{"id":174511,"title":"51 | 安全增强：少不了的自定义授权","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":309841,"user_name":"ZMH.","can_delete":false,"product_type":"c3","uid":1753115,"ip_address":"","ucode":"D45D6CEDFDF8F5","user_header":"https://static001.geekbang.org/account/avatar/00/1a/c0/1b/319baf9d.jpg","comment_is_top":false,"comment_ctime":1630371948,"is_pvip":false,"replies":[{"id":113839,"content":"会的，每个连接都会维护自己的一套Handler，互不影响。","user_name":"作者回复","user_name_real":"傅健","uid":1638649,"ctime":1632966656,"ip_address":"","comment_id":309841,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"有个问题不明白，授权完成后移除handler；那其他客户端的连接怎么办，还会授权吗","like_count":3,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526036,"discussion_content":"会的，每个连接都会维护自己的一套Handler，互不影响。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632966656,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164835,"user_name":"可爱的小奶狗","can_delete":false,"product_type":"c3","uid":1178236,"ip_address":"","ucode":"DC810503571DD2","user_header":"https://static001.geekbang.org/account/avatar/00/11/fa/7c/f8f38ad0.jpg","comment_is_top":false,"comment_ctime":1577097995,"is_pvip":false,"replies":[{"id":62908,"content":"不是非常明白你要做的事情，但是提供几个思路给你参考下，应该有适合你的：\n（1）类似tomcat里面的session管理，你在netty中搞一个全局的handle来维护你的session(存储到redis&#47;db&#47;local根据需求了);\n（2）你的业务数据格式本身可以定义一个字段作为业务阶段标识；\n（3）channel本身可以带attribute属性，你也可以把阶段设置到那个里面；\n虽然不是很清楚你的问题到底是搞啥，但是大体以上3种思路应该有适合你的。谢谢","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1577167975,"ip_address":"","comment_id":164835,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，netty怎样记录每个tcp连接的session,比如业务绑定了session，要根据session来判断业务阶段，然后调用对应的处理方法？","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478912,"discussion_content":"不是非常明白你要做的事情，但是提供几个思路给你参考下，应该有适合你的：\n（1）类似tomcat里面的session管理，你在netty中搞一个全局的handle来维护你的session(存储到redis/db/local根据需求了);\n（2）你的业务数据格式本身可以定义一个字段作为业务阶段标识；\n（3）channel本身可以带attribute属性，你也可以把阶段设置到那个里面；\n虽然不是很清楚你的问题到底是搞啥，但是大体以上3种思路应该有适合你的。谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577167975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161039,"user_name":"faunjoe","can_delete":false,"product_type":"c3","uid":1109373,"ip_address":"","ucode":"161EBB18B7F076","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/7d/112bc7e1.jpg","comment_is_top":false,"comment_ctime":1576108158,"is_pvip":false,"replies":[{"id":61541,"content":"netty本身不提供连接池功能，你可以用apache common pool等工具自己来实现客户端的连接池。也可以搞简单点，新建几个连接(可配)，然后简单的load balance去发送请求也可以。总之，netty本身只提供连接功能。连接的使用是我们自己的事了。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576234700,"ip_address":"","comment_id":161039,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"能讲下客户端连接池吗？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477584,"discussion_content":"netty本身不提供连接池功能，你可以用apache common pool等工具自己来实现客户端的连接池。也可以搞简单点，新建几个连接(可配)，然后简单的load balance去发送请求也可以。总之，netty本身只提供连接功能。连接的使用是我们自己的事了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576234700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228124,"user_name":"haisheng","can_delete":false,"product_type":"c3","uid":2020634,"ip_address":"","ucode":"236C399EBA8280","user_header":"","comment_is_top":false,"comment_ctime":1592562164,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，server端添加了AuthHandler，chient端是循环发送1000次非AuthOperation报文。为什么我看到服务器打印了expect first is auth message, 但是后边的报文还能成功发送server端呢？ctx.close() 不是已经调用了么，通道关闭了，为什么还会发送报文呢？","like_count":1,"discussions":[{"author":{"id":2051913,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM7uNqGmKnYpJRYJ8ogibsETPGluaVR1sPyIpslDbxKRKdMQ8cfmMm4b4RCZbRIiczZiadIZHhBfCBXTRldS4Nibc9fR/132","nickname":"Geek_yulu","note":"","ucode":"E21A78F62F2712","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390763,"discussion_content":"因为你第一次授权通过后，授权handler就已经被移除了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630030791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1670039,"avatar":"https://static001.geekbang.org/account/avatar/00/19/7b/97/950082a4.jpg","nickname":"fish","note":"","ucode":"EBC306460F2962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363627,"discussion_content":"发送1000次之前是不是发送了授权","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617248046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":276483,"user_name":"Liam","can_delete":false,"product_type":"c3","uid":1094597,"ip_address":"","ucode":"1D15D3B64F2606","user_header":"https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg","comment_is_top":false,"comment_ctime":1611970327,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"授权操作处理完后移除handler不会有问题吗，因为handler是@shareable的，如果当前channel移除handler的时候，其他channel正在授权怎么办","like_count":0,"discussions":[{"author":{"id":1670039,"avatar":"https://static001.geekbang.org/account/avatar/00/19/7b/97/950082a4.jpg","nickname":"fish","note":"","ucode":"EBC306460F2962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363626,"discussion_content":"每一个channel都会有auth handler，共享的意思是不用在pipeline里去new了，使用后pipeline里的移除","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617248026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}