{"id":626020,"title":"12｜网络监控：如何监控网络链路和网络设备？","content":"<p>你好，我是秦晓辉。</p><p>上一讲我们介绍了机器监控，机器属于基础设施。除了机器之外，还有一个常见的基础设施，就是网络。<strong>网络监控主要包括网络链路监控和网络设备监控</strong>，通常系统运维人员会比较关注。今天我们就来揭开网络监控的面纱，看看其中涉及了哪些关键技术和实践方法。</p><h2>网络链路监控</h2><p>网络链路监控主要包含三个部分，网络连通性、网络质量、网络流量。</p><p>连通性和质量的监控手段非常简单，就是在链路一侧部署探针，去探测链路另一侧的目标，通过ICMP、TCP、HTTP等协议发送探测数据包，分析回包的结果。典型的指标有丢包率、延迟、回包是否匹配预期条件等。</p><p>网络流量监控，则关注流量大小以及流量内容。流量大小广泛应用于水位管理，比如机器网卡、交换机的接口、外网出口、专线带宽等，及时发现网络瓶颈。分析流量内容，则可以识别过度耗用带宽的用户和应用程序，验证网络QoS策略等。</p><p>这一讲我们使用 Categraf 来演示一下常用探针的配置方式，进行网络连通性和质量监控。网络流量大小，可以使用 SNMP 采集数据，相关方法我们会在后面介绍网络设备监控时讲解。流量内容监控我暂时没有找到开源方案，如果你知道的话，欢迎留言分享。</p><h3>ICMP探测</h3><p>Categraf 的 ICMP 探测使用 Ping 插件，相关配置在 <code>conf/input.ping/ping.toml</code>，主要是配置要探测的目标地址，你可以看一下我给出的样例。</p><!-- [[[read_end]]] --><pre><code class=\"language-bash\">[[instances]]\ntargets = [ \"10.4.5.6\", \"10.4.5.7\" ]\nlabels = { region=\"cloud\", product=\"n9e\" }\n\n[[instances]]\ntargets = [ \"10.4.5.8\" ]\nlabels = { region=\"cloud\", product=\"zbx\" }\n</code></pre><p>例子中是 Ping 3个地址，其中有两个机器是 Nightingale 产品使用的，有一个机器是Zabbix产品使用的，都位于 cloud 这个区域（region）里，所以打了不同的标签来丰富其维度信息。</p><p>如果要同时 Ping 很多台机器，就会占用很多文件句柄，需要提前调大 Categraf 的文件句柄限制。如果是用 systemd 来托管，可以在 categraf.service 文件中添加 LimitNOFILE 配置。</p><pre><code class=\"language-bash\">[Service]\nLimitNOFILE=8192\n</code></pre><p>另一个坑是 CAP 问题，如果使用非 root 账号来运行 Categraf，需要在 categraf.service 文件中添加如下配置。</p><pre><code class=\"language-bash\">[Service]\nCapabilityBoundingSet=CAP_NET_RAW\nAmbientCapabilities=CAP_NET_RAW\n</code></pre><p>Ping 插件可以采集到目标是否连通、延迟时间、丢包率等指标，可以据此做网络链路的监控。比如机房专线的探测，只需要在某个机房部署 Categraf，来探测另一个机房的设备。</p><p>最后是<a href=\"https://github.com/flashcatcloud/categraf/tree/main/inputs/ping\">仪表盘和告警规则</a>，dashboard.json 是仪表盘配置，alerts.json 是告警规则配置，导入夜莺就可以使用。如果是直接使用的 Prometheus，也可以参考 JSON 文件中的 PromQL，并将其改造成 Prometheus yaml 配置。</p><h3>TCP探测</h3><p>很多时候机器是禁 Ping 的，此时TCP探测就派上用场了。TCP探测用的是 Categraf 的 net_response 插件，配置文件在 <code>conf/input.net_response/net_response.toml</code>。实际这个插件既可以探测TCP的响应，也可以探测UDP的响应。配置中最核心的是 targets 部分，指定探测的目标，我给出一个例子，你体会下。</p><pre><code class=\"language-bash\">[[instances]]\ntargets = [\n    \"10.2.3.4:22\",\n    \"localhost:6379\",\n    \":9090\"\n]\n</code></pre><ul>\n<li><code>10.2.3.4:22</code> 表示探测 10.2.3.4 这个机器的 22 端口是否可以连通。</li>\n<li><code>localhost:6379</code> 表示探测本机的 6379 端口是否可以连通。</li>\n<li><code>:9090</code> 表示探测本机的 9090 端口是否可以连通，没有写IP或主机名的就默认使用localhost。</li>\n</ul><p>原理也很简单，就是 Categraf 向目标地址发起网络连接。如果能连通，就认为是正常的，指标值上报为0，如果失败就是非0的值。监控指标名字是net_response_result_code。</p><p>如果是UDP的端口，是无法发起连接探测的。此时采用内容匹配探测，即通过UDP发个字符串给探测目标，理论上探测目标很快就会给出回复。我们来检查回复内容，如果回复内容包含特定字符串，就表示探测目标活着。相关配置是 send 和 expect 字段，你可以看一下配置样例。</p><pre><code class=\"language-bash\">## The following options are required for UDP checks. For TCP, they are\n## optional. The plugin will send the given string to the server and then\n## expect to receive the given 'expect' string back.\n## string sent to the server\nsend = \"ping\"\n## expected string in answer\nexpect = \"pong\"\n</code></pre><p>net_response 插件也内置了仪表盘和告警规则，可以在<a href=\"https://github.com/flashcatcloud/categraf/tree/main/inputs/net_response\">代码目录</a>中找到，导入夜莺就可以使用。</p><h3>HTTP探测</h3><p>HTTP探测和TCP的探测逻辑几乎完全一致，只不过HTTP是七层协议，Categraf 可以解析到Status code、Response body 这些更细粒度的信息。相关配置在 <code>conf/input.http_response/http_response.toml</code>，我们看一个配置样例。</p><pre><code class=\"language-bash\">[[instances]]\ntargets = [\n&nbsp; &nbsp; \"http://localhost\",\n&nbsp; &nbsp; \"https://www.baidu.com\"\n]\n</code></pre><p>很多公司都会在所有的机器上部署 Agent，Agent 会开一个 HTTP 端口，这样就可以通过探测这些 HTTP 端口，知道 Agent 是否存活，进而反推机器的存活性。</p><p>HTTP插件可以对返回的Response做规则匹配，比如判断Response body中是否包含特定的字符串，或者 Status code 是否是指定的值等，你可以看下相关配置。</p><pre><code class=\"language-bash\">## Optional substring match in body of the response (case sensitive)\nexpect_response_substring = \"ok\"\n\n## Optional expected response status code.\nexpect_response_status_code = 200\n</code></pre><p>如果目标地址是 HTTPS 的，Categraf 也会自动检查证书过期时间，指标名是cert_expire_timestamp，证书过期时间一定要记得加个告警规则，我见过很多公司因为证书过期而导致线上故障。</p><p>网络链路的几种探测方式，我们就讲到这里，下面我们再来看一下网络中的节点，网络设备的监控。</p><h2>网络设备监控</h2><p>网络设备监控的典型手段有三个，一个是 Ping 监控，探测是否存活，刚刚我们已经介绍过了。另一个是通过 SNMP 获取指标，比如各个网口的状态、流量、包量等。最后一个是SNMP Trap，一般网络设备有问题，都会发出Trap消息，这些Trap消息很有价值，分析这些Trap消息是常用且有效的监控手段。我们先来看一下 SNMP 获取指标的方式。</p><h3>SNMP指标获取方式</h3><p>要采集网络设备的监控指标，一定要了解SNMP协议。这个内容比较多，你可以结合<a href=\"https://flashcat.cloud/blog/snmp-introduction/\">《SNMP（简单网络管理协议）简介》</a>来理解。简单来讲，就是交换机上有个组件叫 SNMP agent（即 snmpd ），监听 UDP 161 端口，提供查询服务。SNMP manager，比如 Categraf，可以向 SNMP agent 发起查询请求，传入的参数是 OID，SNMP agent 返回 OID 对应的监控数据。</p><p>Categraf 提供了 SNMP 插件，配置文件在 <code>conf/input.snmp/snmp.toml</code>，核心配置就是 SNMP agent 的连接地址以及要采集的 OID 列表。</p><p>举个例子。</p><pre><code class=\"language-bash\">interval = 60\n\n[[instances]]\nagents = [\"udp://172.30.15.189:161\"]\n\ntimeout = \"5s\"\nversion = 2\ncommunity = \"public\"\nagent_host_tag = \"ident\"\nretries = 1\n\n[[instances.field]]\noid = \"RFC1213-MIB::sysUpTime.0\"\nname = \"uptime\"\n\n[[instances.field]]\noid = \"RFC1213-MIB::sysName.0\"\nname = \"source\"\nis_tag = true\n\n[[instances.table]]\noid = \"IF-MIB::ifTable\"\nname = \"interface\"\ninherit_tags = [\"source\"]\n\n[[instances.table.field]]\noid = \"IF-MIB::ifDescr\"\nname = \"ifDescr\"\nis_tag = true\n</code></pre><p>例子中，配置的交换机地址是172.30.15.189，认证版本是 version 2，认证团体名是 public。如果是 v3 版本，可能和下面的认证配置差不多。</p><pre><code class=\"language-bash\">version = 3\nsec_name = \"managev3user\"\nauth_protocol = \"SHA\"\nauth_password = \"example.Demo.c0m\"\n</code></pre><p>要采集哪些指标，是通过 OID 字段来指定的，instances.field 有两个，一个是获取系统启动时间（OID是RFC1213-MIB::sysUpTime.0），一个是获取系统名称（OID是RFC1213-MIB::sysName.0），这两个OID都是Scalar类型，可以使用snmpget进行测试。</p><pre><code class=\"language-bash\">snmpget -v2c -c public 172.30.15.189 RFC1213-MIB::sysUpTime.0\n</code></pre><p>因为 name = “uptime” 这个配置，指标会命名成 snmp_uptime，snmp是插件前缀，uptime就是name字段指定的。看起来挺顺畅，但是为什么sysName这个field多了一个 is_tag = true 的配置呢？因为 sysName 是个字符串，不是要上报的监控数据，它会作为一个标签 source=$sysName 附到所有时序数据上。</p><p>instances.table 部分采集的是 Table 类型的数据，Table 的 OID 是 IF-MIB::ifTable，Table里有多列数据和索引，Categraf 会自动获取Table中所有的索引字段，做成时序数据的标签，还会自动获取所有的数据列，作为指标上报。但是，有些列可能不是数值，比如 ifDescr 就是字符串，这个列无需作为指标上报，作为标签上报更合适，所以有个 is_tag=true 的配置。inherit_tags 表示继承下来的标签，ifTable 收集到的数据就会自动附上 source 标签。</p><p>ifTable 可以拿到各个网口的出入向流量、包量等，对我们做容量监控很有帮助，当然也可以拿到错包、丢包的情况，这些都是很重要的监控指标。这里我贴几条监控数据，让你有一个直观的认识。</p><pre><code class=\"language-bash\">12:01:36 snmp_interface_ifInNUcastPkts agent_hostname=prober01 ident=172.30.15.189 ifIndex=5 source=SW01 0\n12:01:36 snmp_interface_ifInErrors agent_hostname=prober01 ident=172.30.15.189 ifIndex=5 source=SW01 0\n12:01:36 snmp_interface_ifOutDiscards agent_hostname=prober01 ident=172.30.15.189 ifIndex=5 source=SW01 0\n12:01:36 snmp_interface_ifOutErrors agent_hostname=prober01 ident=172.30.15.189 ifIndex=5 source=SW01 0\n</code></pre><p>除了获取指标之外，SNMP Trap 也是很关键的监控手段，<strong>SNMP 指标监控是轮询式，定期采集，而 Trap 是只要有消息就自动通知，即时性更好。</strong>下面我们来看一下 Trap 的相关技术方案。</p><h3>SNMP Trap</h3><p>与 SNMP 采集指标的方式不同，Trap 消息是由交换机里的 SNMP agent 发消息给 SNMP manager（也是走的 UDP 协议），与指标采集的数据流向相反。目前 Categraf 尚不支持 Trap 消息接收，你可以先用 Telegraf 的 snmp_trap 插件做测试。</p><p><img src=\"https://static001.geekbang.org/resource/image/76/09/76d4a3ccc578339427e36d5f5db03d09.jpg?wh=1170x560\" alt=\"\" title=\"SNMP Trap架构（图片来自网络）\"></p><p>用 Trap 机制做事件监控是比较便捷的方式，交换机出现关键问题的时候，都会立刻发出 Trap 消息。我们只要在 Trap Receiver 中配置消息匹配规则，指定什么样的消息应该产生告警即可。但是，匹配规则肯定是需要用人类易读的方式，这就需要借助MIB库，把Trap中的OID翻译成人类易读的字符串。不翻译的话，原始的Trap消息可能是这样的，很难读懂。</p><pre><code class=\"language-json\">{\n&nbsp; \"Version\": 2,\n&nbsp; \"TrapType\": 0,\n&nbsp; \"OID\": null,\n&nbsp; \"Other\": null,\n&nbsp; \"Community\": \"public\",\n&nbsp; \"Username\": \"\",\n&nbsp; \"Address\": \"172.16.1.64:49692\",\n&nbsp; \"VarBinds\": {\n&nbsp; &nbsp; \".1.3.6.1.2.1.1.3.0\": 7908527690000000,\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.1.18\": 18,\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.2.18\": \"Vlanif103\",\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.7.18\": 2,\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.8.18\": 2,\n&nbsp; &nbsp; \".1.3.6.1.6.3.1.1.4.1.0\": [1, 3, 6, 1, 6, 3, 1, 1, 5, 3]\n&nbsp; },\n&nbsp; \"VarBindOIDs\": [\n&nbsp; &nbsp; \".1.3.6.1.2.1.1.3.0\",\n&nbsp; &nbsp; \".1.3.6.1.6.3.1.1.4.1.0\",\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.1.18\",\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.7.18\",\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.8.18\",\n&nbsp; &nbsp; \".1.3.6.1.2.1.2.2.1.2.18\"\n&nbsp; ]\n}\n</code></pre><p>不过遗憾的是，我还没有在开源社区找到兼具翻译和规则匹配的软件，目前可能只有一些商业软件可以做到，比如卓豪。所以这里我通过讲解原理来让你了解整个过程，就不给你演示了。</p><h2>小结</h2><p>这一讲我从网络链路和网络设备两个方面，给你介绍了网络监控的方法。</p><p>网络链路监控，包括连通性和质量监控、流量和内容监控，典型的探测协议是ICMP、TCP、HTTP。Categraf有对应的采集插件可以使用，Prometheus 生态的 Blackbox-Exporter也可以做这个事情。</p><p>网路流量包含多个方面，比如机器网卡是否跑满，我们可以用 Categraf 采集网卡流量数据，而交换机的网口流量需要用SNMP协议获取。网络内容监控，可以使用NetFlow、J-Flow、sFlow、NetStream、IPFIX等手段，找出占用带宽最多的用户、应用程序和协议。</p><p>网络设备监控，用途很广泛，除了交换机、路由器外，UPS、打印机、存储等都支持SNMP协议，我们可以通过SNMP获取到设备的各种监控指标。不过要注意，对于一些老式交换机，SNMP采集不能太频繁，不然有可能影响交换机的性能。</p><p>另一个网络设备监控手段就是Trap了，通过SNMP agent主动发消息给SNMP manager，即时性很好，我们只要写一个 Trap Receiver，做协议翻译和规则匹配，就是一个很好的监控手段。不过这个方向确实是非常细分的领域，目前我们还没有看到相关的开源产品。</p><p><img src=\"https://static001.geekbang.org/resource/image/78/eb/78444e966a71be9f7877eb7ef44f5aeb.jpg?wh=2465x2295\" alt=\"\"></p><h2>互动时刻</h2><p>交换机的监控，最常用的网口统计数据都是国际通用OID，但也有很多常用监控指标是私有OID，不同厂商不一样，比如CPU、内存相关的指标都是私有OID。不同型号常用的私有OID有哪些呢？欢迎留言分享，也欢迎你把今天的内容分享给你身边的朋友，邀他一起学习。我们下一讲再见！</p><p><span class=\"reference\">注：举两个例子，比如HUAWEI ME60的CPU利用率OID是 <code>1.3.6.1.4.1.2011.6.3.4.1.2</code>，Juniper的CPU利用率OID是 <code>1.3.6.1.4.1.2636.3.1.13.1.8</code>。</span></p>","comments":[{"had_liked":false,"id":367629,"user_name":"dobby","can_delete":false,"product_type":"c1","uid":2549097,"ip_address":"四川","ucode":"9C1992C4DD28F5","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoib6BjEV4KPEaIdlLEfoVFRCxCSlL2XaIVDiaakvjhWEibibym323ZeHXAY46JMO3nSHmjiaWtAY47eww/132","comment_is_top":false,"comment_ctime":1675388823,"is_pvip":true,"replies":[{"id":133885,"content":"的确很恶心，不过，如果大家能一起贡献采集配置就好了，就能很快攒起来各种型号设备的采集能力","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1675412767,"ip_address":"北京","comment_id":367629,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"snmp结果的解析太繁琐了，纯纯体力活，开源根本没什么好用的库","like_count":3,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601783,"discussion_content":"的确很恶心，不过，如果大家能一起贡献采集配置就好了，就能很快攒起来各种型号设备的采集能力","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675412767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1146405,"avatar":"https://static001.geekbang.org/account/avatar/00/11/7e/25/3932dafd.jpg","nickname":"GeekNeo","note":"","ucode":"1D355A9BEB8BEA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":630084,"discussion_content":"https://github.com/robotneo/wireless-monitor 基于snmp exporter","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1698114635,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1027722,"avatar":"","nickname":"三毛","note":"","ucode":"F9792EA10F5044","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601887,"discussion_content":"现在有社区做这个吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675440145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367685,"user_name":"hshopeful","can_delete":false,"product_type":"c1","uid":1200048,"ip_address":"湖北","ucode":"EE8D6E0A40607E","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/b0/ab179368.jpg","comment_is_top":false,"comment_ctime":1675421591,"is_pvip":false,"replies":[{"id":133929,"content":"1，Categraf还没有精力做trap\n2，在前面agent选型的章节，介绍过哈。除了前面章节介绍的，另外就是categraf支持metrics、logs、traces三大支柱的数据采集，集成了mtail，改良了mysql采集，改良了system采集，增加了几个Telegraf不支持的plugin，各有优劣吧","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1675425847,"ip_address":"北京","comment_id":367685,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"老师有两个问题请教下：\n1、telegraf 支持 snmp_trap，catagraf 没有支持的原因是什么呢？难点主要是啥？\n2、这节课介绍的插件，telegraf 中都有，想请问下 catagraf 的优势是什么呢？","like_count":2,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601862,"discussion_content":"1，Categraf还没有精力做trap\n2，在前面agent选型的章节，介绍过哈。除了前面章节介绍的，另外就是categraf支持metrics、logs、traces三大支柱的数据采集，集成了mtail，改良了mysql采集，改良了system采集，增加了几个Telegraf不支持的plugin，各有优劣吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675425847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382012,"user_name":"zdyang","can_delete":false,"product_type":"c1","uid":3649214,"ip_address":"上海","ucode":"09B818CE73628A","user_header":"https://static001.geekbang.org/account/avatar/00/37/ae/be/f19c90a5.jpg","comment_is_top":false,"comment_ctime":1696511188,"is_pvip":false,"replies":[{"id":139210,"content":"是的，这个更实时，新设备越来越多支持 Telemetry 了","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1696896290,"ip_address":"北京","comment_id":382012,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"交换机监控还有一种方式是通过telemetry，这是华为的介绍https:&#47;&#47;support.huawei.com&#47;enterprise&#47;zh&#47;doc&#47;EDOC1000173014&#47;165fa2c8?idPath=24030814|9856750|250987487|22896249|19896202","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629255,"discussion_content":"是的，这个更实时，新设备越来越多支持 Telemetry 了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1696896290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":377023,"user_name":"kobe","can_delete":false,"product_type":"c1","uid":1165831,"ip_address":"浙江","ucode":"AB8B599F3D5521","user_header":"https://static001.geekbang.org/account/avatar/00/11/ca/07/22dd76bf.jpg","comment_is_top":false,"comment_ctime":1687846814,"is_pvip":false,"replies":[{"id":137433,"content":"核心关注 http_response_result_code 指标，通过 .&#47;categraf --test --inputs http_response 可以看到。这个 http_response_result_code 指标如果是 0，就表示一切正常，如果非 0，就表示异常，不同的非 0 值代表不同的含义，具体可以参考：https:&#47;&#47;github.com&#47;flashcatcloud&#47;categraf&#47;tree&#47;main&#47;inputs&#47;http_response\n\n指标体系里，仅仅使用不同的 value 呈现错误会有些不易读，也可以尝试事件监控的方式，参考 catpaw 的逻辑：https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;Y-KipuKZxVn8o-NR6-ZBZg","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1687995714,"ip_address":"北京","comment_id":377023,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"\n## Optional substring match in body of the response (case sensitive)\nexpect_response_substring = &quot;ok&quot;\n\n## Optional expected response status code.\nexpect_response_status_code = 200\n\n我这里如果这样配了 那指标的值是什么样的呢","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622177,"discussion_content":"核心关注 http_response_result_code 指标，通过 ./categraf --test --inputs http_response 可以看到。这个 http_response_result_code 指标如果是 0，就表示一切正常，如果非 0，就表示异常，不同的非 0 值代表不同的含义，具体可以参考：https://github.com/flashcatcloud/categraf/tree/main/inputs/http_response\n\n指标体系里，仅仅使用不同的 value 呈现错误会有些不易读，也可以尝试事件监控的方式，参考 catpaw 的逻辑：https://mp.weixin.qq.com/s/Y-KipuKZxVn8o-NR6-ZBZg","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687995715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1165831,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ca/07/22dd76bf.jpg","nickname":"kobe","note":"","ucode":"AB8B599F3D5521","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622200,"discussion_content":"\nBodyMismatch     = 5\nCodeMismatch     = 6\n还有这两个code的含义是啥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688010338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1165831,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ca/07/22dd76bf.jpg","nickname":"kobe","note":"","ucode":"AB8B599F3D5521","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622198,"discussion_content":"我想知道的是加上这两个配置后，对指标的结果集有什么影响吗，就是加和不加有什么区别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688009960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368608,"user_name":"Gong","can_delete":false,"product_type":"c1","uid":1016890,"ip_address":"山东","ucode":"5740D8A9F0E5DB","user_header":"","comment_is_top":false,"comment_ctime":1676476900,"is_pvip":false,"replies":[{"id":134318,"content":"一般监控网卡流量就可以了","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1676716509,"ip_address":"北京","comment_id":368608,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"老师好，请教一下我想监控各终端和服务器的交互流量，有什么办法吗？服务器接的终端数量一千台左右。","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":605545,"discussion_content":"一般监控网卡流量就可以了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676716510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368250,"user_name":"F0RWARD","can_delete":false,"product_type":"c1","uid":1079124,"ip_address":"北京","ucode":"0AEB6D9593F8B4","user_header":"https://static001.geekbang.org/account/avatar/00/10/77/54/895e1035.jpg","comment_is_top":false,"comment_ctime":1676043095,"is_pvip":false,"replies":[{"id":134097,"content":"采集的监控数据都是 float64","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1676102184,"ip_address":"北京","comment_id":368250,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"老师，catagraf采集的网卡流量是32位的，还是64位的？当流量超过1G时，32位的数据会不准确","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603311,"discussion_content":"采集的监控数据都是 float64","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676102184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368052,"user_name":"MiraClei","can_delete":false,"product_type":"c1","uid":1969284,"ip_address":"北京","ucode":"EA28F32A8A3B5D","user_header":"https://static001.geekbang.org/account/avatar/00/1e/0c/84/8542f966.jpg","comment_is_top":false,"comment_ctime":1675848048,"is_pvip":false,"replies":[{"id":134017,"content":"config.toml 里的 hostname 配置，不要写 $ip，如果写 $ip 就自动探测本机IP，自动探测的时候会请求223.5.5.5","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1675849195,"ip_address":"北京","comment_id":368052,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"请教下载服务器离线状态下，categraf启动会频繁重启，报错信息是请求223.5.5.5，但服务器无法联网，这种情况下是如何解决？","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602951,"discussion_content":"config.toml 里的 hostname 配置，不要写 $ip，如果写 $ip 就自动探测本机IP，自动探测的时候会请求223.5.5.5","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675849195,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367770,"user_name":"戒贪嗔痴","can_delete":false,"product_type":"c1","uid":3017168,"ip_address":"浙江","ucode":"D53EA3525DBD71","user_header":"https://static001.geekbang.org/account/avatar/00/2e/09/d0/8609bddc.jpg","comment_is_top":false,"comment_ctime":1675580191,"is_pvip":false,"replies":[{"id":133965,"content":"感谢反馈，已经更正了","user_name":"编辑回复","user_name_real":"编辑","uid":2843479,"ctime":1675673707,"ip_address":"北京","comment_id":367770,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"最后一张图，最常使用的协议是：v2c？还是V2","like_count":0,"discussions":[{"author":{"id":2843479,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/57/cba4c68b.jpg","nickname":"小虎子🐯","note":"","ucode":"4C9530B3FB407B","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602210,"discussion_content":"感谢反馈，已经更正了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675673707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367759,"user_name":"lei","can_delete":false,"product_type":"c1","uid":1855112,"ip_address":"浙江","ucode":"4FFB8B984269FB","user_header":"https://static001.geekbang.org/account/avatar/00/1c/4e/88/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1675566971,"is_pvip":false,"replies":[{"id":133975,"content":"监控服务，就看服务对外提供的服务质量，比如web服务就看可用性、延迟、错误率等，是有方法论的，可以参考第9讲。","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1675728686,"ip_address":"北京","comment_id":367759,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"请教一下，平时的自定义服务数量非常多，每个服务又会对应多个进程或实例，每个进程会对应多线程，这种情况有什么好的方法监控服务吗？","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602285,"discussion_content":"监控服务，就看服务对外提供的服务质量，比如web服务就看可用性、延迟、错误率等，是有方法论的，可以参考第9讲。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675728686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367696,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"北京","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1675434915,"is_pvip":false,"replies":[{"id":133976,"content":"1个","user_name":"作者回复","user_name_real":"编辑","uid":1001078,"ctime":1675728699,"ip_address":"北京","comment_id":367696,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"请问：ping一个机器会占用多少文件句柄？","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"巴辉特","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602286,"discussion_content":"1个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675728699,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3294244,"avatar":"","nickname":"Geek_0063ee","note":"","ucode":"44ECD956507BC2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602266,"discussion_content":"自己构造发送和接收线程就行，无论多少机器只会占用很少的套接字句柄。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675696549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":395073,"user_name":"骑着🚀看银河","can_delete":false,"product_type":"c1","uid":1074734,"ip_address":"上海","ucode":"8706A99A89F0CE","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/2e/527b73c9.jpg","comment_is_top":false,"comment_ctime":1729267336,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100522501,"comment_content":"老师每个案例直接上来贴配置文件，这种对于基础差的太不友好了，能把案例写全了我们能真是环境上跟着操作一遍是不是理解更透彻","like_count":1},{"had_liked":false,"id":382844,"user_name":"GeekNeo","can_delete":false,"product_type":"c1","uid":1146405,"ip_address":"浙江","ucode":"1D355A9BEB8BEA","user_header":"https://static001.geekbang.org/account/avatar/00/11/7e/25/3932dafd.jpg","comment_is_top":false,"comment_ctime":1698114670,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100522501,"comment_content":"https:&#47;&#47;github.com&#47;robotneo&#47;wireless-monitor 个人分享 基于snmp exporter","like_count":1},{"had_liked":false,"id":377920,"user_name":"小豆哥","can_delete":false,"product_type":"c1","uid":1218134,"ip_address":"北京","ucode":"2F742DD7187589","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/56/6bceca1b.jpg","comment_is_top":false,"comment_ctime":1689555264,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100522501,"comment_content":"老师可以补充下snmp_exporter组件采集mibs的过程文档吗","like_count":1},{"had_liked":false,"id":372339,"user_name":"novoer","can_delete":false,"product_type":"c1","uid":1283363,"ip_address":"福建","ucode":"958C1BA9B4DA51","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erLKlSIdiadmBR0awVgQcTGbsnd1dp1uaDcdfgyFNmREXNEANjMVSDKV3yYD2AKQEicibvKY35RVpmmg/132","comment_is_top":false,"comment_ctime":1681008281,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100522501,"comment_content":"是否丢包，丢包率是怎么监控的","like_count":0},{"had_liked":false,"id":369958,"user_name":"Ppppppp","can_delete":false,"product_type":"c1","uid":3294642,"ip_address":"江苏","ucode":"5AD679CC53B6D1","user_header":"https://static001.geekbang.org/account/avatar/00/32/45/b2/24dee83c.jpg","comment_is_top":false,"comment_ctime":1678179807,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100522501,"comment_content":"关于探测监控，比如说证明一个service或者设备是否活着\n在老东家是这么做的，发送命令&#47;字符串&#47;等方式，获得一个期许的相应值，然后通过判断该响应值来证明是否存活。这个思路不仅仅局限于tcp icmp http, 很多服务都可以使用。\n记得之前对于qemu alive&#47;dead就干过类似的事。","like_count":0}]}