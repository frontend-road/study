{"id":482459,"title":"05 | ç¼–ç¨‹æ¥å£ï¼šeBPFç¨‹åºæ˜¯æ€ä¹ˆè·Ÿå†…æ ¸è¿›è¡Œäº¤äº’çš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº† eBPF åœ¨å†…æ ¸ä¸­çš„å®ç°åŸç†ï¼Œä»¥åŠ BPF æŒ‡ä»¤çš„å…·ä½“æ ¼å¼ã€‚</p><p>ç”¨é«˜çº§è¯­è¨€å¼€å‘çš„ eBPF ç¨‹åºï¼Œéœ€è¦é¦–å…ˆç¼–è¯‘ä¸º BPF å­—èŠ‚ç ï¼Œç„¶åå€ŸåŠ© bpf ç³»ç»Ÿè°ƒç”¨åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œæœ€åå†é€šè¿‡æ€§èƒ½ç›‘æ§ç­‰æ¥å£ä¸å…·ä½“çš„å†…æ ¸äº‹ä»¶è¿›è¡Œç»‘å®šã€‚è¿™æ ·ï¼Œå†…æ ¸çš„æ€§èƒ½ç›‘æ§æ¨¡å—æ‰ä¼šåœ¨å†…æ ¸äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œæˆ‘ä»¬å¼€å‘çš„ eBPF ç¨‹åºã€‚</p><p>é‚£ä¹ˆï¼ŒeBPF ç¨‹åºåˆ°åº•æ˜¯å¦‚ä½•è·Ÿå†…æ ¸äº‹ä»¶è¿›è¡Œç»‘å®šçš„ï¼Ÿåˆè¯¥å¦‚ä½•è·Ÿå†…æ ¸ä¸­çš„å…¶ä»–æ¨¡å—è¿›è¡Œäº¤äº’å‘¢ï¼Ÿä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·çœ‹çœ‹ eBPF ç¨‹åºçš„ç¼–ç¨‹æ¥å£ã€‚</p><h2>BPF ç³»ç»Ÿè°ƒç”¨</h2><p>å¦‚ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª<a href=\"https://www.brendangregg.com/ebpf.html\">brendangregg.com</a>ï¼‰æ‰€ç¤ºï¼Œä¸€ä¸ªå®Œæ•´çš„ eBPF ç¨‹åºé€šå¸¸åŒ…å«ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸¤éƒ¨åˆ†ã€‚å…¶ä¸­ï¼Œç”¨æˆ·æ€è´Ÿè´£ eBPF ç¨‹åºçš„åŠ è½½ã€äº‹ä»¶ç»‘å®šä»¥åŠ eBPF ç¨‹åºè¿è¡Œç»“æœçš„æ±‡æ€»è¾“å‡ºï¼›å†…æ ¸æ€è¿è¡Œåœ¨ eBPF è™šæ‹Ÿæœºä¸­ï¼Œè´Ÿè´£å®šåˆ¶å’Œæ§åˆ¶ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a7/6a/a7165eea1fd9fc24090a3a1e8987986a.png?wh=1500x550\" alt=\"å›¾ç‰‡\"></p><p>å¯¹äºç”¨æˆ·æ€ç¨‹åºæ¥è¯´ï¼Œæˆ‘æƒ³ä½ å·²ç»äº†è§£ï¼Œ<strong>å®ƒä»¬ä¸å†…æ ¸è¿›è¡Œäº¤äº’æ—¶å¿…é¡»è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆ</strong>ã€‚è€Œå¯¹åº”åˆ° eBPF ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨åˆ°çš„å°±æ˜¯ <a href=\"https://man7.org/linux/man-pages/man2/bpf.2.html\">bpf ç³»ç»Ÿè°ƒç”¨</a>ã€‚</p><p>åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ <code>man bpf</code>&nbsp;ï¼Œå°±å¯ä»¥æŸ¥è¯¢åˆ° BPF ç³»ç»Ÿè°ƒç”¨çš„è°ƒç”¨æ ¼å¼ï¼š</p><pre><code class=\"language-plain\">#include &lt;linux/bpf.h&gt;\n\nint bpf(int cmd, union bpf_attr *attr, unsigned int size);\n</code></pre><!-- [[[read_end]]] --><p>BPF ç³»ç»Ÿè°ƒç”¨æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š</p><ul>\n<li>ç¬¬ä¸€ä¸ªï¼Œcmd ï¼Œä»£è¡¨æ“ä½œå‘½ä»¤ï¼Œæ¯”å¦‚ä¸Šä¸€è®²ä¸­æˆ‘ä»¬çœ‹åˆ°çš„ BPF_PROG_LOAD å°±æ˜¯åŠ è½½ eBPF ç¨‹åºï¼›</li>\n<li>ç¬¬äºŒä¸ªï¼Œattrï¼Œä»£è¡¨ bpf_attr ç±»å‹çš„ eBPF å±æ€§æŒ‡é’ˆï¼Œä¸åŒç±»å‹çš„æ“ä½œå‘½ä»¤éœ€è¦ä¼ å…¥ä¸åŒçš„å±æ€§å‚æ•°ï¼›</li>\n<li>ç¬¬ä¸‰ä¸ªï¼Œsize ï¼Œä»£è¡¨å±æ€§çš„å¤§å°ã€‚</li>\n</ul><p>æ³¨æ„ï¼Œ<strong>ä¸åŒç‰ˆæœ¬çš„å†…æ ¸æ‰€æ”¯æŒçš„ BPF å‘½ä»¤æ˜¯ä¸åŒçš„</strong>ï¼Œå…·ä½“æ”¯æŒçš„å‘½ä»¤åˆ—è¡¨å¯ä»¥å‚è€ƒå†…æ ¸å¤´æ–‡ä»¶ include/uapi/linux/bpf.h ä¸­  <code>bpf_cmd</code> çš„å®šä¹‰ã€‚æ¯”å¦‚ï¼Œv5.13 å†…æ ¸å·²ç»æ”¯æŒ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L828\">36 ä¸ª BPF å‘½ä»¤</a>ï¼š</p><pre><code class=\"language-plain\">enum bpf_cmd {\n&nbsp; BPF_MAP_CREATE,\n&nbsp; BPF_MAP_LOOKUP_ELEM,\n&nbsp; BPF_MAP_UPDATE_ELEM,\n&nbsp; BPF_MAP_DELETE_ELEM,\n&nbsp; BPF_MAP_GET_NEXT_KEY,\n&nbsp; BPF_PROG_LOAD,\n&nbsp; BPF_OBJ_PIN,\n&nbsp; BPF_OBJ_GET,\n&nbsp; BPF_PROG_ATTACH,\n&nbsp; BPF_PROG_DETACH,\n&nbsp; BPF_PROG_TEST_RUN,\n&nbsp; BPF_PROG_GET_NEXT_ID,\n&nbsp; BPF_MAP_GET_NEXT_ID,\n&nbsp; BPF_PROG_GET_FD_BY_ID,\n&nbsp; BPF_MAP_GET_FD_BY_ID,\n&nbsp; BPF_OBJ_GET_INFO_BY_FD,\n&nbsp; BPF_PROG_QUERY,\n&nbsp; BPF_RAW_TRACEPOINT_OPEN,\n&nbsp; BPF_BTF_LOAD,\n&nbsp; BPF_BTF_GET_FD_BY_ID,\n&nbsp; BPF_TASK_FD_QUERY,\n&nbsp; BPF_MAP_LOOKUP_AND_DELETE_ELEM,\n&nbsp; BPF_MAP_FREEZE,\n&nbsp; BPF_BTF_GET_NEXT_ID,\n&nbsp; BPF_MAP_LOOKUP_BATCH,\n&nbsp; BPF_MAP_LOOKUP_AND_DELETE_BATCH,\n&nbsp; BPF_MAP_UPDATE_BATCH,\n&nbsp; BPF_MAP_DELETE_BATCH,\n&nbsp; BPF_LINK_CREATE,\n&nbsp; BPF_LINK_UPDATE,\n&nbsp; BPF_LINK_GET_FD_BY_ID,\n&nbsp; BPF_LINK_GET_NEXT_ID,\n&nbsp; BPF_ENABLE_STATS,\n&nbsp; BPF_ITER_CREATE,\n&nbsp; BPF_LINK_DETACH,\n&nbsp; BPF_PROG_BIND_MAP,\n};\n</code></pre><p>ä¸ºäº†æ–¹ä¾¿ä½ æŒæ¡ï¼Œæˆ‘æŠŠç”¨æˆ·ç¨‹åºä¸­å¸¸ç”¨çš„å‘½ä»¤æ•´ç†æˆäº†ä¸€ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥åœ¨éœ€è¦æ—¶å‚è€ƒï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/7c/88/7cc33d0bdd8a3ba0dda7f533f3375b88.jpg?wh=1920x1080\" alt=\"å›¾ç‰‡\"></p><h2>BPF è¾…åŠ©å‡½æ•°</h2><p>è¯´å®Œç”¨æˆ·æ€ç¨‹åºçš„ bpf ç³»ç»Ÿè°ƒç”¨æ ¼å¼ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å†…æ ¸æ€çš„ eBPF ç¨‹åºã€‚</p><p>eBPF ç¨‹åºå¹¶ä¸èƒ½éšæ„è°ƒç”¨å†…æ ¸å‡½æ•°ï¼Œå› æ­¤ï¼Œå†…æ ¸å®šä¹‰äº†ä¸€ç³»åˆ—çš„è¾…åŠ©å‡½æ•°ï¼Œç”¨äº eBPF ç¨‹åºä¸å†…æ ¸å…¶ä»–æ¨¡å—è¿›è¡Œäº¤äº’ã€‚æ¯”å¦‚ï¼Œä¸Šä¸€è®²çš„ Hello World ç¤ºä¾‹ä¸­ä½¿ç”¨çš„ bpf_trace_printk() å°±æ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºå‘è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿï¼ˆ/sys/kernel/debug/tracing/trace_pipeï¼‰å†™å…¥è°ƒè¯•ä¿¡æ¯ã€‚</p><p>è¿™é‡Œè¡¥å……ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šä»å†…æ ¸ 5.13 ç‰ˆæœ¬å¼€å§‹ï¼Œéƒ¨åˆ†å†…æ ¸å‡½æ•°ï¼ˆå¦‚&nbsp;<code>tcp_slow_start()</code>ã€<code>tcp_reno_ssthresh()</code>&nbsp;ç­‰ï¼‰ä¹Ÿå¯ä»¥è¢« BPF ç¨‹åºç›´æ¥è°ƒç”¨äº†ï¼Œå…·ä½“ä½ å¯ä»¥æŸ¥çœ‹<a href=\"https://lwn.net/Articles/856005\">è¿™ä¸ªé“¾æ¥</a>ã€‚ ä¸è¿‡ï¼Œè¿™äº›å‡½æ•°åªèƒ½åœ¨ TCP æ‹¥å¡æ§åˆ¶ç®—æ³•çš„ BPF ç¨‹åºä¸­è°ƒç”¨ï¼Œæ‰€ä»¥æœ¬è¯¾ç¨‹ä¸ä¼šè¿‡å¤šå±•å¼€ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„è¾…åŠ©å‡½æ•°éƒ½å¯ä»¥åœ¨ eBPF ç¨‹åºä¸­éšæ„ä½¿ç”¨ï¼Œä¸åŒç±»å‹çš„ eBPF ç¨‹åºæ‰€æ”¯æŒçš„è¾…åŠ©å‡½æ•°æ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚ï¼Œå¯¹äº Hello World ç¤ºä¾‹è¿™ç±»å†…æ ¸æ¢é’ˆï¼ˆkprobeï¼‰ç±»å‹çš„ eBPF ç¨‹åºï¼Œä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ  <code>bpftool feature probe</code>&nbsp;ï¼Œæ¥æŸ¥è¯¢å½“å‰ç³»ç»Ÿæ”¯æŒçš„è¾…åŠ©å‡½æ•°åˆ—è¡¨ï¼š</p><pre><code class=\"language-plain\">$ bpftool feature probe\n...\neBPF helpers supported for program type kprobe:\n\t- bpf_map_lookup_elem\n\t- bpf_map_update_elem\n\t- bpf_map_delete_elem\n\t- bpf_probe_read\n\t- bpf_ktime_get_ns\n\t- bpf_get_prandom_u32\n\t- bpf_get_smp_processor_id\n\t- bpf_tail_call\n\t- bpf_get_current_pid_tgid\n\t- bpf_get_current_uid_gid\n\t- bpf_get_current_comm\n\t- bpf_perf_event_read\n\t- bpf_perf_event_output\n\t- bpf_get_stackid\n\t- bpf_get_current_task\n\t- bpf_current_task_under_cgroup\n\t- bpf_get_numa_node_id\n\t- bpf_probe_read_str\n\t- bpf_perf_event_read_value\n\t- bpf_override_return\n\t- bpf_get_stack\n\t- bpf_get_current_cgroup_id\n\t- bpf_map_push_elem\n\t- bpf_map_pop_elem\n\t- bpf_map_peek_elem\n\t- bpf_send_signal\n\t- bpf_probe_read_user\n\t- bpf_probe_read_kernel\n\t- bpf_probe_read_user_str\n\t- bpf_probe_read_kernel_str\n...\n</code></pre><p>å¯¹äºè¿™äº›è¾…åŠ©å‡½æ•°çš„è¯¦ç»†å®šä¹‰ï¼Œä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ  <code>man bpf-helpers</code>&nbsp;ï¼Œæˆ–è€…å‚è€ƒå†…æ ¸å¤´æ–‡ä»¶ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L1463\">include/uapi/linux/bpf.h</a>&nbsp;ï¼Œæ¥æŸ¥çœ‹å®ƒä»¬çš„è¯¦ç»†å®šä¹‰å’Œä½¿ç”¨è¯´æ˜ã€‚ä¸ºäº†æ–¹ä¾¿ä½ æŒæ¡ï¼Œæˆ‘æŠŠå¸¸ç”¨çš„è¾…åŠ©å‡½æ•°æ•´ç†æˆäº†ä¸€ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥åœ¨éœ€è¦æ—¶å‚è€ƒï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/0b/cb/0b3edac18276a1236dde7135b961d8cb.jpg?wh=1920x1080\" alt=\"å›¾ç‰‡\"></p><p>è¿™å…¶ä¸­ï¼Œéœ€è¦ä½ ç‰¹åˆ«æ³¨æ„çš„æ˜¯ä»¥<code>bpf_probe_read</code>  å¼€å¤´çš„ä¸€ç³»åˆ—å‡½æ•°ã€‚æˆ‘åœ¨ä¸Šä¸€è®²ä¸­å·²ç»æåˆ°ï¼ŒeBPF å†…éƒ¨çš„å†…å­˜ç©ºé—´åªæœ‰å¯„å­˜å™¨å’Œæ ˆã€‚æ‰€ä»¥ï¼Œè¦è®¿é—®å…¶ä»–çš„å†…æ ¸ç©ºé—´æˆ–ç”¨æˆ·ç©ºé—´åœ°å€ï¼Œå°±éœ€è¦å€ŸåŠ©&nbsp;<code>bpf_probe_read</code>  è¿™ä¸€ç³»åˆ—çš„è¾…åŠ©å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¼šè¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥ï¼Œå¹¶ç¦æ­¢ç¼ºé¡µä¸­æ–­çš„å‘ç”Ÿã€‚</p><p>è€Œåœ¨ eBPF ç¨‹åºéœ€è¦å¤§å—å­˜å‚¨æ—¶ï¼Œå°±ä¸èƒ½åƒå¸¸è§„çš„å†…æ ¸ä»£ç é‚£æ ·å»ç›´æ¥åˆ†é…å†…å­˜äº†ï¼Œè€Œæ˜¯å¿…é¡»é€šè¿‡ BPF æ˜ å°„ï¼ˆBPF Mapï¼‰æ¥å®Œæˆã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å¸¦ä½ çœ‹çœ‹ BPF æ˜ å°„çš„å…·ä½“åŸç†ã€‚</p><h2>BPF æ˜ å°„</h2><p>BPF æ˜ å°„ç”¨äºæä¾›å¤§å—çš„é”®å€¼å­˜å‚¨ï¼Œè¿™äº›å­˜å‚¨å¯è¢«ç”¨æˆ·ç©ºé—´ç¨‹åºè®¿é—®ï¼Œè¿›è€Œè·å– eBPF ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ã€‚eBPF ç¨‹åºæœ€å¤šå¯ä»¥è®¿é—® 64 ä¸ªä¸åŒçš„ BPF æ˜ å°„ï¼Œå¹¶ä¸”ä¸åŒçš„ eBPF ç¨‹åºä¹Ÿå¯ä»¥é€šè¿‡ç›¸åŒçš„ BPF æ˜ å°„æ¥å…±äº«å®ƒä»¬çš„çŠ¶æ€ã€‚ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª<a href=\"https://docs.cilium.io/en/stable/bpf\">docs.cilium.io</a>ï¼‰å±•ç¤ºäº†&nbsp;BPF æ˜ å°„çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d8/11/d87b409fa85d3a07973a8689b228cf11.png?wh=576x383\" alt=\"å›¾ç‰‡\" title=\"BPF æ˜ å°„\"></p><p>åœ¨å‰é¢çš„ BPF ç³»ç»Ÿè°ƒç”¨å’Œè¾…åŠ©å‡½æ•°å°èŠ‚ä¸­ï¼Œä½ ä¹Ÿçœ‹åˆ°ï¼Œæœ‰å¾ˆå¤šç³»ç»Ÿè°ƒç”¨å‘½ä»¤å’Œè¾…åŠ©å‡½æ•°éƒ½æ˜¯ç”¨æ¥è®¿é—® BPF æ˜ å°„çš„ã€‚æˆ‘ç›¸ä¿¡ç»†å¿ƒçš„ä½ å·²ç»å‘ç°äº†ï¼šBPF è¾…åŠ©å‡½æ•°ä¸­å¹¶æ²¡æœ‰ BPF æ˜ å°„çš„åˆ›å»ºå‡½æ•°ï¼ŒBPF æ˜ å°„åªèƒ½é€šè¿‡ç”¨æˆ·æ€ç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ¥åˆ›å»ºä¸€ä¸ª BPF æ˜ å°„ï¼Œå¹¶è¿”å›æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ï¼š</p><pre><code class=\"language-c++\">int bpf_create_map(enum bpf_map_type map_type,\n\t\t&nbsp; &nbsp;unsigned int key_size,\n\t\t&nbsp; &nbsp;unsigned int value_size, unsigned int max_entries)\n{\n&nbsp; union bpf_attr attr = {\n&nbsp; &nbsp; .map_type = map_type,\n&nbsp; &nbsp; .key_size = key_size,\n&nbsp; &nbsp; .value_size = value_size,\n&nbsp; &nbsp; .max_entries = max_entries\n&nbsp; };\n&nbsp; return bpf(BPF_MAP_CREATE, &amp;attr, sizeof(attr));\n}\n</code></pre><p>è¿™å…¶ä¸­ï¼Œæœ€å…³é”®çš„æ˜¯è®¾ç½®æ˜ å°„çš„ç±»å‹ã€‚å†…æ ¸å¤´æ–‡ä»¶<a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L867\"> include/uapi/linux/bpf.h </a>ä¸­çš„  <code>bpf_map_type</code> å®šä¹‰äº†æ‰€æœ‰æ”¯æŒçš„æ˜ å°„ç±»å‹ï¼Œä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ bpftool å‘½ä»¤ï¼Œæ¥æŸ¥è¯¢å½“å‰ç³»ç»Ÿæ”¯æŒå“ªäº›æ˜ å°„ç±»å‹ï¼š</p><pre><code class=\"language-bash\">$ bpftool feature probe | grep map_type\neBPF map_type hash is available\neBPF map_type array is available\neBPF map_type prog_array is available\neBPF map_type perf_event_array is available\neBPF map_type percpu_hash is available\neBPF map_type percpu_array is available\neBPF map_type stack_trace is available\n...\n</code></pre><p>åœ¨ä¸‹é¢çš„è¡¨æ ¼ä¸­ï¼Œæˆ‘ç»™ä½ æ•´ç†äº†å‡ ç§æœ€å¸¸ç”¨çš„æ˜ å°„ç±»å‹åŠå…¶åŠŸèƒ½å’Œä½¿ç”¨åœºæ™¯ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/f3/d7/f3210199e6689e7659057a935e7fc5d7.jpg?wh=1920x1080\" alt=\"å›¾ç‰‡\"><br>\nå¦‚æœä½ çš„ eBPF ç¨‹åºä½¿ç”¨äº† BCC åº“ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨é¢„å®šä¹‰çš„å®æ¥ç®€åŒ– BPF æ˜ å°„çš„åˆ›å»ºè¿‡ç¨‹ã€‚æ¯”å¦‚ï¼Œå¯¹å“ˆå¸Œè¡¨æ˜ å°„æ¥è¯´ï¼ŒBCC å®šä¹‰äº†  <code>BPF_HASH(name, key_type=u64, leaf_type=u64, size=10240)</code>ï¼Œå› æ­¤ï¼Œä½ å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‡ ç§æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨æ˜ å°„ï¼š</p><pre><code class=\"language-c++\">// ä½¿ç”¨é»˜è®¤å‚æ•° key_type=u64, leaf_type=u64, size=10240\nBPF_HASH(stats);\n\n// ä½¿ç”¨è‡ªå®šä¹‰keyç±»å‹ï¼Œä¿æŒé»˜è®¤ leaf_type=u64, size=10240\nstruct key_t {\n&nbsp; char c[80];\n};\nBPF_HASH(counts, struct key_t);\n\n// è‡ªå®šä¹‰æ‰€æœ‰å‚æ•°\nBPF_HASH(cpu_time, uint64_t, uint64_t, 4096);\n</code></pre><p>é™¤äº†åˆ›å»ºä¹‹å¤–ï¼Œæ˜ å°„çš„åˆ é™¤ä¹Ÿéœ€è¦ä½ ç‰¹åˆ«æ³¨æ„ã€‚BPF ç³»ç»Ÿè°ƒç”¨ä¸­å¹¶æ²¡æœ‰åˆ é™¤æ˜ å°„çš„å‘½ä»¤ï¼Œè¿™æ˜¯å› ä¸º <strong>BPF æ˜ å°„ä¼šåœ¨ç”¨æˆ·æ€ç¨‹åºå…³é—­æ–‡ä»¶æè¿°ç¬¦çš„æ—¶å€™è‡ªåŠ¨åˆ é™¤</strong>ï¼ˆå³<code>close(fd)</code> ï¼‰ã€‚ å¦‚æœä½ æƒ³åœ¨ç¨‹åºé€€å‡ºåè¿˜ä¿ç•™æ˜ å°„ï¼Œå°±éœ€è¦è°ƒç”¨  <code>BPF_OBJ_PIN</code> å‘½ä»¤ï¼Œå°†æ˜ å°„æŒ‚è½½åˆ° /sys/fs/bpf ä¸­ã€‚</p><p>åœ¨è°ƒè¯• BPF æ˜ å°„ç›¸å…³çš„é—®é¢˜æ—¶ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡ bpftool æ¥æŸ¥çœ‹æˆ–æ“ä½œæ˜ å°„çš„å…·ä½“å†…å®¹ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢è¿™äº›å‘½ä»¤åˆ›å»ºã€æ›´æ–°ã€è¾“å‡ºä»¥åŠåˆ é™¤æ˜ å°„ï¼š</p><pre><code class=\"language-c++\">//åˆ›å»ºä¸€ä¸ªå“ˆå¸Œè¡¨æ˜ å°„ï¼Œå¹¶æŒ‚è½½åˆ°/sys/fs/bpf/stats_map(Keyå’ŒValueçš„å¤§å°éƒ½æ˜¯2å­—èŠ‚)\nbpftool map create /sys/fs/bpf/stats_map type hash key 2 value 2 entries 8 name stats_map\n\n//æŸ¥è¯¢ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ˜ å°„\nbpftool map\n//ç¤ºä¾‹è¾“å‡º\n//340: hash&nbsp; name stats_map&nbsp; flags 0x0\n//&nbsp; &nbsp; &nbsp; &nbsp; key 2B&nbsp; value 2B&nbsp; max_entries 8&nbsp; memlock 4096B\n\n//å‘å“ˆå¸Œè¡¨æ˜ å°„ä¸­æ’å…¥æ•°æ®\nbpftool map update name stats_map key 0xc1 0xc2 value 0xa1 0xa2\n\n//æŸ¥è¯¢å“ˆå¸Œè¡¨æ˜ å°„ä¸­çš„æ‰€æœ‰æ•°æ®\n \nbpftool map dump name stats_map\n//ç¤ºä¾‹è¾“å‡º\n//key: c1 c2&nbsp; value: a1 a2\n//Found 1 element\n\n//åˆ é™¤å“ˆå¸Œè¡¨æ˜ å°„\nrm /sys/fs/bpf/stats_map\n</code></pre><h2><strong>BPF ç±»å‹æ ¼å¼ (BTF)</strong></h2><p>äº†è§£è¿‡ BPF è¾…åŠ©å‡½æ•°å’Œæ˜ å°„ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªå¼€å‘ eBPF ç¨‹åºæ—¶æœ€å¸¸ç¢°åˆ°çš„é—®é¢˜ï¼šå†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</p><p>åœ¨å®‰è£… BCC å·¥å…·çš„æ—¶å€™ï¼Œä½ å¯èƒ½å°±æ³¨æ„åˆ°äº†ï¼Œå†…æ ¸å¤´æ–‡ä»¶ <code>linux-headers-$(uname -r)</code> ä¹Ÿæ˜¯å¿…é¡»è¦å®‰è£…çš„ä¸€ä¸ªä¾èµ–é¡¹ã€‚è¿™æ˜¯å› ä¸º BCC åœ¨ç¼–è¯‘ eBPF ç¨‹åºæ—¶ï¼Œéœ€è¦ä»å†…æ ¸å¤´æ–‡ä»¶ä¸­æ‰¾åˆ°ç›¸åº”çš„å†…æ ¸æ•°æ®ç»“æ„å®šä¹‰ã€‚è¿™æ ·ï¼Œä½ åœ¨è°ƒç”¨ <code>bpf_probe_read</code> æ—¶ï¼Œæ‰èƒ½ä»å†…å­˜åœ°å€ä¸­æå–åˆ°æ­£ç¡®çš„æ•°æ®ç±»å‹ã€‚</p><p>ä½†æ˜¯ï¼Œç¼–è¯‘æ—¶ä¾èµ–å†…æ ¸å¤´æ–‡ä»¶ä¹Ÿä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ã€‚ä¸»è¦æœ‰è¿™ä¸‰ä¸ªæ–¹é¢ï¼š</p><ul>\n<li>é¦–å…ˆï¼Œåœ¨å¼€å‘ eBPF ç¨‹åºæ—¶ï¼Œä¸ºäº†è·å¾—å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œå°±éœ€è¦å¼•å…¥ä¸€å¤§å †çš„å†…æ ¸å¤´æ–‡ä»¶ï¼›</li>\n<li>å…¶æ¬¡ï¼Œå†…æ ¸å¤´æ–‡ä»¶çš„è·¯å¾„å’Œæ•°æ®ç»“æ„å®šä¹‰åœ¨ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­å¾ˆå¯èƒ½ä¸åŒã€‚å› æ­¤ï¼Œä½ åœ¨å‡çº§å†…æ ¸ç‰ˆæœ¬æ—¶ï¼Œå°±ä¼šé‡åˆ°æ‰¾ä¸åˆ°å¤´æ–‡ä»¶å’Œæ•°æ®ç»“æ„å®šä¹‰é”™è¯¯çš„é—®é¢˜ï¼›</li>\n<li>æœ€åï¼Œåœ¨å¾ˆå¤šç”Ÿäº§ç¯å¢ƒçš„æœºå™¨ä¸­ï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œå¹¶ä¸å…è®¸å®‰è£…å†…æ ¸å¤´æ–‡ä»¶ï¼Œè¿™æ—¶å°±æ— æ³•å¾—åˆ°å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚<strong>åœ¨ç¨‹åºä¸­é‡å®šä¹‰æ•°æ®ç»“æ„</strong>è™½ç„¶å¯ä»¥æš‚æ—¶è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†ä¹Ÿå¾ˆå®¹æ˜“æŠŠä½¿ç”¨ç€é”™è¯¯æ•°æ®ç»“æ„çš„ eBPF ç¨‹åºå¸¦å…¥æ–°ç‰ˆæœ¬å†…æ ¸ä¸­è¿è¡Œã€‚</li>\n</ul><p>é‚£ä¹ˆï¼Œè¿™ä¹ˆå¤šçš„é—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿä¸ç”¨æ‹…å¿ƒï¼ŒBPF ç±»å‹æ ¼å¼ï¼ˆBPF Type Format, BTFï¼‰çš„è¯ç”Ÿæ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ã€‚ä»å†…æ ¸ 5.2 å¼€å§‹ï¼Œåªè¦å¼€å¯äº† <code>CONFIG_DEBUG_INFO_BTF</code>ï¼Œåœ¨ç¼–è¯‘å†…æ ¸æ—¶ï¼Œå†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰å°±ä¼šè‡ªåŠ¨å†…åµŒåœ¨å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ vmlinux ä¸­ã€‚å¹¶ä¸”ï¼Œä½ è¿˜å¯ä»¥å€ŸåŠ©ä¸‹é¢çš„å‘½ä»¤ï¼ŒæŠŠè¿™äº›æ•°æ®ç»“æ„çš„å®šä¹‰å¯¼å‡ºåˆ°ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼ˆé€šå¸¸å‘½åä¸º <code>vmlinux.h</code>ï¼‰:</p><pre><code class=\"language-plain\">bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h\n</code></pre><p>å¦‚ä¸‹å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª<a href=\"https://www.grant.pizza/blog/vmlinux-header\">GRANT SELTZERåšå®¢</a>ï¼‰æ‰€ç¤ºï¼Œæœ‰äº†å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œä½ åœ¨å¼€å‘ eBPF ç¨‹åºæ—¶åªéœ€è¦å¼•å…¥ä¸€ä¸ª <code>vmlinux.h</code> å³å¯ï¼Œä¸ç”¨å†å¼•å…¥ä¸€å¤§å †çš„å†…æ ¸å¤´æ–‡ä»¶äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/45/20/45bbf696e8620d322d857ceab3871720.jpg?wh=1920x1204\" alt=\"\" title=\"vmlinux.hçš„ä½¿ç”¨ç¤ºæ„å›¾\"></p><p>åŒæ—¶ï¼Œå€ŸåŠ© BTFã€bpftool ç­‰å·¥å…·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ›´å¥½åœ°äº†è§£ BPF ç¨‹åºçš„å†…éƒ¨ä¿¡æ¯ï¼Œè¿™ä¹Ÿä¼šè®©è°ƒè¯•å˜å¾—æ›´åŠ æ–¹ä¾¿ã€‚æ¯”å¦‚ï¼Œåœ¨æŸ¥çœ‹ BPF æ˜ å°„çš„å†…å®¹æ—¶ï¼Œä½ å¯ä»¥ç›´æ¥çœ‹åˆ°ç»“æ„åŒ–çš„æ•°æ®ï¼Œè€Œä¸åªæ˜¯åå…­è¿›åˆ¶æ•°å€¼ï¼š</p><pre><code class=\"language-c++\"># bpftool map dump id 386\n[\n&nbsp; {\n&nbsp; &nbsp; &nbsp; \"key\": 0,\n&nbsp; &nbsp; &nbsp; \"value\": {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"eth0\": {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"value\": 0,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"ifindex\": 0,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"mac\": []\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; }\n&nbsp; }\n]\n</code></pre><p>è§£å†³äº†å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰é—®é¢˜ï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œ<strong>å¦‚ä½•è®© eBPF ç¨‹åºåœ¨å†…æ ¸å‡çº§ä¹‹åï¼Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å°±å¯ä»¥ç›´æ¥è¿è¡Œ</strong>ã€‚eBPF çš„ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œï¼ˆCompile Once Run Everywhereï¼Œç®€ç§° CO-REï¼‰é¡¹ç›®å€ŸåŠ©äº† BTF æä¾›çš„è°ƒè¯•ä¿¡æ¯ï¼Œå†é€šè¿‡ä¸‹é¢çš„ä¸¤ä¸ªæ­¥éª¤ï¼Œä½¿å¾— eBPF ç¨‹åºå¯ä»¥é€‚é…ä¸åŒç‰ˆæœ¬çš„å†…æ ¸ï¼š</p><ul>\n<li>ç¬¬ä¸€ï¼Œé€šè¿‡å¯¹ BPF ä»£ç ä¸­çš„è®¿é—®åç§»é‡è¿›è¡Œé‡å†™ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­æ•°æ®ç»“æ„åç§»é‡ä¸åŒçš„é—®é¢˜ï¼›</li>\n<li>ç¬¬äºŒï¼Œåœ¨ libbpf ä¸­é¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬ä¸­çš„æ•°æ®ç»“æ„çš„ä¿®æ”¹ï¼Œè§£å†³äº†ä¸åŒå†…æ ¸ä¸­æ•°æ®ç»“æ„ä¸å…¼å®¹çš„é—®é¢˜ã€‚</li>\n</ul><p>BTFå’Œä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œå¸¦æ¥äº†å¾ˆå¤šçš„å¥½å¤„ï¼Œä½†ä½ ä¹Ÿéœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ï¼šå®ƒä»¬éƒ½è¦æ±‚æ¯”è¾ƒæ–°çš„å†…æ ¸ç‰ˆæœ¬ï¼ˆ&gt;=5.2ï¼‰ï¼Œå¹¶ä¸”éœ€è¦éå¸¸æ–°çš„å‘è¡Œç‰ˆï¼ˆå¦‚ Ubuntu 20.10+ã€RHEL 8.2+ ç­‰ï¼‰æ‰ä¼šé»˜è®¤æ‰“å¼€å†…æ ¸é…ç½® <code>CONFIG_DEBUG_INFO_BTF</code>ã€‚å¯¹äºæ—§ç‰ˆæœ¬çš„å†…æ ¸ï¼Œè™½ç„¶å®ƒä»¬ä¸ä¼šå†å»å†…ç½® BTF çš„æ”¯æŒï¼Œä½†å¼€æºç¤¾åŒºæ­£åœ¨å°è¯•é€šè¿‡ <a href=\"https://github.com/aquasecurity/btfhub\">BTFHub</a> ç­‰æ–¹æ³•ï¼Œä¸ºå®ƒä»¬æä¾› BTF è°ƒè¯•ä¿¡æ¯ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº† eBPF ç¨‹åºè·Ÿå†…æ ¸äº¤äº’çš„åŸºæœ¬æ–¹æ³•ã€‚</p><p>ä¸€ä¸ªå®Œæ•´çš„ eBPF ç¨‹åºï¼Œé€šå¸¸åŒ…å«ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¸¤éƒ¨åˆ†ï¼šç”¨æˆ·æ€ç¨‹åºéœ€è¦é€šè¿‡ BPF ç³»ç»Ÿè°ƒç”¨è·Ÿå†…æ ¸è¿›è¡Œäº¤äº’ï¼Œè¿›è€Œå®Œæˆ eBPF ç¨‹åºåŠ è½½ã€äº‹ä»¶æŒ‚è½½ä»¥åŠæ˜ å°„åˆ›å»ºå’Œæ›´æ–°ç­‰ä»»åŠ¡ï¼›è€Œåœ¨å†…æ ¸æ€ä¸­ï¼ŒeBPF ç¨‹åºä¹Ÿä¸èƒ½ä»»æ„è°ƒç”¨å†…æ ¸å‡½æ•°ï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡ BPF è¾…åŠ©å‡½æ•°å®Œæˆæ‰€éœ€çš„ä»»åŠ¡ã€‚å°¤å…¶æ˜¯åœ¨è®¿é—®å†…å­˜åœ°å€çš„æ—¶å€™ï¼Œå¿…é¡»è¦å€ŸåŠ©  <code>bpf_probe_read</code> ç³»åˆ—å‡½æ•°è¯»å–å†…å­˜æ•°æ®ï¼Œä»¥ç¡®ä¿å†…å­˜çš„å®‰å…¨å’Œé«˜æ•ˆè®¿é—®ã€‚</p><p>åœ¨ eBPF ç¨‹åºéœ€è¦å¤§å—å­˜å‚¨æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ ¹æ®åº”ç”¨åœºæ™¯ï¼Œå¼•å…¥ç‰¹å®šç±»å‹çš„ BPF æ˜ å°„ï¼Œå¹¶å€ŸåŠ©å®ƒå‘ç”¨æˆ·ç©ºé—´çš„ç¨‹åºæä¾›è¿è¡ŒçŠ¶æ€çš„æ•°æ®ã€‚</p><p>è¿™ä¸€è®²çš„æœ€åï¼Œæˆ‘è¿˜å¸¦ä½ ä¸€èµ·äº†è§£äº† BTF å’Œ CO-RE é¡¹ç›®ï¼Œå®ƒä»¬åœ¨æä¾›è½»é‡çº§è°ƒè¯•ä¿¡æ¯çš„åŒæ—¶ï¼Œè¿˜è§£å†³äº†è·¨å†…æ ¸ç‰ˆæœ¬çš„å…¼å®¹æ€§é—®é¢˜ã€‚å¾ˆå¤šå¼€æºç¤¾åŒºçš„ eBPF é¡¹ç›®ï¼ˆå¦‚ BCC ç­‰ï¼‰ä¹Ÿéƒ½åœ¨å‘ BTF è¿›è¡Œè¿ç§»ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ æ¥èŠä¸€èŠï¼š</p><ol>\n<li>ä½ æ˜¯å¦‚ä½•ç†è§£ BPF ç³»ç»Ÿè°ƒç”¨å’Œ BPF è¾…åŠ©å‡½æ•°çš„ï¼Ÿ</li>\n<li>é™¤äº†ä»Šå¤©è®²åˆ°çš„å†…å®¹ï¼Œbpftool è¿˜æä¾›äº†å“ªäº›æœ‰è¶£çš„åŠŸèƒ½å‘¢ï¼Ÿç»™ä½ ä¸€ä¸ªå°æç¤ºï¼šå¯ä»¥ä½¿ç”¨ man bpftool æŸ¥è¯¢å®ƒçš„ä½¿ç”¨æ–‡æ¡£ã€‚</li>\n</ol><p>æœŸå¾…ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p>","comments":[{"had_liked":false,"id":332333,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1643181102,"is_pvip":false,"replies":[{"id":121419,"content":"éå¸¸æ£’çš„æ€è€ƒæ€è·¯ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1643203595,"ip_address":"","comment_id":332333,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å€ªè€å¸ˆç•™çš„æ€è€ƒé¢˜æ¯”è¾ƒåŸºç¡€ï¼Œå°è¯•ä»å¦ä¸€ä¸ªè§’åº¦åšä¸‹è§‰å¾—æœ‰è¶£çš„å¯¹æ¯”ï¼š\n\n1ã€bpf ç³»ç»Ÿè°ƒç”¨ä¸€å®šç¨‹åº¦ä¸Šå‚è€ƒäº† perf_event_open è®¾è®¡ï¼Œbpf_attrã€perf_event_attr å‡åŒ…å«äº†å¤§é‡ unionï¼Œç”¨äºé€‚é…ä¸åŒçš„ cmd æˆ–è€…æ€§èƒ½ç›‘æ§äº‹ä»¶ç±»å‹ã€‚å› æ­¤ï¼Œbpfã€perf_event_open æ¥å£çœ‹ä¼¼ç®€å•ï¼Œå…¶å®æ˜¯å¤§æ‚çƒ©ã€‚\n\nbpf(int cmd, union bpf_attr *attr, ...) \nperf_event_open(struct perf_event_attr *attr, ...)\n\n2ã€bpftool å‘½ä»¤è®¾è®¡é£æ ¼é‡åº¦å‚è€ƒäº† iproute2 è½¯ä»¶åŒ…ä¸­çš„ ip å‘½ä»¤ï¼Œç”¨æ³•åŸºæœ¬ä¸Šä¸€è‡´ã€‚\n\nUsage: bpftool [OPTIONS] OBJECT { COMMAND | help }\nUsage: ip [ OPTIONS ] OBJECT { COMMAND | help }\n\næ— è®ºå†…æ ¸å¼€å‘è¿˜æ˜¯å·¥å…·å¼€å‘ï¼Œéƒ½å¯ä»¥çœ‹åˆ°è®¾è®¡æ€è·¯å€Ÿé‰´çš„å½±å­ã€‚å·¥ä½œä¹‹ä½™ä¸å¦¨å¤šäº›å­¦ä¹ ä¸æ€è€ƒï¼Œä¹Ÿè®¸å°±å¯ä»¥æŠŠå¤§å¸ˆä»¬æ¯”è¾ƒå¥½çš„è®¾è®¡æ€è·¯éšæ‰‹ç”¨äºæ‰‹å¤´çš„ä»»åŠ¡ä¹‹ä¸­ã€‚","like_count":34,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548463,"discussion_content":"éå¸¸æ£’çš„æ€è€ƒæ€è·¯ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643203595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115379,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqFcfujkkBkic2ARpPOP4XeEhPNJwA51JJibD79pg4UTA9hS2WnmrSZ0qgiaibdM87dugCeYyNicnYiaFgw/132","nickname":"ermazi","note":"","ucode":"D38B0E9BD701A5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624548,"discussion_content":"å“ªéƒ½æœ‰ä½ , åŒå­¦ è·³æ§½å—?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1690695591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332352,"user_name":"Geek_e8988c","can_delete":false,"product_type":"c1","uid":2171451,"ip_address":"","ucode":"E5B2F025A108B3","user_header":"","comment_is_top":false,"comment_ctime":1643185087,"is_pvip":false,"replies":[{"id":121420,"content":"éå¸¸æ¬£æ…°ä½ åœ¨çœ‹åˆ°ä¸€ä¸ªå…¥é—¨ç¤ºä¾‹å°±èƒ½æ€è€ƒè¿™ä¹ˆå¤šçš„é—®é¢˜ã€‚åŸºç¡€å…¥é—¨ç¯‡çš„å†…å®¹ä¸»è¦ä¾§é‡åœ¨ eBPF æœ¬èº«ï¼Œè€Œå…¶åº”ç”¨çš„æ–¹æ³•éƒ½åŒ…å«åœ¨å®æˆ˜è¿›é˜¶ç¯‡ï¼ˆå…¶å®çœ‹çœ‹ç›®å½•å°±çŸ¥é“è¿™äº›é—®é¢˜éƒ½åŒ…å«åœ¨å®æˆ˜è¿›é˜¶ç¯‡ä¸­ï¼‰ã€‚\n\nä¸è¿‡æ—¢ç„¶é—®åˆ°äº†ï¼Œæˆ‘å°±æå‰å…ˆç»™ä½ ä»‹ç»ä¸€ä¸ªæ–¹ä¾¿çš„å·¥å…· https:&#47;&#47;github.com&#47;iovisor&#47;bpftraceã€‚æƒ³ä½ é—®åˆ°çš„æŸ¥è¯¢è·Ÿè¸ªç‚¹å‡½æ•°ã€æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨æ ¼å¼ã€å¿«é€Ÿè·Ÿè¸ªä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€ç½‘ç»œsocketçš„è·Ÿè¸ªç­‰ç­‰å®ƒéƒ½æ˜¯æ”¯æŒçš„ï¼Œå¹¶ä¸”ç”¨èµ·æ¥å°±åƒSHELLè„šæœ¬ä¸€æ ·æ–¹ä¾¿ã€‚ä½ å¯ä»¥å…ˆå­¦ä¹ ä¸€ä¸‹ï¼Œæˆ‘ä»¬åé¢çš„æ¡ˆä¾‹ä¸­è¿˜ä¼šè®²åˆ°å®ƒçš„è¯¦ç»†ä½¿ç”¨æ–¹æ³•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1643204030,"ip_address":"","comment_id":332352,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"é£å“¥ï¼Œä½ å¥½ï¼Œçœ‹å®Œå‰ä¸¤ç« æ„Ÿè§‰æ¯”è¾ƒè¿·ç³Šã€‚æ²¡èƒ½åšåˆ°å­¦ä»¥è‡´ç”¨ï¼Œæˆ–è€…è¯´ä¸¾ä¸€åä¸‰ã€‚\nä¾‹å¦‚ç¬¬ä¸€ä¸ªebpfç¨‹åºï¼Œé€šè¿‡trace openç³»ç»Ÿè°ƒç”¨æ¥ç›‘æ§åº”ç”¨çš„openåŠ¨ä½œã€‚\né‚£æˆ‘å®é™…ä¸­ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå¿«é€Ÿçš„æ–¹æ¡ˆ&#47;å¥—è·¯æ¥å®Œæˆä¸€äº›å…¶ä»–çš„traceï¼Œä¾‹å¦‚æˆ‘æƒ³çŸ¥é“ç›‘æ§é‚£äº›ç¨‹åºä½¿ç”¨äº†socket&#47;bind(å°¤å…¶é€‚ç”¨äºæœ‰äº›çŸ­æš‚è¿›ç¨‹ä½¿ç”¨udpå‘é€äº†ä¸€äº›æŠ¥æ–‡å°±ç«‹é©¬é€€å‡ºäº†ï¼‰ã€‚\nå½“æˆ‘æƒ³æ–°å¢ä¸€ä¸ªtraceäº‹ä»¶ï¼Œæˆ‘çš„.céœ€è¦å»åŒ…å«é‚£äº›å¤´æ–‡ä»¶ï¼Œæˆ‘çš„.pyéœ€è¦è·Ÿè¸ªé‚£ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚\nè¿™äº›å¤´æ–‡ä»¶ä¸ç³»ç»Ÿè°ƒç”¨åœ¨å“ªå¯ä»¥æ‰¾åˆ°ï¼Œå¦‚æœå»æ‰¾ï¼Ÿ\n\nå¸Œæœ›é£å“¥å¤§ä½¬èƒ½ç»™ä¸ªå¤§ä½“çš„æ¡†æ¶ï¼Œæ€è·¯ï¼Œè°¢è°¢","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548464,"discussion_content":"éå¸¸æ¬£æ…°ä½ åœ¨çœ‹åˆ°ä¸€ä¸ªå…¥é—¨ç¤ºä¾‹å°±èƒ½æ€è€ƒè¿™ä¹ˆå¤šçš„é—®é¢˜ã€‚åŸºç¡€å…¥é—¨ç¯‡çš„å†…å®¹ä¸»è¦ä¾§é‡åœ¨ eBPF æœ¬èº«ï¼Œè€Œå…¶åº”ç”¨çš„æ–¹æ³•éƒ½åŒ…å«åœ¨å®æˆ˜è¿›é˜¶ç¯‡ï¼ˆå…¶å®çœ‹çœ‹ç›®å½•å°±çŸ¥é“è¿™äº›é—®é¢˜éƒ½åŒ…å«åœ¨å®æˆ˜è¿›é˜¶ç¯‡ä¸­ï¼‰ã€‚\n\nä¸è¿‡æ—¢ç„¶é—®åˆ°äº†ï¼Œæˆ‘å°±æå‰å…ˆç»™ä½ ä»‹ç»ä¸€ä¸ªæ–¹ä¾¿çš„å·¥å…· https://github.com/iovisor/bpftraceã€‚æƒ³ä½ é—®åˆ°çš„æŸ¥è¯¢è·Ÿè¸ªç‚¹å‡½æ•°ã€æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨æ ¼å¼ã€å¿«é€Ÿè·Ÿè¸ªä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€ç½‘ç»œsocketçš„è·Ÿè¸ªç­‰ç­‰å®ƒéƒ½æ˜¯æ”¯æŒçš„ï¼Œå¹¶ä¸”ç”¨èµ·æ¥å°±åƒSHELLè„šæœ¬ä¸€æ ·æ–¹ä¾¿ã€‚ä½ å¯ä»¥å…ˆå­¦ä¹ ä¸€ä¸‹ï¼Œæˆ‘ä»¬åé¢çš„æ¡ˆä¾‹ä¸­è¿˜ä¼šè®²åˆ°å®ƒçš„è¯¦ç»†ä½¿ç”¨æ–¹æ³•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643204030,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332680,"user_name":"å†™ç‚¹å•¥å‘¢","can_delete":false,"product_type":"c1","uid":1065272,"ip_address":"","ucode":"C19032CF1C41BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","comment_is_top":false,"comment_ctime":1643463566,"is_pvip":false,"replies":[{"id":121659,"content":"éå¸¸å¥½çš„é—®é¢˜ã€‚ctrl-cå…¶å®ç»ˆæ­¢çš„æ˜¯ç”¨æˆ·ç©ºé—´çš„ç¨‹åºï¼Œç»ˆæ­¢åæ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦éƒ½ä¼šé‡Šæ”¾æ‰ï¼Œå¯¹åº”çš„mapå’Œebpfç¨‹åºå¼•ç”¨éƒ½ä¼šå‡åˆ°0ï¼Œè¿›è€Œå®ƒä»¬ä¹Ÿå°±è¢«è‡ªåŠ¨å›æ”¶äº†ã€‚è¿™äº›éƒ½æ˜¯è‡ªåŠ¨çš„ï¼Œä¸éœ€è¦åœ¨ç¨‹åºé‡Œé¢å¢åŠ é¢å¤–çš„å¤„ç†é€»è¾‘ã€‚\n\nå½“ç„¶ï¼Œåœ¨éœ€è¦é•¿ä¹…ä¿æŒeBPFç¨‹åºçš„æƒ…å¢ƒä¸­ï¼ˆæ¯”å¦‚XDPå’ŒTCç¨‹åºï¼‰ï¼ŒeBPFç¨‹åºå’Œmapçš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¯ä»¥åœ¨ç¨‹åºå†…æ§åˆ¶çš„ï¼Œæ¯”å¦‚é€šè¿‡ tcã€ip ä»¥åŠ bpftool ç­‰å·¥å…·ï¼ˆå½“ç„¶å®ƒä»¬ä¹Ÿéƒ½æœ‰ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚æˆ‘ä»¬è¯¾ç¨‹åé¢è¿˜ä¼šè®²åˆ°ç›¸å…³çš„æ¡ˆä¾‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1643811612,"ip_address":"","comment_id":332680,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æƒ³è¯·æ•™ä¸‹è€å¸ˆå…³äºbpfå†…æ ¸æ€ç¨‹åºçš„æˆåå‘¨æœŸï¼Œæ¯”å¦‚å‰å‡ èŠ‚è¯¾çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘é€šè¿‡ctrl-cç»ˆç«¯ç”¨æˆ·æ€ç¨‹åºçš„æ—¶å€™åœ¨bpfè™šæ‹Ÿæœºä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ç†è§£åº”è¯¥ä¼šç»“æŸå·²ç»åŠ è½½çš„bpfæŒ‡ä»¤ï¼Œæ¸…ç†mapä¹‹ç±»çš„èµ„æºç­‰ç­‰ï¼Œå…·ä½“ä¼šæœ‰å“ªäº›ï¼Œè¿™äº›æ“ä½œæ˜¯å¦‚ä½•åœ¨æˆ‘ä»¬ç¨‹åºä¸­è‡ªåŠ¨æ’å…¥å’Œå®ç°ï¼Œè¯·è€å¸ˆæŒ‡ç‚¹ä¸‹ã€‚","like_count":4,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549288,"discussion_content":"éå¸¸å¥½çš„é—®é¢˜ã€‚ctrl-cå…¶å®ç»ˆæ­¢çš„æ˜¯ç”¨æˆ·ç©ºé—´çš„ç¨‹åºï¼Œç»ˆæ­¢åæ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦éƒ½ä¼šé‡Šæ”¾æ‰ï¼Œå¯¹åº”çš„mapå’Œebpfç¨‹åºå¼•ç”¨éƒ½ä¼šå‡åˆ°0ï¼Œè¿›è€Œå®ƒä»¬ä¹Ÿå°±è¢«è‡ªåŠ¨å›æ”¶äº†ã€‚è¿™äº›éƒ½æ˜¯è‡ªåŠ¨çš„ï¼Œä¸éœ€è¦åœ¨ç¨‹åºé‡Œé¢å¢åŠ é¢å¤–çš„å¤„ç†é€»è¾‘ã€‚\n\nå½“ç„¶ï¼Œåœ¨éœ€è¦é•¿ä¹…ä¿æŒeBPFç¨‹åºçš„æƒ…å¢ƒä¸­ï¼ˆæ¯”å¦‚XDPå’ŒTCç¨‹åºï¼‰ï¼ŒeBPFç¨‹åºå’Œmapçš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¯ä»¥åœ¨ç¨‹åºå†…æ§åˆ¶çš„ï¼Œæ¯”å¦‚é€šè¿‡ tcã€ip ä»¥åŠ bpftool ç­‰å·¥å…·ï¼ˆå½“ç„¶å®ƒä»¬ä¹Ÿéƒ½æœ‰ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚æˆ‘ä»¬è¯¾ç¨‹åé¢è¿˜ä¼šè®²åˆ°ç›¸å…³çš„æ¡ˆä¾‹ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1643811612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332561,"user_name":"ä¸äº†å³°","can_delete":false,"product_type":"c1","uid":1013424,"ip_address":"","ucode":"E23B96D6A3D4EC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/b0/14fec62f.jpg","comment_is_top":false,"comment_ctime":1643341986,"is_pvip":false,"replies":[{"id":121564,"content":"ä¸é”™çš„æ€»ç»“ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1643460891,"ip_address":"","comment_id":332561,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"BPF ç³»ç»Ÿè°ƒç”¨  --&gt; å‘ç”Ÿåœ¨ ç”¨æˆ·æ€\nBPF è¾…åŠ©å‡½æ•°  --&gt; å†…æ ¸æ€\n---\nroot@ubuntu-impish:&#47;proc# bpftool perf\npid 38110  fd 6: prog_id 572  kprobe  func do_sys_openat2  offset 0\n\nroot@ubuntu-impish:&#47;proc# ps -ef|grep 38110\nroot       38110   38109  0 03:41 pts&#47;2    00:00:02 python3 .&#47;trace_open.py","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548961,"discussion_content":"ä¸é”™çš„æ€»ç»“ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643460891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338180,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1647336842,"is_pvip":true,"replies":[{"id":123957,"content":"mapæ˜¯è‡ªåŠ¨åˆ é™¤çš„ï¼Œè·Ÿå®ƒå…³è”çš„æ–‡ä»¶æè¿°ç¬¦å…³é—­åå°±ä¼šåˆ é™¤","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1647958835,"ip_address":"","comment_id":338180,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œ bpf çš„ map æ€ä¹ˆç§»é™¤å•Šï¼Ÿ æ²¡çœ‹åˆ° bpftools çš„å‘½ä»¤","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557770,"discussion_content":"mapæ˜¯è‡ªåŠ¨åˆ é™¤çš„ï¼Œè·Ÿå®ƒå…³è”çš„æ–‡ä»¶æè¿°ç¬¦å…³é—­åå°±ä¼šåˆ é™¤","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1647958835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1674369,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqf54z1ZmqQY1kmJ6t1HAnrqMM3j6WKf0oDeVLhtnA2ZUKY6AX9MK6RjvcO8SiczXy3uU0IzBQ3tpw/132","nickname":"Geek_68d3d2","note":"","ucode":"EBD6D881AA7A74","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":627130,"discussion_content":"ç›´æ¥rm /sys/fs/bpfä¸‹çš„æ–‡ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1693820860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120024,"avatar":"https://static001.geekbang.org/account/avatar/00/11/17/18/e4382a8e.jpg","nickname":"æœ‰è¯†ä¹‹å£«","note":"","ucode":"23F5594193D200","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621703,"discussion_content":"bpf map ç”Ÿå‘½å‘¨æœŸå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  http://arthurchiao.art/blog/lifetime-of-bpf-objects-zh/ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687523909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333008,"user_name":"Geek_59a6f9","can_delete":false,"product_type":"c1","uid":2102108,"ip_address":"","ucode":"6CDDE9A4E57917","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJlaNica7xRH6LlMNJtrbK0toc1od8YdqLZOD2AbnOZ2QyKC13gvrrL9cOx5dyYNcsHnJkR6K4ibxZQ/132","comment_is_top":false,"comment_ctime":1643955026,"is_pvip":false,"replies":[{"id":121729,"content":"ä»ä½ç‰ˆæœ¬åˆ°é«˜ç‰ˆæœ¬çš„å…¼å®¹æ€§å¯ä»¥ç”¨CO-REè§£å†³ï¼ˆCO-REåªåœ¨æ–°ç‰ˆæœ¬å†…æ ¸æ‰æ”¯æŒï¼‰ï¼Œè€Œåè¿‡æ¥å°±éœ€è¦åœ¨eBPFå†…éƒ¨åŠ ä¸Šé¢å¤–çš„ä»£ç æ¥å¤„ç†äº†ã€‚æ¯”å¦‚æ ¹æ®å†…æ ¸ç‰ˆæœ¬ä½œæ¡ä»¶ç¼–è¯‘ï¼Œä½ç‰ˆæœ¬å†…æ ¸æ‰§è¡Œä¸åŒçš„é€»è¾‘ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644116556,"ip_address":"","comment_id":333008,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"åœ¨é«˜ç‰ˆæœ¬å†…æ ¸ç¼–è¯‘è¿è¡Œçš„ebpfç¨‹åºï¼Œç§»æ¤åˆ°ä½ç‰ˆæœ¬ä¹Ÿèƒ½ç›´æ¥è¿è¡Œå—ï¼Ÿä½ç‰ˆæœ¬çš„libbpf å¦‚ä½•æ„ŸçŸ¥åˆ°é«˜ç‰ˆæœ¬å†…æ ¸çš„ä¿®æ”¹ï¼Œä»è€Œé¢„å®šä¹‰ä¸åŒå†…æ ¸ç‰ˆæœ¬çš„æ•°æ®ç»“æ„å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549586,"discussion_content":"ä»ä½ç‰ˆæœ¬åˆ°é«˜ç‰ˆæœ¬çš„å…¼å®¹æ€§å¯ä»¥ç”¨CO-REè§£å†³ï¼ˆCO-REåªåœ¨æ–°ç‰ˆæœ¬å†…æ ¸æ‰æ”¯æŒï¼‰ï¼Œè€Œåè¿‡æ¥å°±éœ€è¦åœ¨eBPFå†…éƒ¨åŠ ä¸Šé¢å¤–çš„ä»£ç æ¥å¤„ç†äº†ã€‚æ¯”å¦‚æ ¹æ®å†…æ ¸ç‰ˆæœ¬ä½œæ¡ä»¶ç¼–è¯‘ï¼Œä½ç‰ˆæœ¬å†…æ ¸æ‰§è¡Œä¸åŒçš„é€»è¾‘ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1644116557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":365428,"user_name":"â”‚ï¼Sk","can_delete":false,"product_type":"c1","uid":2453415,"ip_address":"ä¸Šæµ·","ucode":"A2EEB2E9585A77","user_header":"https://static001.geekbang.org/account/avatar/00/25/6f/a7/565214bc.jpg","comment_is_top":false,"comment_ctime":1672502253,"is_pvip":false,"replies":[{"id":134633,"content":"ä¸è¡Œçš„ï¼Œå®ƒéœ€è¦è¿è¡Œçš„å†…æ ¸ä¹Ÿæ”¯æŒBTFã€‚\n\nä¸è¿‡ç°åœ¨æœ€æ–°çš„bpftoolå·²ç»æ”¯æŒå¯¼å‡ºBTFï¼Œè·ŸeBPFç¨‹åºä¸€é€šåˆ†å‘åä¹Ÿå¯ä»¥æ‰§è¡Œäº†ã€‚å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ªåšå®¢ https:&#47;&#47;www.inspektor-gadget.io&#47;&#47;blog&#47;2022&#47;03&#47;btfgen-one-step-closer-to-truly-portable-ebpf-programs&#47;","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1677500164,"ip_address":"ä¸Šæµ·","comment_id":365428,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å€ªè€å¸ˆå¥½ï¼Œ\n\næƒ³è¯·æ•™ä¸€ä¸‹ï¼Œåœ¨æ”¯æŒ BTF çš„å†…æ ¸ä¸­ï¼Œåˆ©ç”¨ CO-RE ç¼–è¯‘å‡ºçš„ ebpf ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç›´æ¥ copy åˆ°ä½ç‰ˆæœ¬ä¸æ”¯æŒ BTF çš„å†…æ ¸ç‰ˆæœ¬çš„ç³»ç»Ÿä¸Šèƒ½æ­£å¸¸è¿è¡Œå—ï¼Ÿ è°¢è°¢ï¼","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606944,"discussion_content":"ä¸è¡Œçš„ï¼Œå®ƒéœ€è¦è¿è¡Œçš„å†…æ ¸ä¹Ÿæ”¯æŒBTFã€‚\n\nä¸è¿‡ç°åœ¨æœ€æ–°çš„bpftoolå·²ç»æ”¯æŒå¯¼å‡ºBTFï¼Œè·ŸeBPFç¨‹åºä¸€é€šåˆ†å‘åä¹Ÿå¯ä»¥æ‰§è¡Œäº†ã€‚å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ªåšå®¢ https://www.inspektor-gadget.io//blog/2022/03/btfgen-one-step-closer-to-truly-portable-ebpf-programs/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677500164,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354598,"user_name":"MoGeJiErğŸ”","can_delete":false,"product_type":"c1","uid":1882960,"ip_address":"æ±Ÿè‹","ucode":"B7F0477730F294","user_header":"https://static001.geekbang.org/account/avatar/00/1c/bb/50/c8ebd5e1.jpg","comment_is_top":false,"comment_ctime":1660575977,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"BTFé‚£å—æ˜¯ä¸æ˜¯æ²¡è¯´å®Œé˜¿ï¼Ÿä¸æ˜¯åªä»‹ç»äº†å¯ä»¥ä½¿ç”¨bpftoolç”Ÿæˆvmlinux.hå¤´æ–‡ä»¶å˜›ï¼Ÿ æ€ä¹ˆåé¢CO-REå°±å¯ä»¥å€ŸåŠ©BTFçš„è°ƒè¯•ä¿¡æ¯ï¼Ÿè¿™ä¸ªè°ƒè¯•ä¿¡æ¯å“ªé‡Œæ¥ï¼Ÿä¸€å¤´é›¾æ°´ã€‚","like_count":1},{"had_liked":false,"id":342948,"user_name":"woJA1wCgAAbjKldokPvO1h9ZEJTUP8ug","can_delete":false,"product_type":"c1","uid":2930048,"ip_address":"","ucode":"F329F4882868C4","user_header":"","comment_is_top":false,"comment_ctime":1650544183,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œç»“æ„åŒ–çš„æ•°æ®éœ€è¦æ€ä¹ˆçœ‹ï¼Œbpftool map dump id mapidå’Œbpftool map dump name mapnameç»“æœéƒ½æ˜¯ä¸€æ ·çš„16è¿›åˆ¶æ•°","like_count":1},{"had_liked":false,"id":389025,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1397271,"ip_address":"å››å·","ucode":"B62BEA525A64A1","user_header":"https://static001.geekbang.org/account/avatar/00/15/52/17/e3015ba5.jpg","comment_is_top":false,"comment_ctime":1711417365,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œè¯·é—®ä¸‹ebpfå¯¹ç³»ç»Ÿå†…æ ¸çš„è¦æ±‚ï¼Œå¯ä»¥é€šè¿‡å®¹å™¨çš„æ“ä½œç³»ç»Ÿæ¥å±è”½æ‰å¯¹å—ï¼Ÿ ä¸è¦æ±‚ç‰©ç†æœºèŠ‚ç‚¹çš„å†…æ ¸ç‰ˆæœ¬å§ï¼Ÿ ","like_count":0},{"had_liked":false,"id":385276,"user_name":"Geek_94444c","can_delete":false,"product_type":"c1","uid":2415951,"ip_address":"å››å·","ucode":"29D599E99D7A02","user_header":"","comment_is_top":false,"comment_ctime":1702372362,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"&quot;eBPF ç¨‹åºæœ€å¤šå¯ä»¥è®¿é—® 64 ä¸ªä¸åŒçš„ BPF æ˜ å°„&quot; \n1. è¿™å¥è¯çš„æ„æ€æ˜¯å•ä¸ªç”¨æˆ·æ€çš„ebpfç¨‹åºèƒ½åˆ›å»º64ä¸ªmapï¼Œè¿˜æ˜¯ä¸»æœºä¸Šæ‰€æœ‰ebpfç¨‹åºåŠ èµ·æ¥å¯ä»¥åˆ›å»º64ä¸ªå†…æ ¸æ€çš„ebpfç¨‹åºï¼Ÿ\n2. ç”¨æˆ·æ€çš„ebpfç¨‹åºæ€ä¹ˆç»‘å®šè¿™äº›mapçš„ï¼Œæœ‰å®ä¾‹å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":372576,"user_name":"æœä¸œ","can_delete":false,"product_type":"c1","uid":1192878,"ip_address":"å¹¿ä¸œ","ucode":"6B87460865DDAC","user_header":"https://static001.geekbang.org/account/avatar/00/12/33/ae/5e05b9dc.jpg","comment_is_top":false,"comment_ctime":1681293789,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"ä½ å¥½ï¼Œå¶å°”é‡åˆ°ä¸ªé—®é¢˜ï¼Œåœ¨bpfåŠ è½½æˆåŠŸåï¼Œæ²¡çœ‹åˆ°prink åˆ°pipe è°ƒè¯•æ‰“å°ï¼Œé‡å¯ç³»ç»Ÿå°±æ¢å¤ï¼Œä¸çŸ¥ä»€ä¹ˆåŸå› ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ec/0e/d64d4663.jpg","nickname":"k8svip","note":"","ucode":"89F02243735432","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":620305,"discussion_content":"echo 1 &gt; /sys/kernel/tracing/tracing_on","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1686040383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370122,"user_name":"å°å°_zoe","can_delete":false,"product_type":"c1","uid":2308893,"ip_address":"æµ™æ±Ÿ","ucode":"28BA9118B60361","user_header":"https://static001.geekbang.org/account/avatar/00/23/3b/1d/cbfbd93e.jpg","comment_is_top":false,"comment_ctime":1678415005,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"æœ‰æ²¡æœ‰è¯¦ç»†çš„ä»˜è´¹å­¦ä¹ ç¾¤ï¼Ÿ","like_count":0},{"had_liked":false,"id":358156,"user_name":"å¼ Dave","can_delete":false,"product_type":"c1","uid":2440338,"ip_address":"å››å·","ucode":"0E8B6FDEB7505B","user_header":"https://static001.geekbang.org/account/avatar/00/25/3c/92/81fa306d.jpg","comment_is_top":false,"comment_ctime":1663980818,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œè¯·é—®ä¸‹ï¼Œä¸€æ¬¡ç¼–è¯‘åˆ°å¤„æ‰§è¡Œï¼Œå“ªé‡Œè¿˜æœ‰æ›´è¯¦ç»†çš„è§£é‡Šå‘¢ï¼Ÿ\næ²¡å¤ªæ˜ç™½æ–‡ä¸­æ€»ç»“çš„ä¸¤ç‚¹å…·ä½“æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ","like_count":0},{"had_liked":false,"id":344958,"user_name":"ãƒ¾(â—Â°âˆ‡Â°â—)ï¾‰ï¾","can_delete":false,"product_type":"c1","uid":1044175,"ip_address":"","ucode":"89545632BDA56E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOBwR7MCVqwZbPA5RQ2mjUjd571jUXUcBCE7lY5vSMibWn8D5S4PzDZMaAhRPdnRBqYbVOBTJibhJg/132","comment_is_top":false,"comment_ctime":1651896034,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨æ¯”å¦‚åœ¨jdbcè¿æ¥çš„æ—¶å€™ï¼Œæœ‰æ—¶å€™ä¸€äº›é˜²ç«å¢™æˆ–è€…VPNä»€ä¹ˆç¬é—´çš„åŸå› ä¼šå¯¼è‡´è¿™ä¸ªè¿æ¥è¦å¡ä½å¾ˆé•¿æ—¶é—´ï¼ˆé€šå¸¸æ˜¯2å°æ—¶15åˆ†ï¼‰ï¼Œæœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥å¿«é€Ÿæ¢æµ‹å¹¶ç»“æŸè¿™ç§TCPåé¦ˆç»™å®¢æˆ·ç«¯ï¼Œebpfè¿™ä¸ªæ‰‹æ®µå¯ä»¥å˜›ï¼Ÿ","like_count":0},{"had_liked":false,"id":343408,"user_name":"reonard","can_delete":false,"product_type":"c1","uid":1029378,"ip_address":"","ucode":"24F7980E11BA56","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b5/02/3bf0509e.jpg","comment_is_top":false,"comment_ctime":1650818868,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"å€ªè€å¸ˆå¥½ï¼Œæˆ‘è¯•äº†4.18çš„å†…æ ¸ï¼Œä¹Ÿå¯ä»¥ç”¨bpftool btf dump file &#47;sys&#47;kernel&#47;btf&#47;vmlinux format c è·å¾—vmlinux.hï¼Œæ˜¯ä¸æ˜¯å°±ä¸éœ€è¦5.2çš„å†…æ ¸äº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1115379,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqFcfujkkBkic2ARpPOP4XeEhPNJwA51JJibD79pg4UTA9hS2WnmrSZ0qgiaibdM87dugCeYyNicnYiaFgw/132","nickname":"ermazi","note":"","ucode":"D38B0E9BD701A5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624547,"discussion_content":"è¿™ä¸ªå·¥å…·åªæ˜¯èƒ½æ–¹ä¾¿çš„å¯¼å‡º ç›¸åº”å†…æ ¸çš„ bpf å¤´, è·Ÿéœ€ä¸éœ€è¦é«˜ç‰ˆæœ¬æ²¡å•¥å…³ç³», ç‰ˆæœ¬çš„å·®åˆ«åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸»è¦æ˜¯ cmd, map, BTF æ”¯æŒçš„å·®å¼‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1690695431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}