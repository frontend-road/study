{"id":425005,"title":"22ï½œé˜¶æ®µå®æ“ï¼ˆ2ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-åŸºæœ¬æµç¨‹","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ä¸Šç¯‡æˆ‘ä»¬çš„KV storeåˆšå¼€äº†ä¸ªå¤´ï¼Œå†™å¥½äº†åŸºæœ¬çš„æ¥å£ã€‚ä½ æ˜¯ä¸æ˜¯æ‘©æ‹³æ“¦æŒå‡†å¤‡å¼€å§‹å†™å…·ä½“å®ç°çš„ä»£ç äº†ï¼Ÿåˆ«ç€æ€¥ï¼Œå½“å®šä¹‰å¥½æ¥å£åï¼Œå…ˆä¸å¿™å®ç°ï¼Œåœ¨æ’°å†™æ›´å¤šä»£ç å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªä½¿ç”¨è€…çš„è§’åº¦æ¥ä½“éªŒæ¥å£å¦‚ä½•ä½¿ç”¨ã€æ˜¯å¦å¥½ç”¨ï¼Œåè§‚è®¾è®¡æœ‰å“ªäº›åœ°æ–¹æœ‰å¾…å®Œå–„ã€‚</p><p>è¿˜æ˜¯æŒ‰ç…§ä¸Šä¸€è®²å®šä¹‰æ¥å£çš„é¡ºåºæ¥ä¸€ä¸ªä¸€ä¸ªæµ‹è¯•ï¼šé¦–å…ˆæˆ‘ä»¬æ¥æ„å»ºåè®®å±‚ã€‚</p><h3>å®ç°å¹¶éªŒè¯åè®®å±‚</h3><p>å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼š<code>cargo new kv --lib</code>ã€‚è¿›å…¥åˆ°é¡¹ç›®ç›®å½•ï¼Œåœ¨ Cargo.toml ä¸­æ·»åŠ ä¾èµ–ï¼š</p><pre><code class=\"language-rust\">[package]\nname = \"kv\"\nversion = \"0.1.0\"\nedition = \"2018\"\n\n[dependencies]\nbytes = \"1\" # é«˜æ•ˆå¤„ç†ç½‘ç»œ buffer çš„åº“\nprost = \"0.8\" # å¤„ç† protobuf çš„ä»£ç \ntracing = \"0.1\" # æ—¥å¿—å¤„ç†\n\n[dev-dependencies]\nanyhow = \"1\" # é”™è¯¯å¤„ç†\nasync-prost = \"0.2.1\" # æ”¯æŒæŠŠ protobuf å°è£…æˆ TCP frame\nfutures = \"0.3\" # æä¾› Stream trait\ntokio = { version = \"1\", features = [\"rt\", \"rt-multi-thread\", \"io-util\", \"macros\", \"net\" ] } # å¼‚æ­¥ç½‘ç»œåº“\ntracing-subscriber = \"0.2\" # æ—¥å¿—å¤„ç†\n\n[build-dependencies]\nprost-build = \"0.8\" # ç¼–è¯‘ protobuf\n</code></pre><!-- [[[read_end]]] --><p>ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º abi.protoï¼ŒæŠŠä¸Šæ–‡ä¸­ protobuf çš„ä»£ç æ”¾è¿›å»ã€‚åœ¨æ ¹ç›®å½•ä¸‹ï¼Œå†åˆ›å»º <a href=\"http://build.rs\">build.rs</a>ï¼š</p><pre><code class=\"language-rust\">fn main() {\n    let mut config = prost_build::Config::new();\n    config.bytes(&amp;[\".\"]);\n    config.type_attribute(\".\", \"#[derive(PartialOrd)]\");\n    config\n        .out_dir(\"src/pb\")\n        .compile_protos(&amp;[\"abi.proto\"], &amp;[\".\"])\n        .unwrap();\n}\n</code></pre><p>è¿™ä¸ªä»£ç åœ¨<a href=\"https://time.geekbang.org/column/article/413634\">ç¬¬ 5 è®²</a>å·²ç»è§è¿‡äº†ï¼Œ<a href=\"http://build.rs\">build.rs</a> åœ¨ç¼–è¯‘æœŸè¿è¡Œæ¥è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä¸ºç¼–è¯‘å‡ºæ¥çš„ä»£ç é¢å¤–æ·»åŠ äº†ä¸€äº›å±æ€§ã€‚æ¯”å¦‚ä¸º protobuf çš„ bytes ç±»å‹ç”Ÿæˆ Bytes è€Œéç¼ºçœçš„ Vec&lt;u8&gt;ï¼Œä¸ºæ‰€æœ‰ç±»å‹åŠ å…¥ PartialOrd æ´¾ç”Ÿå®ã€‚å…³äº prost-build çš„æ‰©å±•ï¼Œä½ å¯ä»¥çœ‹<a href=\"https://docs.rs/prost-build/0.8.0/prost_build/struct.Config.html\">æ–‡æ¡£</a>ã€‚</p><p>è®°å¾—åˆ›å»º src/pb ç›®å½•ï¼Œå¦åˆ™ç¼–ä¸è¿‡ã€‚ç°åœ¨ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åš <code>cargo build</code> ä¼šç”Ÿæˆ src/pb/abi.rs æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«æ‰€æœ‰ protobuf å®šä¹‰çš„æ¶ˆæ¯çš„ Rust æ•°æ®ç»“æ„ã€‚æˆ‘ä»¬åˆ›å»º src/pb/mod.rsï¼Œå¼•å…¥ <a href=\"http://abi.rs\">abi.rs</a>ï¼Œå¹¶åšä¸€äº›åŸºæœ¬çš„ç±»å‹è½¬æ¢ï¼š</p><pre><code class=\"language-rust\">pub mod abi;\n\nuse abi::{command_request::RequestData, *};\n\nimpl CommandRequest {\n    /// åˆ›å»º HSET å‘½ä»¤\n    pub fn new_hset(table: impl Into&lt;String&gt;, key: impl Into&lt;String&gt;, value: Value) -&gt; Self {\n        Self {\n            request_data: Some(RequestData::Hset(Hset {\n                table: table.into(),\n                pair: Some(Kvpair::new(key, value)),\n            })),\n        }\n    }\n}\n\nimpl Kvpair {\n    /// åˆ›å»ºä¸€ä¸ªæ–°çš„ kv pair\n    pub fn new(key: impl Into&lt;String&gt;, value: Value) -&gt; Self {\n        Self {\n            key: key.into(),\n            value: Some(value),\n        }\n    }\n}\n\n/// ä» String è½¬æ¢æˆ Value\nimpl From&lt;String&gt; for Value {\n    fn from(s: String) -&gt; Self {\n        Self {\n            value: Some(value::Value::String(s)),\n        }\n    }\n}\n\n/// ä» &amp;str è½¬æ¢æˆ Value\nimpl From&lt;&amp;str&gt; for Value {\n    fn from(s: &amp;str) -&gt; Self {\n        Self {\n            value: Some(value::Value::String(s.into())),\n        }\n    }\n}\n</code></pre><p>æœ€åï¼Œåœ¨ src/lib.rs  ä¸­ï¼Œå¼•å…¥ pb æ¨¡å—ï¼š</p><pre><code class=\"language-rust\">mod pb;\npub use pb::abi::*;\n</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰äº†èƒ½æŠŠ KV server æœ€åŸºæœ¬çš„ protobuf æ¥å£è¿è½¬èµ·æ¥çš„ä»£ç ã€‚</p><p>åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º examplesï¼Œè¿™æ ·å¯ä»¥å†™ä¸€äº›ä»£ç æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åè®®ã€‚æˆ‘ä»¬å¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ª examples/client.rs æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse async_prost::AsyncProstStream;\nuse futures::prelude::*;\nuse kv::{CommandRequest, CommandResponse};\nuse tokio::net::TcpStream;\nuse tracing::info;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    tracing_subscriber::fmt::init();\n\n    let addr = \"127.0.0.1:9527\";\n    // è¿æ¥æœåŠ¡å™¨\n    let stream = TcpStream::connect(addr).await?;\n\n    // ä½¿ç”¨ AsyncProstStream æ¥å¤„ç† TCP Frame\n    let mut client =\n        AsyncProstStream::&lt;_, CommandResponse, CommandRequest, _&gt;::from(stream).for_async();\n\n    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤\n    let cmd = CommandRequest::new_hset(\"table1\", \"hello\", \"world\".into());\n\n    // å‘é€ HSET å‘½ä»¤\n    client.send(cmd).await?;\n    if let Some(Ok(data)) = client.next().await {\n        info!(\"Got response {:?}\", data);\n    }\n\n    Ok(())\n}\n</code></pre><p>è¿™æ®µä»£ç è¿æ¥æœåŠ¡å™¨çš„ 9527 ç«¯å£ï¼Œå‘é€ä¸€ä¸ª HSET å‘½ä»¤å‡ºå»ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨çš„å“åº”ã€‚</p><p>åŒæ ·çš„ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª examples/dummy_server.rs æ–‡ä»¶ï¼Œå†™å…¥ä»£ç ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse async_prost::AsyncProstStream;\nuse futures::prelude::*;\nuse kv::{CommandRequest, CommandResponse};\nuse tokio::net::TcpListener;\nuse tracing::info;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    tracing_subscriber::fmt::init();\n    let addr = \"127.0.0.1:9527\";\n    let listener = TcpListener::bind(addr).await?;\n    info!(\"Start listening on {}\", addr);\n    loop {\n        let (stream, addr) = listener.accept().await?;\n        info!(\"Client {:?} connected\", addr);\n        tokio::spawn(async move {\n            let mut stream =\n                AsyncProstStream::&lt;_, CommandRequest, CommandResponse, _&gt;::from(stream).for_async();\n            while let Some(Ok(msg)) = stream.next().await {\n                info!(\"Got a new command: {:?}\", msg);\n\t\t\t\t\t\t\t\t// åˆ›å»ºä¸€ä¸ª 404 response è¿”å›ç»™å®¢æˆ·ç«¯\n                let mut resp = CommandResponse::default();\n                resp.status = 404;\n                resp.message = \"Not found\".to_string();\n                stream.send(resp).await.unwrap();\n            }\n            info!(\"Client {:?} disconnected\", addr);\n        });\n    }\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç é‡Œï¼ŒæœåŠ¡å™¨ç›‘å¬ 9527 ç«¯å£ï¼Œå¯¹ä»»ä½•å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¸€å¾‹è¿”å› status = 404ï¼Œmessage æ˜¯ â€œNot foundâ€ çš„å“åº”ã€‚</p><p>å¦‚æœä½ å¯¹è¿™ä¸¤æ®µä»£ç ä¸­çš„å¼‚æ­¥å’Œç½‘ç»œå¤„ç†åŠæ‡‚ä¸æ‡‚ï¼Œæ²¡å…³ç³»ï¼Œä½ å…ˆæŠŠä»£ç æŠ„ä¸‹æ¥è¿è¡Œã€‚ä»Šå¤©çš„å†…å®¹è·Ÿç½‘ç»œæ— å…³ï¼Œä½ é‡ç‚¹çœ‹å¤„ç†æµç¨‹å°±è¡Œã€‚æœªæ¥ä¼šè®²åˆ°ç½‘ç»œå’Œå¼‚æ­¥å¤„ç†çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --example dummy_server --quiet</code>ã€‚ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --example client --quiet</code>ã€‚</p><p>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œåè®®å±‚çœ‹ä¸Šå»è¿ä½œè‰¯å¥½ã€‚ä¸€æ—¦éªŒè¯é€šè¿‡ï¼Œå°±ä½ å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œå› ä¸ºåè®®å±‚çš„å…¶å®ƒä»£ç éƒ½åªæ˜¯å·¥ä½œé‡è€Œå·²ï¼Œåœ¨ä¹‹åéœ€è¦çš„æ—¶å€™å¯ä»¥æ…¢æ…¢å®ç°ã€‚</p><h3>å®ç°å¹¶éªŒè¯ Storage trait</h3><p>æ¥ä¸‹æ¥æ„å»º Storage traitã€‚</p><p>æˆ‘ä»¬ä¸Šä¸€è®²è°ˆåˆ°äº†å¦‚ä½•ä½¿ç”¨åµŒå¥—çš„æ”¯æŒå¹¶å‘çš„ im-memory HashMap æ¥å®ç° storage traitã€‚ç”±äº Arc&lt;RwLock&lt;HashMap&lt;K, V&gt;&gt;&gt; è¿™æ ·çš„æ”¯æŒå¹¶å‘çš„ HashMap æ˜¯ä¸€ä¸ªåˆšéœ€ï¼ŒRust ç”Ÿæ€æœ‰å¾ˆå¤šç›¸å…³çš„ crate æ”¯æŒï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ dashmap åˆ›å»ºä¸€ä¸ª MemTable ç»“æ„ï¼Œæ¥å®ç° Storage traitã€‚</p><p>å…ˆåˆ›å»º src/storage ç›®å½•ï¼Œç„¶ååˆ›å»º src/storage/mod.rsï¼ŒæŠŠåˆšæ‰è®¨è®ºçš„ trait ä»£ç æ”¾è¿›å»åï¼Œåœ¨ src/lib.rs ä¸­å¼•å…¥ â€œmod storageâ€ã€‚æ­¤æ—¶ä¼šå‘ç°ä¸€ä¸ªé”™è¯¯ï¼šå¹¶æœªå®šä¹‰ KvErrorã€‚</p><p>æ‰€ä»¥æ¥å®šä¹‰ KvErrorã€‚<a href=\"https://time.geekbang.org/column/article/424002\">ç¬¬ 18 è®²</a>è®¨è®ºé”™è¯¯å¤„ç†æ—¶ç®€å•æ¼”ç¤ºäº†ï¼Œå¦‚ä½•ä½¿ç”¨ <a href=\"https://github.com/dtolnay/thiserror\">thiserror</a> çš„æ´¾ç”Ÿå®æ¥å®šä¹‰é”™è¯¯ç±»å‹ï¼Œä»Šå¤©å°±ç”¨å®ƒæ¥å®šä¹‰ KvErrorã€‚åˆ›å»º src/error.rsï¼Œç„¶åå¡«å…¥ï¼š</p><pre><code class=\"language-rust\">use crate::Value;\nuse thiserror::Error;\n\n#[derive(Error, Debug, PartialEq)]\npub enum KvError {\n    #[error(\"Not found for table: {0}, key: {1}\")]\n    NotFound(String, String),\n\n    #[error(\"Cannot parse command: `{0}`\")]\n    InvalidCommand(String),\n    #[error(\"Cannot convert value {:0} to {1}\")]\n    ConvertError(Value, &amp;'static str),\n    #[error(\"Cannot process command {0} with table: {1}, key: {2}. Error: {}\")]\n    StorageError(&amp;'static str, String, String, String),\n\n    #[error(\"Failed to encode protobuf message\")]\n    EncodeError(#[from] prost::EncodeError),\n    #[error(\"Failed to decode protobuf message\")]\n    DecodeError(#[from] prost::DecodeError),\n\n    #[error(\"Internal error: {0}\")]\n    Internal(String),\n}\n</code></pre><p>è¿™äº› error çš„å®šä¹‰å…¶å®æ˜¯åœ¨å®ç°è¿‡ç¨‹ä¸­é€æ­¥æ·»åŠ çš„ï¼Œä½†ä¸ºäº†è®²è§£æ–¹ä¾¿ï¼Œå…ˆä¸€æ¬¡æ€§æ·»åŠ ã€‚å¯¹äº Storage çš„å®ç°ï¼Œæˆ‘ä»¬åªå…³å¿ƒ StorageErrorï¼Œå…¶å®ƒçš„ error å®šä¹‰æœªæ¥ä¼šç”¨åˆ°ã€‚</p><p>åŒæ ·ï¼Œåœ¨ src/lib.rs ä¸‹å¼•å…¥ mod errorï¼Œç°åœ¨ src/lib.rs æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><pre><code class=\"language-rust\">mod error;\nmod pb;\nmod storage;\n\npub use error::KvError;\npub use pb::abi::*;\npub use storage::*;\n</code></pre><p>src/storage/mod.rs æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><pre><code class=\"language-rust\">use crate::{KvError, Kvpair, Value};\n\n/// å¯¹å­˜å‚¨çš„æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒæ•°æ®å­˜åœ¨å“ªå„¿ï¼Œä½†éœ€è¦å®šä¹‰å¤–ç•Œå¦‚ä½•å’Œå­˜å‚¨æ‰“äº¤é“\npub trait Storage {\n    /// ä»ä¸€ä¸ª HashTable é‡Œè·å–ä¸€ä¸ª key çš„ value\n    fn get(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;\n    /// ä»ä¸€ä¸ª HashTable é‡Œè®¾ç½®ä¸€ä¸ª key çš„ valueï¼Œè¿”å›æ—§çš„ value\n    fn set(&amp;self, table: &amp;str, key: String, value: Value) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;\n    /// æŸ¥çœ‹ HashTable ä¸­æ˜¯å¦æœ‰ key\n    fn contains(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;bool, KvError&gt;;\n    /// ä» HashTable ä¸­åˆ é™¤ä¸€ä¸ª key\n    fn del(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;\n    /// éå† HashTableï¼Œè¿”å›æ‰€æœ‰ kv pairï¼ˆè¿™ä¸ªæ¥å£ä¸å¥½ï¼‰\n    fn get_all(&amp;self, table: &amp;str) -&gt; Result&lt;Vec&lt;Kvpair&gt;, KvError&gt;;\n    /// éå† HashTableï¼Œè¿”å› kv pair çš„ Iterator\n    fn get_iter(&amp;self, table: &amp;str) -&gt; Result&lt;Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt;, KvError&gt;;\n}\n</code></pre><p>ä»£ç ç›®å‰æ²¡æœ‰ç¼–è¯‘é”™è¯¯ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶æœ«å°¾æ·»åŠ æµ‹è¯•ä»£ç ï¼Œå°è¯•ä½¿ç”¨è¿™äº›æ¥å£äº†ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ„å»º MemTableï¼Œä½†é€šè¿‡ Storage trait å·²ç»å¤§æ¦‚çŸ¥é“ MemTable æ€ä¹ˆç”¨ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå†™æ®µæµ‹è¯•ä½“éªŒä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn memtable_basic_interface_should_work() {\n        let store = MemTable::new();\n        test_basi_interface(store);\n    }\n\n    #[test]\n    fn memtable_get_all_should_work() {\n        let store = MemTable::new();\n        test_get_all(store);\n    }\n\n    fn test_basi_interface(store: impl Storage) {\n        // ç¬¬ä¸€æ¬¡ set ä¼šåˆ›å»º tableï¼Œæ’å…¥ key å¹¶è¿”å› Noneï¼ˆä¹‹å‰æ²¡å€¼ï¼‰\n        let v = store.set(\"t1\", \"hello\".into(), \"world\".into());\n        assert!(v.unwrap().is_none());\n        // å†æ¬¡ set åŒæ ·çš„ key ä¼šæ›´æ–°ï¼Œå¹¶è¿”å›ä¹‹å‰çš„å€¼\n        let v1 = store.set(\"t1\", \"hello\".into(), \"world1\".into());\n        assert_eq!(v1, Ok(Some(\"world\".into())));\n\n        // get å­˜åœ¨çš„ key ä¼šå¾—åˆ°æœ€æ–°çš„å€¼\n        let v = store.get(\"t1\", \"hello\");\n        assert_eq!(v, Ok(Some(\"world1\".into())));\n\n        // get ä¸å­˜åœ¨çš„ key æˆ–è€… table ä¼šå¾—åˆ° None\n        assert_eq!(Ok(None), store.get(\"t1\", \"hello1\"));\n        assert!(store.get(\"t2\", \"hello1\").unwrap().is_none());\n\n        // contains çº¯åœ¨çš„ key è¿”å› trueï¼Œå¦åˆ™ false\n        assert_eq!(store.contains(\"t1\", \"hello\"), Ok(true));\n        assert_eq!(store.contains(\"t1\", \"hello1\"), Ok(false));\n        assert_eq!(store.contains(\"t2\", \"hello\"), Ok(false));\n\n        // del å­˜åœ¨çš„ key è¿”å›ä¹‹å‰çš„å€¼\n        let v = store.del(\"t1\", \"hello\");\n        assert_eq!(v, Ok(Some(\"world1\".into())));\n\n        // del ä¸å­˜åœ¨çš„ key æˆ– table è¿”å› None\n        assert_eq!(Ok(None), store.del(\"t1\", \"hello1\"));\n        assert_eq!(Ok(None), store.del(\"t2\", \"hello\"));\n    }\n\n    fn test_get_all(store: impl Storage) {\n        store.set(\"t2\", \"k1\".into(), \"v1\".into()).unwrap();\n        store.set(\"t2\", \"k2\".into(), \"v2\".into()).unwrap();\n        let mut data = store.get_all(\"t2\").unwrap();\n        data.sort_by(|a, b| a.partial_cmp(b).unwrap());\n        assert_eq!(\n            data,\n            vec![\n                Kvpair::new(\"k1\", \"v1\".into()),\n                Kvpair::new(\"k2\", \"v2\".into())\n            ]\n        )\n    }\n\n\t\tfn test_get_iter(store: impl Storage) {\n        store.set(\"t2\", \"k1\".into(), \"v1\".into()).unwrap();\n        store.set(\"t2\", \"k2\".into(), \"v2\".into()).unwrap();\n        let mut data: Vec&lt;_&gt; = store.get_iter(\"t2\").unwrap().collect();\n        data.sort_by(|a, b| a.partial_cmp(b).unwrap());\n        assert_eq!(\n            data,\n            vec![\n                Kvpair::new(\"k1\", \"v1\".into()),\n                Kvpair::new(\"k2\", \"v2\".into())\n            ]\n        )\n    }\n}\n</code></pre><p>è¿™ç§åœ¨å†™å®ç°ä¹‹å‰å†™å•å…ƒæµ‹è¯•ï¼Œæ˜¯æ ‡å‡†çš„ TDDï¼ˆTest-Driven Developmentï¼‰æ–¹å¼ã€‚<br>\næˆ‘ä¸ªäººä¸æ˜¯ TDD çš„ç‹‚çƒ­ç²‰ä¸ï¼Œ<strong>ä½†ä¼šåœ¨æ„å»ºå®Œ trait åï¼Œä¸ºè¿™ä¸ª trait æ’°å†™æµ‹è¯•ä»£ç ï¼Œå› ä¸ºå†™æµ‹è¯•ä»£ç æ˜¯ä¸ªå¾ˆå¥½çš„éªŒè¯æ¥å£æ˜¯å¦å¥½ç”¨çš„æ—¶æœº</strong>ã€‚æ¯•ç«Ÿæˆ‘ä»¬ä¸å¸Œæœ›å®ç° trait ä¹‹åï¼Œæ‰å‘ç° trait çš„å®šä¹‰æœ‰ç‘•ç–µï¼Œéœ€è¦ä¿®æ”¹ï¼Œè¿™ä¸ªæ—¶å€™æ”¹åŠ¨çš„ä»£ä»·å°±æ¯”è¾ƒå¤§äº†ã€‚</p><p>æ‰€ä»¥ï¼Œå½“ trait æ¨æ•²å®Œæ¯•ï¼Œå°±å¯ä»¥å¼€å§‹å†™ä½¿ç”¨ trait çš„æµ‹è¯•ä»£ç äº†ã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä»”ç»†æ„Ÿå—ï¼Œå¦‚æœå†™æµ‹è¯•ç”¨ä¾‹æ—¶ç”¨å¾—ä¸èˆ’æœï¼Œæˆ–è€…ä¸ºäº†ä½¿ç”¨å®ƒéœ€è¦åšå¾ˆå¤šç¹ççš„æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥é‡æ–°å®¡è§† trait çš„è®¾è®¡ã€‚</p><p>ä½ å¦‚æœä»”ç»†çœ‹å•å…ƒæµ‹è¯•çš„ä»£ç ï¼Œå°±ä¼šå‘ç°æˆ‘å§‹ç»ˆç§‰æŒ<strong>æµ‹è¯• trait æ¥å£çš„æ€æƒ³</strong>ã€‚å°½ç®¡åœ¨æµ‹è¯•ä¸­éœ€è¦ä¸€ä¸ªå®é™…çš„æ•°æ®ç»“æ„è¿›è¡Œ trait æ–¹æ³•çš„æµ‹è¯•ï¼Œä½†æ ¸å¿ƒçš„æµ‹è¯•ä»£ç éƒ½ç”¨çš„æ³›å‹å‡½æ•°ï¼Œè®©è¿™äº›ä»£ç åªè·Ÿ trait ç›¸å…³ã€‚</p><p>è¿™æ ·ï¼Œä¸€æ¥å¯ä»¥é¿å…æŸä¸ªå…·ä½“ trait å®ç°çš„å¹²æ‰°ï¼ŒäºŒæ¥åœ¨ä¹‹åæƒ³åŠ å…¥æ›´å¤š trait å®ç°æ—¶ï¼Œå¯ä»¥å…±äº«æµ‹è¯•ä»£ç ã€‚æ¯”å¦‚æœªæ¥æƒ³æ”¯æŒ DiskTableï¼Œé‚£ä¹ˆåªæ¶ˆåŠ å‡ ä¸ªæµ‹è¯•ä¾‹ï¼Œè°ƒç”¨å·²æœ‰çš„æ³›å‹å‡½æ•°å³å¯ã€‚</p><p>å¥½ï¼Œæå®šæµ‹è¯•ï¼Œç¡®è®¤traitè®¾è®¡æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬æ¥å†™å…·ä½“å®ç°ã€‚å¯ä»¥åˆ›å»º src/storage/memory.rs æ¥æ„å»º MemTableï¼š</p><pre><code class=\"language-rust\">use crate::{KvError, Kvpair, Storage, Value};\nuse dashmap::{mapref::one::Ref, DashMap};\n\n/// ä½¿ç”¨ DashMap æ„å»ºçš„ MemTableï¼Œå®ç°äº† Storage trait\n#[derive(Clone, Debug, Default)]\npub struct MemTable {\n    tables: DashMap&lt;String, DashMap&lt;String, Value&gt;&gt;,\n}\n\nimpl MemTable {\n    /// åˆ›å»ºä¸€ä¸ªç¼ºçœçš„ MemTable\n    pub fn new() -&gt; Self {\n        Self::default()\n    }\n\n    /// å¦‚æœåä¸º name çš„ hash table ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºï¼Œå¦åˆ™è¿”å›\n    fn get_or_create_table(&amp;self, name: &amp;str) -&gt; Ref&lt;String, DashMap&lt;String, Value&gt;&gt; {\n        match self.tables.get(name) {\n            Some(table) =&gt; table,\n            None =&gt; {\n                let entry = self.tables.entry(name.into()).or_default();\n                entry.downgrade()\n            }\n        }\n    }\n}\n\nimpl Storage for MemTable {\n    fn get(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt; {\n        let table = self.get_or_create_table(table);\n        Ok(table.get(key).map(|v| v.value().clone()))\n    }\n\n    fn set(&amp;self, table: &amp;str, key: String, value: Value) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt; {\n        let table = self.get_or_create_table(table);\n        Ok(table.insert(key, value))\n    }\n\n    fn contains(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;bool, KvError&gt; {\n        let table = self.get_or_create_table(table);\n        Ok(table.contains_key(key))\n    }\n\n    fn del(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt; {\n        let table = self.get_or_create_table(table);\n        Ok(table.remove(key).map(|(_k, v)| v))\n    }\n\n    fn get_all(&amp;self, table: &amp;str) -&gt; Result&lt;Vec&lt;Kvpair&gt;, KvError&gt; {\n        let table = self.get_or_create_table(table);\n        Ok(table\n            .iter()\n            .map(|v| Kvpair::new(v.key(), v.value().clone()))\n            .collect())\n    }\n\n\t\tfn get_iter(&amp;self, _table: &amp;str) -&gt; Result&lt;Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt;, KvError&gt; {\n        todo!()\n    }\n}\n</code></pre><p>é™¤äº† get_iter() å¤–ï¼Œè¿™ä¸ªå®ç°ä»£ç éå¸¸ç®€å•ï¼Œç›¸ä¿¡ä½ çœ‹ä¸€ä¸‹ dashmap çš„æ–‡æ¡£ï¼Œä¹Ÿèƒ½å¾ˆå¿«å†™å‡ºæ¥ã€‚get_iter() å†™èµ·æ¥ç¨å¾®æœ‰äº›éš¾åº¦ï¼Œæˆ‘ä»¬å…ˆæ”¾ä¸‹ä¸è¡¨ï¼Œä¼šåœ¨ä¸‹ä¸€ç¯‡ KV server è®²ã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œæƒ³æŒ‘æˆ˜ä¸€ä¸‹ï¼Œæ¬¢è¿å°è¯•ã€‚</p><p>å®ç°å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•å®ƒæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚æ³¨æ„ç°åœ¨ src/storage/memory.rs è¿˜æ²¡æœ‰è¢«æ·»åŠ ï¼Œæ‰€ä»¥ cargo å¹¶ä¸ä¼šç¼–è¯‘å®ƒã€‚è¦åœ¨ src/storage/mod.rs å¼€å¤´æ·»åŠ ä»£ç ï¼š</p><pre><code class=\"language-rust\">mod memory;\npub use memory::MemTable;\n</code></pre><p>è¿™æ ·ä»£ç å°±å¯ä»¥ç¼–è¯‘é€šè¿‡äº†ã€‚å› ä¸ºè¿˜æ²¡æœ‰å®ç° get_iter æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªæµ‹è¯•éœ€è¦è¢«æ³¨é‡Šæ‰ï¼š</p><pre><code class=\"language-rust\">// #[test]\n// fn memtable_iter_should_work() {\n//     let store = MemTable::new();\n//     test_get_iter(store);\n// }\n</code></pre><p>å¦‚æœä½ è¿è¡Œ <code>cargo test</code> ï¼Œå¯ä»¥çœ‹åˆ°æµ‹è¯•éƒ½é€šè¿‡äº†ï¼š</p><pre><code class=\"language-bash\">&gt; cargo test\n   Compiling kv v0.1.0 (/Users/tchen/projects/mycode/rust/geek-time-rust-resources/21/kv)\n    Finished test [unoptimized + debuginfo] target(s) in 1.95s\n     Running unittests (/Users/tchen/.target/debug/deps/kv-8d746b0f387a5271)\n\nrunning 2 tests\ntest storage::tests::memtable_basic_interface_should_work ... ok\ntest storage::tests::memtable_get_all_should_work ... ok\n\ntest result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\n   Doc-tests kv\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n</code></pre><h3>å®ç°å¹¶éªŒè¯ CommandService trait</h3><p>Storage trait æˆ‘ä»¬å°±ç®—åŸºæœ¬éªŒè¯é€šè¿‡äº†ï¼Œç°åœ¨å†æ¥éªŒè¯ CommandServiceã€‚</p><p>æˆ‘ä»¬åˆ›å»º src/service ç›®å½•ï¼Œä»¥åŠ src/service/mod.rs å’Œ src/service/command_service.rs æ–‡ä»¶ï¼Œå¹¶åœ¨ src/service/mod.rs å†™å…¥ï¼š</p><pre><code class=\"language-rust\">use crate::*;\n\nmod command_service;\n\n/// å¯¹ Command çš„å¤„ç†çš„æŠ½è±¡\npub trait CommandService {\n    /// å¤„ç† Commandï¼Œè¿”å› Response\n    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse;\n}\n</code></pre><p>ä¸è¦å¿˜è®°åœ¨ src/lib.rs ä¸­åŠ å…¥ serviceï¼š</p><pre><code class=\"language-rust\">mod error;\nmod pb;\nmod service;\nmod storage;\n\npub use error::KvError;\npub use pb::abi::*;\npub use service::*;\npub use storage::*;\n</code></pre><p>ç„¶åï¼Œåœ¨ src/service/command_service.rs ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™ä¸€äº›æµ‹è¯•ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œå°±åˆ— HSETã€HGETã€HGETALL ä¸‰ä¸ªå‘½ä»¤ï¼š</p><pre><code class=\"language-rust\">use crate::*;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::command_request::RequestData;\n\n    #[test]\n    fn hset_should_work() {\n        let store = MemTable::new();\n        let cmd = CommandRequest::new_hset(\"t1\", \"hello\", \"world\".into());\n        let res = dispatch(cmd.clone(), &amp;store);\n        assert_res_ok(res, &amp;[Value::default()], &amp;[]);\n\n        let res = dispatch(cmd, &amp;store);\n        assert_res_ok(res, &amp;[\"world\".into()], &amp;[]);\n    }\n\n    #[test]\n    fn hget_should_work() {\n        let store = MemTable::new();\n        let cmd = CommandRequest::new_hset(\"score\", \"u1\", 10.into());\n        dispatch(cmd, &amp;store);\n        let cmd = CommandRequest::new_hget(\"score\", \"u1\");\n        let res = dispatch(cmd, &amp;store);\n        assert_res_ok(res, &amp;[10.into()], &amp;[]);\n    }\n\n    #[test]\n    fn hget_with_non_exist_key_should_return_404() {\n        let store = MemTable::new();\n        let cmd = CommandRequest::new_hget(\"score\", \"u1\");\n        let res = dispatch(cmd, &amp;store);\n        assert_res_error(res, 404, \"Not found\");\n    }\n\n    #[test]\n    fn hgetall_should_work() {\n        let store = MemTable::new();\n        let cmds = vec![\n            CommandRequest::new_hset(\"score\", \"u1\", 10.into()),\n            CommandRequest::new_hset(\"score\", \"u2\", 8.into()),\n            CommandRequest::new_hset(\"score\", \"u3\", 11.into()),\n            CommandRequest::new_hset(\"score\", \"u1\", 6.into()),\n        ];\n        for cmd in cmds {\n            dispatch(cmd, &amp;store);\n        }\n\n        let cmd = CommandRequest::new_hgetall(\"score\");\n        let res = dispatch(cmd, &amp;store);\n        let pairs = &amp;[\n            Kvpair::new(\"u1\", 6.into()),\n            Kvpair::new(\"u2\", 8.into()),\n            Kvpair::new(\"u3\", 11.into()),\n        ];\n        assert_res_ok(res, &amp;[], pairs);\n    }\n\n    // ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç† HGET/HGETALL/HSET\n    fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse {\n        match cmd.request_data.unwrap() {\n            RequestData::Hget(v) =&gt; v.execute(store),\n            RequestData::Hgetall(v) =&gt; v.execute(store),\n            RequestData::Hset(v) =&gt; v.execute(store),\n            _ =&gt; todo!(),\n        }\n    }\n\n    // æµ‹è¯•æˆåŠŸè¿”å›çš„ç»“æœ\n    fn assert_res_ok(mut res: CommandResponse, values: &amp;[Value], pairs: &amp;[Kvpair]) {\n        res.pairs.sort_by(|a, b| a.partial_cmp(b).unwrap());\n        assert_eq!(res.status, 200);\n        assert_eq!(res.message, \"\");\n        assert_eq!(res.values, values);\n        assert_eq!(res.pairs, pairs);\n    }\n\n    // æµ‹è¯•å¤±è´¥è¿”å›çš„ç»“æœ\n    fn assert_res_error(res: CommandResponse, code: u32, msg: &amp;str) {\n        assert_eq!(res.status, code);\n        assert!(res.message.contains(msg));\n        assert_eq!(res.values, &amp;[]);\n        assert_eq!(res.pairs, &amp;[]);\n    }\n}\n</code></pre><p>è¿™äº›æµ‹è¯•çš„ä½œç”¨å°±æ˜¯éªŒè¯äº§å“éœ€æ±‚ï¼Œæ¯”å¦‚ï¼š</p><ul>\n<li>HSET æˆåŠŸè¿”å›ä¸Šä¸€æ¬¡çš„å€¼ï¼ˆè¿™å’Œ Redis ç•¥æœ‰ä¸åŒï¼ŒRedis è¿”å›è¡¨ç¤ºå¤šå°‘ key å—å½±å“çš„ä¸€ä¸ªæ•´æ•°ï¼‰</li>\n<li>HGET è¿”å› Value</li>\n<li>HGETALL è¿”å›ä¸€ç»„æ— åºçš„ Kvpair</li>\n</ul><p>ç›®å‰è¿™äº›æµ‹è¯•æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå› ä¸ºé‡Œé¢ä½¿ç”¨äº†ä¸€äº›æœªå®šä¹‰çš„æ–¹æ³•ï¼Œæ¯”å¦‚ 10.into()ï¼šæƒ³æŠŠæ•´æ•° 10 è½¬æ¢æˆä¸€ä¸ª Valueã€CommandRequest::new_hgetall(â€œscoreâ€)ï¼šæƒ³ç”Ÿæˆä¸€ä¸ª HGETALL å‘½ä»¤ã€‚</p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Ÿå› ä¸ºå¦‚æœæ˜¯ CommandService æ¥å£çš„ä½¿ç”¨è€…ï¼Œè‡ªç„¶å¸Œæœ›ä½¿ç”¨è¿™ä¸ªæ¥å£çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ•´ä½“æ„Ÿè§‰éå¸¸ç®€å•æ˜äº†ã€‚</p><p>å¦‚æœæ¥å£æœŸå¾…ä¸€ä¸ª Valueï¼Œä½†åœ¨ä¸Šä¸‹æ–‡ä¸­æ‹¿åˆ°çš„æ˜¯ 10ã€â€œhelloâ€ è¿™æ ·çš„å€¼ï¼Œé‚£æˆ‘ä»¬ä½œä¸ºè®¾è®¡è€…å°±è¦è€ƒè™‘ä¸º Value å®ç° From&lt;T&gt;ï¼Œè¿™æ ·è°ƒç”¨çš„æ—¶å€™æœ€æ–¹ä¾¿ã€‚åŒæ ·çš„ï¼Œå¯¹äºç”Ÿæˆ CommandRequest è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥æ·»åŠ ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œæ¥è®©è°ƒç”¨æ›´æ¸…æ™°ã€‚</p><p>åˆ°ç°åœ¨ä¸ºæ­¢æˆ‘ä»¬å†™äº†ä¸¤è½®æµ‹è¯•äº†ï¼Œç›¸ä¿¡ä½ å¯¹æµ‹è¯•ä»£ç çš„ä½œç”¨æœ‰å¤§æ¦‚ç†è§£ã€‚æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š</p><ol>\n<li>éªŒè¯å¹¶å¸®åŠ©æ¥å£è¿­ä»£</li>\n<li>éªŒè¯äº§å“éœ€æ±‚</li>\n<li>é€šè¿‡ä½¿ç”¨æ ¸å¿ƒé€»è¾‘ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°æ€è€ƒå¤–å›´é€»è¾‘å¹¶åæ¨å…¶å®ç°</li>\n</ol><p>å‰ä¸¤ç‚¹æ˜¯æœ€åŸºæœ¬çš„ï¼Œä¹Ÿæ˜¯å¾ˆå¤šäººå¯¹TDDçš„ç†è§£ï¼Œå…¶å®è¿˜æœ‰æ›´é‡è¦çš„ä¹Ÿå°±æ˜¯ç¬¬ä¸‰ç‚¹ã€‚é™¤äº†å‰é¢çš„è¾…åŠ©å‡½æ•°å¤–ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•ä»£ç ä¸­è¿˜çœ‹åˆ°äº† dispatch å‡½æ•°ï¼Œå®ƒç›®å‰ç”¨æ¥è¾…åŠ©æµ‹è¯•ã€‚<strong>ä½†ç´§æ¥ç€ä½ ä¼šå‘ç°ï¼Œè¿™æ ·çš„è¾…åŠ©å‡½æ•°ï¼Œå¯ä»¥åˆå¹¶åˆ°æ ¸å¿ƒä»£ç ä¸­ã€‚è¿™æ‰æ˜¯â€œæµ‹è¯•é©±åŠ¨å¼€å‘â€çš„å®è´¨</strong>ã€‚</p><p>å¥½ï¼Œæ ¹æ®æµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ src/pb/mod.rs ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘ï¼Œé¦–å…ˆæ˜¯ CommandRequest çš„ä¸€äº›æ–¹æ³•ï¼Œä¹‹å‰å†™äº† new_hsetï¼Œç°åœ¨å†åŠ å…¥ new_hget å’Œ new_hgetallï¼š</p><pre><code class=\"language-rust\">impl CommandRequest {\n    /// åˆ›å»º HGET å‘½ä»¤\n    pub fn new_hget(table: impl Into&lt;String&gt;, key: impl Into&lt;String&gt;) -&gt; Self {\n        Self {\n            request_data: Some(RequestData::Hget(Hget {\n                table: table.into(),\n                key: key.into(),\n            })),\n        }\n    }\n\n    /// åˆ›å»º HGETALL å‘½ä»¤\n    pub fn new_hgetall(table: impl Into&lt;String&gt;) -&gt; Self {\n        Self {\n            request_data: Some(RequestData::Hgetall(Hgetall {\n                table: table.into(),\n            })),\n        }\n    }\n\n    /// åˆ›å»º HSET å‘½ä»¤\n    pub fn new_hset(table: impl Into&lt;String&gt;, key: impl Into&lt;String&gt;, value: Value) -&gt; Self {\n        Self {\n            request_data: Some(RequestData::Hset(Hset {\n                table: table.into(),\n                pair: Some(Kvpair::new(key, value)),\n            })),\n        }\n    }\n}\n</code></pre><p>ç„¶åå†™å¯¹ Value çš„ From&lt;i64&gt; çš„å®ç°ï¼š</p><pre><code class=\"language-rust\">/// ä» i64è½¬æ¢æˆ Value\nimpl From&lt;i64&gt; for Value {\n    fn from(i: i64) -&gt; Self {\n        Self {\n            value: Some(value::Value::Integer(i)),\n        }\n    }\n}\n</code></pre><p>æµ‹è¯•ä»£ç ç›®å‰å°±å¯ä»¥ç¼–è¯‘é€šè¿‡äº†ï¼Œç„¶è€Œæµ‹è¯•æ˜¾ç„¶ä¼šå¤±è´¥ï¼Œå› ä¸ºè¿˜æ²¡æœ‰åšå…·ä½“çš„å®ç°ã€‚æˆ‘ä»¬åœ¨ src/service/command_service.rs ä¸‹æ·»åŠ  trait çš„å®ç°ä»£ç ï¼š</p><pre><code class=\"language-rust\">impl CommandService for Hget {\n    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {\n        match store.get(&amp;self.table, &amp;self.key) {\n            Ok(Some(v)) =&gt; v.into(),\n            Ok(None) =&gt; KvError::NotFound(self.table, self.key).into(),\n            Err(e) =&gt; e.into(),\n        }\n    }\n}\n\nimpl CommandService for Hgetall {\n    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {\n        match store.get_all(&amp;self.table) {\n            Ok(v) =&gt; v.into(),\n            Err(e) =&gt; e.into(),\n        }\n    }\n}\n\nimpl CommandService for Hset {\n    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {\n        match self.pair {\n            Some(v) =&gt; match store.set(&amp;self.table, v.key, v.value.unwrap_or_default()) {\n                Ok(Some(v)) =&gt; v.into(),\n                Ok(None) =&gt; Value::default().into(),\n                Err(e) =&gt; e.into(),\n            },\n            None =&gt; Value::default().into(),\n        }\n    }\n}\n</code></pre><p>è¿™è‡ªç„¶ä¼šå¼•å‘æ›´å¤šçš„ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ç”¨äº† into() æ–¹æ³•ï¼Œå´æ²¡æœ‰å®ç°ç›¸åº”çš„è½¬æ¢ï¼Œæ¯”å¦‚ï¼ŒValue åˆ° CommandResponse çš„è½¬æ¢ã€KvError åˆ° CommandResponse çš„è½¬æ¢ã€Vec&lt;Kvpair&gt; åˆ° CommandResponse çš„è½¬æ¢ç­‰ç­‰ã€‚</p><p>æ‰€ä»¥åœ¨ src/pb/mod.rs é‡Œç»§ç»­è¡¥ä¸Šç›¸åº”çš„å¤–å›´é€»è¾‘ï¼š</p><pre><code class=\"language-rust\">/// ä» Value è½¬æ¢æˆ CommandResponse\nimpl From&lt;Value&gt; for CommandResponse {\n    fn from(v: Value) -&gt; Self {\n        Self {\n            status: StatusCode::OK.as_u16() as _,\n            values: vec![v],\n            ..Default::default()\n        }\n    }\n}\n\n/// ä» Vec&lt;Kvpair&gt; è½¬æ¢æˆ CommandResponse\nimpl From&lt;Vec&lt;Kvpair&gt;&gt; for CommandResponse {\n    fn from(v: Vec&lt;Kvpair&gt;) -&gt; Self {\n        Self {\n            status: StatusCode::OK.as_u16() as _,\n            pairs: v,\n            ..Default::default()\n        }\n    }\n}\n\n/// ä» KvError è½¬æ¢æˆ CommandResponse\nimpl From&lt;KvError&gt; for CommandResponse {\n    fn from(e: KvError) -&gt; Self {\n        let mut result = Self {\n            status: StatusCode::INTERNAL_SERVER_ERROR.as_u16() as _,\n            message: e.to_string(),\n            values: vec![],\n            pairs: vec![],\n        };\n\n        match e {\n            KvError::NotFound(_, _) =&gt; result.status = StatusCode::NOT_FOUND.as_u16() as _,\n            KvError::InvalidCommand(_) =&gt; result.status = StatusCode::BAD_REQUEST.as_u16() as _,\n            _ =&gt; {}\n        }\n\n        result\n    }\n}\n</code></pre><p>ä»å‰é¢å†™æ¥å£åˆ°è¿™é‡Œå…·ä½“å®ç°ï¼Œä¸çŸ¥é“ä½ æ˜¯å¦æ„Ÿå—åˆ°äº†è¿™æ ·ä¸€ç§æ¨¡å¼ï¼šåœ¨ Rust ä¸‹ï¼Œ<strong>ä½†å‡¡å‡ºç°ä¸¤ä¸ªæ•°æ®ç»“æ„ v1 åˆ° v2 çš„è½¬æ¢ï¼Œä½ éƒ½å¯ä»¥å…ˆä»¥ v1.into() æ¥è¡¨ç¤ºè¿™ä¸ªé€»è¾‘ï¼Œç»§ç»­å¾€ä¸‹å†™ä»£ç ï¼Œä¹‹åå†å»è¡¥ From&lt;T&gt; çš„å®ç°</strong>ã€‚å¦‚æœ v1 å’Œ v2 éƒ½ä¸æ˜¯ä½ å®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆä½ éœ€è¦æŠŠå…¶ä¸­ä¹‹ä¸€ç”¨ struct åŒ…è£…ä¸€ä¸‹ï¼Œæ¥ç»•è¿‡ï¼ˆ<a href=\"https://time.geekbang.org/column/article/421324\">ç¬¬ </a><a href=\"https://time.geekbang.org/column/article/421324\">14 è®²</a>ï¼‰ä¹‹å‰æåˆ°çš„å­¤å„¿è§„åˆ™ã€‚<br>\nä½ å­¦å®Œè¿™èŠ‚è¯¾å¯ä»¥å†å»å›é¡¾ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/414478\">ç¬¬ 6 è®²</a>ï¼Œä»”ç»†æ€è€ƒä¸€ä¸‹å½“æ—¶è¯´çš„â€œç»å¤§å¤šæ•°å¤„ç†é€»è¾‘éƒ½æ˜¯æŠŠæ•°æ®ä»ä¸€ä¸ªæ¥å£è½¬æ¢æˆå¦ä¸€ä¸ªæ¥å£â€ã€‚</p><p>ç°åœ¨ä»£ç åº”è¯¥å¯ä»¥ç¼–è¯‘é€šè¿‡å¹¶æµ‹è¯•é€šè¿‡äº†ï¼Œä½ å¯ä»¥ <code>cargo test</code> æµ‹è¯•ä¸€ä¸‹ã€‚</p><h3>æœ€åçš„æ‹¼å›¾ï¼šService ç»“æ„çš„å®ç°</h3><p>å¥½ï¼Œæ‰€æœ‰çš„æ¥å£ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯/æœåŠ¡å™¨çš„åè®®æ¥å£ã€Storage trait å’Œ CommandService trait éƒ½éªŒè¯å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è€ƒè™‘å¦‚ä½•ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„æŠŠæ‰€æœ‰è¿™äº›ä¸œè¥¿ä¸²è”èµ·æ¥ã€‚</p><p>ä¾æ—§ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹å¦‚ä½•è°ƒç”¨å®ƒã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨ src/service/mod.rs é‡Œæ·»åŠ å¦‚ä¸‹çš„æµ‹è¯•ä»£ç ï¼š</p><pre><code class=\"language-rust\">#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::{MemTable, Value};\n\n\t\t#[test]\n    fn service_should_works() {\n        // æˆ‘ä»¬éœ€è¦ä¸€ä¸ª service ç»“æ„è‡³å°‘åŒ…å« Storage\n        let service = Service::new(MemTable::default());\n\n        // service å¯ä»¥è¿è¡Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå®ƒçš„ clone åº”è¯¥æ˜¯è½»é‡çº§çš„\n        let cloned = service.clone();\n\n        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨ table t1 ä¸­å†™å…¥ k1, v1\n        let handle = thread::spawn(move || {\n            let res = cloned.execute(CommandRequest::new_hset(\"t1\", \"k1\", \"v1\".into()));\n            assert_res_ok(res, &amp;[Value::default()], &amp;[]);\n        });\n        handle.join().unwrap();\n\n        // åœ¨å½“å‰çº¿ç¨‹ä¸‹è¯»å– table t1 çš„ k1ï¼Œåº”è¯¥è¿”å› v1\n        let res = service.execute(CommandRequest::new_hget(\"t1\", \"k1\"));\n        assert_res_ok(res, &amp;[\"v1\".into()], &amp;[]);\n    }\n}\n\n#[cfg(test)]\nuse crate::{Kvpair, Value};\n\n// æµ‹è¯•æˆåŠŸè¿”å›çš„ç»“æœ\n#[cfg(test)]\npub fn assert_res_ok(mut res: CommandResponse, values: &amp;[Value], pairs: &amp;[Kvpair]) {\n    res.pairs.sort_by(|a, b| a.partial_cmp(b).unwrap());\n    assert_eq!(res.status, 200);\n    assert_eq!(res.message, \"\");\n    assert_eq!(res.values, values);\n    assert_eq!(res.pairs, pairs);\n}\n\n// æµ‹è¯•å¤±è´¥è¿”å›çš„ç»“æœ\n#[cfg(test)]\npub fn assert_res_error(res: CommandResponse, code: u32, msg: &amp;str) {\n    assert_eq!(res.status, code);\n    assert!(res.message.contains(msg));\n    assert_eq!(res.values, &amp;[]);\n    assert_eq!(res.pairs, &amp;[]);\n}\n</code></pre><p>æ³¨æ„ï¼Œè¿™é‡Œçš„ assert_res_ok() å’Œ assert_res_error() æ˜¯ä» src/service/command_service.rs ä¸­æŒªè¿‡æ¥çš„ã€‚<strong>åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä¸å…‰äº§å“ä»£ç éœ€è¦ä¸æ–­é‡æ„ï¼Œæµ‹è¯•ä»£ç ä¹Ÿéœ€è¦é‡æ„æ¥è´¯å½» DRY æ€æƒ³</strong>ã€‚</p><p>æˆ‘è§è¿‡å¾ˆå¤šç”Ÿäº§ç¯å¢ƒçš„ä»£ç ï¼Œäº§å“åŠŸèƒ½éƒ¨åˆ†è¿˜è¯´å¾—è¿‡å»ï¼Œä½†æµ‹è¯•ä»£ç åƒæ˜¯ä¸ªç²ªå‘ï¼Œç»å¹´ç´¯æœˆåœ° copy/paste ä½¿å…¶è‡­æ°”ç†å¤©ï¼Œæ¯ä¸ªå¼€å‘è€…åœ¨æ·»åŠ æ–°åŠŸèƒ½çš„æ—¶å€™ï¼Œéƒ½æ©ç€é¼»å­å¾€é‡Œæ‰”ä¸€å¨èµ°äººï¼Œä½¿å¾—ç»´æŠ¤éš¾åº¦è¶Šæ¥è¶Šé«˜ï¼Œæ¯æ¬¡éœ€æ±‚å˜åŠ¨ï¼Œéƒ½æ¶‰åŠä¸€å¤§å¨æµ‹è¯•ä»£ç çš„å˜åŠ¨ï¼Œè¿™æ ·éå¸¸ä¸å¥½ã€‚</p><p>æµ‹è¯•ä»£ç çš„è´¨é‡ä¹Ÿè¦å’Œäº§å“ä»£ç çš„è´¨é‡åŒç­‰è¦æ±‚ã€‚å¥½çš„å¼€å‘è€…å†™çš„æµ‹è¯•ä»£ç çš„å¯è¯»æ€§ä¹Ÿæ˜¯éå¸¸å¼ºçš„ã€‚ä½ å¯ä»¥å¯¹æ¯”ä¸Šé¢å†™çš„ä¸‰æ®µæµ‹è¯•ä»£ç å¤šå¤šæ„Ÿå—ã€‚</p><p>åœ¨æ’°å†™æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦ç‰¹åˆ«æ³¨æ„ï¼š<strong>æµ‹è¯•ä»£ç è¦å›´ç»•ç€ç³»ç»Ÿç¨³å®šçš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ¥å£ï¼Œæ¥æµ‹è¯•ï¼Œè€Œå°½å¯èƒ½å°‘åœ°æµ‹è¯•å®ç°</strong>ã€‚è¿™æ˜¯æˆ‘å¯¹è¿™ä¹ˆå¤šå¹´å·¥ä½œä¸­è¡€æ·‹æ·‹çš„æ•™è®­çš„æ·±åˆ»æ€»ç»“ã€‚</p><p>å› ä¸ºäº§å“ä»£ç å’Œæµ‹è¯•ä»£ç ï¼Œä¸¤è€…æ€»éœ€è¦ä¸€ä¸ªæ˜¯ç›¸å¯¹ç¨³å®šçš„ï¼Œæ—¢ç„¶äº§å“ä»£ç ä¼šä¸æ–­åœ°æ ¹æ®éœ€æ±‚å˜åŠ¨ï¼Œæµ‹è¯•ä»£ç å°±å¿…ç„¶éœ€è¦ç¨³å®šä¸€äº›ã€‚</p><p>é‚£ä»€ä¹ˆæ ·çš„æµ‹è¯•ä»£ç æ˜¯ç¨³å®šçš„ï¼Ÿæµ‹è¯•æ¥å£çš„ä»£ç æ˜¯ç¨³å®šçš„ã€‚åªè¦æ¥å£ä¸å˜ï¼Œæ— è®ºå…·ä½“å®ç°å¦‚ä½•å˜åŒ–ï¼Œå“ªæ€•ä»Šå¤©å¼•å…¥ä¸€ä¸ªæ–°çš„ç®—æ³•ï¼Œæ˜å¤©é‡å†™å®ç°ï¼Œæµ‹è¯•ä»£ç ä¾æ—§èƒ½å¤Ÿå‡›ç„¶ä¸åŠ¨ï¼Œåšå¥½äº§å“è´¨é‡çš„çœ‹é—¨ç‹—ã€‚</p><p>å¥½ï¼Œæˆ‘ä»¬å›æ¥å†™ä»£ç ã€‚åœ¨è¿™æ®µæµ‹è¯•ä¸­ï¼Œå·²ç»æ•²å®šäº† Service è¿™ä¸ªæ•°æ®ç»“æ„çš„ä½¿ç”¨è“å›¾ï¼Œå®ƒå¯ä»¥è·¨çº¿ç¨‹ï¼Œå¯ä»¥è°ƒç”¨ execute æ¥æ‰§è¡ŒæŸä¸ª CommandRequest å‘½ä»¤ï¼Œè¿”å› CommandResponseã€‚</p><p>æ ¹æ®è¿™äº›æƒ³æ³•ï¼Œåœ¨ src/service/mod.rs é‡Œæ·»åŠ  Service çš„å£°æ˜å’Œå®ç°ï¼š</p><pre><code class=\"language-rust\">/// Service æ•°æ®ç»“æ„\npub struct Service&lt;Store = MemTable&gt; {\n    inner: Arc&lt;ServiceInner&lt;Store&gt;&gt;,\n}\n\nimpl&lt;Store&gt; Clone for Service&lt;Store&gt; {\n    fn clone(&amp;self) -&gt; Self {\n        Self {\n\t\t\tinner: Arc::clone(&amp;self.inner),\n        }\n    }\n}\n\n/// Service å†…éƒ¨æ•°æ®ç»“æ„\npub struct ServiceInner&lt;Store&gt; {\n    store: Store,\n}\n\nimpl&lt;Store: Storage&gt; Service&lt;Store&gt; {\n    pub fn new(store: Store) -&gt; Self {\n        Self {\n            inner: Arc::new(ServiceInner { store }),\n        }\n    }\n\n    pub fn execute(&amp;self, cmd: CommandRequest) -&gt; CommandResponse {\n        debug!(\"Got request: {:?}\", cmd);\n        // TODO: å‘é€ on_received äº‹ä»¶\n        let res = dispatch(cmd, &amp;self.inner.store);\n        debug!(\"Executed response: {:?}\", res);\n        // TODO: å‘é€ on_executed äº‹ä»¶\n\n        res\n    }\n}\n\n// ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç† HGET/HGETALL/HSET\npub fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse {\n    match cmd.request_data {\n        Some(RequestData::Hget(param)) =&gt; param.execute(store),\n        Some(RequestData::Hgetall(param)) =&gt; param.execute(store),\n        Some(RequestData::Hset(param)) =&gt; param.execute(store),\n        None =&gt; KvError::InvalidCommand(\"Request has no data\".into()).into(),\n        _ =&gt; KvError::Internal(\"Not implemented\".into()).into(),\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç æœ‰å‡ ä¸ªåœ°æ–¹å€¼å¾—æ³¨æ„ï¼š</p><ol>\n<li>é¦–å…ˆ Service ç»“æ„å†…éƒ¨æœ‰ä¸€ä¸ª ServiceInner å­˜æ”¾å®é™…çš„æ•°æ®ç»“æ„ï¼ŒService åªæ˜¯ç”¨ Arc åŒ…è£¹äº† ServiceInnerã€‚è¿™ä¹Ÿæ˜¯ Rust çš„ä¸€ä¸ªæƒ¯ä¾‹ï¼ŒæŠŠéœ€è¦åœ¨å¤šçº¿ç¨‹ä¸‹ clone çš„ä¸»ä½“å’Œå…¶å†…éƒ¨ç»“æ„åˆ†å¼€ï¼Œè¿™æ ·ä»£ç é€»è¾‘æ›´åŠ æ¸…æ™°ã€‚</li>\n<li>execute() æ–¹æ³•ç›®å‰å°±æ˜¯è°ƒç”¨äº† dispatchï¼Œä½†å®ƒæœªæ¥æ½œåœ¨å¯ä»¥åšä¸€äº›äº‹ä»¶åˆ†å‘ã€‚è¿™æ ·å¤„ç†ä½“ç°äº† SRPï¼ˆSingle Responsibility Principleï¼‰åŸåˆ™ã€‚</li>\n<li>dispatch å…¶å®å°±æ˜¯æŠŠæµ‹è¯•ä»£ç çš„ dispatch é€»è¾‘ç§»åŠ¨è¿‡æ¥æ”¹åŠ¨äº†ä¸€ä¸‹ã€‚</li>\n</ol><p>å†ä¸€æ¬¡ï¼Œæˆ‘ä»¬é‡æ„äº†æµ‹è¯•ä»£ç ï¼ŒæŠŠå®ƒçš„è¾…åŠ©å‡½æ•°å˜æˆäº†äº§å“ä»£ç çš„ä¸€éƒ¨åˆ†ã€‚ç°åœ¨ï¼Œä½ å¯ä»¥è¿è¡Œ <code>cargo test</code> æµ‹è¯•ä¸€ä¸‹ï¼Œå¦‚æœä»£ç æ— æ³•ç¼–è¯‘ï¼Œå¯èƒ½æ˜¯ç¼ºä¸€äº› use ä»£ç ï¼Œæ¯”å¦‚ï¼š</p><pre><code class=\"language-rust\">use crate::{\n    command_request::RequestData, CommandRequest, CommandResponse, KvError, MemTable, Storage,\n};\nuse std::sync::Arc;\nuse tracing::debug;\n</code></pre><h3>æ–°çš„ server</h3><p>ç°åœ¨å¤„ç†é€»è¾‘å·²ç»éƒ½å®Œæˆäº†ï¼Œå¯ä»¥å†™ä¸ªæ–°çš„ example æµ‹è¯•æœåŠ¡å™¨ä»£ç ã€‚</p><p>æŠŠä¹‹å‰çš„ examples/dummy_server.rs å¤åˆ¶ä¸€ä»½ï¼Œæˆä¸º examples/server.rsï¼Œç„¶åå¼•å…¥ Serviceï¼Œä¸»è¦çš„æ”¹åŠ¨å°±ä¸‰å¥ï¼š</p><pre><code class=\"language-rust\">// main å‡½æ•°å¼€å¤´ï¼Œåˆå§‹åŒ– service\nlet service: Service = Service::new(MemTable::new());\n// tokio::spawn ä¹‹å‰ï¼Œå¤åˆ¶ä¸€ä»½ service\nlet svc = service.clone();\n// while loop ä¸­ï¼Œä½¿ç”¨ svc æ¥æ‰§è¡Œ cmd\nlet res = svc.execute(cmd);\n</code></pre><p>ä½ å¯ä»¥è¯•ç€è‡ªå·±ä¿®æ”¹ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse async_prost::AsyncProstStream;\nuse futures::prelude::*;\nuse kv::{CommandRequest, CommandResponse, MemTable, Service};\nuse tokio::net::TcpListener;\nuse tracing::info;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    tracing_subscriber::fmt::init();\n    let service: Service = Service::new(MemTable::new());\n    let addr = \"127.0.0.1:9527\";\n    let listener = TcpListener::bind(addr).await?;\n    info!(\"Start listening on {}\", addr);\n    loop {\n        let (stream, addr) = listener.accept().await?;\n        info!(\"Client {:?} connected\", addr);\n        let svc = service.clone();\n        tokio::spawn(async move {\n            let mut stream =\n                AsyncProstStream::&lt;_, CommandRequest, CommandResponse, _&gt;::from(stream).for_async();\n            while let Some(Ok(cmd)) = stream.next().await {\n                let res = svc.execute(cmd);\n                stream.send(res).await.unwrap();\n            }\n            info!(\"Client {:?} disconnected\", addr);\n        });\n    }\n}\n</code></pre><p>å®Œæˆä¹‹åï¼Œæ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --example server --quiet</code>ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š<code>RUST_LOG=info cargo run --example client --quiet</code>ã€‚æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸ã€‚</p><p>æˆ‘ä»¬çš„ KV server ç¬¬ä¸€ç‰ˆçš„åŸºæœ¬åŠŸèƒ½å°±å®Œå·¥äº†ï¼å½“ç„¶ï¼Œç›®å‰è¿˜åªå¤„ç†äº† 3 ä¸ªå‘½ä»¤ï¼Œå‰©ä¸‹ 6 ä¸ªéœ€è¦ä½ è‡ªå·±å®Œæˆã€‚</p><h2>å°ç»“</h2><p>KV server å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆéš¾çš„é¡¹ç›®ï¼Œä½†æƒ³è¦æŠŠå®ƒå†™å¥½ï¼Œå¹¶ä¸ç®€å•ã€‚å¦‚æœä½ è·Ÿç€è®²è§£ä¸€æ­¥æ­¥èµ°ä¸‹æ¥ï¼Œå¯ä»¥æ„Ÿå—åˆ°ä¸€ä¸ªæœ‰æ½œåœ¨ç”Ÿäº§ç¯å¢ƒè´¨é‡çš„ Rust é¡¹ç›®åº”è¯¥å¦‚ä½•å¼€å‘ã€‚åœ¨è¿™ä¸Šä¸‹ä¸¤è®²å†…å®¹ä¸­ï¼Œæœ‰ä¸¤ç‚¹æˆ‘ä»¬ä¸€å®šè¦è®¤çœŸé¢†ä¼šã€‚</p><p>ç¬¬ä¸€ç‚¹ï¼Œä½ è¦å¯¹éœ€æ±‚æœ‰ä¸€ä¸ªæ¸…æ™°çš„æŠŠæ¡ï¼Œæ‰¾å‡ºå…¶ä¸­ä¸ç¨³å®šçš„éƒ¨åˆ†ï¼ˆvariantï¼‰å’Œæ¯”è¾ƒç¨³å®šçš„éƒ¨åˆ†ï¼ˆinvariantï¼‰ã€‚åœ¨ KV server ä¸­ï¼Œä¸ç¨³å®šçš„éƒ¨åˆ†æ˜¯ï¼Œå¯¹å„ç§æ–°çš„å‘½ä»¤çš„æ”¯æŒï¼Œä»¥åŠå¯¹ä¸åŒçš„ storage çš„æ”¯æŒã€‚<strong>æ‰€ä»¥éœ€è¦æ„å»ºæ¥å£æ¥æ¶ˆå¼­ä¸ç¨³å®šçš„å› ç´ ï¼Œè®©ä¸ç¨³å®šçš„éƒ¨åˆ†å¯ä»¥ç”¨ä¸€ç§ç¨³å®šçš„æ–¹å¼æ¥ç®¡ç†</strong>ã€‚</p><p>ç¬¬äºŒç‚¹ï¼Œä»£ç å’Œæµ‹è¯•å¯ä»¥å›´ç»•ç€æ¥å£èºæ—‹å‰è¿›ï¼Œä½¿ç”¨ TDD å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œè¿™ç§èºæ—‹å¼çš„è¿­ä»£ã€‚<strong>åœ¨ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ç³»ç»Ÿä¸­ï¼šæ¥å£æ˜¯ç¨³å®šçš„ï¼Œæµ‹è¯•æ¥å£çš„ä»£ç æ˜¯ç¨³å®šçš„ï¼Œå®ç°å¯ä»¥æ˜¯ä¸ç¨³å®šçš„</strong>ã€‚åœ¨è¿­ä»£å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¦ä¸æ–­åœ°é‡æ„ï¼Œè®©æµ‹è¯•ä»£ç å’Œäº§å“ä»£ç éƒ½å¾€æœ€ä¼˜çš„æ–¹å‘å‘å±•ã€‚</p><p>çºµè§‚æˆ‘ä»¬å†™çš„ KV serverï¼ŒåŒ…æ‹¬æµ‹è¯•åœ¨å†…ï¼Œä½ å¾ˆéš¾å‘ç°æœ‰å‡½æ•°æˆ–è€…æ–¹æ³•è¶…è¿‡ 50 è¡Œï¼Œä»£ç å¯è¯»æ€§éå¸¸å¼ºï¼Œå‡ ä¹ä¸éœ€è¦æ³¨é‡Šï¼Œå°±å¯ä»¥ç†è§£ã€‚å¦å¤–å› ä¸ºéƒ½æ˜¯ç”¨æ¥å£åšçš„äº¤äº’ï¼Œæœªæ¥ç»´æŠ¤å’Œæ·»åŠ æ–°çš„åŠŸèƒ½ï¼Œä¹ŸåŸºæœ¬ä¸Šæ»¡è¶³ OCP åŸåˆ™ï¼Œé™¤äº† dispatch å‡½æ•°éœ€è¦å¾ˆå°çš„ä¿®æ”¹å¤–ï¼Œå…¶å®ƒæ–°çš„ä»£ç éƒ½æ˜¯åœ¨å®ç°ä¸€äº›æ¥å£è€Œå·²ã€‚</p><p>ç›¸ä¿¡ä½ èƒ½åˆæ­¥æ„Ÿå—åˆ°åœ¨ Rust ä¸‹æ’°å†™ä»£ç çš„æœ€ä½³å®è·µã€‚å¦‚æœä½ ä¹‹å‰ç”¨å…¶ä»–è¯­è¨€ï¼Œå·²ç»é‡‡ç”¨äº†ç±»ä¼¼çš„æœ€ä½³å®è·µï¼Œé‚£ä¹ˆå¯ä»¥æ„Ÿå—ä¸€ä¸‹åŒæ ·çš„å®è·µåœ¨ Rust ä¸‹ä½¿ç”¨çš„é‚£ç§ä¼˜é›…ï¼›å¦‚æœä½ ä¹‹å‰ç”±äºç§ç§åŸå› ï¼Œå†™çš„æ˜¯ç±»ä¼¼ä¹‹å‰æ„å¤§åˆ©é¢æ¡ä¼¼çš„ä»£ç ï¼Œé‚£åœ¨å¼€å‘ Rust ç¨‹åºæ—¶ï¼Œä½ å¯ä»¥è¯•ç€æ¥çº³è¿™ç§æ›´ä¼˜é›…çš„å¼€å‘æ–¹å¼ã€‚</p><p>æ¯•ç«Ÿï¼Œç°åœ¨æˆ‘ä»¬æ‰‹ä¸­æœ‰äº†æ›´å…ˆè¿›çš„æ­¦å™¨ï¼Œå°±å¯ä»¥ç”¨æ›´å…ˆè¿›çš„æ‰“æ³•ã€‚</p><h2>æ€è€ƒé¢˜</h2><ol>\n<li>ä¸ºå‰©ä¸‹ 6 ä¸ªå‘½ä»¤ HMGETã€HMSETã€HDELã€HMDELã€HEXISTã€HMEXIST æ„å»ºæµ‹è¯•ï¼Œå¹¶å®ç°å®ƒä»¬ã€‚åœ¨æµ‹è¯•å’Œå®ç°è¿‡ç¨‹ä¸­ï¼Œä½ ä¹Ÿè®¸éœ€è¦æ·»åŠ æ›´å¤šçš„ From&lt;T&gt; çš„å®ç°ã€‚</li>\n<li>å¦‚æœæœ‰ä½™åŠ›ï¼Œå¯ä»¥è¯•ç€å®ç° MemTable çš„ get_iter() æ–¹æ³•ï¼ˆåç»­çš„ KV Store å®ç°ä¼šè®²ï¼‰ã€‚</li>\n</ol><h3>å»¶ä¼¸æ€è€ƒ</h3><p>è™½ç„¶æˆ‘ä»¬çš„ KV server ä½¿ç”¨äº† concurrent hashmap æ¥å¤„ç†å¹¶å‘ï¼Œä½†è¿™å¹¶ä¸ä¸€å®šæ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ HashMapã€‚å½“ HGET/HSET ç­‰å‘½ä»¤æ¥ä¸´æ—¶ï¼Œå¯ä»¥å¯¹ key åšä¸ªå“ˆå¸Œï¼Œç„¶ååˆ†æ´¾åˆ° â€œæ‹¥æœ‰â€ é‚£ä¸ª key çš„çº¿ç¨‹ï¼Œè¿™æ ·ï¼Œå¯ä»¥é¿å…åœ¨å¤„ç†çš„æ—¶å€™åŠ é”ï¼Œæé«˜ç³»ç»Ÿçš„ååã€‚ä½ å¯ä»¥æƒ³æƒ³å¦‚æœç”¨è¿™ç§æ–¹å¼å¤„ç†ï¼Œè¯¥æ€ä¹ˆåšã€‚</p><p>æ­å–œä½ å®Œæˆäº†å­¦ä¹ çš„ç¬¬22æ¬¡æ‰“å¡ã€‚å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹ä¸€è®²æœŸä¸­æµ‹è¯•è§ï½</p>","neighbors":{"left":{"article_title":"21ï½œé˜¶æ®µå®æ“ï¼ˆ1ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-åŸºæœ¬æµç¨‹","id":425001},"right":{"article_title":"åŠ é¤ï½œæœŸä¸­æµ‹è¯•ï¼šæ¥å†™ä¸€ä¸ªç®€å•çš„grepå‘½ä»¤è¡Œ","id":425013}},"comments":[{"had_liked":false,"id":315538,"user_name":"newzai","can_delete":false,"product_type":"c1","uid":1102367,"ip_address":"","ucode":"D5E34D427D65FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/d2/1f/2ef2514b.jpg","comment_is_top":false,"comment_ctime":1633916032,"is_pvip":false,"replies":[{"id":"115294","content":"examples &#47; test é‡Œç”¨çš„åº“æ˜¯ dev-dependencies + dependenciesã€‚build.rs é‡Œç”¨åˆ°çš„åº“æ˜¯ build-dependencies + dependenciesã€‚æ­£å¸¸ä»£ç ï¼ˆåº“&#47;äºŒè¿›åˆ¶ï¼‰ç”¨çš„æ˜¯ dependencies","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635133081,"ip_address":"","comment_id":315538,"utype":1}],"discussion_count":3,"race_medal":1,"score":"48878556288","product_id":100085301,"comment_content":"dev-dependencies ä¸ dependenciesçš„ç¬¬ä¸‰æ–¹crateæ˜¯å¦‚ä½•åˆ’åˆ†çš„?tokio ä¸ºå•¥ä¸æ”¾åˆ° dependencies? æ”¾åˆ° dependencies ä¸ dev-dependencies æœ‰å•¥åŒºåˆ«ï¼ŸæŸäº›å¦‚ä½•å†³ç­–ä¸€ä¸ª crateæ”¾åˆ°å“ªä¸ª dependenciesï¼Ÿ","like_count":11,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528065,"discussion_content":"examples / test é‡Œç”¨çš„åº“æ˜¯ dev-dependencies + dependenciesã€‚build.rs é‡Œç”¨åˆ°çš„åº“æ˜¯ build-dependencies + dependenciesã€‚æ­£å¸¸ä»£ç ï¼ˆåº“/äºŒè¿›åˆ¶ï¼‰ç”¨çš„æ˜¯ dependencies","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635133081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1401568,"avatar":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","nickname":"è®°äº‹æœ¬","note":"","ucode":"FA942636EE0CC8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402630,"discussion_content":"dev-dependencies  ï¼šcargo build æ—¶å€™ç”¨åˆ°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633923416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200704,"avatar":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","nickname":"pedro","note":"","ucode":"F40C839DDFD599","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402587,"discussion_content":"dev=developï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨ï¼Œç”Ÿæˆç¯å¢ƒä¸ä½¿ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633919561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327335,"user_name":"æ–½æ³°åš","can_delete":false,"product_type":"c1","uid":2718966,"ip_address":"","ucode":"E88E4E737398EF","user_header":"https://static001.geekbang.org/account/avatar/00/29/7c/f6/028f80a8.jpg","comment_is_top":false,"comment_ctime":1640070385,"is_pvip":false,"replies":[{"id":"120815","content":"ğŸ‘ å¾ˆå¥½çš„ tips","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1642310938,"ip_address":"","comment_id":327335,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27409874161","product_id":100085301,"comment_content":"ç”¨powershellçš„ã€‚RUST _LOG=infoã€‚æ”¹æˆ$env:RUST_LOG=&quot;info&quot;;ç„¶åå†cargo run","like_count":6,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546458,"discussion_content":"ğŸ‘ å¾ˆå¥½çš„ tips","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642310938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320299,"user_name":"Geek_b52974","can_delete":false,"product_type":"c1","uid":1298252,"ip_address":"","ucode":"59884399646620","user_header":"","comment_is_top":false,"comment_ctime":1636208091,"is_pvip":true,"replies":[{"id":"116352","content":"å—¯ï¼Œæ²¡é—®é¢˜ï¼Œå¯ä»¥ï¼š<br><br>fn set(<br>        &amp;self,<br>        table: &amp;str,<br>        key: impl Into&lt;String&gt;,<br>        value: impl Into&lt;Value&gt;,<br>    ) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636526949,"ip_address":"","comment_id":320299,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18816077275","product_id":100085301,"comment_content":"ä¸ºä½•ä¸æ˜¯è¿™æ ·è®¾è®¡<br><br>  fn set(&amp;self, table: &amp;str, key: String, value: impl Into&lt;Value&gt;) <br><br>è¿™æ ·ä»¥æ¥å°±å¯ä»¥è®©ä½¿ç”¨è€…çŸ¥é“ä»–æœ‰ä¸€ä¸ªæ–°çš„type éœ€è¦å­˜æ—¶åº”è¯¥ implement è¿™ä¸ª trait ä¹Ÿä¸ä¼šè®©ä½¿ç”¨æ—¶éœ€è¦ä¸€ç›´ å†™into","like_count":5,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529948,"discussion_content":"å—¯ï¼Œæ²¡é—®é¢˜ï¼Œå¯ä»¥ï¼š\n\nfn set(\n        &amp;amp;self,\n        table: &amp;amp;str,\n        key: impl Into&amp;lt;String&amp;gt;,\n        value: impl Into&amp;lt;Value&amp;gt;,\n    ) -&amp;gt; Result&amp;lt;Option&amp;lt;Value&amp;gt;, KvError&amp;gt;;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636526949,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317148,"user_name":"Roy Liang","can_delete":false,"product_type":"c1","uid":1098898,"ip_address":"","ucode":"1DF5FC831A35DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg","comment_is_top":false,"comment_ctime":1634695496,"is_pvip":false,"replies":[{"id":"115249","content":"get_all() ä¼šæœ‰å¤ªå¤šå†…å­˜å ç”¨ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦æä¾›å¯éå†çš„ç»“æœæ—¶ï¼Œå€¾å‘äºä½¿ç”¨ iterator","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635123428,"ip_address":"","comment_id":317148,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14519597384","product_id":100085301,"comment_content":"è€å¸ˆï¼Œget_allæ¥å£ä¸ºä»€ä¹ˆä¸å¥½ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528682,"discussion_content":"get_all() ä¼šæœ‰å¤ªå¤šå†…å­˜å ç”¨ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦æä¾›å¯éå†çš„ç»“æœæ—¶ï¼Œå€¾å‘äºä½¿ç”¨ iterator","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635123428,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317989,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1635088058,"is_pvip":false,"replies":[{"id":"115304","content":"è°¢è°¢ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635133708,"ip_address":"","comment_id":317989,"utype":1}],"discussion_count":1,"race_medal":2,"score":"10225022650","product_id":100085301,"comment_content":"å¿…é¡»ä»”ç»†çœ‹è€å¸ˆçš„æ•™ç¨‹ï¼Œä¸ä»”ç»†å°±æ‰å‘é‡Œäº†ã€‚è¯´å®è¯è€å¸ˆçš„æ–‡ç« è®²çš„æ˜¯çœŸå¿ƒè¯¦ç»†ï¼ŒåŸºæœ¬ä¸ŠæŠŠæ‰€æœ‰çš„å‘éƒ½è®²äº†ã€‚å¦‚æœå®åœ¨ç¼–è¯‘ä¸è¿‡ï¼Œå»ä¸‹è½½è€å¸ˆçš„æºç ï¼Œåƒä¸‡è®°å¾—è¦åšæŒä¸‹å»ã€‚","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529058,"discussion_content":"è°¢è°¢ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635133708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315643,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1633934273,"is_pvip":false,"replies":[{"id":"115293","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635132998,"ip_address":"","comment_id":315643,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10223868865","product_id":100085301,"comment_content":"å¾—ç›Šäºè€å¸ˆè‰¯å¥½çš„æŠ½è±¡ï¼Œæˆ‘æŠ½å‡ºäº†ä¸­åˆçš„æ—¶é—´ï¼Œå®Œæˆäº† hdel å’Œ hexist ä¸¤ä¸ªå‘½ä»¤ï¼Œå¦‚ä¸‹ï¼š<br>```<br>running 6 tests<br>test service::command_service::tests::hget_with_non_exist_key_should_return_404 ... ok<br>test service::command_service::tests::hexist_should_work ... ok<br>test service::command_service::tests::hget_should_work ... ok<br>test service::command_service::tests::hdel_should_work ... ok<br>test service::command_service::tests::hset_should_work ... ok<br>test service::command_service::tests::hgetall_should_work ... ok<br>```<br><br>æœ‰æ—¶é—´å†æ¥æ…¢æ…¢è¡¥å……ï¼Œrust ç¡®å®æ˜¯çˆ½çš„ä¸è¡Œã€‚","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528135,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1401568,"avatar":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","nickname":"è®°äº‹æœ¬","note":"","ucode":"FA942636EE0CC8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405284,"discussion_content":"åŒå­¦ï¼ŒåŠ ä¸ªå¾®ä¿¡äº¤æµä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634548794,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323720,"user_name":"losuika","can_delete":false,"product_type":"c1","uid":1218666,"ip_address":"","ucode":"19685B1B00A4F3","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/6a/3ddeca6e.jpg","comment_is_top":false,"comment_ctime":1638115944,"is_pvip":false,"replies":[{"id":"118878","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639849887,"ip_address":"","comment_id":323720,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5933083240","product_id":100085301,"comment_content":"æ„Ÿè§‰ get_iter åŠ ä¸Šç”Ÿå‘½å‘¨æœŸçš„çº¦æŸå¥½ä¸€äº›ï¼Œå› ä¸ºç°åœ¨ GAT è¿˜æ²¡ç¨³å®šï¼Œå¯ä»¥è¿™æ ·å®ç°ä¸‹ï¼Œ<br>fn get_iter&lt;&#39;a&gt;(<br>    &amp;&#39;a self,<br>    table: &amp;str,<br>) -&gt; Result&lt;Box&lt;dyn Iterator&lt;Item = crate::Kvpair&gt; + &#39;a&gt;, crate::KvError&gt; {<br>    let table = self.get_or_create_table(table);<br>    let inner = Iter::new(table);<br>    Ok(Box::new(inner))<br>}<br><br>struct Iter&lt;&#39;a&gt; {<br>    _table: *const Ref&lt;&#39;static, String, DashMap&lt;String, Value&gt;&gt;,<br>    inner: dashmap::iter::Iter&lt;&#39;a, String, Value&gt;,<br>}<br><br>impl&lt;&#39;a&gt; Iter&lt;&#39;a&gt; {<br>    fn new(table: Ref&lt;&#39;a, String, DashMap&lt;String, Value&gt;&gt;) -&gt; Self {<br>        let t = unsafe {std::mem::transmute::&lt;Ref&lt;&#39;a, String, DashMap&lt;String, Value&gt;&gt;, Ref&lt;&#39;static, String, DashMap&lt;String, Value&gt;&gt;&gt;(table)};<br>        let _table = Box::leak(Box::new(t)) as *const Ref&lt;&#39;static, String, DashMap&lt;String, Value&gt;&gt;;<br><br>        let inner = unsafe {(*_table).iter()};<br>        Self {_table, inner}<br>    }<br>}<br><br>impl&lt;&#39;a&gt; Iterator for Iter&lt;&#39;a&gt; {<br>    type Item = crate::Kvpair;<br><br>    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {<br>        let item = self.inner.next();<br>        item.map(|v| crate::Kvpair::new(v.key(), v.value().clone()))<br>    }<br>}<br><br>impl&lt;&#39;a&gt; Drop for Iter&lt;&#39;a&gt; {<br>    fn drop(&amp;mut self) {<br>        unsafe { drop_in_place(self._table as *mut Ref&lt;&#39;a, String, DashMap&lt;String, Value&gt;&gt;) };<br>    }<br>}","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539839,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639849887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320636,"user_name":"å‘¨","can_delete":false,"product_type":"c1","uid":1149798,"ip_address":"","ucode":"E4D57FF40B355A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8b/66/2b55a7ac.jpg","comment_is_top":false,"comment_ctime":1636429945,"is_pvip":false,"replies":[{"id":"116302","content":"ä½ éœ€è¦ async-prost ä¹Ÿå‡çº§åˆ° prost 0.9 ç‰ˆæœ¬ã€‚æ³¨æ„åƒ prost è¿™æ ·çš„åº“ï¼Œåœ¨ä¸åŒç‰ˆæœ¬é—´ç”Ÿæˆçš„ protobuf ä»£ç æœ‰å¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä½ ä¸èƒ½æŠŠ kv ä¸­ä½¿ç”¨ 0.9 ç¼–è¯‘å‡ºæ¥çš„ protobufï¼Œç”¨åœ¨ 0.8 ç‰ˆæœ¬ä¸­ encode&#47;decodeã€‚å°±å¥½æ¯”ä½ è¦ç”¨å‰æœçš„å°šæ–¹å®å‰‘æ–©æœ¬æœçš„å®˜ä¸€æ ·ã€‚<br><br>æˆ‘æŠŠ async-prost å‡çº§äº†ä¸€ä¸‹ï¼ˆ0.3ï¼‰ï¼Œä¹ŸæŠŠ kv å‡çº§åˆ° prost 0.9ï¼Œç¼–è¯‘å¯ä»¥é€šè¿‡ï¼Œä½ å¯ä»¥è¯•è¯•çœ‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636471387,"ip_address":"","comment_id":320636,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5931397241","product_id":100085301,"comment_content":"æˆ‘æŠŠprostçš„ç‰ˆæœ¬æ”¹æˆ0.9ï¼ˆ0.8ç‰ˆæœ¬çš„å¯ä»¥æ­£å¸¸è¿è¡Œ) ï¼Œç„¶åå†æµ‹è¯•examplesçš„æ—¶å€™ client.sendçš„æ—¶å€™æœ‰ä¸ªæŠ¥é”™:<br>the method `send` exists for struct `AsyncProstStream&lt;tokio::net::TcpStream, CommandResponse, CommandRequest, AsyncDestination&gt;`, but its trait bounds were not satisfied<br>the following trait bounds were not satisfied:<br>`AsyncProstStream&lt;tokio::net::TcpStream, CommandResponse, CommandRequest, AsyncDestination&gt;: futures::Sink&lt;_&gt;`<br>which is required by `AsyncProstStream&lt;tokio::net::TcpStream, CommandResponse, CommandRequest, AsyncDestination&gt;: SinkExt&lt;_&gt;`rustcE0599<br>stream.rs(24, 1): doesn&#39;t satisfy `_: SinkExt&lt;_&gt;`<br>stream.rs(24, 1): doesn&#39;t satisfy `_: futures::Sink&lt;_&gt;`.<br>æˆ‘è¯•ç€ç”¨â€œå¦‚ä½•é˜…è¯»æºç â€é‡Œè¾¹çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å¤ªæ‡‚è¿™ä¸ªé”™è¯¯çš„åŸå› ã€‚å¸Œæœ›è€å¸ˆèƒ½æŒ‡ç‚¹ä¸‹æŸ¥é”™çš„æ–¹æ³•","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530073,"discussion_content":"ä½ éœ€è¦ async-prost ä¹Ÿå‡çº§åˆ° prost 0.9 ç‰ˆæœ¬ã€‚æ³¨æ„åƒ prost è¿™æ ·çš„åº“ï¼Œåœ¨ä¸åŒç‰ˆæœ¬é—´ç”Ÿæˆçš„ protobuf ä»£ç æœ‰å¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä½ ä¸èƒ½æŠŠ kv ä¸­ä½¿ç”¨ 0.9 ç¼–è¯‘å‡ºæ¥çš„ protobufï¼Œç”¨åœ¨ 0.8 ç‰ˆæœ¬ä¸­ encode/decodeã€‚å°±å¥½æ¯”ä½ è¦ç”¨å‰æœçš„å°šæ–¹å®å‰‘æ–©æœ¬æœçš„å®˜ä¸€æ ·ã€‚\n\næˆ‘æŠŠ async-prost å‡çº§äº†ä¸€ä¸‹ï¼ˆ0.3ï¼‰ï¼Œä¹ŸæŠŠ kv å‡çº§åˆ° prost 0.9ï¼Œç¼–è¯‘å¯ä»¥é€šè¿‡ï¼Œä½ å¯ä»¥è¯•è¯•çœ‹ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636471387,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318322,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1635240642,"is_pvip":true,"replies":[{"id":"116581","content":"prost çŸ¥è¯† protobuf serialize &#47; deserialize çš„å·¥å…·ï¼Œå¹¶ä¸è´Ÿè´£åšè¿™æ ·çš„äº‹æƒ…ã€‚ä½ è¯´çš„åŠåŒ…ç²˜åŒ…çš„é—®é¢˜ï¼Œæ˜¯è¢« async_prost å¤„ç†çš„ï¼šhttps:&#47;&#47;github.com&#47;tyrchen&#47;async-prost&#47;blob&#47;master&#47;src&#47;reader.rs#L136ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨ç½‘ç»œé‚£ä¸€å ‚è®²åˆ°çš„ Frame &#47; LengthDelimitedCodec æ¥å§å§ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636642968,"ip_address":"","comment_id":318322,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5930207938","product_id":100085301,"comment_content":"tcpçš„åŠåŒ…ç²˜åŒ…ç­‰ï¼Œæ˜¯è¢«prostå¤„ç†æ‰äº†å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529188,"discussion_content":"prost çŸ¥è¯† protobuf serialize / deserialize çš„å·¥å…·ï¼Œå¹¶ä¸è´Ÿè´£åšè¿™æ ·çš„äº‹æƒ…ã€‚ä½ è¯´çš„åŠåŒ…ç²˜åŒ…çš„é—®é¢˜ï¼Œæ˜¯è¢« async_prost å¤„ç†çš„ï¼šhttps://github.com/tyrchen/async-prost/blob/master/src/reader.rs#L136ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨ç½‘ç»œé‚£ä¸€å ‚è®²åˆ°çš„ Frame / LengthDelimitedCodec æ¥å§å§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636642968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316419,"user_name":"xl000","can_delete":false,"product_type":"c1","uid":1117935,"ip_address":"","ucode":"6FEABE7F7D0DC0","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/ef/030e6d27.jpg","comment_is_top":false,"comment_ctime":1634299283,"is_pvip":false,"replies":[{"id":"115273","content":"å—¯ï¼Œå¯ä»¥ç”¨ impl Into&lt;Value&gt;","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635131236,"ip_address":"","comment_id":316419,"utype":1}],"discussion_count":1,"race_medal":5,"score":"5929266579","product_id":100085301,"comment_content":"```Rust<br>impl Kvpair {<br>    &#47;&#47;&#47; åˆ›å»ºä¸€ä¸ªæ–°çš„ kv pair<br>    fn new(key: impl Into&lt;String&gt;, value: impl Into&lt;Value&gt;) -&gt; Self {<br>        Self {<br>            key: key.into(),<br>            value: Some(value.into()),<br>        }<br>    }<br>}<br>```<br>è€å¸ˆValueç±»å‹çš„å‚æ•°ä¸ºä»€ä¹ˆä¸ç”¨impl Into&lt;Value&gt;æ¥å®šä¹‰å‘¢ï¼Œä¼šæœ‰ä»€ä¹ˆé—®é¢˜å—","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528379,"discussion_content":"å—¯ï¼Œå¯ä»¥ç”¨ impl Into&amp;lt;Value&amp;gt;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635131236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315784,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1634000193,"is_pvip":false,"replies":[{"id":"115288","content":"å—¯ï¼Œæ˜¯çš„ã€‚github é‡Œæ˜¯æ­£ç¡®çš„ï¼Œä½†æ–‡ç« å¿˜è®°æ”¹äº†ï¼Œæˆ‘è®©ç¼–è¾‘æ›´æ–°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635132834,"ip_address":"","comment_id":315784,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5928967489","product_id":100085301,"comment_content":"æ–‡ä¸­ä»£ç æœ‰ä¸€å¤„é”™è¯¯ï¼š<br>let cloned = service.clone();<br>&#47;&#47; åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨ table t1 ä¸­å†™å…¥ k1, v1<br>let handle = thread::spawn(move || {<br>      let res = cloned.execute(CommandRequest::new_hset(&quot;t1&quot;, &quot;k1&quot;, &quot;v1&quot;.into()));<br>      assert_res_ok(res, &amp;[Value::default()], &amp;[]);<br>});<br><br>ä¸‹é¢çš„ execute åº”è¯¥æ˜¯æœ‰ cloned æ¥æ‰§è¡Œçš„ï¼Œä¸èƒ½ç”± service æ‰§è¡Œï¼Œæ‰€æœ‰æƒé—®é¢˜ã€‚<br>","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528165,"discussion_content":"å—¯ï¼Œæ˜¯çš„ã€‚github é‡Œæ˜¯æ­£ç¡®çš„ï¼Œä½†æ–‡ç« å¿˜è®°æ”¹äº†ï¼Œæˆ‘è®©ç¼–è¾‘æ›´æ–°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359841,"user_name":"Geek_a6c6ce","can_delete":false,"product_type":"c1","uid":3074996,"ip_address":"å¹¿ä¸œ","ucode":"21DC76D3225403","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/TusRVU51UggZGpicXMgH64Cb8jek0wyTOpagtUHNAj0EPbhbEv0FJpFU2K3glbtOdJXiaQ9o6QoEfv5PiaIu7rwng/132","comment_is_top":false,"comment_ctime":1665972785,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665972785","product_id":100085301,"comment_content":"å’”å“’","like_count":0},{"had_liked":false,"id":357155,"user_name":"çº¦ä¹¦äºš","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"æ—¥æœ¬","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1662995255,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662995255","product_id":100085301,"comment_content":"åšiterçš„ç»ƒä¹ è¢«ç”Ÿå‘½å‘¨æœŸæŠ˜ç£¨å¾—å¿«å“­äº†ã€‚åé¢åº”è¯¥ç€é‡å†è®²ä¸€è®²çš„","like_count":0},{"had_liked":false,"id":357013,"user_name":"çº¦ä¹¦äºš","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"å¤©æ´¥","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1662858666,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662858666","product_id":100085301,"comment_content":"çœ‹åˆ°ServiceInnerå’ŒServiceçš„å®ç°ä»£ç å°±å‹¾èµ·äº†æˆ‘ä¸€ç›´çš„ä¸€ä¸ªç–‘é—®<br>ServiceInner&lt;Store: Storage&gt; å†™æˆè¿™æ ·ä¸å¯ä»¥ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¿˜è¦åœ¨å®ç°Serviceæ–¹æ³•æ—¶æ‰ç¡®å®šæ³›å‹å‚æ•°ï¼Œå°±åƒæ–‡ä¸­è¿™æ ·ï¼š impl&lt;Store: Storage&gt; Service&lt;Store&gt;<br>æ›´é«˜ä¸€çº§çš„æŠ½è±¡æœ‰å¿…è¦ä¹ˆï¼Ÿæˆ‘æ„Ÿè§‰åœ¨è¿™ä¸ªè½¯ä»¶çš„å¯è§ç”Ÿå‘½å‘¨æœŸé‡Œéƒ½ä¸å¤ªä¼šç”¨æœ‰éStorageçš„Storeå§ï¼Ÿ<br>ä½†æˆ‘åœ¨çœ‹rustçš„ä¸€äº›ä¸‰æ–¹å®ç°ä»¥åŠä¹‹å‰å…¶ä»–æ”¯æŒå¤æ‚æ³›å‹çš„è¯­è¨€çš„ä»£ç é‡Œï¼Œå¥½åƒéƒ½æ˜¯è¿™ç§é£æ ¼ã€‚<br>ä¸å¤ªç†è§£å…¶æ„ä¹‰ã€‚","like_count":0},{"had_liked":false,"id":334988,"user_name":"manonloki","can_delete":false,"product_type":"c1","uid":1199431,"ip_address":"","ucode":"BB28C47615C851","user_header":"https://static001.geekbang.org/account/avatar/00/12/4d/47/bd232c70.jpg","comment_is_top":false,"comment_ctime":1645241190,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645241190","product_id":100085301,"comment_content":"è¿™é‡Œå¡«ä¸ªå‘ï¼Œprostç”Ÿæˆçš„ä»£ç ä¸­æœ‰ä¸¤ä¸ªValue ã€‚<br>ä¸€ä¸ªæ˜¯ç»“æ„ä½“ å¯¹åº”çš„æ˜¯message Value,<br>å¦ä¸€ä¸ªæ˜¯æšä¸¾value::Value å¯¹åº”çš„æ˜¯ message Value{ value }ã€‚<br>ä¾‹å­é‡Œç”¨çš„æ˜¯ç»“æ„ä½“ã€‚å¦‚æœå¼•å…¥äº†æšä¸¾é‚£ä¸ªï¼Œå°±ä¼šæŠ¥é”™è¯´æ²¡æœ‰å®ç°Defaultã€‚<br>å¦‚æœå¼ºåˆ¶æ‰‹å·¥å®ç°ä¹Ÿä¼šæŠ¥å…¶ä»–é”™è¯¯ã€‚å…·ä½“åŸå› å­¦è¯†å°šæµ…ä¸å¤ªæ¸…æ¥šï¼Œä½†æ˜¯è¿™å‘ç»™æ–°äººæŒ‡å‡ºæ¥ï¼Œå…å¾—è·Ÿæˆ‘ä¸€æ ·å¡äº†ä¸¤å¤©â€¦â€¦","like_count":0},{"had_liked":false,"id":333102,"user_name":"æ…•é«˜è¿ª","can_delete":false,"product_type":"c1","uid":1448126,"ip_address":"","ucode":"EB1CB5EA4E3A90","user_header":"https://static001.geekbang.org/account/avatar/00/16/18/be/ad3127e0.jpg","comment_is_top":false,"comment_ctime":1644065804,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1644065804","product_id":100085301,"comment_content":"è€å¸ˆï¼Œè¿™ä¸ª as _ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2660581,"avatar":"https://static001.geekbang.org/account/avatar/00/28/98/e5/a716040e.jpg","nickname":"...zzZ","note":"","ucode":"953A50D833CA58","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551885,"discussion_content":"as æ˜¯ç±»å‹è½¬æ¢ï¼Œ_ æ˜¯çœç•¥ç±»å‹è®©ç¼–è¯‘å™¨æ¨å¯¼ã€‚æ¯”å¦‚ï¼šfn f(_: i64) {}; let i: i32 = 0;f(i as _);","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1645164377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323592,"user_name":"Jagger","can_delete":false,"product_type":"c1","uid":1914208,"ip_address":"","ucode":"0BD13223AEE076","user_header":"https://static001.geekbang.org/account/avatar/00/1d/35/60/d3e723a7.jpg","comment_is_top":false,"comment_ctime":1638007868,"is_pvip":true,"replies":[{"id":"118884","content":"ä½ çœ‹çœ‹ä½ è‡ªå·±çš„ Value å®ç° Default trait æ²¡ï¼Ÿå¯ä»¥å‚è€ƒ github repo  ä¸‹çš„ä»£ç ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639850140,"ip_address":"","comment_id":323592,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1638007868","product_id":100085301,"comment_content":"é™ˆè€å¸ˆï¼ŒValue::default() è¿™ä¸ªå‡½æ•°æˆ‘æ²¡æœ‰æ‰¾åˆ°å“ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539845,"discussion_content":"ä½ çœ‹çœ‹ä½ è‡ªå·±çš„ Value å®ç° Default trait æ²¡ï¼Ÿå¯ä»¥å‚è€ƒ github repo  ä¸‹çš„ä»£ç ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639850140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218666,"avatar":"https://static001.geekbang.org/account/avatar/00/12/98/6a/3ddeca6e.jpg","nickname":"losuika","note":"","ucode":"19685B1B00A4F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534839,"discussion_content":"Value é‡Œé¢æ˜¯ Option ï¼ŒOption å®ç°äº† Defaultï¼Œæ‰€ä»¥ Value ä¹Ÿå°±å®ç°äº† Default","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638284446,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322923,"user_name":"ä¸œå­","can_delete":false,"product_type":"c1","uid":1507020,"ip_address":"","ucode":"A8B9FC47AE9285","user_header":"https://static001.geekbang.org/account/avatar/00/16/fe/cc/d1923683.jpg","comment_is_top":false,"comment_ctime":1637659045,"is_pvip":false,"replies":[{"id":"118899","content":"ä½ ä¸èƒ½ä¹‹é—´æ¢ BTreeMapï¼Œè€Œæ˜¯éœ€è¦ç±»ä¼¼ Arc&lt;RwLock&lt;BTreeMap&gt;&gt; çš„ç»“æ„ï¼Œå› ä¸ºä½ è¦å¤šçº¿ç¨‹è¯»å†™è¿™ä¸ªæ•°æ®ã€‚Dashmap å†…éƒ¨å°è£…äº†ä¸€ä¸ªä¼˜åŒ–çš„ Arc&lt;RwLock&lt;HashMap&gt;&gt;ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639851626,"ip_address":"","comment_id":322923,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1637659045","product_id":100085301,"comment_content":"#[derive(Clone, Debug, Default)]<br>pub struct MemTable {<br>    tables: DashMap&lt;String, BTreeMap&lt;String, String&gt;&gt;,<br>}<br><br>impl MemTable {<br>    &#47;&#47;&#47; åˆ›å»ºä¸€ä¸ªç¼ºçœçš„ MemTable<br>    pub fn new() -&gt; Self {<br>        Self::default()<br>    }<br><br>    &#47;&#47;&#47; å¦‚æœåä¸º name çš„ hash table ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºï¼Œå¦åˆ™è¿”å›<br>    fn get_or_create_table(&amp;self, name: &amp;str) -&gt; Ref&lt;String, BTreeMap&lt;String, String&gt;&gt; {<br>        match self.tables.get(name) {<br>            Some(table) =&gt; table,<br>            None =&gt; {<br>                let entry = self.tables.entry(name.into()).or_default();<br>                entry.downgrade()<br>            }<br>        }<br>    }<br>    fn set(&amp;self, table: &amp;str, key: String, value: String) -&gt; Result&lt;bool&gt; {<br>        let mut table = self.get_or_create_table(table);<br>        table.insert(key, value);<br>        Ok(true)<br>    }<br>}<br><br>tables: DashMap&lt;String, BTreeMap&lt;String, String&gt;&gt;,æˆ‘æŠŠdashmapæ¢æˆ btreemap å°±ä¼šæŠ¥é”™<br><br>error[E0596]: cannot borrow data in a dereference of `dashmap::mapref::one::Ref&lt;&#39;_, String, BTreeMap&lt;String, String&gt;&gt;` as mutable<br>  --&gt; src&#47;map_demo.rs:71:9<br>   |<br>71 |         table.insert(key, value);<br>   |         ^^^^^ cannot borrow as mutable<br>é™ˆè€å¸ˆ ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539860,"discussion_content":"ä½ ä¸èƒ½ä¹‹é—´æ¢ BTreeMapï¼Œè€Œæ˜¯éœ€è¦ç±»ä¼¼ Arc&lt;RwLock&lt;BTreeMap&gt;&gt; çš„ç»“æ„ï¼Œå› ä¸ºä½ è¦å¤šçº¿ç¨‹è¯»å†™è¿™ä¸ªæ•°æ®ã€‚Dashmap å†…éƒ¨å°è£…äº†ä¸€ä¸ªä¼˜åŒ–çš„ Arc&lt;RwLock&lt;HashMap&gt;&gt;ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639851626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317827,"user_name":"å•¦å•¦å•¦å•¦å•¦å•¦å•¦","can_delete":false,"product_type":"c1","uid":1470066,"ip_address":"","ucode":"220DC1DF76454F","user_header":"https://static001.geekbang.org/account/avatar/00/16/6e/72/f8e5b97e.jpg","comment_is_top":false,"comment_ctime":1634982807,"is_pvip":false,"replies":[{"id":"115225","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635121214,"ip_address":"","comment_id":317827,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634982807","product_id":100085301,"comment_content":"å®ç° Hmgetï¼š<br> &#47;&#47;&#47; ä»ä¸€ä¸ª HashTable é‡Œè·å– æ‰¹é‡ keys å¯¹åº”çš„ values<br>    fn get_values(&amp;self, table: &amp;str, keys: &amp;Vec&lt;String&gt;) -&gt; Result&lt;Vec&lt;Option&lt;Value&gt;&gt;, KvError&gt;;<br>&#47;&#47;&#47; åˆ›å»º HMGET å‘½ä»¤<br>    pub fn new_hmget(table: impl Into&lt;String&gt;, keys: Vec&lt;impl Into&lt;String&gt; + Copy&gt;)  -&gt; Self {<br><br>        Self {<br>            request_data: Some(RequestData::Hmget(Hmget {<br>                table: table.into(),<br>                keys: keys<br>                    .iter()<br>                    .map(|&amp;s| s.into())<br>                    .collect(),<br>            })),<br>        }<br>    }<br><br>impl CommandService for Hmget {<br>    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {<br>        match store.get_values(&amp;self.table, &amp;self.keys) {<br>            Ok(v) =&gt; v.into(),<br>            Err(e) =&gt; e.into(),<br>        }<br>    }<br>}<br><br>fn get_values(&amp;self, table: &amp;str, keys: &amp;Vec&lt;String&gt;) -&gt; Result&lt;Vec&lt;Option&lt;Value&gt;&gt;, KvError&gt; {<br>    let table = self.get_or_create_table(table);<br>    let mut result: Vec&lt;Option&lt;Value&gt;&gt; = Vec::new();<br>    for key in keys.iter() {<br>      if let Some(val) = table.get(key).map(|v| v.value().clone()) {<br>        result.push(Some(val));<br>      }<br>    }<br>    Ok(result)<br>  }<br>#[test]<br>    fn hmget_should_work() {<br>        let store = MemTable::new();<br>        let cmd = CommandRequest::new_hset(&quot;score&quot;, &quot;u1&quot;, 10.into());<br>        dispatch(cmd, &amp;store);<br>        let cmd = CommandRequest::new_hset(&quot;score&quot;, &quot;12&quot;, 11.into());<br>        dispatch(cmd, &amp;store);<br>        let cmd = CommandRequest::new_hmget(&quot;score&quot;, vec![&quot;u1&quot;, &quot;12&quot;]);<br>        let res = dispatch(cmd, &amp;store);<br>        assert_res_ok(res, &amp;[10.into(), 11.into()], &amp;[]);<br>    }","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528993,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635121214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317222,"user_name":"Roy Liang","can_delete":false,"product_type":"c1","uid":1098898,"ip_address":"","ucode":"1DF5FC831A35DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg","comment_is_top":false,"comment_ctime":1634715599,"is_pvip":false,"replies":[{"id":"115245","content":"å—¯ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„è¿™æ ·çš„åœºæ™¯ï¼Œå•ä¸ªé”™è¯¯çš„å¤„ç†æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œé™¤éä½¿ç”¨ Vec&lt;Result&lt;T, E&gt;&gt;ã€‚å¦‚æœä¸æ”¹å˜æ¥å£ï¼Œè¿™é‡Œï¼Œè¿”å›é»˜è®¤å€¼æ˜¯æ¯”è¾ƒå¯è¡Œçš„æ–¹æ³•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635123075,"ip_address":"","comment_id":317222,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634715599","product_id":100085301,"comment_content":"hmget&#47;hmsetç­‰å‘½ä»¤è°ƒç”¨storageæ¥å£æ—¶ï¼Œå¦‚ä½•è¿›è¡Œé”™è¯¯å¤„ç†æ¯”è¾ƒå¥½ï¼Ÿæˆ‘ç°åœ¨æ˜¯å¿½ç•¥é”™è¯¯ï¼Œè¿”å›é»˜è®¤å€¼ï¼Œæ„Ÿè§‰ä¸å¤ªå¥½","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528723,"discussion_content":"å—¯ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„è¿™æ ·çš„åœºæ™¯ï¼Œå•ä¸ªé”™è¯¯çš„å¤„ç†æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œé™¤éä½¿ç”¨ Vec&amp;lt;Result&amp;lt;T, E&amp;gt;&amp;gt;ã€‚å¦‚æœä¸æ”¹å˜æ¥å£ï¼Œè¿™é‡Œï¼Œè¿”å›é»˜è®¤å€¼æ˜¯æ¯”è¾ƒå¯è¡Œçš„æ–¹æ³•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635123075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317179,"user_name":"Roy Liang","can_delete":false,"product_type":"c1","uid":1098898,"ip_address":"","ucode":"1DF5FC831A35DA","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/92/338b5609.jpg","comment_is_top":false,"comment_ctime":1634700980,"is_pvip":false,"replies":[{"id":"115248","content":"ä½ éœ€è¦è‡ªå·±å…ˆå®ç°ä¸€ä¸‹åˆ° Value çš„è½¬æ¢ï¼š<br><br>impl From&lt;bool&gt; for Value {<br>    fn from(b: bool) -&gt; Self {<br>        Self {<br>            value: Some(value::Value::Bool(b)),<br>        }<br>    }<br>}","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635123339,"ip_address":"","comment_id":317179,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634700980","product_id":100085301,"comment_content":"```<br>impl CommandService for Hexist {<br>    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {<br>        match store.contains(&amp;self.table, &amp;self.key) {<br>            Ok(v) =&gt; v.into(),<br>            Err(e) =&gt; e.into(),<br>        }<br>    }<br>}<br>```<br>è¿™é‡Œç¼–è¯‘æŠ¥é”™ï¼š^^^^ the trait `From&lt;bool&gt;` is not implemented for `abi::CommandResponse`<br>å¸ƒå°”å€¼æ€æ ·è½¬ä¸ºCommandResponseå‘¢ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528701,"discussion_content":"ä½ éœ€è¦è‡ªå·±å…ˆå®ç°ä¸€ä¸‹åˆ° Value çš„è½¬æ¢ï¼š\n\nimpl From&amp;lt;bool&amp;gt; for Value {\n    fn from(b: bool) -&amp;gt; Self {\n        Self {\n            value: Some(value::Value::Bool(b)),\n        }\n    }\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635123339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315992,"user_name":"ç»ˆç”Ÿæ»éš","can_delete":false,"product_type":"c1","uid":2739953,"ip_address":"","ucode":"4E21A631545D22","user_header":"https://static001.geekbang.org/account/avatar/00/29/ce/f1/d2fc86bb.jpg","comment_is_top":false,"comment_ctime":1634096317,"is_pvip":false,"replies":[{"id":"115280","content":"å—¯ï¼Œä¸é”™","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635132364,"ip_address":"","comment_id":315992,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634096317","product_id":100085301,"comment_content":"&#47;&#47; hmget<br>    &#47;&#47; åˆ›å»º HGETALL å‘½ä»¤<br>    pub fn new_hmget(table: impl Into&lt;String&gt;, keys: Vec::&lt;impl Into&lt;String&gt; + Copy&gt;) -&gt; Self {<br>        let mut v: Vec::&lt;::prost::alloc::string::String&gt; = Vec::new();<br>        for &amp;i in keys.iter() {<br>            v.push(i.into());<br>        }<br>        &#47;&#47; map æ˜¾ç¤º not reference, why?<br>        &#47;&#47; let a:  Vec::&lt;::prost::alloc::string::String&gt; = keys.iter().map(|&amp;x| x.into()).collect();<br>        Self {<br>            request_data: Some(RequestData::Hmget(Hmget {<br>                table: table.into(),<br>                keys: v<br>            })),<br>        }<br>    }<br><br>impl CommandService for Hmget {<br>    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {<br>        let mut out: Vec::&lt;Kvpair&gt; = Vec::new();<br>        for key in self.keys {<br>            match store.get(&amp;self.table, &amp;key) {<br>                Ok(Some(v)) =&gt; out.push(Kvpair::new(key, v)),<br>                _ =&gt; {}<br>            }<br>        }<br>        return out.into();<br>    }<br>}","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528228,"discussion_content":"å—¯ï¼Œä¸é”™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}