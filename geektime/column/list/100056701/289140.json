{"id":289140,"title":"20 | 删除数据后，为什么内存占用率还是很高？","content":"<p>你好，我是蒋德钧。</p><p>在使用Redis时，我们经常会遇到这样一个问题：明明做了数据删除，数据量已经不大了，为什么使用top命令查看时，还会发现Redis占用了很多内存呢？</p><p>实际上，这是因为，当数据删除后，Redis释放的内存空间会由内存分配器管理，并不会立即返回给操作系统。所以，操作系统仍然会记录着给Redis分配了大量内存。</p><p>但是，这往往会伴随一个潜在的风险点：Redis释放的内存空间可能并不是连续的，那么，这些不连续的内存空间很有可能处于一种闲置的状态。这就会导致一个问题：虽然有空闲空间，Redis却无法用来保存数据，不仅会减少Redis能够实际保存的数据量，还会降低Redis运行机器的成本回报率。</p><p>打个形象的比喻。我们可以把Redis的内存空间比作高铁上的车厢座位数。如果高铁的车厢座位数很多，但运送的乘客数很少，那么，高铁运行一次的效率低，成本高，性价比就会降低，Redis也是一样。如果你正好租用了一台16GB内存的云主机运行Redis，但是却只保存了8GB的数据，那么，你租用这台云主机的成本回报率也会降低一半，这个结果肯定不是你想要的。</p><p>所以，这节课，我就和你聊聊Redis的内存空间存储效率问题，探索一下，为什么数据已经删除了，但内存却闲置着没有用，以及相应的解决方案。</p><!-- [[[read_end]]] --><h2>什么是内存碎片？</h2><p>通常情况下，内存空间闲置，往往是因为操作系统发生了较为严重的内存碎片。那么，什么是内存碎片呢？</p><p>为了方便你理解，我还是借助高铁的车厢座位来进行解释。假设一个车厢的座位总共有60个，现在已经卖了57张票，你和2个小伙伴要乘坐高铁出门旅行，刚好需要三张票。不过，你们想要坐在一起，这样可以在路上聊天。但是，在选座位时，你们却发现，已经买不到连续的座位了。于是，你们只好换了一趟车。这样一来，你们需要改变出行时间，而且这趟车就空置了三个座位。</p><p>其实，这趟车的空座位是和你们的人数相匹配的，只是这些空座位是分散的，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/23/df/23ebc99ff968f2c7edd0f8ddf7def8df.jpg?wh=4000*2250\" alt=\"\"></p><p>我们可以把这些分散的空座位叫作“车厢座位碎片”，知道了这一点，操作系统的内存碎片就很容易理解了。虽然操作系统的剩余内存空间总量足够，但是，应用申请的是一块连续地址空间的N字节，但在剩余的内存空间中，没有大小为N字节的连续空间了，那么，这些剩余空间就是内存碎片（比如上图中的“空闲2字节”和“空闲1字节”，就是这样的碎片）。</p><p>那么，Redis中的内存碎片是什么原因导致的呢？接下来，我带你来具体看一看。我们只有了解了内存碎片的成因，才能对症下药，把Redis占用的内存空间充分利用起来，增加存储的数据量。</p><h2>内存碎片是如何形成的？</h2><p>其实，内存碎片的形成有内因和外因两个层面的原因。简单来说，内因是操作系统的内存分配机制，外因是Redis的负载特征。</p><h3>内因：内存分配器的分配策略</h3><p>内存分配器的分配策略就决定了操作系统无法做到“按需分配”。这是因为，内存分配器一般是按固定大小来分配内存，而不是完全按照应用程序申请的内存空间大小给程序分配。</p><p>Redis可以使用libc、jemalloc、tcmalloc多种内存分配器来分配内存，默认使用jemalloc。接下来，我就以jemalloc为例，来具体解释一下。其他分配器也存在类似的问题。</p><p>jemalloc的分配策略之一，是按照一系列固定的大小划分内存空间，例如8字节、16字节、32字节、48字节，…, 2KB、4KB、8KB等。当程序申请的内存最接近某个固定值时，jemalloc会给它分配相应大小的空间。</p><p>这样的分配方式本身是为了减少分配次数。例如，Redis申请一个20字节的空间保存数据，jemalloc就会分配32字节，此时，如果应用还要写入10字节的数据，Redis就不用再向操作系统申请空间了，因为刚才分配的32字节已经够用了，这就避免了一次分配操作。</p><p>但是，如果Redis每次向分配器申请的内存空间大小不一样，这种分配方式就会有形成碎片的风险，而这正好来源于Redis的外因了。</p><h3>外因：键值对大小不一样和删改操作</h3><p>Redis通常作为共用的缓存系统或键值数据库对外提供服务，所以，不同业务应用的数据都可能保存在Redis中，这就会带来不同大小的键值对。这样一来，Redis申请内存空间分配时，本身就会有大小不一的空间需求。这是第一个外因。</p><p>但是咱们刚刚讲过，内存分配器只能按固定大小分配内存，所以，分配的内存空间一般都会比申请的空间大一些，不会完全一致，这本身就会造成一定的碎片，降低内存空间存储效率。</p><p>比如说，应用A保存6字节数据，jemalloc按分配策略分配8字节。如果应用A不再保存新数据，那么，这里多出来的2字节空间就是内存碎片了，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/46/a5/46d93f2ef50a7f6f91812d0c21ebd6a5.jpg?wh=2318*1031\" alt=\"\"></p><p>第二个外因是，这些键值对会被修改和删除，这会导致空间的扩容和释放。具体来说，一方面，如果修改后的键值对变大或变小了，就需要占用额外的空间或者释放不用的空间。另一方面，删除的键值对就不再需要内存空间了，此时，就会把空间释放出来，形成空闲空间。</p><p>我画了下面这张图来帮助你理解。</p><p><img src=\"https://static001.geekbang.org/resource/image/4d/b8/4d5265c6a38d1839bf4943918f6b6db8.jpg?wh=2483*2094\" alt=\"\"></p><p>一开始，应用A、B、C、D分别保存了3、1、2、4字节的数据，并占据了相应的内存空间。然后，应用D删除了1个字节，这个1字节的内存空间就空出来了。紧接着，应用A修改了数据，从3字节变成了4字节。为了保持A数据的空间连续性，操作系统就需要把B的数据拷贝到别的空间，比如拷贝到D刚刚释放的空间中。此时，应用C和D也分别删除了2字节和1字节的数据，整个内存空间上就分别出现了2字节和1字节的空闲碎片。如果应用E想要一个3字节的连续空间，显然是不能得到满足的。因为，虽然空间总量够，但却是碎片空间，并不是连续的。</p><p>好了，到这里，我们就知道了造成内存碎片的内外因素，其中，内存分配器策略是内因，而Redis的负载属于外因，包括了大小不一的键值对和键值对修改删除带来的内存空间变化。</p><p>大量内存碎片的存在，会造成Redis的内存实际利用率变低，接下来，我们就要来解决这个问题了。不过，在解决问题前，我们要先判断Redis运行过程中是否存在内存碎片。</p><h2>如何判断是否有内存碎片？</h2><p>Redis是内存数据库，内存利用率的高低直接关系到Redis运行效率的高低。为了让用户能监控到实时的内存使用情况，Redis自身提供了INFO命令，可以用来查询内存使用的详细信息，命令如下：</p><pre><code>INFO memory\n# Memory\nused_memory:1073741736\nused_memory_human:1024.00M\nused_memory_rss:1997159792\nused_memory_rss_human:1.86G\n…\nmem_fragmentation_ratio:1.86\n</code></pre><p>这里有一个mem_fragmentation_ratio的指标，它表示的就是Redis当前的内存碎片率。那么，这个碎片率是怎么计算的呢？其实，就是上面的命令中的两个指标used_memory_rss和used_memory相除的结果。</p><pre><code>mem_fragmentation_ratio = used_memory_rss/ used_memory\n</code></pre><p>used_memory_rss是操作系统实际分配给Redis的物理内存空间，里面就包含了碎片；而used_memory是Redis为了保存数据实际申请使用的空间。</p><p>我简单举个例子。例如，Redis申请使用了100字节（used_memory），操作系统实际分配了128字节（used_memory_rss），此时，mem_fragmentation_ratio就是1.28。</p><p>那么，知道了这个指标，我们该如何使用呢？在这儿，我提供一些经验阈值：</p><ul>\n<li><strong>mem_fragmentation_ratio 大于1但小于1.5</strong>。这种情况是合理的。这是因为，刚才我介绍的那些因素是难以避免的。毕竟，内因的内存分配器是一定要使用的，分配策略都是通用的，不会轻易修改；而外因由Redis负载决定，也无法限制。所以，存在内存碎片也是正常的。</li>\n<li><strong>mem_fragmentation_ratio 大于 1.5</strong> 。这表明内存碎片率已经超过了50%。一般情况下，这个时候，我们就需要采取一些措施来降低内存碎片率了。</li>\n</ul><h2>如何清理内存碎片？</h2><p>当Redis发生内存碎片后，一个“简单粗暴”的方法就是<strong>重启Redis实例</strong>。当然，这并不是一个“优雅”的方法，毕竟，重启Redis会带来两个后果：</p><ul>\n<li>如果Redis中的数据没有持久化，那么，数据就会丢失；</li>\n<li>即使Redis数据持久化了，我们还需要通过AOF或RDB进行恢复，恢复时长取决于AOF或RDB的大小，如果只有一个Redis实例，恢复阶段无法提供服务。</li>\n</ul><p>所以，还有什么其他好办法吗?</p><p>幸运的是，从4.0-RC3版本以后，Redis自身提供了一种内存碎片自动清理的方法，我们先来看这个方法的基本机制。</p><p>内存碎片清理，简单来说，就是“搬家让位，合并空间”。</p><p>我还以刚才的高铁车厢选座为例，来解释一下。你和小伙伴不想耽误时间，所以直接买了座位不在一起的三张票。但是，上车后，你和小伙伴通过和别人调换座位，又坐到了一起。</p><p>这么一说，碎片清理的机制就很容易理解了。当有数据把一块连续的内存空间分割成好几块不连续的空间时，操作系统就会把数据拷贝到别处。此时，数据拷贝需要能把这些数据原来占用的空间都空出来，把原本不连续的内存空间变成连续的空间。否则，如果数据拷贝后，并没有形成连续的内存空间，这就不能算是清理了。</p><p>我画一张图来解释一下。</p><p><img src=\"https://static001.geekbang.org/resource/image/64/42/6480b6af5b2423b271ef3fb59f555842.jpg?wh=3223*1543\" alt=\"\"></p><p>在进行碎片清理前，这段10字节的空间中分别有1个2字节和1个1字节的空闲空间，只是这两个空间并不连续。操作系统在清理碎片时，会先把应用D的数据拷贝到2字节的空闲空间中，并释放D原先所占的空间。然后，再把B的数据拷贝到D原来的空间中。这样一来，这段10字节空间的最后三个字节就是一块连续空间了。到这里，碎片清理结束。</p><p>不过，需要注意的是：<strong>碎片清理是有代价的</strong>，操作系统需要把多份数据拷贝到新位置，把原有空间释放出来，这会带来时间开销。因为Redis是单线程，在数据拷贝时，Redis只能等着，这就导致Redis无法及时处理请求，性能就会降低。而且，有的时候，数据拷贝还需要注意顺序，就像刚刚说的清理内存碎片的例子，操作系统需要先拷贝D，并释放D的空间后，才能拷贝B。这种对顺序性的要求，会进一步增加Redis的等待时间，导致性能降低。</p><p>那么，有什么办法可以尽量缓解这个问题吗？这就要提到，Redis专门为自动内存碎片清理功机制设置的参数了。我们可以通过设置参数，来控制碎片清理的开始和结束时机，以及占用的CPU比例，从而减少碎片清理对Redis本身请求处理的性能影响。</p><p>首先，Redis需要启用自动内存碎片清理，可以把activedefrag配置项设置为yes，命令如下：</p><pre><code>config set activedefrag yes\n</code></pre><p>这个命令只是启用了自动清理功能，但是，具体什么时候清理，会受到下面这两个参数的控制。这两个参数分别设置了触发内存清理的一个条件，如果同时满足这两个条件，就开始清理。在清理的过程中，只要有一个条件不满足了，就停止自动清理。</p><ul>\n<li><strong>active-defrag-ignore-bytes 100mb</strong>：表示内存碎片的字节数达到100MB时，开始清理；</li>\n<li><strong>active-defrag-threshold-lower 10</strong>：表示内存碎片空间占操作系统分配给Redis的总空间比例达到10%时，开始清理。</li>\n</ul><p>为了尽可能减少碎片清理对Redis正常请求处理的影响，自动内存碎片清理功能在执行时，还会监控清理操作占用的CPU时间，而且还设置了两个参数，分别用于控制清理操作占用的CPU时间比例的上、下限，既保证清理工作能正常进行，又避免了降低Redis性能。这两个参数具体如下：</p><ul>\n<li><strong>active-defrag-cycle-min 25</strong>： 表示自动清理过程所用CPU时间的比例不低于25%，保证清理能正常开展；</li>\n<li><strong>active-defrag-cycle-max 75</strong>：表示自动清理过程所用CPU时间的比例不高于75%，一旦超过，就停止清理，从而避免在清理时，大量的内存拷贝阻塞Redis，导致响应延迟升高。</li>\n</ul><p>自动内存碎片清理机制在控制碎片清理启停的时机上，既考虑了碎片的空间占比、对Redis内存使用效率的影响，还考虑了清理机制本身的CPU时间占比、对Redis性能的影响。而且，清理机制还提供了4个参数，让我们可以根据实际应用中的数据量需求和性能要求灵活使用，建议你在实践中好好地把这个机制用起来。</p><h2>小结</h2><p>这节课，我和你一起了解了Redis的内存空间效率问题，这里面的一个关键技术点就是要识别和处理内存碎片。简单来说，就是“三个一”：</p><ul>\n<li>info memory命令是一个<strong>好工具</strong>，可以帮助你查看碎片率的情况；</li>\n<li>碎片率阈值是一个<strong>好经验</strong>，可以帮忙你有效地判断是否要进行碎片清理了；</li>\n<li>内存碎片自动清理是一个<strong>好方法</strong>，可以避免因为碎片导致Redis的内存实际利用率降低，提升成本收益率。</li>\n</ul><p>内存碎片并不可怕，我们要做的就是了解它，重视它，并借用高效的方法解决它。</p><p>最后，我再给你提供一个小贴士：内存碎片自动清理涉及内存拷贝，这对Redis而言，是个潜在的风险。如果你在实践过程中遇到Redis性能变慢，记得通过日志看下是否正在进行碎片清理。如果Redis的确正在清理碎片，那么，我建议你调小active-defrag-cycle-max的值，以减轻对正常请求处理的影响。</p><h2>每课一问</h2><p>按照惯例，我给你提一个小问题。在这节课中，我提到，可以使用mem_fragmentation_ratio来判断Redis当前的内存碎片率是否严重，我给出的经验阈值都是大于1的。那么，我想请你来聊一聊，如果mem_fragmentation_ratio小于1了，Redis的内存使用是什么情况呢？会对Redis的性能和内存空间利用率造成什么影响呢？</p><p>欢迎你在留言区写下你的思考和答案，和我一起交流讨论，如果觉得今天的内容对你有所帮助，也欢迎分享给你的朋友或同事，我们下节课见。</p>","comments":[{"had_liked":false,"id":249788,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1600790935,"is_pvip":true,"discussion_count":16,"race_medal":0,"score":"1109702353303","product_id":100056701,"comment_content":"如果 mem_fragmentation_ratio 小于 1 了，Redis 的内存使用是什么情况呢？会对 Redis 的性能和内存空间利用率造成什么影响？<br><br>mem_fragmentation_ratio小于1，说明used_memory_rss小于了used_memory，这意味着操作系统分配给Redis进程的物理内存，要小于Redis实际存储数据的内存，也就是说Redis没有足够的物理内存可以使用了，这会导致Redis一部分内存数据会被换到Swap中，之后当Redis访问Swap中的数据时，延迟会变大，性能下降。<br><br>通过这篇文章了解到，Redis在进行内存碎片整理时，由于是主线程操作的，所以这块也是一个影响Redis性能的风险点。<br><br>其中active-defrag-ignore-bytes和active-defrag-threshold-lower参数主要用于控制达到什么阈值后开始碎片整理，如果配置的碎片大小和碎片率在可接受的范围内，那么Redis不会进行碎片整理，也就不会对Redis产生性能影响。<br><br>而达到设定阈值开始碎片整理后，active-defrag-cycle-min和active-defrag-cycle-max参数则用来控制在这期间，Redis主线程资源使用的上下限，这个需要根据碎片整理的时间、Redis的响应延迟进行权衡，合理配置。<br><br>我个人认为，应该优先保证Redis性能尽量不受影响，让碎片整理期间的资源消耗控制在稳定的范围内，并尽量缩短碎片整理的时间。<br>","like_count":259,"discussions":[{"author":{"id":1312184,"avatar":"https://static001.geekbang.org/account/avatar/00/14/05/b8/8d468842.jpg","nickname":"JulyRemember","note":"","ucode":"9E3D5D60D82999","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308478,"discussion_content":"想问下，我看到默认Redis配置文件里面就是redis.conf,配置项activedefrag是注释的，应该表示默认情况下不开启内存碎片自动清理功能吧","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1600959895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":1312184,"avatar":"https://static001.geekbang.org/account/avatar/00/14/05/b8/8d468842.jpg","nickname":"JulyRemember","note":"","ucode":"9E3D5D60D82999","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309472,"discussion_content":"对的，默认是不开启的。纯利用 操作系统来进行内存回收","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601298521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308478,"ip_address":""},"score":309472,"extra":""}]},{"author":{"id":1087879,"avatar":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","nickname":"dao","note":"","ucode":"4181FB270462CF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":355690,"discussion_content":"我设置了backlog_size=300M，如果数据量较小时，碎片化率是<1的，用free命令查看了swap，没有使用swap，这种情况算是 mem_fragmentation_ratio <1 的一个例外。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615470006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1655940,"avatar":"https://static001.geekbang.org/account/avatar/00/19/44/84/4da14994.jpg","nickname":"呆瓜","note":"","ucode":"C98C7B224D0640","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1087879,"avatar":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","nickname":"dao","note":"","ucode":"4181FB270462CF","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":363028,"discussion_content":"小于1但没有swap是什么情况？？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1617100147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":355690,"ip_address":""},"score":363028,"extra":""}]},{"author":{"id":2053373,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/54/fd/32fbba46.jpg","nickname":"purpletsy","note":"","ucode":"E5C366E9FA7C4F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308915,"discussion_content":"请问maxmemory参数和内存碎片率之间有啥关系么？我的理解是，当redis使用到最大的时候，maxmemory=used_memory，如果这个时候存在碎片，那么used_memory_rss还要大于maxmemory。因此maxmemory限制了redis能够实际存放的最大数据量也就是老师说的乘客数，而used_memory_rss是操作系统分配给redis进程的内存总量也就是座位数，这么理解对么？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601120617,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2053373,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/54/fd/32fbba46.jpg","nickname":"purpletsy","note":"","ucode":"E5C366E9FA7C4F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308916,"discussion_content":"是的。没有直接关系。rss多说明操作系统的内存因为redis碎片被浪费一些而已，对redis没影响。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601120816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308915,"ip_address":""},"score":308916,"extra":""}]},{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307984,"discussion_content":"会不会存在机器内存是够的，但是还是用到了swap，并且碎片率小于1呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600821576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":308002,"discussion_content":"存在，比如NUMA架构一个内存节点不够了，但是其他节点还有内存，有可能依旧使用到了Swap。","likes_number":18,"is_delete":false,"is_hidden":false,"ctime":1600824107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":307984,"ip_address":""},"score":308002,"extra":""},{"author":{"id":1131165,"avatar":"https://static001.geekbang.org/account/avatar/00/11/42/9d/c36b7ef7.jpg","nickname":"顾骨","note":"","ucode":"3F6BA592AB7723","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":547533,"discussion_content":"/proc/sys/vm/swappiness 这个也会有影响，取值0~100，越靠近100，说明匿名内存会被释放并放入交换空间，这时page cache可能还占用大量内存（这些内存其实是可以回收使用的）","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642734564,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308002,"ip_address":""},"score":547533,"extra":""}]},{"author":{"id":1325816,"avatar":"https://static001.geekbang.org/account/avatar/00/14/3a/f8/c1a939e7.jpg","nickname":"君哥聊技术","note":"","ucode":"2C9A22BCE4C79E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307980,"discussion_content":"我也想到了swap,但是大佬的回答更详细","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600820443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1314995,"avatar":"https://static001.geekbang.org/account/avatar/00/14/10/b3/9492c0f3.jpg","nickname":"daoguang","note":"","ucode":"C56DA16DCA2D64","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591827,"discussion_content":"rss&lt;used 也不一定是swap导致，可能是这个：https://github.com/redis/redis/issues/946\n“Hello, in your case used physical memory appears to be smaller than virtual memory but you report no swapped pages. It is likely that in your data set there are many blank pages (all filled with zero) so multiple pages are actually mapped to the same zero page.”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666849931,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"罗杰","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575361,"discussion_content":"我也觉得这个功能有点鸡肋。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654770381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1912942,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/TpXzl8Tkc43nScElZibBJDqQ9mUtrrwBhe53w3RRQ3aD4OKMKS8o93BqdLal9DaTz3XTXibIk7kYhAaLFVibqPnWQ/132","nickname":"Geek_9e7b2d","note":"","ucode":"F34668B03F701F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366893,"discussion_content":"应该还会触发内存淘汰机制，删除大量的key，阻塞主线程。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618213060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2649828,"avatar":"https://static001.geekbang.org/account/avatar/00/28/6e/e4/9901994d.jpg","nickname":"Geek_9bd7ef","note":"","ucode":"E68C656EE1EBAC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1912942,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/TpXzl8Tkc43nScElZibBJDqQ9mUtrrwBhe53w3RRQ3aD4OKMKS8o93BqdLal9DaTz3XTXibIk7kYhAaLFVibqPnWQ/132","nickname":"Geek_9e7b2d","note":"","ucode":"F34668B03F701F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545187,"discussion_content":"swap和删除大量过期key是两回事","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641871257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":366893,"ip_address":""},"score":545187,"extra":""}]},{"author":{"id":2308075,"avatar":"","nickname":"Geek_89e362","note":"","ucode":"E596C2CFE1CFAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348119,"discussion_content":"精辟，到位。想到了但是不如您的详细","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612431570,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1515679,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ZRuGPK9Rmo5icH649EpibcT5XL5zm15H62A0MWsuC3yNWNcke6j5gxF4Q5b6J7GQbOiczMAovceoQObttyP8HEfzQ/132","nickname":"Geek_d1b4e1","note":"","ucode":"349C689216672D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337821,"discussion_content":"大佬  占用CPU时间的比例是怎么算出来的?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609080463,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249810,"user_name":"test","can_delete":false,"product_type":"c1","uid":1065849,"ip_address":"","ucode":"9A4973E591DD12","user_header":"https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg","comment_is_top":false,"comment_ctime":1600821710,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"126154873294","product_id":100056701,"comment_content":"mem_fragmentation_ratio小于1，说明redis内存不够用了，换了一部分到swap中，会严重影响性能。","like_count":29},{"had_liked":false,"id":267172,"user_name":"Geek_b8d5c9","can_delete":false,"product_type":"c1","uid":2261175,"ip_address":"","ucode":"505F33B4C0EA31","user_header":"","comment_is_top":false,"comment_ctime":1607617843,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"78917029171","product_id":100056701,"comment_content":"有点想Java中的垃圾回收算法的标记整理","like_count":18},{"had_liked":false,"id":285499,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1616846035,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"57451420883","product_id":100056701,"comment_content":"数据删除后，Redis 释放的内存空间由内存分配器管理，不会立刻返回给操作系统。<br><br>再加上内存碎片的问题，感觉是因为 Redis 是使用 C 语言实现的，如果是在 JVM 上，内存管理就不会成为棘手的问题了，当然性能上 JVM 比起 C 语言来还是有不少劣势。<br><br>其实 Redis 清理内存碎片的方式和 JVM 的内存管理也很类似。<br><br>active-defrag-ignore-bytes、active-defrag-threshold-lower、active-defrag-cycle-min、active-defrag-cycle-max 是 4 个和 Redis 内存碎片清理机制有关的参数，而 100mb、10、25、75 应该是老师给出的参考值或者是最佳实践吧。<br><br>如果 mem_fragmentation_ratio 小于 1，那么我来猜测一下，如果小于 0.5 感觉内存的利用率比较低，内存的 ROI 太低，可以考虑减少给 Redis 分配的内存；而在 0.5 ~ 1 之间的话，感觉应该是比较合适的，但是也有可能会有太多的碎片需要整理。<br><br>看了课代表的回答，惭愧的发现，我完全搞反了 used_memory_rss 和 used_memory 的含义，其中 rss 表示 resident set size<br><br>used_memory: Total number of bytes allocated by Redis using its allocator (either standard libc, jemalloc, or an alternative allocator such as tcmalloc)<br>used_memory_rss: Number of bytes that Redis allocated as seen by the operation system (a.k.a resident set size).<br><br>Ideally, the used_memory_rss value should be only slightly higher than used_momory. When rss &gt;&gt; used, a large difference means there is memory fragmentation... When used &gt;&gt; rss, it means part of Redis memory has been swapped off by the operating system: expect some significant latencies.<br><br>在留言里没有看到老师的身影（“作者回复”），爱总结的非凡哥也不见了，只有课代表还在。","like_count":13},{"had_liked":false,"id":267982,"user_name":"IT小僧","can_delete":false,"product_type":"c1","uid":1036906,"ip_address":"","ucode":"4DC9B291AAD748","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d2/6a/a9039139.jpg","comment_is_top":false,"comment_ctime":1608019026,"is_pvip":true,"discussion_count":4,"race_medal":0,"score":"53147626578","product_id":100056701,"comment_content":"小于1不一定是发生了swap 也有可能是因为内存空白页导致的，前者会影响性能，后者不会。","like_count":12,"discussions":[{"author":{"id":2055993,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/5f/39/8d2c61d3.jpg","nickname":"Kiddy","note":"","ucode":"D07AAEE69BE504","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":403488,"discussion_content":"请问下什么是内存空白页，是指的文件IO脏页写完了的buff/cache里面的页面吗？ ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634089789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2311524,"avatar":"","nickname":"朴2","note":"","ucode":"A858076523A6AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363978,"discussion_content":"遇到过这个实例，碎片率是0.96.反复查验后，结果正常","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617338516,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2055993,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/5f/39/8d2c61d3.jpg","nickname":"Kiddy","note":"","ucode":"D07AAEE69BE504","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2311524,"avatar":"","nickname":"朴2","note":"","ucode":"A858076523A6AB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":403489,"discussion_content":"请问下什么是内存空白页，是指的文件IO脏页写完了的buff/cache里面的页面吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634089805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":363978,"ip_address":""},"score":403489,"extra":""}]},{"author":{"id":2622364,"avatar":"https://static001.geekbang.org/account/avatar/00/28/03/9c/5a0b8825.jpg","nickname":"Bin Watson","note":"","ucode":"33E3487896E859","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547988,"discussion_content":"空白页是啥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642989627,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250131,"user_name":"树斌","can_delete":false,"product_type":"c1","uid":1032894,"ip_address":"","ucode":"37D4121ABEAC19","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c2/be/314c5488.jpg","comment_is_top":false,"comment_ctime":1600944135,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"53140551687","product_id":100056701,"comment_content":"实际案例，redis-cluster三主三从，检查所有节点的内存碎片率均小于1，在0.7-0.9之间，used_memory基本每个节点都只有12m左右，但是检查swap确认是没有虚拟内存交换的，不知道这种情况作何解释？一直没闹明白","like_count":12,"discussions":[{"author":{"id":1635325,"avatar":"https://static001.geekbang.org/account/avatar/00/18/f3/fd/20cb61a8.jpg","nickname":"橙子乐","note":"","ucode":"CA72E9911EC614","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320467,"discussion_content":"我在实际情况下也出现了这种情况，并将此case在redis社区进行过提问，目前得到的答复是没有影响，但是具体原因目前也不清楚。猜想是否是因为实例启动后分配器分配一定大小的内存空间没进行写入所以操作系统实际上并没给此分配空间映射任何页面导致的初始阶段RSS小于实际used,且通过批量往节点中增加数据,内存碎片率会升高至1之上。\n 难得碰见同问题的小伙伴，老师能回复下就好了。","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1604374115,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1087879,"avatar":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","nickname":"dao","note":"","ucode":"4181FB270462CF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":355701,"discussion_content":"你这个可能和我的情况类似，检查一下 repl-backlog-size 设置","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615470383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1506609,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/q2HwchogzNiavKhIB4GfAxH6B88NhSoC7B7keVEUqiaP6JPokDUNJLYehocOyqYqrhA3iaxywyRXLYkYJjDUQESZw/132","nickname":"残天噬魂","note":"","ucode":"A2AD8303A4518D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371532,"discussion_content":"顶上去","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619830933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113737,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2icbib62icXtibTkThtyRksbuJLoTLMts7zook2S30MiaBtbz0f5JskwYicwqXkhpYfvCpuYkcvPTibEaQ/132","nickname":"xuanyuan","note":"","ucode":"1EC79B9372868F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339344,"discussion_content":"顶上去，求老师解答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609642234,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295105,"user_name":"悟空聊架构","can_delete":false,"product_type":"c1","uid":1123163,"ip_address":"","ucode":"C2F482A0CF8AF1","user_header":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","comment_is_top":false,"comment_ctime":1622245879,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"35981984247","product_id":100056701,"comment_content":"课后问题：<br><br>如果 mem_fragmentation_ratio 小于 1 了，Redis 的内存使用是什么情况呢？会对 Redis 的性能和内存空间利用率造成什么影响呢？<br><br>mem_fragmentation_ratio = used_memory_rss &#47; used_memory &lt; 1 ，<br><br>说明操作系统分配给Redis进程的物理内存 &lt; Redis实际存储数据的内存。<br><br>原因和影响：<br><br>1.Redis 没有申请到足够的物理内存<br>2.Redis 的一部分内存数据会被换到 Swap 中<br>3.Redis访问 swap 中的数据时，相当于与磁盘进行交互，访问慢，性能下降。<br><br>swap 是什么？<br><br>内存 swap 是操作系统里将内存数据在内存和磁盘间来回换入和换出的机制，涉及到磁盘的读写。一旦出发 swap，性能会收到慢速磁盘读写的影响。<br>Redis 实例自身使用了大量的内存，导致物理机器的可用内存不足。<br>和 Redis 实例在同一台机器上运行的其他进程，在进行大量的文件读写操作，文件读写本身会占用系统，导致分配给 Redis 实例的内存量变少，进而出发 Redis 发生 swap。<br><br>如何识别和处理 Redis 内存碎片<br><br>info memory 命令是一个好工具，可以帮助你查看碎片率的情况；<br>  INFO memory<br>碎片率阈值是一个好经验，可以帮忙你有效地判断是否要进行碎片清理了；<br>  mem_fragmentation_ratio = used_memory_rss&#47; used_memory<br>  used_memory_rss 是操作系统实际分配给 Redis 的物理内存空间，里面就包含了碎片；<br>  used_memory 是 Redis 为了保存数据实际申请使用的空间<br><br>内存碎片自动清理是一个好方法，可以避免因为碎片导致 Redis 的内存实际利用率降低，提升成本收益率。<br>  config set activedefrag yes<br>  active-defrag-ignore-bytes 100mb：表示内存碎片的字节数达到 100MB 时，开始清理；<br>  ​active-defrag-threshold-lower 10：表示内存碎片空间占操作系统分配给 Redis 的总空间比例达到 10% 时，开始清理。（第一个和第二个需要同时满足才会开始清理）<br>  active-defrag-cycle-min 25： 表示自动清理过程所用 CPU 时间的比例不低于 25%，保证清理能正常开展；<br>  active-defrag-cycle-max 75：表示自动清理过程所用 CPU 时间的比例不高于 75%，一旦超过，就停止清理，从而避免在清理时，大量的内存拷贝阻塞 Redis，导致响应延迟升高。","like_count":8,"discussions":[{"author":{"id":1488020,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","nickname":"追风筝的人","note":"","ucode":"2993D60F94C396","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535339,"discussion_content":"redis 内存使用率 CPU使用率怎么计算？  info 打印的信息没有百分比数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638415471,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":260637,"user_name":"数学汤家凤","can_delete":false,"product_type":"c1","uid":2029485,"ip_address":"","ucode":"DE84E777C384AD","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f7/ad/4fd4d867.jpg","comment_is_top":false,"comment_ctime":1605075929,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"27374879705","product_id":100056701,"comment_content":"内存分配向上取整导致的内部碎片<br>内存反复分配回收导致的外部碎片<br>解决方法移动，什么时候移动？碎片太多且CPU不忙时移动","like_count":6,"discussions":[{"author":{"id":2184325,"avatar":"https://static001.geekbang.org/account/avatar/00/21/54/85/ab5148ce.jpg","nickname":"duckman","note":"","ucode":"0184C26C4B6C1B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329849,"discussion_content":"总结很到位","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606467766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250652,"user_name":"小西几","can_delete":false,"product_type":"c1","uid":1286375,"ip_address":"","ucode":"ED1DDE17534508","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJjzTQ6HPGw2LWLiaiciaibfdMMlmxEwBkBjxOPxeYynZlBKCf6U1b0ezM9IZYibB6yKR7HpRuAOdtj29Q/132","comment_is_top":false,"comment_ctime":1601187166,"is_pvip":false,"discussion_count":10,"race_medal":0,"score":"27370990942","product_id":100056701,"comment_content":"启用碎片整理的时候报错<br><br>127.0.0.1:6379&gt; CONFIG SET activedefrag yes<br>(error) DISABLED Active defragmentation cannot be enabled: it requires a Redis server compiled with a modified Jemalloc like the one shipped by default with the Redis<br>source distribution<br><br>此时碎片率已经达到4.28,并且redis 还没有启用持久化， 其他数据：<br>used_memory:3304902272<br>used_memory_human:3.08G<br>used_memory_rss:14155644928<br>used_memory_rss_human:13.18G<br>used_memory_peak:5176474576<br>used_memory_peak_human:4.82G<br><br><br>请问老师，我该怎么执行碎片整理。这是生产环境，比较重要。因为内存马上不够用了。","like_count":6,"discussions":[{"author":{"id":1203114,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5b/aa/777d7f88.jpg","nickname":"谁谁","note":"","ucode":"9651913B7B7ECC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331192,"discussion_content":"操作系统分配给redis13G多，使用了3G多，不是还有10多G空余吗？为啥快不够了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606802721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2452377,"avatar":"","nickname":"朱庆龙","note":"","ucode":"9E0F5B2AA013AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1203114,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5b/aa/777d7f88.jpg","nickname":"谁谁","note":"","ucode":"9651913B7B7ECC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360343,"discussion_content":"因为mem_fragmentation_ratio已经达到了4.28","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616421312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":331192,"ip_address":""},"score":360343,"extra":""},{"author":{"id":1024294,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","nickname":"null","note":"","ucode":"F9039EFED6B55D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1203114,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5b/aa/777d7f88.jpg","nickname":"谁谁","note":"","ucode":"9651913B7B7ECC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375896,"discussion_content":"当程序申请的内存最接近某个固定值时，jemalloc 会给它分配相应大小的空间。按需分配。比如申请 10B，分配 16B；申请20B，分配 32B，这样 used_memory_rss/used_memory 才有意义。而不是一次性把所有内存分配，否则一开始就分配 13G，只使用 13M，相除的结果就大得离谱。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621860772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":331192,"ip_address":""},"score":375896,"extra":""}]},{"author":{"id":1899435,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/fb/ab/c0c29cda.jpg","nickname":"王世艺","note":"","ucode":"04DA844568766B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309313,"discussion_content":"主从切换后安全重启节点，并升级实例到高版本支持在线收集碎片","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601256551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1286375,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJjzTQ6HPGw2LWLiaiciaibfdMMlmxEwBkBjxOPxeYynZlBKCf6U1b0ezM9IZYibB6yKR7HpRuAOdtj29Q/132","nickname":"小西几","note":"","ucode":"ED1DDE17534508","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1899435,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/fb/ab/c0c29cda.jpg","nickname":"王世艺","note":"","ucode":"04DA844568766B","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":309364,"discussion_content":"没有从节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601270898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":309313,"ip_address":""},"score":309364,"extra":""},{"author":{"id":1388092,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2e/3c/eae43616.jpg","nickname":"sid","note":"","ucode":"3D1F9169A19D29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1286375,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJjzTQ6HPGw2LWLiaiciaibfdMMlmxEwBkBjxOPxeYynZlBKCf6U1b0ezM9IZYibB6yKR7HpRuAOdtj29Q/132","nickname":"小西几","note":"","ucode":"ED1DDE17534508","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311286,"discussion_content":"晚上流量少的时候操作下。\n停掉Redis的流量，RDB保存下，重启Redis","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1602297743,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":309364,"ip_address":""},"score":311286,"extra":""}]},{"author":{"id":1132448,"avatar":"https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg","nickname":"Sam.张朝","note":"","ucode":"FB20554D94B250","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534327,"discussion_content":"windows docker radio 达到15,","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638163758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1087879,"avatar":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","nickname":"dao","note":"","ucode":"4181FB270462CF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":355699,"discussion_content":"从节点可以随时增加上去的，也建议升级一下redis 的版本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615470227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1998835,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/7f/f3/010d9634.jpg","nickname":"Owen Zhang","note":"","ucode":"48D2063B87AD8F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":343657,"discussion_content":"大兄弟 解决了 麻烦@下我， 我来看下，哈哈哈，麻烦谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611125307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2313353,"avatar":"https://static001.geekbang.org/account/avatar/00/23/4c/89/82a3ee04.jpg","nickname":"going","note":"","ucode":"3AA83F9B07BE8B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342506,"discussion_content":"好家伙，这碎片是怎么弄到这么多的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610701509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":252137,"user_name":"dfuru","can_delete":false,"product_type":"c1","uid":2110772,"ip_address":"","ucode":"0222FADA093D95","user_header":"","comment_is_top":false,"comment_ctime":1602142146,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18782011330","product_id":100056701,"comment_content":"分配的物理空间小于申请的空间，发生swap，严重降低读写性能","like_count":4},{"had_liked":false,"id":261446,"user_name":"yyl","can_delete":false,"product_type":"c1","uid":1170843,"ip_address":"","ucode":"1741DACDFCA9AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/dd/9b/0bc44a78.jpg","comment_is_top":false,"comment_ctime":1605339890,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14490241778","product_id":100056701,"comment_content":"mem_fragmentation_ratio 小于 1 ，是什么意思呢？<br>分配给Redis的内存，小于Redis申请的内存大小。假设系统只有4GB，没有其它进程与Redis抢夺物理内存资源。按照提问，Redis实际申请了8G内存，系统最多只能分配给其 4GB，其余的只能通过swap置换至磁盘了，此时Redis性能快速下降","like_count":3},{"had_liked":false,"id":249862,"user_name":"可怜大灰狼","can_delete":false,"product_type":"c1","uid":1928373,"ip_address":"","ucode":"6CA9D6D460B967","user_header":"https://static001.geekbang.org/account/avatar/00/1d/6c/b5/32374f93.jpg","comment_is_top":false,"comment_ctime":1600832598,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"14485734486","product_id":100056701,"comment_content":"老师您好，4.0-RC3 版本之前没有自动清理，是不是只能重启服务？","like_count":3,"discussions":[{"author":{"id":1107772,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e7/3c/366c15ca.jpg","nickname":"浪里个狼","note":"","ucode":"2085BB3632DCAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310937,"discussion_content":"MEMORY PURGE  可以整理内存，耗时小","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1602146783,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249820,"user_name":"青青子衿","can_delete":false,"product_type":"c1","uid":1438102,"ip_address":"","ucode":"4A388A3BA70C29","user_header":"https://static001.geekbang.org/account/avatar/00/15/f1/96/9571fa3d.jpg","comment_is_top":false,"comment_ctime":1600822926,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14485724814","product_id":100056701,"comment_content":"这篇写的很好，感觉受益不小","like_count":3},{"had_liked":false,"id":315676,"user_name":"日落黄昏下","can_delete":false,"product_type":"c1","uid":1464032,"ip_address":"","ucode":"A97725B81D86BC","user_header":"https://static001.geekbang.org/account/avatar/00/16/56/e0/d34f57b3.jpg","comment_is_top":false,"comment_ctime":1633942489,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10223877081","product_id":100056701,"comment_content":"刚建的redis实例的内存碎片率一般会小于1，这个时候并没有数据占用内存，但是会创建复制积压缓冲区，由于此时并没有使用，操作系统并没有真正把内存分配给redis而redis是有记录这个内存的，所以造成了内存碎片率小于1","like_count":2},{"had_liked":false,"id":310143,"user_name":"Mousse","can_delete":false,"product_type":"c1","uid":2734363,"ip_address":"","ucode":"E604B66327EFF9","user_header":"https://static001.geekbang.org/account/avatar/00/29/b9/1b/19121fbf.jpg","comment_is_top":false,"comment_ctime":1630500727,"is_pvip":false,"discussion_count":1,"race_medal":1,"score":"10220435319","product_id":100056701,"comment_content":"蒋老师你好，文中你说redis的内存分配器有： libc、jemalloc、tcmalloc 。默认jemalloc。<br><br>我在我本地redis使用redis-server -v<br><br>得到：Redis server v=6.2.5 sha=00000000:0 malloc=libc bits=64 build=967e5ebd0d817150<br><br>这个是不是代表内存分配器使用了 libc？<br><br>这样导致我在redis.conf中设置activedefrag yes的时候就报错“ &#39;activedefrag yes&#39;<br>Active defragmentation cannot be enabled: it requires a Redis server compiled with a modified Jemalloc like the one shipped by default with the Redis source distribution<br>”<br><br>请问老师这是不是内存分配器的问题，如果是的话，如何切换？感谢","like_count":2,"discussions":[{"author":{"id":2734363,"avatar":"https://static001.geekbang.org/account/avatar/00/29/b9/1b/19121fbf.jpg","nickname":"Mousse","note":"","ucode":"E604B66327EFF9","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391566,"discussion_content":"我自己解决了，因为是mac，所以编译的时候需要补充","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630513575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309272,"user_name":"andy","can_delete":false,"product_type":"c1","uid":1154153,"ip_address":"","ucode":"66FA6DABD5BD3B","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/69/d16ea710.jpg","comment_is_top":false,"comment_ctime":1630028206,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10219962798","product_id":100056701,"comment_content":"删除数据后为什么内存没有变少。因为我们虽然删除了redis中的数据但是redis所占用的内存不一定被释放。我们在申请内存的时候申请28b会给32b。这样的好处是可以减少频繁申请内存的开销，坏处是造成了一定的内存浪费。回到redis中因为会有很多个不同的键值对在不同的时间申请了内存，且数据大小不一致，导致了他们所占用的内存是不连续的，且大小不一致的。这个时候我们删除了其中的一个数据，可能他是32b中的3b这个内存空间还有29b在使用所以它不会被释放。这也就造成了删除了数据但是内存没有变化的情况。<br>出现这个问题我们该如何处理呢？<br>1。  通过info  memory 观察对应的指标看是否内存碎片过高。<br>2。碎片清理两个办法 重启实例和修改配置项让其可以自动清理","like_count":2},{"had_liked":false,"id":305753,"user_name":"走路顺拐","can_delete":false,"product_type":"c1","uid":1987040,"ip_address":"","ucode":"82D19A53DCB14E","user_header":"","comment_is_top":false,"comment_ctime":1628150222,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10218084814","product_id":100056701,"comment_content":"redis碎片清理 是主线程还是子线程","like_count":2,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406193,"discussion_content":"主线程","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634719084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253536,"user_name":"Geek_d61308","can_delete":false,"product_type":"c1","uid":2109103,"ip_address":"","ucode":"FDEE38E49EAE54","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI6nskCoqMibz98cHQIqTSotVeLd6Hzwk6rPG60yrwBgkCibfzB5Yu7Vw1ic6iaxo9P3RoBZcZo37kZXQ/132","comment_is_top":false,"comment_ctime":1602770110,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10192704702","product_id":100056701,"comment_content":"请求老师，文中说redis清理碎片时，会阻塞请求处理，是把所有碎片清理一遍后，在继续处理请求？还是边清理碎片，边处理请求？","like_count":2,"discussions":[{"author":{"id":1649057,"avatar":"https://static001.geekbang.org/account/avatar/00/19/29/a1/41607383.jpg","nickname":"hello","note":"","ucode":"4F42DAA5DB5C38","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325394,"discussion_content":"既然有参数设置，当然是边清理边处理请求，文中也有说明。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1605284176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352759,"user_name":"A 拽丫头","can_delete":false,"product_type":"c1","uid":1470434,"ip_address":"","ucode":"F875D99D18DF6E","user_header":"https://static001.geekbang.org/account/avatar/00/16/6f/e2/f3b05833.jpg","comment_is_top":false,"comment_ctime":1658916188,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5953883484","product_id":100056701,"comment_content":"有点像 mysql  数据删除了，但是数据文件大小还没变化  的原理","like_count":1,"discussions":[{"author":{"id":1811277,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a3/4d/59390ba9.jpg","nickname":"排骨","note":"","ucode":"A413CF46211E1F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583443,"discussion_content":"是差不多，mysql是标记删除,给下次复用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660121460,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"中国香港"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":328034,"user_name":"Mars","can_delete":false,"product_type":"c1","uid":1103640,"ip_address":"","ucode":"65DF3E2EC194FA","user_header":"https://static001.geekbang.org/account/avatar/00/10/d7/18/0d1447db.jpg","comment_is_top":false,"comment_ctime":1640493247,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5935460543","product_id":100056701,"comment_content":"记得通过日志看下是否正在进行碎片清理，请问老师，是通过什么命令来查看正在进行碎片清理？","like_count":1},{"had_liked":false,"id":307012,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1628825394,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5923792690","product_id":100056701,"comment_content":"首先说,是由于Swap机制导致的,这种情况下,访问已经被保存在硬盘的数据时候,会需要发生置换反应,导致降低Redis效率","like_count":1},{"had_liked":false,"id":302726,"user_name":"shawnloong","can_delete":false,"product_type":"c1","uid":1206705,"ip_address":"","ucode":"78EEB9804A1B2D","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/b1/88898e6d.jpg","comment_is_top":false,"comment_ctime":1626346791,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5921314087","product_id":100056701,"comment_content":"redis 生产环境发现从节点比主节点内存高，而且从节点无业务","like_count":1},{"had_liked":false,"id":296964,"user_name":"Welliam.Cao","can_delete":false,"product_type":"c1","uid":1046638,"ip_address":"","ucode":"D6B79E7A32E8E1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/6e/4023d2e6.jpg","comment_is_top":false,"comment_ctime":1623242427,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5918209723","product_id":100056701,"comment_content":"127.0.0.1:7009&gt; memory malloc-stats<br><br>Allocated: 1820983416, active: 1822642176, metadata: 2769523072, resident: 4816531456, mapped: 108743622656<br><br>发现mapped占用100多G的内存，请问这个是什么原因造成的呢？","like_count":1},{"had_liked":false,"id":271116,"user_name":"心动","can_delete":false,"product_type":"c1","uid":1239268,"ip_address":"","ucode":"4024B7EC525BC1","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/e4/ea6b9015.jpg","comment_is_top":false,"comment_ctime":1609403182,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5904370478","product_id":100056701,"comment_content":"当内存碎片率超过1.5时，碎片大概占已分配内存的33.3%","like_count":1},{"had_liked":false,"id":360130,"user_name":"长江大桥上的女子","can_delete":false,"product_type":"c1","uid":2030373,"ip_address":"上海","ucode":"08EC64B252C02F","user_header":"https://static001.geekbang.org/account/avatar/00/1e/fb/25/358e8497.jpg","comment_is_top":false,"comment_ctime":1666193355,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666193355","product_id":100056701,"comment_content":"http:&#47;&#47;gk.link&#47;a&#47;11GoN","like_count":0},{"had_liked":false,"id":354464,"user_name":"Geek_b14c55","can_delete":false,"product_type":"c1","uid":2027632,"ip_address":"浙江","ucode":"C98EAEC045F13D","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/MOuCWWOnoQjOr8KjicQ84R7xu6DRcfDv3VAuHseGJ1gxXicKJboA24vOcrcJickTJPwFAU38VuwCGGkGq7f8WkTIg/132","comment_is_top":false,"comment_ctime":1660444792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660444792","product_id":100056701,"comment_content":"小于1，表示，物理机分配给redis的内存，小于redis实际存储的容量，会把多出来的数据放入swap中，回严重降低性能","like_count":0},{"had_liked":false,"id":348985,"user_name":"笑地","can_delete":false,"product_type":"c1","uid":1103478,"ip_address":"","ucode":"2CD6F5BCAAC2C8","user_header":"https://static001.geekbang.org/account/avatar/00/10/d6/76/be6fc02e.jpg","comment_is_top":false,"comment_ctime":1655623308,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655623308","product_id":100056701,"comment_content":"有没有手动清理内存碎片得方法，自动清理影响生产环境","like_count":0},{"had_liked":false,"id":341823,"user_name":"李二木","can_delete":false,"product_type":"c1","uid":1103091,"ip_address":"","ucode":"30E03BB84ADB27","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg","comment_is_top":false,"comment_ctime":1649847679,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649847679","product_id":100056701,"comment_content":"可以手动选个空闲时间进行内存碎片整理吗？","like_count":0},{"had_liked":false,"id":340014,"user_name":"Leo","can_delete":false,"product_type":"c1","uid":2649276,"ip_address":"","ucode":"CEBAD9CDCFC2A3","user_header":"https://static001.geekbang.org/account/avatar/00/28/6c/bc/f751786b.jpg","comment_is_top":false,"comment_ctime":1648538989,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648538989","product_id":100056701,"comment_content":"课后问题回答：当mem_fragmentation_ratio 小于 1 了，说明内存不够了，那么会使用swap机制，将一部分内存中的数据保存到磁盘；所以当访问到这部分磁盘数据，将会严重影响到redis性能；","like_count":0},{"had_liked":false,"id":339858,"user_name":"张潇赟","can_delete":false,"product_type":"c1","uid":1132192,"ip_address":"","ucode":"1A45B57F9E0723","user_header":"https://static001.geekbang.org/account/avatar/00/11/46/a0/aa6d4ecd.jpg","comment_is_top":false,"comment_ctime":1648438395,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648438395","product_id":100056701,"comment_content":"小于1，应该是一件恐怖的事情。物理内存不够用，分配的小于申请的。有可能一件在使用swap了。","like_count":0},{"had_liked":false,"id":324399,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638415523,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638415523","product_id":100056701,"comment_content":"老师    redis 内存使用率 CPU使用率怎么计算？  info 打印的信息没有百分比数据<br>","like_count":0},{"had_liked":false,"id":291743,"user_name":"吴书勇","can_delete":false,"product_type":"c1","uid":2608193,"ip_address":"","ucode":"89BACDC8797AE3","user_header":"https://static001.geekbang.org/account/avatar/00/27/cc/41/c5c3a1df.jpg","comment_is_top":false,"comment_ctime":1620458301,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620458301","product_id":100056701,"comment_content":"Redis如果不启用内存碎片自动回收，那内存碎片是怎么回收的？难道只能重启？","like_count":0},{"had_liked":false,"id":290675,"user_name":"听风","can_delete":false,"product_type":"c1","uid":1276183,"ip_address":"","ucode":"D0DAA9209C5DF5","user_header":"https://static001.geekbang.org/account/avatar/00/13/79/17/5cf39369.jpg","comment_is_top":false,"comment_ctime":1619683882,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1619683882","product_id":100056701,"comment_content":"老师，请问下，我在mac系统上新开启一个redis单实例服务，没有任何key，在info命令中，查看mem_fragmentation_ratio 参数，值远大于1，请问下存在的原因会有什么点呢？<br><br>127.0.0.1:6379&gt; keys *<br>(empty array)<br>127.0.0.1:6379&gt; info memory<br># Memory<br>used_memory:1064576<br>used_memory_human:1.02M<br>used_memory_rss:2400256<br>used_memory_rss_human:2.29M<br>used_memory_peak:1123120<br>used_memory_peak_human:1.07M<br>used_memory_peak_perc:94.79%<br>used_memory_overhead:1018976<br>used_memory_startup:1001536<br>used_memory_dataset:45600<br>used_memory_dataset_perc:72.34%<br>allocator_allocated:1019456<br>allocator_active:2362368<br>allocator_resident:2362368<br>total_system_memory:17179869184<br>total_system_memory_human:16.00G<br>used_memory_lua:37888<br>used_memory_lua_human:37.00K<br>used_memory_scripts:0<br>used_memory_scripts_human:0B<br>number_of_cached_scripts:0<br>maxmemory:0<br>maxmemory_human:0B<br>maxmemory_policy:noeviction<br>allocator_frag_ratio:2.32<br>allocator_frag_bytes:1342912<br>allocator_rss_ratio:1.00<br>allocator_rss_bytes:0<br>rss_overhead_ratio:1.02<br>rss_overhead_bytes:37888<br>mem_fragmentation_ratio:2.35<br>mem_fragmentation_bytes:1380800<br>mem_not_counted_for_evict:0<br>mem_replication_backlog:0<br>mem_clients_slaves:0<br>mem_clients_normal:17440<br>mem_aof_buffer:0<br>mem_allocator:libc<br>active_defrag_running:0<br>lazyfree_pending_objects:0<br>127.0.0.1:6379&gt;","like_count":0,"discussions":[{"author":{"id":1102245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/a5/2bbedc3b.jpg","nickname":"over","note":"","ucode":"FE272AC19842D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382732,"discussion_content":"碎片太多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625708284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290673,"user_name":"听风","can_delete":false,"product_type":"c1","uid":1276183,"ip_address":"","ucode":"D0DAA9209C5DF5","user_header":"https://static001.geekbang.org/account/avatar/00/13/79/17/5cf39369.jpg","comment_is_top":false,"comment_ctime":1619682832,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619682832","product_id":100056701,"comment_content":"请问如何查看自动内存碎片是否开启？默认的4个参数值是多少？","like_count":0},{"had_liked":false,"id":289703,"user_name":"老大不小","can_delete":false,"product_type":"c1","uid":1295609,"ip_address":"","ucode":"35BCDD3CB13467","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJRFRX8kNzNet7FibNvtavbVpAwK09AhIhrib9k762qWtH6mre8ickP7hM5mgZC4ytr8NnmIfmAhxMSQ/132","comment_is_top":false,"comment_ctime":1619147459,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619147459","product_id":100056701,"comment_content":"看评论区，大家都知道答案，昨天学习了swap，今天却想不到这点，没有学到位。","like_count":0},{"had_liked":false,"id":283882,"user_name":"轨迹","can_delete":false,"product_type":"c1","uid":1738455,"ip_address":"","ucode":"6C9619A0B60CDD","user_header":"https://static001.geekbang.org/account/avatar/00/1a/86/d7/bfd9e42a.jpg","comment_is_top":false,"comment_ctime":1615971447,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615971447","product_id":100056701,"comment_content":"如果Redis一直不开启内存自动清理，内存碎片问题会怎么处理呢？","like_count":0},{"had_liked":false,"id":277383,"user_name":"William","can_delete":false,"product_type":"c1","uid":1346215,"ip_address":"","ucode":"55F5D9DEE485B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg","comment_is_top":false,"comment_ctime":1612402681,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1612402681","product_id":100056701,"comment_content":"active-defrag-cycle-min 25： 表示自动清理过程所用 CPU 时间的比例不低于 25%，保证清理能正常开展；<br>active-defrag-cycle-max 75：表示自动清理过程所用 CPU 时间的比例不高于 75%，一旦超过，就停止清理，从而避免在清理时，大量的内存拷贝阻塞 Redis，导致响应延迟升高。<br><br><br>请问这个比例是怎么算出来的呀？ ","like_count":0,"discussions":[{"author":{"id":2308075,"avatar":"","nickname":"Geek_89e362","note":"","ucode":"E596C2CFE1CFAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348120,"discussion_content":"这应该是个经验值，或者建议值，具体的配置可以根据自己服务器的配置及性能调整","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612431614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1346215,"avatar":"https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg","nickname":"William","note":"","ucode":"55F5D9DEE485B1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2308075,"avatar":"","nickname":"Geek_89e362","note":"","ucode":"E596C2CFE1CFAF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":353300,"discussion_content":"多谢 答疑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615122780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":348120,"ip_address":""},"score":353300,"extra":""}]}]},{"had_liked":false,"id":276193,"user_name":"大壮","can_delete":false,"product_type":"c1","uid":1811115,"ip_address":"","ucode":"A7BC5B78186044","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a2/ab/6533b670.jpg","comment_is_top":false,"comment_ctime":1611826627,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611826627","product_id":100056701,"comment_content":"目前为止看到的最棒的Redis技术分享，真正的结合实际案例，深入浅出！点赞作者！","like_count":0},{"had_liked":false,"id":271109,"user_name":"心动","can_delete":false,"product_type":"c1","uid":1239268,"ip_address":"","ucode":"4024B7EC525BC1","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/e4/ea6b9015.jpg","comment_is_top":false,"comment_ctime":1609402089,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609402089","product_id":100056701,"comment_content":"libc、jemalloc、tcmalloc三种内存分配器有何区别，性能如何，如何切换？","like_count":0},{"had_liked":false,"id":270356,"user_name":"Geek_d1b4e1","can_delete":false,"product_type":"c1","uid":1515679,"ip_address":"","ucode":"349C689216672D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ZRuGPK9Rmo5icH649EpibcT5XL5zm15H62A0MWsuC3yNWNcke6j5gxF4Q5b6J7GQbOiczMAovceoQObttyP8HEfzQ/132","comment_is_top":false,"comment_ctime":1609079626,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1609079626","product_id":100056701,"comment_content":"占用CPU时间的比例是怎么算出来的？","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406183,"discussion_content":"有公式，会根据内存碎片率、配置的各种阈值参数（其中包括文中提到的那些）计算出一个cpu占用比例","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634718014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":266531,"user_name":"黄干","can_delete":false,"product_type":"c1","uid":1237020,"ip_address":"","ucode":"6F408EFAA2DFFE","user_header":"https://static001.geekbang.org/account/avatar/00/12/e0/1c/7093ea15.jpg","comment_is_top":false,"comment_ctime":1607387607,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1607387607","product_id":100056701,"comment_content":"能不能手动清理","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406180,"discussion_content":"memory purge命令可以手动清理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634717928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2008270,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSxhIHPOR2umRMicff8CYjeiamOhltQclqe29nRX1NxtpQzhIauXc9wppzIaXiaIHA0KHvMSG8nxWIQ/132","nickname":"javago","note":"","ucode":"077FC65D93A287","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332983,"discussion_content":"system.gc() ?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607408191,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265630,"user_name":"范闲","can_delete":false,"product_type":"c1","uid":1073125,"ip_address":"","ucode":"F21FD7DF6BA53C","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg","comment_is_top":false,"comment_ctime":1606964708,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606964708","product_id":100056701,"comment_content":"mem_fragmentation_ratio小于1说明redis分配到的内存不够用，会发生swap，导致性能下降。","like_count":0},{"had_liked":false,"id":258666,"user_name":"李皮皮皮皮皮","can_delete":false,"product_type":"c1","uid":1200281,"ip_address":"","ucode":"3BF1DEE4A12359","user_header":"https://static001.geekbang.org/account/avatar/00/12/50/99/44378317.jpg","comment_is_top":false,"comment_ctime":1604536726,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604536726","product_id":100056701,"comment_content":"老师你好，我们在项目中直接使用redis作为数据库。在项目上线前几天发现内存碎片特别验证，而且重启redis进程也得不到解决。我们没有使用rdb和aof做持久化，而是基于redis2.8版本+leveldb作为后端存储。请求这种情形还有其他可能的诱因吗，要怎么做排查呢，万分谢谢","like_count":0},{"had_liked":false,"id":258087,"user_name":"李皮皮皮皮皮","can_delete":false,"product_type":"c1","uid":1200281,"ip_address":"","ucode":"3BF1DEE4A12359","user_header":"https://static001.geekbang.org/account/avatar/00/12/50/99/44378317.jpg","comment_is_top":false,"comment_ctime":1604289928,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604289928","product_id":100056701,"comment_content":"老师你好，我们在项目中直接使用redis作为数据库。在项目上线前几天发现内存碎片特别验证，而且重启redis进程也得不到解决。我们没有使用rdb和aof做持久化，而是基于redis2.8版本+leveldb作为后端存储。请求这种情形还有其他可能的诱因吗，要怎么做排查呢，万分谢谢","like_count":0},{"had_liked":false,"id":257868,"user_name":"学习学个屁","can_delete":false,"product_type":"c1","uid":1049017,"ip_address":"","ucode":"DF2D61E6FB2FCE","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/b9/73435279.jpg","comment_is_top":false,"comment_ctime":1604161516,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604161516","product_id":100056701,"comment_content":"mem_fragmentation_ratio = used_memory_rss&#47; used_memory，mem_fragmentation_ratio 小于1 , 说明 <br> used_memory_rss 这个参数小,操作系统分配的内存,小于 实际保存的内存,说明redis内存不足了, 如果 Redis 的内存不够用了，操作系统会启动 swap 机制，这就会直接拖慢 Redis。swap  会优先执行磁盘查询操作.... ","like_count":0},{"had_liked":false,"id":256381,"user_name":"我是小妖怪🇨🇳","can_delete":false,"product_type":"c1","uid":1758660,"ip_address":"","ucode":"A5381FA2D2C713","user_header":"https://static001.geekbang.org/account/avatar/00/1a/d5/c4/62b2cd5a.jpg","comment_is_top":false,"comment_ctime":1603614419,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603614419","product_id":100056701,"comment_content":"加油！坚持就是胜利","like_count":0},{"had_liked":false,"id":253505,"user_name":"郭嵩阳","can_delete":false,"product_type":"c1","uid":1080998,"ip_address":"","ucode":"9DC42C7B73F580","user_header":"https://static001.geekbang.org/account/avatar/00/10/7e/a6/188817b6.jpg","comment_is_top":false,"comment_ctime":1602755854,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1602755854","product_id":100056701,"comment_content":"老师好;<br>关于应用A B C D分配移动内存那块没有看懂<br>比如A B C D可以比作web应用对吧<br><br>如果同一个redis实例，不同的应用链接操作这个redis，内存分配不一样？<br>如果就一个应用A,还存在内存移动的情况吗,就是第三个图","like_count":0},{"had_liked":false,"id":252866,"user_name":"xueyuan","can_delete":false,"product_type":"c1","uid":1128121,"ip_address":"","ucode":"3DE20A723EBAFE","user_header":"https://static001.geekbang.org/account/avatar/00/11/36/b9/3b28f67c.jpg","comment_is_top":false,"comment_ctime":1602503803,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602503803","product_id":100056701,"comment_content":"mem_fragmentation_ratio 小于 1 了说明redis的内存小于系统分配的内存，那么这边时候进行了操作系统的swap。会影响访问速度。","like_count":0},{"had_liked":false,"id":252140,"user_name":"dfuru","can_delete":false,"product_type":"c1","uid":2110772,"ip_address":"","ucode":"0222FADA093D95","user_header":"","comment_is_top":false,"comment_ctime":1602142420,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1602142420","product_id":100056701,"comment_content":"自动碎片整理是否可不在主线程中操作？","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406184,"discussion_content":"不能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634718064,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250792,"user_name":"star1988007","can_delete":false,"product_type":"c1","uid":1690981,"ip_address":"","ucode":"24674BCD3990DF","user_header":"","comment_is_top":false,"comment_ctime":1601223452,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601223452","product_id":100056701,"comment_content":"执行save后碎片消失，这背后是什么原理呢 ","like_count":0},{"had_liked":false,"id":250598,"user_name":"zhou","can_delete":false,"product_type":"c1","uid":1065310,"ip_address":"","ucode":"E5D21F2A3359CB","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/5e/9d2953a3.jpg","comment_is_top":false,"comment_ctime":1601166639,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1601166639","product_id":100056701,"comment_content":"CPU 时间占用控制如何做到呢","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406192,"discussion_content":"1、首先会根据内存碎片率和一些配置参数（如文中提到的这几个）通过一个公式计算出一个CPU占用比例，如10%。根据计算公式，内存碎片率越高计算结果越大，当然不会超过配置的cpu占用上下限\n2、redis内部有个定时任务，默认100ms会跑一次，这个定时任务里就包括内存碎片清理，那么根据步骤1算出的比例内存清理操作最多占用的时间是10ms\n3、内存碎片清理是一个大循环，里面是scan+内存迁移操作，每次操作结束都会判断清理是否结束或者清理总时长是否超过步骤2算出来的时长，如果是则退出大循环，完成这轮清理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634718973,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250165,"user_name":"小袁","can_delete":false,"product_type":"c1","uid":1811495,"ip_address":"","ucode":"3F5D8721F577D9","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","comment_is_top":false,"comment_ctime":1600957996,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1600957996","product_id":100056701,"comment_content":"为什么不说下内存整理具体是怎么实现的？jemalloc应该不能控制，那到底怎么处理？","like_count":0,"discussions":[{"author":{"id":1388092,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2e/3c/eae43616.jpg","nickname":"sid","note":"","ucode":"3D1F9169A19D29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311287,"discussion_content":"看下这门课程的 开篇词吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602297800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249818,"user_name":"yeek","can_delete":false,"product_type":"c1","uid":1020629,"ip_address":"","ucode":"A1C71023113CB9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/d5/699384a0.jpg","comment_is_top":false,"comment_ctime":1600822792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600822792","product_id":100056701,"comment_content":"小于的话，应该是发生了内存到磁盘的swap吧，这个影响就很大了，swap的数据访问效率会严重降低","like_count":0}]}