{"id":100564,"title":"09 | ä¸ºä»€ä¹ˆ lua-resty-core æ€§èƒ½æ›´é«˜ä¸€äº›ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>å‰é¢ä¸¤èŠ‚è¯¾æˆ‘ä»¬è¯´äº†ï¼ŒLua æ˜¯ä¸€ç§åµŒå…¥å¼å¼€å‘è¯­è¨€ï¼Œæ ¸å¿ƒä¿æŒäº†çŸ­å°ç²¾æ‚ï¼Œä½ å¯ä»¥åœ¨ Redisã€NGINX ä¸­åµŒå…¥ Luaï¼Œæ¥å¸®åŠ©ä½ æ›´çµæ´»åœ°å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚åŒæ—¶ï¼ŒLua ä¹Ÿå¯ä»¥è°ƒç”¨å·²æœ‰çš„ C å‡½æ•°å’Œæ•°æ®ç»“æ„ï¼Œé¿å…é‡å¤é€ è½®å­ã€‚</p><p>åœ¨ Lua ä¸­ï¼Œä½ å¯ä»¥ç”¨ Lua C API æ¥è°ƒç”¨ C å‡½æ•°ï¼Œè€Œåœ¨ LuaJIT ä¸­è¿˜å¯ä»¥ä½¿ç”¨ FFIã€‚å¯¹ OpenResty è€Œè¨€ï¼š</p><ul>\n<li>åœ¨æ ¸å¿ƒçš„ <code>lua-nginx-module</code> ä¸­ï¼Œè°ƒç”¨ C å‡½æ•°çš„ APIï¼Œéƒ½æ˜¯ä½¿ç”¨ Lua C API æ¥å®Œæˆçš„ï¼›</li>\n<li>è€Œåœ¨ <code>lua-resty-core</code> ä¸­ï¼Œåˆ™æ˜¯æŠŠ <code>lua-nginx-module</code> å·²æœ‰çš„éƒ¨åˆ† APIï¼Œä½¿ç”¨ FFI çš„æ¨¡å¼é‡æ–°å®ç°äº†ä¸€éã€‚</li>\n</ul><p>çœ‹åˆ°è¿™é‡Œä½ ä¼°è®¡çº³é—·äº†ï¼šä¸ºä»€ä¹ˆè¦ç”¨ FFI é‡æ–°å®ç°ä¸€éï¼Ÿ</p><p>åˆ«ç€æ€¥ï¼Œè®©æˆ‘ä»¬ä»¥ <a href=\"https://github.com/openresty/lua-nginx-module#ngxdecode_base64\">ngx.base64_decode</a> è¿™ä¸ªå¾ˆç®€å•çš„ API ä¸ºä¾‹ï¼Œä¸€èµ·çœ‹ä¸‹ Lua C API å’Œ FFI çš„å®ç°æœ‰ä½•ä¸åŒä¹‹å¤„ï¼Œè¿™æ ·ä½ ä¹Ÿå¯ä»¥å¯¹å®ƒä»¬çš„æ€§èƒ½æœ‰ä¸ªç›´è§‚çš„è®¤è¯†ã€‚</p><h2>Lua CFunction</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ï¼Œ <code>lua-nginx-module</code> ä¸­ç”¨ Lua C API æ˜¯å¦‚ä½•å®ç°çš„ã€‚æˆ‘ä»¬åœ¨é¡¹ç›®çš„ä»£ç ä¸­æœç´¢ <code>decode_base64</code>ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒçš„ä»£ç å®ç°åœ¨ <code>ngx_http_lua_string.c</code> ä¸­ï¼š</p><pre><code>lua_pushcfunction(L, ngx_http_lua_ngx_decode_base64);\nlua_setfield(L, -2, &quot;decode_base64&quot;);\n</code></pre><!-- [[[read_end]]] --><p>ä¸Šé¢çš„ä»£ç çœ‹ç€å°±å¤´å¤§ï¼Œä¸è¿‡è¿˜å¥½ï¼Œæˆ‘ä»¬ä¸ç”¨æ·±ç©¶é‚£ä¸¤ä¸ª <code>lua_</code> å¼€å¤´çš„å‡½æ•°ï¼Œä»¥åŠå®ƒä»¬å‚æ•°çš„å…·ä½“ä½œç”¨ï¼Œåªéœ€è¦çŸ¥é“ä¸€ç‚¹â€”â€”è¿™é‡Œæ³¨å†Œäº†ä¸€ä¸ª CFunctionï¼š<code>ngx_http_lua_ngx_decode_base64</code>ï¼Œ è€Œå®ƒä¸ <code>ngx.base64_decode</code> è¿™ä¸ªå¯¹å¤–æš´éœ²çš„ API æ˜¯å¯¹åº”å…³ç³»ã€‚</p><p>æˆ‘ä»¬ç»§ç»­â€œæŒ‰å›¾ç´¢éª¥â€ï¼Œåœ¨è¿™ä¸ª C æ–‡ä»¶ä¸­æœç´¢ <code>ngx_http_lua_ngx_decode_base64</code>ï¼Œå®ƒå®šä¹‰åœ¨æ–‡ä»¶çš„å¼€å§‹ä½ç½®ï¼š</p><pre><code>static int ngx_http_lua_ngx_decode_base64(lua_State *L);\n</code></pre><p>å¯¹äºé‚£äº›èƒ½å¤Ÿè¢« Lua è°ƒç”¨çš„ C å‡½æ•°æ¥è¯´ï¼Œå®ƒçš„æ¥å£å¿…é¡»éµå¾ª Lua è¦æ±‚çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ <code>typedef int (*lua_CFunction)(lua_State* L)</code>ã€‚å®ƒåŒ…å«çš„å‚æ•°æ˜¯ <code>lua_State</code> ç±»å‹çš„æŒ‡é’ˆ L ï¼›å®ƒçš„è¿”å›å€¼ç±»å‹æ˜¯ä¸€ä¸ªæ•´å‹ï¼Œè¡¨ç¤ºè¿”å›å€¼çš„æ•°é‡ï¼Œè€Œéè¿”å›å€¼è‡ªèº«ã€‚</p><p>å®ƒçš„å®ç°å¦‚ä¸‹ï¼ˆè¿™é‡Œæˆ‘å·²ç»å»æ‰äº†é”™è¯¯å¤„ç†çš„ä»£ç ï¼‰ï¼š</p><pre><code>static int\n ngx_http_lua_ngx_decode_base64(lua_State *L)\n {\n     ngx_str_t p, src;\n \n    src.data = (u_char *) luaL_checklstring(L, 1, &amp;src.len);\n \n     p.len = ngx_base64_decoded_length(src.len);\n \n     p.data = lua_newuserdata(L, p.len);\n \n     if (ngx_decode_base64(&amp;p, &amp;src) == NGX_OK) {\n         lua_pushlstring(L, (char *) p.data, p.len);\n \n     } else {\n         lua_pushnil(L);\n     }\n \n     return 1;\n }\n</code></pre><p>è¿™æ®µä»£ç ä¸­ï¼Œæœ€ä¸»è¦çš„æ˜¯ <code>ngx_base64_decoded_length</code> å’Œ <code>ngx_decode_base64</code>ï¼Œ å®ƒä»¬éƒ½æ˜¯ NGINX è‡ªèº«æä¾›çš„ C å‡½æ•°ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œç”¨ C ç¼–å†™çš„å‡½æ•°ï¼Œæ— æ³•æŠŠè¿”å›å€¼ä¼ ç»™ Lua ä»£ç ï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡æ ˆï¼Œæ¥ä¼ é€’ Lua å’Œ C ä¹‹é—´çš„è°ƒç”¨å‚æ•°å’Œè¿”å›å€¼ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œä¼šæœ‰å¾ˆå¤šæˆ‘ä»¬ä¸€çœ¼æ— æ³•çœ‹æ‡‚çš„ä»£ç ã€‚åŒæ—¶ï¼Œè¿™äº›ä»£ç ä¹Ÿä¸èƒ½è¢« JIT è·Ÿè¸ªåˆ°ï¼Œæ‰€ä»¥å¯¹äº LuaJIT è€Œè¨€ï¼Œè¿™äº›æ“ä½œæ˜¯å¤„äºé»‘ç›’ä¸­çš„ï¼Œæ²¡æ³•è¿›è¡Œä¼˜åŒ–ã€‚</p><h2>LuaJIT FFI</h2><p>è€Œ FFI åˆ™ä¸åŒã€‚FFI çš„äº¤äº’éƒ¨åˆ†æ˜¯ç”¨ Lua å®ç°çš„ï¼Œè¿™éƒ¨åˆ†ä»£ç å¯ä»¥è¢« JIT è·Ÿè¸ªåˆ°ï¼Œå¹¶è¿›è¡Œä¼˜åŒ–ï¼›å½“ç„¶ï¼Œä»£ç ä¹Ÿä¼šæ›´åŠ ç®€æ´æ˜“æ‡‚ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ <code>base64_decode</code>ä¸ºä¾‹ï¼Œå®ƒçš„ FFI å®ç°åˆ†æ•£åœ¨ä¸¤ä¸ªä»“åº“ä¸­ï¼š <code>lua-resty-core</code> å’Œ <code>lua-nginx-module</code>ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å‰è€…é‡Œé¢<a href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/resty/core/base64.lua#L72\">å®ç°çš„ä»£ç </a>ï¼š</p><pre><code>ngx.decode_base64 = function (s)\n     local slen = #s\n     local dlen = base64_decoded_length(slen)\n     \n     local dst = get_string_buf(dlen)\n     local pdlen = get_size_ptr()\n     local ok = C.ngx_http_lua_ffi_decode_base64(s, slen, dst, pdlen)\n     if ok == 0 then\n         return nil\n     end\n     return ffi_string(dst, pdlen[0])\n end\n</code></pre><p>ä½ ä¼šå‘ç°ï¼Œç›¸æ¯” CFunctionï¼ŒFFI å®ç°çš„ä»£ç æ¸…çˆ½äº†å¾ˆå¤šï¼Œå®ƒå…·ä½“çš„å®ç°æ˜¯ <code>lua-nginx-module</code> ä»“åº“ä¸­çš„<code>ngx_http_lua_ffi_decode_base64</code>ï¼Œå¦‚æœä½ å¯¹è¿™é‡Œæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªå·±å»æŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œç‰¹åˆ«ç®€å•ï¼Œè¿™é‡Œæˆ‘å°±ä¸è´´ä»£ç äº†ã€‚</p><p>ä¸è¿‡ï¼Œç»†å¿ƒçš„ä½ ï¼Œæ˜¯å¦ä»ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œå‘ç°å‡½æ•°å‘½åçš„ä¸€äº›è§„å¾‹äº†å‘¢ï¼Ÿ</p><p>æ²¡é”™ï¼ŒOpenResty ä¸­çš„å‡½æ•°éƒ½æ˜¯æœ‰å‘½åè§„èŒƒçš„ï¼Œä½ å¯ä»¥é€šè¿‡å‘½åæ¨æµ‹å‡ºå®ƒçš„ç”¨å¤„ã€‚æ¯”å¦‚ï¼š</p><ul>\n<li><code>ngx_http_lua_ffi_</code> ï¼Œæ˜¯ç”¨ FFI æ¥å¤„ç† NGINX HTTP è¯·æ±‚çš„ Lua å‡½æ•°ï¼›</li>\n<li><code>ngx_http_lua_ngx_</code> ï¼Œæ˜¯ç”¨ Cfunction æ¥å¤„ç† NGINX HTTP è¯·æ±‚çš„ Lua å‡½æ•°ï¼›</li>\n<li>å…¶ä»– <code>ngx_</code> å’Œ <code>lua_</code> å¼€å¤´çš„å‡½æ•°ï¼Œåˆ™åˆ†åˆ«å±äº NGINX å’Œ Lua çš„å†…ç½®å‡½æ•°ã€‚</li>\n</ul><p>æ›´è¿›ä¸€æ­¥ï¼ŒOpenResty ä¸­çš„ C ä»£ç ï¼Œä¹Ÿæœ‰ç€ä¸¥æ ¼çš„ä»£ç è§„èŒƒï¼Œè¿™é‡Œæˆ‘æ¨èé˜…è¯»<a href=\"https://openresty.org/cn/c-coding-style-guide.html\">å®˜æ–¹çš„ C ä»£ç é£æ ¼æŒ‡å—</a>ã€‚å¯¹äºæœ‰æ„å­¦ä¹  OpenResty çš„ C ä»£ç å¹¶æäº¤ PR çš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™æ˜¯å¿…å¤‡çš„ä¸€ç¯‡æ–‡æ¡£ã€‚å¦åˆ™ï¼Œå³ä½¿ä½ çš„ PR å†™å¾—å†å¥½ï¼Œä¹Ÿä¼šå› ä¸ºä»£ç é£æ ¼é—®é¢˜è¢«åå¤è¯„è®ºå¹¶è¦æ±‚ä¿®æ”¹ã€‚</p><p>å…³äº FFI æ›´å¤šçš„ API å’Œç»†èŠ‚ï¼Œæ¨èä½ é˜…è¯» LuaJIT <a href=\"http://luajit.org/ext_ffi_tutorial.html\">å®˜æ–¹çš„æ•™ç¨‹</a> å’Œ <a href=\"http://luajit.org/ext_ffi_api.html\">æ–‡æ¡£</a>ã€‚æŠ€æœ¯ä¸“æ å¹¶ä¸èƒ½ä»£æ›¿å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä¹Ÿåªèƒ½åœ¨æœ‰é™çš„æ—¶é—´å†…å¸®ä½ æŒ‡å‡ºå­¦ä¹ çš„è·¯å¾„ï¼Œå°‘èµ°ä¸€äº›å¼¯è·¯ï¼Œç¡¬éª¨å¤´è¿˜æ˜¯éœ€è¦ä½ è‡ªå·±å»å•ƒçš„ã€‚</p><h2>LuaJIT FFI GC</h2><p>ä½¿ç”¨ FFI çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¿·æƒ‘ï¼šåœ¨ FFI ä¸­ç”³è¯·çš„å†…å­˜ï¼Œåˆ°åº•ç”±è°æ¥ç®¡ç†å‘¢ï¼Ÿæ˜¯åº”è¯¥æˆ‘ä»¬åœ¨ C é‡Œé¢æ‰‹åŠ¨é‡Šæ”¾ï¼Œè¿˜æ˜¯ LuaJIT è‡ªåŠ¨å›æ”¶å‘¢ï¼Ÿ</p><p>è¿™é‡Œæœ‰ä¸ªç®€å•çš„åŸåˆ™ï¼šLuaJIT åªè´Ÿè´£ç”±è‡ªå·±åˆ†é…çš„èµ„æºï¼›è€Œ <code>ffi.C</code> æ˜¯ C åº“çš„å‘½åç©ºé—´ï¼Œæ‰€ä»¥ï¼Œä½¿ç”¨ <code>ffi.C</code> åˆ†é…çš„ç©ºé—´ä¸ç”± LuaJIT è´Ÿè´£ï¼Œéœ€è¦ä½ è‡ªå·±æ‰‹åŠ¨é‡Šæ”¾ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ä½ ä½¿ç”¨ <code>ffi.C.malloc</code> ç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œé‚£ä½ å°±éœ€è¦ç”¨é…å¯¹çš„ <code>ffi.C.free</code> æ¥é‡Šæ”¾ã€‚LuaJIT çš„å®˜æ–¹æ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªå¯¹åº”çš„ç¤ºä¾‹ï¼š</p><pre><code>local p = ffi.gc(ffi.C.malloc(n), ffi.C.free)\n ...\n p = nil -- Last reference to p is gone.\n -- GC will eventually run finalizer: ffi.C.free(p)\n</code></pre><p>è¿™æ®µä»£ç ä¸­ï¼Œ<code>ffi.C.malloc(n)</code> ç”³è¯·äº†ä¸€æ®µå†…å­˜ï¼ŒåŒæ—¶ <code>ffi.gc</code> å°±ç»™å®ƒæ³¨å†Œäº†ä¸€ä¸ªææ„çš„å›è°ƒå‡½æ•° <code>ffi.C.free</code>ã€‚è¿™æ ·ä¸€æ¥ï¼Œ<code>p</code> è¿™ä¸ª <code>cdata</code> åœ¨è¢« LuaJIT GC çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨ <code>ffi.C.free</code>ï¼Œæ¥é‡Šæ”¾ C çº§åˆ«çš„å†…å­˜ã€‚è€Œ <code>cdata</code> æ˜¯ç”± LuaJIT è´Ÿè´£ GCçš„ ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç ä¸­çš„ <code>p</code> ä¼šè¢« LuaJIT è‡ªåŠ¨é‡Šæ”¾ã€‚</p><p>è¿™é‡Œè¦æ³¨æ„ï¼Œå¦‚æœä½ è¦åœ¨ OpenResty ä¸­ç”³è¯·å¤§å—çš„å†…å­˜ï¼Œæˆ‘æ›´æ¨èä½ ç”¨ <code>ffi.C.malloc</code> è€Œä¸æ˜¯ <code>ffi.new</code>ã€‚åŸå› ä¹Ÿå¾ˆæ˜æ˜¾ï¼š</p><ol>\n<li><code>ffi.new</code> è¿”å›çš„æ˜¯ä¸€ä¸ª <code>cdata</code>ï¼Œè¿™éƒ¨åˆ†å†…å­˜ç”± LuaJIT ç®¡ç†ï¼›</li>\n<li>LuaJIT GC çš„ç®¡ç†å†…å­˜æ˜¯æœ‰ä¸Šé™çš„ï¼ŒOpenResty ä¸­çš„ LuaJIT å¹¶æœªå¼€å¯ GC64 é€‰é¡¹ï¼Œæ‰€ä»¥<strong>å•ä¸ª worker å†…å­˜çš„ä¸Šé™åªæœ‰2G</strong>ã€‚ä¸€æ—¦è¶…è¿‡ LuaJIT çš„å†…å­˜ç®¡ç†ä¸Šé™ï¼Œå°±ä¼šå¯¼è‡´æŠ¥é”™ã€‚</li>\n</ol><p><strong>åœ¨ä½¿ç”¨ FFI çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç‰¹åˆ«æ³¨æ„å†…å­˜æ³„æ¼çš„é—®é¢˜</strong>ã€‚ä¸è¿‡ï¼Œå‡¡äººçš†ä¼šçŠ¯é”™ï¼Œåªè¦æ˜¯äººå†™çš„ä»£ç ï¼Œç™¾å¯†ä¸€ç–ï¼Œæ€»ä¼šå‡ºç° bugã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå·¥å…·å¯ä»¥æ£€æµ‹å†…å­˜æ³„æ¼å‘¢ï¼Ÿ</p><p>è¿™æ—¶å€™ï¼ŒOpenResty å¼ºå¤§çš„å‘¨è¾¹æµ‹è¯•å’Œè°ƒè¯•å·¥å…·é“¾å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥è¯´è¯´æµ‹è¯•ã€‚åœ¨ OpenResty ä½“ç³»ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Valgrind æ¥æ£€æµ‹å†…å­˜æ³„æ¼é—®é¢˜ã€‚</p><p>å‰é¢è¯¾ç¨‹æˆ‘ä»¬æåˆ°è¿‡çš„æµ‹è¯•æ¡†æ¶ <code>test::nginx</code>ï¼Œæœ‰ä¸“é—¨çš„å†…å­˜æ³„æ¼æ£€æµ‹æ¨¡å¼å»è¿è¡Œå•å…ƒæµ‹è¯•æ¡ˆä¾‹é›†ï¼Œä½ åªéœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡ <code>TEST_NGINX_USE_VALGRIND=1</code> å³å¯ã€‚OpenResty çš„å®˜æ–¹é¡¹ç›®åœ¨å‘ç‰ˆæœ¬ä¹‹å‰ï¼Œéƒ½ä¼šåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹å®Œæ•´å›å½’ï¼Œåé¢çš„æµ‹è¯•ç« èŠ‚ä¸­æˆ‘ä»¬å†è¯¦ç»†ä»‹ç»ã€‚</p><p>è€Œ OpenResty çš„ CLI <code>resty</code> ä¹Ÿæœ‰ <code>--valgrind</code> é€‰é¡¹ï¼Œæ–¹ä¾¿ä½ å•ç‹¬è¿è¡ŒæŸæ®µ Lua ä»£ç ï¼Œå³ä½¿ä½ æ²¡æœ‰å†™æµ‹è¯•æ¡ˆä¾‹ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚</p><p>å†æ¥çœ‹è°ƒè¯•å·¥å…·ã€‚</p><p>OpenResty æä¾›<a href=\"https://github.com/openresty/stapxx\">åŸºäº systemtap çš„æ‰©å±•</a>ï¼Œæ¥å¯¹ OpenResty ç¨‹åºè¿›è¡Œæ´»ä½“çš„åŠ¨æ€åˆ†æã€‚ä½ å¯ä»¥åœ¨è¿™ä¸ªé¡¹ç›®çš„å·¥å…·é›†ä¸­ï¼Œæœç´¢ <code>gc</code> è¿™ä¸ªå…³é”®å­—ï¼Œä¼šçœ‹åˆ° <code>lj-gc</code> å’Œ <code>lj-gc-objs</code> è¿™ä¸¤ä¸ªå·¥å…·ã€‚</p><p>è€Œå¯¹äº core dump è¿™ç§ç¦»çº¿åˆ†æï¼ŒOpenResty æä¾›äº† <a href=\"https://github.com/openresty/openresty-gdb-utils\">GDB çš„å·¥å…·é›†</a>ï¼ŒåŒæ ·ä½ å¯ä»¥åœ¨é‡Œé¢æœç´¢ <code>gc</code>ï¼Œæ‰¾åˆ° <code>lgc</code>ã€<code>lgcstat</code> å’Œ <code>lgcpath</code> ä¸‰ä¸ªå·¥å…·ã€‚</p><p>è¿™äº›è°ƒè¯•å·¥å…·çš„å…·ä½“ç”¨æ³•ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢çš„è°ƒè¯•ç« èŠ‚ä¸­è¯¦ç»†ä»‹ç»ï¼Œä½ å…ˆæœ‰ä¸ªå°è±¡å³å¯ã€‚è¿™æ ·ï¼Œä½ é‡åˆ°å†…å­˜é—®é¢˜å°±ä¸ä¼šâ€œç—…æ€¥ä¹±æŠ•åŒ»â€œï¼Œæ¯•ç«ŸOpenResty æœ‰ä¸“é—¨çš„å·¥å…·é›†ï¼Œå¸®ä½ å®šä½å’Œè§£å†³è¿™äº›é—®é¢˜ã€‚</p><h2>lua-resty-core</h2><p>ä»ä¸Šé¢çš„æ¯”è¾ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒFFI çš„æ–¹å¼ä¸ä»…ä»£ç æ›´ç®€æ´ï¼Œè€Œä¸”å¯ä»¥è¢« LuaJIT ä¼˜åŒ–ï¼Œæ˜¾ç„¶æ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚å…¶å®ç°å®ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå®é™…ä¸Šï¼ŒCFunction çš„å®ç°æ–¹å¼å·²ç»è¢« OpenResty åºŸå¼ƒï¼Œç›¸å…³çš„å®ç°ä¹Ÿä»ä»£ç åº“ä¸­ç§»é™¤äº†ã€‚ç°åœ¨æ–°çš„ APIï¼Œéƒ½é€šè¿‡ FFI çš„æ–¹å¼ï¼Œåœ¨ <code>lua-resty-core</code> ä»“åº“ä¸­å®ç°ã€‚</p><p>åœ¨ OpenResty 2019 å¹´ 5 æœˆä»½å‘å¸ƒçš„ 1.15.8.1 ç‰ˆæœ¬å‰ï¼Œ<code>lua-resty-core</code> é»˜è®¤æ˜¯ä¸å¼€å¯çš„ï¼Œè€Œè¿™ä¸ä»…ä¼šå¸¦æ¥æ€§èƒ½æŸå¤±ï¼Œæ›´ä¸¥é‡çš„æ˜¯ä¼šé€ æˆæ½œåœ¨çš„ bugã€‚æ‰€ä»¥ï¼Œæˆ‘å¼ºçƒˆæ¨èè¿˜åœ¨ä½¿ç”¨å†å²ç‰ˆæœ¬çš„ç”¨æˆ·ï¼Œéƒ½æ‰‹åŠ¨å¼€å¯ <code>lua-resty-core</code>ã€‚ä½ åªéœ€è¦åœ¨ <code>init_by_lua</code> é˜¶æ®µï¼Œå¢åŠ ä¸€è¡Œä»£ç å°±å¯ä»¥äº†ï¼š</p><pre><code>require &quot;resty.core&quot;\n</code></pre><p>å½“ç„¶ï¼Œå§—å§—æ¥è¿Ÿçš„ 1.15.8.1 ç‰ˆæœ¬ä¸­ï¼Œå·²ç»å¢åŠ äº† <code>lua_load_resty_core</code> æŒ‡ä»¤ï¼Œé»˜è®¤å¼€å¯äº† <code>lua-resty-core</code>ã€‚æˆ‘ä¸ªäººæ„Ÿè§‰ï¼ŒOpenResty å¯¹äº <code>lua-resty-core</code> çš„å¼€å¯è¿˜æ˜¯è¿‡äºè°¨æ…äº†ï¼Œå¼€æºé¡¹ç›®åº”è¯¥å°½æ—©æŠŠç±»ä¼¼çš„åŠŸèƒ½è®¾ç½®ä¸ºé»˜è®¤å¼€å¯ã€‚</p><p><code>lua-resty-core</code> ä¸­ä¸ä»…é‡æ–°å®ç°äº†éƒ¨åˆ† lua-nginx-module é¡¹ç›®ä¸­çš„ APIï¼Œæ¯”å¦‚ <code>ngx.re.match</code>ã€<code>ngx.md5</code> ç­‰ï¼Œè¿˜å®ç°äº†ä¸å°‘æ–°çš„ APIï¼Œæ¯”å¦‚ ngx.sslã€ngx.base64ã€ngx.errlogã€ngx.processã€ngx.re.splitã€ngx.resp.add_headerã€ngx.balancerã€ngx.semaphore ç­‰ç­‰ï¼Œæˆ‘ä»¬åœ¨åé¢çš„ OpenResty API ç« èŠ‚ä¸­ä¼šä»‹ç»åˆ°ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>è®²äº†è¿™ä¹ˆå¤šå†…å®¹ï¼Œæœ€åæˆ‘è¿˜æ˜¯æƒ³è¯´ï¼ŒFFI è™½ç„¶å¥½ï¼Œå´ä¹Ÿå¹¶ä¸æ˜¯æ€§èƒ½é“¶å¼¹ã€‚å®ƒä¹‹æ‰€ä»¥é«˜æ•ˆï¼Œä¸»è¦åŸå› å°±æ˜¯å¯ä»¥è¢« JIT è¿½è¸ªå¹¶ä¼˜åŒ–ã€‚å¦‚æœä½ å†™çš„ Lua ä»£ç ä¸èƒ½è¢« JITï¼Œè€Œæ˜¯éœ€è¦åœ¨è§£é‡Šæ¨¡å¼ä¸‹æ‰§è¡Œï¼Œé‚£ä¹ˆ FFI çš„æ•ˆç‡åè€Œä¼šæ›´ä½ã€‚</p><p>é‚£ä¹ˆåˆ°åº•æœ‰å“ªäº›æ“ä½œå¯ä»¥è¢« JITï¼Œå“ªäº›ä¸èƒ½å‘¢ï¼Ÿæ€æ ·æ‰å¯ä»¥é¿å…å†™å‡ºä¸èƒ½è¢« JIT çš„ä»£ç å‘¢ï¼Ÿä¸‹ä¸€èŠ‚æˆ‘æ¥æ­æ™“è¿™ä¸ªé—®é¢˜ã€‚</p><p>æœ€åï¼Œç»™ä½ ç•™ä¸€ä¸ªéœ€è¦åŠ¨æ‰‹çš„ä½œä¸šé¢˜ï¼šä½ å¯ä»¥æ‰¾ä¸€ä¸¤ä¸ªlua-nginx-module å’Œ lua-resty-core ä¸­éƒ½å­˜åœ¨çš„ APIï¼Œç„¶åæ€§èƒ½æµ‹è¯•æ¯”è¾ƒä¸€ä¸‹ä¸¤è€…çš„å·®å¼‚å—ï¼Ÿä½ å¯ä»¥çœ‹ä¸‹ FFI çš„æ€§èƒ½æå‡åˆ°åº•æœ‰å¤šå¤§ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„æ€è€ƒã€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ï¼Œä¸€èµ·äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"08 | LuaJITåˆ†æ”¯å’Œæ ‡å‡†Luaæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ","id":100402},"right":{"article_title":"10 | JITç¼–è¯‘å™¨çš„æ­»ç©´ï¼šä¸ºä»€ä¹ˆè¦é¿å…ä½¿ç”¨ NYI ï¼Ÿ","id":100912}},"comments":[{"had_liked":false,"id":104846,"user_name":"é»‘é“æ‰“é‡ç‹","can_delete":false,"product_type":"c1","uid":1189836,"ip_address":"","ucode":"09FCB9DB732177","user_header":"https://static001.geekbang.org/account/avatar/00/12/27/cc/99349a54.jpg","comment_is_top":false,"comment_ctime":1560853800,"is_pvip":false,"replies":[{"id":"37939","content":"å·®ä¸å¤š 10 å€çš„æ€§èƒ½å·®å¼‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560860264,"ip_address":"","comment_id":104846,"utype":1}],"discussion_count":4,"race_medal":0,"score":"53100461352","product_id":100028301,"comment_content":"nginx version: openresty&#47;1.13.6.2<br>1. lua-nginx-module<br>resty -e &quot;local start = ngx.now();<br>for _ =1, 1000000000 do      <br>    ngx.encode_base64(&#39;123456&#39;)<br>end<br>ngx.update_time();<br>ngx.say(ngx.now() - start)&quot;<br>79.530000209808<br>2. lua-resty-core<br>resty -e &quot;require &#39;resty.core&#39;;<br>local start = ngx.now(); <br>for _ =1, 1000000000 do<br>    ngx.encode_base64(&#39;123456&#39;)<br>end<br>ngx.update_time();<br>ngx.say(ngx.now() - start)&quot;<br>8.944000005722<br>ä¸€ä¸ª79.5s ä¸€ä¸ª8.9s","like_count":13,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454451,"discussion_content":"å·®ä¸å¤š 10 å€çš„æ€§èƒ½å·®å¼‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560860264,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1599553,"avatar":"https://static001.geekbang.org/account/avatar/00/18/68/41/86b109fb.jpg","nickname":"é€é¥","note":"","ucode":"46ED5477B7FE87","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1583,"discussion_content":"å·²ç»æ˜ç™½äº†ï¼Œ1.15.8.1ç‰ˆæœ¬é»˜è®¤å¼€å¯äº†lua-resty-core","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562718899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1599553,"avatar":"https://static001.geekbang.org/account/avatar/00/18/68/41/86b109fb.jpg","nickname":"é€é¥","note":"","ucode":"46ED5477B7FE87","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1565,"discussion_content":"$ ./resty -e &#34;local start = ngx.now();\n> for _ =1, 1000000000 do \n>     ngx.encode_base64(&#39;123456&#39;)\n> end\n> ngx.update_time();\n> ngx.say(ngx.now() - start)&#34;\n7.1210000514984\n\n$ ./resty -e &#34;require &#39;resty.core&#39;;\n> local start = ngx.now(); \n> for _ =1, 1000000000 do\n>     ngx.encode_base64(&#39;123456&#39;)\n> end\n> ngx.update_time();\n> ngx.say(ngx.now() - start)&#34;\n7.1410000324249\næˆ‘æµ‹è¯•äº†è¿™ä¸ªè„šæœ¬ç»“æœç›¸å·®ä¸å¤§å•Š","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562687730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1000620,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/44/ac/c84fa0c3.jpg","nickname":"Hadooper","note":"","ucode":"8F6ED4BF9E5AAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":126832,"discussion_content":"æˆ‘æ˜¯0.23 resty  , 1.15.8.2ï¼Œwin10æ“ä½œç³»ç»Ÿï¼Œ16Gå†…å­˜ï¼Œåè€Œresty.coreè¦32ç§’ï¼Œè€Œæ²¡æœ‰å¼•ç”¨çš„åªè¦21ç§’ã€‚è·‘äº†å‡ æ¬¡éƒ½æ˜¯è¿™æ ·ï¼Œè¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578541661,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104373,"user_name":"å¾®é£å¹äº†ä¸ªå¹","can_delete":false,"product_type":"c1","uid":1549067,"ip_address":"","ucode":"1BB44DA255B4FC","user_header":"https://static001.geekbang.org/account/avatar/00/17/a3/0b/ece949c6.jpg","comment_is_top":false,"comment_ctime":1560740013,"is_pvip":false,"replies":[{"id":"37926","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560841121,"ip_address":"","comment_id":104373,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23035576493","product_id":100028301,"comment_content":"æ¸©è€å¸ˆï¼Œ 1.15.8çš„opnrestyé»˜è®¤æ˜¯å¼€å¯GC64çš„ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºè¿™é‡Œffi.C.mallocä¸ffi.newå°±æ²¡å•¥åŒºåˆ«äº†ï¼Ÿå®˜æ–¹çš„æ›´æ–°æ—¥å¿—```change: we now enable the GC64 mode by default in our bundled LuaJIT build for x86_64 architectures; this can be disabled using --without-luajit-gc64. Thanks Thibault Charbonnier for the patch```","like_count":6,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454246,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560841121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110049,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f0/21/104b9565.jpg","nickname":"å°é£å“¥ â€è¶…ç´šæœƒå“¡","note":"","ucode":"417F9563B3005B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":145,"discussion_content":"è¯·é—®åœ¨å“ªé‡ŒæŸ¥çœ‹openrestyæ˜¯å¦å¼€å¯ GC64ï¼Ÿ æˆ‘æœ¬åœ°ä½¿ç”¨çš„æ˜¯1.15.8.1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561172942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103942,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1560569362,"is_pvip":true,"replies":[{"id":"37668","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560667675,"ip_address":"","comment_id":103942,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14445471250","product_id":100028301,"comment_content":"å‡è®¾ä½¿ç”¨decode_base64å‡½æ•°ï¼Œlua-resty-coreä¸å¼€å¯çš„æ—¶å€™ï¼Œä½¿ç”¨çš„å‡½æ•°å°±æ˜¯lua-nginx-moduleä¸­å®ç°çš„ï¼Œè€Œå¼€å¯çš„è¯å°±æ˜¯ä½¿ç”¨lua-resty-coreä¸­å®ç°çš„ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454067,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560667675,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129111,"user_name":"å†™ç‚¹å•¥å‘¢","can_delete":false,"product_type":"c1","uid":1065272,"ip_address":"","ucode":"C19032CF1C41BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","comment_is_top":false,"comment_ctime":1567043995,"is_pvip":false,"replies":[{"id":"49365","content":"ä¸»è¦æ˜¯è¿™ä¸ªåŸå› ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567651486,"ip_address":"","comment_id":129111,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5862011291","product_id":100028301,"comment_content":"è¯·é—®è€å¸ˆï¼Œffiå’Œcfunctionçš„æ€§èƒ½å·®å¼‚æ˜¯ä¸æ˜¯ä¸»è¦æ˜¯æœ‰LuaJITçš„å®æ—¶ç¼–è¯‘ä¼˜åŒ–å¸¦æ¥çš„ï¼Ÿé™¤æ­¤ä¹‹å¤–è¿˜æœ‰å“ªäº›å› ç´ å¯¼è‡´äº†è¿™ä¸¤è€…ä¹‹é—´çš„æ€§èƒ½å·®å¼‚å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465283,"discussion_content":"ä¸»è¦æ˜¯è¿™ä¸ªåŸå› ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567651486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065272,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","nickname":"å†™ç‚¹å•¥å‘¢","note":"","ucode":"C19032CF1C41BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7721,"discussion_content":"è°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567651524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103989,"user_name":"è‹±é›„","can_delete":false,"product_type":"c1","uid":1546612,"ip_address":"","ucode":"D1033C83C6CDE9","user_header":"https://static001.geekbang.org/account/avatar/00/17/99/74/0203bf17.jpg","comment_is_top":false,"comment_ctime":1560583641,"is_pvip":false,"replies":[{"id":"37670","content":"çŸ¥é“ lua-resty-core æ˜¯ä½¿ç”¨ FFI å®ç°çš„ API å°±è¡Œäº†ï¼Œç»†èŠ‚çœ‹ä¸æ‡‚æ²¡æœ‰å…³ç³»ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560667849,"ip_address":"","comment_id":103989,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5855550937","product_id":100028301,"comment_content":"çœ‹ä¸æ‡‚","like_count":2,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454081,"discussion_content":"çŸ¥é“ lua-resty-core æ˜¯ä½¿ç”¨ FFI å®ç°çš„ API å°±è¡Œäº†ï¼Œç»†èŠ‚çœ‹ä¸æ‡‚æ²¡æœ‰å…³ç³»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560667849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103628,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1560478729,"is_pvip":false,"replies":[{"id":"37593","content":"è¦åˆ†åˆ«æŸ¥çœ‹è¿™ä¸¤ä¸ªä»“åº“çš„æ–‡æ¡£äº†","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560567358,"ip_address":"","comment_id":103628,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5855446025","product_id":100028301,"comment_content":"è€å¸ˆï¼Œlua-resty-coreå’Œlua-nginx-moduleå„è‡ªéƒ½æœ‰å“ªäº›APIï¼Œæ€ä¹ˆæŸ¥å‘¢","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453946,"discussion_content":"è¦åˆ†åˆ«æŸ¥çœ‹è¿™ä¸¤ä¸ªä»“åº“çš„æ–‡æ¡£äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560567358,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103550,"user_name":"Geek_e553fa","can_delete":false,"product_type":"c1","uid":1509816,"ip_address":"","ucode":"84842B909749A0","user_header":"","comment_is_top":false,"comment_ctime":1560472645,"is_pvip":false,"replies":[{"id":"37488","content":"å¯ä»¥ä½¿ç”¨æ¨¡å—ä¸­çš„ top level å±€éƒ¨å˜é‡æ¥æ›¿ä»£ï¼Œè¿™ä¸ªåé¢ä¼šæåˆ°ã€‚<br>åœ¨ OpenResty ä¸­æ‰€æœ‰å˜é‡éƒ½è¦åŠ  localã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560477614,"ip_address":"","comment_id":103550,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5855439941","product_id":100028301,"comment_content":"æ²™å‘ã€‚å¸Œæœ›å¤šç‚¹å®ä¾‹ã€‚è¿˜æœ‰è®²è®²å…¨å±€å˜é‡ç”³è¯·ä½¿ç”¨çš„ä¸€äº›æ›¿ä»£æ–¹æ¡ˆã€‚ä¸æ˜¯å¦å®šäº†ä¸ç»™è§£å†³åŠæ³•","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453915,"discussion_content":"å¯ä»¥ä½¿ç”¨æ¨¡å—ä¸­çš„ top level å±€éƒ¨å˜é‡æ¥æ›¿ä»£ï¼Œè¿™ä¸ªåé¢ä¼šæåˆ°ã€‚\nåœ¨ OpenResty ä¸­æ‰€æœ‰å˜é‡éƒ½è¦åŠ  localã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560477614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109594,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1562063137,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562063137","product_id":100028301,"comment_content":"è·¨è¯­è¨€è°ƒç”¨çš„è¯ï¼Œå‡½æ•°è°ƒç”¨è¿”å›éƒ½æ˜¯é€šè¿‡å‡½æ•°æ ˆæ¥ä¼ é€’å˜›ï¼Œæ¯”å¦‚goè°ƒç”¨Cï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹ä¸»é¢˜æ— å…³å“ˆï¼Œå¸Œæœ›è€å¸ˆè§£ç­”ä¸‹","like_count":0},{"had_liked":false,"id":105254,"user_name":"æ—ºæ—º","can_delete":false,"product_type":"c1","uid":1159196,"ip_address":"","ucode":"FE2CF90F446BFB","user_header":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","comment_is_top":false,"comment_ctime":1560947802,"is_pvip":false,"replies":[{"id":"38151","content":"å› ä¸ºä»1.15.8.1ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤å¼€äº† lua-resty-core","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560998452,"ip_address":"","comment_id":105254,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1560947802","product_id":100028301,"comment_content":"æˆ‘æ˜¯1.15.8.1ç‰ˆæœ¬çš„ï¼Œç”¨äº†å‰é¢åŒå­¦ç»™çš„ä»£ç ï¼Œè·‘èµ·æ¥ï¼Œæ—¶é—´ç›¸å·®å¾ˆå°‘ï¼Œä¸€ä¸ª38.133000135422ç§’ï¼Œä¸€ä¸ª37.325000047684ç§’ã€‚è¿™æ˜¯ä¸ºå•¥ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454611,"discussion_content":"å› ä¸ºä»1.15.8.1ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤å¼€äº† lua-resty-core","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560998452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110049,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f0/21/104b9565.jpg","nickname":"å°é£å“¥ â€è¶…ç´šæœƒå“¡","note":"","ucode":"417F9563B3005B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":146,"discussion_content":"è¿™ä¸ openresty/1.13.6.2 çš„lua-resty-core æ‰§è¡Œçš„8.9 ç›¸å·®å¾ˆå¤§å•Šã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1561173278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1065272,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","nickname":"å†™ç‚¹å•¥å‘¢","note":"","ucode":"C19032CF1C41BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1110049,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f0/21/104b9565.jpg","nickname":"å°é£å“¥ â€è¶…ç´šæœƒå“¡","note":"","ucode":"417F9563B3005B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6670,"discussion_content":"åº”è¯¥æ˜¯ä¸¤ä½åŒå­¦çš„æµ‹è¯•æœºå™¨æ€§èƒ½ä¸åŒã€‚ä½†æ˜¯åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šçš„ä¸¤ç§æ–¹å¼å·®å¼‚èƒ½ä½“ç°ffiå’Œcfunctionçš„ä¸åŒã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567043909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":146,"ip_address":""},"score":6670,"extra":""}]}]},{"had_liked":false,"id":103940,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1560569254,"is_pvip":true,"replies":[{"id":"37673","content":"LuaJIT æ˜¯è¿è¡Œ Lua ä»£ç çš„ï¼Œè‡ªç„¶åªèƒ½ JIT å®ƒå…¶ä¸­çš„ Lua ä»£ç ï¼ŒCFunction çš„è‡ªç„¶æ— èƒ½ä¸ºåŠ›ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1560667989,"ip_address":"","comment_id":103940,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1560569254","product_id":100028301,"comment_content":"å¦‚ä½•ç†è§£FFIçš„äº¤äº’éƒ¨åˆ†æ˜¯ç”¨luaå®ç°çš„ï¼Œè¿™éƒ¨åˆ†ä»£ç å¯ä»¥è¢«JITè·Ÿè¸ªåˆ°ï¼Ÿ<br>LuaCFuncionï¼šngx_http_lua_ngx_decode_base64æ•´ä¸ªå‡½æ•°éƒ½ä¸èƒ½è¢«JITè¿½è¸ªåˆ°ï¼Œè€Œå‡½æ•°ngx.decode_base64å¯ä»¥è¢«JITè¿½è¸ªåˆ°ï¼Œåªæœ‰é‡Œé¢çš„å‡½æ•°C.ngx_http_lua_ffi_decode_baseä¸èƒ½è¢«è¿½è¸ªåˆ°æ˜¯å—ï¼Ÿä¹Ÿå°±æ˜¯C.ngx_http_lua_ffi_decode_baseå‡½æ•°å¯ä»¥è¢«JITç¼–è¯‘ä¼˜åŒ–ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454065,"discussion_content":"LuaJIT æ˜¯è¿è¡Œ Lua ä»£ç çš„ï¼Œè‡ªç„¶åªèƒ½ JIT å®ƒå…¶ä¸­çš„ Lua ä»£ç ï¼ŒCFunction çš„è‡ªç„¶æ— èƒ½ä¸ºåŠ›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560667989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306092,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ61zTDmLk7IhLJn6seBPOwsVaKIWUWaxk5YmsdYBZUOYMQCsyl9iaQVSg9U5qJVLLOCFUoLUuYnRA/132","nickname":"fjpcode","note":"","ucode":"C32C5E3ECB9A90","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4377,"discussion_content":"ä¸ºä»€ä¹ˆåˆ©ç”¨FFIçš„lua_resty_moduleæ¥å£æ€§èƒ½æ›´ä¼˜ï¼Œä»…ä»…æ˜¯å› ä¸ºluaéƒ¨åˆ†ä¼šè¢«JITç¼–è¯‘ï¼Ÿ æ˜¯å¦è¿˜æœ‰å…¶ä»–å› ç´ çš„å½±å“å‘¢ï¼Ÿ æ¯”å¦‚ffiè°ƒç”¨Cå‡½æ•°çš„æµç¨‹è¦æ¯”åˆ©ç”¨ç”¨lua c APIçš„æ›´ä¼˜ï¼Œé€Ÿåº¦æ›´å¿«ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565341296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103809,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1560519044,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1560519044","product_id":100028301,"comment_content":"è¿™ä¸ªä¸å¤ªäº†è§£ï¼Œopenresty å·¥ä½œä¸­è¦çš„å°‘ï¼Œè¿˜æ²¡ä¸Šæ‰‹çš„ï¼Œä¸çŸ¥é“æ€ä¹ˆå»æ¯”è¾ƒæ€§èƒ½","like_count":0}]}