{"id":98855,"title":"29 | è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼šæ–‡ä»¶å¤šäº†å°±éœ€è¦æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ","content":"<p>ä¸Šä¸€èŠ‚ï¼Œå’±ä»¬çš„å›¾ä¹¦é¦†ä¹¦æ¶ï¼Œä¹Ÿå°±æ˜¯ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼éƒ½æ­å»ºå¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå›¾ä¹¦ç®¡ç†ä¸å€Ÿé˜…ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ç®¡ç†æ¨¡å—ï¼Œä¸ç„¶æˆ‘ä»¬æ€ä¹ˆçŸ¥é“ä¹¦éƒ½å€Ÿç»™è°äº†å‘¢ï¼Ÿ</p><p>è¿›ç¨‹è¦æƒ³å¾€æ–‡ä»¶ç³»ç»Ÿé‡Œé¢è¯»å†™æ•°æ®ï¼Œéœ€è¦å¾ˆå¤šå±‚çš„ç»„ä»¶ä¸€èµ·åˆä½œã€‚å…·ä½“æ˜¯æ€ä¹ˆåˆä½œçš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€çœ‹ã€‚</p><ul>\n<li>åœ¨åº”ç”¨å±‚ï¼Œè¿›ç¨‹åœ¨è¿›è¡Œæ–‡ä»¶è¯»å†™æ“ä½œæ—¶ï¼Œå¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨å¦‚sys_openã€sys_readã€sys_writeç­‰ã€‚</li>\n<li>åœ¨å†…æ ¸ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½éœ€è¦ä¸ºæ‰“å¼€çš„æ–‡ä»¶ï¼Œç»´æŠ¤ä¸€å®šçš„æ•°æ®ç»“æ„ã€‚</li>\n<li>åœ¨å†…æ ¸ï¼Œæ•´ä¸ªç³»ç»Ÿæ‰“å¼€çš„æ–‡ä»¶ï¼Œä¹Ÿéœ€è¦ç»´æŠ¤ä¸€å®šçš„æ•°æ®ç»“æ„ã€‚</li>\n<li>Linuxå¯ä»¥æ”¯æŒå¤šè¾¾æ•°åç§ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿã€‚å®ƒä»¬çš„å®ç°å„ä¸ç›¸åŒï¼Œå› æ­¤Linuxå†…æ ¸å‘ç”¨æˆ·ç©ºé—´æä¾›äº†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿè¿™ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œæ¥å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ“ä½œã€‚å®ƒæä¾›äº†å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡æ¨¡å‹ï¼Œä¾‹å¦‚inodeã€directory entryã€mountç­‰ï¼Œä»¥åŠæ“ä½œè¿™äº›å¯¹è±¡çš„æ–¹æ³•ï¼Œä¾‹å¦‚inode operationsã€directory operationsã€file operationsç­‰ã€‚</li>\n<li>ç„¶åå°±æ˜¯å¯¹æ¥çš„æ˜¯çœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¾‹å¦‚æˆ‘ä»¬ä¸ŠèŠ‚è®²çš„ext4æ–‡ä»¶ç³»ç»Ÿã€‚</li>\n<li>ä¸ºäº†è¯»å†™ext4æ–‡ä»¶ç³»ç»Ÿï¼Œè¦é€šè¿‡å—è®¾å¤‡I/Oå±‚ï¼Œä¹Ÿå³BIOå±‚ã€‚è¿™æ˜¯æ–‡ä»¶ç³»ç»Ÿå±‚å’Œå—è®¾å¤‡é©±åŠ¨çš„æ¥å£ã€‚</li>\n<li>ä¸ºäº†åŠ å¿«å—è®¾å¤‡çš„è¯»å†™æ•ˆç‡ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªç¼“å­˜å±‚ã€‚</li>\n<li>æœ€ä¸‹å±‚æ˜¯å—è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚</li>\n</ul><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/3c/73/3c506edf93b15341da3db658e9970773.jpg?wh=1846*2852\" alt=\"\"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬é€å±‚è§£æã€‚</p><p>åœ¨è¿™ä¹‹å‰ï¼Œæœ‰ä¸€ç‚¹ä½ éœ€è¦æ³¨æ„ã€‚è§£æç³»ç»Ÿè°ƒç”¨æ˜¯äº†è§£å†…æ ¸æ¶æ„æœ€æœ‰åŠ›çš„ä¸€æŠŠé’¥åŒ™ï¼Œè¿™é‡Œæˆ‘ä»¬åªè¦é‡ç‚¹å…³æ³¨è¿™å‡ ä¸ªæœ€é‡è¦çš„ç³»ç»Ÿè°ƒç”¨å°±å¯ä»¥äº†ï¼š</p><ul>\n<li>mountç³»ç»Ÿè°ƒç”¨ç”¨äºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼›</li>\n<li>openç³»ç»Ÿè°ƒç”¨ç”¨äºæ‰“å¼€æˆ–è€…åˆ›å»ºæ–‡ä»¶ï¼Œåˆ›å»ºè¦åœ¨flagsä¸­è®¾ç½®O_CREATï¼Œå¯¹äºè¯»å†™è¦è®¾ç½®flagsä¸ºO_RDWRï¼›</li>\n<li>readç³»ç»Ÿè°ƒç”¨ç”¨äºè¯»å–æ–‡ä»¶å†…å®¹ï¼›</li>\n<li>writeç³»ç»Ÿè°ƒç”¨ç”¨äºå†™å…¥æ–‡ä»¶å†…å®¹ã€‚</li>\n</ul><h2>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</h2><p>æƒ³è¦æ“ä½œæ–‡ä»¶ç³»ç»Ÿï¼Œç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å†…æ ¸æ˜¯ä¸æ˜¯æ”¯æŒæŸç§ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œéœ€è¦æˆ‘ä»¬è¿›è¡Œæ³¨å†Œæ‰èƒ½çŸ¥é“ã€‚ä¾‹å¦‚ï¼Œå’±ä»¬ä¸Šä¸€èŠ‚è§£æçš„ext4æ–‡ä»¶ç³»ç»Ÿï¼Œå°±éœ€è¦é€šè¿‡register_filesystemè¿›è¡Œæ³¨å†Œï¼Œä¼ å…¥çš„å‚æ•°æ˜¯ext4_fs_typeï¼Œè¡¨ç¤ºæ³¨å†Œçš„æ˜¯ext4ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™é‡Œé¢æœ€é‡è¦çš„ä¸€ä¸ªæˆå‘˜å˜é‡å°±æ˜¯ext4_mountã€‚è®°ä½å®ƒï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢è¿˜ä¼šç”¨ã€‚</p><pre><code>register_filesystem(&amp;ext4_fs_type);\n\n\nstatic struct file_system_type ext4_fs_type = {\n\t.owner\t\t= THIS_MODULE,\n\t.name\t\t= &quot;ext4&quot;,\n\t.mount\t\t= ext4_mount,\n\t.kill_sb\t= kill_block_super,\n\t.fs_flags\t= FS_REQUIRES_DEV,\n};\n</code></pre><p>å¦‚æœä¸€ç§æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹æ›¾ç»åœ¨å†…æ ¸æ³¨å†Œè¿‡ï¼Œè¿™å°±è¯´æ˜å…è®¸ä½ æŒ‚è½½å¹¶ä¸”ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚</p><p>åˆšæ‰æˆ‘è¯´äº†å‡ ä¸ªéœ€è¦é‡ç‚¹å…³æ³¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£æˆ‘ä»¬å°±ä»ç¬¬ä¸€ä¸ªmountç³»ç»Ÿè°ƒç”¨å¼€å§‹è§£æã€‚mountç³»ç»Ÿè°ƒç”¨çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>SYSCALL_DEFINE5(mount, char __user *, dev_name, char __user *, dir_name, char __user *, type, unsigned long, flags, void __user *, data)\n{\n......\n\tret = do_mount(kernel_dev, dir_name, kernel_type, flags, options);\n......\n}\n</code></pre><p>æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šdo_mount-&gt;do_new_mount-&gt;vfs_kern_mountã€‚</p><pre><code>struct vfsmount *\nvfs_kern_mount(struct file_system_type *type, int flags, const char *name, void *data)\n{\n......\n\tmnt = alloc_vfsmnt(name);\n......\n\troot = mount_fs(type, flags, name, data);\n......\n\tmnt-&gt;mnt.mnt_root = root;\n\tmnt-&gt;mnt.mnt_sb = root-&gt;d_sb;\n\tmnt-&gt;mnt_mountpoint = mnt-&gt;mnt.mnt_root;\n\tmnt-&gt;mnt_parent = mnt;\n\tlist_add_tail(&amp;mnt-&gt;mnt_instance, &amp;root-&gt;d_sb-&gt;s_mounts);\n\treturn &amp;mnt-&gt;mnt;\n}\n</code></pre><p>vfs_kern_mountå…ˆæ˜¯åˆ›å»ºstruct mountç»“æ„ï¼Œæ¯ä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿéƒ½å¯¹åº”äºè¿™æ ·ä¸€ä¸ªç»“æ„ã€‚</p><pre><code>struct mount {\n\tstruct hlist_node mnt_hash;\n\tstruct mount *mnt_parent;\n\tstruct dentry *mnt_mountpoint;\n\tstruct vfsmount mnt;\n\tunion {\n\t\tstruct rcu_head mnt_rcu;\n\t\tstruct llist_node mnt_llist;\n\t};\n\tstruct list_head mnt_mounts;\t/* list of children, anchored here */\n\tstruct list_head mnt_child;\t/* and going through their mnt_child */\n\tstruct list_head mnt_instance;\t/* mount instance on sb-&gt;s_mounts */\n\tconst char *mnt_devname;\t/* Name of device e.g. /dev/dsk/hda1 */\n\tstruct list_head mnt_list;\n......\n} __randomize_layout;\n\n\nstruct vfsmount {\n\tstruct dentry *mnt_root;\t/* root of the mounted tree */\n\tstruct super_block *mnt_sb;\t/* pointer to superblock */\n\tint mnt_flags;\n} __randomize_layout;\n</code></pre><p>å…¶ä¸­ï¼Œmnt_parentæ˜¯è£…è½½ç‚¹æ‰€åœ¨çš„çˆ¶æ–‡ä»¶ç³»ç»Ÿï¼Œmnt_mountpointæ˜¯è£…è½½ç‚¹åœ¨çˆ¶æ–‡ä»¶ç³»ç»Ÿä¸­çš„dentryï¼›struct dentryè¡¨ç¤ºç›®å½•ï¼Œå¹¶å’Œç›®å½•çš„inodeå…³è”ï¼›mnt_rootæ˜¯å½“å‰æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•çš„dentryï¼Œmnt_sbæ˜¯æŒ‡å‘è¶…çº§å—çš„æŒ‡é’ˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹è°ƒç”¨mount_fsæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€‚</p><pre><code>struct dentry *\nmount_fs(struct file_system_type *type, int flags, const char *name, void *data)\n{\n\tstruct dentry *root;\n\tstruct super_block *sb;\n......\n\troot = type-&gt;mount(type, flags, name, data);\n......\n\tsb = root-&gt;d_sb;\n......\n}\n</code></pre><p>è¿™é‡Œè°ƒç”¨çš„æ˜¯ext4_fs_typeçš„mountå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å’±ä»¬ä¸Šé¢æåˆ°çš„ext4_mountï¼Œä»æ–‡ä»¶ç³»ç»Ÿé‡Œé¢è¯»å–è¶…çº§å—ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ä¸­ï¼Œæ¯ä¸ªåœ¨ç¡¬ç›˜ä¸Šçš„ç»“æ„ï¼Œåœ¨å†…å­˜ä¸­ä¹Ÿå¯¹åº”ç›¸åŒæ ¼å¼çš„ç»“æ„ã€‚å½“æ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½è¯»åˆ°å†…å­˜é‡Œé¢ï¼Œå†…æ ¸å°±å¯ä»¥é€šè¿‡æ“ä½œè¿™äº›æ•°æ®ç»“æ„ï¼Œæ¥æ“ä½œæ–‡ä»¶ç³»ç»Ÿäº†ã€‚</p><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œç†è§£å„ä¸ªæ•°æ®ç»“æ„åœ¨è¿™é‡Œçš„å…³ç³»ï¼Œéå¸¸é‡è¦ã€‚æˆ‘è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæ¥è§£æç»è¿‡mountä¹‹åï¼Œåˆšåˆšé‚£äº›æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ã€‚</p><p>æˆ‘ä»¬å‡è®¾æ ¹æ–‡ä»¶ç³»ç»Ÿä¸‹é¢æœ‰ä¸€ä¸ªç›®å½•homeï¼Œæœ‰å¦å¤–ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸAæŒ‚è½½åœ¨è¿™ä¸ªç›®å½•homeä¸‹é¢ã€‚åœ¨æ–‡ä»¶ç³»ç»ŸAçš„æ ¹ç›®å½•ä¸‹é¢æœ‰å¦å¤–ä¸€ä¸ªæ–‡ä»¶å¤¹helloã€‚ç”±äºæ–‡ä»¶ç³»ç»ŸAå·²ç»æŒ‚è½½åˆ°äº†ç›®å½•homeä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æœ‰äº†ç›®å½•/home/helloï¼Œç„¶åæœ‰å¦å¤–ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸBæŒ‚è½½åœ¨/home/helloä¸‹é¢ã€‚åœ¨æ–‡ä»¶ç³»ç»ŸBçš„æ ¹ç›®å½•ä¸‹é¢æœ‰å¦å¤–ä¸€ä¸ªæ–‡ä»¶å¤¹worldï¼Œåœ¨worldä¸‹é¢æœ‰ä¸ªæ–‡ä»¶å¤¹dataã€‚ç”±äºæ–‡ä»¶ç³»ç»ŸBå·²ç»æŒ‚è½½åˆ°äº†/home/helloä¸‹é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æœ‰äº†ç›®å½•/home/hello/world/dataã€‚</p><p>ä¸ºäº†ç»´æŠ¤è¿™äº›å…³ç³»ï¼Œæ“ä½œç³»ç»Ÿåˆ›å»ºäº†è¿™ä¸€ç³»åˆ—æ•°æ®ç»“æ„ã€‚å…·ä½“ä½ å¯ä»¥çœ‹ä¸‹é¢çš„å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/66/27/663b3c5903d15fd9ba52f6d049e0dc27.jpeg?wh=5173*4114\" alt=\"\"></p><p>æ–‡ä»¶ç³»ç»Ÿæ˜¯æ ‘å½¢å…³ç³»ã€‚å¦‚æœæ‰€æœ‰çš„æ–‡ä»¶å¤¹éƒ½æ˜¯å‡ ä»£å•ä¼ ï¼Œé‚£å°±å˜æˆäº†ä¸€æ¡çº¿ã€‚ä½ æ³¨æ„çœ‹å›¾ä¸­çš„ä¸‰æ¡æ–œçº¿ã€‚</p><p>ç¬¬ä¸€æ¡çº¿æ˜¯æœ€å·¦è¾¹çš„å‘å·¦æ–œçš„<strong>dentryæ–œçº¿</strong>ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶å’Œæ–‡ä»¶å¤¹éƒ½æœ‰dentryï¼Œç”¨äºå’Œinodeå…³è”ã€‚ç¬¬äºŒæ¡çº¿æ˜¯æœ€å³é¢çš„å‘å³æ–œçš„<strong>mountæ–œçº¿</strong>ï¼Œå› ä¸ºè¿™ä¸ªä¾‹å­æ¶‰åŠä¸¤æ¬¡æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ï¼Œå†åŠ ä¸Šå¯åŠ¨çš„æ—¶å€™æŒ‚è½½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä¸€å…±ä¸‰ä¸ªmountã€‚ç¬¬ä¸‰æ¡çº¿æ˜¯ä¸­é—´çš„å‘å³æ–œçš„<strong>fileæ–œçº¿</strong>ï¼Œæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªfileç»“æ„ï¼Œå®ƒé‡Œé¢æœ‰ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæŒ‡å‘ç›¸åº”çš„mountï¼Œä¸€ä¸ªæŒ‡å‘ç›¸åº”çš„dentryã€‚</p><p>æˆ‘ä»¬ä»æœ€ä¸Šé¢å¾€ä¸‹çœ‹ã€‚æ ¹ç›®å½•/å¯¹åº”ä¸€ä¸ªdentryï¼Œæ ¹ç›®å½•æ˜¯åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™æŒ‚è½½çš„ï¼Œå› è€Œæœ‰ä¸€ä¸ªmountç»“æ„ã€‚è¿™ä¸ªmountç»“æ„çš„mount pointæŒ‡é’ˆå’Œmount rootæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘æ ¹ç›®å½•çš„dentryã€‚æ ¹ç›®å½•å¯¹åº”çš„fileçš„ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡å‘æ ¹ç›®å½•çš„dentryï¼Œä¸€ä¸ªæŒ‡å‘æ ¹ç›®å½•çš„æŒ‚è½½ç»“æ„mountã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒå±‚ã€‚ä¸‹ä¸€å±‚ç›®å½•homeå¯¹åº”äº†ä¸¤ä¸ªdentryï¼Œè€Œä¸”å®ƒä»¬çš„parentéƒ½æŒ‡å‘ç¬¬ä¸€å±‚çš„dentryã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæ–‡ä»¶ç³»ç»ŸAæŒ‚è½½åˆ°äº†è¿™ä¸ªç›®å½•ä¸‹ã€‚è¿™ä½¿å¾—è¿™ä¸ªç›®å½•æœ‰ä¸¤ä¸ªç”¨å¤„ã€‚ä¸€æ–¹é¢ï¼Œhomeæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼›å¦ä¸€æ–¹é¢ï¼Œhomeæ˜¯æ–‡ä»¶ç³»ç»ŸAçš„æ ¹ç›®å½•ã€‚</p><p>å› ä¸ºè¿˜æœ‰ä¸€æ¬¡æŒ‚è½½ï¼Œå› è€Œåˆæœ‰äº†ä¸€ä¸ªmountç»“æ„ã€‚è¿™ä¸ªmountç»“æ„çš„mount pointæŒ‡é’ˆæŒ‡å‘ä½œä¸ºæŒ‚è½½ç‚¹çš„é‚£ä¸ªdentryã€‚mount rootæŒ‡é’ˆæŒ‡å‘ä½œä¸ºæ ¹ç›®å½•çš„é‚£ä¸ªdentryï¼ŒåŒæ—¶parentæŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€å±‚çš„mountç»“æ„ã€‚homeå¯¹åº”çš„fileçš„ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡å‘æ–‡ä»¶ç³»ç»ŸAæ ¹ç›®å½•çš„dentryï¼Œä¸€ä¸ªæŒ‡å‘æ–‡ä»¶ç³»ç»ŸAçš„æŒ‚è½½ç»“æ„mountã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ç¬¬ä¸‰å±‚ã€‚ç›®å½•helloåˆæŒ‚è½½äº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸBï¼Œæ‰€ä»¥ç¬¬ä¸‰å±‚çš„ç»“æ„å’Œç¬¬äºŒå±‚å‡ ä¹ä¸€æ ·ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ç¬¬å››å±‚ã€‚ç›®å½•worldå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç›®å½•ã€‚åªè¦å®ƒçš„dentryçš„parentæŒ‡é’ˆæŒ‡å‘ä¸Šä¸€å±‚å°±å¯ä»¥äº†ã€‚æˆ‘ä»¬æ¥çœ‹worldå¯¹åº”çš„fileç»“æ„ã€‚ç”±äºæŒ‚è½½ç‚¹ä¸å˜ï¼Œè¿˜æ˜¯æŒ‡å‘ç¬¬ä¸‰å±‚çš„mountç»“æ„ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ç¬¬äº”å±‚ã€‚å¯¹äºæ–‡ä»¶dataï¼Œæ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ï¼Œå®ƒçš„dentryçš„parentæŒ‡å‘ç¬¬å››å±‚çš„dentryã€‚å¯¹äºdataå¯¹åº”çš„fileç»“æ„ï¼Œç”±äºæŒ‚è½½ç‚¹ä¸å˜ï¼Œè¿˜æ˜¯æŒ‡å‘ç¬¬ä¸‰å±‚çš„mountç»“æ„ã€‚</p><h2>æ‰“å¼€æ–‡ä»¶</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»åˆ†æOpenç³»ç»Ÿè°ƒç”¨è¯´èµ·ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/89251\">ç³»ç»Ÿè°ƒç”¨</a>çš„é‚£ä¸€èŠ‚ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è¿›ç¨‹é‡Œé¢é€šè¿‡openç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶ï¼Œæœ€ç»ˆå¯¹è°ƒç”¨åˆ°å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨å®ç°sys_openã€‚å½“æ—¶æˆ‘ä»¬ä»…ä»…è§£æäº†ç³»ç»Ÿè°ƒç”¨çš„åŸç†ï¼Œæ²¡æœ‰æ¥ç€åˆ†æä¸‹å»ï¼Œç°åœ¨æˆ‘ä»¬æ¥ç€åˆ†æè¿™ä¸ªè¿‡ç¨‹ã€‚</p><pre><code>SYSCALL_DEFINE3(open, const char __user *, filename, int, flags, umode_t, mode)\n{\n......\n\treturn do_sys_open(AT_FDCWD, filename, flags, mode);\n}\n\n\nlong do_sys_open(int dfd, const char __user *filename, int flags, umode_t mode)\n{\n......\n\tfd = get_unused_fd_flags(flags);\n\tif (fd &gt;= 0) {\n\t\tstruct file *f = do_filp_open(dfd, tmp, &amp;op);\n\t\tif (IS_ERR(f)) {\n\t\t\tput_unused_fd(fd);\n\t\t\tfd = PTR_ERR(f);\n\t\t} else {\n\t\t\tfsnotify_open(f);\n\t\t\tfd_install(fd, f);\n\t\t}\n\t}\n\tputname(tmp);\n\treturn fd;\n}\n</code></pre><p>è¦æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œé¦–å…ˆè¦é€šè¿‡get_unused_fd_flagså¾—åˆ°ä¸€ä¸ªæ²¡æœ‰ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚ä½•è·å–è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘¢ï¼Ÿ</p><p>åœ¨æ¯ä¸€ä¸ªè¿›ç¨‹çš„task_structä¸­ï¼Œæœ‰ä¸€ä¸ªæŒ‡é’ˆfilesï¼Œç±»å‹æ˜¯files_structã€‚</p><pre><code>struct files_struct\t\t*files;\n</code></pre><p>files_structé‡Œé¢æœ€é‡è¦çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œæ¯æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±ä¼šåœ¨è¿™ä¸ªåˆ—è¡¨ä¸­åˆ†é…ä¸€é¡¹ï¼Œä¸‹æ ‡å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ã€‚</p><pre><code>struct files_struct {\n......\n\tstruct file __rcu * fd_array[NR_OPEN_DEFAULT];\n};\n</code></pre><p>å¯¹äºä»»ä½•ä¸€ä¸ªè¿›ç¨‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ–‡ä»¶æè¿°ç¬¦0è¡¨ç¤ºstdinæ ‡å‡†è¾“å…¥ï¼Œæ–‡ä»¶æè¿°ç¬¦1è¡¨ç¤ºstdoutæ ‡å‡†è¾“å‡ºï¼Œæ–‡ä»¶æè¿°ç¬¦2è¡¨ç¤ºstderræ ‡å‡†é”™è¯¯è¾“å‡ºã€‚å¦å¤–ï¼Œå†æ‰“å¼€çš„æ–‡ä»¶ï¼Œéƒ½ä¼šä»è¿™ä¸ªåˆ—è¡¨ä¸­æ‰¾ä¸€ä¸ªç©ºé—²ä½ç½®åˆ†é…ç»™å®ƒã€‚</p><p>æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘struct fileçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªstruct fileå¯¹åº”ã€‚</p><p>do_sys_openä¸­è°ƒç”¨do_filp_openï¼Œå°±æ˜¯åˆ›å»ºè¿™ä¸ªstruct fileç»“æ„ï¼Œç„¶åfd_install(fd, f)æ˜¯å°†æ–‡ä»¶æè¿°ç¬¦å’Œè¿™ä¸ªç»“æ„å…³è”èµ·æ¥ã€‚</p><pre><code>struct file *do_filp_open(int dfd, struct filename *pathname,\n\t\tconst struct open_flags *op)\n{\n......\n\tset_nameidata(&amp;nd, dfd, pathname);\n\tfilp = path_openat(&amp;nd, op, flags | LOOKUP_RCU);\n......\n\trestore_nameidata();\n\treturn filp;\n}\n</code></pre><p>do_filp_opené‡Œé¢é¦–å…ˆåˆå§‹åŒ–äº†struct nameidataè¿™ä¸ªç»“æ„ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæ–‡ä»¶éƒ½æ˜¯ä¸€ä¸²çš„è·¯å¾„åç§°ï¼Œéœ€è¦é€ä¸ªè§£æã€‚è¿™ä¸ªç»“æ„åœ¨è§£æå’ŒæŸ¥æ‰¾è·¯å¾„çš„æ—¶å€™æä¾›è¾…åŠ©ä½œç”¨ã€‚</p><p>åœ¨struct nameidataé‡Œé¢æœ‰ä¸€ä¸ªå…³é”®çš„æˆå‘˜å˜é‡struct pathã€‚</p><pre><code>struct path {\n\tstruct vfsmount *mnt;\n\tstruct dentry *dentry;\n} __randomize_layout;\n</code></pre><p>å…¶ä¸­ï¼Œstruct vfsmountå’Œæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æœ‰å…³ã€‚å¦ä¸€ä¸ªstruct dentryï¼Œé™¤äº†ä¸Šé¢è¯´çš„ç”¨äºæ ‡è¯†ç›®å½•ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è¡¨ç¤ºæ–‡ä»¶åï¼Œè¿˜ä¼šå»ºç«‹æ–‡ä»¶ååŠå…¶inodeä¹‹é—´çš„å…³è”ã€‚</p><p>æ¥ä¸‹æ¥å°±è°ƒç”¨path_openatï¼Œä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p><ul>\n<li>get_empty_filpç”Ÿæˆä¸€ä¸ªstruct fileç»“æ„ï¼›</li>\n<li>path_initåˆå§‹åŒ–nameidataï¼Œå‡†å¤‡å¼€å§‹èŠ‚ç‚¹è·¯å¾„æŸ¥æ‰¾ï¼›</li>\n<li>link_path_walkå¯¹äºè·¯å¾„åé€å±‚è¿›è¡ŒèŠ‚ç‚¹è·¯å¾„æŸ¥æ‰¾ï¼Œè¿™é‡Œé¢æœ‰ä¸€ä¸ªå¤§çš„å¾ªç¯ï¼Œç”¨â€œ/â€åˆ†éš”é€å±‚å¤„ç†ï¼›</li>\n<li>do_lastè·å–æ–‡ä»¶å¯¹åº”çš„inodeå¯¹è±¡ï¼Œå¹¶ä¸”åˆå§‹åŒ–fileå¯¹è±¡ã€‚</li>\n</ul><pre><code>static struct file *path_openat(struct nameidata *nd,\n\t\t\tconst struct open_flags *op, unsigned flags)\n{\n......\n\tfile = get_empty_filp();\n......\n\ts = path_init(nd, flags);\n......\n\twhile (!(error = link_path_walk(s, nd)) &amp;&amp;\n\t\t(error = do_last(nd, file, op, &amp;opened)) &gt; 0) {\n......\n\t}\n\tterminate_walk(nd);\n......\n\treturn file;\n}\n</code></pre><p>ä¾‹å¦‚ï¼Œæ–‡ä»¶â€œ/root/hello/world/dataâ€ï¼Œlink_path_walkä¼šè§£æå‰é¢çš„è·¯å¾„éƒ¨åˆ†â€œ/root/hello/worldâ€ï¼Œè§£æå®Œæ¯•çš„æ—¶å€™nameidataçš„dentryä¸ºè·¯å¾„åçš„æœ€åä¸€éƒ¨åˆ†çš„çˆ¶ç›®å½•â€œ/root/hello/worldâ€ï¼Œè€Œnameidataçš„filenameä¸ºè·¯å¾„åçš„æœ€åä¸€éƒ¨åˆ†â€œdataâ€ã€‚</p><p>æœ€åä¸€éƒ¨åˆ†çš„è§£æå’Œå¤„ç†ï¼Œæˆ‘ä»¬äº¤ç»™do_lastã€‚</p><pre><code>static int do_last(struct nameidata *nd,\n\t\t   struct file *file, const struct open_flags *op,\n\t\t   int *opened)\n{\n......\n\terror = lookup_fast(nd, &amp;path, &amp;inode, &amp;seq);\n......\n    error = lookup_open(nd, &amp;path, file, op, got_write, opened);\n......\n\terror = vfs_open(&amp;nd-&gt;path, file, current_cred());\n......\n}\n</code></pre><p>åœ¨è¿™é‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŸ¥æ‰¾æ–‡ä»¶è·¯å¾„æœ€åä¸€éƒ¨åˆ†å¯¹åº”çš„dentryã€‚å¦‚ä½•æŸ¥æ‰¾å‘¢ï¼Ÿ</p><p>Linuxä¸ºäº†æé«˜ç›®å½•é¡¹å¯¹è±¡çš„å¤„ç†æ•ˆç‡ï¼Œè®¾è®¡ä¸å®ç°äº†ç›®å½•é¡¹é«˜é€Ÿç¼“å­˜dentry cacheï¼Œç®€ç§°dcacheã€‚å®ƒä¸»è¦ç”±ä¸¤ä¸ªæ•°æ®ç»“æ„ç»„æˆï¼š</p><ul>\n<li>å“ˆå¸Œè¡¨dentry_hashtableï¼šdcacheä¸­çš„æ‰€æœ‰dentryå¯¹è±¡éƒ½é€šè¿‡d_hashæŒ‡é’ˆé“¾åˆ°ç›¸åº”çš„dentryå“ˆå¸Œé“¾è¡¨ä¸­ï¼›</li>\n<li>æœªä½¿ç”¨çš„dentryå¯¹è±¡é“¾è¡¨s_dentry_lruï¼šdentryå¯¹è±¡é€šè¿‡å…¶d_lruæŒ‡é’ˆé“¾å…¥LRUé“¾è¡¨ä¸­ã€‚LRUçš„æ„æ€æ˜¯æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œæˆ‘ä»¬å·²ç»å¥½å‡ æ¬¡çœ‹åˆ°å®ƒäº†ã€‚åªè¦æœ‰å®ƒï¼Œå°±è¯´æ˜é•¿æ—¶é—´ä¸ä½¿ç”¨ï¼Œå°±åº”è¯¥é‡Šæ”¾äº†ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/82/59/82dd76e1e84915206eefb8fc88385859.jpeg?wh=1804*3043\" alt=\"\"></p><p>è¿™ä¸¤ä¸ªåˆ—è¡¨ä¹‹é—´ä¼šäº§ç”Ÿå¤æ‚çš„å…³ç³»ï¼š</p><ul>\n<li>å¼•ç”¨ä¸º0ï¼šä¸€ä¸ªåœ¨æ•£åˆ—è¡¨ä¸­çš„dentryå˜æˆæ²¡æœ‰äººå¼•ç”¨äº†ï¼Œå°±ä¼šè¢«åŠ åˆ°LRUè¡¨ä¸­å»ï¼›</li>\n<li>å†æ¬¡è¢«å¼•ç”¨ï¼šä¸€ä¸ªåœ¨LRUè¡¨ä¸­çš„dentryå†æ¬¡è¢«å¼•ç”¨äº†ï¼Œåˆ™ä»LRUè¡¨ä¸­ç§»é™¤ï¼›</li>\n<li>åˆ†é…ï¼šå½“dentryåœ¨æ•£åˆ—è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä»Slubåˆ†é…å™¨ä¸­åˆ†é…ä¸€ä¸ªï¼›</li>\n<li>è¿‡æœŸå½’è¿˜ï¼šå½“LRUè¡¨ä¸­æœ€é•¿æ—¶é—´æ²¡æœ‰ä½¿ç”¨çš„dentryåº”è¯¥é‡Šæ”¾å›Slubåˆ†é…å™¨ï¼›</li>\n<li>æ–‡ä»¶åˆ é™¤ï¼šæ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œç›¸åº”çš„dentryåº”è¯¥é‡Šæ”¾å›Slubåˆ†é…å™¨ï¼›</li>\n<li>ç»“æ„å¤ç”¨ï¼šå½“éœ€è¦åˆ†é…ä¸€ä¸ªdentryï¼Œä½†æ˜¯æ— æ³•åˆ†é…æ–°çš„ï¼Œå°±ä»LRUè¡¨ä¸­å–å‡ºä¸€ä¸ªæ¥å¤ç”¨ã€‚</li>\n</ul><p>æ‰€ä»¥ï¼Œdo_last()åœ¨æŸ¥æ‰¾dentryçš„æ—¶å€™ï¼Œå½“ç„¶å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œè°ƒç”¨çš„æ˜¯lookup_fastã€‚</p><p>å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±éœ€è¦çœŸçš„åˆ°æ–‡ä»¶ç³»ç»Ÿé‡Œé¢å»æ‰¾äº†ï¼Œlookup_openä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„dentryï¼Œå¹¶ä¸”è°ƒç”¨ä¸Šä¸€çº§ç›®å½•çš„Inodeçš„inode_operationsçš„lookupå‡½æ•°ï¼Œå¯¹äºext4æ¥è®²ï¼Œè°ƒç”¨çš„æ˜¯ext4_lookupï¼Œä¼šåˆ°å’±ä»¬ä¸Šä¸€èŠ‚è®²çš„æ–‡ä»¶ç³»ç»Ÿé‡Œé¢å»æ‰¾inodeã€‚æœ€ç»ˆæ‰¾åˆ°åå°†æ–°ç”Ÿæˆçš„dentryèµ‹ç»™pathå˜é‡ã€‚</p><pre><code>static int lookup_open(struct nameidata *nd, struct path *path,\n\t\t\tstruct file *file,\n\t\t\tconst struct open_flags *op,\n\t\t\tbool got_write, int *opened)\n{\n    ......\n    dentry = d_alloc_parallel(dir, &amp;nd-&gt;last, &amp;wq);\n    ......\n    struct dentry *res = dir_inode-&gt;i_op-&gt;lookup(dir_inode, dentry,\n\t\t\t\t\t\t\t     nd-&gt;flags);\n    ......\n    path-&gt;dentry = dentry;\n\tpath-&gt;mnt = nd-&gt;path.mnt;\n}\n\n\n\n\nconst struct inode_operations ext4_dir_inode_operations = {\n\t.create\t\t= ext4_create,\n\t.lookup\t\t= ext4_lookup,\n...\n</code></pre><p>do_last()çš„æœ€åä¸€æ­¥æ˜¯è°ƒç”¨vfs_opençœŸæ­£æ‰“å¼€æ–‡ä»¶ã€‚</p><pre><code>int vfs_open(const struct path *path, struct file *file,\n\t     const struct cred *cred)\n{\n\tstruct dentry *dentry = d_real(path-&gt;dentry, NULL, file-&gt;f_flags, 0);\n......\n\tfile-&gt;f_path = *path;\n\treturn do_dentry_open(file, d_backing_inode(dentry), NULL, cred);\n}\n\n\nstatic int do_dentry_open(struct file *f,\n\t\t\t  struct inode *inode,\n\t\t\t  int (*open)(struct inode *, struct file *),\n\t\t\t  const struct cred *cred)\n{\n......\n\tf-&gt;f_mode = OPEN_FMODE(f-&gt;f_flags) | FMODE_LSEEK |\n\t\t\t\tFMODE_PREAD | FMODE_PWRITE;\n\tpath_get(&amp;f-&gt;f_path);\n\tf-&gt;f_inode = inode;\n\tf-&gt;f_mapping = inode-&gt;i_mapping;\n......\n\tf-&gt;f_op = fops_get(inode-&gt;i_fop);\n......\n\topen = f-&gt;f_op-&gt;open;\n......\n\terror = open(inode, f);\n......\n\tf-&gt;f_flags &amp;= ~(O_CREAT | O_EXCL | O_NOCTTY | O_TRUNC);\n\tfile_ra_state_init(&amp;f-&gt;f_ra, f-&gt;f_mapping-&gt;host-&gt;i_mapping);\n\treturn 0;\n......\n}\n\n\nconst struct file_operations ext4_file_operations = {\n......\n\t.open\t\t= ext4_file_open,\n......\n};\n\n</code></pre><p>vfs_opené‡Œé¢æœ€ç»ˆè¦åšçš„ä¸€ä»¶äº‹æƒ…æ˜¯ï¼Œè°ƒç”¨f_op-&gt;openï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ext4_file_openã€‚å¦å¤–ä¸€ä»¶é‡è¦çš„äº‹æƒ…æ˜¯å°†æ‰“å¼€æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¡«å†™åˆ°struct fileè¿™ä¸ªç»“æ„é‡Œé¢ã€‚</p><pre><code>struct file {\n\tunion {\n\t\tstruct llist_node\tfu_llist;\n\t\tstruct rcu_head \tfu_rcuhead;\n\t} f_u;\n\tstruct path\t\tf_path;\n\tstruct inode\t\t*f_inode;\t/* cached value */\n\tconst struct file_operations\t*f_op;\n\tspinlock_t\t\tf_lock;\n\tenum rw_hint\t\tf_write_hint;\n\tatomic_long_t\t\tf_count;\n\tunsigned int \t\tf_flags;\n\tfmode_t\t\t\tf_mode;\n\tstruct mutex\t\tf_pos_lock;\n\tloff_t\t\t\tf_pos;\n\tstruct fown_struct\tf_owner;\n\tconst struct cred\t*f_cred;\n......\n\tstruct address_space\t*f_mapping;\n\terrseq_t\t\tf_wb_err;\n}\n</code></pre><h2>æ€»ç»“æ—¶åˆ»</h2><p>å¯¹äºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„è§£æå°±åˆ°è¿™é‡Œäº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæœ‰å…³æ–‡ä»¶çš„æ•°æ®ç»“æ„å±‚æ¬¡å¤šï¼Œè€Œä¸”å¾ˆå¤æ‚ï¼Œå°±å¾—åˆ°äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œè¿™å¼ å›¾åœ¨è¿™ä¸ªä¸“æ æœ€å¼€å§‹çš„æ—¶å€™ï¼Œå·²ç»å±•ç¤ºè¿‡ä¸€éï¼Œåˆ°è¿™é‡Œï¼Œä½ åº”è¯¥èƒ½æ˜ç™½å®ƒä»¬ä¹‹é—´çš„å…³ç³»äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/80/b9/8070294bacd74e0ac5ccc5ac88be1bb9.png?wh=4819*2602\" alt=\"\"></p><p>è¿™å¼ å›¾ååˆ†é‡è¦ï¼Œä¸€å®šè¦æŒæ¡ã€‚å› ä¸ºæˆ‘ä»¬åé¢çš„å­—ç¬¦è®¾å¤‡ã€å—è®¾å¤‡ã€ç®¡é“ã€è¿›ç¨‹é—´é€šä¿¡ã€ç½‘ç»œç­‰ç­‰ï¼Œå…¨éƒ¨éƒ½è¦ç”¨åˆ°è¿™é‡Œé¢çš„çŸ¥è¯†ã€‚å¸Œæœ›å½“ä½ å†æ¬¡é‡åˆ°å®ƒçš„æ—¶å€™ï¼Œèƒ½å¤Ÿé©¬ä¸Šè¯´å‡ºå„ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»ã€‚</p><p>è¿™é‡Œæˆ‘å¸¦ä½ ç®€å•åšä¸€ä¸ªæ¢³ç†ï¼Œå¸®åŠ©ä½ ç†è§£è®°å¿†å®ƒã€‚</p><p>å¯¹äºæ¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰“å¼€çš„æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåœ¨files_structé‡Œé¢ä¼šæœ‰æ–‡ä»¶æè¿°ç¬¦æ•°ç»„ã€‚æ¯ä¸ªä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯è¿™ä¸ªæ•°ç»„çš„ä¸‹æ ‡ï¼Œé‡Œé¢çš„å†…å®¹æŒ‡å‘ä¸€ä¸ªfileç»“æ„ï¼Œè¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶ã€‚è¿™ä¸ªç»“æ„é‡Œé¢æœ‰è¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„inodeï¼Œæœ€é‡è¦çš„æ˜¯è¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„æ“ä½œfile_operationã€‚å¦‚æœæ“ä½œè¿™ä¸ªæ–‡ä»¶ï¼Œå°±çœ‹è¿™ä¸ªfile_operationé‡Œé¢çš„å®šä¹‰äº†ã€‚</p><p>å¯¹äºæ¯ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œéƒ½æœ‰ä¸€ä¸ªdentryå¯¹åº”ï¼Œè™½ç„¶å«ä½œdirectory entryï¼Œä½†æ˜¯ä¸ä»…ä»…è¡¨ç¤ºæ–‡ä»¶å¤¹ï¼Œä¹Ÿè¡¨ç¤ºæ–‡ä»¶ã€‚å®ƒæœ€é‡è¦çš„ä½œç”¨å°±æ˜¯æŒ‡å‘è¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„inodeã€‚</p><p>å¦‚æœè¯´fileç»“æ„æ˜¯ä¸€ä¸ªæ–‡ä»¶æ‰“å¼€ä»¥åæ‰åˆ›å»ºçš„ï¼Œdentryæ˜¯æ”¾åœ¨ä¸€ä¸ªdentry cacheé‡Œé¢çš„ï¼Œæ–‡ä»¶å…³é—­äº†ï¼Œä»–ä¾ç„¶å­˜åœ¨ï¼Œå› è€Œä»–å¯ä»¥æ›´é•¿æœŸåœ°ç»´æŠ¤å†…å­˜ä¸­çš„æ–‡ä»¶çš„è¡¨ç¤ºå’Œç¡¬ç›˜ä¸Šæ–‡ä»¶çš„è¡¨ç¤ºä¹‹é—´çš„å…³ç³»ã€‚</p><p>inodeç»“æ„å°±è¡¨ç¤ºç¡¬ç›˜ä¸Šçš„inodeï¼ŒåŒ…æ‹¬å—è®¾å¤‡å·ç­‰ã€‚</p><p>å‡ ä¹æ¯ä¸€ç§ç»“æ„éƒ½æœ‰è‡ªå·±å¯¹åº”çš„operationç»“æ„ï¼Œé‡Œé¢éƒ½æ˜¯ä¸€äº›æ–¹æ³•ï¼Œå› è€Œå½“åé¢é‡åˆ°å¯¹äºæŸç§ç»“æ„è¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œå¦‚æœä¸å®¹æ˜“æ‰¾åˆ°ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œå°±å…ˆæ‰¾è¿™ä¸ªoperationç»“æ„ï¼Œå°±æ¸…æ¥šäº†ã€‚</p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ä¸Šä¸€èŠ‚çš„æ€»ç»“ä¸­ï¼Œæˆ‘ä»¬è¯´ï¼ŒåŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„å¯¹åº”å…³ç³»ã€‚å¦‚æœè·¨çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œä½ çŸ¥é“å¦‚ä½•ç»´æŠ¤è¿™ç§æ˜ å°„å…³ç³»å—ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659\" alt=\"\"></p>","comments":[{"had_liked":false,"id":100577,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1559597835,"is_pvip":false,"replies":[{"id":"37048","content":"èµï¼Œè¿™ä¸ªæ€è·¯å¥½å•Š","user_name":"ä½œè€…å›å¤","comment_id":100577,"uid":"1001590","ip_address":"","utype":1,"ctime":1560255727,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"134703584011","product_id":100024701,"comment_content":"æ–‡ç« çš„æ ¸å¿ƒå°±æ˜¯æŠŠç£ç›˜æ–‡ä»¶æ•°æ®æ˜ å°„åˆ°è¿›ç¨‹ä¸­ï¼Œå¯ä»¥æŠŠåœ¨ç£ç›˜çš„æ–‡ä»¶ç»„ç»‡çœ‹æˆä¸€ç§åè®®ï¼Œå†…å­˜ä¸­è¿›ç¨‹ä¸­çš„æ–‡ä»¶ç»„ç»‡å½¢å¼çœ‹æˆå¦å¤–ä¸€ç§åè®®ï¼Œå†…æ ¸å°±æ˜¯è¿™ä¸¤ä¸ªåè®®çš„ä¸­è½¬proxy,å¸¦ç€è¿™ä¸ªä¸»çº¿çœ‹æ–‡ç« æ€è·¯è¦æ˜æœ—ä¸€äº›<br>  inodeå’Œdentryåœ¨ä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„æ—¶å€™æ€ä¹ˆåˆå§‹åŒ–å’Œåšå¥½æ˜ å°„å…³ç³»ï¼Œè¿™ä¸ªæ˜¯éš¾ç‚¹ï¼Œæˆ‘ä¸€å¼€å§‹ä¹Ÿçœ‹æ‡µé€¼äº†ï¼Œåæ¥ä¸€æƒ³ï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿä¸æ˜¯æŒ‚è½½äº†å„ç§ç£ç›˜åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿä¹ˆï¼Œè¿™ä¸ªè€å¸ˆå¦‚æœç»“åˆcentosçš„xfsæ ¹æ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œå¯ä»¥æŒ‚è½½ext4çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ªç£ç›˜åˆ†åŒºæ¼”ç¤ºæŒ‚è½½ï¼Œç„¶ååˆ†æï¼Œå¯èƒ½å¤§å®¶æ›´å¥½ç†è§£ï¼Œæ¯•ç«Ÿå¹³æ—¶å¤§å®¶éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ ¼å¼èµ°åˆ°é»‘ï¼Œä¸ªäººå»ºè®®è¿™ç§å¤æ‚é€»è¾‘å…³ç³»æ¯”å¦‚é‚£ä¸ªæŒ‚è½½å›¾å¯ä»¥æ‹ä¸ªåŠ¨æ€å›¾å’Œè§†é¢‘ï¼Œå‘ä¸ªé“¾æ¥è®©å¤§å®¶å»çœ‹çœ‹ï¼Œ<br>  ","like_count":32,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452607,"discussion_content":"èµï¼Œè¿™ä¸ªæ€è·¯å¥½å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560255727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228194,"user_name":"Geek_ty","can_delete":false,"product_type":"c1","uid":1587280,"ip_address":"","ucode":"F8178B6B09D628","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epZhOmpZpicOzalVU7kibd59dMJc25N9cfGu9icBAIUPzYNYDedtzlYHZBiazaYiadgqvlotrjM4CA6KOQ/132","comment_is_top":false,"comment_ctime":1592585625,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"74607029657","product_id":100024701,"comment_content":"æ„Ÿè§‰æ–‡ä»¶ç³»ç»Ÿå‡ ç¯‡æ–‡ç« è¿˜æœ‰å¾ˆå¤§æå‡ç©ºé—´ï¼Œæ•´ä½“é€»è¾‘ä¸Šåº”è¯¥æœ‰æ‰€è°ƒæ•´æ‰èƒ½æ›´å®¹æ˜“è®©äººçœ‹æ‡‚ã€‚å¦å¤–åœ¨æœ‰äº›æ–¹é¢ä»‹ç»çš„ä¸å¤Ÿè¯¦ç»†ï¼Œå¦‚dentryç­‰å¹¶æ²¡æœ‰ç»™å‡ºè¯´æ˜ã€‚é™¤æ­¤ä¹‹å¤–è¿˜å¿½ç•¥äº†å¾ˆå¤šï¼Œå¦‚ext4_inode_infoå’Œext4_inodeæ˜¯ä»€ä¹ˆå…³ç³»ï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿå’Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•å»ºç«‹å…³ç³»ï¼Œå…¶è®¾è®¡çš„è‰ºæœ¯çš„åˆ†æã€‚å¸Œæœ›ä½œè€…æœ‰ç©ºçš„è¯å¯ä»¥æ•´ç†æ•´ç†æé«˜ä¸€ä¸‹ï¼Œå†™çš„æ›´èƒ½ç”±æµ…å…¥æ·±ã€‚","like_count":18},{"had_liked":false,"id":101205,"user_name":"çƒˆæ—¥èé›ª","can_delete":false,"product_type":"c1","uid":1131925,"ip_address":"","ucode":"E462E30FB0AFC0","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/95/968fd89f.jpg","comment_is_top":false,"comment_ctime":1559741251,"is_pvip":false,"replies":[{"id":"37036","content":"èµ","user_name":"ä½œè€…å›å¤","comment_id":101205,"uid":"1001590","ip_address":"","utype":1,"ctime":1560255464,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"74574185283","product_id":100024701,"comment_content":"ç»“åˆã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹è¿™æœ¬ä¹¦ è¿›å…¥çŠ¶æ€æ›´å¿«","like_count":18,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452851,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560255464,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2311161,"avatar":"","nickname":"ç¨»è‰äºº","note":"","ucode":"C5DF5B2437C97B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376752,"discussion_content":"çœ‹å®Œè¿™ä¸ªä¸“æ ï¼Œå»çœ‹è¿™æœ¬ä¹¦ï¼Œä¼šè½»æ¾å¾ˆå¤šï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622310462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101064,"user_name":"why","can_delete":false,"product_type":"c1","uid":1012937,"ip_address":"","ucode":"C9E796E53F6F5E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/74/c9/d3439ca4.jpg","comment_is_top":false,"comment_ctime":1559707921,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"44509380881","product_id":100024701,"comment_content":"- å¤šå±‚ç»„ä»¶ç»Ÿä¸€å®Œæˆè¿›è¡Œè¯»å†™æ–‡ä»¶çš„ä»»åŠ¡<br>    - ç³»ç»Ÿè°ƒç”¨ sys_open, sys_read ç­‰<br>    - è¿›ç¨‹ç»´æŠ¤æ‰“å¼€çš„æ–‡ä»¶æ•°æ®ç»“æ„, ç³»ç»Ÿç»´æŠ¤æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æ•°æ®ç»“æ„<br>    - Linux æä¾›ç»Ÿä¸€çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ¥å£; ä¾‹å¦‚ inode, directory entry, mount, ä»¥åŠå¯¹åº”æ“ä½œ inode  operationsç­‰, å› æ­¤å¯ä»¥åŒæ—¶æ”¯æŒæ•°åç§ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿ<br>    - vfs é€šè¿‡è®¾å¤‡ I&#47;O å±‚åœ¨é€šè¿‡å—è®¾å¤‡é©±åŠ¨ç¨‹åºè®¿é—®ç¡¬ç›˜æ–‡ä»¶ç³»ç»Ÿ<br>    - é€šè¿‡ç¼“å­˜å±‚åŠ å¿«å—è®¾å¤‡è¯»å†™<br>- é€šè¿‡è§£æç³»ç»Ÿè°ƒç”¨äº†è§£å†…æ ¸æ¶æ„<br>- æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ mount<br>    - æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿ register_filesystem åæ‰èƒ½æŒ‚è½½<br>    - è°ƒç”¨é“¾ mount-&gt;do_mount-&gt;do_new_mountâ†’vfs_kern_mount<br>    - é¦–å…ˆåˆ›å»º struct mount<br>        - å…¶ä¸­ mnt_parent æŒ‡å‘çˆ¶ fs çš„ mount; mnt_parentpoint æŒ‡å‘çˆ¶ fs çš„ dentry<br>        - ç”¨ dentry è¡¨ç¤ºç›®å½•, å¹¶å’Œç›®å½•çš„ inode å…³è”<br>        - mnt_root æŒ‡å‘å½“å‰ fs æ ¹ç›®å½•çš„ dentry; è¿˜æœ‰ vfsmount æŒ‡å‘æŒ‚è½½æ ‘ root å’Œè¶…çº§å—<br>    - è°ƒç”¨ mount_fs è¿›è¡ŒæŒ‚è½½<br>        - è°ƒç”¨ ext4_fs_typeâ†’mount(ext4_mount),  è¯»å–è¶…çº§å—åˆ°å†…å­˜<br>        - æ–‡ä»¶å’Œæ–‡ä»¶å¤¹éƒ½æœ‰ä¸€ä¸ª dentry, ç”¨äºä¸ inode å…³è”, æ¯ä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿéƒ½ç”±ä¸€ä¸ª mount æè¿°; æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½ç”± file ç»“æ„æè¿°, å…¶æŒ‡å‘ dentry å’Œ mount.<br>        - äºŒå±‚æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•æœ‰ä¸¤ä¸ª dentry, ä¸€ä¸ªè¡¨ç¤ºæŒ‚è½½ç‚¹, å¦ä¸€ä¸ªæ˜¯ä¸Šå±‚ fs çš„ç›®å½•.<br>- æ‰“å¼€æ–‡ä»¶ sys_open<br>    - å…ˆè·å–ä¸€ä¸ªæœªä½¿ç”¨çš„ fd, å…¶ä¸­ task_struct.files.fd_array[] ä¸­æ¯ä¸€é¡¹æŒ‡å‘æ‰“å¼€æ–‡ä»¶çš„ struct file, å…¶ä¸­ fd ä½œä¸ºä¸‹æ ‡. é»˜è®¤ 0â†’stdin, 1â†’stdout, 2â†’stderr<br>    - è°ƒç”¨ do_sys_open-&gt;do_flip_open<br>        - å…ˆåˆå§‹åŒ– nameidata, è§£ææ–‡ä»¶è·¯å¾„å; æ¥ç€è°ƒç”¨ path_openat<br>            - ç”Ÿæˆ struct file ç»“æ„; åˆå§‹åŒ– nameidata, å‡†å¤‡æŸ¥æ‰¾<br>            - link_path_walk æ ¹æ®è·¯å¾„åé€å±‚æŸ¥æ‰¾<br>            - do_last è·å–æ–‡ä»¶ inode, åˆå§‹åŒ– file<br>        - æŸ¥æ‰¾è·¯å¾„æœ€åä¸€éƒ¨åˆ†å¯¹åº”çš„ dentry<br>            - Linux é€šè¿‡ç›®å½•é¡¹é«˜é€Ÿç¼“å­˜ dentry cache(dentry) æé«˜æ•ˆç‡. ç”±ä¸¤ä¸ªæ•°æ®ç»“æ„ç»„æˆ<br>                - å“ˆå¸Œè¡¨: dentry_hashtable; å¼•ç”¨å˜ä¸º 0 ååŠ å…¥ lru é“¾è¡¨; dentry æ²¡æ‰¾åˆ°åˆ™ä» slub åˆ†é…; æ— æ³•åˆ†é…åˆ™ä» lru ä¸­è·å–; æ–‡ä»¶åˆ é™¤é‡Šæ”¾ dentry;<br>                - æœªä½¿ç”¨çš„ dentry lru é“¾è¡¨; å†æ¬¡è¢«å¼•ç”¨è¿”å›å“ˆå¸Œè¡¨; dentry è¿‡æœŸè¿”å›ç»™ slub åˆ†é…å™¨<br>            - do_last å…ˆä»ç¼“å­˜æŸ¥æ‰¾ dentry, è‹¥æ²¡æ‰¾åˆ°åœ¨ä»æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾å¹¶åˆ›å»º dentry, å†èµ‹ç»™ nameidata çš„ path.dentry; æœ€åè°ƒç”¨ vfs_open çœŸæ­£æ‰“å¼€æ–‡ä»¶<br>            - vfs_open ä¼šè°ƒç”¨ f_op-&gt;open å³ ext4_file_open, è¿˜å°†æ–‡ä»¶ä¿¡æ¯å­˜å…¥ struct file ä¸­.<br>        - è®¸å¤šç»“æ„ä½“ä¸­éƒ½æœ‰è‡ªå·±å¯¹åº”çš„ operation ç»“æ„, æ–¹ä¾¿è°ƒç”¨å¯¹åº”çš„å‡½æ•°è¿›è¡Œå¤„ç†","like_count":11},{"had_liked":false,"id":100612,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1559606284,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23034442764","product_id":100024701,"comment_content":"æˆ‘å†è¡¥å……æ€»ç»“ä¸€ä¸‹<br>ç¬¬ä¸€ æ–‡ç« è®²çš„æ˜¯æ ¼å¼åŒ–ä¸€ä¸ªç£ç›˜å¹¶ä¸”mountåˆ°ç³»ç»Ÿæ ¹ç›®å½•<br>ç¬¬äºŒ è¿›ç¨‹åˆ›å»ºè¿‡ç¨‹ä¸­è·Ÿæ–‡ä»¶çš„äº¤äº’è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æ‰“å¼€ï¼Œåˆ›å»ºï¼Œå½“ç„¶ä¿®æ”¹åˆ é™¤è€å¸ˆæ²¡è®²<br>è¿›åŸæ–‡ä»¶ç³»ç»Ÿè¿™ä¸ªæˆ‘æœ‰ç‚¹ç–‘æƒ‘ä¹‹å‰è€å¸ˆè®²è¿›ç¨‹task structæœ‰æè¿‡ï¼Œå¸Œæœ›è€å¸ˆæŒ‡ç‚¹æŒ‡ç‚¹<br>å¤§å®¶å¯ä»¥è‡ªå·±æ ¼å¼åŒ–ä¸€ä¸ªç›˜ext4ï¼Œç„¶åstrace mount &#47;dev&#47;sdc &#47;test_flash &gt; mntout 2&gt;&amp;1<br>æˆ‘è¿½è¸ªçš„å…³äºmountçš„å¦‚ä¸‹<br>execve(&quot;&#47;bin&#47;mount&quot;, [&quot;mount&quot;, &quot;&#47;dev&#47;sdc&quot;, &quot;&#47;test_flash&quot;], [&#47;* 26 vars *&#47;]) = 0<br>open(&quot;&#47;lib64&#47;libmount.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3<br>lstat(&quot;&#47;run&#47;mount&#47;utab&quot;, 0x7ffebb0a8130) = -1 ENOENT (No such file or directory)<br>mkdir(&quot;&#47;run&#47;mount&quot;, 0755)               = -1 EEXIST (File exists)<br>stat(&quot;&#47;run&#47;mount&#47;utab&quot;, 0x7ffebb0a8020) = -1 ENOENT (No such file or directory)<br>stat(&quot;&#47;run&#47;mount&quot;, {st_mode=S_IFDIR|0755, st_size=40, ...}) = 0<br>access(&quot;&#47;run&#47;mount&quot;, R_OK|W_OK)         = 0<br>stat(&quot;&#47;sbin&#47;mount.ext4&quot;, 0x7ffebb0a6fc0) = -1 ENOENT (No such file or directory)<br>stat(&quot;&#47;sbin&#47;fs.d&#47;mount.ext4&quot;, 0x7ffebb0a6fc0) = -1 ENOENT (No such file or directory)<br>stat(&quot;&#47;sbin&#47;fs&#47;mount.ext4&quot;, 0x7ffebb0a6fc0) = -1 ENOENT (No such file or directory)<br>mount(&quot;&#47;dev&#47;sdc&quot;, &quot;&#47;test_flash&quot;, &quot;ext4&quot;, MS_MGC_VAL, NULL) = 0<br>","like_count":6},{"had_liked":false,"id":151107,"user_name":"æ·±å¯’è‰²çš„çŒ«ä¸¶","can_delete":false,"product_type":"c1","uid":1183264,"ip_address":"","ucode":"869A2AB044E0D2","user_header":"https://static001.geekbang.org/account/avatar/00/12/0e/20/bf8d71c3.jpg","comment_is_top":false,"comment_ctime":1573654230,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"18753523414","product_id":100024701,"comment_content":"è€å¸ˆï¼Œä½ è¯´dentryæœ€é‡è¦çš„ä½œç”¨æ˜¯æŒ‡å‘inodeï¼Œä½†æ˜¯ struct fileä¸æ˜¯å·²ç»æŒ‡å‘inodeäº†ä¹ˆ","like_count":5,"discussions":[{"author":{"id":1253128,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/08/14642f9e.jpg","nickname":"ç›¸æœ›äºæ±Ÿæ¹–","note":"","ucode":"9CCB6F89F92C89","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552286,"discussion_content":"åªæ˜¯ä¸ºäº†æ–¹ä¾¿è·¯å¾„æŸ¥æ‰¾å’Œå¤ç”¨è€Œå·²ï¼Œdentryæœ‰ç¼“å­˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645373217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1203671,"avatar":"","nickname":"é£é€æ®‹å¶_c","note":"","ucode":"9BB90C99B09691","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368764,"discussion_content":"æˆ‘ç†è§£åº”è¯¥æ˜¯ä½œç”¨ä¸ä¸€æ ·ï¼Œstruct fileæ˜¯VFSçš„æ¥å£å±‚ï¼Œæ˜¯ç»™æ¯ä¸ªè¿›ç¨‹ç”¨ï¼Œå±è”½ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„ç»†èŠ‚ã€‚ä½†æ˜¯dentryæ˜¯çœŸå®inodeå’Œå†…å­˜çš„æ˜ å°„å…³ç³»ï¼Œå±äºVFSçš„å®ç°å±‚ã€‚struct filleæŒ‡å‘inodeï¼Œä¸ä»£è¡¨dentryå°±æ²¡ç”¨äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618824797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":267133,"user_name":"è¾¾æ–‡è¥¿","can_delete":false,"product_type":"c1","uid":1398824,"ip_address":"","ucode":"01C1063F23D634","user_header":"https://static001.geekbang.org/account/avatar/00/15/58/28/c86340ca.jpg","comment_is_top":false,"comment_ctime":1607605846,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14492507734","product_id":100024701,"comment_content":"inodeè·Ÿdentryå±äºæ–‡ä»¶ç³»ç»ŸèŒƒç•´ï¼Œstruct fileå±äºè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œfdå±äºç”¨æˆ·æ€ç©ºé—´æ¦‚å¿µã€‚","like_count":4},{"had_liked":false,"id":135500,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1569199493,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14454101381","product_id":100024701,"comment_content":"è€å¸ˆï¼Œæˆ‘çš„ç†è§£ç¬¬ä¸€å¼ å›¾ä¸­çš„page cacheï¼Œåº”è¯¥æ˜¯bufferå§ï¼Œè€Œpage cacheæ˜¯åœ¨VFSè¿™ä¸€å±‚ ","like_count":4},{"had_liked":false,"id":155381,"user_name":"czh","can_delete":false,"product_type":"c1","uid":1159078,"ip_address":"","ucode":"649FE5C9269D69","user_header":"https://static001.geekbang.org/account/avatar/00/11/af/a6/3f15ba2f.jpg","comment_is_top":false,"comment_ctime":1574683769,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10164618361","product_id":100024701,"comment_content":"è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå…¶å®å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥å„ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»è¦æ˜ç™½ï¼Œä½œè€…åœ¨æœ€åå·²ç»ç”»å‡ºæ¥äº†ï¼èƒŒäº†å®ƒï¼","like_count":3},{"had_liked":false,"id":115414,"user_name":"oldman","can_delete":false,"product_type":"c1","uid":1133711,"ip_address":"","ucode":"6BACE2832B4429","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/8f/a90b3969.jpg","comment_is_top":false,"comment_ctime":1563584559,"is_pvip":false,"replies":[{"id":"46561","content":"çœ‹ä¹¦ï¼Œå†™ä»£ç ","user_name":"ä½œè€…å›å¤","comment_id":115414,"uid":"1001590","ip_address":"","utype":1,"ctime":1566357705,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"10153519151","product_id":100024701,"comment_content":"æƒ³é—®é—®è€å¸ˆï¼Œæ€ä¹ˆæ‰èƒ½å­¦å¥½Cè¯­è¨€","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459099,"discussion_content":"çœ‹ä¹¦ï¼Œå†™ä»£ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566357705,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104222,"user_name":"Guarantee","can_delete":false,"product_type":"c1","uid":1388495,"ip_address":"","ucode":"46380E86F03F26","user_header":"https://static001.geekbang.org/account/avatar/00/15/2f/cf/fb214a2c.jpg","comment_is_top":false,"comment_ctime":1560688570,"is_pvip":false,"replies":[{"id":"49032","content":"draw.io","user_name":"ä½œè€…å›å¤","comment_id":104222,"uid":"1001590","ip_address":"","utype":1,"ctime":1567581490,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"10150623162","product_id":100024701,"comment_content":"è€å¸ˆï¼Œæ‚¨ä¸“æ ä¸­çš„å›¾ï¼Œç”¨çš„æ˜¯ä»€ä¹ˆè½¯ä»¶ï¼Œè¿˜æ˜¯å°±æ˜¯PSåšçš„å›¾å—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454175,"discussion_content":"draw.io","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567581490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163462,"user_name":"å¥”è·‘çš„ç ä»”","can_delete":false,"product_type":"c1","uid":1609871,"ip_address":"","ucode":"AB3B02B07B8B8C","user_header":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","comment_is_top":false,"comment_ctime":1576726435,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5871693731","product_id":100024701,"comment_content":"å¯¹äºæ€»ç»“ä¸­çš„é‚£å‰¯å›¾ï¼Œè¿›ç¨‹Aå’Œè¿›ç¨‹Béƒ½æ‰“å¼€äº†stderræ–‡ä»¶ï¼Œä½†æ˜¯ï¼Œå›¾ä¸­è¡¨ç¤ºçš„æ˜¯ä¸¤ä¸ªstderræ–‡ä»¶æè¿°ç¬¦æŒ‡å‘äº†åŒä¸€ä¸ªstruct fileç»“æ„ã€‚ç†è®ºä¸Šï¼Œè¿™ä¸ªè¿›ç¨‹çš„stderråº”è¯¥å¯¹åº”ä¸åŒçš„struct fileæ‰å¯¹ï¼Œåº”ä¸ºstruct fileä¾é™„äºè¿›ç¨‹çš„ï¼Œè¿›ç¨‹æ¯æ‰“å¼€æ–‡ä»¶ï¼Œå†…æ ¸å°±ä¼šç›¸åº”çš„åˆ›å»ºä¸€ä¸ªstruct fileä¸ä¹‹å¯¹åº”ã€‚","like_count":1},{"had_liked":false,"id":126783,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1566474591,"is_pvip":false,"replies":[{"id":"48790","content":"inodeç»“æ„å°±æ˜¯ç”¨æ¥â€œè¡¨ç¤ºâ€ç¡¬ç›˜ä¸Šçš„inodeã€‚inodeç»“æ„ä½“æ˜¯ç£ç›˜æ–‡ä»¶inodeçš„å†…å­˜è¡¨ç¤ºï¼Œæˆ‘ä¹Ÿæ˜¯è¿™ä¸ªæ„æ€çš„","user_name":"ä½œè€…å›å¤","comment_id":126783,"uid":"1001590","ip_address":"","utype":1,"ctime":1567496355,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5861441887","product_id":100024701,"comment_content":"`inode ç»“æ„å°±è¡¨ç¤ºç¡¬ç›˜ä¸Šçš„ inodeï¼ŒåŒ…æ‹¬å—è®¾å¤‡å·ç­‰ã€‚` è¿™ä¸ªè¯´æ³•ä¸å¤ªå‡†ç¡®ã€‚inodeç»“æ„ä½“æ˜¯ç£ç›˜æ–‡ä»¶inodeçš„å†…å­˜è¡¨ç¤ºï¼Œç£ç›˜æ–‡ä»¶çš„inodeä¸åŒ…å«å¼•ç”¨è®¡æ•°ä¹‹ç±»çš„ä¸œè¥¿ï¼Œè¢«è¯»å–è‡³å†…å­˜ï¼Œä½¿ç”¨inodeç»“æ„ä½“è¡¨ç¤ºã€‚","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464164,"discussion_content":"inodeç»“æ„å°±æ˜¯ç”¨æ¥â€œè¡¨ç¤ºâ€ç¡¬ç›˜ä¸Šçš„inodeã€‚inodeç»“æ„ä½“æ˜¯ç£ç›˜æ–‡ä»¶inodeçš„å†…å­˜è¡¨ç¤ºï¼Œæˆ‘ä¹Ÿæ˜¯è¿™ä¸ªæ„æ€çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567496355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286929,"user_name":"geek","can_delete":false,"product_type":"c1","uid":2401422,"ip_address":"","ucode":"FF0845140D72A9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/NyFOEueITjaGLpakMEuWAqVQjo1uDIXlpDdpCxXGfaWiaXzibLQ3WgOFCe8D9FvCmyjsGT7jDsLUbkt8jt2aVs9g/132","comment_is_top":false,"comment_ctime":1617686045,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1617686045","product_id":100024701,"comment_content":"file operationå’Œ inode operationæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä¸ºå•¥è¦åˆ†ä¸¤ç§ï¼Œæˆ‘ç†è§£fileå°±æ˜¯inodeï¼Œæ“ä½œfileå°±æ˜¯æ“ä½œinodeã€‚","like_count":0},{"had_liked":false,"id":282079,"user_name":"garlic","can_delete":false,"product_type":"c1","uid":1019579,"ip_address":"","ucode":"FEB147EDB5774E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8e/bb/c039dc11.jpg","comment_is_top":false,"comment_ctime":1615046196,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1615046196","product_id":100024701,"comment_content":"è·¨è¶Šäº†æ–‡ä»¶ç³»ç»Ÿç›®å½•å’Œæ–‡ä»¶å°±æ²¡å•¥å…³ç³»äº†ï¼Œ æŸ¥æ‰¾æ–‡ä»¶å¯ä»¥é€šè¿‡dentry cacheè¿›è¡ŒæŸ¥æ‰¾ï¼Œ æœªæ‰¾åˆ°æ—¶ï¼Œé€šè¿‡æ–‡ä»¶ç³»ç»Ÿmount pointä¿¡æ¯ï¼Œè¯»å–ä¸­é—´çš„ç›®å½•ï¼Œ æŸ¥æ‰¾ç”Ÿæˆæ–°dentryï¼Œ å…¶çˆ¶dentryä¹Ÿæ˜¯æŒ‡å‘å…¶æ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ä¼šè·¨è¶Šæ–‡ä»¶ç³»ç»Ÿï¼Œ å­¦ä¹ ç¬”è®°https:&#47;&#47;garlicspace.com&#47;2021&#47;03&#47;06&#47;linux%e8%b7%a8%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%96%87%e4%bb%b6%e5%a4%b9%e5%92%8c%e6%96%87%e4%bb%b6%e6%98%a0%e5%b0%84%e5%85%b3%e7%b3%bb&#47;","like_count":1},{"had_liked":false,"id":263155,"user_name":"å‡¯","can_delete":false,"product_type":"c1","uid":1405256,"ip_address":"","ucode":"60DB11CF72C7B0","user_header":"https://static001.geekbang.org/account/avatar/00/15/71/48/44df7f4e.jpg","comment_is_top":false,"comment_ctime":1606026031,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606026031","product_id":100024701,"comment_content":"æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³è¯·æ•™ä¸€ä¸‹ï¼Œæ–‡ä»¶æ‰“å¼€å¦‚æœæ˜¯æ–‡æœ¬æ ¼å¼æ‰“å¼€æ–‡æœ¬æ–‡ä»¶ï¼ˆtxtæ ¼å¼ï¼‰æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ‰“å¼€.csv .xls å°±æœ‰é—®é¢˜ã€‚æ‰“å¼€æ–‡ä»¶ä¸€èˆ¬éƒ½ä¼šé‡åˆ°åˆ¤æ–­æ–‡ä»¶æ ¼å¼çš„é—®é¢˜ã€‚<br><br>è§£å†³æ–¹æ¡ˆå¤§è‡´æœ‰ä¸¤ç§ï¼Œ<br>1. æŒ‰ç…§æ–‡ä»¶åç¼€åˆ¤æ–­ï¼Œï¼ˆä¸é è°±ï¼Œwindowså¯ä»¥ä¿®æ”¹åç¼€ã€‚Linuxä¸å…³å¿ƒåç¼€ï¼‰<br>2. äºŒè¿›åˆ¶æ–¹å¼æ‰“å¼€ï¼Œè¯»å–å‰é¢çš„ä¸€åˆ°ä¸¤ä¸ªå­—èŠ‚ï¼Œè½¬æ¢æˆ16è¿›åˆ¶çš„çš„å­—ç¬¦ä¸²ï¼Œåˆ¤æ–­è¿™ä¸ªå­—ç¬¦ä¸²åœ¨æå‰å‡†å¤‡å¥½çš„ä¸åŒæ–‡ä»¶çš„ç±»å‹å’Œå¼€å¤´å‰ä¸¤ä¸ªå­—ç¬¦ä¸²ç»„æˆçš„å­—å…¸ä¸­æŸ¥æ‰¾ã€‚ä»è€ŒæŸ¥æ‰¾åˆ°å¯¹åº”çš„å…³ç³»ã€‚<br>ç¬¬äºŒç§æ–¹å¼å¯ä»¥åˆ¤æ–­ï¼Œä½†æ˜¯ä¸çŸ¥é“åŸç†ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å¯é ã€‚è¿™ä¸ªå‚è€ƒçš„æ–‡æ¡£ä¹ˆã€‚<br><br>æ‹“å±•ï¼Œå¦‚æœå¯ä»¥åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥åˆ¤æ–­ç¼–ç æ ¼å¼ã€‚è¿™ä¸ªæ²¡æœ‰æŸ¥åˆ°ã€‚","like_count":0},{"had_liked":false,"id":260583,"user_name":"KèŒæ— æƒ¨","can_delete":false,"product_type":"c1","uid":2194764,"ip_address":"","ucode":"97A532D588FD49","user_header":"","comment_is_top":false,"comment_ctime":1605065456,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605065456","product_id":100024701,"comment_content":"è€å¸ˆ è¯·æ•™ä¸€ä¸‹struct ext4_dir_entry_2ä¸struct dentryå­˜åœ¨ä»€ä¹ˆå…³è”å—?","like_count":0},{"had_liked":false,"id":254889,"user_name":"æ—¶å…‰","can_delete":false,"product_type":"c1","uid":1347240,"ip_address":"","ucode":"1087509C209C54","user_header":"https://static001.geekbang.org/account/avatar/00/14/8e/a8/c9819e37.jpg","comment_is_top":false,"comment_ctime":1603206647,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1603206647","product_id":100024701,"comment_content":"è€å¸ˆï¼Œæ–‡ä»¶åæ²¡æœ‰å­˜æ”¾åœ¨inodeç»“æ„é‡Œé¢å—ï¼Œé‚£æ–‡ä»¶ååœ¨ç£ç›˜ä¸Šçš„ä»€ä¹ˆåœ°æ–¹å­˜æ”¾å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":219358,"user_name":"ç™¾è¡Œå´ä¹¦","can_delete":false,"product_type":"c1","uid":1806261,"ip_address":"","ucode":"3DFCBBEBCA9A4B","user_header":"https://static001.geekbang.org/account/avatar/00/1b/8f/b5/7bc42adc.jpg","comment_is_top":false,"comment_ctime":1590016089,"is_pvip":false,"replies":[{"id":"83086","content":"ç«Ÿç„¶èƒ½pingé€šï¼Œèƒ½æ‰¾åˆ°ç½‘å¡å—ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":219358,"uid":"1001590","ip_address":"","utype":1,"ctime":1591785810,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"1590016089","product_id":100024701,"comment_content":"è€å¸ˆè¯·æ•™ä¸€ä¸ªé—®é¢˜<br>æˆ‘ä»¬åˆ›å»ºçš„namespace  æœ‰æ²¡æœ‰ç»Ÿä¸€çš„åœ°æ–¹æ‰¾åˆ°å®ƒ<br>æˆ‘åˆ›å»ºä¸€ä¸ªnetwork  namespace åœ¨&#47;var&#47;run&#47;netns ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªæŒ‚è½½ç‚¹  å¯ä»¥é€šè¿‡å®ƒ åˆ°nsä¸­ <br> ç°åœ¨æˆ‘å°†ä¸€ä¸ªç½‘å¡è®¾å¤‡æ”¾åˆ°è¿™ä¸ªnsä¸­  å¯ç”¨å¹¶é…ç½®IP  å¯ä»¥pingé€š  <br>æ­¤æ—¶é€šè¿‡ ip nsnet del å‘½ä»¤å°†è¿™ä¸ªnsåˆ é™¤  &#47;var&#47;run&#47;netns&#47; ç›®å½•ä¸‹ nsçš„æŒ‚è½½ç‚¹æ–‡ä»¶ä¹Ÿå°†æ¶ˆå¤± <br>å†ping åŸå…ˆé‚£ä¸ªç½‘å¡  å‘ç°è¿˜å¯ä»¥pingé€š<br>ç–‘é—®:è¯¥æ€ä¹ˆè¿›å…¥è¿™ä¸ªnsï¼Œæ€ä¹ˆå°†é‚£ä¸ªç½‘å¡æ‹¿å›æ¥ï¼Ÿ<br>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜  æ˜¯ä¸æ˜¯åªæœ‰åœ¨ç£ç›˜ä¸­çš„æ–‡ä»¶  æ‰èƒ½é€šè¿‡ find -inum inodeæ‰¾åˆ°  åœ¨å†…å­˜ä¸­ä¸èƒ½é€šè¿‡è¯¥æ–¹æ³•  æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•é€šè¿‡ inodeæ‰¾åˆ°å†…å­˜ä¸­çš„æ–‡ä»¶","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495782,"discussion_content":"ç«Ÿç„¶èƒ½pingé€šï¼Œèƒ½æ‰¾åˆ°ç½‘å¡å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591785810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1806261,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/8f/b5/7bc42adc.jpg","nickname":"ç™¾è¡Œå´ä¹¦","note":"","ucode":"3DFCBBEBCA9A4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281654,"discussion_content":"æ‰¾ä¸ç€ï¼Œä½¿ç”¨çš„æ˜¯macvlan","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591786062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173193,"user_name":"èŠ±æ™¨å°‘å¹´","can_delete":false,"product_type":"c1","uid":1098987,"ip_address":"","ucode":"6AA3537A6BA10E","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/eb/2285a345.jpg","comment_is_top":false,"comment_ctime":1579451352,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1579451352","product_id":100024701,"comment_content":"æˆ‘ç†è§£page cacheé‚£ä¸€å±‚åº”è¯¥æ˜¯ç¼“å†²åŒºï¼Œè€Œpage cacheåº”è¯¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šé¢","like_count":0},{"had_liked":false,"id":139954,"user_name":"zhj","can_delete":false,"product_type":"c1","uid":1311772,"ip_address":"","ucode":"65B9E222D6E075","user_header":"https://static001.geekbang.org/account/avatar/00/14/04/1c/b0c6c009.jpg","comment_is_top":false,"comment_ctime":1570773628,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1570773628","product_id":100024701,"comment_content":"åœ¨vfs_kern_mountå‡½æ•°ä¸­<br>mnt-&gt;mnt.mnt_root = root;<br>\tmnt-&gt;mnt.mnt_sb = root-&gt;d_sb;<br>\tmnt-&gt;mnt_mountpoint = mnt-&gt;mnt.mnt_root;<br>\tmnt-&gt;mnt_parent = mnt;<br><br>è¿™ä¸æ˜¯è¯´æ˜æ–°åˆ†é…çš„mountçš„æŒ‚è½½ç‚¹å°±æ˜¯vfsmountä¸­çš„mnt_root<br>mnt_parent å°±æ˜¯æ–°åˆ†é…çš„mount  <br>å’Œä¸Šæ–‡è®²åˆ°çš„äºŒè€…dentryä¸ä¸€è‡´ ä¸” mountçš„çˆ¶mountè¯´çš„ä¸ä¸€è‡´","like_count":0,"discussions":[{"author":{"id":1657948,"avatar":"https://static001.geekbang.org/account/avatar/00/19/4c/5c/9ea0f752.jpg","nickname":"ç¨‹åºçŒ¿ä¸åœ†","note":"","ucode":"BC8926A84A07C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":177313,"discussion_content":"do_add_mountå‡½æ•°ä¸­ä¼šåšçœŸæ­£çš„æŒ‚æ¥æ“ä½œï¼Œä¿®æ”¹æŒ‚è½½ç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582093806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":138851,"user_name":"williamcai","can_delete":false,"product_type":"c1","uid":1158294,"ip_address":"","ucode":"B158F52C2D39BC","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/96/46b13896.jpg","comment_is_top":false,"comment_ctime":1570492816,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1570492816","product_id":100024701,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼Œåœ¨dcacheä¸­æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªï¼Œè¿™ä¸ªæ–°åˆ›å»ºçš„æ–‡ä»¶è¦ä¸è¦æ”¾å…¥dcacheä¸­ï¼Ÿ<br>","like_count":0},{"had_liked":false,"id":133052,"user_name":"è®¡ç®—æœºç­é™ˆå…¬å­","can_delete":false,"product_type":"c1","uid":1168448,"ip_address":"","ucode":"0D776A68CBA05D","user_header":"https://static001.geekbang.org/account/avatar/00/11/d4/40/7401ecc1.jpg","comment_is_top":false,"comment_ctime":1568339775,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568339775","product_id":100024701,"comment_content":"æœ‰ä¸€ç‚¹ç–‘æƒ‘çš„å°±æ˜¯ï¼Œæ˜¯ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ä¼šæ–°å»ºä¸¤ä¸ªstructï¼Œä¸€ä¸ªæ˜¯file structä»–ä¼šæ”¾è¿›files_structæ•°ç»„é‡Œé¢ï¼Œè¿™ä¸ªfile stucté‡Œé¢æ‹¥æœ‰inodeä¿¡æ¯ã€‚ç„¶åè¿˜ä¼šæ–°å»ºä¸€ä¸ªdentry structï¼Œé‡Œé¢ä¹Ÿæœ‰inodeçš„ä¿¡æ¯ï¼Ÿæˆ‘çœ‹ä¸“æ ä¸­è¯´è¿™ä¸¤ä¸ªstructéƒ½æ˜¯åœ¨æ–‡ä»¶æ‰“å¼€åæ–°å»ºçš„ï¼Œé‚£è¿™ä¸¤ä¸ªä½œç”¨æ˜¯å¦é‡å¤ï¼Ÿè¿˜æ˜¯è¯´å› ä¸ºdentryè¿˜ä¿ç•™äº†mountçš„ä¿¡æ¯ï¼Ÿ","like_count":0},{"had_liked":false,"id":105498,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1561015662,"is_pvip":false,"replies":[{"id":"48899","content":"åœ¨å†…å­˜é‡Œé¢ï¼Œä¹Ÿæœ‰superblockçš„ï¼Œä¼šå…³è”dentry","user_name":"ä½œè€…å›å¤","comment_id":105498,"uid":"1001590","ip_address":"","utype":1,"ctime":1567510813,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1561015662","product_id":100024701,"comment_content":"å¦‚ä½•ç»´æŠ¤è·¨æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„å…³ç³»ï¼šé€šè¿‡dentryåœ¨æ“ä½œç³»ç»Ÿå±‚é¢æ¥ç»´æŠ¤ï¼Œdentryå’Œinodeå…³è”ï¼Œè€Œä¸”dentryé‡Œæœ‰parentã€childã€subdirsè¿™äº›æˆå‘˜ï¼Œæ­£å¥½å¯¹åº”æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ä¹‹é—´çš„å…³ç³»","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454706,"discussion_content":"åœ¨å†…å­˜é‡Œé¢ï¼Œä¹Ÿæœ‰superblockçš„ï¼Œä¼šå…³è”dentry","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567510813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105450,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1561003062,"is_pvip":false,"replies":[{"id":"48900","content":"ä¼šçš„","user_name":"ä½œè€…å›å¤","comment_id":105450,"uid":"1001590","ip_address":"","utype":1,"ctime":1567510822,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1561003062","product_id":100024701,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼šlookup_openåˆ›å»ºæ–°çš„dentryåï¼Œä¼šæŠŠæ–°çš„dentryåŠ åˆ°dentry cacheé‡Œå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454689,"discussion_content":"ä¼šçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567510822,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102616,"user_name":"Spring","can_delete":false,"product_type":"c1","uid":1222211,"ip_address":"","ucode":"8175463FB4705B","user_header":"https://static001.geekbang.org/account/avatar/00/12/a6/43/cb6ab349.jpg","comment_is_top":false,"comment_ctime":1560264833,"is_pvip":false,"replies":[{"id":"49133","content":"dentryä¸ä»…ä»…è¡¨ç¤ºç›®å½•ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºæ–‡ä»¶","user_name":"ä½œè€…å›å¤","comment_id":102616,"uid":"1001590","ip_address":"","utype":1,"ctime":1567596312,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1560264833","product_id":100024701,"comment_content":"ä»æ–‡ç« å¯ä»¥çœ‹å‡ºï¼Œçˆ¶æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹å…¶å®å°±æ˜¯å­æ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„åœ°æ–¹ï¼Œæ¯”å¦‚æ–‡ç« ä¸­çš„Aæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„homeç›®å½•ä¸‹ï¼Œé‚£homeæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæŒ‚è½½ç‚¹ã€‚<br>å¦å¤–ï¼Œæˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼šdataæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œdentryæ˜¯ä¸€ä¸ªç›®å½•ï¼Œä¸ºä»€ä¹ˆdataæ–‡ä»¶struct fileçš„dentryæŒ‡å‘ä¸€ä¸ªå«dataçš„dentryå‘¢ï¼Ÿæ˜æ˜æ²¡æœ‰dataç›®å½•å‘€ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453503,"discussion_content":"dentryä¸ä»…ä»…è¡¨ç¤ºç›®å½•ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºæ–‡ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567596312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100556,"user_name":"åˆ˜å¼·","can_delete":false,"product_type":"c1","uid":1035612,"ip_address":"","ucode":"B2E41BB894A727","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cd/5c/e09eac13.jpg","comment_is_top":false,"comment_ctime":1559576946,"is_pvip":false,"replies":[{"id":"37049","content":"homeæ˜¯åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä¸€ä¸ªæŒ‚è½½ç‚¹<br>","user_name":"ä½œè€…å›å¤","comment_id":100556,"uid":"1001590","ip_address":"","utype":1,"ctime":1560255907,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1559576946","product_id":100024701,"comment_content":"è€å¸ˆï¼Œå®åœ¨æ˜¯ä¸ç†è§£homeç›®å½•ä¸ºä»€ä¹ˆæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ï¼Œéš¾é“ä¸æ˜¯é‚£ä¸ªâ€œ&#47;â€å—ï¼Ÿæˆ‘ä¸€ç›´ç†è§£çš„æŒ‚è½½ç‚¹å°±æ˜¯æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„é‚£ä¸ªç›®å½•ï¼Œå¸Œæœ›è€å¸ˆæŠ½ä¸ªæ—¶é—´ï¼ŒæŒ‡ç‚¹ä¸€ä¸‹æŒ‚è½½ç›®å½•å’ŒæŒ‚è½½ç‚¹çš„åŒºåˆ«ï¼Œçœ‹äº†ä¸€å¤©äº†ï¼Œè°¢è°¢ã€‚","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452597,"discussion_content":"homeæ˜¯åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä¸€ä¸ªæŒ‚è½½ç‚¹\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560255907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100506,"user_name":"Sharry","can_delete":false,"product_type":"c1","uid":1239293,"ip_address":"","ucode":"045DDB864659F6","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/fd/035f4c94.jpg","comment_is_top":false,"comment_ctime":1559568199,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559568199","product_id":100024701,"comment_content":"è€å¸ˆçš„æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿä¸ªäººæ„Ÿè§‰æ²¡æœ‰é”™, æˆ‘çš„ç†è§£å¦‚ä¸‹<br><br>- ç¬¬ä¸€å±‚<br>  - mount: æ ¹æ–‡ä»¶ç³»ç»Ÿæè¿° <br>  - dentry: æ ¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„<br>  - file: æ ¹æ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„æ–‡ä»¶<br>    - vfsmount: æŒ‡å‘è¯¥æ–‡ä»¶çš„æ–‡ä»¶ç³»ç»Ÿ <br>    - dentry: æŒ‡å‘è¯¥æ–‡ä»¶çš„è·¯å¾„<br>- ç¬¬äºŒå±‚<br>  - mount: æ–‡ä»¶ç³»ç»Ÿ A çš„æè¿°<br>  - dentry: æ–‡ä»¶ç³»ç»Ÿ A çš„æ ¹è·¯å¾„<br>  - file: æ–‡ä»¶ç³»ç»Ÿ A çš„ç›®å½•æ–‡ä»¶<br>- ç¬¬ä¸‰å±‚<br>  - mount: æ–‡ä»¶ç³»ç»Ÿ B çš„æè¿°<br>  - dentry: æ–‡ä»¶ç³»ç»Ÿ B çš„æ ¹è·¯å¾„<br>  - file: æ–‡ä»¶ç³»ç»Ÿ B çš„ç›®å½•æ–‡ä»¶<br>- ç¬¬å››å±‚<br>  - dentry: æ–‡ä»¶ç³»ç»Ÿ B ä¸­ world æ–‡ä»¶å¤¹è·¯å¾„<br>  - file: æ–‡ä»¶ç³»ç»Ÿ B ä¸­çš„æ–‡ä»¶<br>- ç¬¬äº”å±‚<br>  - dentry: æ–‡ä»¶ç³»ç»Ÿ B ä¸­ world æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶è·¯å¾„<br>  - file: æ–‡ä»¶ç³»ç»Ÿ B ä¸­ world æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶","like_count":0},{"had_liked":false,"id":100245,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1559497927,"is_pvip":false,"replies":[{"id":"49204","content":"è£¸è®¾å¤‡çš„è¯ï¼Œå¾ˆéš¾å‡†ç¡®è¾¨åˆ«æ–‡ä»¶å§","user_name":"ä½œè€…å›å¤","comment_id":100245,"uid":"1001590","ip_address":"","utype":1,"ctime":1567603051,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"1559497927","product_id":100024701,"comment_content":"è€å¸ˆï¼Œèƒ½å¦è®²ä¸€ä¸‹è¯»å†™è£¸è®¾å¤‡å’Œè¯»å†™è®¾å¤‡ä¸Šçš„æ–‡ä»¶çš„ç»†èŠ‚æ–¹é¢çš„åŒºåˆ«","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452472,"discussion_content":"è£¸è®¾å¤‡çš„è¯ï¼Œå¾ˆéš¾å‡†ç¡®è¾¨åˆ«æ–‡ä»¶å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567603051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1233832,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d3/a8/91eed372.jpg","nickname":"é­ä¹","note":"","ucode":"B6D50018BE67E7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2940,"discussion_content":"æ–‡ä»¶ç³»ç»Ÿéœ€è¦æ·±å…¥ç†è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564048989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}