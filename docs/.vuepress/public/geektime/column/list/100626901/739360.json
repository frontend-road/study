{"id":739360,"title":"30ï½œUnsafeç¼–ç¨‹ï¼ˆä¸‹ï¼‰ï¼šä½¿ç”¨Rustä¸ºPythonå†™ä¸€ä¸ªæ‰©å±•","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬äº†è§£äº†Unsafe Rustçš„æ‰€å±å®šä½å’ŒåŸºæœ¬æ€§è´¨ï¼Œè¿™ä¸€è®²æˆ‘ä»¬å°±æ¥çœ‹çœ‹Rust FFIç¼–ç¨‹åˆ°åº•æ˜¯æ€æ ·ä¸€ç§å½¢å¼ã€‚</p><p>FFIæ˜¯ä¸å¤–éƒ¨è¯­è¨€è¿›è¡Œäº¤äº’çš„æ¥å£ï¼Œåœ¨Safe Rustçœ‹æ¥ï¼Œå®ƒæ˜¯ä¸å¯ä¿¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Rustç¼–è¯‘ä¸èƒ½ä¿è¯å®ƒæ˜¯å®‰å…¨çš„ï¼Œåªèƒ½ç”±ç¨‹åºå‘˜è‡ªå·±æ¥ä¿è¯ï¼Œå› æ­¤åœ¨Rusté‡Œè°ƒç”¨è¿™äº›å¤–éƒ¨çš„ä»£ç åŠŸèƒ½å°±éœ€è¦æŠŠå®ƒä»¬åŒ…åœ¨ <code>unsafe {}</code> ä¸­ã€‚</p><p>Rustå’ŒCæœ‰è¡€ç¼˜å…³ç³»ï¼Œå…·æœ‰ABIä¸Šçš„ä¸€è‡´æ€§ï¼Œæ‰€ä»¥<strong>Rustå’ŒCä¹‹é—´å¯ä»¥å®ç°åŒå‘äº’è°ƒï¼Œå¹¶ä¸”ä¸ä¼šæŸå¤±æ€§èƒ½ã€‚</strong></p><h2>Rustè°ƒç”¨C</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹åœ¨Rustä¸­å¦‚ä½•è°ƒç”¨Cåº“çš„ä»£ç ã€‚</p><p>ä¸€èˆ¬å„ä¸ªå¹³å°ä¸‹éƒ½æœ‰ libm åº“ï¼Œå®ƒæ˜¯æ“ä½œç³»ç»ŸåŸºæœ¬çš„æ•°å­¦mathåº“ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥Linuxä¸ºä¾‹æ¥è¯´æ˜ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ¥è‡ª <a href=\"https://doc.rust-lang.org/rust-by-example/std_misc/ffi.html\">Rust By Example</a>ã€‚</p><pre><code class=\"language-plain\">use std::fmt;\n\n// è¿æ¥åˆ°ç³»ç»Ÿçš„ libm åº“\n#[link(name = \"m\")]\nextern {\n&nbsp; &nbsp; // è¿™æ˜¯ä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼Œè®¡ç®—å•ç²¾åº¦å¤æ•°çš„æ–¹æ ¹\n&nbsp; &nbsp; fn csqrtf(z: Complex) -&gt; Complex;\n    // è®¡ç®—å¤æ•°çš„ä½™å¼¦å€¼\n&nbsp; &nbsp; fn ccosf(z: Complex) -&gt; Complex;\n}\n\n// å¯¹unsafeè°ƒç”¨çš„safeå°è£…ï¼Œä»æ­¤ä»¥åï¼Œå°±æŒ‰safeå‡½æ•°æ–¹å¼ä½¿ç”¨è¿™ä¸ªæ¥å£\nfn cos(z: Complex) -&gt; Complex {\n&nbsp; &nbsp; unsafe { ccosf(z) }\n}\n\nfn main() {\n&nbsp; &nbsp; // z = -1 + 0i\n&nbsp; &nbsp; let z = Complex { re: -1., im: 0. };\n\n&nbsp; &nbsp; // è°ƒç”¨måº“ä¸­çš„å‡½æ•°ï¼Œéœ€è¦ç”¨ unsafe {} åŒ…èµ·æ¥\n&nbsp; &nbsp; let z_sqrt = unsafe { csqrtf(z) };\n\n&nbsp; &nbsp; println!(\"the square root of {:?} is {:?}\", z, z_sqrt);\n\n&nbsp; &nbsp; // è°ƒç”¨å®‰å…¨å°è£…åçš„å‡½æ•°\n&nbsp; &nbsp; println!(\"cos({:?}) = {:?}\", z, cos(z));\n}\n\n// ç”¨ repr(C) æ ‡æ³¨ï¼Œå®šä¹‰Rustç»“æ„ä½“çš„ABIæ ¼å¼ï¼ŒæŒ‰Cçš„ABIæ¥\n#[repr(C)]\n#[derive(Clone, Copy)]\nstruct Complex {\n&nbsp; &nbsp; re: f32,\n&nbsp; &nbsp; im: f32,\n}\n\n// å®ç°å¤æ•°çš„æ‰“å°è¾“å‡º\nimpl fmt::Debug for Complex {\n&nbsp; &nbsp; fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {\n&nbsp; &nbsp; &nbsp; &nbsp; if self.im &lt; 0. {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write!(f, \"{}-{}i\", self.re, -self.im)\n&nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write!(f, \"{}+{}i\", self.re, self.im)\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><!-- [[[read_end]]] --><p>libm åº“æ˜¯ç”¨Cè¯­è¨€å®ç°çš„ï¼Œæˆ‘ä»¬è¦è°ƒç”¨å®ƒï¼Œéœ€è¦ç”¨è¿™æ ·çš„æ ‡æ³¨ã€‚</p><pre><code class=\"language-plain\">#[link(name = \"m\")]\nextern {\n}\n</code></pre><p>ç”¨ lnk å±æ€§å®å°†libmåº“è¿æ¥è¿›æ¥ï¼Œä»¥ä¾¿å»é‡Œé¢æ‰¾å¯¹åº”çš„å‡½æ•°ã€‚ç„¶åæŠŠéœ€è¦çš„å¤–éƒ¨å‡½æ•°å¯¼å…¥è¿›æ¥ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ <code>csqrtf()</code> å‡½æ•°å’Œ <code>ccosf()</code> çš„Cè¯­è¨€ç­¾åã€‚</p><pre><code class=\"language-plain\">float complex csqrtf(float complex z);\nfloat complex ccosf (float complex z);\n</code></pre><p>å¯¼å…¥çš„æ—¶å€™ï¼Œè¦ç¿»è¯‘æˆRustå‡½æ•°çš„ç­¾åå½¢å¼ã€‚</p><pre><code class=\"language-plain\">fn csqrtf(z: Complex) -&gt; Complex;\nfn ccosf(z: Complex) -&gt; Complex;\n</code></pre><p>è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ç”¨ <code>unsafe {}</code> åŒ…èµ·æ¥ã€‚</p><p>ç„¶åæˆ‘ä»¬ä»”ç»†çœ‹ä¸€ä¸‹åœ¨Rustä¸­å¯¹åº”åˆ°libmä¸­çš„å¤æ•°çš„å®šä¹‰ã€‚</p><pre><code class=\"language-plain\">#[repr(C)]\n#[derive(Clone, Copy)]\nstruct Complex {\n&nbsp; &nbsp; re: f32,\n&nbsp; &nbsp; im: f32,\n}\n</code></pre><p>å¯¹åº”çš„Cè¯­è¨€ä¸­çš„ç»“æ„å®šä¹‰åœ¨ <a href=\"https://en.cppreference.com/w/c/numeric/complex\">complex.h å¤´æ–‡ä»¶</a>ä¸­ï¼Œå®ƒæ˜¯C99æ ‡å‡†å¼•å…¥çš„æ•°æ®ç±»å‹ã€‚</p><p>æœ¬èº«è¿™ä¸ªå®šä¹‰éå¸¸ç®€å•ï¼Œå°±æ˜¯å®šä¹‰å¤æ•°çš„å®éƒ¨å’Œè™šéƒ¨å°±å¯ä»¥äº†ï¼Œä¸è¿‡ä¸€å®šè¦ç”¨ <code>#[repr(C)]</code> æ ‡æ³¨ã€‚å®ƒçš„æ„æ€æ˜¯è¿™ä¸ªç±»å‹ç¼–è¯‘çš„æ—¶å€™ï¼Œè¦ä½¿ç”¨Cè¯­è¨€çš„ABIæ ¼å¼ã€‚æˆ‘ä»¬ä¸€èˆ¬éƒ½ä½¿ç”¨Cè¯­è¨€ABIæ ¼å¼ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„ABIæ ¼å¼ï¼Œä½ å¯ä»¥ç‚¹å‡»æˆ‘ç»™å‡ºçš„<a href=\"https://doc.rust-lang.org/nomicon/ffi.html#foreign-calling-conventions\">é“¾æ¥</a>ï¼ŒæŸ¥åˆ°Rustä¸­æ”¯æŒçš„ABIæ ¼å¼åˆ—è¡¨ã€‚</p><p>ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨Rustå‡½æ•°å¯¹è¿™äº›å¤–éƒ¨unsafeå‡½æ•°åšä¸€ä¸‹å°è£…ã€‚åƒcoså‡½æ•°è¿™æ ·ï¼Œä½ å¯ä»¥å‚çœ‹ä¸€ä¸‹ç¤ºä¾‹ä»£ç ã€‚</p><pre><code class=\"language-plain\">fn cos(z: Complex) -&gt; Complex {\n&nbsp; &nbsp; unsafe { ccosf(z) }\n}\n</code></pre><p>æ‰§è¡Œ <code>cargo run</code>ï¼Œè¾“å‡ºäº†ä¸‹é¢è¿™ä¸¤è¡Œä»£ç ã€‚</p><pre><code class=\"language-plain\">the square root of -1+0i is 0+1i\ncos(-1+0i) = 0.5403023+0i\n</code></pre><p><span class=\"reference\">æ³¨ï¼šé¡¹ç›®ä»£ç é“¾æ¥</span><a href=\"https://github.com/miketang84/jikeshijian/tree/master/30-ffi/rust_call_c\">https://github.com/miketang84/jikeshijian/tree/master/30-ffi/rust_call_c</a></p><h3>bindgen</h3><p>Rustå®˜æ–¹å‡ºäº†ä¸€ä¸ª <a href=\"https://github.com/rust-lang/rust-bindgen\">bindgen</a> é¡¹ç›®ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿä»Cåº“çš„å¤´æ–‡ä»¶ç”ŸæˆRust FFIç»‘å®šå±‚ä»£ç ã€‚ä¹‹æ‰€ä»¥èƒ½è¿™æ ·åšï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å‘ç°ï¼ŒCçš„æ¥å£è½¬æ¢æˆRustçš„æ¥å£å½¢å¼æ˜¯éå¸¸å›ºå®šçš„ï¼Œè½¬æ¢çš„è¿‡ç¨‹éœ€è¦å†™å¤§é‡çš„æ ·æ¿ä»£ç ï¼Œæ‰€ä»¥å°±å¯ä»¥ç”¨ bindgen è¿™ç§å·¥å…·è‡ªåŠ¨è½¬æ¢ã€‚</p><p>æ¯”å¦‚æŸä¸ªCå¤´æ–‡ä»¶é‡Œå®šä¹‰äº†è¿™æ ·çš„ç±»å‹å’Œå‡½æ•°ï¼š</p><pre><code class=\"language-plain\">typedef struct Doggo {\n    int many;\n    char wow;\n} Doggo;\n\nvoid eleven_out_of_ten_majestic_af(Doggo* pupper);\n</code></pre><p>ä½¿ç”¨ bindgen è‡ªåŠ¨ç”ŸæˆFFIç»‘å®šåï¼Œå¯ä»¥ç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p><pre><code class=\"language-plain\">/* automatically generated by rust-bindgen 0.99.9 */\n\n#[repr(C)]\npub struct Doggo {\n    pub many: ::std::os::raw::c_int,\n    pub wow: ::std::os::raw::c_char,\n}\n\nextern \"C\" {\n    pub fn eleven_out_of_ten_majestic_af(pupper: *mut Doggo);\n}\n</code></pre><p>ä½ å¯èƒ½å‘ç°äº†ï¼ŒRusté‡Œæœ‰ä¸€æ‰¹ç±»å‹ï¼Œä»¥ c_ å‰ç¼€å¼€å¤´ã€‚æ¯”å¦‚ Cè¯­è¨€çš„ int ç±»å‹ï¼Œå¯¹åº” std ä¸­çš„ç±»å‹ä½ å¯ä»¥é€šè¿‡æˆ‘ç»™å‡ºçš„<a href=\"https://doc.rust-lang.org/std/ffi/type.c_int.html\">é“¾æ¥</a>æ‰¾åˆ°ã€‚</p><p>è¿™äº›å°±æ˜¯Rusté‡Œå®šä¹‰çš„ä¸Cå®Œå…¨ç›¸åŒçš„ç±»å‹ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ <a href=\"https://doc.rust-lang.org/std/ffi/type.c_char.html\">c_char</a> çš„å®šä¹‰ã€‚</p><pre><code class=\"language-plain\">pub type c_char = i8;\n</code></pre><p>ç«Ÿç„¶ç›´æ¥æ˜¯ä¸€ä¸ª i8ã€‚å› ä¸ºCè¯­è¨€é‡Œçš„charå°±æ˜¯ä¸€ä¸ªæ™®é€šå­—èŠ‚ï¼Œå’ŒRusté‡Œçš„charå®Œå…¨ä¸åŒã€‚è¿™æ˜¯åœ¨Rustä¸­å®Œå…¨å…¼å®¹Cå¿…è¦çš„ä¸€æ­¥ï¼Œå°±æ˜¯<strong>æŠŠCä¸­çš„ç±»å‹å…¨éƒ¨æ˜ å°„è¿‡æ¥ï¼Œå¹¶åŠ ä¸Šc_ å‰ç¼€</strong>ã€‚è¿™æ ·å•ç‹¬æä¸€æ‰¹ç±»å‹å°±æ˜¯å› ä¸ºæœ‰çš„ç±»å‹æ²¡åŠæ³•ç›´æ¥æ˜ å°„åˆ° Rust çš„ char ä¸Šæ¥ï¼Œæ¯”å¦‚åˆšåˆšè¯´çš„è¿™ä¸ª c_charã€‚</p><p>å…¸å‹çš„ï¼Œè¿˜æœ‰ C è¯­è¨€ä¸­çš„ void ç±»å‹ï¼Œå®ƒåœ¨Rusté‡Œæ²¡æœ‰å¯¹åº”ç‰©ï¼Œæ‰€ä»¥å°±æ˜ å°„æˆäº† <a href=\"https://doc.rust-lang.org/std/ffi/enum.c_void.html\">c_void</a>ï¼Œåœ¨Rustä¸­å®šä¹‰æˆäº†ä¸€ä¸ª enumã€‚</p><pre><code class=\"language-plain\">#[repr(u8)]\npub enum c_void {\n    // some variants omitted\n}\n</code></pre><p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹ï¼Œåè¿‡æ¥ï¼Œåœ¨Cä¸­å¦‚ä½•è°ƒç”¨Rustä»£ç ã€‚</p><h2>Cè°ƒç”¨Rust</h2><p>åœ¨Cä¸­è°ƒç”¨Rustä»£ç çš„åŸºæœ¬æ€è·¯æ˜¯ï¼ŒRustä»£ç ç¼–è¯‘æˆ <code>.so</code> æˆ– <code>.dll</code> åŠ¨æ€é“¾æ¥åº“ï¼Œåœ¨Cè¯­è¨€é‡Œé¢ç¼–è¯‘çš„æ—¶å€™ï¼Œè¿æ¥å°±å¯ä»¥äº†ã€‚</p><p>åœ¨ lib.rs æ–‡ä»¶ä¸­ï¼Œå†™è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼š</p><pre><code class=\"language-plain\">#[no_mangle]\npub extern \"C\" fn hello_from_rust() {\n&nbsp; &nbsp; println!(\"Hello from Rust!\");\n}\n</code></pre><p>æ³¨æ„å±æ€§å® <code>#[no_mangle]</code>ï¼Œåœ¨Rustä¸­ï¼Œno_mangle ç”¨äºå‘Šè¯‰Rustç¼–è¯‘å™¨ä¸è¦ä¿®æ”¹å‡½æ•°çš„åç§°ï¼Œè¿™ç§ä¿®æ”¹å«åšManglingï¼Œå®ƒæ˜¯ç¼–è¯‘å™¨åœ¨è§£æåç§°æ—¶ï¼Œä¿®æ”¹æˆ‘ä»¬å®šä¹‰çš„å‡½æ•°åç§°ï¼Œå¢åŠ ä¸€äº›ç”¨äºå…¶ç¼–è¯‘è¿‡ç¨‹çš„é¢å¤–ä¿¡æ¯ã€‚ä½†åœ¨å’Œå…¶ä»–è¯­è¨€äº¤äº’æ—¶ï¼Œå¦‚æœå‡½æ•°åç§°è¢«ç¼–è¯‘å™¨ä¿®æ”¹ï¼Œç¨‹åºå¼€å‘è€…å°±æ²¡åŠæ³•çŸ¥é“ä¿®æ”¹åçš„å‡½æ•°åç§°äº†ï¼Œå…¶ä»–è¯­è¨€ä¹Ÿæ— æ³•æŒ‰åŸåç§°è°ƒç”¨ã€‚å› æ­¤ï¼Œ#[no_mangle] åœ¨è¿™ç§åœºæ™¯ä¸‹å°±éå¸¸æœ‰ç”¨äº†ã€‚</p><p>Cargo.toml è¦åŠ ä¸ªé…ç½®ï¼Œè¡¨ç¤ºç¼–è¯‘çš„è¿™ä¸ªåº“æ˜¯ C ABI æ ¼å¼çš„åŠ¨æ€é“¾æ¥åº“ã€‚</p><pre><code class=\"language-plain\">[lib]\ncrate-type = [\"cdylib\"]\n</code></pre><p>ç„¶åç”¨ <code>cargo build</code> ç¼–è¯‘è¾“å‡ºã€‚ä½ å¯ä»¥åœ¨ target/debug ç›®å½•ä¸‹é¢çœ‹åˆ°ä½ çš„ <code>.so</code> åº“æ–‡ä»¶ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><pre><code class=\"language-plain\">$ ls target/debug/\nbuild&nbsp; deps&nbsp; examples&nbsp; incremental&nbsp; libc_call_rust.d&nbsp; libc_call_rust.so\n</code></pre><p>è¿™é‡Œè¿™ä¸ª libc_call_rust.so å°±æ˜¯æˆ‘ä»¬çš„åŠ¨æ€é“¾æ¥åº“ï¼Œå…¶ä¸­ <code>c_call_rust</code> æ˜¯æˆ‘ä»¬è¿™ä¸ª crate çš„åå­—ã€‚</p><p>ä¸‹é¢æ˜¯Cçš„éƒ¨åˆ†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">extern void hello_from_rust();\n\nint main(void) {\n&nbsp; &nbsp; hello_from_rust();\n&nbsp; &nbsp; return 0;\n}\n</code></pre><p>å­˜æˆ call_rust.c æ–‡ä»¶ã€‚ç”¨ä¸‹é¢è¿™ç§å½¢å¼ç¼–è¯‘ï¼š</p><pre><code class=\"language-plain\">gcc call_rust.c -o call_rust -lc_call_rust -L./target/debug\n</code></pre><p>è¿è¡Œï¼š</p><pre><code class=\"language-plain\">LD_LIBRARY_PATH=./target/debug ./call_rust\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°è¾“å‡ºå†…å®¹ <code>Hello from Rust!</code>ã€‚</p><p><span class=\"reference\">æ³¨ï¼šå®Œæ•´å¯æµ‹è¯•ä»£ç </span><a href=\"https://github.com/miketang84/jikeshijian/tree/master/30-ffi/c_call_rust\">https://github.com/miketang84/jikeshijian/tree/master/30-ffi/c_call_rust</a></p><p>å½“ç„¶ï¼Œè¿™åªæ˜¯æœ€ç®€å•çš„å½¢å¼ï¼Œä¸‡é‡Œé•¿å¾æˆ‘ä»¬åˆšè¸å‡ºç¬¬ä¸€æ­¥ï¼Œè¿˜æœ‰å„ç§å¤æ‚çš„FFIåœºæ™¯ç­‰ç€ä½ å»æ¢ç´¢ã€‚</p><h3>Cbindgen</h3><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œå½“ä½ éœ€è¦ä»¥Rustä»“åº“ä¸ºä¸»ï¼Œä¸ºå…¶ä»–è¯­è¨€å¯¼å‡ºCæ¥å£çš„æ—¶å€™ï¼Œä¸€èˆ¬è¿˜éœ€è¦ç”ŸæˆCçš„å¤´æ–‡ä»¶ï¼Œè¿™æ—¶ï¼Œä½ åº”è¯¥ä¼šå¯¹ <a href=\"https://github.com/mozilla/cbindgen\">cbindgen</a> é¡¹ç›®å¾ˆæ„Ÿå…´è¶£ï¼Œå®ƒä¹Ÿç®—åŠå®˜æ–¹çš„ï¼ˆåœ¨Mozillaåä¸‹ï¼‰ï¼Œå®ƒçš„ä½œç”¨ä¸å‰é¢çš„ bindgen åˆšå¥½ç›¸åï¼Œæ˜¯ä»Rustä»£ç ä¸­ç”ŸæˆCå¯ä»¥è°ƒç”¨çš„ä»£ç ç­¾åã€‚</p><p>Rustä¸Cçš„äº¤äº’æˆ‘ä»¬å…ˆè®¨è®ºåˆ°è¿™é‡Œï¼Œä¸‹é¢æˆ‘ä»¬è¦ç ”ç©¶ä¸€ä¸‹å¦‚ä½•ç”¨Rustç»™Pythonå†™æ‰©å±•ã€‚</p><h2>ä½¿ç”¨Rustç»™Pythonå†™æ‰©å±•</h2><p>æ ‡å‡†çš„Pythonæ‰©å±•æ˜¯ç”¨ C/C++ å†™çš„ï¼ŒPython å®˜æ–¹æœ‰<a href=\"https://docs.python.org/3/extending/extending.html\">æ•™ç¨‹</a>ï¼Œæ„Ÿå…´è¶£çš„è¯ä½ å¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚æˆ‘ä»¬è¿™èŠ‚è¯¾èšç„¦äºå¦‚ä½•ç”¨Rustç»™Pythonå†™æ‰©å±•ã€‚</p><p>å…¶å®ï¼Œåªè¦ä½ å°†Rustçš„ä»£ç æ‰©å±•åˆ°Cå¯ä»¥è°ƒç”¨ï¼Œé‚£ä¹ˆå†è¿›ä¸€æ­¥ï¼ŒæŒ‰Pythonå®˜æ–¹æ•™ç¨‹é‚£æ ·ï¼Œç»§ç»­å°†Cä»£ç å°è£…æˆPythonæ‰©å±•å°±å¯ä»¥äº†ï¼Œä¸‹é¢æˆ‘ä»¬è®²çš„åŸºæœ¬æ€è·¯ä¹Ÿæ˜¯è¿™æ ·ã€‚</p><p>åœ¨å®é™…å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå†™éå¸¸å¤šçš„æ ·æ¿ä»£ç ï¼Œå†™èµ·æ¥æ¯”è¾ƒç—›è‹¦ã€‚ä½†æ˜¯Rustç¤¾åŒºæœ‰éå¸¸ä¼˜ç§€çš„é¡¹ç›®ï¼šPyO3ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å‡è½»è¿™ç§çƒ¦æ¼ï¼Œè‡ªåŠ¨å¸®æˆ‘ä»¬å¤„ç†å¥½ä¸­é—´æ ·æ¿å°è£…è¿‡ç¨‹ã€‚</p><h3>PyO3</h3><p>PyO3æ˜¯Rustç¤¾åŒºé‡Œéå¸¸ç«çš„ä¸Pythonç»‘å®šçš„æ¡†æ¶ï¼Œå®ƒä¸ä»…å¯ä»¥å®ç°ç”¨Rustç»™Pythonå†™æ‰©å±•ï¼Œè¿˜èƒ½åœ¨Rustçš„äºŒè¿›åˆ¶ç¨‹åºä¸­ç›´æ¥æ‰§è¡ŒPythonä»£ç ã€‚æ‰€ä»¥å®é™… PyO3 æ˜¯ä¸€ä¸ªåŒå‘ç»‘å®šåº“ã€‚</p><p>PyO3å°è£…äº†åº•å±‚FFIç»‘å®šçš„å„ç§ç»†èŠ‚ã€‚è¿™äº›ç»†èŠ‚å…¶å®ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼Œä½ å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œå¦‚ä½•å°†Pythonçš„Classæ­£ç¡®æ˜ å°„åˆ°Rustä¸­å¯¹åº”çš„ç±»å‹ï¼Œå¦‚ä½•æ­£ç¡®å¤„ç†æ¨¡å—ã€å‡½æ•°ã€å‚æ•°ã€è¿”å›å€¼ç±»å‹ï¼Œè¿™é‡Œé¢æœ‰å„ç§ç»†èŠ‚ï¼Œæƒ³æƒ³å°±å¤´ç—›ã€‚</p><p>è€Œ PyO3 æŠŠè¿™ä¸€åˆ‡éƒ½å°è£…åœ¨äº†Rustå±æ€§å®é‡Œé¢ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">use num_bigint::BigUint;\nuse num_traits::{One, Zero};\nuse pyo3::prelude::*;\n\n// Calculate large fibonacci numbers.\nfn fib(n: usize) -&gt; BigUint {\n&nbsp; &nbsp; let mut f0: BigUint = Zero::zero();\n&nbsp; &nbsp; let mut f1: BigUint = One::one();\n&nbsp; &nbsp; for _ in 0..n {\n&nbsp; &nbsp; &nbsp; &nbsp; let f2 = f0 + &amp;f1;\n&nbsp; &nbsp; &nbsp; &nbsp; f0 = f1;\n&nbsp; &nbsp; &nbsp; &nbsp; f1 = f2;\n&nbsp; &nbsp; }\n&nbsp; &nbsp; f0\n}\n\n#[pyfunction]\nfn calc_fib(n: usize) -&gt; PyResult&lt;()&gt; {\n&nbsp; &nbsp; let _ = fib(n);\n&nbsp; &nbsp; Ok(())\n}\n\n#[pymodule]\nfn rust_fib(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {\n&nbsp; &nbsp; m.add_function(wrap_pyfunction!(calc_fib, m)?)?;\n&nbsp; &nbsp; Ok(())\n}\n</code></pre><p>è¿™ä¸ªç¤ºä¾‹çš„ä½œç”¨æ˜¯è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬Né¡¹ã€‚å½“è¿™ä¸ªNå€¼æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæ–æ³¢é‚£å¥‘æ•°æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ•°ï¼Œä¸€ä¸ªu64è£…ä¸ä¸‹ï¼Œå› æ­¤æˆ‘ä»¬è¦ä½¿ç”¨å¤§æ•°ç±»å‹ã€‚åœ¨Rustä¸­ï¼Œnum-bigintæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„å¤§æ•°ç±»å‹å®ç°åº“ã€‚è€Œåœ¨Pythonä¸­ï¼Œinté»˜è®¤å°±æ”¯æŒå¤§æ•°ã€‚</p><p>ä»£ç ä¸­ï¼Œ<code>fib()</code> å‡½æ•°æ˜¯çœŸæ­£è®¡ç®—æ–æ³¢é‚£å¥‘æ•°çš„å‡½æ•°ï¼Œç„¶ååœ¨ <code>calc_fib()</code> ä¸­å°è£…ç»™äº† Python ä½¿ç”¨ï¼Œè¯·æ³¨æ„è¿™ä¸ªå‡½æ•°å¤´ä¸Šçš„ <code>#[pyfunction]</code> æ ‡æ³¨ï¼Œå®ƒè¡¨æ˜è¿™ä¸ªå‡½æ•°ä¼šå¯¼å‡ºç»™ Python ä½¿ç”¨ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚</p><p>è€Œä¸‹é¢çš„ <code>rust_fib()</code> å‡½æ•°ï¼Œåˆ™æ˜¯æ ‡å‡†çš„æ ·æ¿ä»£ç ï¼Œå®ƒè¡¨ç¤ºåˆ›å»ºä¸€ä¸ª Python çš„æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—çš„åå­—å«åš <code>rust_fib</code>ï¼Œè¿™ä¸ªåå­—ä¼šåœ¨Pythonä»£ç ä¸­ä»¥ <code>import rust_fib</code> çš„å½¢å¼å¯¼å…¥ã€‚<code>#[pymodule]</code> å°±èµ·è¿™ä¸ªè‡ªåŠ¨è½¬åŒ–çš„ä½œç”¨ã€‚è¿™ä¸ªå‡½æ•°ä¸­çš„ m å‚æ•°å°±è¡¨ç¤ºæ¨¡å—å®ä¾‹ï¼Œ<code>m.add_function()</code> å°† <code>calc_fib()</code> æ·»åŠ åˆ°è¿™ä¸ªæ¨¡å—ä¸­ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™ä¸ª crate åº“ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªå…±è¯†åº“ï¼Œå¹¶è¢«å¯¼å…¥ä¸º Python çš„ä¸€ä¸ªæ¨¡å—ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹ Cargo.toml çš„æ–°å¢é…ç½®ã€‚</p><pre><code class=\"language-plain\">[lib]\nname = \"rust_fib\"\ncrate-type = [\"cdylib\"]\n</code></pre><p>åœ¨Pythonä¸­è¿™æ ·è°ƒç”¨ï¼š</p><pre><code class=\"language-plain\">import rust_fib\nrust_fib.calc_fib(2000000)\n</code></pre><p><span class=\"reference\">æ³¨ï¼šå®Œæ•´çš„å¯è¿è¡Œä»£ç </span><a href=\"https://github.com/miketang84/jikeshijian/blob/master/30-ffi/bigint-pyo3\">https://github.com/miketang84/jikeshijian/blob/master/30-ffi/bigint-pyo3</a></p><p>è¿™æ ·PyO3é¡¹ç›®çš„ä¸€ä¸ªå…³é”®æ˜¯ï¼Œéœ€è¦ä½¿ç”¨ maturin è¿™ç§æ„å»ºå·¥å…·ã€‚ä½ å¯ä»¥ä¸‹è½½ä»£ç åï¼ŒæŒ‰ä¸‹é¢çš„è„šæœ¬å‡†å¤‡å¥½è™šæ‹Ÿç¯å¢ƒï¼Œå¹¶åœ¨è¿™ä¸ªè™šæ‹Ÿç¯å¢ƒé‡Œå®‰è£…å¥½ maturinã€‚</p><pre><code class=\"language-plain\">$ cd bigint-pyo3\n$ python -m venv .env\n$ source .env/bin/activate\n$ pip install maturin\n</code></pre><p>åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œï¼š</p><pre><code class=\"language-plain\">maturin develop -r\n</code></pre><p>è¿™ä¸ªæŒ‡ä»¤ä¼šç¼–è¯‘Rustä»£ç ä¸º release æ¨¡å¼ï¼Œå¹¶æŠŠç¼–è¯‘åçš„æ–‡ä»¶å®‰è£…åˆ° Python module åº“çš„ç›®å½•ç»„ç»‡é‡Œå»ã€‚</p><p>ç„¶åè¿è¡Œï¼š</p><pre><code class=\"language-plain\">$ time python fib_rust.py\n\nreal&nbsp; &nbsp; 0m12.452s\nuser&nbsp; &nbsp; 0m12.431s\nsys&nbsp; &nbsp; &nbsp;0m0.020s\n</code></pre><p>æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹çº¯Pythonç‰ˆæœ¬è¿è¡Œçš„æ—¶é—´ã€‚</p><pre><code class=\"language-plain\">$ time python fib.py\n\nreal&nbsp; &nbsp; 0m21.730s\nuser&nbsp; &nbsp; 0m21.490s\nsys&nbsp; &nbsp; &nbsp;0m0.240s\n</code></pre><p>è¿™æ˜¯è®¡ç®—ç¬¬200ä¸‡é¡¹æ–æ³¢é‚£å¥‘æ•°ï¼Œå¯ä»¥çœ‹åˆ°ç”¨Rustå®ç°çš„ç‰ˆæœ¬å¿«å°†è¿‘ä¸€å€ã€‚</p><p>PyO3ç»™æˆ‘ä»¬æä¾›çš„ç¼–ç¨‹ç•Œé¢éå¸¸æ¸…çˆ½ï¼Œåªè¦ä½ è·Ÿç€æ“ä½œä¸€éï¼Œå¾ˆå¿«å°±èƒ½ç”¨Rustç»™Pythonå†™æ‰©å±•äº†ã€‚PyO3çš„<a href=\"https://pyo3.rs\">æ–‡æ¡£</a>ä¹Ÿå†™å¾—éå¸¸å¥½ï¼Œä¸Šé¢æœ‰æ›´å…¨é¢çš„åŠŸèƒ½ä»‹ç»ï¼Œä¸€å®šè¦è¯»ä¸€è¯»ã€‚</p><h3>æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹ï¼šæ–‡æœ¬å•è¯ç»Ÿè®¡</h3><p>Pythonçš„GILï¼ˆGlobal Interpreter Lockï¼‰æ˜¯ä¸€ä¸ªè¢«äººè¯Ÿç—…çš„ç‰¹æ€§ï¼Œå®ƒé™åˆ¶å¾ˆå¤šPythonä»£ç åªèƒ½ä»¥å•çº¿ç¨‹çš„å½¢å¼æ¥è·‘ã€‚å› æ­¤ä¹Ÿå°±å¤§å¤§é™åˆ¶äº†Pythonçš„æ€§èƒ½ã€‚è€ŒRuståŸç”Ÿæ”¯æŒç³»ç»Ÿçº§å¤šçº¿ç¨‹ï¼ˆthreadï¼‰ä»¥åŠè½»é‡çº§çº¿ç¨‹ï¼ˆtokio task ç­‰ï¼‰ï¼Œèƒ½å¤Ÿéå¸¸æ–¹ä¾¿åœ°å……åˆ†å‹æ¦¨æ‰€æœ‰CPUæ ¸ã€‚æ—¢ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Rustç»™Pythonå†™æ‰©å±•ï¼Œé‚£ä¸€ä¸ªç‚¹å­å°±é¡ºç†æˆç« å†’å‡ºæ¥äº†â€”â€”å¯ä»¥ä½¿ç”¨Rustç»™Pythonå†™æ‰©å±•å®ç°å¹¶è¡Œè®¡ç®—ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±ä»¥å®˜æ–¹çš„ç¤ºä¾‹ word_count æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ã€‚è¿™ä¸ªç¨‹åºè¦è§£å†³è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šç»Ÿè®¡å‡ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶é‡Œï¼ŒæŸä¸€ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ã€‚è¿™ä¸ªæ–‡æœ¬æ–‡ä»¶æ˜¯æŒ‰æ¢è¡Œç¬¦åˆ†éš”æˆä¸€è¡Œä¸€è¡Œçš„ï¼Œè¡Œä¸è¡Œä¹‹é—´äº’ä¸å¹²æ¶‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨æŒ‰è¡Œåˆ†å‰²çš„å½¢å¼æ¥å¹¶è¡ŒåŒ–å¤„ç†ã€‚</p><p>Rustä¸­æœ‰ä¸€ä¸ªè‘—åçš„å¹¶è¡ŒåŒ–åº“Rayonï¼Œå¯ä»¥å°†ä¸²è¡Œè¿­ä»£å™¨è½¬æ¢æˆä¸€ä¸ªå¹¶è¡ŒåŒ–ç‰ˆæœ¬çš„è¿­ä»£å™¨ï¼Œä»è€Œå®ç°ç¨‹åºçš„å¹¶è¡ŒåŒ–ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä»£ç ï¼š</p><pre><code class=\"language-plain\">use pyo3::prelude::*;\nuse rayon::prelude::*;\n\n/// å¹¶è¡ŒåŒ–ç‰ˆæœ¬çš„æœç´¢åŠŸèƒ½å®ç°\n#[pyfunction]\nfn search(contents: &amp;str, needle: &amp;str) -&gt; usize {\n&nbsp; &nbsp; contents\n&nbsp; &nbsp; &nbsp; &nbsp; .par_lines()\n&nbsp; &nbsp; &nbsp; &nbsp; .map(|line| count_line(line, needle))\n&nbsp; &nbsp; &nbsp; &nbsp; .sum()\n}\n\n/// å°†è¡ŒæŒ‰ç©ºæ ¼åˆ†å‰²ï¼Œç»Ÿè®¡ç›®æ ‡å•è¯æ•°ç›®\nfn count_line(line: &amp;str, needle: &amp;str) -&gt; usize {\n&nbsp; &nbsp; let mut total = 0;\n&nbsp; &nbsp; for word in line.split(' ') {\n&nbsp; &nbsp; &nbsp; &nbsp; if word == needle {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; total += 1;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp; &nbsp; total\n}\n\n// å¯¼å‡ºåˆ°Python module\n#[pymodule]\nfn word_count(_py: Python&lt;'_&gt;, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {\n&nbsp; &nbsp; m.add_function(wrap_pyfunction!(search, m)?)?;\n\n&nbsp; &nbsp; Ok(())\n}\n</code></pre><p>ä»£ç ä¸­ï¼Œ<code>search()</code> å‡½æ•°ä¸­ <code>contents.par_lines()</code> è¿™ä¸€è¡Œå°±æ˜¯ä½¿ç”¨çš„ Rayon é‡Œçš„ <code>par_lines()</code> è¿­ä»£å™¨ï¼Œå®ƒæ˜¯ <code>lines()</code> è¿­ä»£å™¨çš„å¹¶è¡ŒåŒ–ç‰ˆæœ¬ã€‚ä¸Šé¢çš„ search å®ç°å¯¹åº”ä¸‹é¢çš„ Python ç‰ˆæœ¬ã€‚</p><pre><code class=\"language-plain\">def search_py(contents: str, needle: str) -&gt; int:\n&nbsp; &nbsp; total = 0\n&nbsp; &nbsp; for line in contents.splitlines():\n&nbsp; &nbsp; &nbsp; &nbsp; for word in line.split(\" \"):\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if word == needle:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; total += 1\n&nbsp; &nbsp; return total\n</code></pre><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹<a href=\"https://github.com/miketang84/jikeshijian/tree/master/30-ffi/word-count\">é¡¹ç›®ä»£ç </a>ï¼Œè¿™ä¸ªé¡¹ç›®ä½¿ç”¨ <code>pytest-benchmark</code> æ¥åšæ€§èƒ½è¯„æµ‹ã€‚è¦è¿è¡Œæ€§èƒ½è¯„æµ‹ï¼Œä½ éœ€è¦å®‰è£… noxã€‚</p><pre><code class=\"language-plain\">// å…ˆå®‰è£…é¡¹ç›®ä¾èµ–\npip install .\n// å†å®‰è£… nox å·¥å…·\npip install nox\n</code></pre><p>ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œï¼š</p><pre><code class=\"language-plain\">nox -s bench\n</code></pre><p>ç¨ç­‰ç‰‡åˆ»ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">$ nox -s bench\nnox &gt; Running session bench\nnox &gt; Creating virtual environment (virtualenv) using python3 in .nox/bench\nnox &gt; python -m pip install '.[dev]'\nnox &gt; pytest --benchmark-enable\n=========================================================== test session starts ============================================================\nplatform linux -- Python 3.10.12, pytest-7.4.3, pluggy-1.3.0\nbenchmark: 4.0.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)\nrootdir: /home/mike/works/pyo3works/word-count\nconfigfile: pyproject.toml\nplugins: benchmark-4.0.0\ncollected 2 items\n\ntests/test_word_count.py ..&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [100%]\n\n\n\n----------------------------------------------------------------------------------------- benchmark: 2 tests ----------------------------------------------------------------------------------------\nName (time in ms)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Min&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Max&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Mean&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; StdDev&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Median&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IQR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Outliers&nbsp; &nbsp; &nbsp; OPS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Rounds&nbsp; Iterations\n-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\ntest_word_count_rust_parallel&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;19.6740 (1.0)&nbsp; &nbsp; &nbsp; 50.2725 (1.0)&nbsp; &nbsp; &nbsp; 27.9049 (1.0)&nbsp; &nbsp; &nbsp; 9.7562 (2.27)&nbsp; &nbsp; &nbsp;22.9368 (1.0)&nbsp; &nbsp; &nbsp; 8.5993 (1.13)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2;2&nbsp; 35.8360 (1.0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 13&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1\ntest_word_count_python_sequential&nbsp; &nbsp; &nbsp;78.4158 (3.99)&nbsp; &nbsp; &nbsp;91.5790 (1.82)&nbsp; &nbsp; &nbsp;84.4852 (3.03)&nbsp; &nbsp; &nbsp;4.3023 (1.0)&nbsp; &nbsp; &nbsp; 84.7501 (3.69)&nbsp; &nbsp; &nbsp;7.6210 (1.0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5;0&nbsp; 11.8364 (0.33)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;13&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1\n-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n\nLegend:\n&nbsp; Outliers: 1 Standard Deviation from Mean; 1.5 IQR (InterQuartile Range) from 1st Quartile and 3rd Quartile.\n&nbsp; OPS: Operations Per Second, computed as 1 / Mean\n============================================================ 2 passed in 2.78s =============================================================\nnox &gt; Session bench was successful.\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒRustå¹¶è¡ŒåŒ–ç‰ˆæœ¬æ¯”Pythoné¡ºåºåŒ–ç‰ˆæœ¬çš„å¹³å‡æ€§èƒ½æå‡äº†3å€å·¦å³ï¼ˆå¹¶è¡ŒåŒ–ç‰ˆæœ¬æ¶ˆè€—æ—¶é—´ä¸ºé¡ºåºåŒ–ç‰ˆæœ¬çš„1/3å·¦å³ï¼‰ï¼Œå®é™…ä¸Šè¢«å¤„ç†çš„æ–‡ä»¶è¶Šå¤§ï¼Œè¿™ä¸ªæ€§èƒ½æå‡å°±è¶Šæ˜æ˜¾ã€‚</p><h2>ä¸šç•ŒçŸ¥åPyO3ç»‘å®šé¡¹ç›®ä»‹ç»</h2><p>ç›®å‰ï¼ŒRustç”Ÿæ€å’ŒPythonä¹‹é—´å·²ç»æœ‰ä¸€äº›çŸ¥åçš„é¡¹ç›®ä½¿ç”¨ PyO3 å®ç°ç»‘å®šäº†ï¼Œæˆ‘é€‰äº†å‡ ä¸ªæ¯”è¾ƒä¸é”™çš„æ”¾åœ¨ä¸‹é¢ï¼Œä½ å¯ä»¥ç‚¹å‡»é“¾æ¥æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚</p><ul>\n<li>OpenDAL çš„ Python ç»‘å®šï¼š<a href=\"https://github.com/apache/incubator-opendal/tree/main/bindings/python\">https://github.com/apache/incubator-opendal/tree/main/bindings/python</a></li>\n<li>Polars çš„ Python ç»‘å®šï¼š<a href=\"https://github.com/pola-rs/polars/tree/main/py-polars\">https://github.com/pola-rs/polars/tree/main/py-polars</a></li>\n<li>Delta Lake çš„ Python ç»‘å®šï¼š<a href=\"https://github.com/delta-io/delta-rs/tree/main/python\">https://github.com/delta-io/delta-rs/tree/main/python</a></li>\n<li>Arrow-Datafusion çš„ Python ç»‘å®šï¼š<a href=\"https://github.com/apache/arrow-datafusion-python\">https://github.com/apache/arrow-datafusion-python</a></li>\n<li>tokenizers çš„ Python ç»‘å®šï¼š<a href=\"https://github.com/huggingface/tokenizers/tree/main/bindings/python\">https://github.com/huggingface/tokenizers/tree/main/bindings/python</a></li>\n</ul><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬é€šè¿‡4ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨Rustä¸­è°ƒç”¨Cå‡½æ•°ï¼Œå¦‚ä½•åœ¨Cå‡½æ•°ä¸­è°ƒç”¨Rustå‡½æ•°ï¼Œä»¥åŠåœ¨Pythonä¸­è°ƒç”¨Rustå®ç°çš„æ¨¡å—å’Œå‡½æ•°ã€‚å¹¶ä¸”é€šè¿‡å¯¹æ¯”Rustçš„å®ç°ç‰ˆæœ¬ä¸PythonåŸç”Ÿçš„å®ç°ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨Rustå†™Pythonæ‰©å±•æ€§èƒ½æ›´å¥½ã€‚</p><p>Unsafe Rustç¼–ç¨‹å¤§é‡å‡ºç°åœ¨åº•å±‚æ€§èƒ½çš„ä¼˜åŒ–å’Œä¸å…¶ä»–è¯­è¨€äº¤äº’çš„åœºæ™¯ä¸­ï¼Œä½“ç°äº†Rustè¿™é—¨è¯­è¨€ä¸€ä¸ªå¥‡ç‰¹çš„åœ°æ–¹ï¼šRustè¯­è¨€æœ¬èº«å¯¹å®‰å…¨æ€§å’Œæ€§èƒ½çš„è¿½æ±‚ï¼Œä¸ä½†è®©Rustæœ¬èº«è„±é¢–è€Œå‡ºï¼Œè€Œä¸”è¿˜åå“ºäº†Cè¯­è¨€çš„ç”Ÿæ€ï¼Œç”¨Rusté‡æ–°å®ç°ä¸€éƒ¨åˆ†æ¨¡å—ï¼ŒåŒæ—¶è¿˜èƒ½æ— ç¼åœ°æ¥å…¥ä¹‹å‰çš„Cç³»ç»Ÿä¸­ï¼Œæå‡äº†ä¹‹å‰Cç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚å¹¶ä¸”è¿™æ˜¯ä¸€ç§æ¸è¿›çš„åšæ³•ï¼Œéå¸¸æœ‰åˆ©äºå†å²é—ç•™ç³»ç»Ÿçš„è¿­ä»£æ›´æ–°ã€‚</p><p>æ­¤å¤–ï¼ŒUnsafe Rustç¼–ç¨‹è¿˜å¯ä»¥èµ‹èƒ½å…¶ä»–è¯­è¨€ç¤¾åŒºï¼Œå°†Rustçš„æ¾æ¹ƒåŠ¨åŠ›å’Œå®‰å…¨æ‰©å±•åˆ°äº†Pythonã€JavaScriptç­‰å…¶ä»–è¯­è¨€ã€‚å®ƒä»¬ä¹‹å‰çš„æ‰©å±•ä½¿ç”¨C/C++ç¼–å†™ï¼ŒåŒæ ·ä¼šå­˜åœ¨å®‰å…¨æ€§å’Œç¨³å®šæ€§çš„é—®é¢˜ï¼Œè€ŒRustè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p><p>ä¸è¿‡æ¶‰åŠåˆ°Unsafe Rustå’ŒFFIçš„åœºæ™¯ï¼Œæƒ³è¦å°è£…ä¸€ä¸ªçœŸæ­£å¥½ç”¨çš„åº“æˆ–æ‰©å±•ï¼Œè¿˜æœ‰å¤§é‡çš„ç»†èŠ‚çŸ¥è¯†å¾…ä½ æ¢ç´¢ã€‚ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬å·²ç»è¸ä¸Šäº†å®‰å…¨æå‡å’Œæ€§èƒ½æå‡ä¹‹è·¯ï¼Œæœ‰Rustä¸ºä½ è¾“å‡ºåŠ¨åŠ›ï¼Œä¿é©¾æŠ¤èˆªï¼Œä½ ä¾¿å¯ä»¥æ”¾å¼€æ‰‹è„šï¼Œå¤§èƒ†å»å¹²ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·ä½ èŠä¸€èŠï¼ŒCè¯­è¨€ä¸­çš„charä¸Rustä¸­çš„charçš„åŒºåˆ«åœ¨å“ªé‡Œï¼ŸCè¯­è¨€çš„å­—ç¬¦ä¸²ä¸Rustä¸­çš„StringåŒºåˆ«åœ¨å“ªé‡Œï¼Ÿå¦‚ä½•å°†Cè¯­è¨€çš„å­—ç¬¦ä¸²ç±»å‹æ˜ å°„åˆ°Rustçš„ç±»å‹ä¸­æ¥ï¼Ÿæ¬¢è¿ä½ æŠŠè‡ªå·±çš„æ€è€ƒåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"29ï½œUnsafeç¼–ç¨‹ï¼ˆä¸Šï¼‰ï¼š Unsafe Rustä¸­é‚£äº›è¢«å°å°çš„èƒ½åŠ›","id":739345},"right":{"article_title":"ç»“æŸè¯­ï½œæœªæ¥è®©Rustå¸¦ä½ â€œé”ˆâ€åˆ°èµ·é£","id":740385}},"comments":[{"had_liked":false,"id":388309,"user_name":"å°å¯çˆ±(`ã¸Â´*)ãƒ","can_delete":false,"product_type":"c1","uid":1016404,"ip_address":"é‡åº†","ucode":"E75189846F6616","user_header":"https://static001.geekbang.org/account/avatar/00/0f/82/54/b9cd3674.jpg","comment_is_top":false,"comment_ctime":1709857021,"is_pvip":false,"replies":[{"id":141473,"content":"è°¢è°¢","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1710434371,"ip_address":"åŠ æ‹¿å¤§","comment_id":388309,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è·Ÿå®Œäº†ï¼Œå¾ˆå€¼å¾—çš„ï¼Œè€å¸ˆåŠŸåº•å¾ˆåšã€‚","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":639284,"discussion_content":"è°¢è°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1710434372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŠ æ‹¿å¤§","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386094,"user_name":"ä¸€å¸¦ä¸€è·¯","can_delete":false,"product_type":"c1","uid":1633613,"ip_address":"å››å·","ucode":"BD3E750A9EBF25","user_header":"https://static001.geekbang.org/account/avatar/00/18/ed/4d/7df516d5.jpg","comment_is_top":false,"comment_ctime":1704091394,"is_pvip":false,"replies":[{"id":140726,"content":"æœªæ¥å¯æœŸï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704170660,"ip_address":"é‡åº†","comment_id":386094,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"Rust ä¸ Python ç»‘å®šæœªæ¥å¯æœŸï¼","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634875,"discussion_content":"æœªæ¥å¯æœŸï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704170660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":387204,"user_name":"A0.ä½•æ–‡ç¥¥","can_delete":false,"product_type":"c1","uid":1052569,"ip_address":"å¹¿ä¸œ","ucode":"2549126DAEA15D","user_header":"https://static001.geekbang.org/account/avatar/00/10/0f/99/0d72321f.jpg","comment_is_top":false,"comment_ctime":1706699006,"is_pvip":false,"replies":[{"id":141162,"content":"æˆ‘ç»™çš„æºä»£ç é‡Œé¢æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œæ³¨é‡Šæ‰äº†ã€‚ä½ å¯ä»¥ç ”ç©¶ç ”ç©¶ã€‚å…³é—­çš„åŸå› æ˜¯ä¸ºäº†ç®€åŒ–éš¾åº¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1707198559,"ip_address":"å››å·","comment_id":387204,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è€å¸ˆï¼Œæˆ‘æ ¹æ®æ–‡æ¡£https:&#47;&#47;pyo3.rs&#47;v0.20.2&#47;parallelismäº†è§£åˆ°ï¼Œå¦‚æœè¦åœ¨PyO3é‡ŒRelease GILéœ€è¦æ‰§è¡ŒPython::allow_threadsï¼Œå’±ä»¬å®ä¾‹æ˜¯ä¸æ˜¯é—æ¼äº†è¿™ä¸€æ­¥ï¼Œå®é™…è·‘çš„è¿˜æ˜¯single CPU coreã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636896,"discussion_content":"æˆ‘ç»™çš„æºä»£ç é‡Œé¢æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œæ³¨é‡Šæ‰äº†ã€‚ä½ å¯ä»¥ç ”ç©¶ç ”ç©¶ã€‚å…³é—­çš„åŸå› æ˜¯ä¸ºäº†ç®€åŒ–éš¾åº¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1707198559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386876,"user_name":"tan","can_delete":false,"product_type":"c1","uid":1477463,"ip_address":"ä¸­å›½é¦™æ¸¯","ucode":"20E176CB1EFD51","user_header":"https://static001.geekbang.org/account/avatar/00/16/8b/57/a3daeaae.jpg","comment_is_top":false,"comment_ctime":1705764378,"is_pvip":false,"replies":[{"id":141076,"content":"è¿™ç§è§‚æµ‹ä¸å‡†ï¼Œå› ä¸ºæ··æ‚äº†åŠ è½½æ–‡ä»¶çš„æ—¶é—´åœ¨é‡Œé¢ã€‚ä¸è¿‡é‚£ä¸ª12ç§’å¤šçš„å·®è·æœ‰ç‚¹åƒæƒŠäº†ã€‚ä½ å¼€äº†releaseç¼–è¯‘æ²¡","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705970862,"ip_address":"é‡åº†","comment_id":386876,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"window è§‚æµ‹æ—¶é—´ï¼š Measure-Command {python .\\fib_rust.py}    ã€‚\nps: ä¸ºä»€ä¹ˆæˆ‘åœ¨window10ä¸Šæµ‹è¯• pythonè‡ªå·±å†™çš„å‡½æ•°åªè¦ 0.49s, è°ƒç”¨rustçš„éœ€è¦12s\nps: å¦‚æœæœ‰åŒå­¦ä¸å…³å¿ƒæ‰§è¡Œæ—¶é—´æƒ³è¦ç¡®å®šè°ƒç”¨æˆåŠŸä¸å¦ï¼Œéœ€è¦`calc_fib` æŠŠç»™è¿™ä¸ªå‡½æ•°è¿”å›å€¼","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636341,"discussion_content":"è¿™ç§è§‚æµ‹ä¸å‡†ï¼Œå› ä¸ºæ··æ‚äº†åŠ è½½æ–‡ä»¶çš„æ—¶é—´åœ¨é‡Œé¢ã€‚ä¸è¿‡é‚£ä¸ª12ç§’å¤šçš„å·®è·æœ‰ç‚¹åƒæƒŠäº†ã€‚ä½ å¼€äº†releaseç¼–è¯‘æ²¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705970862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386868,"user_name":"zxk","can_delete":false,"product_type":"c1","uid":1221195,"ip_address":"æµ·å—","ucode":"4BB2BD9D2BCD04","user_header":"https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg","comment_is_top":false,"comment_ctime":1705737981,"is_pvip":false,"replies":[{"id":141020,"content":"çœŸæ£’ğŸ‘ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705760738,"ip_address":"é‡åº†","comment_id":386868,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"C è¯­è¨€ä¸­çš„ char æ˜¯ä¸€ä¸ª 8bit å¤§å°çš„ç±»å‹ï¼Œä¸€ä¸ª char å¯ä»¥è¦†ç›– ASCII ç è¡¨ï¼›è€Œåœ¨ Rust ä¸­ char æ˜¯ä¸€ä¸ª Unicode å­—ç¬¦ï¼Œä½¿ç”¨ 32bitï¼ˆå³ UTF-32ï¼‰è¿›è¡Œå­˜å‚¨ã€‚\n\nC è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²å…¶å®å°±æ˜¯ä¸€ä¸ª char æ•°ç»„ï¼Œå¹¶ä»¥ `\\0` ä½œä¸ºç»“æŸæ ‡å¿—ï¼›è€Œ Rust ä¸­çš„ String æ˜¯ç»è¿‡ UTF-8 ç¼–ç åçš„å­—èŠ‚æ•°ç»„ï¼Œä¸€ä¸ªå®é™…çš„å­—ç¬¦å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ªå­—èŠ‚ï¼ˆUTF-8 æ˜¯å¯å˜é•¿ç¼–ç ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªé•¿åº¦æ¥å¾—å‡ºå­—ç¬¦ä¸²çš„ç»“æŸä½ç½®ã€‚\n\nè‹¥è¦å°† C è¯­è¨€çš„å­—ç¬¦ä¸²ç±»å‹æ˜ å°„åˆ° Rust ä¸­çš„ç±»å‹ï¼Œç›®å‰èƒ½æƒ³åˆ°ä¸¤ç§æ–¹æ¡ˆï¼š\n1. C ç«¯ä»¥ UTF-8 çš„æ–¹å¼ç¼–ç å­˜å‚¨å­—ç¬¦ä¸²ï¼Œå¹¶ä¼ é€’ç»™ Rustï¼› Rust å¯ä»¥é€‰æ‹©ä½¿ç”¨ CString å­˜å‚¨åœ¨è½¬åŒ–ï¼Œæˆ–è€…è‡ªè¡Œè§£æå¹¶æ³¨æ„ `\\0` çš„æ ‡è¯†ç¬¦ï¼›\n2. C ç«¯è‡ªç”±é€‰æ‹©ç¼–ç ï¼Œåœ¨ä¼ ç»™ Rust æ—¶å‘Šè¯‰ Rust ç¼–ç æ–¹å¼ï¼Œå¹¶ç”± Rust è‡ªè¡Œè§£ç ï¼Œå¹¶è½¬ä¸ºå†…éƒ¨çš„ UTF-8 ç¼–ç ã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636186,"discussion_content":"çœŸæ£’ğŸ‘ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705760738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386217,"user_name":"Noya","can_delete":false,"product_type":"c1","uid":1519230,"ip_address":"æµ™æ±Ÿ","ucode":"52EEB72E80BAF8","user_header":"https://static001.geekbang.org/account/avatar/00/17/2e/7e/a15b477c.jpg","comment_is_top":false,"comment_ctime":1704346812,"is_pvip":false,"replies":[{"id":140783,"content":"çœŸæ£’ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704366240,"ip_address":"é‡åº†","comment_id":386217,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å®Œç»“!","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635063,"discussion_content":"çœŸæ£’ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704366240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386102,"user_name":"åˆ˜ä¸¹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"å¹¿ä¸œ","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1704106411,"is_pvip":false,"replies":[{"id":140721,"content":"åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ¯”è¾ƒä¸€ä¸‹è®¡ç®—æ€§èƒ½ã€‚ä½ å¯ä»¥å°è¯•æ”¹è¿›ä¸€ä¸‹è¿™ä¸ªç¤ºä¾‹ã€‚ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704162265,"ip_address":"é‡åº†","comment_id":386102,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¯·é—®åœ¨ calc_fib å‡½æ•°é‡Œï¼Œä¸ºä»€ä¹ˆ fib çš„è®¡ç®—ç»“æœè¢«ä¸¢å¼ƒï¼Œè€Œè¿”å› Ok(()) å‘¢ï¼Ÿ\n","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634869,"discussion_content":"åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ¯”è¾ƒä¸€ä¸‹è®¡ç®—æ€§èƒ½ã€‚ä½ å¯ä»¥å°è¯•æ”¹è¿›ä¸€ä¸‹è¿™ä¸ªç¤ºä¾‹ã€‚ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704162265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1633613,"avatar":"https://static001.geekbang.org/account/avatar/00/18/ed/4d/7df516d5.jpg","nickname":"ä¸€å¸¦ä¸€è·¯","note":"","ucode":"BD3E750A9EBF25","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634956,"discussion_content":"æ˜¯çš„\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704208871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386101,"user_name":"åˆ˜ä¸¹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"å¹¿ä¸œ","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1704105364,"is_pvip":false,"replies":[{"id":140727,"content":"è¿™ä¸ªå·¥ç¨‹æ–‡ä»¶æ˜¯ maturin åˆ›å»ºçš„ . æ²¡æœ‰åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ, æˆ‘è¿˜æ²¡è¯•è¿‡. å¯èƒ½maturinèƒ½è¯†åˆ«é»˜è®¤é…ç½®å§.","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704170877,"ip_address":"é‡åº†","comment_id":386101,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¯·é—®è€å¸ˆï¼Œpyproject.toml è¿™ä¸ªæ–‡ä»¶æ˜¯å“ªä¸ªå·¥å…·éœ€è¦çš„ï¼Ÿ æˆ‘æŒ‰æœ¬è¯¾æ•™ç¨‹æ“ä½œï¼Œæ²¡æœ‰åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634876,"discussion_content":"è¿™ä¸ªå·¥ç¨‹æ–‡ä»¶æ˜¯ maturin åˆ›å»ºçš„ . æ²¡æœ‰åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ, æˆ‘è¿˜æ²¡è¯•è¿‡. å¯èƒ½maturinèƒ½è¯†åˆ«é»˜è®¤é…ç½®å§.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704170877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":1633613,"avatar":"https://static001.geekbang.org/account/avatar/00/18/ed/4d/7df516d5.jpg","nickname":"ä¸€å¸¦ä¸€è·¯","note":"","ucode":"BD3E750A9EBF25","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":634955,"discussion_content":"å‘å¸ƒå°±ä¸è¡Œäº†ï¼ŒPyPIå‘å¸ƒè¿™ä¸ªåº“æ˜¯éœ€è¦çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704208847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":634876,"ip_address":"å››å·","group_id":0},"score":634955,"extra":""}]},{"author":{"id":1081922,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","nickname":"åˆ˜ä¸¹","note":"","ucode":"66594D1C957E15","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634960,"discussion_content":"åœ¨åé¢çš„ä¾‹å­é‡Œå‘ç° pip install . ä¼šè¯†åˆ«ä½¿ç”¨åˆ° pyproject.toml  è¿™ä¸ªæ–‡ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704240248,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386100,"user_name":"Geek_72807e","can_delete":false,"product_type":"c1","uid":3570665,"ip_address":"å±±è¥¿","ucode":"9E9A6277605048","user_header":"","comment_is_top":false,"comment_ctime":1704103359,"is_pvip":false,"replies":[{"id":140728,"content":"é™ˆå¤©è€å¸ˆçš„è¯¾,æ•™ä½ å®Œæ•´åœ°åšä¸€ä¸ªkv db. æŒºä¸é”™çš„.  é™ˆè€å¸ˆçš„è¯¾å¯ä»¥çœ‹ä½œæ˜¯æœ¬è¯¾ç¨‹çš„è¿›é˜¶è¯¾ç¨‹.","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704170914,"ip_address":"é‡åº†","comment_id":386100,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"åŸºæœ¬è·Ÿå®Œäº†è€å¸ˆçš„è¯¾ç¨‹ï¼Œè¿˜æœ‰å“ªäº›è¿›é˜¶å†…å®¹æˆ–å‚è€ƒèµ„æ–™è€å¸ˆæ¨èä¸€ä¸‹ï¼Ÿï¼","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634877,"discussion_content":"é™ˆå¤©è€å¸ˆçš„è¯¾,æ•™ä½ å®Œæ•´åœ°åšä¸€ä¸ªkv db. æŒºä¸é”™çš„.  é™ˆè€å¸ˆçš„è¯¾å¯ä»¥çœ‹ä½œæ˜¯æœ¬è¯¾ç¨‹çš„è¿›é˜¶è¯¾ç¨‹.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704170914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":1633613,"avatar":"https://static001.geekbang.org/account/avatar/00/18/ed/4d/7df516d5.jpg","nickname":"ä¸€å¸¦ä¸€è·¯","note":"","ucode":"BD3E750A9EBF25","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":634954,"discussion_content":"èµçˆ†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704208788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":634877,"ip_address":"å››å·","group_id":0},"score":634954,"extra":""}]}]},{"had_liked":false,"id":396323,"user_name":"é™ˆå§è™«","can_delete":false,"product_type":"c1","uid":1481979,"ip_address":"æµ™æ±Ÿ","ucode":"44BB84712436AB","user_header":"https://static001.geekbang.org/account/avatar/00/16/9c/fb/7fe6df5b.jpg","comment_is_top":false,"comment_ctime":1733973754,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":5,"score":2,"product_id":100626901,"comment_content":"çœŸçš„è®²çš„å¾ˆå¥½ï¼Œæˆ‘å­¦ä¹  rust çš„ç¬¬ä¸€è¯¾ï¼Œè°¢è°¢è€å¸ˆğŸ™","like_count":0}]}