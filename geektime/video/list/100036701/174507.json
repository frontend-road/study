{"id":174507,"title":"49 | 安全增强：启用空闲监测","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":159127,"user_name":"fancion","can_delete":false,"product_type":"c3","uid":1121584,"ip_address":"","ucode":"9000895F6BE0E4","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/30/4a82c7af.jpg","comment_is_top":false,"comment_ctime":1575543746,"is_pvip":false,"replies":[{"id":61452,"content":"你把断开连接理解成为了防止恶意的人做连接不做事的情况，而心跳是为了自己信任的机器没做事也不被断开连接，这样理解就不冲突了。那你可能会想那恶意的人也定时发乱七八糟的信息不就行了？所以我们加了授权，第一个消息必须是授权。所以他也攻击不了的。总之有点饶人，可以一个一个判断需求来添加就容易理解了。\n再说点饶人的话:断开是断开，心跳是心跳，心跳有的时候是为了监测已断掉的连接，而有的时候为了不断开连接而做心跳用来证明自己还在。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576137365,"ip_address":"","comment_id":159127,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"请问老师，这里的断开链接和心跳本身冲突没？怎么理解好一点？","like_count":3,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476959,"discussion_content":"你把断开连接理解成为了防止恶意的人做连接不做事的情况，而心跳是为了自己信任的机器没做事也不被断开连接，这样理解就不冲突了。那你可能会想那恶意的人也定时发乱七八糟的信息不就行了？所以我们加了授权，第一个消息必须是授权。所以他也攻击不了的。总之有点饶人，可以一个一个判断需求来添加就容易理解了。\n再说点饶人的话:断开是断开，心跳是心跳，心跳有的时候是为了监测已断掉的连接，而有的时候为了不断开连接而做心跳用来证明自己还在。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576137365,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167967,"user_name":"有个不可","can_delete":false,"product_type":"c3","uid":1444978,"ip_address":"","ucode":"D8B8C0796C9A7E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eryISBbUnI2TMKAwVltOd5tLdbQDunvubib8hzoTjOfORmBp4ib2RDvGlUFpydSoLHkEa2CeJJ4j1rQ/132","comment_is_top":false,"comment_ctime":1577970042,"is_pvip":false,"replies":[{"id":65351,"content":"不是的，是因为KeepaliveHandler里面遇到idle就写了keepalive数据，所以相当于重置了idle的状态，具体而言：\n写的时候（idleStateHandler#write）会回调：IdleStateHandler#writeListener\n然后重置了状态位：\nfirstWriterIdleEvent = firstAllIdleEvent = true;\n\n从你的这个问题，你可以去理解下为什么要区分第一次和后面的。你可以这样测下，就是把client的idle检测后的发送消息去掉，然后把server的idle check后的关闭连接给去掉，进而测试体会下。谢谢。\n\n","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1578101989,"ip_address":"","comment_id":167967,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师问一下，为什么客户端KeepaliveHandler触发时间每次都是IdleStateEvent.FIRST_WRITER_IDLE_STATE_EVENT，看了一下源码，IdleStateHandler里面的firstWriterIdleEvent初始默认为true，发过一次事件后会改为false，下次触发事件应该是IdleStateEvent.WRITER_IDLE_STATE_EVENT，难道是因为多线程的可见性问题导致的吗？","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480075,"discussion_content":"不是的，是因为KeepaliveHandler里面遇到idle就写了keepalive数据，所以相当于重置了idle的状态，具体而言：\n写的时候（idleStateHandler#write）会回调：IdleStateHandler#writeListener\n然后重置了状态位：\nfirstWriterIdleEvent = firstAllIdleEvent = true;\n\n从你的这个问题，你可以去理解下为什么要区分第一次和后面的。你可以这样测下，就是把client的idle检测后的发送消息去掉，然后把server的idle check后的关闭连接给去掉，进而测试体会下。谢谢。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578101989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169319,"user_name":"WING","can_delete":false,"product_type":"c3","uid":1485200,"ip_address":"","ucode":"E4723BA4027407","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IdElofI20lsCUm1NIQPSpYFzAGLbLs41SL324FkmTb0icqnRJicW6mqX4iag1BQUSNtc7BtKJ2fEUYwU4rN47vEsQ/132","comment_is_top":false,"comment_ctime":1578314086,"is_pvip":false,"replies":[{"id":65700,"content":"如果别人知道你的服务器IP，你说的情况确实会发生;\n所以idle保护仅仅是减缓这种情况，还需要其他的，比如紧接着的第50节“黑白名单”，但是直接使用可能不够，需要写一些代码。总结一下对这种问题的一些做法供你参考和选择：\n（1）设置一个ip只能建N个连接，当然这个是根据需求来的，就是根据实际情况减少建太多连接的情况\n（2）如果一个ip做的连接因为idle断连，且断连的时候还没有经过任何授权（可以在连接上设置一个attribute属性，比如IsAuth来标记可做过授权），只要N次以上，则自动将ip加入黑名单，以后不给它再做连接了：需要自己写写代码。\n（3）下下策：考虑设置so_reuseaddr来减少time_wait时间（当然或许本来你就设置了，那样会很快解除time_wait状态的）\n等等吧，总之根据攻击特征做防范就行。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1578361383,"ip_address":"","comment_id":169319,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，如果黑客知道了服务端的地址和端口，然后只是进行大量的TCP连接（大量肉鸡），不发任何信息。服务端idle检查后主动关闭channel，因为是服务端主动关闭的，这样会不会导致大量的TIME_WAIT消耗服务端的资源？如果会有什么办法防御？","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480506,"discussion_content":"如果别人知道你的服务器IP，你说的情况确实会发生;\n所以idle保护仅仅是减缓这种情况，还需要其他的，比如紧接着的第50节“黑白名单”，但是直接使用可能不够，需要写一些代码。总结一下对这种问题的一些做法供你参考和选择：\n（1）设置一个ip只能建N个连接，当然这个是根据需求来的，就是根据实际情况减少建太多连接的情况\n（2）如果一个ip做的连接因为idle断连，且断连的时候还没有经过任何授权（可以在连接上设置一个attribute属性，比如IsAuth来标记可做过授权），只要N次以上，则自动将ip加入黑名单，以后不给它再做连接了：需要自己写写代码。\n（3）下下策：考虑设置so_reuseaddr来减少time_wait时间（当然或许本来你就设置了，那样会很快解除time_wait状态的）\n等等吧，总之根据攻击特征做防范就行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578361383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1485200,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/IdElofI20lsCUm1NIQPSpYFzAGLbLs41SL324FkmTb0icqnRJicW6mqX4iag1BQUSNtc7BtKJ2fEUYwU4rN47vEsQ/132","nickname":"WING","note":"","ucode":"E4723BA4027407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":122946,"discussion_content":"感谢老师的详细回答。对于第二个做法，我有点疑问：设置channel的attr，但是断连后这个channel不会销毁吗？同一个ip下一次再连上了应该是一个新的channel实例了，不知我的理解对不对？我想到的是用redis计数来做这个黑白名单。\n\n另外还想请教老师一个问题：我写的程序曾经被攻击过，有大量的非法ip连上来，有同事说是有人控制肉鸡攻击，有同事说是伪造的ip，想请教老师，伪造ip发tcp数据包攻击是否有可能?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578381573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1485200,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/IdElofI20lsCUm1NIQPSpYFzAGLbLs41SL324FkmTb0icqnRJicW6mqX4iag1BQUSNtc7BtKJ2fEUYwU4rN47vEsQ/132","nickname":"WING","note":"","ucode":"E4723BA4027407","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":124795,"discussion_content":"你直接回复评论，我是看不到的，除非我点开视频页面一个一个翻，所以下次你可以另外提一个问题，然后我们再一起讨论。今天刚好我点开了视频页面，所以我才看到您的这个问题了。哈哈\n\n1 断连了确实销毁了，你的理解是对的，所以在断连的时候，你要想办法记录下来这个ip，不然等于啥也没有干，然后这个ip记录到哪是另外一个问题，你说的redis确实可以，相当于全局了，比记录在本地的拦截效果更好点，当然记录在本地也行，只是说这个机器拦住了，另外一个机器可能还需要点时间才能拦住。\n\n2 伪造ip有可能，但是你想下，TCP是三次握手的，你伪造IP发了第一个SYN，那我们的服务器肯定把ack和syn回给伪造的地址去了，所以虽然耗资源，但是连接是建立不起来的，这个叫syn攻击吧，应该不是你遇到的那种情况。这个安全攻击太多了，被人盯上都是头疼，我搞了一个小的个人网站还被人攻击了，也是类似ddos攻击，也是根据别人的攻击特征，设置自动黑名单，才把资源利用率给搞降低了。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1578451026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":122946,"ip_address":"","group_id":0},"score":124795,"extra":""}]}]},{"had_liked":false,"id":161570,"user_name":"Peter","can_delete":false,"product_type":"c3","uid":1595382,"ip_address":"","ucode":"A77322C4E07B2D","user_header":"https://static001.geekbang.org/account/avatar/00/18/57/f6/2c7ac1ad.jpg","comment_is_top":false,"comment_ctime":1576234948,"is_pvip":false,"replies":[{"id":61549,"content":"不同channel的某一个handler对象是否相同，共享判断方法参考直播的pdf(课程git里)里面有，可以下载下看看。这里我不重复复制粘贴了。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576264793,"ip_address":"","comment_id":161570,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师2个问题：我们课程里老出现的这个 “共享” 是什么意思啊，是谁跟谁共享什么？第二个问题怎么判断我们写的一个Handler要不要共享？","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477766,"discussion_content":"不同channel的某一个handler对象是否相同，共享判断方法参考直播的pdf(课程git里)里面有，可以下载下看看。这里我不重复复制粘贴了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576264793,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187100,"user_name":"被过去推开","can_delete":false,"product_type":"c3","uid":1276690,"ip_address":"","ucode":"8B4F34FE93FD5B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Cib5umA0W17N9pichI08pnrXAExdbyh7AVzH4nEhD6KN3FXuELk4LJJuqUPPD7xmIy9nq5Hjbgnzic7sVZG5BKiaUQ/132","comment_is_top":false,"comment_ctime":1584015780,"is_pvip":false,"replies":[{"id":79276,"content":"不一样，层次不同，一个是tcp层的，一个是应用层的，你如果上层做过了，下层不做确实也可以。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1588641605,"ip_address":"","comment_id":187100,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"只要在pipeline加入了idle检测相关的handler，就不用去设置childOption中的keepalive选项了，这个对吗？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486990,"discussion_content":"不一样，层次不同，一个是tcp层的，一个是应用层的，你如果上层做过了，下层不做确实也可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588641605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":292795,"user_name":"Geek_1cc6d1","can_delete":false,"product_type":"c3","uid":1850248,"ip_address":"","ucode":"3E083616DD0742","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erZCyXaP2gbxwFHxvtnyaaF2Pyy5KkSMsk9kh7SJl8icp1CD6wicb6VJibiblGibbpDo6IuHrdST6AnWQg/132","comment_is_top":false,"comment_ctime":1620982537,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，在网络断开后到调用writeAndFlush 抛出异常之间的时间是什么参数配置的（这个时间是超过心跳检查时间的）","like_count":0,"discussions":[{"author":{"id":1850248,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erZCyXaP2gbxwFHxvtnyaaF2Pyy5KkSMsk9kh7SJl8icp1CD6wicb6VJibiblGibbpDo6IuHrdST6AnWQg/132","nickname":"Geek_1cc6d1","note":"","ucode":"3E083616DD0742","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374526,"discussion_content":"本地测试时发现。如果对端被kill了，writeAndFlush还是会正常返回，过段时间才会抛异常","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621234729,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":221799,"user_name":"夏目","can_delete":false,"product_type":"c3","uid":1212750,"ip_address":"","ucode":"67C075A01CF4D2","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg","comment_is_top":false,"comment_ctime":1590593206,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，你这里客户端发送的keepalive消息好像就是一个正常的消息发送，在服务端那边会解析处理的吧","like_count":0,"discussions":[{"author":{"id":1670039,"avatar":"https://static001.geekbang.org/account/avatar/00/19/7b/97/950082a4.jpg","nickname":"fish","note":"","ucode":"EBC306460F2962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363617,"discussion_content":"心跳一般回复收到即可，业务不考虑放在此报文","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617246295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}