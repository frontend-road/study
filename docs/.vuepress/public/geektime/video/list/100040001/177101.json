{"id":177101,"title":"25 | 分片集群机制及原理","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":173170,"user_name":"标","can_delete":false,"product_type":"c3","uid":1136272,"ip_address":"","ucode":"D7FDCF388DE02C","user_header":"https://static001.geekbang.org/account/avatar/00/11/56/90/bfb92de9.jpg","comment_is_top":false,"comment_ctime":1579444577,"is_pvip":false,"replies":[{"id":67845,"content":"官方的建议不管读还是写，都用分片来解决。百万级的并发算是很大了，如果是点查为主的读操作占绝大多数，那么一个节点理论上支撑10万以上并发是可以的，当然必须是那种32&#47;64 核高CPU的物理服务器。 Oppo的同学分享过单集群支撑100万+并发，该集群由14个分片组成，14x3共42台机器","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580275307,"ip_address":"","comment_id":173170,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，数据量不是很大，如果要支撑百万并发，一般要如何设计，大概要多少个节点，用复制集还是分片集？","like_count":8,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481987,"discussion_content":"官方的建议不管读还是写，都用分片来解决。百万级的并发算是很大了，如果是点查为主的读操作占绝大多数，那么一个节点理论上支撑10万以上并发是可以的，当然必须是那种32/64 核高CPU的物理服务器。 Oppo的同学分享过单集群支撑100万+并发，该集群由14个分片组成，14x3共42台机器","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580275307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3563327,"avatar":"","nickname":"Geek_97446b","note":"","ucode":"A5535FDAE72DB4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":608265,"discussion_content":"单节点支撑到10万并发，是不是太夸张了？之前不是说 mongodb 5k 的并发，mysql 数据库 1k 的并发吗？请教老师下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678351687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":481987,"ip_address":"广东","group_id":0},"score":608265,"extra":""}]},{"author":{"id":1111985,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg","nickname":"美妙的代码","note":"","ucode":"9DADD72C193296","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364955,"discussion_content":"32/64核 一台只能支持 10万左右并发啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617671560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171730,"user_name":"齐宝金","can_delete":false,"product_type":"c3","uid":1305074,"ip_address":"","ucode":"F783442C82FCC2","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/f2/9067371a.jpg","comment_is_top":false,"comment_ctime":1579000547,"is_pvip":false,"replies":[{"id":66775,"content":"我可以执行。。。\n\nMacBook-Pro-4:tmp tjworks$ mongodump  -d local -c oplog.rs -q &#39;{ts:{$lt:Timestamp(1415928580, 1),$gt: Timestamp(1415928529, 1000)}}&#39; \n2020-01-16T08:01:22.401+0800\twriting local.oplog.rs to \n2020-01-16T08:01:22.414+0800\tdone dumping local.oplog.rs (0 documents)\nMacBook-Pro-4:tmp tjworks$ \n\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579132885,"ip_address":"","comment_id":171730,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"mongodump --port 27019 -d local -c oplog.rs -q &#39;{ts:{$lt:Timestamp(1415928580, 1),$gt: Timestamp(1415928529, 1000)}}&#39; -o &#47;tmp&#47;\n2020-01-14T19:13:54.024+0800    Failed: error parsing query as Extended JSON: invalid JSON input\n\n请问老师，之前这个命令是可以执行的，现在发现一执行，就报错，请问下是啥原因，谢谢老师","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481487,"discussion_content":"我可以执行。。。\n\nMacBook-Pro-4:tmp tjworks$ mongodump  -d local -c oplog.rs -q &amp;#39;{ts:{$lt:Timestamp(1415928580, 1),$gt: Timestamp(1415928529, 1000)}}&amp;#39; \n2020-01-16T08:01:22.401+0800\twriting local.oplog.rs to \n2020-01-16T08:01:22.414+0800\tdone dumping local.oplog.rs (0 documents)\nMacBook-Pro-4:tmp tjworks$ \n\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579132885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1310953,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/e9/00fd2bd3.jpg","nickname":"五云天北是神州","note":"","ucode":"8AA63B4CD0E2D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320515,"discussion_content":"我执行也是和宝金一个报错  2020-11-03T15:24:52.141+0800    Failed: error parsing query as Extended JSON: invalid JSON input","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604388327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170028,"user_name":"不经意间","can_delete":false,"product_type":"c3","uid":1261493,"ip_address":"","ucode":"C39D98697ACB8B","user_header":"https://static001.geekbang.org/account/avatar/00/13/3f/b5/5fe77e16.jpg","comment_is_top":false,"comment_ctime":1578494697,"is_pvip":false,"replies":[{"id":66110,"content":"各个分片的数据理论上是互不重叠的，所以如果配置服务器坏的话，你将无法组成一个新的分片集群，但是你的数据可以合并起来组成非分片的集群。\n\n当然，考虑到分片集群某一时间点会有正在分片之间迁移的数据，这个数据合并还是有点风险。\n\n所以你的配置服务器，也是需要3个节点来保证数据的可靠性。\n\n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1578644286,"ip_address":"","comment_id":170028,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师您好，看视频得知configsrv节点很重要，它保存了分片集群的元数据。如果这个节点的数据因为一些原因损坏、丢失了，那集群里的各个分片还能重新组成一个新的分片集群吗？\n\n还有一个问题，我开启数据库分片并给集合添加分片键后，开启集合分片时，开启操作会卡一小会（大概30秒）然后提示操作超时，这有可能是什么原因导致的啊？我的复制集各节点之间是可以正常访问的。百度查到的是3.2.3的一个bug，升级到3.2.10就好了，但是还没测试。我使用的版本正是3.23。","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480815,"discussion_content":"各个分片的数据理论上是互不重叠的，所以如果配置服务器坏的话，你将无法组成一个新的分片集群，但是你的数据可以合并起来组成非分片的集群。\n\n当然，考虑到分片集群某一时间点会有正在分片之间迁移的数据，这个数据合并还是有点风险。\n\n所以你的配置服务器，也是需要3个节点来保证数据的可靠性。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578644286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167682,"user_name":"阿强","can_delete":false,"product_type":"c3","uid":1000140,"ip_address":"","ucode":"2BD9F71C18FCBF","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAq0OYBickLibicxc4qybvFODNDn4aZvgfibRuqPPSjHBdAL3kpicjRIUFQhCaKvWayYaTGn3w84LKDGg/132","comment_is_top":false,"comment_ctime":1577892801,"is_pvip":false,"replies":[{"id":65188,"content":"谢谢您的认可！再接再厉！","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577966002,"ip_address":"","comment_id":167682,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"目前讲解最清晰的课程，体现在信息整理，表达逻辑，语速与停顿间隔，适度表情。体现出经常进行技术讲解的积累。\n准备订阅，等我6号的优惠包到账。","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479943,"discussion_content":"谢谢您的认可！再接再厉！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577966002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187045,"user_name":"天涯咫尺间","can_delete":false,"product_type":"c3","uid":1134316,"ip_address":"","ucode":"87D13B0C3FC35C","user_header":"https://static001.geekbang.org/account/avatar/00/11/4e/ec/0340146a.jpg","comment_is_top":false,"comment_ctime":1583999181,"is_pvip":false,"replies":[{"id":73191,"content":"可以。一般都会建议使用联合索引。你的选择看上去没问题。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1584626093,"ip_address":"","comment_id":187045,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，物联网场景下，听您讲的hash分片范围查询效果不好，那我可以使用联合索引吗？一个id和一个时间戳，id非自增。","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486973,"discussion_content":"可以。一般都会建议使用联合索引。你的选择看上去没问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584626093,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174694,"user_name":"爱吃彩虹糖的猫~","can_delete":false,"product_type":"c3","uid":1261108,"ip_address":"","ucode":"9EC7A8FD4B7DB1","user_header":"https://static001.geekbang.org/account/avatar/00/13/3e/34/dd0a3c61.jpg","comment_is_top":false,"comment_ctime":1580354169,"is_pvip":false,"replies":[{"id":67967,"content":"棒棒的！","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580446196,"ip_address":"","comment_id":174694,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"这节开拓了视野，了解了MongoDB集群的大概知识，TJ很给力","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482491,"discussion_content":"棒棒的！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580446196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":168050,"user_name":"金刚","can_delete":false,"product_type":"c3","uid":1199081,"ip_address":"","ucode":"EF0F1891A50330","user_header":"https://static001.geekbang.org/account/avatar/00/12/4b/e9/a23f3151.jpg","comment_is_top":false,"comment_ctime":1578006612,"is_pvip":false,"replies":[{"id":65259,"content":"我先mark一下你的问题，在更新完所有课程后我会考虑追加一些内容。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1578009658,"ip_address":"","comment_id":168050,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，可以讲讲Mongodb数据清理方面最佳实践吗","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480119,"discussion_content":"我先mark一下你的问题，在更新完所有课程后我会考虑追加一些内容。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578009658,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1882918,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/bb/26/9178c1ea.jpg","nickname":"飞利","note":"","ucode":"E35552AAE26A06","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":185976,"discussion_content":"这个最近我们也刚好遇到，业务日志表约5亿条记录，之前使用某个日期型字段加官方的TTL，因为TTL每分钟启动一次，如果每次需要清除的数据在50万条以内，TTL可以及时清除，但是遇到高峰，每次清除达到150万条，TTL就不能及时了。我们是自己写了js代码来定期清除，为了避免TTL遇到的问题，代码限制了每次清除数据的时间范围（_id换算成时间），遇到高峰也不怕，各自处理各自范围内的数据，相互不影响，效果还不错。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582643396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167884,"user_name":"崔伟协","can_delete":false,"product_type":"c3","uid":1022452,"ip_address":"","ucode":"ACDEEDF2A10999","user_header":"https://static001.geekbang.org/account/avatar/00/0f/99/f4/e0484cac.jpg","comment_is_top":false,"comment_ctime":1577957433,"is_pvip":false,"replies":[{"id":65207,"content":"4.2 开始支持分片事务了。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577969664,"ip_address":"","comment_id":167884,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"分片mongos支持事务吗？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480041,"discussion_content":"4.2 开始支持分片事务了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577969664,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167829,"user_name":"wayland","can_delete":false,"product_type":"c3","uid":1600646,"ip_address":"","ucode":"AF93DC7D39B362","user_header":"https://static001.geekbang.org/account/avatar/00/18/6c/86/dba0e59c.jpg","comment_is_top":false,"comment_ctime":1577945321,"is_pvip":false,"replies":[{"id":65185,"content":"一般原则是不需要。\n\n如果你的应用场景用不到数据合并（连统一报表都不需要），并且数据量级在10亿级以上，可以考虑作为一个特殊优化手段做分表。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577965862,"ip_address":"","comment_id":167829,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，mongodb还需要考虑分库分表吗，如果要考虑一般是在什么数量级别才分呢？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480013,"discussion_content":"一般原则是不需要。\n\n如果你的应用场景用不到数据合并（连统一报表都不需要），并且数据量级在10亿级以上，可以考虑作为一个特殊优化手段做分表。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577965862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2254829,"avatar":"https://static001.geekbang.org/account/avatar/00/22/67/ed/c0cfc05b.jpg","nickname":"勿忘初心","note":"","ucode":"243245EB95A135","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324202,"discussion_content":"我们目前的需求是群组聊天记录太多，打算一个群组存一个表\n现在我们公司开会讨论的方案是先分表后分片，我想请教一下分表太多会不会有问题，如果有问题的话就得找到原因说服大家，调整方案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605068788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245444,"user_name":"Mr.zhou","can_delete":false,"product_type":"c3","uid":1461488,"ip_address":"","ucode":"F7B2365D183788","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep0Cb1HGLBTD57I53ZLsIBnvN3YkJOTkibWyibPoCUM5cbnhqDicm1aKWTUFeI7SEd8REnibfZVWeM3BQ/132","comment_is_top":false,"comment_ctime":1598946169,"is_pvip":false,"replies":[{"id":90301,"content":"选主基本条件：多数节点存活。 你的shard1本来应该有3个节点（分别在207，208，224），现在只剩208了，就会变成只读，secondary。你要再恢复shard1的一个节点才可以工作","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1599000231,"ip_address":"","comment_id":245444,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"问题1：如何查看分片集群中哪个分片是主分片？\n问题2：如果有三台服务器：\nIP224服务器启动：路由服务、配置服务、分片1、分片2、分片3\nIP207服务器启动：路由服务、配置服务、分片1、分片2、分片3\nIP208服务器启动：路由服务、配置服务、分片1、分片2、分片3\n使用rs.status()查看分片结果如下：\nshards:\n        {  &quot;_id&quot; : &quot;shard1&quot;,  &quot;host&quot; : &quot;shard1&#47;X.X.X.207:27001,X.X.X.208:27001,X.X.X.224:27001&quot;,  &quot;state&quot; : 1 }\n        {  &quot;_id&quot; : &quot;shard2&quot;,  &quot;host&quot; : &quot;shard2&#47;X.X.X.207:27002,X.X.X.208:27002,X.X.X.224:27002&quot;,  &quot;state&quot; : 1 }\n        {  &quot;_id&quot; : &quot;shard3&quot;,  &quot;host&quot; : &quot;shard3&#47;X.X.X.207:27003,X.X.X.208:27003,X.X.X.224:27003&quot;,  &quot;state&quot; : 1 }\n\n今天，224服务器突然挂了。结果服务出现了问题，日志报错如下：\n ERROR com.bamboocloud.im.handler.process.ProcessHandlerProcesser$ProcessExecutorTaskRunnable 163 - Failed ProcessExecutorTaskRunnable\ncom.mongodb.MongoQueryException: Query failed with error code 133 and error message &#39;Encountered non-retryable error during query :: caused by :: Could not find host matching read preference { mode: &quot;primary&quot; } for set shard1&#39; on server X.X.X.207:27017\n\n登录到mongodb集群发现：207服务器上只剩下路由服务、配置服务、分片2；208服务器上路由服务、配置服务、分片1、分片2、分片3都在。\n\n我感觉，虽然224和207的shard1没了，但是208服务器上shard1还在呀！应该被选取为主shard呀？这样不应该影响业务才对呀？\n","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504881,"discussion_content":"选主基本条件：多数节点存活。 你的shard1本来应该有3个节点（分别在207，208，224），现在只剩208了，就会变成只读，secondary。你要再恢复shard1的一个节点才可以工作","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599000231,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3008825,"avatar":"","nickname":"Geek_64ac91","note":"","ucode":"66E87F31364059","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":650567,"discussion_content":"您好，大佬 您这个部署 MongoDB 集群的思路是在 三台 MongoDB 的节点上部署了 三个复制集是吗？ 每个节点互为主从？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1725267451,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"山东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169369,"user_name":"👻 小二","can_delete":false,"product_type":"c3","uid":1625463,"ip_address":"","ucode":"9EEA8553163270","user_header":"https://static001.geekbang.org/account/avatar/00/18/cd/77/b2ab5d44.jpg","comment_is_top":false,"comment_ctime":1578323054,"is_pvip":false,"replies":[{"id":66770,"content":"当你使用read majority的时候，mongo会在主节点有额外的一些状态记录。他会根据这个这些信息来决定返回哪个版本的值给你，并不需要去请求多个节点。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579132374,"ip_address":"","comment_id":169369,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师， 请问下, majority 读时， 我有3个节点，刚开始三个节点， x值都是1， 后面更新了x=2时， a节点跟b节点都更新了， c还没来得及更新， 然后我去读， 刚好落在c节点上， 那此时 会返回1？\n你上次回答我说是2，mongo是怎么判断现在是2的，难道他会同时请求多个点？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480530,"discussion_content":"当你使用read majority的时候，mongo会在主节点有额外的一些状态记录。他会根据这个这些信息来决定返回哪个版本的值给你，并不需要去请求多个节点。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579132374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169366,"user_name":"👻 小二","can_delete":false,"product_type":"c3","uid":1625463,"ip_address":"","ucode":"9EEA8553163270","user_header":"https://static001.geekbang.org/account/avatar/00/18/cd/77/b2ab5d44.jpg","comment_is_top":false,"comment_ctime":1578323004,"is_pvip":false,"replies":[{"id":66209,"content":"你给个例子好一点，不用100个，就2个","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1578748313,"ip_address":"","comment_id":169366,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师你还没回答我， ，  mongo如果大量存入不同字段的数据， 会有问题吗？ 比如我存入100w条， 字段是uuid， 唯一的数据， 每条有100个uuid的字段， 这样， 整张表加起来就有 1亿个不同的字段。\n 100个uuid的字段，字段名都不一样的","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480529,"discussion_content":"你给个例子好一点，不用100个，就2个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578748313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167724,"user_name":"许凯","can_delete":false,"product_type":"c3","uid":1604645,"ip_address":"","ucode":"4F11AD41CB0244","user_header":"https://static001.geekbang.org/account/avatar/00/18/7c/25/70134099.jpg","comment_is_top":false,"comment_ctime":1577923139,"is_pvip":false,"replies":[{"id":66855,"content":"能否提供一个比较具体的场景我可以针对性的回答？","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579170548,"ip_address":"","comment_id":167724,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"想请问下老师，对于多维度实时统计这样的场景有没有好的解决方案","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479964,"discussion_content":"能否提供一个比较具体的场景我可以针对性的回答？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579170548,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167688,"user_name":"cheriston","can_delete":false,"product_type":"c3","uid":1309984,"ip_address":"","ucode":"617CBFCE0925C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","comment_is_top":false,"comment_ctime":1577893622,"is_pvip":false,"replies":[{"id":65186,"content":"请看后续章节","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577965885,"ip_address":"","comment_id":167688,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师，mongodb集群怎么备份好","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479948,"discussion_content":"请看后续章节","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577965885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167686,"user_name":"cheriston","can_delete":false,"product_type":"c3","uid":1309984,"ip_address":"","ucode":"617CBFCE0925C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","comment_is_top":false,"comment_ctime":1577893500,"is_pvip":false,"replies":[{"id":65187,"content":"谢谢！","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577965891,"ip_address":"","comment_id":167686,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师课程很吸引人，点赞","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479947,"discussion_content":"谢谢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577965891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272735,"user_name":"Mars丶小石头","can_delete":false,"product_type":"c3","uid":1765017,"ip_address":"","ucode":"D7689F7676C39B","user_header":"https://static001.geekbang.org/account/avatar/00/1a/ee/99/8c78ad93.jpg","comment_is_top":false,"comment_ctime":1610257146,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"唐老师，你好，如果数据量超过10T，数据可以按月分区，热点数据可能就是在当月的集合上，历史的只是查询，性能可以慢一点，要怎么设置分区架构比较好呢？如果全用SSD成本比较高，可以SSD和普通磁盘混用么？\n也就是能不能设置热点的数据在SSD盘，历史数据在普通磁盘上呢？","like_count":1},{"had_liked":false,"id":391057,"user_name":"北辰","can_delete":false,"product_type":"c3","uid":3887508,"ip_address":"河南","ucode":"193ECB1D894429","user_header":"https://static001.geekbang.org/account/avatar/00/3b/51/94/3c42f065.jpg","comment_is_top":false,"comment_ctime":1717155484,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"请问老师，假如大多数是读操作，但是数据量可能比较大，并发10万以内，能不能不做分片只用复制集解决呢？如果用复制集的话，是不是也相当于达到了并发压力平均到各个节点的目的？","like_count":0},{"had_liked":false,"id":351726,"user_name":"夏志强","can_delete":false,"product_type":"c3","uid":3012895,"ip_address":"","ucode":"562B4155C216E3","user_header":"https://static001.geekbang.org/account/avatar/00/2d/f9/1f/fadbecc9.jpg","comment_is_top":false,"comment_ctime":1658131183,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师您好，请问下mongo一个集合最多支持多少数据量？","like_count":0},{"had_liked":false,"id":347065,"user_name":"颜海航","can_delete":false,"product_type":"c3","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1653660438,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师您好 我们生产的的mongodb之上还有dns 产生一个域名。域名之后配置上所有的momgos节点这种合理吗","like_count":0},{"had_liked":false,"id":344257,"user_name":"Geek_f4f7ac","can_delete":false,"product_type":"c3","uid":1617438,"ip_address":"","ucode":"E86E0A33581456","user_header":"https://static001.geekbang.org/account/avatar/00/18/ae/1e/b6fd49bf.jpg","comment_is_top":false,"comment_ctime":1651400977,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"如果是hash分片，hash相同了怎么办？还有config中hash分片键是怎么的","like_count":0},{"had_liked":false,"id":287980,"user_name":"蒋良权","can_delete":false,"product_type":"c3","uid":1236189,"ip_address":"","ucode":"5A355D37948D59","user_header":"https://static001.geekbang.org/account/avatar/00/12/dc/dd/cf9e4ade.jpg","comment_is_top":false,"comment_ctime":1618238778,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，我想请问一下，基于硬hash的分片方式，如果扩展了分片节点，如何解决旧的分片失效的问题呢","like_count":0},{"had_liked":false,"id":285523,"user_name":"Geek_d7f861","can_delete":false,"product_type":"c3","uid":1746804,"ip_address":"","ucode":"B10DB3CEF3F083","user_header":"","comment_is_top":false,"comment_ctime":1616856911,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"老师，我想请教下mongodb一旦使用分片，那有那些功能是相对于单机情况下无法使用的，比如联合查询的使用等","like_count":0},{"had_liked":false,"id":260603,"user_name":"勿忘初心","can_delete":false,"product_type":"c3","uid":2254829,"ip_address":"","ucode":"243245EB95A135","user_header":"https://static001.geekbang.org/account/avatar/00/22/67/ed/c0cfc05b.jpg","comment_is_top":false,"comment_ctime":1605068776,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"我们目前的需求是群组聊天记录太多，打算一个群组存一个表\n现在我们公司开会讨论的方案是先分表后分片，我想请教一下分表太多会不会有问题，如果有问题的话就得找到原因说服大家，调整方案","like_count":0},{"had_liked":false,"id":245443,"user_name":"Mr.zhou","can_delete":false,"product_type":"c3","uid":1461488,"ip_address":"","ucode":"F7B2365D183788","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep0Cb1HGLBTD57I53ZLsIBnvN3YkJOTkibWyibPoCUM5cbnhqDicm1aKWTUFeI7SEd8REnibfZVWeM3BQ/132","comment_is_top":false,"comment_ctime":1598946084,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100040001,"comment_content":"问题1：如何查看分片集群中哪个分片是主分片？\n问题2：如果有三台服务器：\nIP224服务器启动：路由服务、配置服务、分片1、分片2、分片3\nIP207服务器启动：路由服务、配置服务、分片1、分片2、分片3\nIP208服务器启动：路由服务、配置服务、分片1、分片2、分片3\n\n\nshards:\n        {  &quot;_id&quot; : &quot;shard1&quot;,  &quot;host&quot; : &quot;shard1&#47;X.X.X.207:27001,X.X.X.208:27001,X.X.X.224:27001&quot;,  &quot;state&quot; : 1 }\n        {  &quot;_id&quot; : &quot;shard2&quot;,  &quot;host&quot; : &quot;shard2&#47;X.X.X.207:27002,X.X.X.208:27002,X.X.X.224:27002&quot;,  &quot;state&quot; : 1 }\n        {  &quot;_id&quot; : &quot;shard3&quot;,  &quot;host&quot; : &quot;shard3&#47;X.X.X.207:27003,X.X.X.208:27003,X.X.X.224:27003&quot;,  &quot;state&quot; : 1 }\n\n\n\n问题1：如何查看分片集群中哪个分片是主分片？\n问题2：如果有三台服务器：\nIP224服务器启动：路由服务、配置服务、分片1、分片2、分片3\nIP207服务器启动：路由服务、配置服务、分片1、分片2、分片3\nIP208服务器启动：路由服务、配置服务、分片1、分片2、分片3\n使用rs.status()查看分片结果如下：\nshards:\n        {  &quot;_id&quot; : &quot;shard1&quot;,  &quot;host&quot; : &quot;shard1&#47;X.X.X.207:27001,X.X.X.208:27001,X.X.X.224:27001&quot;,  &quot;state&quot; : 1 }\n        {  &quot;_id&quot; : &quot;shard2&quot;,  &quot;host&quot; : &quot;shard2&#47;X.X.X.207:27002,X.X.X.208:27002,X.X.X.224:27002&quot;,  &quot;state&quot; : 1 }\n        {  &quot;_id&quot; : &quot;shard3&quot;,  &quot;host&quot; : &quot;shard3&#47;X.X.X.207:27003,X.X.X.208:27003,X.X.X.224:27003&quot;,  &quot;state&quot; : 1 }\n\n今天，224服务器突然挂了。结果服务出现了问题，日志报错如下：\n ERROR com.bamboocloud.im.handler.process.ProcessHandlerProcesser$ProcessExecutorTaskRunnable 163 - Failed ProcessExecutorTaskRunnable\ncom.mongodb.MongoQueryException: Query failed with error code 133 and error message &#39;Encountered non-retryable error during query :: caused by :: Could not find host matching read preference { mode: &quot;primary&quot; } for set shard1&#39; on server X.X.X.207:27017\n\n登录到mongodb集群发现：207服务器上只剩下路由服务、配置服务、分片2；208服务器上路由服务、配置服务、分片1、分片2、分片3都在。\n\n我感觉，虽然224和207的shard1没了，但是208服务器上shard1还在呀！应该被选取为主shard呀？这样不应该影响业务才对呀？","like_count":0}]}