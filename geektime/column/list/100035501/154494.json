{"id":154494,"title":"19 | æ‰“å¼€æ½˜å¤šæ‹‰ç›’å­ï¼šJavaScriptå¼‚æ­¥ç¼–ç¨‹","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å››ç«ã€‚</p><p>æˆ‘ä»¬åœ¨æœ¬ç« ä¼Šå§‹çš„ <a href=\"https://time.geekbang.org/column/article/145875\">[ç¬¬ 14 è®²]</a> ä¸­åˆæ­¥å­¦ä¹ äº† JavaScript çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œä½“ä¼šåˆ°äº†æ€ç»´æ¨¡å¼çš„è½¬å˜ï¼Œä¹Ÿå»ºç«‹èµ·äº†å¼‚æ­¥ç¼–ç¨‹çš„åˆæ­¥æ¦‚å¿µã€‚åœ¨æœ¬ç« æœ€åä¸€è®²ï¼Œæˆ‘ä»¬å°†æ·±å…¥å¼‚æ­¥ç¼–ç¨‹ï¼Œç»§ç»­æ¢è®¨å…¶ä¸­çš„å…³é”®æŠ€æœ¯ã€‚</p><p>å¼‚æ­¥ç¼–ç¨‹å°±åƒæ˜¯ä¸€ä¸ªç¥ç§˜çš„å®ç›’ï¼Œçœ‹èµ·æ¥æ™¶è¹å‰”é€ï¼Œå¯ä¸€æ—¦ä½¿ç”¨ä¸å½“ï¼Œå°±ä¼šæ˜¯å¸¦æ¥ç¾éš¾çš„æ½˜å¤šæ‹‰ç›’å­ï¼ŒçŠ¶æ€æ··ä¹±ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚å¸Œæœ›åœ¨è¿™ä¸€è®²ä¹‹åï¼Œä½ å¯ä»¥äº†è§£æ›´å¤šçš„å…³äº JavaScript åœ¨å¼‚æ­¥ç¼–ç¨‹æ–¹é¢çš„é«˜çº§ç‰¹æ€§ï¼Œä»è€Œä¹ æƒ¯å¹¶å†™å‡ºå¯é çš„å¼‚æ­¥ä»£ç ã€‚</p><h2>1. ç”¨ Promise ä¼˜åŒ–åµŒå¥—å›è°ƒ</h2><p>å‡å¦‚æˆ‘ä»¬éœ€è¦å†™è¿™æ ·ä¸€æ®µä»£ç ï¼Œæ¥æ¨¡æ‹Ÿä¸€åªå°ç‹—å‘å‰å¥”è·‘ï¼Œå®ƒä¸€å…±è·‘äº† 3 æ¬¡ï¼Œå¥”è·‘çš„è·ç¦»åˆ†åˆ«ä¸º 1ã€2ã€3ï¼Œæ¯æ¬¡å¥”è·‘éƒ½è¦èŠ±è´¹ 1 ç§’é’Ÿæ—¶é—´ï¼š</p><pre><code>setTimeout(\n  () =&gt; {\n    console.log(1);\n    setTimeout(\n      () =&gt; {\n        console.log(2);\n        setTimeout(\n          () =&gt; {\n            console.log(3);\n          },\n          1000\n        );\n      },\n      1000\n    );\n  },\n  1000\n);\n</code></pre><p>ä½ çœ‹ï¼Œæˆ‘ä»¬ç”¨äº† 3 æ¬¡ setTimeoutï¼Œæ¯æ¬¡éƒ½æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨ä»¥æ‰“å°å½“å‰è·‘çš„è·ç¦»ï¼Œä»¥åŠé€’å½’è°ƒç”¨å¥”è·‘é€»è¾‘ï¼Œç¬¬äºŒä¸ªå‚æ•°ç”¨äºæ¨¡æ‹Ÿå¥”è·‘è€—æ—¶ 1000 æ¯«ç§’ã€‚è¿™ä¸ªé—®é¢˜å…¶å®ä»£è¡¨äº†å®é™…ç¼–ç¨‹ä¸­ä¸€ç±»å¾ˆå¸¸è§çš„ JavaScript å¼‚æ­¥ç¼–ç¨‹é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ Ajax æ–¹å¼å¼‚æ­¥è·å–ä¸€ä¸ªè¯·æ±‚ï¼Œåœ¨å¾—åˆ°è¿”å›çš„ç»“æœåï¼Œå†æ‰§è¡Œå¦ä¸€ä¸ª Ajax æ“ä½œã€‚</p><p>ç°åœ¨ï¼Œè¯·ä½ æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·ä¸­çš„æ§åˆ¶å°ï¼Œè¿è¡Œä¸€ä¸‹ï¼š</p><pre><code>3693\n1\n2\n3\n</code></pre><!-- [[[read_end]]] --><p>ç¬¬ä¸€è¡Œæ˜¯ setTimeout è¿”å›çš„å¥æŸ„ï¼Œç”±äºæ§åˆ¶å°è¿è¡Œçš„å…³ç³»ï¼Œç³»ç»Ÿä¼šæŠŠæœ€åä¸€è¡Œæ‰§è¡Œçš„è¿”å›å€¼æ‰“å°å‡ºæ¥ï¼Œå› æ­¤å®ƒå¯ä»¥å¿½ç•¥ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç»“æœæ°å¦‚é¢„æœŸï¼Œæ¯ä¸€è¡Œçš„æ‰“å°éƒ½é—´éš”äº†ä¸€ç§’ï¼Œæ¨¡æ‹Ÿäº†å¥”è·‘çš„æ•ˆæœã€‚</p><p>ä½†æ˜¯ï¼Œè¿™ä¸ªä»£ç ä¼¼ä¹ä¸å¤ªâ€œå¥½çœ‹â€å•Šï¼Œç¹çè€Œä¸”å†—é•¿ï¼Œæ˜“ç†è§£æ€§å’Œå¯ç»´æŠ¤æ€§æ˜¾ç„¶ä¸è¿‡å…³ï¼Œä»£ç çš„çŠ¶æ€é‡åœ¨è¿™ç§æƒ…å†µä¸‹å¾ˆéš¾é¢„æµ‹å’Œç»´æŠ¤ã€‚å°±å¦‚åŒåŒæ­¥ç¼–ç¨‹ä¸–ç•Œä¸­å¸¸è§çš„â€œ<a href=\"https://zh.wikipedia.org/wiki/%E9%9D%A2%E6%9D%A1%E5%BC%8F%E4%BB%A3%E7%A0%81\">é¢æ¡ä»£ç </a>ï¼ˆSpaghetti Codeï¼‰â€ä¸€æ ·ï¼Œè¿™æ ·â€œåå‘³é“â€çš„ä»£ç åœ¨å¼‚æ­¥ç¼–ç¨‹çš„ä¸–ç•Œä¸­å…¶å®ä¹Ÿå¾ˆå¸¸è§ï¼Œä¸”ä¹Ÿæœ‰ä¸ªä¸“æœ‰ç§°å‘¼â€”â€”â€œé‡‘å­—å¡”å„è¿â€ï¼ˆPyramid of Doomï¼ŒåµŒå¥—ç»“æ„å°±åƒé‡‘å­—å¡”ä¸€æ ·ï¼‰ã€‚</p><p>åˆ°è¿™é‡Œï¼Œä¸çŸ¥ä½ ä¼šä¸ä¼šæƒ³ï¼Œèƒ½ä¸èƒ½æŠŠé‡å¤çš„é€»è¾‘æŠ½å–å‡ºæ¥å‘¢ï¼Ÿå…·ä½“è¯´ï¼Œå°±æ˜¯è¿™ä¸ª setTimeout æ–¹æ³•ç›¸å…³çš„ä»£ç ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½å–å…¬ç”¨é€»è¾‘ï¼Œå®šä¹‰ä¸€ä¸ª run æ–¹æ³•ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å½“å‰è·‘åŠ¨è·ç¦»ï¼Œç¬¬äºŒä¸ªæ˜¯å›è°ƒæ–¹æ³•ï¼Œç”¨äºå½“å‰è·‘å®Œä»¥åï¼Œè§¦å‘ä¸‹ä¸€æ¬¡è·‘åŠ¨çš„è¡Œä¸ºï¼š</p><pre><code>var run = (steps, callback) =&gt; {\n  setTimeout(\n    () =&gt; {\n      console.log(steps);\n      callback();\n    },\n    1000\n  );\n};\n\nrun(1, () =&gt; {\n  run(2, () =&gt; {\n    run(3, () =&gt; {});\n  });\n});\n</code></pre><p>å—¯ï¼Œä»£ç ç¡®å®æ¸…çˆ½å¤šäº†ã€‚å¯æ˜¯ï¼Œçœ‹ç€è¿™åµŒå¥—çš„ä¸‰ä¸ª runï¼Œæˆ‘è§‰å¾—è¿™å¹¶æ²¡æœ‰ä»æœ¬è´¨ä¸Šè§£å†³é—®é¢˜ï¼Œåªæ˜¯ä»£ç ç®€çŸ­äº†äº›ï¼ŒåµŒå¥—è°ƒç”¨ä¾ç„¶å­˜åœ¨ã€‚</p><p>æ¯å½“æˆ‘ä»¬å¼€å§‹å†™è¿™æ ·åå¤åµŒå¥—å›è°ƒçš„ä»£ç æ—¶ï¼Œæˆ‘ä»¬å°±åº”è¯¥è­¦é†’ï¼Œæˆ‘ä»¬æ˜¯å¦åœ¨åˆ›é€ ä¸€ä¸ªä»£ç ç»´æŠ¤ä¸Šçš„å‘ã€‚é‚£èƒ½ä¸èƒ½ä½¿ç”¨æŸä¸€ç§ä¼˜é›…çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>æœ‰ï¼å®ƒå°±æ˜¯ Promiseï¼Œå¹¶ä¸”ä» ES6 å¼€å§‹ï¼ŒJavaScript åŸç”Ÿæ”¯æŒï¼Œä¸å†éœ€è¦ç¬¬ä¸‰æ–¹çš„åº“æˆ–è€…è‡ªå·±å®ç°çš„å·¥å…·ç±»äº†ã€‚</p><p><strong>Promiseï¼Œå°±å¦‚åŒå­—é¢æ„æ€â€œæ‰¿è¯ºâ€ä¸€æ ·ï¼Œå®šä¹‰åœ¨å½“å‰ï¼Œä½†è¡Œä¸ºå‘ç”Ÿäºæœªæ¥ã€‚</strong>å®ƒçš„æ„é€ æ–¹æ³•ä¸­æ¥å—ä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚æœä½ å¯¹è¿™ç§å°†å‡½æ•°ä½œä¸ºå‚æ•°çš„æ–¹å¼ä¼ å…¥è¿˜ä¸ä¹ æƒ¯ï¼Œè¯·å›çœ‹ <a href=\"https://time.geekbang.org/column/article/145878\">[ç¬¬ 15 è®²]</a> å¯¹å‡½æ•°æˆä¸ºä¸€ç­‰å…¬æ°‘çš„ä»‹ç»ï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°æ¥å— resolve å’Œ reject ä¸¤ä¸ªå‚æ•°ï¼Œå‰è€…åœ¨æœªæ¥çš„æ‰§è¡ŒæˆåŠŸæ—¶ä¼šè¢«è°ƒç”¨ï¼Œåè€…åœ¨æœªæ¥çš„æ‰§è¡Œå¤±è´¥æ—¶ä¼šè¢«è°ƒç”¨ã€‚</p><pre><code>var run = steps =&gt; \n  () =&gt; \n    new Promise((resolve, reject) =&gt; {\n      setTimeout(\n        () =&gt; {\n          console.log(steps);\n          resolve(); // ä¸€ç§’åçš„æœªæ¥æ‰§è¡ŒæˆåŠŸï¼Œéœ€è¦è°ƒç”¨\n        },\n        1000\n      );\n    });\n\nPromise.resolve()\n  .then(run(1))\n  .then(run(2))\n  .then(run(3));\n</code></pre><p>æ­£å¦‚ä»£ç æ‰€ç¤ºï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬è®© run() æ–¹æ³•è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚è¿™æ ·ï¼Œè¿™ä¸ª Promise å¯¹è±¡ï¼Œå¹¶ä¸æ˜¯åœ¨ç¨‹åºä¸€å¼€å§‹å°±åˆå§‹åŒ–çš„ï¼Œè€Œæ˜¯åœ¨æœªæ¥çš„æŸä¸€æ—¶åˆ»ï¼Œå‰ä¸€æ­¥æ“ä½œå®Œæˆä¹‹åæ‰ä¼šå¾—åˆ°æ‰§è¡Œï¼Œè¿™ä¸€ç‚¹éå¸¸å…³é”®ï¼Œå¹¶ä¸”è¿™æ˜¯ä¸€ç§<strong>é€šè¿‡ç»™åŸå§‹ä»£ç æ·»åŠ å‡½æ•°åŒ…è£…çš„æ–¹å¼å®ç°äº†è¿™é‡Œçš„â€œå®šä¹‰ã€ä¼ é€’ã€ä½†ä¸æ‰§è¡Œâ€çš„è¦æ±‚ã€‚</strong></p><p>è¿™æ ·åšå°±æ˜¯æŠŠå®é™…çš„æ‰§è¡Œé€»è¾‘ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶å‡½æ•°åŒ…è£…èµ·æ¥å†ä¼ é€’å‡ºå»ï¼Œä»¥è¾¾åˆ°å»¶è¿Ÿå¯¹è¯¥é€»è¾‘æ±‚å€¼çš„ç›®çš„ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªä¸“æœ‰åå­— <a href=\"https://en.wikipedia.org/wiki/Thunk\">Thunk</a>ï¼Œå®ƒæ˜¯ä¸€ç§åœ¨ JavaScript å¼‚æ­¥ç¼–ç¨‹çš„ä¸–ç•Œä¸­å¾ˆå¸¸è§çš„æ‰‹æ®µï¼ˆJavaScript ä¸­æœ‰æ—¶ Thunk ç‰¹æŒ‡ç”¨è¿™ç§æŠ€æœ¯æ¥å°†å¤šå‚æ•°å‡½æ•°åŒ…è£…æˆå•å‚æ•°å‡½æ•°ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬åœ¨æ­¤ä¸è®¨è®ºï¼‰ã€‚æ¢è¨€ä¹‹ï¼Œä¸Šé¢ä»£ç ä¾‹å­ä¸­çš„ç¬¬äºŒè¡Œï¼Œç»ä¸å¯çœç•¥ï¼Œä¸€äº›åˆšå¼€å§‹å­¦å†™å¼‚æ­¥ç¼–ç¨‹çš„ç¨‹åºå‘˜æœ‹å‹ï¼Œå°±å¾ˆå®¹æ˜“çŠ¯è¿™ä¸ªé”™è¯¯ã€‚</p><p>å¦å¤–ï¼Œè¿™é‡Œæˆ‘è¿˜ä½¿ç”¨äº†ä¸¤ä¸ªå°æŠ€å·§æ¥ç®€åŒ–ä»£ç ï¼š</p><ul>\n<li>ä¸€ä¸ªæ˜¯ () =&gt; { return xxx; } å¯ä»¥è¢«ç®€åŒ–ä¸º () =&gt; xxxï¼›</li>\n<li>å¦ä¸€ä¸ªæ˜¯ä½¿ç”¨ Promise.resolve() è¿”å›ä¸€ä¸ªå·²ç»æ‰§è¡ŒæˆåŠŸçš„ç©ºæ“ä½œï¼Œä»è€Œå°†æ‰€æœ‰åç»­æ‰§è¡Œçš„ run æ–¹æ³•éƒ½å¯ä»¥ä»¥ç»Ÿä¸€çš„å½¢å¼æ”¾åˆ°è°ƒç”¨é“¾é‡Œé¢å»ã€‚</li>\n</ul><p>ç°åœ¨ï¼Œä½¿ç”¨ run() æ–¹æ³•çš„ä»£ç è°ƒç”¨å·²ç»æ ¼å¤–åœ°ç®€å•è€Œæ¸…æ™°äº†ã€‚åœ¨ Promise çš„å¸®åŠ©ä¸‹ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œç”¨äº†å‡ ä¸ª then æ–¹æ³•ï¼Œå®ç°äº†é€»è¾‘åœ¨å‰ä¸€æ­¥æˆåŠŸåçš„ä¾æ¬¡æ‰§è¡Œã€‚äºæ˜¯ï¼Œ<strong>åµŒå¥—çš„é‡‘å­—å¡”å„è¿æ¶ˆå¤±äº†ï¼Œå˜æˆäº†ç›´è§‚çš„é“¾å¼è°ƒç”¨</strong>ï¼Œè¿™æ˜¯å¼‚æ­¥ç¼–ç¨‹ä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„ä¼˜åŒ–ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä¹˜èƒœè¿½å‡»ï¼Œè¿›ä¸€æ­¥è€ƒè™‘ï¼Œä¸Šé¢é‚£ä¸ª run() æ–¹æ³•æ˜æ˜¾ä¸å¤Ÿç›´è§‚ï¼Œèƒ½ä¸èƒ½ä»¥æŸç§æ–¹å¼ä¼˜åŒ–è°ƒæ•´ä¸€ä¸‹ï¼Ÿ</p><p>èƒ½ï¼ä»£ç çœ‹èµ·æ¥å¤æ‚çš„åŸå› æ˜¯å¼•å…¥äº† setTimeoutï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨ setTimeout åªæ˜¯ä¸ºäº†â€œç­‰ä¸€ä¸‹â€ï¼Œæ¥æ¨¡æ‹Ÿå°ç‹—å¥”è·‘çš„è¿‡ç¨‹ã€‚è¿™ä¸ªâ€œç­‰ä¸€ä¸‹â€çš„è¡Œä¸ºï¼Œå®é™…æ˜¯æœ‰æ™®éæ„ä¹‰çš„ã€‚åœ¨ JavaScript è¿™æ ·çš„éé˜»å¡ä»£ç ä¸­ï¼Œä¸å¯èƒ½é€šè¿‡ä»£ç çš„æ–¹å¼è®©ä»£ç å®é™…æ‰§è¡Œçš„æ—¶å€™çœŸçš„â€œç­‰ä¸€ä¸‹â€ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬å´å¯ä»¥ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼è®©ä»£ç çœ‹èµ·æ¥åƒæ˜¯æ‰§è¡Œäº†ä¸€ä¸ªâ€œç­‰ä¸€ä¸‹â€çš„æ“ä½œã€‚æˆ‘ä»¬å®šä¹‰ï¼š</p><pre><code>var wait = ms =&gt;\n  new Promise(resolve =&gt; setTimeout(resolve, ms));\n</code></pre><p>æœ‰äº† wait çš„é“ºå«ï¼Œæˆ‘ä»¬æŠŠåŸæœ¬å¥”è·‘çš„ setTimeout ä½¿ç”¨æ›´ä¸ºç›´è§‚çš„ wait å‡½æ•°æ¥æ›¿æ¢ï¼Œä¸€ä¸‹å­å°±è®© run çš„å®ç°æ¸…æ™°äº†å¾ˆå¤šï¼š</p><pre><code>var run = steps =&gt; \n  () =&gt; wait(1000).then(() =&gt; { console.log(steps); });\n</code></pre><p>ä½ çœ‹ï¼Œè¿™ä¸ªä¾‹å­ï¼Œå†åŠ ä¸Šå‰é¢çš„ then è°ƒç”¨é“¾çš„ä¾‹å­ï¼Œä½ æ˜¯å¦çœ‹å‡ºï¼Œ<strong>åˆ©ç”¨ Promiseï¼Œæˆ‘ä»¬ä¼¼ä¹ç¥å¥‡åœ°æŠŠâ€œå¼‚æ­¥â€ä»£ç å˜æˆâ€œåŒæ­¥â€çš„äº†</strong>ã€‚å…¶å®ï¼Œä»£ç æ‰§è¡Œå¹¶æ²¡æœ‰çœŸæ­£åœ°å˜æˆåŒæ­¥ï¼Œä½†æ˜¯ä»£ç å´â€œçœ‹èµ·æ¥â€åƒæ˜¯åŒæ­¥ä»£ç ï¼Œè€ŒåŒæ­¥å’Œé¡ºåºæ‰§è¡Œçš„é€»è¾‘å¯¹äºäººçš„å¤§è„‘æ›´ä¸ºå‹å¥½ã€‚</p><p>ç»è¿‡è¿™æ ·çš„é‡æ„ä»¥åï¼Œå†æ¬¡æ‰§è¡Œåˆšæ‰çš„ 3 æ¬¡å¥”è·‘è°ƒç”¨ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€æ ·çš„ç»“æœã€‚</p><pre><code>Promise.resolve()\n  .then(run(1))\n  .then(run(2))\n  .then(run(3));\n</code></pre><p>å—¯ï¼Œçœ‹èµ·æ¥æˆ‘ä»¬å·²ç»åšåˆ°æè‡´äº†ï¼Œä»£ç ä¹Ÿå·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå¤§æ¦‚æ²¡æœ‰åŠæ³•å†æ”¹å†™å’Œä¼˜åŒ–äº†å§ï¼Ÿä¸ï¼å…¶å®æˆ‘ä»¬è¿˜æœ‰ç»§ç»­æ“ä½œçš„åŠæ³•ã€‚ä¹Ÿè®¸æˆ‘åº”è¯¥è¯´ï¼Œå±…ç„¶è¿˜æœ‰ã€‚</p><p>åœ¨ ES7 ä¸­ï¼Œasync/await çš„è¯­æ³•ç³–è¢«å¼•å…¥ã€‚é€šè¿‡å®ƒï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ä»£ç çš„å†™æ³•ï¼Œè®©å¼‚æ­¥ç¼–ç¨‹è¶Šæ¥è¶ŠåƒåŒæ­¥ç¼–ç¨‹ï¼Œä¹Ÿè¶Šæ¥è¶Šæ¥è¿‘äººå¤§è„‘è‡ªç„¶çš„æ€ç»´ã€‚</p><ul>\n<li>async ç”¨äºæ ‡è®°å½“å‰çš„å‡½æ•°ä¸ºå¼‚æ­¥å‡½æ•°ï¼›</li>\n<li>await ç”¨äºè¡¨ç¤ºå®ƒçš„åé¢è¦è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œåœ¨è¿™ä¸ª Promise å¯¹è±¡å¾—åˆ°å¼‚æ­¥ç»“æœä»¥åï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</li>\n</ul><p>è€ƒè™‘ä¸€ä¸‹ä¸Šé¢çš„ run æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¹å†™æˆ async/await çš„å½¢å¼ï¼š</p><pre><code>var run = async steps =&gt; {\n  await wait(1000);\n  console.log(steps);\n}\n</code></pre><p>ä½ çœ‹ï¼Œä»£ç çœ‹èµ·æ¥å°±å’ŒåŒæ­¥çš„æ²¡æœ‰æœ¬è´¨åŒºåˆ«äº†ï¼Œç­‰å¾… 1000 æ¯«ç§’ä»¥åï¼Œæ‰“å° stepsã€‚</p><p>æ¥ç€ï¼Œå¦‚æœæˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼ˆå¦‚æœä½ ä¸æ˜¯åœ¨ Chrome çš„æ§åˆ¶å°æ‰§è¡Œï¼Œä½ å¯ä»¥æŠŠä¸‹é¢ä¸‰è¡Œä»£ç æ”¾åˆ°ä»»æ„ä¸€ä¸ª async å‡½æ•°ä¸­å»æ‰§è¡Œï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼‰ï¼š</p><pre><code>await run(1);\nawait run(2);\nawait run(3);\n</code></pre><p>æˆ‘ä»¬å¾—åˆ°äº†ä¸€æ ·çš„ç»“æœã€‚è¿™æ®µä»£ç çœ‹èµ·æ¥ä¹Ÿå’Œé¡ºåºã€åŒæ­¥æ‰§è¡Œçš„ä»£ç æ²¡æœ‰åŒºåˆ«äº†ï¼Œè™½ç„¶ï¼Œå®é™…çš„è¿è¡Œä¾ç„¶æ˜¯å‰é¢ä½ çœ‹åˆ°çš„å¼‚æ­¥è°ƒç”¨ï¼Œè¿™é‡Œçš„æ•ˆæœåªæ˜¯ async/await è¯­æ³•ç³–ä¸ºç¨‹åºå‘˜åˆ›é€ çš„ä¸€ä¸ªç¾å¥½çš„å‡è±¡ã€‚</p><p>çºµè§‚è¿™ä¸ªå°ç‹—å¥”è·‘çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æŠŠæ™¦æ¶©éš¾æ‡‚çš„åµŒå¥—å›è°ƒä»£ç ï¼Œä¼˜åŒ–æˆäº†æ˜“è¯»ã€æ˜“ç†è§£çš„â€œå‡åŒæ­¥â€ä»£ç ã€‚èªæ˜çš„ç¨‹åºå‘˜æ€»åœ¨åŠªåŠ›åœ°åˆ›é€ å„ç§å·¥å…·ï¼Œå»<strong>æ”¹å–„ä»£ç å¼‚æ­¥è°ƒç”¨çš„è¡¨è¾¾èƒ½åŠ›ï¼Œä½†æ˜¯è¶Šæ˜¯æ·±å…¥ï¼Œå°±è¶Šèƒ½å‘ç°ï¼Œæœ€è‡ªç„¶çš„è¡¨è¾¾ï¼Œä¼¼ä¹æ¥è‡ªäºçº¯ç²¹çš„åŒæ­¥ä»£ç ã€‚</strong></p><h2>2. ç”¨ç”Ÿæˆå™¨æ¥å®ç°åç¨‹</h2><p><strong>åç¨‹ï¼ŒCoroutineï¼Œç®€å•è¯´å°±æ˜¯ä¸€ç§é€šç”¨çš„åä½œå¼å¤šä»»åŠ¡çš„å­ç¨‹åºï¼Œå®ƒé€šè¿‡ä»»åŠ¡æ‰§è¡Œçš„æŒ‚èµ·ä¸æ¢å¤ï¼Œæ¥å®ç°ä»»åŠ¡ä¹‹é—´çš„åˆ‡æ¢ã€‚</strong></p><p>è¿™é‡Œæåˆ°çš„â€œåä½œå¼â€ï¼Œæ˜¯ä¸€ç§å¤šä»»åŠ¡å¤„ç†çš„æ¨¡å¼ï¼Œå®ƒå’Œâ€œæŠ¢å å¼â€ç›¸å¯¹ã€‚å¦‚æœæ˜¯åä½œå¼ï¼Œæ¯ä¸ªä»»åŠ¡å¤„ç†çš„é€»è¾‘å¿…é¡»ä¸»åŠ¨æ”¾å¼ƒæ‰§è¡Œæƒï¼ˆæŒ‚èµ·ï¼‰ï¼Œå°†ç»§ç»­æ‰§è¡Œçš„èµ„æºè®©å‡ºæ¥ç»™åˆ«çš„ä»»åŠ¡ï¼Œç›´åˆ°é‡æ–°è·å¾—ç»§ç»­æ‰§è¡Œçš„æœºä¼šï¼ˆæ¢å¤ï¼‰ï¼›è€ŒæŠ¢å å¼åˆ™å®Œå…¨å°†ä»»åŠ¡è°ƒåº¦äº¤ç”±ç¬¬ä¸‰æ–¹ï¼Œæ¯”å¦‚æ“ä½œç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç›´æ¥å‰¥å¤ºå½“å‰æ‰§è¡Œä»»åŠ¡çš„èµ„æºï¼Œåˆ†é…ç»™å…¶å®ƒä»»åŠ¡ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œåˆ›å»ºçº¿ç¨‹çš„å¼€é”€æ¯”è¿›ç¨‹å°ï¼Œè€Œåç¨‹é€šå¸¸å®Œå…¨æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…å®Œæˆçš„ï¼Œè¿çº¿ç¨‹åˆ‡æ¢çš„ä»£ä»·éƒ½å…å»äº†ï¼Œå› æ­¤å®ƒåœ¨èµ„æºå¼€é”€æ–¹é¢æ›´æœ‰ä¼˜åŠ¿ã€‚</p><p>JavaScript çš„åç¨‹æ˜¯é€šè¿‡ç”Ÿæˆå™¨æ¥å®ç°çš„ï¼Œæ‰§è¡Œçš„ä¸»æµç¨‹åœ¨ç”Ÿæˆå™¨ä¸­å¯ä»¥ä»¥ yield ä¸ºç•Œï¼Œè¿›è¡Œåä½œå¼çš„æŒ‚èµ·å’Œæ¢å¤æ“ä½œï¼Œä»è€Œåœ¨å¤–éƒ¨å‡½æ•°å’Œç”Ÿæˆå™¨å†…éƒ¨é€»è¾‘ä¹‹é—´è·³è½¬ï¼Œè€Œ JavaScript å¼•æ“ä¼šè´Ÿè´£ç®¡ç†ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥è®¤è¯†ä¸€ä¸‹ JavaScript å’Œè¿­ä»£æœ‰å…³çš„ä¸¤ä¸ªåè®®ï¼Œå®ƒä»¬æ˜¯æˆ‘ä»¬åé¢å­¦ä¹ ç”Ÿæˆå™¨çš„åŸºç¡€ï¼š</p><ul>\n<li>ç¬¬ä¸€ä¸ªæ˜¯å¯è¿­ä»£åè®®ï¼Œå®ƒå…è®¸å®šä¹‰å¯¹è±¡è‡ªå·±çš„è¿­ä»£è¡Œä¸ºï¼Œæ¯”å¦‚å“ªäº›å±æ€§æ–¹æ³•æ˜¯å¯ä»¥è¢« for å¾ªç¯éå†åˆ°çš„ï¼›</li>\n<li>ç¬¬äºŒä¸ªæ˜¯è¿­ä»£å™¨åè®®ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§æ ‡å‡†çš„æ–¹æ³•æ¥ä¾æ¬¡äº§ç”Ÿåºåˆ—çš„ä¸‹ä¸€ä¸ªå€¼ï¼ˆnext() æ–¹æ³•ï¼‰ï¼Œå¦‚æœåºåˆ—æ˜¯æœ‰é™é•¿çš„ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰çš„å€¼éƒ½äº§ç”Ÿåï¼Œå°†æœ‰ä¸€ä¸ªé»˜è®¤çš„è¿”å›å€¼ã€‚</li>\n</ul><p>æ¥ç€æˆ‘å°±å¯ä»¥ä»‹ç»ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰äº†ã€‚åœ¨ JavaScript ä¸­ï¼Œç”Ÿæˆå™¨å¯¹è±¡æ˜¯ç”±ç”Ÿæˆå™¨å‡½æ•° function* è¿”å›ï¼Œä¸”ç¬¦åˆâ€œå¯è¿­ä»£åè®®â€å’Œâ€œè¿­ä»£å™¨åè®®â€ä¸¤è€…ã€‚function* å’Œ yield å…³é”®å­—é€šå¸¸ä¸€èµ·ä½¿ç”¨ï¼Œyield ç”¨æ¥åœ¨ç”Ÿæˆå™¨çš„ next() æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œæ ‡è¯†ç”Ÿæˆå™¨æ‰§è¡Œä¸­æ–­çš„ä½ç½®ï¼Œå¹¶å°† yield å³ä¾§è¡¨è¾¾å¼çš„å€¼è¿”å›ã€‚è§ä¸‹é¢è¿™ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><pre><code>function* IdGenerator() {\n  let index = 1;\n  while (true)\n    yield index++;\n}\n\nvar idGenerator = IdGenerator();\n\nconsole.log(idGenerator.next());\nconsole.log(idGenerator.next());\n</code></pre><p>è¿™æ˜¯ä¸€ä¸ª id é¡ºåºç”Ÿæˆçš„ç”Ÿæˆå™¨ï¼Œåˆå§‹ index ä¸º 1ï¼Œæ¯æ¬¡è°ƒç”¨ next() æ¥è·å–åºåˆ—çš„ä¸‹ä¸€ä¸ªæ•°å€¼ï¼Œå¹¶ä¸” index ä¼šè‡ªå¢ 1ã€‚ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— é™çš„åºåˆ—ã€‚</p><p>æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ï¼š</p><pre><code>{value: 1, done: false}\n{value: 2, done: false}\n</code></pre><p>æ¯æ¬¡è¿”å›çš„å¯¹è±¡é‡Œé¢ï¼Œvalue çš„å€¼å°±æ˜¯ç”Ÿæˆçš„ idï¼Œè€Œ done çš„å€¼è¡¨ç¤ºè¿™ä¸ªåºåˆ—æ˜¯å¦ç»“æŸã€‚</p><p>ä½ çœ‹ï¼Œä»¥å¾€æˆ‘ä»¬è¯´èµ·éå†çš„æ—¶å€™ï¼Œè„‘æµ·é‡Œæ€»ä¼šç¬¬ä¸€æ—¶é—´æƒ³èµ·æŸä¸ªå®¹å™¨ï¼ŒæŸä¸ªæ•°æ®é›†åˆï¼Œä½†æ˜¯ï¼Œæœ‰äº†ç”Ÿæˆå™¨ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹æ›´ä¸ºå¤æ‚çš„é€»è¾‘è¿›è¡Œè¿­ä»£ã€‚</p><p>ç”Ÿæˆå™¨å¯ä¸æ˜¯åªèƒ½å¾€å¤–è¿”å›ï¼Œè¿˜èƒ½å¾€é‡Œä¼ å€¼ã€‚å…·ä½“è¯´ï¼Œyield å³ä¾§çš„è¡¨è¾¾å¼ä¼šè¿”å›ï¼Œä½†æ˜¯åœ¨è°ƒç”¨ next() æ–¹æ³•æ—¶ï¼Œå…¥å‚ä¼šè¢«æ›¿ä»£æ‰ yield åŠå³ä¾§çš„è¡¨è¾¾å¼è€Œå‚ä¸ä»£ç è¿ç®—ã€‚æˆ‘ä»¬å°†ä¸Šé¢çš„ä¾‹å­å°å°åœ°æ”¹åŠ¨ä¸€ä¸‹ï¼š</p><pre><code>function* IdGenerator() {\n  let index = 1, factor = 1;\n  while (true) {\n    factor = yield index; // ä½ç½®â‘ \n    index = yield factor * index; // ä½ç½®â‘¡\n  }\n}\n</code></pre><p>å¥½ï¼Œè¿™æ˜¯ç”Ÿæˆå™¨çš„å®šä¹‰ï¼Œå…¶è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>var calculate = (idGenerator) =&gt; {\n  console.log(idGenerator.next());\n  console.log(idGenerator.next(1));\n  console.log(idGenerator.next(2));\n  console.log(idGenerator.next(3));\n};\n\ncalculate(IdGenerator());\n</code></pre><p>åœ¨å¾€ä¸‹é˜…è¯»ä»¥å‰ï¼Œä½ èƒ½ä¸èƒ½å…ˆæƒ³ä¸€æƒ³ï¼Œè¿™ä¸ª calculate æ–¹æ³•çš„è°ƒç”¨ï¼Œä¼šäº§ç”Ÿæ€æ ·çš„è¾“å‡ºï¼Ÿ</p><p>å¥½ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ã€‚ç°åœ¨è¿™ä¸ª id ç”Ÿæˆå™¨æ¯ä¸ªå¾ªç¯èŠ‚å¯ä»¥é€šè¿‡ yield è¿”å›ä¸¤æ¬¡ï¼Œæˆ‘æŠŠä¸Šè¿°æ‰§è¡Œæ­¥éª¤è§£é‡Šä¸€ä¸‹ï¼ˆä¸ºäº†ä¾¿äºè¯´æ˜ä»£ç ä½ç½®ï¼Œåœ¨ç”Ÿæˆå™¨ä»£ç ä¸­æˆ‘æ ‡è®°äº†â€œä½ç½®â‘ â€å’Œâ€œä½ç½®â‘¡â€ï¼Œè¯·å¯¹åº”èµ·æ¥æŸ¥çœ‹ï¼‰ï¼š</p><ul>\n<li>è°ƒç”¨ next()ï¼Œä½ç½®â‘ çš„ yield å³ä¾§çš„ index è¿”å›ï¼Œå› æ­¤å€¼ä¸º 1ï¼›</li>\n<li>è°ƒç”¨ next(1)ï¼Œå®å‚ä¸º 1ï¼Œå®ƒè¢«èµ‹å€¼ç»™ä½ç½®â‘ çš„ factorï¼Œå‚ä¸ä½ç½®â‘¡çš„ yield å³ä¾§çš„è¡¨è¾¾å¼è®¡ç®—ï¼Œå¾—åˆ° 1ï¼›</li>\n<li>è°ƒç”¨ next(2)ï¼Œå®å‚ä¸º 2ï¼Œå®ƒè¢«èµ‹å€¼ç»™ä½ç½®â‘¡çš„ indexï¼Œç”±äº while å¾ªç¯çš„å…³ç³»ï¼Œä½ç½®â‘ çš„ yield å³ä¾§çš„ index è¿”å›ï¼Œå› æ­¤å¾—åˆ° 2ï¼›</li>\n<li>è°ƒç”¨ next(3)ï¼Œå®å‚ä¸º 3ï¼Œå®ƒè¢«èµ‹å€¼ç»™ä½ç½®â‘ çš„ factorï¼Œå‚ä¸ä½ç½®â‘¡çš„ yield å³ä¾§çš„è¡¨è¾¾å¼è®¡ç®—ï¼Œ3 * 2 å¾—åˆ° 6ã€‚</li>\n</ul><p>ä½¿ç”¨å›¾æ¥è¡¨ç¤ºï¼Œå°±æ˜¯è¿™æ ·å­ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/66/49/66e19715cc976a6870f73e2a8d34bb49.png?wh=876*1603\" alt=\"\"></p><p>ä»å›¾ä¸­ä½ åº”è¯¥å¯ä»¥ç†è§£ï¼Œé€šè¿‡ç”Ÿæˆå™¨æ¥å®ç° JavaScript åç¨‹çš„åŸç†äº†ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼Œ<strong>ç”Ÿæˆå™¨å°†ä¸€ä¸ªå®Œæ•´çš„æ–¹æ³•æ‰§è¡Œé€šè¿‡ yield æ‹†åˆ†æˆäº†å¤šä¸ªéƒ¨åˆ†ï¼Œå¹¶ä¸”æ¯ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥æœ‰è¾“å…¥è¾“å‡ºï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºã€‚</strong>å®ƒå’Œå…¶å®ƒå‡½æ•°ä¸€èµ·ï¼Œä»¥åå¤æŒ‚èµ·å’Œæ¢å¤çš„æ–¹å¼ä¸€æ®µä¸€æ®µåœ°å°†ä»»åŠ¡å®Œæˆã€‚</p><p>æœ€åï¼Œç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p><pre><code>{value: 1, done: false}\n{value: 1, done: false}\n{value: 2, done: false}\n{value: 6, done: false}\n</code></pre><h2>3. å¼‚æ­¥é”™è¯¯å¤„ç†</h2><p>é”™è¯¯å¤„ç†æ˜¯æ‰€æœ‰ç¼–ç¨‹èŒƒå‹éƒ½å¿…é¡»è¦è€ƒè™‘çš„é—®é¢˜ï¼Œåœ¨ä½¿ç”¨ JavaScript è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹æ—¶ï¼Œä¹Ÿä¸ä¾‹å¤–ã€‚ä½ å¯èƒ½ä¼šæœ‰è¿™æ ·ä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœæˆ‘ä»¬ä¸åšç‰¹æ®Šå¤„ç†ï¼Œä¼šæ€æ ·å‘¢ï¼Ÿä¸”çœ‹ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘å…ˆå®šä¹‰ä¸€ä¸ªå¿…å®šä¼šå¤±è´¥çš„æ–¹æ³•ï¼š</p><pre><code>var fail = () =&gt; {\n  setTimeout(() =&gt; {\n    throw new Error(&quot;fail&quot;);\n  }, 1000);\n};\n</code></pre><p>ç„¶åè°ƒç”¨ä¸€ä¸‹ï¼š</p><pre><code>console.log(1);\ntry {\n  fail();\n} catch (e) {\n  console.log(&quot;captured&quot;);\n}\nconsole.log(2);\n</code></pre><p>åœ¨ Chrome å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°ä¸­æ‰§è¡Œä¸€ä¸‹ï¼Œæˆ‘ä»¬å°†çœ‹åˆ° 1 å’Œ 2 çš„è¾“å‡ºï¼Œå¹¶åœ¨ 1 ç§’é’Ÿä¹‹åï¼Œè·å¾—ä¸€ä¸ªâ€œUncaught Errorâ€çš„é”™è¯¯æ‰“å°ï¼Œæ³¨æ„è§‚å¯Ÿè¿™ä¸ªé”™è¯¯çš„å †æ ˆï¼š</p><pre><code>Uncaught Error: fail\n    at &lt;anonymous&gt;:3:11\n    at e (lizard-service-vendor.2b011077.js:1)\n\t(anonymous)\t@\tVM261:3\n\te\t@\tlizard-service-vendor.2b011077.js:1\n\tsetTimeout (async)\t\t\n\t(anonymous)\t@\tlizard-service-vendor.2b011077.js:1\n\tfail\t@\tVM261:2\n\t(anonymous)\t@\tVM296:3\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°äº†å…¶ä¸­çš„ setTimeout (async) è¿™æ ·çš„å­—æ ·ï¼Œè¡¨ç¤ºç€è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨æŠ›å‡ºçš„å †æ ˆï¼Œä½†æ˜¯ï¼Œâ€œcapturedâ€ è¿™æ ·çš„å­—æ ·ä¹Ÿå¹¶æœªæ‰“å°ï¼Œå› ä¸ºæ¯æ–¹æ³• fail() æœ¬èº«çš„åŸå§‹é¡ºåºæ‰§è¡Œå¹¶æ²¡æœ‰å¤±è´¥ï¼Œè¿™ä¸ªå¼‚å¸¸çš„æŠ›å‡ºæ˜¯åœ¨å›è°ƒè¡Œä¸ºé‡Œå‘ç”Ÿçš„ã€‚</p><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºå¼‚æ­¥ç¼–ç¨‹æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ç§æ›´å¥½çš„æœºåˆ¶æ¥æ•è·å¹¶å¤„ç†å¯èƒ½å‘ç”Ÿçš„å¼‚å¸¸ã€‚</p><h3>Promise çš„å¼‚å¸¸å¤„ç†</h3><p>è¿˜è®°å¾—ä¸Šé¢ä»‹ç»çš„ Promise å—ï¼Ÿå®ƒé™¤äº†æ”¯æŒ resolve å›è°ƒä»¥å¤–ï¼Œè¿˜æ”¯æŒ reject å›è°ƒï¼Œå‰è€…ç”¨äºè¡¨ç¤ºå¼‚æ­¥è°ƒç”¨é¡ºåˆ©ç»“æŸï¼Œè€Œåè€…åˆ™è¡¨ç¤ºæœ‰å¼‚å¸¸å‘ç”Ÿï¼Œä¸­æ–­è°ƒç”¨é“¾å¹¶å°†å¼‚å¸¸æŠ›å‡ºï¼š</p><pre><code>var exe = (flag) =&gt;\n  () =&gt; new Promise((resolve, reject) =&gt; {\n    console.log(flag);\n    setTimeout(() =&gt; { flag ? resolve(&quot;yes&quot;) : reject(&quot;no&quot;); }, 1000);\n  });\n</code></pre><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œflag å‚æ•°ç”¨æ¥æ§åˆ¶æµç¨‹æ˜¯é¡ºåˆ©æ‰§è¡Œè¿˜æ˜¯å‘ç”Ÿé”™è¯¯ã€‚åœ¨é”™è¯¯å‘ç”Ÿçš„æ—¶å€™ï¼Œno å­—ç¬¦ä¸²ä¼šè¢«ä¼ é€’ç»™ reject å‡½æ•°ï¼Œè¿›ä¸€æ­¥ä¼ é€’ç»™è°ƒç”¨é“¾ï¼š</p><pre><code>Promise.resolve()\n  .then(exe(false))\n  .then(exe(true));\n</code></pre><p>ä½ çœ‹ï¼Œä¸Šé¢çš„è°ƒç”¨é“¾ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œç¬¬äºŒè¡Œå°±ä¼ å…¥äº†å‚æ•° falseï¼Œå®ƒå°±å·²ç»å¤±è´¥äº†ï¼Œå¼‚å¸¸æŠ›å‡ºäº†ï¼Œå› æ­¤ç¬¬ä¸‰è¡Œçš„ exe å®é™…æ²¡æœ‰å¾—åˆ°æ‰§è¡Œï¼Œä½ ä¼šçœ‹åˆ°è¿™æ ·çš„æ‰§è¡Œç»“æœï¼š</p><pre><code>false\nUncaught (in promise) no\n</code></pre><p>è¿™å°±è¯´æ˜ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œè°ƒç”¨é“¾è¢«ä¸­æ–­äº†ï¼Œä¸‹ä¸€ä¸ªæ­£å¸¸é€»è¾‘ exe(true) æ²¡æœ‰è¢«æ‰§è¡Œã€‚</p><p>ä½†æ˜¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ•è·é”™è¯¯ï¼Œè€Œç»§ç»­æ‰§è¡Œåé¢çš„é€»è¾‘ï¼Œè¯¥æ€æ ·åšï¼Ÿè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±è¦åœ¨è°ƒç”¨é“¾ä¸­ä½¿ç”¨ catch äº†ï¼š</p><pre><code>Promise.resolve()\n  .then(exe(false))\n  .catch((info) =&gt; { console.log(info); })\n  .then(exe(true));\n</code></pre><p>è¿™ç§æ–¹å¼ä¸‹ï¼Œå¼‚å¸¸ä¿¡æ¯è¢«æ•è·å¹¶æ‰“å°ï¼Œè€Œè°ƒç”¨é“¾çš„ä¸‹ä¸€æ­¥ï¼Œä¹Ÿå°±æ˜¯ç¬¬å››è¡Œçš„ exe(true) å¯ä»¥ç»§ç»­è¢«æ‰§è¡Œã€‚æˆ‘ä»¬å°†çœ‹åˆ°è¿™æ ·çš„è¾“å‡ºï¼š</p><pre><code>false\nno\ntrue\n</code></pre><h3>async/await ä¸‹çš„å¼‚å¸¸å¤„ç†</h3><p>åˆ©ç”¨ async/await çš„è¯­æ³•ç³–ï¼Œæˆ‘ä»¬å¯ä»¥åƒå¤„ç†åŒæ­¥ä»£ç çš„å¼‚å¸¸ä¸€æ ·ï¼Œæ¥å¤„ç†å¼‚æ­¥ä»£ç ï¼š</p><pre><code>var run = async () =&gt; {\n  try {\n    await exe(false)();\n    await exe(true)();\n  } catch (e) {\n    console.log(e);\n  }\n}\n\nrun();\n</code></pre><p>ç®€å•è¯´æ˜ä¸€ä¸‹ ï¼Œå®šä¹‰ä¸€ä¸ªå¼‚æ­¥æ–¹æ³• runï¼Œç”±äº await åé¢éœ€è¦ç›´æ¥è·Ÿ Promise å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡é¢å¤–çš„ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ç¬¦å· () æŠŠåŸæœ‰çš„ exe æ–¹æ³•å†…éƒ¨çš„ Thunk åŒ…è£…æ‹†æ‰ï¼Œå³æ‰§è¡Œ exe(false)() æˆ– exe(true)() è¿”å›çš„å°±æ˜¯ Promise å¯¹è±¡ã€‚åœ¨ try å—ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨ catch æ¥æ•æ‰ã€‚è¿è¡Œä»£ç ï¼Œæˆ‘ä»¬å¾—åˆ°äº†è¿™æ ·çš„è¾“å‡ºï¼š</p><pre><code>false\nno\n</code></pre><p>è¿™ä¸ª false å°±æ˜¯ exe æ–¹æ³•å¯¹å…¥å‚çš„è¾“å‡ºï¼Œè€Œè¿™ä¸ª no å°±æ˜¯ setTimeout æ–¹æ³• reject çš„å›è°ƒè¿”å›ï¼Œå®ƒé€šè¿‡å¼‚å¸¸æ•è·å¹¶æœ€ç»ˆåœ¨ catch å—ä¸­è¾“å‡ºã€‚å°±åƒæˆ‘ä»¬æ‰€è®¤è¯†çš„åŒæ­¥ä»£ç ä¸€æ ·ï¼Œç¬¬å››è¡Œçš„ exe(true) å¹¶æœªå¾—åˆ°æ‰§è¡Œã€‚</p><h2>æ€»ç»“æ€è€ƒ</h2><p>ä»Šå¤©æˆ‘ä»¬ç»“åˆå®ä¾‹å­¦ä¹ äº† JavaScript å¼‚æ­¥ç¼–ç¨‹çš„ä¸€äº›æ–¹æ³•ï¼ŒåŒ…æ‹¬ä½¿ç”¨ Promise æˆ– async/await æ¥æ”¹å–„å¼‚æ­¥ä»£ç ï¼Œä½¿ç”¨ç”Ÿæˆå™¨æ¥å®ç°åç¨‹ï¼Œä»¥åŠæ€æ ·è¿›è¡Œå¼‚æ­¥é”™è¯¯å¤„ç†ç­‰ç­‰ã€‚å…¶ä¸­ï¼ŒPromise ç›¸å…³çš„ä½¿ç”¨æ˜¯éœ€è¦é‡ç‚¹ç†è§£çš„å†…å®¹ï¼Œå› ä¸ºå®ƒçš„åº”ç”¨æ€§éå¸¸æ™®éã€‚</p><p>ç°åœ¨ï¼Œæˆ‘æ¥æä¸¤ä¸ªé—®é¢˜ï¼š</p><ul>\n<li>åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼Œæ˜¯å¦ä½¿ç”¨è¿‡ JavaScript å¼‚æ­¥ç¼–ç¨‹ï¼Œéƒ½ä½¿ç”¨äº†å’Œå¼‚æ­¥ç¼–ç¨‹æœ‰å…³çš„å“ªäº›æŠ€æœ¯å‘¢ï¼Ÿ</li>\n<li>ES6 å’Œ ES7 å¼•å…¥äº†å¾ˆå¤š JavaScript çš„é«˜çº§ç‰¹æ€§å’Œè¯­æ³•ç³–ï¼ŒåŒ…æ‹¬è¿™ä¸€è®²æåˆ°çš„éƒ¨åˆ†ã€‚æœ‰ç¨‹åºå‘˜æœ‹å‹è®¤ä¸ºï¼Œè¿™äº›åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨ï¼Œåè€Œç»™ç¼–ç¨‹äººå‘˜çš„é˜…è¯»å’Œç†è§£é€ æˆäº†å›°æ‰°ï¼Œå¢åŠ äº†å­¦ä¹ æ›²çº¿ï¼Œè¿˜ä¸å¦‚ä¸ç”¨å®ƒä»¬ï¼Œå†™â€œç®€å•â€çš„ JavaScript è¯­æ³•ã€‚å¯¹æ­¤ï¼Œä½ æ€ä¹ˆçœ‹ï¼Ÿ</li>\n</ul><p>åœ¨æœ¬ç« æˆ‘ä»¬å­¦ä¹ äº†åŸºäº Web çš„å…¨æ ˆæŠ€æœ¯ä¸­ï¼Œå‰ç«¯ç›¸å…³çš„éƒ¨åˆ†ï¼Œå¸Œæœ›è¿™äº›å†…å®¹èƒ½å¤Ÿå¸®åˆ°ä½ ï¼Œåœ¨å‰ç«¯è¿™å—åœŸåœ°ä¸Šæˆé•¿ä¸ºæ›´å¥½çš„å·¥ç¨‹å¸ˆã€‚åŒæ—¶ï¼Œåœ¨è¿™ä¸€ç« æˆ‘ä»¬å­¦åˆ°äº†å¾ˆå¤šå¥—è·¯å’Œæ–¹æ³•ï¼Œè¯·å›æƒ³ä¸€ä¸‹ï¼Œå¹¶åœ¨æœªæ¥çš„å·¥ä½œä¸­æ…¢æ…¢åº”ç”¨å’Œä½“ä¼šï¼Œå®ƒä»¬éƒ½æ˜¯å¯ä»¥åº”ç”¨åˆ°è½¯ä»¶å…¶å®ƒé¢†åŸŸçš„è®¾è®¡å’Œç¼–ç ä¸Šçš„ã€‚åœ¨ç¬¬å››ç« ï¼Œæˆ‘ä»¬ä¼šå°†ç›®å…‰å¾€åç§»ï¼Œå»äº†è§£äº†è§£æŒä¹…åŒ–çš„ä¸–ç•Œï¼Œå¸Œæœ›ç°åœ¨çš„ä½ ä¾ç„¶å……æ»¡å¹²åŠ²ï¼</p><h2>æ‰©å±•é˜…è¯»</h2><ul>\n<li>å¯¹äºä»Šå¤©å­¦ä¹ çš„ Promiseï¼Œä½ å¯ä»¥åœ¨ MDN çš„<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Using_promises\">ä½¿ç”¨ Promise</a> ä¸€æ–‡ä¸­è¯»åˆ°æ›´ä¸ºè¯¦å°½çš„ä»‹ç»ï¼›ç¬¬äºŒä¸ªæ˜¯ç”Ÿæˆå™¨ï¼Œç”Ÿæˆå™¨å®é™…ä¸ŠåŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œå®ƒç”šè‡³å¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥å‚è§ <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/function*\">MDN çš„ç¤ºä¾‹æ•™ç¨‹</a>ã€‚</li>\n<li>å¦‚æœä½ æƒ³å¿«é€Ÿæµè§ˆ ES6 æ–°å¸¦æ¥çš„ JavaScript é«˜çº§ç‰¹æ€§ï¼Œæˆ‘æ¨èä½ æµè§ˆ  <a href=\"http://es6.ruanyifeng.com/\">ECMAScript 6 å…¥é—¨</a>ï¼Œä»ä¸­æŒ‘é€‰ä½ æ„Ÿå…´è¶£çš„å†…å®¹é˜…è¯»ã€‚</li>\n<li><a href=\"https://hackernoon.com/async-await-generators-promises-51f1a6ceede2\">Async-Await â‰ˆ Generators + Promises</a> è¿™ç¯‡æ–‡ç« ä»‹ç»äº†ç”Ÿæˆå™¨ã€Promise å’Œ async/await ä¹‹é—´çš„å…³ç³»ï¼Œè¯»å®Œä½ å°±èƒ½æ˜ç™½â€œä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´ async/await æ˜¯ç”Ÿæˆå™¨å’Œ Promise çš„è¯­æ³•ç³–â€ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥é˜…è¯»ï¼Œæƒ³é˜…è¯»ä¸­æ–‡ç‰ˆçš„å¯ä»¥å‚è§<a href=\"https://hackernoon.com/async-await-generators-promises-51f1a6ceede2\">è¿™ä¸ªç¿»è¯‘</a>ã€‚</li>\n</ul><p></p>","comments":[{"had_liked":false,"id":148569,"user_name":"äºŒç‹—","can_delete":false,"product_type":"c1","uid":1244288,"ip_address":"","ucode":"91C38887F4F07B","user_header":"https://static001.geekbang.org/account/avatar/00/12/fc/80/21d67b9b.jpg","comment_is_top":false,"comment_ctime":1573032004,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5867999300","product_id":100035501,"comment_content":"å¼‚æ­¥ å„ç§ç®­å¤´åµŒå¥—  jså¥½éš¾è¯» å¥½éš¾æ‡‚","like_count":2,"discussions":[{"author":{"id":1580075,"avatar":"https://static001.geekbang.org/account/avatar/00/18/1c/2b/2069abe6.jpg","nickname":"å››ç«","note":"","ucode":"E4BED7DCAADD99","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":60661,"discussion_content":"æœ‰äº›çœ‹èµ·æ¥éš¾æ‡‚åªæ˜¯ä¸€äº›è¯­æ³•ï¼Œå¾ˆå¿«å°±èƒ½é€‚åº”ï¼›æœ‰äº›çœ‹èµ·æ¥éš¾æ‡‚åˆ™æ˜¯é€»è¾‘ã€å…³ç³»ã€æµç¨‹å’Œä»£ç ç»“æ„ç­‰çš„ç†è§£ï¼Œè¿™äº›éœ€è¦æ…¢æ…¢ç§¯ç´¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574744116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145650,"user_name":"å’•å½å’•å½","can_delete":false,"product_type":"c1","uid":1023333,"ip_address":"","ucode":"628DE6B1008D3A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9d/65/ef4fc8e1.jpg","comment_is_top":false,"comment_ctime":1572336896,"is_pvip":false,"replies":[{"id":"56325","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"å››ç«","uid":"1580075","ctime":1572407617,"ip_address":"","comment_id":145650,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5867304192","product_id":100035501,"comment_content":"1ï¼Œä¸»è¦ä½¿ç”¨è¿‡å¦‚ä¸‹çš„å¼‚æ­¥ç¼–ç¨‹ï¼šä½¿ç”¨è¿‡åˆ©ç”¨å¼‚æ­¥ç¼–ç¨‹ï¼Œå°†å¤§çš„è®¡ç®—ä»»åŠ¡åˆ†æˆå°çš„è®¡ç®—ä»»åŠ¡ã€‚å½“æ—¶çš„åœºæ™¯æ˜¯é¡µé¢æ»šåŠ¨çš„åŒæ—¶ï¼Œéœ€è¦å¤§é‡è®¡ç®—ï¼ŒæŸäº›æ‰‹æœºä¼šå¡é¡¿ã€‚å°†è®¡ç®—åˆ†æˆå°çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¯ä»¥ä¿è¯æ»šåŠ¨çš„æµç•…<br>2ï¼Œä¸ªäººä¸æ˜¯å¾ˆè®¤åŒè¿™ç§çœ‹æ³•ã€‚å†™èµ·æ¥ç®€å•å¾—jsè¯­æ³•ï¼Œå¯èƒ½é˜…è¯»ï¼Œç»´æŠ¤æ¯”è¾ƒå›°éš¾ï¼Œæ¯•ç«Ÿä»£ç ä¸»è¦æ˜¯ç»™äººçœ‹çš„ã€‚å°±å¦‚æœ¬æ–‡ç”¨Promise &#47; asyncï¼Œawaitæ”¹å–„ä¹‹å‰çš„åµŒå¥—å†™æ³•ï¼Œä»£ç æ›´ä¼˜é›…ã€‚","like_count":1,"discussions":[{"author":{"id":1580075,"avatar":"https://static001.geekbang.org/account/avatar/00/18/1c/2b/2069abe6.jpg","nickname":"å››ç«","note":"","ucode":"E4BED7DCAADD99","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472508,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572407617,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208044,"user_name":"KevinÂ·ç¨‹","can_delete":false,"product_type":"c1","uid":1843468,"ip_address":"","ucode":"00C3A6A55B103D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/4KNQJyG0Uex2q6bkhL54O92EDU2ymvEKXSqfibHnP7WT5ZRia7EWfnXl9SwSttU2hxSEvjpLck1ByRdotViciafDxg/132","comment_is_top":false,"comment_ctime":1587263516,"is_pvip":false,"replies":[{"id":"78308","content":"æˆ‘çš„è¿™äº›ä¾‹å­ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç¤ºä¾‹åŸç†å’Œç”¨æ³•ï¼Œå¸®åŠ©ä½ æ›´å¥½ç†è§£å¼‚æ­¥ç¼–ç¨‹ã€‚å½“ç„¶ï¼Œæœ‰å¾ˆå¤šçš„å®é™…ä¸šåŠ¡åœºæ™¯ï¼Œéœ€è¦æˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹çš„æ–¹å¼æ¥å®ç°","user_name":"ä½œè€…å›å¤","user_name_real":"å››ç«","uid":"1580075","ctime":1587653287,"ip_address":"","comment_id":208044,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587263516","product_id":100035501,"comment_content":"å¼€å§‹æ²¡æ˜ç™½è€å¸ˆæå‡ºæ¥javascriptå¼‚æ­¥ç¼–ç¨‹å’Œå‰è¾¹çš„ä»£ç æ˜¯è¦è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Œè€Œä¸”promiseä¹Ÿæ˜¯çœ‹çš„ä¸€å¤´é›¾æ°´ã€‚åæ¥åå¤ç ”ç©¶ä¸€ä¸‹ï¼Œå‘ç°å°ç‹—è·‘æ­¥å¦‚æœç”¨é¡ºåºä»£ç æ‰§è¡Œï¼Œä½†æ˜¯æ¯ä¸€æ­¥å»¶è¿Ÿæ—¶é—´ä¸åŒçš„è¯ï¼Œå®ç°æœ€ç»ˆæ•ˆæœå´æœªå¿…æ˜¯é¡ºåºçš„ï¼Œç”šè‡³æ˜¯ç›¸åçš„ï¼Œå¦‚ä¸‹ä»£ç ï¼š<br>setTimeout(() =&gt;{ console.log(1); } , 10000); &#47;&#47;ç¬¬ä¸€æ¬¡è·‘10ç§’<br>setTimeout(() =&gt;{ console.log(2); } , 8000); &#47;&#47;ç¬¬äºŒæ¬¡è·‘8ç§’<br>setTimeout(() =&gt;{ console.log(3); } , 5000); &#47;&#47;ç¬¬ä¸‰æ¬¡è·‘5ç§’<br>ç»“æœæ˜¯ï¼š3 2 1çš„é¡ºåºã€‚<br>ä½†æ˜¯é€šè¿‡æœ¬æ–‡çš„ä»£ç å®ç°æ–¹å¼ï¼Œå´æ˜¯èƒ½å¤Ÿå®ç°å°ç‹—1-&gt;2-&gt;3çš„é¡ºåºè·‘æ­¥è¿‡ç¨‹çš„å±•ç°ï¼Œé¿å…ä¸Šé¢ä»£ç å¯¼è‡´çš„é¢ä¸åŒæ­¥ç°è±¡ã€‚æœ¬æ–‡ä»£ç ç¨åŠ ä¿®æ”¹ï¼Œå¥½åƒæ›´èƒ½ä½“ç°è¿™ç§åŒæ­¥æ§åˆ¶çš„æ•ˆæœï¼Œå¦‚ä¸‹ï¼š<br>setTimeout(<br>  () =&gt; {<br>    console.log(1);<br>    setTimeout(<br>      () =&gt; {<br>        console.log(2);<br>        setTimeout(<br>          () =&gt; {<br>            console.log(3);<br>          },<br>          5000<br>        );<br>      },<br>      8000<br>    );<br>  },<br>  10000<br>);<br><br>ç»“æœæ‰æ˜¯å®é™…æƒ³è¦è¾¾åˆ°çš„1 2 3çš„é¡ºåºã€‚å› æ­¤ä¸ªäººç†è§£è¿™æ ·æ˜¯ä¸ºäº†å®ç°å°ç‹—è·‘æ­¥æ•´ä¸ªè¿‡ç¨‹çš„åŒæ­¥æ§åˆ¶ã€‚ä¸çŸ¥ç†è§£çš„å¯¹ä¸å¯¹ã€‚<br>","like_count":1,"discussions":[{"author":{"id":1580075,"avatar":"https://static001.geekbang.org/account/avatar/00/18/1c/2b/2069abe6.jpg","nickname":"å››ç«","note":"","ucode":"E4BED7DCAADD99","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492321,"discussion_content":"æˆ‘çš„è¿™äº›ä¾‹å­ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç¤ºä¾‹åŸç†å’Œç”¨æ³•ï¼Œå¸®åŠ©ä½ æ›´å¥½ç†è§£å¼‚æ­¥ç¼–ç¨‹ã€‚å½“ç„¶ï¼Œæœ‰å¾ˆå¤šçš„å®é™…ä¸šåŠ¡åœºæ™¯ï¼Œéœ€è¦æˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹çš„æ–¹å¼æ¥å®ç°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587653287,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":147796,"user_name":"pyhhou","can_delete":false,"product_type":"c1","uid":1256496,"ip_address":"","ucode":"31EF8D50CF91A5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ibZVAmmdAibBeVpUjzwId8ibgRzNk7fkuR5pgVicB5mFSjjmt2eNadlykVLKCyGA0GxGffbhqLsHnhDRgyzxcKUhjg/132","comment_is_top":false,"comment_ctime":1572897641,"is_pvip":false,"replies":[{"id":"57148","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"å››ç«","uid":"1580075","ctime":1573014232,"ip_address":"","comment_id":147796,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1572897641","product_id":100035501,"comment_content":"1. Promise ä»¥åŠ async&#47;await åœ¨ç›®å‰å¼€å‘çš„é¡¹ç›®ä¸­å‡æœ‰ç”¨åˆ°ï¼Œasync&#47;await éå¸¸å¥½ç”¨ï¼Œç”¨åŒæ­¥çš„é£æ ¼å†™å¼‚æ­¥çš„ä»£ç ï¼Œè®©ä»£ç æ¸…æ™°æ˜“æ‡‚ï¼Œä½†æ˜¯å¹¶ä¸å»ºè®®ä»»ä½•åœ°æ–¹éƒ½åŠ ä¸Š async&#47;awaitï¼Œè¿™ä¼šå¤±å» JavaScript å¼‚æ­¥çš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚è¯´ç›¸äº’æ²¡æœ‰å…³è”æ€§çš„ I&#47;O å¤„ç†ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ Promise.all()ï¼Œå¦å¤–å»ºè®®å°½é‡ä¸è¦åœ¨å¾ªç¯é‡Œé¢å†™ async&#47;await è¿›è¡Œ I&#47;O è¯·æ±‚ï¼Œè¿™ä¼šä¸¥é‡å½±å“ç¨‹åºè¿è¡Œæ•ˆç‡<br><br>2. ä¸ªäººä¸æ•¢è‹ŸåŒã€‚ä¸å¾—ä¸æ‰¿è®¤ JavaScript æ˜¯ä¸€é—¨æœ‰è®¾è®¡ç¼ºé™·çš„è¯­è¨€ï¼Œåœ¨å…¶è¯ç”Ÿä¹‹åˆä»…ä»…æ˜¯ä¸ºäº†è§£å†³ç®€å•çš„é—®é¢˜ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå®ä¼Ÿçš„ç›®æ ‡å’Œè§„åˆ’ï¼Œä½†æ˜¯éšç€ Web çš„è¿…é€Ÿå‘å±•ï¼ŒJavaScript çš„åº”ç”¨é¢†åŸŸè¶Šæ¥è¶Šå¹¿æ³›ï¼Œä»å‰ç«¯é¡µé¢åˆ°åç«¯çš„ Nodeï¼ŒJavaScript é€æ¸å¸æ”¶å…¶ä»–è¯­è¨€çš„è®¾è®¡æ€æƒ³å¹¶ç»“åˆè‡ªèº«æƒ…å†µè¿›è¡Œé‡æ–°è®¾è®¡ï¼Œè®©å…¶ç¼–å†™æ›´è‡ªç„¶ä¹Ÿæ›´é«˜æ•ˆã€‚å…¶å®å¹¶ä¸è®¤åŒ â€œç»™ç¼–ç¨‹äººå‘˜çš„é˜…è¯»å’Œç†è§£é€ æˆå›°æ‰°â€ï¼Œåƒ Promise çš„å‡ºç°æœ¬èº«å°±æ˜¯ä¸ºäº†è§£å†³å¼‚æ­¥ç¼–ç é£æ ¼çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯å…¶ä»–é—®é¢˜ï¼Œä¹Ÿè®¸è¿™ä¼šå¯¹é‚£äº›åªä¼š JavaScriptï¼Œå¹¶ä¸”åªä¼šç”¨ JavaScript å†™ç®€å•çš„å‰ç«¯é¡µé¢çš„äººæœ‰å›°æ‰°ï¼Œä½†æ˜¯å¯¹å¤§å¤šæ•°ç¨‹åºå‘˜æ¥è¯´æ˜¯å¥½äº‹ã€‚å¦å¤–è¯´åˆ°å­¦ä¹ æ›²çº¿ï¼ŒJavaScript ç°åœ¨åœ¨å‰åç«¯ä¸Šéƒ½å¯ä»¥è¿›è¡Œå¼€å‘ï¼Œéš¾é“è¯´ä¼ ç»Ÿçš„åç«¯è¯­è¨€ï¼Œæ¯”å¦‚ï¼ŒJavaã€C++ å°±æ²¡æœ‰å­¦ä¹ æ›²çº¿å—ï¼Ÿåº”ç”¨é¢†åŸŸå˜å¹¿æ³›ï¼ŒæŠ€æœ¯å˜å¤šï¼Œå­¦ä¹ æ›²çº¿é€’å¢å…¶å®æ˜¯å†æ­£å¸¸ä¸è¿‡çš„äº‹æƒ…ï¼Œä¸è¿‡ï¼Œåˆ°å¤´æ¥ï¼Œè¿˜æ˜¯åƒè€å¸ˆè¯´çš„é‚£æ ·ï¼ŒæŠ€æœ¯éƒ½æ˜¯ç›¸é€šçš„ï¼Œç†è§£å…¶èƒŒåçš„æ€æƒ³æ˜¯å…³é”®","like_count":1,"discussions":[{"author":{"id":1580075,"avatar":"https://static001.geekbang.org/account/avatar/00/18/1c/2b/2069abe6.jpg","nickname":"å››ç«","note":"","ucode":"E4BED7DCAADD99","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473310,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573014232,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146905,"user_name":"æå¨","can_delete":false,"product_type":"c1","uid":1400349,"ip_address":"","ucode":"8B466DD6C42DE1","user_header":"https://static001.geekbang.org/account/avatar/00/15/5e/1d/82cedd0a.jpg","comment_is_top":false,"comment_ctime":1572694699,"is_pvip":false,"replies":[{"id":"56764","content":"è€å®è¯´ï¼Œè¿™å¯èƒ½æ˜¯è¿™ä¸ªä¸“æ é‡Œé¢æœ€éš¾çš„ä¸¤ã€ä¸‰ç¯‡æ–‡ç« ä¹‹ä¸€äº†ã€‚<br>è¦æ˜¯æœ‰äº›å†…å®¹ä½ å§‹ç»ˆæä¸æ‡‚ï¼Œå¹¶ä¸”æŠŠå…·ä½“é—®é¢˜è®²å‡ºæ¥çš„è¯ï¼Œå¯ä»¥è®¨è®º","user_name":"ä½œè€…å›å¤","user_name_real":"å››ç«","uid":"1580075","ctime":1572708824,"ip_address":"","comment_id":146905,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1572694699","product_id":100035501,"comment_content":"å¥½éš¾æ‡‚å•Š","like_count":1,"discussions":[{"author":{"id":1580075,"avatar":"https://static001.geekbang.org/account/avatar/00/18/1c/2b/2069abe6.jpg","nickname":"å››ç«","note":"","ucode":"E4BED7DCAADD99","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473051,"discussion_content":"è€å®è¯´ï¼Œè¿™å¯èƒ½æ˜¯è¿™ä¸ªä¸“æ é‡Œé¢æœ€éš¾çš„ä¸¤ã€ä¸‰ç¯‡æ–‡ç« ä¹‹ä¸€äº†ã€‚\nè¦æ˜¯æœ‰äº›å†…å®¹ä½ å§‹ç»ˆæä¸æ‡‚ï¼Œå¹¶ä¸”æŠŠå…·ä½“é—®é¢˜è®²å‡ºæ¥çš„è¯ï¼Œå¯ä»¥è®¨è®º","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572708824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145143,"user_name":"é›¶ç»´","can_delete":false,"product_type":"c1","uid":1235055,"ip_address":"","ucode":"D783CB1D59D1BE","user_header":"https://static001.geekbang.org/account/avatar/00/12/d8/6f/22e5ec55.jpg","comment_is_top":false,"comment_ctime":1572223715,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1572223715","product_id":100035501,"comment_content":"è€å¸ˆï¼Œå¦‚ä½•ä½¿ç”¨ promise å’Œ generator æ¨¡æ‹Ÿå‡º await çš„è¿”å›å€¼å‘¢ï¼Ÿ<br>å¦‚æœç”¨ async&#47;awiat:<br> const res = await ajax(); <br>å˜æˆ yield æ˜¯:<br>  const res = yield ajaxWrap();<br><br>res æ˜¯æ€ä¹ˆç”¨ ajaxWrap é‡Œé¢å‡ºæ¥çš„å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1023333,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9d/65/ef4fc8e1.jpg","nickname":"å’•å½å’•å½","note":"","ucode":"628DE6B1008D3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41074,"discussion_content":"// å‚è€ƒäº†è€å¸ˆç»™çš„æ‹“å±•é˜…è¯»ï¼Œå¯ä»¥è¿™æ ·å®ç°\n\nfunction* ajaxWrap() {\n    yield ajax();\n}\n\nconst res = runner(ajaxWrap)\n\nfunction runner(genFn) {\n    let iter = genFn();\n    function run(arg) {\n        let result = run.next(arg);\n        if (result.done) {\n            return result.value;\n        } else {\n            return Promise.resolve(result.value).then(run);\n        }\n    }\n\n    return run();\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572342091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1235055,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d8/6f/22e5ec55.jpg","nickname":"é›¶ç»´","note":"","ucode":"D783CB1D59D1BE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1023333,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9d/65/ef4fc8e1.jpg","nickname":"å’•å½å’•å½","note":"","ucode":"628DE6B1008D3A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41658,"discussion_content":"ä¸€ç›´å¿½è§†äº†è¿”å›æ˜¯ä¸itr.next(arg)é‡Œçš„argæœ‰å…³ã€‚ã€‚ç°åœ¨æ˜ç™½äº†ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572485078,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":41074,"ip_address":""},"score":41658,"extra":""}]}]},{"had_liked":false,"id":144622,"user_name":"é äººå“å»èµ¢","can_delete":false,"product_type":"c1","uid":1301286,"ip_address":"","ucode":"7A20F9EBE847E1","user_header":"https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg","comment_is_top":false,"comment_ctime":1571983639,"is_pvip":false,"replies":[{"id":"55890","content":"ç”¨å¾—å°‘æ˜¯ä¸€ä¸ªæ–¹é¢ï¼Œæœ¬æ¥ JavaScript å¦‚æœä¹¦å†™çš„æ—¶å€™ä¸æ³¨æ„ç»“æ„å’Œç»„ç»‡çš„è¯ï¼Œç¡®å®å®¹æ˜“å†™å‡ºéš¾æ‡‚çš„ä»£ç ","user_name":"ä½œè€…å›å¤","user_name_real":"å››ç«","uid":"1580075","ctime":1572127437,"ip_address":"","comment_id":144622,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571983639","product_id":100035501,"comment_content":"è¿™ä¸ªpromiseâ€œå¼‚æ­¥â€å˜â€œåŒæ­¥â€ï¼Œå°±æ˜¯è®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä¸€æ ·ï¼Œåˆšçœ‹ç¬¬ä¸€éæ²¡çœ‹æ˜ç™½ï¼Œè¿˜æœ‰å°±æ˜¯ç®­å¤´å‡½æ•°ï¼Œç®­å¤´å¤šäº†ï¼Œæˆ‘å°±ä¸èƒ½ç¬¬ä¸€æ—¶é—´çœ‹æ˜ç™½ï¼Œçœ‹æ¥è¿˜æ˜¯ç”¨å¾—å°‘ã€‚","like_count":0,"discussions":[{"author":{"id":1580075,"avatar":"https://static001.geekbang.org/account/avatar/00/18/1c/2b/2069abe6.jpg","nickname":"å››ç«","note":"","ucode":"E4BED7DCAADD99","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472037,"discussion_content":"ç”¨å¾—å°‘æ˜¯ä¸€ä¸ªæ–¹é¢ï¼Œæœ¬æ¥ JavaScript å¦‚æœä¹¦å†™çš„æ—¶å€™ä¸æ³¨æ„ç»“æ„å’Œç»„ç»‡çš„è¯ï¼Œç¡®å®å®¹æ˜“å†™å‡ºéš¾æ‡‚çš„ä»£ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572127437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143830,"user_name":"tt","can_delete":false,"product_type":"c1","uid":1489957,"ip_address":"","ucode":"7753B79AD5A9AC","user_header":"https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg","comment_is_top":false,"comment_ctime":1571797274,"is_pvip":false,"replies":[{"id":"55657","content":"è¿™ä¸ªé—®é¢˜ä¸å¤ªå¥½å›ç­”ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰è¶³å¤Ÿçš„ç»Ÿè®¡æ•°æ®ã€‚æ®æˆ‘ä¸ªäººçš„ç»å†ï¼ŒPython å¼€å‘æ•ˆç‡ç¡®å®æ˜¯è¦æ¯” Java é«˜å‡ºä¸å°‘","user_name":"ä½œè€…å›å¤","user_name_real":"å››ç«","uid":"1580075","ctime":1571894590,"ip_address":"","comment_id":143830,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571797274","product_id":100035501,"comment_content":"è€å¸ˆï¼ŒJavaScriptå’ŒPythonç¡®å®å¤ªåƒäº†ï¼Œå°¤å…¶æ˜¯å¼‚æ­¥å‡½æ•°ã€ç”Ÿæˆå™¨ä»¥åŠåç¨‹çš„éƒ¨åˆ†ã€‚<br><br>é‚£ä¹ˆï¼Œå¯¹äºå°è§„æ¨¡çš„å›¢é˜Ÿï¼ŒJavaScript+Pythonæˆ–è€…JavaScript+node.jsçš„ç»„åˆæ˜¯ä¸æ˜¯æ¯”JavaScript+javaåœ¨å¼€å‘é€Ÿåº¦ä¸Šæ›´æœ‰ä¼˜åŠ¿å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1580075,"avatar":"https://static001.geekbang.org/account/avatar/00/18/1c/2b/2069abe6.jpg","nickname":"å››ç«","note":"","ucode":"E4BED7DCAADD99","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471713,"discussion_content":"è¿™ä¸ªé—®é¢˜ä¸å¤ªå¥½å›ç­”ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰è¶³å¤Ÿçš„ç»Ÿè®¡æ•°æ®ã€‚æ®æˆ‘ä¸ªäººçš„ç»å†ï¼ŒPython å¼€å‘æ•ˆç‡ç¡®å®æ˜¯è¦æ¯” Java é«˜å‡ºä¸å°‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571894590,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}