{"id":491632,"title":"20 | Flowï¼šä¸ºä»€ä¹ˆè¯´Flowæ˜¯â€œå†·â€çš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ¶›ã€‚ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ Kotlinåç¨‹Flowçš„åŸºç¡€çŸ¥è¯†ã€‚</p><p>Flowï¼Œå¯ä»¥è¯´æ˜¯åœ¨Kotlinåç¨‹å½“ä¸­è‡ªæˆä½“ç³»çš„çŸ¥è¯†ç‚¹ã€‚<strong>Flowæå…¶å¼ºå¤§ã€æå…¶çµæ´»</strong>ï¼Œåœ¨å®ƒå‡ºç°ä¹‹å‰ï¼Œä¸šç•Œè¿˜æœ‰å¾ˆå¤šè´¨ç–‘Kotlinåç¨‹çš„å£°éŸ³ï¼Œè®¤ä¸ºKotlinçš„æŒ‚èµ·å‡½æ•°ã€ç»“æ„åŒ–å¹¶å‘ï¼Œå¹¶ä¸è¶³ä»¥å½¢æˆæ ¸å¿ƒç«äº‰åŠ›ï¼Œåœ¨å¼‚æ­¥ã€å¹¶å‘ä»»åŠ¡çš„é¢†åŸŸï¼ŒRxJavaå¯ä»¥åšå¾—æ›´å¥½ã€‚</p><p>ä½†æ˜¯ï¼Œéšç€2019å¹´Kotlinæ¨å‡ºFlowä»¥åï¼Œè¿™æ ·çš„è´¨ç–‘å£°å°±æ¸æ¸æ²¡æœ‰äº†ã€‚æœ‰äº†Flowä»¥åï¼ŒKotlinçš„åç¨‹å·²ç»æ²¡æœ‰æ˜æ˜¾çš„çŸ­æ¿äº†ã€‚ç®€å•çš„å¼‚æ­¥åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æŒ‚èµ·å‡½æ•°ã€launchã€asyncï¼›è‡³äºå¤æ‚çš„å¼‚æ­¥åœºæ™¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Flowã€‚</p><p>å®é™…ä¸Šï¼Œåœ¨å¾ˆå¤šæŠ€æœ¯é¢†åŸŸï¼ŒFlowå·²ç»å¼€å§‹å é¢†RxJavaåŸæœ¬çš„é¢†åœ°ï¼Œåœ¨Androidé¢†åŸŸï¼ŒFlowç”šè‡³è¿˜è¦å–ä»£åŸæœ¬LiveDataçš„åœ°ä½ã€‚å› ä¸ºï¼ŒFlowæ˜¯çœŸçš„é¦™å•Šï¼</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥å­¦ä¹ Flowã€‚</p><h2>Flowå°±æ˜¯â€œæ•°æ®æµâ€</h2><p>Flowè¿™ä¸ªå•è¯æœ‰â€œæµâ€çš„æ„æ€ï¼Œæ¯”å¦‚Cash Flowä»£è¡¨äº†â€œç°é‡‘æµâ€ï¼›Traffic Flowä»£è¡¨äº†â€œè½¦æµâ€ï¼›Flowåœ¨Kotlinåç¨‹å½“ä¸­ï¼Œå…¶å®å°±æ˜¯â€œæ•°æ®æµâ€çš„æ„æ€ã€‚å› ä¸ºFlowå½“ä¸­â€œæµæ·Œâ€çš„ï¼Œéƒ½æ˜¯æ•°æ®ã€‚</p><p>ä¸ºäº†å¸®ä½ å»ºç«‹æ€ç»´æ¨¡å‹ï¼Œæˆ‘åšäº†ä¸€ä¸ªåŠ¨å›¾ï¼Œæ¥æè¿°Flowçš„è¡Œä¸ºæ¨¡å¼ã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/d3/81/d3138d1386ef7c863086fe9fdcbc0a81.gif?wh=1080x495\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒFlowå’Œæˆ‘ä»¬ä¸ŠèŠ‚è¯¾å­¦ä¹ çš„Channelä¸ä¸€æ ·ï¼ŒFlowå¹¶ä¸æ˜¯åªæœ‰â€œå‘é€â€â€œæ¥æ”¶â€ä¸¤ä¸ªè¡Œä¸ºï¼Œå®ƒå½“ä¸­æµæ·Œçš„æ•°æ®æ˜¯<strong>å¯ä»¥åœ¨ä¸­é€”æ”¹å˜</strong>çš„ã€‚</p><p>Flowçš„æ•°æ®å‘é€æ–¹ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œä¸Šæ¸¸â€ï¼›æ•°æ®æ¥æ”¶æ–¹ç§°ä¹‹ä¸ºâ€œä¸‹æ¸¸â€ã€‚è·Ÿç°å®ç”Ÿæ´»ä¸­ä¸€æ ·ï¼Œä¸Šä¸‹æ¸¸å…¶å®ä¹Ÿæ˜¯ç›¸å¯¹çš„æ¦‚å¿µã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å›¾ï¼Œå¯¹äºä¸­è½¬ç«™2æ¥è¯´ï¼Œä¸­è½¬ç«™1å°±ç›¸å½“äºå®ƒçš„ä¸Šæ¸¸ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ff/31/ffb1b4f8256ae249108d60600947c031.jpg?wh=2000x1125\" alt=\"\"></p><p>å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å‘é€æ–¹ã€æ¥æ”¶æ–¹çš„ä¸­é—´ï¼Œæ˜¯å¯ä»¥æœ‰å¤šä¸ªâ€œä¸­è½¬ç«™â€çš„ã€‚åœ¨è¿™äº›ä¸­è½¬ç«™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œä¸€äº›å¤„ç†äº†ã€‚</p><p>å…¶å®ï¼ŒFlowè¿™æ ·çš„æ•°æ®æ¨¡å‹ï¼Œåœ¨ç°å®ç”Ÿæ´»ä¸­ä¹Ÿå­˜åœ¨ï¼Œæ¯”å¦‚è¯´é•¿æ±Ÿï¼Œå®ƒæœ‰å‘æºåœ°å’Œä¸‹æ¸¸ï¼Œä¸­é—´è¿˜æœ‰å¾ˆå¤šå¤§åã€æ°´ç”µç«™ï¼Œç”šè‡³è¿˜æœ‰ä¸€äº›æ±¡æ°´å‡€åŒ–å‚ã€‚</p><p>å¥½ï¼Œç›¸ä¿¡ä½ ç°åœ¨å¯¹Flowå·²ç»æœ‰æ¯”è¾ƒæ¸…æ™°çš„æ¦‚å¿µäº†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ1\n\nfun main() = runBlocking {\n    flow {                  // ä¸Šæ¸¸ï¼Œå‘æºåœ°\n        emit(1)             // æŒ‚èµ·å‡½æ•°\n        emit(2)\n        emit(3)\n        emit(4)\n        emit(5)\n    }.filter { it &gt; 2 }     // ä¸­è½¬ç«™1\n        .map { it * 2 }     // ä¸­è½¬ç«™2\n        .take(2)            // ä¸­è½¬ç«™3\n        .collect{           // ä¸‹æ¸¸\n            println(it)\n        }\n}\n\n/*\nè¾“å‡ºç»“æœï¼š                       \n6\n8\n*/\n</code></pre><p>å¦‚æœä½ ç»“åˆç€ä¹‹å‰çš„å›¾ç‰‡æ¥åˆ†æè¿™æ®µä»£ç çš„è¯ï¼Œç›¸ä¿¡é©¬ä¸Šå°±èƒ½åˆ†æå‡ºå®ƒçš„æ‰§è¡Œç»“æœã€‚å› ä¸ºFlowçš„è¿™ç§<strong>é“¾å¼è°ƒç”¨</strong>çš„APIï¼Œæœ¬èº«å°±éå¸¸ç¬¦åˆäººçš„é˜…è¯»ä¹ æƒ¯ã€‚</p><p>è€Œä¸”ï¼ŒFlowå†™å‡ºæ¥çš„ä»£ç éå¸¸æ¸…æ™°æ˜“æ‡‚ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ç…§å‰é¢çš„ç¤ºæ„å›¾æ¥çœ‹ä¸€ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a0/f6/a0a912dfffebb66f428d2b8789a914f6.jpg?wh=2000x1125\" alt=\"\"></p><p>è¯´å®è¯ï¼ŒFlowè¿™æ ·ä»£ç æ¨¡å¼ï¼Œè°ä¸çˆ±å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æ¥ç®€å•åˆ†æä¸€ä¸‹ï¼š</p><ul>\n<li><strong>flow{}</strong>ï¼Œæ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„Flowã€‚åœ¨å®ƒçš„Lambdaå½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong>emit()</strong> è¿™ä¸ªæŒ‚èµ·å‡½æ•°å¾€ä¸‹æ¸¸å‘é€æ•°æ®ï¼Œè¿™é‡Œçš„emitå…¶å®å°±æ˜¯â€œå‘å°„â€â€œå‘é€â€çš„æ„æ€ã€‚ä¸Šæ¸¸åˆ›å»ºäº†ä¸€ä¸ªâ€œæ•°æ®æµâ€ï¼ŒåŒæ—¶ä¹Ÿè¦è´Ÿè´£å‘é€æ•°æ®ã€‚è¿™è·Ÿç°å®ç”Ÿæ´»ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼šé•¿æ±Ÿé‡Œçš„æ°´ä»ä¸Šæ¸¸äº§ç”Ÿï¼Œè¿™æ˜¯å¤©ç»åœ°ä¹‰çš„ã€‚æ‰€ä»¥ï¼Œå¯¹äºä¸Šæ¸¸è€Œè¨€ï¼Œåªéœ€è¦åˆ›å»ºFlowï¼Œç„¶åå‘é€æ•°æ®å³å¯ï¼Œå…¶ä»–çš„éƒ½äº¤ç»™ä¸­è½¬ç«™å’Œä¸‹æ¸¸ã€‚</li>\n<li><strong>filter{}ã€map{}ã€take(2)</strong>ï¼Œå®ƒä»¬æ˜¯<strong>ä¸­é—´æ“ä½œç¬¦</strong>ï¼Œå°±åƒä¸­è½¬ç«™ä¸€æ ·ï¼Œå®ƒä»¬çš„ä½œç”¨å°±æ˜¯å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè¿™å¾ˆå¥½ç†è§£ã€‚Flowæœ€å¤§çš„ä¼˜åŠ¿ï¼Œå°±æ˜¯å®ƒçš„æ“ä½œç¬¦è·Ÿé›†åˆæ“ä½œç¬¦é«˜åº¦ä¸€è‡´ã€‚åªè¦ä½ ä¼šç”¨Listã€Sequenceï¼Œé‚£ä½ å°±å¯ä»¥å¿«é€Ÿä¸Šæ‰‹Flowçš„æ“ä½œç¬¦ï¼Œè¿™ä¸­é—´å‡ ä¹æ²¡æœ‰é¢å¤–çš„å­¦ä¹ æˆæœ¬ã€‚</li>\n<li><strong>collect{}</strong>ï¼Œä¹Ÿè¢«ç§°ä¸º<strong>ç»ˆæ­¢æ“ä½œç¬¦</strong>æˆ–è€…<strong>æœ«ç«¯æ“ä½œç¬¦</strong>ï¼Œå®ƒçš„ä½œç”¨å…¶å®åªæœ‰ä¸€ä¸ªï¼šç»ˆæ­¢Flowæ•°æ®æµï¼Œå¹¶ä¸”æ¥æ”¶è¿™äº›æ•°æ®ã€‚</li>\n</ul><p>é™¤äº†ä½¿ç”¨flow{} åˆ›å»ºFlowä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <strong>flowOf()</strong> è¿™ä¸ªå‡½æ•°ã€‚æ‰€ä»¥ï¼Œä»æŸç§ç¨‹åº¦ä¸Šè®²ï¼ŒFlowè·ŸKotlinçš„é›†åˆå…¶å®ä¹Ÿæ˜¯æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„çš„ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ2\n\nfun main() = runBlocking {\n    flowOf(1, 2, 3, 4, 5).filter { it &gt; 2 }\n        .map { it * 2 }\n        .take(2)\n        .collect {\n            println(it)\n        }\n\n    listOf(1, 2, 3, 4, 5).filter { it &gt; 2 }\n        .map { it * 2 }\n        .take(2)\n        .forEach {\n            println(it)\n        }\n}\n\n/*\nè¾“å‡ºç»“æœ\n6\n8\n6\n8\n*/\n</code></pre><p>ä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Flow APIä¸é›†åˆAPIä¹‹é—´çš„å…±æ€§ã€‚listOfåˆ›å»ºListï¼ŒflowOfåˆ›å»ºFlowã€‚éå†Listï¼Œæˆ‘ä»¬ä½¿ç”¨forEach{}ï¼›éå†Flowï¼Œæˆ‘ä»¬ä½¿ç”¨collect{}ã€‚</p><p>åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠFlowå½“åšé›†åˆæ¥ä½¿ç”¨ï¼Œæˆ–è€…åè¿‡æ¥ï¼ŒæŠŠé›†åˆå½“åšFlowæ¥ç”¨ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ3\n\nfun main() = runBlocking {\n    // Flowè½¬List\n    flowOf(1, 2, 3, 4, 5)\n        .toList()\n        .filter { it &gt; 2 }\n        .map { it * 2 }\n        .take(2)\n        .forEach {\n            println(it)\n        }\n\n    // Listè½¬Flow\n    listOf(1, 2, 3, 4, 5)\n        .asFlow()\n        .filter { it &gt; 2 }\n        .map { it * 2 }\n        .take(2)\n        .collect {\n            println(it)\n        }\n}\n\n/*\nè¾“å‡ºç»“æœ\n6\n8\n6\n8\n*/\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Flow.toList()ã€List.asFlow()è¿™ä¸¤ä¸ªæ‰©å±•å‡½æ•°ï¼Œè®©æ•°æ®åœ¨Listã€Flowä¹‹é—´æ¥å›è½¬æ¢ï¼Œè€Œå…¶ä¸­çš„ä»£ç ç”šè‡³ä¸éœ€è¦åšå¤šå°‘æ”¹å˜ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘å…¶å®å·²ç»ç»™ä½ ä»‹ç»äº†ä¸‰ç§åˆ›å»ºFlowçš„æ–¹å¼ï¼Œæˆ‘æ¥å¸®ä½ æ€»ç»“ä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7a/2e/7a0a85927254e66e4847c17de49d052e.jpg?wh=2000x697\" alt=\"\"></p><p>å¥½ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯¹Flowæœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†äº†ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒçš„APIæ€»ä½“åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šä¸Šæ¸¸ã€ä¸­é—´æ“ä½œã€ä¸‹æ¸¸ã€‚å…¶ä¸­å¯¹äºä¸Šæ¸¸æ¥è¯´ï¼Œä¸€èˆ¬æœ‰ä¸‰ç§åˆ›å»ºæ–¹å¼ï¼Œè¿™äº›æˆ‘ä»¬ä¹Ÿéƒ½éœ€è¦å¥½å¥½æŒæ¡ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ä¸­é—´æ“ä½œç¬¦ã€‚</p><h2>ä¸­é—´æ“ä½œç¬¦</h2><p>ä¸­é—´æ“ä½œç¬¦ï¼ˆIntermediate Operatorsï¼‰ï¼Œé™¤äº†ä¹‹å‰æåˆ°çš„mapã€filterã€takeè¿™ç§ä»é›†åˆé‚£è¾¹â€œæŠ„â€æ¥çš„æ“ä½œç¬¦ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„æ“ä½œç¬¦éœ€è¦æˆ‘ä»¬ç‰¹åˆ«æ³¨æ„ã€‚è¿™äº›æ“ä½œç¬¦è·ŸKotliné›†åˆAPIæ˜¯æ²¡å…³ç³»çš„ï¼Œ<strong>å®ƒä»¬æ˜¯ä¸“é—¨ä¸ºFlowè®¾è®¡çš„</strong>ã€‚æˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹ã€‚</p><h3>Flowç”Ÿå‘½å‘¨æœŸ</h3><p>åœ¨Flowçš„ä¸­é—´æ“ä½œç¬¦å½“ä¸­ï¼Œ<strong>onStartã€onCompletion</strong>è¿™ä¸¤ä¸ªæ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ã€‚å®ƒä»¬æ˜¯ä»¥æ“ä½œç¬¦çš„å½¢å¼å­˜åœ¨ï¼Œä½†å®é™…ä¸Šçš„ä½œç”¨ï¼Œæ˜¯ç›‘å¬ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚</p><p>onStartï¼Œå®ƒçš„ä½œç”¨æ˜¯æ³¨å†Œä¸€ä¸ªç›‘å¬äº‹ä»¶ï¼šå½“flowå¯åŠ¨ä»¥åï¼Œå®ƒå°±ä¼šè¢«å›è°ƒã€‚å…·ä½“æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ4\nfun main() = runBlocking {\n    flowOf(1, 2, 3, 4, 5)\n        .filter {\n            println(\"filter: $it\")\n            it &gt; 2\n        }\n        .map {\n            println(\"map: $it\")\n            it * 2\n        }\n        .take(2)\n        .onStart { println(\"onStart\") } // æ³¨æ„è¿™é‡Œ\n        .collect {\n            println(\"collect: $it\")\n        }\n}\n\n/*\nè¾“å‡ºç»“æœ\nonStart\nfilter: 1\nfilter: 2\nfilter: 3\nmap: 3\ncollect: 6\nfilter: 4\nmap: 4\ncollect: 8\n*/\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒonStartçš„æ‰§è¡Œé¡ºåºï¼Œå¹¶ä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§ä¸Šä¸‹æ¸¸æ¥æ‰§è¡Œçš„ã€‚è™½ç„¶onStartçš„ä½ç½®æ˜¯å¤„äºä¸‹æ¸¸ï¼Œè€Œfilterã€mapã€takeæ˜¯ä¸Šæ¸¸ï¼Œä½†onStartæ˜¯æœ€å…ˆæ‰§è¡Œçš„ã€‚å› ä¸ºå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå›è°ƒï¼Œä¸æ˜¯ä¸€ä¸ªæ•°æ®å¤„ç†çš„ä¸­é—´ç«™ã€‚</p><p>ç›¸åº”çš„ï¼Œfilterã€mapã€takeè¿™ç±»æ“ä½œç¬¦ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯è·Ÿå®ƒä»¬çš„ä½ç½®ç›¸å…³çš„ã€‚æœ€ç»ˆçš„æ‰§è¡Œç»“æœï¼Œä¹Ÿä¼šå—åˆ°ä½ç½®å˜åŒ–çš„å½±å“ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ5\nfun main() = runBlocking {\n    flowOf(1, 2, 3, 4, 5)\n        .take(2) // æ³¨æ„è¿™é‡Œ\n        .filter {\n            println(\"filter: $it\")\n            it &gt; 2\n        }\n        .map {\n            println(\"map: $it\")\n            it * 2\n        }\n        .onStart { println(\"onStart\") }\n        .collect {\n            println(\"collect: $it\")\n        }\n}\n/*\nè¾“å‡ºç»“æœ\nonStart\nfilter: 1\nfilter: 2\n*/\n</code></pre><p>å¯è§ï¼Œåœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†take(2)çš„ä½ç½®æŒªåˆ°äº†ä¸Šæ¸¸çš„èµ·å§‹ä½ç½®ï¼Œè¿™æ—¶å€™ç¨‹åºçš„æ‰§è¡Œç»“æœå°±å®Œå…¨å˜äº†ã€‚</p><p>OKï¼Œç†è§£äº†onStartä»¥åï¼ŒonCompletionä¹Ÿå°±å¾ˆå¥½ç†è§£äº†ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ6\nfun main() = runBlocking {\n    flowOf(1, 2, 3, 4, 5)\n        .onCompletion { println(\"onCompletion\") } // æ³¨æ„è¿™é‡Œ\n        .filter {\n            println(\"filter: $it\")\n            it &gt; 2\n        }\n        .take(2)\n        .collect {\n            println(\"collect: $it\")\n        }\n}\n\n/*\nè¾“å‡ºç»“æœ\nfilter: 1\nfilter: 2\nfilter: 3\ncollect: 3\nfilter: 4\ncollect: 4\nonCompletion\n*/\n</code></pre><p>å’ŒonStartç±»ä¼¼ï¼ŒonCompletionçš„æ‰§è¡Œé¡ºåºï¼Œè·Ÿå®ƒåœ¨Flowå½“ä¸­çš„ä½ç½®æ— å…³ã€‚onCompletionåªä¼šåœ¨Flowæ•°æ®æµæ‰§è¡Œå®Œæ¯•ä»¥åï¼Œæ‰ä¼šå›è°ƒã€‚</p><p>è¿˜è®°å¾—åœ¨<a href=\"https://time.geekbang.org/column/article/487930\">ç¬¬16è®²</a>é‡Œï¼Œæˆ‘ä»¬æåˆ°çš„Job.invokeOnCompletion{} è¿™ä¸ªç”Ÿå‘½å‘¨æœŸå›è°ƒå—ï¼Ÿåœ¨è¿™é‡Œï¼ŒFlow.onCompletion{} ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼ŒonCompletion{} åœ¨é¢å¯¹ä»¥ä¸‹ä¸‰ç§æƒ…å†µæ—¶éƒ½ä¼šè¿›è¡Œå›è°ƒï¼š</p><ul>\n<li>æƒ…å†µ1ï¼ŒFlowæ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼›</li>\n<li>æƒ…å†µ2ï¼ŒFlowå½“ä¸­å‡ºç°å¼‚å¸¸ï¼›</li>\n<li>æƒ…å†µ3ï¼ŒFlowè¢«å–æ¶ˆã€‚</li>\n</ul><p>å¯¹äºæƒ…å†µ1ï¼Œæˆ‘ä»¬å·²ç»åœ¨ä¸Šé¢çš„ä»£ç ä¸­éªŒè¯è¿‡äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹åé¢ä¸¤ç§æƒ…å†µï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ7\nfun main() = runBlocking {\n    launch {\n        flow {\n            emit(1)\n            emit(2)\n            emit(3)\n        }.onCompletion { println(\"onCompletion first: $it\") }\n            .collect {\n                println(\"collect: $it\")\n                if (it == 2) {\n                    cancel()            // 1\n                    println(\"cancel\")\n                }\n            }\n    }\n\n    delay(100L)\n\n    flowOf(4, 5, 6)\n        .onCompletion { println(\"onCompletion second: $it\") }\n        .collect {\n            println(\"collect: $it\")\n            // ä»…ç”¨äºæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒä¸åº”è¯¥è¿™ä¹ˆåˆ›å»ºå¼‚å¸¸\n            throw IllegalStateException() // 2\n        }\n}\n\n/*\ncollect: 1\ncollect: 2\ncancel\nonCompletion first: JobCancellationException: // 3\ncollect: 4\nonCompletion second: IllegalStateException    // 4\n*/\n</code></pre><p>åœ¨ä¸Šé¢çš„æ³¨é‡Š1å½“ä¸­ï¼Œæˆ‘ä»¬åœ¨collect{} é‡Œè°ƒç”¨äº†cancelæ–¹æ³•ï¼Œè¿™ä¼šå–æ¶ˆæ‰æ•´ä¸ªFlowï¼Œè¿™æ—¶å€™ï¼Œflow{} å½“ä¸­å‰©ä¸‹çš„ä»£ç å°†ä¸ä¼šå†è¢«æ‰§è¡Œã€‚æœ€åï¼ŒonCompletionä¹Ÿä¼šè¢«è°ƒç”¨ï¼ŒåŒæ—¶ï¼Œè¯·ä½ ç•™æ„æ³¨é‡Š3ï¼Œè¿™é‡Œè¿˜ä¼šå¸¦ä¸Šå¯¹åº”çš„å¼‚å¸¸ä¿¡æ¯JobCancellationExceptionã€‚</p><p>åŒæ ·çš„ï¼Œæ ¹æ®æ³¨é‡Š2ã€4ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½åˆ†æå‡ºä¸€æ ·çš„ç»“æœã€‚</p><p>è€Œä¸”ä»ä¸Šé¢çš„ä»£ç é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå½“Flowå½“ä¸­å‘ç”Ÿå¼‚å¸¸ä»¥åï¼ŒFlowå°±ä¼šç»ˆæ­¢ã€‚é‚£ä¹ˆå¯¹äºè¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p><p>ä¸‹é¢æˆ‘å°±å¸¦ä½ æ¥çœ‹çœ‹ï¼ŒFlowå½“ä¸­å¦‚ä½•å¤„ç†å¼‚å¸¸ã€‚</p><h3>catchå¼‚å¸¸å¤„ç†</h3><p>å‰é¢æˆ‘å·²ç»ä»‹ç»è¿‡ï¼ŒFlowä¸»è¦æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼šä¸Šæ¸¸ã€ä¸­é—´æ“ä½œã€ä¸‹æ¸¸ã€‚é‚£ä¹ˆï¼ŒFlowå½“ä¸­çš„å¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è¿™ä¸ªæ ‡å‡†æ¥è¿›è¡Œåˆ†ç±»ï¼Œä¹Ÿå°±æ˜¯å¼‚å¸¸å‘ç”Ÿçš„ä½ç½®ã€‚</p><p>å¯¹äºå‘ç”Ÿåœ¨ä¸Šæ¸¸ã€ä¸­é—´æ“ä½œè¿™ä¸¤ä¸ªé˜¶æ®µçš„å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <strong>catch</strong> è¿™ä¸ªæ“ä½œç¬¦æ¥è¿›è¡Œæ•è·å’Œè¿›ä¸€æ­¥å¤„ç†ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ8\nfun main() = runBlocking {\n    val flow = flow {\n        emit(1)\n        emit(2)\n        throw IllegalStateException()\n        emit(3)\n    }\n\n    flow.map { it * 2 }\n        .catch { println(\"catch: $it\") } // æ³¨æ„è¿™é‡Œ\n        .collect {\n            println(it)\n        }\n}\n/*\nè¾“å‡ºç»“æœï¼š\n2\n4\ncatch: java.lang.IllegalStateException\n*/\n</code></pre><p>æ‰€ä»¥ï¼Œcatchè¿™ä¸ªæ“ä½œç¬¦ï¼Œå…¶å®å°±ç›¸å½“äºæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„try-catchçš„æ„æ€ã€‚åªæ˜¯è¯´ï¼Œåè€…æ˜¯ç”¨äºæ™®é€šçš„ä»£ç ï¼Œè€Œå‰è€…æ˜¯ç”¨äºFlowæ•°æ®æµçš„ï¼Œä¸¤è€…çš„æ ¸å¿ƒç†å¿µæ˜¯ä¸€æ ·çš„ã€‚ä¸è¿‡ï¼Œè€ƒè™‘åˆ°Flowå…·æœ‰ä¸Šä¸‹æ¸¸çš„ç‰¹æ€§ï¼Œcatchè¿™ä¸ªæ“ä½œç¬¦çš„ä½œç”¨æ˜¯<strong>å’Œå®ƒçš„ä½ç½®å¼ºç›¸å…³</strong>çš„ã€‚</p><p><strong>catchçš„ä½œç”¨åŸŸï¼Œä»…é™äºcatchçš„ä¸Šæ¸¸ã€‚</strong>æ¢å¥è¯è¯´ï¼Œå‘ç”Ÿåœ¨catchä¸Šæ¸¸çš„å¼‚å¸¸ï¼Œæ‰ä¼šè¢«æ•è·ï¼Œå‘ç”Ÿåœ¨catchä¸‹æ¸¸çš„å¼‚å¸¸ï¼Œåˆ™ä¸ä¼šè¢«æ•è·ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¢ä¸€ä¸ªå†™æ³•ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ9\nfun main() = runBlocking {\n    val flow = flow {\n        emit(1)\n        emit(2)\n        emit(3)\n    }\n\n    flow.map { it * 2 }\n        .catch { println(\"catch: $it\") }\n        .filter { it / 0 &gt; 1}  // æ•…æ„åˆ¶é€ å¼‚å¸¸\n        .collect {\n            println(it)\n        }\n}\n\n/*\nè¾“å‡ºç»“æœ\nException in thread \"main\" ArithmeticException: / by zero\n*/\n</code></pre><p>ä»ä¸Šé¢ä»£ç çš„æ‰§è¡Œç»“æœé‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œcatchå¯¹äºå‘ç”Ÿåœ¨å®ƒä¸‹æ¸¸çš„å¼‚å¸¸æ˜¯æ— èƒ½ä¸ºåŠ›çš„ã€‚è¿™ä¸€ç‚¹ï¼Œå€ŸåŠ©æˆ‘ä»¬ä¹‹å‰çš„æ€ç»´æ¨¡å‹æ¥æ€è€ƒï¼Œä¹Ÿæ˜¯éå¸¸ç¬¦åˆç›´è§‰çš„ã€‚æ¯”å¦‚è¯´ï¼Œé•¿æ±Ÿä¸Šé¢çš„æ±¡æ°´å¤„ç†å‚ï¼Œå½“ç„¶åªèƒ½å¤„ç†å®ƒä¸Šæ¸¸çš„æ°´ï¼Œè€Œå¯¹äºå‘ç”Ÿåœ¨ä¸‹æ¸¸çš„æ±¡æŸ“ï¼Œæ˜¯æ— èƒ½ä¸ºåŠ›çš„ã€‚</p><p>é‚£ä¹ˆï¼Œå‘ç”Ÿåœ¨ä¸Šæ¸¸æºå¤´ï¼Œè¿˜æœ‰å‘ç”Ÿåœ¨ä¸­é—´æ“ä½œçš„å¼‚å¸¸ï¼Œå¤„ç†èµ·æ¥å…¶å®å¾ˆå®¹æ˜“ï¼Œæˆ‘ä»¬åªéœ€è¦ç•™æ„catchçš„ä½œç”¨åŸŸå³å¯ã€‚æœ€åå°±æ˜¯å‘ç”Ÿåœ¨ä¸‹æ¸¸æœ«å°¾å¤„çš„å¼‚å¸¸äº†ã€‚</p><p>å¦‚æœä½ å›è¿‡å¤´å»çœ‹ä»£ç æ®µ7å½“ä¸­çš„å¼‚å¸¸ï¼Œä¼šå‘ç°å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå…¸å‹çš„â€œå‘ç”Ÿåœ¨ä¸‹æ¸¸çš„å¼‚å¸¸â€ï¼Œæ‰€ä»¥å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°±ä¸èƒ½ç”¨catchæ“ä½œç¬¦äº†ã€‚é‚£ä¹ˆæœ€ç®€å•çš„åŠæ³•ï¼Œå…¶å®æ˜¯ä½¿ç”¨ <strong>try-catch</strong>ï¼ŒæŠŠcollect{} å½“ä¸­å¯èƒ½å‡ºç°é—®é¢˜çš„ä»£ç åŒ…è£¹èµ·æ¥ã€‚æ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ10\n\nfun main() = runBlocking {\n    flowOf(4, 5, 6)\n        .onCompletion { println(\"onCompletion second: $it\") }\n        .collect {\n            try {\n                println(\"collect: $it\")\n                throw IllegalStateException()\n            } catch (e: Exception) {\n                println(\"Catch $e\")\n            }\n        }\n}\n</code></pre><p>æ‰€ä»¥ï¼Œé’ˆå¯¹Flowå½“ä¸­çš„å¼‚å¸¸å¤„ç†ï¼Œæˆ‘ä»¬ä¸»è¦æœ‰ä¸¤ç§æ‰‹æ®µï¼šä¸€ä¸ªæ˜¯catchæ“ä½œç¬¦ï¼Œå®ƒä¸»è¦ç”¨äºä¸Šæ¸¸å¼‚å¸¸çš„æ•è·ï¼›è€Œtry-catchè¿™ç§ä¼ ç»Ÿçš„æ–¹å¼ï¼Œæ›´å¤šçš„æ˜¯åº”ç”¨äºä¸‹æ¸¸å¼‚å¸¸çš„æ•è·ã€‚</p><blockquote>\n<p>æç¤ºï¼šå…³äºæ›´å¤šåç¨‹å¼‚å¸¸å¤„ç†çš„è¯é¢˜ï¼Œæˆ‘ä»¬ä¼šåœ¨ç¬¬23è®²æ·±å…¥ä»‹ç»ã€‚</p>\n</blockquote><h3>åˆ‡æ¢Contextï¼šflowOnã€launchIn</h3><p>å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ï¼ŒFlowéå¸¸é€‚åˆå¤æ‚çš„å¼‚æ­¥ä»»åŠ¡ã€‚åœ¨å¤§éƒ¨åˆ†çš„å¼‚æ­¥ä»»åŠ¡å½“ä¸­ï¼Œæˆ‘ä»¬éƒ½éœ€è¦é¢‘ç¹åˆ‡æ¢å·¥ä½œçš„çº¿ç¨‹ã€‚å¯¹äºè€—æ—¶ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦çº¿ç¨‹æ± å½“ä¸­æ‰§è¡Œï¼Œå¯¹äºUIä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œã€‚</p><p>è€Œåœ¨Flowå½“ä¸­ï¼Œæˆ‘ä»¬å€ŸåŠ© <strong>flowOn</strong> è¿™ä¸€ä¸ªæ“ä½œç¬¦ï¼Œå°±å¯ä»¥çµæ´»å®ç°ä»¥ä¸Šçš„éœ€æ±‚ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ11\nfun main() = runBlocking {\n    val flow = flow {\n        logX(\"Start\")\n        emit(1)\n        logX(\"Emit: 1\")\n        emit(2)\n        logX(\"Emit: 2\")\n        emit(3)\n        logX(\"Emit: 3\")\n    }\n\n    flow.filter {\n            logX(\"Filter: $it\")\n            it &gt; 2\n        }\n        .flowOn(Dispatchers.IO)  // æ³¨æ„è¿™é‡Œ\n        .collect {\n            logX(\"Collect $it\")\n        }\n}\n\n/*\nè¾“å‡ºç»“æœ\n================================\nStart\nThread:DefaultDispatcher-worker-1 @coroutine#2\n================================\n================================\nFilter: 1\nThread:DefaultDispatcher-worker-1 @coroutine#2\n================================\n================================\nEmit: 1\nThread:DefaultDispatcher-worker-1 @coroutine#2\n================================\n================================\nFilter: 2\nThread:DefaultDispatcher-worker-1 @coroutine#2\n================================\n================================\nEmit: 2\nThread:DefaultDispatcher-worker-1 @coroutine#2\n================================\n================================\nFilter: 3\nThread:DefaultDispatcher-worker-1 @coroutine#2\n================================\n================================\nEmit: 3\nThread:DefaultDispatcher-worker-1 @coroutine#2\n================================\n================================\nCollect 3\nThread:main @coroutine#1\n================================\n</code></pre><p>flowOnæ“ä½œç¬¦ä¹Ÿæ˜¯å’Œå®ƒçš„ä½ç½®å¼ºç›¸å…³çš„ã€‚å®ƒçš„ä½œç”¨åŸŸè·Ÿå‰é¢çš„catchç±»ä¼¼ï¼š<strong>flowOnä»…é™äºå®ƒçš„ä¸Šæ¸¸ã€‚</strong></p><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒflowOnçš„ä¸Šæ¸¸ï¼Œå°±æ˜¯flow{}ã€filter{} å½“ä¸­çš„ä»£ç ï¼Œæ‰€ä»¥ï¼Œå®ƒä»¬çš„ä»£ç å…¨éƒ½è¿è¡Œåœ¨DefaultDispatcherè¿™ä¸ªçº¿ç¨‹æ± å½“ä¸­ã€‚åªæœ‰collect{} å½“ä¸­çš„ä»£ç æ˜¯è¿è¡Œåœ¨mainçº¿ç¨‹å½“ä¸­çš„ã€‚</p><p>å¯¹åº”çš„ï¼Œå¦‚æœä½ æŒªåŠ¨ä¸€ä¸‹ä¸Šé¢ä»£ç ä¸­flowOnçš„ä½ç½®ï¼Œä¼šå‘ç°æ‰§è¡Œç»“æœå°±ä¼šä¸ä¸€æ ·ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ12\nflow.flowOn(Dispatchers.IO) // æ³¨æ„è¿™é‡Œ\n    .filter {\n        logX(\"Filter: $it\")\n        it &gt; 2\n    }\n    .collect {\n        logX(\"Collect $it\")\n    }\n/*\nè¾“å‡ºç»“æœï¼š\nfilterå½“ä¸­çš„ä»£ç ä¼šæ‰§è¡Œåœ¨mainçº¿ç¨‹\n*/\n</code></pre><p>è¿™é‡Œçš„ä»£ç æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½æ¨æµ‹å‡ºæ¥ï¼Œå› ä¸ºflowOnçš„ä½œç”¨åŸŸä»…é™äºä¸Šæ¸¸ï¼Œæ‰€ä»¥å®ƒåªä¼šè®©flow{} å½“ä¸­çš„ä»£ç è¿è¡Œåœ¨DefaultDispatcherå½“ä¸­ï¼Œå‰©ä¸‹çš„ä»£ç åˆ™æ‰§è¡Œåœ¨mainçº¿ç¨‹ã€‚</p><p>ä½†æ˜¯åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°ä¸€ä¸ªç±»ä¼¼catchçš„å›°å¢ƒï¼šå¦‚æœæƒ³è¦æŒ‡å®šcollectå½“ä¸­çš„Contextï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬èƒ½æƒ³åˆ°çš„æœ€ç®€å•çš„åŠæ³•ï¼Œå°±æ˜¯ç”¨å‰é¢å­¦è¿‡çš„ï¼š<strong>withContext{}</strong>ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ13\n\n// ä¸æ¨è\nflow.flowOn(Dispatchers.IO)\n    .filter {\n        logX(\"Filter: $it\")\n        it &gt; 2\n    }\n    .collect {\n        withContext(mySingleDispatcher) {\n            logX(\"Collect $it\")\n        }\n    }\n/*\nè¾“å‡ºç»“æœï¼š\ncollect{}å°†è¿è¡Œåœ¨MySingleThread\nfilter{}è¿è¡Œåœ¨main\nflow{}è¿è¡Œåœ¨DefaultDispatcher\n*/\n</code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨collect{} é‡Œä½¿ç”¨äº†withContext{}ï¼Œæ‰€ä»¥å®ƒçš„æ‰§è¡Œå°±äº¤ç»™äº†MySingleThreadã€‚ä¸è¿‡ï¼Œæœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³è¦æ”¹å˜é™¤äº†flowOnä»¥å¤–æ‰€æœ‰ä»£ç çš„Contextã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›collect{}ã€filter{} éƒ½è¿è¡Œåœ¨MySingleThreadã€‚</p><p>é‚£ä¹ˆè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨withContext{} <strong>è¿›ä¸€æ­¥æ‰©å¤§åŒ…è£¹çš„èŒƒå›´</strong>ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ14\n\n// ä¸æ¨è\nwithContext(mySingleDispatcher) {\n    flow.flowOn(Dispatchers.IO)\n        .filter {\n            logX(\"Filter: $it\")\n            it &gt; 2\n        }\n        .collect{\n            logX(\"Collect $it\")\n        }\n}\n\n/*\nè¾“å‡ºç»“æœï¼š\ncollect{}å°†è¿è¡Œåœ¨MySingleThread\nfilter{}è¿è¡Œåœ¨MySingleThread\nflow{}è¿è¡Œåœ¨DefaultDispatcher\n*/\n</code></pre><p>ä¸è¿‡ï¼Œè¿™ç§å†™æ³•ç»ˆå½’æ˜¯æœ‰äº›ä¸‘é™‹ï¼Œå› æ­¤ï¼ŒKotlinå®˜æ–¹è¿˜ä¸ºæˆ‘ä»¬æä¾›äº†å¦ä¸€ä¸ªæ“ä½œç¬¦ï¼Œ<strong>launchIn</strong>ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ“ä½œç¬¦æ˜¯æ€ä¹ˆç”¨çš„ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ15\nval scope = CoroutineScope(mySingleDispatcher)\nflow.flowOn(Dispatchers.IO)\n    .filter {\n        logX(\"Filter: $it\")\n        it &gt; 2\n    }\n    .onEach {\n        logX(\"onEach $it\")\n    }\n    .launchIn(scope)\n\n/*\nè¾“å‡ºç»“æœï¼š\nonEach{}å°†è¿è¡Œåœ¨MySingleThread\nfilter{}è¿è¡Œåœ¨MySingleThread\nflow{}è¿è¡Œåœ¨DefaultDispatcher\n*/\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸å†ç›´æ¥ä½¿ç”¨collect{}ï¼Œè€Œæ˜¯å€ŸåŠ©äº†onEach{} æ¥å®ç°ç±»ä¼¼collect{} çš„åŠŸèƒ½ã€‚åŒæ—¶æˆ‘ä»¬åœ¨æœ€åä½¿ç”¨äº†launchIn(scope)ï¼ŒæŠŠå®ƒä¸Šæ¸¸çš„ä»£ç éƒ½åˆ†å‘åˆ°æŒ‡å®šçš„çº¿ç¨‹å½“ä¸­ã€‚</p><p>å¦‚æœä½ å»çœ‹launchInçš„æºä»£ç çš„è¯ï¼Œä½ ä¼šå‘ç°å®ƒçš„å®šä¹‰æå…¶ç®€å•ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ16\npublic fun &lt;T&gt; Flow&lt;T&gt;.launchIn(scope: CoroutineScope): Job = scope.launch {\n    collect() // tail-call\n}\n</code></pre><p>ç”±æ­¤å¯è§ï¼ŒlaunchInä»ä¸¥æ ¼æ„ä¹‰æ¥è®²ï¼Œåº”è¯¥ç®—æ˜¯ä¸€ä¸ªä¸‹æ¸¸çš„ç»ˆæ­¢æ“ä½œç¬¦ï¼Œå› ä¸ºå®ƒæœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº†collect()ã€‚</p><p>å› æ­¤ï¼Œä¸Šé¢çš„ä»£ç æ®µ16ï¼Œä¹Ÿä¼šç­‰ä»·äºä¸‹é¢çš„å†™æ³•ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ17\nfun main() = runBlocking {\n    val scope = CoroutineScope(mySingleDispatcher)\n    val flow = flow {\n        logX(\"Start\")\n        emit(1)\n        logX(\"Emit: 1\")\n        emit(2)\n        logX(\"Emit: 2\")\n        emit(3)\n        logX(\"Emit: 3\")\n    }\n        .flowOn(Dispatchers.IO)\n        .filter {\n            logX(\"Filter: $it\")\n            it &gt; 2\n        }\n        .onEach {\n            logX(\"onEach $it\")\n        }\n        \n    scope.launch { // æ³¨æ„è¿™é‡Œ\n        flow.collect()\n    }\n    \n    delay(100L)\n}\n</code></pre><p>æ‰€ä»¥ï¼Œæ€»çš„æ¥è¯´ï¼Œå¯¹äºFlowå½“ä¸­çš„çº¿ç¨‹åˆ‡æ¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨flowOnã€launchInã€withContextï¼Œä½†å…¶å®ï¼ŒflowOnã€launchInå°±å·²ç»å¯ä»¥æ»¡è¶³éœ€æ±‚äº†ã€‚</p><p>å¦å¤–ï¼Œç”±äºFlowå½“ä¸­ç›´æ¥ä½¿ç”¨withContextæ˜¯å¾ˆå®¹æ˜“å¼•å‘å…¶ä»–é—®é¢˜çš„ï¼Œå› æ­¤ï¼Œ<strong>withContextåœ¨Flowå½“ä¸­æ˜¯ä¸è¢«æ¨èçš„ï¼Œå³ä½¿è¦ç”¨ï¼Œä¹Ÿåº”è¯¥è°¨æ…å†è°¨æ…</strong>ã€‚</p><blockquote>\n<p>æç¤ºï¼šé’ˆå¯¹Flowå½“ä¸­withContextå¼•å‘çš„é—®é¢˜ï¼Œæˆ‘ä¼šåœ¨è¿™èŠ‚è¯¾çš„æ€è€ƒé¢˜é‡Œç»™å‡ºå…·ä½“æ¡ˆä¾‹ã€‚</p>\n</blockquote><h2>ä¸‹æ¸¸ï¼šç»ˆæ­¢æ“ä½œç¬¦</h2><p>æœ€åï¼Œæˆ‘ä»¬å°±åˆ°äº†ä¸‹æ¸¸é˜¶æ®µï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç»ˆæ­¢æ“ä½œç¬¦ï¼ˆTerminal Operatorsï¼‰çš„å«ä¹‰å’Œä½¿ç”¨ã€‚</p><blockquote>\n<p>è¿™é‡Œçš„Terminalï¼Œå…¶å®æœ‰ç»ˆæ­¢ã€æœ«å°¾ã€ç»ˆç‚¹çš„æ„æ€ã€‚</p>\n</blockquote><p>åœ¨Flowå½“ä¸­ï¼Œç»ˆæ­¢æ“ä½œç¬¦çš„æ„æ€å°±æ˜¯ç»ˆæ­¢æ•´ä¸ªFlowæµç¨‹çš„æ“ä½œç¬¦ã€‚è¿™é‡Œçš„â€œç»ˆæ­¢â€ï¼Œå…¶å®æ˜¯è·Ÿå‰é¢çš„â€œä¸­é—´â€æ“ä½œç¬¦å¯¹åº”çš„ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åœ¨filteræ“ä½œç¬¦çš„åé¢ï¼Œè¿˜å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–çš„æ“ä½œç¬¦ï¼Œæ¯”å¦‚è¯´mapï¼Œå› ä¸ºfilteræœ¬èº«å°±æ˜¯ä¸€ä¸ªâ€œä¸­é—´â€æ“ä½œç¬¦ã€‚ä½†æ˜¯ï¼Œcollectæ“ä½œç¬¦ä¹‹åï¼Œæˆ‘ä»¬æ— æ³•ç»§ç»­ä½¿ç”¨mapä¹‹ç±»çš„æ“ä½œï¼Œå› ä¸ºcollectæ˜¯ä¸€ä¸ªâ€œç»ˆæ­¢â€æ“ä½œç¬¦ï¼Œä»£è¡¨Flowæ•°æ®æµçš„ç»ˆæ­¢ã€‚</p><p>Flowé‡Œé¢ï¼Œæœ€å¸¸è§çš„ç»ˆæ­¢æ“ä½œç¬¦å°±æ˜¯collectã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä»é›†åˆå½“ä¸­â€œæŠ„â€è¿‡æ¥çš„æ“ä½œç¬¦ï¼Œä¹Ÿæ˜¯Flowçš„ç»ˆæ­¢æ“ä½œç¬¦ã€‚æ¯”å¦‚first()ã€single()ã€fold{}ã€reduce{}ã€‚</p><p>å¦å¤–ï¼Œå½“æˆ‘ä»¬å°è¯•å°†Flowè½¬æ¢æˆé›†åˆçš„æ—¶å€™ï¼Œå®ƒæœ¬èº«ä¹Ÿå°±æ„å‘³ç€Flowæ•°æ®æµçš„ç»ˆæ­¢ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å‰é¢ç”¨è¿‡çš„toListï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ18\nfun main() = runBlocking {\n    // Flowè½¬List\n    flowOf(1, 2, 3, 4, 5)\n        .toList()           // æ³¨æ„è¿™é‡Œ\n        .filter { it &gt; 2 }\n        .map { it * 2 }\n        .take(2)\n        .forEach {\n            println(it)\n        }\n}\n</code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå½“æˆ‘ä»¬è°ƒç”¨äº†toList()ä»¥åï¼Œå¾€åæ‰€æœ‰çš„æ“ä½œç¬¦ï¼Œéƒ½ä¸å†æ˜¯Flowçš„APIè°ƒç”¨äº†ï¼Œè™½ç„¶å®ƒä»¬çš„åå­—æ²¡æœ‰å˜ï¼Œfilterã€mapï¼Œè¿™äº›éƒ½åªæ˜¯é›†åˆçš„APIã€‚æ‰€ä»¥ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šè®²ï¼ŒtoListä¹Ÿç®—æ˜¯ä¸€ä¸ªç»ˆæ­¢æ“ä½œç¬¦ã€‚</p><h2>ä¸ºä»€ä¹ˆè¯´Flowæ˜¯â€œå†·â€çš„ï¼Ÿ</h2><p>ç°åœ¨æˆ‘ä»¬å°±ç®—æ˜¯æŠŠFlowè¿™ä¸ªAPIç»™ææ¸…æ¥šäº†ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªç–‘é—®æˆ‘ä»¬æ²¡è§£å†³ï¼Œå°±æ˜¯è¿™èŠ‚è¯¾çš„æ ‡é¢˜ï¼šä¸ºä»€ä¹ˆè¯´Flowæ˜¯â€œå†·â€çš„ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œå¦‚æœä½ ç†è§£äº†ä¸ŠèŠ‚è¯¾Channelä¸ºä»€ä¹ˆæ˜¯â€œçƒ­â€çš„ï¼Œé‚£ä½ å°±ä¸€å®šå¯ä»¥ç†è§£Flowä¸ºä»€ä¹ˆæ˜¯â€œå†·â€çš„ã€‚æˆ‘ä»¬å¯ä»¥æ¨¡ä»¿ä¸ŠèŠ‚è¯¾çš„Channelä»£ç ï¼Œå†™ä¸€æ®µFlowçš„ä»£ç ï¼Œä¸¤ç›¸å¯¹æ¯”ä¹‹ä¸‹å…¶å®é©¬ä¸Šå°±èƒ½å‘ç°å®ƒä»¬ä¹‹é—´çš„å·®å¼‚äº†ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ19\n\nfun main() = runBlocking {\n    // å†·æ•°æ®æµ\n    val flow = flow {\n        (1..3).forEach {\n            println(\"Before send $it\")\n            emit(it)\n            println(\"Send $it\")\n        }\n    }\n\n    // çƒ­æ•°æ®æµ\n    val channel = produce&lt;Int&gt;(capacity = 0) {\n        (1..3).forEach {\n            println(\"Before send $it\")\n            send(it)\n            println(\"Send $it\")\n        }\n    }\n\n    println(\"end\")\n}\n\n/*\nè¾“å‡ºç»“æœï¼š\nend\nBefore send 1\n// Flow å½“ä¸­çš„ä»£ç å¹¶æœªæ‰§è¡Œ\n*/\n</code></pre><p>æˆ‘ä»¬çŸ¥é“ï¼ŒChannelä¹‹æ‰€ä»¥è¢«è®¤ä¸ºæ˜¯â€œçƒ­â€çš„åŸå› ï¼Œæ˜¯å› ä¸º<strong>ä¸ç®¡æœ‰æ²¡æœ‰æ¥æ”¶æ–¹ï¼Œå‘é€æ–¹éƒ½ä¼šå·¥ä½œ</strong>ã€‚é‚£ä¹ˆå¯¹åº”çš„ï¼ŒFlowè¢«è®¤ä¸ºæ˜¯â€œå†·â€çš„åŸå› ï¼Œå°±æ˜¯å› ä¸º<strong>åªæœ‰è°ƒç”¨ç»ˆæ­¢æ“ä½œç¬¦ä¹‹åï¼ŒFlowæ‰ä¼šå¼€å§‹å·¥ä½œã€‚</strong></p><h3>Flow è¿˜æ˜¯â€œæ‡’â€çš„</h3><p>å…¶å®ï¼Œå¦‚æœä½ å»ä»”ç»†è°ƒè¯•è¿‡ä»£ç æ®µ1çš„è¯ï¼Œåº”è¯¥å°±å·²ç»å‘ç°äº†ï¼ŒFlowä¸ä»…æ˜¯â€œå†·â€çš„ï¼Œå®ƒè¿˜æ˜¯â€œæ‡’â€çš„ã€‚ä¸ºäº†æš´éœ²å‡ºå®ƒçš„è¿™ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬ç¨å¾®æ”¹é€ ä¸€ä¸‹ä»£ç æ®µ1ï¼Œç„¶ååŠ ä¸€äº›æ—¥å¿—è¿›æ¥ã€‚</p><pre><code class=\"language-plain\">// ä»£ç æ®µ20\n\nfun main() = runBlocking {\n    flow {\n        println(\"emit: 3\")\n        emit(3)\n        println(\"emit: 4\")\n        emit(4)\n        println(\"emit: 5\")\n        emit(5)\n    }.filter {\n        println(\"filter: $it\")\n        it &gt; 2\n    }.map {\n        println(\"map: $it\")\n        it * 2\n    }.collect {\n        println(\"collect: $it\")\n    }\n}\n/*\nè¾“å‡ºç»“æœï¼š\nemit: 3\nfilter: 3\nmap: 3\ncollect: 6\nemit: 4\nfilter: 4\nmap: 4\ncollect: 8\nemit: 5\nfilter: 5\nmap: 5\ncollect: 10\n*/\n</code></pre><p>é€šè¿‡ä¸Šé¢çš„è¿è¡Œç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒFlowä¸€æ¬¡åªä¼šå¤„ç†ä¸€æ¡æ•°æ®ã€‚è™½ç„¶å®ƒä¹Ÿæ˜¯Flowâ€œå†·â€çš„ä¸€ç§è¡¨ç°ï¼Œä½†è¿™ä¸ªç‰¹æ€§å‡†ç¡®æ¥è¯´æ˜¯â€œæ‡’â€ã€‚</p><p>å¦‚æœä½ ç»“åˆä¸ŠèŠ‚è¯¾â€œæœåŠ¡å‘˜ç«¯èŒ¶é€æ°´â€çš„åœºæ™¯æ¥æ€è€ƒçš„è¯ï¼ŒFlowä¸ä»…æ˜¯ä¸€ä¸ªâ€œå†·æ·¡â€çš„æœåŠ¡å‘˜ï¼Œè¿˜æ˜¯ä¸€ä¸ªâ€œæ‡’æƒ°â€çš„æœåŠ¡å‘˜ï¼šæ˜æ˜é¥­æ¡Œä¸Šæœ‰3ä¸ªäººéœ€è¦å–æ°´ï¼Œä½†æœåŠ¡å‘˜ååä¸ä¸€æ¬¡æ€§ä¸Š3æ¯æ°´ï¼Œè€Œæ˜¯è¦è¿™3ä¸ªäººï¼Œæ¯ä¸ªäººéƒ½å«æœåŠ¡å‘˜ä¸€æ¬¡ï¼ŒæœåŠ¡å‘˜æ‰ä¼šä¸€æ¯ä¸€æ¯åœ°é€3æ¯æ°´è¿‡æ¥ã€‚</p><p>å¯¹æ¯”Channelçš„æ€ç»´æ¨¡å‹æ¥çœ‹çš„è¯ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/4a/59/4aaae2c6b5e14c7ae938b630d2794e59.jpg?wh=2000x762\" alt=\"\"></p><blockquote>\n<p>æç¤ºï¼šFlowé»˜è®¤æƒ…å†µä¸‹æ˜¯â€œæ‡’æƒ°â€çš„ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®è®©å®ƒâ€œå‹¤å¿«â€èµ·æ¥ã€‚</p>\n</blockquote><h2>æ€è€ƒä¸å®æˆ˜</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒFlowéå¸¸é€‚åˆå¤æ‚çš„å¼‚æ­¥ä»»åŠ¡åœºæ™¯ã€‚å€ŸåŠ©å®ƒçš„flowOnã€launchInï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºéå¸¸çµæ´»çš„ä»£ç ã€‚æ¯”å¦‚è¯´ï¼Œåœ¨Androidã€Swingä¹‹ç±»çš„UIå¹³å°ä¹‹ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ21\n\nfun main() = runBlocking {\n    fun loadData() = flow {\n        repeat(3){\n            delay(100L)\n            emit(it)\n            logX(\"emit $it\")\n        }\n    }\n\n    // æ¨¡æ‹ŸAndroidã€Swingçš„UI\n    val uiScope = CoroutineScope(mySingleDispatcher)\n\n    loadData()\n        .map { it * 2 }\n        .flowOn(Dispatchers.IO) // 1ï¼Œè€—æ—¶ä»»åŠ¡\n        .onEach {\n            logX(\"onEach $it\")\n        }\n        .launchIn(uiScope)      // 2ï¼ŒUIä»»åŠ¡\n\n    delay(1000L)\n}\n</code></pre><p>è¿™æ®µä»£ç å¾ˆå®¹æ˜“ç†è§£ï¼Œæˆ‘ä»¬è®©è€—æ—¶ä»»åŠ¡åœ¨IOçº¿ç¨‹æ± æ‰§è¡Œï¼Œæ›´æ–°UIåˆ™åœ¨UIçº¿ç¨‹ã€‚</p><p>å¦‚æœç»“åˆæˆ‘ä»¬å‰é¢å­¦è¿‡çš„Flowæ“ä½œç¬¦ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾è®¡å‡ºæ›´åŠ æœ‰æ„æ€çš„ä»£ç ï¼š</p><pre><code class=\"language-plain\">// ä»£ç æ®µ22\n\nfun main() = runBlocking {\n    fun loadData() = flow {\n        repeat(3) {\n            delay(100L)\n            emit(it)\n            logX(\"emit $it\")\n        }\n    }\n    fun updateUI(it: Int) {}\n    fun showLoading() { println(\"Show loading\") }\n    fun hideLoading() { println(\"Hide loading\") }\n\n    val uiScope = CoroutineScope(mySingleDispatcher)\n\n    loadData()\n        .onStart { showLoading() }          // æ˜¾ç¤ºåŠ è½½å¼¹çª—\n        .map { it * 2 }\n        .flowOn(Dispatchers.IO)\n        .catch { throwable -&gt;\n            println(throwable)\n            hideLoading()                   // éšè—åŠ è½½å¼¹çª—\n            emit(-1)                   // å‘ç”Ÿå¼‚å¸¸ä»¥åï¼ŒæŒ‡å®šé»˜è®¤å€¼\n        }\n        .onEach { updateUI(it) }            // æ›´æ–°UIç•Œé¢ \n        .onCompletion { hideLoading() }     // éšè—åŠ è½½å¼¹çª—\n        .launchIn(uiScope)\n\n    delay(10000L)\n}\n</code></pre><p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç›‘å¬onStartã€onCompletionçš„å›è°ƒäº‹ä»¶ï¼Œå°±å¯ä»¥å®ç°Loadingå¼¹çª—çš„æ˜¾ç¤ºå’Œéšè—ã€‚è€Œå¯¹äºå‡ºç°å¼‚å¸¸çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨catch{} å½“ä¸­è°ƒç”¨emit()ï¼Œç»™å‡ºä¸€ä¸ªé»˜è®¤å€¼ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆé˜²æ­¢UIç•Œé¢å‡ºç°ç©ºç™½ã€‚</p><p>ä¸å¾—ä¸è¯´ï¼Œä»¥ä¸Šä»£ç çš„å¯è¯»æ€§æ˜¯éå¸¸å¥½çš„ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾çš„å†…å®¹åˆ°è¿™é‡Œå°±å·®ä¸å¤šç»“æŸäº†ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•çš„æ€»ç»“ã€‚</p><ul>\n<li>Flowï¼Œå°±æ˜¯<strong>æ•°æ®æµ</strong>ã€‚æ•´ä¸ªFlowçš„APIè®¾è®¡ï¼Œå¯ä»¥å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œä¸Šæ¸¸çš„æºå¤´ã€ä¸­é—´æ“ä½œç¬¦ã€ä¸‹æ¸¸ç»ˆæ­¢æ“ä½œç¬¦ã€‚</li>\n<li>å¯¹äº<strong>ä¸Šæ¸¸æºå¤´</strong>æ¥è¯´ï¼Œå®ƒä¸»è¦è´Ÿè´£ï¼šåˆ›å»ºFlowï¼Œå¹¶ä¸”äº§ç”Ÿæ•°æ®ã€‚è€Œåˆ›å»ºFlowï¼Œä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼šflow{}ã€flowOf()ã€asFlow()ã€‚</li>\n<li>å¯¹äº<strong>ä¸­é—´æ“ä½œç¬¦</strong>æ¥è¯´ï¼Œå®ƒä¹Ÿåˆ†ä¸ºå‡ å¤§ç±»ã€‚ç¬¬ä¸€ç±»æ˜¯ä»é›†åˆâ€œæŠ„â€è¿‡æ¥çš„æ“ä½œç¬¦ï¼Œæ¯”å¦‚mapã€filterï¼›ç¬¬äºŒç±»æ˜¯ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œæ¯”å¦‚onStartã€onCompletionï¼›ç¬¬ä¸‰ç±»æ˜¯åŠŸèƒ½å‹APIï¼Œæ¯”å¦‚è¯´flowOnåˆ‡æ¢Contextã€catchæ•è·ä¸Šæ¸¸çš„å¼‚å¸¸ã€‚</li>\n<li>å¯¹äº<strong>ä¸‹æ¸¸çš„ç»ˆæ­¢æ“ä½œç¬¦</strong>ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸‰å¤§ç±»ã€‚é¦–å…ˆï¼Œå°±æ˜¯collectè¿™ä¸ªæœ€åŸºç¡€çš„ç»ˆæ­¢æ“ä½œç¬¦ï¼›å…¶æ¬¡ï¼Œå°±æ˜¯ä»é›†åˆAPIâ€œæŠ„â€è¿‡æ¥çš„æ“ä½œç¬¦ï¼Œæ¯”å¦‚foldã€reduceï¼›æœ€åï¼Œå°±æ˜¯Flowè½¬æ¢æˆé›†åˆçš„APIï¼Œæ¯”å¦‚è¯´flow.toList()ã€‚</li>\n</ul><p>ä½ ä¹Ÿè¦æ¸…æ¥šä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´â€œFlowæ˜¯å†·çš„â€çš„åŸå› ï¼Œä»¥åŠå®ƒå¯¹æ¯”Channelçš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚å¦å¤–åœ¨è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬è¿˜æ¢ç´¢äº†Flowåœ¨Androidé‡Œçš„å®é™…åº”ç”¨åœºæ™¯ï¼Œå½“æˆ‘ä»¬å°†Flowä¸å®ƒçš„æ“ä½œç¬¦çµæ´»ç»„åˆåˆ°ä¸€èµ·çš„æ—¶å€™ï¼Œå°±å¯ä»¥è®¾è®¡å‡ºå¯è¯»æ€§éå¸¸å¥½çš„ä»£ç ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/74/1a/747837c1b0657ae4042fbce9eae75f1a.jpg?wh=2000x1306\" alt=\"\"></p><p>å…¶å®ï¼ŒFlowæœ¬èº«å°±æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„è¯é¢˜ï¼Œèƒ½è®²çš„çŸ¥è¯†ç‚¹å®åœ¨å¤ªå¤šäº†ã€‚ä½†è€ƒè™‘åˆ°å’±ä»¬è¯¾ç¨‹å­¦ä¹ éœ€è¦å¾ªåºæ¸è¿›ï¼Œç°é˜¶æ®µæˆ‘åªæ˜¯ä»ä¸­æŒ‘é€‰ä¸€äº›æœ€é‡è¦ã€æœ€å…³é”®çš„çŸ¥è¯†ç‚¹æ¥è®²ã€‚æ›´å¤šFlowçš„é«˜é˜¶ç”¨æ³•ï¼Œç­‰æˆ‘ä»¬å­¦å®Œåç¨‹ç¯‡ã€æºç ç¯‡ä¹‹åï¼Œæˆ‘ä¼šå†è€ƒè™‘å¢åŠ ä¸€äº›æ›´é«˜é˜¶çš„å†…å®¹è¿›æ¥ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å‰é¢æˆ‘æ›¾æåˆ°è¿‡ï¼ŒFlowå½“ä¸­ç›´æ¥ä½¿ç”¨withContext{}ï¼Œæ˜¯å¾ˆå®¹æ˜“å‡ºç°é—®é¢˜çš„ï¼Œä¸‹é¢ä»£ç æ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚è¯·é—®ä½ èƒ½è§£é‡Šå…¶ä¸­çš„ç¼˜ç”±å—ï¼ŸKotlinå®˜æ–¹ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Ÿ</p><pre><code class=\"language-plain\">// ä»£ç æ®µ23\n\nfun main() = runBlocking {\n    flow {\n        withContext(Dispatchers.IO) {\n            emit(1)\n        }\n    }.map { it * 2 }\n        .collect()\n}\n\n/*\nè¾“å‡ºç»“æœ\nIllegalStateException: Flow invariant is violated\n*/\n</code></pre><p>è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ‘ä¼šåœ¨ç¬¬32è®²ä»‹ç»Flowæºç çš„æ—¶å€™ç»™å‡ºè¯¦ç»†çš„è§£é‡Šã€‚</p>","neighbors":{"left":{"article_title":"19 | Channelï¼šä¸ºä»€ä¹ˆè¯´Channelæ˜¯â€œçƒ­â€çš„ï¼Ÿ","id":491021},"right":{"article_title":"21 | selectï¼šåˆ°åº•æ˜¯åœ¨é€‰æ‹©ä»€ä¹ˆï¼Ÿ","id":492405}},"comments":[{"had_liked":false,"id":339391,"user_name":"Paul Shan","can_delete":false,"product_type":"c1","uid":1593140,"ip_address":"","ucode":"32D99989028284","user_header":"","comment_is_top":false,"comment_ctime":1648068209,"is_pvip":false,"replies":[{"id":"124299","content":"æ²¡é”™ï¼Œæ˜¯è¿™ä¸ªæ„æ€ã€‚","user_name":"ä½œè€…å›å¤","comment_id":339391,"uid":"1180670","ip_address":"","utype":1,"ctime":1648521380,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"36007806577","product_id":100103401,"comment_content":"æ€è€ƒé¢˜:flowæœ¬èº«å·²ç»æä¾›äº†çº¿ç¨‹åˆ‡æ¢çš„ä¸­é—´æ“ä½œç¬¦flowOnå’ŒlaunchInï¼Œæ¥ç¡®å®šä¸åŒéƒ¨åˆ†çš„çº¿ç¨‹è¾¹ç•Œå¹¶ä¼˜åŒ–ï¼ŒwithContextè¦å†æ¬¡åˆ‡æ¢çº¿ç¨‹ï¼ŒåŠ¿å¿…æ‰“ç ´flowè§„åˆ’å¥½çš„çº¿ç¨‹è¾¹ç•Œï¼Œä¼°è®¡è¦å‡ºé”™ï¼ŒæŠ›å‡ºå¼‚å¸¸æ¥æå‰æŠ¥é”™ã€‚","like_count":9,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558909,"discussion_content":"æ²¡é”™ï¼Œæ˜¯è¿™ä¸ªæ„æ€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648521380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354434,"user_name":"NormanYonng","can_delete":false,"product_type":"c1","uid":3055932,"ip_address":"æµ™æ±Ÿ","ucode":"E95D8EEC07F123","user_header":"https://static001.geekbang.org/account/avatar/00/2e/a1/3c/e415fa49.jpg","comment_is_top":false,"comment_ctime":1660384581,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5955351877","product_id":100103401,"comment_content":"æˆ‘ä½œä¸ºç¨å¾®æœ‰javaåŸºç¡€çš„æ„Ÿè§‰è€å¸ˆè®²åˆ°javaçš„å¯¹æ¯”æ—¶è¿˜æ˜¯æ„Ÿè§‰åˆ°èƒ½å¾ˆå¿«æ·±å…¥ç†è§£ï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå®ä¾‹ä»£ç æœ‰æ—¶å€™ç”¨é«˜é˜¶å‡½æ•°å’Œkotlinæ ‡å‡†å‡½æ•°çš„æ—¶å€™æˆ‘å°±ä¼šä¸€è„¸æ‡µé€¼ï¼Œå»æŸ¥è¿™ä¸ªå‡½æ•°ä½œç”¨ã€‚è¿™ä¸ªçœŸçš„æ˜¯è¿™ä¸ªè¯¾ç¨‹å¾ˆå¤§çš„ç¼ºç‚¹ï¼Œç‰¹åˆ«æ˜¯æ²¡æœ‰ç¼–ç¨‹ç»éªŒçš„äººæ¥è¯´ï¼Œä»£ç ä¸€èˆ¬èˆ¬è§£æéœ€è¦ç†è§£ä»£ç çš„æ¯ä¸€ä¸ªå­—ç¬¦ä½œç”¨åŠå‡½æ•°ä½œç”¨ã€‚å¸Œæœ›è€å¸ˆèƒ½åœ¨ç¬¬ä¸€è¯¾åŠ ä¸ªkotlinæ ‡å‡†å‡½æ•°è®²è§£ï¼Œè¿˜æœ‰è®²è§£ä»£ç æ—¶ï¼Œä½¿ç”¨çš„æ ‡å‡†å‡½æ•°ï¼Œè®²è§£ä¸€ä¸‹æ ‡å‡†å‡½æ•°çš„ä½œç”¨","like_count":0,"discussions":[{"author":{"id":1342000,"avatar":"https://static001.geekbang.org/account/avatar/00/14/7a/30/23fc4089.jpg","nickname":"24éš‹å¿ƒæ‰€æ¬²","note":"","ucode":"1B8B2789F68C94","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592065,"discussion_content":"ä¸å¯èƒ½æŒ‡æœ›è€å¸ˆé¢é¢ä¿±åˆ°ï¼Œå¦‚æœæ ‡å‡†å‡½æ•°éƒ½è®²ä¸€éçš„è¯ä¼°è®¡100èŠ‚è¯¾ä¹Ÿæ‰“ä¸ä½äº†ã€‚ä¸æ‡‚çš„è¯å°±çœ‹æºç å•Šã€æœèµ„æ–™å•Šï¼Œè¿™ä¸æ˜¯å¾ˆåŸºç¡€çš„èƒ½åŠ›ä¹ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667054256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ²³åŒ—"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336753,"user_name":"é­å…¨è¿","can_delete":false,"product_type":"c1","uid":1090798,"ip_address":"","ucode":"3FED702C724E2A","user_header":"https://static001.geekbang.org/account/avatar/00/10/a4/ee/cffd8ee6.jpg","comment_is_top":false,"comment_ctime":1646354591,"is_pvip":false,"replies":[{"id":"123158","content":"æ€æƒ³æ˜¯ç±»ä¼¼çš„ï¼Œä½†Flowçš„æ“ä½œç¬¦æ¯”RxJavaè¿˜æ˜¯è¦å°‘å¾ˆå¤šçš„ã€‚æ‰€ä»¥ä¼šæ›´å®¹æ˜“ä¸Šæ‰‹ä¸€äº›ã€‚","user_name":"ä½œè€…å›å¤","comment_id":336753,"uid":"1180670","ip_address":"","utype":1,"ctime":1646581883,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"5941321887","product_id":100103401,"comment_content":"Flow è·ŸRxJava çš„ä½¿ç”¨æ–¹å¼å¤ªåƒäº†","like_count":2,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554763,"discussion_content":"æ€æƒ³æ˜¯ç±»ä¼¼çš„ï¼Œä½†Flowçš„æ“ä½œç¬¦æ¯”RxJavaè¿˜æ˜¯è¦å°‘å¾ˆå¤šçš„ã€‚æ‰€ä»¥ä¼šæ›´å®¹æ˜“ä¸Šæ‰‹ä¸€äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646581883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1714085,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/27/a5/2c7f86b2.jpg","nickname":"ä¸Šå²¸çš„ğŸŸ","note":"","ucode":"B5EC8429B17267","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":577447,"discussion_content":"é‚£æ˜¯ä¸æ˜¯æ›´å¤æ‚çš„åœºæ™¯å¯èƒ½è¿˜æ˜¯è¦ç”¨RxJavaæ¥å®ç°ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656121550,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":554763,"ip_address":""},"score":577447,"extra":""},{"author":{"id":1342000,"avatar":"https://static001.geekbang.org/account/avatar/00/14/7a/30/23fc4089.jpg","nickname":"24éš‹å¿ƒæ‰€æ¬²","note":"","ucode":"1B8B2789F68C94","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1714085,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/27/a5/2c7f86b2.jpg","nickname":"ä¸Šå²¸çš„ğŸŸ","note":"","ucode":"B5EC8429B17267","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":592066,"discussion_content":"ä½ ä¸¾ä¸ªä¾‹å­ï¼Ÿçœ‹çœ‹æœ‰å¤šå¤æ‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667054290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":577447,"ip_address":"æ²³åŒ—"},"score":592066,"extra":""}]}]},{"had_liked":false,"id":354277,"user_name":"éƒ‘å³°","can_delete":false,"product_type":"c1","uid":1112517,"ip_address":"ç¾å›½","ucode":"4D4C0C020E507C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f9/c5/95b97dfa.jpg","comment_is_top":false,"comment_ctime":1660237153,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660237153","product_id":100103401,"comment_content":"withContext() å¤ªå…·æœ‰ä¾µå…¥æ€§ã€‚å¯èƒ½ç ´åflowOnå’ŒlaunchInçš„é€»è¾‘ã€‚","like_count":0},{"had_liked":false,"id":352875,"user_name":"é’Ÿæ„","can_delete":false,"product_type":"c1","uid":2340622,"ip_address":"é™•è¥¿","ucode":"0C1954C3CF1151","user_header":"https://static001.geekbang.org/account/avatar/00/23/b7/0e/f7b48767.jpg","comment_is_top":false,"comment_ctime":1658991669,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658991669","product_id":100103401,"comment_content":"ä½œè€…çš„è¯¾ç¨‹æºä»£ç ï¼Œåœ¨å“ªé‡Œä¸‹è½½å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":352810,"user_name":"å°äººç‰©","can_delete":false,"product_type":"c1","uid":1743045,"ip_address":"","ucode":"0C8CB8F7E43DF3","user_header":"https://static001.geekbang.org/account/avatar/00/1a/98/c5/a0ca3e05.jpg","comment_is_top":false,"comment_ctime":1658941702,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658941702","product_id":100103401,"comment_content":"è€å¸ˆå…³äºlaunchInçš„è¡¨è¿°ä¼¼ä¹æ¯”è¾ƒæ¨¡ç³Šï¼ŒlaunchInçš„è®¾è®¡æˆ‘è§‰å¾—ä¸»è¦è¿˜æ˜¯ç”¨äºåœ¨ä¸€ä¸ªæ–°çš„åç¨‹ä¸­å¯åŠ¨flowï¼Œä»è€Œé¿å…é˜»å¡å¤–é¢çš„åç¨‹ï¼Œå› ä¸ºcollectæ“ä½œç¬¦æ˜¯æŒ‚èµ·çš„ã€‚å½“æˆ‘ä»¬æœ‰å¤šä¸ªflowä»»åŠ¡å¹¶å‘éœ€æ±‚æ—¶ï¼Œå°±å¯ä»¥ç”¨launchInæ¥æ–¹ä¾¿çš„å¤„ç†ã€‚è‡³äºcollectä»£ç çš„çº¿ç¨‹åˆ‡æ¢å®é™…ä¹Ÿä¸æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºcollectçš„æ‰§è¡Œç¯å¢ƒå°±æ˜¯æ‰€åœ¨åç¨‹çš„ç¯å¢ƒ","like_count":0},{"had_liked":false,"id":349429,"user_name":"è®¸å…ˆæ£®","can_delete":false,"product_type":"c1","uid":1795371,"ip_address":"","ucode":"1F42D4A6B5C6AF","user_header":"https://static001.geekbang.org/account/avatar/00/1b/65/2b/446ef7b6.jpg","comment_is_top":false,"comment_ctime":1655966291,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655966291","product_id":100103401,"comment_content":"åç¨‹1.4ä¹‹å‰cancelä¸æˆåŠŸï¼Œ3è¿˜æ˜¯ä¼šæ‰“å°ã€‚1.4ä¹‹åæ­£å¸¸<br>collect: 1<br>collect: 2<br>cancel<br>collect: 3<br>onCompletion first: null<br>collect: 4<br>onCompletion second: null","like_count":0},{"had_liked":false,"id":340423,"user_name":"pengzhaoyang coder","can_delete":false,"product_type":"c1","uid":2879489,"ip_address":"","ucode":"25550F569BB0FD","user_header":"https://static001.geekbang.org/account/avatar/00/2b/f0/01/fd1c2548.jpg","comment_is_top":false,"comment_ctime":1648807150,"is_pvip":false,"replies":[{"id":"124596","content":"æ˜¯çš„ï¼Œé‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¸å…è®¸å¤šä¸ªCoroutineContextï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":340423,"uid":"1180670","ip_address":"","utype":1,"ctime":1649134327,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1648807150","product_id":100103401,"comment_content":"å‘é€çš„æ•°æ®å¿…é¡»æ¥è‡ªåŒä¸€ä¸ªåç¨‹å†…ï¼Œä¸å…è®¸æ¥è‡ªå¤šä¸ªCoroutineContextï¼Œæ‰€ä»¥é»˜è®¤ä¸èƒ½åœ¨flow{}ä¸­åˆ›å»ºæ–°åç¨‹æˆ–é€šè¿‡withContext()åˆ‡æ¢åç¨‹ã€‚å¦‚éœ€åˆ‡æ¢ä¸Šæ¸¸çš„CoroutineContextï¼Œå¯ä»¥é€šè¿‡flowOn()è¿›è¡Œåˆ‡æ¢","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560031,"discussion_content":"æ˜¯çš„ï¼Œé‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¸å…è®¸å¤šä¸ªCoroutineContextï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649134327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339394,"user_name":"Paul Shan","can_delete":false,"product_type":"c1","uid":1593140,"ip_address":"","ucode":"32D99989028284","user_header":"","comment_is_top":false,"comment_ctime":1648069025,"is_pvip":false,"replies":[{"id":"124302","content":"æ˜¯çš„ï¼ŒChannelæ›´åƒæ˜¯ä¸€ä¸ªåº•å±‚çš„åŸºç¡€å·¥å…·ï¼Œä¸å¤ªé€‚åˆç›´æ¥æ‹¿æ¥ç”¨ã€‚","user_name":"ä½œè€…å›å¤","comment_id":339394,"uid":"1180670","ip_address":"","utype":1,"ctime":1648521792,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1648069025","product_id":100103401,"comment_content":"Flowä¹Ÿæœ‰çƒ­çš„SharedFlowï¼Œè¿˜æ”¯æŒä¸€å¯¹å¤šçš„æœåŠ¡ï¼Œæˆ‘è‡ªå·±çš„ç»éªŒæ˜¯ï¼ŒChannelåœ¨å…·ä½“åœºæ™¯ä¸­åŸºæœ¬å¯ä»¥è¢«Flowæ›¿ä»£ï¼Œè€Œä¸”æ›´æ–¹ä¾¿æ›´å®‰å…¨ã€‚","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558912,"discussion_content":"æ˜¯çš„ï¼ŒChannelæ›´åƒæ˜¯ä¸€ä¸ªåº•å±‚çš„åŸºç¡€å·¥å…·ï¼Œä¸å¤ªé€‚åˆç›´æ¥æ‹¿æ¥ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648521793,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339393,"user_name":"Paul Shan","can_delete":false,"product_type":"c1","uid":1593140,"ip_address":"","ucode":"32D99989028284","user_header":"","comment_is_top":false,"comment_ctime":1648068620,"is_pvip":false,"replies":[{"id":"124301","content":"æ˜¯çš„ï¼ŒFlowçš„å­¦ä¹ æˆæœ¬ä¼šæ›´ä½ä¸€äº›ã€‚","user_name":"ä½œè€…å›å¤","comment_id":339393,"uid":"1180670","ip_address":"","utype":1,"ctime":1648521648,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1648068620","product_id":100103401,"comment_content":"åŸæ¥åœ¨ä½¿ç”¨Rxjavaè¿˜æ˜¯Coroutineçš„æ—¶å€™ï¼Œæˆ‘è¿˜æ˜¯æ”¯æŒä½¿ç”¨Rxjavaçš„ï¼ŒFlowå‡ºæ¥ä¹‹åï¼Œæˆ‘å°±å€’å‘Coroutine Flowã€‚","like_count":1,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558911,"discussion_content":"æ˜¯çš„ï¼ŒFlowçš„å­¦ä¹ æˆæœ¬ä¼šæ›´ä½ä¸€äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648521648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339173,"user_name":"æ¢ä¸­å","can_delete":false,"product_type":"c1","uid":1006789,"ip_address":"","ucode":"52FE40242CBAD0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg","comment_is_top":false,"comment_ctime":1647956477,"is_pvip":true,"replies":[{"id":"124001","content":"æ„Ÿè°¢ä½ çš„å»ºè®®ï¼Œæˆ‘ä¼šè€ƒè™‘çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":339173,"uid":"1180670","ip_address":"","utype":1,"ctime":1648029731,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1647956477","product_id":100103401,"comment_content":"å¤§ä½¬ï¼Œèƒ½ç»“åˆå‡ ä¸ªæœåŠ¡ç«¯çš„ä¾‹å­è®²è®²ä¸ï¼Œå…¶å®åç¨‹çš„ä¸»è¦å‘æŒ¥åœºæ™¯è¿˜æ˜¯åœ¨æœåŠ¡ç«¯ï¼Œå°±åƒgoroutingä¸€æ ·","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557947,"discussion_content":"æ„Ÿè°¢ä½ çš„å»ºè®®ï¼Œæˆ‘ä¼šè€ƒè™‘çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648029731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338364,"user_name":"dawn","can_delete":false,"product_type":"c1","uid":1121701,"ip_address":"","ucode":"979CE356267183","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIpF5euTNx3GOkmf515HFh1ahAzogerLfIyLia2AspTIR9fkU6icGbo2ungo23cdM5s9dUjZGMno7ZA/132","comment_is_top":false,"comment_ctime":1647439219,"is_pvip":false,"replies":[{"id":"123741","content":"å…¶å®æ˜¯å› ä¸ºï¼šä½ ä»£ç ä¸­çš„Dispatcherå¯¹åº”çš„çº¿ç¨‹æ± æ²¡æœ‰å®šä¹‰æˆå®ˆæŠ¤çº¿ç¨‹ã€‚<br><br>```<br>fun main() {<br>    &#47;&#47; è¯·ç•™æ„ Dispatcher å½“ä¸­çš„isDaemon = true<br>    val mySingleDispatcher = Executors.newSingleThreadExecutor {<br>        Thread(it, &quot;MySingleThread&quot;).apply { isDaemon = true }<br>    }.asCoroutineDispatcher()<br>    val scope = CoroutineScope(mySingleDispatcher)<br>    runBlocking {<br>        flow {<br>            emit(1f)<br>            emit(&quot;s&quot;)<br>            kotlinx.coroutines.delay(2000)<br>            emit(2f)<br>            emit(3f)<br>&#47;&#47;            throw NullPointerException()<br>            emit(4f)<br>            emit(5f)<br>            logX(&quot;emit&quot;)<br>        }.filter {<br>            logX(&quot;filter&quot;)<br>            it is Float<br>        }.onStart {<br>            logX(&quot;onStart&quot;)<br>        }.onCompletion {<br>            logX(&quot;onCompletion&quot;)<br>        }.catch {<br>            logX(&quot;catch $it&quot;)<br>        }.onEach {<br>            logX(it)<br>        }.launchIn(scope)<br><br>        logX(&quot;end&quot;)<br>    }<br>}<br>```","user_name":"ä½œè€…å›å¤","comment_id":338364,"uid":"1180670","ip_address":"","utype":1,"ctime":1647571754,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1647439219","product_id":100103401,"comment_content":"å¤§ä½¬ï¼Œä¸ºä»€ä¹ˆä¸‹é¢çš„ä»£ç æ²¡æ³•ç»“æŸ<br>fun main() {<br>    val asCoroutineDispatcher = Executors.newSingleThreadExecutor().asCoroutineDispatcher()<br>    val scope = CoroutineScope(asCoroutineDispatcher)<br>    runBlocking {<br>        flow {<br>            emit(1f)<br>            emit(&quot;s&quot;)<br>            kotlinx.coroutines.delay(2000)<br>            emit(2f)<br>            emit(3f)<br>&#47;&#47;            throw NullPointerException()<br>            emit(4f)<br>            emit(5f)<br>            logX(&quot;emit&quot;)<br>        }.filter {<br>            logX(&quot;filter&quot;)<br>            it is Float<br>        }.onStart {<br>            logX(&quot;onStart&quot;)<br>        }.onCompletion {<br>            logX(&quot;onCompletion&quot;)<br>        }.catch {<br>            logX(&quot;catch $it&quot;)<br>        }.onEach {<br>            logX(it)<br>        }.launchIn(scope)<br><br>        logX(&quot;end&quot;)<br>    }<br>}","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556914,"discussion_content":"å…¶å®æ˜¯å› ä¸ºï¼šä½ ä»£ç ä¸­çš„Dispatcherå¯¹åº”çš„çº¿ç¨‹æ± æ²¡æœ‰å®šä¹‰æˆå®ˆæŠ¤çº¿ç¨‹ã€‚\n\n```\nfun main() {\n    // è¯·ç•™æ„ Dispatcher å½“ä¸­çš„isDaemon = true\n    val mySingleDispatcher = Executors.newSingleThreadExecutor {\n        Thread(it, &#34;MySingleThread&#34;).apply { isDaemon = true }\n    }.asCoroutineDispatcher()\n    val scope = CoroutineScope(mySingleDispatcher)\n    runBlocking {\n        flow {\n            emit(1f)\n            emit(&#34;s&#34;)\n            kotlinx.coroutines.delay(2000)\n            emit(2f)\n            emit(3f)\n//            throw NullPointerException()\n            emit(4f)\n            emit(5f)\n            logX(&#34;emit&#34;)\n        }.filter {\n            logX(&#34;filter&#34;)\n            it is Float\n        }.onStart {\n            logX(&#34;onStart&#34;)\n        }.onCompletion {\n            logX(&#34;onCompletion&#34;)\n        }.catch {\n            logX(&#34;catch $it&#34;)\n        }.onEach {\n            logX(it)\n        }.launchIn(scope)\n\n        logX(&#34;end&#34;)\n    }\n}\n```","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647571755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2697815,"avatar":"https://static001.geekbang.org/account/avatar/00/29/2a/57/6629c858.jpg","nickname":"é˜¿åº·","note":"","ucode":"DF20E1E33A8A34","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580894,"discussion_content":"ä¸ºå•¥è¾“å‡ºé¡ºåºæ˜¯è¿™æ ·çš„ï¼Ÿ\n```\n2022-07-21 17:22:56.231 D/logX: main-&gt;end\n2022-07-21 17:22:56.231 D/logX: MySingleThread-&gt;onStart\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;filter\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;it:1.0\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;filter\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;filter\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;it:2.0\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;filter\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;it:3.0\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;filter\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;it:4.0\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;filter\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;it:5.0\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;emit\n2022-07-21 17:22:56.233 D/logX: MySingleThread-&gt;onCompletion\n```\nrunBlocking ä¸æ˜¯é˜»å¡çº¿ç¨‹å—ï¼Ÿä¸åº”è¯¥æ˜¯å…ˆæ‰§è¡Œå®ŒrunBlocking é‡Œé¢çš„ä»£ç å†è¾“å‡º\nmain-&gt;endå—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658395518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337868,"user_name":"ç™½ä¹¾æ¶›","can_delete":false,"product_type":"c1","uid":1339841,"ip_address":"","ucode":"0C704B0B90C8D7","user_header":"https://static001.geekbang.org/account/avatar/00/14/71/c1/cbc55e06.jpg","comment_is_top":false,"comment_ctime":1647097747,"is_pvip":false,"replies":[{"id":"123583","content":"æˆ‘åœ¨ç¬¬17è®²å½“ä¸­æåˆ°è¿‡ï¼Œåœ¨éUIå¹³å°ä¸Šï¼ŒDispatchers.Mainæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚åªæœ‰åœ¨Androidã€Swingä¹‹ç±»çš„å¹³å°ï¼Œæˆ‘ä»¬æ‰å¯ä»¥ä½¿ç”¨Dispatchers.Mainã€‚","user_name":"ä½œè€…å›å¤","comment_id":337868,"uid":"1180670","ip_address":"","utype":1,"ctime":1647235560,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1647097747","product_id":100103401,"comment_content":"ä»¥ä¸‹ä»£ç ï¼Œä¸ºå•¥æ²¡æœ‰ä»»ä½•æ—¥å¿—è¾“å‡ºï¼Ÿ<br>è€Œä¸”ï¼Œä¸ºå•¥ç¨‹åºä¸ä¼šç»“æŸï¼Ÿ<br><br>fun main() = runBlocking {<br>    withContext(dispatcher) {<br>        flow { log(&quot;emit&quot;); emit(1) }<br>            .flowOn(Dispatchers.Main)<br>            .filter { log(&quot;filter&quot;); it &gt; 0 }<br>            .collect { log(&quot;collect&quot;) }<br>    }<br>}","like_count":1,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556160,"discussion_content":"æˆ‘åœ¨ç¬¬17è®²å½“ä¸­æåˆ°è¿‡ï¼Œåœ¨éUIå¹³å°ä¸Šï¼ŒDispatchers.Mainæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚åªæœ‰åœ¨Androidã€Swingä¹‹ç±»çš„å¹³å°ï¼Œæˆ‘ä»¬æ‰å¯ä»¥ä½¿ç”¨Dispatchers.Mainã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647235560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337866,"user_name":"ç™½ä¹¾æ¶›","can_delete":false,"product_type":"c1","uid":1339841,"ip_address":"","ucode":"0C704B0B90C8D7","user_header":"https://static001.geekbang.org/account/avatar/00/14/71/c1/cbc55e06.jpg","comment_is_top":false,"comment_ctime":1647097232,"is_pvip":false,"replies":[{"id":"123582","content":"è¿™å¾ˆåˆç†ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œemitæ˜¯ä¼šä½¿ç”¨collectçš„åç¨‹ä¸Šä¸‹æ–‡çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":337866,"uid":"1180670","ip_address":"","utype":1,"ctime":1647235144,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1647097232","product_id":100103401,"comment_content":"ä¸ºå•¥ä¸‹é¢ä»£ç ä¸­çš„ emit ä¹Ÿæ‰§è¡Œåœ¨ IO çº¿ç¨‹ï¼Ÿ<br><br>fun main() = runBlocking {<br>    val flow = flow { log(&quot;emit&quot;); emit(1) }<br>    withContext(Dispatchers.IO) {<br>        flow.filter { log(&quot;filter&quot;); it &gt; 0 }<br>            .collect { log(&quot;collect&quot;) }<br>    }<br>}","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556158,"discussion_content":"è¿™å¾ˆåˆç†ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œemitæ˜¯ä¼šä½¿ç”¨collectçš„åç¨‹ä¸Šä¸‹æ–‡çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647235144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135912,"avatar":"https://static001.geekbang.org/account/avatar/00/11/55/28/31b0cf2f.jpg","nickname":"é»‘è‰²æ¯›è¡£","note":"","ucode":"FF7E235F91BA5C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561294,"discussion_content":"withContext (Dispatchers.IO) {\n}\nä¸æ˜¯åˆ‡æ¢çº¿ç¨‹äº†ä¹ˆï¼Ÿï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649595639,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337580,"user_name":"æ›¾å¸…","can_delete":false,"product_type":"c1","uid":1234319,"ip_address":"","ucode":"322F049DA9284D","user_header":"https://static001.geekbang.org/account/avatar/00/12/d5/8f/d0874a01.jpg","comment_is_top":false,"comment_ctime":1646902887,"is_pvip":false,"replies":[{"id":"123417","content":"èƒ½ä»æºç ä¸­æ‰¾åˆ°è¯æ®ï¼Œå¾ˆå¥½ã€‚","user_name":"ä½œè€…å›å¤","comment_id":337580,"uid":"1180670","ip_address":"","utype":1,"ctime":1647010344,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1646902887","product_id":100103401,"comment_content":"å…³äºæ€è€ƒé¢˜ï¼Œç¿»äº†ä¸€ä¸‹ emit() çš„ä»£ç ï¼Œå‘ç°é‡Œé¢æœ‰è¯´åˆ°è¿™ä¸€ç‚¹ã€‚<br>é‡Œé¢è¯´ä¸å…è®¸åœ¨ withContext é‡Œ è°ƒç”¨ emit() æ˜¯å› ä¸º emit() é»˜è®¤ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œä¸”è¿˜ç»™å‡ºäº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ä½¿ç”¨ channel æ¥å¤„ç†ã€‚","like_count":1,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555665,"discussion_content":"èƒ½ä»æºç ä¸­æ‰¾åˆ°è¯æ®ï¼Œå¾ˆå¥½ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647010344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337109,"user_name":"ç¥ç§˜å˜‰Bin","can_delete":false,"product_type":"c1","uid":2879116,"ip_address":"","ucode":"6045F09320E5F3","user_header":"https://static001.geekbang.org/account/avatar/00/2b/ee/8c/06f3aef0.jpg","comment_is_top":false,"comment_ctime":1646626152,"is_pvip":false,"replies":[{"id":"123278","content":"æ–¹å‘å·²ç»å¯¹äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":337109,"uid":"1180670","ip_address":"","utype":1,"ctime":1646755187,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1646626152","product_id":100103401,"comment_content":"æˆ‘çŒœæ˜¯é¿å…withContextå’ŒflowOnã€launchInçš„å†²çªï¼Œä¸»åŠ¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸å¯¹ä¸šåŠ¡è¿›è¡Œæç¤ºã€‚","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555134,"discussion_content":"æ–¹å‘å·²ç»å¯¹äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646755187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337101,"user_name":"ä»å¿ƒæ‰€æ¬²","can_delete":false,"product_type":"c1","uid":1895808,"ip_address":"","ucode":"8F0C6C41BAE8D3","user_header":"https://static001.geekbang.org/account/avatar/00/1c/ed/80/157c58a9.jpg","comment_is_top":false,"comment_ctime":1646623046,"is_pvip":false,"replies":[{"id":"123276","content":"onCompletion{}ä¸€èˆ¬åªä½œä¸ºå›è°ƒæ¥ä½¿ç”¨ï¼Œç›®å‰æ²¡æœ‰åŠæ³•ç›´æ¥æ‹¿åˆ°flowå½“ä¸­çš„å†…å®¹ã€‚å…¶å®ï¼Œå¦‚æœä½ èƒ½è®¤æ¸…flowæœ¬è´¨æ˜¯æ•°æ®æµçš„è¯ï¼Œä½ åº”è¯¥ä¹Ÿèƒ½çŸ¥é“ï¼ŒonCompletionçš„æ—¶å€™ï¼Œå–å“ªä¸ªæ•°æ®ä¹Ÿæ— æ³•ç•Œå®šã€‚å¦å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå…ˆåé¡ºåºçš„é—®é¢˜ï¼Œflowå½“ä¸­çš„æ•°æ®ä¼ è¾“å®Œåæ‰ä¼šæœ‰onCompletionã€‚","user_name":"ä½œè€…å›å¤","comment_id":337101,"uid":"1180670","ip_address":"","utype":1,"ctime":1646755152,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1646623046","product_id":100103401,"comment_content":"æ€æ ·åœ¨onCompletionçš„æ—¶å€™æ‹¿åˆ°flowçš„å†…å®¹å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555132,"discussion_content":"onCompletion{}ä¸€èˆ¬åªä½œä¸ºå›è°ƒæ¥ä½¿ç”¨ï¼Œç›®å‰æ²¡æœ‰åŠæ³•ç›´æ¥æ‹¿åˆ°flowå½“ä¸­çš„å†…å®¹ã€‚å…¶å®ï¼Œå¦‚æœä½ èƒ½è®¤æ¸…flowæœ¬è´¨æ˜¯æ•°æ®æµçš„è¯ï¼Œä½ åº”è¯¥ä¹Ÿèƒ½çŸ¥é“ï¼ŒonCompletionçš„æ—¶å€™ï¼Œå–å“ªä¸ªæ•°æ®ä¹Ÿæ— æ³•ç•Œå®šã€‚å¦å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå…ˆåé¡ºåºçš„é—®é¢˜ï¼Œflowå½“ä¸­çš„æ•°æ®ä¼ è¾“å®Œåæ‰ä¼šæœ‰onCompletionã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646755152,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337010,"user_name":"PoPlus","can_delete":false,"product_type":"c1","uid":1574765,"ip_address":"","ucode":"5F0927921317F2","user_header":"https://static001.geekbang.org/account/avatar/00/18/07/6d/4c1909be.jpg","comment_is_top":false,"comment_ctime":1646550378,"is_pvip":false,"replies":[{"id":"123150","content":"è¿™é‡Œdelayçš„ä½œç”¨æ˜¯é˜²æ­¢ä¸»çº¿ç¨‹æå‰ç»“æŸè€Œçœ‹ä¸åˆ°flowè¾“å‡ºçš„æ—¥å¿—ã€‚ä¸ç®¡æ˜¯launchInï¼Œè¿˜æ˜¯â€œscope.launch { &#47;&#47; æ³¨æ„è¿™é‡Œ flow.collect() }â€ï¼Œå…¶å®éƒ½éœ€è¦ã€‚","user_name":"ä½œè€…å›å¤","comment_id":337010,"uid":"1180670","ip_address":"","utype":1,"ctime":1646580773,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1646550378","product_id":100103401,"comment_content":"æ—¢ç„¶ launchIn ä¹Ÿæ˜¯ç”¨ collect å®ç°çš„ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦åœ¨ç¨‹åºæœ«å°¾ delay ä¸€ä¸‹å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1180670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/03/fe/0f43ef35.jpg","nickname":"æœ±æ¶›","note":"","ucode":"5AB5AFE32B8008","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554753,"discussion_content":"è¿™é‡Œdelayçš„ä½œç”¨æ˜¯é˜²æ­¢ä¸»çº¿ç¨‹æå‰ç»“æŸè€Œçœ‹ä¸åˆ°flowè¾“å‡ºçš„æ—¥å¿—ã€‚ä¸ç®¡æ˜¯launchInï¼Œè¿˜æ˜¯â€œscope.launch { // æ³¨æ„è¿™é‡Œ flow.collect() }â€ï¼Œå…¶å®éƒ½éœ€è¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646580773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}