{"id":780132,"title":"13ï½œåˆ—è¡¨ï¼ˆä¸Šï¼‰ï¼šPythonè¯­è¨€çš„æ ¸å¿ƒæ•°æ®ç»“æ„","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æµ·çº³ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/774409\">ç¬¬ 7 èŠ‚è¯¾</a>ï¼Œæˆ‘ä»¬å®ç°äº† Python çš„ä¸¤ä¸ªåŸºæœ¬çš„å†…å»ºç±»å‹ï¼šæ•´æ•°å’Œå­—ç¬¦ä¸²ï¼Œä»è€Œæ„å»ºäº†è™šæ‹Ÿæœºçš„æœ€åŸºæœ¬çš„å¯¹è±¡ç³»ç»Ÿã€‚ä»è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸¤ä¸ªé‡è¦çš„åŸºæœ¬å†…å»ºç±»å‹ï¼Œåˆ†åˆ«æ˜¯åˆ—è¡¨ï¼ˆlistï¼‰å’Œå­—å…¸ï¼ˆdictï¼‰ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥ç ”ç©¶å¦‚ä½•å®ç°åˆ—è¡¨ã€‚</p><h2>åˆ—è¡¨çš„å®šä¹‰</h2><p>Python ä¸­çš„åˆ—è¡¨å¾ˆåƒæ•°ç»„æ“ä½œï¼Œå¯ä»¥æ”¯æŒå¯¹å…ƒç´ çš„æ’å…¥ã€æ·»åŠ ã€åˆ é™¤ç­‰æ“ä½œã€‚å®é™…ä¸Š Python çš„ list å’Œ C++ STL ä¸­çš„ vector éå¸¸ç›¸ä¼¼ã€‚åŒºåˆ«åœ¨äºï¼ŒPython çš„ list å…è®¸å®ƒçš„å…ƒç´ æ˜¯ä¸åŒç±»å‹çš„ã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ list çš„ç‰¹æ€§ã€‚</p><pre><code class=\"language-python\"># test_list.py\nlst = [1, \"hello\"]\n\n# result is [1, 'hello']\nprint(lst)\n</code></pre><p>ä¸Šé¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨åŒ…å«äº†ä¸¤ä¸ªå…ƒç´ ã€‚ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ•´æ•° 1ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯å­—ç¬¦ä¸² <code>â€œhelloâ€</code>ã€‚ç¬¬äºŒè¡Œä»£ç æŠŠè¿™ä¸ªåˆ—è¡¨æ‰“å°äº†å‡ºæ¥ã€‚</p><p>é€šè¿‡ show_file å·¥å…·ï¼Œæˆ‘ä»¬èƒ½è§‚å¯Ÿåˆ° Python ä¸ºäº†å®šä¹‰åˆ—è¡¨å¼•å…¥äº†æ–°çš„å­—èŠ‚ç ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯å®ç°è¿™äº›å®šä¹‰åˆ—è¡¨æ‰€ç”¨çš„å­—èŠ‚ç ã€‚</p><pre><code class=\"language-plain\">&nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 (1)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 ('hello')\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 BUILD_LIST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6 STORE_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 (lst)\n\n&nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 LOAD_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 (print)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10 LOAD_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 (lst)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12 CALL_FUNCTION&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;14 POP_TOP\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 (None)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;18 RETURN_VALUE\n</code></pre><!-- [[[read_end]]] --><p>å®šä¹‰åˆ—è¡¨å¹¶æ‰“å°ï¼Œæ‰€ä½¿ç”¨çš„å­—èŠ‚ç å°±æ˜¯æˆ‘ä»¬ä¸Šé¢åˆ—å‡ºæ¥çš„ï¼Œå…¶ä¸­ç»å¤§éƒ¨åˆ†çš„å­—èŠ‚ç éƒ½å·²ç»å®ç°å¥½äº†ï¼Œå”¯ä¸€ä¸€ä¸ªæ–°çš„å­—èŠ‚ç æ˜¯ BUILD_LISTã€‚</p><p>åœ¨ BUILD_LIST ä¹‹å‰æœ‰ä¸¤ä¸ª LOAD_CONST æŒ‡ä»¤ï¼Œåˆ†åˆ«æŠŠæ•´æ•° 1ã€å­—ç¬¦ä¸² <code>â€œhelloâ€</code> é€åˆ°æ ˆé¡¶ã€‚ BUILD_LIST æŒ‡ä»¤æ˜¯å¸¦æœ‰å‚æ•°çš„ï¼Œå®ƒçš„å‚æ•°å°±ä»£è¡¨äº†æ“ä½œæ•°æ ˆä¸Šæœ‰å¤šå°‘ä¸ªå…ƒç´ æ˜¯åˆ—è¡¨ä¸­çš„å†…å®¹ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œå‚æ•°æ˜¯ 2ï¼Œè¿™å°±è¡¨ç¤ºæˆ‘ä»¬åº”è¯¥ä»æ ˆä¸Šå–å‡ºä¸¤ä¸ªå¯¹è±¡ï¼Œä»¥è¿™ä¸¤ä¸ªå¯¹è±¡ä¸ºå‚æ•°å»åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ—è¡¨ï¼Œå¹¶æŠŠè¿™ä¸ªåˆ—è¡¨å†æ”¾åˆ°æ“ä½œæ•°æ ˆé¡¶ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/772703\">ç¬¬ 5 èŠ‚è¯¾</a>ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªåŸºæœ¬çš„åˆ—è¡¨é›å½¢ï¼Œé‚£å°±æ˜¯ HiList ç±»ï¼Œä½†åœ¨<a href=\"https://time.geekbang.org/column/article/774409\">ç¬¬ 7 èŠ‚è¯¾</a>å¯¹ç±»å‹è¿›è¡Œé‡æ„çš„æ—¶å€™ï¼Œåªåšäº† HiInteger å’Œ HiString çš„é‡æ„å·¥ä½œï¼ŒHiList ç±»è¢«å¿½ç•¥äº†ã€‚HiList ç±»åŒ…å«äº†å¾ˆå¤šå†…å»ºæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©åœ¨å®ç°äº†å‡½æ•°å’Œæ–¹æ³•ä»¥åå†æ¥é‡æ„ HiListã€‚</p><p>é‡æ„çš„ç¬¬ä¸€æ­¥æ˜¯å¼•å…¥ ListKlassï¼Œä¸ºåˆ—è¡¨ç±»å¢åŠ ç±»å‹æ ‡å¿—ã€‚</p><pre><code class=\"language-c++\">class ListKlass : public Klass {\nprivate:\n&nbsp; &nbsp; ListKlass();\n&nbsp; &nbsp; static ListKlass* instance;\n\npublic:\n&nbsp; &nbsp; static ListKlass* get_instance();\n\n&nbsp; &nbsp; virtual void print(HiObject* obj);\n};\n\nclass HiList : public HiObject {\nfriend class ListKlass;\n\nprivate:\n&nbsp; &nbsp; ArrayList&lt;HiObject*&gt;* _inner_list;\n\npublic:\n&nbsp; &nbsp; HiList();\n&nbsp; &nbsp; HiList(ObjList ol);\n&nbsp; &nbsp; ArrayList&lt;HiObject*&gt;* inner_list()&nbsp; { return _inner_list; }\n\n&nbsp; &nbsp; int size()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { return _inner_list-&gt;size(); }\n&nbsp; &nbsp; void append(HiObject* obj)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { _inner_list-&gt;add(obj); }\n&nbsp; &nbsp; HiObject* pop()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ return _inner_list-&gt;pop(); }\n&nbsp; &nbsp; HiObject* get(int index)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { return _inner_list-&gt;get(index); }\n&nbsp; &nbsp; void&nbsp; &nbsp; &nbsp; set(int i, HiObject* o)&nbsp; &nbsp;{ _inner_list-&gt;set(i, o); }\n&nbsp; &nbsp; HiObject* top()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{ return get(size() - 1); }\n};\n</code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ç±»å‹ HiListï¼Œå®ƒæ˜¯ HiObject çš„å­ç±»ã€‚åœ¨ HiList ä¸­ï¼Œæœ‰ä¸€ä¸ªåŸŸ _inner_listï¼Œå®ƒçš„ç±»å‹æ˜¯ ArrayListã€‚æˆ‘ä»¬åœ¨ HiList ä¸­å®šä¹‰äº†å„ç§æ“ä½œï¼Œæœ€ç»ˆéƒ½è½¬åŒ–æˆäº†å¯¹ ArrayList çš„æ“ä½œã€‚è¿™äº›æ“ä½œåŒ…æ‹¬ï¼š</p><ol>\n<li>appendï¼šå‘åˆ—è¡¨çš„å°¾éƒ¨æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚</li>\n<li>popï¼šæŠŠåˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ åˆ é™¤ï¼Œå¹¶è¿”å›è¿™ä¸ªå…ƒç´ ã€‚</li>\n<li>getï¼šç»™å®šä¸‹æ ‡ï¼Œå–å‡ºåˆ—è¡¨ä¸­ç›¸åº”çš„å€¼ã€‚</li>\n<li>setï¼šç»™å®šä¸‹æ ‡ï¼ŒæŠŠåˆ—è¡¨ä¸­ç›¸åº”çš„å€¼è®¾ä¸ºè¾“å…¥å‚æ•°çš„å€¼ã€‚</li>\n<li>topï¼šå–åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä½†ä¸åˆ é™¤ã€‚</li>\n</ol><p>å¦‚ä½•æŠŠè¿™äº›æ–¹æ³•ä¸ Python å­—èŠ‚ç ç›¸è”ç³»æ˜¯ä¸‹èŠ‚è¯¾çš„ä¸»è¦ä»»åŠ¡ã€‚æˆ‘ä»¬è¿™èŠ‚è¯¾è¿˜æ˜¯æŠŠæ³¨æ„åŠ›é›†ä¸­åˆ° ListKlass çš„å®ç°ä¸Šã€‚åœ¨æˆ‘ä»¬çš„è®¾è®¡ç†å¿µä¸­ï¼Œæ‰€æœ‰ä¸ç±»å‹ç›¸å…³çš„æ“ä½œéƒ½ä¼šåœ¨ Klass ä¸­å®ç°ã€‚ä¸ºäº†æ”¯æŒæ‰“å°åˆ—è¡¨ï¼Œæˆ‘ä»¬è¦åœ¨ ListKlass ä¸­å®ç° HiList çš„ print æ–¹æ³•ã€‚</p><pre><code class=\"language-c++\">HiList::HiList() {\n&nbsp; &nbsp; set_klass(ListKlass::get_instance());\n&nbsp; &nbsp; _inner_list = new ArrayList&lt;HiObject*&gt;();\n}\n\nHiList::HiList(ObjList ol) {\n&nbsp; &nbsp; set_klass(ListKlass::get_instance());\n&nbsp; &nbsp; _inner_list = ol;\n}\n\nListKlass* ListKlass::instance = NULL;\n\nListKlass* ListKlass::get_instance() {\n&nbsp; &nbsp; if (instance == NULL)\n&nbsp; &nbsp; &nbsp; &nbsp; instance = new ListKlass();\n\n&nbsp; &nbsp; return instance;\n}\n\nListKlass::ListKlass() {\n}\n\nvoid ListKlass::print(HiObject* x) {\n&nbsp; &nbsp; HiList * lx = (HiList*)x;\n&nbsp; &nbsp; assert(lx &amp;&amp; lx-&gt;klass() == (Klass*) this);\n\n&nbsp; &nbsp; printf(\"[\");\n\n&nbsp; &nbsp; int size = lx-&gt;_inner_list-&gt;size();\n&nbsp; &nbsp; if (size &gt;= 1)\n&nbsp; &nbsp; &nbsp; &nbsp; lx-&gt;_inner_list-&gt;get(0)-&gt;print();\n\n&nbsp; &nbsp; for (int i = 1; i &lt; size; i++) {\n&nbsp; &nbsp; &nbsp; &nbsp; printf(\", \");\n&nbsp; &nbsp; &nbsp; &nbsp; lx-&gt;_inner_list-&gt;get(i)-&gt;print();\n&nbsp; &nbsp; }\n&nbsp; &nbsp; printf(\"]\");\n}\n</code></pre><p>ä¸Šè¿°ä»£ç å…ˆå®šä¹‰äº† HiList çš„æ„é€ æ–¹æ³•ï¼ˆç¬¬ 1 è‡³ 9 è¡Œï¼‰ã€‚åœ¨æ„é€ æ–¹æ³•é‡Œï¼ŒæŠŠ klass è®¾ç½®ä¸º ListKlassã€‚è¿™ä¸ªæ“ä½œå’Œ HiIntegerã€HiString ç­‰å¦‚å‡ºä¸€è¾™ï¼Œæˆ‘å°±ä¸å†è¯¦ç»†è§£é‡Šäº†ã€‚<br>\nç¬¬äºŒéƒ¨åˆ†å®ç°äº† ListKlass å•ä¾‹ç±»ï¼ˆç¬¬ 11 è¡Œè‡³ç¬¬ 21 è¡Œï¼‰ã€‚å…³äºå•ä¾‹æ¨¡å¼ï¼Œæˆ‘ä»¬ä¹Ÿåå¤ä½¿ç”¨å¤šæ¬¡äº†ï¼Œè¿™é‡Œä¹Ÿä¸å†è¿‡å¤šè§£é‡Šäº†ã€‚</p><p>æœ€åä¸€éƒ¨åˆ†å®šä¹‰äº† ListKlass çš„ print æ–¹æ³•ï¼ˆç¬¬ 23 è‡³ 38 è¡Œï¼‰ã€‚print æ–¹æ³•æ˜¯å®šä¹‰åœ¨ HiObject ä¸­çš„è™šæ–¹æ³•ã€‚ListKlass ä¸­çš„ print æ–¹æ³•ä»…ä»…æ˜¯ä¸ºäº†å®ç°å¯¹ HiList å¯¹è±¡çš„æ‰“å°ã€‚å®ƒçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæ‰“å°å·¦ä¸­æ‹¬å·ä»¥åï¼Œå°±æŠŠ list ä¸­çš„æ‰€æœ‰å…ƒç´ é€ä¸ªå–å‡ºå¹¶ä¸”è°ƒç”¨å®ƒçš„ print æ–¹æ³•ã€‚</p><p>åœ¨æ„å»ºå¥½äº† HiList è¿™ä¸ªåŸºç¡€è®¾æ–½ä»¥åï¼Œå­—èŠ‚ç  BUILD_LIST çš„å®ç°å°±æ°´åˆ°æ¸ æˆäº†ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸Šä¸€èŠ‚è¯¾å·²ç»å€ŸåŠ© HiList å®ç°äº†å…ƒç»„ï¼ˆtupleï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œå®Œå…¨å¯ä»¥å¤ç”¨ BUILD_TUPLE çš„é€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹å¯¹åº”çš„ä»£ç ã€‚</p><pre><code class=\"language-c++\">void Interpreter::run(CodeObject* codes) {\n&nbsp; &nbsp; _frame = new FrameObject(codes);\n&nbsp; &nbsp; while (_frame-&gt;has_more_codes()) {\n\t&nbsp; &nbsp; unsigned char op_code = _frame-&gt;get_op_code();\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; FunctionObject* fo;\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; switch (op_code) {\n\t\t...\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case ByteCode::BUILD_LIST:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case ByteCode::BUILD_TUPLE:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lst = new HiList();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while (op_arg--) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lst-&gt;set(op_arg, POP());\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><p>å°±åƒå‰é¢åˆ†æçš„ï¼ŒBUILD_LIST çš„å®ç°å°±æ˜¯æ–°å»ºä¸€ä¸ªåˆ—è¡¨ï¼ŒæŠŠæ ˆä¸Šçš„å…ƒç´ å–å‡ºæ¥ï¼Œæ”¾åˆ°åˆ—è¡¨ä¸­ï¼Œå†æŠŠè¿™ä¸ªåˆ—è¡¨æ”¾åˆ°æ ˆé¡¶ã€‚</p><p>ç¼–è¯‘å¹¶æ‰§è¡Œï¼Œå°±èƒ½çœ‹åˆ°è¿™èŠ‚è¯¾å¼€å§‹çš„ä¸¤è¡Œä»£ç å¯ä»¥æ­£ç¡®åœ°æ‰“å°äº†ã€‚</p><p>åˆ—è¡¨å¯¹è±¡ä¸Šå®šä¹‰äº†å¾ˆå¤šæ“ä½œï¼Œæœ€å…¸å‹çš„å°±æ˜¯æŸ¥æ‰¾ã€ä¿®æ”¹ã€å¢åŠ å’Œåˆ é™¤ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å°±åˆ†åˆ«æ¥ç ”ç©¶ä¸€ä¸‹ï¼Œå¦‚ä½•å®ç°è¿™äº›åŠŸèƒ½ã€‚</p><h2>åˆ—è¡¨çš„å–ä¸‹æ ‡æ“ä½œ</h2><p>åˆ—è¡¨å–ä¸‹æ ‡å¾ˆåƒ C è¯­è¨€ä¸­çš„æ•°ç»„ï¼Œå®ƒæ˜¯é€šè¿‡ä¸­æ‹¬å·è¯­æ³•è¿›è¡Œç´¢å¼•çš„ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-python\">lst = [\"hello\", \"world\"]\n\n# result is \"hello\"\nprint lst[0]\n</code></pre><p>ä½¿ç”¨ä¸­æ‹¬å·å’Œä¸‹æ ‡çš„å½¢å¼å–å¾—åˆ—è¡¨ä¸­çš„æŒ‡å®šå…ƒç´ ï¼Œè¿™ç§è¯­æ³•æˆ‘ä»¬æ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°ï¼Œæ‰€ä»¥å°±å¯ä»¥é€šè¿‡ show_file å·¥å…·è¿›è¡Œè§‚å¯Ÿï¼Œè¿™ç§æ•°ç»„ä¸‹æ ‡çš„è¯­æ³•ä¼šè¢«ç¿»è¯‘æˆæ€æ ·çš„å­—èŠ‚ç ã€‚</p><pre><code class=\"language-plain\">&nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 LOAD_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 (print)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10 LOAD_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 (lst)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 (0)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;14 BINARY_SUBSCR\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16 CALL_FUNCTION&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;18 POP_TOP\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;20 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 (None)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;22 RETURN_VALUE\n</code></pre><p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªæ–°çš„å­—èŠ‚ç ï¼šBINARY_SUBSCRï¼ˆç¬¬ 4 è¡Œï¼‰ã€‚åœ¨è¿™ä¸ªå­—èŠ‚ç ä¹‹å‰ï¼Œå·²ç»æŠŠåˆ—è¡¨ lst å’Œæ•´æ•° 0 åŠ è½½åˆ°äº†æ ˆé¡¶ï¼ˆç¬¬ 1 è¡Œå’Œç¬¬ 2 è¡Œï¼‰ã€‚</p><p>BINARY_SUBSCRçš„æ„ä¹‰æ˜¯å–å‡ºåˆ—è¡¨ lst çš„ç¬¬ 0 é¡¹ï¼Œå¹¶æŠŠç»“æœé€å…¥æ ˆé¡¶ã€‚è¿™ä¸ªå­—èŠ‚ç æ˜¯ subscript çš„ç¼©å†™ã€‚</p><p>å®é™…ä¸Šï¼Œé™¤äº†åˆ—è¡¨æœ‰å–ä¸‹æ ‡æ“ä½œä»¥å¤–ï¼Œstring å¯¹è±¡ä¹Ÿæ”¯æŒå–ä¸‹æ ‡æ“ä½œã€‚æœªæ¥ï¼Œæˆ‘ä»¬è¿˜ä¼šé‡åˆ°è‡ªå®šä¹‰ç±»å‹ä¸­ä¹Ÿå¯ä»¥æ”¯æŒå–ä¸‹æ ‡æ“ä½œã€‚å› æ­¤ï¼Œè¿™å°±æœ‰å¿…è¦åœ¨ HiObject å¯¹è±¡ä½“ç³»ä¸­å¼•å…¥å–ä¸‹æ ‡æ“ä½œäº†ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥å®šä¹‰ HiObject ä¸­çš„ subscr æ–¹æ³•ï¼Œç„¶åå†æ‰©å±•åˆ° HiList å’Œ HiString ç±»ä¸­å»ã€‚</p><pre><code class=\"language-c++\">// object/hiObject.hpp\nclass HiObject {\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; HiObject* subscr(HiObject* x);\n};\n\n// object/hiObject.cpp\nHiObject* HiObject::subscr(HiObject* x) {\n&nbsp; &nbsp; return klass()-&gt;subscr(this, x);\n}\n</code></pre><p>åœ¨ Object ç±»ä¸­ï¼Œæˆ‘ä»¬æŠŠ subscr çš„çœŸæ­£å®ç°è½¬ç§»åˆ°å®ƒçš„ Klass ä¸­å»äº†ã€‚åœ¨ Klass ä¸­ï¼Œsubscr ä¼šæ˜¯ä¸€ä¸ªè™šå‡½æ•°ï¼Œé€šè¿‡è™šå‡½æ•°æœºåˆ¶ä¿è¯äº†ä¸åŒç±»å‹çš„å¯¹è±¡å¯ä»¥è°ƒç”¨ç›¸åº”çš„ subscr æ–¹æ³•ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹list ç±»å‹çš„å®ç°ã€‚</p><pre><code class=\"language-c++\">// object/klass.hpp\nclass Klass {\nprivate:\n&nbsp; &nbsp; ...\npublic:\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; virtual HiObject* subscr&nbsp; &nbsp;(HiObject* x, HiObject* y) { return 0; }\n};\n\n// object/hiList.hpp\nclass ListKlass : public Klass {\nprivate:\n&nbsp; &nbsp; ...\npublic:\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; virtual HiObject* subscr (HiObject* x, HiObject* y);\n};\n\n// object/hiList.cpp\nHiObject* ListKlass::subscr(HiObject* x, HiObject* y) {\n&nbsp; &nbsp; assert(x &amp;&amp; x-&gt;klass() == (Klass*) this);\n&nbsp; &nbsp; assert(y &amp;&amp; y-&gt;klass() == (Klass*) IntegerKlass::get_instance());\n\n&nbsp; &nbsp; HiList * lx = (HiList*)x;\n&nbsp; &nbsp; HiInteger* iy = (HiInteger*)y;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; return lx-&gt;inner_list()-&gt;get(iy-&gt;value());\n}\n</code></pre><p>è¿™æ®µä»£ç ä¸»è¦æ˜¯æè¿°äº† Klass çš„æ¶æ„è®¾è®¡ï¼ŒçœŸæ­£åœ¨åˆ—è¡¨ä¸­å–å€¼çš„åªæœ‰ç¬¬ 27 è¡Œè€Œå·²ã€‚ListKlass çš„ subscr å‡½æ•°æ£€æŸ¥äº†ç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ ‡ï¼Œåœ¨ list ä¸­å®ƒå¿…é¡»æ˜¯æ•´å‹ï¼ˆç¬¬ 22 è¡Œï¼‰ã€‚</p><p>å¦‚æœä¸æ˜¯æ•´å‹çš„è¯ï¼Œassert è¯­å¥å°±ä¸èƒ½æˆåŠŸï¼Œè™šæ‹Ÿæœºä¼šç›´æ¥é€€å‡ºã€‚å®é™…ä¸Šï¼ŒPython çš„æ­£ç¡®è¡Œä¸ºæ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œç”±äºç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰å®ç°å¼‚å¸¸æœºåˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œå°±å…ˆé‡‡ç”¨æŠ¥é”™é€€å‡ºè¿™ç§å¤„ç†æ–¹å¼ã€‚é™¤æ­¤ä¹‹å¤–çš„å…¶ä»–ä»£ç éƒ½æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å†è§£é‡Šäº†ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬è¿˜è¦åœ¨ Interpreter ä¸­æ·»åŠ  BINARY_SUBSCR çš„å®ç°ï¼Œåªéœ€è¦æŠŠæ ˆé¡¶çš„ä¸¤ä¸ªå¯¹è±¡å–å‡ºæ¥ï¼Œå†ä»¥ç¬¬ä¸€ä¸ªå¯¹è±¡ä¸ºå‚æ•°ï¼Œè°ƒç”¨ç¬¬äºŒä¸ªå¯¹è±¡çš„ subscr æ–¹æ³•å³å¯ã€‚</p><pre><code class=\"language-c++\">void Interpreter::run(CodeObject* codes) {\n&nbsp; &nbsp; _frame = new FrameObject(codes);\n&nbsp; &nbsp; while (_frame-&gt;has_more_codes()) {\n\t&nbsp; &nbsp; unsigned char op_code = _frame-&gt;get_op_code();\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; FunctionObject* fo;\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; switch (op_code) {\n\t\t...\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case ByteCode::BINARY_SUBSCR:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = POP();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = POP();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH(w-&gt;subscr(v));\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œè¿™èŠ‚è¯¾å¼€å§‹çš„é‚£ä¸ªæµ‹è¯•ä»£ç å°±å¯ä»¥æ­£ç¡®æ‰§è¡Œäº†ã€‚</p><p>åœ¨å®Œæˆäº† list çš„ subscr æ“ä½œä¹‹åï¼Œä¸º string æ·»åŠ ç›¸åº”çš„æ“ä½œå°±å¾ˆç®€å•äº†ã€‚æ•´ä¸ªæµç¨‹çš„æ¡†æ¶å·²ç»æ­å»ºèµ·æ¥äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ StringKlass ä¸­æ·»åŠ  subscr å³å¯ã€‚</p><pre><code class=\"language-c++\">// object/hiString.hpp\nclass StringKlass : public Klass {\nprivate:\n&nbsp; &nbsp; ...\npublic:\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; virtual HiObject* subscr (HiObject* x, HiObject* y);\n};\n\n// object/hiString.cpp\nHiObject* StringKlass::subscr(HiObject* x, HiObject* y) {\n&nbsp; &nbsp; assert(x &amp;&amp; x-&gt;klass() == (Klass*) this);\n&nbsp; &nbsp; assert(y &amp;&amp; y-&gt;klass() == (Klass*) IntegerKlass::get_instance());\n\n&nbsp; &nbsp; HiString * sx = (HiString*)x;\n&nbsp; &nbsp; HiInteger* iy = (HiInteger*)y;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; return new HiString(&amp;(sx-&gt;value()[iy-&gt;value()]), 1);\n}\n</code></pre><p>å­—ç¬¦ä¸²çš„å–ä¸‹æ ‡æ“ä½œä¸åˆ—è¡¨çš„å–ä¸‹æ ‡æ“ä½œå‡ ä¹ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºä¸¤è€…çš„ subscr æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸åŒã€‚</p><p>åˆ—è¡¨çš„å–ä¸‹æ ‡æ“ä½œçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œè€Œå­—ç¬¦ä¸²çš„è¿”å›å€¼åˆ™æ˜¯å¦ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨ StringKlass ä¸­å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ string å¯¹è±¡ã€‚æˆ‘ä»¬ä½¿ç”¨äº†å¸¦æœ‰é•¿åº¦å‚æ•°çš„æ„é€ æ–¹æ³•æ¥åˆ›å»ºè¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼ˆç¬¬ 18 è¡Œï¼‰ã€‚è¿™ä¸ªæ„é€ æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://time.geekbang.org/column/article/774409\">ç¬¬ 7 èŠ‚è¯¾</a>å­—ç¬¦ä¸²çš„å®ç°éƒ¨åˆ†ã€‚</p><p>åˆ°è¿™é‡Œï¼Œå–ä¸‹æ ‡æ“ä½œå°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å®ç°åœ¨åˆ—è¡¨ä¸­æŸ¥æ‰¾å…ƒç´ çš„åŠŸèƒ½ã€‚</p><h2>åˆ¤æ–­åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å«æŸå…ƒç´ </h2><p>åœ¨ Python ä¸­ï¼ŒæŸ¥æ‰¾åˆ—è¡¨æ˜¯å¦åŒ…å«äº†æŸä¸ªå¯¹è±¡ï¼Œé€šå¸¸ä½¿ç”¨ in å…³é”®å­—ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-python\">l = [\"hello\", \"world\"]\n\nif \"hello\" in l:\n&nbsp; &nbsp; # this statement will be executed\n&nbsp; &nbsp; print \"yes\"\nelse:\n&nbsp; &nbsp; print \"no\"\n</code></pre><p>ä½¿ç”¨ in å…³é”®å­—å¯ä»¥åˆ¤æ–­ <code>â€œhelloâ€</code> æ˜¯å¦åœ¨åˆ—è¡¨ä¸­ã€‚å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨ show_file å·¥å…·æŸ¥çœ‹è¿™ä¸ªä¾‹å­çš„å­—èŠ‚ç ã€‚</p><pre><code class=\"language-plain\">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;...\n&nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 ('hello')\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;15 LOAD_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 (l)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;18 COMPARE_OP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 (in)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;21 POP_JUMP_IF_FALSE&nbsp; &nbsp; &nbsp; &nbsp;32\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;...\n</code></pre><p>æ³¨æ„ç¬¬ 4 è¡Œçš„å­—èŠ‚ç  COMPARE_OPã€‚åœ¨<a href=\"https://time.geekbang.org/column/article/772703\">ç¬¬ 5 èŠ‚è¯¾</a>å®ç°æ§åˆ¶æµçš„æ—¶å€™ï¼Œè¿™ä¸ªå­—èŠ‚ç å°±å·²ç»å¾—åˆ°æ”¯æŒäº†ï¼Œå®ƒå¯ä»¥å¯¹ä¸¤ä¸ªå¯¹è±¡è¿›è¡Œåˆ¤æ–­ç›¸ç­‰ã€æ¯”è¾ƒå¤§å°ç­‰æ“ä½œã€‚</p><p>COMPARE_OP å­—èŠ‚ç æ˜¯å¸¦æœ‰å‚æ•°çš„ï¼Œå®ƒçš„å‚æ•°ç”¨äºæŒ‡å®šæ¯”è¾ƒæ“ä½œç¬¦çš„ç±»å‹ï¼Œæ¯”å¦‚ 4 å°±ä»£è¡¨å¤§äºï¼Œ0 ä»£è¡¨å°äºï¼Œ2 ä»£è¡¨ç­‰äºã€‚è¿™èŠ‚è¯¾ COMPARE_OP å¸¦äº†ä¸€ä¸ªæ–°çš„å‚æ•°ï¼š6ã€‚æ‹¬å·é‡Œçš„æ³¨é‡Šä¹Ÿæ ‡æ˜äº†ï¼Œè¿™ä¸ªå‚æ•°ä»£è¡¨ inã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å°±è¦åœ¨ COMPARE_OP ä¸­å®ç° in æ¯”è¾ƒæ“ä½œã€‚</p><pre><code class=\"language-c++\">void Interpreter::run(CodeObject* codes) {\n&nbsp; &nbsp; _frame = new FrameObject(codes);\n&nbsp; &nbsp; while (_frame-&gt;has_more_codes()) {\n\t&nbsp; &nbsp; unsigned char op_code = _frame-&gt;get_op_code();\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; switch (op_code) {\n\t\t...\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case ByteCode::COMPARE_OP:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = POP();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = POP();\n\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; switch(op_arg) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case ByteCode::IN:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PUSH(w-&gt;contains(v));\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf(\"Error: Unrecognized compare op %d\\n\", op_arg);\n\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><p>å’Œå–ä¸‹æ ‡ä»¥åŠæ¯”è¾ƒæ˜¯å¦ç›¸ç­‰çš„æ“ä½œä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ w çš„ contains æ–¹æ³•æ¥åˆ¤æ–­ w ä¸­æ˜¯å¦å«æœ‰ vã€‚</p><p>not in çš„å®ç°å°±äº¤ç»™ä½ è‡ªå·±äº†ï¼Œåªéœ€è¦æŠŠ contains çš„è¿”å›è¿›è¡Œå–åæ“ä½œå°±å¯ä»¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ contains ä¸º Trueï¼Œå°±å¾€æ ˆé¡¶é€å…¥ Falseï¼Œå¦‚æœ contains çš„è¿”å›å€¼ä¸º Falseï¼Œå°±å¾€æ ˆé¡¶é€å…¥ Trueã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä» HiObject å¼€å§‹å¢åŠ  contains æ–¹æ³•ï¼Œæ€è·¯å’Œæ­¥éª¤ä¸ä¹‹å‰æ·»åŠ  subscr æ˜¯ä¸€æ ·çš„ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">// object/hiObject.hpp\nclass HiObject {\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; HiObject* subscr(HiObject* x);\n\tHiObject* contains(HiObject* x);\n};\n\n// object/hiObject.cpp\nHiObject* HiObject::contains(HiObject* x) {\n&nbsp; &nbsp; return klass()-&gt;contains(this, x);\n}\n\n// object/klass.hpp\nclass Klass {\nprivate:\n&nbsp; &nbsp; ...\npublic:\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; virtual HiObject* contains (HiObject* x, HiObject* y) { return 0; }\n};\n</code></pre><p>ç„¶åï¼Œåœ¨ ListKlass ä¸­ï¼Œæ·»åŠ  contains æ–¹æ³•çš„å…·ä½“å®ç°ã€‚</p><pre><code class=\"language-c++\">// object/hiList.hpp\nclass ListKlass : public Klass {\nprivate:\n&nbsp; &nbsp; ...\npublic:\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; virtual HiObject* contains (HiObject* x, HiObject* y);\n};\n\n// object/hiList.cpp\nHiObject* ListKlass::contains(HiObject* x, HiObject* y) {\n&nbsp; &nbsp; HiList * lx = (HiList*)x;\n&nbsp; &nbsp; assert(lx &amp;&amp; lx-&gt;klass() == (Klass*) this);\n\n&nbsp; &nbsp; int size = lx-&gt;_inner_list-&gt;size();\n&nbsp; &nbsp; for (int i = 1; i &lt; size; i++) {\n&nbsp; &nbsp; &nbsp; &nbsp; if (lx-&gt;_inner_list-&gt;get(i)-&gt;equal(y))\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return Universe::HiTrue;\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; return Universe::HiFalse;\n}\n</code></pre><p>contains æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘æ˜¯éå†æ•´ä¸ª listï¼Œå¯¹äºå®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½ä¸å‚æ•° y è¿›è¡Œæ¯”è¾ƒï¼ŒæŸ¥çœ‹å®ƒä»¬æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœç›¸ç­‰ï¼Œå°±è¿”å› Trueï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œå°±åœ¨æ–¹æ³•çš„ç»“å°¾è¿”å› Falseã€‚</p><p>æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨ equal æ–¹æ³•æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦ç›¸ç­‰ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ klass ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªè™šå‡½æ•°ã€‚æ¯”è¾ƒç›¸ç­‰çš„å…·ä½“é€»è¾‘éƒ½å°è£…åœ¨ç›¸åº”ç±»å‹çš„ klass ä¸­äº†ã€‚ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹<a href=\"https://time.geekbang.org/column/article/772703\">ç¬¬ 5 èŠ‚è¯¾</a>å’Œ<a href=\"https://time.geekbang.org/column/article/774409\">ç¬¬ 7 èŠ‚è¯¾</a>çš„ç›¸å…³å†…å®¹è¿›è¡Œå¤ä¹ ã€‚</p><p>å­—ç¬¦ä¸²ç±»å‹ä¹Ÿæ”¯æŒ in æ¯”è¾ƒï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-python\">if \"lo\" in \"hello\":\n&nbsp; &nbsp; # this statement will be executed\n&nbsp; &nbsp; print(\"yes\")\nelse:\n&nbsp; &nbsp; print(\"no\")\n</code></pre><p>åœ¨å­—ç¬¦ä¸²é‡Œæ·»åŠ  contains æ–¹æ³•ï¼Œç›¸ä¿¡ä½ å·²ç»å¯ä»¥é©¾è½»å°±ç†Ÿäº†ï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸å†é‡å¤äº†ï¼Œä½ å¯ä»¥è‡ªå·±åŠ¨æ‰‹å°è¯•ä¸€ä¸‹ã€‚</p><p>åˆ¤æ–­åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å«æŸä¸€å…ƒç´ çš„åŠŸèƒ½å°±å®ç°å®Œäº†ã€‚å¯¹äºä¸€ä¸ªæ•°æ®ç»“æ„æ¥è¯´ï¼Œæ”¯æŒå¢åˆ æŸ¥æ”¹çš„æ“ä½œæ˜¯å¿…é¡»å…·å¤‡çš„èƒ½åŠ›ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šä¾æ¬¡å®ç°è¿™äº›åŠŸèƒ½ã€‚</p><h2>å‘åˆ—è¡¨ä¸­æ·»åŠ å…ƒç´ </h2><p>å¾€åˆ—è¡¨ä¸­æ·»åŠ å…ƒç´ æœ‰ä¸¤ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯è°ƒç”¨ append æ–¹æ³•ï¼Œå¦ä¸€ä¸ªæ˜¯è°ƒç”¨ insert æ–¹æ³•ã€‚æˆ‘ä»¬å…ˆæ¥å®ç° append æ–¹æ³•ã€‚</p><p>å…ˆæ¥å†™ä¸€ä¸ª append æ–¹æ³•çš„æµ‹è¯•ç”¨ä¾‹ã€‚</p><pre><code class=\"language-python\">l = []\nl.append(0)\nprint l\n</code></pre><p>åœ¨ä½¿ç”¨ show_file å·¥å…·æŸ¥çœ‹å­—èŠ‚ç ä¹‹å‰ï¼Œä½ å¯ä»¥è¯•ç€è‡ªå·±æ¨æ–­ä¸€ä¸‹ï¼Œè¿™æ®µä»£ç æ‰€å¯¹åº”çš„å­—èŠ‚ç æ˜¯ä»€ä¹ˆã€‚ç„¶åå†æ¥æ ¸æŸ¥è‡ªå·±çš„æ¨æµ‹æ˜¯ä¸æ˜¯æ­£ç¡®ã€‚append æ–¹æ³•çš„è°ƒç”¨ä¼šè¢«ç¿»è¯‘æˆä»¥ä¸‹å­—èŠ‚ç ï¼š</p><pre><code class=\"language-plain\">&nbsp; 2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 LOAD_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 (lst)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6 LOAD_METHOD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 (append)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 (1)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10 CALL_METHOD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;12 POP_TOP\n</code></pre><p>è¿™äº›å­—èŠ‚ç éƒ½å·²ç»å®ç°è¿‡äº†ã€‚è¿™é‡Œåªè¦å†ä¸º List ç±»å‹å¢åŠ  append æ–¹æ³•å³å¯ã€‚å¯¹ç…§åœ¨<a href=\"https://time.geekbang.org/column/article/778919\">ç¬¬ 12 èŠ‚è¯¾</a>ä¸ºå­—ç¬¦ä¸²å¢åŠ  upper æ–¹æ³•çš„è¿‡ç¨‹ï¼Œlist çš„ append æ–¹æ³•æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</p><p>é¦–å…ˆï¼Œå®Œæˆ append æ–¹æ³•çš„å®šä¹‰ã€‚</p><pre><code class=\"language-c++\">// object/hiList.hpp\nHiObject* list_append(ObjList args);\n\n// object/hiList.cpp\nHiObject* list_append(ObjList args) {\n&nbsp; &nbsp; ((HiList*)(args-&gt;get(0)))-&gt;append(args-&gt;get(1));\n&nbsp; &nbsp; return Universe::HiNone;\n}\n</code></pre><p>list_append æ–¹æ³•æ‰€æ¥å—çš„å‚æ•°å’Œ string_upper ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª ArrayListã€‚ArrayList çš„ç¬¬ä¸€é¡¹ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯è¦æ·»åŠ å…ƒç´ çš„åˆ—è¡¨ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¾…æ·»åŠ çš„å…ƒç´ ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯ Noneã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦æŠŠå®ƒæ”¾åˆ° ListKlass çš„ klass_dict ä¸­å»ã€‚åªéœ€è¦åœ¨ ListKlass çš„æ„é€ æ–¹æ³•ä¸­æ·»åŠ  klass_dict çš„åˆå§‹åŒ–é€»è¾‘å³å¯ã€‚</p><pre><code class=\"language-c++\">ListKlass::ListKlass() {\n&nbsp; &nbsp; HiDict * klass_dict = new HiDict();\n&nbsp; &nbsp; klass_dict-&gt;put(new HiString(\"append\"),&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; new FunctionObject(list_append));\n&nbsp; &nbsp; set_klass_dict(klass_dict);\n}\n</code></pre><p>é€šè¿‡è¿™ç§æ–¹å¼å°±æŠŠå­—ç¬¦ä¸² <code>â€œappendâ€</code> ä¸å†…å»ºæ–¹æ³•è”ç³»äº†èµ·æ¥ã€‚å½“è™šæ‹Ÿæœºæ‰§è¡Œåˆ°äº† LOAD_METHOD æ—¶ï¼Œå°±é€šè¿‡å­—ç¬¦ä¸²æŸ¥æ‰¾åˆ°äº† list_append æ‰€å¯¹åº”çš„ FunctionObjectã€‚ç„¶åï¼Œåœ¨ HiObject çš„ getattr æ–¹æ³•ä¸­ï¼Œåˆ—è¡¨å¯¹è±¡ä¼šä¸ append æ–¹æ³•ç»‘å®šåœ¨ä¸€èµ·ï¼Œç”Ÿæˆä¸€ä¸ª MethodObjectã€‚</p><p>æ‰€ä»¥ï¼Œå½“æ‰§è¡Œåˆ° CALL_METHOD æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šç”¨è¿™ä¸ªç»è¿‡ç»‘å®šçš„ MethodObjectï¼Œè¿›ä¸€æ­¥å°±ä¼šè°ƒç”¨ Interpreter::build_frame æ–¹æ³•ã€‚åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬å¯¹ MethodObject åšäº†æ­£ç¡®çš„å¤„ç†ã€‚</p><p>ç»è¿‡è¿™æ ·çš„æ¨æ¼”ï¼Œæˆ‘ä»¬å°±çŸ¥é“è¿™ä¸ªè¿‡ç¨‹æ˜¯å®Œæ•´çš„äº†ã€‚ç¼–è¯‘æ‰§è¡Œï¼Œè¿™èŠ‚è¯¾å¼€å§‹å¤„çš„æµ‹è¯•ç”¨ä¾‹å°±å¯ä»¥æ­£ç¡®æ‰§è¡Œã€‚</p><p>å¾€åˆ—è¡¨ä¸­æ·»åŠ å…ƒç´ çš„ç¬¬äºŒç§æ–¹æ³•æ˜¯ insert æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-python\">l = [1, 2]\nl.insert(0, 3)\n# result is [3, 1, 2]\nprint(l)&nbsp;\n</code></pre><p>insert æ–¹æ³•ä¸ append æ–¹æ³•åœ¨åŸç†ä¸Šå¹¶æ— äºŒè‡´ã€‚ä½œä¸ºç»ƒä¹ ï¼Œå°±ç•™ç»™ä½ è‡ªè¡Œæ·»åŠ ã€‚</p><h2>ä¿®æ”¹åˆ—è¡¨ä¸­çš„å…ƒç´ </h2><p>ä¿®æ”¹åˆ—è¡¨ä¸­çš„å…ƒç´ ä¸ C è¯­è¨€ä¸­çš„æ•°ç»„æ“ä½œç›¸åŒï¼Œæ˜¯ä½¿ç”¨å–ä¸‹æ ‡æ“ä½œç¬¦å’Œèµ‹å€¼æ“ä½œå®Œæˆçš„ã€‚ä¾‹å¦‚ï¼š</p><pre><code class=\"language-python\">l = [1, 2]\nl[0] = 3\n# result is [3, 2]\nprint(l)\n</code></pre><p>ä¿®æ”¹å…ƒç´ ä¸æ·»åŠ å…ƒç´ ä¸åŒï¼Œä¸å†æ˜¯ä½¿ç”¨å†…å»ºæ–¹æ³•æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½äº†ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€ç§æ–°çš„è¯­æ³•ã€‚å¾€å¾€æ–°çš„è¯­æ³•æ‰€å¯¹åº”çš„æ˜¯æ–°çš„å­—èŠ‚ç ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥éªŒè¯ä¸Šè¿°ä¾‹å­æ‰€å¯¹åº”çš„å­—èŠ‚ç ï¼š</p><pre><code class=\"language-plain\">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;...\n&nbsp;12&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 (3)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;15 LOAD_NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 (l)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;18 LOAD_CONST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 (0)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;21 STORE_SUBSCR\n\t\t\t ...\n</code></pre><p>æ­£å¦‚æˆ‘ä»¬æ‰€é¢„æ–™çš„ï¼Œåœ¨ç¬¬ 5 è¡Œå‡ºç°äº†ä¸€ä¸ªæ–°çš„å­—èŠ‚ç ï¼š<strong>STORE_SUBSCR</strong>ã€‚è¿™ä¸ªå­—èŠ‚ç å’Œ BINARY_SUBSCR æ­£å¥½æ˜¯ä¸€å¯¹ç›¸å¯¹åº”çš„æ“ä½œï¼Œä¸€ä¸ªæ˜¯ç”¨äºå–åˆ—è¡¨å…ƒç´ ï¼Œä¸€ä¸ªæ˜¯ç”¨äºä¿®æ”¹åˆ—è¡¨å…ƒç´ ã€‚</p><p>é™¤äº†åˆ—è¡¨æ”¯æŒä¿®æ”¹åˆ—è¡¨å…ƒç´ çš„æ“ä½œä¹‹å¤–ï¼Œç¬¬ 15 èŠ‚è¯¾è¦è®²çš„å­—å…¸ç±»å‹ä¹Ÿæ”¯æŒè¿™ä¸ªæ“ä½œï¼Œå¦å¤–ï¼Œè‡ªå®šä¹‰ç±»å‹ä¹Ÿå¯ä»¥é‡è½½è¿™ä¸ªæ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰å¿…è¦åœ¨ HiObject ç±»å‹ä¸­å¢åŠ å…ƒç´ ä¿®æ”¹çš„æ“ä½œã€‚</p><pre><code class=\"language-c++\">// object/hiObject.hpp\nclass HiObject {\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; HiObject* subscr(HiObject* x);\n&nbsp; &nbsp; void&nbsp; &nbsp; &nbsp; store_subscr(HiObject* x, HiObject* y);&nbsp;\n&nbsp; &nbsp; HiObject* contains(HiObject* x);\n};\n\n// object/hiObject.cpp\nvoid HiObject::store_subscr(HiObject* x, HiObject* y) {\n&nbsp; &nbsp; klass()-&gt;store_subscr(this, x, y);\n}\n</code></pre><p>ä¸å‰è¾¹æ·»åŠ  subscr å’Œ contains æ–¹æ³•ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨ HiObject ç±»çš„ store_subscr æ–¹æ³•ä¸­ï¼Œç›´æ¥è°ƒç”¨å®ƒæ‰€å¯¹åº”çš„ klass çš„ store_subscr æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦åœ¨ klass ä¸­æ·»åŠ  store_subscr æ–¹æ³•ã€‚</p><pre><code class=\"language-c++\">// object/klass.hpp\nclass Klass {\nprivate:\n&nbsp; &nbsp; ...\npublic:\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; virtual void store_subscr&nbsp; (HiObject* x, HiObject* y, HiObject* z) { return; }\n};\n\n// object/hiList.hpp\nclass ListKlass : public Klass {\nprivate:\n&nbsp; &nbsp; ...\npublic:\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; virtual void store_subscr (HiObject* x, HiObject* y, HiObject* z);\n};\n\n// object/hiList.cpp\nvoid ListKlass::store_subscr(HiObject* x, HiObject* y, HiObject* z) {\n&nbsp; &nbsp; assert(x &amp;&amp; x-&gt;klass() == (Klass*) this);\n&nbsp; &nbsp; assert(y &amp;&amp; y-&gt;klass() == IntegerKlass::get_instance());\n\n&nbsp; &nbsp; HiList * lx = (HiList*)x;\n&nbsp; &nbsp; HiInteger* iy = (HiInteger*)y;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; lx-&gt;inner_list()-&gt;set(iy-&gt;value(), z);\n}\n</code></pre><p>ListKlass çš„ store_subscr æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨è¦ä¿®æ”¹çš„åˆ—è¡¨ï¼Œç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨ä¸‹æ ‡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä»£è¡¨çœŸæ­£çš„ç›®æ ‡å¯¹è±¡ã€‚</p><p>store_subscr çš„ä¸»è¦é€»è¾‘æ˜¯å¾ˆç®€å•çš„ï¼Œå®ƒåªæ˜¯è°ƒç”¨äº† inner_list çš„ set æ–¹æ³•ï¼ŒæŠŠç›¸åº”åºå·çš„å…ƒç´ è®¾ä¸º zã€‚æœ€åï¼Œè¦å®ç°çš„å­—èŠ‚ç  STORE_SUBSCR ä¹Ÿå°±æ°´åˆ°æ¸ æˆäº†ã€‚</p><pre><code class=\"language-c++\">void Interpreter::run(CodeObject* codes) {\n&nbsp; &nbsp; _frame = new FrameObject(codes);\n\tHiObject *v, *w, *u;\n\t...\n&nbsp; &nbsp; while (_frame-&gt;has_more_codes()) {\n\t&nbsp; &nbsp; unsigned char op_code = _frame-&gt;get_op_code();\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; switch (op_code) {\n\t\t...\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case ByteCode::STORE_SUBSCR:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u = POP();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v = POP();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; w = POP();\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v-&gt;store_subscr(u, w);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; &nbsp; &nbsp; ...\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n</code></pre><p>è¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡é‡åˆ°ä¸€ä¸ªä¸å¸¦å‚æ•°çš„å­—èŠ‚ç å…³ç³»åˆ°ä¸‰ä¸ªå¯¹è±¡çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸€å®šè¦æ³¨æ„ä¸‰ä¸ªå‚æ•°çš„é¡ºåºï¼Œä¸è¦æé”™äº†ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±èƒ½æ­£ç¡®åœ°æ‰§è¡Œè¿™éƒ¨åˆ†å¼€å§‹çš„é‚£ä¸ªä¾‹å­äº†ã€‚</p><h2>åœ¨åˆ—è¡¨ä¸­æŸ¥æ‰¾å…ƒç´ </h2><p>æŸ¥æ‰¾å…ƒç´ æœ¬è´¨ä¸Šä¸åˆ¤æ–­åˆ—è¡¨æ˜¯å¦åŒ…å«ç‰¹å®šå…ƒç´ çš„æ“ä½œæ˜¯ä¸€æ ·çš„ã€‚ä¸åŒä¹‹å¤„åœ¨äºæŸ¥æ‰¾å…ƒç´ çš„æ“ä½œï¼Œå…¶è¿”å›å€¼æ˜¯è¿™ä¸ªå…ƒç´ åœ¨åˆ—è¡¨ä¸­çš„åºå·ï¼Œå¦‚æœå…ƒç´ ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼ˆValueErrorï¼‰ã€‚è€Œåˆ¤æ–­æ˜¯å¦åŒ…å«æ“ä½œçš„è¿”å›å€¼æ˜¯å¸ƒå°”å‹ã€‚</p><p>åœ¨åˆ—è¡¨ä¸­æŸ¥æ‰¾å…ƒç´ çš„ä½ç½®ï¼Œéœ€ä½¿ç”¨ index æ–¹æ³•ã€‚ä¸ append æ–¹æ³•ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿé‡‡ç”¨å†…å»ºæ–¹æ³•æ¥å®ç°å®ƒã€‚å…ˆæ¥å®šä¹‰ä¸€ä¸ªåä¸º list_index çš„æ–¹æ³•ã€‚</p><pre><code class=\"language-c++\">HiObject* list_index(ObjList args) {\n&nbsp; &nbsp; HiList* list = (HiList*)(args-&gt;get(0));\n&nbsp; &nbsp; HiObject* target = (HiObject*)(args-&gt;get(1));\n\n&nbsp; &nbsp; assert(list &amp;&amp; list-&gt;klass() == ListKlass::get_instance());\n\n&nbsp; &nbsp; for (int i = 0; i &lt; list-&gt;inner_list()-&gt;size(); i++) {\n&nbsp; &nbsp; &nbsp; &nbsp; if (list-&gt;get(i)-&gt;equal(target) == (HiObject*)Universe::HiTrue) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return new HiInteger(i);\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; return NULL;\n}\n</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘æ˜¯éå†åˆ—è¡¨çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼ŒæŠŠå®ƒä¸ç›®æ ‡å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœ equal æ–¹æ³•çš„è¿”å›å€¼ä¸º Trueï¼Œå°±è®¤ä¸ºåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°ç›®æ ‡å…ƒç´ ã€‚ç„¶åæŠŠç›®æ ‡å…ƒç´ çš„åºå·è¿”å›ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåº”è¯¥æŠ›å‡ºå¼‚å¸¸ï¼Œç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰å®ç°å¼‚å¸¸ï¼Œè¿™é‡Œå…ˆä½¿ç”¨ç©ºè¿”å›å€¼ä»£æ›¿ã€‚</p><p>æœ€ååªéœ€è¦åœ¨ ListKlass çš„æ„é€ å‡½æ•°é‡ŒæŠŠå­—ç¬¦ä¸² <code>â€œindexâ€</code> ä¸ <code>list_index</code> æ–¹æ³•å…³è”èµ·æ¥å°±å¯ä»¥äº†ã€‚</p><pre><code class=\"language-c++\">ListKlass::ListKlass() {\n&nbsp; &nbsp; HiDict * klass_dict = new HiDict();\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; klass_dict-&gt;put(new HiString(\"index\"),&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; new FunctionObject(list_index));\n&nbsp; &nbsp; ...\n&nbsp; &nbsp; set_klass_dict(klass_dict);\n}\n</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±æŠŠåˆ—è¡¨çš„å¢ã€æ”¹ã€æŸ¥çš„åŠŸèƒ½å®ç°äº†ã€‚ä¸‹èŠ‚è¯¾æˆ‘ä»¬ä¼šç»§ç»­å®ç°åˆ é™¤å…ƒç´ çš„åŠŸèƒ½ã€‚</p><h2>æ€»ç»“</h2><p>åˆ—è¡¨å’Œå­—å…¸æ˜¯ Python è™šæ‹Ÿæœºä¸­ä¸¤ä¸ªæ ¸å¿ƒçš„å†…å»ºæ•°æ®ç»“æ„ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬é‡ç‚¹å®ç°äº†åˆ—è¡¨çš„åŸºæœ¬åŠŸèƒ½ã€‚</p><p>é¦–å…ˆæ˜¯åˆ—è¡¨çš„è¡¨ç¤ºï¼Œåœ¨è¿™èŠ‚è¯¾ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº† HiList ç±»ï¼Œä½†å®ƒçš„åŠŸèƒ½å¹¶ä¸å®Œå–„ã€‚æ‰€ä»¥è¿™èŠ‚è¯¾çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯è¡¥å…¨ ListKlassï¼ŒæŠŠåˆ—è¡¨ç±»ä¹ŸåŠ å…¥åˆ°è™šæ‹Ÿæœºçš„å¯¹è±¡ä½“ç³»ä¸­æ¥ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯å‘åˆ—è¡¨ä¸­å¢åŠ åŠŸèƒ½ã€‚è¿™é‡Œæˆ‘ä»¬æŠŠåˆ—è¡¨çš„åŠŸèƒ½åˆ†æˆä¸¤å¤§ç±»ï¼Œç¬¬ä¸€ç±»æ˜¯é€šè¿‡å†…å»ºæ–¹æ³•å®ç°çš„ï¼Œç¬¬äºŒç±»æ˜¯é€šè¿‡æ–°çš„è¯­æ³•å’Œå­—èŠ‚ç æ¥æ‰©å±•çš„ã€‚</p><p>å†…å»ºæ–¹æ³•åŒ…æ‹¬å‘åˆ—è¡¨çš„æœ«å°¾æ·»åŠ å…ƒç´ çš„appendæ–¹æ³•ï¼Œå‘åˆ—è¡¨çš„æŒ‡å®šä½ç½®æ·»åŠ å…ƒç´ çš„insertæ–¹æ³•ï¼Œè¿˜æœ‰æŸ¥è¯¢å…ƒç´ åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®çš„ indexæ–¹æ³•ã€‚</p><p>æ–°å¢çš„è¯­æ³•åŒ…æ‹¬é€šè¿‡å–ä¸‹æ ‡è®¿é—®åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œå¯¹åº”çš„å­—èŠ‚ç æ˜¯BINARY_SUBSCRï¼›åˆ¤æ–­åˆ—è¡¨ä¸­æ˜¯å¦åŒ…æ‹¬æŸä¸ªå…ƒç´ ï¼Œå¯¹åº”çš„å­—èŠ‚ç è¯´ COMPARE_OP/inï¼›è¿˜æœ‰ä¿®æ”¹åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œå­—èŠ‚ç æ˜¯ STORE_SUBSCRã€‚</p><p>å¢åŠ äº†è¿™äº›åŠŸèƒ½ä»¥åï¼Œåˆ—è¡¨å°±åŸºæœ¬å¯ç”¨äº†ã€‚ä¸‹èŠ‚è¯¾æˆ‘ä»¬ä¼šç»§ç»­è¡¥é½åˆ—è¡¨çš„å…¶ä»–åŠŸèƒ½ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å­—ç¬¦ä¸²çš„ contains æ–¹æ³•éœ€è¦åœ¨å­—ç¬¦ä¸²ä¸­è¿›è¡Œå­ä¸²æŸ¥æ‰¾æ“ä½œã€‚ä½ çŸ¥é“æœ‰å“ªäº›é«˜æ•ˆçš„å­ä¸²æŸ¥æ‰¾ç®—æ³•å—ï¼Ÿæ¬¢è¿ä½ æŠŠä½ çŸ¥é“çš„æ–¹æ³•åˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"12ï½œNativeæ–¹æ³•ï¼šæ‰“é€šåº•å±‚è½¯ä»¶ä¸é«˜å±‚åº”ç”¨çš„å…³é”®","id":778919},"right":{"article_title":"14ï½œåˆ—è¡¨ï¼ˆä¸‹ï¼‰ï¼šåˆ—è¡¨æ‰€æ”¯æŒçš„åŸºæœ¬æ“ä½œ","id":780140}},"comments":[{"had_liked":false,"id":391147,"user_name":"æ«æ ‘_6177003","can_delete":false,"product_type":"c1","uid":1267891,"ip_address":"å››å·","ucode":"84B81DAD9C832E","user_header":"https://static001.geekbang.org/account/avatar/00/13/58/b3/abb3256b.jpg","comment_is_top":false,"comment_ctime":1717424948,"is_pvip":false,"replies":[{"id":142292,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1360512,"ctime":1717804533,"ip_address":"æµ™æ±Ÿ","comment_id":391147,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"KMPç®—æ³•","like_count":1,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":646369,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1717804533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1225368,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b2/98/82b76c88.jpg","nickname":"Se7en","note":"","ucode":"93EFAE37AFB12D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":646361,"discussion_content":"è¿™ä¸ªç®—æ³•åœ¨å“ªé‡Œç”¨äº†æ¥ç€ï¼Œæ²¡çœ‹åˆ°ğŸ‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1717766884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":395283,"user_name":"ifelse","can_delete":false,"product_type":"c1","uid":2550743,"ip_address":"æµ™æ±Ÿ","ucode":"D0565908C99695","user_header":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","comment_is_top":false,"comment_ctime":1730095616,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":3,"score":2,"product_id":100761401,"comment_content":"å­¦ä¹ æ‰“å¡","like_count":0}]}