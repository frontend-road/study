{"id":68636,"title":"37 | 找到容器不容易：Service、DNS与服务发现","content":"<p>你好，我是张磊。今天我和你分享的主题是：找到容器不容易之Service、DNS与服务发现。</p><p>在前面的文章中，我们已经多次使用到了Service这个Kubernetes里重要的服务对象。而Kubernetes之所以需要Service，一方面是因为Pod的IP不是固定的，另一方面则是因为一组Pod实例之间总会有负载均衡的需求。</p><p>一个最典型的Service定义，如下所示：</p><pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: hostnames\nspec:\n  selector:\n    app: hostnames\n  ports:\n  - name: default\n    protocol: TCP\n    port: 80\n    targetPort: 9376\n</code></pre><p>这个Service的例子，相信你不会陌生。其中，我使用了selector字段来声明这个Service只代理携带了app=hostnames标签的Pod。并且，这个Service的80端口，代理的是Pod的9376端口。</p><p>然后，我们的应用的Deployment，如下所示：</p><pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hostnames\nspec:\n  selector:\n    matchLabels:\n      app: hostnames\n  replicas: 3\n  template:\n    metadata:\n      labels:\n        app: hostnames\n    spec:\n      containers:\n      - name: hostnames\n        image: k8s.gcr.io/serve_hostname\n        ports:\n        - containerPort: 9376\n          protocol: TCP\n</code></pre><p>这个应用的作用，就是每次访问9376端口时，返回它自己的hostname。</p><p>而被selector选中的Pod，就称为Service的Endpoints，你可以使用kubectl get ep命令看到它们，如下所示：</p><pre><code>$ kubectl get endpoints hostnames\nNAME        ENDPOINTS\nhostnames   10.244.0.5:9376,10.244.0.6:9376,10.244.0.7:9376\n</code></pre><p>需要注意的是，只有处于Running状态，且readinessProbe检查通过的Pod，才会出现在Service的Endpoints列表里。并且，当某一个Pod出现问题时，Kubernetes会自动把它从Service里摘除掉。</p><!-- [[[read_end]]] --><p>而此时，通过该Service的VIP地址10.0.1.175，你就可以访问到它所代理的Pod了：</p><pre><code>$ kubectl get svc hostnames\nNAME        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nhostnames   ClusterIP   10.0.1.175   &lt;none&gt;        80/TCP    5s\n\n$ curl 10.0.1.175:80\nhostnames-0uton\n\n$ curl 10.0.1.175:80\nhostnames-yp2kp\n\n$ curl 10.0.1.175:80\nhostnames-bvc05\n</code></pre><p>这个VIP地址是Kubernetes自动为Service分配的。而像上面这样，通过三次连续不断地访问Service的VIP地址和代理端口80，它就为我们依次返回了三个Pod的hostname。这也正印证了Service提供的是Round Robin方式的负载均衡。对于这种方式，我们称为：ClusterIP模式的Service。</p><p>你可能一直比较好奇，Kubernetes里的Service究竟是如何工作的呢？</p><p>实际上，<strong>Service是由kube-proxy组件，加上iptables来共同实现的。</strong></p><p>举个例子，对于我们前面创建的名叫hostnames的Service来说，一旦它被提交给Kubernetes，那么kube-proxy就可以通过Service的Informer感知到这样一个Service对象的添加。而作为对这个事件的响应，它就会在宿主机上创建这样一条iptables规则（你可以通过iptables-save看到它），如下所示：</p><pre><code>-A KUBE-SERVICES -d 10.0.1.175/32 -p tcp -m comment --comment &quot;default/hostnames: cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-NWV5X2332I4OT4T3\n</code></pre><p>可以看到，这条iptables规则的含义是：凡是目的地址是10.0.1.175、目的端口是80的IP包，都应该跳转到另外一条名叫KUBE-SVC-NWV5X2332I4OT4T3的iptables链进行处理。</p><p>而我们前面已经看到，10.0.1.175正是这个Service的VIP。所以这一条规则，就为这个Service设置了一个固定的入口地址。并且，由于10.0.1.175只是一条iptables规则上的配置，并没有真正的网络设备，所以你ping这个地址，是不会有任何响应的。</p><p>那么，我们即将跳转到的KUBE-SVC-NWV5X2332I4OT4T3规则，又有什么作用呢？</p><p>实际上，它是一组规则的集合，如下所示：</p><pre><code>-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment &quot;default/hostnames:&quot; -m statistic --mode random --probability 0.33332999982 -j KUBE-SEP-WNBA2IHDGP2BOBGZ\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment &quot;default/hostnames:&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-X3P2623AGDH6CDF3\n-A KUBE-SVC-NWV5X2332I4OT4T3 -m comment --comment &quot;default/hostnames:&quot; -j KUBE-SEP-57KPRZ3JQVENLNBR\n</code></pre><p>可以看到，这一组规则，实际上是一组随机模式（–mode random）的iptables链。</p><p>而随机转发的目的地，分别是KUBE-SEP-WNBA2IHDGP2BOBGZ、KUBE-SEP-X3P2623AGDH6CDF3和KUBE-SEP-57KPRZ3JQVENLNBR。</p><p>而这三条链指向的最终目的地，其实就是这个Service代理的三个Pod。所以这一组规则，就是Service实现负载均衡的位置。</p><p>需要注意的是，iptables规则的匹配是从上到下逐条进行的，所以为了保证上述三条规则每条被选中的概率都相同，我们应该将它们的probability字段的值分别设置为1/3（0.333…）、1/2和1。</p><p>这么设置的原理很简单：第一条规则被选中的概率就是1/3；而如果第一条规则没有被选中，那么这时候就只剩下两条规则了，所以第二条规则的probability就必须设置为1/2；类似地，最后一条就必须设置为1。</p><p>你可以想一下，如果把这三条规则的probability字段的值都设置成1/3，最终每条规则被选中的概率会变成多少。</p><p>通过查看上述三条链的明细，我们就很容易理解Service进行转发的具体原理了，如下所示：</p><pre><code>-A KUBE-SEP-57KPRZ3JQVENLNBR -s 10.244.3.6/32 -m comment --comment &quot;default/hostnames:&quot; -j MARK --set-xmark 0x00004000/0x00004000\n-A KUBE-SEP-57KPRZ3JQVENLNBR -p tcp -m comment --comment &quot;default/hostnames:&quot; -m tcp -j DNAT --to-destination 10.244.3.6:9376\n\n-A KUBE-SEP-WNBA2IHDGP2BOBGZ -s 10.244.1.7/32 -m comment --comment &quot;default/hostnames:&quot; -j MARK --set-xmark 0x00004000/0x00004000\n-A KUBE-SEP-WNBA2IHDGP2BOBGZ -p tcp -m comment --comment &quot;default/hostnames:&quot; -m tcp -j DNAT --to-destination 10.244.1.7:9376\n\n-A KUBE-SEP-X3P2623AGDH6CDF3 -s 10.244.2.3/32 -m comment --comment &quot;default/hostnames:&quot; -j MARK --set-xmark 0x00004000/0x00004000\n-A KUBE-SEP-X3P2623AGDH6CDF3 -p tcp -m comment --comment &quot;default/hostnames:&quot; -m tcp -j DNAT --to-destination 10.244.2.3:9376\n</code></pre><p>可以看到，这三条链，其实是三条DNAT规则。但在DNAT规则之前，iptables对流入的IP包还设置了一个“标志”（–set-xmark）。这个“标志”的作用，我会在下一篇文章再为你讲解。</p><p>而DNAT规则的作用，就是在PREROUTING检查点之前，也就是在路由之前，将流入IP包的目的地址和端口，改成–to-destination所指定的新的目的地址和端口。可以看到，这个目的地址和端口，正是被代理Pod的IP地址和端口。</p><p>这样，访问Service VIP的IP包经过上述iptables处理之后，就已经变成了访问具体某一个后端Pod的IP包了。不难理解，这些Endpoints对应的iptables规则，正是kube-proxy通过监听Pod的变化事件，在宿主机上生成并维护的。</p><p>以上，就是Service最基本的工作原理。</p><p>此外，你可能已经听说过，Kubernetes的kube-proxy还支持一种叫作IPVS的模式。这又是怎么一回事儿呢？</p><p>其实，通过上面的讲解，你可以看到，kube-proxy通过iptables处理Service的过程，其实需要在宿主机上设置相当多的iptables规则。而且，kube-proxy还需要在控制循环里不断地刷新这些规则来确保它们始终是正确的。</p><p>不难想到，当你的宿主机上有大量Pod的时候，成百上千条iptables规则不断地被刷新，会大量占用该宿主机的CPU资源，甚至会让宿主机“卡”在这个过程中。所以说，<strong>一直以来，基于iptables的Service实现，都是制约Kubernetes项目承载更多量级的Pod的主要障碍。</strong></p><p>而IPVS模式的Service，就是解决这个问题的一个行之有效的方法。</p><p>IPVS模式的工作原理，其实跟iptables模式类似。当我们创建了前面的Service之后，kube-proxy首先会在宿主机上创建一个虚拟网卡（叫作：kube-ipvs0），并为它分配Service VIP作为IP地址，如下所示：</p><pre><code># ip addr\n  ...\n  73：kube-ipvs0：&lt;BROADCAST,NOARP&gt;  mtu 1500 qdisc noop state DOWN qlen 1000\n  link/ether  1a:ce:f5:5f:c1:4d brd ff:ff:ff:ff:ff:ff\n  inet 10.0.1.175/32  scope global kube-ipvs0\n  valid_lft forever  preferred_lft forever\n</code></pre><p>而接下来，kube-proxy就会通过Linux的IPVS模块，为这个IP地址设置三个IPVS虚拟主机，并设置这三个虚拟主机之间使用轮询模式(rr)来作为负载均衡策略。我们可以通过ipvsadm查看到这个设置，如下所示：</p><pre><code># ipvsadm -ln\n IP Virtual Server version 1.2.1 (size=4096)\n  Prot LocalAddress:Port Scheduler Flags\n    -&gt;  RemoteAddress:Port           Forward  Weight ActiveConn InActConn     \n  TCP  10.102.128.4:80 rr\n    -&gt;  10.244.3.6:9376    Masq    1       0          0         \n    -&gt;  10.244.1.7:9376    Masq    1       0          0\n    -&gt;  10.244.2.3:9376    Masq    1       0          0\n</code></pre><p>可以看到，这三个IPVS虚拟主机的IP地址和端口，对应的正是三个被代理的Pod。</p><p>这时候，任何发往10.102.128.4:80的请求，就都会被IPVS模块转发到某一个后端Pod上了。</p><p>而相比于iptables，IPVS在内核中的实现其实也是基于Netfilter的NAT模式，所以在转发这一层上，理论上IPVS并没有显著的性能提升。但是，IPVS并不需要在宿主机上为每个Pod设置iptables规则，而是把对这些“规则”的处理放到了内核态，从而极大地降低了维护这些规则的代价。这也正印证了我在前面提到过的，“将重要操作放入内核态”是提高性能的重要手段。</p><blockquote>\n<p>备注：这里你可以再回顾下第33篇文章<a href=\"https://time.geekbang.org/column/article/65287\">《深入解析容器跨主机网络》</a>中的相关内容。</p>\n</blockquote><p>不过需要注意的是，IPVS模块只负责上述的负载均衡和代理功能。而一个完整的Service流程正常工作所需要的包过滤、SNAT等操作，还是要靠iptables来实现。只不过，这些辅助性的iptables规则数量有限，也不会随着Pod数量的增加而增加。</p><p>所以，在大规模集群里，我非常建议你为kube-proxy设置–proxy-mode=ipvs来开启这个功能。它为Kubernetes集群规模带来的提升，还是非常巨大的。</p><p><strong>此外，我在前面的文章中还介绍过Service与DNS的关系。</strong></p><p>在Kubernetes中，Service和Pod都会被分配对应的DNS A记录（从域名解析IP的记录）。</p><p>对于ClusterIP模式的Service来说（比如我们上面的例子），它的A记录的格式是：<my-svc>.<my-namespace>.svc.cluster.local。当你访问这条A记录的时候，它解析到的就是该Service的VIP地址。</my-namespace></my-svc></p><p>而对于指定了clusterIP=None的Headless Service来说，它的A记录的格式也是：<my-svc>.<my-namespace>.svc.cluster.local。但是，当你访问这条A记录的时候，它返回的是所有被代理的Pod的IP地址的集合。当然，如果你的客户端没办法解析这个集合的话，它可能会只会拿到第一个Pod的IP地址。</my-namespace></my-svc></p><p>此外，对于ClusterIP模式的Service来说，它代理的Pod被自动分配的A记录的格式是：<pod-ip>.<my-namespace>.pod.cluster.local。这条记录指向Pod的IP地址。</my-namespace></pod-ip></p><p>而对Headless Service来说，它代理的Pod被自动分配的A记录的格式是：<my-pod-name>.<my-service-name>.<my-namespace>.svc.cluster.local。这条记录也指向Pod的IP地址。</my-namespace></my-service-name></my-pod-name></p><p>但如果你为Pod指定了Headless Service，并且Pod本身声明了hostname和subdomain字段，那么这时候Pod的A记录就会变成：&lt;pod的hostname&gt;.<subdomain>.<my-namespace>.svc.cluster.local，比如：</my-namespace></subdomain></p><pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: default-subdomain\nspec:\n  selector:\n    name: busybox\n  clusterIP: None\n  ports:\n  - name: foo\n    port: 1234\n    targetPort: 1234\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox1\n  labels:\n    name: busybox\nspec:\n  hostname: busybox-1\n  subdomain: default-subdomain\n  containers:\n  - image: busybox\n    command:\n      - sleep\n      - &quot;3600&quot;\n    name: busybox\n</code></pre><p>在上面这个Service和Pod被创建之后，你就可以通过busybox-1.default-subdomain.default.svc.cluster.local解析到这个Pod的IP地址了。</p><p>需要注意的是，在Kubernetes里，/etc/hosts文件是单独挂载的，这也是为什么kubelet能够对hostname进行修改并且Pod重建后依然有效的原因。这跟Docker的Init层是一个原理。</p><h2>总结</h2><p>在这篇文章里，我为你详细讲解了Service的工作原理。实际上，Service机制，以及Kubernetes里的DNS插件，都是在帮助你解决同样一个问题，即：如何找到我的某一个容器？</p><p>这个问题在平台级项目中，往往就被称作服务发现，即：当我的一个服务（Pod）的IP地址是不固定的且没办法提前获知时，我该如何通过一个固定的方式访问到这个Pod呢？</p><p>而我在这里讲解的、ClusterIP模式的Service为你提供的，就是一个Pod的稳定的IP地址，即VIP。并且，这里Pod和Service的关系是可以通过Label确定的。</p><p>而Headless Service为你提供的，则是一个Pod的稳定的DNS名字，并且，这个名字是可以通过Pod名字和Service名字拼接出来的。</p><p>在实际的场景里，你应该根据自己的具体需求进行合理选择。</p><h2>思考题</h2><p>请问，Kubernetes的Service的负载均衡策略，在iptables和ipvs模式下，都有哪几种？具体工作模式是怎样的？</p><p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。</p>","comments":[{"had_liked":false,"id":39601,"user_name":"追寻云的痕迹","can_delete":false,"product_type":"c1","uid":1081114,"ip_address":"","ucode":"2B782C85CF0F67","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/1a/eb8021c3.jpg","comment_is_top":false,"comment_ctime":1542327476,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"332254809268","product_id":100015201,"comment_content":"iptables是万恶之源，在复杂系统中，网络处理越简单越好。现在k8s这套玩法，给实际工作中的运维排错带来极大的麻烦。","like_count":78,"discussions":[{"author":{"id":1845394,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/28/92/436735f5.jpg","nickname":"晞月520","note":"","ucode":"4F05E02A5C1608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287702,"discussion_content":"都改用ipvs 了啊\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1593513425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1209160,"avatar":"https://static001.geekbang.org/account/avatar/00/12/73/48/ced94e09.jpg","nickname":"小超在努力","note":"","ucode":"5C04AA8A96532F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5673,"discussion_content":"深有感觉，这玩意太难跟踪","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566433808,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90602,"user_name":"qingbo","can_delete":false,"product_type":"c1","uid":1283979,"ip_address":"","ucode":"A4AA89EA310C27","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/8b/bd318156.jpg","comment_is_top":false,"comment_ctime":1556586666,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"134700572842","product_id":100015201,"comment_content":"看到也有同学问pod DNS，希望能讲得更详细些。我查阅官方文档及自己实践后的了解是这两种pod有DNS记录：<br>1. statefulset的pod。有人问之前讲DNS的是在哪，就是“20 | 深入理解StatefulSet（三）：有状态应用实践”这一篇。<br>2. pod显式指定了hostname和subdomain，并且有个headless service的名字和subdomain一样。在“27 | 聪明的微创新：Operator工作原理解读”一篇中讲到的etcd operator就是这样让pod拥有了DNS记录。Deployment的pod template也可以指定hostname和subdomain，但是却没办法给每个pod分配不同的hostname。指定hostname和subdomain之后，hostname.subdomain.default.svc.cluster.local这样的域名确实可以解析，但是因为多个pod都是这个FQDN，所以解析出来的效果和headless service一样，多个A记录，也就失去意义了。github上有个issue想让deployment管理的pod也有独立的DNS，好像没得到支持。","like_count":32,"discussions":[{"author":{"id":1476022,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIRiaWicYyZvuH6ROCAsbRjzGYVAvsGbLCUfcII5x3Z8SxhxPBEqm434g1TEUxhCztTJrJ7aR1068rw/132","nickname":"Geek_a121ad","note":"","ucode":"C102E85AE5F457","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550281,"discussion_content":"deployment代理的pod是没有独立的dns记录进行解析的是吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644465671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535072,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638345227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85175,"user_name":"纳爱斯","can_delete":false,"product_type":"c1","uid":1239666,"ip_address":"","ucode":"4ECD6B2DC91E51","user_header":"https://static001.geekbang.org/account/avatar/00/12/ea/72/92e43306.jpg","comment_is_top":false,"comment_ctime":1554994439,"is_pvip":false,"replies":[{"id":"31580","content":"对","user_name":"作者回复","comment_id":85175,"uid":"1218095","ip_address":"","utype":1,"ctime":1555697689,"user_name_real":"Geek_6ef93d"}],"discussion_count":1,"race_medal":0,"score":"130404013319","product_id":100015201,"comment_content":"老师，是每个 node 上都会有 iptables 的全部规则吗","like_count":31,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446583,"discussion_content":"对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555697689,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":39892,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1542378549,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"126096430133","product_id":100015201,"comment_content":"老师，..svc.cluster.local这些点前面的东西能写全吗？录音听了N次也没记下来。文字不行的话能不能弄个图片？","like_count":28},{"had_liked":false,"id":56942,"user_name":"勤劳的小胖子-libo","can_delete":false,"product_type":"c1","uid":1158344,"ip_address":"","ucode":"5BB20CD5A56568","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg","comment_is_top":false,"comment_ctime":1546584108,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"96035864620","product_id":100015201,"comment_content":"示例终于都可以工作了，深化理解。<br>一种是通过&lt;serviceName&gt;.&lt;namespace&gt;.svc.cluster.local访问。对应于clusterIP<br>另一种是通过&lt;podName&gt;.&lt;serviceName&gt;.&lt;namesapce&gt;.svc.cluster.local访问,对应于headless service.<br>&#47; # nslookup *.default.svc.cluster.local<br>Server:    10.96.0.10<br>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local<br><br>Name:      *.default.svc.cluster.local<br>Address 1: 10.244.1.7 busybox-3.default-subdomain.default.svc.cluster.local<br>Address 2: 10.96.0.1 kubernetes.default.svc.cluster.local<br>Address 3: 10.97.103.223 hostnames.default.svc.cluster.local<br>","like_count":23},{"had_liked":false,"id":155276,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1574673681,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"53114281233","product_id":100015201,"comment_content":"ipvs负载均衡：round robin<br>    least connection<br>    destination hashing<br>    source hashing<br>    shortest expected delay<br>    never queue<br>    overflow-connection","like_count":13},{"had_liked":false,"id":39663,"user_name":"runner","can_delete":false,"product_type":"c1","uid":1200107,"ip_address":"","ucode":"6037BEDDF7AA48","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/eb/b5bb4227.jpg","comment_is_top":false,"comment_ctime":1542333188,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"53081940740","product_id":100015201,"comment_content":"请问老师，每个节点会有全部的iptables规则么，还是只有自己所属服务的规则？<br>如果服务是nodePort类型，它会在所有节点上占用端口？还是容器所在的几个节点占用端口？","like_count":11,"discussions":[{"author":{"id":2393431,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEK4xKibFviba7jKvx9OYcLXZgTywmqdwAibSS6hiaxVczQhAENWEOqfRzBadX5sYdw2cUcBYEtsicxyv6w/132","nickname":"Geek_08f26a","note":"","ucode":"4DE7914EAABF73","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347874,"discussion_content":"所有节点都会占用端口\n","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1612348619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1445106,"avatar":"https://static001.geekbang.org/account/avatar/00/16/0c/f2/eff644f9.jpg","nickname":"Geek_f04d81","note":"","ucode":"ECD9F1BE0B2186","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341435,"discussion_content":"我这边看是每个节点都是全部的iptables规则","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1610419715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":181004,"user_name":"李康","can_delete":false,"product_type":"c1","uid":1258843,"ip_address":"","ucode":"04C931B60B0F0D","user_header":"https://static001.geekbang.org/account/avatar/00/13/35/5b/c9d7e8c0.jpg","comment_is_top":false,"comment_ctime":1582457564,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40237163228","product_id":100015201,"comment_content":"<br>-A KUBE-SEP-57KPRZ3JQVENLNBR -s 10.244.3.6&#47;32 -m comment --comment &quot;default&#47;hostnames:&quot; -j MARK --set-xmark 0x00004000&#47;0x00004000<br><br>-A KUBE-SEP-WNBA2IHDGP2BOBGZ -s 10.244.1.7&#47;32 -m comment --comment &quot;default&#47;hostnames:&quot; -j MARK --set-xmark 0x00004000&#47;0x00004000<br><br>-A KUBE-SEP-X3P2623AGDH6CDF3 -s 10.244.2.3&#47;32 -m comment --comment &quot;default&#47;hostnames:&quot; -j MARK --set-xmark 0x00004000&#47;0x00004000<br><br>问下为啥源地址是这个啊？现在数据包源地址不应该是客户端的地址吗？","like_count":8},{"had_liked":false,"id":39544,"user_name":"mcc","can_delete":false,"product_type":"c1","uid":1153489,"ip_address":"","ucode":"A05A7AB1355903","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/d1/2c6f297f.jpg","comment_is_top":false,"comment_ctime":1542299554,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"31607070626","product_id":100015201,"comment_content":"描述一个实际使用中遇到kube-proxy的一个问题。我使用service的nodeport模式对外发布服务，前端使用openresty做代理的，upstream就配置node ip+nodeport。在使用过程中发现openresty经常不定期报104:connection reset by peer when read response head这个错误，从错误看出openstry从nodeport读取数据的时候tcp连接被重置了，使用同一openresty的后端是普通虚拟机的节点的服务却没有这个问题，问题还有个特点就是某个服务长时间没有被访问，第一次点击的时候就会出现，然后后面就好了。nodeport是被kube-proxy监听的，问题就出在openresty与kube-proxy的tcp连接上，能否帮忙分析kube-proxy为何会重置连接？","like_count":7,"discussions":[{"author":{"id":1006424,"avatar":"","nickname":"门窗小二","note":"","ucode":"0BF3780C247F22","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376126,"discussion_content":"mark，同问如何解决的？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621987714,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2055993,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/5f/39/8d2c61d3.jpg","nickname":"Kiddy","note":"","ucode":"D07AAEE69BE504","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572232,"discussion_content":"请问这个问题找到原因了吗，分享下呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652666879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1229823,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKickJXbocFlu3n3tBDR0kEU2UVjtHIA1qnzEicTVvwlQ2E4Vt9T1oV3Uw3KtbGeYpaU1oAEf1iazXPA/132","nickname":"Geek_d7a8cc","note":"","ucode":"2970446CCF76D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":194570,"discussion_content":"咋解决的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583233250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1082097,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/f1/c2cfbd2e.jpg","nickname":"积红","note":"","ucode":"A8ED0D66E7E723","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1779,"discussion_content":"问题解决了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562910602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1153489,"avatar":"https://static001.geekbang.org/account/avatar/00/11/99/d1/2c6f297f.jpg","nickname":"mcc","note":"","ucode":"A05A7AB1355903","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1082097,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/f1/c2cfbd2e.jpg","nickname":"积红","note":"","ucode":"A8ED0D66E7E723","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":123022,"discussion_content":"解决了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578386547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1779,"ip_address":""},"score":123022,"extra":""},{"author":{"id":1944962,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZ2Kr6TQt91Mdr16atJvwEkyYq1YGh8qR7BPCqPlgO7ZoyM95z4uLbSkMyzcP33fyIRAcHAUdN8Q/132","nickname":"极客精英","note":"","ucode":"ED4A435488CC40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1153489,"avatar":"https://static001.geekbang.org/account/avatar/00/11/99/d1/2c6f297f.jpg","nickname":"mcc","note":"","ucode":"A05A7AB1355903","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319031,"discussion_content":"请问您是如何解决的？最近也遇到这样的问题了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1603930472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":123022,"ip_address":""},"score":319031,"extra":""},{"author":{"id":1681159,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoHgweicVlhxFOAh4V9Bv0MwamKuOV8IZiacTaYjO3ZMuvwQdYibzeUnQSMpiaSfRTHIhnnLBFLDEq7qA/132","nickname":"kay","note":"","ucode":"03F88D31BE2BD5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1944962,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZ2Kr6TQt91Mdr16atJvwEkyYq1YGh8qR7BPCqPlgO7ZoyM95z4uLbSkMyzcP33fyIRAcHAUdN8Q/132","nickname":"极客精英","note":"","ucode":"ED4A435488CC40","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":564248,"discussion_content":"请问后来怎么解决的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650200018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":319031,"ip_address":""},"score":564248,"extra":""}]}]},{"had_liked":false,"id":45912,"user_name":"艾斯Z艾穆","can_delete":false,"product_type":"c1","uid":1107498,"ip_address":"","ucode":"DAA7686EC80430","user_header":"https://static001.geekbang.org/account/avatar/00/10/e6/2a/2ac18fb8.jpg","comment_is_top":false,"comment_ctime":1543817006,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18723686190","product_id":100015201,"comment_content":"您好，我使用coreDNS插件版本是1.2.6 <br>配置文件的内容：<br>Corefile: |<br>    .:53 {<br>        errors<br>        health<br>        kubernetes cluster.local. in-addr.arpa ip6.arpa {<br>            pods insecure<br>            upstream<br>            fallthrough in-addr.arpa ip6.arpa<br>        }<br>        prometheus :9153<br>        proxy . 100.64.255.100 223.5.5.5 11.125.1.12<br>        cache 30<br>        loop<br>        reload<br>        loadbalance<br>    }<br>在解析公网的域名的时候会有小概率随机出现unknown host，请问会是什么问题","like_count":4,"discussions":[{"author":{"id":1226625,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b7/81/ac11be3b.jpg","nickname":"海","note":"","ucode":"356EABFD394513","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":733,"discussion_content":"我也遇到了，所以业务pod的dns策略是直接使用宿主机的dns文件，不用coredns","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561991155,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":137017,"user_name":"grep","can_delete":false,"product_type":"c1","uid":1215500,"ip_address":"","ucode":"69FF2DDEEF58FE","user_header":"https://static001.geekbang.org/account/avatar/00/12/8c/0c/a36cdf51.jpg","comment_is_top":false,"comment_ctime":1569576424,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14454478312","product_id":100015201,"comment_content":"示例里这里打出来的 endpoints ip：<br>kubectl get endpoints hostnames<br>NAME        ENDPOINTS<br>hostnames   10.244.0.5:9376,10.244.0.6:9376,10.244.0.7:9376<br><br>与下面的 iptables 规则里的 endpoint ip 对不上<br>-A KUBE-SEP-57KPRZ3JQVENLNBR -s 10.244.3.6&#47;32 -m comment --comment &quot;default&#47;hostnames:&quot; -j MARK --set-xmark 0x00004000&#47;0x00004000<br>-A KUBE-SEP-57KPRZ3JQVENLNBR -p tcp -m comment --comment &quot;default&#47;hostnames:&quot; -m tcp -j DNAT --to-destination 10.244.3.6:9376<br><br>-A KUBE-SEP-WNBA2IHDGP2BOBGZ -s 10.244.1.7&#47;32 -m comment --comment &quot;default&#47;hostnames:&quot; -j MARK --set-xmark 0x00004000&#47;0x00004000<br>-A KUBE-SEP-WNBA2IHDGP2BOBGZ -p tcp -m comment --comment &quot;default&#47;hostnames:&quot; -m tcp -j DNAT --to-destination 10.244.1.7:9376<br><br>-A KUBE-SEP-X3P2623AGDH6CDF3 -s 10.244.2.3&#47;32 -m comment --comment &quot;default&#47;hostnames:&quot; -j MARK --set-xmark 0x00004000&#47;0x00004000<br>-A KUBE-SEP-X3P2623AGDH6CDF3 -p tcp -m comment --comment &quot;default&#47;hostnames:&quot; -m tcp -j DNAT --to-destination 10.244.2.3:9376<br><br>是不是中间重新部署过？","like_count":3,"discussions":[{"author":{"id":1676412,"avatar":"https://static001.geekbang.org/account/avatar/00/19/94/7c/70bf584f.jpg","nickname":"勤奋的辣牛肉","note":"","ucode":"D48CC31A8D44FC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565635,"discussion_content":"是的 .感觉也应该是 -d 还不应该是 -s","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650507571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1004165,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/52/85/99545c24.jpg","nickname":"叶王","note":"","ucode":"D7193A95D8281C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561970,"discussion_content":"而且应该是 -d 10.244.3.6/32","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649755628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90772,"user_name":"Mr.Cling","can_delete":false,"product_type":"c1","uid":1141490,"ip_address":"","ucode":"9CC3868AE6C14B","user_header":"https://static001.geekbang.org/account/avatar/00/11/6a/f2/fee557fe.jpg","comment_is_top":false,"comment_ctime":1556635149,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"14441537037","product_id":100015201,"comment_content":"这时候，任何发往 10.102.128.4:80 的请求，就都会被 IPVS 模块转发到某一个后端 Pod 上了。<br><br>请问这里的10.102.128.4的IP是什么IP？","like_count":3,"discussions":[{"author":{"id":1323748,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI3nvp97tyVLKPKlmFhd4c33BUkeBpCbAlom8yV9zKjScQQWppTVM4ic8Rx2tozG0Y8ospQPLiciavCg/132","nickname":"Geek_d9010d","note":"","ucode":"DFC48B0C418C13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":212150,"discussion_content":" TCP  10.102.128.4:80 rr    ->  10.244.3.6:9376    Masq    1       0          0             ->  10.244.1.7:9376    Masq    1       0          0    ->  10.244.2.3:9376    Masq    1       0          0\n这些ip都不是vip和pod的ip啊，不太理解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584940715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1048707,"avatar":"https://static001.geekbang.org/account/avatar/00/10/00/83/9329a697.jpg","nickname":"马殿军","note":"","ucode":"97FE6251C04E6D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100256,"discussion_content":"10.102.128.4 这个IP好像是写错了，应该是10.0.1.175，参考这个文章：https://kubernetes.io/zh/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577245021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1048707,"avatar":"https://static001.geekbang.org/account/avatar/00/10/00/83/9329a697.jpg","nickname":"马殿军","note":"","ucode":"97FE6251C04E6D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100226,"discussion_content":"我也没看明白","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577243363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":39563,"user_name":"Majorin_Che","can_delete":false,"product_type":"c1","uid":1131906,"ip_address":"","ucode":"22D3B0A20D4D1F","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/82/164b9073.jpg","comment_is_top":false,"comment_ctime":1542320665,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14427222553","product_id":100015201,"comment_content":"所以这里服务发现的方式就是通过label发现pod，是这样理解吗？","like_count":3,"discussions":[{"author":{"id":1131300,"avatar":"https://static001.geekbang.org/account/avatar/00/11/43/24/3f9f7c70.jpg","nickname":"zixuan","note":"","ucode":"C72920DD05B074","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537081,"discussion_content":"通过vip、dnsname来发现， label是指定把哪些pod挂在这个vip/name下面","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638951757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":251303,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1601455658,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10191390250","product_id":100015201,"comment_content":"必然会存在着轮询去进行负载均衡的策略以及利用会话保持的进行保证客户端分配固定的pod Ip的模式","like_count":2},{"had_liked":false,"id":155222,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1574666490,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10164601082","product_id":100015201,"comment_content":"iptables的负载均衡分两种：random &#47; nth，random是随机模式，--probability p指定了概率，nth是轮巡模式，--every n和--packet p指定了每n个packet中匹配其中的第p个。","like_count":2},{"had_liked":false,"id":143482,"user_name":"思维决定未来","can_delete":false,"product_type":"c1","uid":1412891,"ip_address":"","ucode":"88CC245B3C6E2D","user_header":"","comment_is_top":false,"comment_ctime":1571715158,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"10161649750","product_id":100015201,"comment_content":"如果把这三条规则的 probability 字段的值都设置成1&#47;3，那么第一条规则命中几率是1&#47;3，第二条是2&#47;3 * 1&#47;3=2&#47;9，第三条是1&#47;3 * 1&#47;3 = 1&#47;9","like_count":2,"discussions":[{"author":{"id":2397697,"avatar":"https://static001.geekbang.org/account/avatar/00/24/96/01/6e9b5ac8.jpg","nickname":"超人","note":"","ucode":"233ED8C823A68D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376149,"discussion_content":"如果都设置成1/3的话三条规则的概率是：\n1/3\n2/3*1/3=2/9\n2/3*2/3*1/3=4/27\n\n如果提一条是1/3  第二条是1/2 第三条是1的话，概率是：\n1/3\n2/3*1/2=1/3\n2/3*1/2*1=1/3\n三条轮询","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1621994340,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1206365,"avatar":"https://static001.geekbang.org/account/avatar/00/12/68/5d/1ccee378.jpg","nickname":"茫农","note":"","ucode":"71F7143644C9CB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":314795,"discussion_content":"第三条应该是 1 - 1/3 - 2/9 = 4/9","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603197385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2189618,"avatar":"","nickname":"咕噜咕噜地","note":"","ucode":"1503E8A088EBDF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374016,"discussion_content":"第三条应该是(1-1/3-2/9)*1/3=4/27","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620970509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1234998,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d8/36/badf4003.jpg","nickname":"卡洛梅特","note":"","ucode":"A9997083BF684A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363701,"discussion_content":"第三条必中吧。。。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617266004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1741990,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/94/a6/eb8bbfbe.jpg","nickname":"唯她命@蓝胖子","note":"","ucode":"A86E24F7B8497E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1234998,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d8/36/badf4003.jpg","nickname":"卡洛梅特","note":"","ucode":"A9997083BF684A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364563,"discussion_content":"为什么是第三条中，能否帮忙解释下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617519791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":363701,"ip_address":""},"score":364563,"extra":""},{"author":{"id":1234998,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d8/36/badf4003.jpg","nickname":"卡洛梅特","note":"","ucode":"A9997083BF684A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1741990,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/94/a6/eb8bbfbe.jpg","nickname":"唯她命@蓝胖子","note":"","ucode":"A86E24F7B8497E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364935,"discussion_content":"按顺序，三条都是符合的规则，那不管第三条概率怎么样，前两条没选上，第三条都要被选啊，难道这次选择放弃不要了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617668458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":364563,"ip_address":""},"score":364935,"extra":""}]}]},{"had_liked":false,"id":94503,"user_name":"甘陵笑笑生","can_delete":false,"product_type":"c1","uid":1028570,"ip_address":"","ucode":"9F9D60CFEB73DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b1/da/88197585.jpg","comment_is_top":false,"comment_ctime":1557827847,"is_pvip":true,"replies":[{"id":"36306","content":"不会的，除非删除svc","user_name":"作者回复","comment_id":94503,"uid":"1218095","ip_address":"","utype":1,"ctime":1559619476,"user_name_real":"Geek_6ef93d"}],"discussion_count":2,"race_medal":0,"score":"10147762439","product_id":100015201,"comment_content":"请教一下 service的VIP设置后会变吗 如果变 什么时候会变","like_count":2,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":450082,"discussion_content":"不会的，除非删除svc","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559619476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1061898,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZtZz0LgYRdP1FKvmPfQUv7vQ04ibTvNTx3wcG0WEblMHQ8dORKqBeMlath93yO5a129tKhFPkA4w/132","nickname":"小刚","note":"","ucode":"9CDB75A4083391","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381757,"discussion_content":"service vip是怎么确定落在哪个节点？ 如果这个节点挂了，怎么实现vip快速漂移？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625202153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":41887,"user_name":"勤劳的小胖子-libo","can_delete":false,"product_type":"c1","uid":1158344,"ip_address":"","ucode":"5BB20CD5A56568","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg","comment_is_top":false,"comment_ctime":1542867835,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132802427","product_id":100015201,"comment_content":"&quot;我在前面的文章中还介绍过 Service 与 DNS 的关系.&quot;可以帮忙指明一下是第几章吗？找了一圈没找到。<br><br>另外：试着通过域名访问hostanmes，不行。通过ip可以。<br>vagrant@kubeadm1:~&#47;37ServiceDns$ curl hostnames.svc.cluster.local:80<br>curl: (6) Could not resolve host: hostnames.svc.cluster.local<br><br>vagrant@kubeadm1:~&#47;37ServiceDns$ curl 10.110.252.216:80<br>hostnames-84985c9fdd-sgwpp<br><br><br>","like_count":2},{"had_liked":false,"id":40917,"user_name":"Long Long☞","can_delete":false,"product_type":"c1","uid":1229757,"ip_address":"","ucode":"46869DB564FABE","user_header":"https://static001.geekbang.org/account/avatar/00/12/c3/bd/03a16b21.jpg","comment_is_top":false,"comment_ctime":1542694839,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10132629431","product_id":100015201,"comment_content":"老师 现在我遇到一个问题，同一个域名希望在不同的namespace中解析成不同的IP，要怎么实现","like_count":2,"discussions":[{"author":{"id":1337552,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZCX6TPTqnEaoia8s6IT0PKUHTeDoXiaLPSibQMQ9Sia6P1bqCYSdanX8g9GRZ3kHp5a6x4enx3tyPuQ/132","nickname":"daidai","note":"","ucode":"67405B4E1005E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563965,"discussion_content":"hostalias","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650119688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":39929,"user_name":"xianhai","can_delete":false,"product_type":"c1","uid":1073505,"ip_address":"","ucode":"906578663CEB3E","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/61/677e8f92.jpg","comment_is_top":false,"comment_ctime":1542397998,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132332590","product_id":100015201,"comment_content":"服务发布有问题,如何确定问题出在kubeproxy上还是overlay network上？这一块如何trouble shooting，能讲讲吗？","like_count":2},{"had_liked":false,"id":39700,"user_name":"vx:jiancheng_goon","can_delete":false,"product_type":"c1","uid":1218615,"ip_address":"","ucode":"FD34901B061825","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/37/7f575aec.jpg","comment_is_top":false,"comment_ctime":1542337421,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132272013","product_id":100015201,"comment_content":"sevice是由kubelet创建的吗？再有kubenates的sevice代理的却不是pod，而是apiserver的容器，那么kubenates service是什么时候由谁创建出来的？","like_count":2},{"had_liked":false,"id":351040,"user_name":"双叶","can_delete":false,"product_type":"c1","uid":1009260,"ip_address":"","ucode":"6DA1D477F9D580","user_header":"https://static001.geekbang.org/account/avatar/00/0f/66/6c/4a68a916.jpg","comment_is_top":false,"comment_ctime":1657489215,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5952456511","product_id":100015201,"comment_content":"不太赞同 ipvs 比 iptables 快是因为把更多的操作放到了内核里面，不管 ipvs 还是 iptables，他的所有逻辑都是在内核里面跑的，只是 iptables 需要遍历规则，而规则数量会跟随 pod 数量增长，导致时间复杂度是 O(n)，而 ipvs 是专门做负载均衡的，时间复杂度是 O(1)。<br><br>这篇文章里面有比较细致的说明：https:&#47;&#47;www.tigera.io&#47;blog&#47;comparing-kube-proxy-modes-iptables-or-ipvs&#47;<br>基本来说，就是 iptables 不能放太多规则","like_count":2},{"had_liked":false,"id":341663,"user_name":"叶王","can_delete":false,"product_type":"c1","uid":1004165,"ip_address":"","ucode":"D7193A95D8281C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/85/99545c24.jpg","comment_is_top":false,"comment_ctime":1649755471,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5944722767","product_id":100015201,"comment_content":"endpoint ip 和后面 iptables ip 没有对上。","like_count":1},{"had_liked":false,"id":281323,"user_name":"越战越勇","can_delete":false,"product_type":"c1","uid":2459240,"ip_address":"","ucode":"63D0C601FFEB2A","user_header":"https://static001.geekbang.org/account/avatar/00/25/86/68/ecac85d4.jpg","comment_is_top":false,"comment_ctime":1614690655,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5909657951","product_id":100015201,"comment_content":"你好，请教下，service的负载均衡支持一致性hash策略吗，有个需求，如：客户端通过udp端口10010通过service访问到某个pod，但是后续客户端还会通过10010发送数据，但是要求后续发送的数据都转发到第一次的pod。  期待您的答复，谢谢","like_count":1,"discussions":[{"author":{"id":2254917,"avatar":"https://static001.geekbang.org/account/avatar/00/22/68/45/ddf89612.jpg","nickname":"bestgopher","note":"","ucode":"D89735C8CA9C6E","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545029,"discussion_content":"SessionAffinity","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641809055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1048358,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJeqy27pXAvufBYicAhPbEnxE4mhKGCXSsMn0rM8xAf5O7e4lFc8ImicdSJG8w2cypdJN7bKTNNgOxA/132","nickname":"init","note":"","ucode":"3F56F410B9708A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354373,"discussion_content":"affinity","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615282598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244892,"user_name":"海阔天空","can_delete":false,"product_type":"c1","uid":1733275,"ip_address":"","ucode":"8658B1610192E7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOBwR7MCVqwZzc3keFAJT12Sic3VYWx4PrZbCGDm4kBZD3oqnR4xsibGGtGy4tFO8y05Ims27SiaavA/132","comment_is_top":false,"comment_ctime":1598717908,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5893685204","product_id":100015201,"comment_content":"对于 ClusterIP 模式的 Service 来说，它代理的 Pod 被自动分配的 A 记录的格式是：..pod.cluster.local。这条记录指向 Pod 的 IP 地址。 ==&gt; 目前版本，并没有找到对应的DNS记录呀","like_count":1},{"had_liked":false,"id":242655,"user_name":"一路顺风","can_delete":false,"product_type":"c1","uid":2032032,"ip_address":"","ucode":"D46B7F92D65189","user_header":"https://static001.geekbang.org/account/avatar/00/1f/01/a0/07ca2bd2.jpg","comment_is_top":false,"comment_ctime":1597805310,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5892772606","product_id":100015201,"comment_content":"老师，请问通过service的vip访问后端服务是如何保持tcp连接的状态的","like_count":1},{"had_liked":false,"id":39666,"user_name":"LS","can_delete":false,"product_type":"c1","uid":1086139,"ip_address":"","ucode":"3F054F6E5360CB","user_header":"https://static001.geekbang.org/account/avatar/00/10/92/bb/ed57d6b8.jpg","comment_is_top":false,"comment_ctime":1542333578,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5837300874","product_id":100015201,"comment_content":"请教一下关于边缘节点如何对外服务呢？","like_count":1},{"had_liked":false,"id":350238,"user_name":"郑海成","can_delete":false,"product_type":"c1","uid":1192616,"ip_address":"","ucode":"B0363EA4B2C646","user_header":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","comment_is_top":false,"comment_ctime":1656676593,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1656676593","product_id":100015201,"comment_content":"iptables运行在用户态，负载均衡算法只支持概率；ipvs运行在内核态，支持多种负载均衡算法比如rr lc。但两种模式都还是四层负载均衡，无法支持基于应用层数据的负载","like_count":0},{"had_liked":false,"id":325654,"user_name":"focus","can_delete":false,"product_type":"c1","uid":1215228,"ip_address":"","ucode":"1584B9C212AB7D","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDj4jSAykTpH1kNtoFgsygeyr01A7mxhxQqzdiapXNgUyBykCz6zJBtLAO7wLAtf4y4pHxWvvoTmg/132","comment_is_top":false,"comment_ctime":1639061327,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639061327","product_id":100015201,"comment_content":"&#47;etc&#47;hosts 是挂载进去，不是pod启动时生成的？","like_count":0},{"had_liked":false,"id":318835,"user_name":"陈斯佳","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1635464570,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635464570","product_id":100015201,"comment_content":"第三十七课:找到容器不容易<br>Service提供的是Round Robin方式的负载均衡。<br><br>Service是由kube-proxy组建，加上iptables来共同实现的<br><br>一直以来基于iptables的Service实现，都是制约K8s项目承载更多量级的Pod的主要障碍，而IPVS模式的Service有效的解决了这个问题。","like_count":0},{"had_liked":false,"id":314275,"user_name":"Vndi","can_delete":false,"product_type":"c1","uid":2114744,"ip_address":"","ucode":"23DA6A7BE63E9F","user_header":"https://static001.geekbang.org/account/avatar/00/20/44/b8/d5fe40fb.jpg","comment_is_top":false,"comment_ctime":1632928509,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632928509","product_id":100015201,"comment_content":"意思是原生service都只能走nat不走容器网络了？那istio service规则不写在iptables里，应该是可以用容器网络的吧","like_count":0},{"had_liked":false,"id":302654,"user_name":"SmartsYoung","can_delete":false,"product_type":"c1","uid":1843402,"ip_address":"","ucode":"7277B790D470DE","user_header":"https://static001.geekbang.org/account/avatar/00/1c/20/ca/2b0f69bc.jpg","comment_is_top":false,"comment_ctime":1626318342,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1626318342","product_id":100015201,"comment_content":"请教一下，curl不通是什么原因？<br><br>37$ kubectl get endpoints hostnames<br>NAME        ENDPOINTS                                         AGE<br>hostnames   172.17.0.3:9376,172.17.0.4:9376,172.17.0.5:9376   50s<br>smartsyoung@smartsyoung-Lenovo-Legion-Y7000P2020H:~&#47;Desktop&#47;go learing&#47;cncf-k8s&#47;37$ kubectl get svc hostnames<br>NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE<br>hostnames   ClusterIP   10.100.38.200   &lt;none&gt;        80&#47;TCP    59s<br>smartsyoung@smartsyoung-Lenovo-Legion-Y7000P2020H:~&#47;Desktop&#47;go learing&#47;cncf-k8s&#47;37$ curl 10.100.38.200:80<br>curl: (28) Failed to connect to 10.100.38.200 port 80: Connection timed out","like_count":0,"discussions":[{"author":{"id":1226968,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg","nickname":"hcyycb","note":"","ucode":"77FF6CA41F9E66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553978,"discussion_content":"同学，你的问题解决了吗？是不是clusterIP 在 ipvs 模式，跨node节点是curl访问不了的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646149256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300351,"user_name":"独孤九剑","can_delete":false,"product_type":"c1","uid":2230909,"ip_address":"","ucode":"6C1253E2B8C1D4","user_header":"https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg","comment_is_top":false,"comment_ctime":1625125316,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625125316","product_id":100015201,"comment_content":"“服务”本质是一种“反向代理”机制","like_count":0},{"had_liked":false,"id":296109,"user_name":"Shen","can_delete":false,"product_type":"c1","uid":1182167,"ip_address":"","ucode":"CFF7609A754392","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/d7/ffe7b0bf.jpg","comment_is_top":false,"comment_ctime":1622766758,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622766758","product_id":100015201,"comment_content":"还是不太明白Iptables和IPVS","like_count":0},{"had_liked":false,"id":287282,"user_name":"肚子","can_delete":false,"product_type":"c1","uid":1475826,"ip_address":"","ucode":"18CA41EF46C6D1","user_header":"https://static001.geekbang.org/account/avatar/00/16/84/f2/47808d5a.jpg","comment_is_top":false,"comment_ctime":1617867804,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617867804","product_id":100015201,"comment_content":"[root@ctrl-master1 hedu]# kubectl apply -f busybox.yaml<br>service&#47;default-subdomain created<br>pod&#47;busybox1 created<br>You have new mail in &#47;var&#47;spool&#47;mail&#47;root<br>[root@ctrl-master1 hedu]# kubectl get svc<br>NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE<br>default-subdomain   ClusterIP   None          &lt;none&gt;        1234&#47;TCP   15s<br>kubernetes          ClusterIP   10.178.64.1   &lt;none&gt;        443&#47;TCP    93d<br>[root@ctrl-master1 hedu]# kubectl get pod -owide<br>NAME       READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES<br>busybox1   1&#47;1     Running   0          21s   10.132.7.236   192.168.1.3   &lt;none&gt;           &lt;none&gt;<br>[root@ctrl-master1 hedu]# ping busybox-1.default-subdomain.default.svc.cluster.local<br>ping: busybox-1.default-subdomain.default.svc.cluster.local: Name or service not known<br><br>是我哪里实践有问题吗？解析不了pod域名","like_count":0},{"had_liked":false,"id":270024,"user_name":"Dunbreak","can_delete":false,"product_type":"c1","uid":1155210,"ip_address":"","ucode":"A64010733754BF","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/8a/69f4023c.jpg","comment_is_top":false,"comment_ctime":1608880868,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608880868","product_id":100015201,"comment_content":"在 wsl的ubuntu下，单纯绑定一个service和deployment无法通过curl + IP访问这个service，不知道有没有人遇到过这个问题，有什么解决方法？","like_count":0},{"had_liked":false,"id":250190,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1600964527,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1600964527","product_id":100015201,"comment_content":"感觉现在k8s最缺少是描述一个pod可以访问哪些资源的功能，如果是一个有限的网络，不光安全性有保障，网络的规则下发也更快速和敏捷，未来会考虑这种设限的网络声明功能吗？","like_count":0,"discussions":[{"author":{"id":1033219,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","nickname":"JianXu","note":"","ucode":"2A61BDBB573BDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592056,"discussion_content":"network policy ? ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667051106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250184,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1600962915,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1600962915","product_id":100015201,"comment_content":"如果很多service，不是有很多ipvs的网卡？","like_count":0,"discussions":[{"author":{"id":1201970,"avatar":"https://static001.geekbang.org/account/avatar/00/12/57/32/c219f938.jpg","nickname":"酸柚子","note":"","ucode":"B45571609BB92F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330890,"discussion_content":"不会， 可以绑定多个IP","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606726963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250183,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1600962804,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1600962804","product_id":100015201,"comment_content":"ipvs的vip是每台机器都创建了？","like_count":0,"discussions":[{"author":{"id":1033219,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","nickname":"JianXu","note":"","ucode":"2A61BDBB573BDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592057,"discussion_content":"应该是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667051135,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239401,"user_name":"海盗船长","can_delete":false,"product_type":"c1","uid":1363634,"ip_address":"","ucode":"ECB28BA21A4113","user_header":"https://static001.geekbang.org/account/avatar/00/14/ce/b2/1f914527.jpg","comment_is_top":false,"comment_ctime":1596524423,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1596524423","product_id":100015201,"comment_content":"镜像image: k8s.gcr.io&#47;serve_hostname 如果拉取不下来，可以换成image: gcr.azk8s.cn&#47;google-containers&#47;serve_hostname","like_count":0,"discussions":[{"author":{"id":1318243,"avatar":"https://static001.geekbang.org/account/avatar/00/14/1d/63/62078f19.jpg","nickname":"张国旗","note":"","ucode":"AF519777AB262E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300282,"discussion_content":"image: anjia0532/serve_hostname","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598010244,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1213988,"avatar":"https://static001.geekbang.org/account/avatar/00/12/86/24/c9365583.jpg","nickname":"Jane","note":"","ucode":"D6CCAA4E001F9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1318243,"avatar":"https://static001.geekbang.org/account/avatar/00/14/1d/63/62078f19.jpg","nickname":"张国旗","note":"","ucode":"AF519777AB262E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572090,"discussion_content":"谢谢\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652598251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300282,"ip_address":""},"score":572090,"extra":""}]}]},{"had_liked":false,"id":232659,"user_name":"Geek_9e499c","can_delete":false,"product_type":"c1","uid":2057530,"ip_address":"","ucode":"2445BBC6F42C1C","user_header":"","comment_is_top":false,"comment_ctime":1594081883,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594081883","product_id":100015201,"comment_content":"老师，我购买课程只为解决一个问题，就是coredns的安装问题，到时课程好像没提到，现象是这样的：目前集群安装好并且运行一段时间，但是pod访问不带选择器外部mysql的service名称时候，不起作用，本人特地禁用了环境变量的注入。","like_count":0},{"had_liked":false,"id":200268,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1397271,"ip_address":"","ucode":"B62BEA525A64A1","user_header":"https://static001.geekbang.org/account/avatar/00/15/52/17/083d67fb.jpg","comment_is_top":false,"comment_ctime":1585566649,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585566649","product_id":100015201,"comment_content":"请问老师， 跨命名空间的时候，是否还能通过  svcName.namespace 进行对 service的访问呢？","like_count":0},{"had_liked":false,"id":200267,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1397271,"ip_address":"","ucode":"B62BEA525A64A1","user_header":"https://static001.geekbang.org/account/avatar/00/15/52/17/083d67fb.jpg","comment_is_top":false,"comment_ctime":1585566593,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1585566593","product_id":100015201,"comment_content":"请问老师，命名空间的隔离是否限制了 service通过 dns方式进行访问呢？ ","like_count":0,"discussions":[{"author":{"id":1048358,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJeqy27pXAvufBYicAhPbEnxE4mhKGCXSsMn0rM8xAf5O7e4lFc8ImicdSJG8w2cypdJN7bKTNNgOxA/132","nickname":"init","note":"","ucode":"3F56F410B9708A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354375,"discussion_content":"dns是全局的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615282891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":198662,"user_name":"vincent","can_delete":false,"product_type":"c1","uid":1796234,"ip_address":"","ucode":"9FAD09D87C1E42","user_header":"","comment_is_top":false,"comment_ctime":1585462852,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585462852","product_id":100015201,"comment_content":"老师，是否有查询命令可以显示出DNS服务器记录的所有DNS","like_count":0},{"had_liked":false,"id":198661,"user_name":"vincent","can_delete":false,"product_type":"c1","uid":1796234,"ip_address":"","ucode":"9FAD09D87C1E42","user_header":"","comment_is_top":false,"comment_ctime":1585462791,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585462791","product_id":100015201,"comment_content":"在创建pod后好像没有pod的dns，pod中resolve的查询顺序：<br>svc.cluster.local cluster.local<br>没有查到文章中提到..pod.cluster.local格式的dns","like_count":0},{"had_liked":false,"id":195936,"user_name":"那迦树","can_delete":false,"product_type":"c1","uid":1055625,"ip_address":"","ucode":"34519C1DEA41A0","user_header":"https://static001.geekbang.org/account/avatar/00/10/1b/89/b7fae170.jpg","comment_is_top":false,"comment_ctime":1585224870,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585224870","product_id":100015201,"comment_content":"我们项目整合完k8s之后，有很多服务有对外暴露地址的需求，这里我们通过网关解决了这个问题，不知道还有没有其他的办法","like_count":0},{"had_liked":false,"id":186287,"user_name":"AmyHuang","can_delete":false,"product_type":"c1","uid":1078721,"ip_address":"","ucode":"3EF94E7B9F0CBA","user_header":"https://static001.geekbang.org/account/avatar/00/10/75/c1/431039c0.jpg","comment_is_top":false,"comment_ctime":1583818055,"is_pvip":false,"replies":[{"id":"72831","content":"这个很复杂，需要跟踪整个数据链路来做判断，尤其是iptables规则是不是被周期性改动了","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1584422971,"ip_address":"","comment_id":186287,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1583818055","product_id":100015201,"comment_content":"老师 现在有个问题请教：service 三副本 把一个副本所在节点驱逐，pod迁移到新的节点有一段时间可以telnet podip +port，但是直接curl service +port 会有数据中断，这个可能是我们设置什么导致呢？","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486706,"discussion_content":"这个很复杂，需要跟踪整个数据链路来做判断，尤其是iptables规则是不是被周期性改动了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584422971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1033219,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","nickname":"JianXu","note":"","ucode":"2A61BDBB573BDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592061,"discussion_content":"我们公司就是一路抓包，后来觉得这样太累，给所有节点部署pod man 用ebpf ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667051304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54853,"user_name":"ohgenlong","can_delete":false,"product_type":"c1","uid":1101682,"ip_address":"","ucode":"3D2B4CBA5538D5","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/72/bcb09995.jpg","comment_is_top":false,"comment_ctime":1545970021,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1545970021","product_id":100015201,"comment_content":"老师好，kube-proxy的ipvs的模式是什么模式哈？我看他的网段都不一样，应该不是dr模式","like_count":0,"discussions":[{"author":{"id":1474931,"avatar":"","nickname":"Geek_df0ab0","note":"","ucode":"32669D2692BFF1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273630,"discussion_content":"nat吧。如果dr模式的话要在每个pod里都配置一个甚至多个service的VIP","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590480922,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":39787,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1542356830,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542356830","product_id":100015201,"comment_content":"请教一下，在没有Service的情况下，每个POD有自己的DNS A记录吗？","like_count":0},{"had_liked":false,"id":39752,"user_name":"lane","can_delete":false,"product_type":"c1","uid":1220780,"ip_address":"","ucode":"9F76D2BEB610AA","user_header":"https://static001.geekbang.org/account/avatar/00/12/a0/ac/a23f48e3.jpg","comment_is_top":false,"comment_ctime":1542346850,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1542346850","product_id":100015201,"comment_content":"老师，后面会介绍ingress吗？","like_count":0},{"had_liked":false,"id":39661,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1542332671,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1542332671","product_id":100015201,"comment_content":"请教一下，如果不指定一个service的类型，那么创建出来后是NodePort类型的吗？","like_count":0,"discussions":[{"author":{"id":1720144,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/3f/50/bf9e9e92.jpg","nickname":"马宏伟","note":"","ucode":"D72048FB04D550","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41087,"discussion_content":"默认是clusterIP","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1572347982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}