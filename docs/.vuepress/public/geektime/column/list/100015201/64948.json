{"id":64948,"title":"32 | 浅谈容器网络","content":"<p>你好，我是张磊。今天我和你分享的主题是：浅谈容器网络。</p><p>在前面讲解容器基础时，我曾经提到过一个Linux容器能看见的“网络栈”，实际上是被隔离在它自己的Network Namespace当中的。</p><p>而所谓“网络栈”，就包括了：网卡（Network Interface）、回环设备（Loopback Device）、路由表（Routing Table）和iptables规则。对于一个进程来说，这些要素，其实就构成了它发起和响应网络请求的基本环境。</p><p>需要指出的是，作为一个容器，它可以声明直接使用宿主机的网络栈（–net=host），即：不开启Network Namespace，比如：</p><pre><code>$ docker run –d –net=host --name nginx-host nginx\n</code></pre><p>在这种情况下，这个容器启动后，直接监听的就是宿主机的80端口。</p><p>像这样直接使用宿主机网络栈的方式，虽然可以为容器提供良好的网络性能，但也会不可避免地引入共享网络资源的问题，比如端口冲突。所以，<strong>在大多数情况下，我们都希望容器进程能使用自己Network Namespace里的网络栈，即：拥有属于自己的IP地址和端口。</strong></p><p>这时候，一个显而易见的问题就是：<span class=\"orange\">这个被隔离的容器进程，该如何跟其他Network Namespace里的容器进程进行交互呢？</span></p><!-- [[[read_end]]] --><p>为了理解这个问题，你其实可以把每一个容器看做一台主机，它们都有一套独立的“网络栈”。</p><p>如果你想要实现两台主机之间的通信，最直接的办法，就是把它们用一根网线连接起来；而如果你想要实现多台主机之间的通信，那就需要用网线，把它们连接在一台交换机上。</p><p>在Linux中，能够起到虚拟交换机作用的网络设备，是网桥（Bridge）。它是一个工作在数据链路层（Data Link）的设备，主要功能是根据MAC地址学习来将数据包转发到网桥的不同端口（Port）上。</p><p>当然，至于为什么这些主机之间需要MAC地址才能进行通信，这就是网络分层模型的基础知识了。不熟悉这块内容的读者，可以通过<a href=\"https://www.lifewire.com/layers-of-the-osi-model-illustrated-818017\">这篇文章</a>来学习一下。</p><p>而为了实现上述目的，Docker项目会默认在宿主机上创建一个名叫docker0的网桥，凡是连接在docker0网桥上的容器，就可以通过它来进行通信。</p><p>可是，我们又该如何把这些容器“连接”到docker0网桥上呢？</p><p>这时候，我们就需要使用一种名叫<strong>Veth Pair</strong>的虚拟设备了。</p><p>Veth Pair设备的特点是：它被创建出来后，总是以两张虚拟网卡（Veth Peer）的形式成对出现的。并且，从其中一个“网卡”发出的数据包，可以直接出现在与它对应的另一张“网卡”上，哪怕这两个“网卡”在不同的Network Namespace里。</p><p>这就使得Veth Pair常常被用作连接不同Network Namespace 的“网线”。</p><p>比如，现在我们启动了一个叫作nginx-1的容器：</p><pre><code>$ docker run –d --name nginx-1 nginx\n</code></pre><p>然后进入到这个容器中查看一下它的网络设备：</p><pre><code># 在宿主机上\n$ docker exec -it nginx-1 /bin/bash\n# 在容器里\nroot@2b3c181aecf1:/# ifconfig\neth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500\n        inet 172.17.0.2  netmask 255.255.0.0  broadcast 0.0.0.0\n        inet6 fe80::42:acff:fe11:2  prefixlen 64  scopeid 0x20&lt;link&gt;\n        ether 02:42:ac:11:00:02  txqueuelen 0  (Ethernet)\n        RX packets 364  bytes 8137175 (7.7 MiB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 281  bytes 21161 (20.6 KiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n        \nlo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536\n        inet 127.0.0.1  netmask 255.0.0.0\n        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;\n        loop  txqueuelen 1000  (Local Loopback)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 0  bytes 0 (0.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n        \n$ route\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\ndefault         172.17.0.1      0.0.0.0         UG    0      0        0 eth0\n172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0\n</code></pre><p>可以看到，这个容器里有一张叫作eth0的网卡，它正是一个Veth Pair设备在容器里的这一端。</p><p>通过route命令查看nginx-1容器的路由表，我们可以看到，这个eth0网卡是这个容器里的默认路由设备；所有对172.17.0.0/16网段的请求，也会被交给eth0来处理（第二条172.17.0.0路由规则）。</p><p>而这个Veth Pair设备的另一端，则在宿主机上。你可以通过查看宿主机的网络设备看到它，如下所示：</p><pre><code># 在宿主机上\n$ ifconfig\n...\ndocker0   Link encap:Ethernet  HWaddr 02:42:d8:e4:df:c1  \n          inet addr:172.17.0.1  Bcast:0.0.0.0  Mask:255.255.0.0\n          inet6 addr: fe80::42:d8ff:fee4:dfc1/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:309 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:372 errors:0 dropped:0 overruns:0 carrier:0\n collisions:0 txqueuelen:0 \n          RX bytes:18944 (18.9 KB)  TX bytes:8137789 (8.1 MB)\nveth9c02e56 Link encap:Ethernet  HWaddr 52:81:0b:24:3d:da  \n          inet6 addr: fe80::5081:bff:fe24:3dda/64 Scope:Link\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:288 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:371 errors:0 dropped:0 overruns:0 carrier:0\n collisions:0 txqueuelen:0 \n          RX bytes:21608 (21.6 KB)  TX bytes:8137719 (8.1 MB)\n          \n$ brctl show\nbridge name bridge id  STP enabled interfaces\ndocker0  8000.0242d8e4dfc1 no  veth9c02e56\n</code></pre><p>通过ifconfig命令的输出，你可以看到，nginx-1容器对应的Veth Pair设备，在宿主机上是一张虚拟网卡。它的名字叫作veth9c02e56。并且，通过brctl show的输出，你可以看到这张网卡被“插”在了docker0上。</p><p>这时候，如果我们再在这台宿主机上启动另一个Docker容器，比如nginx-2：</p><pre><code>$ docker run –d --name nginx-2 nginx\n$ brctl show\nbridge name bridge id  STP enabled interfaces\ndocker0  8000.0242d8e4dfc1 no  veth9c02e56\n       vethb4963f3\n</code></pre><p>你就会发现一个新的、名叫vethb4963f3的虚拟网卡，也被“插”在了docker0网桥上。</p><p>这时候，如果你在nginx-1容器里ping一下nginx-2容器的IP地址（172.17.0.3），就会发现同一宿主机上的两个容器默认就是相互连通的。</p><p><span class=\"orange\">这其中的原理其实非常简单，我来解释一下。</span></p><p>当你在nginx-1容器里访问nginx-2容器的IP地址（比如ping 172.17.0.3）的时候，这个目的IP地址会匹配到nginx-1容器里的第二条路由规则。可以看到，这条路由规则的网关（Gateway）是0.0.0.0，这就意味着这是一条直连规则，即：凡是匹配到这条规则的IP包，应该经过本机的eth0网卡，通过二层网络直接发往目的主机。</p><p>而要通过二层网络到达nginx-2容器，就需要有172.17.0.3这个IP地址对应的MAC地址。所以nginx-1容器的网络协议栈，就需要通过eth0网卡发送一个ARP广播，来通过IP地址查找对应的MAC地址。</p><blockquote>\n<p>备注：ARP（Address Resolution Protocol），是通过三层的IP地址找到对应的二层MAC地址的协议。</p>\n</blockquote><p>我们前面提到过，这个eth0网卡，是一个Veth Pair，它的一端在这个nginx-1容器的Network Namespace里，而另一端则位于宿主机上（Host Namespace），并且被“插”在了宿主机的docker0网桥上。</p><p>一旦一张虚拟网卡被“插”在网桥上，它就会变成该网桥的“从设备”。从设备会被“剥夺”调用网络协议栈处理数据包的资格，从而“降级”成为网桥上的一个端口。而这个端口唯一的作用，就是接收流入的数据包，然后把这些数据包的“生杀大权”（比如转发或者丢弃），全部交给对应的网桥。</p><p>所以，在收到这些ARP请求之后，docker0网桥就会扮演二层交换机的角色，把ARP广播转发到其他被“插”在docker0上的虚拟网卡上。这样，同样连接在docker0上的nginx-2容器的网络协议栈就会收到这个ARP请求，从而将172.17.0.3所对应的MAC地址回复给nginx-1容器。</p><p>有了这个目的MAC地址，nginx-1容器的eth0网卡就可以将数据包发出去。</p><p>而根据Veth Pair设备的原理，这个数据包会立刻出现在宿主机上的veth9c02e56虚拟网卡上。不过，此时这个veth9c02e56网卡的网络协议栈的资格已经被“剥夺”，所以这个数据包就直接流入到了docker0网桥里。</p><p>docker0处理转发的过程，则继续扮演二层交换机的角色。此时，docker0网桥根据数据包的目的MAC地址（也就是nginx-2容器的MAC地址），在它的CAM表（即交换机通过MAC地址学习维护的端口和MAC地址的对应表）里查到对应的端口（Port）为：vethb4963f3，然后把数据包发往这个端口。</p><p>而这个端口，正是nginx-2容器“插”在docker0网桥上的另一块虚拟网卡，当然，它也是一个Veth Pair设备。这样，数据包就进入到了nginx-2容器的Network Namespace里。</p><p>所以，nginx-2容器看到的情况是，它自己的eth0网卡上出现了流入的数据包。这样，nginx-2的网络协议栈就会对请求进行处理，最后将响应（Pong）返回到nginx-1。</p><p>以上，就是同一个宿主机上的不同容器通过docker0网桥进行通信的流程了。我把这个流程总结成了一幅示意图，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/e0/66/e0d28e0371f93af619e91a86eda99a66.png?wh=1715*995\" alt=\"\"><br>\n需要注意的是，在实际的数据传递时，上述数据的传递过程在网络协议栈的不同层次，都有Linux内核Netfilter参与其中。所以，如果感兴趣的话，你可以通过打开iptables的TRACE功能查看到数据包的传输过程，具体方法如下所示：</p><pre><code># 在宿主机上执行\n$ iptables -t raw -A OUTPUT -p icmp -j TRACE\n$ iptables -t raw -A PREROUTING -p icmp -j TRACE\n</code></pre><p>通过上述设置，你就可以在/var/log/syslog里看到数据包传输的日志了。这一部分内容，你可以在课后结合<a href=\"https://en.wikipedia.org/wiki/Iptables\">iptables的相关知识</a>进行实践，从而验证我和你分享的数据包传递流程。</p><p>熟悉了docker0网桥的工作方式，你就可以理解，在默认情况下，<strong>被限制在Network Namespace里的容器进程，实际上是通过Veth Pair设备+宿主机网桥的方式，实现了跟同其他容器的数据交换。</strong></p><p>与之类似地，当你在一台宿主机上，访问该宿主机上的容器的IP地址时，这个请求的数据包，也是先根据路由规则到达docker0网桥，然后被转发到对应的Veth Pair设备，最后出现在容器里。这个过程的示意图，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/9f/01/9fb381d1e49318bb6a67bda3f9db6901.png?wh=1715*995\" alt=\"\"><br>\n同样地，当一个容器试图连接到另外一个宿主机时，比如：ping 10.168.0.3，它发出的请求数据包，首先经过docker0网桥出现在宿主机上。然后根据宿主机的路由表里的直连路由规则（10.168.0.0/24 via eth0)），对10.168.0.3的访问请求就会交给宿主机的eth0处理。</p><p>所以接下来，这个数据包就会经宿主机的eth0网卡转发到宿主机网络上，最终到达10.168.0.3对应的宿主机上。当然，这个过程的实现要求这两台宿主机本身是连通的。这个过程的示意图，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/90/95/90bd630c0723ea8a1fb7ccd738ad1f95.png?wh=1834*994\" alt=\"\"><br>\n所以说，<strong>当你遇到容器连不通“外网”的时候，你都应该先试试docker0网桥能不能ping通，然后查看一下跟docker0和Veth Pair设备相关的iptables规则是不是有异常，往往就能够找到问题的答案了。</strong></p><p>不过，在最后一个“Docker容器连接其他宿主机”的例子里，你可能已经联想到了这样一个问题：如果在另外一台宿主机（比如：10.168.0.3）上，也有一个Docker容器。那么，我们的nginx-1容器又该如何访问它呢？</p><p>这个问题，其实就是容器的“跨主通信”问题。</p><p>在Docker的默认配置下，一台宿主机上的docker0网桥，和其他宿主机上的docker0网桥，没有任何关联，它们互相之间也没办法连通。所以，连接在这些网桥上的容器，自然也没办法进行通信了。</p><p>不过，万变不离其宗。</p><p>如果我们通过软件的方式，创建一个整个集群“公用”的网桥，然后把集群里的所有容器都连接到这个网桥上，不就可以相互通信了吗？</p><p>说得没错。</p><p>这样一来，我们整个集群里的容器网络就会类似于下图所示的样子：</p><p><img src=\"https://static001.geekbang.org/resource/image/b4/3d/b4387a992352109398a66d1dbe6e413d.png?wh=1828*721\" alt=\"\"><br>\n可以看到，构建这种容器网络的核心在于：我们需要在已有的宿主机网络上，再通过软件构建一个覆盖在已有宿主机网络之上的、可以把所有容器连通在一起的虚拟网络。所以，这种技术就被称为：Overlay Network（覆盖网络）。</p><p>而这个Overlay Network本身，可以由每台宿主机上的一个“特殊网桥”共同组成。比如，当Node 1上的Container 1要访问Node 2上的Container 3的时候，Node 1上的“特殊网桥”在收到数据包之后，能够通过某种方式，把数据包发送到正确的宿主机，比如Node 2上。而Node 2上的“特殊网桥”在收到数据包后，也能够通过某种方式，把数据包转发给正确的容器，比如Container 3。</p><p>甚至，每台宿主机上，都不需要有一个这种特殊的网桥，而仅仅通过某种方式配置宿主机的路由表，就能够把数据包转发到正确的宿主机上。这些内容，我在后面的文章中会为你一一讲述。</p><h2>总结</h2><p>在今天这篇文章中，我主要为你介绍了在本地环境下，单机容器网络的实现原理和docker0网桥的作用。</p><p>这里的关键在于，容器要想跟外界进行通信，它发出的IP包就必须从它的Network Namespace里出来，来到宿主机上。</p><p>而解决这个问题的方法就是：为容器创建一个一端在容器里充当默认网卡、另一端在宿主机上的Veth Pair设备。</p><p>上述单机容器网络的知识，是后面我们讲解多机容器网络的重要基础，请务必认真消化理解。</p><h2>思考题</h2><p>尽管容器的Host Network模式有一些缺点，但是它性能好、配置简单，并且易于调试，所以很多团队会直接使用Host Network。那么，如果要在生产环境中使用容器的Host Network模式，你觉得需要做哪些额外的准备工作呢？</p><p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。</p><p></p>","neighbors":{"left":{"article_title":"31 | 容器存储实践：CSI插件编写指南","id":64392},"right":{"article_title":"33 | 深入解析容器跨主机网络","id":65287}},"comments":[{"had_liked":false,"id":37956,"user_name":"blackpiglet","can_delete":false,"product_type":"c1","uid":1032928,"ip_address":"","ucode":"58AA8329C91767","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg","comment_is_top":false,"comment_ctime":1541825350,"is_pvip":false,"discussion_count":11,"race_medal":0,"score":"903484957510","product_id":100015201,"comment_content":"看到有位同学问怎么找 docker 和 宿主机上 veth 设备的关系，学完后我也有这个疑问，查了一下，结论是没有命令可以直接查到。但是可以查看 container 里的 eth0 网卡的 iflink 找到对应关系。<br># 宿主机上<br>$ ip link <br>......<br>9: veth0e9cd8d@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default <br>    link&#47;ether 6a:fb:59:e5:7e:da brd ff:ff:ff:ff:ff:ff link-netnsid 1<br><br># 容器内<br>$ sudo docker exec -it e151 bash<br>root@e1517e9d9e1a:&#47;# cat &#47;sys&#47;class&#47;net&#47;eth0&#47;iflink <br>9<br><br>这样就可以确定 container e1517e9d9e1a 在物理机上对应的 veth pair 是 veth0e9cd8d 了。<br><br>这种方式需要登录到 docker 里执行命令，不是所有的容器都能这么做，不过 github 上有人专门做了个脚本来用实现这个功能，可以参考一下：<br>https:&#47;&#47;github.com&#47;micahculpepper&#47;dockerveth","like_count":211,"discussions":[{"author":{"id":1493414,"avatar":"https://static001.geekbang.org/account/avatar/00/16/c9/a6/e26048f8.jpg","nickname":"晓丹🤒","note":"","ucode":"432BA150343E6B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542904,"discussion_content":"容器内执行 ethtool -S eth0 | grep peer_ifindex, 可以看到对端序列号，然后宿主机上 ip link | grep 那个序列号也可以找到","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1640877984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1793475,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/5d/c3/69019d24.jpg","nickname":"江东","note":"","ucode":"391A62BC7039B3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563044,"discussion_content":"启用、禁用接口\n  ip link set device down   禁用指定接口\n  ip link set device up    启用指定接口\n\n  比如禁用eth0就是ip link set eth0 down\n (ifconfig 查看接口)","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1649928348,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1476242,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoH0yFsw11puZt1kX9aNDicW5REJljurmD9MBWo9h0mFibNjdzWtEZZhMZErBSvAg8co8NM3Jib0oqrA/132","nickname":"Geek_e0cb26","note":"","ucode":"68E20693D2EE95","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588744,"discussion_content":"直接用ip addr看得更清楚,,\napt-get update &amp;&amp; apt-get install iproute2\n$ ip addr\n351: eth0@if352: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default\n    link/ether 02:42:ac:1d:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 172.29.0.2/16 brd 172.29.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n关于网桥网络, 看到一篇不错的文章: \nhttps://mp.weixin.qq.com/s?__biz=MzIwODI1ODI0Mw==&amp;mid=2651298967&amp;idx=1&amp;sn=74e45187c6b6dfe8dbf831a41f3d0dd5&amp;chksm=8cf6e93bbb81602dd3587232e767e32e7accff835cd872955003f72cfee38e6b804798df53c1&amp;token=1359849894&amp;lang=zh_CN#rd","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664069330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ff/08/7c18d8a4.jpg","nickname":"团","note":"","ucode":"D56ABBCE4E4D90","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542899,"discussion_content":"牛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640876970,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1313840,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0c/30/bb4bfe9d.jpg","nickname":"lyonger","note":"","ucode":"E89A75DADEA2A1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384773,"discussion_content":"为啥宿主机器的ifindex编号要比容器里面的小1？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626746900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1122150,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1f/66/59e0647a.jpg","nickname":"万历十五年","note":"","ucode":"3D8CF5DF847AE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371122,"discussion_content":"赞，非常好用的方法👍\n查看 container 里的 eth0 网卡的 iflink 找到对应关系。\n# 宿主机上\n$ ip link \n......\n9: veth0e9cd8d@if8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default \n    link/ether 6a:fb:59:e5:7e:da brd ff:ff:ff:ff:ff:ff link-netnsid 1\n\n# 容器内\n$ sudo docker exec -it e151 bash\nroot@e1517e9d9e1a:/# cat /sys/class/net/eth0/iflink \n9\n\n这样就可以确定 container e1517e9d9e1a 在物理机上对应的 veth pair 是 veth0e9cd8d 了。\n\n这种方式需要登录到 docker 里执行命令，不是所有的容器都能这么做，不过 github 上有人专门做了个脚本来用实现这个功能，可以参考一下：\nhttps://github.com/micahculpepper/dockerveth","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619658569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1090196,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a2/94/ae0a60d8.jpg","nickname":"江山未","note":"","ucode":"5293DD9482717F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309848,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601461326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2043157,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/2d/15/efa5f9f7.jpg","nickname":"漂流瓶","note":"","ucode":"42F8B4724D1C53","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288214,"discussion_content":"感谢这位同学解惑\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593680131,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1484283,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a5/fb/e78299a6.jpg","nickname":"szh","note":"","ucode":"6DFDF4883AB576","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":233633,"discussion_content":"这个很好","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586935747,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1205253,"avatar":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","nickname":"我来也","note":"","ucode":"773D6104F56767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":228919,"discussion_content":"哈哈,复习的时候按着你的说明实操了下,确实不错!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586590065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1260026,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","nickname":"安排","note":"","ucode":"F78CFA9624CAEF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":114224,"discussion_content":"牛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577964357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38121,"user_name":"Jianwen Ji","can_delete":false,"product_type":"c1","uid":1027028,"ip_address":"","ucode":"20A8AC1AA8A8E9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erHaczgBsEF7zqCj8Hlq2vtYh0M6Jj3pia66ZW0O4fFvNldbkHYX6d8B0fBHwicxAcMMRmcNzPrJLMA/132","comment_is_top":false,"comment_ctime":1541946334,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"242060114910","product_id":100015201,"comment_content":"当一个容器试图连接到另外一个宿主机时，比如：ping 10.168.0.3，它发出的请求数据包，首先经过 docker0 网桥出现在宿主机上。宿主机再把这个ping包发送出去之前会做源nat转换，把源ip改成宿主机的ip。大家可以分别在docker0和宿主机的真实网卡上tcpdump 抓包看一下。在宿主机用iptables -L -t nat就能看到相应的规则。","like_count":56,"discussions":[{"author":{"id":1201777,"avatar":"https://static001.geekbang.org/account/avatar/00/12/56/71/fb2d9923.jpg","nickname":"Kerwin","note":"","ucode":"082382EFB0A1A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":44981,"discussion_content":"不改的话，目的宿主机不会认识容器的ip，就无法通信了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1572998328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2254917,"avatar":"https://static001.geekbang.org/account/avatar/00/22/68/45/ddf89612.jpg","nickname":"bestgopher","note":"","ucode":"D89735C8CA9C6E","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544761,"discussion_content":"的确需要把源地址转换下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641700004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ff/08/7c18d8a4.jpg","nickname":"团","note":"","ucode":"D56ABBCE4E4D90","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542900,"discussion_content":"确实这一点在数据流转过程中比较重要，估计作者忘记提了吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640877178,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1057843,"avatar":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","nickname":"阿甘","note":"","ucode":"BC93175B70E05D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540487,"discussion_content":"赞，我觉得这个关键点作者没有提到实在不应该","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640067896,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2054990,"avatar":"","nickname":"海柔儿稀罕","note":"","ucode":"CBEEBEA2CAE8A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290426,"discussion_content":"确实是看到了与外部互通进行了SNAT可以通过抓包看到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594468363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1131907,"avatar":"https://static001.geekbang.org/account/avatar/00/11/45/83/93d389ba.jpg","nickname":"我是谁","note":"","ucode":"AE3996142811F4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":264860,"discussion_content":"iptables没有看到源地址转换的规则啊，是靠iptables做的源地址转换吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589353417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2550335,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eor3yhoBAvuFPgibmLwRTtbFDvSyt9icTdco5fctGa31jVWWgYA8uKrAT2fEO0q3bep7HjtkiaTWHAiaA/132","nickname":"yxyjw999","note":"","ucode":"A4A3C810C8384E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1131907,"avatar":"https://static001.geekbang.org/account/avatar/00/11/45/83/93d389ba.jpg","nickname":"我是谁","note":"","ucode":"AE3996142811F4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384456,"discussion_content":"通过MASQUERADE进行原地址伪装","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1626599914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":264860,"ip_address":""},"score":384456,"extra":""}]}]},{"had_liked":false,"id":36846,"user_name":"pytimer","can_delete":false,"product_type":"c1","uid":1014666,"ip_address":"","ucode":"A0038F6CB1F9AC","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ercmNryEicqDS73icpUu7W0BnZ7ZIia6jR7kdVMIzH0q1d7L8EKAYWeTJcribibGcHnJzpsjRFxAe26egQ/132","comment_is_top":false,"comment_ctime":1541376259,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"207699806467","product_id":100015201,"comment_content":"使用host网络的话，应该要提前规划好每个服务应该使用的端口吧","like_count":48,"discussions":[{"author":{"id":1019036,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg","nickname":"dancer","note":"","ucode":"B8D5641A3AC490","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":206334,"discussion_content":"讲的真好！之前一直不理解为什么网桥上的veth收到了了数据，就能把它转发到别的容器，原来是这个veth被网桥降级成了一个端口","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1584382062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58093,"user_name":"程空万里","can_delete":false,"product_type":"c1","uid":1218737,"ip_address":"","ucode":"EAF054AE7D1AC7","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/b1/73268f62.jpg","comment_is_top":false,"comment_ctime":1546996184,"is_pvip":false,"replies":[{"id":"20977","content":"那就多留言哈","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1547019276,"ip_address":"","comment_id":58093,"utype":1}],"discussion_count":1,"race_medal":0,"score":"138985949656","product_id":100015201,"comment_content":"张老师对网络的讲解实在是太棒了，棒在并不使用高深的网络词语，那些高深的网络词语让人不知所述，头晕转向的，而是用最直白的讲话式加上配图来讲解，一看就懂，太喜欢了！少留言的我，都忍不住写留言！","like_count":33,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435901,"discussion_content":"那就多留言哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547019276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38328,"user_name":"kissingers","can_delete":false,"product_type":"c1","uid":1135299,"ip_address":"","ucode":"615151808CF628","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132","comment_is_top":false,"comment_ctime":1542021971,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"108916204371","product_id":100015201,"comment_content":"查看veth 对端接口还有一个办法：用 ethtool -S &lt;NIC&gt;，输出结果有一项peer_inindex，再在host 上用ip link show，可以对应到。","like_count":25,"discussions":[{"author":{"id":1113864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ff/08/7c18d8a4.jpg","nickname":"团","note":"","ucode":"D56ABBCE4E4D90","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542925,"discussion_content":"Mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640881289,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130611,"user_name":"Brave Shine","can_delete":false,"product_type":"c1","uid":1222003,"ip_address":"","ucode":"CBB1BAF89DB936","user_header":"https://static001.geekbang.org/account/avatar/00/12/a5/73/3ddc7c77.jpg","comment_is_top":false,"comment_ctime":1567494086,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"70286970822","product_id":100015201,"comment_content":"【简化版】<br>找 docker 和 宿主机上 veth 设备的关系<br>-  容器<br>ip netns exec netns1(network namespaces) ethool -S veth1 <br>找到这个字段：<br>NIC statistics：<br>  peer_ifindex: 5(序列号)<br><br>-  宿主机<br>ip netns exec netns2 ip link | grep 5 &lt;- 序列号<br><br>结果：veth0","like_count":16},{"had_liked":false,"id":36850,"user_name":"Acter","can_delete":false,"product_type":"c1","uid":1082561,"ip_address":"","ucode":"EF747BEAD2A797","user_header":"https://static001.geekbang.org/account/avatar/00/10/84/c1/dfcad82a.jpg","comment_is_top":false,"comment_ctime":1541376677,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"61670918821","product_id":100015201,"comment_content":"请问老师：docker0网桥和普通的linux网桥在实现上有什么区别吗？","like_count":14},{"had_liked":false,"id":258383,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1604404758,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"53144012310","product_id":100015201,"comment_content":"容器直接使用宿主机网络栈的方式，虽然简单且能提供比较好的网络性能，但是不可避免地引入了共享网络资源的问题，比如端口冲突。<br><br>容器使用Network Namespace进行隔离可以避免共享网络资源的问题，但该如何和其他容器进程交互？  <br>-&gt; 联系到多台物理机的交互是通过网线，共同连接到一个交换机来实现物理机的相互连通。 <br>-&gt; 到了容器，也有一个类似交换机的虚拟交换机设备，网桥（Bridge），凡是连接到这个网桥上的容器进程，都可以通过它来相互通信 <br>-&gt;  现在容器有了虚拟的交换机了，但是容器连接到“交换机”上的“网线”呢？  通过 Veth Pair来充当网线的功能，它被创建出来后，总是以两张虚拟网卡（Veth Peer）的形式成对出现，作为网线的两端。<br>-&gt; 因此： 在默认情况下，被限制在Network Namespace里的容器进程实际上是通过Veth Pari设备+宿主机网桥的方式，实现了跟其他容器的数据交换<br><br>现在解决了容器和同一个宿主机下其他容器交互的问题了，那么如果容器想要和其他宿主机上的容器交互，要如何实现？<br>-&gt; 答案和单个宿主机上容器互访相似，我们用软件或应将的方式创建一个整个集群“公用”的网桥，然后把集群里所有容器都连接到这个网桥上<br><br>-&gt; 构建这种容器网络的核心在于需要在已有的宿主机网络上，再通过软件构件一个覆盖在已有宿主机网络之上的、可以把所有容器连接在一起的虚拟网络。所以，这种技术就被称为：Overlay Network（覆盖网络）。<br>","like_count":12},{"had_liked":false,"id":37047,"user_name":"loda","can_delete":false,"product_type":"c1","uid":1043287,"ip_address":"","ucode":"3F9575DBFA1031","user_header":"https://static001.geekbang.org/account/avatar/00/0f/eb/57/3032e1a7.jpg","comment_is_top":false,"comment_ctime":1541431875,"is_pvip":false,"replies":[{"id":"13381","content":"当然可以。但这还是overlay，只是没用隧道。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541508024,"ip_address":"","comment_id":37047,"utype":1}],"discussion_count":7,"race_medal":0,"score":"53081039427","product_id":100015201,"comment_content":"请教个问题，默认情况两台主机的docker0无法互通，那么如果在这两台机器上配置了路由规则，将docker0的数据转发到eth0，两台机器通过网线或者交换机相连，这样是不是可以保证不用引入overlay network，容器之间也能互通","like_count":13,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428140,"discussion_content":"当然可以。但这还是overlay，只是没用隧道。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541508024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1073666,"avatar":"https://static001.geekbang.org/account/avatar/00/10/62/02/2370d8c0.jpg","nickname":"浮白","note":"","ucode":"6FB94B1EB3D4F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299691,"discussion_content":"IP包： 172.17.0.0 -> 网关（docker0） -> 10.168.0.0，大概过程就是这样的，在172.17.0.0网络下的IP包经过网关进入另一个网络10.168.0.0，如果把docker0类比成路由器，那么docker0在172.17.0.0这一侧充当网关，IP地址是172.17.0.1，同时在10.168.0.0这一侧充当这个网络上的一个主机，应该拥有着和10.168.0.2类似的IP（但不能是10.168.0.1），但是docker0在10.168.0.0这一侧是直接使用了10.168.0.2这个IP的吧，具体是怎么样的我也不清楚了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597766100,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120478,"avatar":"https://static001.geekbang.org/account/avatar/00/11/18/de/45875491.jpg","nickname":"蔺波","note":"","ucode":"C185D35419790C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":137060,"discussion_content":"你们的疑问是对的，也可以通过配置路由或者nat实现container的跨主机互通，而且这个不是overlay，因为并没有在contaiber数据包外面又包一层overlay信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579176824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1004165,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/52/85/99545c24.jpg","nickname":"叶王","note":"","ucode":"D7193A95D8281C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":120806,"discussion_content":"我也有这个疑问，前面说Node1的容器到Node2主机时，可以连接。后面马上说Node1的容器到Node2的容器无法连接，就有点让人困惑。其实按前面说的配置直连路由规则，都到Node2主机了，再到docker0，就进去容器了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578297115,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1073666,"avatar":"https://static001.geekbang.org/account/avatar/00/10/62/02/2370d8c0.jpg","nickname":"浮白","note":"","ucode":"6FB94B1EB3D4F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1004165,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/52/85/99545c24.jpg","nickname":"叶王","note":"","ucode":"D7193A95D8281C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299685,"discussion_content":"不行的，docker0即有2层网络的MAC地址，又有3层网络的IP地址，所以它更像是一个虚拟路由器，在一台宿主机上充当容器的网关。Node1中容器可以访问Node2宿主机，但是Node1中容器不能访问Node2宿主机中的容器，因为Node1和Node2的虚拟路由（docker0）具有相同的网络号（都是172.17.0.0），所以他们下面的容器也具有相同的网络号，这样，当Node1上的容器（假设是172.17.0.2）想访问Node2上容器（假设是172.17.0.3）时，容器的本地路由表能判断出172.13.0.3跟自己一样，同属一个数据链路层网络（因为网络号相同），那么就会直接通过数据链路层（以太网）进行通讯（如果没有对方的MAC地址会先用ARP广播查询对方的MAC）。这个时候只使用到了docker0的二层网络的能力，没有使用其3层网络的能力（IP路由控制），是不会走到网关（docker0）之外的。","likes_number":17,"is_delete":false,"is_hidden":false,"ctime":1597764693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":120806,"ip_address":""},"score":299685,"extra":""},{"author":{"id":1073666,"avatar":"https://static001.geekbang.org/account/avatar/00/10/62/02/2370d8c0.jpg","nickname":"浮白","note":"","ucode":"6FB94B1EB3D4F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1004165,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/52/85/99545c24.jpg","nickname":"叶王","note":"","ucode":"D7193A95D8281C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299688,"discussion_content":"Node1中的容器访问Node2时，通过路由表计算出IP包的下一跳是172.17.0.1，于是就发给了docker0网桥（这相当于我们的平时的主机把IP包发给网关，也就是路由器），从docker0到宿主机的转变过程我不清楚，但是下一步就是到了宿主机了，宿主机通过路由控制表计算出目标IP10.168.0.3跟自己在同一个链路网络上，对应的网卡是eth0，然后就使用eth0网卡将IP包发送到出去（发送前可能要通过ARP协议查找10.168.0.3的MAC地址），10.168.0.2和10.168.0.3在同一个链路网络上，所以不需要走路由再进行IP包的下一跳，10.168.0.3直接就收到了。","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1597765540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":120806,"ip_address":""},"score":299688,"extra":""},{"author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1073666,"avatar":"https://static001.geekbang.org/account/avatar/00/10/62/02/2370d8c0.jpg","nickname":"浮白","note":"","ucode":"6FB94B1EB3D4F6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536831,"discussion_content":"流弊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638878660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":299685,"ip_address":""},"score":536831,"extra":""}]}]},{"had_liked":false,"id":92395,"user_name":"饭粒","can_delete":false,"product_type":"c1","uid":1153455,"ip_address":"","ucode":"4C3220B0D43997","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg","comment_is_top":false,"comment_ctime":1557246457,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"48801886713","product_id":100015201,"comment_content":"nginx 内的ifconfig可以在容器内安装。<br># apt-get update <br># apt install net-tools","like_count":11,"discussions":[{"author":{"id":1054727,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/07/9f5f5dd3.jpg","nickname":"憶海拾貝","note":"","ucode":"99E883A8601DED","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":25126,"discussion_content":"nginx容器里可以用ip命令","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570430814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1056944,"avatar":"https://static001.geekbang.org/account/avatar/00/10/20/b0/0a1551c4.jpg","nickname":"日拱一卒","note":"","ucode":"3BDFD6F473862C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":20984,"discussion_content":"感觉用 debug container image 会好一点， 网络工具比较多， nginx 镜像都还要手动安装。 略麻烦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569410029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1500593,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIicibkDiceIZd7R3y57L7WIVFpVWU6ebp40G3ZNLFtlUWb7d4O5BpyxKQSd81FXo4rQFbQoUWu35jJg/132","nickname":"zhuxuxu","note":"","ucode":"DCD8E5D7F6F8A8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1056944,"avatar":"https://static001.geekbang.org/account/avatar/00/10/20/b0/0a1551c4.jpg","nickname":"日拱一卒","note":"","ucode":"3BDFD6F473862C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":268442,"discussion_content":"你说的这个是镜像吗 还是命令？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589777526,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":20984,"ip_address":""},"score":268442,"extra":""}]}]},{"had_liked":false,"id":36912,"user_name":"Yuki_YANG","can_delete":false,"product_type":"c1","uid":1218647,"ip_address":"","ucode":"C200463E3AB225","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/57/e6ef93ae.jpg","comment_is_top":false,"comment_ctime":1541385972,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48786026228","product_id":100015201,"comment_content":"文中&quot;通过 ifconfig 命令的输出，你可以看到，nginx-1 容器对应的 Veth Pair 设备, 在宿主机上是一张虚拟网卡。它的名字叫作veth9c02e56&quot;<br>请问下是用哪个命令看出来的, 貌似route, ifconfig, brctl, 找不到这个对应关系呢<br><br><br><br>","like_count":11},{"had_liked":false,"id":39117,"user_name":"帅","can_delete":false,"product_type":"c1","uid":1207367,"ip_address":"","ucode":"DB792F56C26429","user_header":"https://static001.geekbang.org/account/avatar/00/12/6c/47/57b6c4e8.jpg","comment_is_top":false,"comment_ctime":1542192025,"is_pvip":false,"replies":[{"id":"13980","content":"对<br>","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1542205017,"ip_address":"","comment_id":39117,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35901930393","product_id":100015201,"comment_content":"老师你好，网络的章节中讲到的二层网络和三层网络是分别指数据链路层和网络层么？","like_count":8,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428927,"discussion_content":"对\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542205017,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37902,"user_name":"kissingers","can_delete":false,"product_type":"c1","uid":1135299,"ip_address":"","ucode":"615151808CF628","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132","comment_is_top":false,"comment_ctime":1541780210,"is_pvip":false,"replies":[{"id":"13664","content":"对。这里其实都在二层ebtables处理的。我修改一下。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541842296,"ip_address":"","comment_id":37902,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35901518578","product_id":100015201,"comment_content":"老师，容器1访问容器2，直接docker0网桥根据转发表转发就行了，怎么还有先到docker0接口，路由选择，再回到docker0转发的过程？访问外网时才会有到docker0这个网关，再路由出去的过程吧？","like_count":8,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428519,"discussion_content":"对。这里其实都在二层ebtables处理的。我修改一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541842296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37046,"user_name":"loda","can_delete":false,"product_type":"c1","uid":1043287,"ip_address":"","ucode":"3F9575DBFA1031","user_header":"https://static001.geekbang.org/account/avatar/00/0f/eb/57/3032e1a7.jpg","comment_is_top":false,"comment_ctime":1541431616,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31606202688","product_id":100015201,"comment_content":"推荐使用ip link show来看veth-eth映射关系，可以看到ifconfig看不到的link","like_count":7},{"had_liked":false,"id":251594,"user_name":"Geek_633adb","can_delete":false,"product_type":"c1","uid":2078963,"ip_address":"","ucode":"6B12E1F3E7A631","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM7vS14iaOp9WSIviciaKibTorW43zeJD8kVqplSFLBCibYoXtR2Q3w9pRvpUwQHNlNcvNxexgpdxJTEpFg/132","comment_is_top":false,"comment_ctime":1601709215,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23076545695","product_id":100015201,"comment_content":"这课质量太高了, 吸收效果远胜于刚刚看完的&quot;阿里云原生技术公开课&quot;, 磊哥表达能力真的牛！","like_count":5},{"had_liked":false,"id":79269,"user_name":"gl328518397","can_delete":false,"product_type":"c1","uid":1293354,"ip_address":"","ucode":"05AF4661EF0AAF","user_header":"https://static001.geekbang.org/account/avatar/00/13/bc/2a/00a3d488.jpg","comment_is_top":false,"comment_ctime":1553420428,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18733289612","product_id":100015201,"comment_content":"nginx镜像没有ifconfig 这些命令吧？","like_count":4,"discussions":[{"author":{"id":1102245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/a5/2bbedc3b.jpg","nickname":"over","note":"","ucode":"FE272AC19842D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348998,"discussion_content":"安装一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612839238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52107,"user_name":"Devil May Cry.Samsara","can_delete":false,"product_type":"c1","uid":1067416,"ip_address":"","ucode":"007363CC2BB184","user_header":"https://static001.geekbang.org/account/avatar/00/10/49/98/a29a006e.jpg","comment_is_top":false,"comment_ctime":1545310568,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18725179752","product_id":100015201,"comment_content":"老师，你好，我想问个问题<br>docker的这个网络 vethpair网卡 ip是怎么来的么？<br>我无意发现 ，vethpair的ip都是之前都是172网段，  今天发现有个192的物理ip 居然访问不通了，，然后就发现 docker里面的 ip除了172网段 居然还有192网段，所以与物理192网段的路由表有冲突了<br>docker里面这个我用的都是默认网桥模式，这个vethpare 的ip到底怎么来的，难道不是从docker0的网桥上创建出来的么。<br>","like_count":4,"discussions":[{"author":{"id":2100644,"avatar":"","nickname":"Geek_8e2759","note":"","ucode":"EBDBA4D92B5C50","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320808,"discussion_content":"172.17.0.1/16 网段是 docker0 默认网段；如果还有 192 网段的，那是不是因为还有一个 192 网段的网桥，在这个网桥上也配置了一个 vethpair","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604483083,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37703,"user_name":"kissingers","can_delete":false,"product_type":"c1","uid":1135299,"ip_address":"","ucode":"615151808CF628","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132","comment_is_top":false,"comment_ctime":1541687631,"is_pvip":false,"replies":[{"id":"13573","content":"静态IP。访问外网为什么要NAT。同主机两张网卡要用什么连。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541719259,"ip_address":"","comment_id":37703,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18721556815","product_id":100015201,"comment_content":"docker0网桥有没有dhcp 功能？主机上的容器访问外网没有NAT？主机网卡没连到docker0？","like_count":4,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428457,"discussion_content":"静态IP。访问外网为什么要NAT。同主机两张网卡要用什么连。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541719259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2449777,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132","nickname":"types","note":"","ucode":"8B50927EF1804F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":359214,"discussion_content":"docker 访问外网是需要NAT的, 类似如下\niptables -t nat -A POSTROUTING -s 192.168.2.0/24 -o enp5s0 -j MASQUERADE\n仅仅根据路由规则，source IP不会变化，返回的消息无法到达source host　","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1616142898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164763,"user_name":"彬哥","can_delete":false,"product_type":"c1","uid":1148392,"ip_address":"","ucode":"6FF7945FF40DD4","user_header":"https://static001.geekbang.org/account/avatar/00/11/85/e8/1e3e5657.jpg","comment_is_top":false,"comment_ctime":1577087809,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14461989697","product_id":100015201,"comment_content":"在k8s的node 上看到两个bridge：<br>[root@iZbp199519zhaqjop2eeueZ ~]# brctl show<br>bridge name\tbridge id\t\tSTP enabled\tinterfaces<br>cni0\t\t8000.0a58ac140101\tno\t\tveth0982eb93<br>\t\t\t\t\t\t\tveth1ebba82a<br>\t\t\t\t\t\t\tveth25fd7752<br>\t\t\t\t\t\t\tveth2963c093<br>\t\t\t\t\t\t\tveth2f243ddd<br>\t\t\t\t\t\t\tveth319b6524<br>\t\t\t\t\t\t\tveth3c36e5f4<br>\t\t\t\t\t\t\tveth4554e1b9<br>\t\t\t\t\t\t\tveth4ccc7ce2<br>\t\t\t\t\t\t\tveth72769145<br>\t\t\t\t\t\t\tveth72fb8dcc<br>\t\t\t\t\t\t\tveth8b3290bf<br>\t\t\t\t\t\t\tveth98697671<br>\t\t\t\t\t\t\tvethd9a36cf2<br>\t\t\t\t\t\t\tvethf2f528fc<br>docker0\t\t8000.024284d8b746\tno","like_count":3,"discussions":[{"author":{"id":1366782,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/eQysJPqzuAoyrWzWyXyYibrAszp6B4WUic7g2TnO8ksfWtCibOEMRqQmCZk4xJwEPQwTRH21W4e2f77FoQTzL6Dhw/132","nickname":"钱涛","note":"","ucode":"B08EB10AD30D74","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323256,"discussion_content":"k8s使用的cni0的网络插件，没有用默认的docker网络？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604907958,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36910,"user_name":"fiisio","can_delete":false,"product_type":"c1","uid":1148088,"ip_address":"","ucode":"87CB8F5EAA033B","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/b8/0b73ecdc.jpg","comment_is_top":false,"comment_ctime":1541385695,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14426287583","product_id":100015201,"comment_content":"容器里面应该是veth 不是 eth吧？","like_count":3,"discussions":[{"author":{"id":1363634,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ce/b2/1f914527.jpg","nickname":"海盗船长","note":"","ucode":"ECB28BA21A4113","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290655,"discussion_content":"容器中接口就是eth0","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1594558605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1317899,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAWUhO0xSjD6wbGScY5WOujAE94vNYWlWmsVdibb0IWbXzSSNXJHp0lqfWVq8ZicKBsEY1EuAWArew/132","nickname":"Felix","note":"","ucode":"9318688F3C5419","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369155,"discussion_content":"名称可以修改啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618961072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46383,"user_name":"xumc","can_delete":false,"product_type":"c1","uid":1033274,"ip_address":"","ucode":"22D24AF9D52B65","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c4/3a/77bbc665.jpg","comment_is_top":false,"comment_ctime":1543912359,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10133846951","product_id":100015201,"comment_content":"有用mac的吗？在mac里docker run -d --name nginx-v2 nginx，  docker exec -it nginx-v2 &#47;bin&#47;bash<br>里没有ifconfig ipconfig, netstat -ns这样的命令，查了一下，mac上docker运行在虚拟机里，不用docker-0网桥<br>所以想问一下：MAC里如何理解docker的网络？<br>难道要搞虚拟机吗？","like_count":2,"discussions":[{"author":{"id":1401797,"avatar":"https://static001.geekbang.org/account/avatar/00/15/63/c5/a85ade71.jpg","nickname":"刘冬","note":"","ucode":"982676C96C0EB4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532576,"discussion_content":"我个人觉得最简单的方案，就是搞个Virtual Box，然后装Ubuntu，然后装Docker。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637648441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36974,"user_name":"虎虎❤️","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1541409868,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10131344460","product_id":100015201,"comment_content":"用host网络需要平台能够自动分配端口，避免冲突。并且application可以通过比如环境变量动态配置端口信息。","like_count":2},{"had_liked":false,"id":36904,"user_name":"silver","can_delete":false,"product_type":"c1","uid":1186740,"ip_address":"","ucode":"908E3C8560D6E1","user_header":"https://static001.geekbang.org/account/avatar/00/12/1b/b4/a6db1c1e.jpg","comment_is_top":false,"comment_ctime":1541384034,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10131318626","product_id":100015201,"comment_content":"当容器试图连接到别的宿主机时，容器的连接具体怎么被route到宿主机的eth0的呢？根据前文对“从设备”的描述，这些请求不是应该全被直接转发到了docker0上吗","like_count":2},{"had_liked":false,"id":292022,"user_name":"董永刚","can_delete":false,"product_type":"c1","uid":1169147,"ip_address":"","ucode":"ADA792B226A6CD","user_header":"https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg","comment_is_top":false,"comment_ctime":1620647217,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5915614513","product_id":100015201,"comment_content":"1、如何将veth paire设备和容器的关系对应起来？<br>首先： 在容器内执行 ip link 命令 （也可以使用 ip addr 命令，只是出入内容比 ip link 命令更详细，这里不需要那么详细 ）<br>root@d03940d4deb7:&#47;# ip link   \t# 第1个容器中执行<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000<br>    link&#47;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>32: eth0@if33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default <br>    link&#47;ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br><br>root@4a92ae9c8a04:&#47;# ip link \t # 第2个容器中执行<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000<br>    link&#47;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>34: eth0@if35: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default <br>    link&#47;ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff<br>注意标记的荒地红色加粗字体<br><br>然后，在宿主机中执行 <br>[root@VM-12-2-centos container_network_xuexi]# ip link<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000<br>    link&#47;loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000<br>    link&#47;ether 52:54:00:9b:57:b4 brd ff:ff:ff:ff:ff:ff<br>3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default <br>    link&#47;ether 02:42:42:28:61:42 brd ff:ff:ff:ff:ff:ff<br>33: veth56a81c2@if32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default <br>    link&#47;ether 32:18:bb:35:43:6d brd ff:ff:ff:ff:ff:ff link-netnsid 0<br>35: veth0a71d12@if34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default <br>    link&#47;ether e2:82:eb:a8:6d:13 brd ff:ff:ff:ff:ff:ff link-netnsid 1<br>这样就找到了对应关系","like_count":1},{"had_liked":false,"id":92243,"user_name":"六天天天向上","can_delete":false,"product_type":"c1","uid":1518477,"ip_address":"","ucode":"D21973B2A51690","user_header":"https://static001.geekbang.org/account/avatar/00/17/2b/8d/14bb07d4.jpg","comment_is_top":false,"comment_ctime":1557211416,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5852178712","product_id":100015201,"comment_content":"默认按照的Ubuntu或者centos是没有ifconfig或ping命令的，在ubuntu里安装的命令是；<br>apt-get update<br>&#47;&#47;ifconfig <br>apt install net-tools       <br>&#47;&#47;ping<br>apt install iputils-ping ","like_count":1},{"had_liked":false,"id":36896,"user_name":"silver","can_delete":false,"product_type":"c1","uid":1186740,"ip_address":"","ucode":"908E3C8560D6E1","user_header":"https://static001.geekbang.org/account/avatar/00/12/1b/b4/a6db1c1e.jpg","comment_is_top":false,"comment_ctime":1541382296,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5836349592","product_id":100015201,"comment_content":"读这篇文章发现NIC bridge这些概念理解有些吃力，有什么好的资料推荐么","like_count":1,"discussions":[{"author":{"id":2663721,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er8sYHCPqtn0TRP72qup5YicYAvTDNP7b8cuykCR0o5Yb6ViaQJFKShJbMsWahVk4sQdwDU2UQf6NiaA/132","nickname":"akai","note":"","ucode":"8D4AA48A86B71C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575525,"discussion_content":"可以理解为二层交换机。参考资料《计算机网络》","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654916604,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360679,"user_name":"瞬间","can_delete":false,"product_type":"c1","uid":1035035,"ip_address":"北京","ucode":"70597EC50C71E5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cb/1b/a9afb6c6.jpg","comment_is_top":false,"comment_ctime":1666752718,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666752718","product_id":100015201,"comment_content":"想问一下，docker0 作为二层交换机为什么会有ip地址？","like_count":0},{"had_liked":false,"id":342773,"user_name":"窝窝头","can_delete":false,"product_type":"c1","uid":1063866,"ip_address":"","ucode":"5C2635ED6484F8","user_header":"https://static001.geekbang.org/account/avatar/00/10/3b/ba/3b30dcde.jpg","comment_is_top":false,"comment_ctime":1650455683,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650455683","product_id":100015201,"comment_content":"需要确认端口占用的情况","like_count":0},{"had_liked":false,"id":339668,"user_name":"fomy","can_delete":false,"product_type":"c1","uid":1125834,"ip_address":"","ucode":"CD87EA03B1F327","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg","comment_is_top":false,"comment_ctime":1648282980,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648282980","product_id":100015201,"comment_content":"干货满满，一篇文章花费几个小时才能消化完。","like_count":0},{"had_liked":false,"id":338917,"user_name":"LLL","can_delete":false,"product_type":"c1","uid":1748234,"ip_address":"","ucode":"0871A8A94B54FE","user_header":"https://static001.geekbang.org/account/avatar/00/1a/ad/0a/6a7d41f1.jpg","comment_is_top":false,"comment_ctime":1647787145,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647787145","product_id":100015201,"comment_content":"老师，容器访问外网情况，容器内虚拟网卡要做一次2层封装，到达宿主机网卡后还要一次2层封装吗","like_count":0},{"had_liked":false,"id":330389,"user_name":"深海极光","can_delete":false,"product_type":"c1","uid":1096111,"ip_address":"","ucode":"331024F7E99C64","user_header":"https://static001.geekbang.org/account/avatar/00/10/b9/af/f59b4c7c.jpg","comment_is_top":false,"comment_ctime":1641962576,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641962576","product_id":100015201,"comment_content":"请问下老师，如果pod被销毁了，对应的docker0网桥上的veth 对会被取消不，也就是对应的Mac地址和ip 也会回收不，因为再访问这个ip 出现的是超时异常","like_count":0},{"had_liked":false,"id":327330,"user_name":"阿甘","can_delete":false,"product_type":"c1","uid":1057843,"ip_address":"","ucode":"BC93175B70E05D","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","comment_is_top":false,"comment_ctime":1640068029,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1640068029","product_id":100015201,"comment_content":"&gt; 与之类似地，当你在一台宿主机上，访问该宿主机上的容器的 IP 地址时，这个请求的数据包，也是先根据路由规则到达 docker0 网桥，然后被转发到对应的 Veth Pair 设备，最后出现在容器里。<br>容器的私有地址没办法直接从外部访问吧？这个路由规则是怎么建立的？","like_count":0},{"had_liked":false,"id":325251,"user_name":"Alex","can_delete":false,"product_type":"c1","uid":1837179,"ip_address":"","ucode":"70806CEA9AB15E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","comment_is_top":false,"comment_ctime":1638879368,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638879368","product_id":100015201,"comment_content":"如果要在生产环境中使用容器的 Host Network 模式，需要提前分配好端口，避免冲突","like_count":0},{"had_liked":false,"id":325034,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638783306,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638783306","product_id":100015201,"comment_content":"容器要想跟外界进行通信，它发出的 IP 包就必须从它的 Network Namespace 里出来，来到宿主机上。而解决这个问题的方法就是：为容器创建一个一端在容器里充当默认网卡、另一端在宿主机上的 Veth Pair 设备。","like_count":0},{"had_liked":false,"id":325032,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638782686,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638782686","product_id":100015201,"comment_content":"熟悉了 docker0 网桥的工作方式，你就可以理解，在默认情况下，被限制在 Network Namespace 里的容器进程，实际上是通过 Veth Pair 设备 + 宿主机网桥的方式，实现了跟同其他容器的数据交换。与之类似地，当你在一台宿主机上，访问该宿主机上的容器的 IP 地址时，这个请求的数据包，也是先根据路由规则到达 docker0 网桥，然后被转发到对应的 Veth Pair 设备，最后出现在容器里。这个过程的示意图，如下所示：","like_count":0},{"had_liked":false,"id":325030,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638782661,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638782661","product_id":100015201,"comment_content":"数据包先到达docker 0网桥，再根据路由规则转到对应的 veth pair 设备， 最后到达容器","like_count":0},{"had_liked":false,"id":325029,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638782607,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638782607","product_id":100015201,"comment_content":"当你遇到容器连不通“外网”的时候，你都应该先试试 docker0 网桥能不能 ping 通，然后查看一下跟 docker0 和 Veth Pair 设备相关的 iptables 规则是不是有异常，往往就能够找到问题的答案了。","like_count":0},{"had_liked":false,"id":317758,"user_name":"陈斯佳","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1634949200,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634949200","product_id":100015201,"comment_content":"第三十二课:浅谈容器网络<br>网络栈包括:网卡（Network Interface）、回环设备（Loopback device）、路由表（Routing Table）、iptables组成。<br><br>Linux中能起到虚拟机交换作用的设备是网桥bridge。它是一个工作在数据链路层（Data Link）的设备，主要功能是根据MAC地址学习来将数据包转发到网桥的不同端口。docker项目默认的网桥是docker0。Veth pair是用来连接不同network namespace的网线。被限制在network namespace里的容器进程实际上是通过veth pair+宿主机网桥（docker0）的方式实现了跟其他容器的数据交换。当你遇到容器连接不通外网的时候，你都应该先试试，docker0网桥能不能ping通，然后查看一下了docker0和veth pair设备相关的iptables规则是不是有异常，往往就能够找到问题的答案。<br><br><br><br><br><br>","like_count":0},{"had_liked":false,"id":316374,"user_name":"丽园","can_delete":false,"product_type":"c1","uid":1316034,"ip_address":"","ucode":"4C4F0527C12894","user_header":"https://static001.geekbang.org/account/avatar/00/14/14/c2/e4b63ae3.jpg","comment_is_top":false,"comment_ctime":1634290475,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634290475","product_id":100015201,"comment_content":"老师好，使用hostNetwork时，默认使用管理网，但是集群中的pod通信需要使用内网，hostNetwork可以配置使用那个网络吗？","like_count":0},{"had_liked":false,"id":314137,"user_name":"唐江","can_delete":false,"product_type":"c1","uid":1878120,"ip_address":"","ucode":"867C9808CF7760","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJpJXWFP3dNle88WnTkRTsEQkPJmOhepibiaTfhEtMRrbdg5EAWm4EzurA61oKxvCK2ZjMmy1QvmChw/132","comment_is_top":false,"comment_ctime":1632875024,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632875024","product_id":100015201,"comment_content":"老师，容器里面的网络栈具体是什么角色在处理呀？比如网络层数据的拆解包，记得容器里面没有内核，数据的7层处理是睡在处理？","like_count":0},{"had_liked":false,"id":308183,"user_name":"一笑淡然","can_delete":false,"product_type":"c1","uid":1165645,"ip_address":"","ucode":"477ACF40DD74B8","user_header":"https://static001.geekbang.org/account/avatar/00/11/c9/4d/89a764b5.jpg","comment_is_top":false,"comment_ctime":1629444331,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629444331","product_id":100015201,"comment_content":"在容器内部通过docker0的ip，能访问宿主机上其他应用程序吗，另外docker0的ip是固定吗","like_count":0},{"had_liked":false,"id":299524,"user_name":"vincentjia","can_delete":false,"product_type":"c1","uid":1005699,"ip_address":"","ucode":"EC26D23594600D","user_header":"","comment_is_top":false,"comment_ctime":1624694532,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624694532","product_id":100015201,"comment_content":"深读一遍，受益匪浅","like_count":0},{"had_liked":false,"id":298501,"user_name":"Geek_5baa01","can_delete":false,"product_type":"c1","uid":2470693,"ip_address":"","ucode":"EE194170C4B30E","user_header":"","comment_is_top":false,"comment_ctime":1624159436,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624159436","product_id":100015201,"comment_content":"Veth Pair 在 MAC 上查看不了....","like_count":0},{"had_liked":false,"id":292024,"user_name":"董永刚","can_delete":false,"product_type":"c1","uid":1169147,"ip_address":"","ucode":"ADA792B226A6CD","user_header":"https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg","comment_is_top":false,"comment_ctime":1620647316,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620647316","product_id":100015201,"comment_content":"可以使用如下dockerfile创建一个nginx镜像，增加ifconfig ，ip link等命令<br>[root@k8s-node1 dockerfile_dir]# cat Dockerfile <br>FROM nginx:1.9.1<br>RUN apt-get update &amp;&amp; apt install net-tools","like_count":0},{"had_liked":false,"id":291482,"user_name":"董永刚","can_delete":false,"product_type":"c1","uid":1169147,"ip_address":"","ucode":"ADA792B226A6CD","user_header":"https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg","comment_is_top":false,"comment_ctime":1620303170,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620303170","product_id":100015201,"comment_content":"你好，老师：<br>请问，veth 设备如何对应起来呢，比如主机的一个veth 对应的哪个容器的eth0呢","like_count":0},{"had_liked":false,"id":284682,"user_name":"Geek_7769cb","can_delete":false,"product_type":"c1","uid":1586120,"ip_address":"","ucode":"4098431A2F27C2","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/qKojC39YlhNJfq3oPsVicNhhTJMmkicqQ54brKPaRrBkvibTadOwA9GYVwD8ywLhpplhWiaicVKUW3I60YAB1ib6OrpA/132","comment_is_top":false,"comment_ctime":1616415118,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1616415118","product_id":100015201,"comment_content":"<br>$ docker run –d –net=host --name nginx-host nginx<br><br>这句应该是 <br>$ docker run –d --net=host --name nginx-host nginx","like_count":0},{"had_liked":false,"id":284270,"user_name":"types","can_delete":false,"product_type":"c1","uid":2449777,"ip_address":"","ucode":"8B50927EF1804F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132","comment_is_top":false,"comment_ctime":1616145108,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616145108","product_id":100015201,"comment_content":"请教一个问题，docker container内部通过bridge的方式访问外网，外网的数据是如何达到容器内部的。<br>目前我在网上搜索的结果是SNAT之后conntrack会保存相应的PNAT信息，从而保证数据可以回流，请问是否准确！！","like_count":0},{"had_liked":false,"id":279058,"user_name":"？","can_delete":false,"product_type":"c1","uid":2030035,"ip_address":"","ucode":"3043E00A056081","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f9/d3/2cb7516e.jpg","comment_is_top":false,"comment_ctime":1613578333,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1613578333","product_id":100015201,"comment_content":"现在k8s推荐使用ipvs，iptable因为是遍历方式去查找网络规则的，而ipvs则是通过哈希算法，当我们集群很大的时候会有大量的iptable规则，会导致性能下降","like_count":0,"discussions":[{"author":{"id":1057843,"avatar":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","nickname":"阿甘","note":"","ucode":"BC93175B70E05D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540488,"discussion_content":"IPVS是LVS的实现吧？主要做负载均衡的，跟iptable还不一样。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640068177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269934,"user_name":"Geek_dcd9db","can_delete":false,"product_type":"c1","uid":2379525,"ip_address":"","ucode":"5B49BDFFC1EC6A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/dyMfbxmVZ1YTGg2bYOSia2icoIr815gJQF72XcibfFaLgqwcsDk48jDMmjITV3bBxXsPvd2v5IdRXvz4u6fSHUDwA/132","comment_is_top":false,"comment_ctime":1608859103,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608859103","product_id":100015201,"comment_content":"老师你好，容器访问宿主机的时候，数据包先到达网桥，那网桥判断不在一个网段，怎么转发到宿主机的呢？","like_count":0},{"had_liked":false,"id":266655,"user_name":"Wind","can_delete":false,"product_type":"c1","uid":1887603,"ip_address":"","ucode":"AD108636DE44C4","user_header":"https://static001.geekbang.org/account/avatar/00/1c/cd/73/f6889c2f.jpg","comment_is_top":false,"comment_ctime":1607427430,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607427430","product_id":100015201,"comment_content":"电力猫 哈哈","like_count":0},{"had_liked":false,"id":250119,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1600941361,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600941361","product_id":100015201,"comment_content":"对于使用host网络连接,需要考虑的第一件事就是端口的冲突可能性<br>如果在一个宿主机上运行多个相同进程,必然会出现端口冲突的问题","like_count":0},{"had_liked":false,"id":245759,"user_name":"大G来了呦","can_delete":false,"product_type":"c1","uid":1610260,"ip_address":"","ucode":"97711D9CCA73B0","user_header":"https://static001.geekbang.org/account/avatar/00/18/92/14/6ca50b3b.jpg","comment_is_top":false,"comment_ctime":1599042157,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599042157","product_id":100015201,"comment_content":"网络基础比较薄弱，对于k8s的网络之前也学习过，但是总是印象不深刻，不过经过老师的讲解，我现在对后面的网络学习信息倍增，通俗易懂把复杂的知识点说明白，才是真的厉害！","like_count":0},{"had_liked":false,"id":242153,"user_name":"冬冬","can_delete":false,"product_type":"c1","uid":1180054,"ip_address":"","ucode":"B673E6482B5C93","user_header":"https://static001.geekbang.org/account/avatar/00/12/01/96/afcb6174.jpg","comment_is_top":false,"comment_ctime":1597625708,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1597625708","product_id":100015201,"comment_content":"docker实例通过VethPair与宿主机建立连接关系，其中Veth的一端在容器内，另一段插在宿主机的docker0网桥上。<br>容器内请求路由是通过宿主机向外转发，在容器内ping otherIp时 需将otherIp转换为mac地址(通arp地址解析获取硬件地址)，容器内无法完成此操作 容器通过默认路由在宿主机解析，获取请求mac地址 然后从容器经过docker0中 VethPair另外一端 通过宿主机将请求转发出去。","like_count":0},{"had_liked":false,"id":241416,"user_name":"刘易之","can_delete":false,"product_type":"c1","uid":1909024,"ip_address":"","ucode":"1CDC3E98B92CE3","user_header":"https://static001.geekbang.org/account/avatar/00/1d/21/20/d7f5bb18.jpg","comment_is_top":false,"comment_ctime":1597288138,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597288138","product_id":100015201,"comment_content":"关于课后题目<br>1.直接是宿主机网络,对于端口的使用 需要进行维护,以免造成端口冲突<br>2.需要做好网络隔离","like_count":0},{"had_liked":false,"id":222406,"user_name":"cliff(亮剑)","can_delete":false,"product_type":"c1","uid":1314866,"ip_address":"","ucode":"A8D1A92331AE20","user_header":"https://static001.geekbang.org/account/avatar/00/14/10/32/e37aacfe.jpg","comment_is_top":false,"comment_ctime":1590796231,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1590796231","product_id":100015201,"comment_content":"RHEL8上没有brctl， 如何查看网桥的端口","like_count":0,"discussions":[{"author":{"id":1363634,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ce/b2/1f914527.jpg","nickname":"海盗船长","note":"","ucode":"ECB28BA21A4113","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290656,"discussion_content":"安装下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594558640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":216839,"user_name":"我是谁","can_delete":false,"product_type":"c1","uid":1131907,"ip_address":"","ucode":"AE3996142811F4","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/83/93d389ba.jpg","comment_is_top":false,"comment_ctime":1589353364,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1589353364","product_id":100015201,"comment_content":"主机1上的容器访问主机2应该做了源地址转换吧，这个在iptables规则里没有看到相关的规则啊，请问有人知道是怎么做的吗？","like_count":0,"discussions":[{"author":{"id":1296833,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIro8BKyich3jKa3z45RWMkXXSgXibbVN6d01KN4cot2ZzoAD5YsicxRV04QRlYfmVE4icLr5xQblrkqA/132","nickname":"麦子","note":"","ucode":"160354D35D7ABB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308960,"discussion_content":"nat 表里面的 masqurade 那条规则","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601132366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":216673,"user_name":"Andy","can_delete":false,"product_type":"c1","uid":1119133,"ip_address":"","ucode":"4BCA899B8E4E85","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/9d/0ff43179.jpg","comment_is_top":false,"comment_ctime":1589326222,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589326222","product_id":100015201,"comment_content":"本节课学到了，同一台服务器容器间网络是互通的，如果想让不同服务器间容器互通，需要一个连接所有服务器的虚拟网络插件。学到了，route 、brctl show","like_count":0},{"had_liked":false,"id":209140,"user_name":"张三","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1587514931,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587514931","product_id":100015201,"comment_content":"学习了，精彩。持久化的部分有点懵，跳过学习容器网络，开头这篇很好懂。","like_count":0},{"had_liked":false,"id":202361,"user_name":"AE","can_delete":false,"product_type":"c1","uid":1007575,"ip_address":"","ucode":"57E32DCEC92245","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5f/d7/4e036beb.jpg","comment_is_top":false,"comment_ctime":1585975469,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585975469","product_id":100015201,"comment_content":"请问这句话怎么理解？  不太理解  剥夺调用网络协议栈处理数据包  降级端口<br>一旦一张虚拟网卡被“插”在网桥上，它就会变成该网桥的“从设备”。从设备会被“剥夺”调用网络协议栈处理数据包的资格，从而“降级”成为网桥上的一个端口。而这个端口唯一的作用，就是接收流入的数据包，然后把这些数据包的“生杀大权”（比如转发或者丢弃），全部交给对应的网桥。","like_count":0},{"had_liked":false,"id":185107,"user_name":"崔","can_delete":false,"product_type":"c1","uid":1120006,"ip_address":"","ucode":"09EF60A03327AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/17/06/e7fd65fc.jpg","comment_is_top":false,"comment_ctime":1583484686,"is_pvip":false,"replies":[{"id":"72833","content":"OSI 哈","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1584423145,"ip_address":"","comment_id":185107,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1583484686","product_id":100015201,"comment_content":"不好意思，这里想请教一下，文中提到的二层网络，以及后面提到的三层网络，指的是OSI模型，还是TCP&#47;IP 模型","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486255,"discussion_content":"OSI 哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584423145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175146,"user_name":"Dale","can_delete":false,"product_type":"c1","uid":1010056,"ip_address":"","ucode":"DD4717C06E417D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg","comment_is_top":false,"comment_ctime":1580570923,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580570923","product_id":100015201,"comment_content":"生产环境使用HostNetwork，因为复用宿主机的网络，所有服务端口提前需要规划好，不能出现冲突。","like_count":0},{"had_liked":false,"id":155150,"user_name":"唐荣轩","can_delete":false,"product_type":"c1","uid":1268732,"ip_address":"","ucode":"D225DC43E94D23","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8a5dg6aBRohA4bQ5KcHdDt6nCnrk0PiarfnVZ3zsgrBbjayAG1bhuAEfyZaNpplnXYDytZlWpfkA/132","comment_is_top":false,"comment_ctime":1574652191,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574652191","product_id":100015201,"comment_content":"改造计算或者服务框架呀，每一类计算框架自己去一段端口区间寻址。中间件的人做paas的时候最喜欢这么做了。需要注意的是检查并占用端口这个逻辑过程得原子化，否则容易出现检查完端口可用但是真正去占用的时候却已经被占用了这样的问题","like_count":0},{"had_liked":false,"id":107482,"user_name":"GaelYang","can_delete":false,"product_type":"c1","uid":1463730,"ip_address":"","ucode":"B8E0B2402A7DCC","user_header":"https://static001.geekbang.org/account/avatar/00/16/55/b2/d70deacf.jpg","comment_is_top":false,"comment_ctime":1561543509,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561543509","product_id":100015201,"comment_content":"docker0 网桥会带来性能的下降吗？","like_count":0},{"had_liked":false,"id":94172,"user_name":"淡定","can_delete":false,"product_type":"c1","uid":1283773,"ip_address":"","ucode":"3BDB305F29FAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/96/bd/27ce72ab.jpg","comment_is_top":false,"comment_ctime":1557737348,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557737348","product_id":100015201,"comment_content":"老师，iptables &#47;netfilter 那个连接貌似翻墙才能用，你这边有iptables的讲解吗？","like_count":0},{"had_liked":false,"id":58489,"user_name":"汤尼房","can_delete":false,"product_type":"c1","uid":1100996,"ip_address":"","ucode":"A4D961DD9C2F74","user_header":"https://static001.geekbang.org/account/avatar/00/10/cc/c4/5ac16f31.jpg","comment_is_top":false,"comment_ctime":1547089940,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547089940","product_id":100015201,"comment_content":"老师您好，我在容器A中ping容器B的ip的实践中，通过对docker0网桥、容器A在宿主机的虚拟网卡以及容器B在宿主机的虚拟网卡使用tcpdump的抓包发现，arp报告的是容器B内的eth0的mac地址，在宿主机上arp命令查看容器B的ip确实对应的是容器B中的虚拟网卡eth0的mac地址，而不是容器B在宿主机上插在docker0上的虚拟网卡的mac地址，那老师在文章中通过查看cam知道容器在宿主机上的虚拟网卡的信息，这一块是如何实现的呢？这一步有点疑惑，或者说知道了容器内的虚拟网卡默认就知道其在宿主机上对应的虚拟网卡？望老师帮忙解惑。","like_count":0},{"had_liked":false,"id":50779,"user_name":"玉剑冰锋","can_delete":false,"product_type":"c1","uid":1214202,"ip_address":"","ucode":"8EA56A71BA5B22","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg","comment_is_top":false,"comment_ctime":1545044183,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545044183","product_id":100015201,"comment_content":"请教一下，多个运行容器，如何对应容器与宿主机对应的虚拟网卡？","like_count":0},{"had_liked":false,"id":47873,"user_name":"林辉","can_delete":false,"product_type":"c1","uid":1103911,"ip_address":"","ucode":"A51EBC35DA54AD","user_header":"https://static001.geekbang.org/account/avatar/00/10/d8/27/5d7bf561.jpg","comment_is_top":false,"comment_ctime":1544242125,"is_pvip":false,"replies":[{"id":"17505","content":"是么……编辑看一下？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1544533474,"ip_address":"","comment_id":47873,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544242125","product_id":100015201,"comment_content":"老师，你的第一条命令-d的-样式不对。。。","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431922,"discussion_content":"是么……编辑看一下？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544533474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":43111,"user_name":"jssfy","can_delete":false,"product_type":"c1","uid":1137238,"ip_address":"","ucode":"F16353CFE607B7","user_header":"https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg","comment_is_top":false,"comment_ctime":1543167502,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543167502","product_id":100015201,"comment_content":"赞一个！<br>请问172.17.0.1这个ip和docker0网桥是什么关系呢？是否可以理解为连接宿主机的veth一端","like_count":0},{"had_liked":false,"id":37177,"user_name":"swordholder","can_delete":false,"product_type":"c1","uid":1002569,"ip_address":"","ucode":"3D1361126AD3CB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/49/d21c134f.jpg","comment_is_top":false,"comment_ctime":1541474654,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1541474654","product_id":100015201,"comment_content":"docker的跨主机网络有两种方式：overlay封包和路由<br>现在公有云都提供了kubernetes服务，那么在阿里云或腾讯云上创建的集群，采用的是哪种方式？","like_count":0},{"had_liked":false,"id":37045,"user_name":"loda","can_delete":false,"product_type":"c1","uid":1043287,"ip_address":"","ucode":"3F9575DBFA1031","user_header":"https://static001.geekbang.org/account/avatar/00/0f/eb/57/3032e1a7.jpg","comment_is_top":false,"comment_ctime":1541431502,"is_pvip":false,"replies":[{"id":"13382","content":"是的，已修正","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541508125,"ip_address":"","comment_id":37045,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1541431502","product_id":100015201,"comment_content":"在宿主机上ifconfig看到的虚拟网卡应该是veth9c02e56，而不是vethb4963f3，12行代码应该有点问题","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428139,"discussion_content":"是的，已修正","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541508125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36994,"user_name":"gogo","can_delete":false,"product_type":"c1","uid":1003104,"ip_address":"","ucode":"E8F0F3B000020A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4e/60/0d5aa340.jpg","comment_is_top":false,"comment_ctime":1541415045,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1541415045","product_id":100015201,"comment_content":"老师您好，集群中一个节点的kubelet一直报错，&#47;sys&#47;fs&#47;cgroup&#47;devices&#47;kubupods&#47;pod... no space left on device,重启了docker和kubelet无效，请问这可能是什么原因呢","like_count":0}]}