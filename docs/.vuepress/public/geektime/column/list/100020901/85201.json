{"id":85201,"title":"47 | æ¡ˆä¾‹ç¯‡ï¼šæœåŠ¡å™¨æ€»æ˜¯æ—¶ä¸æ—¶ä¸¢åŒ…ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿï¼ˆä¸Šï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¢³ç†äº†ï¼Œåº”ç”¨ç¨‹åºå®¹å™¨åŒ–åæ€§èƒ½ä¸‹é™çš„åˆ†ææ–¹æ³•ã€‚ä¸€èµ·å…ˆç®€å•å›é¡¾ä¸‹ã€‚</p><p>å®¹å™¨åˆ©ç”¨ Linux å†…æ ¸æä¾›çš„å‘½åç©ºé—´æŠ€æœ¯ï¼Œå°†ä¸åŒåº”ç”¨ç¨‹åºçš„è¿è¡Œéš”ç¦»èµ·æ¥ï¼Œå¹¶ç”¨ç»Ÿä¸€çš„é•œåƒï¼Œæ¥ç®¡ç†åº”ç”¨ç¨‹åºçš„ä¾èµ–ç¯å¢ƒã€‚è¿™ä¸ºåº”ç”¨ç¨‹åºçš„ç®¡ç†å’Œç»´æŠ¤ï¼Œå¸¦æ¥äº†æå¤§çš„ä¾¿æ·æ€§ï¼Œå¹¶è¿›ä¸€æ­¥å‚¬ç”Ÿäº†å¾®æœåŠ¡ã€äº‘åŸç”Ÿç­‰æ–°ä¸€ä»£æŠ€æœ¯æ¶æ„ã€‚</p><p>ä¸è¿‡ï¼Œè™½è¯´æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œä½†å®¹å™¨åŒ–ä¹Ÿä¼šå¯¹åº”ç”¨ç¨‹åºçš„æ€§èƒ½å¸¦æ¥ä¸€å®šå½±å“ã€‚æ¯”å¦‚ï¼Œä¸Šä¸€èŠ‚æˆ‘ä»¬ä¸€èµ·åˆ†æçš„ Java åº”ç”¨ï¼Œå°±å®¹æ˜“å‘ç”Ÿå¯åŠ¨è¿‡æ…¢ã€è¿è¡Œä¸€æ®µæ—¶é—´å OOM é€€å‡ºç­‰é—®é¢˜ã€‚å½“ä½ ç¢°åˆ°è¿™ç§é—®é¢˜æ—¶ï¼Œä¸è¦æ…Œï¼Œæˆ‘ä»¬å‰é¢å››å¤§åŸºç¡€æ¨¡å—ä¸­çš„å„ç§æ€è·¯ï¼Œéƒ½ä¾ç„¶é€‚ç”¨ã€‚</p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸“æ ä¸­çš„å¾ˆå¤šæ¡ˆä¾‹éƒ½åœ¨å®¹å™¨ä¸­è¿è¡Œã€‚å®¹å™¨åŒ–åï¼Œåº”ç”¨ç¨‹åºä¼šé€šè¿‡å‘½åç©ºé—´è¿›è¡Œéš”ç¦»ã€‚æ‰€ä»¥ï¼Œä½ åœ¨åˆ†ææ—¶ï¼Œä¸è¦å¿˜äº†ç»“åˆå‘½åç©ºé—´ã€cgroupsã€iptables ç­‰æ¥ç»¼åˆåˆ†æã€‚æ¯”å¦‚ï¼š</p><ul>\n<li>\n<p>cgroups ä¼šå½±å“å®¹å™¨åº”ç”¨çš„è¿è¡Œï¼›</p>\n</li>\n<li>\n<p>iptables ä¸­çš„ NATï¼Œä¼šå½±å“å®¹å™¨çš„ç½‘ç»œæ€§èƒ½ï¼›</p>\n</li>\n<li>\n<p>å åŠ æ–‡ä»¶ç³»ç»Ÿï¼Œä¼šå½±å“åº”ç”¨çš„ I/O æ€§èƒ½ç­‰ã€‚</p>\n</li>\n</ul><p>å…³äº NAT çš„å½±å“ï¼Œæˆ‘åœ¨ç½‘ç»œæ¨¡å—çš„ <a href=\"https://time.geekbang.org/column/article/83189\">å¦‚ä½•ä¼˜åŒ–NATæ€§èƒ½</a>  æ–‡ç« ä¸­ï¼Œå·²ç»ä¸ºä½ ä»‹ç»äº†å¾ˆå¤šä¼˜åŒ–æ€è·¯ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹å¦ä¸€ç§æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ä¸¢åŒ…çš„åˆ†ææ–¹æ³•ã€‚</p><p>æ‰€è°“ä¸¢åŒ…ï¼Œæ˜¯æŒ‡åœ¨ç½‘ç»œæ•°æ®çš„æ”¶å‘è¿‡ç¨‹ä¸­ï¼Œç”±äºç§ç§åŸå› ï¼Œæ•°æ®åŒ…è¿˜æ²¡ä¼ è¾“åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œå°±è¢«ä¸¢å¼ƒäº†ã€‚è¿™äº›è¢«ä¸¢å¼ƒåŒ…çš„æ•°é‡ï¼Œé™¤ä»¥æ€»çš„ä¼ è¾“åŒ…æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<strong>ä¸¢åŒ…ç‡</strong>ã€‚ä¸¢åŒ…ç‡æ˜¯ç½‘ç»œæ€§èƒ½ä¸­æœ€æ ¸å¿ƒçš„æŒ‡æ ‡ä¹‹ä¸€ã€‚</p><!-- [[[read_end]]] --><p>ä¸¢åŒ…é€šå¸¸ä¼šå¸¦æ¥ä¸¥é‡çš„æ€§èƒ½ä¸‹é™ï¼Œç‰¹åˆ«æ˜¯å¯¹ TCP æ¥è¯´ï¼Œä¸¢åŒ…é€šå¸¸æ„å‘³ç€ç½‘ç»œæ‹¥å¡å’Œé‡ä¼ ï¼Œè¿›è€Œè¿˜ä¼šå¯¼è‡´ç½‘ç»œå»¶è¿Ÿå¢å¤§ã€ååé™ä½ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±ä»¥æœ€å¸¸ç”¨çš„åå‘ä»£ç†æœåŠ¡å™¨ Nginx ä¸ºä¾‹ï¼Œå¸¦ä½ ä¸€èµ·çœ‹çœ‹ï¼Œå¦‚ä½•åˆ†æç½‘ç»œä¸¢åŒ…çš„é—®é¢˜ã€‚ç”±äºå†…å®¹æ¯”è¾ƒå¤šï¼Œè¿™ä¸ªæ¡ˆä¾‹å°†åˆ†ä¸ºä¸Šä¸‹ä¸¤ç¯‡æ¥è®²è§£ï¼Œä»Šå¤©æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ†å†…å®¹ã€‚</p><h2>æ¡ˆä¾‹å‡†å¤‡</h2><p>ä»Šå¤©çš„æ¡ˆä¾‹éœ€è¦ç”¨åˆ°ä¸¤å°è™šæ‹Ÿæœºï¼Œè¿˜æ˜¯åŸºäº Ubuntu 18.04ï¼ŒåŒæ ·é€‚ç”¨äºå…¶ä»–çš„ Linux ç³»ç»Ÿã€‚æˆ‘ä½¿ç”¨çš„æ¡ˆä¾‹ç¯å¢ƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul>\n<li>\n<p>æœºå™¨é…ç½®ï¼š2 CPUï¼Œ8GB å†…å­˜ã€‚</p>\n</li>\n<li>\n<p>é¢„å…ˆå®‰è£… dockerã€curlã€hping3 ç­‰å·¥å…·ï¼Œå¦‚ apt install docker.io curl hping3ã€‚</p>\n</li>\n</ul><p>è¿™äº›å·¥å…·ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­å·²ç»å¤šæ¬¡ä½¿ç”¨ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤ä»‹ç»ã€‚</p><p>ç°åœ¨ï¼Œæ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ«ç™»å½•åˆ°è¿™ä¸¤å°è™šæ‹Ÿæœºä¸­ï¼Œå¹¶å®‰è£…ä¸Šè¿°å·¥å…·ã€‚</p><p>æ³¨æ„ï¼Œä»¥ä¸‹æ‰€æœ‰å‘½ä»¤éƒ½é»˜è®¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œå¦‚æœä½ ç”¨æ™®é€šç”¨æˆ·èº«ä»½ç™»é™†ç³»ç»Ÿï¼Œè¯·è¿è¡Œ sudo su root å‘½ä»¤ï¼Œåˆ‡æ¢åˆ° root ç”¨æˆ·ã€‚</p><blockquote>\n<p>å¦‚æœå®‰è£…è¿‡ç¨‹æœ‰é—®é¢˜ï¼Œä½ å¯ä»¥å…ˆä¸Šç½‘æœç´¢è§£å†³ï¼Œå®åœ¨è§£å†³ä¸äº†çš„ï¼Œè®°å¾—åœ¨ç•™è¨€åŒºå‘æˆ‘æé—®ã€‚</p>\n</blockquote><p>åˆ°è¿™é‡Œï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­£å¼è¿›å…¥æ“ä½œç¯èŠ‚ã€‚</p><h2>æ¡ˆä¾‹åˆ†æ</h2><p>æˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„æ¡ˆä¾‹æ˜¯ä¸€ä¸ª Nginx åº”ç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œhping3 å’Œ curl æ˜¯ Nginx çš„å®¢æˆ·ç«¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7d/1b/7d8cb9a2ce1c3bad4d74f46a632f671b.png?wh=1632*1032\" alt=\"\"></p><p>ä¸ºäº†æ–¹ä¾¿ä½ è¿è¡Œï¼Œæˆ‘å·²ç»æŠŠå®ƒæ‰“åŒ…æˆäº†ä¸€ä¸ª Docker é•œåƒï¼Œå¹¶æ¨é€åˆ° Docker Hub ä¸­ã€‚ä½ å¯ä»¥ç›´æ¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ¥è¿è¡Œå®ƒã€‚</p><p>åœ¨ç»ˆç«¯ä¸€ä¸­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨ Nginx åº”ç”¨ï¼Œå¹¶åœ¨80ç«¯å£ç›‘å¬ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code>$ docker run --name nginx --hostname nginx --privileged -p 80:80 -itd feisky/nginx:drop\ndae0202cc27e5082b282a6aeeb1398fcec423c642e63322da2a97b9ebd7538e0\n</code></pre><p>ç„¶åï¼Œæ‰§è¡Œ docker ps å‘½ä»¤ï¼ŒæŸ¥è¯¢å®¹å™¨çš„çŠ¶æ€ï¼Œä½ ä¼šå‘ç°å®¹å™¨å·²ç»å¤„äºè¿è¡ŒçŠ¶æ€ï¼ˆUpï¼‰äº†ï¼š</p><pre><code>$ docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                NAMES\ndae0202cc27e        feisky/nginx:drop   &quot;/start.sh&quot;         4 minutes ago       Up 4 minutes        0.0.0.0:80-&gt;80/tcp   nginx\n</code></pre><p>ä¸è¿‡ï¼Œä» docker ps çš„è¾“å‡ºï¼Œæˆ‘ä»¬åªèƒ½çŸ¥é“å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œè‡³äº Nginx æ˜¯å¦å¯ä»¥æ­£å¸¸å¤„ç†å¤–éƒ¨è¯·æ±‚ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥çš„ç¡®è®¤ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„ hping3 å‘½ä»¤ï¼Œè¿›ä¸€æ­¥éªŒè¯ Nginx æ˜¯ä¸æ˜¯çœŸçš„å¯ä»¥æ­£å¸¸è®¿é—®äº†ã€‚æ³¨æ„ï¼Œè¿™é‡Œæˆ‘æ²¡æœ‰ä½¿ç”¨ pingï¼Œæ˜¯å› ä¸º ping åŸºäº ICMP åè®®ï¼Œè€Œ Nginx ä½¿ç”¨çš„æ˜¯ TCP åè®®ã€‚</p><pre><code># -cè¡¨ç¤ºå‘é€10ä¸ªè¯·æ±‚ï¼Œ-Sè¡¨ç¤ºä½¿ç”¨TCP SYNï¼Œ-pæŒ‡å®šç«¯å£ä¸º80\n$ hping3 -c 10 -S -p 80 192.168.0.30\nHPING 192.168.0.30 (eth0 192.168.0.30): S set, 40 headers + 0 data bytes\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=3 win=5120 rtt=7.5 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=4 win=5120 rtt=7.4 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=5 win=5120 rtt=3.3 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=7 win=5120 rtt=3.0 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=6 win=5120 rtt=3027.2 ms\n\n--- 192.168.0.30 hping statistic ---\n10 packets transmitted, 5 packets received, 50% packet loss\nround-trip min/avg/max = 3.0/609.7/3027.2 ms\n</code></pre><p>ä» hping3 çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå‘é€äº† 10 ä¸ªè¯·æ±‚åŒ…ï¼Œå´åªæ”¶åˆ°äº† 5 ä¸ªå›å¤ï¼Œ50% çš„åŒ…éƒ½ä¸¢äº†ã€‚å†è§‚å¯Ÿæ¯ä¸ªè¯·æ±‚çš„ RTT å¯ä»¥å‘ç°ï¼ŒRTT ä¹Ÿæœ‰éå¸¸å¤§çš„æ³¢åŠ¨å˜åŒ–ï¼Œå°çš„æ—¶å€™åªæœ‰ 3msï¼Œè€Œå¤§çš„æ—¶å€™åˆ™æœ‰ 3sã€‚</p><p>æ ¹æ®è¿™äº›è¾“å‡ºï¼Œæˆ‘ä»¬åŸºæœ¬èƒ½åˆ¤æ–­ï¼Œå·²ç»å‘ç”Ÿäº†ä¸¢åŒ…ç°è±¡ã€‚å¯ä»¥çŒœæµ‹ï¼Œ3s çš„ RTT ï¼Œå¾ˆå¯èƒ½æ˜¯å› ä¸ºä¸¢åŒ…åé‡ä¼ å¯¼è‡´çš„ã€‚é‚£åˆ°åº•æ˜¯å“ªé‡Œå‘ç”Ÿäº†ä¸¢åŒ…å‘¢ï¼Ÿ</p><p>æ’æŸ¥ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å›å¿†ä¸€ä¸‹ Linux çš„ç½‘ç»œæ”¶å‘æµç¨‹ï¼Œå…ˆä»ç†è®ºä¸Šåˆ†æï¼Œå“ªé‡Œæœ‰å¯èƒ½ä¼šå‘ç”Ÿä¸¢åŒ…ã€‚ä½ ä¸å¦¨æ‹¿å‡ºæ‰‹è¾¹çš„ç¬”å’Œçº¸ï¼Œè¾¹å›å¿†è¾¹åœ¨çº¸ä¸Šæ¢³ç†ï¼Œæ€è€ƒæ¸…æ¥šå†ç»§ç»­ä¸‹é¢çš„å†…å®¹ã€‚</p><p>åœ¨è¿™é‡Œï¼Œä¸ºäº†å¸®ä½ ç†è§£ç½‘ç»œä¸¢åŒ…çš„åŸç†ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œä½ å¯ä»¥ä¿å­˜å¹¶æ‰“å°å‡ºæ¥ä½¿ç”¨ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/dd/fd/dd5b4050d555b1c23362456e357dfffd.png?wh=4544*2680\" alt=\"\"></p><p>ä»å›¾ä¸­ä½ å¯ä»¥çœ‹å‡ºï¼Œå¯èƒ½å‘ç”Ÿä¸¢åŒ…çš„ä½ç½®ï¼Œå®é™…ä¸Šè´¯ç©¿äº†æ•´ä¸ªç½‘ç»œåè®®æ ˆã€‚æ¢å¥è¯è¯´ï¼Œå…¨ç¨‹éƒ½æœ‰ä¸¢åŒ…çš„å¯èƒ½ã€‚æ¯”å¦‚æˆ‘ä»¬ä»ä¸‹å¾€ä¸Šçœ‹ï¼š</p><ul>\n<li>\n<p>åœ¨ä¸¤å° VM è¿æ¥ä¹‹é—´ï¼Œå¯èƒ½ä¼šå‘ç”Ÿä¼ è¾“å¤±è´¥çš„é”™è¯¯ï¼Œæ¯”å¦‚ç½‘ç»œæ‹¥å¡ã€çº¿è·¯é”™è¯¯ç­‰ï¼›</p>\n</li>\n<li>\n<p>åœ¨ç½‘å¡æ”¶åŒ…åï¼Œç¯å½¢ç¼“å†²åŒºå¯èƒ½ä¼šå› ä¸ºæº¢å‡ºè€Œä¸¢åŒ…ï¼›</p>\n</li>\n<li>\n<p>åœ¨é“¾è·¯å±‚ï¼Œå¯èƒ½ä¼šå› ä¸ºç½‘ç»œå¸§æ ¡éªŒå¤±è´¥ã€QoS ç­‰è€Œä¸¢åŒ…ï¼›</p>\n</li>\n<li>\n<p>åœ¨ IP å±‚ï¼Œå¯èƒ½ä¼šå› ä¸ºè·¯ç”±å¤±è´¥ã€ç»„åŒ…å¤§å°è¶…è¿‡ MTU ç­‰è€Œä¸¢åŒ…ï¼›</p>\n</li>\n<li>\n<p>åœ¨ä¼ è¾“å±‚ï¼Œå¯èƒ½ä¼šå› ä¸ºç«¯å£æœªç›‘å¬ã€èµ„æºå ç”¨è¶…è¿‡å†…æ ¸é™åˆ¶ç­‰è€Œä¸¢åŒ…ï¼›</p>\n</li>\n<li>\n<p>åœ¨å¥—æ¥å­—å±‚ï¼Œå¯èƒ½ä¼šå› ä¸ºå¥—æ¥å­—ç¼“å†²åŒºæº¢å‡ºè€Œä¸¢åŒ…ï¼›</p>\n</li>\n<li>\n<p>åœ¨åº”ç”¨å±‚ï¼Œå¯èƒ½ä¼šå› ä¸ºåº”ç”¨ç¨‹åºå¼‚å¸¸è€Œä¸¢åŒ…ï¼›</p>\n</li>\n<li>\n<p>æ­¤å¤–ï¼Œå¦‚æœé…ç½®äº† iptables è§„åˆ™ï¼Œè¿™äº›ç½‘ç»œåŒ…ä¹Ÿå¯èƒ½å› ä¸º iptables è¿‡æ»¤è§„åˆ™è€Œä¸¢åŒ…ã€‚</p>\n</li>\n</ul><p>å½“ç„¶ï¼Œä¸Šé¢è¿™äº›é—®é¢˜ï¼Œè¿˜æœ‰å¯èƒ½åŒæ—¶å‘ç”Ÿåœ¨é€šä¿¡çš„ä¸¤å°æœºå™¨ä¸­ã€‚ä¸è¿‡ï¼Œç”±äºæˆ‘ä»¬æ²¡å¯¹ VM2 åšä»»ä½•ä¿®æ”¹ï¼Œå¹¶ä¸” VM2 ä¹Ÿåªè¿è¡Œäº†ä¸€ä¸ªæœ€ç®€å•çš„ hping3 å‘½ä»¤ï¼Œè¿™å„¿ä¸å¦¨å‡è®¾å®ƒæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><p>ä¸ºäº†ç®€åŒ–æ•´ä¸ªæ’æŸ¥è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥å‡è®¾ï¼Œ VM1 çš„ç½‘ç»œå’Œå†…æ ¸é…ç½®ä¹Ÿæ²¡é—®é¢˜ã€‚è¿™æ ·ä¸€æ¥ï¼Œæœ‰å¯èƒ½å‘ç”Ÿé—®é¢˜çš„ä½ç½®ï¼Œå°±éƒ½åœ¨å®¹å™¨å†…éƒ¨äº†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬åˆ‡æ¢å›ç»ˆç«¯ä¸€ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œè¿›å…¥å®¹å™¨çš„ç»ˆç«¯ä¸­ï¼š</p><pre><code>$ docker exec -it nginx bash\nroot@nginx:/#\n</code></pre><p>åœ¨è¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥çš„æ‰€æœ‰åˆ†æï¼Œå‰é¢å¸¦æœ‰ <em>root@nginx:/#</em> çš„æ“ä½œï¼Œéƒ½è¡¨ç¤ºåœ¨å®¹å™¨ä¸­è¿›è¡Œã€‚</p><blockquote>\n<p>æ³¨æ„ï¼šå®é™…ç¯å¢ƒä¸­ï¼Œå®¹å™¨å†…éƒ¨å’Œå¤–éƒ¨éƒ½æœ‰å¯èƒ½å‘ç”Ÿé—®é¢˜ã€‚ä¸è¿‡ä¸è¦æ‹…å¿ƒï¼Œå®¹å™¨å†…ã€å¤–éƒ¨çš„åˆ†ææ­¥éª¤å’Œæ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡è¦èŠ±æ›´å¤šçš„æ—¶é—´è€Œå·²ã€‚</p>\n</blockquote><p>é‚£ä¹ˆï¼Œ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»åè®®æ ˆä¸­ï¼Œé€å±‚æ’æŸ¥ä¸¢åŒ…é—®é¢˜ã€‚</p><h3>é“¾è·¯å±‚</h3><p>é¦–å…ˆï¼Œæ¥çœ‹æœ€åº•ä¸‹çš„é“¾è·¯å±‚ã€‚å½“ç¼“å†²åŒºæº¢å‡ºç­‰åŸå› å¯¼è‡´ç½‘å¡ä¸¢åŒ…æ—¶ï¼ŒLinux ä¼šåœ¨ç½‘å¡æ”¶å‘æ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯ä¸­ï¼Œè®°å½•ä¸‹æ”¶å‘é”™è¯¯çš„æ¬¡æ•°ã€‚</p><p>ä½ å¯ä»¥é€šè¿‡ ethtool æˆ–è€… netstat ï¼Œæ¥æŸ¥çœ‹ç½‘å¡çš„ä¸¢åŒ…è®°å½•ã€‚æ¯”å¦‚ï¼Œå¯ä»¥åœ¨å®¹å™¨ä¸­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥çœ‹ä¸¢åŒ…æƒ…å†µï¼š</p><pre><code>root@nginx:/# netstat -i\nKernel Interface table\nIface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg\neth0       100       31      0      0 0             8      0      0      0 BMRU\nlo       65536        0      0      0 0             0      0      0      0 LRU\n</code></pre><p>è¾“å‡ºä¸­çš„ RX-OKã€RX-ERRã€RX-DRPã€RX-OVR ï¼Œåˆ†åˆ«è¡¨ç¤ºæ¥æ”¶æ—¶çš„æ€»åŒ…æ•°ã€æ€»é”™è¯¯æ•°ã€è¿›å…¥Ring Buffer åå› å…¶ä»–åŸå› ï¼ˆå¦‚å†…å­˜ä¸è¶³ï¼‰å¯¼è‡´çš„ä¸¢åŒ…æ•°ä»¥åŠ Ring Buffer æº¢å‡ºå¯¼è‡´çš„ä¸¢åŒ…æ•°ã€‚</p><p>TX-OKã€TX-ERRã€TX-DRPã€TX-OVR ä¹Ÿä»£è¡¨ç±»ä¼¼çš„å«ä¹‰ï¼Œåªä¸è¿‡æ˜¯æŒ‡å‘é€æ—¶å¯¹åº”çš„å„ä¸ªæŒ‡æ ‡ã€‚</p><blockquote>\n<p>æ³¨æ„ï¼Œç”±äº Docker å®¹å™¨çš„è™šæ‹Ÿç½‘å¡ï¼Œå®é™…ä¸Šæ˜¯ä¸€å¯¹ veth pairï¼Œä¸€ç«¯æ¥å…¥å®¹å™¨ä¸­ç”¨ä½œ eth0ï¼Œå¦ä¸€ç«¯åœ¨ä¸»æœºä¸­æ¥å…¥ docker0 ç½‘æ¡¥ä¸­ã€‚veth é©±åŠ¨å¹¶æ²¡æœ‰å®ç°ç½‘ç»œç»Ÿè®¡çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ä½¿ç”¨ ethtool -S å‘½ä»¤ï¼Œæ— æ³•å¾—åˆ°ç½‘å¡æ”¶å‘æ•°æ®çš„æ±‡æ€»ä¿¡æ¯ã€‚</p>\n</blockquote><p>ä»è¿™ä¸ªè¾“å‡ºä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰å‘ç°ä»»ä½•é”™è¯¯ï¼Œè¯´æ˜å®¹å™¨çš„è™šæ‹Ÿç½‘å¡æ²¡æœ‰ä¸¢åŒ…ã€‚ä¸è¿‡è¦æ³¨æ„ï¼Œå¦‚æœç”¨ tc ç­‰å·¥å…·é…ç½®äº† QoSï¼Œé‚£ä¹ˆ tc è§„åˆ™å¯¼è‡´çš„ä¸¢åŒ…ï¼Œå°±ä¸ä¼šåŒ…å«åœ¨ç½‘å¡çš„ç»Ÿè®¡ä¿¡æ¯ä¸­ã€‚</p><p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜è¦æ£€æŸ¥ä¸€ä¸‹ eth0 ä¸Šæ˜¯å¦é…ç½®äº† tc è§„åˆ™ï¼Œå¹¶æŸ¥çœ‹æœ‰æ²¡æœ‰ä¸¢åŒ…ã€‚æˆ‘ä»¬ç»§ç»­å®¹å™¨ç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„ tc å‘½ä»¤ï¼Œä¸è¿‡è¿™æ¬¡æ³¨æ„æ·»åŠ  -s é€‰é¡¹ï¼Œä»¥è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼š</p><pre><code>root@nginx:/# tc -s qdisc show dev eth0\nqdisc netem 800d: root refcnt 2 limit 1000 loss 30%\n Sent 432 bytes 8 pkt (dropped 4, overlimits 0 requeues 0)\n backlog 0b 0p requeues 0\n</code></pre><p>ä» tc çš„è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°ï¼Œ eth0 ä¸Šé¢é…ç½®äº†ä¸€ä¸ªç½‘ç»œæ¨¡æ‹Ÿæ’é˜Ÿè§„åˆ™ï¼ˆqdisc netemï¼‰ï¼Œå¹¶ä¸”é…ç½®äº†ä¸¢åŒ…ç‡ä¸º 30%ï¼ˆloss 30%ï¼‰ã€‚å†çœ‹åé¢çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå‘é€äº† 8 ä¸ªåŒ…ï¼Œä½†æ˜¯ä¸¢äº† 4 ä¸ªã€‚</p><p>çœ‹æ¥ï¼Œåº”è¯¥å°±æ˜¯è¿™é‡Œï¼Œå¯¼è‡´ Nginx å›å¤çš„å“åº”åŒ…ï¼Œè¢« netem æ¨¡å—ç»™ä¸¢äº†ã€‚</p><p>æ—¢ç„¶å‘ç°äº†é—®é¢˜ï¼Œè§£å†³æ–¹æ³•ä¹Ÿå°±å¾ˆç®€å•äº†ï¼Œç›´æ¥åˆ æ‰ netem æ¨¡å—å°±å¯ä»¥äº†ã€‚æˆ‘ä»¬å¯ä»¥ç»§ç»­åœ¨å®¹å™¨ç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ é™¤ tc ä¸­çš„ netem æ¨¡å—ï¼š</p><pre><code>root@nginx:/# tc qdisc del dev eth0 root netem loss 30%\n</code></pre><p>åˆ é™¤åï¼Œé—®é¢˜åˆ°åº•è§£å†³äº†æ²¡ï¼Ÿæˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­ï¼Œé‡æ–°æ‰§è¡Œåˆšæ‰çš„ hping3 å‘½ä»¤ï¼Œçœ‹çœ‹ç°åœ¨è¿˜æœ‰æ²¡æœ‰é—®é¢˜ï¼š</p><pre><code>$ hping3 -c 10 -S -p 80 192.168.0.30\nHPING 192.168.0.30 (eth0 192.168.0.30): S set, 40 headers + 0 data bytes\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=0 win=5120 rtt=7.9 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=2 win=5120 rtt=1003.8 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=5 win=5120 rtt=7.6 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=6 win=5120 rtt=7.4 ms\nlen=44 ip=192.168.0.30 ttl=63 DF id=0 sport=80 flags=SA seq=9 win=5120 rtt=3.0 ms\n\n--- 192.168.0.30 hping statistic ---\n10 packets transmitted, 5 packets received, 50% packet loss\nround-trip min/avg/max = 3.0/205.9/1003.8 ms\n</code></pre><p>ä¸å¹¸çš„æ˜¯ï¼Œä» hping3 çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè·Ÿå‰é¢ç°è±¡ä¸€æ ·ï¼Œè¿˜æ˜¯ 50% çš„ä¸¢åŒ…ï¼›RTT çš„æ³¢åŠ¨ä¹Ÿä»æ—§å¾ˆå¤§ï¼Œä» 3ms åˆ° 1sã€‚</p><p>æ˜¾ç„¶ï¼Œé—®é¢˜è¿˜æ˜¯æ²¡è§£å†³ï¼Œä¸¢åŒ…è¿˜åœ¨ç»§ç»­å‘ç”Ÿã€‚ä¸è¿‡ï¼Œæ—¢ç„¶é“¾è·¯å±‚å·²ç»æ’æŸ¥å®Œäº†ï¼Œæˆ‘ä»¬å°±ç»§ç»­å‘ä¸Šå±‚åˆ†æï¼Œçœ‹çœ‹ç½‘ç»œå±‚å’Œä¼ è¾“å±‚æœ‰æ²¡æœ‰é—®é¢˜ã€‚</p><h3>ç½‘ç»œå±‚å’Œä¼ è¾“å±‚</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç½‘ç»œå±‚å’Œä¼ è¾“å±‚ä¸­ï¼Œå¼•å‘ä¸¢åŒ…çš„å› ç´ éå¸¸å¤šã€‚ä¸è¿‡ï¼Œå…¶å®æƒ³ç¡®è®¤æ˜¯å¦ä¸¢åŒ…ï¼Œæ˜¯éå¸¸ç®€å•çš„äº‹ï¼Œå› ä¸º Linux å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†å„ä¸ªåè®®çš„æ”¶å‘æ±‡æ€»æƒ…å†µã€‚</p><p>æˆ‘ä»¬ç»§ç»­åœ¨å®¹å™¨ç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„ netstat -s å‘½ä»¤ï¼Œå°±å¯ä»¥çœ‹åˆ°åè®®çš„æ”¶å‘æ±‡æ€»ï¼Œä»¥åŠé”™è¯¯ä¿¡æ¯äº†ï¼š</p><pre><code>root@nginx:/# netstat -s\nIp:\n    Forwarding: 1\t\t\t\t\t//å¼€å¯è½¬å‘\n    31 total packets received\t\t//æ€»æ”¶åŒ…æ•°\n    0 forwarded\t\t\t\t\t\t//è½¬å‘åŒ…æ•°\n    0 incoming packets discarded\t//æ¥æ”¶ä¸¢åŒ…æ•°\n    25 incoming packets delivered\t//æ¥æ”¶çš„æ•°æ®åŒ…æ•°\n    15 requests sent out\t\t\t//å‘å‡ºçš„æ•°æ®åŒ…æ•°\nIcmp:\n    0 ICMP messages received\t\t//æ”¶åˆ°çš„ICMPåŒ…æ•°\n    0 input ICMP message failed\t\t//æ”¶åˆ°ICMPå¤±è´¥æ•°\n    ICMP input histogram:\n    0 ICMP messages sent\t\t\t//ICMPå‘é€æ•°\n    0 ICMP messages failed\t\t\t//ICMPå¤±è´¥æ•°\n    ICMP output histogram:\nTcp:\n    0 active connection openings\t//ä¸»åŠ¨è¿æ¥æ•°\n    0 passive connection openings\t//è¢«åŠ¨è¿æ¥æ•°\n    11 failed connection attempts\t//å¤±è´¥è¿æ¥å°è¯•æ•°\n    0 connection resets received\t//æ¥æ”¶çš„è¿æ¥é‡ç½®æ•°\n    0 connections established\t\t//å»ºç«‹è¿æ¥æ•°\n    25 segments received\t\t\t//å·²æ¥æ”¶æŠ¥æ–‡æ•°\n    21 segments sent out\t\t\t//å·²å‘é€æŠ¥æ–‡æ•°\n    4 segments retransmitted\t\t//é‡ä¼ æŠ¥æ–‡æ•°\n    0 bad segments received\t\t\t//é”™è¯¯æŠ¥æ–‡æ•°\n    0 resets sent\t\t\t\t\t//å‘å‡ºçš„è¿æ¥é‡ç½®æ•°\nUdp:\n    0 packets received\n    ...\nTcpExt:\n    11 resets received for embryonic SYN_RECV sockets\t//åŠè¿æ¥é‡ç½®æ•°\n    0 packet headers predicted\n    TCPTimeouts: 7\t\t//è¶…æ—¶æ•°\n    TCPSynRetrans: 4\t//SYNé‡ä¼ æ•°\n\t...\n</code></pre><p>netstat æ±‡æ€»äº† IPã€ICMPã€TCPã€UDP ç­‰å„ç§åè®®çš„æ”¶å‘ç»Ÿè®¡ä¿¡æ¯ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯æ’æŸ¥ä¸¢åŒ…é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦è§‚å¯Ÿçš„æ˜¯é”™è¯¯æ•°ã€ä¸¢åŒ…æ•°ä»¥åŠé‡ä¼ æ•°ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„è¾“å‡ºï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ TCP åè®®å‘ç”Ÿäº†ä¸¢åŒ…å’Œé‡ä¼ ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul>\n<li>\n<p>11 æ¬¡è¿æ¥å¤±è´¥é‡è¯•ï¼ˆ11 failed connection attemptsï¼‰</p>\n</li>\n<li>\n<p>4 æ¬¡é‡ä¼ ï¼ˆ4 segments retransmittedï¼‰</p>\n</li>\n<li>\n<p>11 æ¬¡åŠè¿æ¥é‡ç½®ï¼ˆ11 resets received for embryonic SYN_RECV socketsï¼‰</p>\n</li>\n<li>\n<p>4 æ¬¡ SYN é‡ä¼ ï¼ˆTCPSynRetransï¼‰</p>\n</li>\n<li>\n<p>7 æ¬¡è¶…æ—¶ï¼ˆTCPTimeoutsï¼‰</p>\n</li>\n</ul><p>è¿™ä¸ªç»“æœå‘Šè¯‰æˆ‘ä»¬ï¼ŒTCP åè®®æœ‰å¤šæ¬¡è¶…æ—¶å’Œå¤±è´¥é‡è¯•ï¼Œå¹¶ä¸”ä¸»è¦é”™è¯¯æ˜¯åŠè¿æ¥é‡ç½®ã€‚æ¢å¥è¯è¯´ï¼Œä¸»è¦çš„å¤±è´¥ï¼Œéƒ½æ˜¯ä¸‰æ¬¡æ¡æ‰‹å¤±è´¥ã€‚</p><p>ä¸è¿‡ï¼Œè™½ç„¶åœ¨è¿™å„¿çœ‹åˆ°äº†è¿™ä¹ˆå¤šå¤±è´¥ï¼Œä½†å…·ä½“å¤±è´¥çš„æ ¹æºè¿˜æ˜¯æ— æ³•ç¡®å®šã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»§ç»­é¡ºç€åè®®æ ˆæ¥åˆ†æã€‚æ¥ä¸‹æ¥çš„å‡ å±‚åˆè¯¥å¦‚ä½•åˆ†æå‘¢ï¼Ÿä½ ä¸å¦¨è‡ªå·±å…ˆæ¥æ€è€ƒæ“ä½œä¸€ä¸‹ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬ç»§ç»­æ¥ä¸€èµ·æ¢è®¨ã€‚</p><h2>å°ç»“</h2><p>ç½‘ç»œä¸¢åŒ…ï¼Œé€šå¸¸ä¼šå¸¦æ¥ä¸¥é‡çš„æ€§èƒ½ä¸‹é™ï¼Œç‰¹åˆ«æ˜¯å¯¹ TCP æ¥è¯´ï¼Œä¸¢åŒ…é€šå¸¸æ„å‘³ç€ç½‘ç»œæ‹¥å¡å’Œé‡ä¼ ï¼Œè¿›ä¸€æ­¥è¿˜ä¼šå¯¼è‡´ç½‘ç»œå»¶è¿Ÿå¢å¤§ã€ååé™ä½ã€‚</p><p>ä»Šå¤©çš„è¿™ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬å­¦ä¼šäº†å¦‚ä½•ä»é“¾è·¯å±‚ã€ç½‘ç»œå±‚å’Œä¼ è¾“å±‚ç­‰å…¥æ‰‹ï¼Œåˆ†æç½‘ç»œä¸¢åŒ…çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œæ¡ˆä¾‹æœ€åï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ‰¾å‡ºæœ€ç»ˆçš„æ€§èƒ½ç“¶é¢ˆï¼Œä¸‹ä¸€èŠ‚ï¼Œæˆ‘å°†ç»§ç»­ä¸ºä½ è®²è§£ã€‚</p><h2>æ€è€ƒ</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼Œä¹Ÿæ˜¯æ¡ˆä¾‹æœ€åæåˆ°çš„é—®é¢˜ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬åªåˆ†æäº†é“¾è·¯å±‚ã€ç½‘ç»œå±‚ä»¥åŠä¼ è¾“å±‚ç­‰ã€‚è€Œæ ¹æ® TCP/IP åè®®æ ˆå’Œ Linux ç½‘ç»œæ”¶å‘åŸç†ï¼Œè¿˜æœ‰å¾ˆå¤šæˆ‘ä»¬æ²¡åˆ†æåˆ°çš„åœ°æ–¹ã€‚é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•åˆ†æï¼Œæ‰èƒ½ç ´è·è¿™ä¸ªæ¡ˆä¾‹ï¼Œæ‰¾å‡ºâ€œçœŸå‡¶â€å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":75560,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1552435703,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40207141367","product_id":100020901,"comment_content":"æ‰“å¡day50<br>è¿˜æ²¡æ¥å¾—åŠå®è·µï¼Œæ€è·¯æ˜¯ï¼Œåœ¨æœåŠ¡ç«¯ç”¨tcpdumpæŠ“åŒ…ï¼Œç„¶åå¯¼å…¥wiresharkåˆ†æï½","like_count":10},{"had_liked":false,"id":91227,"user_name":"æ— åè€å’","can_delete":false,"product_type":"c1","uid":1348261,"ip_address":"","ucode":"48874CE670E122","user_header":"","comment_is_top":false,"comment_ctime":1556937258,"is_pvip":false,"replies":[{"id":"33131","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":91227,"uid":"1001282","ip_address":"","utype":1,"ctime":1557327419,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"35916675626","product_id":100020901,"comment_content":"ç»è¿‡ä¸€å¤œçš„æ€è€ƒï¼Œç»ˆäºææ˜ç™½äº†ï¼Œä½¿ç”¨iptablesåšäº†é™åˆ¶ï¼Œåˆ é™¤è¿™2æ¡è§„åˆ™å°±æ­£å¸¸Pingäº†ã€‚<br><br>root@nginx:&#47;# iptables -nvL<br>Chain INPUT (policy ACCEPT 84 packets, 3472 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br>   51  2116 DROP       all  --  *      *       0.0.0.0&#47;0            0.0.0.0&#47;0            statistic mode random probability 0.29999999981<br><br>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain OUTPUT (policy ACCEPT 65 packets, 2960 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br>   38  1716 DROP       all  --  *      *       0.0.0.0&#47;0            0.0.0.0&#47;0            statistic mode random probability 0.29999999981","like_count":9,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448850,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557327419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233777,"user_name":"é™ˆé–","can_delete":false,"product_type":"c1","uid":1147418,"ip_address":"","ucode":"8C9596A54DB5C8","user_header":"https://static001.geekbang.org/account/avatar/00/11/82/1a/64ec25ff.jpg","comment_is_top":false,"comment_ctime":1594446729,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27364250505","product_id":100020901,"comment_content":"åœ¨å®é™…åœºæ™¯ä¸­ï¼Œä½¿ç”¨ netstat -s çš„è¾“å‡ºæŠ¥å‘ŠæŸ¥çœ‹ï¼Œå¯èƒ½æ··æ‚å…¶ä»–ä¸€äº›æœåŠ¡çš„è¾“å‡ºï¼Œä¸€äº›é”™è¯¯ä¹Ÿæ¯”è¾ƒæ··æ‚ï¼Œæ‰€ä»¥è¿™ç§æ•´ä¸ªç³»ç»Ÿçš„è¾“å‡ºæŠ¥å‘Šï¼Œå‚è€ƒä»·å€¼å¯èƒ½ä¸å¤§","like_count":7},{"had_liked":false,"id":76169,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1552542814,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18732411998","product_id":100020901,"comment_content":"æœ‰å¯èƒ½nginxé…ç½®é—®é¢˜","like_count":4},{"had_liked":false,"id":76791,"user_name":"äºšæ´²-å‡¯æ’’å¤§å¸","can_delete":false,"product_type":"c1","uid":1123650,"ip_address":"","ucode":"2C9E4C60896B6B","user_header":"https://static001.geekbang.org/account/avatar/00/11/25/42/72adcb14.jpg","comment_is_top":false,"comment_ctime":1552708674,"is_pvip":false,"replies":[{"id":"28065","content":"è¿™æ˜¯ä»procæ–‡ä»¶ç³»ç»Ÿè¯»å‡ºæ¥çš„ï¼Œé‡ç½®åªèƒ½é‡å¯","user_name":"ä½œè€…å›å¤","comment_id":76791,"uid":"1001282","ip_address":"","utype":1,"ctime":1552751031,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"10142643266","product_id":100020901,"comment_content":"netstat -s çš„æ•°æ®æ€ä¹ˆé‡ç½®å‘¢","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443448,"discussion_content":"è¿™æ˜¯ä»procæ–‡ä»¶ç³»ç»Ÿè¯»å‡ºæ¥çš„ï¼Œé‡ç½®åªèƒ½é‡å¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552751031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75732,"user_name":"æ—¥æ‹±ä¸€å’","can_delete":false,"product_type":"c1","uid":1056944,"ip_address":"","ucode":"3BDFD6F473862C","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/b0/0a1551c4.jpg","comment_is_top":false,"comment_ctime":1552460503,"is_pvip":false,"replies":[{"id":"28046","content":"è¯·å‚è€ƒæ–‡ä¸­ï¼ˆ47å’Œ48ç¯‡ï¼‰çš„æ€è·¯åˆ†æ","user_name":"ä½œè€…å›å¤","comment_id":75732,"uid":"1001282","ip_address":"","utype":1,"ctime":1552749134,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"10142395095","product_id":100020901,"comment_content":"é‡åˆ°è¿‡  ingress  envoy -&gt;  æŸç»„åº”ç”¨å®¹å™¨  æ—¶ä¸æ—¶çš„å®¹å™¨è®¿é—® 503çš„é—®é¢˜ï¼Œ  æŠ“åŒ…æ”¾ wireshark åˆ†æï¼Œå‘ç°æœ‰å¤§é‡çš„ dup ackã€‚  <br>2ä¸ªå®¹å™¨çš„æœºå™¨æŒ‡æ ‡æ­£å¸¸ï¼Œ pod æŒ‡æ ‡æ­£å¸¸ã€‚<br><br>è‡³ä»Šä¸çŸ¥é“åŸå› ï¼Œ å‡çº§äº†æ“ä½œç³»ç»Ÿå†…æ ¸åï¼Œ é—®é¢˜æœ‰æ‰€ç¼“è§£ï¼Œä½†æ˜¯æ²¡æœ‰æ ¹æœ¬è§£å†³é—®é¢˜ã€‚  ä½œè€…å¯å¦æä¾›ä¸ªæ€è·¯ï¼Ÿ<br>","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443005,"discussion_content":"è¯·å‚è€ƒæ–‡ä¸­ï¼ˆ47å’Œ48ç¯‡ï¼‰çš„æ€è·¯åˆ†æ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552749134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75706,"user_name":"Frank","can_delete":false,"product_type":"c1","uid":1111985,"ip_address":"","ucode":"9DADD72C193296","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg","comment_is_top":false,"comment_ctime":1552453573,"is_pvip":true,"replies":[{"id":"28044","content":"æ‰©å±•TCPæŒ‡æ ‡ï¼Œç›¸å¯¹äºTcpéƒ¨åˆ†åŒ…å«æ›´å¤šçš„æŒ‡æ ‡","user_name":"ä½œè€…å›å¤","comment_id":75706,"uid":"1001282","ip_address":"","utype":1,"ctime":1552748962,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"5847420869","product_id":100020901,"comment_content":"è€å¸ˆ TcpExt: è¡¨ç¤ºä»€ä¹ˆé¡¹ç›®å“¦ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442991,"discussion_content":"æ‰©å±•TCPæŒ‡æ ‡ï¼Œç›¸å¯¹äºTcpéƒ¨åˆ†åŒ…å«æ›´å¤šçš„æŒ‡æ ‡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552748962,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":193524,"user_name":"Richard","can_delete":false,"product_type":"c1","uid":1316758,"ip_address":"","ucode":"893F958B9DD161","user_header":"https://static001.geekbang.org/account/avatar/00/14/17/96/846fc11b.jpg","comment_is_top":false,"comment_ctime":1584923564,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1584923564","product_id":100020901,"comment_content":"è€å¸ˆï¼Œnetstat â€“sæ˜¯ä¸€ä¸ªå¯åŠ¨åçš„ç´¯è®¡å€¼ï¼Œé‚£ä¹ˆåœ¨å‡ºç°é—®é¢˜åå†å»æŸ¥çœ‹è¿™ä¸ªç´¯è®¡å€¼ï¼Œå…¶ç»“æœå¹¶ä¸å…·å¤‡å‚è€ƒæ€§ï¼Œé‚£ä¹ˆé™¤äº†æ‰‹åŠ¨ç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…çš„å¿«ç…§ï¼Œæœ‰æ²¡æœ‰å…¶å®ƒä¾¿æ·çš„æ–¹æ³•å¿«é€Ÿçš„ç»Ÿè®¡å‡ºé—®é¢˜æ—¶é—´æ®µå†…çš„æ•°æ®å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1167662,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d1/2e/d531b29b.jpg","nickname":"å›¾åå…”","note":"","ucode":"2395E9506CBE0E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291458,"discussion_content":"watch -d netstat -sçªå‡ºå˜åŒ–çš„æ•°æ®ï¼Œæˆ–è®¸æ˜¯ä¸ªæ€è·¯","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1594823191,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85431,"user_name":"å¦‚æœ","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1555059587,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555059587","product_id":100020901,"comment_content":"DAY47.æ‰“å¡","like_count":0},{"had_liked":false,"id":78461,"user_name":"é’çŸ³","can_delete":false,"product_type":"c1","uid":1215531,"ip_address":"","ucode":"B0056AD6453322","user_header":"https://static001.geekbang.org/account/avatar/00/12/8c/2b/3ab96998.jpg","comment_is_top":false,"comment_ctime":1553154228,"is_pvip":false,"replies":[{"id":"28756","content":"æˆ‘ä»¬è¿™æ˜¯ä¸¢åŒ…é—®é¢˜ï¼Œåªéœ€è¦å»åˆ†ænetstatä¸­æœ‰ä¸¢åŒ…çš„ä½ç½®å°±å¯ä»¥äº†","user_name":"ä½œè€…å›å¤","comment_id":78461,"uid":"1001282","ip_address":"","utype":1,"ctime":1553317755,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1553154228","product_id":100020901,"comment_content":"TCPç¼“å†²åŒºåœ¨æº¢å‡ºåï¼Œæ•°æ®ä¼šè¢«é˜»å¡å¹¶ä¸ä¼šä¸¢å¼ƒï¼Œä»netstatå¯ä»¥çœ‹åˆ°Recv-Qçš„å€¼å¾ˆå¤§ã€‚<br>UDPç¼“å†²åŒºæº¢å‡ºï¼Œç›´æ¥ä¸¢å¼ƒæŠ¥æ–‡ï¼Œä»netstat -så¯ä»¥çœ‹åˆ°UDPæœ‰å¤§é‡çš„packet receive errorsé”™è¯¯ã€‚<br><br>çœ‹äº†47ã€48èŠ‚ï¼Œå¹¶æ²¡æœ‰ä»å¥—æ¥å­—å±‚æ’æŸ¥é—®é¢˜æ˜¯å› ä¸ºä½¿ç”¨TCPåè®®çš„åŸå› å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444102,"discussion_content":"æˆ‘ä»¬è¿™æ˜¯ä¸¢åŒ…é—®é¢˜ï¼Œåªéœ€è¦å»åˆ†ænetstatä¸­æœ‰ä¸¢åŒ…çš„ä½ç½®å°±å¯ä»¥äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553317755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77971,"user_name":"cheyang","can_delete":false,"product_type":"c1","uid":1315085,"ip_address":"","ucode":"D1A13DF0B9A2A7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0lekib0VOFiaylqrYiaYgSVSMJ9ZyLymaxHpL9hWIUvEypxGhrDkJ2CSQUSwKaopuZFpRvRCIUicghA/132","comment_is_top":false,"comment_ctime":1553047365,"is_pvip":false,"replies":[{"id":"28776","content":"ss æŸ¥çœ‹SYN-SENTçŠ¶æ€çš„è¿æ¥ï¼›æˆ–è€…ï¼Œä½¿ç”¨tcpdumpæŠ“åŒ…","user_name":"ä½œè€…å›å¤","comment_id":77971,"uid":"1001282","ip_address":"","utype":1,"ctime":1553319368,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1553047365","product_id":100020901,"comment_content":"netstat -sä¸­çš„failed connection attemptsçš„ipæºæœ‰åŠæ³•å®šä½åˆ°å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443917,"discussion_content":"ss æŸ¥çœ‹SYN-SENTçŠ¶æ€çš„è¿æ¥ï¼›æˆ–è€…ï¼Œä½¿ç”¨tcpdumpæŠ“åŒ…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553319368,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75830,"user_name":"H","can_delete":false,"product_type":"c1","uid":1445382,"ip_address":"","ucode":"DC6E0CE95E5B64","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oW1lwRgwgBaQk0ZA33fy4XE0rqF7NiaRupV89lqzib02SA5hwFRUicA5OiaA6TYaxKubnVAEFJnJ5olq8xmcJLpcwg/132","comment_is_top":false,"comment_ctime":1552477862,"is_pvip":false,"replies":[{"id":"28051","content":"è¿™å„¿æŒ‡æ ‡å¤ªå¤šäº†ï¼Œå¤§éƒ¨åˆ†è¿˜éƒ½æ˜¯å®Œæ•´çš„è‹±è¯­å¥å­ï¼Œåº”è¯¥å¾ˆå¥½ç†è§£ã€‚å¦‚æœæœ‰å“ªä¸ªä¸æ‡‚çš„ï¼Œå¯ä»¥å•ç‹¬æå‡ºæ¥","user_name":"ä½œè€…å›å¤","comment_id":75830,"uid":"1001282","ip_address":"","utype":1,"ctime":1552749948,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1552477862","product_id":100020901,"comment_content":"è€å¸ˆèƒ½è¯¦ç»†è§£é‡Šä¸‹ä¸€TcpExt é‡Œçš„æŒ‡æ ‡åˆ†åˆ«æ˜¯ä»£è¡¨ä»€ä¹ˆæ„æ€å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443048,"discussion_content":"è¿™å„¿æŒ‡æ ‡å¤ªå¤šäº†ï¼Œå¤§éƒ¨åˆ†è¿˜éƒ½æ˜¯å®Œæ•´çš„è‹±è¯­å¥å­ï¼Œåº”è¯¥å¾ˆå¥½ç†è§£ã€‚å¦‚æœæœ‰å“ªä¸ªä¸æ‡‚çš„ï¼Œå¯ä»¥å•ç‹¬æå‡ºæ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552749948,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75739,"user_name":"æˆ‘æ¥ä¹Ÿ","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1552461626,"is_pvip":false,"replies":[{"id":"28047","content":"ä½ è¿™å®¹å™¨ä¸­mtuåªæœ‰100æ˜¯æ›´ç‹ å‘€ğŸ˜Š<br><br>DUPè¡¨ç¤ºæ”¶åˆ°äº†é‡å¤åŒ…","user_name":"ä½œè€…å›å¤","comment_id":75739,"uid":"1001282","ip_address":"","utype":1,"ctime":1552749315,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":2,"race_medal":0,"score":"1552461626","product_id":100020901,"comment_content":"[D47æ‰“å¡]<br>ä¸çŸ¥ä¸ºä½•,å®¹å™¨ä¸­çš„mtuå€¼åªæœ‰100, å³ä½¿`ifconfig eth0 mtu 1400`,ä¸¢åŒ…ç‡ä¹Ÿæ˜¯ä¾æ—§å¾ˆé«˜.<br>æˆ‘è¿™è¾¹çš„hping3ç»“æœä¸­,æœ‰äº›çœ‹ä¸æ‡‚çš„åœ°æ–¹:<br>DUP! len=44 ip=192.168.1.128 ttl=63 DF id=0 sport=80 flags=SA seq=2 win=27200 rtt=1018.3 ms<br>len=44 ip=192.168.1.128 ttl=63 DF id=0 sport=80 flags=SA seq=4 win=27200 rtt=1032.7 ms<br>DUP! len=44 ip=192.168.1.128 ttl=63 DF id=0 sport=80 flags=SA seq=2 win=27200 rtt=3034.1 ms<br><br>è¿™é‡Œçš„DUPåº”è¯¥æ˜¯é‡å¤äº†çš„æ„æ€å§.<br><br>è€å¸ˆè¿™ä¸ªæ¡ˆä¾‹å¤ªç‹ äº†,è¿é“¾è·¯å±‚ä¸Šéƒ½åšäº†æ‰‹è„š.ğŸ˜","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443009,"discussion_content":"ä½ è¿™å®¹å™¨ä¸­mtuåªæœ‰100æ˜¯æ›´ç‹ å‘€ğŸ˜Š\n\nDUPè¡¨ç¤ºæ”¶åˆ°äº†é‡å¤åŒ…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552749315,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1300550,"avatar":"https://static001.geekbang.org/account/avatar/00/13/d8/46/9bfd1bf2.jpg","nickname":"åˆ˜å‰‘æ³¢","note":"","ucode":"BD2D6249455633","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587951,"discussion_content":"nginxé‚£ä¸ªå®¹å™¨æ‹‰ä¸ä¸‹æ¥äº†ï¼Œæ˜¯æ—¶é—´å¤ªä¹…äº†æœ‰æ›´æ–°å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663401376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}