{"id":150560,"title":"35 | ZooKeeper本地存储源码解析","content":"<p><strong>课件和Demo地址</strong></p><p><a href=\"https://gitee.com/geektime-geekbang/geekbang-zk-course\">https://gitee.com/geektime-geekbang/geekbang-zk-course</a></p>","comments":[{"had_liked":false,"id":149723,"user_name":"Geek_ee6004","can_delete":false,"product_type":"c3","uid":1288285,"ip_address":"","ucode":"C98AD1486746C3","user_header":"","comment_is_top":false,"comment_ctime":1573354398,"is_pvip":false,"replies":[{"id":58518,"content":"&gt; 1、snapshot的话，可以理解为是数据库里面的全量备份吗？\n是数据库里面的全量备份。\n\n&gt; 这个触发的时机都有哪些呢，是否是定期的？\nsnapCount控制生成快照的频率，当日志文件里面的日志记录数大于snapCount &#47; 2 + r.nextInt(snapCount&#47;2)时生成一个快照。细节可以参见SyncRequestProcessor.java的代码。\n\n&gt; 如果配置pure事务日志的时候，清除事务日志的时候，会触发snapshot吗？\n不会。但是保证数据恢复需要的快照不会被清除掉。\n\n&gt; 2、snapshot的保存有什么策略吗？是否系统运行很久后，snapshot会膨胀得很大（存在多个文件）如何去管理呢？\nautopurge.snapRetainCount控制保留多少个快照，autopurge.purgeInterval控制多长时间进行一次清理。如果autopurge.purgeInterval设置成了0，需要手动使用zkCleanup.sh进行清理。\n\n&gt; 3、snapshot是否可以用来做新服务器的数据恢复？比如我有五个节点的集群，现在坏了3个，还剩2个，希望再加3个，新增的3个节点，如何才能保证与剩余2个节点的数据一致，是通告依次动态添加节点来让zookeeper进行同步刷新。还是说，可以自己从剩余的2个节点中拷贝数据和事务日志，让新节点从快照和事务日志中恢复数据呢？\n快照的用处之一就是用来做新服务器和leader节点之间的同步。如果剩下的两个节点还是形成了一个运行的ensemble,依次动态添加节点就行了。ZooKeeper会自动进行新节点和leader节点之前的同步。如果新节点落后leader节点不多，就会只从leader节点接收日志记录。否则的话，先从leader节点接收一个快照，再接收后续日志记录。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1573914392,"ip_address":"","comment_id":149723,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师，你好，看完后，有几个问题，希望得到解答\n1、snapshot的话，可以理解为是数据库里面的全量备份吗？这个触发的时机都有哪些呢，是否是定期的？如果配置pure事务日志的时候，清除事务日志的时候，会触发snapshot吗？\n2、snapshot的保存有什么策略吗？是否系统运行很久后，snapshot会膨胀得很大（存在多个文件）如何去管理呢？\n3、snapshot是否可以用来做新服务器的数据恢复？比如我有五个节点的集群，现在坏了3个，还剩2个，希望再加3个，新增的3个节点，如何才能保证与剩余2个节点的数据一致，是通告依次动态添加节点来让zookeeper进行同步刷新。还是说，可以自己从剩余的2个节点中拷贝数据和事务日志，让新节点从快照和事务日志中恢复数据呢？","like_count":4,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473955,"discussion_content":"&amp;gt; 1、snapshot的话，可以理解为是数据库里面的全量备份吗？\n是数据库里面的全量备份。\n\n&amp;gt; 这个触发的时机都有哪些呢，是否是定期的？\nsnapCount控制生成快照的频率，当日志文件里面的日志记录数大于snapCount / 2 + r.nextInt(snapCount/2)时生成一个快照。细节可以参见SyncRequestProcessor.java的代码。\n\n&amp;gt; 如果配置pure事务日志的时候，清除事务日志的时候，会触发snapshot吗？\n不会。但是保证数据恢复需要的快照不会被清除掉。\n\n&amp;gt; 2、snapshot的保存有什么策略吗？是否系统运行很久后，snapshot会膨胀得很大（存在多个文件）如何去管理呢？\nautopurge.snapRetainCount控制保留多少个快照，autopurge.purgeInterval控制多长时间进行一次清理。如果autopurge.purgeInterval设置成了0，需要手动使用zkCleanup.sh进行清理。\n\n&amp;gt; 3、snapshot是否可以用来做新服务器的数据恢复？比如我有五个节点的集群，现在坏了3个，还剩2个，希望再加3个，新增的3个节点，如何才能保证与剩余2个节点的数据一致，是通告依次动态添加节点来让zookeeper进行同步刷新。还是说，可以自己从剩余的2个节点中拷贝数据和事务日志，让新节点从快照和事务日志中恢复数据呢？\n快照的用处之一就是用来做新服务器和leader节点之间的同步。如果剩下的两个节点还是形成了一个运行的ensemble,依次动态添加节点就行了。ZooKeeper会自动进行新节点和leader节点之前的同步。如果新节点落后leader节点不多，就会只从leader节点接收日志记录。否则的话，先从leader节点接收一个快照，再接收后续日志记录。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573914392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1288285,"avatar":"","nickname":"Geek_ee6004","note":"","ucode":"C98AD1486746C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":99391,"discussion_content":"谢谢老师！\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577199514,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165287,"user_name":"万事屋","can_delete":false,"product_type":"c3","uid":1105854,"ip_address":"","ucode":"57C08B85373B0D","user_header":"https://static001.geekbang.org/account/avatar/00/10/df/be/c6f8953f.jpg","comment_is_top":false,"comment_ctime":1577194095,"is_pvip":false,"replies":[{"id":75928,"content":"organic.apache.zookeeper.data包里面的代码是由zookeeper.jute文件生成的。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1586145013,"ip_address":"","comment_id":165287,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"我从github上clone的代码没有organic.apache.zookeeper.data这个包？","like_count":1,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479107,"discussion_content":"organic.apache.zookeeper.data包里面的代码是由zookeeper.jute文件生成的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586145013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165280,"user_name":"万事屋","can_delete":false,"product_type":"c3","uid":1105854,"ip_address":"","ucode":"57C08B85373B0D","user_header":"https://static001.geekbang.org/account/avatar/00/10/df/be/c6f8953f.jpg","comment_is_top":false,"comment_ctime":1577192774,"is_pvip":false,"replies":[{"id":66863,"content":"使用的Darcula主体。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1579174926,"ip_address":"","comment_id":165280,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"想要老师的intellij idea的配色","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479105,"discussion_content":"使用的Darcula主体。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579174926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144603,"user_name":"不二","can_delete":false,"product_type":"c3","uid":1147151,"ip_address":"","ucode":"67E0E3BA3EEC26","user_header":"https://static001.geekbang.org/account/avatar/00/11/81/0f/8f7ebd2d.jpg","comment_is_top":false,"comment_ctime":1571977894,"is_pvip":false,"replies":[{"id":56753,"content":"1. 网络原因导致ZooKeeper节点互相连不上。\n2. 多个ZooKeeper节点的失败。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1572697480,"ip_address":"","comment_id":144603,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师您好，最近公司zk集群挂掉了，由于业务紧急，重启了集群，想请教老师，zk挂掉一些常见的原因有哪些","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472026,"discussion_content":"1. 网络原因导致ZooKeeper节点互相连不上。\n2. 多个ZooKeeper节点的失败。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572697480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143438,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1571708800,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师  想问个问题 如果zookeeper 创造了一个snapshot 之后比如snapshot中的最大zxid是a, 那么他会不会在snapshot完成后把小于等于a的transanction log删除， 只保留zxid大于a的transanction log？","like_count":0}]}