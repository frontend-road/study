{"id":420009,"title":"05ï½œå°è£…ï¼šå¦‚ä½•è®©ä½ çš„æ¡†æ¶æ›´å¥½ç”¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚</p><p>åœ¨å‰é¢å‡ èŠ‚è¯¾ï¼Œæˆ‘ä»¬å®ç°äº†æ¡†æ¶çš„è·¯ç”±ã€ä¸­é—´ä»¶ç­‰æœºåˆ¶ï¼Œå¹¶ä¸”è‡ªå®šä¹‰ context ç»“æ„æ¥å°è£…è¯·æ±‚ã€‚ä½†æ˜¯å›é¡¾åœ¨å¯¹ context çš„å°è£…ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å°† requestã€response ç»“æ„ç›´æ¥æ”¾å…¥ context ç»“æ„ä½“ä¸­ï¼Œå¯¹åº”çš„æ–¹æ³•å¹¶æ²¡æœ‰å¾ˆå¥½çš„å°è£…ã€‚æ‰€ä»¥è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬è¦åšçš„äº‹æƒ…å°±æ˜¯ä¸º context å°è£…æ›´å¤šçš„æ–¹æ³•ï¼Œè®©æ¡†æ¶æ›´å¥½ç”¨ã€‚</p><p>åœ¨ä»Šå¤©çš„å­¦ä¹ ä¸­ï¼Œå¸Œæœ›ä½ èƒ½è®¤è¯†åˆ°ï¼Œå‡½æ•°å°è£…å¹¶ä¸æ˜¯ä¸€ä»¶å¾ˆç®€å•ã€å¾ˆéšæ„çš„äº‹æƒ…ã€‚ç›¸åï¼Œå¦‚ä½•å°è£…å‡ºæ˜“ç”¨ã€å¯è¯»æ€§é«˜çš„å‡½æ•°æ˜¯éå¸¸éœ€è¦ç²¾å¿ƒè€ƒé‡çš„ï¼Œ<strong>æ¡†æ¶ä¸­æ¯ä¸ªå‡½æ•°çš„å‚æ•°ã€è¿”å›å€¼ã€å‘½åï¼Œéƒ½ä»£è¡¨ç€æˆ‘ä»¬ä½œä¸ºä½œè€…åœ¨æŸä¸ªäº‹æƒ…ä¸Šçš„æ€è€ƒ</strong>ã€‚æƒ³è¦é’ˆå¯¹æŸä¸ªåŠŸèƒ½ï¼Œå°è£…å‡ºä¸€ç³»åˆ—æ¯”è¾ƒå®Œç¾çš„æ¥å£ï¼Œæ›´è¦æˆ‘ä»¬ä»ç³»ç»Ÿæ€§çš„è§’åº¦æ€è€ƒã€‚</p><h2>æ€è€ƒå¦‚ä½•å°è£…è¯·æ±‚å’Œè¿”å›</h2><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°½é‡åœ¨ context è¿™ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œå°è£…â€œè¯»å–è¯·æ±‚æ•°æ®â€å’Œâ€œå°è£…è¿”å›æ•°æ®â€ä¸­çš„æ–¹æ³•ã€‚åœ¨åŠ¨æ‰‹ä¹‹å‰è¿˜æ˜¯å…ˆåšåˆ°å¿ƒä¸­æœ‰æ•°ï¼Œæˆ‘ä»¬å°†è¯·æ±‚å’Œè¿”å›è¿™ä¸¤ä¸ªäº‹æƒ…åˆ†å¼€æ€è€ƒã€‚</p><ul>\n<li>è¯»å–è¯·æ±‚æ•°æ®</li>\n</ul><p>è¦è¯»å–è¯·æ±‚æ•°æ®åŒ…å«å“ªäº›å†…å®¹å‘¢ï¼Ÿç¬¬ä¸€è®²æˆ‘ä»¬æåˆ°è¿‡ï¼ŒHTTP æ¶ˆæ¯ä½“åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šHTTP å¤´éƒ¨å’Œ HTTP Body ä½“ã€‚å¤´éƒ¨æè¿°çš„ä¸€èˆ¬æ˜¯å’Œä¸šåŠ¡æ— å…³ä½†ä¸ä¼ è¾“ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚åœ°å€ã€ç¼–ç æ ¼å¼ã€ç¼“å­˜æ—¶é•¿ç­‰ï¼›Body é‡Œé¢ä¸»è¦æè¿°çš„æ˜¯ä¸ä¸šåŠ¡ç›¸å…³çš„ä¿¡æ¯ã€‚</p><!-- [[[read_end]]] --><p>æ‰€ä»¥é’ˆå¯¹è¯·æ±‚æ•°æ®çš„è¿™ä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬åº”è¯¥è®¾è®¡ä¸åŒçš„æ–¹æ³•ã€‚</p><p>Header ä¿¡æ¯ä¸­ï¼ŒåŒ…å« HTTP çš„ä¸€äº›åŸºç¡€ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚åœ°å€ã€è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚ IPã€è¯·æ±‚åŸŸåã€Cookie ä¿¡æ¯ç­‰ï¼Œæ˜¯ç»å¸¸è¯»å–ä½¿ç”¨çš„ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸€æä¾›å°è£…ã€‚</p><p>è€Œå¦å¤–ä¸€äº›æ›´ç»†èŠ‚çš„å†…å®¹ç¼–ç æ ¼å¼ã€ç¼“å­˜æ—¶é•¿ç­‰ï¼Œç”±äºæ¶‰åŠçš„ HTTP åè®®ç»†èŠ‚å†…å®¹æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å¾ˆéš¾å°†æ¯ä¸ªç»†èŠ‚éƒ½å°è£…å‡ºæ¥ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ˜¯ä»¥ key=value çš„å½¢å¼ä¼ é€’åˆ°æœåŠ¡ç«¯çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿè€ƒè™‘å°è£…ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•ã€‚</p><p>Body ä¿¡æ¯ä¸­ï¼ŒHTTP æ˜¯å·²ç»ä»¥æŸç§å½¢å¼å°è£…å¥½çš„ï¼Œå¯èƒ½æ˜¯ JSON æ ¼å¼ã€XML æ ¼å¼ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ Form è¡¨å•æ ¼å¼ã€‚å…¶ä¸­ Form è¡¨å•æ³¨æ„ä¸€ä¸‹ï¼Œå®ƒå¯èƒ½åŒ…å« File æ–‡ä»¶ï¼Œè¯·æ±‚å‚æ•°å’Œè¿”å›å€¼è‚¯å®šå’Œå…¶ä»–çš„ Form è¡¨å•å­—æ®µæ˜¯ä¸ä¸€æ ·çš„ï¼Œéœ€è¦æˆ‘ä»¬å¯¹å…¶å•ç‹¬å°è£…ä¸€ä¸ªå‡½æ•°ã€‚</p><ul>\n<li>å°è£…è¿”å›æ•°æ®</li>\n</ul><p>å°è£…è¿”å›æ•°æ®ï¼ŒæŒ‡çš„æ˜¯å°†å¤„ç†åçš„æ•°æ®è¿”å›ç»™æµè§ˆå™¨ã€‚åŒæ ·ï¼Œå®ƒä¹Ÿåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼ŒHeader å¤´éƒ¨å’Œ Body ä½“ã€‚</p><p>Header å¤´éƒ¨ï¼Œæˆ‘ä»¬ç»å¸¸è¦è®¾ç½®çš„æ˜¯è¿”å›çŠ¶æ€ç å’Œ Cookieï¼Œæ‰€ä»¥å•ç‹¬ä¸ºå…¶å°è£…ã€‚å…¶ä»–çš„ Header åŒæ ·æ˜¯ key=value å½¢å¼è®¾ç½®çš„ï¼Œè®¾ç½®ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•å³å¯ã€‚</p><p>è¿”å›æ•°æ®çš„ Body ä½“æ˜¯æœ‰ä¸åŒå½¢å¼çš„ï¼Œæ¯”å¦‚ JSONã€JSONPã€XMLã€HTMLæˆ–è€…å…¶ä»–æ–‡æœ¬æ ¼å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é’ˆå¯¹ä¸åŒçš„Bodyä½“å½¢å¼ï¼Œè¿›è¡Œä¸åŒçš„å°è£…ã€‚</p><p>ä¸€è·¯åˆ†æä¸‹æ¥ï¼Œå†åˆ—å‡ºè¿™æ ·ä¸€ä¸ªæ€ç»´å¯¼å›¾å°±éå¸¸æ¸…æ™°äº†ã€‚<img src=\"https://static001.geekbang.org/resource/image/5d/3b/5d7b8554f7cbd074db00a62acdfe5a3b.jpg?wh=2038x2209\" alt=\"\"></p><h2>å®šä¹‰æ¥å£è®©å°è£…æ›´æ˜ç¡®</h2><p>ç°åœ¨åˆ†æå®Œéœ€è¦å°è£…å“ªäº›æ–¹æ³•äº†ï¼Œä½ å·²ç»è¿«ä¸åŠå¾…æƒ³å¼€å§‹è¿›è¡Œå°è£…å‡½æ•°çš„å®ç°äº†å§ã€‚ä½†æ˜¯è¿™é‡Œï¼Œæˆ‘å†ç»™ä¸€ä¸ªç¼–ç å°å»ºè®®ï¼š<strong>å¯¹äºæ¯”è¾ƒå®Œæ•´çš„åŠŸèƒ½æ¨¡å—ï¼Œå…ˆå®šä¹‰æ¥å£ï¼Œå†å…·ä½“å®ç°</strong>ã€‚</p><p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªæ¸…æ™°çš„ã€åŒ…å«è‹¥å¹²ä¸ªæ–¹æ³•çš„æ¥å£ï¼Œå¯ä»¥è®©ä½¿ç”¨è€…éå¸¸æ¸…æ¥šï¼šè¿™ä¸ªåŠŸèƒ½æ¨¡å—æä¾›äº†å“ªäº›å‡½æ•°ã€å“ªäº›å‡½æ•°æ˜¯æˆ‘è¦çš„ã€å“ªäº›å‡½æ•°æ˜¯æˆ‘ä¸è¦çš„ï¼Œåœ¨ç”¨çš„æ—¶å€™ï¼ŒæŸ¥æ‰¾ä¹Ÿæ›´æ–¹ä¾¿ã€‚å¦‚æœä½ æœ‰è¿‡ï¼Œåœ¨è¶…è¿‡ 20 ä¸ªå‡½æ•°çš„ç»“æ„ä½“ä¸­ï¼ŒæŸ¥æ‰¾ä½ éœ€è¦çš„å‡½æ•°çš„æƒ¨ç—›ç»å†ï¼Œä½ å°±ä¼šè§‰å¾—è¿™ä¸€ç‚¹å°¤ä¸ºé‡è¦äº†ã€‚</p><p>å…¶æ¬¡ï¼Œå®šä¹‰æ¥å£èƒ½åšåˆ°â€œå®ç°è§£è€¦â€ã€‚ä½¿ç”¨æ¥å£ä½œä¸ºå‚æ•°ã€è¿”å›å€¼ï¼Œèƒ½å¤Ÿè®©ä½¿ç”¨è€…åœ¨å†™å…·ä½“å‡½æ•°çš„æ—¶å€™ï¼Œæœ‰ä¸åŒçš„å®ç°ï¼›è€Œä¸”åœ¨ä¸åŒå®ç°ä¸­ï¼Œåªéœ€è¦åšåˆ°æ¥å£ä¸€è‡´ï¼Œå°±èƒ½å¾ˆç®€å•è¿›è¡Œæ›¿æ¢ï¼Œè€Œä¸ç”¨ä¿®æ”¹ä½¿ç”¨æ–¹çš„ä»»ä½•ä»£ç ã€‚</p><p>å¥½ï¼Œæ˜ç™½è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å†å›åˆ°å°è£…éœ€æ±‚ä¸Šï¼Œå…ˆå®šä¹‰ä¸¤ä¸ªæ¥å£ï¼šIRequest å’Œ IResponseï¼Œåˆ†åˆ«å¯¹åº”â€œè¯»å–è¯·æ±‚æ•°æ®â€å’Œâ€œå°è£…è¿”å›æ•°æ®â€ è¿™ä¸¤ä¸ªåŠŸèƒ½æ¨¡å—ã€‚</p><p>æˆ‘ä»¬åˆ†åˆ«åœ¨æ¡†æ¶ç›®å½•ä¸‹åˆ›å»ºrequest.goå’Œresponse.goæ¥å­˜æ”¾è¿™ä¸¤ä¸ªæ¥å£åŠå…¶å®ç°ã€‚</p><h3>IRequestæ¥å£å®šä¹‰</h3><p>è¯»å–è¯·æ±‚æ•°æ® IRequestï¼Œæˆ‘ä»¬å®šä¹‰çš„æ–¹æ³•å¦‚ä¸‹ï¼Œåœ¨request.goä¸­è¿›è¡Œä¿®æ”¹ï¼š</p><pre><code class=\"language-go\">// ä»£è¡¨è¯·æ±‚åŒ…å«çš„æ–¹æ³•\ntype IRequest interface {\n\t// è¯·æ±‚åœ°å€ url ä¸­å¸¦çš„å‚æ•°\n\t// å½¢å¦‚: foo.com?a=1&amp;b=bar&amp;c[]=bar\n\tQueryInt(key string, def int) (int, bool)\n\tQueryInt64(key string, def int64) (int64, bool)\n\tQueryFloat64(key string, def float64) (float64, bool)\n\tQueryFloat32(key string, def float32) (float32, bool)\n\tQueryBool(key string, def bool) (bool, bool)\n\tQueryString(key string, def string) (string, bool)\n\tQueryStringSlice(key string, def []string) ([]string, bool)\n\tQuery(key string) interface{}\n\n\t// è·¯ç”±åŒ¹é…ä¸­å¸¦çš„å‚æ•°\n\t// å½¢å¦‚ /book/:id\n\tParamInt(key string, def int) (int, bool)\n\tParamInt64(key string, def int64) (int64, bool)\n\tParamFloat64(key string, def float64) (float64, bool)\n\tParamFloat32(key string, def float32) (float32, bool)\n\tParamBool(key string, def bool) (bool, bool)\n\tParamString(key string, def string) (string, bool)\n\tParam(key string) interface{}\n\n\t// form è¡¨å•ä¸­å¸¦çš„å‚æ•°\n\tFormInt(key string, def int) (int, bool)\n\tFormInt64(key string, def int64) (int64, bool)\n\tFormFloat64(key string, def float64) (float64, bool)\n\tFormFloat32(key string, def float32) (float32, bool)\n\tFormBool(key string, def bool) (bool, bool)\n\tFormString(key string, def string) (string, bool)\n\tFormStringSlice(key string, def []string) ([]string, bool)\n\tFormFile(key string) (*multipart.FileHeader, error)\n\tForm(key string) interface{}\n\n\t// json body\n\tBindJson(obj interface{}) error\n\n\t// xml body\n\tBindXml(obj interface{}) error\n\n\t// å…¶ä»–æ ¼å¼\n\tGetRawData() ([]byte, error)\n\n\t// åŸºç¡€ä¿¡æ¯\n\tUri() string\n\tMethod() string\n\tHost() string\n\tClientIp() string\n\n\t// header\n\tHeaders() map[string][]string\n\tHeader(key string) (string, bool)\n\n\t// cookie\n\tCookies() map[string]string\n\tCookie(key string) (string, bool)\n}\n</code></pre><p>ç®€å•è¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† QueryXXX çš„ç³»åˆ—æ–¹æ³•æ¥ä»£è¡¨ä» URL çš„å‚æ•°åç¼€ä¸­è·å–çš„å‚æ•°ï¼›ä½¿ç”¨ ParamXXX çš„ç³»åˆ—æ–¹æ³•æ¥ä»£è¡¨ä»è·¯ç”±åŒ¹é…ä¸­è·å–çš„å‚æ•°ï¼›ä½¿ç”¨ FormXXX çš„ç³»åˆ—æ–¹æ³•æ¥ä»£è¡¨ä» Body çš„ form è¡¨å•ä¸­è·å–çš„å‚æ•°ã€‚</p><p>ä¸çŸ¥é“ä½ å‘ç°äº†æ²¡æœ‰ï¼Œ<strong>è¿™ä¸‰ä¸ªç³»åˆ—çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç»Ÿä¸€äº†å‚æ•°å’Œè¿”å›å€¼</strong>ã€‚</p><ul>\n<li>å‚æ•°ä¸€èˆ¬éƒ½æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯ keyï¼Œä»£è¡¨ä»å‚æ•°åˆ—è¡¨ä¸­æŸ¥æ‰¾å‚æ•°çš„å…³é”®è¯ï¼›å¦å¤–ä¸€ä¸ªæ˜¯ defï¼Œä»£è¡¨å¦‚æœæŸ¥æ‰¾ä¸åˆ°å…³é”®è¯ï¼Œä¼šä½¿ç”¨å“ªä¸ªé»˜è®¤å€¼è¿›è¡Œè¿”å›ã€‚</li>\n<li>è¿”å›å€¼è¿”å›ä¸¤ä¸ªï¼šä¸€ä¸ªä»£è¡¨å¯¹åº” key çš„åŒ¹é…å€¼ï¼Œè€Œå¦ä¸€ä¸ª bool è¿”å›å€¼ä»£è¡¨æ˜¯å¦æœ‰è¿™ä¸ªè¿”å›å€¼ã€‚</li>\n</ul><p>è¿™æ ·çš„è®¾è®¡ï¼Œåœ¨è·å–å‚æ•°çš„æ—¶å€™ï¼Œèƒ½è®©éœ€è¦å¤„ç†çš„ä¸¤ä¸ªé€»è¾‘ï¼Œé»˜è®¤å‚æ•°å’Œæ˜¯å¦æœ‰å‚æ•°ï¼Œéƒ½å¾—åˆ°å¾ˆå¥½çš„å¤„ç†ï¼›åŒæ—¶å¯¹äº JSON æ ¼å¼ã€XML æ ¼å¼çš„ Body ç»“æ„è¯»å–ï¼Œä¹Ÿæä¾›äº†å¯¹åº”çš„æ–¹æ³•ã€‚</p><p>å¯¹åŸºç¡€ä¿¡æ¯ï¼Œæˆ‘ä»¬æä¾›äº† URIã€Methodã€Hostã€ClinetIp ç­‰æ–¹æ³•ï¼›å¯¹ Header å¤´ï¼Œæˆ‘ä»¬æä¾›æ ¹æ® key è·å– Header å€¼çš„é€šç”¨æ–¹æ³•ï¼›åŒæ—¶ï¼Œä¹Ÿå¯¹ Cookie å•ç‹¬æä¾›äº†æ‰¹é‡è·å– Cookie å’ŒæŒ‰ç…§å…³é”®è¯è·å– Cookie çš„ä¸¤ä¸ªæ–¹æ³•ã€‚</p><p>è¿™äº›éƒ½å¯¹åº”æˆ‘ä»¬ç¬¬ä¸€éƒ¨åˆ†åˆ†æçš„æ€ç»´å¯¼å›¾ä¸­â€œè¯»å–è¯·æ±‚æ•°æ®â€éƒ¨åˆ†ã€‚</p><h3>IResponseæ¥å£å®šä¹‰</h3><p>å¯¹äºå°è£…è¿”å›æ•°æ® IResponseï¼Œæˆ‘ä»¬åœ¨response.goä¸­å®šä¹‰çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">// IResponse ä»£è¡¨è¿”å›æ–¹æ³•\ntype IResponse interface {\n\t// Json è¾“å‡º\n\tJson(obj interface{}) IResponse\n\n\t// Jsonp è¾“å‡º\n\tJsonp(obj interface{}) IResponse\n\n\t//xml è¾“å‡º\n\tXml(obj interface{}) IResponse\n\n\t// html è¾“å‡º\n\tHtml(template string, obj interface{}) IResponse\n\n\t// string\n\tText(format string, values ...interface{}) IResponse\n\n\t// é‡å®šå‘\n\tRedirect(path string) IResponse\n\n\t// header\n\tSetHeader(key string, val string) IResponse\n\n\t// Cookie\n\tSetCookie(key string, val string, maxAge int, path, domain string, secure, httpOnly bool) IResponse\n\n\t// è®¾ç½®çŠ¶æ€ç \n\tSetStatus(code int) IResponse\n\n\t// è®¾ç½® 200 çŠ¶æ€\n\tSetOkStatus() IResponse\n}\n</code></pre><p>å¯¹äº Header éƒ¨åˆ†ï¼Œæˆ‘ä»¬è®¾è®¡äº†çŠ¶æ€ç çš„è®¾ç½®å‡½æ•° SetStatus/SetOkStatus/Redirectï¼Œè¿˜è®¾è®¡äº† Cookie çš„è®¾ç½®å‡½æ•° SetCookieï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬æä¾›äº†é€šç”¨çš„è®¾ç½® Header çš„å‡½æ•° SetHeaderã€‚</p><p>å¯¹äº Body éƒ¨åˆ†ï¼Œæˆ‘ä»¬è®¾è®¡äº† JSONã€JSONPã€XMLã€HTMLã€Text ç­‰æ–¹æ³•æ¥è¾“å‡ºä¸åŒæ ¼å¼çš„ Bodyã€‚</p><p>è¿™é‡Œæ³¨æ„ä¸‹ï¼Œ<strong>å¾ˆå¤šæ–¹æ³•çš„è¿”å›å€¼ä½¿ç”¨ IResponse æ¥å£æœ¬èº«ï¼Œ è¿™ä¸ªè®¾è®¡èƒ½å…è®¸ä½¿ç”¨æ–¹è¿›è¡Œé“¾å¼è°ƒç”¨</strong>ã€‚é“¾å¼è°ƒç”¨çš„å¥½å¤„æ˜¯ï¼Œèƒ½å¾ˆå¤§æå‡ä»£ç çš„é˜…è¯»æ€§ï¼Œæ¯”å¦‚åœ¨ä¸šåŠ¡é€»è¾‘ä»£ç controller.goé‡Œè¿™ä¸ªè°ƒç”¨æ–¹æ³•ï¼š</p><pre><code class=\"language-plain\">c.SetOkStatus().Json(\"ok, UserLoginController: \" + foo)\n</code></pre><p>å°±èƒ½å¾ˆå¥½åœ°é˜…è¯»ï¼šâ€œè¿”å›æˆåŠŸï¼Œå¹¶ä¸”è¾“å‡º JSON å­—ç¬¦ä¸²â€ã€‚è¿™ç§é€šè¿‡è¿”å›å€¼è¿”å›æ¥å£æœ¬èº«çš„å°æŠ€å·§ï¼Œæˆ‘ä»¬åé¢ä¼šç»å¸¸ç”¨åˆ°ã€‚</p><h2>å®ç°å…·ä½“çš„æ¥å£</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®ç°è¿™ä¸¤ä¸ªæ¥å£ï¼Œç›´æ¥å°† Context è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå®ç°è¿™ä¸¤ä¸ªæ¥å£å®šä¹‰çš„æ–¹æ³•å°±è¡Œäº†ã€‚<strong>å› ä¸ºåœ¨ Golang ä¸­ï¼Œåªè¦åŒ…å«äº†æ¥å£æ‰€å¸¦çš„å‡½æ•°å°±æ˜¯å®ç°äº†æ¥å£ï¼Œå¹¶ä¸éœ€è¦æ˜¾å¼æ ‡è®°ç»§æ‰¿</strong>ã€‚</p><p>ç”±äºè¿™äº›æ¥å£æœ‰çš„æ¯”è¾ƒé‡å¤ï¼Œæ‰€ä»¥è¿™é‡Œåªè§£è¯´å‡ ä¸ªé‡ç‚¹çš„å®ç°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href=\"https://github.com/gohade/coredemo/tree/geekbang/05\">GitHub ä»“åº“</a>ã€‚</p><h2>è¯·æ±‚ç›¸å…³æ¥å£å®ç°</h2><p>æˆ‘ä»¬å…ˆå°†æ³¨æ„åŠ›ä¸“æ³¨åœ¨ Request è¯·æ±‚ç›¸å…³çš„æ–¹æ³•ä¸Šï¼Œé¦–å…ˆå¤„ç†åˆšæ‰åœ¨request.goä¸­å®šä¹‰çš„ Query ç›¸å…³çš„å‚æ•°è¯·æ±‚æ–¹æ³•ã€‚</p><pre><code class=\"language-go\">    // è¯·æ±‚åœ°å€ url ä¸­å¸¦çš„å‚æ•°\n\t// å½¢å¦‚: foo.com?a=1&amp;b=bar&amp;c[]=bar\n\tQueryInt(key string, def int) (int, bool)\n\tQueryInt64(key string, def int64) (int64, bool)\n\tQueryFloat64(key string, def float64) (float64, bool)\n\tQueryFloat32(key string, def float32) (float32, bool)\n\tQueryBool(key string, def bool) (bool, bool)\n\tQueryString(key string, def string) (string, bool)\n\tQueryStringSlice(key string, def []string) ([]string, bool)\n\tQuery(key string) interface{}\n</code></pre><p>å¦‚ä½•è·å–è¯·æ±‚å‚æ•°å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥ä» http.Request ç»“æ„ä¸­ï¼Œé€šè¿‡ Query æ–¹æ³•ï¼Œè·å–åˆ°è¯·æ±‚ URL ä¸­çš„å‚æ•°ã€‚</p><h3>Query è¯·æ±‚æ–¹æ³•å®ç°</h3><p>æ‰€ä»¥ï¼Œåœ¨request.goä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª QueryAll() æ–¹æ³•ã€‚</p><pre><code class=\"language-go\">// è·å–è¯·æ±‚åœ°å€ä¸­æ‰€æœ‰å‚æ•°\nfunc (ctx *Context) QueryAll() map[string][]string {\n\tif ctx.request != nil {\n\t\treturn map[string][]string(ctx.request.URL.Query())\n\t}\n\treturn map[string][]string{}\n}\n</code></pre><p>æ¥ç€è¦åšçš„ï¼Œå°±æ˜¯å°†è¿™ä¸ª QueryAll æŸ¥è¯¢å‡ºæ¥çš„ map ç»“æ„æ ¹æ® key æŸ¥è¯¢ï¼Œå¹¶ä¸”è½¬æ¢ä¸ºå…¶ä»–ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ Intã€Int64ã€Float64ã€Float32 ç­‰ã€‚</p><p>è¿™é‡Œæˆ‘æ¨èä¸€ä¸ª<a href=\"https://github.com/spf13/cast\">ç¬¬ä¸‰æ–¹åº“cast</a>ï¼Œè¿™ä¸ªåº“å®ç°äº†å¤šç§å¸¸è§ç±»å‹ä¹‹é—´çš„ç›¸äº’è½¬æ¢ï¼Œè¿”å›æœ€ç¬¦åˆç›´è§‰çš„ç»“æœï¼Œé€šè¿‡<a href=\"https://pkg.go.dev/\">è¿™ä¸ªç½‘ç«™</a>å¯ä»¥æŸ¥çœ‹å…¶æä¾›çš„æ‰€æœ‰æ–¹æ³•ï¼Œè¿™é‡Œå±•ç¤ºéƒ¨åˆ†ä½ å¯ä»¥çœ‹çœ‹ï¼š</p><pre><code class=\"language-go\">...\nfunc ToUint(i interface{}) uint\nfunc ToUint16(i interface{}) uint16\nfunc ToUint16E(i interface{}) (uint16, error)\nfunc ToUint32(i interface{}) uint32\nfunc ToUint32E(i interface{}) (uint32, error)\nfunc ToUint64(i interface{}) uint64\nfunc ToUint64E(i interface{}) (uint64, error)\nfunc ToUint8(i interface{}) uint8\nfunc ToUint8E(i interface{}) (uint8, error)\nfunc ToUintE(i interface{}) (uint, error)\n...\n</code></pre><p>å½’çº³èµ·æ¥ï¼Œcast æä¾›ç±»å‹è½¬æ¢æ–¹æ³•ï¼Œå‚æ•°å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œè½¬æ¢ä¸ºå¯¹åº”çš„ç›®æ ‡ç±»å‹ï¼Œæ¯ç§è½¬æ¢ä¼šæä¾›ä¸¤ç»„æ–¹æ³•ï¼Œä¸€ç»„æ˜¯å¸¦ error è¿”å›å€¼çš„æ–¹æ³•ï¼Œä¸€ç»„æ˜¯ä¸å¸¦ error è¿”å›å€¼çš„ã€‚å¦‚æœä½¿ç”¨ cast åº“ï¼Œæˆ‘ä»¬å°†request.goä¸­ QueryXXX æ–¹å¼çš„å®ç°ä¿®æ”¹ä¸€ä¸‹ï¼š</p><pre><code class=\"language-go\">// è·å– Int ç±»å‹çš„è¯·æ±‚å‚æ•°\nfunc (ctx *Context) QueryInt(key string, def int) (int, bool) {\n\tparams := ctx.QueryAll()\n\tif vals, ok := params[key]; ok {\n\t\tif len(vals) &gt; 0 {\n\t\t\t// ä½¿ç”¨ cast åº“å°† string è½¬æ¢ä¸º Int\n\t\t\treturn cast.ToInt(vals[0]), true\n\t\t}\n\t}\n\treturn def, false\n}\n</code></pre><p>QueryAllè¿”å›ä¸€ä¸ªmapç»“æ„ï¼Œæ ¹æ®keyæŸ¥æ‰¾å‡ºå¯¹åº”çš„å‚æ•°å€¼ï¼Œå¹¶ä¸”é€šè¿‡caståº“å°†å¯¹åº”çš„å‚æ•°å€¼è½¬åŒ–æˆç›®æ ‡æ•°æ®ç»“æ„ã€‚</p><p>Query çš„å‚æ•°è¯·æ±‚æ–¹æ³•å°±å®ç°å®Œæˆäº†ã€‚<strong>Form è¡¨å•ç›¸å…³çš„è¯·æ±‚æ–¹æ³•æ˜¯ä» HTTP Body ä¸­è·å–å‚æ•°ï¼ŒåŒ Query æ–¹æ³•ç›¸ç±»ä¼¼ï¼Œæˆ‘ä»¬å°±ä¸å†é‡å¤</strong>ï¼Œç®€å•è¯´ä¸‹æ€è·¯ï¼šå¯ä»¥ä» http.Request ä¸­è·å–åˆ° Form çš„è¯·æ±‚å‚æ•°ï¼Œç„¶åå†ç”¨ cast åº“è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><h3>Param è¯·æ±‚æ–¹æ³•å®ç°</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®ç° Param ç›¸å…³çš„è¯·æ±‚æ–¹æ³•ã€‚</p><p>Param çš„è¯·æ±‚æ–¹æ³•æ˜¯ï¼šé€šè¿‡è·¯ç”±è§£æè¯·æ±‚åœ°å€ï¼ŒæŠ½å–è¯·æ±‚åœ°å€ä¸­åŒ…å«é€šé…ç¬¦çš„æ®µã€‚æ¯”å¦‚è·¯ç”±è§„åˆ™ä¸º /subject/:idï¼ŒçœŸå®è¯·æ±‚ URI ä¸º /subject/1ï¼Œé‚£ä¹ˆè·å– key ä¸º id çš„ Param å€¼å°±ä¸º 1ã€‚</p><p>æ€ä¹ˆå®ç°æˆ‘ä»¬å¾—å›é¡¾ç¬¬ä¸‰èŠ‚è¯¾è®²çš„è·¯ç”±ï¼Œç”¨ trie æ ‘å®ç°äº†è·¯ç”±è§„åˆ™ã€‚å½“è¯·æ±‚è¿›å…¥çš„æ—¶å€™ï¼Œå°†è¯·æ±‚çš„ URI åœ°å€æ ¹æ®åˆ†éš”ç¬¦åˆ†æˆä¸åŒçš„æ®µï¼Œç”¨è¿™ä¸ªæ®µå»åŒ¹é… trie æ ‘ã€‚åªæœ‰å½“æ¯ä¸ªæ®µéƒ½åŒ¹é… trie æ ‘ä¸­æŸä¸ªè·¯å¾„çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰å°†è·¯å¾„ç»ˆæ­¢èŠ‚ç‚¹é‡Œçš„ Handlers ï¼Œä½œä¸ºè¿™ä¸ªè¯·æ±‚çš„æœ€ç»ˆå¤„ç†å‡½æ•°ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/68/98/6837822864392bbb5e7345518448b098.jpg?wh=1920x1080\" alt=\"\"></p><p>è€Œåœ¨è¿™ä¸ªåŒ¹é…è·¯å¾„ä¸­ï¼Œæœ‰çš„èŠ‚ç‚¹æ˜¯æ ¹æ®é€šé…ç¬¦è¿›è¡ŒåŒ¹é…çš„ï¼Œè¿™äº›èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬è¦æŸ¥æ‰¾çš„ Param å‚æ•°ã€‚</p><p>ç°åœ¨å°±è¦è·å–è·¯ç”±è§£æè¿‡ç¨‹ä¸­çš„è¿™äº›é€šé…ç¬¦å‚æ•°ï¼Œ<strong>æœ€æœ´ç´ çš„æƒ³æ³•å°±æ˜¯ï¼šæŸ¥æ‰¾å‡ºè¿™ä¸ªåŒ¹é…è·¯å¾„ï¼Œç„¶åæŸ¥æ‰¾å‡ºå…¶ä¸­çš„é€šé…ç¬¦èŠ‚ç‚¹ï¼Œå†å’Œè¯·æ±‚ URI å¯¹åº”ï¼Œè·å–è¿™äº›é€šé…ç¬¦å‚æ•°</strong>ã€‚æˆ‘ä»¬çœ‹è¿™ä¸ªæƒ³æ³•å¦‚ä½•å®ç°ã€‚</p><p>ä¹‹å‰æŸ¥æ‰¾è·¯ç”±çš„æ—¶å€™ï¼ŒæŸ¥åˆ°çš„æ˜¯åŒ¹é…è·¯å¾„çš„æœ€ç»ˆèŠ‚ç‚¹ï¼Œå¦‚ä½•è¿½æº¯åˆ°æ•´ä¸ªåŒ¹é…è·¯å¾„å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘æ„é€ ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼šæ”¹é€  node èŠ‚ç‚¹ï¼Œå¢åŠ ä¸€ä¸ª parent æŒ‡é’ˆï¼ŒæŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼Œå°† trie æ ‘å˜æˆä¸€ä¸ªåŒå‘æŒ‡é’ˆã€‚æ¥ä¿®æ”¹æ¡†æ¶ç›®å½•ä¸­çš„trie.goï¼š</p><pre><code class=\"language-go\">// ä»£è¡¨èŠ‚ç‚¹\ntype node struct {\n\t...\n\tparent&nbsp; &nbsp;*node&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// çˆ¶èŠ‚ç‚¹ï¼ŒåŒå‘æŒ‡é’ˆ\n}\n</code></pre><p>åœ¨å¢åŠ è·¯ç”±è§„åˆ™ï¼ˆAddRouterï¼‰çš„æ—¶å€™ï¼Œåˆ›å»ºå­èŠ‚ç‚¹ä¹Ÿè¦åŒæ—¶ä¿®æ”¹è¿™ä¸ª parent æŒ‡é’ˆï¼Œç»§ç»­å†™ï¼š</p><pre><code class=\"language-go\">func (tree *Tree) AddRouter(uri string, handlers []ControllerHandler) error {\n\t...\n\t// å¯¹æ¯ä¸ª segment\n\tfor index, segment := range segments {\n\n\t\t...\n\t\tif objNode == nil {\n\t\t\t// åˆ›å»ºä¸€ä¸ªå½“å‰ node çš„èŠ‚ç‚¹\n\t\t\tcnode := newNode()\n\t\t\tcnode.segment = segment\n\t\t\tif isLast {\n\t\t\t\tcnode.isLast = true\n\t\t\t\tcnode.handlers = handlers\n\t\t\t}\n\t\t\t// çˆ¶èŠ‚ç‚¹æŒ‡é’ˆä¿®æ”¹\n\t\t\tcnode.parent = n\n\t\t\tn.childs = append(n.childs, cnode)\n\t\t\tobjNode = cnode\n\t\t}\n\n\t\tn = objNode\n\t}\n\n\treturn nil\n}\n</code></pre><p>è¿™æ ·ï¼ŒåŒå‘é“¾è¡¨å°±ä¿®æ”¹å®Œäº†ã€‚æ¥ç€å°±æ ¹æ®æœ€ç»ˆåŒ¹é…çš„èŠ‚ç‚¹å’Œè¯·æ±‚ URIï¼ŒæŸ¥æ‰¾å‡ºæ•´ä¸ªåŒ¹é…é“¾è·¯ä¸­çš„é€šé…ç¬¦èŠ‚ç‚¹å’Œå¯¹åº” URI ä¸­çš„åˆ†æ®µï¼Œè¿˜æ˜¯åœ¨trie.goé‡Œç»§ç»­å†™ï¼š</p><pre><code class=\"language-go\">// å°† uri è§£æä¸º params\nfunc (n *node) parseParamsFromEndNode(uri string) map[string]string {\n\tret := map[string]string{}\n\tsegments := strings.Split(uri, \"/\")\n\tcnt := len(segments)\n\tcur := n\n\tfor i := cnt - 1; i &gt;= 0; i-- {\n\t\tif cur.segment == \"\" {\n\t\t\tbreak\n\t\t}\n\t\t// å¦‚æœæ˜¯é€šé…ç¬¦èŠ‚ç‚¹\n\t\tif isWildSegment(cur.segment) {\n\t\t\t// è®¾ç½® params\n\t\t\tret[cur.segment[1:]] = segments[i]\n\t\t}\n\t\tcur = cur.parent\n\t}\n\treturn ret\n}\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œä¸ºäº†è®© context ä¸­æœ‰ map ç»“æ„çš„è·¯ç”±å‚æ•°ï¼Œæˆ‘ä»¬å°†è§£æå‡ºæ¥çš„ params å­˜å‚¨åˆ° context ç»“æ„ä¸­ã€‚è¿™é‡Œä¿®æ”¹æ¡†æ¶ç›®å½•ä¸­çš„core.goæ–‡ä»¶ï¼š</p><pre><code class=\"language-go\">// æ‰€æœ‰è¯·æ±‚éƒ½è¿›å…¥è¿™ä¸ªå‡½æ•°, è¿™ä¸ªå‡½æ•°è´Ÿè´£è·¯ç”±åˆ†å‘\nfunc (c *Core) ServeHTTP(response http.ResponseWriter, request *http.Request) {\n\n\t// å°è£…è‡ªå®šä¹‰ context\n\tctx := NewContext(request, response)\n\n\t// å¯»æ‰¾è·¯ç”±\n\tnode := c.FindRouteNodeByRequest(request)\n\t...\n\n\t// è®¾ç½®è·¯ç”±å‚æ•°\n\tparams := node.parseParamsFromEndNode(request.URL.Path)\n\tctx.SetParams(params)\n\n\t...\n}\n</code></pre><p>æœ€åï¼Œå›åˆ°æ¡†æ¶ç›®å½•çš„request.goï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ cast åº“æ¥å°†è¿™ä¸ª Param ç³»åˆ—æ–¹æ³•å®Œæˆï¼š</p><pre><code class=\"language-go\">// è·å–è·¯ç”±å‚æ•°\nfunc (ctx *Context) Param(key string) interface{} {\n\tif ctx.params != nil {\n\t\tif val, ok := ctx.params[key]; ok {\n\t\t\treturn val\n\t\t}\n\t}\n\treturn nil\n}\n\n// è·¯ç”±åŒ¹é…ä¸­å¸¦çš„å‚æ•°\n// å½¢å¦‚ /book/:id\nfunc (ctx *Context) ParamInt(key string, def int) (int, bool) {\n\tif val := ctx.Param(key); val != nil {\n\t\t// é€šè¿‡ cast è¿›è¡Œç±»å‹è½¬æ¢\n\t\treturn cast.ToInt(val), true\n\t}\n\treturn def, false\n}\n</code></pre><h3>Bind è¯·æ±‚æ–¹æ³•å®ç°</h3><p>åˆ°è¿™é‡Œï¼ŒParamXXXç³»åˆ—å‡½æ•°å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ BindXXX ç³»åˆ—å‡½æ•°ï¼Œæ¯”å¦‚ BindJsonã€‚å®ƒçš„å®ç°åªéœ€è¦ç®€å•2æ­¥ï¼šè¯»å– Body ä¸­çš„æ–‡æœ¬ã€è§£æ body æ–‡æœ¬åˆ°ç»“æ„ä½“ã€‚æ‰€ä»¥ä¿®æ”¹response.goä¸­çš„å‡½æ•°ï¼š</p><pre><code class=\"language-go\">// å°† body æ–‡æœ¬è§£æåˆ° obj ç»“æ„ä½“ä¸­\nfunc (ctx *Context) BindJson(obj interface{}) error {\n\tif ctx.request != nil {\n\t\t// è¯»å–æ–‡æœ¬\n\t\tbody, err := ioutil.ReadAll(ctx.request.Body)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\t// é‡æ–°å¡«å…… request.Bodyï¼Œä¸ºåç»­çš„é€»è¾‘äºŒæ¬¡è¯»å–åšå‡†å¤‡\n\t\tctx.request.Body = ioutil.NopCloser(bytes.NewBuffer(body))\n\n\t\t// è§£æåˆ° obj ç»“æ„ä½“ä¸­\n\t\terr = json.Unmarshal(body, obj)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t} else {\n\t\treturn errors.New(\"ctx.request empty\")\n\t}\n\treturn nil\n}\n</code></pre><p>è¯»å– Body ä¸­çš„æ–‡æœ¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ ioutil.ReadAll æ–¹æ³•ï¼Œè§£æ Body æ–‡æœ¬åˆ°ç»“æ„ä½“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ json.Unmarshal æ–¹æ³•ã€‚</p><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<strong>request.Body çš„è¯»å–æ˜¯ä¸€æ¬¡æ€§çš„</strong>ï¼Œè¯»å–ä¸€æ¬¡ä¹‹åï¼Œä¸‹ä¸ªé€»è¾‘å†å» request.Body ä¸­æ˜¯è¯»å–ä¸åˆ°æ•°æ®å†…å®¹çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¯»å–å®Œ request.Body ä¹‹åï¼Œè¿˜è¦å†å¤åˆ¶ä¸€ä»½ Body å†…å®¹ï¼Œå¡«å……åˆ° request.Body é‡Œã€‚</p><h2>è¿”å›ç›¸å…³æ¥å£å®ç°</h2><p>è¿”å›æ¥å£ä¸­çš„ JSONã€XMLã€TEXT çš„è¾“å‡ºæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°†è¾“å‡ºæ•°æ®ç»“æ„è¿›è¡Œåºåˆ—åŒ–å°±è¡Œï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹è®²æ¯”è¾ƒå¤æ‚çš„ä¸¤ç§å®ç° JSONP è¾“å‡ºå’Œ HTML è¾“å‡ºã€‚</p><h3>JSONP è¾“å‡ºæ–¹æ³•å®ç°</h3><p>JSONP æ˜¯ä¸€ç§æˆ‘ä»¬å¸¸ç”¨çš„è§£å†³è·¨åŸŸèµ„æºå…±äº«çš„æ–¹æ³•ï¼Œç®€è¦ä»‹ç»ä¸‹è¿™ä¸ªæ–¹æ³•çš„åŸç†ã€‚</p><p>åœ¨ JavaScript ä¸­ä½¿ç”¨ HTTP è¯·æ±‚ï¼ˆAjaxï¼‰ä¼šå—åˆ°åŒæºç­–ç•¥çš„é™åˆ¶ã€‚æ¯”å¦‚è¯´ A ç½‘ç«™çš„é¡µé¢ä¸èƒ½åœ¨ JavaScript ä¸­è·¨åŸŸè®¿é—® B ç½‘ç«™çš„èµ„æºã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›èƒ½è·¨åŸŸè®¿é—®æ€ä¹ˆåŠï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ HTML ä¸­æ ‡ç­¾&lt;script&gt;ä¸­çš„è¯·æ±‚æ˜¯ä¸å—åŒæºç­–ç•¥å½±å“çš„ï¼Œ<strong>é‚£å¦‚æœèƒ½å°†Bç½‘ç«™çš„èµ„æºæ•°æ®ï¼Œé€šè¿‡scriptæ ‡ç­¾è¿”å›æ¥ï¼Œæ˜¯ä¸æ˜¯å°±ç›´æ¥è§£å†³äº†è·¨åŸŸé—®é¢˜</strong>ï¼Ÿç¡®å®ï¼ŒJSONPå°±æ˜¯è¿™ä¹ˆè®¾è®¡çš„ï¼Œé€šè¿‡scriptæ ‡ç­¾çš„æºåœ°å€ï¼Œè¿”å›æ•°æ®èµ„æº+ JavaScriptä»£ç ã€‚</p><p>æ¯”å¦‚ A ç½‘ç«™çš„ç½‘é¡µå¦‚ä¸‹ï¼Œå®ƒå¸Œæœ›ä» B ç½‘ç«™ä¸­è·å–æ•°æ®ï¼Œå¡«å……è¿› id ä¸º\"context\"çš„ div æ ‡ç­¾ä¸­ã€‚</p><pre><code class=\"language-xml\">&lt;html&gt;\n  &lt;body&gt;\n    &lt;div id=\"context\"&gt;&lt;/div&gt;\n  &lt;/body&gt;\n&lt;/html&gt;\n\n&lt;script&gt;\n  function callfun(data) {\n     document.getElementById('context').innerHTML = data;\n  }\n&lt;/script&gt;\n\n&lt;script src=\"http://B.com/jsonp?callback=callfun\"&gt;&lt;/script&gt;\n</code></pre><p>ä½¿ç”¨ ajax è¯·æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯åšä¸åˆ°è¿™ä¸€ç‚¹çš„ï¼Œå› ä¸ºåŒæºç­–ç•¥é™åˆ¶äº†ç½‘é¡µå’Œæ•°æ®å¿…é¡»åœ¨åŒä¸€ä¸ªæºä¸‹ã€‚ä½†æ˜¯å¦‚æœ B ç½‘ç«™çš„æ¥å£æ”¯æŒäº† JSONPï¼Œå®ƒèƒ½æ ¹æ®è¯·æ±‚å‚æ•°è¿”å›ä¸€æ®µ JavaScript ä»£ç ï¼Œç±»ä¼¼ï¼š</p><pre><code class=\"language-plain\">callfunc({\"id\":1, \"name\": jianfengye})\n</code></pre><p>è¿™æ—¶ A ç½‘ç«™çš„ç½‘é¡µï¼Œå°±èƒ½ç›´æ¥è°ƒç”¨ callfunc æ–¹æ³•ï¼Œå¹¶ä¸”è·å–åˆ° B ç½‘ç«™è¿”å›çš„æ•°æ®ã€‚</p><p>äº†è§£äº† JSONP çš„åŸç†ï¼Œæˆ‘ä»¬å›åˆ°æœåŠ¡ç«¯å®ç° JSONP çš„æ–¹æ³•ä¸­ã€‚è¿™ä¸ªæ–¹æ³•è¦åšçš„äº‹æƒ…å°±æ˜¯ï¼š<strong>è·å–è¯·æ±‚ä¸­çš„å‚æ•°ä½œä¸ºå‡½æ•°åï¼Œè·å–è¦è¿”å›çš„æ•°æ® JSON ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œå°†å‡½æ•°å+å‡½æ•°å‚æ•°ä½œä¸ºè¿”å›æ–‡æœ¬</strong>ã€‚</p><p>æˆ‘ä»¬åœ¨response.goä¸­è¡¥å……Jsonpæ–¹æ³•ã€‚</p><pre><code class=\"language-go\">// Jsonp è¾“å‡º\nfunc (ctx *Context) Jsonp(obj interface{}) IResponse {\n\t// è·å–è¯·æ±‚å‚æ•° callback\n\tcallbackFunc, _ := ctx.QueryString(\"callback\", \"callback_function\")\n\tctx.SetHeader(\"Content-Type\", \"application/javascript\")\n\t// è¾“å‡ºåˆ°å‰ç«¯é¡µé¢çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸‹è¿›è¡Œå­—ç¬¦è¿‡æ»¤ï¼Œå¦åˆ™æœ‰å¯èƒ½é€ æˆ XSS æ”»å‡»\n\tcallback := template.JSEscapeString(callbackFunc)\n\n\t// è¾“å‡ºå‡½æ•°å\n\t_, err := ctx.responseWriter.Write([]byte(callback))\n\tif err != nil {\n\t\treturn ctx\n\t}\n\t// è¾“å‡ºå·¦æ‹¬å·\n\t_, err = ctx.responseWriter.Write([]byte(\"(\"))\n\tif err != nil {\n\t\treturn ctx\n\t}\n\t// æ•°æ®å‡½æ•°å‚æ•°\n\tret, err := json.Marshal(obj)\n\tif err != nil {\n\t\treturn ctx\n\t}\n\t_, err = ctx.responseWriter.Write(ret)\n\tif err != nil {\n\t\treturn ctx\n\t}\n\t// è¾“å‡ºå³æ‹¬å·\n\t_, err = ctx.responseWriter.Write([]byte(\")\"))\n\tif err != nil {\n\t\treturn ctx\n\t}\n\treturn ctx\n}\n</code></pre><h3>HTML è¾“å‡ºæ–¹æ³•å®ç°</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸‹ HTML è¾“å‡ºã€‚</p><p>HTML å‡½æ•°è¾“å‡ºçš„å°±æ˜¯ä¸€ä¸ªçº¯ HTML é¡µé¢ã€‚ç°åœ¨çš„ HTML é¡µé¢ï¼ŒåŸºæœ¬éƒ½æ˜¯åŠ¨æ€é¡µé¢ï¼Œä¹Ÿå°±æ˜¯è¯´é¡µé¢åŸºæœ¬å†…å®¹éƒ½æ˜¯ä¸€æ ·ï¼Œä½†æ˜¯æ ¹æ®ä¸åŒè¯·æ±‚ã€ä¸åŒé€»è¾‘ï¼Œé¡µé¢ä¸­çš„æ•°æ®éƒ¨åˆ†æ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨è¾“å‡º HTML é¡µé¢å†…å®¹çš„æ—¶å€™ï¼Œå¸¸ç”¨â€œæ¨¡ç‰ˆ+æ•°æ®â€çš„æ–¹å¼ã€‚</p><p>æ¨¡ç‰ˆä¸­å­˜æ”¾çš„æ˜¯é¡µé¢åŸºæœ¬å†…å®¹ï¼ŒåŒ…æ‹¬å¸ƒå±€ä¿¡æ¯ï¼ˆCSSï¼‰ã€é€šç”¨è„šæœ¬ï¼ˆJavaScriptï¼‰ã€é¡µé¢æ•´ä½“ç»“æ„ï¼ˆHTMLï¼‰ã€‚ä½†æ˜¯é¡µé¢ç»“æ„ä¸­ï¼ŒæŸä¸ªæ ‡ç­¾çš„å…·ä½“å†…å®¹ã€å…·ä½“æ•°å€¼ï¼Œå°±è¡¨ç¤ºæˆæ•°æ®ï¼Œåœ¨æ¨¡ç‰ˆä¸­ä¿ç•™æ•°æ®çš„ä½ç½®ï¼Œåœ¨æœ€ç»ˆæ¸²æŸ“ HTML å†…å®¹çš„æ—¶å€™ï¼ŒæŠŠæ•°æ®å¡«å……è¿›å…¥æ¨¡ç‰ˆå°±è¡Œäº†ã€‚</p><p>åœ¨ Golang ä¸­ï¼Œè¿™ç§â€œæ¨¡ç‰ˆ+æ•°æ®â€çš„æ–‡æœ¬æ¸²æŸ“æ–¹å¼æ˜¯æœ‰ä¸€ä¸ªå®˜æ–¹åº“æ¥å®ç°çš„ <a href=\"https://golang.org/pkg/html/template/\">html/template</a> ï¼Œå®ƒçš„æ¨¡ç‰ˆä½¿ç”¨{{.XX}} ä½œä¸ºæ•°æ®çš„å ä½ç¬¦ï¼Œè¡¨ç¤ºä¼ å…¥çš„æ•°æ®ç»“æ„çš„æŸä¸ªå­—æ®µï¼š</p><pre><code class=\"language-go\">&lt;h1&gt;{{.PageTitle}}&lt;/h1&gt;\n&lt;ul&gt;\n    {{range .Todos}}\n        {{if .Done}}\n            &lt;li class=\"done\"&gt;{{.Title}}&lt;/li&gt;\n        {{else}}\n            &lt;li&gt;{{.Title}}&lt;/li&gt;\n        {{end}}\n    {{end}}\n&lt;/ul&gt;\n</code></pre><p>ä¼ å…¥çš„æ•°æ®ç»“æ„ä¸ºï¼š</p><pre><code class=\"language-go\">data := TodoPageData{\n    PageTitle: \"My TODO list\",\n    Todos: []Todo{\n        {Title: \"Task 1\", Done: false},\n        {Title: \"Task 2\", Done: true},\n        {Title: \"Task 3\", Done: true},\n    },\n}\n</code></pre><p>æ‰€ä»¥å…·ä½“çš„æ¸²æŸ“å¯ä»¥åˆ†æˆä¸¤æ­¥ï¼š<strong>å…ˆæ ¹æ®æ¨¡ç‰ˆåˆ›é€ å‡º template ç»“æ„ï¼›å†ä½¿ç”¨ template.Execute å°†ä¼ å…¥æ•°æ®å’Œæ¨¡ç‰ˆç»“åˆ</strong>ã€‚</p><p>æˆ‘ä»¬çš„ HTML å‡½æ•°å¯ä»¥ä½¿ç”¨ html/templateï¼Œä¿®æ”¹æ¡†æ¶ç›®å½•response.goä¸­çš„Htmlæ–¹æ³•ï¼š</p><pre><code class=\"language-go\">// html è¾“å‡º\nfunc (ctx *Context) Html(file string, obj interface{}) IResponse {\n\t// è¯»å–æ¨¡ç‰ˆæ–‡ä»¶ï¼Œåˆ›å»º template å®ä¾‹\n\tt, err := template.New(\"output\").ParseFiles(file)\n\tif err != nil {\n\t\treturn ctx\n\t}\n\t// æ‰§è¡Œ Execute æ–¹æ³•å°† obj å’Œæ¨¡ç‰ˆè¿›è¡Œç»“åˆ\n\tif err := t.Execute(ctx.responseWriter, obj); err != nil {\n\t\treturn ctx\n\t}\n\n\tctx.SetHeader(\"Content-Type\", \"application/html\")\n\treturn ctx\n}\n\n</code></pre><p>å‚æ•°ä¸ºæ¨¡ç‰ˆæ–‡ä»¶å’Œè¾“å‡ºå¯¹è±¡ï¼Œå…ˆä½¿ç”¨ ParseFiles æ¥è¯»å–æ¨¡ç‰ˆæ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ª template æ•°æ®ç»“æ„ï¼Œç„¶åä½¿ç”¨ Execute æ–¹æ³•ï¼Œå°†æ•°æ®å¯¹è±¡å’Œæ¨¡ç‰ˆè¿›è¡Œç»“åˆï¼Œå¹¶ä¸”è¾“å‡ºåˆ° responseWriter ä¸­ã€‚</p><p>è¿™èŠ‚è¯¾çš„ä»£ç ç»“æ„æ”¾åœ¨è¿™é‡Œäº†ï¼Œå®Œæ•´çš„ä»£ç åœ¨GitHubä¸Šçš„<a href=\"https://github.com/gohade/coredemo/tree/geekbang/05\">geekbang/05</a>åˆ†æ”¯ä¸Šã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/f3/37/f352fyyb3443eeed2ce318859638bb37.png?wh=746x1398\" alt=\"\"></p><h2>å°ç»“</h2><p>æˆ‘ä»¬è¿™èŠ‚è¯¾åœ¨ context è¿™ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œå°è£…å’Œå®ç°â€œè¯»å–è¯·æ±‚æ•°æ®â€å’Œâ€œå°è£…è¿”å›æ•°æ®â€çš„æ–¹æ³•ã€‚é¦–å…ˆç³»ç»Ÿæ€è€ƒè¿™ä¸¤ä¸ªéœ€æ±‚åŠŸèƒ½çš„å°è£…ï¼›å†è®¾è®¡IRequestå’ŒIResponseä¸¤ä¸ªæ¥å£ï¼Œå®šä¹‰äº†å¯¹åº”çš„æ–¹æ³•ï¼Œå¹¶ä¸”è®©contextå®ç°è¿™ä¸¤ä¸ªæ¥å£ï¼›æœ€åï¼Œæˆ‘ä»¬å¯¹è¿™ä¸¤ä¸ªæ¥å£çš„æ–¹æ³•è¿›è¡Œäº†å…·ä½“å®ç°ã€‚</p><p>ä½ ç°åœ¨æ˜¯ä¸æ˜¯è®¤è¯†åˆ°äº†ï¼Œä¸ºä»€ä¹ˆæˆ‘åœ¨å¼€å¤´ä¼šè¯´ï¼Œå‡½æ•°å°è£…å¹¶ä¸æ˜¯ä¸€ä»¶å¾ˆç®€å•ã€å¾ˆéšæ„çš„äº‹æƒ…ï¼Œå¦‚ä½•å°è£…å‡ºæ˜“ç”¨ã€å¯è¯»æ€§é«˜çš„å‡½æ•°æ˜¯éœ€è¦æˆ‘ä»¬ç²¾å¿ƒè€ƒé‡çš„ã€‚</p><p>å¦‚æœè¯´ä¸€å®šè¦è®°ä½ä¸€å¥è¯ï¼Œå¸Œæœ›ä½ èƒ½è®°ä½ï¼Œåœ¨å®ç°â€œè¯»å–è¯·æ±‚æ•°æ®â€å’Œâ€œå°è£…è¿”å›æ•°æ®â€çš„è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨â€œ<strong>å…ˆç³»ç»Ÿè®¾è®¡ï¼Œå†å®šä¹‰æ¥å£ï¼Œæœ€åå…·ä½“å®ç°</strong>â€çš„ç³»ç»Ÿæ€è€ƒæ–¹æ³•ã€‚å¦‚æœä½ ä¸€æ¥åˆ°è¦å¼€å‘æŸäº›åŠŸèƒ½æ¨¡å—éœ€æ±‚ï¼Œä¸å…ˆæƒ³æ¸…æ¥šå°±ç«‹åˆ»ä¸Šæ‰‹ï¼Œæœ€ç»ˆå®ç°çš„ä»£ç ï¼Œç»†èŠ‚ä¼šéå¸¸æ··ä¹±ï¼Œå¤ç”¨æ€§æå·®ã€‚</p><p>è¯·è®°ä½ï¼Œè®¾è®¡æ°¸è¿œä¼˜äºå®ç°ï¼</p><h2>æ€è€ƒé¢˜</h2><p>ä½œä¸ºä¸€ä¸ªWebæ¡†æ¶ï¼Œå®‰å…¨æ€§æ˜¯å¾ˆå…³é”®çš„ä¸€ä¸ªç¯èŠ‚ï¼Œæˆ‘ä»¬åœ¨å®ç°JSONPæ–¹æ³•çš„æ—¶å€™ï¼Œæœ‰è¿™ä¸€è¡Œä»£ç ï¼š</p><pre><code class=\"language-go\">//è¾“å‡ºåˆ°å‰ç«¯é¡µé¢çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸‹è¿›è¡Œå­—ç¬¦è¿‡æ»¤ï¼Œå¦åˆ™æœ‰å¯èƒ½é€ æˆ XSS æ”»å‡»\ncallback := template.JSEscapeString(callbackFunc)\n</code></pre><p>è¯·ä½ æ€è€ƒä¸‹ï¼Œå¦‚æœæˆ‘ç›´æ¥å°†callbackFuncè¾“å‡ºåˆ°é¡µé¢ä¸Šï¼Œä¼šæœ‰ä»€ä¹ˆä¸å®‰å…¨çš„é—®é¢˜å—ï¼Ÿä»€ä¹ˆæ˜¯XSSæ”»å‡»ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€è¯·ä»–ä¸€èµ·å­¦ä¹ ã€‚ä¸‹èŠ‚è¯¾è§ï½</p>","neighbors":{"left":{"article_title":"04ï½œä¸­é—´ä»¶ï¼šå¦‚ä½•æé«˜æ¡†æ¶çš„å¯æ‹“å±•æ€§ï¼Ÿ","id":420006},"right":{"article_title":"06ï½œé‡å¯ï¼šå¦‚ä½•è¿›è¡Œä¼˜é›…å…³é—­ï¼Ÿ","id":421354}},"comments":[{"had_liked":false,"id":324460,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1638442496,"is_pvip":false,"replies":[{"id":"118676","content":"ç¡®å®æ˜¯ä¸ªå¥½åŠæ³•ï¼Œç›´æ¥åšä¸€ä¸‹å¼ºåˆ¶è½¬æ¢èƒ½å°†é”™è¯¯æå‰æš´éœ²<br>æ„Ÿè°¢","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1069186","ctime":1639618606,"ip_address":"","comment_id":324460,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35998180864","product_id":100090601,"comment_content":"ä¸çŸ¥é“å„ä½çœ‹githubæœ‰æ²¡æœ‰çœ‹åˆ° FormInt å’Œ FormString æˆ‘æ²¡æœ‰æ‰¾åˆ°å¯èƒ½æ˜¯ç²—å¿ƒï¼Œå»ºè®®å„ä½åœ¨å®ç°çš„æ—¶å€™å¯ä»¥åœ¨å¼€å¤´å†™ä¸Šè¿™ä¹ˆå‡ å¥ä»£ç <br><br>var _ IRequest = new(Context)<br>var _ IResponse = new(Context)<br>var _ context.Context = new(Context)<br>å¦‚æœå½“å‰contextæ²¡æœ‰å®ç°å®Œ IRequest å’Œ IResponse ä¼šæŠ¥é”™å¹¶ä¸”ä½ èƒ½çœ‹åˆ°æ˜¯å“ªäº›æ¥å£æœªå®ç°ã€‚<br><br>è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹å°±æ˜¯ Headers() map[string]string<br>è¿™é‡Œæ¥å£å®šä¹‰çš„æ˜¯ è¿™æ · ä½†æ˜¯è¯•ä¸‹ä½ çš„æ—¶å€™æ˜¯è¿™æ · Headers() map[string][]string","like_count":9,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539129,"discussion_content":"ç¡®å®æ˜¯ä¸ªå¥½åŠæ³•ï¼Œç›´æ¥åšä¸€ä¸‹å¼ºåˆ¶è½¬æ¢èƒ½å°†é”™è¯¯æå‰æš´éœ²\næ„Ÿè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639618606,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313102,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1632280331,"is_pvip":true,"replies":[{"id":"117998","content":"ç–‘é—®ï¼š<br><br>1. JSONPçš„å“åº”ä¹Ÿæ˜¯åœ¨æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥ç”¨templateï¼Ÿ<br>å½“ç„¶å¯ä»¥çš„ï¼Œæ‹¼æ¥å­—ç¬¦ä¸²æœ‰å¤šç§æ–¹å¼ï¼Œtemplateä¹Ÿæ˜¯å¯ä»¥ã€‚<br><br>2. å¯¹äºå„ç§è¯·æ±‚å’Œå“åº”æ ¼å¼çš„æ”¯æŒï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥å†™æˆä¸­é—´ä»¶çš„å½¢å¼ï¼Œè®©APIæ›´ç²¾ç®€ï¼Ÿ<br>å¯ä»¥çš„ï¼Œä¿®æ”¹å“åº”æ ¼å¼ä¸»è¦è¦å…ˆä¿®æ”¹ä¸‹contextä¸­çš„responseWriterï¼Œè®©è¾“å‡ºå…ˆè¿›å…¥åˆ°æˆ‘ä»¬å®šä¹‰çš„writerä¸­ï¼Œç„¶åä¿®æ”¹åå†è¾“å‡ºåˆ°å‰ç«¯ã€‚è¿™æ ·åšå¯è¡Œã€‚<br>ä¸è¿‡æ›´å¤šçš„åšæ³•æ˜¯å°è£…ä¸€ä¸ªå…¬å…±æ–¹æ³•ï¼Œæ‰€æœ‰apiåœ°æ–¹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚<br><br>3. é‡å¤è¯»å–bodyçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿæˆ‘èƒ½æƒ³åˆ°çš„æ˜¯æŸäº›è®¿é—®æ§åˆ¶çš„ä¸­é—´ä»¶å¯èƒ½éœ€è¦äº‹å…ˆæ£€æŸ¥bodyçš„å†…å®¹ã€‚è¿™æ ·æ˜¯ä¸æ˜¯å°±æ²¡æ³•åšæµå¼å¤„ç†ï¼ˆå› ä¸ºè¦æŠŠè¯·æ±‚bodyè¯»å®Œæ‰èƒ½åšä¸‹ä¸€æ­¥çš„å¤„ç†ï¼‰ï¼Ÿæ¯”å¦‚ä¸€è¾¹è¯»å–è¯·æ±‚bodyä¸€è¾¹å†™å…¥å“åº”bodyã€‚<br><br>è¿™ä¸ªåœºæ™¯å¾ˆå¤šçš„ï¼Œè¦æ‰“ä¸€ä¸ªè¾“å…¥è¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—åˆ°æ—¥å¿—ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæˆ–è€…è¦å®ç°ä¸€ä¸ªå›æ”¾åŠŸèƒ½ï¼Œéƒ½æœ‰å¯èƒ½è¦è¯»å–è¯·æ±‚body.","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1069186","ctime":1638843447,"ip_address":"","comment_id":313102,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10222214923","product_id":100090601,"comment_content":"è½¬ä¹‰æ˜¯ä¸ºäº†é˜²æ­¢callbackåç§°åŒ…å«ä»»æ„jsä»£ç ã€‚è™½ç„¶è¦è¾¾æˆXSSæœ‰å„ç§å‰ç½®æ¡ä»¶ï¼Œé˜²å¾¡XSSä¹Ÿè¦åˆ†å„ç§æƒ…å†µï¼Œæ²¡æœ‰å®Œç¾çš„æ–¹æ³•ï¼Œä½†è½¬ä¹‰æ€»æ¯”ä¸è½¬ä¹‰è¦å¼ºã€‚<br><br>ç–‘é—®ï¼š<br><br>1. JSONPçš„å“åº”ä¹Ÿæ˜¯åœ¨æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥ç”¨templateï¼Ÿ<br><br>2. å¯¹äºå„ç§è¯·æ±‚å’Œå“åº”æ ¼å¼çš„æ”¯æŒï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥å†™æˆä¸­é—´ä»¶çš„å½¢å¼ï¼Œè®©APIæ›´ç²¾ç®€ï¼Ÿ<br><br>3. é‡å¤è¯»å–bodyçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿæˆ‘èƒ½æƒ³åˆ°çš„æ˜¯æŸäº›è®¿é—®æ§åˆ¶çš„ä¸­é—´ä»¶å¯èƒ½éœ€è¦äº‹å…ˆæ£€æŸ¥bodyçš„å†…å®¹ã€‚è¿™æ ·æ˜¯ä¸æ˜¯å°±æ²¡æ³•åšæµå¼å¤„ç†ï¼ˆå› ä¸ºè¦æŠŠè¯·æ±‚bodyè¯»å®Œæ‰èƒ½åšä¸‹ä¸€æ­¥çš„å¤„ç†ï¼‰ï¼Ÿæ¯”å¦‚ä¸€è¾¹è¯»å–è¯·æ±‚bodyä¸€è¾¹å†™å…¥å“åº”bodyã€‚","like_count":2,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536666,"discussion_content":"ç–‘é—®ï¼š\n\n1. JSONPçš„å“åº”ä¹Ÿæ˜¯åœ¨æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥ç”¨templateï¼Ÿ\nå½“ç„¶å¯ä»¥çš„ï¼Œæ‹¼æ¥å­—ç¬¦ä¸²æœ‰å¤šç§æ–¹å¼ï¼Œtemplateä¹Ÿæ˜¯å¯ä»¥ã€‚\n\n2. å¯¹äºå„ç§è¯·æ±‚å’Œå“åº”æ ¼å¼çš„æ”¯æŒï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥å†™æˆä¸­é—´ä»¶çš„å½¢å¼ï¼Œè®©APIæ›´ç²¾ç®€ï¼Ÿ\nå¯ä»¥çš„ï¼Œä¿®æ”¹å“åº”æ ¼å¼ä¸»è¦è¦å…ˆä¿®æ”¹ä¸‹contextä¸­çš„responseWriterï¼Œè®©è¾“å‡ºå…ˆè¿›å…¥åˆ°æˆ‘ä»¬å®šä¹‰çš„writerä¸­ï¼Œç„¶åä¿®æ”¹åå†è¾“å‡ºåˆ°å‰ç«¯ã€‚è¿™æ ·åšå¯è¡Œã€‚\nä¸è¿‡æ›´å¤šçš„åšæ³•æ˜¯å°è£…ä¸€ä¸ªå…¬å…±æ–¹æ³•ï¼Œæ‰€æœ‰apiåœ°æ–¹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚\n\n3. é‡å¤è¯»å–bodyçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿæˆ‘èƒ½æƒ³åˆ°çš„æ˜¯æŸäº›è®¿é—®æ§åˆ¶çš„ä¸­é—´ä»¶å¯èƒ½éœ€è¦äº‹å…ˆæ£€æŸ¥bodyçš„å†…å®¹ã€‚è¿™æ ·æ˜¯ä¸æ˜¯å°±æ²¡æ³•åšæµå¼å¤„ç†ï¼ˆå› ä¸ºè¦æŠŠè¯·æ±‚bodyè¯»å®Œæ‰èƒ½åšä¸‹ä¸€æ­¥çš„å¤„ç†ï¼‰ï¼Ÿæ¯”å¦‚ä¸€è¾¹è¯»å–è¯·æ±‚bodyä¸€è¾¹å†™å…¥å“åº”bodyã€‚\n\nè¿™ä¸ªåœºæ™¯å¾ˆå¤šçš„ï¼Œè¦æ‰“ä¸€ä¸ªè¾“å…¥è¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—åˆ°æ—¥å¿—ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæˆ–è€…è¦å®ç°ä¸€ä¸ªå›æ”¾åŠŸèƒ½ï¼Œéƒ½æœ‰å¯èƒ½è¦è¯»å–è¯·æ±‚body.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638843447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326022,"user_name":"å’¸é±¼","can_delete":false,"product_type":"c1","uid":2712078,"ip_address":"","ucode":"32C83B9B063541","user_header":"https://static001.geekbang.org/account/avatar/00/29/62/0e/af82f76f.jpg","comment_is_top":false,"comment_ctime":1639312318,"is_pvip":true,"replies":[{"id":"118645","content":"1 è¿™é‡Œå…¶å®æœ‰ä¸‰ä¸ªé€»è¾‘ï¼Œa æ˜¯å¦æœ‰è¿™ä¸ªkeyï¼Œb è¿™ä¸ªkeyæ˜¯å¦å¯ä»¥è½¬æ¢ä¸ºç›®æ ‡å¯¹è±¡ï¼Œ c å¦‚æœå¤±è´¥å’Œæ²¡æœ‰ï¼Œè¦æ€ä¹ˆå¤„ç†ã€‚ç›®å‰æ˜¯æ²¡æœ‰keyè¿”å›é»˜è®¤å€¼ï¼Œæœ‰keyä½†æ˜¯æ— æ³•è½¬æ¢è¿”å›é›¶å€¼ï¼Œä¸è¿‡æ€è€ƒäº†ä¸€ä¸‹ï¼Œè¿™é‡Œç¡®å®æ˜¯æ”¹æˆâ€œå¤±è´¥å’Œå¤„ç†â€éƒ½è¿”å›é»˜è®¤å€¼æ¯”è¾ƒå¥½ã€‚<br>2 parseParamsFromEndNode è¿™é‡Œä¼ é€’çš„æ˜¯request.URL.Pathï¼Œæ˜¯æ²¡æœ‰å¤§å†™è½¬æ¢è¿‡çš„ã€‚åº”è¯¥ä¸éœ€è¦åŠ è¿™ä¸ª","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1069186","ctime":1639585409,"ip_address":"","comment_id":326022,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5934279614","product_id":100090601,"comment_content":"æœ‰ä¸¤ç‚¹ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸å¸¦errorè¿”å›å€¼çš„castæ–¹æ³•å‘¢ï¼Œè¿™æ ·å¦‚æœè§£æå‡ºäº†é—®é¢˜ï¼Œè¿”å›çš„ä¸ä¼šæ˜¯é»˜è®¤å€¼ï¼Œè€Œä¼šæ˜¯é›¶å€¼ã€‚å¦å¤–ä¸€ç‚¹æ˜¯æˆ‘è®°å¾—å‰é¢æ³¨å†Œè·¯ç”±çš„æ—¶å€™æŠŠè·¯å¾„éƒ½å˜æˆäº†å¤§å†™æ¥ç€ï¼Œè¿™æ ·åœ¨å–è·¯å¾„å‚æ•°çš„æ—¶å€™åº”è¯¥åŠ ä¸€é“æŠŠkeyè½¬æˆå¤§å†™çš„æ­¥éª¤å§ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°å‚æ•°çš„","like_count":1,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539072,"discussion_content":"1 è¿™é‡Œå…¶å®æœ‰ä¸‰ä¸ªé€»è¾‘ï¼Œa æ˜¯å¦æœ‰è¿™ä¸ªkeyï¼Œb è¿™ä¸ªkeyæ˜¯å¦å¯ä»¥è½¬æ¢ä¸ºç›®æ ‡å¯¹è±¡ï¼Œ c å¦‚æœå¤±è´¥å’Œæ²¡æœ‰ï¼Œè¦æ€ä¹ˆå¤„ç†ã€‚ç›®å‰æ˜¯æ²¡æœ‰keyè¿”å›é»˜è®¤å€¼ï¼Œæœ‰keyä½†æ˜¯æ— æ³•è½¬æ¢è¿”å›é›¶å€¼ï¼Œä¸è¿‡æ€è€ƒäº†ä¸€ä¸‹ï¼Œè¿™é‡Œç¡®å®æ˜¯æ”¹æˆâ€œå¤±è´¥å’Œå¤„ç†â€éƒ½è¿”å›é»˜è®¤å€¼æ¯”è¾ƒå¥½ã€‚\n2 parseParamsFromEndNode è¿™é‡Œä¼ é€’çš„æ˜¯request.URL.Pathï¼Œæ˜¯æ²¡æœ‰å¤§å†™è½¬æ¢è¿‡çš„ã€‚åº”è¯¥ä¸éœ€è¦åŠ è¿™ä¸ª","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639585409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318556,"user_name":"æœ¨ç§»","can_delete":false,"product_type":"c1","uid":2774699,"ip_address":"","ucode":"F100BE8919DBF4","user_header":"https://static001.geekbang.org/account/avatar/00/2a/56/ab/6a964bbb.jpg","comment_is_top":false,"comment_ctime":1635332491,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5930299787","product_id":100090601,"comment_content":"subjectApi.Put(&quot;&#47;:id&#47;:id&quot;, SubjectUpdateController)  è¿™ç§è·¯ç”±å–å‚æ•°å°±æ²¡æ³•åŒºåˆ†äº†ï¼Œæ³¨å†Œè·¯ç”±éœ€è¦æŠŠè¿™ç§æƒ…å†µè€ƒè™‘è¿›å»å—","like_count":1,"discussions":[{"author":{"id":1107540,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e6/54/86056001.jpg","nickname":"å°é©¬ğŸ","note":"","ucode":"8CA466A4004BDB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589224,"discussion_content":"å…„å¼Ÿ restfullæœ¬æ¥å°±å¾ˆæ‰¯äº†  ä½ è¿™ã€‚ã€‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664532601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1192961,"avatar":"https://static001.geekbang.org/account/avatar/00/12/34/01/30ca98e6.jpg","nickname":"arronK","note":"","ucode":"58DC6FBF2CF0C1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572410,"discussion_content":"ç›¸å½“äºå£°æ˜ä¸¤ä¸ªåŒåå˜é‡ï¼Œç„¶åè¿˜æƒ³åœ¨åŒä¸€ä¸ªè¿ç”¨åŸŸä½¿ç”¨ã€‚è¿™ä¸çæ‰¯å˜›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652774398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357795,"user_name":"airmyä¸¶","can_delete":false,"product_type":"c1","uid":1299673,"ip_address":"å¹¿ä¸œ","ucode":"41959C9F5B4B65","user_header":"https://static001.geekbang.org/account/avatar/00/13/d4/d9/c3296187.jpg","comment_is_top":false,"comment_ctime":1663644789,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1663644789","product_id":100090601,"comment_content":"è¾“å‡ºè§£æHTMLçš„è¿™ä¸ªåœ°æ–¹ï¼št, err := template.New(â€œoutputâ€).ParseFiles(file) è¿™é‡Œæ˜¯å¦æœ‰é—®é¢˜ï¼Ÿtemplate.New éœ€è¦ä¼ å…¥çš„åº”è¯¥æ˜¯æ¨¡ç‰ˆçš„æ–‡ä»¶åç§°å§ï¼Ÿè¿™é‡Œæ˜¯å¦åº”è¯¥ä½¿ç”¨ filepath.Base(file) å»è·å–ï¼Ÿ","like_count":0},{"had_liked":false,"id":335797,"user_name":"è€å…µ","can_delete":false,"product_type":"c1","uid":1471109,"ip_address":"","ucode":"F004F8EC90E5B0","user_header":"https://static001.geekbang.org/account/avatar/00/16/72/85/c337e9a1.jpg","comment_is_top":false,"comment_ctime":1645692059,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645692059","product_id":100090601,"comment_content":"åˆ©ç”¨escape template.JSEscapeString(callbackFunc) è§£å†³XSSæ”»å‡»çš„é—®é¢˜ã€‚<br>ç–‘é—®ï¼š<br>ä½†æ˜¯æ¡†æ¶å¦‚ä½•è§£å†³CSRFæ”»å‡»çš„é—®é¢˜å‘¢ï¼Ÿæ£€æŸ¥CSRF tokenå’ŒXSRF tokenï¼Ÿ","like_count":0},{"had_liked":false,"id":330513,"user_name":"ç‰›ç‰å¯Œ","can_delete":false,"product_type":"c1","uid":1231623,"ip_address":"","ucode":"DD962676F8FAF6","user_header":"https://static001.geekbang.org/account/avatar/00/12/cb/07/482b7155.jpg","comment_is_top":false,"comment_ctime":1642003536,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642003536","product_id":100090601,"comment_content":"clientIpæ‹¼é”™äº†","like_count":0},{"had_liked":false,"id":321779,"user_name":"kfns0b11","can_delete":false,"product_type":"c1","uid":1448061,"ip_address":"","ucode":"B64C5B841A88BC","user_header":"https://static001.geekbang.org/account/avatar/00/16/18/7d/3916b1e8.jpg","comment_is_top":false,"comment_ctime":1637044293,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1637044293","product_id":100090601,"comment_content":"&gt; &#47;&#47; é‡æ–°å¡«å…… request.Bodyï¼Œä¸ºåç»­çš„é€»è¾‘äºŒæ¬¡è¯»å–åšå‡†å¤‡ <br>&gt; ctx.request.Body = ioutil.NopCloser(bytes.NewBuffer(body))<br><br>è¿™é‡Œèƒ½è¯¦ç»†è§£é‡Šä¸€ä¸‹å—ï¼Ÿctx.request.Body æœ¬èº«æ˜¯ io.ReadCloser ç±»å‹ï¼Œä½¿ç”¨ NopCloser å‡½æ•°ä¸ºåç»­çš„é€»è¾‘äºŒæ¬¡è¯»å–åšå‡†å¤‡æ˜¯ä»€ä¹ˆæ„æ€å•Šï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"å‹","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535605,"discussion_content":"æ¯æ¬¡è¯»å–å®Œrequest bodyä¹‹å é‚£ä¹ˆ ä½ å†æ¬¡è®¿é—® ctx.request.Bodyå°±æ²¡æœ‰å€¼äº†ã€‚æ‰€ä»¥æ¯æ¬¡å–å‡ºæ¥ä¹‹åå†å¡å›å»ã€‚ è‡³äºioutil.NopCloser(bytes.NewBuffer(body)) è¿™ä¸ªå°±æ˜¯ä¸ºäº†å†æ¬¡å¡å›å»è€Œå·²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638494065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313116,"user_name":"Geek_5244fa","can_delete":false,"product_type":"c1","uid":1072743,"ip_address":"","ucode":"B87A550526F74C","user_header":"https://static001.geekbang.org/account/avatar/00/10/5e/67/133d2da6.jpg","comment_is_top":false,"comment_ctime":1632285700,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1632285700","product_id":100090601,"comment_content":"ç±»ä¼¼ Jsonp è¿™äº›è¾“å‡ºæ–¹æ³•ä¸­ï¼Œéƒ½æ˜¯å¿½ç•¥é”™è¯¯ç„¶åè¿”å› Context å®ç°é“¾å¼è°ƒç”¨ï¼Œè¿™æ ·ä¸ä¼šæœ‰é—®é¢˜å—ï¼Ÿ<br><br>ä¾‹å¦‚ç”¨æˆ·æäº†ä¸ªæ²¡æ³• json åºåˆ—åŒ–çš„æ•°æ®ï¼Œè¾“å‡ºåˆ°å·¦æ‹¬å·å°±æ–­æ‰ï¼Œä¸ä¼šå¾ˆéš¾æ’æŸ¥ï¼Ÿ","like_count":0}]}