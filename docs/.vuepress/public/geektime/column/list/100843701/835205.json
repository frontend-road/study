{"id":835205,"title":"06ï½œå¹¶å‘ç­‰å¾…ï¼šå¦‚ä½•é™ä½å®æ—¶ç³»ç»Ÿçš„å“åº”å»¶æ—¶ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¾é€¸ã€‚</p><p>åœ¨ä¸ŠèŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•å€ŸåŠ©èµ„æºå¤ç”¨æ¥é™ä½Golangè¿è¡Œæ—¶çš„èµ„æºæŸè€—ï¼Œä»è€Œæå‡å•æœºååã€‚åœ¨èµ„æºå¤ç”¨çš„æŠ€å·§é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹å¼ºè°ƒäº†åç¨‹æ± è¿™ä¸€å…³é”®æŠ€å·§ã€‚</p><p>æœ‰äº†åç¨‹å¹¶å‘çš„è¿ç”¨ï¼Œè‡ªç„¶å°‘ä¸äº†å¹¶å‘ç›¸å…³çš„æŠ€æœ¯ã€‚æ‰€ä»¥åœ¨ä»Šå¤©çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬å°±æ¥èŠä¸€èŠåç¨‹<strong>å¹¶å‘ç­‰å¾…æŠ€æœ¯â€”â€”WaitGroupç±»å‹å’ŒerrgroupåŒ…</strong>ã€‚åªæœ‰ç†Ÿç»ƒåœ°æŒæ¡è¿™äº›å¹¶å‘æŠ€æœ¯ï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿåœ¨é¢å¯¹å„ç§å¹¶å‘åœºæ™¯æ—¶ï¼Œæ›´å¿«ã€æ›´å¥½åœ°è§£å†³å„ç§å¹¶å‘é—®é¢˜ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥æƒ³ä¸€ä¸ªé—®é¢˜ï¼šå€˜è‹¥æˆ‘ä»¬éœ€è¦å‘å¤šä¸ªä¸‹æ¸¸å‘èµ·å¹¶å‘è¯·æ±‚ï¼Œå¹¶ä¸”å¿…é¡»å¾—ç­‰å¾…æ‰€æœ‰è¯·æ±‚è¿”å›æ—¶ï¼Œä½ ä¼šç”¨Golangçš„å“ªä¸ªå¹¶å‘ç±»å‹æ¥å®ç°å‘¢ï¼Ÿ</p><p><img src=\"https://static001.geekbang.org/resource/image/46/63/4648cf524f607d5a56f025f83fb84863.jpg?wh=7128x3139\" alt=\"\" title=\"å›¾1 å¹¶å‘è°ƒç”¨\"></p><h2>WaitGroupç±»å‹</h2><p>å½“é¢å¯¹è¿™ç§åœºæ™¯æ—¶ï¼Œå¸¸è§„è§£å†³æ–¹æ³•æ˜¯ç”¨Golangçš„åŸºç¡€å¹¶å‘ç±»å‹WaitGroupã€‚<strong>WaitGroupçš„ä½œç”¨æ˜¯é˜»å¡ç­‰å¾…å¤šä¸ªå¹¶å‘ä»»åŠ¡æ‰§è¡Œå®Œæˆ</strong>ã€‚WaitGroupç±»å‹ä¸»è¦åŒ…å«ä¸‹é¢å‡ ä¸ªæ–¹æ³•ã€‚</p><pre><code class=\"language-go\">func (wg *WaitGroup) Add(delta int)\nfunc (wg *WaitGroup) Done()\nfunc (wg *WaitGroup) Wait()\n</code></pre><ul>\n<li>\n<p>ç¬¬ä¸€ä¸ªæ˜¯ <strong>Addæ–¹æ³•</strong>ï¼Œåœ¨ä»»åŠ¡è¿è¡Œä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨Addæ–¹æ³•ï¼Œç”¨äºè®¾ç½®éœ€è¦ç­‰å¾…å®Œæˆçš„ä»»åŠ¡æ•°ï¼ŒAddæ–¹æ³•ä¼ è¿›å»çš„æ•°å€¼ä¹‹å’Œï¼Œéœ€è¦å’Œä»»åŠ¡æ•°ç›¸ç­‰ã€‚</p>\n</li>\n<li>\n<p>ç¬¬äºŒä¸ªæ˜¯ <strong>Doneæ–¹æ³•</strong>ï¼Œæ¯ä¸ªä»»åŠ¡å®Œæˆæ—¶ï¼Œéœ€è¦è°ƒç”¨Doneæ–¹æ³•ï¼Œç”¨äºå‘ŠçŸ¥WaitGroupå¯¹è±¡å·²ç»æœ‰ä¸€ä¸ªä»»åŠ¡è¿è¡Œå®Œæˆã€‚</p>\n</li>\n<li>\n<p>ç¬¬ä¸‰ä¸ªæ˜¯ <strong>Waitæ–¹æ³•</strong>ï¼Œå½“éœ€è¦ç­‰å¾…æ‰€æœ‰å¹¶å‘ä»»åŠ¡å®Œæˆæ—¶ï¼Œè°ƒç”¨Waitæ–¹æ³•ï¼Œç”¨äºé˜»å¡ä¸»åç¨‹ã€‚</p>\n</li>\n</ul><!-- [[[read_end]]] --><p>çŸ¥é“äº†WaitGroupç±»å‹çš„APIï¼Œé‚£æˆ‘ä»¬è¯¥å¦‚ä½•ç”¨WaitGroupæ¥å®ç°å¹¶å‘è°ƒç”¨æ—¶çš„é˜»å¡ç­‰å¾…åŠŸèƒ½å‘¢ï¼Ÿ</p><p>ä¸‹é¢æˆ‘ä¸ºä½ å‡†å¤‡äº†ä¸€æ®µä»£ç ï¼Œä½ å¯ä»¥å‚è€ƒè¿™æ®µä»£ç å®ç°å¹¶å‘ç­‰å¾…åŠŸèƒ½ã€‚</p><pre><code class=\"language-go\">import (\n    \"sync\"\n)\n\nvar urls = []string{\n    \"http://www.golang.org/\",\n    \"http://www.google.com/\",\n    \"http://www.somestupidname.com/\",\n}\n\nfunc TestWaitGroup(t *testing.T) {\n    // åˆ›å»ºWaitGroupå¯¹è±¡\n    wg := sync.WaitGroup{}\n    results := make([]string, len(urls))\n    for index, url := range urls {\n        url := url\n        index := index\n        // åœ¨åˆ›å»ºåç¨‹æ‰§è¡Œä»»åŠ¡ä¹‹å‰ï¼Œè°ƒç”¨Addæ–¹æ³•\n        wg.Add(1)\n        go func() {\n            // ä»»åŠ¡å®Œæˆåï¼Œè°ƒç”¨Doneæ–¹æ³•\n            defer wg.Done()\n            // Fetch the URL.\n            resp, err := http.Get(url)\n            if err != nil {\n                return\n            }\n\n            defer resp.Body.Close()\n            body, err := io.ReadAll(resp.Body)\n            if err != nil {\n                return\n            }\n            results[index] = string(body)\n\n        }()\n    }\n    // ä¸»åç¨‹é˜»å¡ï¼Œç­‰å¾…æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆ\n    wg.Wait()\n}\n</code></pre><p>è¿™æ®µä»£ç çš„æ ¸å¿ƒæ˜¯ä¸‹é¢å‡ æ­¥ã€‚</p><ol>\n<li>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºæ–°çš„WaitGroupç±»å‹å¯¹è±¡ã€‚</p>\n</li>\n<li>\n<p>æ¥ç€ï¼Œåœ¨æ¯æ¬¡åˆ›å»ºåç¨‹ä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨Addæ–¹æ³•è®¾ç½®éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°ã€‚</p>\n</li>\n<li>\n<p>ç„¶åï¼Œåœ¨æ¯ä¸ªä»»åŠ¡è¿è¡Œå®Œæˆåè°ƒç”¨Doneæ–¹æ³•ï¼Œå‘ŠçŸ¥WaitGroupå¯¹è±¡æœ‰ä¸€ä¸ªä»»åŠ¡å·²ç»è¿è¡Œå®Œæˆã€‚</p>\n</li>\n<li>\n<p>æœ€åï¼Œåœ¨ä¸»åç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨Waitæ–¹æ³•é˜»å¡ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚</p>\n</li>\n</ol><h2>errgroupåŒ…</h2><p>è™½ç„¶ä½¿ç”¨WaitGroupç±»å‹å¯ä»¥å®ç°å¹¶å‘ç­‰å¾…åŠŸèƒ½ï¼Œä½†æ˜¯ <strong>WaitGroup ç±»å‹åœ¨é”™è¯¯å¤„ç†æ–¹é¢å­˜åœ¨ä¸€å®šçš„åŠŸèƒ½å±€é™æ€§ã€‚æ¯”å¦‚ï¼Œå½“æŸä¸ªå¹¶å‘ä»»åŠ¡äº§ç”Ÿé”™è¯¯æ—¶ï¼Œæˆ‘ä»¬éš¾ä»¥ä¾¿æ·åœ°å°†è¯¥é”™è¯¯ä¿¡æ¯ä¼ é€’è‡³ä¸»åç¨‹è¿›è¡Œå¤„ç†ï¼Œè€Œä¸”æ— æ³•æœ‰æ•ˆåœ°ä¸­æ­¢å…¶ä»–å¾…è¿è¡Œæˆ–è¿è¡Œä¸­çš„ä»»åŠ¡ã€‚</strong></p><p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å¯¹å¹¶å‘ä»»åŠ¡çš„é”™è¯¯è¿›è¡Œå¤„ç†ï¼ŒGolangä¸ºæˆ‘ä»¬æä¾›äº†æä¸ºä¾¿æ·çš„å¹¶å‘æ‰©å±•åº“ â€”â€”errgroup åŒ…ã€‚errgroupåŒ…çš„æ ¸å¿ƒæ˜¯ Group ç±»å‹ï¼ŒGroup ç±»å‹æ˜¯å¯¹WaitGroupçš„å°è£…ï¼Œåœ¨å¹¶å‘ç­‰å¾…çš„åŸºç¡€åŠŸèƒ½ä¹‹ä¸Šï¼Œå®ƒé¢å¤–æä¾›äº†ä¸€ç³»åˆ—å®ç”¨çš„æ‰©å±•åŠŸèƒ½ã€‚</p><h3>é”™è¯¯å¤„ç†ï¼šå¦‚ä½•åœ¨ä¸»åç¨‹ä¸­è·å–å¹¶å‘ä»»åŠ¡é”™è¯¯ä¿¡æ¯ï¼Ÿ</h3><p>é¦–å…ˆå’±ä»¬æ¥çœ‹çœ‹é”™è¯¯å¤„ç†åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å½“å¹¶å‘ä»»åŠ¡æ‰§è¡Œå‡ºé”™çš„æ—¶å€™ï¼Œä¸»åç¨‹èƒ½è·å–åˆ°å‡ºé”™ä¿¡æ¯å¹¶è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™å°±æ¶‰åŠåˆ°Group ç±»å‹æä¾›çš„ä¸¤ä¸ªé‡è¦æ–¹æ³•ã€‚</p><ul>\n<li>\n<p>é¦–å…ˆæ˜¯ <strong>Go æ–¹æ³•</strong>ï¼Œè¯¥<strong>æ–¹æ³•çš„å‚æ•°ä¸ºå…·æœ‰é”™è¯¯è¿”å›å€¼çš„å‡½æ•°ç±»å‹ï¼Œåœ¨Goæ–¹æ³•å†…éƒ¨ä¼šåœ¨ä¸€ä¸ªç‹¬ç«‹çš„åç¨‹ä¸­å»è¿è¡Œæ‰€ä¼ å…¥çš„è¿™ä¸ªå‡½æ•°</strong>ï¼Œè¿™æ ·å°±èƒ½å®ç°å¹¶å‘æ‰§è¡Œçš„æ•ˆæœã€‚</p>\n</li>\n<li>\n<p>å…¶æ¬¡ä¾¿æ˜¯ <strong>Wait æ–¹æ³•</strong>ï¼Œå®ƒä¸ WaitGroup ç±»å‹çš„ Wait æ–¹æ³•æœ‰ç‚¹åƒï¼ŒGroupç±»å‹çš„ Wait æ–¹æ³•åŒæ ·ä¼šé˜»å¡ç­‰å¾…æ‰€æœ‰ä¼ å…¥åˆ° Go æ–¹æ³•ä¸­çš„å‡½æ•°å…¨éƒ¨è¿è¡Œå®Œæ¯•ã€‚ç„¶è€Œï¼ŒäºŒè€…çš„ä¸åŒä¹‹å¤„ä¹Ÿååˆ†æ˜æ˜¾ï¼Œ<strong>Group ç±»å‹çš„ Wait æ–¹æ³•å…·å¤‡ä¸€ä¸ª error ç±»å‹çš„è¿”å›å€¼</strong>ã€‚å¦‚æœä¼ å…¥Go æ–¹æ³•çš„å‡½æ•°è¿è¡Œè¿”å›äº†é”™è¯¯ï¼Œé‚£ä¹ˆæ­¤ Wait æ–¹æ³•å°†ä¼šè¿”å›è¯¥é”™è¯¯ä¿¡æ¯ã€‚å½“ç„¶ï¼Œåœ¨å¤šä¸ªä¼ å…¥çš„å‡½æ•°ä¸­éƒ½å‡ºç°äº†é”™è¯¯æ—¶ï¼Œå®ƒåªä¼šè¿”å›æ‰€é‡åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯ã€‚</p>\n</li>\n</ul><pre><code class=\"language-go\">func (g *Group) Go(f func() error)\nfunc (g *Group) Wait() error\n</code></pre><p>åœ¨äº†è§£äº† Group ç±»å‹çš„ API ä¹‹åï¼Œæˆ‘ä»¬å†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨errgroupåŒ…ã€‚</p><p>ç”¨errgroupåŒ…å®ç°å¹¶å‘ç­‰å¾…å’Œé”™è¯¯å¤„ç†åŠŸèƒ½çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚</p><pre><code class=\"language-go\">import (\n    \"golang.org/x/sync/errgroup\"\n)\n\nfunc TestErrHandle(t *testing.T) {\n    results := make([]string, len(urls))\n    // åˆ›å»ºGroupç±»å‹\n    g := new(errgroup.Group)\n    for index, url := range urls {\n        // Launch a goroutine to fetch the URL.\n        url := url\n        index := index\n        // è°ƒç”¨Goæ–¹æ³•\n        g.Go(func() error {\n            // Fetch the URL.\n            resp, err := http.Get(url)\n            if err != nil {\n                return err // è¿”å›é”™è¯¯\n            }\n            defer resp.Body.Close()\n            body, err := io.ReadAll(resp.Body)\n            if err != nil {\n                return err // è¿”å›é”™è¯¯\n            }\n            results[index] = string(body)\n            return nil\n        })\n    }\n    // Wait for all HTTP fetches to complete.\n    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶å¯¹é”™è¯¯è¿›è¡Œå¤„ç†\n    if err := g.Wait(); err != nil {\n        fmt.Println(\"Failured fetched all URLs.\")\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ ¸å¿ƒæ˜¯ä¸‹é¢å‡ æ­¥ã€‚</p><ol>\n<li>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦åˆ›å»º Group ç±»å‹çš„å¯¹è±¡ã€‚</li>\n<li>ç¬¬äºŒæ­¥ï¼Œåœ¨ Group çš„ Go æ–¹æ³•ä¸­ä¼ å…¥é‚£äº›éœ€è¦å¹¶å‘è¿è¡Œçš„å‡½æ•°ã€‚ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›<strong>ä¼ å…¥çš„å‡½æ•°å¿…é¡»å°†é”™è¯¯è¿”å›</strong>ã€‚</li>\n<li>ç¬¬ä¸‰æ­¥ï¼Œä¹Ÿæ˜¯æœ€åä¸€æ­¥ï¼Œåœ¨ä¸»åç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ Groupå¯¹è±¡çš„ Wait æ–¹æ³•ã€‚<strong>é€šè¿‡è¿™ä¸€è°ƒç”¨ï¼Œä¸»åç¨‹å°†ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´è‡³æ‰€æœ‰é€šè¿‡ Go æ–¹æ³•ä¼ å…¥çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚å¹¶ä¸”ï¼Œåœ¨ä»»åŠ¡å®Œæˆåï¼Œæˆ‘ä»¬è¿˜èƒ½å¤Ÿå¯¹ Wait æ–¹æ³•æ‰€è¿”å›çš„é”™è¯¯è¿›è¡Œå¤„ç†ã€‚</strong></li>\n</ol><h3>ä»»åŠ¡å–æ¶ˆï¼šå¦‚ä½•ä¸­æ­¢å¹¶å‘ä»»åŠ¡çš„è¿è¡Œï¼Ÿ</h3><p>é™¤äº†é”™è¯¯å¤„ç†åŠŸèƒ½ï¼ŒerrgroupåŒ…æä¾›çš„ä»»åŠ¡å–æ¶ˆåŠŸèƒ½ä¹Ÿç›¸å½“å®ç”¨ã€‚<strong>æ‰€è°“ä»»åŠ¡å–æ¶ˆåŠŸèƒ½ï¼Œæ˜¯æŒ‡ä¸€æ—¦åœ¨å¤šä¸ªå¹¶å‘ä»»åŠ¡ä¸­æœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä¸­æ­¢é‚£äº›å°šæœªå¼€å§‹æ‰§è¡Œæˆ–è€…æ˜¯æ­£åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…¶ä»–å¹¶å‘ä»»åŠ¡</strong>ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥é¿å…å› ç»§ç»­æ‰§è¡Œè¿™äº›ä¸å¿…è¦çš„ä»»åŠ¡è€Œå¯¼è‡´èµ„æºæµªè´¹ã€‚</p><p>è€Œè¦å®ç°ä»»åŠ¡å–æ¶ˆåŠŸèƒ½ï¼Œé™¤äº†æˆ‘ä»¬ä¹‹å‰å­¦åˆ°çš„Group ç±»å‹çš„ Go æ–¹æ³•å’Œ Wait æ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªæä¸ºå…³é”®çš„æ ¸å¿ƒæ–¹æ³•ï¼Œé‚£å°±æ˜¯ <strong>WithContext å‡½æ•°</strong>ã€‚å€ŸåŠ©è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬èƒ½å¤ŸåŸºäºcontextæ¥åˆ›å»º Group å¯¹è±¡ï¼Œè¿™æ ·åœ¨ä»»åŠ¡æ‰§è¡ŒæŠ¥é”™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨contextæ¥åœæ­¢æ‰€æœ‰ç›¸å…³ä»»åŠ¡ã€‚</p><pre><code class=\"language-go\">func WithContext(ctx context.Context) (*Group, context.Context)\n</code></pre><p>åœ¨äº†è§£äº†WithContext å‡½æ•°ä¹‹åï¼Œç°åœ¨è®©æˆ‘ä»¬errgroupåŒ…æ¥å®ç°ä»»åŠ¡å–æ¶ˆåŠŸèƒ½ã€‚</p><p>å¦‚åŒä¸‹é¢çš„ä»£ç ï¼Œå’Œå‰é¢å®ç°é”™è¯¯å¤„ç†åŠŸèƒ½ä¸åŒï¼Œç”¨errgroupåŒ…æ¥å®ç°ä»»åŠ¡å–æ¶ˆåŠŸèƒ½ï¼Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒè¦ç‚¹ã€‚</p><p>ç¬¬ä¸€ç‚¹ï¼Œéœ€è¦<strong>ç”¨WithContextå‡½æ•°</strong>åˆ›å»ºGroupå¯¹è±¡ã€‚</p><p>ç¬¬äºŒç‚¹ï¼Œåœ¨ä¼ å…¥Goæ–¹æ³•çš„å‡½æ•°ä¸­ï¼Œéœ€è¦å®ç° <strong>select-doneæ¨¡å¼</strong>ï¼Œä¹Ÿå°±æ˜¯å½“å‡½æ•°è¿è¡Œæ—¶ï¼Œå‘ç°contextè¢«å–æ¶ˆï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä»è€Œé¿å…æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p><pre><code class=\"language-go\">func TestCancel(t *testing.T) {\n    results := make([]string, len(urls))\n    // ç”¨WithContextå‡½æ•°åˆ›å»ºGroupå¯¹è±¡\n    eg, ctx := errgroup.WithContext(context.Background())\n    for index, url := range urls {\n        url := url\n        index := index\n        // è°ƒç”¨Goæ–¹æ³•\n        eg.Go(func() error {\n            select {\n            case &lt;-ctx.Done(): // select-doneæ¨¡å¼å–æ¶ˆè¿è¡Œ\n                return errors.New(\"task is cancelled\")\n            default:\n                // Fetch the URL.\n                resp, err := http.Get(url)\n                if err != nil {\n                    return err // è¿”å›é”™è¯¯\n                }\n                defer resp.Body.Close()\n                body, err := io.ReadAll(resp.Body)\n                if err != nil {\n                    return err // è¿”å›é”™è¯¯\n                }\n                results[index] = string(body)\n                return nil\n            }\n        })\n    }\n    // Wait for all HTTP fetches to complete.\n    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶å¯¹é”™è¯¯è¿›è¡Œå¤„ç†\n    if err := eg.Wait(); err != nil {\n        fmt.Println(\"Failured fetched all URLs.\")\n    }\n}\n</code></pre><h3>åç¨‹æ•°é™åˆ¶ï¼šå¦‚ä½•æ§åˆ¶å¹¶å‘è¿è¡Œçš„æœ€å¤§åç¨‹æ•°ï¼Ÿ</h3><p>é™¤äº†é”™è¯¯å¤„ç†å’Œä»»åŠ¡å–æ¶ˆåŠŸèƒ½ï¼ŒerrgroupåŒ…è¿˜å¯ä»¥<strong>é™åˆ¶åŒæ—¶å¹¶å‘è¿è¡Œçš„æœ€å¤§åç¨‹æ•°</strong>ã€‚å®ƒçš„æ ¸å¿ƒæ˜¯ <strong>SetLimitæ–¹æ³•</strong>ã€‚</p><p>å¦‚æœæˆ‘ä»¬ç”¨SetLimitæ–¹æ³•è®¾ç½®äº†å¯åŒæ—¶è¿è¡Œçš„æœ€å¤§åç¨‹æ•°ï¼Œå½“è°ƒç”¨Goæ–¹æ³•æ—¶ï¼Œä¸€æ—¦è¾¾åˆ°äº†æœ€å¤§åç¨‹æ•°ï¼Œå°±ä¼šé˜»å¡åˆ›å»ºæ–°åç¨‹è¿è¡Œä»»åŠ¡ï¼Œç›´åˆ°æœ‰åç¨‹è¿è¡Œå®Œï¼Œæ‰å¯ä»¥åˆ›å»ºæ–°åç¨‹ã€‚</p><pre><code class=\"language-go\">func (g *Group) SetLimit(n int)\n</code></pre><p>ç°åœ¨è®©æˆ‘ä»¬åŸºäºSetLimitæ–¹æ³•ï¼Œæ¥å®ç°é™åˆ¶å¹¶å‘è¿è¡Œçš„æœ€å¤§åç¨‹æ•°åŠŸèƒ½ã€‚å¦‚åŒä¸‹é¢çš„ä»£ç ä¸€æ ·ï¼Œé™åˆ¶å¹¶å‘è¿è¡Œçš„æœ€å¤§åç¨‹æ•°ï¼Œæ ¸å¿ƒæ˜¯è°ƒç”¨SetLimitæ–¹æ³•ã€‚</p><pre><code class=\"language-go\">func TestLimitGNum(t *testing.T) {\n    results := make([]string, len(urls))\n    // ç”¨WithContextå‡½æ•°åˆ›å»ºGroupå¯¹è±¡\n    eg, ctx := errgroup.WithContext(context.Background())\n    // è°ƒç”¨SetLimitæ–¹æ³•ï¼Œè®¾ç½®å¯åŒæ—¶è¿è¡Œçš„æœ€å¤§åç¨‹æ•°\n    eg.SetLimit(2)\n    for index, url := range urls {\n        url := url\n        index := index\n        // è°ƒç”¨Goæ–¹æ³•\n        eg.Go(func() error {\n            select {\n            case &lt;-ctx.Done(): // select-doneæ¨¡å¼å–æ¶ˆè¿è¡Œ\n                return errors.New(\"task is cancelled\")\n            default:\n                // Fetch the URL.\n                resp, err := http.Get(url)\n                if err != nil {\n                    return err // è¿”å›é”™è¯¯\n                }\n                defer resp.Body.Close()\n                body, err := io.ReadAll(resp.Body)\n                if err != nil {\n                    return err // è¿”å›é”™è¯¯\n                }\n                results[index] = string(body)\n                return nil\n            }\n        })\n    }\n    // Wait for all HTTP fetches to complete.\n    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶å¯¹é”™è¯¯è¿›è¡Œå¤„ç†\n    if err := eg.Wait(); err != nil {\n        fmt.Println(\"Failured fetched all URLs.\")\n    }\n}\n</code></pre><h2>errgroupæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</h2><p>å‰é¢æˆ‘ä»‹ç»äº†errgroupåœ¨ä¸åŒåŠŸèƒ½åœºæ™¯çš„ä½¿ç”¨ï¼Œä¸è¿‡å’±ä»¬è¿˜å¯ä»¥ç»§ç»­å¾€æ·±äº†æŒ–æŒ–ï¼Œçœ‹çœ‹ errgroup åº•å±‚åˆ°åº•æ˜¯å’‹å®ç°çš„ã€‚è¦æ˜¯æŠŠ errgroup åŒ…çš„å®ç°ææ¸…æ¥šäº†ï¼Œé‚£æˆ‘ä»¬è‡ªå·±è®¾è®¡å¹¶å‘ç¨‹åºçš„æœ¬äº‹ä¹Ÿèƒ½å¾€ä¸Šæä¸€å¤§æˆªã€‚</p><p>é¦–å…ˆï¼Œå’±ä»¬æ¥çœ‹çœ‹ errgroup åŒ… Group ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå®ƒæœ‰å‡ ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ã€‚</p><pre><code class=\"language-go\">type token struct{}\n\ntype Group struct {\n    cancel func(error) // è¿™ä¸ªä½œç”¨æ˜¯ç‚ºäº†å‰é¢èªªçš„ WithContext è€Œä¾†çš„\n\n    wg sync.WaitGroup // errGroupåº•å±‚çš„é˜»å¡ç­‰å¾…åŠŸèƒ½ï¼Œå°±æ˜¯é€šè¿‡WaitGroupå®ç°çš„\n\n    sem chan token // ç”¨äºæ§åˆ¶æœ€å¤§è¿è¡Œçš„åç¨‹æ•°\n\n    err     error // æœ€ååœ¨Waitæ–¹æ³•ä¸­è¿”å›çš„error\n    errOnce sync.Once // ç”¨äºå®‰å…¨çš„è®¾ç½®err\n}\n</code></pre><ul>\n<li>\n<p>å…ˆè¯´ cancel å˜é‡ï¼Œå®ƒå°±æ˜¯ä¸ºäº†å‰é¢è®²çš„ WithContext åŠŸèƒ½è®¾è®¡çš„ï¼Œä¸“é—¨ç”¨æ¥æ§åˆ¶å–æ¶ˆä»»åŠ¡è¿è¡Œã€‚</p>\n</li>\n<li>\n<p>sync.WaitGroup ç±»å‹çš„å˜é‡ wg ï¼ŒGroup ç±»å‹åœ¨åº•å±‚æ˜¯é å°è£…å®ƒæ¥å®ç°é˜»å¡ç­‰å¾…åŠŸèƒ½çš„ã€‚</p>\n</li>\n<li>\n<p>é€šé“ç±»å‹å˜é‡ sem ï¼Œç”¨æ¥æ§åˆ¶åŒæ—¶èƒ½è·‘çš„æœ€å¤§åç¨‹æ•°é‡ã€‚</p>\n</li>\n<li>\n<p>error ç±»å‹çš„å˜é‡ err ï¼Œåœ¨ Group ç±»å‹çš„ Wait æ–¹æ³•é‡Œï¼Œå®ƒä¼šè¢«è¿”å›ç»™è°ƒç”¨è€…ã€‚</p>\n</li>\n<li>\n<p>æœ€åå°±æ˜¯sync.Once ç±»å‹å˜é‡ï¼Œå®ƒçš„ç”¨å¤„å°±æ˜¯èƒ½å®‰å…¨åœ°è®¾ç½® err å˜é‡ã€‚åœ¨å¥½å¤šåç¨‹ä¸€èµ·å¹¶å‘è·‘çš„æƒ…å†µä¸‹ï¼Œå®ƒèƒ½ä¿è¯ err å˜é‡åªè®¾ç½®ä¸€æ¬¡ï¼Œè€Œä¸”æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚</p>\n</li>\n</ul><p>æ¥ç€ï¼Œå’±ä»¬æ¥çœ‹çœ‹ <strong>WithContextå‡½æ•°</strong>å’Œ <strong>SetLimitæ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ä»»åŠ¡å–æ¶ˆåŠŸèƒ½å’Œåç¨‹æ•°é™åˆ¶çš„æ ¸å¿ƒæ–¹æ³•ã€‚</strong></p><p>å°±åƒä¸‹é¢çš„ä»£ç ä¸€æ ·ï¼ŒWithContextå‡½æ•°å†…éƒ¨ä¼šç”Ÿæˆå¯ä»¥è¢«å–æ¶ˆçš„contextç±»å‹å¯¹è±¡ctxï¼Œå¹¶ä¸”ä¼šç”Ÿæˆcancelå‡½æ•°å˜é‡ï¼Œå°è£…åœ¨Groupå¯¹è±¡ä¸­ã€‚SetLimitæ–¹æ³•ç”¨äºè®¾ç½®é€šé“å®¹é‡<strong>ã€‚</strong></p><pre><code class=\"language-go\">func WithContext(ctx context.Context) (*Group, context.Context) {\n    ctx, cancel := withCancelCause(ctx)\n    return &amp;Group{cancel: cancel}, ctx // ç”Ÿæˆæœ‰å–æ¶ˆåŠŸèƒ½çš„context\n}\n\nfunc (g *Group) SetLimit(n int) {\n    g.sem = make(chan token, n) // è®¾ç½®é€šé“å®¹é‡\n}\n</code></pre><p>ç„¶åï¼Œå’±ä»¬æ¥çœ‹çœ‹<strong>Goæ–¹æ³•</strong>ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯Groupç±»å‹çš„æ ¸å¿ƒæ–¹æ³•ã€‚</p><pre><code class=\"language-go\">func (g *Group) Go(f func() error) {\n    if g.sem != nil {\n        g.sem &lt;- token{} // é€šé“æ»¡åˆ™é˜»å¡ï¼Œç”¨æ¥æ§åˆ¶æœ€å¤§å¹¶å‘æ•°\n    }\n\n    g.wg.Add(1)\n    go func() {\n        defer g.done() // åº•å±‚è°ƒç”¨g.wg.Done()\n\n        if err := f(); err != nil {\n            g.errOnce.Do(func() { // å®‰å…¨çš„è®¾ç½®errå˜é‡\n                g.err = err\n                if g.cancel != nil {\n                    g.cancel(g.err) // ä»»åŠ¡è¿è¡Œå‡ºé”™ï¼Œè°ƒç”¨g.cancelæ–¹æ³•ï¼Œç”¨contextæ§åˆ¶å…¶å®ƒä»»åŠ¡æ˜¯å¦ä¸­æ­¢è¿è¡Œ\n                }\n            })\n        }\n    }()\n}\n\nfunc (g *Group) done() {\n    if g.sem != nil {\n        &lt;-g.sem // åç¨‹è¿è¡Œå®Œï¼Œé€šé“è¯»\n    }\n    g.wg.Done()\n}\n</code></pre><p>å’±ä»¬ä¸€èµ·æ¥åˆ†æä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ã€‚</p><ol>\n<li>å‡å¦‚æˆ‘ä»¬è°ƒç”¨SetLimitæ–¹æ³•è®¾ç½®äº†é€šé“å®¹é‡ï¼Œå½“éœ€è¦åˆ›å»ºåç¨‹ä¹‹å‰ï¼Œåœ¨Goæ–¹æ³•çš„ç¬¬3è¡Œä¼šå¾€é€šé“å†™ï¼Œå½“é€šé“å·²ç»è¢«å†™æ»¡æ—¶åˆ™é˜»å¡ä¸åˆ›å»ºåç¨‹ã€‚å½“åç¨‹è¿è¡Œå®Œæ—¶ï¼Œåœ¨Goæ–¹æ³•ç¬¬8è¡Œçš„doneæ–¹æ³•å†…ï¼Œä¼šè¯»é€šé“ã€‚</li>\n<li>ç¬¬6è¡Œå’Œç¬¬8è¡Œï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨WaitGroupç±»å‹çš„Addå’ŒDoneæ–¹æ³•æ¥å®ç°å¹¶å‘ç­‰å¾…åŠŸèƒ½ã€‚</li>\n<li>ç¬¬10-12è¡Œï¼Œå½“ä¼ å…¥Goæ–¹æ³•çš„å‡½æ•°è°ƒç”¨å‡ºé”™æ—¶ï¼Œé€šè¿‡errOnceå®‰å…¨åœ°è®¾ç½®errå˜é‡ï¼Œè¿™ä¸ªé”™è¯¯ä¾¿æ˜¯Waitæ–¹æ³•æ”¶åˆ°çš„é”™è¯¯ã€‚</li>\n<li>ç¬¬14è¡Œï¼Œè°ƒç”¨g.cancelå‡½æ•°æ¥è®©ctx.Done()èƒ½è¯»åˆ°å€¼ï¼Œè¾¾åˆ°ä¸­æ­¢å…¶å®ƒä»»åŠ¡è¿è¡Œçš„ç›®çš„ã€‚</li>\n</ol><p>æœ€åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹Waitæ–¹æ³•ã€‚</p><pre><code class=\"language-go\">// Wait blocks until all function calls from the Go method have returned, then\n// returns the first non-nil error (if any) from them.\nfunc (g *Group) Wait() error {\n    g.wg.Wait()\n    if g.cancel != nil {\n            g.cancel(g.err)\n    }\n    return g.err\n}\n</code></pre><p>Waitæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œæ ¸å¿ƒå°±æ˜¯è°ƒç”¨g.wgæ¥é˜»å¡ç­‰å¾…ï¼Œå¹¶å°†Goæ–¹æ³•ä¸­è®¾ç½®çš„g.erré”™è¯¯è¿”å›ï¼Œä»è€Œå®ç°é”™è¯¯å¤„ç†åŠŸèƒ½ã€‚</p><h2>å°ç»“</h2><p>åœ¨ä»Šå¤©çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†åœ¨å¹¶å‘ç­‰å¾…åœºæ™¯é‡Œå¤§æ˜¾èº«æ‰‹çš„å…³é”®æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯ WaitGroup ç±»å‹ä»¥åŠ errgroup åŒ…ã€‚é€šè¿‡å¹¶å‘ç­‰å¾…ï¼Œå’±ä»¬å¯ä»¥å°†å¤šä¸ªä¸‹æ¸¸çš„ä¸²è¡Œè¯·æ±‚å˜æˆå¹¶å‘è¯·æ±‚ï¼Œä»è€Œé™ä½å“åº”å»¶æ—¶ã€‚</p><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹è¿™ä¸¤ä¸ªå¹¶å‘ç­‰å¾…æŠ€å·§çŸ¥è¯†ã€‚</p><ul>\n<li>WaitGroup ç±»å‹ã€‚å½“æˆ‘ä»¬æ‰‹å¤´æœ‰ä¸€ä¸ªè§„æ¨¡è¾ƒå¤§çš„ä»»åŠ¡æ—¶ï¼Œä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥å·§å¦™åœ°å°†å…¶æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡ï¼Œç„¶åè®©è¿™äº›å­ä»»åŠ¡å¹¶å‘è¿è¡Œã€‚è€Œæ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬è¿˜éœ€è¦ç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡éƒ½é¡ºåˆ©æ‰§è¡Œå®Œæ¯•ï¼Œé‚£ä¹ˆ WaitGroup ç±»å‹å°±è¯¥é—ªäº®ç™»åœºå•¦ï¼Œå®ƒèƒ½å¤Ÿç²¾å‡†åœ°æ»¡è¶³è¿™ä¸€éœ€æ±‚ã€‚</li>\n<li>errgroup åŒ…ã€‚å®é™…ä¸Šï¼Œerrgroup åŒ…å¯ä»¥çœ‹ä½œæ˜¯å¯¹ WaitGroup ç±»å‹çš„å‡çº§ä¸å°è£…ã€‚å½“æˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸ä»…éœ€è¦å¹¶å‘è¿è¡Œä»»åŠ¡ï¼Œè¿˜å¾—å‘¨å…¨åœ°è€ƒè™‘å¯¹å¯èƒ½å‡ºç°çš„é”™è¯¯è¿›è¡Œå¦¥å–„å¤„ç†ã€èƒ½å¤Ÿçµæ´»åœ°å–æ¶ˆä»»åŠ¡ä»¥åŠç²¾å‡†åœ°æ§åˆ¶æœ€å¤§åç¨‹æ•°ç­‰å¤æ‚éœ€æ±‚ï¼Œè¿™æ—¶errgroup åŒ…æ— ç–‘å°±æ˜¯æˆ‘ä»¬çš„æœ€ä½³é€‰æ‹©ã€‚</li>\n</ul><p>å¸Œæœ›ä½ èƒ½å¤Ÿç”¨å¿ƒå»ä½“ä¼š WaitGroup ç±»å‹å’Œ errgroup åŒ…åœ¨å®é™…åœºæ™¯ä¸­çš„åº”ç”¨ã€‚åœ¨ä»Šåé‡åˆ°å¹¶å‘ç­‰å¾…åœºæ™¯æ—¶ï¼Œä¸å¦¨è¯•è¯•ç”¨errgroupåŒ…ï¼Œç›¸ä¿¡å®ƒä¼šç»™ä½ å¸¦æ¥æ„æƒ³ä¸åˆ°çš„ä¾¿åˆ©ä¸é«˜æ•ˆã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å½“å¤šä»»åŠ¡å¹¶å‘è¿è¡Œæ—¶ï¼Œä¼šé‡åˆ°è¿™æ ·ä¸€ç§ç‰¹æ®Šçš„åœºæ™¯ï¼šåªæœ‰å½“æ‰€æœ‰å¹¶å‘çš„ä»»åŠ¡éƒ½å‡ºç°é”™è¯¯æ—¶ï¼Œæ•´ä¸ªè¯·æ±‚æ‰ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼›è€Œåªæœ‰éƒ¨åˆ†ä»»åŠ¡å‡ºé”™æ—¶ï¼Œè¯·æ±‚ä¹Ÿä¸ä¼šè¿”å›é”™è¯¯ã€‚é‚£ä¹ˆæˆ‘ä»¬ç©¶ç«Ÿè¯¥æ€ä¹ˆåœ¨ä¸»åç¨‹é‡Œè·å–æ¯ä¸ªå¹¶å‘ä»»åŠ¡çš„æ‰§è¡Œå‡ºé”™ä¿¡æ¯å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åœ¨è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":396490,"user_name":"lJ","can_delete":false,"product_type":"c1","uid":2562558,"ip_address":"æ±Ÿè‹","ucode":"CC29D06A16FF93","user_header":"https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg","comment_is_top":false,"comment_ctime":1734663437,"is_pvip":false,"replies":[{"id":143945,"content":"ğŸ‘ğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1313417,"ctime":1734876700,"ip_address":"å¹¿ä¸œ","comment_id":396490,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100843701,"comment_content":"å¯ä»¥åŸºäº WaitGroup å’Œä¸€ä¸ªé”™è¯¯é€šé“ï¼ˆerror channelï¼Œå®¹é‡ä¸å°äºæ§åˆ¶çš„åç¨‹å¹¶å‘æ•°ï¼Œé¿å…é˜»å¡ï¼‰æ¥æ”¶é›†å¹¶å‘åç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯ï¼Œä»»åŠ¡åç¨‹å‘ç”Ÿçš„é”™è¯¯å†™å…¥err channelä¸­ï¼Œå¼€å¯ä¸€ä¸ªåç¨‹è¯»å–err channelã€‚ä¹Ÿå¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€çš„é”™è¯¯åˆ‡ç‰‡errsï¼Œåœ¨åç¨‹å‡ºé”™æ—¶å°†errèµ‹å€¼ç»™errsã€‚\n\nå¼€æºå®ç°æœ‰\n1ã€github.com&#47;facebookgo&#47;errgroupï¼Œæ‰©å±•äº†æ ‡å‡†åº“çš„sync.WaitGroupï¼Œerrorsæ”¶é›†åç¨‹æ‰§è¡Œæ—¶å‘ç”Ÿçš„é”™è¯¯\ntype Group struct {\n\twg     sync.WaitGroup\n\tmu     sync.Mutex\n\terrors MultiError\n}\n2ã€github.com&#47;vardius&#47;gollbackï¼Œgollback.Allæ–¹æ³•è¿”å›æ‰€æœ‰çš„é”™è¯¯\n\næœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡erråˆ‡ç‰‡ä¿å­˜ä»»åŠ¡åç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯","like_count":2,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655409,"discussion_content":"ğŸ‘ğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734876700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":396493,"user_name":"æ©™","can_delete":false,"product_type":"c1","uid":2955031,"ip_address":"åŒ—äº¬","ucode":"39A4CBCBC68AE8","user_header":"https://static001.geekbang.org/account/avatar/00/2d/17/17/ffc85c92.jpg","comment_is_top":false,"comment_ctime":1734675361,"is_pvip":false,"replies":[{"id":143946,"content":"è¿™é‡Œä¸»è¦æ˜¯æƒ³æ¼”ç¤ºè¿™ä¸ªåŠŸèƒ½æ€ä¹ˆç”¨ï¼Œå¦‚æœæƒ³æ¼”ç¤ºå‡ºå…¶ä¸­ä¸€ä¸ªä»»åŠ¡å‡ºé”™ï¼Œå…¶å®ƒä»»åŠ¡è¢«å–æ¶ˆçš„æ•ˆæœï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™æ®µä»£ç è¿è¡Œï¼Œtask2ä¼šæ‰§è¡Œselect-doneåˆ†æ”¯ï¼špackage main\n\nimport (\n\t&quot;context&quot;\n\t&quot;errors&quot;\n\t&quot;fmt&quot;\n\t&quot;testing&quot;\n\t&quot;time&quot;\n\n\t&quot;golang.org&#47;x&#47;sync&#47;errgroup&quot;\n)\n\nfunc TestCancel(t *testing.T) {\n\t&#47;&#47; ç”¨WithContextå‡½æ•°åˆ›å»ºGroupå¯¹è±¡\n\teg, ctx := errgroup.WithContext(context.Background())\n\teg.Go(func() error {\n\t\ttime.Sleep(1 * time.Second)\n\t\treturn errors.New(&quot;task1 error&quot;)\n\t})\n\t&#47;&#47; è°ƒç”¨Goæ–¹æ³•\n\teg.Go(func() error {\n\t\ttime.Sleep(2 * time.Second)\n\t\tselect {\n\t\tcase &lt;-ctx.Done(): &#47;&#47; select-doneæ¨¡å¼å–æ¶ˆè¿è¡Œ\n\t\t\tfmt.Println(&quot;task2 is cancelled&quot;)\n\t\tdefault:\n\t\t\tfmt.Println(&quot;task2 done&quot;)\n\t\t}\n\t\treturn nil\n\t})\n\n\t&#47;&#47; ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶å¯¹é”™è¯¯è¿›è¡Œå¤„ç†\n\tif err := eg.Wait(); err != nil {\n\t\tfmt.Println(&quot;Failured&quot;)\n\t}\n}\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1313417,"ctime":1734877430,"ip_address":"å¹¿ä¸œ","comment_id":396493,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100843701,"comment_content":"func TestCancel(t *testing.T) {\n    results := make([]string, len(urls))\n    &#47;&#47; ç”¨WithContextå‡½æ•°åˆ›å»ºGroupå¯¹è±¡\n    eg, ctx := errgroup.WithContext(context.Background())\n    for index, url := range urls {\n        url := url\n        index := index\n        &#47;&#47; è°ƒç”¨Goæ–¹æ³•\n        eg.Go(func() error {\n            select {\n            case &lt;-ctx.Done(): &#47;&#47; select-doneæ¨¡å¼å–æ¶ˆè¿è¡Œ\n                return errors.New(&quot;task is cancelled&quot;)\n            default:\n                &#47;&#47; Fetch the URL.\n                resp, err := http.Get(url)\n                if err != nil {\n                    return err &#47;&#47; è¿”å›é”™è¯¯\n                }\n                defer resp.Body.Close()\n                body, err := io.ReadAll(resp.Body)\n                if err != nil {\n                    return err &#47;&#47; è¿”å›é”™è¯¯\n                }\n                results[index] = string(body)\n                return nil\n            }\n        })\n    }\n    &#47;&#47; Wait for all HTTP fetches to complete.\n    &#47;&#47; ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶å¯¹é”™è¯¯è¿›è¡Œå¤„ç†\n    if err := eg.Wait(); err != nil {\n        fmt.Println(&quot;Failured fetched all URLs.&quot;)\n    }\n}\nè¿™ä¸ªæ–¹æ³•æ„Ÿè§‰ç›´æ¥ç”¨å¯ä»¥cancleçš„contextä¼šä¸ä¼šæ¯”è¾ƒå¥½ï¼Œå¦‚æœæ£€æµ‹åˆ°é”™è¯¯ç›´æ¥cancelæ‰ã€‚ç°åœ¨æ„Ÿè§‰è¿™ä¸ªä¾‹å­è™½ç„¶æ”¯æŒcancelï¼Œè™½ç„¶åœ¨è®²cancelï¼Œä½†æ˜¯ä¾‹å­æ²¡æœ‰æ”¯æŒcancelï¼Œçœ‹èµ·æ¥æ€ªæ€ªçš„ã€‚","like_count":0,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655410,"discussion_content":"è¿™é‡Œä¸»è¦æ˜¯æƒ³æ¼”ç¤ºè¿™ä¸ªåŠŸèƒ½æ€ä¹ˆç”¨ï¼Œå¦‚æœæƒ³æ¼”ç¤ºå‡ºå…¶ä¸­ä¸€ä¸ªä»»åŠ¡å‡ºé”™ï¼Œå…¶å®ƒä»»åŠ¡è¢«å–æ¶ˆçš„æ•ˆæœï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™æ®µä»£ç è¿è¡Œï¼Œtask2ä¼šæ‰§è¡Œselect-doneåˆ†æ”¯ï¼špackage main\n\nimport (\n\t&#34;context&#34;\n\t&#34;errors&#34;\n\t&#34;fmt&#34;\n\t&#34;testing&#34;\n\t&#34;time&#34;\n\n\t&#34;golang.org/x/sync/errgroup&#34;\n)\n\nfunc TestCancel(t *testing.T) {\n\t// ç”¨WithContextå‡½æ•°åˆ›å»ºGroupå¯¹è±¡\n\teg, ctx := errgroup.WithContext(context.Background())\n\teg.Go(func() error {\n\t\ttime.Sleep(1 * time.Second)\n\t\treturn errors.New(&#34;task1 error&#34;)\n\t})\n\t// è°ƒç”¨Goæ–¹æ³•\n\teg.Go(func() error {\n\t\ttime.Sleep(2 * time.Second)\n\t\tselect {\n\t\tcase &lt;-ctx.Done(): // select-doneæ¨¡å¼å–æ¶ˆè¿è¡Œ\n\t\t\tfmt.Println(&#34;task2 is cancelled&#34;)\n\t\tdefault:\n\t\t\tfmt.Println(&#34;task2 done&#34;)\n\t\t}\n\t\treturn nil\n\t})\n\n\t// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¹¶å¯¹é”™è¯¯è¿›è¡Œå¤„ç†\n\tif err := eg.Wait(); err != nil {\n\t\tfmt.Println(&#34;Failured&#34;)\n\t}\n}\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734877430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}