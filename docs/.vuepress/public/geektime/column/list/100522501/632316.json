{"id":632316,"title":"20ï½œåº”ç”¨ç›‘æ§ï¼šå¦‚ä½•ä½¿ç”¨æ—¥å¿—æ¥ç›‘æ§åº”ç”¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç§¦æ™“è¾‰ã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬ä»‹ç»äº†åº”ç”¨åŸ‹ç‚¹ç›‘æ§ï¼Œå¯¹äºè‡ªç ”çš„è½¯ä»¶ï¼Œåœ¨ä¸€å¼€å§‹å°±å»ºç«‹å¯è§‚æµ‹èƒ½åŠ›æ˜¯éå¸¸å¥½çš„é€‰æ‹©ï¼Œä½†æ˜¯å¾ˆå¤šè½¯ä»¶å¯èƒ½æ— æ³•ä¿®æ”¹æºä»£ç ï¼Œæ¯”å¦‚ä¸€äº›å¤–é‡‡çš„è½¯ä»¶ï¼Œé‚£å°±åªèƒ½ç”¨ä¸€äº›å¤–æŒ‚å¼çš„æ‰‹æ®µï¼Œæ¯”å¦‚åœ¨è¯·æ±‚é“¾è·¯ä¸Šæ’å…¥ä¸€äº›ä»£ç†é€»è¾‘ï¼Œæˆ–è€…è¯»å–åˆ†æåº”ç”¨æ—¥å¿—ã€‚</p><p>å…¸å‹çš„ä»£ç†æ–¹å¼æ˜¯ Nginxï¼Œå¦‚æœæ˜¯ HTTP æœåŠ¡ï¼Œä» Nginx çš„ Access æ—¥å¿—ä¸­å¯ä»¥è·å–å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚è®¿é—®çš„æ˜¯å“ªä¸ªæ¥å£ï¼Œç”¨çš„ä»€ä¹ˆ HTTP æ–¹æ³•ï¼Œè¿”å›çš„çŠ¶æ€ç æ˜¯ä»€ä¹ˆï¼Œè€—æ—¶å¤šä¹…ç­‰ç­‰ã€‚è¿™äº›ä¿¡æ¯å¯¹åº”ç”¨çš„ç›‘æ§å¾ˆæœ‰å¸®åŠ©ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ eBPF æŠ€æœ¯ä¸ºç½‘ç»œåŒ…å¢åŠ ä¸€äº›è¿‡æ»¤åˆ†æé€»è¾‘ï¼Œä¸è¿‡ eBPF è¦æ±‚çš„å†…æ ¸ç‰ˆæœ¬è¾ƒé«˜ã€‚è€Œé€šè¿‡æ—¥å¿—å¯¹åº”ç”¨åšç›‘æ§ï¼Œæ˜¾ç„¶æ˜¯ç›¸å¯¹ç›´è§‚å’Œå»‰ä»·çš„æ–¹å¼ï¼Œè¿™ä¸€è®²æˆ‘ä»¬å°±æ¥çœ‹çœ‹æ€ä¹ˆä»æ—¥å¿—ä¸­æå–æŒ‡æ ‡ã€‚</p><h2>æå–æŒ‡æ ‡çš„å…¸å‹åšæ³•</h2><p>æ ¹æ®æå–è§„åˆ™è¿è¡Œçš„ä½ç½®å¯ä»¥åˆ†ä¸ºä¸¤ç±»åšæ³•ï¼Œä¸€ä¸ªæ˜¯åœ¨ä¸­å¿ƒç«¯ï¼Œä¸€ä¸ªæ˜¯åœ¨æ—¥å¿—ç«¯ã€‚</p><p><strong>ä¸­å¿ƒç«¯</strong>å°±æ˜¯æŠŠè¦å¤„ç†çš„æ‰€æœ‰æœºå™¨çš„æ—¥å¿—éƒ½ç»Ÿä¸€ä¼ åˆ°ä¸­å¿ƒï¼Œæ¯”å¦‚é€šè¿‡ Kafka ä¼ è¾“ï¼Œæœ€ç»ˆè½åˆ° Elasticsearchï¼ŒæŒ‡æ ‡æå–è§„åˆ™å¯ä»¥ä½œä¸ºæµè®¡ç®—ä»»åŠ¡æ’åˆ° Kafka é€šé“ä¸Šï¼Œæ€§èƒ½å’Œå®æ—¶æ€§éƒ½ç›¸å¯¹æ›´å¥½ã€‚æˆ–è€…ç›´æ¥å†™ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œè°ƒç”¨ Elasticsearch çš„æ¥å£æŸ¥è¯¢æ—¥å¿—ï¼ŒåŒæ—¶ç»™å‡ºèšåˆè®¡ç®—å‡½æ•°ï¼Œè®© Elasticsearch è¿”å›æŒ‡æ ‡æ•°æ®ï¼Œç„¶åå†™å…¥æ—¶åºåº“ï¼Œå®æ—¶æ€§ä¼šå·®ä¸€äº›ï¼Œä½†ä¹ŸåŸºæœ¬å¤Ÿç”¨ã€‚</p><!-- [[[read_end]]] --><p><strong>æ—¥å¿—ç«¯</strong>å¤„ç†æ˜¯æŒ‡æå–è§„åˆ™ç›´æ¥è¿è¡Œåœ¨äº§ç”Ÿæ—¥å¿—çš„æœºå™¨ä¸Šï¼Œæµå¼è¯»å–æ—¥å¿—ï¼ŒåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ã€‚å¯¹äºå‘½ä¸­çš„æ—¥å¿—ï¼Œæå–å…¶ä¸­çš„æ•°å­—éƒ¨åˆ†ä½œä¸ºæŒ‡æ ‡ä¸ŠæŠ¥ï¼Œæˆ–è€…ä¸æå–ä»»ä½•æ•°å­—ï¼Œåªç»Ÿè®¡ä¸€ä¸‹å‘½ä¸­çš„æ—¥å¿—è¡Œæ•°æœ‰æ—¶ä¹Ÿå¾ˆæœ‰ä»·å€¼ï¼Œæ¯”å¦‚ç»Ÿè®¡ä¸€ä¸‹ <code>Error</code> æˆ– <code>Exception</code> å…³é”®å­—å‡ºç°çš„æ¬¡æ•°ï¼Œæˆ‘ä»¬å°±çŸ¥é“ç³»ç»Ÿæ˜¯ä¸æ˜¯æŠ¥é”™äº†ã€‚</p><p>ä¸­å¿ƒç«¯å¤„ç†çš„æ–¹å¼ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°å¼€æºè§£å†³æ–¹æ¡ˆï¼Œå¦‚æœä½ çŸ¥é“æœ‰å¥½ç”¨çš„å¼€æºæ–¹æ¡ˆå¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€åˆ†äº«ã€‚æ—¥å¿—ç«¯å¤„ç†çš„æ–¹å¼ï¼Œå€’æ˜¯æœ‰å¾ˆå¤šå¼€æºæ–¹æ¡ˆï¼Œæ¯”è¾ƒæœ‰åçš„æ˜¯ <a href=\"https://github.com/google/mtail\">mtail</a> å’Œ <a href=\"https://github.com/fstab/grok_exporter\">grok_exporter</a>ï¼Œmtail å‘å¸ƒæ—¶é—´æ›´ä¹…ï¼Œ3400 starï¼Œgrok_exporter å‘å¸ƒæ—¶é—´æ™šä¸€äº›ï¼Œ700 starï¼Œä¸è¿‡å®ƒä»¬åŸç†ä¸Šæ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹ä»‹ç» mtail çš„ç”¨æ³•ã€‚</p><h2>å¿«é€Ÿä¸Šæ‰‹mtail</h2><p>ä½ åº”è¯¥ç”¨è¿‡ Linux ä¸‹çš„ tail å‘½ä»¤å§ï¼Ÿmtailã€grok_exporter ç­‰å·¥å…·å°±åƒæ˜¯å¯¹æ—¥å¿—æ–‡ä»¶æ‰§è¡Œ <code>tail -f</code>ï¼Œç„¶åæ¯æ”¶åˆ°ä¸€æ¡æ—¥å¿—ï¼Œå°±å»åŒ¹é…é¢„å®šä¹‰çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œå°±æ‰§è¡ŒæŸäº›åŠ¨ä½œï¼Œå¦åˆ™è·³è¿‡ç­‰å¾…ä¸‹ä¸€æ¡æ—¥å¿—ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å®‰è£…ä¸€ä¸‹ mtailï¼Œç»Ÿè®¡ä¸€ä¸‹ /var/log/messages ä¸­ Out of memory å…³é”®å­—å‡ºç°çš„æ¬¡æ•°ï¼Œä½œä¸ºä¸€ä¸ªé‡è¦çš„ç›‘æ§æŒ‡æ ‡ä¸ŠæŠ¥ã€‚</p><p>mtail æœ€æ–°ç‰ˆæœ¬æ˜¯ <a href=\"https://github.com/google/mtail/releases/tag/v3.0.0-rc50\">3.0.0-rc50</a>ï¼Œè™½ç„¶æ˜¯ rc ç‰ˆæœ¬ï¼Œä¸è¿‡ä¸ç”¨æ€•ï¼Œmtail ä¸€ç›´åœ¨å‘ rc ç‰ˆå°±æ˜¯ä¸å‘æ­£å¼ç‰ˆï¼Œæˆ‘åœ¨ç”Ÿäº§ç¯å¢ƒç”¨è¿‡æ²¡é‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘ä»¬å°±æ‹¿è¿™ä¸ªç‰ˆæœ¬ä¸¾ä¾‹ï¼Œä¸‹è½½å’Œä½ çš„ OS åŒ¹é…çš„å‘å¸ƒåŒ…ï¼Œè§£å‹ç¼©ï¼Œå¯ä»¥çœ‹åˆ° mtail çš„äºŒè¿›åˆ¶ã€‚</p><p>æˆ‘æƒ³ç»Ÿè®¡/var/log/messages ä¸­ Out of memory å…³é”®å­—å‡ºç°çš„æ¬¡æ•°ï¼Œé‚£æˆ‘å¾—é€šè¿‡æŸç§æœºåˆ¶å‘Šè¯‰ mtail æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä»€ä¹ˆï¼Œæå–è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ªè§„åˆ™æ–‡ä»¶æˆ‘ä»¬å«åš programï¼Œä¸€èˆ¬å‘½åä¸º xyz.mtailï¼Œæˆ‘ç»™å‡ºäº†ä¸€ä¸ªæ ·ä¾‹ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p><pre><code class=\"language-yaml\"># åœ¨ mtail äºŒè¿›åˆ¶åŒçº§ç›®å½•ä¸‹åˆ›å»º progs ç›®å½•ï¼Œä¸‹é¢æ”¾ç½® syslogs å­ç›®å½•\n# syslogs å­ç›®å½•ç”¨äºæ”¾ç½®ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶å¯¹åº”çš„æå–è§„åˆ™\nmkdir -p progs/syslogs\n\n# ç”¨äºç»Ÿè®¡ Out of memory å…³é”®å­—çš„ mtail è§„åˆ™æ–‡ä»¶å†…å®¹å¦‚ä¸‹(æˆ‘å‘½åä¸º\n# syslogs.mtail)ï¼š\ncounter oom_total\n/Out of memory/ {\n&nbsp; oom_total++\n}\n</code></pre><p>æ–‡ä»¶å†…å®¹çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œåªæœ‰ 4 è¡Œï¼Œç¬¬ä¸€è¡Œæ˜¯å£°æ˜äº†ä¸€ä¸ªå˜é‡ï¼Œç±»å‹æ˜¯ counterï¼Œå˜é‡åæ˜¯ oom_totalï¼Œç¬¬äºŒè¡Œæ˜¯åœ¨ <code>//</code> ä¹‹é—´å®šä¹‰äº†ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥åŒ¹é… Out of memoryï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œå°±æ‰§è¡Œå¤§æ‹¬å·é‡Œçš„å†…å®¹ï¼Œå¯¹ oom_total å˜é‡åŠ  1ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠ mtail è¿è¡Œèµ·æ¥ï¼Œçœ‹çœ‹æ•ˆæœå¦‚ä½•ã€‚</p><p>å¯åŠ¨å‘½ä»¤ï¼š</p><pre><code class=\"language-yaml\">./mtail -progs ./progs/syslogs/ -logs /var/log/messages\n</code></pre><p>é€šè¿‡ -progs å‚æ•°æŒ‡å®š mtail æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œå½“ç„¶ï¼ŒæŒ‡å®šå…·ä½“çš„æ–‡ä»¶ä¹Ÿå¯ä»¥ï¼Œé€šè¿‡ -logs å‚æ•°æŒ‡å®šè¦æå–çš„æ—¥å¿—æ–‡ä»¶æ˜¯å“ªä¸ªï¼Œæ”¯æŒ glob åŒ¹é…ï¼Œä¹Ÿæ”¯æŒä¼ å…¥å¤šæ¬¡ -logs å‚æ•°ã€‚mtail å¯åŠ¨ä¹‹åä¼šé»˜è®¤ç›‘å¬åœ¨ 3903 ç«¯å£ï¼Œè¯·æ±‚ 3903 çš„ <code>/metrics</code> æ¥å£å°±èƒ½æ‹¿åˆ° Prometheus åè®®çš„ç›‘æ§æ•°æ®ã€‚</p><pre><code class=\"language-yaml\">[root@fc-demo-02 qinxiaohui]# ss -tlnp|grep mtail\nLISTEN&nbsp; &nbsp; &nbsp;0&nbsp; &nbsp; &nbsp; 128&nbsp; &nbsp; &nbsp; &nbsp;[::]:3903&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [::]:*&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;users:((\"mtail\",pid=18972,fd=7))\n[root@fc-demo-02 qinxiaohui]# curl -s localhost:3903/metrics | grep oom_total\n# HELP oom_total defined at syslogs.mtail:1:9-17\n# TYPE oom_total counter\noom_total{prog=\"syslogs.mtail\"} 0\n</code></pre><p>ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œæˆ‘ä½¿ç”¨ grep å‘½ä»¤åšäº†è¿‡æ»¤ï¼Œåªå±•ç¤ºäº† oom_total ç›¸å…³çš„å†…å®¹ï¼Œå®é™…ä¸Š mtail ä¼šè¾“å‡ºå¾ˆå¤šæŒ‡æ ‡ï¼Œä½ å¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ã€‚æœ‰äº†è¿™ä¸ª /metrics æ¥å£ï¼Œæ€ä¹ˆå’Œç›‘æ§ç³»ç»Ÿå¯¹æ¥å°±å¾ˆæ˜æ˜¾äº†ï¼Œç›´æ¥ç”±æŠ“å–å™¨æ¥è¿™ä¸ªåœ°å€æŠ“å–æ•°æ®å°±å¯ä»¥äº†ã€‚ä¸‹é¢æˆ‘ä»¬ç»§ç»­è®²è§£ mtail æœ¬èº«çš„ç”¨æ³•ã€‚</p><p>ä¾‹å­é‡Œ mtail è‡ªåŠ¨åŠ äº†ä¸€ä¸ª prog æ ‡ç­¾ï¼ŒæŠŠ mtail æ–‡ä»¶åä½œä¸ºæ ‡ç­¾åŠ ä¸Šäº†ï¼Œå¯¹äºä¸€äº› access.log ç±»å‹çš„æ—¥å¿—ï¼Œç»å¸¸ç”¨äºç»Ÿè®¡æ¥å£çš„ååã€å»¶è¿Ÿç­‰ï¼Œéœ€è¦æŠŠæ¥å£è·¯å¾„ã€methodã€statuscode ç­‰ä½œä¸ºæ ‡ç­¾ï¼Œåº”è¯¥å¦‚ä½•é…ç½®å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¥ Nginx çš„ access æ—¥å¿—ä½œä¸ºæ ·ä¾‹æ¥æ¼”ç¤ºï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘çš„ Nginx çš„ logformatã€‚</p><pre><code class=\"language-yaml\">&nbsp; &nbsp; log_format&nbsp; main&nbsp; '$remote_addr - $remote_user [$time_local] \"$request\" '\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '$status $body_bytes_sent \"$http_referer\" '\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n</code></pre><p>å¯¹åº”çš„å‡ æ¡æ ·ä¾‹æ—¥å¿—å¦‚ä¸‹ï¼š</p><pre><code class=\"language-yaml\"># tail -n 5 /var/log/nginx/access.log\n119.45.249.92 - - [17/Dec/2022:22:35:39 +0800] \"GET / HTTP/1.1\" 200 14849 \"-\" \"clb-healthcheck\" \"-\"\n119.45.249.92 - - [17/Dec/2022:22:35:40 +0800] \"GET / HTTP/1.1\" 200 14849 \"-\" \"clb-healthcheck\" \"-\"\n119.45.249.92 - - [17/Dec/2022:22:35:40 +0800] \"GET / HTTP/1.1\" 200 14849 \"-\" \"clb-healthcheck\" \"-\"\n119.45.249.92 - - [17/Dec/2022:22:35:41 +0800] \"GET / HTTP/1.1\" 200 14849 \"-\" \"clb-healthcheck\" \"-\"\n119.45.249.92 - - [17/Dec/2022:22:35:41 +0800] \"GET / HTTP/1.1\" 200 14849 \"-\" \"clb-healthcheck\" \"-\"\n</code></pre><p>è¿™ä¸ª logformat ç€å®ç®€å•ï¼Œè¿å“åº”å»¶è¿Ÿéƒ½æ²¡æœ‰æ‰“å°ï¼Œè¿™æ˜¯ Nginx é»˜è®¤çš„ logformatï¼Œæˆ‘ä»¬ä¹Ÿå…ˆç»´æŒç°çŠ¶ï¼Œç»Ÿè®¡ä¸€ä¸‹è¯·æ±‚æ•°é‡ä»¥åŠå“åº”ä½“çš„å¤§å°ï¼Œä¸‹é¢æ˜¯å…·ä½“çš„ mtail æ–‡ä»¶å†…å®¹ã€‚</p><pre><code class=\"language-yaml\">counter request_total by method, url, code\ncounter body_bytes_sent_total by method, url, code\n\n/\"(?P&lt;method&gt;\\S+) (?P&lt;url&gt;\\S+) HTTP\\/1.1\" (?P&lt;code&gt;\\d+) (?P&lt;body_bytes_sent&gt;\\d+)/ {\n\trequest_total[$method][$url][$code]++\n\tbody_bytes_sent_total[$method][$url][$code] += $body_bytes_sent\n}\n</code></pre><p>è¿™ä¸ªæ­£åˆ™çœ‹èµ·æ¥å°±å¤æ‚å¤šäº†ï¼Œæ¯”å¦‚è·å– statuscode çš„åœ°æ–¹å†™çš„æ­£åˆ™æ˜¯ <code>(?P&lt;code&gt;\\d+)</code>ï¼Œè¿™ä¸ªå«åš<strong>å‘½åæ•è·</strong>ï¼Œæ ¸å¿ƒçš„æ­£åˆ™å°±æ˜¯ <code>\\d+</code>ï¼Œä½†æ˜¯åé¢æƒ³ç”¨è¿™ä¸ªå†…å®¹ï¼Œå°±ç»™å®ƒè®¾ç½®äº†ä¸€ä¸ªå˜é‡å« codeï¼Œè€Œ methodã€urlã€body_bytes_sent éƒ½æ˜¯åŒæ ·çš„é“ç†ã€‚</p><p>åŒ¹é…äº†æ­£åˆ™ä¹‹åï¼Œåšäº†ä¸¤ä¸ªåŠ¨ä½œï¼Œrequest_total å˜é‡åŠ ä¸€ï¼Œç›¸å½“äºåœ¨ç»Ÿè®¡è¯·æ±‚æ¬¡æ•°ï¼Œbody_bytes_sent_total å˜é‡åŠ ä¸Šæ—¥å¿—è¿™è¡Œæå–çš„ $body_bytes_sent å˜é‡çš„å€¼ï¼Œæ˜¯åœ¨ç»Ÿè®¡å“åº”æ€»å¤§å°ã€‚</p><p>è¿™é‡Œ request_total å’Œ body_bytes_sent_total è¿™ä¸¤ä¸ªæŒ‡æ ‡éƒ½æ˜¯å¸¦æœ‰æ ‡ç­¾çš„ï¼Œä¸”éƒ½æ˜¯ 3 ä¸ªæ ‡ç­¾ï¼šmethodã€urlã€codeï¼Œå£°æ˜ä¹‹åå°±å¯ä»¥ä½¿ç”¨ï¼Œé€šè¿‡å‘½åæ•è·çš„æ–¹å¼ç»™çš„å˜é‡åä¹Ÿå¯ä»¥åœ¨åé¢ä½¿ç”¨ï¼Œéå¸¸çµæ´»ã€‚ä¸‹é¢æ˜¯æµ‹è¯•è¾“å‡ºã€‚</p><pre><code class=\"language-yaml\"># é€šè¿‡ä¸‹é¢çš„å‘½ä»¤åŠ è½½ nginx çš„ mtailï¼ŒæŒ‡å®š nginx çš„ access.log\n./mtail -progs ./progs/nginx/ -logs /var/log/nginx/access.log\n\n# ä¸‹é¢è¯·æ±‚ä¸€ä¸‹ /metrics æ¥å£ï¼Œçœ‹çœ‹æ˜¯å¦é‡‡é›†æˆåŠŸ\n[root@fc-demo-02 qinxiaohui]# curl -s localhost:3903/metrics | grep -P 'request_total|body_bytes_sent_total'\n# HELP body_bytes_sent_total defined at nginx.mtail:2:9-29\n# TYPE body_bytes_sent_total counter\nbody_bytes_sent_total{code=\"200\",method=\"GET\",prog=\"nginx.mtail\",url=\"/\"} 1.143373e+06\n# HELP request_total defined at nginx.mtail:1:9-21\n# TYPE request_total counter\nrequest_total{code=\"200\",method=\"GET\",prog=\"nginx.mtail\",url=\"/\"} 77\n</code></pre><p>çœ‹èµ·æ¥ä¸€åˆ‡æ­£å¸¸ï¼Œä¸Šé¢è¿™äº›æ ‡ç­¾éƒ½æ˜¯ä»æ—¥å¿—ä¸­ç›´æ¥æå–çš„ï¼Œå¦‚æœæˆ‘æƒ³é™„åŠ ä¸€äº›é™æ€æ ‡ç­¾åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿæ¯”å¦‚æŠŠæœºæˆ¿ä¿¡æ¯ä½œä¸ºæ ‡ç­¾é™„åˆ°æ—¶åºæ•°æ®ä¸Šï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹æ ·ä¾‹ã€‚</p><pre><code class=\"language-yaml\">hidden text zone\nzone = \"beijing\"\n\ncounter request_total by method, url, code, zone\ncounter body_bytes_sent_total by method, url, code, zone\n\n/\"(?P&lt;method&gt;\\S+) (?P&lt;url&gt;\\S+) HTTP\\/1.1\" (?P&lt;code&gt;\\d+) (?P&lt;body_bytes_sent&gt;\\d+)/ {\n\trequest_total[$method][$url][$code][zone]++\n\tbody_bytes_sent_total[$method][$url][$code][zone] += $body_bytes_sent\n}\n</code></pre><p>è¿™é‡ŒåŠ äº†ä¸€ä¸ªå…¨å±€çš„ zone=â€œbeijingâ€ çš„æ ‡ç­¾ï¼Œå†™æ³•ä¸€ç›®äº†ç„¶ï¼Œä¸è¿‡å¤šè§£é‡Šã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯åœ¨å¼•ç”¨ zone å˜é‡çš„æ—¶å€™ï¼Œå‰é¢ä¸è¦åŠ  <code>$</code> ç¬¦å·ã€‚è¿™é‡Œåƒä¸‡åˆ«å†™é¡ºæ‰‹äº†ï¼Œçœ‹åˆ°å…¶ä»–å˜é‡éƒ½åŠ  <code>$</code> å°±æŠŠ zone ä¹ŸåŠ ä¸Šäº†ï¼ŒåŠ ä¸Šå°±è¯†åˆ«ä¸äº†äº†ã€‚</p><p>ä¸Šé¢ä¸¤ä¸ªä¾‹å­æ¼”ç¤ºçš„éƒ½æ˜¯ Counter ç±»å‹çš„å˜é‡ï¼Œå…¶å® mtail è¿˜æ”¯æŒ Gauge å’Œ Histogram ç±»å‹ï¼Œå¹¶ä¸”åœ¨ä»“åº“çš„ <a href=\"https://github.com/google/mtail/tree/main/examples\">examples</a> ç›®å½•ä¸‹æä¾›äº†å¾ˆå¤šæ ·ä¾‹ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼Œæ³¨æ„ Histogram ç±»å‹åœ¨å®šä¹‰çš„æ—¶å€™è¦ç»™å‡º Bucket çš„åˆ†å¸ƒèŒƒå›´ï¼Œè¦ä¸ç„¶ mtail ä¸çŸ¥é“å¦‚ä½•æ”¾ç½®ç»Ÿè®¡æ•°æ®ï¼Œè¿™ä¸ªåº”è¯¥ä¹Ÿå®¹æ˜“ç†è§£ï¼Œå¦‚æœæœ‰ç–‘é—®å¯ä»¥è¿”å›å‰é¢<a href=\"https://time.geekbang.org/column/article/620800\">ç¬¬ 2 è®²</a>ï¼Œå†å›é¡¾ä¸€ä¸‹ Histogram ç±»å‹çš„è®²è§£ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç”Ÿäº§çº§çš„ä¾‹å­ï¼Œç”¨äºåˆ†æ lighttpd çš„è®¿é—®æ—¥å¿—ï¼Œæˆ‘ä»¬ä»ä¸­å¯ä»¥å­¦åˆ°æ›´å¤šç”Ÿäº§çº§çš„å†™æ³•ã€‚</p><pre><code class=\"language-yaml\"># Copyright 2010 Google Inc. All Rights Reserved.\n# This file is available under the Apache license.\n\n# mtail module for a lighttpd server\n\ncounter request by status\ncounter time_taken by status\ncounter bytes_out by subtotal, status\ncounter bytes_in by status\ncounter requests by proxy_cache\n\n\n\nconst ACCESSLOG_RE // +\n&nbsp; &nbsp; /(?P&lt;proxied_for&gt;\\S+) (?P&lt;request_ip&gt;\\S+) (?P&lt;authuser&gt;\\S+)/ +\n&nbsp; &nbsp; / \\[(?P&lt;access_time&gt;[^\\]]+)\\] \"(?P&lt;http_method&gt;\\S+) (?P&lt;url&gt;.+?) / +\n&nbsp; &nbsp; /(?P&lt;protocol&gt;\\S+)\" (?P&lt;status&gt;\\d+) (?P&lt;bytes_body&gt;\\d+) (?P&lt;bytes_in&gt;\\d+)/ +\n&nbsp; &nbsp; / (?P&lt;bytes_out&gt;\\d+) (?P&lt;time_taken&gt;\\d+) \"(?P&lt;referer&gt;[^\"]+)\" / +\n&nbsp; &nbsp; /\"(?P&lt;agent&gt;[^\"]+)\"/\n\n\n\n# /var/log/lighttpd/access.log\ngetfilename() =~ /lighttpd.access.log/ {\n&nbsp; // + ACCESSLOG_RE {\n&nbsp; &nbsp; # Parse an accesslog entry.\n&nbsp; &nbsp; $url == \"/healthz\" {\n&nbsp; &nbsp; &nbsp; # nothing\n&nbsp; &nbsp; }\n&nbsp; &nbsp; otherwise {\n&nbsp; &nbsp; &nbsp; strptime($access_time, \"02/Jan/2006:15:04:05 -0700\")\n\n&nbsp; &nbsp; &nbsp; request[$status]++\n&nbsp; &nbsp; &nbsp; time_taken[$status] += $time_taken\n&nbsp; &nbsp; &nbsp; bytes_out[\"resp_body\", $status] += $bytes_body\n&nbsp; &nbsp; &nbsp; bytes_out[\"resp_header\", $status] += $bytes_out - $bytes_body\n&nbsp; &nbsp; &nbsp; bytes_in[$status] += $bytes_in\n\n&nbsp; &nbsp; &nbsp; $proxied_for != \"-\" {\n&nbsp; &nbsp; &nbsp; &nbsp; requests[$request_ip]++\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp; }\n}\n</code></pre><p>è¿™ä¸ª program ä¸€å¼€å§‹ï¼Œå®šä¹‰äº†å¾ˆå¤š counter ç±»å‹çš„å˜é‡ï¼Œè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆæ–°çŸ¥è¯†ï¼Œç•¥è¿‡ã€‚ç„¶åå®šä¹‰äº†ä¸€ä¸ªå¸¸é‡ ACCESSLOG_REï¼Œè¿™ä¸ªæ­£åˆ™å¾ˆå¤æ‚ï¼Œå¯¹äºè¿™ç±»å¤æ‚çš„æ­£åˆ™ï¼Œå¯ä»¥æ‹†æˆå¾ˆå¤šä¸ªå°çš„éƒ¨åˆ†ï¼Œç›¸äº’ä¹‹é—´ç”¨ + è¿æ¥ï¼Œè¿™ç§åšæ³•æ—¢å®¹æ˜“é˜…è¯»ï¼Œåˆå®¹æ˜“ä¸ºæ¯ä¸ªç‰‡æ®µå¢åŠ æ³¨é‡Šï¼Œä¾¿äºåæœŸç»´æŠ¤ï¼Œåé¢ä»‹ç»çš„ grok_exporter åˆ™æ›´è¿›ä¸€æ­¥ï¼ŒæŠŠè¿™äº›æ­£åˆ™ç‰‡æ®µç›´æ¥åšæˆ pattern å•ç‹¬ç»´æŠ¤äº†ã€‚</p><p>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œgetfilename() æ˜¯ä¸ªå†…ç½®å‡½æ•°ï¼Œè·å–æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ï¼Œå¯¹è¿™ä¸ªå†…å®¹åšäº†ä¸€ä¸ªæ­£åˆ™åˆ¤æ–­ï¼Œå¦‚æœåŒ¹é…æ‰å»èµ°æ ¸å¿ƒé€»è¾‘ï¼Œè¿™é‡Œæ˜¯ä¸æ˜¯æœ‰äº›å¤šæ­¤ä¸€ä¸¾äº†å‘¢ï¼Ÿæˆ‘çŒœæµ‹ï¼Œè¿™ä¸ªå†™æ³•çš„åˆè¡·æ˜¯è§‰å¾—è¿™æ®µå†…å®¹å¯èƒ½ä¼šå’Œå…¶ä»–çš„æå–è§„åˆ™æ··åœ¨ä¸€èµ·ï¼ŒåŒæ—¶æå–å¤šä¸ªæ—¥å¿—æ–‡ä»¶æ—¶ï¼Œä¸ºäº†é¿å…è¿™æ®µé€»è¾‘è·‘åœ¨ä¸€äº›æ— å…³çš„æ—¥å¿—ä¸Šï¼Œå°±åŠ äº†è¿™ä¹ˆä¸€å¥åˆ¤æ–­ï¼Œè€ƒè™‘å¾—å¾ˆå‘¨å…¨ã€‚ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ä¿è¯è¿™æ®µé€»è¾‘åªç”¨äºå¤„ç† lighttpd çš„è®¿é—®æ—¥å¿—ï¼Œè¿™ä¸ªåˆ¤æ–­å°±æ˜¯å¯ä»¥å»æ‰çš„ã€‚</p><p>getfilename() çš„åˆ¤æ–­é€šè¿‡ä¹‹åï¼Œå°±å¼€å§‹æ ¡éªŒä¸»æ­£åˆ™äº†ã€‚ä¸»æ­£åˆ™åŒ¹é…å°±å¼€å§‹åˆ¤æ–­è¯·æ±‚çš„ url æ˜¯ä¸æ˜¯ <code>/healthz</code>ï¼Œå¦‚æœæ˜¯å°±ä»€ä¹ˆéƒ½ä¸å¹²ï¼ˆç©ºé€»è¾‘ï¼‰ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯å¥åº·æ£€æŸ¥çš„æ¥å£ï¼Œæ²¡å¿…è¦æå–æŒ‡æ ‡ã€‚å¦åˆ™è¿›è¡Œä¸»é€»è¾‘å¤„ç†ï¼Œâ€œå¦åˆ™â€çš„å…³é”®è¯æ˜¯ otherwiseï¼Œç›¸å½“äº elseã€‚ä¸»é€»è¾‘éƒ¨åˆ†ä½ åº”è¯¥ä¸€çœ¼å°±èƒ½æ˜ç™½æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæ ¸å¿ƒç‚¹æ˜¯è¿™ä¸ª strptime å‡½æ•°ï¼Œå®ƒå…¶å®æ˜¯åœ¨å‘Šè¯‰ mtail ç”¨ä»€ä¹ˆæ—¶é—´æ ¼å¼æ¥è½¬æ¢æ—¶é—´æˆ³ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ Go å†™æ³•çš„ format patternï¼Œè¿™äº›å…¶å®éƒ½å¥½ç†è§£ï¼Œæ¯”è¾ƒå®¹æ˜“æ‰å‘é‡Œçš„æ˜¯<strong>æ—¶åŒºé—®é¢˜</strong>ã€‚</p><p>å¦‚æœæ—¥å¿—é‡Œçš„æ—¶é—´æˆ³æ²¡æœ‰æ‰“å°æ—¶åŒºä¿¡æ¯ï¼Œmtail åœ¨å¤„ç†çš„æ—¶å€™ä¼šæŠŠå®ƒä»¬ç»Ÿä¸€å½“åš UTC æ—¶é—´æ¥å¯¹å¾…ï¼Œè¿™åœ¨å…¶ä»–æ—¶åŒºçš„åœºæ™¯æ˜¾ç„¶æ˜¯é”™è¯¯çš„ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦æ‰‹å·¥æŒ‡å®šæ—¶åŒºï¼Œæ¯”å¦‚é€šè¿‡ <code>-override_timezone=Asia/Shanghai</code> å¯åŠ¨å‚æ•°å¯ä»¥è®© mtail ä½¿ç”¨ä¸œå…«åŒºã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬å‹æ ¹å°±ä¸åœ¨ <code>/metrics</code> æ¥å£ä¸­æš´éœ²æ—¶é—´æˆ³ä¿¡æ¯ï¼Œé‚£æŠ“å–å™¨æŠ“å–æ•°æ®çš„æ—¶å€™åªèƒ½ä½¿ç”¨æŠ“å–çš„æ—¶é—´ï¼Œæ—¶åŒºè¿™ä¸ªå‚æ•°æœ‰æ²¡æœ‰éƒ½æ— æ‰€è°“äº†ï¼Œä½†å¦‚æœæˆ‘ä»¬åœ¨ <code>/metrics</code> æ¥å£ä¸­è¿”å›æ—¶é—´æˆ³ä¿¡æ¯ï¼Œå°±ä¸€å®šè¦åœ¨å¯åŠ¨å‚æ•°ä¸­æ§åˆ¶æ—¶åŒºï¼Œæ˜¯å¦åœ¨ <code>/metrics</code> æ¥å£ä¸­è¿”å›æ—¶é—´æˆ³ä¿¡æ¯ï¼Œä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªå¯åŠ¨å‚æ•°æ¥æ§åˆ¶çš„ï¼Œ<code>emit_metric_timestamp</code> è®¾ç½®ä¸º true çš„æ—¶å€™æ‰ä¼šè¿”å›æ—¶é—´æˆ³ã€‚</p><p>æœ€åè¯´ä¸€ä¸‹ mtail çš„éƒ¨ç½²ï¼Œå¦‚æœä¸€ä¸ªæœºå™¨ä¸Šæœ‰ 5 ä¸ªåº”ç”¨ç¨‹åºéƒ½è¦ç”¨ mtail æ¥æå–æŒ‡æ ‡ï¼Œå„ä¸ªåº”ç”¨çš„æ—¥å¿—æ ¼å¼åˆä¸ä¸€æ ·ï¼Œå»ºè®®å¯åŠ¨ 5 ä¸ª mtail è¿›ç¨‹åˆ†åˆ«æ¥å¤„ç†ã€‚è™½ç„¶ç®¡ç†èµ·æ¥éº»çƒ¦ï¼Œä½†æ˜¯æ€§èƒ½å¥½ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰å½±å“ã€‚</p><p>å¦‚æœæŠŠæ‰€æœ‰æå–è§„åˆ™éƒ½æ”¾åˆ°ä¸€ä¸ªç›®å½•ä¸‹ï¼Œç„¶åé€šè¿‡å¤šæ¬¡ -logs å‚æ•°çš„æ–¹å¼åŒæ—¶æŒ‡å®šè¿™å¤šä¸ªåº”ç”¨çš„æ—¥å¿—è·¯å¾„ï¼Œä¸€ä¸ª mtail è¿›ç¨‹ä¹Ÿèƒ½å¤„ç†ï¼Œä½†æ˜¯å¯¹äºæ¯ä¸€è¡Œæ—¥å¿—ï¼Œmtail è¦æŠŠæ‰€æœ‰æå–è§„åˆ™éƒ½è·‘ä¸€éï¼Œååˆ†æµªè´¹æ€§èƒ½ï¼Œè€Œä¸”æ­£åˆ™æå–ï¼Œé€Ÿåº¦æœ¬æ¥å°±ä¸å¿«ã€‚å¦å¤–æœ‰äº›æŒ‡æ ‡å¯èƒ½æ˜¯æ‰€æœ‰åº”ç”¨éƒ½å¯ä»¥å¤ç”¨çš„ï¼Œå¦‚æœæ”¾åœ¨ä¸€èµ·å¤„ç†ï¼Œè¿˜å®¹æ˜“ç›¸äº’å¹²æ‰°ï¼Œå¯¼è‡´ç»Ÿè®¡æ•°æ®ä¸å‡†ã€‚ä»è¿™ä¸¤ç‚¹æ¥çœ‹ï¼Œå°½é‡è¿˜æ˜¯è¦æ‹†å¼€åˆ†åˆ«å¤„ç†ï¼Œè™½ç„¶ç®¡ç†èµ·æ¥éº»çƒ¦ä¸€äº›ï¼Œä½†ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚</p><p>åœ¨å®¹å™¨åœºæ™¯ä¸­å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œå®¹å™¨åœºæ™¯ç›´æ¥ä½¿ç”¨ sidecar éƒ¨ç½²å°±å¥½äº†ï¼Œæ¯ä¸ª Pod å¿…ç„¶åªæœ‰ä¸€ä¸ªåº”ç”¨ï¼Œä¼´ç”Ÿçš„ mtail å°±ä¸“æ³¨å»å¤„ç†è¿™ä¸ªåº”ç”¨çš„æ—¥å¿—å°±å¥½äº†ã€‚</p><blockquote>\n<p><span class=\"reference\">ğŸ’¡ å»¶ä¼¸è®¨è®ºï¼šç‰©ç†æœºå¤§æ¦‚ç‡ä¼šæœ‰æ··éƒ¨ 5 ä¸ªç”šè‡³ 50 ä¸ªæœåŠ¡çš„åœºæ™¯ï¼Œå®¹å™¨åˆå¿…ç„¶æ˜¯ä¸€ä¸ªæœåŠ¡ä¸€ä¸ª Podï¼Œé‚£è™šæ‹Ÿæœºå‘¢ï¼Ÿåšæˆå¤§è§„æ ¼çš„å¥½ï¼Œè¿˜æ˜¯å°è§„æ ¼çš„å¥½å‘¢ï¼Ÿæ˜¯æœ‰æ··éƒ¨å¥½è¿˜æ˜¯æ²¡æœ‰æ··éƒ¨å¥½å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€åˆ†äº«ä½ çš„è§è§£ã€‚</span></p>\n</blockquote><p>mtail åŸºæœ¬ç”¨æ³•æˆ‘ä»¬å°±ä»‹ç»è¿™ä¹ˆå¤šï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ„Ÿå—åˆ°ï¼Œå¾—å†™è¿™ä¹ˆå¤šæ­£åˆ™ï¼Œå¤ªéº»çƒ¦äº†ã€‚æœ‰æ²¡æœ‰ä¸€äº›å·¥å…·å¯ä»¥å¤ç”¨è¿™äº›æ­£åˆ™è¡¨è¾¾å¼å‘¢ï¼Ÿæ¯•ç«Ÿæœ‰å¾ˆå¤šç›¸åŒçš„æ­£åˆ™éœ€æ±‚ï¼Œæ²¡å¿…è¦é‡å¤é€ è½®å­ã€‚çš„ç¡®æœ‰ï¼Œé™¤äº†åˆšæ‰ä»‹ç»çš„ mtail è‡ªå¸¦çš„ <a href=\"https://github.com/google/mtail/tree/main/examples\">examples</a> ä¹‹å¤–ï¼Œgrok_exporter æŠŠæ¯ä¸ªæ­£åˆ™éƒ½æ‹†æ•£äº†ï¼Œå¤ç”¨æ€§æ›´å¥½ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ grok_exporter æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</p><h2>å¿«é€Ÿä¸Šæ‰‹grok_exporter</h2><p>grok_exporter çš„æ ¸å¿ƒé€»è¾‘å’Œ mtail ä¸€æ ·ï¼Œå°±æ˜¯é€šè¿‡æ­£åˆ™ä»æ—¥å¿—ä¸­æå–æŒ‡æ ‡ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»ä»‹ç»è¿‡ mtail çš„æ ¸å¿ƒé€»è¾‘äº†ï¼Œæ‰€ä»¥å…³äºgrok_exporter çš„ä»‹ç»ä¼šç›¸å¯¹ç®€æ˜ä¸€äº›ã€‚</p><p>grok_exporter æ˜¾ç„¶æ˜¯ç”¨åˆ°äº† Grokï¼ŒGrok åœ¨ logstash ä¸­è¢«é‡åº¦ä½¿ç”¨ï¼Œå†…ç½®äº† 100 å¤šä¸ªé¢„å®šä¹‰çš„æ­£åˆ™ï¼ˆå«åš patternï¼‰ï¼Œåœ¨ grok_exporter çš„ä»£ç ä»“åº“é‡Œç›´æ¥ä½œä¸º submodule çš„æ–¹å¼å¼•ç”¨äº† <a href=\"https://github.com/logstash-plugins/logstash-patterns-core/tree/6d25c13c15f98843513f7cdc07f0fb41fbd404ef\">logstash-patterns-core</a>ï¼Œé¢„å®šä¹‰çš„æ­£åˆ™æ”¾åœ¨äº† <a href=\"https://github.com/logstash-plugins/logstash-patterns-core/tree/6d25c13c15f98843513f7cdc07f0fb41fbd404ef/patterns\">patterns</a> ç›®å½•ä¸‹ï¼Œä½ å¯ä»¥ç‚¹å‡»æŸ¥é˜…ã€‚</p><p>ä» grok_exporter çš„ <a href=\"https://github.com/fstab/grok_exporter/releases\">releases</a> é¡µé¢ä¸‹è½½å‘å¸ƒåŒ…ï¼Œè§£å‹ç¼©ï¼Œç›´æ¥è¿è¡Œå°±å¯ä»¥ã€‚</p><pre><code class=\"language-yaml\">./grok_exporter -config ./example/config.yml\n</code></pre><p>grok_exporter é»˜è®¤ç›‘å¬åœ¨ 9144 ç«¯å£ï¼Œæˆ‘ä»¬çœ‹ä¸‹è®¿é—®æµ‹è¯•æ•ˆæœã€‚</p><pre><code class=\"language-yaml\">[flashcat@fc-demo-02 ~]$ curl -s 10.100.0.7:9144/metrics | head -n 6\n# HELP exim_rejected_rcpt_total Total number of rejected recipients, partitioned by error message.\n# TYPE exim_rejected_rcpt_total counter\nexim_rejected_rcpt_total{error_message=\"Sender verify failed\",logfile=\"exim-rejected-RCPT-examples.log\"} 2000\nexim_rejected_rcpt_total{error_message=\"Unrouteable address\",logfile=\"exim-rejected-RCPT-examples.log\"} 32\nexim_rejected_rcpt_total{error_message=\"relay not permitted\",logfile=\"exim-rejected-RCPT-examples.log\"} 165\n# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\n</code></pre><p>é€šè¿‡ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°grok_exporterå¯ä»¥æ­£å¸¸æ‹¿åˆ°ç›‘æ§æ•°æ®äº†ã€‚ä¸‹é¢æˆ‘ä»¬æä¸€ä¸‹æµ‹è¯•æ•°æ®ï¼ŒæŠŠå®ƒæ”¾åˆ° example ç›®å½•ä¸‹ï¼Œä¿å­˜ä¸º login.logã€‚</p><pre><code class=\"language-yaml\">12.12.2022 04:33:03 10.1.2.1 user=Ulric message=\"logged in\"\n12.12.2022 06:47:03 10.1.2.2 user=Qin message=\"logged failed\"\n12.12.2022 06:55:03 10.1.2.2 user=Qin message=\"logged in\"\n12.12.2022 07:03:03 10.1.2.3 user=Sofia message=\"logged in\"\n12.12.2022 07:37:03 10.1.2.1 user=Ulric message=\"logged out\"\n12.12.2022 08:47:03 10.1.2.2 user=Qin message=\"logged out\"\n12.12.2022 14:34:03 10.1.2.3 user=Sofia message=\"logged out\"\n</code></pre><p>ä¹‹åä¿®æ”¹ config.yml æ¥è§£ælogin.logã€‚</p><pre><code class=\"language-yaml\">global:\n&nbsp; config_version: 3\ninput:\n&nbsp; type: file\n&nbsp; path: ./example/login.log\n&nbsp; readall: true # Read from the beginning of the file? False means we start at the end of the file and read only new lines.\nimports:\n- type: grok_patterns\n&nbsp; dir: ./patterns\nmetrics:\n- type: counter\n&nbsp; name: user_activity\n&nbsp; help: Counter metric example with labels.\n&nbsp; match: '%{DATE} %{TIME} %{HOSTNAME:instance} user=%{USER:user} message=\"%{GREEDYDATA:data}\"'\n&nbsp; labels:\n&nbsp; &nbsp; user: '{{.user}}'\n&nbsp; &nbsp; logfile: '{{base .logfile}}'\nserver:\n&nbsp; protocol: http\n&nbsp; port: 9144\n</code></pre><p>ä½¿ç”¨è¿™ä¸ªæ–°çš„é…ç½®æ–‡ä»¶åšä¸ªæµ‹è¯•ï¼Œä¸‹é¢æ˜¯è¿”å›å†…å®¹ã€‚</p><pre><code class=\"language-yaml\">[flashcat@fc-demo-02 ~]$ curl -s 10.100.0.7:9144/metrics | grep user_activity\ngrok_exporter_line_processing_errors_total{metric=\"user_activity\"} 0\ngrok_exporter_lines_matching_total{metric=\"user_activity\"} 7\ngrok_exporter_lines_processing_time_microseconds_total{metric=\"user_activity\"} 106\n# HELP user_activity Counter metric example with labels.\n# TYPE user_activity counter\nuser_activity{logfile=\"login.log\",user=\"Qin\"} 3\nuser_activity{logfile=\"login.log\",user=\"Sofia\"} 2\nuser_activity{logfile=\"login.log\",user=\"Ulric\"} 2\n</code></pre><p>çœ‹èµ·æ¥ grok_exporter è¦æ¯” mtail çš„æ–¹å¼æ›´æ˜“ç”¨ï¼Œä¸è¿‡å’Œ mtail ä¸€æ ·ï¼Œå¦‚æœè¦å¯¹å¤šä¸ªåº”ç”¨ç¨‹åºåˆ†åˆ«è¿›è¡Œæ—¥å¿—åˆ†æå¤„ç†ï¼Œå°±è¦å¯åŠ¨å¤šä¸ª grok_exporter å®ä¾‹ï¼Œè¿™ç‚¹è¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚å½“ç„¶ï¼Œåœ¨è¿ç®—æ–¹é¢ï¼Œgrok_exporter æ²¡æœ‰ mtail è¿™ç§ç±»è¯­è¨€å¼çš„å¤„ç†æ¥å¾—çµæ´»æ–¹ä¾¿ã€‚è‡³äºé€‰ç”¨å“ªä¸ªï¼Œå°ºæœ‰æ‰€çŸ­å¯¸æœ‰æ‰€é•¿ï¼Œéƒ½å­¦ä¼šï¼Œå…·ä½“ä½¿ç”¨åœºæ™¯å…·ä½“å†³ç­–ã€‚è¿™ä¸€è®²æˆ‘å°±ç»™ä½ ä»‹ç»è¿™ä¹ˆå¤šï¼Œä¸‹é¢æˆ‘ä»¬åšä¸€ä¸ªæ€»ç»“ã€‚</p><h2>å°ç»“</h2><p>æˆ‘ä»¬è¿™ä¸€è®²ä»‹ç»çš„æ‰‹æ®µï¼Œä»æ ‡é¢˜ä¸Šæ¥çœ‹æ˜¯æœåŠ¡äºåº”ç”¨ç›‘æ§ï¼Œä¸è¿‡å®é™…ä¸Šä¹Ÿå¯ä»¥ç”¨äºæ“ä½œç³»ç»Ÿã€ä¸­é—´ä»¶ã€æ•°æ®åº“ç­‰å…¶ä»–ç›‘æ§åœºæ™¯ï¼Œè€Œåº”ç”¨ç›‘æ§æœ¬èº«ï¼Œåå€’ä¸æ¨èæ—¥å¿—ç›‘æ§æ–¹å¼ï¼Œè€Œæ˜¯æ›´æ¨èä¸Šä¸€è®²ä»‹ç»çš„åŸ‹ç‚¹ç›‘æ§æ–¹å¼ã€‚è¿™ä¸€ç‚¹ï¼Œè¯·ä½ ä¸€å®šè¦æ³¨æ„ï¼Œæ¯•ç«Ÿç›¸æ¯”åŸ‹ç‚¹æ–¹å¼ï¼Œæ—¥å¿—æ–¹å¼é“¾è·¯åˆé•¿ã€æ€§èƒ½åˆå·®ï¼Œç®—æ˜¯ä¸€ä¸ªä¸å¾—å·²è€Œä¸ºä¹‹çš„æ–¹å¼ã€‚</p><p>æŒ‡æ ‡æå–çš„å‡ ç§æ–¹å¼ï¼Œæ€»ä½“ä¸Šæ¥çœ‹å°±æ˜¯ä¸­å¿ƒç«¯å’Œæ—¥å¿—ç«¯ä¸¤ç§ï¼Œç”±äºä¸­å¿ƒç«¯çš„å¤„ç†æ–¹å¼å¤šè§äºå•†ä¸šè½¯ä»¶ï¼Œæ²¡æœ‰çœ‹åˆ°å¼€æºè§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹ä»‹ç»çš„æ˜¯æ—¥å¿—ç«¯çš„å¤„ç†æ–¹å¼ï¼Œæ—¥å¿—ç«¯çš„å¤„ç†æ ¸å¿ƒé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡ç±»ä¼¼  <code>tail -f</code> çš„æ–¹å¼ä¸æ–­è¯»å–æ—¥å¿—å†…å®¹ï¼Œç„¶åå¯¹æ¯è¡Œæ—¥å¿—åšæ­£åˆ™åŒ¹é…æå–ï¼Œç”±äºæ—¥å¿—æ ¼å¼ä¸å›ºå®šï¼Œå¾ˆéš¾æœ‰ç»“æ„åŒ–çš„å¤„ç†æ‰‹æ®µï¼Œæ‰€ä»¥è¿™äº›å·¥å…·éƒ½æ˜¯é€‰æ‹©ä½¿ç”¨æ­£åˆ™çš„æ–¹å¼æ¥æå–è¿‡æ»¤æŒ‡æ ‡ã€‚</p><p>mtail å’Œ grok_exporter æ˜¯æ—¥å¿—ç«¯å¤„ç†å·¥å…·çš„ä½¼ä½¼è€…ï¼Œmtail ç›´æ¥å†™æ­£åˆ™ï¼Œè™½ç„¶å¯é˜…è¯»æ€§ä¸Šç¨å¾®å·®äº†ç‚¹å„¿ï¼Œä½†æ˜¯èƒœåœ¨é€»è¾‘å¤„ç†èƒ½åŠ›ï¼Œå¯ä»¥å¯¹æå–çš„å˜é‡åšè¿ç®—ï¼Œå°±åƒä¸€é—¨å°è¯­è¨€ï¼Œæ‰€ä»¥ mtail æŠŠè¿™äº›æå–è§„åˆ™çš„æ–‡ä»¶å«åš programã€‚grok_exporter å¯ä»¥ä½¿ç”¨é¢„å®šä¹‰çš„ pattern åç§°é…ç½®åŒ¹é…è§„åˆ™ï¼Œæ›´æ˜“è¯»ã€æ˜“ç»´æŠ¤ï¼Œè¿ç®—æ–¹é¢åˆ™æ˜¾å¾—ç¨å¼±ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/47/af/4704d08fdbdb7a7af28a13d906yybeaf.jpg?wh=2659x2489\" alt=\"\"></p><h2>äº’åŠ¨æ—¶åˆ»</h2><p>ç”±äº mtail å’Œ grok_exporter éƒ½æ˜¯é€šè¿‡æ­£åˆ™æå–çš„æ–¹å¼æ¥å¤„ç†éç»“æ„åŒ–çš„æ—¥å¿—æ•°æ®çš„ï¼Œæ€§èƒ½æ˜¯ä¸ªæ¯”è¾ƒå…³é”®çš„é—®é¢˜ï¼Œå¦‚æœæ—¥å¿—é‡å¾ˆå¤§ï¼Œå¯èƒ½ä¼šä¾µèš€è¾ƒå¤šçš„æœºå™¨ç®—åŠ›ï¼Œç”šè‡³å½±å“ä¸Šé¢è¿è¡Œçš„æœåŠ¡ã€‚æœ‰æ²¡æœ‰ä»€ä¹ˆå®è·µæ–¹å¼å¯ä»¥æå‡æ€§èƒ½å‘¢ï¼Ÿæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>","comments":[{"had_liked":false,"id":369536,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"åŒ—äº¬","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1677646752,"is_pvip":false,"replies":[{"id":134681,"content":"è¯»å–æ—¥å¿—åˆ°ä¸­å¿ƒï¼Œå¤§éƒ½è¿˜æ˜¯é‡‡ç”¨EFKçš„ç”Ÿæ€ï¼›Telegraf é‡‡é›†æ•°æ®é€šè¿‡ prometheus_client æš´éœ²ï¼Œæ²¡æœ‰çœ‹åˆ°å“ªä¸ªå…¬å¸è¿™ä¹ˆç”¨ï¼Œé€šè¿‡ remotewrite å†™æ•°æ®åˆ°åç«¯å­˜å‚¨çš„å€’æ˜¯ä¸å°‘ï¼Œå¦‚æœæ˜¯pullçš„æ–¹å¼ï¼Œå¤§éƒ½è¿˜æ˜¯ä½¿ç”¨node-exporterå±…å¤š","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1677662452,"ip_address":"åŒ—äº¬","comment_id":369536,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"è®¨è®ºï¼šç‰©ç†æœºå¤§æ¦‚ç‡ä¼šæœ‰æ··éƒ¨ 5 ä¸ªç”šè‡³ 50 ä¸ªæœåŠ¡çš„åœºæ™¯ï¼Œå®¹å™¨åˆå¿…ç„¶æ˜¯ä¸€ä¸ªæœåŠ¡ä¸€ä¸ª Podï¼Œé‚£è™šæ‹Ÿæœºå‘¢ï¼Ÿåšæˆå¤§è§„æ ¼çš„å¥½ï¼Œè¿˜æ˜¯å°è§„æ ¼çš„å¥½å‘¢ï¼Ÿæ˜¯æœ‰æ··éƒ¨å¥½è¿˜æ˜¯æ²¡æœ‰æ··éƒ¨å¥½å‘¢ï¼Ÿ\n\næˆ‘è§‰å¾—å¯¹äºè™šæ‹Ÿæœºï¼Œå¤§è§„æ ¼é€‚åˆæ··éƒ¨ï¼Œå°è§„æ ¼é€‚åˆå•ç‹¬éƒ¨ç½²ã€‚å¤§è§„æ ¼æ··éƒ¨çš„è¯ï¼Œå¯ä»¥æœ€å¤§åŒ–åˆ©ç”¨èµ„æºã€‚ä¸è¿‡ï¼Œä»ç›‘æ§è§’åº¦æ¥è¯´ï¼Œæ··éƒ¨ä¼šå¯¹äºæ•°æ®ç›‘æ§å¸¦æ¥å¹²æ‰°å› ç´ ï¼Œå› ä¸ºæ··éƒ¨ç ´åäº†éš”ç¦»æ€§ã€‚\n\n\næ€è€ƒé¢˜ï¼šç”±äº mtail å’Œ grok_exporter éƒ½æ˜¯é€šè¿‡æ­£åˆ™æå–çš„æ–¹å¼æ¥å¤„ç†éç»“æ„åŒ–çš„æ—¥å¿—æ•°æ®çš„ï¼Œæ€§èƒ½æ˜¯ä¸ªæ¯”è¾ƒå…³é”®çš„é—®é¢˜ï¼Œå¦‚æœæ—¥å¿—é‡å¾ˆå¤§ï¼Œå¯èƒ½ä¼šä¾µèš€è¾ƒå¤šçš„æœºå™¨ç®—åŠ›ï¼Œç”šè‡³å½±å“ä¸Šé¢è¿è¡Œçš„æœåŠ¡\n\næˆ‘æ²¡æœ‰è¿‡å¤šçš„ä½¿ç”¨ç»éªŒï¼Œè°ˆè°ˆæˆ‘çš„æƒ³æ³•ã€‚å¯¹äºæ—¥å¿—é‡å¤§ï¼Œå¯ä»¥è€ƒè™‘åˆ†æ®µå¤„ç†ï¼Œå¯ä»¥å…ˆæŠŠæ—¥å¿—åˆ‡åˆ†æˆå¤šæ®µï¼Œç„¶åæ¯æ®µåˆ†åˆ«å¤„ç†ï¼Œå‡å°‘ä¸€æ¬¡å¤„ç†çš„æ•°æ®é‡ã€‚å¦å¤–ï¼Œä¸ºäº†æ§åˆ¶mtail å’Œ grok_exporterä¾µèš€è¾ƒå¤šçš„ç®—åŠ›ï¼Œå¯ä»¥é€šè¿‡cgroupçš„æ–¹å¼æ¥æ§åˆ¶max cpuä½¿ç”¨ç‡ã€‚\n\né—®é¢˜ï¼šè¯·é—®è€å¸ˆ Telegrafçš„ plugin logparser å’Œ tailå¯ä»¥è¯»å–logæ–‡ä»¶ï¼Œ åŒæ—¶ä¹Ÿæœ‰ prometheus_clientï¼Œå®é™…å·¥ä½œä¸­æœ‰åº”ç”¨ä¹ˆï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607189,"discussion_content":"è¯»å–æ—¥å¿—åˆ°ä¸­å¿ƒï¼Œå¤§éƒ½è¿˜æ˜¯é‡‡ç”¨EFKçš„ç”Ÿæ€ï¼›Telegraf é‡‡é›†æ•°æ®é€šè¿‡ prometheus_client æš´éœ²ï¼Œæ²¡æœ‰çœ‹åˆ°å“ªä¸ªå…¬å¸è¿™ä¹ˆç”¨ï¼Œé€šè¿‡ remotewrite å†™æ•°æ®åˆ°åç«¯å­˜å‚¨çš„å€’æ˜¯ä¸å°‘ï¼Œå¦‚æœæ˜¯pullçš„æ–¹å¼ï¼Œå¤§éƒ½è¿˜æ˜¯ä½¿ç”¨node-exporterå±…å¤š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677662452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390060,"user_name":"é‡‘é¾Ÿ","can_delete":false,"product_type":"c1","uid":1228500,"ip_address":"å››å·","ucode":"1C7D35C8AE8D9D","user_header":"https://static001.geekbang.org/account/avatar/00/12/be/d4/ff1c1319.jpg","comment_is_top":false,"comment_ctime":1714259264,"is_pvip":false,"replies":[{"id":142169,"content":"å¯ä»¥å‚è€ƒGrafanaï¼ŒæŠŠpromæˆ–è€…mysqlä½œä¸ºæ•°æ®æºï¼Œå³ï¼Œæ•°æ®åœ¨promä¸­ä¹Ÿè¡Œï¼Œåœ¨å…¶ä»–å­˜å‚¨ï¼ˆæ¯”å¦‚mysqlï¼‰ä¸­ä¹Ÿæ˜¯å¯ä»¥çš„ï¼›è·³è½¬éœ€æ±‚ï¼ŒGrafanaã€å¤œèºã€Kibana ä¸­éƒ½ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡è·³è½¬é“¾æ¥æ¥åšçš„ï¼Œè·³è½¬é“¾æ¥é‡Œå¯ä»¥ä¼ å‚ï¼Œå‚æ•°å°±æ˜¯æ¥è‡ªå½“å‰è¿™ä¸ªæ•°æ®çš„æŸä¸ªå­—æ®µã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1716775994,"ip_address":"åŒ—äº¬","comment_id":390060,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸ªå¤§ç›˜éœ€è¦æŸ¥çœ‹ æŸç§ç±»å‹ä»»åŠ¡æ•°æˆ–è€…ä»»åŠ¡çš„å¤±è´¥æ•°ï¼ˆç¬æ—¶çš„æ•°æ®ï¼‰ï¼Œè¿™ç±»æ•°æ®éƒ½æ˜¯å­˜åœ¨ä¸šåŠ¡çš„æ•°æ®åº“é‡Œé¢ï¼Œæ‰€ä»¥æœ‰2ä¸ªé—®é¢˜:\n1. ç”¨æˆ·çœ‹çš„æ•°æ®æ˜¯ç¬æ—¶çš„å¿«ç…§æ•°æ®ï¼Œä¸”æƒ³ç”¨é¥¼çŠ¶å›¾çœ‹ï¼Œä¸ç”¨æ—¶åºå›¾çœ‹ï¼Œè¿™ç±»æ•°æ®é€‚åˆè¸©åœ¨promé‡Œé¢å—ï¼Ÿ\n2. åŒæ—¶è¦é€šè¿‡è¿™ç±»ç»Ÿè®¡æ•°æ®ç‚¹å‡»è·³è½¬åˆ°è¯¦ç»†åˆ—è¡¨ï¼ˆä¸šåŠ¡çš„è¯¦ç»†åˆ—è¡¨ï¼ŒæŸ¥çœ‹å¤±è´¥ä»»åŠ¡æ•°æ˜ç»†ï¼‰ï¼Œè¿™ä¸ªåº”è¯¥æ€ä¹ˆå®ç°å¥½ï¼Œæ˜¯åœ¨ å±•ç¤ºå›¾çš„æ ‡ç­¾ä¸Šéƒ½é…ç½®ä¸ªè·³è½¬è¿æ¥?\næˆ‘ä»¬çš„ç³»ç»Ÿéƒ½è‡ªç ”å“ˆ","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":645784,"discussion_content":"å¯ä»¥å‚è€ƒGrafanaï¼ŒæŠŠpromæˆ–è€…mysqlä½œä¸ºæ•°æ®æºï¼Œå³ï¼Œæ•°æ®åœ¨promä¸­ä¹Ÿè¡Œï¼Œåœ¨å…¶ä»–å­˜å‚¨ï¼ˆæ¯”å¦‚mysqlï¼‰ä¸­ä¹Ÿæ˜¯å¯ä»¥çš„ï¼›è·³è½¬éœ€æ±‚ï¼ŒGrafanaã€å¤œèºã€Kibana ä¸­éƒ½ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡è·³è½¬é“¾æ¥æ¥åšçš„ï¼Œè·³è½¬é“¾æ¥é‡Œå¯ä»¥ä¼ å‚ï¼Œå‚æ•°å°±æ˜¯æ¥è‡ªå½“å‰è¿™ä¸ªæ•°æ®çš„æŸä¸ªå­—æ®µã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1716775994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":1228500,"avatar":"https://static001.geekbang.org/account/avatar/00/12/be/d4/ff1c1319.jpg","nickname":"é‡‘é¾Ÿ","note":"","ucode":"1C7D35C8AE8D9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":645859,"discussion_content":"1. è¿™é‡Œmysqlä½œä¸ºæ•°æ®æºæ˜¯è¦å®šæ—¶å†™åˆ°promå—ï¼Ÿ\n2.è·³è½¬é“¾æ¥?è¿™ä¸ªåœ¨å“ªå„¿é…ç½®ï¼Œæˆ‘åœ¨å¤œèºé‡Œé¢æ²¡æœ‰çœ‹åˆ°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1716905000,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":645784,"ip_address":"å››å·","group_id":0},"score":645859,"extra":""}]}]},{"had_liked":false,"id":375889,"user_name":"Geek_be4f4d","can_delete":false,"product_type":"c1","uid":2833547,"ip_address":"åŒ—äº¬","ucode":"67D6E9E7F96E2E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er67Ir89QuLrOwHU7ruZoiaLUqibvB0NibSD19UxiaPT79ZrMIC48t2a5Ohaib7Vt8qW9ez6uMicFMclAibg/132","comment_is_top":false,"comment_ctime":1686109109,"is_pvip":false,"replies":[{"id":137304,"content":"phpæ˜¯å¦æœ‰ç‰¹å®šè¯­è¨€çš„ä¸“å±æ–¹æ¡ˆæˆ‘ä¸å¤ªæ¸…æ¥šï¼Œé€šç”¨metricsæ–¹æ¡ˆçš„è¯ï¼Œå°±æ˜¯ prometheusã€statsd äº†ï¼Œtracingçš„è¯å¯ä»¥çœ‹çœ‹ otel","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1687167351,"ip_address":"åŒ—äº¬","comment_id":375889,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œåº”ç”¨ç›‘æ§æœ¬èº«ï¼Œæ¨èåŸ‹ç‚¹æ–¹å¼å®ç°ï¼Œè¯·é—®phpæœ‰ä»€ä¹ˆå¥½ç”¨çš„sdkæ¥å®ç°åŸ‹ç‚¹ç›‘æ§å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621372,"discussion_content":"phpæ˜¯å¦æœ‰ç‰¹å®šè¯­è¨€çš„ä¸“å±æ–¹æ¡ˆæˆ‘ä¸å¤ªæ¸…æ¥šï¼Œé€šç”¨metricsæ–¹æ¡ˆçš„è¯ï¼Œå°±æ˜¯ prometheusã€statsd äº†ï¼Œtracingçš„è¯å¯ä»¥çœ‹çœ‹ otel","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1687167351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":375875,"user_name":"å‹‡æ•¢é»„ç“œ","can_delete":false,"product_type":"c1","uid":1150783,"ip_address":"å¹¿ä¸œ","ucode":"3B6005B4A2CAB8","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/3f/684f858e.jpg","comment_is_top":false,"comment_ctime":1686099845,"is_pvip":false,"replies":[{"id":137305,"content":"lokiæ˜¯å¯ä»¥åšä¸­å¿ƒç«¯ç›‘æ§çš„ï¼ŒEFKçš„è¯ä¸€èˆ¬æ˜¯é…åˆå¼€æºçš„elastalert","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1687167400,"ip_address":"åŒ—äº¬","comment_id":375875,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"è¯·æ•™ä¸‹è€å¸ˆï¼Œæ–‡ä¸­è¯´çš„ä¸­å¿ƒç«¯ç›‘æ§æ—¥å¿—æ–¹æ¡ˆæ²¡æœ‰å¼€æºï¼ŒEFKæˆ–è€…lokiç®—å—","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":621374,"discussion_content":"lokiæ˜¯å¯ä»¥åšä¸­å¿ƒç«¯ç›‘æ§çš„ï¼ŒEFKçš„è¯ä¸€èˆ¬æ˜¯é…åˆå¼€æºçš„elastalert","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687167400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1000015,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","nickname":"åˆåŒå’å•æ˜¯ä¸€å¹´å•Š","note":"","ucode":"E067320E537DEE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":630433,"discussion_content":"lokiæœ‰æ—¥å¿—å‘Šè­¦ç»„ä»¶ï¼Ÿ elasalertå¯ä»¥å¯¹æ¥ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1698414473,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":621374,"ip_address":"æ²³åŒ—","group_id":0},"score":630433,"extra":""}]}]},{"had_liked":false,"id":369175,"user_name":"Kevin","can_delete":false,"product_type":"c1","uid":1315379,"ip_address":"åŒ—äº¬","ucode":"566BD76987E32F","user_header":"https://static001.geekbang.org/account/avatar/00/14/12/33/52b11198.jpg","comment_is_top":false,"comment_ctime":1677203747,"is_pvip":true,"replies":[{"id":134504,"content":"etcdç›´æ¥æš´éœ²prometheusåè®®çš„ç›‘æ§æ•°æ®ï¼Œä½¿ç”¨input.prometheusç›´æ¥æŠ“å°±å¥½äº†ï¼ŒKubernetesç›‘æ§ç« èŠ‚å…¶å®ä»‹ç»è¿‡å¦‚ä½•é‡‡é›†etcdçš„æ•°æ®äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1677220938,"ip_address":"åŒ—äº¬","comment_id":369175,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"çœ‹äº†ä¸‹ç›®å½•ï¼Œè¿™æ˜¯æŒ‡æ ‡æœé›†çš„æœ€åä¸€ç« äº†ã€‚æƒ³é—®ä¸‹ï¼Œcategrafæ²¡æœ‰åšetcdçš„æŒ‡æ ‡é‡‡é›†å—ï¼Ÿçœ‹confç›®å½•ä¸‹æ²¡æœ‰input.etcdç›®å½•","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606565,"discussion_content":"etcdç›´æ¥æš´éœ²prometheusåè®®çš„ç›‘æ§æ•°æ®ï¼Œä½¿ç”¨input.prometheusç›´æ¥æŠ“å°±å¥½äº†ï¼ŒKubernetesç›‘æ§ç« èŠ‚å…¶å®ä»‹ç»è¿‡å¦‚ä½•é‡‡é›†etcdçš„æ•°æ®äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677220938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369035,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1677035428,"is_pvip":false,"replies":[{"id":134427,"content":"1ï¼Œéœ€è¦ä¿å­˜ï¼ŒæŒ‡æ ‡æ˜¯ç»Ÿè®¡æ•°æ®ï¼Œæ—¥å¿—æ˜¯ç»†èŠ‚\n2ï¼Œè™šæ‹Ÿæœºå¯¹äºç”¨æˆ·æ¥è¯´è·Ÿæ­£å¸¸çš„æœºå™¨æ²¡å•¥å¤ªå¤§åŒºåˆ«ã€‚ã€‚ã€‚ã€‚\n3ï¼Œæ²¡æ³•é€šè¿‡æ³¨å†Œç”¨æˆ·é‡è¡¡é‡ï¼Œæ ¹æ®ç›‘æ§ç›®æ ‡è¡¡é‡","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1677061014,"ip_address":"åŒ—äº¬","comment_id":369035,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š\nQ1ï¼šåº”ç”¨ä¿å­˜æ—¥å¿—è¿˜æœ‰ç”¨å—ï¼Ÿ\næ—¢ç„¶å¯¹äºåº”ç”¨çš„ç›‘æ§æ¨èä½¿ç”¨åŸ‹ç‚¹æ–¹å¼ï¼Œä¸æ¨èä½¿ç”¨æ—¥å¿—æ–¹å¼ã€‚é‚£ä¹ˆï¼Œå¯¹äºåº”ç”¨ï¼Œè¿˜æœ‰å¿…è¦æ‰“å°ã€ä¿å­˜æ—¥å¿—å—ï¼Ÿå°¤å…¶æ˜¯çº¿ä¸Šç¯å¢ƒã€‚\nQ2ï¼šç”¨äº‘æœåŠ¡çš„è¯ï¼Œä¸€èˆ¬æ˜¯è™šæ‹Ÿæœºï¼Œcategrafæ€ä¹ˆéƒ¨ç½²åˆ°æœºå™¨ä¸Šï¼Ÿæœºå™¨æ˜¯è™šæ‹Ÿçš„ï¼Œæ˜¯ä¸ç¡®å®šçš„å®ä½“ï¼Œæ€ä¹ˆæŠŠcategraféƒ¨ç½²åˆ°ç‰¹å®šçš„æœºå™¨ä¸Šå•Šã€‚\nQ3ï¼šæ³¨å†Œç”¨æˆ·100ä¸‡çš„ç½‘ç«™ï¼Œé€‚åˆç”¨ä»€ä¹ˆç›‘æ§ï¼Ÿ\né€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæ„Ÿè§‰Prometheusé€‚åˆæ¯”è¾ƒå¤§çš„è§„æ¨¡çš„ç½‘ç«™ã€‚é‚£ä¹ˆï¼Œå¯¹äºæ³¨å†Œç”¨æˆ·100ä¸‡çš„ç½‘ç«™ï¼Œæ˜¯ä¸æ˜¯æœ‰æ›´åˆé€‚çš„ç›‘æ§æ–¹æ¡ˆï¼Ÿï¼ˆæ³¨1ï¼šå¯¹äºç½‘ç«™è§„æ¨¡å¤§å°ï¼Œæˆ‘ä¸å¾ˆæ¸…æ¥šï¼›100ä¸‡ç”¨æˆ·çš„è§„æ¨¡ï¼Œç®—å¤§è¿˜æ˜¯å°ï¼Œä¸æ¸…æ¥šï¼Œåªæ˜¯ä¸ªäººè‡†æµ‹ï¼› æ³¨2ï¼š ä¹Ÿè®¸Prometheusä¹Ÿé€‚åˆå°è§„æ¨¡çš„ç½‘ç«™ï¼‰","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606298,"discussion_content":"1ï¼Œéœ€è¦ä¿å­˜ï¼ŒæŒ‡æ ‡æ˜¯ç»Ÿè®¡æ•°æ®ï¼Œæ—¥å¿—æ˜¯ç»†èŠ‚\n2ï¼Œè™šæ‹Ÿæœºå¯¹äºç”¨æˆ·æ¥è¯´è·Ÿæ­£å¸¸çš„æœºå™¨æ²¡å•¥å¤ªå¤§åŒºåˆ«ã€‚ã€‚ã€‚ã€‚\n3ï¼Œæ²¡æ³•é€šè¿‡æ³¨å†Œç”¨æˆ·é‡è¡¡é‡ï¼Œæ ¹æ®ç›‘æ§ç›®æ ‡è¡¡é‡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677061014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369093,"user_name":"åˆ˜æ¶›","can_delete":false,"product_type":"c1","uid":1827023,"ip_address":"å¹¿ä¸œ","ucode":"ED3B715A686F1A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyjXibFIGsSeb2O9NFzKubgF2QgNNiaRhFpJmn1WsXqKrOwicQrmCtHUUyBpDV3eRf6U3V52gRiaTG5A/132","comment_is_top":false,"comment_ctime":1677110672,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"ä¸­å¿ƒå¤„ç†ï¼Œfilebeat kafka flink","like_count":2},{"had_liked":false,"id":379208,"user_name":"ä¸ç»æ„é—´","can_delete":false,"product_type":"c1","uid":1261493,"ip_address":"åŒ—äº¬","ucode":"C39D98697ACB8B","user_header":"https://static001.geekbang.org/account/avatar/00/13/3f/b5/5fe77e16.jpg","comment_is_top":false,"comment_ctime":1691551095,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"å…³äºäº’åŠ¨é—®é¢˜ï¼Œæœ‰æ–¹æ³•å¯ä»¥å¯¹æ—¥å¿—å†…å®¹å»åå—ï¼Œå¯¹äºçœ‹æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—çš„æƒ…å†µã€‚\nå¯¹äºcounteråº”è¯¥å°±ä¸è¡Œäº†ï¼Œå®ƒå¾—è®¡æ•°ã€‚","like_count":0},{"had_liked":false,"id":369066,"user_name":"æ—é¾","can_delete":false,"product_type":"c1","uid":1766285,"ip_address":"å¹¿ä¸œ","ucode":"61A98DC0DC1E8A","user_header":"https://static001.geekbang.org/account/avatar/00/1a/f3/8d/402e0e0f.jpg","comment_is_top":false,"comment_ctime":1677055306,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"ç”±äºé¡¹ç›®ä¸­å·²ç»æ­å»ºäº†opentraceingé“¾è·¯ï¼ŒæŠŠæ•°æ®åŠ è½½åˆ°prometheusï¼Œè¯·é—®è¿™ç§æ–¹æ¡ˆæœ‰æ²¡æœ‰ä»€ä¹ˆç¼ºç‚¹","like_count":0},{"had_liked":false,"id":369022,"user_name":"Tangzen","can_delete":false,"product_type":"c1","uid":2842683,"ip_address":"åŒ—äº¬","ucode":"B895E7FDEEED64","user_header":"https://static001.geekbang.org/account/avatar/00/2b/60/3b/d12cd56b.jpg","comment_is_top":false,"comment_ctime":1677027516,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"åŒç±»äº§å“æœ‰loki+grafana,sls","like_count":0}]}