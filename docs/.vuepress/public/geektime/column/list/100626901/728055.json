{"id":728055,"title":"15ï½œtokioç¼–ç¨‹ï¼šåœ¨å¤šä»»åŠ¡ä¹‹é—´æ“ä½œåŒä¸€ç‰‡æ•°æ®","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeã€‚ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ å¦‚ä½•åœ¨tokioçš„å¤šä¸ªä»»åŠ¡ä¹‹é—´å…±äº«åŒä¸€ç‰‡æ•°æ®ã€‚</p><p>å¹¶å‘ä»»åŠ¡ä¹‹é—´å¦‚ä½•å…±äº«æ•°æ®æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¯¾é¢˜ï¼Œåœ¨æ‰€æœ‰è¯­è¨€ä¸­éƒ½ä¼šç¢°åˆ°ã€‚ä¸åŒçš„è¯­è¨€æä¾›çš„æ–¹æ¡ˆæ”¯æŒä¸å°½ç›¸åŒï¼Œæ¯”å¦‚ Erlang è¯­è¨€é»˜è®¤åªæä¾›æ¶ˆæ¯æ¨¡å‹ï¼ŒGolang ä¹Ÿæ¨èä½¿ç”¨ channel æ¥åœ¨å¹¶å‘ä»»åŠ¡ä¹‹é—´è¿›è¡ŒåŒæ­¥ã€‚</p><p>Rustè¯­è¨€è€ƒè™‘åˆ°å…¶åº”ç”¨é¢†åŸŸçš„å¹¿æ³›æ€§å’Œå¤šæ ·æ€§ï¼Œæä¾›äº†å¤šç§æœºåˆ¶æ¥è¾¾åˆ°è¿™ä¸€ç›®çš„ï¼Œéœ€è¦æˆ‘ä»¬æ ¹æ®ä¸åŒçš„åœºæ™¯è‡ªè¡Œé€‰æ‹©æœ€åˆé€‚çš„æœºåˆ¶ã€‚æ‰€ä»¥ç›¸å¯¹æ¥è¯´ï¼ŒRuståœ¨è¿™æ–¹é¢è¦å­¦çš„çŸ¥è¯†ç‚¹è¦å¤šä¸€äº›ï¼Œå¥½å¤„æ˜¯å®ƒåœ¨å‡ ä¹æ‰€æœ‰åœºæ™¯ä¸­éƒ½èƒ½åšåˆ°æœ€å¥½ã€‚</p><h2>ä»»åŠ¡ç›®æ ‡</h2><p>å®šä¹‰ä¸€ä¸ªå†…å­˜æ•°æ®åº“dbï¼Œåœ¨ä¸åŒçš„å­ä»»åŠ¡ä¸­ï¼Œå¹¶å‘åœ°å‘è¿™ä¸ªå†…å­˜æ•°æ®åº“æ›´æ–°æ•°æ®ã€‚</p><h2>æ½œåœ¨é—®é¢˜</h2><p>ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬æŠŠ <code>Vec&lt;u32&gt;</code> å½“ä½œdbã€‚æ¯”å¦‚è¿™ä¸ªdbä¸­ç°åœ¨æœ‰10ä¸ªæ•°æ®ã€‚</p><pre><code class=\"language-plain\">let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n</code></pre><p>ç°åœ¨æœ‰ä¸¤ä¸ªä»»åŠ¡ task_a å’Œ task_bï¼Œå®ƒä»¬éƒ½æƒ³æ›´æ–°dbé‡Œçš„ç¬¬5ä¸ªå…ƒç´ çš„æ•°æ® db[4]ã€‚</p><p>task_a æƒ³æŠŠå®ƒæ›´æ–°æˆ 50ï¼Œtask_b æƒ³æŠŠå®ƒæ›´æ–°æˆ 100ã€‚è¿™ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´æ˜¯æ²¡æœ‰ååŒæœºåˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯äº’ç›¸ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ï¼Œæ›´ä¸çŸ¥é“å¯¹æ–¹è¦å¹²å˜›ã€‚äºæ˜¯å°±å¯èƒ½å‡ºç°è¿™æ ·çš„æƒ…å†µï¼Œä¸¤ä¸ªä»»åŠ¡å‡ ä¹åŒæ—¶å‘èµ·æ›´æ–°è¯·æ±‚ï¼Œå‡å¦‚ task_a é¢†å…ˆä¸€ç‚¹ç‚¹æ—¶é—´ï¼Œå…ˆæŠŠ db[4] æ›´æ–°æˆ 50 äº†ï¼Œä½†æ˜¯å®ƒå¾—æ ¡éªŒä¸€ä¸‹æ›´æ–°æ­£ç¡®äº†æ²¡æœ‰ï¼Œæ‰€ä»¥å®ƒå¾—å‘èµ·ä¸€ä¸ªç´¢å¼•è¯·æ±‚ï¼ŒæŠŠ db[4] çš„æ•°æ®å–å‡ºæ¥çœ‹çœ‹æ˜¯ä¸æ˜¯ 50ã€‚</p><!-- [[[read_end]]] --><p>ä½†æ˜¯åœ¨task_aå»æ£€æŸ¥ db[4] çš„å€¼ä¹‹å‰æå°çš„ä¸€ä¸ªæ—¶é—´ç‰‡æ®µé‡Œé¢ï¼Œtask_b å¯¹db[4]æ›´æ–°æ“ä½œä¹Ÿå‘ç”Ÿäº†ï¼Œäºæ˜¯db[4] è¢«æ›´æ–°æˆäº† 100ã€‚ç„¶å task_a å–å›å€¼ä¹‹åï¼Œå‘ç°å€¼æ˜¯ 100ã€‚å¾ˆå¥‡æ€ªï¼Œå¹¶ä¸”åˆ¤æ–­è‡ªå·±æ²¡æœ‰æ›´æ–°æˆåŠŸè¿™ä¸ªæ•°æ®ï¼Œæœ‰å¯èƒ½ä¼šå†æ›´æ–°ä¸€æ¬¡ï¼Œå†æ¬¡æŠŠ db[4] ç½®ä¸º 50ã€‚è¿™åˆå¯èƒ½å¯¹ task_b çš„æ ¡éªŒæœºåˆ¶é€ æˆå¹²æ‰°ã€‚äºæ˜¯æ•´ä¸ªç³»ç»Ÿå°±å¼€å§‹ç´Šä¹±äº†ã€‚</p><p>è¿™å°±æ˜¯å¤šä¸ªä»»åŠ¡æ“ä½œå…±äº«æ•°æ®å¯èƒ½ä¼šå‘ç”Ÿçš„é—®é¢˜ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹åœ¨Rustä¸­æ€ä¹ˆå»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2>æ–¹æ¡ˆå°è¯•</h2><p>æˆ‘ä»¬å¯ä»¥å…ˆä»æœ€ç®€å•çš„æ€è·¯å¼€å§‹ï¼Œè®¾è®¡å¦‚ä¸‹æ–¹æ¡ˆã€‚</p><h3>æ–¹æ¡ˆä¸€ï¼šå…¨å±€å˜é‡</h3><p>å¦‚æœä½ æœ‰å…¶ä»–è¯­è¨€ç¼–ç¨‹ç»éªŒçš„è¯ï¼Œåº”è¯¥å¾ˆå®¹æ˜“å°±èƒ½æƒ³åˆ°ä¸€ä¸ªæ–¹æ¡ˆï¼Œå°±æ˜¯åˆ©ç”¨å…¨å±€å˜é‡æ¥å®ç°å¤šä¸ªä»»åŠ¡çš„æ•°æ®å…±äº«ã€‚å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ DBï¼Œä¸º <code>Vec&lt;u32&gt;</code> ç±»å‹ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªDBï¼Œå¹¶å¯ä»¥å‘é‡Œé¢pushæ•°æ®ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥è¯•è¯•ç›´æ¥åœ¨mainå‡½æ•°é‡Œå¯¹è¿™ä¸ªDBå…¨å±€å˜é‡è¿›è¡Œæ“ä½œã€‚</p><pre><code class=\"language-plain\">static DB: Vec&lt;u32&gt; = Vec::new();\n\nfn main() {\n&nbsp; &nbsp; DB.push(10);\n}\n</code></pre><p>å‘ç°ä¸è¡Œï¼Œç¼–è¯‘ä¼šæŠ¥é”™ï¼š</p><pre><code class=\"language-plain\">error[E0596]: cannot borrow immutable static item `DB` as mutable\n --&gt; src/main.rs:4:5\n  |\n4 |     DB.push(10);\n  |     ^^^^^^^^^^^ cannot borrow as mutable\n</code></pre><p>å¯èƒ½æ˜¯æ²¡åŠ  mutï¼ŸåŠ ä¸Šè¯•ä¸€è¯•ã€‚</p><pre><code class=\"language-plain\">static mut DB: Vec&lt;u32&gt; = Vec::new();\n\nfn main() {\n&nbsp; &nbsp; DB.push(10);\n}\n</code></pre><p>è¿˜æ˜¯å‡ºé”™ï¼š</p><pre><code class=\"language-plain\">error[E0133]: use of mutable static is unsafe and requires unsafe function or block\n --&gt; src/main.rs:4:5\n  |\n4 |     DB.push(10);\n  |     ^^^^^^^^^^^ use of mutable static\n  |\n  = note: mutable statics can be mutated by multiple threads: aliasing violations or data races will cause undefined behavior\n</code></pre><p>Rustç¼–è¯‘å™¨æŠ¥é”™è¯´ï¼Œè¦ä½¿ç”¨å¯å˜çš„é™æ€å…¨å±€å˜é‡æ˜¯ä¸å®‰å…¨çš„ï¼Œéœ€è¦ç”¨åˆ°unsafeåŠŸèƒ½ã€‚unsafeåŠŸèƒ½æˆ‘ä»¬è¿˜æ²¡è®²ï¼Œè€Œä¸”ä¸æ˜¯è¿™èŠ‚è¯¾çš„é‡ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œä¸å±•å¼€ã€‚æ€»ä¹‹ï¼Œ<strong>Rustä¸æ¨èæˆ‘ä»¬ä½¿ç”¨å…¨å±€ï¼ˆé™æ€ï¼‰å˜é‡</strong>ã€‚å› ä¸ºå…¨å±€å˜é‡ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ¡ˆï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤šä»»åŠ¡å¹¶å‘ç¨‹åºæ¥è¯´ï¼Œåº”è¯¥å°½å¯èƒ½é¿å…ã€‚</p><p>é‚£æ—¢ç„¶å…¨å±€å˜é‡ä¸èƒ½ç”¨äº†ï¼Œæœ‰ä¸€ä¸ªå¯è¡Œçš„é€‰æ‹©æ˜¯ï¼Œåœ¨ main å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼ŒæŠŠè¿™ä¸ªå®ä¾‹ä¼ ç»™å„ä¸ªä»»åŠ¡ã€‚å› ä¸ºè¿™ä¸ªå®ä¾‹æ˜¯åœ¨mainå‡½æ•°ä¸­åˆ›å»ºçš„ï¼Œå®ƒçš„ç”Ÿå‘½æœŸè·Ÿmainå‡½æ•°ä¸€æ ·é•¿ï¼Œæ‰€ä»¥ä¹Ÿç›¸å½“äºå…¨å±€å˜é‡äº†ã€‚</p><h3>æ–¹æ¡ˆäºŒï¼šmainå‡½æ•°ä¸­çš„å¯¹è±¡</h3><p>ç¨å¾®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œè¿™ä¸‹å¯ä»¥äº†ã€‚</p><pre><code class=\"language-plain\">fn main() {\n&nbsp; &nbsp; let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n&nbsp; &nbsp; db[4] = 50;\n}\n</code></pre><p>ä¸‹é¢æˆ‘ä»¬å°è¯•åœ¨mainå‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªtokioä»»åŠ¡ã€‚</p><pre><code class=\"language-plain\">#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n\n&nbsp; &nbsp; let task_a = tokio::task::spawn(async {\n&nbsp; &nbsp; &nbsp; &nbsp; db[4] = 50;\n&nbsp; &nbsp; });\n&nbsp; &nbsp; _ = task_a.await.unwrap();\n\n&nbsp; &nbsp; println!(\"{:?}\", db);\n}\n</code></pre><p>è¿™æ˜¯ä¸€æ®µç¨€æ¾å¹³å¸¸çš„ä»£ç ï¼Œç›®çš„å°±æ˜¯èµ·ä¸€ä¸ªtaskï¼Œæ›´æ–°ä¸€ä¸‹Vecé‡Œçš„å…ƒç´ ï¼Œç„¶åç­‰å¾…è¿™ä¸ªä»»åŠ¡ç»“æŸï¼Œæ‰“å°è¿™ä¸ªVecçš„å€¼ã€‚ä½†æ˜¯ï¼Œåœ¨Rustä¸­ï¼Œè¿™æ®µä»£ç æ— æ³•é€šè¿‡ï¼ŒRustç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</p><pre><code class=\"language-plain\">error[E0373]: async block may outlive the current function, but it borrows `db`, which is owned by the current function\n&nbsp;--&gt; src/main.rs:5:37\n&nbsp; |\n5 |&nbsp; &nbsp; &nbsp; &nbsp;let task_a = tokio::task::spawn(async {\n&nbsp; |&nbsp; _____________________________________^\n6 | |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;db[4] = 50;\n&nbsp; | |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- `db` is borrowed here\n7 | |&nbsp; &nbsp; &nbsp;});\n&nbsp; | |_____^ may outlive borrowed value `db`\n&nbsp; |\n&nbsp; = note: async blocks are not executed immediately and must either take a reference or ownership of outside variables they use\nhelp: to force the async block to take ownership of `db` (and any other referenced variables), use the `move` keyword\n&nbsp; |\n5 |&nbsp; &nbsp; &nbsp;let task_a = tokio::task::spawn(async move {\n&nbsp; |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;++++\n</code></pre><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªé”™è¯¯æç¤ºï¼Œé”™è¯¯æç¤ºç¬¬1è¡Œè¯´ï¼Œä»»ä½•å¼‚æ­¥å—éƒ½æœ‰å¯èƒ½è¶…å‡ºå½“å‰å‡½æ•°çš„ç”Ÿå­˜æœŸï¼Œä½†æ˜¯å®ƒé‡Œé¢ä¾èµ–çš„dbæ˜¯åœ¨å½“å‰å‡½æ•°å®šä¹‰çš„ï¼Œå› æ­¤åœ¨å¼‚æ­¥å—æ‰§è¡Œçš„æ—¶å€™ï¼ŒdbæŒ‡å‘çš„å¯¹è±¡æœ‰å¯èƒ½ä¼šæ¶ˆå¤±ï¼Œä»è€Œå‡ºé”™ã€‚ä½ å¯èƒ½å·²ç»çŒœåˆ°äº†ï¼Œé”™è¯¯åŸå› è·Ÿæ‰€æœ‰æƒç›¸å…³ã€‚åŸå› æ˜¯è¿™ä¸ªtask_aè¿è¡Œçš„ç”Ÿå­˜æ—¶é—´æ®µï¼Œæœ‰å¯èƒ½è¶…è¿‡main taskç”Ÿå­˜çš„æ—¶é—´æ®µï¼Œæ‰€ä»¥task_aé‡Œçš„asyncå—ä¸­ç›´æ¥å€Ÿç”¨mainå‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡dbä¼šæœ‰æ‰€æœ‰æƒç›¸å…³é£é™©ã€‚</p><p>ä¸è¿‡è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ç–‘é—®ï¼Œæˆ‘ä»¬ä¸æ˜¯åœ¨mainä¸­æ‰‹åŠ¨ <code>.await</code> äº†å—ï¼Ÿä¼šç­‰å¾…è¿™ä¸ªå­taskçš„è¿”å›ç»“æœï¼Œä½†æ˜¯Rustå¹¶æ²¡æœ‰åˆ†æåˆ°è¿™ä¸€ç‚¹ã€‚å®ƒå¯èƒ½ä¼šè§‰å¾—ä½ åœ¨ <code>task_a.await</code> è¿™ä¸€å¥ä¹‹å‰å…¶å®æ˜¯æœ‰æœºä¼šå°†dbç»™å¼„æ¶ˆå¤±çš„ï¼Œæ¯”å¦‚æ‰‹åŠ¨ <code>drop()</code> æ‰è¿™ä¸ªdbï¼Œæˆ–è€…è¯´è°ƒç”¨äº†ä»€ä¹ˆåˆ«çš„å‡½æ•°ï¼ŒæŠŠdbçš„æ‰€æœ‰æƒåœ¨é‚£é‡Œç»™æ¶ˆè€—äº†ã€‚</p><p>å®ƒåœ¨é”™è¯¯ä¿¡æ¯ç¬¬12è¡Œå»ºè®®æˆ‘ä»¬åœ¨ async ååŠ  move ä¿®é¥°ç¬¦ï¼Œè¿™æ ·æŒ‡æ˜å¼ºåˆ¶å°† db çš„æ‰€æœ‰æƒç§»åŠ¨è¿›task_é‡Œå»ã€‚æˆ‘ä»¬æŒ‰ç…§å»ºè®®ä¿®æ”¹ä¸€ä¸‹ã€‚</p><pre><code class=\"language-plain\">#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n\n&nbsp; &nbsp; let task_a = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; db[4] = 50;\n&nbsp; &nbsp; });\n&nbsp; &nbsp; _ = task_a.await.unwrap();\n\n&nbsp; &nbsp; println!(\"{:?}\", db);\n}\n</code></pre><p>ä»ç„¶ç¼–è¯‘å‡ºé”™ï¼ŒæŠ¥é”™ä¿¡æ¯æ¢äº†ã€‚</p><pre><code class=\"language-plain\">error[E0382]: borrow of moved value: `db`\n&nbsp; --&gt; src/main.rs:10:22\n&nbsp; &nbsp;|\n3&nbsp; |&nbsp; &nbsp; &nbsp; &nbsp;let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;------ move occurs because `db` has type `Vec&lt;u32&gt;`, which does not implement the `Copy` trait\n4&nbsp; |\n5&nbsp; |&nbsp; &nbsp; &nbsp; &nbsp;let task_a = tokio::task::spawn(async move {\n&nbsp; &nbsp;|&nbsp; _____________________________________-\n6&nbsp; | |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;db[4] = 50;\n&nbsp; &nbsp;| |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- variable moved due to use in generator\n7&nbsp; | |&nbsp; &nbsp; &nbsp;});\n&nbsp; &nbsp;| |_____- value moved here\n...\n10 |&nbsp; &nbsp; &nbsp; &nbsp;println!(\"{:?}\", db);\n&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^ value borrowed here after move\n</code></pre><p>å®ƒè¯´ï¼Œdbå·²ç»è¢«ç§»åŠ¨åˆ°äº†task_aé‡Œäº†ï¼Œæ‰€ä»¥åœ¨mainå‡½æ•°ä¸­è®¿é—®ä¸åˆ°ã€‚è¿™ç§ä¸¥è‹›æ€§ï¼Œå¯¹äºä»å…¶ä»–è¯­è¨€è¿‡æ¥çš„æ–°æ‰‹æ¥è¯´ï¼Œç¡®å®ä»¤äººå´©æºƒã€‚ä¸è¿‡åè¿‡æ¥æƒ³æƒ³Rustç¡®å®æŠŠç»†èŠ‚æŠ å¾—å¾ˆæ­»ï¼Œè¿™ä¹Ÿæ˜¯å®ƒæ¯”å…¶ä»–è¯­è¨€å®‰å…¨çš„åŸå› ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¬å°åŠ©æ‰‹çš„è¯ï¼Œä¸åœ¨mainå‡½æ•°ä¸­æ‰“å°äº†ã€‚è¿™æ ·ç¡®å®èƒ½ç¼–è¯‘é€šè¿‡ã€‚</p><pre><code class=\"language-plain\">#[tokio::main]\nasync fn main() {\n    let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n\n    let task_a = tokio::task::spawn(async move {\n        db[4] = 50;\n    });\n    _ = task_a.await.unwrap();\n}\n</code></pre><p>ç¬¬ä¸€æ­¥èµ°é€šäº†ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬è¦æµ‹è¯•å¤šä»»åŠ¡å¹¶å‘çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†å¢åŠ ä¸€ä¸ªä»»åŠ¡ã€‚</p><pre><code class=\"language-plain\">use tokio::task;\n\n#[tokio::main]\nasync fn main() {\n    let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n    \n    let task_a = task::spawn(async move {\n        db[4] = 50;\n    });\n    let task_b = task::spawn(async move {\n        db[4] = 100;\n    });\n    _ = task_a.await.unwrap();\n    _ = task_b.await.unwrap();\n}\n</code></pre><p>è¿™ç§å†™æ³•æ˜æ˜¾ä¼šæœ‰é—®é¢˜ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦ç¼–è¯‘å°±å¯ä»¥çŸ¥é“ï¼Œå› ä¸ºå‡ºç°äº†ä¸¤æ¬¡ async move å—ã€‚å¦‚æœä½ æ˜¯ä¸€æ­¥æ­¥å­¦è¿‡æ¥çš„è¯ï¼Œåº”è¯¥çŸ¥é“ï¼Œdbåœ¨ç¬¬ä¸€ä¸ªasync moveæ—¶å·²ç»è¢«ç§»åŠ¨è¿› task_a äº†ï¼Œåé¢ä¸å¯èƒ½å†ç§»åŠ¨è¿› task_bã€‚</p><p>ç¼–è¯‘éªŒè¯åï¼Œç¡®å®å¦‚æ­¤ã€‚</p><pre><code class=\"language-plain\">error[E0382]: use of moved value: `db`\n&nbsp; --&gt; src/main.rs:10:30\n&nbsp; &nbsp;|\n5&nbsp; |&nbsp; &nbsp; &nbsp; &nbsp;let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;------ move occurs because `db` has type `Vec&lt;u32&gt;`, which does not implement the `Copy` trait\n6&nbsp; |&nbsp; &nbsp; &nbsp; &nbsp;\n7&nbsp; |&nbsp; &nbsp; &nbsp; &nbsp;let task_a = task::spawn(async move {\n&nbsp; &nbsp;|&nbsp; ______________________________-\n8&nbsp; | |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;db[4] = 50;\n&nbsp; &nbsp;| |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- variable moved due to use in generator\n9&nbsp; | |&nbsp; &nbsp; &nbsp;});\n&nbsp; &nbsp;| |_____- value moved here\n10 |&nbsp; &nbsp; &nbsp; &nbsp;let task_b = task::spawn(async move {\n&nbsp; &nbsp;|&nbsp; ______________________________^\n11 | |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;db[4] = 100;\n&nbsp; &nbsp;| |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- use occurs due to use in generator\n12 | |&nbsp; &nbsp; &nbsp;});\n&nbsp; &nbsp;| |_____^ value used here after move\n</code></pre><p>é‚£åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><h3>æ–¹æ¡ˆä¸‰ï¼šåˆ©ç”¨ Arc</h3><p>å›æƒ³ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/725815\">ç¬¬ 12 è®²</a>æˆ‘ä»¬è®²åˆ°è¿‡çš„Arcè¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒå¯ä»¥è®©å¤šä¸ªæŒæœ‰è€…å…±äº«å¯¹åŒä¸€èµ„æºçš„æ‰€æœ‰æƒã€‚ä½†æ˜¯Arcä¹Ÿæœ‰ä¸€ä¸ªå·¨å¤§çš„é™åˆ¶ï¼Œå°±æ˜¯å®ƒæ— æ³•ä¿®æ”¹è¢«åŒ…è£¹çš„å€¼ã€‚ä½†ä¸ç®¡æ€æ ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç¢°ç¢°è¿æ°”ï¼Œæ”¹åŠ¨ä¸€ä¸‹ã€‚</p><pre><code class=\"language-plain\">use std::sync::Arc;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let mut db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n&nbsp; &nbsp; let arc_db = Arc::new(db);\n&nbsp; &nbsp; let arc_db2 = arc_db.clone();\n\n&nbsp; &nbsp; let task_a = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; arc_db[4] = 50;\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; arc_db2[4] = 100;\n&nbsp; &nbsp; });\n&nbsp; &nbsp; _ = task_a.await.unwrap();\n&nbsp; &nbsp; _ = task_b.await.unwrap();\n\n&nbsp; &nbsp; // println!(\"{:?}\", db);\n}\n</code></pre><p>ä¸å‡ºæ‰€æ–™ï¼ŒRustç¼–è¯‘ä¸é€šè¿‡ï¼Œè¿™è¯´æ˜é€šè¿‡ <code>Arc&lt;T&gt;</code> æ²¡åŠæ³•ä¿®æ”¹é‡Œé¢çš„å€¼ã€‚</p><pre><code class=\"language-plain\">error[E0596]: cannot borrow data in an `Arc` as mutable\n&nbsp; --&gt; src/main.rs:10:9\n&nbsp; &nbsp;|\n10 |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;arc_db[4] = 50;\n&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^^^^^^ cannot borrow as mutable\n&nbsp; &nbsp;|\n&nbsp; &nbsp;= help: trait `DerefMut` is required to modify through a dereference, but it is not implemented for `Arc&lt;Vec&lt;u32&gt;&gt;`\n\nerror[E0596]: cannot borrow data in an `Arc` as mutable\n&nbsp; --&gt; src/main.rs:13:9\n&nbsp; &nbsp;|\n13 |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;arc_db2[4] = 100;\n&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^^^^^^^ cannot borrow as mutable\n&nbsp; &nbsp;|\n&nbsp; &nbsp;= help: trait `DerefMut` is required to modify through a dereference, but it is not implemented for `Arc&lt;Vec&lt;u32&gt;&gt;`\n</code></pre><p>è™½ç„¶ç°åœ¨æˆ‘ä»¬çš„ä»£ç è¿˜æ˜¯æ²¡æœ‰ç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯æ€è·¯æ˜¯æ²¡é—®é¢˜çš„ï¼šè¦åœ¨å¹¶å‘çš„å¤šä¸ªä»»åŠ¡ä¸­ï¼Œè®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œé‚£ä¹ˆå¿…ç„¶æ¶‰åŠåˆ°å¤šæ‰€æœ‰æƒï¼Œæ‰€ä»¥ä½¿ç”¨Arcæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ã€‚ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œ<strong>æœ‰æ²¡æœ‰åŠæ³•æ›´æ”¹è¢«ArcåŒ…è£¹èµ·æ¥çš„å€¼</strong>ã€‚</p><p>ç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œåˆ©ç”¨ Mutex å°±å¯ä»¥ã€‚</p><h3>æ–¹æ¡ˆå››ï¼šArc+Mutex</h3><p>ä¸€ä¸ªå¤šä»»åŠ¡å¹¶å‘ç¼–ç¨‹è¦ä¿®æ”¹åŒä¸€ä¸ªå€¼ï¼Œé‚£å¿…ç„¶è¦é˜²æ­¢ä¿®æ”¹å†²çªï¼Œè¿™å°±ä¸å¾—ä¸ç”¨åˆ°è®¡ç®—æœºé¢†åŸŸé‡Œä¸€ä¸ªå¸¸è§çš„å·¥å…·â€”â€”é”ã€‚</p><p>Mutexæ˜¯ä¸€ç§äº’æ–¥é”ï¼Œè¢«MutexåŒ…è£¹ä½çš„å¯¹è±¡ï¼ŒåŒæ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ªreaderæˆ–ä¸€ä¸ªwriterã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œè¦å…ˆè·å¾—Mutexé”ï¼ŒæˆåŠŸåï¼Œæ‰èƒ½è¯»æˆ–å†™è¿™ä¸ªé”é‡Œé¢çš„å€¼ã€‚å¤šä¸ªä»»åŠ¡ä¸èƒ½åŒæ—¶è·å¾—åŒä¸€ä¸ªMutexé”ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æŒæœ‰Mutexé”æ—¶ï¼Œå…¶ä»–ä»»åŠ¡ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°é‚£ä¸ªä»»åŠ¡ç”¨å®Œäº†Mutexé”ï¼Œå¹¶è‡ªåŠ¨é‡Šæ”¾äº†å®ƒã€‚</p><pre><code class=\"language-plain\">use std::sync::Arc;\nuse tokio::sync::Mutex;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let db: Vec&lt;u32&gt; = vec![1,2,3,4,5,6,7,8,9,10];\n&nbsp; &nbsp; let arc_db = Arc::new(Mutex::new(db));  // åŠ é”\n&nbsp; &nbsp; let arc_db2 = arc_db.clone();\n&nbsp; &nbsp; let arc_db3 = arc_db.clone();\n\n&nbsp; &nbsp; let task_a = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; let mut db = arc_db.lock().await;  // è·å–é”\n&nbsp; &nbsp; &nbsp; &nbsp; db[4] = 50;\n        assert_eq!(db[4], 50);             // æ ¡éªŒå€¼\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; let mut db = arc_db2.lock().await;  // è·å–é”\n&nbsp; &nbsp; &nbsp; &nbsp; db[4] = 100;\n        assert_eq!(db[4], 100);            // æ ¡éªŒå€¼\n&nbsp; &nbsp; });\n&nbsp; &nbsp; _ = task_a.await.unwrap();\n&nbsp; &nbsp; _ = task_b.await.unwrap();\n\n&nbsp; &nbsp; println!(\"{:?}\", arc_db3.lock().await);  // è·å–é”\n}\n// è¾“å‡º\n[1, 2, 3, 4, 100, 6, 7, 8, 9, 10]\n</code></pre><p>åŠ ä¸ŠMutexï¼Œè¿™ä¸ªä¾‹å­å°±èƒ½é¡ºåˆ©ç¼–è¯‘å¹¶è¿è¡Œé€šè¿‡äº†ã€‚</p><p>è¿™ä¸ªä¾‹å­é‡Œçš„ç¬¬7è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Arc::new(Mutex::new())</code> ç»„åˆæŠŠdbåŒ…äº†ä¸¤å±‚ï¼Œå¤–å±‚æ˜¯Arcï¼Œé‡Œå±‚æ˜¯Mutexã€‚ç„¶åï¼Œæˆ‘ä»¬æŠŠarc_dbå…‹éš†äº†ä¸¤æ¬¡ï¼Œè¿™ç§å…‹éš†åªæ˜¯å¢åŠ Arcçš„å¼•ç”¨è®¡æ•°ï¼Œä»£ä»·éå¸¸ä½ã€‚</p><p>ç„¶ååœ¨æ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™ï¼Œå…ˆé€šè¿‡ <code>arc_db.lock().await</code> è¿™ç§æ–¹å¼è·å¾—é”ï¼Œå†ç­‰å¾…å–å‡ºé”ä¸­å¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯Vecçš„å¼•ç”¨ï¼Œç„¶åé€šè¿‡è¿™ä¸ªå¼•ç”¨å»æ›´æ–°dbçš„å€¼ã€‚</p><p>åˆ©ç”¨Arcä¸Mutexçš„ç»„åˆï¼Œæˆ‘ä»¬è¿˜é¡ºä¾¿è§£å†³äº†åœ¨main taskä¸èƒ½æ‰“å°è¿™ä¸ªdbçš„é—®é¢˜ã€‚å®é™…ä¸Šï¼Œåœ¨Rustä¸­ï¼Œ<code>Arc&lt;Mutex&lt;T&gt;&gt;</code> æ˜¯ä¸€å¯¹å¾ˆå¸¸è§çš„ç»„åˆï¼Œåˆ©ç”¨å®ƒä»¬çš„ç»„åˆæŠ€æœ¯ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†çš„å¹¶å‘ç¼–ç¨‹åœºæ™¯ã€‚</p><p>æœ‰äº†è¿™ä¸¤å…„å¼Ÿçš„åŠ æŒï¼Œæˆ‘ä»¬ç”¨Rustå†™ä¸šåŠ¡ä»£ç å°±å˜å¾—åƒJavaä¸€æ ·é«˜æ•ˆã€ä¾¿æ·ã€‚ç›¸å¯¹äºGoã€Pythonæˆ–JavaScriptæ¥è¯´ï¼ŒRustçš„å¼‚æ­¥å¹¶å‘ç¼–ç¨‹ä»£ç ç¨å¾®æœ‰äº›ç¹çï¼Œä½†æ˜¯å®ƒçš„æ¨¡å¼æ˜¯éå¸¸å›ºå®šçš„ï¼Œæœ€åè¿™ä¸ªç¤ºä¾‹é‡Œçš„æ¨¡å¼å¯ä»¥æ— è„‘ä½¿ç”¨ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒArcã€Mutexå’Œclone() ä¸€èµ·ï¼Œè¢«ç¤¾åŒºå«åšâ€œRustä¸‰æ¿æ–§â€ï¼Œå°±æ˜¯å› ä¸ºå®ƒä»¬ç®€å•ç²—æš´ï¼Œæ–¹ä¾¿å¥½ç”¨ã€‚</p><p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†è¿™èŠ‚è¯¾å¼€å¤´æå‡ºçš„é—®é¢˜ã€‚</p><h2>å…¶ä»–é”</h2><p>é™¤äº†Mutexï¼Œtokioé‡Œè¿˜æä¾›äº†ä¸€äº›é”ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ã€‚</p><h3>tokio::sync::RwLock</h3><p>RwLockæ˜¯è¯»å†™é”ã€‚å®ƒå’ŒMutexçš„åŒºåˆ«æ˜¯ï¼ŒMutexä¸è®ºæ˜¯è¯»è¿˜æ˜¯å†™ï¼ŒåŒæ—¶åªæœ‰ä¸€ä¸ªèƒ½æ‹¿åˆ°é”ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªtaskåœ¨è¯»ï¼Œè€Œå¦ä¸€ä¸ªtaskä¹Ÿæƒ³è¯»çš„æ—¶å€™ï¼Œä»ç„¶éœ€è¦ç­‰å¾…ç¬¬ä¸€ä¸ªtaskå…ˆé‡Šæ”¾é”ã€‚æ‰€ä»¥åœ¨è¯»æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼ŒMutexçš„è¿è¡Œæ•ˆç‡ä¸æ˜¯å¤ªç†æƒ³ã€‚</p><p>è€ŒRwLockçš„è®¾è®¡æ˜¯ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æ‹¿çš„æ˜¯è¯»é”æ—¶ï¼Œå…¶ä»–ä»»åŠ¡ä¹Ÿèƒ½å†æ‹¿åˆ°è¯»é”ï¼Œå¤šä¸ªè¯»é”ä¹‹é—´å¯ä»¥åŒæ—¶å­˜åœ¨ã€‚å½“ä¸€ä¸ªä»»åŠ¡æƒ³æ‹¿å†™é”çš„æ—¶å€™ï¼Œå¿…é¡»ç­‰å¾…å…¶ä»–æ‰€æœ‰è¯»é”æˆ–å†™é”é‡Šæ”¾åæ‰èƒ½æ‹¿åˆ°ã€‚</p><p>å½“ä¸€ä¸ªä»»åŠ¡æ‹¿åˆ°äº†å†™é”æ—¶ï¼Œå…¶ä»–ä»»åŠ¡åªèƒ½ç­‰å¾…å®ƒå®Œæˆåæ‰èƒ½ç»§ç»­æ“ä½œï¼Œä¸ç®¡å…¶ä»–ä»»åŠ¡æ˜¯è¦å†™è¿˜æ˜¯è¯»ã€‚å› æ­¤å¯¹äºå†™æ¥è®²ï¼ŒRwLockæ˜¯æ’æ–¥å‹è®¿é—®ï¼›å¯¹äºè¯»æ¥è®²ï¼ŒRwLockæä¾›äº†å…±äº«è®¿é—®ã€‚è¿™ä¸€ç‚¹ä¸ä¸å¯å˜å¼•ç”¨å’Œå¯å˜å¼•ç”¨çš„å…³ç³»ç‰¹åˆ«åƒã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p><pre><code class=\"language-plain\">use tokio::sync::RwLock;\n#[tokio::main]\nasync fn main() {\n    let lock = RwLock::new(5);\n    // å¤šä¸ªè¯»é”å¯ä»¥åŒæ—¶å­˜åœ¨\n    {\n        let r1 = lock.read().await;\n        let r2 = lock.read().await;\n        assert_eq!(*r1, 5);\n        assert_eq!(*r2, 5);\n    } // åœ¨è¿™ä¸€å¥ç»“æŸæ—¶ï¼Œä¸¤ä¸ªè¯»é”éƒ½é‡Šæ”¾æ‰äº†\n    \n    // åŒæ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ªå†™é”\n    {\n        let mut w = lock.write().await;\n        *w += 1;\n        assert_eq!(*w, 6);\n    } // åœ¨è¿™ä¸€å¥ç»“æŸæ—¶ï¼Œå†™é”é‡Šæ”¾æ‰äº†\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒRwLockçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåœ¨è¯»æ“ä½œæ¯”å†™æ“ä½œå¤šå¾ˆå¤šçš„æƒ…å†µä¸‹ï¼ŒRwLockçš„æ€§èƒ½ä¼šæ¯”Mutexå¥½å¾ˆå¤šã€‚</p><p>Rustæ ‡å‡†åº“ä¸­è¿˜æœ‰ä¸€äº›ç”¨äºç®€å•ç±»å‹çš„åŸå­é”ã€‚</p><h3>std::sync::atomic</h3><p>å¦‚æœå…±äº«æ•°æ®çš„åªæ˜¯ä¸€äº›ç®€å•çš„ç±»å‹ï¼Œæ¯”å¦‚ boolã€i32ã€u8ã€usizeç­‰ç­‰ï¼Œå°±ä¸éœ€è¦ä½¿ç”¨Mutexæˆ–RwLockæŠŠè¿™äº›ç±»å‹åŒ…èµ·æ¥ï¼Œæ¯”å¦‚åƒè¿™æ · <code>Arc&lt;Mutex&lt;u32&gt;&gt;</code>ï¼Œå¯ä»¥ç›´æ¥ç”¨Rustæ ‡å‡†åº“é‡Œæä¾›çš„åŸå­ç±»å‹ã€‚<code>std::sync::atomic</code> è¿™ä¸ªæ¨¡å—ä¸‹é¢æä¾›äº†å¾ˆå¤šåŸå­ç±»å‹ï¼Œæ¯”å¦‚AtomicBoolã€AtomicI8ã€AtomicI16ç­‰ç­‰ã€‚</p><p><code>Mutex&lt;u32&gt;</code> å¯¹åº”çš„åŸå­ç±»å‹æ˜¯ <code>std::sync::atomic::AtomicU32</code>ã€‚</p><p>åƒä¸‹é¢è¿™æ ·ä½¿ç”¨ï¼š</p><pre><code class=\"language-plain\">use std::sync::atomic::AtomicU32;\n\nfn main() {\n    // åˆ›å»º\n    let atomic_forty_two = AtomicU32::new(42);\n    let arc_data = Arc::new(atomic_forty_two);\n    \n    let mut some_var = AtomicU32::new(10);\n    // æ›´æ–°\n    *some_var.get_mut() = 5;\n    assert_eq!(*some_var.get_mut(), 5);\n}\n</code></pre><p>å…¶ä»–ç±»å‹æŒ‰ç±»ä¼¼çš„æ–¹å¼ä½¿ç”¨å°±å¯ä»¥äº†ã€‚åŸå­ç±»å‹ä¹‹æ‰€ä»¥ä¼šå•ç‹¬æå‡ºæ¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯é”çš„åŸºç¡€ï¼Œå…¶ä»–çš„é”ä¼šå»ºç«‹åœ¨è¿™äº›åŸºç¡€åŸå­ç±»å‹ä¹‹ä¸Šï¼Œè¿™äº›åŸå­ç±»å‹ä¹Ÿå¯ä»¥å……åˆ†åˆ©ç”¨ç¡¬ä»¶æä¾›çš„å…³äºåŸå­æ“ä½œçš„æ”¯æŒï¼Œä»è€Œæé«˜åº”ç”¨çš„æ€§èƒ½ã€‚</p><blockquote>\n<p>æ³¨ï¼šåœ¨å¤šæ ¸CPUä¸­ï¼Œå¸¸è§çš„ç¡¬ä»¶æ”¯æŒåŸå­æ“ä½œçš„æ–¹æ³•åŒ…æ‹¬CPUä¸­çš„ç¼“å­˜ä¸€è‡´æ€§åè®®ã€æ€»çº¿é”å®šç­‰æœºåˆ¶ï¼Œå¯ä»¥ä½¿å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹åŒæ—¶å¯¹åŒä¸€å˜é‡è¿›è¡ŒåŸå­æ“ä½œæ—¶ï¼Œä¸ä¼šå‡ºç°æ•°æ®ç«äº‰å’Œçº¿ç¨‹åŒæ­¥çš„é—®é¢˜ã€‚</p>\n</blockquote><p>é”ï¼ˆlockï¼‰å’Œæ— é”ï¼ˆlock-freeï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦é¢†åŸŸä¸€ä¸ªéå¸¸å¤§çš„è¯¾é¢˜ï¼ŒRustæœ‰æœ¬ä¹¦ <a href=\"https://marabos.nl/atomics/\">ã€ŠRust Atomics and&nbsp;Locksã€‹</a>ä¸“é—¨è®²è¿™ä¸ªï¼Œæœ‰å…´è¶£çš„è¯ä½ å¯ä»¥çœ‹ä¸€çœ‹ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬é€šè¿‡ä¸€æ­¥æ­¥éªŒè¯çš„æ–¹å¼ï¼Œå­¦ä¹ äº†åœ¨Rustå’Œtokioä¸­å¦‚ä½•åœ¨å¤šä¸ªä»»åŠ¡ä¸­æ“ä½œå…±äº«æ•°æ®ï¼Œç»è¿‡å¤šæ¬¡è¢«ç¼–è¯‘å™¨æ‹’ç»çš„ç—›è‹¦ï¼Œæœ€åæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç›¸å½“èˆ’æœçš„æ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥ä¾›æˆ‘ä»¬ä»¥ååœ¨åšå¹¶å‘ç¼–ç¨‹æ—¶ä½¿ç”¨ï¼Œä½¿ç”¨æ—¶çš„æ¨¡å¼éå¸¸å›ºå®šï¼Œæ²¡æœ‰ä»€ä¹ˆå¿ƒæ™ºè´Ÿæ‹…ã€‚æ•´ä¸ªæ¢ç´¢è¿‡ç¨‹è™½ç„¶æ¯”è¾ƒè¾›è‹¦ï¼Œä½†æ˜¯ç»“æœå´æ˜¯æ¯”è¾ƒç¾å¥½çš„ã€‚è¿™ä¹Ÿè®¸å°±æ˜¯Rustçš„å­¦ä¹ è¿‡ç¨‹å§ï¼Œå…ˆè‹¦åç”œã€‚</p><p>åœ¨æ•´ä¸ªæ¢ç´¢è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ·±åˆ‡ä½“ä¼šRustæ‰€æœ‰æƒæ¨¡å‹åœ¨å¹¶å‘åœºæ™¯ä¸‹å‘æŒ¥çš„é‡è¦ä½œç”¨ã€‚å¦‚æœä½ æƒ³è®©ç¨‹åºç¼–è¯‘é€šè¿‡ï¼Œé‚£ä¹ˆå¿…é¡»ä¸¥æ ¼éµå®ˆRustçš„æ‰€æœ‰æƒæ¨¡å‹ï¼›ä¸€æ—¦ä½ åœ¨Rustçš„æ‰€æœ‰æƒæŒ‡å¯¼ä¸‹æ£é¼“å‡ºäº†å¹¶å‘ä»£ç ï¼Œé‚£ä¹ˆ<strong>ä½ çš„å¹¶å‘ä»£ç å°±ä¸€å®šä¸ä¼šäº§ç”Ÿç”±äºç«äº‰æ¡ä»¶è€Œå¯¼è‡´çš„æ¦‚ç‡æ€§Bug</strong>ã€‚</p><p>å¦‚æœä½ æœ‰è¿™æ–¹é¢çš„ç»éªŒæ•™è®­ï¼Œä½ ä¸€å®šä¼šç‰¹åˆ«æ†æ¶è¿™ç§æ¦‚ç‡æ€§çš„Bugï¼Œå› ä¸ºæœ‰å¯èƒ½ä»…ä»…æ˜¯é‡ç°Bugç°åœºå°±è¦èŠ±ä¸€ä¸ªæœˆçš„æ—¶é—´ã€‚åŒæ—¶ï¼Œä½ ä¼šçˆ±ä¸ŠRustï¼Œå› ä¸ºå®ƒä»è¯­è¨€å±‚é¢å°±å¸®æˆ‘ä»¬æœç»äº†è¿™ç§æƒ…å†µï¼Œè®©æˆ‘ä»¬çš„çº¿ä¸ŠæœåŠ¡ç‰¹åˆ«ç¨³å®šï¼Œæ™šä¸Šå¯ä»¥å®‰å¿ƒç¡è§‰äº†ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¿™èŠ‚è¯¾ä»£ç é‡Œä¸‹é¢è¿™ä¸¤å¥çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Œç¬¬ä¸€è¡Œä¼šé˜»å¡ç¬¬äºŒå¥å—ï¼Ÿ</p><pre><code class=\"language-plain\">    _ = task_a.await.unwrap();\n    _ = task_b.await.unwrap();\n</code></pre><p>å¸Œæœ›ä½ å¯ä»¥å¼€åŠ¨è„‘ç­‹ï¼Œè®¤çœŸæ€è€ƒï¼ŒæŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œé‚€ä»–ä»¬ä¸€èµ·å­¦ä¹ Rustã€‚å¥½äº†ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§å§ï¼</p>","neighbors":{"left":{"article_title":"14ï½œtokioå®æˆ˜ï¼šç¼–å†™ä¸€ä¸ªç½‘ç»œå‘½ä»¤è¡Œç¨‹åº","id":726207},"right":{"article_title":"16ï½œtokioç¼–ç¨‹ï¼šä½¿ç”¨channelåœ¨ä¸åŒä»»åŠ¡é—´é€šä¿¡ï¼Ÿ","id":728107}},"comments":[{"had_liked":false,"id":384322,"user_name":"lilp","can_delete":false,"product_type":"c1","uid":2014371,"ip_address":"å¹¿ä¸œ","ucode":"CA4695BD25565B","user_header":"https://static001.geekbang.org/account/avatar/00/1e/bc/a3/7f753d36.jpg","comment_is_top":false,"comment_ctime":1700692138,"is_pvip":false,"replies":[{"id":140231,"content":"1 æ˜¯çš„ã€‚ 2 spawnåå°±ç«‹å³æ‰§è¡Œã€‚åé¢è¿™ä¸¤å¥åªæ˜¯ç­‰å¾…ä»»åŠ¡è¿”å›ã€‚åœ¨æ‰§è¡Œç¬¬äºŒå¥ä¹‹å‰æœ‰å¯èƒ½ç¬¬äºŒä¸ªä»»åŠ¡å·²ç»æ‰§è¡Œå®Œäº†ï¼Œç¬¬äºŒå¥åªæ˜¯æŠŠå…¶ä»»åŠ¡çš„è¿”å›å€¼å–å›æ¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700708354,"ip_address":"é‡åº†","comment_id":384322,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"1. åº”è¯¥æ˜¯é˜²æ­¢è¿™ä¸¤ä¸ªä»»åŠ¡è¿˜æ²¡èµ°å®Œï¼Œä¸»çº¿ç¨‹å°±ç»“æŸäº†ï¼Ÿ\n2. ä¸ä¼šé˜»å¡ã€‚æˆ‘ç†è§£çš„æ˜¯è¿™ä¸¤ä¸ªä»»åŠ¡ åŒæ—¶å¯åŠ¨ï¼Œé¡ºåºå®Œæˆã€‚ä¸ç®¡ä»–ä¿©æ€ä¹ˆå»æŠ¢è¿™ä¸ªé” æœ€åçš„å®Œæˆé¡ºåºåº”è¯¥è¿˜æ˜¯å’Œmainä¸­å†™çš„.await() é¡ºåºä¸€æ ·ã€‚","like_count":6,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632359,"discussion_content":"1 æ˜¯çš„ã€‚ 2 spawnåå°±ç«‹å³æ‰§è¡Œã€‚åé¢è¿™ä¸¤å¥åªæ˜¯ç­‰å¾…ä»»åŠ¡è¿”å›ã€‚åœ¨æ‰§è¡Œç¬¬äºŒå¥ä¹‹å‰æœ‰å¯èƒ½ç¬¬äºŒä¸ªä»»åŠ¡å·²ç»æ‰§è¡Œå®Œäº†ï¼Œç¬¬äºŒå¥åªæ˜¯æŠŠå…¶ä»»åŠ¡çš„è¿”å›å€¼å–å›æ¥ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1700708355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2014371,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/bc/a3/7f753d36.jpg","nickname":"lilp","note":"","ucode":"CA4695BD25565B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632486,"discussion_content":"å¥½å˜ æ˜ç™½äº† ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700826569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384334,"user_name":"PEtFiSh","can_delete":false,"product_type":"c1","uid":1765926,"ip_address":"ä¸Šæµ·","ucode":"C4922398A92E05","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLO6XvxfFPMGcVSSX8uIZY2yib29qlyat178pU4QM3gIic5GXZ8PC0tzRiazP3FiajXbTj19SE4ZhV0gQ/132","comment_is_top":false,"comment_ctime":1700706811,"is_pvip":false,"replies":[{"id":140236,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700729356,"ip_address":"é‡åº†","comment_id":384334,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"awaitä»£ç ä¼šæŒç»­ç­‰å¾…ç›´åˆ°ä»»åŠ¡ç»“æŸï¼Œå› æ­¤åœ¨main threadé‡Œç¬¬ä¸€è¡Œä¼šé˜»å¡ç¬¬äºŒè¡Œã€‚ä½†è¿™ä¸ä¼šè®©task_aé˜»å¡task_bã€‚åŠ å…¥awaitå¯ä»¥ä½¿æœ€åçš„println!æ‰“å°ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œå®Œä»¥åè¢«ä¿®æ”¹çš„dbå€¼ï¼Œå¦‚æœä¸åŠ å…¥awaitã€‚æœ‰ä¸€å®šå‡ ç‡æœ€åprintln!æ‰“å°çš„è¿˜æ˜¯åŸå§‹çš„db","like_count":4,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632394,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700729356,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384271,"user_name":"-","can_delete":false,"product_type":"c1","uid":1546505,"ip_address":"åŒ—äº¬","ucode":"7B34258D346793","user_header":"https://static001.geekbang.org/account/avatar/00/17/99/09/29c46a7b.jpg","comment_is_top":false,"comment_ctime":1700618619,"is_pvip":false,"replies":[{"id":140223,"content":"æ€è€ƒå¾—å¾ˆæ£’ï¼Œå‰åè”ç³»èµ·æ¥äº†ã€‚arc mutex å…¶å®æ˜¯æ‹¿åˆ°äº†å¯¹è±¡æ‰€æœ‰æƒï¼Œæœ‰æ‰€æœ‰æƒäº†å½“ç„¶ä¿®æ”¹å€¼å°±æ–¹ä¾¿äº†ã€‚è·Ÿå‰é¢å¹¶ä¸å†²çªï¼Œå½“ç„¶å¦‚æœè¿˜æƒ³æ·±å…¥ä¸‹å»ï¼Œå¯ä»¥çœ‹çœ‹ å†…éƒ¨å¯å˜æ€§ è¿™ä¸ªæ¦‚å¿µã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700707595,"ip_address":"é‡åº†","comment_id":384271,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼ŒArc::new(Mutex::new(db))åå¯ä»¥å°†ä¸€ä¸ªä¸å¯å˜çš„å˜é‡å˜æˆå¯å˜å˜é‡ï¼Ÿè¿™ä¸ªæ˜¯ä»€ä¹ˆåŸå› ","like_count":4,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632350,"discussion_content":"æ€è€ƒå¾—å¾ˆæ£’ï¼Œå‰åè”ç³»èµ·æ¥äº†ã€‚arc mutex å…¶å®æ˜¯æ‹¿åˆ°äº†å¯¹è±¡æ‰€æœ‰æƒï¼Œæœ‰æ‰€æœ‰æƒäº†å½“ç„¶ä¿®æ”¹å€¼å°±æ–¹ä¾¿äº†ã€‚è·Ÿå‰é¢å¹¶ä¸å†²çªï¼Œå½“ç„¶å¦‚æœè¿˜æƒ³æ·±å…¥ä¸‹å»ï¼Œå¯ä»¥çœ‹çœ‹ å†…éƒ¨å¯å˜æ€§ è¿™ä¸ªæ¦‚å¿µã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700707595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1979955,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","nickname":"seven9t","note":"","ucode":"B7CA7D62C56938","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635783,"discussion_content":"åº•å±‚ç”¨äº†unsafeç»•è¿‡","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1705199067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3779530,"avatar":"https://static001.geekbang.org/account/avatar/00/39/ab/ca/32d6c05d.jpg","nickname":"å“„å“„","note":"","ucode":"F75FB23BEDC60A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632286,"discussion_content":"dbçš„æ‰€æœ‰æƒæœ€åç»™äº†Arcï¼ŒMutexä¸Šé”ä¹‹åå°±å¯ä»¥è¯»å†™ï¼Œå…·ä½“æ€ä¹ˆå®ç°çš„æ²¡çœ‹æºç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700631403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386598,"user_name":"seven9t","can_delete":false,"product_type":"c1","uid":1979955,"ip_address":"å¹¿ä¸œ","ucode":"B7CA7D62C56938","user_header":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","comment_is_top":false,"comment_ctime":1705199249,"is_pvip":false,"replies":[{"id":140981,"content":"å…³äºè¿™ä¸ªè¯é¢˜ï¼Œå¯ä»¥çœ‹ä¸‹tokioå®˜ç½‘çš„ä¸€ä¸ªè¯´æ˜ï¼šhttps:&#47;&#47;tokio.rs&#47;tokio&#47;tutorial&#47;shared-state\nåŒºåˆ«å°±æ˜¯è¦ä¸è¦è·¨ await è¾¹ç•Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705414881,"ip_address":"é‡åº†","comment_id":386598,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å¯ä»¥è¯´ä¸‹å¦‚æœç”¨rustè‡ªå¸¦çš„Mutexè€Œä¸æ˜¯tokioçš„ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ ï¼ˆæ˜¯å¦å¿…é¡»é…å¥—","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635973,"discussion_content":"å…³äºè¿™ä¸ªè¯é¢˜ï¼Œå¯ä»¥çœ‹ä¸‹tokioå®˜ç½‘çš„ä¸€ä¸ªè¯´æ˜ï¼šhttps://tokio.rs/tokio/tutorial/shared-state\nåŒºåˆ«å°±æ˜¯è¦ä¸è¦è·¨ await è¾¹ç•Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705414881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384377,"user_name":"ä¸‹é›¨å¤©","can_delete":false,"product_type":"c1","uid":1008315,"ip_address":"æ¹–åŒ—","ucode":"816B3792ECC50A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/62/bb/323a3133.jpg","comment_is_top":false,"comment_ctime":1700736678,"is_pvip":false,"replies":[{"id":140243,"content":"spawnæ¯”è¾ƒç‰¹æ®Šï¼Œç‰¹æ®Šå¤„ç†çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700792851,"ip_address":"é‡åº†","comment_id":384377,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"çœ‹å®ç°ï¼Œå°±å½“å‰ä¾‹å­è€Œè¨€task_aä¸ä¼šé˜»å¡task_bã€‚ å¦‚æœtask_aä¸­loop{}ä¸‹å°±å¯ä»¥é˜»å¡äº†ã€‚\n\næœ‰ä¸ªç–‘é—®ï¼Œä¸ºå•¥task::spawnåé¢ä¼šè‡ªåŠ¨æ‰§è¡Œå‘¢ï¼Ÿ æˆ‘ç†è§£åªæœ‰.awaitäº†æ‰ä¼šåŠ åˆ°è°ƒåº¦å™¨é‡Œé¢æ‰§è¡Œã€‚","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632455,"discussion_content":"spawnæ¯”è¾ƒç‰¹æ®Šï¼Œç‰¹æ®Šå¤„ç†çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700792851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1008315,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/bb/323a3133.jpg","nickname":"ä¸‹é›¨å¤©","note":"","ucode":"816B3792ECC50A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":632466,"discussion_content":"ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700801238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":632455,"ip_address":"æ¹–åŒ—","group_id":0},"score":632466,"extra":""},{"author":{"id":2186188,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/cc/be5c5b75.jpg","nickname":"äº‘æ¸¸","note":"","ucode":"28048E54740904","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":649919,"discussion_content":"ä¸ºå•¥spawnè¦åšç‰¹æ®Šå¤„ç†å•Šï¼Ÿ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1724143042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":632455,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":649919,"extra":""}]},{"author":{"id":1979955,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","nickname":"seven9t","note":"","ucode":"B7CA7D62C56938","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635784,"discussion_content":"spawnæ˜¯åˆ›å»ºå¹¶å¯åŠ¨ï¼Œawaitæ˜¯ç­‰æ‰§è¡Œç»“æœ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705199159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384284,"user_name":"Geek_72807e","can_delete":false,"product_type":"c1","uid":3570665,"ip_address":"å±±è¥¿","ucode":"9E9A6277605048","user_header":"","comment_is_top":false,"comment_ctime":1700624465,"is_pvip":false,"replies":[{"id":140229,"content":"å¾ˆæ£’çš„æ€è€ƒğŸ‘ï¼Œæœ‰å¯èƒ½å‡ºç°ã€‚çœ‹å“ªä¸ªä»»åŠ¡åæ‰§è¡Œå®Œæˆï¼ŒåæŠ¢åˆ°é”ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700708051,"ip_address":"é‡åº†","comment_id":384284,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¯·é—®è€å¸ˆï¼Œæ–¹æ¡ˆå››ä¸­ï¼Œä¼šä¸ä¼šå‡ºç°ä¸¤æ¬¡ä¿®æ”¹æ“ä½œé¡ºåºä¸ç¡®å®šçš„é—®é¢˜ï¼Œæœ€ç»ˆç»“æ„å¯ä»¥æ˜¯40ï¼Œä¹Ÿä¼šæ˜¯100ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632356,"discussion_content":"å¾ˆæ£’çš„æ€è€ƒğŸ‘ï¼Œæœ‰å¯èƒ½å‡ºç°ã€‚çœ‹å“ªä¸ªä»»åŠ¡åæ‰§è¡Œå®Œæˆï¼ŒåæŠ¢åˆ°é”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700708051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3737491,"avatar":"https://static001.geekbang.org/account/avatar/00/39/07/93/710c7ee2.jpg","nickname":"ä¸å¿˜åˆå¿ƒ","note":"","ucode":"8262D42405F4E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632328,"discussion_content":"åŒé—®, æœ€ç»ˆç»“æœ, æ˜¯ä¸æ˜¯50, å’Œ100ä¸¤ç§å¯èƒ½éƒ½å­˜åœ¨?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700655509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386546,"user_name":"yunyi","can_delete":false,"product_type":"c1","uid":1139000,"ip_address":"å¹¿ä¸œ","ucode":"A3A66C4ACE2591","user_header":"https://static001.geekbang.org/account/avatar/00/11/61/38/d586a684.jpg","comment_is_top":false,"comment_ctime":1705050670,"is_pvip":false,"replies":[{"id":140979,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705411054,"ip_address":"é‡åº†","comment_id":386546,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"1ã€ä¸ºäº†ç­‰å¾…ä»»åŠ¡å®Œæˆ\n2ã€ä¸ä¼šé˜»å¡ï¼Œä¸¤ä¸ªä»»åŠ¡æ˜¯å¹¶è¡Œè¿è¡Œçš„ï¼Œç»“æœä¹Ÿæœ‰å¯èƒ½æ˜¯è¢«æ”¹æˆ50ï¼Œtaskbå…ˆå®Œæˆï¼Œå†æ‰§è¡Œtaskaã€‚","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635970,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705411054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384258,"user_name":"é›å’Œ","can_delete":false,"product_type":"c1","uid":2695785,"ip_address":"å¹¿ä¸œ","ucode":"C703A7FDCAD58C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/qUHuge7oea6mA4bUTyJ4rpTP7Havj5m2WEqKvrARDbe8HYnu52vQ8DfAWNkLEfQbic83ibDhnUZYRTwut5Dl8icDA/132","comment_is_top":false,"comment_ctime":1700611272,"is_pvip":false,"replies":[{"id":140225,"content":"ä¸ä¼šï¼Œä½ æ‰§è¡Œå°±çŸ¥é“äº†ã€‚åŸå› åœ¨ä¸‹ä¸€è®²æœ‰è®²ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700707897,"ip_address":"é‡åº†","comment_id":384258,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"ä¼šï¼Œå› ä¸ºè¦è·å–mutex","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632352,"discussion_content":"ä¸ä¼šï¼Œä½ æ‰§è¡Œå°±çŸ¥é“äº†ã€‚åŸå› åœ¨ä¸‹ä¸€è®²æœ‰è®²ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700707897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386684,"user_name":"Geek_3b58b9","can_delete":false,"product_type":"c1","uid":3196265,"ip_address":"æ±Ÿè‹","ucode":"E9DE52FD0B5E29","user_header":"","comment_is_top":false,"comment_ctime":1705328308,"is_pvip":false,"replies":[{"id":140980,"content":"æ™ºèƒ½æŒ‡é’ˆä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„cé‚£ç§æŒ‡é’ˆã€‚ é”çš„å®ç°å°±éœ€è¦ç”¨åˆ°æŒ‡ä»¤é›†å±‚é¢çš„åŸå­æŒ‡ä»¤æ¥ä¼˜åŒ–ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705411188,"ip_address":"é‡åº†","comment_id":386684,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å¯¹åŸå­å˜é‡çš„è¯»å†™è®¿é—®å¯ä»¥ç”¨æŒ‡é’ˆï¼Ÿè¿˜æ˜¯è¯´åº”è¯¥ç”¨ä¸“é—¨çš„APIï¼Ÿæˆ‘è®°å¾—åŸå­ç±»å‹æœ‰ç‰¹å®šçš„CPUæŒ‡ä»¤çš„","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635971,"discussion_content":"æ™ºèƒ½æŒ‡é’ˆä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„cé‚£ç§æŒ‡é’ˆã€‚ é”çš„å®ç°å°±éœ€è¦ç”¨åˆ°æŒ‡ä»¤é›†å±‚é¢çš„åŸå­æŒ‡ä»¤æ¥ä¼˜åŒ–ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705411189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386540,"user_name":"yunyi","can_delete":false,"product_type":"c1","uid":1139000,"ip_address":"å¹¿ä¸œ","ucode":"A3A66C4ACE2591","user_header":"https://static001.geekbang.org/account/avatar/00/11/61/38/d586a684.jpg","comment_is_top":false,"comment_ctime":1705045034,"is_pvip":false,"replies":[{"id":140910,"content":"å¹¸ä¼šå¹¸ä¼š","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1705068291,"ip_address":"é‡åº†","comment_id":386540,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å“‡ ï¼Œå±…ç„¶çœ‹åˆ°äº†Erlangçš„å­—çœ¼ï¼Œæˆ‘ä¸€ç›´æ˜¯ç”¨erlangåšä¸ºä¸»åŠ›è¯­è¨€çš„åç«¯å¼€å‘ï¼Œæœ€è¿‘åœ¨å­¦rustï¼Œæ‰¾äº†å¾ˆå¤šèµ„æ–™ï¼Œæœ€åä¹°äº†è€å¸ˆçš„æ•™ç¨‹ï¼Œå¦‚è·è‡³å®","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635715,"discussion_content":"å¹¸ä¼šå¹¸ä¼š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705068291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385721,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1703156490,"is_pvip":false,"replies":[{"id":140589,"content":"1. Arc::clone(arc_db) å’Œ arc_db.clone()  æ˜¯ä¸€æ ·çš„ã€‚\n2. æ•™ç¨‹é‡Œé¢ç”¨ tokio çš„ Arcï¼ŒMutexï¼Œä¸»è¦æ˜¯ä¸ç»™åŒå­¦å¼•å…¥é¢å¤–çš„ç†è§£è´Ÿæ‹…ã€‚ä¸ç„¶è¦å­¦çš„ä¸œè¥¿åˆå¤šäº†ã€‚\n\nå…³äºå®ƒä»¬çš„å·®åˆ«ï¼Œå¯ä»¥çœ‹è¿™é‡Œï¼šhttps:&#47;&#47;tokio.rs&#47;tokio&#47;tutorial&#47;shared-state   On using std::sync::Mutex","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703232734,"ip_address":"é‡åº†","comment_id":385721,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"é—®ä¸ªäº‹å„¿ï¼Œ Arc::clone(arc_db) å’Œ arc_db.clone() ä¸€æ ·å—ï¼Ÿ\n\nä¸ºå•¥ ä¸ç”¨ `std::sync::{Arc, Mutex}` è€Œæ˜¯ `tokio::sync::{Arc, Mutex}`\n\nå¦‚æœæ˜¯å› ä¸ºåœ¨ tokio runtime é‡Œå¤´è¦ç”¨ tokio çš„ä¸œè¥¿çš„è¯ï¼Œ é‚£ä¹ˆåœ¨å•¥æƒ…å†µä¸‹ä¼šç”¨ std çš„å‡ æ¿æ–§å‘¢ï¼Ÿ\n\nåŒæ­¥åœºæ™¯éƒ½ç”¨ std::sync åº•ä¸‹çš„ä¸œè¥¿å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634339,"discussion_content":"1. Arc::clone(arc_db) å’Œ arc_db.clone()  æ˜¯ä¸€æ ·çš„ã€‚\n2. æ•™ç¨‹é‡Œé¢ç”¨ tokio çš„ Arcï¼ŒMutexï¼Œä¸»è¦æ˜¯ä¸ç»™åŒå­¦å¼•å…¥é¢å¤–çš„ç†è§£è´Ÿæ‹…ã€‚ä¸ç„¶è¦å­¦çš„ä¸œè¥¿åˆå¤šäº†ã€‚\n\nå…³äºå®ƒä»¬çš„å·®åˆ«ï¼Œå¯ä»¥çœ‹è¿™é‡Œï¼šhttps://tokio.rs/tokio/tutorial/shared-state   On using std::sync::Mutex","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1703232735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":3623568,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","nickname":"superggn","note":"","ucode":"831CCD98B393FE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":634353,"discussion_content":"æ„Ÿè°¢çŒ›ç”·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703273697,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":634339,"ip_address":"åŒ—äº¬","group_id":0},"score":634353,"extra":""}]},{"author":{"id":3623568,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","nickname":"superggn","note":"","ucode":"831CCD98B393FE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634329,"discussion_content":"- Arc::clone å’Œ arc_db.clone åŠŸèƒ½ä¸€è‡´ï¼Œ åªæ˜¯æ ¼å¼çš„åŒºåˆ«\n- Arc åœ¨ std tokio é‡Œæ˜¯é€šç”¨çš„ï¼Œ tokio::sync é‡Œæ²¡æœ‰ Arc\n- Mutex åŒºåˆ† std å’Œ tokio, è¿™æ˜¯åŠŸèƒ½éœ€è¦ï¼Œ æ˜¯å¿…é¡»åŒºåˆ†çš„\n- åŒæ­¥ç”¨ std::sync::Mutex, å¼‚æ­¥ tokio::sync::Mutex åŠ äº†ä¸€äº›ç‰¹æ€§ä»è€Œèƒ½é€‚åº”å¼‚æ­¥åœºæ™¯ï¼Œ æ‰€ä»¥å¼‚æ­¥å¿…é¡»ç”¨ tokio::sync::Mutex, ä¸èƒ½ç”¨ std çš„ä¸œè¥¿","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1703223700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385720,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1703156284,"is_pvip":false,"replies":[{"id":140634,"content":"å¾ˆæ£’","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703577919,"ip_address":"é‡åº†","comment_id":385720,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"æ€è€ƒé¢˜\næ„ä¹‰ï¼š ç­‰æ‰§è¡Œå®Œäº†å†æ‰“å°ï¼Œ å¯¹é½ä¸€ä¸‹å­ï¼Œ åˆ«ä»»åŠ¡æ²¡è·‘å®Œä¸»è¿›ç¨‹å°±å®Œäº‹å„¿äº†\nåˆ° await è¿™å—å„¿å°±æ˜¯åŒæ­¥äº†ï¼Œ è¿™ä¿© await æ˜¯é¡ºåºæ‰§è¡Œï¼Œ \nå¦‚æœ task_a æ²¡æ‰§è¡Œå®Œï¼Œ task_b å·²ç»æ‰§è¡Œå®Œäº†ï¼Œ å°±ä¼šå¡åœ¨ task_a è¿™é‡Œï¼Œ task_a è¿™è¡Œå®Œäº‹å„¿äº†åœ¨æ‰§è¡Œ task_b çš„ await, è¿™ä¼šå„¿ task_b å› ä¸ºå·²ç»å®Œäº‹å„¿äº†ï¼Œ æ‰€ä»¥ç¬¬2ä¸ª await ä¸ä¼šå¡\n","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634500,"discussion_content":"å¾ˆæ£’","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703577919,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385670,"user_name":"-HedonğŸ­","can_delete":false,"product_type":"c1","uid":3176234,"ip_address":"æ¹–åŒ—","ucode":"FAE541E7A2B88F","user_header":"https://static001.geekbang.org/account/avatar/00/30/77/2a/0cd4c373.jpg","comment_is_top":false,"comment_ctime":1703073940,"is_pvip":false,"replies":[{"id":140555,"content":"å¯¹çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703122482,"ip_address":"é‡åº†","comment_id":385670,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"task_a.await.unwrap() æ˜¯é˜»å¡ç­‰å¾…ä»»åŠ¡ç»“æœï¼Œæ‰€ä»¥ task_a.await.unwrap() ä¼šé˜»å¡ task_b.await.unwrap() ï¼Œä½†æ˜¯ task_a ä¸ä¼šé˜»å¡ task_bï¼Œspwan å¹¶å‘æ‰§è¡Œçš„ã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634230,"discussion_content":"å¯¹çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703122482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385447,"user_name":"Geek_e5eb33","can_delete":false,"product_type":"c1","uid":1934555,"ip_address":"å®‰å¾½","ucode":"296CC5358A4788","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/axiaxUndY1I8iaOu5qZOwFiaKgicR1AlWsSUyyYIMdEnibuhhzuQnicvXibaOxSakMNAQIPmgicsTfPvUnWJ5WCFzmdHDw/132","comment_is_top":false,"comment_ctime":1702629541,"is_pvip":false,"replies":[{"id":140471,"content":"é€šè¿‡å‡½æ•°å‚æ•°ä¼ é€’è¿›æ¥ã€‚ç”Ÿæˆçš„æ‰€æœ‰æƒå¯¹è±¡é€šè¿‡å‡½æ•°å€¼è¿”å›ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1702701878,"ip_address":"é‡åº†","comment_id":385447,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"è¯·é—®è€å¸ˆï¼Œrust ä¸­ä¸å»ºè®®ä½¿ç”¨å…¨å±€å˜é‡ã€‚é‚£å¦‚æœæˆ‘æƒ³è¿›è¡Œæ¨¡å—åŒ–å¼€å‘ï¼Œåœ¨ A æ¨¡å—ä¸­å®šä¹‰çš„å˜é‡(æ¯”å¦‚ç¼“å­˜äº†ç”¨æˆ·ä¿¡æ¯)ï¼Œæ€ä¹ˆä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨å‘¢ï¼Œç›®å‰èƒ½æƒ³åˆ°çš„æ˜¯éƒ½å®šä¹‰åˆ° main é‡Œã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633874,"discussion_content":"é€šè¿‡å‡½æ•°å‚æ•°ä¼ é€’è¿›æ¥ã€‚ç”Ÿæˆçš„æ‰€æœ‰æƒå¯¹è±¡é€šè¿‡å‡½æ•°å€¼è¿”å›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702701878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384293,"user_name":"Taozi","can_delete":false,"product_type":"c1","uid":1021926,"ip_address":"ä¸Šæµ·","ucode":"DD6567A31B3E33","user_header":"","comment_is_top":false,"comment_ctime":1700636397,"is_pvip":false,"replies":[{"id":140230,"content":"ğŸ‘å¾ˆæ£’çš„åˆ†æï¼Œèµ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700708139,"ip_address":"é‡åº†","comment_id":384293,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"å…³äºarcé‡Œé¢ä¸ºä½•éœ€è¦å¥—lockæ‰èƒ½ä¿®æ”¹å€¼ï¼Œå½“ç„¶æ˜¯ä¸ºäº†åœ¨è¿è¡Œæ—¶ä¿è¯å†…å­˜å®‰å…¨ã€‚ä¸ºä»€ä¹ˆè¯´åœ¨è¿è¡Œæ—¶ï¼Œå› ä¸ºè¿˜æœ‰å¯¹åº”çš„åœ¨é™æ€æ—¶ã€‚è¿˜è®°å¾—æœ€å¼€å§‹æˆ‘ä»¬è¯´rustä¸­æ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªownerï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯oweråœ¨å…¶ä½œç”¨åŸŸç»“æŸæ—¶é‡Šæ”¾å€¼ï¼Œè¿™æ˜¯å¯ä»¥é€šè¿‡ä»£ç é™æ€åˆ†æå‡ºæ¥çš„ã€‚å¯¹äºæ‰€æœ‰æƒä¸èƒ½é™æ€ç¡®å®šçš„æƒ…å†µï¼Œå°±éœ€è¦arcæ¥è¿™ä¸ªç¬¬ä¸‰æ–¹æ¥æŒæœ‰æ‰€æœ‰æƒï¼Œç„¶ååŠ¨æ€çš„å†³å®šä½•æ—¶é‡Šæ”¾å€¼ã€‚åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å¼•ç”¨è®¡æ•°ã€‚åŒæ ·æœ€å¼€å§‹æˆ‘ä»¬ä¹Ÿè¯´ä¸€ä¸ªå€¼åªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªå¯å˜å€Ÿç”¨æˆ–è€…å¤šä¸ªä¸å¯å˜å€Ÿç”¨ï¼Œè¿™ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡é™æ€åˆ†æä¿è¯çš„ï¼Œä½†æ˜¯åœ¨arcè¿™é‡Œåªèƒ½é€šè¿‡åŠ é”åœ¨è¿è¡Œæ—¶ä¿è¯è¿™ç‚¹ã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632357,"discussion_content":"ğŸ‘å¾ˆæ£’çš„åˆ†æï¼Œèµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700708139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384278,"user_name":"Geek_6fjt20","can_delete":false,"product_type":"c1","uid":1672482,"ip_address":"åŒ—äº¬","ucode":"B7EB9B061E2C06","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqrbHib1v0wPRVHxrFK2CPQQX8Wg3rRMPiaZ5teMKu5klT48yns6yo4krZsIqHskwdEsibVvQ3QB7CUQ/132","comment_is_top":false,"comment_ctime":1700623036,"is_pvip":false,"replies":[{"id":140228,"content":"ä¸é”™ğŸ‘Œ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700707950,"ip_address":"é‡åº†","comment_id":384278,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"å¤ªæ–¹ä¾¿äº†ï¼Œä¸åƒjavaï¼Œå³ä½¿æœ‰å„ç§åŒæ­¥é”ä¹Ÿè¦è€ƒè™‘å¤šç§æƒ…å†µä¸‹çš„ä¸ä¸€è‡´","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632355,"discussion_content":"ä¸é”™ğŸ‘Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700707950,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384272,"user_name":"å“„å“„","can_delete":false,"product_type":"c1","uid":3779530,"ip_address":"åŒ—äº¬","ucode":"F75FB23BEDC60A","user_header":"https://static001.geekbang.org/account/avatar/00/39/ab/ca/32d6c05d.jpg","comment_is_top":false,"comment_ctime":1700619193,"is_pvip":false,"replies":[{"id":140222,"content":"å¯¹ï¼Œå…³é”®ç‚¹åœ¨äºspawnï¼Œä¸‹ä¸€èŠ‚ä¼šä¸“é—¨æåˆ°è¿™ä¸ªã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700707448,"ip_address":"é‡åº†","comment_id":384272,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"çœ‹å‘½åæ˜¯å¦è§„èŒƒï¼Œæœ‰äº›äººä¼šå°†futureå‘½åä¸ºtaskã€‚å¦‚æœtask_aå’Œtask_béƒ½æ˜¯taskï¼Œé‚£ä¹ˆä»–ä»¬éƒ½ä¼šåœ¨å„è‡ªæ‰§è¡Œï¼Œtask_bä¸éœ€è¦ç­‰å¾…task_aå®Œæˆæ‰å¼€å§‹æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨spawnä¹‹åå°±å¼€å§‹æ‰§è¡Œã€‚å¦‚æœå¦‚æœtask_aå’Œtask_béƒ½æ˜¯futureï¼Œé‚£ä¹ˆå°±æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œtask_bå¿…é¡»ç­‰å¾…task_aå®Œæˆæ‰èƒ½æ‰§è¡Œã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632348,"discussion_content":"å¯¹ï¼Œå…³é”®ç‚¹åœ¨äºspawnï¼Œä¸‹ä¸€èŠ‚ä¼šä¸“é—¨æåˆ°è¿™ä¸ªã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700707448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384259,"user_name":"å“„å“„","can_delete":false,"product_type":"c1","uid":3779530,"ip_address":"åŒ—äº¬","ucode":"F75FB23BEDC60A","user_header":"https://static001.geekbang.org/account/avatar/00/39/ab/ca/32d6c05d.jpg","comment_is_top":false,"comment_ctime":1700612238,"is_pvip":false,"replies":[{"id":140224,"content":"å¯¹çš„ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸ªä¾‹å­ https:&#47;&#47;github.com&#47;Amanieu&#47;parking_lot&#47;issues&#47;212 ã€‚å…³äºrustä¸­çš„deadlockæˆ‘åé¢ä¼šåœ¨è¿™ä¸ªè¯¾ç¨‹ä¹‹å¤–å•ç‹¬å†™ä¸“é¢˜åˆ†æã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700707841,"ip_address":"é‡åº†","comment_id":384259,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"Rwlockï¼šè¯·é—®æ€ä¹ˆç†è§£ï¼šEach read and write should be run in its own task.Otherwise ,they can cause a deadlock.","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632351,"discussion_content":"å¯¹çš„ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸ªä¾‹å­ https://github.com/Amanieu/parking_lot/issues/212 ã€‚å…³äºrustä¸­çš„deadlockæˆ‘åé¢ä¼šåœ¨è¿™ä¸ªè¯¾ç¨‹ä¹‹å¤–å•ç‹¬å†™ä¸“é¢˜åˆ†æã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700707842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3779530,"avatar":"https://static001.geekbang.org/account/avatar/00/39/ab/ca/32d6c05d.jpg","nickname":"å“„å“„","note":"","ucode":"F75FB23BEDC60A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":632390,"discussion_content":"è€å¸ˆï¼Œrustçš„ç¼–è¯‘å™¨ç”Ÿæˆæ‰§è¡Œä»£ç æ—¶ï¼Œæ˜¯ä¸æ˜¯å¯¹ä»£ç æ‰§è¡Œè¿›è¡Œäº†ä¼˜åŒ–ï¼Ÿå› ä¸ºrustè§„åˆ™ä¸­ï¼Œä¸€ä¸ªscopå†…çš„&amp;å’Œ&amp;mutä¸ºäº†é¿å…data raceçš„ä¸å…±å­˜é™åˆ¶æœºåˆ¶ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å®Œå…¨æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œï¼Œæˆ‘æ€ä¹ˆæƒ³ä¹Ÿæ˜¯ä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰çš„å‘€ã€‚åŒç†ï¼ŒRwlockä¹Ÿæœ‰è¿™æ ·çš„ä½¿ç”¨é™åˆ¶ç–‘é—®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700726256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":632351,"ip_address":"åŒ—äº¬","group_id":0},"score":632390,"extra":""}]}]},{"had_liked":false,"id":384257,"user_name":"ä¼¯é˜³","can_delete":false,"product_type":"c1","uid":1596631,"ip_address":"åŒ—äº¬","ucode":"DBDC8735AA54AD","user_header":"https://static001.geekbang.org/account/avatar/00/18/5c/d7/3b92bb0d.jpg","comment_is_top":false,"comment_ctime":1700603438,"is_pvip":false,"replies":[{"id":140226,"content":"666","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700707907,"ip_address":"é‡åº†","comment_id":384257,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"ç¡®å®æ¯”å…¶ä»–è¯­è¨€æ–¹ä¾¿å¤šä¸€äº›","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632353,"discussion_content":"666","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700707907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}