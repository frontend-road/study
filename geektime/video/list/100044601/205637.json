{"id":205637,"title":"33 | é›†æˆäº‹ä»¶ï¼šä½¿ç”¨RabbitMQæ¥å®ç°EventBus","content":"<p><strong>è¯¾ä»¶å’ŒDemoåœ°å€</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":197122,"user_name":"è‰¾roger","can_delete":false,"product_type":"c3","uid":1359790,"ip_address":"","ucode":"9F65CE9A81D6DB","user_header":"","comment_is_top":false,"comment_ctime":1585358966,"is_pvip":false,"replies":[{"id":77158,"content":"å¾ˆå¥½çš„å»ºè®®ï¼Œè¿™é‡Œåº”è¯¥è®¾è®¡æ¥å£è¿›è¡Œéš”ç¦»","user_name":"ä½œè€…å›å¤","user_name_real":"è‚–ä¼Ÿå®‡","uid":1756585,"ctime":1586875607,"ip_address":"","comment_id":197122,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"åº”è¯¥å‘å¸ƒå™¨åŒ…è£…ä¸‹æ¥å£ï¼Œä¸è¦å°†icappublisherç­‰capæ¡†æ¶ç›´æ¥åœ¨é¢†åŸŸå±‚å¼•å…¥ï¼Œè€Œé€ æˆé¢†åŸŸäº‹ä»¶çš„ä¾èµ–æ±¡æŸ“","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"è€è‚–æƒ³å½“å¤–è¯­å¤§ä½¬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489452,"discussion_content":"å¾ˆå¥½çš„å»ºè®®ï¼Œè¿™é‡Œåº”è¯¥è®¾è®¡æ¥å£è¿›è¡Œéš”ç¦»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586875607,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223558,"user_name":"å¼ å¿—ç‚œ","can_delete":false,"product_type":"c3","uid":1221549,"ip_address":"","ucode":"31643B345C5B27","user_header":"https://static001.geekbang.org/account/avatar/00/12/a3/ad/79b26eea.jpg","comment_is_top":false,"comment_ctime":1591114029,"is_pvip":false,"replies":[{"id":83289,"content":"çœ‹çœ‹ç»„ä»¶ç‰ˆæœ¬çš„åŒºåˆ«","user_name":"ä½œè€…å›å¤","user_name_real":"è‚–ä¼Ÿå®‡","uid":1756585,"ctime":1591950287,"ip_address":"","comment_id":223558,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"è€å¸ˆï¼Œåœ¨è¿™èŠ‚è¯¾é‡åˆ°äº†3ä¸ªé—®é¢˜ï¼š\n1ã€åºåˆ—åŒ–çš„æ—¶å€™ï¼Œæç¤ºDomainEventsåºåˆ—åŒ–æ­»å¾ªç¯ï¼Œå¯¼è‡´æˆ‘éœ€è¦å¢åŠ [IgnoreDataMember]æ³¨è§£ï¼Œå¯æ˜¯çœ‹è€å¸ˆçš„æ¡ˆä¾‹é‡Œé¢æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚\n2ã€åœ¨é¢†åŸŸäº‹ä»¶ä¸­ï¼Œé¢†åŸŸäº‹ä»¶å¯ä»¥ç¡®å®šåªæ¨é€äº†ä¸€æ¬¡ï¼Œä½†æ˜¯Handlerè¿™è¾¹ï¼Œå´å¤„ç†äº†2æ¬¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆäº†ã€‚\n3ã€åœ¨é›†æˆäº‹ä»¶è¿™è¾¹ï¼Œäº‹ä»¶æ­£å¸¸å‘å‡ºå»äº†ï¼Œç„¶åæ¥æ”¶åˆ°çš„æ—¶å€™ï¼ŒIDå’ŒAddresså´ååºåˆ—åŒ–å¤±è´¥äº†ï¼Œç›´åˆ°æˆ‘å°†ID { get; protected set; }æ”¹æˆäº†IDï½›get;set;ï½ä¹‹åï¼Œæ‰èƒ½æˆåŠŸè·å–ï¼ŒAddressåŒæ ·ï¼Œéƒ½éœ€è¦å°†Setè®¾ç½®æˆåŠŸPublicä¹‹åæ‰èƒ½æ­£å¸¸è·å–ã€‚\nä½†æ˜¯å…¶ä»–Orderä¸­çš„å‚æ•°ï¼ŒSetä¾ç„¶æ˜¯privateï¼Œå´æ²¡æœ‰é—®é¢˜ï¼Ÿ\nâ€¦â€¦\nç„¶åæˆ‘è¿è¡Œäº†è€å¸ˆçš„Demoï¼Œéƒ½æ²¡æœ‰è¿™äº›é—®é¢˜ã€‚ã€‚å¯æ˜¯æˆ‘å¯¹æ¯”èµ·æ¥ï¼Œæ€»æ„Ÿè§‰ä»£ç æ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚ã€‚è€å¸ˆèƒ½è¯´ä¸‹ï¼Œè¿™é—®é¢˜å‡ºåœ¨å“ªé‡Œä¹ˆã€‚\næˆ–è€…å¯èƒ½å‡ºç°åœ¨å“ªäº›åŸå› ä¸Šä¹ˆã€‚ã€‚","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"è€è‚–æƒ³å½“å¤–è¯­å¤§ä½¬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497165,"discussion_content":"çœ‹çœ‹ç»„ä»¶ç‰ˆæœ¬çš„åŒºåˆ«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591950287,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":183749,"user_name":"é™ˆæ­£æ–‡","can_delete":false,"product_type":"c3","uid":1107451,"ip_address":"","ucode":"D1DF7997BA4105","user_header":"https://static001.geekbang.org/account/avatar/00/10/e5/fb/5b186d20.jpg","comment_is_top":false,"comment_ctime":1583126237,"is_pvip":false,"replies":[{"id":71582,"content":"çœ‹èµ·æ¥åƒæ˜¯é…ç½®æ²¡æ³¨å†Œå¯¹ï¼Œä½ éœ€è¦å¼•å…¥ï¼š\nMicrosoft.EntityFrameworkCore.SqlServer\n\nå°†ï¼š\nbuilder.UseMySql(connectionString);\næ”¹ä¸ºï¼š\nbuilder.UseSqlServer(connectionString);","user_name":"ä½œè€…å›å¤","user_name_real":"è‚–ä¼Ÿå®‡","uid":1756585,"ctime":1583566260,"ip_address":"","comment_id":183749,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"æŠŠmysqlæ¢æˆsqlserveråæŠ¥é”™å¦‚ä¸‹ï¼šSystem.InvalidOperationException:â€œValueFactory attempted to access the Value property of this instance.â€\næ­¤å¼‚å¸¸æœ€åˆæ˜¯åœ¨æ­¤è°ƒç”¨å †æ ˆä¸­å¼•å‘çš„:\n\tSystem.Lazy&lt;T&gt;.ViaFactory(System.Threading.LazyThreadSafetyMode)\n\tSystem.Lazy&lt;T&gt;.ExecutionAndPublication(System.LazyHelper, bool)\n\tSystem.Lazy&lt;T&gt;.CreateValue()\n\tSystem.Lazy&lt;T&gt;.Value.get()\n\tMicrosoft.Extensions.Options.OptionsCache&lt;TOptions&gt;.GetOrAdd(string, System.Func&lt;TOptions&gt;)\n\tMicrosoft.Extensions.Options.OptionsManager&lt;TOptions&gt;.Get(string)\n\tMicrosoft.Extensions.Options.OptionsManager&lt;TOptions&gt;.Value.get()\n\tDotNetCore.CAP.SqlServer.SqlServerStorageInitializer.GetPublishedTableName()\n\tDotNetCore.CAP.SqlServer.SqlServerDataStorage.SqlServerDataStorage(Microsoft.Extensions.Options.IOptions&lt;DotNetCore.CAP.CapOptions&gt;, Microsoft.Extensions.Options.IOptions&lt;DotNetCore.CAP.SqlServerOptions&gt;, DotNetCore.CAP.Persistence.IStorageInitializer)","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"è€è‚–æƒ³å½“å¤–è¯­å¤§ä½¬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485769,"discussion_content":"çœ‹èµ·æ¥åƒæ˜¯é…ç½®æ²¡æ³¨å†Œå¯¹ï¼Œä½ éœ€è¦å¼•å…¥ï¼š\nMicrosoft.EntityFrameworkCore.SqlServer\n\nå°†ï¼š\nbuilder.UseMySql(connectionString);\næ”¹ä¸ºï¼š\nbuilder.UseSqlServer(connectionString);","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583566260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1107451,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e5/fb/5b186d20.jpg","nickname":"é™ˆæ­£æ–‡","note":"","ucode":"D1DF7997BA4105","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195826,"discussion_content":"é—®é¢˜æ‰¾åˆ°äº†ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯aspnetcore.capçš„ä¸€ä¸ªbug,é€šè¿‡æŸ¥çœ‹capçš„åŸç å‘ç°ï¼Œå¦‚æœåœ¨EFContextä¸­æ³¨å…¥ICapPublisherï¼Œä¼šå¯¼è‡´åœ¨åˆå§‹åŒ–EFContextæ—¶è·å–ä¾èµ–é¡¹ä¸­çš„IOption<SqlServerOptions>æ—¶æŠ¥é”™","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583313403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1156746,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a6/8a/d6e6aab8.jpg","nickname":"ç§¦æ—¶æ˜æœˆ","note":"","ucode":"B76BE4440BD6EE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245689,"discussion_content":"æˆ‘ä¹Ÿæ˜¯æŠ¥åŒæ ·çš„é”™è¯¯æŠŠoptions.UseEntityFramework<DomainContext>()æ¢æˆoptions.UseSqlServerå°±æ²¡é—®é¢˜äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587691945,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306154,"user_name":"ğŸ‘‘ ğŸ‘‘","can_delete":false,"product_type":"c3","uid":2626523,"ip_address":"","ucode":"035BB06DBBE345","user_header":"https://static001.geekbang.org/account/avatar/00/28/13/db/d5222c1c.jpg","comment_is_top":false,"comment_ctime":1628409337,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"å‡ºç° ValueFactory attempted to access the Value property of this instance.é”™è¯¯å¥½åƒæ˜¯å› ä¸ºåˆå§‹åŒ–æ—¶ä¸åº”è¯¥EFContextçš„æ„é€ å‡½æ•°ä¸­è¿›è¡ŒæœåŠ¡çš„æ³¨å†Œã€‚\nå¯ä»¥å°†å®ƒä»æ„é€ å‡½æ•°ä¸­ç§»é™¤æ–°å»ºä¸€ä¸ªé™æ€çš„èµ‹å€¼æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ã€‚å¹¶ä¸”åœ¨Controllerçš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œæ³¨å†Œå¹¶è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œèµ‹å€¼ã€‚\nEFContextï¼š\n public static void SetICapPublisher(ICapPublisher capBus)\n        {\n            _capBus = capBus;\n        }\nControllerï¼š\n public UserController(IMediator mediator, ICapPublisher capBus)\n        {\n            this._mediator = mediator;\n            DomainContext.SetICapPublisher(capBus);\n        }\nStartUPï¼š\nUserMySqlä¿®æ”¹ä¸º UseSqlServer\n\nå¦‚æœå‡ºç°_capPublisher.PublishAsyncæ–¹æ³•æç¤ºâ€œcap.publishedâ€ä¸å­˜åœ¨\nå¯èƒ½æ˜¯ICapPublisheråˆå§‹åŒ–æ—¶æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹ä¸€ä¸‹controlleræ„é€ å‡½æ•°ä¸­ICapPublisherèµ‹å€¼æ—¶å®ƒçš„ConnectionStringæ˜¯å¦ä¸ºç©ºã€‚\né€šå¸¸éƒ½æ˜¯ç¼ºå°‘ options.UseEntityFramework&lt;DomainContext&gt;();é€ æˆçš„ã€‚\nConnectionStringæŸ¥çœ‹ï¼š\ncapBusåŠ å…¥ç›‘æ§ï¼ŒNon-Public members =ã€‹_storage =&gt;Non-Public members=&gt;_initialzer=&gt;Non-Public members=&gt;_options=&gt;Value","like_count":2},{"had_liked":false,"id":246259,"user_name":"XINGHE","can_delete":false,"product_type":"c3","uid":1809135,"ip_address":"","ucode":"5B659283931B95","user_header":"https://static001.geekbang.org/account/avatar/00/1b/9a/ef/f3567104.jpg","comment_is_top":false,"comment_ctime":1599229501,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"è¯·æ•™è€å¸ˆï¼Œä½¿ç”¨CAPæ¡†æ¶ï¼Œå¦‚æœBæœåŠ¡æ¥æ”¶AæœåŠ¡çš„äº‹ä»¶ï¼Œä½†æ˜¯æ— æ³•å®Œæˆå¤„ç†ï¼ŒæœåŠ¡AæœåŠ¡è¿›è¡Œå›æ»šï¼Œåº”è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿ","like_count":2},{"had_liked":false,"id":349569,"user_name":"å†è§ç†æƒ³","can_delete":false,"product_type":"c3","uid":1245999,"ip_address":"","ucode":"FAC88B3F6F6DFD","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg","comment_is_top":false,"comment_ctime":1656072296,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"services.AddCap(x =&gt;\n            {\n                x.UseEntityFramework&lt;AppDbContext&gt;();\nåœ¨dbContextä¸­ ä½¿ç”¨Icappublish ä¼šæœ‰å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œè°ƒè¯•äº†ä¸€å¤©æœ€åçœ‹äº†ä¸€ä¸‹ capçš„æºç ï¼Œ\nWe detected that you are using ICapPublisher in DbContext, please change the configuration to use the storage extension directly to avoid circular references! eg:  x.UseMySql()","like_count":1},{"had_liked":false,"id":247512,"user_name":"beReply","can_delete":false,"product_type":"c3","uid":1912096,"ip_address":"","ucode":"45B0A70397B5CA","user_header":"https://static001.geekbang.org/account/avatar/00/1d/2d/20/d7fc08ea.jpg","comment_is_top":false,"comment_ctime":1599730294,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"sqlserveræ•°æ®åº“\nä½¿ç”¨options.UseEntityFramework&lt;DomainContext&gt;();æ³¨å†Œä¼šæŠ¥ValueFactory attempted to access the Value property of this instance.â€\nä½¿ç”¨options.UseSqlServer(configuration.GetConnectionString(&quot;DefaultConnection&quot;));æ­£å¸¸è¿è¡Œ\nåœ¨è¿™ä¹‹å‰å¯¹sqlServerè¿›è¡Œäº†æ³¨å†Œï¼Œ\n service.AddDbContext&lt;DomainContext&gt;(options =&gt; options\n                .UseSqlServer(connectString));","like_count":1,"discussions":[{"author":{"id":2626523,"avatar":"https://static001.geekbang.org/account/avatar/00/28/13/db/d5222c1c.jpg","nickname":"ğŸ‘‘ ğŸ‘‘","note":"","ucode":"035BB06DBBE345","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385814,"discussion_content":"ç‰›é€¼å•Šè€å“¥ã€‚ä¸€ç›´è§‰å¾—è¿™é‡Œæœ‰é—®é¢˜ï¼Œä½†æ˜¯ä¸æ‡‚.net core ä¸çŸ¥é“å…·ä½“æ˜¯å“ªé‡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627285626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301951,"user_name":"æ²é›ª","can_delete":false,"product_type":"c3","uid":1028301,"ip_address":"","ucode":"0C42BF0D75FD9B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b0/cd/c54572fe.jpg","comment_is_top":false,"comment_ctime":1625993383,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"services.AddTransient&lt;ISubscriberService, SubscriberService&gt;() è¿™é‡Œçš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥æ˜¯ä½¿ç”¨ å•ä¾‹æ¨¡å¼å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":288528,"user_name":"é¥­","can_delete":false,"product_type":"c3","uid":1610573,"ip_address":"","ucode":"B3F1702D4DE604","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJKj3GbvevFibxwJibTqm16NaE8MXibwDUlnt5tt73KF9WS2uypha2m1Myxic6Q47Zaj2DZOwia3AgicO7Q/132","comment_is_top":false,"comment_ctime":1618530357,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹\nç°åœ¨å…¬å¸è¿™è¾¹å¯èƒ½è®©æˆ‘è´Ÿè´£ä¸ºä¸€ä¸ªå¤§å‹ä¼ä¸šçš„ç”Ÿäº§åˆ¶é€ æ‰§è¡Œ(mes)ç³»ç»ŸåšæŠ€æœ¯æ¡†æ¶é€‰å‹å’Œè®¾è®¡ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯ä¸šåŠ¡åŠŸèƒ½æ¯”è¾ƒåºå¤§å¤æ‚ï¼Œé«˜å¹¶å‘é«˜å¯ç”¨ä¸ç”¨è€ƒè™‘ã€‚æƒ³æ¥æƒ³å»ï¼Œå¦‚æœå°±æ˜¯ç®€å•åšä¸ªå‰ååˆ†ç¦»ï¼Œå†å°†åç«¯è®¾è®¡ä¸€ä¸ªä¸‰å±‚æ¶æ„ï¼Œå¥½åƒä¹Ÿä¸å¤Ÿã€‚\nä¸çŸ¥é“ä¸€èˆ¬å¤§å‹çš„ä¸šåŠ¡åŠŸèƒ½åºå¤§å¤æ‚çš„mesç³»ç»Ÿï¼Œç”¨.netéƒ½æ˜¯æ€ä¹ˆè®¾è®¡ï¼Œéƒ½ç”¨åˆ°å“ªäº›æ¡†æ¶ï¼Œä¸çŸ¥é“æ‚¨è¿™è¾¹æœ‰æ²¡æœ‰æ¡ˆä¾‹å’Œå»ºè®®å¯ä¾›å‚è€ƒï¼Œ","like_count":0},{"had_liked":false,"id":247758,"user_name":"é­æ¨æ¨","can_delete":false,"product_type":"c3","uid":1813738,"ip_address":"","ucode":"694BCECBDD2DDB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/ac/ea/beb8eb34.jpg","comment_is_top":false,"comment_ctime":1599819809,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"\n        public static IServiceCollection AddEventBus(this IServiceCollection services, IConfiguration configuration)\n        {\n            &#47;&#47;services.AddDbContext&lt;DomainContext&gt;(options =&gt; options.UseSqlServer(configuration.GetValue&lt;string&gt;(&quot;MySqlServer&quot;)));\n            services.AddTransient&lt;ISubscriberService, SubscriberService&gt;();\n            services.AddCap(options =&gt;\n            {\n                options.UseSqlServer(configuration.GetValue&lt;string&gt;(&quot;MySqlServer&quot;));\n                &#47;&#47;options.UseEntityFramework&lt;DomainContext&gt;();\n                &#47;&#47;options.UseSqlServer();\n\n                options.UseRabbitMQ(options =&gt;\n                {\n                    configuration.GetSection(&quot;RabbitMQ&quot;).Bind(options);\n                    &#47;&#47;options.Port\n                });\n                options.FailedRetryCount = 20; &#47;&#47;é‡è¯•20æ¬¡ç»“æŸ\n                options.FailedThresholdCallback = failed =&gt;\n                {\n                    var logger = failed.ServiceProvider.GetService&lt;ILogger&gt;();\n                    logger.LogInformation($@&quot;A message of type {failed.MessageType} failed after executing {options.FailedRetryCount} several times, \n                        requiring manual troubleshooting. Message name: {failed.Message.GetName()}&quot;);\n                };\n                options.UseDashboard();\n            });\n\n            return services;\n        }\n\næˆ‘ä¹Ÿæ˜¯æŠ¥é”™ ä½¿ç”¨options.UseEntityFramework&lt;DomainContext&gt;();æ³¨å†Œä¼šæŠ¥ValueFactory attempted to access the Value property of this instance.â€\n public static IServiceCollection AddSqlServerDomainContext(this IServiceCollection services, string connectionString)\n        {\n            return services.AddDomainContext(builder =&gt;\n            {\n                builder.UseSqlServer(connectionString);\n            });\n        }\næ”¹æˆäº†è¿™ä¸ª   ç°åœ¨é¡¹ç›®ä¸ä¼šæŠ¥é”™  è®¢é˜…äº‹ä»¶æ¥æ”¶ä¸äº†","like_count":0},{"had_liked":false,"id":237582,"user_name":"å¼ ä¿Šæ°","can_delete":false,"product_type":"c3","uid":1309986,"ip_address":"","ucode":"F2CBA500DC94BD","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/22/32b95be7.jpg","comment_is_top":false,"comment_ctime":1595889990,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"è€å¸ˆï¼Œåœ¨webformä¸‹æœ‰ä»€ä¹ˆç±»ä¼¼capæ¡†æ¶ ï¼Œè§‰å¾—ä¸é”™çš„æ¨èä¸‹å‘—","like_count":0},{"had_liked":false,"id":228538,"user_name":"çˆ±å­¦ä¹ çš„å¤§å”","can_delete":false,"product_type":"c3","uid":1085152,"ip_address":"","ucode":"91F9ABF1EC98D0","user_header":"https://static001.geekbang.org/account/avatar/00/10/8e/e0/847348b1.jpg","comment_is_top":false,"comment_ctime":1592729431,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"è€å¸ˆï¼Œä½ èƒ½è®²è®²rabitMQåˆ°åº•åœ¨è¿™ä¸¤ä¸ªåœ°æ–¹èµ·äº†ä¸ªä»€ä¹ˆä½œç”¨å—ï¼Ÿ\næˆ‘ä»¬çš„MediatRé¦–å…ˆæ˜¯æŠŠäº‹ä»¶æ”¾åˆ°publishè¡¨ï¼Œç„¶årabbitMQä»è¿™é‡Œè¾¹å–å‡ºæ¥ï¼Œç„¶åsubscribeç«¯ä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œå–æ•°æ®ç„¶åæ¶ˆè´¹ï¼Œå†æŠŠæ¶ˆè´¹ç»“æœå­˜åˆ°subscribeè¡¨é‡Œçš„å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":208785,"user_name":"è·¯äººä¹™","can_delete":false,"product_type":"c3","uid":1816206,"ip_address":"","ucode":"1A8AEB9FF1CDEB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/b6/8e/2b4504a9.jpg","comment_is_top":false,"comment_ctime":1587438019,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"è€å¸ˆï¼Œæˆ‘åŒä¸€ä¸ªæ–¹æ³•ä¸­ä½¿ç”¨_capPublisherå‘å¸ƒå¤šæ¬¡åŒä¸€ç±»å‹çš„æ¶ˆæ¯ï¼ˆé›†æˆäº‹ä»¶çš„å‚æ•°ä¸åŒï¼‰ã€‚å¦‚_capPublisher.PublishAsync(â€œCreateOrderâ€,order)è¿™é‡Œæ¯ä¸ªorderï¼Œçš„å‚æ•°æ˜¯ä¸åŒçš„ã€‚å¤šä¸ªæ¶ˆæ¯å‘å¸ƒååœ¨æ•°æ®åº“çš„å‘å¸ƒè¡¨ä¸­å¯ä»¥çœ‹åˆ°æˆåŠŸå‘å¸ƒäº†å¤šä¸ªæ¶ˆæ¯ï¼Œè€Œæ¶ˆè´¹è¡¨ä¹Ÿèƒ½æ¶ˆè´¹å…¨éƒ¨çš„æ¶ˆæ¯ï¼Œä½†æ¶ˆè´¹è¡¨æ‰§è¡Œçš„é›†æˆäº‹ä»¶çš„å‚æ•°å€¼éƒ½æ˜¯æœ€åå‘å¸ƒçš„å‚æ•°ã€‚ç›¸å½“äºå‘å¸ƒçš„æ¶ˆæ¯å¦‚æœæ²¡æ¥å¾—åŠæ‰§è¡Œï¼Œé‚£æœ€ç»ˆæ‰§è¡Œæ—¶ä¼šå…¨éƒ¨æ‰§è¡Œæˆæœ€åå‘å¸ƒæ¶ˆæ¯æ—¶ä¼ é€’è¿‡æ¥çš„å†…å®¹ã€‚ä¸ºäº†éªŒè¯æ˜¯ä¸æ˜¯å› ä¸ºæ¶ˆæ¯ä¸ºæ‰§è¡Œåˆå‘å¸ƒæ¶ˆæ¯å¼•èµ·çš„é—®é¢˜ï¼Œæˆ‘åœ¨å‘å¸ƒæ¯æ¡æ¶ˆæ¯åçº¿ç¨‹ç­‰å¾…ä¸€ç§’é—®é¢˜å°±è§£å†³äº†ã€‚æƒ³çŸ¥é“è¿™ç§é—®é¢˜è¦æ€ä¹ˆè§£å†³ï¼Œå¦‚æœæœ‰å¹¶å‘å‡ºç°åŒä¸€æ—¶åˆ»å‘å¸ƒäº†å¤šä¸ªåŒç±»æ¶ˆæ¯ï¼Œé‚£æ¶ˆè´¹ç«¯ä¼šä¸ä¼šå°±å‡ºé—®é¢˜äº†ã€‚","like_count":0,"discussions":[{"author":{"id":1816206,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/b6/8e/2b4504a9.jpg","nickname":"è·¯äººä¹™","note":"","ucode":"1A8AEB9FF1CDEB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244562,"discussion_content":"è€å¸ˆï¼ŒåŸå› æˆ‘æ‰¾åˆ°äº†ã€‚æ˜¯å› ä¸ºé›†æˆäº‹ä»¶ä¼ é€’çš„å¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹ï¼ŒåŒæ—¶å‘å¸ƒå¤šä¸ªé›†æˆäº‹ä»¶æ—¶è™½ç„¶æˆ‘ä¿®æ”¹äº†å¼•ç”¨å¯¹è±¡çš„å€¼ï¼Œä½†æ¶ˆè´¹æ—¶æ˜¯è¯»çš„å¯¹è±¡æœ€åçš„çŠ¶æ€ã€‚æˆ‘æœ‰ä¸€ç‚¹ä¸è§£çš„æ˜¯å¦‚æœè¯»çš„æ˜¯æœ€åçš„çŠ¶æ€ï¼Œä¸ºä»€ä¹ˆå‘å¸ƒè¡¨çš„å€¼æ˜¯ä¿å­˜çš„æ˜¯æ¯æ¬¡å¯¹è±¡çš„å€¼ï¼Œåªæœ‰æ¶ˆè´¹è¡¨ä¿å­˜çš„æ˜¯æ¶ˆè´¹æ—¶å¯¹è±¡çš„æœ€ç»ˆå€¼ã€‚é‚£æ˜¯ä¸æ˜¯ç†è§£æˆæ¶ˆè´¹çš„å¯¹è±¡å€¼å¹¶ä¸æ˜¯ä»å‘å¸ƒè¡¨ä¸­åºåˆ—åŒ–å‡ºæ¥çš„ï¼Œè€Œæ˜¯ä»å†…å­˜ä¸­è·å–çš„ï¼Œé‚£å‘å¸ƒè¡¨ä¿å­˜çš„æ•°æ®æ„ä¹‰æ˜¯å†…å­˜ä¸­è¯¥å¯¹è±¡ä¸å­˜åœ¨æ—¶æ‰ä»æ•°æ®åº“ä¸­è¯»å–ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587612714,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201215,"user_name":"ç‹äºš","can_delete":false,"product_type":"c3","uid":1810841,"ip_address":"","ucode":"765CDC2A4DF8CF","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a1/99/137f5ff7.jpg","comment_is_top":false,"comment_ctime":1585733772,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"è‚–è€å¸ˆï¼šæˆ‘åœ¨æœ¬åœ°ä½¿ç”¨sqlæ•°æ®åº“è°ƒè¯•æ—¶  å‘ç°å½“ç¨‹åºåœ¨æ¨é€é›†æˆäº‹ä»¶(ä»£ç ï¼šawait _capPublisher.PublishAsync(&quot;OrderCreated&quot;, new OrderCreatedIntegrationEvent(notification.Order.Id));)  èµ°åˆ°è¿™é‡Œæ—¶ï¼Œ é¡µé¢æç¤ºå¼‚å¸¸(å¼‚å¸¸ä¿¡æ¯ï¼šMicrosoft.Data.SqlClient.SqlException (0x80131904): â€œ`â€é™„è¿‘æœ‰è¯­æ³•é”™è¯¯ã€‚\n   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\n   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)\n   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)\n   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean&amp; dataReady.......))  è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ ","like_count":0},{"had_liked":false,"id":197119,"user_name":"è‰¾roger","can_delete":false,"product_type":"c3","uid":1359790,"ip_address":"","ucode":"9F65CE9A81D6DB","user_header":"","comment_is_top":false,"comment_ctime":1585358720,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"capå¦‚ä½•é…ç½®å¤šä¸ªexchange?æˆ‘åœ¨exchange Aè®¢é˜…event1åå¤„ç†æˆåŠŸï¼Œå†å‘å¸ƒevent2åˆ°å¦ä¸€ä¸ªexchang B.è¿™ä¸ªéœ€æ±‚å¦‚ä½•é…ç½®å®ç°ï¼Ÿ","like_count":0},{"had_liked":false,"id":183748,"user_name":"é™ˆæ­£æ–‡","can_delete":false,"product_type":"c3","uid":1107451,"ip_address":"","ucode":"D1DF7997BA4105","user_header":"https://static001.geekbang.org/account/avatar/00/10/e5/fb/5b186d20.jpg","comment_is_top":false,"comment_ctime":1583126166,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"æˆ‘æŠŠmysqlæ¢æˆsqlserverï¼Œåœ¨å¯åŠ¨é¡¹ç›®æ—¶æ€»æ˜¯æŠ¥é”™","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214271,"discussion_content":"çœ‹æºç ï¼Œæissue","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585156529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182995,"user_name":"é¡¾ä½ å¿ƒå®‰","can_delete":false,"product_type":"c3","uid":1813098,"ip_address":"","ucode":"D0080EBA52CFBB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/aa/6a/fade4619.jpg","comment_is_top":false,"comment_ctime":1582903414,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"å¬æ‡‚äº†  å¯ä»¥","like_count":0}]}