{"id":309098,"title":"17 | SingleFlight å’Œ CyclicBarrierï¼šè¯·æ±‚åˆå¹¶å’Œå¾ªç¯æ …æ è¯¥æ€ä¹ˆç”¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘æ¥ç»™ä½ ä»‹ç»ä¸¤ä¸ªéå¸¸é‡è¦çš„æ‰©å±•å¹¶å‘åŸè¯­ï¼šSingleFlightå’ŒCyclicBarrierã€‚SingleFlightçš„ä½œç”¨æ˜¯å°†å¹¶å‘è¯·æ±‚åˆå¹¶æˆä¸€ä¸ªè¯·æ±‚ï¼Œä»¥å‡å°‘å¯¹ä¸‹å±‚æœåŠ¡çš„å‹åŠ›ï¼›è€ŒCyclicBarrieræ˜¯ä¸€ä¸ªå¯é‡ç”¨çš„æ …æ å¹¶å‘åŸè¯­ï¼Œç”¨æ¥æ§åˆ¶ä¸€ç»„è¯·æ±‚åŒæ—¶æ‰§è¡Œçš„æ•°æ®ç»“æ„ã€‚</p><p>å…¶å®ï¼Œå®ƒä»¬ä¸¤ä¸ªå¹¶æ²¡æœ‰ç›´æ¥çš„å…³ç³»ï¼Œåªæ˜¯å†…å®¹ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—ç”¨æœ€çŸ­çš„æ—¶é—´å¸¦ä½ æŒæ¡å®ƒä»¬ã€‚ä¸€èŠ‚è¯¾å°±èƒ½æŒæ¡ä¸¤ä¸ªâ€œæ­¦å™¨â€ï¼Œæ˜¯ä¸æ˜¯å¾ˆé«˜æ•ˆï¼Ÿ</p><h1>è¯·æ±‚åˆå¹¶SingleFlight</h1><p>SingleFlightæ˜¯Goå¼€å‘ç»„æä¾›çš„ä¸€ä¸ªæ‰©å±•å¹¶å‘åŸè¯­ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼Œåœ¨å¤„ç†å¤šä¸ªgoroutineåŒæ—¶è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œåªè®©ä¸€ä¸ªgoroutineå»è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œç­‰åˆ°è¿™ä¸ªgoroutineè¿”å›ç»“æœçš„æ—¶å€™ï¼Œå†æŠŠç»“æœè¿”å›ç»™è¿™å‡ ä¸ªåŒæ—¶è°ƒç”¨çš„goroutineï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¹¶å‘è°ƒç”¨çš„æ•°é‡ã€‚</p><p>è¿™é‡Œæˆ‘æƒ³å…ˆå›ç­”ä¸€ä¸ªé—®é¢˜ï¼šæ ‡å‡†åº“ä¸­çš„sync.Onceä¹Ÿå¯ä»¥ä¿è¯å¹¶å‘çš„goroutineåªä¼šæ‰§è¡Œä¸€æ¬¡å‡½æ•°fï¼Œé‚£ä¹ˆï¼ŒSingleFlightå’Œsync.Onceæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œsync.Onceä¸æ˜¯åªåœ¨å¹¶å‘çš„æ—¶å€™ä¿è¯åªæœ‰ä¸€ä¸ªgoroutineæ‰§è¡Œå‡½æ•°fï¼Œè€Œæ˜¯ä¼šä¿è¯æ°¸è¿œåªæ‰§è¡Œä¸€æ¬¡ï¼Œè€ŒSingleFlightæ˜¯æ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨å¤šä¸ªè¯·æ±‚åŒæ—¶è°ƒç”¨çš„æ—¶å€™åªæœ‰ä¸€ä¸ªæ‰§è¡Œã€‚å®ƒä»¬ä¸¤ä¸ªé¢å¯¹çš„åœºæ™¯æ˜¯ä¸åŒçš„ï¼Œ<strong>sync.Onceä¸»è¦æ˜¯ç”¨åœ¨å•æ¬¡åˆå§‹åŒ–åœºæ™¯ä¸­ï¼Œè€ŒSingleFlightä¸»è¦ç”¨åœ¨åˆå¹¶å¹¶å‘è¯·æ±‚çš„åœºæ™¯ä¸­</strong>ï¼Œå°¤å…¶æ˜¯ç¼“å­˜åœºæ™¯ã€‚</p><!-- [[[read_end]]] --><p>å¦‚æœä½ å­¦ä¼šäº†SingleFlightï¼Œåœ¨é¢å¯¹ç§’æ€ç­‰å¤§å¹¶å‘è¯·æ±‚çš„åœºæ™¯ï¼Œè€Œä¸”è¿™äº›è¯·æ±‚éƒ½æ˜¯è¯»è¯·æ±‚æ—¶ï¼Œä½ å°±å¯ä»¥æŠŠè¿™äº›è¯·æ±‚åˆå¹¶ä¸ºä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ ·ï¼Œä½ å°±å¯ä»¥å°†åç«¯æœåŠ¡çš„å‹åŠ›ä»né™åˆ°1ã€‚å°¤å…¶æ˜¯åœ¨é¢å¯¹åç«¯æ˜¯æ•°æ®åº“è¿™æ ·çš„æœåŠ¡çš„æ—¶å€™ï¼Œé‡‡ç”¨ SingleFlightå¯ä»¥æå¤§åœ°æé«˜æ€§èƒ½ã€‚é‚£ä¹ˆï¼Œè¯ä¸å¤šè¯´ï¼Œå°±è®©æˆ‘ä»¬å¼€å§‹å­¦ä¹ SingleFlightå§ã€‚</p><h2>å®ç°åŸç†</h2><p>SingleFlightä½¿ç”¨äº’æ–¥é”Mutexå’ŒMapæ¥å®ç°ã€‚Mutexæä¾›å¹¶å‘æ—¶çš„è¯»å†™ä¿æŠ¤ï¼ŒMapç”¨æ¥ä¿å­˜åŒä¸€ä¸ªkeyçš„æ­£åœ¨å¤„ç†ï¼ˆin flightï¼‰çš„è¯·æ±‚ã€‚</p><p>SingleFlightçš„æ•°æ®ç»“æ„æ˜¯Groupï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2a/da/2a260ccce4e06ea1be2cf3f7abbe84da.png?wh=1000*123\" alt=\"\"></p><ul>\n<li>Doï¼šè¿™ä¸ªæ–¹æ³•æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›å‡½æ•°æ‰§è¡Œçš„ç»“æœã€‚ä½ éœ€è¦æä¾›ä¸€ä¸ªkeyï¼Œå¯¹äºåŒä¸€ä¸ªkeyï¼Œåœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªåœ¨æ‰§è¡Œï¼ŒåŒä¸€ä¸ªkeyå¹¶å‘çš„è¯·æ±‚ä¼šç­‰å¾…ã€‚ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„è¯·æ±‚è¿”å›çš„ç»“æœï¼Œå°±æ˜¯å®ƒçš„è¿”å›ç»“æœã€‚å‡½æ•°fnæ˜¯ä¸€ä¸ªæ— å‚çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªç»“æœæˆ–è€…errorï¼Œè€ŒDoæ–¹æ³•ä¼šè¿”å›å‡½æ•°æ‰§è¡Œçš„ç»“æœæˆ–è€…æ˜¯errorï¼Œsharedä¼šæŒ‡ç¤ºvæ˜¯å¦è¿”å›ç»™å¤šä¸ªè¯·æ±‚ã€‚</li>\n<li>DoChanï¼šç±»ä¼¼Doæ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯è¿”å›ä¸€ä¸ªchanï¼Œç­‰fnå‡½æ•°æ‰§è¡Œå®Œï¼Œäº§ç”Ÿäº†ç»“æœä»¥åï¼Œå°±èƒ½ä»è¿™ä¸ªchanä¸­æ¥æ”¶è¿™ä¸ªç»“æœã€‚</li>\n<li>Forgetï¼šå‘Šè¯‰Groupå¿˜è®°è¿™ä¸ªkeyã€‚è¿™æ ·ä¸€æ¥ï¼Œä¹‹åè¿™ä¸ªkeyè¯·æ±‚ä¼šæ‰§è¡Œfï¼Œè€Œä¸æ˜¯ç­‰å¾…å‰ä¸€ä¸ªæœªå®Œæˆçš„fnå‡½æ•°çš„ç»“æœã€‚</li>\n</ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹å…·ä½“çš„å®ç°æ–¹æ³•ã€‚</p><p>é¦–å…ˆï¼ŒSingleFlightå®šä¹‰ä¸€ä¸ªè¾…åŠ©å¯¹è±¡callï¼Œè¿™ä¸ªcallå°±ä»£è¡¨æ­£åœ¨æ‰§è¡Œfnå‡½æ•°çš„è¯·æ±‚æˆ–è€…æ˜¯å·²ç»æ‰§è¡Œå®Œçš„è¯·æ±‚ã€‚Groupä»£è¡¨SingleFlightã€‚</p><pre><code>  // ä»£è¡¨ä¸€ä¸ªæ­£åœ¨å¤„ç†çš„è¯·æ±‚ï¼Œæˆ–è€…å·²ç»å¤„ç†å®Œçš„è¯·æ±‚\n  type call struct {\n\t\twg sync.WaitGroup\n\t\n\n\t\t// è¿™ä¸ªå­—æ®µä»£è¡¨å¤„ç†å®Œçš„å€¼ï¼Œåœ¨waitgroupå®Œæˆä¹‹å‰åªä¼šå†™ä¸€æ¬¡\n        // waitgroupå®Œæˆä¹‹åå°±è¯»å–è¿™ä¸ªå€¼\n\t\tval interface{}\n\t\terr error\n\t\n        // æŒ‡ç¤ºå½“callåœ¨å¤„ç†æ—¶æ˜¯å¦è¦å¿˜æ‰è¿™ä¸ªkey\n\t\tforgotten bool\n\t\tdups  int\n\t\tchans []chan&lt;- Result\n\t}\n\t\n    // groupä»£è¡¨ä¸€ä¸ªsingleflightå¯¹è±¡\n\ttype Group struct {\n\t\tmu sync.Mutex       // protects m\n\t\tm  map[string]*call // lazily initialized\n\t}\n</code></pre><p>æˆ‘ä»¬åªéœ€è¦æŸ¥çœ‹ä¸€ä¸ªDoæ–¹æ³•ï¼ŒDoChançš„å¤„ç†æ–¹æ³•æ˜¯ç±»ä¼¼çš„ã€‚</p><pre><code>  func (g *Group) Do(key string, fn func() (interface{}, error)) (v interface{}, err error, shared bool) {\n\t\tg.mu.Lock()\n\t\tif g.m == nil {\n\t\t\tg.m = make(map[string]*call)\n\t\t}\n\t\tif c, ok := g.m[key]; ok {//å¦‚æœå·²ç»å­˜åœ¨ç›¸åŒçš„key\n\t\t\tc.dups++\n\t\t\tg.mu.Unlock()\n\t\t\tc.wg.Wait() //ç­‰å¾…è¿™ä¸ªkeyçš„ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆ\n\t\t\treturn c.val, c.err, true //ä½¿ç”¨ç¬¬ä¸€ä¸ªkeyçš„è¯·æ±‚ç»“æœ\n\t\t}\n\t\tc := new(call) // ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªcall\n\t\tc.wg.Add(1)\n\t\tg.m[key] = c //åŠ å…¥åˆ°key mapä¸­\n\t\tg.mu.Unlock()\n\t\n\n\t\tg.doCall(c, key, fn) // è°ƒç”¨æ–¹æ³•\n\t\treturn c.val, c.err, c.dups &gt; 0\n\t}\n</code></pre><p>doCallæ–¹æ³•ä¼šå®é™…è°ƒç”¨å‡½æ•°fnï¼š</p><pre><code>  func (g *Group) doCall(c *call, key string, fn func() (interface{}, error)) {\n\t\tc.val, c.err = fn()\n\t\tc.wg.Done()\n\t\n\n\t\tg.mu.Lock()\n\t\tif !c.forgotten { // å·²è°ƒç”¨å®Œï¼Œåˆ é™¤è¿™ä¸ªkey\n\t\t\tdelete(g.m, key)\n\t\t}\n\t\tfor _, ch := range c.chans {\n\t\t\tch &lt;- Result{c.val, c.err, c.dups &gt; 0}\n\t\t}\n\t\tg.mu.Unlock()\n\t}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä½ è¦æ³¨æ„ä¸‹ç¬¬7è¡Œã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œforgotten==falseï¼Œæ‰€ä»¥ç¬¬8è¡Œé»˜è®¤ä¼šè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆåï¼Œåç»­çš„åŒä¸€ä¸ªkeyçš„è¯·æ±‚åˆé‡æ–°å¼€å§‹æ–°ä¸€æ¬¡çš„fnå‡½æ•°çš„è°ƒç”¨ã€‚</p><p>Goæ ‡å‡†åº“çš„ä»£ç ä¸­å°±æœ‰ä¸€ä¸ªSingleFlightçš„<a href=\"https://github.com/golang/go/blob/50bd1c4d4eb4fac8ddeb5f063c099daccfb71b26/src/internal/singleflight/singleflight.go\">å®ç°</a>ï¼Œè€Œæ‰©å±•åº“ä¸­çš„SingleFlightå°±æ˜¯åœ¨æ ‡å‡†åº“çš„ä»£ç åŸºç¡€ä¸Šæ”¹çš„ï¼Œé€»è¾‘å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œæˆ‘å°±ä¸å¤šè¯´äº†ã€‚</p><h2>åº”ç”¨åœºæ™¯</h2><p>äº†è§£äº†SingleFlightçš„å®ç°åŸç†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒéƒ½åº”ç”¨äºä»€ä¹ˆåœºæ™¯ä¸­ã€‚</p><p>Goä»£ç åº“ä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°äº†SingleFlightã€‚</p><p>ç¬¬ä¸€ä¸ªæ˜¯åœ¨<a href=\"https://github.com/golang/go/blob/b1b67841d1e229b483b0c9dd50ddcd1795b0f90f/src/net/lookup.go\">net/lookup.go</a>ä¸­ï¼Œå¦‚æœåŒæ—¶æœ‰æŸ¥è¯¢åŒä¸€ä¸ªhostçš„è¯·æ±‚ï¼ŒlookupGroupä¼šæŠŠè¿™äº›è¯·æ±‚mergeåˆ°ä¸€èµ·ï¼Œåªéœ€è¦ä¸€ä¸ªè¯·æ±‚å°±å¯ä»¥äº†ï¼š</p><pre><code>// lookupGroup merges LookupIPAddr calls together for lookups for the same\n// host. The lookupGroup key is the LookupIPAddr.host argument.\n// The return values are ([]IPAddr, error).\nlookupGroup singleflight.Group\n</code></pre><p>ç¬¬äºŒä¸ªæ˜¯Goåœ¨æŸ¥è¯¢ä»“åº“ç‰ˆæœ¬ä¿¡æ¯æ—¶ï¼Œå°†å¹¶å‘çš„è¯·æ±‚åˆå¹¶æˆ1ä¸ªè¯·æ±‚ï¼š</p><pre><code>func metaImportsForPrefix(importPrefix string, mod ModuleMode, security web.SecurityMode) (*urlpkg.URL, []metaImport, error) {\n        // ä½¿ç”¨ç¼“å­˜ä¿å­˜è¯·æ±‚ç»“æœ\n\t\tsetCache := func(res fetchResult) (fetchResult, error) {\n\t\t\tfetchCacheMu.Lock()\n\t\t\tdefer fetchCacheMu.Unlock()\n\t\t\tfetchCache[importPrefix] = res\n\t\t\treturn res, nil\n\t\t\n        // ä½¿ç”¨ SingleFlightè¯·æ±‚\n\t\tresi, _, _ := fetchGroup.Do(importPrefix, func() (resi interface{}, err error) {\n\t\t\tfetchCacheMu.Lock()\n            // å¦‚æœç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥ä»ç¼“å­˜ä¸­å–\n\t\t\tif res, ok := fetchCache[importPrefix]; ok {\n\t\t\t\tfetchCacheMu.Unlock()\n\t\t\t\treturn res, nil\n\t\t\t}\n\t\t\tfetchCacheMu.Unlock()\n            ......\n</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ¶‰åŠåˆ°äº†ç¼“å­˜çš„é—®é¢˜ã€‚ä¸Šé¢çš„ä»£ç ä¼šæŠŠç»“æœæ”¾åœ¨ç¼“å­˜ä¸­ï¼Œè¿™ä¹Ÿæ˜¯å¸¸ç”¨çš„ä¸€ç§è§£å†³ç¼“å­˜å‡»ç©¿çš„ä¾‹å­ã€‚</p><p>è®¾è®¡ç¼“å­˜é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦è§£å†³ç¼“å­˜ç©¿é€ã€ç¼“å­˜é›ªå´©å’Œç¼“å­˜å‡»ç©¿é—®é¢˜ã€‚ç¼“å­˜å‡»ç©¿é—®é¢˜æ˜¯æŒ‡ï¼Œåœ¨å¹³å¸¸é«˜å¹¶å‘çš„ç³»ç»Ÿä¸­ï¼Œå¤§é‡çš„è¯·æ±‚åŒæ—¶æŸ¥è¯¢ä¸€ä¸ª key æ—¶ï¼Œå¦‚æœè¿™ä¸ªkeyæ­£å¥½è¿‡æœŸå¤±æ•ˆäº†ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“ä¸Šã€‚è¿™å°±æ˜¯ç¼“å­˜å‡»ç©¿ã€‚</p><p>ç”¨SingleFlightæ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜å†åˆé€‚ä¸è¿‡äº†ã€‚å› ä¸ºï¼Œè¿™ä¸ªæ—¶å€™ï¼Œåªè¦è¿™äº›å¯¹åŒä¸€ä¸ªkeyçš„å¹¶å‘è¯·æ±‚çš„å…¶ä¸­ä¸€ä¸ªåˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œå°±å¯ä»¥äº†ï¼Œè¿™äº›å¹¶å‘çš„è¯·æ±‚å¯ä»¥å…±äº«åŒä¸€ä¸ªç»“æœã€‚å› ä¸ºæ˜¯ç¼“å­˜æŸ¥è¯¢ï¼Œä¸ç”¨è€ƒè™‘å¹‚ç­‰æ€§é—®é¢˜ã€‚</p><p>äº‹å®ä¸Šï¼Œåœ¨Goç”Ÿæ€åœˆçŸ¥åçš„ç¼“å­˜æ¡†æ¶groupcacheä¸­ï¼Œå°±ä½¿ç”¨äº†è¾ƒæ—©çš„Goæ ‡å‡†åº“çš„SingleFlightå®ç°ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥ç»™ä½ ä»‹ç»ä¸€ä¸‹groupcacheæ˜¯å¦‚ä½•ä½¿ç”¨SingleFlightè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜çš„ã€‚</p><p>groupcacheä¸­çš„SingleFlightåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p><pre><code>func (g *Group) Do(key string, fn func() (interface{}, error)) (interface{}, error)\n</code></pre><p>SingleFlightçš„ä½œç”¨æ˜¯ï¼Œåœ¨åŠ è½½ä¸€ä¸ªç¼“å­˜é¡¹çš„æ—¶å€™ï¼Œåˆå¹¶å¯¹åŒä¸€ä¸ªkeyçš„loadçš„å¹¶å‘è¯·æ±‚ï¼š</p><pre><code>\ttype Group struct {\n\t\tã€‚ã€‚ã€‚ã€‚ã€‚ã€‚\n\t\t// loadGroup ensures that each key is only fetched once\n\t\t// (either locally or remotely), regardless of the number of\n\t\t// concurrent callers.\n\t\tloadGroup flightGroup\n        ......\n\t}\n\n    func (g *Group) load(ctx context.Context, key string, dest Sink) (value ByteView, destPopulated bool, err error) {\n\t\tviewi, err := g.loadGroup.Do(key, func() (interface{}, error)  {\n\t\t\t// ä»cache, peer, localå°è¯•æŸ¥è¯¢cache\n\t\t\treturn value, nil\n\t\t})\n\t\tif err == nil {\n\t\t\tvalue = viewi.(ByteView)\n\t\t}\n\t\treturn\n\t}\n</code></pre><p>å…¶å®ƒçš„çŸ¥åé¡¹ç›®å¦‚Cockroachdbï¼ˆå°å¼ºæ•°æ®åº“ï¼‰ã€CoreDNSï¼ˆDNSæœåŠ¡å™¨ï¼‰ç­‰éƒ½æœ‰SingleFlightåº”ç”¨ï¼Œä½ å¯ä»¥æŸ¥çœ‹è¿™äº›é¡¹ç›®çš„ä»£ç ï¼ŒåŠ æ·±å¯¹SingleFlightçš„ç†è§£ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œä½¿ç”¨SingleFlightæ—¶ï¼Œå¯ä»¥é€šè¿‡åˆå¹¶è¯·æ±‚çš„æ–¹å¼é™ä½å¯¹ä¸‹æ¸¸æœåŠ¡çš„å¹¶å‘å‹åŠ›ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½ï¼Œå¸¸å¸¸ç”¨äºç¼“å­˜ç³»ç»Ÿä¸­ã€‚æœ€åï¼Œæˆ‘æƒ³ç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼Œä½ è§‰å¾—ï¼ŒSingleFlightèƒ½ä¸èƒ½åˆå¹¶å¹¶å‘çš„å†™æ“ä½œå‘¢ï¼Ÿ</p><h1>å¾ªç¯æ …æ CyclicBarrier</h1><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å†ç»™ä½ ä»‹ç»å¦å¤–ä¸€ä¸ªå¹¶å‘åŸè¯­ï¼šå¾ªç¯æ …æ ï¼ˆCyclicBarrierï¼‰ï¼Œå®ƒå¸¸å¸¸åº”ç”¨äºé‡å¤è¿›è¡Œä¸€ç»„goroutineåŒæ—¶æ‰§è¡Œçš„åœºæ™¯ä¸­ã€‚</p><p><a href=\"https://github.com/marusama/cyclicbarrier\">CyclicBarrier</a>å…è®¸ä¸€ç»„goroutineå½¼æ­¤ç­‰å¾…ï¼Œåˆ°è¾¾ä¸€ä¸ªå…±åŒçš„æ‰§è¡Œç‚¹ã€‚åŒæ—¶ï¼Œå› ä¸ºå®ƒå¯ä»¥è¢«é‡å¤ä½¿ç”¨ï¼Œæ‰€ä»¥å«å¾ªç¯æ …æ ã€‚å…·ä½“çš„æœºåˆ¶æ˜¯ï¼Œå¤§å®¶éƒ½åœ¨æ …æ å‰ç­‰å¾…ï¼Œç­‰å…¨éƒ¨éƒ½åˆ°é½äº†ï¼Œå°±æŠ¬èµ·æ …æ æ”¾è¡Œã€‚</p><p>äº‹å®ä¸Šï¼Œè¿™ä¸ªCyclicBarrieræ˜¯å‚è€ƒ<a href=\"https://docs.oracle.com/en/java/javase/15/docs/api/java.base/java/util/concurrent/CyclicBarrier.html\">Java CyclicBarrier</a>å’Œ<a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.threading.barrier?redirectedfrom=MSDN&amp;view=netcore-3.1\">C# Barrier</a>çš„åŠŸèƒ½å®ç°çš„ã€‚Javaæä¾›äº†CountDownLatchï¼ˆå€’è®¡æ—¶å™¨ï¼‰å’ŒCyclicBarrierï¼ˆå¾ªç¯æ …æ ï¼‰ä¸¤ä¸ªç±»ä¼¼çš„ç”¨äºä¿è¯å¤šçº¿ç¨‹åˆ°è¾¾åŒä¸€ä¸ªæ‰§è¡Œç‚¹çš„ç±»ï¼Œåªä¸è¿‡å‰è€…æ˜¯åˆ°è¾¾0çš„æ—¶å€™æ”¾è¡Œï¼Œåè€…æ˜¯åˆ°è¾¾æŸä¸ªæŒ‡å®šçš„æ•°çš„æ—¶å€™æ”¾è¡Œã€‚C# BarrieråŠŸèƒ½ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä½ å¯ä»¥æŸ¥çœ‹é“¾æ¥ï¼Œäº†è§£å®ƒçš„å…·ä½“ç”¨æ³•ã€‚</p><p>ä½ å¯èƒ½ä¼šè§‰å¾—ï¼ŒCyclicBarrierå’ŒWaitGroupçš„åŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼ï¼Œç¡®å®æ˜¯è¿™æ ·ã€‚ä¸è¿‡ï¼ŒCyclicBarrieræ›´é€‚åˆç”¨åœ¨â€œå›ºå®šæ•°é‡çš„goroutineç­‰å¾…åŒä¸€ä¸ªæ‰§è¡Œç‚¹â€çš„åœºæ™¯ä¸­ï¼Œè€Œä¸”åœ¨æ”¾è¡Œgoroutineä¹‹åï¼ŒCyclicBarrierå¯ä»¥é‡å¤åˆ©ç”¨ï¼Œä¸åƒWaitGroupé‡ç”¨çš„æ—¶å€™ï¼Œå¿…é¡»å°å¿ƒç¿¼ç¿¼é¿å…panicã€‚</p><p>å¤„ç†å¯é‡ç”¨çš„å¤šgoroutineç­‰å¾…åŒä¸€ä¸ªæ‰§è¡Œç‚¹çš„åœºæ™¯çš„æ—¶å€™ï¼ŒCyclicBarrierå’ŒWaitGroupæ–¹æ³•è°ƒç”¨çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/c2/79/c2123588d4aa9f7dedec7fc35435c679.jpg?wh=2486*1633\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä½¿ç”¨WaitGroupå®ç°çš„è¯ï¼Œè°ƒç”¨æ¯”è¾ƒå¤æ‚ï¼Œä¸åƒCyclicBarrieré‚£ä¹ˆæ¸…çˆ½ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå¦‚æœæƒ³é‡ç”¨WaitGroupï¼Œä½ è¿˜è¦ä¿è¯ï¼Œå°†WaitGroupçš„è®¡æ•°å€¼é‡ç½®åˆ°nçš„æ—¶å€™ä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚</p><p>WaitGroupæ›´é€‚åˆç”¨åœ¨â€œä¸€ä¸ªgoroutineç­‰å¾…ä¸€ç»„goroutineåˆ°è¾¾åŒä¸€ä¸ªæ‰§è¡Œç‚¹â€çš„åœºæ™¯ä¸­ï¼Œæˆ–è€…æ˜¯ä¸éœ€è¦é‡ç”¨çš„åœºæ™¯ä¸­ã€‚</p><p>å¥½äº†ï¼Œäº†è§£äº†CyclicBarrierçš„åº”ç”¨åœºæ™¯å’ŒåŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹å®ƒçš„å…·ä½“å®ç°ã€‚</p><h2>å®ç°åŸç†</h2><p>CyclicBarrieræœ‰ä¸¤ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼š</p><ol>\n<li>ç¬¬ä¸€ä¸ªæ˜¯Newæ–¹æ³•ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œæ¥æŒ‡å®šå¾ªç¯æ …æ å‚ä¸è€…çš„æ•°é‡ï¼›</li>\n<li>ç¬¬äºŒä¸ªæ–¹æ³•æ˜¯NewWithActionï¼Œå®ƒé¢å¤–æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥åœ¨æ¯ä¸€æ¬¡åˆ°è¾¾æ‰§è¡Œç‚¹çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ã€‚å…·ä½“çš„æ—¶é—´ç‚¹æ˜¯åœ¨æœ€åä¸€ä¸ªå‚ä¸è€…åˆ°è¾¾ä¹‹åï¼Œä½†æ˜¯å…¶å®ƒçš„å‚ä¸è€…è¿˜æœªè¢«æ”¾è¡Œä¹‹å‰ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒï¼Œåšæ”¾è¡Œä¹‹å‰çš„ä¸€äº›å…±äº«çŠ¶æ€çš„æ›´æ–°ç­‰æ“ä½œã€‚</li>\n</ol><p>è¿™ä¸¤ä¸ªæ–¹æ³•çš„ç­¾åå¦‚ä¸‹ï¼š</p><pre><code>func New(parties int) CyclicBarrier\nfunc NewWithAction(parties int, barrierAction func() error) CyclicBarrier\n</code></pre><p>CyclicBarrieræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code>type CyclicBarrier interface {\n    // ç­‰å¾…æ‰€æœ‰çš„å‚ä¸è€…åˆ°è¾¾ï¼Œå¦‚æœè¢«ctx.Done()ä¸­æ–­ï¼Œä¼šè¿”å›ErrBrokenBarrier\n    Await(ctx context.Context) error\n\n    // é‡ç½®å¾ªç¯æ …æ åˆ°åˆå§‹åŒ–çŠ¶æ€ã€‚å¦‚æœå½“å‰æœ‰ç­‰å¾…è€…ï¼Œé‚£ä¹ˆå®ƒä»¬ä¼šè¿”å›ErrBrokenBarrier\n    Reset()\n\n    // è¿”å›å½“å‰ç­‰å¾…è€…çš„æ•°é‡\n    GetNumberWaiting() int\n\n    // å‚ä¸è€…çš„æ•°é‡\n    GetParties() int\n\n    // å¾ªç¯æ …æ æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€\n    IsBroken() bool\n}\n</code></pre><p>å¾ªç¯æ …æ çš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ã€‚å¾ªç¯æ …æ çš„å‚ä¸è€…åªéœ€è°ƒç”¨Awaitç­‰å¾…ï¼Œç­‰æ‰€æœ‰çš„å‚ä¸è€…éƒ½åˆ°è¾¾åï¼Œå†æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚å½“æ‰§è¡Œä¸‹ä¸€æ­¥çš„æ—¶å€™ï¼Œå¾ªç¯æ …æ çš„çŠ¶æ€åˆæ¢å¤åˆ°åˆå§‹çš„çŠ¶æ€äº†ï¼Œå¯ä»¥è¿æ¥ä¸‹ä¸€è½®åŒæ ·å¤šçš„å‚ä¸è€…ã€‚</p><p>æœ‰ä¸€é“éå¸¸ç»å…¸çš„å¹¶å‘ç¼–ç¨‹çš„é¢˜ç›®ï¼Œéå¸¸é€‚åˆä½¿ç”¨å¾ªç¯æ …æ ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚</p><h2>å¹¶å‘è¶£é¢˜ï¼šä¸€æ°§åŒ–äºŒæ°¢åˆ¶é€ å·¥å‚</h2><p>é¢˜ç›®æ˜¯è¿™æ ·çš„ï¼š</p><blockquote>\n<p>æœ‰ä¸€ä¸ªåå«å¤§è‡ªç„¶çš„æ¬è¿å·¥çš„å·¥å‚ï¼Œç”Ÿäº§ä¸€ç§å«åšä¸€æ°§åŒ–äºŒæ°¢çš„ç¥ç§˜æ¶²ä½“ã€‚è¿™ç§æ¶²ä½“çš„åˆ†å­æ˜¯ç”±ä¸€ä¸ªæ°§åŸå­å’Œä¸¤ä¸ªæ°¢åŸå­ç»„æˆçš„ï¼Œä¹Ÿå°±æ˜¯æ°´ã€‚</p>\n</blockquote><blockquote>\n<p>è¿™ä¸ªå·¥å‚æœ‰å¤šæ¡ç”Ÿäº§çº¿ï¼Œæ¯æ¡ç”Ÿäº§çº¿è´Ÿè´£ç”Ÿäº§æ°§åŸå­æˆ–è€…æ˜¯æ°¢åŸå­ï¼Œæ¯æ¡ç”Ÿäº§çº¿ç”±ä¸€ä¸ªgoroutineè´Ÿè´£ã€‚</p>\n</blockquote><blockquote>\n<p>è¿™äº›ç”Ÿäº§çº¿ä¼šé€šè¿‡ä¸€ä¸ªæ …æ ï¼Œåªæœ‰ä¸€ä¸ªæ°§åŸå­ç”Ÿäº§çº¿å’Œä¸¤ä¸ªæ°¢åŸå­ç”Ÿäº§çº¿éƒ½å‡†å¤‡å¥½ï¼Œæ‰èƒ½ç”Ÿæˆå‡ºä¸€ä¸ªæ°´åˆ†å­ï¼Œå¦åˆ™æ‰€æœ‰çš„ç”Ÿäº§çº¿éƒ½ä¼šå¤„äºç­‰å¾…çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ°´åˆ†å­å¿…é¡»ç”±ä¸‰ä¸ªä¸åŒçš„ç”Ÿäº§çº¿æä¾›åŸå­ï¼Œè€Œä¸”æ°´åˆ†å­æ˜¯ä¸€ä¸ªä¸€ä¸ªæŒ‰ç…§é¡ºåºäº§ç”Ÿçš„ï¼Œæ¯ç”Ÿäº§ä¸€ä¸ªæ°´åˆ†å­ï¼Œå°±ä¼šæ‰“å°å‡ºHHOã€HOHã€OHHä¸‰ç§å½¢å¼çš„å…¶ä¸­ä¸€ç§ã€‚HHHã€OOHã€OHOã€HOOã€OOOéƒ½æ˜¯ä¸å…è®¸çš„ã€‚</p>\n</blockquote><blockquote>\n<p>ç”Ÿäº§çº¿ä¸­æ°¢åŸå­çš„ç”Ÿäº§çº¿ä¸º2Næ¡ï¼Œæ°§åŸå­çš„ç”Ÿäº§çº¿ä¸ºNæ¡ã€‚</p>\n</blockquote><p>ä½ å¯ä»¥å…ˆæƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ€ä¹ˆæ¥å®ç°å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªH2Oè¾…åŠ©æ•°æ®ç±»å‹ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªä¿¡å·é‡çš„å­—æ®µå’Œä¸€ä¸ªå¾ªç¯æ …æ ã€‚</p><ol>\n<li>semaHä¿¡å·é‡ï¼šæ§åˆ¶æ°¢åŸå­ã€‚ä¸€ä¸ªæ°´åˆ†å­éœ€è¦ä¸¤ä¸ªæ°¢åŸå­ï¼Œæ‰€ä»¥ï¼Œæ°¢åŸå­çš„ç©ºæ§½æ•°èµ„æºæ•°è®¾ç½®ä¸º2ã€‚</li>\n<li>semaOä¿¡å·é‡ï¼šæ§åˆ¶æ°§åŸå­ã€‚ä¸€ä¸ªæ°´åˆ†å­éœ€è¦ä¸€ä¸ªæ°§åŸå­ï¼Œæ‰€ä»¥èµ„æºæ•°çš„ç©ºæ§½æ•°è®¾ç½®ä¸º1ã€‚</li>\n<li>å¾ªç¯æ …æ ï¼šç­‰å¾…ä¸¤ä¸ªæ°¢åŸå­å’Œä¸€ä¸ªæ°§åŸå­å¡«è¡¥ç©ºæ§½ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚</li>\n</ol><p>æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“çš„ä»£ç ï¼š</p><pre><code>package water\nimport (\n\t&quot;context&quot;\n\t&quot;github.com/marusama/cyclicbarrier&quot;\n\t&quot;golang.org/x/sync/semaphore&quot;\n)\n// å®šä¹‰æ°´åˆ†å­åˆæˆçš„è¾…åŠ©æ•°æ®ç»“æ„\ntype H2O struct {\n\tsemaH *semaphore.Weighted // æ°¢åŸå­çš„ä¿¡å·é‡\n\tsemaO *semaphore.Weighted // æ°§åŸå­çš„ä¿¡å·é‡\n\tb     cyclicbarrier.CyclicBarrier // å¾ªç¯æ …æ ï¼Œç”¨æ¥æ§åˆ¶åˆæˆ\n}\nfunc New() *H2O {\n\treturn &amp;H2O{\n\t\tsemaH: semaphore.NewWeighted(2), //æ°¢åŸå­éœ€è¦ä¸¤ä¸ª\n\t\tsemaO: semaphore.NewWeighted(1), // æ°§åŸå­éœ€è¦ä¸€ä¸ª\n\t\tb:     cyclicbarrier.New(3),  // éœ€è¦ä¸‰ä¸ªåŸå­æ‰èƒ½åˆæˆ\n\t}\n}\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹å„æ¡æµæ°´çº¿çš„å¤„ç†æƒ…å†µã€‚</p><p>æµæ°´çº¿åˆ†ä¸ºæ°¢åŸå­å¤„ç†æµæ°´çº¿å’Œæ°§åŸå­å¤„ç†æµæ°´çº¿ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ°¢åŸå­çš„æµæ°´çº¿ï¼šå¦‚æœæœ‰å¯ç”¨çš„ç©ºæ§½ï¼Œæ°¢åŸå­çš„æµæ°´çº¿çš„å¤„ç†æ–¹æ³•æ˜¯hydrogenï¼Œhydrogenæ–¹æ³•å°±ä¼šå ç”¨ä¸€ä¸ªç©ºæ§½ï¼ˆh2o.semaH.Acquireï¼‰ï¼Œè¾“å‡ºä¸€ä¸ªHå­—ç¬¦ï¼Œç„¶åç­‰å¾…æ …æ æ”¾è¡Œã€‚ç­‰å…¶å®ƒçš„goroutineå¡«è¡¥äº†æ°¢åŸå­çš„å¦ä¸€ä¸ªç©ºæ§½å’Œæ°§åŸå­çš„ç©ºæ§½ä¹‹åï¼Œç¨‹åºæ‰å¯ä»¥ç»§ç»­è¿›è¡Œã€‚</p><pre><code>func (h2o *H2O) hydrogen(releaseHydrogen func()) {\n\th2o.semaH.Acquire(context.Background(), 1)\n\n\treleaseHydrogen() // è¾“å‡ºH\n\th2o.b.Await(context.Background()) //ç­‰å¾…æ …æ æ”¾è¡Œ\n\th2o.semaH.Release(1) // é‡Šæ”¾æ°¢åŸå­ç©ºæ§½\n}\n</code></pre><p>ç„¶åæ˜¯æ°§åŸå­çš„æµæ°´çº¿ã€‚æ°§åŸå­çš„æµæ°´çº¿å¤„ç†æ–¹æ³•æ˜¯oxygenï¼Œ oxygenæ–¹æ³•æ˜¯ç­‰å¾…æ°§åŸå­çš„ç©ºæ§½ï¼Œç„¶åè¾“å‡ºä¸€ä¸ªOï¼Œå°±ç­‰å¾…æ …æ æ”¾è¡Œã€‚æ”¾è¡Œåï¼Œé‡Šæ”¾æ°§åŸå­ç©ºæ§½ä½ã€‚</p><pre><code>func (h2o *H2O) oxygen(releaseOxygen func()) {\n\th2o.semaO.Acquire(context.Background(), 1)\n\n\treleaseOxygen() // è¾“å‡ºO\n\th2o.b.Await(context.Background()) //ç­‰å¾…æ …æ æ”¾è¡Œ\n\th2o.semaO.Release(1) // é‡Šæ”¾æ°¢åŸå­ç©ºæ§½\n}\n</code></pre><p>åœ¨æ …æ æ”¾è¡Œä¹‹å‰ï¼Œåªæœ‰ä¸¤ä¸ªæ°¢åŸå­çš„ç©ºæ§½ä½å’Œä¸€ä¸ªæ°§åŸå­çš„ç©ºæ§½ä½ã€‚åªæœ‰ç­‰æ …æ æ”¾è¡Œä¹‹åï¼Œè¿™äº›ç©ºæ§½ä½æ‰ä¼šè¢«é‡Šæ”¾ã€‚æ …æ æ”¾è¡Œï¼Œå°±æ„å‘³ç€ä¸€ä¸ªæ°´åˆ†å­ç»„æˆæˆåŠŸã€‚</p><p>è¿™ä¸ªç®—æ³•æ˜¯ä¸æ˜¯æ­£ç¡®å‘¢ï¼Ÿæˆ‘ä»¬æ¥ç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•æ£€æµ‹ä¸€ä¸‹ã€‚</p><pre><code>package water\n\n\nimport (\n    &quot;math/rand&quot;\n    &quot;sort&quot;\n    &quot;sync&quot;\n    &quot;testing&quot;\n    &quot;time&quot;\n)\n\n\nfunc TestWaterFactory(t *testing.T) {\n    //ç”¨æ¥å­˜æ”¾æ°´åˆ†å­ç»“æœçš„channel\n    var ch chan string\n    releaseHydrogen := func() {\n        ch &lt;- &quot;H&quot;\n    }\n    releaseOxygen := func() {\n        ch &lt;- &quot;O&quot;\n    }\n\n    // 300ä¸ªåŸå­ï¼Œ300ä¸ªgoroutine,æ¯ä¸ªgoroutineå¹¶å‘çš„äº§ç”Ÿä¸€ä¸ªåŸå­\n    var N = 100\n    ch = make(chan string, N*3)\n\n\n    h2o := New()\n\n    // ç”¨æ¥ç­‰å¾…æ‰€æœ‰çš„goroutineå®Œæˆ\n    var wg sync.WaitGroup\n    wg.Add(N * 3)\n   \n    // 200ä¸ªæ°¢åŸå­goroutine\n    for i := 0; i &lt; 2*N; i++ {\n        go func() {\n            time.Sleep(time.Duration(rand.Intn(100)) * time.Millisecond)\n            h2o.hydrogen(releaseHydrogen)\n            wg.Done()\n        }()\n    }\n    // 100ä¸ªæ°§åŸå­goroutine\n    for i := 0; i &lt; N; i++ {\n        go func() {\n            time.Sleep(time.Duration(rand.Intn(100)) * time.Millisecond)\n            h2o.oxygen(releaseOxygen)\n            wg.Done()\n        }()\n    }\n    \n    //ç­‰å¾…æ‰€æœ‰çš„goroutineæ‰§è¡Œå®Œ\n    wg.Wait()\n\n    // ç»“æœä¸­è‚¯å®šæ˜¯300ä¸ªåŸå­\n    if len(ch) != N*3 {\n        t.Fatalf(&quot;expect %d atom but got %d&quot;, N*3, len(ch))\n    }\n\n    // æ¯ä¸‰ä¸ªåŸå­ä¸€ç»„ï¼Œåˆ†åˆ«è¿›è¡Œæ£€æŸ¥ã€‚è¦æ±‚è¿™ä¸€ç»„åŸå­ä¸­å¿…é¡»åŒ…å«ä¸¤ä¸ªæ°¢åŸå­å’Œä¸€ä¸ªæ°§åŸå­ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®ç»„æˆä¸€ä¸ªæ°´åˆ†å­ã€‚\n    var s = make([]string, 3)\n    for i := 0; i &lt; N; i++ {\n        s[0] = &lt;-ch\n        s[1] = &lt;-ch\n        s[2] = &lt;-ch\n        sort.Strings(s)\n\n\n        water := s[0] + s[1] + s[2]\n        if water != &quot;HHO&quot; {\n            t.Fatalf(&quot;expect a water molecule but got %s&quot;, water)\n        }\n    }\n}\n</code></pre><h1>æ€»ç»“</h1><p>æ¯ä¸€ä¸ªå¹¶å‘åŸè¯­éƒ½æœ‰å®ƒå­˜åœ¨çš„é“ç†ï¼Œä¹Ÿéƒ½æœ‰å®ƒåº”ç”¨çš„åœºæ™¯ã€‚</p><p>å¦‚æœä½ æ²¡æœ‰å­¦ä¹ CyclicBarrierï¼Œä½ å¯èƒ½åªä¼šæƒ³åˆ°ï¼Œç”¨WaitGroupæ¥å®ç°è¿™ä¸ªæ°´åˆ†å­åˆ¶é€ å·¥å‚çš„ä¾‹å­ã€‚</p><pre><code>type H2O struct {\n    semaH *semaphore.Weighted\n    semaO *semaphore.Weighted\n    wg    sync.WaitGroup //å°†å¾ªç¯æ …æ æ›¿æ¢æˆWaitGroup\n}\n\nfunc New() *H2O {\n    var wg sync.WaitGroup\n    wg.Add(3)\n\n    return &amp;H2O{\n        semaH: semaphore.NewWeighted(2),\n        semaO: semaphore.NewWeighted(1),\n        wg:    wg,\n    }\n}\n\n\nfunc (h2o *H2O) hydrogen(releaseHydrogen func()) {\n    h2o.semaH.Acquire(context.Background(), 1)\n    releaseHydrogen()\n\n    // æ ‡è®°è‡ªå·±å·²è¾¾åˆ°ï¼Œç­‰å¾…å…¶å®ƒgoroutineåˆ°è¾¾\n    h2o.wg.Done()\n    h2o.wg.Wait()\n\n    h2o.semaH.Release(1)\n}\n\nfunc (h2o *H2O) oxygen(releaseOxygen func()) {\n    h2o.semaO.Acquire(context.Background(), 1)\n    releaseOxygen()\n\n    // æ ‡è®°è‡ªå·±å·²è¾¾åˆ°ï¼Œç­‰å¾…å…¶å®ƒgoroutineåˆ°è¾¾\n    h2o.wg.Done()\n    h2o.wg.Wait()\n    //éƒ½åˆ°è¾¾åé‡ç½®wg \n    h2o.wg.Add(3)\n\n    h2o.semaO.Release(1)\n}\n</code></pre><p>ä½ ä¸€çœ‹ä»£ç å°±çŸ¥é“äº†ï¼Œä½¿ç”¨WaitGroupéå¸¸å¤æ‚ï¼Œè€Œä¸”ï¼Œé‡ç”¨å’ŒDoneæ–¹æ³•çš„è°ƒç”¨æœ‰å¹¶å‘çš„é—®é¢˜ï¼Œç¨‹åºå¯èƒ½panicï¼Œè¿œè¿œæ²¡æœ‰ä½¿ç”¨å¾ªç¯æ …æ æ›´åŠ ç®€å•ç›´æ¥ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘å»ºè®®ä½ å¤šäº†è§£ä¸€äº›å¹¶å‘åŸè¯­ï¼Œç”šè‡³æ˜¯ä»å…¶å®ƒç¼–ç¨‹è¯­è¨€ã€æ“ä½œç³»ç»Ÿä¸­å­¦ä¹ æ›´å¤šçš„å¹¶å‘åŸè¯­ï¼Œè¿™æ ·å¯ä»¥è®©ä½ çš„çŸ¥è¯†åº“æ›´åŠ ä¸°å¯Œï¼Œåœ¨é¢å¯¹å¹¶å‘åœºæ™¯çš„æ—¶å€™ï¼Œä½ ä¹Ÿèƒ½æ›´åŠ æ¸¸åˆƒæœ‰ä½™ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/82/4f/826f346ac0ccd687dc5d9bcc46621d4f.jpg?wh=2250*1233\" alt=\"\"></p><h1>æ€è€ƒé¢˜</h1><p>å¦‚æœå¤§è‡ªç„¶çš„æ¬è¿å·¥å·¥å‚ç”Ÿäº§çš„æ¶²ä½“æ˜¯åŒæ°§æ°´ï¼ˆåŒæ°§æ°´åˆ†å­æ˜¯ä¸¤ä¸ªæ°¢åŸå­å’Œä¸¤ä¸ªæ°§åŸå­ï¼‰ï¼Œä½ åˆè¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","neighbors":{"left":{"article_title":"16 | Semaphoreï¼šä¸€ç¯‡æ–‡ç« ææ‡‚ä¿¡å·é‡","id":308399},"right":{"article_title":"18 | åˆ†ç»„æ“ä½œï¼šå¤„ç†ä¸€ç»„å­ä»»åŠ¡ï¼Œè¯¥ç”¨ä»€ä¹ˆå¹¶å‘åŸè¯­ï¼Ÿ","id":310443}},"comments":[{"had_liked":false,"id":262489,"user_name":"æœé‘«","can_delete":false,"product_type":"c1","uid":1332244,"ip_address":"","ucode":"D7651198B2C487","user_header":"https://static001.geekbang.org/account/avatar/00/14/54/14/84d49453.jpg","comment_is_top":false,"comment_ctime":1605750029,"is_pvip":false,"replies":[{"id":"95273","content":"åŠ æ²¹ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605766025,"ip_address":"","comment_id":262489,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44555422989","product_id":100061801,"comment_content":"è°¢è°¢è€å¸ˆçš„æ–‡ç« ï¼ç¬¬ä¸€æ¬¡çŸ¥é“æœ‰è¿™ä¸¤ç§å¹¶å‘åŸè¯­ï¼Œä¸ç®¡ä¹‹åå·¥ä½œèƒ½ä¸èƒ½ç”¨åˆ°ï¼Œè¿™éƒ½æ˜¯å¯¹ä¸ªäººçœ¼ç•Œçš„å¼€é˜”ï¼<br>ps:è€å¸ˆçš„æ–‡ç« å‡ ä¹éƒ½æ˜¯ä¸€ç¯‡é¡¶ä¸¤ç¯‡ï¼Œåˆšè®¢é˜…çš„æ—¶å€™è¿˜æ‹…å¿ƒè¯¾ç¨‹å†…å®¹å¤ªå°‘ï¼Œç°åœ¨ä¸€çœ‹æ‹…å¿ƒå®Œå…¨æ˜¯å¤šä½™çš„ï¼Œè¿™æ®µæ—¶é—´è¯»äº†è€å¸ˆçš„æ–‡ç« ä¹‹åï¼Œä¸ªäººå¯¹goå¹¶å‘çŸ¥è¯†äº†è§£æ›´æ·±åˆ»äº†ï¼Œè°¢è°¢è€å¸ˆï¼","like_count":11,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509855,"discussion_content":"åŠ æ²¹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605766025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262216,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1605666697,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"27375470473","product_id":100061801,"comment_content":"SingleFlight èƒ½ä¸èƒ½åˆå¹¶å¹¶å‘çš„å†™æ“ä½œå‘¢ï¼Ÿ<br>æˆ‘è§‰å¾—å¾—åˆ†æƒ…å†µè®¨è®ºï¼Œå¦‚æœå¤šä¸ªå†™è¯·æ±‚æ˜¯å¯¹äºåŒä¸€ä¸ªå¯¹è±¡ç›¸åŒçš„å†™æ“ä½œï¼Œæ¯”å¦‚æŠŠæŸæ¡è®°å½•çš„ä¸€ä¸ªå­—æ®µè®¾ç½®ä¸ºæŸä¸€ä¸ªå€¼ï¼Œè¿™æ ·çš„è¯å¯ä»¥åˆå¹¶ã€‚<br>å¦‚æœå†™æ“ä½œæ˜¯å¯¹äºå¯¹è±¡å¢å‡æ“ä½œï¼Œæ¶‰åŠå¹‚ç­‰è¡Œæ“ä½œä¸å¤ªåˆé€‚åˆå¹¶ã€‚","like_count":7},{"had_liked":false,"id":263036,"user_name":"chapin","can_delete":false,"product_type":"c1","uid":1070020,"ip_address":"","ucode":"BB1800A771A8E9","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/c4/dea5d7f3.jpg","comment_is_top":false,"comment_ctime":1605955764,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14490857652","product_id":100061801,"comment_content":"è¿™ä¸€èŠ‚åœ¨å®é™…é¡¹ç›®ä¸­éƒ½ç›´æ¥ç”¨åˆ°ã€‚","like_count":4,"discussions":[{"author":{"id":1198953,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4b/69/c02eac91.jpg","nickname":"å¤§æ¼ èƒ¡èåœ","note":"","ucode":"FBE51E4A13EF4F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328226,"discussion_content":"å®é™…ä¸Šé¢ç”¨çš„å°‘å§ï¼Œåº”è¯¥ä¹Ÿæœ‰å…¶ä»–çš„æ–¹å¼æ¥å®ç°å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606109895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2178501,"avatar":"https://static001.geekbang.org/account/avatar/00/21/3d/c5/f43fa619.jpg","nickname":"ğŸ€æŸ æª¬é±¼ä¹Ÿæ˜¯é±¼","note":"","ucode":"DCF033636465F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1198953,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4b/69/c02eac91.jpg","nickname":"å¤§æ¼ èƒ¡èåœ","note":"","ucode":"FBE51E4A13EF4F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336625,"discussion_content":"singleflightè¿˜æ˜¯æœ‰ç”¨åˆ°ï¼Œbarrierä¸å¤ªæ¸…æ¥š\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608636593,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328226,"ip_address":""},"score":336625,"extra":""}]}]},{"had_liked":false,"id":270480,"user_name":"Fan","can_delete":false,"product_type":"c1","uid":1115232,"ip_address":"","ucode":"3BF28670FD9407","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","comment_is_top":false,"comment_ctime":1609143260,"is_pvip":false,"replies":[{"id":"98143","content":"https:&#47;&#47;github.com&#47;smallnest&#47;dive-to-gosync-workshop&#47;tree&#47;master&#47;7.orchestration&#47;water","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1609202068,"ip_address":"","comment_id":270480,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5904110556","product_id":100061801,"comment_content":"è€å¸ˆï¼Œåœ¨ä½ githubåœ°å€ https:&#47;&#47;github.com&#47;smallnest&#47;dive-to-gosync-workshop&#47;tree&#47;master&#47;7.orchestration&#47;waterä¸­æ²¡æœ‰æœåˆ°WaitGroupç‰ˆæœ¬çš„H2Oçš„ä¾‹å­ï¼Œä½†æ˜¯æŒ‰ç…§ä½ æ­£æ–‡ä¸­WaitGroupç‰ˆæœ¬å®ç°H2Oï¼Œæœ‰æŠ¥é”™panic: sync: WaitGroup is reused before previous Wait has returned<br>ã€‚è¯·é—®è€å¸ˆè¿™åº”è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿå¾ˆå›°æƒ‘ï¼Œæœ›è€å¸ˆæŒ‡ç‚¹ã€‚","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512642,"discussion_content":"https://github.com/smallnest/dive-to-gosync-workshop/tree/master/7.orchestration/water","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609202068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115232,"avatar":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","nickname":"Fan","note":"","ucode":"3BF28670FD9407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338209,"discussion_content":"è€å¸ˆï¼Œä½ è¯´çš„é‚£ä¸ªä¾‹å­ä¸æ˜¯ç”¨WaitGroupå®ç°çš„ï¼Œè€Œæ˜¯ç”¨CyclicBarrieræ¥å®ç°ã€‚è¿™ä¸ªæˆ‘èƒ½ç†è§£ã€‚\næ‘˜è‡ªæ­£æ–‡å†…å®¹â€œä½ ä¸€çœ‹ä»£ç å°±çŸ¥é“äº†ï¼Œä½¿ç”¨ WaitGroup éå¸¸å¤æ‚ï¼Œè€Œä¸”ï¼Œé‡ç”¨å’Œ Done æ–¹æ³•çš„è°ƒç”¨æœ‰å¹¶å‘çš„é—®é¢˜ï¼Œç¨‹åºå¯èƒ½ panicï¼Œè¿œè¿œæ²¡æœ‰ä½¿ç”¨å¾ªç¯æ …æ æ›´åŠ ç®€å•ç›´æ¥ã€‚â€è¿™ä¸ªçš„æ„æ€æ˜¯è¯´æ­£æ–‡é‚£ä¸ªç”¨WaitGroupå®ç°çš„H2Oç‰ˆæœ¬ï¼Œæ˜¯æœ‰é—®é¢˜çš„ï¼Œå¯¹å—ï¼Ÿ\næˆ‘è¿™è¾¹æµ‹è¯•çš„è¯ï¼ŒæŠ¥é”™ä¿¡æ¯æ˜¯è¿™ä¸ªpanic: sync: WaitGroup is reused before previous Wait has returnedã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609213386,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270061,"user_name":"Fan","can_delete":false,"product_type":"c1","uid":1115232,"ip_address":"","ucode":"3BF28670FD9407","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","comment_is_top":false,"comment_ctime":1608888999,"is_pvip":false,"replies":[{"id":"97878","content":"æŠ¥ä»€ä¹ˆé”™ï¼Ÿè¿™äº›ä¾‹å­éƒ½æ˜¯æˆ‘è¿è¡Œè¿‡çš„ï¼Œä½ ä¹Ÿå¯ä»¥åˆ°githubä¸Šæœæˆ‘çš„ä¸€ä¸ªé¡¹ç›®å«workshopçš„ä»£ç ","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1608900792,"ip_address":"","comment_id":270061,"utype":1}],"discussion_count":4,"race_medal":0,"score":"5903856295","product_id":100061801,"comment_content":"è€å¸ˆï¼Œæ„Ÿè§‰ä½ ä¸Šé¢ç”¨waitGroupå®ç°è¿™ä¸ªH2Oçš„ä¾‹å­æœ‰é—®é¢˜çš„ã€‚æˆ‘è¿™è¾¹è¿è¡Œéƒ½panicçš„ã€‚","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512503,"discussion_content":"æŠ¥ä»€ä¹ˆé”™ï¼Ÿè¿™äº›ä¾‹å­éƒ½æ˜¯æˆ‘è¿è¡Œè¿‡çš„ï¼Œä½ ä¹Ÿå¯ä»¥åˆ°githubä¸Šæœæˆ‘çš„ä¸€ä¸ªé¡¹ç›®å«workshopçš„ä»£ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608900792,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115232,"avatar":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","nickname":"Fan","note":"","ucode":"3BF28670FD9407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337435,"discussion_content":"``` go\n//water.go\ntype H2O struct {\n    semaH *semaphore.Weighted\n    semaO *semaphore.Weighted\n    wg    sync.WaitGroup //å°†å¾ªç¯æ …æ æ›¿æ¢æˆWaitGroup\n}\n\nfunc New() *H2O {\n    var wg sync.WaitGroup\n    wg.Add(3)\n\n    return &amp;H2O{\n        semaH: semaphore.NewWeighted(2),\n        semaO: semaphore.NewWeighted(1),\n        wg:    wg,\n    }\n}\n\n\nfunc (h2o *H2O) hydrogen(releaseHydrogen func()) {\n    h2o.semaH.Acquire(context.Background(), 1)\n    releaseHydrogen()\n\n    // æ ‡è®°è‡ªå·±å·²è¾¾åˆ°ï¼Œç­‰å¾…å…¶å®ƒgoroutineåˆ°è¾¾\n    h2o.wg.Done()\n    h2o.wg.Wait()\n\n    h2o.semaH.Release(1)\n}\n\nfunc (h2o *H2O) oxygen(releaseOxygen func()) {\n    h2o.semaO.Acquire(context.Background(), 1)\n    releaseOxygen()\n\n    // æ ‡è®°è‡ªå·±å·²è¾¾åˆ°ï¼Œç­‰å¾…å…¶å®ƒgoroutineåˆ°è¾¾\n    h2o.wg.Done()\n    h2o.wg.Wait()\n    //éƒ½åˆ°è¾¾åé‡ç½®wg \n    h2o.wg.Add(3)\n\n    h2o.semaO.Release(1)\n}\n```","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608905337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115232,"avatar":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","nickname":"Fan","note":"","ucode":"3BF28670FD9407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337434,"discussion_content":"å‚è€ƒè¿™ä¸ªé“¾æ¥çš„https://github.com/smallnest/dive-to-gosync-workshop/tree/master/7.orchestration/water","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608905251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115232,"avatar":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","nickname":"Fan","note":"","ucode":"3BF28670FD9407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337433,"discussion_content":"è€å¸ˆï¼Œå°±æ˜¯ä½ è¿™ä¸ªé“¾æ¥ä¸­çš„ä»£ç ã€‚ä¸è¿‡water.goè¿™ä¸ªæ›¿æ¢æˆä½ ç”¨WaitGroup æ¥å®ç°é‚£ä¸ªã€‚\næŠ¥é”™ä¿¡æ¯\n\nRunning tool: /usr/local/go/bin/go test -timeout 30s -run ^TestWaterFactory$ gin-demo/water -v\n\n=== RUN   TestWaterFactory\npanic: sync: WaitGroup is reused before previous Wait has returned\n\ngoroutine 8 [running]:\nsync.(*WaitGroup).Wait(0xc00000c0f0)\n\t/usr/local/go/src/sync/waitgroup.go:132 +0xad\ndemo/water.(*H2O).hydrogen(0xc00000c0e0, 0xc00004c510)\n\t/Users/xxx/demo/water/water.go:33 +0x8b\ndemo/water.TestWaterFactory.func5(0x64, 0xc00000c0e0, 0xc00004c510, 0xc0000162c0)\n\t/Users/xxx/demo/water/water_test.go:45 +0x70\ncreated by demo/water.TestWaterFactory\n\t/Users/xxx/demo/water/water_test.go:42 +0x1fa\nFAIL demo/water\t0.507s","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608905203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263374,"user_name":"ä¼Ÿä¼Ÿ","can_delete":false,"product_type":"c1","uid":1060937,"ip_address":"","ucode":"F0B393FC6E1098","user_header":"https://static001.geekbang.org/account/avatar/00/10/30/49/f9e37ced.jpg","comment_is_top":false,"comment_ctime":1606119185,"is_pvip":true,"replies":[{"id":"95571","content":"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1606133129,"ip_address":"","comment_id":263374,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5901086481","product_id":100061801,"comment_content":"package main<br><br>import (<br>\t&quot;context&quot;<br><br>\t&quot;github.com&#47;marusama&#47;cyclicbarrier&quot;<br>\t&quot;golang.org&#47;x&#47;sync&#47;semaphore&quot;<br>)<br><br>type H2O2 struct {<br>\tsemaH *semaphore.Weighted<br>\tsemaO *semaphore.Weighted<br>\tb     cyclicbarrier.CyclicBarrier<br>}<br><br>func New() *H2O2 {<br>\treturn &amp;H2O2{<br>\t\tsemaH: semaphore.NewWeighted(2),<br>\t\tsemaO: semaphore.NewWeighted(2),<br>\t\tb:     cyclicbarrier.New(4),<br>\t}<br>}<br><br>func (h2o2 *H2O2) hydrogen(releaseHydrogen func()) {<br>\th2o2.semaH.Acquire(context.Background(), 1)<br>\treleaseHydrogen()<br>\th2o2.b.Await(context.Background())<br>\th2o2.semaH.Release(1)<br>}<br><br>func (h2o2 *H2O2) oxygen(releaseOxygen func()) {<br>\th2o2.semaO.Acquire(context.Background(), 1)<br>\treleaseOxygen()<br>\th2o2.b.Await(context.Background())<br>\th2o2.semaO.Release(1)<br>}","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510165,"discussion_content":"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606133129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262570,"user_name":"è™«å­æ¨±æ¡ƒ","can_delete":false,"product_type":"c1","uid":1226331,"ip_address":"","ucode":"F8244A9E9BC5A6","user_header":"https://static001.geekbang.org/account/avatar/00/12/b6/5b/4486e4f9.jpg","comment_is_top":false,"comment_ctime":1605771399,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5900738695","product_id":100061801,"comment_content":"å†™äº†singleFlightçš„ä¾‹å­è¾…åŠ©æ€è€ƒã€‚<br>package main<br><br>import (<br>\t&quot;log&quot;<br>\t&quot;sync&quot;<br>\t&quot;sync&#47;atomic&quot;<br>\t&quot;time&quot;<br><br>\t&quot;golang.org&#47;x&#47;sync&#47;singleflight&quot;<br>)<br><br>var (<br>\tsf           = singleflight.Group{}<br>\trequestCount = int64(0)<br>\tresp         = make(chan int64, 0)<br>\twg           sync.WaitGroup<br>)<br><br>func main() {<br>\tfor i := 0; i &lt; 100; i++ {<br>\t\twg.Add(1)<br>\t\tgo func() {<br>\t\t\tdo, err, _ := sf.Do(&quot;number&quot;, Request)<br>\t\t\tif err != nil {<br>\t\t\t\tlog.Println(err)<br>\t\t\t}<br>\t\t\tlog.Println(&quot;resp&quot;, do)<br>\t\t\tdefer wg.Done()<br>\t\t}()<br>\t}<br>\ttime.Sleep(time.Second)<br>\tresp &lt;- atomic.LoadInt64(&amp;requestCount)<br>\twg.Wait()<br><br>}<br><br>func Request() (interface{}, error) {<br>\tatomic.AddInt64(&amp;requestCount, 1)<br>\treturn &lt;-resp, nil<br>}","like_count":1},{"had_liked":false,"id":338650,"user_name":"æ— åæ°","can_delete":false,"product_type":"c1","uid":1256121,"ip_address":"","ucode":"584E697AE276AB","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/b9/2bf8cc89.jpg","comment_is_top":false,"comment_ctime":1647621457,"is_pvip":false,"replies":[{"id":"123863","content":"hho,hoh,ohhï¼Œéƒ½å¯ä»¥ï¼Œåªæœ‰ä¿è¯æ˜¯ä¸€ä¸ªæ°´åˆ†å­","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1647823971,"ip_address":"","comment_id":338650,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1647621457","product_id":100061801,"comment_content":"CyclicBarrier é‚£ä¸ªæµ‹è¯•ä¾‹å­æ²¡æœ‰çœ‹æ‡‚ï¼Œ2ä¸ªHï¼Œä¸€ä¸ªOé¡ºåºæ€ä¹ˆä¿è¯æ˜¯HHOğŸ˜…","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557440,"discussion_content":"hho,hoh,ohhï¼Œéƒ½å¯ä»¥ï¼Œåªæœ‰ä¿è¯æ˜¯ä¸€ä¸ªæ°´åˆ†å­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647823971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1589872,"avatar":"https://static001.geekbang.org/account/avatar/00/18/42/70/c69f9b9d.jpg","nickname":"pisces","note":"","ucode":"7189215B51D120","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559961,"discussion_content":"åªèƒ½ä¿è¯æ•°é‡æ˜¯2ä¸ªHå’Œ1ä¸ªOï¼Œè€å¸ˆåšäº†æ’åºï¼Œæ‰€ä»¥ä¸€å®šè¾“å‡ºHHO","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1649082005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336889,"user_name":"Lukia","can_delete":false,"product_type":"c1","uid":1028698,"ip_address":"","ucode":"C19472337BCCC6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b2/5a/574f5bb0.jpg","comment_is_top":false,"comment_ctime":1646450031,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646450031","product_id":100061801,"comment_content":"â€œforgotten==falseï¼Œæ‰€ä»¥ç¬¬ 8 è¡Œé»˜è®¤ä¼šè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆåï¼Œåç»­çš„åŒä¸€ä¸ª key çš„è¯·æ±‚åˆé‡æ–°å¼€å§‹æ–°ä¸€æ¬¡çš„ fn å‡½æ•°çš„è°ƒç”¨ã€‚â€è¿™ä¸€æ®µé€»è¾‘å¯ä»¥ç†è§£ ï¼Œä½†æ˜¯forgottençš„å˜é‡å‘½åå¾ˆå¥‡æ€ªï¼ˆæ„Ÿè§‰æ˜¯åå­—å–åäº†ï¼Ÿï¼‰ï¼Œfalseçš„æ—¶å€™å»åˆ é™¤mapé‡Œçš„keyï¼Œè¿™ä¸ªå’Œå¸¸è¯†ç›¸æ‚–ï¼Ÿ","like_count":0},{"had_liked":false,"id":323750,"user_name":"Geek8956","can_delete":false,"product_type":"c1","uid":2689403,"ip_address":"","ucode":"BF7EF77F174B79","user_header":"","comment_is_top":false,"comment_ctime":1638150521,"is_pvip":false,"replies":[{"id":"118054","content":"å¾ªç¯æ …æ çš„é‡ç‚¹æ˜¯å¾ªç¯ï¼Œé‡ç”¨","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1638928502,"ip_address":"","comment_id":323750,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638150521","product_id":100061801,"comment_content":"è€å¸ˆï¼Œè¯·é—®å¾ªç¯æ æ …å’Œcondå¹¶å‘åŸè¯­æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä»–ä»¬éƒ½å¯ä»¥è®©å¤šä¸ªåç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œç„¶åå¹¶å‘çš„å¼€å§‹æ‰§è¡Œã€‚","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536984,"discussion_content":"å¾ªç¯æ …æ çš„é‡ç‚¹æ˜¯å¾ªç¯ï¼Œé‡ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638928502,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318261,"user_name":"gitxuzan","can_delete":false,"product_type":"c1","uid":1081566,"ip_address":"","ucode":"B0E20F892DA716","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/de/c6191045.jpg","comment_is_top":false,"comment_ctime":1635218649,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635218649","product_id":100061801,"comment_content":"package main<br><br>import (<br>\t&quot;golang.org&#47;x&#47;sync&#47;singleflight&quot;<br>\t&quot;log&quot;<br>\t&quot;time&quot;<br>)<br><br>func main() {<br>\tvar singleSetCache singleflight.Group<br><br>\tgetAndSetCache := func(requestID int, cacheKey string) (string, error) {<br>\t\tvalue, _, _ := singleSetCache.Do(cacheKey, func() (ret interface{}, err error) { &#47;&#47;doçš„å…¥å‚keyï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„keyï¼Œè¿™æ ·åŒä¸€ä¸ªç¼“å­˜ï¼Œåªæœ‰ä¸€ä¸ªåç¨‹ä¼šå»è¯»DB<br>\t\t\tlog.Printf(&quot;requestidæ‰§è¡Œä¸€æ¬¡ %v &quot;, requestID)<br>\t\t\treturn &quot;VALUE&quot;, nil<br>\t\t})<br>\t\treturn value.(string), nil<br>\t}<br><br>\tcacheKey := &quot;cacheKey&quot;<br>\tfor i := 1; i &lt; 10; i++ { &#47;&#47;æ¨¡æ‹Ÿå¤šä¸ªåç¨‹åŒæ—¶è¯·æ±‚<br>\t\tgo func(requestID int) {<br>\t\t\tvalue, _ := getAndSetCache(requestID, cacheKey)<br>\t\t\t&#47;&#47;_ = value<br>\t\t\tlog.Printf(&quot;requestID %v get å€¼: %v&quot;, requestID, value)<br>\t\t}(i)<br>\t}<br>\ttime.Sleep(20 * time.Second)<br>}","like_count":0},{"had_liked":false,"id":297251,"user_name":"Panda","can_delete":false,"product_type":"c1","uid":1095740,"ip_address":"","ucode":"911A200C7B18BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/b8/3c/1a294619.jpg","comment_is_top":false,"comment_ctime":1623394456,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1623394456","product_id":100061801,"comment_content":"å­¦åˆ°äº†     SingleFight  åˆå¹¶      <br>","like_count":1},{"had_liked":false,"id":290665,"user_name":"TT","can_delete":false,"product_type":"c1","uid":1466771,"ip_address":"","ucode":"2D8CE3E45DA7A4","user_header":"https://static001.geekbang.org/account/avatar/00/16/61/93/3191eafa.jpg","comment_is_top":false,"comment_ctime":1619681033,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619681033","product_id":100061801,"comment_content":"ç§’å•Šï¼èµ¶ç´§è‡ªå·±å†™ç¯‡æ–‡ç« å†æ€»ç»“ä¸€ä¸‹ï¼Œè€å¸ˆåº”è¯¥ä¸ä»‹æ„æˆ‘æŠ„ç‚¹ä½œä¸šå§å“ˆå“ˆå“ˆï¼Œæˆ‘ä¼šæ³¨æ˜å‡ºå¤„çš„","like_count":0},{"had_liked":false,"id":276332,"user_name":"è™¢åœ‹æŠ€é†¬","can_delete":false,"product_type":"c1","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1611887738,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1611887738","product_id":100061801,"comment_content":"SingleFlight è¿™æ®µè¯ â€œä½ è¦æ³¨æ„ä¸‹ç¬¬ 7 è¡Œã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œforgotten==falseï¼Œæ‰€ä»¥ç¬¬ 8 è¡Œé»˜è®¤ä¼šè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆåï¼Œåç»­çš„åŒä¸€ä¸ª key çš„è¯·æ±‚åˆé‡æ–°å¼€å§‹æ–°ä¸€æ¬¡çš„ fn å‡½æ•°çš„è°ƒç”¨â€ï¼›æ„Ÿè§‰è·Ÿå¼€å¤´è¯´çš„ SingleFlight å¹¶å‘åªæ‰§è¡Œä¸€æ¬¡ç›¸çŸ›ç›¾ï¼›<br>ä»”ç»†ç†è§£æºç åŸæ¥æ˜¯è¿™æ ·ï¼šæ¯”å¦‚ æœ‰100ä¸ªå¹¶å‘kéƒ½æ˜¯xxxï¼›åœ¨SingleFlightå†…éƒ¨doCallæ—¶ï¼Œå¼€å§‹æœ‰20ä¸ªå¹¶å‘äº†ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå®Œäº†ä¼šåˆ é™¤kï¼ˆxxxï¼‰ï¼›åé¢åˆæœ‰60æ¬¡å¹¶å‘äº†ï¼Œä¼šåœ¨æ‰§è¡Œä¸€æ¬¡ç„¶ååˆ é™¤ï¼›åé¢åˆæœ‰20æ¬¡å¹¶å‘äº†å°±ä¼šåˆæ‰§è¡Œä¸€æ¬¡ååˆ é™¤ã€‚<br>","like_count":0,"discussions":[{"author":{"id":1392924,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/rRCSdTPyqWcW6U8DO9xL55ictNPlbQ38VAcaBNgibqaAhcH7mn1W9ddxIJLlMiaA5sngBicMX02w2HP5pAWpBAJsag/132","nickname":"butterfly","note":"","ucode":"1B724973303FB0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351264,"discussion_content":"ç»“åˆredisç¼“å­˜ä½¿ç”¨çš„è¯ï¼Œç¬¬ä¸€æ¬¡20æ¬¡å¹¶å‘çš„æ—¶å€™ï¼Œåº”è¯¥å°†æ•°æ®è®¾ç½®åœ¨redisä¸­ï¼Œ ç¬¬äºŒæ¬¡60æ¬¡å¹¶å‘çš„æ—¶å€™ï¼Œåº”è¯¥å…ˆä»redisä¸­è¯»ï¼Œè¯»ä¸åˆ°çš„æ—¶å€™ï¼Œå†ç”¨ SingleFlightè®¿é—®æ•°æ®åº“","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1614219886,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270479,"user_name":"Fan","can_delete":false,"product_type":"c1","uid":1115232,"ip_address":"","ucode":"3BF28670FD9407","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","comment_is_top":false,"comment_ctime":1609143244,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609143244","product_id":100061801,"comment_content":"è€å¸ˆï¼Œåœ¨ä½ githubåœ°å€ https:&#47;&#47;github.com&#47;smallnest&#47;dive-to-gosync-workshop&#47;tree&#47;master&#47;7.orchestration&#47;waterä¸­æ²¡æœ‰æœåˆ°WaitGroupç‰ˆæœ¬çš„H2Oçš„ä¾‹å­ï¼Œä½†æ˜¯æŒ‰ç…§ä½ æ­£æ–‡ä¸­WaitGroupç‰ˆæœ¬å®ç°H2Oï¼Œæœ‰æŠ¥é”™panic: sync: WaitGroup is reused before previous Wait has returned<br>ã€‚è¯·é—®è€å¸ˆè¿™åº”è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿå¾ˆå›°æƒ‘ï¼Œæœ›è€å¸ˆæŒ‡ç‚¹ã€‚","like_count":0},{"had_liked":false,"id":266614,"user_name":"è€çºª","can_delete":false,"product_type":"c1","uid":1227735,"ip_address":"","ucode":"BECF11D225D260","user_header":"https://static001.geekbang.org/account/avatar/00/12/bb/d7/91da132b.jpg","comment_is_top":false,"comment_ctime":1607415938,"is_pvip":false,"replies":[{"id":"96812","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1607421159,"ip_address":"","comment_id":266614,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1607415938","product_id":100061801,"comment_content":"åœ¨CyclicBarrierä¸­ï¼Œæ˜¯éœ€è¦ä¸€ç»„goroutineéƒ½æ‰§è¡Œåˆ°Await()æ–¹æ³•åï¼Œæ‰ä¼šéƒ½å‘ä¸‹æ‰§è¡Œå¦åˆ™å°±ä¼šé˜»å¡åœ¨Await()æ–¹æ³•ä¸Šå—","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511330,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607421159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262900,"user_name":"Linuxer","can_delete":false,"product_type":"c1","uid":1153978,"ip_address":"","ucode":"272D9D8089C3D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg","comment_is_top":false,"comment_ctime":1605875474,"is_pvip":false,"replies":[{"id":"95375","content":"å¤šå®è·µï¼Œåœ¨é¡¹ç›®ä¸­é”»ç‚¼ï¼Œå¾ˆå¿«å°±é¡ºæ‰‹äº†","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605888315,"ip_address":"","comment_id":262900,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605875474","product_id":100061801,"comment_content":"æ„Ÿè§‰è‡ªå·²Goåˆšåˆšå…¥é—¨ï¼Œæˆ‘ç¡®å®ä¹Ÿæ‰å­¦ä¹ ä¸€å‘¨å·¦å³ï¼Œçœ‹ç€æŒºçˆ½ï¼Œå†™èµ·æ¥è¿˜æ˜¯ä¸é¡ºæ‰‹ï¼Œè¿˜å¾—å¤šç»ƒä¹ ï¼Œè€å¸ˆèƒ½å¦ç»™æˆ‘ä»¬è¿™äº›æ‰“ç®—è½¬Goçš„æ–°æ‰‹ä¸€äº›å»ºè®®ï¼Œè°¢è°¢","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510024,"discussion_content":"å¤šå®è·µï¼Œåœ¨é¡¹ç›®ä¸­é”»ç‚¼ï¼Œå¾ˆå¿«å°±é¡ºæ‰‹äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605888315,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262303,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1605688467,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605688467","product_id":100061801,"comment_content":"æ‰“å¡ã€‚","like_count":0}]}