{"id":73795,"title":"17 | 如何正确地显示随机消息？","content":"<p>我在上一篇文章，为你讲解完order by语句的几种执行模式后，就想到了之前一个做英语学习App的朋友碰到过的一个性能问题。今天这篇文章，我就从这个性能问题说起，和你说说MySQL中的另外一种排序需求，希望能够加深你对MySQL排序逻辑的理解。</p><p>这个英语学习App首页有一个随机显示单词的功能，也就是根据每个用户的级别有一个单词表，然后这个用户每次访问首页的时候，都会随机滚动显示三个单词。他们发现随着单词表变大，选单词这个逻辑变得越来越慢，甚至影响到了首页的打开速度。</p><p>现在，如果让你来设计这个SQL语句，你会怎么写呢？</p><p>为了便于理解，我对这个例子进行了简化：去掉每个级别的用户都有一个对应的单词表这个逻辑，直接就是从一个单词表中随机选出三个单词。这个表的建表语句和初始数据的命令如下：</p><pre><code>mysql&gt; CREATE TABLE `words` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `word` varchar(64) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB;\n\ndelimiter ;;\ncreate procedure idata()\nbegin\n  declare i int;\n  set i=0;\n  while i&lt;10000 do\n    insert into words(word) values(concat(char(97+(i div 1000)), char(97+(i % 1000 div 100)), char(97+(i % 100 div 10)), char(97+(i % 10))));\n    set i=i+1;\n  end while;\nend;;\ndelimiter ;\n\ncall idata();\n</code></pre><p>为了便于量化说明，我在这个表里面插入了10000行记录。接下来，我们就一起看看要随机选择3个单词，有什么方法实现，存在什么问题以及如何改进。</p><h1>内存临时表</h1><p>首先，你会想到用order by rand()来实现这个逻辑。</p><pre><code>mysql&gt; select word from words order by rand() limit 3;\n</code></pre><p>这个语句的意思很直白，随机排序取前3个。虽然这个SQL语句写法很简单，但执行流程却有点复杂的。</p><!-- [[[read_end]]] --><p>我们先用explain命令来看看这个语句的执行情况。</p><p><img src=\"https://static001.geekbang.org/resource/image/59/50/59a4fb0165b7ce1184e41f2d061ce350.png?wh=1553*142\" alt=\"\"></p><center><span class=\"reference\">图1 使用explain命令查看语句的执行情况</span></center><p>Extra字段显示Using temporary，表示的是需要使用临时表；Using filesort，表示的是需要执行排序操作。</p><p>因此这个Extra的意思就是，需要临时表，并且需要在临时表上排序。</p><p>这里，你可以先回顾一下<a href=\"https://time.geekbang.org/column/article/73479\">上一篇文章</a>中全字段排序和rowid排序的内容。我把上一篇文章的两个流程图贴过来，方便你复习。</p><p><img src=\"https://static001.geekbang.org/resource/image/6c/72/6c821828cddf46670f9d56e126e3e772.jpg?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图2 全字段排序</span></center><p><img src=\"https://static001.geekbang.org/resource/image/dc/6d/dc92b67721171206a302eb679c83e86d.jpg?wh=1142*856\" alt=\"\"></p><center>图3 rowid排序</center><p>然后，我再问你一个问题，你觉得对于临时内存表的排序来说，它会选择哪一种算法呢？回顾一下上一篇文章的一个结论：<strong>对于InnoDB表来说</strong>，执行全字段排序会减少磁盘访问，因此会被优先选择。</p><p>我强调了“InnoDB表”，你肯定想到了，<strong>对于内存表，回表过程只是简单地根据数据行的位置，直接访问内存得到数据，根本不会导致多访问磁盘</strong>。优化器没有了这一层顾虑，那么它会优先考虑的，就是用于排序的行越小越好了，所以，MySQL这时就会选择rowid排序。</p><p>理解了这个算法选择的逻辑，我们再来看看语句的执行流程。同时，通过今天的这个例子，我们来尝试分析一下语句的扫描行数。</p><p>这条语句的执行流程是这样的：</p><ol>\n<li>\n<p>创建一个临时表。这个临时表使用的是memory引擎，表里有两个字段，第一个字段是double类型，为了后面描述方便，记为字段R，第二个字段是varchar(64)类型，记为字段W。并且，这个表没有建索引。</p>\n</li>\n<li>\n<p>从words表中，按主键顺序取出所有的word值。对于每一个word值，调用rand()函数生成一个大于0小于1的随机小数，并把这个随机小数和word分别存入临时表的R和W字段中，到此，扫描行数是10000。</p>\n</li>\n<li>\n<p>现在临时表有10000行数据了，接下来你要在这个没有索引的内存临时表上，按照字段R排序。</p>\n</li>\n<li>\n<p>初始化 sort_buffer。sort_buffer中有两个字段，一个是double类型，另一个是整型。</p>\n</li>\n<li>\n<p>从内存临时表中一行一行地取出R值和位置信息（我后面会和你解释这里为什么是“位置信息”），分别存入sort_buffer中的两个字段里。这个过程要对内存临时表做全表扫描，此时扫描行数增加10000，变成了20000。</p>\n</li>\n<li>\n<p>在sort_buffer中根据R的值进行排序。注意，这个过程没有涉及到表操作，所以不会增加扫描行数。</p>\n</li>\n<li>\n<p>排序完成后，取出前三个结果的位置信息，依次到内存临时表中取出word值，返回给客户端。这个过程中，访问了表的三行数据，总扫描行数变成了20003。</p>\n</li>\n</ol><p>接下来，我们通过慢查询日志（slow log）来验证一下我们分析得到的扫描行数是否正确。</p><pre><code># Query_time: 0.900376  Lock_time: 0.000347 Rows_sent: 3 Rows_examined: 20003\nSET timestamp=1541402277;\nselect word from words order by rand() limit 3;\n</code></pre><p>其中，Rows_examined：20003就表示这个语句执行过程中扫描了20003行，也就验证了我们分析得出的结论。</p><p>这里插一句题外话，在平时学习概念的过程中，你可以经常这样做，先通过原理分析算出扫描行数，然后再通过查看慢查询日志，来验证自己的结论。我自己就是经常这么做，这个过程很有趣，分析对了开心，分析错了但是弄清楚了也很开心。</p><p>现在，我来把完整的排序执行流程图画出来。</p><p><img src=\"https://static001.geekbang.org/resource/image/2a/fc/2abe849faa7dcad0189b61238b849ffc.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图4 随机排序完整流程图1</span></center><p>图中的pos就是位置信息，你可能会觉得奇怪，这里的“位置信息”是个什么概念？在上一篇文章中，我们对InnoDB表排序的时候，明明用的还是ID字段。</p><p>这时候，我们就要回到一个基本概念：<strong>MySQL的表是用什么方法来定位“一行数据”的。</strong></p><p>在前面<a href=\"https://time.geekbang.org/column/article/69236\">第4</a>和<a href=\"https://time.geekbang.org/column/article/69636\">第5</a>篇介绍索引的文章中，有几位同学问到，如果把一个InnoDB表的主键删掉，是不是就没有主键，就没办法回表了？</p><p>其实不是的。如果你创建的表没有主键，或者把一个表的主键删掉了，那么InnoDB会自己生成一个长度为6字节的rowid来作为主键。</p><p>这也就是排序模式里面，rowid名字的来历。实际上它表示的是：每个引擎用来唯一标识数据行的信息。</p><ul>\n<li>对于有主键的InnoDB表来说，这个rowid就是主键ID；</li>\n<li>对于没有主键的InnoDB表来说，这个rowid就是由系统生成的；</li>\n<li>MEMORY引擎不是索引组织表。在这个例子里面，你可以认为它就是一个数组。因此，这个rowid其实就是数组的下标。</li>\n</ul><p>到这里，我来稍微小结一下：<strong>order by rand()使用了内存临时表，内存临时表排序的时候使用了rowid排序方法。</strong></p><h1>磁盘临时表</h1><p>那么，是不是所有的临时表都是内存表呢？</p><p>其实不是的。tmp_table_size这个配置限制了内存临时表的大小，默认值是16M。如果临时表大小超过了tmp_table_size，那么内存临时表就会转成磁盘临时表。</p><p>磁盘临时表使用的引擎默认是InnoDB，是由参数internal_tmp_disk_storage_engine控制的。</p><p>当使用磁盘临时表的时候，对应的就是一个没有显式索引的InnoDB表的排序过程。</p><p>为了复现这个过程，我把tmp_table_size设置成1024，把sort_buffer_size设置成 32768, 把 max_length_for_sort_data 设置成16。</p><pre><code>set tmp_table_size=1024;\nset sort_buffer_size=32768;\nset max_length_for_sort_data=16;\n/* 打开 optimizer_trace，只对本线程有效 */\nSET optimizer_trace='enabled=on'; \n\n/* 执行语句 */\nselect word from words order by rand() limit 3;\n\n/* 查看 OPTIMIZER_TRACE 输出 */\nSELECT * FROM `information_schema`.`OPTIMIZER_TRACE`\\G\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/78/ab/78d2db9a4fdba81feadccf6e878b4aab.png?wh=646*369\" alt=\"\"></p><center><span class=\"reference\">图5 OPTIMIZER_TRACE部分结果</span></center><p>然后，我们来看一下这次OPTIMIZER_TRACE的结果。</p><p>因为将max_length_for_sort_data设置成16，小于word字段的长度定义，所以我们看到sort_mode里面显示的是rowid排序，这个是符合预期的，参与排序的是随机值R字段和rowid字段组成的行。</p><p>这时候你可能心算了一下，发现不对。R字段存放的随机值就8个字节，rowid是6个字节（至于为什么是6字节，就留给你课后思考吧），数据总行数是10000，这样算出来就有140000字节，超过了sort_buffer_size 定义的 32768字节了。但是，number_of_tmp_files的值居然是0，难道不需要用临时文件吗？</p><p>这个SQL语句的排序确实没有用到临时文件，采用是MySQL 5.6版本引入的一个新的排序算法，即：优先队列排序算法。接下来，我们就看看为什么没有使用临时文件的算法，也就是归并排序算法，而是采用了优先队列排序算法。</p><p>其实，我们现在的SQL语句，只需要取R值最小的3个rowid。但是，如果使用归并排序算法的话，虽然最终也能得到前3个值，但是这个算法结束后，已经将10000行数据都排好序了。</p><p>也就是说，后面的9997行也是有序的了。但，我们的查询并不需要这些数据是有序的。所以，想一下就明白了，这浪费了非常多的计算量。</p><p>而优先队列算法，就可以精确地只得到三个最小值，执行流程如下：</p><ol>\n<li>对于这10000个准备排序的(R,rowid)，先取前三行，构造成一个堆；</li>\n</ol><p>（对数据结构印象模糊的同学，可以先设想成这是一个由三个元素组成的数组）</p><ol>\n<li>\n<p>取下一个行(R’,rowid’)，跟当前堆里面最大的R比较，如果R’小于R，把这个(R,rowid)从堆中去掉，换成(R’,rowid’)；</p>\n</li>\n<li>\n<p>重复第2步，直到第10000个(R’,rowid’)完成比较。</p>\n</li>\n</ol><p>这里我简单画了一个优先队列排序过程的示意图。</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/97/e9c29cb20bf9668deba8981e444f6897.png?wh=1536*2048\" alt=\"\"></p><center><span class=\"reference\">图6 优先队列排序算法示例</span></center><p>图6是模拟6个(R,rowid)行，通过优先队列排序找到最小的三个R值的行的过程。整个排序过程中，为了最快地拿到当前堆的最大值，总是保持最大值在堆顶，因此这是一个最大堆。</p><p>图5的OPTIMIZER_TRACE结果中，filesort_priority_queue_optimization这个部分的chosen=true，就表示使用了优先队列排序算法，这个过程不需要临时文件，因此对应的number_of_tmp_files是0。</p><p>这个流程结束后，我们构造的堆里面，就是这个10000行里面R值最小的三行。然后，依次把它们的rowid取出来，去临时表里面拿到word字段，这个过程就跟上一篇文章的rowid排序的过程一样了。</p><p>我们再看一下上面一篇文章的SQL查询语句：</p><pre><code>select city,name,age from t where city='杭州' order by name limit 1000  ;\n</code></pre><p>你可能会问，这里也用到了limit，为什么没用优先队列排序算法呢？原因是，这条SQL语句是limit 1000，如果使用优先队列算法的话，需要维护的堆的大小就是1000行的(name,rowid)，超过了我设置的sort_buffer_size大小，所以只能使用归并排序算法。</p><p>总之，不论是使用哪种类型的临时表，order by rand()这种写法都会让计算过程非常复杂，需要大量的扫描行数，因此排序过程的资源消耗也会很大。</p><p>再回到我们文章开头的问题，怎么正确地随机排序呢？</p><h1>随机排序方法</h1><p>我们先把问题简化一下，如果只随机选择1个word值，可以怎么做呢？思路上是这样的：</p><ol>\n<li>\n<p>取得这个表的主键id的最大值M和最小值N;</p>\n</li>\n<li>\n<p>用随机函数生成一个最大值到最小值之间的数 X = (M-N)*rand() + N;</p>\n</li>\n<li>\n<p>取不小于X的第一个ID的行。</p>\n</li>\n</ol><p>我们把这个算法，暂时称作随机算法1。这里，我直接给你贴一下执行语句的序列:</p><pre><code>mysql&gt; select max(id),min(id) into @M,@N from t ;\nset @X= floor((@M-@N+1)*rand() + @N);\nselect * from t where id &gt;= @X limit 1;\n</code></pre><p>这个方法效率很高，因为取max(id)和min(id)都是不需要扫描索引的，而第三步的select也可以用索引快速定位，可以认为就只扫描了3行。但实际上，这个算法本身并不严格满足题目的随机要求，因为ID中间可能有空洞，因此选择不同行的概率不一样，不是真正的随机。</p><p>比如你有4个id，分别是1、2、4、5，如果按照上面的方法，那么取到 id=4的这一行的概率是取得其他行概率的两倍。</p><p>如果这四行的id分别是1、2、40000、40001呢？这个算法基本就能当bug来看待了。</p><p>所以，为了得到严格随机的结果，你可以用下面这个流程:</p><ol>\n<li>\n<p>取得整个表的行数，并记为C。</p>\n</li>\n<li>\n<p>取得 Y = floor(C * rand())。 floor函数在这里的作用，就是取整数部分。</p>\n</li>\n<li>\n<p>再用limit Y,1 取得一行。</p>\n</li>\n</ol><p>我们把这个算法，称为随机算法2。下面这段代码，就是上面流程的执行语句的序列。</p><pre><code>mysql&gt; select count(*) into @C from t;\nset @Y = floor(@C * rand());\nset @sql = concat(&quot;select * from t limit &quot;, @Y, &quot;,1&quot;);\nprepare stmt from @sql;\nexecute stmt;\nDEALLOCATE prepare stmt;\n</code></pre><p>由于limit 后面的参数不能直接跟变量，所以我在上面的代码中使用了prepare+execute的方法。你也可以把拼接SQL语句的方法写在应用程序中，会更简单些。</p><p>这个随机算法2，解决了算法1里面明显的概率不均匀问题。</p><p>MySQL处理limit Y,1 的做法就是按顺序一个一个地读出来，丢掉前Y个，然后把下一个记录作为返回结果，因此这一步需要扫描Y+1行。再加上，第一步扫描的C行，总共需要扫描C+Y+1行，执行代价比随机算法1的代价要高。</p><p>当然，随机算法2跟直接order by rand()比起来，执行代价还是小很多的。</p><p>你可能问了，如果按照这个表有10000行来计算的话，C=10000，要是随机到比较大的Y值，那扫描行数也跟20000差不多了，接近order by rand()的扫描行数，为什么说随机算法2的代价要小很多呢？我就把这个问题留给你去课后思考吧。</p><p>现在，我们再看看，如果我们按照随机算法2的思路，要随机取3个word值呢？你可以这么做：</p><ol>\n<li>\n<p>取得整个表的行数，记为C；</p>\n</li>\n<li>\n<p>根据相同的随机方法得到Y1、Y2、Y3；</p>\n</li>\n<li>\n<p>再执行三个limit Y, 1语句得到三行数据。</p>\n</li>\n</ol><p>我们把这个算法，称作随机算法3。下面这段代码，就是上面流程的执行语句的序列。</p><pre><code>mysql&gt; select count(*) into @C from t;\nset @Y1 = floor(@C * rand());\nset @Y2 = floor(@C * rand());\nset @Y3 = floor(@C * rand());\nselect * from t limit @Y1，1； //在应用代码里面取Y1、Y2、Y3值，拼出SQL后执行\nselect * from t limit @Y2，1；\nselect * from t limit @Y3，1；\n</code></pre><h1>小结</h1><p>今天这篇文章，我是借着随机排序的需求，跟你介绍了MySQL对临时表排序的执行过程。</p><p>如果你直接使用order by rand()，这个语句需要Using temporary 和 Using filesort，查询的执行代价往往是比较大的。所以，在设计的时候你要尽量避开这种写法。</p><p>今天的例子里面，我们不是仅仅在数据库内部解决问题，还会让应用代码配合拼接SQL语句。在实际应用的过程中，比较规范的用法就是：尽量将业务逻辑写在业务代码中，让数据库只做“读写数据”的事情。因此，这类方法的应用还是比较广泛的。</p><p>最后，我给你留下一个思考题吧。</p><p>上面的随机算法3的总扫描行数是 C+(Y1+1)+(Y2+1)+(Y3+1)，实际上它还是可以继续优化，来进一步减少扫描行数的。</p><p>我的问题是，如果你是这个需求的开发人员，你会怎么做，来减少扫描行数呢？说说你的方案，并说明你的方案需要的扫描行数。</p><p>你可以把你的设计和结论写在留言区里，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>我在上一篇文章最后留给你的问题是，select * from t where city in (“杭州”,\" 苏州 \") order by name limit 100;这个SQL语句是否需要排序？有什么方案可以避免排序？</p><p>虽然有(city,name)联合索引，对于单个city内部，name是递增的。但是由于这条SQL语句不是要单独地查一个city的值，而是同时查了\"杭州\"和\" 苏州 \"两个城市，因此所有满足条件的name就不是递增的了。也就是说，这条SQL语句需要排序。</p><p>那怎么避免排序呢？</p><p>这里，我们要用到(city,name)联合索引的特性，把这一条语句拆成两条语句，执行流程如下：</p><ol>\n<li>\n<p>执行select * from t where city=“杭州” order by name limit 100; 这个语句是不需要排序的，客户端用一个长度为100的内存数组A保存结果。</p>\n</li>\n<li>\n<p>执行select * from t where city=“苏州” order by name limit 100; 用相同的方法，假设结果被存进了内存数组B。</p>\n</li>\n<li>\n<p>现在A和B是两个有序数组，然后你可以用归并排序的思想，得到name最小的前100值，就是我们需要的结果了。</p>\n</li>\n</ol><p>如果把这条SQL语句里“limit 100”改成“limit 10000,100”的话，处理方式其实也差不多，即：要把上面的两条语句改成写：</p><pre><code>select * from t where city=&quot;杭州&quot; order by name limit 10100; \n</code></pre><p>和</p><pre><code> select * from t where city=&quot;苏州&quot; order by name limit 10100。\n</code></pre><p>这时候数据量较大，可以同时起两个连接一行行读结果，用归并排序算法拿到这两个结果集里，按顺序取第10001~10100的name值，就是需要的结果了。</p><p>当然这个方案有一个明显的损失，就是从数据库返回给客户端的数据量变大了。</p><p>所以，如果数据的单行比较大的话，可以考虑把这两条SQL语句改成下面这种写法：</p><pre><code>select id,name from t where city=&quot;杭州&quot; order by name limit 10100; \n</code></pre><p>和</p><pre><code>select id,name from t where city=&quot;苏州&quot; order by name limit 10100。\n</code></pre><p>然后，再用归并排序的方法取得按name顺序第10001~10100的name、id的值，然后拿着这100个id到数据库中去查出所有记录。</p><p>上面这些方法，需要你根据性能需求和开发的复杂度做出权衡。</p><p>评论区留言点赞板：</p><blockquote>\n<p>评论区很多同学都提到不能排序，说明各位对索引的存储都理解对了。<br>\n@峰 同学提到了归并排序，是我们这个问题解法的核心思想；<br>\n@老杨同志 的回答中提到了“从业务上砍掉功能”，这个也确实是在业务设计中可以考虑的一个方向；<br>\n@某、人 帮忙回答了@发条橙子同学的问题，尤其是对问题一的回答，非常精彩。</p>\n</blockquote>","neighbors":{"left":{"article_title":"16 | “order by”是怎么工作的？","id":73479},"right":{"article_title":"18 | 为什么这些SQL语句逻辑相同，性能却差异巨大？","id":74059}},"comments":[{"had_liked":false,"id":52283,"user_name":"老杨同志","can_delete":false,"product_type":"c1","uid":1246199,"ip_address":"","ucode":"3F334F0CFD3DE6","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg","comment_is_top":true,"comment_ctime":1545358176,"is_pvip":false,"replies":[{"id":"18995","content":"重新整理表这个思路很赞👍🏿<br><br>看得出你是业务经验很丰富啊，这几次问题，对底层实现和业务功能的平衡，考虑点很不错","user_name":"作者回复","comment_id":52283,"uid":"1264162","ip_address":"","utype":1,"ctime":1545359994,"user_name_real":"林晓斌"}],"discussion_count":7,"race_medal":0,"score":"9.2233731851563991e+18","product_id":100020801,"comment_content":"对应单词这种总量不是很多的数据，第一感觉应该装jdk缓存或者redis缓存。由于需要随机访问，数组比较好。假如一个单词平均10个字节，10*10000，不到1M就装下了。<br>如果一定要用数据库来做，老师的方案1比较好，空洞的问题，如果单词库不变，可以在上线前整理数据，把空洞处理调。比如：原来单词存在A表，新建B表  ，执行 insert into B(word) select word from A.   B的id是自增的，就会生成连续的主键。当然如果A表写比较频繁，且数据量较大，业务上禁用 这种写法，RR的隔离级别会锁A表 <br>","like_count":268,"discussions":[{"author":{"id":1254645,"avatar":"https://static001.geekbang.org/account/avatar/00/13/24/f5/64ca8ddd.jpg","nickname":"凌轩","note":"","ucode":"1BC5A205F3B9C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159643,"discussion_content":"如果用数据库且存在大量增删的情况下，一般业务上会要求逻辑删除，而不会真正的删除那一行，所以id应该可以保持连续性，这样的话，用方案1,每次取多个随机id，select id,word\n from t where id in (92,94,95,100,101,109) and deleted = 0;如果结果不足3个，过滤掉这些id再取第二次直到满足3个为止。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1580719954,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1589055,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKKKdCyib4iblXC6JIH7HWDfIFVweTb7SgEOuRjquic3GiaiaGInFSiaU8w2y2bjvZjgiaA3IEQuyibXTaeHQ/132","nickname":"10xiaohu","note":"","ucode":"CAB39DBB93E608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1254645,"avatar":"https://static001.geekbang.org/account/avatar/00/13/24/f5/64ca8ddd.jpg","nickname":"凌轩","note":"","ucode":"1BC5A205F3B9C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351225,"discussion_content":"这样会不会麻烦了？要递归，还要排除之前选中的，当然一般第二次就可以了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614180429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":159643,"ip_address":""},"score":351225,"extra":""}]},{"author":{"id":1019332,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","nickname":"长期规划","note":"","ucode":"5EF65E9115834B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":53015,"discussion_content":"用缓存比较好👍","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1574124180,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2350043,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/sFkJYPdIIjHfxgCxAh1D4Pyk1jAueicu7egY1PUvR8egs12gAXxmO51YT6Bk7NianYRyMRPTpd3kKWXvZ8TEkRyw/132","nickname":"Geek_7794e2","note":"","ucode":"2F749554FEA20D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539503,"discussion_content":"为什么这个地方会锁表","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1639730599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2665912,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELkIkwnBrhKPibPZiaJD7LYXksCJ00rsgibk4M0iaUJke4dWBicCs8zOR5dzQqb82alK7HVLqALrTPx3Yg/132","nickname":"Geek_993c4a","note":"","ucode":"A93C79B3502929","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2350043,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/sFkJYPdIIjHfxgCxAh1D4Pyk1jAueicu7egY1PUvR8egs12gAXxmO51YT6Bk7NianYRyMRPTpd3kKWXvZ8TEkRyw/132","nickname":"Geek_7794e2","note":"","ucode":"2F749554FEA20D","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":555312,"discussion_content":"同问","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1646843757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":539503,"ip_address":""},"score":555312,"extra":""},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2350043,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/sFkJYPdIIjHfxgCxAh1D4Pyk1jAueicu7egY1PUvR8egs12gAXxmO51YT6Bk7NianYRyMRPTpd3kKWXvZ8TEkRyw/132","nickname":"Geek_7794e2","note":"","ucode":"2F749554FEA20D","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":588987,"discussion_content":"RR隔离级别下，insert会加间隙锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664287988,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":539503,"ip_address":"陕西"},"score":588987,"extra":""}]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433819,"discussion_content":"重新整理表这个思路很赞👍🏿\n\n看得出你是业务经验很丰富啊，这几次问题，对底层实现和业务功能的平衡，考虑点很不错","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1545359994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52242,"user_name":"雪中鼠","can_delete":false,"product_type":"c1","uid":1082083,"ip_address":"","ucode":"EBEF2C2422BC93","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/e3/d9285284.jpg","comment_is_top":true,"comment_ctime":1545353987,"is_pvip":false,"replies":[{"id":"19001","content":"这个也是个好方法，就是确保连续，可以快速的得到C和几个偏移量","user_name":"作者回复","comment_id":52242,"uid":"1264162","ip_address":"","utype":1,"ctime":1545361691,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"9.223372158659199e+18","product_id":100020801,"comment_content":"如果按照业务需求，随机取三个，数据库还在设计阶段,可以增加一个主键字段,用来记录每行记录的rowid，这样一万行，那就是连续的一万，然后随机，用该随机rowid回表查询该行记录","like_count":29,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433800,"discussion_content":"这个也是个好方法，就是确保连续，可以快速的得到C和几个偏移量","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545361691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301419,"discussion_content":"删除第一条数据，全表都要跟着变动这个字段吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598520844,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1082083,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/e3/d9285284.jpg","nickname":"雪中鼠","note":"","ucode":"EBEF2C2422BC93","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305904,"discussion_content":"这里不考虑删除的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600127147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":301419,"ip_address":""},"score":305904,"extra":""}]}]},{"had_liked":false,"id":52456,"user_name":"HuaMax","can_delete":false,"product_type":"c1","uid":1118488,"ip_address":"","ucode":"2E78DE1AF098AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/11/18/8cee35f9.jpg","comment_is_top":false,"comment_ctime":1545385631,"is_pvip":false,"replies":[{"id":"19104","content":"👍🏿","user_name":"作者回复","comment_id":52456,"uid":"1264162","ip_address":"","utype":1,"ctime":1545398151,"user_name_real":"林晓斌"}],"discussion_count":8,"race_medal":0,"score":"602840807071","product_id":100020801,"comment_content":"假设Y1，Y2，Y3是由小到大的三个数，则可以优化成这样，这样扫描行数为Y3<br>id1 = select * from t limit @Y1，1；<br>id2= select * from t where id &gt; id1 limit @Y2-@Y1，1；<br>select * from t where id &gt; id2 limit @Y3 - @Y2，1；","like_count":141,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433883,"discussion_content":"👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545398151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1082785,"avatar":"https://static001.geekbang.org/account/avatar/00/10/85/a1/2442332c.jpg","nickname":"郭俊杰","note":"","ucode":"D328E5738A4413","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1643,"discussion_content":"C+Y3","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1562754850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2690457,"avatar":"https://static001.geekbang.org/account/avatar/00/29/0d/99/448d0e2b.jpg","nickname":"残霜晓月","note":"","ucode":"A615784C1EA7F1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559475,"discussion_content":"“如何优化大表分页查询”的答法之一","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1648791198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1363822,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/uktgj5R0p78c67oLib8EuRMRCgP8yjxnZ1ibVOuibhRZvjJpKSJNaTl0UlEfGyiaaiaGyPmqpGYpibTt0QopX1qtWfQQ/132","nickname":"杨大小最嗨皮","note":"","ucode":"7DFACF1414AE16","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531915,"discussion_content":"6 本质是用利用主键索引避免重复的全表扫描","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1637467544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2254917,"avatar":"https://static001.geekbang.org/account/avatar/00/22/68/45/ddf89612.jpg","nickname":"bestgopher","note":"","ucode":"D89735C8CA9C6E","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551139,"discussion_content":"牛逼啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644908547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373338,"discussion_content":"获取三个随机数就是3C，获取三个随机word扫描Y3+3行，总共扫描了3C+Y3+3行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620701587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1809799,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJNxMqDoNODfL1aFpkJboxlZPyFANAt9ovzksYtMUIGo3KbHr4Qy8j20Txrpiau6iaJGgAr1nCfpy9w/132","nickname":"爱学习的老吴","note":"","ucode":"E515F50E7A8A68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380973,"discussion_content":"获取随机数是函数操作，不用扫表，应该是count(*) 时扫了C，总共是C+Y3 + 3","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624848677,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373338,"ip_address":""},"score":380973,"extra":""}]},{"author":{"id":1475528,"avatar":"https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg","nickname":"maybe","note":"","ucode":"93D160F617E750","race_medal":4,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372412,"discussion_content":"我也是想到这个，分页查询优化方式\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620311400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52337,"user_name":"岁月安然","can_delete":false,"product_type":"c1","uid":1258557,"ip_address":"","ucode":"4538C24B67B513","user_header":"https://static001.geekbang.org/account/avatar/00/13/34/3d/51762e76.jpg","comment_is_top":false,"comment_ctime":1545363943,"is_pvip":false,"replies":[{"id":"19020","content":"对的，<br><br>你是第一个回答正文中间问题的😄👍🏿","user_name":"作者回复","comment_id":52337,"uid":"1264162","ip_address":"","utype":1,"ctime":1545364645,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"400977322471","product_id":100020801,"comment_content":"为什么随机算法2比order by rand()的代价小很多？<br>因为随机算法2进行limit获取数据的时候是根据主键排序获取的，主键天然索引排序。获取到第9999条的数据也远比order by rand()方法的组成临时表R字段排序再获取rowid代价小的多。","like_count":94,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433838,"discussion_content":"对的，\n\n你是第一个回答正文中间问题的😄👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545364645,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301420,"discussion_content":"只扫描，不建立临时表不排序，代价小太多了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598521023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3004698,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/d9/1a/f5bb1a23.jpg","nickname":"LL","note":"","ucode":"1E498475B2D9EC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576554,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655648993,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1475528,"avatar":"https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg","nickname":"maybe","note":"","ucode":"93D160F617E750","race_medal":4,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372414,"discussion_content":"赞同","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620311849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52197,"user_name":"吴宇晨","can_delete":false,"product_type":"c1","uid":1199968,"ip_address":"","ucode":"F8F45B7067DF6D","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/60/049a20e9.jpg","comment_is_top":false,"comment_ctime":1545350427,"is_pvip":false,"replies":[{"id":"19007","content":"抓住了关键点👍🏿","user_name":"作者回复","comment_id":52197,"uid":"1264162","ip_address":"","utype":1,"ctime":1545362115,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"383797439771","product_id":100020801,"comment_content":"我觉得可以按Y排个序，第一条取完，拿到对应id，然后有一条语句就是where id大于xxx，limit y2-y1，1","like_count":90,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433777,"discussion_content":"抓住了关键点👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545362115,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1672786,"avatar":"https://static001.geekbang.org/account/avatar/00/19/86/52/91c7d112.jpg","nickname":"Garen","note":"","ucode":"0608C88F83EF0C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":34735,"discussion_content":"我觉得老师举的例子没有考虑Y1，Y2，Y3值相同的情况。而楼主举的例子完全没看懂.\n一、边界的问题，万一拿到的Id是9998（甚至可能是9999，10000）。\n二、where条件的大于和limit y2-y1组合起来有问题。可能会偏移出10000以外。\n三、我没能看出这比算法3少了扫描行数\n\n不知道是不是我没能理解全面","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1571218509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1691243,"avatar":"https://static001.geekbang.org/account/avatar/00/19/ce/6b/ae7489a0.jpg","nickname":"Ccc","note":"","ucode":"EAEA0284948959","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1672786,"avatar":"https://static001.geekbang.org/account/avatar/00/19/86/52/91c7d112.jpg","nickname":"Garen","note":"","ucode":"0608C88F83EF0C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":64252,"discussion_content":"where id > xxx直接定位到第Y1条了，所以第二次select的时候就可以少扫描了Y行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574943364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":34735,"ip_address":""},"score":64252,"extra":""},{"author":{"id":1691243,"avatar":"https://static001.geekbang.org/account/avatar/00/19/ce/6b/ae7489a0.jpg","nickname":"Ccc","note":"","ucode":"EAEA0284948959","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1672786,"avatar":"https://static001.geekbang.org/account/avatar/00/19/86/52/91c7d112.jpg","nickname":"Garen","note":"","ucode":"0608C88F83EF0C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":64258,"discussion_content":"这个和分页的逻辑是一样的，每次都用上一次拿到的最后一条id作为where条件","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1574943458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":34735,"ip_address":""},"score":64258,"extra":""}]}]},{"had_liked":false,"id":52316,"user_name":"倪大人","can_delete":false,"product_type":"c1","uid":1193052,"ip_address":"","ucode":"4798D69F3E86FB","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/5c/6b4757a0.jpg","comment_is_top":false,"comment_ctime":1545361810,"is_pvip":false,"replies":[{"id":"19017","content":"漂亮","user_name":"作者回复","comment_id":52316,"uid":"1264162","ip_address":"","utype":1,"ctime":1545364413,"user_name_real":"林晓斌"}],"discussion_count":18,"race_medal":0,"score":"147574249874","product_id":100020801,"comment_content":"课后题可以在随机出Y1、Y2、Y3后，算出Ymax、Ymin<br>再用 select id from t limit Ymin，(Ymax - Ymin)；<br>得到id集后算出Y1、Y2、Y3对应的三个id<br>最后  select * from t where id in (id1, id2, id3)<br>这样扫描的行数应该是C+Ymax+3","like_count":35,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433831,"discussion_content":"漂亮","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545364413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1526471,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/c7/0cff4a59.jpg","nickname":"木木夕","note":"","ucode":"EA5D709D0DE50E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":29759,"discussion_content":"我有一个疑问就是，万一最大值和最小值的相差很大，比如1000万数据，limt min,max  相差了500万，那取500万个ID回到应用中，不是占了很大的内存吗？不容易OOM吗？，如果多个用户同时这样并发，那会不会炸？","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1570782482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1044546,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f0/42/7728d4f5.jpg","nickname":"艿艿","note":"","ucode":"8F727AB7A7F6B2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1526471,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/c7/0cff4a59.jpg","nickname":"木木夕","note":"","ucode":"EA5D709D0DE50E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":37762,"discussion_content":"牛逼！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571664469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":29759,"ip_address":""},"score":37762,"extra":""},{"author":{"id":1583588,"avatar":"https://static001.geekbang.org/account/avatar/00/18/29/e4/ade74d94.jpg","nickname":"hejun","note":"","ucode":"DCF01B4159178F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1526471,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/c7/0cff4a59.jpg","nickname":"木木夕","note":"","ucode":"EA5D709D0DE50E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283230,"discussion_content":"有道理，数据量大了就不好使了。其实主要问题就是如何更高效的定位Y1，Y2，Y3。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592216859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":29759,"ip_address":""},"score":283230,"extra":""},{"author":{"id":2289364,"avatar":"https://static001.geekbang.org/account/avatar/00/22/ee/d4/040686cd.jpg","nickname":"阳光下的小丑","note":"","ucode":"57995B5CC72715","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1526471,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/c7/0cff4a59.jpg","nickname":"木木夕","note":"","ucode":"EA5D709D0DE50E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543100,"discussion_content":"同样想到这个问题，感觉是在制造更大的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640948025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":29759,"ip_address":""},"score":543100,"extra":""}]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":160642,"discussion_content":"你是如何根据y1-y3算出相应的ID的，这个有点不知所谓啊。而且limit返回来是多个值的，肯定不是3个，因为max-min随机得出任何值都有可能。这叫什么路子？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580821599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1212009,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLyfaTNuvbkicpu3mTujhbQ2Xr6KSbfNJrukFv1gSmtdicxTNgN61M2ibxZdQpRToicQNJDKDuB27F3Ag/132","nickname":"路人甲","note":"","ucode":"D6247E2F110FC7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":182722,"discussion_content":"我觉得他的意思是先取出这范围内的所有id，然后根据[y1,y3]（区间内是连续的整数）这个区间中，y1（第一个值），y2，y3（最后一个值）所在的位置拿到剩下的y2","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582451926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":160642,"ip_address":""},"score":182722,"extra":""},{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1212009,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLyfaTNuvbkicpu3mTujhbQ2Xr6KSbfNJrukFv1gSmtdicxTNgN61M2ibxZdQpRToicQNJDKDuB27F3Ag/132","nickname":"路人甲","note":"","ucode":"D6247E2F110FC7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298397,"discussion_content":"区间内不一定是连续的，但y2可以通过y2-y1拿到","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1597289136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":182722,"ip_address":""},"score":298397,"extra":""}]},{"author":{"id":1541014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","nickname":"天亮前说晚安","note":"","ucode":"1D82EE562A7C71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":135167,"discussion_content":"第一条语句可以id>Y1,这样扫描就是：C+Ymax-Ymin+3了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1579074847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1446494,"avatar":"https://static001.geekbang.org/account/avatar/00/16/12/5e/77b67a85.jpg","nickname":"飘云","note":"","ucode":"C6FE0310D6853C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":563093,"discussion_content":"select * from t where id in (id1, id2, id3) 这条语句不是扫描三行吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649939600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2873959,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/da/67/e18b690e.jpg","nickname":"神经蛙","note":"","ucode":"E0CE74B2363E10","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":541444,"discussion_content":" “select id from t limit Ymin，(Ymax - Ymin)；” 通过 3 个随机数得到 id 的范围集合，第一个元素是 Ymin 的 id，最后一个是 Ymax 的 id，第 y2-Ymin 个元素是 y2 的 id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640362944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333987,"discussion_content":"厉害，这么好滴算法只恨自己想不出来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607685022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1702547,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eruzEDjGnUFZz8ehoKKwy1IZKsPQ9ANkcZt0QMk1Uxuvx5FVlAYoiaaKoaKia99ticTib5sUkxsPduD4A/132","nickname":"GEEKBANG_7745681","note":"","ucode":"9668855F627CFD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303293,"discussion_content":"为了解决部分问题可能带来更大的问题，不妥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599208551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1209431,"avatar":"https://static001.geekbang.org/account/avatar/00/12/74/57/7b828263.jpg","nickname":"张sir","note":"","ucode":"52958DF6705208","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195889,"discussion_content":"但感觉有问题，如果计算Ymin和Ymax的Id不存在咋办，这样取出的数据就不足3条了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583320173,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1209431,"avatar":"https://static001.geekbang.org/account/avatar/00/12/74/57/7b828263.jpg","nickname":"张sir","note":"","ucode":"52958DF6705208","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298395,"discussion_content":"y1 y2 y3都是偏移量，与id分布无关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597288890,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":195889,"ip_address":""},"score":298395,"extra":""}]},{"author":{"id":1680305,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLcS8xEPSgUyy3Yicib9OvB2JXXMibWRQpFPxVzmonZeHDyD9X2nMZx3kEicdvWyIxoMictAkdcxrez57A/132","nickname":"the7th","note":"","ucode":"D1F910232C847D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":152873,"discussion_content":"我有个需求，请各位指点一二，如果有今天发布的文章先按今天的排序，再取余下的随机排序，如果没有今天发布的就随机排序，并且要分页.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580001769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1153928,"avatar":"https://static001.geekbang.org/account/avatar/00/11/9b/88/34c171f1.jpg","nickname":"herongwei","note":"","ucode":"E4158BF7AD2E70","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":121746,"discussion_content":"想问的是，得到 id 集后，如何算出 Y1、Y2、Y3 对应的三个 id 呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578322635,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1153928,"avatar":"https://static001.geekbang.org/account/avatar/00/11/9b/88/34c171f1.jpg","nickname":"herongwei","note":"","ucode":"E4158BF7AD2E70","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298402,"discussion_content":"集合的第一个元素是Ymin，最后一个是Ymax，剩下那比如是y2，就用y2-Ymin，在集合上通过偏移的到","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597289817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":121746,"ip_address":""},"score":298402,"extra":""}]}]},{"had_liked":false,"id":69041,"user_name":"大神仙","can_delete":false,"product_type":"c1","uid":1151944,"ip_address":"","ucode":"8179D170A97936","user_header":"https://static001.geekbang.org/account/avatar/00/11/93/c8/9eb6c644.jpg","comment_is_top":false,"comment_ctime":1550650466,"is_pvip":false,"replies":[{"id":"24485","content":"我的理解是说，<br>你碰到了这种情况：<br><br>limit  n, a; 显示a条记录；<br>然后 limit n+a, a显示第二组a条件记录；<br>这两组a个记录出现了重复数据对吧，<br><br>是的，是因为limit 有可能出现两种算法，比如直接排序和优先队列排序，就是不同的结果。<br>而limit 后面的参数，是会影响算法的","user_name":"作者回复","comment_id":69041,"uid":"1264162","ip_address":"","utype":1,"ctime":1550651724,"user_name_real":"林晓斌"}],"discussion_count":13,"race_medal":0,"score":"113219800162","product_id":100020801,"comment_content":"老师，limit n order by 非索引字段 进行分页查询。数据库符合条件的count=147000条，分页查询count也正确，但是分页查询出的147000条数据中存在重复数据。<br>1，这个我看网上解释是因为堆排序算法不稳定导致的。这个说法是否正确。<br>2，我查了很多资料，没找到，或者您能给我个指导，我去查查","like_count":26,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439928,"discussion_content":"我的理解是说，\n你碰到了这种情况：\n\nlimit  n, a; 显示a条记录；\n然后 limit n+a, a显示第二组a条件记录；\n这两组a个记录出现了重复数据对吧，\n\n是的，是因为limit 有可能出现两种算法，比如直接排序和优先队列排序，就是不同的结果。\n而limit 后面的参数，是会影响算法的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550651724,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1933794,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJjiaBHJyfAKK3lAdX62MveJHoPb4V6zE6jhPa3cjdBv7owc53aBHbNf3pibOsbciccSwichwiaR4m5nAQ/132","nickname":"Geek_82640c","note":"","ucode":"A69C2D502A27D0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332890,"discussion_content":"以前疑惑为啥limit在下一页会出现上一页的数据，原来是采用了堆排序和优先队列排序的算法导致","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1607387479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1475528,"avatar":"https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg","nickname":"maybe","note":"","ucode":"93D160F617E750","race_medal":4,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372420,"discussion_content":"堆排序不是稳定排序算法","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1620312484,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1054108,"avatar":"https://static001.geekbang.org/account/avatar/00/10/15/9c/310c902c.jpg","nickname":"e^x","note":"","ucode":"29B56E0DF4EF48","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1475528,"avatar":"https://static001.geekbang.org/account/avatar/00/16/83/c8/5ce842f6.jpg","nickname":"maybe","note":"","ucode":"93D160F617E750","race_medal":4,"user_type":1,"is_pvip":false},"discussion":{"id":530543,"discussion_content":"此话怎讲？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637082964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":372420,"ip_address":""},"score":530543,"extra":"{\"user_type\":1}"},{"author":{"id":2254917,"avatar":"https://static001.geekbang.org/account/avatar/00/22/68/45/ddf89612.jpg","nickname":"bestgopher","note":"","ucode":"D89735C8CA9C6E","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1054108,"avatar":"https://static001.geekbang.org/account/avatar/00/10/15/9c/310c902c.jpg","nickname":"e^x","note":"","ucode":"29B56E0DF4EF48","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551140,"discussion_content":"这不是基本理论吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644908708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":530543,"ip_address":""},"score":551140,"extra":""}]},{"author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306795,"discussion_content":"存在重复元素才会有这种情况？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600392090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1069103,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/2f/5992eb8f.jpg","nickname":"静悄悄的看","note":"","ucode":"D3602584911805","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553786,"discussion_content":"所以这样问题怎么避免呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646094002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1879290,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/ac/fa/a32099e7.jpg","nickname":"Curiosity","note":"","ucode":"A6732CAE6CBE8E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1069103,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/2f/5992eb8f.jpg","nickname":"静悄悄的看","note":"","ucode":"D3602584911805","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554250,"discussion_content":"使用或结合数据唯一的字段进行排序","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1646286066,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":553786,"ip_address":""},"score":554250,"extra":""}]},{"author":{"id":2448277,"avatar":"https://static001.geekbang.org/account/avatar/00/25/5b/95/462890c6.jpg","nickname":"叶涛","note":"","ucode":"B45348979BE159","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365759,"discussion_content":"这个的直接排序是指归并排序?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617876960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1589055,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKKKdCyib4iblXC6JIH7HWDfIFVweTb7SgEOuRjquic3GiaiaGInFSiaU8w2y2bjvZjgiaA3IEQuyibXTaeHQ/132","nickname":"10xiaohu","note":"","ucode":"CAB39DBB93E608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351227,"discussion_content":"嘿嘿嘿，看算法可好久了，忘了这两个算法的稳定性，完了回头再复习复习","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614181101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1757797,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d2/65/79d89c77.jpg","nickname":"小白白不白","note":"","ucode":"270EC3A197A8D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348079,"discussion_content":"还是有疑问，两种排序算法不都是比对完所有的数据吗？ 既然比对完了，那么应该不会重复值排序错乱的吧（比如设定为两种算法 都设定为 if（>=）else）？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612422887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1214347,"avatar":"https://static001.geekbang.org/account/avatar/00/12/87/8b/79c1203a.jpg","nickname":"拉上板车上高速","note":"","ucode":"3F948501BED87D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334627,"discussion_content":"之前需求开发时遇到这样的问题，测试一直说有问题，我一直在忽悠测试说是数据的问题。。。\n所以这样看来，如果需求开发遇到需要排序的，是不是也应该从业务侧考虑如何实现能消除这种排序不稳定造成的影响。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607922075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2037841,"avatar":"","nickname":"huan","note":"","ucode":"C98A40D3667336","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297205,"discussion_content":"排序算法的稳定性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596807845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66880,"user_name":"梦康","can_delete":false,"product_type":"c1","uid":1069512,"ip_address":"","ucode":"8935F3C329C58E","user_header":"https://static001.geekbang.org/account/avatar/00/10/51/c8/83852d5a.jpg","comment_is_top":false,"comment_ctime":1550034579,"is_pvip":false,"replies":[{"id":"25702","content":"帮你贴下你自己的答案哈 https:&#47;&#47;mengkang.net&#47;1338.html","user_name":"作者回复","comment_id":66880,"uid":"1264162","ip_address":"","utype":1,"ctime":1551377787,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"96039315091","product_id":100020801,"comment_content":"翻了下评论，没人问优先队列排序里的 row_size 和 rows_estimate 是如何计算的。想了半天没想明白。","like_count":22,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438957,"discussion_content":"帮你贴下你自己的答案哈 https://mengkang.net/1338.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551377787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1168686,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d5/2e/7ace1d94.jpg","nickname":"wallacefw","note":"","ucode":"9EC56A542D9927","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":576206,"discussion_content":"连接已经没有了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655350906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":438957,"ip_address":""},"score":576206,"extra":""}]},{"author":{"id":1005713,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/58/91/3a2822f0.jpg","nickname":"trymorewang","note":"","ucode":"5804857F5B8B2E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384655,"discussion_content":"真顶啊 哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626690447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52201,"user_name":"王飞洋","can_delete":false,"product_type":"c1","uid":1049345,"ip_address":"","ucode":"8FE8FE8C8CD4F1","user_header":"https://static001.geekbang.org/account/avatar/00/10/03/01/62b32acf.jpg","comment_is_top":false,"comment_ctime":1545350744,"is_pvip":false,"replies":[{"id":"19021","content":"要说算法还是隔壁王老师讲的专业，这里咱们就只追求MySQL 里面用到的，能给大家讲明白就行了😄","user_name":"作者回复","comment_id":52201,"uid":"1264162","ip_address":"","utype":1,"ctime":1545364755,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"96034631256","product_id":100020801,"comment_content":"归并排序，优先队列，算法无处不在。","like_count":22,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433779,"discussion_content":"要说算法还是隔壁王老师讲的专业，这里咱们就只追求MySQL 里面用到的，能给大家讲明白就行了😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545364755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1834181,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/fc/c5/ff8b770e.jpg","nickname":"BugBean","note":"","ucode":"B51232281AD9BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":263074,"discussion_content":"算法还是隔壁老王专业哈哈","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1589169461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1314724,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0f/a4/0b49469f.jpg","nickname":"木子00","note":"","ucode":"8F78CA722EB29B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307176,"discussion_content":"老王。哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600521974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52199,"user_name":"慧鑫coming","can_delete":false,"product_type":"c1","uid":1324385,"ip_address":"","ucode":"7BAC9CA255630E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLE4LYb3jrH63ZV98Zpc8DompwDgb1O3nffMoZCmiaibauRyEFv6NDNsST9RWxZExvMLMWb50zaanoQ/132","comment_is_top":false,"comment_ctime":1545350669,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"91739663885","product_id":100020801,"comment_content":"又到周五了，开心😜","like_count":21},{"had_liked":false,"id":52964,"user_name":"freesia","can_delete":false,"product_type":"c1","uid":1207824,"ip_address":"","ucode":"FC37B0B796958E","user_header":"https://static001.geekbang.org/account/avatar/00/12/6e/10/05f19719.jpg","comment_is_top":false,"comment_ctime":1545559052,"is_pvip":false,"replies":[{"id":"19209","content":"嗯嗯，MySQL 的代码和业务代码都是代码😄 配合起来用","user_name":"作者回复","comment_id":52964,"uid":"1264162","ip_address":"","utype":1,"ctime":1545574399,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"74560003084","product_id":100020801,"comment_content":"从上一讲到这一讲，我发现老师在处理问题时，提出的方法就不再是单纯依靠MySQL解决，因为可能会耗费很多资源，而是把问题分担一部分到客户端，比如客户端拿到数据后再排序，或者客户端产生随机数再到MySQL中去查询。","like_count":17,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434006,"discussion_content":"嗯嗯，MySQL 的代码和业务代码都是代码😄 配合起来用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545574399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2369545,"avatar":"https://static001.geekbang.org/account/avatar/00/24/28/09/0ac42cff.jpg","nickname":"慕苏","note":"","ucode":"7ED14D00429C21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336545,"discussion_content":"阔以阔以，mysql只是存储数据用的\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608623335,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55163,"user_name":"Mr.Strive.Z.H.L","can_delete":false,"product_type":"c1","uid":1030198,"ip_address":"","ucode":"6D97E159E2EECD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg","comment_is_top":false,"comment_ctime":1546053668,"is_pvip":false,"replies":[{"id":"20038","content":"mysql的执行过程都是由执行器来调度的<br><br>不论创建memory临时表还是innodb临时表，都是执行器调用引擎的创建表接口实现的<br><br>写数据和读数据也是<br><br>排序这个操作，是在server层做的","user_name":"作者回复","comment_id":55163,"uid":"1264162","ip_address":"","utype":1,"ctime":1546135206,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"70265530404","product_id":100020801,"comment_content":"老师你好，回顾这篇的时候突然有个疑惑。<br>执行器只是调引擎接口获取结果，但是我认为order by的排序过程应该是在执行器执行的吧？内存临时表使用的memory引擎，应该也是在server端，而磁盘临时表应该是innodb内部。<br>我这么理解对吗？还是说整个排序过程全部都在innodb内部执行？<br>对此突然有点疑惑………","like_count":16,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434687,"discussion_content":"mysql的执行过程都是由执行器来调度的\n\n不论创建memory临时表还是innodb临时表，都是执行器调用引擎的创建表接口实现的\n\n写数据和读数据也是\n\n排序这个操作，是在server层做的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546135206,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52486,"user_name":"李皮皮皮皮皮","can_delete":false,"product_type":"c1","uid":1200281,"ip_address":"","ucode":"3BF1DEE4A12359","user_header":"https://static001.geekbang.org/account/avatar/00/12/50/99/44378317.jpg","comment_is_top":false,"comment_ctime":1545393719,"is_pvip":false,"replies":[{"id":"19100","content":"开两个窗口，按顺序执行命令哦","user_name":"作者回复","comment_id":52486,"uid":"1264162","ip_address":"","utype":1,"ctime":1545396564,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"53085001271","product_id":100020801,"comment_content":"我经常在文中看到多个事务的执行时序。线下做实验的时候，是怎么保证能按这个时序执行呢？","like_count":13,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433893,"discussion_content":"开两个窗口，按顺序执行命令哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545396564,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66814,"user_name":"Sinyo","can_delete":false,"product_type":"c1","uid":1307297,"ip_address":"","ucode":"57B243E7AB86A5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAibnPX9jW8kqLcIfibjic8GbkQkEUYyFKJkc39hZhibVlNrqwTjdLozkqibI2IwACd5YzofYickNxFnZg/132","comment_is_top":false,"comment_ctime":1550024637,"is_pvip":false,"replies":[{"id":"23671","content":"没有少0哈<br><br>好问题<br><br>最小堆的维护代价比数组大，不只是14*1000哦","user_name":"作者回复","comment_id":66814,"uid":"1264162","ip_address":"","utype":1,"ctime":1550047676,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"40204730301","product_id":100020801,"comment_content":"你可能会问，这里也用到了 limit，为什么没用优先队列排序算法呢？原因是，这条 SQL 语句是 limit 1000，如果使用优先队列算法的话，需要维护的堆的大小就是 1000 行的 (name,rowid)，超过了我设置的 sort_buffer_size 大小，所以只能使用归并排序算法。<br><br>老师，上面的limit 1000 不是才14000么？14000小于32768的还是优先队列排序算法把？这里是不是10000少写了个0呢？","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438925,"discussion_content":"没有少0哈\n\n好问题\n\n最小堆的维护代价比数组大，不只是14*1000哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550047676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298433,"discussion_content":"刚好有同样的问题要问，太好啦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597297972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62268,"user_name":"胡楚坚","can_delete":false,"product_type":"c1","uid":1120212,"ip_address":"","ucode":"225883EDF35BED","user_header":"https://static001.geekbang.org/account/avatar/00/11/17/d4/d7a4e6f5.jpg","comment_is_top":false,"comment_ctime":1547998840,"is_pvip":false,"replies":[{"id":"22033","content":"前提是有limit 子句哈","user_name":"作者回复","comment_id":62268,"uid":"1264162","ip_address":"","utype":1,"ctime":1548040169,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"40202704504","product_id":100020801,"comment_content":"老师，只要sort buffer 足够，就采用优先队列排序，而不用管到底是全字段排序还是rowid排序，对吗？","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437152,"discussion_content":"前提是有limit 子句哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548040169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52468,"user_name":"无眠","can_delete":false,"product_type":"c1","uid":1123870,"ip_address":"","ucode":"FBFA936A884EAA","user_header":"https://static001.geekbang.org/account/avatar/00/11/26/1e/adc166df.jpg","comment_is_top":false,"comment_ctime":1545388142,"is_pvip":false,"replies":[{"id":"19103","content":"查询需要临时表，比如我们这个例子里，需要临时表来放rand()结果","user_name":"作者回复","comment_id":52468,"uid":"1264162","ip_address":"","utype":1,"ctime":1545397373,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"40200093806","product_id":100020801,"comment_content":"一直比较疑惑什么情况下会产生临时表Using temporary，希望老师指点下","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433888,"discussion_content":"查询需要临时表，比如我们这个例子里，需要临时表来放rand()结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545397373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373362,"discussion_content":"需要存放中间结果的就需要临时表吧，内存临时表放不下就用磁盘临时表存放。在这里的临时文件是sort buffer存放不下需要排序的数据了，就需要磁盘临时文件辅助排序","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1620705977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307865,"discussion_content":"如果没有rand()函数、并且参与排序的数据量比较大的情况下(内存临时表存不下的时候)，是不是就不需要临时表了？\n直接使用临时文件就可以了？\n临时表和临时文件之间是什么关系？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600776444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53636,"user_name":"高枕","can_delete":false,"product_type":"c1","uid":1310312,"ip_address":"","ucode":"20F6CF75EC9AA4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/68/e0bebd9a.jpg","comment_is_top":false,"comment_ctime":1545703048,"is_pvip":false,"replies":[{"id":"19495","content":"排序内存设大点😄 ","user_name":"作者回复","comment_id":53636,"uid":"1264162","ip_address":"","utype":1,"ctime":1545715646,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"35905441416","product_id":100020801,"comment_content":"老师，怎样让mysql使用优先队列排序法而不使用归并排序算法呢？","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434210,"discussion_content":"排序内存设大点😄 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545715646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376408,"discussion_content":"排序内存搞大点，并且使用 limit 限制结果数量","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1622112026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65213,"user_name":"奋斗心","can_delete":false,"product_type":"c1","uid":1247286,"ip_address":"","ucode":"06A195AB0B6570","user_header":"https://static001.geekbang.org/account/avatar/00/13/08/36/98be3d69.jpg","comment_is_top":false,"comment_ctime":1549113742,"is_pvip":false,"replies":[{"id":"23128","content":"第一个10000是扫描原表，第二个10000是扫描内存表；<br><br>排序过程本身是不增加扫描行数的<br><br>","user_name":"作者回复","comment_id":65213,"uid":"1264162","ip_address":"","utype":1,"ctime":1549156529,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"31613884814","product_id":100020801,"comment_content":"20000行是指：扫描10000行到内存临时表，还有10000行是随机排序吗","like_count":7,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438362,"discussion_content":"第一个10000是扫描原表，第二个10000是扫描内存表；\n\n排序过程本身是不增加扫描行数的\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549156529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79568,"user_name":"big-new","can_delete":false,"product_type":"c1","uid":1343129,"ip_address":"","ucode":"5BFDEC5A641959","user_header":"https://static001.geekbang.org/account/avatar/00/14/7e/99/2d064061.jpg","comment_is_top":false,"comment_ctime":1553508528,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"27323312304","product_id":100020801,"comment_content":"您好，老师？请问全字段排序、rowid排序  与  临时文件算法（归并排序算法）、优先队列排序算法的  作用点分别在哪里？赶紧这两种概念分不清楚了。麻烦帮忙解答下疑惑~，谢谢？","like_count":6,"discussions":[{"author":{"id":1022507,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOpANMwDibLmj5IGJh6dTw300sZ1BHM5sG3sZv1A1rvCHOiblPD3jgFOiaMVVujtctWnQbVFoNPpRgw/132","nickname":"alioo","note":"","ucode":"F36A38C1F5FFAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":46492,"discussion_content":"当sql中有order by要求排序，而此时没有合适的索引可以避免排序的话，则只能选择一种排序方式（要么全字段排序，要么rowid排序），另外排序时需要空间来搞的（要么使用内存临时表，要么使用文件临时表）。当sql中除了有order by X还有limit Y时，说明排序后的结果取前Y就够了，那么在选择排序算法（要么是归并排序，要么是优先队列）上会选择优先队列算法","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1573175374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1290245,"avatar":"https://static001.geekbang.org/account/avatar/00/13/b0/05/48e3f940.jpg","nickname":"无心","note":"","ucode":"2AD84413DB4A72","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1022507,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOpANMwDibLmj5IGJh6dTw300sZ1BHM5sG3sZv1A1rvCHOiblPD3jgFOiaMVVujtctWnQbVFoNPpRgw/132","nickname":"alioo","note":"","ucode":"F36A38C1F5FFAB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":115825,"discussion_content":"有个疑问，排序一定会用到临时表吗？因为我看Using temporary和Using filesort是两个选项，有没有只使用临时文件来存放数据结构，不创建临时表的情况？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578038231,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":46492,"ip_address":""},"score":115825,"extra":""},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1290245,"avatar":"https://static001.geekbang.org/account/avatar/00/13/b0/05/48e3f940.jpg","nickname":"无心","note":"","ucode":"2AD84413DB4A72","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159811,"discussion_content":"排序不一定会用到临时表，上面说了，如果排序时还需要另外的空间来搞的，就需要临时表了。如果能用全字段或rowid排序算法搞定的话，那就不用临时表了。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1580735240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":115825,"ip_address":""},"score":159811,"extra":""},{"author":{"id":2497728,"avatar":"https://static001.geekbang.org/account/avatar/00/26/1c/c0/b8ff566a.jpg","nickname":"我是大橙子132","note":"","ucode":"61660568CF07C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1022507,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOpANMwDibLmj5IGJh6dTw300sZ1BHM5sG3sZv1A1rvCHOiblPD3jgFOiaMVVujtctWnQbVFoNPpRgw/132","nickname":"alioo","note":"","ucode":"F36A38C1F5FFAB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560480,"discussion_content":"排序的空间是sortbuffer，内存/磁盘临时表是因为rand（）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649343398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":46492,"ip_address":""},"score":560480,"extra":""}]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308065,"discussion_content":"全字段排序、rowid排序这些是属于排序算法还是属于排序方式？我认为这是排序方式，不知道这个理解对不对。\n\n临时文件(归并排序)、优先队列排序这两个应该是属于排序算法吧？\n\n在排序的时候，是先把数据放入sort buffer中，还是是先判断一下待排序的数据大小是否超过了sort buffer的限制，然后再决定是在sort buffer中排序还是使用临时文件排序？\n\n是否需要临时表这个判断，是在哪个阶段进行判断的？\n现在感觉整个排序过程好乱。没有一个完整的脉络。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1600834653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53063,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1545577356,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27315381132","product_id":100020801,"comment_content":"今天这个问题我的理解转换成sql是:<br>mysql&gt; select count(*) into @C from t1;<br>set @Y = floor(@C * rand());<br>set @Y1 = floor(@C * rand());<br>set @Y2 = floor(@C * rand());<br>select LEAST(@Y,@Y1,@Y2) into @Y4;<br>select GREATEST(@Y,@Y1,@Y2) into @Y6;<br>select floor((@Y6+@Y4)&#47;2) into @Y5;<br>set @sql = concat(&quot;select id into @id from t1 limit &quot;, @Y4, &quot;,1&quot;);<br>set @sql1 = concat(&quot;select id into @id1 from t1 where id&gt;@id limit &quot;, @Y5-@Y4, &quot;,1&quot;);<br>set @sql2 = concat(&quot;select id into @id2 from t1 where id&gt;@id1 limit &quot;, @Y6-@Y5, &quot;,1&quot;);<br>prepare stmt from @sql;<br>prepare stmt1 from @sql1;<br>prepare stmt2 from @sql2;<br>execute stmt;<br>execute stmt1;<br>execute stmt2;<br>DEALLOCATE prepare stmt;<br>DEALLOCATE prepare stmt1;<br>DEALLOCATE prepare stmt2;<br>select * from t1 where id in (@id,@id1,@id2);<br>感觉mysql不太适合处理随机数的问题,稍稍有点复杂。<br>不过这两节课收获很多,对order by排序理解又深入不少,原来堆排序是放limit m,m行如果比sort_buffer占用空间小,则先把m行放进数据集里,然后在把表里的数据一行一行取出来做比较。得出的结果,在根据MRR回表取数据。<br>老师,我有一个问题:<br>堆排序,如果比较的值是相等的情况下,会不会替换在sort_buffer里？我感觉是不会,如果不会才能解释得通排序值相等,id不等的情况,不管是大顶堆还是小顶堆,得到的结果集都是id相对更小的","like_count":6},{"had_liked":false,"id":52291,"user_name":"老杨同志","can_delete":false,"product_type":"c1","uid":1246199,"ip_address":"","ucode":"3F334F0CFD3DE6","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg","comment_is_top":false,"comment_ctime":1545359401,"is_pvip":false,"replies":[{"id":"19013","content":"不能，需要从头再来","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545362448,"ip_address":"","comment_id":52291,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23020195881","product_id":100020801,"comment_content":"对应order by 还有个疑问，如果 我第一次执行 select * from a limit 0,100  紧接着执行select * from a limit 100,200 能使用第一次执行的结果吗？如果表没有发送变化的时候可以吗","like_count":6,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433823,"discussion_content":"不能，需要从头再来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545362448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241424,"user_name":"moonfox","can_delete":false,"product_type":"c1","uid":1526355,"ip_address":"","ucode":"902BFF40EFA9FA","user_header":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","comment_is_top":false,"comment_ctime":1597290209,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18777159393","product_id":100020801,"comment_content":"请问下，既然可以放入内存的临时表，为什么不直接在sort_buffer中进行呢？还有我在慢查询日志里，显示扫描的行数是10003，而不是20003","like_count":4,"discussions":[{"author":{"id":1441589,"avatar":"https://static001.geekbang.org/account/avatar/00/15/ff/35/b744c027.jpg","nickname":"惜昔","note":"","ucode":"B3478E40B612FC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308934,"discussion_content":"我也有同样疑惑","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601126226,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64782,"user_name":"阿狸爱JAVA","can_delete":false,"product_type":"c1","uid":1033566,"ip_address":"","ucode":"597971781B1500","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c5/5e/24cc5a72.jpg","comment_is_top":false,"comment_ctime":1548907286,"is_pvip":false,"replies":[{"id":"22935","content":"加油慢慢来哈~~😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548922654,"ip_address":"","comment_id":64782,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18728776470","product_id":100020801,"comment_content":"感觉老师的思路很宽广，就像一个大宝藏，方案一不行还有方案二，方案二不行还有方案三，并且每个方案都能给出具体的性能比较与证据，而自己自能顺着老师的思路还能明白，可是一旦扩展开来，便大脑一片空白","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438176,"discussion_content":"加油慢慢来哈~~😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548922654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52419,"user_name":"鲸鱼","can_delete":false,"product_type":"c1","uid":1020655,"ip_address":"","ucode":"2231296F71166E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/ef/ba3f7260.jpg","comment_is_top":false,"comment_ctime":1545378970,"is_pvip":false,"replies":[{"id":"19108","content":"把innodb_flush_at_trx_commit设置成2，sync_binlog设置成1000看看","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545398333,"ip_address":"","comment_id":52419,"utype":1}],"discussion_count":3,"race_medal":0,"score":"18725248154","product_id":100020801,"comment_content":"运行老师给的存储过程特别慢，怎么排查原因呢，mysql版本是8.0.13","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433868,"discussion_content":"把innodb_flush_at_trx_commit设置成2，sync_binlog设置成1000看看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545398333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1487346,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b1/f2/3bcc1fad.jpg","nickname":"Caesar Yang","note":"","ucode":"359561CC3B04B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7036,"discussion_content":"修改存储过程  在循环之前开启事务  在循环结束提交事务  将多事务改成单个事务  执行就会很快","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1567306128,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1640757,"avatar":"https://static001.geekbang.org/account/avatar/00/19/09/35/7d2ced23.jpg","nickname":"样儿","note":"","ucode":"AB01047991559C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":71889,"discussion_content":"我的是8.0.15，是1也挺快的。。不知道为什么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575463890,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62011,"user_name":"杰之7","can_delete":false,"product_type":"c1","uid":1297232,"ip_address":"","ucode":"F7DA2E21085332","user_header":"https://static001.geekbang.org/account/avatar/00/13/cb/50/66d0bd7f.jpg","comment_is_top":false,"comment_ctime":1547880598,"is_pvip":false,"replies":[{"id":"21960","content":"是的，数据结构和算法在数据库里面是很重要的，因为用数据库的时候，我们测完功能，下一步就是测试性能。<br>性能好不好，全靠算法支撑^_^","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547894892,"ip_address":"","comment_id":62011,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14432782486","product_id":100020801,"comment_content":"通过这一节的阅读，老师讲述了一个APP页面随机三个单词的SQL排序问题及背后的原理。<br><br>在使用Order by rand()排序的时候，使用的是临时内存表，用的是Rowid的排序方法。另外一种是磁盘临时表，用的是优先排序算法。最后在介绍了随机排序算法。<br><br>目前，我没有学过计算机数据结构，应该对今天老师讲述的算法结构有些陌生，但我知道如果随机产生的数执行很慢的话，数据库设计结构应该可以进行优化，也对数据库原理和数据结构能联系的如此紧密产生的好奇。<br>","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437069,"discussion_content":"是的，数据结构和算法在数据库里面是很重要的，因为用数据库的时候，我们测完功能，下一步就是测试性能。\n性能好不好，全靠算法支撑^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547894892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325726,"user_name":"InfoQ_小汤","can_delete":false,"product_type":"c1","uid":1739070,"ip_address":"","ucode":"E4C30DB7A9B54C","user_header":"https://static001.geekbang.org/account/avatar/00/1a/89/3e/0dd8e96b.jpg","comment_is_top":false,"comment_ctime":1639107392,"is_pvip":false,"replies":[{"id":"118292","content":"执行 limit a,b 的时候，会把a+b这么多数据全部读出来，然后丢掉前面a条，返回后面的b条，因此a很大的时候，性能会很差","user_name":"作者回复","user_name_real":"编辑","uid":"1264162","ctime":1639385060,"ip_address":"","comment_id":325726,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10229041984","product_id":100020801,"comment_content":"有个问题想问下老师 就是游标跟limit在大数据量分页的时候 性能怎么样？老师可以简单说说么","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538256,"discussion_content":"执行 limit a,b 的时候，会把a+b这么多数据全部读出来，然后丢掉前面a条，返回后面的b条，因此a很大的时候，性能会很差","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639385060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":88941,"user_name":"daydaynobug","can_delete":false,"product_type":"c1","uid":1336773,"ip_address":"","ucode":"C6923405EB62BA","user_header":"https://static001.geekbang.org/account/avatar/00/14/65/c5/97003360.jpg","comment_is_top":false,"comment_ctime":1556030154,"is_pvip":false,"replies":[{"id":"32650","content":"都在内存的话就用快排<br><br>需要用到文件的话，有用到合并排序","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1556850892,"ip_address":"","comment_id":88941,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10145964746","product_id":100020801,"comment_content":"老师，在sort_buffer中排序总是会使用快排吗，这个跟待排序的数据量有关系吗，会不会使用其他的排序算法啊","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":447955,"discussion_content":"都在内存的话就用快排\n\n需要用到文件的话，有用到合并排序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1556850892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79286,"user_name":"J Sun","can_delete":false,"product_type":"c1","uid":1003877,"ip_address":"","ucode":"18873D0F4EFD8F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/51/65/35f711a1.jpg","comment_is_top":false,"comment_ctime":1553424663,"is_pvip":false,"replies":[{"id":"30022","content":"不是，是系统线程里的临时内存，不是临时表","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1554432710,"ip_address":"","comment_id":79286,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10143359255","product_id":100020801,"comment_content":"sort buffer 是个什么鬼？是临时表吗？忘老师解答一下！","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444430,"discussion_content":"不是，是系统线程里的临时内存，不是临时表","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554432710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159918,"discussion_content":"看看16章","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580739453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79272,"user_name":"Jesson","can_delete":false,"product_type":"c1","uid":1212313,"ip_address":"","ucode":"EBADA87D9E5AE6","user_header":"https://static001.geekbang.org/account/avatar/00/12/7f/99/6a92ff95.jpg","comment_is_top":false,"comment_ctime":1553421238,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"10143355830","product_id":100020801,"comment_content":"Y1， Y2， Y3 可能相同！","like_count":2,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159825,"discussion_content":"机率很小。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580735883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64196,"user_name":"linqw","can_delete":false,"product_type":"c1","uid":1134138,"ip_address":"","ucode":"09DCFE98C54DD8","user_header":"https://static001.geekbang.org/account/avatar/00/11/4e/3a/86196508.jpg","comment_is_top":false,"comment_ctime":1548692698,"is_pvip":false,"replies":[{"id":"22959","content":"2. 后面有一篇专门讲临时表的哈<br>3. 6个字节属于中规中矩，总是要选一个长度，max和min，默认是会走索引的<br>4. 这个就是rowid排序和全字段排序的区别。都有可能会选的，看单行大小<br>5. 看到现象带着问题gdb 效果不错（就是比较枯燥）","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548941212,"ip_address":"","comment_id":64196,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10138627290","product_id":100020801,"comment_content":"看了两篇的排序，想大致写下自己的理解，老师帮忙看下哦<br>1、order by内部会使用归并排序，根据sort buffer size决定是否需要使用外部（磁盘）排序，根据max_length_for_sort_data决定使用全字段排序还是rowid排序，不同点是rowid排序，只使用排序字段和主键，会在原有的基础上，多进行回表查询，多了磁盘操作，为此可以使用复合查询，这样从索引中查询出来的数据，就是有序的，可以直接进行回表，返回result，也可以考虑是否使用覆盖索引，直接返回值，如果order by后面加上limit num，num是小值，在5.6以上会使用优先队列进行排序。<br>2、随机排序，由于随机排序会使用临时表，根据tmp_table_size来判断临时表是否是内存临时表，如果使用的是内存临时表，使用memory引擎，由于其memory不是采用b+树结构，采用有序集合么？内部会将其要查询出来的值，换算其类似数组的下标和排序的字段，存放在sort_buffer中？好奇一点如果要查询出来的字段是不单单是word，而是更多的字段，内部也会计算出类似数组的下标么？内部采用的是hash么？还是其他算法，存放在sort buffer中后，会和1点一样，根据其sort buffer size和max length进行决定，如果使用的临时表是磁盘，默认innodb，为此临时表会存放rowid，word，random？再根据sort buffer size来决定是使用rowid还是全字段排序。<br>3、有点不太理解rowid默认6个字节，是为了防止表过大么？还有max(主键)和min，不会走索引，内部逻辑是？<br>4、对第16章文章课后问题答案的疑问，我们分开取，在归并排序，本来是mysql要是内部sort buffer size够大，也是使用归并排序，我们再取出数据再用外部排序是为了防止sort buffer size不够的磁盘排序么？感觉city和name字段实际的字段长度应该也不会很大，是否可以考虑在维护一个（name，city）的复合索引么？<br>5、老师，在看mysql源码是有啥比较好的建议么？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437902,"discussion_content":"2. 后面有一篇专门讲临时表的哈\n3. 6个字节属于中规中矩，总是要选一个长度，max和min，默认是会走索引的\n4. 这个就是rowid排序和全字段排序的区别。都有可能会选的，看单行大小\n5. 看到现象带着问题gdb 效果不错（就是比较枯燥）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548941212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54478,"user_name":"Mr.Strive.Z.H.L","can_delete":false,"product_type":"c1","uid":1030198,"ip_address":"","ucode":"6D97E159E2EECD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg","comment_is_top":false,"comment_ctime":1545879036,"is_pvip":false,"replies":[{"id":"19801","content":"子查询不一定会需要临时表，你要看explain的结果哈<br><br>如果需要临时表，还要再看临时表大小，小的用memory引擎，大的用innodb ","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545903906,"ip_address":"","comment_id":54478,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10135813628","product_id":100020801,"comment_content":"老师您好，这篇的order by rand()用到了临时表。<br>那么嵌套的sql语句：<br>select * from (select * from t1 where ...) t2 where .....<br>括号内部查询出的结果集是不是也会以 临时表的形式 存在？?如果是的话，那么这个临时表是不是也存储在innodb内部呀，等待事务结束后再清空？？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434468,"discussion_content":"子查询不一定会需要临时表，你要看explain的结果哈\n\n如果需要临时表，还要再看临时表大小，小的用memory引擎，大的用innodb ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545903906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52648,"user_name":"路过","can_delete":false,"product_type":"c1","uid":1316401,"ip_address":"","ucode":"7152C19ED024CC","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/31/ae8adf82.jpg","comment_is_top":false,"comment_ctime":1545466259,"is_pvip":false,"replies":[{"id":"19171","content":"确实没地方看😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545489868,"ip_address":"","comment_id":52648,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10135400851","product_id":100020801,"comment_content":"老师，我为快速执行存储过程。把参数位置为：<br>innodb_flush_log_at_trx_commit=2<br>sync_binlog=0<br>执行马上就结束了。否则要等很久。请教老师，上面修改后，数据和log还没有真正刷到磁盘。请问我在哪里可以看到相关的信息。<br>使用show engine innodb status\\G 看到：<br>0 pending log flushes, 0 pending chkp writes<br>20197 log i&#47;o&#39;s done, 0.00 log i&#47;o&#39;s&#47;second<br>谢谢！","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433937,"discussion_content":"确实没地方看😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545489868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1442290,"avatar":"https://static001.geekbang.org/account/avatar/00/16/01/f2/ad48e316.jpg","nickname":"邱海涛","note":"","ucode":"87285FC6CE4566","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6366,"discussion_content":"看OS的脏页刷盘情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566870862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52450,"user_name":"银太","can_delete":false,"product_type":"c1","uid":1051765,"ip_address":"","ucode":"B505D15F7CB839","user_header":"https://static001.geekbang.org/account/avatar/00/10/0c/75/e7c6c403.jpg","comment_is_top":false,"comment_ctime":1545384349,"is_pvip":false,"replies":[{"id":"19128","content":"你一个事务里面是不是不止一个这样的update 语句?","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545401702,"ip_address":"","comment_id":52450,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10135318941","product_id":100020801,"comment_content":"请教下老师：<br>表A有sku和warehouse两个字段组成的唯一索引,udx_sku_warehouse，高并发下容易死锁<br>执行的语句：update A set quantity=quantity+1 where sku=xx and warehouse=xx<br>查看死锁的日志：两个事务都在等待udx_sku_warehouse的X锁，但两个事务修改的并不是同一条记录，不是很明白，可以讲解一下吗？多谢<br>*** (1) TRANSACTION:<br>TRANSACTION 466841895, ACTIVE 0.021 sec starting index read<br>mysql tables in use 1, locked 1<br>LOCK WAIT 11 lock struct(s), heap size 2936, 9 row lock(s), undo log entries 11<br>LOCK BLOCKING MySQL thread id: 1927379 block 1895984<br>MySQL thread id 1895984, OS thread handle 0x2b2ffed85700, query id 783954740 10.27.8.222 oms updating<br>UPDATE oms_stock<br>    SET quantity = quantity + -1<br>    WHERE sku_id = 13978218638755841<br>      AND virtual_warehouse_id = 13867758969455616<br>*** (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 297 page no 89 n bits 424 index `udx_sku_id_warehouse_id` of table `oms_biz`.`oms_stock` trx id 466841895 lock_mode X locks rec but not gap waiting<br>Record lock, heap no 18 PHYSICAL RECORD: n_fields 3; compact format; info bits 0<br><br>*** (2) TRANSACTION:<br>TRANSACTION 466841901, ACTIVE 0.015 sec starting index read<br>mysql tables in use 1, locked 1<br>11 lock struct(s), heap size 2936, 8 row lock(s), undo log entries 9<br>MySQL thread id 1927379, OS thread handle 0x2b2f97440700, query id 783954758 10.27.8.222 oms updating<br>UPDATE oms_stock<br>    SET quantity = quantity + -1<br>    WHERE sku_id = 1809040003028<br>      AND virtual_warehouse_id = 13867758969455616<br>*** (2) HOLDS THE LOCK(S):<br>RECORD LOCKS space id 297 page no 89 n bits 424 index `udx_sku_id_warehouse_id` of table `oms_biz`.`oms_stock` trx id 466841901 lock_mode X locks rec but not gap<br>Record lock, heap no 18 PHYSICAL RECORD: n_fields 3; compact format; info bits 0<br><br>*** (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 297 page no 74 n bits 400 index `udx_sku_id_warehouse_id` of table `oms_biz`.`oms_stock` trx id 466841901 lock_mode X locks rec but not gap waiting<br>Record lock, heap no 12 PHYSICAL RECORD: n_fields 3; compact format; info bits 0","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433881,"discussion_content":"你一个事务里面是不是不止一个这样的update 语句?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545401702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52313,"user_name":"董航","can_delete":false,"product_type":"c1","uid":1231787,"ip_address":"","ucode":"9CA208FD26F849","user_header":"https://static001.geekbang.org/account/avatar/00/12/cb/ab/1aac53bf.jpg","comment_is_top":false,"comment_ctime":1545361557,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10135296149","product_id":100020801,"comment_content":"堆结构，大顶树，小顶树！！！","like_count":2},{"had_liked":false,"id":326431,"user_name":"大口吃肉喝酒","can_delete":false,"product_type":"c1","uid":2132654,"ip_address":"","ucode":"E429EAD5262AC9","user_header":"https://static001.geekbang.org/account/avatar/00/20/8a/ae/2edc03e9.jpg","comment_is_top":false,"comment_ctime":1639529703,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5934496999","product_id":100020801,"comment_content":"我对order by排序流程有点点疑问❓<br>1、我们所有word记录都会在临时内存表生成一个概率值，存储在临时表R字段里面，并在内存临时表中按照R排序，那为什么还要在sort buffer中在排序呢，相当于排序了两次？","like_count":1},{"had_liked":false,"id":298028,"user_name":"8.13.3.27.30","can_delete":false,"product_type":"c1","uid":1556358,"ip_address":"","ucode":"2DE3CE3E338BAB","user_header":"https://static001.geekbang.org/account/avatar/00/17/bf/86/c0cb35f0.jpg","comment_is_top":false,"comment_ctime":1623893520,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5918860816","product_id":100020801,"comment_content":"上期的问题分2次查询的方案有个疑问：<br><br>一次查询只需要一次网络开销、二次查询需要2次网络开销，这个方案真的会更快吗？","like_count":1},{"had_liked":false,"id":289344,"user_name":"Steven","can_delete":false,"product_type":"c1","uid":1253652,"ip_address":"","ucode":"3FE64459842015","user_header":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","comment_is_top":false,"comment_ctime":1618985101,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5913952397","product_id":100020801,"comment_content":"【磁盘临时表】部分的例子，怎么知道是使用了【内存临时表】还是【磁盘临时表】？","like_count":1},{"had_liked":false,"id":229631,"user_name":"张俭","can_delete":false,"product_type":"c1","uid":1194527,"ip_address":"","ucode":"6A94534F11C4BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/3a/1f/5b8f0d71.jpg","comment_is_top":false,"comment_ctime":1593079058,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5888046354","product_id":100020801,"comment_content":"mysql8。0的测试结果是10003行了。","like_count":1},{"had_liked":false,"id":209130,"user_name":"杨","can_delete":false,"product_type":"c1","uid":1971269,"ip_address":"","ucode":"7EFEFE285975C6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oltLEqTrmHm2aJP99BK6tHu5h7hp4aj08wR5Wt6H31iadFduDAVvjYKmhQ2nvGbLV3lkVdiat2GRasgWXoJeTibUg/132","comment_is_top":false,"comment_ctime":1587514072,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5882481368","product_id":100020801,"comment_content":"大家都好厉害  我现在都只能理解你们说的   评论区大牛也好多","like_count":1},{"had_liked":false,"id":188376,"user_name":"spoofer","can_delete":false,"product_type":"c1","uid":1768852,"ip_address":"","ucode":"6723F64ACC3F27","user_header":"https://static001.geekbang.org/account/avatar/00/1a/fd/94/8704d2b0.jpg","comment_is_top":false,"comment_ctime":1584346166,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879313462","product_id":100020801,"comment_content":"现实场景下，这种需求的解决方式有很多种设计，而且使用数据库来做解决方案应该不是最优解。但用这个例子来做排序的学习是很赞的","like_count":1},{"had_liked":false,"id":156954,"user_name":"萝卜条","can_delete":false,"product_type":"c1","uid":1692713,"ip_address":"","ucode":"4BC975BBFE50A7","user_header":"https://static001.geekbang.org/account/avatar/00/19/d4/29/5f52a82c.jpg","comment_is_top":false,"comment_ctime":1575000323,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"5869967619","product_id":100020801,"comment_content":"mysql 8.0 <br>select word from words order by rand() limit 3;<br>Query_time: 0.008170  Lock_time: 0.000158 Rows_sent: 3  Rows_examined: 10003<br>只扫描了10003行。<br>请问是否8.0版本对内存临时表做了优化，之后sort_buffer对内存临时表的扫描不计入扫描行数","like_count":1,"discussions":[{"author":{"id":1284212,"avatar":"https://static001.geekbang.org/account/avatar/00/13/98/74/6edfe4c1.jpg","nickname":"icephobia","note":"","ucode":"CD383B35994331","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132357,"discussion_content":"你执行一下 SET max_length_for_sort_data = 16; 你的慢查询日志排序是用了全字段排序，所以是10003。改下参数以后走的是rowid排序就是20003了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1578900630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1603078,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/zAZv4NyuS21Y1qk45j8JiaoEYdA5Zgc1PqpJsBokz5bZVmdkf6kNWvT4cUAAKAdH6TgN52DWZhiaH6wNFhw14nRg/132","nickname":"Geek_4e4ec2","note":"","ucode":"6DAD5EE4FFB195","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1284212,"avatar":"https://static001.geekbang.org/account/avatar/00/13/98/74/6edfe4c1.jpg","nickname":"icephobia","note":"","ucode":"CD383B35994331","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536315,"discussion_content":"这个参数在8.0.20后已经过时了，设置不会有任何效果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638757229,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":132357,"ip_address":""},"score":536315,"extra":""}]},{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298421,"discussion_content":"我的也是，10003行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597295149,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111552,"user_name":"残天噬魂","can_delete":false,"product_type":"c1","uid":1506609,"ip_address":"","ucode":"A2AD8303A4518D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/q2HwchogzNiavKhIB4GfAxH6B88NhSoC7B7keVEUqiaP6JPokDUNJLYehocOyqYqrhA3iaxywyRXLYkYJjDUQESZw/132","comment_is_top":false,"comment_ctime":1562566091,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5857533387","product_id":100020801,"comment_content":"老师好，请教一下，order by rand()的流程分析中，最什么是两步排序，感觉第一步排序意义不大，只要有第二步就可以了？","like_count":1,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159904,"discussion_content":"再仔细琢磨一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580739260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53075,"user_name":"Sinyo","can_delete":false,"product_type":"c1","uid":1307297,"ip_address":"","ucode":"57B243E7AB86A5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAibnPX9jW8kqLcIfibjic8GbkQkEUYyFKJkc39hZhibVlNrqwTjdLozkqibI2IwACd5YzofYickNxFnZg/132","comment_is_top":false,"comment_ctime":1545579524,"is_pvip":false,"replies":[{"id":"19233","content":"原表的id字段本来就是主键哈<br><br>但是临时表还是需要的，因为需要一个表，表里有个字段来放随机数","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545592030,"ip_address":"","comment_id":53075,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840546820","product_id":100020801,"comment_content":"老师，如果还是用rand()排序，但图4 原表中的id字段是主键；<br>内存临时表的W字段是不是代替了sort_buffer中的POS字段，不会用到sort_buffer了呢？<br>还是加了id为主键就不会用到内存临时表了呢？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434028,"discussion_content":"原表的id字段本来就是主键哈\n\n但是临时表还是需要的，因为需要一个表，表里有个字段来放随机数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545592030,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52823,"user_name":"不二","can_delete":false,"product_type":"c1","uid":1140951,"ip_address":"","ucode":"1E1527C71FD9DB","user_header":"https://static001.geekbang.org/account/avatar/00/11/68/d7/714c3d89.jpg","comment_is_top":false,"comment_ctime":1545535721,"is_pvip":false,"replies":[{"id":"19197","content":"一个内存一个磁盘上<br>没有一摸一样呀，要加个rand()字段","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545538488,"ip_address":"","comment_id":52823,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840503017","product_id":100020801,"comment_content":"sort_buffer和临时文件区别是啥，临时文件既然跟数据表一模一样，为啥还要临时文件","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433989,"discussion_content":"一个内存一个磁盘上\n没有一摸一样呀，要加个rand()字段","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545538488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52662,"user_name":"发条橙子 。","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":false,"comment_ctime":1545469346,"is_pvip":false,"replies":[{"id":"19164","content":"Limit 100这个应该比较确定是有收益的，后面翻页越来越大以后，就需要看看了，多查一次其实关系不大，返回数据量如果太大是需要考虑的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545478556,"ip_address":"","comment_id":52662,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840436642","product_id":100020801,"comment_content":"这篇文章刷新了对上篇文章的认知 ， 原来是否使用内存排序还是外部排序不单单只是根据 内存参数的大小来决定 ， 还会根据返回的情况按照选择的算法来决定具体使用哪种排序 。<br><br>另外对上一篇的解答我只想到会排序 ， 老师扩展如何从业务上处理来避免排序的思想 ，也让我学到很多 。很多负责的或者执行比较慢的sql，可以通过业务上的逻辑调整来拆解这些sql 使其性能提高 。<br><br>但是这里有个小疑问 ： 虽然通过两次查询返回结果后进行归并排序处理可以避免mysql排序带来的性能损耗 。 但是这样处理由 一次查询请求变成了 两次查询请求 。多一次请求会多带来一些网络io之类的性能消耗 。这样整体看来是否反而更不划算<br><br><br>另外感谢 @某人 的回答 ，看了你的回答也学习到了很多 🙏","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433942,"discussion_content":"Limit 100这个应该比较确定是有收益的，后面翻页越来越大以后，就需要看看了，多查一次其实关系不大，返回数据量如果太大是需要考虑的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545478556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52635,"user_name":"似水流年","can_delete":false,"product_type":"c1","uid":1304443,"ip_address":"","ucode":"D114A8E273133C","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/7b/71da8283.jpg","comment_is_top":false,"comment_ctime":1545459658,"is_pvip":false,"replies":[{"id":"19161","content":"嗯，归并排序就是把两个有序的集合变成一个有序集合。<br><br>比如，你可以想一下，一个奇数数组1，3，5…99 ，另一个2，4，6… 100；<br>怎么样合成一个有序数组最快","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545469701,"ip_address":"","comment_id":52635,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840426954","product_id":100020801,"comment_content":"对于什么是归并排序还是不明白，这也算一种排序吧？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433929,"discussion_content":"嗯，归并排序就是把两个有序的集合变成一个有序集合。\n\n比如，你可以想一下，一个奇数数组1，3，5…99 ，另一个2，4，6… 100；\n怎么样合成一个有序数组最快","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545469701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52576,"user_name":"风动草","can_delete":false,"product_type":"c1","uid":1303051,"ip_address":"","ucode":"6ED975DC4DD0D0","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/0b/e3c8765a.jpg","comment_is_top":false,"comment_ctime":1545443125,"is_pvip":false,"replies":[{"id":"19157","content":"是的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545458845,"ip_address":"","comment_id":52576,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840410421","product_id":100020801,"comment_content":"老师好！您说的在建二级索引的过程中，是把主键取出来构造二级索引，而且要读全表，这个读全表意思是不是，读了主键，就意味着主键的叶子节点也一起读出来了？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433910,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545458845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52259,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545355428,"is_pvip":false,"replies":[{"id":"18998","content":"字节","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545361481,"ip_address":"","comment_id":52259,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840322724","product_id":100020801,"comment_content":"临时表设置参数单位是k还是m?","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433809,"discussion_content":"字节","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545361481,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52217,"user_name":"james.h.fu","can_delete":false,"product_type":"c1","uid":1330945,"ip_address":"","ucode":"B5773B8DCB1F7A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKib804LQiawZc7KHzerDF2B4zGvPByXKTVR1h6HibRlc8sQFAujIO3M02GicOg9Qia9ibBZlbmDyJcCKyQ/132","comment_is_top":false,"comment_ctime":1545352732,"is_pvip":false,"replies":[{"id":"19012","content":"还真不是，如果只有这个需求，单独搭一个redis就多了…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545362405,"ip_address":"","comment_id":52217,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840320028","product_id":100020801,"comment_content":"嗯，应该职责分离，让redis,es去做这类业务。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433787,"discussion_content":"还真不是，如果只有这个需求，单独搭一个redis就多了…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545362405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52202,"user_name":"泰格杨","can_delete":false,"product_type":"c1","uid":1182151,"ip_address":"","ucode":"DF23BD9D31B536","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/c7/861b4a70.jpg","comment_is_top":false,"comment_ctime":1545351096,"is_pvip":false,"replies":[{"id":"19006","content":"堆排序是一种叫法，代码里面写优先队列排序，我还是照直翻译😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545362050,"ip_address":"","comment_id":52202,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840318392","product_id":100020801,"comment_content":"一般不叫优先队列排序吧，叫堆排序吧。<br>count总数可以缓存，访问0。程序通过代码随机一个0到总数-100的位置记为p，然后limit p，100。在从100个里随机选择3个id，回表查数据。<br>扫描的行数为p+100+3。看3个字符随机的程度，100可以调整","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433780,"discussion_content":"堆排序是一种叫法，代码里面写优先队列排序，我还是照直翻译😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545362050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52196,"user_name":"峰","can_delete":false,"product_type":"c1","uid":1056019,"ip_address":"","ucode":"C53CB64E8E7D19","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg","comment_is_top":false,"comment_ctime":1545349758,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5840317054","product_id":100020801,"comment_content":"直接在解决方案一的基础上改成只取等于id（id=@x）的结果，如果取不到就再取直到取到为止。当然如果要取多条，就要业务端做去重，重复的话就再随机取一次。这个无疑适合的场景是id尽可能没有太大的空洞，limit的数据尽可能少。","like_count":1},{"had_liked":false,"id":355247,"user_name":"Geek_323a60","can_delete":false,"product_type":"c1","uid":2797976,"ip_address":"四川","ucode":"CDC276EC255411","user_header":"","comment_is_top":false,"comment_ctime":1661224039,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661224039","product_id":100020801,"comment_content":"1. 内存临时表和磁盘临时表存储的内容是一样的吗？使用磁盘临时表的场景仅仅是内存放不下临时表转而放入磁盘吗？<br>2. 在讲解内存临时表时主要针对的是  select word from words order by rand() limit 3; 进行分析的。我想问一下 select word from words order by word limit 3; 执行时内存临时表中的字段是什么样的呢？","like_count":0},{"had_liked":false,"id":355242,"user_name":"Geek_323a60","can_delete":false,"product_type":"c1","uid":2797976,"ip_address":"四川","ucode":"CDC276EC255411","user_header":"","comment_is_top":false,"comment_ctime":1661221925,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661221925","product_id":100020801,"comment_content":"磁盘临时表存储的内容应该和内存临时表一样的吧，只不过是内存放不下转而放入到磁盘中而已。可以这么理解吗？","like_count":0},{"had_liked":false,"id":355241,"user_name":"Geek_323a60","can_delete":false,"product_type":"c1","uid":2797976,"ip_address":"四川","ucode":"CDC276EC255411","user_header":"","comment_is_top":false,"comment_ctime":1661221869,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661221869","product_id":100020801,"comment_content":"磁盘临时表存储的内容应该和内存临时表一样的吧，只不过是内存放不下转而放入到磁盘中而已。可以这么理解吗？","like_count":0},{"had_liked":false,"id":354873,"user_name":"陈陶","can_delete":false,"product_type":"c1","uid":2786997,"ip_address":"上海","ucode":"B0B4A0A9FEC445","user_header":"https://static001.geekbang.org/account/avatar/00/2a/86/b5/6d91d231.jpg","comment_is_top":false,"comment_ctime":1660835060,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660835060","product_id":100020801,"comment_content":"用窗口函数over，就可以用where row = Y or =R...代替limit了。既不需要动态sql，也只需要遍历一遍而不是3遍。","like_count":0},{"had_liked":false,"id":353728,"user_name":"勿更改任何信息","can_delete":false,"product_type":"c1","uid":2028955,"ip_address":"北京","ucode":"B4949BEB8B2AFD","user_header":"","comment_is_top":false,"comment_ctime":1659701837,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1659701837","product_id":100020801,"comment_content":"感觉有些问题的解决方案非常不切合实际啊，比如这个问题：select * from t where city in (“杭州”,&quot; 苏州 &quot;) order by name limit 100;为了解决不排序问题，分别写成2个SQL再归并排序。<br>在实际场景中，怎么可能这样做啊。。。。希望举例合理些，不要脱离现实使用。","like_count":0},{"had_liked":false,"id":352264,"user_name":"Edgar Huang","can_delete":false,"product_type":"c1","uid":2709243,"ip_address":"","ucode":"9369D45C0C5A00","user_header":"https://static001.geekbang.org/account/avatar/00/29/56/fb/3342e017.jpg","comment_is_top":false,"comment_ctime":1658487829,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658487829","product_id":100020801,"comment_content":"请问一下，您画图都是用的什么软件呀","like_count":0},{"had_liked":false,"id":343322,"user_name":"卡卡","can_delete":false,"product_type":"c1","uid":1611484,"ip_address":"","ucode":"F0D6471CA06A6C","user_header":"https://static001.geekbang.org/account/avatar/00/18/96/dc/58ccf3f3.jpg","comment_is_top":false,"comment_ctime":1650780360,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650780360","product_id":100020801,"comment_content":"林老师，问你个问题，就是可重复度隔离级别已经解决了脏读、不可重复度、幻读问题，为什么还由串行化这个隔离级别？或者说串行化隔离级别的使用场景有哪些？","like_count":0},{"had_liked":false,"id":342553,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1650339295,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650339295","product_id":100020801,"comment_content":"MySQL好像已经没这个问题😭","like_count":0},{"had_liked":false,"id":342549,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1650336904,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650336904","product_id":100020801,"comment_content":"假设id是连续的，取出最大最小值，然后，让应用程序随机出一个id，再去数据库取id的数据，扫描3次","like_count":0},{"had_liked":false,"id":342114,"user_name":"何图图","can_delete":false,"product_type":"c1","uid":2940831,"ip_address":"","ucode":"5D2F19F4ADF2AA","user_header":"","comment_is_top":false,"comment_ctime":1650018184,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650018184","product_id":100020801,"comment_content":"苏州杭州的问题，分开各查100的条件是在前200个name的排序中，苏州杭州刚好各占100才可以吧？比如苏州的前500名的name的排序都在杭州的前面，分开各查100还对吗？","like_count":0},{"had_liked":false,"id":341876,"user_name":"Amy","can_delete":false,"product_type":"c1","uid":2251963,"ip_address":"","ucode":"B987A7FDC45497","user_header":"https://static001.geekbang.org/account/avatar/00/22/5c/bb/9aea8098.jpg","comment_is_top":false,"comment_ctime":1649897611,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649897611","product_id":100020801,"comment_content":"这种需求，是不是用ES更好一点。","like_count":0},{"had_liked":false,"id":336760,"user_name":"yinwenping","can_delete":false,"product_type":"c1","uid":1088594,"ip_address":"","ucode":"90310F95D8B72F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er6ADlY3IFt3Rs1aVDyrTO2ytQZDiciaXVKgxCnsqZJUQHzH6I0I6PYvdoiaI6rkm7OLOxHia7t1icDyBQ/132","comment_is_top":false,"comment_ctime":1646357659,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646357659","product_id":100020801,"comment_content":"看到问题的第一直觉是，从主键id的范围内随机取3个，然后在用主键id去查表。<br>第二种方法: 首页的访问量大，对于10000个单词，数据也没多少，都缓存到redis，然后从缓存取也可以啊，每隔一段时间更新缓存就行了。","like_count":0},{"had_liked":false,"id":336593,"user_name":"鲁·本","can_delete":false,"product_type":"c1","uid":1209939,"ip_address":"","ucode":"F1DEB30C21B48E","user_header":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","comment_is_top":false,"comment_ctime":1646230171,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646230171","product_id":100020801,"comment_content":"为什么不直接在内存临时表排序，而要转到sortbuffer里去呢？","like_count":0},{"had_liked":false,"id":336091,"user_name":"。。","can_delete":false,"product_type":"c1","uid":2853618,"ip_address":"","ucode":"A52A6043D27D87","user_header":"https://static001.geekbang.org/account/avatar/00/2b/8a/f2/6c6f7886.jpg","comment_is_top":false,"comment_ctime":1645898155,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645898155","product_id":100020801,"comment_content":"老师，在随机算法3中，select * from t limit @Y1，1；扫描行数应该是 @Y+1 对吗？但是我自己试的时候，发现 select * from t limt 0,1，并没有走索引，而是进行了全部扫描，不明白为什么。","like_count":0},{"had_liked":false,"id":332208,"user_name":"Hunter_Dark","can_delete":false,"product_type":"c1","uid":1342279,"ip_address":"","ucode":"3A07CCBC250B69","user_header":"https://static001.geekbang.org/account/avatar/00/14/7b/47/96dad3ff.jpg","comment_is_top":false,"comment_ctime":1643096094,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1643096094","product_id":100020801,"comment_content":"上一期的答案可以用（name, city）做索引吗？ 这样不是可以利用索引递推取完 100个就结束了？","like_count":0},{"had_liked":false,"id":329081,"user_name":"建强","can_delete":false,"product_type":"c1","uid":1397126,"ip_address":"","ucode":"62B03D0E0C64EC","user_header":"https://static001.geekbang.org/account/avatar/00/15/51/86/b5fd8dd8.jpg","comment_is_top":false,"comment_ctime":1641102753,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641102753","product_id":100020801,"comment_content":"思考题：<br>我的方案是这样的，先取出Y1,Y2,Y3最大的那个变量，根据最大值构造一个临时表，临时表中重新设置一个自增的临时ID，根据三个变量的最大值从原表中取出对应的记录数放入临时表中，然后再从临时表中分别取出ID=Y1，Y2，Y3的记录，这样的最大的扫描行数就是MAX(Y1,Y2,Y3) + 3<br><br>对应的SQL语句：<br><br># 假设@M是三个变量的最大值<br>select *<br>from <br>(<br>    select (@x := @x + 1) t_id, t.* <br>    from words<br>    ,(select @x:=0) t<br>    limit 0,@M+1<br>) t<br>where t_id in (@Y1, @Y2, @Y3);<br>","like_count":0},{"had_liked":false,"id":325717,"user_name":"InfoQ_小汤","can_delete":false,"product_type":"c1","uid":1739070,"ip_address":"","ucode":"E4C30DB7A9B54C","user_header":"https://static001.geekbang.org/account/avatar/00/1a/89/3e/0dd8e96b.jpg","comment_is_top":false,"comment_ctime":1639105030,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639105030","product_id":100020801,"comment_content":"老师 这种随机出现相同数字的概率怎么处理？count(*)一定 rand()函数有可能随机出两次三次一样的","like_count":0},{"had_liked":false,"id":319569,"user_name":"上海","can_delete":false,"product_type":"c1","uid":2678569,"ip_address":"","ucode":"6A4F9D80D25028","user_header":"https://static001.geekbang.org/account/avatar/00/28/df/29/3c956177.jpg","comment_is_top":false,"comment_ctime":1635852826,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635852826","product_id":100020801,"comment_content":"直接生成一个在1与row count之间的随机数x，然后查询条件为rowid=x或者建一个自增索引列c，令c=x。如果需要要多行，就重复这个过程。<br>请问这样会不会更好呢？","like_count":0},{"had_liked":false,"id":319568,"user_name":"上海","can_delete":false,"product_type":"c1","uid":2678569,"ip_address":"","ucode":"6A4F9D80D25028","user_header":"https://static001.geekbang.org/account/avatar/00/28/df/29/3c956177.jpg","comment_is_top":false,"comment_ctime":1635852818,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635852818","product_id":100020801,"comment_content":"直接生成一个在1与row count之间的随机数x，然后查询条件为rowid=x或者建一个自增索引列c，令c=x。如果需要要多行，就重复这个过程。<br>请问这样会不会更好呢？","like_count":0},{"had_liked":false,"id":317726,"user_name":"qiushye","can_delete":false,"product_type":"c1","uid":1322164,"ip_address":"","ucode":"D005A152F8BEDC","user_header":"","comment_is_top":false,"comment_ctime":1634904386,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634904386","product_id":100020801,"comment_content":"<br>mysql&gt; select count(*) into @C from t;<br>set @Y1 = floor(@C * rand());<br>set @Y2 = floor(@C * rand());<br>set @Y3 = floor(@C * rand());<br>select * from t limit @Y1，1； &#47;&#47;在应用代码里面取Y1、Y2、Y3值，拼出SQL后执行<br>select * from t limit @Y2，1；<br>select * from t limit @Y3，1；<br><br>这个方法拿三个随机单词时可能出现Y1, Y2, Y3中有重复的随机数吧，最后取出的单词也重复了。","like_count":0},{"had_liked":false,"id":313847,"user_name":"追风","can_delete":false,"product_type":"c1","uid":2644373,"ip_address":"","ucode":"46A2EC5C07AC4F","user_header":"","comment_is_top":false,"comment_ctime":1632710151,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1632710151","product_id":100020801,"comment_content":"老师  8.0后是不是对该排序做了优化。我的版本是8.0.26 ，我执行 <br>select word from words order by rand() limit 3;<br>该语句，在慢查询日志中，显示 扫描行数为10003<br># Query_time: 0.002946  Lock_time: 0.000144 Rows_sent: 3  Rows_examined: 10003<br>SET timestamp=1541402277;<br>select word from words order by rand() limit 3;","like_count":0},{"had_liked":false,"id":312183,"user_name":"Eternal","can_delete":false,"product_type":"c1","uid":1188023,"ip_address":"","ucode":"EA6FE7CC98F740","user_header":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","comment_is_top":false,"comment_ctime":1631674993,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631674993","product_id":100020801,"comment_content":"本期的问题：<br>如果单词数量是固定的，可以将每条单词id存到一个redis中的set中利用redis的函数随机取出3个ID，然后拿到id到数据库主键查询","like_count":0},{"had_liked":false,"id":312182,"user_name":"Eternal","can_delete":false,"product_type":"c1","uid":1188023,"ip_address":"","ucode":"EA6FE7CC98F740","user_header":"https://static001.geekbang.org/account/avatar/00/12/20/b7/bdb3bcf0.jpg","comment_is_top":false,"comment_ctime":1631674889,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631674889","product_id":100020801,"comment_content":"上一期的问题：这个和分库分表后的分页查询是个类似问题，需要先查询每个分片后的一页数据，然后排序取一页的数据，这叫merge合并数据，用老师说得归并排序实现","like_count":0},{"had_liked":false,"id":306665,"user_name":"秀秀","can_delete":false,"product_type":"c1","uid":1145162,"ip_address":"","ucode":"9D4D327324570B","user_header":"https://static001.geekbang.org/account/avatar/00/11/79/4a/10348395.jpg","comment_is_top":false,"comment_ctime":1628662981,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628662981","product_id":100020801,"comment_content":"随机一次Y1， 直接 limit @y1, 3不香嘛？","like_count":0},{"had_liked":false,"id":304899,"user_name":"赴","can_delete":false,"product_type":"c1","uid":2675954,"ip_address":"","ucode":"D47B3179BE3950","user_header":"https://static001.geekbang.org/account/avatar/00/28/d4/f2/3c0bfa0e.jpg","comment_is_top":false,"comment_ctime":1627694151,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627694151","product_id":100020801,"comment_content":"前面有同学说记录rowid，假如删除了，rowid是否就不连续了。那假如我们新加一个字段frand(索引),每写入一条就插入rand()值，在数据量大点的时候，他就表现得比较随机了吧，即使中间有删除空洞，然后通过这列进行课题里的随机算法1。","like_count":0},{"had_liked":false,"id":303647,"user_name":"朱区","can_delete":false,"product_type":"c1","uid":2034512,"ip_address":"","ucode":"1CFC71F159422A","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0b/50/211be6d5.jpg","comment_is_top":false,"comment_ctime":1626915607,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626915607","product_id":100020801,"comment_content":"随机取值不应该随机在内存表获取3行记录，为啥还要排序？","like_count":0},{"had_liked":false,"id":300913,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1625450884,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625450884","product_id":100020801,"comment_content":"临时文件和磁盘临时表 ，是一个东西吗？文中总是把这个概念交叉。。。","like_count":0},{"had_liked":false,"id":300561,"user_name":"yezj","can_delete":false,"product_type":"c1","uid":1832266,"ip_address":"","ucode":"38BD97834AC8F8","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIIP4P45S9HTzVH2SAH7u9UoKcjibh3smlme8Ieh4921diaaRJYcRcBWwq7XiaCySXO9lopRpDtzp7yA/132","comment_is_top":false,"comment_ctime":1625218687,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625218687","product_id":100020801,"comment_content":"老师对于上一讲的答案的第三问，感觉还是有问题吧，如果苏州只有5千条数据，杭州8千条数据，那么区第101页，按照老师的答案，是没有数据的。但实际上是有数据的。老师的答案查第一页是可以的。","like_count":0},{"had_liked":false,"id":294665,"user_name":"等风来","can_delete":false,"product_type":"c1","uid":1350677,"ip_address":"","ucode":"5B7FF74A51F534","user_header":"https://static001.geekbang.org/account/avatar/00/14/9c/15/719f1f44.jpg","comment_is_top":false,"comment_ctime":1622037691,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622037691","product_id":100020801,"comment_content":"有个疑问，limit 100，10 这条语句是， 存储引擎是返回110行呢还是是返回10行","like_count":0},{"had_liked":false,"id":294568,"user_name":"maybe","can_delete":false,"product_type":"c1","uid":1640973,"ip_address":"","ucode":"2C0D1D26853DB3","user_header":"https://static001.geekbang.org/account/avatar/00/19/0a/0d/7bac5bcb.jpg","comment_is_top":false,"comment_ctime":1622001417,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622001417","product_id":100020801,"comment_content":"MySql默认一个节点的长度为16K，一个整数（bigint）字段索引的长度为 8B,另外每个索引还跟着6B的指向其子树的指针。","like_count":0},{"had_liked":false,"id":284048,"user_name":"易翔","can_delete":false,"product_type":"c1","uid":1304541,"ip_address":"","ucode":"8C63DB7379186C","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/dd/e68f9cf5.jpg","comment_is_top":false,"comment_ctime":1616049917,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616049917","product_id":100020801,"comment_content":"虽然systemctl start mysqld 没启动成功。<br>使用 &#47;usr&#47;sbin&#47;mysqld --daemonize 却可以成功。<br><br>[root@db1 log]# &#47;usr&#47;sbin&#47;mysqld --daemonize <br>[root@db1 log]# mysql -uroot -p<br>Enter password: <br>Welcome to the MySQL monitor.  Commands end with ; or \\g.<br>Your MySQL connection id is 3<br>Server version: 5.7.33-log MySQL Community Server (GPL)<br><br>Copyright (c) 2000, 2021, Oracle and&#47;or its affiliates.<br><br>Oracle is a registered trademark of Oracle Corporation and&#47;or its<br>affiliates. Other names may be trademarks of their respective<br>owners.<br><br>Type &#39;help;&#39; or &#39;\\h&#39; for help. Type &#39;\\c&#39; to clear the current input statement.<br><br>[root@localhost][(none)]&gt; <br><br><br><br><br><br>希望您能看到，指点一下。这个在普通的运维层面上还真的不好看了。问了几十个DBA都无一例外说是权限问题。最多只能2000字符。分了好几个评论了。。没有排版，如果您要看了。实在难为了。。感激不尽！！！","like_count":0},{"had_liked":false,"id":284047,"user_name":"易翔","can_delete":false,"product_type":"c1","uid":1304541,"ip_address":"","ucode":"8C63DB7379186C","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/dd/e68f9cf5.jpg","comment_is_top":false,"comment_ctime":1616049875,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616049875","product_id":100020801,"comment_content":"使用<br><br>[root@db1 ~]# systemctl status mysqld.service<br>● mysqld.service - MySQL Server<br>   Loaded: loaded (&#47;usr&#47;lib&#47;systemd&#47;system&#47;mysqld.service; enabled; vendor preset: disabled)<br>   Active: failed (Result: exit-code) since 四 2021-03-18 14:35:21 CST; 6s ago<br>     Docs: man:mysqld(8)<br>           http:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;en&#47;using-systemd.html<br>  Process: 17314 ExecStart=&#47;usr&#47;sbin&#47;mysqld --daemonize (code=exited, status=1&#47;FAILURE)<br><br>3月 18 14:35:21 db1 systemd[1]: Starting MySQL Server...<br>3月 18 14:35:21 db1 mysqld[17314]: 2021-03-18T06:35:21.070260Z 0 [Warning] Changed limits: max_open_files: 1024 (requested 5000)<br>3月 18 14:35:21 db1 mysqld[17314]: 2021-03-18T06:35:21.235977Z 0 [Warning] Can&#39;t create test file &#47;data&#47;mysql&#47;mysqldata&#47;mydata&#47;db1.lower-test<br>3月 18 14:35:21 db1 systemd[1]: mysqld.service: control process exited, code=exited status=1<br>3月 18 14:35:21 db1 systemd[1]: Failed to start MySQL Server.<br>3月 18 14:35:21 db1 systemd[1]: Unit mysqld.service entered failed state.<br>3月 18 14:35:21 db1 systemd[1]: mysqld.service failed.<br><br>其中&#47;usr&#47;lib&#47;systemd&#47;system&#47;mysqld.service 的内容如下。（我删减了一下）<br><br>[root@db1 log]# cat &#47;usr&#47;lib&#47;systemd&#47;system&#47;mysqld.service | sed s&#47;^&quot; &quot;*&#47;&#47;g |sed &#47;^$&#47;d |sed &#47;^#&#47;d<br>[Unit]<br>Description=MySQL Server<br>Documentation=man:mysqld(8)<br>Documentation=http:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;en&#47;using-systemd.html<br>After=network.target<br>After=syslog.target<br>[Install]<br>[Service]<br>User=mysql<br>Group=mysql<br>Type=forking<br>ExecStart=&#47;usr&#47;sbin&#47;mysqld --daemonize<br><br>error.log 权限没有问题。由于错误日志没有打开，错误日志里面没有任何内容。<br>[root@db1 log]# pwd <br>&#47;data&#47;mysql&#47;mysqldata&#47;log<br>[root@db1 log]# ll<br>总用量 4<br>-rw-r-----. 1 mysql mysql    0 3月  18 14:41 error.log<br>-rw-r-----. 1 mysql mysql 1305 3月  18 14:10 slow-query.log<br>[root@db1 log]# <br><br>","like_count":0},{"had_liked":false,"id":284046,"user_name":"易翔","can_delete":false,"product_type":"c1","uid":1304541,"ip_address":"","ucode":"8C63DB7379186C","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/dd/e68f9cf5.jpg","comment_is_top":false,"comment_ctime":1616049861,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616049861","product_id":100020801,"comment_content":"使用journalctl -xe<br><br>-- Unit mysqld.service has begun starting up.<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.745329Z 0 [Warning] Changed limits: max_open_files: 1024 (requested 5000)<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.924877Z 0 [Warning] Can&#39;t create test file &#47;data&#47;mysql&#47;mysqldata&#47;mydata&#47;db1.lower-test<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.924962Z 0 [Note] &#47;usr&#47;sbin&#47;mysqld (mysqld 5.7.33-log) starting as process 17303 ...<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.927283Z 0 [Warning] Can&#39;t create test file &#47;data&#47;mysql&#47;mysqldata&#47;mydata&#47;db1.lower-test<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.927327Z 0 [Warning] Can&#39;t create test file &#47;data&#47;mysql&#47;mysqldata&#47;mydata&#47;db1.lower-test<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.928908Z 0 [ERROR] Could not open file &#39;&#47;data&#47;mysql&#47;mysqldata&#47;log&#47;error.log&#39; for error logging: Permission denied<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.928957Z 0 [ERROR] Aborting<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.929392Z 0 [Note] Binlog end<br>3月 18 14:34:17 db1 mysqld[17301]: Initialization of mysqld failed: 0<br>3月 18 14:34:17 db1 mysqld[17301]: 2021-03-18T06:34:17.929481Z 0 [Note] &#47;usr&#47;sbin&#47;mysqld: Shutdown complete<br>3月 18 14:34:17 db1 systemd[1]: mysqld.service: control process exited, code=exited status=1<br>3月 18 14:34:17 db1 systemd[1]: Failed to start MySQL Server.<br>-- Subject: Unit mysqld.service has failed<br>-- Defined-By: systemd<br>-- Support: http:&#47;&#47;lists.freedesktop.org&#47;mailman&#47;listinfo&#47;systemd-devel<br>-- <br>-- Unit mysqld.service has failed.<br>-- <br>-- The result is failed.<br>3月 18 14:34:17 db1 systemd[1]: Unit mysqld.service entered failed state.<br>3月 18 14:34:17 db1 systemd[1]: mysqld.service failed.<br>3月 18 14:34:17 db1 polkitd[716]: Unregistered Authentication Agent for unix-process:17295:51674709 (system bus name :1.405, object path &#47;org&#47;freedesktop&#47;PolicyKit1&#47;AuthenticationAg<br><br>","like_count":0},{"had_liked":false,"id":284045,"user_name":"易翔","can_delete":false,"product_type":"c1","uid":1304541,"ip_address":"","ucode":"8C63DB7379186C","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/dd/e68f9cf5.jpg","comment_is_top":false,"comment_ctime":1616049846,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1616049846","product_id":100020801,"comment_content":"林老师，你的专栏我看了几遍了。经常来温故一下。这两天在centos7上用rpm安装5.7.33的时候遇到一个问题。倒腾了一天多了，还没有找到问题所在，问了很多DBA，思路都差不多，结果都解决不了。有人说编译安装跳过这个错。可我还是想知道到底什么原因。。希望您能看到，指点一下。<br>由于不能截图。只能复制描述信息了。<br>=====<br>我使用 systemctl start mysqld 报错如下。<br>[root@db1 ~]# systemctl start mysqld<br><br>Job for mysqld.service failed because the control process exited with error code. See &quot;systemctl status mysqld.service&quot; and &quot;journalctl -xe&quot; for details.<br><br>","like_count":0,"discussions":[{"author":{"id":1462026,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIY8d8yb0o6a5fyBSlk2HHOjk0vrYCnfaeybAVbQrLibexQWIGliam8cuwVlCfdRhfeZE20iaVWXXqVw/132","nickname":"Geek_c89ab3","note":"","ucode":"E3C8A8CF267079","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387601,"discussion_content":"看mysql 错误日志","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628297463,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277955,"user_name":"吉法师","can_delete":false,"product_type":"c1","uid":2232546,"ip_address":"","ucode":"F1E3F4F526CA13","user_header":"https://static001.geekbang.org/account/avatar/00/22/10/e2/35f2fc23.jpg","comment_is_top":false,"comment_ctime":1612682453,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612682453","product_id":100020801,"comment_content":"最近用Nodejs写了个数据库，想随机吐出冷笑话，也遇到了这个问题，如果一次返回全部的数据，网络传输的时候JSON.parse老失败，我就想只返回需要的数据就行了。<br><br>我的数据库SQL解析器是用的第三方模块，不支持rand()这种，所以我也是先select count(*) 然后去拿具体的哪几行的，正好就是老师说的这个方法","like_count":0},{"had_liked":false,"id":274140,"user_name":"否极泰来","can_delete":false,"product_type":"c1","uid":1439355,"ip_address":"","ucode":"C249173266251A","user_header":"https://static001.geekbang.org/account/avatar/00/15/f6/7b/b6abcbbe.jpg","comment_is_top":false,"comment_ctime":1610871157,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1610871157","product_id":100020801,"comment_content":"上面提到的算法我试了一下<br>一个百万条记录的表<br>算法 1<br>select * from t where id &gt;= @X limit 1;<br>如果@X  值很小 那么explain 看了扫描行数50万  但是查询速度很快（0.006s）<br><br>算法三<br>select * from t limit @Y1，1；<br>如果@Y的值很高(就是全表扫描了)  查询就需要0.5秒了","like_count":0},{"had_liked":false,"id":268436,"user_name":"下个目标45k","can_delete":false,"product_type":"c1","uid":1066508,"ip_address":"","ucode":"193BA8C3AA9A61","user_header":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","comment_is_top":false,"comment_ctime":1608194165,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608194165","product_id":100020801,"comment_content":"我来实现这个需求的话,两种情况<br>1. 如果id是自增<br>找到最大的id值 ,在(minId,maxId) 直接业务代码random三个出来 ,查询单词时套上缓存 <br><br>2.如果id是时序递增<br>定时查询一批单词,比如1000个放入缓存,比如redis ,利用SRANDMEMBER 命令随机返回三个","like_count":0},{"had_liked":false,"id":267066,"user_name":"陈松Plus","can_delete":false,"product_type":"c1","uid":1264707,"ip_address":"","ucode":"0074BDECFA3D1D","user_header":"https://static001.geekbang.org/account/avatar/00/13/4c/43/150c70c2.jpg","comment_is_top":false,"comment_ctime":1607586741,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607586741","product_id":100020801,"comment_content":"老师好，请教个业务问题。我们系统也有类似的根据用户兴趣爱好随机显示文章的需求，同时涉及到分页。第一次随机取20条，用户下拉刷新再随机返回20条与之前不同的文章，请问这种需求应该怎么设计比较合理呢。文章总数 1W+，每篇文章较大，有text字段。","like_count":0},{"had_liked":false,"id":265363,"user_name":"Wangyf","can_delete":false,"product_type":"c1","uid":2226219,"ip_address":"","ucode":"349068A07CB1D4","user_header":"https://static001.geekbang.org/account/avatar/00/21/f8/2b/339660f1.jpg","comment_is_top":false,"comment_ctime":1606878006,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1606878006","product_id":100020801,"comment_content":"我写这留言的时候还没有看别人的，我想的是，搞一个生词本出来。显示的那 3 个单词，就从这生词本里挑。生词本可以放在用户手机上，而且要扫描的数量，也会少很多很多。占用的手机存储，几乎可以忽略不计","like_count":0},{"had_liked":false,"id":262628,"user_name":"玄真","can_delete":false,"product_type":"c1","uid":2237677,"ip_address":"","ucode":"D21A7096AFB816","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLg04lnicnUNWVmohBVoWiaKPpuYu8j0CHVIjjurfO3YcJqicHZBMYFqjoEpiaa3jrNmRzyzXiaPPt29cA/132","comment_is_top":false,"comment_ctime":1605785760,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605785760","product_id":100020801,"comment_content":"select id,自增序号  into  临时表，在自增序号上面建立索引，用算法2取出三个随机序号，再取出对应的主键id，再走主键查询呢。","like_count":0},{"had_liked":false,"id":250854,"user_name":"卢金永","can_delete":false,"product_type":"c1","uid":1027889,"ip_address":"","ucode":"00A20E6E6AD35B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIxSrpEI7VGZK4x7L67bYr6N0RqqcaGHFxcCsSUXVRLZ09CYrJtFq5K8UBUs760BJkM76CjfshYiag/132","comment_is_top":false,"comment_ctime":1601261661,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601261661","product_id":100020801,"comment_content":"单独查询主键生成包含自增字段+主键的临时表，随机取出3个自增字段（已经连续）对应的值（即主键），再根据主键反查结果，这样性能如何？","like_count":0},{"had_liked":false,"id":250459,"user_name":"惜昔","can_delete":false,"product_type":"c1","uid":1441589,"ip_address":"","ucode":"B3478E40B612FC","user_header":"https://static001.geekbang.org/account/avatar/00/15/ff/35/b744c027.jpg","comment_is_top":false,"comment_ctime":1601090488,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1601090488","product_id":100020801,"comment_content":"想问临时表是在server层吗","like_count":0,"discussions":[{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335438,"discussion_content":"提到了memory引擎,应该是在存储层","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608194417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":248818,"user_name":"大空翼","can_delete":false,"product_type":"c1","uid":1523795,"ip_address":"","ucode":"B56CB3F3B1B407","user_header":"","comment_is_top":false,"comment_ctime":1600322846,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600322846","product_id":100020801,"comment_content":"select * from t where city in (“杭州”,&quot; 苏州 &quot;) order by name limit 100; 这排序没有用到索引，但是查询条件用到了吧？","like_count":0},{"had_liked":false,"id":246725,"user_name":"Magic","can_delete":false,"product_type":"c1","uid":1272047,"ip_address":"","ucode":"FD9CEDAA419EB0","user_header":"https://static001.geekbang.org/account/avatar/00/13/68/ef/6264ca3d.jpg","comment_is_top":false,"comment_ctime":1599465212,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599465212","product_id":100020801,"comment_content":"课后题：<br>将计算得到的Y1，Y2，Y3按从小到大排序，然后<br>select id1 from t limit Y1,1;<br>select id2 from t where id&gt;id1 limit Y2-Y1,1<br>select * from t where id&gt;id2 limit Y3-Y2,1","like_count":0},{"had_liked":false,"id":244561,"user_name":"瑞哲","can_delete":false,"product_type":"c1","uid":1502093,"ip_address":"","ucode":"9F170728A055AD","user_header":"https://static001.geekbang.org/account/avatar/00/16/eb/8d/8ee78d3d.jpg","comment_is_top":false,"comment_ctime":1598581443,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598581443","product_id":100020801,"comment_content":"老师，没有查到mysql rowid为什么是6字节的，查到了oracle的，oracle 7以前，rowid是存储了 10位的文件号，22位的块号，16位的行号，6个字节，MySQL也是这样所以rowid是6个字节吗","like_count":0},{"had_liked":false,"id":243320,"user_name":"考拉出山","can_delete":false,"product_type":"c1","uid":1303954,"ip_address":"","ucode":"917E35FD7B2D06","user_header":"https://wx.qlogo.cn/mmopen/vi_32/1mOvT5fApeicXppMP3zADG6XIPicNt5D9dL6y46SF5UUcH0hicG21LM6xSgHJj5oAdzCyeGtLZYHYmlvaFwecrGOA/132","comment_is_top":false,"comment_ctime":1598059017,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598059017","product_id":100020801,"comment_content":"看了这么多篇章，又看到赞美。每次我都怀疑是自己水平理解能力有问题，虽然水平确实不怎么样。但是我想说，很多内容都没有讲清楚，前后逻辑，正反推导逻辑，留言反而成了点睛。说这个更多不是为了抱怨，而是给后面看的人提示。","like_count":0},{"had_liked":false,"id":241594,"user_name":"Racoon","can_delete":false,"product_type":"c1","uid":1040047,"ip_address":"","ucode":"20D9DBDDEB3B1E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/de/af/9379c7bd.jpg","comment_is_top":false,"comment_ctime":1597366876,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597366876","product_id":100020801,"comment_content":"在临时表上按照R字段排序，然后把数据从临时表读取存到sort_buffer，为什么存sort_buffer不是有序的，sort_buffer为什么还要再进行排序呢","like_count":0},{"had_liked":false,"id":234616,"user_name":"小能","can_delete":false,"product_type":"c1","uid":2063014,"ip_address":"","ucode":"39EAAC8443B83C","user_header":"https://static001.geekbang.org/account/avatar/00/1f/7a/a6/e37fbbd8.jpg","comment_is_top":false,"comment_ctime":1594734487,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594734487","product_id":100020801,"comment_content":"老师，对于随机抽样，为什么不用蓄水抽样算法？这样O(n)就完事了","like_count":0},{"had_liked":false,"id":232146,"user_name":"冬仔","can_delete":false,"product_type":"c1","uid":1326683,"ip_address":"","ucode":"AD355D9814F7AD","user_header":"https://static001.geekbang.org/account/avatar/00/14/3e/5b/260507c5.jpg","comment_is_top":false,"comment_ctime":1593871184,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593871184","product_id":100020801,"comment_content":"老师请问，对于本文的随机取三个word的问题。MySQL为什么不直接使用全字段排序（R, w），即一次读出每行的word，然后计算一个随机值R，出入sort_buffer？而是用临时表存了（R，w），又用buffer_sort存了（R，pos）。这样R就会重复占用一次存储空间（内存或磁盘），感受上似乎更加占用内存。而且sort_buffer排序完后，还要根据pos去临时表搜w，感觉也有点没必要吧？","like_count":0},{"had_liked":false,"id":229005,"user_name":"景梦园","can_delete":false,"product_type":"c1","uid":1620479,"ip_address":"","ucode":"0A17708457ACB2","user_header":"https://static001.geekbang.org/account/avatar/00/18/b9/ff/ea6c2e86.jpg","comment_is_top":false,"comment_ctime":1592878829,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592878829","product_id":100020801,"comment_content":"老师，请问为什么 select count(*) from words; 慢查询给的 Rows_examined=0 呢？","like_count":0},{"had_liked":false,"id":216738,"user_name":"Wings","can_delete":false,"product_type":"c1","uid":1215464,"ip_address":"","ucode":"047167807048EC","user_header":"https://static001.geekbang.org/account/avatar/00/12/8b/e8/7f09a744.jpg","comment_is_top":false,"comment_ctime":1589334540,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589334540","product_id":100020801,"comment_content":"老师，是不是limit中不支持拿变量？报错如下： You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;@Y1,1&#39; at line 1","like_count":0},{"had_liked":false,"id":209043,"user_name":"Sparrow","can_delete":false,"product_type":"c1","uid":1693667,"ip_address":"","ucode":"88D3F3920C68BC","user_header":"https://static001.geekbang.org/account/avatar/00/19/d7/e3/e6cf6352.jpg","comment_is_top":false,"comment_ctime":1587482261,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587482261","product_id":100020801,"comment_content":"我们以前是给表加个范围0-1的随机数字段rn，并加索引。<br>查询的时候先随机生成一个0-1的随机数r，再取大于或小于这个数的第一个数<br>select*from t where rn&gt;r limit 1;","like_count":0},{"had_liked":false,"id":206651,"user_name":"鲁班大师","can_delete":false,"product_type":"c1","uid":1179156,"ip_address":"","ucode":"4F9615DF87B031","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/14/f1532dec.jpg","comment_is_top":false,"comment_ctime":1586913759,"is_pvip":false,"replies":[{"id":"77237","content":"功能上是允许的<br>性能上的收益是要看业务哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1586941106,"ip_address":"","comment_id":206651,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1586913759","product_id":100020801,"comment_content":"可以创建三个字段以上的联合索引吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491854,"discussion_content":"功能上是允许的\n性能上的收益是要看业务哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586941106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1179156,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fe/14/f1532dec.jpg","nickname":"鲁班大师","note":"","ucode":"4F9615DF87B031","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":234218,"discussion_content":"我理解联合索引的字段越多，插入和更新的性能就越差，因为要涉及到数据页的合并和分裂。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586960990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206421,"user_name":"初音未来","can_delete":false,"product_type":"c1","uid":1274518,"ip_address":"","ucode":"3AE23DBC649B97","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erKFNFAQl3ibwlic54a5SQYAMhQYeVtMnSmMahZZjyqG2d66whxbEE3I3IyD07pSmte5DSibr71m6A9g/132","comment_is_top":false,"comment_ctime":1586858495,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586858495","product_id":100020801,"comment_content":"林老师你好，看您的文章有段时间了，最近两天碰到一个棘手问题，还请老师给一个解决思路，<br>我们的CPU使用率在1分钟之内，从20%增加到100%，TCP连接数同步上升，然而我们的业务请求并没有增加，查看慢日志：<br>select `id`,<br>       `class_id`,<br>       `tmall`,<br>       `buss_name`,<br>       `goods_id` as `taobao_id`,<br>       `url_shop` as `prourl`,<br>       `thumb` as `pic`,<br>       `youhuiquan_link` as `couponLink`,<br>       `price_shoujia` as `shoujia`,<br>       `price_juanhou` as `juanhou`,<br>       `youhuiquan_price` as `quan_fee`,<br>       `sales`,<br>       `video_url`,<br>       `commission_rate`,<br>       `nick`,<br>       `youhuiquan_num_shengyu`,<br>       `youhuiquan_time_guoqi`,<br>       `deposit` as `presale_deposit`,<br>       `youhuiquan_quan_condition`,<br>       `deposit_deduct` as `presale_reduction`<br>  from `fl_taoke_product`<br> where `is_show`= 1<br>   and `online_time`&lt;= 1586700873<br> order by `is_recommend` desc,<br>         `tmall` desc,<br>         `sales` desc,<br>         `id` desc<br> limit 19 offset 0<br><br>这条sql执行比较慢，而且排序没有用到索引，以为找到问题所在了，但是这个SQL平时不会造成CPU瓶颈，排查到这就没了思路，希望老师提供一个思路，在线等","like_count":0,"discussions":[{"author":{"id":1274518,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erKFNFAQl3ibwlic54a5SQYAMhQYeVtMnSmMahZZjyqG2d66whxbEE3I3IyD07pSmte5DSibr71m6A9g/132","nickname":"初音未来","note":"","ucode":"3AE23DBC649B97","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":232220,"discussion_content":"另外发现mysql错误日志\n\n2020-04-12 23:05:07 50993 [Warning] Sort aborted, host: 172.20.134.27, user: tkjidi_newapi, thread: 2200192, query: select `id`, `class_id`, `tmall`, `buss_name`, `goods_id` as `taobao_id`, `url_shop`\nas `prourl`, `thumb` as `pic`, `youhuiquan_link` as `couponLink`, `price_shoujia` as `shoujia`, `price_juanhou` as `juanhou`, `youhuiquan_price` as `quan_fee`, `sales`, `video_url`, `commission_rate`\n, `nick`, `youhuiquan_num_shengyu`, `youhuiquan_time_guoqi`, `deposit` as `presale_deposit`, `youhuiquan_quan_condition`, `deposit_deduct` as `presale_reduction` from `fl_taoke_product` where `is_show\n` = 1 and `online_time` <= 1586703893 order by `is_recommend` desc, `tmall` desc, `sales` desc, `id` desc limit 19 offset 0\n\n\n\t\n2020-04-12 22:15:30 50993 [Note] Multi-threaded slave statistics for channel &#39;&#39;: seconds elapsed = 120; events assigned = 467867649; worker queues filled over overrun level = 0; waited due a Worker qu\neue full = 0; waited due the total size = 0; slept when Workers occupied = 0\n\n2020-04-12 22:16:44 50993 [Warning] TCP send or receive package error : did not call getsockopt to obtain error message.\n\n\n2020-04-12 22:20:17 50993 [Warning] TCP send or receive package error : TCP Write Error, Errno: 32, Error message: Broken pipe, Remote IP: 172.20.134.41, tcp blocked: no, package size: -1, socket(tcpi\n_total_retrans: 0, tcpi_reordering: 3, tcpi_rcv_space: 87380, tcpi_snd_ssthresh: 2147483647, tcpi_snd_cwnd: 10, tcpi_rtt: 2125, tcpi_rttvar: 750)\n\n\n给个思路吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586861604,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205932,"user_name":"TIAN","can_delete":false,"product_type":"c1","uid":1276795,"ip_address":"","ucode":"CCCF80602C1753","user_header":"https://static001.geekbang.org/account/avatar/00/13/7b/7b/5b39b47b.jpg","comment_is_top":false,"comment_ctime":1586759519,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586759519","product_id":100020801,"comment_content":"请问老师或者其他同学，归并排序的语句应该怎么写，也就是说分别查出走索引的两个排序之后，怎么合并到一起？谢谢","like_count":0},{"had_liked":false,"id":201178,"user_name":"亲斤弓虽😈","can_delete":false,"product_type":"c1","uid":1412163,"ip_address":"","ucode":"575893ECF0B7AA","user_header":"https://static001.geekbang.org/account/avatar/00/15/8c/43/af33659f.jpg","comment_is_top":false,"comment_ctime":1585728368,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585728368","product_id":100020801,"comment_content":"课后思考题:<br>优化行数,存储单词的表可以用MyISAM引擎,因为表的维护成本肯定很低,主要也是已读为主,所以用MyISAM引擎即可.而且在老师的14讲https:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;72775 也说count(*)对于MyISAM引擎是直接存储在硬盘上的,读取效率很高不用在扫描全表.C的扫描行数可以等于0<br><br>磁盘临时表的优先级队列排序,我理解就是一个堆化过程,构建大顶堆.然后拿堆顶的三行返回","like_count":0},{"had_liked":false,"id":197520,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1585383469,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585383469","product_id":100020801,"comment_content":"真的有随机取数的需求的话，一般也不会直接丢给数据库来实现，如果数据量不是特别大的话，完全可以把数据做个缓存，然后随机从中取出想要的数据","like_count":0},{"had_liked":false,"id":197518,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1585383346,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585383346","product_id":100020801,"comment_content":"实际工作中，不可能把所有的问题全部丢给数据库 ，业务层面要处理大部分的逻辑","like_count":0},{"had_liked":false,"id":191045,"user_name":"starj","can_delete":false,"product_type":"c1","uid":1108791,"ip_address":"","ucode":"3546E42F1340B2","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/37/a2f4c9f8.jpg","comment_is_top":false,"comment_ctime":1584719713,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1584719713","product_id":100020801,"comment_content":"需要好好消化下","like_count":0},{"had_liked":false,"id":190803,"user_name":"纸飞机","can_delete":false,"product_type":"c1","uid":1108954,"ip_address":"","ucode":"E83EB9A453ACE2","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/da/09feef5a.jpg","comment_is_top":false,"comment_ctime":1584693298,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584693298","product_id":100020801,"comment_content":"使用优先队列算法的扫描行数怎么计算？","like_count":0},{"had_liked":false,"id":190784,"user_name":"纸飞机","can_delete":false,"product_type":"c1","uid":1108954,"ip_address":"","ucode":"E83EB9A453ACE2","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/da/09feef5a.jpg","comment_is_top":false,"comment_ctime":1584692167,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584692167","product_id":100020801,"comment_content":"为什么使用优先队列算法的扫描行数是10000呢？ 从原表拿出数据放到临时表是10000，后面从临时表拿数据放到sort_buffer中没有计算行数吗？","like_count":0},{"had_liked":false,"id":185602,"user_name":"乔丹","can_delete":false,"product_type":"c1","uid":1217413,"ip_address":"","ucode":"D832A9F97A0C7E","user_header":"https://static001.geekbang.org/account/avatar/00/12/93/85/f5d9474c.jpg","comment_is_top":false,"comment_ctime":1583642185,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583642185","product_id":100020801,"comment_content":"对于问题优化C+(Y1+1)+(Y2+1)+(Y3+1)的方法，在遍历表的时候，一次性将Y1+1, Y2+1, Y3+1都取出来。减少遍历的次数。<br>","like_count":0},{"had_liked":false,"id":184463,"user_name":"张sir","can_delete":false,"product_type":"c1","uid":1209431,"ip_address":"","ucode":"52958DF6705208","user_header":"https://static001.geekbang.org/account/avatar/00/12/74/57/7b828263.jpg","comment_is_top":false,"comment_ctime":1583321936,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583321936","product_id":100020801,"comment_content":"对于sort_buffer的理解，我感觉是这样的，如果全字段排序放不下，就使用rowId排序，如果rowId+排序字段也放不下的话，则优化器会考虑优先队列排序，优先队列排序的内存如果大于sort_buffer的话，则使用磁盘临时文件，这样理解对吗？","like_count":0},{"had_liked":false,"id":181462,"user_name":"木得感情的编码机器","can_delete":false,"product_type":"c1","uid":1810051,"ip_address":"","ucode":"9C6CD47ADCB8E6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0uyg1IicbEhLwsgM2A2ROoyVdWdmUqZfQfs6G67w9m3hdRNBMOQJatQoACj3qNGgj2KVIgricaYiaQ/132","comment_is_top":false,"comment_ctime":1582545648,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582545648","product_id":100020801,"comment_content":"老师最后的随机3个单词的程序可能会出现相同值，可以改进成把总行数分成3份，比如10000行，就分成 [0-3333]，[3334-6666], [6667-9999]，然后每一份取一个随机数，这样Y1, Y2, Y3就不会重复了。","like_count":0},{"had_liked":false,"id":179498,"user_name":"飞火流苏","can_delete":false,"product_type":"c1","uid":1286444,"ip_address":"","ucode":"FD9948121EC3DD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTImeO3D5b56uwnS9OqzsuhNiciaA3ekC49lNt7NaGoTZ3U7tfLKRLR3V0F7k8hEJQZ4mQD7hfGwWiceQ/132","comment_is_top":false,"comment_ctime":1582016227,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582016227","product_id":100020801,"comment_content":"EXPLAIN SELECT * FROM product ORDER by rand(); <br>这个查询语句Using temporary; Using filesort没有问题，但是当把select *换成select id时，发现extra信息中多了一个Using Index，mysql选了一个基数最小的索引。这是为什么呢？","like_count":0},{"had_liked":false,"id":175795,"user_name":"王盛武","can_delete":false,"product_type":"c1","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1580828516,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580828516","product_id":100020801,"comment_content":"innodb_sort_buffer_size和sort_buffer_size 这两个参数的区别是？","like_count":0},{"had_liked":false,"id":171023,"user_name":"ipromiseu","can_delete":false,"product_type":"c1","uid":1159317,"ip_address":"","ucode":"775E2CC0E7CA69","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbUHD8KH3mYz39QuHj5BXB06VqCus5WR4oHfNuSYdPVLno3Tq61yhMiaugxpMicKibDFQ4KwX7icoDWQ/132","comment_is_top":false,"comment_ctime":1578824408,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1578824408","product_id":100020801,"comment_content":"limit Y,1 会有深翻页问题，可以改成 where id &gt; Y ,limit 1。这个对不对","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159843,"discussion_content":"看你order by的字段是不是也依旧是递增的。否则这个不一定对。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580736441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167504,"user_name":"湯尼陳","can_delete":false,"product_type":"c1","uid":1607276,"ip_address":"","ucode":"7C787DB9FBCA37","user_header":"https://static001.geekbang.org/account/avatar/00/18/86/6c/b4f41f88.jpg","comment_is_top":false,"comment_ctime":1577845870,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577845870","product_id":100020801,"comment_content":"在ID是连续的情况下，在业务层代码做随机选择算法，选出三个数，然后直接select * from t where id=xx.","like_count":0},{"had_liked":false,"id":165270,"user_name":"栋能","can_delete":false,"product_type":"c1","uid":1006849,"ip_address":"","ucode":"8BD9C939D3E8E1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5d/01/9cd84003.jpg","comment_is_top":false,"comment_ctime":1577191152,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1577191152","product_id":100020801,"comment_content":"没太看明白：“select * from t where city=&quot;杭州&quot; order by name limit 10000,100; ” 为什么要改成 “<br>select * from t where city=&quot;杭州&quot; order by name limit 10100; ” ？我理解第一条既然是10000,100，那sort_buffer是否自然就可以解析成对10100进行了排序，然后再返回最后的100条数据？而第二条其实还是要将10100条数据拿到sort_buffer中进行排序的，我是没看出来第二条有啥特别指出？反正都是在临时文件中进行排序","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159873,"discussion_content":"并不是啊，因为杭州、苏州加起来可能8万行，然后8万行再排序，过10000行，然后取100。如果采用这种方式，也就最多取20200行，然后排序再跨10000行，取100行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580738102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":162760,"user_name":"咩咩咩","can_delete":false,"product_type":"c1","uid":1237849,"ip_address":"","ucode":"9DEC7D5D52D972","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/6a8fRQFxX5VXOpRKyYibsemKwDMexMxkzZOBquPo6T4HOcYicBiaTcqibDoTIhZSjVjF3nKXTEGDYOGPt2xqqwiawjg/132","comment_is_top":false,"comment_ctime":1576585437,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576585437","product_id":100020801,"comment_content":"sort_buffer_size和tmp_table_size的区别有点懵.什么时候会使用临时文件,什么是时候会使用临时表?<br>我的理解是一般排序过程中,sort_buffer_size比数据量低则会使用临时文件辅助排序,而临时表则是需要其它字段辅助排序时使用,但是需要其它字段其实也可以在sort_buffer加一个字段完成呀.不知道对不对,老师指点一下","like_count":0},{"had_liked":false,"id":160413,"user_name":"遇见","can_delete":false,"product_type":"c1","uid":1624590,"ip_address":"","ucode":"FAF53CD4C28494","user_header":"https://static001.geekbang.org/account/avatar/00/18/ca/0e/5009c5ff.jpg","comment_is_top":false,"comment_ctime":1575947206,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1575947206","product_id":100020801,"comment_content":"这种问题我会在业务代码里获取总行数之后，直接随机出三个id值，然后用id去数据库匹配取值了。<br><br>随机这种事儿，最好交给业务代码来做。<br><br>数据库最喜欢给他个主键ID，获取值了。简单又快速。","like_count":0,"discussions":[{"author":{"id":1667987,"avatar":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","nickname":"Ryan","note":"","ucode":"95BBBEE5B23878","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215800,"discussion_content":"假如你随机算出来的id在数据库被删除了呢？你不能一直重复算吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585384338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160202,"user_name":"Simple life","can_delete":false,"product_type":"c1","uid":1571460,"ip_address":"","ucode":"1902D7F72FB43F","user_header":"https://static001.geekbang.org/account/avatar/00/17/fa/84/f01d203a.jpg","comment_is_top":false,"comment_ctime":1575890667,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1575890667","product_id":100020801,"comment_content":"看了老师对于最后上期问题的解答，有个疑惑，虽然方案减少了数据库的操作时间，但是却增加了IO时间，会不会得不偿失，毕竟远程访问的耗时是比较大的","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159877,"discussion_content":"这个就看数据量，做各方面权衡。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580738197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157844,"user_name":"Geek_3004e0","can_delete":false,"product_type":"c1","uid":1732823,"ip_address":"","ucode":"441D39BDC39E4A","user_header":"https://static001.geekbang.org/account/avatar/00/1a/70/d7/d1049bae.jpg","comment_is_top":false,"comment_ctime":1575269293,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575269293","product_id":100020801,"comment_content":"老师，想问下，对于words表做排序查询select word from words order by word limit 3，发现慢查询中的日志记录 Rows_examined: 10003，而查询前后比较 performance_schema.session_status where variable_name = &#39;Innodb_rows_read&#39; 的差值是1000， max_length_for_sort_data 参数是4096，sort_buffer_size是262144。为什么慢查询的rows_examined会多3条记录呢？","like_count":0},{"had_liked":false,"id":157618,"user_name":"looper","can_delete":false,"product_type":"c1","uid":1238396,"ip_address":"","ucode":"DA4BCE83836C04","user_header":"https://static001.geekbang.org/account/avatar/00/12/e5/7c/2a5a418b.jpg","comment_is_top":false,"comment_ctime":1575213530,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575213530","product_id":100020801,"comment_content":"课后题：不使用减少扫描记录数，可以通过优化了limit，使用id+1的方式","like_count":0},{"had_liked":false,"id":152929,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574125217,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574125217","product_id":100020801,"comment_content":"每个单词10个字节的话，10000个单是100,000字节，即100K不到，可以用redis缓存的列表，每次随机选下标取三个，用lindex","like_count":0},{"had_liked":false,"id":152830,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574085124,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574085124","product_id":100020801,"comment_content":"老师，在图4中会用到堆排序吗？我理解应该也会吧，对于top K问题，堆排序时间复杂度更小","like_count":0},{"had_liked":false,"id":134467,"user_name":"丁丁历险记","can_delete":false,"product_type":"c1","uid":1661704,"ip_address":"","ucode":"A43829E454C067","user_header":"https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg","comment_is_top":false,"comment_ctime":1568852653,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568852653","product_id":100020801,"comment_content":"再补一句，典型的key  val  结构  为啥不用nosql 来处理。","like_count":0},{"had_liked":false,"id":134465,"user_name":"丁丁历险记","can_delete":false,"product_type":"c1","uid":1661704,"ip_address":"","ucode":"A43829E454C067","user_header":"https://static001.geekbang.org/account/avatar/00/19/5b/08/b0b0db05.jpg","comment_is_top":false,"comment_ctime":1568852573,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1568852573","product_id":100020801,"comment_content":"第一反应，单词表大小固定，所以我就直接<br>随机生产三个随机数<br>where  id  in（xxx,yyy,zxz）<br>然后再接着听。。。","like_count":0,"discussions":[{"author":{"id":1667987,"avatar":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","nickname":"Ryan","note":"","ucode":"95BBBEE5B23878","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215801,"discussion_content":"如果随机产生的id记录被删除了，后续怎样处理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585384411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125046,"user_name":"小罗希冀","can_delete":false,"product_type":"c1","uid":1311995,"ip_address":"","ucode":"88416458FF0041","user_header":"https://static001.geekbang.org/account/avatar/00/14/04/fb/40f298bb.jpg","comment_is_top":false,"comment_ctime":1566051707,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566051707","product_id":100020801,"comment_content":"1、查询当前最大的自增id:select id from t order by id limit 1;<br>2、获取一个0到最大自增id之间一个数：0-n<br>3、查询小于随机值第一条，有则结束：select id from t order by id where id &lt;@id limit 1;<br>4、若步骤三为查到，则查询大于或等于随机值的第一条:select id from t order by id where id &gt;=@id limit 1;<br>总体描述行数：c+(2|3），但查询次数最坏需3次","like_count":0},{"had_liked":false,"id":124881,"user_name":"我家门前有只猪","can_delete":false,"product_type":"c1","uid":1488035,"ip_address":"","ucode":"F8CF618CF4681E","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/a3/a159ca86.jpg","comment_is_top":false,"comment_ctime":1566007505,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566007505","product_id":100020801,"comment_content":"有点不理解 ，为什么在排序之前会用到临时表？","like_count":0,"discussions":[{"author":{"id":1652836,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epKJlW7sqts2ZbPuhMbseTAdvHWnrc4ficAeSZyKibkvn6qyxflPrkKKU3mH6XCNmYvDg11tB6y0pxg/132","nickname":"pc","note":"","ucode":"1AD538B9A900B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100433,"discussion_content":"为了有随机数字段R","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577259804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":124836,"user_name":"林肯","can_delete":false,"product_type":"c1","uid":1008582,"ip_address":"","ucode":"D2C97220230DE5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/63/c6/d6ea3df3.jpg","comment_is_top":false,"comment_ctime":1566004608,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566004608","product_id":100020801,"comment_content":"如果单词表的id是自增的，那么每次在服务端先拿到minid maxid然后随机算出三个id根据id去库里取就行了","like_count":0,"discussions":[{"author":{"id":1261674,"avatar":"https://static001.geekbang.org/account/avatar/00/13/40/6a/ab1cf396.jpg","nickname":"小兵","note":"","ucode":"AA3BA727C25179","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5170,"discussion_content":"如果有空洞就不行了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1566027066,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119116,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1564523540,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564523540","product_id":100020801,"comment_content":"课前思考<br>1：如何正确显示随机消息？<br>随机消息是啥？消息是啥？后来看过文章发现，消息就是数据库表中的行数据，随机消息就是随机的一行数据。那随机取一条不就行啦！恩，关键怎么随机取？如果主键自增且连续，则比较简单。若主键自增但不连续，那就维护一个自增且连续的字段，按哪个字段随机取，可以在表中维护，也可以在内存中映射。<br>课后思考<br>感觉老师的优化思路，和我的课前思考类似，当然有些精巧的方法我是没想到的。","like_count":0},{"had_liked":false,"id":118143,"user_name":"啊啊啊哦哦","can_delete":false,"product_type":"c1","uid":1309877,"ip_address":"","ucode":"68C7153ECAAC57","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/RNO4yZyBvic914hewmNNE8iblYDcfv5yGHZ9OnKuCuZXNmGR0F5qV3icKLT2xpMt66GyEpicZVvrmz8A6TIqt92MQg/132","comment_is_top":false,"comment_ctime":1564279174,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564279174","product_id":100020801,"comment_content":"老师 排序选择是。 如果内存够放全部数据 就快速排序算法，如果内存不够但根据limit的数量如果内存够放就优先队列排序。否者就归并排序法吗","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159896,"discussion_content":"是的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580738838,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117111,"user_name":"王斯拉","can_delete":false,"product_type":"c1","uid":1593957,"ip_address":"","ucode":"D00DD3CE432189","user_header":"https://static001.geekbang.org/account/avatar/00/18/52/65/320eccb3.jpg","comment_is_top":false,"comment_ctime":1563970648,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1563970648","product_id":100020801,"comment_content":"老师有个问题我不理解。<br>今天课程的2个例子，第一个要去整个表排序，第二个就只需要优先队列。为什么第一个例子不用队列优先排序呢，我理解只需要排3个，另外9997个根本不需要呢。。求解答","like_count":0,"discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298468,"discussion_content":"你操作一下就 能看出来，第一个其实也用了 优先排序呢，但要得到最小的3个，还是要和另外9777个进行比较才可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597305500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159901,"discussion_content":"因为tmp_table_size变成了1024，过渡到了磁盘临时表，此时可以采用优先队列排序。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580739224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114661,"user_name":"Robert","can_delete":false,"product_type":"c1","uid":1304095,"ip_address":"","ucode":"BC46EBC8B45E5A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e6/1f/1dca76e5.jpg","comment_is_top":false,"comment_ctime":1563358795,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1563358795","product_id":100020801,"comment_content":"老师，请教您一个问题。表a，有三个字段，id，name，age。id为主键，name为二级索引。<br>表的数据有(1,&#39;aa&#39;,12),(2,&#39;aa&#39;,23),(3,&#39;aa&#39;,32),(4,&#39;cc&#39;,33),(5,&#39;dd&#39;,24),....，假设一个页只能放两条数据，即id=1和id=3不再同一个数据页。<br>select * from a where name = ‘aa’；我这条语句如果走了name的索引，然后一条条回表。<br>问题是：第一个满足条件的，找到id=1回表，是将id=1所在的数据页刷到内存中，还是仅仅把id=1这一行刷到内存呢？我看老师一直说的是将这一行刷到内存，但是内存刷新到磁盘是以页的方式往下刷，并且覆盖。<br>问题二：如果回表的数据刷到内存是以单行来的话，怎样保证数据在这个页中的位置以及其他信息不变呢？怎样保证数据页从内存刷盘的时候，这个数据页可以直接覆盖呢？<br>问题三：如果回表刷到内存的是刷的满足条件的数据页，那当id=2回表的时候，发现id=1已经刷过一次到内存里了，这个页是不是就不会再往上刷了呢？这个信息记录在哪里呢？","like_count":0,"discussions":[{"author":{"id":1135593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/53/e9/f244988e.jpg","nickname":"NIRVANA","note":"","ucode":"F3A979679AA44E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291622,"discussion_content":"mysql都是按页来读的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594890444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113545,"user_name":"yhui","can_delete":false,"product_type":"c1","uid":1512714,"ip_address":"","ucode":"1AAAF47E41FFB8","user_header":"https://static001.geekbang.org/account/avatar/00/17/15/0a/c450e565.jpg","comment_is_top":false,"comment_ctime":1563074775,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563074775","product_id":100020801,"comment_content":"这个问题最优的解决还是把随机在应用程序里处理，然后组合sql查询即可","like_count":0},{"had_liked":false,"id":100361,"user_name":"Longerian","can_delete":false,"product_type":"c1","uid":1032464,"ip_address":"","ucode":"0B74EE70D09A2A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/10/28d5a686.jpg","comment_is_top":false,"comment_ctime":1559537209,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559537209","product_id":100020801,"comment_content":"有没有课程源码整理出来，这样大家可以对着参考 学习下","like_count":0},{"had_liked":false,"id":95709,"user_name":"冥王星","can_delete":false,"product_type":"c1","uid":1311603,"ip_address":"","ucode":"CA43C381A69736","user_header":"https://static001.geekbang.org/account/avatar/00/14/03/73/38397da1.jpg","comment_is_top":false,"comment_ctime":1558146443,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1558146443","product_id":100020801,"comment_content":"这里有一个问题，在使用order by rand()进行随机数据选择的时候，为什么要使用内存临时表呢，为什么不直接使用sort_buffer进行排序？另外，在这个方式中，为什么要进行两次排序，在内存临时表和sort_buffer之中进行了两次排序？","like_count":0,"discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298424,"discussion_content":"我也觉得如果内存表可以放下所有数据，sort_buffer也可以，就没必要使用内存表了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597296440,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159908,"discussion_content":"因为有随机啊，不能把这个因素丢掉。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580739318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298425,"discussion_content":"随机字段可以直接生成在sort _buffer 里，然后直接对sort_buffer 进行排序就可以了呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597296575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":159908,"ip_address":""},"score":298425,"extra":""}]}]},{"had_liked":false,"id":91972,"user_name":"MrVito","can_delete":false,"product_type":"c1","uid":1252169,"ip_address":"","ucode":"716FF6F8871706","user_header":"https://static001.geekbang.org/account/avatar/00/13/1b/49/ddefc656.jpg","comment_is_top":false,"comment_ctime":1557146456,"is_pvip":false,"replies":[{"id":"32859","content":"稳住~~<br><br>先提过一篇也是可以的😆<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1557155129,"ip_address":"","comment_id":91972,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1557146456","product_id":100020801,"comment_content":"好吧，到了这一课，我彻底崩溃！","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449099,"discussion_content":"稳住~~\n\n先提过一篇也是可以的😆\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557155129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":89250,"user_name":"kissrain","can_delete":false,"product_type":"c1","uid":1120583,"ip_address":"","ucode":"2177C53E3B2DCC","user_header":"https://static001.geekbang.org/account/avatar/00/11/19/47/b27f1314.jpg","comment_is_top":false,"comment_ctime":1556117037,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1556117037","product_id":100020801,"comment_content":"请教一下老师，内存临时表和sort_buffer的不同点在哪呢？既然sort_buffer可以用来进行排序，那么为什么还需要内存临时表，还有什么时候会用到内存临时表呢？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159911,"discussion_content":"如果sort_buffer需要额外的内存来做为处理排序的前提条件呢，那内存临时表就有用了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580739377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81475,"user_name":"Joey","can_delete":false,"product_type":"c1","uid":1322859,"ip_address":"","ucode":"AEC682E1A31AD9","user_header":"https://static001.geekbang.org/account/avatar/00/14/2f/6b/ea6aabac.jpg","comment_is_top":false,"comment_ctime":1553922255,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553922255","product_id":100020801,"comment_content":"(city,name) 有联合索引，in 也是会走索引的吧，用mysql 5.7测试下来会走索引<br>","like_count":0},{"had_liked":false,"id":79861,"user_name":"道","can_delete":false,"product_type":"c1","uid":1324160,"ip_address":"","ucode":"851A0AD751D317","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/80/30e9ae41.jpg","comment_is_top":false,"comment_ctime":1553565268,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1553565268","product_id":100020801,"comment_content":"内存临时表只有随机数和单词这两个字段，并没有记录位置信息，sortbuffer是如何从内存表获取位置信息的呢","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159915,"discussion_content":"内存临时表中有rowid","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580739414,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1135593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/53/e9/f244988e.jpg","nickname":"NIRVANA","note":"","ucode":"F3A979679AA44E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291623,"discussion_content":"看老师的内容是说得位置信息，其实相当于是数组的下标","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594890834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":159915,"ip_address":""},"score":291623,"extra":""}]}]},{"had_liked":false,"id":79599,"user_name":"big-new","can_delete":false,"product_type":"c1","uid":1343129,"ip_address":"","ucode":"5BFDEC5A641959","user_header":"https://static001.geekbang.org/account/avatar/00/14/7e/99/2d064061.jpg","comment_is_top":false,"comment_ctime":1553511084,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553511084","product_id":100020801,"comment_content":"当max_length_for_sort_data 这个值足够大时比如1024，<br>1、当第16章的order by name limit 3的情况时，默认会走全字段排序？<br>2、order by rand（）情况时 也是会直接走rowid排序，不会走全字段排序吗？<br>3、当max_length_for_sort_data足够大（1024），但tmp_table_size值特别特别小时，会走哪个排序？<br>思路优点不清楚，麻烦帮忙理理思路？<br><br>","like_count":0},{"had_liked":false,"id":79050,"user_name":"黄明恩","can_delete":false,"product_type":"c1","uid":1119409,"ip_address":"","ucode":"EF75C8BFA14D17","user_header":"https://static001.geekbang.org/account/avatar/00/11/14/b1/7d974f0a.jpg","comment_is_top":false,"comment_ctime":1553332495,"is_pvip":false,"replies":[{"id":"28796","content":"嗯 讨论的前提还是innodb表","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1553339630,"ip_address":"","comment_id":79050,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1553332495","product_id":100020801,"comment_content":"总扫描行数是 C+(Y1+1)+(Y2+1)+(Y3+1)，优化思路，一般这样的表都是静态的吧，可以考虑MyIsam引擎，C就变常数时间了。至于Y1,Y3,Y3有同学提到了，算Y1，其他两个<br>用相对随机做优化","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444339,"discussion_content":"嗯 讨论的前提还是innodb表","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553339630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78872,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1553265199,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553265199","product_id":100020801,"comment_content":"课后思考：<br>假设 Y1 &lt;= Y2 &lt;= Y3(0&lt;=Y&lt;=10000)<br>取 limit Y1, Y3-Y1<br>程序取列表的首，尾，再根据 Y2 与 Y1 的偏移量取 Y2。<br>扫描了 C+Y3 行。<br>缺点：如果Y1=0，Y3=10000，就全表返回了。","like_count":0},{"had_liked":false,"id":77724,"user_name":"思考特～","can_delete":false,"product_type":"c1","uid":1301824,"ip_address":"","ucode":"B9B4E64962BAD2","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/40/a185dfcb.jpg","comment_is_top":false,"comment_ctime":1552987106,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552987106","product_id":100020801,"comment_content":"select * from a;  --500条记录<br><br><br>SELECT DISTINCT<br>\tuuid() id,<br>\tname ,<br>\tnow(3) time<br>FROM<br>\ta<br>\t<br>--50条记录<br><br>name唯一行数只有50条，感觉这条sql的执行是先dintinct name，然后再产生uuid()，组合成结果返回<br><br>丁老师这是我最近发现一个问题，执行计划看不出什么过程，可否解释下执行过程？","like_count":0},{"had_liked":false,"id":72681,"user_name":"曼巴","can_delete":false,"product_type":"c1","uid":1185400,"ip_address":"","ucode":"794BACF765E2A8","user_header":"https://static001.geekbang.org/account/avatar/00/12/16/78/3f4a2104.jpg","comment_is_top":false,"comment_ctime":1551692009,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1551692009","product_id":100020801,"comment_content":"优先队列排序不实用临时表，而且扫描行数比使用临时表的方法要少，那为什么对于limit值比较小的order by语句还要使用临时表的方法","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159926,"discussion_content":"看tmp_table_size的值。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580739659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71503,"user_name":"Magic","can_delete":false,"product_type":"c1","uid":1272047,"ip_address":"","ucode":"FD9CEDAA419EB0","user_header":"https://static001.geekbang.org/account/avatar/00/13/68/ef/6264ca3d.jpg","comment_is_top":false,"comment_ctime":1551359094,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551359094","product_id":100020801,"comment_content":"回答一下今日课后题：利用随机函数rand()得到X，Y，Z后，取X，Y，Z的最大值，假设是X，然后select word from words limit X,1得到第一个随机值，利用读缓存，后面执行select word from words limit Y&#47;Z ,1时直接到缓存中查到word，不需要过引擎了，因此总的扫描行数就是C+X+1了<br>","like_count":0},{"had_liked":false,"id":69606,"user_name":"归心","can_delete":false,"product_type":"c1","uid":1036567,"ip_address":"","ucode":"985E3188A9F6FE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d1/17/356cc426.jpg","comment_is_top":false,"comment_ctime":1550796775,"is_pvip":false,"replies":[{"id":"24694","content":"你说得对，这里笔误的，应该是“越小越好”，发起勘误了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550798819,"ip_address":"","comment_id":69606,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550796775","product_id":100020801,"comment_content":"文章中提到在内存临时表中使用的是rowid排序，考虑因素除了数据在内存中不多访问磁盘外，优化器会优先考虑排序的行数。我的疑问是排序的行数对于全字段排序和rowid排序不是都一样吗？望老师解答，谢谢。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440183,"discussion_content":"你说得对，这里笔误的，应该是“越小越好”，发起勘误了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550798819,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69122,"user_name":"罗小喇叭","can_delete":false,"product_type":"c1","uid":1351630,"ip_address":"","ucode":"964BB2B8B68C7D","user_header":"https://static001.geekbang.org/account/avatar/00/14/9f/ce/58c35565.jpg","comment_is_top":false,"comment_ctime":1550665794,"is_pvip":false,"replies":[{"id":"24557","content":"你这里是假设如果没有删除，自增主键就是连续的，可以看下《39 | 自增主键为什么不是连续的？》😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550679547,"ip_address":"","comment_id":69122,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550665794","product_id":100020801,"comment_content":"总觉得在mysql语句上做运算会耗时很多，如果这个表在不删除数据的情况下，我拿到id的最大值和最小值，然后从这个数值区间随机取三个数（比如用PHP写），再从表中根据这三个id获取name值是不是也可以","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439962,"discussion_content":"你这里是假设如果没有删除，自增主键就是连续的，可以看下《39 | 自增主键为什么不是连续的？》😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550679547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":53784,"user_name":"极客童","can_delete":false,"product_type":"c1","uid":1250397,"ip_address":"","ucode":"D92EA8CA293B93","user_header":"https://static001.geekbang.org/account/avatar/00/13/14/5d/f4d789cc.jpg","comment_is_top":false,"comment_ctime":1545724568,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545724568","product_id":100020801,"comment_content":"上期问题，虽然想到归并排序，但是没觉得会手动重新排序，以为会有办法从sql下手，哈哈。<br>对归并排序，我认为可以select * from table limit 100 offset 10000，再计算，速度更快。","like_count":0},{"had_liked":false,"id":53265,"user_name":"郭江伟","can_delete":false,"product_type":"c1","uid":1313994,"ip_address":"","ucode":"613D638619B5A2","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/ca/6173350b.jpg","comment_is_top":false,"comment_ctime":1545620735,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545620735","product_id":100020801,"comment_content":"开发上将取三次随机值变成取一次随机值：<br>比如在算法3上求出Y 此时扫描的行数为C+Y+3<br>然后select * from t limit @Y ,3<br>如果y值非常大，可以考虑使用下面方法，此时扫描行数是C+(C-y)+3：<br>select * from t order by id desc  limit C-@Y,3<br>另外考虑到这种单词表的数量不一定很多（按照用户级别设置单词表），单个单词表不会很大（单词数量有限并且可以设置）取单词功能对用户体验非常重要，如果并发很大，可以考虑在系统启动时在内存中为每个单词表建立行号—ID映射表，这样随即算出取第Y行数据，得到对应行的id，直接用id从数据库获取需要的数据,redis可以很容易实现这种做法","like_count":0},{"had_liked":false,"id":52991,"user_name":"dzkk","can_delete":false,"product_type":"c1","uid":1301932,"ip_address":"","ucode":"A81EFDB1D43C0D","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/ac/f40bbd15.jpg","comment_is_top":false,"comment_ctime":1545565711,"is_pvip":false,"replies":[{"id":"19206","content":"删除不会变化，增加一般会变，除非是刚好之前有比较多的空闲空间，新索引需要的磁盘都是用的空闲空间。<br><br>你看一下专栏的《数据删了一半，…》这篇","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545572499,"ip_address":"","comment_id":52991,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545565711","product_id":100020801,"comment_content":"老师好，请教个问题，innodb引擎增加或者删除索引后，数据文件大小并无变化，重建表后文件大小才会变化，请问这是怎么回事，能否帮分析一下，谢谢。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434011,"discussion_content":"删除不会变化，增加一般会变，除非是刚好之前有比较多的空闲空间，新索引需要的磁盘都是用的空闲空间。\n\n你看一下专栏的《数据删了一半，…》这篇","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545572499,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52888,"user_name":"Chris","can_delete":false,"product_type":"c1","uid":1132777,"ip_address":"","ucode":"82056BBE2E4488","user_header":"https://static001.geekbang.org/account/avatar/00/11/48/e9/f7dba760.jpg","comment_is_top":false,"comment_ctime":1545547657,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545547657","product_id":100020801,"comment_content":"昨天遇到一个诡异的问题；猜测是mysql在做DDL的时候崩溃，导致表文件损坏；<br>[ERROR] InnoDB: The file &#39;.&#47;stt_member&#47;t_member_base_info_542.ibd&#39; already exists though the corresponding table did not exist in the InnoDB dat<br>a dictionary. Have you moved InnoDB .ibd files around without using the SQL commands DISCARD TABLESPACE and IMPORT TABLESPACE, or did mysqld crash in the middle of CREATE TABLE? You<br> can resolve the problem by removing the file &#39;.&#47;stt_member&#47;t_member_base_info_542.ibd&#39; under the &#39;datadir&#39; of MySQL.<br>从文件上观察，发现该表只有一个ibd文件，缺少frm文件，<br>1.首先尝试复制一个frm，然后执行drop table base_info_542,执行成功，但还是无法重建该表，提示已经存在，但通过各种方式均无法查看到该表；<br>2.然后尝试将整个库删除，然后导入该库，发现该表仍然无法创建；重启实例后，报如下错：<br>[Warning] InnoDB: Tablespace &#39;stt_member&#47;t_member_base_info_542&#39; exists in the cache with id 40297 != 61817<br>3.最后尝试将redo日志移走后重启实例，迁移回来再重启，该表才能创建成功；因此怀疑是redo日志中包含该表执行alter table的操作，结果执行过程中，实例崩溃，导致该表文件损坏；然后每次重启，mysql都会进行崩溃恢复，导致每次重启后该表都不正常；反而是迁移走redo日志后，再重启后才恢复正常，应该是数据文件的lsn已经大于了redo的lsn，所以才不会尝试进行恢复。<br>以上很多都是猜测，这里比较疑惑的是，<br>1.表结构信息一般会保留几分，为什么查看物理文件已经不存在了，还会报表文件已经存在，而且删除表后，依然无法重建；即使整个库都删除，删除的时候也发现提示说RROR 1010 (HY000): Error dropping database (can&#39;t rmdir &#39;.&#47;stt_member&#39;, errno: 39);<br>2.mysql通过redo日志做崩溃恢复时，对DDL语句的恢复步骤有什么特殊之处么；<br>3.遇到这种情况，除了删除redo日志，然后重启实例，还有更好的方法么，因为只是一个表损坏了，但尝试各种方法也无法删除，无法重建，通过删除整个实例的redo日志的方式恢复，代价有点高；<br>这个问题困扰了蛮久，可能学艺不精，有些地方感觉有点不好理解😄","like_count":0},{"had_liked":false,"id":52740,"user_name":"长杰","can_delete":false,"product_type":"c1","uid":1312212,"ip_address":"","ucode":"DD52C9494005F7","user_header":"https://static001.geekbang.org/account/avatar/00/14/05/d4/e06bf86d.jpg","comment_is_top":false,"comment_ctime":1545492703,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545492703","product_id":100020801,"comment_content":"对y排序，假如y1最小，y3最大，可以limit y1,（y3+1-y1），取出结果后，根据y1,y2,y3的差值，从结果集中找到y1+1,y2+1,y3+1","like_count":0},{"had_liked":false,"id":52739,"user_name":"Scott","can_delete":false,"product_type":"c1","uid":1014800,"ip_address":"","ucode":"7E57FDCB5E5D49","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/10/165cb374.jpg","comment_is_top":false,"comment_ctime":1545492183,"is_pvip":false,"replies":[{"id":"19174","content":"这一讲确实比较难，如果目前看比较吃力，可以直接跳到结论部分和最后的方案讨论部分","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545509796,"ip_address":"","comment_id":52739,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545492183","product_id":100020801,"comment_content":"说实话，对于应用开发人员来讲，这个看得不是一般的吃力，如果要平滑难度，我可以去看什么书或者资料。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433966,"discussion_content":"这一讲确实比较难，如果目前看比较吃力，可以直接跳到结论部分和最后的方案讨论部分","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545509796,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52701,"user_name":"信信","can_delete":false,"product_type":"c1","uid":1303865,"ip_address":"","ucode":"8DF0EC045579FD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg","comment_is_top":false,"comment_ctime":1545480958,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545480958","product_id":100020801,"comment_content":"老师，您好，您在上篇文章中图2下的第六点提到“对 sort_buffer 中的数据按照字段 name 做快速排序”；本篇文章说MYSQL5.6之后引入优先队列排序的。那我可以理解为，当不需要临时文件时，MYSQL5.6之前，sort_buffer 中的数据采用快速排序；MYSQL5.6之后，sort_buffer 中的数据采用优先队列排序吗？","like_count":0},{"had_liked":false,"id":52561,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1545438405,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545438405","product_id":100020801,"comment_content":"临时表排序，1临时表有内存临时表和磁盘临时表，默认内存临时表配置大小16M，超过了就用硬盘临时表。extro里面有using temporary和using filesort表示使用临时表，对临时表排序。2 临时表排序过程，把临时表读到内存中，优先使用rowid排序，将rowid和排序字段放到sort_buffer里面，优先级队列排序，limit取前几行，拿着rowid去临时表找对应的数据。3sort_buffer排序，limit条数比较少，维护一个堆，优先级对列排序。如果limit条数多用快排，如果超过了sort_buffer_size，用归并排序。","like_count":0},{"had_liked":false,"id":52524,"user_name":"银太","can_delete":false,"product_type":"c1","uid":1051765,"ip_address":"","ucode":"B505D15F7CB839","user_header":"https://static001.geekbang.org/account/avatar/00/10/0c/75/e7c6c403.jpg","comment_is_top":false,"comment_ctime":1545405013,"is_pvip":false,"replies":[{"id":"19151","content":"现在极客时间系统还不支持…<br><br>从你这个死锁信息看就是这样的，<br><br>要控制事务中的顺序","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545410466,"ip_address":"","comment_id":52524,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545405013","product_id":100020801,"comment_content":"是有其他语句，包括这个表的其他update和其他表的insert和update。猜想可能是两个事务有相同的记录需要更新，互相持有了不同记录的唯一索引x锁。<br>目前是改为了现查出来通过主键去更新，但感觉不能解决这个问题。<br>比如事务1更新AB，事务2更新BA，那么还是可能事务1持有A的行锁等待B的行锁，事务2相反。不知是否正确，请老师指正。<br>另外这个怎么在原留言回复啊？😂","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433900,"discussion_content":"现在极客时间系统还不支持…\n\n从你这个死锁信息看就是这样的，\n\n要控制事务中的顺序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545410466,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52523,"user_name":"Against all odds","can_delete":false,"product_type":"c1","uid":1177919,"ip_address":"","ucode":"9A5F78691CE912","user_header":"https://static001.geekbang.org/account/avatar/00/11/f9/3f/9b8c205b.jpg","comment_is_top":false,"comment_ctime":1545404716,"is_pvip":false,"replies":[{"id":"19153","content":"好吧，这是改题目😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545412801,"ip_address":"","comment_id":52523,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1545404716","product_id":100020801,"comment_content":"个人觉得随机取N条和随机取1条是一样的，可以直接直接写成limit @Y,N;业务逻辑上应该没什么区别","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433899,"discussion_content":"好吧，这是改题目😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545412801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159940,"discussion_content":"连着取N条也算是随机，因为Y是不同的嘛。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580740047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52518,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1545403945,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1545403945","product_id":100020801,"comment_content":"关于联合索引再追问一个问题（基于两个字段简单拼接的前提）：<br>在一个表中使用联合唯一索引 col0 及 col1，有如下两行数据：<br>col0       col1<br>1            11<br>11           1<br><br>拼接后的数据都是111，不符合联合唯一索引的要求，所以肯定不是简单拼接的，MySQL底层做了什么处理呢","like_count":0},{"had_liked":false,"id":52481,"user_name":"唐名之","can_delete":false,"product_type":"c1","uid":1004394,"ip_address":"","ucode":"F472C71E043E03","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/JKKWS6TzhncvAA0p0NDiaATPIvMicSM76vNAg9IG1ibibcJYPAiaicYjZfq4gAV8GRtcTpOibfRD8vzqHBtL0ibmhwQsbg/132","comment_is_top":false,"comment_ctime":1545390960,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545390960","product_id":100020801,"comment_content":"1：既然是首页说明是热点数据首先考虑是否应该用NoSql缓存；<br>2：单独用字段一个字段做递增操作，随机三个数为递增范围内的查；","like_count":0},{"had_liked":false,"id":52428,"user_name":"夜空中最亮的星","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1545380369,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545380369","product_id":100020801,"comment_content":"定了专栏 跟着学了这些天，计划19 年看的第一本 就是 《高性能mysql》有了老师的专栏做基础 就不怕了","like_count":0},{"had_liked":false,"id":52422,"user_name":"风动草","can_delete":false,"product_type":"c1","uid":1303051,"ip_address":"","ucode":"6ED975DC4DD0D0","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/0b/e3c8765a.jpg","comment_is_top":false,"comment_ctime":1545379879,"is_pvip":false,"replies":[{"id":"19126","content":"“整个表A按照字段B分组排序”，并没有哦。B只需要把表的主键取出来构造索引就可以，A表原来的主键索引树是不需要动的<br><br>要读全表。<br><br><br>第二个问题，会变大，新索引占了额外空间的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545401253,"ip_address":"","comment_id":52422,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545379879","product_id":100020801,"comment_content":"丁奇老师，好！<br>      一直默默看，今天对索引方面有一些疑问：<br>1.虽然我理解了二级索引的叶子便是主键索引的值，主键索引的叶子便是具体数据。问题来了，索引在物理层面，是和数据绑定在一起的，是不是我在A表的B字段创建一个二级索引叫indexB，就意味着整个A表就按照B字段做了一次数据格式化的分组并排序。做这个操作的过程，是否是读全表呢？另外在创建索引结束后，原先没有二级索引的A表在没有第三方因素（比如碎片整理）的干扰下，是否理论表会变大？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433870,"discussion_content":"“整个表A按照字段B分组排序”，并没有哦。B只需要把表的主键取出来构造索引就可以，A表原来的主键索引树是不需要动的\n\n要读全表。\n\n\n第二个问题，会变大，新索引占了额外空间的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545401253,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52400,"user_name":"aeli","can_delete":false,"product_type":"c1","uid":1143750,"ip_address":"","ucode":"E8BA0D5B99FE08","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKBeLeMAng7hIAuuPVe5wn1kzXVVFgvkIbqzoj0vnj2G88YUmqVeL3rmSdaERbe1yRrA4qBL5GXUg/132","comment_is_top":false,"comment_ctime":1545375651,"is_pvip":false,"replies":[{"id":"19064","content":"额你这个改了需求，不是随机，而是顺序😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545380075,"ip_address":"","comment_id":52400,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545375651","product_id":100020801,"comment_content":"我考虑的方法是产品上的，特别这种随机需求要求不能重复出现上次用户浏览过的单词时。<br>我会采用生成一个单词的乱序表，比如3k单词，我会生成3000*3000行，单词id，随机type，的新表。然后用户hash或随机指定一个type类型，选择一个随机顺序后，依序显示这3000个单词，这样用户只需要记录上次显示的单词序列游标，然后取大于这个id的3个值就行。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433859,"discussion_content":"额你这个改了需求，不是随机，而是顺序😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545380075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52397,"user_name":"布衣骇客","can_delete":false,"product_type":"c1","uid":1256280,"ip_address":"","ucode":"5226B0F67090D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/2b/58/11c05ccb.jpg","comment_is_top":false,"comment_ctime":1545375298,"is_pvip":false,"replies":[{"id":"19065","content":"额，这个是数据结构的“堆”哈<br>临时表查完就删除，跟GC不太一样<br>内存和缓存是啥区别？是在内存中，如果内存不够就磁盘","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545380146,"ip_address":"","comment_id":52397,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545375298","product_id":100020801,"comment_content":"老师好，这里的堆和jvm中的堆有什么区别和联系呢？还有临时表(生命周期)生存和销毁的过程又是怎么样的呢？是有类似jvm中的GC来处理吗？还有临时表是在缓存中？还是在内存中的呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433858,"discussion_content":"额，这个是数据结构的“堆”哈\n临时表查完就删除，跟GC不太一样\n内存和缓存是啥区别？是在内存中，如果内存不够就磁盘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545380146,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52396,"user_name":"一块跑跑","can_delete":false,"product_type":"c1","uid":1177796,"ip_address":"","ucode":"576EC5A37721FD","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/c4/c7f665df.jpg","comment_is_top":false,"comment_ctime":1545375174,"is_pvip":false,"replies":[{"id":"19066","content":"你说的是哪个过程，内存里还是磁盘里…","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545380181,"ip_address":"","comment_id":52396,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1545375174","product_id":100020801,"comment_content":"老师，在这个示例中，排序过程中 pos 位置信息存的是主键 id 吧？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433857,"discussion_content":"你说的是哪个过程，内存里还是磁盘里…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545380181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159946,"discussion_content":"pos位置存的是row id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580740145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52383,"user_name":"吴亚楠","can_delete":false,"product_type":"c1","uid":1285800,"ip_address":"","ucode":"9582C4086FD13E","user_header":"https://static001.geekbang.org/account/avatar/00/13/9e/a8/09106237.jpg","comment_is_top":false,"comment_ctime":1545373006,"is_pvip":false,"replies":[{"id":"19067","content":"我们方法1就是这么做的😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545380222,"ip_address":"","comment_id":52383,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545373006","product_id":100020801,"comment_content":"其实很简单的，找出最大id 和 最小id，然后应用端求出三个随机的id，然后直接select word from table where id &gt;= id，这样就行了，主要是这个条件转换成&gt;= ，这样就不怕空洞问题了，只是可能不是特别随机，会有一些单词拿到的概率较大一些了。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433854,"discussion_content":"我们方法1就是这么做的😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545380222,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52370,"user_name":"滔滔","can_delete":false,"product_type":"c1","uid":1303342,"ip_address":"","ucode":"6968B5771AF79D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg","comment_is_top":false,"comment_ctime":1545370212,"is_pvip":false,"replies":[{"id":"19031","content":"不会，update直接拿X","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545372084,"ip_address":"","comment_id":52370,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545370212","product_id":100020801,"comment_content":"老师，想请教一个问题:在RR隔离级别下，表a有id,name两列，只有id一个聚簇索引，name列没有索引，两边同时执行update a set name = &#39;aaa&#39; where id = 1,会不会出现这种情况，update是先获得S锁，再获得X锁，两个并发事务碰巧同时获得了这条记录的S锁，同时去求X锁，发生死锁呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433849,"discussion_content":"不会，update直接拿X","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545372084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52362,"user_name":"undifined","can_delete":false,"product_type":"c1","uid":1068920,"ip_address":"","ucode":"449CB4CD2DC089","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg","comment_is_top":false,"comment_ctime":1545367855,"is_pvip":false,"replies":[{"id":"19033","content":"如果保证没空洞，不用扫描全部来得到C，可以通过max() min()相减得到C😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545372288,"ip_address":"","comment_id":52362,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545367855","product_id":100020801,"comment_content":"我设计这个功能的思路是在业务代码里先读取word 表里的最大和最小 ID，然后随机生成三个整数当做ID 进行查询，这样就可以避免在数据库排序，只需要访问两次数据库；或者写一个存储过程实现这个逻辑，只需要一次访问；老师您觉得这样合理吗<br>-----------<br>是不是就是我们的方法一的思路？<br>-----------<br>是同样的思路<br>补充一下就是 在业务代码中做先扫描总行数C，根据 C 生成三个随机数作为主键进行查询，扫描行数为 C + 3；当然这种方法应该保证主键 ID 没有空洞","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433845,"discussion_content":"如果保证没空洞，不用扫描全部来得到C，可以通过max() min()相减得到C😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545372288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52327,"user_name":"Victor","can_delete":false,"product_type":"c1","uid":1003903,"ip_address":"","ucode":"801413B2B5C7B5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/51/7f/c74e3543.jpg","comment_is_top":false,"comment_ctime":1545362995,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545362995","product_id":100020801,"comment_content":"算法3中，Y1, Y2, Y3 这三个生成的随机数，假如有重复的话，会不满足业务的要求。<br>所以这里的取三次SQL语句的拼接，最好做在业务端，每次取回的结果放在 set 中，知道三条不同的单次记录。","like_count":0},{"had_liked":false,"id":52309,"user_name":"rabbitlog","can_delete":false,"product_type":"c1","uid":1002916,"ip_address":"","ucode":"6771E633362807","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/a4/78ccca46.jpg","comment_is_top":false,"comment_ctime":1545360810,"is_pvip":false,"replies":[{"id":"19018","content":"这两个都是不错的思路<br><br>1的话在数据量不大的时候效果还是不错的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545364494,"ip_address":"","comment_id":52309,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545360810","product_id":100020801,"comment_content":"有两个思路：<br>1. 把主键id 全部查询出来，然后在应用层直接 rand 出来对应的 id，最后直接查询对应的 id 就好。<br>2. 可以把问题处理一下，不追求完备的方案，比如，<br>C = count(*) from t<br>start = rand(1, C);<br>select id from t order by id asc limit  start, 100<br>然后从 100 个随机选择 3 个。 <br>这是一个伪随机的算法，但是对于应用来说可以满足了。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433828,"discussion_content":"这两个都是不错的思路\n\n1的话在数据量不大的时候效果还是不错的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545364494,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52244,"user_name":"undifined","can_delete":false,"product_type":"c1","uid":1068920,"ip_address":"","ucode":"449CB4CD2DC089","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg","comment_is_top":false,"comment_ctime":1545354031,"is_pvip":false,"replies":[{"id":"19000","content":"不是简单转移，在客户端不需要没排序；<br>嗯，后面你几个描述都对<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545361631,"ip_address":"","comment_id":52244,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545354031","product_id":100020801,"comment_content":"老师，上节课后题的答案，从操作来看其实是把排序的压力转移到了客户端，如果用数据库排序反而简单；如果我把索引改为 name_city，这样是不是可以避免排序，但是这样有可能会扫描所有的数据；如果考虑排序，那么 city_name 是不是更好的选择；如果有很多个城市一起排序，那么 name_city 是不是更好一些","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433802,"discussion_content":"不是简单转移，在客户端不需要没排序；\n嗯，后面你几个描述都对\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545361631,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52236,"user_name":"小新","can_delete":false,"product_type":"c1","uid":1246916,"ip_address":"","ucode":"A5A6F142D7BC44","user_header":"https://static001.geekbang.org/account/avatar/00/13/06/c4/11c9aa38.jpg","comment_is_top":false,"comment_ctime":1545353757,"is_pvip":false,"replies":[{"id":"19004","content":"嗯，考虑下这个表暴涨的情况（当然单词是涨不到哪去，如果是别的业务就要小心）","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545361752,"ip_address":"","comment_id":52236,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545353757","product_id":100020801,"comment_content":"我觉得这种需求用redis实现比较好吧(个人理解)，我查询出这个用户的单词放入redis中，然后每次增加或减少就更新redis，然后直接再redis中随机返回这三个单词，我觉得这样也可以","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433797,"discussion_content":"嗯，考虑下这个表暴涨的情况（当然单词是涨不到哪去，如果是别的业务就要小心）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545361752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52221,"user_name":"undifined","can_delete":false,"product_type":"c1","uid":1068920,"ip_address":"","ucode":"449CB4CD2DC089","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg","comment_is_top":false,"comment_ctime":1545352989,"is_pvip":false,"replies":[{"id":"19005","content":"是不是就是我们的方法一的思路？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545361790,"ip_address":"","comment_id":52221,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545352989","product_id":100020801,"comment_content":"我设计这个功能的思路是在业务代码里先读取word 表里的最大和最小 ID，然后随机生成三个整数当做ID 进行查询，这样就可以避免在数据库排序，只需要访问两次数据库；或者写一个存储过程实现这个逻辑，只需要一次访问；老师您觉得这样合理吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433789,"discussion_content":"是不是就是我们的方法一的思路？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545361790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}