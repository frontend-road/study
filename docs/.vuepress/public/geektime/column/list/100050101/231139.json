{"id":231139,"title":"07 | SocketServerï¼ˆä¸Šï¼‰ï¼šKafkaåˆ°åº•æ˜¯æ€ä¹ˆåº”ç”¨NIOå®ç°ç½‘ç»œé€šä¿¡çš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬æ¥è¯´è¯´Kafkaåº•å±‚çš„NIOé€šä¿¡æœºåˆ¶æºç ã€‚</p><p>åœ¨è°ˆåˆ°Kafkaé«˜æ€§èƒ½ã€é«˜ååé‡å®ç°åŸç†çš„æ—¶å€™ï¼Œå¾ˆå¤šäººéƒ½å¯¹å®ƒä½¿ç”¨äº†Java NIOè¿™ä»¶äº‹æ´¥æ´¥ä¹é“ã€‚å®é™…ä¸Šï¼Œææ‡‚â€œKafkaç©¶ç«Ÿæ˜¯æ€ä¹ˆåº”ç”¨NIOæ¥å®ç°ç½‘ç»œé€šä¿¡çš„â€ï¼Œä¸ä»…æ˜¯æˆ‘ä»¬æŒæ¡Kafkaè¯·æ±‚å…¨æµç¨‹å¤„ç†çš„å‰ææ¡ä»¶ï¼Œå¯¹æˆ‘ä»¬äº†è§£Reactoræ¨¡å¼çš„å®ç°å¤§æœ‰è£¨ç›Šï¼Œè€Œä¸”è¿˜èƒ½å¸®åŠ©æˆ‘ä»¬è§£å†³å¾ˆå¤šå®é™…é—®é¢˜ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œå½“Brokerå¤„ç†é€Ÿåº¦å¾ˆæ…¢ã€éœ€è¦ä¼˜åŒ–çš„æ—¶å€™ï¼Œä½ åªæœ‰æ˜ç¡®çŸ¥é“SocketServerç»„ä»¶çš„å·¥ä½œåŸç†ï¼Œæ‰èƒ½åˆ¶å®šå‡ºæ°å½“çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶æœ‰é’ˆå¯¹æ€§åœ°ç»™å‡ºå¯¹åº”çš„è°ƒä¼˜å‚æ•°ã€‚</p><p>é‚£ä¹ˆï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ‹¿ä¸‹è¿™ä¸ªè‡³å…³é‡è¦çš„NIOé€šä¿¡æœºåˆ¶å§ã€‚</p><h2>ç½‘ç»œé€šä¿¡å±‚</h2><p>åœ¨æ·±å…¥å­¦ä¹ Kafkaå„ä¸ªç½‘ç»œç»„ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»æ•´ä½“ä¸Šçœ‹ä¸€ä¸‹å®Œæ•´çš„ç½‘ç»œé€šä¿¡å±‚æ¶æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/52/e8/52c3226ad4736751b4b1ccfcb2a09ee8.jpg?wh=2079*2053\" alt=\"\"></p><p>å¯ä»¥çœ‹å‡ºï¼ŒKafkaç½‘ç»œé€šä¿¡ç»„ä»¶ä¸»è¦ç”±ä¸¤å¤§éƒ¨åˆ†æ„æˆï¼š<strong>SocketServer</strong>å’Œ<strong>KafkaRequestHandlerPool</strong>ã€‚</p><p><strong>SocketServerç»„ä»¶æ˜¯æ ¸å¿ƒ</strong>ï¼Œä¸»è¦å®ç°äº†Reactoræ¨¡å¼ï¼Œç”¨äºå¤„ç†å¤–éƒ¨å¤šä¸ªClientsï¼ˆè¿™é‡Œçš„ClientsæŒ‡çš„æ˜¯å¹¿ä¹‰çš„Clientsï¼Œå¯èƒ½åŒ…å«Producerã€Consumeræˆ–å…¶ä»–Brokerï¼‰çš„å¹¶å‘è¯·æ±‚ï¼Œå¹¶è´Ÿè´£å°†å¤„ç†ç»“æœå°è£…è¿›Responseä¸­ï¼Œè¿”è¿˜ç»™Clientsã€‚</p><!-- [[[read_end]]] --><p><strong>KafkaRequestHandlerPoolç»„ä»¶å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„I/Oçº¿ç¨‹æ± </strong>ï¼Œé‡Œé¢å®šä¹‰äº†è‹¥å¹²ä¸ªI/Oçº¿ç¨‹ï¼Œç”¨äºæ‰§è¡ŒçœŸå®çš„è¯·æ±‚å¤„ç†é€»è¾‘ã€‚</p><p>ä¸¤è€…çš„äº¤äº’ç‚¹åœ¨äºSocketServerä¸­å®šä¹‰çš„RequestChannelå¯¹è±¡å’ŒProcessorçº¿ç¨‹ã€‚å¯¹äº†ï¼Œæˆ‘æ‰€è¯´çš„çº¿ç¨‹ï¼Œåœ¨ä»£ç ä¸­æœ¬è´¨ä¸Šéƒ½æ˜¯Runnableç±»å‹ï¼Œä¸ç®¡æ˜¯Acceptorç±»ã€Processorç±»ï¼Œè¿˜æ˜¯åé¢æˆ‘ä»¬ä¼šå•ç‹¬è®¨è®ºçš„KafkaRequestHandlerç±»ã€‚</p><p>è®²åˆ°è¿™é‡Œï¼Œæˆ‘ç¨å¾®æç¤ºä½ ä¸€ä¸‹ã€‚åœ¨ç¬¬9èŠ‚è¯¾ï¼Œæˆ‘ä¼šç»™å‡ºKafkaRequestHandlerPoolçº¿ç¨‹æ± çš„è¯¦ç»†ä»‹ç»ã€‚ä½†ä½ ç°åœ¨éœ€è¦çŸ¥é“çš„æ˜¯ï¼ŒKafkaRequestHandlerPoolçº¿ç¨‹æ± å®šä¹‰äº†å¤šä¸ªKafkaRequestHandlerçº¿ç¨‹ï¼Œè€ŒKafkaRequestHandlerçº¿ç¨‹æ˜¯çœŸæ­£å¤„ç†è¯·æ±‚é€»è¾‘çš„åœ°æ–¹ã€‚å’ŒKafkaRequestHandlerç›¸æ¯”ï¼Œä»Šå¤©æ‰€è¯´çš„Acceptorå’ŒProcessorçº¿ç¨‹ä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œåªèƒ½ç®—æ˜¯è¯·æ±‚å’Œå“åº”çš„â€œæ¬è¿å·¥â€ç½¢äº†ã€‚</p><p>äº†è§£äº†å®Œæ•´çš„ç½‘ç»œé€šä¿¡å±‚æ¶æ„ä¹‹åï¼Œæˆ‘ä»¬è¦é‡ç‚¹å…³æ³¨ä¸€ä¸‹SocketServerç»„ä»¶ã€‚<strong>è¿™ä¸ªç»„ä»¶æ˜¯Kafkaç½‘ç»œé€šä¿¡å±‚ä¸­æœ€é‡è¦çš„å­æ¨¡å—ã€‚å®ƒä¸‹è¾–çš„Acceptorçº¿ç¨‹ã€Processorçº¿ç¨‹å’ŒRequestChannelç­‰å¯¹è±¡ï¼Œéƒ½æ˜¯å®æ–½ç½‘ç»œé€šä¿¡çš„é‡è¦ç»„æˆéƒ¨åˆ†</strong>ã€‚ä½ å¯èƒ½ä¼šæ„Ÿåˆ°æ„å¤–çš„æ˜¯ï¼Œè¿™å¥—çº¿ç¨‹ç»„åˆåœ¨æºç ä¸­æœ‰å¤šå¥—ï¼Œåˆ†åˆ«å…·æœ‰ä¸åŒçš„ç”¨é€”ã€‚åœ¨ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä¼šå…·ä½“è·Ÿä½ åˆ†äº«ä¸€ä¸‹ï¼Œä¸åŒçš„çº¿ç¨‹ç»„åˆä¼šè¢«åº”ç”¨åˆ°å“ªäº›å®é™…åœºæ™¯ä¸­ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬è¿›å…¥åˆ°SocketServerç»„ä»¶çš„å­¦ä¹ ã€‚</p><h2>SocketServeræ¦‚è§ˆ</h2><p>SocketServerç»„ä»¶çš„æºç ä½äºKafkaå·¥ç¨‹çš„coreåŒ…ä¸‹ï¼Œå…·ä½“ä½ç½®æ˜¯src/main/scala/kafka/networkè·¯å¾„ä¸‹çš„SocketServer.scalaæ–‡ä»¶ã€‚</p><p>SocketServer.scalaå¯è°“æ˜¯å…ƒè€çº§çš„æºç æ–‡ä»¶äº†ã€‚åœ¨Kafkaçš„æºç æ¼”è¿›å†å²ä¸­ï¼Œå¾ˆå¤šä»£ç æ–‡ä»¶è¿›è¿›å‡ºå‡ºï¼Œè¿™ä¸ªæ–‡ä»¶å´ä¸€ç›´â€œåšå¼ºåœ°æ´»ç€â€ï¼Œè€Œä¸”è¿˜åœ¨ä¸æ–­å®Œå–„ã€‚å¦‚æœç¿»å¼€å®ƒçš„Gitä¿®æ”¹å†å²ï¼Œä½ ä¼šå‘ç°ï¼Œå®ƒæœ€æ—©çš„ä¿®æ”¹æäº¤å†å²å¯å›æº¯åˆ°2011å¹´8æœˆï¼Œè¶³è§å®ƒçš„èµ„å†ä¹‹è€ã€‚</p><p>ç›®å‰ï¼ŒSocketServer.scalaæ–‡ä»¶æ˜¯ä¸€ä¸ªè¿‘2000è¡Œçš„å¤§æ–‡ä»¶ï¼Œå…±æœ‰8ä¸ªä»£ç éƒ¨åˆ†ã€‚æˆ‘ä½¿ç”¨ä¸€å¼ æ€ç»´å¯¼å›¾å¸®ä½ æ¢³ç†ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/18/18/18b39a0fe7817bf6c2344bf6b49eaa18.jpg?wh=2569*3387\" alt=\"\"></p><p>ä¹ä¸€çœ‹ç»„ä»¶æœ‰å¾ˆå¤šï¼Œä½†ä½ ä¹Ÿä¸å¿…æ‹…å¿ƒï¼Œæˆ‘å…ˆå¯¹è¿™äº›ç»„ä»¶åšä¸ªç®€å•çš„ä»‹ç»ï¼Œç„¶åæˆ‘ä»¬é‡ç‚¹å­¦ä¹ ä¸€ä¸‹Acceptorç±»å’ŒProcessorç±»çš„æºç ã€‚æ¯•ç«Ÿï¼Œ<strong>è¿™ä¸¤ä¸ªç±»æ˜¯å®ç°ç½‘ç»œé€šä¿¡çš„å…³é”®éƒ¨ä»¶</strong>ã€‚å¦å¤–ï¼Œä»Šå¤©æˆ‘ç»™å‡ºçš„éƒ½æ˜¯SocketServerç»„ä»¶çš„åŸºæœ¬æƒ…å†µä»‹ç»ï¼Œä¸‹èŠ‚è¯¾æˆ‘å†è¯¦ç»†å‘ä½ å±•ç¤ºå®ƒçš„å®šä¹‰ã€‚</p><p>1.<strong>AbstractServerThreadç±»</strong>ï¼šè¿™æ˜¯Acceptorçº¿ç¨‹å’ŒProcessorçº¿ç¨‹çš„æŠ½è±¡åŸºç±»ï¼Œå®šä¹‰äº†è¿™ä¸¤ä¸ªçº¿ç¨‹çš„å…¬æœ‰æ–¹æ³•ï¼Œå¦‚shutdownï¼ˆå…³é—­çº¿ç¨‹ï¼‰ç­‰ã€‚æˆ‘ä¸ä¼šé‡ç‚¹å±•å¼€è¿™ä¸ªæŠ½è±¡ç±»çš„ä»£ç ï¼Œä½†ä½ è¦é‡ç‚¹å…³æ³¨ä¸‹CountDownLatchç±»åœ¨çº¿ç¨‹å¯åŠ¨å’Œçº¿ç¨‹å…³é—­æ—¶çš„ä½œç”¨ã€‚</p><p>å¦‚æœä½ è‹¦äºå¯»æ‰¾Javaçº¿ç¨‹å®‰å…¨ç¼–ç¨‹çš„æœ€ä½³å®è·µæ¡ˆä¾‹ï¼Œé‚£ä¸€å®šä¸è¦é”™è¿‡CountDownLatchè¿™ä¸ªç±»ã€‚Kafkaä¸­çš„çº¿ç¨‹æ§åˆ¶ä»£ç å¤§é‡ä½¿ç”¨äº†åŸºäºCountDownLatchçš„ç¼–ç¨‹æŠ€æœ¯ï¼Œä¾æ‰˜äºå®ƒæ¥å®ç°ä¼˜é›…çš„çº¿ç¨‹å¯åŠ¨ã€çº¿ç¨‹å…³é—­ç­‰æ“ä½œã€‚å› æ­¤ï¼Œæˆ‘å»ºè®®ä½ ç†Ÿç»ƒæŒæ¡å®ƒä»¬ï¼Œå¹¶åº”ç”¨åˆ°ä½ æ—¥åçš„å·¥ä½œå½“ä¸­å»ã€‚</p><p>2.<strong>Acceptorçº¿ç¨‹ç±»</strong>ï¼šè¿™æ˜¯æ¥æ”¶å’Œåˆ›å»ºå¤–éƒ¨TCPè¿æ¥çš„çº¿ç¨‹ã€‚æ¯ä¸ªSocketServerå®ä¾‹åªä¼šåˆ›å»ºä¸€ä¸ªAcceptorçº¿ç¨‹ã€‚å®ƒçš„å”¯ä¸€ç›®çš„å°±æ˜¯åˆ›å»ºè¿æ¥ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„Requestä¼ é€’ç»™ä¸‹æ¸¸çš„Processorçº¿ç¨‹å¤„ç†ã€‚</p><p>3.<strong>Processorçº¿ç¨‹ç±»</strong>ï¼šè¿™æ˜¯å¤„ç†å•ä¸ªTCPè¿æ¥ä¸Šæ‰€æœ‰è¯·æ±‚çš„çº¿ç¨‹ã€‚æ¯ä¸ªSocketServerå®ä¾‹é»˜è®¤åˆ›å»ºè‹¥å¹²ä¸ªï¼ˆnum.network.threadsï¼‰Processorçº¿ç¨‹ã€‚Processorçº¿ç¨‹è´Ÿè´£å°†æ¥æ”¶åˆ°çš„Requestæ·»åŠ åˆ°RequestChannelçš„Requesté˜Ÿåˆ—ä¸Šï¼ŒåŒæ—¶è¿˜è´Ÿè´£å°†Responseè¿”è¿˜ç»™Requestå‘é€æ–¹ã€‚</p><p>4.<strong>Processorä¼´ç”Ÿå¯¹è±¡ç±»</strong>ï¼šä»…ä»…å®šä¹‰äº†ä¸€äº›ä¸Processorçº¿ç¨‹ç›¸å…³çš„å¸¸è§ç›‘æ§æŒ‡æ ‡å’Œå¸¸é‡ç­‰ï¼Œå¦‚Processorçº¿ç¨‹ç©ºé—²ç‡ç­‰ã€‚</p><p>5.<strong>ConnectionQuotasç±»</strong>ï¼šæ˜¯æ§åˆ¶è¿æ¥æ•°é…é¢çš„ç±»ã€‚æˆ‘ä»¬èƒ½å¤Ÿè®¾ç½®å•ä¸ªIPåˆ›å»ºBrokerè¿æ¥çš„æœ€å¤§æ•°é‡ï¼Œä»¥åŠå•ä¸ªBrokerèƒ½å¤Ÿå…è®¸çš„æœ€å¤§è¿æ¥æ•°ã€‚</p><p>6.<strong>TooManyConnectionsExceptionç±»</strong>ï¼šSocketServerå®šä¹‰çš„ä¸€ä¸ªå¼‚å¸¸ç±»ï¼Œç”¨äºæ ‡è¯†è¿æ¥æ•°é…é¢è¶…é™æƒ…å†µã€‚</p><p>7.<strong>SocketServerç±»</strong>ï¼šå®ç°äº†å¯¹ä»¥ä¸Šæ‰€æœ‰ç»„ä»¶çš„ç®¡ç†å’Œæ“ä½œï¼Œå¦‚åˆ›å»ºå’Œå…³é—­Acceptorã€Processorçº¿ç¨‹ç­‰ã€‚</p><p>8.<strong>SocketServerä¼´ç”Ÿå¯¹è±¡ç±»</strong>ï¼šå®šä¹‰äº†ä¸€äº›æœ‰ç”¨çš„å¸¸é‡ï¼ŒåŒæ—¶æ˜ç¡®äº†SocketServerç»„ä»¶ä¸­çš„å“ªäº›å‚æ•°æ˜¯å…è®¸åŠ¨æ€ä¿®æ”¹çš„ã€‚</p><h2>Acceptorçº¿ç¨‹</h2><p>ç»å…¸çš„Reactoræ¨¡å¼æœ‰ä¸ªDispatcherçš„è§’è‰²ï¼Œæ¥æ”¶å¤–éƒ¨è¯·æ±‚å¹¶åˆ†å‘ç»™ä¸‹é¢çš„å®é™…å¤„ç†çº¿ç¨‹ã€‚åœ¨Kafkaä¸­ï¼Œè¿™ä¸ªDispatcherå°±æ˜¯Acceptorçº¿ç¨‹ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼š</p><pre><code>private[kafka] class Acceptor(val endPoint: EndPoint,\n                              val sendBufferSize: Int,\n                              val recvBufferSize: Int,\n                              brokerId: Int,\n                              connectionQuotas: ConnectionQuotas,\n                              metricPrefix: String) extends AbstractServerThread(connectionQuotas) with KafkaMetricsGroup {\n  // åˆ›å»ºåº•å±‚çš„NIO Selectorå¯¹è±¡\n  // Selectorå¯¹è±¡è´Ÿè´£æ‰§è¡Œåº•å±‚å®é™…I/Oæ“ä½œï¼Œå¦‚ç›‘å¬è¿æ¥åˆ›å»ºè¯·æ±‚ã€è¯»å†™è¯·æ±‚ç­‰\n  private val nioSelector = NSelector.open() \n  // Brokerç«¯åˆ›å»ºå¯¹åº”çš„ServerSocketChannelå®ä¾‹\n  // åç»­æŠŠè¯¥Channelå‘ä¸Šä¸€æ­¥çš„Selectorå¯¹è±¡æ³¨å†Œ\n  val serverChannel = openServerSocket(endPoint.host, endPoint.port)\n  // åˆ›å»ºProcessorçº¿ç¨‹æ± ï¼Œå®é™…ä¸Šæ˜¯Processorçº¿ç¨‹æ•°ç»„\n  private val processors = new ArrayBuffer[Processor]()\n  private val processorsStarted = new AtomicBoolean\n\n  private val blockedPercentMeter = newMeter(s&quot;${metricPrefix}AcceptorBlockedPercent&quot;,\n    &quot;blocked time&quot;, TimeUnit.NANOSECONDS, Map(ListenerMetricTag -&gt; endPoint.listenerName.value))\n  ......\n}\n</code></pre><p>ä»å®šä¹‰æ¥çœ‹ï¼ŒAcceptorçº¿ç¨‹æ¥æ”¶5ä¸ªå‚æ•°ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æœ‰3ä¸ªã€‚</p><ul>\n<li><strong>endPoint</strong>ã€‚å®ƒå°±æ˜¯ä½ å®šä¹‰çš„Kafka Brokerè¿æ¥ä¿¡æ¯ï¼Œæ¯”å¦‚PLAINTEXT://localhost:9092ã€‚Acceptoréœ€è¦ç”¨åˆ°endPointåŒ…å«çš„ä¸»æœºåå’Œç«¯å£ä¿¡æ¯åˆ›å»ºServer Socketã€‚</li>\n<li><strong>sendBufferSize</strong>ã€‚å®ƒè®¾ç½®çš„æ˜¯SocketOptionsçš„SO_SNDBUFï¼Œå³ç”¨äºè®¾ç½®å‡ºç«™ï¼ˆOutboundï¼‰ç½‘ç»œI/Oçš„åº•å±‚ç¼“å†²åŒºå¤§å°ã€‚è¯¥å€¼é»˜è®¤æ˜¯Brokerç«¯å‚æ•°socket.send.buffer.bytesçš„å€¼ï¼Œå³100KBã€‚</li>\n<li><strong>recvBufferSize</strong>ã€‚å®ƒè®¾ç½®çš„æ˜¯SocketOptionsçš„SO_RCVBUFï¼Œå³ç”¨äºè®¾ç½®å…¥ç«™ï¼ˆInboundï¼‰ç½‘ç»œI/Oçš„åº•å±‚ç¼“å†²åŒºå¤§å°ã€‚è¯¥å€¼é»˜è®¤æ˜¯Brokerç«¯å‚æ•°socket.receive.buffer.bytesçš„å€¼ï¼Œå³100KBã€‚</li>\n</ul><p>è¯´åˆ°è¿™å„¿ï¼Œæˆ‘æƒ³ç»™ä½ æä¸€ä¸ªä¼˜åŒ–å»ºè®®ã€‚å¦‚æœåœ¨ä½ çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒClientsä¸Brokerçš„é€šä¿¡ç½‘ç»œå»¶è¿Ÿå¾ˆå¤§ï¼ˆæ¯”å¦‚RTT&gt;10msï¼‰ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä½ è°ƒå¤§æ§åˆ¶ç¼“å†²åŒºå¤§å°çš„ä¸¤ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯sendBufferSizeå’ŒrecvBufferSizeã€‚é€šå¸¸æ¥è¯´ï¼Œé»˜è®¤å€¼100KBå¤ªå°äº†ã€‚</p><p>é™¤äº†ç±»å®šä¹‰çš„å­—æ®µï¼ŒAcceptorçº¿ç¨‹è¿˜æœ‰ä¸¤ä¸ªéå¸¸å…³é”®çš„è‡ªå®šä¹‰å±æ€§ã€‚</p><ul>\n<li><strong>nioSelector</strong>ï¼šæ˜¯Java NIOåº“çš„Selectorå¯¹è±¡å®ä¾‹ï¼Œä¹Ÿæ˜¯åç»­æ‰€æœ‰ç½‘ç»œé€šä¿¡ç»„ä»¶å®ç°Java NIOæœºåˆ¶çš„åŸºç¡€ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰Java NIOï¼Œé‚£ä¹ˆæˆ‘æ¨èä½ å­¦ä¹ è¿™ä¸ªç³»åˆ—æ•™ç¨‹ï¼š<a href=\"http://tutorials.jenkov.com/java-nio/index.html\">Java NIO</a>ã€‚</li>\n<li><strong>processors</strong>ï¼šç½‘ç»œProcessorçº¿ç¨‹æ± ã€‚Acceptorçº¿ç¨‹åœ¨åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦åˆ›å»ºå¯¹åº”çš„ç½‘ç»œProcessorçº¿ç¨‹æ± ã€‚å¯è§ï¼ŒProcessorçº¿ç¨‹æ˜¯åœ¨Acceptorçº¿ç¨‹ä¸­ç®¡ç†å’Œç»´æŠ¤çš„ã€‚</li>\n</ul><p>æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£å®ƒå°±å¿…é¡»è¦å®šä¹‰ç›¸å…³çš„æ–¹æ³•ã€‚Acceptorä»£ç ä¸­ï¼Œæä¾›äº†3ä¸ªä¸Processorç›¸å…³çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯addProcessorsã€startProcessorså’ŒremoveProcessorsã€‚é‰´äºå®ƒä»¬çš„ä»£ç éƒ½éå¸¸ç®€å•ï¼Œæˆ‘ç”¨æ³¨é‡Šçš„æ–¹å¼ç»™å‡ºä¸»ä½“é€»è¾‘çš„æ­¥éª¤ï¼š</p><h3>addProcessors</h3><pre><code>private[network] def addProcessors(\n  newProcessors: Buffer[Processor], processorThreadPrefix: String): Unit = synchronized {\n  processors ++= newProcessors // æ·»åŠ ä¸€ç»„æ–°çš„Processorçº¿ç¨‹\n  if (processorsStarted.get) // å¦‚æœProcessorçº¿ç¨‹æ± å·²ç»å¯åŠ¨\n    startProcessors(newProcessors, processorThreadPrefix) // å¯åŠ¨æ–°çš„Processorçº¿ç¨‹\n}\n</code></pre><h3>startProcessors</h3><pre><code>private[network] def startProcessors(processorThreadPrefix: String): Unit = synchronized {\n    if (!processorsStarted.getAndSet(true)) {  // å¦‚æœProcessorçº¿ç¨‹æ± æœªå¯åŠ¨\n      startProcessors(processors, processorThreadPrefix) // å¯åŠ¨ç»™å®šçš„Processorçº¿ç¨‹\n    }\n}\n\nprivate def startProcessors(processors: Seq[Processor], processorThreadPrefix: String): Unit = synchronized {\n  processors.foreach { processor =&gt; // ä¾æ¬¡åˆ›å»ºå¹¶å¯åŠ¨Processorçº¿ç¨‹\n  // çº¿ç¨‹å‘½åè§„èŒƒï¼šprocessorçº¿ç¨‹å‰ç¼€-kafka-network-thread-brokeråºå·-ç›‘å¬å™¨åç§°-å®‰å…¨åè®®-Processoråºå·\n  // å‡è®¾ä¸ºåºå·ä¸º0çš„Brokerè®¾ç½®PLAINTEXT://localhost:9092ä½œä¸ºè¿æ¥ä¿¡æ¯ï¼Œé‚£ä¹ˆ3ä¸ªProcessorçº¿ç¨‹åç§°åˆ†åˆ«ä¸ºï¼š\n  // data-plane-kafka-network-thread-0-ListenerName(PLAINTEXT)-PLAINTEXT-0\n  // data-plane-kafka-network-thread-0-ListenerName(PLAINTEXT)-PLAINTEXT-1\n  // data-plane-kafka-network-thread-0-ListenerName(PLAINTEXT)-PLAINTEXT-2\n  KafkaThread.nonDaemon(s&quot;${processorThreadPrefix}-kafka-network-thread-$brokerId-${endPoint.listenerName}-${endPoint.securityProtocol}-${processor.id}&quot;, processor).start()\n  }\n}\n\n</code></pre><h3>removeProcessors</h3><pre><code>private[network] def removeProcessors(removeCount: Int, requestChannel: RequestChannel): Unit = synchronized {\n  // è·å–Processorçº¿ç¨‹æ± ä¸­æœ€åremoveCountä¸ªçº¿ç¨‹\n  val toRemove = processors.takeRight(removeCount)\n  // ç§»é™¤æœ€åremoveCountä¸ªçº¿ç¨‹\n  processors.remove(processors.size - removeCount, removeCount)\n  // å…³é—­æœ€åremoveCountä¸ªçº¿ç¨‹\n  toRemove.foreach(_.shutdown())\n  // åœ¨RequestChannelä¸­ç§»é™¤è¿™äº›Processor\n  toRemove.foreach(processor =&gt; requestChannel.removeProcessor(processor.id))\n}\n</code></pre><p>ä¸ºäº†æ›´åŠ å½¢è±¡åœ°å±•ç¤ºè¿™äº›æ–¹æ³•çš„é€»è¾‘ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œå®ƒåŒæ—¶åŒ…å«äº†è¿™3ä¸ªæ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/49/2b/494e5bac80f19a2533bb9e7b30003e2b.jpg?wh=3110*1774\" alt=\"\"></p><p>åˆšæ‰æˆ‘ä»¬å­¦åˆ°çš„addProcessorsã€startProcessorså’ŒremoveProcessorsæ–¹æ³•æ˜¯ç®¡ç†Processorçº¿ç¨‹ç”¨çš„ã€‚åº”è¯¥è¿™ä¹ˆè¯´ï¼Œæœ‰äº†è¿™ä¸‰ä¸ªæ–¹æ³•ï¼ŒAcceptorç±»å°±å…·å¤‡äº†åŸºæœ¬çš„Processorçº¿ç¨‹æ± ç®¡ç†åŠŸèƒ½ã€‚ä¸è¿‡ï¼Œ<strong>Acceptorç±»é€»è¾‘çš„é‡å¤´æˆå…¶å®æ˜¯runæ–¹æ³•ï¼Œå®ƒæ˜¯å¤„ç†Reactoræ¨¡å¼ä¸­åˆ†å‘é€»è¾‘çš„ä¸»è¦å®ç°æ–¹æ³•</strong>ã€‚ä¸‹é¢æˆ‘ä½¿ç”¨æ³¨é‡Šçš„æ–¹å¼ç»™å‡ºrunæ–¹æ³•çš„å¤§ä½“è¿è¡Œé€»è¾‘ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>def run(): Unit = {\n  //æ³¨å†ŒOP_ACCEPTäº‹ä»¶\n  serverChannel.register(nioSelector, SelectionKey.OP_ACCEPT)\n  // ç­‰å¾…Acceptorçº¿ç¨‹å¯åŠ¨å®Œæˆ\n  startupComplete()\n  try {\n    // å½“å‰ä½¿ç”¨çš„Processoråºå·ï¼Œä»0å¼€å§‹ï¼Œæœ€å¤§å€¼æ˜¯num.network.threads - 1\n    var currentProcessorIndex = 0\n    while (isRunning) {\n      try {\n        // æ¯500æ¯«ç§’è·å–ä¸€æ¬¡å°±ç»ªI/Oäº‹ä»¶\n        val ready = nioSelector.select(500)\n        if (ready &gt; 0) { // å¦‚æœæœ‰I/Oäº‹ä»¶å‡†å¤‡å°±ç»ª\n          val keys = nioSelector.selectedKeys()\n          val iter = keys.iterator()\n          while (iter.hasNext &amp;&amp; isRunning) {\n            try {\n              val key = iter.next\n              iter.remove()\n              if (key.isAcceptable) {\n                // è°ƒç”¨acceptæ–¹æ³•åˆ›å»ºSocketè¿æ¥\n                accept(key).foreach { socketChannel =&gt;\n                  var retriesLeft = synchronized(processors.length)\n                  var processor: Processor = null\n                  do {\n                    retriesLeft -= 1\n                    // æŒ‡å®šç”±å“ªä¸ªProcessorçº¿ç¨‹è¿›è¡Œå¤„ç†\n                    processor = synchronized {\n                      currentProcessorIndex = currentProcessorIndex % processors.length\n                      processors(currentProcessorIndex)\n                    }\n                    // æ›´æ–°Processorçº¿ç¨‹åºå·\n                    currentProcessorIndex += 1\n                  } while (!assignNewConnection(socketChannel, processor, retriesLeft == 0)) // Processoræ˜¯å¦æ¥å—äº†è¯¥è¿æ¥\n                }\n              } else\n                throw new IllegalStateException(&quot;Unrecognized key state for acceptor thread.&quot;)\n            } catch {\n              case e: Throwable =&gt; error(&quot;Error while accepting connection&quot;, e)\n            }\n          }\n        }\n      }\n      catch {\n        case e: ControlThrowable =&gt; throw e\n        case e: Throwable =&gt; error(&quot;Error occurred&quot;, e)\n      }\n    }\n  } finally { // æ‰§è¡Œå„ç§èµ„æºå…³é—­é€»è¾‘\n    debug(&quot;Closing server socket and selector.&quot;)\n    CoreUtils.swallow(serverChannel.close(), this, Level.ERROR)\n    CoreUtils.swallow(nioSelector.close(), this, Level.ERROR)\n    shutdownComplete()\n  }\n}\n\n</code></pre><p>çœ‹ä¸Šå»ä»£ç ä¼¼ä¹æœ‰ç‚¹å¤šï¼Œæˆ‘å†ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜ä¸€ä¸‹runæ–¹æ³•çš„ä¸»è¦å¤„ç†é€»è¾‘å§ã€‚è¿™é‡Œçš„å…³é”®ç‚¹åœ¨äºï¼ŒAcceptorçº¿ç¨‹ä¼šå…ˆä¸ºæ¯ä¸ªå…¥ç«™è¯·æ±‚ç¡®å®šè¦å¤„ç†å®ƒçš„Processorçº¿ç¨‹ï¼Œç„¶åè°ƒç”¨assignNewConnectionæ–¹æ³•ä»¤Processorçº¿ç¨‹åˆ›å»ºä¸å‘é€æ–¹çš„è¿æ¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1c/55/1c8320c702c1e18b37b992cadc61d555.jpg?wh=1463*2604\" alt=\"\"></p><p>åŸºæœ¬ä¸Šï¼ŒAcceptorçº¿ç¨‹ä½¿ç”¨Java NIOçš„Selector + SocketChannelçš„æ–¹å¼å¾ªç¯åœ°è½®è¯¢å‡†å¤‡å°±ç»ªçš„I/Oäº‹ä»¶ã€‚è¿™é‡Œçš„I/Oäº‹ä»¶ï¼Œä¸»è¦æ˜¯æŒ‡ç½‘ç»œè¿æ¥åˆ›å»ºäº‹ä»¶ï¼Œå³ä»£ç ä¸­çš„SelectionKey.OP_ACCEPTã€‚ä¸€æ—¦æ¥æ”¶åˆ°å¤–éƒ¨è¿æ¥è¯·æ±‚ï¼ŒAcceptorå°±ä¼šæŒ‡å®šä¸€ä¸ªProcessorçº¿ç¨‹ï¼Œå¹¶å°†è¯¥è¯·æ±‚äº¤ç”±å®ƒï¼Œè®©å®ƒåˆ›å»ºçœŸæ­£çš„ç½‘ç»œè¿æ¥ã€‚æ€»çš„æ¥è¯´ï¼ŒAcceptorçº¿ç¨‹å°±åšè¿™ä¹ˆç‚¹äº‹ã€‚</p><h2>Processorçº¿ç¨‹</h2><p>ä¸‹é¢æˆ‘ä»¬è¿›å…¥åˆ°Processorçº¿ç¨‹æºç çš„å­¦ä¹ ã€‚</p><p><strong>å¦‚æœè¯´Acceptoræ˜¯åšå…¥ç«™è¿æ¥å¤„ç†çš„ï¼Œé‚£ä¹ˆï¼ŒProcessorä»£ç åˆ™æ˜¯çœŸæ­£åˆ›å»ºè¿æ¥ä»¥åŠåˆ†å‘è¯·æ±‚çš„åœ°æ–¹</strong>ã€‚æ˜¾ç„¶ï¼Œå®ƒè¦åšçš„äº‹æƒ…è¿œæ¯”Acceptorè¦å¤šå¾—å¤šã€‚æˆ‘å…ˆç»™å‡ºProcessorçº¿ç¨‹çš„runæ–¹æ³•ï¼Œä½ å¤§è‡´æ„Ÿå—ä¸€ä¸‹ï¼š</p><pre><code>override def run(): Unit = {\n    startupComplete() // ç­‰å¾…Processorçº¿ç¨‹å¯åŠ¨å®Œæˆ\n    try {\n      while (isRunning) {\n        try {\n          configureNewConnections() // åˆ›å»ºæ–°è¿æ¥\n          // register any new responses for writing\n          processNewResponses() // å‘é€Responseï¼Œå¹¶å°†Responseæ”¾å…¥åˆ°inflightResponsesä¸´æ—¶é˜Ÿåˆ—\n          poll() // æ‰§è¡ŒNIO pollï¼Œè·å–å¯¹åº”SocketChannelä¸Šå‡†å¤‡å°±ç»ªçš„I/Oæ“ä½œ\n          processCompletedReceives() // å°†æ¥æ”¶åˆ°çš„Requestæ”¾å…¥Requesté˜Ÿåˆ—\n          processCompletedSends() // ä¸ºä¸´æ—¶Responseé˜Ÿåˆ—ä¸­çš„Responseæ‰§è¡Œå›è°ƒé€»è¾‘\n          processDisconnected() // å¤„ç†å› å‘é€å¤±è´¥è€Œå¯¼è‡´çš„è¿æ¥æ–­å¼€\n          closeExcessConnections() // å…³é—­è¶…è¿‡é…é¢é™åˆ¶éƒ¨åˆ†çš„è¿æ¥\n        } catch {\n          case e: Throwable =&gt; processException(&quot;Processor got uncaught exception.&quot;, e)\n        }\n      }\n    } finally { // å…³é—­åº•å±‚èµ„æº\n      debug(s&quot;Closing selector - processor $id&quot;)\n      CoreUtils.swallow(closeAll(), this, Level.ERROR)\n      shutdownComplete()\n    }\n}\n</code></pre><p>runæ–¹æ³•é€»è¾‘è¢«åˆ‡å‰²å¾—ç›¸å½“å¥½ï¼Œå„ä¸ªå­æ–¹æ³•çš„è¾¹ç•Œéå¸¸æ¸…æ¥šã€‚å› æ­¤ï¼Œä»æ•´ä½“ä¸Šçœ‹ï¼Œè¯¥æ–¹æ³•å‘ˆç°å‡ºäº†é¢å‘å¯¹è±¡é¢†åŸŸä¸­éå¸¸éš¾å¾—çš„å°è£…ç‰¹æ€§ã€‚æˆ‘ä½¿ç”¨ä¸€å¼ å›¾æ¥å±•ç¤ºä¸‹è¯¥æ–¹æ³•è¦åšçš„äº‹æƒ…ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/1d/42/1d6f59036ea2797bfc1591f57980df42.jpg?wh=1988*6258\" alt=\"\"></p><p>åœ¨è¯¦ç»†è¯´runæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹Processorçº¿ç¨‹åˆå§‹åŒ–æ—¶è¦åšçš„äº‹æƒ…ã€‚</p><p>æ¯ä¸ªProcessorçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»º3ä¸ªé˜Ÿåˆ—ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„é˜Ÿåˆ—æ˜¯å¹¿ä¹‰çš„é˜Ÿåˆ—ï¼Œå…¶åº•å±‚ä½¿ç”¨çš„æ•°æ®ç»“æ„å¯èƒ½æ˜¯é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªMapå¯¹è±¡è€Œå·²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>private val newConnections = new ArrayBlockingQueue[SocketChannel](connectionQueueSize)\nprivate val inflightResponses = mutable.Map[String, RequestChannel.Response]()\nprivate val responseQueue = new LinkedBlockingDeque[RequestChannel.Response]()\n</code></pre><p><strong>é˜Ÿåˆ—ä¸€ï¼šnewConnections</strong></p><p><strong>å®ƒä¿å­˜çš„æ˜¯è¦åˆ›å»ºçš„æ–°è¿æ¥ä¿¡æ¯</strong>ï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯SocketChannelå¯¹è±¡ã€‚è¿™æ˜¯ä¸€ä¸ªé»˜è®¤ä¸Šé™æ˜¯20çš„é˜Ÿåˆ—ï¼Œè€Œä¸”ï¼Œç›®å‰ä»£ç ä¸­ç¡¬ç¼–ç äº†é˜Ÿåˆ—çš„é•¿åº¦ï¼Œå› æ­¤ï¼Œä½ æ— æ³•å˜æ›´è¿™ä¸ªé˜Ÿåˆ—çš„é•¿åº¦ã€‚</p><p>æ¯å½“Processorçº¿ç¨‹æ¥æ”¶æ–°çš„è¿æ¥è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šå°†å¯¹åº”çš„SocketChannelæ”¾å…¥è¿™ä¸ªé˜Ÿåˆ—ã€‚åé¢åœ¨åˆ›å»ºè¿æ¥æ—¶ï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨configureNewConnectionsæ—¶ï¼‰ï¼Œå°±ä»è¯¥é˜Ÿåˆ—ä¸­å–å‡ºSocketChannelï¼Œç„¶åæ³¨å†Œæ–°çš„è¿æ¥ã€‚</p><p><strong>é˜Ÿåˆ—äºŒï¼šinflightResponses</strong></p><p>ä¸¥æ ¼æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸´æ—¶Responseé˜Ÿåˆ—ã€‚å½“Processorçº¿ç¨‹å°†Responseè¿”è¿˜ç»™Requestå‘é€æ–¹ä¹‹åï¼Œè¿˜è¦å°†Responseæ”¾å…¥è¿™ä¸ªä¸´æ—¶é˜Ÿåˆ—ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¸´æ—¶é˜Ÿåˆ—å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œæœ‰äº›Responseå›è°ƒé€»è¾‘è¦åœ¨Responseè¢«å‘é€å›å‘é€æ–¹ä¹‹åï¼Œæ‰èƒ½æ‰§è¡Œï¼Œå› æ­¤éœ€è¦æš‚å­˜åœ¨ä¸€ä¸ªä¸´æ—¶é˜Ÿåˆ—é‡Œé¢ã€‚è¿™å°±æ˜¯inflightResponseså­˜åœ¨çš„æ„ä¹‰ã€‚</p><p><strong>é˜Ÿåˆ—ä¸‰ï¼šresponseQueue</strong></p><p>çœ‹åå­—æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯Responseé˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯Requesté˜Ÿåˆ—ã€‚è¿™å‘Šè¯‰äº†æˆ‘ä»¬ä¸€ä¸ªäº‹å®ï¼š<strong>æ¯ä¸ªProcessorçº¿ç¨‹éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„Responseé˜Ÿåˆ—</strong>ï¼Œè€Œä¸æ˜¯åƒç½‘ä¸Šçš„æŸäº›æ–‡ç« è¯´çš„ï¼ŒResponseé˜Ÿåˆ—æ˜¯çº¿ç¨‹å…±äº«çš„æˆ–æ˜¯ä¿å­˜åœ¨RequestChannelä¸­çš„ã€‚Responseé˜Ÿåˆ—é‡Œé¢ä¿å­˜ç€éœ€è¦è¢«è¿”è¿˜ç»™å‘é€æ–¹çš„æ‰€æœ‰Responseå¯¹è±¡ã€‚</p><p>å¥½äº†ï¼Œäº†è§£äº†è¿™äº›ä¹‹åï¼Œç°åœ¨æˆ‘ä»¬æ¥æ·±å…¥åœ°æŸ¥çœ‹ä¸€ä¸‹Processorçº¿ç¨‹çš„å·¥ä½œé€»è¾‘ã€‚æ ¹æ®runæ–¹æ³•ä¸­çš„æ–¹æ³•è°ƒç”¨é¡ºåºï¼Œæˆ‘å…ˆæ¥ä»‹ç»ä¸‹configureNewConnectionsæ–¹æ³•ã€‚</p><h3>configureNewConnections</h3><p>å°±åƒæˆ‘å‰é¢æ‰€è¯´çš„ï¼ŒconfigureNewConnectionsè´Ÿè´£å¤„ç†æ–°è¿æ¥è¯·æ±‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ç”¨æ³¨é‡Šçš„æ–¹å¼ç»™å‡ºè¿™ä¸ªæ–¹æ³•çš„ä¸»ä½“é€»è¾‘ï¼š</p><pre><code>private def configureNewConnections(): Unit = {\n    var connectionsProcessed = 0 // å½“å‰å·²é…ç½®çš„è¿æ¥æ•°è®¡æ•°å™¨\n    while (connectionsProcessed &lt; connectionQueueSize &amp;&amp; !newConnections.isEmpty) { // å¦‚æœæ²¡è¶…é…é¢å¹¶ä¸”æœ‰å¾…å¤„ç†æ–°è¿æ¥\n      val channel = newConnections.poll() // ä»è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºSocketChannel\n      try {\n        debug(s&quot;Processor $id listening to new connection from ${channel.socket.getRemoteSocketAddress}&quot;)\n        // ç”¨ç»™å®šSelectoræ³¨å†Œè¯¥Channel\n        // åº•å±‚å°±æ˜¯è°ƒç”¨Java NIOçš„SocketChannel.register(selector, SelectionKey.OP_READ)\n        selector.register(connectionId(channel.socket), channel)\n        connectionsProcessed += 1 // æ›´æ–°è®¡æ•°å™¨\n      } catch {\n        case e: Throwable =&gt;\n          val remoteAddress = channel.socket.getRemoteSocketAddress\n          close(listenerName, channel)\n          processException(s&quot;Processor $id closed connection from $remoteAddress&quot;, e)\n      }\n    }\n}\n\n</code></pre><p><strong>è¯¥æ–¹æ³•æœ€é‡è¦çš„é€»è¾‘æ˜¯è°ƒç”¨selectorçš„registeræ¥æ³¨å†ŒSocketChannel</strong>ã€‚æ¯ä¸ªProcessorçº¿ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ªSelectorç±»å®ä¾‹ã€‚Selectorç±»æ˜¯ç¤¾åŒºæä¾›çš„ä¸€ä¸ªåŸºäºJava NIO Selectorçš„æ¥å£ï¼Œç”¨äºæ‰§è¡Œéé˜»å¡å¤šé€šé“çš„ç½‘ç»œI/Oæ“ä½œã€‚åœ¨æ ¸å¿ƒåŠŸèƒ½ä¸Šï¼ŒKafkaæä¾›çš„Selectorå’ŒJavaæä¾›çš„æ˜¯ä¸€è‡´çš„ã€‚</p><h3>processNewResponses</h3><p>å®ƒè´Ÿè´£å‘é€Responseç»™Requestå‘é€æ–¹ï¼Œå¹¶ä¸”å°†Responseæ”¾å…¥ä¸´æ—¶Responseé˜Ÿåˆ—ã€‚å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p><pre><code>private def processNewResponses(): Unit = {\n    var currentResponse: RequestChannel.Response = null\n    while ({currentResponse = dequeueResponse(); currentResponse != null}) { // Responseé˜Ÿåˆ—ä¸­å­˜åœ¨å¾…å¤„ç†Response\n      val channelId = currentResponse.request.context.connectionId // è·å–è¿æ¥é€šé“ID\n      try {\n        currentResponse match {\n          case response: NoOpResponse =&gt; // æ— éœ€å‘é€Response\n            updateRequestMetrics(response)\n            trace(s&quot;Socket server received empty response to send, registering for read: $response&quot;)\n            handleChannelMuteEvent(channelId, ChannelMuteEvent.RESPONSE_SENT)\n            tryUnmuteChannel(channelId)\n          case response: SendResponse =&gt; // å‘é€Responseå¹¶å°†Responseæ”¾å…¥inflightResponses\n            sendResponse(response, response.responseSend)\n          case response: CloseConnectionResponse =&gt; // å…³é—­å¯¹åº”çš„è¿æ¥\n            updateRequestMetrics(response)\n            trace(&quot;Closing socket connection actively according to the response code.&quot;)\n            close(channelId)\n          case _: StartThrottlingResponse =&gt;\n            handleChannelMuteEvent(channelId, ChannelMuteEvent.THROTTLE_STARTED)\n          case _: EndThrottlingResponse =&gt;\n            handleChannelMuteEvent(channelId, ChannelMuteEvent.THROTTLE_ENDED)\n            tryUnmuteChannel(channelId)\n          case _ =&gt;\n            throw new IllegalArgumentException(s&quot;Unknown response type: ${currentResponse.getClass}&quot;)\n        }\n      } catch {\n        case e: Throwable =&gt;\n          processChannelException(channelId, s&quot;Exception while processing response for $channelId&quot;, e)\n      }\n    }\n}\n</code></pre><p>è¿™é‡Œçš„å…³é”®æ˜¯<strong>SendResponseåˆ†æ”¯ä¸Šçš„sendResponseæ–¹æ³•</strong>ã€‚è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒä»£ç å…¶å®åªæœ‰ä¸‰è¡Œï¼š</p><pre><code>if (openOrClosingChannel(connectionId).isDefined) { // å¦‚æœè¯¥è¿æ¥å¤„äºå¯è¿æ¥çŠ¶æ€\n  selector.send(responseSend) // å‘é€Response\n  inflightResponses += (connectionId -&gt; response) // å°†ResponseåŠ å…¥åˆ°inflightResponsesé˜Ÿåˆ—\n}\n</code></pre><h3>poll</h3><p>ä¸¥æ ¼æ¥è¯´ï¼Œä¸Šé¢æåˆ°çš„æ‰€æœ‰å‘é€çš„é€»è¾‘éƒ½ä¸æ˜¯æ‰§è¡ŒçœŸæ­£çš„å‘é€ã€‚çœŸæ­£æ‰§è¡ŒI/OåŠ¨ä½œçš„æ–¹æ³•æ˜¯è¿™é‡Œçš„pollæ–¹æ³•ã€‚</p><p>pollæ–¹æ³•çš„æ ¸å¿ƒä»£ç å°±åªæœ‰1è¡Œï¼š<strong>selector.poll(pollTimeout)</strong>ã€‚åœ¨åº•å±‚ï¼Œå®ƒå®é™…ä¸Šè°ƒç”¨çš„æ˜¯Java NIO Selectorçš„selectæ–¹æ³•å»æ‰§è¡Œé‚£äº›å‡†å¤‡å°±ç»ªçš„I/Oæ“ä½œï¼Œä¸ç®¡æ˜¯æ¥æ”¶Requestï¼Œè¿˜æ˜¯å‘é€Responseã€‚å› æ­¤ï¼Œä½ éœ€è¦è®°ä½çš„æ˜¯ï¼Œ<strong>pollæ–¹æ³•æ‰æ˜¯çœŸæ­£æ‰§è¡ŒI/Oæ“ä½œé€»è¾‘çš„åœ°æ–¹</strong>ã€‚</p><h3>processCompletedReceives</h3><p>å®ƒæ˜¯æ¥æ”¶å’Œå¤„ç†Requestçš„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>private def processCompletedReceives(): Unit = {\n  // éå†æ‰€æœ‰å·²æ¥æ”¶çš„Request\n  selector.completedReceives.asScala.foreach { receive =&gt;\n    try {\n      // ä¿è¯å¯¹åº”è¿æ¥é€šé“å·²ç»å»ºç«‹\n      openOrClosingChannel(receive.source) match {\n        case Some(channel) =&gt;\n          val header = RequestHeader.parse(receive.payload)\n          if (header.apiKey == ApiKeys.SASL_HANDSHAKE &amp;&amp; channel.maybeBeginServerReauthentication(receive, nowNanosSupplier))\n            trace(s&quot;Begin re-authentication: $channel&quot;)\n          else {\n            val nowNanos = time.nanoseconds()\n            // å¦‚æœè®¤è¯ä¼šè¯å·²è¿‡æœŸï¼Œåˆ™å…³é—­è¿æ¥\n            if (channel.serverAuthenticationSessionExpired(nowNanos)) {\n              debug(s&quot;Disconnecting expired channel: $channel : $header&quot;)\n              close(channel.id)\n              expiredConnectionsKilledCount.record(null, 1, 0)\n            } else {\n              val connectionId = receive.source\n              val context = new RequestContext(header, connectionId, channel.socketAddress,\n                channel.principal, listenerName, securityProtocol,\n                channel.channelMetadataRegistry.clientInformation)\n              val req = new RequestChannel.Request(processor = id, context = context,\n                startTimeNanos = nowNanos, memoryPool, receive.payload, requestChannel.metrics)\n              if (header.apiKey == ApiKeys.API_VERSIONS) {\n                val apiVersionsRequest = req.body[ApiVersionsRequest]\n                if (apiVersionsRequest.isValid) {\n                  channel.channelMetadataRegistry.registerClientInformation(new ClientInformation(\n                    apiVersionsRequest.data.clientSoftwareName,\n                    apiVersionsRequest.data.clientSoftwareVersion))\n                }\n              }\n              // æ ¸å¿ƒä»£ç ï¼šå°†Requestæ·»åŠ åˆ°Requesté˜Ÿåˆ—\n              requestChannel.sendRequest(req)\n              selector.mute(connectionId)\n              handleChannelMuteEvent(connectionId, ChannelMuteEvent.REQUEST_RECEIVED)\n            }\n          }\n        case None =&gt;\n          throw new IllegalStateException(s&quot;Channel ${receive.source} removed from selector before processing completed receive&quot;)\n      }\n    } catch {\n      case e: Throwable =&gt;\n        processChannelException(receive.source, s&quot;Exception while processing request from ${receive.source}&quot;, e)\n    }\n  }\n}\n\n</code></pre><p>çœ‹ä¸Šå»ä»£ç æœ‰å¾ˆå¤šï¼Œä½†å…¶å®æœ€æ ¸å¿ƒçš„ä»£ç å°±åªæœ‰1è¡Œï¼š<strong>requestChannel.sendRequest(req)</strong>ï¼Œä¹Ÿå°±æ˜¯å°†æ­¤Requestæ”¾å…¥Requesté˜Ÿåˆ—ã€‚å…¶ä»–ä»£ç åªæ˜¯ä¸€äº›å¸¸è§„åŒ–çš„æ ¡éªŒå’Œè¾…åŠ©é€»è¾‘ã€‚</p><p>è¿™ä¸ªæ–¹æ³•çš„æ„æ€æ˜¯è¯´ï¼Œ<strong>Processorä»åº•å±‚Socketé€šé“ä¸æ–­è¯»å–å·²æ¥æ”¶åˆ°çš„ç½‘ç»œè¯·æ±‚ï¼Œç„¶åè½¬æ¢æˆRequestå®ä¾‹ï¼Œå¹¶å°†å…¶æ”¾å…¥åˆ°Requesté˜Ÿåˆ—</strong>ã€‚æ•´ä¸ªé€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œå¯¹å§ï¼Ÿ</p><h3>processCompletedSends</h3><p>å®ƒè´Ÿè´£å¤„ç†Responseçš„å›è°ƒé€»è¾‘ã€‚æˆ‘ä¹‹å‰è¯´è¿‡ï¼ŒResponseéœ€è¦è¢«å‘é€ä¹‹åæ‰èƒ½æ‰§è¡Œå¯¹åº”çš„å›è°ƒé€»è¾‘ï¼Œè¿™ä¾¿æ˜¯è¯¥æ–¹æ³•ä»£ç è¦å®ç°çš„åŠŸèƒ½ï¼š</p><pre><code>private def processCompletedSends(): Unit = {\n  // éå†åº•å±‚SocketChannelå·²å‘é€çš„Response\n  selector.completedSends.asScala.foreach { send =&gt;\n    try {\n      // å–å‡ºå¯¹åº”inflightResponsesä¸­çš„Response\n      val response = inflightResponses.remove(send.destination).getOrElse {\n        throw new IllegalStateException(s&quot;Send for ${send.destination} completed, but not in `inflightResponses`&quot;)\n      }\n      updateRequestMetrics(response) // æ›´æ–°ä¸€äº›ç»Ÿè®¡æŒ‡æ ‡\n      // æ‰§è¡Œå›è°ƒé€»è¾‘\n      response.onComplete.foreach(onComplete =&gt; onComplete(send))\n      handleChannelMuteEvent(send.destination, ChannelMuteEvent.RESPONSE_SENT)\n      tryUnmuteChannel(send.destination)\n    } catch {\n      case e: Throwable =&gt; processChannelException(send.destination,\n        s&quot;Exception while processing completed send to ${send.destination}&quot;, e)\n    }\n  }\n}\n\n</code></pre><p>è¿™é‡Œé€šè¿‡è°ƒç”¨Responseå¯¹è±¡çš„onCompleteæ–¹æ³•ï¼Œæ¥å®ç°å›è°ƒå‡½æ•°çš„æ‰§è¡Œã€‚</p><h3>processDisconnected</h3><p>é¡¾åæ€ä¹‰ï¼Œå®ƒå°±æ˜¯å¤„ç†å·²æ–­å¼€è¿æ¥çš„ã€‚è¯¥æ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•ï¼Œæˆ‘ç”¨æ³¨é‡Šæ ‡æ³¨äº†ä¸»è¦çš„æ‰§è¡Œæ­¥éª¤ï¼š</p><pre><code>private def processDisconnected(): Unit = {\n  // éå†åº•å±‚SocketChannelçš„é‚£äº›å·²ç»æ–­å¼€çš„è¿æ¥\n  selector.disconnected.keySet.asScala.foreach { connectionId =&gt;\n    try {\n      // è·å–æ–­å¼€è¿æ¥çš„è¿œç«¯ä¸»æœºåä¿¡æ¯\n      val remoteHost = ConnectionId.fromString(connectionId).getOrElse {\n        throw new IllegalStateException(s&quot;connectionId has unexpected format: $connectionId&quot;)\n      }.remoteHost\n  // å°†è¯¥è¿æ¥ä»inflightResponsesä¸­ç§»é™¤ï¼ŒåŒæ—¶æ›´æ–°ä¸€äº›ç›‘æ§æŒ‡æ ‡\n  inflightResponses.remove(connectionId).foreach(updateRequestMetrics)\n  // æ›´æ–°é…é¢æ•°æ®\n  connectionQuotas.dec(listenerName, InetAddress.getByName(remoteHost))\n    } catch {\n      case e: Throwable =&gt; processException(s&quot;Exception while processing disconnection of $connectionId&quot;, e)\n    }\n  }\n}\n\n</code></pre><p>æ¯”è¾ƒå…³é”®çš„ä»£ç æ˜¯éœ€è¦ä»åº•å±‚Selectorä¸­è·å–é‚£äº›å·²ç»æ–­å¼€çš„è¿æ¥ï¼Œä¹‹åæŠŠå®ƒä»¬ä»inflightResponsesä¸­ç§»é™¤æ‰ï¼ŒåŒæ—¶ä¹Ÿè¦æ›´æ–°å®ƒä»¬çš„é…é¢æ•°æ®ã€‚</p><h3>closeExcessConnections</h3><p>è¿™æ˜¯Processorçº¿ç¨‹çš„runæ–¹æ³•æ‰§è¡Œçš„æœ€åä¸€æ­¥ï¼Œå³<strong>å…³é—­è¶…é™è¿æ¥</strong>ã€‚ä»£ç å¾ˆç®€å•ï¼š</p><pre><code>private def closeExcessConnections(): Unit = {\n    // å¦‚æœé…é¢è¶…é™äº†\n    if (connectionQuotas.maxConnectionsExceeded(listenerName)) {\n      // æ‰¾å‡ºä¼˜å…ˆå…³é—­çš„é‚£ä¸ªè¿æ¥\n      val channel = selector.lowestPriorityChannel() \n      if (channel != null)\n        close(channel.id) // å…³é—­è¯¥è¿æ¥\n    }\n}\n</code></pre><p>æ‰€è°“ä¼˜å…ˆå…³é—­ï¼Œæ˜¯æŒ‡åœ¨è¯¸å¤šTCPè¿æ¥ä¸­æ‰¾å‡ºæœ€è¿‘æœªè¢«ä½¿ç”¨çš„é‚£ä¸ªã€‚è¿™é‡Œâ€œæœªè¢«ä½¿ç”¨â€å°±æ˜¯è¯´ï¼Œåœ¨æœ€è¿‘ä¸€æ®µæ—¶é—´å†…ï¼Œæ²¡æœ‰ä»»ä½•Requestç»ç”±è¿™ä¸ªè¿æ¥è¢«å‘é€åˆ°Processorçº¿ç¨‹ã€‚</p><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ äº†è§£äº†Kafkaç½‘ç»œé€šä¿¡å±‚çš„å…¨è²Œï¼Œå¤§è‡´ä»‹ç»äº†æ ¸å¿ƒç»„ä»¶SocketServerï¼Œè¿˜èŠ±äº†ç›¸å½“å¤šçš„æ—¶é—´ç ”ç©¶SocketServerä¸‹çš„Acceptorå’ŒProcessorçº¿ç¨‹ä»£ç ã€‚æˆ‘ä»¬æ¥ç®€å•æ€»ç»“ä¸€ä¸‹ã€‚</p><ul>\n<li>ç½‘ç»œé€šä¿¡å±‚ç”±SocketServerç»„ä»¶å’ŒKafkaRequestHandlerPoolç»„ä»¶æ„æˆã€‚</li>\n<li>SocketServerå®ç°äº†Reactoræ¨¡å¼ï¼Œç”¨äºé«˜æ€§èƒ½åœ°å¹¶å‘å¤„ç†I/Oè¯·æ±‚ã€‚</li>\n<li>SocketServeråº•å±‚ä½¿ç”¨äº†Javaçš„Selectorå®ç°NIOé€šä¿¡ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/41/51/41317d400ed096bbca8efadf43186f51.jpg?wh=2349*2028\" alt=\"\"></p><p>åœ¨ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä¼šé‡ç‚¹ä»‹ç»SocketServerå¤„ç†ä¸åŒç±»å‹Requestæ‰€åšçš„è®¾è®¡åŠå…¶å¯¹åº”çš„ä»£ç ã€‚è¿™æ˜¯ç¤¾åŒºä¸ºäº†æé«˜Brokerå¤„ç†æ§åˆ¶ç±»è¯·æ±‚çš„é‡å¤§ä¸¾æªï¼Œä¹Ÿæ˜¯ä¸ºäº†æ”¹å–„Brokerä¸€è‡´æ€§æ‰€åšçš„åŠªåŠ›ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬é‡ç‚¹å…³æ³¨ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>æœ€åï¼Œè¯·æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆRequesté˜Ÿåˆ—è¢«è®¾è®¡æˆçº¿ç¨‹å…±äº«çš„ï¼Œè€ŒResponseé˜Ÿåˆ—åˆ™æ˜¯æ¯ä¸ªProcessorçº¿ç¨‹ä¸“å±çš„ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"06 | è¯·æ±‚é€šé“ï¼šå¦‚ä½•å®ç°Kafkaè¯·æ±‚é˜Ÿåˆ—ï¼Ÿ","id":230352},"right":{"article_title":"08 | SocketServerï¼ˆä¸­ï¼‰ï¼šè¯·æ±‚è¿˜è¦åŒºåˆ†ä¼˜å…ˆçº§ï¼Ÿ","id":232134}},"comments":[{"had_liked":false,"id":214420,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1588744580,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720599183995e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬é‡ç‚¹äº†è§£äº†Kafkaä¸­çš„è¯·æ±‚é€šé“ï¼šRequestChannelç±»ã€‚è¯¾åæˆ‘è®©ä½ å»æºç ä¸­å¯»æ‰¾ç›‘æ§Requesté˜Ÿåˆ—å½“å‰ä½¿ç”¨æƒ…å†µçš„ç›‘æ§æŒ‡æ ‡ã€‚ä¸‹é¢æˆ‘ç»™å‡ºæˆ‘çš„ç­”æ¡ˆã€‚è¿™ä¸ªç›‘æ§æŒ‡æ ‡å°±æ˜¯RequestQueueSizeã€‚å®Œæ•´çš„MBeanå†™æ³•æ˜¯kafka.network:type=RequestChannel,name=RequestQueueSizeã€‚ä½ å¯ä»¥åœ¨RequestChannel.scalaä¸­æ‰¾åˆ°è¿™è¡Œæºç ï¼šnewGauge(requestQueueSizeMetricName, () =&gt; requestQueue.size)<br>è¿™é‡Œçš„requestQueueSizeMetricNameå°±å¯¹åº”äºRequestQueueSize<br><br><br>okayï¼Œä½ æ‰¾åˆ°äº†å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":5},{"had_liked":false,"id":212720,"user_name":"æ¯å¤©æ™’ç™½ç‰™","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1588201871,"is_pvip":false,"replies":[{"id":"79030","content":"èµğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588209084,"ip_address":"","comment_id":212720,"utype":1}],"discussion_count":1,"race_medal":1,"score":"31652972943","product_id":100050101,"comment_content":"å»å¹´è‡ªå·±åœ¨å·¥ä½œä¸­æ¥è§¦äº† Kafkaï¼Œç„¶åå†™äº†ç¯‡ç½‘ç»œå±‚çš„æºç åˆ†æ(åº”è¯¥å«æºç æ³¨é‡Š + ç”»å›¾)<br>https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;-VzDU0V8J2guNXwhiBEEyg<br>","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493593,"discussion_content":"èµğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588209084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212701,"user_name":"Geek_d1cc4d","can_delete":false,"product_type":"c1","uid":1834116,"ip_address":"","ucode":"05CC1344081E07","user_header":"https://static001.geekbang.org/account/avatar/00/1b/fc/84/7c740988.jpg","comment_is_top":false,"comment_ctime":1588178959,"is_pvip":false,"replies":[{"id":"79135","content":"å¾ˆæœ‰é“ç†ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588400627,"ip_address":"","comment_id":212701,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23063015439","product_id":100050101,"comment_content":"Requesté˜Ÿåˆ—çº¿ç¨‹å…±äº«ï¼Œè¿™æ ·ä¸åŒçº¿ç¨‹çš„workloadæ‰ä¸ä¼šå‘ç”Ÿå€¾æ–œï¼Œä¸ç„¶å¯èƒ½ä¼šå‘ç”Ÿä¸€è¾¹çš„çº¿ç¨‹ç©ºé—²ï¼Œä¸€è¾¹çš„çº¿ç¨‹é˜Ÿåˆ—æ»¡","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493585,"discussion_content":"å¾ˆæœ‰é“ç†ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588400627,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1764779,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/ed/ab/bc63a5fe.jpg","nickname":"æš®é†‰ä¸œé£","note":"","ucode":"656D65152F1857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392066,"discussion_content":"æ„Ÿè§‰è¿™ä¸ªä¸æ˜¯ä¸»è¦å› ç´ ï¼Œæ¥è‡ªåŒä¸€ä¸ªchannelçš„è¯·æ±‚å¾ˆå¤šï¼Œçº¿ç¨‹è‡ªç„¶ä¼šæœ‰workloadå€¾æ–œã€‚å•ä¸ª requestQueue æ˜¯ä¸ºäº†æ€»è¯·æ±‚æ•°æ›´å¥½åšç›‘æ§å’Œé™æµå§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630810682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287419,"user_name":"åœ¨è·¯ä¸Š","can_delete":false,"product_type":"c1","uid":1724215,"ip_address":"","ucode":"FA8E8FD88886AF","user_header":"https://static001.geekbang.org/account/avatar/00/1a/4f/37/ad1ca21d.jpg","comment_is_top":false,"comment_ctime":1617938676,"is_pvip":true,"replies":[{"id":"104423","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1618026141,"ip_address":"","comment_id":287419,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14502840564","product_id":100050101,"comment_content":"è¯¾åé¢˜æ€è€ƒï¼š<br>ï¼ˆ1ï¼‰Request é˜Ÿåˆ—åœ¨è¢« IO çº¿ç¨‹å–èµ°å¤„ç†æ—¶ä¸éœ€è¦å…³å¿ƒ Request è¢«å“ªä¸ª IO çº¿ç¨‹å¤„ç†äº†ã€‚å¤„ç†å®Œæ”¾å…¥åˆ°å¯¹åº”çš„ Response é˜Ÿåˆ—å°±å¥½ã€‚<br>ï¼ˆ2ï¼‰Response é˜Ÿåˆ—æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå› ä¸º Processor ç®¡ç†ç€æŸä¸€ç»„ SocketChannelï¼ŒSocketChannel å‘å‡ºçš„æŸä¸ª Request å¤„ç†å®Œæˆåç”Ÿæˆ Response è¿˜éœ€è¦åœ¨è¯¥ Processor Send å‡ºå»ã€‚<br>ï¼ˆ3ï¼‰å¦‚æœ Response è®¾è®¡æˆè·Ÿ Request ä¸€æ ·åœ¨å…±äº«é˜Ÿåˆ—ä¸­ï¼Œ Processor éœ€è¦ä¸»åŠ¨å» take å‡ºæ¥ï¼Œè¿™æ—¶è¿˜éœ€è¦åˆ¤å®šå¯¹åº”çš„ SocketChannel æ˜¯å¦å±äºè¿™ä¸ª Processorã€‚<br>    æˆ–è€…è®¾è®¡æˆ ç”±ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹å–åˆ†å‘ç»™ä¸åŒçš„ Processorã€‚é‚£è¿˜ä¸å¦‚ IO çº¿ç¨‹å¤„ç†å®Œç›´æ¥å‘ç»™ä¸åŒçš„ Response é˜Ÿåˆ—åˆ’ç®—ä¹Ÿæ²¡æœ‰é”çš„ç«äº‰ã€‚<br><br>è¡¨è¾¾çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ ï¼šProcessor çº¿ç¨‹çš„ selector æ³¨å†Œäº†è¯¥çº¿ç¨‹æ‰€ç®¡ç†çš„ä¸€ç»„ SocketChannelï¼Œæ”¶å‘è¯·æ±‚åªèƒ½ç”±è¯¥ Processor å¤„ç†ã€‚æ‰€ä»¥ç”± Processor ç®¡ç†ç‹¬å±çš„ Response é˜Ÿåˆ—ã€‚","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518304,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618026141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231317,"user_name":"__Unsafe","can_delete":false,"product_type":"c1","uid":1237779,"ip_address":"","ucode":"7D9975396A3194","user_header":"https://static001.geekbang.org/account/avatar/00/12/e3/13/feaf21e4.jpg","comment_is_top":false,"comment_ctime":1593651518,"is_pvip":false,"replies":[{"id":"85434","content":"Kafkaæ²¡åšå¤„ç†ã€‚æ¯•ç«Ÿä¸å±äºå®ƒåº”åšçš„äº‹æƒ…","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593657704,"ip_address":"","comment_id":231317,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10183586110","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæƒ³è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œkafkaæ˜¯å¦‚ä½•å¤„ç†nio çš„ epollç©ºè½®è®­bugçš„ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500256,"discussion_content":"Kafkaæ²¡åšå¤„ç†ã€‚æ¯•ç«Ÿä¸å±äºå®ƒåº”åšçš„äº‹æƒ…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593657704,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219200,"user_name":"hc","can_delete":false,"product_type":"c1","uid":1317758,"ip_address":"","ucode":"4DAD8D649AE8B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/1b/7e/17c2eca1.jpg","comment_is_top":false,"comment_ctime":1589965617,"is_pvip":false,"replies":[{"id":"80977","content":"çœ‹ç€åƒæ˜¯éå¸¸å¤è€çš„å¼‚å¸¸äº†ã€‚é€šå¸¸éƒ½æ˜¯listenersé…ç½®æˆ–æ˜¯clientsçš„&#47;etc&#47;hostsé…ç½®çš„é—®é¢˜ã€‚æ€»ä¹‹æ˜¯è¿ä¸ä¸ŠBrokerå¯¼è‡´çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589974312,"ip_address":"","comment_id":219200,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5884932913","product_id":100050101,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘è¿™è¾¹ç”Ÿäº§ç¯å¢ƒkafka0.10ç‰ˆæœ¬ç”Ÿäº§è€…å¶ç„¶ä¼šå‡ºç°kafka.common.FailedToSendMessageException: Failed to send messages after 3 triesçš„é—®é¢˜ï¼Œé—®ä¸€ä¸‹æ‚¨è¿™è¾¹æœ‰ä»€ä¹ˆå¥½çš„å®šä½æ€è·¯å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495712,"discussion_content":"çœ‹ç€åƒæ˜¯éå¸¸å¤è€çš„å¼‚å¸¸äº†ã€‚é€šå¸¸éƒ½æ˜¯listenersé…ç½®æˆ–æ˜¯clientsçš„/etc/hostsé…ç½®çš„é—®é¢˜ã€‚æ€»ä¹‹æ˜¯è¿ä¸ä¸ŠBrokerå¯¼è‡´çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589974312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1317758,"avatar":"https://static001.geekbang.org/account/avatar/00/14/1b/7e/17c2eca1.jpg","nickname":"hc","note":"","ucode":"4DAD8D649AE8B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":270046,"discussion_content":"æ„Ÿè°¢æ„Ÿè°¢ è§£å†³æ‰äº† è°¢è°¢ hostsæ–‡ä»¶ä¸­hostå°‘é…ç½®äº†äº†ä¸€ä¸ªèŠ‚ç‚¹","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1589977789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214947,"user_name":"å°å´”","can_delete":false,"product_type":"c1","uid":1104958,"ip_address":"","ucode":"4E537416787752","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1588855309,"is_pvip":false,"replies":[{"id":"79691","content":"å¦‚æœRTTå¾ˆå¤§ï¼Œæˆ‘ä»¬æœ€å¥½æ˜¯è®©Socket bufferç´¯ç§¯æ›´å¤šçš„æ•°æ®ä¹‹åä¸€æ¬¡æ€§å‘é€ï¼ŒèŠ‚çœç½‘ç»œI&#47;Oå¸¦å®½ã€‚å°±æ¯”å¦‚é€å¿«é€’ï¼Œå¦‚æœç›®çš„åœ°å¾ˆè¿œï¼Œå¿«é€’å‘˜æœ€å¥½å…ˆç§¯æ”’å¤šä¸€ç‚¹å¾…å‘é€çš„ç‰©ä»¶ä¹‹åå†å»å‘é€","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588984492,"ip_address":"","comment_id":214947,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5883822605","product_id":100050101,"comment_content":"ä¸ºä»€ä¹ˆClients ä¸ Broker çš„é€šä¿¡ç½‘ç»œå»¶è¿Ÿå¾ˆå¤§ï¼Œå»ºè®®è°ƒå¤§ç¼“å†²åŒºå‘¢ï¼ŸèƒŒååŸç†æ˜¯ä»€ä¹ˆï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494252,"discussion_content":"å¦‚æœRTTå¾ˆå¤§ï¼Œæˆ‘ä»¬æœ€å¥½æ˜¯è®©Socket bufferç´¯ç§¯æ›´å¤šçš„æ•°æ®ä¹‹åä¸€æ¬¡æ€§å‘é€ï¼ŒèŠ‚çœç½‘ç»œI/Oå¸¦å®½ã€‚å°±æ¯”å¦‚é€å¿«é€’ï¼Œå¦‚æœç›®çš„åœ°å¾ˆè¿œï¼Œå¿«é€’å‘˜æœ€å¥½å…ˆç§¯æ”’å¤šä¸€ç‚¹å¾…å‘é€çš„ç‰©ä»¶ä¹‹åå†å»å‘é€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588984492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1101864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d0/28/af87f7ab.jpg","nickname":"ç™½äº¬äº¬","note":"","ucode":"5FE4B923570534","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282225,"discussion_content":"ä¸€æ¬¡æ‹‰ä¸€ä»¶ï¼Œä¸ä¸€æ¬¡æ‹‰10ä»¶çš„é“ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591924374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336120,"user_name":"é‚€æœˆå¯¹å½±","can_delete":false,"product_type":"c1","uid":1204313,"ip_address":"","ucode":"A3482EDF73EB0D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QicTra5HbNEwGxeG49XibcUibB82I2hpBnp8tviaiaicvFAojuMtRiaLCyl6syzzoS546H2hJibNAQ3h9XM097iapiaamcEQ/132","comment_is_top":false,"comment_ctime":1645939030,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645939030","product_id":100050101,"comment_content":"è€å¸ˆæ‚¨å¥½ kafkaå®¢æˆ·ç«¯å‘é€è¯·æ±‚1 è¯·æ±‚2 è¯·æ±‚3 æœåŠ¡ç«¯è¿˜å›å“åº”1 å“åº”2 å“åº”3 å“åº”1æ˜¯æ€ä¹ˆå¯¹åº”è¯·æ±‚1çš„è€Œä¸ä¼šåˆ°è¯·æ±‚2ä¸Š çœ‹æºç è¿™æ–¹é¢æ²¡çœ‹æ˜ç™½","like_count":0},{"had_liked":false,"id":326697,"user_name":"xiaoå„¿","can_delete":false,"product_type":"c1","uid":1665318,"ip_address":"","ucode":"6D7C182FCAD14C","user_header":"https://static001.geekbang.org/account/avatar/00/19/69/26/7968c18f.jpg","comment_is_top":false,"comment_ctime":1639635040,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639635040","product_id":100050101,"comment_content":"kafkaè¿æ¥é›†ç¾¤å¦‚æœåªå†™ä¸€ä¸ªbrokeråœ°å€ï¼Œå½“zookeeperæŒ‚æ‰åï¼Œè®¿é—®ä¼šå­˜åœ¨é—®é¢˜å—ï¼Ÿï¼ˆ2.5ç‰ˆæœ¬ï¼‰","like_count":0},{"had_liked":false,"id":324802,"user_name":"èƒ¡å°ç¦¾","can_delete":false,"product_type":"c1","uid":1132315,"ip_address":"","ucode":"1C23B7492C0C9E","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg","comment_is_top":false,"comment_ctime":1638631825,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638631825","product_id":100050101,"comment_content":"è€å¸ˆå…³äº startupComplete() çš„æ³¨é‡Šä¸å¤ªå¯¹. å®ƒå¹¶ä¸æ˜¯ä¸ºäº† ç­‰å¾…åˆå§‹åŒ–å®Œæˆ,è€Œæ˜¯ä¸ºäº†é€šçŸ¥åˆ«çš„çº¿ç¨‹åˆå§‹åŒ–å®Œæˆ.","like_count":0},{"had_liked":false,"id":314913,"user_name":"å‚»å‚»çš„å¸…","can_delete":false,"product_type":"c1","uid":1668617,"ip_address":"","ucode":"14A795523A682E","user_header":"https://static001.geekbang.org/account/avatar/00/19/76/09/62a10668.jpg","comment_is_top":false,"comment_ctime":1633576302,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633576302","product_id":100050101,"comment_content":"è¯¾åé—®é¢˜ï¼šå› ä¸ºAcceptorå’ŒProcessorå·²ç»å®Œæˆé«˜ååã€è´Ÿè½½å‡è¡¡ç­‰ç½‘ç»œæ€§èƒ½ç“¶é¢ˆçš„ç‚¹å’Œè¯»å†™åˆ†ç¦»ï¼Œè€Œä¸”I&#47;Oæ˜¯å±äºé‡é€»è¾‘æ“ä½œï¼ŒæŒ‰ç…§è°æœ‰ç©ºè°å¤„ç†çš„é€»è¾‘ï¼Œå› æ­¤åªéœ€è¦ä¸€ä¸ªRequest é˜Ÿåˆ—ä½œä¸ºç¼“å†²åŒºï¼Œç©ºé—²I&#47;Oçº¿ç¨‹ä»é˜Ÿåˆ—æ‹¿å‡ºæ‰§è¡Œå³å¯ã€‚Acceptorçº¿ç¨‹åªè´Ÿè´£å¤„ç†è¿æ¥æ²¡æœ‰èƒ½åŠ›å¤„ç†å“åº”ï¼ŒæŒ‰ç…§è°å¤„ç†è°å“åº”çš„åŸåˆ™ï¼ŒåŒæ—¶è¿æ¥åˆ°Processorçº¿ç¨‹çš„æ—¶å€™å·²ç»è´Ÿè½½å‡è¡¡äº†ï¼Œå› ä¸ºç”±å¯¹åº”çš„è´Ÿè´£æ¥æ”¶çš„processè´Ÿè´£å“åº”æ˜¯å†è‡ªç„¶ä¸è¿‡äº†ï¼Œå› ä¸ºResponseé˜Ÿåˆ—æ˜¯æ¯ä¸ªprocessorçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªï¼Œè¿™æ ·è®¾è®¡é€»è¾‘å¤„ç†æ›´ä¼˜é›…","like_count":0},{"had_liked":false,"id":309483,"user_name":"å’¸","can_delete":false,"product_type":"c1","uid":1349358,"ip_address":"","ucode":"1F189A2B1A6A71","user_header":"https://static001.geekbang.org/account/avatar/00/14/96/ee/9b21c199.jpg","comment_is_top":false,"comment_ctime":1630159299,"is_pvip":false,"replies":[{"id":"112526","content":"å—¯å—¯ï¼Œæ˜¯è¿™æ ·çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1630810099,"ip_address":"","comment_id":309483,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1630159299","product_id":100050101,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œçœ‹è¿‡è¿™å—çš„ç½‘ç»œæ¨¡å‹åæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºkafkaçš„brokerç«¯é‡‡ç”¨çš„æ˜¯reactorä¸­çš„å¤šçº¿ç¨‹æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªreactorè´Ÿè´£ç½‘ç»œä¸Šçš„é“¾æ¥ï¼Œæ¥æ”¶ç­‰æ“ä½œï¼Œå¤„ç†èµ„æºæ± æ˜¯å¤šä¸ªï¼Œè´Ÿè´£è¯»æ•°æ®ï¼Œå¤„ç†ä¸šåŠ¡(è¿™é‡Œä¹Ÿå°±æ˜¯æ”¾åœ¨é˜Ÿåˆ—é‡Œ)ï¼Œè¿™æ ·ç†è§£å¯¹å—","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525892,"discussion_content":"å—¯å—¯ï¼Œæ˜¯è¿™æ ·çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630810099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":254592,"user_name":"Bryant.C","can_delete":false,"product_type":"c1","uid":1172363,"ip_address":"","ucode":"0DF832373CFA97","user_header":"https://static001.geekbang.org/account/avatar/00/11/e3/8b/27f875ba.jpg","comment_is_top":false,"comment_ctime":1603154392,"is_pvip":false,"replies":[{"id":"93053","content":"å“ˆå“ˆï¼Œè¿™ä¸ªè¦è€ƒè¯ä¸‹äº†ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1603354283,"ip_address":"","comment_id":254592,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1603154392","product_id":100050101,"comment_content":"è€ç‰ˆæœ¬çš„response Queueå¥½åƒç¡®å®æ˜¯ä¿å­˜åœ¨requestChannelä¸­ï¼Œç”¨processor idå»ç´¢å¼•çš„","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507448,"discussion_content":"å“ˆå“ˆï¼Œè¿™ä¸ªè¦è€ƒè¯ä¸‹äº†ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603354283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1757482,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIMFaaIb1ZyU6zuYrT2WlD4RrsV2orxLonpIFwsx3ic01OLJ0N4dnSXQ3mFQxnbemiabKDw9810rX4Q/132","nickname":"Geek_4660f3","note":"","ucode":"8B59B0C29EF88A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565322,"discussion_content":"è€ç‰ˆæœ¬ç¡®å®æ˜¯è¿™æ ·çš„ï¼Œæˆ‘åˆšçœ‹äº†è€ç‰ˆæœ¬ä»£ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650440296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236632,"user_name":"é•¿è„–å­æ ‘","can_delete":false,"product_type":"c1","uid":1182802,"ip_address":"","ucode":"D9090EF67EEB1B","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/52/f25c3636.jpg","comment_is_top":false,"comment_ctime":1595485659,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1595485659","product_id":100050101,"comment_content":"æ€»ç»“äº†ä¸‹ acceptor å’Œ processor çš„å¤„ç†é€»è¾‘<br>Acceptor éƒ¨åˆ†:<br>1. å»ºç«‹ä¸€ä¸ª ServerSocketChannel , å¹¶æ³¨å†Œç›‘å¬ OP_ACCEPT äº‹ä»¶<br>2. å¾ªç¯è°ƒç”¨ select æ–¹æ³•, è·å–äº‹ä»¶é€šçŸ¥,  è¿™æ—¶ä¼šæ‹¿åˆ°ä¸€ä¸ª socketChannel , ç„¶åä½¿ç”¨è½®è¯¢é€‰æ‹©ä¸€ä¸ªç©ºé—²çš„ processor ,<br> å°†è¿™ä¸ª socketChannel æ”¾å…¥ processor çš„ newConnections é˜Ÿåˆ—ä¸­<br><br>Processor éƒ¨åˆ†:<br>1. ç»™ processor çš„ newConnections é˜Ÿåˆ—ä¸­çš„ channel æ³¨å†Œ OP_READ<br>2. ä» responseQueue ä¸­æ‹‰å– response å¯¹è±¡, å‘é€ response , å¹¶å°† å‘é€å®Œçš„ response æ”¾å…¥ inflightResponses é˜Ÿåˆ—ä¸­<br>3. è·å–å¯¹åº”socketChannel ä¸Šå‡†å¤‡å°±ç»ªçš„ IO æ“ä½œ, å°†è·å–åˆ°çš„å­—èŠ‚, å°è£…æˆ NetworkReceive , å¹¶æ”¾å…¥ completedReceives map ä¸­<br>4. ä» completedReceives ä¸­è·å– NetWorkReceive , å°†å…¶å°è£…æˆ Request , æ”¾å…¥æ‰€æœ‰ processor å…±äº«çš„è¯·æ±‚é˜Ÿåˆ— requestQueue ä¸­<br>5. å–å‡º inflightResponses  é˜Ÿåˆ—ä¸­çš„response , å¯¹å…¶è°ƒç”¨å›è°ƒé€»è¾‘<br>6. å¤„ç†è¿æ¥æ–­å¼€åçš„äº‹æƒ…<br>7. å…³é—­è¶…è¿‡é…é¢é™åˆ¶éƒ¨åˆ†çš„è¿æ¥","like_count":0},{"had_liked":false,"id":236630,"user_name":"é•¿è„–å­æ ‘","can_delete":false,"product_type":"c1","uid":1182802,"ip_address":"","ucode":"D9090EF67EEB1B","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/52/f25c3636.jpg","comment_is_top":false,"comment_ctime":1595485417,"is_pvip":true,"replies":[{"id":"87679","content":"å—¯å—¯ï¼Œä½ è¯´çš„æ˜¯å¯¹çš„ã€‚åªæ˜¯æˆ‘ä»¬å¯¹äºâ€œåˆ›å»ºè¿æ¥â€çš„å®šä¹‰å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œé™¤äº†åˆ›å»ºTCPè¿æ¥ï¼ŒKafkaè¿˜éœ€è¦åˆ›å»ºæ‰€éœ€çš„é€šé“ç­‰å¯¹è±¡ï¼Œè¿™åœ¨Kafkaçœ‹æ¥éƒ½æ˜¯æ­£å¸¸å·¥ä½œå‰çš„å‡†å¤‡å·¥ä½œï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1595811126,"ip_address":"","comment_id":236630,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1595485417","product_id":100050101,"comment_content":"æ–‡ä¸­è¯´:<br> æ¯å½“ Processor çº¿ç¨‹æ¥æ”¶æ–°çš„è¿æ¥è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šå°†å¯¹åº”çš„ SocketChannel æ”¾å…¥è¿™ä¸ªé˜Ÿåˆ—ã€‚åé¢åœ¨åˆ›å»ºè¿æ¥æ—¶ï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ configureNewConnections æ—¶ï¼‰ï¼Œå°±ä»è¯¥é˜Ÿåˆ—ä¸­å–å‡º SocketChannelï¼Œç„¶åæ³¨å†Œæ–°çš„è¿æ¥ã€‚<br>æŒ‰ç…§æˆ‘çš„ç†è§£, tcp ä¸‰æ¬¡æ¡æ‰‹æ˜¯åœ¨ Acceptor è°ƒç”¨ accept()  å®Œæˆä¹‹å‰å°±å·²ç»å®Œæˆäº†çš„.  è€Œå¹¶ä¸æ˜¯ processor çš„å·¥ä½œ. processor çš„ configureNewConnections æ–¹æ³•åªæ˜¯å°† å·²ç»å»ºç«‹çš„è¿æ¥å–å‡ºæ¥å†æ¬¡æ³¨å†Œ OP_READ äº‹ä»¶è€Œå·²<br><br>è€å¸ˆæ€ä¹ˆçœ‹? å¤§å®¶æœ‰ä»€ä¹ˆæƒ³æ³•ä¹ˆ?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502153,"discussion_content":"å—¯å—¯ï¼Œä½ è¯´çš„æ˜¯å¯¹çš„ã€‚åªæ˜¯æˆ‘ä»¬å¯¹äºâ€œåˆ›å»ºè¿æ¥â€çš„å®šä¹‰å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œé™¤äº†åˆ›å»ºTCPè¿æ¥ï¼ŒKafkaè¿˜éœ€è¦åˆ›å»ºæ‰€éœ€çš„é€šé“ç­‰å¯¹è±¡ï¼Œè¿™åœ¨Kafkaçœ‹æ¥éƒ½æ˜¯æ­£å¸¸å·¥ä½œå‰çš„å‡†å¤‡å·¥ä½œï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595811126,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2307937,"avatar":"https://static001.geekbang.org/account/avatar/00/23/37/61/51e10a30.jpg","nickname":"QAQ","note":"","ucode":"6E47215CBB81F5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374049,"discussion_content":"kafkaæ‹¿åˆ°åˆ›å»ºè¿æ¥å®Œæˆçš„nioçš„socketchannelåï¼Œéœ€è¦è½¬æˆè‡ªå·±çš„kafkachannelï¼Œæ”¾åˆ°selectorï¼ˆä¹Ÿæ˜¯kafkaè‡ªå·±åŒ…è£…çš„ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620981123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236427,"user_name":"é•¿è„–å­æ ‘","can_delete":false,"product_type":"c1","uid":1182802,"ip_address":"","ucode":"D9090EF67EEB1B","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/52/f25c3636.jpg","comment_is_top":false,"comment_ctime":1595412573,"is_pvip":true,"replies":[{"id":"87402","content":"ğŸ˜ƒ","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1595464889,"ip_address":"","comment_id":236427,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1595412573","product_id":100050101,"comment_content":"Processor ä¸­ run() ä¸­ä¼šè°ƒç”¨ processCompletedReceives() è¿™ä¸ªæ–¹æ³•, å°† request  æ”¾å…¥ requestQueue ä¸­, è¿˜ä»¥ä¸ºå®ƒæ²¡åŠ é”, å¤šä¸ª Processor ä¼šå¯¼è‡´é—®é¢˜.  æœ€åå‘ç° requestQueue æ˜¯ ArrayBlockingQueue , é‡Œé¢ç”¨äº†å¯é‡å…¥é”.  å“å“å“ å¹¶å‘å®¹å™¨åˆå¿˜å¾—å·®ä¸å¤šäº†","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502053,"discussion_content":"ğŸ˜ƒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595464889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230647,"user_name":"yes","can_delete":false,"product_type":"c1","uid":1386201,"ip_address":"","ucode":"612BF6884ED6CC","user_header":"https://static001.geekbang.org/account/avatar/00/15/26/d9/f7e96590.jpg","comment_is_top":false,"comment_ctime":1593440039,"is_pvip":false,"replies":[{"id":"85262","content":"è¿™ä¸ªææ³•å‘¢æ˜¯Kafkaè¿™è¾¹çš„å®šä¹‰ï¼Œä¸æ˜¯æˆ‘è‡ªå·±å‘½åçš„ï¼Œæºç ä¸­å¹¶æ— ä¸šåŠ¡çº¿ç¨‹çš„ææ³•ã€‚ä¸è¿‡æˆ‘ä»¬ç†è§£æ„æ€å°±è¡Œï¼Œä¸ç”¨å¤ªçº ç»“äºç§°è°“","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593507145,"ip_address":"","comment_id":230647,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593440039","product_id":100050101,"comment_content":"å¯¹äºè€å¸ˆä¸€ç›´è®²è¿°çš„ç½‘ç»œçº¿ç¨‹å’ŒIOçº¿ç¨‹æˆ‘ä¸€ç›´è§‰å¾—æœ‰ç‚¹åˆ«æï¼Œå•å•æ˜¯å› ä¸ºå‚æ•°çš„åç§°æ‰€ä»¥è¿™æ ·å«å˜›ï¼Ÿè¿˜æ˜¯å®˜æ–¹å°±æ˜¯è¿™æ ·å‘½åçš„ï¼Ÿ<br>åœ¨æˆ‘çš„å°è±¡ä¸­ï¼Œå¯¹äºkafkaçš„processorçº¿ç¨‹æ‰€åšçš„äº‹ï¼Œæˆ‘è®¤ä¸ºprocessoråº”è¯¥ç§°ä¸ºIOçº¿ç¨‹ï¼Œè¯»å†™socketï¼Œè€ŒKafkaRequestHandlerPoolåšçš„äº‹ï¼Œå¯¹äºBrokeræ¥è¯´ä¸æ­£æ˜¯Brokeræ‰€éœ€è¦çš„åšçš„&quot;ä¸šåŠ¡&quot;ä¹ˆï¼Ÿæ‰€ä»¥ç§°ä¹‹ä¸ºä¸šåŠ¡çº¿ç¨‹è€Œä¸æ˜¯IOçº¿ç¨‹ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499974,"discussion_content":"è¿™ä¸ªææ³•å‘¢æ˜¯Kafkaè¿™è¾¹çš„å®šä¹‰ï¼Œä¸æ˜¯æˆ‘è‡ªå·±å‘½åçš„ï¼Œæºç ä¸­å¹¶æ— ä¸šåŠ¡çº¿ç¨‹çš„ææ³•ã€‚ä¸è¿‡æˆ‘ä»¬ç†è§£æ„æ€å°±è¡Œï¼Œä¸ç”¨å¤ªçº ç»“äºç§°è°“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593507145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217660,"user_name":"huldar","can_delete":false,"product_type":"c1","uid":1396865,"ip_address":"","ucode":"4B2C41B3A6B824","user_header":"https://static001.geekbang.org/account/avatar/00/15/50/81/e9c5a274.jpg","comment_is_top":false,"comment_ctime":1589561474,"is_pvip":false,"replies":[{"id":"80551","content":"æ˜¯ç¢°åˆ°è¿™ä¸ªé”™è¯¯äº†å—ï¼Ÿ java.lang.ClassNotFoundException: com.fasterxml.jackson.databind.JsonNode<br><br>å¦‚æœæ˜¯ï¼Œæˆ‘å€¾å‘äºè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªbug","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589639482,"ip_address":"","comment_id":217660,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1589561474","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæ‚¨å¥½ã€‚å¦‚ä½•æ­£ç¡®è¿è¡ŒApiKeysä¸­çš„mainæ–¹æ³•å‘¢ï¼Ÿç›´æ¥åœ¨ideaä¸­ç‚¹å‡»runæŒ‰é’®ä¼šæŠ¥ClassNotFoundExceptionã€‚æŸ¥èµ„æ–™ååˆ†æåº”è¯¥ä½¿ç”¨gradleçš„taskè¿è¡Œï¼Œä½†æ˜¯åœ¨clientsä¸­æ²¡æœ‰æ‰¾åˆ°åº”è¯¥æ˜¯å“ªä¸ªtaskã€‚è°¢è°¢ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495210,"discussion_content":"æ˜¯ç¢°åˆ°è¿™ä¸ªé”™è¯¯äº†å—ï¼Ÿ java.lang.ClassNotFoundException: com.fasterxml.jackson.databind.JsonNode\n\nå¦‚æœæ˜¯ï¼Œæˆ‘å€¾å‘äºè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªbug","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589639482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1396865,"avatar":"https://static001.geekbang.org/account/avatar/00/15/50/81/e9c5a274.jpg","nickname":"huldar","note":"","ucode":"4B2C41B3A6B824","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":267453,"discussion_content":"å¯¹ï¼Œè€å¸ˆã€‚æ˜¯è¿™ä¸ªå¼‚å¸¸ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589640902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215418,"user_name":"å°å´”","can_delete":false,"product_type":"c1","uid":1104958,"ip_address":"","ucode":"4E537416787752","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1588988433,"is_pvip":false,"replies":[{"id":"79806","content":"producerã€consumerå’Œbrokerç«¯éƒ½éœ€è¦è°ƒæ•´å•Šï¼Œéƒ½æœ‰å„è‡ªçš„å‚æ•°","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1589036299,"ip_address":"","comment_id":215418,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588988433","product_id":100050101,"comment_content":"æ¥ä¸Šæ¡è€å¸ˆå›å¤ï¼Œâ€œÂ å¦‚æœRTTå¾ˆå¤§ï¼Œæˆ‘ä»¬æœ€å¥½æ˜¯è®©Socket bufferç´¯ç§¯æ›´å¤šçš„æ•°æ®ä¹‹åä¸€æ¬¡æ€§å‘é€ï¼ŒèŠ‚çœç½‘ç»œI&#47;Oå¸¦å®½ã€‚â€<br>ä½†è¿™é‡Œè°ƒå¤§çš„ç¼“å†²åŒºæ˜¯brokerç«¯çš„ï¼Œbrokeræ˜¯æ¥æ”¶ç«¯ï¼Œæ ¹æœ¬æªæ–½ä¸åº”è¯¥æ˜¯è°ƒå¤§clientsä¸€æ¬¡å‘é€çš„çš„æ•°æ®é‡ä¹ˆï¼Ÿ<br>è¿˜æ˜¯è¯´è¿™é‡Œçš„brokeræ—¢æ˜¯æ¥æ”¶ç«¯ï¼Œåˆæ˜¯å…¶ä»–brokerçš„clientsï¼Ÿæ–‡ä¸­rttæŒ‡brokerä¹‹é—´çš„é€šè®¯ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494426,"discussion_content":"producerã€consumerå’Œbrokerç«¯éƒ½éœ€è¦è°ƒæ•´å•Šï¼Œéƒ½æœ‰å„è‡ªçš„å‚æ•°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589036299,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214520,"user_name":"å°å´”","can_delete":false,"product_type":"c1","uid":1104958,"ip_address":"","ucode":"4E537416787752","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1588761196,"is_pvip":false,"replies":[{"id":"79566","content":"å¾ˆæœ‰é“ç†ğŸ‘<br>","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588846131,"ip_address":"","comment_id":214520,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588761196","product_id":100050101,"comment_content":"responseè·Ÿå¯¹åº”å’Œsocketé“¾æ¥æ˜¯ç»‘æ­»çš„ï¼Œå¦‚æœæ”¾åˆ°å…±äº«é˜Ÿåˆ—ï¼Œä¹Ÿåªèƒ½ç”¨ä¸€ä¸ªdispatcheræ¥å–ï¼Œå‘ç»™å¯¹åº”processorï¼Œå¾ˆå¤šä½™ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494092,"discussion_content":"å¾ˆæœ‰é“ç†ğŸ‘\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588846131,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214013,"user_name":"ä¼¯å®‰çŸ¥å¿ƒ","can_delete":false,"product_type":"c1","uid":1961835,"ip_address":"","ucode":"6C17706658672C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg","comment_is_top":false,"comment_ctime":1588633856,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588633856","product_id":100050101,"comment_content":"æˆ‘è®¤ä¸º2ç‚¹ï¼Œç¬¬ä¸€ï¼Œä¿æŒå¤„ç†ç‹¬ç«‹æ€§ï¼Œä¸€ä¸ªprocessorå¤„ç†ä¸€ä¸ªé“¾æ¥ï¼›ç¬¬äºŒï¼ŒæŒ‰ç†è¯´é™åˆ¶responseé˜Ÿåˆ—ä»£ç é™åˆ¶è¶Šå°‘ï¼Œè¯·æ±‚è¶Šå¿«ï¼Œæˆ‘ä¸ªäººè§‰å¾—å’ŒçŠ¶æ€æœ‰å…³ç³»ï¼Œkafkaè¯·æ±‚å¤„ç†æ˜¯æ— çŠ¶æ€æ¨¡å¼ï¼Œè¿™ä¹ˆåšæ˜¯åœ¨æœ‰çŠ¶æ€å¤„ç†åšçš„åŠªåŠ›ã€‚è¯´kafkaæ— çŠ¶æ€ä¹Ÿæœ‰é—®é¢˜ï¼Œæœ‰ä¸ªsessionï¼ˆè™½ç„¶å¼€å¯kerberosæ‰ä½¿ç”¨ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªä¹Ÿèƒ½è¯æ˜kafkaå¹¶éç»å¯¹æ— çŠ¶æ€ã€‚","like_count":0},{"had_liked":false,"id":213536,"user_name":"å†¯ç£Š","can_delete":false,"product_type":"c1","uid":1855112,"ip_address":"","ucode":"4FFB8B984269FB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIYj6Zv3ibicLebxo7lsPMEwpBynHkYp8pLc3FcltUfmOBSRxpmicEwIAgP9OvSKnGGdaxwsZ7yiciaSsQ/132","comment_is_top":false,"comment_ctime":1588467677,"is_pvip":false,"replies":[{"id":"79373","content":"è§†é¢‘è¯¾è¿™ç§æ–¹å¼å¯èƒ½åç»­ä¼šè®¤çœŸè€ƒè™‘çœ‹çœ‹çš„ï¼Œç›®å‰ç¡®å®è¿˜æ²¡æœ‰æ€è·¯ã€‚ä¸è¿‡å¤šè°¢é¼“åŠ±ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588743807,"ip_address":"","comment_id":213536,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588467677","product_id":100050101,"comment_content":"åˆ©ç”¨å‡æœŸç»ˆäºè¿½ä¸Šäº†ï¼Œèƒ¡è€å¸ˆè®²å¾—éå¸¸è¯¦ç»†ï¼Œæ„Ÿè°¢ã€‚èƒ¡è€å¸ˆï¼Œæ—¥åæœ‰æ²¡æœ‰æƒ³è¿‡å¼€ä¸€èŠ‚æ“ä½œå®æ“è¯¾ï¼Ÿæ—¥å¸¸å¼€å‘ä¸­å¯èƒ½ä¼šé‡åˆ°ä¸Šé¢æåˆ°çš„æŸç§é—®é¢˜ï¼Œä½†ä¸çŸ¥ä»ä½•ä¸‹æ‰‹ï¼Œå¦‚æœè€å¸ˆå¸¦ç€æ‹¿å‡ºå®é™…ä¸­ä¸€ä¸¤ä¸ªå°æ¡ˆä¾‹æ¥å‰–æä¸‹ï¼Œæˆ‘ä»¬å°±æ›´æ¸…æ™°äº†ï¼Œé‡åˆ°é—®é¢˜ä¹ŸçŸ¥é“å¦‚ä½•æ€è€ƒäº†ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493805,"discussion_content":"è§†é¢‘è¯¾è¿™ç§æ–¹å¼å¯èƒ½åç»­ä¼šè®¤çœŸè€ƒè™‘çœ‹çœ‹çš„ï¼Œç›®å‰ç¡®å®è¿˜æ²¡æœ‰æ€è·¯ã€‚ä¸è¿‡å¤šè°¢é¼“åŠ±ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588743807,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213443,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1588416184,"is_pvip":false,"replies":[{"id":"79376","content":"å—¯ï¼Œå¾ˆæœ‰é“ç†ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588744012,"ip_address":"","comment_id":213443,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1588416184","product_id":100050101,"comment_content":"æˆ‘æ˜¯è¿™æ ·ç†è§£çš„ï¼Œresquestå…±äº«è¿™æ ·æ‰èƒ½å®çº¿ç¨‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œresponseä¸“å±çš„æ˜¯å› ä¸ºå¯¹åº”çš„requestå·²ç»åˆ†é…ç»™å¯¹åº”çš„çº¿ç¨‹å¤„ç†å·²ï¼Œä¸ºäº†é¿å…çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸Šä¸‹æ–‡åˆ‡æ¢ç†å› ä¹Ÿç”±è¿™ä¸ªçº¿ç¨‹å¤„ç†å“åº”ï¼Œä½œä¸ºä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„å˜é‡æ›´åŠ åˆç†","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493780,"discussion_content":"å—¯ï¼Œå¾ˆæœ‰é“ç†ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588744012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1938149,"avatar":"","nickname":"æåæ–Œ","note":"","ucode":"230D09D8CE97AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339542,"discussion_content":"è¯·é—®ä¸€ä¸‹è€å¸ˆï¼Œæˆ‘ä»¬é›†ç¾¤ä¸‰å°è¿æ¥æ•°ï¼Œå¹¶å‘é“¾æ¥æœ€å¤§æ˜¯å¤šå¤§å‘¢ï¼Œæ˜¯æ ¹æ®max.connections æ¥è®¾ç½®çš„å˜›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609727237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1961835,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg","nickname":"ä¼¯å®‰çŸ¥å¿ƒ","note":"","ucode":"6C17706658672C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":257965,"discussion_content":"è¡¥å……ä¸€ä¸‹ï¼Œç½‘ä¸Šè¯´kafkaå¤„ç†æ— çŠ¶æ€ï¼Œæœ‰ä¸ªè¯¯åŒºkafkaæœ‰ä¸ªsessionç±»ï¼Œä¹Ÿç®—æ˜¯æœ‰çŠ¶æ€çš„åŠªåŠ›å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588632883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1961835,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg","nickname":"ä¼¯å®‰çŸ¥å¿ƒ","note":"","ucode":"6C17706658672C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":257961,"discussion_content":"æˆ‘è®¤ä¸º2ç‚¹ï¼Œç¬¬ä¸€ï¼Œä¿æŒå¤„ç†ç‹¬ç«‹æ€§ï¼Œä¸€ä¸ªprocessorå¤„ç†ä¸€ä¸ªé“¾æ¥ï¼›ç¬¬äºŒï¼ŒæŒ‰ç†è¯´é™åˆ¶responseé˜Ÿåˆ—ä»£ç é™åˆ¶è¶Šå°‘ï¼Œè¯·æ±‚è¶Šå¿«ï¼Œæˆ‘ä¸ªäººè§‰å¾—å’ŒçŠ¶æ€æœ‰å…³ç³»ï¼Œkafkaè¯·æ±‚å¤„ç†æ˜¯æ— çŠ¶æ€æ¨¡å¼ï¼Œè¿™ä¹ˆåšæ˜¯åœ¨æœ‰çŠ¶æ€å¤„ç†åšçš„åŠªåŠ›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588632176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}