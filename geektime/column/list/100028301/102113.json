{"id":102113,"title":"15 | OpenResty å’Œåˆ«çš„å¼€å‘å¹³å°æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>ä¸Šä¸€æ¨¡å—ä¸­ï¼Œ ä½ å·²ç»å­¦ä¹ äº† OpenResty çš„ä¸¤ä¸ªåŸºçŸ³ï¼šNGINX å’Œ LuaJITï¼Œç›¸ä¿¡ä½ å·²ç»æ‘©æ‹³æ“¦æŒï¼Œå‡†å¤‡å¼€å§‹å­¦ä¹  OpenResty æä¾›çš„ API äº†å§ï¼Ÿ</p><p>ä¸è¿‡ï¼Œåˆ«ç€æ€¥ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œä½ è¿˜éœ€è¦å†èŠ±ä¸€ç‚¹å„¿æ—¶é—´ï¼Œæ¥ç†Ÿæ‚‰ä¸‹ OpenResty çš„åŸç†å’ŒåŸºæœ¬æ¦‚å¿µã€‚</p><h2>åŸç†</h2><p>åœ¨å‰é¢çš„ LuaJIT å†…å®¹ä¸­ï¼Œä½ å·²ç»è§è¿‡ä¸‹é¢è¿™ä¸ªæ¶æ„å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/14/f0/14ab2f0c81c170234ab739cb700a62f0.png?wh=1146*828\" alt=\"\"></p><p>è¿™é‡Œæˆ‘å†è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚</p><p>OpenResty çš„ master å’Œ worker è¿›ç¨‹ä¸­ï¼Œéƒ½åŒ…å«ä¸€ä¸ª LuaJIT VMã€‚åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…çš„æ‰€æœ‰åç¨‹ï¼Œéƒ½ä¼šå…±äº«è¿™ä¸ª VMï¼Œå¹¶åœ¨è¿™ä¸ª VM ä¸­è¿è¡Œ Lua ä»£ç ã€‚</p><p>è€Œåœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œæ¯ä¸ª worker è¿›ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªåç¨‹åœ¨è¿è¡Œã€‚çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šNGINX æ—¢ç„¶èƒ½å¤Ÿæ”¯æŒ C10K ï¼ˆä¸Šä¸‡å¹¶å‘ï¼‰ï¼Œä¸æ˜¯éœ€è¦åŒæ—¶å¤„ç†ä¸€ä¸‡ä¸ªè¯·æ±‚å—ï¼Ÿ</p><p>å½“ç„¶ä¸æ˜¯ï¼ŒNGINX å®é™…ä¸Šæ˜¯é€šè¿‡ epoll çš„äº‹ä»¶é©±åŠ¨ï¼Œæ¥å‡å°‘ç­‰å¾…å’Œç©ºè½¬ï¼Œæ‰å°½å¯èƒ½åœ°è®© CPU èµ„æºéƒ½ç”¨äºå¤„ç†ç”¨æˆ·çš„è¯·æ±‚ã€‚æ¯•ç«Ÿï¼Œåªæœ‰å•ä¸ªçš„è¯·æ±‚è¢«è¶³å¤Ÿå¿«åœ°å¤„ç†å®Œï¼Œæ•´ä½“æ‰èƒ½è¾¾åˆ°é«˜æ€§èƒ½çš„ç›®çš„ã€‚å¦‚æœé‡‡ç”¨çš„æ˜¯å¤šçº¿ç¨‹æ¨¡å¼ï¼Œè®©ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆåœ¨ C10K çš„æƒ…å†µä¸‹ï¼Œèµ„æºå¾ˆå®¹æ˜“å°±ä¼šè¢«è€—å°½çš„ã€‚</p><p>åœ¨ OpenResty å±‚é¢ï¼ŒLua çš„åç¨‹ä¼šä¸ NGINX çš„äº‹ä»¶æœºåˆ¶ç›¸äº’é…åˆã€‚å¦‚æœ Lua ä»£ç ä¸­å‡ºç°ç±»ä¼¼æŸ¥è¯¢ MySQL æ•°æ®åº“è¿™æ ·çš„ I/O æ“ä½œï¼Œå°±ä¼šå…ˆè°ƒç”¨ Lua åç¨‹çš„ yield æŠŠè‡ªå·±æŒ‚èµ·ï¼Œç„¶ååœ¨ NGINX ä¸­æ³¨å†Œå›è°ƒï¼›åœ¨ I/O æ“ä½œå®Œæˆï¼ˆä¹Ÿå¯èƒ½æ˜¯è¶…æ—¶æˆ–è€…å‡ºé”™ï¼‰åï¼Œå†ç”± NGINX å›è°ƒ resume æ¥å”¤é†’ Lua åç¨‹ã€‚è¿™æ ·å°±å®Œæˆäº† Lua åç¨‹å’Œ NGINX äº‹ä»¶é©±åŠ¨çš„é…åˆï¼Œé¿å…åœ¨ Lua ä»£ç ä¸­å†™å›è°ƒã€‚</p><!-- [[[read_end]]] --><p>æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼Œæè¿°äº†è¿™æ•´ä¸ªæµç¨‹ã€‚å…¶ä¸­ï¼Œ<code>lua_yield</code> å’Œ <code>lua_resume</code> éƒ½å±äº Lua æä¾›çš„ <code>lua_CFunction</code>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/fa/34/fae1008edb43c7476cf2f20da9928234.png?wh=1728*764\" alt=\"\"></p><p>å¦å¤–ä¸€ä¸ªæ–¹é¢ï¼Œå¦‚æœ Lua ä»£ç ä¸­æ²¡æœ‰ I/O æˆ–è€… sleep æ“ä½œï¼Œæ¯”å¦‚å…¨æ˜¯å¯†é›†çš„åŠ è§£å¯†è¿ç®—ï¼Œé‚£ä¹ˆ Lua åç¨‹å°±ä¼šä¸€ç›´å ç”¨ LuaJIT VMï¼Œç›´åˆ°å¤„ç†å®Œæ•´ä¸ªè¯·æ±‚ã€‚</p><p>ä¸‹é¢æˆ‘æä¾›äº† <code>ngx.sleep</code> çš„ä¸€æ®µæºç ï¼Œå¯ä»¥å¸®ä½ æ›´æ¸…æ™°ç†è§£è¿™ä¸€ç‚¹ã€‚ è¿™æ®µä»£ç ä½äº <code>ngx_http_lua_sleep.c</code> ä¸­ï¼Œä½ å¯ä»¥åœ¨ <code>lua-nginx-module</code> é¡¹ç›®çš„  <a href=\"https://github.com/openresty/lua-nginx-module/tree/master/src\">src ç›®å½•</a>ä¸­æ‰¾åˆ°å®ƒã€‚</p><p>åœ¨<code>ngx_http_lua_sleep.c</code> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° sleep å‡½æ•°çš„å…·ä½“å®ç°ã€‚ä½ éœ€è¦å…ˆé€šè¿‡ C å‡½æ•° <code>ngx_http_lua_ngx_sleep</code>ï¼Œæ¥æ³¨å†Œ <code>ngx.sleep</code> è¿™ä¸ª Lua APIï¼š</p><pre><code>void\nngx_http_lua_inject_sleep_api(lua_State *L)\n{\n     lua_pushcfunction(L, ngx_http_lua_ngx_sleep);\n     lua_setfield(L, -2, &quot;sleep&quot;);\n}\n</code></pre><p>ä¸‹é¢ä¾¿æ˜¯ sleep çš„ä¸»å‡½æ•°ï¼Œè¿™é‡Œæˆ‘åªæ‘˜å–äº†å‡ è¡Œä¸»è¦çš„ä»£ç ï¼š</p><pre><code>static int ngx_http_lua_ngx_sleep(lua_State *L)\n{\n    coctx-&gt;sleep.handler = ngx_http_lua_sleep_handler;\n    ngx_add_timer(&amp;coctx-&gt;sleep, (ngx_msec_t) delay);\n    return lua_yield(L, 0);\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼š</p><ul>\n<li>è¿™é‡Œå…ˆå¢åŠ äº† <code>ngx_http_lua_sleep_handler</code> è¿™ä¸ªå›è°ƒå‡½æ•°ï¼›</li>\n<li>ç„¶åè°ƒç”¨ <code>ngx_add_timer</code> è¿™ä¸ª NGINX æä¾›çš„æ¥å£ï¼Œå‘ NGINX çš„äº‹ä»¶å¾ªç¯ä¸­å¢åŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼›</li>\n<li>æœ€åä½¿ç”¨ <code>lua_yield</code> æŠŠ Lua åç¨‹æŒ‚èµ·ï¼ŒæŠŠæ§åˆ¶æƒäº¤ç»™ NGINX çš„äº‹ä»¶å¾ªç¯ã€‚</li>\n</ul><p>å½“ sleep æ“ä½œå®Œæˆåï¼Œ <code>ngx_http_lua_sleep_handler</code> è¿™ä¸ªå›è°ƒå‡½æ•°å°±è¢«è§¦å‘äº†ã€‚å®ƒé‡Œé¢è°ƒç”¨äº† <code>ngx_http_lua_sleep_resume</code>, å¹¶æœ€ç»ˆä½¿ç”¨ <code>lua_resume</code> å”¤é†’äº† Lua åç¨‹ã€‚æ›´å…·ä½“çš„è°ƒç”¨è¿‡ç¨‹ï¼Œä½ å¯ä»¥è‡ªå·±å»ä»£ç é‡Œé¢æ£€ç´¢ï¼Œè¿™é‡Œæˆ‘å°±ä¸å±•å¼€æè¿°äº†ã€‚</p><p><code>ngx.sleep</code> åªæ˜¯æœ€ç®€å•çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œä¸è¿‡é€šè¿‡å¯¹å®ƒçš„å‰–æï¼Œä½ å¯ä»¥çœ‹å‡º <code>lua-nginx-module</code> æ¨¡å—çš„åŸºæœ¬åŸç†ã€‚</p><h2>åŸºæœ¬æ¦‚å¿µ</h2><p>åˆ†æå®ŒåŸç†ä¹‹åï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œå›å¿†ä¸‹ OpenResty ä¸­<strong>é˜¶æ®µ</strong>å’Œ<strong>éé˜»å¡</strong>è¿™ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µã€‚</p><p>OpenResty å’Œ NGINX ä¸€æ ·ï¼Œéƒ½æœ‰é˜¶æ®µçš„æ¦‚å¿µï¼Œå¹¶ä¸”æ¯ä¸ªé˜¶æ®µéƒ½æœ‰è‡ªå·±ä¸åŒçš„ä½œç”¨ï¼š</p><ul>\n<li><code>set_by_lua</code>ï¼Œç”¨äºè®¾ç½®å˜é‡ï¼›</li>\n<li><code>rewrite_by_lua</code>ï¼Œç”¨äºè½¬å‘ã€é‡å®šå‘ç­‰ï¼›</li>\n<li><code>access_by_lua</code>ï¼Œç”¨äºå‡†å…¥ã€æƒé™ç­‰ï¼›</li>\n<li><code>content_by_lua</code>ï¼Œç”¨äºç”Ÿæˆè¿”å›å†…å®¹ï¼›</li>\n<li><code>header_filter_by_lua</code>ï¼Œç”¨äºåº”ç­”å¤´è¿‡æ»¤å¤„ç†ï¼›</li>\n<li><code>body_filter_by_lua</code>ï¼Œç”¨äºåº”ç­”ä½“è¿‡æ»¤å¤„ç†ï¼›</li>\n<li><code>log_by_lua</code>ï¼Œç”¨äºæ—¥å¿—è®°å½•ã€‚</li>\n</ul><p>å½“ç„¶ï¼Œå¦‚æœä½ çš„ä»£ç é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œéƒ½æ”¾åœ¨ rewrite æˆ–è€… content é˜¶æ®µæ‰§è¡Œï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>ä¸è¿‡éœ€è¦æ³¨æ„ï¼ŒOpenResty çš„ API æ˜¯æœ‰é˜¶æ®µä½¿ç”¨é™åˆ¶çš„ã€‚æ¯ä¸€ä¸ª API éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ä½¿ç”¨é˜¶æ®µåˆ—è¡¨ï¼Œå¦‚æœä½ è¶…èŒƒå›´ä½¿ç”¨å°±ä¼šæŠ¥é”™ã€‚è¿™ä¸å…¶ä»–çš„å¼€å‘è¯­è¨€æœ‰å¾ˆå¤§çš„ä¸åŒã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œè¿™é‡Œæˆ‘è¿˜æ˜¯ä»¥ <code>ngx.sleep</code> ä¸ºä¾‹ã€‚é€šè¿‡æŸ¥é˜…æ–‡æ¡£ï¼Œæˆ‘çŸ¥é“å®ƒåªèƒ½ç”¨äºä¸‹é¢åˆ—å‡ºçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä¸åŒ…æ‹¬ log é˜¶æ®µï¼š</p><pre><code>context: rewrite_by_lua*, access_by_lua*, content_by_lua*, ngx.timer.*, ssl_certificate_by_lua*, ssl_session_fetch_by_lua*_\n</code></pre><p>è€Œå¦‚æœä½ ä¸çŸ¥é“è¿™ä¸€ç‚¹ï¼Œåœ¨å®ƒä¸æ”¯æŒçš„ log é˜¶æ®µä½¿ç”¨ sleep çš„è¯:</p><pre><code>location / {\n    log_by_lua_block {\n        ngx.sleep(1)\n     }\n}\n</code></pre><p>åœ¨ NGINX çš„é”™è¯¯æ—¥å¿—ä¸­ï¼Œå°±ä¼šå‡ºç° error çº§åˆ«çš„æç¤ºï¼š</p><pre><code>[error] 62666#0: *6 failed to run log_by_lua*: log_by_lua(nginx.conf:14):2: API disabled in the context of log_by_lua*\nstack traceback:\n    [C]: in function 'sleep'\n</code></pre><p>æ‰€ä»¥ï¼Œåœ¨ä½ ä½¿ç”¨ API ä¹‹å‰ï¼Œä¸€å®šè®°å¾—è¦å…ˆæŸ¥é˜…æ–‡æ¡£ï¼Œç¡®å®šå…¶èƒ½å¦åœ¨ä»£ç çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚</p><p>å¤ä¹ äº†é˜¶æ®µçš„æ¦‚å¿µåï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸‹éé˜»å¡ã€‚é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œç”± OpenResty æä¾›çš„æ‰€æœ‰ APIï¼Œéƒ½æ˜¯éé˜»å¡çš„ã€‚</p><p>æˆ‘ç»§ç»­ä»¥ sleep 1 ç§’è¿™ä¸ªéœ€æ±‚ä¸ºä¾‹æ¥è¯´æ˜ã€‚å¦‚æœä½ è¦åœ¨ Lua ä¸­å®ç°å®ƒï¼Œä½ éœ€è¦è¿™æ ·åšï¼š</p><pre><code>function sleep(s)\n   local ntime = os.time() + s\n   repeat until os.time() &gt; ntime\nend\n</code></pre><p>å› ä¸ºæ ‡å‡† Lua æ²¡æœ‰ç›´æ¥çš„ sleep å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ç”¨ä¸€ä¸ªå¾ªç¯ï¼Œæ¥ä¸åœåœ°åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æŒ‡å®šçš„æ—¶é—´ã€‚è¿™ä¸ªå®ç°å°±æ˜¯é˜»å¡çš„ï¼Œåœ¨ sleep çš„è¿™ä¸€ç§’é’Ÿæ—¶é—´å†…ï¼ŒLua æ­£åœ¨åšæ— ç”¨åŠŸï¼Œè€Œå…¶ä»–éœ€è¦å¤„ç†çš„è¯·æ±‚ï¼Œåªèƒ½åœ¨ä¸€è¾¹å‚»å‚»åœ°ç­‰å¾…ã€‚</p><p>ä¸è¿‡ï¼Œè¦æ˜¯æ¢æˆ <code>ngx.sleep(1)</code> æ¥å®ç°çš„è¯ï¼Œæ ¹æ®ä¸Šé¢æˆ‘ä»¬åˆ†æè¿‡çš„æºç ï¼Œåœ¨è¿™ä¸€ç§’é’Ÿçš„æ—¶é—´å†…ï¼ŒOpenResty ä¾ç„¶å¯ä»¥å»å¤„ç†å…¶ä»–è¯·æ±‚ï¼ˆæ¯”å¦‚ B è¯·æ±‚ï¼‰ï¼Œå½“å‰è¯·æ±‚ï¼ˆæˆ‘ä»¬å«å®ƒ A è¯·æ±‚ï¼‰çš„ä¸Šä¸‹æ–‡ä¼šè¢«ä¿å­˜èµ·æ¥ï¼Œå¹¶ç”± NGINX çš„äº‹ä»¶æœºåˆ¶æ¥å”¤é†’ï¼Œå†å›åˆ° A è¯·æ±‚ï¼Œè¿™æ · CPU å°±ä¸€ç›´å¤„äºçœŸæ­£çš„å·¥ä½œçŠ¶æ€ã€‚</p><h2>å˜é‡å’Œç”Ÿå‘½å‘¨æœŸ</h2><p>é™¤äº†è¿™ä¸¤ä¸ªé‡è¦æ¦‚å¿µå¤–ï¼Œ<strong>å˜é‡çš„ç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œä¹Ÿæ˜¯ OpenResty å¼€å‘ä¸­å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚</p><p>å‰é¢è¯´è¿‡ï¼Œåœ¨ OpenResty ä¸­ï¼Œæˆ‘æ¨èä½ æŠŠæ‰€æœ‰å˜é‡éƒ½å£°æ˜ä¸ºå±€éƒ¨å˜é‡ï¼Œå¹¶ç”¨ luacheck å’Œ lua-releng è¿™æ ·çš„å·¥å…·æ¥æ£€æµ‹å…¨å±€å˜é‡ã€‚è¿™å…¶å®å¯¹äºæ¨¡å—æ¥è¯´ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·çš„å†™æ³•ï¼š</p><pre><code>local ngx_re = require &quot;ngx.re&quot;\n</code></pre><p>å…¶å®ï¼Œåœ¨ OpenResty ä¸­ï¼Œé™¤äº† <code>init_by_lua</code> å’Œ <code>init_worker_by_lua</code> è¿™ä¸¤ä¸ªé˜¶æ®µå¤–ï¼Œå…¶ä½™é˜¶æ®µéƒ½ä¼šè®¾ç½®ä¸€ä¸ªéš”ç¦»çš„å…¨å±€å˜é‡è¡¨ï¼Œä»¥å…åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ±¡æŸ“äº†å…¶ä»–è¯·æ±‚ã€‚å³ä½¿åœ¨è¿™ä¸¤ä¸ªå¯ä»¥å®šä¹‰å…¨å±€å˜é‡çš„é˜¶æ®µï¼Œä½ ä¹Ÿåº”è¯¥å°½é‡é¿å…å»å®šä¹‰å…¨å±€å˜é‡ã€‚</p><p>é€šå¸¸æ¥è¯´ï¼Œè¯•å›¾ç”¨å…¨å±€å˜é‡æ¥è§£å†³çš„é—®é¢˜ï¼Œå…¶å®æ›´åº”è¯¥ç”¨æ¨¡å—çš„å˜é‡æ¥è§£å†³ï¼Œè€Œä¸”è¿˜ä¼šæ›´åŠ æ¸…æ™°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡å—ä¸­å˜é‡çš„ç¤ºä¾‹ï¼š</p><pre><code>local _M = {}\n\n_M.color = {\n      red = 1,\n      blue = 2,\n      green = 3\n  }\n\n  return _M\n</code></pre><p>æˆ‘åœ¨ä¸€ä¸ªåä¸º hello.lua çš„æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ªæ¨¡å—ï¼Œæ¨¡å—åŒ…å«äº† color è¿™ä¸ª tableã€‚ç„¶åï¼Œæˆ‘åˆåœ¨ nginx.conf ä¸­å¢åŠ äº†å¯¹åº”çš„é…ç½®ï¼š</p><pre><code>location / {\n    content_by_lua_block {\n        local hello = require &quot;hello&quot;\n        ngx.say(hello.color.green)\n     }\n}\n</code></pre><p>è¿™æ®µé…ç½®ä¼šåœ¨ content é˜¶æ®µä¸­ require è¿™ä¸ªæ¨¡å—ï¼Œå¹¶æŠŠ green çš„å€¼ä½œä¸º http è¯·æ±‚è¿”å›ä½“æ‰“å°å‡ºæ¥ã€‚</p><p>ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œæ¨¡å—å˜é‡ä¸ºä»€ä¹ˆè¿™ä¹ˆç¥å¥‡å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œåœ¨åŒä¸€ worker è¿›ç¨‹ä¸­ï¼Œæ¨¡å—åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼›ä¹‹åè¿™ä¸ª worker å¤„ç†çš„æ‰€æœ‰è¯·æ±‚ï¼Œå°±å¯ä»¥å…±äº«æ¨¡å—ä¸­çš„æ•°æ®äº†ã€‚æˆ‘ä»¬è¯´â€œå…¨å±€â€çš„æ•°æ®å¾ˆé€‚åˆå°è£…åœ¨æ¨¡å—å†…ï¼Œæ˜¯å› ä¸º OpenResty çš„ worker ä¹‹é—´å®Œå…¨éš”ç¦»ï¼Œæ‰€ä»¥æ¯ä¸ª worker éƒ½ä¼šç‹¬ç«‹åœ°å¯¹æ¨¡å—è¿›è¡ŒåŠ è½½ï¼Œè€Œæ¨¡å—çš„æ•°æ®ä¹Ÿä¸èƒ½è·¨è¶Š workerã€‚</p><p>è‡³äºåº”è¯¥å¦‚ä½•å¤„ç† worker ä¹‹é—´éœ€è¦å…±äº«çš„æ•°æ®ï¼Œæˆ‘ä¼šç•™åˆ°åé¢çš„ç« èŠ‚æ¥è®²è§£ï¼Œè¿™é‡Œä½ å…ˆä¸å¿…æ·±ç©¶ã€‚</p><p>ä¸è¿‡ï¼Œè¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªå¾ˆå®¹æ˜“å‡ºé”™çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯<strong>è®¿é—®æ¨¡å—å˜é‡çš„æ—¶å€™ï¼Œä½ æœ€å¥½ä¿æŒåªè¯»ï¼Œè€Œä¸è¦å°è¯•å»ä¿®æ”¹ï¼Œä¸ç„¶åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¼šå‡ºç° race</strong>ã€‚è¿™ç§ bug ä¾é å•å…ƒæµ‹è¯•æ˜¯æ— æ³•å‘ç°çš„ï¼Œå®ƒåœ¨çº¿ä¸Šå¶å°”ä¼šå‡ºç°ï¼Œå¹¶ä¸”å¾ˆéš¾å®šä½ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¨¡å—å˜é‡ green å½“å‰çš„å€¼æ˜¯ 3ï¼Œè€Œä½ åœ¨ä»£ç ä¸­åšäº†åŠ  1 çš„æ“ä½œï¼Œé‚£ä¹ˆç°åœ¨ green çš„å€¼æ˜¯ 4 å—ï¼Ÿä¸ä¸€å®šï¼Œå®ƒå¯èƒ½æ˜¯ 4ï¼Œä¹Ÿå¯èƒ½æ˜¯ 5 æˆ–è€…æ˜¯ 6ã€‚å› ä¸ºåœ¨å¯¹æ¨¡å—å˜é‡è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼ŒOpenResty å¹¶ä¸ä¼šåŠ é”ï¼Œè¿™æ—¶å°±ä¼šäº§ç”Ÿç«äº‰ï¼Œæ¨¡å—å˜é‡çš„å€¼å°±ä¼šè¢«å¤šä¸ªè¯·æ±‚åŒæ—¶æ›´æ–°ã€‚</p><p>è¯´å®Œäº†å…¨å±€å˜é‡ã€å±€éƒ¨å˜é‡å’Œæ¨¡å—å˜é‡ï¼Œæœ€åæˆ‘ä»¬å†æ¥è®²è®²è·¨é˜¶æ®µçš„å˜é‡ã€‚</p><p>æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯è·¨è¶Šé˜¶æ®µçš„ã€å¯ä»¥è¯»å†™çš„å˜é‡ã€‚è€Œåƒæˆ‘ä»¬ç†Ÿæ‚‰çš„ NGINX ä¸­ <code>$host</code>ã€<code>$scheme</code> ç­‰å˜é‡ï¼Œè™½ç„¶æ»¡è¶³è·¨è¶Šé˜¶æ®µçš„æ¡ä»¶ï¼Œä½†å´æ— æ³•åšåˆ°åŠ¨æ€åˆ›å»ºï¼Œä½ å¿…é¡»å…ˆåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰æ‰èƒ½ä½¿ç”¨å®ƒä»¬ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ ·çš„å†™æ³•ï¼š</p><pre><code>location /foo {\n      set $my_var ; # éœ€è¦å…ˆåˆ›å»º $my_var å˜é‡\n      content_by_lua_block {\n          ngx.var.my_var = 123\n      }\n  }\n</code></pre><p>OpenResty æä¾›äº† <code>ngx.ctx</code>ï¼Œæ¥è§£å†³è¿™ç±»é—®é¢˜ã€‚å®ƒæ˜¯ä¸€ä¸ª Lua tableï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨åŸºäºè¯·æ±‚çš„ Lua æ•°æ®ï¼Œä¸”ç”Ÿå­˜å‘¨æœŸä¸å½“å‰è¯·æ±‚ç›¸åŒã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å®˜æ–¹æ–‡æ¡£ä¸­çš„è¿™ä¸ªç¤ºä¾‹ï¼š</p><pre><code>location /test {\n      rewrite_by_lua_block {\n          ngx.ctx.foo = 76\n      }\n      access_by_lua_block {\n          ngx.ctx.foo = ngx.ctx.foo + 3\n      }\n      content_by_lua_block {\n          ngx.say(ngx.ctx.foo)\n      }\n  }\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå˜é‡ <code>foo</code>ï¼Œå­˜æ”¾åœ¨ <code>ngx.ctx</code> ä¸­ã€‚è¿™ä¸ªå˜é‡è·¨è¶Šäº† rewriteã€access å’Œ content ä¸‰ä¸ªé˜¶æ®µï¼Œæœ€ç»ˆåœ¨ content é˜¶æ®µæ‰“å°å‡ºäº†å€¼ï¼Œå¹¶ä¸”æ˜¯æˆ‘ä»¬é¢„æœŸçš„ 79ã€‚</p><p>å½“ç„¶ï¼Œ<code>ngx.ctx</code> ä¹Ÿæœ‰è‡ªå·±çš„å±€é™æ€§ï¼š</p><ul>\n<li>æ¯”å¦‚è¯´ï¼Œä½¿ç”¨ <code>ngx.location.capture</code> åˆ›å»ºçš„å­è¯·æ±‚ï¼Œä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ <code>ngx.ctx</code> æ•°æ®ï¼Œå’Œçˆ¶è¯·æ±‚çš„ <code>ngx.ctx</code> äº’ä¸å½±å“ï¼›</li>\n<li>å†å¦‚ï¼Œä½¿ç”¨ <code>ngx.exec</code> åˆ›å»ºçš„å†…éƒ¨é‡å®šå‘ï¼Œä¼šé”€æ¯åŸå§‹è¯·æ±‚çš„ <code>ngx.ctx</code>ï¼Œé‡æ–°ç”Ÿæˆç©ºç™½çš„ <code>ngx.ctx</code>ã€‚</li>\n</ul><p>è¿™ä¸¤ä¸ªå±€é™ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­éƒ½æœ‰è¯¦ç»†çš„<a href=\"https://github.com/openresty/lua-nginx-module#ngxctx\">ä»£ç ç¤ºä¾‹</a>ï¼Œå¦‚æœä½ æœ‰å…´è¶£å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>æœ€åï¼Œæˆ‘å†å¤šè¯´å‡ å¥ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ çš„æ˜¯ OpenResty çš„åŸç†å’Œå‡ ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œä¸è¿‡ï¼Œä½ å¹¶ä¸éœ€è¦èƒŒå¾—æ»šç“œçƒ‚ç†Ÿï¼Œæ¯•ç«Ÿï¼Œè¿™äº›æ¦‚å¿µæ€»æ˜¯åœ¨å’Œå®é™…éœ€æ±‚ä»¥åŠä»£ç ç»“åˆåœ¨ä¸€èµ·æ—¶ï¼Œæ‰ä¼šå˜å¾—æœ‰æ„ä¹‰å¹¶ç”ŸåŠ¨èµ·æ¥ã€‚</p><p>ä¸çŸ¥é“ä½ æ˜¯å¦‚ä½•ç†è§£çš„å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€å’Œæˆ‘ä¸€èµ·æ¢è®¨ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":108177,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1561691204,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40216396868","product_id":100028301,"comment_content":"è¯´ä¸€æ®µæ¯”è¾ƒç»•å£çš„åºŸè¯æ¥ç†è§£åç¨‹ã€å¼‚æ­¥ï¼š<br>openrestyä¸­çš„ä¸€ä¸ªworkerè¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹æ˜¯è½»é‡åŒ–çš„çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥å«å¾®çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºåç¨‹ï¼Œæ‰€è°“åç¨‹å°±æ˜¯å¤„ç†åç¨‹å¯¹è±¡çš„çº¿ç¨‹ï¼Œæ‰€è°“åç¨‹å¯¹è±¡å°±æ˜¯å¼‚æ­¥åŒ–çš„ä»£ç ç‰‡æ®µï¼Œæ‰€è°“å¼‚æ­¥åŒ–å°±æ˜¯é‡åˆ°ç½‘ç»œI&#47;Oç£ç›˜I&#47;Oç­‰è€—æ—¶I&#47;Oæ“ä½œæ—¶ä½¿CPUåœæ­¢ç­‰å¾…I&#47;Oï¼Œé©¬ä¸Šå»å¤„ç†ä¸‹ä¸€ä¸ªåç¨‹å¯¹è±¡ï¼Œé¿å…ç™½ç™½æµªè´¹CPUæ—¶é—´ï¼Œè¿™å°±æ˜¯éé˜»å¡ï¼Œå…·ä½“è¯´åº”è¯¥å«CPUéé˜»å¡ï¼Œå½“ä¹‹å‰çš„åç¨‹å¯¹è±¡I&#47;Oå®Œæˆåï¼ŒCPUåœ¨å›å»ç»§ç»­å¤„ç†è¯¥åç¨‹å¯¹è±¡å‰©ä½™çš„ä»£ç ï¼Œå½“ç„¶äº†ç»§ç»­å¤„ç†è¿‡ç¨‹ä¸­é‡åˆ°I&#47;Oé˜»å¡è¿˜ä¼šç»§ç»­ä¸­æ–­è·³å‡ºå»æ‰§è¡Œå…¶ä»–åç¨‹å¯¹è±¡ï¼Œå¾€å¤...","like_count":9},{"had_liked":false,"id":123019,"user_name":"jackstraw","can_delete":false,"product_type":"c1","uid":1137207,"ip_address":"","ucode":"C967D2D6158F99","user_header":"https://static001.geekbang.org/account/avatar/00/11/5a/37/8775d714.jpg","comment_is_top":false,"comment_ctime":1565593005,"is_pvip":false,"replies":[{"id":"46055","content":"å¦‚æœä¿®æ”¹çš„ä¸­é€”æœ‰ yield æ“ä½œï¼Œå°±å¯èƒ½ä¼šæœ‰ raceã€‚æ²¡æœ‰ yield çš„è¯è‡ªç„¶æ²¡æœ‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1566196533,"ip_address":"","comment_id":123019,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23040429485","product_id":100028301,"comment_content":"è€å¸ˆè¯´çš„ï¼Œâ€œè®¿é—®æ¨¡å—å˜é‡çš„æ—¶å€™ï¼Œä½ æœ€å¥½ä¿æŒåªè¯»ï¼Œè€Œä¸è¦å°è¯•å»ä¿®æ”¹ï¼Œä¸ç„¶åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¼šå‡ºç° raceâ€è¿™ä¸ªé—®é¢˜æœ‰ç‚¹ç–‘æƒ‘ã€‚æ—¢ç„¶æ¯ä¸ªworkeråŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªè¯·æ±‚åœ¨è¿›è¡Œä¸­ï¼Œé‚£ä¹ˆåŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªè¯·æ±‚æ­£åœ¨æ“ä½œè¿™ä¸ªæ¨¡å—å˜é‡å•Šï¼Ÿæ€ä¹ˆä¼šå‡ºç°raceï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462500,"discussion_content":"å¦‚æœä¿®æ”¹çš„ä¸­é€”æœ‰ yield æ“ä½œï¼Œå°±å¯èƒ½ä¼šæœ‰ raceã€‚æ²¡æœ‰ yield çš„è¯è‡ªç„¶æ²¡æœ‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566196533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1101764,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cf/c4/2ca9e47b.jpg","nickname":"åšå¼ºå°ç†Š9","note":"","ucode":"E013A055398003","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574238,"discussion_content":"æˆ‘ä¹Ÿæœ‰è¿™ä¸ªç–‘é—®ï¼Ÿï¼Ÿ openrestyå¤§éƒ¨åˆ†ä¸æ˜¯ åŒæ­¥éé˜»å¡å—ï¼Ÿï¼Ÿï¼Ÿ åŒä¸€ä¸ªè¯·æ±‚ï¼Œè¢«ä¸€ä¸ªwokrå¤„ç†æ—¶ï¼Œè¢«yeildæŒ‚èµ·æ¥ã€‚åªæ˜¯cpuåœ¨è®©å‡ºã€‚ä½†æ˜¯è¯·æ±‚è¿˜æ˜¯åŒæ­¥å§ã€‚å¦‚ä½•raceå‘¢ï¼Ÿï¼Ÿï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653918897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108373,"user_name":"é˜³å…‰æ¢¦","can_delete":false,"product_type":"c1","uid":1283965,"ip_address":"","ucode":"55BDA128D39931","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/TTPicMEZ5s1zKiaKYecIljicRV9dibITPM0958W3VuNHXlTQic2Dj6XYGibF7dqrG3JWr0LMx7hY9zXGzuvTDNGw8KAA/132","comment_is_top":false,"comment_ctime":1561731580,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14446633468","product_id":100028301,"comment_content":"è€å¸ˆï¼ŒåŸºäºworkerçš„ç¼“å­˜æ¨¡å—ï¼Œå¯¹æ•°æ®æ”¹å†™æ“ä½œæ—¶å€™ä¹Ÿæœ‰ç«äº‰ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1532404,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIvUlicgrWtibbDzwhLw5cQrDSy2JuE1mVvmXq11KQIwpLicgDuWfpp9asE0VCN6HhibPDWn7wBc2lfmA/132","nickname":"aã€","note":"","ucode":"590FE8DB111492","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576785,"discussion_content":"è¿™é‡Œçš„ç«äº‰è¯´çš„æ›´å¤šçš„æ˜¯ä¸ä¸€è‡´å§ï¼Œå› ä¸ºæ˜¯åŸºäºworkerçš„ç¼“å­˜ï¼Œå¦‚æœnginxæ˜¯å¼€å¯äº†å¤šworkerçš„ï¼Œé‚£ä¹ˆå¯¹æ•°æ®è¿›è¡Œå†™æ“ä½œï¼Œå°±è‚¯å®šæ˜¯ä¸ä¸€è‡´çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655790601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120485,"avatar":"https://static001.geekbang.org/account/avatar/00/11/18/e5/29141f9c.jpg","nickname":"è‡ªæ¥å·å„¿","note":"","ucode":"CB790607BE0BE2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2003,"discussion_content":"è™½ç„¶æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯å¦‚æœé‡åˆ°ä¸Šä¸‹æ–‡ç¯å¢ƒæŒ‚èµ·æƒ…å†µï¼Œè¿˜æ˜¯å¯èƒ½å‡ºç°ç«Ÿæ€çš„ã€‚å…¶ä»–race conditionåœºæ™¯è¿˜è¯·å¤§å®¶æ‰©å±•~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563177313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":283550,"user_name":"DC","can_delete":false,"product_type":"c1","uid":1250344,"ip_address":"","ucode":"EC0E7E86056FA6","user_header":"https://static001.geekbang.org/account/avatar/00/13/14/28/9e3edef0.jpg","comment_is_top":false,"comment_ctime":1615814846,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5910782142","product_id":100028301,"comment_content":"openrestyçš„æ—¥å¿—è·¯å¾„æ˜¯å¦‚ä½•é…ç½®çš„ï¼Œè¿™ä¸ªé—®é¢˜ä¸€ç›´å›°æ‰°æˆ‘ï¼Œngx.logæ‰“å°ä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼Œæ–‡ä»¶ä½ç½®å¯ä»¥é…ç½®å—ï¼Œé»˜è®¤æ˜¯error.logå—","like_count":1},{"had_liked":false,"id":340900,"user_name":"çŒªå°æ“","can_delete":false,"product_type":"c1","uid":1370959,"ip_address":"","ucode":"D9552746AE3327","user_header":"https://static001.geekbang.org/account/avatar/00/14/eb/4f/6a97b1cd.jpg","comment_is_top":false,"comment_ctime":1649224272,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649224272","product_id":100028301,"comment_content":"åŒæ­¥å’Œå¼‚æ­¥ï¼Œé˜»å¡å’Œéé˜»å¡ï¼Œè¿™éƒ½æ˜¯æ²¡æœ‰å¥½å’Œåçš„åŒºåˆ«çš„ï¼Œä»¥ä¸ºå¼‚æ­¥éé˜»å¡æ¯”åŒæ­¥é˜»å¡å¥½ï¼Œå¾ˆç‰‡é¢ï¼Œè€Œä¸”ä¸å¯¹ã€‚å¦‚æœç¡¬è¦è¯´é˜»å¡å’Œéé˜»å¡å“ªä¸ªæ›´å¥½ä¸€ç‚¹ï¼Œåº”è¯¥æ˜¯é˜»å¡æ¯”éé˜»å¡æ›´å¥½ä¸€ç‚¹ã€‚ç”¨ä¸€ä¸ªcpuç©ºè½¬çš„ä»£ç æ¥åšé˜»å¡çš„ä¾‹å­ï¼Œè¿™ä¹Ÿå¤ªé»‘é˜»å¡äº†å§ã€‚ç©ºè½¬ä¸ç­‰äºé˜»å¡ï¼Œç©ºè½¬ç”¨100%CPUï¼Œé˜»å¡ä¸æ¶ˆè€—CPUã€‚","like_count":0},{"had_liked":false,"id":292565,"user_name":"Geek_xiaoer","can_delete":false,"product_type":"c1","uid":1693884,"ip_address":"","ucode":"DF77DF5ACCD83F","user_header":"","comment_is_top":false,"comment_ctime":1620878836,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"1620878836","product_id":100028301,"comment_content":"è€å¸ˆè¯´çš„ï¼Œâ€œè®¿é—®æ¨¡å—å˜é‡çš„æ—¶å€™ï¼Œä½ æœ€å¥½ä¿æŒåªè¯»ï¼Œè€Œä¸è¦å°è¯•å»ä¿®æ”¹ï¼Œä¸ç„¶åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¼šå‡ºç° raceâ€è¿™ä¸ªé—®é¢˜æœ‰ç‚¹ç–‘æƒ‘ã€‚æ—¢ç„¶æ¯ä¸ªworkeråŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªè¯·æ±‚åœ¨è¿›è¡Œä¸­ï¼Œé‚£ä¹ˆåŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªè¯·æ±‚æ­£åœ¨æ“ä½œè¿™ä¸ªæ¨¡å—å˜é‡å•Šï¼Ÿæ€ä¹ˆä¼šå‡ºç°raceï¼Ÿ<br><br>------<br>ä½œè€…å›å¤: å¦‚æœä¿®æ”¹çš„ä¸­é€”æœ‰ yield æ“ä½œï¼Œå°±å¯èƒ½ä¼šæœ‰ raceã€‚æ²¡æœ‰ yield çš„è¯è‡ªç„¶æ²¡æœ‰ã€‚<br><br>-----<br>åŒé—®ï¼Œè¿™é‡Œçš„yieldæŒ‡ä»€ä¹ˆï¼Ÿæ˜¯luaåç¨‹ä¸»åŠ¨yieldå—ï¼Œè¿˜æ˜¯å…¶å®ƒæ¡ä»¶è§¦å‘è¢«åŠ¨yieldçš„ï¼Ÿèƒ½ä¸èƒ½ç»™ä¸ªyieldå¯¼è‡´raceçš„ä¾‹å­ï¼Ÿè°¢è°¢ï¼","like_count":0,"discussions":[{"author":{"id":1014349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7a/4d/b0228a1a.jpg","nickname":"å¹³é£é€ é›¨","note":"","ucode":"F9EE4704F31E22","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555260,"discussion_content":"ä¸€å¼€å§‹çš„è¯„è®ºå†™é”™äº† padæ‰“å­—ä¸æ–¹ä¾¿ æŠ±æ­‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646824276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1014349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7a/4d/b0228a1a.jpg","nickname":"å¹³é£é€ é›¨","note":"","ucode":"F9EE4704F31E22","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555259,"discussion_content":"read xxx\nyield\na = a + 1\n\nread ooo\nyield\na = a + 1\n\n# açš„å€¼å› ä¸ºç«äº‰å˜çš„ä¸ç¡®å®š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646824225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1014349,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7a/4d/b0228a1a.jpg","nickname":"å¹³é£é€ é›¨","note":"","ucode":"F9EE4704F31E22","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555257,"discussion_content":"read xxx \na = a + 1\nyield \n\nread ooo\na = a + 1\nyield\n\n# açš„å€¼å› ä¸ºç«äº‰å˜çš„ä¸ç¡®å®š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646824170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1142524,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6e/fc/b25150d7.jpg","nickname":"jawe","note":"","ucode":"6DB8BF50767629","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":413686,"discussion_content":"ngx.sleepå°±æ˜¯ä¸€ä¸ªyield","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636543625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":283566,"user_name":"DC","can_delete":false,"product_type":"c1","uid":1250344,"ip_address":"","ucode":"EC0E7E86056FA6","user_header":"https://static001.geekbang.org/account/avatar/00/13/14/28/9e3edef0.jpg","comment_is_top":false,"comment_ctime":1615820266,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615820266","product_id":100028301,"comment_content":"è€å¸ˆ openrestyä¸­æŠŠè¯·æ±‚ä½“ä½œä¸ºæ—¥å¿—æ‰“å°åˆ°æœ¬åœ° èƒ½æŒ‡å®šè·¯å¾„å’Œæ–‡ä»¶å è¿™æ ·ä¸€ä¸ªéœ€æ±‚ æˆ‘ç¿»é˜…äº†å„ç§è¯´æ˜ å§‹ç»ˆæ²¡æœ‰å¥½çš„åšæ³• å…¶ä»–æŠ€æœ¯æ ˆå¾ˆå®¹æ˜“å®ç° è¿™æ–¹é¢èƒ½ç»™ä¸ªæŒ‡å¼•å—","like_count":0},{"had_liked":false,"id":132929,"user_name":"life_ç‰›","can_delete":false,"product_type":"c1","uid":1150443,"ip_address":"","ucode":"39E99CD4BFA48C","user_header":"https://static001.geekbang.org/account/avatar/00/11/8d/eb/e98af40f.jpg","comment_is_top":false,"comment_ctime":1568276445,"is_pvip":false,"replies":[{"id":"51285","content":"OpenResty çš„ä¸€äº›ç‰¹æ€§ç”¨åˆ°äº† SSE 4.2 æŒ‡ä»¤é›†ï¼Œè¿™ä¸ªåªèƒ½æ¢æœºå™¨äº†","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@APISIX","uid":"1017955","ctime":1568621280,"ip_address":"","comment_id":132929,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1568276445","product_id":100028301,"comment_content":"è€å¸ˆï¼Œç¼–è¯‘openrestyæ—¶å€™å‡ºç° error SSE 4.2 not foundè¿™ä¸ªé”™è¯¯ï¼Œç½‘ä¸Šæœ‰è¯´cpuå¤ªè€ å¦‚ä½•å¤„ç†è¿™æ ·çš„é—®é¢˜ï¼Œè¿˜æ˜¯å¯ä»¥å¿½ç•¥","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467180,"discussion_content":"OpenResty çš„ä¸€äº›ç‰¹æ€§ç”¨åˆ°äº† SSE 4.2 æŒ‡ä»¤é›†ï¼Œè¿™ä¸ªåªèƒ½æ¢æœºå™¨äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568621280,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1150443,"avatar":"https://static001.geekbang.org/account/avatar/00/11/8d/eb/e98af40f.jpg","nickname":"life_ç‰›","note":"","ucode":"39E99CD4BFA48C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":20780,"discussion_content":"å¦‚æœä½¿ç”¨ç¼–è¯‘å¥½çš„dockeré•œåƒè¿è¡Œåœ¨è¯¥æœåŠ¡å™¨ä¸Šï¼Œå¯¹åæœŸä½¿ç”¨ä¼šä¸ä¼šäº§ç”Ÿå½±å“å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569374725,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131146,"user_name":"å®ä»”","can_delete":false,"product_type":"c1","uid":1013493,"ip_address":"","ucode":"A0F17DFF99DB21","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","comment_is_top":false,"comment_ctime":1567652000,"is_pvip":true,"replies":[{"id":"50717","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1568173431,"ip_address":"","comment_id":131146,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567652000","product_id":100028301,"comment_content":"locationé…ç½®å¦‚ä¸‹ï¼š<br>location &#47; {<br>            access_by_lua_file lua&#47;access.lua;<br>            content_by_lua_file lua&#47;content.lua;<br>        }<br><br>access_by_lua_fileå†…å®¹å¦‚ä¸‹:<br>ngx.var.res = &quot;test&quot;<br>content_by_lua_fileå†…å®¹å¦‚ä¸‹ï¼š<br>ngx.say(ngx.var.res)<br>è€å¸ˆä½ å¥½ï¼Œè¿™æ ·å­ä¹Ÿè¯´å¯ä»¥åšåˆ°å˜é‡è·¨é˜¶æ®µè¯»å†™çš„","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466311,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568173431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109324,"user_name":"ä¸Šå–„è‹¥æ°´","can_delete":false,"product_type":"c1","uid":1199746,"ip_address":"","ucode":"E95D2C010807AE","user_header":"https://static001.geekbang.org/account/avatar/00/12/4e/82/67ece8b8.jpg","comment_is_top":false,"comment_ctime":1562000033,"is_pvip":false,"replies":[{"id":"40897","content":"æ˜¯å¦æœ‰æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Ÿå¯ä»¥æ”¾åˆ° gist é‡Œé¢","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562737095,"ip_address":"","comment_id":109324,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562000033","product_id":100028301,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œçœ‹ä½ çš„æœ€ä½³å®è·µä¸­ï¼Œé‡åˆ°ä¸€ä¸ªé—®é¢˜è¯·æ•™ä¸€ä¸‹ï¼Œåœ¨å¼•å…¥ç¬¬ä¸‰æ–¹restyåº“æ—¶ï¼Œæˆ‘æ ¹æ®é…ç½®è¯·æ±‚ä¸æ˜¯è¿”å›çš„ç™¾åº¦é¦–é¡µï¼Œæ˜¯ä¸€ä¸ª<br>&lt;!DOCTYPE html&gt;<br>&lt;!--STATUS OK--&gt;<br>æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿå¤šè°¢ã€‚","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456353,"discussion_content":"æ˜¯å¦æœ‰æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Ÿå¯ä»¥æ”¾åˆ° gist é‡Œé¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562737095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108991,"user_name":"FF","can_delete":false,"product_type":"c1","uid":1001615,"ip_address":"","ucode":"26349F32B406D7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/8f/7ecd4eed.jpg","comment_is_top":false,"comment_ctime":1561944758,"is_pvip":false,"replies":[{"id":"39728","content":"å…¶å®ä¸æ˜¯åªæœ‰ä¸€ä¸ªåç¨‹ï¼Œæ˜¯æœ‰ä¸€ä¸ªçˆ¶åç¨‹å’Œå­åç¨‹ã€‚è¿™æ–¹é¢æ¨è codedump è€å¸ˆçš„æºç åˆ†æï¼šhttps:&#47;&#47;www.codedump.info&#47;post&#47;20190501-lua-stream&#47;ï¼Œå†…å®¹è´¨é‡å¾ˆé«˜","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562084878,"ip_address":"","comment_id":108991,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1561944758","product_id":100028301,"comment_content":"æ¸©è€å¸ˆèƒ½å¦é’ˆå¯¹ OR è¿›ç¨‹å’Œåç¨‹çš„äº¤äº’å’Œä»–ä¿©çš„åä½œå…³ç³»å±•å¼€è®²è®²ã€‚<br><br>æ¯”å¦‚åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œæ¯ä¸ª worker è¿›ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªåç¨‹åœ¨è¿è¡Œã€‚é‚£å¦‚æœåç¨‹é˜»å¡ï¼Œè¿™ä¸ª worker è¿›ç¨‹æ˜¯å¦ä¹Ÿåœ¨é˜»å¡çŠ¶æ€ ï¼Ÿåç¨‹æ˜¯ä¸æ˜¯ç”± OR çš„ worker è¿›ç¨‹æ¥åˆ›å»º ï¼Œå•ä¸ªè¯·æ±‚å®Œåå°±æ¶ˆäº¡ ï¼Ÿ<br><br>æˆ–è€…è¿™æ–¹é¢æœ‰ä»€ä¹ˆèµ„æ–™å¯ä»¥æ¨èä¸‹å—ï¼Ÿ<br><br>æ„Ÿè°¢ã€‚ç›¼å¤ã€‚","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456196,"discussion_content":"å…¶å®ä¸æ˜¯åªæœ‰ä¸€ä¸ªåç¨‹ï¼Œæ˜¯æœ‰ä¸€ä¸ªçˆ¶åç¨‹å’Œå­åç¨‹ã€‚è¿™æ–¹é¢æ¨è codedump è€å¸ˆçš„æºç åˆ†æï¼šhttps://www.codedump.info/post/20190501-lua-stream/ï¼Œå†…å®¹è´¨é‡å¾ˆé«˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562084878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108738,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1561869139,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1561869139","product_id":100028301,"comment_content":"æ–‡ä¸­è¿™æ ·ä¸€æ®µè¯ï¼šâ€œå…¶ä½™é˜¶æ®µéƒ½ä¼šè®¾ç½®ä¸€ä¸ªéš”ç¦»çš„å…¨å±€å˜é‡è¡¨ï¼Œä»¥å…åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ±¡æŸ“äº†å…¶ä»–è¯·æ±‚â€ã€‚å‰åŠå¥ä¼¼ä¹æ˜¯è¦è¡¨è¾¾é˜²æ­¢åœ¨å¤„ç†çš„å„ä¸ªé˜¶æ®µäº’ç›¸å¹²æ‰°ã€‚ååŠå¥è¿™æ ·è¯´ï¼Œæ˜¯å› ä¸ºåŒä¸€ä¸ªworkerè¿›ç¨‹ä¸­çš„ä¸åŒçš„è¯·æ±‚å…¶å®æ˜¯å…±äº«å…¨å±€å˜é‡çš„æ˜¯å§ï¼Œä¹Ÿæ˜¯åŒä¸€ä¸ªè¿›ç¨‹é‡Œçš„å…¨å±€å˜é‡æœ¬æ¥å°±æ˜¯å…¬ç”¨çš„ã€‚","like_count":0},{"had_liked":false,"id":108372,"user_name":"é˜³å…‰æ¢¦","can_delete":false,"product_type":"c1","uid":1283965,"ip_address":"","ucode":"55BDA128D39931","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/TTPicMEZ5s1zKiaKYecIljicRV9dibITPM0958W3VuNHXlTQic2Dj6XYGibF7dqrG3JWr0LMx7hY9zXGzuvTDNGw8KAA/132","comment_is_top":false,"comment_ctime":1561731267,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561731267","product_id":100028301,"comment_content":"è®²çš„å¥½ğŸ‘","like_count":0},{"had_liked":false,"id":108277,"user_name":"John","can_delete":false,"product_type":"c1","uid":1458885,"ip_address":"","ucode":"ECACBE31D5D1A7","user_header":"https://static001.geekbang.org/account/avatar/00/16/42/c5/7913cdb0.jpg","comment_is_top":false,"comment_ctime":1561711195,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561711195","product_id":100028301,"comment_content":"è€å¸ˆï¼Œinit é˜¶æ®µåˆ›å»ºçš„å…¨å±€å˜é‡ï¼Œä½¿ç”¨content é˜¶æ®µçš„apiè¿›è¡Œä¿®æ”¹ï¼Œæ˜¯å¦å®‰å…¨ï¼Ÿ<br>æ¯”å¦‚å®ç°æ— reloadçš„é…ç½®æ¨é€ï¼š<br>-- åœ¨init_by_lua å®šä¹‰å…¨å±€çš„é…ç½®æ–‡ä»¶table<br>CONFIG = {a = 1};<br><br>-- åœ¨access_by_luaä¸­ä½¿ç”¨å…¨å±€çš„CONFIGå®ç°ä¸šåŠ¡é€»è¾‘<br>if CONFIG[&#39;a&#39;] = 1 then<br>    ngx.exit(ngx.HTTP_FORBIDDEN) <br>end <br><br>-- ä¸ºäº†åŠ¨æ€è·Ÿæ–°å…¨å±€é…ç½®ï¼Œæä¾›ä¸€ä¸ªAPIï¼Œå‘é€getè¯·æ±‚æ›´æ–° &#47;set-config?a =2<br>location = &#47;set-config {<br>      content_by_lua_block &#39;<br>          local args = ngx.req.get_uri_args()<br>          CONFIG[&#39;a&#39;] = args[&#39;a&#39;]<br>     &#39;<br>}","like_count":0}]}