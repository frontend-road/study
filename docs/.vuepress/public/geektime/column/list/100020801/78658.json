{"id":78658,"title":"31 | 误删数据后除了跑路，还能怎么办？","content":"<p>今天我要和你讨论的是一个沉重的话题：误删数据。</p><p>在前面几篇文章中，我们介绍了MySQL的高可用架构。当然，传统的高可用架构是不能预防误删数据的，因为主库的一个drop table命令，会通过binlog传给所有从库和级联从库，进而导致整个集群的实例都会执行这个命令。</p><p>虽然我们之前遇到的大多数的数据被删，都是运维同学或者DBA背锅的。但实际上，只要有数据操作权限的同学，都有可能踩到误删数据这条线。</p><p>今天我们就来聊聊误删数据前后，我们可以做些什么，减少误删数据的风险，和由误删数据带来的损失。</p><p>为了找到解决误删数据的更高效的方法，我们需要先对和MySQL相关的误删数据，做下分类：</p><ol>\n<li>\n<p>使用delete语句误删数据行；</p>\n</li>\n<li>\n<p>使用drop table或者truncate table语句误删数据表；</p>\n</li>\n<li>\n<p>使用drop database语句误删数据库；</p>\n</li>\n<li>\n<p>使用rm命令误删整个MySQL实例。</p>\n</li>\n</ol><h1>误删行</h1><p>在<a href=\"https://time.geekbang.org/column/article/76446\">第24篇文章</a>中，我们提到如果是使用delete语句误删了数据行，可以用Flashback工具通过闪回把数据恢复回来。</p><p>Flashback恢复数据的原理，是修改binlog的内容，拿回原库重放。而能够使用这个方案的前提是，需要确保binlog_format=row 和 binlog_row_image=FULL。</p><!-- [[[read_end]]] --><p>具体恢复数据时，对单个事务做如下处理：</p><ol>\n<li>\n<p>对于insert语句，对应的binlog event类型是Write_rows event，把它改成Delete_rows event即可；</p>\n</li>\n<li>\n<p>同理，对于delete语句，也是将Delete_rows event改为Write_rows event；</p>\n</li>\n<li>\n<p>而如果是Update_rows的话，binlog里面记录了数据行修改前和修改后的值，对调这两行的位置即可。</p>\n</li>\n</ol><p>如果误操作不是一个，而是多个，会怎么样呢？比如下面三个事务：</p><pre><code>(A)delete ...\n(B)insert ...\n(C)update ...\n</code></pre><p>现在要把数据库恢复回这三个事务操作之前的状态，用Flashback工具解析binlog后，写回主库的命令是：</p><pre><code>(reverse C)update ...\n(reverse B)delete ...\n(reverse A)insert ...\n</code></pre><p>也就是说，如果误删数据涉及到了多个事务的话，需要将事务的顺序调过来再执行。</p><p><strong>需要说明的是，我不建议你直接在主库上执行这些操作。</strong></p><p>恢复数据比较安全的做法，是恢复出一个备份，或者找一个从库作为临时库，在这个临时库上执行这些操作，然后再将确认过的临时库的数据，恢复回主库。</p><p>为什么要这么做呢？</p><p>这是因为，一个在执行线上逻辑的主库，数据状态的变更往往是有关联的。可能由于发现数据问题的时间晚了一点儿，就导致已经在之前误操作的基础上，业务代码逻辑又继续修改了其他数据。所以，如果这时候单独恢复这几行数据，而又未经确认的话，就可能会出现对数据的二次破坏。</p><p>当然，<strong>我们不止要说误删数据的事后处理办法，更重要是要做到事前预防</strong>。我有以下两个建议：</p><ol>\n<li>\n<p>把sql_safe_updates参数设置为on。这样一来，如果我们忘记在delete或者update语句中写where条件，或者where条件里面没有包含索引字段的话，这条语句的执行就会报错。</p>\n</li>\n<li>\n<p>代码上线前，必须经过SQL审计。</p>\n</li>\n</ol><p>你可能会说，设置了sql_safe_updates=on，如果我真的要把一个小表的数据全部删掉，应该怎么办呢？</p><p>如果你确定这个删除操作没问题的话，可以在delete语句中加上where条件，比如where id&gt;=0。</p><p>但是，delete全表是很慢的，需要生成回滚日志、写redo、写binlog。所以，从性能角度考虑，你应该优先考虑使用truncate table或者drop table命令。</p><p>使用delete命令删除的数据，你还可以用Flashback来恢复。而使用truncate /drop table和drop database命令删除的数据，就没办法通过Flashback来恢复了。为什么呢？</p><p>这是因为，即使我们配置了binlog_format=row，执行这三个命令时，记录的binlog还是statement格式。binlog里面就只有一个truncate/drop 语句，这些信息是恢复不出数据的。</p><p>那么，如果我们真的是使用这几条命令误删数据了，又该怎么办呢？</p><h1>误删库/表</h1><p>这种情况下，要想恢复数据，就需要使用全量备份，加增量日志的方式了。这个方案要求线上有定期的全量备份，并且实时备份binlog。</p><p>在这两个条件都具备的情况下，假如有人中午12点误删了一个库，恢复数据的流程如下：</p><ol>\n<li>\n<p>取最近一次全量备份，假设这个库是一天一备，上次备份是当天0点；</p>\n</li>\n<li>\n<p>用备份恢复出一个临时库；</p>\n</li>\n<li>\n<p>从日志备份里面，取出凌晨0点之后的日志；</p>\n</li>\n<li>\n<p>把这些日志，除了误删除数据的语句外，全部应用到临时库。</p>\n</li>\n</ol><p>这个流程的示意图如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/2f/db/2fafd0b75286e0163f432f85428ff8db.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图1 数据恢复流程-mysqlbinlog方法</span></center><p>关于这个过程，我需要和你说明如下几点：</p><ol>\n<li>\n<p>为了加速数据恢复，如果这个临时库上有多个数据库，你可以在使用mysqlbinlog命令时，加上一个–database参数，用来指定误删表所在的库。这样，就避免了在恢复数据时还要应用其他库日志的情况。</p>\n</li>\n<li>\n<p>在应用日志的时候，需要跳过12点误操作的那个语句的binlog：</p>\n<ul>\n<li>如果原实例没有使用GTID模式，只能在应用到包含12点的binlog文件的时候，先用–stop-position参数执行到误操作之前的日志，然后再用–start-position从误操作之后的日志继续执行；</li>\n<li>如果实例使用了GTID模式，就方便多了。假设误操作命令的GTID是gtid1，那么只需要执行set gtid_next=gtid1;begin;commit; 先把这个GTID加到临时实例的GTID集合，之后按顺序执行binlog的时候，就会自动跳过误操作的语句。</li>\n</ul>\n</li>\n</ol><p>不过，即使这样，使用mysqlbinlog方法恢复数据还是不够快，主要原因有两个：</p><ol>\n<li>\n<p>如果是误删表，最好就是只恢复出这张表，也就是只重放这张表的操作，但是mysqlbinlog工具并不能指定只解析一个表的日志；</p>\n</li>\n<li>\n<p>用mysqlbinlog解析出日志应用，应用日志的过程就只能是单线程。我们在<a href=\"https://time.geekbang.org/column/article/77083\">第26篇文章</a>中介绍的那些并行复制的方法，在这里都用不上。</p>\n</li>\n</ol><p><strong>一种加速的方法是，</strong>在用备份恢复出临时实例之后，将这个临时实例设置成线上备库的从库，这样：</p><ol>\n<li>\n<p>在start slave之前，先通过执行﻿<br>\n﻿change replication filter replicate_do_table = (tbl_name) 命令，就可以让临时库只同步误操作的表；</p>\n</li>\n<li>\n<p>这样做也可以用上并行复制技术，来加速整个数据恢复过程。</p>\n</li>\n</ol><p>这个过程的示意图如下所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/65/f1/65bb04929b8235fb677c7a78b5bd67f1.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图2 数据恢复流程-master-slave方法</span></center><p>可以看到，图中binlog备份系统到线上备库有一条虚线，是指如果由于时间太久，备库上已经删除了临时实例需要的binlog的话，我们可以从binlog备份系统中找到需要的binlog，再放回备库中。</p><p>假设，我们发现当前临时实例需要的binlog是从master.000005开始的，但是在备库上执行show binlogs 显示的最小的binlog文件是master.000007，意味着少了两个binlog文件。这时，我们就需要去binlog备份系统中找到这两个文件。</p><p>把之前删掉的binlog放回备库的操作步骤，是这样的：</p><ol>\n<li>\n<p>从备份系统下载master.000005和master.000006这两个文件，放到备库的日志目录下；</p>\n</li>\n<li>\n<p>打开日志目录下的master.index文件，在文件开头加入两行，内容分别是 “./master.000005”和“./master.000006”;</p>\n</li>\n<li>\n<p>重启备库，目的是要让备库重新识别这两个日志文件；</p>\n</li>\n<li>\n<p>现在这个备库上就有了临时库需要的所有binlog了，建立主备关系，就可以正常同步了。</p>\n</li>\n</ol><p>不论是把mysqlbinlog工具解析出的binlog文件应用到临时库，还是把临时库接到备库上，这两个方案的共同点是：误删库或者表后，恢复数据的思路主要就是通过备份，再加上应用binlog的方式。</p><p>也就是说，这两个方案都要求备份系统定期备份全量日志，而且需要确保binlog在被从本地删除之前已经做了备份。</p><p>但是，一个系统不可能备份无限的日志，你还需要根据成本和磁盘空间资源，设定一个日志保留的天数。如果你的DBA团队告诉你，可以保证把某个实例恢复到半个月内的任意时间点，这就表示备份系统保留的日志时间就至少是半个月。</p><p>另外，我建议你不论使用上述哪种方式，都要把这个数据恢复功能做成自动化工具，并且经常拿出来演练。为什么这么说呢？</p><p>这里的原因，主要包括两个方面：</p><ol>\n<li>\n<p>虽然“发生这种事，大家都不想的”，但是万一出现了误删事件，能够快速恢复数据，将损失降到最小，也应该不用跑路了。</p>\n</li>\n<li>\n<p>而如果临时再手忙脚乱地手动操作，最后又误操作了，对业务造成了二次伤害，那就说不过去了。</p>\n</li>\n</ol><h1>延迟复制备库</h1><p>虽然我们可以通过利用并行复制来加速恢复数据的过程，但是这个方案仍然存在“恢复时间不可控”的问题。</p><p>如果一个库的备份特别大，或者误操作的时间距离上一个全量备份的时间较长，比如一周一备的实例，在备份之后的第6天发生误操作，那就需要恢复6天的日志，这个恢复时间可能是要按天来计算的。</p><p>那么，我们有什么方法可以缩短恢复数据需要的时间呢？</p><p>如果有非常核心的业务，不允许太长的恢复时间，我们可以考虑<strong>搭建延迟复制的备库。</strong>这个功能是MySQL 5.6版本引入的。</p><p>一般的主备复制结构存在的问题是，如果主库上有个表被误删了，这个命令很快也会被发给所有从库，进而导致所有从库的数据表也都一起被误删了。</p><p>延迟复制的备库是一种特殊的备库，通过 CHANGE MASTER TO MASTER_DELAY = N命令，可以指定这个备库持续保持跟主库有N秒的延迟。</p><p>比如你把N设置为3600，这就代表了如果主库上有数据被误删了，并且在1小时内发现了这个误操作命令，这个命令就还没有在这个延迟复制的备库执行。这时候到这个备库上执行stop slave，再通过之前介绍的方法，跳过误操作命令，就可以恢复出需要的数据。</p><p>这样的话，你就随时可以得到一个，只需要最多再追1小时，就可以恢复出数据的临时实例，也就缩短了整个数据恢复需要的时间。</p><h1>预防误删库/表的方法</h1><p>虽然常在河边走，很难不湿鞋，但终究还是可以找到一些方法来避免的。所以这里，我也会给你一些减少误删操作风险的建议。</p><p>第一条建议是，账号分离。这样做的目的是，避免写错命令。比如：</p><ul>\n<li>我们只给业务开发同学DML权限，而不给truncate/drop权限。而如果业务开发人员有DDL需求的话，也可以通过开发管理系统得到支持。</li>\n<li>即使是DBA团队成员，日常也都规定只使用只读账号，必要的时候才使用有更新权限的账号。</li>\n</ul><p>第二条建议是，制定操作规范。这样做的目的，是避免写错要删除的表名。比如：</p><ul>\n<li>在删除数据表之前，必须先对表做改名操作。然后，观察一段时间，确保对业务无影响以后再删除这张表。</li>\n<li>改表名的时候，要求给表名加固定的后缀（比如加_to_be_deleted)，然后删除表的动作必须通过管理系统执行。并且，管理系删除表的时候，只能删除固定后缀的表。</li>\n</ul><h1>rm删除数据</h1><p>其实，对于一个有高可用机制的MySQL集群来说，最不怕的就是rm删除数据了。只要不是恶意地把整个集群删除，而只是删掉了其中某一个节点的数据的话，HA系统就会开始工作，选出一个新的主库，从而保证整个集群的正常工作。</p><p>这时，你要做的就是在这个节点上把数据恢复回来，再接入整个集群。</p><p>当然了，现在不止是DBA有自动化系统，SA（系统管理员）也有自动化系统，所以也许一个批量下线机器的操作，会让你整个MySQL集群的所有节点都全军覆没。</p><p>应对这种情况，我的建议只能是说尽量把你的备份跨机房，或者最好是跨城市保存。</p><h1>小结</h1><p>今天，我和你讨论了误删数据的几种可能，以及误删后的处理方法。</p><p>但，我要强调的是，预防远比处理的意义来得大。</p><p>另外，在MySQL的集群方案中，会时不时地用到备份来恢复实例，因此定期检查备份的有效性也很有必要。</p><p>如果你是业务开发同学，你可以用show grants命令查看账户的权限，如果权限过大，可以建议DBA同学给你分配权限低一些的账号；你也可以评估业务的重要性，和DBA商量备份的周期、是否有必要创建延迟复制的备库等等。</p><p>数据和服务的可靠性不止是运维团队的工作，最终是各个环节一起保障的结果。</p><p>今天的课后话题是，回忆下你亲身经历过的误删数据事件吧，你用了什么方法来恢复数据呢？你在这个过程中得到的经验又是什么呢？</p><p>你可以把你的经历和经验写在留言区，我会在下一篇文章的末尾选取有趣的评论和你一起讨论。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>我在上一篇文章给你留的问题，是关于空表的间隙的定义。</p><p>一个空表就只有一个间隙。比如，在空表上执行：</p><pre><code>begin;\nselect * from t where id&gt;1 for update;\n</code></pre><p>这个查询语句加锁的范围就是next-key lock (-∞, supremum]。</p><p>验证方法的话，你可以使用下面的操作序列。你可以在图4中看到显示的结果。</p><p><img src=\"https://static001.geekbang.org/resource/image/12/65/12eb6a38c347203f60df72ecaea95565.png?wh=941*276\" alt=\"\"></p><center><span class=\"reference\">图3 复现空表的next-key lock</span></center><p><img src=\"https://static001.geekbang.org/resource/image/53/9f/531b6556ffc82c6b02f9a010a3ceb09f.png?wh=1422*228\" alt=\"\"></p><center><span class=\"reference\">图4 show engine innodb status 部分结果</span></center><p>评论区留言点赞板：</p><blockquote>\n<p>@老杨同志 给出了正确的分析和SQL语句验证方法；<br>\n@库淘淘 指出了show engine innodb status验证结论。</p>\n</blockquote><p>赞这些思考和反馈。</p><p></p>","neighbors":{"left":{"article_title":"30 | 答疑文章（二）：用动态的观点看加锁","id":78427},"right":{"article_title":"32 | 为什么还有kill不掉的语句？","id":79026}},"comments":[{"had_liked":false,"id":63114,"user_name":"苍茫","can_delete":false,"product_type":"c1","uid":1299149,"ip_address":"","ucode":"CED8598307BEAE","user_header":"https://static001.geekbang.org/account/avatar/00/13/d2/cd/6fb14677.jpg","comment_is_top":true,"comment_ctime":1548258383,"is_pvip":false,"replies":[{"id":"22365","content":"👍 这个是血泪经验<br><br>拷贝文本执行，这个操作还可能存在字符集隐患。<br><br>这个事情更深一层逻辑，是你做了创造性的事情，非常优秀👍。<br>而这个运维同学认为他只是一个”复制粘贴执行的人”， 这种思路下是迟早会出问题的。","user_name":"作者回复","comment_id":63114,"uid":"1264162","ip_address":"","utype":1,"ctime":1548288852,"user_name_real":"林晓斌"}],"discussion_count":10,"race_medal":0,"score":"9.2233727084179005e+18","product_id":100020801,"comment_content":"有一次，我维护一张表，需要手动修改大量数据的状态，sql就很多，然后我保存到txt文件中以附件的形式发给部门老大审批，部门老大审批后转发邮件给运维，然后运维这哥们用的是360浏览器，他预览的sql，然后全部复制到客户端执行，但是问题也在这，360浏览器预览的时候由于文本偏长，到了某一条语句只有前半部分的update语句，没有后面的条件，然后就悲剧了。全表的状态都变成同一个。然后我就特别莫名其妙，还被老大批了一顿。说我写的脚本有问题。这锅我可不背，我把脚本在本地备份库跑了一遍又一遍就是没有问题。然后我再去运维哥们那，叫他再复制一下脚本就发现问题了。好在执行脚本前进行了表备份。扩展一下，如果你用谷歌浏览器就不会出现这种问题！发现问题后，立马恢复了数据","like_count":157,"discussions":[{"author":{"id":1126538,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg","nickname":"业余草","note":"","ucode":"99BDC1E629049D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41,"discussion_content":"而这个运维同学认为他只是一个”复制粘贴执行的人”， 这种思路下是迟早会出问题的。这句说的莫名其妙的好！","likes_number":17,"is_delete":false,"is_hidden":false,"ctime":1561013290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2052476,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Qq6oLfOTgKzjiculoUDicdv7WoY1iabPfOTumibWeInVP2Mnod9XVPrNSClvIiaLbvtDlIjRnWUNaXcYwREGzlcaDog/132","nickname":"Geek_在下蟑螂王","note":"","ucode":"E1F5BBB5BC5962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1126538,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg","nickname":"业余草","note":"","ucode":"99BDC1E629049D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323634,"discussion_content":"工……工具人","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1604977370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":41,"ip_address":""},"score":323634,"extra":""}]},{"author":{"id":1034377,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c8/89/e8e01a09.jpg","nickname":"周瑞峰","note":"","ucode":"E252E5A546104B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289375,"discussion_content":"同样遇到过一次，发的邮件，where 条件换行了，运维没拷贝上","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1594083480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437476,"discussion_content":"👍 这个是血泪经验\n\n拷贝文本执行，这个操作还可能存在字符集隐患。\n\n这个事情更深一层逻辑，是你做了创造性的事情，非常优秀👍。\n而这个运维同学认为他只是一个”复制粘贴执行的人”， 这种思路下是迟早会出问题的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1548288852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1274787,"avatar":"https://static001.geekbang.org/account/avatar/00/13/73/a3/2b077607.jpg","nickname":"Michael","note":"","ucode":"C233DF1D224EC1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414266,"discussion_content":"笑得肚子疼","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636704587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2326401,"avatar":"https://static001.geekbang.org/account/avatar/00/23/7f/81/8cd1e6a2.jpg","nickname":"阳[太阳][太阳][太阳]","note":"","ucode":"5069182EA0A0AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328397,"discussion_content":"用什么方法可以规避复制粘贴？可以直接执行.sql文件么？或者通过自动同步工具执行DDL？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606134346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1014665,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/89/34f2cbcc.jpg","nickname":"杨宇","note":"","ucode":"EB74DF6E269F03","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2326401,"avatar":"https://static001.geekbang.org/account/avatar/00/23/7f/81/8cd1e6a2.jpg","nickname":"阳[太阳][太阳][太阳]","note":"","ucode":"5069182EA0A0AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328860,"discussion_content":"在mysql提示符下，输入命令：\nsource 文件全路径\n（或者）\n\\. 文件全路径","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606263108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328397,"ip_address":""},"score":328860,"extra":""},{"author":{"id":2283781,"avatar":"https://static001.geekbang.org/account/avatar/00/22/d9/05/0d772dbf.jpg","nickname":"咦","note":"","ucode":"2E0D5A488489A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2326401,"avatar":"https://static001.geekbang.org/account/avatar/00/23/7f/81/8cd1e6a2.jpg","nickname":"阳[太阳][太阳][太阳]","note":"","ucode":"5069182EA0A0AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398605,"discussion_content":"建议最好还是直接执行sql吧，省的出现sql在人为转移过程中出错","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632820731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328397,"ip_address":""},"score":398605,"extra":""}]},{"author":{"id":1034377,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c8/89/e8e01a09.jpg","nickname":"周瑞峰","note":"","ucode":"E252E5A546104B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289374,"discussion_content":"同样遇到过一次，发的邮件，where 条件换行了，运维没拷贝上","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1594083478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1440429,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fa/ad/3fa02ac7.jpg","nickname":"星期八","note":"","ucode":"D8C66E7F61B0D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":271185,"discussion_content":"草哥，你好呀！","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590105505,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63085,"user_name":"無名小卒","can_delete":false,"product_type":"c1","uid":1345918,"ip_address":"","ucode":"1CBD8F26D7D33E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/hGLA7hlgfLk3VQs1m3HbkGCg0zicgaSJeYFGfW7JgocuicpoN0Ukyic7MouDXXxBDAKSJLJyEWb3Ef7ic6K6bOKbsw/132","comment_is_top":true,"comment_ctime":1548247210,"is_pvip":false,"replies":[{"id":"22352","content":"👍 非常好的经验<br>如果能够切实执行，即使有出问题，也是可以很快恢复的<br>把这些脚本当做开发代码来维护，是一个很好的实践","user_name":"作者回复","comment_id":63085,"uid":"1264162","ip_address":"","utype":1,"ctime":1548257696,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"9.2233725795689001e+18","product_id":100020801,"comment_content":"对生产数据库操作，公司DBA提出的编写脚本方法，个人觉得还是值得分享，虽说可能大部分公司也可能有这样的规范。<br>修改生产的数据，或者添加索引优化，都要先写好四个脚本：备份脚本、执行脚本、验证脚本和回滚脚本。备份脚本是对需要变更的数据备份到一张表中，固定需要操作的数据行，以便误操作或业务要求进行回滚；执行脚本就是对数据变更的脚本，为防Update错数据，一般连备份表进行Update操作；验证脚本是验证数据变更或影响行数是否达到预期要求效果；回滚脚本就是将数据回滚到修改前的状态。<br>虽说分四步骤写脚本可能会比较繁琐，但是这能够很大程度避免数据误操作。","like_count":127,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437466,"discussion_content":"👍 非常好的经验\n如果能够切实执行，即使有出问题，也是可以很快恢复的\n把这些脚本当做开发代码来维护，是一个很好的实践","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548257696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1124075,"avatar":"https://static001.geekbang.org/account/avatar/00/11/26/eb/24e0ac9c.jpg","nickname":"嬴梦川","note":"","ucode":"104CDFD26A1711","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373811,"discussion_content":"我们有预发布环境，数据和生成环境是一样的。然后我们在预发布环境上先执行(包括执行脚本和回滚脚本)，然后去生存环境，按照一样的步骤一样的脚本去执行，执行时有时研发还会站在运维身边盯着。——这样大大减小了生成环境事故率。","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1620882052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2014285,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKNv880TlsNuKaWcKbxiaAZTQIBWfJAddC8wfOROnwRPRwJXaEGSTBH2sic4jK7IGpxZn79tTDcREjw/132","nickname":"Geek_7482f6","note":"","ucode":"F3565F78525D30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":410333,"discussion_content":"那修改一次生产环境数据是真的麻烦啊","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1635666883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1274787,"avatar":"https://static001.geekbang.org/account/avatar/00/13/73/a3/2b077607.jpg","nickname":"Michael","note":"","ucode":"C233DF1D224EC1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414268,"discussion_content":"之前银行工作的时候，都是这样的规范，不然投产组投产sql出问题了，就是开发的锅，给的生产制品没按照规范来","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636704805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110477,"user_name":"Sancho","can_delete":false,"product_type":"c1","uid":1436391,"ip_address":"","ucode":"78849913082622","user_header":"https://static001.geekbang.org/account/avatar/00/15/ea/e7/9ce305ec.jpg","comment_is_top":false,"comment_ctime":1562286289,"is_pvip":false,"replies":[{"id":"40802","content":"这个老大是高手😆","user_name":"作者回复","comment_id":110477,"uid":"1264162","ip_address":"","utype":1,"ctime":1562698589,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"336569735377","product_id":100020801,"comment_content":"说说我的故事：一次更新，少了一个条件，结果把全表更新了，用的是pg，当时dba说没发恢复。这是属于一个业务核心表，数据有6000多条。当时业务系统有本地缓存，业务系统的更新会发通知刷新，数据库操作的更新要去业务系统主动刷新。在dba操作完sql，说了影响行数之后，我立刻傻了。赶紧上报老大，技术群里大吼不要刷缓存。我们老大是个老司机，知道dba是指望不上了，立刻在另一个业务系统写了几行代码，然后发布上线。浏览器一个地址下去，内存里的数据全部返回到浏览了。。。","like_count":79,"discussions":[{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296592,"discussion_content":"哈，这里边内存分2个，\n第一是redis这种，云上的只有基本监控，大部分都需要业务与运维共同开发一套便于自己排查与使用且通用的redis工具，其中scan数据是基础，如果有这个功能的话，不需要上线服务，只需要在页面上scan一下，并下载结果，请注意大部分redis操作请使用文件保存，而不是直接在内存直接返回。\n第二本地缓存，本地缓存这个一般是guava的loadingcache这种，这种麻烦一些，一把设置的频繁都是秒级别，分钟级别的少，但是也可以构建本地缓存统一托管器，统一使用托管器，自然也可以控制本地缓存，这个为啥来，应对突发热点与流量。可以外部直接接入本地缓存，防止redis被打挂。\n以上都属于公司的基础设置构建，如果构建的足够全，遇到事情自然就不慌张。如果么有，你也可以主动承担这个，设计并发言适合于自己公司业务场景又尽量可以考虑通用的组件模块系统哇~","likes_number":16,"is_delete":false,"is_hidden":false,"ctime":1596596024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456900,"discussion_content":"这个老大是高手😆","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562698589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331786,"discussion_content":"六千行做备份表","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606976858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1304870,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e9/26/ee614fd4.jpg","nickname":"依山观澜","note":"","ucode":"F93BDCAB56B9B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373977,"discussion_content":"个例","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620956679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63001,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1548224074,"is_pvip":false,"replies":[{"id":"22265","content":"👍 ","user_name":"作者回复","comment_id":63001,"uid":"1264162","ip_address":"","utype":1,"ctime":1548238963,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"224886523466","product_id":100020801,"comment_content":"总结下今天的知识点:<br>我觉得DBA的最核心的工作就是保证数据的完整性<br>今天老师也讲到了先要做好预防,预防的话大概是通过这几个点：<br>1.权限控制与分配(数据库和服务器权限)<br>2.制作操作规范<br>3.定期给开发进行培训<br>4.搭建延迟备库<br>5.做好sql审计,只要是对线上数据有更改操作的语句(DML和DDL)都需要进行审核<br>6.做好备份。备份的话又分为两个点.<br>(1)如果数据量比较大,用物理备份xtrabackup。定期对数据库进行全量备份,也可以做增量备份。<br>(2)如果数据量较少,用mysqldump或者mysqldumper。再利用binlog来恢复或者搭建主从的方式来恢复数据。<br>定期备份binlog文件也是很有必要的<br>还需要定期检查备份文件是否可用,如果真的发生了误操作,需要恢复数据的时候,发生备份文件不可用,那就更悲剧了<br><br>如果发生了数据删除的操作,又可以从以下几个点来恢复:<br>1.DML误操作语句造成数据不完整或者丢失。可以通过flashback,不过我们目前用的是美团的myflash,也是一个不错的工具，本质都差不多.都是先解析binlog event,然后在进行反转。把delete反转为insert,insert反转为delete,update前后image对调。所以必须设置binlog_format=row 和 binlog_row_image=full.<br>切记恢复数据的时候,应该先恢复到临时的实例,然后在恢复回主库上。<br>2.DDL语句误操作(truncate和drop),由于DDL语句不管binlog_format是row还是statement.在binlog里都只记录语句,不记录image所以恢复起来相对要麻烦得多。只能通过全量备份+应用binlog的方式来恢复数据。一旦数据量比较大,那么恢复时间就特别长,<br>对业务是个考验。所以就涉及到老师在第二讲提到的问题了，全量备份的周期怎么去选择","like_count":53,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437434,"discussion_content":"👍 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548238963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1308159,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","nickname":"颜海航","note":"","ucode":"5644F6328BF901","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1869,"discussion_content":"数据量较大时 用xtrabackup做全备，然后如果有新的binlog就备份出来。想问下这个用xtrabackup做全备知道怎么做，binlog的备份恢复是用什么工具吗？备份出来之后怎么恢复呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563016318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63361,"user_name":"还一棵树","can_delete":false,"product_type":"c1","uid":1317709,"ip_address":"","ucode":"C187F2A141D60E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eop9WylZJicLQxlvXukXUgPp39zJHyyReK5s1C9VhA6rric7GiarbfQMuWhdCCDdxdfL610Hc4cNkn9Q/132","comment_is_top":false,"comment_ctime":1548332346,"is_pvip":false,"replies":[{"id":"22435","content":"👍<br>这基本上是最快的恢复步骤了","user_name":"作者回复","comment_id":63361,"uid":"1264162","ip_address":"","utype":1,"ctime":1548333993,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"216296697146","product_id":100020801,"comment_content":"我遇到过一个线上误truncate表的，最终选择的处理过程如下：<br>1、创建一个同版本的空mysql实例，建一个名字+结构一模一样的表<br>2、discard这个表的tablespace<br>3、从之前的备份集中   innobackupex --apply-log 并记录binlog位置（用innobackupex备份的）。还原后找到误操作表的.ibd文件，copy到新实例对应的位置<br>4、在之前创建的mysql实例上import  tablespace<br>5、利用mysqlbinlog 处理增量数据<br>6、最后导出 再导入","like_count":51,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437563,"discussion_content":"👍\n这基本上是最快的恢复步骤了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548333993,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1194853,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3b/65/3a4fc8cf.jpg","nickname":"prepared","note":"","ucode":"00E54A5C7CDCBE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337890,"discussion_content":"可以写一篇详细的博客","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609118354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336009,"avatar":"https://static001.geekbang.org/account/avatar/00/14/62/c9/7da27891.jpg","nickname":"DKSky","note":"","ucode":"69371A81033949","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":59988,"discussion_content":"请问为什么要用到TTS，直接通过innobackupex恢复到新实例，不可以吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574695854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1594292,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epCnHKhYLefpkm02lnr4SpV5T4ibDQ2e4SlibkcaGu8ZxVDlEmVib6j0TiaDTicMmjrEdiaia8Aeen3nR7dg/132","nickname":"Geek_4a677e","note":"","ucode":"ACE5BD07A232D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1336009,"avatar":"https://static001.geekbang.org/account/avatar/00/14/62/c9/7da27891.jpg","nickname":"DKSky","note":"","ucode":"69371A81033949","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532104,"discussion_content":"tts是啥意思 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637516996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":59988,"ip_address":""},"score":532104,"extra":"{\"user_type\":1}"}]}]},{"had_liked":false,"id":62879,"user_name":"Knight²º¹⁸","can_delete":false,"product_type":"c1","uid":1089754,"ip_address":"","ucode":"BDCB830B6A730F","user_header":"https://static001.geekbang.org/account/avatar/00/10/a0/da/4f50f1b2.jpg","comment_is_top":false,"comment_ctime":1548201571,"is_pvip":false,"replies":[{"id":"22234","content":"后来通过 chatrr +i 命令给所有重要的文件增加了 i 权限属性，这样哪怕 root 用户都无法直接删除文件。<br><br>mark<br>","user_name":"作者回复","comment_id":62879,"uid":"1264162","ip_address":"","utype":1,"ctime":1548205068,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"138987155043","product_id":100020801,"comment_content":"很久之前，升级mongodb，在备份数据文件时，备份了指向数据文件的软连接(当时没注意是软连接)，导致在删除数据文件后，再通过备份数据文件恢复数据时找不到文件，这时才发现自己备份的只是一个软连接，最后是通过备份节点才恢复的数据。当时还没自动化运维工具，线上操作也不规范。后来通过 chatrr +i  命令给所有重要的文件增加了 i 权限属性，这样哪怕 root 用户都无法直接删除文件。差点就跑路了？😂😂😂","like_count":33,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437380,"discussion_content":"后来通过 chatrr +i 命令给所有重要的文件增加了 i 权限属性，这样哪怕 root 用户都无法直接删除文件。\n\nmark\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548205068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1427946,"avatar":"https://static001.geekbang.org/account/avatar/00/15/c9/ea/08c2cc5b.jpg","nickname":"如果可以改变","note":"","ucode":"64AB9E200AD7AC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":99886,"discussion_content":"chattr -R +i可以保护子文件下的所有内容，chattr +i无法保护子文件内容","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1577204383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1391166,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3a/3e/53ab11ce.jpg","nickname":"周杰伦的奶茶","note":"","ucode":"343CF19391FB9F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372336,"discussion_content":"chattr +i 文件也没有写权限了吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620288367,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63522,"user_name":"顺哥聊成长","can_delete":false,"product_type":"c1","uid":1023328,"ip_address":"","ucode":"FEF42E951B16F4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9d/60/45b3184d.jpg","comment_is_top":false,"comment_ctime":1548389708,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"134692375884","product_id":100020801,"comment_content":"我只想说，作者功力过于深厚了！","like_count":32},{"had_liked":false,"id":63958,"user_name":"Long","can_delete":false,"product_type":"c1","uid":1318970,"ip_address":"","ucode":"2417242560360A","user_header":"https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg","comment_is_top":false,"comment_ctime":1548621130,"is_pvip":false,"replies":[{"id":"22621","content":"感谢你的分享，都是血泪教训。。<br>我看有几个是用的可视化工具导致的，后面还是尽量用MySQL客户端敲命令吧😆<br><br>ibd文件坏页我之前有回答过其他同学的，看下这个<br>https:&#47;&#47;weibo.com&#47;1933424965&#47;H3qIu0JYo?from=page_1005051933424965_profile&amp;wvr=6&amp;mod=weibotime","user_name":"作者回复","comment_id":63958,"uid":"1264162","ip_address":"","utype":1,"ctime":1548636093,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"96037901642","product_id":100020801,"comment_content":"又到了讲故事(事故)的时候了，历史上遇到过很多次事故。全表误删除，误更新不下于8次，有MySQL 的DB也有memory DB.   有一次同事比较搞笑的是，有一次一张重要的权限控制表更新，由于用的是workbench 界面工具当时写了where条件，但是在选中执行行的时候where条件在第二行，没选中，还在执行前的时候手动把session 级的sql_safe_updates=0了，也没有点开那个autocommit取消的按钮。然后一执行，全表更新了，导致全网只有一个用户可以正常登录。还有其他的误操作，总结历史遇到过的这类问题基本就是几类<br>1. 登错环境，以为是测试环境，一顿操作猛如虎，一看环境是生产，回头一看，表已经drop了……<br>2. sql写的有问题，逻辑错误，或者条件缺失，常见的如不带where；or关键字的逻辑没有用括号括好<br>3. 还有一些奇葩的，比如where 字段1=字段2写成了字段1+字段2，逻辑等于判断变成了是否为1的判断了，大概率全表更新了。<br><br>错误解决大部分都是用备份恢复或者根据错误的逻辑来逻辑恢复。<br><br><br>还有一个，最近在尝试的，就是ibd文件中有坏页，只要一读到那个坏页，就会crash，报错spaceid page no should be多少多少，尝试了copy frm, ibd，ibdata, iblogfile这些表结构，数据文件，数据字典，undo redo 日志，也尝试用了undrop的工具也解析不出来。这个表比较特殊，是一个特殊库，没备份，表没有索引没法通过走索引跳过那个坏页的那些行，现在的状态是，只能用nysqldump恢复一部分数据。   我想通过16进制，自己慢慢找到那个脏写的数据，然后修改一下文件……<br>老师有什么比较好的建议吗？或者后面会说到ibd文件的物理结构之类的吗？ 感谢","like_count":23,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437781,"discussion_content":"感谢你的分享，都是血泪教训。。\n我看有几个是用的可视化工具导致的，后面还是尽量用MySQL客户端敲命令吧😆\n\nibd文件坏页我之前有回答过其他同学的，看下这个\nhttps://weibo.com/1933424965/H3qIu0JYo?from=page_1005051933424965_profile&amp;amp;wvr=6&amp;amp;mod=weibotime","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548636093,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93932,"user_name":"__困","can_delete":false,"product_type":"c1","uid":1207209,"ip_address":"","ucode":"5B68050D0F95CB","user_header":"https://static001.geekbang.org/account/avatar/00/12/6b/a9/ef0b2bd4.jpg","comment_is_top":false,"comment_ctime":1557671135,"is_pvip":false,"replies":[{"id":"34310","content":"就要看情况了<br><br>如果原库是删表，就把临时库里面的表导过去，小表逻辑导，大表可以用“透明表空间机制”物理导；<br>如果原库是误删了一些行，那只能在临时库里面select数据出来，按照业务的需要去补了","user_name":"作者回复","comment_id":93932,"uid":"1264162","ip_address":"","utype":1,"ctime":1558261004,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"87457017055","product_id":100020801,"comment_content":"不知道老师还在吗，看到这里，恢复出临时库后，怎么应用到主库","like_count":21,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449833,"discussion_content":"就要看情况了\n\n如果原库是删表，就把临时库里面的表导过去，小表逻辑导，大表可以用“透明表空间机制”物理导；\n如果原库是误删了一些行，那只能在临时库里面select数据出来，按照业务的需要去补了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558261004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590895,"discussion_content":"透明表空间机制\n1.源库创建相同表结构的表。\n2.discard tablespace 删除表空间随之idb也会被删除。\n3.cp idb等文件到源库。\n4.import tablespace ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666152251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":185350,"user_name":"斐波那契","can_delete":false,"product_type":"c1","uid":1464006,"ip_address":"","ucode":"85E2EBC01392B1","user_header":"https://static001.geekbang.org/account/avatar/00/16/56/c6/0b449bc6.jpg","comment_is_top":false,"comment_ctime":1583565704,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"44533238664","product_id":100020801,"comment_content":"虽然我不是DBA 但是曾经我上过oracle课程 老师讲过一句话----你在数据在 你不在数据依然在","like_count":11},{"had_liked":false,"id":97791,"user_name":"乔纳森","can_delete":false,"product_type":"c1","uid":1045107,"ip_address":"","ucode":"51EC9FAE071388","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f2/73/1c7bceae.jpg","comment_is_top":false,"comment_ctime":1558775162,"is_pvip":true,"replies":[{"id":"34987","content":"成长了：）","user_name":"作者回复","comment_id":97791,"uid":"1264162","ip_address":"","utype":1,"ctime":1558800200,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"31623546234","product_id":100020801,"comment_content":"感谢老师的讲解，我也分享一个吧；<br>delete 删除2000w 左右的数据场景， 开发直接自己登mysql服务操作的<br>1. 导出主键id。到一个文件中<br>2. 一个循环取id, delete. <br>for id in $( cat id.file)<br>do <br>mysql -hhost -pport -uuser -ppswd -e &quot;delete from t where id=$id&quot;;<br>done<br>问题出在id.file，是用什么工具导出来的，里面一个id 列头部；内容大概如下<br>id<br>3<br>400<br>然后就删了全表了，因为这个删全表的时间非常长，在删完后，从库重放时出现了延迟；<br>还好我们有A--B--C ，主从架构，在C实例上用mydumper 导入和恢复（导入时，会关闭binlog，所以在A和B 上都导入了数据）；<br>假如当时：<br>1. 有长事务监控的话，就可以及时发现，并杀掉delete 操作，避免悲剧发生<br>2. 假如知道用ibd 来恢复的话，就可以直接用文件拷贝，被sql 回放快多了<br>3. 当时还是太年轻了","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451422,"discussion_content":"成长了：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558800200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1434831,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e4/cf/906f47c9.jpg","nickname":"含章","note":"","ucode":"A7CA116D5275C9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294762,"discussion_content":"idb怎么回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595991104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1589259,"avatar":"https://static001.geekbang.org/account/avatar/00/18/40/0b/d552db0c.jpg","nickname":"Working","note":"","ucode":"018741FC175C7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1434831,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e4/cf/906f47c9.jpg","nickname":"含章","note":"","ucode":"A7CA116D5275C9","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":330351,"discussion_content":"idb恢复不了delete数据(没开binlog），意义不大。innodb_force_recoverry=6,无法执行alert","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606576432,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":294762,"ip_address":""},"score":330351,"extra":""},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1589259,"avatar":"https://static001.geekbang.org/account/avatar/00/18/40/0b/d552db0c.jpg","nickname":"Working","note":"","ucode":"018741FC175C7B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377572,"discussion_content":"他说的ibd恢复指的是透明表空间传输的方法","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1622712563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":330351,"ip_address":""},"score":377572,"extra":""}]}]},{"had_liked":false,"id":81004,"user_name":"张仕华","can_delete":false,"product_type":"c1","uid":1054248,"ip_address":"","ucode":"8D41E96A5889FC","user_header":"https://static001.geekbang.org/account/avatar/00/10/16/28/c11e7aae.jpg","comment_is_top":false,"comment_ctime":1553773244,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27323577020","product_id":100020801,"comment_content":"图3中 select * from t where id&gt;1 for update 少了 &quot;for update&quot;?","like_count":6},{"had_liked":false,"id":117195,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1563987036,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"23038823516","product_id":100020801,"comment_content":"老师，您好！<br><br>文章提到：“在用备份恢复出临时实例之后，将这个临时实例设置成线上备库的从库”。<br><br>将临时实例设置成线上备库的前提，是备库还未应用主库删除库&#47;表的 binlog 吧？<br>如果备库同步了主库的 binlog，也把库&#47;表删除了，这时候该怎么做？（在临时库设置 gtid_next 跳过该删除操作么？如果不支持 gtid 又该咋办？）<br><br>谢谢老师！","like_count":5,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294566,"discussion_content":"备库数据应该也是删除了，但是他有binlog呀，临时库通过全量备份恢复的，现在就是缺的增量的部分，通过作为备库的从库同步增量的binlog就可以恢复了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595929534,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1508329,"avatar":"https://static001.geekbang.org/account/avatar/00/17/03/e9/6358059c.jpg","nickname":"GalaxyCreater","note":"","ucode":"C79E8A088D57CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":263320,"discussion_content":"主从同步的时候，从库要设置跳过这个GTID，就可以恢复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589199077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103643,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d7/1b/f8b387ee.jpg","nickname":"olderwei","note":"","ucode":"9D66C179BD5BAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":196963,"discussion_content":"我也有这个疑问，如果备库没有删的话，那为什么还需要恢复一个临时库，直接用备库应用binlog不就可以吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583388790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1652836,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epKJlW7sqts2ZbPuhMbseTAdvHWnrc4ficAeSZyKibkvn6qyxflPrkKKU3mH6XCNmYvDg11tB6y0pxg/132","nickname":"pc","note":"","ucode":"1AD538B9A900B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":135184,"discussion_content":"我也是这个问题，如果主从同步很快，那么删除的时候从库立马也就drop表了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579076135,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215138,"user_name":"#160","can_delete":false,"product_type":"c1","uid":1195835,"ip_address":"","ucode":"0C0A2C5494B252","user_header":"https://static001.geekbang.org/account/avatar/00/12/3f/3b/6f3cf0af.jpg","comment_is_top":false,"comment_ctime":1588912590,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18768781774","product_id":100020801,"comment_content":"现在好多云平台提供托管的mysql实例，我们现在就用的aws托管实例，运维相当于交给了云平台，对于我们业务开发人员来说，能做的也就是crud了，记得有一次不小心清空了一个表的数据，直接在页面上点一点就把表恢复回来了，整个过程就是个黑盒。我觉得对于开发人员来说，该专栏的理论意义大于实践意义，学习其中的思想理念。","like_count":4,"discussions":[{"author":{"id":1794060,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/60/0c/e1f012cb.jpg","nickname":"frankie","note":"","ucode":"813D1352B68A21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":272420,"discussion_content":"很多公司买的阿里云，自己搭建MySQL。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590303781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63057,"user_name":"700","can_delete":false,"product_type":"c1","uid":1072896,"ip_address":"","ucode":"E4BD0CBADAF951","user_header":"","comment_is_top":false,"comment_ctime":1548239035,"is_pvip":false,"replies":[{"id":"22274","content":"其实是要看表的大小<br><br>如果是一个大表，逻辑恢复还是比较慢的，毕竟用物理备份来恢复出实例，相对会快些。<br><br>当然如果你已经有了一个成熟系统用逻辑恢复来实现，也不用改它，主要关注一下是否满足SLA就可以了^_^<br>facebook就是主要用逻辑备份的","user_name":"作者回复","comment_id":63057,"uid":"1264162","ip_address":"","utype":1,"ctime":1548242213,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"14433140923","product_id":100020801,"comment_content":"老师，请教。假如我有数据库的物理备份和逻辑备份（mydumper），因为 mydumper 导出的数据是按表名分开存放的，那么表误删数据的时候优先考虑逻辑备份（误删数据表的备份集）+binlog 恢复比物理备份恢复会快点？基于此，我总感觉物理备份只是在要恢复整个实例时才会优先考虑，而恢复整个实例的场景又是比较少的，毕竟一般大家的线上架构至少都是主从模式。所以逻辑备份被物理备份更实用。这种想法算是说得通吗？","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437453,"discussion_content":"其实是要看表的大小\n\n如果是一个大表，逻辑恢复还是比较慢的，毕竟用物理备份来恢复出实例，相对会快些。\n\n当然如果你已经有了一个成熟系统用逻辑恢复来实现，也不用改它，主要关注一下是否满足SLA就可以了^_^\nfacebook就是主要用逻辑备份的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548242213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63032,"user_name":"亮","can_delete":false,"product_type":"c1","uid":1086346,"ip_address":"","ucode":"5B8E59AEA6E3F2","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/8a/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1548233753,"is_pvip":false,"replies":[{"id":"22271","content":"哦 抱歉哈，我这边验证的时候默认用的latin1，是16+16+4","user_name":"作者回复","comment_id":63032,"uid":"1264162","ip_address":"","utype":1,"ctime":1548239298,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"10138168345","product_id":100020801,"comment_content":"CREATE TABLE `t` (<br>`id` int(11) NOT NULL,<br>`city` varchar(16) NOT NULL,<br>`name` varchar(16) NOT NULL,<br>`age` int(11) NOT NULL,<br>`addr` varchar(128) DEFAULT NULL,<br>PRIMARY KEY (`id`),<br>KEY `city` (`city`)<br>) ENGINE=InnoDB;<br><br>老师请教您16章的问题，您提到“city、name、age 这三个字段的定义总长度是36”，这个是怎么算出来的呢，varchar(16)是可以保存16个字符，占用了49个字节（utf8），所以我没想明白36是怎么来的。<br><br>第二个问题是max_length_for_sort_data参数系统默认是1024，是1024个字节的意思吗？<br><br>2019-01-23<br><br> 作者回复<br><br>1. age(11)其实是4个字节哈<br>2. 对，单位是字节<br><br>谢谢老师，不过还是没明白，age是4个字节，city和name分别是49个字节，49+49+4=102字节，36是怎么来的呢？再次感谢<br>","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437445,"discussion_content":"哦 抱歉哈，我这边验证的时候默认用的latin1，是16+16+4","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548239298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1324550,"avatar":"https://static001.geekbang.org/account/avatar/00/14/36/06/08c46bcd.jpg","nickname":"聂利","note":"","ucode":"808E064089724D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587418,"discussion_content":"age 是整型 int,只占4个字节 ，11， 只是一个显示长度","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663041219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1126538,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg","nickname":"业余草","note":"","ucode":"99BDC1E629049D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":42,"discussion_content":"int(11) 是最容易翻车的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561013598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62895,"user_name":"Cranliu","can_delete":false,"product_type":"c1","uid":1304302,"ip_address":"","ucode":"DC2DE84B142FDA","user_header":"https://static001.geekbang.org/account/avatar/00/13/e6/ee/e3c4c9b3.jpg","comment_is_top":false,"comment_ctime":1548203864,"is_pvip":false,"replies":[{"id":"22235","content":"对的，备份的意识很重要。<br><br><br>不过“drop&#47;truncate 的时候先逻辑备份”这么做的不多^_^ <br>主要的原因是逻辑备份可能会对系统有额外消耗。（全表扫描）<br><br>","user_name":"作者回复","comment_id":62895,"uid":"1264162","ip_address":"","utype":1,"ctime":1548205220,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"10138138456","product_id":100020801,"comment_content":"个人觉得，预防同样很重要，一般的dml操作，我是先ctas要操作的数据，drop&#47;truncate 的时候先逻辑备份。","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437388,"discussion_content":"对的，备份的意识很重要。\n\n\n不过“drop/truncate 的时候先逻辑备份”这么做的不多^_^ \n主要的原因是逻辑备份可能会对系统有额外消耗。（全表扫描）\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548205220,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318720,"user_name":"青萍之末","can_delete":false,"product_type":"c1","uid":2145548,"ip_address":"","ucode":"C55233E90112FC","user_header":"https://static001.geekbang.org/account/avatar/00/20/bd/0c/1bd1b097.jpg","comment_is_top":false,"comment_ctime":1635402862,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5930370158","product_id":100020801,"comment_content":"只有原理解释，没有环境操作，老实说有点偷懒了。","like_count":1},{"had_liked":false,"id":235875,"user_name":"niunan","can_delete":false,"product_type":"c1","uid":1006960,"ip_address":"","ucode":"13EDDBAF0BD651","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/zorkvVKoJ9aMjcw1CWCDLF2hXpKddpb20od5alsjcndyGg01pf43QjqoIOB2ibr2n2icINK6cvAAcBapByNAPtWQ/132","comment_is_top":false,"comment_ctime":1595232091,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5890199387","product_id":100020801,"comment_content":"提交工单给XX云，然后一会他们就会打电话过来了。。。^_^!!!","like_count":1,"discussions":[{"author":{"id":1047479,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/b7/6ecb191f.jpg","nickname":"yong","note":"","ucode":"E83FDDD570A9D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372161,"discussion_content":"某某云客服问，亲，你做快照了吗。我说，没有。他说，不要意思，数据无法恢复。我说，帮我转接工程师。10分钟后工程师联系我说binlog可以恢复。我一查binlog是开了的。但是备份的数据和binlog之间有空洞。后来花钱找人解决了。删完库，学了好多技能。主从延迟同步。数据库定时全备。binlog回放。delete误删恢复。很后悔，为啥职业生涯没能早点删库。错过好多🐶","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1620216224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2369545,"avatar":"https://static001.geekbang.org/account/avatar/00/24/28/09/0ac42cff.jpg","nickname":"慕苏","note":"","ucode":"7ED14D00429C21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1047479,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/b7/6ecb191f.jpg","nickname":"yong","note":"","ucode":"E83FDDD570A9D7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405665,"discussion_content":"哈哈哈，没毛病！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634614867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":372161,"ip_address":""},"score":405665,"extra":""}]}]},{"had_liked":false,"id":193130,"user_name":"运维老胡","can_delete":false,"product_type":"c1","uid":1227007,"ip_address":"","ucode":"DF398BEE296E11","user_header":"https://static001.geekbang.org/account/avatar/00/12/b8/ff/249da6da.jpg","comment_is_top":false,"comment_ctime":1584884389,"is_pvip":false,"replies":[{"id":"73664","content":"血泪经验呀<br>其实重做从库不应该有“drop database”这种命令<br>直接在新的目录下重新创建一个新的<br>旧的从库要删除的时候，先mv到回收站，确认没问题后再rm 文件<br><br>","user_name":"作者回复","comment_id":193130,"uid":"1264162","ip_address":"","utype":1,"ctime":1584891736,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"5879851685","product_id":100020801,"comment_content":"个人经历：一年前刚接手线上MySQL维护工作不久，某天线上一台MySQL意外重启导致复制中断，其中新来的DBA就告诉我需要重做从库，大周末的特意跑去公司重做从库，登上从库后没有进行环境的确认，以为只是主备复制，其实是双主复制，结果在从库上直接执行了drop database ，幸亏只删了2个小库，然后想起来有没有可能是双主。后来通过回复全库备份和应用binlog才恢复好被删的2个库的数据。<br>从中得到经验：<br>1、操作前必须确认环境。<br>2、从库断电重启导致复制异常，可以先跳过错误，后续业务低峰期再通过主从复制校验来修复。<br>3、一定要定期做好备份。","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488510,"discussion_content":"血泪经验呀\n其实重做从库不应该有“drop database”这种命令\n直接在新的目录下重新创建一个新的\n旧的从库要删除的时候，先mv到回收站，确认没问题后再rm 文件\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584891736,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63566,"user_name":"PengfeiWang","can_delete":false,"product_type":"c1","uid":1308369,"ip_address":"","ucode":"C877BBE99192B2","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/d1/dcafd7cf.jpg","comment_is_top":false,"comment_ctime":1548402395,"is_pvip":false,"replies":[{"id":"22492","content":"大家都是这么做的😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548413249,"ip_address":"","comment_id":63566,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5843369691","product_id":100020801,"comment_content":"老师，您好，有个问题请教一下：<br>关于MySQL备份有效性的验证，你有什么好的方法可以推荐吗？目前只能通过不定期的备份恢复来验证。","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437638,"discussion_content":"大家都是这么做的😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548413249,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1047479,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/b7/6ecb191f.jpg","nickname":"yong","note":"","ucode":"E83FDDD570A9D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372157,"discussion_content":"把备份的数据恢复到测服，顺便就验证了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620215263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63330,"user_name":"catalina","can_delete":false,"product_type":"c1","uid":1322372,"ip_address":"","ucode":"FC55E1CFE14CB9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/G9pdXkStPJoCwmpxux3kshQFrhWOnKcia1AH2O6uSTSGAVMm7AO7h76t2w7BpnVl6vp2hlzODAibia5xa7KIKvtWg/132","comment_is_top":false,"comment_ctime":1548325320,"is_pvip":false,"replies":[{"id":"22434","content":"原库的这几个表还会继续更新吗？ 如果会继续更新，就用搭主备的方法；<br>如果没更新了，后面有一个文章专门讲这个问题哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548332469,"ip_address":"","comment_id":63330,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5843292616","product_id":100020801,"comment_content":"老师，我们现在需要将一个库下面的所有表的数据同步到另外一个库，每个表有几百万数据吧，大约十多张表。有什么好的方法吗？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437551,"discussion_content":"原库的这几个表还会继续更新吗？ 如果会继续更新，就用搭主备的方法；\n如果没更新了，后面有一个文章专门讲这个问题哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548332469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2036786,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/14/32/e37762cb.jpg","nickname":"标准码农","note":"","ucode":"F1AAA474EC0619","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301486,"discussion_content":"直接服务器做镜像 用恢复镜像的方式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598538412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1794060,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/60/0c/e1f012cb.jpg","nickname":"frankie","note":"","ucode":"813D1352B68A21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":272419,"discussion_content":"每个表几百万，那dump下的sql也就5个G吧？当然还是考虑索引大小的，十几个表，mysqlpump压缩也没多大啊，慢慢dump下来恢复呗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590303730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63070,"user_name":"风二中","can_delete":false,"product_type":"c1","uid":1131876,"ip_address":"","ucode":"73AC0AFB04931D","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/64/2b09a36b.jpg","comment_is_top":false,"comment_ctime":1548243389,"is_pvip":true,"replies":[{"id":"22275","content":"嗯 对于核心业务，使用延迟复制的备份<br><br>RPO时间为0？有这么凶残的业务需求吗。。我能想到的就是多套延迟备份的库。<br>比如开3个， 一个是10分钟，一个20分钟，一个30分钟（主要考虑成本）<br>RPO这么敏感的，应该有对应敏感的监控，误操作要是30分钟还不能发现，可以挑战一下，这个业务是不是值得这么高的指标^_^<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548245362,"ip_address":"","comment_id":63070,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5843210685","product_id":100020801,"comment_content":"老师，您好。如何设置binlog 的备份时间呢，感觉RPO 时间总是不能为零，如果是informix 可以只丢一个逻辑日志。对于需要保证mysql恢复 RPO 时间为零，有什么建议吗？备库延迟1小时，加每小时备份一次binlog 。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437457,"discussion_content":"嗯 对于核心业务，使用延迟复制的备份\n\nRPO时间为0？有这么凶残的业务需求吗。。我能想到的就是多套延迟备份的库。\n比如开3个， 一个是10分钟，一个20分钟，一个30分钟（主要考虑成本）\nRPO这么敏感的，应该有对应敏感的监控，误操作要是30分钟还不能发现，可以挑战一下，这个业务是不是值得这么高的指标^_^\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548245362,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63030,"user_name":"高强","can_delete":false,"product_type":"c1","uid":1312433,"ip_address":"","ucode":"AA3C76FDD4BC61","user_header":"https://static001.geekbang.org/account/avatar/00/14/06/b1/ba6b4335.jpg","comment_is_top":false,"comment_ctime":1548232714,"is_pvip":false,"replies":[{"id":"22269","content":"改成RC隔离级别试试","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548239145,"ip_address":"","comment_id":63030,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5843200010","product_id":100020801,"comment_content":"老师你好，问个带子查询的delete&#47;update&#47;insert问题，Delete from A where name in(\r<br>   Select name from B where time&lt;’2019-01-23 11:11:12’\r<br>)  这条语句删除A表记录之前是不是也会把表 B满足条件的记录也会给锁住呢?<br>我试验了一下会锁住B表记录的，有没有其他办法不让锁B表呢?","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437443,"discussion_content":"改成RC隔离级别试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548239145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1629257,"avatar":"https://static001.geekbang.org/account/avatar/00/18/dc/49/43ae1627.jpg","nickname":"Ansyear","note":"","ucode":"489CE96852EA2C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352970,"discussion_content":"子查询为啥会被锁住啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614932014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63022,"user_name":"杜嘉嘉","can_delete":false,"product_type":"c1","uid":1306430,"ip_address":"","ucode":"C23DE27E7886BD","user_header":"https://static001.geekbang.org/account/avatar/00/13/ef/3e/9c3a8abc.jpg","comment_is_top":false,"comment_ctime":1548230071,"is_pvip":false,"replies":[{"id":"22268","content":"你的需求是要删表吗？<br>如果是要删表，就rename，过了观察时间再drop<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548239129,"ip_address":"","comment_id":63022,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5843197367","product_id":100020801,"comment_content":"我有个问题，那么如果说需要修改数据。在没有自动化平台这种情况下，为了避免数据丢失，我觉得有两种方式可行。如果说是删除整个表，可以使用rename 操作。第二种就是进行备份。我想问老师，那种方法更合理一些？rename是DDL语句，会不会锁表？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437441,"discussion_content":"你的需求是要删表吗？\n如果是要删表，就rename，过了观察时间再drop\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548239129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62894,"user_name":"511","can_delete":false,"product_type":"c1","uid":1307855,"ip_address":"","ucode":"AB0D3907F4EA39","user_header":"https://static001.geekbang.org/account/avatar/00/13/f4/cf/2af390ad.jpg","comment_is_top":false,"comment_ctime":1548203716,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5843171012","product_id":100020801,"comment_content":"早~","like_count":1},{"had_liked":false,"id":350015,"user_name":"cloud","can_delete":false,"product_type":"c1","uid":2724511,"ip_address":"","ucode":"E465F7413D6FC0","user_header":"https://static001.geekbang.org/account/avatar/00/29/92/9f/40d46f64.jpg","comment_is_top":false,"comment_ctime":1656505739,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1656505739","product_id":100020801,"comment_content":"看过很多误操作的，可以先开启事务，执行脚本，验证后再提交，这样就有保障些","like_count":0},{"had_liked":false,"id":344025,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1651198907,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651198907","product_id":100020801,"comment_content":"MySQL8已经没上期的问题了。","like_count":0},{"had_liked":false,"id":336380,"user_name":"Mr.x","can_delete":false,"product_type":"c1","uid":1130726,"ip_address":"","ucode":"FDA144380DB9AE","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/e6/2cd0f52b.jpg","comment_is_top":false,"comment_ctime":1646122392,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646122392","product_id":100020801,"comment_content":"都是血泪史，看着笑哭，加下 mysql 8.0 binlog 的文档 https:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;8.0&#47;en&#47;mysqlbinlog.html","like_count":0},{"had_liked":false,"id":334820,"user_name":"Bruce","can_delete":false,"product_type":"c1","uid":1016284,"ip_address":"","ucode":"61E439EEF865A6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/81/dc/a1662051.jpg","comment_is_top":false,"comment_ctime":1645147598,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645147598","product_id":100020801,"comment_content":"binlog不完整的情况下去恢复数据，有好方法么？<br><br>我们有个库，日志记录开启是在运行一段时间后开启的，并未做全量备份，然后某天有同事执行了 drop database xxx，现在想恢复 xxx。<br><br>因为日志不是全量，恢复起来比较麻烦，不知道老师是否有好的建议可以指导下","like_count":0},{"had_liked":false,"id":287336,"user_name":"攻城狮","can_delete":false,"product_type":"c1","uid":1197444,"ip_address":"","ucode":"7D2C2836052C4C","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/84/4b309ba9.jpg","comment_is_top":false,"comment_ctime":1617889071,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617889071","product_id":100020801,"comment_content":"请问老师用的什么软件画的流程图啊","like_count":0},{"had_liked":false,"id":281886,"user_name":"杰sir","can_delete":false,"product_type":"c1","uid":1098505,"ip_address":"","ucode":"80BB56B3BFB71A","user_header":"https://static001.geekbang.org/account/avatar/00/10/c3/09/dc368335.jpg","comment_is_top":false,"comment_ctime":1614935109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614935109","product_id":100020801,"comment_content":"对于修改或删除数据的需求都尽量用脚本来操作。<br>1，修改数据，写好脚本，记录好log，包括要更新数据前后的值，正式执行更新操作前把update语句注释掉，通过log看看要更新的数据对不对，同时保存这份log，之后在正式执行更新。<br>2，删除操作，同样先写好脚本，记录删除前的数，正式删除前先注释delete语句确认删除数据逻辑无误后再正式执行删除操作。<br><br>如果是自己通过命令行连接数据库操作的话，在更新数据前先把update改为select看看更新的数据行是否正常，之后再正式update, delete删除数据也一样。<br><br>还有是手贱，通过上下方向箭头查找历史命令，一不小心看错sql语句执行了一个delete或者update。这种可以在delete和updata时尽量加个limit，让历史记录里的sql都有limit，出现这种情况的时候可以控制一定的影响范围。","like_count":0},{"had_liked":false,"id":275907,"user_name":"枫中浪子","can_delete":false,"product_type":"c1","uid":2351949,"ip_address":"","ucode":"860BEA32059B37","user_header":"https://static001.geekbang.org/account/avatar/00/23/e3/4d/8a26dbb2.jpg","comment_is_top":false,"comment_ctime":1611716116,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611716116","product_id":100020801,"comment_content":"大佬用没有推荐的flashback工具啊","like_count":0},{"had_liked":false,"id":260410,"user_name":"盛艳明","can_delete":false,"product_type":"c1","uid":1132347,"ip_address":"","ucode":"E4C1C699572C44","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/3b/15e4490f.jpg","comment_is_top":false,"comment_ctime":1604999716,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1604999716","product_id":100020801,"comment_content":"问下老师 ，mysql 如果事务在commit 之前挂掉了，事务的恢复工作是不是 mysql 系统很具 redolog 和 binlog文件自己就修复了，根本不需要人工接入","like_count":0,"discussions":[{"author":{"id":1047479,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/b7/6ecb191f.jpg","nickname":"yong","note":"","ucode":"E83FDDD570A9D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372158,"discussion_content":"这个没有mysql会自动恢复的，无需干涉。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620215382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257789,"user_name":"moonfox","can_delete":false,"product_type":"c1","uid":1526355,"ip_address":"","ucode":"902BFF40EFA9FA","user_header":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","comment_is_top":false,"comment_ctime":1604131006,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1604131006","product_id":100020801,"comment_content":"有如下问题，还请老师解答<br>1. 主从复制中断为什么要重做从库？<br>2.如何判断删除的数据已经恢复好了？<br>3.如果没有启用GTID，指定参数`--stop-position`，执行到误操作之前的日志就可以了吧，误操作之后的日志还需要恢复吗？","like_count":0,"discussions":[{"author":{"id":1047479,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/b7/6ecb191f.jpg","nickname":"yong","note":"","ucode":"E83FDDD570A9D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372159,"discussion_content":"3.需要。这个恢复的数据是作为主库使用，必需要数据是最新的吧。删除语句之后的变更不恢复不就是丢数据了吗。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620215729,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241372,"user_name":"张觥","can_delete":false,"product_type":"c1","uid":1341821,"ip_address":"","ucode":"6784E44838EBCA","user_header":"https://static001.geekbang.org/account/avatar/00/14/79/7d/b573c6d9.jpg","comment_is_top":false,"comment_ctime":1597281656,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597281656","product_id":100020801,"comment_content":"Mysqlbinlog工具的--database参数只支持输入一个db，不能同时过滤多个db的binlog事件，这个工具有点坑，不做全了","like_count":0},{"had_liked":false,"id":225398,"user_name":"lleft","can_delete":false,"product_type":"c1","uid":1970443,"ip_address":"","ucode":"D573EB509455AE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","comment_is_top":false,"comment_ctime":1591750912,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1591750912","product_id":100020801,"comment_content":"恢复的临时库接到备库进行恢复的时候是怎么样跳过误删除的语句的？gtid模式是通过设置set gtid_next的方式，那传统复制的怎么跳过呢？","like_count":0,"discussions":[{"author":{"id":1047479,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/b7/6ecb191f.jpg","nickname":"yong","note":"","ucode":"E83FDDD570A9D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372162,"discussion_content":"数据量不大时，可以这么操作：将binlog导出到文件，注释掉误删语句，在恢复的最近备份删回放即可。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620216411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222575,"user_name":"磊磊","can_delete":false,"product_type":"c1","uid":1119820,"ip_address":"","ucode":"172CC7DA5641FB","user_header":"https://static001.geekbang.org/account/avatar/00/11/16/4c/6dbf3dfb.jpg","comment_is_top":false,"comment_ctime":1590837968,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590837968","product_id":100020801,"comment_content":"我一般重要数据 都双写。","like_count":0},{"had_liked":false,"id":218824,"user_name":"有朋自远方来","can_delete":false,"product_type":"c1","uid":1083600,"ip_address":"","ucode":"23A12829DEB119","user_header":"https://static001.geekbang.org/account/avatar/00/10/88/d0/6e75f766.jpg","comment_is_top":false,"comment_ctime":1589880904,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1589880904","product_id":100020801,"comment_content":"线上数据误删除。找业务方，把数据补回来了😂","like_count":0,"discussions":[{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331793,"discussion_content":"有的没留输入的入口 ，那就悲剧了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606978237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208908,"user_name":"Sparrow","can_delete":false,"product_type":"c1","uid":1693667,"ip_address":"","ucode":"88D3F3920C68BC","user_header":"https://static001.geekbang.org/account/avatar/00/19/d7/e3/e6cf6352.jpg","comment_is_top":false,"comment_ctime":1587463482,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587463482","product_id":100020801,"comment_content":"我有次修改某个字段，但是查找替换的时候不小心每个where前面都有个分号； 导致所有的update语句都变成无条件update； 全表数据改了 。。。。<br>----<br>另外请教一个问题，恢复数据的时候，历史数据和新数据都往新库写， 或不会造成数据冲突，被覆盖的情况？  迁移数据库的时候也有这个疑问","like_count":0},{"had_liked":false,"id":182774,"user_name":"大汉_客家族_数据工程_曾院士","can_delete":false,"product_type":"c1","uid":1215758,"ip_address":"","ucode":"AD73C36D617CA1","user_header":"https://static001.geekbang.org/account/avatar/00/12/8d/0e/1f49ade9.jpg","comment_is_top":false,"comment_ctime":1582863832,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582863832","product_id":100020801,"comment_content":"请问一下备份出新实例做备库，使用并发恢复，怎么跳过删除操作的GTID?","like_count":0},{"had_liked":false,"id":176060,"user_name":"王盛武","can_delete":false,"product_type":"c1","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1580927029,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1580927029","product_id":100020801,"comment_content":"rm的如果是主库， 如果有部分binlog还没送出去， 即使HA选出新的master，那是否有可能丢失部分数据呢？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":177262,"discussion_content":"应该有可能吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582090057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163668,"user_name":"anchor","can_delete":false,"product_type":"c1","uid":1083124,"ip_address":"","ucode":"24EECD40CC54C2","user_header":"https://static001.geekbang.org/account/avatar/00/10/86/f4/331f33a7.jpg","comment_is_top":false,"comment_ctime":1576764196,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576764196","product_id":100020801,"comment_content":"在一家公司的一个生产库上所有表的数据少了2周的数据，后面dba通过binlog找回了，但是还有些数据不一致，也没有说啥原因，怀疑是不是dba误操作了","like_count":0},{"had_liked":false,"id":149337,"user_name":"虎小牙","can_delete":false,"product_type":"c1","uid":1323427,"ip_address":"","ucode":"05E28911E407C6","user_header":"https://static001.geekbang.org/account/avatar/00/14/31/a3/8fac8e75.jpg","comment_is_top":false,"comment_ctime":1573196569,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573196569","product_id":100020801,"comment_content":"就像看弹幕一样，评论区永远很精彩！！！","like_count":0},{"had_liked":false,"id":120509,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1564919521,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564919521","product_id":100020801,"comment_content":"自己好像没有误删数据的经验，之前公司小，也不直接操作数据库。目前公司对于数据库的操作比较严格，业务开发中物理删除是禁用的，修改数据也是先逻辑修改再插入。如果是数据结转，更需要层层审核最后有DBA操刀。<br>预防为主，防治结合，我们做到了，基本将问题扼杀在摇篮里。","like_count":0},{"had_liked":false,"id":113455,"user_name":"颜海航","can_delete":false,"product_type":"c1","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1563016328,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1563016328","product_id":100020801,"comment_content":"数据量较大时 用xtrabackup做全备，然后如果有新的binlog就备份出来。想问下这个用xtrabackup做全备知道怎么做，binlog的备份恢复是用什么工具吗？备份出来之后怎么恢复呢","like_count":0,"discussions":[{"author":{"id":2182464,"avatar":"https://static001.geekbang.org/account/avatar/00/21/4d/40/24e85fbf.jpg","nickname":"宇宙尘埃cosmic dust","note":"","ucode":"CCD21CCD186F73","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308562,"discussion_content":"binlog的备份恢复工具就是mysqlbinlog，恢复的逻辑或者叫步骤：就是使用innobackupex工具(如果全备的工具使用innobackupex做的话)先把全量的备份恢复，然后再使用mysqlbinlog命令对全量备份后的生成的那些二进制日志文件做恢复，应该就能能恢复到最后的数据了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600996756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104414,"user_name":"cache","can_delete":false,"product_type":"c1","uid":1248232,"ip_address":"","ucode":"E23FFCDC6A5E40","user_header":"https://static001.geekbang.org/account/avatar/00/13/0b/e8/53061df4.jpg","comment_is_top":false,"comment_ctime":1560747931,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560747931","product_id":100020801,"comment_content":"误删表后，配置临时实例作为备库的从库，利用change replication filter后，是不是还需要指定复制到误删之前的GTID，如start slave until SQL_BEFORE_GTIDS? 但是在 slave_parallel_worker 部分的官档中又说“on a multithreaded slave the START SLAVE UNTIL statement only supports using SQL_AFTER_MTS_GAPS”, 还请老师解惑。","like_count":0},{"had_liked":false,"id":63565,"user_name":"杜嘉嘉","can_delete":false,"product_type":"c1","uid":1306430,"ip_address":"","ucode":"C23DE27E7886BD","user_header":"https://static001.geekbang.org/account/avatar/00/13/ef/3e/9c3a8abc.jpg","comment_is_top":false,"comment_ctime":1548402166,"is_pvip":false,"replies":[{"id":"22491","content":"是，不过rename的执行速度很快<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548413235,"ip_address":"","comment_id":63565,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548402166","product_id":100020801,"comment_content":"老师，接着上面问题。是删表，线上rename，有什么风险吗？需要注意什么？rename是不是ddl操作","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437637,"discussion_content":"是，不过rename的执行速度很快\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548413235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63345,"user_name":"苍茫","can_delete":false,"product_type":"c1","uid":1299149,"ip_address":"","ucode":"CED8598307BEAE","user_header":"https://static001.geekbang.org/account/avatar/00/13/d2/cd/6fb14677.jpg","comment_is_top":false,"comment_ctime":1548330126,"is_pvip":false,"replies":[{"id":"22431","content":"后面有一篇专门说这个，敬请期待哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548332238,"ip_address":"","comment_id":63345,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548330126","product_id":100020801,"comment_content":"有一次我在查询数据倒数报表给业务方，那个脚本是我写的，关联了很多表，还跨了库，一个主表有一万多条纪录，关联另一张操作记录表好像是10万条数据。因为要统计多步操作步骤，所以每一步的操作记录我就得按照不同的条件关联产生临时表（关联中有group 还有max（）聚合函数，这个是需求导致的），一开始写好的查询很快有了结果。那天11点多的时候，我执行那个脚本，发现很慢没有反应，然后我就把连接关了，重复几次操作，然后生产库就被我搞挂了。后面运维的同学操作了一波才恢复过来。这次也是运维同学背的锅。后面，还把我的操作给贴出来了，做通报批评。我想问下为啥会出现这种情况呢？<br>后续我的组长对我写的sql进行了优化，主要是把联表操作需要的信息放在子查询中，然后再操作记录表中加了索引，有了备份库，每次执行脚本导出数据都是在备份库中导出，就再也没有发生这个问题了。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437558,"discussion_content":"后面有一篇专门说这个，敬请期待哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548332238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63337,"user_name":"阿丽","can_delete":false,"product_type":"c1","uid":1170970,"ip_address":"","ucode":"C01D32E7165302","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erJFlHhylrbLANtehiaX50wgVa2Z1ibQAdLpgyW4gCpEyOKEI9bPNZZBiabrP2oCleZWc2KKyKADz8tg/132","comment_is_top":false,"comment_ctime":1548327151,"is_pvip":false,"replies":[{"id":"22432","content":"全文索引有stop words的，你看看是不是落在stop words里了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548332303,"ip_address":"","comment_id":63337,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548327151","product_id":100020801,"comment_content":"老师，麻烦问一下，5.7.21上innodb的表两列（有中文有英文）建的全文索引，最小分词1，按中文可以查询，按英文有些查询不出来，您知道原因吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437556,"discussion_content":"全文索引有stop words的，你看看是不是落在stop words里了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548332303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63263,"user_name":"hua168","can_delete":false,"product_type":"c1","uid":1065255,"ip_address":"","ucode":"CFF9A7E86EBA48","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg","comment_is_top":false,"comment_ctime":1548314687,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1548314687","product_id":100020801,"comment_content":"大神，有亲戚小公司搞DBA一年，我想问一下：<br>1.DBA一般发展方向是怎样的呀？运维和开发我了解，DBA没接触过，无法给建议，一般的升级过程是怎样的？<br>2.以后发展方向是怎样？现在都是开源、大数据时代时代，阿里又搞“去IOE”，一般oracle DBA发展前景不好吧？<br><br>能帮指一个大概的方向吗？谢谢~~","like_count":0},{"had_liked":false,"id":63213,"user_name":"aliang","can_delete":false,"product_type":"c1","uid":1149502,"ip_address":"","ucode":"B36B94B362477F","user_header":"https://static001.geekbang.org/account/avatar/00/11/8a/3e/30c05bce.jpg","comment_is_top":false,"comment_ctime":1548299559,"is_pvip":true,"replies":[{"id":"23194","content":"可否贴一下你的show variables  的结果，我这边验证（不论D有没有加begin）的效果都是你说的第二次的情况哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549277569,"ip_address":"","comment_id":63213,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548299559","product_id":100020801,"comment_content":"老师好。这是第6讲评论区Tony Du的评论：<br>session A: begin; select * from t limit 1; 最先启动sessionA<br>session B: begin; select * from t limit 1; 紧接着启动sessionB<br>session C: alter table t add f int; 然后再是启动sessionC<br>session D: begin; select * from t limit 1; 最后是启动sessionD<br>他说session C会被A和B阻塞，D会被C阻塞；当A和B提交后，D是可以继续执行得到查询结果的，但是C仍然被阻塞，只有D提交后C才能执行成功。我自己在5.6和5.7按他的步骤做了试验，结果和他一样。<br>然后我再做了一次试验，这次把D的begin;去掉，变成了：<br>session A: begin; select * from t limit 1; 最先启动sessionA<br>session B: begin; select * from t limit 1; 紧接着启动sessionB<br>session C: alter table t add f int; 然后再是启动sessionC<br>session D: select * from t limit 1; 最后是启动sessionD<br>结果是当A和B提交后，D和C都能执行成功了（和老师的结果一样）。我的问题是：为什么第一次session D显式开启事务，和第二次不显式开启的结果不一样呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437504,"discussion_content":"可否贴一下你的show variables  的结果，我这边验证（不论D有没有加begin）的效果都是你说的第二次的情况哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549277569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63194,"user_name":"太福","can_delete":false,"product_type":"c1","uid":1301817,"ip_address":"","ucode":"9DA81A8EA9D044","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/39/f5747c5d.jpg","comment_is_top":false,"comment_ctime":1548296644,"is_pvip":false,"replies":[{"id":"23046","content":"这个不算突然出现吧，你两次检测之间是1分钟是吧？<br><br>你这样说我看不太明白，可否给一个当时的show processlist的截图；<br>你还能执行show processlist，就不能算”僵死“；<br>io的状态如果有保存，也贴一下当时的iostat的结果；<br><br>可以发个微博附图，然后地址发到评论区哈<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549010015,"ip_address":"","comment_id":63194,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548296644","product_id":100020801,"comment_content":"因为时间原因，前面的课程没跟上，在这里请教个最近线上mysql遇到的问题：<br>  一个从库mysql5.6版本,正常情况下只有3到5个并发sql在查询，每分钟用下面的sql查看一次检测到的<br> SELECT  t1.* FROM information_schema.`PROCESSLIST` t1  WHERE  info is not null ORDER BY time desc;<br> 前一次检测还是几个sql在查询，下1分钟查到2000多个sql在跑，很多堆积了几十秒的sql，状态“Sending data” “Creating sort index”<br> ，而这些sql在正常情况下是不到1秒就查到结果了的，且cpu使用率与io很低，看起来mysql僵死的了。<br>有两个问题：1）问题突然出现<br>              2）大量sql在跑，而cpu与磁盘io反而比正常下降；这是从库，写只有主从同步，其它都是读查询。<br>配置：64G内存，bp分配40G，io使用不高<br>,业务量没大变动，也没新版本发布，大体排除业务并发加大导致的。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437496,"discussion_content":"这个不算突然出现吧，你两次检测之间是1分钟是吧？\n\n你这样说我看不太明白，可否给一个当时的show processlist的截图；\n你还能执行show processlist，就不能算”僵死“；\nio的状态如果有保存，也贴一下当时的iostat的结果；\n\n可以发个微博附图，然后地址发到评论区哈\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549010015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62997,"user_name":"夹心面包","can_delete":false,"product_type":"c1","uid":1301957,"ip_address":"","ucode":"002BBA49D83D17","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJCscgdVibmoPyRLRaicvk6rjTJxePZ6VFHvGjUQvtfhCS6kO4OZ1AVibbhNGKlWZmpEFf2yA6ptsqHw/132","comment_is_top":false,"comment_ctime":1548223557,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1548223557","product_id":100020801,"comment_content":"可以都走inception自动审核执行,不过对DDL还是无解 哈哈","like_count":0},{"had_liked":false,"id":62901,"user_name":"亮","can_delete":false,"product_type":"c1","uid":1086346,"ip_address":"","ucode":"5B8E59AEA6E3F2","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/8a/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1548204790,"is_pvip":false,"replies":[{"id":"22258","content":"1. age(11)其实是4个字节哈<br>2. 对，单位是字节<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548224634,"ip_address":"","comment_id":62901,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548204790","product_id":100020801,"comment_content":"CREATE TABLE `t` (<br>  `id` int(11) NOT NULL,<br>  `city` varchar(16) NOT NULL,<br>  `name` varchar(16) NOT NULL,<br>  `age` int(11) NOT NULL,<br>  `addr` varchar(128) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `city` (`city`)<br>) ENGINE=InnoDB;<br><br>老师请教您16章的问题，您提到“city、name、age 这三个字段的定义总长度是36”，这个是怎么算出来的呢，varchar(16)是可以保存16个字符，占用了49个字节（utf8），所以我没想明白36是怎么来的。<br><br>第二个问题是max_length_for_sort_data参数系统默认是1024，是1024个字节的意思吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437391,"discussion_content":"1. age(11)其实是4个字节哈\n2. 对，单位是字节\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548224634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}