{"id":369251,"title":"05ï½œSpring AOP å¸¸è§é”™è¯¯ï¼ˆä¸Šï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å‚…å¥ã€‚è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬èŠèŠSpring AOPä½¿ç”¨ä¸­å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚</p><p>Spring AOPæ˜¯Springä¸­é™¤äº†ä¾èµ–æ³¨å…¥å¤–ï¼ˆDIï¼‰æœ€ä¸ºæ ¸å¿ƒçš„åŠŸèƒ½ï¼Œé¡¾åæ€ä¹‰ï¼ŒAOPå³Aspect Oriented Programmingï¼Œç¿»è¯‘ä¸ºé¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚</p><p>è€ŒSpring AOPåˆ™åˆ©ç”¨CGlibå’ŒJDKåŠ¨æ€ä»£ç†ç­‰æ–¹å¼æ¥å®ç°è¿è¡ŒæœŸåŠ¨æ€æ–¹æ³•å¢å¼ºï¼Œå…¶ç›®çš„æ˜¯å°†ä¸ä¸šåŠ¡æ— å…³çš„ä»£ç å•ç‹¬æŠ½ç¦»å‡ºæ¥ï¼Œä½¿å…¶é€»è¾‘ä¸å†ä¸ä¸šåŠ¡ä»£ç è€¦åˆï¼Œä»è€Œé™ä½ç³»ç»Ÿçš„è€¦åˆæ€§ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§å’Œå¼€å‘æ•ˆç‡ã€‚å› è€ŒAOPä¾¿æˆä¸ºäº†æ—¥å¿—è®°å½•ã€ç›‘æ§ç®¡ç†ã€æ€§èƒ½ç»Ÿè®¡ã€å¼‚å¸¸å¤„ç†ã€æƒé™ç®¡ç†ã€ç»Ÿä¸€è®¤è¯ç­‰å„ä¸ªæ–¹é¢è¢«å¹¿æ³›ä½¿ç”¨çš„æŠ€æœ¯ã€‚</p><p>è¿½æ ¹æº¯æºï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥èƒ½æ— æ„ŸçŸ¥åœ°åœ¨å®¹å™¨å¯¹è±¡æ–¹æ³•å‰åä»»æ„æ·»åŠ ä»£ç ç‰‡æ®µï¼Œé‚£æ˜¯ç”±äºSpringåœ¨è¿è¡ŒæœŸå¸®æˆ‘ä»¬æŠŠåˆ‡é¢ä¸­çš„ä»£ç é€»è¾‘åŠ¨æ€â€œç»‡å…¥â€åˆ°äº†å®¹å™¨å¯¹è±¡æ–¹æ³•å†…ï¼Œæ‰€ä»¥è¯´<strong>AOPæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªä»£ç†æ¨¡å¼</strong>ã€‚ç„¶è€Œåœ¨ä½¿ç”¨è¿™ç§ä»£ç†æ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šç”¨ä¸å¥½ï¼Œé‚£ä¹ˆè¿™èŠ‚è¯¾æˆ‘ä»¬å°±æ¥è§£æä¸‹æœ‰å“ªäº›å¸¸è§çš„é—®é¢˜ï¼Œä»¥åŠèƒŒåçš„åŸç†æ˜¯ä»€ä¹ˆã€‚</p><h2>æ¡ˆä¾‹1ï¼šthisè°ƒç”¨çš„å½“å‰ç±»æ–¹æ³•æ— æ³•è¢«æ‹¦æˆª</h2><p>å‡è®¾æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ªå®¿èˆç®¡ç†ç³»ç»Ÿï¼Œè¿™ä¸ªæ¨¡å—åŒ…å«ä¸€ä¸ªè´Ÿè´£ç”µè´¹å……å€¼çš„ç±»ElectricServiceï¼Œå®ƒå«æœ‰ä¸€ä¸ªå……ç”µæ–¹æ³•charge()ï¼š</p><!-- [[[read_end]]] --><pre><code>@Service\npublic class ElectricService {\n\n    public void charge() throws Exception {\n        System.out.println(&quot;Electric charging ...&quot;);\n        this.pay();\n    }\n\n    public void pay() throws Exception {\n        System.out.println(&quot;Pay with alipay ...&quot;);\n        Thread.sleep(1000);\n    }\n\n}\n</code></pre><p>åœ¨è¿™ä¸ªç”µè´¹å……å€¼æ–¹æ³•charge()ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨æ”¯ä»˜å®è¿›è¡Œå……å€¼ã€‚å› æ­¤åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘åŠ å…¥äº†pay()æ–¹æ³•ã€‚ä¸ºäº†æ¨¡æ‹Ÿpay()æ–¹æ³•è°ƒç”¨è€—æ—¶ï¼Œä»£ç æ‰§è¡Œäº†ä¼‘çœ 1ç§’ï¼Œå¹¶åœ¨charge()æ–¹æ³•é‡Œä½¿ç”¨ this.pay()çš„æ–¹å¼è°ƒç”¨è¿™ç§æ”¯ä»˜æ–¹æ³•ã€‚</p><p>ä½†æ˜¯å› ä¸ºæ”¯ä»˜å®æ”¯ä»˜æ˜¯ç¬¬ä¸‰æ–¹æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•ä¸‹æ¥å£è°ƒç”¨æ—¶é—´ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±å¼•å…¥äº†ä¸€ä¸ª@Aroundçš„å¢å¼º ï¼Œåˆ†åˆ«è®°å½•åœ¨pay()æ–¹æ³•æ‰§è¡Œå‰åçš„æ—¶é—´ï¼Œå¹¶è®¡ç®—å‡ºæ‰§è¡Œpay()æ–¹æ³•çš„è€—æ—¶ã€‚</p><pre><code>@Aspect\n@Service\n@Slf4j\npublic class AopConfig {\n    @Around(&quot;execution(* com.spring.puzzle.class5.example1.ElectricService.pay()) &quot;)\n    public void recordPayPerformance(ProceedingJoinPoint joinPoint) throws Throwable {\n        long start = System.currentTimeMillis();\n        joinPoint.proceed();\n        long end = System.currentTimeMillis();\n        System.out.println(&quot;Pay method time costï¼ˆmsï¼‰: &quot; + (end - start));\n    }\n}\n</code></pre><p>æœ€åæˆ‘ä»¬å†é€šè¿‡å®šä¹‰ä¸€ä¸ªControlleræ¥æä¾›ç”µè´¹å……å€¼æ¥å£ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>@RestController\npublic class HelloWorldController {\n    @Autowired\n    ElectricService electricService;\n    @RequestMapping(path = &quot;charge&quot;, method = RequestMethod.GET)\n    public void charge() throws Exception{\n          electricService.charge();\n    };\n}\n</code></pre><p>å®Œæˆä»£ç åï¼Œæˆ‘ä»¬è®¿é—®ä¸Šè¿°æ¥å£ï¼Œä¼šå‘ç°è¿™æ®µè®¡ç®—æ—¶é—´çš„åˆ‡é¢å¹¶æ²¡æœ‰æ‰§è¡Œåˆ°ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><blockquote>\n<p>Electric charging ...<br>\nPay with alipay ...</p>\n</blockquote><p>å›æº¯ä¹‹å‰çš„ä»£ç å¯çŸ¥ï¼Œåœ¨@Aroundçš„åˆ‡é¢ç±»ä¸­ï¼Œæˆ‘ä»¬å¾ˆæ¸…æ™°åœ°å®šä¹‰äº†åˆ‡é¢å¯¹åº”çš„æ–¹æ³•ï¼Œä½†æ˜¯å´æ²¡æœ‰è¢«æ‰§è¡Œåˆ°ã€‚è¿™è¯´æ˜äº†åœ¨ç±»çš„å†…éƒ¨ï¼Œé€šè¿‡thisæ–¹å¼è°ƒç”¨çš„æ–¹æ³•ï¼Œæ˜¯æ²¡æœ‰è¢«Spring AOPå¢å¼ºçš„ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ã€‚</p><h3>æ¡ˆä¾‹è§£æ</h3><p>æˆ‘ä»¬å¯ä»¥ä»æºç ä¸­æ‰¾åˆ°çœŸç›¸ã€‚é¦–å…ˆæ¥è®¾ç½®ä¸ªæ–­ç‚¹ï¼Œè°ƒè¯•çœ‹çœ‹thiså¯¹åº”çš„å¯¹è±¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e0/5f/e0f4b047228fac437d57f56dcd18185f.png?wh=700*332\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œthiså¯¹åº”çš„å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ElectricServiceå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ã€‚å†çœ‹çœ‹åœ¨Controllerå±‚ä¸­è‡ªåŠ¨è£…é…çš„ElectricServiceå¯¹è±¡æ˜¯ä»€ä¹ˆæ ·ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/b2/f9/b24f00b4b96c46983295da05180174f9.png?wh=1112*258\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªè¢«Springå¢å¼ºè¿‡çš„Beanï¼Œæ‰€ä»¥æ‰§è¡Œcharge()æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œè®°å½•æ¥å£è°ƒç”¨æ—¶é—´çš„å¢å¼ºæ“ä½œã€‚è€Œthiså¯¹åº”çš„å¯¹è±¡åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰åšä»»ä½•é¢å¤–çš„å¢å¼ºã€‚</p><p>ä¸ºä»€ä¹ˆthiså¼•ç”¨çš„å¯¹è±¡åªæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡å‘¢ï¼Ÿè¿™è¿˜è¦ä»Spring AOPå¢å¼ºå¯¹è±¡çš„è¿‡ç¨‹æ¥çœ‹ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œæœ‰äº›åŸºç¡€æˆ‘éœ€è¦åœ¨è¿™é‡Œå¼ºè°ƒä¸‹ã€‚</p><p><strong>1.  Spring AOPçš„å®ç°</strong></p><p>Spring AOPçš„åº•å±‚æ˜¯åŠ¨æ€ä»£ç†ã€‚è€Œåˆ›å»ºä»£ç†çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œ<strong>JDKçš„æ–¹å¼å’ŒCGLIBçš„æ–¹å¼</strong>ã€‚JDKåŠ¨æ€ä»£ç†åªèƒ½å¯¹å®ç°äº†æ¥å£çš„ç±»ç”Ÿæˆä»£ç†ï¼Œè€Œä¸èƒ½é’ˆå¯¹æ™®é€šç±»ã€‚è€ŒCGLIBæ˜¯å¯ä»¥é’ˆå¯¹ç±»å®ç°ä»£ç†ï¼Œä¸»è¦æ˜¯å¯¹æŒ‡å®šçš„ç±»ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œè¦†ç›–å…¶ä¸­çš„æ–¹æ³•ï¼Œæ¥å®ç°ä»£ç†å¯¹è±¡ã€‚å…·ä½“åŒºåˆ«å¯å‚è€ƒä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/99/a1/99c74d82d811ec567b28a24ccd6e85a1.png?wh=1191*573\" alt=\"\"></p><p><strong>2.  å¦‚ä½•ä½¿ç”¨Spring AOP</strong></p><p>åœ¨Spring Bootä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªè¦æ·»åŠ ä»¥ä¸‹ä¾èµ–å°±å¯ä»¥ç›´æ¥ä½¿ç”¨AOPåŠŸèƒ½ï¼š</p><blockquote>\n<p>&lt;dependency&gt;<br>\n&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>\n&lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;<br>\n&lt;/dependency&gt;</p>\n</blockquote><p>è€Œå¯¹äºéSpring Bootç¨‹åºï¼Œé™¤äº†æ·»åŠ ç›¸å…³AOPä¾èµ–é¡¹å¤–ï¼Œæˆ‘ä»¬è¿˜å¸¸å¸¸ä¼šä½¿ç”¨@EnableAspectJAutoProxyæ¥å¼€å¯AOPåŠŸèƒ½ã€‚è¿™ä¸ªæ³¨è§£ç±»å¼•å…¥ï¼ˆImportï¼‰AspectJAutoProxyRegistrarï¼Œå®ƒé€šè¿‡å®ç°ImportBeanDefinitionRegistrarçš„æ¥å£æ–¹æ³•æ¥å®ŒæˆAOPç›¸å…³Beançš„å‡†å¤‡å·¥ä½œã€‚</p><p>è¡¥å……å®Œæœ€åŸºæœ¬çš„Springåº•å±‚çŸ¥è¯†å’Œä½¿ç”¨çŸ¥è¯†åï¼Œæˆ‘ä»¬å…·ä½“çœ‹ä¸‹åˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚å…ˆæ¥çœ‹ä¸‹è°ƒç”¨æ ˆï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/1f/2a/1fb3735e51a8e06833f065a175517c2a.png?wh=1565*570\" alt=\"\"></p><p>åˆ›å»ºä»£ç†å¯¹è±¡çš„æ—¶æœºå°±æ˜¯åˆ›å»ºä¸€ä¸ªBeançš„æ—¶å€™ï¼Œè€Œåˆ›å»ºçš„çš„å…³é”®å·¥ä½œå…¶å®æ˜¯ç”±AnnotationAwareAspectJAutoProxyCreatorå®Œæˆçš„ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ç§BeanPostProcessorã€‚æ‰€ä»¥å®ƒçš„æ‰§è¡Œæ˜¯åœ¨å®ŒæˆåŸå§‹Beanæ„å»ºåçš„åˆå§‹åŒ–Beanï¼ˆinitializeBeanï¼‰è¿‡ç¨‹ä¸­ã€‚è€Œå®ƒåˆ°åº•å®Œæˆäº†ä»€ä¹ˆå·¥ä½œå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å®ƒçš„postProcessAfterInitializationæ–¹æ³•ï¼š</p><pre><code>public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {\n   if (bean != null) {\n      Object cacheKey = getCacheKey(bean.getClass(), beanName);\n      if (this.earlyProxyReferences.remove(cacheKey) != bean) {\n         return wrapIfNecessary(bean, beanName, cacheKey);\n      }\n   }\n   return bean;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­çš„å…³é”®æ–¹æ³•æ˜¯wrapIfNecessaryï¼Œé¡¾åæ€ä¹‰ï¼Œ<strong>åœ¨éœ€è¦ä½¿ç”¨AOPæ—¶ï¼Œå®ƒä¼šæŠŠåˆ›å»ºçš„åŸå§‹çš„Beanå¯¹è±¡wrapæˆä»£ç†å¯¹è±¡ä½œä¸ºBeanè¿”å›</strong>ã€‚å…·ä½“åˆ°è¿™ä¸ªwrapè¿‡ç¨‹ï¼Œå¯å‚è€ƒä¸‹é¢çš„å…³é”®ä»£ç è¡Œï¼š</p><pre><code>protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {\n   // çœç•¥éå…³é”®ä»£ç \n   Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);\n   if (specificInterceptors != DO_NOT_PROXY) {\n      this.advisedBeans.put(cacheKey, Boolean.TRUE);\n      Object proxy = createProxy(\n            bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));\n      this.proxyTypes.put(cacheKey, proxy.getClass());\n      return proxy;\n   }\n   // çœç•¥éå…³é”®ä»£ç  \n}\n\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œç¬¬6è¡Œçš„createProxyè°ƒç”¨æ˜¯åˆ›å»ºä»£ç†å¯¹è±¡çš„å…³é”®ã€‚å…·ä½“åˆ°æ‰§è¡Œè¿‡ç¨‹ï¼Œå®ƒé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªä»£ç†å·¥å‚ï¼Œç„¶åå°†é€šçŸ¥å™¨ï¼ˆadvisorsï¼‰ã€è¢«ä»£ç†å¯¹è±¡ç­‰ä¿¡æ¯åŠ å…¥åˆ°ä»£ç†å·¥å‚ï¼Œæœ€åé€šè¿‡è¿™ä¸ªä»£ç†å·¥å‚æ¥è·å–ä»£ç†å¯¹è±¡ã€‚ä¸€äº›å…³é”®è¿‡ç¨‹å‚è€ƒä¸‹é¢çš„æ–¹æ³•ï¼š</p><pre><code>protected Object createProxy(Class&lt;?&gt; beanClass, @Nullable String beanName,\n      @Nullable Object[] specificInterceptors, TargetSource targetSource) {\n  // çœç•¥éå…³é”®ä»£ç \n  ProxyFactory proxyFactory = new ProxyFactory();\n  if (!proxyFactory.isProxyTargetClass()) {\n   if (shouldProxyTargetClass(beanClass, beanName)) {\n      proxyFactory.setProxyTargetClass(true);\n   }\n   else {\n      evaluateProxyInterfaces(beanClass, proxyFactory);\n   }\n  }\n  Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);\n  proxyFactory.addAdvisors(advisors);\n  proxyFactory.setTargetSource(targetSource);\n  customizeProxyFactory(proxyFactory);\n   // çœç•¥éå…³é”®ä»£ç \n  return proxyFactory.getProxy(getProxyClassLoader());\n}\n</code></pre><p>ç»è¿‡è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼Œä¸€ä¸ªä»£ç†å¯¹è±¡å°±è¢«åˆ›å»ºå‡ºæ¥äº†ã€‚æˆ‘ä»¬ä»Springä¸­è·å–åˆ°çš„å¯¹è±¡éƒ½æ˜¯è¿™ä¸ªä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥å…·æœ‰AOPåŠŸèƒ½ã€‚è€Œä¹‹å‰ç›´æ¥ä½¿ç”¨thiså¼•ç”¨åˆ°çš„åªæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡åŠæ³•å®ç°AOPçš„åŠŸèƒ½äº†ã€‚</p><h3>é—®é¢˜ä¿®æ­£</h3><p>ä»ä¸Šè¿°æ¡ˆä¾‹è§£æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œ<strong>åªæœ‰å¼•ç”¨çš„æ˜¯è¢«åŠ¨æ€ä»£ç†åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œæ‰ä¼šè¢«Springå¢å¼ºï¼Œå…·å¤‡AOPè¯¥æœ‰çš„åŠŸèƒ½</strong>ã€‚é‚£ä»€ä¹ˆæ ·çš„å¯¹è±¡å…·å¤‡è¿™æ ·çš„æ¡ä»¶å‘¢ï¼Ÿ</p><p>æœ‰ä¸¤ç§ã€‚ä¸€ç§æ˜¯è¢«@Autowiredæ³¨è§£çš„ï¼Œäºæ˜¯æˆ‘ä»¬çš„ä»£ç å¯ä»¥æ”¹æˆè¿™æ ·ï¼Œå³é€šè¿‡@Autowiredçš„æ–¹å¼ï¼Œåœ¨ç±»çš„å†…éƒ¨ï¼Œè‡ªå·±å¼•ç”¨è‡ªå·±ï¼š</p><pre><code>@Service\npublic class ElectricService {\n    @Autowired\n    ElectricService electricService;\n    public void charge() throws Exception {\n        System.out.println(&quot;Electric charging ...&quot;);\n        //this.pay();\n        electricService.pay();\n    }\n    public void pay() throws Exception {\n        System.out.println(&quot;Pay with alipay ...&quot;);\n        Thread.sleep(1000);\n    }\n}\n</code></pre><p>å¦ä¸€ç§æ–¹æ³•å°±æ˜¯ç›´æ¥ä»AopContextè·å–å½“å‰çš„Proxyã€‚é‚£ä½ å¯èƒ½ä¼šé—®äº†ï¼ŒAopContextæ˜¯ä»€ä¹ˆï¼Ÿç®€å•è¯´ï¼Œå®ƒçš„æ ¸å¿ƒå°±æ˜¯é€šè¿‡ä¸€ä¸ªThreadLocalæ¥å°†Proxyå’Œçº¿ç¨‹ç»‘å®šèµ·æ¥ï¼Œè¿™æ ·å°±å¯ä»¥éšæ—¶æ‹¿å‡ºå½“å‰çº¿ç¨‹ç»‘å®šçš„Proxyã€‚</p><p>ä¸è¿‡ä½¿ç”¨è¿™ç§æ–¹æ³•æœ‰ä¸ªå°å‰æï¼Œå°±æ˜¯éœ€è¦åœ¨@EnableAspectJAutoProxyé‡ŒåŠ ä¸€ä¸ªé…ç½®é¡¹exposeProxy = trueï¼Œè¡¨ç¤ºå°†ä»£ç†å¯¹è±¡æ”¾å…¥åˆ°ThreadLocalï¼Œè¿™æ ·æ‰å¯ä»¥ç›´æ¥é€šè¿‡ AopContext.currentProxy()çš„æ–¹å¼è·å–åˆ°ï¼Œå¦åˆ™ä¼šæŠ¥é”™å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0e/98/0e42f3129e1c098b0f860f1f7f2e6298.png?wh=1489*563\" alt=\"\"></p><p>æŒ‰è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸‹ç›¸å…³ä»£ç ï¼š</p><pre><code>import org.springframework.aop.framework.AopContext;\nimport org.springframework.stereotype.Service;\n@Service\npublic class ElectricService {\n    public void charge() throws Exception {\n        System.out.println(&quot;Electric charging ...&quot;);\n        ElectricService electric = ((ElectricService) AopContext.currentProxy());\n        electric.pay();\n    }\n    public void pay() throws Exception {\n        System.out.println(&quot;Pay with alipay ...&quot;);\n        Thread.sleep(1000);\n    }\n}\n</code></pre><p>åŒæ—¶ï¼Œä¸è¦å¿˜è®°ä¿®æ”¹EnableAspectJAutoProxyæ³¨è§£çš„exposeProxyå±æ€§ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre><code>@SpringBootApplication\n@EnableAspectJAutoProxy(exposeProxy = true)\npublic class Application {\n    // çœç•¥éå…³é”®ä»£ç \n}\n</code></pre><p>è¿™ä¸¤ç§æ–¹æ³•çš„æ•ˆæœå…¶å®æ˜¯ä¸€æ ·çš„ï¼Œæœ€ç»ˆæˆ‘ä»¬æ‰“å°å‡ºäº†æœŸå¾…çš„æ—¥å¿—ï¼Œåˆ°è¿™ï¼Œé—®é¢˜é¡ºåˆ©è§£å†³äº†ã€‚</p><pre><code>Electric charging ...\nPay with alipay ...\nPay method time cost(ms): 1005\n</code></pre><h2>æ¡ˆä¾‹2ï¼šç›´æ¥è®¿é—®è¢«æ‹¦æˆªç±»çš„å±æ€§æŠ›ç©ºæŒ‡é’ˆå¼‚å¸¸</h2><p>æ¥ä¸Šä¸€ä¸ªæ¡ˆä¾‹ï¼Œåœ¨å®¿èˆç®¡ç†ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†charge()æ–¹æ³•è¿›è¡Œæ”¯ä»˜ã€‚åœ¨ç»Ÿä¸€ç»“ç®—çš„æ—¶å€™æˆ‘ä»¬ä¼šç”¨åˆ°ä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ä»˜æ¬¾ç¼–å·ï¼Œè¿™æ—¶å€™å°±ç”¨åˆ°äº†å‡ ä¸ªæ–°çš„ç±»ã€‚</p><p>Userç±»ï¼ŒåŒ…å«ç”¨æˆ·çš„ä»˜æ¬¾ç¼–å·ä¿¡æ¯ï¼š</p><pre><code>public class User {\n    private String payNum;\n    public User(String payNum) {\n        this.payNum = payNum;\n    }\n    public String getPayNum() {\n        return payNum;\n    }\n    public void setPayNum(String payNum) {\n        this.payNum = payNum;\n    }\n}\n</code></pre><p>AdminUserServiceç±»ï¼ŒåŒ…å«ä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ï¼ˆUserï¼‰ï¼Œå…¶ä»˜æ¬¾ç¼–å·ä¸º202101166ï¼›å¦å¤–ï¼Œè¿™ä¸ªæœåŠ¡ç±»æœ‰ä¸€ä¸ªlogin()æ–¹æ³•ï¼Œç”¨æ¥ç™»å½•ç³»ç»Ÿã€‚</p><pre><code>@Service\npublic class AdminUserService {\n    public final User adminUser = new User(&quot;202101166&quot;);\n    \n    public void login() {\n        System.out.println(&quot;admin user login...&quot;);\n    }\n}\n</code></pre><p>æˆ‘ä»¬éœ€è¦ä¿®æ”¹ElectricServiceç±»å®ç°è¿™ä¸ªéœ€æ±‚ï¼šåœ¨ç”µè´¹å……å€¼æ—¶ï¼Œéœ€è¦ç®¡ç†å‘˜ç™»å½•å¹¶ä½¿ç”¨å…¶ç¼–å·è¿›è¡Œç»“ç®—ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>import org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n@Service\npublic class ElectricService {\n    @Autowired\n    private AdminUserService adminUserService;\n    public void charge() throws Exception {\n        System.out.println(&quot;Electric charging ...&quot;);\n        this.pay();\n    }\n\n    public void pay() throws Exception {\n        adminUserService.login();\n        String payNum = adminUserService.adminUser.getPayNum();\n        System.out.println(&quot;User pay num : &quot; + payNum);\n        System.out.println(&quot;Pay with alipay ...&quot;);\n        Thread.sleep(1000);\n    }\n}\n</code></pre><p>ä»£ç å®Œæˆåï¼Œæ‰§è¡Œcharge()æ“ä½œï¼Œä¸€åˆ‡æ­£å¸¸ï¼š</p><pre><code>Electric charging ...\nadmin user login...\nUser pay num : 202101166\nPay with alipay ...\n</code></pre><p>è¿™æ—¶å€™ï¼Œç”±äºå®‰å…¨éœ€è¦ï¼Œå°±éœ€è¦ç®¡ç†å‘˜åœ¨ç™»å½•æ—¶ï¼Œè®°å½•ä¸€è¡Œæ—¥å¿—ä»¥ä¾¿äºä»¥åå®¡è®¡ç®¡ç†å‘˜æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªAOPç›¸å…³é…ç½®ç±»ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><pre><code>@Aspect\n@Service\n@Slf4j\npublic class AopConfig {\n    @Before(&quot;execution(* com.spring.puzzle.class5.example2.AdminUserService.login(..)) &quot;)\n    public void logAdminLogin(JoinPoint pjp) throws Throwable {\n        System.out.println(&quot;! admin login ...&quot;);\n    }\n}\n</code></pre><p>æ·»åŠ è¿™æ®µä»£ç åï¼Œæˆ‘ä»¬æ‰§è¡Œcharge()æ“ä½œï¼Œå‘ç°ä¸ä»…æ²¡æœ‰ç›¸å…³æ—¥å¿—ï¼Œè€Œä¸”åœ¨æ‰§è¡Œä¸‹é¢è¿™ä¸€è¡Œä»£ç çš„æ—¶å€™ç›´æ¥æŠ›å‡ºäº†NullPointerExceptionï¼š</p><blockquote>\n<p>String payNum = dminUserService.user.getPayNum();</p>\n</blockquote><p>æœ¬æ¥ä¸€åˆ‡æ­£å¸¸çš„ä»£ç ï¼Œå› ä¸ºå¼•å…¥äº†ä¸€ä¸ªAOPåˆ‡é¢ï¼ŒæŠ›å‡ºäº†NullPointerExceptionã€‚è¿™ä¼šæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿæˆ‘ä»¬å…ˆdebugä¸€ä¸‹ï¼Œæ¥çœ‹çœ‹åŠ å…¥AOPåè°ƒç”¨çš„å¯¹è±¡æ˜¯ä»€ä¹ˆæ ·å­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/a2/cd48479a45c2b06621c2e07a33f519a2.png?wh=917*419\" alt=\"\"></p><p>å¯ä»¥çœ‹å‡ºï¼ŒåŠ å…¥AOPåï¼Œæˆ‘ä»¬çš„å¯¹è±¡å·²ç»æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡äº†ï¼Œå¦‚æœä½ çœ¼å°–çš„è¯ï¼Œå°±ä¼šå‘ç°åœ¨ä¸Šå›¾ä¸­ï¼Œå±æ€§adminUserç¡®å®ä¸ºnullã€‚ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿä¸ºäº†è§£ç­”è¿™ä¸ªè¯¡å¼‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥ç†è§£Springä½¿ç”¨CGLIBç”ŸæˆProxyçš„åŸç†ã€‚</p><h3>æ¡ˆä¾‹è§£æ</h3><p>æˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªæ¡ˆä¾‹ä¸­è§£æäº†åˆ›å»ºSpring Proxyçš„å¤§ä½“è¿‡ç¨‹ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ä¸€ä¸‹é€šè¿‡Proxyåˆ›å»ºå‡ºæ¥çš„æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„å¯¹è±¡ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒAdminUserServiceåªæ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œè€ŒAOPå¢å¼ºè¿‡çš„åˆ™æ˜¯ä¸€ä¸ªAdminUserService <span dollar=\"\">$</span>$EnhancerBySpringCGLIB<span dollar=\"\">$</span>$xxxxã€‚</p><p>è¿™ä¸ªç±»å®é™…ä¸Šæ˜¯AdminUserServiceçš„ä¸€ä¸ªå­ç±»ã€‚å®ƒä¼šoverwriteæ‰€æœ‰publicå’Œprotectedæ–¹æ³•ï¼Œå¹¶åœ¨å†…éƒ¨å°†è°ƒç”¨å§”æ‰˜ç»™åŸå§‹çš„AdminUserServiceå®ä¾‹ã€‚</p><p>ä»å…·ä½“å®ç°è§’åº¦çœ‹ï¼ŒCGLIBä¸­AOPçš„å®ç°æ˜¯åŸºäºorg.springframework.cglib.proxyåŒ…ä¸­  Enhancerå’ŒMethodInterceptorä¸¤ä¸ªæ¥å£æ¥å®ç°çš„ã€‚</p><p><strong>æ•´ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</strong></p><ul>\n<li>å®šä¹‰è‡ªå®šä¹‰çš„MethodInterceptorè´Ÿè´£å§”æ‰˜æ–¹æ³•æ‰§è¡Œï¼›</li>\n<li>åˆ›å»ºEnhanceå¹¶è®¾ç½®Callbackä¸ºä¸Šè¿°MethodInterceptorï¼›</li>\n<li>enhancer.create()åˆ›å»ºä»£ç†ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å…·ä½“åˆ†æä¸€ä¸‹Springçš„ç›¸å…³å®ç°æºç ã€‚</p><p>åœ¨ä¸Šä¸ªæ¡ˆä¾‹åˆ†æé‡Œï¼Œæˆ‘ä»¬ç®€è¦æåŠäº†Springçš„åŠ¨æ€ä»£ç†å¯¹è±¡çš„åˆå§‹åŒ–æœºåˆ¶ã€‚åœ¨å¾—åˆ°Advisorsä¹‹åï¼Œä¼šé€šè¿‡ProxyFactory.getProxyè·å–ä»£ç†å¯¹è±¡ï¼š</p><pre><code>public Object getProxy(ClassLoader classLoader) {\n\treturn createAopProxy().getProxy(classLoader);\n}\n</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»¥CGLIBçš„Proxyçš„å®ç°ç±»CglibAopProxyä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹å…·ä½“çš„æµç¨‹ï¼š</p><pre><code>public Object getProxy(@Nullable ClassLoader classLoader) {\n    // çœç•¥éå…³é”®ä»£ç \n    // åˆ›å»ºåŠé…ç½® Enhancer\n    Enhancer enhancer = createEnhancer();\n    // çœç•¥éå…³é”®ä»£ç \n    // è·å–Callbackï¼šåŒ…å«DynamicAdvisedInterceptorï¼Œäº¦æ˜¯MethodInterceptor\n    Callback[] callbacks = getCallbacks(rootClass);\n    // çœç•¥éå…³é”®ä»£ç \n    // ç”Ÿæˆä»£ç†å¯¹è±¡å¹¶åˆ›å»ºä»£ç†ï¼ˆè®¾ç½® enhancer çš„ callback å€¼ï¼‰\n    return createProxyClassAndInstance(enhancer, callbacks);\n    // çœç•¥éå…³é”®ä»£ç \n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­çš„å‡ ä¸ªå…³é”®æ­¥éª¤å¤§ä½“ç¬¦åˆä¹‹å‰æåŠçš„ä¸‰ä¸ªæ­¥éª¤ï¼Œå…¶ä¸­æœ€åä¸€æ­¥ä¸€èˆ¬éƒ½ä¼šæ‰§è¡Œåˆ°CglibAopProxyå­ç±»ObjenesisCglibAopProxyçš„createProxyClassAndInstance()æ–¹æ³•ï¼š</p><pre><code>protected Object createProxyClassAndInstance(Enhancer enhancer, Callback[] callbacks) {\n   //åˆ›å»ºä»£ç†ç±»Class\n   Class&lt;?&gt; proxyClass = enhancer.createClass();\n   Object proxyInstance = null;\n   //spring.objenesis.ignoreé»˜è®¤ä¸ºfalse\n   //æ‰€ä»¥objenesis.isWorthTrying()ä¸€èˆ¬ä¸ºtrue\n   if (objenesis.isWorthTrying()) {\n      try {\n         // åˆ›å»ºå®ä¾‹\n         proxyInstance = objenesis.newInstance(proxyClass, enhancer.getUseCache());\n      }\n      catch (Throwable ex) {\n          // çœç•¥éå…³é”®ä»£ç \n      }\n   }\n       \n    if (proxyInstance == null) {\n       // å°è¯•æ™®é€šåå°„æ–¹å¼åˆ›å»ºå®ä¾‹\n       try {\n          Constructor&lt;?&gt; ctor = (this.constructorArgs != null ?\n                proxyClass.getDeclaredConstructor(this.constructorArgTypes) :\n                proxyClass.getDeclaredConstructor());\n          ReflectionUtils.makeAccessible(ctor);\n          proxyInstance = (this.constructorArgs != null ?\n                ctor.newInstance(this.constructorArgs) : ctor.newInstance());\n      //çœç•¥éå…³é”®ä»£ç \n       }\n    }\n   // çœç•¥éå…³é”®ä»£ç \n   ((Factory) proxyInstance).setCallbacks(callbacks);\n   return proxyInstance;\n}\n</code></pre><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒSpringä¼šé»˜è®¤å°è¯•ä½¿ç”¨objenesisæ–¹å¼å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¦‚æœå¤±è´¥åˆ™å†æ¬¡å°è¯•ä½¿ç”¨å¸¸è§„æ–¹å¼å®ä¾‹åŒ–å¯¹è±¡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æŸ¥çœ‹objenesisæ–¹å¼å®ä¾‹åŒ–å¯¹è±¡çš„æµç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/42/34/422160a6fd0c3ee1af8b05769a015834.png?wh=1027*397\" alt=\"\"></p><p>å‚ç…§ä¸Šè¿°æˆªå›¾æ‰€ç¤ºè°ƒç”¨æ ˆï¼Œobjenesisæ–¹å¼æœ€åä½¿ç”¨äº†JDKçš„ReflectionFactory.newConstructorForSerialization()å®Œæˆäº†ä»£ç†å¯¹è±¡çš„å®ä¾‹åŒ–ã€‚è€Œå¦‚æœä½ ç¨å¾®ç ”ç©¶ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œä½ ä¼šæƒŠè®¶åœ°å‘ç°ï¼Œè¿™ç§æ–¹å¼åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡æ˜¯ä¸ä¼šåˆå§‹åŒ–ç±»æˆå‘˜å˜é‡çš„ã€‚</p><p>æ‰€ä»¥è¯´åˆ°è¿™é‡Œï¼Œèªæ˜çš„ä½ å¯èƒ½å·²ç»è§‰å¯Ÿåˆ°çœŸç›¸å·²ç»æš´éœ²äº†ï¼Œæˆ‘ä»¬è¿™ä¸ªæ¡ˆä¾‹çš„æ ¸å¿ƒæ˜¯ä»£ç†ç±»å®ä¾‹çš„é»˜è®¤æ„å»ºæ–¹å¼å¾ˆç‰¹åˆ«ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å’Œå¯¹æ¯”ä¸‹é€šè¿‡åå°„æ¥å®ä¾‹åŒ–å¯¹è±¡çš„æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š</p><ul>\n<li>java.lang.Class.newInsance()</li>\n<li>java.lang.reflect.Constructor.newInstance()</li>\n<li>sun.reflect.ReflectionFactory.newConstructorForSerialization().newInstance()</li>\n</ul><p>å‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼éƒ½ä¼šåŒæ—¶åˆå§‹åŒ–ç±»æˆå‘˜å˜é‡ï¼Œä½†æ˜¯æœ€åä¸€ç§é€šè¿‡ReflectionFactory.newConstructorForSerialization().newInstance()å®ä¾‹åŒ–ç±»åˆ™ä¸ä¼šåˆå§‹åŒ–ç±»æˆå‘˜å˜é‡ï¼Œè¿™å°±æ˜¯å½“å‰é—®é¢˜çš„æœ€ç»ˆç­”æ¡ˆäº†ã€‚</p><h3>é—®é¢˜ä¿®æ­£</h3><p>äº†è§£äº†é—®é¢˜çš„æ ¹æœ¬åŸå› åï¼Œä¿®æ­£èµ·æ¥ä¹Ÿå°±ä¸å›°éš¾äº†ã€‚æ—¢ç„¶æ˜¯æ— æ³•ç›´æ¥è®¿é—®è¢«æ‹¦æˆªç±»çš„æˆå‘˜å˜é‡ï¼Œé‚£æˆ‘ä»¬å°±æ¢ä¸ªæ–¹å¼ï¼Œåœ¨UserServiceé‡Œå†™ä¸ªgetUser()æ–¹æ³•ï¼Œä»å†…éƒ¨è®¿é—®è·å–å˜é‡ã€‚</p><p>æˆ‘ä»¬åœ¨AdminUserServiceé‡ŒåŠ äº†ä¸ªgetUser()æ–¹æ³•ï¼š</p><pre><code>public User getUser() {\n    return user;\n}\n</code></pre><p>åœ¨ElectricServiceé‡Œé€šè¿‡getUser()è·å–Userå¯¹è±¡ï¼š</p><blockquote>\n<p>//åŸæ¥å‡ºé”™çš„æ–¹å¼ï¼š<br>\n//String payNum = = adminUserService.adminUser.getPayNum();<br>\n//ä¿®æ”¹åçš„æ–¹å¼ï¼š<br>\nString payNum = adminUserService.getAdminUser().getPayNum();</p>\n</blockquote><p>è¿è¡Œä¸‹æ¥ï¼Œä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥çœ‹åˆ°ç®¡ç†å‘˜ç™»å½•æ—¥å¿—äº†ï¼š</p><pre><code>Electric charging ...\n! admin login ...\nadmin user login...\nUser pay num : 202101166\nPay with alipay ...\n</code></pre><p>ä½†ä½ æœ‰æ²¡æœ‰äº§ç”Ÿå¦ä¸€ä¸ªå›°æƒ‘å‘¢ï¼Ÿæ—¢ç„¶ä»£ç†ç±»çš„ç±»å±æ€§ä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œé‚£ä¸ºä»€ä¹ˆå¯ä»¥é€šè¿‡åœ¨AdminUserServiceé‡Œå†™ä¸ªgetUser()æ–¹æ³•æ¥è·å–ä»£ç†ç±»å®ä¾‹çš„å±æ€§å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å†æ¬¡å›é¡¾createProxyClassAndInstanceçš„ä»£ç é€»è¾‘ï¼Œåˆ›å»ºä»£ç†ç±»åï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨setCallbacksæ¥è®¾ç½®æ‹¦æˆªåéœ€è¦æ³¨å…¥çš„ä»£ç ï¼š</p><pre><code>protected Object createProxyClassAndInstance(Enhancer enhancer, Callback[] callbacks) {\n   Class&lt;?&gt; proxyClass = enhancer.createClass();\n   Object proxyInstance = null;\n   if (objenesis.isWorthTrying()) {\n      try {\n         proxyInstance = objenesis.newInstance(proxyClass, enhancer.getUseCache());\n      }\n   // çœç•¥éå…³é”®ä»£ç \n   ((Factory) proxyInstance).setCallbacks(callbacks);\n   return proxyInstance;\n}\n</code></pre><p>é€šè¿‡ä»£ç è°ƒè¯•å’Œåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ä¸Šè¿°çš„callbacksä¸­ä¼šå­˜åœ¨ä¸€ç§æœåŠ¡äºAOPçš„DynamicAdvisedInterceptorï¼Œå®ƒçš„æ¥å£æ˜¯MethodInterceptorï¼ˆcallbackçš„å­æ¥å£ï¼‰ï¼Œå®ç°äº†æ‹¦æˆªæ–¹æ³•intercept()ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å®ƒæ˜¯å¦‚ä½•å®ç°è¿™ä¸ªæ–¹æ³•çš„ï¼š</p><pre><code>public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {\n   // çœç•¥éå…³é”®ä»£ç \n    TargetSource targetSource = this.advised.getTargetSource();\n    // çœç•¥éå…³é”®ä»£ç  \n      if (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) {\n         Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);\n         retVal = methodProxy.invoke(target, argsToUse);\n      }\n      else {\n         // We need to create a method invocation...\n         retVal = new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();\n      }\n      retVal = processReturnType(proxy, target, method, retVal);\n      return retVal;\n   }\n   //çœç•¥éå…³é”®ä»£ç \n}\n</code></pre><p>å½“ä»£ç†ç±»æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¼šè¢«Springæ‹¦æˆªï¼Œä»è€Œè¿›å…¥æ­¤intercept()ï¼Œå¹¶åœ¨æ­¤æ–¹æ³•ä¸­è·å–è¢«ä»£ç†çš„åŸå§‹å¯¹è±¡ã€‚è€Œåœ¨åŸå§‹å¯¹è±¡ä¸­ï¼Œç±»å±æ€§æ˜¯è¢«å®ä¾‹åŒ–è¿‡ä¸”å­˜åœ¨çš„ã€‚å› æ­¤ä»£ç†ç±»æ˜¯å¯ä»¥é€šè¿‡æ–¹æ³•æ‹¦æˆªè·å–è¢«ä»£ç†å¯¹è±¡å®ä¾‹çš„å±æ€§ã€‚</p><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†é—®é¢˜ã€‚ä½†å¦‚æœä½ çœ‹å¾—ä»”ç»†ï¼Œå°±ä¼šå‘ç°ï¼Œå…¶å®ä½ æ”¹å˜ä¸€ä¸ªå±æ€§ï¼Œä¹Ÿå¯ä»¥è®©äº§ç”Ÿçš„ä»£ç†å¯¹è±¡çš„å±æ€§å€¼ä¸ä¸ºnullã€‚ä¾‹å¦‚ä¿®æ”¹å¯åŠ¨å‚æ•°spring.objenesis.ignoreå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/83/7e/83e34cbd460ac74c5d623905dce0497e.png?wh=933*185\" alt=\"\"></p><p>æ­¤æ—¶å†è°ƒè¯•ç¨‹åºï¼Œä½ ä¼šå‘ç°adminUserå·²ç»ä¸ä¸ºnulläº†ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/b1/3b2dd77392c3b439d0a182f5817045b1.png?wh=801*294\" alt=\"\"></p><p>æ‰€ä»¥è¿™ä¹Ÿæ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•ï¼Œç›¸ä¿¡èªæ˜çš„ä½ å·²ç»èƒ½ä»å‰æ–‡è´´å‡ºçš„ä»£ç ä¸­æ‰¾å‡ºå®ƒèƒ½å¤Ÿå·¥ä½œèµ·æ¥çš„åŸç†äº†ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>é€šè¿‡ä»¥ä¸Šä¸¤ä¸ªæ¡ˆä¾‹çš„ä»‹ç»ï¼Œç›¸ä¿¡ä½ å¯¹Spring AOPåŠ¨æ€ä»£ç†çš„åˆå§‹åŒ–æœºåˆ¶å·²ç»æœ‰äº†è¿›ä¸€æ­¥çš„äº†è§£ï¼Œè¿™é‡Œæ€»ç»“é‡ç‚¹å¦‚ä¸‹ï¼š</p><ol>\n<li>\n<p>ä½¿ç”¨AOPï¼Œå®é™…ä¸Šå°±æ˜¯è®©Springè‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªProxyï¼Œä½¿å¾—è°ƒç”¨è€…èƒ½æ— æ„ŸçŸ¥åœ°è°ƒç”¨æŒ‡å®šæ–¹æ³•ã€‚è€ŒSpringæœ‰åŠ©äºæˆ‘ä»¬åœ¨è¿è¡ŒæœŸé‡ŒåŠ¨æ€ç»‡å…¥å…¶å®ƒé€»è¾‘ï¼Œå› æ­¤ï¼ŒAOPæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ã€‚</p>\n</li>\n<li>\n<p>æˆ‘ä»¬åªæœ‰è®¿é—®è¿™äº›ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œæ‰èƒ½è·å¾—AOPå®ç°çš„åŠŸèƒ½ï¼Œæ‰€ä»¥é€šè¿‡thiså¼•ç”¨æ˜¯æ— æ³•æ­£ç¡®ä½¿ç”¨AOPåŠŸèƒ½çš„ã€‚åœ¨ä¸èƒ½æ”¹å˜ä»£ç ç»“æœå‰æä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡@Autowiredã€AopContext.currentProxy()ç­‰æ–¹å¼è·å–ç›¸åº”çš„ä»£ç†å¯¹è±¡æ¥å®ç°æ‰€éœ€çš„åŠŸèƒ½ã€‚</p>\n</li>\n<li>\n<p>æˆ‘ä»¬ä¸€èˆ¬ä¸èƒ½ç›´æ¥ä»ä»£ç†ç±»ä¸­å»æ‹¿è¢«ä»£ç†ç±»çš„å±æ€§ï¼Œè¿™æ˜¯å› ä¸ºé™¤éæˆ‘ä»¬æ˜¾ç¤ºè®¾ç½®spring.objenesis.ignoreä¸ºtrueï¼Œå¦åˆ™ä»£ç†ç±»çš„å±æ€§æ˜¯ä¸ä¼šè¢«Springåˆå§‹åŒ–çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è¢«ä»£ç†ç±»ä¸­å¢åŠ ä¸€ä¸ªæ–¹æ³•æ¥é—´æ¥è·å–å…¶å±æ€§ã€‚</p>\n</li>\n</ol><h2>æ€è€ƒé¢˜</h2><p>ç¬¬äºŒä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†é€šè¿‡åå°„æ¥å®ä¾‹åŒ–ç±»çš„ä¸‰ç§æ–¹å¼ï¼š</p><ul>\n<li>java.lang.Class.newInsance()</li>\n<li>java.lang.reflect.Constructor.newInstance()</li>\n<li>sun.reflect.ReflectionFactory.newConstructorForSerialization().newInstance()</li>\n</ul><p>å…¶ä¸­ç¬¬ä¸‰ç§æ–¹å¼ä¸ä¼šåˆå§‹åŒ–ç±»å±æ€§ï¼Œä½ èƒ½å¤Ÿå†™ä¸€ä¸ªä¾‹å­æ¥è¯æ˜è¿™ä¸€ç‚¹å—ï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæˆ‘ä»¬ç•™è¨€åŒºè§ï¼</p>","neighbors":{"left":{"article_title":"04ï½œSpring Bean ç”Ÿå‘½å‘¨æœŸå¸¸è§é”™è¯¯","id":367876},"right":{"article_title":"06ï½œSpring AOP å¸¸è§é”™è¯¯ï¼ˆä¸‹ï¼‰","id":369989}},"comments":[{"had_liked":false,"id":327902,"user_name":"é˜¿ç’4r","can_delete":false,"product_type":"c1","uid":1504590,"ip_address":"","ucode":"AF711CD4B24236","user_header":"https://static001.geekbang.org/account/avatar/00/16/f5/4e/87f4faee.jpg","comment_is_top":false,"comment_ctime":1640348319,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"61769890463","product_id":100077001,"comment_content":"æˆ‘ä¸€ç‚¹ä¹Ÿä¸èªæ˜","like_count":15,"discussions":[{"author":{"id":1331611,"avatar":"https://static001.geekbang.org/account/avatar/00/14/51/9b/ccea47d9.jpg","nickname":"å®‰è¿ªå¯†æ©","note":"","ucode":"A6F3F67CF8E6F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555164,"discussion_content":"ä½ æ‰¾ä¸€ä¸‹è¿™ä¸ªåœ°æ–¹ï¼š\n\n//spring.objenesis.ignoreé»˜è®¤ä¸ºfalse   \n//æ‰€ä»¥objenesis.isWorthTrying()ä¸€èˆ¬ä¸ºtrue","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646790966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337371,"user_name":"å®‰è¿ªå¯†æ©","can_delete":false,"product_type":"c1","uid":1331611,"ip_address":"","ucode":"A6F3F67CF8E6F8","user_header":"https://static001.geekbang.org/account/avatar/00/14/51/9b/ccea47d9.jpg","comment_is_top":false,"comment_ctime":1646793299,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"23121629779","product_id":100077001,"comment_content":"hi å‚…å“¥ï¼Œ æ¡ˆä¾‹ä¸€çš„è§£å†³æ–¹æ¡ˆä¸€ï¼Œéœ€è¦åŠ @Lazyå¦åˆ™ä¼šå‡ºç°å¾ªç¯ä¾èµ–ã€‚<br>  @Lazy<br>  @Autowired private ElectricService electricService;","like_count":5,"discussions":[{"author":{"id":1023101,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg","nickname":"studyçš„ç¨‹åºå‘˜","note":"","ucode":"E5AE9037D24429","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582707,"discussion_content":"springå…è®¸å­—æ®µæ³¨å…¥çš„å¾ªç¯ä¾èµ–ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ä¸€å®šå½±å“ï¼Œå¯¼è‡´æå‰aop","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659603362,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290771,"user_name":"Ball","can_delete":false,"product_type":"c1","uid":1521451,"ip_address":"","ucode":"1EE949E68D84CA","user_header":"https://static001.geekbang.org/account/avatar/00/17/37/2b/b32f1d66.jpg","comment_is_top":false,"comment_ctime":1619747804,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18799616988","product_id":100077001,"comment_content":"ğŸ¤”æ€»ç»“ä¸€ä¸‹ï¼Œä»Šå¤©ä»¥ä¸¤ä¸ª AOP åœºæ™¯ä¸‹çš„é—®é¢˜ä¸ºçº¿ç´¢ï¼Œæ·±å…¥ Spring æºç æ¢è®¨äº† Spring çš„åŠ¨æ€ä»£ç†æœºåˆ¶ï¼Œè¿˜åˆ†äº«äº† AOP åœºæ™¯ä¸‹é—®é¢˜çš„ debug æŠ€å·§ã€‚ç»“åˆé—®é¢˜å®šä½çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆç»™å‡ºäº†é—®é¢˜çš„å¤šç§è§£å†³æ–¹æ¡ˆã€‚ğŸ‘","like_count":4},{"had_liked":false,"id":298391,"user_name":"Monday","can_delete":false,"product_type":"c1","uid":1250907,"ip_address":"","ucode":"77B9BACC783598","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","comment_is_top":false,"comment_ctime":1624074496,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14508976384","product_id":100077001,"comment_content":"æ¡ˆä¾‹2ï¼šuserçš„å‘½åä¸€ä¼šuserä¸€ä¼šadminUserï¼Œä¸ç»Ÿä¸€å•Š","like_count":3,"discussions":[{"author":{"id":1331611,"avatar":"https://static001.geekbang.org/account/avatar/00/14/51/9b/ccea47d9.jpg","nickname":"å®‰è¿ªå¯†æ©","note":"","ucode":"A6F3F67CF8E6F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555173,"discussion_content":"æ²¡æ¯›ç—…ï¼ŒadminUser æ˜¯ User çš„å­ç±»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646794570,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291724,"user_name":"å­æˆ¿","can_delete":false,"product_type":"c1","uid":1438860,"ip_address":"","ucode":"CB05938C248BB3","user_header":"https://static001.geekbang.org/account/avatar/00/15/f4/8c/0866b228.jpg","comment_is_top":false,"comment_ctime":1620450511,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14505352399","product_id":100077001,"comment_content":"æœ¬è´¨åŸå› æ˜¯ bean åˆå§‹åŒ–åè¢«åˆ›å»ºä¸ºä»£ç† bean ï¼Œåªæœ‰è®¿é—®ä»£ç†å¯¹è±¡ æ–¹æ³•æ‰ä¼šè¢«æ‹¦æˆª","like_count":4},{"had_liked":false,"id":348188,"user_name":"Geek_930ce1","can_delete":false,"product_type":"c1","uid":2979489,"ip_address":"","ucode":"A0530EF5CAB3A5","user_header":"","comment_is_top":false,"comment_ctime":1654831210,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5949798506","product_id":100077001,"comment_content":"ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory();<br>        Constructor&lt;AdminUserService&gt; constructor1  = AdminUserService.class.getConstructor();<br>        Constructor constructor2 = reflectionFactory.newConstructorForSerialization(AdminUserService.class,constructor1);<br>        AdminUserService adminUserService3 = (AdminUserService)constructor2.newInstance();<br>        System.out.println(&quot;sun.reflect.ReflectionFactory.newConstructorForSerialization().newInstance()&quot;+adminUserService3);<br>ç»è¿‡å°è¯•ï¼Œè¿˜æ˜¯å­˜åœ¨æˆå‘˜å˜é‡ï¼Œæ˜¯ä¸ºä»€ä¹ˆ","like_count":1,"discussions":[{"author":{"id":2118988,"avatar":"https://static001.geekbang.org/account/avatar/00/20/55/4c/a3b696fd.jpg","nickname":"é¥®æ°´å²æº","note":"","ucode":"1E6DC35E3509D3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586162,"discussion_content":"reflectionFactory.newConstructorForSerialization(AdminUserService.class,constructor1);\nå®é™…ä½¿ç”¨çš„å¦å¤–ä¸ªapiï¼Œä¸å«æ„é€ å™¨çš„reflectionFactory.newConstructorForSerialization(AdminUserService.classï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662014492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1023101,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg","nickname":"studyçš„ç¨‹åºå‘˜","note":"","ucode":"E5AE9037D24429","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582717,"discussion_content":"AdminUserService éœ€è¦å®ç° Serializable","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659604070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356151,"user_name":"é¥®æ°´å²æº","can_delete":false,"product_type":"c1","uid":2118988,"ip_address":"åŒ—äº¬","ucode":"1E6DC35E3509D3","user_header":"https://static001.geekbang.org/account/avatar/00/20/55/4c/a3b696fd.jpg","comment_is_top":false,"comment_ctime":1662014388,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1662014388","product_id":100077001,"comment_content":"ç¬¬3ç§æ„é€ æ–¹å¼ï¼Œæˆå‘˜å±æ€§ä¸ä¼šåˆå§‹åŒ–çš„ä»£ç <br>       <br> ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory();<br>        Constructor constructor = reflectionFactory.newConstructorForSerialization(AdminUserService.class);<br>        AdminUserService adminUserService = (AdminUserService) constructor.newInstance();<br>        System.out.println(adminUserService.adminUser.payNum);<br><br>ä½†æ˜¯<br>reflectionFactory.newConstructorForSerializationè¿™ä¸ªæ–¹æ³•è¿˜æœ‰ç§å…¥å‚ï¼Œä¼ å…¥æŒ‡å®šæ„é€ æ–¹æ³•æ—¶ï¼Œå…¶å¯ä»¥å®Œæˆæˆå‘˜å±æ€§åˆå§‹åŒ–ã€‚<br>Constructor&lt;?&gt; newConstructorForSerialization(Class&lt;?&gt; var1, Constructor&lt;?&gt; var2)","like_count":0},{"had_liked":false,"id":351425,"user_name":"è´è¶","can_delete":false,"product_type":"c1","uid":1193167,"ip_address":"","ucode":"8019924D99182F","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/cf/0a316b48.jpg","comment_is_top":false,"comment_ctime":1657781447,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657781447","product_id":100077001,"comment_content":"        Constructor&lt;Object&gt; constructor = Object.class.getDeclaredConstructor();<br>        Constructor&lt;?&gt; constructor1 = ReflectionFactory.getReflectionFactory()<br>                .newConstructorForSerialization(Person.class, constructor);<br><br>        constructor1.s        Constructor&lt;Object&gt; constructor = Object.class.getDeclaredConstructor();<br>        Constructor&lt;?&gt; constructor1 = ReflectionFactory.getReflectionFactory()<br>                .newConstructorForSerialization(Person.class, constructor);<br><br>        constructor1.setAccessible(true);<br>        Person personByReflection = (Person) constructor1.newInstance();<br>        <br>        System.out.println(personByReflection);etAccessible(true);<br>        Person personByReflection = (Person) constructor1.newInstance();<br>        <br>        System.out.println(personByReflection);","like_count":0},{"had_liked":false,"id":351424,"user_name":"è´è¶","can_delete":false,"product_type":"c1","uid":1193167,"ip_address":"","ucode":"8019924D99182F","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/cf/0a316b48.jpg","comment_is_top":false,"comment_ctime":1657781427,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657781427","product_id":100077001,"comment_content":"        Constructor&lt;Object&gt; constructor = Object.class.getDeclaredConstructor();<br>        Constructor&lt;?&gt; constructor1 = ReflectionFactory.getReflectionFactory()<br>                .newConstructorForSerialization(Person.class, constructor);<br><br>        constructor1.setAccessible(true);<br>        Person personByReflection = (        Constructor&lt;Object&gt; constructor = Object.class.getDeclaredConstructor();<br>        Constructor&lt;?&gt; constructor1 = ReflectionFactory.getReflectionFactory()<br>                .newConstructorForSerialization(Person.class, constructor);<br><br>        constructor1.setAccessible(true);<br>        Person personByReflection = (Person) constructor1.newInstance();<br>                Constructor&lt;Object&gt; constructor = Object.class.getDeclaredConstructor();<br>        Constructor&lt;?&gt; constructor1 = ReflectionFactory.getReflectionFactory()<br>                .newConstructorForSerialization(Person.class, constructor);<br><br>        constructor1.setAccessible(true);<br>        Person personByReflection = (Person) constructor1.newInstance();<br>        11111<br>        System.out.println(personByReflectio11n);<br>        System.out.println(personByReflection);) constructor1.newInstance();<br>        <br>        System.out.println(personByReflection);","like_count":0},{"had_liked":false,"id":347315,"user_name":"Bumblebee","can_delete":false,"product_type":"c1","uid":2051293,"ip_address":"","ucode":"B879C8A511D08D","user_header":"https://static001.geekbang.org/account/avatar/00/1f/4c/dd/c6035349.jpg","comment_is_top":false,"comment_ctime":1653918328,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1653918328","product_id":100077001,"comment_content":"ä»Šæ—¥æ”¶è·ï¼ˆæ€»ç»“çš„ä¸å¯¹çš„å¸Œæœ›è€å¸ˆåŒå­¦ä»¬å¤šå¤šæŒ‡æ­£ï¼‰<br><br>â‘  JDK åŠ¨æ€ä»£ç†åªèƒ½å¯¹å®ç°äº†æ¥å£çš„ç±»ç”Ÿæˆä»£ç†ï¼Œè€Œä¸èƒ½é’ˆå¯¹æ™®é€šç±»ã€‚è€Œ CGLIB æ˜¯å¯ä»¥é’ˆå¯¹ç±»å®ç°ä»£ç†ï¼Œä¸»è¦æ˜¯å¯¹æŒ‡å®šçš„ç±»ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œè¦†ç›–å…¶ä¸­çš„æ–¹æ³•ï¼Œæ¥å®ç°ä»£ç†å¯¹è±¡ã€‚<br><br>â‘¡ thisè°ƒç”¨çš„å½“å‰ç±»æ–¹æ³•æ— æ³•è¢«æ‹¦æˆªï¼ˆå¯ä»¥é€šè¿‡@Autowiredã€AopContext.currentProxy() æ–¹å¼è§£å†³ï¼‰ï¼›<br><br>â‘¢ æˆ‘ä»¬ä¸€èˆ¬ä¸èƒ½ç›´æ¥ä»ä»£ç†ç±»ä¸­å»æ‹¿è¢«ä»£ç†ç±»çš„å±æ€§ï¼Œè¿™æ˜¯å› ä¸ºé™¤éæˆ‘ä»¬æ˜¾ç¤ºè®¾ç½® spring.objenesis.ignore ä¸º trueï¼Œå¦åˆ™ä»£ç†ç±»çš„å±æ€§æ˜¯ä¸ä¼šè¢« Spring åˆå§‹åŒ–çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è¢«ä»£ç†ç±»ä¸­å¢åŠ ä¸€ä¸ªæ–¹æ³•æ¥é—´æ¥è·å–å…¶å±æ€§ã€‚<br><br><br>æ€»ç»“ï¼šæˆ‘è§‰å¾—SpringAopç”Ÿæˆçš„ä»£ç†ç±»æ˜¯å¯¹è¢«ä»£ç†ç±»çš„ä¸€ä¸ªåŒ…è£…ï¼Œä»£ç†ç±»å¯¹è±¡ä»…è¢«ä»£ç†å¯¹è±¡æ–¹æ³•æ‰§è¡Œå‰åè¿›è¡Œå¢å¼ºï¼ŒåŸå§‹æ–¹æ³•çš„è°ƒç”¨è¿˜æ˜¯ç”±è¢«ä»£ç†å¯¹è±¡è‡ªå·±æ‰§è¡Œï¼›","like_count":0},{"had_liked":false,"id":345584,"user_name":"æ‡µé€¼çŒ´","can_delete":false,"product_type":"c1","uid":1204947,"ip_address":"","ucode":"BDC748A96AC316","user_header":"https://static001.geekbang.org/account/avatar/00/12/62/d3/663de972.jpg","comment_is_top":false,"comment_ctime":1652413235,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652413235","product_id":100077001,"comment_content":"@@Lookup ä¹Ÿå¯ä»¥å®ç°æ¡ˆä¾‹ä¸€","like_count":0},{"had_liked":false,"id":338889,"user_name":"jerry guo","can_delete":false,"product_type":"c1","uid":1267753,"ip_address":"","ucode":"179943AFCB93F8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo2GMhevabZrjINs2TKvIeGC7TJkicNlLvqTticuM5KL8ZN80OC2CnrsUyzPcZXO4uptj4Q1S4jT2lQ/132","comment_is_top":false,"comment_ctime":1647775980,"is_pvip":true,"replies":[{"id":"123900","content":"åŒå­¦å…·ä½“å“ªé‡Œæ²¡çœ‹æ‡‚ï¼Œå¯å¦å…·ä½“ï¼Ÿæ–¹ä¾¿å°ç¼–è¿­ä»£ã€‚","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":"1356014","ctime":1647858481,"ip_address":"","comment_id":338889,"utype":2}],"discussion_count":2,"race_medal":0,"score":"1647775980","product_id":100077001,"comment_content":"è¿™ç¯‡å¤ªéš¾äº† æ²¡çœ‹æ‡‚","like_count":0,"discussions":[{"author":{"id":1356014,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b0/ee/d0871efd.jpg","nickname":"å†¬é’","note":"","ucode":"14576781B499FB","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557548,"discussion_content":"åŒå­¦å…·ä½“å“ªé‡Œæ²¡çœ‹æ‡‚ï¼Œå¯å¦å…·ä½“ï¼Ÿæ–¹ä¾¿å°ç¼–è¿­ä»£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647858482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1023101,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg","nickname":"studyçš„ç¨‹åºå‘˜","note":"","ucode":"E5AE9037D24429","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582708,"discussion_content":"æœ‰é’±çœŸå¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659603452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":337366,"user_name":"å®‰è¿ªå¯†æ©","can_delete":false,"product_type":"c1","uid":1331611,"ip_address":"","ucode":"A6F3F67CF8E6F8","user_header":"https://static001.geekbang.org/account/avatar/00/14/51/9b/ccea47d9.jpg","comment_is_top":false,"comment_ctime":1646791588,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1646791588","product_id":100077001,"comment_content":"hi å‚…å“¥ï¼Œ é‚£æ˜¯ä¸æ˜¯è¯´ private æ–¹æ³•æ— æ³•è¢«AOP å¢å¼ºï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1023101,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg","nickname":"studyçš„ç¨‹åºå‘˜","note":"","ucode":"E5AE9037D24429","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582710,"discussion_content":"åº”è¯¥æ˜¯å› ä¸ºprivateæ–¹æ³•æ— æ³•è¢«ç»§æ‰¿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659603483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335429,"user_name":"å¼€å·","can_delete":false,"product_type":"c1","uid":2754166,"ip_address":"","ucode":"21A9D6CE85EF58","user_header":"https://static001.geekbang.org/account/avatar/00/2a/06/76/c2d807bf.jpg","comment_is_top":false,"comment_ctime":1645516327,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1645516327","product_id":100077001,"comment_content":"æ¡ˆä¾‹ä¸€é‡Œï¼Œè‡ªå·±å¼•ç”¨è‡ªå·±ï¼Œæˆ‘æŠ¥äº†å¾ªç¯ä¾èµ–çš„é”™è¯¯","like_count":0,"discussions":[{"author":{"id":1331611,"avatar":"https://static001.geekbang.org/account/avatar/00/14/51/9b/ccea47d9.jpg","nickname":"å®‰è¿ªå¯†æ©","note":"","ucode":"A6F3F67CF8E6F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555168,"discussion_content":"åœ¨@Autowired ä¸Šé¢åŠ @Lazy","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646793207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323262,"user_name":"è±†æ³¥ä¸¸","can_delete":false,"product_type":"c1","uid":1186828,"ip_address":"","ucode":"D1638AFD21A224","user_header":"https://static001.geekbang.org/account/avatar/00/12/1c/0c/b5b2cd51.jpg","comment_is_top":false,"comment_ctime":1637806429,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637806429","product_id":100077001,"comment_content":"æ¡ˆä¾‹äºŒï¼Œæˆå‘˜å˜é‡æˆ‘å¦‚æœä¸å£°æ˜æˆfinalï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥ç»§æ‰¿åˆ°äº†å•Š","like_count":0},{"had_liked":false,"id":319570,"user_name":"æäºŒæœ¨","can_delete":false,"product_type":"c1","uid":1103091,"ip_address":"","ucode":"30E03BB84ADB27","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg","comment_is_top":false,"comment_ctime":1635852872,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1635852872","product_id":100077001,"comment_content":"String payNum = dminUserService.user.getPayNum(); æœ‰ä¸¤ä¸ªæ‹¼å†™é”™è¯¯ï¼ŒdminUserService ä¸å¯¹ï¼Œåº”è¯¥æ˜¯adminUserServiceï¼ŒadminUserServiceé‡Œå±æ€§åæ˜¯adminUser,ä¸æ˜¯user","like_count":0},{"had_liked":false,"id":304243,"user_name":"Geek_5aec96","can_delete":false,"product_type":"c1","uid":2591874,"ip_address":"","ucode":"45345D53041E42","user_header":"","comment_is_top":false,"comment_ctime":1627302705,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1627302705","product_id":100077001,"comment_content":"è€å¸ˆ ä½ å¥½ thisä¸ºä»€ä¹ˆä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079495,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg","nickname":"æ–°ä¸–ç•Œ","note":"","ucode":"4473DC1505F158","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394307,"discussion_content":"å› ä¸ºè°ƒç”¨çœŸæ­£è¢«ä»£ç†çš„æ–¹æ³•ï¼Œæ˜¯é€šè¿‡åŸå§‹å¯¹è±¡è°ƒç”¨çš„ï¼Œè€Œä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨è¢«ä»£ç†æ–¹æ³•çš„å†…éƒ¨ç”¨thisï¼Œå°±æ˜¯è¢«ä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡åªæ˜¯é‡å†™äº†è¢«ä»£ç†å¯¹è±¡æ–¹æ³•ï¼Œå½“çœŸæ­£è°ƒç”¨è¢«ä»£ç†å¯¹è±¡æ–¹æ³•æ—¶ï¼Œéœ€è¦åŸå¯¹è±¡çš„ï¼Œä½ å¯ä»¥å®ç°MethodInterceptorï¼Œè°ƒè¯•ä¸€ä¸‹çœŸæ­£çš„æ–¹æ³•æ‰§è¡Œï¼Œå°±æ˜ç™½äº†","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1631838895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298915,"user_name":"Monday","can_delete":false,"product_type":"c1","uid":1250907,"ip_address":"","ucode":"77B9BACC783598","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","comment_is_top":false,"comment_ctime":1624372119,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1624372119","product_id":100077001,"comment_content":"æ¡ˆä¾‹2å¦‚æœgetUser()ä¹Ÿè¢«AOPæ‹¦æˆªçš„è¯ï¼ŒElectricServiceä¸­è°ƒç”¨adminUserService.getUser()è¿˜æ˜¯ä¼šæŠ¥NPEã€‚æˆ‘ç†è§£AdminUserServiceçš„ä»£ç†ç±»çš„getUser()æ–¹æ³•ä¼šè°ƒç”¨AdminUserService.getUser()åº”è¯¥ä¼šè¿”å›éç©ºå¯¹è±¡æ‰å¯¹å•Š","like_count":0,"discussions":[{"author":{"id":1079495,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg","nickname":"æ–°ä¸–ç•Œ","note":"","ucode":"4473DC1505F158","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394308,"discussion_content":"å¦‚æœgetUserè¢«æ‹¦æˆªï¼Œé‚£ä¹ˆè°ƒç”¨get Userçš„ä¾ç„¶æ˜¯ä»£ç†å¯¹è±¡ï¼Œå’ŒåŸé—®é¢˜ä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631839009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291976,"user_name":"TANMIYOO","can_delete":false,"product_type":"c1","uid":1375256,"ip_address":"","ucode":"BC3556131D4D61","user_header":"https://static001.geekbang.org/account/avatar/00/14/fc/18/8e69f7cf.jpg","comment_is_top":false,"comment_ctime":1620633607,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1620633607","product_id":100077001,"comment_content":"è€å¸ˆæˆ‘æœ‰ä¸ªé—®é¢˜æ³¨è§£@EnableAspectJAutoProxyçš„å±æ€§proxyTargetClassé»˜è®¤æ˜¯falseï¼ŒElectricServiceå¹¶æ²¡æœ‰å®ç°æ¥å£ï¼Œä¸ºä»€ä¹ˆè¿˜å¯ä»¥åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1023101,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg","nickname":"studyçš„ç¨‹åºå‘˜","note":"","ucode":"E5AE9037D24429","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582713,"discussion_content":"å¦‚æœä¸ºtrueï¼Œä¸€å®šæ˜¯cglibï¼Œå¦‚æœä¸ºfalseï¼Œspringä¼šçœ‹æœ‰æ²¡æœ‰æ¥å£ï¼Œæ²¡æœ‰å°±è¿˜æ˜¯cglib","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659603588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290836,"user_name":"å“¦å¼æ‰äº†","can_delete":false,"product_type":"c1","uid":1232599,"ip_address":"","ucode":"1F89B1BA1EEF52","user_header":"https://static001.geekbang.org/account/avatar/00/12/ce/d7/8168e1bf.jpg","comment_is_top":false,"comment_ctime":1619774923,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1619774923","product_id":100077001,"comment_content":"System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, &quot;.&#47;cglib&quot;); &#47;&#47;ä»£ç†ç±»æŒä¹…åŒ–åˆ°æ–‡ä»¶<br>æ€è€ƒé¢˜ï¼š<br>AdminUserServiceSonç»§æ‰¿AdminUserServiceï¼Œçœ‹èµ·æ¥çˆ¶ç±»éƒ½æ²¡æœ‰åŠ è½½ã€‚ä½†æ˜¯ä¸ºå•¥è¿˜æ˜¯å¸Œæœ›è€å¸ˆè§£ç­”ä¸‹<br>        SunReflectionFactoryInstantiator instantiator = new SunReflectionFactoryInstantiator(AdminUserServiceSon.class);<br>        System.out.println(instantiator.newInstance());<br><br>        Constructor&lt;AdminUserServiceSon&gt; constructor = AdminUserServiceSon.class.getConstructor(null);<br>        System.out.println(constructor.newInstance().adminUser);<br><br>        AdminUserServiceSon adminUserServiceSon = AdminUserServiceSon.class.newInstance();<br>        System.out.println(adminUserServiceSon.adminUser);","like_count":0}]}