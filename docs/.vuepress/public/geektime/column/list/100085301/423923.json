{"id":423923,"title":"17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†åˆ‡ç‰‡ï¼Œå¯¹æ¯”äº†æ•°ç»„ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²å’Œå®ƒä»¬çš„åˆ‡ç‰‡ä»¥åŠåˆ‡ç‰‡å¼•ç”¨çš„å…³ç³»ã€‚ä»Šå¤©å°±ç»§ç»­è®² Rust é‡Œå¦ä¸€ä¸ªéå¸¸é‡è¦çš„é›†åˆå®¹å™¨ï¼šHashMapï¼Œä¹Ÿå°±æ˜¯å“ˆå¸Œè¡¨ã€‚</p><p>å¦‚æœè°ˆè®ºè½¯ä»¶å¼€å‘ä¸­æœ€é‡è¦ã€å‡ºé•œç‡æœ€é«˜çš„æ•°æ®ç»“æ„ï¼Œé‚£å“ˆå¸Œè¡¨ä¸€å®šä½åˆ—å…¶ä¸­ã€‚å¾ˆå¤šç¼–ç¨‹è¯­è¨€ç”šè‡³å°†å“ˆå¸Œè¡¨ä½œä¸ºä¸€ç§å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œåšè¿›äº†è¯­è¨€çš„æ ¸å¿ƒã€‚æ¯”å¦‚ PHP çš„å…³è”æ•°ç»„ï¼ˆassociate arrayï¼‰ã€Python çš„å­—å…¸ï¼ˆdictï¼‰ã€JavaScript çš„å¯¹è±¡ï¼ˆobjectï¼‰å’Œ Mapã€‚</p><p>Google çš„å·¥ç¨‹å¸ˆMatt Kulukundis åœ¨ <a href=\"https://youtu.be/ncHmEUmJZf4?t=210\">cppCon 2017</a> åšçš„ä¸€ä¸ªæ¼”è®²ï¼Œè¯´ï¼šå…¨ä¸–ç•Œ Google çš„æœåŠ¡å™¨ä¸Š 1% çš„ CPU æ—¶é—´ç”¨æ¥åšå“ˆå¸Œè¡¨çš„è®¡ç®—ï¼Œè¶…è¿‡ 4% çš„å†…å­˜ç”¨æ¥å­˜å‚¨å“ˆå¸Œè¡¨ã€‚è¶³ä»¥è¯æ˜å“ˆå¸Œè¡¨çš„é‡è¦æ€§ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼ï¼Œéƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨ï¼Œå¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/4e/83/4e0c043a82e29886cd7b8e1dd79a5183.jpg?wh=2364x1304\" alt=\"\"></p><h2>Rust çš„å“ˆå¸Œè¡¨</h2><p>é‚£ Rust ä¸ºæˆ‘ä»¬æä¾›äº†ä»€ä¹ˆæ ·çš„å“ˆå¸Œè¡¨å‘¢ï¼Ÿå®ƒé•¿ä»€ä¹ˆæ ·ï¼Ÿæ€§èƒ½å¦‚ä½•ï¼Ÿæˆ‘ä»¬ä»å®˜æ–¹æ–‡æ¡£å­¦èµ·ã€‚</p><p>å¦‚æœä½ æ‰“å¼€ <a href=\"https://doc.rust-lang.org/std/collections/struct.HashMap.html\">HashMap</a> çš„æ–‡æ¡£ï¼Œä¼šçœ‹åˆ°è¿™æ ·ä¸€å¥è¯ï¼š</p><blockquote>\n<p>A hash map implemented with <strong>quadratic probing</strong> and <strong>SIMD lookup</strong>.</p>\n</blockquote><!-- [[[read_end]]] --><p>è¿™ä¸€çœ‹å°±æœ‰ç‚¹è‚¾ä¸Šè…ºç´ ä¸Šå‡äº†ï¼Œå‡ºç°äº†ä¸¤ä¸ªé«˜ç«¯è¯æ±‡ï¼šäºŒæ¬¡æ¢æŸ¥ï¼ˆquadratic probingï¼‰å’Œ SIMD æŸ¥è¡¨ï¼ˆSIMD lookupï¼‰ï¼Œéƒ½æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå®ƒä»¬æ˜¯Rustå“ˆå¸Œè¡¨ç®—æ³•çš„è®¾è®¡æ ¸å¿ƒï¼Œæˆ‘ä»¬ä»Šå¤©çš„å­¦ä¹ ä¹Ÿä¼šå›´ç»•ç€è¿™ä¸¤ä¸ªè¯å±•å¼€ï¼Œæ‰€ä»¥åˆ«ç€æ€¥ï¼Œç­‰å­¦å®Œç›¸ä¿¡ä½ ä¼šç†è§£è¿™å¥è¯çš„ã€‚</p><p>å…ˆæŠŠåŸºç¡€ç†è®ºæ‰«ä¸€éã€‚å“ˆå¸Œè¡¨æœ€æ ¸å¿ƒçš„ç‰¹ç‚¹å°±æ˜¯ï¼š<strong>å·¨é‡çš„å¯èƒ½è¾“å…¥å’Œæœ‰é™çš„å“ˆå¸Œè¡¨å®¹é‡ã€‚</strong>è¿™å°±ä¼šå¼•å‘å“ˆå¸Œå†²çªï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªæˆ–è€…å¤šä¸ªè¾“å…¥çš„å“ˆå¸Œè¢«æ˜ å°„åˆ°äº†åŒä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦èƒ½å¤Ÿå¤„ç†å“ˆå¸Œå†²çªã€‚</p><p>è¦è§£å†³å†²çªï¼Œé¦–å…ˆå¯ä»¥é€šè¿‡æ›´å¥½çš„ã€åˆ†å¸ƒæ›´å‡åŒ€çš„å“ˆå¸Œå‡½æ•°ï¼Œä»¥åŠä½¿ç”¨æ›´å¤§çš„å“ˆå¸Œè¡¨æ¥ç¼“è§£å†²çªï¼Œä½†æ— æ³•å®Œå…¨è§£å†³ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨å†²çªè§£å†³æœºåˆ¶ã€‚</p><h3>å¦‚ä½•è§£å†³å†²çªï¼Ÿ</h3><p>ç†è®ºä¸Šï¼Œä¸»è¦çš„å†²çªè§£å†³æœºåˆ¶æœ‰é“¾åœ°å€æ³•ï¼ˆchainingï¼‰å’Œå¼€æ”¾å¯»å€æ³•ï¼ˆopen addressingï¼‰ã€‚</p><p>é“¾åœ°å€æ³•ï¼Œæˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå°±æ˜¯æŠŠè½åœ¨åŒä¸€ä¸ªå“ˆå¸Œä¸Šçš„æ•°æ®ç”¨å•é“¾è¡¨æˆ–è€…åŒé“¾è¡¨è¿æ¥èµ·æ¥ã€‚è¿™æ ·åœ¨æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå…ˆæ‰¾åˆ°å¯¹åº”çš„å“ˆå¸Œæ¡¶ï¼ˆhash bucketï¼‰ï¼Œç„¶åå†åœ¨å†²çªé“¾ä¸ŠæŒ¨ä¸ªæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„é¡¹ï¼š<img src=\"https://static001.geekbang.org/resource/image/a3/5d/a3334e4a3259e0bd231815a486b7c45d.jpg?wh=2364x1610\" alt=\"\"></p><p>å†²çªé“¾å¤„ç†å“ˆå¸Œå†²çªéå¸¸ç›´è§‚ï¼Œå¾ˆå®¹æ˜“ç†è§£å’Œæ’°å†™ä»£ç ï¼Œä½†ç¼ºç‚¹æ˜¯å“ˆå¸Œè¡¨å’Œå†²çªé“¾ä½¿ç”¨äº†ä¸åŒçš„å†…å­˜ï¼Œå¯¹ç¼“å­˜ä¸å‹å¥½ã€‚</p><p>å¼€æ”¾å¯»å€æ³•æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨çœ‹åšä¸€ä¸ªå¤§æ•°ç»„ï¼Œä¸å¼•å…¥é¢å¤–çš„å†…å­˜ï¼Œå½“å†²çªäº§ç”Ÿæ—¶ï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æŠŠæ•°æ®æ’å…¥åˆ°å…¶å®ƒç©ºé—²çš„ä½ç½®ã€‚æ¯”å¦‚çº¿æ€§æ¢å¯»ï¼ˆlinear probingï¼‰åœ¨å‡ºç°å“ˆå¸Œå†²çªæ—¶ï¼Œä¸æ–­å¾€åæ¢å¯»ï¼Œç›´åˆ°æ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ã€‚</p><p>è€Œ<strong>äºŒæ¬¡æ¢æŸ¥</strong>ï¼Œç†è®ºä¸Šæ˜¯åœ¨å†²çªå‘ç”Ÿæ—¶ï¼Œä¸æ–­æ¢å¯»å“ˆå¸Œä½ç½®åŠ å‡ n çš„äºŒæ¬¡æ–¹ï¼Œæ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ï¼Œæˆ‘ä»¬çœ‹å›¾ï¼Œæ›´å®¹æ˜“ç†è§£ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/42/4e/42a18970ac2eec7510c69c1f8323bc4e.jpg?wh=2364x1304\" alt=\"\">ï¼ˆå›¾ä¸­ç¤ºæ„æ˜¯ç†è®ºä¸Šçš„å¤„ç†æ–¹æ³•ï¼Œå®é™…ä¸ºäº†æ€§èƒ½ä¼šæœ‰å¾ˆå¤šä¸åŒçš„å¤„ç†ã€‚ï¼‰</p><p>å¼€æ”¾å¯»å€è¿˜æœ‰å…¶å®ƒæ–¹æ¡ˆï¼Œæ¯”å¦‚äºŒæ¬¡å“ˆå¸Œä»€ä¹ˆçš„ï¼Œä»Šå¤©å°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚</p><p>å¥½ï¼Œææ˜ç™½å“ˆå¸Œè¡¨çš„äºŒæ¬¡æ¢æŸ¥çš„ç†è®ºçŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹ï¼ŒRust å“ˆå¸Œè¡¨ä¸æ˜¯ç”¨å†²çªé“¾æ¥è§£å†³å“ˆå¸Œå†²çªï¼Œè€Œæ˜¯ç”¨å¼€æ”¾å¯»å€æ³•çš„äºŒæ¬¡æ¢æŸ¥æ¥è§£å†³çš„ã€‚å½“ç„¶ï¼Œåé¢ä¼šè®²åˆ° Rust çš„äºŒæ¬¡æ¢æŸ¥å’Œç†è®ºçš„å¤„ç†æ–¹å¼æœ‰äº›å·®åˆ«ã€‚</p><p>è€Œå¦ä¸€ä¸ªå…³é”®è¯ï¼Œä½¿ç”¨ SIMD åšå•æŒ‡ä»¤å¤šæ•°æ®çš„æŸ¥è¡¨ï¼Œä¹Ÿå’Œä¸€ä¼šè¦è®²åˆ° Rust å“ˆå¸Œè¡¨å·§å¦™çš„å†…å­˜å¸ƒå±€æ¯æ¯ç›¸å…³ã€‚</p><h3>HashMap çš„æ•°æ®ç»“æ„</h3><p>è¿›å…¥æ­£é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Rust å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œæ‰“å¼€æ ‡å‡†åº“çš„ <a href=\"https://doc.rust-lang.org/src/std/collections/hash/map.rs.html#206-208\">æºä»£ç </a>ï¼š</p><pre><code class=\"language-rust\">use hashbrown::hash_map as base;\n\n#[derive(Clone)]\npub struct RandomState {\n    k0: u64,\n    k1: u64,\n}\n\npub struct HashMap&lt;K, V, S = RandomState&gt; {\n    base: base::HashMap&lt;K, V, S&gt;,\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒHashMap æœ‰ä¸‰ä¸ªæ³›å‹å‚æ•°ï¼ŒK å’Œ V ä»£è¡¨ key / value çš„ç±»å‹ï¼ŒS æ˜¯å“ˆå¸Œç®—æ³•çš„çŠ¶æ€ï¼Œå®ƒé»˜è®¤æ˜¯ RandomStateï¼Œå ä¸¤ä¸ª u64ã€‚RandomState ä½¿ç”¨ SipHash ä½œä¸ºç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼ˆcryptographically secure hashingï¼‰ã€‚</p><p>ä»å®šä¹‰ä¸­è¿˜èƒ½çœ‹åˆ°ï¼ŒRust çš„ HashMap å¤ç”¨äº† hashbrown çš„ HashMapã€‚hashbrown æ˜¯ Rust ä¸‹å¯¹ <a href=\"https://abseil.io/blog/20180927-swisstables\">Google Swiss Table</a> çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆå®ç°ï¼Œæˆ‘ä»¬æ‰“å¼€ hashbrown çš„ä»£ç ï¼Œçœ‹å®ƒçš„<a href=\"https://docs.rs/hashbrown/0.11.2/src/hashbrown/map.rs.html#192-195\">ç»“æ„</a>ï¼š</p><pre><code class=\"language-rust\">pub struct HashMap&lt;K, V, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; {\n    pub(crate) hash_builder: S,\n    pub(crate) table: RawTable&lt;(K, V), A&gt;,\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒHashMap é‡Œæœ‰ä¸¤ä¸ªåŸŸï¼Œä¸€ä¸ªæ˜¯ hash_builderï¼Œç±»å‹æ˜¯åˆšæ‰æˆ‘ä»¬æåˆ°çš„æ ‡å‡†åº“ä½¿ç”¨çš„ RandomStateï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å…·ä½“çš„ RawTableï¼š</p><pre><code class=\"language-rust\">pub struct RawTable&lt;T, A: Allocator + Clone = Global&gt; {\n    table: RawTableInner&lt;A&gt;,\n    // Tell dropck that we own instances of T.\n    marker: PhantomData&lt;T&gt;,\n}\n\nstruct RawTableInner&lt;A&gt; {\n    // Mask to get an index from a hash value. The value is one less than the\n    // number of buckets in the table.\n    bucket_mask: usize,\n\n    // [Padding], T1, T2, ..., Tlast, C1, C2, ...\n    //                                ^ points here\n    ctrl: NonNull&lt;u8&gt;,\n\n    // Number of elements that can be inserted before we need to grow the table\n    growth_left: usize,\n\n    // Number of elements in the table, only really used by len()\n    items: usize,\n\n    alloc: A,\n}\n</code></pre><p>RawTable ä¸­ï¼Œå®é™…ä¸Šæœ‰æ„ä¹‰çš„æ•°æ®ç»“æ„æ˜¯ RawTableInnerï¼Œå‰å››ä¸ªå­—æ®µå¾ˆé‡è¦ï¼Œæˆ‘ä»¬ä¸€ä¼šè®²HashMapçš„å†…å­˜å¸ƒå±€ä¼šå†æåˆ°ï¼š</p><ul>\n<li>usize çš„ bucket_maskï¼Œæ˜¯å“ˆå¸Œè¡¨ä¸­å“ˆå¸Œæ¡¶çš„æ•°é‡å‡ä¸€ï¼›</li>\n<li>åå­—å« ctrl çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘å“ˆå¸Œè¡¨å †å†…å­˜æœ«ç«¯çš„ ctrl åŒºï¼›</li>\n<li>usize çš„å­—æ®µ growth_leftï¼ŒæŒ‡å“ˆå¸Œè¡¨åœ¨ä¸‹æ¬¡è‡ªåŠ¨å¢é•¿å‰è¿˜èƒ½å­˜å‚¨å¤šå°‘æ•°æ®ï¼›</li>\n<li>usize çš„ itemsï¼Œè¡¨æ˜å“ˆå¸Œè¡¨ç°åœ¨æœ‰å¤šå°‘æ•°æ®ã€‚</li>\n</ul><p>è¿™é‡Œæœ€åçš„ alloc å­—æ®µï¼Œå’Œ RawTable çš„ marker ä¸€æ ·ï¼Œåªæ˜¯ä¸€ä¸ªç”¨æ¥å ä½çš„ç±»å‹ï¼Œæˆ‘ä»¬ç°åœ¨åªéœ€çŸ¥é“ï¼Œå®ƒç”¨æ¥åˆ†é…åœ¨å †ä¸Šçš„å†…å­˜ã€‚</p><h3>HashMap çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</h3><p>æ•°æ®ç»“æ„ææ¸…æ¥šï¼Œæˆ‘ä»¬å†çœ‹å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚Rust å“ˆå¸Œè¡¨çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—å¾ˆæ–¹ä¾¿çš„æ–¹æ³•ï¼Œä½¿ç”¨èµ·æ¥å’Œå…¶å®ƒè¯­è¨€éå¸¸ç±»ä¼¼ï¼Œä½ åªè¦çœ‹çœ‹<a href=\"https://doc.rust-lang.org/std/collections/struct.HashMap.html\">æ–‡æ¡£</a>ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£ã€‚æˆ‘ä»¬æ¥å†™æ®µä»£ç ï¼Œå°è¯•ä¸€ä¸‹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a0543e873c9b6ecb49f56755493dc968\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::collections::HashMap;\n\nfn main() {\n    let mut map = HashMap::new();\n    explain(\"empty\", &amp;map);\n\n    map.insert('a', 1);\n    explain(\"added 1\", &amp;map);\n\n    map.insert('b', 2);\n    map.insert('c', 3);\n    explain(\"added 3\", &amp;map);\n\n    map.insert('d', 4);\n    explain(\"added 4\", &amp;map);\n\n    // get æ—¶éœ€è¦ä½¿ç”¨å¼•ç”¨ï¼Œå¹¶ä¸”ä¹Ÿè¿”å›å¼•ç”¨\n    assert_eq!(map.get(&amp;'a'), Some(&amp;1));\n    assert_eq!(map.get_key_value(&amp;'b'), Some((&amp;'b', &amp;2)));\n\n    map.remove(&amp;'a');\n    // åˆ é™¤åå°±æ‰¾ä¸åˆ°äº†\n    assert_eq!(map.contains_key(&amp;'a'), false);\n    assert_eq!(map.get(&amp;'a'), None);\n    explain(\"removed\", &amp;map);\n    // shrink åå“ˆå¸Œè¡¨å˜å°\n    map.shrink_to_fit();\n    explain(\"shrinked\", &amp;map);\n}\n\nfn explain&lt;K, V&gt;(name: &amp;str, map: &amp;HashMap&lt;K, V&gt;) {\n    println!(\"{}: len: {}, cap: {}\", name, map.len(), map.capacity());\n}\n</code></pre><p>è¿è¡Œè¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·çš„è¾“å‡ºï¼š</p><pre><code class=\"language-rust\">empty: len: 0, cap: 0\nadded 1: len: 1, cap: 3\nadded 3: len: 3, cap: 3\nadded 4: len: 4, cap: 7\nremoved: len: 3, cap: 7\nshrinked: len: 3, cap: 3\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ HashMap::new() æ—¶ï¼Œå®ƒå¹¶æ²¡æœ‰åˆ†é…ç©ºé—´ï¼Œå®¹é‡ä¸ºé›¶ï¼Œ<strong>éšç€å“ˆå¸Œè¡¨ä¸æ–­æ’å…¥æ•°æ®ï¼Œå®ƒä¼šä»¥ 2çš„å¹‚å‡ä¸€çš„æ–¹å¼å¢é•¿</strong>ï¼Œæœ€å°æ˜¯ 3ã€‚å½“åˆ é™¤è¡¨ä¸­çš„æ•°æ®æ—¶ï¼ŒåŸæœ‰çš„è¡¨å¤§å°ä¸å˜ï¼Œåªæœ‰æ˜¾å¼åœ°è°ƒç”¨ shrink_to_fitï¼Œæ‰ä¼šè®©å“ˆå¸Œè¡¨å˜å°ã€‚</p><h2>HashMap çš„å†…å­˜å¸ƒå±€</h2><p>ä½†æ˜¯é€šè¿‡ HashMap çš„å…¬å¼€æ¥å£ï¼Œæˆ‘ä»¬æ— æ³•çœ‹åˆ° HashMap åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•å¸ƒå±€çš„ï¼Œè¿˜æ˜¯éœ€è¦å€ŸåŠ©ä¹‹å‰ä½¿ç”¨è¿‡çš„ std::mem::transmute æ–¹æ³•ï¼Œæ¥æŠŠæ•°æ®ç»“æ„æ‰“å‡ºæ¥ã€‚æˆ‘ä»¬æŠŠåˆšæ‰çš„ä»£ç æ”¹ä¸€æ”¹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=40a71cd4e349369e7255f173578ec9ae\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::collections::HashMap;\n\nfn main() {\n    let map = HashMap::new();\n    let mut map = explain(\"empty\", map);\n\n    map.insert('a', 1);\n    let mut map = explain(\"added 1\", map);\n    map.insert('b', 2);\n    map.insert('c', 3);\n\n    let mut map = explain(\"added 3\", map);\n\n    map.insert('d', 4);\n\n    let mut map = explain(\"added 4\", map);\n\n    map.remove(&amp;'a');\n\n    explain(\"final\", map);\n}\n\n// HashMap ç»“æ„æœ‰ä¸¤ä¸ª u64 çš„ RandomStateï¼Œç„¶åæ˜¯å››ä¸ª usizeï¼Œ\n// åˆ†åˆ«æ˜¯ bucket_mask, ctrl, growth_left å’Œ items\n// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»\nfn explain&lt;K, V&gt;(name: &amp;str, map: HashMap&lt;K, V&gt;) -&gt; HashMap&lt;K, V&gt; {\n    let arr: [usize; 6] = unsafe { std::mem::transmute(map) };\n    println!(\n        \"{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}\",\n        name, arr[2], arr[3], arr[4], arr[5]\n    );\n    unsafe { std::mem::transmute(arr) }\n}\n</code></pre><p>è¿è¡Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><pre><code class=\"language-rust\">empty: bucket_mask 0x0, ctrl 0x1056df820, growth_left: 0, items: 0\nadded 1: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 2, items: 1\nadded 3: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 0, items: 3\nadded 4: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 3, items: 4\nfinal: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 4, items: 3\n</code></pre><p>æœ‰æ„æ€ï¼Œæˆ‘ä»¬å‘ç°åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œctrl å¯¹åº”çš„å †åœ°å€å‘ç”Ÿäº†æ”¹å˜ã€‚</p><p>åœ¨æˆ‘çš„ OS X ä¸‹ï¼Œä¸€å¼€å§‹å“ˆå¸Œè¡¨ä¸ºç©ºï¼Œctrl åœ°å€çœ‹ä¸Šå»æ˜¯ä¸€ä¸ª TEXT/RODATA æ®µçš„åœ°å€ï¼Œåº”è¯¥æ˜¯æŒ‡å‘äº†ä¸€ä¸ªé»˜è®¤çš„ç©ºè¡¨åœ°å€ï¼›æ’å…¥ç¬¬ä¸€ä¸ªæ•°æ®åï¼Œå“ˆå¸Œè¡¨åˆ†é…äº† 4 ä¸ª bucketï¼Œctrl åœ°å€å‘ç”Ÿæ”¹å˜ï¼›åœ¨æ’å…¥ä¸‰ä¸ªæ•°æ®åï¼Œgrowth_left ä¸ºé›¶ï¼Œå†æ’å…¥æ—¶ï¼Œå“ˆå¸Œè¡¨é‡æ–°åˆ†é…ï¼Œctrl åœ°å€ç»§ç»­æ”¹å˜ã€‚</p><p>åˆšæ‰åœ¨æ¢ç´¢ HashMap æ•°æ®ç»“æ„æ—¶ï¼Œè¯´è¿‡ ctrl æ˜¯ä¸€ä¸ªæŒ‡å‘å“ˆå¸Œè¡¨å †åœ°å€æœ«ç«¯ ctrl åŒºçš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€ï¼Œè®¡ç®—å‡ºå“ˆå¸Œè¡¨å †åœ°å€çš„èµ·å§‹åœ°å€ã€‚</p><p>å› ä¸ºå“ˆå¸Œè¡¨æœ‰ 8 ä¸ª bucketï¼ˆ0x7 + 1ï¼‰ï¼Œæ¯ä¸ª bucket å¤§å°æ˜¯ keyï¼ˆcharï¼‰ + valueï¼ˆi32ï¼‰ çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸€å…±æ˜¯ 64 ä¸ªå­—èŠ‚ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œ<strong>é€šè¿‡ ctrl åœ°å€å‡å» 64ï¼Œå°±å¯ä»¥å¾—åˆ°å“ˆå¸Œè¡¨çš„å †å†…å­˜èµ·å§‹åœ°å€</strong>ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ rust-gdb / rust-lldb æ¥æ‰“å°è¿™ä¸ªå†…å­˜ï¼ˆå¦‚æœä½ å¯¹ rust-gdb / rust-lldb æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹æ–‡æœ«çš„å‚è€ƒé˜…è¯»ï¼‰ã€‚</p><p>è¿™é‡Œæˆ‘ç”¨ Linux ä¸‹çš„ rust-gdb è®¾ç½®æ–­ç‚¹ï¼Œä¾æ¬¡æŸ¥çœ‹å“ˆå¸Œè¡¨æœ‰ä¸€ä¸ªã€ä¸‰ä¸ªã€å››ä¸ªå€¼ï¼Œä»¥åŠåˆ é™¤ä¸€ä¸ªå€¼çš„çŠ¶æ€ï¼š</p><pre><code class=\"language-rust\">â¯ rust-gdb ~/.target/debug/hashmap2\nGNU gdb (Ubuntu 9.2-0ubuntu2) 9.2\n...\n(gdb) b hashmap2.rs:32\nBreakpoint 1 at 0xa43e: file src/hashmap2.rs, line 32.\n(gdb) r\nStarting program: /home/tchen/.target/debug/hashmap2\n...\n# æœ€åˆçš„çŠ¶æ€ï¼Œå“ˆå¸Œè¡¨ä¸ºç©º\nempty: bucket_mask 0x0, ctrl 0x555555597be0, growth_left: 0, items: 0\n\nBreakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32\n32\t    unsafe { std::mem::transmute(arr) }\n(gdb) c\nContinuing.\n# æ’å…¥äº†ä¸€ä¸ªå…ƒç´ åï¼Œbucket æœ‰ 4 ä¸ªï¼ˆ0x3+1ï¼‰ï¼Œå †åœ°å€èµ·å§‹ä½ç½® 0x5555555a7af0 - 4*8(0x20)\nadded 1: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 2, items: 1\n\nBreakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32\n32\t    unsafe { std::mem::transmute(arr) }\n(gdb) x /12x 0x5555555a7ad0\n0x5555555a7ad0:\t0x00000061\t0x00000001\t0x00000000\t0x00000000\n0x5555555a7ae0:\t0x00000000\t0x00000000\t0x00000000\t0x00000000\n0x5555555a7af0:\t0x0affffff\t0xffffffff\t0xffffffff\t0xffffffff\n(gdb) c\nContinuing.\n# æ’å…¥äº†ä¸‰ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ²¡æœ‰å‰©ä½™ç©ºé—´ï¼Œå †åœ°å€èµ·å§‹ä½ç½®ä¸å˜ 0x5555555a7af0 - 4*8(0x20)\nadded 3: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 0, items: 3\n\nBreakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32\n32\t    unsafe { std::mem::transmute(arr) }\n(gdb) x /12x 0x5555555a7ad0\n0x5555555a7ad0:\t0x00000061\t0x00000001\t0x00000062\t0x00000002\n0x5555555a7ae0:\t0x00000000\t0x00000000\t0x00000063\t0x00000003\n0x5555555a7af0:\t0x0a72ff02\t0xffffffff\t0xffffffff\t0xffffffff\n(gdb) c\nContinuing.\n# æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x5555555a7b50 - 8*8(0x40)\nadded 4: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 3, items: 4\n\nBreakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32\n32\t    unsafe { std::mem::transmute(arr) }\n(gdb) x /20x 0x5555555a7b10\n0x5555555a7b10:\t0x00000061\t0x00000001\t0x00000000\t0x00000000\n0x5555555a7b20:\t0x00000064\t0x00000004\t0x00000063\t0x00000003\n0x5555555a7b30:\t0x00000000\t0x00000000\t0x00000062\t0x00000002\n0x5555555a7b40:\t0x00000000\t0x00000000\t0x00000000\t0x00000000\n0x5555555a7b50:\t0xff72ffff\t0x0aff6502\t0xffffffff\t0xffffffff\n(gdb) c\nContinuing.\n# åˆ é™¤ a åï¼Œå‰©ä½™ 4 ä¸ªä½ç½®ã€‚æ³¨æ„ ctrl bit çš„å˜åŒ–ï¼Œä»¥åŠ 0x61 0x1 å¹¶æ²¡æœ‰è¢«æ¸…é™¤\nfinal: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 4, items: 3\n\nBreakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32\n32\t    unsafe { std::mem::transmute(arr) }\n(gdb) x /20x 0x5555555a7b10\n0x5555555a7b10:\t0x00000061\t0x00000001\t0x00000000\t0x00000000\n0x5555555a7b20:\t0x00000064\t0x00000004\t0x00000063\t0x00000003\n0x5555555a7b30:\t0x00000000\t0x00000000\t0x00000062\t0x00000002\n0x5555555a7b40:\t0x00000000\t0x00000000\t0x00000000\t0x00000000\n0x5555555a7b50:\t0xff72ffff\t0xffff6502\t0xffffffff\t0xffffffff\n</code></pre><p>è¿™æ®µè¾“å‡ºè•´è—äº†å¾ˆå¤šä¿¡æ¯ï¼Œæˆ‘ä»¬ç»“åˆç¤ºæ„å›¾æ¥ä»”ç»†æ¢³ç†ã€‚</p><p>é¦–å…ˆï¼Œæ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´  â€˜aâ€™: 1 åï¼Œå“ˆå¸Œè¡¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š<img src=\"https://static001.geekbang.org/resource/image/d1/87/d126ceb74605b168d36bc1e83d4c9e87.jpg?wh=2364x1762\" alt=\"\"></p><p>key â€˜aâ€™ çš„ hash å’Œ bucket_mask 0x3 è¿ç®—åå¾—åˆ°ç¬¬ 0 ä¸ªä½ç½®æ’å…¥ã€‚åŒæ—¶ï¼Œè¿™ä¸ª hash çš„å¤´ 7 ä½å–å‡ºæ¥ï¼Œåœ¨ ctrl è¡¨ä¸­å¯¹åº”çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 0 ä¸ªå­—èŠ‚ï¼ŒæŠŠè¿™ä¸ªå€¼å†™å…¥ã€‚</p><p>è¦ç†è§£è¿™ä¸ªæ­¥éª¤ï¼Œå…³é”®å°±æ˜¯è¦ææ¸…æ¥šè¿™ä¸ª ctrl è¡¨æ˜¯ä»€ä¹ˆã€‚</p><h3>ctrl è¡¨</h3><p>ctrl è¡¨çš„ä¸»è¦ç›®çš„æ˜¯å¿«é€ŸæŸ¥æ‰¾ã€‚å®ƒçš„è®¾è®¡éå¸¸ä¼˜é›…ï¼Œå€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p><p>ä¸€å¼  ctrl è¡¨é‡Œï¼Œæœ‰è‹¥å¹²ä¸ª 128bit æˆ–è€…è¯´ 16 ä¸ªå­—èŠ‚çš„åˆ†ç»„ï¼ˆgroupï¼‰ï¼Œgroup é‡Œçš„æ¯ä¸ªå­—èŠ‚å« ctrl byteï¼Œå¯¹åº”ä¸€ä¸ª bucketï¼Œé‚£ä¹ˆä¸€ä¸ª group å¯¹åº” 16 ä¸ª bucketã€‚å¦‚æœä¸€ä¸ª bucket å¯¹åº”çš„ ctrl byte é¦–ä½ä¸ä¸º 1ï¼Œå°±è¡¨ç¤ºè¿™ä¸ª ctrl byte è¢«ä½¿ç”¨ï¼›å¦‚æœæ‰€æœ‰ä½éƒ½æ˜¯ 1ï¼Œæˆ–è€…è¯´è¿™ä¸ªå­—èŠ‚æ˜¯ 0xffï¼Œé‚£ä¹ˆå®ƒæ˜¯ç©ºé—²çš„ã€‚</p><p>ä¸€ç»„ control byte çš„æ•´ä¸ª 128 bit çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¢«åŠ è½½è¿›æ¥ï¼Œç„¶åå’ŒæŸä¸ªå€¼è¿›è¡Œ maskï¼Œæ‰¾åˆ°å®ƒæ‰€åœ¨çš„ä½ç½®ã€‚è¿™å°±æ˜¯ä¸€å¼€å§‹æåˆ°çš„<strong>SIMD æŸ¥è¡¨</strong>ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œç°ä»£ CPU éƒ½æ”¯æŒå•æŒ‡ä»¤å¤šæ•°æ®é›†çš„æ“ä½œï¼Œè€ŒRust å……åˆ†åˆ©ç”¨äº† CPU è¿™ç§èƒ½åŠ›ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥è®©å¤šä¸ªç›¸å…³çš„æ•°æ®è½½å…¥åˆ°ç¼“å­˜ä¸­å¤„ç†ï¼Œå¤§å¤§åŠ å¿«æŸ¥è¡¨çš„é€Ÿåº¦ã€‚æ‰€ä»¥ï¼ŒRust çš„å“ˆå¸Œè¡¨æŸ¥è¯¢çš„æ•ˆç‡éå¸¸é«˜ã€‚</p><p>å…·ä½“æ€ä¹ˆæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ HashMap æ˜¯å¦‚ä½•é€šè¿‡ ctrl è¡¨æ¥è¿›è¡Œæ•°æ®æŸ¥è¯¢çš„ã€‚å‡è®¾è¿™å¼ è¡¨é‡Œå·²ç»æ·»åŠ äº†ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬ç°åœ¨è¦æŸ¥æ‰¾ key ä¸º â€˜câ€™ çš„æ•°æ®ï¼š</p><ol>\n<li>é¦–å…ˆå¯¹ â€˜câ€™ åšå“ˆå¸Œï¼Œå¾—åˆ°ä¸€ä¸ªå“ˆå¸Œå€¼ hï¼›</li>\n<li>æŠŠ h è·Ÿ bucket_mask åšä¸ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ï¼Œå›¾ä¸­æ˜¯ 139ï¼›</li>\n<li>æ‹¿ç€è¿™ä¸ª 139ï¼Œæ‰¾åˆ°å¯¹åº”çš„ ctrl group çš„èµ·å§‹ä½ç½®ï¼Œå› ä¸º ctrl group ä»¥ 16 ä¸ºä¸€ç»„ï¼Œæ‰€ä»¥è¿™é‡Œæ‰¾åˆ° 128ï¼›</li>\n<li>ç”¨ SIMD æŒ‡ä»¤åŠ è½½ä» 128 å¯¹åº”åœ°å€å¼€å§‹çš„ 16 ä¸ªå­—èŠ‚ï¼›</li>\n<li>å¯¹ hash å–å¤´ 7 ä¸ª bitï¼Œç„¶åå’Œåˆšåˆšå–å‡ºçš„ 16 ä¸ªå­—èŠ‚ä¸€èµ·åšä¸ï¼Œæ‰¾åˆ°å¯¹åº”çš„åŒ¹é…ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå®ƒï¼ˆä»¬ï¼‰å¾ˆå¤§æ¦‚ç‡æ˜¯è¦æ‰¾çš„å€¼ï¼›</li>\n<li>å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆä»¥äºŒæ¬¡æ¢æŸ¥ï¼ˆä»¥ 16 çš„å€æ•°ä¸æ–­ç´¯ç§¯ï¼‰çš„æ–¹å¼å¾€åæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚</li>\n</ol><p>ä½ å¯ä»¥ç»“åˆä¸‹å›¾ç†è§£è¿™ä¸ªç®—æ³•ï¼š<img src=\"https://static001.geekbang.org/resource/image/d2/60/d2a3cc569c9a9b0728a659c030eb6560.jpg?wh=2364x1762\" alt=\"\"></p><p>æ‰€ä»¥ï¼Œå½“ HashMap æ’å…¥å’Œåˆ é™¤æ•°æ®ï¼Œä»¥åŠå› æ­¤å¯¼è‡´é‡æ–°åˆ†é…çš„æ—¶å€™ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯åœ¨ç»´æŠ¤è¿™å¼  ctrl è¡¨å’Œæ•°æ®çš„å¯¹åº”ã€‚</p><p>å› ä¸º ctrl è¡¨æ˜¯æ‰€æœ‰æ“ä½œæœ€å…ˆè§¦åŠçš„å†…å­˜ï¼Œæ‰€ä»¥ï¼Œåœ¨ HashMap çš„ç»“æ„ä¸­ï¼Œ<strong>å †å†…å­˜çš„æŒ‡é’ˆç›´æ¥æŒ‡å‘ ctrl è¡¨</strong>ï¼Œè€Œä¸æ˜¯æŒ‡å‘å †å†…å­˜çš„èµ·å§‹ä½ç½®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜çš„è®¿é—®ã€‚</p><h3>å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿</h3><p>å¥½ï¼Œå›åˆ°åˆšæ‰è®²çš„å†…å­˜å¸ƒå±€ç»§ç»­è¯´ã€‚åœ¨æ’å…¥ç¬¬ä¸€æ¡æ•°æ®åï¼Œæˆ‘ä»¬çš„å“ˆå¸Œè¡¨åªæœ‰ 4 ä¸ª bucketï¼Œæ‰€ä»¥åªæœ‰å¤´ 4 ä¸ªå­—èŠ‚çš„ ctrl è¡¨æœ‰ç”¨ã€‚éšç€å“ˆå¸Œè¡¨çš„å¢é•¿ï¼Œbucket ä¸å¤Ÿï¼Œå°±ä¼šå¯¼è‡´é‡æ–°åˆ†é…ã€‚ç”±äº bucket_mask æ°¸è¿œæ¯” bucket æ•°é‡å°‘ 1ï¼Œæ‰€ä»¥æ’å…¥ä¸‰ä¸ªå…ƒç´ åå°±ä¼šé‡æ–°åˆ†é…ã€‚</p><p>æ ¹æ® rust-gdb ä¸­å¾—åˆ°çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çœ‹æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨ï¼Œåœ¨åŠ å…¥ â€˜dâ€™: 4 æ—¶ï¼Œæ˜¯å¦‚ä½•å¢é•¿çš„ã€‚</p><p>é¦–å…ˆï¼Œ<strong>å“ˆå¸Œè¡¨ä¼šæŒ‰å¹‚æ‰©å®¹</strong>ï¼Œä» 4 ä¸ª bucket æ‰©å±•åˆ° 8 ä¸ª bucketã€‚</p><p>è¿™ä¼šå¯¼è‡´åˆ†é…æ–°çš„å †å†…å­˜ï¼Œç„¶ååŸæ¥çš„ ctrl table å’Œå¯¹åº”çš„kvæ•°æ®ä¼šè¢«ç§»åŠ¨åˆ°æ–°çš„å†…å­˜ä¸­ã€‚è¿™ä¸ªä¾‹å­é‡Œå› ä¸º char å’Œ i32 å®ç°äº† Copy traitï¼Œæ‰€ä»¥æ˜¯æ‹·è´ï¼›å¦‚æœ key çš„ç±»å‹æ˜¯ Stringï¼Œé‚£ä¹ˆåªæœ‰ String çš„ 24 ä¸ªå­—èŠ‚ (ptr|cap|len) çš„ç»“æ„è¢«ç§»åŠ¨ï¼ŒString çš„å®é™…å†…å­˜ä¸éœ€è¦å˜åŠ¨ã€‚</p><p>åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠ<strong>å“ˆå¸Œçš„é‡åˆ†é…</strong>ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œâ€˜aâ€™ / â€˜câ€™ çš„ç›¸å¯¹ä½ç½®å’Œå®ƒä»¬çš„ ctrl byte æ²¡æœ‰å˜åŒ–ï¼Œä½†é‡æ–°åš hash åï¼Œâ€˜bâ€™ çš„ ctrl byte å’Œä½ç½®éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/ec/e0/ec62494f0c576f932c9716195a1ba6e0.jpg?wh=2364x1762\" alt=\"\"></p><h3>åˆ é™¤ä¸€ä¸ªå€¼</h3><p>æ˜ç™½äº†å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•å¢é•¿çš„ï¼Œæˆ‘ä»¬å†æ¥çœ‹åˆ é™¤çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p><p>å½“è¦åœ¨å“ˆå¸Œè¡¨ä¸­åˆ é™¤ä¸€ä¸ªå€¼æ—¶ï¼Œæ•´ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ç±»ä¼¼ï¼Œå…ˆè¦æ‰¾åˆ°è¦è¢«åˆ é™¤çš„ key æ‰€åœ¨çš„ä½ç½®ã€‚åœ¨æ‰¾åˆ°å…·ä½“ä½ç½®åï¼Œ<strong>å¹¶ä¸éœ€è¦å®é™…æ¸…é™¤å†…å­˜ï¼Œåªéœ€è¦å°†å®ƒçš„ ctrl byte è®¾å› 0xff</strong>ï¼ˆæˆ–è€…æ ‡è®°æˆåˆ é™¤çŠ¶æ€ï¼‰ã€‚è¿™æ ·ï¼Œè¿™ä¸ª bucket å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨äº†ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/82/9e/828f746528039b15b8601ee6f8cdd79e.jpg?wh=2364x1762\" alt=\"\"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“ key/value æœ‰é¢å¤–çš„å†…å­˜æ—¶ï¼Œæ¯”å¦‚ Stringï¼Œå®ƒçš„å†…å­˜ä¸ä¼šç«‹å³å›æ”¶ï¼Œåªæœ‰åœ¨ä¸‹ä¸€æ¬¡å¯¹åº”çš„ bucket è¢«ä½¿ç”¨æ—¶ï¼Œè®© HashMap ä¸å†æ‹¥æœ‰è¿™ä¸ª String çš„æ‰€æœ‰æƒä¹‹åï¼Œè¿™ä¸ª String çš„å†…å­˜æ‰è¢«å›æ”¶ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢çš„ç¤ºæ„å›¾ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/0d/4d/0d191c99c4201bb88fb5a11d70a9434d.jpg?wh=2364x1304\" alt=\"\"></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™å¹¶ä¸ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Œé¡¶å¤šæ˜¯å†…å­˜å ç”¨ç‡ç¨é«˜ä¸€äº›ã€‚ä½†æŸäº›æç«¯æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åœ¨å“ˆå¸Œè¡¨ä¸­æ·»åŠ å¤§é‡å†…å®¹ï¼Œåˆåˆ é™¤å¤§é‡å†…å®¹åè¿è¡Œï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡ shrink_to_fit / shrink_to é‡Šæ”¾æ‰ä¸éœ€è¦çš„å†…å­˜ã€‚</p><h3>è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš Hash key</h3><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„æˆä¸º HashMap çš„ keyã€‚æ­¤æ—¶ï¼Œè¦ä½¿ç”¨åˆ°ä¸‰ä¸ª traitï¼š<a href=\"https://doc.rust-lang.org/std/hash/trait.Hash.html\">Hash</a>ã€<a href=\"https://doc.rust-lang.org/std/cmp/trait.PartialEq.html\">PartialEq</a>ã€<a href=\"https://doc.rust-lang.org/std/cmp/trait.Eq.html\">Eq</a>ï¼Œä¸è¿‡è¿™ä¸‰ä¸ª trait éƒ½å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨ç”Ÿæˆã€‚å…¶ä¸­ï¼š</p><ul>\n<li>å®ç°äº† Hash ï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è®¡ç®—å“ˆå¸Œï¼›</li>\n<li>å®ç°äº† PartialEq/Eqï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è¿›è¡Œç›¸ç­‰å’Œä¸ç›¸ç­‰çš„æ¯”è¾ƒã€‚Eq å®ç°äº†æ¯”è¾ƒçš„è‡ªåæ€§ï¼ˆa == aï¼‰ã€å¯¹ç§°æ€§ï¼ˆa == b åˆ™ b == aï¼‰ä»¥åŠä¼ é€’æ€§ï¼ˆa == bï¼Œb == cï¼Œåˆ™ a == cï¼‰ï¼ŒPartialEq æ²¡æœ‰å®ç°è‡ªåæ€§ã€‚</li>\n</ul><p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªä¾‹å­ï¼Œçœ‹çœ‹è‡ªå®šä¹‰æ•°æ®ç»“æ„å¦‚ä½•æ”¯æŒ HashMapï¼š</p><pre><code class=\"language-rust\">use std::{\n    collections::{hash_map::DefaultHasher, HashMap},\n    hash::{Hash, Hasher},\n};\n\n// å¦‚æœè¦æ”¯æŒ Hashï¼Œå¯ä»¥ç”¨ #[derive(Hash)]ï¼Œå‰ææ˜¯æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Hash\n// å¦‚æœè¦èƒ½ä½œä¸º HashMap çš„ keyï¼Œè¿˜éœ€è¦ PartialEq å’Œ Eq\n#[derive(Debug, Hash, PartialEq, Eq)]\nstruct Student&lt;'a&gt; {\n    name: &amp;'a str,\n    age: u8,\n}\n\nimpl&lt;'a&gt; Student&lt;'a&gt; {\n    pub fn new(name: &amp;'a str, age: u8) -&gt; Self {\n        Self { name, age }\n    }\n}\nfn main() {\n    let mut hasher = DefaultHasher::new();\n    let student = Student::new(\"Tyr\", 18);\n    // å®ç°äº† Hash çš„æ•°æ®ç»“æ„å¯ä»¥ç›´æ¥è°ƒç”¨ hash æ–¹æ³•\n    student.hash(&amp;mut hasher);\n    let mut map = HashMap::new();\n    // å®ç°äº† Hash / PartialEq / Eq çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º HashMap çš„ key\n    map.insert(student, vec![\"Math\", \"Writing\"]);\n    println!(\"hash: 0x{:x}, map: {:?}\", hasher.finish(), map);\n}\n</code></pre><h2>HashSet / BTreeMap / BTreeSet</h2><p>æœ€åæˆ‘ä»¬ç®€å•è®²è®²å’Œ HashMap ç›¸å…³çš„å…¶å®ƒå‡ ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>æœ‰æ—¶æˆ‘ä»¬åªéœ€è¦ç®€å•ç¡®è®¤å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœç”¨ HashMap å°±æœ‰äº›æµªè´¹ç©ºé—´äº†ã€‚è¿™æ—¶å¯ä»¥ç”¨HashSetï¼Œå®ƒå°±æ˜¯ç®€åŒ–çš„ HashMapï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ— åºçš„é›†åˆï¼Œå®šä¹‰ç›´æ¥æ˜¯ HashMap&lt;K, ()&gt;ï¼š</p><pre><code class=\"language-rust\">use hashbrown::hash_set as base;\n\npub struct HashSet&lt;T, S = RandomState&gt; {\n    base: base::HashSet&lt;T, S&gt;,\n}\n\npub struct HashSet&lt;T, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; {\n    pub(crate) map: HashMap&lt;T, (), S, A&gt;,\n}\n</code></pre><p>ä½¿ç”¨ HashSet æŸ¥çœ‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºé›†åˆçš„æ•ˆç‡éå¸¸é«˜ã€‚</p><p>å¦ä¸€ä¸ªå’Œ HashMap ä¸€æ ·å¸¸ç”¨çš„æ•°æ®ç»“æ„å°±æ˜¯BTreeMapäº†ã€‚BTreeMap æ˜¯å†…éƒ¨ä½¿ç”¨ <a href=\"https://en.wikipedia.org/wiki/B-tree\">B-tree</a> æ¥ç»„ç»‡å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ã€‚å¦å¤– BTreeSet å’Œ HashSet ç±»ä¼¼ï¼Œæ˜¯ BTreeMap çš„ç®€åŒ–ç‰ˆï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æœ‰åºé›†åˆã€‚</p><p>æˆ‘ä»¬è¿™é‡Œé‡ç‚¹çœ‹ä¸‹BTreeMapï¼Œå®ƒçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub struct BTreeMap&lt;K, V&gt; {\n    root: Option&lt;Root&lt;K, V&gt;&gt;,\n    length: usize,\n}\n\npub type Root&lt;K, V&gt; = NodeRef&lt;marker::Owned, K, V, marker::LeafOrInternal&gt;;\n\npub struct NodeRef&lt;BorrowType, K, V, Type&gt; {\n    height: usize,\n    node: NonNull&lt;LeafNode&lt;K, V&gt;&gt;,\n    _marker: PhantomData&lt;(BorrowType, Type)&gt;,\n}\n\nstruct LeafNode&lt;K, V&gt; {\n    parent: Option&lt;NonNull&lt;InternalNode&lt;K, V&gt;&gt;&gt;,\n    parent_idx: MaybeUninit&lt;u16&gt;,\n    len: u16,\n    keys: [MaybeUninit&lt;K&gt;; CAPACITY],\n    vals: [MaybeUninit&lt;V&gt;; CAPACITY],\n}\n\nstruct InternalNode&lt;K, V&gt; {\n    data: LeafNode&lt;K, V&gt;,\n    edges: [MaybeUninit&lt;BoxedNode&lt;K, V&gt;&gt;; 2 * B],\n}\n</code></pre><p>å’Œ HashMap ä¸åŒçš„æ˜¯ï¼ŒBTreeMap æ˜¯æœ‰åºçš„ã€‚æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=711b0bd9ac7dbdd882c4b84809212778\">ä»£ç </a>ï¼‰:</p><pre><code class=\"language-rust\">use std::collections::BTreeMap;\n\nfn main() {\n    let map = BTreeMap::new();\n    let mut map = explain(\"empty\", map);\n\n    for i in 0..16usize {\n        map.insert(format!(\"Tyr {}\", i), i);\n    }\n\n    let mut map = explain(\"added\", map);\n\n    map.remove(\"Tyr 1\");\n\n    let map = explain(\"remove 1\", map);\n\n    for item in map.iter() {\n        println!(\"{:?}\", item);\n    }\n}\n\n// BTreeMap ç»“æ„æœ‰ heightï¼Œnode å’Œ length\n// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»\nfn explain&lt;K, V&gt;(name: &amp;str, map: BTreeMap&lt;K, V&gt;) -&gt; BTreeMap&lt;K, V&gt; {\n    let arr: [usize; 3] = unsafe { std::mem::transmute(map) };\n    println!(\n        \"{}: height: {}, root node: 0x{:x}, len: 0x{:x}\",\n        name, arr[0], arr[1], arr[2]\n    );\n    unsafe { std::mem::transmute(arr) }\n}\n</code></pre><p>å®ƒçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">empty: height: 0, root node: 0x0, len: 0x0\nadded: height: 1, root node: 0x7f8286406190, len: 0x10\nremove 1: height: 1, root node: 0x7f8286406190, len: 0xf\n(\"Tyr 0\", 0)\n(\"Tyr 10\", 10)\n(\"Tyr 11\", 11)\n(\"Tyr 12\", 12)\n(\"Tyr 13\", 13)\n(\"Tyr 14\", 14)\n(\"Tyr 15\", 15)\n(\"Tyr 2\", 2)\n(\"Tyr 3\", 3)\n(\"Tyr 4\", 4)\n(\"Tyr 5\", 5)\n(\"Tyr 6\", 6)\n(\"Tyr 7\", 7)\n(\"Tyr 8\", 8)\n(\"Tyr 9\", 9)\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨éå†æ—¶ï¼ŒBTreeMap ä¼šæŒ‰ç…§ key çš„é¡ºåºæŠŠå€¼æ‰“å°å‡ºæ¥ã€‚å¦‚æœä½ æƒ³è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º BTreeMap çš„ keyï¼Œé‚£ä¹ˆéœ€è¦å®ç° <a href=\"https://doc.rust-lang.org/std/cmp/trait.PartialOrd.html\">PartialOrd</a> å’Œ <a href=\"https://doc.rust-lang.org/std/cmp/trait.Ord.html\">Ord</a>ï¼Œè¿™ä¸¤è€…çš„å…³ç³»å’Œ PartialEq / Eq ç±»ä¼¼ï¼ŒPartialOrd ä¹Ÿæ²¡æœ‰å®ç°è‡ªåæ€§ã€‚åŒæ ·çš„ï¼ŒPartialOrd å’Œ Ord ä¹Ÿå¯ä»¥é€šè¿‡æ´¾ç”Ÿå®æ¥å®ç°ã€‚</p><h2>å°ç»“</h2><p>åœ¨å­¦ä¹ æ•°æ®ç»“æ„çš„æ—¶å€™ï¼Œå¸¸ç”¨æ•°æ®ç»“æ„çš„å†…å­˜å¸ƒå±€å’ŒåŸºæœ¬ç®—æ³•ä½ ä¸€å®šè¦ç†è§£æ¸…æ¥šï¼Œå¯¹å®ƒåœ¨ä¸åŒæƒ…å†µä¸‹å¦‚ä½•å¢é•¿ï¼Œä¹Ÿè¦å°½é‡åšåˆ°å¿ƒé‡Œæœ‰æ•°ã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬èŠ±å¤§ç²¾åŠ›è¯¦ç»†å­¦ä¹ äº† HashMap çš„æ•°æ®ç»“æ„ä»¥åŠç®—æ³•çš„åŸºæœ¬æ€è·¯ï¼Œç®—æ˜¯æŠ›ç –å¼•ç‰ã€‚è¿™é—¨è¯¾æ— è®ºå¤šæ·±å…¥è®²è§£ï¼Œä¹Ÿåªèƒ½è§¦åŠ Rust æ•´ä¸ªç”Ÿæ€åœˆçš„ä¹ç‰›ä¸€æ¯›ï¼Œä¸å¯èƒ½é¢é¢ä¿±åˆ°ã€‚</p><p>æˆ‘çš„åŸåˆ™æ˜¯â€œæˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”â€ï¼Œåœ¨ä½ æŒæ¡è¿™æ ·çš„åˆ†ææ–¹æ³•åï¼Œä»¥åé‡åˆ°æ ‡å‡†åº“æˆ–è€…ç¬¬ä¸‰æ–¹åº“çš„å…¶å®ƒçš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•æ·±å…¥æ¢ç´¢å­¦ä¹ ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬ç¨‹åºå‘˜å­¦ä¸œè¥¿ï¼Œ<strong>ä¼šç”¨æ˜¯ç¬¬ä¸€å±‚ï¼ŒçŸ¥é“å®ƒæ˜¯å¦‚ä½•è®¾è®¡çš„æ˜¯ç¬¬äºŒå±‚ï¼Œèƒ½å¤Ÿè‡ªå·±å†™å‡ºæ¥æ‰æ˜¯ç¬¬ä¸‰å±‚</strong>ã€‚Rustå€Ÿé‰´çš„ Google Swiss table ç®—æ³•ç®€å•ç²¾å·§ï¼Œè™½ç„¶ hashbrown åœ¨å®ç°æ—¶ï¼Œä¸ºäº†æœ€å¤§åŒ–æ€§èƒ½å’Œåˆ©ç”¨ SSE æŒ‡ä»¤é›†ï¼Œä½¿ç”¨äº†å¾ˆå¤š unsafe ä»£ç ï¼Œä½†æˆ‘ä»¬æ’°å†™ä¸€ä¸ªæ€§èƒ½ä¸é‚£ä¹ˆå¥½çš„ safe ç‰ˆæœ¬ï¼Œå¹¶ä¸æ˜¯å¤æ‚çš„äº‹æƒ…ï¼Œéå¸¸æ¨èä½ å®ç°ä¸€ä¸‹ã€‚</p><p>é›†åˆç±»å‹æˆ‘ä»¬å°±æš‚æ—¶è®²è§£åˆ°è¿™é‡Œï¼Œæœªæ¥å®æˆ˜è¦ä½¿ç”¨åˆ°æŸäº›æ•°æ®ç»“æ„æ—¶ï¼Œæ¯”å¦‚ VecDequeï¼Œæˆ‘ä»¬å†æ·±å…¥æ¢ç´¢ã€‚å…¶ä»–çš„é›†åˆç±»å‹ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¦ç”¨çš„æ—¶å€™è‡ªè¡Œé˜…è¯»<a href=\"https://doc.rust-lang.org/std/collections/index.html\">æ–‡æ¡£</a>ã€‚</p><p>å¦‚æœä½ æƒ³äº†è§£è¿™ä¸¤è®²ä¸­é›†åˆç±»å‹çš„æ—¶é—´å¤æ‚åº¦ï¼Œå¯ä»¥çœ‹ä¸‹è¡¨ï¼ˆ<a href=\"https://doc.rust-lang.org/std/collections/index.html#performance\">æ¥æº</a>ï¼‰ï¼š<img src=\"https://static001.geekbang.org/resource/image/60/2f/60733157bd6e6171a7fee22981469b2f.jpg?wh=2364x1304\" alt=\"\"></p><h3>æ€è€ƒé¢˜</h3><p>1.ä¿®æ”¹ä¸‹é¢ä»£ç çš„é”™è¯¯ï¼Œä½¿å…¶ç¼–è¯‘é€šè¿‡ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c29bbe5c06183eec0892101298dfc510\">ä»£ç </a>ï¼‰ã€‚</p><pre><code class=\"language-rust\">use std::collections::BTreeMap;\n\n#[derive(Debug)]\nstruct Name {\n&nbsp; &nbsp; pub name: String,\n&nbsp; &nbsp; pub flags: u32,\n}\n\nimpl Name {\n&nbsp; &nbsp; pub fn new(name: impl AsRef&lt;str&gt;, flags: u32) -&gt; Self {\n&nbsp; &nbsp; &nbsp; &nbsp; Self {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name: name.as_ref().to_string(),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flags,\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n\nfn main() {\n&nbsp; &nbsp; let mut map = BTreeMap::new();\n&nbsp; &nbsp; map.insert(Name::new(\"/etc/password\", 0x1), 12);\n&nbsp; &nbsp; map.insert(Name::new(\"/etc/hosts\", 0x1), 4);\n&nbsp; &nbsp; map.insert(Name::new(\"/home/tchen\", 0x0), 28);\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; for item in map.iter() {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"{:?}\", item);\n&nbsp; &nbsp; }\n}\n\n</code></pre><p>2.æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ª session è¡¨çš„ key æ˜¯ (Source IPã€Source Portã€Dst IPã€Dst Portã€Proto) è¿™æ ·çš„é•¿åº¦ 15 ä¸ªå­—èŠ‚çš„äº”å…ƒç»„ï¼Œvalue æ˜¯ 200 å­—èŠ‚çš„ Session ç»“æ„ï¼Œè¦å®¹çº³ 1200000 ä¸ª Sessionï¼Œæ•´ä¸ªå“ˆå¸Œè¡¨è¦å å¤šå¤§çš„å †å†…å­˜ï¼Ÿå†…å­˜çš„åˆ©ç”¨ç‡å¦‚ä½•ï¼Ÿ</p><p>3.ä½¿ç”¨æ–‡ä¸­åŒæ ·çš„æ–¹å¼ï¼Œç»“åˆ rust-gdb / rust-lldb æ¢ç´¢ BTreeMapã€‚ä½ èƒ½ç”»å‡ºæ¥åœ¨æ’å…¥ä»¥ 26 ä¸ªå­—æ¯ä¸º keyï¼Œ1ï½26 ä¸º value åçš„ BTreeMap çš„å†…å­˜å¸ƒå±€ä¹ˆï¼Ÿ</p><p>ä»Šå¤©ä½ å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬17æ¬¡æ‰“å¡ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p><h3>å‚è€ƒèµ„æ–™</h3><p>1.ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨åœ¨è½¯ä»¶ç³»ç»Ÿä¸­çš„é‡è¦åœ°ä½ï¼Œä½†å“ˆå¸Œè¡¨åœ¨æœ€åæƒ…å†µä¸‹ï¼Œå¦‚æœç»å¤§å¤šæ•° key çš„ hash éƒ½ç¢°æ’åœ¨ä¸€èµ·ï¼Œæ€§èƒ½ä¼šåˆ° O(n)ï¼Œè¿™ä¼šæå¤§æ‹–ç´¯ç³»ç»Ÿçš„æ•ˆç‡ã€‚</p><p>æ¯”å¦‚ 1M å¤§å°çš„ session è¡¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹æŸ¥è¡¨é€Ÿåº¦æ˜¯ O(1)ï¼Œä½†æç«¯æƒ…å†µä¸‹ï¼Œéœ€è¦æ¯”è¾ƒ 1M ä¸ªæ•°æ®åæ‰èƒ½æ‰¾åˆ°ï¼Œè¿™æ ·çš„ç³»ç»Ÿå°±å®¹æ˜“è¢« DoS æ”»å‡»ã€‚æ‰€ä»¥å¦‚æœä¸æ˜¯åŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼Œåªè¦é»‘å®¢çŸ¥é“å“ˆå¸Œç®—æ³•ï¼Œå°±å¯ä»¥æ„é€ å‡ºå¤§é‡çš„ key äº§ç”Ÿè¶³å¤Ÿå¤šçš„å“ˆå¸Œç¢°æ’ï¼Œé€ æˆç›®æ ‡ç³»ç»Ÿ DoSã€‚</p><p><a href=\"https://en.wikipedia.org/wiki/SipHash\">SipHash</a> å°±æ˜¯ä¸ºäº†å›åº” DoS æ”»å‡»è€Œåˆ›å»ºçš„å“ˆå¸Œç®—æ³•ï¼Œè™½ç„¶å’Œ sha2 è¿™æ ·çš„åŠ å¯†å“ˆå¸Œä¸åŒï¼ˆä¸è¦å°† SipHash ç”¨äºåŠ å¯†ï¼ï¼‰ï¼Œä½†å®ƒå¯ä»¥æä¾›ç±»ä¼¼ç­‰çº§çš„å®‰å…¨æ€§ã€‚æŠŠ SipHash ä½œä¸º HashMap çš„ç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼ŒRust å¯ä»¥é¿å…å¼€å‘è€…åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¢« DoSï¼Œå°±åƒæ›¾ç»åœ¨ <a href=\"https://arstechnica.com/information-technology/2011/12/huge-portions-of-web-vulnerable-to-hashing-denial-of-service-attack/\">Web ä¸–ç•Œ</a>å‘ç”Ÿçš„é‚£æ ·ã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸€åˆ‡çš„ä»£ä»·æ˜¯æ€§èƒ½æŸè€—ï¼Œè™½ç„¶ SipHash éå¸¸å¿«ï¼Œä½†å®ƒæ¯” hashbrown ç¼ºçœä½¿ç”¨çš„ <a href=\"https://github.com/tkaitchuck/aHash\">Ahash</a> æ…¢äº†ä¸å°‘ã€‚å¦‚æœä½ ç¡®å®šä½¿ç”¨çš„ HashMap ä¸éœ€è¦ DoS é˜²æŠ¤ï¼ˆæ¯”å¦‚ä¸€ä¸ªå®Œå…¨å†…éƒ¨ä½¿ç”¨çš„ HashMapï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ Ahash æ¥æ›¿æ¢ã€‚ä½ åªéœ€è¦ä½¿ç”¨ Ahash æä¾›çš„ RandomState å³å¯ï¼š</p><pre><code class=\"language-rust\">use ahash::{AHasher, RandomState};\nuse std::collections::HashMap;\nlet mut map: HashMap&lt;char, i32, RandomState&gt; = HashMap::default();\nmap.insert('a', 1);\n</code></pre><p>2.å¦‚ä½•ä½¿ç”¨ rust-gdb / rust-lldbï¼Ÿ</p><p>ä¹‹å‰çš„æ„šæ˜§ä¹‹å·…<a href=\"https://time.geekbang.org/column/article/418778\">åŠ é¤</a>æè¿‡ <a href=\"https://www.gnu.org/software/gdb/\">gdb</a> / <a href=\"https://lldb.llvm.org/\">lldb</a> ï¼Œä»Šå¤©å°±æ˜¯ä½¿ç”¨ç¤ºä¾‹ã€‚æ²¡æœ‰ä½¿ç”¨è¿‡çš„æœ‹å‹ï¼Œå¯ä»¥çœ‹çœ‹å®ƒä»¬çš„æ–‡æ¡£äº†è§£ä¸€ä¸‹ã€‚</p><p>gdb é€‚åˆåœ¨ Linux ä¸‹ï¼Œlldb å¯ä»¥åœ¨ OS X ä¸‹è°ƒè¯• Rust ç¨‹åºã€‚<a href=\"https://github.com/rust-lang/rust/blob/master/src/etc/rust-gdb\">rust-gdb</a> / <a href=\"https://github.com/rust-lang/rust/blob/master/src/etc/rust-lldb\">rust-lldb</a> æä¾›äº†ä¸€äº›å¯¹ Rust æ›´å‹å¥½çš„ pretty-print åŠŸèƒ½ï¼Œåœ¨å®‰è£… Rust æ—¶ï¼Œå®ƒä»¬ä¹Ÿä¼šè¢«å®‰è£…ã€‚ä½¿ç”¨è¿‡ gdb çš„åŒå­¦ï¼Œå¯ä»¥çœ‹ <a href=\"https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf\">gdb é€ŸæŸ¥æ‰‹å†Œ</a>ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹ <a href=\"https://lldb.llvm.org/use/map.html\">gdb/lldb å‘½ä»¤å¯¹åº”æ‰‹å†Œ</a>ã€‚</p><p>æˆ‘ä¸€èˆ¬ä¸ç”¨å®ƒä»¬è°ƒè¯•ç¨‹åºã€‚<strong>ä¸ç®¡ä»»ä½•è¯­è¨€ï¼Œå¦‚æœå¼€å‘æ—¶ï¼Œä½ å‘ç°è‡ªå·±æ€»åœ¨è®¾ç½®æ–­ç‚¹è°ƒè¯•ç¨‹åºï¼Œè¯´æ˜ä½ æ’°å†™ä»£ç çš„æ–¹å¼æœ‰é—®é¢˜</strong>ã€‚è¦ä¹ˆï¼Œæ²¡æœ‰æŠŠæ¥å£å’Œç®—æ³•è®¾è®¡æ¸…æ¥šï¼Œæƒ³åˆ°å“ªå†™åˆ°å“ªï¼›è¦ä¹ˆï¼Œæ˜¯ä½ çš„å‡½æ•°å†™å¾—è¿‡äºå¤æ‚ï¼Œå¤ªå¤šçŠ¶æ€çº ç¼ ï¼Œæ²¡æœ‰éµå¾ª SRPï¼ˆSingle Responsibility Principleï¼‰ã€‚</p><p><strong>å¥½çš„ä»£ç æ˜¯å†™å‡ºæ¥çš„ï¼Œä¸æ˜¯è°ƒå‡ºæ¥çš„ã€‚ä¸å…¶æŠŠæ—¶é—´èŠ±åœ¨è°ƒè¯•ä¸Šï¼Œä¸å¦‚æŠŠæ—¶é—´èŠ±åœ¨è®¾è®¡ã€æ—¥å¿—ï¼Œä»¥åŠå•å…ƒæµ‹è¯•ä¸Š</strong>ã€‚æ‰€ä»¥ï¼Œgdb/lldb å¯¹æˆ‘æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªç†è§£æ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­å¸ƒå±€ä»¥åŠæ¢ç´¢ç®—æ³•å¦‚ä½•è¿è¡Œçš„å·¥å…·ã€‚ä½ å¯ä»¥ä»”ç»†é˜…è¯»æ–‡ä¸­å±•ç¤ºçš„ gdb session å’Œä¸ä¹‹ç›¸å…³çš„ä»£ç ï¼Œçœ‹çœ‹å¦‚ä½•æ„é€ ä»£ç æ¥ç»“åˆ gdb æ¢ç´¢ HashMap åœ¨ä¸åŒçŠ¶æ€ä¸‹çš„è¡Œä¸ºã€‚</p><p>å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€TAä¸€èµ·è®¨è®ºï½</p>","neighbors":{"left":{"article_title":"16ï½œæ•°æ®ç»“æ„ï¼šVec<T>ã€&[T]ã€Box<[T]> ï¼Œä½ çœŸçš„äº†è§£é›†åˆå®¹å™¨ä¹ˆï¼Ÿ","id":422975},"right":{"article_title":"18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ","id":424002}},"comments":[{"had_liked":false,"id":314815,"user_name":"Geek_5244fa","can_delete":false,"product_type":"c1","uid":1072743,"ip_address":"","ucode":"B87A550526F74C","user_header":"https://static001.geekbang.org/account/avatar/00/10/5e/67/133d2da6.jpg","comment_is_top":false,"comment_ctime":1633448830,"is_pvip":true,"replies":[{"id":"114173","content":"èµï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633813565,"ip_address":"","comment_id":314815,"utype":1}],"discussion_count":3,"race_medal":0,"score":"35993187198","product_id":100085301,"comment_content":"è¯´ä¸€ä¸‹å¯¹ hashbrown çš„ç†è§£ã€‚<br><br>ä¸€èˆ¬çš„å“ˆå¸Œè¡¨æ˜¯å¯¹æ•°ç»„å¤§å°å–æ¨¡ï¼ˆhash % lenï¼‰æ¥å®šä½ä½ç½®çš„ï¼Œä½†æ˜¯ hashbrown æŠŠ hash åˆ†ä¸¤éƒ¨åˆ†ä½¿ç”¨ï¼š<br><br>1. ä½å‡ ä½ï¼ˆ&amp; bucket_sizeï¼‰å®šä½åœ¨æ•°ç»„çš„ä½ç½®<br>2. é«˜ 7 ä½å­˜åˆ°å¯¹åº”ä½ç½®çš„ ctrl å—é‡Œï¼Œç±»ä¼¼æŒ‡çº¹çš„ä½œç”¨<br><br>ä¸€èˆ¬å“ˆå¸Œè¡¨è·å–æ—¶ï¼Œå–æ¨¡å®šä½åˆ°ä½ç½®åï¼Œè¦å®Œæ•´å¯¹æ¯” key æ‰èƒ½çŸ¥é“æ˜¯æ‰¾åˆ°ï¼ˆkeyç›¸åŒï¼‰è¿˜æ˜¯è¦æ¢æŸ¥ï¼ˆkey ä¸åŒï¼‰ã€‚<br><br>è€Œ hashbrown å¯ä»¥åˆ©ç”¨ ctrl é‡Œå­˜èµ·æ¥çš„é«˜ 7 ä½å¿«é€Ÿå‘ç°å†²çªçš„æƒ…å†µï¼ˆä½å‡ ä½ç›¸åŒä½†é«˜7 ä½ä¸åŒï¼‰ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥æ¢æŸ¥ã€‚","like_count":9,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527799,"discussion_content":"èµï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633813565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1072743,"avatar":"https://static001.geekbang.org/account/avatar/00/10/5e/67/133d2da6.jpg","nickname":"Geek_5244fa","note":"","ucode":"B87A550526F74C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":401321,"discussion_content":"Go çš„ map ä¹Ÿæ˜¯ç±»ä¼¼çš„æ€è·¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633624047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2806043,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLBFkSq1oiaEMRjtyyv4ZpCI0OuaSsqs04ODm0OkZF6QhsAh3SvqhxibS2n7PLAVZE3QRSn5Hic0DyXg/132","nickname":"ddh","note":"","ucode":"8E852375365F16","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1072743,"avatar":"https://static001.geekbang.org/account/avatar/00/10/5e/67/133d2da6.jpg","nickname":"Geek_5244fa","note":"","ucode":"B87A550526F74C","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":413888,"discussion_content":"æ˜¯çš„ï¼Œ å½“æ—¶å­¦goçš„æ—¶å€™ä¹Ÿæœ‰è¿™ä¸ª","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636597361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":401321,"ip_address":""},"score":413888,"extra":""}]}]},{"had_liked":false,"id":314450,"user_name":"GeekCiao","can_delete":false,"product_type":"c1","uid":1850166,"ip_address":"","ucode":"D5DAB08E430AC7","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4D6vFOOEC0DiaTHdqmxKIWxRb9Tzt5koAQI3s4jKRNX5gfEHgu6S77AgjicpvWpKnmiah0TTEIiajGnA/132","comment_is_top":false,"comment_ctime":1633067057,"is_pvip":false,"replies":[{"id":"113973","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633320456,"ip_address":"","comment_id":314450,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27402870833","product_id":100085301,"comment_content":"aHash å·²ç»å¯ä»¥åšåˆ°DOSé˜²æŠ¤äº†ï¼šhttps:&#47;&#47;github.com&#47;tkaitchuck&#47;aHash&#47;wiki&#47;How-aHash-is-resists-DOS-attacks","like_count":7,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527683,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633320456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314503,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1633156021,"is_pvip":true,"replies":[{"id":"113970","content":"è¿™æ˜¯ä¸ªå’Œ CPU æŒ‡ä»¤é›†ç´§å¯†ç›¸å…³çš„æ“ä½œã€‚x86&#47;64 CPU ç›®å‰è¿˜æ˜¯æœåŠ¡å™¨çš„ä¸»æµï¼ˆè™½ç„¶æœªæ¥ä¸ä¸€å®šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633320208,"ip_address":"","comment_id":314503,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14518057909","product_id":100085301,"comment_content":"SIMD lookupä¹Ÿåªæ˜¯åœ¨x86&#47;64ä¸Šç”¨sse2è€Œå·²ï¼Œæ®è¯´avx&#47;neonæ•ˆæœä¸ä½³ï¼š<br><br>https:&#47;&#47;github.com&#47;rust-lang&#47;hashbrown&#47;blob&#47;cedc3267e4&#47;src&#47;raw&#47;mod.rs#L16<br><br>çœ‹äº†ä¸‹å…¶ä»–å¹³å°ä¹Ÿéƒ½è¿˜æ²¡ç¨³å®šï¼š<br><br>https:&#47;&#47;doc.rust-lang.org&#47;core&#47;arch&#47;index.html#modules","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527704,"discussion_content":"è¿™æ˜¯ä¸ªå’Œ CPU æŒ‡ä»¤é›†ç´§å¯†ç›¸å…³çš„æ“ä½œã€‚x86/64 CPU ç›®å‰è¿˜æ˜¯æœåŠ¡å™¨çš„ä¸»æµï¼ˆè™½ç„¶æœªæ¥ä¸ä¸€å®šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633320208,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317241,"user_name":"å¾æ´²æ›´","can_delete":false,"product_type":"c1","uid":1314643,"ip_address":"","ucode":"F8A323CB732D05","user_header":"https://static001.geekbang.org/account/avatar/00/14/0f/53/92a50f01.jpg","comment_is_top":false,"comment_ctime":1634719179,"is_pvip":true,"replies":[{"id":"115243","content":"ä¸æ˜¯ usize å¤§å°çš„æŒ‡é’ˆã€‚ä½ å¯ä»¥è‡ªå·±æƒ³æƒ³ String å’Œ Vec&lt;T&gt; çš„ç»“æ„éƒ½æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚æ‰€ä»¥è¿™é‡Œ key  æ˜¯ 24 ä¸ªå­—èŠ‚ï¼Œvalue ä¹Ÿæ˜¯ 24 ä¸ªå­—èŠ‚ï¼Œå®ƒä»¬å†é€šè¿‡ç»“æ„é‡Œçš„æŒ‡é’ˆæŒ‡å‘é¢å¤–çš„å †åœ°å€é‡Œçš„å†…å®¹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635122543,"ip_address":"","comment_id":317241,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10224653771","product_id":100085301,"comment_content":"HashMapä½¿ç”¨çš„ä¸€ä¸ªé—®é¢˜ï¼šæ–‡ç« ä¾‹å­æ’å…¥çš„å…ƒç´ æ˜¯charå’Œi32, é•¿åº¦å›ºå®šéƒ½æ˜¯32å­—èŠ‚ï¼ŒHashMapåœ¨æ’å…¥æ•°æ®æ—¶ï¼Œä»å›¾ä¸Šçœ‹ï¼Œæ˜¯ç›´æ¥å°†å€¼è®°å½•åœ¨å †å†…å­˜ä¸­æ•°ç»„å¯¹åº”çš„ä½ç½®ä¸Šã€‚å¯¹äºä¸€ä¸ªå¤æ‚çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚è¯´Keyæ˜¯Stringï¼ŒValueæ˜¯Vec&lt;String&gt;, é‚£ä¹ˆè®°å½•çš„æ˜¯ä¸æ˜¯å°±æ˜¯ å¤§å°ä¸ºusize çš„æŒ‡é’ˆå‘¢ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528730,"discussion_content":"ä¸æ˜¯ usize å¤§å°çš„æŒ‡é’ˆã€‚ä½ å¯ä»¥è‡ªå·±æƒ³æƒ³ String å’Œ Vec&amp;lt;T&amp;gt; çš„ç»“æ„éƒ½æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚æ‰€ä»¥è¿™é‡Œ key  æ˜¯ 24 ä¸ªå­—èŠ‚ï¼Œvalue ä¹Ÿæ˜¯ 24 ä¸ªå­—èŠ‚ï¼Œå®ƒä»¬å†é€šè¿‡ç»“æ„é‡Œçš„æŒ‡é’ˆæŒ‡å‘é¢å¤–çš„å †åœ°å€é‡Œçš„å†…å®¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635122543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1042983,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/27/a3737d61.jpg","nickname":"Shanks-ç‹å†²","note":"","ucode":"C4B90A17850E20","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583461,"discussion_content":"ä¼¼ä¹ HashMap çš„k vä¼šåˆ†åˆ«å­˜å‚¨å¯¹åº” String å’Œ Vec&lt;String&gt; çš„èƒ–æŒ‡é’ˆï¼Œåˆšå¥½æ˜¯24å’Œ24å­—èŠ‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660125007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324880,"user_name":"äº¤æµä¼š","can_delete":false,"product_type":"c1","uid":2022072,"ip_address":"","ucode":"EA82C16C86FAEE","user_header":"https://static001.geekbang.org/account/avatar/00/1e/da/b8/3f80b8a5.jpg","comment_is_top":false,"comment_ctime":1638699421,"is_pvip":false,"replies":[{"id":"118861","content":"ä½ å¯ä»¥åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šæ‰“å° main å‡½æ•°çš„åœ°å€å’Œ main ä¸‹ä¸€ä¸ª u32ï¼Œä¸€ä¸ª vec çš„å †åœ°å€ï¼Œå°±å¯ä»¥å¤§æ¦‚çœ‹åˆ°ä¸åŒåœ°å€çš„åŒºåˆ«äº†ã€‚æ¯”å¦‚ï¼š<br><br>```rust<br>fn main() {<br>    let a = 1;<br>    let arr = vec![1,2,3];<br>    <br>    println!(&quot;main: {:p}, a: {:p}, s: {:p}&quot;, main as *const (), &amp;a, &amp;arr[0]);<br>}<br>```<br><br>åœ¨ playground ä¸‹çš„æ‰“å°ï¼ˆhttps:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=8003d4ccfbf6d63280b124811a219f4aï¼‰ï¼š<br>main: 0x55bcfa1f5100, a: 0x7ffcd8b6adec, s: 0x55bcfb6ca9d0<br><br>å¦‚æœä½ æƒ³çŸ¥é“æ›´è¯¦ç»†çš„å„ä¸ªæ®µçš„åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ readelf æˆ–è€…åœ¨ gdb é‡Œé¢æŸ¥çœ‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639848605,"ip_address":"","comment_id":324880,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5933666717","product_id":100085301,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªç–‘é—®ä¸å¤ªæ‡‚è¯·æ•™ä¸€ä¸‹ï¼š<br>æ‚¨åœ¨æ–‡ä¸­è¯´ ----<br>...åœ¨æˆ‘çš„ OS X ä¸‹ï¼Œä¸€å¼€å§‹å“ˆå¸Œè¡¨ä¸ºç©ºï¼Œctrl åœ°å€çœ‹ä¸Šå»æ˜¯ä¸€ä¸ª TEXT&#47;RODATA æ®µçš„åœ°å€ï¼Œ...<br><br>æƒ³è¯·é—®ä¸€ä¸‹ï¼Œé€šè¿‡çœ‹æ•°æ®åœ°å€æ€ä¹ˆèƒ½åŒºåˆ†æ˜¯åœ¨ æ®µä¸Šè¿˜æ˜¯å †æ ˆä¸Šçš„ï¼Ÿ è°¢è°¢ï½","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539821,"discussion_content":"ä½ å¯ä»¥åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šæ‰“å° main å‡½æ•°çš„åœ°å€å’Œ main ä¸‹ä¸€ä¸ª u32ï¼Œä¸€ä¸ª vec çš„å †åœ°å€ï¼Œå°±å¯ä»¥å¤§æ¦‚çœ‹åˆ°ä¸åŒåœ°å€çš„åŒºåˆ«äº†ã€‚æ¯”å¦‚ï¼š\n\n```rust\nfn main() {\n    let a = 1;\n    let arr = vec![1,2,3];\n    \n    println!(&#34;main: {:p}, a: {:p}, s: {:p}&#34;, main as *const (), &amp;a, &amp;arr[0]);\n}\n```\n\nåœ¨ playground ä¸‹çš„æ‰“å°ï¼ˆhttps://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=8003d4ccfbf6d63280b124811a219f4aï¼‰ï¼š\nmain: 0x55bcfa1f5100, a: 0x7ffcd8b6adec, s: 0x55bcfb6ca9d0\n\nå¦‚æœä½ æƒ³çŸ¥é“æ›´è¯¦ç»†çš„å„ä¸ªæ®µçš„åœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ readelf æˆ–è€…åœ¨ gdb é‡Œé¢æŸ¥çœ‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315085,"user_name":"Ixa","can_delete":false,"product_type":"c1","uid":2033305,"ip_address":"","ucode":"4F05A56E2E1C2C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKkPibGWUPadLGzn4aQ7dmSYJyiaic7LHL8icerLv7y3ZPiazOFnHHIk6icaOYJXTqLibiadYsYBy6VKAGVkA/132","comment_is_top":false,"comment_ctime":1633683896,"is_pvip":false,"replies":[{"id":"114160","content":"å¯¹ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633812189,"ip_address":"","comment_id":315085,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5928651192","product_id":100085301,"comment_content":"æŠŠ PartialOrd å’Œ PartialEq å®ç°å³å¯è§£å†³æŠ¥é”™ã€‚ä½¿ç”¨è¯å…¸çš„cmpæ¥è¿›è¡Œå¯¹æ¯”<br><br>impl Ord for Name {<br>    fn cmp(&amp;self, other: &amp;Self) -&gt; Ordering {<br>        (self.flags, &amp;self.name).cmp(&amp;(other.flags, &amp;other.name))<br>    }<br>}<br><br>impl PartialOrd for Name {<br>    fn partial_cmp(&amp;self, other: &amp;Self) -&gt; Option&lt;Ordering&gt; {<br>        Some(self.cmp(other))<br>    }<br>}<br><br>impl PartialEq for Name {<br>    fn eq(&amp;self, other: &amp;Self) -&gt; bool {<br>        (self.flags, &amp;self.name) == (other.flags, &amp;other.name)<br>    }<br>}<br>","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527868,"discussion_content":"å¯¹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633812189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314740,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1633379124,"is_pvip":false,"replies":[{"id":"114178","content":"ä½ å¯ä»¥å‚è€ƒï¼šhttps:&#47;&#47;gankra.github.io&#47;blah&#47;rust-btree-case&#47; æ¥å­¦ä¹ ã€‚è™½ç„¶æ˜¯æ¯”è¾ƒæ—§çš„æ–‡ç« ï¼Œä½† Btreemap çš„æ€æƒ³å’Œå¤§æ–¹å‘æ˜¯ä¸€è‡´çš„ã€‚<br><br>3. B=6,edges æ˜¯ä¸ªæ•°ç»„ï¼Œé‡Œé¢æœ‰ 12 ä¸ªå…ƒç´ ï¼Œå…ƒç´ ç±»å‹æ˜¯å¯èƒ½æœªåˆå§‹åŒ–ï¼ˆMaybeUninitï¼‰çš„BoxedNode&lt;K, V&gt;ã€‚è¿™ä¸ªä»£ç å¼€å¤´å¤„æœ‰ä¼ªä»£ç è¡¨è¿°æƒ³è¦è¾¾æˆçš„ç›®çš„ï¼š<br><br>&#47;&#47; This is an attempt at an implementation following the ideal<br>&#47;&#47;<br>&#47;&#47; ```<br>&#47;&#47; struct BTreeMap&lt;K, V&gt; {<br>&#47;&#47;     height: usize,<br>&#47;&#47;     root: Option&lt;Box&lt;Node&lt;K, V, height&gt;&gt;&gt;<br>&#47;&#47; }<br>&#47;&#47;<br>&#47;&#47; struct Node&lt;K, V, height: usize&gt; {<br>&#47;&#47;     keys: [K; 2 * B - 1],<br>&#47;&#47;     vals: [V; 2 * B - 1],<br>&#47;&#47;     edges: [if height &gt; 0 { Box&lt;Node&lt;K, V, height - 1&gt;&gt; } else { () }; 2 * B],<br>&#47;&#47;     parent: Option&lt;(NonNull&lt;Node&lt;K, V, height + 1&gt;&gt;, u16)&gt;,<br>&#47;&#47;     len: u16,<br>&#47;&#47; }","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633814307,"ip_address":"","comment_id":314740,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5928346420","product_id":100085301,"comment_content":"ç¬¬ä¸‰é¢˜:<br>```<br>    # æœ€åˆ root insert a - k<br>    x&#47;24 0x100504080<br>    0x100504080: 0x004044a0 0x00000001 0x00000061 0x00000062<br>    0x100504090: 0x00000063 0x00000064 0x00000065 0x00000066<br>    0x1005040a0: 0x00000067 0x00000068 0x00000069 0x0000006a<br>    0x1005040b0: 0x0000006b 0x00000001 0x00000002 0x00000003<br>    0x1005040c0: 0x00000004 0x00000005 0x00000006 0x00000007<br>    0x1005040d0: 0x00000008 0x00000009 0x0000000a 0x0000000b<br>    # insert ç¬¬11ä¸ª å‡ºç°æ–°çš„root<br>    x 0x1004044a0<br>    0x1004044a0: 00 00 00 00 00 00 00 00 67 00 00 00 00 00 00 00 ........g.......<br>    0x1004044b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................<br>    ## ç»§ç»­ insert åˆ° z<br>    x 0x1004044a0<br>    0x1004044a0: 00 00 00 00 00 00 00 00 67 00 00 00 6e 00 00 00 ........g...n...<br>    0x1004044b0: 5 00 00 00 ff ff ff ff ff ff ff ff ff ff ff ff  u...ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½<br>```<br><br>`LeafNode`çš„capacityæ˜¯11, è£…æ»¡äº†è¿‡åå°±å˜æˆ6ä¸ª, ç•™5ä¸ªslotä»¥å¤‡depthåŠ æ·±<br><br>```<br>    root        &lt;g           n            u&gt; <br>    leaf &lt;a-f&gt;   &lt;h-m&gt;     &lt;o-t&gt;      &lt;v-z&gt;<br>```<br><br>ç–‘é—®: <br><br><br>1. `LeafNode` ç¬¬ä¸€ä¸ªfieldä¸æ˜¯parentå˜›? ä¸ºå•¥leaf 1çš„ç¬¬ä¸€ä½æ˜¯ `0x004044a0` ä»…ä»…æ˜¯32ä½? æˆ‘çš„æœºå™¨æ˜¯64ä½, è€Œä¸”ä¹‹åå‡ºç°çš„parentçš„addressæ˜¯ `0x1004044a0`, æ„Ÿè§‰è¿™ä¸¤ä¸ªå¾ˆæ¥è¿‘? ä¸çŸ¥é“è¿™æ˜¯ä»€ä¹ˆtrick<br><br>2. æ€ä¹ˆä»root node read leaf nodeçš„memoryå‘¢? root nodeçš„parentæ˜¯null, æ²¡æ‰¾åˆ°æ€ä¹ˆaccess leaf node. æˆ‘ç›®å‰åªèƒ½ä»æœ€åˆçš„root nodeçŒœ (ä»¥ä¸ºä¹‹åè¿™ä¸ªrootå˜æˆäº†leaf)<br><br>3. è¿™ä¸ªfieldèƒ½å¤§æ¦‚è®²ä¸€è®²big pictureå˜›? ç›®å‰è¯»æºç è¿˜æ˜¯æœ‰éš¾åº¦...<br>```<br> struct InternalNode { data: LeafNode, edges: [MaybeUninit&gt;; 2 * B],}<br>````<br>","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527778,"discussion_content":"ä½ å¯ä»¥å‚è€ƒï¼šhttps://gankra.github.io/blah/rust-btree-case/ æ¥å­¦ä¹ ã€‚è™½ç„¶æ˜¯æ¯”è¾ƒæ—§çš„æ–‡ç« ï¼Œä½† Btreemap çš„æ€æƒ³å’Œå¤§æ–¹å‘æ˜¯ä¸€è‡´çš„ã€‚\n\n3. B=6,edges æ˜¯ä¸ªæ•°ç»„ï¼Œé‡Œé¢æœ‰ 12 ä¸ªå…ƒç´ ï¼Œå…ƒç´ ç±»å‹æ˜¯å¯èƒ½æœªåˆå§‹åŒ–ï¼ˆMaybeUninitï¼‰çš„BoxedNode&amp;lt;K, V&amp;gt;ã€‚è¿™ä¸ªä»£ç å¼€å¤´å¤„æœ‰ä¼ªä»£ç è¡¨è¿°æƒ³è¦è¾¾æˆçš„ç›®çš„ï¼š\n\n// This is an attempt at an implementation following the ideal\n//\n// ```\n// struct BTreeMap&amp;lt;K, V&amp;gt; {\n//     height: usize,\n//     root: Option&amp;lt;Box&amp;lt;Node&amp;lt;K, V, height&amp;gt;&amp;gt;&amp;gt;\n// }\n//\n// struct Node&amp;lt;K, V, height: usize&amp;gt; {\n//     keys: [K; 2 * B - 1],\n//     vals: [V; 2 * B - 1],\n//     edges: [if height &amp;gt; 0 { Box&amp;lt;Node&amp;lt;K, V, height - 1&amp;gt;&amp;gt; } else { () }; 2 * B],\n//     parent: Option&amp;lt;(NonNull&amp;lt;Node&amp;lt;K, V, height + 1&amp;gt;&amp;gt;, u16)&amp;gt;,\n//     len: u16,\n// }","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633814307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314677,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1633323333,"is_pvip":false,"replies":[{"id":"113991","content":"æ³¨æ„çœ‹å›¾ï¼Œè¿™å¥è¯ä¹‹åçš„å›¾ï¼Œä½ çœ‹çœ‹å›¾ä¸­å‰åå¯¹æ¯”ã€‚<br><br>&gt; åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠå“ˆå¸Œçš„é‡åˆ†é…ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œâ€˜aâ€™ &#47; â€˜câ€™ çš„ç›¸å¯¹ä½ç½®å’Œå®ƒä»¬çš„ ctrl byte æ²¡æœ‰å˜åŒ–ï¼Œä½†é‡æ–°åš hash åï¼Œâ€˜bâ€™ çš„ ctrl byte å’Œä½ç½®éƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚<br><br>ç°åœ¨ ctrl bits çš„ä½ç½®æ˜¯ï¼š5 6 7 8 1 2 3 4ã€‚æ‰€ä»¥ 0a å¯¹åº”ç¬¬ä¸€é¡¹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633326416,"ip_address":"","comment_id":314677,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5928290629","product_id":100085301,"comment_content":"å¯¹æ–‡ä¸­çš„ä¾‹å­æœ‰äº›ç–‘é—®:<br><br>æˆ‘çš„ç†è§£æ˜¯, ctrl section, byteçš„postion, å¯¹åº”ç€bucketçš„position<br><br>`a` åœ¨ç¬¬ä¸€ä¸ªbucket, ä¸ºå•¥ctrl sectionçš„ç¬¬ä¸€ä¸ªbyteä¸æ˜¯`0x72` å‘¢? å’Œç¤ºæ„å›¾ (`ctrl è¡¨` é‚£ä¸€èŠ‚) å¯¹ä¸ä¸Š.<br><br>```<br>(gdb) c<br>Continuing.<br># æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x5555555a7b50 - 8*8(0x40)<br>added 4: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 3, items: 4<br><br>Breakpoint 1, hashmap2::explain (name=..., map=...) at src&#47;hashmap2.rs:32<br>32      unsafe { std::mem::transmute(arr) }<br>(gdb) x &#47;20x 0x5555555a7b10<br>0x5555555a7b10:  0x00000061  0x00000001  0x00000000  0x00000000<br>0x5555555a7b20:  0x00000064  0x00000004  0x00000063  0x00000003<br>0x5555555a7b30:  0x00000000  0x00000000  0x00000062  0x00000002<br>0x5555555a7b40:  0x00000000  0x00000000  0x00000000  0x00000000<br>0x5555555a7b50:  0xff72ffff  0x0aff6502  0xffffffff  0xffffffff<br>```<br><br>ctrlçš„start addræ˜¯0x5555555a7b50, ç¬¬ä¸€ä¸ªbyteä¸åº”è¯¥å¯¹åº”bucket 1å—? ç„¶è€Œ`0a` å¯¹åº”çš„æ˜¯ç¬¬5ä¸ªbucket?","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527758,"discussion_content":"æ³¨æ„çœ‹å›¾ï¼Œè¿™å¥è¯ä¹‹åçš„å›¾ï¼Œä½ çœ‹çœ‹å›¾ä¸­å‰åå¯¹æ¯”ã€‚\n\n&amp;gt; åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠå“ˆå¸Œçš„é‡åˆ†é…ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œâ€˜aâ€™ / â€˜câ€™ çš„ç›¸å¯¹ä½ç½®å’Œå®ƒä»¬çš„ ctrl byte æ²¡æœ‰å˜åŒ–ï¼Œä½†é‡æ–°åš hash åï¼Œâ€˜bâ€™ çš„ ctrl byte å’Œä½ç½®éƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚\n\nç°åœ¨ ctrl bits çš„ä½ç½®æ˜¯ï¼š5 6 7 8 1 2 3 4ã€‚æ‰€ä»¥ 0a å¯¹åº”ç¬¬ä¸€é¡¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633326416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2181012,"avatar":"https://static001.geekbang.org/account/avatar/00/21/47/94/46d6a079.jpg","nickname":"Siact","note":"","ucode":"0C294F4614D48C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":587362,"discussion_content":"ä¸ºä»€ä¹ˆç°åœ¨çš„ctrl bit çš„ä½ç½®ä¸æ˜¯ï¼š1 2 3 4 5 6 7 8 å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662994171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":527758,"ip_address":"ä¸­å›½é¦™æ¸¯"},"score":587362,"extra":""}]},{"author":{"id":1111835,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","nickname":"Marvichov","note":"","ucode":"7482099415C41C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400681,"discussion_content":"1. ä¸ºå•¥ctrl bitsä¸æ˜¯natural order(1-8)å‘¢? æ„Ÿè§‰è¿™æ ·å¥½ç†è§£ä¸€ç‚¹\n\n2. 5-8, 1-4 è¿™æ ·çš„å¸ƒå±€, éš¾é“æœ‰ä»€ä¹ˆä¼˜åŠ¿å˜›? 8-1æˆ‘è¿˜å¯ä»¥ç†è§£, ç›´æ¥ç”¨ctrlçš„addr - offsetå°±èƒ½æ‰¾åˆ°bucket addr.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633363860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314628,"user_name":"é˜¿æµ·","can_delete":false,"product_type":"c1","uid":1281585,"ip_address":"","ucode":"2589431F840C42","user_header":"https://static001.geekbang.org/account/avatar/00/13/8e/31/28972804.jpg","comment_is_top":false,"comment_ctime":1633266499,"is_pvip":true,"replies":[{"id":"113982","content":"1. æ­£ç¡®ï¼<br>2. éœ€è¦å†…å­˜ (200+15+1) * 2M = 432Mï¼Œå®é™…å ç”¨ (200+15) * 114M = 246Mï¼Œåˆ©ç”¨ç‡ 57%ã€‚æ³¨æ„ HashMap  bucket æ•°é‡æ˜¯æŒ‡æ•°å¢é•¿çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633322146,"ip_address":"","comment_id":314628,"utype":1}],"discussion_count":7,"race_medal":0,"score":"5928233795","product_id":100085301,"comment_content":"è¿™ä¸€ç« çœ‹çš„æ¯”ä¹‹å‰åƒåŠ›å¾ˆå¤šï¼Œå°¤å…¶æ˜¯ä¸­é—´è§‚å¯Ÿå†…å­˜å¸ƒå±€çš„å†…å®¹ã€‚åé¢æœ‰æœºä¼šå†æ¥ä»”ç»†ç¢ç£¨ä¸‹ã€‚<br><br>å°è¯•å›ç­”ä¸‹é—®é¢˜å§ï¼š<br><br>1. Nameéœ€è¦å®ç° Debug, PartialEq, Eq, PartialOrd, Ord è¿™å‡ ä¸ªtrait<br>```<br>#[derive(Debug, PartialEq, Eq, PartialOrd, Ord)]<br>struct Name {<br>    pub name: String,<br>    pub flags: u32,<br>}<br>```<br><br>2. ç²—ç•¥ç®—äº†ä¸‹ï¼Œ(15 + 200) * 1200000  &#47; ï¼ˆ1024 * 1024ï¼‰å¤§çº¦éœ€è¦246Må†…å­˜ã€‚å†…å­˜åˆ©ç”¨ç‡ä¸çŸ¥é“è¦æ€ä¹ˆç®—äº†ã€‚<br><br>3. ç­‰æœ‰æ—¶é—´å†ç¢ç£¨ä¸‹","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527744,"discussion_content":"1. æ­£ç¡®ï¼\n2. éœ€è¦å†…å­˜ (200+15+1) * 2M = 432Mï¼Œå®é™…å ç”¨ (200+15) * 114M = 246Mï¼Œåˆ©ç”¨ç‡ 57%ã€‚æ³¨æ„ HashMap  bucket æ•°é‡æ˜¯æŒ‡æ•°å¢é•¿çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633322146,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1494311,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epdUKuOV21hnfTmXPibv5ReJCCIxiamtzXkibh9p41sSJeYQ87swreLWlTNEibh5ibefsoJfFppOvR088Q/132","nickname":"Geek_05de53","note":"","ucode":"20872B89D6A782","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":551033,"discussion_content":"è¯·é—®è€å¸ˆ(200+15+1)è¿™å…¶ä¸­æ¯ä¸ª+1æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿæ˜¯æ¯ä¸ªæ•°æ®å¯¹åº”çš„ctrlè¡¨çš„å­—èŠ‚å ç”¨çš„ä¹ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644855458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":527744,"ip_address":""},"score":551033,"extra":""}]},{"author":{"id":1298252,"avatar":"","nickname":"Geek_b52974","note":"","ucode":"59884399646620","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411280,"discussion_content":"å› ç‚ºå…¨éƒ¨çš„æ•¸æ“šå¤§æ¦‚æ˜¯ 1.14M å€‹ (1200000) bucketï¼Œå‰ 1 ä¸€æ¬¡æ“´å±•æ˜¯ 1M å€‹ bucketï¼Œå¡ä¸ä¸‹äº†å°±æœƒç­‰æ¯”é•·åˆ° 2 M å€‹ bucket","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635878108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1494311,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epdUKuOV21hnfTmXPibv5ReJCCIxiamtzXkibh9p41sSJeYQ87swreLWlTNEibh5ibefsoJfFppOvR088Q/132","nickname":"Geek_05de53","note":"","ucode":"20872B89D6A782","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1298252,"avatar":"","nickname":"Geek_b52974","note":"","ucode":"59884399646620","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":551032,"discussion_content":"è¯·é—®(200+15+1)è¿™å…¶ä¸­æ¯ä¸ª+1æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿæ˜¯æ¯ä¸ªæ•°æ®å¯¹åº”çš„ctrlè¡¨çš„å­—èŠ‚å ç”¨çš„ä¹ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644855437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":411280,"ip_address":""},"score":551032,"extra":""}]},{"author":{"id":1298252,"avatar":"","nickname":"Geek_b52974","note":"","ucode":"59884399646620","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411279,"discussion_content":"é€™é‚Šæ‡‰è©²æ˜¯ 1.14 M ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635877703,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2738941,"avatar":"https://static001.geekbang.org/account/avatar/00/29/ca/fd/4e6dd31c.jpg","nickname":"æ¸æçº¢èŒ¶","note":"","ucode":"03D80953AF984E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":408344,"discussion_content":"è¯·é—®ï¼Œ2Må’Œ114Måˆ†åˆ«æ˜¯æ€ä¹ˆå¾—åˆ°çš„å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635231608,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1166095,"avatar":"https://static001.geekbang.org/account/avatar/00/11/cb/0f/cc403ab4.jpg","nickname":"é˜¿å‡¯","note":"","ucode":"26310370149BFE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2738941,"avatar":"https://static001.geekbang.org/account/avatar/00/29/ca/fd/4e6dd31c.jpg","nickname":"æ¸æçº¢èŒ¶","note":"","ucode":"03D80953AF984E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559970,"discussion_content":"å®é™…éœ€è¦ 1,200,000 ä¸ª bucketï¼Œå³ 1,200,000 / 1024 / 1024 â‰ˆ 1.44Mã€‚\nè€Œ HashMap çš„å®¹é‡æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ï¼Œæ‰€ä»¥åˆ†é…å†…å­˜æ—¶è¦å‘ä¸Šå–æ•´åˆ° 2Mï¼Œå³ 2,097,152 ä¸ª bucketã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649085632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":408344,"ip_address":""},"score":559970,"extra":""}]}]},{"had_liked":false,"id":358392,"user_name":"æ˜Ÿå®¿æµ·","can_delete":false,"product_type":"c1","uid":2189067,"ip_address":"å®‰å¾½","ucode":"F49E70D579D59E","user_header":"https://static001.geekbang.org/account/avatar/00/21/67/0b/145e3804.jpg","comment_is_top":false,"comment_ctime":1664266575,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1664266575","product_id":100085301,"comment_content":"https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=213aeb2d1aada4cb3c1ede3f2e9c9e36<br>å¤§ä½¬ï¼Œhashmapçš„capacityä¸ºä½•ä¸æ˜¯ 2çš„å¹‚-1ï¼Œè€Œæ˜¯capacity= growth_left + itemsã€‚","like_count":0},{"had_liked":false,"id":356481,"user_name":"Geek_a6c6ce","can_delete":false,"product_type":"c1","uid":3074996,"ip_address":"ç¾å›½","ucode":"21DC76D3225403","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/TusRVU51UggZGpicXMgH64Cb8jek0wyTOpagtUHNAj0EPbhbEv0FJpFU2K3glbtOdJXiaQ9o6QoEfv5PiaIu7rwng/132","comment_is_top":false,"comment_ctime":1662356793,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662356793","product_id":100085301,"comment_content":"å’”å“’","like_count":0},{"had_liked":false,"id":347919,"user_name":"ELSE","can_delete":false,"product_type":"c1","uid":1172907,"ip_address":"","ucode":"72448D7271C8B0","user_header":"https://static001.geekbang.org/account/avatar/00/11/e5/ab/56f348e5.jpg","comment_is_top":false,"comment_ctime":1654583348,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654583348","product_id":100085301,"comment_content":"ä¸€è·¯å­¦åˆ°è¿™é‡Œï¼Œæ„Ÿè§‰çœŸæ˜¯å¹²è´§æ»¡æ»¡ï¼Œä½œè€…ç”¨å¿ƒäº†ï¼Œè™½ç„¶å¾ˆå¤šä¸œè¥¿æ²¡èƒ½ç†è§£ï¼Œä½†æˆ‘æƒ³ç¬¬äºŒéå†çœ‹çš„æ—¶å€™åº”è¯¥æ”¶è·æ›´å¤šã€‚å¦å¤–ï¼Œéå¸¸èµå¹å­¦å‘˜é‡Œå…¨æ˜¯é«˜æ‰‹å•Šï¼","like_count":0},{"had_liked":false,"id":333471,"user_name":"æ…¢æ…¢æœ€å¿«","can_delete":false,"product_type":"c1","uid":2203460,"ip_address":"","ucode":"F15797874EB5ED","user_header":"https://static001.geekbang.org/account/avatar/00/21/9f/44/316f93a6.jpg","comment_is_top":false,"comment_ctime":1644376555,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644376555","product_id":100085301,"comment_content":"hash æ³•çš„å¯¹æ¯”ï¼Œä»¥åŠ swiss tablesçš„è¯¦è§£ï¼Œæ„Ÿè§‰çœ‹çœ‹è¿™ç¯‡æ–‡ç«  https:&#47;&#47;zhuanlan.zhihu.com&#47;p&#47;277732297ï¼Œç†è§£èµ·æ¥è¿˜æŒºå—ç”¨çš„","like_count":1},{"had_liked":false,"id":314808,"user_name":"Geek_5244fa","can_delete":false,"product_type":"c1","uid":1072743,"ip_address":"","ucode":"B87A550526F74C","user_header":"https://static001.geekbang.org/account/avatar/00/10/5e/67/133d2da6.jpg","comment_is_top":false,"comment_ctime":1633444471,"is_pvip":true,"replies":[{"id":"114174","content":"å¯¹ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633813587,"ip_address":"","comment_id":314808,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633444471","product_id":100085301,"comment_content":"&gt; å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨ï¼Œå¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨ã€‚<br><br><br>è¿™é‡Œè¯´çš„ä¸€ä¸€å¯¹åº”ï¼Œç»“åˆå›¾æ¥çœ‹ï¼Œä¼¼ä¹è¯´çš„æ˜¯ä½ç½®çš„æ˜ å°„ã€‚<br><br>HashMap æœ‰ä¸¤ä¸ªæ˜ å°„å…³ç³»ï¼Œä¸€ä¸ªæ˜¯ key åˆ°ä½ç½®çš„æ˜ å°„ï¼Œä¸€ä¸ªåˆ° value çš„æ˜ å°„ã€‚ä¸åŒ key å¯èƒ½æ˜ å°„åˆ°ç›¸åŒçš„ä½ç½®ï¼ˆå†²çªï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜ å°„åˆ°ç›¸åŒçš„å€¼ã€‚<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527795,"discussion_content":"å¯¹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633813587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314684,"user_name":"ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚","can_delete":false,"product_type":"c1","uid":1462209,"ip_address":"","ucode":"F3B0439BE0D062","user_header":"https://static001.geekbang.org/account/avatar/00/16/4f/c1/7f596aba.jpg","comment_is_top":false,"comment_ctime":1633326255,"is_pvip":true,"replies":[{"id":"114180","content":"hashmap ä¸­æ‰€æœ‰çš„è¾“å…¥éƒ½æ¥è‡ªäºå†…éƒ¨ç³»ç»Ÿï¼Œæ¯”å¦‚ä½ æœ‰ä¸ª databaseï¼Œä½¿ç”¨ uuid åšä¸»é”®ï¼Œä½ è¦ç”¨ hashmap æ¥å¯¹ db çš„æ•°æ®åšç¼“å­˜ï¼Œé‚£ä¹ˆ key å°±æ˜¯ db ä¸­çš„ uuidï¼Œè¿™æ˜¯ä½ è‡ªå·±ç”Ÿæˆçš„æ•°æ®ï¼Œå¹¶éå¯ä»¥ç²¾å¿ƒæ„é€ çš„ç”¨æˆ·è¾“å…¥ï¼Œæ‰€ä»¥å¯ä»¥ç”¨é DDOS resistent çš„ hash ç®—æ³•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633814557,"ip_address":"","comment_id":314684,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633326255","product_id":100085301,"comment_content":"æ¯”å¦‚ä¸€ä¸ªå®Œå…¨å†…éƒ¨ä½¿ç”¨çš„ HashMapï¼Œè¿™ä¸ªæ²¡å¤ªæ‡‚ï¼Œå¦‚ä½•åˆ¤æ–­é¡¹ç›®ä¸­çš„hashmapæ˜¯å®Œå…¨å†…éƒ¨ä½¿ç”¨çš„å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527761,"discussion_content":"hashmap ä¸­æ‰€æœ‰çš„è¾“å…¥éƒ½æ¥è‡ªäºå†…éƒ¨ç³»ç»Ÿï¼Œæ¯”å¦‚ä½ æœ‰ä¸ª databaseï¼Œä½¿ç”¨ uuid åšä¸»é”®ï¼Œä½ è¦ç”¨ hashmap æ¥å¯¹ db çš„æ•°æ®åšç¼“å­˜ï¼Œé‚£ä¹ˆ key å°±æ˜¯ db ä¸­çš„ uuidï¼Œè¿™æ˜¯ä½ è‡ªå·±ç”Ÿæˆçš„æ•°æ®ï¼Œå¹¶éå¯ä»¥ç²¾å¿ƒæ„é€ çš„ç”¨æˆ·è¾“å…¥ï¼Œæ‰€ä»¥å¯ä»¥ç”¨é DDOS resistent çš„ hash ç®—æ³•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633814557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314616,"user_name":"ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚","can_delete":false,"product_type":"c1","uid":1462209,"ip_address":"","ucode":"F3B0439BE0D062","user_header":"https://static001.geekbang.org/account/avatar/00/16/4f/c1/7f596aba.jpg","comment_is_top":false,"comment_ctime":1633259140,"is_pvip":true,"replies":[{"id":"113967","content":"hash å†²çªï¼Œhash åŸæœ¬å¯¹åº”çš„ bucket è¢«å ç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œå“ˆå¸Œå†²çªçš„å¤„ç†äº†ï¼Œéœ€è¦æ‰¾å‡ºæ¥ä¸€ä¸ªç©ºé—²çš„ bucketï¼Œè¿™ä¸ªæ—¶å€™ç”¨äºŒæ¬¡æ¢æŸ¥ã€‚<br><br>è‡³äºå¯¹åŸæ¥çš„ key çš„æ›´æ–°ï¼ŒæŸ¥åˆ° hash å¯¹åº”çš„ slot åï¼Œè¿˜ä¼šè¿›ä¸€æ­¥å’Œ key åšå¯¹æ¯”ã€‚å‘ç°key ç›¸åŒï¼Œåˆ™åšæ›´æ–°æ“ä½œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1633320000,"ip_address":"","comment_id":314616,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1633259140","product_id":100085301,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªä¸å¤ªæ‡‚çš„åœ°æ–¹ã€‚æ–‡ç« é‡Œè®²åˆ°äº†äºŒæ¬¡æ¢æŸ¥ï¼Œä½† Rusté‡Œé¢çš„hashmap åœ¨æ’å…¥çš„æ—¶å€™ï¼Œå¯¹keyè¿›è¡Œhashï¼Œè¿™ä¸ªåœ°æ–¹æ€ä¹ˆåŒºåˆ«hashå‡ºæ¥çš„keyè¦ä¸è¦è¿›è¡ŒäºŒæ¬¡æ¢æŸ¥å‘¢ï¼Ÿå› ä¸ºç°åœ¨æœ‰ä¸¤ç§å¯èƒ½ï¼Œç¬¬ä¸€ç§æ˜¯è¿™æ˜¯ä¸€ä¸ªæ–°çš„keyï¼Œhashå†²çªäº†ï¼Œéœ€è¦è¿›è¡ŒäºŒæ¬¡æ¢æŸ¥ã€‚ç¬¬äºŒç§æƒ…å†µæ˜¯ï¼Œè¿™è¿˜æ˜¯åŸæ¥çš„keyï¼Œè¦æ›´æ–°valueã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527737,"discussion_content":"hash å†²çªï¼Œhash åŸæœ¬å¯¹åº”çš„ bucket è¢«å ç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œå“ˆå¸Œå†²çªçš„å¤„ç†äº†ï¼Œéœ€è¦æ‰¾å‡ºæ¥ä¸€ä¸ªç©ºé—²çš„ bucketï¼Œè¿™ä¸ªæ—¶å€™ç”¨äºŒæ¬¡æ¢æŸ¥ã€‚\n\nè‡³äºå¯¹åŸæ¥çš„ key çš„æ›´æ–°ï¼ŒæŸ¥åˆ° hash å¯¹åº”çš„ slot åï¼Œè¿˜ä¼šè¿›ä¸€æ­¥å’Œ key åšå¯¹æ¯”ã€‚å‘ç°key ç›¸åŒï¼Œåˆ™åšæ›´æ–°æ“ä½œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633320000,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536336,"discussion_content":"ä½ å¥½åƒæ··æ·†äº†æ’å…¥/æ›´æ–°æ“ä½œä¸æ¢æŸ¥çš„å…³ç³»ï¼Œå®é™…ä¸Šä¸¤è€…æ²¡æœ‰å®è´¨ä¸Šçš„å…³ç³»ã€‚\nåªæœ‰hashç¢°æ’æ‰ä¼šè§¦å‘å†æ¬¡æ¢æŸ¥ï¼ˆäºŒæ¬¡æ¢æŸ¥ä¸æ˜¯å†æ¬¡æ¢æŸ¥çš„æ„æ€ï¼Œè€Œæ˜¯æŒ‡æ¢æŸ¥æ–¹å¼æ˜¯äºŒæ¬¡å¹‚ï¼‰ï¼Œè€Œhashç¢°æ’å‘ç”Ÿåœ¨ä¸ºå€¼å¯»æ‰¾æ’å…¥ä½ç½®çš„è¿‡ç¨‹ä¸­ï¼Œåªæœ‰ç¡®å®šäº†è¿™ä¸ªkeyè¿˜æ²¡æ’å…¥ï¼Œæ‰ä¼šæ‰§è¡ŒçœŸæ­£çš„æ’å…¥æ“ä½œï¼Œæ‰ä¼šåœ¨å¯»æ‰¾æ’å…¥ä½ç½®çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå†æ¬¡æ¢æŸ¥ã€‚\nå¯¹äºä»»æ„ä¸€ä¸ª key è°ƒç”¨ insertï¼Œé¦–å…ˆä¼šå¯»æ‰¾ map é‡Œæœ‰æ²¡æœ‰è¿™ä¸ª keyï¼Œå¦‚æœæ‰¾åˆ°äº†å°±ç›´æ¥æ›´æ–°ï¼Œæ²¡æ‰¾åˆ°æ‰æ‰§è¡ŒçœŸæ­£çš„æ’å…¥æ“ä½œã€‚åœ¨çœŸæ­£çš„æ’å…¥æ“ä½œä¸­ï¼Œå…ˆå¾—åˆ° hashï¼Œç„¶åæ‰¾åˆ°æ’å…¥çš„ä½ç½®ï¼Œæ‰¾ä½ç½®çš„è¿‡ç¨‹ä¸­å°±å¯èƒ½å‘ç”Ÿ hash ç¢°æ’ï¼Œè¿›è€Œè¦å†æ¬¡æ¢æŸ¥ä¸‹ä¸€ä¸ªå¯èƒ½çš„ä½ç½®ï¼ŒäºŒæ¬¡æ¢æŸ¥å°±å‘ç”Ÿåœ¨è¿™ä¸ªæ‰¾ä½ç½®çš„è¿‡ç¨‹ä¸­ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638762012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536339,"discussion_content":"ä¸è¿‡ï¼Œåœ¨ç¡®å®šâ€œmap é‡Œæœ‰æ²¡æœ‰è¿™ä¸ª keyâ€çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè¿ç”¨äº†ç›¸åŒçš„æ¢æŸ¥æ–¹å¼æ¥æœç´¢è¿™ä¸ªkeyã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638762437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}