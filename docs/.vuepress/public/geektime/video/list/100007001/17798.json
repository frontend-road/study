{"id":17798,"title":"91 | 信号量 vs 线程池隔离","content":"无","comments":[{"had_liked":false,"id":45682,"user_name":"Ax1an","can_delete":false,"product_type":"c3","uid":1014934,"ip_address":"","ucode":"C2B3FCF5ED05FC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/96/79f027c6.jpg","comment_is_top":false,"comment_ctime":1543747558,"is_pvip":false,"replies":[{"id":16458,"content":"你可以使用信号量然后设超时（比如2秒），但调用的服务要花5秒，这个调用线程（容器线程）不能在2秒时主动超时，必然等5秒调用返回，hystrix会标记一次超时，因为你设了2秒超时（虽然实际服务调花5且是成功的）。线程池设2秒超时的话，下面的调用线程（hystrix线程池内线程）会在2秒时主动超时。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1543841288,"ip_address":"","comment_id":45682,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"信号量不支持主动超时的解释，看了三遍还是没看懂，麻烦波波老师再详细解释一下，感谢！","like_count":4,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431153,"discussion_content":"你可以使用信号量然后设超时（比如2秒），但调用的服务要花5秒，这个调用线程（容器线程）不能在2秒时主动超时，必然等5秒调用返回，hystrix会标记一次超时，因为你设了2秒超时（虽然实际服务调花5且是成功的）。线程池设2秒超时的话，下面的调用线程（hystrix线程池内线程）会在2秒时主动超时。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543841288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":193360,"user_name":"Jason","can_delete":false,"product_type":"c3","uid":1085947,"ip_address":"","ucode":"6EECC0C25A9FCC","user_header":"https://static001.geekbang.org/account/avatar/00/10/91/fb/9b9d22a0.jpg","comment_is_top":false,"comment_ctime":1584890962,"is_pvip":false,"replies":[{"id":74045,"content":"信号量semaphore是一种同步机制，在一个调用线程里头，没办法主动超时。超时需要两个线程，B线程在实际干活，A线程拿着秒表看着B线程是否超时。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585058227,"ip_address":"","comment_id":193360,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"为什么信号量不支持超时呢？另外信号量需要同有关联进程间通信么？","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488545,"discussion_content":"信号量semaphore是一种同步机制，在一个调用线程里头，没办法主动超时。超时需要两个线程，B线程在实际干活，A线程拿着秒表看着B线程是否超时。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585058227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":35674,"user_name":"breezeQian","can_delete":false,"product_type":"c3","uid":1066220,"ip_address":"","ucode":"29A6CC6B245ED9","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/ec/0c24c4f5.jpg","comment_is_top":false,"comment_ctime":1540736402,"is_pvip":false,"replies":[{"id":12988,"content":"建议看hystrix文档对semaphore信号量的解释，内部本质是同步阻塞机制，\n\nhttps:&#47;&#47;github.com&#47;Netflix&#47;Hystrix&#47;wiki&#47;How-it-Works\n\nNote: if a dependency is isolated with a semaphore and then becomes latent, the parent threads will remain blocked until the underlying network calls timeout.","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1541159807,"ip_address":"","comment_id":35674,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，信号量隔离不支持异步调用是什么意思？麻烦您有空解释下，😄","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427620,"discussion_content":"建议看hystrix文档对semaphore信号量的解释，内部本质是同步阻塞机制，\n\nhttps://github.com/Netflix/Hystrix/wiki/How-it-Works\n\nNote: if a dependency is isolated with a semaphore and then becomes latent, the parent threads will remain blocked until the underlying network calls timeout.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541159807,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":68349,"user_name":"NICK","can_delete":false,"product_type":"c3","uid":1322863,"ip_address":"","ucode":"FE50160CA16DCC","user_header":"https://static001.geekbang.org/account/avatar/00/14/2f/6f/31721039.jpg","comment_is_top":false,"comment_ctime":1550486562,"is_pvip":false,"replies":[{"id":24399,"content":"受信任服务一般是企业内部开发，性能不至太差，所以用信号量也OK。但是如果服务确实很慢，即使受信任，也要考虑线程池隔离，同时因为在企业内部，我们一般可以要求服务提供方改善性能。第三方的服务我们一般称为不受信，因为性能一般无法把控，可能很慢，我们一般也无法要求第三方改善性能。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1550577238,"ip_address":"","comment_id":68349,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，为什么受信任服务的就用信号量？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439639,"discussion_content":"受信任服务一般是企业内部开发，性能不至太差，所以用信号量也OK。但是如果服务确实很慢，即使受信任，也要考虑线程池隔离，同时因为在企业内部，我们一般可以要求服务提供方改善性能。第三方的服务我们一般称为不受信，因为性能一般无法把控，可能很慢，我们一般也无法要求第三方改善性能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550577238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":52114,"user_name":"王盛武","can_delete":false,"product_type":"c3","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1545311590,"is_pvip":false,"replies":[{"id":19119,"content":"一个线程管多个服务，就无法有效隔离，就会有干扰问题。一个服务一般不会同时调很多其它服务，调超&gt;=10服务场景是很少的，即使有，10个线程池开销也不大。只有网关（或某些聚合服务）会大量调其它服务，这时不用线程池，而用信号量。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1545399739,"ip_address":"","comment_id":52114,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"为什么不以多个服务作为一个线程池？\n10个接口，开10个线程池，   核心活跃线程数开销会不会很大？\n还是每个接口的单个线程池设置核心线程数不大，然后通过线程等待队列的方式优化？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433750,"discussion_content":"一个线程管多个服务，就无法有效隔离，就会有干扰问题。一个服务一般不会同时调很多其它服务，调超&amp;gt;=10服务场景是很少的，即使有，10个线程池开销也不大。只有网关（或某些聚合服务）会大量调其它服务，这时不用线程池，而用信号量。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545399739,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48706,"user_name":"魏红生","can_delete":false,"product_type":"c3","uid":1227645,"ip_address":"","ucode":"E090888574BC5E","user_header":"https://static001.geekbang.org/account/avatar/00/12/bb/7d/c7f6b46e.jpg","comment_is_top":false,"comment_ctime":1544519799,"is_pvip":false,"replies":[{"id":17799,"content":"如果是聚合服务过多（一般在网关上），请使用信号量隔离，不要用线程池，否则会搞出很多线程池开销太大不可控。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1544706269,"ip_address":"","comment_id":48706,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"你好，我现在遇到一个问题想请教下：\n    每个服务单元设置一个线程池进行隔离限流，但是线程都没有回收一直hang住了，如：\n&quot;hystrix-xxxservice-5&quot; #1029 daemon prio=5 os_prio=0 tid=0x00007f5a9c235800 nid=0x402b waiting on condition [0x00007f5a87ce5000]\n   java.lang.Thread.State: WAITING (parking)\n        at sun.misc.Unsafe.park(Native Method)\n        - parking to wait for  &lt;0x00000006c58491a0&gt; (a java.util.concurrent.SynchronousQueue$TransferStack)\n        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:458)\n        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n        at java.util.concurrent.SynchronousQueue.take(SynchronousQueue.java:924)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n        at java.lang.Thread.run(Thread.java:748)\n\n 当是聚合服务（服务单元过多）的时候，这样的线程hang住很浪费资源，请问有办法解决吗？\n ","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432318,"discussion_content":"如果是聚合服务过多（一般在网关上），请使用信号量隔离，不要用线程池，否则会搞出很多线程池开销太大不可控。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544706269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34668,"user_name":"正是那朵玫瑰","can_delete":false,"product_type":"c3","uid":1048261,"ip_address":"","ucode":"73D630B654573F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg","comment_is_top":false,"comment_ctime":1540256583,"is_pvip":false,"replies":[{"id":12617,"content":"一般是以服务为单位进行隔离限流","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1540554341,"ip_address":"","comment_id":34668,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，想问下我看到线程池隔离的话是每个服务一个线程池，信号量隔离也是每个服务设置一个信号量吗？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427291,"discussion_content":"一般是以服务为单位进行隔离限流","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540554341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}