{"id":771660,"title":"02ï½œç¼–ç¨‹è¯­è¨€å…¨æ™¯å›¾ï¼ˆä¸Šï¼‰ï¼šç¼–è¯‘å™¨æ˜¯å¦‚ä½•æŠŠæºä»£ç ç¿»è¯‘æˆå­—èŠ‚ç çš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æµ·çº³ã€‚</p><p>ä»ä¸ŠèŠ‚è¯¾ç¼–ç¨‹è¯­è¨€å‘å±•çš„åŸºæœ¬å†ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œç¼–ç¨‹è¯­è¨€çš„å‘å±•ä¸ºè™šæ‹ŸæœºæŠ€æœ¯æä¾›äº†æºåŠ¨åŠ›ï¼Œè€Œè™šæ‹ŸæœºæŠ€æœ¯çš„å‘å±•åˆ™ä¸ºç¼–ç¨‹è¯­è¨€çš„å‘å±•æä¾›äº†æ ¹æœ¬ä¿éšœã€‚è™šæ‹Ÿæœºä¸­çš„å¾ˆå¤šæŠ€æœ¯æ˜¯ä¸ºäº†æ”¯æŒå¯¹åº”çš„è¯­è¨€ç‰¹æ€§æ‰è¢«å‘æ˜å‡ºæ¥çš„ï¼ŒåŒæ ·æœ‰å¾ˆå¤šå¥½ç”¨çš„è¯­è¨€ç‰¹æ€§ä¹Ÿæ˜¯å› ä¸ºè™šæ‹ŸæœºæŠ€æœ¯çš„é•¿è¶³å‘å±•æ‰å¾—ä»¥å®ç°ã€‚æ‰€ä»¥è¯´ï¼Œ<strong>ç¼–ç¨‹è¯­è¨€å’Œè™šæ‹ŸæœºæŠ€æœ¯æ˜¯ç›¸äº’ä¾èµ–å’Œå¯¹ç«‹ç»Ÿä¸€çš„</strong>ã€‚</p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬å°†åœ¨ä¸ŠèŠ‚è¯¾å†…å®¹çš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨ä¸€ä¸ªæœ€åŸºæœ¬çš„<strong>è¡¨è¾¾å¼æ±‚å€¼</strong>çš„ä¾‹å­ï¼Œæ¥è¯´æ˜ä¸€ä¸ªç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨æ˜¯å¦‚ä½•æŠŠæºä»£ç ç¿»è¯‘æˆè®¡ç®—æœºå¯ä»¥ç†è§£çš„ç»“æ„å¹¶æœ€ç»ˆæ‰§è¡Œçš„ã€‚</p><p>æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªåªåŒ…å«äº†æ•°å­—å’Œå››åˆ™è¿ç®—çš„è¡¨è¾¾å¼ï¼Œç¼–å†™ä¸€ä¸ªç¨‹åºæ¥è®¡ç®—è¿™ä¸ªè¡¨è¾¾å¼ã€‚åŸºæœ¬çš„è¿‡ç¨‹åŒ…æ‹¬è¯æ³•åˆ†æã€æ–‡æ³•åˆ†æã€ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ã€ç”Ÿæˆå­—èŠ‚ç ã€è™šæ‹Ÿæœºæ‰§è¡Œäº”ä¸ªæ­¥éª¤ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬ä¼šå®ç°å‰å››ä¸ªæ­¥éª¤ï¼Œè™šæ‹Ÿæœºæ‰§è¡Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œæˆ‘ä»¬å°†ä¼šåœ¨ç¬¬ä¸‰è®²æ·±å…¥ä»‹ç»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/01/dc/01f33b8729bb289658b79af49ca257dc.png?wh=3342x952\" alt=\"å›¾ç‰‡\"></p><h2>è¯æ³•åˆ†æ</h2><p>ç¬¬ä¸€ä¸ªæ­¥éª¤å°±æ˜¯è¦ä»æ–‡æœ¬æ–‡ä»¶ä¸­é€ä¸ªå­—ç¬¦åœ°å»è¯»å–å†…å®¹ï¼Œç„¶åæŠŠå­—ç¬¦è¯†åˆ«æˆæ•°å­—æˆ–è€…æ˜¯è¿ç®—ç¬¦ã€‚è¿™äº›æ•°å­—å’Œè¿ç®—ç¬¦æ˜¯ç»„æˆç¨‹åºçš„åŸºæœ¬å…ƒç´ ï¼Œå®ƒæœ‰ä¸€ä¸ªä¸“ç”¨çš„åå­—ï¼Œå«åštokenã€‚æŠŠæ–‡æœ¬æ–‡ä»¶ä¸­çš„ä¸€ä¸²å­—ç¬¦ï¼Œè¯†åˆ«æˆä¸€ä¸²tokenï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå‘½åä¸º test_token.txtï¼Œå…¶ä¸­åªåŒ…å«ä¸€è¡Œè¡¨è¾¾å¼ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-plain\">12 * 48 + 59\n</code></pre><p>è¿™ä¸ªè¡¨è¾¾å¼å…¶å®æ˜¯ç”±5ä¸ªtokenç»„æˆçš„ï¼Œåˆ†åˆ«æ˜¯æ•°å­—12ã€ä¹˜å·ã€æ•°å­—48ã€åŠ å·å’Œæ•°å­—59ã€‚è¿™äº› token å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šæ•°å­—å’Œæ“ä½œç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æè¿°è¿™ä¸¤ç±» tokenã€‚</p><pre><code class=\"language-plain\">NUM = [0-9]+\nOP = [\"+-*/\"]\n</code></pre><p>å…¶ä¸­ï¼ŒNUM ä»£è¡¨æ•´æ•°ï¼Œå®ƒçš„å®šä¹‰æ˜¯è‡³å°‘åŒ…å«ä¸€ä¸ª0åˆ°9ä¹‹é—´çš„ä¸€ä¸ªæ•°å­—ã€‚OP ä»£è¡¨æ“ä½œç¬¦ï¼Œæ˜¯åŠ å‡ä¹˜é™¤å››ä¸ªå­—ç¬¦ä¸­çš„ä¸€ä¸ªã€‚åœ¨å­—ç¬¦ä¸²ä¸­è¯†åˆ«æ­£åˆ™è¡¨è¾¾å¼ï¼Œæœ€å¸¸ç”¨çš„ä¸€ä¸ªåŠæ³•å°±æ˜¯ä½¿ç”¨<strong>æœ‰é™è‡ªåŠ¨æœº</strong>ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹åŒ…å«äº†è¿™ä¸¤æ¡ç®€å•è§„åˆ™çš„è‡ªåŠ¨æœºç¤ºæ„å›¾ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/5e/83/5ea648a5d7cd6fc5eca7640d57897c83.png?wh=2112x1126\" alt=\"å›¾ç‰‡\"></p><p><span class=\"reference\">æ³¨ï¼šè¿™é‡Œæˆ‘è¡¥å……ä¸€ä¸ªæœ‰é™è‡ªåŠ¨æœºçš„è®²è§£è§†é¢‘ï¼Œä½ å¯ä»¥äº†è§£å®ƒæ˜¯å¦‚ä½•å®šä¹‰ä»¥åŠå¦‚ä½•è½¬æ¢æˆç›¸åº”çš„ä»£ç ã€‚</span></p><p><video poster=\"https://media001.geekbang.org/d01ff6f9125d71ef81205017f1f80102/snapshots/b0625d4602724f319e16229d9d24c99b-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/2cf450a8-18f79f4b206-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/20858f6e125e71ef80316732b68e0102/27cc669446954f45999d2ffc4952cbfa-9640d537f6d20870dce04a6748e3e6b0-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>å°†è¿™ä¸ªæœ‰é™è‡ªåŠ¨æœºè½¬æ¢æˆç¨‹åºä»£ç æ˜¯ä¸€ç§å›ºå®šåŒ–çš„æ¨¡å¼ã€‚ç¨‹åºä¸æ–­åœ°è¯»å…¥å­—ç¬¦ï¼Œå¹¶æŠŠå…¶ä¸­çš„tokenè¯†åˆ«å‡ºæ¥ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ç›¸åº”çš„ä»£ç ã€‚</p><pre><code class=\"language-c++\">#include &lt;stdio.h&gt;\n\n#define INIT 0\n#define NUM 1\n\nint main() {\n    FILE * fp = fopen(\"test_token.txt\", \"r\");\n    char ch; \n    int state, num = 0;\n\n    while ((ch = getc(fp)) != EOF) {\n        if (ch == ' ' || ch == '\\n') {\n            if (state == NUM) {\n                printf(\"token NUM : %d\\n\", num);\n                state = INIT;\n                num = 0;\n            }   \n        }   \n\n        else if (ch &gt;= '0' &amp;&amp; ch &lt;= '9') {\n            state = NUM;\n            num = num * 10 + ch - '0';\n        }   \n\n        else if (ch == '+' || ch == '-' || ch == '*' || ch == '/') {\n\t\t    if (state == NUM) {\n                printf(\"token NUM : %d\\n\", num);\n                state = INIT;\n                num = 0;\n            }\n\n            printf(\"token operator : %c\\n\", ch);\n            state = INIT;\n        }\n\n    }\n\n    fclose(fp);\n    return 0;\n}\n</code></pre><p>å½“ç¨‹åºé‡åˆ°åŠ å‡ä¹˜é™¤æ“ä½œç¬¦çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥æ‰“å°å‡ºè¿™æ˜¯ä¸€ä¸ªæ“ä½œç¬¦ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å½“é‡åˆ°æ•°å­—çš„æ—¶å€™è¦è¿›è¡Œè½¬æ¢ï¼Œå°†å­—ç¬¦å˜æˆæ•°å­—ï¼ˆ20è‡³23è¡Œï¼‰ã€‚åœ¨æ•°å­—å­—ç¬¦ç»“æŸçš„æ—¶å€™è¦å°†æ•°å­—çš„å€¼æ‰“å°å‡ºæ¥ï¼ˆç¬¬13è‡³17è¡Œï¼Œç¬¬26è‡³30è¡Œï¼‰ã€‚</p><p>ç¨‹åºä½¿ç”¨stateå˜é‡æ¥æ ‡è¯†æ•°å­—å­—ç¬¦æ˜¯å¦ç»“æŸã€‚å½“stateçš„å€¼ä¸ºNUMæ—¶ï¼Œå°±è¡¨ç¤ºç¨‹åºæ­£åœ¨æ¥æ”¶ä¸€ä¸ªæ•°å­—ã€‚</p><p>ç¼–è¯‘å¹¶æ‰§è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š</p><pre><code class=\"language-c++\">token NUM : 12\ntoken operator : *\ntoken NUM : 48\ntoken operator : +\ntoken NUM : 59\n</code></pre><p>å¯è§ï¼Œè¿™ä¸ªç¨‹åºæ­£ç¡®åœ°å°†è¡¨è¾¾å¼ä¸­çš„å„ä¸ª token åˆ†æå‡ºæ¥äº†ã€‚</p><h2>æ–‡æ³•åˆ†æ</h2><p>ä»æ–‡æœ¬æ–‡ä»¶ä¸­åˆ†æå‡ºç¨‹åºçš„åŸºæœ¬å…ƒç´ â€”â€”tokenä»¥åï¼Œç¼–è¯‘å™¨å°±è¦å°è¯•ç€å»ç†è§£è¿™äº› token ä¹‹é—´çš„å…³ç³»äº†ã€‚</p><p>token ä¹‹é—´æ˜¯æœ‰å…¶å†…åœ¨çš„é€»è¾‘å…³ç³»çš„ï¼Œæ¯”å¦‚ï¼ŒåŠ æ³•ç¬¦å·çš„å‰åéƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¯ä»¥æ‰§è¡ŒåŠ æ³•æ“ä½œçš„ç›®æ ‡ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå˜é‡ï¼Œä½†åŠ å·åé¢å´ä¸€å®šä¸èƒ½ç´§è·Ÿä¸€ä¸ªä¹˜å·ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªä¸åˆæ³•çš„è¡¨è¾¾å¼ã€‚</p><p>ç¼–è¯‘å™¨è¦åˆ†æè¿™äº› token ç»„æˆçš„åºåˆ—æ˜¯å¦æœ‰æ„ä¹‰ï¼Œè¿™ä¸ªå·¥ä½œå°±æ˜¯ç”±æ–‡æ³•åˆ†æå®Œæˆçš„ã€‚</p><p>æ–‡æ³•åˆ†æä¸»è¦æœ‰ä¸¤å¤§ç±»ç®—æ³•ï¼Œä¸€ç§æ˜¯è‡ªé¡¶å‘ä¸‹çš„åˆ†ææ–¹æ³•ï¼Œä¸€ç§æ˜¯è‡ªåº•å‘ä¸Šçš„åˆ†ææ–¹æ³•ã€‚å…¶ä¸­ï¼Œè‡ªé¡¶å‘ä¸‹çš„åˆ†ææ–¹æ³•ç®—æ³•ç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£å’Œç¼–å†™ã€‚è€Œ yacc ç­‰æ–‡æ³•åˆ†æå·¥å…·åˆ™ä»¥è‡ªåº•å‘ä¸Šçš„ç®—æ³•ä¸ºä¸»ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯æ€§èƒ½å¥½ï¼Œè¡¨è¾¾èƒ½åŠ›å¼ºï¼Œä½†æ˜¯éš¾ä»¥è°ƒè¯•ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±ä»¥è‡ªé¡¶å‘ä¸‹çš„åˆ†ææ–¹æ³•ä¸ºä¸»ï¼Œæ¥ä»‹ç»æ–‡æ³•åˆ†æå™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p>è‡ªé¡¶å‘ä¸‹çš„åˆ†ææ–¹æ³•ä¹Ÿè¢«ç§°ä¸ºé€’å½’ä¸‹é™çš„åˆ†ææ–¹æ³•ã€‚</p><p>æ‰€è°“è½¯ä»¶è®¾è®¡ï¼Œä¸è¿‡æ˜¯æŠŠä¸€ä¸ªå¤§çš„é—®é¢˜åŒ–è§£ä¸ºä¸€ä¸ªä¸ªå°çš„é—®é¢˜ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬è®¾è®¡ä¸€ä¸ªç½‘ç«™æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯æŠŠå®ƒåˆ†æˆä¸åŒçš„æ¨¡å—ï¼Œç„¶åæ¯ä¸ªæ¨¡å—ä¸‹é¢å†è®¾è®¡å„ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œç»„ä»¶ä¸‹é¢å†è¿›è¡Œæ›´ç»†ç²’åº¦çš„åˆ’åˆ†ã€‚è¿™å°±æ˜¯ä¸€ç§ä»ä¸Šåˆ°ä¸‹çš„ä»»åŠ¡åˆ†è§£ã€‚åœ¨æ–‡æ³•åˆ†æä¸­ï¼Œæœ¬è´¨ä¸Šä¹Ÿé‡‡ç”¨äº†åŒæ ·çš„åˆ†ææ€è·¯ã€‚</p><p>ä»¥è¡¨è¾¾å¼æ±‚å€¼ä¸ºä¾‹ï¼Œæœ€é¡¶éƒ¨çš„ä»»åŠ¡ï¼Œè®¡ç®—ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆexpressionï¼‰çš„å€¼ã€‚ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯å¤šé¡¹å¼ï¼Œå®ƒæ˜¯ç”±æ¯ä¸ªé¡¹æ±‚å’Œï¼ˆå·®ä¸å’Œçš„åŸç†ä¸€æ ·ï¼Œè¿™é‡Œä¸ºäº†æè¿°æ–¹ä¾¿åªè¯´å’Œçš„æƒ…å†µï¼‰å¾—åˆ°çš„ã€‚æ‰€ä»¥ï¼Œä¸€ä¸ªexpressionå°±å¯ä»¥å®šä¹‰ä¸ºï¼š</p><pre><code class=\"language-c++\">expression := term + term + ... + term\n</code></pre><p>ç­‰å¼å³è¾¹çš„ term æ˜¯ä¸€ä¸ªæ±‚å’Œå¼ä¸­çš„å„ä¸ªåŠ æ•°ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå¤šé¡¹å¼ 2 + 3 * 4 + 5ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªå¼å­çœ‹æˆ 2 ä¸ 3 * 4 ä¸ 5 çš„æ±‚å’Œã€‚å…¶ä¸­ï¼Œ2 æ˜¯ä¸€ä¸ªtermï¼Œ3 * 4 ä¹Ÿæ˜¯ä¸€ä¸ªtermï¼Œ5 ä¹Ÿæ˜¯ä¸€ä¸ª termã€‚</p><p>åŒæ ·çš„æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨æ¥æ‹†åˆ† termã€‚term å¯ä»¥çœ‹æˆæ˜¯å¤šä¸ªå› å­çš„ç§¯ã€‚æ‰€ä»¥term å°±å¯ä»¥å®šä¹‰ä¸ºï¼š</p><pre><code class=\"language-c++\">term := factor * factor ... * factor\n</code></pre><p>å·¦è¾¹çš„ term æ˜¯ä¸€ä¸ªè§„æ¨¡æ¯”è¾ƒå¤§çš„ç§¯ï¼Œè€Œå³è¾¹çš„ä¸€ä¸ª factor åˆ™ä»£è¡¨äº†ä¸€ä¸ªå› å­ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠ term è¿™ä¸ªç»“æ„æ‹†æˆäº†è§„æ¨¡æ›´å°çš„å› å­äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­å®šä¹‰ factorã€‚</p><pre><code class=\"language-c++\">facotr := NUMBER | (expression)\n</code></pre><p>ç­‰å¼å³è¾¹çš„ä¸­é—´ç«–çº¿è¡¨ç¤ºâ€œæˆ–â€çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª factor å¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°ï¼ˆNUMBERï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåŒ…åœ¨ä¸€å¯¹æ‹¬å·é‡Œçš„è¡¨è¾¾å¼ã€‚åè¿‡æ¥è¯´ï¼Œå½“é‡åˆ°ä¸€ä¸ªæ•´æ•°ï¼Œå°±å¯ä»¥è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ª factorã€‚æˆ–è€…ç”¨æ‹¬å·æ‹¬èµ·æ¥çš„è¡¨è¾¾å¼ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª factorã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¡¨è¾¾å¼çš„æ–‡æ³•éœ€è¦å…ˆä½¿ç”¨ term å»è§£æ„ expressionï¼Œå†ä½¿ç”¨ factor å»è§£æ„ termï¼Œæœ€å factor è¿˜è¦ expression å»è§£æ„ï¼Œç»•äº†ä¸€åœˆåˆå›æ¥äº†ã€‚<strong>è¿™ç§ç”¨è‡ªå·±çš„å®šä¹‰æ¥å®šä¹‰è‡ªå·±çš„æƒ…å†µå°±æ˜¯é€’å½’ã€‚</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/cc/d2/ccfa870a1eb9a2bdd1c9ed5d0cf222d2.png?wh=2002x1020\" alt=\"å›¾ç‰‡\"></p><p>ä½†æ˜¯é€’å½’ä¸èƒ½æ²¡æœ‰ç»ˆç‚¹ï¼Œè¦ä½¿é€’å½’çš„å®šä¹‰å˜å¾—å®Œæ•´ï¼Œå°±å¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ã€‚</p><ol>\n<li>å­é—®é¢˜å¿…é¡»å’ŒåŸå§‹é—®é¢˜æ˜¯åŒæ ·æ€§è´¨çš„ï¼Œè€Œä¸”è§„æ¨¡è¦æ›´å°ã€æ›´ç®€å•ã€‚</li>\n<li>ä¸èƒ½æ— é™åˆ¶åœ°è°ƒç”¨æœ¬èº«ï¼Œå¿…é¡»æœ‰ä¸ªå‡ºå£ï¼ŒåŒ–ç®€ä¸ºéé€’å½’çŠ¶å†µå¤„ç†ã€‚</li>\n</ol><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œå­é—®é¢˜çš„è§„æ¨¡æ˜¯ä¸æ–­ç¼©å°çš„ï¼Œè¿™ä¸€ç‚¹æ²¡æœ‰é—®é¢˜ã€‚ç¬¬2ç‚¹ï¼Œå¿…é¡»æœ‰ä¸ªå‡ºå£ï¼Œè¿™ä¸ªå‡ºå£æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å°±æ˜¯<strong>factorçš„å®šä¹‰</strong>ï¼Œå½“é—®é¢˜æ‹†åˆ°åªæœ‰ä¸€ä¸ªæ•´æ•°çš„æ—¶å€™ï¼Œé€’å½’å°±ä¼šç»ˆæ­¢ï¼Œä¹Ÿå°±æ˜¯æ¡ä»¶2ä¸­æ‰€è¯´çš„å‡ºå£ã€‚</p><p>è¿™å‡ æ¡è§„åˆ™ä¸€èµ·ç»„æˆäº†è¡¨è¾¾å¼æ±‚å€¼çš„<strong>æ–‡æ³•</strong>ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸ªæ–‡æ³•è½¬æ¢æˆç¨‹åºï¼ˆèŠ‚é€‰è‡ªparser.cppï¼‰ã€‚</p><pre><code class=\"language-plain\">// è¿™é‡Œåªè¦å¯¹ç…§ expression çš„å®šä¹‰å®ç°å°±å¯ä»¥äº†\n// expression := term ï¼ˆ+|- term)*\nint Parser::expression() {\n    // å¯¹åº”ç¬¬ä¸€ä¸ª term\n&nbsp; &nbsp; int a = term();\n&nbsp; &nbsp; Token* op = get_token();\n\n    // å¤šä¸ª term å¯ä»¥å¯¹åº” while è¯­å¥\n&nbsp; &nbsp; while (op != NULL &amp;&amp;\n&nbsp; &nbsp; &nbsp; &nbsp; (op-&gt;_tt == T_PLUS || op-&gt;_tt == T_MINUS)) {\n&nbsp; &nbsp; &nbsp; &nbsp; consume();\n&nbsp; &nbsp; &nbsp; &nbsp; int b = term();\n&nbsp; &nbsp; &nbsp; &nbsp; if (op-&gt;_tt == T_PLUS) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = a + b;\n&nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = a - b;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n\n&nbsp; &nbsp; &nbsp; &nbsp; op = get_token();\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; return a;\n}\n\n// term := factor ((*|/) factor) *\nint Parser::term() {\n&nbsp; &nbsp; int a = factor();\n&nbsp; &nbsp; Token* op = get_token();\n&nbsp; &nbsp; while (op != NULL &amp;&amp;\n&nbsp; &nbsp; &nbsp; &nbsp; (op-&gt;_tt == T_MULT || op-&gt;_tt == T_DIV)) {\n&nbsp; &nbsp; &nbsp; &nbsp; consume();\n&nbsp; &nbsp; &nbsp; &nbsp; int b = factor();\n&nbsp; &nbsp; &nbsp; &nbsp; if (op-&gt;_tt == T_MULT) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = a * b;\n&nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a = a / b;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n\n&nbsp; &nbsp; &nbsp; &nbsp; op = get_token();\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; return a;\n}\n\n// factor := INT | (expression)\nint Parser::factor() {\n&nbsp; &nbsp; Token* data = get_token();\n&nbsp; &nbsp; if (data-&gt;_tt == T_INT) {\n&nbsp; &nbsp; &nbsp; &nbsp; consume();\n&nbsp; &nbsp; &nbsp; &nbsp; return stoi(data);\n&nbsp; &nbsp; }\n&nbsp; &nbsp; else if (data-&gt;_tt == T_LEFT_PAR) {\n&nbsp; &nbsp; &nbsp; &nbsp; match(T_LEFT_PAR);\n&nbsp; &nbsp; &nbsp; &nbsp; int a = expression();\n&nbsp; &nbsp; &nbsp; &nbsp; match(T_RIGHT_PAR);\n\n&nbsp; &nbsp; &nbsp; &nbsp; return a;\n&nbsp; &nbsp; }\n&nbsp; &nbsp; return -1;\n}\n\n// å°†å­—ç¬¦ä¸²è½¬æ¢æˆæ•°å­—\nint Parser::stoi(Token* data) {\n&nbsp; &nbsp; int value = 0;\n&nbsp; &nbsp; for (int i = 0; i &lt; data-&gt;_length; i++) {\n&nbsp; &nbsp; &nbsp; &nbsp; value = value * 10 + data-&gt;_value[i] - '0';\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; return value;\n}\n\nint Parser::eval() {\n&nbsp; &nbsp; printf(\"%d\\n\", expression());\n\n&nbsp; &nbsp; return 0;\n}\n</code></pre><p>ä»£ç é‡Œå®šä¹‰è¿™æ ·ä¸‰ä¸ªå‡½æ•°ï¼šexpressionã€termã€factorã€‚expressionè¡¨ç¤ºå¯¹è¡¨è¾¾å¼æ±‚å€¼ï¼Œtermè¡¨ç¤ºå¯¹è¡¨è¾¾å¼ä¸­çš„æŸä¸€é¡¹æ±‚å€¼ï¼Œfactorè¡¨ç¤ºå¯¹æŸä¸€ä¸ªå› å­æ±‚å€¼ã€‚</p><p>expression å‡½æ•°é‡Œçš„ä¸»è¦ç»“æ„å°±æ˜¯ while å¾ªç¯ï¼Œç”¨äºå¤„ç†å¤šä¸ªåŠ å·å’Œå‡å·çš„æƒ…å†µã€‚é‡åˆ°ä¸€ä¸ªåŠ å·ä»¥åï¼Œå°±ä¼šè°ƒç”¨ term å‡½æ•°å»å¤„ç†å¤šé¡¹å¼ä¸­çš„æŸä¸€é¡¹ã€‚term å‡½æ•°çš„ç»“æ„ä¸ expression å‡½æ•°çš„ç»“æ„æ˜¯ç›¸åŒçš„ã€‚factor å‡½æ•°åˆ™ä½¿ç”¨äº†åˆ†æ”¯ç»“æ„æ¥åŒºåˆ†æ•°å­—ï¼ˆç¬¬48è¡Œï¼‰å’Œå°æ‹¬å·ï¼ˆç¬¬52è¡Œï¼‰ä¸¤ç§æƒ…å†µã€‚</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä» expression ä¸‹é™åˆ° termï¼Œå†ä¸‹é™åˆ° factorï¼Œæœ‰æ˜æ˜¾çš„è‡ªä¸Šè€Œä¸‹çš„è§£æè¿‡ç¨‹ã€‚æ‰€ä»¥è¿™ç§æ–¹å¼å°±è¢«ç§°ä¸ºè‡ªä¸Šè€Œä¸‹çš„é€’å½’ä¸‹é™å¼æ–‡æ³•åˆ†æã€‚</p><p>ä¸Šè¿°ä»£ç ä¸ä¸‰æ¡æ–‡æ³•è§„åˆ™çš„å¯¹åº”å…³ç³»ååˆ†æ˜æ˜¾ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å°±ä¸å†è¿‡å¤šåœ°åˆ†æä»£ç çš„å®ç°äº†ã€‚è¿™æ®µä»£ç åœ¨æ‰§è¡Œçš„æ—¶å€™å°±ç›´æ¥æŠŠè¡¨è¾¾å¼çš„å€¼æ±‚å‡ºæ¥ï¼Œå¹¶ä¸”æ‰“å°åœ¨å±å¹•ä¸Šäº†ã€‚ä¸€ä¸ªçœŸå®çš„ç¼–è¯‘å™¨åœ¨å·¥ä½œçš„æ—¶å€™æ˜¯ä¸ä¼šæ‰§è¡Œæºä»£ç çš„ï¼Œå®ƒåªè´Ÿè´£å°†æºä»£ç è½¬æ¢æˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥ä»‹ç»ä¸€ä¸‹æŠ½è±¡è¯­æ³•æ ‘çš„ç»“æ„å’Œå·¥ä½œåŸç†ã€‚</p><h2>æŠ½è±¡è¯­æ³•æ ‘</h2><p>æŠ½è±¡è¯­æ³•æ ‘å¯¹ç¼–è¯‘å™¨æœ‰éåŒå¯»å¸¸çš„æ„ä¹‰ï¼Œå¤§å¤šæ•°ç¼–è¯‘å™¨éƒ½ä¼šå®ç°æŠ½è±¡è¯­æ³•æ ‘è¿™ä¸ªæ•°æ®ç»“æ„ã€‚è¿™æ˜¯å› ä¸ºè¯­æ³•æ ‘åœ¨è¡¨è¾¾ç¨‹åºç»“æ„æ–¹é¢æœ‰éå¸¸ç›´è§‚çš„å½¢å¼ã€‚ä¾‹å¦‚ï¼Œ12 * 48 + 59 çš„æŠ½è±¡è¯­æ³•æ ‘å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1e/3c/1ea8133850ebb83f94bf8bcf0877633c.png?wh=1630x984\" alt=\"å›¾ç‰‡\"></p><p>æŠ½è±¡è¯­æ³•æ ‘æœ‰å¾ˆå¤šä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ååºéå†è¯­æ³•æ ‘æ¥å¯¹è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ï¼Œä¹Ÿå¯ä»¥åœ¨è¯­æ³•æ ‘ä¸Šåšå¾ˆå¤šæ€§èƒ½ä¼˜åŒ–çš„å·¥ä½œï¼Œè¿˜å¯ä»¥é€šè¿‡æŠ½è±¡è¯­æ³•æ ‘æ¥ç”Ÿæˆå­—èŠ‚ç ã€‚æ¥ä¸‹æ¥çš„ä¾‹å­å°†ä¼šå±•ç¤ºå¦‚ä½•é€šè¿‡è¯­æ³•æ ‘äº§ç”Ÿå­—èŠ‚ç ã€‚</p><p>åœ¨æ–‡æ³•åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸ç›´æ¥è®¡ç®—è¡¨è¾¾å¼çš„å€¼ï¼Œè€Œæ˜¯å°†æ¯ä¸€ä¸ªåˆ†æç»“æœè½¬åŒ–æˆä¸€ä¸ªè¯­æ³•æ ‘å†…éƒ¨èŠ‚ç‚¹ï¼Œå°±å¯ä»¥åœ¨æ–‡æ³•åˆ†æè¿‡ç¨‹ä¸­æ„å»ºè¯­æ³•æ ‘äº†ã€‚</p><p>é¦–å…ˆï¼Œå®šä¹‰å¥½æŠ½è±¡è¯­æ³•æ ‘çš„å„ä¸ªç»“ç‚¹çš„ç»“æ„ã€‚</p><pre><code class=\"language-c++\">class Node {\npublic:\n&nbsp; &nbsp; virtual void accept(Visitor* v) = 0;\n};\n\nenum OpType {\n&nbsp; &nbsp; AST_OP_ADD,\n&nbsp; &nbsp; AST_OP_SUB,\n&nbsp; &nbsp; AST_OP_MUL,\n&nbsp; &nbsp; AST_OP_DIV,\n&nbsp; &nbsp; AST_OP_MOD,\n};\n\nclass BinaryOp : public Node {\nprotected:\n&nbsp; &nbsp; OpType _op_type;\n&nbsp; &nbsp; Node* _left;\n&nbsp; &nbsp; Node* _right;\n\npublic:\n&nbsp; &nbsp; BinaryOp(OpType op_type, Node* left, Node* right) :\n&nbsp; &nbsp; &nbsp; &nbsp; _op_type(op_type), _left(left), _right(right) {\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; virtual void accept(Visitor* v);\n\n&nbsp; &nbsp; void set_left(Node* left);\n&nbsp; &nbsp; void set_right(Node* right);\n\n&nbsp; &nbsp; OpType op_type()&nbsp; &nbsp; { return _op_type; }\n&nbsp; &nbsp; Node* left()&nbsp; &nbsp; &nbsp; &nbsp; { return _left; }\n&nbsp; &nbsp; Node* right()&nbsp; &nbsp; &nbsp; &nbsp;{ return _right; }\n};\n\nclass ConstInt : public Node {\npublic:\n&nbsp; &nbsp; int _value;\n\n&nbsp; &nbsp; ConstInt(int v) : _value(v) {}\n\n&nbsp; &nbsp; virtual void accept(Visitor* v);\n};\n</code></pre><p>æŠ½è±¡è¯­æ³•æ ‘ç»“ç‚¹ç±»ä¸­çš„ accept æ–¹æ³•æ˜¯ä¸ºäº†å®ç°è®¿é—®è€…æ¨¡å¼è€Œå®šä¹‰çš„ã€‚åŒæ—¶ï¼Œä¿®æ”¹æ–‡æ³•åˆ†æçš„å®ç°ï¼Œè®©æ–‡æ³•åˆ†æçš„ç»“æœè¿”å›è¯­æ³•æ ‘ç»“ç‚¹ã€‚</p><pre><code class=\"language-c++\">Node* Parser::expression() {\n    Node* a = term();\n    Token* op = get_token();\n    while (op != NULL &amp;&amp;\n        (op-&gt;_tt == T_PLUS || op-&gt;_tt == T_MINUS)) {\n        consume();\n        Node* b = term();\n        if (op-&gt;_tt == T_PLUS) {\n            a = new BinaryOp(AST_OP_ADD, a, b);\n        } else {\n            a = new BinaryOp(AST_OP_SUB, a, b);\n        }\n\n        op = get_token();\n    }\n\n    return a;\n}\n\nNode* Parser::term() {\n    Node* a = factor();\n    Token* op = get_token();\n    while (op != NULL &amp;&amp;\n        (op-&gt;_tt == T_MULT || op-&gt;_tt == T_DIV)) {\n        consume();\n        Node* b = factor();\n        if (op-&gt;_tt == T_MULT) {\n            a = new BinaryOp(AST_OP_MUL, a, b);\n        } else {\n            a = new BinaryOp(AST_OP_DIV, a, b);\n        }\n\n        op = get_token();\n    }\n\n    return a;\n}\n\nNode* Parser::factor() {\n    Token* data = get_token();\n    if (data-&gt;_tt == T_INT) {\n        consume();\n        return new ConstInt(stoi(data));\n    }\n    else if (data-&gt;_tt == T_LEFT_PAR) {\n        match(T_LEFT_PAR);\n        Node* a = expression();\n        match(T_RIGHT_PAR);\n\n        return a;\n    }\n    return NULL;\n}\n</code></pre><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œé‡æ–°ç¼–è¯‘è¿è¡Œæ•´ä¸ªé¡¹ç›®ï¼Œå°±å¯ä»¥æ­£ç¡®åœ°å¾—åˆ°æŠ½è±¡è¯­æ³•æ ‘äº†ã€‚æˆ‘ä»¬è¯¾ç¨‹æ‰€é™„å¸¦çš„ä»£ç ä»“é‡Œæä¾›äº†ä¸€ä¸ªä½¿ç”¨è®¿é—®è€…æ¨¡å¼å®ç°çš„Dumperå·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨æ ‘å½¢ç»“æ„æ‰“å°ä¸€ä¸ªè¡¨è¾¾å¼çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œä½ å¯ä»¥è‡ªå·±çœ‹ä¸€çœ‹ã€‚</p><h2>ç”Ÿæˆå­—èŠ‚ç </h2><p>å¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œä¸€æ¬¡ååºéå†å°±å¯ä»¥ç”ŸæˆåŸºäºæ ˆçš„å­—èŠ‚ç ã€‚å¦‚æœä½ å¯¹äºŒå‰æ ‘çš„éå†æ¯”è¾ƒäº†è§£çš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚</p><p>ç¬¬ä¸€èŠ‚è¯¾æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº†ï¼Œ<strong>å­—èŠ‚ç çš„æœ¬è´¨æ˜¯ä¸€ä¸ªè™šæ‹ŸæŒ‡ä»¤é›†</strong>ï¼Œå®ƒé‡Œé¢çš„æ¯æ¡æŒ‡ä»¤ä»£è¡¨ä¸€ç§æ“ä½œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè™šæ‹Ÿæœºçš„è™šæ‹ŸæŒ‡ä»¤é›†åŒ…å«çš„æŒ‡ä»¤æ•°ä¸ä¼šè¶…è¿‡ 256ï¼Œä¸€ä¸ªå­—èŠ‚å°±è¶³å¤Ÿç¼–ç å…¨éƒ¨çš„æŒ‡ä»¤äº†ï¼Œæ‰€ä»¥äººä»¬æŠŠè¿™ç§è™šæ‹ŸæŒ‡ä»¤é›†å«åšå­—èŠ‚ç ã€‚</p><p>ä½œä¸ºç¤ºä¾‹ï¼Œè™šæ‹ŸæŒ‡ä»¤çš„ç¼–ç å¯ä»¥ä»»æ„å®šä¹‰ï¼Œä¾‹å¦‚ï¼š</p><pre><code class=\"language-c++\">#define BINARY_MUL      20\n#define BINARY_DIV      21\n#define BINARY_ADD\t    23\n#define BINARY_SUB      24\n\n#define LOAD_CONST\t100\n</code></pre><p>å°±åƒç¬¬ä¸€èŠ‚è¯¾å±•ç¤ºçš„åŸºäºæ ˆçš„è™šæ‹Ÿæœºçš„è®¡ç®—è¿‡ç¨‹ï¼ŒBINARY_ADDè¿™å››ä¸ªäºŒå…ƒæ“ä½œç¬¦çš„æ“ä½œæ•°éƒ½åœ¨æ ˆä¸Šã€‚æ‰§è¡ŒBINARY_ADDæ—¶ï¼Œè™šæ‹Ÿæœºä¼šä»æ“ä½œæ•°æ ˆé¡¶ä¸Šå–ä¸¤ä¸ªæ•°å­—ï¼Œæ±‚å’Œï¼Œç„¶åå°†å’Œå†é€å…¥æ ˆé¡¶ã€‚è€ŒLOAD_CONSTçš„ä½œç”¨åˆ™æ˜¯å°†æ•°å­—åŠ è½½åˆ°æ ˆé¡¶ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå†å¼•å…¥ä¸€ä¸ªæ–°çš„è®¿é—®è€…PrintVisitorï¼Œç”¨äºæ‰“å°å­—èŠ‚ç åŠ©è®°ç¬¦ã€‚è¿™é‡Œä½¿ç”¨å­—ç¬¦ä¸²å°†å­—èŠ‚ç çš„åŠ©è®°ç¬¦æ‰“å°å‡ºæ¥ï¼Œå¹¶ä¸æ˜¯ç›´æ¥å°†è™šæ‹Ÿæœºå¯ä»¥æ‰§è¡Œçš„è™šæ‹ŸæŒ‡ä»¤æ‰“å°å‡ºæ¥ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰ï¼š</p><pre><code class=\"language-c++\">// visitor.hpp\nclass PrintVisitor : public Visitor {\npublic:\n    PrintVisitor() {}\n\n    void visit(Node* n);\n\n    virtual void visit(BinaryOp* n);\n    virtual void visit(ConstInt* n);\n};\n\n// visitor.cpp\nvoid PrintVisitor::visit(Node* n) {\n    n-&gt;accept(this);\n}\n\nvoid PrintVisitor::visit(BinaryOp* op) {\n    visit(op-&gt;left());\n    visit(op-&gt;right());\n\n    switch(op-&gt;op_type()) {\n    case AST_OP_ADD:\n        printf(\"BINARY_ADD\\n\");\n        break;\n    case AST_OP_SUB:\n        printf(\"BINARY_SUB\\n\");\n        break;\n    case AST_OP_MUL:\n        printf(\"BINARY_MUL\\n\");\n        break;\n    case AST_OP_DIV:\n        printf(\"BINARY_DIV\\n\");\n        break;\n    default:\n        printf(\"Unknown binary op %d\\n\", op-&gt;op_type());\n        return;\n    }\n\n}\n\nvoid PrintVisitor::visit(ConstInt* n) {\n    printf(\"LOAD_CONST\\t%d\\n\", n-&gt;_value);\n}\n</code></pre><p>ä½¿ç”¨ PrintVisitor æ¥è®¿é—®æŠ½è±¡è¯­æ³•æ ‘æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²çš„æ–¹å¼å°†å­—èŠ‚ç å±•ç¤ºå‡ºæ¥ã€‚ç¼–è¯‘è¿è¡Œçš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">LOAD_CONST&nbsp; &nbsp; &nbsp; 12\nLOAD_CONST&nbsp; &nbsp; &nbsp; 48\nBINARY_MUL\nLOAD_CONST&nbsp; &nbsp; &nbsp; 59\nBINARY_ADD\n</code></pre><p>å¦‚æœæƒ³çœŸæ­£åœ°ç”Ÿæˆå­—èŠ‚ç ï¼Œå°±æŠŠå­—ç¬¦ä¸²çš„æ–¹å¼æ”¹æˆå­—èŠ‚ç çš„æ–¹å¼å³å¯ã€‚è¿™é‡Œå¼•å…¥ä¸€ä¸ªæ–°çš„è®¿é—®è€… CodeGenï¼Œç”¨äºåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€æ®µçœŸæ­£çš„å¯ä¾›è™šæ‹Ÿæœºæ‰§è¡Œçš„è™šæ‹ŸæŒ‡ä»¤ä¸²ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚ç ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„æ ¸å¿ƒä»£ç ã€‚</p><pre><code class=\"language-c++\">void CodeGen::add_op(unsigned char op_code, unsigned char param) {\n&nbsp; &nbsp; _insts.push_back(op_code);\n&nbsp; &nbsp; if (op_code &gt; HAVE_ARGUMENT) {\n&nbsp; &nbsp; &nbsp; &nbsp; _insts.push_back(param);\n&nbsp; &nbsp; }\n}\n\nvoid CodeGen::visit(BinaryOp* op) {\n&nbsp; &nbsp; visit(op-&gt;left());\n&nbsp; &nbsp; visit(op-&gt;right());\n\n&nbsp; &nbsp; switch(op-&gt;op_type()) {\n&nbsp; &nbsp; case AST_OP_ADD:\n&nbsp; &nbsp; &nbsp; &nbsp; add_op(BINARY_ADD);\n&nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; case AST_OP_SUB:\n&nbsp; &nbsp; &nbsp; &nbsp; add_op(BINARY_SUB);\n&nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; case AST_OP_MUL:\n&nbsp; &nbsp; &nbsp; &nbsp; add_op(BINARY_MUL);\n&nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; case AST_OP_DIV:\n&nbsp; &nbsp; &nbsp; &nbsp; add_op(BINARY_DIV);\n&nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; default:\n&nbsp; &nbsp; &nbsp; &nbsp; printf(\"Unknown binary op %d\\n\", op-&gt;op_type());\n&nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; }\n}\n\nvoid CodeGen::visit(ConstInt* n) {\n&nbsp; &nbsp; add_op(LOAD_CONST, n-&gt;_value);\n}\n</code></pre><p>CodeGenç±»çš„ä½œç”¨æ˜¯è®°å½•å­—èŠ‚ç ï¼Œ_instæ˜¯ä¸€ä¸ª char ç±»å‹çš„ vectorã€‚add_op æ–¹æ³•æ˜¯å°†ä¸€ä¸ªæŒ‡ä»¤æ·»åŠ åˆ°å­—èŠ‚ç å‘é‡é‡Œã€‚</p><p>HAVE_ARGUMENT æ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„å®ï¼ˆç¬¬3è¡Œï¼‰ï¼Œå®ƒçš„å€¼æ˜¯ 90ï¼Œå¦‚æœæŒ‡ä»¤ç¼–å·å°äº 90ï¼Œå°±ä»£è¡¨è¿™ä¸ªæŒ‡ä»¤æ²¡æœ‰å‚æ•°ï¼Œå¦åˆ™è¿™ä¸ªæŒ‡ä»¤å°±å¸¦æœ‰å‚æ•°ã€‚</p><p>ä¸¤ä¸ªæ ¸å¿ƒçš„ visit æ–¹æ³•ï¼ˆç¬¬ 8 è¡Œå’Œç¬¬ 31 è¡Œï¼‰ï¼ŒåŸºæœ¬é€»è¾‘å’Œ PrintVisitor ç›¸åŒï¼Œéƒ½æ˜¯å¯¹è¯­æ³•æ ‘è¿›è¡Œååºéå†ã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ C++ è¯­è¨€æˆåŠŸå®ç°äº†ä¸€ä¸ªç®€å•çš„è¡¨è¾¾å¼çš„ç¼–è¯‘å™¨ï¼ŒåŒ…å«äº†è¯æ³•åˆ†æã€æ–‡æ³•åˆ†æã€å­—èŠ‚ç ç”Ÿæˆç­‰æ­¥éª¤ï¼Œéº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚åé¢ä¸æ–­åœ°æ–°å¢å„ç§è¯­æ³•ç‰¹æ€§ï¼Œå®é™…ä¸Šä¹Ÿä¸è¿‡æ˜¯åœ¨è¿™ä¸ªå¤§æ¡†æ¶ä¸Šæ·»ç –åŠ ç“¦ã€‚ç†è§£äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æŒæ¡äº†ç¼–è¯‘å™¨çš„åŸºæœ¬å·¥ä½œåŸç†ã€‚</p><h2>æ€»ç»“</h2><p>æºä»£ç æ˜¯ç”±äººç¼–å†™ï¼Œä¾›äººé˜…è¯»å’Œç»´æŠ¤çš„ï¼Œè®¡ç®—æœºå¹¶ä¸è®¤è¯†å®ƒã€‚è®¡ç®—æœºèƒ½ç†è§£çš„æ˜¯æœºå™¨æŒ‡ä»¤ï¼ŒæŠŠæºä»£ç ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤å°±æ˜¯ç¼–è¯‘å™¨çš„æ ¸å¿ƒåŠŸèƒ½ã€‚ä¸€ä¸ªç”±è¯­è¨€è™šæ‹Ÿæœºæ”¯æŒçš„åŠ¨æ€è¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œå…¶ä¸»è¦çš„å·¥ä½œæµç¨‹åŒ…å«äº†è¯æ³•åˆ†æã€æ–‡æ³•åˆ†æã€ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ã€ç”Ÿæˆå­—èŠ‚ç ä»¥åŠæ‰§è¡Œå­—èŠ‚ç ç­‰è¿‡ç¨‹ã€‚</p><p>è¯æ³•åˆ†æçš„ä¸»è¦ä½œç”¨æ˜¯å°†å­—ç¬¦åˆ’åˆ†æˆä¸€ä¸ªä¸ªæœ‰æ„ä¹‰çš„å•è¯ï¼Œè¿™äº›å•è¯ç»Ÿç§°ä¸º tokenï¼Œè¯æ³•åˆ†æç»å¸¸ä½¿ç”¨<strong>æœ‰é™è‡ªåŠ¨æœº</strong>ä½œä¸ºä¸»è¦çš„å®ç°æ‰‹æ®µã€‚æ–‡æ³•åˆ†æçš„ä½œç”¨æ˜¯åˆ†æ token ä¹‹é—´çš„æœ‰æœºè”ç³»ï¼Œè¿›è€Œè¯†åˆ«å‡ºæŠ½è±¡è¯­æ³•æ ‘ç»“æ„ã€‚å®ƒæœ‰ä¸¤å¤§ç±»é‡è¦çš„åˆ†ææ‰‹æ®µï¼Œåˆ†åˆ«æ˜¯è‡ªé¡¶å‘ä¸‹çš„é€’å½’ä¸‹é™åˆ†ææ³•å’Œè‡ªåº•å‘ä¸Šçš„åˆ†ææ³•ã€‚è‡ªé¡¶å‘ä¸‹çš„åˆ†ææ³•ç®€å•ç›´è§‚ï¼Œæ‰€ä»¥æ˜¯æˆ‘ä»¬è¿™èŠ‚è¯¾é‡ç‚¹ä»‹ç»çš„å†…å®¹ã€‚</p><p>ä½¿ç”¨<strong>è®¿é—®è€…æ¨¡å¼</strong>æ“ä½œæŠ½è±¡è¯­æ³•æ ‘æ˜¯ä¸€ç§å¸¸ç”¨çš„æ‰‹æ®µï¼Œå¯¹æŠ½è±¡è¯­æ³•æ ‘çš„ååºéå†å¯ä»¥äº§ç”Ÿå­—èŠ‚ç ï¼Œåœ¨ç”Ÿæˆå­—èŠ‚ç ä»¥åï¼Œè™šæ‹Ÿæœºå°±å¯ä»¥æ‰§è¡Œè¿™äº›å­—èŠ‚ç äº†ã€‚ä¸‹ä¸€èŠ‚è¯¾æˆ‘ä»¬å°±ä¼šé€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„è™šæ‹Ÿæœºæ¥è¯´æ˜å­—èŠ‚ç æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ã€‚</p><p><span class=\"reference\">æ³¨ï¼šç‚¹å‡»é“¾æ¥æŸ¥çœ‹<a href=\"https://gitee.com/hinus/pythonvm/tree/geektime/\">è¯¾ç¨‹ä»£ç åœ°å€</a></span></p><h2>æ€è€ƒé¢˜</h2><p>å¦‚æœä¸ºè¿™èŠ‚è¯¾çš„æ–‡æ³•å¼•å…¥å˜é‡çš„è¯ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿåªéœ€è¦è€ƒè™‘å˜é‡å‡ºç°åœ¨è¡¨è¾¾å¼å³å¯ï¼Œä¸ç”¨è€ƒè™‘å˜é‡æ˜¯å¦‚ä½•å®šä¹‰å’Œèµ‹åˆå€¼çš„ã€‚æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":390429,"user_name":"lightwolf","can_delete":false,"product_type":"c1","uid":3229927,"ip_address":"å®‰å¾½","ucode":"9F4E0F742C174D","user_header":"https://static001.geekbang.org/account/avatar/00/31/48/e7/958b7e6c.jpg","comment_is_top":false,"comment_ctime":1715324551,"is_pvip":false,"replies":[{"id":142049,"content":"ğŸ‘ï¼Œprattç®—æ³•ç”¨äºå¤„ç†è‡ªå®šä¹‰çš„ä¸­ç¼€è¿ç®—ç¬¦éå¸¸æœ‰æ•ˆã€‚å®ƒè¦è€ƒè™‘è¿ç®—ç¬¦ä¼˜å…ˆçº§ã€‚ã€Šcrafting interpreterã€‹è¿™æœ¬ä¹¦å¯ä»¥å‚è€ƒ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1360512,"ctime":1715562344,"ip_address":"ä¸Šæµ·","comment_id":390429,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"æˆ‘è§‰å¾—prattç®—æ³•æ˜¯parseäºŒå…ƒè¡¨è¾¾å¼æœ€å¥½çš„ç®—æ³•ï¼Œç‰¹åˆ«å¥½ç”¨ğŸ˜„","like_count":4,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644844,"discussion_content":"ğŸ‘ï¼Œprattç®—æ³•ç”¨äºå¤„ç†è‡ªå®šä¹‰çš„ä¸­ç¼€è¿ç®—ç¬¦éå¸¸æœ‰æ•ˆã€‚å®ƒè¦è€ƒè™‘è¿ç®—ç¬¦ä¼˜å…ˆçº§ã€‚ã€Šcrafting interpreterã€‹è¿™æœ¬ä¹¦å¯ä»¥å‚è€ƒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715562344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390529,"user_name":"æœç²’æ©™","can_delete":false,"product_type":"c1","uid":1272730,"ip_address":"æ±Ÿè‹","ucode":"000B15E28C68B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/6b/9a/786b1ed8.jpg","comment_is_top":false,"comment_ctime":1715568949,"is_pvip":false,"replies":[{"id":142056,"content":"https:&#47;&#47;gitee.com&#47;hinus&#47;pythonvm&#47;tree&#47;geektime&#47;ã€‚è®°å¾—åŠ å…¥å¾®ä¿¡ç¾¤ã€‚åŠæ—¶è·å–æœ€æ–°çš„ç›´æ’­ç­”ç–‘ä¿¡æ¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1360512,"ctime":1715613074,"ip_address":"æµ™æ±Ÿ","comment_id":390529,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"giteeé‡Œé¢æ€ä¹ˆæ‰¾æ¯ä¸€è¯¾å¯¹åº”çš„ä»£ç ï¼Œæœ€å¥½èƒ½æŒ‰ç…§è¯¾æ—¶åˆ†ç±»ã€‚","like_count":1,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644930,"discussion_content":"https://gitee.com/hinus/pythonvm/tree/geektime/ã€‚è®°å¾—åŠ å…¥å¾®ä¿¡ç¾¤ã€‚åŠæ—¶è·å–æœ€æ–°çš„ç›´æ’­ç­”ç–‘ä¿¡æ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715613074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390493,"user_name":"Triple tree","can_delete":false,"product_type":"c1","uid":3889514,"ip_address":"æµ™æ±Ÿ","ucode":"4A9A6ABCA167B5","user_header":"https://static001.geekbang.org/account/avatar/00/3b/59/6a/ac154bfe.jpg","comment_is_top":false,"comment_ctime":1715488482,"is_pvip":false,"replies":[{"id":142054,"content":"ğŸ‘ï¼Œå¯ä»¥ï¼Œå¯ä»¥ã€‚æµ‹è¯•ç”¨ä¾‹çš„æœ€ååŠ ä¸€ä¸ªæ¢è¡Œç¬¦è§„é¿ä¸€ä¸‹å§ã€‚æ¬¢è¿åŠ å…¥å¾®ä¿¡ç¾¤ï¼ŒæŒæ¡æœ€æ–°çš„ç›´æ’­ç­”ç–‘ä¿¡æ¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1360512,"ctime":1715562848,"ip_address":"ä¸Šæµ·","comment_id":390493,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"è¯æ³•åˆ†æparser.cppä»£ç ä¸­ï¼Œå¦‚æœæ–‡ä»¶ä¸­æœ«å°¾ä»¥æ•°å­—ç»“æŸå¹¶ä¸”æ²¡æœ‰ç©ºæ ¼æˆ–æ¢è¡Œç¬¦ï¼Œæœ€åä¸€ä¸ªæ•°å­—æ— æ³•æ‰“å°ï¼Œåœ¨fcloseå‰éœ€è¦åˆ¤æ–­ä¸€ä¸‹stateæ˜¯å¦ä¸ºNUMï¼Œæ˜¯çš„è¯æ‰“å°num","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644851,"discussion_content":"ğŸ‘ï¼Œå¯ä»¥ï¼Œå¯ä»¥ã€‚æµ‹è¯•ç”¨ä¾‹çš„æœ€ååŠ ä¸€ä¸ªæ¢è¡Œç¬¦è§„é¿ä¸€ä¸‹å§ã€‚æ¬¢è¿åŠ å…¥å¾®ä¿¡ç¾¤ï¼ŒæŒæ¡æœ€æ–°çš„ç›´æ’­ç­”ç–‘ä¿¡æ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715562848,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1667175,"avatar":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","nickname":"qinsi","note":"","ucode":"090D9C4068FF12","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644762,"discussion_content":"æ›´é€šç”¨çš„åšæ³•å¯èƒ½æ˜¯é‡åˆ°EOFå°±è¿”å›ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦, è¿™æ ·å°±ä¸ç”¨ä¾èµ–äºåˆ¤æ–­ç‰¹å®šçš„state","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715495953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390454,"user_name":"lunar","can_delete":false,"product_type":"c1","uid":1197007,"ip_address":"æ±Ÿè‹","ucode":"4FC1E388AD98C6","user_header":"https://static001.geekbang.org/account/avatar/00/12/43/cf/118c4ef5.jpg","comment_is_top":false,"comment_ctime":1715392415,"is_pvip":false,"replies":[{"id":142046,"content":"ä¸¤è¾¹ä¸€èµ·å¯¹ç…§ç€ç ”ç©¶ï¼Œä¸€ä¸ªæ˜¯llç®—æ³•ï¼Œä¸€ä¸ªæ˜¯lrç®—æ³•ï¼Œå¹¶ä¸å†²çªï¼ŒåŠ æ²¹ğŸ’ª","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1360512,"ctime":1715561750,"ip_address":"ä¸Šæµ·","comment_id":390454,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"antlr è¿˜æ²¡ç ”ç©¶å®Œ åˆæ¥çœ‹è¿™ä¸ªäº†ï¼Œæˆ‘è¿˜çœŸæ˜¯å†²åŠ¨","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644841,"discussion_content":"ä¸¤è¾¹ä¸€èµ·å¯¹ç…§ç€ç ”ç©¶ï¼Œä¸€ä¸ªæ˜¯llç®—æ³•ï¼Œä¸€ä¸ªæ˜¯lrç®—æ³•ï¼Œå¹¶ä¸å†²çªï¼ŒåŠ æ²¹ğŸ’ª","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715561750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390355,"user_name":"æµ©ä»”æ˜¯ç¨‹åºå‘˜","can_delete":false,"product_type":"c1","uid":1104601,"ip_address":"å¹¿ä¸œ","ucode":"A7E5CF9E1571A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg","comment_is_top":false,"comment_ctime":1715182871,"is_pvip":false,"replies":[{"id":141954,"content":"æœ‰å‘€ï¼Œåœ¨è¯¾ç¨‹ä»‹ç»é¡µé¢","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":2843479,"ctime":1715213033,"ip_address":"åŒ—äº¬","comment_id":390355,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100761401,"comment_content":"é¦–å‘ï¼ï¼æœ‰äº¤æµç¾¤å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2843479,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/57/cba4c68b.jpg","nickname":"å°è™å­ğŸ¯","note":"","ucode":"4C9530B3FB407B","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644366,"discussion_content":"æœ‰å‘€ï¼Œåœ¨è¯¾ç¨‹ä»‹ç»é¡µé¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715213033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":8,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":395034,"user_name":"ifelse","can_delete":false,"product_type":"c1","uid":2550743,"ip_address":"æµ™æ±Ÿ","ucode":"D0565908C99695","user_header":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","comment_is_top":false,"comment_ctime":1729149882,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":3,"score":2,"product_id":100761401,"comment_content":"å­¦ä¹ æ‰“å¡","like_count":0}]}