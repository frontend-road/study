{"id":111471,"title":"31 | 生产级网关需要考虑哪些环节？","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":136117,"user_name":"Lyle","can_delete":false,"product_type":"c3","uid":1002548,"ip_address":"","ucode":"55371A8BE9F88D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/34/0df5906a.jpg","comment_is_top":false,"comment_ctime":1569370485,"is_pvip":false,"replies":[{"id":52264,"content":"好办法！","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1569416478,"ip_address":"","comment_id":136117,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"防爬虫上次听到还有一个套路是网页中放一个隐藏链接，用户是看不到的，不会点到，爬虫会爬到，凡是访问这个链接的都是爬虫，禁掉","like_count":12,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468467,"discussion_content":"好办法！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569416478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":179972,"user_name":"Geek_1380b5","can_delete":false,"product_type":"c3","uid":1816251,"ip_address":"","ucode":"7FBB913427682C","user_header":"","comment_is_top":false,"comment_ctime":1582131012,"is_pvip":false,"replies":[{"id":69976,"content":"如果比较的是绝对性能，那么java&#47;spring开发的网关肯定比不上nginx。但是并不是说java&#47;spring开发的网关就不能承载高并发，Netflix(高峰期占全面1&#47;3的互联网流量)之前采用的Zuul 1.x做其API网关，Zuul就是Java&#47;Servlet开发的，Zuul本身无状态可以水平扩容，可以支撑Netflix全部API流量。另外携程之前API网关也是基于Zuul改造，支撑每日百亿级流量。\n\nFaraday比Zuul更加简单，虽然它只是一个教学用的简化网关，但是它的性能(经过一定的优化)并不会比zuul差。\n\n实际上，企业级网关单纯比较绝对性能意义不大，更重要的是看是否支持水平扩容(容量不够可以简单扩容即可，云环境中就是多起几个实例而已)，是否易于维护(nginx偏运维对开发并不友好)，监控治理体系是否完善等，这些方面对网关等技术基础设施更为重要。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1582211252,"ip_address":"","comment_id":179972,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"我记得网关本身应该承载高并发，ngixs可以达到10万，咱这个法拉第大概是个什么水平","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484469,"discussion_content":"如果比较的是绝对性能，那么java/spring开发的网关肯定比不上nginx。但是并不是说java/spring开发的网关就不能承载高并发，Netflix(高峰期占全面1/3的互联网流量)之前采用的Zuul 1.x做其API网关，Zuul就是Java/Servlet开发的，Zuul本身无状态可以水平扩容，可以支撑Netflix全部API流量。另外携程之前API网关也是基于Zuul改造，支撑每日百亿级流量。\n\nFaraday比Zuul更加简单，虽然它只是一个教学用的简化网关，但是它的性能(经过一定的优化)并不会比zuul差。\n\n实际上，企业级网关单纯比较绝对性能意义不大，更重要的是看是否支持水平扩容(容量不够可以简单扩容即可，云环境中就是多起几个实例而已)，是否易于维护(nginx偏运维对开发并不友好)，监控治理体系是否完善等，这些方面对网关等技术基础设施更为重要。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582211252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119419,"user_name":"hunterlodge","can_delete":false,"product_type":"c3","uid":1069755,"ip_address":"","ucode":"5B83A79E784161","user_header":"https://static001.geekbang.org/account/avatar/00/10/52/bb/225e70a6.jpg","comment_is_top":false,"comment_ctime":1564582609,"is_pvip":false,"replies":[{"id":43917,"content":"大致思路：在网关上收集访问日志(Access Log)，进入Kafka，后台大数据系统分析访问日志，生成爬虫ip列表(简单的统计单位时间ip访问量，生成top ip列表，复杂的还可以根据访问模式+AI计算出爬虫行为)，这个爬虫ip列表再反馈给网关(网关可以定期拉取)，网关根据这个ip列表禁止访问。ip列表比较简单粗糙，也可以是用户id列表。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564671966,"ip_address":"","comment_id":119419,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"请问老师，防爬的一般套路是怎样的呢？谢谢","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460896,"discussion_content":"大致思路：在网关上收集访问日志(Access Log)，进入Kafka，后台大数据系统分析访问日志，生成爬虫ip列表(简单的统计单位时间ip访问量，生成top ip列表，复杂的还可以根据访问模式+AI计算出爬虫行为)，这个爬虫ip列表再反馈给网关(网关可以定期拉取)，网关根据这个ip列表禁止访问。ip列表比较简单粗糙，也可以是用户id列表。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564671966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258509,"user_name":"龙彦极客","can_delete":false,"product_type":"c3","uid":2272998,"ip_address":"","ucode":"20D380C00D8B05","user_header":"https://static001.geekbang.org/account/avatar/00/22/ae/e6/0c41e48d.jpg","comment_is_top":false,"comment_ctime":1604468928,"is_pvip":false,"replies":[{"id":94571,"content":"把zuul部署成k8s中的服务service，可以按需扩展(通过replicaset&#47;deployment方式)。\n\nLBS -&gt; zuul service可以。\nLBS -&gt; Ingress service -&gt; zuul service也可以。这种更灵活，除了微服务以外，静态或者mvc站点，也可以躲在Ingress后面，通过ingress做灵活的反向代理。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1605013888,"ip_address":"","comment_id":258509,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师你好！\n网关用zuul，是无状态的，后期要水平扩展，在k8s里面部署要怎么做？\n如果只要一个域名，是不是阿里云直接LBS+zuul（replicaset扩展）就可以了？\n多个域名，才考虑用阿里云LBS+Ingress+zuul集群（replicaset扩展），这样吗？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508676,"discussion_content":"把zuul部署成k8s中的服务service，可以按需扩展(通过replicaset/deployment方式)。\n\nLBS -&amp;gt; zuul service可以。\nLBS -&amp;gt; Ingress service -&amp;gt; zuul service也可以。这种更灵活，除了微服务以外，静态或者mvc站点，也可以躲在Ingress后面，通过ingress做灵活的反向代理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605013888,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207560,"user_name":"Katherine","can_delete":false,"product_type":"c3","uid":1898758,"ip_address":"","ucode":"C57AB0B17DA1A1","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f9/06/dea695ea.jpg","comment_is_top":false,"comment_ctime":1587107976,"is_pvip":false,"replies":[{"id":77936,"content":"其实网关在整个微服务体系中是比较好理解的，网关在企业网络边界上，是API出入口，负责路由&#47;安全&#47;认证&#47;监控等跨横切面的功能。\n\n可以理解成一个公司的门卫，负责出入流量监控，安全监控，给人指路(路由)等。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1587393233,"ip_address":"","comment_id":207560,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"我感觉网关的内容理解起来比较费劲","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492167,"discussion_content":"其实网关在整个微服务体系中是比较好理解的，网关在企业网络边界上，是API出入口，负责路由/安全/认证/监控等跨横切面的功能。\n\n可以理解成一个公司的门卫，负责出入流量监控，安全监控，给人指路(路由)等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587393233,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163487,"user_name":"独钓寒江雪","can_delete":false,"product_type":"c3","uid":1028704,"ip_address":"","ucode":"1B2E3A7B8D6627","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erdd1KOUnW6yErToiaN4iaU4qHPn9PtU0fspzkzSKLqEyGG5383MBgHu1SEgzuibnMEiaHHGR31seHvNA/132","comment_is_top":false,"comment_ctime":1576730781,"is_pvip":false,"replies":[{"id":62340,"content":"网关一般是无状态部署，可以水平扩展，它的前置一般还有负载均衡设备(比如nginx或者硬件如F5)。\n\n服务注册可以采用Eureka服务注册中心，有专门的API支持下线操作，具体可以看其官方文档。\n\n网关选择，zuul已经有很多落地案例，比较稳定，spring cloud gateway也可以尝试。\n\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1576841740,"ip_address":"","comment_id":163487,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"那自己做个网关的话，如何做ha？也是用的keepalived去关联？然后所有的服务2个都注册么？？那如何下线服务呀。。。如果现在要选择一个网关的话在上面做拓展的话，是选择sprngclound gateaway么？有啥推荐么老师。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478413,"discussion_content":"网关一般是无状态部署，可以水平扩展，它的前置一般还有负载均衡设备(比如nginx或者硬件如F5)。\n\n服务注册可以采用Eureka服务注册中心，有专门的API支持下线操作，具体可以看其官方文档。\n\n网关选择，zuul已经有很多落地案例，比较稳定，spring cloud gateway也可以尝试。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576841740,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152966,"user_name":"FY","can_delete":false,"product_type":"c3","uid":1525109,"ip_address":"","ucode":"BFDEB6633DCA93","user_header":"https://static001.geekbang.org/account/avatar/00/17/45/75/b550951c.jpg","comment_is_top":false,"comment_ctime":1574130505,"is_pvip":false,"replies":[{"id":58830,"content":"是网关报跨域错误，还是后台服务报跨域错误？\n\n可以给相关spring应用添加全局跨域配置，参考：\nhttps:&#47;&#47;www.baeldung.com&#47;spring-cors\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1574166268,"ip_address":"","comment_id":152966,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师，我现在实验碰到一个问题就是，我在网关之外部署了一个第三方前端应用，通过Faraday访问后端服务一直报跨域问题，但绕过faraday就可以，这个怎么解决，谢谢","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475005,"discussion_content":"是网关报跨域错误，还是后台服务报跨域错误？\n\n可以给相关spring应用添加全局跨域配置，参考：\nhttps://www.baeldung.com/spring-cors\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574166268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1525109,"avatar":"https://static001.geekbang.org/account/avatar/00/17/45/75/b550951c.jpg","nickname":"FY","note":"","ucode":"BFDEB6633DCA93","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":58464,"discussion_content":"谢谢，我已经解决了，第三方服务必须通过网关访问子服务，所以只需要在网关加，但网关通过spring boot配置跨域的方式解决不了，因为faraday主要做路由转发的，后来我在过滤器里模拟了跨域请求的处理逻辑就解决了，faraday网关可扩展性非常好，赞一个！\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574677447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128879,"user_name":"张凌恺","can_delete":false,"product_type":"c3","uid":1355729,"ip_address":"","ucode":"A68F55D286A7D7","user_header":"https://static001.geekbang.org/account/avatar/00/14/af/d1/9239608c.jpg","comment_is_top":false,"comment_ctime":1566979666,"is_pvip":false,"replies":[{"id":47892,"content":"对，网关一般是无状态集群部署的，前置一般有硬件(如F5）或者软件(如nginx)LB做负载均衡，也有F5 -&gt; nginx -&gt; gateway软硬结合两层负载的，因为nginx配置相比F5方便。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1566999266,"ip_address":"","comment_id":128879,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师，如果大流量请求访问下，网关本身是否会成为瓶颈？网关本身是否也需要部署多台做负载均衡，看到Netflix的架构是在网关之前再搭一个AWS ELB，如果不使用AWS，是否还有其他解决方案？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465152,"discussion_content":"对，网关一般是无状态集群部署的，前置一般有硬件(如F5）或者软件(如nginx)LB做负载均衡，也有F5 -&amp;gt; nginx -&amp;gt; gateway软硬结合两层负载的，因为nginx配置相比F5方便。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566999266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119217,"user_name":"虎哥","can_delete":false,"product_type":"c3","uid":1185061,"ip_address":"","ucode":"29D604EC85D3BC","user_header":"https://static001.geekbang.org/account/avatar/00/12/15/25/1d3d616f.jpg","comment_is_top":false,"comment_ctime":1564539032,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"响应流优化","like_count":0}]}