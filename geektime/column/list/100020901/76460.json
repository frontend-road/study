{"id":76460,"title":"21 | 套路篇：如何“快准狠”找到系统内存的问题？","content":"<p>你好，我是倪朋飞。</p><p>前几节，通过几个案例，我们分析了各种常见的内存性能问题。我相信通过它们，你对内存的性能分析已经有了基本的思路，也熟悉了很多分析内存性能的工具。你肯定会想，有没有迅速定位内存问题的方法？当定位出内存的瓶颈后，又有哪些优化内存的思路呢？</p><p>今天，我就来帮你梳理一下，怎样可以快速定位系统内存，并且总结了相关的解决思路。</p><h2>内存性能指标</h2><p>为了分析内存的性能瓶颈，首先你要知道，怎样衡量内存的性能，也就是性能指标问题。我们先来回顾一下，前几节学过的内存性能指标。</p><p>你可以自己先找张纸，凭着记忆写一写；或者打开前面的文章，自己总结一下。</p><p>首先，你最容易想到的是系统内存使用情况，比如已用内存、剩余内存、共享内存、可用内存、缓存和缓冲区的用量等。</p><ul>\n<li>\n<p>已用内存和剩余内存很容易理解，就是已经使用和还未使用的内存。</p>\n</li>\n<li>\n<p>共享内存是通过tmpfs实现的，所以它的大小也就是tmpfs使用的内存大小。tmpfs其实也是一种特殊的缓存。</p>\n</li>\n<li>\n<p>可用内存是新进程可以使用的最大内存，它包括剩余内存和可回收缓存。</p>\n</li>\n<li>\n<p>缓存包括两部分，一部分是磁盘读取文件的页缓存，用来缓存从磁盘读取的数据，可以加快以后再次访问的速度。另一部分，则是Slab分配器中的可回收内存。</p>\n</li>\n<li>\n<p>缓冲区是对原始磁盘块的临时存储，用来缓存将要写入磁盘的数据。这样，内核就可以把分散的写集中起来，统一优化磁盘写入。</p>\n</li>\n</ul><!-- [[[read_end]]] --><p>第二类很容易想到的，应该是进程内存使用情况，比如进程的虚拟内存、常驻内存、共享内存以及Swap内存等。</p><ul>\n<li>\n<p>虚拟内存，包括了进程代码段、数据段、共享内存、已经申请的堆内存和已经换出的内存等。这里要注意，已经申请的内存，即使还没有分配物理内存，也算作虚拟内存。</p>\n</li>\n<li>\n<p>常驻内存是进程实际使用的物理内存，不过，它不包括Swap和共享内存。</p>\n</li>\n<li>\n<p>共享内存，既包括与其他进程共同使用的真实的共享内存，还包括了加载的动态链接库以及程序的代码段等。</p>\n</li>\n<li>\n<p>Swap内存，是指通过Swap换出到磁盘的内存。</p>\n</li>\n</ul><p>当然，这些指标中，常驻内存一般会换算成占系统总内存的百分比，也就是进程的内存使用率。</p><p>除了这些很容易想到的指标外，我还想再强调一下，缺页异常。</p><p>在内存分配的原理中，我曾经讲到过，系统调用内存分配请求后，并不会立刻为其分配物理内存，而是在请求首次访问时，通过缺页异常来分配。缺页异常又分为下面两种场景。</p><ul>\n<li>\n<p>可以直接从物理内存中分配时，被称为次缺页异常。</p>\n</li>\n<li>\n<p>需要磁盘I/O介入（比如Swap）时，被称为主缺页异常。</p>\n</li>\n</ul><p>显然，主缺页异常升高，就意味着需要磁盘I/O，那么内存访问也会慢很多。</p><p>除了系统内存和进程内存，第三类重要指标就是Swap的使用情况，比如Swap的已用空间、剩余空间、换入速度和换出速度等。</p><ul>\n<li>\n<p>已用空间和剩余空间很好理解，就是字面上的意思，已经使用和没有使用的内存空间。</p>\n</li>\n<li>\n<p>换入和换出速度，则表示每秒钟换入和换出内存的大小。</p>\n</li>\n</ul><p>这些内存的性能指标都需要我们熟记并且会用，我把它们汇总成了一个思维导图，你可以保存打印出来，或者自己仿照着总结一份。</p><p><img src=\"https://static001.geekbang.org/resource/image/e2/36/e28cf90f0b137574bca170984d1e6736.png?wh=1586*1760\" alt=\"\"></p><h2>内存性能工具</h2><p>了解了内存的性能指标，我们还得知道，怎么才能获得这些指标，也就是会用性能工具。这里，我们也用同样的方法，回顾一下前面案例中已经用到的各种内存性能工具。 还是鼓励你先自己回忆和总结一下。</p><p>首先，你应该注意到了，所有的案例中都用到了free。这是个最常用的内存工具，可以查看系统的整体内存和Swap使用情况。相对应的，你可以用top或ps，查看进程的内存使用情况。</p><p>然后，在缓存和缓冲区的原理篇中，我们通过proc文件系统，找到了内存指标的来源；并通过vmstat，动态观察了内存的变化情况。与free相比，vmstat除了可以动态查看内存变化，还可以区分缓存和缓冲区、Swap换入和换出的内存大小。</p><p>接着，在缓存和缓冲区的案例篇中，为了弄清楚缓存的命中情况，我们又用了cachestat ，查看整个系统缓存的读写命中情况，并用 cachetop 来观察每个进程缓存的读写命中情况。</p><p>再接着，在内存泄漏的案例中，我们用vmstat，发现了内存使用在不断增长，又用memleak，确认发生了内存泄漏。通过memleak给出的内存分配栈，我们找到了内存泄漏的可疑位置。</p><p>最后，在Swap的案例中，我们用sar发现了缓冲区和Swap升高的问题。通过cachetop，我们找到了缓冲区升高的根源；通过对比剩余内存跟/proc/zoneinfo的内存阈，我们发现Swap升高是内存回收导致的。案例最后，我们还通过/proc文件系统，找出了Swap所影响的进程。</p><p>到这里，你是不是再次感觉到了来自性能世界的“恶意”。性能工具怎么那么多呀？其实，还是那句话，理解内存的工作原理，结合性能指标来记忆，拿下工具的使用方法并不难。</p><h2>性能指标和工具的联系</h2><p>同CPU性能分析一样，我的经验是两个不同维度出发，整理和记忆。</p><ul>\n<li>\n<p>从内存指标出发，更容易把工具和内存的工作原理关联起来。</p>\n</li>\n<li>\n<p>从性能工具出发，可以更快地利用工具，找出我们想观察的性能指标。特别是在工具有限的情况下，我们更得充分利用手头的每一个工具，挖掘出更多的问题。</p>\n</li>\n</ul><p>同样的，根据内存性能指标和工具的对应关系，我做了两个表格，方便你梳理关系和理解记忆。当然，你也可以当成“指标工具”和“工具指标”指南来用，在需要时直接查找。</p><p>第一个表格，从内存指标出发，列举了哪些性能工具可以提供这些指标。这样，在实际排查性能问题时，你就可以清楚知道，究竟要用什么工具来辅助分析，提供你想要的指标。</p><p><img src=\"https://static001.geekbang.org/resource/image/8f/ed/8f477035fc4348a1f80bde3117a7dfed.png?wh=1708*2116\" alt=\"\"></p><p>第二个表格，从性能工具出发，整理了这些常见工具能提供的内存指标。掌握了这个表格，你可以最大化利用已有的工具，尽可能多地找到你要的指标。</p><p>这些工具的具体使用方法并不用背，你只要知道有哪些可用的工具，以及这些工具提供的基本指标。真正用到时， man 一下查它们的使用手册就可以了。</p><p><img src=\"https://static001.geekbang.org/resource/image/52/9b/52bb55fba133401889206d02c224769b.png?wh=1701*1753\" alt=\"\"></p><h2>如何迅速分析内存的性能瓶颈</h2><p>我相信到这一步，你对内存的性能指标已经非常熟悉，也清楚每种性能指标分别能用什么工具来获取。</p><p>那是不是说，每次碰到内存性能问题，你都要把上面这些工具全跑一遍，然后再把所有内存性能指标全分析一遍呢？</p><p>自然不是。前面的CPU性能篇我们就说过，简单查找法，虽然是有用的，也很可能找到某些系统潜在瓶颈。但是这种方法的低效率和大工作量，让我们首先拒绝了这种方法。</p><p>还是那句话，在实际生产环境中，我们希望的是，尽可能<strong>快</strong>地定位系统瓶颈，然后尽可能<strong>快</strong>地优化性能，也就是要又快又准地解决性能问题。</p><p>那有没有什么方法，可以又快又准地分析出系统的内存问题呢？</p><p>方法当然有。还是那个关键词，找关联。其实，虽然内存的性能指标很多，但都是为了描述内存的原理，指标间自然不会完全孤立，一般都会有关联。当然，反过来说，这些关联也正是源于系统的内存原理，这也是我总强调基础原理的重要性，并在文章中穿插讲解。</p><p>举个最简单的例子，当你看到系统的剩余内存很低时，是不是就说明，进程一定不能申请分配新内存了呢？当然不是，因为进程可以使用的内存，除了剩余内存，还包括了可回收的缓存和缓冲区。</p><p>所以，<strong>为了迅速定位内存问题，我通常会先运行几个覆盖面比较大的性能工具，比如free、top、vmstat、pidstat等</strong>。</p><p>具体的分析思路主要有这几步。</p><ol>\n<li>\n<p>先用free和top，查看系统整体的内存使用情况。</p>\n</li>\n<li>\n<p>再用vmstat和pidstat，查看一段时间的趋势，从而判断出内存问题的类型。</p>\n</li>\n<li>\n<p>最后进行详细分析，比如内存分配分析、缓存/缓冲区分析、具体进程的内存使用分析等。</p>\n</li>\n</ol><p>同时，我也把这个分析过程画成了一张流程图，你可以保存并打印出来使用。</p><p><img src=\"https://static001.geekbang.org/resource/image/d7/fe/d79cd017f0c90b84a36e70a3c5dccffe.png?wh=1629*885\" alt=\"\"></p><p>图中列出了最常用的几个内存工具，和相关的分析流程。其中，箭头表示分析的方向，举几个例子你可能会更容易理解。</p><p>第一个例子，当你通过free，发现大部分内存都被缓存占用后，可以使用vmstat或者sar观察一下缓存的变化趋势，确认缓存的使用是否还在继续增大。</p><p>如果继续增大，则说明导致缓存升高的进程还在运行，那你就能用缓存/缓冲区分析工具（比如cachetop、slabtop等），分析这些缓存到底被哪里占用。</p><p>第二个例子，当你free一下，发现系统可用内存不足时，首先要确认内存是否被缓存/缓冲区占用。排除缓存/缓冲区后，你可以继续用pidstat或者top，定位占用内存最多的进程。</p><p>找出进程后，再通过进程内存空间工具（比如pmap），分析进程地址空间中内存的使用情况就可以了。</p><p>第三个例子，当你通过vmstat或者sar发现内存在不断增长后，可以分析中是否存在内存泄漏的问题。</p><p>比如你可以使用内存分配分析工具 memleak ，检查是否存在内存泄漏。如果存在内存泄漏问题，memleak会为你输出内存泄漏的进程以及调用堆栈。</p><p>注意，这个图里我没有列出所有性能工具，只给出了最核心的几个。这么做，一方面，确实不想让大量的工具列表吓到你。</p><p>另一方面，希望你能把重心先放在核心工具上，通过我提供的案例和真实环境的实践，掌握使用方法和分析思路。 毕竟熟练掌握它们，你就可以解决大多数的内存问题。</p><h2>小结</h2><p>在今天的文章中，我带你回顾了常见的内存性能指标，梳理了常见的内存性能分析工具，最后还总结了快速分析内存问题的思路。</p><p>虽然内存的性能指标和性能工具都挺多，但理解了内存管理的基本原理后，你会发现它们其实都有一定的关联。梳理出它们的关系，掌握内存分析的套路并不难。</p><p>找到内存问题的来源后，下一步就是相应的优化工作了。在我看来，内存调优最重要的就是，保证应用程序的热点数据放到内存中，并尽量减少换页和交换。</p><p>常见的优化思路有这么几种。</p><ol>\n<li>\n<p>最好禁止 Swap。如果必须开启Swap，降低swappiness的值，减少内存回收时Swap的使用倾向。</p>\n</li>\n<li>\n<p>减少内存的动态分配。比如，可以使用内存池、大页（HugePage）等。</p>\n</li>\n<li>\n<p>尽量使用缓存和缓冲区来访问数据。比如，可以使用堆栈明确声明内存空间，来存储需要缓存的数据；或者用Redis 这类的外部缓存组件，优化数据的访问。</p>\n</li>\n<li>\n<p>使用cgroups等方式限制进程的内存使用情况。这样，可以确保系统内存不会被异常进程耗尽。</p>\n</li>\n<li>\n<p>通过 /proc/pid/oom_adj ，调整核心应用的oom_score。这样，可以保证即使内存紧张，核心应用也不会被OOM杀死。</p>\n</li>\n</ol><h2>思考</h2><p>由于篇幅限制，我在这里只列举了一些我认为的重要内存指标和分析思路。我想，你肯定也碰到过很多内存相关的性能问题。所以，我想请你来聊一聊，你处理过的内存性能问题，你是怎样分析它的瓶颈并解决的呢？这个过程中，遇到了什么坑，或者有什么重要收获吗？</p><p>欢迎在留言区跟我讨论，也欢迎把这篇文章分享给你的同事、朋友。我们一起在实战中演练，在交流中进步。</p><p></p>","comments":[{"had_liked":false,"id":60427,"user_name":"allan","can_delete":false,"product_type":"c1","uid":1142819,"ip_address":"","ucode":"CA0BE868AA9FF5","user_header":"https://static001.geekbang.org/account/avatar/00/11/70/23/972dcd30.jpg","comment_is_top":false,"comment_ctime":1547471302,"is_pvip":false,"replies":[{"id":"22300","content":"很细心呀，这里概念上和工具给出的指标有些出入，实际使用时要注意工具给出的指标的含义","user_name":"作者回复","comment_id":60427,"uid":"1001282","ip_address":"","utype":1,"ctime":1548248691,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"104626686406","product_id":100020901,"comment_content":"老师，您在文中说到：<br>常驻内存是进程实际使用的物理内存，不过，它不包括 Swap 和共享内存。<br><br>但是在下一篇答疑的文章中提到：RSS 表示常驻内存，把进程用到的共享内存也算了进去。<br><br>这是不是矛盾了，是不是这一篇中说到的有问题呢？<br>","like_count":24,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436503,"discussion_content":"很细心呀，这里概念上和工具给出的指标有些出入，实际使用时要注意工具给出的指标的含义","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1548248691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57533,"user_name":"减肥的老郭","can_delete":false,"product_type":"c1","uid":1102573,"ip_address":"","ucode":"5B9A7CA5F87EBD","user_header":"https://static001.geekbang.org/account/avatar/00/10/d2/ed/e9158538.jpg","comment_is_top":false,"comment_ctime":1546830224,"is_pvip":false,"replies":[{"id":"20765","content":"有的，比如内存泄漏使用valgrind、动态跟踪使用systemtap等。这些工具相对来说更难用一些","user_name":"作者回复","comment_id":57533,"uid":"1001282","ip_address":"","utype":1,"ctime":1546853905,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"74561274256","product_id":100020901,"comment_content":"老师好，文中提到的bcc相关的工具都需要版本较高的内核，但是真实生产都无法满足这个要求，有别的替代工具么？","like_count":17,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435632,"discussion_content":"有的，比如内存泄漏使用valgrind、动态跟踪使用systemtap等。这些工具相对来说更难用一些","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1546853905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63444,"user_name":"大坏狐狸","can_delete":false,"product_type":"c1","uid":1325678,"ip_address":"","ucode":"5044F89A505C5B","user_header":"https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg","comment_is_top":false,"comment_ctime":1548375868,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"65972885308","product_id":100020901,"comment_content":"哈哈 学着后面忘着前面 哎","like_count":15},{"had_liked":false,"id":57701,"user_name":"无名老卒","can_delete":false,"product_type":"c1","uid":1348261,"ip_address":"","ucode":"48874CE670E122","user_header":"","comment_is_top":false,"comment_ctime":1546870730,"is_pvip":false,"replies":[{"id":"21001","content":"可以把系统和进程的内存指标监控起来，这样根据历史趋势就可以知道是哪些进程内存泄漏了。<br><br>其他的这些也有，但比较少。实际进程基本上都有一个内存管理模块，统一管理内存。有问题也是这个模块刚开始写的时候比较多，后面就会逐渐稳定起来。","user_name":"作者回复","comment_id":57701,"uid":"1001282","ip_address":"","utype":1,"ctime":1547029157,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"27316674506","product_id":100020901,"comment_content":"老师能不能举一些实际的例子，我是有遇到过线上内存泄露的案例，每次出现这个问题时，基本上是无解，因为基本上都是直接宕机了。这个可有监控方法？<br><br>其他的内存使用上的问题，如缺页、缓存数据用得过多等异常，基本上没有遇到过，这类问题，老师遇到的次数多吗？","like_count":6,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435711,"discussion_content":"可以把系统和进程的内存指标监控起来，这样根据历史趋势就可以知道是哪些进程内存泄漏了。\n\n其他的这些也有，但比较少。实际进程基本上都有一个内存管理模块，统一管理内存。有问题也是这个模块刚开始写的时候比较多，后面就会逐渐稳定起来。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547029157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114258,"user_name":"深蓝","can_delete":false,"product_type":"c1","uid":1219317,"ip_address":"","ucode":"944AE8C1F2DBC7","user_header":"https://static001.geekbang.org/account/avatar/00/12/9a/f5/71eee10b.jpg","comment_is_top":false,"comment_ctime":1563262346,"is_pvip":false,"replies":[{"id":"41977","content":"top有没有按照内存排序？","user_name":"作者回复","comment_id":114258,"uid":"1001282","ip_address":"","utype":1,"ctime":1563456521,"user_name_real":"倪朋飞"}],"discussion_count":3,"race_medal":0,"score":"18743131530","product_id":100020901,"comment_content":"我现实中遇到一个奇怪的场景 free -m 查看 used 很高 free buff&#47;cache 都很低 top命令看不到内存占用高的内存，目前系统中可用的工具只有pmap top ps slabtop 请问老师有什么思路来排查这个问题","like_count":4,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458582,"discussion_content":"top有没有按照内存排序？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563456521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254615,"avatar":"https://static001.geekbang.org/account/avatar/00/13/24/d7/146f484b.jpg","nickname":"小宇子2B","note":"","ucode":"E360188C65EAEA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348901,"discussion_content":"我也遇到这种问题，然后去看了/proc/meminfo，看到slab的不可回收内存很高，然后看了下skbuff_head_cache对象有200多万个，google查了下skbuff_head_cache是套接字缓冲区，然后联合机器上的应用特性，它会大量创建tcp连接，看了监控，确实tcp连接数翻了4倍多。\n但是想问下老师，我知道slab中是哪些对象占用较多，那我怎么看这些对象是哪个应用产生的呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612771898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2716828,"avatar":"https://static001.geekbang.org/account/avatar/00/29/74/9c/9ba19751.jpg","nickname":"噼啪豆","note":"","ucode":"B9F950C07C2B99","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554612,"discussion_content":"我们也遇到过这样的问题，但是后面怀疑是虚拟机的内存被虚拟机管理工具给调度到了其它虚拟机上，造成了内存使用信息未被记录，查不到使用者的情况。后续让虚拟机管理员给锁定了内存分配。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646488197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58084,"user_name":"风飘，吾独思","can_delete":false,"product_type":"c1","uid":1131032,"ip_address":"","ucode":"4DF0E7DC22EE53","user_header":"https://static001.geekbang.org/account/avatar/00/11/42/18/edc1b373.jpg","comment_is_top":false,"comment_ctime":1546994684,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18726863868","product_id":100020901,"comment_content":"打卡","like_count":4},{"had_liked":false,"id":296609,"user_name":"公共账号","can_delete":false,"product_type":"c1","uid":2324779,"ip_address":"","ucode":"BEBF70723F0A84","user_header":"https://static001.geekbang.org/account/avatar/00/23/79/2b/365055c3.jpg","comment_is_top":false,"comment_ctime":1623061645,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14507963533","product_id":100020901,"comment_content":"上面的套路只适合一些简单场景，如果是简单场景通过二分法注释或者动态检查工具也能很快解决；但是遇到复杂场景，比如程序运行了1个月才泄露500M，或者程序内存申请非常频繁，短时间内记录会非常大，排除也是很费时间的。https:&#47;&#47;www.91dengdeng.cn&#47;2019&#47;05&#47;07&#47;windbg%E5%88%86%E6%9E%90%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F&#47;<br>讲解了一些其他方法<br>","like_count":3},{"had_liked":false,"id":57488,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1546821963,"is_pvip":false,"replies":[{"id":"20766","content":"可能跟NUMA配置有关，可以查下是不是允许跨NODE","user_name":"作者回复","comment_id":57488,"uid":"1001282","ip_address":"","utype":1,"ctime":1546854211,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"14431723851","product_id":100020901,"comment_content":"倪老师，我们有一个空闲的docker节点（CentOS 7.4，只有k8s node组件，ceph组件和2个空跑的测试pod），平常只有几十的磁盘iops，每隔若干天后系统磁盘的iops就会持续超过3000，并且降不下来。经过iostat检查发现磁盘读写来自于swap卷，奇怪的是系统空闲内存很多，swap使用率也只有一点点（不到1%），主机上也没什么业务。现在每次碰到这个问题只能重启一下解决。请问这种问题有啥解决思路吗？","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435602,"discussion_content":"可能跟NUMA配置有关，可以查下是不是允许跨NODE","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546854211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57717,"user_name":"shuifa","can_delete":false,"product_type":"c1","uid":1040063,"ip_address":"","ucode":"636733F5C88A7B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/de/bf/4df4224d.jpg","comment_is_top":false,"comment_ctime":1546874305,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"10136808897","product_id":100020901,"comment_content":"打卡，学习是一种习惯","like_count":2},{"had_liked":false,"id":358480,"user_name":"Geek_e2b0f9","can_delete":false,"product_type":"c1","uid":1602650,"ip_address":"北京","ucode":"CAB31078DDB515","user_header":"","comment_is_top":false,"comment_ctime":1664353211,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5959320507","product_id":100020901,"comment_content":"Top Res不断升高","like_count":1},{"had_liked":false,"id":309226,"user_name":"NARUTO","can_delete":false,"product_type":"c1","uid":1234420,"ip_address":"","ucode":"D4ECADEBAFD4FF","user_header":"https://static001.geekbang.org/account/avatar/00/12/d5/f4/ce6acfc0.jpg","comment_is_top":false,"comment_ctime":1629989726,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5924957022","product_id":100020901,"comment_content":"老师，在使用perf record -g pid命令后，怎么知道输出的结果中，调用频繁的指令是什么意思呢？或者从哪里可以查到呢？比如我看到结果中占比前三的有start_thread java_start Java_java_util_zip_Deflater_deflateBytes","like_count":1},{"had_liked":false,"id":258578,"user_name":"Geek_f702be","can_delete":false,"product_type":"c1","uid":1143067,"ip_address":"","ucode":"8E3B5F393C4266","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epumnXjMLYzHkGFhAraIiaAMXpotuUR9PCexBWl25tRLFAvpzs03Hfse4Y1lyeWuryz6z80Fd8AXiaw/132","comment_is_top":false,"comment_ctime":1604490032,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5899457328","product_id":100020901,"comment_content":"打卡<br>free top vmstat从大到小进行定位分析是缓存、swap、还是内存泄漏问题","like_count":1},{"had_liked":false,"id":118323,"user_name":"沙漠风暴","can_delete":false,"product_type":"c1","uid":1284147,"ip_address":"","ucode":"9F5E421C82DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/13/98/33/64e35e5a.jpg","comment_is_top":false,"comment_ctime":1564321875,"is_pvip":false,"replies":[{"id":"44408","content":"VIRT高没事的，内存使用率高是不是还有其他的进程？或者多进程？","user_name":"作者回复","comment_id":118323,"uid":"1001282","ip_address":"","utype":1,"ctime":1565016172,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"5859289171","product_id":100020901,"comment_content":"老师好，我们公司生产服务器上面内存使用率总是99%，我用top命令查了，是tomcat站点的java进程的VIRT是15G，RES是5G，机器总物理内存15G，这个VIRT是不是太高了，是什么原因导致的呢，会影响机器和tomcat的性能吗？谢谢指教！","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460356,"discussion_content":"VIRT高没事的，内存使用率高是不是还有其他的进程？或者多进程？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565016172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75768,"user_name":"平安喜乐","can_delete":false,"product_type":"c1","uid":1102350,"ip_address":"","ucode":"B97D8944B0B035","user_header":"https://static001.geekbang.org/account/avatar/00/10/d2/0e/26bf35a4.jpg","comment_is_top":false,"comment_ctime":1552466581,"is_pvip":false,"replies":[{"id":"28049","content":"这在官方文档上就有的 https:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;8.0&#47;en&#47;memory-use.html","user_name":"作者回复","comment_id":75768,"uid":"1001282","ip_address":"","utype":1,"ctime":1552749687,"user_name_real":"倪朋飞"}],"discussion_count":2,"race_medal":0,"score":"5847433877","product_id":100020901,"comment_content":"例如：mysql 内存占用较高 怎么分析 MySQL 进程具体内存耗用呢？谢谢！","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443025,"discussion_content":"这在官方文档上就有的 https://dev.mysql.com/doc/refman/8.0/en/memory-use.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552749687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390998,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/3r3hXiaTMf17zZyUFQV1n5ynjUxlLukVUAGQAiakAuUjWPHh98kLA0HzpnMWrH5iawibIYRCVSC3hd7ticicUpT8NS6A/132","nickname":"挨踢人","note":"","ucode":"D1828C1A944D5A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3735,"discussion_content":"top -H -p pid(mysqld)","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1564738671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70792,"user_name":"让熊猫飞上天","can_delete":false,"product_type":"c1","uid":1348156,"ip_address":"","ucode":"7D6D349B6E3730","user_header":"https://static001.geekbang.org/account/avatar/00/14/92/3c/9116abf4.jpg","comment_is_top":false,"comment_ctime":1551185271,"is_pvip":false,"replies":[{"id":"25366","content":"是的，但是 memleak 内核版本要比较新，valgrind 在很旧的内核上也可以用","user_name":"作者回复","comment_id":70792,"uid":"1001282","ip_address":"","utype":1,"ctime":1551195680,"user_name_real":"倪朋飞"}],"discussion_count":1,"race_medal":0,"score":"5846152567","product_id":100020901,"comment_content":"你好，老师，问一下工具valgrind使用时在分析内存泄露时，这个工具不能直接使用pid来定位，只能跟程序文件吗？ 感觉没有memleak这个好用","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440832,"discussion_content":"是的，但是 memleak 内核版本要比较新，valgrind 在很旧的内核上也可以用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551195680,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57793,"user_name":"划时代","can_delete":false,"product_type":"c1","uid":1061454,"ip_address":"","ucode":"9554CE2F83B77F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2o1Izf2YyJSnnI0ErZ51pYRlnrmibqUTaia3tCU1PjMxuwyXSKOLUYiac2TQ5pd5gNGvS81fVqKWGvDsZLTM8zhWg/132","comment_is_top":false,"comment_ctime":1546912391,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5841879687","product_id":100020901,"comment_content":"打卡总结","like_count":1},{"had_liked":false,"id":57470,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1546819539,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5841786835","product_id":100020901,"comment_content":"打卡day22<br>总结篇，紧跟大佬脚步～","like_count":1},{"had_liked":false,"id":360714,"user_name":"iq2wh","can_delete":false,"product_type":"c1","uid":1054546,"ip_address":"北京","ucode":"B2C894ED48B2EF","user_header":"https://static001.geekbang.org/account/avatar/00/10/17/52/8e72876e.jpg","comment_is_top":false,"comment_ctime":1666776254,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666776254","product_id":100020901,"comment_content":"老师，遇到一个问题：<br><br>系统是 CentOS7，内存64G快占用满了，但是用 htop 却看不出来内存占用特别多的进程。<br><br>这是个测试节点，节点上的进程也不多，两个tomcat、一个 Redis、docker 跑了两个容器，就这几个占用比较多，但从htop上看远没有 60G 这么大。<br><br>从系统日志也没看到特殊的异常，这种情况可能是什么占用了几十 G 内存，要怎么下手去分析？","like_count":0},{"had_liked":false,"id":359128,"user_name":"Geek_f93234","can_delete":false,"product_type":"c1","uid":1769504,"ip_address":"北京","ucode":"1E5DC903A5429E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJGXndj5N66z9BL1ic9GibZzWWgoVeWaWTL2XUnCYic7iba2kAEvN9WfjmlXELD5lqt8IJ1P023N5ZWicg/132","comment_is_top":false,"comment_ctime":1665282408,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1665282408","product_id":100020901,"comment_content":"day21打卡","like_count":0},{"had_liked":false,"id":343335,"user_name":"爱丽包°","can_delete":false,"product_type":"c1","uid":2535283,"ip_address":"","ucode":"125325E82EE6D2","user_header":"https://static001.geekbang.org/account/avatar/00/26/af/73/6bc60f7a.jpg","comment_is_top":false,"comment_ctime":1650787429,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650787429","product_id":100020901,"comment_content":"老师，怎么查看主次缺页异常呢？是pidstat -r中的 minflt&#47;s跟majflt&#47;s嘛","like_count":0},{"had_liked":false,"id":339664,"user_name":"Sudouble","can_delete":false,"product_type":"c1","uid":1365574,"ip_address":"","ucode":"B369B09DAF8D20","user_header":"https://static001.geekbang.org/account/avatar/00/14/d6/46/5eb5261b.jpg","comment_is_top":false,"comment_ctime":1648281911,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1648281911","product_id":100020901,"comment_content":"我之前都是主要关注程序本身的问题，有的问题还需要从系统资源的角度下手。<br>看了老师的这篇分享，不得不感叹操作系统强，才是真的强，应用软件全是依托于操作系统。","like_count":0},{"had_liked":false,"id":331110,"user_name":"糊涂小孩123","can_delete":false,"product_type":"c1","uid":1318107,"ip_address":"","ucode":"A34B12F20798B4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/QGOH86dIQBpRKRS3icrRE4JJquETmQcXPBd4VhMCbVV4iconpgUdNFbCJYu4GSOfCics0QmGkhicY3xrrkblkkic9JQ/132","comment_is_top":false,"comment_ctime":1642428051,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642428051","product_id":100020901,"comment_content":"pmap看到一个nginx worker进程的内存分布中显示的是anon这种怎么分析呢？","like_count":0},{"had_liked":false,"id":303460,"user_name":"小子","can_delete":false,"product_type":"c1","uid":1372483,"ip_address":"","ucode":"553ED8E064107B","user_header":"https://static001.geekbang.org/account/avatar/00/14/f1/43/bd24ec72.jpg","comment_is_top":false,"comment_ctime":1626798570,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1626798570","product_id":100020901,"comment_content":"最近遇到一个问题，有点整不明白，比较棘手，新上线一个机房，发现一部分服务，在这个新上线的机房swap使用比较严重，导致cpu升高。但是在其他物理机房的机器均正常。容灾考虑是多机房部署，系统代码环境都一样，只有硬件差异。新上线机房硬件配置很高，就不知道为什么会出现这种情形，业务说他服务没问题，从系统层面来说，程序使用swap导致，程序问题，但是为什么是一边倒，新机房服务吃swap呢？这个问题几天来说不清楚。为什么同样代码，同样大小内存，同样系统，不同硬件CPU，新机房会占用swap，且程序占用内存也高呢？求助广大朋友指点一二，朋飞老师指点下思路。","like_count":0,"discussions":[{"author":{"id":1443017,"avatar":"https://static001.geekbang.org/account/avatar/00/16/04/c9/ef585c96.jpg","nickname":"碌舰虾","note":"","ucode":"B947C229E767D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388651,"discussion_content":"和NUMA架构有关？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628867472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":278150,"user_name":"小宇子2B","can_delete":false,"product_type":"c1","uid":1254615,"ip_address":"","ucode":"E360188C65EAEA","user_header":"https://static001.geekbang.org/account/avatar/00/13/24/d7/146f484b.jpg","comment_is_top":false,"comment_ctime":1612776067,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1612776067","product_id":100020901,"comment_content":"我也遇到过free看内存用的很多，但是top对了下没有用那么多，按内存排序了。<br>然后去看了&#47;proc&#47;meminfo，看到slab的不可回收内存很高，然后看了下skbuff_head_cache对象有200多万个，google查了下skbuff_head_cache是套接字缓冲区，然后联合机器上的应用特性，它会大量创建tcp连接，看了监控，确实tcp连接数翻了4倍多。<br>但是想问下老师，我知道slab中是哪些对象占用较多，那我怎么看这些对象是哪个应用产生的呢？","like_count":0,"discussions":[{"author":{"id":1105983,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e0/3f/41d5ecf8.jpg","nickname":"David","note":"","ucode":"0F71681A79885F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382845,"discussion_content":"都可以查到tcp链接了，直接netstat检查对应pid不就找到对应进程了么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625740960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277599,"user_name":"120","can_delete":false,"product_type":"c1","uid":1333032,"ip_address":"","ucode":"0A974F616A3D1C","user_header":"https://static001.geekbang.org/account/avatar/00/14/57/28/8f1ed5ac.jpg","comment_is_top":false,"comment_ctime":1612488461,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1612488461","product_id":100020901,"comment_content":"前辈，请教下，怎么检查系统和进程的缺页异常？现在有个case存在大量的写缓存，时不时出现写超时？怎么破<br>","like_count":0,"discussions":[{"author":{"id":1101226,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cd/aa/33d48789.jpg","nickname":"卫江","note":"","ucode":"DE2F7A6916F1A9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349949,"discussion_content":"通过pidstat -r 可以看到进程的缺页异常","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613639512,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257166,"user_name":"泥鳅也是鱼","can_delete":false,"product_type":"c1","uid":1287513,"ip_address":"","ucode":"3E69CBD0C10CB6","user_header":"https://static001.geekbang.org/account/avatar/00/13/a5/59/e27c2d45.jpg","comment_is_top":false,"comment_ctime":1603869716,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603869716","product_id":100020901,"comment_content":"使用 cgroups 等方式限制进程的内存使用情况，这个怎么使用","like_count":0},{"had_liked":false,"id":249325,"user_name":"袁满","can_delete":false,"product_type":"c1","uid":1275527,"ip_address":"","ucode":"4E069B1B176CE0","user_header":"https://static001.geekbang.org/account/avatar/00/13/76/87/c5b6ef6b.jpg","comment_is_top":false,"comment_ctime":1600591991,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1600591991","product_id":100020901,"comment_content":"老师你好！我现在碰到一个问题，程序在运行过程中，会偶然出现崩溃产生core文件，用gdb跟踪调用堆栈，每次出现的最终调用函数不一样，有一定几率最终的调用函数是相同，我们初步怀疑程序内部出现使用了无效内存地址，诸如也指针之类。但是代码翻来翻去也没找到问题所在。不知道有什么工具可以辅助排查这样的问题没有。","like_count":0},{"had_liked":false,"id":245331,"user_name":"Night","can_delete":false,"product_type":"c1","uid":1693386,"ip_address":"","ucode":"F0AE9ED5AF6CAE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhGfKVcr0FUYP2hFpVGcSOq8N9HdPGMciaDIOj7lWBt8zufj7b1bHwTx5uSTichTLXQibRuIaxmRGibw/132","comment_is_top":false,"comment_ctime":1598915452,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598915452","product_id":100020901,"comment_content":"请教下，如果是一个短时进程或者线程疯狂的写文件，应该如何定位呢，用工具的时候进程可能进程已经结束，或者线程已经结束？","like_count":0},{"had_liked":false,"id":244593,"user_name":"Geek_8c2731","can_delete":false,"product_type":"c1","uid":1928194,"ip_address":"","ucode":"A87F938209D65A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkGGBK46EQpqE6zWCncMs14Jw95s191Y6pk3x3gQpNrvSc2YWoFEgUxmJWicibGp7XsFFKaZxuTSnA/132","comment_is_top":false,"comment_ctime":1598587066,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598587066","product_id":100020901,"comment_content":"老师，线上环境，内核3.0，装不了bcc 工具包。VMstat输出查看到cache7G，进程已经申请不到内存导致任务失败，也就是说系统没有回收释放缓存，我该用什么办法找出这个原因。避免后期再次出现","like_count":0},{"had_liked":false,"id":234555,"user_name":"Nick","can_delete":false,"product_type":"c1","uid":1921287,"ip_address":"","ucode":"64BBE005890845","user_header":"https://static001.geekbang.org/account/avatar/00/1d/51/07/b5a945b6.jpg","comment_is_top":false,"comment_ctime":1594718996,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594718996","product_id":100020901,"comment_content":"老师，我最近发下服务器free出来的内存会不断减少，但是网上搜索到这样一段描述“空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到free中去，因此在linux上free内存会越来越少，但不用为此担心。如果出于习惯去计算可用内存数，这里有个近似的计算公式：第四行的free + 第四行的buffers + 第五行的cached” 。请问是不是就不用关心free出来的内存变小？","like_count":0},{"had_liked":false,"id":227183,"user_name":"天草二十六","can_delete":false,"product_type":"c1","uid":1360712,"ip_address":"","ucode":"3165EE3007527B","user_header":"https://static001.geekbang.org/account/avatar/00/14/c3/48/3a739da6.jpg","comment_is_top":false,"comment_ctime":1592307596,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592307596","product_id":100020901,"comment_content":"java内存泄露，有什么好的排查手段吗， 除了jmap导出堆信息外， dump文件实在太大了，下载费事。<br>free看到内存占用的内存3G多， jvm的堆最大也才设置为1G。 使用pinpoint监控jvm, 没有看到full gc， 看到堆最大值也没超过1G，日志里也没有看到oom异常错误。 jmap -histo:live 看到的对象大小也大多是jdk自身的类，而且未超过1G, jmap本来想去掉histo:live， 来查看所有的，线上用户没有权限。<br>---- 内存问题，针对性的java语音这块，还有没有其他手段好推荐一二， 不具备本地调试的条件目前。 <br>","like_count":0},{"had_liked":false,"id":196002,"user_name":"丁乐洪","can_delete":false,"product_type":"c1","uid":1264392,"ip_address":"","ucode":"549CE57AB20B49","user_header":"https://static001.geekbang.org/account/avatar/00/13/4b/08/52954cd7.jpg","comment_is_top":false,"comment_ctime":1585229400,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585229400","product_id":100020901,"comment_content":"有了套路，下一步是多实践","like_count":0},{"had_liked":false,"id":193965,"user_name":"linker","can_delete":false,"product_type":"c1","uid":1803259,"ip_address":"","ucode":"6C5799F2FC2C82","user_header":"https://static001.geekbang.org/account/avatar/00/1b/83/fb/621adceb.jpg","comment_is_top":false,"comment_ctime":1585008550,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585008550","product_id":100020901,"comment_content":"为什么没有说内核的内存问题，比较伙伴系统泄露等？","like_count":0},{"had_liked":false,"id":189451,"user_name":"刘友淙","can_delete":false,"product_type":"c1","uid":1620058,"ip_address":"","ucode":"97F3A69A308313","user_header":"","comment_is_top":false,"comment_ctime":1584517586,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584517586","product_id":100020901,"comment_content":"D9 打卡","like_count":0},{"had_liked":false,"id":170247,"user_name":"吴小喵","can_delete":false,"product_type":"c1","uid":1392780,"ip_address":"","ucode":"A8CB5407A89593","user_header":"https://static001.geekbang.org/account/avatar/00/15/40/8c/bc76ecd3.jpg","comment_is_top":false,"comment_ctime":1578556702,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578556702","product_id":100020901,"comment_content":"老师，我是一个基础比较差的同学，看这个专栏很费劲，能不能说明一下需要先学什么基础知识","like_count":0},{"had_liked":false,"id":162854,"user_name":"王旧业","can_delete":false,"product_type":"c1","uid":1013076,"ip_address":"","ucode":"A8DEC38430D007","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/54/73cc7f73.jpg","comment_is_top":false,"comment_ctime":1576625081,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576625081","product_id":100020901,"comment_content":"glibc相关的一些参数引起的内存异常，老师有没有案例？","like_count":0},{"had_liked":false,"id":152589,"user_name":"诺克大叔","can_delete":false,"product_type":"c1","uid":1075501,"ip_address":"","ucode":"373FF68C5EE169","user_header":"https://static001.geekbang.org/account/avatar/00/10/69/2d/ff2fa54e.jpg","comment_is_top":false,"comment_ctime":1574046287,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574046287","product_id":100020901,"comment_content":"老师您好，如何快速的定位，系统上哪个程序占用较大内存，也就是说内存都去哪了？","like_count":0},{"had_liked":false,"id":152365,"user_name":"fly2best","can_delete":false,"product_type":"c1","uid":1161951,"ip_address":"","ucode":"C08673A53B6B0E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/1QaemlbAe4ZXibt2fAFtqMXzyDGgPjCiaFibH7nP2sObHjJUW0qfBY3dUb5oics9j4rqEygGq8fn6pdiaxtVEzhlPAQ/132","comment_is_top":false,"comment_ctime":1573983234,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1573983234","product_id":100020901,"comment_content":"你好，请教一下sar -B 中pgscand的含义","like_count":0,"discussions":[{"author":{"id":1013424,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/76/b0/14fec62f.jpg","nickname":"不了峰","note":"","ucode":"E23B96D6A3D4EC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551053,"discussion_content":"直接页面扫描","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644890225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139965,"user_name":"new","can_delete":false,"product_type":"c1","uid":1081910,"ip_address":"","ucode":"D02D595CDB9805","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/36/3c2d4416.jpg","comment_is_top":false,"comment_ctime":1570775856,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1570775856","product_id":100020901,"comment_content":"内存泄露定位实际上操作起来还是很蒙，比如我用pidstat观察到某个进程的Rss值一直在递增，但是总体占用内存又很小，而且每次递增也只有几百kb，用vmstat观察内存也不是一直在增加，这种就不知道怎么回事了，所以内存泄露是要结合多方面来看吗，那这种情况我需要怎么确认这个进程的到底有没有内存泄露呢","like_count":0},{"had_liked":false,"id":132378,"user_name":"坤丰","can_delete":false,"product_type":"c1","uid":1143705,"ip_address":"","ucode":"AEE94BF9B837AB","user_header":"https://static001.geekbang.org/account/avatar/00/11/73/99/eb99b2cb.jpg","comment_is_top":false,"comment_ctime":1568103579,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568103579","product_id":100020901,"comment_content":"次缺页多少算高呢？<br>如果过高的话，需要怎么处理","like_count":0},{"had_liked":false,"id":104400,"user_name":"群书","can_delete":false,"product_type":"c1","uid":1437036,"ip_address":"","ucode":"BA9EE71D2D818A","user_header":"https://static001.geekbang.org/account/avatar/00/15/ed/6c/6fb35017.jpg","comment_is_top":false,"comment_ctime":1560744779,"is_pvip":true,"replies":[{"id":"37817","content":"请参考第18篇","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1560764436,"ip_address":"","comment_id":104400,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1560744779","product_id":100020901,"comment_content":"大佬 线上环境发现有内存泄漏 怎么处理","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454258,"discussion_content":"请参考第18篇","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560764436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93781,"user_name":"dao","can_delete":false,"product_type":"c1","uid":1087879,"ip_address":"","ucode":"4181FB270462CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","comment_is_top":false,"comment_ctime":1557587722,"is_pvip":true,"replies":[{"id":"33531","content":"加油","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1557670827,"ip_address":"","comment_id":93781,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1557587722","product_id":100020901,"comment_content":"学到这了，觉得有点吃力了，记录一下","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449769,"discussion_content":"加油","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557670827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93488,"user_name":"jimmy","can_delete":false,"product_type":"c1","uid":1018298,"ip_address":"","ucode":"852C5476842A58","user_header":"https://static001.geekbang.org/account/avatar/00/0f/89/ba/e1d6ce24.jpg","comment_is_top":false,"comment_ctime":1557479992,"is_pvip":false,"replies":[{"id":"33533","content":"man查手册 这是必会的的一个技能","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1557670905,"ip_address":"","comment_id":93488,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1557479992","product_id":100020901,"comment_content":"文章说通过ps、top命令查看缺页异常，哪个指标代表缺页异常的","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449654,"discussion_content":"man查手册 这是必会的的一个技能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557670905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1959822,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/e7/8e/318cfde0.jpg","nickname":"Spoon","note":"","ucode":"2FF9193AD482C2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338553,"discussion_content":"man ps/top进入之后搜索fault关键字啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609311326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":88146,"user_name":"Jec","can_delete":false,"product_type":"c1","uid":1452205,"ip_address":"","ucode":"3E0C0C13292B03","user_header":"https://static001.geekbang.org/account/avatar/00/16/28/ad/9a2ab0cf.jpg","comment_is_top":false,"comment_ctime":1555858487,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555858487","product_id":100020901,"comment_content":"老师，虽然java的内存分析这些用不上，能分享一下java程序的一些内存高调优的方法和案例吗","like_count":0},{"had_liked":false,"id":66906,"user_name":"如果","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1550039733,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550039733","product_id":100020901,"comment_content":"day21,打卡","like_count":0},{"had_liked":false,"id":61752,"user_name":"shibo","can_delete":false,"product_type":"c1","uid":1363215,"ip_address":"","ucode":"003A5780BB0AFE","user_header":"","comment_is_top":false,"comment_ctime":1547790837,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1547790837","product_id":100020901,"comment_content":"有干货，物超所值，非常有收获，继续打卡","like_count":0},{"had_liked":false,"id":58978,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1547264455,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547264455","product_id":100020901,"comment_content":"打卡<br>","like_count":0},{"had_liked":false,"id":57792,"user_name":"Charlescliff","can_delete":false,"product_type":"c1","uid":1007612,"ip_address":"","ucode":"C5743F21C7C499","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5f/fc/840a833b.jpg","comment_is_top":false,"comment_ctime":1546912349,"is_pvip":false,"replies":[{"id":"20998","content":"上监控系统，各种内存指标增长的趋势是可以看到的","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1547028667,"ip_address":"","comment_id":57792,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546912349","product_id":100020901,"comment_content":"老师，如果是swap缓慢的增长该如何分析呢，每天几十M的速度，sar vmstat几乎看不到si so，程序跑了一个月增长了一个g swap","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435764,"discussion_content":"上监控系统，各种内存指标增长的趋势是可以看到的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547028667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57602,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1546846093,"is_pvip":false,"replies":[{"id":"20763","content":"😢","user_name":"作者回复","user_name_real":"倪朋飞","uid":"1001282","ctime":1546853752,"ip_address":"","comment_id":57602,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546846093","product_id":100020901,"comment_content":"[D22打卡]<br>内存的分析方法 和 工具 有了个印象.<br>等遇到了内存方面的性能问题再来精读吧.<br>现在我个人精力有限. 只能先抓重点了. <br>并不是老师的专栏写的不好.😂😂","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435661,"discussion_content":"😢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546853752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57478,"user_name":"大青蛙","can_delete":false,"product_type":"c1","uid":1315713,"ip_address":"","ucode":"D0066C85F48515","user_header":"https://static001.geekbang.org/account/avatar/00/14/13/81/f16a0401.jpg","comment_is_top":false,"comment_ctime":1546820870,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546820870","product_id":100020901,"comment_content":"沙发","like_count":0}]}