{"id":623839,"title":"18｜自托管构建：如何使用 Tekton 构建镜像？","content":"<p>你好，我是王炜。</p><p>前两节课，我们分别介绍了如何使用 GitHub Action Workflow 和 GitLab CI 来自动构建镜像，它们配置起来相对简单，作为平台自带的功能，也不需要花费额外的维护成本。并且，它们都和 Git 仓库深度整合，这就让触发流水线变得非常简单了。</p><p>对于构建次数较少的团队来说，在免费额度范围内使用它们是一个非常好的选择。但是对于构建次数非常频繁的中大型团队来说，综合考虑费用、可控和定制化等各方面因素，他们可能会考虑使用其他自托管的方案。</p><p>这节课，我们就来介绍其中一种自动构建镜像的自托管方案：<strong>使用 Tekton 来自动构建镜像。</strong>Tekton 是一款基于 Kubernetes 的 CI/CD 开源产品，如果你已经有一个 Kubernetes 集群，那么利用 Tekton 直接在 Kubernetes 上构建镜像是一个不错的选择。</p><p>我会首先带你了解 Tekton 的基本概念，然后我们仍然以示例应用为例，从零开始为示例应用配置构建镜像的流水线，并结合 GitHub为 Tekton 配置 Webhook 触发器，实现提交代码之后触发 Tekton 流水线并构建镜像，最后推送到镜像仓库的过程。</p><p>在学完这节课之后，你将基本掌握 Tekton 的流水线以及触发器的用法，并具备独立配置它们的能力。</p><!-- [[[read_end]]] --><p>在开始今天的学习之前，你需要具备以下前提条件。</p><ul>\n<li>在本地安装了 kubectl。</li>\n<li>已经按照<a href=\"https://time.geekbang.org/column/article/622743\">第16讲</a>将 <a href=\"https://github.com/lyzhang1999/kubernetes-example\">kubernetes-example</a> 示例应用代码推送到了自己的 GitHub 仓库中。</li>\n</ul><h2>准备 Kubernetes 集群</h2><p>由于我们在实践的过程中需要 Kubernetes 集群的 Loadbalancer 能力，所以，首先你需要准备一个云厂商的 Kubernetes 集群，你可以使用 AWS、阿里云或腾讯云等任何云厂商。这里我以开通腾讯云 TKE 集群为例演示一下，<strong>这部分内容比较基础，如果你已经有云厂商 Kubernetes 集群，或者熟悉开通过程，都可以跳过这个步骤。</strong></p><p>首先，登录腾讯云并在<a href=\"https://console.cloud.tencent.com/tke2\">这个页面</a>打开 TKE 控制台，点击“新建”按钮，选择“标准集群”。</p><p><img src=\"https://static001.geekbang.org/resource/image/06/19/06a9f41ea4995155e6f59f1050e72519.png?wh=1920x1113\" alt=\"图片\"></p><p>在创建集群页面输入“集群名称”，“所在地域”项中选择“中国香港”，集群网络选择“Default”，其他信息保持默认，点击下一步。</p><p><img src=\"https://static001.geekbang.org/resource/image/d4/9e/d4d3e50848b7955ae17d5713e050199e.png?wh=1710x868\" alt=\"图片\"></p><p>接下来进入到 Worker 节点配置阶段。在“机型”一栏中选择一个 2 核 8G 的节点，在“公网带宽”一栏中将带宽调整为 100Mbps，并且按量计费。</p><p><img src=\"https://static001.geekbang.org/resource/image/84/ab/84b2b5e0eae4f7d730831aab913fc5ab.png?wh=1920x812\" alt=\"图片\"></p><p>点击“下一步”。后续的页面都保持默认选择，点击“完成”创建 Kubernetes 集群。这里需要等待几分钟直至集群准备就绪。</p><p><img src=\"https://static001.geekbang.org/resource/image/8a/1e/8a1e7316111ba78caa5a40c4acd40f1e.png?wh=1778x406\" alt=\"图片\"></p><p>点击集群名称“docker-build”进入集群详情页，在“集群APIServer信息”一栏找到“外网访问”，点击开关来开启集群的外网访问。</p><p><img src=\"https://static001.geekbang.org/resource/image/b0/a8/b05a317c0fecf31110634a2f44a58aa8.png?wh=1300x332\" alt=\"图片\"></p><p>在弹出的新窗口中，选择“Default”安全组并选择“按使用流量”计费，访问方式选择“公网 IP”，然后点击“保存”开通集群外网访问。</p><p><img src=\"https://static001.geekbang.org/resource/image/67/6b/6754def296488c9ac73fa26ayy8dcd6b.png?wh=1334x956\" alt=\"图片\"></p><p>等待“外网访问”开关转变为启用状态。</p><p>接下来，在“Kubeconfig”一栏点击“复制”，复制集群 Kubeconfig 信息。</p><p><img src=\"https://static001.geekbang.org/resource/image/15/35/15ca4f2ee0a02e3aea7b74b0c68d1835.png?wh=1304x514\" alt=\"图片\"></p><p>接下来，将集群证书信息内容写入到本地的 ~/.kube/config 文件内，这是 kubectl 默认读取 kubeconfig 的文件位置。</p><p>为了避免覆盖已有的 kubeconfig，首先你需要备份 ~/.kube/config 文件。</p><pre><code class=\"language-powershell\">$ mv ~/.kube/config ~/.kube/config-bak\n</code></pre><p>然后新建 ~/.kube/config 文件，将刚才复制的 Kubeconfig 内容写入到该文件内。</p><p>最后，执行 kubectl get node 来验证 kubectl 与集群的联通性。</p><pre><code class=\"language-powershell\">$ kubectl get node\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATUS&nbsp; &nbsp;ROLES&nbsp; &nbsp; AGE&nbsp; &nbsp; &nbsp;VERSION\n172.19.0.107&nbsp; &nbsp;Ready&nbsp; &nbsp; &lt;none&gt;&nbsp; &nbsp;5m21s&nbsp; &nbsp;v1.22.5-tke.5\n</code></pre><p>待 Node 信息返回后，我们的 Kubernetes 集群也就准备好了。</p><h2>安装组件</h2><p>准备好云厂商 Kubernetes 集群之后，接下来我们需要安装两个组件，分别是 Tekton 相关的组件以及 Ingress-Nginx。</p><h3>Tekton</h3><p>首先，安装 Tekton Operator。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml\nnamespace/tekton-pipelines created\npodsecuritypolicy.policy/tekton-pipelines created\n......\n</code></pre><p>等待 Tekton 所有的 Pod 就绪。</p><pre><code class=\"language-powershell\">$ kubectl wait --for=condition=Ready pods --all -n tekton-pipelines --timeout=300s\npod/tekton-pipelines-controller-799f9f989b-hxmlx condition met\npod/tekton-pipelines-webhook-556f9f7476-sgx2n condition met\n</code></pre><p>接下来，安装 Tekton Dashboard。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://storage.googleapis.com/tekton-releases/dashboard/latest/release.yaml\nserviceaccount/tekton-dashboard created\nrole.rbac.authorization.k8s.io/tekton-dashboard-info created\n......\n</code></pre><p>然后，分别安装 Tekton Trigger 和 Tekton Interceptors 组件。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml\npodsecuritypolicy.policy/tekton-triggers created\nclusterrole.rbac.authorization.k8s.io/tekton-triggers-admin created\n......\n\n$ kubectl apply -f https://storage.googleapis.com/tekton-releases/triggers/latest/interceptors.yaml\ndeployment.apps/tekton-triggers-core-interceptors created\nservice/tekton-triggers-core-interceptors created\n......\n</code></pre><p>等待所有 Tekton 的所有组件的 Pod 都处于就绪状态，Tekton 就部署完成了。</p><pre><code class=\"language-powershell\">$ kubectl wait --for=condition=Ready pods --all -n tekton-pipelines --timeout=300s\npod/tekton-dashboard-5d94c7f687-8t6p2 condition met\npod/tekton-pipelines-controller-799f9f989b-hxmlx condition met\npod/tekton-pipelines-webhook-556f9f7476-sgx2n condition met\npod/tekton-triggers-controller-bffdd47cf-cw7sv condition met\npod/tekton-triggers-core-interceptors-5485b8bd66-n9n2m condition met\npod/tekton-triggers-webhook-79ddd8d6c9-f79tg condition met\n</code></pre><h3>Ingress-Nginx</h3><p>安装完 Tekton 之后，我们再来安装 Ingress-Nginx。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/cloud/deploy.yaml\nnamespace/ingress-nginx created\nserviceaccount/ingress-nginx created\nserviceaccount/ingress-nginx-admission created\n......\n</code></pre><p>等待所有 Ingress-Nginx Pod 处于就绪状态，Ingress-Nginx 就部署完成了。</p><pre><code class=\"language-powershell\">$ kubectl wait --for=condition=AVAILABLE deployment/ingress-nginx-controller --all -n ingress-nginx\ndeployment.apps/ingress-nginx-controller condition met\n</code></pre><h3>暴露 Tekton Dashboard</h3><p>配置好 Tekton 和 Ingress-Nginx 之后，为了方便访问 Tekton Dashboard，我们要通过 Ingress 的方式暴露它，将下列内容保存为 tekton-dashboard.yaml。</p><pre><code class=\"language-powershell\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: ingress-resource\n  namespace: tekton-pipelines\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/ssl-redirect: \"false\"\nspec:\n  rules:\n    - host: tekton.k8s.local\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: tekton-dashboard\n                port:\n                  number: 9097\n</code></pre><p>然后，执行 kubectl apply 将它应用到集群内。</p><pre><code class=\"language-powershell\">$ kubectl apply -f tekton-dashboard.yaml\ningress.networking.k8s.io/ingress-resource created\n</code></pre><p>接下来，获取 Ingress-Nginx Loadbalancer 的外网 IP 地址。你可以使用 kubectl get service 来获取。</p><pre><code class=\"language-powershell\">$ kubectl get services --namespace ingress-nginx ingress-nginx-controller --output jsonpath='{.status.loadBalancer.ingress[0].ip}'\n43.135.82.249\n</code></pre><p>由于之前我在 Ingress 策略中配置的是一个虚拟域名，<strong>所以需要在本地配置 Hosts</strong>。当然你也可以将 Ingress 的 host 修改为实际的域名，并且为域名添加 DNS 解析，也能达到同样的效果。</p><p>以 Linux 系统为例，要修改 Hosts，你需要将下面的内容添加到 /etc/hosts 文件内。</p><pre><code class=\"language-powershell\">43.135.82.249 tekton.k8s.local\n</code></pre><p>然后，你就可以通过域名 <a href=\"http://tekton.k8s.local\">http://tekton.k8s.local</a> 来访问 Tekton Dashboard 了。</p><p><img src=\"https://static001.geekbang.org/resource/image/2c/21/2c543f8aa1ec09b7d3eb03d0e323bd21.png?wh=1920x1041\" alt=\"图片\"></p><h2>Tekton 简介</h2><p>在正式创建 Tekton 流水线之前，你需要先了解一些基本概念，你可以结合下面这张图来理解一下。</p><p><img src=\"https://static001.geekbang.org/resource/image/db/3f/db54feyy96365d7358678857eca5883f.jpg?wh=1920x703\" alt=\"图片\"></p><p>在上面这张图中，从左往右依次出现了这几个概念：EventListener、TriggerTemplate、PipelineRun、Pipeline、Task 以及 Step，接下来，我就简单介绍一下它们。</p><h3>EventListener</h3><p>EventListener 顾名思义是一个事件监听器，它是外部事件的入口。EventListener 通常以 HTTP 的方式对外暴露，在我们这节课的例子中，我们会在 GitHub 创建 WebHook 来调用 Tekton 的 EventListener，使它能接收到仓库推送事件。</p><h3>TriggerTemplate</h3><p>当 EventListener 接收到外部事件之后，它会调用 Trigger 也就是触发器，而 TriggerTemplate 是用来定义接收到事件之后需要创建的 Tekton 资源的，例如创建一个 PipelineRun 对象来运行流水线。这节课，我们会使用 TriggerTemplate 来创建 PipelineRun 资源。</p><h3>Step</h3><p>Step 是流水线中的一个具体的操作，例如构建和推送镜像操作。Step 接收镜像和需要运行的 Shell 脚本作为参数，Tekton 将会启动镜像并执行 Shell 脚本。</p><h3>Task</h3><p>Task 是一组有序的 Step 集合，每一个 Task 都会在独立的 Pod 中运行，Task 中不同的 Step 将在同一个 Pod 不同的容器内运行。</p><h3>Pipeline</h3><p>Pipeline 是 Tekton 中的一个核心组件，它是一组 Task 的集合，Task 将组成一组有向无环图（DAG），Pipeline 会按照 DAG 的顺序来执行。</p><h3>PipelineRun</h3><p>PipelineRun 实际上是 Pipeline 的实例化，它负责为 Pipeline 提供输入参数，并运行 Pipeline。例如，两次不同的镜像构建操作对应的就是两个不同的 PipelineRun 资源。</p><h2>创建 Tekton Pipeline</h2><p>可以看出，Tekton 的概念确实比较多，抽象也不好理解。别担心，接下来我们就实际创建一下流水线，在这个过程中不断加深理解。</p><h3>概述</h3><p>我们先来看看这节课创建的 Tekton 流水线最终可以实现的效果，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/03/64/034e124d0ebf48f722af67dc1f647864.jpg?wh=1920x677\" alt=\"图片\"></p><p>简单来说，当我们向 GitHub 推送代码时，GitHub 将以 HTTP 请求的方式通知集群内的 Tekton 触发器，触发器通过 Ingress-Nginx 对外暴露，当触发器接收到来自 GitHub 的事件推送时，将通过 TriggerTemplate 来创建 PipelineRun 运行 Pipeline，最终实现镜像的自动构建和推送。</p><h3>创建 Task</h3><p>好，下面我们正式开始实战。<strong>在创建 Pipeline 之前，我们需要先创建两个 Task，这两个 Task 分别负责“检出代码”还有“构建和推送镜像”。</strong></p><p>首先创建检出代码的 Task。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/lyzhang1999/gitops/main/ci/18/tekton/task/git-clone.yaml\ntask.tekton.dev/git-clone created\n</code></pre><p>这个 Task 是 Tekton 官方提供的插件，它和 GitHub Action 的 checkout 插件有一点类似，主要作用是检出代码。在这里，我们不需要理解它具体的细节。<br>\n然后，创建构建和推送镜像的 Task。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/lyzhang1999/gitops/main/ci/18/tekton/task/docker-build.yaml\ntask.tekton.dev/docker-socket configured\n</code></pre><p>简单介绍一个这个 Task，关键内容如下。</p><pre><code class=\"language-powershell\">apiVersion: tekton.dev/v1beta1\nkind: Task\nmetadata:\n  name: docker-socket\nspec:\n  workspaces:\n    - name: source\n  params:\n    - name: image\n      description: Reference of the image docker will produce.\n    ......\n  steps:\n    - name: docker-build\n      image: docker:stable\n      env:\n        ......\n        - name: IMAGE\n          value: $(params.image)\n        - name: DOCKER_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: registry-auth\n              key: password\n        - name: DOCKER_USERNAME\n          valueFrom:\n            secretKeyRef:\n              name: registry-auth\n              key: username\n      workingDir: $(workspaces.source.path)\n      script: |\n        cd $SUBDIRECTORY\n        docker login $REGISTRY_URL -u $DOCKER_USERNAME -p $DOCKER_PASSWORD\n        if [ \"${REGISTRY_URL}\" = \"docker.io\" ] ; then\n          docker build --no-cache -f $CONTEXT/$DOCKERFILE_PATH -t $DOCKER_USERNAME/$IMAGE:$TAG $CONTEXT\n          docker push $DOCKER_USERNAME/$IMAGE:$TAG\n          exit\n        fi\n        docker build --no-cache -f $CONTEXT/$DOCKERFILE_PATH -t $REGISTRY_URL/$REGISTRY_MIRROR/$IMAGE:$TAG $CONTEXT\n        docker push $REGISTRY_URL/$REGISTRY_MIRROR/$IMAGE:$TAG\n      volumeMounts: # 共享 docker.socket\n        - mountPath: /var/run/\n          name: dind-socket\n  sidecars: #sidecar 提供 docker daemon\n    - image: docker:dind\n      ......\n</code></pre><p>spec.params 字段用来定义变量，并最终由 PipelineRun 提供具体的值。</p><p>spec.steps 字段用来定义具体的执行步骤，例如，我们在这里使用 docker:stable 镜像创建了容器，并将 spec.params 定义的变量以 ENV 的方式传递到容器内部，其中 DOCKER_PASSWORD 和 DOCKER_USERNAME 两个变量来源于 Secret，我们将在后续创建。</p><p>spec.steps[0].script 字段定义了具体执行的命令，这里执行了 docker login 登录到 Docker Hub，并且使用了 docker build 和 docker push 来构建和推送镜像。我们对 Docker Hub 和其他镜像仓库做了区分，以便使用不同的 TAG 命名规则。</p><p>spec.sidecars 字段为容器提供 Docker daemon，它使用的镜像是 docker:dind。</p><p>仔细回想一下上节课的内容你会发现，<strong>这个 Task 定义的具体行为和 GitLab CI 定义的流水线非常类似</strong>，它们都是指定一个镜像，然后运行一段脚本，并且都是用 DiND 的方式来构建和推送镜像的。</p><h3>创建 Pipeline</h3><p>创建完 Task 之后，由于它们实现的具体功能是独立的，所以我们需要将他们联系起来。也就是说，我们希望 Pipeline 先克隆代码，再构建和推送镜像。所以，下面我们需要创建 Pipeline 来引用这两个 Task。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/lyzhang1999/gitops/main/ci/18/tekton/pipeline/pipeline.yaml\npipeline.tekton.dev/github-trigger-pipeline created\n</code></pre><p>这里我也简单介绍一下这个 Pipeline。</p><pre><code class=\"language-powershell\">apiVersion: tekton.dev/v1beta1\nkind: Pipeline\nmetadata:\n  name: github-trigger-pipeline\nspec:\n  workspaces:\n    - name: pipeline-pvc\n    ......\n  params:\n    - name: subdirectory # 为每一个 Pipeline 配置一个 workspace，防止并发错误\n      type: string\n      default: \"\"\n    - name: git_url\n    ......\n  tasks:\n    - name: clone\n      taskRef:\n        name: git-clone\n      workspaces:\n        - name: output\n          workspace: pipeline-pvc\n        - name: ssh-directory\n          workspace: git-credentials\n      params:\n        - name: subdirectory\n          value: $(params.subdirectory)\n        - name: url\n          value: $(params.git_url)\n    - name: build-and-push-frontend\n      taskRef:\n        name: docker-socket\n      runAfter:\n        - clone\n      workspaces:\n        - name: source\n          workspace: pipeline-pvc\n      params:\n        - name: image\n          value: \"frontend\"\n        ......\n    - name: build-and-push-backend\n      taskRef:\n        name: docker-socket\n      runAfter:\n        - clone\n      workspaces:\n        - name: source\n          workspace: pipeline-pvc\n      params:\n        - name: image\n          value: \"backend\"\n        ......\n</code></pre><p>首先，spec.workspaces 定义了一个工作空间。还记得我们提到的每一个 Task 都会在独立的 Pod 中运行吗？那么不同的 Task 如何共享上下文呢？答案就是 workspaces。实际上它是一个 PVC 持久化卷，这个 PVC 将会在 Pod 之间复用，这就让下游 Task 可以读取到上游 Task 写入的数据（比如克隆的代码）。</p><p>spec.params 定义了 Pipeline 的参数，参数的传递顺序是：PipelineRun-&gt;Pipeline-&gt;Task。</p><p>spec.tasks 定义了 Pipeline 引用的 Task，例如在这里分别引用了 git-clone 和 docker-socket 两个 Task，并且都指定了同一个 workspaces pipeline-pvc，然后指定了 params 向 Task 传递了参数值。</p><p>在 build-and-push-frontend 和 build-and-push-backend Task 中，都指定了 runAfter 字段，它的含义是等待 clone Task 执行完毕后再运行。</p><p>所以，Pipeline 对 Task 的引用就形成了一个有向无环图（DAG），在这个 Pipeline 中，首先会检出源码，然后以并行的方式同时构建前后端镜像。</p><h3>创建 EventListener</h3><p>创建完 Pipeline 之后，工作流实际上就已经定义好了。但是我们并不希望手动来运行它，我们希望通过 GitHub 来自动触发它。所以，接下来需要创建 EventListener 来获得一个能够监听外部事件的服务。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/lyzhang1999/gitops/main/ci/18/tekton/trigger/github-event-listener.yaml\neventlistener.triggers.tekton.dev/github-listener created\n</code></pre><p>EventListener 的具体作用是：接收来自 GitHub 的 Webhook 调用，并将 Webhook 的参数和TriggerTemplate 定义的参数对应起来，以便将参数值从 Webhook 一直传递到 PipelineRun。</p><h3>暴露 EventListener</h3><p>在 EventListener 创建完成之后，Tekton 将会拉起一个 Deployment 用来处理 Webhook 请求，你可以通过 kubectl get deployment 命令来查看。</p><pre><code class=\"language-yaml\">$ kubectl get deployment\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;READY&nbsp; &nbsp;UP-TO-DATE&nbsp; &nbsp;AVAILABLE&nbsp; &nbsp;AGE\nel-github-listener&nbsp; &nbsp;1/1&nbsp; &nbsp; &nbsp;1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;22m\n</code></pre><p>同时，Tekton 也会为 el-github-listener Deployment 创建 Service，以便接受来自外部的 HTTP 请求。</p><pre><code class=\"language-yaml\">$ kubectl get service&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TYPE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CLUSTER-IP&nbsp; &nbsp; &nbsp; EXTERNAL-IP&nbsp; &nbsp; PORT(S)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AGE\nel-github-listener&nbsp; &nbsp; ClusterIP&nbsp; &nbsp; &nbsp; 172.16.253.54&nbsp; &nbsp;&lt;none&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8080/TCP,9000/TCP&nbsp; &nbsp;4h23m\n</code></pre><p>为了能够让 GitHub 将事件推送到 Tekton 中，我们需要暴露 el-github-listener Service。我使用了 Ingress-Nginx 来对外暴露它。</p><pre><code class=\"language-powershell\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/lyzhang1999/gitops/main/ci/18/tekton/ingress/github-listener.yaml\ningress.networking.k8s.io/ingress-resource created\n</code></pre><p>这个 Ingress 的内容比较简单，具体如下。</p><pre><code class=\"language-powershell\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: ingress-resource\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/ssl-redirect: \"false\"\nspec:\n  rules:\n    - http:\n        paths:\n          - path: /hooks\n            pathType: Exact\n            backend:\n              service:\n                name: el-github-listener\n                port:\n                  number: 8080\n</code></pre><p>在 Ingress 策略中，我们没有使用 host 定义域名，而使用了 path 来匹配路径。这样，Tekton 接收外部 Webhook 的入口也就是 Ingress-Nginx 的负载均衡器 IP 地址了，具体的地址为 <a href=\"http://43.135.82.249/hooks%E3%80%82\">http://43.135.82.249/hooks。</a></p><h3>创建 TriggerTemplate</h3><p>不过 EventListener 并不能独立工作，它还需要一个助手，那就是 TriggerTemplate。TriggerTemplate 是真正控制 Pipeline 启动的组件，它负责创建 PipelineRun。</p><p>我们可以通过下面的命令来创建 TriggerTemplate。</p><pre><code class=\"language-yaml\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/lyzhang1999/gitops/main/ci/18/tekton/trigger/github-trigger-template.yaml\ntriggertemplate.triggers.tekton.dev/github-template created\n</code></pre><h3>创建 Service Account 和 PVC</h3><p>下一步，由于触发器并没有具体的执行用户，所以我们还需要为触发器配置权限，也就是创建 Service Account。同时，我们也可以一并创建用于共享 Task 之间上下文的 PVC 。</p><pre><code class=\"language-yaml\">$ kubectl apply -f https://ghproxy.com/https://raw.githubusercontent.com/lyzhang1999/gitops/main/ci/18/tekton/other/service-account.yaml\nserviceaccount/tekton-build-sa created\nclusterrolebinding.rbac.authorization.k8s.io/tekton-clusterrole-binding created\npersistentvolumeclaim/pipeline-pvc created\nrole.rbac.authorization.k8s.io/tekton-triggers-github-minimal created\nrolebinding.rbac.authorization.k8s.io/tekton-triggers-github-binding created\nclusterrole.rbac.authorization.k8s.io/tekton-triggers-github-clusterrole created\nclusterrolebinding.rbac.authorization.k8s.io/tekton-triggers-github-clusterbinding created\n</code></pre><h3>设置 Secret</h3><p>最后，我们还需要为 Tekton 提供一些凭据信息，例如 Docker Hub Token、GitHub Webhook Secret 以及用于检出私有仓库的私钥信息。</p><p>将下面的内容保存为 secret.yaml，并修改相应的内容。</p><pre><code class=\"language-yaml\">apiVersion: v1\nkind: Secret\nmetadata:\n  name: registry-auth\n  annotations:\n    tekton.dev/docker-0: https://docker.io\ntype: kubernetes.io/basic-auth\nstringData:\n  username: \"\" # docker username\n  password: \"\" # docker hub token\n\n---\n# github webhook token secret\napiVersion: v1\nkind: Secret\nmetadata:\n  name: github-secret\ntype: Opaque\nstringData:\n  secretToken: \"webhooksecret\"\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: git-credentials\ndata:\n  id_rsa: LS0tLS......\n  known_hosts: Z2l0aHViLm......\n  config: SG9zd......\n</code></pre><p>解释一下，你主要需要修改的是下面这几个字段。</p><ul>\n<li>将 stringData.username 替换为你的 Docker Hub 的用户名。</li>\n<li>将 stringData.password 替换为你的 Docker Hub Token，如果你还没有创建好，可以在<a href=\"https://time.geekbang.org/column/article/623358\">上一节课</a>找到相应内容。</li>\n<li>将 data.id_rsa 替换为你本地 ~/.ssh/id_rsa 文件的 base64 编码内容，这将会为 Tekton 提供检出私有仓库的权限，你可以使用 <code>$ cat ~/.ssh/id_rsa | base64</code> 命令来获取。</li>\n<li>将 data.known_hosts 替换为你本地 ~/.ssh/known_hosts 文件的 base64 编码内容，你可以通过 <code>$ cat ~/.ssh/known_hosts | grep \"github\" | base64</code> 命令来获取。</li>\n<li>将 data.config 替换为你本地 ~/.ssh/config 文件的 base64 编码内容，你可以通过 <code>$ cat ~/.ssh/config | base64</code> 命令来获取。</li>\n</ul><p>然后，运行 kuebctl apply，同时将这 3 个 Secret 应用到集群内。</p><pre><code class=\"language-powershell\">$ kubectl apply -f secret.yaml\nsecret/registry-auth created\nsecret/github-secret created\nsecret/git-credentials created\n</code></pre><h2>创建 GitHub Webhook</h2><p>到这里，Tekton 的配置就已经完成了。接下来还剩最后一步：创建 GitHub Webhook。</p><p>打开你在 GitHub 创建的 kubernetes-example 仓库，进入“Settings”页面，点击左侧的“Webhooks”菜单，在右侧的页面中按照下图进行配置。</p><p><img src=\"https://static001.geekbang.org/resource/image/1e/c4/1e34209ddb966834bab1cd764745e6c4.png?wh=1920x873\" alt=\"图片\"></p><p>输入 Webhook 地址，也就是“ Ingress-Nginx 网关的负载均衡器地址 + hooks 路径”，并且将“Content type”配置为“application/json”。</p><p>点击“Add webhook”创建。</p><h2>触发 Pipeline</h2><p>到这里，所有的准备工作就已经完成了。现在我们向仓库提交一个空的 commit 来触发 Pipeline。</p><pre><code class=\"language-powershell\">$ git commit --allow-empty -m \"Trigger Build\"\n[main 79ca67e] Trigger Build\n$ git push origin main\n</code></pre><p>完成推送后，打开 <a href=\"http://tekton.k8s.local/\">http://tekton.k8s.local/</a> 进入 Tekton 控制台，点击左侧的“PipelineRun”，你会看到刚才触发的 Pipeline。</p><p><img src=\"https://static001.geekbang.org/resource/image/5c/3f/5cae12fac140f38e37bd832ae025fc3f.png?wh=1920x1041\" alt=\"图片\"></p><p>点击 PipelineRun 的名称进入详情页面，可以看到 Pipeline 包含 3 个 Task 及其输出的日志信息。</p><p><img src=\"https://static001.geekbang.org/resource/image/3a/22/3a259b30286f52a981bb5d803dede722.png?wh=1920x1041\" alt=\"图片\"></p><p>到这里，我们就成功地将 GitHub 和 Tekton Pipeline 结合，并通过 GitHub Webhook 触发了 Pipeline，实现了镜像的自动构建和推送，和上一节课实现的效果一样，每次有新的提交时都会触发构建，<strong>并且每个 commit id 对应一个镜像版本</strong>。</p><h2>总结</h2><p>总结一下。在这节课，我们介绍了如何通过 Tekton Pipeline 来自动构建和推送镜像。</p><p>Tekton 的概念繁多，并且比较抽象，完全掌握这些概念有一定难度。为了方便理解和记忆，你可以把 Tekton 的概念和 GitHub Action 做类比，例如，Task 有点像 GitHub Action 的插件，git-clone Task 实际上和我们在 GitHub Action 引用的 actions/checkout@v3 插件功能是类似的。</p><p>其次，Tekton Pipeline 和 GitHub Action Workflow 也比较类似，Tekton Pipeline 通过引用和组合不同的 Task 形成了一个流水线。而 GitHub Action Workflow 则是通过引用并组合插件来完成一个工作流。</p><p>相比较而言，它们之间最大的差异还是在触发器上。GitHub Action Workflow 的触发器内置到了工作流中，只需要在工作流声明什么时候可以被触发即可。而 Tekton 则需要借助 EventListener 和 TriggerTemplate 这两个组件来接收外部 Webhook 事件并触发 Pipeline。所以 Tekton 复杂的配置也主要集中在这两块。</p><p>Tekton 虽然配置相对复杂，但它是一次性配置，如果你已有 Kubernetes 集群，那么使用 Tekton 来构建镜像是一个不错的选择，这种方案使得镜像构建成本几乎为零，并且扩展性强。</p><p>在前面几节课，我们都是使用 Docker Hub 作为镜像存储仓库的。但实际上，它同样也需要收费，<strong>在镜像存储方面，我们同样也可以使用自托管方案来进一步降低成本。</strong></p><p>在下一节课，我们会详细介绍这部分的内容。</p><h2>课后题</h2><p>最后，给你留一道思考题吧。</p><p>在一个 Tekton Task 中，Step 是在同一个 Pod 不同的容器里运行的，我们知道 Pod 的容器启动是没有顺序的，那么 Tekton 是如何控制 Step 的运行顺序的呢？</p><p>提示：你可以在 Pipeline 运行时，查看 Task 拉起的 Pod Manifest 查找线索（<code>kubectl get pods $POD_NAME -o yaml</code>）。</p><p>欢迎你给我留言交流讨论，你也可以把这节课分享给更多的朋友一起阅读。我们下节课见。</p>","comments":[{"had_liked":false,"id":366965,"user_name":"李多","can_delete":false,"product_type":"c1","uid":2806068,"ip_address":"山东","ucode":"974E2C405C2CE7","user_header":"https://static001.geekbang.org/account/avatar/00/2a/d1/34/03dc9e03.jpg","comment_is_top":false,"comment_ctime":1674704634,"is_pvip":false,"replies":[{"id":133917,"content":"感谢分享，原文已修改。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675416307,"ip_address":"广东","comment_id":366965,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"原文：\nkubectl apply -f https:&#47;&#47;storage.googleapis.com&#47;tekton-releases&#47;dashboard&#47;latest&#47;tekton-dashboard-release.yaml\n貌似已经 404 无法访问了。\n\n新的 dashboard yaml 在这个路径下：\nkubectl apply --filename https:&#47;&#47;storage.googleapis.com&#47;tekton-releases&#47;dashboard&#47;latest&#47;release.yaml\n\n参照：https:&#47;&#47;github.com&#47;tektoncd&#47;dashboard","like_count":5,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601822,"discussion_content":"感谢分享，原文已修改。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1003207,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4e/c7/8c2d0a3d.jpg","nickname":"余泽锋","note":"","ucode":"5AB1499746C003","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633499,"discussion_content":"还是一样出现404 ，大佬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702265448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"新加坡","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1308196,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","nickname":"ghostwritten","note":"","ucode":"AE512F2E24A1A0","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601093,"discussion_content":"谢谢，大佬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675055856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366783,"user_name":"Waylon","can_delete":false,"product_type":"c1","uid":1310297,"ip_address":"北京","ucode":"D9269A5A42F670","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoUEZtvgjx3Lo8ib1GxBruDJCLXxX0KfRptk7BoBtRebKMA4Chp2tPbiaCwlCQ9hBZ4JnukX1bs9blA/132","comment_is_top":false,"comment_ctime":1674209250,"is_pvip":false,"replies":[{"id":133924,"content":"👍🏻课代表！","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675416857,"ip_address":"广东","comment_id":366783,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"容器的entrypoint启动进程\n监控到&#47;tekton&#47;downward&#47;ready文件的创建, 并等待文件内容的写入\n执行git-init子进程, 从 git 仓库克隆源码\n创建&#47;tekton&#47;tools&#47;0文件\n\n所有的 Step 都是被 &#47;tekton&#47;tools&#47;entrypoints 封装起来执行的。  \n-wait_file 指定一个文件，通过监听文件句柄，在探测到文件存在时执行被封装的 Step 任务。  \n-post_file 指定一个文件，在Step任务完成后创建这个文件。\n通过文件序列 &#47;tekton&#47;tools&#47;${index} 来对 Step 进行排序。\n","like_count":3,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601831,"discussion_content":"👍🏻课代表！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2608728,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","nickname":"Dexter","note":"","ucode":"909CABC4AC4AC9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":643174,"discussion_content":"具体体现的container中，是基于pre or post hook吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1714105124,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367245,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"北京","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1675067465,"is_pvip":false,"replies":[{"id":133901,"content":"赞，很高兴看到你获得了收获！加油~","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675415160,"ip_address":"广东","comment_id":367245,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100312001,"comment_content":"跟着步骤已全部实现，学到了不少东西。\n第一页：\n1. 腾讯云创建k8级群：申请标准集群、创建集群网络、设置配额、外网访问、本地kubectl访问集群。\n2. 安装 Tekton Operator\nkubectl apply -f https:&#47;&#47;storage.googleapis.com&#47;tekton-releases&#47;pipeline&#47;latest&#47;release.yaml\n等待：kubectl wait --for=condition=Ready pods --all -n tekton-pipelines --timeout=300s\n\n3. 安装 Tekton Trigger 和 Tekton Interceptors 组件\nkubectl apply -f https:&#47;&#47;storage.googleapis.com&#47;tekton-releases&#47;triggers&#47;latest&#47;release.yaml\nkubectl apply -f https:&#47;&#47;storage.googleapis.com&#47;tekton-releases&#47;triggers&#47;latest&#47;interceptors.yaml\nkubectl wait --for=condition=Ready pods --all -n tekton-pipelines --timeout=300s\n\n4. 安装 Ingress-Nginx\nkubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;kubernetes&#47;ingress-nginx&#47;controller-v1.4.0&#47;deploy&#47;static&#47;provider&#47;cloud&#47;deploy.yaml\nkubectl wait --for=condition=AVAILABLE deployment&#47;ingress-nginx-controller --all -n ingress-nginx\n\n5. 暴露 Tekton Dashboard\nkubectl apply -f tekton-dashboard.yaml\n获取外网 IP ：kubectl get services --namespace ingress-nginx ingress-nginx-controller --output jsonpath=&#39;{.status.loadBalancer.ingress[0].ip}&#39;\n配置43.135.82.249 tekton.k8s.local 通过域名 http:&#47;&#47;tekton.k8s.local 来访问Tekton Dashboard\n\n6. 创建 Task：检出代码\n kubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;lyzhang1999&#47;gitops&#47;main&#47;ci&#47;18&#47;tekton&#47;task&#47;git-clone.yaml\n\n7. 创建 Task：构建和推送镜像\nkubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;lyzhang1999&#47;gitops&#47;main&#47;ci&#47;18&#47;tekton&#47;task&#47;docker-build.yaml\n\n8. 创建 Pipeline\n kubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;lyzhang1999&#47;gitops&#47;main&#47;ci&#47;18&#47;tekton&#47;pipeline&#47;pipeline.yaml\n\n9. 创建 EventListener\nkubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;lyzhang1999&#47;gitops&#47;main&#47;ci&#47;18&#47;tekton&#47;trigger&#47;github-event-listener.yaml\n\n","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601806,"discussion_content":"赞，很高兴看到你获得了收获！加油~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675415160,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369552,"user_name":"邵涵","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"北京","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1677657142,"is_pvip":false,"replies":[{"id":134680,"content":"是的，只有 Task 可以复用。如果有很多仓库需要构建镜像的话，也可以考虑用 GitHub Action。不过不同的仓库实际上也需要重新写 Action YAML，只不过它可以内置很多变量可以直接使用，这样让 YAML 的内容看起来都差不多。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1677661895,"ip_address":"广东","comment_id":369552,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"如果按照本文的方式对多个github仓库使用Tekton配置自动构建镜像能力，是需要针对每个github仓库都创建独立的webhook url（并在ingress中为其做相应配置）并创建独立的EventListener、TriggerTemplate、Pipeline等对象吗？因为看起来这些对象之间是环环相扣的并在yaml定义中有针对比如镜像名称的一些信息的hardcode的，这样看起来就无法一套对象对多个git仓库通用了","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607188,"discussion_content":"是的，只有 Task 可以复用。如果有很多仓库需要构建镜像的话，也可以考虑用 GitHub Action。不过不同的仓库实际上也需要重新写 Action YAML，只不过它可以内置很多变量可以直接使用，这样让 YAML 的内容看起来都差不多。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1677661896,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369305,"user_name":"老虎","can_delete":false,"product_type":"c1","uid":3244346,"ip_address":"北京","ucode":"C7A812E497BBEC","user_header":"https://static001.geekbang.org/account/avatar/00/31/81/3a/32ad4faa.jpg","comment_is_top":false,"comment_ctime":1677381220,"is_pvip":false,"replies":[{"id":134567,"content":"先在 github 配置一下 ssh key：https:&#47;&#47;docs.github.com&#47;en&#47;authentication&#47;connecting-to-github-with-ssh&#47;adding-a-new-ssh-key-to-your-github-account","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1677396167,"ip_address":"广东","comment_id":369305,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"请问这个secret里面cat ~&#47;.ssh&#47;known_hosts | grep &quot;github&quot; | base64\n找不到github的known_host值，应该怎么处理，谢谢","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606772,"discussion_content":"先在 github 配置一下 ssh key：https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677396167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368961,"user_name":"Geek_5dacb9","can_delete":false,"product_type":"c1","uid":2536149,"ip_address":"北京","ucode":"8B82F41DE292F5","user_header":"","comment_is_top":false,"comment_ctime":1676955535,"is_pvip":false,"replies":[{"id":134371,"content":"你的本机需要先从 GitHub 克隆一个仓库。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1676966977,"ip_address":"广东","comment_id":368961,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"cat ~&#47;.ssh&#47;known_hosts | grep &quot;github&quot; | base64 和cat ~&#47;.ssh&#47;config | base64没有找到是哪里没有配置吗？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606140,"discussion_content":"你的本机需要先从 GitHub 克隆一个仓库。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676966978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2608728,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","nickname":"Dexter","note":"","ucode":"909CABC4AC4AC9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":643093,"discussion_content":"必须用ssh的方式clone吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1714038833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":606140,"ip_address":"芬兰","group_id":0},"score":643093,"extra":""}]}]},{"had_liked":false,"id":368330,"user_name":"Geek_03197d","can_delete":false,"product_type":"c1","uid":3196256,"ip_address":"江苏","ucode":"1A4CB405EF154A","user_header":"","comment_is_top":false,"comment_ctime":1676207924,"is_pvip":false,"replies":[{"id":134116,"content":"Skaffold 在本地开发的时候比较常用，Tekton 通用型会更好一些。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1676211171,"ip_address":"广东","comment_id":368330,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"Tekton &amp; skaffold 能否对比一下？哪个业界用的更广泛？( 我看skaffold的github 上的star更多) ,谢谢","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603433,"discussion_content":"Skaffold 在本地开发的时候比较常用，Tekton 通用型会更好一些。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676211171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368018,"user_name":"gyl1989113","can_delete":false,"product_type":"c1","uid":1363213,"ip_address":"四川","ucode":"B7F2860B3FB101","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","comment_is_top":false,"comment_ctime":1675824353,"is_pvip":false,"replies":[{"id":133991,"content":"gcr.io 的网络问题，建议开通一台云厂商的香港集群来测试，或者解决无法访问的问题。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675829418,"ip_address":"广东","comment_id":368018,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"Failed to pull image &quot;gcr.io&#47;tekton-releases&#47;github.com&#47;tektoncd&#47;pipeline&#47;cmd&#47;controller:v0.44.0@sha256:51e4c16fc4d0b18912106ff7fe37cc24c0667de6af468cdd1a9e9dc174039de1&quot;: rpc error: code = Unknown desc = failed to pull and unpack image &quot;gcr.io&#47;tekton-releases&#47;github.com&#47;tektoncd&#47;pipeline&#47;cmd&#47;controller@sha256:51e4c16fc4d0b18912106ff7fe37cc24c0667de6af468cdd1a9e9dc174039de1&quot;: failed to resolve reference &quot;gcr.io&#47;tekton-releases&#47;github.com&#47;tektoncd&#47;pipeline&#47;cmd&#47;controller@sha256:51e4c16fc4d0b18912106ff7fe37cc24c0667de6af468cdd1a9e9dc174039de1&quot;: failed to do request: Head &quot;https:&#47;&#47;gcr.io&#47;v2&#47;tekton-releases&#47;github.com&#47;tektoncd&#47;pipeline&#47;cmd&#47;controller&#47;manifests&#47;sha256:51e4c16fc4d0b18912106ff7fe37cc24c0667de6af468cdd1a9e9dc174039de1&quot;: dial tcp 108.177.125.82:443: i&#47;o timeout. 咋办呢","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602640,"discussion_content":"gcr.io 的网络问题，建议开通一台云厂商的香港集群来测试，或者解决无法访问的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675829418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2306763,"avatar":"https://static001.geekbang.org/account/avatar/00/23/32/cb/ab6b9dfe.jpg","nickname":"Jeremy Zhang","note":"","ucode":"576AEACEE7A6ED","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":655460,"discussion_content":"已开通腾讯云网络问题。请问下怎么解决该问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1735004632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":602640,"ip_address":"安徽","group_id":0},"score":655460,"extra":""}]}]},{"had_liked":false,"id":366811,"user_name":"Amosヾ","can_delete":false,"product_type":"c1","uid":1567014,"ip_address":"江苏","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1674278725,"is_pvip":true,"replies":[{"id":133923,"content":"感谢指正~","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675416559,"ip_address":"广东","comment_id":366811,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"创建 Task和创建 Pipeline两步中各有两个是spec，而不是spce吧？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601828,"discussion_content":"感谢指正~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366810,"user_name":"Amosヾ","can_delete":false,"product_type":"c1","uid":1567014,"ip_address":"江苏","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1674278647,"is_pvip":true,"replies":[{"id":133922,"content":"不支持哦，只能通过 YAML 来配置。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675416528,"ip_address":"广东","comment_id":366810,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"tekton是否支持图形化拖拽的方式编辑task、piplinerun呢？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601827,"discussion_content":"不支持哦，只能通过 YAML 来配置。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416528,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366691,"user_name":"奕","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"广东","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1674057143,"is_pvip":false,"replies":[{"id":133925,"content":"对，虚拟机也可以，但因为没有 LB 能力所以配置起来会复杂一点。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675416888,"ip_address":"广东","comment_id":366691,"utype":1}],"discussion_count":3,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"这里使用云厂商的k8s 集群是不是为了获取公网IP, 方便可以 github webhook 联动？\n\n如果是这样 带公网ip 的云虚拟机是不是也可以完成？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601832,"discussion_content":"对，虚拟机也可以，但因为没有 LB 能力所以配置起来会复杂一点。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416888,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1983237,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/43/05/3fbf26cf.jpg","nickname":"Noel ZHANG","note":"","ucode":"DF4E7E1FAFB509","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601154,"discussion_content":"这里的k8s是为了部署Tekton，webhook地址是Tekton暴露的出来的.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675087018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1567014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","nickname":"Amosヾ","note":"","ucode":"833F6FCB4042AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600371,"discussion_content":"理论上只要github能够访问通你的k8s地址就可以","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674269211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366633,"user_name":"无名无姓","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"北京","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1674007783,"is_pvip":false,"replies":[{"id":133583,"content":"什么顺序呢？","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1674010748,"ip_address":"广东","comment_id":366633,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"这个顺序是必须的么？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600091,"discussion_content":"什么顺序呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674010748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390014,"user_name":"Dexter","can_delete":false,"product_type":"c1","uid":2608728,"ip_address":"浙江","ucode":"909CABC4AC4AC9","user_header":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","comment_is_top":false,"comment_ctime":1714105250,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"文中的github webhook token secret是指local PC（比如git clone下对应仓库的）还是公有云中开通的节点？\n必须要用ssh方式clone下仓库，才能有.ssh目录下的一些文件吗？","like_count":0},{"had_liked":false,"id":384169,"user_name":"Geek_b3fd1d","can_delete":false,"product_type":"c1","uid":3467902,"ip_address":"湖南","ucode":"3B73AE5E30BFA3","user_header":"","comment_is_top":false,"comment_ctime":1700454831,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"怎么用Tekton选择构建项目中的子模块 ？","like_count":0},{"had_liked":false,"id":367246,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"北京","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1675067555,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":1,"score":3,"product_id":100312001,"comment_content":"这篇文章干货很赞。\n第二页：\n10. 暴露 EventListener\nkubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;lyzhang1999&#47;gitops&#47;main&#47;ci&#47;18&#47;tekton&#47;ingress&#47;github-listener.yaml\n\n11. 创建 TriggerTemplate\nkubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;lyzhang1999&#47;gitops&#47;main&#47;ci&#47;18&#47;tekton&#47;trigger&#47;github-trigger-template.yaml\n\n12. 创建 Service Account 和 PVC\nkubectl apply -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;raw.githubusercontent.com&#47;lyzhang1999&#47;gitops&#47;main&#47;ci&#47;18&#47;tekton&#47;other&#47;service-account.yaml\n\n13. 设置 Secret\ncat ~&#47;.ssh&#47;id_rsa | base64\ncat ~&#47;.ssh&#47;known_hosts | grep &quot;github&quot; | base64\ncat ~&#47;.ssh&#47;config | base64\n多行转一行工具：https:&#47;&#47;www.lmcjl.com&#47;index&#47;keyword&#47;pinjie.html\nkubectl apply -f secret.yaml\n\n14. 创建 GitHub Webhook\n在 GitHub 创建的 `kubernetes-example` 仓库，进入“Settings”页面，点击左侧的“Webhooks”菜单，输入 `Webhook` 地址，也就是“ http:&#47;&#47;外网ip&#47;hooks”，并且将“Content type”配置为“`application&#47;json`”。点击“`Add webhook`”创建。\n\n15. 触发 Pipeline\ngit commit --allow-empty -m &quot;Trigger Build&quot;\ngit push origin main","like_count":0}]}