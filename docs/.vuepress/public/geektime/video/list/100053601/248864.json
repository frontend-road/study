{"id":248864,"title":"06 | 计数服务设计（下）","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-distributed\">https://gitee.com/geektime-geekbang/geektime-distributed</a></p>","comments":[{"had_liked":false,"id":227412,"user_name":"jhren","can_delete":false,"product_type":"c3","uid":1596987,"ip_address":"","ucode":"60F7CCEA1E2C88","user_header":"https://static001.geekbang.org/account/avatar/00/18/5e/3b/845fb641.jpg","comment_is_top":false,"comment_ctime":1592375701,"is_pvip":false,"replies":[{"id":83837,"content":"⛽️","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1592412318,"ip_address":"","comment_id":227412,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"感谢杨老师核心名词都提供了英文翻译","like_count":4,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498627,"discussion_content":"⛽️","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592412318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246402,"user_name":"Bill","can_delete":false,"product_type":"c3","uid":1001581,"ip_address":"","ucode":"0D9F998FC0359F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/6d/b2c56a77.jpg","comment_is_top":false,"comment_ctime":1599311328,"is_pvip":false,"replies":[{"id":90596,"content":"当然，环节越少越简单，出故障的概率就小，但是还是要看量级，因为体量决定架构。根据具体的体量大小，可以适当简化。\n\n1. 可以通过采集网关(或者反向代理)的访问日志，来实现计数服务。\n2. 通常原始访问日志也需要保存起来，中间一般引入kafka消息队列，主要考虑一个是流量消峰，另外一个是前后解耦合。\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1599402785,"ip_address":"","comment_id":246402,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"可以更简单一些，流量直接打到网关上记录日志，然后起个普通的统计聚合服务，面向写的场景写入DB就了。\n\n简化掉中间很多环节，可用性提升。","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505130,"discussion_content":"当然，环节越少越简单，出故障的概率就小，但是还是要看量级，因为体量决定架构。根据具体的体量大小，可以适当简化。\n\n1. 可以通过采集网关(或者反向代理)的访问日志，来实现计数服务。\n2. 通常原始访问日志也需要保存起来，中间一般引入kafka消息队列，主要考虑一个是流量消峰，另外一个是前后解耦合。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599402785,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227208,"user_name":"静水流深","can_delete":false,"product_type":"c3","uid":1339724,"ip_address":"","ucode":"644F05EFBD2E7B","user_header":"https://static001.geekbang.org/account/avatar/00/14/71/4c/2cefec07.jpg","comment_is_top":false,"comment_ctime":1592314120,"is_pvip":false,"replies":[{"id":83707,"content":"⛽️","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1592324047,"ip_address":"","comment_id":227208,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"这节课，让我感受到了，知识储备的重要性！！需要不断地去深入学习。","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498533,"discussion_content":"⛽️","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592324047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":252902,"user_name":"杰","can_delete":false,"product_type":"c3","uid":1109562,"ip_address":"","ucode":"036B010A45070A","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/3a/c0ad9c43.jpg","comment_is_top":false,"comment_ctime":1602511693,"is_pvip":false,"replies":[{"id":92696,"content":"本课程主要面向中高级工程师和架构师，受众有一定限制","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1602864075,"ip_address":"","comment_id":252902,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"波波老师讲的很精彩，可惜报名的人数那么少，可能大部分学员看到标题就没太大兴趣了。","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506911,"discussion_content":"本课程主要面向中高级工程师和架构师，受众有一定限制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602864075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229409,"user_name":"G小调","can_delete":false,"product_type":"c3","uid":1145529,"ip_address":"","ucode":"8F3D50E2C1A559","user_header":"https://static001.geekbang.org/account/avatar/00/11/7a/b9/c3d3a92f.jpg","comment_is_top":false,"comment_ctime":1592987164,"is_pvip":false,"replies":[{"id":84828,"content":"简单用一个ConcurrentHashMap，key是videoId，value是1分钟内的点击数量累加值。\n\n弄个后台线程每分钟，新建一个ConcurrentHashMap，替换那个老的，然后把老的值打包写入本地MQ。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1593188200,"ip_address":"","comment_id":229409,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"有个疑问，计算服务，怎么计算一个窗口期时间内的请求聚合，再推送到数据库存储","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499471,"discussion_content":"简单用一个ConcurrentHashMap，key是videoId，value是1分钟内的点击数量累加值。\n\n弄个后台线程每分钟，新建一个ConcurrentHashMap，替换那个老的，然后把老的值打包写入本地MQ。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593188200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228277,"user_name":"何凌","can_delete":false,"product_type":"c3","uid":1139066,"ip_address":"","ucode":"659D0EA089AFA4","user_header":"https://static001.geekbang.org/account/avatar/00/11/61/7a/ec7c1881.jpg","comment_is_top":false,"comment_ctime":1592631291,"is_pvip":false,"replies":[{"id":84216,"content":"一般不直接写mq，前面放一个代理服务去写mq，这样客户端不耦合具体的mq技术。\n\nkafka的auth，可以根据需要关闭，即使有auth也没有关系，客户端用官方方法做auth就好了。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1592668874,"ip_address":"","comment_id":228277,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"有没有可能直接写MQ？Kafka会有auth的问题，如果是带auth的MQ呢？","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498981,"discussion_content":"一般不直接写mq，前面放一个代理服务去写mq，这样客户端不耦合具体的mq技术。\n\nkafka的auth，可以根据需要关闭，即使有auth也没有关系，客户端用官方方法做auth就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592668874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228156,"user_name":"不忘初心","can_delete":false,"product_type":"c3","uid":1117880,"ip_address":"","ucode":"5FE187B3F4EC39","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/b8/d91adbb3.jpg","comment_is_top":false,"comment_ctime":1592569291,"is_pvip":false,"replies":[{"id":84208,"content":"可以，甚至还可以通过nginx或者网关的访问日志来收集。课程只是一个演示场景。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1592667926,"ip_address":"","comment_id":228156,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"观看事件的产生，老说讲的是浏览器主动发送，是否可以在api网关里用过滤器来产生观看事件？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498936,"discussion_content":"可以，甚至还可以通过nginx或者网关的访问日志来收集。课程只是一个演示场景。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592667926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227640,"user_name":"tt","can_delete":false,"product_type":"c3","uid":1489957,"ip_address":"","ucode":"7753B79AD5A9AC","user_header":"https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg","comment_is_top":false,"comment_ctime":1592447701,"is_pvip":false,"replies":[{"id":83976,"content":"⛽️","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1592498370,"ip_address":"","comment_id":227640,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"看得真过瘾","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498730,"discussion_content":"⛽️","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592498370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289973,"user_name":"Sky","can_delete":false,"product_type":"c3","uid":1461938,"ip_address":"","ucode":"809EC994C20BD5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er6TFrwyVZOGvwHbpYmyo0Hxnq4JlFob3UcicQiaqcaaatiaeo9Zrq1ricTAsRFHJ4LHCVCyN6XGxAibpA/132","comment_is_top":false,"comment_ctime":1619288078,"is_pvip":false,"replies":[{"id":105442,"content":"如果通过内存做聚合并且要保证数据不丢，那么一般必须先写入磁盘文件。相当于在每台counting service的主机上要有磁盘queue(相当于write ahread log)，然后在磁盘queue的一端写入数据，另外一端做消费聚合，同时在磁盘上记录queue的消费指针。后面如果计数服务crash了，重启服务后，从上次的消费指针重新消费即可，这样可以保证可靠性(但是可能重复消费)。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1619966667,"ip_address":"","comment_id":289973,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"计数服务如果是一个窗口期时间内的请求聚合，再推送到数据库存储， 在还没推送前，计数服务器crash，那存储与concurren hashmap中的计数就丢失了。如果为了放丢失，写入硬盘又慢，这个有什么好的办法解决？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519077,"discussion_content":"如果通过内存做聚合并且要保证数据不丢，那么一般必须先写入磁盘文件。相当于在每台counting service的主机上要有磁盘queue(相当于write ahread log)，然后在磁盘queue的一端写入数据，另外一端做消费聚合，同时在磁盘上记录queue的消费指针。后面如果计数服务crash了，重启服务后，从上次的消费指针重新消费即可，这样可以保证可靠性(但是可能重复消费)。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619966667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289713,"user_name":"瞌睡的李先生","can_delete":false,"product_type":"c3","uid":2264685,"ip_address":"","ucode":"88480FAFB4F879","user_header":"https://static001.geekbang.org/account/avatar/00/22/8e/6d/f2354440.jpg","comment_is_top":false,"comment_ctime":1619150243,"is_pvip":false,"replies":[{"id":105441,"content":"加油💪","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1619965929,"ip_address":"","comment_id":289713,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"作为一个0年经验的实习生，感觉波波老师讲的东西为我打开了一扇新世界的大门","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518999,"discussion_content":"加油💪","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619965929,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286765,"user_name":"Geek_3b1096","can_delete":false,"product_type":"c3","uid":1549364,"ip_address":"","ucode":"A6BD92B79B3632","user_header":"","comment_is_top":false,"comment_ctime":1617571451,"is_pvip":false,"replies":[{"id":104791,"content":"谢谢支持，加油💪","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1618667939,"ip_address":"","comment_id":286765,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100053601,"comment_content":"老师讲的非常好","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518083,"discussion_content":"谢谢支持，加油💪","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618667939,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}