{"id":734199,"title":"03ï½œåŠ¨æ€Responseï¼šæŒ‰ç…§è§„èŒƒæ„é€ è¿”å›æµ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniTomcatã€‚</p><p>ä¸ŠèŠ‚è¯¾æˆ‘ä»¬åˆæ­¥æ„é€ äº†ä¸€ä¸ªæœ€åŸå§‹çš„å¯è¿è¡Œçš„ HTTP Serverï¼Œåšåˆ°äº†å°†æ–‡ä»¶å†…å®¹è¾“å‡ºåˆ°æµè§ˆå™¨ã€‚ä½†æˆ‘ä»¬ä¹Ÿå‘ç°ï¼Œè¿™ä¸ªåŸå§‹ç‰ˆæœ¬çš„HTTP Serverå±€é™æ€§å¾ˆå¤§ï¼Œåªèƒ½ä½¿ç”¨é™æ€èµ„æºï¼Œä¸èƒ½ç»„è£…Responseè¿”å›ç»“æœï¼Œç«Ÿç„¶è¿˜è¦æ±‚é™æ€èµ„æºæœ¬èº«çš„æ–‡æœ¬æ ¼å¼ç¬¦åˆHTTPåè®®ä¸­Responseçš„è§„èŒƒï¼Œè€Œä¸”ä¹Ÿä¸æ»¡è¶³ä¸åŒå¼‚å¸¸åœºæ™¯ä¸‹çš„Responseè¿”å›ã€‚è¿™ä¸ªæœåŠ¡éœ€è¦ä¸šåŠ¡ç¨‹åºå‘˜è‡ªè¡Œå‡†å¤‡å®Œæ•´çš„æ»¡è¶³HTTP Responseè§„èŒƒæ ¼å¼çš„é™æ€èµ„æºï¼Œéå¸¸ä¸å‹å¥½ã€‚</p><p>å…¶æ¬¡ï¼Œä¸€ä¸ªæ­£å¸¸çš„ HTTP æœåŠ¡å“åº”è¯·æ±‚ä¸åº”åªæœ‰é™æ€èµ„æºï¼Œä¹Ÿåº”å­˜åœ¨åŠ¨æ€èµ„æºã€‚è¿™å°±æ˜¯è¿™èŠ‚è¯¾æˆ‘ä»¬è¦å¼•å…¥çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µâ€”â€”<strong>Servletï¼Œå®ƒæ˜¯å®ç°åŠ¨æ€èµ„æºè¿”å›çš„å¥½å·¥å…·</strong>ã€‚æ€»ä½“ç»“æ„å›¾å¦‚ä¸‹ï¼Œç°åœ¨å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥åŠ¨æ‰‹å®ç°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/yy/39/yy5870c90fbb711ae8667cabf5c5c839.png?wh=1920x852\" alt=\"å›¾ç‰‡\"></p><h2>é¡¹ç›®ç»“æ„</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è®¡åˆ’é‡‡ç”¨Mavenç»“æ„å¯¹é¡¹ç›®çš„åŒ…ä¾èµ–è¿›è¡Œç®¡ç†ï¼Œçœå»äº†æ‰‹å·¥å¯¼å…¥jaråŒ…çš„ç¯èŠ‚ã€‚ä½†æœ‰ä¸€ç‚¹æˆ‘ä»¬å§‹ç»ˆåšæŒï¼Œå°±æ˜¯<strong>å¼•å…¥æœ€å°‘çš„ä¾èµ–åŒ…ï¼Œä¸€åˆ‡åŠŸèƒ½å°½å¯èƒ½ç”¨æœ€åŸç”Ÿçš„JDKæ¥å®ç°</strong>ã€‚</p><p>è¿™èŠ‚è¯¾é¡¹ç›®ç»“æ„å˜åŒ–å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">MiniTomcat\nâ”œâ”€ src\nâ”‚  â”œâ”€ main\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ server\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpServer.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Request.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Response.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Servlet.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ StatisResourceProcessor.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”œâ”€ webroot\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”œâ”€ hello.txt\nâ”œâ”€ pom.xml\n</code></pre><!-- [[[read_end]]] --><p>æˆ‘ä»¬æŒ‰ç…§Mavené¡¹ç›®è§„èŒƒï¼ŒæŠŠserverç›®å½•æ•´ä½“ç§»åŠ¨åˆ° <code>src/main/java</code> ç›®å½•ä¸‹ï¼Œæ–°å¢testæ¨¡å—å’Œpomæ¨¡å—ã€‚å…¶ä»–ç±»çš„å…·ä½“åŠŸèƒ½æˆ‘ä»¬ä¼šæ”¾åœ¨åé¢æ…¢æ…¢ä»‹ç»ã€‚</p><p>ä½ å¯ä»¥å…ˆçœ‹ä¸€ä¸‹è¿™èŠ‚è¯¾pom.xmlé…ç½®å†…å®¹ï¼Œç°åœ¨åªå¼•ç”¨äº†Apache commons-lang3è¿™ä¸ªä¾èµ–åŒ…ã€‚</p><pre><code class=\"language-xml\">&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;groupId&gt;day2&lt;/groupId&gt;\n    &lt;artifactId&gt;day2&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;\n            &lt;version&gt;3.4&lt;/version&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n&lt;/project&gt;\n</code></pre><h2>Responseè¯·æ±‚è§„èŒƒ</h2><p>æˆ‘ä»¬å…ˆåŠ¨æ‰‹æ”¹é€ ä¸Šä¸€èŠ‚è¯¾çš„Responseï¼Œä¸èƒ½å†è¦æ±‚åœ¨é™æ€èµ„æºæ–‡æœ¬ä¸­å†™æ­»æ ¼å¼äº†ï¼Œè€Œæ˜¯æœåŠ¡å™¨è‡ªå·±è¿›è¡Œå°è£…ã€‚æ—¢ç„¶è¦å°è£…Responseè¯·æ±‚ï¼Œè‡ªç„¶æˆ‘ä»¬å¾—äº†è§£ä¸€ç‚¹HTTPè¿™ä¸ªåè®®å¯¹è¿”å›å†…å®¹çš„è§„å®šã€‚æ ¹æ®è§„å®šï¼ŒResponseç”±å››éƒ¨åˆ†ç»„æˆï¼šçŠ¶æ€è¡Œã€Headerå¤´ã€ç©ºè¡Œä¸å“åº”ä½“ã€‚è€ŒçŠ¶æ€è¡Œåˆç”±HTTPåè®®åŠå…¶ç‰ˆæœ¬ã€çŠ¶æ€ç ã€çŠ¶æ€åç§°ç»„æˆã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸Šä¸€èŠ‚è¯¾çš„é™æ€èµ„æºhello.txtã€‚</p><pre><code class=\"language-plain\">HTTP/1.1 200 OK\nContent-Type: text/html\nContent-Length: 12\n\nHello World!\n</code></pre><p>ç”±ä¸Šè¿°å†…å®¹å¯çœ‹å‡ºï¼Œç¬¬ä¸€è¡Œæ˜¯çŠ¶æ€è¡Œï¼Œè¡¨ç¤ºä½¿ç”¨HTTPåè®®ã€ç‰ˆæœ¬ï¼ˆ1.1ï¼‰ã€è¿”å›çŠ¶æ€ç ï¼ˆ200ï¼‰ä»¥åŠè¿”å›çŠ¶æ€åç§°ï¼ˆOKï¼‰ï¼Œä¸­é—´ç”±ä¸€ä¸ªç©ºæ ¼åˆ†éš”ã€‚Content-Type: text/htmlå’ŒContent-Length: 12åˆ™æ˜¯ä»¥é”®å€¼å¯¹çš„å½¢å¼å±•ç¤ºçš„è¿”å›å¤´ï¼ˆHeaderï¼‰ï¼Œä¾è¡Œæ’åˆ—ï¼Œè¿™é‡Œé¢åŒ…å«å¯¹æœåŠ¡å™¨å’Œè¿”å›æ•°æ®çš„æè¿°ã€‚å¸¸ç”¨é”®çš„å–å€¼è¿˜æœ‰Cookieã€Authorizationç­‰ã€‚</p><p>ä¹‹åç©ºä¸€è¡Œï¼Œéšåå†™å…¥è¿”å›çš„å†…å®¹ï¼ˆHello World!ï¼‰ï¼Œè¿™äº›æ˜¯æœåŠ¡å™¨è¿”å›ç»™å®¢æˆ·ç«¯çš„å…·ä½“æ•°æ®ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæ–‡æœ¬ã€æ–‡ä»¶ã€å›¾ç‰‡ç­‰ã€‚æˆ‘ä»¬æŠŠå®ƒå«åšå“åº”ä½“ã€‚</p><p>ç”±è¿™äº›å†…å®¹å¯ä»¥çœ‹å‡ºï¼Œ<strong>åªæœ‰å“åº”ä½“æ˜¯éœ€è¦ä¸šåŠ¡ç¨‹åºå‘˜å…³å¿ƒçš„</strong>ï¼Œè¯´æ˜é™¤å“åº”ä½“ä¹‹å¤–çš„å†…å®¹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æŠŠå®ƒå°è£…åˆ°Responseé‡Œã€‚</p><h2>Responseå°è£…</h2><p>åœ¨MiniTomcaté¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬è§„å®šå“åº”æ ¼å¼å¦‚ä¸‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šæ ¹æ®è¿™ä¸ªæ ¼å¼å¯¹Responseè¿›è¡Œå°è£…ã€‚</p><pre><code class=\"language-plain\">HTTP/1.1 ${StatusCode} ${StatusName}\nContent-Type: ${ContentType}\nContent-Length: ${ContentLength}\nServer: minit\nDate: ${ZonedDateTime}\n</code></pre><p>ä¸Šè¿° <code>${StatusCode}</code>ã€<code>${StatusName}</code> ç­‰å ä½ç¬¦ï¼Œæˆ‘ä»¬ä¼šåˆ©ç”¨åˆ°apache commons-langåŒ…é‡Œçš„StringUtilså·¥å…·è¿›è¡Œå ä½ç¬¦å¡«å……ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸å†è‡ªå·±é€ è½®å­è¿›è¡Œæ›¿æ¢å·¥ä½œï¼Œcommons-langåŒ…é»˜è®¤å·²ç”±pom.xmlå¼•å…¥ã€‚</p><p>åœ¨è¿™ä¸€èŠ‚è¯¾çš„å†…å®¹ä¸­ï¼Œ<strong>æˆ‘ä»¬å¼•å…¥ StaticResourceProcessor.javaï¼Œä¸“ç”¨äºå¤„ç† Response çš„è¿”å›å€¼</strong>ï¼ŒåŸæœ‰çš„Response.javaåªä½œä¸ºè¿”å›å®ä½“ç±»å­˜åœ¨ã€‚</p><p>å‚è€ƒä»£ç ï¼š</p><pre><code class=\"language-java\">public class Response {\n    Request request;\n    OutputStream output;\n    public Response(OutputStream output) {\n        this.output = output;\n    }\n    public void setRequest(Request request) {\n        this.request = request;\n    }\n    public OutputStream getOutput() {\n        return this.output;\n    }\n}\n</code></pre><p>æ—¢ç„¶å¦‚æ­¤ï¼Œå¯»æ‰¾é™æ€èµ„æºæ–‡ä»¶çš„ä»»åŠ¡ï¼Œè‡ªç„¶å°±å¾—ç”±<strong> StaticResourceProcessor.java </strong>æ‰¿æ‹…ã€‚</p><pre><code class=\"language-java\">public class StaticResourceProcessor {\n    private static final int BUFFER_SIZE = 1024;\n    //ä¸‹é¢çš„å­—ç¬¦ä¸²æ˜¯å½“æ–‡ä»¶æ²¡æœ‰æ‰¾åˆ°æ—¶è¿”å›çš„404é”™è¯¯æè¿°\n    private static String fileNotFoundMessage = \"HTTP/1.1 404 File Not Found\\r\\n\" +\n            \"Content-Type: text/html\\r\\n\" +\n            \"Content-Length: 23\\r\\n\" +\n            \"\\r\\n\" +\n            \"&lt;h1&gt;File Not Found&lt;/h1&gt;\";\n    //ä¸‹é¢çš„å­—ç¬¦ä¸²æ˜¯æ­£å¸¸æƒ…å†µä¸‹è¿”å›çš„ï¼Œæ ¹æ®httpåè®®ï¼Œé‡Œé¢åŒ…å«äº†ç›¸åº”çš„å˜é‡ã€‚\n    private static String OKMessage = \"HTTP/1.1 ${StatusCode} ${StatusName}\\r\\n\"+\n            \"Content-Type: ${ContentType}\\r\\n\"+\n            \"Content-Length: ${ContentLength}\\r\\n\"+\n            \"Server: minit\\r\\n\"+\n            \"Date: ${ZonedDateTime}\\r\\n\"+\n            \"\\r\\n\";\n    //å¤„ç†è¿‡ç¨‹å¾ˆç®€å•ï¼Œå…ˆå°†å“åº”å¤´å†™å…¥è¾“å‡ºæµï¼Œç„¶åä»æ–‡ä»¶ä¸­è¯»å–å†…å®¹å†™å…¥è¾“å‡ºæµ\n    public void process(Request request, Response response) throws IOException {\n        byte[] bytes = new byte[BUFFER_SIZE];\n        FileInputStream fis = null;\n        OutputStream output = null;\n        try {\n            output = response.getOutput();\n            File file = new File(HttpServer.WEB_ROOT, request.getUri());\n            if (file.exists()) {\n                //æ‹¼å“åº”å¤´\n                String head = composeResponseHead(file);\n                output.write(head.getBytes(\"utf-8\"));\n                //è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå†™å…¥è¾“å‡ºæµ\n                fis = new FileInputStream(file);\n                int ch = fis.read(bytes, 0, BUFFER_SIZE);\n                while (ch != -1) {\n                    output.write(bytes, 0, ch);\n                    ch = fis.read(bytes, 0, BUFFER_SIZE);\n                }\n                output.flush();\n            }\n            else {\n                output.write(fileNotFoundMessage.getBytes());\n            }\n        } catch (IOException e) {\n            System.out.println(e.toString());\n        } finally {\n            if (fis != null) {\n                fis.close();\n            }\n        }\n    }\n    //æ‹¼å“åº”å¤´ï¼Œå¡«å……å˜é‡å€¼\n    private String composeResponseHead(File file) {\n        long fileLength = file.length();\n        Map&lt;String, Object&gt; valuesMap = new HashMap&lt;&gt;();\n        valuesMap.put(\"StatusCode\", \"200\");\n        valuesMap.put(\"StatusName\", \"OK\");\n        valuesMap.put(\"ContentType\", \"text/html;charset=utf-8\");\n        valuesMap.put(\"ContentLength\", fileLength);\n        valuesMap.put(\"ZonedDateTime\", DateTimeFormatter.ISO_ZONED_DATE_TIME.format(ZonedDateTime.now()));\n        StrSubstitutor sub = new StrSubstitutor(valuesMap);\n        String responseHead = sub.replace(OKMessage);\n        return responseHead;\n    }\n}\n</code></pre><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ ¸å¿ƒä»£ç å°±æ˜¯ <code>process()</code> è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒåšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€æ˜¯æ‹¼å“åº”å¤´ï¼ŒäºŒæ˜¯ä»æ–‡æœ¬æ–‡ä»¶ä¸­è¯»å–å­—èŠ‚æµï¼Œè¿™ä¸¤éƒ¨åˆ†å†…å®¹éƒ½è¾“å‡ºåˆ°Responseçš„output streamä¸­ã€‚è¿™é‡Œé¢å¤–åˆ¤æ–­äº†ä¸€ä¸‹æ–‡ä»¶å­˜ä¸å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±è¿”å›404ã€‚</p><p>ç›¸æ¯”ä¸Šä¸€èŠ‚è¯¾çš„Responseè¿”å›ç±»ï¼Œå®ƒæœ€å¤§çš„å˜åŒ–åœ¨äºå¼•å…¥äº†composeResponseHeadæ–¹æ³•å¯¹è¿”å›çš„çŠ¶æ€è¡Œä»¥åŠè¿”å›å¤´Headerè¿›è¡ŒåŠ¨æ€ç»„è£…ã€‚StrSubstitutoræ˜¯commons-langåŒ…ä¸­æä¾›çš„ä¸€ä¸ªå­—ç¬¦ä¸²å¤„ç†å·¥å…·ï¼Œä¼ å…¥MAPç±»å‹çš„æ•°æ®ç»“æ„åï¼Œä¼šæ ¹æ®MAPé‡Œçš„Keyå€¼å¯¹æ¯”ï¼Œç”¨Valueå€¼æŠŠå ä½ç¬¦æ›¿æ¢æ‰ã€‚</p><p>æ”¹é€ ä¹‹åï¼Œåœ¨hello.txtæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å†™ä¸Šè¿”å›ä½“çš„å†…å®¹ï¼Œä¸éœ€è¦è‡ªå·±æ‰‹å†™å“åº”å¤´ï¼Œå°±å¯ä»¥åœ¨æµè§ˆå™¨å†…æ¸²æŸ“å‡ºç›¸å…³å†…å®¹ã€‚</p><h2>å¼•å…¥åŠ¨æ€èµ„æº</h2><p>ä¸Šé¢æˆ‘ä»¬å°±é’ˆå¯¹é™æ€èµ„æºè¿›è¡Œäº†æ”¹é€ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹è€ƒè™‘<strong>å¦‚ä½•å¤„ç†åŠ¨æ€èµ„æº</strong>ã€‚åœ¨Javaä¸­ï¼Œæåˆ°WebæœåŠ¡å™¨ç»•ä¸å¼€ä¸€ä¸ªæ¦‚å¿µâ€”â€”Servletã€‚Servletæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¸€èˆ¬æˆ‘ä»¬è®¤ä¸ºå®ç°äº†è¿™ä¸ªæ¥å£çš„ç±»ï¼Œéƒ½å¯ä»¥ç»Ÿç§°ä¸ºServletã€‚å®ƒçš„ä¸»è¦çš„åŠŸèƒ½åœ¨äºäº¤äº’å¼åœ°æµè§ˆä»¥åŠä¿®æ”¹æ•°æ®ï¼ŒéšååŠ¨æ€åœ°ç”Ÿæˆç½‘é¡µç«¯å±•ç¤ºçš„å†…å®¹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹é€æ­¥å®ç°Servletçš„è°ƒç”¨ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬ç®€å•åœ°ä»¥ <code>/servlet/</code> è¿™ä¸ªè·¯å¾„æ¥åŒºåˆ†æ˜¯å¦è¦è°ƒç”¨Servletè·å–åŠ¨æ€èµ„æºã€‚å¦‚æœåŒ…å«è¿™ä¸ªè·¯å¾„ï¼Œå°±è°ƒç”¨å¯¹åº”Servletï¼›åä¹‹ï¼Œå°±åˆ¤æ–­ä¸ºæ˜¯è°ƒç”¨é™æ€èµ„æºã€‚ä»Šåæˆ‘ä»¬å†æ…¢æ…¢åœ°æ”¹è¿›è·¯å¾„åŒ¹é…çš„æ–¹å¼ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è·å–Requestè¯·æ±‚åè°ƒç”¨ <code>getUri()</code>ï¼Œå°±å¯ä»¥åˆ¤æ–­ä½¿ç”¨å“ªä¸€ç§æ–¹å¼è¿›è¡Œå¤„ç†ã€‚</p><p>å®šä¹‰Servletæ¥å£ï¼ŒæŒ‰ç…§Servletçš„è§„èŒƒåº”è¯¥å®ç°javax.servlet.Servletã€‚ä½†è¿™é‡Œæˆ‘ä»¬å¸Œæœ›èƒ½ç®€å•ä¸€ç‚¹ï¼Œè‡ªå·±å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œä½œä¸ºèµ·æ­¥æ¥æ¢è®¨ã€‚</p><pre><code class=\"language-java\">package server;\n\npublic interface Servlet {\n    public void service(Request req, Response res) throws IOException;\n}\n</code></pre><p>è¿™ä¸ªæ¥å£ä¸­åªæœ‰ä¸€ä¸ªserviceæ–¹æ³•ï¼Œå¯ä»¥ç•™ç»™ä¸šåŠ¡ç¨‹åºå‘˜è‡ªè¡Œå®ç°ã€‚æ¯æ¬¡è°ƒç”¨Servletçš„æ—¶å€™ï¼Œå…¶å®éƒ½æ˜¯åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæ ¹æ®è¿™é‡Œæ–¹æ³•å†…çš„å®ç°åŠ¨æ€ç”ŸæˆWebä¸Šçš„å†…å®¹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ServletProcessor.javaçš„å®šä¹‰ã€‚</p><pre><code class=\"language-java\">public class ServletProcessor {\n    //å“åº”å¤´å®šä¹‰ï¼Œé‡Œé¢åŒ…å«å˜é‡\n    private static String OKMessage = \"HTTP/1.1 ${StatusCode} ${StatusName}\\r\\n\"+\n            \"Content-Type: ${ContentType}\\r\\n\"+\n            \"Server: minit\\r\\n\"+\n            \"Date: ${ZonedDateTime}\\r\\n\"+\n            \"\\r\\n\";\n\n    public void process(Request request, Response response) {\n        //é¦–å…ˆæ ¹æ®uriæœ€åä¸€ä¸ª/å·æ¥å®šä½ï¼Œåé¢çš„å­—ç¬¦ä¸²è®¤ä¸ºæ˜¯servletåå­—\n        String uri = request.getUri();\n        String servletName = uri.substring(uri.lastIndexOf(\"/\") + 1);\n        URLClassLoader loader = null;\n        OutputStream output = null;\n\n        try {\n            // create a URLClassLoader\n            URL[] urls = new URL[1];\n            URLStreamHandler streamHandler = null;\n            File classPath = new File(HttpServer.WEB_ROOT);\n            String repository = (new URL(\"file\", null, classPath.getCanonicalPath() + File.separator)).toString() ;\n            urls[0] = new URL(null, repository, streamHandler);\n            loader = new URLClassLoader(urls);\n        }\n        catch (IOException e) {\n            System.out.println(e.toString() );\n        }\n        //ç”±ä¸Šé¢çš„URLClassLoaderåŠ è½½è¿™ä¸ªservlet\n        Class&lt;?&gt; servletClass = null;\n        try {\n            servletClass = loader.loadClass(servletName);\n        }\n        catch (ClassNotFoundException e) {\n            System.out.println(e.toString());\n        }\n        //å†™å“åº”å¤´\n        output = response.getOutput();\n        String head = composeResponseHead();\n        try {\n            output.write(head.getBytes(\"utf-8\"));\n        } catch (UnsupportedEncodingException e1) {\n            e1.printStackTrace();\n        } catch (IOException e1) {\n            e1.printStackTrace();\n        }\n        //åˆ›å»ºservletæ–°å®ä¾‹ï¼Œç„¶åè°ƒç”¨service()ï¼Œç”±å®ƒæ¥å†™åŠ¨æ€å†…å®¹åˆ°å“åº”ä½“\n        Servlet servlet = null;\n        try {\n            servlet = (Servlet) servletClass.newInstance();\n            servlet.service(request, response);\n        }\n        catch (Exception e) {\n            System.out.println(e.toString());\n        }\n        catch (Throwable e) {\n            System.out.println(e.toString());\n        }\n\n        try {\n            output.flush();\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n\n    }\n    //ç”Ÿæˆå“åº”å¤´ï¼Œå¡«å……å˜é‡å€¼\n    private String composeResponseHead() {\n        Map&lt;String,Object&gt; valuesMap = new HashMap&lt;&gt;();\n        valuesMap.put(\"StatusCode\",\"200\");\n        valuesMap.put(\"StatusName\",\"OK\");\n        valuesMap.put(\"ContentType\",\"text/html;charset=uft-8\");\n        valuesMap.put(\"ZonedDateTime\", DateTimeFormatter.ISO_ZONED_DATE_TIME.format(ZonedDateTime.now()));\n        StrSubstitutor sub = new StrSubstitutor(valuesMap);\n        String responseHead = sub.replace(OKMessage);\n        return responseHead;\n    }\n}\n</code></pre><p>composeResponseHeadæ–¹æ³•ä¸å¤šä»‹ç»äº†ï¼Œä¸StaticResourceProcessorä¸­ä¸€è‡´ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹processæ–¹æ³•ï¼Œå®ƒçš„æ ¸å¿ƒåœ¨äºé€šè¿‡URIä¸­çš„<code>\"/\"</code>å®šä½åˆ°å¯¹åº”çš„Servletåç§°ï¼Œé€šè¿‡åå°„è·å–åˆ°å¯¹åº”çš„Servletå®ç°ç±»å¹¶åŠ è½½ï¼Œè°ƒç”¨serviceæ–¹æ³•è·å–åŠ¨æ€èµ„æºè¿”å›ä½“ï¼Œç»“åˆç»„è£…çš„è¿”å›å¤´ä¸€å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>çœ‹ä»£ç çš„ç»†èŠ‚ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªClassLoaderï¼Œå°±æ˜¯è¿™ä¸€å¥ï¼š</p><pre><code class=\"language-java\">loader = new URLClassLoader(urls);\n</code></pre><p>è¿™æ˜¯å› ä¸ºServletæ˜¯ç”±åº”ç”¨ç¨‹åºå‘˜ç¼–å†™çš„ï¼Œæˆ‘ä»¬å†™æœåŠ¡å™¨çš„æ—¶å€™ä¸çŸ¥é“è·¯å¾„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è§„å®šä¸€ä¸ªç›®å½•ï¼Œè®©ç¨‹åºå‘˜å°†Servletæ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚ä¸ºäº†å°†è¿™äº›åº”ç”¨ç¨‹åºç±»å’ŒæœåŠ¡å™¨è‡ªèº«çš„ç±»åˆ†å¼€ï¼Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªURLClassLoaderæ¥è¿›è¡ŒåŠ è½½ã€‚åé¢æ¶‰åŠåˆ°å¤šåº”ç”¨çš„æ—¶å€™ï¼Œä¼šå†è¯¦ç»†ä»‹ç»Javaçš„ç±»åŠ è½½æœºåˆ¶ã€‚</p><p>ä¹‹åï¼Œåˆ›å»ºè°ƒç”¨Servletå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„ <code>service()</code> æ–¹æ³•ï¼Œè°ƒç”¨çš„æ—¶å€™ï¼Œå°†Requestå’ŒResponseä½œä¸ºå‚æ•°ä¼ è¿›å»ã€‚åº”ç”¨ç¨‹åºå‘˜å†™Servletçš„æ—¶å€™ï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ªRequestè·å–å‚æ•°ï¼Œç„¶åå°†ç»“æœå†™å…¥åˆ°Responseä¸­ã€‚</p><p>æœ€åï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨åŠ ä¸Š <code>flush()</code>ï¼Œä¿è¯è¾“å‡ºã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹ä¸å®é™…çš„ServletæœåŠ¡å™¨è§„èŒƒå¤§ä½“ä¸€è‡´ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºå•ä¾‹æ¨¡å¼ã€‚æŒ‰ç…§Servletè§„èŒƒï¼Œä¸€ä¸ªServletåº”å½“æ˜¯å•å¯¹è±¡å¤šçº¿ç¨‹çš„ã€‚è€Œæˆ‘ä»¬ç°åœ¨æ¯æ¬¡éƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„Servletå¯¹è±¡ï¼Œåé¢éœ€è¦è¿›ä¸€æ­¥ä¿®æ­£ã€‚</p><h2>è°ƒæ•´æœåŠ¡å™¨ç¨‹åº</h2><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†åŠ¨æ€èµ„æºä¸é™æ€èµ„æºçš„å¤„ç†ç±»ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦è°ƒæ•´æœåŠ¡ç«¯çš„å¤„ç†ä»£ç äº†ï¼Œä¸»è¦éœ€è¦è°ƒæ•´HTTP Serverç±»é‡Œçš„awaitæ–¹æ³•ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹è°ƒæ•´è¿‡åçš„HTTP Serverç±»ã€‚</p><pre><code class=\"language-java\">public class HttpServer {\n    public static final String WEB_ROOT = System.getProperty(\"user.dir\") + File.separator + \"webroot\";\n    public static void main(String[] args) {\n        HttpServer server = new HttpServer();\n        server.await();\n    }\n    public void await() {\n        ServerSocket serverSocket = null;\n        int port = 8080;\n        try {\n            serverSocket = new ServerSocket(port, 1, InetAddress.getByName(\"127.0.0.1\"));\n        } catch (IOException e) {\n            e.printStackTrace();\n            System.exit(1);\n        }\n        while (true) {\n            Socket socket = null;\n            InputStream input = null;\n            OutputStream output = null;\n            try {\n                socket = serverSocket.accept();\n                input = socket.getInputStream();\n                output = socket.getOutputStream();\n                // create Request object and parse\n                Request request = new Request(input);\n                request.parse();\n                // create Response object\n                Response response = new Response(output);\n                response.setRequest(request);\n                if (request.getUri().startsWith(\"/servlet/\")) {\n                    ServletProcessor processor = new ServletProcessor();\n                    processor.process(request, response);\n                }\n                else {\n                    StaticResourceProcessor processor = new StaticResourceProcessor();\n                    processor.process(request, response);\n                }\n                // close the socket\n                socket.close();\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n        }\n    }\n}\n</code></pre><p>å’Œä¸Šä¸€èŠ‚è¯¾ç›¸æ¯”ï¼Œå”¯ä¸€çš„å˜åŒ–åœ¨äºæ–°å¢äº†å¯¹æ˜¯å¦ä¸ºServletçš„åˆ¤æ–­ã€‚</p><pre><code class=\"language-java\">if (request.getUri().startsWith(\"/servlet/\")) {\n    ServletProcessor processor = new ServletProcessor();\n    processor.process(request, response);\n}\nelse {\n    StaticResourceProcessor processor = new StaticResourceProcessor();\n    processor.process(request, response);\n}\n</code></pre><p>å¦‚æœæ˜¯Servletï¼Œå°±å¯ç”¨ServletProcessorï¼Œå¦‚æœä¸æ˜¯Servletï¼Œå°±è®¤ä¸ºæ˜¯ä¸€ä¸ªé™æ€èµ„æºã€‚</p><p>ç°åœ¨æ”¹é€ å·¥ä½œå°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼Œç¼–å†™ä¸€æ®µæµ‹è¯•ä»£ç å¯¹æˆ‘ä»¬çš„åŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚</p><h2>æµ‹è¯•</h2><p>åœ¨ <code>src/test/java/test</code> ç›®å½•ä¸‹ï¼Œå®šä¹‰HelloServlet.javaï¼Œå®ç°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„Servletæ¥å£ã€‚</p><pre><code class=\"language-java\">package test;\nimport server.Request;\nimport server.Response;\nimport server.Servlet;\nimport java.io.IOException;\npublic class HelloServlet implements Servlet {\n    @Override\n    public void service(Request req, Response res) throws IOException {\n        String doc = \"&lt;!DOCTYPE html&gt; \\n\" +\n                \"&lt;html&gt;\\n\" +\n                \"&lt;head&gt;&lt;meta charset=\\\"utf-8\\\"&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;\\n\"+\n                \"&lt;body bgcolor=\\\"#f0f0f0\\\"&gt;\\n\" +\n                \"&lt;h1 align=\\\"center\\\"&gt;\" + \"Hello World ä½ å¥½\" + \"&lt;/h1&gt;\\n\";\n        res.getOutput().write(doc.getBytes(\"utf-8\"));\n    }\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿”å›çš„å†…å®¹éƒ½æ˜¯çº¯HTMLè¯­æ³•ï¼Œåªç¼–å†™äº†è¿”å›ä½“ï¼Œä¸å†å…³å¿ƒè¿”å›å¤´çš„å†…å®¹ã€‚åœ¨ç¼–å†™å®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦å•ç‹¬ç¼–è¯‘è¿™ä¸ªç±»ï¼Œç”ŸæˆHelloServlet.classï¼ŒæŠŠç¼–è¯‘åçš„æ–‡ä»¶æ”¾åˆ° <code>/webroot/test</code> ç›®å½•ä¸‹ï¼ŒåŸå› åœ¨äºæˆ‘ä»¬çš„æœåŠ¡å™¨éœ€è¦ä»webrootç›®å½•ä¸‹è·å–èµ„æºæ–‡ä»¶ã€‚</p><p>åœ¨å‡†å¤‡å·¥ä½œè¿›è¡Œå®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬è¿è¡ŒHttpServeræœåŠ¡å™¨ï¼Œé”®å…¥ <code>http://localhost:8080/hello.txt</code> åï¼Œå¯ä»¥å‘ç°hello.txté‡Œæ‰€æœ‰çš„æ–‡æœ¬å†…å®¹ï¼Œéƒ½ä½œä¸ºè¿”å›ä½“å±•ç¤ºåœ¨æµè§ˆå™¨é¡µé¢ä¸Šäº†ã€‚æˆ‘ä»¬å†è¾“å…¥ <code>http://localhost:8080/servlet/test.HelloServlet</code> å°±å¯ä»¥çœ‹åˆ°æµè§ˆå™¨æ˜¾ç¤ºï¼šHello World ä½ å¥½ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨HelloServletä¸­å®šä¹‰çš„è¿”å›èµ„æºå†…å®¹ã€‚</p><p>è¿™è¡¨æ˜æ•´ä½“åŠŸèƒ½æ”¹é€ æˆåŠŸã€‚</p><h2>å°ç»“</h2><p><img src=\"https://static001.geekbang.org/resource/image/d3/e3/d3a4341ef3a5b7f0153c9a179c7f74e3.jpg?wh=3547x2572\" alt=\"\"></p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬åŸºäºå‰é¢æœ€å°å¯ç”¨çš„HttpServeræœåŠ¡å™¨è¿›è¡Œäº†æ”¹é€ ï¼Œä¸»è¦åŒ…æ‹¬å¯¹HTTPåè®®è¿”å›å†…å®¹ä¸­çš„çŠ¶æ€è¡Œå’Œè¿”å›å¤´è¿›è¡Œå°è£…ï¼Œè¿˜æœ‰å¼•å…¥åŠ¨æ€èµ„æºå’ŒServletçš„æ¦‚å¿µï¼Œå¯¹Webç«¯è¿”å›å†…å®¹è¿›è¡Œäº†æ‰©å……ã€‚ä½†æ˜¯æˆ‘ä»¬è¦æ³¨æ„çš„ä¸€ç‚¹åœ¨äº<strong>ç›®å‰æˆ‘ä»¬å¹¶æ²¡æœ‰éµå®ˆ Servlet çš„è§„èŒƒï¼Œåªæ˜¯ç®€å•å¼•å…¥äº†è¿™ä¸€æ¦‚å¿µè€Œå·²ï¼Œå¯¹æ­¤æˆ‘ä»¬è¿˜æœ‰è®¸å¤šæ”¹è¿›ä¼˜åŒ–çš„ç©ºé—´ã€‚</strong></p><p>æœ¬èŠ‚è¯¾ä»£ç å‚è§ï¼š<a href=\"https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter03\">https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter03</a></p><h2><strong>æ€è€ƒé¢˜</strong></h2><p>å­¦å®Œäº†è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬ç°åœ¨æ˜¯ç®€å•åœ°é€šè¿‡URIä¸­åŒ…å« <code>/servlet/</code> æ¥åˆ¤åˆ«æ˜¯å¦æ˜¯ä¸€ä¸ªåŠ¨æ€Servletï¼Œæœ‰ä»€ä¹ˆæ›´å¥½çš„åŠæ³•å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ çš„æ–¹æ³•åˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":385536,"user_name":"soâ€†long","can_delete":false,"product_type":"c1","uid":1449679,"ip_address":"æµ™æ±Ÿ","ucode":"2A6B47BB32FC18","user_header":"https://static001.geekbang.org/account/avatar/00/16/1e/cf/97cd8be1.jpg","comment_is_top":false,"comment_ctime":1702892599,"is_pvip":false,"replies":[{"id":140510,"content":"å¥½é—®é¢˜å•Šã€‚è¿™ä¸ªæƒ…å†µè®°ä½ä¸‰ç‚¹ï¼Œä¸€ï¼Œè¦è®¾ç½®content-length äºŒï¼Œæˆ–è€…æŒ‡å®štransfer-encodingä¸ºchunkedï¼Œä¸‰ï¼Œéƒ½ä¸æŒ‡å®šï¼Œå¯ç”¨çŸ­è¿æ¥ï¼Œå³æœåŠ¡å™¨å…³é—­è¿æ¥ã€‚ ä¸ç¬¦åˆä¸‰ç‚¹çš„æƒ…å†µï¼Œå¤§æ¦‚ç‡å‡ºé—®é¢˜ã€‚MiniTomcatæ˜¯ç®€åŒ–æ•™å­¦ç‰ˆæœ¬ï¼Œæ˜¯çŸ­è¿æ¥ï¼Œåªæ˜¯æ¢è®¨äº†ä¸€ä¸‹chunkedæ–¹å¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1702970812,"ip_address":"åŒ—äº¬","comment_id":385536,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è€å¸ˆè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼ŒServletProcessoræ²¡æœ‰è®¾ç½®å“åº”å¤´Content-Lengthï¼Œæµè§ˆå™¨ä¸ä¼šæœ‰æ‹†åŒ…æˆ–è€…ç²˜åŒ…çš„é—®é¢˜å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634075,"discussion_content":"å¥½é—®é¢˜å•Šã€‚è¿™ä¸ªæƒ…å†µè®°ä½ä¸‰ç‚¹ï¼Œä¸€ï¼Œè¦è®¾ç½®content-length äºŒï¼Œæˆ–è€…æŒ‡å®štransfer-encodingä¸ºchunkedï¼Œä¸‰ï¼Œéƒ½ä¸æŒ‡å®šï¼Œå¯ç”¨çŸ­è¿æ¥ï¼Œå³æœåŠ¡å™¨å…³é—­è¿æ¥ã€‚ ä¸ç¬¦åˆä¸‰ç‚¹çš„æƒ…å†µï¼Œå¤§æ¦‚ç‡å‡ºé—®é¢˜ã€‚MiniTomcatæ˜¯ç®€åŒ–æ•™å­¦ç‰ˆæœ¬ï¼Œæ˜¯çŸ­è¿æ¥ï¼Œåªæ˜¯æ¢è®¨äº†ä¸€ä¸‹chunkedæ–¹å¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702970812,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385347,"user_name":"HHğŸ·ğŸ ","can_delete":false,"product_type":"c1","uid":1133678,"ip_address":"å¹¿ä¸œ","ucode":"C50172BDA604D5","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","comment_is_top":false,"comment_ctime":1702467035,"is_pvip":false,"replies":[{"id":140437,"content":"web.xmlæ˜¯ç»å…¸æ–¹æ³•","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1702521482,"ip_address":"åŒ—äº¬","comment_id":385347,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"ğŸ¤ªåŒ¹é… web.xml æˆ–æ³¨è§£å®šä¹‰çš„ servlet åç§°ï¼Œ æ‰¾åˆ°å°±å¯ä»¥å½“åšåŠ¨æ€ servletã€‚ ä¸çŸ¥é“å¯¹ä¸å¯¹ï¼Œ æƒ³æ³•æ¯”è¾ƒå•è°ƒï¼Œ å¸Œæœ›è€å¸ˆå’Œæœ‹å‹ç»™å‡ºç‚¹è¯„å’Œæ„è§","like_count":1,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633708,"discussion_content":"web.xmlæ˜¯ç»å…¸æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702521482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":387052,"user_name":"Xiaosong","can_delete":false,"product_type":"c1","uid":1883431,"ip_address":"ç¾å›½","ucode":"28A03027343F9D","user_header":"https://static001.geekbang.org/account/avatar/00/1c/bd/27/e653a220.jpg","comment_is_top":false,"comment_ctime":1706326698,"is_pvip":false,"replies":[{"id":141107,"content":"ä½ ç”¨IDEAï¼ŒæŠŠGiteeä¸Šçš„é¡¹ç›®æ‹‰ä¸‹æ¥ï¼Œç„¶åç¼–è¯‘ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1706574422,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":387052,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"æ¬¸ ä»æ¥æ²¡ å•ç‹¬ç¼–è¯‘è¿‡å•ç‹¬çš„ javaæ–‡ä»¶ï¼Œæˆ‘çœ‹targeté‡Œé¢ä¸ç¼–è¯‘test diråº•ä¸‹çš„æ–‡ä»¶ï¼Œè¯·æ•™ä¸€ä¸‹æ€ä¹ˆæ“ä½œ","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636608,"discussion_content":"ä½ ç”¨IDEAï¼ŒæŠŠGiteeä¸Šçš„é¡¹ç›®æ‹‰ä¸‹æ¥ï¼Œç„¶åç¼–è¯‘ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1706574422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385450,"user_name":"Geek_50a5cc","can_delete":false,"product_type":"c1","uid":1786951,"ip_address":"åŒ—äº¬","ucode":"0F6C1C2552261F","user_header":"","comment_is_top":false,"comment_ctime":1702630993,"is_pvip":false,"replies":[{"id":140467,"content":"å¯¹çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1702688067,"ip_address":"åŒ—äº¬","comment_id":385450,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"æ‰€ä»¥ Servlet åŠ¨æ€èµ„æºçš„ classloader éƒ½æ˜¯å» ç¼–è¯‘åçš„classeså®šä½éœ€è¦çš„Servletï¼Œå¯¹å—","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633862,"discussion_content":"å¯¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702688067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385414,"user_name":"å½©ç¬”é‡‡è´­","can_delete":false,"product_type":"c1","uid":3508556,"ip_address":"æ²³å—","ucode":"1619359E489AF7","user_header":"https://static001.geekbang.org/account/avatar/00/35/89/4c/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1702608643,"is_pvip":false,"replies":[{"id":140466,"content":"æ­å–œå•Šï¼å¸Œæœ›åˆ†äº«ä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1702687986,"ip_address":"åŒ—äº¬","comment_id":385414,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"å•Šæˆ‘æ‚Ÿäº†","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633861,"discussion_content":"æ­å–œå•Šï¼å¸Œæœ›åˆ†äº«ä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702687987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385395,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1702558115,"is_pvip":false,"replies":[{"id":140479,"content":"Q1ï¼Œä»£ç å†IDEAä¸Šéƒ½æ˜¯å¯ç¼–è¯‘è¿è¡Œçš„ï¼Œä½ æ˜¯å†Giteeä¸Šæ‹¿çš„å®Œæ•´ä»£ç å—ï¼Ÿæ–‡æœ¬ä¸­çš„ä»£ç åªæ˜¯ä¸»ä½“éƒ¨åˆ†ï¼Œå› ä¸ºç¯‡å¹…åŸå› ï¼Œä¸å®Œæ•´ã€‚\nQ2ï¼Œå­¦åˆ°è¿™èŠ‚è¯¾ï¼ŒResponseåªæœ‰è¿™ä¹ˆä¸€ç‚¹ç‚¹ã€‚Miniç³»åˆ—è¯¾ç¨‹çš„é£æ ¼éƒ½æ˜¯ä»æ— åˆ°æœ‰ä¸€ç‚¹ç‚¹é•¿å¤§ï¼Œåé¢çš„ç« èŠ‚å›é€æ­¥å®Œå–„å®ƒã€‚\nQ3ï¼Œrequestå’Œresponseéƒ½å¯ä»¥å¤„ç†æ–‡ä»¶ï¼ŒMultipart&#47;form-dataï¼Œä½ å¯ä»¥çœ‹çœ‹httpåè®®çš„è§„å®šã€‚MiniTomcatæ²¡æœ‰å®ç°ã€‚æˆ‘ä»¬çš„ä¸»è¦ç›®æ ‡æ˜¯servletå®¹å™¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1702776906,"ip_address":"åŒ—äº¬","comment_id":385395,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š\nQ1ï¼šè€å¸ˆå¼€å‘ç”¨çš„IDEæ˜¯Ideaå—ï¼Ÿ\næˆ‘ç”¨Idea2019ï¼Œæ‰“å¼€è€å¸ˆçš„ç¬¬ä¸‰è¯¾ä»£ç ï¼Œæ‰“å¼€HttpServer.java,è¿è¡Œmainå‡½æ•°ï¼Œæç¤ºç¼–è¯‘é”™è¯¯ï¼šâ€œError:java: é”™è¯¯: ä¸æ”¯æŒå‘è¡Œç‰ˆæœ¬ 5â€ã€‚\næˆ‘çš„ç”µè„‘ä¸Šjavaç‰ˆæœ¬æ˜¯java8ã€‚è€å¸ˆçš„ä»£ç åªæœ‰ä¸‰éƒ¨åˆ†ï¼šsrcç›®å½•ã€webrootç›®å½•ã€pom.xmlï¼Œéƒ½æ²¡æœ‰åŒ…å«Javaç‰ˆæœ¬ä¿¡æ¯å•Šã€‚\nNote1:å…¶ä¸­ä¸€éƒ¨åˆ†ä»£ç æ˜¯ï¼š if (index2 &gt; index1) return requestString.substring(index1 + 1, index2);  å¯¹äºè¿™ä¸ªä»£ç ï¼Œidea2019çš„æç¤ºæ˜¯ï¼š&#39;if&#39;æ²¡æœ‰åŠ å¤§æ‹¬å·ã€‚ï¼‰\nNote2:\nimport java.time.ZonedDateTime;\nå¯¹äºæ­¤å¯¼åŒ…ï¼Œæœ‰çº¢è‰²ä¸‹åˆ’çº¿ï¼ŒIdea2019æç¤ºâ€œUsage of API documented as @since 1.8+ â€ã€‚è¿™ä¸ªæœ‰å½±å“å—ï¼Ÿ\n\nQ2ï¼šResponseç±»åªæœ‰è¿™äº›å†…å®¹å—ï¼Ÿ\næœ¬è¯¾ä¸­ï¼ŒResponseåªå½“åšå®ä½“ç±»å¤„ç†ï¼Œå®ä½“ç±»çš„è¯ï¼Œåº”è¯¥åŒ…å«å“åº”çš„å¤šä¸ªå­—æ®µï¼Œæ¯”å¦‚çŠ¶æ€è¡Œã€å“åº”å¤´ç­‰å­—æ®µï¼Œä½†æœ¬æ–‡åªæœ‰Requestå’ŒOutputStreamï¼Œæ˜¯æ²¡æœ‰å…¨éƒ¨åˆ—å‡ºæ¥å—ï¼Ÿ\n\nQ3ï¼šå¯¹äºå›¾ç‰‡ï¼ŒResponseæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ\næŠŠå›¾ç‰‡ä¹Ÿå½“åšæ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶ï¼Œè¯»å‡ºçš„ç»“æœåº”è¯¥æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶åæŠŠäºŒè¿›åˆ¶æ•°æ®æ”¾åˆ°responseçš„å“åº”ä½“ä¸­ï¼Œæ˜¯è¿™æ ·å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633912,"discussion_content":"Q1ï¼Œä»£ç å†IDEAä¸Šéƒ½æ˜¯å¯ç¼–è¯‘è¿è¡Œçš„ï¼Œä½ æ˜¯å†Giteeä¸Šæ‹¿çš„å®Œæ•´ä»£ç å—ï¼Ÿæ–‡æœ¬ä¸­çš„ä»£ç åªæ˜¯ä¸»ä½“éƒ¨åˆ†ï¼Œå› ä¸ºç¯‡å¹…åŸå› ï¼Œä¸å®Œæ•´ã€‚\nQ2ï¼Œå­¦åˆ°è¿™èŠ‚è¯¾ï¼ŒResponseåªæœ‰è¿™ä¹ˆä¸€ç‚¹ç‚¹ã€‚Miniç³»åˆ—è¯¾ç¨‹çš„é£æ ¼éƒ½æ˜¯ä»æ— åˆ°æœ‰ä¸€ç‚¹ç‚¹é•¿å¤§ï¼Œåé¢çš„ç« èŠ‚å›é€æ­¥å®Œå–„å®ƒã€‚\nQ3ï¼Œrequestå’Œresponseéƒ½å¯ä»¥å¤„ç†æ–‡ä»¶ï¼ŒMultipart/form-dataï¼Œä½ å¯ä»¥çœ‹çœ‹httpåè®®çš„è§„å®šã€‚MiniTomcatæ²¡æœ‰å®ç°ã€‚æˆ‘ä»¬çš„ä¸»è¦ç›®æ ‡æ˜¯servletå®¹å™¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702776906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1133678,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","nickname":"HHğŸ·ğŸ ","note":"","ucode":"C50172BDA604D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633789,"discussion_content":"å…„å¼Ÿï¼Œ Q1åº”è¯¥æ˜¯ä½ æœ¬åœ°å·¥å…·ç¯å¢ƒé—®é¢˜ï¼›  Q2 Response ä¼ é€’ç»™ ResourceProcessor è¿›è¡Œå¤„ç†ï¼Œ ä½ çœ‹çœ‹ StaticResourceProcessor è¿™ä¸ªç±»ä»–å°±æ˜¯æœ‰å¤„ç†å“åº”å¤´çš„ä»£ç ï¼Œ ä½ å¯ä»¥çœ‹ä¸€ä¸‹ï¼› Q3 å°±è·Ÿä½ è¯´çš„ä¸€æ ·ï¼Œ è¯»å–å›¾ç‰‡ç„¶åè¾“å‡ºï¼ŒStaticResourceProcessor å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚  ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1702622139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":393980,"user_name":"wild wings.Luv","can_delete":false,"product_type":"c1","uid":3790749,"ip_address":"ä¸Šæµ·","ucode":"D76D40B24B4998","user_header":"https://static001.geekbang.org/account/avatar/00/39/d7/9d/73390cc0.jpg","comment_is_top":false,"comment_ctime":1725494287,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·é—®è€å¸ˆï¼Œåœ¨02å¤„ç†é™æ€èµ„æºçš„æ—¶å€™ï¼Œcontenttypeè®¾ç½®ä¸º12ï¼Œhello.txtæ˜¯æ•´ä¸ªhttpæŠ¥æ–‡çš„å†…å®¹ï¼Œæ­¤æ—¶ä¼šè§£æå‰é¢çš„å†…å®¹ä½œä¸ºå“åº”å¤´ã€‚ä½†æ˜¯åœ¨03å¤„ç†é™æ€èµ„æºï¼Œæ˜¯æ‹¼æ¥å“åº”å¤´ï¼Œæ‰€ä»¥hello.txtæ•´ä¸ªæ–‡ä»¶éƒ½è¢«å½“æˆäº†å“åº”ä½“ã€‚æ­¤æ—¶hello.txtå°±ä¸éœ€è¦æ˜¯æ•´ä¸ªæŠ¥æ–‡äº†ã€‚","like_count":0},{"had_liked":false,"id":385616,"user_name":"Martito","can_delete":false,"product_type":"c1","uid":3171426,"ip_address":"å±±ä¸œ","ucode":"6C29938DB2A92B","user_header":"https://static001.geekbang.org/account/avatar/00/30/64/62/8b20c551.jpg","comment_is_top":false,"comment_ctime":1702979189,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"ä¸ºä»€ä¹ˆæˆ‘ç¼–è¯‘è¿™ä¸ªHelloServlet.javaæŠ¥é”™å‘¢ ideaä¸­ä¹Ÿæ²¡æœ‰æç¤ºé”™è¯¯å‘€","like_count":0,"discussions":[{"author":{"id":1004852,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIOalZv4nwJSuZbjicJAia6zYzRXRs969HRD8H3fmGIUbhhmDkVHUwWjVqs6LlzprWrplXKUpBbW1gA/132","nickname":"ä¸´æµ·å¬é£","note":"","ucode":"F6A18E3668DCC5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634252,"discussion_content":"åŒç¼–è¯‘æŠ¥é”™ï¼Œè¯·é—®è§£å†³äº†å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703129953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}