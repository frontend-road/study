{"id":65287,"title":"33 | 深入解析容器跨主机网络","content":"<p>你好，我是张磊。今天我和你分享的主题是：深入解析容器跨主机网络。</p><p>在上一篇文章中，我为你详细讲解了在单机环境下，Linux容器网络的实现原理（网桥模式）。并且提到了，在Docker的默认配置下，不同宿主机上的容器通过IP地址进行互相访问是根本做不到的。</p><p>而正是为了解决这个容器“跨主通信”的问题，社区里才出现了那么多的容器网络方案。而且，相信你一直以来都有这样的疑问：这些网络方案的工作原理到底是什么？</p><p>要理解容器“跨主通信”的原理，就一定要先从Flannel这个项目说起。</p><p>Flannel项目是CoreOS公司主推的容器网络方案。事实上，Flannel项目本身只是一个框架，真正为我们提供容器网络功能的，是Flannel的后端实现。目前，Flannel支持三种后端实现，分别是：</p><ol>\n<li>\n<p>VXLAN；</p>\n</li>\n<li>\n<p>host-gw；</p>\n</li>\n<li>\n<p>UDP。</p>\n</li>\n</ol><p>这三种不同的后端实现，正代表了三种容器跨主网络的主流实现方法。其中，host-gw模式，我会在下一篇文章中再做详细介绍。</p><p>而UDP模式，是Flannel项目最早支持的一种方式，却也是性能最差的一种方式。所以，这个模式目前已经被弃用。不过，Flannel之所以最先选择UDP模式，就是因为这种模式是最直接、也是最容易理解的容器跨主网络实现。</p><!-- [[[read_end]]] --><p>所以，在今天这篇文章中，<span class=\"orange\">我会先从UDP模式开始，来为你讲解容器“跨主网络”的实现原理。</span></p><p>在这个例子中，我有两台宿主机。</p><ul>\n<li>宿主机Node 1上有一个容器container-1，它的IP地址是100.96.1.2，对应的docker0网桥的地址是：100.96.1.1/24。</li>\n<li>宿主机Node 2上有一个容器container-2，它的IP地址是100.96.2.3，对应的docker0网桥的地址是：100.96.2.1/24。</li>\n</ul><p>我们现在的任务，就是让container-1访问container-2。</p><p>这种情况下，container-1容器里的进程发起的IP包，其源地址就是100.96.1.2，目的地址就是100.96.2.3。由于目的地址100.96.2.3并不在Node 1的docker0网桥的网段里，所以这个IP包会被交给默认路由规则，通过容器的网关进入docker0网桥（如果是同一台宿主机上的容器间通信，走的是直连规则），从而出现在宿主机上。</p><p>这时候，这个IP包的下一个目的地，就取决于宿主机上的路由规则了。此时，Flannel已经在宿主机上创建出了一系列的路由规则，以Node 1为例，如下所示：</p><pre><code># 在Node 1上\n$ ip route\ndefault via 10.168.0.1 dev eth0\n100.96.0.0/16 dev flannel0  proto kernel  scope link  src 100.96.1.0\n100.96.1.0/24 dev docker0  proto kernel  scope link  src 100.96.1.1\n10.168.0.0/24 dev eth0  proto kernel  scope link  src 10.168.0.2\n</code></pre><p>可以看到，由于我们的IP包的目的地址是100.96.2.3，它匹配不到本机docker0网桥对应的100.96.1.0/24网段，只能匹配到第二条、也就是100.96.0.0/16对应的这条路由规则，从而进入到一个叫作flannel0的设备中。</p><p>而这个flannel0设备的类型就比较有意思了：它是一个TUN设备（Tunnel设备）。</p><p>在Linux中，TUN设备是一种工作在三层（Network Layer）的虚拟网络设备。TUN设备的功能非常简单，即：<strong>在操作系统内核和用户应用程序之间传递IP包。</strong></p><p>以flannel0设备为例：像上面提到的情况，当操作系统将一个IP包发送给flannel0设备之后，flannel0就会把这个IP包，交给创建这个设备的应用程序，也就是Flannel进程。这是一个从内核态（Linux操作系统）向用户态（Flannel进程）的流动方向。</p><p>反之，如果Flannel进程向flannel0设备发送了一个IP包，那么这个IP包就会出现在宿主机网络栈中，然后根据宿主机的路由表进行下一步处理。这是一个从用户态向内核态的流动方向。</p><p>所以，当IP包从容器经过docker0出现在宿主机，然后又根据路由表进入flannel0设备后，宿主机上的flanneld进程（Flannel项目在每个宿主机上的主进程），就会收到这个IP包。然后，flanneld看到了这个IP包的目的地址，是100.96.2.3，就把它发送给了Node 2宿主机。</p><p>等一下，<strong>flanneld又是如何知道这个IP地址对应的容器，是运行在Node 2上的呢？</strong></p><p>这里，就用到了Flannel项目里一个非常重要的概念：子网（Subnet）。</p><p>事实上，在由Flannel管理的容器网络里，一台宿主机上的所有容器，都属于该宿主机被分配的一个“子网”。在我们的例子中，Node 1的子网是100.96.1.0/24，container-1的IP地址是100.96.1.2。Node 2的子网是100.96.2.0/24，container-2的IP地址是100.96.2.3。</p><p>而这些子网与宿主机的对应关系，正是保存在Etcd当中，如下所示：</p><pre><code>$ etcdctl ls /coreos.com/network/subnets\n/coreos.com/network/subnets/100.96.1.0-24\n/coreos.com/network/subnets/100.96.2.0-24\n/coreos.com/network/subnets/100.96.3.0-24\n</code></pre><p>所以，flanneld进程在处理由flannel0传入的IP包时，就可以根据目的IP的地址（比如100.96.2.3），匹配到对应的子网（比如100.96.2.0/24），从Etcd中找到这个子网对应的宿主机的IP地址是10.168.0.3，如下所示：</p><pre><code>$ etcdctl get /coreos.com/network/subnets/100.96.2.0-24\n{&quot;PublicIP&quot;:&quot;10.168.0.3&quot;}\n</code></pre><p>而对于flanneld来说，只要Node 1和Node 2是互通的，那么flanneld作为Node 1上的一个普通进程，就一定可以通过上述IP地址（10.168.0.3）访问到Node 2，这没有任何问题。</p><p>所以说，flanneld在收到container-1发给container-2的IP包之后，就会把这个IP包直接封装在一个UDP包里，然后发送给Node 2。不难理解，这个UDP包的源地址，就是flanneld所在的Node 1的地址，而目的地址，则是container-2所在的宿主机Node 2的地址。</p><p>当然，这个请求得以完成的原因是，每台宿主机上的flanneld，都监听着一个8285端口，所以flanneld只要把UDP包发往Node 2的8285端口即可。</p><p>通过这样一个普通的、宿主机之间的UDP通信，一个UDP包就从Node 1到达了Node 2。而Node 2上监听8285端口的进程也是flanneld，所以这时候，flanneld就可以从这个UDP包里解析出封装在里面的、container-1发来的原IP包。</p><p>而接下来flanneld的工作就非常简单了：flanneld会直接把这个IP包发送给它所管理的TUN设备，即flannel0设备。</p><p>根据我前面讲解的TUN设备的原理，这正是一个从用户态向内核态的流动方向（Flannel进程向TUN设备发送数据包），所以Linux内核网络栈就会负责处理这个IP包，具体的处理方法，就是通过本机的路由表来寻找这个IP包的下一步流向。</p><p>而Node 2上的路由表，跟Node 1非常类似，如下所示：</p><pre><code># 在Node 2上\n$ ip route\ndefault via 10.168.0.1 dev eth0\n100.96.0.0/16 dev flannel0  proto kernel  scope link  src 100.96.2.0\n100.96.2.0/24 dev docker0  proto kernel  scope link  src 100.96.2.1\n10.168.0.0/24 dev eth0  proto kernel  scope link  src 10.168.0.3\n</code></pre><p>由于这个IP包的目的地址是100.96.2.3，它跟第三条、也就是100.96.2.0/24网段对应的路由规则匹配更加精确。所以，Linux内核就会按照这条路由规则，把这个IP包转发给docker0网桥。</p><p>接下来的流程，就如同我在上一篇文章<a href=\"https://time.geekbang.org/column/article/64948\">《浅谈容器网络》</a>中和你分享的那样，docker0网桥会扮演二层交换机的角色，将数据包发送给正确的端口，进而通过Veth Pair设备进入到container-2的Network Namespace里。</p><p>而container-2返回给container-1的数据包，则会经过与上述过程完全相反的路径回到container-1中。</p><p>需要注意的是，上述流程要正确工作还有一个重要的前提，那就是docker0网桥的地址范围必须是Flannel为宿主机分配的子网。这个很容易实现，以Node 1为例，你只需要给它上面的Docker Daemon启动时配置如下所示的bip参数即可：</p><pre><code>$ FLANNEL_SUBNET=100.96.1.1/24\n$ dockerd --bip=$FLANNEL_SUBNET ...\n</code></pre><p>以上，就是基于Flannel UDP模式的跨主通信的基本原理了。我把它总结成了一幅原理图，如下所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/83/6c/8332564c0547bf46d1fbba2a1e0e166c.jpg?wh=1857*878\" alt=\"\" title=\"图1 基于Flannel UDP模式的跨主通信的基本原理\"></p><p>可以看到，Flannel UDP模式提供的其实是一个三层的Overlay网络，即：它首先对发出端的IP包进行UDP封装，然后在接收端进行解封装拿到原始的IP包，进而把这个IP包转发给目标容器。这就好比，Flannel在不同宿主机上的两个容器之间打通了一条“隧道”，使得这两个容器可以直接使用IP地址进行通信，而无需关心容器和宿主机的分布情况。</p><p>我前面曾经提到，上述UDP模式有严重的性能问题，所以已经被废弃了。通过我上面的讲述，你有没有发现性能问题出现在了哪里呢？</p><p>实际上，相比于两台宿主机之间的直接通信，基于Flannel UDP模式的容器通信多了一个额外的步骤，即flanneld的处理过程。而这个过程，由于使用到了flannel0这个TUN设备，仅在发出IP包的过程中，就需要经过三次用户态与内核态之间的数据拷贝，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/84/8d/84caa6dc3f9dcdf8b88b56bd2e22138d.png?wh=890*593\" alt=\"\" title=\"图2 TUN设备示意图\"></p><p>我们可以看到：</p><p>第一次，用户态的容器进程发出的IP包经过docker0网桥进入内核态；</p><p>第二次，IP包根据路由表进入TUN（flannel0）设备，从而回到用户态的flanneld进程；</p><p>第三次，flanneld进行UDP封包之后重新进入内核态，将UDP包通过宿主机的eth0发出去。</p><p>此外，我们还可以看到，Flannel进行UDP封装（Encapsulation）和解封装（Decapsulation）的过程，也都是在用户态完成的。在Linux操作系统中，上述这些上下文切换和用户态操作的代价其实是比较高的，这也正是造成Flannel UDP模式性能不好的主要原因。</p><p>所以说，<strong>我们在进行系统级编程的时候，有一个非常重要的优化原则，就是要减少用户态到内核态的切换次数，并且把核心的处理逻辑都放在内核态进行</strong>。这也是为什么，Flannel后来支持的<span class=\"orange\">VXLAN模式，逐渐成为了主流的容器网络方案的原因。</span></p><p>VXLAN，即Virtual Extensible LAN（虚拟可扩展局域网），是Linux内核本身就支持的一种网络虚似化技术。所以说，VXLAN可以完全在内核态实现上述封装和解封装的工作，从而通过与前面相似的“隧道”机制，构建出覆盖网络（Overlay Network）。</p><p>VXLAN的覆盖网络的设计思想是：在现有的三层网络之上，“覆盖”一层虚拟的、由内核VXLAN模块负责维护的二层网络，使得连接在这个VXLAN二层网络上的“主机”（虚拟机或者容器都可以）之间，可以像在同一个局域网（LAN）里那样自由通信。当然，实际上，这些“主机”可能分布在不同的宿主机上，甚至是分布在不同的物理机房里。</p><p>而为了能够在二层网络上打通“隧道”，VXLAN会在宿主机上设置一个特殊的网络设备作为“隧道”的两端。这个设备就叫作VTEP，即：VXLAN Tunnel End Point（虚拟隧道端点）。</p><p>而VTEP设备的作用，其实跟前面的flanneld进程非常相似。只不过，它进行封装和解封装的对象，是二层数据帧（Ethernet frame）；而且这个工作的执行流程，全部是在内核里完成的（因为VXLAN本身就是Linux内核中的一个模块）。</p><p>上述基于VTEP设备进行“隧道”通信的流程，我也为你总结成了一幅图，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/03/f5/03185fab251a833fef7ed6665d5049f5.jpg?wh=1767*933\" alt=\"\" title=\"图3 基于Flannel VXLAN模式的跨主通信的基本原理\n\"></p><p>可以看到，图中每台宿主机上名叫flannel.1的设备，就是VXLAN所需的VTEP设备，它既有IP地址，也有MAC地址。</p><p>现在，我们的container-1的IP地址是10.1.15.2，要访问的container-2的IP地址是10.1.16.3。</p><p>那么，与前面UDP模式的流程类似，当container-1发出请求之后，这个目的地址是10.1.16.3的IP包，会先出现在docker0网桥，然后被路由到本机flannel.1设备进行处理。也就是说，来到了“隧道”的入口。为了方便叙述，我接下来会把这个IP包称为“原始IP包”。</p><p>为了能够将“原始IP包”封装并且发送到正确的宿主机，VXLAN就需要找到这条“隧道”的出口，即：目的宿主机的VTEP设备。</p><p>而这个设备的信息，正是每台宿主机上的flanneld进程负责维护的。</p><p>比如，当Node 2启动并加入Flannel网络之后，在Node 1（以及所有其他节点）上，flanneld就会添加一条如下所示的路由规则：</p><pre><code>$ route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n...\n10.1.16.0       10.1.16.0       255.255.255.0   UG    0      0        0 flannel.1\n</code></pre><p>这条规则的意思是：凡是发往10.1.16.0/24网段的IP包，都需要经过flannel.1设备发出，并且，它最后被发往的网关地址是：10.1.16.0。</p><p>从图3的Flannel VXLAN模式的流程图中我们可以看到，10.1.16.0正是Node 2上的VTEP设备（也就是flannel.1设备）的IP地址。</p><p>为了方便叙述，接下来我会把Node 1和Node 2上的flannel.1设备分别称为“源VTEP设备”和“目的VTEP设备”。</p><p>而这些VTEP设备之间，就需要想办法组成一个虚拟的二层网络，即：通过二层数据帧进行通信。</p><p>所以在我们的例子中，“源VTEP设备”收到“原始IP包”后，就要想办法把“原始IP包”加上一个目的MAC地址，封装成一个二层数据帧，然后发送给“目的VTEP设备”（当然，这么做还是因为这个IP包的目的地址不是本机）。</p><p>这里需要解决的问题就是：<strong>“目的VTEP设备”的MAC地址是什么？</strong></p><p>此时，根据前面的路由记录，我们已经知道了“目的VTEP设备”的IP地址。而要根据三层IP地址查询对应的二层MAC地址，这正是ARP（Address Resolution Protocol ）表的功能。</p><p>而这里要用到的ARP记录，也是flanneld进程在Node 2节点启动时，自动添加在Node 1上的。我们可以通过ip命令看到它，如下所示：</p><pre><code># 在Node 1上\n$ ip neigh show dev flannel.1\n10.1.16.0 lladdr 5e:f8:4f:00:e3:37 PERMANENT\n</code></pre><p>这条记录的意思非常明确，即：IP地址10.1.16.0，对应的MAC地址是5e:f8:4f:00:e3:37。</p><blockquote>\n<p>可以看到，最新版本的Flannel并不依赖L3 MISS事件和ARP学习，而会在每台节点启动时把它的VTEP设备对应的ARP记录，直接下放到其他每台宿主机上。</p>\n</blockquote><p>有了这个“目的VTEP设备”的MAC地址，<strong>Linux内核就可以开始二层封包工作了</strong>。这个二层帧的格式，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/f2/55/f208fba66d2b58405864882342b23255.jpg?wh=799*179\" alt=\"\" title=\"图4 Flannel VXLAN模式的内部帧\"></p><p>可以看到，Linux内核会把“目的VTEP设备”的MAC地址，填写在图中的Inner Ethernet Header字段，得到一个二层数据帧。</p><p>需要注意的是，上述封包过程只是加一个二层头，不会改变“原始IP包”的内容。所以图中的Inner IP Header字段，依然是container-2的IP地址，即10.1.16.3。</p><p>但是，上面提到的这些VTEP设备的MAC地址，对于宿主机网络来说并没有什么实际意义。所以上面封装出来的这个数据帧，并不能在我们的宿主机二层网络里传输。为了方便叙述，我们把它称为“内部数据帧”（Inner Ethernet Frame）。</p><p>所以接下来，Linux内核还需要再把“内部数据帧”进一步封装成为宿主机网络里的一个普通的数据帧，好让它“载着”“内部数据帧”，通过宿主机的eth0网卡进行传输。</p><p>我们把这次要封装出来的、宿主机对应的数据帧称为“外部数据帧”（Outer Ethernet Frame）。</p><p>为了实现这个“搭便车”的机制，Linux内核会在“内部数据帧”前面，加上一个特殊的VXLAN头，用来表示这个“乘客”实际上是一个VXLAN要使用的数据帧。</p><p>而这个VXLAN头里有一个重要的标志叫作<strong>VNI</strong>，它是VTEP设备识别某个数据帧是不是应该归自己处理的重要标识。而在Flannel中，VNI的默认值是1，这也是为何，宿主机上的VTEP设备都叫作flannel.1的原因，这里的“1”，其实就是VNI的值。</p><p><strong>然后，Linux内核会把这个数据帧封装进一个UDP包里发出去。</strong></p><p>所以，跟UDP模式类似，在宿主机看来，它会以为自己的flannel.1设备只是在向另外一台宿主机的flannel.1设备，发起了一次普通的UDP链接。它哪里会知道，这个UDP包里面，其实是一个完整的二层数据帧。这是不是跟特洛伊木马的故事非常像呢？</p><p>不过，不要忘了，一个flannel.1设备只知道另一端的flannel.1设备的MAC地址，却不知道对应的宿主机地址是什么。</p><p>也就是说，这个UDP包该发给哪台宿主机呢？</p><p>在这种场景下，flannel.1设备实际上要扮演一个“网桥”的角色，在二层网络进行UDP包的转发。而在Linux内核里面，“网桥”设备进行转发的依据，来自于一个叫作FDB（Forwarding Database）的转发数据库。</p><p>不难想到，这个flannel.1“网桥”对应的FDB信息，也是flanneld进程负责维护的。它的内容可以通过bridge fdb命令查看到，如下所示：</p><pre><code># 在Node 1上，使用“目的VTEP设备”的MAC地址进行查询\n$ bridge fdb show flannel.1 | grep 5e:f8:4f:00:e3:37\n5e:f8:4f:00:e3:37 dev flannel.1 dst 10.168.0.3 self permanent\n</code></pre><p>可以看到，在上面这条FDB记录里，指定了这样一条规则，即：</p><p>发往我们前面提到的“目的VTEP设备”（MAC地址是5e:f8:4f:00:e3:37）的二层数据帧，应该通过flannel.1设备，发往IP地址为10.168.0.3的主机。显然，这台主机正是Node 2，UDP包要发往的目的地就找到了。</p><p>所以<strong>接下来的流程，就是一个正常的、宿主机网络上的封包工作。</strong></p><p>我们知道，UDP包是一个四层数据包，所以Linux内核会在它前面加上一个IP头，即原理图中的Outer IP Header，组成一个IP包。并且，在这个IP头里，会填上前面通过FDB查询出来的目的主机的IP地址，即Node 2的IP地址10.168.0.3。</p><p>然后，Linux内核再在这个IP包前面加上二层数据帧头，即原理图中的Outer Ethernet Header，并把Node 2的MAC地址填进去。这个MAC地址本身，是Node 1的ARP表要学习的内容，无需Flannel维护。这时候，我们封装出来的“外部数据帧”的格式，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/85/8cede8f74a57617494027ba137383f85.jpg?wh=1864*192\" alt=\"\" title=\"图5 Flannel VXLAN模式的外部帧\"></p><p>这样，封包工作就宣告完成了。</p><p>接下来，Node 1上的flannel.1设备就可以把这个数据帧从Node 1的eth0网卡发出去。显然，这个帧会经过宿主机网络来到Node 2的eth0网卡。</p><p>这时候，Node 2的内核网络栈会发现这个数据帧里有VXLAN Header，并且VNI=1。所以Linux内核会对它进行拆包，拿到里面的内部数据帧，然后根据VNI的值，把它交给Node 2上的flannel.1设备。</p><p>而flannel.1设备则会进一步拆包，取出“原始IP包”。接下来就回到了我在上一篇文章中分享的单机容器网络的处理流程。最终，IP包就进入到了container-2容器的Network Namespace里。</p><p>以上，就是Flannel VXLAN模式的具体工作原理了。</p><h2>总结</h2><p>在本篇文章中，我为你详细讲解了Flannel UDP和VXLAN模式的工作原理。这两种模式其实都可以称作“隧道”机制，也是很多其他容器网络插件的基础。比如Weave的两种模式，以及Docker的Overlay模式。</p><p>此外，从上面的讲解中我们可以看到，VXLAN模式组建的覆盖网络，其实就是一个由不同宿主机上的VTEP设备，也就是flannel.1设备组成的虚拟二层网络。对于VTEP设备来说，它发出的“内部数据帧”就仿佛是一直在这个虚拟的二层网络上流动。这，也正是覆盖网络的含义。</p><blockquote>\n<p>备注：如果你想要在我们前面部署的集群中实践Flannel的话，可以在Master节点上执行如下命令来替换网络插件。<br>\n第一步，执行<code>$ rm -rf /etc/cni/net.d/*</code>；<br>\n第二步，执行<code>$ kubectl delete -f \"https://cloud.weave.works/k8s/net?k8s-version=1.11\"</code>；<br>\n第三步，在<code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code>里，为容器启动命令添加如下两个参数：<br>\n<code>--allocate-node-cidrs=true</code><br>\n<code>--cluster-cidr=10.244.0.0/16</code><br>\n第四步， 重启所有kubelet；<br>\n第五步， 执行<code>$ kubectl create -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml</code>。</p>\n</blockquote><h2>思考题</h2><p>可以看到，Flannel通过上述的“隧道”机制，实现了容器之间三层网络（IP地址）的连通性。但是，根据这个机制的工作原理，你认为Flannel能负责保证二层网络（MAC地址）的连通性吗？为什么呢？</p><p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。</p>","neighbors":{"left":{"article_title":"32 | 浅谈容器网络","id":64948},"right":{"article_title":"34 | Kubernetes网络模型与CNI网络插件","id":67351}},"comments":[{"had_liked":false,"id":67901,"user_name":"宝爷","can_delete":false,"product_type":"c1","uid":1153664,"ip_address":"","ucode":"DD517FA7EB59AB","user_header":"https://static001.geekbang.org/account/avatar/00/11/9a/80/2bf8d7fc.jpg","comment_is_top":false,"comment_ctime":1550317962,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"778939398538","product_id":100015201,"comment_content":"这里使用UDP，不需要可靠，因为可靠性不是这一层需要考虑的事情，这一层需要考虑的事情就是把这个包发送到目标地址。如果出现了UDP丢包的情况，也完全没有关系，这里UDP包裹的是我们真正的数据包，如果我们上层使用的是TCP协议，而Flannel使用UDP包裹了我们的数据包，当出现丢包了，TCP的确认机制会发现这个丢包而重传，从而保证可靠。","like_count":182,"discussions":[{"author":{"id":1887603,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/cd/73/f6889c2f.jpg","nickname":"Wind","note":"","ucode":"AD108636DE44C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333162,"discussion_content":"这里的udp其实是充当了“数据链路层“， 这层本来就允许丢包\n","likes_number":14,"is_delete":false,"is_hidden":false,"ctime":1607469426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1207457,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6c/a1/80d83f0a.jpg","nickname":"Ellison","note":"","ucode":"A2FB94D4F6A332","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1887603,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/cd/73/f6889c2f.jpg","nickname":"Wind","note":"","ucode":"AD108636DE44C4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350309,"discussion_content":"一般都是内网IP进行传输， 如果出现丢包了， 肯定你设备问题","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1613809834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":333162,"ip_address":""},"score":350309,"extra":""}]},{"author":{"id":1022156,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/cc/d7793058.jpg","nickname":"lgjchina","note":"","ucode":"4B5482C935BB3C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313894,"discussion_content":"可靠性是TCP的重传机制，发送方没有收到确认然后重传，容器网络栈只管收发。另外一般在内网中，UDP是非常可靠的，除非出现网络设备故障。","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1603102583,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1910345,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/26/49/491fbb94.jpg","nickname":"WiSoniC","note":"","ucode":"FB5EDF6B902950","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":261835,"discussion_content":"精辟，是不是可以理解容器中的TCP数据包被宿主机封装成了UDP数据包，可靠性部分实际是容器内部的网络栈在维护？","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1589012250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1224228,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ae/24/5723e6fe.jpg","nickname":"绝望的生鱼片","note":"","ucode":"5F4337E4623FEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1910345,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/26/49/491fbb94.jpg","nickname":"WiSoniC","note":"","ucode":"FB5EDF6B902950","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347850,"discussion_content":"我理解是的，可靠性是在容器封装的tcp数据包里保证的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612340427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":261835,"ip_address":""},"score":347850,"extra":""},{"author":{"id":1313840,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0c/30/bb4bfe9d.jpg","nickname":"lyonger","note":"","ucode":"E89A75DADEA2A1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1910345,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/26/49/491fbb94.jpg","nickname":"WiSoniC","note":"","ucode":"FB5EDF6B902950","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385443,"discussion_content":"我也是这么理解的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1627047366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":261835,"ip_address":""},"score":385443,"extra":""}]}]},{"had_liked":false,"id":37333,"user_name":"Maiza","can_delete":false,"product_type":"c1","uid":1007248,"ip_address":"","ucode":"D6911CDAC0D8C7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/90/5f79859b.jpg","comment_is_top":false,"comment_ctime":1541551811,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"211994949315","product_id":100015201,"comment_content":"分分钟变成了计算机网络课程 😄","like_count":50,"discussions":[{"author":{"id":1845394,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/28/92/436735f5.jpg","nickname":"晞月520","note":"","ucode":"4F05E02A5C1608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287687,"discussion_content":"我以前是搞网络的 看这个都看不懂","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1593510233,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37503,"user_name":"虎虎❤️","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1541614869,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"160455404821","product_id":100015201,"comment_content":"我又思考了一下，二层网络可能无法连通。因为flannel网络中，node上的fdb是靠配置而非学习得到。当node1上的容器1想要通过mac地址直连node2上的容器2时，由于node1中的fdb中没有配置容器2的mac地址相关记录，所以flannel.1无法找到VTEP出口的ip。故而二层网络没有连通性。<br><br>如果想要有连通性，需要配置VTEP为学习模式，并且把所有的VTEP加入一个分组中。这样在fdb表中查询不到mac地址时，vxlan在VTEP组中发起广播(或者组播？这个概念我有点混淆)。VTEP也可作为一个网桥设备，继续向docker0，进而目的node上的所有容器广播。正确的目的地址会响应请求，而且刚才途经的设备fdb都学习到了源容器的mac 地址映射，所以响应数据可以顺利返回源容器。这样就完成了二层网络的连通。","like_count":37,"discussions":[{"author":{"id":1172019,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e2/33/3ca366bf.jpg","nickname":"寻找乌托邦","note":"","ucode":"12143F0FAAAF2B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18224,"discussion_content":"参考Vxlan网络Overlay 的方案就可以，自学习","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569033819,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135631,"user_name":"俊釆","can_delete":false,"product_type":"c1","uid":1046158,"ip_address":"","ucode":"AB08F7D04C20CB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/8e/c9c94420.jpg","comment_is_top":false,"comment_ctime":1569231502,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"134713217678","product_id":100015201,"comment_content":"读了至少6遍了，每次都有新的收获，感谢磊哥给力的分享。","like_count":32},{"had_liked":false,"id":37391,"user_name":"阿鹏","can_delete":false,"product_type":"c1","uid":1207915,"ip_address":"","ucode":"88C847A20EEA9A","user_header":"https://static001.geekbang.org/account/avatar/00/12/6e/6b/9c3f3abb.jpg","comment_is_top":false,"comment_ctime":1541567808,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"65966077248","product_id":100015201,"comment_content":"我看很多文章都推荐calico，老师觉得呢","like_count":15,"discussions":[{"author":{"id":1845394,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/28/92/436735f5.jpg","nickname":"晞月520","note":"","ucode":"4F05E02A5C1608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287688,"discussion_content":"calico 要对网络很熟悉 适合大的环境","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1593510259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":61713,"user_name":"凌","can_delete":false,"product_type":"c1","uid":1257995,"ip_address":"","ucode":"41369B360C794F","user_header":"https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg","comment_is_top":false,"comment_ctime":1547780321,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"53087387873","product_id":100015201,"comment_content":"flannel进程负责子网-&gt;VTEP mac，VTEP mac-&gt;节点ip(fdb)的维护，为什么不直接维护子网-&gt;节点ip表更直接，中间的二层网络感觉多此一举的","like_count":12,"discussions":[{"author":{"id":1359866,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/fa/de262c51.jpg","nickname":"钟阅","note":"","ucode":"3CCB22D2E3E10F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":76669,"discussion_content":"需要解耦VTEP 和host node，比如dest node is down, VTEP 迁移到新的node上的情况","likes_number":21,"is_delete":false,"is_hidden":false,"ctime":1575822918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1837179,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/08/7b/7f086546.jpg","nickname":"Alex","note":"","ucode":"70806CEA9AB15E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1359866,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/fa/de262c51.jpg","nickname":"钟阅","note":"","ucode":"3CCB22D2E3E10F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537043,"discussion_content":"有道理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638943687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":76669,"ip_address":""},"score":537043,"extra":""},{"author":{"id":2956746,"avatar":"","nickname":"Geek_4911b5","note":"","ucode":"EB3F19827ECCD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1359866,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/fa/de262c51.jpg","nickname":"钟阅","note":"","ucode":"3CCB22D2E3E10F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560058,"discussion_content":"这样的话，我觉得现有的逻辑也得处理你说的情况，并且flannel应该要保证VTEP迁移的场景。\n\n这里我觉得应该是报文到达node2后，后续的通信完全是二层的，而VETP得mac就相当于一个二层交换机。\n\n当然如果想直接找到容器的mac也行，但是这样路由信息就得很大很大","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649150404,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":76669,"ip_address":""},"score":560058,"extra":""},{"author":{"id":2334257,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/4fZ9thib248ZkR1N3Eekeyb8N1V1Ud0uePctlI4VQUibPSmEZvgoP0VYl6IsVHJc7ZMiczQMtU76y6E6ag1zNAK4Q/132","nickname":"Geek_336577","note":"","ucode":"4826355EBA4950","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2956746,"avatar":"","nickname":"Geek_4911b5","note":"","ucode":"EB3F19827ECCD2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576448,"discussion_content":"转移后，写入ETCD，集群内所有flanneld都会watch etcd，监听到变化后，做本节点的修改","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655558030,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":560058,"ip_address":""},"score":576448,"extra":""}]}]},{"had_liked":false,"id":281452,"user_name":"大杏仁儿","can_delete":false,"product_type":"c1","uid":1120756,"ip_address":"","ucode":"EBF09A3AAF93DC","user_header":"https://static001.geekbang.org/account/avatar/00/11/19/f4/34fdd4be.jpg","comment_is_top":false,"comment_ctime":1614753842,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"40269459506","product_id":100015201,"comment_content":"这个和一般的网络传输不同，一般的网络传输会直接请求ip地址，根据ip地址，发送ARP请求来获取下一跳设备的mac地址，获取mac地址之后会缓存下来，这是一般路由器或者网桥做的事情。但在容器网络里我们只知道目标容器的ip地址，并不知道宿主机的ip地址，需要将容器的ip地址和宿主机的ip地址关联起来。这个关系由路由规则, fdb存储的数据和ARP记录下来，这些都是在创建node节点的时候，由各个节点的flanneld创建出来。通过路由规则知道了该将数据包发送到flannel.1这个vtep设备处理并且知道了目地vtep的ip地址，通过vtep IP地址ip neigh show dev flannel.1 找到了对端的vtep mac地址，通过对端vtep mac地址查询 bridge fdb list 查到了这个mac地址对应的宿主机地址。 这样封装出包之后按照vxlan逻辑进行正常发送。","like_count":10,"discussions":[{"author":{"id":2530236,"avatar":"https://static001.geekbang.org/account/avatar/00/26/9b/bc/16d405c8.jpg","nickname":"喷火龙的梦想","note":"","ucode":"D883506CEBFDD6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554474,"discussion_content":"老表，我蒙圈了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646393029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":105556,"user_name":"坤","can_delete":false,"product_type":"c1","uid":1010922,"ip_address":"","ucode":"74E6838226A405","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg","comment_is_top":false,"comment_ctime":1561029644,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40215735308","product_id":100015201,"comment_content":"好深的功底","like_count":9},{"had_liked":false,"id":78488,"user_name":"whatever","can_delete":false,"product_type":"c1","uid":1446891,"ip_address":"","ucode":"675C63131E2BAF","user_header":"https://static001.geekbang.org/account/avatar/00/16/13/eb/150bf071.jpg","comment_is_top":false,"comment_ctime":1553158227,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"35912896595","product_id":100015201,"comment_content":"老师您将的关于linux网络方面的能介绍一本书吗？我想体系化的学习一下相关知识。比如flannel.1是怎么介入到操作系统内核那里的，是linux本身提供了扩展吗，这些问题我觉得还是需要体系化的学习一下，要不感觉知其然不知其所以然","like_count":8,"discussions":[{"author":{"id":1264563,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4b/b3/01d64240.jpg","nickname":"龟龟🐢","note":"","ucode":"C53C0D15C9EA83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574579,"discussion_content":"建议你看看协议栈的分层，flannel.1只是Linux上面的其中一种虚拟设备。对于协议栈来说，这些设备都是无差别化的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654159648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38261,"user_name":"勤劳的小胖子-libo","can_delete":false,"product_type":"c1","uid":1158344,"ip_address":"","ucode":"5BB20CD5A56568","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg","comment_is_top":false,"comment_ctime":1542007632,"is_pvip":false,"replies":[{"id":"13793","content":"现在它们都不依赖etcd，直接连apiserver","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1542070717,"ip_address":"","comment_id":38261,"utype":1}],"discussion_count":2,"race_medal":0,"score":"35901746000","product_id":100015201,"comment_content":"Flannel中的UDP需要Etcd来维护相关的子网与宿主机的对应关系，在VxLan中也需要Etcd吗？老师，什么时候可以讲下Etcd在k8s中的原理与应用？","like_count":9,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428659,"discussion_content":"现在它们都不依赖etcd，直接连apiserver","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542070717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1207457,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6c/a1/80d83f0a.jpg","nickname":"Ellison","note":"","ucode":"A2FB94D4F6A332","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350679,"discussion_content":"感觉对apiservice的开销更大了， 还好有informer","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613977421,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38216,"user_name":"何先生","can_delete":false,"product_type":"c1","uid":1178630,"ip_address":"","ucode":"A004799E6D813F","user_header":"https://static001.geekbang.org/account/avatar/00/11/fc/06/6cc5d4d5.jpg","comment_is_top":false,"comment_ctime":1541990617,"is_pvip":false,"replies":[{"id":"13732","content":"好问题。你可以想想，这里是不是需要“可靠”呢？","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1542000504,"ip_address":"","comment_id":38216,"utype":1}],"discussion_count":12,"race_medal":0,"score":"35901728985","product_id":100015201,"comment_content":"为什么要使用UDP呢，UDP不是不可靠的吗","like_count":8,"discussions":[{"author":{"id":1587282,"avatar":"https://static001.geekbang.org/account/avatar/00/18/38/52/526c10f9.jpg","nickname":"阿七","note":"","ucode":"B14B05BD0EB78A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":281623,"discussion_content":"1、不需要可靠。因为这个udp里面包裹的是tcp的内容，收发双端如果发现丢包，还是会重传的。\n2、局域网环境下，可靠性有一定保障，不会因为使用了udp造成频繁丢包。\n3、udp开销小。","likes_number":17,"is_delete":false,"is_hidden":false,"ctime":1591779287,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1029436,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg","nickname":"艺超(鲁鸣)","note":"","ucode":"7F749FA543E0F1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1587282,"avatar":"https://static001.geekbang.org/account/avatar/00/18/38/52/526c10f9.jpg","nickname":"阿七","note":"","ucode":"B14B05BD0EB78A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295304,"discussion_content":"请教一下，udp里面包裹的是tcp的内容，这个怎么理解呢？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1596160341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":281623,"ip_address":""},"score":295304,"extra":""},{"author":{"id":1186807,"avatar":"https://static001.geekbang.org/account/avatar/00/12/1b/f7/45e8b64a.jpg","nickname":"Fire","note":"","ucode":"4A2C50B77EDB2C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1029436,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg","nickname":"艺超(鲁鸣)","note":"","ucode":"7F749FA543E0F1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342968,"discussion_content":"也不一定是tcp，这里相当于是用udp封装网络包模拟三层路由选路，对容器来说是可以把这个udp隧道当成三层ip包，ip包不保证到达，这一点和udp包的特性完全吻合。基于这个模拟的ip规则，容器可以发送多种上层协议，比如tcp，udp。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1610888289,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":295304,"ip_address":""},"score":342968,"extra":""},{"author":{"id":1237070,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e0/4e/c266bdb4.jpg","nickname":"[小狗]","note":"","ucode":"090AEAC8A86134","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1029436,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg","nickname":"艺超(鲁鸣)","note":"","ucode":"7F749FA543E0F1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349920,"discussion_content":"你为什么要通信呢？ 不是为了应用吗？难道就是ping吗？ 他的意思是前期的封装都是为了一个运输的载体做的规则，真正要达到的目的是body里面的内容可以被对端进行解帧识别，转发路由找到最终的宿主，进行应用层操作","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613629904,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":295304,"ip_address":""},"score":349920,"extra":""}]},{"author":{"id":1158795,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ae/8b/43ce01ca.jpg","nickname":"ezekiel","note":"","ucode":"AB4AB6FA8612D8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342641,"discussion_content":"因为在内网，网络环境比较好。而且可靠性保证可以在flannel内保证","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1610761455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1172019,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e2/33/3ca366bf.jpg","nickname":"寻找乌托邦","note":"","ucode":"12143F0FAAAF2B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18226,"discussion_content":"UDP开销小，如果洪泛没结果，可以再次发。而且都是局域网，网络可靠性有保证。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1569033951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428643,"discussion_content":"好问题。你可以想想，这里是不是需要“可靠”呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1542000504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1175140,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ee/64/55adb692.jpg","nickname":" 海大","note":"","ucode":"03D1013FBE6047","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347331,"discussion_content":"网络可靠性决定于数据内部tcp保证，udp无需建立连接 占用资源","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612195569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2334257,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/4fZ9thib248ZkR1N3Eekeyb8N1V1Ud0uePctlI4VQUibPSmEZvgoP0VYl6IsVHJc7ZMiczQMtU76y6E6ag1zNAK4Q/132","nickname":"Geek_336577","note":"","ucode":"4826355EBA4950","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576452,"discussion_content":"应用层使用的TCP协议，可以保证","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655558194,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1290469,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Um0fKCDsGBRStZBF1M4HLPSq8jiancnNoYKiaYyYldFX0NObkyUFmnVKTgjm6Y7wUiaCQ3Vm9Ic213l65kJfUzq4w/132","nickname":"Geek_c92584","note":"","ucode":"D9DA02DA718977","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377744,"discussion_content":"和IP一样，尽最大努力传送就好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622803715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139121,"avatar":"https://static001.geekbang.org/account/avatar/00/11/61/b1/1261c177.jpg","nickname":"胖胖虎","note":"","ucode":"9CA8F99CC82944","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342217,"discussion_content":"我觉得还有一点，如果使用TCP协议的话，本身是需要建立连接的，随之而来的是TCP协议相关的一系列网络相关的控制，比较复杂。宿主机之间通信实际上只需要把数据包投递过去就可以了，没有必要再加上这么一层控制。相关具体应用的控制在封装内的协议已经做过了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610616467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1042891,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/e9/cb/cbc3ca53.jpg","nickname":"钱多多","note":"","ucode":"1D8E525B37283E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":201713,"discussion_content":"模拟 IP","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583829363,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55819,"user_name":"divfor","can_delete":false,"product_type":"c1","uid":1000315,"ip_address":"","ucode":"3B14C74252741D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/43/7b/0c7f8fbe.jpg","comment_is_top":false,"comment_ctime":1546315515,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31611086587","product_id":100015201,"comment_content":"讲隧道模式不提mtu处理，是不是缺了什么","like_count":7},{"had_liked":false,"id":37319,"user_name":"程燕华","can_delete":false,"product_type":"c1","uid":1105759,"ip_address":"","ucode":"7BF6821D186E23","user_header":"https://static001.geekbang.org/account/avatar/00/10/df/5f/dabab90b.jpg","comment_is_top":false,"comment_ctime":1541550587,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27311354363","product_id":100015201,"comment_content":"各个node会将自己的vtep信息上报给apiserver，apiserver将信息同步给各个节点的flanneld，flanneld通过netlink下发，完成信息的同步","like_count":6},{"had_liked":false,"id":69978,"user_name":"Rain","can_delete":false,"product_type":"c1","uid":1175329,"ip_address":"","ucode":"603DFFAC6A3755","user_header":"https://static001.geekbang.org/account/avatar/00/11/ef/21/69c181b8.jpg","comment_is_top":false,"comment_ctime":1550923893,"is_pvip":false,"discussion_count":10,"race_medal":0,"score":"23025760373","product_id":100015201,"comment_content":"抓包分析了下，确实如老师所描述，外部数据帧的源和目的MAC地址分别为宿主机网卡的MAC地址，外部IP头的源和目的地址分别为宿主机的IP地址，内部数据帧中的源和目的MAC地址分别为VTEP设备的MAC地址，内部IP头的源和目的地址分别为容器的IP地址。但是有个问题，做了个测试，在容器里面arping另一个宿主机上的容器地址，却得不到回应，这是为什么？广播地址不会被封装出去吗？","like_count":5,"discussions":[{"author":{"id":1162382,"avatar":"","nickname":"神灯","note":"","ucode":"615A1404E157E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":21323,"discussion_content":"我抓包的情况有所不同，我抓包显示外层数据帧的源目mac地址分别是宿主机的源目mac地址，源目ip地址分别是宿主机的源目ip地址。内层数据包的源目mac地址是flannel的源目mac地址，但是源IP是源flannel的地址，目的IP地址是目的容器的IP，这里为什么源IP会变成flannel的IP？是配置有问题还是哪里的问题？哪位老师帮忙分析下","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569467604,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2848426,"avatar":"","nickname":"Geek_7b826d","note":"","ucode":"0602900CB534A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1162382,"avatar":"","nickname":"神灯","note":"","ucode":"615A1404E157E2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562476,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649834120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":21323,"ip_address":""},"score":562476,"extra":""}]},{"author":{"id":1172019,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e2/33/3ca366bf.jpg","nickname":"寻找乌托邦","note":"","ucode":"12143F0FAAAF2B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18221,"discussion_content":"可能是Vxlan的隧道内部做了广播抑制。但是有个疑问，二层通信如何过去容器MAC","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569033735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1446375,"avatar":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","nickname":"book尾汁","note":"","ucode":"AE2B8DFC643ACC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1172019,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e2/33/3ca366bf.jpg","nickname":"寻找乌托邦","note":"","ucode":"12143F0FAAAF2B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":189330,"discussion_content":"这个有了容器的ip地址，会根据路由表转发到网桥，网桥在根据自己维护的路由表选择对应的vir接口进行转发就到容器了吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582870276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":18221,"ip_address":""},"score":189330,"extra":""}]},{"author":{"id":1412891,"avatar":"","nickname":"思维决定未来","note":"","ucode":"88CC245B3C6E2D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3971,"discussion_content":"VETP设备的MAC地址不就是宿主机的MAC地址吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1565012260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1566413,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e6/cd/bf5e928c.jpg","nickname":"小太阳","note":"","ucode":"80FD4A871ABFAD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1412891,"avatar":"","nickname":"思维决定未来","note":"","ucode":"88CC245B3C6E2D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4776,"discussion_content":"不是。宿主机上可以有多个vtep","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1565712278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":3971,"ip_address":""},"score":4776,"extra":""}]},{"author":{"id":2032032,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/01/a0/07ca2bd2.jpg","nickname":"一路顺风","note":"","ucode":"D46B7F92D65189","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":355766,"discussion_content":"请问封装的udp是通过什么端口发送和接收呢，这个端口是固定的吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615474140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1057843,"avatar":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","nickname":"阿甘","note":"","ucode":"BC93175B70E05D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2032032,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/01/a0/07ca2bd2.jpg","nickname":"一路顺风","note":"","ucode":"D46B7F92D65189","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540500,"discussion_content":"互联网号码分配局（Internet Assigned Numbers Authority，IANA）也专门分配了 4789 作为 VTEP 设备的 UDP 端口（以前 Linux VXLAN 用的默认端口是 8472，目前这两个端口在许多场景中仍有并存的情况）。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640070305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":355766,"ip_address":""},"score":540500,"extra":""}]},{"author":{"id":2054990,"avatar":"","nickname":"海柔儿稀罕","note":"","ucode":"CBEEBEA2CAE8A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290890,"discussion_content":"不错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594633666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2054990,"avatar":"","nickname":"海柔儿稀罕","note":"","ucode":"CBEEBEA2CAE8A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290889,"discussion_content":"不错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594633646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261803,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1605528026,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18785397210","product_id":100015201,"comment_content":"容器“跨主通信”的三种主流实现方法：UDP、host-gw、VXLAN，其中：<br>（1）UDP：最直接、最容易理解、性能最差的实现方式 。 比如Flannel的实现中，flanneld将不同宿主机划分成不同的子网，不同的容器所在的宿主机不同则子网也不同，这些&lt;宿主机,子网&gt;信息存储在etcd中。当容器需要“跨主通信”时， flanneld进程会将发出端的IP包进行UDP封装，然后发送到目的端的宿主机上，目的端的宿主机的flanneld再进行解封装发送给对应的容器来使用。<br><br>（2）VXLAN：  Virtual Extensible LAN（虚拟可扩展局域网），通过VXLAN技术在内核态上实现了UDP方式的封装和解封装，提高了性能，即用VTEP实现了flanneld进程的功能<br>","like_count":4},{"had_liked":false,"id":235310,"user_name":"海柔儿稀罕","can_delete":false,"product_type":"c1","uid":2054990,"ip_address":"","ucode":"CBEEBEA2CAE8A7","user_header":"","comment_is_top":false,"comment_ctime":1594969401,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18774838585","product_id":100015201,"comment_content":"搞开发的说网络，很简单的网络道理讲的啰里啰嗦，让搞网络的看的费劲。两件事数据平面和控制平面以及数据包在每个转发阶段是如何封装解封装的需要查什么表。<br>还有K8S属于PAAS就不应该有多租户说法，多租户是IAAS层面的。K8S从底层网络层面就做不到IAAS层面的租户地址空间的隔离和解决地址重叠。","like_count":4,"discussions":[{"author":{"id":1095819,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b8/8b/68555cbf.jpg","nickname":"Geek_122dd9","note":"","ucode":"12BDEF1FC06633","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586206,"discussion_content":"不是每个人都跟你一样熟悉网络","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662033039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153066,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1574151535,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18754020719","product_id":100015201,"comment_content":"关键是那个fdb，如果fdb能够记录容器mac和宿主机ip的对应关系，那就可以保证二层连通性","like_count":4},{"had_liked":false,"id":37306,"user_name":"xianhai","can_delete":false,"product_type":"c1","uid":1073505,"ip_address":"","ucode":"906578663CEB3E","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/61/677e8f92.jpg","comment_is_top":false,"comment_ctime":1541545099,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14426446987","product_id":100015201,"comment_content":"etcdctl ls 这个命令不存在啊。<br>我是用这个命令安装etcdctl的：go get github.com&#47;coreos&#47;etcd&#47;cmd&#47;etcdctl<br><br>极客时间版权所有: https:&#47;&#47;time.geekbang.org&#47;column&#47;article&#47;65287","like_count":3},{"had_liked":false,"id":325927,"user_name":"我来烤烤你","can_delete":false,"product_type":"c1","uid":2268886,"ip_address":"","ucode":"C0444817B6B16F","user_header":"https://static001.geekbang.org/account/avatar/00/22/9e/d6/4b07f8b5.jpg","comment_is_top":false,"comment_ctime":1639236900,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10229171492","product_id":100015201,"comment_content":"VXLAN的实现过程为什么一定要套一个UDP在中间？？？非常费解","like_count":2,"discussions":[{"author":{"id":1264563,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4b/b3/01d64240.jpg","nickname":"龟龟🐢","note":"","ucode":"C53C0D15C9EA83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574580,"discussion_content":"反过来想可能就明白了，如果没有这个UDP header，你去实现vxlan怎么封装这个ether frame","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654159758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293631,"user_name":"罗峰","can_delete":false,"product_type":"c1","uid":1218501,"ip_address":"","ucode":"5F3D6AF8F28322","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/c5/84491beb.jpg","comment_is_top":false,"comment_ctime":1621472561,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10211407153","product_id":100015201,"comment_content":"确实图多术语少，基础差的人也能明白个大概","like_count":2},{"had_liked":false,"id":284098,"user_name":"我是谁","can_delete":false,"product_type":"c1","uid":1131907,"ip_address":"","ucode":"AE3996142811F4","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/83/93d389ba.jpg","comment_is_top":false,"comment_ctime":1616063291,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"10205997883","product_id":100015201,"comment_content":"老师请教2个问题哈，<br>1. vxlan协议中，内层mac头应该是源虚拟机和目标虚拟机的mac地址，外层ip头是源和目的端vtep设备的ip，外层mac头是源和目的端vtep设备的mac地址。为什么flannel的vxlan方案中不是这个样子，是flanneld对flannel.1设备封包解包进行了调整吗？这个地方有很大疑虑<br>2. flannel.1这个vtep设备封包是会封装到外层的mac头才算封装完毕吗？还是只是封装到添加vxlan头，其他的交由内核完成的？因为我看文章介绍，flannel.1解包时从内层数据包开始解析的。所以这一块也很迷惑。","like_count":2,"discussions":[{"author":{"id":2848426,"avatar":"","nickname":"Geek_7b826d","note":"","ucode":"0602900CB534A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562979,"discussion_content":"这个问题可以回到一下吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649919441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2848426,"avatar":"","nickname":"Geek_7b826d","note":"","ucode":"0602900CB534A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562477,"discussion_content":"同问在flannel上抓包为啥抓不到vxlan的包，只在宿主机上抓包抓到了vxlan的包","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649834246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135299,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKzqiaZnBw2myRWY802u48Rw3W2zDtKoFQ6vN63m4FdyjibM21FfaOYe8MbMpemUdxXJeQH6fRdVbZA/132","nickname":"kissingers","note":"","ucode":"615151808CF628","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379714,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624090801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2449777,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132","nickname":"types","note":"","ucode":"8B50927EF1804F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360213,"discussion_content":"同样的问题，vxlan中outer source ip/mac是自身vtep设备的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616390760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62168,"user_name":"凌","can_delete":false,"product_type":"c1","uid":1257995,"ip_address":"","ucode":"41369B360C794F","user_header":"https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg","comment_is_top":false,"comment_ctime":1547966927,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10137901519","product_id":100015201,"comment_content":"flannel的基础是不同node分子网这是三层的概念，二层显然无法满足","like_count":2},{"had_liked":false,"id":43113,"user_name":"jssfy","can_delete":false,"product_type":"c1","uid":1137238,"ip_address":"","ucode":"F16353CFE607B7","user_header":"https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg","comment_is_top":false,"comment_ctime":1543170176,"is_pvip":false,"replies":[{"id":"15415","content":"主机上的agent要负责维护这些信息","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1543192223,"ip_address":"","comment_id":43113,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10133104768","product_id":100015201,"comment_content":"请问bridge fdb看到的其它节点vtep的对应关系vtep是各节点主动注册的？","like_count":2,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":430301,"discussion_content":"主机上的agent要负责维护这些信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543192223,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":41522,"user_name":"小谢同学","can_delete":false,"product_type":"c1","uid":1032544,"ip_address":"","ucode":"E809E6BC470631","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c1/60/fc3689d0.jpg","comment_is_top":false,"comment_ctime":1542800183,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132734775","product_id":100015201,"comment_content":"请问为什么vxlan一定要使用udp建立连接呢？","like_count":2},{"had_liked":false,"id":37389,"user_name":"虎虎❤️","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1541565437,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10131500029","product_id":100015201,"comment_content":"基于udp backend的flannel不能实现2层连通，flannel0是tun设备，工作在三层网络。<br><br>基于vxlan backend的flannel我认为可以实现2层连通。vxlan封装转发的是二层数据帧，整个flannel网络里只有交换设备，设备都在一个广播域里。所以即使arp表里没有记录也可以通过广播实现2层连通。flannel.1可以通过手动维护fdb表（记录目的容器的mac地址和其所在主机的映射），或者在vtep分组中进行广播，来找到目的VTEP，进而转发到目的容器。","like_count":2},{"had_liked":false,"id":37355,"user_name":"Acter","can_delete":false,"product_type":"c1","uid":1082561,"ip_address":"","ucode":"EF747BEAD2A797","user_header":"https://static001.geekbang.org/account/avatar/00/10/84/c1/dfcad82a.jpg","comment_is_top":false,"comment_ctime":1541554650,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"10131489242","product_id":100015201,"comment_content":"文中所述“container-1里的进程发起的IP包，根据默认路由规则，通过容器的网关进入docker0网桥，从而出现在宿主机上。”请问老师“容器的网关”是谁？","like_count":2,"discussions":[{"author":{"id":1158275,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ac/83/2f143a22.jpg","nickname":"雪粮","note":"","ucode":"363A83AC7CE8B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":26745,"discussion_content":"容器的网关就是docker0桥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570616571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318011,"user_name":"陈斯佳","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1635123285,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5930090581","product_id":100015201,"comment_content":"第三十三课:深入解析容器跨主机网络<br>在Linux中，TUN设备是一种工作在三层（Network Layer）的虚拟网络设备，它的功能是在操作系统内核和用户应用程序之间传递IP包。<br><br>Funnel的子网和宿主机的对应关系保存在etcd中<br><br>Funnel UDP 模式提供的其实是一个三层的Overlay网络，即：它首先对发出端的IP包进行UDP封装，然后在接收端进行解封装拿到原始的IP包，进而把这个IP包转发给目标容器。<br><br>VXLAN的覆盖网络设计思想是：在现有的三层网络之上覆盖一层虚拟的、由内核VXLAN模块负责维护的二层网络，使得连接在这个VXLAN二层网络上的“主机”之间，可以像在同一个LAN局域网里那样自由的通信。","like_count":1},{"had_liked":false,"id":303290,"user_name":"Ilovek8s","can_delete":false,"product_type":"c1","uid":1542450,"ip_address":"","ucode":"64DF0F7D0CF0B0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/a8PMLmCTCBa40j7JIy3d8LsdbW5hne7lkk9KOGQuiaeVk4cn06KWwlP3ic69BsQLpNFtRTjRdUM2ySDBAv1MOFfA/132","comment_is_top":false,"comment_ctime":1626703650,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5921670946","product_id":100015201,"comment_content":"你认为 Flannel 能负责保证二层网络（MAC 地址）的连通性吗？为什么呢？<br>答：不能，因为最新版的flannel已经不依赖L3 MISS事件和ARP学习，flannel启动时就会在每个节点将vtep与mac对应起来，而封装起来的内部数据帧对宿主机之间的通信是没有意义的，必须再封装一层节点之间的包头，但这时候的外层包头信息又不能保证容器之间的二层连通信","like_count":1},{"had_liked":false,"id":221202,"user_name":"superkong","can_delete":false,"product_type":"c1","uid":1066996,"ip_address":"","ucode":"D43F0D6B236B7E","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/f4/a7389cd3.jpg","comment_is_top":false,"comment_ctime":1590425433,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5885392729","product_id":100015201,"comment_content":"非常精彩！","like_count":1},{"had_liked":false,"id":149376,"user_name":"奶爸熊大","can_delete":false,"product_type":"c1","uid":1518372,"ip_address":"","ucode":"8C4BF29560B218","user_header":"https://static001.geekbang.org/account/avatar/00/17/2b/24/1ad936e6.jpg","comment_is_top":false,"comment_ctime":1573204680,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5868171976","product_id":100015201,"comment_content":"您好，calico 节点能否与节点间路由器建立 bdp 连接，这样就省去了ipip模式的性能损耗。","like_count":1},{"had_liked":false,"id":114328,"user_name":"iGeneral","can_delete":false,"product_type":"c1","uid":1274314,"ip_address":"","ucode":"F7EA381C34955E","user_header":"https://static001.geekbang.org/account/avatar/00/13/71/ca/87688ff9.jpg","comment_is_top":false,"comment_ctime":1563275124,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5858242420","product_id":100015201,"comment_content":"想起来原来做毕业设计的时候，跨主机直接容器的通信好像直接用的etcd服务发现，直接吧docker的网络暴露出去，然后依赖etcd来做的跨主机通信。 其实还可以","like_count":1},{"had_liked":false,"id":73742,"user_name":"彦","can_delete":false,"product_type":"c1","uid":1125048,"ip_address":"","ucode":"13EE4093C488A5","user_header":"https://static001.geekbang.org/account/avatar/00/11/2a/b8/edbafb82.jpg","comment_is_top":false,"comment_ctime":1551967139,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5846934435","product_id":100015201,"comment_content":"请问，某个节点上flannel进程启动后，会发送相关状态到其他节点---那么，这个共享的配置信息是不是经过Etcd处理的？FDB这个转发数据库是不是也是在这个时机形成的？ 这样 在打上外层标签时就这直接从内核态进行操作，从而效率比较高。","like_count":1},{"had_liked":false,"id":44284,"user_name":"周娄子","can_delete":false,"product_type":"c1","uid":1228039,"ip_address":"","ucode":"18A1E6926C095A","user_header":"https://static001.geekbang.org/account/avatar/00/12/bd/07/bf8c31fb.jpg","comment_is_top":false,"comment_ctime":1543400149,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5838367445","product_id":100015201,"comment_content":"container veth设备都是attach在bridge上的, 应该无法保证二层网络（MAC 地址）的连通性<br>","like_count":1},{"had_liked":false,"id":37994,"user_name":"blackpiglet","can_delete":false,"product_type":"c1","uid":1032928,"ip_address":"","ucode":"58AA8329C91767","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg","comment_is_top":false,"comment_ctime":1541844697,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5836811993","product_id":100015201,"comment_content":"思考题：Flannel 能负责保证二层网络（MAC 地址）的连通性吗？<br><br>回答：我觉得不能，Flannel 的工作模式都是根据 IP 来判断下一条跳转到哪个网络设备上，是基于三层做路由。如果要基于 MAC 做寻址的话，Flannel 无法知道其他主机上的容器的 MAC 地址，所以无法转发。","like_count":1,"discussions":[{"author":{"id":1584072,"avatar":"https://static001.geekbang.org/account/avatar/00/18/2b/c8/3692a09c.jpg","nickname":"刘文","note":"","ucode":"DCA71276CA2C49","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414157,"discussion_content":"应该是的，基于mac地址只能转发到宿主机，无法直接到达虚拟设备","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636679347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37865,"user_name":"Len","can_delete":false,"product_type":"c1","uid":1022767,"ip_address":"","ucode":"53C623CE17973F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9b/2f/b7a3625e.jpg","comment_is_top":false,"comment_ctime":1541755459,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5836722755","product_id":100015201,"comment_content":"在同一个网络里，添加容器网络和各主机之间的映射，能达到连通性，不在一个网络里应该没发做到二层网络的连通性吧？不知道回答的对不对。","like_count":1},{"had_liked":false,"id":37617,"user_name":"艾斯Z艾穆","can_delete":false,"product_type":"c1","uid":1107498,"ip_address":"","ucode":"DAA7686EC80430","user_header":"https://static001.geekbang.org/account/avatar/00/10/e6/2a/2ac18fb8.jpg","comment_is_top":false,"comment_ctime":1541652844,"is_pvip":false,"replies":[{"id":"13575","content":"看service部分讲解","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541719345,"ip_address":"","comment_id":37617,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5836620140","product_id":100015201,"comment_content":"您好，我遇到一个问题<br>我在一个被service选中的app里访问不了这个service的port可以ping通，用pod的ip可以访问到端口<br>别的pod可以访问到service的port<br>这个pod也可以访问别的service的port<br>kube-proxy用的模式是ipvs","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428427,"discussion_content":"看service部分讲解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541719345,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37520,"user_name":"月亮上看星星","can_delete":false,"product_type":"c1","uid":1255514,"ip_address":"","ucode":"3143782B54D388","user_header":"https://static001.geekbang.org/account/avatar/00/13/28/5a/dc141082.jpg","comment_is_top":false,"comment_ctime":1541635358,"is_pvip":false,"replies":[{"id":"13578","content":"镜像得给容器做rootfs。你理解一下对一个进程来说，rootfs跟普通目录的区别。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541719531,"ip_address":"","comment_id":37520,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5836602654","product_id":100015201,"comment_content":"磊哥，问你个docker的问题，镜像load到主机上，镜像里的文件是不是存储在主机的某个目录上，起来的容器访问这个文件，实际上就是访问主机上的这个文件？如果是这样的话，创建个数据卷放这个文件，让容器去访问这个数据卷里的这个文件，其实也是访问主机某个目录里的文件，不知道这两种方式有什么区别呢？请磊哥指导下呢","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428379,"discussion_content":"镜像得给容器做rootfs。你理解一下对一个进程来说，rootfs跟普通目录的区别。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541719531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360097,"user_name":"梦回汉唐","can_delete":false,"product_type":"c1","uid":1321581,"ip_address":"四川","ucode":"9C66E35165F813","user_header":"https://static001.geekbang.org/account/avatar/00/14/2a/6d/0e436c1c.jpg","comment_is_top":false,"comment_ctime":1666173461,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666173461","product_id":100015201,"comment_content":"对于TUN设备的描述太精髓了，解决了我很多年的困惑。我之前一直不能明白从容器流到宿主机的包为什么可以走两次路由表，现在可算是明白了。","like_count":0},{"had_liked":false,"id":359347,"user_name":"田小麦","can_delete":false,"product_type":"c1","uid":1648999,"ip_address":"北京","ucode":"4C10997F6173ED","user_header":"https://static001.geekbang.org/account/avatar/00/19/29/67/fc61a741.jpg","comment_is_top":false,"comment_ctime":1665460786,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1665460786","product_id":100015201,"comment_content":"只有很深的功底，才能用这么直观的文字，写出易于理解的干货！！！","like_count":0},{"had_liked":false,"id":358461,"user_name":"AB","can_delete":false,"product_type":"c1","uid":1202470,"ip_address":"浙江","ucode":"0BB62078D5D1CA","user_header":"https://static001.geekbang.org/account/avatar/00/12/59/26/e9594316.jpg","comment_is_top":false,"comment_ctime":1664333815,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1664333815","product_id":100015201,"comment_content":"flanneld工作在用户空间，封装UDP包在内核空间，flanneld传输到eth0中间是不是还有一个步骤封装和解封","like_count":0},{"had_liked":false,"id":354892,"user_name":"Geek_1cc6d1","can_delete":false,"product_type":"c1","uid":1850248,"ip_address":"北京","ucode":"3E083616DD0742","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erZCyXaP2gbxwFHxvtnyaaF2Pyy5KkSMsk9kh7SJl8icp1CD6wicb6VJibiblGibbpDo6IuHrdST6AnWQg/132","comment_is_top":false,"comment_ctime":1660870123,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660870123","product_id":100015201,"comment_content":"主机网通不就可以了么，为什么要多这么一层虚拟网络？","like_count":0},{"had_liked":false,"id":348741,"user_name":"雁南飞","can_delete":false,"product_type":"c1","uid":1427499,"ip_address":"","ucode":"8CA46975D6EEA1","user_header":"https://static001.geekbang.org/account/avatar/00/15/c8/2b/169ad3d0.jpg","comment_is_top":false,"comment_ctime":1655363740,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655363740","product_id":100015201,"comment_content":"太复杂了, 对网络知识薄弱的我是个重锤","like_count":0},{"had_liked":false,"id":343589,"user_name":"窝窝头","can_delete":false,"product_type":"c1","uid":1063866,"ip_address":"","ucode":"5C2635ED6484F8","user_header":"https://static001.geekbang.org/account/avatar/00/10/3b/ba/3b30dcde.jpg","comment_is_top":false,"comment_ctime":1650942606,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650942606","product_id":100015201,"comment_content":"flannel查找目标ip对应的mac地址及目的主机的ip其实是通过fdb查找出来的，而fdb是由flannel维护的，所以这块是否可靠还是看flannel对fdb维护的模式吧，如果只是node2加入时注册退出时删除而没有进行状态维护的话那就不可靠了","like_count":0},{"had_liked":false,"id":342142,"user_name":"勤奋的辣牛肉","can_delete":false,"product_type":"c1","uid":1676412,"ip_address":"","ucode":"D48CC31A8D44FC","user_header":"https://static001.geekbang.org/account/avatar/00/19/94/7c/70bf584f.jpg","comment_is_top":false,"comment_ctime":1650034678,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650034678","product_id":100015201,"comment_content":"VXLAN的实现过程为什么一定要套一个UDP在中间？","like_count":0},{"had_liked":false,"id":341925,"user_name":"Geek_7b826d","can_delete":false,"product_type":"c1","uid":2848426,"ip_address":"","ucode":"0602900CB534A6","user_header":"","comment_is_top":false,"comment_ctime":1649919375,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649919375","product_id":100015201,"comment_content":"按文中讲到的在fannel.1 上抓包可以抓到vxlan的报文吗？ ","like_count":0},{"had_liked":false,"id":340378,"user_name":"Eason Lau","can_delete":false,"product_type":"c1","uid":1035123,"ip_address":"","ucode":"51C987C477F1F0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cb/73/9eb7c992.jpg","comment_is_top":false,"comment_ctime":1648784687,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648784687","product_id":100015201,"comment_content":"看懂了不同宿主机传输数据的原理","like_count":0},{"had_liked":false,"id":335275,"user_name":"the outsider","can_delete":false,"product_type":"c1","uid":1665646,"ip_address":"","ucode":"3209715E5AD7A4","user_header":"https://static001.geekbang.org/account/avatar/00/19/6a/6e/38738a57.jpg","comment_is_top":false,"comment_ctime":1645436430,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645436430","product_id":100015201,"comment_content":"老师，请教个问题，我们生产环境已经部署好的集群（v1.19），两个pod之间，突然之间无法hosts解析（svc.ns），两个node之间其他的pod能通过（svc.ns）通信。我们没找到原因，老师能麻烦帮忙分析一下吗？感谢老师","like_count":0},{"had_liked":false,"id":330709,"user_name":"cosz3","can_delete":false,"product_type":"c1","uid":1218665,"ip_address":"","ucode":"B9023D4A088CF2","user_header":"https://static001.geekbang.org/account/avatar/00/12/98/69/5a1c6620.jpg","comment_is_top":false,"comment_ctime":1642127878,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642127878","product_id":100015201,"comment_content":"我用 kubeadmn 部署后安装了 cni Flannel，使用的是 cni0 没有 使用 docker0， kubeadmn 安装时候怎么指定使用 docker0 呢？","like_count":0},{"had_liked":false,"id":325039,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1638784142,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638784142","product_id":100015201,"comment_content":"计算机网络   TCP&#47;IP协议卷一","like_count":0},{"had_liked":false,"id":316625,"user_name":"杨","can_delete":false,"product_type":"c1","uid":1971269,"ip_address":"","ucode":"7EFEFE285975C6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oltLEqTrmHm2aJP99BK6tHu5h7hp4aj08wR5Wt6H31iadFduDAVvjYKmhQ2nvGbLV3lkVdiat2GRasgWXoJeTibUg/132","comment_is_top":false,"comment_ctime":1634460529,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634460529","product_id":100015201,"comment_content":"flannel vtep有个网络包发送图就好了  就像那个udp模式","like_count":0},{"had_liked":false,"id":315767,"user_name":"言午木杉","can_delete":false,"product_type":"c1","uid":1201009,"ip_address":"","ucode":"300BEDC1B07DF1","user_header":"https://static001.geekbang.org/account/avatar/00/12/53/71/a4e9f20e.jpg","comment_is_top":false,"comment_ctime":1633970975,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633970975","product_id":100015201,"comment_content":"看完感觉上了一节计算机网络课程，老师讲的非常好，对不同宿主机的通信有了比较详细的了解，之前只是知道docker不同数组是依靠overlay来实现的，但是具体的就不知道了。","like_count":0},{"had_liked":false,"id":307122,"user_name":"招耳","can_delete":false,"product_type":"c1","uid":1001825,"ip_address":"","ucode":"D163E1A6377CF6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/61/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1628872383,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628872383","product_id":100015201,"comment_content":"老师，node1上的这条路由是谁创建的呢？<br>100.96.0.0&#47;16 dev flannel0  proto kernel  scope link  src 100.96.1.0","like_count":0},{"had_liked":false,"id":306336,"user_name":"csw354","can_delete":false,"product_type":"c1","uid":2648492,"ip_address":"","ucode":"60F2065B574B34","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Bb0c1RZVKHXhoCWYZK4I8aXMUHib1iaPia4P9v6zY5bDRBib4b2sfoMkaAPajm4fch9d3EMmSia2wmcglD057aflGkw/132","comment_is_top":false,"comment_ctime":1628501378,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628501378","product_id":100015201,"comment_content":"那么，与前面 UDP 模式的流程类似，当 container-1 发出请求之后，这个目的地址是 10.1.16.3 的 IP 包，会先出现在 docker0 网桥，然后被路由到本机 flannel.1 设备进行处理。<br>如果是“被路由”，那本来的二层包不就会被剥离以太网报头，只有三层IP报文，那vtep封装的不也变成三层IP报文，而不是二层以太网报文吗","like_count":0},{"had_liked":false,"id":305634,"user_name":"Demon.Lee","can_delete":false,"product_type":"c1","uid":1052859,"ip_address":"","ucode":"7F0E5493A8E345","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","comment_is_top":false,"comment_ctime":1628079460,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1628079460","product_id":100015201,"comment_content":"请教老师和小伙伴一个问题。<br>一个简单的 k8s 集群（1个 master ，2个 worker） ，master 的 ip 为 10.5.xx.xx，2 个 worker 的 ip 为 192.168.100.xx。<br><br>有一个 pod 暴露了一个 https 端口（比如443），然后 通过 curl https:&#47;&#47;xxx:443&#47;apis&#47;xxx 访问（调用是会带上token），如果这个 pod 不在 master 节点上，那么在 master 节点上发起请求后一直没反应，直到超时。而在 2 个 worker 节点发起请求，则可以正常返回。<br>如果将这个 pod 强制调度到 master 节点上，那么在 master 节点上发起请求，可以正常返回，但在  2 个 worker 节点发起请求，会超时无响应。<br><br>导致这个问题的原因会是什么呢","like_count":0},{"had_liked":false,"id":302692,"user_name":"PeiHongbing","can_delete":false,"product_type":"c1","uid":1635932,"ip_address":"","ucode":"F115AD8740B0DC","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKSEVQdSoW2SwDic2U3uIibsa1bH3qSSzCvYTN5xHC5ppGDS2DBxL1KcbuxZ6Ez6kyOGj1F4toiaiazBA/132","comment_is_top":false,"comment_ctime":1626335898,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626335898","product_id":100015201,"comment_content":"请问怎么搭建实验环境呢？","like_count":0},{"had_liked":false,"id":302111,"user_name":"郑亚刚","can_delete":false,"product_type":"c1","uid":1983303,"ip_address":"","ucode":"F4CD42D82551AF","user_header":"https://static001.geekbang.org/account/avatar/00/1e/43/47/2bc320bf.jpg","comment_is_top":false,"comment_ctime":1626085435,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626085435","product_id":100015201,"comment_content":"vxlan中的Outer UDP header是vxlan协议规定的：<br>VXLAN头和原始以太帧一起作为UDP的数据。UDP头中，目的端口号（VXLAN Port）固定为4789，源端口号（UDP Src. Port）是原始以太帧通过哈希算法计算后的值。<br>是这样的吗？","like_count":0},{"had_liked":false,"id":299946,"user_name":"李健","can_delete":false,"product_type":"c1","uid":1297756,"ip_address":"","ucode":"5919D20D0A4489","user_header":"https://static001.geekbang.org/account/avatar/00/13/cd/5c/b31e126e.jpg","comment_is_top":false,"comment_ctime":1624932361,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1624932361","product_id":100015201,"comment_content":"最后问题:<br>抛开flannel，linux下vxlan+bridge技术可以实现二层互通，这也是openstack里实现租户隔离的一种方式<br><br>但具体到flannel, flannel里用vxlan只是实现了三层互通","like_count":0},{"had_liked":false,"id":294589,"user_name":"李青情意重","can_delete":false,"product_type":"c1","uid":2626238,"ip_address":"","ucode":"3F27F555C2C06D","user_header":"https://static001.geekbang.org/account/avatar/00/28/12/be/a12a7963.jpg","comment_is_top":false,"comment_ctime":1622011109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622011109","product_id":100015201,"comment_content":"希望老师解答下疑惑，我加了一个自启动任务，想在容器启动之后自启动一个脚本。但是每次都需要我在k8s的dashboard中选择pod的执行按钮，也就是exec进入容器中才会触发自启动任务。很疑惑","like_count":0},{"had_liked":false,"id":284608,"user_name":"姜尧","can_delete":false,"product_type":"c1","uid":2405411,"ip_address":"","ucode":"D813E046DD81E8","user_header":"https://static001.geekbang.org/account/avatar/00/24/b4/23/0e296758.jpg","comment_is_top":false,"comment_ctime":1616385781,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616385781","product_id":100015201,"comment_content":"咱们现在kubernetesVersion: 版本已经很高了，demonset这些都不支持了，<br>所以安装flannel的时候可以用下面这个<br>kubectl create -f https:&#47;&#47;raw.githubusercontent.com&#47;coreos&#47;flannel&#47;master&#47;Documentation&#47;kube-flannel.yml<br>","like_count":0},{"had_liked":false,"id":283113,"user_name":"我","can_delete":false,"product_type":"c1","uid":1228448,"ip_address":"","ucode":"CEB9CAA8A65930","user_header":"https://static001.geekbang.org/account/avatar/00/12/be/a0/af1725e1.jpg","comment_is_top":false,"comment_ctime":1615551613,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615551613","product_id":100015201,"comment_content":"容器网络 是不是会降低网络性能？转发几次 数据拷贝也多","like_count":0},{"had_liked":false,"id":258159,"user_name":"Denuth","can_delete":false,"product_type":"c1","uid":1284665,"ip_address":"","ucode":"E20A7E707155CD","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/39/82679f79.jpg","comment_is_top":false,"comment_ctime":1604315354,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604315354","product_id":100015201,"comment_content":"这个云的网络 可真是老母猪的皮 一层套一层","like_count":0},{"had_liked":false,"id":256031,"user_name":"猫不吃鱼","can_delete":false,"product_type":"c1","uid":1551837,"ip_address":"","ucode":"3A15C951912525","user_header":"https://static001.geekbang.org/account/avatar/00/17/ad/dd/2630314e.jpg","comment_is_top":false,"comment_ctime":1603509664,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603509664","product_id":100015201,"comment_content":"这个原理是不是有点像VPN的原理。通过点对点隧道协议实现一个大的虚拟局域网","like_count":0},{"had_liked":false,"id":250305,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1601018191,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601018191","product_id":100015201,"comment_content":"关于这个问题,flannel维护的必然是子网,也就是三层上的概念,想要直接打通二层的网路联通,那么就需要考虑不同宿主机之间容器如何知道彼此的MAC地址呢?可以参考VXLAN的解决方案,每一个VTEP都通过IGMP,加入一个组播组需要VTEP都挂载到一个组内,方便进行广播arp请求,从而打通二层网络","like_count":0},{"had_liked":false,"id":247000,"user_name":"静心","can_delete":false,"product_type":"c1","uid":1335457,"ip_address":"","ucode":"EB264FA6519FDA","user_header":"https://static001.geekbang.org/account/avatar/00/14/60/a1/8f003697.jpg","comment_is_top":false,"comment_ctime":1599554458,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1599554458","product_id":100015201,"comment_content":"老师的知识面不仅全面，而且还很有深度，也具有很强的体系结构。不难k8s讲的透彻，而且对于网络的知识也理解颇深。很荣幸遇到了这么好的老师。不过感觉，这个课程我要完全消化掉，可能需要3遍。","like_count":0},{"had_liked":false,"id":245961,"user_name":"大G来了呦","can_delete":false,"product_type":"c1","uid":1610260,"ip_address":"","ucode":"97711D9CCA73B0","user_header":"https://static001.geekbang.org/account/avatar/00/18/92/14/6ca50b3b.jpg","comment_is_top":false,"comment_ctime":1599121806,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599121806","product_id":100015201,"comment_content":"讲的真好！一遍听明白，厉害！","like_count":0},{"had_liked":false,"id":242381,"user_name":"冬冬","can_delete":false,"product_type":"c1","uid":1180054,"ip_address":"","ucode":"B673E6482B5C93","user_header":"https://static001.geekbang.org/account/avatar/00/12/01/96/afcb6174.jpg","comment_is_top":false,"comment_ctime":1597708658,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1597708658","product_id":100015201,"comment_content":"node跨主机通信引入了flannel组件，从node1请求node2在每个组件对请求包进行分发（docker0、flannel）,flannel包含子网 在node2地址在subnet范围内，则对请求包进行分发 最终达到node2上的container。<br>课后问题：我觉得不合适，mac地址为硬件地址 当与请求节点直连时 可通过mac实现，但当目的node不在subnet时，还是要需要rarp（地址逆解析）转换为ip 然后将数据包分发到目的node。 <br> ","like_count":0},{"had_liked":false,"id":241738,"user_name":"不啦不啦不","can_delete":false,"product_type":"c1","uid":1793080,"ip_address":"","ucode":"F538996E183F52","user_header":"https://static001.geekbang.org/account/avatar/00/1b/5c/38/9d7198b7.jpg","comment_is_top":false,"comment_ctime":1597405266,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597405266","product_id":100015201,"comment_content":"隧道画的太好看了哈哈","like_count":0},{"had_liked":false,"id":241441,"user_name":"明","can_delete":false,"product_type":"c1","uid":2108110,"ip_address":"","ucode":"57B974802AD79A","user_header":"https://static001.geekbang.org/account/avatar/00/20/2a/ce/fea443f7.jpg","comment_is_top":false,"comment_ctime":1597296602,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597296602","product_id":100015201,"comment_content":"&quot;为了方便叙述，接下来我会把 Node 1 和 Node 2 上的 flannel.1 设备分别称为“源 VTEP 设备”和“目的 VTEP 设备”。而这些 VTEP 设备之间，就需要想办法组成一个虚拟的二层网络，即：通过二层数据帧进行通信。&quot;<br>1、VTEP并不需要工作在二层网络，两个flannel.1也是用IP地址来找对端。2、不同NODE上的container，子网不同，那就是三层通信了。3、最后通过宿主机以UDP通信，那这个路由可达即可。 似乎原理上不需要，container之间也不会是二层网络？","like_count":0},{"had_liked":false,"id":234039,"user_name":"海盗船长","can_delete":false,"product_type":"c1","uid":1363634,"ip_address":"","ucode":"ECB28BA21A4113","user_header":"https://static001.geekbang.org/account/avatar/00/14/ce/b2/1f914527.jpg","comment_is_top":false,"comment_ctime":1594560326,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594560326","product_id":100015201,"comment_content":"是通过什么技术？在哪一步设置不同node上docker0的子网段的？","like_count":0},{"had_liked":false,"id":217048,"user_name":"Andy","can_delete":false,"product_type":"c1","uid":1119133,"ip_address":"","ucode":"4BCA899B8E4E85","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/9d/0ff43179.jpg","comment_is_top":false,"comment_ctime":1589412504,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1589412504","product_id":100015201,"comment_content":"之前学技术时，书上说udp性能差，是广播方式的通信。以后还会出现tcp的网络插件？","like_count":0,"discussions":[{"author":{"id":1145068,"avatar":"https://static001.geekbang.org/account/avatar/00/11/78/ec/f7f0d21a.jpg","nickname":"Dev-L","note":"","ucode":"485E940C3F17B9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292995,"discussion_content":"啥？不会看了假书吧？udp比tcp高效吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595407022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209844,"user_name":"lpf32","can_delete":false,"product_type":"c1","uid":1039717,"ip_address":"","ucode":"E1B127FDFF74BB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/dd/65/3b4a2930.jpg","comment_is_top":false,"comment_ctime":1587624204,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587624204","product_id":100015201,"comment_content":"虚拟二层网络的连通性依赖于node节点三层网络的联通性，自身并不能保证联通","like_count":0},{"had_liked":false,"id":209251,"user_name":"张三","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1587524003,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587524003","product_id":100015201,"comment_content":"学习了，精彩，顺便学习了OSI分层模型中每一层之间的连接。谢谢","like_count":0},{"had_liked":false,"id":198665,"user_name":"vincent","can_delete":false,"product_type":"c1","uid":1796234,"ip_address":"","ucode":"9FAD09D87C1E42","user_header":"","comment_is_top":false,"comment_ctime":1585462975,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585462975","product_id":100015201,"comment_content":"openstack的网络可以实现虚机网络的相互隔离，kubernetes是否有类似的机制可以实现","like_count":0},{"had_liked":false,"id":195937,"user_name":"那迦树","can_delete":false,"product_type":"c1","uid":1055625,"ip_address":"","ucode":"34519C1DEA41A0","user_header":"https://static001.geekbang.org/account/avatar/00/10/1b/89/b7fae170.jpg","comment_is_top":false,"comment_ctime":1585224930,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585224930","product_id":100015201,"comment_content":"不知道pod间的网络交互会不会有比较大的流量性能损耗呢","like_count":0},{"had_liked":false,"id":188642,"user_name":"dancer","can_delete":false,"product_type":"c1","uid":1019036,"ip_address":"","ucode":"B8D5641A3AC490","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg","comment_is_top":false,"comment_ctime":1584384235,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584384235","product_id":100015201,"comment_content":"这节课的内容需要多复习几遍，然后用自己的理解把图画出来。","like_count":0},{"had_liked":false,"id":186404,"user_name":"芒果少侠","can_delete":false,"product_type":"c1","uid":1350159,"ip_address":"","ucode":"98D0BBB52BB80F","user_header":"https://static001.geekbang.org/account/avatar/00/14/9a/0f/da7ed75a.jpg","comment_is_top":false,"comment_ctime":1583836867,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1583836867","product_id":100015201,"comment_content":"看完后面的课程，再回头反复观看、推敲，终于有种廓然开朗的感觉","like_count":0},{"had_liked":false,"id":175246,"user_name":"Dale","can_delete":false,"product_type":"c1","uid":1010056,"ip_address":"","ucode":"DD4717C06E417D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg","comment_is_top":false,"comment_ctime":1580628856,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580628856","product_id":100015201,"comment_content":"flannel udp隧道就是ipip隧道的实现方式了。","like_count":0},{"had_liked":false,"id":175191,"user_name":"Dale","can_delete":false,"product_type":"c1","uid":1010056,"ip_address":"","ucode":"DD4717C06E417D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg","comment_is_top":false,"comment_ctime":1580609342,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580609342","product_id":100015201,"comment_content":"思考题：你认为 Flannel 能负责保证二层网络（MAC 地址）的连通性吗？为什么呢？<br>我认为是可以连通的。因为容器与宿主机通过bridge虚拟网桥连通，直接通过veth pair的mac地址可以连通。在跨宿主机上，flannel的VETP上也有mac地址，可以和宿主机连通，跨宿主机二层是连通，整个过程都可以通过二层连通","like_count":0},{"had_liked":false,"id":174732,"user_name":"ZARD","can_delete":false,"product_type":"c1","uid":1544906,"ip_address":"","ucode":"F85773DD7B94B2","user_header":"https://static001.geekbang.org/account/avatar/00/17/92/ca/6616a42b.jpg","comment_is_top":false,"comment_ctime":1580366008,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580366008","product_id":100015201,"comment_content":"老师，UDP模式下，宿主机上容器的子网可直接对应宿主机的IP地址。  而在VXLAN模式下，是通过FDB表来找对应宿主机的IP地址的，那UDP模式下子网和宿主机IP地址这个对应关系在VXLAN模式下还有吗。","like_count":0},{"had_liked":false,"id":158647,"user_name":"super","can_delete":false,"product_type":"c1","uid":1431893,"ip_address":"","ucode":"C5AB6ED96F278E","user_header":"https://static001.geekbang.org/account/avatar/00/15/d9/55/c60c5547.jpg","comment_is_top":false,"comment_ctime":1575427139,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1575427139","product_id":100015201,"comment_content":"flannel vxlan抓flannel.1网卡看到的原地址是flannel网卡地址是咋做到的呢？有知道的么？","like_count":0},{"had_liked":false,"id":153061,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1574150148,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1574150148","product_id":100015201,"comment_content":"有一个问题，vxlan要求宿主机之间是二层连通吗？","like_count":0,"discussions":[{"author":{"id":2334257,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/4fZ9thib248ZkR1N3Eekeyb8N1V1Ud0uePctlI4VQUibPSmEZvgoP0VYl6IsVHJc7ZMiczQMtU76y6E6ag1zNAK4Q/132","nickname":"Geek_336577","note":"","ucode":"4826355EBA4950","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349466,"discussion_content":"必须不用，数据从一个机器到另外一个机器实际上是走的udp即3层的一个通信。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613224410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2108110,"avatar":"https://static001.geekbang.org/account/avatar/00/20/2a/ce/fea443f7.jpg","nickname":"明","note":"","ucode":"57B974802AD79A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298427,"discussion_content":"这个地方同样疑惑。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597296664,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1920729,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/4e/d9/550bb4a2.jpg","nickname":"刘晓洁","note":"","ucode":"4862B1CBB501D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":221247,"discussion_content":"不需要，三层连通即可","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585994719,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152333,"user_name":"拉欧","can_delete":false,"product_type":"c1","uid":1206605,"ip_address":"","ucode":"40996A8093A95F","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg","comment_is_top":false,"comment_ctime":1573975924,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573975924","product_id":100015201,"comment_content":"不能吧，虽然flannel实现的是虚拟的二层，实际上还是在三层进行工作的，mac层联通完全是物理层的事情，需要链路上的交换机和路由保持正常工作，不是软件能解决的问题","like_count":0},{"had_liked":false,"id":141231,"user_name":"hal","can_delete":false,"product_type":"c1","uid":1359844,"ip_address":"","ucode":"98E625F7327FD9","user_header":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","comment_is_top":false,"comment_ctime":1571130851,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571130851","product_id":100015201,"comment_content":"🐂.......我竟然听懂了","like_count":0},{"had_liked":false,"id":133926,"user_name":"Geek_7a4ed9","can_delete":false,"product_type":"c1","uid":1120458,"ip_address":"","ucode":"323557E5FC4328","user_header":"https://static001.geekbang.org/account/avatar/00/11/18/ca/2ad3676d.jpg","comment_is_top":false,"comment_ctime":1568700171,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1568700171","product_id":100015201,"comment_content":"VXLAN模式下封包的时候为什么需要目的VTEP设备的MAC地址,这个MAC地址有啥作用？<br>我目前的理解，目标机器eth0接收到原始数据包后，根据VNI将包传给flannel.1 设备，flannel.1 设备再将数据包转到docker0网关就可以了啊。","like_count":0},{"had_liked":false,"id":91525,"user_name":"随意门","can_delete":false,"product_type":"c1","uid":1316502,"ip_address":"","ucode":"6AADD9C133AFCB","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/96/1538f36c.jpg","comment_is_top":false,"comment_ctime":1557048499,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557048499","product_id":100015201,"comment_content":"图 1 基于 Flannel UDP 模式的跨主通信的基本原...里面的flannel的ip是不是应该是100.96.0.0&#47;16啊？<br><br>","like_count":0},{"had_liked":false,"id":85047,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1554966623,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554966623","product_id":100015201,"comment_content":"两个字 可靠","like_count":0},{"had_liked":false,"id":81364,"user_name":"fangxuan","can_delete":false,"product_type":"c1","uid":1073369,"ip_address":"","ucode":"3870F2BF5679A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/60/d9/829ac53b.jpg","comment_is_top":false,"comment_ctime":1553872743,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1553872743","product_id":100015201,"comment_content":"flanneld维护了很多信息，这些信息都是存在用户态还是内核态？另外，如果node1和node2不在一个网段，即中间有个路由器，fdb中存的记录中存的就是路由器的ip了吗？这个就类似路由学习了啊，flanneld是怎么做到的？","like_count":0},{"had_liked":false,"id":71154,"user_name":"LEON","can_delete":false,"product_type":"c1","uid":1109922,"ip_address":"","ucode":"58F7AF5302FCAD","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg","comment_is_top":false,"comment_ctime":1551274627,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1551274627","product_id":100015201,"comment_content":"为什么有的教材是flannel.0有的是flannel.1。这两个flannel我看里面地址的掩码不一样，有什么区别？","like_count":0},{"had_liked":false,"id":63192,"user_name":"Adam","can_delete":false,"product_type":"c1","uid":1305633,"ip_address":"","ucode":"338BA720880E4F","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/21/b0fe1bfd.jpg","comment_is_top":false,"comment_ctime":1548296334,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1548296334","product_id":100015201,"comment_content":"老师，请问下，vxlan模式下，宿主机是否不需要在同一个子网内？路由上可达就行？","like_count":0},{"had_liked":false,"id":62177,"user_name":"凌","can_delete":false,"product_type":"c1","uid":1257995,"ip_address":"","ucode":"41369B360C794F","user_header":"https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg","comment_is_top":false,"comment_ctime":1547970278,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547970278","product_id":100015201,"comment_content":"udp的模式比vxlan数据包要少一层包装吧","like_count":0},{"had_liked":false,"id":51386,"user_name":"(!0+)[+]+([+]+)[-~]","can_delete":false,"product_type":"c1","uid":1133804,"ip_address":"","ucode":"1544F3EEF6AC6E","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/ec/9fea079a.jpg","comment_is_top":false,"comment_ctime":1545180109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545180109","product_id":100015201,"comment_content":"flannel要保证容器二层网络联通，首先要知道node2上的容器mac地址二层帧需要发往node2的VTEP设备","like_count":0},{"had_liked":false,"id":49307,"user_name":"jssfy","can_delete":false,"product_type":"c1","uid":1137238,"ip_address":"","ucode":"F16353CFE607B7","user_header":"https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg","comment_is_top":false,"comment_ctime":1544663554,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544663554","product_id":100015201,"comment_content":"可以看到，Flannel 通过上述的“隧道”机制，实现了容器之间三层网络（IP 地址）的连通性。但是，根据这个机制的工作原理，你认为 Flannel 能负责保证二层网络（MAC 地址）的连通性吗？为什么呢？<br>如果每个flanneld进程都单独维护一个大的容器arp表，是否就可以实现二层的互通？","like_count":0},{"had_liked":false,"id":47272,"user_name":"pepezzzz","can_delete":false,"product_type":"c1","uid":1143169,"ip_address":"","ucode":"414AD2DFD4BA1A","user_header":"https://static001.geekbang.org/account/avatar/00/11/71/81/4e47560f.jpg","comment_is_top":false,"comment_ctime":1544096153,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544096153","product_id":100015201,"comment_content":"发往我们前面提到的“目的 VTEP 设备”（MAC 地址是 5e:f8:4f:00:e3:37）的二层数据帧，应该通过 flannel.1 设备，发往 IP 地址为 10.168.0.3 的主机。<br><br><br>通过 flannel.1 设备 ，这个是不是不对，应该是来自于。<br>","like_count":0},{"had_liked":false,"id":44401,"user_name":"在路上","can_delete":false,"product_type":"c1","uid":1143372,"ip_address":"","ucode":"335960F683C23C","user_header":"https://static001.geekbang.org/account/avatar/00/11/72/4c/4d636a23.jpg","comment_is_top":false,"comment_ctime":1543420970,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1543420970","product_id":100015201,"comment_content":"由于我们的 IP 包的目的地址是 100.96.2.3，它匹配不到本机 docker0 网桥对应的 100.96.1.0&#47;24 网段，只能匹配到第二条、也就是 100.96.0.0&#47;16 对应的这条路由规则，从而进入到一个叫作 flannel0 的设备中。<br>这里不太理解，为什么匹配到第二条路由规则了呢？","like_count":0},{"had_liked":false,"id":37743,"user_name":"陆培尔","can_delete":false,"product_type":"c1","uid":1095319,"ip_address":"","ucode":"B9AE067272513B","user_header":"https://static001.geekbang.org/account/avatar/00/10/b6/97/93e82345.jpg","comment_is_top":false,"comment_ctime":1541723189,"is_pvip":false,"replies":[{"id":"13634","content":"bpf其实跟网络关系不大，咱们以后有机会再讲","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541767210,"ip_address":"","comment_id":37743,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1541723189","product_id":100015201,"comment_content":"老师能说一下最近很火的cilium吗，BPF的内部机制","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428474,"discussion_content":"bpf其实跟网络关系不大，咱们以后有机会再讲","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541767210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37681,"user_name":"LEON","can_delete":false,"product_type":"c1","uid":1109922,"ip_address":"","ucode":"58F7AF5302FCAD","user_header":"https://static001.geekbang.org/account/avatar/00/10/ef/a2/6ea5bb9e.jpg","comment_is_top":false,"comment_ctime":1541676941,"is_pvip":true,"replies":[{"id":"13579","content":"你自己写的java应用，用户态。你自己写的linux内核模块，内核态。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1541719598,"ip_address":"","comment_id":37681,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1541676941","product_id":100015201,"comment_content":"老师，请问内核态和用户态具体指的是什么呢？该如何理解？","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428446,"discussion_content":"你自己写的java应用，用户态。你自己写的linux内核模块，内核态。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541719598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":37417,"user_name":"swordholder","can_delete":false,"product_type":"c1","uid":1002569,"ip_address":"","ucode":"3D1361126AD3CB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/49/d21c134f.jpg","comment_is_top":false,"comment_ctime":1541578749,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1541578749","product_id":100015201,"comment_content":"VXLAN就是将二层网络帧封装在UDP包中进行传输。<br>因此我觉得对于二层网络帧，可以将目的MAC地址配置在 FDB（Forwarding Database）中，指明出口设备flannel.1 和目的IP地址，后面就是正常的UDP包传输过程。","like_count":0},{"had_liked":false,"id":37392,"user_name":"风轨","can_delete":false,"product_type":"c1","uid":1185844,"ip_address":"","ucode":"7B8A5233B61EB0","user_header":"https://static001.geekbang.org/account/avatar/00/12/18/34/c082419c.jpg","comment_is_top":false,"comment_ctime":1541567924,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1541567924","product_id":100015201,"comment_content":"根据文中描述，容器之间二层网络不通，VTEP设备之间二层网络是联通的。<br>容器通过docker0网桥与VTEP设备通信，所以容器之间的二层网络不联通。<br>推论:<br>要让容器之间二层网络联通，除非每个容器都拥有自己的VTEP设备，且这些设备的VNI标识一样，同一台宿主机上的VTEP设备VNI应该不能一样。<br><br>容器之间进行二层通信似乎没有必要。","like_count":0},{"had_liked":false,"id":37345,"user_name":"Vincen","can_delete":false,"product_type":"c1","uid":1218185,"ip_address":"","ucode":"1029A901EC7BA0","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/89/9312b3a2.jpg","comment_is_top":false,"comment_ctime":1541553426,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1541553426","product_id":100015201,"comment_content":"应该不能吧 二层的数据包根本不会发送给flannel","like_count":0},{"had_liked":false,"id":37327,"user_name":"DJH","can_delete":false,"product_type":"c1","uid":1256740,"ip_address":"","ucode":"2BDEF123B3DB6A","user_header":"https://static001.geekbang.org/account/avatar/00/13/2d/24/28acca15.jpg","comment_is_top":false,"comment_ctime":1541551520,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1541551520","product_id":100015201,"comment_content":"请教一下，每个主机上的VTEAP设备的VNI值是不是都是不同（唯一）的？","like_count":0,"discussions":[{"author":{"id":1281551,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/pZ5ibu3jOPTfWVtzTeNTiaL2PiabGT2Y2yKd2TNDcZMkIY34T5fhGcSnBjgpkd54Q3S6b3gRW3yYTxZk0QHYB0qnw/132","nickname":"啊树","note":"","ucode":"F1072F4610B6F8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582985,"discussion_content":"VNI 的默认值是 1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659861867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}