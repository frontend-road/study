{"id":125952,"title":"35 | 流量调度与负载均衡","content":"<p>你好，我是七牛云许式伟。</p><p>相比桌面程序而言，服务端程序依赖的基础软件不只是操作系统和编程语言，还多了两类：</p><ul>\n<li>负载均衡（Load Balance）；</li>\n<li>数据库或其他形式的存储（DB/Storage）。</li>\n</ul><p>为什么会需要负载均衡（Load Balance）？今天我们就聊一下有关于流量调度与负载均衡的那些事情。</p><p>上一讲我们画了服务端程序的体系架构图，如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/89/82/895dbf7e39fb562215e0176ca4aad382.png?wh=592*502\" alt=\"\"></p><p>什么是 “流量调度”？我们首先要了解这样几个常见的服务端程序运行实例（进程）相关的概念：</p><ul>\n<li>连接数；</li>\n<li>IOPS；</li>\n<li>流量，入向流量和出向流量。</li>\n</ul><p>我们知道，一个基本的服务端程序的服务请求，通常是由一个请求包（Request）和一个应答包（Response）构成。这样一问一答就是一次完整的服务。</p><p>连接数，有时候也会被称为并发数，指的是同时在服务中的请求数。也就是那些已经发送请求（Request），但是还没有收完应答（Response）的请求数量。</p><p>IOPS，指的是平均每秒完成的请求（一问一答）的数量。它可以用来判断服务端程序的做事效率。</p><p>流量分入向流量和出向流量。入向流量可以这么估算：</p><ul>\n<li>平均每秒收到的请求包（Request）数量 <code>*</code> 请求包平均大小。</li>\n</ul><p>同样的，出向流量可以这么估算：</p><ul>\n<li>平均每秒返回的应答包（Response）数量 <code>*</code> 应答包平均大小。</li>\n</ul><!-- [[[read_end]]] --><p>不考虑存在无效的请求包，也就是存在有问无答的情况（但实际生产环境下肯定是有的）的话，那么平均每秒收到的请求包（Request）数量、平均每秒返回的应答包（Response）数量就是 IOPS。故此：</p><ul>\n<li>入向流量 ≈ IOPS <code>*</code> 请求包平均大小</li>\n<li>出向流量 ≈ IOPS <code>*</code> 应答包平均大小</li>\n</ul><p>所谓流量调度，就是把海量客户并发的请求包按特定策略分派到不同的服务端程序实例的过程。</p><p>有很多手段可以做流量调度。</p><h2>DNS 流量调度</h2><p>最基础的方式，是通过 DNS，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/79/cd/793c5e6b7a884e6816a60ebe2ee803cd.png?wh=586*272\" alt=\"\"></p><p>一个域名通过 DNS 解析到多个 IP，每个 IP 对应不同的服务端程序实例。这样就完成了流量调度。这里我们没有用到常规意义的负载均衡（Load Balance）软件，但是我们的确完成了流量调度。</p><p>那么这种做法有什么不足？</p><p><strong>第一个问题，是升级不便。</strong></p><p>要想升级 IP1 对应的服务端程序实例，必须先把 IP1 从 DNS 解析中去除，等 IP1 这个实例没有流量了，然后我们升级该实例，最后把 IP1 加回 DNS 解析中。</p><p>看起来还好，但是我们不要忘记，DNS 解析是有层层缓冲的。我们把 IP1 从 DNS 解析中去除，就算我们写明 TTL 是 15 分钟，但是过了一天可能都还稀稀拉拉有一些用户请求被发送到 IP1 这个实例。</p><p>所以通过调整 DNS 解析来实现升级，有极大的不确定性，完成一个实例的升级周期特别长。</p><p>假如一个实例升级需要 1 天，我们总共有 10 个实例，那么就需要 10 天。这太夸张了。</p><p><strong>第二个问题，是流量调度不均衡。</strong></p><p>DNS 服务器是有能力做一定的流量均衡的。比如第一次域名解析返回 IP1 优先，第二次域名解析让 IP2 优先，以此类推，它可以根据域名解析来均衡地返回 IP 列表。</p><p>但是域名解析均衡，并不代表真正的流量均衡。</p><p>一方面，不是每次用户请求都会对应一次 DNS 解析，客户端自己有缓存。另一方面，DNS 解析本身也有层层缓存，到 DNS 服务器的比例已经很少了。</p><p>所以在这样情况下，按域名解析做流量调度均衡，是非常粗糙的，实际结果并不可控。</p><p>那么，怎么让流量调度能够做到真正均衡？</p><h2>网络层负载均衡</h2><p>第一种做法，是在网络层（IP 层）做负载均衡。</p><p>章文嵩博士发起的负载均衡软件 LVS（Linux Virtual Server）就工作在这一层。我们以 LVS 为代表介绍一下工作原理。</p><p>LVS 支持三种调度模式。</p><ul>\n<li>VS/NAT：通过网络地址转换（NAT）技术做调度。请求和响应都会经过调度器中转，性能最差。</li>\n<li>VS/TUN：把请求报文通过 IP 隧道转发至真实服务器，而真实服务器将响应直接返回给客户，所以调度器只处理请求报文。这种做法性能比 VS/NAT 好很多。</li>\n<li>VS/DR：通过改写请求报文的MAC地址，将请求发送到真实服务器，真实服务器将响应直接返回给客户。这种做法相比 VS/TUN 少了 IP 隧道的开销，性能最好。</li>\n</ul><p>我们重点介绍下 VS/DR 技术。</p><p><img src=\"https://static001.geekbang.org/resource/image/02/32/02d193a74158940f18a8562b771de732.png?wh=636*411\" alt=\"\"></p><p>如上图所示。设客户端的 IP 和 MAC 为 CIP、CMAC。</p><p>第 1 步，客户端发起请求，其 IP 报文中，源 IP 为用户的 CIP ，目标 IP 是 VIP；源 MAC 地址为 CMAC ，目标 MAC 地址为 DMAC。</p><p>第 2 步，请求包到达 LVS 调度器（Director Server）。我们保持源 IP 和目标 IP 不变，仅仅修改目标 MAC 地址为 RMAC，将请求转发到真实的业务服务器实例 RS（Real Server）。</p><p>第 3 步，RS 收到数据包并经过处理，直接响应发送给客户端。</p><p>这里面的关键技巧，是 VIP 绑定在多台机器上，所以我们把它叫做虚拟 IP（Virtual IP）。它既绑定在 LVS 调度器（Director Server）上，也绑定在所有的业务服务器实例 RS（Real Server）上。</p><p>当然这里有一个很重要的细节是，ARP 广播查询 VIP 对应的 MAC 地址得到什么？答案当然是 LVS 调度器（Director Server）。在真实的业务服务器实例 RS（Real Server）上，我们把 VIP 绑定在 lo 接口上，并对 ARP 请求作了抑制，这样就避免了 IP 冲突。</p><p>LVS 这种在网络层底层来做负载均衡，相比其他负载均衡技术来说，其特点是通用性强、性能优势高。</p><p>但它也有一些缺点。假如某个业务服务器实例 RS 挂掉，但 LVS 调度器（Director Server）还没有感知到，在这个短周期内转发到该实例的请求都会失败。这样的失败只能依赖客户端重试来解决。</p><h2>应用层负载均衡</h2><p>有办法避免出现这种请求失败的情况吗？</p><p>可以。答案是：服务端重试。</p><p>怎么做服务端重试？应用层负载均衡。有时候我们也把它叫做应用网关。</p><p>HTTP 协议是应用最为广泛的应用层协议。当前应用网关，绝大多数都是 HTTP 应用网关。</p><p>Nginx 和 Apache 都是大家最为耳熟能详的 HTTP 应用网关。因为知道应用层协议的细节，所以 HTTP 应用网关的能力通常非常强大。这一点我们后面还会进一步进行探讨，今天我们先聊负载均衡（Load Balance）相关的内容。</p><p>HTTP 网关收到一个 HTTP 请求（Request）后，根据一定调度算法把请求转发给后端真实的业务服务器实例 RS（Real Server），收到 RS 的应答（Response）后，再把它转发给客户端。</p><p>整个过程的逻辑非常简单，而且重试也非常好做。</p><p>在发现某个 RS 实例挂了后，HTTP 网关可以将同一个 HTTP 请求（Request）重新发给其他 RS 实例。</p><p>当然一个重要的细节是为了能够支持重试，HTTP 请求（Request）需要被保存起来。不保存 HTTP 请求做重试是有可能的，但是只能支持业务实例完全挂掉 HTTP 请求一个字节都没发过去的场景。但在断电或异常崩溃等情况，显然会有很多进行中的请求是不符合这个前提的，它们就没法做重试。</p><p>大部分 HTTP 请求不大，直接在内存中存储即可，保存代价不高。但是文件上传型的请求，由于请求包中包含文件内容，可能就需要依赖临时文件或其他手段来保存 HTTP 请求。</p><h2>优雅升级</h2><p>有了负载均衡，不只是可以实现了流量的均衡调度，连带业务服务器的升级也会方便多了。</p><p>对于前端是 LVS 这种网络层负载均衡的场景，升级的核心步骤为：</p><ul>\n<li>升级系统通知 LVS 调度器（Director Server）下线要升级的业务服务器（Real Server）实例。</li>\n<li>LVS 调度器（Director Server）将该实例从 RS 集合中去除，这样就不再调度新流量到它。</li>\n<li>升级系统通知要升级的 RS 实例退出。</li>\n<li>要升级的 RS 实例处理完所有处理中的请求，然后主动退出。</li>\n<li>升级系统更新 RS 实例到新版本，并重启。</li>\n<li>升级系统将 RS 实例重新加回 RS 集合参与调度。</li>\n</ul><p>对于前端是 HTTP 应用网关这种负载均衡的场景，升级的过程可以更加简单：</p><ul>\n<li>升级系统通知升级的业务服务器（Real Server）实例退出。</li>\n<li>要升级的 RS 实例进入退出状态，这时新请求进来直接拒绝（返回一个特殊的 Status Code）；处理完所有处理中的请求后，RS 实例主动退出。</li>\n<li>升级系统更新 RS 实例到新版本，并重启。</li>\n</ul><p>可以看出，因 HTTP 应用网关支持重试，业务服务器的升级过程就变得简单很多。</p><h2>结语</h2><p>今天我们从流量调度谈起，聊了几种典型的调度手段和负载均衡的方式。</p><p>从流量调度角度来说，负载均衡的最大价值是让多个业务服务器的压力均衡。这里面隐含的一个前提是负载均衡软件的抗压能力往往比业务服务器强很多（为什么？欢迎留言讨论）。</p><p>这表现在：其一，负载均衡的实例数/业务服务器的实例数往往大大小于1；其二，DNS 的调度不均衡，所以负载均衡的不同实例的压力不均衡，有的实例可能压力很大。</p><p>当然，负载均衡的价值并不只是做流量的均衡调度，它也让我们的业务服务器优雅升级成为可能。</p><p>如果你对今天的内容有什么思考与解读，欢迎给我留言，我们一起讨论。下一讲我们将聊聊存储中间件。</p><p>如果你觉得有所收获，也欢迎把文章分享给你的朋友。感谢你的收听，我们下期再见。</p>","comments":[{"had_liked":false,"id":127192,"user_name":"Geek_4b2920","can_delete":false,"product_type":"c1","uid":1503496,"ip_address":"","ucode":"EAB9B6245DCE6E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/WaxXhtrBWOibKLuicSY9420WFYPepvr0E3Wy2wE1NQ2JRt9T3vRwfW2H6iaEr8DSicr6yAfiahEJhy1JG2FEkmUJvRw/132","comment_is_top":false,"comment_ctime":1566604395,"is_pvip":false,"replies":[{"id":"47082","content":"lvs 不太好做，在 VS&#47;DR 模式下应答包（response）根本就不经过它，所以它连请求包（request）是否已经应答都不知道，就别提失败后重试了。如果在 VS&#47;NAT 模式下，它也需要理解应用层的协议后才能重试，那它就不是网络层负载均衡，而是应用层负载均衡了。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1566622262,"ip_address":"","comment_id":127192,"utype":1}],"discussion_count":3,"race_medal":0,"score":"104645819499","product_id":100025201,"comment_content":"讲到lvs时说到&quot;有办法避免出现这种请求失败的情况吗？&quot;，接着就说nginx是怎么去做的，感觉这里不太衔接呢，lvs不能做服务端重试？还是什么原因？没太明白","like_count":25,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464367,"discussion_content":"lvs 不太好做，在 VS/DR 模式下应答包（response）根本就不经过它，所以它连请求包（request）是否已经应答都不知道，就别提失败后重试了。如果在 VS/NAT 模式下，它也需要理解应用层的协议后才能重试，那它就不是网络层负载均衡，而是应用层负载均衡了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566622262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1102245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/a5/2bbedc3b.jpg","nickname":"over","note":"","ucode":"FE272AC19842D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367137,"discussion_content":"因为你不知道目标ip上的服务是否正常工作","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618276684,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1037070,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d3/0e/d2f9dd72.jpg","nickname":"孙梦华🙄🙄","note":"","ucode":"2017F0E865416C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366369,"discussion_content":"VS/NAT模式，不是地址转换吗？做的是源地址IP和目标地址IP的转换，为什么要理解应用层协议啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618043734,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228531,"user_name":"dovefi","can_delete":false,"product_type":"c1","uid":1007670,"ip_address":"","ucode":"9F8C59F095B187","user_header":"https://static001.geekbang.org/account/avatar/00/0f/60/36/1848c2b7.jpg","comment_is_top":false,"comment_ctime":1592727846,"is_pvip":false,"replies":[{"id":"84386","content":"一般三个都会同时用","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1592830576,"ip_address":"","comment_id":228531,"utype":1}],"discussion_count":2,"race_medal":0,"score":"78902139174","product_id":100025201,"comment_content":"总结一下：<br>1. dns 负载均衡<br>优点：没有服务器额外开销，没有流量瓶颈<br>缺点：变更延时高，流量均衡能力弱，没有重试<br><br>2. LVS 四层均衡<br>优点: 只处理入向流量，减小了流量瓶颈的问题，切换升级容易，调度容易<br>缺点：由于出向流量不经过lvs，所以没办法做重试的功能，<br><br>3. nginx 七层负载均衡<br>优点：完美解决负载均衡的问题，解决请求重试问题，同样可以做到无感知服务端升级<br>缺点：容易成为流量瓶颈，很依赖负载均衡的性能<br><br>一般的架构都是 LVS + nginx 的模式","like_count":19,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499068,"discussion_content":"一般三个都会同时用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592830576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111985,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg","nickname":"Frank","note":"","ucode":"9DADD72C193296","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301861,"discussion_content":"lvs 不是网络层吗？ 第三层吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598688324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126993,"user_name":"Void_seT","can_delete":false,"product_type":"c1","uid":1070863,"ip_address":"","ucode":"DD55CB0198A5CD","user_header":"https://static001.geekbang.org/account/avatar/00/10/57/0f/1f229bf5.jpg","comment_is_top":false,"comment_ctime":1566531258,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35926269626","product_id":100025201,"comment_content":"1、首先，因为绝大多数情况下负载均衡服务器的简单转发消耗的系统资源更少，而业务逻辑的处理往往需要更多的系统资源，那么，在服务器配置相当的情况下，负载均衡服务器就比业务处理服务器能处理更多的请求；<br>2、如果，负载均衡服务器的处理能力与业务处理服务器的处理能力相当，那这种依靠负载均衡服务器来做负载均衡的方式效率就极低（约为50%），资源使用率也很低（约为50%），那么，在架构演进的过程中，这种负载均衡方式一定会被淘汰，取而代之的会有目前httpdns等其他的负载均衡方式。","like_count":7},{"had_liked":false,"id":128239,"user_name":"williamcai","can_delete":false,"product_type":"c1","uid":1158294,"ip_address":"","ucode":"B158F52C2D39BC","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/96/46b13896.jpg","comment_is_top":false,"comment_ctime":1566865256,"is_pvip":false,"replies":[{"id":"47550","content":"文章中有解释，arp 协议是通过 ip 得到 mac，这时只有调度器响应 arp。也就是说，在全局，vip 是被认为绑在调度器上。只有各个业务服务器自己以为自己也绑了vip。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1566869933,"ip_address":"","comment_id":128239,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31631636328","product_id":100025201,"comment_content":"lvs调度器和业务服务器都用vip，请求过来了，它怎么通过vip找到的是调度器，而不是业务服务器","like_count":8,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464859,"discussion_content":"文章中有解释，arp 协议是通过 ip 得到 mac，这时只有调度器响应 arp。也就是说，在全局，vip 是被认为绑在调度器上。只有各个业务服务器自己以为自己也绑了vip。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566869933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1500869,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e6/c5/d7aa290b.jpg","nickname":"科春","note":"","ucode":"5766A7E9B9F497","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":24607,"discussion_content":"我认为，在这个场景中其他服务器的ip是否和LVS的vip地址是否一样不重要了，请求都是通过LVS转发的，只要LVS服务器知道后面有哪些服务器来相应就可以了。LVS也是一个故障点啊。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570195988,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126954,"user_name":"CoderLim","can_delete":false,"product_type":"c1","uid":1029523,"ip_address":"","ucode":"4A856891BE98E5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKY0ibA4DWA9Bf6MuicKhyEt0yDXvAzG21xnOUHNLDwuic2icxpesyeXc1AMboeZEW97e8SuZdzIBefqA/132","comment_is_top":false,"comment_ctime":1566525555,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23041362035","product_id":100025201,"comment_content":"负载均衡软件的抗压能力往往比业务服务器强很多，为什么？<br>负载均衡的功能只是转发，相对简单，没有耗时操作，主要的瓶颈应该是最大连接数和内存","like_count":5},{"had_liked":false,"id":210618,"user_name":"喆里","can_delete":false,"product_type":"c1","uid":1125033,"ip_address":"","ucode":"0B4B38104645CA","user_header":"https://static001.geekbang.org/account/avatar/00/11/2a/a9/83684d4a.jpg","comment_is_top":false,"comment_ctime":1587796972,"is_pvip":true,"replies":[{"id":"78422","content":"这样做是靠谱的","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1587806172,"ip_address":"","comment_id":210618,"utype":1}],"discussion_count":1,"race_medal":1,"score":"18767666156","product_id":100025201,"comment_content":"请教下，上面的说两种负载均衡方式LVS和http应用网关，在实际应用中，是不是LVS后面的RS对应的就是http应用网关实例， http网关实例后面的RS才是真正的业务实例？","like_count":5,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493064,"discussion_content":"这样做是靠谱的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587806172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126871,"user_name":"leslie","can_delete":false,"product_type":"c1","uid":1324255,"ip_address":"","ucode":"798E7C1CC98CC2","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg","comment_is_top":false,"comment_ctime":1566507327,"is_pvip":false,"replies":[{"id":"46900","content":"存储的扩展不是基于负载均衡，这个下一讲就会有所涉及。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1566514457,"ip_address":"","comment_id":126871,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18746376511","product_id":100025201,"comment_content":"      老师今天说的都是前端的：可是好像负载均衡不止这些吧，软件一旦并发高了不是从整体的去做均衡么，不仅仅是这些吧？就像数据库方面我经常会去做一主多从、读写分离，甚至说软硬件很多时候都会做相应的事情，可是总觉得这个如何去整体的把握这种均衡确实觉得不容易把握。<br>       老师的课程一路断断续续努力学到现在整体的收获还是让我感觉不一样：如果可以的话，希望老师对于负载均衡这个问题进行适当的扩展，可能这是大多从业到一定年份的IT从业者会碰到的一个困惑问题，这个合理性确实有时很难整体合理的把握。","like_count":4,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464214,"discussion_content":"存储的扩展不是基于负载均衡，这个下一讲就会有所涉及。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566514457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1049576,"avatar":"https://static001.geekbang.org/account/avatar/00/10/03/e8/4c943503.jpg","nickname":"乐","note":"","ucode":"4505CB6BD9C144","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6054,"discussion_content":"我看你是想要了解数据复制与分区相关知识，正好我最近有在看《密集型应用系统设计》，推荐一哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566641251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229923,"user_name":"王棕生","can_delete":false,"product_type":"c1","uid":1337944,"ip_address":"","ucode":"901BD0447A871E","user_header":"https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg","comment_is_top":false,"comment_ctime":1593198165,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14478100053","product_id":100025201,"comment_content":"许老师，lvs 是工作在IP层，也就是不断接受IP数据包，然后转发到业务服务器；如果同一个TCP 包中几个IP数据包被转发到了不同的业务服务器怎么办？lvs 是怎么控制的呢？还有关于F5是怎么保证的没？","like_count":4,"discussions":[{"author":{"id":2935490,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/ca/c2/f3ce9c87.jpg","nickname":"杜桀","note":"","ucode":"68B04A040AA940","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587501,"discussion_content":"如果是连续的报文不会出现被转发到不同服务器的情况，因为lvs是建立在linux的转发之上的，有连接跟踪保证同一条链接的所有报文被转发到相同目的地。除非报文间隔很长，导致转发会话都超时老化了，再来的报文会创建新的会话，这种有可能后来的报文被转发到别的服务器上。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663116272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127956,"user_name":"humor","can_delete":false,"product_type":"c1","uid":1181867,"ip_address":"","ucode":"9B48C4C7BEC92C","user_header":"https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg","comment_is_top":false,"comment_ctime":1566814104,"is_pvip":false,"replies":[{"id":"47404","content":"反过来了，是通过ip拿到mac。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1566816682,"ip_address":"","comment_id":127956,"utype":1}],"discussion_count":3,"race_medal":0,"score":"14451715992","product_id":100025201,"comment_content":"lvs调度器怎么做到只是修改了mac地址就能找到要转发的业务服务器的呢？我理解的网络层的转发是要先通过mac拿到ip，才能找到对应的机器的","like_count":4,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464722,"discussion_content":"反过来了，是通过ip拿到mac。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566816682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":129009,"discussion_content":"老师，这个问题中你们说的: 通过ip，这个ip是vip吧？拿到mac是业务服务器的rmac吧？这样调度器才知道目标服务器是谁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578669181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104407,"avatar":"https://static001.geekbang.org/account/avatar/00/10/da/17/69cca649.jpg","nickname":"旗木卡卡","note":"","ucode":"2C05BFE91D6892","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":61390,"discussion_content":"TCP/IP协议再看看，这种只能支持在相同网段通过ARP协议IP查MAC，再转发请求包。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574778500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":296639,"user_name":"不温暖啊不纯良","can_delete":false,"product_type":"c1","uid":2079117,"ip_address":"","ucode":"204474A214E00C","user_header":"https://static001.geekbang.org/account/avatar/00/1f/b9/8d/00bded19.jpg","comment_is_top":false,"comment_ctime":1623077011,"is_pvip":false,"replies":[{"id":"107768","content":"dns负载均衡并不是客户端负载均衡，但是和客户端负载均衡的原理的确比较像。客户端负载均衡是很难做精细均衡，因为它只看到自己，看不到其他客户端，不像服务端可以对所有客户做均衡。两者一般是配合关系，负载均衡的入口ip通常有多个，通过dns或客户端先做一次初步的均衡，再通过服务端负载均衡做精细均衡。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1623117818,"ip_address":"","comment_id":296639,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10213011603","product_id":100025201,"comment_content":"老师在文章中提到的DNS流量调度，是不是就相当于是客户端的负载均衡？就像Spring cloud的里面的Ribbon一样？因为ribbon也是客户端拿到所有服务的IP列表，然后在客户端根据负载均衡算法去请求对应的服务，如果不是那么ribbon再进行服务升级的时候，是不是也存在DNS流量调度那样的问题？<br><br>我在网上搜了一下，负载均衡有客户端的负载均衡，也有服务端的负载均衡，它们两个之间的优缺点到底是啥？","like_count":3,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521534,"discussion_content":"dns负载均衡并不是客户端负载均衡，但是和客户端负载均衡的原理的确比较像。客户端负载均衡是很难做精细均衡，因为它只看到自己，看不到其他客户端，不像服务端可以对所有客户做均衡。两者一般是配合关系，负载均衡的入口ip通常有多个，通过dns或客户端先做一次初步的均衡，再通过服务端负载均衡做精细均衡。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1623117818,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2079117,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/b9/8d/00bded19.jpg","nickname":"不温暖啊不纯良","note":"","ucode":"204474A214E00C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378284,"discussion_content":"谢谢老师的回复，我明白了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623147977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161681,"user_name":"氧气🌙 🐟 🌺","can_delete":false,"product_type":"c1","uid":1591015,"ip_address":"","ucode":"8E23C210A9F09E","user_header":"https://static001.geekbang.org/account/avatar/00/18/46/e7/e20279ea.jpg","comment_is_top":false,"comment_ctime":1576294268,"is_pvip":false,"replies":[{"id":"61569","content":"是这样","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1576296661,"ip_address":"","comment_id":161681,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10166228860","product_id":100025201,"comment_content":"这里面隐含的一个前提是负载均衡软件的抗压能力往往比业务服务器强很多。<br>由上面一问引发的问题：全球DNS服务器的性能怎样，如何能撑得住全球并发访问？我猜想访问压力也不是直接分散，而是逐个梯次缓存，类似于硬盘，内存，缓存，寄存器等逐级释放。","like_count":2,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477812,"discussion_content":"是这样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576296661,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128793,"user_name":"居培波","can_delete":false,"product_type":"c1","uid":1437396,"ip_address":"","ucode":"27A5A8D9D4682B","user_header":"https://static001.geekbang.org/account/avatar/00/15/ee/d4/204d0c6d.jpg","comment_is_top":false,"comment_ctime":1566963468,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10156898060","product_id":100025201,"comment_content":"中小型产品(项目)用Nginx+Tomcat完成简单负载均衡部署，nginx不需要处理产品业务需求，只需转发客户端请求即可。利用Nginx高并发、轻量级等特征满足一定用户量的增长。","like_count":2},{"had_liked":false,"id":126883,"user_name":"业余爱好者","can_delete":false,"product_type":"c1","uid":1482915,"ip_address":"","ucode":"A890935A982988","user_header":"https://static001.geekbang.org/account/avatar/00/16/a0/a3/8da99bb0.jpg","comment_is_top":false,"comment_ctime":1566516118,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10156450710","product_id":100025201,"comment_content":"负载均衡软件就是为了流量调度而生的，它主要是将请求路由到应用服务器，相比而言，应用服务器多了负载的业务处理这一步，所以抗压能力不如负载均衡软件。","like_count":2},{"had_liked":false,"id":289241,"user_name":"不温暖啊不纯良","can_delete":false,"product_type":"c1","uid":2079117,"ip_address":"","ucode":"204474A214E00C","user_header":"https://static001.geekbang.org/account/avatar/00/1f/b9/8d/00bded19.jpg","comment_is_top":false,"comment_ctime":1618930256,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5913897552","product_id":100025201,"comment_content":"分别介绍了DNS流量调度。 Lvs网络层负载均衡。还有基于HTTP协议的应用层的负载均衡。<br><br>从来没有真正体验过负载均衡带来的好处，因为我们是做政务项目的，并发量比较低，虽然用nginx做的负载均衡和反向代理，但对这些技术的认知还停留在表面。<br><br>负载均衡为什么要以单个业务服务器的抗压能力大？因为所有请求都是通过他分发给业务服务器的，也就是说我有10个服务器，每个服务器处理100个请求，但是负载均衡服软件要能够。处理1000个请求，所以他有内存足够大。<br><br>关于DNS ，lvs，HTTP网关， Lvs和HTTP网关，老师介绍过了，一个是应用在网络层，一个是应用在应用层面，但是他们不都是为了处理用户请求吗，他们之间是一起处理用户的请求吗？还有DNS他们之间的关系是什么样的？虽然说各有优缺点，但我看老师说，在一般业务中这三个都要用，我都没有见识过。<br><br>没有理解老师这段话的意思。<br><br>这表现在：其一，负载均衡的实例数 &#47; 业务服务器的实例数往往大大小于 1；其二，DNS 的调度不均衡，所以负载均衡的不同实例的压力不均衡，有的实例可能压力很大。","like_count":1},{"had_liked":false,"id":284993,"user_name":"右耳朵猫咪","can_delete":false,"product_type":"c1","uid":1014984,"ip_address":"","ucode":"3AB186CC780FBB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/c8/8627f5c1.jpg","comment_is_top":false,"comment_ctime":1616573424,"is_pvip":true,"replies":[{"id":"103366","content":"这个必须没问题啊😄","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1616574629,"ip_address":"","comment_id":284993,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5911540720","product_id":100025201,"comment_content":"七牛云能顶住每天亿万级的视频文件存储吗，比如像快手、抖音那样的。","like_count":2,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517542,"discussion_content":"这个必须没问题啊😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616574629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1510987,"avatar":"https://static001.geekbang.org/account/avatar/00/17/0e/4b/7d5fbad7.jpg","nickname":"沈！","note":"","ucode":"05CEE8B7794521","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376945,"discussion_content":"专业的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622432255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":220504,"user_name":"::error","can_delete":false,"product_type":"c1","uid":2014834,"ip_address":"","ucode":"75B4317A3B9070","user_header":"https://static001.geekbang.org/account/avatar/00/1e/be/72/6060d4a6.jpg","comment_is_top":false,"comment_ctime":1590252089,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5885219385","product_id":100025201,"comment_content":"每一次都觉得自己对计算机网络很了解了，可是每一次看到高手写的文章，都刷新一次对计算机网络的认识!!","like_count":1},{"had_liked":false,"id":215674,"user_name":"Messi  Curry","can_delete":false,"product_type":"c1","uid":1210566,"ip_address":"","ucode":"365B842DA94EA5","user_header":"https://static001.geekbang.org/account/avatar/00/12/78/c6/c952aec9.jpg","comment_is_top":false,"comment_ctime":1589075428,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5884042724","product_id":100025201,"comment_content":"首先负载均衡存在的意义主要是为了帮服务器分压，假设负载均衡抗压能力=业务服务器，那将是一个巨大成本的浪费，这样会导致它的数量必须要少，同样的请求量，数量小就要意味着更高的并发支持。再者，负载均衡主要负责根据权重进行策略转发，不承载业务服务器那种逻辑处理，也没有跟各个中间件和数据库的过多交互，高并发的实现是顺理成章的。","like_count":1},{"had_liked":false,"id":161285,"user_name":"edward","can_delete":false,"product_type":"c1","uid":1076445,"ip_address":"","ucode":"3944E1D3B4F312","user_header":"https://static001.geekbang.org/account/avatar/00/10/6c/dd/0009448e.jpg","comment_is_top":false,"comment_ctime":1576166166,"is_pvip":false,"replies":[{"id":"61502","content":"这个主要要改负载均衡的配置，不要按ip来分派请求","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1576201478,"ip_address":"","comment_id":161285,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5871133462","product_id":100025201,"comment_content":"老师，你好，想请问一下，我在数据中心中部署了5台服务器和F5做负载均衡，现在遇到一个问题，某个经办点有很多用户，他们是通过nat的形式访问我们的负载地址，导致整个经办点的用户请求都压在一台机子上，这种情况下，选择哪种负载方式可以解决这种情况，让来自一个经办点的用户的请求能均匀转发到5台服务器上？","like_count":1,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477676,"discussion_content":"这个主要要改负载均衡的配置，不要按ip来分派请求","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576201478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127125,"user_name":"Aaron Cheung","can_delete":false,"product_type":"c1","uid":1079816,"ip_address":"","ucode":"03972759C53667","user_header":"https://static001.geekbang.org/account/avatar/00/10/7a/08/4d3e47dd.jpg","comment_is_top":false,"comment_ctime":1566561861,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5861529157","product_id":100025201,"comment_content":"学习了 业务流量不大……肿么办","like_count":1,"discussions":[{"author":{"id":1501988,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/MECl6MSL2h426aNC4icaFPHhIFzZhNaohCY8uEX7wPfJOWCGwj8m66wapnk9yFFz5Nx2Nk8RwqmEkIzib3Oduqlw/132","nickname":"killer","note":"","ucode":"4581C4A062236F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":72641,"discussion_content":"流量不大也需要预防单点故障，给他整上准没错😎😎","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1575510454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127054,"user_name":"许童童","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1566545792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5861513088","product_id":100025201,"comment_content":"老师这一节讲得很好，服务优雅升级配合负载均衡确实是很不错的解决方案。","like_count":1},{"had_liked":false,"id":126909,"user_name":"借我一生","can_delete":false,"product_type":"c1","uid":1132818,"ip_address":"","ucode":"070669898CD237","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/jJ7h5pbYA6EYRh8NHZmI8oNiaqyKh7VZ0QEACd2e4sqH6vcpsnGhxOcGfxia7aOA7F4HQBngVKKRVklCHy9GxWOw/132","comment_is_top":false,"comment_ctime":1566520435,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5861487731","product_id":100025201,"comment_content":"1，在硬件层做负载均衡，比如F5 也是一种常见且高性能的做法。<br>2，要避免最外接入层单点，且需要解决超高并发下单台负载均衡服务器性能瓶颈，只能上DNS轮询技术","like_count":1},{"had_liked":false,"id":339035,"user_name":"FOCUS","can_delete":false,"product_type":"c1","uid":1140080,"ip_address":"","ucode":"DFE3078B632026","user_header":"https://static001.geekbang.org/account/avatar/00/11/65/70/7e137498.jpg","comment_is_top":false,"comment_ctime":1647868448,"is_pvip":false,"replies":[{"id":"123964","content":"不是，是nginx、apache这些","user_name":"作者回复","user_name_real":"编辑","uid":"1228022","ctime":1647971049,"ip_address":"","comment_id":339035,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1647868448","product_id":100025201,"comment_content":"文中所说的&quot;HTTP 网关&quot;，其实就是业务应用种，所写的请求处理逻辑？","like_count":0,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557823,"discussion_content":"不是，是nginx、apache这些","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647971049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323964,"user_name":"阿甘","can_delete":false,"product_type":"c1","uid":1057843,"ip_address":"","ucode":"BC93175B70E05D","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","comment_is_top":false,"comment_ctime":1638241724,"is_pvip":true,"replies":[{"id":"117610","content":"通过ip高可用来做","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1638289926,"ip_address":"","comment_id":323964,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1638241724","product_id":100025201,"comment_content":"老师，请问Director Serve本身的单点&#47;LB 又该怎么解决呢？","like_count":0,"discussions":[{"author":{"id":1203276,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5c/4c/ccf611c4.jpg","nickname":"miao linjie","note":"","ucode":"1C16D43A055213","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551207,"discussion_content":"通过KeepAlived 或者 OSPF+ECMP来做。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644928307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1057843,"avatar":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","nickname":"阿甘","note":"","ucode":"BC93175B70E05D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535399,"discussion_content":"老师能展开介绍一下吗？或者给个链接我学习一下，谢谢老师！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638428123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314750,"user_name":"Geek_100ec2","can_delete":false,"product_type":"c1","uid":2061693,"ip_address":"","ucode":"5B18F238F14352","user_header":"https://static001.geekbang.org/account/avatar/00/1f/75/7d/1283991d.jpg","comment_is_top":false,"comment_ctime":1633399952,"is_pvip":false,"replies":[{"id":"114024","content":"实现机制有差别 效果相近。具体上，IP隧道是有协议转换成本，而DR只是改目标mac地址，是很轻的操作。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1633532545,"ip_address":"","comment_id":314750,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633399952","product_id":100025201,"comment_content":"lvs第二种和第三种调度方法有啥区别啊，感觉都是请求走调度器，响应直接有rs发走了","like_count":0,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527781,"discussion_content":"实现机制有差别 效果相近。具体上，IP隧道是有协议转换成本，而DR只是改目标mac地址，是很轻的操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633532545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":312713,"user_name":"tradeoff","can_delete":false,"product_type":"c1","uid":1249453,"ip_address":"","ucode":"069F02DD08D347","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIY3pCmEAQ7FADr3iclfZF8DxnjwY3icDbrTqbPFfMeLpLVPfLkdSj7biak5E7c85HQJicPYic4t1CwmWw/132","comment_is_top":false,"comment_ctime":1631950799,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631950799","product_id":100025201,"comment_content":"感觉上，负载均衡也是一种分层解耦的思想，因为多了一层，所以优雅升级更容易实现。","like_count":0},{"had_liked":false,"id":290889,"user_name":"Geek_2a4536","can_delete":false,"product_type":"c1","uid":2030670,"ip_address":"","ucode":"640A0D228B275C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLrbCic7BckSd3xrawFH5KW0yYtI1uSsIEPFh0FIHxvHv9u6XBKgZCqH13qPbZDHTdqgevXLdGQlEw/132","comment_is_top":false,"comment_ctime":1619838144,"is_pvip":false,"replies":[{"id":"105432","content":"可以多个路由器互备","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1619925139,"ip_address":"","comment_id":290889,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1619838144","product_id":100025201,"comment_content":"接入网络的路由器，如果吞吐量不够了，或者单点了，该怎么处理。。。","like_count":1,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519307,"discussion_content":"可以多个路由器互备","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619925139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2030670,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLrbCic7BckSd3xrawFH5KW0yYtI1uSsIEPFh0FIHxvHv9u6XBKgZCqH13qPbZDHTdqgevXLdGQlEw/132","nickname":"Geek_2a4536","note":"","ucode":"640A0D228B275C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372895,"discussion_content":"多个路由器接入网络吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620491453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280860,"user_name":"Run","can_delete":false,"product_type":"c1","uid":1371941,"ip_address":"","ucode":"6738D2F36ACFF6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLMDBq7lqg9ZasC4f21R0axKJRVCBImPKlQF8yOicLLXIsNgsZxsVyN1mbvFOL6eVPluTNgJofwZeA/132","comment_is_top":false,"comment_ctime":1614428313,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614428313","product_id":100025201,"comment_content":"高屋建瓴","like_count":0},{"had_liked":false,"id":223689,"user_name":"坤","can_delete":false,"product_type":"c1","uid":1010922,"ip_address":"","ucode":"74E6838226A405","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg","comment_is_top":false,"comment_ctime":1591156517,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591156517","product_id":100025201,"comment_content":"nat模式下 源IP信息会丢失，这个业界有比较好的解决方案吗？","like_count":0},{"had_liked":false,"id":220507,"user_name":"::error","can_delete":false,"product_type":"c1","uid":2014834,"ip_address":"","ucode":"75B4317A3B9070","user_header":"https://static001.geekbang.org/account/avatar/00/1e/be/72/6060d4a6.jpg","comment_is_top":false,"comment_ctime":1590252611,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590252611","product_id":100025201,"comment_content":"道理应该不难吧，负载均衡服务器是第一个和客户的请求打交道的，然后再把用户的请求分别发给对应的业务服务器，所以负载均衡服务器的抗压能力肯定是要比业务服务器强很多的","like_count":0},{"had_liked":false,"id":218720,"user_name":"业余爱好者","can_delete":false,"product_type":"c1","uid":1482915,"ip_address":"","ucode":"A890935A982988","user_header":"https://static001.geekbang.org/account/avatar/00/16/a0/a3/8da99bb0.jpg","comment_is_top":false,"comment_ctime":1589858978,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589858978","product_id":100025201,"comment_content":"为什么负载均衡软件的性能高于业务服务器?<br><br>负载均衡不需要处理业务，职责单一，只需针对网络的传输机制做优化，做的事情少，自然性能更好。","like_count":0},{"had_liked":false,"id":207260,"user_name":"盘尼西林","can_delete":false,"product_type":"c1","uid":1197347,"ip_address":"","ucode":"B59569FC25144F","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/23/28311447.jpg","comment_is_top":false,"comment_ctime":1587038969,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587038969","product_id":100025201,"comment_content":" IPVS调度器的三种策略:<br>            * 重写请求的目标IP地址为真实服务器地址 【递归】<br>            * 重写请求的目标IP地址为真实服务器地址 &amp;&amp; 真实服务器请求直接返回给客户端 【传递】<br>            * 重写请求的目标MAC地址为真实服务器地址 &amp;&amp; 真实服务器请求直接返回给客户端 【传递】  ","like_count":0},{"had_liked":false,"id":175025,"user_name":"猫头鹰波波","can_delete":false,"product_type":"c1","uid":1019787,"ip_address":"","ucode":"573AC477FA869C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8f/8b/9080f1fa.jpg","comment_is_top":false,"comment_ctime":1580529936,"is_pvip":false,"replies":[{"id":"67995","content":"一般来说两个都需要","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1580545508,"ip_address":"","comment_id":175025,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1580529936","product_id":100025201,"comment_content":"请教下，现在企业中用HTTP网关比较多，还是LVS比较多啊","like_count":1,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482601,"discussion_content":"一般来说两个都需要","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580545508,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157510,"user_name":"你为啥那么牛","can_delete":false,"product_type":"c1","uid":1503506,"ip_address":"","ucode":"1ABC604A54A8F6","user_header":"https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg","comment_is_top":false,"comment_ctime":1575181933,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1575181933","product_id":100025201,"comment_content":"https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;y8AkMDFkA_vyOcRnbS0Fyg<br><br>补充","like_count":0,"discussions":[{"author":{"id":1102245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/a5/2bbedc3b.jpg","nickname":"over","note":"","ucode":"FE272AC19842D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367145,"discussion_content":"该内容已被发布者删除\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618277413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1503506,"avatar":"https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg","nickname":"你为啥那么牛","note":"","ucode":"1ABC604A54A8F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1102245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/a5/2bbedc3b.jpg","nickname":"over","note":"","ucode":"FE272AC19842D3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367329,"discussion_content":"这是哪篇文章的评论？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618322235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":367145,"ip_address":""},"score":367329,"extra":""}]}]},{"had_liked":false,"id":138394,"user_name":"科春","can_delete":false,"product_type":"c1","uid":1500869,"ip_address":"","ucode":"5766A7E9B9F497","user_header":"https://static001.geekbang.org/account/avatar/00/16/e6/c5/d7aa290b.jpg","comment_is_top":false,"comment_ctime":1570195758,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1570195758","product_id":100025201,"comment_content":"第 1 步，客户端发起请求，其 IP 报文中，源 IP 为用CIP ，目标IP是VIP，源MAC地址是CMAC，目的mac地址是DMAC。<br><br>我任务在真实环境中，MAC层是会在三层设备上重写的。也就是说在这个场景里，CMAC报文在经过路由器后，CMAC会变成路由器连接交换机接口的MAC地址。同样DMAC在数据包发送初期，是路由器连接C端的接口的MAC不会是LVS服务器的MAC。<br><br>","like_count":0,"discussions":[{"author":{"id":1104407,"avatar":"https://static001.geekbang.org/account/avatar/00/10/da/17/69cca649.jpg","nickname":"旗木卡卡","note":"","ucode":"2C05BFE91D6892","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":61414,"discussion_content":"你说的应该对，老师只是做个演示，不是重点。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574778868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129165,"user_name":"Geek_88604f","can_delete":false,"product_type":"c1","uid":1501234,"ip_address":"","ucode":"33DD1318E53814","user_header":"","comment_is_top":false,"comment_ctime":1567053619,"is_pvip":false,"replies":[{"id":"48089","content":"一般用的多个hash函数，一个不行用另一个。当然简单+1试下一个服务器也可以。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1567075979,"ip_address":"","comment_id":129165,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1567053619","product_id":100025201,"comment_content":"如果负载均衡策略选择的是根据ip地址做hash，那么当某个后台服务器故障了，怎么做故障迁移？","like_count":1,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465316,"discussion_content":"一般用的多个hash函数，一个不行用另一个。当然简单+1试下一个服务器也可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567075979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104407,"avatar":"https://static001.geekbang.org/account/avatar/00/10/da/17/69cca649.jpg","nickname":"旗木卡卡","note":"","ucode":"2C05BFE91D6892","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":61430,"discussion_content":"也可能是移除掉故障服务器IP后，基于新IP表，重新做hash，重新分发请求。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574779072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128968,"user_name":"兢","can_delete":false,"product_type":"c1","uid":1070683,"ip_address":"","ucode":"878EAA03E02C1C","user_header":"","comment_is_top":false,"comment_ctime":1566997271,"is_pvip":false,"replies":[{"id":"47895","content":"QPS是Queries per second，TPS是Transactions per second，IOPS是Input&#47;Output per second。每秒测量的东西有所不同。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1567001138,"ip_address":"","comment_id":128968,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1566997271","product_id":100025201,"comment_content":"看了一些文章，有提到QPS和TPS的概念，之前就对这两个概念非常混淆，现在又学到一个IOPS，感觉这几个概念说的是不同的东西，但又觉得是一个东西，请问他们之间细微的差别再哪里","like_count":0,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465197,"discussion_content":"QPS是Queries per second，TPS是Transactions per second，IOPS是Input/Output per second。每秒测量的东西有所不同。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567001138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127132,"user_name":"黄伟洪","can_delete":false,"product_type":"c1","uid":1369165,"ip_address":"","ucode":"97331040A49EAD","user_header":"https://static001.geekbang.org/account/avatar/00/14/e4/4d/c7b5f20a.jpg","comment_is_top":false,"comment_ctime":1566566773,"is_pvip":false,"replies":[{"id":"47037","content":"我猜想你说的docker应该是指k8s。k8s应该是四层（传输层）和七层（应用层）。我们这里谈的是三层（网络层）和七层。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1566569181,"ip_address":"","comment_id":127132,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1566566773","product_id":100025201,"comment_content":"Docker是基于应用层的负载均衡？","like_count":1,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464334,"discussion_content":"我猜想你说的docker应该是指k8s。k8s应该是四层（传输层）和七层（应用层）。我们这里谈的是三层（网络层）和七层。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566569181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126974,"user_name":"觉","can_delete":false,"product_type":"c1","uid":1503600,"ip_address":"","ucode":"95E85D30E92170","user_header":"https://static001.geekbang.org/account/avatar/00/16/f1/70/bca09d2d.jpg","comment_is_top":false,"comment_ctime":1566528972,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566528972","product_id":100025201,"comment_content":"一门深入 长时薰修","like_count":0,"discussions":[{"author":{"id":1102245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/a5/2bbedc3b.jpg","nickname":"over","note":"","ucode":"FE272AC19842D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367143,"discussion_content":"随喜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618277290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126965,"user_name":"Jxin","can_delete":false,"product_type":"c1","uid":1251111,"ip_address":"","ucode":"4C03928388C413","user_header":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","comment_is_top":false,"comment_ctime":1566526491,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566526491","product_id":100025201,"comment_content":"1.课后题：假如网关层负载率小于应用层，同时本次请求是需要rsp的。那么网关层该干嘛还是能干嘛，问题是整个应用集群的负载量将受到网关层的约束，也就是说水平扩容无状态应用服务并无法增长负载量。（单机瓶颈依然存在，java现流行的可编程网关负载感觉就会存在这方面问题）<br>2.存储请求和计算请求是两码事。存储请求的请求分发往往意味着业务数据模型的拆分（分布式数据一致性）。存上面是分流了，但除非整个业务拆分贯穿全链路，不然查时就头疼了（比如根据地区将整个业务数据拆分存储）。而计算请求基本都是可以水平扩的。","like_count":0,"discussions":[{"author":{"id":1503506,"avatar":"https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg","nickname":"你为啥那么牛","note":"","ucode":"1ABC604A54A8F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":58382,"discussion_content":"没看明白","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574672623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126959,"user_name":"Charles","can_delete":false,"product_type":"c1","uid":1001410,"ip_address":"","ucode":"32646D78CC0389","user_header":"https://static001.geekbang.org/account/avatar/00/0f/47/c2/e9fa4cf6.jpg","comment_is_top":false,"comment_ctime":1566525822,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566525822","product_id":100025201,"comment_content":"从文章的描述，负载均衡软件之所以性能高，是因为相对业务服务器，少了高级语言层面的编译解析执行、复杂业务逻辑处理、IO读写存储、以及响应过程的处理，而是直接通过网络层以及CPU和内存解决了一切需求","like_count":0},{"had_liked":false,"id":126947,"user_name":"歌在云端","can_delete":false,"product_type":"c1","uid":1110238,"ip_address":"","ucode":"1C876780C9D25E","user_header":"https://static001.geekbang.org/account/avatar/00/10/f0/de/ef564e67.jpg","comment_is_top":false,"comment_ctime":1566524353,"is_pvip":true,"replies":[{"id":"46981","content":"1、是通过dns；2、三个均衡方式是可以一起的","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1566530966,"ip_address":"","comment_id":126947,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1566524353","product_id":100025201,"comment_content":"请问一下多机房的是怎么处理的，比方说在深圳，上海，北京各部署对应的服务，怎么保证广东那边的请求优先进入到深圳的机房里面去啊？是通过DNS吗。还有假如客户端增加，是不是可以三种均衡一起弄","like_count":1,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464257,"discussion_content":"1、是通过dns；2、三个均衡方式是可以一起的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566530966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1500869,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e6/c5/d7aa290b.jpg","nickname":"科春","note":"","ucode":"5766A7E9B9F497","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":24608,"discussion_content":"多机房比较负者，应该需要全局负载均衡器，它同时得知道数据中心的业务服务器的状态及位置信息。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1570196395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110238,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f0/de/ef564e67.jpg","nickname":"歌在云端","note":"","ucode":"1C876780C9D25E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5933,"discussion_content":"谢谢老师解答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566541995,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126907,"user_name":"Linuxer","can_delete":false,"product_type":"c1","uid":1153978,"ip_address":"","ucode":"272D9D8089C3D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg","comment_is_top":false,"comment_ctime":1566520416,"is_pvip":false,"replies":[{"id":"46984","content":"严谨考虑的话比较复杂，负载均衡也是一个集群，相互之间是否需要协同。目前负载均衡的调度策略大都比较简单，详细可以参考lvs、nginx等软件的文档。","user_name":"作者回复","user_name_real":"许式伟-七牛云(已满)","uid":"1228022","ctime":1566533046,"ip_address":"","comment_id":126907,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1566520416","product_id":100025201,"comment_content":"这里面隐含的一个前提是负载均衡软件的抗压能力往往比业务服务器强很多 <br><br>负载均衡软件按照文章所说应该有更高的iops，处理时间短，逻辑相对简单。<br>有一个问题请教，负载均衡考虑流量，是不是还需要保存到每个RS目前流量的统计信息呢？","like_count":0,"discussions":[{"author":{"id":1228022,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/f6/e61d4b8f.jpg","nickname":"许式伟-七牛云(已满)","note":"","ucode":"1A2F8AA6F6DB54","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464239,"discussion_content":"严谨考虑的话比较复杂，负载均衡也是一个集群，相互之间是否需要协同。目前负载均衡的调度策略大都比较简单，详细可以参考lvs、nginx等软件的文档。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566533046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104407,"avatar":"https://static001.geekbang.org/account/avatar/00/10/da/17/69cca649.jpg","nickname":"旗木卡卡","note":"","ucode":"2C05BFE91D6892","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":61482,"discussion_content":"现在局域网万兆、4万兆带宽都很常见了，带宽应该不会是个突出问题。请求产生的流量，如果请求比较均衡，那理论上带宽也会比较均衡。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574779903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1199777,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4e/a1/bd0ccf62.jpg","nickname":"张裕","note":"","ucode":"E3A46D7CA26D82","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5894,"discussion_content":"之前实践过每个RS定时上报自己的状态信息，到负载均衡调度服务的方案，但是汇报的内容做得比较死，简单地就是最大容量多少（配置中心下发的），当前容量多少，我觉得更好的方案是RS能够根据当前的负载自己进行度量，但不知道有没有好的度量手段？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566529876,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1104407,"avatar":"https://static001.geekbang.org/account/avatar/00/10/da/17/69cca649.jpg","nickname":"旗木卡卡","note":"","ucode":"2C05BFE91D6892","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1199777,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4e/a1/bd0ccf62.jpg","nickname":"张裕","note":"","ucode":"E3A46D7CA26D82","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":61462,"discussion_content":"简单点的做法是负载均衡用最少连接数轮询策略应该可以，我们之前这么用过。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574779729,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":5894,"ip_address":""},"score":61462,"extra":""}]}]}]}