{"id":2272,"title":"12 | 跟 Netflix 学习微服务路由发现体系","content":"<p>无</p>\n","comments":[{"had_liked":false,"id":2381,"user_name":"LMD","can_delete":false,"product_type":"c3","uid":1013443,"ip_address":"","ucode":"7626FBB7A4E771","user_header":"","comment_is_top":true,"comment_ctime":1516964833,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"关于《微服务架构核心20讲》课程讲义（PDF 文件），学员可复制下面链接到浏览器下载获取。 http:&#47;&#47;t.cn&#47;RQs9iTw","like_count":6},{"had_liked":false,"id":9068,"user_name":"曲大伟","can_delete":false,"product_type":"c3","uid":1099318,"ip_address":"","ucode":"1255CDCE290877","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/36/953b088f.jpg","comment_is_top":false,"comment_ctime":1526604706,"is_pvip":false,"replies":[{"id":2785,"content":"k8s是开箱即用式的PaaS平台，Google基本上把微服务的基础能力（服务发现，容器资源调度，发布和监控等）都封装在这个平台里头。目前k8s在社区很火，我认为可以作为微服务平台的一站式解决方案。当然也可以走另外一条路，利用社区开源的组件，比如Spring Cloud自己组合拼装微服务平台。这两种方式各有利弊，前一种方式起步会快，但是随着业务发展难免需要深度定制，所以要有研发资源深入k8s的源码+深度定制的能力。后一种方式前期学习成本和门槛不低，需要有研发定制能力，但是后期会有更大的灵活性。简单讲，两条路都可以走通，但是如果要用好运维好的话，深度定制能力是必须的，千万别简单认为用一个开源产品可以解决所有问题，真正的复杂性在运维治理、流程和业务中。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1526738672,"ip_address":"","comment_id":9068,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"杨老师，现在kubernate讨论的比较多，我的理解他主要起到paas和支撑服务的角色，请问用它搭建微服务架构是否合适，对于运维和开发的要求和工作量是否高？","like_count":7,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":417963,"discussion_content":"k8s是开箱即用式的PaaS平台，Google基本上把微服务的基础能力（服务发现，容器资源调度，发布和监控等）都封装在这个平台里头。目前k8s在社区很火，我认为可以作为微服务平台的一站式解决方案。当然也可以走另外一条路，利用社区开源的组件，比如Spring Cloud自己组合拼装微服务平台。这两种方式各有利弊，前一种方式起步会快，但是随着业务发展难免需要深度定制，所以要有研发资源深入k8s的源码+深度定制的能力。后一种方式前期学习成本和门槛不低，需要有研发定制能力，但是后期会有更大的灵活性。简单讲，两条路都可以走通，但是如果要用好运维好的话，深度定制能力是必须的，千万别简单认为用一个开源产品可以解决所有问题，真正的复杂性在运维治理、流程和业务中。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1526738672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":4771,"user_name":"蔷薇尾巴","can_delete":false,"product_type":"c3","uid":1080000,"ip_address":"","ucode":"36ED230446436F","user_header":"https://static001.geekbang.org/account/avatar/00/10/7a/c0/79293c49.jpg","comment_is_top":false,"comment_ctime":1522421939,"is_pvip":false,"replies":[{"id":1342,"content":"聚合服务并非必须，视情况可以直接调基础服务，要不要聚合层，要看业务规模复杂度，前端的迭代频率，团队规模和构成。小团体业务不复杂未必要聚合层。大团队分工业务复杂多变，通常需要聚合层，避免变化扩散到基础服务。另外，聚合层一般是异步并行调后端然后聚合数据。","user_name":"作者回复","user_name_real":"晨晖","uid":1000463,"ctime":1522811141,"ip_address":"","comment_id":4771,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"请问杨老师，聚合服务是必须的吗？如客户端使用异步调用多个请求服务，这样不是更快些吗？如果通过聚合服务调用，然后聚合服务再分别调用基础服务，这样是不是反而更慢些呢？\n还有是否只有需要合并数据的时候才通过聚合服务，否者直接可以调用基础服务？谢谢","like_count":7,"discussions":[{"author":{"id":1000463,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/44/0f/abb7bfe3.jpg","nickname":"Geek_4zi01v","note":"","ucode":"6A485218B87E38","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":416522,"discussion_content":"聚合服务并非必须，视情况可以直接调基础服务，要不要聚合层，要看业务规模复杂度，前端的迭代频率，团队规模和构成。小团体业务不复杂未必要聚合层。大团队分工业务复杂多变，通常需要聚合层，避免变化扩散到基础服务。另外，聚合层一般是异步并行调后端然后聚合数据。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1522811141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":3317,"user_name":"贼道","can_delete":false,"product_type":"c3","uid":1049316,"ip_address":"","ucode":"CFC6727249C815","user_header":"","comment_is_top":false,"comment_ctime":1519048012,"is_pvip":false,"replies":[{"id":1374,"content":"没有统一标准，简单讲看你的规模，原则是尽量单一职责，一种网关负责一种场景（无线GW，H5 GW，第三方联盟商GW，开放平台GW等等）。如果你的规模小人少，有些东西可以合起来，甚至只有一种网关（里头逻辑会复杂维护是问题）。规模大人多的话，尽量分分开吧，当然维护成本工作量也大。","user_name":"作者回复","user_name_real":"晨晖","uid":1000463,"ctime":1522821210,"ip_address":"","comment_id":3317,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"各种用途的gw什么时候应该独立部署，什么情况应该合并部署？","like_count":5,"discussions":[{"author":{"id":1000463,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/44/0f/abb7bfe3.jpg","nickname":"Geek_4zi01v","note":"","ucode":"6A485218B87E38","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415867,"discussion_content":"没有统一标准，简单讲看你的规模，原则是尽量单一职责，一种网关负责一种场景（无线GW，H5 GW，第三方联盟商GW，开放平台GW等等）。如果你的规模小人少，有些东西可以合起来，甚至只有一种网关（里头逻辑会复杂维护是问题）。规模大人多的话，尽量分分开吧，当然维护成本工作量也大。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1522821210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1899314,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/LalJD9ruYQI5zVM1GOCe4PjunIbbeeMiacFHC4TAj0DBVeialKt3vRCLs9dxn1vYXvfp8pgcyaeEQkh1nde1JoBQ/132","nickname":"jun","note":"","ucode":"3A9633CA1FE72E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":263145,"discussion_content":"团队规模小的团队，网关层可以合并使用，只是在网关内部的逻辑控制会比较复杂","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1589180003,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":15419,"user_name":"meijing0114","can_delete":false,"product_type":"c3","uid":1012416,"ip_address":"","ucode":"B349D33E2F3ECC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/72/c0/b09911a0.jpg","comment_is_top":false,"comment_ctime":1531184024,"is_pvip":false,"replies":[{"id":5399,"content":"你的思考正确，可参考Consul Template这样的组件，它可以监视Consul中服务变化，动态更新nginx模板。研发能力强也可以定制自研lua角本对接服务注册中心，另外kong也可参考，内核也是nginx，定制扩展能力更强。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1531406267,"ip_address":"","comment_id":15419,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"对老师说的服务注册组件console了解不多。如果用nginx做网关层的话，势必会遇到通过nginx模块或者lua脚本与服务注册中心进行通信的问题。一个明显的痛点就是如何把upstream中写死的ip列表，替换成后端的服务名称进行动态路由。并且能够感知后端服务的机器扩缩容。可能需要通过定期探测+定期获取缓存+失效移除的方式。","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420378,"discussion_content":"你的思考正确，可参考Consul Template这样的组件，它可以监视Consul中服务变化，动态更新nginx模板。研发能力强也可以定制自研lua角本对接服务注册中心，另外kong也可参考，内核也是nginx，定制扩展能力更强。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1531406267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207906,"user_name":"柳十三","can_delete":false,"product_type":"c3","uid":1385852,"ip_address":"","ucode":"FE50C9778914C6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/tKvmZ3Vs4t6RZ3X7cAliaW47Zatxhn1aV5PcCYT9NZ9k9WWqRrEBGHicGtRWvsG6yQqHnaWw6cGNSbicNLjZebcHA/132","comment_is_top":false,"comment_ctime":1587213252,"is_pvip":false,"replies":[{"id":77940,"content":"有些公司做法基础服务基本上就是数据访问层(对领域模型的增删改查)，也有公司基础服务也是包含一定业务逻辑的，比如订单服务&#47;支付服务。聚合服务主要聚合&#47;裁剪&#47;适配工作。\n\n聚合：比如首页同时要展示分类和产品信息，那么首页聚合服务同时要调用category和product两个服务再聚合起来。\n裁剪：针对手机屏幕，显示不了那么多数据，所以要裁剪掉一些payload。\n适配：适配不同的端用户体验设备，PC&#47;Pad&#47;Mobile等。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1587393982,"ip_address":"","comment_id":207906,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"基础服务是做最简单的增删改查，不写任何业务逻辑还是什么，聚合服务里面到底做什么呢?杨老师能解释下吗","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492278,"discussion_content":"有些公司做法基础服务基本上就是数据访问层(对领域模型的增删改查)，也有公司基础服务也是包含一定业务逻辑的，比如订单服务/支付服务。聚合服务主要聚合/裁剪/适配工作。\n\n聚合：比如首页同时要展示分类和产品信息，那么首页聚合服务同时要调用category和product两个服务再聚合起来。\n裁剪：针对手机屏幕，显示不了那么多数据，所以要裁剪掉一些payload。\n适配：适配不同的端用户体验设备，PC/Pad/Mobile等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587393982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":11308,"user_name":"小北","can_delete":false,"product_type":"c3","uid":1101976,"ip_address":"","ucode":"4DAC260AC75B71","user_header":"https://static001.geekbang.org/account/avatar/00/10/d0/98/9779cf40.jpg","comment_is_top":false,"comment_ctime":1528042832,"is_pvip":false,"replies":[{"id":3665,"content":"zk可以做服务发现，阿里的dubbo还有新浪微博的motan都支持zk做服务发现。zk是一个通用的分布式协调框架，自己做服务发现的话，需要在上面进一步封装，有一定门槛，不如eureka开箱即用简单。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1528131045,"ip_address":"","comment_id":11308,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"波波老师，您好。听了你的课程受益匪浅。有个问题请教一下，目前有些架构师在服务发现的选型上使用了zookeeper，但个人觉得这个框架貌似不合适做微服务的服务发现。您对这个有什么建议么？","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":418787,"discussion_content":"zk可以做服务发现，阿里的dubbo还有新浪微博的motan都支持zk做服务发现。zk是一个通用的分布式协调框架，自己做服务发现的话，需要在上面进一步封装，有一定门槛，不如eureka开箱即用简单。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1528131045,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140483,"user_name":"冷月无声","can_delete":false,"product_type":"c3","uid":1679206,"ip_address":"","ucode":"E09D2E83AD22D3","user_header":"https://static001.geekbang.org/account/avatar/00/19/9f/66/ecc5617d.jpg","comment_is_top":false,"comment_ctime":1570957125,"is_pvip":false,"replies":[{"id":74646,"content":"服务调用&#47;返回和注册中心&#47;服务发现没有直接关系。\n\n外部客户端-&gt;网关-&gt;聚合服务-&gt;基础服务，这个是微服务调用链。基础服务-&gt;聚合服务-&gt;网关-&gt;外部客户端，这个是微服务响应返回链路。\n\n网关发现聚合服务，或者聚合服务发现基础服务，这些一般是后台异步进行，和客户端调用&#47;返回没有直接关系。\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585406141,"ip_address":"","comment_id":140483,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"杨老师，外部服务直接通过网关调用内部聚合服务的时候是不是都会先通过网关去注册中心里的路由表中查询到具体的聚合服务，然后聚合服务再去调用基础服务，然后基础服务在注册网关中发现聚合服务，进行返回？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470411,"discussion_content":"服务调用/返回和注册中心/服务发现没有直接关系。\n\n外部客户端-&amp;gt;网关-&amp;gt;聚合服务-&amp;gt;基础服务，这个是微服务调用链。基础服务-&amp;gt;聚合服务-&amp;gt;网关-&amp;gt;外部客户端，这个是微服务响应返回链路。\n\n网关发现聚合服务，或者聚合服务发现基础服务，这些一般是后台异步进行，和客户端调用/返回没有直接关系。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585406141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125122,"user_name":"Jed","can_delete":false,"product_type":"c3","uid":1204911,"ip_address":"","ucode":"6021AF7FC03AF6","user_header":"https://static001.geekbang.org/account/avatar/00/12/62/af/d2d0312d.jpg","comment_is_top":false,"comment_ctime":1566094598,"is_pvip":false,"replies":[{"id":45977,"content":"无线网关主要负责无线原生Native和Hybrid等应用场景，这个是只是一种划分，具体每家公司的划分方式可能不太一样。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1566134381,"ip_address":"","comment_id":125122,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"想问下无线GW主要是负责哪些场景呢？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463444,"discussion_content":"无线网关主要负责无线原生Native和Hybrid等应用场景，这个是只是一种划分，具体每家公司的划分方式可能不太一样。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566134381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":218467,"user_name":"我来也","can_delete":false,"product_type":"c3","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1589806164,"is_pvip":false,"replies":[{"id":80883,"content":"k8s平台内置支持服务发现，所以不需要再单独引入服务注册发现中心。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1589899129,"ip_address":"","comment_id":218467,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"有个疑惑:\n现在的k8s,Istio都有一些服务发现和注册的能力了,\n如果是简单的场景,是否可以不再引入单独的服务注册中心了呢?","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495471,"discussion_content":"k8s平台内置支持服务发现，所以不需要再单独引入服务注册发现中心。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589899129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":181048,"user_name":"钱","can_delete":false,"product_type":"c3","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1582465836,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100003901,"comment_content":"Netflix的网关和服务发现，ZUUL+EUREKA，听着感觉OK😁，我们的服务注册中心是ZK。","like_count":1},{"had_liked":false,"id":39386,"user_name":"张闯","can_delete":false,"product_type":"c3","uid":1090513,"ip_address":"","ucode":"D5AD46A8DD6FB7","user_header":"https://static001.geekbang.org/account/avatar/00/10/a3/d1/a30a4d06.jpg","comment_is_top":false,"comment_ctime":1542261135,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100003901,"comment_content":"网关和注册中心是微服务体系的两个核心概念。\n上游服务向注册中心注册服务，下游服务到注册中心发现服务。网关是最下游的服务，负责将外部请求转发到微服务体系内的边界服务。\n注册中心在负责了所有服务的注册和发现的同时，也肩负起了微服务体系的监控和服务治理的职责。","like_count":1}]}