{"id":136546,"title":"36ä¸¨æ•°æ®åº“æ²¡æœ‰å¤‡ä»½ï¼Œæ²¡æœ‰ä½¿ç”¨Binlogçš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•æ¢å¤æ•°æ®ï¼Ÿ","content":"<p>æˆ‘ä»¬ä¸ŠèŠ‚è¯¾è®²è§£äº†MySQLçš„å¤åˆ¶æŠ€æœ¯ï¼Œé€šè¿‡ä¸»ä»åŒæ­¥å¯ä»¥å®ç°è¯»å†™åˆ†ç¦»ï¼Œçƒ­å¤‡ä»½ï¼Œè®©æœåŠ¡å™¨æ›´åŠ é«˜å¯ç”¨ã€‚MySQLçš„å¤åˆ¶ä¸»è¦æ˜¯é€šè¿‡Binlogæ¥å®Œæˆçš„ï¼ŒBinlogè®°å½•äº†æ•°æ®åº“æ›´æ–°çš„äº‹ä»¶ï¼Œä»åº“I/Oçº¿ç¨‹ä¼šå‘ä¸»åº“å‘é€Binlogæ›´æ–°çš„è¯·æ±‚ï¼ŒåŒæ—¶ä¸»åº“äºŒè¿›åˆ¶è½¬å‚¨çº¿ç¨‹ä¼šå‘é€Binlogç»™ä»åº“ä½œä¸ºä¸­ç»§æ—¥å¿—è¿›è¡Œä¿å­˜ï¼Œç„¶åä»åº“ä¼šé€šè¿‡ä¸­ç»§æ—¥å¿—é‡æ”¾ï¼Œå®Œæˆæ•°æ®åº“çš„åŒæ­¥æ›´æ–°ã€‚è¿™ç§åŒæ­¥æ“ä½œæ˜¯è¿‘ä¹å®æ—¶çš„åŒæ­¥ï¼Œç„¶è€Œä¹Ÿæœ‰äººä¸ºè¯¯æ“ä½œæƒ…å†µçš„å‘ç”Ÿï¼Œæ¯”å¦‚DBAäººå‘˜ä¸ºäº†æ–¹ä¾¿ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œæˆ–è€…å¿˜è®°äº†å½“å‰æ˜¯åœ¨å¼€å‘ç¯å¢ƒï¼Œè¿˜æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå°±ç›´æ¥å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œï¼Œè¿™æ ·å¾ˆæœ‰å¯èƒ½ä¼šé€ æˆæ•°æ®çš„ä¸¢å¤±ï¼Œæƒ…å†µä¸¥é‡æ—¶ï¼Œè¯¯æ“ä½œè¿˜æœ‰å¯èƒ½åŒæ­¥ç»™ä»åº“å®æ—¶æ›´æ–°ã€‚ä¸è¿‡æˆ‘ä»¬ä¾ç„¶æœ‰ä¸€äº›ç­–ç•¥å¯ä»¥é˜²æ­¢è¿™ç§è¯¯æ“ä½œï¼Œæ¯”å¦‚åˆ©ç”¨å»¶è¿Ÿå¤‡ä»½çš„æœºåˆ¶ã€‚å»¶è¿Ÿå¤‡ä»½æœ€å¤§çš„ä½œç”¨å°±æ˜¯é¿å…è¿™ç§â€œæ‰‹æŠ–â€çš„æƒ…å†µï¼Œè®©æˆ‘ä»¬åœ¨å»¶è¿Ÿä»åº“è¿›è¡Œè¯¯æ“ä½œå‰åœæ­¢ä¸‹æ¥ï¼Œè¿›è¡Œæ•°æ®åº“çš„æ¢å¤ã€‚</p><p>å½“ç„¶å¦‚æœæˆ‘ä»¬å¯¹æ•°æ®åº“åšè¿‡æ—¶é—´ç‚¹å¤‡ä»½ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ¢å¤åˆ°è¯¥æ—¶é—´ç‚¹ã€‚ä¸è¿‡æˆ‘ä»¬ä»Šå¤©è¦è®¨è®ºçš„æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯åœ¨æ²¡åšæ•°æ®åº“å¤‡ä»½ï¼Œæ²¡æœ‰å¼€å¯ä½¿ç”¨Binlogçš„æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½åœ°æ‰¾å›æ•°æ®ã€‚</p><p>ä»Šå¤©çš„å†…å®¹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol>\n<li>InnoDBå­˜å‚¨å¼•æ“ä¸­çš„è¡¨ç©ºé—´æ˜¯æ€æ ·çš„ï¼Ÿä¸¤ç§è¡¨ç©ºé—´å­˜å‚¨æ–¹å¼å„æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ</li>\n<li>å¦‚æœ.ibdæ–‡ä»¶æŸåäº†ï¼Œæ•°æ®è¯¥å¦‚ä½•æ‰¾å›ï¼Ÿ</li>\n<li>å¦‚ä½•æ¨¡æ‹ŸInnoDBæ–‡ä»¶çš„æŸåä¸æ•°æ®æ¢å¤ï¼Ÿ</li>\n</ol><!-- [[[read_end]]] --><h2>InnoDBå­˜å‚¨å¼•æ“çš„è¡¨ç©ºé—´</h2><p>InnoDBå­˜å‚¨å¼•æ“çš„æ–‡ä»¶æ ¼å¼æ˜¯.ibdæ–‡ä»¶ï¼Œæ•°æ®ä¼šæŒ‰ç…§è¡¨ç©ºé—´ï¼ˆtablespaceï¼‰è¿›è¡Œå­˜å‚¨ï¼Œåˆ†ä¸ºå…±äº«è¡¨ç©ºé—´å’Œç‹¬ç«‹è¡¨ç©ºé—´ã€‚å¦‚æœæƒ³è¦æŸ¥çœ‹è¡¨ç©ºé—´çš„å­˜å‚¨æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹<code>innodb_file_per_table</code>å˜é‡è¿›è¡ŒæŸ¥è¯¢ï¼Œä½¿ç”¨<code>show variables like 'innodb_file_per_table';</code>ã€‚ONè¡¨ç¤ºç‹¬ç«‹è¡¨ç©ºé—´ï¼Œè€ŒOFFåˆ™è¡¨ç¤ºå…±äº«è¡¨ç©ºé—´ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7d/0d/7dc5aae75a7d5d2c599c7cb8dd97440d.png?wh=1319*356\" alt=\"\"><br>\nå¦‚æœé‡‡ç”¨å…±äº«è¡¨ç©ºé—´çš„æ¨¡å¼ï¼ŒInnoDBå­˜å‚¨çš„è¡¨æ•°æ®éƒ½ä¼šæ”¾åˆ°å…±äº«è¡¨ç©ºé—´ä¸­ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªæ•°æ®è¡¨å…±ç”¨ä¸€ä¸ªè¡¨ç©ºé—´ï¼ŒåŒæ—¶è¡¨ç©ºé—´ä¹Ÿä¼šè‡ªåŠ¨åˆ†æˆå¤šä¸ªæ–‡ä»¶å­˜æ”¾åˆ°ç£ç›˜ä¸Šã€‚è¿™æ ·åšçš„å¥½å¤„åœ¨äºå•ä¸ªæ•°æ®è¡¨çš„å¤§å°å¯ä»¥çªç ´æ–‡ä»¶ç³»ç»Ÿå¤§å°çš„é™åˆ¶ï¼Œæœ€å¤§å¯ä»¥è¾¾åˆ°64TBï¼Œä¹Ÿå°±æ˜¯InnoDBå­˜å‚¨å¼•æ“è¡¨ç©ºé—´çš„ä¸Šé™ã€‚ä¸è¶³ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¤šä¸ªæ•°æ®è¡¨å­˜æ”¾åˆ°ä¸€èµ·ï¼Œç»“æ„ä¸æ¸…æ™°ï¼Œä¸åˆ©äºæ•°æ®çš„æ‰¾å›ï¼ŒåŒæ—¶å°†æ‰€æœ‰æ•°æ®å’Œç´¢å¼•éƒ½å­˜æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¹Ÿä¼šä½¿å¾—å…±äº«è¡¨ç©ºé—´çš„æ–‡ä»¶å¾ˆå¤§ã€‚</p><p>é‡‡ç”¨ç‹¬ç«‹è¡¨ç©ºé—´çš„æ–¹å¼å¯ä»¥è®©æ¯ä¸ªæ•°æ®è¡¨éƒ½æœ‰è‡ªå·±çš„ç‰©ç†æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯table_name.ibdçš„æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä¿å­˜äº†æ•°æ®è¡¨ä¸­çš„æ•°æ®ã€ç´¢å¼•ã€è¡¨çš„å†…éƒ¨æ•°æ®å­—å…¸ç­‰ä¿¡æ¯ã€‚å®ƒçš„ä¼˜åŠ¿åœ¨äºæ¯å¼ è¡¨éƒ½ç›¸äº’ç‹¬ç«‹ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–æ•°æ®è¡¨ï¼Œå­˜å‚¨ç»“æ„æ¸…æ™°ï¼Œåˆ©äºæ•°æ®æ¢å¤ï¼ŒåŒæ—¶æ•°æ®è¡¨è¿˜å¯ä»¥åœ¨ä¸åŒçš„æ•°æ®åº“ä¹‹é—´è¿›è¡Œè¿ç§»ã€‚</p><h2>å¦‚æœ.ibdæ–‡ä»¶æŸåäº†ï¼Œæ•°æ®å¦‚ä½•æ‰¾å›</h2><p>å¦‚æœæˆ‘ä»¬ä¹‹å‰æ²¡æœ‰åšè¿‡å…¨é‡å¤‡ä»½ï¼Œä¹Ÿæ²¡æœ‰å¼€å¯Binlogï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡.ibdæ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤ï¼Œé‡‡ç”¨ç‹¬ç«‹è¡¨ç©ºé—´çš„æ–¹å¼å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹æ•°æ®åº“è¿›è¡Œè¿ç§»å’Œåˆ†æã€‚å¦‚æœæˆ‘ä»¬è¯¯åˆ é™¤ï¼ˆDELETEï¼‰æŸä¸ªæ•°æ®è¡¨æˆ–è€…æŸäº›æ•°æ®è¡Œï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ç¬¬ä¸‰æ–¹å·¥å…·å›æ•°æ®ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œå¯ä»¥ä½¿ç”¨Percona Data Recovery Tool for InnoDBå·¥å…·ï¼Œèƒ½ä½¿ç”¨å·¥å…·è¿›è¡Œä¿®å¤æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨DELETEçš„æ—¶å€™æ˜¯é€»è¾‘åˆ é™¤ã€‚æˆ‘ä»¬ä¹‹å‰å­¦ä¹ è¿‡InnoDBçš„é¡µç»“æ„ï¼Œåœ¨ä¿å­˜æ•°æ®è¡Œçš„æ—¶å€™è¿˜æœ‰ä¸ªåˆ é™¤æ ‡è®°ä½ï¼Œå¯¹åº”çš„æ˜¯é¡µç»“æ„ä¸­çš„delete_maskå±æ€§ï¼Œè¯¥å±æ€§ä¸º1çš„æ—¶å€™æ ‡è®°äº†è®°å½•å·²ç»è¢«é€»è¾‘åˆ é™¤ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯çœŸçš„åˆ é™¤ã€‚ä¸è¿‡å½“æœ‰æ–°çš„è®°å½•æ’å…¥çš„æ—¶å€™ï¼Œè¢«åˆ é™¤çš„è¡Œè®°å½•å¯èƒ½ä¼šè¢«è¦†ç›–æ‰ã€‚æ‰€ä»¥å½“æˆ‘ä»¬å‘ç”Ÿäº†DELETEè¯¯åˆ é™¤çš„æ—¶å€™ï¼Œä¸€å®šè¦ç¬¬ä¸€æ—¶é—´åœæ­¢å¯¹è¯¯åˆ é™¤çš„è¡¨è¿›è¡Œæ›´æ–°å’Œå†™å…¥ï¼ŒåŠæ—¶å°†.ibdæ–‡ä»¶æ‹·è´å‡ºæ¥å¹¶è¿›è¡Œä¿®å¤ã€‚</p><p>å¦‚æœå·²ç»å¼€å¯äº†Binlogï¼Œå°±å¯ä»¥ä½¿ç”¨é—ªå›å·¥å…·ï¼Œæ¯”å¦‚mysqlbinlogæˆ–è€…binlog2sqlï¼Œä»å·¥å…·åç§°ä¸­ä¹Ÿèƒ½çœ‹å‡ºæ¥å®ƒä»¬éƒ½æ˜¯åŸºäºBinlogæ¥åšçš„é—ªå›ã€‚åŸç†å°±æ˜¯å› ä¸ºBinlogæ–‡ä»¶æœ¬èº«ä¿å­˜äº†æ•°æ®åº“æ›´æ–°çš„äº‹ä»¶ï¼ˆEventï¼‰ï¼Œé€šè¿‡è¿™äº›äº‹ä»¶å¯ä»¥å¸®æˆ‘ä»¬é‡ç°æ•°æ®åº“çš„æ‰€æœ‰æ›´æ–°å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯Binlogå›æ»šã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹æ²¡æœ‰åšè¿‡å¤‡ä»½ï¼Œä¹Ÿæ²¡æœ‰å¼€å¯Binlogçš„æƒ…å†µä¸‹ï¼Œå¦‚æœ.ibdæ–‡ä»¶å‘ç”Ÿäº†æŸåï¼Œå¦‚ä½•é€šè¿‡æ•°æ®åº“è‡ªèº«çš„æœºåˆ¶æ¥è¿›è¡Œæ•°æ®æ¢å¤ã€‚</p><p>å®é™…ä¸Šï¼ŒInnoDBæ˜¯æœ‰è‡ªåŠ¨æ¢å¤æœºåˆ¶çš„ï¼Œå¦‚æœå‘ç”Ÿäº†æ„å¤–ï¼ŒInnoDBå¯ä»¥åœ¨è¯»å–æ•°æ®è¡¨æ—¶è‡ªåŠ¨ä¿®å¤é”™è¯¯ã€‚ä½†æœ‰æ—¶å€™.ibdæ–‡ä»¶æŸåäº†ï¼Œä¼šå¯¼è‡´æ•°æ®åº“æ— æ³•æ­£å¸¸è¯»å–æ•°æ®è¡¨ï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦äººå·¥ä»‹å…¥ï¼Œè°ƒæ•´ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å«åš<code>innodb_force_recovery</code>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤<code>show variables like 'innodb_force_recovery';</code>æ¥æŸ¥çœ‹å½“å‰å‚æ•°çš„çŠ¶æ€ï¼Œä½ èƒ½çœ‹åˆ°é»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºä¸è¿›è¡Œå¼ºåˆ¶æ¢å¤ã€‚å¦‚æœé‡åˆ°é”™è¯¯ï¼Œæ¯”å¦‚ibdæ–‡ä»¶ä¸­çš„æ•°æ®é¡µå‘ç”ŸæŸåï¼Œåˆ™æ— æ³•è¯»å–æ•°æ®ï¼Œä¼šå‘ç”ŸMySQLå®•æœºçš„æƒ…å†µï¼Œæ­¤æ—¶ä¼šå°†é”™è¯¯æ—¥å¿—è®°å½•ä¸‹æ¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6e/ba/6edf81f6402311ca7f8ee8619b656fba.png?wh=1297*369\" alt=\"\"><br>\n<code>innodb_force_recovery</code>å‚æ•°ä¸€å…±æœ‰7ç§çŠ¶æ€ï¼Œé™¤äº†é»˜è®¤çš„0ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä¸º1-6çš„å–å€¼ï¼Œåˆ†åˆ«ä»£è¡¨ä¸åŒçš„å¼ºåˆ¶æ¢å¤æªæ–½ã€‚</p><p>å½“æˆ‘ä»¬éœ€è¦å¼ºåˆ¶æ¢å¤çš„æ—¶å€™ï¼Œå¯ä»¥å°†<code>innodb_force_recovery</code>è®¾ç½®ä¸º1ï¼Œè¡¨ç¤ºå³ä½¿å‘ç°äº†æŸåé¡µä¹Ÿå¯ä»¥ç»§ç»­è®©æœåŠ¡è¿è¡Œï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¯»å–æ•°æ®è¡¨ï¼Œå¹¶ä¸”å¯¹å½“å‰æŸåçš„æ•°æ®è¡¨è¿›è¡Œåˆ†æå’Œå¤‡ä»½ã€‚</p><p>é€šå¸¸<code>innodb_force_recovery</code>å‚æ•°è®¾ç½®ä¸º1ï¼Œåªè¦èƒ½æ­£å¸¸è¯»å–æ•°æ®è¡¨å³å¯ã€‚ä½†å¦‚æœå‚æ•°è®¾ç½®ä¸º1ä¹‹åè¿˜æ— æ³•è¯»å–æ•°æ®è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å‚æ•°é€ä¸€å¢åŠ ï¼Œæ¯”å¦‚2ã€3ç­‰ã€‚ä¸€èˆ¬æ¥è¯´ä¸éœ€è¦å°†å‚æ•°è®¾ç½®åˆ°4æˆ–ä»¥ä¸Šï¼Œå› ä¸ºè¿™æœ‰å¯èƒ½å¯¹æ•°æ®æ–‡ä»¶é€ æˆæ°¸ä¹…ç ´åã€‚å¦å¤–å½“<code>innodb_force_recovery</code>è®¾ç½®ä¸ºå¤§äº0æ—¶ï¼Œç›¸å½“äºå¯¹InnoDBè¿›è¡Œäº†å†™ä¿æŠ¤ï¼Œåªèƒ½è¿›è¡ŒSELECTè¯»å–æ“ä½œï¼Œè¿˜æ˜¯æœ‰é™åˆ¶çš„è¯»å–ï¼Œå¯¹äºWHEREæ¡ä»¶ä»¥åŠORDER BYéƒ½æ— æ³•è¿›è¡Œæ“ä½œã€‚</p><p>å½“æˆ‘ä»¬å¼€å¯äº†å¼ºåˆ¶æ¢å¤ä¹‹åï¼Œæ•°æ®åº“çš„åŠŸèƒ½ä¼šå—åˆ°å¾ˆå¤šé™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å°½å¿«æŠŠæœ‰é—®é¢˜çš„æ•°æ®è¡¨å¤‡ä»½å‡ºæ¥ï¼Œå®Œæˆæ•°æ®æ¢å¤æ“ä½œã€‚æ•´ä½“çš„æ¢å¤æ­¥éª¤å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ€è·¯è¿›è¡Œï¼š</p><p>1.ä½¿ç”¨<code>innodb_force_recovery</code>å¯åŠ¨æœåŠ¡å™¨</p><p>å°†<code>innodb_force_recovery</code>å‚æ•°è®¾ç½®ä¸º1ï¼Œå¯åŠ¨æ•°æ®åº“ã€‚å¦‚æœæ•°æ®è¡¨ä¸èƒ½æ­£å¸¸è¯»å–ï¼Œéœ€è¦è°ƒå¤§å‚æ•°ç›´åˆ°èƒ½è¯»å–æ•°æ®ä¸ºæ­¢ã€‚é€šå¸¸è®¾ç½®ä¸º1å³å¯ã€‚</p><p>2.å¤‡ä»½æ•°æ®è¡¨</p><p>åœ¨å¤‡ä»½æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å‡†å¤‡ä¸€ä¸ªæ–°çš„æ•°æ®è¡¨ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“ã€‚åŸå› å¾ˆç®€å•ï¼ŒInnoDBå­˜å‚¨å¼•æ“å·²ç»å†™ä¿æŠ¤äº†ï¼Œæ— æ³•å°†æ•°æ®å¤‡ä»½å‡ºæ¥ã€‚ç„¶åå°†æŸåçš„InnoDBæ•°æ®è¡¨å¤‡ä»½åˆ°æ–°çš„MyISAMæ•°æ®è¡¨ä¸­ã€‚</p><p>3.åˆ é™¤æ—§è¡¨ï¼Œæ”¹åæ–°è¡¨</p><p>æ•°æ®å¤‡ä»½å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ é™¤æ‰åŸæœ‰æŸåçš„InnoDBæ•°æ®è¡¨ï¼Œç„¶åå°†æ–°è¡¨è¿›è¡Œæ”¹åã€‚</p><p>4.å…³é—­<code>innodb_force_recovery</code>ï¼Œå¹¶é‡å¯æ•°æ®åº“</p><p><code>innodb_force_recovery</code>å¤§äº1çš„æ—¶å€™ä¼šæœ‰å¾ˆå¤šé™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥åŠŸèƒ½å…³é—­ï¼Œç„¶åé‡å¯æ•°æ®åº“ï¼Œå¹¶ä¸”å°†æ•°æ®è¡¨çš„MyISAMå­˜å‚¨å¼•æ“æ›´æ–°ä¸ºInnoDBå­˜å‚¨å¼•æ“ã€‚</p><h2>InnoDBæ–‡ä»¶çš„æŸåä¸æ¢å¤å®ä¾‹</h2><p>æˆ‘ä»¬åˆšæ‰è¯´äº†InnoDBæ–‡ä»¶æŸåæ—¶çš„äººå·¥æ“ä½œè¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥æ¨¡æ‹Ÿä¸‹ã€‚</p><h3>ç”ŸæˆInnoDBæ•°æ®è¡¨</h3><p>ä¸ºäº†ç®€ä¾¿ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ•°æ®è¡¨t1ï¼Œåªæœ‰idä¸€ä¸ªå­—æ®µï¼Œç±»å‹ä¸ºintã€‚ä½¿ç”¨å‘½ä»¤<code>create table t1(id int);</code>å³å¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0c/34/0c2790f539d4f35aec6dd0703b059134.png?wh=944*113\" alt=\"\"><br>\nç„¶ååˆ›å»ºä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹å¸®æˆ‘ä»¬ç”Ÿæˆä¸€äº›æ•°æ®ï¼š</p><pre><code>BEGIN\n-- å½“å‰æ•°æ®è¡Œ\nDECLARE i INT DEFAULT 0;\n-- æœ€å¤§æ•°æ®è¡Œæ•°\nDECLARE max_num INT DEFAULT 100;\n-- å…³é—­è‡ªåŠ¨æäº¤\nSET autocommit=0;\nREPEAT\nSET i=i+1;\n-- å‘t1è¡¨ä¸­æ’å…¥æ•°æ®\nINSERT INTO t1(id) VALUES(i);\nUNTIL i = max_num\nEND REPEAT;\n-- æäº¤äº‹åŠ¡\nCOMMIT;\nEND\n</code></pre><p>ç„¶åæˆ‘ä»¬è¿è¡Œ<code>call insert_t1()</code>ï¼Œè¿™ä¸ªå­˜å‚¨è¿‡ç¨‹å¸®æˆ‘ä»¬æ’å…¥äº†100æ¡æ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å°±æœ‰äº†t1.ibdè¿™ä¸ªæ–‡ä»¶ã€‚</p><h3>æ¨¡æ‹ŸæŸå.ibdæ–‡ä»¶</h3><p>å®é™…å·¥ä½œä¸­æˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°å„ç§å„æ ·çš„æƒ…å†µï¼Œæ¯”å¦‚.ibdæ–‡ä»¶æŸåç­‰ï¼Œå¦‚æœé‡åˆ°äº†æ•°æ®æ–‡ä»¶çš„æŸåï¼ŒMySQLæ˜¯æ— æ³•æ­£å¸¸è¯»å–çš„ã€‚åœ¨æ¨¡æ‹ŸæŸå.ibdæ–‡ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå…³é—­æ‰MySQLæœåŠ¡ï¼Œç„¶åç”¨ç¼–è¾‘å™¨æ‰“å¼€t1.ibdï¼Œç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d3/7c/d34734f6dfbf0e01cf4a40bb549e147c.png?wh=1116*959\" alt=\"\"><br>\næ–‡ä»¶æ˜¯æœ‰äºŒè¿›åˆ¶ç¼–ç çš„ï¼Œçœ‹ä¸æ‡‚æ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬åªéœ€è¦ç ´åå…¶ä¸­çš„ä¸€äº›å†…å®¹å³å¯ï¼Œæ¯”å¦‚æˆ‘åœ¨t1.ibdæ–‡ä»¶ä¸­åˆ é™¤äº†2è¡Œå†…å®¹ï¼ˆæ–‡ä»¶å¤§éƒ¨åˆ†å†…å®¹ä¸º0ï¼Œæˆ‘ä»¬åœ¨æ–‡ä»¶ä¸­é—´éƒ¨åˆ†æ‰¾åˆ°ä¸€äº›é0çš„å–å€¼ï¼Œç„¶ååˆ é™¤å…¶ä¸­çš„ä¸¤è¡Œï¼š4284è¡Œä¸4285è¡Œï¼ŒåŸibdæ–‡ä»¶å’ŒæŸååçš„ibdæ–‡ä»¶è§<a href=\"https://github.com/cystanford/innodb_force_recovery\">GitHub</a><a href=\"https://github.com/cystanford/innodb_force_recovery\">åœ°å€</a>ã€‚å…¶ä¸­t1.ibdä¸ºåˆ›å»ºçš„åŸå§‹æ•°æ®æ–‡ä»¶,t1-æŸå.ibdä¸ºæŸååçš„æ•°æ®æ–‡ä»¶ï¼Œä½ éœ€è¦è‡ªå·±åˆ›å»ºt1æ•°æ®è¡¨ï¼Œç„¶åå°†t1-æŸå.ibdæ‹·è´åˆ°æœ¬åœ°ï¼Œå¹¶æ”¹åä¸ºt1.ibdï¼‰ã€‚</p><p>ç„¶åæˆ‘ä»¬ä¿å­˜æ–‡ä»¶ï¼Œè¿™æ—¶.ibdæ–‡ä»¶å‘ç”Ÿäº†æŸåï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰æ‰“å¼€<code>innodb_force_recovery</code>ï¼Œé‚£ä¹ˆæ•°æ®æ–‡ä»¶æ— æ³•æ­£å¸¸è¯»å–ã€‚ä¸ºäº†èƒ½è¯»å–åˆ°æ•°æ®è¡¨ä¸­çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹MySQLçš„é…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ°<code>[mysqld]</code>çš„ä½ç½®ï¼Œç„¶åå†ä¸‹é¢å¢åŠ ä¸€è¡Œ<code>innodb_force_recovery=1</code>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a3/94/a3a226bbd1b435393039b75618be6e94.png?wh=1729*312\" alt=\"\"></p><h3>å¤‡ä»½æ•°æ®è¡¨</h3><p>å½“æˆ‘ä»¬è®¾ç½®<code>innodb_force_recovery</code>å‚æ•°ä¸º1çš„æ—¶å€™ï¼Œå¯ä»¥è¯»å–åˆ°æ•°æ®è¡¨t1ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯æ•°æ®ä¸å…¨ã€‚æˆ‘ä»¬ä½¿ç”¨<code>SELECT * FROM t1 LIMIT 10;</code>è¯»å–å½“å‰å‰10æ¡æ•°æ®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/76/0a/761a5495f9769de35f60f112e4d94b0a.png?wh=881*803\" alt=\"\"><br>\nä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦å®Œæ•´çš„æ•°æ®ï¼Œä½¿ç”¨<code>SELECT * FROM t1 LIMIT 100;</code>å°±ä¼šå‘ç”Ÿå¦‚ä¸‹é”™è¯¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/62/93/623a6cd6987f5ac11aad432257edcc93.png?wh=1625*109\" alt=\"\"><br>\nè¿™æ˜¯å› ä¸ºè¯»å–çš„éƒ¨åˆ†åŒ…å«äº†å·²æŸåçš„æ•°æ®é¡µï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾åˆ¤æ–­æ•°æ®é¡µæŸåçš„ä½ç½®ã€‚è¿™é‡Œæˆ‘ä»¬é€šè¿‡å®éªŒï¼Œå¯ä»¥å¾—å‡ºåªæœ‰æœ€åä¸€ä¸ªè®°å½•è¡Œæ”¶åˆ°äº†æŸåï¼Œè€Œå‰99æ¡è®°å½•éƒ½å¯ä»¥æ­£ç¡®è¯»å‡ºï¼ˆå…·ä½“å®éªŒè¿‡ç¨‹çœç•¥ï¼‰ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½åˆ¤æ–­å‡ºæ¥æœ‰æ•ˆçš„æ•°æ®è¡Œçš„ä½ç½®ï¼Œä»è€Œå°†å®ƒä»¬å¤‡ä»½å‡ºæ¥ã€‚é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç›¸åŒçš„è¡¨ç»“æ„t2ï¼Œå­˜å‚¨å¼•æ“è®¾ç½®ä¸ºMyISAMã€‚æˆ‘åˆšæ‰è®²è¿‡è¿™é‡Œä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“æ˜¯å› ä¸ºåœ¨<code>innodb_force_recovery=1</code>çš„æƒ…å†µä¸‹ï¼Œæ— æ³•å¯¹innodbæ•°æ®è¡¨è¿›è¡Œå†™æ•°æ®ã€‚ä½¿ç”¨å‘½ä»¤<code>CREATE TABLE t2(id int) ENGINE=MyISAM;</code>ã€‚</p><p>ç„¶åæˆ‘ä»¬å°†æ•°æ®è¡¨t1ä¸­çš„å‰99è¡Œæ•°æ®å¤åˆ¶ç»™t2æ•°æ®è¡¨ï¼Œä½¿ç”¨ï¼š</p><pre><code>INSERT INTO t2 SELECT * FROM t1 LIMIT 99;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/a9/38/a91d4a2d259bba1c2aeb9a5b95619238.png?wh=1219*306\" alt=\"\"><br>\næˆ‘ä»¬åˆšæ‰è®²è¿‡åœ¨åˆ†æt1æ•°æ®è¡¨çš„æ—¶å€™æ— æ³•ä½¿ç”¨WHEREä»¥åŠORDER BYç­‰å­å¥ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å®éªŒä¸€ä¸‹ï¼Œå¦‚æœæƒ³è¦æŸ¥è¯¢id&lt;10çš„æ•°æ®è¡Œéƒ½æœ‰å“ªäº›ï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿå¦‚ä¸‹é”™è¯¯ã€‚åŸå› æ˜¯æŸåçš„æ•°æ®é¡µæ— æ³•è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/fc/9d/fc00a89e22a301826bbdd7b37d7b7c9d.png?wh=1644*122\" alt=\"\"></p><h3>åˆ é™¤æ—§è¡¨ï¼Œæ”¹åæ–°è¡¨</h3><p>åˆšæ‰æˆ‘ä»¬å·²ç»æ¢å¤äº†å¤§éƒ¨åˆ†çš„æ•°æ®ã€‚è™½ç„¶è¿˜æœ‰ä¸€è¡Œè®°å½•æ²¡æœ‰æ¢å¤ï¼Œä½†æ˜¯èƒ½æ‰¾åˆ°ç»å¤§éƒ¨åˆ†çš„æ•°æ®ä¹Ÿæ˜¯å¥½çš„ã€‚ç„¶åæˆ‘ä»¬å°±éœ€è¦æŠŠä¹‹å‰æ—§çš„æ•°æ®è¡¨åˆ é™¤æ‰ï¼Œä½¿ç”¨<code>DROP TABLE t1;</code>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f3/47/f30d79228572382810fd388ded1ff447.png?wh=925*125\" alt=\"\"><br>\næ›´æ–°è¡¨åï¼Œå°†æ•°æ®è¡¨åç§°ç”±t2æ”¹æˆt1ï¼Œä½¿ç”¨<code>RENAME TABLE t2 to t1;</code>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/23/98/23af300e09c2fd5afafe1cec849d7f98.png?wh=928*116\" alt=\"\"><br>\nå°†æ–°çš„æ•°æ®è¡¨t1å­˜å‚¨å¼•æ“æ”¹æˆInnoDBï¼Œä¸è¿‡ç›´æ¥ä¿®æ”¹çš„è¯ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d1/a6/d102e7ec02a228529b26bd070601b9a6.png?wh=1729*101\" alt=\"\"></p><h3>å…³é—­<code>innodb_force_recovery</code>ï¼Œå¹¶é‡å¯æ•°æ®åº“</h3><p>å› ä¸ºä¸Šé¢æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†MySQLé…ç½®æ–‡ä»¶ä¸­çš„<code>innodb_force_recovery=1</code>åˆ é™¤æ‰ï¼Œç„¶åé‡å¯æ•°æ®åº“ã€‚æœ€åå°†t1çš„å­˜å‚¨å¼•æ“æ”¹æˆInnoDBå³å¯ï¼Œä½¿ç”¨<code>ALTER TABLE t1 engine = InnoDB;</code>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ab/1b/abc06822471b4eb4036de1504840df1b.png?wh=1016*163\" alt=\"\"></p><h2>æ€»ç»“</h2><p>æˆ‘ä»¬åˆšæ‰äººå·¥æ¢å¤äº†æŸåçš„ibdæ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè™½ç„¶æ²¡æœ‰100%æ‰¾å›ï¼Œä½†æ˜¯ç›¸æ¯”äºæŸæ‰‹æ— æªæ¥è¯´ï¼Œå·²ç»æ˜¯ä¸å¹¸ä¸­çš„ä¸‡å¹¸ï¼Œè‡³å°‘æˆ‘ä»¬è¿˜å¯ä»¥æŠŠæ­£ç¡®çš„æ•°æ®é¡µä¸­çš„è®°å½•æˆåŠŸå¤‡ä»½å‡ºæ¥ï¼Œå°½å¯èƒ½æ¢å¤åŸæœ‰çš„æ•°æ®è¡¨ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç›¸ä¿¡ä½ åº”è¯¥å¯¹ibdæ–‡ä»¶ï¼Œä»¥åŠInnoDBè‡ªèº«çš„å¼ºåˆ¶æ¢å¤ï¼ˆForce Recoveryï¼‰æœºåˆ¶æœ‰æ›´æ·±çš„äº†è§£ã€‚</p><p>æ•°æ®è¡¨æŸåï¼Œä»¥åŠäººä¸ºçš„è¯¯åˆ é™¤éƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çœ‹åˆ°çš„æƒ…å†µï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½æŒ‡æœ›è¿æ°”ï¼Œæˆ–è€…è¯´æˆ‘ä»¬ä¸èƒ½ç¥ˆç¥·è¿™äº›äº‹æƒ…ä¸ä¼šå‘ç”Ÿã€‚åœ¨é‡åˆ°è¿™äº›æƒ…å†µçš„æ—¶å€™ï¼Œåº”è¯¥é€šè¿‡æœºåˆ¶å°½é‡ä¿è¯æ•°æ®åº“çš„å®‰å…¨ç¨³å®šè¿è¡Œã€‚è¿™ä¸ªè¿‡ç¨‹æœ€ä¸»è¦çš„å°±æ˜¯åº”è¯¥åŠæ—¶å¤‡ä»½ï¼Œå¹¶ä¸”å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè¿™æ ·å½“æœ‰è¯¯æ“ä½œçš„æ—¶å€™å°±å¯ä»¥é€šè¿‡æ•°æ®åº“å¤‡ä»½ä»¥åŠBinlogæ—¥å¿—æ¥å®Œæˆæ•°æ®æ¢å¤ã€‚åŒæ—¶é‡‡ç”¨å»¶è¿Ÿå¤‡ä»½çš„ç­–ç•¥ä¹Ÿå¯ä»¥å°½é‡æŠµå¾¡è¯¯æ“ä½œã€‚æ€»ä¹‹ï¼ŒåŠæ—¶å¤‡ä»½æ˜¯éå¸¸æœ‰å¿…è¦çš„æªæ–½ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦å®šæ—¶éªŒè¯å¤‡ä»½æ–‡ä»¶çš„æœ‰æ•ˆæ€§ï¼Œä¿è¯å¤‡ä»½æ–‡ä»¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚</p><p>å¦‚æœä½ é‡åˆ°äº†æ•°æ®åº“ibdæ–‡ä»¶æŸåçš„æƒ…å†µï¼Œå¹¶ä¸”æ²¡æœ‰é‡‡ç”¨ä»»ä½•çš„å¤‡ä»½ç­–ç•¥ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨InnoDBçš„å¼ºåˆ¶æ¢å¤æœºåˆ¶ï¼Œå¯åŠ¨MySQLå¹¶ä¸”å°†æŸåçš„æ•°æ®è¡¨è½¬å‚¨åˆ°MyISAMæ•°æ®è¡¨ä¸­ï¼Œå°½å¯èƒ½æ¢å¤å·²æœ‰çš„æ•°æ®ã€‚æ€»ä¹‹æœºåˆ¶æ¯”äººä¸ºæ›´é è°±ï¼Œæˆ‘ä»¬è¦ä¸ºé•¿æœŸçš„è¿è¥åšå¥½å……è¶³çš„å‡†å¤‡ã€‚ä¸€æ—¦å‘ç”Ÿäº†è¯¯æ“ä½œè¿™ç§ç´§æ€¥æƒ…å†µï¼Œä¸è¦æ…Œå¼ ï¼ŒåŠæ—¶é‡‡å–å¯¹åº”çš„æªæ–½æ‰æ˜¯æœ€é‡è¦çš„ã€‚</p><p><img src=\"\" alt=\"\"></p><p>ä»Šå¤©çš„å†…å®¹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæˆ‘æƒ³é—®é—®ï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œä½ æ˜¯å¦é‡åˆ°è¿‡è¯¯æ“ä½œçš„æƒ…å†µå‘¢ï¼Ÿä½ åˆæ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿé™¤äº†æˆ‘ä¸Šé¢ä»‹ç»çš„æœºåˆ¶å¤–ï¼Œè¿˜æœ‰å“ªäº›å¤‡ä»½çš„æœºåˆ¶å¯ä»¥å¢å¼ºæ•°æ®çš„å®‰å…¨æ€§ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå†™ä¸‹ä½ çš„æ€è€ƒï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–è€…åŒäº‹ï¼Œä¸€èµ·äº¤æµä¸€ä¸‹ã€‚</p>","neighbors":{"left":{"article_title":"35ä¸¨æ•°æ®åº“ä¸»ä»åŒæ­¥çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•è§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Ÿ","id":135697},"right":{"article_title":"37ä¸¨SQLæ³¨å…¥ï¼šä½ çš„SQLæ˜¯å¦‚ä½•è¢«æ³¨å…¥çš„ï¼Ÿ","id":137050}},"comments":[{"had_liked":false,"id":133740,"user_name":"Monday","can_delete":false,"product_type":"c1","uid":1250907,"ip_address":"","ucode":"77B9BACC783598","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","comment_is_top":false,"comment_ctime":1568644251,"is_pvip":false,"replies":[{"id":"53364","content":"å¯èƒ½æ–‡ä»¶éšè—äº†ï¼Œéœ€è¦å…ˆå°†éšè—æ–‡ä»¶è®¾ç½®ä¸ºè¯¾ä»¶ï¼Œç„¶ååœ¨C:\\ProgramData\\MySQL\\MySQL Server 8.0ä¸­æ‰¾åˆ°my.iniï¼Œç„¶åå†æ·»åŠ innodb_force_recoveryæ•°å€¼","user_name":"ä½œè€…å›å¤","user_name_real":"cy","uid":"1306094","ctime":1570428907,"ip_address":"","comment_id":133740,"utype":1}],"discussion_count":2,"race_medal":0,"score":"27338448027","product_id":100029501,"comment_content":"å¼€å¯innodb_force_recoveryåªèƒ½è¿›è¡Œæœ‰é™åˆ¶çš„selectæ“ä½œï¼Œé‚£åç»­çš„å››æ­¥ä¸­ï¼Œæ€ä¹ˆè¿˜èƒ½å†åˆ é™¤æ—§è¡¨ï¼Ÿ<br>ä¸Šç½‘æŸ¥çš„èµ„æ–™éƒ½æ˜¯innodb_force_recovery&gt;0æ—¶ï¼Œå¯ä»¥selectï¼Œcreateï¼Œdropä½†æ˜¯ä¸å¯ä»¥insertï¼Œupdateï¼Œdeleteã€‚ã€‚ã€‚æ¨windowsç³»ç»Ÿä¸‹å®‰è£…çš„mysqlæ²¡æ‰¾åˆ°åœ¨å“ªé‡Œè®¾ç½®innodb_force_recoveryçš„å€¼ï¼Œæ‰€ä»¥æ²¡éªŒè¯ã€‚ã€‚ã€‚","like_count":7,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467493,"discussion_content":"å¯èƒ½æ–‡ä»¶éšè—äº†ï¼Œéœ€è¦å…ˆå°†éšè—æ–‡ä»¶è®¾ç½®ä¸ºè¯¾ä»¶ï¼Œç„¶ååœ¨C:\\ProgramData\\MySQL\\MySQL Server 8.0ä¸­æ‰¾åˆ°my.iniï¼Œç„¶åå†æ·»åŠ innodb_force_recoveryæ•°å€¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570428907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1919541,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/4a/35/66caeed9.jpg","nickname":"å®Œç¾åšæŒ","note":"","ucode":"AE0261D8DDEF64","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377848,"discussion_content":"ç»™ä½ è®¤çœŸçš„æ€åº¦ç‚¹èµï¼ŒåŠ æ²¹~\nè¯è¯´æ–‡ä¸­æˆ‘çœ‹åˆ°åˆ é™¤æ“ä½œç”¨çš„å¥½åƒå°±æ˜¯ DROP TABLE t1ï¼Œè€ŒæŒ‰ç…§ä½ çš„è¯´æ³•â€œinnodb_force_recovery>0æ—¶ï¼Œå¯ä»¥selectï¼Œcreateï¼Œdropâ€ã€‚\nå¦å¤–ï¼Œè€å¸ˆè¯´è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®innodb_force_recoveryçš„å€¼ï¼Œå…·ä½“çš„æ–¹æ³•ï¼ŒåŸè¯æ˜¯â€œä¸ºäº†èƒ½è¯»å–åˆ°æ•°æ®è¡¨ä¸­çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ MySQL çš„é…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ°[mysqld]çš„ä½ç½®ï¼Œç„¶åå†ä¸‹é¢å¢åŠ ä¸€è¡Œinnodb_force_recovery=1â€ã€‚\nä¸çŸ¥é“ä½ å®‰è£…mysqlçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰åœ¨mysqlçš„æ–‡ä»¶ä¸‹è‡ªå·±åˆ›å»ºä¸€ä¸ª my.ini æ–‡ä»¶ï¼Œæˆ‘æ˜¯æŒ‰ç…§ https://www.bilibili.com/video/BV1VE411x7fZ?t=999 ä¸­æåˆ°çš„æ–¹æ³•è¿›è¡Œå®‰è£…çš„ï¼Œé‡Œé¢å°±æœ‰æåˆ°è¿™ä¸ªæ–‡ä»¶ã€‚\næˆ‘æ²¡æœ‰å…·ä½“å®ç°æ–‡ä¸­çš„æ¨¡æ‹Ÿè¿‡ç¨‹ï¼Œä½†æ˜¯æˆ‘æ€€ç–‘å¯èƒ½è€å¸ˆè¯´çš„å°±æ˜¯åœ¨è¿™ä¸ªmy.ini æ–‡ä»¶ä¸­è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ã€‚\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æƒ³è¯·æ•™å¤§å®¶ï¼Œæ–‡ä¸­æåˆ°çš„ â€œç„¶åç”¨ç¼–è¾‘å™¨æ‰“å¼€ t1.ibdâ€ï¼Œè¿™é‡Œçš„ç¼–è¾‘å™¨æ˜¯ä»€ä¹ˆç¼–è¾‘å™¨å•Šï¼Ÿ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1622906799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204075,"user_name":"Cookie123456","can_delete":false,"product_type":"c1","uid":1913261,"ip_address":"","ucode":"F9EF63C38F8976","user_header":"","comment_is_top":false,"comment_ctime":1586330120,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"18766199304","product_id":100029501,"comment_content":"åˆ›å»ºçš„å­˜å‚¨è¿‡ç¨‹çš„å®Œæ•´ä»£ç ä¸ºï¼š<br>DELIMITER $$<br>CREATE PROCEDURE `insert_t1`(IN i int, IN max_num int)<br>BEGIN <br>-- å½“å‰æ•°æ®è¡Œ<br>DECLARE i INT DEFAULT 0;<br>-- æœ€å¤§æ•°æ®è¡Œæ•°<br>DECLARE max_num INT DEFAULT 100;<br>-- å…³é—­è‡ªåŠ¨æäº¤<br>SET autocommit=0;<br>REPEAT<br>SET i=i+1;<br>-- å‘t1è¡¨ä¸­æ’å…¥æ•°æ®<br>INSERT INTO t1(id) VALUES(i);<br>UNTIL i = max_num<br>END REPEAT;<br>-- æäº¤äº‹åŠ¡<br>COMMIT;<br>END $$<br><br>CALL insert_t1(0,100);<br>SELECT @i as sum;<br>","like_count":5,"discussions":[{"author":{"id":1474214,"avatar":"https://static001.geekbang.org/account/avatar/00/16/7e/a6/4e331ef4.jpg","nickname":"éª‘è¡Œçš„æŒæŸœJ","note":"","ucode":"3163102651C653","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":270663,"discussion_content":"è°¢å…„å¼Ÿ ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590034529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1716015,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/2f/2f/f434b676.jpg","nickname":"èƒŒé å’¸ğŸŸé‡è§ğŸ±","note":"","ucode":"30113675864F23","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":409340,"discussion_content":"mysqlæ˜¯æ²¡æœ‰åŒ¿åå—çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635422086,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133557,"user_name":"è®¸ç«¥ç«¥","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1568604447,"is_pvip":false,"replies":[{"id":"53365","content":"ä½¿å¾— å¯ä»¥ä½¿ç”¨æ¢å¤å·¥å…·","user_name":"ä½œè€…å›å¤","user_name_real":"cy","uid":"1306094","ctime":1570428975,"ip_address":"","comment_id":133557,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18748473631","product_id":100029501,"comment_content":"ç£ç›˜ä¹Ÿæ˜¯é€»è¾‘åˆ é™¤ï¼Œåªè¦æ–‡ä»¶è¿˜æ²¡æœ‰è¢«è¦†ç›–å†™ï¼Œä¹Ÿæ˜¯å¯ä»¥é€šè¿‡ç‰©ç†çš„æ–¹å¼æŠŠæ•°æ®æ‰¾å›æ¥çš„ã€‚","like_count":5,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467427,"discussion_content":"ä½¿å¾— å¯ä»¥ä½¿ç”¨æ¢å¤å·¥å…·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570428975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207571,"user_name":"Jone_ä¹”æ³“æº","can_delete":false,"product_type":"c1","uid":1407941,"ip_address":"","ucode":"158154301D5E40","user_header":"https://static001.geekbang.org/account/avatar/00/15/7b/c5/35f92dad.jpg","comment_is_top":false,"comment_ctime":1587110807,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14472012695","product_id":100029501,"comment_content":"è¯·é—®ä»€ä¹ˆæƒ…å†µä¼šå¯¼è‡´.ibdæ–‡ä»¶æŸåå‘¢ï¼Ÿ","like_count":4},{"had_liked":false,"id":133498,"user_name":"è’™å¼€å¼º","can_delete":false,"product_type":"c1","uid":1317706,"ip_address":"","ucode":"61B3183781B9F7","user_header":"https://static001.geekbang.org/account/avatar/00/14/1b/4a/f9df2d06.jpg","comment_is_top":false,"comment_ctime":1568594398,"is_pvip":false,"replies":[{"id":"53367","content":"å¯¹ MySQLä¸­å­˜å‚¨å¼•æ“æ˜¯é’ˆå¯¹æ•°æ®è¡¨çš„","user_name":"ä½œè€…å›å¤","user_name_real":"cy","uid":"1306094","ctime":1570429028,"ip_address":"","comment_id":133498,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14453496286","product_id":100029501,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼Œé‚£ä¸ªå­˜å‚¨å¼•æ“æ˜¯å¯ä»¥é’ˆå¯¹è¡¨çº§è®¾å®šçš„ä¹ˆ","like_count":4,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467404,"discussion_content":"å¯¹ MySQLä¸­å­˜å‚¨å¼•æ“æ˜¯é’ˆå¯¹æ•°æ®è¡¨çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570429028,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"ä¸€æ­¥","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":13505,"discussion_content":"å¯ä»¥é’ˆå¯¹è¡¨çº§åˆ«çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568681804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151756,"user_name":"éš°æœ‰è·","can_delete":false,"product_type":"c1","uid":1357944,"ip_address":"","ucode":"2BE9A32AB28963","user_header":"https://static001.geekbang.org/account/avatar/00/14/b8/78/2828195b.jpg","comment_is_top":false,"comment_ctime":1573785884,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10163720476","product_id":100029501,"comment_content":"è€å¸ˆï¼Œæˆ‘åœ¨ä½¿ç”¨ibdæ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤æ—¶ï¼Œè¿›å…¥äº†my.cnfæ–‡ä»¶ï¼Œ<br>ç„¶åè®¾ç½®äº†innodb_force_recovery = 1ï¼Œå†é‡æ–°å¯åŠ¨Mysqlå‘ç°æ— æ³•å¯åŠ¨ï¼Œç„¶ååœ¨logé‡Œé¢çœ‹åˆ°ä¸‹é¢è¿™å¥è¯ï¼š<br> [ERROR] &#47;usr&#47;sbin&#47;mysqld: unknown variable &#39;innodb_force_recoveryâ€‚=â€‚1<br><br>æˆ‘å»ç½‘ä¸Šæœç´¢è¿™ä¸ªæŠ¥é”™ï¼Œä½†æ˜¯ç›®å‰æ²¡æœ‰å‘ç°å¥½çš„è§£å†³åŠæ³•ï¼Œè¯·é—®æˆ‘è¯¥æ€ä¹ˆæ ·ç»§ç»­æ“ä½œå‘¢ï¼Œå³ä½¿æ— æ³•è·å–æ•°æ®ï¼Œèƒ½è·å–åŸæ¥çš„æ•°æ®è¡¨ç»“æ„ä¹Ÿæ˜¯å¥½çš„ï¼Œå¸Œæœ›è·å–æ‚¨çš„æŒ‡å¯¼ã€‚","like_count":3},{"had_liked":false,"id":183708,"user_name":"å››å–œ","can_delete":false,"product_type":"c1","uid":1071389,"ip_address":"","ucode":"C5EBED19C0F332","user_header":"https://static001.geekbang.org/account/avatar/00/10/59/1d/c89abcd8.jpg","comment_is_top":false,"comment_ctime":1583118618,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5878085914","product_id":100029501,"comment_content":"è‡ªå·±éšä¾¿æ”¹äº†idbæ–‡ä»¶é åé¢çš„2è¡Œï¼Œåªèƒ½è¯»å–åˆ°ç¬¬ä¸€æ¡æ•°æ®ã€‚","like_count":2},{"had_liked":false,"id":174704,"user_name":"CrazyCodes","can_delete":false,"product_type":"c1","uid":1081205,"ip_address":"","ucode":"C9C0E72522EB5B","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/75/551c5d6c.jpg","comment_is_top":false,"comment_ctime":1580357009,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5875324305","product_id":100029501,"comment_content":"å¼€å¯äºŒè¿›åˆ¶ä¼šä¸ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“<br>","like_count":1},{"had_liked":false,"id":171607,"user_name":"rike","can_delete":false,"product_type":"c1","uid":1583833,"ip_address":"","ucode":"920AAD0BD9245C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/E3XKbwTv6WTssolgqZjZCkiazHgl2IdBYfwVfAcB7Ff3krsIQeBIBFQLQE1Kw91LFbl3lic2EzgdfNiciaYDlJlELA/132","comment_is_top":false,"comment_ctime":1578974744,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5873942040","product_id":100029501,"comment_content":"æŒ‰ç…§é“¾æ¥ä¸­çš„æ•°æ®åº“æ–‡ä»¶ï¼Œåœ¨æ•°æ®åº“é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½®å‚æ•°åï¼Œæ— æ³•å¯åŠ¨ã€‚æŠ¥é”™<br>[FATAL] Tablespace id is 1477 in the data dictionary but in file .&#47;wucai&#47;t1.ibd it is 83!","like_count":1},{"had_liked":false,"id":144712,"user_name":"çˆ±æ€è€ƒçš„ä»™äººçƒ","can_delete":false,"product_type":"c1","uid":1576177,"ip_address":"","ucode":"77E31190A5B5AF","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/ic8KF0sfxicsx4F25HZrtZwP2fQEibicfibFeYIQBibxnVlHIiaqkfictJuvLCKia0p7liaQvbTzCYWLibjJK6B8kc8e194ng/132","comment_is_top":false,"comment_ctime":1572005444,"is_pvip":false,"replies":[{"id":"62695","content":"æ•°æ®æŸåæ˜¯ä¸€ç§å¯èƒ½","user_name":"ä½œè€…å›å¤","user_name_real":"cy","uid":"1306094","ctime":1577084771,"ip_address":"","comment_id":144712,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5866972740","product_id":100029501,"comment_content":"åŸæ¥ä¸¢å¤±æ•°æ®è¿æ¥è¿™ä¸ªé”™è¯¯æ˜¯ç”±äºæ•°æ®æŸåé€ æˆçš„","like_count":2,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472078,"discussion_content":"æ•°æ®æŸåæ˜¯ä¸€ç§å¯èƒ½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577084771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142055,"user_name":"Venom","can_delete":false,"product_type":"c1","uid":1187061,"ip_address":"","ucode":"2055AC6F322781","user_header":"https://static001.geekbang.org/account/avatar/00/12/1c/f5/fd386689.jpg","comment_is_top":false,"comment_ctime":1571284762,"is_pvip":false,"replies":[{"id":"63487","content":"æœ‰äº›ä»£ç æ”¾åˆ°githubä¸Šäº†ï¼Œå¯ä»¥çœ‹ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"cy","uid":"1306094","ctime":1577514220,"ip_address":"","comment_id":142055,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5866252058","product_id":100029501,"comment_content":"ä»£ç å¯ä¸å¯ä»¥éƒ½æ”¾ä¸Šæ¥å‘€ å°‘ä¸€å¥åˆ›å»ºå­˜å‚¨è¿‡ç¨‹çš„è¯­å¥ä¹Ÿå¾ˆéº»çƒ¦çš„ã€‚ã€‚ã€‚","like_count":1,"discussions":[{"author":{"id":1306094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ed/ee/c4779b67.jpg","nickname":"cy","note":"","ucode":"50D653399A31F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470970,"discussion_content":"æœ‰äº›ä»£ç æ”¾åˆ°githubä¸Šäº†ï¼Œå¯ä»¥çœ‹ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577514220,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":134077,"user_name":"ç©ºçŸ¥","can_delete":false,"product_type":"c1","uid":1013283,"ip_address":"","ucode":"C448E98238DD36","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg","comment_is_top":false,"comment_ctime":1568734091,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5863701387","product_id":100029501,"comment_content":"å¦‚æœ ibdæ–‡ä»¶æŸåçš„æ•°æ®åœ¨å¼€å¤´ï¼Œé‚£ä¼šéƒ½selectä¸å‡ºæ¥å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1440095,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f9/5f/a0a882a0.jpg","nickname":"çº³å·","note":"","ucode":"D2ACBBEA997AF9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":133792,"discussion_content":"å¯ä»¥select  * from  tab  limit   n,m (è·³è¿‡)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578989563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":310836,"user_name":"TheOne","can_delete":false,"product_type":"c1","uid":1582134,"ip_address":"","ucode":"2A359780156A8B","user_header":"https://static001.geekbang.org/account/avatar/00/18/24/36/1c4af368.jpg","comment_is_top":false,"comment_ctime":1630929336,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630929336","product_id":100029501,"comment_content":"ç£ç›˜é‡Œçš„æ•°æ®ä¹Ÿæ˜¯é€»è¾‘åˆ é™¤ï¼Œä½†æ˜¯æ’å…¥å¤šäº†é€»è¾‘åˆ é™¤çš„æ•°æ®ä¹Ÿå°±å½»åº•æ²¡äº†","like_count":0},{"had_liked":false,"id":296344,"user_name":"å®Œç¾åšæŒ","can_delete":false,"product_type":"c1","uid":1919541,"ip_address":"","ucode":"AE0261D8DDEF64","user_header":"https://static001.geekbang.org/account/avatar/00/1d/4a/35/66caeed9.jpg","comment_is_top":false,"comment_ctime":1622907905,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622907905","product_id":100029501,"comment_content":"æƒ³è¯·æ•™å¤§å®¶ï¼Œæ–‡ä¸­æåˆ°çš„ â€œç„¶åç”¨ç¼–è¾‘å™¨æ‰“å¼€ t1.ibdâ€ï¼Œè¿™é‡Œçš„ç¼–è¾‘å™¨æ˜¯ä»€ä¹ˆç¼–è¾‘å™¨å•Šï¼Ÿ","like_count":1}]}