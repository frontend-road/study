{"id":529910,"title":"44ï½œRESTful Web Servicesï¼ˆ8ï¼‰ï¼šå¦‚ä½•åœ¨ç°æœ‰ä»£ç çš„åŸºç¡€ä¸Šæ„é€ æµ‹è¯•ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¾æ˜Šã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨TDDçš„æ–¹å¼å®ç°RESTful Web Servicesã€‚</p><h2>å›é¡¾æ¶æ„æ„¿æ™¯ä¸ä»»åŠ¡åˆ—è¡¨</h2><p>ç›®å‰æˆ‘ä»¬çš„æ¶æ„æ„¿æ™¯å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/ay/6b/ayy42af78d776e59ecfb351b86f5ff6b.jpg?wh=8000x4500\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/01/ee/014f16b122d581f0936e236d94dcc4ee.jpeg?wh=8000x4500\" alt=\"\"></p><p>ä»»åŠ¡åˆ—è¡¨ä¸ºï¼š</p><ul>\n<li>\n<p>ResourceServlet</p>\n<ul>\n<li>\n<p>å°†è¯·æ±‚æ´¾åˆ†ç»™å¯¹åº”çš„èµ„æºï¼ˆResourceï¼‰ï¼Œå¹¶æ ¹æ®è¿”å›çš„çŠ¶æ€ã€è¶…åª’ä½“ç±»å‹ã€å†…å®¹ï¼Œå“åº”Httpè¯·æ±‚</p>\n<ul>\n<li><s>ä½¿ç”¨OutboundResponseçš„statusä½œä¸ºHttp Responseçš„çŠ¶æ€</s></li>\n<li><s>ä½¿ç”¨OutboundResponseçš„headersä½œä¸ºHttp Responseçš„Http Headers</s></li>\n<li><s>é€šè¿‡MessageBodyWriterå°†OutboundResponseçš„GenericEntityå†™å›ä¸ºBody</s></li>\n<li>å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„MessageBodyWriterï¼Œåˆ™è¿”å›500æ—é”™è¯¯</li>\n<li>å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„HeaderDelegateï¼Œåˆ™è¿”å›500æ—é”™è¯¯</li>\n<li>å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„ExceptionMapperï¼Œåˆ™è¿”å›500æ—é”™è¯¯</li>\n<li><s>å¦‚æœentityä¸ºç©ºï¼Œåˆ™å¿½ç•¥body</s></li>\n</ul>\n</li>\n<li>\n<p><s>å½“èµ„æºæ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œæ ¹æ®å¼‚å¸¸å“åº”Httpè¯·æ±‚</s></p>\n<ul>\n<li><s>å¦‚æœæŠ›å‡ºWebApplicationExceptionï¼Œä¸”responseä¸ä¸ºnullï¼Œåˆ™ä½¿ç”¨responseå“åº”Http</s></li>\n<li><s>å¦‚æœæŠ›å‡ºçš„ä¸æ˜¯WebApplicationExceptionï¼Œåˆ™é€šè¿‡å¼‚å¸¸çš„å…·ä½“ç±»å‹æŸ¥æ‰¾ExceptionMapperï¼Œç”Ÿäº§responseå“åº”Httpè¯·æ±‚</s></li>\n</ul>\n</li>\n<li>\n<p>å½“å…¶ä»–ç»„ä»¶æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œæ ¹æ®å¼‚å¸¸å“åº”Httpè¯·æ±‚</p>\n<ul>\n<li>è°ƒç”¨ExceptionMapperæ—¶</li>\n<li>è°ƒç”¨HeaderDelegateæ—¶</li>\n<li>è°ƒç”¨MessageBodyWriteræ—¶</li>\n<li>é€šè¿‡ProvidersæŸ¥æ‰¾ExceptionMapperæ—¶</li>\n<li>é€šè¿‡ProvidersæŸ¥æ‰¾MessageBodyWriteræ—¶</li>\n<li>é€šè¿‡RuntimeDelegateæŸ¥æ‰¾HeaderDelegateæ—¶</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>RuntimeDelegate</p>\n<ul>\n<li>ä¸ºMediaTypeæä¾›HeaderDelegate</li>\n<li>ä¸ºCacheControlæä¾›HeaderDelegate</li>\n<li>ä¸ºCookieæä¾›HeaderDelegates</li>\n<li>ä¸ºEntityTagæä¾›HeaderDelegate</li>\n<li>ä¸ºLinkæä¾›HeaderDelegate</li>\n<li>ä¸ºNewCookieæä¾›HeaderDelegate</li>\n<li>ä¸ºDateæä¾›HeaderDelegate</li>\n<li>æä¾›OutboundResponseBuilder</li>\n</ul>\n</li>\n<li>\n<p>OutboundResponseBuilder</p>\n</li>\n<li>\n<p>OutboundResponse</p>\n</li>\n</ul><!-- [[[read_end]]] --><p>ä»£ç ä¸ºï¼š</p><pre><code>package geektime.tdd.rest;\n\nimport jakarta.servlet.ServletException;\nimport jakarta.servlet.http.HttpServlet;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport jakarta.ws.rs.WebApplicationException;\nimport jakarta.ws.rs.core.GenericEntity;\nimport jakarta.ws.rs.core.MultivaluedMap;\nimport jakarta.ws.rs.ext.ExceptionMapper;\nimport jakarta.ws.rs.ext.MessageBodyWriter;\nimport jakarta.ws.rs.ext.Providers;\nimport jakarta.ws.rs.ext.RuntimeDelegate;\nimport java.io.IOException;\nimport java.util.function.Supplier;\n\npublic class ResourceServlet extends HttpServlet {\n    private Runtime runtime;\n    private Providers providers;\n    \n    public ResourceServlet(Runtime runtime) {\n        this.runtime = runtime;\n        this.providers = runtime.getProviders();\n    }\n    \n    @Override\n    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {\n        ResourceRouter router = runtime.getResourceRouter();\n        respond(resp, () -&gt; router.dispatch(req, runtime.createResourceContext(req, resp)));\n    }\n    \n    private void respond(HttpServletResponse resp, Supplier&lt;OutboundResponse&gt; supplier) {\n        try {\n            respond(resp, supplier.get());\n        } catch (WebApplicationException exception) {\n            respond(resp, () -&gt; (OutboundResponse) exception.getResponse());\n        } catch (Throwable throwable) {\n            respond(resp, () -&gt; from(throwable));\n        }\n    }\n    \n    private void respond(HttpServletResponse resp, OutboundResponse response) throws IOException {\n        resp.setStatus(response.getStatus());\n        MultivaluedMap&lt;String, Object&gt; headers = response.getHeaders();\n        for (String name : headers.keySet())\n            for (Object value : headers.get(name)) {\n                RuntimeDelegate.HeaderDelegate headerDelegate = RuntimeDelegate.getInstance().createHeaderDelegate(value.getClass());\n                resp.addHeader(name, headerDelegate.toString(value));\n            }\n        GenericEntity entity = response.getGenericEntity();\n        if (entity != null) {\n            MessageBodyWriter writer = providers.getMessageBodyWriter(entity.getRawType(), entity.getType(), response.getAnnotations(), response.getMediaType());\n            writer.writeTo(entity.getEntity(), entity.getRawType(), entity.getType(), response.getAnnotations(), response.getMediaType(),\n                    response.getHeaders(), resp.getOutputStream());\n        }\n    }\n    \n    private OutboundResponse from(Throwable throwable) {\n        ExceptionMapper mapper = providers.getExceptionMapper(throwable.getClass());\n        return (OutboundResponse) mapper.toResponse(throwable);\n    }\n}\n</code></pre><h2>è§†é¢‘æ¼”ç¤º</h2><p>ä¸‹é¢è®©æˆ‘ä»¬ç»§ç»­ï¼š</p><p><video poster=\"https://media001.geekbang.org/5f3a84e1f0c04e6f9d28dd163ee4e3df/snapshots/871fd3abb22042bdb2e0239bc0c2893b-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/253a1469-1817f405d74-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/a4436d919158407aa461780fa50e2d6b/dcf6e09e50514eed9d4625eb1ccbb769-c3215a7a9e4de6a652e33ba139f3ceae-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><h2>æ€è€ƒé¢˜</h2><p>åœ¨è¿›å…¥ä¸‹èŠ‚è¯¾ä¹‹å‰ï¼Œå¸Œæœ›ä½ èƒ½è®¤çœŸæ€è€ƒå¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚</p><ol>\n<li>è¯·ä¾æ®è§†é¢‘æ¼”ç¤ºä¸­çš„åšæ³•ï¼Œç»§ç»­å¯¹æµ‹è¯•ä»£ç è¿›è¡Œé‡æ„ã€‚</li>\n<li>æˆ‘çŸ¥é“ä¸å°‘åŒå­¦åœ¨å­¦ä¹ è¯¾ç¨‹çš„åŒæ—¶ï¼Œè¿˜è¡¥ä¹ äº†å¾ˆå¤šç›¸å…³çŸ¥è¯†ï¼Œé‚£ä¹ˆå¾ˆæ¬¢è¿æŠŠä½ çš„ä¹¦å•åˆ†äº«å‡ºæ¥ï¼Œä¾›å…¶ä»–åŒå­¦å‚è€ƒã€‚</li>\n</ol><p>ä¹Ÿæ¬¢è¿æŠŠä½ çš„é¡¹ç›®ä»£ç åˆ†äº«å‡ºæ¥ã€‚ç›¸ä¿¡ç»è¿‡ä½ çš„æ€è€ƒä¸å®æ“ï¼Œå­¦ä¹ æ•ˆæœä¼šæ›´å¥½ï¼</p>","neighbors":{"left":{"article_title":"43ï½œRESTful Web Servicesï¼ˆ7ï¼‰ï¼šå‰©ä¸‹ä¸¤ä¸ªSad Pathåœºæ™¯è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ","id":526946},"right":{"article_title":"45ï½œRESTful Web Servicesï¼ˆ9ï¼‰ï¼šé€šè¿‡ä¼¦æ•¦å­¦æ´¾å¾—åˆ°çš„æµ‹è¯•é£æ ¼æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ","id":529932}},"comments":[{"had_liked":false,"id":355553,"user_name":"Luke","can_delete":false,"product_type":"c1","uid":1004462,"ip_address":"åŒ—äº¬","ucode":"8F7DE6E7B3D74F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/53/ae/a08024b2.jpg","comment_is_top":false,"comment_ctime":1661491762,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1661491762","product_id":100109401,"comment_content":"è¸©äº†ä¸ªå‘ã€‚å¦‚æœæµ‹è¯•æ—¶é‡åˆ° StackOverflowError çš„ï¼Œçœ‹çœ‹ stub çš„ OutboundResponse æ˜¯å¦éƒ½æ˜¯é»˜è®¤å€¼ã€‚","like_count":0,"discussions":[{"author":{"id":1027207,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ac/87/8ed5880a.jpg","nickname":"å¤§ç¢—","note":"","ucode":"F9CDC0C5BE48AC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586958,"discussion_content":"æ”¹æˆ repsonse()ï¼Œä¸ç„¶ä¼šå¾ªç¯è°ƒç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662626812,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":350271,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1656740388,"is_pvip":false,"replies":[{"id":"127874","content":"å“ˆå“ˆå“ˆå¾è€å¸ˆå¾ˆå¤šæ“ä½œéƒ½åˆ·æ–°äº†æˆ‘çš„è®¤çŸ¥ï¼","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":"2189689","ctime":1658043050,"ip_address":"","comment_id":350271,"utype":2}],"discussion_count":1,"race_medal":0,"score":"1656740388","product_id":100109401,"comment_content":"@TestFactory + æ ‡ç­¾ + åå°„åˆ·æ–°äº†æˆ‘å¯¹è‡ªåŠ¨åŒ–æµ‹è¯•è®¤çŸ¥ï¼","like_count":0,"discussions":[{"author":{"id":2189689,"avatar":"https://static001.geekbang.org/account/avatar/00/21/69/79/b4132042.jpg","nickname":"ğŸ‘","note":"","ucode":"DE34B3B14287D1","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580251,"discussion_content":"å“ˆå“ˆå“ˆå¾è€å¸ˆå¾ˆå¤šæ“ä½œéƒ½åˆ·æ–°äº†æˆ‘çš„è®¤çŸ¥ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658043051,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":349953,"user_name":"æ«ä¸­çš„åˆ€å‰‘","can_delete":false,"product_type":"c1","uid":1322387,"ip_address":"","ucode":"4B086F538184AA","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/93/0f1cbf44.jpg","comment_is_top":false,"comment_ctime":1656469788,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1656469788","product_id":100109401,"comment_content":"çœ‹è€å¸ˆé‡æ„ä»£ç æ˜¯çœŸçš„èˆ’æœï¼Œä¿¡æ‰‹æ‹ˆæ¥ï¼Œä¸€æ°”å‘µæˆã€‚<br>åŠ¨æ€æµ‹è¯•é…åˆå‡½æ•°å¼è¿˜èƒ½è¿™ä¹ˆç”¨ï¼Œå­¦åˆ°äº†ã€‚","like_count":0}]}