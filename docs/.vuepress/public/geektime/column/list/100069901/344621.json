{"id":344621,"title":"15 | å†…å­˜ï¼šä¸ºä»€ä¹ˆä½ çš„etcdå†…å­˜å ç”¨é‚£ä¹ˆé«˜ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å”èªã€‚</p><p>åœ¨ä½¿ç”¨etcdçš„è¿‡ç¨‹ä¸­ï¼Œä½ æ˜¯å¦è¢«å¼‚å¸¸å†…å­˜å ç”¨ç­‰ç°è±¡å›°æ‰°è¿‡ï¼Ÿæ¯”å¦‚etcdä¸­åªä¿å­˜äº†1ä¸ª1MBçš„key-valueï¼Œä½†æ˜¯ç»è¿‡è‹¥å¹²æ¬¡ä¿®æ”¹åï¼Œæœ€ç»ˆetcdå†…å­˜å¯èƒ½è¾¾åˆ°æ•°Gã€‚å®ƒæ˜¯ç”±ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼Ÿå¦‚ä½•åˆ†æå‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯æˆ‘ä»Šå¤©è¦å’Œä½ åˆ†äº«çš„ä¸»é¢˜ï¼šetcdçš„å†…å­˜ã€‚ å¸Œæœ›é€šè¿‡è¿™èŠ‚è¯¾ï¼Œå¸®åŠ©ä½ æŒæ¡etcdå†…å­˜æŠ–åŠ¨ã€å¼‚å¸¸èƒŒåçš„å¸¸è§åŸå› å’Œåˆ†ææ–¹æ³•ï¼Œå½“ä½ é‡åˆ°ç±»ä¼¼é—®é¢˜æ—¶ï¼Œèƒ½ç‹¬ç«‹å®šä½ã€è§£å†³ã€‚åŒæ—¶ï¼Œå¸®åŠ©ä½ åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸ºé›†ç¾¤èŠ‚ç‚¹é…ç½®å……è¶³çš„å†…å­˜èµ„æºï¼Œéµå¾ªæœ€ä½³å®è·µï¼Œå°½é‡å‡å°‘expensive requestï¼Œé¿å…etcdå†…å­˜å‡ºç°çªå¢ï¼Œå¯¼è‡´OOMã€‚</p><h2>åˆ†ææ•´ä½“æ€è·¯</h2><p>å½“ä½ é‡åˆ°etcdå†…å­˜å ç”¨è¾ƒé«˜çš„æ¡ˆä¾‹æ—¶ï¼Œä½ è„‘æµ·ä¸­ç¬¬ä¸€ååº”æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ä¹Ÿè®¸ä½ ä¼šç«‹åˆ»é‡å¯etcdè¿›ç¨‹ï¼Œå°è¯•å°†å†…å­˜é™ä½åˆ°åˆç†æ°´å¹³ï¼Œé¿å…çº¿ä¸ŠæœåŠ¡å‡ºé—®é¢˜ã€‚</p><p>ä¹Ÿè®¸ä½ ä¼šå¼€å¯etcd debugæ¨¡å¼ï¼Œé‡å¯etcdè¿›ç¨‹ç­‰å¤ç°ï¼Œç„¶åé‡‡é›†heap profileåˆ†æå†…å­˜å ç”¨ã€‚</p><p>ä»¥ä¸Šæªæ–½éƒ½æœ‰å…¶åˆç†æ€§ã€‚ä½†ä½œä¸ºå›¢é˜Ÿå†…etcdé«˜æ‰‹çš„ä½ ï¼Œåœ¨é›†ç¾¤ç¨³å®šæ€§è¿˜ä¸å½±å“ä¸šåŠ¡çš„å‰æä¸‹ï¼Œèƒ½å¦å…ˆé€šè¿‡å†…å­˜å¼‚å¸¸çš„ç°åœºï¼Œç»“åˆetcdçš„è¯»å†™æµç¨‹ã€å„æ ¸å¿ƒæ¨¡å—ä¸­å¯èƒ½ä¼šä½¿ç”¨è¾ƒå¤šå†…å­˜çš„å…³é”®æ•°æ®ç»“æ„ï¼Œæ¨æµ‹å‡ºå†…å­˜å¼‚å¸¸çš„å¯èƒ½åŸå› ï¼Ÿ</p><p>å…¨æ–¹ä½çš„åˆ†æå†…å­˜å¼‚å¸¸ç°åœºï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬èŠ‚çœå¤§é‡å¤ç°å’Œå®šä½æ—¶é—´ï¼Œä¹Ÿæ˜¯ä½ ä¸“ä¸šæ€§çš„ä½“ç°ã€‚</p><!-- [[[read_end]]] --><p>ä¸‹å›¾æ˜¯æˆ‘ä»¥etcdå†™è¯·æ±‚æµç¨‹ä¸ºä¾‹ï¼Œç»™ä½ æ€»ç»“çš„å¯èƒ½å¯¼è‡´etcdå†…å­˜å ç”¨è¾ƒé«˜çš„æ ¸å¿ƒæ¨¡å—ä¸å…¶æ•°æ®ç»“æ„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c2/49/c2673ebb2db4b555a9fbe229ed1bda49.png?wh=1920*1056\" alt=\"\"></p><p>ä»å›¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œå½“etcdæ”¶åˆ°ä¸€ä¸ªå†™è¯·æ±‚åï¼ŒgRPC Serverä¼šå’Œä½ å»ºç«‹è¿æ¥ã€‚è¿æ¥æ•°è¶Šå¤šï¼Œä¼šå¯¼è‡´etcdè¿›ç¨‹çš„fdã€goroutineç­‰èµ„æºä¸Šæ¶¨ï¼Œå› æ­¤ä¼šä½¿ç”¨è¶Šæ¥è¶Šå¤šçš„å†…å­˜ã€‚</p><p>å…¶æ¬¡ï¼ŒåŸºäºæˆ‘ä»¬<a href=\"https://time.geekbang.org/column/article/337604\">04</a>ä»‹ç»çš„RaftçŸ¥è¯†èƒŒæ™¯ï¼Œå®ƒéœ€è¦å°†æ­¤è¯·æ±‚çš„æ—¥å¿—æ¡ç›®ä¿å­˜åœ¨raftLogé‡Œé¢ã€‚etcd raftLogåç«¯å®ç°æ˜¯å†…å­˜å­˜å‚¨ï¼Œæ ¸å¿ƒå°±æ˜¯æ•°ç»„ã€‚å› æ­¤raftLogä½¿ç”¨çš„å†…å­˜ä¸å…¶ä¿å­˜çš„æ—¥å¿—æ¡ç›®æˆæ­£æ¯”ï¼Œå®ƒä¹Ÿæ˜¯å†…å­˜åˆ†æè¿‡ç¨‹ä¸­æœ€å®¹æ˜“è¢«å¿½è§†çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>ç„¶åå½“æ­¤æ—¥å¿—æ¡ç›®è¢«é›†ç¾¤å¤šæ•°èŠ‚ç‚¹ç¡®è®¤åï¼Œåœ¨åº”ç”¨åˆ°çŠ¶æ€æœºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šåœ¨å†…å­˜treeIndexæ¨¡å—çš„B-treeä¸­åˆ›å»ºã€æ›´æ–°keyä¸ç‰ˆæœ¬å·ä¿¡æ¯ã€‚ åœ¨è¿™è¿‡ç¨‹ä¸­treeIndexæ¨¡å—çš„B-treeä½¿ç”¨çš„å†…å­˜ä¸keyã€å†å²ç‰ˆæœ¬å·æ•°é‡æˆæ­£æ¯”ã€‚</p><p>æ›´æ–°å®ŒtreeIndexæ¨¡å—çš„ç´¢å¼•ä¿¡æ¯åï¼Œetcdå°†key-valueæ•°æ®æŒä¹…åŒ–å­˜å‚¨åˆ°boltdbã€‚boltdbä½¿ç”¨äº†mmapæŠ€æœ¯ï¼Œå°†dbæ–‡ä»¶æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿå†…å­˜ä¸­ã€‚å› æ­¤åœ¨æœªè§¦å‘æ“ä½œç³»ç»Ÿå°†dbå¯¹åº”çš„å†…å­˜pageæ¢å‡ºçš„æƒ…å†µä¸‹ï¼Œetcdçš„dbæ–‡ä»¶è¶Šå¤§ï¼Œä½¿ç”¨çš„å†…å­˜ä¹Ÿå°±è¶Šå¤§ã€‚</p><p>åŒæ—¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¿˜æœ‰ä¸¤ä¸ªæ³¨æ„äº‹é¡¹ã€‚</p><p>ä¸€æ–¹é¢ï¼Œå…¶ä»–clientå¯èƒ½ä¼šåˆ›å»ºè‹¥å¹²watcherã€ç›‘å¬è¿™ä¸ªå†™è¯·æ±‚æ¶‰åŠçš„keyï¼Œ etcdä¹Ÿéœ€è¦ä½¿ç”¨ä¸€å®šçš„å†…å­˜ç»´æŠ¤watcherã€æ¨é€keyå˜åŒ–ç›‘å¬çš„äº‹ä»¶ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœè¿™ä¸ªå†™è¯·æ±‚çš„keyè¿˜å…³è”äº†Leaseï¼ŒLeaseæ¨¡å—ä¼šåœ¨å†…å­˜ä¸­ä½¿ç”¨æ•°æ®ç»“æ„Heapæ¥å¿«é€Ÿæ·˜æ±°è¿‡æœŸçš„Leaseï¼Œå› æ­¤Heapä¹Ÿæ˜¯ä¸€ä¸ªå ç”¨ä¸€å®šå†…å­˜çš„æ•°æ®ç»“æ„ã€‚</p><p>æœ€åï¼Œä¸ä»…ä»…æ˜¯å†™è¯·æ±‚æµç¨‹ä¼šå ç”¨å†…å­˜ï¼Œè¯»è¯·æ±‚æœ¬èº«ä¹Ÿä¼šå¯¼è‡´å†…å­˜ä¸Šå‡ã€‚å°¤å…¶æ˜¯expensive requestï¼Œå½“äº§ç”Ÿå¤§åŒ…æŸ¥è¯¢æ—¶ï¼ŒMVCCæ¨¡å—éœ€è¦ä½¿ç”¨å†…å­˜ä¿å­˜æŸ¥è¯¢çš„ç»“æœï¼Œå¾ˆå®¹æ˜“å¯¼è‡´å†…å­˜çªå¢ã€‚</p><p>åŸºäºä»¥ä¸Šè¯»å†™æµç¨‹å›¾å¯¹æ ¸å¿ƒæ•°æ®ç»“æ„ä½¿ç”¨å†…å­˜çš„åˆ†æï¼Œæˆ‘ä»¬å®šä½é—®é¢˜æ—¶å°±æœ‰çº¿ç´¢ã€æ–¹æ³•å¯å¾ªäº†ã€‚é‚£å¦‚ä½•ç¡®å®šæ˜¯å“ªä¸ªæ¨¡å—ã€åœºæ™¯å¯¼è‡´çš„å†…å­˜å¼‚å¸¸å‘¢ï¼Ÿ</p><p>æ¥ä¸‹æ¥æˆ‘å°±é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œå’Œä½ æ·±å…¥ä»‹ç»ä¸‹å†…å­˜å¼‚å¸¸çš„åˆ†ææ–¹æ³•ã€‚</p><h2>ä¸€ä¸ªkeyä½¿ç”¨æ•°Gå†…å­˜çš„æ¡ˆä¾‹</h2><p>æˆ‘ä»¬é€šè¿‡goremanå¯åŠ¨ä¸€ä¸ª3èŠ‚ç‚¹etcdé›†ç¾¤(linux/etcd v3.4.9)ï¼Œdb quotaä¸º6Gï¼Œæ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤å¹¶è§‚å¯Ÿetcdå†…å­˜å ç”¨æƒ…å†µï¼š</p><ul>\n<li>æ‰§è¡Œ1000æ¬¡çš„putåŒä¸€ä¸ªkeyæ“ä½œï¼Œvalueä¸º1MBï¼›</li>\n<li>æ›´æ–°å®Œåå¹¶è¿›è¡Œcompactã€defragæ“ä½œï¼›</li>\n</ul><pre><code># putåŒä¸€ä¸ªkeyï¼Œæ‰§è¡Œ1000æ¬¡\nfor i in {1..1000}; do dd if=/dev/urandom bs=1024 \ncount=1024  | ETCDCTL_API=3 etcdctl put key  || break; done\n\n# è·å–æœ€æ–°revisionï¼Œå¹¶å‹ç¼©\netcdctl compact `(etcdctl endpoint status --write-out=&quot;json&quot; | egrep -o '&quot;revision&quot;:[0-9]*' | egrep -o '[0-9].*')`\n\n# å¯¹é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œç¢ç‰‡æ•´ç†\netcdctl defrag --cluster\n</code></pre><p>åœ¨æ‰§è¡Œæ“ä½œå‰ï¼Œç©ºé›†ç¾¤etcd db size 20KBï¼Œetcdè¿›ç¨‹å†…å­˜36Må·¦å³ï¼Œåˆ†åˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c1/e6/c1fb89ae1d6218a66cf1db30c41d9be6.png?wh=1164*358\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/6c/6d/6ce074583f39cd9a19bdcb392133426d.png?wh=1318*420\" alt=\"\"></p><p>ä½ é¢„æµ‹æ‰§è¡Œ1000æ¬¡åŒæ ·keyæ›´æ–°åï¼Œetcdè¿›ç¨‹å ç”¨äº†å¤šå°‘å†…å­˜å‘¢? çº¦37Mï¼Ÿ 1Gï¼Ÿ 2Gï¼Ÿ3Gï¼Ÿ è¿˜æ˜¯å…¶ä»–å‘¢ï¼Ÿ</p><p>æ‰§è¡Œ1000æ¬¡çš„putæ“ä½œåï¼Œdbå¤§å°å’Œetcdå†…å­˜å ç”¨åˆ†åˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d6/45/d6dc86f76f52dfed73ab1771ebbbf545.png?wh=1302*348\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/9d/70/9d97762851c18a0c4cd89aa5a7bb0270.png?wh=1310*404\" alt=\"\"></p><p>å½“æˆ‘ä»¬æ‰§è¡Œcompactã€defragå‘½ä»¤åï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œdbå¤§å°åªæœ‰1Må·¦å³ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°etcdè¿›ç¨‹å®é™…å´ä»å ç”¨äº†2Gå·¦å³å†…å­˜ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/93/bd/937c3fb0bf12595928e8ae4b05b7a5bd.png?wh=1260*354\" alt=\"\"></p><p><img src=\"https://static001.geekbang.org/resource/image/8d/58/8d2d9fb3c0193745d80fe68b0cb4a758.png?wh=1276*406\" alt=\"\"></p><p>æ•´ä¸ªé›†ç¾¤åªæœ‰ä¸€ä¸ªkeyï¼Œä¸ºä»€ä¹ˆetcdå ç”¨äº†è¿™ä¹ˆå¤šçš„å†…å­˜å‘¢ï¼Ÿæ˜¯etcdå‘ç”Ÿäº†å†…å­˜æ³„éœ²å—ï¼Ÿ</p><h2>raftLog</h2><p>å½“ä½ å‘èµ·ä¸€ä¸ªputè¯·æ±‚çš„æ—¶å€™ï¼Œetcdéœ€é€šè¿‡Raftæ¨¡å—å°†æ­¤è¯·æ±‚åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œè¯¦ç»†æµç¨‹ä½ å¯ç»“åˆä¸‹å›¾å†æ¬¡äº†è§£ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/df/2c/df9yy18a1e28e18295cfc15a28cd342c.png?wh=1920*1328\" alt=\"\"></p><p>ä»å›¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼ŒRaftæ¨¡å—çš„è¾“å…¥æ˜¯ä¸€ä¸ªæ¶ˆæ¯/Msgï¼Œè¾“å‡ºç»Ÿä¸€ä¸ºReadyç»“æ„ã€‚etcdä¼šæŠŠæ­¤è¯·æ±‚å°è£…æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œæäº¤åˆ°Raftæ¨¡å—ã€‚</p><p>Raftæ¨¡å—æ”¶åˆ°æ­¤è¯·æ±‚åï¼Œä¼šæŠŠæ­¤æ¶ˆæ¯è¿½åŠ åˆ°raftLogçš„unstableå­˜å‚¨çš„entryå†…å­˜æ•°ç»„ä¸­ï¼ˆå›¾ä¸­æµç¨‹2ï¼‰ï¼Œå¹¶ä¸”å°†å¾…æŒä¹…åŒ–çš„æ­¤æ¶ˆæ¯å°è£…åˆ°Readyç»“æ„å†…ï¼Œé€šè¿‡ç®¡é“é€šçŸ¥åˆ°etcdserverï¼ˆå›¾ä¸­æµç¨‹3ï¼‰ã€‚</p><p>etcdserverå–å‡ºæ¶ˆæ¯ï¼ŒæŒä¹…åŒ–åˆ°WALä¸­ï¼Œå¹¶è¿½åŠ åˆ°raftLogçš„å†…å­˜å­˜å‚¨storageçš„entryæ•°ç»„ä¸­ï¼ˆå›¾ä¸­æµç¨‹5ï¼‰ã€‚</p><p>ä¸‹é¢æ˜¯<a href=\"https://github.com/etcd-io/etcd/blob/v3.4.9/raft/log.go#L24:L45\">raftLog</a>çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå®ƒç”±storageã€unstableã€committedã€appliedç­‰ç»„æˆã€‚storageå­˜å‚¨å·²ç»æŒä¹…åŒ–åˆ°WALä¸­çš„æ—¥å¿—æ¡ç›®ï¼Œunstableå­˜å‚¨æœªæŒä¹…åŒ–çš„æ¡ç›®å’Œå¿«ç…§ï¼Œä¸€æ—¦æŒä¹…åŒ–ä¼šåŠæ—¶åˆ é™¤æ—¥å¿—æ¡ç›®ï¼Œå› æ­¤ä¸å­˜åœ¨è¿‡å¤šå†…å­˜å ç”¨çš„é—®é¢˜ã€‚</p><pre><code>type raftLog struct {\n   // storage contains all stable entries since the last snapshot.\n   storage Storage\n\n\n   // unstable contains all unstable entries and snapshot.\n   // they will be saved into storage.\n   unstable unstable\n\n\n   // committed is the highest log position that is known to be in\n   // stable storage on a quorum of nodes.\n   committed uint64\n   // applied is the highest log position that the application has\n   // been instructed to apply to its state machine.\n   // Invariant: applied &lt;= committed\n   applied uint64\n}\n</code></pre><p>ä»ä¸Šé¢raftLogç»“æ„ä½“ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œå­˜å‚¨ç¨³å®šçš„æ—¥å¿—æ¡ç›®çš„storageç±»å‹æ˜¯Storageï¼ŒStorageå®šä¹‰äº†å­˜å‚¨Raftæ—¥å¿—æ¡ç›®çš„æ ¸å¿ƒAPIæ¥å£ï¼Œä¸šåŠ¡åº”ç”¨å±‚å¯æ ¹æ®å®é™…åœºæ™¯è¿›è¡Œå®šåˆ¶åŒ–å®ç°ã€‚etcdä½¿ç”¨çš„æ˜¯Raftç®—æ³•åº“æœ¬èº«æä¾›çš„MemoryStorageï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼Œæ ¸å¿ƒæ˜¯ä½¿ç”¨äº†ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨å·²ç»æŒä¹…åŒ–åçš„æ—¥å¿—æ¡ç›®ã€‚</p><pre><code>// MemoryStorage implements the Storage interface backed\n// by an in-memory array.\ntype MemoryStorage struct {\n   // Protects access to all fields. Most methods of MemoryStorage are\n   // run on the raft goroutineï¼Œ but Append() is run on an application\n   // goroutine.\n   sync.Mutex\n\n   hardState pb.HardState\n   snapshot  pb.Snapshot\n   // ents[i] has raftLog position i+snapshot.Metadata.Index\n   ents []pb.Entry\n}\n</code></pre><p>é‚£ä¹ˆéšç€å†™è¯·æ±‚å¢å¤šï¼Œå†…å­˜ä¸­ä¿ç•™çš„Raftæ—¥å¿—æ¡ç›®ä¼šè¶Šæ¥è¶Šå¤šï¼Œå¦‚ä½•é˜²æ­¢etcdå‡ºç°OOMå‘¢ï¼Ÿ</p><p>etcdæä¾›äº†å¿«ç…§å’Œå‹ç¼©åŠŸèƒ½æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>é¦–å…ˆä½ å¯ä»¥é€šè¿‡è°ƒæ•´--snapshot-countå‚æ•°æ¥æ§åˆ¶ç”Ÿæˆå¿«ç…§çš„é¢‘ç‡ï¼Œå…¶å€¼é»˜è®¤æ˜¯100000ï¼ˆetcd v3.4.9ï¼Œæ—©æœŸetcdç‰ˆæœ¬æ˜¯10000ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ¯10ä¸‡ä¸ªå†™è¯·æ±‚è§¦å‘ä¸€æ¬¡å¿«ç…§ç”Ÿæˆæ“ä½œã€‚</p><p>å¿«ç…§ç”Ÿæˆå®Œä¹‹åï¼Œetcdä¼šé€šè¿‡å‹ç¼©æ¥åˆ é™¤æ—§çš„æ—¥å¿—æ¡ç›®ã€‚</p><p>é‚£ä¹ˆæ˜¯å…¨éƒ¨åˆ é™¤æ—¥å¿—æ¡ç›®è¿˜æ˜¯ä¿ç•™ä¸€å°éƒ¨åˆ†å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¿ç•™ä¸€å°éƒ¨åˆ†Raftæ—¥å¿—æ¡ç›®ã€‚æ•°é‡ç”±DefaultSnapshotCatchUpEntrieså‚æ•°æ§åˆ¶ï¼Œé»˜è®¤5000ï¼Œç›®å‰ä¸æ”¯æŒè‡ªå®šä¹‰é…ç½®ã€‚</p><p>ä¿ç•™ä¸€å°éƒ¨åˆ†æ—¥å¿—æ¡ç›®å…¶å®æ˜¯ä¸ºäº†å¸®åŠ©æ…¢çš„Followerä»¥è¾ƒä½çš„å¼€é”€å‘Leaderè·å–Raftæ—¥å¿—æ¡ç›®ï¼Œä»¥å°½å¿«è¿½ä¸ŠLeaderè¿›åº¦ã€‚è‹¥raftLogä¸­ä¸ä¿ç•™ä»»ä½•æ—¥å¿—æ¡ç›®ï¼Œå°±åªèƒ½å‘é€å¿«ç…§ç»™æ…¢çš„Followerï¼Œè¿™å¼€é”€å°±éå¸¸å¤§äº†ã€‚</p><p>é€šè¿‡ä»¥ä¸Šåˆ†æå¯çŸ¥ï¼Œå¦‚æœä½ çš„è¯·æ±‚key-valueæ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚ä¸Šé¢æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­æ˜¯1Mï¼Œ1000æ¬¡ä¿®æ”¹ï¼Œé‚£ä¹ˆetcd raftLogè‡³å°‘ä¼šæ¶ˆè€—1Gçš„å†…å­˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå†…å­˜éšç€å†™è¯·æ±‚ä¿®æ”¹æ¬¡æ•°ä¸æ–­å¢é•¿çš„åŸå› ã€‚</p><p>é™¤äº†raftLogå ç”¨å†…å­˜å¤–ï¼ŒMVCCæ¨¡å—çš„treeIndex/boltdbæ¨¡å—åˆæ˜¯å¦‚ä½•ä½¿ç”¨å†…å­˜çš„å‘¢ï¼Ÿ</p><h2>treeIndex</h2><p>ä¸€ä¸ªputå†™è¯·æ±‚çš„æ—¥å¿—æ¡ç›®è¢«é›†ç¾¤å¤šæ•°èŠ‚ç‚¹ç¡®è®¤æäº¤åï¼Œè¿™æ—¶etcdserverå°±ä¼šä»Raftæ¨¡å—è·å–å·²æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œåº”ç”¨åˆ°MVCCæ¨¡å—çš„treeIndexå’Œboltdbã€‚</p><p>æˆ‘ä»¬çŸ¥é“treeIndexæ˜¯åŸºäºgoogleå†…å­˜btreeåº“å®ç°çš„ä¸€ä¸ªç´¢å¼•ç®¡ç†æ¨¡å—ï¼Œåœ¨etcdä¸­æ¯ä¸ªkeyéƒ½ä¼šåœ¨treeIndexä¸­ä¿å­˜ä¸€ä¸ªç´¢å¼•é¡¹(keyIndex)ï¼Œè®°å½•ä½ çš„keyå’Œç‰ˆæœ¬å·ç­‰ä¿¡æ¯ï¼Œå¦‚ä¸‹é¢çš„æ•°æ®ç»“æ„æ‰€ç¤ºã€‚</p><pre><code>type keyIndex struct {\n   key         []byte\n   modified    revision // the main rev of the last modification\n   generations []generation\n}\n</code></pre><p>åŒæ—¶ï¼Œä½ æ¯æ¬¡å¯¹keyçš„ä¿®æ”¹ã€åˆ é™¤æ“ä½œéƒ½ä¼šåœ¨keyçš„ç´¢å¼•é¡¹ä¸­è¿½åŠ ä¸€æ¡ä¿®æ”¹è®°å½•(revision)ã€‚å› æ­¤ï¼Œéšç€ä¿®æ”¹æ¬¡æ•°çš„å¢åŠ ï¼Œetcdå†…å­˜ä¼šä¸€ç›´å¢åŠ ã€‚é‚£ä¹ˆå¦‚ä½•æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œé˜²æ­¢è¿‡å¤šçš„å†…å­˜å ç”¨å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆä¹Ÿæ˜¯å‹ç¼©ã€‚æ­£å¦‚æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/342891\">11</a>å‹ç¼©ç¯‡å’Œä½ ä»‹ç»çš„ï¼Œå½“ä½ æ‰§è¡Œcompactå‘½ä»¤æ—¶ï¼Œetcdä¼šéå†treeIndexä¸­çš„å„ä¸ªkeyIndexï¼Œæ¸…ç†å†å²ç‰ˆæœ¬å·è®°å½•ä¸å·²åˆ é™¤çš„keyï¼Œé‡Šæ”¾å†…å­˜ã€‚</p><p>ä»ä¸Šé¢çš„keyIndexæ•°æ®ç»“æ„æˆ‘ä»¬å¯çŸ¥ï¼Œä¸€ä¸ªkeyçš„ç´¢å¼•é¡¹å†…å­˜å¼€é”€è·Ÿä½ çš„keyå¤§å°ã€ä¿å­˜çš„å†å²ç‰ˆæœ¬æ•°ã€compactç­–ç•¥æœ‰å…³ã€‚ä¸ºäº†é¿å…å†…å­˜ç´¢å¼•é¡¹å ç”¨è¿‡å¤šçš„å†…å­˜ï¼Œkeyçš„é•¿åº¦ä¸åº”è¿‡é•¿ï¼ŒåŒæ—¶ä½ éœ€è¦é…ç½®å¥½åˆç†çš„å‹ç¼©ç­–ç•¥ã€‚</p><h2>boltdb</h2><p>åœ¨treeIndexæ¨¡å—ä¸­åˆ›å»ºã€æ›´æ–°å®ŒkeyIndexæ•°æ®ç»“æ„åï¼Œä½ çš„key-valueæ•°æ®ã€å„ç§ç‰ˆæœ¬å·ã€leaseç­‰ç›¸å…³ä¿¡æ¯ä¼šä¿å­˜åˆ°å¦‚ä¸‹çš„ä¸€ä¸ªmvccpb.keyValueç»“æ„ä½“ä¸­ã€‚å®ƒæ˜¯boltdbçš„valueï¼Œkeyåˆ™æ˜¯treeIndexä¸­ä¿å­˜çš„ç‰ˆæœ¬å·ï¼Œç„¶åé€šè¿‡boltdbçš„å†™æ¥å£ä¿å­˜åˆ°dbæ–‡ä»¶ä¸­ã€‚</p><pre><code>kv := mvccpb.KeyValue{\n   Key:            keyï¼Œ\n   Value:          valueï¼Œ\n   CreateRevision: cï¼Œ\n   ModRevision:    revï¼Œ\n   Version:        verï¼Œ\n   Lease:          int64(leaseID)ï¼Œ\n}\n</code></pre><p>å‰é¢æˆ‘ä»¬åœ¨ä»‹ç»boltdbæ—¶ï¼Œæåˆ°è¿‡etcdåœ¨å¯åŠ¨æ—¶ä¼šé€šè¿‡mmapæœºåˆ¶ï¼Œå°†etcd dbæ–‡ä»¶æ˜ å°„åˆ°etcdè¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå¹¶è®¾ç½®mmapçš„MAP_POPULATE flagï¼Œå®ƒä¼šå‘Šè¯‰Linuxå†…æ ¸é¢„è¯»æ–‡ä»¶ï¼Œè®©Linuxå†…æ ¸å°†æ–‡ä»¶å†…å®¹æ‹·è´åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚</p><p>åœ¨èŠ‚ç‚¹å†…å­˜è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œåç»­è¯»è¯·æ±‚å¯ç›´æ¥ä»å†…å­˜ä¸­è·å–ã€‚ç›¸æ¯”readç³»ç»Ÿè°ƒç”¨ï¼Œmmapå°‘äº†ä¸€æ¬¡ä»page cacheæ‹·è´åˆ°è¿›ç¨‹å†…å­˜åœ°å€ç©ºé—´çš„æ“ä½œï¼Œå› æ­¤å…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚</p><p>è‹¥etcdèŠ‚ç‚¹å†…å­˜ä¸è¶³ï¼Œå¯èƒ½ä¼šå¯¼è‡´dbæ–‡ä»¶å¯¹åº”çš„å†…å­˜é¡µè¢«æ¢å‡ºã€‚å½“è¯»è¯·æ±‚å‘½ä¸­çš„é¡µæœªåœ¨å†…å­˜ä¸­æ—¶ï¼Œå°±ä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼Œå¯¼è‡´è¯»è¿‡ç¨‹ä¸­äº§ç”Ÿç£ç›˜IOã€‚è¿™æ ·è™½ç„¶é¿å…äº†etcdè¿›ç¨‹OOMï¼Œä½†æ˜¯æ­¤è¿‡ç¨‹ä¼šäº§ç”Ÿè¾ƒå¤§çš„å»¶æ—¶ã€‚</p><p>ä»ä»¥ä¸Šboltdbçš„key-valueå’Œmmapæœºåˆ¶ä»‹ç»ä¸­æˆ‘ä»¬å¯çŸ¥ï¼Œæˆ‘ä»¬åº”æ§åˆ¶boltdbæ–‡ä»¶å¤§å°ï¼Œä¼˜åŒ–key-valueå¤§å°ï¼Œé…ç½®åˆç†çš„å‹ç¼©ç­–ç•¥ï¼Œå›æ”¶æ—§ç‰ˆæœ¬ï¼Œé¿å…è¿‡å¤šå†…å­˜å ç”¨ã€‚</p><h2>watcher</h2><p>åœ¨ä½ å†™å…¥keyçš„æ—¶å€™ï¼Œå…¶ä»–clientè¿˜å¯é€šè¿‡etcdçš„Watchç›‘å¬æœºåˆ¶ï¼Œè·å–åˆ°keyçš„å˜åŒ–äº‹ä»¶ã€‚</p><p>é‚£åˆ›å»ºä¸€ä¸ªwatcherè€—è´¹çš„å†…å­˜è·Ÿå“ªäº›å› ç´ æœ‰å…³å‘¢?</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/341060\">08</a>Watchæœºåˆ¶è®¾è®¡ä¸å®ç°åˆ†æä¸­ï¼Œæˆ‘å’Œä½ ä»‹ç»è¿‡åˆ›å»ºwatcherçš„æ•´ä½“æµç¨‹ä¸æ¶æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªwatcheræ—¶ï¼Œclientä¸serverå»ºç«‹è¿æ¥åï¼Œä¼šåˆ›å»ºä¸€ä¸ªgRPC Watch Streamï¼Œéšåé€šè¿‡è¿™ä¸ªgRPC Watch Streamå‘é€åˆ›å»ºwatcherè¯·æ±‚ã€‚</p><p>æ¯ä¸ªgRPC Watch Streamä¸­etcd WatchServerä¼šåˆ†é…ä¸¤ä¸ªgoroutineå¤„ç†ï¼Œä¸€ä¸ªæ˜¯sendLoopï¼Œå®ƒè´Ÿè´£Watchäº‹ä»¶çš„æ¨é€ã€‚ä¸€ä¸ªæ˜¯recvLoopï¼Œè´Ÿè´£æ¥æ”¶clientçš„åˆ›å»ºã€å–æ¶ˆwatcherè¯·æ±‚æ¶ˆæ¯ã€‚</p><p>åŒæ—¶å¯¹æ¯ä¸ªwatcheræ¥è¯´ï¼Œetcdçš„WatchableKVæ¨¡å—éœ€å°†å…¶ä¿å­˜åˆ°ç›¸åº”çš„å†…å­˜ç®¡ç†æ•°æ®ç»“æ„ä¸­ï¼Œå®ç°å¯é çš„Watchäº‹ä»¶æ¨é€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/42/bf/42575d8d0a034e823b8e48d4ca0a49bf.png?wh=1920*1075\" alt=\"\"></p><p>å› æ­¤watchç›‘å¬æœºåˆ¶è€—è´¹çš„å†…å­˜è·Ÿclientè¿æ¥æ•°ã€gRPC Streamã€watcheræ•°(watching)æœ‰å…³ï¼Œå¦‚ä¸‹é¢å…¬å¼æ‰€ç¤ºï¼š</p><ul>\n<li>c1è¡¨ç¤ºæ¯ä¸ªè¿æ¥è€—è´¹çš„å†…å­˜ï¼›</li>\n<li>c2è¡¨ç¤ºæ¯ä¸ªgRPC Streamè€—è´¹çš„å†…å­˜ï¼›</li>\n<li>c3è¡¨ç¤ºæ¯ä¸ªwatcherè€—è´¹çš„å†…å­˜ã€‚</li>\n</ul><pre><code>memory = c1 * number_of_conn + c2 * \navg_number_of_stream_per_conn + c3 * \navg_number_of_watch_stream\n</code></pre><p>æ ¹æ®etcdç¤¾åŒºçš„<a href=\"https://etcd.io/docs/v3.4.0/benchmarks/etcd-3-watch-memory-benchmark/\">å‹æµ‹æŠ¥å‘Š</a>ï¼Œå¤§æ¦‚ä¼°ç®—å‡ºWatchæœºåˆ¶ä¸­c1ã€c2ã€c3å ç”¨çš„å†…å­˜åˆ†åˆ«å¦‚ä¸‹ï¼š</p><ul>\n<li>æ¯ä¸ªclientè¿æ¥æ¶ˆè€—å¤§çº¦17kbçš„å†…å­˜(c1)ï¼›</li>\n<li>æ¯ä¸ªgRPC Streamæ¶ˆè€—å¤§çº¦18kbçš„å†…å­˜(c2)ï¼›</li>\n<li>æ¯ä¸ªwatcheræ¶ˆè€—å¤§çº¦350ä¸ªå­—èŠ‚(c3)ï¼›</li>\n</ul><p>å½“ä½ çš„ä¸šåŠ¡åœºæ™¯å¤§é‡ä½¿ç”¨watcherçš„æ—¶å€™ï¼Œåº”æå‰ä¼°ç®—ä¸‹å†…å­˜å®¹é‡å¤§å°ï¼Œé€‰æ‹©åˆé€‚çš„å†…å­˜é…ç½®èŠ‚ç‚¹ã€‚</p><p>æ³¨æ„ä»¥ä¸Šä¼°ç®—å¹¶ä¸åŒ…æ‹¬watchäº‹ä»¶å †ç§¯çš„å¼€é”€ã€‚å˜æ›´äº‹ä»¶è¾ƒå¤šï¼ŒæœåŠ¡ç«¯ã€å®¢æˆ·ç«¯é«˜è´Ÿè½½ï¼Œç½‘ç»œé˜»å¡ç­‰æƒ…å†µéƒ½å¯èƒ½å¯¼è‡´äº‹ä»¶å †ç§¯ã€‚</p><p>åœ¨etcd 3.4.9ç‰ˆæœ¬ä¸­ï¼Œæ¯ä¸ªwatcheré»˜è®¤bufferæ˜¯1024ã€‚bufferå†…ä¿å­˜watchå“åº”ç»“æœï¼Œå¦‚watchIDã€watchäº‹ä»¶ï¼ˆwatchäº‹ä»¶åŒ…å«keyã€valueï¼‰ç­‰ã€‚</p><p>è‹¥å¤§é‡äº‹ä»¶å †ç§¯ï¼Œå°†äº§ç”Ÿè¾ƒé«˜æ˜‚çš„å†…å­˜çš„å¼€é”€ã€‚ä½ å¯ä»¥é€šè¿‡etcd_debugging_mvcc_pending_events_totalæŒ‡æ ‡ç›‘æ§å †ç§¯çš„äº‹ä»¶æ•°ï¼Œetcd_debugging_slow_watcher_totalæŒ‡æ ‡ç›‘æ§æ…¢çš„watcheræ•°ï¼Œæ¥åŠæ—¶å‘ç°å¼‚å¸¸ã€‚</p><h2>expensive request</h2><p>å½“ä½ å†™å…¥æ¯”è¾ƒå¤§çš„key-valueåï¼Œå¦‚æœclienté¢‘ç¹æŸ¥è¯¢å®ƒï¼Œä¹Ÿä¼šäº§ç”Ÿé«˜æ˜‚çš„å†…å­˜å¼€é”€ã€‚</p><p>å‡è®¾æˆ‘ä»¬å†™å…¥äº†100ä¸ªè¿™æ ·1Må¤§å°çš„keyï¼Œ é€šè¿‡Rangeæ¥å£ä¸€æ¬¡æŸ¥è¯¢100ä¸ªkeyï¼Œ é‚£ä¹ˆboltdbéå†ã€ååºåˆ—åŒ–è¿‡ç¨‹å°†èŠ±è´¹è‡³å°‘100MBçš„å†…å­˜ã€‚å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œå®ƒä¼šéå†æ•´ä¸ªkey-valueï¼Œå°†key-valueä¿å­˜åˆ°æ•°ç»„kvsä¸­ã€‚</p><pre><code>kvs := make([]mvccpb.KeyValueï¼Œ limit)\nrevBytes := newRevBytes()\nfor iï¼Œ revpair := range revpairs[:len(kvs)] {\n   revToBytes(revpairï¼Œ revBytes)\n   _ï¼Œ vs := tr.tx.UnsafeRange(keyBucketNameï¼Œ revBytesï¼Œ nilï¼Œ 0)\n   if len(vs) != 1 {\n        ......    \n   }\n   if err := kvs[i].Unmarshal(vs[0]); err != nil {\n        .......\n   }\n</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ¬¡æŸ¥è¯¢å°±è€—è´¹äº†è‡³å°‘100MBçš„å†…å­˜ã€äº§ç”Ÿäº†è‡³å°‘100MBçš„æµé‡ï¼Œéšç€ä½ QPSå¢å¤§åï¼Œå¾ˆå®¹æ˜“OOMã€ç½‘å¡å‡ºç°ä¸¢åŒ…ã€‚</p><p>count-onlyã€limitæŸ¥è¯¢åœ¨keyç™¾ä¸‡çº§ä»¥ä¸Šæ—¶ï¼Œä¹Ÿä¼šäº§ç”Ÿéå¸¸å¤§çš„å†…å­˜å¼€é”€ã€‚å› ä¸ºå®ƒä»¬åœ¨éå†treeIndexçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå°†ç›¸å…³keyä¿å­˜åœ¨æ•°ç»„é‡Œé¢ã€‚å½“keyå¤šæ—¶ï¼Œæ­¤å¼€é”€ä¸å®¹å¿½è§†ã€‚</p><p>æ­£å¦‚æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/343245\">13</a>  dbå¤§å°ä¸­è®²åˆ°çš„ï¼Œåœ¨masteråˆ†æ”¯ï¼Œæˆ‘å·²æäº¤ç›¸å…³PRè§£å†³count-onlyå’ŒlimitæŸ¥è¯¢å¯¼è‡´å†…å­˜å ç”¨çªå¢çš„é—®é¢˜ã€‚</p><h2>etcd v2/goroutines/bug</h2><p>é™¤äº†ä»¥ä¸Šä»‹ç»çš„æ ¸å¿ƒæ¨¡å—ã€expensive requeståœºæ™¯å¯èƒ½å¯¼è‡´è¾ƒé«˜çš„å†…å­˜å¼€é”€å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹åœºæ™¯ä¹Ÿä¼šå¯¼è‡´etcdå†…å­˜ä½¿ç”¨è¾ƒé«˜ã€‚</p><p>é¦–å…ˆæ˜¯<strong>etcdä¸­ä½¿ç”¨äº†v2çš„APIå†™å…¥äº†å¤§é‡çš„key-valueæ•°æ®</strong>ï¼Œè¿™ä¼šå¯¼è‡´å†…å­˜é£™é«˜ã€‚æˆ‘ä»¬çŸ¥é“etcd v2çš„key-valueéƒ½æ˜¯å­˜å‚¨åœ¨å†…å­˜æ ‘ä¸­çš„ï¼ŒåŒæ—¶v2çš„watcherä¸æ”¯æŒå¤šè·¯å¤ç”¨ï¼Œå†…å­˜å¼€é”€ç›¸æ¯”v3å¤šäº†ä¸€ä¸ªæ•°é‡çº§ã€‚</p><p>åœ¨etcd 3.4ç‰ˆæœ¬ä¹‹å‰ï¼Œetcdé»˜è®¤åŒæ—¶æ”¯æŒetcd v2/v3 APIï¼Œetcd 3.4ç‰ˆæœ¬é»˜è®¤å…³é—­äº†v2 APIã€‚ ä½ å¯ä»¥é€šè¿‡etcd v2 APIå’Œetcd v2å†…å­˜å­˜å‚¨æ¨¡å—çš„metricså‰ç¼€etcd_debugging_storeï¼Œè§‚å¯Ÿé›†ç¾¤ä¸­æ˜¯å¦æœ‰v2æ•°æ®å¯¼è‡´çš„å†…å­˜å ç”¨é«˜ã€‚</p><p>å…¶æ¬¡æ˜¯<strong>goroutinesæ³„éœ²</strong>å¯¼è‡´å†…å­˜å ç”¨é«˜ã€‚æ­¤é—®é¢˜å¯èƒ½ä¼šåœ¨å®¹å™¨åŒ–åœºæ™¯ä¸­é‡åˆ°ã€‚etcdåœ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œè‹¥å‡ºç°é˜»å¡åˆ™å¯èƒ½ä¼šå¯¼è‡´goroutineé˜»å¡å¹¶æŒç»­æ³„éœ²ï¼Œæœ€ç»ˆå¯¼è‡´å†…å­˜æ³„éœ²ã€‚ä½ å¯ä»¥é€šè¿‡è§‚å¯Ÿã€ç›‘æ§go_goroutinesæ¥å‘ç°è¿™ä¸ªé—®é¢˜ã€‚</p><p>æœ€åæ˜¯<strong>etcd bug</strong>å¯¼è‡´çš„å†…å­˜æ³„éœ²ã€‚å½“ä½ åŸºæœ¬æ’é™¤ä»¥ä¸Šåœºæ™¯å¯¼è‡´çš„å†…å­˜å ç”¨é«˜åï¼Œåˆ™å¾ˆå¯èƒ½æ˜¯etcd bugå¯¼è‡´çš„å†…å­˜æ³„éœ²ã€‚</p><p>æ¯”å¦‚æ—©æœŸetcd clientv3çš„lease keepaliveç§Ÿçº¦é¢‘ç¹ç»­æœŸbugï¼Œå®ƒä¼šå¯¼è‡´Leaderé«˜è´Ÿè½½ã€å†…å­˜æ³„éœ²ï¼Œæ­¤bugå·²åœ¨3.2.24/3.3.9ç‰ˆæœ¬ä¸­ä¿®å¤ã€‚</p><p>è¿˜æœ‰æœ€è¿‘æˆ‘ä¿®å¤çš„etcd 3.4ç‰ˆæœ¬çš„<a href=\"https://github.com/etcd-io/etcd/pull/11731\">FollowerèŠ‚ç‚¹å†…å­˜æ³„éœ²</a>ã€‚å…·ä½“è¡¨ç°æ˜¯ä¸¤ä¸ªFollowerèŠ‚ç‚¹å†…å­˜ä¸€ç›´å‡é«˜ï¼ŒLeaderèŠ‚ç‚¹æ­£å¸¸ï¼Œå·²åœ¨3.4.6ç‰ˆæœ¬ä¸­ä¿®å¤ã€‚</p><p>è‹¥å†…å­˜æ³„éœ²å¹¶ä¸æ˜¯å·²çŸ¥çš„etcd bugå¯¼è‡´ï¼Œé‚£ä½ å¯ä»¥å¼€å¯pprofï¼Œ å°è¯•å¤ç°ï¼Œé€šè¿‡åˆ†æpprof heapæ–‡ä»¶æ¥ç¡®å®šæ¶ˆè€—å¤§é‡å†…å­˜çš„æ¨¡å—å’Œæ•°æ®ç»“æ„ã€‚</p><h2>å°èŠ‚</h2><p>ä»Šå¤©æˆ‘é€šè¿‡ä¸€ä¸ªå†™å…¥1MB  keyçš„å®é™…æ¡ˆä¾‹ï¼Œç»™ä½ ä»‹ç»äº†å¯èƒ½å¯¼è‡´etcdå†…å­˜å ç”¨é«˜çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€åœºæ™¯ï¼ŒåŒæ—¶æˆ‘å°†å¯èƒ½å¯¼è‡´å†…å­˜å ç”¨è¾ƒé«˜çš„å› ç´ æ€»ç»“ä¸ºäº†ä¸‹é¢è¿™å¹…å›¾ï¼Œä½ å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/aa/90/aaf7b4f5f6f568dc70c1a0964fb92790.png?wh=1920*684\" alt=\"\"></p><p>é¦–å…ˆæ˜¯raftLogã€‚ä¸ºäº†å¸®åŠ©slow FolloweråŒæ­¥æ•°æ®ï¼Œå®ƒè‡³å°‘è¦ä¿ç•™5000æ¡æœ€è¿‘æ”¶åˆ°çš„å†™è¯·æ±‚åœ¨å†…å­˜ä¸­ã€‚è‹¥ä½ çš„keyéå¸¸å¤§ï¼Œä½ æ›´æ–°5000æ¬¡ä¼šäº§ç”Ÿè¾ƒå¤§çš„å†…å­˜å¼€é”€ã€‚</p><p>å…¶æ¬¡æ˜¯treeIndexã€‚ æ¯ä¸ªkey-valueä¼šåœ¨å†…å­˜ä¸­ä¿ç•™ä¸€ä¸ªç´¢å¼•é¡¹ã€‚ç´¢å¼•é¡¹çš„å¼€é”€è·Ÿkeyé•¿åº¦ã€ä¿ç•™çš„å†å²ç‰ˆæœ¬æœ‰å…³ï¼Œä½ å¯ä»¥é€šè¿‡compactå‘½ä»¤å‹ç¼©ã€‚</p><p>ç„¶åæ˜¯boltdbã€‚etcdå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šé€šè¿‡mmapç³»ç»Ÿè°ƒç”¨ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ä¸­ã€‚ä½ å¯ä»¥é€šè¿‡compactå‘½ä»¤å›æ”¶æ—§ç‰ˆæœ¬ï¼Œdefragå‘½ä»¤è¿›è¡Œç¢ç‰‡æ•´ç†ã€‚</p><p>æ¥ç€æ˜¯watcherã€‚å®ƒçš„å†…å­˜å ç”¨è·Ÿè¿æ¥æ•°ã€gRPC Watch Streamæ•°ã€watcheræ•°æœ‰å…³ã€‚watchæœºåˆ¶ä¸€ä¸ªä¸å¯å¿½è§†çš„å†…å­˜å¼€é”€å…¶å®æ˜¯äº‹ä»¶å †ç§¯çš„å ç”¨ç¼“å­˜ï¼Œä½ å¯ä»¥é€šè¿‡ç›¸å…³metricsåŠæ—¶å‘ç°å †ç§¯çš„äº‹ä»¶ä»¥åŠslow watcherã€‚</p><p>æœ€åæˆ‘ä»‹ç»äº†ä¸€äº›å…¸å‹çš„åœºæ™¯å¯¼è‡´çš„å†…å­˜å¼‚å¸¸ï¼Œå¦‚å¤§åŒ…æŸ¥è¯¢ç­‰expensive requestï¼Œetcdä¸­å­˜å‚¨äº†v2 APIå†™å…¥çš„keyï¼Œ goroutinesæ³„éœ²ä»¥åŠetcd lease bugç­‰ã€‚</p><p>å¸Œæœ›ä»Šå¤©çš„å†…å®¹ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ ä»å®¹åº”å¯¹etcdå†…å­˜å ç”¨é«˜çš„é—®é¢˜ï¼Œåˆç†é…ç½®ä½ çš„é›†ç¾¤ï¼Œä¼˜åŒ–ä¸šåŠ¡expensive requestï¼Œè®©etcdè·‘å¾—æ›´ç¨³ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>åœ¨ä¸€ä¸ªkeyä½¿ç”¨æ•°Gå†…å­˜çš„æ¡ˆä¾‹ä¸­ï¼Œæœ€åæ‰§è¡Œcompactå’Œdefragåçš„ç»“æœæ˜¯2Gï¼Œä¸ºä»€ä¹ˆä¸æ˜¯1Gå·¦å³å‘¢ï¼Ÿåœ¨macOSä¸‹è¡Œä¸ºæ˜¯å¦ä¸€æ ·å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åŠ¨æ‰‹åšä¸‹è¿™ä¸ªå°å®éªŒï¼Œåˆ†æä¸‹åŸå› ï¼Œåˆ†äº«ä½ çš„è§‚ç‚¹ã€‚</p><p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™èŠ‚è¯¾çš„å†…å®¹æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œè°¢è°¢ã€‚</p>","neighbors":{"left":{"article_title":"14 | å»¶æ—¶ï¼šä¸ºä»€ä¹ˆä½ çš„etcdè¯·æ±‚ä¼šå‡ºç°è¶…æ—¶ï¼Ÿ","id":343645},"right":{"article_title":"16 | æ€§èƒ½åŠç¨³å®šæ€§ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•ä¼˜åŒ–åŠæ‰©å±•etcdæ€§èƒ½ï¼Ÿ","id":345588}},"comments":[{"had_liked":false,"id":284972,"user_name":"[å°ç‹—]","can_delete":false,"product_type":"c1","uid":1237070,"ip_address":"","ucode":"090AEAC8A86134","user_header":"https://static001.geekbang.org/account/avatar/00/12/e0/4e/c266bdb4.jpg","comment_is_top":false,"comment_ctime":1616566726,"is_pvip":false,"replies":[{"id":"103447","content":"å»ºè®®å¯ä»¥å…ˆä»æ—©æœŸçš„v2ä»£ç çœ‹èµ·ï¼Œé‚£æ—¶é€»è¾‘æœ€ç®€å•ï¼Œhttps:&#47;&#47;github.com&#47;etcd-io&#47;etcd&#47;blob&#47;release-0.4&#47;server&#47;v2&#47;get_handler.go,ç„¶åå†çœ‹etcd v3çš„ä»£ç ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ç»™ä½ å‡ ä¸ªå°å»ºè®®ï¼š<br>1. æŠ“ä½ä¸»æ¬¡ï¼Œæ¯”å¦‚æ ¸å¿ƒè¯»å†™æµç¨‹æ˜¯æ€æ ·çš„ï¼Œå¿½ç•¥ä¸€äº›ç‰¹æ®Šç»†èŠ‚<br>2. çœ‹çœ‹æµ‹è¯•ç”¨ä¾‹å¦‚ä½•ä½¿ç”¨æ ¸å¿ƒæ¨¡å—çš„APIçš„ï¼Œæ¯”å¦‚etcd v3 mvccçš„æ¨¡å—æµ‹è¯•æ–‡ä»¶<br>https:&#47;&#47;github.com&#47;etcd-io&#47;etcd&#47;blob&#47;v3.4.9&#47;mvcc&#47;kv_test.go<br>3. è‡ªå·±å¯åŠ¨æ‰‹å†™å†™æºç åˆ†æ<br>4. è‡ªå·±å¤šå®è·µä¸‹ï¼Œéƒ¨ç½²ä¸ªå•æœºetcdé›†ç¾¤ï¼Œè‡³å°‘è¦æŠŠetcdctlå„ä¸ªå‘½ä»¤ç»™æ“ä½œä¸‹<br>5. æ—¥å¿—çº§åˆ«å¯ä»¥æ”¹æˆdebug, æ›´åŠ æ–¹ä¾¿è§‚å¯Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1616651875,"ip_address":"","comment_id":284972,"utype":1}],"discussion_count":3,"race_medal":0,"score":"40271272390","product_id":100069901,"comment_content":"å¤§ä½¬ï¼Œæˆ‘æƒ³é˜…è¯»ä¸‹etcdçš„æºç ï¼Œæœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ ç›®å‰åªæ˜¯ä¸ºäº†ç®€å†å¥½çœ‹äº›ï¼Œä»¥åä¼šæ·±åº¦å­¦ä¹ ä¸‹","like_count":10,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517532,"discussion_content":"å»ºè®®å¯ä»¥å…ˆä»æ—©æœŸçš„v2ä»£ç çœ‹èµ·ï¼Œé‚£æ—¶é€»è¾‘æœ€ç®€å•ï¼Œhttps://github.com/etcd-io/etcd/blob/release-0.4/server/v2/get_handler.go,ç„¶åå†çœ‹etcd v3çš„ä»£ç ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ç»™ä½ å‡ ä¸ªå°å»ºè®®ï¼š\n1. æŠ“ä½ä¸»æ¬¡ï¼Œæ¯”å¦‚æ ¸å¿ƒè¯»å†™æµç¨‹æ˜¯æ€æ ·çš„ï¼Œå¿½ç•¥ä¸€äº›ç‰¹æ®Šç»†èŠ‚\n2. çœ‹çœ‹æµ‹è¯•ç”¨ä¾‹å¦‚ä½•ä½¿ç”¨æ ¸å¿ƒæ¨¡å—çš„APIçš„ï¼Œæ¯”å¦‚etcd v3 mvccçš„æ¨¡å—æµ‹è¯•æ–‡ä»¶\nhttps://github.com/etcd-io/etcd/blob/v3.4.9/mvcc/kv_test.go\n3. è‡ªå·±å¯åŠ¨æ‰‹å†™å†™æºç åˆ†æ\n4. è‡ªå·±å¤šå®è·µä¸‹ï¼Œéƒ¨ç½²ä¸ªå•æœºetcdé›†ç¾¤ï¼Œè‡³å°‘è¦æŠŠetcdctlå„ä¸ªå‘½ä»¤ç»™æ“ä½œä¸‹\n5. æ—¥å¿—çº§åˆ«å¯ä»¥æ”¹æˆdebug, æ›´åŠ æ–¹ä¾¿è§‚å¯Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616651875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1237070,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e0/4e/c266bdb4.jpg","nickname":"[å°ç‹—]","note":"","ucode":"090AEAC8A86134","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361373,"discussion_content":"éå¸¸æ„Ÿè°¢æ‚¨çš„ç•™è¨€ã€‚\næˆ‘å…¶å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒç™½çš„ç™½ï¼Œæˆ‘æƒ³é—®ä¸‹ï¼Œåœ¨æˆ‘çš„æ½œæ„è¯†ä¸­ï¼Œæˆ‘å­¦ä¹ æºä»£ç æ— éæ˜¯ä¸ºäº†é¢è¯•éœ€è¦ï¼Œæ˜¾å¾—é«˜å¤§ä¸Šã€‚å¦‚æœæŠ›å¼€è¿™äº›ï¼Œå­¦ä¹ è¿™ä¸ªæºç çœŸæ­£çš„ç”¨å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Œå¯ä»¥ä»ä¼ä¸šä¸šåŠ¡è§’åº¦å’Œä¸ªäººè§’åº¦æ¥è§£æƒ‘ä¸‹ï¼Œéå¸¸æ„Ÿè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616654598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1975831,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/rSzzqGwHcvhwPejiaPsCY9XBX7ib7zTxJ6cUDORdhGIakX8dTPVsz6ibud5ec1FeWQGTseF2TPRECCjky5JMlHvDg/132","nickname":"Struggle~honor","note":"","ucode":"EBC6DFC6CF0973","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1237070,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e0/4e/c266bdb4.jpg","nickname":"[å°ç‹—]","note":"","ucode":"090AEAC8A86134","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550962,"discussion_content":"ä¸ªäººæ„Ÿè§‰å­¦ä¹ æºç çš„å¥½å¤„æ˜¯ï¼Œ1.å¯ä»¥äº†è§£åˆ°ä¸€äº›Goå¼€å‘ä¸­çš„è¾ƒä¸ºä¼˜é›…çš„ä»£ç ã€‚åº”ç”¨åˆ°å¹³å¸¸çš„å¼€å‘ã€‚2. æ›´å¥½ç†è§£é¡¹ç›®çš„æ¶æ„ï¼Œé‡åˆ°ç±»ä¼¼çš„é—®é¢˜çš„æ—¶å€™ï¼Œä¹Ÿä¼šè¿‡æ›´åŠ æœ‰æ€è·¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644827354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":361373,"ip_address":""},"score":550962,"extra":""}]}]},{"had_liked":false,"id":279844,"user_name":"shuff1e","can_delete":false,"product_type":"c1","uid":1756280,"ip_address":"","ucode":"85601271951B5A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep075ibtmxMf3eOYlBJ96CE9TEelLUwePaLqp8M75gWHEcM3za0voylA0oe9y3NiaboPB891rypRt7w/132","comment_is_top":false,"comment_ctime":1613980976,"is_pvip":false,"replies":[{"id":"101816","content":"æ˜¯æŒ‡etcd v2çš„key-valueæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­çš„,å¦‚æœä½ etcd v3é‡Œé¢å­˜å‚¨äº†å¤§é‡çš„etcd v2 key-valueæ•°æ®ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜å ç”¨è¾ƒé«˜ã€‚<br>ä½ å¯ä»¥å‚è€ƒä¸‹etcd v2 storeçš„å®šä¹‰ï¼Œetcd v2çš„key-valueæ•°æ®å°±æ˜¯ç›´æ¥å­˜å‚¨åœ¨è¿™ä¸ªç»“æ„å“ˆ<br>https:&#47;&#47;github.com&#47;etcd-io&#47;etcd&#47;blob&#47;release-3.3&#47;store&#47;store.go#L73:L83","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1614229974,"ip_address":"","comment_id":279844,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14498882864","product_id":100069901,"comment_content":"etcd v2 çš„ key-value éƒ½æ˜¯å­˜å‚¨åœ¨å†…å­˜æ ‘ä¸­ï¼Œå…·ä½“æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢","like_count":3,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515891,"discussion_content":"æ˜¯æŒ‡etcd v2çš„key-valueæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­çš„,å¦‚æœä½ etcd v3é‡Œé¢å­˜å‚¨äº†å¤§é‡çš„etcd v2 key-valueæ•°æ®ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜å ç”¨è¾ƒé«˜ã€‚\nä½ å¯ä»¥å‚è€ƒä¸‹etcd v2 storeçš„å®šä¹‰ï¼Œetcd v2çš„key-valueæ•°æ®å°±æ˜¯ç›´æ¥å­˜å‚¨åœ¨è¿™ä¸ªç»“æ„å“ˆ\nhttps://github.com/etcd-io/etcd/blob/release-3.3/store/store.go#L73:L83","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614229974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344270,"user_name":"i_chase","can_delete":false,"product_type":"c1","uid":1795511,"ip_address":"","ucode":"09C41C863F4EA3","user_header":"https://static001.geekbang.org/account/avatar/00/1b/65/b7/058276dc.jpg","comment_is_top":false,"comment_ctime":1651412700,"is_pvip":true,"replies":[{"id":"125742","content":"ä¸»è¦åŸå› æ˜¯etcd 3.4 ç‰ˆæœ¬æ˜¯ä½¿ç”¨ go 1.12 ç¼–è¯‘çš„ï¼Œgo runtime çš„é»˜è®¤å†…å­˜ç®¡ç†ç­–ç•¥æ˜¯ MADV_FREE, å®ƒçš„æ€§èƒ½è¾ƒå¥½ï¼Œä½†æ˜¯ä¼šå¯¼è‡´ä½ çœ‹åˆ°çš„etcdå†…å­˜è™šé«˜ï¼Œç›‘æ§æŒ‡æ ‡å¼‚å¸¸ã€ç”¨æˆ·ä½“éªŒä¸ä½³ç­‰é—®é¢˜ï¼ŒåŸå› æ˜¯è¿™ç§ç­–ç•¥ï¼Œåœ¨ç³»ç»Ÿå†…å­˜æœ‰å‹åŠ›çš„æ—¶å€™ï¼Œå†…æ ¸æ‰ä¼šé‡Šæ”¾å ç”¨çš„å†…å­˜ã€‚<br>ä» go v1.16 èµ·ï¼ŒGo åœ¨ Linux ä¸‹çš„é»˜è®¤å†…å­˜ç®¡ç†ç­–ç•¥å˜æˆäº† MADV_DONTNEED ç­–ç•¥ã€‚MADV_DONTNEED è™½ç„¶æ•ˆç‡ç›¸æ¯” MADV_FREE ç­–ç•¥è¾ƒä½ï¼Œä½†æ˜¯ä¼šè®© rss å†…å­˜ä¸‹é™è¾ƒå¿«ï¼Œæ›´åŠ ç¬¦åˆç›´è§‚æ„Ÿå—ï¼Œèƒ½é¿å… MADV_FREE ç›¸å…³çš„å‰¯ä½œç”¨ã€‚<br>æ›´è¯¦ç»†çš„å¯ä»¥å‚è€ƒgolang issueå’Œetcd 3.5 blog.<br>https:&#47;&#47;github.com&#47;golang&#47;go&#47;issues&#47;42330<br>https:&#47;&#47;etcd.io&#47;blog&#47;2021&#47;announcing-etcd-3.5 Monitoringéƒ¨åˆ†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1009582","ctime":1651632331,"ip_address":"","comment_id":344270,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10241347292","product_id":100069901,"comment_content":"è¿™ä¸€æœŸçš„æ€è€ƒé¢˜æœ‰ç­”æ¡ˆå—","like_count":3,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":569989,"discussion_content":"ä¸»è¦åŸå› æ˜¯etcd 3.4 ç‰ˆæœ¬æ˜¯ä½¿ç”¨ go 1.12 ç¼–è¯‘çš„ï¼Œgo runtime çš„é»˜è®¤å†…å­˜ç®¡ç†ç­–ç•¥æ˜¯ MADV_FREE, å®ƒçš„æ€§èƒ½è¾ƒå¥½ï¼Œä½†æ˜¯ä¼šå¯¼è‡´ä½ çœ‹åˆ°çš„etcdå†…å­˜è™šé«˜ï¼Œç›‘æ§æŒ‡æ ‡å¼‚å¸¸ã€ç”¨æˆ·ä½“éªŒä¸ä½³ç­‰é—®é¢˜ï¼ŒåŸå› æ˜¯è¿™ç§ç­–ç•¥ï¼Œåœ¨ç³»ç»Ÿå†…å­˜æœ‰å‹åŠ›çš„æ—¶å€™ï¼Œå†…æ ¸æ‰ä¼šé‡Šæ”¾å ç”¨çš„å†…å­˜ã€‚\nä» go v1.16 èµ·ï¼ŒGo åœ¨ Linux ä¸‹çš„é»˜è®¤å†…å­˜ç®¡ç†ç­–ç•¥å˜æˆäº† MADV_DONTNEED ç­–ç•¥ã€‚MADV_DONTNEED è™½ç„¶æ•ˆç‡ç›¸æ¯” MADV_FREE ç­–ç•¥è¾ƒä½ï¼Œä½†æ˜¯ä¼šè®© rss å†…å­˜ä¸‹é™è¾ƒå¿«ï¼Œæ›´åŠ ç¬¦åˆç›´è§‚æ„Ÿå—ï¼Œèƒ½é¿å… MADV_FREE ç›¸å…³çš„å‰¯ä½œç”¨ã€‚\næ›´è¯¦ç»†çš„å¯ä»¥å‚è€ƒgolang issueå’Œetcd 3.5 blog.\nhttps://github.com/golang/go/issues/42330\nhttps://etcd.io/blog/2021/announcing-etcd-3.5 Monitoringéƒ¨åˆ†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651632332,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":284927,"user_name":"æ±Ÿå±±æœª","can_delete":false,"product_type":"c1","uid":1090196,"ip_address":"","ucode":"5293DD9482717F","user_header":"https://static001.geekbang.org/account/avatar/00/10/a2/94/ae0a60d8.jpg","comment_is_top":false,"comment_ctime":1616549139,"is_pvip":false,"replies":[{"id":"103449","content":"åœ¨ä¸Šä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ç»™äº†ä¸€äº›è¦ç‚¹ï¼Œå»ºè®®å¯ä»¥å…ˆä»æ—©æœŸçš„v2ä»£ç çœ‹èµ·ï¼Œé‚£æ—¶é€»è¾‘æœ€ç®€å•ï¼Œhttps:&#47;&#47;github.com&#47;etcd-io&#47;etcd&#47;blob&#47;release-0.4&#47;server&#47;v2&#47;get_handler.go,ç„¶åå†çœ‹etcd v3çš„ä»£ç ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ç»™ä½ å‡ ä¸ªå°å»ºè®®ï¼š<br>1. æŠ“ä½ä¸»æ¬¡ï¼Œæ¯”å¦‚æ ¸å¿ƒè¯»å†™æµç¨‹æ˜¯æ€æ ·çš„ï¼Œå¿½ç•¥ä¸€äº›ç‰¹æ®Šç»†èŠ‚<br>2. çœ‹çœ‹æµ‹è¯•ç”¨ä¾‹å¦‚ä½•ä½¿ç”¨æ ¸å¿ƒæ¨¡å—çš„APIçš„ï¼Œæ¯”å¦‚etcd v3 mvccçš„æ¨¡å—æµ‹è¯•æ–‡ä»¶<br>https:&#47;&#47;github.com&#47;etcd-io&#47;etcd&#47;blob&#47;v3.4.9&#47;mvcc&#47;kv_test.go<br>3. è‡ªå·±å¯åŠ¨æ‰‹å†™å†™æºç åˆ†æ<br>4. è‡ªå·±å¤šå®è·µä¸‹ï¼Œéƒ¨ç½²ä¸ªå•æœºetcdé›†ç¾¤ï¼Œè‡³å°‘è¦æŠŠetcdctlå„ä¸ªå‘½ä»¤ç»™æ“ä½œä¸‹<br>5. æ—¥å¿—çº§åˆ«å¯ä»¥æ”¹æˆdebug, æ›´åŠ æ–¹ä¾¿è§‚å¯Ÿ<br>å¦‚æœç»™ç¤¾åŒºåšè´¡çŒ®ï¼Œå¯ä»¥å¤šå…³æ³¨ä¸‹ç¤¾åŒºæ­£åœ¨è®¨è®ºçš„issueå’ŒPRï¼Œå¯»æ‰¾åˆ‡å…¥ç‚¹ï¼Œæ¯”å¦‚æ–‡æ¡£å®Œå–„ã€æ‹¼å†™é”™è¯¯ã€ä¸ç¨³å®šçš„æµ‹è¯•ç”¨ä¾‹ä¿®å¤ç­‰å¼€å§‹ï¼Œæœ‰æ—¶å€™å¤§å®¶ä¼šæ ‡æ³¨label help wanted, https:&#47;&#47;github.com&#47;etcd-io&#47;etcd&#47;issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22<br><br>treeIndexæ ¸å¿ƒæ˜¯btree,boltdbæ ¸å¿ƒæ˜¯b+ tree,æ—©æœŸä¸å»ºè®®ä½ çœ‹ï¼Œäº†è§£å®ƒçš„åŠŸèƒ½å³å¯ï¼Œå½“ä½ å¯¹etcdæœ‰ä¸€å®šæŒæ¡åï¼Œå¯ä»¥è¯¦ç»†çœ‹çœ‹ï¼Œäº†è§£ä¸‹ç”Ÿäº§çº§çš„btreeåŠb+ treeå®ç°ï¼Œç›¸ä¿¡ä½ ä¼šæ”¶è´§å¾ˆå¤šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1616652375,"ip_address":"","comment_id":284927,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10206483731","product_id":100069901,"comment_content":"è€å¸ˆï¼Œæƒ³é—®ä¸‹ã€‚å·¥ä½œä¸­æœ‰ç”¨åˆ°etcdï¼Œå¦‚æœæƒ³é€šè¿‡çœ‹etcdæºç æå‡äº†è§£çš„è¯ï¼Œå»ºè®®ä»å“ªé‡Œå…¥æ‰‹å‘¢ã€‚<br>å¦‚æœå¯èƒ½çš„è¯ï¼Œä¹Ÿå¸Œæœ›èƒ½åƒä½ ä¸€æ ·ï¼Œä¸ºç¤¾åŒºåšä¸€äº›è´¡çŒ®ã€‚<br>ç›´æ¥ä»å¯åŠ¨å‘½ä»¤çœ‹ä¸‹å»å—ï¼Ÿè¿˜æœ‰å°±æ˜¯ treeindexå’Œbboltæœ‰å¿…è¦çœ‹å—ã€‚","like_count":2,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517514,"discussion_content":"åœ¨ä¸Šä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ç»™äº†ä¸€äº›è¦ç‚¹ï¼Œå»ºè®®å¯ä»¥å…ˆä»æ—©æœŸçš„v2ä»£ç çœ‹èµ·ï¼Œé‚£æ—¶é€»è¾‘æœ€ç®€å•ï¼Œhttps://github.com/etcd-io/etcd/blob/release-0.4/server/v2/get_handler.go,ç„¶åå†çœ‹etcd v3çš„ä»£ç ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ç»™ä½ å‡ ä¸ªå°å»ºè®®ï¼š\n1. æŠ“ä½ä¸»æ¬¡ï¼Œæ¯”å¦‚æ ¸å¿ƒè¯»å†™æµç¨‹æ˜¯æ€æ ·çš„ï¼Œå¿½ç•¥ä¸€äº›ç‰¹æ®Šç»†èŠ‚\n2. çœ‹çœ‹æµ‹è¯•ç”¨ä¾‹å¦‚ä½•ä½¿ç”¨æ ¸å¿ƒæ¨¡å—çš„APIçš„ï¼Œæ¯”å¦‚etcd v3 mvccçš„æ¨¡å—æµ‹è¯•æ–‡ä»¶\nhttps://github.com/etcd-io/etcd/blob/v3.4.9/mvcc/kv_test.go\n3. è‡ªå·±å¯åŠ¨æ‰‹å†™å†™æºç åˆ†æ\n4. è‡ªå·±å¤šå®è·µä¸‹ï¼Œéƒ¨ç½²ä¸ªå•æœºetcdé›†ç¾¤ï¼Œè‡³å°‘è¦æŠŠetcdctlå„ä¸ªå‘½ä»¤ç»™æ“ä½œä¸‹\n5. æ—¥å¿—çº§åˆ«å¯ä»¥æ”¹æˆdebug, æ›´åŠ æ–¹ä¾¿è§‚å¯Ÿ\nå¦‚æœç»™ç¤¾åŒºåšè´¡çŒ®ï¼Œå¯ä»¥å¤šå…³æ³¨ä¸‹ç¤¾åŒºæ­£åœ¨è®¨è®ºçš„issueå’ŒPRï¼Œå¯»æ‰¾åˆ‡å…¥ç‚¹ï¼Œæ¯”å¦‚æ–‡æ¡£å®Œå–„ã€æ‹¼å†™é”™è¯¯ã€ä¸ç¨³å®šçš„æµ‹è¯•ç”¨ä¾‹ä¿®å¤ç­‰å¼€å§‹ï¼Œæœ‰æ—¶å€™å¤§å®¶ä¼šæ ‡æ³¨label help wanted, https://github.com/etcd-io/etcd/issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22\n\ntreeIndexæ ¸å¿ƒæ˜¯btree,boltdbæ ¸å¿ƒæ˜¯b+ tree,æ—©æœŸä¸å»ºè®®ä½ çœ‹ï¼Œäº†è§£å®ƒçš„åŠŸèƒ½å³å¯ï¼Œå½“ä½ å¯¹etcdæœ‰ä¸€å®šæŒæ¡åï¼Œå¯ä»¥è¯¦ç»†çœ‹çœ‹ï¼Œäº†è§£ä¸‹ç”Ÿäº§çº§çš„btreeåŠb+ treeå®ç°ï¼Œç›¸ä¿¡ä½ ä¼šæ”¶è´§å¾ˆå¤šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616652375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1090196,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a2/94/ae0a60d8.jpg","nickname":"æ±Ÿå±±æœª","note":"","ucode":"5293DD9482717F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361623,"discussion_content":"è°¢è°¢è§£ç­”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616719868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322250,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1637278118,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1637278118","product_id":100069901,"comment_content":"ä¸€ä¸ªå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªClientï¼Œwatchä¸€ä¸ªkeyæ˜¯ä¸€ä¸ªwatcherï¼ŒgRPC Watch Stream æ•°å¦‚ä½•ç¡®å®šå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":322249,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1637277503,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1637277503","product_id":100069901,"comment_content":"&gt;å…¶æ¬¡æ˜¯ goroutines æ³„éœ²å¯¼è‡´å†…å­˜å ç”¨é«˜ã€‚æ­¤é—®é¢˜å¯èƒ½ä¼šåœ¨å®¹å™¨åŒ–åœºæ™¯ä¸­é‡åˆ°ã€‚etcd åœ¨æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œè‹¥å‡ºç°é˜»å¡åˆ™å¯èƒ½ä¼šå¯¼è‡´ goroutine é˜»å¡å¹¶æŒç»­æ³„éœ²ï¼Œæœ€ç»ˆå¯¼è‡´å†…å­˜æ³„éœ²<br>è€å¸ˆï¼Œè¿™é‡Œä¸å¤ªæ˜ç™½ï¼Œä¸ºä»€ä¹ˆæ‰“å°æ—¥å¿—é˜»å¡ä¼šå¯¼è‡´å†…å­˜æ³„éœ²å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":295166,"user_name":"sxfworks","can_delete":false,"product_type":"c1","uid":1335551,"ip_address":"","ucode":"E16CEFB1E0DBF8","user_header":"https://static001.geekbang.org/account/avatar/00/14/60/ff/cbe8fb58.jpg","comment_is_top":false,"comment_ctime":1622277425,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622277425","product_id":100069901,"comment_content":"è¿™å‡ å¤©çœ‹äº†etcdçš„æºç ï¼Œæœ€å¼€å§‹ä¸€ç›´å¥½å¥‡leaderå’Œfolloweræ€ä¹ˆåªåŒæ­¥ä¸€æ¬¡snapshotï¼Œæ˜¯æˆ‘çœ‹é”™äº†ï¼Œè¿˜æ˜¯çœŸçš„è¿™ä¹ˆç²—æš´ğŸ˜‚","like_count":0}]}