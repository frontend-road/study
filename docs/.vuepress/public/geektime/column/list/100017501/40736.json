{"id":40736,"title":"04 | 流量削峰这事应该怎么做？","content":"<p>如果你看过秒杀系统的流量监控图的话，你会发现它是一条直线，就在秒杀开始那一秒是一条很直很直的线，这是因为秒杀请求在时间上高度集中于某一特定的时间点。这样一来，就会导致一个特别高的流量峰值，它对资源的消耗是瞬时的。</p><p>但是对秒杀这个场景来说，最终能够抢到商品的人数是固定的，也就是说100人和10000人发起请求的结果都是一样的，并发度越高，无效请求也越多。</p><p>但是从业务上来说，秒杀活动是希望更多的人来参与的，也就是开始之前希望有更多的人来刷页面，但是真正开始下单时，秒杀请求并不是越多越好。因此我们可以设计一些规则，让并发的请求更多地延缓，而且我们甚至可以过滤掉一些无效请求。</p><h2>为什么要削峰</h2><p>为什么要削峰呢？或者说峰值会带来哪些坏处？</p><p>我们知道服务器的处理资源是恒定的，你用或者不用它的处理能力都是一样的，所以出现峰值的话，很容易导致忙到处理不过来，闲的时候却又没有什么要处理。但是由于要保证服务质量，我们的很多处理资源只能按照忙的时候来预估，而这会导致资源的一个浪费。</p><p>这就好比因为存在早高峰和晚高峰的问题，所以有了错峰限行的解决方案。削峰的存在，一是可以让服务端处理变得更加平稳，二是可以节省服务器的资源成本。针对秒杀这一场景，削峰从本质上来说就是更多地延缓用户请求的发出，以便减少和过滤掉一些无效请求，它遵从“请求数要尽量少”的原则。</p><!-- [[[read_end]]] --><p>今天，我就来介绍一下流量削峰的一些操作思路：排队、答题、分层过滤。这几种方式都是无损（即不会损失用户的发出请求）的实现方案，当然还有些有损的实现方案，包括我们后面要介绍的关于稳定性的一些办法，比如限流和机器负载保护等一些强制措施也能达到削峰保护的目的，当然这都是不得已的一些措施，因此就不归类到这里了。</p><h2>排队</h2><p>要对流量进行削峰，最容易想到的解决方案就是用消息队列来缓冲瞬时流量，把同步的直接调用转换成异步的间接推送，中间通过一个队列在一端承接瞬时的流量洪峰，在另一端平滑地将消息推送出去。在这里，消息队列就像“水库”一样，\t拦蓄上游的洪水，削减进入下游河道的洪峰流量，从而达到减免洪水灾害的目的。</p><p>用消息队列来缓冲瞬时流量的方案，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/db/d9/db0e4dcd2c66bc5611c4d6adccbb0bd9.jpg?wh=1134*682\" alt=\"\"></p><center><span class=\"reference\">图1  用消息队列来缓冲瞬时流量</span></center><p>但是，如果流量峰值持续一段时间达到了消息队列的处理上限，例如本机的消息积压达到了存储空间的上限，消息队列同样也会被压垮，这样虽然保护了下游的系统，但是和直接把请求丢弃也没多大的区别。就像遇到洪水爆发时，即使是有水库恐怕也无济于事。</p><p>除了消息队列，类似的排队方式还有很多，例如：</p><ol>\n<li>利用线程池加锁等待也是一种常用的排队方式；</li>\n<li>先进先出、先进后出等常用的内存排队算法的实现方式；</li>\n<li>把请求序列化到文件中，然后再顺序地读文件（例如基于MySQL binlog的同步机制）来恢复请求等方式。</li>\n</ol><p>可以看到，这些方式都有一个共同特征，就是把“一步的操作”变成“两步的操作”，其中增加的一步操作用来起到缓冲的作用。</p><p>说到这里你可能会说，这样一来增加了访问请求的路径啊，并不符合我们介绍的“4要1不要”原则。没错，的确看起来不太合理，但是如果不增加一个缓冲步骤，那么在一些场景下系统很可能会直接崩溃，所以最终还是需要你做出妥协和平衡。</p><h2>答题</h2><p>你是否还记得，最早期的秒杀只是纯粹地刷新页面和点击购买按钮，它是后来才增加了答题功能的。那么，为什么要增加答题功能呢？</p><p>这主要是为了增加购买的复杂度，从而达到两个目的。</p><p>第一个目的是防止部分买家使用秒杀器在参加秒杀时作弊。2011年秒杀非常火的时候，秒杀器也比较猖獗，因而没有达到全民参与和营销的目的，所以系统增加了答题来限制秒杀器。增加答题后，下单的时间基本控制在2s后，秒杀器的下单比例也大大下降。答题页面如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/58/ca/582f492096a10852f7df137a584ae5ca.jpg?wh=870*234\" alt=\"\"></p><center><span class=\"reference\">图2  答题页面</span></center><p>第二个目的其实就是延缓请求，起到对请求流量进行削峰的作用，从而让系统能够更好地支持瞬时的流量高峰。这个重要的功能就是把峰值的下单请求拉长，从以前的1s之内延长到2s~10s。这样一来，请求峰值基于时间分片了。这个时间的分片对服务端处理并发非常重要，会大大减轻压力。而且，由于请求具有先后顺序，靠后的请求到来时自然也就没有库存了，因此根本到不了最后的下单步骤，所以真正的并发写就非常有限了。这种设计思路目前用得非常普遍，如当年支付宝的“咻一咻”、微信的“摇一摇”都是类似的方式。</p><p>这里，我重点说一下秒杀答题的设计思路。</p><p><img src=\"https://static001.geekbang.org/resource/image/9d/b3/9df54dde5c41bf3b62567111f6f84bb3.jpg?wh=942*567\" alt=\"\"></p><center><span class=\"reference\">图3  秒杀答题</span></center><p>如上图所示，整个秒杀答题的逻辑主要分为3部分。</p><ol>\n<li><strong>题库生成模块</strong>，这个部分主要就是生成一个个问题和答案，其实题目和答案本身并不需要很复杂，重要的是能够防止由机器来算出结果，即防止秒杀器来答题。</li>\n<li><strong>题库的推送模块</strong>，用于在秒杀答题前，把题目提前推送给详情系统和交易系统。题库的推送主要是为了保证每次用户请求的题目是唯一的，目的也是防止答题作弊。</li>\n<li><strong>题目的图片生成模块</strong>，用于把题目生成为图片格式，并且在图片里增加一些干扰因素。这也同样是为防止机器直接来答题，它要求只有人才能理解题目本身的含义。这里还要注意一点，由于答题时网络比较拥挤，我们应该把题目的图片提前推送到CDN上并且要进行预热，不然的话当用户真正请求题目时，图片可能加载比较慢，从而影响答题的体验。</li>\n</ol><p>其实真正答题的逻辑比较简单，很好理解：当用户提交的答案和题目对应的答案做比较，如果通过了就继续进行下一步的下单逻辑，否则就失败。我们可以把问题和答案用下面这样的key来进行MD5加密：</p><ul>\n<li>问题key：userId+itemId+question_Id+time+PK</li>\n<li>答案key：userId+itemId+answer+PK</li>\n</ul><p>验证的逻辑如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/0d/86/0d76780836ed220427a9370fce99f186.jpg?wh=1208*299\" alt=\"\"></p><center><span class=\"reference\">图4  答题的验证逻辑</span></center><p>注意，这里面的验证逻辑，除了验证问题的答案以外，还包括用户本身身份的验证，例如是否已经登录、用户的Cookie是否完整、用户是否重复频繁提交等。</p><p>除了做正确性验证，我们还可以对提交答案的时间做些限制，例如从开始答题到接受答案要超过1s，因为小于1s是人为操作的可能性很小，这样也能防止机器答题的情况。</p><h2>分层过滤</h2><p>前面介绍的排队和答题要么是少发请求，要么对发出来的请求进行缓冲，而针对秒杀场景还有一种方法，就是对请求进行分层过滤，从而过滤掉一些无效的请求。分层过滤其实就是采用“漏斗”式设计来处理请求的，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/4a/09/4a5b7e080e7d357986f02ed1fd8b7309.jpg?wh=1186*1264\" alt=\"\"></p><center><span class=\"reference\">图5  分层过滤</span></center><p>假如请求分别经过CDN、前台读系统（如商品详情系统）、后台系统（如交易系统）和数据库这几层，那么：</p><ul>\n<li>大部分数据和流量在用户浏览器或者CDN上获取，这一层可以拦截大部分数据的读取；</li>\n<li>经过第二层（即前台系统）时数据（包括强一致性的数据）尽量得走Cache，过滤一些无效的请求；</li>\n<li>再到第三层后台系统，主要做数据的二次检验，对系统做好保护和限流，这样数据量和请求就进一步减少；</li>\n<li>最后在数据层完成数据的强一致性校验。</li>\n</ul><p>这样就像漏斗一样，尽量把数据量和请求量一层一层地过滤和减少了。</p><p><strong>分层过滤的核心思想是：在不同的层次尽可能地过滤掉无效请求，让“漏斗”最末端的才是有效请求</strong>。而要达到这种效果，我们就必须对数据做分层的校验。</p><p>分层校验的基本原则是：</p><ol>\n<li>将动态请求的读数据缓存（Cache）在Web端，过滤掉无效的数据读；</li>\n<li>对读数据不做强一致性校验，减少因为一致性校验产生瓶颈的问题；</li>\n<li>对写数据进行基于时间的合理分片，过滤掉过期的失效请求；</li>\n<li>对写请求做限流保护，将超出系统承载能力的请求过滤掉；</li>\n<li>对写数据进行强一致性校验，只保留最后有效的数据。</li>\n</ol><p>分层校验的目的是：在读系统中，尽量减少由于一致性校验带来的系统瓶颈，但是尽量将不影响性能的检查条件提前，如用户是否具有秒杀资格、商品状态是否正常、用户答题是否正确、秒杀是否已经结束、是否非法请求、营销等价物是否充足等；在写数据系统中，主要对写的数据（如“库存”）做一致性检查，最后在数据库层保证数据的最终准确性（如“库存”不能减为负数）。</p><h2>总结一下</h2><p>今天，我介绍了如何在网站面临大流量冲击时进行请求的削峰，并主要介绍了削峰的3种处理方式：一个是通过队列来缓冲请求，即控制请求的发出；一个是通过答题来延长请求发出的时间，在请求发出后承接请求时进行控制，最后再对不符合条件的请求进行过滤；最后一种是对请求进行分层过滤。</p><p>其中，队列缓冲方式更加通用，它适用于内部上下游系统之间调用请求不平缓的场景，由于内部系统的服务质量要求不能随意丢弃请求，所以使用消息队列能起到很好的削峰和缓冲作用。</p><p>而答题更适用于秒杀或者营销活动等应用场景，在请求发起端就控制发起请求的速度，因为越到后面无效请求也会越多，所以配合后面介绍的分层拦截的方式，可以更进一步减少无效请求对系统资源的消耗。</p><p>分层过滤非常适合交易性的写请求，比如减库存或者拼车这种场景，在读的时候需要知道还有没有库存或者是否还有剩余空座位。但是由于库存和座位又是不停变化的，所以读的数据是否一定要非常准确呢？其实不一定，你可以放一些请求过去，然后在真正减的时候再做强一致性保证，这样既过滤一些请求又解决了强一致性读的瓶颈。</p><p>不过，在削峰的处理方式上除了采用技术手段，其实还可以采用业务手段来达到一定效果，例如在零点开启大促的时候由于流量太大导致支付系统阻塞，这个时候可以采用发放优惠券、发起抽奖活动等方式，将一部分流量分散到其他地方，这样也能起到缓冲流量的作用。</p><p>最后，欢迎你在留言区和我交流，你也可以说说在实际工作中，还有哪些对流量进行削峰的不同思路或方案，非常期待。</p><p></p>","neighbors":{"left":{"article_title":"03 | 二八原则：有针对性地处理好系统的“热点数据”","id":40729},"right":{"article_title":"05 | 影响性能的因素有哪些？又该如何提高系统的性能？","id":40742}},"comments":[{"had_liked":false,"id":54369,"user_name":"烛火下的乌托邦","can_delete":false,"product_type":"c1","uid":1213149,"ip_address":"","ucode":"FA181682F65727","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLmQJ7hMJzmgMgUjgibpjnJYCZvvx7LS7G0sCGuzra8PHad9UBqPy7NwpWCsicvibGkYBOj7VLCLtTSg/132","comment_is_top":false,"comment_ctime":1545835828,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"203409298740","product_id":100017501,"comment_content":"MD5说成加密又怎么样？本来MD5的存在不就是为了加密吗？至于原理大家明白就可以了，真的是。。。","like_count":48,"discussions":[{"author":{"id":1603271,"avatar":"","nickname":"Geek_f3a3d1","note":"","ucode":"E15FA1C3AB3174","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":93466,"discussion_content":"算是该详细的不详细。作者对知识有所隐瞒吧。","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1576928422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139373,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/ad/3b780869.jpg","nickname":"Panda_High","note":"","ucode":"41A94A45ACCE1E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553000,"discussion_content":"水平太低，戾气太重","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1645684246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1952124,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/c9/7c/fae4262e.jpg","nickname":"西野子言","note":"","ucode":"130B4FBE5BFB18","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245600,"discussion_content":"所以应该说成MD5，不带“加密”这两个字？！你可真优秀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587688729,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95910,"user_name":"無忘","can_delete":false,"product_type":"c1","uid":1122598,"ip_address":"","ucode":"A9BB59B9CB136E","user_header":"https://static001.geekbang.org/account/avatar/00/11/21/26/ebc6b234.jpg","comment_is_top":false,"comment_ctime":1558253580,"is_pvip":false,"discussion_count":10,"race_medal":0,"score":"164767010828","product_id":100017501,"comment_content":"很无奈，关键的下单通过消息队列接收，但是如何及时将用户是否抢成功的结果反馈给前端用户，这个没有说明！<br><br>用户是下单成功页面停留？间隔刷新去获取最后的抢购结果吗？还是说单独给个页面让用户查询自己是否抢购成功！<br><br>其实不少人问得是这个问题！<br><br>消息队列只能返回给你消息是否投递成功，不能告诉你抢购是否成功！😪 <br><br>反而令牌桶的方式比较靠谱，预先生成一定数量令牌，取到令牌放入队列，返回抢购成功！不做后续处理，及时返回！","like_count":39,"discussions":[{"author":{"id":1195258,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg","nickname":"文敦复","note":"","ucode":"B8F4A6BD5D7805","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":199186,"discussion_content":"1、令牌筒也是限流的一种方式，但是抢到令牌，不代表下单成功吧！？\n2、下单成功与否，应该是依赖订单生成和库存减少这些个事务操作是否成功来决定的吧？","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1583567614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1443078,"avatar":"https://static001.geekbang.org/account/avatar/00/16/05/06/f5979d65.jpg","nickname":"亚洲舞王.尼古拉斯赵四","note":"","ucode":"7159F5D7232696","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":78782,"discussion_content":"我也是想知道这个才买的这个课","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1576021852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1182516,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","nickname":"王盛武","note":"","ucode":"DE7EF246D3DCE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1443078,"avatar":"https://static001.geekbang.org/account/avatar/00/16/05/06/f5979d65.jpg","nickname":"亚洲舞王.尼古拉斯赵四","note":"","ucode":"7159F5D7232696","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":117009,"discussion_content":"我知道","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578068805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":78782,"ip_address":""},"score":117009,"extra":""},{"author":{"id":1158156,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ac/0c/f3e37765.jpg","nickname":"夏","note":"","ucode":"2DE213960503A8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1443078,"avatar":"https://static001.geekbang.org/account/avatar/00/16/05/06/f5979d65.jpg","nickname":"亚洲舞王.尼古拉斯赵四","note":"","ucode":"7159F5D7232696","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577041,"discussion_content":"同感！要退钱！语焉不详的垃圾课！作者人品有问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655897111,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":78782,"ip_address":""},"score":577041,"extra":""}]},{"author":{"id":1095012,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b5/64/248749df.jpg","nickname":"速水御舟","note":"","ucode":"6803881344A16E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368836,"discussion_content":"我也是想看这个，结果没有","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1618841631,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120395,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ6Gia1LtqJmDBakeMqgdq2OXymy6AUbTKicjFrLwsia3As8aGDpib6ias7zMyxibUKAJ56LjV02LQMn1Nw/132","nickname":"姜超","note":"","ucode":"1622266500CE14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358989,"discussion_content":"令牌还在实时产生，所以获得令牌≠抢购成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616080871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1485074,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a9/12/c1ec44b5.jpg","nickname":"MJC","note":"","ucode":"B1DEAD985734F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":268955,"discussion_content":"可以做同步阻塞，线程挂起，等待消息返回，当前请求返回，就是比较慢。他说用消息队列的场景是，请求不能随意丢弃的情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589851488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1446717,"avatar":"https://static001.geekbang.org/account/avatar/00/16/13/3d/63bab08c.jpg","nickname":"小小少年","note":"","ucode":"BCBEC92B9DFA85","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6296,"discussion_content":"大家积极讨论啊,我也问的是这个\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566827497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1182516,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","nickname":"王盛武","note":"","ucode":"DE7EF246D3DCE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1446717,"avatar":"https://static001.geekbang.org/account/avatar/00/16/13/3d/63bab08c.jpg","nickname":"小小少年","note":"","ucode":"BCBEC92B9DFA85","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":117011,"discussion_content":"我知道","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578068826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":6296,"ip_address":""},"score":117011,"extra":""},{"author":{"id":1206260,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIv1HejPpCFLKP6z5qJWUTPr55hmxe37lXj7kFj9KMoQfic4goddiaFO03a0P9wZIA6M1EmX96PlPYg/132","nickname":"大菠萝","note":"","ucode":"BB70B313B88A30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1182516,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","nickname":"王盛武","note":"","ucode":"DE7EF246D3DCE8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307268,"discussion_content":"愿闻其详","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600582373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":117011,"ip_address":""},"score":307268,"extra":""}]}]},{"had_liked":false,"id":30001,"user_name":"胡镇华","can_delete":false,"product_type":"c1","uid":1253628,"ip_address":"","ucode":"E4FE336242CD80","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/fc/927ab903.jpg","comment_is_top":false,"comment_ctime":1538622077,"is_pvip":false,"replies":[{"id":"11694","content":"就是实时处理，每个请求过来实时处理，先过来先处理","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539497367,"ip_address":"","comment_id":30001,"utype":1}],"discussion_count":8,"race_medal":0,"score":"164747379325","product_id":100017501,"comment_content":"用消息队列实现的话，处理结果无法立即知晓，用户体验不真实，有没有更实时的方案？","like_count":39,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425807,"discussion_content":"就是实时处理，每个请求过来实时处理，先过来先处理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539497367,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1089732,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a0/c4/4ab49f4e.jpg","nickname":"孔祥鑫","note":"","ucode":"121EC48A798034","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":242986,"discussion_content":"这个问题在极客相关的课程里看到过很多次，只要涉及到后端异步处理的，基本上都会带出来前端如何给用户反馈结果的问题。然而大部分作者对这个问题都有些答非所问，猜想是不是都比较专注在后端，前端体验并不在他的职责范围之内","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1587515724,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1073596,"avatar":"https://static001.geekbang.org/account/avatar/00/10/61/bc/88a905a5.jpg","nickname":"赵强强","note":"","ucode":"1B8AE07484C69A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1089732,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a0/c4/4ab49f4e.jpg","nickname":"孔祥鑫","note":"","ucode":"121EC48A798034","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283103,"discussion_content":"会给前端一个轮训接口","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1592183698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":242986,"ip_address":""},"score":283103,"extra":""}]},{"author":{"id":1198218,"avatar":"https://static001.geekbang.org/account/avatar/00/12/48/8a/a20396e9.jpg","nickname":"live fast","note":"","ucode":"D5ECDDA2DBE5AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328945,"discussion_content":"秒杀用答题和异步消息有些怪","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606280492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1116081,"avatar":"https://static001.geekbang.org/account/avatar/00/11/07/b1/d03668fa.jpg","nickname":"h.h","note":"","ucode":"2ED4A3A98DF5E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":166549,"discussion_content":"可以用查询模式，前端轮询结果。当下单按钮点击后，前端就启定时任务去轮询结果。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1581410118,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","nickname":"悟空WuKong","note":"","ucode":"49AFD2B048C1BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217360,"discussion_content":"我觉得减库存和创建订单可以同步，其他的像付款、增加积分啥的就异步","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585548995,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1095012,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b5/64/248749df.jpg","nickname":"速水御舟","note":"","ucode":"6803881344A16E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368838,"discussion_content":"这个问题老师有没有给解答呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618841816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39809,"discussion_content":"阻塞等待秒杀结果吗? ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571991849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32330,"user_name":"看不到de颜色","can_delete":false,"product_type":"c1","uid":1162714,"ip_address":"","ucode":"88348CCAE81931","user_header":"https://static001.geekbang.org/account/avatar/00/11/bd/da/3d76ea74.jpg","comment_is_top":false,"comment_ctime":1539533903,"is_pvip":false,"replies":[{"id":"12243","content":"大家对请求队列这块问的比较多，疑问也多，后面相关的问题我找个时间统一回答一下吧。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540098060,"ip_address":"","comment_id":32330,"utype":1}],"discussion_count":1,"race_medal":0,"score":"48784174159","product_id":100017501,"comment_content":"看完本篇文章，有几点疑问还想请老师解答一下。<br>1.使用消息队列削峰的话，可以知道消息是否被消费，但是是否真的秒杀成功该如何向用户返回。<br>2.看到老师提到削峰的方式，之前有看过到诸如令牌桶，漏桶之类的算法。是否也可以在此引入呢？<br>3.如果并发请求过大的话是否可以在每个服务上加入信号量来控制，数量为库存大小。每当处理一个请求就减一下，归零不再向下处理呢。","like_count":10,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426731,"discussion_content":"大家对请求队列这块问的比较多，疑问也多，后面相关的问题我找个时间统一回答一下吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540098060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30096,"user_name":"Ballontt","can_delete":false,"product_type":"c1","uid":1016269,"ip_address":"","ucode":"68F452A4DFD569","user_header":"https://static001.geekbang.org/account/avatar/00/0f/81/cd/f5555346.jpg","comment_is_top":false,"comment_ctime":1538659885,"is_pvip":false,"replies":[{"id":"10943","content":"光从减少请求的角度可以，但是体验会很差😃","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538819599,"ip_address":"","comment_id":30096,"utype":1}],"discussion_count":2,"race_medal":0,"score":"44488332845","product_id":100017501,"comment_content":"可不可以前端直接按照1%的概率去请求后台接口。请数量一下就下降了100倍","like_count":10,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425853,"discussion_content":"光从减少请求的角度可以，但是体验会很差😃","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538819599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1190085,"avatar":"https://static001.geekbang.org/account/avatar/00/12/28/c5/3a880251.jpg","nickname":"李鑫|MT","note":"","ucode":"D9985A7D2EC2FF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":181194,"discussion_content":"那还有没有先来后到了？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582344534,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30085,"user_name":"Lost In The Echo。","can_delete":false,"product_type":"c1","uid":1211954,"ip_address":"","ucode":"6EC7BF57DA3A15","user_header":"https://static001.geekbang.org/account/avatar/00/12/7e/32/e569f729.jpg","comment_is_top":false,"comment_ctime":1538650943,"is_pvip":false,"replies":[{"id":"11683","content":"参考一下nero的回答哈","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539496951,"ip_address":"","comment_id":30085,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44488323903","product_id":100017501,"comment_content":"请求入队列后怎么给用户“交代”？","like_count":10,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425848,"discussion_content":"参考一下nero的回答哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539496951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30780,"user_name":"皇甫","can_delete":false,"product_type":"c1","uid":1126865,"ip_address":"","ucode":"6856B2508661E0","user_header":"https://static001.geekbang.org/account/avatar/00/11/31/d1/dc1f9b95.jpg","comment_is_top":false,"comment_ctime":1538996369,"is_pvip":false,"replies":[{"id":"11191","content":"如果是同步的就要等待消息被正确投递后才返回结果，但大部分就是异步的，寄发送后即返回，然后由消息队列保证最后最终被投递，这个要由消息队列自己来承诺sla","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539084888,"ip_address":"","comment_id":30780,"utype":1}],"discussion_count":1,"race_medal":0,"score":"40193702033","product_id":100017501,"comment_content":"请问徐老师，当请求被丢进消息队列以后，是就直接返回给用户吗？ 那用户怎么知道请求是否成功了呢？","like_count":9,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426095,"discussion_content":"如果是同步的就要等待消息被正确投递后才返回结果，但大部分就是异步的，寄发送后即返回，然后由消息队列保证最后最终被投递，这个要由消息队列自己来承诺sla","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539084888,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36895,"user_name":"Geek_c991e0","can_delete":false,"product_type":"c1","uid":1206623,"ip_address":"","ucode":"5B6391E2D69D50","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epLLXBLBLgticobxvBYRezd304Y66Q8ibYCl7mG9dvTHGrx9obRcn7ZmJBcib3ibsQPIX3xIbNYiaAUrOA/132","comment_is_top":false,"comment_ctime":1541382208,"is_pvip":false,"replies":[{"id":"14465","content":"入了队列不处理就超时了，队列的大小不应该和秒杀商品数关联","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1542529698,"ip_address":"","comment_id":36895,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23016218688","product_id":100017501,"comment_content":"大神问下，如果秒杀库存总数是10，那削峰队列大小就是10吗，如果有后面不买了，但是已经入了队列了，怎么办。还是说队列放所有请求，这样的话是不是浪费啊","like_count":5,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428079,"discussion_content":"入了队列不处理就超时了，队列的大小不应该和秒杀商品数关联","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542529698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32317,"user_name":"GrubbyLu","can_delete":false,"product_type":"c1","uid":1063483,"ip_address":"","ucode":"1B471210A668EF","user_header":"https://static001.geekbang.org/account/avatar/00/10/3a/3b/3a6efa8f.jpg","comment_is_top":false,"comment_ctime":1539529080,"is_pvip":false,"replies":[{"id":"12244","content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一、详细回答一下吧","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540098097,"ip_address":"","comment_id":32317,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18719398264","product_id":100017501,"comment_content":"徐老师看了其他同学的留言以及您的回复之后，还是有一点不能理解。就是用消息队列进行解耦之后，如何把消息队列处理秒杀请求的结果反馈给用户，有什么好的通知方式嘛？（看到有一个同学留言说用长链接异步推送结果，您说用户体验偏差，麻烦能介绍一些好的方式嘛）","like_count":4,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426724,"discussion_content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一、详细回答一下吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540098097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29906,"user_name":"潘政宇","can_delete":false,"product_type":"c1","uid":1254758,"ip_address":"","ucode":"9A6658EE862D95","user_header":"https://static001.geekbang.org/account/avatar/00/13/25/66/4835d92e.jpg","comment_is_top":false,"comment_ctime":1538586541,"is_pvip":true,"replies":[{"id":"10754","content":"有多种处理方式，一种是丢弃<br>还有可以把队列序列化到文件，然后再慢慢消化","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538617970,"ip_address":"","comment_id":29906,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18718455725","product_id":100017501,"comment_content":"队列被打满了，直接丢包吗？","like_count":4,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425772,"discussion_content":"有多种处理方式，一种是丢弃\n还有可以把队列序列化到文件，然后再慢慢消化","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538617970,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29901,"user_name":"大老杨","can_delete":false,"product_type":"c1","uid":1114792,"ip_address":"","ucode":"51694DBB013715","user_header":"https://static001.geekbang.org/account/avatar/00/11/02/a8/ff61bff2.jpg","comment_is_top":false,"comment_ctime":1538585039,"is_pvip":false,"replies":[{"id":"10756","content":"答题是有两种效果<br>一是可以防止一些秒杀器<br>二是可以延长一部分答题时间<br>是不是影响体验，我觉得体验和上面两条相比应该要做些妥协","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538618179,"ip_address":"","comment_id":29901,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18718454223","product_id":100017501,"comment_content":"这种答题的是不是对于秒杀场景用户体验不是很好","like_count":4,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425769,"discussion_content":"答题是有两种效果\n一是可以防止一些秒杀器\n二是可以延长一部分答题时间\n是不是影响体验，我觉得体验和上面两条相比应该要做些妥协","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538618179,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95636,"user_name":"LionHeart","can_delete":false,"product_type":"c1","uid":1080165,"ip_address":"","ucode":"12A9BF1E407943","user_header":"","comment_is_top":false,"comment_ctime":1558107700,"is_pvip":false,"replies":[{"id":"34281","content":"😂","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1558245246,"ip_address":"","comment_id":95636,"utype":1}],"discussion_count":8,"race_medal":0,"score":"14443009588","product_id":100017501,"comment_content":"有个奇怪的想法，比如10万个人12:00秒杀10个商品，系统在12:00前在10万个人中挑选10个用户id放缓存，真正秒杀时直接判断用户id在不在缓存中，在缓存就进入后面的逻辑，最差的情况就是缓存中的10个用户最终没有来秒杀，那再走正常的秒杀逻辑","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":450541,"discussion_content":"😂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558245246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1064054,"avatar":"https://static001.geekbang.org/account/avatar/00/10/3c/76/b63e0dc1.jpg","nickname":"高","note":"","ucode":"7647D8257CEFAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100380,"discussion_content":"按照这个思路，自己悄悄注册一个账号，每次都提前选中我自己","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1577256128,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1308783,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f8/6f/080973cf.jpg","nickname":"Edward","note":"","ucode":"10FAADF92D05F4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2263,"discussion_content":"哥们，思路很新奇，不过千万别这么干","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1563417863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1106532,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e2/64/b5f4fa28.jpg","nickname":"测试账号勿删","note":"","ucode":"1645D775C95094","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1308783,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f8/6f/080973cf.jpg","nickname":"Edward","note":"","ucode":"10FAADF92D05F4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":133613,"discussion_content":"为啥？这样对客户来说也是随机的啊，也算是公平的啊","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1578975817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2263,"ip_address":""},"score":133613,"extra":""},{"author":{"id":2244755,"avatar":"https://static001.geekbang.org/account/avatar/00/22/40/93/455b1560.jpg","nickname":"CERT","note":"","ucode":"9A0F5785B74851","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1106532,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e2/64/b5f4fa28.jpg","nickname":"测试账号勿删","note":"","ucode":"1645D775C95094","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381660,"discussion_content":"随机是随机，但假如你选中的这10个用户是10万个人最后点击进入的，先来的抢不到，就怀疑你这个平台作弊了，信用崩塌比系统崩掉更危险","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625153576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":133613,"ip_address":""},"score":381660,"extra":""}]},{"author":{"id":1195572,"avatar":"","nickname":"hailowell","note":"","ucode":"557DCAB01710AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316044,"discussion_content":"思路真清奇😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603352887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063114,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/7b/0a/b65e1fae.jpg","nickname":"不要挑战自己的智商","note":"","ucode":"4910FF07C35DC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306431,"discussion_content":"你觉得这样更快？有时间去捕捉那10个id，还不如直接处理先进来的id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600267195,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1790764,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/53/2c/4aa39edd.jpg","nickname":"Jannik","note":"","ucode":"510CD8FA4FD4C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304554,"discussion_content":"这个内部用户作弊太简单了，不合适吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599613561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":44369,"user_name":"弘毅","can_delete":false,"product_type":"c1","uid":1109305,"ip_address":"","ucode":"2EF8604D8795DB","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/39/d9706a1a.jpg","comment_is_top":false,"comment_ctime":1543415421,"is_pvip":true,"replies":[{"id":"16256","content":"因为库存是有限的，没有库存后续的请求都是无效请求了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1543727429,"ip_address":"","comment_id":44369,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14428317309","product_id":100017501,"comment_content":"我想问下，对于一个秒杀，什么样的请求是无效请求呢？感觉所有订单请求都是希望购买的有效请求，那么就这个请求的有效和无效是基于什么来区分的？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":430742,"discussion_content":"因为库存是有限的，没有库存后续的请求都是无效请求了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543727429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1203293,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5c/5d/974b033f.jpg","nickname":"陆老师","note":"","ucode":"0EA27C4755FF4A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331543,"discussion_content":"作者你回答的这不是屁话么","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606897426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34306,"user_name":"😂😂😂","can_delete":false,"product_type":"c1","uid":1102119,"ip_address":"","ucode":"25C8AB9315FE4B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d1/27/e364df55.jpg","comment_is_top":false,"comment_ctime":1540097576,"is_pvip":false,"replies":[{"id":"12626","content":"下单时是实时写数据库的","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540629379,"ip_address":"","comment_id":34306,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14424999464","product_id":100017501,"comment_content":"不好意思，我表述错了。是在给多张表插入数据时，像并发情况下，很多用户都下订单并付款，那么插入时是直接插入到数据库吗？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427170,"discussion_content":"下单时是实时写数据库的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540629379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31617,"user_name":"五年","can_delete":false,"product_type":"c1","uid":1081224,"ip_address":"","ucode":"28A6F945FB0626","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/88/c4263c58.jpg","comment_is_top":false,"comment_ctime":1539246442,"is_pvip":false,"replies":[{"id":"11660","content":"这个地方发放优惠券这个是一个营销策略，主要是为了分散流量，例如在活动页面可以通过弹窗的方式，把一部分用户吸引到一个新的业务，让用户玩个游戏，通关了就发放一个优惠券。这个方式当然是吸引那种还没有明确下单目标的用户，如果你已经有了目标商品了，就等着时间一到来下单了，那么优惠券对你也没有吸引力，其实优惠券也不是要吸引所有的用户，那样也起不到分流的目的了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539491073,"ip_address":"","comment_id":31617,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14424148330","product_id":100017501,"comment_content":"零点大促开始了...发放优惠券怎么操作呢....我这个时候已经在指定商品这里等着了....","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426430,"discussion_content":"这个地方发放优惠券这个是一个营销策略，主要是为了分散流量，例如在活动页面可以通过弹窗的方式，把一部分用户吸引到一个新的业务，让用户玩个游戏，通关了就发放一个优惠券。这个方式当然是吸引那种还没有明确下单目标的用户，如果你已经有了目标商品了，就等着时间一到来下单了，那么优惠券对你也没有吸引力，其实优惠券也不是要吸引所有的用户，那样也起不到分流的目的了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539491073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31437,"user_name":"Lee","can_delete":false,"product_type":"c1","uid":1253051,"ip_address":"","ucode":"47B0D1FB9162BA","user_header":"","comment_is_top":false,"comment_ctime":1539179316,"is_pvip":false,"replies":[{"id":"11664","content":"参考下我给nero的回答哈","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539494353,"ip_address":"","comment_id":31437,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14424081204","product_id":100017501,"comment_content":"有两个小问题请教一下：<br>生产者将用户请求放入队列后，用户的请求就结束了，但是消费者还未处理，这时生产者给用户返回什么呢？<br>队列的消费者处理完用户的请求后，怎么返回结果给用户呢？ ","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426336,"discussion_content":"参考下我给nero的回答哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539494353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30728,"user_name":"func","can_delete":false,"product_type":"c1","uid":1254534,"ip_address":"","ucode":"481018617F42D8","user_header":"https://static001.geekbang.org/account/avatar/00/13/24/86/6069f169.jpg","comment_is_top":false,"comment_ctime":1538984060,"is_pvip":false,"replies":[{"id":"11194","content":"你可以了解一下rocketmq是怎么做的😃","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539085166,"ip_address":"","comment_id":30728,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14423885948","product_id":100017501,"comment_content":"许大神你好，请求入队列后怎么给用户  反馈结果？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426074,"discussion_content":"你可以了解一下rocketmq是怎么做的😃","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539085166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1053069,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKdcWLjLTJBu1OFpM3TW9shLSMibP2rBaic0cAsrMMibMhXvZ3ZZbEibryT6S3P8JB7bOBs6X9dKvLsicw/132","nickname":"洪洪洪水","note":"","ucode":"89B7FEF17767C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279929,"discussion_content":"rocketmq怎么做的？^_^","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1591452265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30134,"user_name":"落雪飞花","can_delete":false,"product_type":"c1","uid":1095320,"ip_address":"","ucode":"76C6813E9DDC4C","user_header":"https://static001.geekbang.org/account/avatar/00/10/b6/98/46ec8e9a.jpg","comment_is_top":false,"comment_ctime":1538696171,"is_pvip":false,"replies":[{"id":"10941","content":"可以提前预热","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538819366,"ip_address":"","comment_id":30134,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14423598059","product_id":100017501,"comment_content":"增加答题之后，答题系统应该也有性能瓶颈，是提前预热还是怎么处理？","like_count":3,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425865,"discussion_content":"可以提前预热","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538819366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262713,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1605831253,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"10195765845","product_id":100017501,"comment_content":"（前面的留言因为有敏感词所以分了好几段，改正敏感词后，重发一遍）<br><br>看到削峰填谷首先想到消息队列，但是对于秒杀来说，可能时效性的要求会更高一些，而且不要求填谷。<br><br>看到很多留言在问如何通过消息队列通知用户，但是我感觉这个应该不难啊，一般可能是用户在秒杀下单页面等待（时间很短），如果消息队列处理结束（成功或者失败），就通知用户。在用户端阻塞，但是在服务端异步。<br><br>把老师给 nero 的回答抄录在下面，等着看老师之后的答疑。<br><br>“如果是同步的就要等待消息被正确投递后才返回结果，但大部分就是异步的，寄发送后即返回，然后由消息队列保证最后最终被投递，这个要由消息队列自己来承诺 sla”<br><br>一开始我以为各种答题只是为了屏蔽机器人或者秒杀器，原来还有延缓请求的作用，即使你答题的速度超过 99% 的人，其实也被“延缓”了。<br><br>封层过滤比较好理解，真正能进入下单环节（写数据库）的，其实没有多少人。<br><br>如果把三种流量削峰的方法结合起来用，那么可能最外层是答题，然后是分层过滤，在后台写系统的时候加入消息队列，不知道这种设想是否正确。","like_count":2},{"had_liked":false,"id":218776,"user_name":"山猫","can_delete":false,"product_type":"c1","uid":1466682,"ip_address":"","ucode":"004F622AEDA906","user_header":"https://static001.geekbang.org/account/avatar/00/16/61/3a/a259c187.jpg","comment_is_top":false,"comment_ctime":1589874179,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10179808771","product_id":100017501,"comment_content":"之前面试时，问我如何做投票系统，特别是针对大流量和恶意投票。其实这些方法基本上是通用的。","like_count":2,"discussions":[{"author":{"id":1198218,"avatar":"https://static001.geekbang.org/account/avatar/00/12/48/8a/a20396e9.jpg","nickname":"live fast","note":"","ucode":"D5ECDDA2DBE5AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328948,"discussion_content":"能讲讲你的观点吗\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606280801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76985,"user_name":"悟空WuKong","can_delete":false,"product_type":"c1","uid":1139455,"ip_address":"","ucode":"49AFD2B048C1BA","user_header":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","comment_is_top":false,"comment_ctime":1552794029,"is_pvip":false,"replies":[{"id":"30093","content":"感谢","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1554532685,"ip_address":"","comment_id":76985,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10142728621","product_id":100017501,"comment_content":"我来晚了，老师还在吗？给老师点个赞！","like_count":2,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443528,"discussion_content":"感谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554532685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":51310,"user_name":"D.L","can_delete":false,"product_type":"c1","uid":1339142,"ip_address":"","ucode":"E6DA186C4BB972","user_header":"https://static001.geekbang.org/account/avatar/00/14/6f/06/82d8bdfb.jpg","comment_is_top":false,"comment_ctime":1545151411,"is_pvip":false,"replies":[{"id":"19634","content":"是的，写的时候做强一致性校验","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545823623,"ip_address":"","comment_id":51310,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10135086003","product_id":100017501,"comment_content":"请问，分层过滤这里有点没理解，意思是说每层都做库存检验，但不做强一致（锁）是吗，直到最后一层再做？","like_count":2,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":433401,"discussion_content":"是的，写的时候做强一致性校验","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545823623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34254,"user_name":"Mac Kwan","can_delete":false,"product_type":"c1","uid":1001958,"ip_address":"","ucode":"FC80EBC9CD37A8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/e6/4f00fe55.jpg","comment_is_top":false,"comment_ctime":1540048570,"is_pvip":false,"replies":[{"id":"12219","content":"你描述的这种方式应该是一种异步下单的方式。<br><br>优点是请求不是实时处理的，所以单个请求的处理灵活度比例大，例如可以用事物来保证数据的一致性，单个请求的rt也不用要求太高等，等请求处理完成再把结果推给用户就行<br><br>缺点就是这种异步方式用户体验比较差，就像你说的用户感觉像进入一个黑盒子不知道发生了什么，不是实时的感受到处理结果","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540092322,"ip_address":"","comment_id":34254,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10129983162","product_id":100017501,"comment_content":"让我想起了以前零点去抢特价机票的画面。输入网址打开发现被转向到了一个“小黑屋页面”，倒计时后重新自动刷新尝试才有机会进入到真正的业务网站订机票。老师你能简单分析一下这个方案实现方式以及优缺点吗","like_count":2,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427158,"discussion_content":"你描述的这种方式应该是一种异步下单的方式。\n\n优点是请求不是实时处理的，所以单个请求的处理灵活度比例大，例如可以用事物来保证数据的一致性，单个请求的rt也不用要求太高等，等请求处理完成再把结果推给用户就行\n\n缺点就是这种异步方式用户体验比较差，就像你说的用户感觉像进入一个黑盒子不知道发生了什么，不是实时的感受到处理结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540092322,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31619,"user_name":"五年","can_delete":false,"product_type":"c1","uid":1081224,"ip_address":"","ucode":"28A6F945FB0626","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/88/c4263c58.jpg","comment_is_top":false,"comment_ctime":1539246676,"is_pvip":false,"replies":[{"id":"11618","content":"用消息队列处理秒杀请求，然后长连接异步推送处理结果出来了也是一种实现方式，这是一种异步处理方式，优点是简化了服务端的复杂度，缺点事是，用户体验偏差<br><br><br><br><br><br>","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539421229,"ip_address":"","comment_id":31619,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10129181268","product_id":100017501,"comment_content":"消息队列这个方式也,如果我们进入消息队列的话,想要用户实时知道抢购结果,是不是需要像小米的抢购那种,直接把页面设置成抢购中,然后再回来通知...<br>这个通知是否需要 websocket 长链接,又或者其他实现?","like_count":2,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426432,"discussion_content":"用消息队列处理秒杀请求，然后长连接异步推送处理结果出来了也是一种实现方式，这是一种异步处理方式，优点是简化了服务端的复杂度，缺点事是，用户体验偏差\n\n\n\n\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539421229,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262711,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1605831161,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"5900798457","product_id":100017501,"comment_content":"分层过滤比较好理解，真正能进入下单环节（写数据库）的，其实没有多少人。<br><br>如果把三种流量削峰的方法结合起来用，那么可能最外层是答题，然后是分层过滤，在后台写系统的时候加入消息队列，不知道这种设想是否正确。","like_count":2},{"had_liked":false,"id":82462,"user_name":"jg4igianshu","can_delete":false,"product_type":"c1","uid":1059873,"ip_address":"","ucode":"DE1001BF2D383E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLsia5hqVlTLn17lUBwSpSUzraib7MSH3gOUNWOx8qUwpz3Lp6gFtkIibOMUAouyMGj5RIeTcePUfNkw/132","comment_is_top":false,"comment_ctime":1554217816,"is_pvip":false,"replies":[{"id":"30085","content":"可以理解一个加密串，防止数据被伪造","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1554531875,"ip_address":"","comment_id":82462,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5849185112","product_id":100017501,"comment_content":"问题 key：userId+itemId+question_Id+time+PK<br>答案 key：userId+itemId+answer+PK<br>这两个key我不是很理解，为什么要加上time，还有pk是什么?<br>感谢指点！","like_count":2,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445601,"discussion_content":"可以理解一个加密串，防止数据被伪造","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554531875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34127,"user_name":"杜明欣","can_delete":false,"product_type":"c1","uid":1198150,"ip_address":"","ucode":"7B010119294F99","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIqWaVic6yGdicbM2ca4KaJLo3oVtxnpea9hb2zMKSvM2UNiadF5l3PW88QJibcKiaf5b61c0cVa72ZYjw/132","comment_is_top":false,"comment_ctime":1540013471,"is_pvip":false,"replies":[{"id":"12225","content":"😉","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540093789,"ip_address":"","comment_id":34127,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5834980767","product_id":100017501,"comment_content":"消息队列有处理一种方式是，用户请求进入队列之后，不立即返回而是设置超时同步等待，消息被消费会唤起等待，返回到用户。这样可以防止用户请求给下游系统造成太大压力","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427125,"discussion_content":"😉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540093789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139455,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","nickname":"悟空WuKong","note":"","ucode":"49AFD2B048C1BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217463,"discussion_content":"哪种消息队列","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585562075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":33259,"user_name":"曾斌","can_delete":false,"product_type":"c1","uid":1108573,"ip_address":"","ucode":"E6CEA931C3DEBC","user_header":"https://static001.geekbang.org/account/avatar/00/10/ea/5d/8f7b20a1.jpg","comment_is_top":false,"comment_ctime":1539766954,"is_pvip":false,"replies":[{"id":"12231","content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540096258,"ip_address":"","comment_id":33259,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5834734250","product_id":100017501,"comment_content":"要对流量进行削峰，最容易想到的解决方案就是用消息队列来缓冲瞬时流量，把同步的直接调用转换成异步的间接推送，中间通过一个队...<br>-----------------------------<br>这个方式虽然提高了系统吞吐量，但是库存扣减成功了，如果通知用户秒杀成功？","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426956,"discussion_content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540096258,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1053069,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKdcWLjLTJBu1OFpM3TW9shLSMibP2rBaic0cAsrMMibMhXvZ3ZZbEibryT6S3P8JB7bOBs6X9dKvLsicw/132","nickname":"洪洪洪水","note":"","ucode":"89B7FEF17767C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279912,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591449901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32558,"user_name":"Murray","can_delete":false,"product_type":"c1","uid":1191968,"ip_address":"","ucode":"742A0A1D155D41","user_header":"https://static001.geekbang.org/account/avatar/00/12/30/20/7de2220c.jpg","comment_is_top":false,"comment_ctime":1539607970,"is_pvip":false,"replies":[{"id":"12239","content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540097779,"ip_address":"","comment_id":32558,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5834575266","product_id":100017501,"comment_content":"用消息队列时，如果请求被队列接受到，可不可以理解为前端进入排队页面，然后轮询排队结果，可能抢购成功，可能抢购失败？","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426817,"discussion_content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540097779,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30398,"user_name":"小喵喵","can_delete":false,"product_type":"c1","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":false,"comment_ctime":1538825675,"is_pvip":false,"replies":[{"id":"11206","content":"1.无效请求是针对没发再抢到商品的人来说的<br>2.例如库存数据<br>3.限流保护回来最后一章有介绍<br>","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539088026,"ip_address":"","comment_id":30398,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5833792971","product_id":100017501,"comment_content":"1.分层过滤，既然是请求，为什么有些是无效呢？<br>2.将动态请求的读数据缓存（Cache）在 Web 端，过滤无效的数据读。这个cache是动态的呀，是不是经常需要更新cache呢？能举例一下，到底什么样子的动态数据缓存（Cache）在 Web 端？？<br>3.限流保护具体怎么做？谢谢。","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425980,"discussion_content":"1.无效请求是针对没发再抢到商品的人来说的\n2.例如库存数据\n3.限流保护回来最后一章有介绍\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539088026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29903,"user_name":"Ben","can_delete":false,"product_type":"c1","uid":1253750,"ip_address":"","ucode":"56744C908D9FC8","user_header":"https://static001.geekbang.org/account/avatar/00/13/21/76/5d052ba7.jpg","comment_is_top":false,"comment_ctime":1538586076,"is_pvip":false,"replies":[{"id":"11692","content":"😉","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539497227,"ip_address":"","comment_id":29903,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5833553372","product_id":100017501,"comment_content":"第一第一","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425770,"discussion_content":"😉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539497227,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322469,"user_name":"扭断翅膀的猪","can_delete":false,"product_type":"c1","uid":1251238,"ip_address":"","ucode":"E94AE44B950C91","user_header":"https://static001.geekbang.org/account/avatar/00/13/17/a6/fae3dd91.jpg","comment_is_top":false,"comment_ctime":1637403076,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637403076","product_id":100017501,"comment_content":"能不能用点真正的技术手段. 像什么答题, 分发优惠券打散流量太 low 了吧","like_count":0},{"had_liked":false,"id":311472,"user_name":"段俊河","can_delete":false,"product_type":"c1","uid":1944294,"ip_address":"","ucode":"AFCEF6AE0E1AC7","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwIC7xlfFoSmaTKCAUXgAW7ibLrRS9icPeib7bOODl6CgWITDflWCm4Qjd7ZBmqiafCR4YmRYZHiaFooQ/132","comment_is_top":false,"comment_ctime":1631248181,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631248181","product_id":100017501,"comment_content":"还没有免费的课程讲得好","like_count":0},{"had_liked":false,"id":305499,"user_name":"石建","can_delete":false,"product_type":"c1","uid":1041013,"ip_address":"","ucode":"72339F0F3463E8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/75/94039076.jpg","comment_is_top":false,"comment_ctime":1627999165,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627999165","product_id":100017501,"comment_content":"【对写数据进行基于时间的合理分片，过滤掉过期的失效请求】。这个是啥意义，有人懂吗？","like_count":0},{"had_liked":false,"id":289071,"user_name":"速水御舟","can_delete":false,"product_type":"c1","uid":1095012,"ip_address":"","ucode":"6803881344A16E","user_header":"https://static001.geekbang.org/account/avatar/00/10/b5/64/248749df.jpg","comment_is_top":false,"comment_ctime":1618841740,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618841740","product_id":100017501,"comment_content":"使用消息队列削峰的话，可以知道消息是否被消费，但是是否真的秒杀成功该如何向用户返回？  <br>老师，这个问题能否说一下？？？","like_count":0},{"had_liked":false,"id":289070,"user_name":"速水御舟","can_delete":false,"product_type":"c1","uid":1095012,"ip_address":"","ucode":"6803881344A16E","user_header":"https://static001.geekbang.org/account/avatar/00/10/b5/64/248749df.jpg","comment_is_top":false,"comment_ctime":1618841696,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618841696","product_id":100017501,"comment_content":"使用消息队列削峰的话，可以知道消息是否被消费，但是是否真的秒杀成功该如何向用户返回？","like_count":0},{"had_liked":false,"id":262712,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1605831185,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1605831185","product_id":100017501,"comment_content":"一开始我以为各种答题只是为了挡住机器人，原来还有延缓请求的作用，即使你答题的速度超过 99% 的人，其实也被“延缓”了。<br>","like_count":0},{"had_liked":false,"id":262709,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1605831122,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1605831122","product_id":100017501,"comment_content":"看到削峰填谷首先想到消息队列，但是对于秒杀来说，可能时效性的要求会更高一些，而且不要求填谷。","like_count":0},{"had_liked":false,"id":229376,"user_name":"猿飞日斩","can_delete":false,"product_type":"c1","uid":1668982,"ip_address":"","ucode":"9ABF88EAD3965C","user_header":"https://static001.geekbang.org/account/avatar/00/19/77/76/56740001.jpg","comment_is_top":false,"comment_ctime":1592979713,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592979713","product_id":100017501,"comment_content":"流量消峰最容易想到的是消息队列，采用消息对队列异步就会带来通知用户结果困难的问题，不论是采用客户端轮询（人为增大了流量）还是主动PUSH（人为增大了连接数），从这两个角度考虑建议不使用消息队列，而消息队列对于抗流量洪峰起到很大一部分作用。<br>问腿1，对于超大流量（100w&#47;s）到底用不用消息队列？如果使用又该怎么用？如果不用？触发降级拒绝服务？","like_count":0},{"had_liked":false,"id":192081,"user_name":"Mango","can_delete":false,"product_type":"c1","uid":1734886,"ip_address":"","ucode":"EC2D20BD322E22","user_header":"","comment_is_top":false,"comment_ctime":1584836971,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584836971","product_id":100017501,"comment_content":"流量削峰","like_count":0},{"had_liked":false,"id":110219,"user_name":"Yoph","can_delete":false,"product_type":"c1","uid":1050702,"ip_address":"","ucode":"48E676BA29EC3D","user_header":"https://static001.geekbang.org/account/avatar/00/10/08/4e/87e40222.jpg","comment_is_top":false,"comment_ctime":1562210364,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562210364","product_id":100017501,"comment_content":"答题应该和验证码没有本质区别吧","like_count":0},{"had_liked":false,"id":104512,"user_name":"Eazow","can_delete":false,"product_type":"c1","uid":1346402,"ip_address":"","ucode":"D81D8FF2B2FF0D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/bmgpp5wc8GLmOdHNQccSgrunK0VdIicB6rpTHXCTF5xEkm2YvPHOX2DwNt2EqTzJ70JD41h0u5qW4R0yXRY1ZCg/132","comment_is_top":false,"comment_ctime":1560770256,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1560770256","product_id":100017501,"comment_content":"您好，请问请求加入队列后，是不是会立即返回响应，然后再由客户端ajax请求定时获取请求的处理结果？","like_count":0,"discussions":[{"author":{"id":1053069,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKdcWLjLTJBu1OFpM3TW9shLSMibP2rBaic0cAsrMMibMhXvZ3ZZbEibryT6S3P8JB7bOBs6X9dKvLsicw/132","nickname":"洪洪洪水","note":"","ucode":"89B7FEF17767C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279915,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591450002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":88706,"user_name":"后端进阶","can_delete":false,"product_type":"c1","uid":1125656,"ip_address":"","ucode":"480F48F5378307","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/18/918eaecf.jpg","comment_is_top":false,"comment_ctime":1555983867,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555983867","product_id":100017501,"comment_content":"来晚了，老师讲的很好，顺便买了老师的书来学习，哈哈","like_count":0},{"had_liked":false,"id":82469,"user_name":"jg4igianshu","can_delete":false,"product_type":"c1","uid":1059873,"ip_address":"","ucode":"DE1001BF2D383E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLsia5hqVlTLn17lUBwSpSUzraib7MSH3gOUNWOx8qUwpz3Lp6gFtkIibOMUAouyMGj5RIeTcePUfNkw/132","comment_is_top":false,"comment_ctime":1554219045,"is_pvip":false,"replies":[{"id":"30084","content":"时间精度一般都是毫秒<br>答案key一是可以减少数据的大小，二是可用保护答案不是容易被泄露","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1554531805,"ip_address":"","comment_id":82469,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1554219045","product_id":100017501,"comment_content":"补充提问:time的精读是多少。<br>我思考了下正常只需要问题key，存储的数据包含cdn图片地址和答案。<br>答案key是做什么用？应该不需要记录玩家答题的数据吧！谢谢指点迷津！","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445602,"discussion_content":"时间精度一般都是毫秒\n答案key一是可以减少数据的大小，二是可用保护答案不是容易被泄露","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554531805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50116,"user_name":"饭粒","can_delete":false,"product_type":"c1","uid":1153455,"ip_address":"","ucode":"4C3220B0D43997","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg","comment_is_top":false,"comment_ctime":1544870469,"is_pvip":false,"replies":[{"id":"19636","content":"答题一般是在系统的最外层就判断了，这里说的排队不是指秒杀请求的排队而是指后台系统之间的请求部分需要排队，他是存在于系统之间的调用中。关于排队的说明你可以进一步看一下最后一节的内容","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1545824083,"ip_address":"","comment_id":50116,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1544870469","product_id":100017501,"comment_content":"请问下，如果排队和答题一起采用，排队处理的位置是在系统什么位置？是在 “图 4 答题的验证逻辑” 秒杀请求之前吗？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432883,"discussion_content":"答题一般是在系统的最外层就判断了，这里说的排队不是指秒杀请求的排队而是指后台系统之间的请求部分需要排队，他是存在于系统之间的调用中。关于排队的说明你可以进一步看一下最后一节的内容","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545824083,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":35189,"user_name":"流沙","can_delete":false,"product_type":"c1","uid":1255337,"ip_address":"","ucode":"64F12F181650B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/27/a9/80468562.jpg","comment_is_top":false,"comment_ctime":1540453191,"is_pvip":true,"replies":[{"id":"12634","content":"判断处理的结果就是不得已而丢弃消息，也相当于消息队列不能正常运转了","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540640230,"ip_address":"","comment_id":35189,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1540453191","product_id":100017501,"comment_content":"开始介绍的，使用消息列队，当队列满了之后，不可以做判断处理吗？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427472,"discussion_content":"判断处理的结果就是不得已而丢弃消息，也相当于消息队列不能正常运转了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540640230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":33532,"user_name":"😂😂😂","can_delete":false,"product_type":"c1","uid":1102119,"ip_address":"","ucode":"25C8AB9315FE4B","user_header":"https://static001.geekbang.org/account/avatar/00/10/d1/27/e364df55.jpg","comment_is_top":false,"comment_ctime":1539822425,"is_pvip":false,"replies":[{"id":"12230","content":"创建数据库表？<br>下单为什么会创建很多表？下单只会insert一些数据的。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540096065,"ip_address":"","comment_id":33532,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539822425","product_id":100017501,"comment_content":"我有个问题请教下，在用户下单创建表单时，可能会创建很多表，像这种秒杀系统来说，如何对创建表单过程进行优化","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426984,"discussion_content":"创建数据库表？\n下单为什么会创建很多表？下单只会insert一些数据的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540096065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":32526,"user_name":"奋斗心","can_delete":false,"product_type":"c1","uid":1247286,"ip_address":"","ucode":"06A195AB0B6570","user_header":"https://static001.geekbang.org/account/avatar/00/13/08/36/98be3d69.jpg","comment_is_top":false,"comment_ctime":1539601910,"is_pvip":false,"replies":[{"id":"12241","content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧。","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1540097982,"ip_address":"","comment_id":32526,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1539601910","product_id":100017501,"comment_content":"给nero的回复还是没有看懂。（异步方案）请求到了消息队列，立即返回请求什么，才能保证用户体验。","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426807,"discussion_content":"大家对请求队列这块问的比较多，后面相关的问题我找个时间统一回答一下吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540097982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1053069,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKdcWLjLTJBu1OFpM3TW9shLSMibP2rBaic0cAsrMMibMhXvZ3ZZbEibryT6S3P8JB7bOBs6X9dKvLsicw/132","nickname":"洪洪洪水","note":"","ucode":"89B7FEF17767C3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279911,"discussion_content":"Nero我回复是什么样的？没找到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591449872,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31621,"user_name":"五年","can_delete":false,"product_type":"c1","uid":1081224,"ip_address":"","ucode":"28A6F945FB0626","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/88/c4263c58.jpg","comment_is_top":false,"comment_ctime":1539246747,"is_pvip":false,"replies":[{"id":"11617","content":"题库是独立的<br>交互是因为下单需要验证答案啊","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539420922,"ip_address":"","comment_id":31621,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1539246747","product_id":100017501,"comment_content":"题库系统不是应该独立的吗...交易系统为什么会和题库系统有交互呢...","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426434,"discussion_content":"题库是独立的\n交互是因为下单需要验证答案啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539420922,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30322,"user_name":"脸脸","can_delete":false,"product_type":"c1","uid":1115431,"ip_address":"","ucode":"92144B78022566","user_header":"https://static001.geekbang.org/account/avatar/00/11/05/27/08518c9d.jpg","comment_is_top":false,"comment_ctime":1538792711,"is_pvip":false,"replies":[{"id":"10947","content":"Cdn的数据一致性还要有一个失效系统来完成，这里没有详细介绍了，这个失效也比较复杂，建议可以关注一下我的《大型网站架构演进与性能优化》一书更进一步了解一下","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538820480,"ip_address":"","comment_id":30322,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538792711","product_id":100017501,"comment_content":"老师，我有个问题，在分层过滤方案中如果作为写系统，那么CDN基本职能存放静态类在的资源，服务做到服务器端的处理，如果作为读系统，是可以通过CDN分发网络挡掉一些读请求，但是我们又如何保障CDN节点上面数据的一致性呢，因为据我所知CDN数据的更新时间是具体不确定性的，谢谢老师。另外还想问一下文章中图是使用什么工具画的谢谢。","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425941,"discussion_content":"Cdn的数据一致性还要有一个失效系统来完成，这里没有详细介绍了，这个失效也比较复杂，建议可以关注一下我的《大型网站架构演进与性能优化》一书更进一步了解一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538820480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30104,"user_name":"李明成","can_delete":false,"product_type":"c1","uid":1256488,"ip_address":"","ucode":"E44922559132EB","user_header":"https://static001.geekbang.org/account/avatar/00/13/2c/28/bff8f0c4.jpg","comment_is_top":false,"comment_ctime":1538663192,"is_pvip":false,"replies":[{"id":"11682","content":"😊","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539496915,"ip_address":"","comment_id":30104,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538663192","product_id":100017501,"comment_content":"看了收益很多，有些不明白的地方，等系列的看完，如果还不明白，在提问……","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425856,"discussion_content":"😊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539496915,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29943,"user_name":"Stalary","can_delete":false,"product_type":"c1","uid":1101749,"ip_address":"","ucode":"F69AFF7C958D31","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/b5/d1ec6a7d.jpg","comment_is_top":false,"comment_ctime":1538613293,"is_pvip":false,"replies":[{"id":"10764","content":"序列化到文件为什么会占用很大的内存？序列化到文件可能会影响延时，所以要异步的执行","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1538619603,"ip_address":"","comment_id":29943,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538613293","product_id":100017501,"comment_content":"请求序列化到文件中，是不是会占用很大的内存？","like_count":0,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425783,"discussion_content":"序列化到文件为什么会占用很大的内存？序列化到文件可能会影响延时，所以要异步的执行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538619603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29917,"user_name":"李勇","can_delete":false,"product_type":"c1","uid":1122136,"ip_address":"","ucode":"B5AE3D070D9269","user_header":"https://static001.geekbang.org/account/avatar/00/11/1f/58/ade4475d.jpg","comment_is_top":false,"comment_ctime":1538607412,"is_pvip":false,"replies":[{"id":"11693","content":"😉","user_name":"作者回复","user_name_real":"君山","uid":"1253339","ctime":1539497235,"ip_address":"","comment_id":29917,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1538607412","product_id":100017501,"comment_content":"不错","like_count":1,"discussions":[{"author":{"id":1253339,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1f/db/d7d863ed.jpg","nickname":"君山","note":"","ucode":"F8ACCB6FBFAFCD","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425778,"discussion_content":"😉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539497235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}