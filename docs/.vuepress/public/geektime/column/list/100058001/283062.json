{"id":283062,"title":"09 åˆ†æç¯‡ | å¦‚ä½•å¯¹å†…æ ¸å†…å­˜æ³„æ¼åšäº›åŸºç¡€çš„åˆ†æï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é‚µäºšæ–¹ã€‚</p><p>å¦‚æœä½ æ˜¯ä¸€ååº”ç”¨å¼€å‘è€…ï¼Œé‚£ä½ å¯¹åº”ç”¨ç¨‹åºå¼•èµ·çš„å†…å­˜æ³„æ¼åº”è¯¥ä¸ä¼šé™Œç”Ÿã€‚ä½†æ˜¯ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œå†…å­˜æ³„æ¼ä¹Ÿå¯èƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿï¼ˆå†…æ ¸ï¼‰è‡ªèº«çš„é—®é¢˜å¼•èµ·çš„å‘¢ï¼Ÿè¿™æ˜¯å¾ˆå¤šåº”ç”¨å¼€å‘è€…ä»¥åŠè¿ç»´äººå‘˜å®¹æ˜“å¿½è§†çš„åœ°æ–¹ï¼Œæˆ–è€…æ˜¯ç›¸å¯¹é™Œç”Ÿçš„é¢†åŸŸã€‚</p><p>ç„¶è€Œé™Œç”Ÿçš„é¢†åŸŸä¸ä»£è¡¨ä¸ä¼šæœ‰é—®é¢˜ï¼Œå¦‚æœåœ¨é™Œç”Ÿçš„é¢†åŸŸå‘ç”Ÿäº†é—®é¢˜ï¼Œè€Œä½ æ€»æ˜¯ä¹ æƒ¯äºåˆ†æåº”ç”¨ç¨‹åºè‡ªèº«ï¼Œé‚£ä½ å¯èƒ½è¦æµªè´¹å¾ˆå¤šçš„åˆ†ææ—¶é—´ï¼Œå´ä¾ç„¶ä¸€æ— æ‰€è·ã€‚æ‰€ä»¥ï¼Œå¯¹äºåº”ç”¨å¼€å‘è€…æˆ–è€…è¿ç»´äººå‘˜è€Œè¨€ï¼ŒæŒæ¡åŸºæœ¬çš„å†…æ ¸å†…å­˜æ³„æ¼åˆ†ææ–¹æ³•ä¹Ÿæ˜¯å¿…éœ€çš„ï¼Œè¿™æ ·åœ¨å®ƒå‘ç”Ÿé—®é¢˜æ—¶ï¼Œä½ å¯ä»¥æœ‰ä¸€ä¸ªåˆæ­¥çš„åˆ¤æ–­ï¼Œè€Œä¸è‡³äºä¸€ç­¹è«å±•ã€‚</p><p>å†…æ ¸å†…å­˜æ³„æ¼å¾€å¾€éƒ½ä¼šæ˜¯å¾ˆä¸¥é‡çš„é—®é¢˜ï¼Œè¿™é€šå¸¸æ„å‘³ç€è¦é‡å¯æœåŠ¡å™¨æ¥è§£å†³äº†ï¼Œæˆ‘ä»¬è‚¯å®šå¹¶ä¸å¸Œæœ›åªèƒ½é é‡å¯æœåŠ¡å™¨æ¥è§£å†³å®ƒï¼Œä¸ç„¶é‚£å°±åªèƒ½æ²¡å®Œæ²¡äº†åœ°é‡å¯äº†ã€‚æˆ‘ä»¬å¸Œæœ›çš„åº”è¯¥æ˜¯ï¼Œåœ¨å‘ç”Ÿäº†å†…å­˜æ³„æ¼åï¼Œèƒ½å¤Ÿåˆ¤æ–­å‡ºæ¥æ˜¯ä¸æ˜¯å†…æ ¸å¼•èµ·çš„é—®é¢˜ï¼Œä»¥åŠèƒ½å¤Ÿæ‰¾åˆ°å¼•èµ·é—®é¢˜çš„æ ¹å› ï¼Œæˆ–è€…æ˜¯å‘æ›´ä¸“ä¸šçš„å†…æ ¸å¼€å‘è€…æ±‚åŠ©æ¥æ‰¾åˆ°é—®é¢˜æ ¹å› ï¼Œä»è€Œå½»åº•è§£å†³æ‰å®ƒï¼Œä»¥å…å†æ¬¡é‡å¯æœåŠ¡å™¨ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åˆ¤æ–­å†…å­˜æ³„æ¼æ˜¯å¦æ˜¯å†…æ ¸å¯¼è‡´çš„å‘¢ï¼Ÿè¿™èŠ‚è¯¾æˆ‘ä»¬å°±æ¥è®²ä¸€è®²å†…æ ¸å†…å­˜æ³„æ¼çš„åŸºç¡€åˆ†ææ–¹æ³•ã€‚</p><h2>å†…æ ¸å†…å­˜æ³„æ¼æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>åœ¨è¿›è¡Œå…·ä½“çš„åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹å†…æ ¸å†…å­˜æ³„æ¼æœ‰ä¸ªåˆæ­¥çš„æ¦‚å¿µï¼Œç©¶ç«Ÿå†…æ ¸å†…å­˜æ³„æ¼æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿè¿™å¾—ä»å†…æ ¸ç©ºé—´å†…å­˜åˆ†é…çš„åŸºæœ¬æ–¹æ³•è¯´èµ·ã€‚</p><!-- [[[read_end]]] --><p>æˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/280455\">06åŸºç¡€ç¯‡</a>é‡Œè®²è¿‡ï¼Œè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆaddress spaceï¼‰æ—¢åŒ…æ‹¬ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œä¹ŸåŒ…æ‹¬å†…æ ¸åœ°å€ç©ºé—´ã€‚è¿™å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼Œè¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ€ç”³è¯·çš„å†…å­˜ï¼Œå¯¹åº”çš„æ˜¯ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œè¿›ç¨‹è¿è¡Œåœ¨å†…æ ¸æ€ç”³è¯·çš„å†…å­˜ï¼Œå¯¹åº”çš„æ˜¯å†…æ ¸åœ°å€ç©ºé—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/41/d9/41909181c0f6aa0958c33df52cd626d9.jpg?wh=3700*2809\" alt=\"\"></p><p>åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡malloc()å’Œfree()åœ¨ç”¨æˆ·æ€ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼Œä¸ä¹‹å¯¹åº”ï¼Œå¯ä»¥é€šè¿‡kmalloc()/kfree()ä»¥åŠvmalloc()/vfree()åœ¨å†…æ ¸æ€ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ã€‚å½“ç„¶ï¼Œè¿˜æœ‰å…¶ä»–ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„æ–¹æ³•ï¼Œä½†å¤§è‡´å¯ä»¥åˆ†ä¸ºè¿™ä¸¤ç±»ã€‚</p><p>ä»æœ€å³ä¾§çš„ç‰©ç†å†…å­˜ä¸­ä½ å¯ä»¥çœ‹å‡ºè¿™ä¸¤ç±»å†…å­˜ç”³è¯·æ–¹å¼çš„ä¸»è¦åŒºåˆ«ï¼Œkmalloc()å†…å­˜çš„ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œè€Œvmalloc()å†…å­˜çš„ç‰©ç†åœ°å€åˆ™æ˜¯ä¸è¿ç»­çš„ã€‚è¿™ä¸¤ç§ä¸åŒç±»å‹çš„å†…å­˜ä¹Ÿæ˜¯å¯ä»¥é€šè¿‡/proc/meminfoæ¥è§‚å¯Ÿçš„ï¼š</p><pre><code>$ cat /proc/meminfo\n...\nSlab:            2400284 kB\nSReclaimable:      47248 kB\nSUnreclaim:      2353036 kB\n...\nVmallocTotal:   34359738367 kB\nVmallocUsed:     1065948 kB\n...\n</code></pre><p>å…¶ä¸­vmallocç”³è¯·çš„å†…å­˜ä¼šä½“ç°åœ¨VmallocUsedè¿™ä¸€é¡¹ä¸­ï¼Œå³å·²ä½¿ç”¨çš„VmallocåŒºå¤§å°ï¼›è€Œkmallocç”³è¯·çš„å†…å­˜åˆ™æ˜¯ä½“ç°åœ¨Slabè¿™ä¸€é¡¹ä¸­ï¼Œå®ƒåˆåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­SReclaimableæ˜¯æŒ‡åœ¨å†…å­˜ç´§å¼ çš„æ—¶å€™å¯ä»¥è¢«å›æ”¶çš„å†…å­˜ï¼Œè€ŒSUnreclaimåˆ™æ˜¯ä¸å¯ä»¥è¢«å›æ”¶åªèƒ½ä¸»åŠ¨é‡Šæ”¾çš„å†…å­˜ã€‚</p><p>å†…æ ¸ä¹‹æ‰€ä»¥å°†kmallocå’Œvmallocçš„ä¿¡æ¯é€šè¿‡/proc/meminfoç»™å¯¼å‡ºæ¥ï¼Œä¹Ÿæ˜¯ä¸ºäº†åœ¨å®ƒä»¬å¼•èµ·é—®é¢˜çš„æ—¶å€™ï¼Œè®©æˆ‘ä»¬å¯ä»¥æœ‰æ–¹æ³•æ¥è¿›è¡Œæ’æŸ¥ã€‚åœ¨è®²è¿°å…·ä½“çš„æ¡ˆä¾‹ä»¥åŠæ’æŸ¥æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»¥ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¥çœ‹ä¸‹å†…æ ¸ç©ºé—´æ˜¯å¦‚ä½•è¿›è¡Œå†…å­˜ç”³è¯·å’Œé‡Šæ”¾çš„ã€‚</p><pre><code>/* kmem_test */\n#include &lt;linux/init.h&gt;\n#include &lt;linux/vmalloc.h&gt;\n\n#define SIZE (1024 * 1024 * 1024)\n\nchar *kaddr;\n\nchar *kmem_alloc(unsigned long size)\n{\n        char *p;\n        p = vmalloc(size);\n        if (!p)\n                pr_info(&quot;[kmem_test]: vmalloc failed\\n&quot;);\n        return p;\n}\n\nvoid kmem_free(const void *addr)\n{\n        if (addr)\n                vfree(addr);\n}\n\n\nint __init kmem_init(void)\n{\n        pr_info(&quot;[kmem_test]: kernel memory init\\n&quot;);\n        kaddr = kmem_alloc(SIZE);\n        return 0;\n}\n\n\nvoid __exit kmem_exit(void)\n{\n        kmem_free(kaddr);\n        pr_info(&quot;[kmem_test]: kernel memory exit\\n&quot;);\n}\n\nmodule_init(kmem_init)\nmodule_exit(kmem_exit)\n\nMODULE_LICENSE(&quot;GPLv2&quot;);\n</code></pre><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å†…æ ¸æ¨¡å—ï¼Œåœ¨è¿™ä¸ªå†…æ ¸æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨vmallocæ¥åˆ†é…äº†1Gçš„å†…å­˜ç©ºé—´ï¼Œç„¶ååœ¨æ¨¡å—é€€å‡ºçš„æ—¶å€™ä½¿ç”¨vfreeé‡Šæ”¾æ‰å®ƒã€‚è¿™åœ¨å½¢å¼ä¸Šè·Ÿåº”ç”¨ç”³è¯·/é‡Šæ”¾å†…å­˜å…¶å®æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯ç”³è¯·å’Œé‡Šæ”¾å†…å­˜çš„æ¥å£å‡½æ•°ä¸ä¸€æ ·è€Œå·²ã€‚</p><p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨Makefileæ¥ç¼–è¯‘è¿™ä¸ªå†…æ ¸æ¨¡å—ï¼š</p><pre><code>obj-m = kmem_test.o\n\nall:\n        make -C /lib/modules/`uname -r`/build M=`pwd`\nclean:\n        rm -f *.o *.ko *.mod.c *.mod *.a modules.order Module.symvers\n</code></pre><p>æ‰§è¡Œmakeå‘½ä»¤åå°±ä¼šç”Ÿæˆä¸€ä¸ªkmem_testçš„å†…æ ¸æ¨¡å—ï¼Œæ¥ç€æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥å®‰è£…è¯¥æ¨¡å—äº†ï¼š</p><pre><code>$ insmod kmem_test\n</code></pre><p>ç”¨rmmodå‘½ä»¤åˆ™å¯ä»¥æŠŠå®ƒå¸è½½æ‰ï¼š</p><pre><code>$ rmmod kmem_test\n</code></pre><p>è¿™ä¸ªç¤ºä¾‹ç¨‹åºå°±æ˜¯å†…æ ¸ç©ºé—´å†…å­˜åˆ†é…çš„åŸºæœ¬æ–¹æ³•ã€‚ä½ å¯ä»¥åœ¨æ’å…¥/å¸è½½æ¨¡å—å‰åè§‚å¯ŸVmallocUsedçš„å˜åŒ–ï¼Œä»¥ä¾¿äºä½ æ›´å¥½åœ°ç†è§£è¿™ä¸€é¡¹çš„å«ä¹‰ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿå†…æ ¸ç©ºé—´çš„å†…å­˜æ³„æ¼å‘¢ï¼Ÿ</p><p>è·Ÿç”¨æˆ·ç©ºé—´çš„å†…å­˜æ³„æ¼ç±»ä¼¼ï¼Œå†…æ ¸ç©ºé—´çš„å†…å­˜æ³„æ¼ä¹Ÿæ˜¯æŒ‡åªç”³è¯·å†…å­˜è€Œä¸å»é‡Šæ”¾è¯¥å†…å­˜çš„æƒ…å†µï¼Œæ¯”å¦‚è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸åœ¨kmem_exit()è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨kmem_free()ï¼Œå°±ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼é—®é¢˜ã€‚</p><p>é‚£ä¹ˆï¼Œå†…æ ¸ç©ºé—´çš„å†…å­˜æ³„æ¼ä¸ç”¨æˆ·ç©ºé—´çš„å†…å­˜æ³„æ¼æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œç”¨æˆ·ç©ºé—´å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸä¸ç”¨æˆ·è¿›ç¨‹æ˜¯ä¸€è‡´çš„ï¼Œè¿›ç¨‹é€€å‡ºåè¿™éƒ¨åˆ†å†…å­˜å°±ä¼šè‡ªåŠ¨é‡Šæ”¾æ‰ã€‚ä½†æ˜¯ï¼Œå†…æ ¸ç©ºé—´å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸å†…æ ¸ä¸€è‡´çš„ï¼Œå´ä¸æ˜¯è·Ÿå†…æ ¸æ¨¡å—ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å†…æ ¸æ¨¡å—é€€å‡ºæ—¶ï¼Œä¸ä¼šè‡ªåŠ¨é‡Šæ”¾æ‰è¯¥å†…æ ¸æ¨¡å—ç”³è¯·çš„å†…å­˜ï¼Œåªæœ‰åœ¨å†…æ ¸é‡å¯ï¼ˆå³æœåŠ¡å™¨é‡å¯ï¼‰æ—¶æ‰ä¼šé‡Šæ”¾æ‰è¿™éƒ¨åˆ†å†…å­˜ã€‚</p><p>æ€»ä¹‹ï¼Œä¸€æ—¦å‘ç”Ÿå†…æ ¸å†…å­˜æ³„æ¼ï¼Œä½ å¾ˆéš¾æœ‰å¾ˆå¥½çš„æ–¹æ³•æ¥ä¼˜é›…åœ°è§£å†³æ‰å®ƒï¼Œå¾ˆå¤šæ—¶å€™å”¯ä¸€çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é‡å¯æœåŠ¡å™¨ï¼Œè¿™æ˜¾ç„¶æ˜¯ä»¶å¾ˆä¸¥é‡çš„é—®é¢˜ã€‚åŒæ ·åœ°ï¼Œæˆ‘ä¹Ÿå»ºè®®ä½ æ¥è§‚å¯Ÿä¸‹è¿™ä¸ªè¡Œä¸ºï¼Œä½†æ˜¯ä½ éœ€è¦åšå¥½é‡å¯æœåŠ¡å™¨çš„å¿ƒç†å‡†å¤‡ã€‚</p><p>kmallocçš„ç”¨æ³•è·Ÿvmallocç•¥æœ‰ä¸åŒï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://www.kernel.org/doc/htmldocs/kernel-api/API-kmalloc.html\">kmalloc API</a>å’Œ<a href=\"https://www.kernel.org/doc/htmldocs/kernel-api/API-kfree.html\">kfree API</a>æ¥ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„æµ‹è¯•ç¨‹åºï¼Œç„¶åè§‚å¯Ÿä¸‹kmallocå†…å­˜å’Œ/proc/meminfoä¸­é‚£å‡ é¡¹çš„å…³ç³»ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ä¸åšæ¼”ç¤ºäº†ï¼Œç•™ç»™ä½ ä½œä¸ºè¯¾åä½œä¸šã€‚</p><p>å†…æ ¸å†…å­˜æ³„æ¼çš„é—®é¢˜å¾€å¾€ä¼šå‘ç”Ÿåœ¨ä¸€äº›é©±åŠ¨ç¨‹åºä¸­ï¼Œæ¯”å¦‚è¯´ç½‘å¡é©±åŠ¨ï¼ŒSSDå¡é©±åŠ¨ç­‰ï¼Œä»¥åŠæˆ‘ä»¬è‡ªå·±å¼€å‘çš„ä¸€äº›é©±åŠ¨ï¼Œå› ä¸ºè¿™ç±»é©±åŠ¨ä¸åƒLinuxå†…æ ¸é‚£æ ·ç»å†è¿‡å¤§è§„æ¨¡çš„åŠŸèƒ½éªŒè¯å’Œæµ‹è¯•ï¼Œæ‰€ä»¥ç›¸å¯¹å®¹æ˜“å‡ºç°ä¸€äº›éšè—å¾ˆæ·±çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šå°±é‡åˆ°è¿‡å¾ˆå¤šèµ·è¿™ç±»ç¬¬ä¸‰æ–¹é©±åŠ¨å¼•å‘çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œæ’æŸ¥èµ·æ¥å¾€å¾€ä¹Ÿæ¯”è¾ƒè´¹æ—¶ã€‚ä½œä¸ºä¸€ä¸ªè§£å†³è¿‡å¾ˆå¤šè¿™ç±»é—®é¢˜çš„è¿‡æ¥äººï¼Œæˆ‘å¯¹ä½ çš„å»ºè®®æ˜¯ï¼Œå½“ä½ å‘ç°å†…æ ¸å†…å­˜æ³„æ¼æ—¶ï¼Œé¦–å…ˆéœ€è¦å»è´¨ç–‘çš„å°±æ˜¯ä½ ä»¬ç³»ç»Ÿä¸­çš„ç¬¬ä¸‰æ–¹é©±åŠ¨ç¨‹åºï¼Œä»¥åŠä½ ä»¬è‡ªå·±å¼€å‘çš„é©±åŠ¨ç¨‹åºã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ¥è§‚å¯Ÿå†…æ ¸å†…å­˜æ³„æ¼å‘¢ï¼Ÿ</p><h2>å¦‚ä½•è§‚å¯Ÿå†…æ ¸å†…å­˜æ³„æ¼ï¼Ÿ</h2><p>åœ¨å‰é¢å·²ç»è®²è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡/proc/meminfoæ¥è§‚å¯Ÿå†…æ ¸å†…å­˜çš„åˆ†é…æƒ…å†µï¼Œè¿™æä¾›äº†ä¸€ä¸ªè§‚å¯Ÿå†…æ ¸å†…å­˜çš„ç®€ä¾¿æ–¹æ³•ï¼š</p><ul>\n<li>å¦‚æœ/proc/meminfoä¸­å†…æ ¸å†…å­˜ï¼ˆæ¯”å¦‚VmallocUsedå’ŒSUnreclaimï¼‰å¤ªå¤§ï¼Œé‚£å¾ˆæœ‰å¯èƒ½å‘ç”Ÿäº†å†…æ ¸å†…å­˜æ³„æ¼ï¼›</li>\n<li>å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥å‘¨æœŸæ€§åœ°è§‚å¯ŸVmallocUsedå’ŒSUnreclaimçš„å˜åŒ–ï¼Œå¦‚æœå®ƒä»¬æŒç»­å¢é•¿è€Œä¸ä¸‹é™ï¼Œä¹Ÿå¯èƒ½æ˜¯å‘ç”Ÿäº†å†…æ ¸å†…å­˜æ³„æ¼ã€‚</li>\n</ul><p>/proc/meminfoåªæ˜¯æä¾›äº†ç³»ç»Ÿå†…å­˜çš„æ•´ä½“ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦çœ‹å…·ä½“æ˜¯ä»€ä¹ˆæ¨¡å—åœ¨ä½¿ç”¨å†…å­˜ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™ä¹Ÿå¯ä»¥é€šè¿‡/procæ¥æŸ¥çœ‹ï¼Œæ‰€ä»¥å†æ¬¡å¼ºè°ƒä¸€éï¼Œå½“ä½ ä¸æ¸…æ¥šè¯¥å¦‚ä½•å»åˆ†ææ—¶ï¼Œä½ å¯ä»¥è¯•ç€å»æŸ¥çœ‹/procç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚ä»¥ä¸Šé¢çš„ç¨‹åºä¸ºä¾‹ï¼Œå®‰è£…kmem_testè¿™ä¸ªå†…æ ¸æ¨¡å—åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡/proc/vmallocinfoæ¥çœ‹åˆ°è¯¥æ¨¡å—çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p><pre><code>$ cat /proc/vmallocinfo | grep kmem_test\n0xffffc9008a003000-0xffffc900ca004000 1073745920 kmem_alloc+0x13/0x30 [kmem_test] pages=262144 vmalloc vpages N0=262144\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨[kmem_test]è¿™ä¸ªæ¨¡å—é‡Œï¼Œé€šè¿‡kmem_allocè¿™ä¸ªå‡½æ•°ç”³è¯·äº†262144ä¸ªpagesï¼Œå³æ€»å…±1Gå¤§å°çš„å†…å­˜ã€‚å‡è®¾æˆ‘ä»¬æ€€ç–‘kmem_testè¿™ä¸ªæ¨¡å—å­˜åœ¨é—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»çœ‹çœ‹kmem_allocè¿™ä¸ªå‡½æ•°é‡Œç”³è¯·çš„å†…å­˜æœ‰æ²¡æœ‰é‡Šæ”¾çš„åœ°æ–¹ã€‚</p><p>ä¸Šé¢è¿™ä¸ªæµ‹è¯•ç¨‹åºç›¸å¯¹æ¯”è¾ƒç®€å•ä¸€äº›ï¼Œæ‰€ä»¥æ ¹æ®/proc/vmallocinfoé‡Œé¢çš„ä¿¡æ¯å°±èƒ½å¤Ÿç®€å•åœ°çœ‹å‡ºæ¥æ˜¯å¦æœ‰é—®é¢˜ã€‚ä½†æ˜¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„ä¸€äº›é©±åŠ¨æˆ–è€…å†…æ ¸æ¨¡å—ï¼Œåœ¨é€»è¾‘ä¸Šä¼šå¤æ‚å¾—å¤šï¼Œå¾ˆéš¾ä¸€çœ¼å°±çœ‹å‡ºæ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œè¿™å¾€å¾€éœ€è¦å¤§é‡çš„åˆ†æã€‚</p><p>é‚£å¯¹äºè¿™ç§å¤æ‚åœºæ™¯ä¸‹çš„å†…æ ¸å†…å­˜æ³„æ¼é—®é¢˜ï¼ŒåŸºæœ¬çš„åˆ†ææ€è·¯æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><h2>å¤æ‚åœºæ™¯ä¸‹å†…æ ¸å†…å­˜æ³„æ¼é—®é¢˜åˆ†ææ€è·¯</h2><p>å¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹å†…æ ¸å†…å­˜æ³„æ¼åšäº›åŸºç¡€çš„åˆ†æï¼Œæœ€å¥½å€ŸåŠ©ä¸€äº›å†…æ ¸å†…å­˜æ³„æ¼åˆ†æå·¥å…·ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„åˆ†æå·¥å…·å°±æ˜¯<a href=\"https://www.kernel.org/doc/html/v4.10/dev-tools/kmemleak.html\">kmemleak</a>ã€‚</p><p>kmemleakæ˜¯å†…æ ¸å†…å­˜æ³„æ¼æ£€æŸ¥çš„åˆ©å™¨ï¼Œä½†æ˜¯ï¼Œå®ƒçš„ä½¿ç”¨ä¹Ÿå­˜åœ¨ä¸€äº›ä¸ä¾¿æ€§ï¼Œå› ä¸ºæ‰“å¼€è¯¥ç‰¹æ€§ä¼šç»™æ€§èƒ½å¸¦æ¥ä¸€äº›æŸè€—ï¼Œæ‰€ä»¥ç”Ÿäº§ç¯å¢ƒä¸­çš„å†…æ ¸éƒ½ä¼šé»˜è®¤å…³é—­è¯¥ç‰¹æ€§ã€‚è¯¥ç‰¹æ€§æˆ‘ä»¬ä¸€èˆ¬åªç”¨åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œç„¶ååœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿è¡Œéœ€è¦åˆ†æçš„é©±åŠ¨ç¨‹åºä»¥åŠå…¶ä»–å†…æ ¸æ¨¡å—ã€‚</p><p>ä¸å…¶ä»–å†…å­˜æ³„æ¼æ£€æŸ¥å·¥å…·ç±»ä¼¼ï¼Œkmemleakä¹Ÿæ˜¯é€šè¿‡æ£€æŸ¥å†…æ ¸å†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œæ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç”³è¯·çš„å†…å­˜ä¸å†ä½¿ç”¨ä¹Ÿä¸é‡Šæ”¾çš„æƒ…å†µã€‚å¦‚æœå­˜åœ¨ï¼Œå°±è®¤ä¸ºæ˜¯å†…æ ¸å†…å­˜æ³„æ¼ï¼Œç„¶åæŠŠè¿™äº›æ³„æ¼çš„ä¿¡æ¯é€šè¿‡/sys/kernel/debug/kmemleakè¿™ä¸ªæ–‡ä»¶å¯¼å‡ºç»™ç”¨æˆ·åˆ†æã€‚åŒæ ·ä»¥æˆ‘ä»¬ä¸Šé¢çš„ç¨‹åºä¸ºä¾‹ï¼Œæ£€æŸ¥ç»“æœå¦‚ä¸‹ï¼š</p><pre><code>unreferenced object 0xffffc9008a003000 (size 1073741824):\n  comm &quot;insmod&quot;, pid 11247, jiffies 4344145825 (age 3719.606s)\n  hex dump (first 32 bytes):\n    38 40 18 ba 80 88 ff ff 00 00 00 00 00 00 00 00  8@..............\n    f0 13 c9 73 80 88 ff ff 18 40 18 ba 80 88 ff ff  ...s.....@......\n  backtrace:\n    [&lt;00000000fbd7cb65&gt;] __vmalloc_node_range+0x22f/0x2a0\n    [&lt;000000008c0afaef&gt;] vmalloc+0x45/0x50\n    [&lt;000000004f3750a2&gt;] 0xffffffffa0937013\n    [&lt;0000000078198a11&gt;] 0xffffffffa093c01a\n    [&lt;000000002041c0ec&gt;] do_one_initcall+0x4a/0x200\n    [&lt;000000008d10d1ed&gt;] do_init_module+0x60/0x220\n    [&lt;000000003c285703&gt;] load_module+0x156c/0x17f0\n    [&lt;00000000c428a5fe&gt;] __do_sys_finit_module+0xbd/0x120\n    [&lt;00000000bc613a5a&gt;] __x64_sys_finit_module+0x1a/0x20\n    [&lt;000000004b0870a2&gt;] do_syscall_64+0x52/0x90\n    [&lt;000000002f458917&gt;] entry_SYSCALL_64_after_hwframe+0x44/0xa9\n</code></pre><p>ç”±äºè¯¥ç¨‹åºé€šè¿‡vmallocç”³è¯·çš„å†…å­˜ä»¥åå†ä¹Ÿæ²¡æœ‰ä½¿ç”¨ï¼Œæ‰€ä»¥è¢«kmemleakæ ‡è®°ä¸ºäº†â€œunreferenced objectâ€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä½¿ç”¨å®Œè¯¥å†…å­˜ç©ºé—´åå°±é‡Šæ”¾å®ƒä»¥èŠ‚çœå†…å­˜ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šæ¥è§‚å¯Ÿå†…æ ¸å†…å­˜æ³„æ¼ï¼Œå°±æ— æ³•ä½¿ç”¨kmemleakäº†ï¼Œé‚£è¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ³•å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…æ ¸æä¾›çš„å†…æ ¸å†…å­˜ç”³è¯·é‡Šæ”¾çš„tracepointï¼Œæ¥åŠ¨æ€è§‚å¯Ÿå†…æ ¸å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/4c/8c/4c434f56b5c41f9cc2eb53a2c98f948c.jpg?wh=1977*1133\" alt=\"\"></p><p>å½“æˆ‘ä»¬ä½¿èƒ½è¿™äº›tracepointsåï¼Œå°±å¯ä»¥è§‚å¯Ÿå†…å­˜çš„åŠ¨æ€ç”³è¯·å’Œé‡Šæ”¾æƒ…å†µäº†ï¼Œåªæ˜¯è¿™ä¸ªåˆ†æè¿‡ç¨‹ä¸å¦‚kmemleaké‚£ä¹ˆé«˜æ•ˆã€‚</p><p>å½“æˆ‘ä»¬æƒ³è¦è§‚å¯ŸæŸäº›å†…æ ¸ç»“æ„ä½“çš„ç”³è¯·å’Œé‡Šæ”¾æ—¶ï¼Œå¯èƒ½æ²¡æœ‰å¯¹åº”çš„tracepiontã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨kprobeæˆ–è€…systemtapï¼Œæ¥é’ˆå¯¹å…·ä½“çš„å†…æ ¸ç»“æ„ä½“ç”³è¯·é‡Šæ”¾å‡½æ•°è¿›è¡Œè¿½è¸ªäº†ã€‚ä¸‹é¢å°±æ˜¯æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¸€ä¸ªå…·ä½“æ¡ˆä¾‹ã€‚</p><p>ä¸šåŠ¡æ–¹åé¦ˆè¯´dockeré‡Œé¢çš„å¯ç”¨å†…å­˜è¶Šæ¥è¶Šå°‘ï¼Œä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆçŠ¶å†µï¼Œåœ¨æˆ‘ä»¬é€šè¿‡/procä¸‹é¢çš„æ–‡ä»¶ï¼ˆ/proc/slabinfoï¼‰åˆ¤æ–­å‡ºæ¥æ˜¯dentryæ¶ˆè€—å†…å­˜è¿‡å¤šåï¼Œå†™äº†ä¸€ä¸ªsystemtapè„šæœ¬æ¥è§‚å¯Ÿdentryçš„ç”³è¯·å’Œé‡Šæ”¾ï¼š</p><pre><code># dalloc_dfree.stp\n# usage : stap -x pid dalloc_dfree.stp\nglobal free = 0;\nglobal alloc = 0;\n\nprobe kernel.function(&quot;d_free&quot;) {\n        if (target() == pid()) {\n                free++;\n        }   \n}\n\nprobe kernel.function(&quot;d_alloc&quot;).return {\n        if (target() == pid()) {\n                alloc++;\n        }   \n}\n\nprobe end {\n        printf(&quot;alloc %d free %d\\n&quot;, alloc, free);\n}\n</code></pre><p>æˆ‘ä»¬ä½¿ç”¨è¯¥å·¥å…·è¿›è¡Œäº†å¤šæ¬¡ç»Ÿè®¡ï¼Œéƒ½å‘ç°æ˜¯dentryçš„ç”³è¯·è¿œå¤§äºå®ƒçš„é‡Šæ”¾ï¼š</p><pre><code>alloc 2041 free 1882\nalloc 18137 free 6852\nalloc 22505 free 10834\nalloc 33118 free 20531\n</code></pre><p>äºæ˜¯ï¼Œæˆ‘ä»¬åˆ¤æ–­åœ¨å®¹å™¨ç¯å¢ƒä¸­dentryçš„å›æ”¶å­˜åœ¨é—®é¢˜ï¼Œæœ€ç»ˆå®šä½å‡ºè¿™æ˜¯3.10ç‰ˆæœ¬å†…æ ¸çš„ä¸€ä¸ªBugï¼š å¦‚æœdockerå†…éƒ¨å†…å­˜ä½¿ç”¨è¾¾åˆ°äº†limitï¼Œä½†æ˜¯å…¨å±€å¯ç”¨å†…å­˜è¿˜å¾ˆå¤šï¼Œé‚£å°±æ— æ³•å»å›æ”¶dockerå†…éƒ¨çš„slabäº†ã€‚å½“ç„¶ï¼Œè¿™ä¸ªBugåœ¨<a href=\"https://lwn.net/Articles/628829/\">æ–°ç‰ˆæœ¬å†…æ ¸ä¸Šå·²ç»fixäº†</a>ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾å°±è®²åˆ°è¿™é‡Œã€‚</p><h2>è¯¾å ‚æ€»ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è®²äº†ä¸€ç§æ›´éš¾åˆ†æä»¥åŠå¼•èµ·å±å®³æ›´å¤§çš„å†…å­˜æ³„æ¼ï¼šå†…æ ¸å†…å­˜æ³„æ¼ã€‚æˆ‘ä»¬è¿˜è®²äº†é’ˆå¯¹è¿™ç§å†…å­˜æ³„æ¼çš„å¸¸ç”¨åˆ†ææ–¹æ³•ï¼š</p><ul>\n<li>ä½ å¯ä»¥é€šè¿‡/proc/meminfoé‡Œé¢çš„ä¿¡æ¯æ¥çœ‹å†…æ ¸å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œç„¶åæ ¹æ®è¿™é‡Œé¢çš„ä¿¡æ¯æ¥åšä¸€äº›åŸºæœ¬çš„åˆ¤æ–­ï¼šå¦‚æœå†…æ ¸å¤ªå¤§é‚£å°±å€¼å¾—æ€€ç–‘ï¼›</li>\n<li>kmemleakæ˜¯å†…æ ¸å†…å­˜åˆ†æçš„åˆ©å™¨ï¼Œä½†æ˜¯ä¸€èˆ¬åªåœ¨æµ‹è¯•ç¯å¢ƒä¸Šä½¿ç”¨å®ƒï¼Œå› ä¸ºå®ƒå¯¹æ€§èƒ½ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„å½±å“ï¼›</li>\n<li>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥ä½¿ç”¨tracepointæˆ–è€…kprobeï¼Œæ¥è¿½è¸ªç‰¹å®šç±»å‹å†…æ ¸å†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œä»è€Œå¸®åŠ©æˆ‘ä»¬åˆ¤æ–­æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ã€‚ä½†è¿™å¾€å¾€éœ€è¦ä¸“ä¸šçš„çŸ¥è¯†ï¼Œä½ åœ¨ä¸æ˜ç™½çš„æ—¶å€™å¯ä»¥å»è¯·æ•™ä¸€äº›å†…æ ¸ä¸“å®¶ï¼›</li>\n<li>å†…æ ¸å†…å­˜æ³„æ¼é€šå¸¸éƒ½æ˜¯ç¬¬ä¸‰æ–¹é©±åŠ¨æˆ–è€…è‡ªå·±å†™çš„ä¸€äº›å†…æ ¸æ¨¡å—å¯¼è‡´çš„ï¼Œåœ¨å‡ºç°å†…æ ¸å†…å­˜æ³„æ¼æ—¶ï¼Œä½ å¯ä»¥ä¼˜å…ˆå»æ’æŸ¥å®ƒä»¬ã€‚</li>\n</ul><h2>è¯¾åä½œä¸š</h2><p>æˆ‘ä»¬è¿™èŠ‚è¯¾è®²çš„å†…å®¹å¯¹åº”ç”¨å¼€å‘è€…ä¼šæœ‰äº›éš¾åº¦ï¼Œå¯¹äºè¿ç»´äººå‘˜è€Œè¨€ä¹Ÿæ˜¯éœ€è¦æŒæ¡çš„ã€‚æ‰€ä»¥æˆ‘ä»¬çš„è¯¾åä½œä¸šä¸»è¦æ˜¯é’ˆå¯¹è¿ç»´äººå‘˜æˆ–è€…å†…æ ¸åˆå­¦è€…çš„ï¼šè¯·å†™ä¸€ä¸ªsystemtapè„šæœ¬æ¥è¿½è¸ªå†…æ ¸å†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾ã€‚æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘è®¨è®ºã€‚</p><p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™èŠ‚è¯¾çš„å†…å®¹æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚</p>","neighbors":{"left":{"article_title":"08 æ¡ˆä¾‹ç¯‡ | Shmemï¼šè¿›ç¨‹æ²¡æœ‰æ¶ˆè€—å†…å­˜ï¼Œå†…å­˜å“ªå»äº†ï¼Ÿ","id":282129},"right":{"article_title":"10 åˆ†æç¯‡ | å†…å­˜æ³„æ¼æ—¶ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ä¸€æ­¥æ­¥æ‰¾åˆ°æ ¹å› ï¼Ÿ","id":283787}},"comments":[{"had_liked":false,"id":247841,"user_name":"stackWarn","can_delete":false,"product_type":"c1","uid":1002005,"ip_address":"","ucode":"89672E452DEBA5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","comment_is_top":false,"comment_ctime":1599886372,"is_pvip":false,"replies":[{"id":"91581","content":"å¤§æ¦‚çœ‹äº†ä¸‹ï¼Œåº”è¯¥æ˜¯è·Ÿmodule_exitæœ‰å…³ï¼Œåœ¨exitåkprobeå°±æ— æ³•è¿½è¸ªåˆ°è¿™ä¸ªæ¨¡å—äº†ï¼Œä½ å¯ä»¥åˆ†æä¸‹modlue_exitçš„é€»è¾‘ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"é‚µäºšæ–¹","uid":"1981399","ctime":1600861198,"ip_address":"","comment_id":247841,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10189820964","product_id":100058001,"comment_content":"æ ¹æ®æœ¬æ–‡å†™çš„ä¸€ç¯‡å®éªŒåšå®¢ï¼Œé“¾æ¥ https:&#47;&#47;0xfe.com.cn&#47;post&#47;b6ee23d8.html<br>æœ«å°¾ç¢°åˆ°ä¸ªé—®é¢˜ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰è€å¸ˆå¸®å¿™è§£æƒ‘ï¼ï¼","like_count":2,"discussions":[{"author":{"id":1981399,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/3b/d7/9d942870.jpg","nickname":"é‚µäºšæ–¹","note":"","ucode":"CDFABCB81B9782","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505510,"discussion_content":"å¤§æ¦‚çœ‹äº†ä¸‹ï¼Œåº”è¯¥æ˜¯è·Ÿmodule_exitæœ‰å…³ï¼Œåœ¨exitåkprobeå°±æ— æ³•è¿½è¸ªåˆ°è¿™ä¸ªæ¨¡å—äº†ï¼Œä½ å¯ä»¥åˆ†æä¸‹modlue_exitçš„é€»è¾‘ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600861198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247062,"user_name":"jssfy","can_delete":false,"product_type":"c1","uid":1137238,"ip_address":"","ucode":"F16353CFE607B7","user_header":"https://static001.geekbang.org/account/avatar/00/11/5a/56/115c6433.jpg","comment_is_top":false,"comment_ctime":1599574990,"is_pvip":false,"replies":[{"id":"91117","content":"è¿™éœ€è¦çœ‹slab allocå’Œfreeï¼Œä¸è¿‡è¿™äº›å‡½æ•°ä¼šè°ƒç”¨çš„ç‰¹åˆ«é¢‘ç¹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"é‚µäºšæ–¹","uid":"1981399","ctime":1599976653,"ip_address":"","comment_id":247062,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10189509582","product_id":100058001,"comment_content":"è¯·é—®æ‰¾åˆ°dentryçš„ç”³è¯·å’Œé‡Šæ”¾å‡½æ•°æœ‰ä»€ä¹ˆå¸¸è§„çš„å¥—è·¯å—? å› ä¸ºè¿™æ¬¡æ˜¯dentryä¸‹æ¬¡å¯èƒ½æ˜¯inodeæˆ–è€…å…¶ä»–cache","like_count":2,"discussions":[{"author":{"id":1981399,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/3b/d7/9d942870.jpg","nickname":"é‚µäºšæ–¹","note":"","ucode":"CDFABCB81B9782","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505300,"discussion_content":"è¿™éœ€è¦çœ‹slab allocå’Œfreeï¼Œä¸è¿‡è¿™äº›å‡½æ•°ä¼šè°ƒç”¨çš„ç‰¹åˆ«é¢‘ç¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599976653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247302,"user_name":"ä»è¿œæ–¹è¿‡æ¥","can_delete":false,"product_type":"c1","uid":1797551,"ip_address":"","ucode":"4791DBC7E05B1D","user_header":"","comment_is_top":false,"comment_ctime":1599653636,"is_pvip":false,"replies":[{"id":"91119","content":"è¿™äº›tracepiontéƒ½åœ¨&#47;sys&#47;fs&#47;kernel&#47;debug&#47;tracing&#47;eventsè¿™ä¸ªè·¯å¾„ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡perfæ¥æŸ¥çœ‹ã€‚<br>å¾ˆå¤šæƒ…å†µä¸‹ä¸éœ€è¦çœ‹å†…æ ¸æºç æ‰èƒ½ç”¨ï¼Œä¸»è¦çœ‹ä½ ç”¨ä»–æ¥åšä»€ä¹ˆï¼Œçœ‹å†…æ ¸æºç æ˜¯ä¸ºäº†äº†è§£å†…æ ¸çš„ç»†èŠ‚ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"é‚µäºšæ–¹","uid":"1981399","ctime":1599976866,"ip_address":"","comment_id":247302,"utype":1}],"discussion_count":4,"race_medal":0,"score":"5894620932","product_id":100058001,"comment_content":"è€å¸ˆï¼Œä¸åŒç‰ˆæœ¬çš„å†…æ ¸éƒ½æä¾›äº†é‚£äº›tracepointå‘¢ï¼Ÿåœ¨å“ªé‡Œæœ‰è®°å½•ä¹ˆï¼Ÿ     ç„¶åæ¯ä¸ªtracepointçš„ä½¿ç”¨æ˜¯éœ€è¦çœ‹å†…æ ¸æºç æ‰çŸ¥é“æ€ä¹ˆç”¨ä¹ˆï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1981399,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/3b/d7/9d942870.jpg","nickname":"é‚µäºšæ–¹","note":"","ucode":"CDFABCB81B9782","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505369,"discussion_content":"è¿™äº›tracepiontéƒ½åœ¨/sys/fs/kernel/debug/tracing/eventsè¿™ä¸ªè·¯å¾„ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡perfæ¥æŸ¥çœ‹ã€‚\nå¾ˆå¤šæƒ…å†µä¸‹ä¸éœ€è¦çœ‹å†…æ ¸æºç æ‰èƒ½ç”¨ï¼Œä¸»è¦çœ‹ä½ ç”¨ä»–æ¥åšä»€ä¹ˆï¼Œçœ‹å†…æ ¸æºç æ˜¯ä¸ºäº†äº†è§£å†…æ ¸çš„ç»†èŠ‚ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599976866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1235551,"avatar":"https://static001.geekbang.org/account/avatar/00/12/da/5f/3c68103d.jpg","nickname":"éƒ­æ¢“è‰¯","note":"","ucode":"50E57E6A723E14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358228,"discussion_content":"éœ€è¦æŒ‚è½½debugfsï¼Œæ‰ä¼šæœ‰è¿™ä¸ªç›®å½•ã€‚mount - debugfs debugfs /sys/kernel/debug","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1615949632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1797551,"avatar":"","nickname":"ä»è¿œæ–¹è¿‡æ¥","note":"","ucode":"4791DBC7E05B1D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305519,"discussion_content":"æ²¡æœ‰è¿™ä¸ªç›®å½•ğŸ˜°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599981416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1717529,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/35/19/769a9a88.jpg","nickname":"Haonan","note":"","ucode":"E6C31AC6190C69","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305111,"discussion_content":"åœ¨Documentation/traceæ–‡ä»¶å¤¹é‡Œä¼šæœ‰è¯¦ç»†è®²è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599787452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":349816,"user_name":"é£æ¸…æ‰¬","can_delete":false,"product_type":"c1","uid":1047043,"ip_address":"","ucode":"651F1390B64953","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fa/03/619e3e48.jpg","comment_is_top":false,"comment_ctime":1656345642,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1656345642","product_id":100058001,"comment_content":"æœ‰æ²¡æœ‰æœ‹å‹é‡åˆ°makeæŠ¥é”™çš„æƒ…å†µï¼Œè¿™ç§å¦‚ä½•è§£å†³å‘€ï¼Ÿ<br>make -C &#47;lib&#47;modules&#47;`uname -r`&#47;build M=`pwd`<br>make[1]: Entering directory &#39;&#47;usr&#47;src&#47;linux-headers-5.15.0-39-generic&#39;<br>make[2]: *** No rule to make target &#39;&#47;root&#47;workspace&#47;cpp&#47;kmalloc&#47;kmem_test.o&#39;, needed by &#39;&#47;root&#47;workspace&#47;cpp&#47;kmalloc&#47;kmem_test.mod&#39;.  Stop.<br>make[1]: *** [Makefile:1875: &#47;root&#47;workspace&#47;cpp&#47;kmalloc] Error 2<br>make[1]: Leaving directory &#39;&#47;usr&#47;src&#47;linux-headers-5.15.0-39-generic&#39;<br>make: *** [Makefile:4: all] Error 2<br>root@52coder:~&#47;workspace&#47;cpp&#47;kmalloc#","like_count":0},{"had_liked":false,"id":346135,"user_name":"lJ","can_delete":false,"product_type":"c1","uid":2562558,"ip_address":"","ucode":"CC29D06A16FF93","user_header":"https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg","comment_is_top":false,"comment_ctime":1652852914,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652852914","product_id":100058001,"comment_content":"è€å¸ˆï¼Œæ ¹æ®ä»£ç åœ¨è‡ªå·±è™šæ‹Ÿæœºå®éªŒäº†ä¸€ä¸‹ï¼Œkmem_testå®‰è£…å‰åï¼ŒVmallocUsedå§‹ç»ˆéƒ½æ˜¯0ï¼Œåªæœ‰MemFreeã€MemAvailableå‘ç”Ÿäº†1Gå·¦å³çš„å˜åŒ–ï¼Œå…¶å®ƒæŒ‡æ ‡æ— æ˜æ˜¾å˜åŒ–ã€‚â€˜â€™<br><br>[root@rune32bit module]# uname -r<br>4.18.9-1.el7.elrepo.x86_64","like_count":0},{"had_liked":false,"id":334336,"user_name":"MiraClei","can_delete":false,"product_type":"c1","uid":1969284,"ip_address":"","ucode":"EA28F32A8A3B5D","user_header":"https://static001.geekbang.org/account/avatar/00/1e/0c/84/8542f966.jpg","comment_is_top":false,"comment_ctime":1644892560,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644892560","product_id":100058001,"comment_content":"docker å†…éƒ¨çš„ slabæ— æ³•å›æ”¶é—®é¢˜ï¼Œæ˜¯åœ¨å†…æ ¸ä»€ä¹ˆç‰ˆæœ¬ä¿®å¤çš„ã€‚æˆ‘ä»¬ä½¿ç”¨çš„CentOS7.6 å†…æ ¸ç‰ˆæœ¬:3.10.0-957.21.3.el7.x86_64ï¼Œå­˜åœ¨ç±»ä¼¼é—®é¢˜ï¼Œfreeçœ‹åˆ°çš„cacheæŒç»­å¢é«˜è¶…è¿‡ç³»ç»Ÿ50%ï¼Œdockerå¯åŠ¨çš„å®¹å™¨é¢‘ç¹çš„è¢«ç³»ç»Ÿkillåé‡å¯ï¼Œæ­¤cacheæ‰‹åŠ¨æ— æ³•é‡Šæ”¾æ‰ï¼Œå¿…é¡»é‡å¯æœåŠ¡å™¨æ‰èƒ½é‡Šæ”¾æ‰æ­¤éƒ¨åˆ†å†…å­˜","like_count":0},{"had_liked":false,"id":334335,"user_name":"MiraClei","can_delete":false,"product_type":"c1","uid":1969284,"ip_address":"","ucode":"EA28F32A8A3B5D","user_header":"https://static001.geekbang.org/account/avatar/00/1e/0c/84/8542f966.jpg","comment_is_top":false,"comment_ctime":1644892381,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644892381","product_id":100058001,"comment_content":"è¯·é—®ä¸‹docker å†…éƒ¨çš„ slabæ— æ³•å›æ”¶çš„é—®é¢˜ï¼Œæ˜¯åœ¨å†…æ ¸ä»€ä¹ˆç‰ˆæœ¬ä¸Šä¿®å¤çš„","like_count":0},{"had_liked":false,"id":311629,"user_name":"Aå…å¸…å«å“¥","can_delete":false,"product_type":"c1","uid":2058258,"ip_address":"","ucode":"76D2522E602AEF","user_header":"https://static001.geekbang.org/account/avatar/00/1f/68/12/031a05c3.jpg","comment_is_top":false,"comment_ctime":1631352803,"is_pvip":false,"replies":[{"id":"112937","content":"å¤šè°¢æŒ‡å‡ºæ¥","user_name":"ä½œè€…å›å¤","user_name_real":"é‚µäºšæ–¹","uid":"1981399","ctime":1631437365,"ip_address":"","comment_id":311629,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631352803","product_id":100058001,"comment_content":"å†…æ ¸ä»£ç å°‘äº† #include &lt;linux&#47;module.h&gt;","like_count":0,"discussions":[{"author":{"id":1981399,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/3b/d7/9d942870.jpg","nickname":"é‚µäºšæ–¹","note":"","ucode":"CDFABCB81B9782","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526685,"discussion_content":"å¤šè°¢æŒ‡å‡ºæ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631437365,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287410,"user_name":"Ilovek8s","can_delete":false,"product_type":"c1","uid":1542450,"ip_address":"","ucode":"64DF0F7D0CF0B0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/a8PMLmCTCBa40j7JIy3d8LsdbW5hne7lkk9KOGQuiaeVk4cn06KWwlP3ic69BsQLpNFtRTjRdUM2ySDBAv1MOFfA/132","comment_is_top":false,"comment_ctime":1617935101,"is_pvip":false,"replies":[{"id":"104504","content":"å¯èƒ½æ˜¯ç³»ç»Ÿå†…å­˜ä¸å¤Ÿç”¨äº†ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"é‚µäºšæ–¹","uid":"1981399","ctime":1618146687,"ip_address":"","comment_id":287410,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1617935101","product_id":100058001,"comment_content":"ç¼–è¯‘å®Œä¹‹åï¼ŒåŠ è½½åˆ°å†…æ ¸æ¨¡å—ï¼Œæç¤ºkmallocå¤±è´¥ï¼Œéº»çƒ¦è€å¸ˆæŒ‡ç‚¹ä¸€ä¸‹","like_count":0,"discussions":[{"author":{"id":1981399,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/3b/d7/9d942870.jpg","nickname":"é‚µäºšæ–¹","note":"","ucode":"CDFABCB81B9782","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518299,"discussion_content":"å¯èƒ½æ˜¯ç³»ç»Ÿå†…å­˜ä¸å¤Ÿç”¨äº†ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618146687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246902,"user_name":"å†¬é£å‘å·¦å¹","can_delete":false,"product_type":"c1","uid":1066928,"ip_address":"","ucode":"376C45C5134F93","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/b0/a9b77a1e.jpg","comment_is_top":false,"comment_ctime":1599527904,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1599527904","product_id":100058001,"comment_content":"æ¶¨è§è¯†äº†","like_count":0,"discussions":[{"author":{"id":1309948,"avatar":"https://static001.geekbang.org/account/avatar/00/13/fc/fc/1e235814.jpg","nickname":"è€¿é•¿å­¦","note":"","ucode":"C7A262812854D4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347873,"discussion_content":"è€å¸ˆï¼Œæ€ä¹ˆæ¿€æ´»kmemleakè¿™ä¸ªæ¨¡å—ï¼ŒCentOS7.2ä¸Šè¿‡æ¥config-3.10.0-327-e17.x86_64ç»“æœæ˜¯#CONFIG_DEBUG_KMEMLEAK is not set","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612347943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}