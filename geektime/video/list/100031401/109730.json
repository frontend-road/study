{"id":109730,"title":"30 | Faraday网关代码解析（下）","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":117364,"user_name":"pedro","can_delete":false,"product_type":"c3","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1564032933,"is_pvip":false,"replies":[{"id":43003,"content":"k8s支持类似网关的功能，叫ingress。我在Staffjoy中引入了一个轻量级的自研的网关，主要有两个目的：1)教学目的，让大家理解网关是怎么工作的，同时在k8s中，让大家理解ingress原理(Faraday类似一个自研的Ingress）；2)Faraday是一个SpringBoot应用，可编程的比较灵活，要开发一些网关逻辑(比如路由，安全)比较灵活方便，另外Faraday的代码和其它微服务代码是一套统一管理的，如果引入一个其它网关，还要单独配置、管理和部署，反而麻烦。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564059831,"ip_address":"","comment_id":117364,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师请教一下，既然k8s自带了云原生级别的网关，staffjoy又为什么需要项目级别的Faraday网关呢","like_count":6,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459930,"discussion_content":"k8s支持类似网关的功能，叫ingress。我在Staffjoy中引入了一个轻量级的自研的网关，主要有两个目的：1)教学目的，让大家理解网关是怎么工作的，同时在k8s中，让大家理解ingress原理(Faraday类似一个自研的Ingress）；2)Faraday是一个SpringBoot应用，可编程的比较灵活，要开发一些网关逻辑(比如路由，安全)比较灵活方便，另外Faraday的代码和其它微服务代码是一套统一管理的，如果引入一个其它网关，还要单独配置、管理和部署，反而麻烦。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564059831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200704,"avatar":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","nickname":"pedro","note":"","ucode":"F40C839DDFD599","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3004,"discussion_content":"多谢了，明白了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1564107193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1502048,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er4qHCR12J6r5iaH5NUlXKib2PQMyDuUpxma47TaGFAY82FqFFu6YictRvK8bBMkEicgMWpTRF6PuLjZw/132","nickname":"JRT324","note":"","ucode":"85E94F34813E2E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351558,"discussion_content":"波波老师，为什么不用 spring cloud gateway?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614324495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129220,"user_name":"大维","can_delete":false,"product_type":"c3","uid":1129620,"ip_address":"","ucode":"5FEAF1F0B48876","user_header":"https://static001.geekbang.org/account/avatar/00/11/3c/94/932231c2.jpg","comment_is_top":false,"comment_ctime":1567064592,"is_pvip":false,"replies":[{"id":48105,"content":"用spring cloud gateway实现faraday的功能，完全可以做到，而且可能比faraday还要简单，建议学员自己动手实现，作为对课程学习成果的一个检验。如果学员理解了网关的原理和faraday的源码实现，完全可以用spring cloud gateway或者zuul替换faraday，如果能做到，这门课程可以打80分以上了。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1567083063,"ip_address":"","comment_id":129220,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师，能再给出一个采用springcloud gateway的配置来完全实现 法拉第 网关的功能的 源码 及 所有配置文件（application.yml k8s config）不？就当是另外一个网关的实现？","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465340,"discussion_content":"用spring cloud gateway实现faraday的功能，完全可以做到，而且可能比faraday还要简单，建议学员自己动手实现，作为对课程学习成果的一个检验。如果学员理解了网关的原理和faraday的源码实现，完全可以用spring cloud gateway或者zuul替换faraday，如果能做到，这门课程可以打80分以上了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567083063,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120096,"user_name":"John","can_delete":false,"product_type":"c3","uid":1020861,"ip_address":"","ucode":"E4ADF8488953FB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/93/bd/f3977ebb.jpg","comment_is_top":false,"comment_ctime":1564790552,"is_pvip":false,"replies":[{"id":44140,"content":"Faraday网关使用简单的同步处理方式，如果要实现reactive stream的方式，建议参考spring cloud gateway的做法，它是基于Spring WebFlux实现的异步模式。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564841169,"ip_address":"","comment_id":120096,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"如果respond和request的body是reactive的stream","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461199,"discussion_content":"Faraday网关使用简单的同步处理方式，如果要实现reactive stream的方式，建议参考spring cloud gateway的做法，它是基于Spring WebFlux实现的异步模式。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564841169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119107,"user_name":"王皓月","can_delete":false,"product_type":"c3","uid":1154968,"ip_address":"","ucode":"02F05C485968DB","user_header":"https://static001.geekbang.org/account/avatar/00/11/9f/98/b6f20c10.jpg","comment_is_top":false,"comment_ctime":1564505176,"is_pvip":false,"replies":[{"id":43786,"content":"拆分成微服务方式可以考虑，具体看你的业务复杂性和团队规模。关于微服务+网关安全认证架构，可以继续看课程第5章内容，里头有详细的架构分析，看看对你是否有启发，如果还有问题，也可以加我微信进一步交流(bulldog2015），说明来自极客时间。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564579410,"ip_address":"","comment_id":119107,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师您好，我在工作中会涉及到通过Socket接收IoT设备数据、通过调用第三方服务器接口获取IoT设备数据等等类似操作，开发的多个web应用中经常会重复调用这些数据，现在的做法是将这些操作IoT设备及数据库的代码在多个web应用中重用，但这样操作（多个Web应用中重复出现相关代码）部署在同一台服务器上会对服务器的性能产生影响，并且开发也不是很便利，现在的想法是将这些代码拆分为微服务，web应用或SPA&#47;无线原生应用通过统一网关访问这些服务，进而开发一个位于网关中或位于网关后的鉴权认证服务提供登陆和鉴权访问功能。请问这种想法是否可行，波波老师可否传授一个比较好的架构设计使以后的开发更方便快捷，同时提供可扩展性和可配置性。谢谢老师～","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460747,"discussion_content":"拆分成微服务方式可以考虑，具体看你的业务复杂性和团队规模。关于微服务+网关安全认证架构，可以继续看课程第5章内容，里头有详细的架构分析，看看对你是否有启发，如果还有问题，也可以加我微信进一步交流(bulldog2015），说明来自极客时间。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564579410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192385,"user_name":"arch","can_delete":false,"product_type":"c3","uid":1078931,"ip_address":"","ucode":"A69EBFE0520B85","user_header":"https://static001.geekbang.org/account/avatar/00/10/76/93/2e9bf8ab.jpg","comment_is_top":false,"comment_ctime":1584848367,"is_pvip":true,"replies":[{"id":74021,"content":"网关一般是工作在7层的，例如网关路由需要识别http header或者path信息。\n\n7层网关有一点性能开销，但是网关无状态可以水平扩，之前携程经验，每日百亿请求通过网关，平均增加延迟约20ms左右。\n\n也有用TCP做网关的，之前携程的无线网关就是基于TCP，但是反而把事情搞复杂，还要定制通讯协议，开发调试都不方便，后来我们迁移到HTTP了。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585055744,"ip_address":"","comment_id":192385,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"服务添加网关多了层跳转，基于HTTP是否性能会受影响，是否可以考虑基于TCP去实现提升网关性能","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488386,"discussion_content":"网关一般是工作在7层的，例如网关路由需要识别http header或者path信息。\n\n7层网关有一点性能开销，但是网关无状态可以水平扩，之前携程经验，每日百亿请求通过网关，平均增加延迟约20ms左右。\n\n也有用TCP做网关的，之前携程的无线网关就是基于TCP，但是反而把事情搞复杂，还要定制通讯协议，开发调试都不方便，后来我们迁移到HTTP了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585055744,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117942,"user_name":"许凯","can_delete":false,"product_type":"c3","uid":1604645,"ip_address":"","ucode":"4F11AD41CB0244","user_header":"https://static001.geekbang.org/account/avatar/00/18/7c/25/70134099.jpg","comment_is_top":false,"comment_ctime":1564196384,"is_pvip":false,"replies":[{"id":43224,"content":"你好，如果采用jwt令牌，里头可以包含用户角色&#47;组等信息，在网关层可以做初步的权限控制，然后网关将用户角色&#47;组信息向后传递，这样后台服务接口层可以进一步做细粒度权限控制，一般做法是在控制器上添加权限控制标注Annotation，Spring可以通过定制截获器标注实现。本课程第5章会进一步讲解Staffjoy项目的安全认证方案，有比较简单的权限控制实现，请继续关注课程。后面我还会在开发一个微服务电商案例，会展示比较复杂的微服务权限控制方案，可以关注我的github.com&#47;spring2go。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564224584,"ip_address":"","comment_id":117942,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"还有想请问下老师，对于有自定义各种角色，用户组的情况，进行细粒度的权限控制是不是只能在每个接口的地方分别写业务逻辑代码进行处理","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460192,"discussion_content":"你好，如果采用jwt令牌，里头可以包含用户角色/组等信息，在网关层可以做初步的权限控制，然后网关将用户角色/组信息向后传递，这样后台服务接口层可以进一步做细粒度权限控制，一般做法是在控制器上添加权限控制标注Annotation，Spring可以通过定制截获器标注实现。本课程第5章会进一步讲解Staffjoy项目的安全认证方案，有比较简单的权限控制实现，请继续关注课程。后面我还会在开发一个微服务电商案例，会展示比较复杂的微服务权限控制方案，可以关注我的github.com/spring2go。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564224584,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1604645,"avatar":"https://static001.geekbang.org/account/avatar/00/18/7c/25/70134099.jpg","nickname":"许凯","note":"","ucode":"4F11AD41CB0244","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3161,"discussion_content":"嗯，感谢老师，对于中小系统，如果直接用token+redis的方案，在成功登陆时把所有权限信息存到redis，在网关处进行身份认证，在微服务的接口处取出权限信息进行权限控制，不知道这样有没有问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564234908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118201,"user_name":"许凯","can_delete":false,"product_type":"c3","uid":1604645,"ip_address":"","ucode":"4F11AD41CB0244","user_header":"https://static001.geekbang.org/account/avatar/00/18/7c/25/70134099.jpg","comment_is_top":false,"comment_ctime":1564289445,"is_pvip":false,"replies":[{"id":43319,"content":"这个是一种采用集中状态(redis)校验做法，原则上没有问题，需要监控流量做好扩容。关于微服务安全认证的原理和做法，请关注课程第5章，有详细剖析。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564320555,"ip_address":"","comment_id":118201,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"嗯，感谢老师，对于中小系统，如果直接用token+redis的方案，在成功登陆时把所有权限信息存到redis，在网关处进行身份认证，在微服务的接口处取出权限信息进行权限控制，不知道这样有没有问题","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460298,"discussion_content":"这个是一种采用集中状态(redis)校验做法，原则上没有问题，需要监控流量做好扩容。关于微服务安全认证的原理和做法，请关注课程第5章，有详细剖析。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564320555,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117830,"user_name":"许凯","can_delete":false,"product_type":"c3","uid":1604645,"ip_address":"","ucode":"4F11AD41CB0244","user_header":"https://static001.geekbang.org/account/avatar/00/18/7c/25/70134099.jpg","comment_is_top":false,"comment_ctime":1564141590,"is_pvip":false,"replies":[{"id":43220,"content":"你好，课程更新由极客时间统一安排，目前节奏是每周更新10小节课，预计8月底前会全部更新完，请耐心等待，也可以等全部更新完后再统一学习，谢谢支持！","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564223700,"ip_address":"","comment_id":117830,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"盼着赶紧更新","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460134,"discussion_content":"你好，课程更新由极客时间统一安排，目前节奏是每周更新10小节课，预计8月底前会全部更新完，请耐心等待，也可以等全部更新完后再统一学习，谢谢支持！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564223700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117069,"user_name":"杨智晓 ✟","can_delete":false,"product_type":"c3","uid":1024263,"ip_address":"","ucode":"E3B56F4A38F63D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a1/07/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1563961837,"is_pvip":false,"replies":[{"id":42840,"content":"这个不好说，脱离测试和实际生产情况，单纯谈论性能意义不大。要实际做性能测试得出数据才知道。在生产的话，还要看实际用户流量模式和后台服务性能情况，一般需要监控数据才清楚。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1563973963,"ip_address":"","comment_id":117069,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师，请教一个问题，这个Faraday是SpringBoot自带的嵌入Tomcat，也就是BIO的，如果换成Jetty，会不会更好一点？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459803,"discussion_content":"这个不好说，脱离测试和实际生产情况，单纯谈论性能意义不大。要实际做性能测试得出数据才知道。在生产的话，还要看实际用户流量模式和后台服务性能情况，一般需要监控数据才清楚。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563973963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367570,"user_name":"Geek_c559a0","can_delete":false,"product_type":"c3","uid":3294380,"ip_address":"浙江","ucode":"DB6339D92A4A1F","user_header":"","comment_is_top":false,"comment_ctime":1675325933,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"麻烦问一下 为什么我在exchange时候一直有io报错  提示broken pipe","like_count":0}]}