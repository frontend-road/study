{"id":813345,"title":"21ï½œè¡¨è¿æ¥å¦‚ä½•æ‰§è¡Œï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬æ¥èŠä¸€èŠMySQLä¸­çš„è¡¨è¿æ¥æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚</p><p>ä»åŠŸèƒ½æˆ–è¯­æ³•ä¸Šæ¥çœ‹ï¼Œè¡¨è¿æ¥æœ‰å†…è¿æ¥ï¼ˆInner Joinï¼‰å’Œå¤–è¿æ¥ï¼ˆOuter Joinï¼‰ã€‚å¤–è¿æ¥åˆåŒ…æ‹¬å·¦è¿æ¥ï¼ˆLeft Outer Joinï¼‰ã€å³è¿æ¥ï¼ˆRight Outer Joinï¼‰ã€å…¨å¤–è¿æ¥ï¼ˆFull Outer Joinï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰åŠè¿æ¥ï¼ˆSemi Joinï¼‰ã€åè¿æ¥ï¼ˆAnti Joinï¼‰ï¼Œè¿™äº›è¿æ¥æ–¹å¼ä¼šåœ¨inã€not inã€existsã€not existsç­‰æŸ¥è¯¢ä¸­ä½¿ç”¨ã€‚</p><p>ä¸ç®¡æ˜¯å“ªç§è¿æ¥ï¼Œåœ¨å®ç°å±‚é¢ä¸Šï¼ŒMySQLä¼šä½¿ç”¨åµŒå¥—å¾ªç¯è¿æ¥æˆ–å“ˆå¸Œè¿æ¥è¿™ä¸¤å¤§ç±»ç®—æ³•ï¼Œå®ƒä»¬æœ‰ç€ä¸åŒçš„æ‰§è¡Œæ–¹å¼ï¼Œä»¥åŠä¸åŒçš„æˆæœ¬è®¡ç®—æ–¹æ³•ã€‚æ‰§è¡Œå¤šè¡¨è¿æ¥æ—¶ï¼Œä¼˜åŒ–å™¨è¿˜éœ€è¦é€‰æ‹©æœ€ä½³çš„è¿æ¥é¡ºåºã€‚å¯¹äºå†…è¿æ¥ï¼Œä¼˜åŒ–å™¨å¯ä»¥è‡ªåŠ¨é€‰æ‹©è¡¨çš„è¿æ¥é¡ºåºï¼Œä»¥æœ€ä½çš„æˆæœ¬æ¥æ‰§è¡ŒSQLã€‚å¯¹äºå¤–è¿æ¥ï¼Œä¿®æ”¹è¡¨çš„è¿æ¥é¡ºåºä¼šå½±å“æŸ¥è¯¢çš„ç»“æœï¼Œå› æ­¤ä¼˜åŒ–å™¨ä¸èƒ½éšæ„è°ƒæ•´è¡¨çš„é¡ºåºã€‚MySQLä¸­è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„è¿æ¥æ–¹å¼â€”â€”<strong>STRAIGHT_JOIN</strong>ï¼Œä½¿ç”¨STRAIGHT_JOINæ—¶ï¼Œè¿æ¥é¡ºåºæ˜¯å›ºå®šçš„ã€‚</p><p>å¯¹äºå·²ç»ç¡®å®šè¿æ¥é¡ºåºçš„ä¸¤ä¸ªè¡¨ï¼ŒMySQLæœ‰å‡ ç§ç®—æ³•æ¥å®ç°è¡¨è¿æ¥ã€‚</p><ul>\n<li>åµŒå¥—å¾ªç¯ï¼ˆNested-Loopï¼‰</li>\n</ul><p>åµŒå¥—å¾ªç¯æ˜¯MySQLä¸­æœ€æ—©æ”¯æŒçš„è¿æ¥ç®—æ³•ã€‚å½“é©±åŠ¨è¡¨ä¸­éœ€è¦å‚ä¸å…³è”çš„è®°å½•è¾ƒå°‘ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨é€‰æ‹©æ€§è¾ƒé«˜çš„ç´¢å¼•æŸ¥æ‰¾åˆ°è¢«é©±åŠ¨è¡¨çš„å…³è”è®°å½•æ—¶ï¼Œä½¿ç”¨åµŒå¥—å¾ªç¯æ•ˆç‡å¾ˆé«˜ã€‚</p><!-- [[[read_end]]] --><ul>\n<li>å—åµŒå¥—å¾ªç¯ï¼ˆBlock Nested-Loopï¼‰</li>\n</ul><p>å¦‚æœè¢«é©±åŠ¨è¡¨ç¼ºå°‘ç›¸å…³çš„ç´¢å¼•ï¼Œä½¿ç”¨æ™®é€šçš„åµŒå¥—å¾ªç¯ç®—æ³•æ—¶ï¼Œå¯¹äºé©±åŠ¨è¡¨ä¸­çš„æ¯ä¸€è¡Œè®°å½•ï¼Œéƒ½éœ€è¦å…¨è¡¨æ‰«æä¸€æ¬¡è¢«é©±åŠ¨è¡¨ï¼Œå› æ­¤æ€§èƒ½ä¼šå¾ˆå·®ã€‚å—åµŒå¥—å¾ªç¯ç®—æ³•å¼•å…¥äº†Join Bufferï¼Œæ‰§è¡Œè¡¨è¿æ¥æ—¶ï¼Œå…ˆå°†é©±åŠ¨è¡¨ä¸­çš„ä¸€æ‰¹æ•°æ®ç¼“å­˜åˆ°Join Bufferä¸­ã€‚å…¨è¡¨æ‰«æä¸€æ¬¡è¢«é©±åŠ¨è¡¨æ—¶ï¼Œå¯ä»¥è·ŸJoin Bufferä¸­çš„æ‰€æœ‰è®°å½•è¿›è¡Œå…³è”ï¼Œä»¥æ­¤æ¥å‡å°‘è¢«é©±åŠ¨è¡¨çš„å…¨è¡¨æ‰«ææ¬¡æ•°ã€‚MySQLä»8.0.20ç‰ˆæœ¬å¼€å§‹å·²ç»åºŸé™¤äº†å—åµŒå¥—å¾ªç¯ç®—æ³•ï¼Œè½¬è€Œä½¿ç”¨å“ˆå¸Œè¿æ¥ç®—æ³•ã€‚</p><ul>\n<li>å“ˆå¸Œè¿æ¥ï¼ˆHash Joinï¼‰</li>\n</ul><p>å“ˆå¸Œè¿æ¥ä»å—åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•ä¸­è¿›åŒ–è€Œæ¥ã€‚ä½¿ç”¨å“ˆå¸Œè¿æ¥ç®—æ³•æ—¶ï¼Œå…ˆå°†é©±åŠ¨è¡¨çš„æ•°æ®ä»¥å“ˆå¸Œè¡¨çš„å½¢å¼ç¼“å­˜åˆ°Join Bufferä¸­ã€‚å¯¹äºè¢«é©±åŠ¨è¡¨ä¸­çš„æ¯ä¸€è¡Œè®°å½•ï¼Œä½¿ç”¨å“ˆå¸ŒæŸ¥æ‰¾ç®—æ³•åˆ°Join BufferæŸ¥æ‰¾å…³è”è®°å½•ã€‚åœ¨è¢«é©±åŠ¨è¡¨ç¼ºå°‘åˆé€‚çš„ç´¢å¼•æ—¶ï¼Œä½¿ç”¨å“ˆå¸Œè¿æ¥ç®—æ³•èƒ½æå¤§æé«˜æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p><ul>\n<li>Batched Key Access</li>\n</ul><p>æ™®é€šåµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•ä¸­ï¼Œé€šå¸¸ä¸æ˜¯æŒ‰ROWIDçš„é¡ºåºå›è¡¨æŸ¥æ‰¾æ•°æ®ï¼Œè¿™æ ·å¯èƒ½ä¼šå¸¦æ¥å¤§é‡çš„éšæœºIOï¼Œè€Œåœ¨æ•°æ®åº“ä¸­ï¼Œå¤§é‡çš„éšæœºIOä¼šå½±å“æŸ¥è¯¢çš„æ€§èƒ½ã€‚å’Œå•è¡¨MRRè®¿é—®è·¯å¾„ç±»ä¼¼ï¼Œä½¿ç”¨Batched Key Accessè¿æ¥ç®—æ³•æ—¶ï¼Œä¼šå…ˆå°†éœ€è¦å›è¡¨æŸ¥è¯¢çš„è®°å½•çš„ROWIDç¼“å­˜åˆ°Join Bufferä¸­å¹¶è¿›è¡Œæ’åºï¼Œæ’åºä¹‹åæŒ‰ROWIDçš„é¡ºåºå›è¡¨æŸ¥æ‰¾æ•°æ®ï¼Œåœ¨ä¸€äº›ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼ŒæŒ‰ROWIDé¡ºåºå›è¡¨è®¿é—®æ•°æ®å¯èƒ½ä¼šæé«˜ä¸€äº›æ€§èƒ½ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»è¿™å‡ ç§è¿æ¥ç®—æ³•çš„å®ç°æ–¹å¼ã€‚</p><h2>è¡¨è¿æ¥ç®—æ³•è¯¦è§£</h2><h3>åµŒå¥—å¾ªç¯è¿æ¥ï¼ˆNested-Loopï¼‰</h3><p>å¯¹äºç±»ä¼¼ä¸‹é¢çš„SQLï¼š</p><pre><code class=\"language-plain\">select *\nfrom t1, t2\nwhere t1.c1 = 'xx'\nand t1.c2 = t2.c2\nand ...\n</code></pre><p>å¦‚æœæ»¡è¶³ä¸‹é¢2ä¸ªæ¡ä»¶ï¼Œå°±æœ‰å¯èƒ½ä½¿ç”¨ä»¥t1è¡¨ä¸ºé©±åŠ¨è¡¨çš„åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³•ã€‚</p><ol>\n<li>\n<p>T2è¡¨çš„å…³è”å­—æ®µC2ä¸Šå»ºæœ‰ç´¢å¼•ï¼Œç´¢å¼•è¿‡æ»¤æ€§æ¯”è¾ƒé«˜ã€‚</p>\n</li>\n<li>\n<p>T1è¡¨æ»¡è¶³å…¶ä»–è¿‡æ»¤æ¡ä»¶çš„è®°å½•æ•°ä¸å¤šã€‚å¦‚æœT1è¡¨çš„å…¶ä»–è¿‡æ»¤å­—æ®µå¦‚C1ä¸Šæœ‰ç´¢å¼•å¹¶ä¸”è¿‡æ»¤æ€§è¾ƒé«˜ï¼Œåˆ™æŸ¥è¯¢çš„æ€§èƒ½æ›´é«˜ã€‚</p>\n</li>\n</ol><p>åµŒå¥—å¾ªç¯è¿æ¥å¤§è‡´åˆ†ä¸ºä¸‹é¢è¿™å‡ ä¸ªæ‰§è¡Œæ­¥éª¤ï¼š</p><ol>\n<li>\n<p>ä½¿ç”¨é©±åŠ¨è¡¨T1ä¸Šçš„è¿‡æ»¤æ¡ä»¶å®šä½åˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€‚</p>\n</li>\n<li>\n<p>å¯¹äºæ­¥éª¤1ç­›é€‰å‡ºæ¥çš„æ¯ä¸€è¡Œè®°å½•ï¼ŒæŸ¥æ‰¾T2è¡¨ã€‚</p>\n</li>\n<li>\n<p>ä½¿ç”¨T2è¡¨å…¶å®ƒè¿‡æ»¤æ¡ä»¶ä»¥åŠT1è¡¨çš„å…³è”æ¡ä»¶ï¼Œä»T2è¡¨è·å–æ•°æ®ã€‚</p>\n</li>\n<li>\n<p>å°†è¡¨è¿æ¥çš„ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚è¿™é‡Œï¼ŒMySQLé»˜è®¤ä¸éœ€è¦å°†è¡¨è¿æ¥çš„ç»“æœè®°å½•åˆ°ä¸´æ—¶è¡¨ã€‚è€Œæ˜¯æ¯å…³è”å®Œæˆä¸€è¡Œè®°å½•ï¼Œå°±å°†è®°å½•å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>\n</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/d1/43/d18640f9cc792ae24626b8bc9ba08443.jpg?wh=1488x904\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè¿™é‡Œä»ç„¶ç”¨äº†18è®²ä¸­åˆ›å»ºçš„tabè¡¨ï¼Œä½†æ˜¯analyze tableåï¼Œç»Ÿè®¡ä¿¡æ¯æœ‰ä¸€ç‚¹åŒºåˆ«ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select * from mysql.innodb_table_stats where table_name = 'tab'\\G\n*************************** 1. row ***************************\n           database_name: rep\n              table_name: tab\n             last_update: 2024-08-29 14:33:43\n                  n_rows: 9900\n    clustered_index_size: 161\nsum_of_other_index_sizes: 15\n\nmysql&gt; show indexes from tab;\n+------------+----------+--------------+-------------+-------------+\n| Non_unique | Key_name | Seq_in_index | Column_name | Cardinality |\n+------------+----------+--------------+-------------+-------------+\n|          0 | PRIMARY  |            1 | id          |        9900 |\n|          1 | idx_abc  |            1 | a           |           3 |\n|          1 | idx_abc  |            2 | b           |        9900 |\n|          1 | idx_abc  |            3 | c           |        9900 |\n+------------+----------+--------------+-------------+-------------+\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼ŒexplainåŠ ä¸Šäº†format=treeï¼Œè¿™æ ·æ›´ç›´è§‚ä¸€ç‚¹ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain format=tree select * \n    from tab t1, tab t2\n    where t1.b between 1 and 100 \n    and t1.a = t2.a\\G\n*************************** 1. row ***************************\nEXPLAIN: \n-&gt; Nested loop inner join  (cost=496805.68 rows=3629637)\n    -&gt; Filter: (t1.b between 1 and 100)  (cost=1030.25 rows=1100)\n        -&gt; Table scan on t1  (cost=1030.25 rows=9900)\n    -&gt; Index lookup on t2 using idx_abc (a=t1.a)  (cost=121.05 rows=3300)\n</code></pre><p>ä»ä¼˜åŒ–å™¨è·Ÿè¸ªé‡Œå¯ä»¥çœ‹åˆ°ï¼Œé©±åŠ¨è¡¨è®¿é—®æˆæœ¬ä¸º1030.25ï¼Œè¢«é©±åŠ¨è¡¨T2çš„è®¿é—®æˆæœ¬ä¸º495775ï¼Œæ€»æˆæœ¬ä¸º496806ã€‚</p><pre><code class=\"language-plain\">\"best_access_path\": {\n    \"considered_access_paths\": [\n      {\n        \"rows_to_scan\": 9900,\n        \"filtering_effect\": [\n        ],\n        \"final_filtering_effect\": 0.1111,\n        \"access_type\": \"scan\",\n        \"resulting_rows\": 1099.89,\n        \"cost\": 1030.25,\n        \"chosen\": true\n      }\n    ]\n  },\n  \"condition_filtering_pct\": 100,\n  \"rows_for_plan\": 1099.89,\n  \"cost_for_plan\": 1030.25,\n  \n  \"rest_of_plan\": [\n    {\n      \"plan_prefix\": [\n        \"`tab` `t1`\"\n      ],\n      \"table\": \"`tab` `t2`\",\n      \"best_access_path\": {\n        \"considered_access_paths\": [\n          {\n            \"access_type\": \"ref\",\n            \"index\": \"idx_abc\",\n            \"rows\": 3300,\n            \"cost\": 495775,\n            \"chosen\": true\n          }\n        ]\n      },\n      \"condition_filtering_pct\": 100,\n      \"rows_for_plan\": 3.62964e+06,\n      \"cost_for_plan\": 496806,\n      \"chosen\": true\n    }\n  ]\n},\n</code></pre><p>åµŒå¥—å¾ªç¯è¿æ¥æˆæœ¬å¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªå…¬å¼è¡¨ç¤ºï¼š</p><p>æ€»æˆæœ¬ = é©±åŠ¨è¡¨è®¿é—®æˆæœ¬ + é©±åŠ¨è¡¨è¿‡æ»¤åè®°å½•æ•° * è¢«é©±åŠ¨è¡¨è®¿é—®æˆæœ¬</p><p>åœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¾‹å­ä¸­ï¼Œé©±åŠ¨è¡¨è®¿é—®æˆæœ¬ä¸ºå…¨è¡¨æ‰«æçš„æˆæœ¬ï¼Œä½¿ç”¨19è®²ä¸­çš„è®¡ç®—å…¬å¼è®¡ç®—ã€‚</p><pre><code class=\"language-plain\">&gt;&gt;&gt; scan_cost(pages=161, rows=9900, in_mem_pct=1)\n1030.25\n</code></pre><p>åµŒå¥—å¾ªç¯éœ€è¦æ‰§è¡Œå¤šå°‘æ¬¡å‘¢ï¼Ÿæ ¹æ®é©±åŠ¨çš„è¿‡æ»¤æ¡ä»¶æ¥ä¼°ç®—ï¼Œæ¡ä»¶b between 1 and 100ä¸­ï¼Œå­—æ®µbç¼ºå°‘ç›¸å…³ç´¢å¼•ï¼ŒMySQLè®¤ä¸ºè¿™ä¸ªæ¡ä»¶çš„è¿‡æ»¤æ€§ä¸º0.1111ï¼Œå› æ­¤æ»¡è¶³æ¡ä»¶çš„è®°å½•æ•°ä¸º9900 * 0.1111 = 1099.89ã€‚å…³äºä¸åŒæ¡ä»¶çš„è¿‡æ»¤æ€§ï¼Œåç»­ä¼šåšä¸€äº›ä»‹ç»ã€‚</p><p>è¢«é©±åŠ¨è¡¨ä½¿ç”¨ç´¢å¼•idx_abcåšrefè®¿é—®ï¼Œç”±äºä½¿ç”¨äº†è¡¨è¿æ¥ï¼Œè®¿é—®è¡Œæ•°é€šè¿‡ç»Ÿè®¡ä¿¡æ¯è®¡ç®—ï¼Œä¸º9900/3 = 3300ã€‚refè®¿é—®è·¯å¾„çš„æˆæœ¬ä½¿ç”¨20è®²ä¸­çš„å…¬å¼è®¡ç®—ã€‚</p><pre><code class=\"language-plain\">&gt;&gt;&gt; ref_cost_normal_index(rows=3300, n_rows=9900, clustered_index_size=161, in_mem_pct=1.0)\n120.75\n</code></pre><p>å…³è”æŸ¥è¯¢çš„æ€»æˆæœ¬ç”±ä¸‹é¢è¿™æ®µPythonä»£ç æ¥è®¡ç®—ã€‚</p><pre><code class=\"language-plain\">def join_cost(t1_cost, t1_filtered_rows, t2_io_cost, t2_filtered_rows):\n    t2_cost = t2_io_cost + row_eval_cost(t2_filtered_rows)\n    result = t1_cost + t1_filtered_rows * t2_cost\n    return result\n</code></pre><p>ç”±æ­¤å¾—åˆ°æŸ¥è¯¢çš„æ€»æˆæœ¬ã€‚</p><pre><code class=\"language-plain\">&gt;&gt;&gt; t1_filetered_rows = 9900 * 0.1111\n&gt;&gt;&gt; t2_filtered_rows = 9900.0/3\n&gt;&gt;&gt; join_cost(t1_cost=1030.25, t1_filtered_rows=t1_filetered_rows, \\\n    t2_io_cost=120.75, t2_filtered_rows=t2_filtered_rows)\n496805.66750000004\n</code></pre><h3>åŸºäºå—çš„åµŒå¥—å¾ªç¯ï¼ˆBlock Nested-Loopï¼ŒBNLï¼‰</h3><p>å¦‚æœè¢«é©±åŠ¨è¡¨æ²¡æœ‰åˆé€‚çš„ç´¢å¼•å¯ç”¨ï¼Œåœ¨è€çš„ç‰ˆæœ¬ä¸­ï¼Œä¼šä½¿ç”¨åŸºäºå—çš„åµŒå¥—å¾ªç¯ç®—æ³•ã€‚åŸºäºå—çš„åµŒå¥—å¾ªç¯ç®—æ³•æ‰§è¡Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol>\n<li>\n<p>æŸ¥æ‰¾é©±åŠ¨è¡¨ä¸­æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€‚</p>\n</li>\n<li>\n<p>å°†ä»æ­¥éª¤1å¾—åˆ°çš„è®°å½•ç¼“å­˜åˆ°Join Bufferä¸­ã€‚Join bufferçš„å¤§å°ç”±å‚æ•°join_buffer_sizeæ§åˆ¶ã€‚</p>\n</li>\n<li>\n<p>å…¨è¡¨æ‰«æè¢«é©±åŠ¨è¡¨ã€‚å¦‚æœè¢«é©±åŠ¨è¡¨ä¸Šæœ‰å…¶ä»–è¿‡æ»¤æ¡ä»¶ï¼Œåˆ™å…ˆè¿›è¡Œè¿‡æ»¤ã€‚</p>\n</li>\n<li>\n<p>å°†ä»æ­¥éª¤3è·å–çš„è®°å½•å’ŒJoin Bufferä¸­çš„è®°å½•åšåŒ¹é…ã€‚</p>\n</li>\n<li>\n<p>å°†æ­¥éª¤4åŒ¹é…åˆ°çš„è®°å½•è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>\n</li>\n</ol><p>å¦‚æœé©±åŠ¨è¡¨ä¸­æ»¡è¶³æ¡ä»¶çš„è®°å½•å¤ªå¤šï¼Œæ— æ³•ä¸€æ¬¡æ€§å…¨éƒ¨ç¼“å­˜åˆ°Join Bufferä¸­ï¼Œè¿˜éœ€è¦åˆ†æ‰¹å¤„ç†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d0/da/d038c4336f04d82db0860a54acfd5dda.jpg?wh=1516x952\" alt=\"å›¾ç‰‡\"></p><p>MySQL 8.0.20ç‰ˆæœ¬ä¹‹åï¼Œå®é™…ä¸Šå·²ç»ä¸ä¼šå†ä½¿ç”¨åŸºäºå—çš„åµŒå¥—å¾ªç¯ç®—æ³•ã€‚ä¸‹é¢çš„æ‰§è¡Œè®¡åˆ’æ˜¯åœ¨5.7.41çš„ç‰ˆæœ¬ä¸­æ‰§è¡Œå¾—åˆ°ï¼ˆè¾“å‡ºä¸­å»æ‰äº†ä¸ç›¸å…³çš„åˆ—ï¼‰ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1, tab t2      \n    where t1.b between 1 and 100 \n\tand  t1.c = t2.c \n\tand t2.padding like '%x%';\n\t\n+----+-------------+-------+------+------+----------+----------------------------------------------------+\n| id | select_type | table | type | rows | filtered | Extra                                              |\n+----+-------------+-------+------+------+----------+----------------------------------------------------+\n|  1 | SIMPLE      | t1    | ALL  | 9755 |    11.11 | Using where                                        |\n|  1 | SIMPLE      | t2    | ALL  | 9755 |     1.11 | Using where; Using join buffer (Block Nested Loop) |\n+----+-------------+-------+------+------+----------+----------------------------------------------------+\n</code></pre><p>æ³¨æ„åˆ°ä¸Šé¢æ‰§è¡Œè®¡åˆ’ä¸­Extraåˆ—ä¸­æ˜¾ç¤ºçš„â€œUsing join buffer (Block Nested Loop) â€ã€‚ä¼˜åŒ–å™¨å‚æ•°optimizer_switchä¸­çš„é€‰é¡¹block_nested_loopç”¨æ¥æ§åˆ¶æ˜¯å¦å¼€å¯BNLï¼Œè¯¥é€‰é¡¹é»˜è®¤ä¸ºONã€‚</p><h3>å“ˆå¸Œè¿æ¥</h3><p>MySQL 8.0.20ç‰ˆæœ¬å¼€å§‹åºŸå¼ƒäº†å¯¹BNLçš„æ”¯æŒï¼ŒåŸå…ˆä½¿ç”¨BNLçš„æŸ¥è¯¢è½¬è€Œä½¿ç”¨å“ˆå¸Œè¿æ¥ï¼ŒåŒæ—¶optimizer_switchä¸­çš„é€‰é¡¹hash_joinä¹Ÿä¸å†èµ·ä½œç”¨äº†ã€‚ä½¿ç”¨å’Œä¸Šä¸€èŠ‚åŒæ ·çš„SQLï¼Œåœ¨8.0ä¸­æ‰§è¡Œæ˜¾ç¤ºä½¿ç”¨Hash Joinï¼Œè¿™é‡Œä½¿ç”¨format=treeï¼š</p><pre><code class=\"language-plain\">mysql&gt; explain format =tree select * from tab t1, tab t2      \n    where t1.b between 1 and 100 \n    and  t1.c = t2.c \n    and t2.padding like '%x%'\\G\n\nEXPLAIN: \n-&gt; Inner hash join (t2.c = t1.c)  (cost=122234.57 rows=1344)\n    -&gt; Filter: (t2.padding like '%x%')  (cost=99.21 rows=110)\n        -&gt; Table scan on t2  (cost=99.21 rows=9900)\n    -&gt; Hash\n        -&gt; Filter: (t1.b between 1 and 100)  (cost=1030.25 rows=1100)\n            -&gt; Table scan on t1  (cost=1030.25 rows=9900)\n</code></pre><p>ä»optimizer traceä¸­ï¼Œå¯ä»¥çœ‹åˆ°using_join_cacheä¸ºtrueï¼Œbuffers_neededæ˜¯éœ€è¦å¡«å……Join Bufferçš„æ¬¡æ•°ï¼Œè¿™æ˜¯ç”±é©±åŠ¨è¡¨ä¸­æ»¡è¶³æ¡ä»¶çš„è®°å½•æ•°ã€è¡Œé•¿åº¦ï¼Œä»¥åŠjoin_buffer_sizeçš„è®¾ç½®å†³å®šçš„ã€‚æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œjoin_buffer_sizeä½¿ç”¨äº†é»˜è®¤çš„256Kã€‚</p><pre><code class=\"language-plain\">{\n  \"considered_execution_plans\": [\n    {\n      \"plan_prefix\": [\n      ],\n      \"table\": \"`tab` `t1`\",\n      \"best_access_path\": {\n        \"considered_access_paths\": [\n          {\n            \"rows_to_scan\": 9900,\n            \"filtering_effect\": [\n            ],\n            \"final_filtering_effect\": 0.1111,\n            \"access_type\": \"scan\",\n            \"resulting_rows\": 1099.89,\n            \"cost\": 1030.25,\n            \"chosen\": true\n          }\n        ]\n      },\n      \"condition_filtering_pct\": 100,\n      \"rows_for_plan\": 1099.89,\n      \"cost_for_plan\": 1030.25,\n      \"rest_of_plan\": [\n        {\n          \"plan_prefix\": [\n            \"`tab` `t1`\"\n          ],\n          \"table\": \"`tab` `t2`\",\n          \"best_access_path\": {\n            \"considered_access_paths\": [\n              {\n                \"rows_to_scan\": 9900,\n                \"filtering_effect\": [\n                ],\n                \"final_filtering_effect\": 0.1111,\n                \"access_type\": \"scan\",\n                \"using_join_cache\": true,\n                \"buffers_needed\": 118,\n                \"resulting_rows\": 1099.89,\n                \"cost\": 230083,\n                \"chosen\": true\n              }\n            ]\n          },\n          \"condition_filtering_pct\": 10,\n          \"rows_for_plan\": 120976,\n          \"cost_for_plan\": 231113,\n          \"chosen\": true\n        }\n      ]\n    }\n</code></pre><h4>å“ˆå¸Œè¿æ¥æˆæœ¬è®¡ç®—</h4><p>å“ˆå¸Œè¿æ¥çš„æˆæœ¬åŒ…æ‹¬å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ol>\n<li>\n<p>è®¿é—®é©±åŠ¨è¡¨çš„æˆæœ¬ã€‚</p>\n</li>\n<li>\n<p>è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ã€‚</p>\n</li>\n</ol><p>å“ˆå¸Œè¿æ¥æ—¶ï¼Œè¢«é©±åŠ¨è¡¨å¯èƒ½éœ€è¦æ‰«æå¤šæ¬¡ï¼Œæ‰«ææ¬¡æ•°ä¸»è¦ç”±é©±åŠ¨è¡¨ç»“æœé›†çš„å¤§å°å’ŒJoin Bufferçš„å¤§å°å†³å®šã€‚è®¿é—®è¢«é©±åŠ¨è¡¨çš„æˆæœ¬ä¸»è¦åŒ…æ‹¬IOæˆæœ¬å’Œè¡Œè¯„ä¼°æˆæœ¬ã€‚å¦‚æœè¢«é©±åŠ¨è¡¨ä¸Šæœ‰é¢å¤–çš„è¿‡æ»¤æ¡ä»¶ï¼Œåˆ™åœ¨è¿™ä¸€æ­¥å¯ä»¥å…ˆæ»¤æ‰ä¸€éƒ¨åˆ†è®°å½•ã€‚</p><ol start=\"3\">\n<li>è¿æ¥çš„æˆæœ¬</li>\n</ol><p>è¿æ¥çš„æˆæœ¬ä¸»è¦æ˜¯è¡Œè¯„ä¼°æˆæœ¬ã€‚åœ¨æ­¥éª¤2ä¸­å·²ç»è¿‡æ»¤æ‰çš„è®°å½•ä¸éœ€è¦å‚ä¸è¡¨è¿æ¥ï¼Œå› æ­¤è¿æ¥æˆæœ¬æ ¹æ®æ­¥éª¤2è¿‡æ»¤ä¹‹åçš„è®°å½•æ•°æ¥è®¡ç®—ã€‚</p><p>å“ˆå¸Œè¿æ¥çš„æˆæœ¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹Pythonä»£ç æ¥è®¡ç®—ã€‚</p><pre><code class=\"language-plain\">def hash_join_cost(t1_cost, \n    prefix_rows, \n    t2_scan_cost, \n    t2_rows, \n    t2_filtered_rows, \n    cached_row_len,\n    join_buffer_size\n):\n    buffer_cnt = 1.0 + 1.0 * cached_row_len * prefix_rows / join_buffer_size\n    t2_scan_cost_all = buffer_cnt * t2_scan_cost\n    t2_row_eval_cost = buffer_cnt * row_eval_cost(t2_rows - t2_filtered_rows)\n    join_row_eval_cost = row_eval_cost(prefix_rows * t2_filtered_rows)\n    result = t1_cost + t2_scan_cost_all + t2_row_eval_cost + join_row_eval_cost\n    return result\n</code></pre><p>å‡½æ•°hash_join_costå‚æ•°çš„å«ä¹‰æˆ‘æ•´ç†æˆä¸‹é¢è¿™ä¸ªè¡¨æ ¼ï¼Œä¾›ä½ å‚è€ƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/19/9d/19f67522d9ea270d4af42dab18c5379d.png?wh=1920x972\" alt=\"å›¾ç‰‡\"></p><p>åœ¨æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œé©±åŠ¨è¡¨å…¨è¡¨æ‰«æè®¿é—®æˆæœ¬ä¸º1030.25ï¼Œé©±åŠ¨è¡¨è¿‡æ»¤æ€§ä¸º0.1111ã€‚è¢«é©±åŠ¨è¡¨å•æ¬¡æ‰«æIOçš„æˆæœ¬ä¸º40.25ã€‚è¢«é©±åŠ¨è¡¨æ€»è®°å½•æ•°ä¸º9900ï¼Œè¢«é©±åŠ¨è¡¨è¿‡æ»¤æ€§ä¸º0.1111ã€‚é©±åŠ¨è¡¨æ•´è¡Œè®°å½•éƒ½éœ€è¦ç¼“å­˜åˆ°Join Bufferä¸­ï¼Œå•è¡Œè®°å½•çš„é•¿åº¦ä¸º28019ï¼Œjoin_buffer_sizeä¸º256Kï¼Œå› æ­¤æŸ¥è¯¢çš„æ€»æˆæœ¬ä¸º231112.789595233ã€‚</p><pre><code class=\"language-plain\">&gt;&gt;&gt; hash_join_cost(1030.25,\n     prefix_rows=9900 * 0.1111,\n     t2_scan_cost=40.25,\n     t2_rows=9900,\n     t2_filtered_rows=9900*0.1111,\n     cached_row_len=28019,\n     join_buffer_size=256*1024)\n231112.789595233\n</code></pre><p>è¿™é‡Œè¡Œé•¿åº¦æ˜¯æ ¹æ®è¡¨ç»“æ„æ¥è®¡ç®—çš„ï¼Œ4ä¸ªæ•´æ•°å­—æ®µé•¿åº¦å›ºå®šï¼Œvarcharå­—æ®µæŒ‰å®šä¹‰çš„é•¿åº¦è®¡ç®—ã€‚</p><pre><code class=\"language-plain\">mysql&gt; desc tab;\n+---------+---------------+------+-----+---------+-------+\n| Field   | Type          | Null | Key | Default | Extra |\n+---------+---------------+------+-----+---------+-------+\n| id      | int           | NO   | PRI | NULL    |       |\n| a       | int           | NO   | MUL | NULL    |       |\n| b       | int           | NO   |     | NULL    |       |\n| c       | int           | NO   |     | NULL    |       |\n| padding | varchar(7000) | YES  |     | NULL    |       |\n+---------+---------------+------+-----+---------+-------+\n</code></pre><h4>éç­‰å€¼å“ˆå¸Œè¿æ¥</h4><p>æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨åªæ”¯æŒç­‰å€¼æŸ¥æ‰¾ã€‚ä½†æ˜¯åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè¿æ¥æ¡ä»¶ä¸ºt1.c &gt; t2.cï¼Œå¯ä»¥çœ‹åˆ°ä¹Ÿä½¿ç”¨äº†å“ˆå¸Œè¿æ¥ï¼ˆæ³¨æ„Extraä¸­æ˜¾ç¤ºçš„â€œUsing join buffer (hash join)â€ï¼‰ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1, tab t2 \n    where t1.b between 1 and 100 and t1.c &gt; t2.c;\n\n+----+-------------+-------+------+------+----------+--------------------------------------------+\n| id | select_type | table | type | rows | filtered | Extra                                      |\n+----+-------------+-------+------+------+----------+--------------------------------------------+\n|  1 | SIMPLE      | t1    | ALL  | 9900 |    11.11 | Using where                                |\n|  1 | SIMPLE      | t2    | ALL  | 9900 |    33.33 | Using where; Using join buffer (hash join) |\n+----+-------------+-------+------+------+----------+--------------------------------------------+\n</code></pre><p>å®é™…ä¸Šï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯å…ˆåšäº†ä¸€ä¸ªä¸å¸¦å…³è”æ¡ä»¶çš„ç¬›å¡å°”è¿æ¥ï¼Œç„¶åå†å¯¹ç»“æœæ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚ä½¿ç”¨explain format=treeå¯ä»¥æ›´æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸€ç‚¹ï¼Œæ³¨æ„æ‰§è¡Œè®¡åˆ’ä¸­æ˜¾ç¤ºçš„â€œInner hash join (no condition)â€ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain format=tree select * from tab t1, tab t2\n         where t1.b between 1 and 100 and t1.c &gt; t2.c\\G\n*************************** 1. row ***************************\nEXPLAIN: \n-&gt; Filter: (t1.c &gt; t2.c)  (cost=1094693.45 rows=3629274)\n    -&gt; Inner hash join (no condition)  (cost=1094693.45 rows=3629274)\n        -&gt; Table scan on t2  (cost=4.64 rows=9900)\n        -&gt; Hash\n            -&gt; Filter: (t1.b between 1 and 100)  (cost=1030.25 rows=1100)\n                -&gt; Table scan on t1  (cost=1030.25 rows=9900)\n</code></pre><h3>BKAï¼ˆBlocked Key Accessï¼‰</h3><p>å•è¡¨rangeæŸ¥è¯¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨MRRä¼˜åŒ–ï¼Œå…ˆå¯¹rowidè¿›è¡Œæ’åºï¼Œç„¶åå†å›è¡¨æŸ¥è¯¢æ•°æ®ã€‚åœ¨è¡¨å…³è”çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„ä¼˜åŒ–æ–¹æ³•ï¼Œå…ˆæ ¹æ®å…³è”æ¡ä»¶å–å‡ºè¢«å…³è”è¡¨çš„rowidï¼Œå°†rowidç¼“å­˜åœ¨join bufferä¸­ï¼Œå¯¹rowidè¿›è¡Œæ’åºåï¼Œå†å›è¡¨è·å–æ•°æ®ã€‚</p><p>ä½¿ç”¨BKAç®—æ³•æ—¶ï¼Œä¼šç”¨åˆ°Join Bufferã€‚BKAè¿æ¥ç®—æ³•çš„æ‰§è¡Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><ol>\n<li>\n<p>ä»é©±åŠ¨è¡¨ä¸­è¯»å–æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€‚</p>\n</li>\n<li>\n<p>å°†æ­¥éª¤1è¯»å–çš„1è¡Œè®°å½•ç¼“å­˜åˆ°Join Bufferä¸­ã€‚</p>\n</li>\n<li>\n<p>è¯„ä¼°é©±åŠ¨è¡¨çš„1è¡Œè®°å½•å ç”¨çš„å†…å­˜ï¼Œä»¥åŠé€šè¿‡è¿™1è¡Œè®°å½•èƒ½å…³è”åˆ°çš„è¢«é©±åŠ¨è¡¨çš„è®°å½•ROWIDå ç”¨çš„ç©ºé—´ã€‚</p>\n</li>\n</ol><p>å¦‚æœjoin bufferç©ºé—´å¤Ÿç”¨ï¼Œåˆ™ç»§ç»­å¾€join bufferä¸­åŠ å…¥é©±åŠ¨è¡¨çš„è®°å½•ã€‚å¦åˆ™ï¼Œåˆ†é…MRR bufferï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥éª¤ã€‚MRR Bufferåˆ†é…çš„ç©ºé—´ä¸ºjoin_buffer_sizeå‡å»æ­¥éª¤2ç¼“å­˜çš„è¡Œå ç”¨çš„ç©ºé—´ã€‚</p><ol>\n<li>\n<p>æ ¹æ®ç¼“å­˜çš„é©±åŠ¨è¡¨çš„è®°å½•ï¼Œæ‰«æè¢«é©±åŠ¨è¡¨çš„ç´¢å¼•ï¼Œå°†è®°å½•çš„rowidç¼“å­˜åˆ°MRR bufferä¸­ã€‚å°†MRR bufferå†…çš„rowidè¿›è¡Œæ’åºã€‚</p>\n</li>\n<li>\n<p>æŒ‰ROWIDçš„é¡ºåºåˆ°è¢«é©±åŠ¨è¡¨è·å–æ•°æ®ã€‚</p>\n</li>\n<li>\n<p>å…³è”æ•°æ®ï¼Œå¹¶å°†å…³è”åçš„æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>\n</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/d3/7e/d3e8f35aa560c210a158b5d317a1c07e.jpg?wh=1568x988\" alt=\"å›¾ç‰‡\"></p><p>å’Œå•è¡¨MRRä¼˜åŒ–ç±»ä¼¼ï¼Œè¡¨å…³è”æ—¶ä½¿ç”¨BKAä¼˜åŒ–æœ‰ä¸€äº›å‰ææ¡ä»¶ï¼š</p><ol>\n<li>\n<p>è¢«é©±åŠ¨è¡¨çš„å…³è”å­—æ®µå­˜åœ¨äºŒçº§ç´¢å¼•ã€‚å¦‚æœä½¿ç”¨è¢«é©±åŠ¨è¡¨çš„å…³è”æ¡ä»¶æ˜¯ä¸»é”®ï¼Œåˆ™ä¸ä¼šé‡‡ç”¨BKAä¼˜åŒ–ã€‚</p>\n</li>\n<li>\n<p>éœ€è¦å›è¡¨è®¿é—®è¢«å…³è”è¡¨ã€‚å¦‚æœåœ¨æŸ¥è¯¢ä¸­ï¼Œè¢«é©±åŠ¨è¡¨è®¿é—®çš„å­—æ®µéƒ½åœ¨ç´¢å¼•ä¸­ï¼Œä¸éœ€è¦å›è¡¨ï¼Œåˆ™ä¸ä¼šé‡‡ç”¨BKAä¼˜åŒ–ã€‚</p>\n</li>\n<li>\n<p>optimizer_switchå‚æ•°ä¸­ï¼Œå¼€å¯batched_key_accessé€‰é¡¹å’Œmrré€‰é¡¹ã€‚batched_key_accessé»˜è®¤ä¸ºOFFã€‚</p>\n</li>\n<li>\n<p>optimizer_switchå‚æ•°ä¸­ï¼Œå°†mrr_cost_basedè®¾ç½®ä¸ºOFFã€‚ç›®å‰å¯¹ä¼˜åŒ–å™¨å¯¹MRRæˆæœ¬è¯„ä¼°æ¯”è¾ƒä¿å®ˆï¼Œå› æ­¤å¼€å¯mrr_cost_basedæ—¶ï¼ŒMRRæ‰§è¡Œè®¡åˆ’çš„æˆæœ¬å¾ˆå¯èƒ½æ¯”æ™®é€šçš„åµŒå¥—å¾ªç¯è¿˜è¦é«˜ã€‚</p>\n</li>\n</ol><p>æˆ‘ä»¬å¯ä»¥åœ¨æŸ¥è¯¢ä¸­åŠ ä¸ŠBKAæˆ–MRRæç¤ºï¼Œå¼ºåˆ¶èµ°BKAæ‰§è¡Œè®¡åˆ’ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select /*+ BKA(t2) */ *      \n    from tab t1, tab t2     \n    where t1.b between 1 and 100      \n    and t1.a = t2.a;\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+----------------------------------------+\n| id | select_type | table | type | possible_keys | key     | key_len | ref      | rows | filtered | Extra                                  |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+----------------------------------------+\n|  1 | SIMPLE      | t1    | ALL  | idx_abc       | NULL    | NULL    | NULL     | 9913 |    11.11 | Using where                            |\n|  1 | SIMPLE      | t2    | ref  | idx_abc       | idx_abc | 4       | rep.t1.a | 3304 |   100.00 | Using join buffer (Batched Key Access) |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+----------------------------------------+\n</code></pre><p>BKAçš„æˆæœ¬è®¡ç®—æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ã€‚</p><h2>æ¡ä»¶è¿‡æ»¤ï¼ˆCondition Filteringï¼‰</h2><p>ä¼˜åŒ–å™¨åœ¨è®¡ç®—è¡¨çš„è¿æ¥é¡ºåºæ—¶ï¼Œéœ€è¦è¯„ä¼°æ¯ä¸ªè¡¨æœ‰å¤šå°‘è¡Œè®°å½•æ»¡è¶³æ¡ä»¶ï¼Œè¿™å†³å®šäº†æœ‰å¤šå°‘è¡Œè®°å½•ä¼šå‚ä¸åˆ°åç»­çš„è¿æ¥æ“ä½œä¸­ã€‚è¡Œæ•°è¯„ä¼°æ˜¯å¦ç²¾ç¡®ï¼Œä¼šå½±å“ä¼˜åŒ–å™¨æ˜¯å¦èƒ½è·å–ä¸€ä¸ªæ€§èƒ½è‰¯å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚å¦‚æœå­—æ®µä¸Šæœ‰ç´¢å¼•ï¼ŒMySQLå¯ä»¥ä½¿ç”¨Index Diveæœºåˆ¶æˆ–è€…è¡¨å’Œç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯æ¥è¯„ä¼°è¡Œæ•°ã€‚å¦‚æœå­—æ®µæ²¡æœ‰å»ºç´¢å¼•ï¼ŒMySQLä¼šä½¿ç”¨ä¸€äº›å›ºå®šçš„è§„åˆ™æ¥é¢„ä¼°æ»¡è¶³æ¡ä»¶çš„è®°å½•æ•°ï¼Œè¿™ä¹Ÿç§°ä¸ºæ¡ä»¶è¿‡æ»¤ã€‚</p><p>æˆ‘ä»¬ç”¨å‡ ä¸ªç®€å•çš„SQLæ¥è§‚å¯Ÿä¸‹æ¡ä»¶è¿‡æ»¤çš„ä¸€äº›æƒ…å†µã€‚</p><p>tabè¡¨ä¸­æ²¡æœ‰ä»¥å­—æ®µCå¼€å¤´çš„ç´¢å¼•ï¼Œä¸‹é¢çš„æŸ¥è¯¢ä½¿ç”¨å…¨è¡¨æ‰«æï¼Œè¿‡æ»¤æ¡ä»¶C=1çš„è¿‡æ»¤æ€§ä¸º10%ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where c = 1;\n+----+-------------+-------+------+------+----------+-------------+\n| id | select_type | table | type | rows | filtered | Extra       |\n+----+-------------+-------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | 9900 |    10.00 | Using where |\n+----+-------------+-------+------+------+----------+-------------+\n</code></pre><p>ä¸‹é¢çš„SQLä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯å­—æ®µCä¸åœ¨ç´¢å¼•çš„å‰ç¼€ä¸­ï¼Œå› æ­¤åªç”¨åˆ°äº†ç´¢å¼•å­—æ®µAã€‚è¿‡æ»¤æ€§æ ¹æ®æ¡ä»¶C=1è®¡ç®—ï¼Œä¸º10%ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where a = 1 and c = 1;\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+\n| id | select_type | table | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra                 |\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+\n|  1 | SIMPLE      | tab   | ref  | idx_abc       | idx_abc | 4       | const | 3333 |    10.00 | Using index condition |\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+\n</code></pre><p>è¿™æ˜¯å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œä½¿ç”¨ä¸ç­‰äºæ¡ä»¶ï¼Œè¿‡æ»¤æ€§ä¸º90%ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where c != 1;\n+----+-------------+-------+------+------+----------+-------------+\n| id | select_type | table | type | rows | filtered | Extra       |\n+----+-------------+-------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | 9900 |    90.00 | Using where |\n+----+-------------+-------+------+------+----------+-------------+\n</code></pre><p>ä¸‹é¢çš„è¡¨æ ¼æ€»ç»“äº†ä¸€äº›å¸¸è§åœºæ™¯ä¸‹çš„è¿‡æ»¤æ€§ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a5/42/a5ed0f20c4b00716e70a282cf3d74942.png?wh=1920x1253\" alt=\"å›¾ç‰‡\"></p><h3>ç›´æ–¹å›¾</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQLå¹¶ä¸çŸ¥é“è¡¨ä¸­æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œå› æ­¤åœ¨ä¼°ç®—æ¡ä»¶çš„è¿‡æ»¤æ€§æ—¶å¯èƒ½ä¼šå­˜åœ¨è¾ƒå¤§çš„åå·®ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæŸ¥è¯¢ï¼ŒæŒ‰é»˜è®¤çš„è§„åˆ™ï¼Œé¢„ä¼°æŸ¥è¯¢è¿”å›çš„è®°å½•æ•°ä¸º2970è¡Œã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where b  in (1,2,3);\n+----+-------------+-------+------+------+----------+-------------+\n| id | select_type | table | type | rows | filtered | Extra       |\n+----+-------------+-------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | 9900 |    30.00 | Using where |\n+----+-------------+-------+------+------+----------+-------------+\n\nmysql&gt; explain format=tree select * from tab where b  in (1,2,3)\\G\n*************************** 1. row ***************************\nEXPLAIN: \n-&gt; Filter: (tab.b in (1,2,3))  (cost=1030.25 rows=2970)\n    -&gt; Table scan on tab  (cost=1030.25 rows=9900)\n</code></pre><p>ä½†å®é™…ä¸Šï¼Œåªæœ‰3è¡Œè®°å½•æ»¡è¶³æ¡ä»¶ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select count(*) from tab where b in (1,2,3);\n+----------+\n| count(*) |\n+----------+\n|        3 |\n+----------+\n</code></pre><p>è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ”¶é›†å­—æ®µçš„ç›´æ–¹å›¾ï¼Œä»¥å¾—åˆ°æ›´ç²¾ç¡®çš„è¡Œæ•°è¯„ä¼°ã€‚</p><pre><code class=\"language-plain\">mysql&gt; analyze table tab UPDATE HISTOGRAM ON b;\n+---------+-----------+----------+----------------------------------------------+\n| Table   | Op        | Msg_type | Msg_text                                     |\n+---------+-----------+----------+----------------------------------------------+\n| rep.tab | histogram | status   | Histogram statistics created for column 'b'. |\n+---------+-----------+----------+----------------------------------------------+\n</code></pre><p>æ”¶é›†å­—æ®µBä¸Šçš„ç›´æ–¹å›¾åï¼ŒæŸ¥è¯¢è·å¾—äº†æ›´ç²¾ç¡®çš„è®°å½•æ•°ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain format=tree select * from tab where b  in (1,2,3)\\G\n*************************** 1. row ***************************\nEXPLAIN: \n-&gt; Filter: (tab.b in (1,2,3))  (cost=1030.25 rows=10)\n    -&gt; Table scan on tab  (cost=1030.25 rows=9900)\n</code></pre><p>è¿™é‡Œé¢„ä¼°çš„è®°å½•æ•°ä¸º10ï¼Œå’ŒçœŸå®çš„è®°å½•æ•°æœ‰ä¸€äº›å·®è·ï¼Œä½†æ˜¯æ¯”æ”¶é›†ç›´æ–¹å›¾ä¹‹å‰çš„è¯„ä¼°è¦å‡†ç¡®å¤šäº†ã€‚</p><p>åœ¨å•è¡¨æŸ¥è¯¢ä¸­ï¼Œæ˜¯å¦ä½¿ç”¨æ¡ä»¶è¿‡æ»¤å¯¹æ‰§è¡Œè®¡åˆ’çš„å½±å“å¹¶ä¸å¤§ã€‚ä½†æ˜¯åœ¨å¤šè¡¨è¿æ¥çš„æŸ¥è¯¢ä¸­ï¼Œæ¡ä»¶è¿‡æ»¤å¯èƒ½ä¼šå½±å“æ‰§è¡Œè®¡åˆ’ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨optimizer_switchä¸­çš„condition_fanout_filteré€‰é¡¹æ¥æ§åˆ¶æ˜¯å¦å¼€å¯æ¡ä»¶è¿‡æ»¤è®¡ç®—ã€‚</p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå…³é—­äº†condition_fanout_filteré€‰é¡¹ï¼ŒæŸ¥è¯¢çš„è¿‡æ»¤æ€§å°±å˜æˆäº†100%ã€‚</p><pre><code class=\"language-plain\">mysql&gt; set optimizer_switch='condition_fanout_filter=off';\nQuery OK, 0 rows affected (0.01 sec)\n\n\nmysql&gt; explain select * from tab where b=10;\n+----+-------------+-------+------+------+----------+-------------+\n| id | select_type | table | type | rows | filtered | Extra       |\n+----+-------------+-------+------+------+----------+-------------+\n|  1 | SIMPLE      | tab   | ALL  | 9900 |   100.00 | Using where |\n+----+-------------+-------+------+------+----------+-------------+\n</code></pre><h2>è¡¨è¿æ¥é¡ºåºå¦‚ä½•ç¡®å®š</h2><p>ç¡®å®šåˆé€‚çš„è¡¨è¿æ¥é¡ºåºæ˜¯ä¼˜åŒ–å™¨çš„ä¸€é¡¹é‡è¦å·¥ä½œã€‚å¦‚æœSQLä¸­ä½¿ç”¨äº†å¤–è¿æ¥æˆ–STRAIGHT_JOINï¼Œåˆ™ç›¸å…³çš„ä¸¤ä¸ªè¡¨çš„è¿æ¥é¡ºåºå·²ç»å›ºå®šï¼Œä¼˜åŒ–å™¨ä¸èƒ½è°ƒèŠ‚è¡¨çš„è¿æ¥é¡ºåºã€‚å¯¹äºæ™®é€šçš„è¡¨è¿æ¥ï¼ˆè‡ªç„¶è¿æ¥ã€å†…è¿æ¥ï¼‰ï¼Œä¼˜åŒ–å™¨éœ€è¦è¯„ä¼°ä¸åŒè¿æ¥é¡ºåºçš„æˆæœ¬ï¼Œå¹¶ä»ä¸­é€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p>Nä¸ªè¡¨çš„è¿æ¥æœ‰Nçš„é˜¶ä¹˜ç§å¯èƒ½çš„è¿æ¥é¡ºåºã€‚æ¯”å¦‚3ä¸ªè¡¨çš„è¿æ¥æœ‰6ç§è¿æ¥é¡ºåºï¼Œ5ä¸ªè¡¨çš„è¿æ¥æœ‰120ç§è¿æ¥é¡ºåºï¼Œ10ä¸ªè¡¨çš„è¿æ¥æœ‰3628800ç§è¿æ¥é¡ºåºã€‚éšç€è¡¨æ•°é‡çš„å¢åŠ ï¼Œè¿æ¥é¡ºåºçš„æ•°é‡å‘ˆæŒ‡æ•°å¢é•¿ï¼Œä»å…¶ä¸­é€‰æ‹©æœ€ä½³è¿æ¥é¡ºåºçš„æˆæœ¬ä¹Ÿç›¸åº”æˆæŒ‡æ•°çº§å¢é•¿ã€‚MySQLä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•æ¥ç¡®å®šè¡¨çš„è¿æ¥é¡ºåºï¼Œåœ¨æœç´¢è¿‡ç¨‹ä¸­ä½¿ç”¨äº†ä¸€äº›è§„åˆ™ï¼Œä»¥å‡å°‘è¯„ä¼°è¡¨è¿æ¥é¡ºåºæ¶ˆè€—çš„æ—¶é—´ï¼ŒåŒæ—¶è¿˜èƒ½å¾—åˆ°æœ€ä¼˜æˆ–æ¥è¿‘æœ€ä¼˜çš„è¿æ¥é¡ºåºã€‚</p><p>ä¼˜åŒ–å™¨å¤§è‡´ä¸Šä½¿ç”¨ä¸‹é¢è¿™å‡ ä¸ªæ­¥éª¤æ¥ç¡®å®šè¡¨çš„è¿æ¥é¡ºåºã€‚</p><ol>\n<li>è§£æSQLï¼Œå•ç‹¬è¯„ä¼°SQLä¸­æ¯ä¸ªè¡¨çš„è®¿é—®æˆæœ¬ã€‚</li>\n</ol><p>ä¼˜åŒ–å™¨é¦–å…ˆå¯¹æŸ¥è¯¢ä¸­çš„æ¯ä¸ªè¡¨è¿›è¡Œåˆæ­¥è¯„ä¼°ï¼ŒåŒ…æ‹¬è¡¨çš„è¡Œæ•°ã€æ‰«ææˆæœ¬ã€‚å¦‚æœæœ‰å¯ç”¨çš„ç´¢å¼•ï¼Œè¿˜éœ€è¦è¯„ä¼°ç´¢å¼•è®¿é—®çš„è®°å½•æ•°å’Œæˆæœ¬ã€‚</p><ol start=\"2\">\n<li>æ ¹æ®æ­¥éª¤1åˆ†æçš„ç»“æ„ï¼Œå¯¹è¡¨è¿›è¡Œåˆæ­¥æ’åºã€‚</li>\n</ol><p>æ­¥éª¤1ä¸­å·²ç»å¾—åˆ°äº†æ¯ä¸ªè¡¨çš„è®°å½•æ•°å’Œé€šè¿‡ç´¢å¼•è®¿é—®çš„è®°å½•æ•°ã€‚è¿™ä¸€æ­¥æ ¹æ®éœ€è¦è®¿é—®çš„è®°å½•æ•°è¿›è¡Œæ’åºï¼Œè®°å½•æ•°å°‘çš„è¡¨æ’åœ¨å‰ã€‚</p><ol start=\"3\">\n<li>ä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ï¼Œå¾—åˆ°æœ€ä½³çš„è¿æ¥é¡ºåºã€‚</li>\n</ol><p>å‡è®¾ä»æ­¥éª¤2å¾—åˆ°è¡¨çš„é¡ºåºä¸ºT1ï¼ŒT2ï¼ŒT3ï¼Œæ€»å…±æœ‰6ç§å¯èƒ½çš„è¿æ¥é¡ºåºã€‚æŒ‰ä¸‹å›¾æ˜¾ç¤ºçš„é¡ºåºä¾æ¬¡è¯„ä¼°è¡¨è¿æ¥æˆæœ¬ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/fd/8c4b365fab7f2665a30c2331a7b1b8fd.jpg?wh=1662x918\" alt=\"å›¾ç‰‡\"></p><p>å…ˆè®¡ç®—é¡ºåº1ï¼ˆT1, T2, T3ï¼‰çš„è¿æ¥æˆæœ¬ï¼Œå°†å¾—åˆ°çš„æˆæœ¬è®°ä¸ºæ‰§è¡Œè®¡åˆ’çš„æœ€ä½æˆæœ¬ã€‚ç„¶åä¾æ¬¡è¯„ä¼°å…¶å®ƒå‡ ç§è¿æ¥é¡ºåºçš„æˆæœ¬ï¼Œå¾—åˆ°æˆæœ¬æœ€ä½çš„è¿æ¥é¡ºåºã€‚åœ¨æœç´¢è¡¨è¿æ¥é¡ºåºæ—¶ï¼Œå®é™…ä¸Šå¹¶ä¸ä¼šç©·ä¸¾æ¯ä¸€ä¸ªå¯èƒ½çš„é¡ºåºï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹å¯ä»¥å‡å°‘æœç´¢çš„ç©ºé—´ã€‚</p><ol>\n<li>\n<p>å¯¹ä¸€ä¸ªç‰¹å®šçš„è¿æ¥é¡ºåºï¼Œå¦‚æœå‰é¢å‡ ä¸ªè¡¨çš„è¿æ¥æˆæœ¬å·²ç»è¶…è¿‡æœ€ä½çš„è®¿é—®æˆæœ¬ï¼Œåˆ™ä¸éœ€è¦å†è¯„ä¼°ä»¥è¿™å‡ ä¸ªè¡¨å¼€å¤´çš„è¿æ¥é¡ºåºã€‚ä¾‹å¦‚åœ¨è¯„ä¼°T2å¼€å¤´è¿™ä¸ªè¿æ¥é¡ºåºæ—¶ï¼Œå¦‚æœè®¿é—®T2è¡¨å¯¹æˆæœ¬æ¯”ä¹‹å‰å¾—åˆ°çš„æœ€ä½æˆæœ¬è¿˜è¦é«˜ï¼Œå°±ä¸éœ€è¦å†è¯„ä¼°T2,T1,T3å’ŒT2,T3,T1è¿™å‡ ç§è¿æ¥é¡ºåºäº†ã€‚</p>\n</li>\n<li>\n<p>å‚æ•°optimizer_search_depthè®¾ç½®äº†æœç´¢çš„æœ€å¤§æ·±åº¦ã€‚å¯ä»¥é€šè¿‡å‚æ•°optimizer_search_depthæ¥é™åˆ¶æœç´¢æ·±åº¦ã€‚æ¯”å¦‚å¯¹äº20ä¸ªè¡¨çš„è¿æ¥ï¼Œéœ€è¦è¯„ä¼°çš„é¡ºåºæ•°ä¸º20çš„é˜¶ä¹˜ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å·¨å¤§çš„æ•°å­—ã€‚å¦‚æœå°†optimizer_search_depthè®¾ç½®ä¸º10ï¼Œå¯ä»¥å°†è¯„ä¼°çš„é¡ºåºæ•°é™åˆ¶åˆ°20*10çš„é˜¶ä¹˜ä»¥å†…ã€‚é™åˆ¶æœç´¢æ·±åº¦å¯ä»¥å‡å°‘ç”¨æ¥è¯„ä¼°è¡¨è¿æ¥é¡ºåºçš„æ—¶é—´ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½ä¼šé”™è¿‡æœ€ä½³çš„è¿æ¥é¡ºåºã€‚å¦‚æœä½ ä¸ç¡®å®šå¦‚ä½•è®¾ç½®è¯¥å‚æ•°ï¼Œå¯ä»¥å°è¯•å°†optimizer_search_depthè®¾ç½®ä¸º0ï¼Œä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„å€¼ã€‚</p>\n</li>\n<li>\n<p>ä½¿ç”¨ä¸€äº›å¯å‘å¼è§„åˆ™è·³è¿‡ä¸€äº›çœ‹èµ·æ¥ä¸å¤ªæœ‰å‰æ™¯çš„è¿æ¥é¡ºåºã€‚ä¼˜åŒ–å™¨è¿˜ä½¿ç”¨äº†ä¸€äº›å¯å‘å¼çš„è§„åˆ™ï¼Œæ¥è·³è¿‡ä¸€äº›çœ‹èµ·æ¥ä¸å¤ªå¥½çš„è¿æ¥é¡ºåºã€‚å½“ç„¶è¿™æœ‰å¯èƒ½é”™è¿‡æœ€ä½³çš„è¿æ¥é¡ºåºï¼Œä½†æ˜¯å¯ä»¥å‡å°‘ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„æ—¶é—´ã€‚å¯ä»¥é€šè¿‡å‚æ•°optimizer_prune_levelæ¥æ§åˆ¶æ˜¯å¦ä½¿ç”¨å¯å‘å¼è§„åˆ™ã€‚è¯¥å‚æ•°é»˜è®¤ä¸ºONã€‚å¦‚æœä½ è§‰å¾—å› ä¸ºä½¿ç”¨äº†å¯å‘å¼è§„åˆ™å¯¼è‡´ä¼˜åŒ–å™¨é€‰é¡¹äº†ä¸ä½³çš„è¿æ¥é¡ºåºï¼Œå¯ä»¥å°è¯•å…³é—­è¯¥é€‰é¡¹ã€‚</p>\n</li>\n</ol><p>ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è§‚å¯Ÿä¼˜åŒ–å™¨å¦‚ä½•é€‰æ‹©è¡¨çš„è¿æ¥é¡ºåºã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain\n     select * from tab t1, tab t2, tab t3\n     where t1.c = t2.c\n     and t2.b = t3.b\n     and t1.c in (10,20,30)\n     and t2.b between 1000 and 2000\n     and t2.a = 2\n     and t3.a &gt; 1 and t3.a &lt;=2;\n+----+-------------+-------+-------+---------+------+----------+--------------------------------------------+\n| id | select_type | table | type  | key     | rows | filtered | Extra                                      |\n+----+-------------+-------+-------+---------+------+----------+--------------------------------------------+\n|  1 | SIMPLE      | t3    | range | idx_abc |  667 |   100.00 | Using index condition                      |\n|  1 | SIMPLE      | t2    | ref   | idx_abc |    1 |   100.00 | Using index condition                      |\n|  1 | SIMPLE      | t1    | ALL   | NULL    | 9913 |     3.00 | Using where; Using join buffer (hash join) |\n+----+-------------+-------+-------+---------+------+----------+--------------------------------------------+\n</code></pre><p>ä»optimizer traceä¸­å¯ä»¥è§‚å¯Ÿåˆ°ä¼˜åŒ–çš„è¿‡ç¨‹ï¼š</p><ol>\n<li>å•ç‹¬è¯„ä¼°æ¯ä¸ªè¡¨çš„è¡Œæ•°å’Œç´¢å¼•ï¼ˆæŸ¥çœ‹optimizer traceä¸­rows_estimationéƒ¨åˆ†ï¼‰</li>\n</ol><ul>\n<li>T1è¡¨</li>\n</ul><p>T1è¡¨çš„æ¡ä»¶ä¸ºt1.c in (10,20,30)ï¼Œæ— å¯ç”¨ç´¢å¼•ï¼Œè®¿é—®è®°å½•æ•°ä¸º9913ã€‚</p><pre><code class=\"language-plain\">{\n  \"table\": \"`tab` `t1`\",\n  \"table_scan\": {\n    \"rows\": 9913,\n    \"cost\": 40.25\n  }\n}\n</code></pre><ul>\n<li>T2è¡¨</li>\n</ul><p>T2è¡¨çš„æ¡ä»¶ä¸ºt2.a = 2 and t2.b between 1000 and 2000ï¼Œå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œè®¿é—®è®°å½•æ•°ä¸º334ã€‚</p><pre><code class=\"language-plain\">\"chosen_range_access_summary\": {\n  \"range_access_plan\": {\n    \"type\": \"range_scan\",\n    \"index\": \"idx_abc\",\n    \"rows\": 334,\n    \"ranges\": [\n      \"a = 2 AND 1000 &lt;= b &lt;= 2000 AND 10 &lt;= c &lt;= 30\"\n    ]\n  },\n  \"rows_for_plan\": 334,\n  \"cost_for_plan\": 117.16,\n  \"chosen\": true\n}\n</code></pre><ul>\n<li>T3è¡¨</li>\n</ul><p>T3è¡¨çš„æ¡ä»¶ä¸ºt3.a &gt; 1 and t3.a &lt;=2ï¼Œå¯ä»¥ä½¿ç”¨ç´¢å¼•ã€‚è®¿é—®è®°å½•æ•°ä¸º667ã€‚</p><pre><code class=\"language-plain\"> \"chosen_range_access_summary\": {\n   \"range_access_plan\": {\n     \"type\": \"range_scan\",\n     \"index\": \"idx_abc\",\n     \"rows\": 667,\n     \"ranges\": [\n       \"1 &lt;= a &lt;= 2 AND b &lt;= 2000\"\n     ]\n   },\n   \"rows_for_plan\": 667,\n   \"cost_for_plan\": 233.71,\n   \"chosen\": true\n } \n</code></pre><ol start=\"2\">\n<li>ç¡®å®šè¡¨çš„åˆå§‹è¿æ¥é¡ºåºã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/18/ea/18f8e99a3fdd36fc20e39ef6f350c0ea.png?wh=1920x664\" alt=\"å›¾ç‰‡\"></p><p>è¡¨çš„åˆå§‹è¿æ¥é¡ºåºä¸ºT2ï¼ŒT3ï¼ŒT1ã€‚</p><ol start=\"3\">\n<li>æœç´¢æœ€ä½³è¿æ¥é¡ºåºã€‚</li>\n</ol><p>å¯ä»¥ä»optimizer tracä¸­çš„considered_execution_plansä¸­è§‚å¯Ÿè¡¨è¿æ¥é¡ºåºçš„è¯„ä¼°è¿‡ç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9a/aa/9a3eeaff6f558c2284d2db57749bafaa.png?wh=1920x1268\" alt=\"å›¾ç‰‡\"></p><p>ä¸‹é¢å°±æ˜¯è¿™ä¸ªæŸ¥è¯¢è¿æ¥é¡ºåºè¯„ä¼°è¿‡ç¨‹çš„ä¸€ä¸ªç¤ºæ„å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0b/7c/0bc216212f4276ef990859a7296e437c.jpg?wh=1722x862\" alt=\"å›¾ç‰‡\"></p><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MySQLä¸­è¡¨è¿æ¥çš„å‡ ç§æ–¹æ³•ã€‚</p><p>ä¼˜åŒ–å™¨ä¼šè¯„ä¼°ä¸åŒçš„è¿æ¥é¡ºåºå’Œè¿æ¥æ–¹æ³•çš„æˆæœ¬ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªæˆæœ¬æœ€ä½çš„æ‰§è¡Œè®¡åˆ’ã€‚åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œä¼˜åŒ–å™¨é€‰æ‹©çš„æ‰§è¡Œè®¡åˆ’ï¼Œåœ¨æ‰§è¡Œæ—¶å¹¶ä¸æ˜¯æ•ˆç‡æœ€é«˜çš„ï¼Œè¿™æ—¶å°±éœ€è¦æˆ‘ä»¬åˆ†æSQLä¸­ç›¸å…³è¡¨çš„ç´¢å¼•ç»“æ„å’Œç»Ÿè®¡ä¿¡æ¯ï¼ŒæŸ¥çœ‹è¡¨çš„æ•°æ®åˆ†å¸ƒæƒ…å†µï¼Œæƒ³åŠæ³•è®©ä¼˜åŒ–å™¨é€‰æ‹©æ•ˆç‡æ›´é«˜çš„æ‰§è¡Œè®¡åˆ’ã€‚å­æŸ¥è¯¢ã€åŠè¿æ¥(Semi Join)ã€åè¿æ¥ï¼ˆAnti Joinï¼‰çš„å†…å®¹å‘¢ï¼Œæˆ‘ä»¬æ”¾åˆ°ä¸‹ä¸€èŠ‚è¯¾å†è®¨è®ºã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åæ¥çœ‹ä¸€ä¸ªè¡¨è¿æ¥çš„ä¾‹å­ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨ï¼Œå†™å…¥10000è¡Œæ•°æ®ã€‚</p><pre><code class=\"language-plain\">create table t_jointab(\n  id int not null auto_increment,\n  a int not null,\n  b int not null,\n  c varchar(4000),\n    primary key(id),\n    key idx_a(a)\n) engine=innodb charset utf8mb4;\n\n\ninsert into t_jointab(a,b,c)\nselect case when n &lt; 9000 then n else 9000 end as a,\n    n % 1000, rpad('x', 2000, 'ABCD')\nfrom numbers where n &lt; 10000;\n</code></pre><p>æ”¶é›†å¹¶æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\">mysql&gt; analyze table t_jointab;\n+---------------+---------+----------+----------+\n| Table         | Op      | Msg_type | Msg_text |\n+---------------+---------+----------+----------+\n| rep.t_jointab | analyze | status   | OK       |\n+---------------+---------+----------+----------+\n1 row in set (0.62 sec)\n\nmysql&gt; show indexes from t_jointab;\n+------------+----------+--------------+-------------+-------------+\n| Non_unique | Key_name | Seq_in_index | Column_name | Cardinality |\n+------------+----------+--------------+-------------+-------------+\n|          0 | PRIMARY  |            1 | id          |        8580 |\n|          1 | idx_a    |            1 | a           |        8580 |\n+------------+----------+--------------+-------------+-------------+\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’ï¼Œä½¿ç”¨äº†åµŒå¥—å¾ªç¯ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain format=tree \n    select count(*) \n    from t_jointab t1, t_jointab t2 \n    where t1.a = t2.a and t1.b = t2.b\\G\n*************************** 1. row ***************************\nEXPLAIN: \n-&gt; Aggregate: count(0)  (cost=5079.75 rows=1)\n    -&gt; Nested loop inner join  (cost=4221.75 rows=8580)\n        -&gt; Table scan on t1  (cost=1218.75 rows=8580)\n        -&gt; Filter: (t2.b = t1.b)  (cost=0.25 rows=1)\n            -&gt; Index lookup on t2 using idx_a (a=t1.a)  (cost=0.25 rows=1)\n</code></pre><p>ä¸Šé¢è¿™ä¸ªæ‰§è¡Œè®¡åˆ’çœ‹ä¸Šå»æ²¡ä»€ä¹ˆå¤§é—®é¢˜ï¼Œä½†æ˜¯åœ¨æˆ‘çš„ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œæ¶ˆè€—äº†1åˆ†å¤šçš„æ—¶é—´ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select count(*)\n   from t_jointab t1, t_jointab t2 \n   where t1.a = t2.a and t1.b = t2.b;\n+----------+\n| count(*) |\n+----------+\n|    10000 |\n+----------+\n1 row in set (1 min 19.29 sec)\n</code></pre><p>æŸ¥çœ‹æ…¢æ—¥å¿—å‘ç°ï¼Œè¿™ä¸ªè¯­å¥çš„Rows_examinedæ¯”è¾ƒé«˜ï¼Œæœ‰100å¤šä¸‡ã€‚</p><pre><code class=\"language-plain\"># Query_time: 79.285872  Lock_time: 0.000036 Rows_sent: 1  Rows_examined: 1019000\nSET timestamp=1724921875;\nselect count(*)ã€‚\n   from t_jointab t1, t_jointab t2\n   where t1.a = t2.a and t1.b = t2.b;\n</code></pre><p>è¯·ä½ åˆ†æä¸€ä¸‹ï¼Œè¿™ä¸ªSQLæ‰§è¡Œæ¯”è¾ƒæ…¢çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æœ‰å“ªäº›å¯èƒ½çš„ä¼˜åŒ–æ–¹æ¡ˆï¼ˆå‰ææ˜¯ä¸èƒ½ä¿®æ”¹è¡¨é‡Œçš„æ•°æ®ï¼‰ï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":394868,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1728614840,"is_pvip":false,"replies":[{"id":143380,"content":"è€ƒè™‘å¾—å¾ˆå…¨é¢äº†ã€‚\nè¿™ä¸ªåœºæ™¯ä¸‹ä½¿ç”¨hash joinï¼Œæˆ–è€…å°†ç´¢å¼•idx_a(a)æ”¹æˆç»„åˆç´¢å¼•idx_a(a,b) éƒ½èƒ½å–å¾—ä¸é”™çš„æ•ˆæœã€‚ğŸ‘ğŸ‘\n\nè™½ç„¶è¿™é‡Œçš„ä¾‹å­æ˜¯äººä¸ºæ„é€ çš„ï¼Œä½†æ˜¯æ­£å¼ç¯å¢ƒä¸­æœ‰æ—¶ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ã€‚æœ‰æ—¶ä¹ŸæŠŠè¿™ç§æƒ…å†µç§°ä¸ºâ€œæ•°æ®å€¾æ–œâ€ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728626871,"ip_address":"æµ™æ±Ÿ","comment_id":394868,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è¡¨ t_jointab ä¸­æœ‰ 1 ä¸‡æ¡è®°å½•ï¼Œå‰ 9000 æ¡è®°å½•çš„å­—æ®µ a æ˜¯å”¯ä¸€çš„ï¼Œå 1000 æ¡è®°å½•çš„å­—æ®µ a çš„å€¼éƒ½æ˜¯ 9000\nselect count(*) from t_jointab t1, t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n1. å…ˆå¯¹è¡¨ t1 è¿›è¡Œå…¨è¡¨æ‰«æ\n2. æ‹¿æ­¥éª¤1 ä¸­å¾—åˆ°çš„ a å€¼å†åˆ°è¡¨ t2 çš„ç´¢å¼• idx_a ä¸­å»æ£€ç´¢\n\nå‰ 9000 æ¡æ˜¯å”¯ä¸€çš„ï¼Œå› æ­¤æ‰«æè¡Œæ•° = 9000 + 9000*1\nå 1000 æ¡è®°å½•çš„ a éƒ½ç›¸åŒï¼Œå› æ­¤æ‰«æè¡Œæ•°= 1000 + 1000 * 1000 = 10100\næ€»è¡Œæ•°=18000 + 10100 = 1019000\n\nä¼˜åŒ–æ–¹æ¡ˆ1ï¼šå“ˆå¸Œè¿æ¥ï¼Œåªç”¨æ‰«æ 20000 è¡Œ\nmysql&gt; select count(*) from t_jointab t1 ignore index(idx_a), t_jointab t2 ignore index(idx_a) where t1.a = t2.a and t1.b = t2.b;\n1 row in set (0.01 sec)\n\nä¼˜åŒ–æ–¹æ¡ˆ2ï¼šä¿®æ”¹ç´¢å¼• idx_aï¼Œåœ¨å­—æ®µ a,b ä¸Šå»ºç«‹ä¸€ä¸ªè”åˆç´¢å¼•ï¼Œæ‹¿å­—æ®µ a å’Œ b å»è¢«é©±åŠ¨è¡¨ç´¢å¼•æŸ¥æ‰¾ï¼Œé¿å…æ‰«æé¢å¤–æ•°æ®ä»¥åŠé¿å…å›è¡¨å’Œæ•°æ®è¿‡æ»¤\nalter table t_jointab drop index idx_a, add index idx_a(a,b);\nmysql&gt; select count(*) from t_jointab t1, t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n1 row in set (0.03 sec)","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652291,"discussion_content":"è€ƒè™‘å¾—å¾ˆå…¨é¢äº†ã€‚\nè¿™ä¸ªåœºæ™¯ä¸‹ä½¿ç”¨hash joinï¼Œæˆ–è€…å°†ç´¢å¼•idx_a(a)æ”¹æˆç»„åˆç´¢å¼•idx_a(a,b) éƒ½èƒ½å–å¾—ä¸é”™çš„æ•ˆæœã€‚ğŸ‘ğŸ‘\n\nè™½ç„¶è¿™é‡Œçš„ä¾‹å­æ˜¯äººä¸ºæ„é€ çš„ï¼Œä½†æ˜¯æ­£å¼ç¯å¢ƒä¸­æœ‰æ—¶ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ã€‚æœ‰æ—¶ä¹ŸæŠŠè¿™ç§æƒ…å†µç§°ä¸ºâ€œæ•°æ®å€¾æ–œâ€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728626871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394859,"user_name":"TheOne","can_delete":false,"product_type":"c1","uid":1582134,"ip_address":"åŒ—äº¬","ucode":"2A359780156A8B","user_header":"https://static001.geekbang.org/account/avatar/00/18/24/36/0829cbdc.jpg","comment_is_top":false,"comment_ctime":1728559697,"is_pvip":false,"replies":[{"id":143382,"content":"å…ˆçœ‹ä¸‹SQLçš„æ‰§è¡Œè®¡åˆ’ï¼Œæ˜¯ä¸€ä¸ªåµŒå¥—å¾ªç¯ã€‚\nmysql&gt; explain format=tree  select count(*) from t_jointab t1 , t_jointab t2 where t1.a = t2.a and t1.b = t2.b\\G\n*************************** 1. row ***************************\nEXPLAIN: \n-&gt; Aggregate: count(0)  (cost=4307.55 rows=1)\n    -&gt; Nested loop inner join  (cost=4221.75 rows=858)\n        -&gt; Index scan on t1 using idx_ab  (cost=1218.75 rows=8580)\n        -&gt; Filter: (t2.b = t1.b)  (cost=0.25 rows=0.1)\n            -&gt; Index lookup on t2 using idx_a (a=t1.a)  (cost=0.25 rows=1)\n\nè¿™ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œç”¨ä¼ªä»£è¡¨ç¤ºï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š\ndef get_count():\n    cnt = 0\n    for t1_row in (select * from t_jointab t1):\n        for t2_row in (select * from t_jointab t2 where a = t1_row.a and b = t1_row.b):\n\t        cnt = cnt + 1\n    return cnt\n\nç”±äºt1.a = 9000çš„æ—¶å€™ï¼Œä½¿ç”¨ç´¢å¼•idx_a(a)èƒ½åŒ¹é…åˆ°1000è¡Œæ•°æ®ï¼Œè€Œä¸”æœ‰1000æ¡t1.a = 9000çš„æ•°æ®ï¼Œå› æ­¤å¾ªç¯çš„æ‰§è¡Œæ¬¡æ•°æ¯”è¾ƒå¤šã€‚\n\nå¶æ˜åŒå­¦çš„ç•™è¨€ä¸­ï¼Œç»™å‡ºäº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸¤ç§æœ‰æ•ˆçš„æ–¹æ³•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728628521,"ip_address":"æµ™æ±Ÿ","comment_id":394859,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è€ƒé¢˜ï¼Œæœ‰ç‚¹æƒ³ä¸æ˜ç™½","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652294,"discussion_content":"å…ˆçœ‹ä¸‹SQLçš„æ‰§è¡Œè®¡åˆ’ï¼Œæ˜¯ä¸€ä¸ªåµŒå¥—å¾ªç¯ã€‚\nmysql&gt; explain format=tree  select count(*) from t_jointab t1 , t_jointab t2 where t1.a = t2.a and t1.b = t2.b\\G\n*************************** 1. row ***************************\nEXPLAIN: \n-&gt; Aggregate: count(0)  (cost=4307.55 rows=1)\n    -&gt; Nested loop inner join  (cost=4221.75 rows=858)\n        -&gt; Index scan on t1 using idx_ab  (cost=1218.75 rows=8580)\n        -&gt; Filter: (t2.b = t1.b)  (cost=0.25 rows=0.1)\n            -&gt; Index lookup on t2 using idx_a (a=t1.a)  (cost=0.25 rows=1)\n\nè¿™ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œç”¨ä¼ªä»£è¡¨ç¤ºï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š\ndef get_count():\n    cnt = 0\n    for t1_row in (select * from t_jointab t1):\n        for t2_row in (select * from t_jointab t2 where a = t1_row.a and b = t1_row.b):\n\t        cnt = cnt + 1\n    return cnt\n\nç”±äºt1.a = 9000çš„æ—¶å€™ï¼Œä½¿ç”¨ç´¢å¼•idx_a(a)èƒ½åŒ¹é…åˆ°1000è¡Œæ•°æ®ï¼Œè€Œä¸”æœ‰1000æ¡t1.a = 9000çš„æ•°æ®ï¼Œå› æ­¤å¾ªç¯çš„æ‰§è¡Œæ¬¡æ•°æ¯”è¾ƒå¤šã€‚\n\nå¶æ˜åŒå­¦çš„ç•™è¨€ä¸­ï¼Œç»™å‡ºäº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸¤ç§æœ‰æ•ˆçš„æ–¹æ³•ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1728628522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":1582134,"avatar":"https://static001.geekbang.org/account/avatar/00/18/24/36/0829cbdc.jpg","nickname":"TheOne","note":"","ucode":"2A359780156A8B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":652303,"discussion_content":"é€šä¿—æ˜“æ‡‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728646804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":652294,"ip_address":"åŒ—äº¬","group_id":0},"score":652303,"extra":""}]}]},{"had_liked":false,"id":394869,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1728614965,"is_pvip":false,"replies":[{"id":143381,"content":"æ‰§è¡Œ1åˆ†é’Ÿä¸»è¦æ˜¯å› ä¸ºæˆ‘çš„æµ‹è¯•è™šæœºIOæ€§èƒ½å¤ªå·®äº†ã€‚\n\næ‰§è¡Œè®¡åˆ’æ²¡æœ‰é—®é¢˜ã€‚\nmysql&gt; explain select count(*) from t_jointab t1, t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n+----+-------------+-------+------+---------------+-------+---------+----------+------+\n| id | select_type | table | type | possible_keys | key   | key_len | ref      | rows |\n+----+-------------+-------+------+---------------+-------+---------+----------+------+\n|  1 | SIMPLE      | t1    | ALL  | idx_a         | NULL  | NULL    | NULL     | 8580 |\n|  1 | SIMPLE      | t2    | ref  | idx_a         | idx_a | 4       | rep.t1.a |    1 |\n\n### è™šæœºä¸Šæ‰§è¡Œ 1åˆ†å¤š\nmysql&gt; select count(*) from t_jointab t1, t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n+----------+\n| count(*) |\n+----------+\n|    10000 |\n+----------+\n1 row in set (1 min 30.77 sec)\n\næ¢åˆ°ç¬”è®°æœ¬ä¸Šæ‰§è¡Œä¹Ÿæ˜¯1ç§’å¤šã€‚\n\n### ç¬”è®°æœ¬ä¸Šçš„æ‰§è¡Œæ—¶é—´ 1.14ç§’\nmysql&gt; select count(*) from t_jointab t1 , t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n+----------+\n| count(*) |\n+----------+\n|    10000 |\n+----------+\n1 row in set (1.14 sec)","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728627201,"ip_address":"æµ™æ±Ÿ","comment_id":394869,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œè¿™é‡Œè¦è€ƒè™‘ &lt;sort_key, additional_fields&gt; å—ï¼Ÿå› ä¸ºæˆ‘çœ‹æˆ‘çš„è¯­å¥æ²¡ä½ é‚£ä¹ˆæ…¢ï¼Œ1så·¦å³å°±è¿”å›äº†ï¼Œä½ çš„æŸ¥è¯¢è¦1åˆ†é’Ÿå¤šï¼Œè®©æˆ‘æ€€ç–‘æ˜¯ä¸æ˜¯æ²¡èµ°ç´¢å¼•æŸ¥æ‰¾æˆ–è€…æ‰«æäº† c è¿™ä¸ªå¤§åˆ—ã€‚","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652292,"discussion_content":"æ‰§è¡Œ1åˆ†é’Ÿä¸»è¦æ˜¯å› ä¸ºæˆ‘çš„æµ‹è¯•è™šæœºIOæ€§èƒ½å¤ªå·®äº†ã€‚\n\næ‰§è¡Œè®¡åˆ’æ²¡æœ‰é—®é¢˜ã€‚\nmysql&gt; explain select count(*) from t_jointab t1, t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n+----+-------------+-------+------+---------------+-------+---------+----------+------+\n| id | select_type | table | type | possible_keys | key   | key_len | ref      | rows |\n+----+-------------+-------+------+---------------+-------+---------+----------+------+\n|  1 | SIMPLE      | t1    | ALL  | idx_a         | NULL  | NULL    | NULL     | 8580 |\n|  1 | SIMPLE      | t2    | ref  | idx_a         | idx_a | 4       | rep.t1.a |    1 |\n\n### è™šæœºä¸Šæ‰§è¡Œ 1åˆ†å¤š\nmysql&gt; select count(*) from t_jointab t1, t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n+----------+\n| count(*) |\n+----------+\n|    10000 |\n+----------+\n1 row in set (1 min 30.77 sec)\n\næ¢åˆ°ç¬”è®°æœ¬ä¸Šæ‰§è¡Œä¹Ÿæ˜¯1ç§’å¤šã€‚\n\n### ç¬”è®°æœ¬ä¸Šçš„æ‰§è¡Œæ—¶é—´ 1.14ç§’\nmysql&gt; select count(*) from t_jointab t1 , t_jointab t2 where t1.a = t2.a and t1.b = t2.b;\n+----------+\n| count(*) |\n+----------+\n|    10000 |\n+----------+\n1 row in set (1.14 sec)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728627202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}