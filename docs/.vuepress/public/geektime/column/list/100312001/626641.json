{"id":626641,"title":"25ï½œç”Ÿäº§ç¨³å®šçš„ç§˜å¯†æ­¦å™¨ï¼šå¦‚ä½•å®æ–½é‡‘ä¸é›€å‘å¸ƒï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚</p><p>ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä»€ä¹ˆæ˜¯è“ç»¿å‘å¸ƒä»¥åŠå¦‚ä½•å®æ–½è“ç»¿å‘å¸ƒã€‚è“ç»¿å‘å¸ƒæ˜¯ä¸€ç§é€šè¿‡èµ„æºå†—ä½™æ¥æ¢å–å›æ»šæ•ˆç‡çš„å‘å¸ƒæ–¹å¼ï¼Œç»“åˆ Argo Rollout ï¼Œèƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°å®ç°è‡ªåŠ¨åŒ–çš„æµé‡åˆ‡æ¢ã€‚</p><p>ä½†æ˜¯å®ƒçš„ç¼ºç‚¹ä¹Ÿæ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼šå½“æ–°ç¯å¢ƒå‡†å¤‡å¥½ä¹‹åï¼Œæµé‡å°†è¿›è¡Œå…¨é‡åˆ‡æ¢ï¼Œ<strong>æ— æ³•å¯¹æ–°ç¯å¢ƒè¿›è¡Œå°è§„æ¨¡çš„æµé‡éªŒè¯ã€‚</strong></p><p>ä¸ºäº†æ›´å¥½åœ°äº†è§£æ–°ç¯å¢ƒçš„æ€§èƒ½å’Œæ½œåœ¨çš„é—®é¢˜ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯è®©æ–°çš„ç¯å¢ƒæ¥æ”¶ä¸€å°éƒ¨åˆ†ç”Ÿäº§æµé‡ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šæŠŠä¸€å®šæ¯”ä¾‹çš„ç”Ÿäº§æµé‡è½¬å‘åˆ°æ–°çš„ç¯å¢ƒï¼Œä»¥æ­¤æ¥éªŒè¯æ–°ç¯å¢ƒçš„è¡¨ç°ã€‚è¿™ç§å‘å¸ƒæ–¹å¼å°±å«åš<strong>é‡‘ä¸é›€å‘å¸ƒï¼Œåˆå«åšç°åº¦å‘å¸ƒ</strong>ã€‚</p><blockquote>\n<p>åœ¨çŸ¿ç‰©å¼€é‡‡æ—©æœŸï¼Œç”±äºç¼ºå°‘æœ‰æ¯’æ°”ä½“æ¢æµ‹å™¨ï¼ŒçŸ¿å·¥ä¸‹äº•ä¹‹åçš„æ­»äº¡ç‡éå¸¸é«˜ã€‚åæ¥ï¼Œäººä»¬å‘ç°é‡‘ä¸é›€é¸Ÿå¯¹æœ‰å®³æ°”ä½“éå¸¸æ•æ„Ÿï¼Œäºæ˜¯æŠŠé‡‘ä¸é›€é¸ŸæŠ•å…¥åˆ°çŸ¿äº•ä¸­å……å½“æ¢æµ‹å™¨çš„è§’è‰²ï¼Œä»¥æ­¤æ¥ä¿æŠ¤çŸ¿å·¥ã€‚</p>\n</blockquote><p>æ–°ç¯å¢ƒå°±åƒé‡‘ä¸é›€é¸Ÿï¼Œé¦–å½“å…¶å†²â€œæ¢æµ‹â€ç”Ÿäº§ç¯å¢ƒçš„æ½œåœ¨é—®é¢˜ï¼Œä»¥æ­¤æ¥æå‡å‘å¸ƒçš„å®‰å…¨æ€§ã€‚</p><p>åœ¨è¿™èŠ‚è¯¾ï¼Œæˆ‘ä¼šå…ˆé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä»¥æ‰‹åŠ¨çš„æ–¹å¼æ¥å®æ–½é‡‘ä¸é›€å‘å¸ƒï¼Œç„¶åï¼Œæˆ‘ä¼šç»“åˆ Argo Rollout è¿™æ¬¾å·¥å…·æ¥è¿›ä¸€æ­¥ä»‹ç»å¦‚ä½•è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹ã€‚</p><p>åœ¨å¼€å§‹ä»Šå¤©çš„å­¦ä¹ ä¹‹å‰ï¼Œä½ éœ€è¦å…·å¤‡ä»¥ä¸‹å‰ææ¡ä»¶ã€‚</p><ul>\n<li>æŒ‰ç…§<a href=\"https://time.geekbang.org/column/article/612571\">ç¬¬ 2 è®²</a>çš„å†…å®¹åœ¨æœ¬åœ°é…ç½®å¥½ Kind é›†ç¾¤ï¼Œå®‰è£… Ingress-Nginxï¼Œ<strong>å¹¶æš´éœ² 80 å’Œ 443 ç«¯å£ã€‚</strong></li>\n<li>é…ç½®å¥½ Kubectl ä½¿å…¶èƒ½å¤Ÿè®¿é—® Kind é›†ç¾¤ã€‚</li>\n<li>æŒ‰ç…§<a href=\"https://time.geekbang.org/column/article/625912\">ç¬¬ 24 è®²</a>çš„å†…å®¹å®‰è£…å¥½ Argo Rollout ä»¥åŠ kubectl æ’ä»¶ã€‚</li>\n</ul><!-- [[[read_end]]] --><h2>é‡‘ä¸é›€å‘å¸ƒæ¦‚è¿°</h2><p>ä¸ºäº†æ›´å¥½åœ°å¸®åŠ©ä½ ç†è§£é‡‘ä¸é›€å‘å¸ƒï¼Œåœ¨æ­£å¼è¿›å…¥å®æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹å®ƒçš„æ•´ä½“æ¶æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7e/b2/7e641f508d3dbbeeecbe88a5a82a79b2.jpg?wh=1920x1013\" alt=\"å›¾ç‰‡\"></p><p>åœ¨ä¸Šé¢è¿™å¼ æ¶æ„å›¾ä¸­ï¼Œæˆ‘ä»¬ä¼šå¯¹åŒä¸€ä¸ªåº”ç”¨éƒ¨ç½²ä¸¤å¥—ç¯å¢ƒï¼Œä¸€å¥—æ˜¯ Prod ç”Ÿäº§ç¯å¢ƒï¼Œå¦ä¸€å¥—æ˜¯ Canary é‡‘ä¸é›€ç¯å¢ƒã€‚è¿™ä¸¤å¥—ç¯å¢ƒåˆ†åˆ«ç”±ä¸åŒçš„ Service é€šè¿‡é€‰æ‹©å™¨è¿›è¡Œå…³è”ï¼Œæœ€å¤–å±‚é€šè¿‡ Ingress-Nginx ç½‘å…³å°†æµé‡æŒ‰ä¸åŒçš„æ¯”ä¾‹è½¬å‘åˆ° Service å½“ä¸­ã€‚æ¯”å¦‚ï¼Œå›¾ä¸­ 20% çš„æµé‡å°†ä¼šè½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒï¼Œ80% çš„æµé‡ä¼šè½¬å‘åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸€ç§æµé‡è´Ÿè½½å‡è¡¡çš„ç®—æ³•ã€‚</p><p>é™¤äº†ä»¥ä¸åŒæ¯”ä¾‹åˆ†å‘æµé‡ä»¥å¤–ï¼Œé‡‘ä¸é›€å‘å¸ƒè¿˜å¯ä»¥é€šè¿‡ç‰¹å®šçš„ Header æ¥è¿›è¡Œè¯†åˆ«å’Œåˆ†å‘æµé‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3e/c0/3eba0f6eaayy0e43d097ef19348c30c0.jpg?wh=1920x1020\" alt=\"å›¾ç‰‡\"></p><p>æ­£å¦‚ä¸Šé¢çš„å›¾æ‰€ç¤ºï¼Œå¸¸è§„æµé‡å°†ä»ç„¶è®¿é—®ç”Ÿäº§ç¯å¢ƒï¼Œè€Œè¯·æ±‚å¤´ä¸­å¸¦æœ‰ X-Canary çš„è¯·æ±‚å°†ä¼šè¢«è½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒï¼Œä»¥æ­¤å°†æµé‡è¿›è¡ŒåŒºåˆ†ã€‚</p><p>è¿™ä¸¤ç§æ–¹å¼åœ¨å‘å¸ƒè¿‡ç¨‹ä¸­å…·æœ‰æå¼ºçš„çµæ´»æ€§ï¼Œç¬¬ä¸€ç§ä»¥ä¸åŒæ¯”ä¾‹åˆ†å‘æµé‡çš„æ–¹å¼å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œç°åº¦éªŒè¯ï¼Œé¿å…å¤§è§„æ¨¡æ•…éšœã€‚ç¬¬äºŒç§è¯†åˆ«ç‰¹å®šè¯·æ±‚çš„æ–¹å¼åˆ™æ›´åŠ ç²¾å‡†ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ§åˆ¶è®©ä»€ä¹ˆç±»å‹çš„ç”¨æˆ·è®¿é—®é‡‘ä¸é›€ç¯å¢ƒï¼Œä¾‹å¦‚å¯¹ä¸åŒåœ°åŸŸã€ä¸åŒæ€§åˆ«ã€å¹´é¾„çš„ç”¨æˆ·è¿›è¡Œé‡‘ä¸é›€å®éªŒã€‚</p><h2>é‡‘ä¸é›€å®æˆ˜</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥é‡‘ä¸é›€å‘å¸ƒçš„å®æˆ˜ç¯èŠ‚ã€‚æˆ‘ä¼šé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ Kubernetes åŸç”Ÿçš„ Deployment å’Œ Service æ¥è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒï¼Œå®æˆ˜è¿‡ç¨‹ä¸»è¦åŒ…å«ä¸‹é¢å‡ ä¸ªæ­¥éª¤ã€‚</p><ol>\n<li>åˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„ Deployment å’Œ Serviceã€‚</li>\n<li>åˆ›å»ºç”Ÿäº§ç¯å¢ƒ Ingress ç­–ç•¥ï¼Œå¹¶æŒ‡å‘ç”Ÿäº§ç¯å¢ƒçš„ Serviceã€‚</li>\n<li>è®¿é—®ç”Ÿäº§ç¯å¢ƒã€‚</li>\n<li>åˆ›å»ºé‡‘ä¸é›€ç¯å¢ƒçš„ Deployment å’Œ Serviceã€‚</li>\n<li>åˆ›å»ºé‡‘ä¸é›€ç¯å¢ƒ Ingress ç­–ç•¥ï¼Œå¹¶å®ç°æŒ‰æ¯”ä¾‹åˆ†å‘å’Œè¯†åˆ«ç‰¹æ®Šæµé‡åˆ†å‘ã€‚</li>\n<li>è®¿é—®ç”Ÿäº§ç¯å¢ƒã€‚</li>\n</ol><h3>åˆ›å»ºç”Ÿäº§ç¯å¢ƒ</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºç”Ÿäº§ç¯å¢ƒã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º prod_deployment.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: prod\n  labels:\n    app: prod\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: prod\n  template:\n    metadata:\n      labels:\n        app: prod\n    spec:\n      containers:\n      - name: demo\n        image: argoproj/rollouts-demo:blue\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: prod-service\n  labels:\n    app: prod\nspec:\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8080\n  selector:\n    app: prod\n  type: ClusterIP\n</code></pre><p>åœ¨ä¸Šé¢è¿™æ®µ Manifest ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† argoproj/rollouts-demo:blue é•œåƒæ¥æ¨¡æ‹Ÿåˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„ Deployment å·¥ä½œè´Ÿè½½ï¼Œå¹¶ä¸”åˆ›å»ºäº†åä¸º prod-service çš„ Service å¯¹è±¡ï¼ŒåŒæ—¶é€šè¿‡ Service é€‰æ‹©å™¨å°† Service å’Œ Pod è¿›è¡Œäº†å…³è”ã€‚</p><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å‘½ä»¤å°†ç¤ºä¾‹åº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f prod_deployment.yaml\ndeployment.apps/prod created\nservice/prod-service created\n</code></pre><p>éƒ¨ç½²å®Œæˆåï¼Œç­‰å¾…å·¥ä½œè´Ÿè½½ Readyã€‚</p><pre><code class=\"language-yaml\">$ kubectl wait pods -l app=prod --for condition=Ready --timeout=90s\npod/prod-96bc479bb-mxj6v condition met\n</code></pre><p>å½“çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºåï¼Œä»£è¡¨ç”Ÿäº§ç¯å¢ƒå·²ç»å‡†å¤‡å¥½äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå†åˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„ Ingress ç­–ç•¥ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º prod_ingress.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: prod-ingress\nspec:\n  rules:\n  - host: \"canary.demo\"\n    http:\n      paths:\n      - pathType: Prefix\n        path: \"/\"\n        backend:\n          service:\n            name: prod-service\n            port:\n              number: 80\n</code></pre><p>ç„¶åï¼Œé€šè¿‡ kubectl apply å°†å…¶åº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f blue_ingress.yaml&nbsp; &nbsp;\ningress.networking.k8s.io/prod-ingress created\n</code></pre><p>åœ¨ä¸Šé¢åˆ›å»ºçš„ Ingres ç­–ç•¥ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº† canary.demo ä½œä¸ºè®¿é—®åŸŸåã€‚æ‰€ä»¥ï¼Œåœ¨è®¿é—®ç”Ÿäº§ç¯å¢ƒä¹‹å‰ï¼Œä½ éœ€è¦å…ˆåœ¨æœ¬åœ°é…ç½® Hosts æ‰èƒ½è®¿é—®ã€‚</p><pre><code class=\"language-yaml\">127.0.0.1 canary.demo\n</code></pre><h3>è®¿é—®ç”Ÿäº§ç¯å¢ƒ</h3><p>é…ç½®å®Œ Hosts ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è®¿é—®ç”Ÿäº§ç¯å¢ƒäº†ã€‚ä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://canary.demo\">http://canary.demo</a>ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°åƒä¸‹é¢æˆªå›¾çš„é¡µé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/38/4a/386403474a8c3ce608a8fe0fc182894a.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>åœ¨è¿™ä¸ªé¡µé¢é‡Œï¼Œæµè§ˆå™¨æ¯ç§’é’Ÿä¼šå‘åç«¯å‘å‡º 50 ä¸ªè¯·æ±‚ï¼Œè“è‰²çš„æ–¹å—ä»£è¡¨åç«¯è¿”å›æ¥å£çš„å†…å®¹ä¸º blueï¼Œå¯¹åº”çš„æ˜¯ argoproj/rollouts-demo:blue ç‰ˆæœ¬çš„é•œåƒï¼Œç”¨æ¥æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒã€‚</p><h3>éƒ¨ç½²é‡‘ä¸é›€ç¯å¢ƒ</h3><p>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦ä»¥é‡‘ä¸é›€å‘å¸ƒçš„æ–¹å¼æ¥æ›´æ–°ç¯å¢ƒï¼Œé¦–å…ˆéœ€è¦å…ˆåˆ›å»ºé‡‘ä¸é›€ç¯å¢ƒã€‚ä½ å¯ä»¥å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º canary_deployment.yamlã€‚</p><pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: canary\n  labels:\n    app: canary\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: canary\n  template:\n    metadata:\n      labels:\n        app: canary\n    spec:\n      containers:\n      - name: demo\n        image: argoproj/rollouts-demo:green\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: canary-service\n  labels:\n    app: canary\nspec:\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8080\n  selector:\n    app: canary\n  type: ClusterIP\n</code></pre><p>åœ¨è¿™æ®µ Manifest ä¸­ï¼Œæˆ‘ä»¬ç”¨ argoproj/rollouts-demo:green é•œåƒæ¥æ¨¡æ‹Ÿåˆ›å»ºé‡‘ä¸é›€ç¯å¢ƒçš„ Deploymentï¼Œå¹¶ä¸”åˆ›å»ºäº†åä¸º canary-service çš„ Service å¯¹è±¡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ kubectl apply å°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary_deployment.yaml\ndeployment.apps/canary created\nservice/canary-service created\n</code></pre><p>éƒ¨ç½²å®Œæˆåï¼Œç­‰å¾…å·¥ä½œè´Ÿè½½ Readyã€‚</p><pre><code class=\"language-yaml\">$ kubectl wait pods -l app=canary --for condition=Ready --timeout=90s\npod/canary-579d4b57d6-fpg29 condition met\n</code></pre><p>å½“çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºåï¼Œä»£è¡¨é‡‘ä¸é›€ç¯å¢ƒå·²ç»å‡†å¤‡å¥½äº†ã€‚</p><h3>é…ç½®é‡‘ä¸é›€ç­–ç•¥</h3><p>ç°åœ¨ï¼Œç”Ÿäº§ç¯å¢ƒå’Œé‡‘ä¸é›€ç¯å¢ƒéƒ½å·²ç»å‡†å¤‡å¥½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦é…ç½®é‡‘ä¸é›€ç¯å¢ƒçš„ Ingress ç­–ç•¥ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º canary_ingress.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: canary-ingress-canary\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"20\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"X-Canary\"\nspec:\n  rules:\n  - host: \"canary.demo\"\n    http:\n      paths:\n      - pathType: Prefix\n        path: \"/\"\n        backend:\n          service:\n            name: canary-service\n            port:\n              number: 80\n</code></pre><p>ç›¸æ¯”è¾ƒç”Ÿäº§ç¯å¢ƒçš„ Ingress ç­–ç•¥ï¼Œè¿™æ®µé‡‘ä¸é›€ç¯å¢ƒçš„ Ingress ç­–ç•¥åœ¨ metadata.annotations å­—æ®µä¸Šæœ‰æ˜æ˜¾çš„å·®å¼‚ï¼Œä¸‹é¢æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ã€‚</p><p>nginx.ingress.kubernetes.io/canary å­—æ®µçš„å€¼ä¸º trueï¼Œè¡¨ç¤ºå¯ç”¨é‡‘ä¸é›€å‘å¸ƒç­–ç•¥ã€‚</p><p>nginx.ingress.kubernetes.io/canary-weight å­—æ®µçš„å€¼ä¸º 20ï¼Œè¡¨ç¤ºå°† 20% çš„æµé‡è½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒå½“ä¸­ï¼Œå®é™…ä¸Šè¿™æ˜¯è´Ÿè½½å‡è¡¡çš„åŠ æƒè½®è¯¢æœºåˆ¶ã€‚</p><p>nginx.ingress.kubernetes.io/canary-by-header å­—æ®µçš„å€¼ä¸º X-Canaryï¼Œä»£è¡¨å½“ Header ä¸­åŒ…å« X-Canary æ—¶ï¼Œåˆ™æ— è§†æµé‡æ¯”ä¾‹è§„åˆ™ï¼Œå°†è¯·æ±‚ç›´æ¥è½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒä¸­ã€‚</p><p>æ‰€ä»¥ï¼Œä¸Šé¢çš„ Ingress ç­–ç•¥å®é™…ä¸ŠåŒæ—¶é…ç½®äº†<strong>åŸºäºè¯·æ±‚æµé‡æ¯”ä¾‹ä»¥åŠè¯·æ±‚å¤´çš„é‡‘ä¸é›€ç­–ç•¥ã€‚</strong></p><p>ç°åœ¨ï¼Œå°†é‡‘ä¸é›€ç¯å¢ƒçš„ Ingress ç­–ç•¥åº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary_ingress.yaml\ningress.networking.k8s.io/canary-ingress-canary created\n</code></pre><p>é‡æ–°è¿”å›æµè§ˆå™¨ï¼Œä½ å°†ä¼šçœ‹åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆè“è‰²æ–¹å—ï¼‰å’Œé‡‘ä¸é›€ç¯å¢ƒï¼ˆç»¿è‰²æ–¹å—ï¼‰çš„æµé‡æ¯”ä¾‹å°†æŒ‰ç…§é…ç½®çš„<strong>4:1</strong>æ¥åˆ†å¸ƒï¼Œå¦‚ä¸‹å›¾å³ä¸‹è§’æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/99/65/99f7b2d03fb303a787580913d8e61165.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>ç°åœ¨ï¼Œä½ åªéœ€è¦è°ƒæ•´é‡‘ä¸é›€ç¯å¢ƒçš„ Ingress ç­–ç•¥ï¼Œåˆ†æ¬¡æå‡ canary-weight çš„å€¼ç›´åˆ° 100%ï¼Œä¹Ÿå°±å®ç°äº†ä¸€æ¬¡å®Œæ•´çš„é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹ã€‚</p><h2>é‡‘ä¸é›€å‘å¸ƒè‡ªåŠ¨åŒ–</h2><p>ä¸Šé¢æåˆ°æ‰‹åŠ¨é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬é™¤äº†éœ€è¦æ‰‹åŠ¨åˆ›å»ºç”Ÿäº§å’Œé‡‘ä¸é›€ä¸¤ä¸ªç¯å¢ƒä»¥å¤–ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨é…ç½® Ingress ç­–ç•¥ï¼Œå¦‚æœæƒ³è¦è°ƒæ•´é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹ï¼Œé‚£ä¹ˆå°±éœ€è¦å¤šæ¬¡ä¿®æ”¹ Ingress ç­–ç•¥ã€‚è¿™ç§å‘å¸ƒæ–¹å¼æ•ˆç‡å¾ˆä½ï¼Œå¹¶ä¸”æœ€åå°†é‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºç”Ÿäº§ç¯å¢ƒæ—¶ä¹Ÿéœ€è¦æ‰‹åŠ¨å¤„ç†ã€‚</p><p>ä½†æ˜¯å€ŸåŠ© Argo Rollout çš„è‡ªåŠ¨é‡‘ä¸é›€å‘å¸ƒåŠŸèƒ½ï¼Œå°±èƒ½å¾ˆå¥½åœ°è§£å†³è¿™äº›é—®é¢˜ã€‚</p><p>åœ¨ä½¿ç”¨ Argo Rollout ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆåœ¨é›†ç¾¤é‡Œå®‰è£…å®ƒï¼Œå¹¶åœ¨æœ¬åœ°å®‰è£…å¥½ Argo Rollout kubectl æ’ä»¶ï¼Œå…·ä½“æµç¨‹ä½ å¯ä»¥å‚è€ƒç¬¬ 24 è®²çš„å†…å®¹ã€‚</p><h3>åˆ›å»º Rollout å¯¹è±¡</h3><p>ä¸ºäº†å®ç°è‡ªåŠ¨åŒ–çš„é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° Rollout å¯¹è±¡ã€‚å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨ç®¡ç†é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„ ReplicaSetã€Service å’Œ Ingress å¯¹è±¡ã€‚</p><p>é¦–å…ˆï¼Œä½ éœ€è¦å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º canary-rollout.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: canary-demo\n  labels:\n    app: canary-demo\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: canary-demo\n  template:\n    metadata:\n      labels:\n        app: canary-demo\n    spec:\n      containers:\n      - name: canary-demo\n        image: argoproj/rollouts-demo:blue\n        imagePullPolicy: Always\n        ports:\n        - name: http\n          containerPort: 8080\n          protocol: TCP\n        resources:\n          requests:\n            memory: 32Mi\n            cpu: 5m\n  strategy:\n    canary:\n      canaryService: canary-demo-canary\n      stableService: canary-demo\n      canaryMetadata:\n        labels:\n          deployment: canary\n      stableMetadata:\n        labels:\n          deployment: stable\n      trafficRouting:\n        nginx:\n          stableIngress: canary-demo\n          additionalIngressAnnotations:\n            canary-by-header: X-Canary\n      steps:\n        - setWeight: 20\n        - pause: {}\n        - setWeight: 50\n        - pause:\n            duration: 30s\n        - setWeight: 70\n        - pause:\n            duration: 30s\n</code></pre><p>ç„¶åï¼Œå°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary-rollout.yaml&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\nrollout.argoproj.io/canary-demo created\n</code></pre><p>åœ¨ä¸Šé¢è¿™æ®µ Rollout å¯¹è±¡ä¸­ï¼Œspec.template å­—æ®µå’Œ Deployment å·¥ä½œè´Ÿè½½çš„å­—æ®µå®šä¹‰æ˜¯ä¸€è‡´çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº† argoproj/rollouts-demo:blue é•œåƒæ¥åˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„å·¥ä½œè´Ÿè½½ï¼Œå¹¶å®šä¹‰äº† strategy.canary å­—æ®µï¼Œå®ƒä»£è¡¨ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒçš„ç­–ç•¥ã€‚å…¶ä»–çš„å­—æ®µæˆ‘ä¹Ÿç®€å•ä»‹ç»ä¸€ä¸‹ã€‚</p><p>canaryService è¡¨ç¤ºé‡‘ä¸é›€ Service çš„åç§°ï¼Œæˆ‘ä»¬ä¼šåœ¨ç¨ååˆ›å»ºå®ƒã€‚</p><p>stableService è¡¨ç¤ºç”Ÿäº§ç¯å¢ƒ Service çš„åç§°ï¼ŒåŒæ ·ä¹Ÿéœ€è¦åœ¨ç¨ååˆ›å»ºã€‚</p><p>canaryMetadata å’Œ stableMetadata å­—æ®µè¡¨ç¤ºåœ¨é‡‘ä¸é›€å‘å¸ƒæ—¶ï¼Œä¼šå°†é¢å¤–çš„æ ‡ç­¾å¢åŠ åˆ° Pod ä¸­ï¼Œå®ƒå¯ä»¥åŒºåˆ†ä¸åŒç¯å¢ƒçš„ Podã€‚</p><p>trafficRouting.nginx å­—æ®µè¡¨ç¤ºä½¿ç”¨ Ingress-Nginx æ¥ç®¡ç†æµé‡ï¼ŒåŒæ—¶ï¼ŒtrafficRouting.nginx.stableIngress å­—æ®µç”¨æ¥æŒ‡å®š Ingress åç§°ï¼Œè¿™ä¸ª Ingress éœ€è¦æˆ‘ä»¬æå‰åˆ›å»ºã€‚</p><p>trafficRouting.nginx.additionalIngressAnnotations å­—æ®µç”¨æ¥é…ç½®ç‰¹å®šçš„<strong>é‡‘ä¸é›€æµé‡è¯†åˆ«ç­–ç•¥</strong>ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯å½“è¯·æ±‚å¤´å‡ºç° X-Canary æ—¶ï¼Œå°±å°†æµé‡è½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒä¸­ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹é‡è¦çš„é…ç½®ï¼šcanary.stepsï¼Œ<strong>å®ƒæ˜¯ç”¨æ¥æè¿°å¦‚ä½•è¿›è¡Œè‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒ</strong>ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè‡ªåŠ¨åŒ–é‡‘ä¸é›€çš„é…ç½®å¦‚ä¸‹ã€‚</p><ol>\n<li>å°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹é…ç½®ä¸º 20%ã€‚</li>\n<li>æš‚åœé‡‘ä¸é›€å‘å¸ƒï¼Œç›´åˆ°æ‰‹åŠ¨æ‰¹å‡†ã€‚</li>\n<li>å°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹é…ç½®ä¸º 50%ï¼Œå¹¶æŒç»­ 30 ç§’ã€‚</li>\n<li>å°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹é…ç½®ä¸º 70%ï¼Œå¹¶æŒç»­ 30 ç§’ã€‚</li>\n<li>å®Œæˆé‡‘ä¸é›€å‘å¸ƒï¼Œæ­¤æ—¶é‡‘ä¸é›€ç¯å¢ƒæˆä¸ºæ–°çš„ç”Ÿäº§ç¯å¢ƒï¼Œå¹¶æ¥æ”¶æ‰€æœ‰çš„ç”Ÿäº§æµé‡ã€‚</li>\n</ol><h3>åˆ›å»º Service å’Œ Ingress å¯¹è±¡</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»º Service å’Œ Ingress å¯¹è±¡ã€‚é¦–å…ˆåˆ›å»ºç”¨äºç”Ÿäº§ç¯å¢ƒçš„ canary-demo å’Œé‡‘ä¸é›€ç¯å¢ƒçš„ canary-demo-canary Service å¯¹è±¡ï¼Œå°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º canary-demo-service.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: canary-demo\n  labels: \n    app: canary-demo\nspec:\n  ports:\n  - port: 80\n    targetPort: http\n    protocol: TCP\n    name: http\n  selector:\n    app: canary-demo\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: canary-demo-canary\n  labels: \n    app: canary-demo\nspec:\n  ports:\n  - port: 80\n    targetPort: http\n    protocol: TCP\n    name: http\n  selector:\n    app: canary-demo\n</code></pre><p>ç„¶åï¼Œå°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary-demo-service.yaml&nbsp;\nservice/canary-demo created\nservice/canary-demo-canary created\n</code></pre><p>æœ€åï¼Œåˆ›å»º Ingress å¯¹è±¡ã€‚å°†ä¸‹é¢å†…å®¹ä¿å­˜ä¸º canary-demo-ingress.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: canary-demo\n  labels:\n    app: canary-demo\n  annotations:\n    kubernetes.io/ingress.class: nginx\nspec:\n  rules:\n    - host: canary.auto\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: canary-demo\n                port:\n                  name: http\n</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠ canary.auto ä½œä¸ºç”Ÿäº§ç¯å¢ƒå’Œé‡‘ä¸é›€ç¯å¢ƒçš„åŸŸåï¼Œå¹¶ä¸”å°†åç«¯ Service é…ç½®ä¸º canary-demoã€‚</p><p>ä½¿ç”¨ kubectl apply å‘½ä»¤å°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary-demo-ingress.yaml&nbsp;\ningress.networking.k8s.io/canary-demo created\n</code></pre><p>åŒæ ·åœ°ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—® canary.auto åŸŸåï¼Œä½ è¿˜éœ€è¦æ·»åŠ  Hosts ç­–ç•¥ã€‚</p><pre><code class=\"language-yaml\">127.0.0.1 canary.auto\n</code></pre><h3>è®¿é—®ç”Ÿäº§ç¯å¢ƒ</h3><p>é…ç½®å¥½ Hosts ä¹‹åï¼Œå°±å¯ä»¥è®¿é—®ç”Ÿäº§ç¯å¢ƒäº†ã€‚ä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://canary.auto\">http://canary.auto</a>ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°å’Œæ‰‹åŠ¨éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒä¸€æ ·çš„ç•Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6b/a3/6b715e2ce61b345e6980a4a431554aa3.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><h3>é‡‘ä¸é›€å‘å¸ƒè‡ªåŠ¨åŒ–</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»åˆ›å»ºå¥½äº†ç”Ÿäº§ç¯å¢ƒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­è¿›è¡Œè‡ªåŠ¨åŒ–çš„é‡‘ä¸é›€å‘å¸ƒã€‚</p><p>å‡è®¾æˆ‘ä»¬éœ€è¦æ›´æ–°ç”Ÿäº§ç¯å¢ƒï¼Œå¹¶éœ€è¦å°†ç”Ÿäº§ç¯å¢ƒçš„ argoproj/rollouts-demo:blue é•œåƒæ›´æ–°ä¸º argoproj/rollouts-demo:green é•œåƒã€‚æ­¤æ—¶ï¼Œä½ åªéœ€è¦ä¿®æ”¹ Rollout å¯¹è±¡çš„ image å­—æ®µï¼Œå°† blue ä¿®æ”¹ä¸º green å³å¯ã€‚</p><pre><code class=\"language-yaml\">containers:\n- name: canary-demo\n&nbsp; image: argoproj/rollouts-demo:green\n</code></pre><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å°† Rollout å¯¹è±¡é‡æ–°åº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary-rollout.yaml&nbsp; &nbsp; &nbsp;\nrollout.argoproj.io/canary-demo configured\n</code></pre><p>ç°åœ¨ï¼Œè¿”å›æµè§ˆå™¨ï¼Œç­‰å¾…åå‡ ç§’åï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ä»£è¡¨é‡‘ä¸é›€ç¯å¢ƒçš„ç»¿è‰²æ–¹å—å¼€å§‹å‡ºç°ï¼Œå¹¶å¤§è‡´å åˆ°æ€»è¯·æ±‚æ•°çš„ 20%ï¼Œå¦‚ä¸‹å›¾å³ä¸‹è§’æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/50/2d/50881d27c0536b708264c52c25b5c72d.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨ Rollout å¯¹è±¡ä¸­è¿˜é…ç½®äº† canary-by-header å‚æ•°ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä½¿ç”¨ç‰¹å®šçš„ Header è¯·æ±‚æ—¶ï¼Œæµé‡å°†è¢«è½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ curl æ¥éªŒè¯ã€‚</p><pre><code class=\"language-yaml\">$ for i in `seq 1 10`; do curl -H \"X-Canary: always\" http://canary.auto/color; done\n\"green\"\"green\"\"green\"\"green\"\"green\"\"green\"\"green\"\"green\"\"green\"\"green\"\n</code></pre><p>ä»ä¸Šé¢çš„è¯·æ±‚å‘½ä»¤æˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“ Header ä¸­æºå¸¦äº† X-Canary: always ä¹‹åï¼Œå°†è¿”å› green å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯é‡‘ä¸é›€ç¯å¢ƒçš„ green é•œåƒã€‚</p><p>åˆ°è¿™é‡Œï¼Œè‡ªåŠ¨é‡‘ä¸é›€å‘å¸ƒçš„ç¬¬ä¸€é˜¶æ®µå°±å·²ç»å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»“åˆ Argo Rollout Dashboardï¼Œç»§ç»­è¿›è¡Œè‡ªåŠ¨é‡‘ä¸é›€å‘å¸ƒå‰©ä¸‹çš„é˜¶æ®µã€‚</p><h3>è®¿é—® Argo Rollout Dashboard</h3><p>è¦è®¿é—® Argo Rollout Dashboardï¼Œä½ éœ€è¦å…ˆå®‰è£… Argo Rollout kubectl æ’ä»¶ï¼Œå…·ä½“æµç¨‹ä½ å¯ä»¥å‚è€ƒç¬¬ 24 è®²çš„å†…å®¹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubectl argo rollouts dashboard æ¥å¯ç”¨ Dashboardã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts dashboard\nINFO[0000] Argo Rollouts Dashboard is now available at http://localhost:3100/rollouts\n</code></pre><p>ç„¶åï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://localhost:3100/rollouts\">http://localhost:3100/rollouts</a>ï¼Œæ‰“å¼€ Dashboardã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/17/14/17f9be6a94f9ecb7a76e5d59fd9f6614.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥ï¼Œç‚¹å‡»å¡ç‰‡è¿›å…¥ canary-demo è¯¦æƒ…ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°†çœ‹åˆ°é‡‘ä¸é›€å‘å¸ƒçš„å®Œæ•´æ­¥éª¤ä»¥åŠå½“å‰æ‰€å¤„çš„é˜¶æ®µã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c8/7a/c8987f23142675f5183yy7e38deff17a.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>ä»ä¸Šé¢çš„æˆªå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œé‡‘ä¸é›€å‘å¸ƒä¸€å…±æœ‰ 6 ä¸ªé˜¶æ®µï¼Œå½“å‰å¤„äºç¬¬äºŒä¸ªæš‚åœé˜¶æ®µï¼Œè¿™å’Œæˆ‘ä»¬åœ¨ Rollout é‡Œçš„å®šä¹‰æ˜¯ä¸€è‡´çš„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨æ‰¹å‡†çš„æ–¹å¼è®©é‡‘ä¸é›€å‘å¸ƒè¿›å…¥ä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚ä½ å¯ä»¥ä½¿ç”¨ kubectl argo rollouts promote å‘½ä»¤æ¥è®©é‡‘ä¸é›€å‘å¸ƒç»§ç»­è¿è¡Œã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts promote canary-demo\nrollout 'canary-demo' promoted\n</code></pre><p>ä¹‹åï¼Œé‡‘ä¸é›€å‘å¸ƒå°†ä¼šæŒ‰ç…§æˆ‘ä»¬é¢„å®šçš„æ­¥éª¤è¿è¡Œã€‚<strong>é¦–å…ˆå°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹è®¾ç½®ä¸º 50%ï¼Œåœç•™ 30 ç§’ï¼Œç„¶åå°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹è®¾ç½®ä¸º 70%ï¼Œå†åœç•™ 30 ç§’ï¼Œæœ€åå°†é‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºç”Ÿäº§ç¯å¢ƒã€‚</strong>å½“é‡‘ä¸é›€å‘å¸ƒå®Œæˆä¹‹åï¼ŒArgo Rollout å°†åŒæ—¶è‡ªåŠ¨å¯¹è€çš„ç¯å¢ƒè¿›è¡Œç¼©å®¹æ“ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/33/20/3311a34841b40b809e93c8cda60b6b20.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œä¸€æ¬¡å®Œæ•´çš„è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒå°±å·²ç»å®Œæˆäº†ã€‚</p><h2>è‡ªåŠ¨åŒ–åŸç†</h2><p>Argo Rollout å®é™…ä¸Šæ˜¯åœ¨ä¸åŒçš„é‡‘ä¸é›€å‘å¸ƒé˜¶æ®µï¼Œé€šè¿‡ä¿®æ”¹ ReplicaSetã€Service å’Œ Ingress å¯¹è±¡æ¥å®ç°è‡ªåŠ¨åŒ–çš„ã€‚</p><p>åœ¨åˆšå¼€å§‹åˆ›å»ºç”Ÿäº§ç¯å¢ƒæ—¶ï¼ŒIngressã€Service å’Œ Rollout å¯¹è±¡çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9b/6d/9ba1b45e21ccb889df1ab755e5564a6d.jpg?wh=1920x531\" alt=\"å›¾ç‰‡\"></p><p>ä¸Šé¢çš„è¿™æ¡æµé‡é“¾è·¯æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆï¼Œæœ€å¤–å±‚ Ingress åœ¨æ¥æ”¶åˆ°æµé‡åä¼šå°†å…¶è½¬å‘åˆ°ç”Ÿäº§ç¯å¢ƒçš„ Serviceï¼ŒService åˆé€šè¿‡é€‰æ‹©å™¨æ¥åŒ¹é…è¢« Rollout å¯¹è±¡ç®¡ç†çš„ Podã€‚</p><p>å½“æˆ‘ä»¬ä¿®æ”¹äº† Rollout çš„é•œåƒç‰ˆæœ¬å¹¶è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒæ—¶ï¼ŒRollout å¯¹è±¡ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é‡‘ä¸é›€ç¯å¢ƒçš„ ReplicaSet å¯¹è±¡ï¼Œå¹¶ä¿®æ”¹ Service çš„æ ‡ç­¾é€‰æ‹©å™¨æ¥åŒ¹é…åˆ°é‡‘ä¸é›€ç¯å¢ƒçš„ Podã€‚ç„¶åï¼Œå†ç”Ÿæˆä¸€ä¸ªé¢å¤–çš„ Ingress å¯¹è±¡æ¥åŒ¹é…éœ€è¦è½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡ï¼ŒåŒ…æ‹¬æŒ‰æƒé‡ä»¥åŠåŒ¹é… Header çš„è§„åˆ™ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b9/58/b9567193e35f83ae7f0f723746d47e58.jpg?wh=1920x839\" alt=\"å›¾ç‰‡\"></p><p>å½“å¤„äºä¸åŒçš„é‡‘ä¸é›€é˜¶æ®µæ—¶ï¼ŒArgo Rollout ä¼šè‡ªåŠ¨ä¿®æ”¹ Ingress å¯¹è±¡çš„ nginx.ingress.kubernetes.io/canary-weight æ³¨è§£çš„å€¼ï¼Œä»¥æ­¤æ¥æ§åˆ¶ä¸åŒæ¯”ä¾‹çš„æµé‡è¿›å…¥é‡‘ä¸é›€ç¯å¢ƒã€‚</p><p>æœ€åï¼Œå½“é‡‘ä¸é›€å‘å¸ƒçš„æ‰€æœ‰é˜¶æ®µéƒ½å®Œæˆä¹‹åï¼ŒArgo Rollout è¿˜ä¼šè‡ªåŠ¨å°†é‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºç”Ÿäº§ç¯å¢ƒã€‚å…·ä½“çš„åšæ³•æ˜¯ï¼Œä¿®æ”¹é‡‘ä¸é›€ç¯å¢ƒçš„ Ingress ç­–ç•¥ï¼Œå°† nginx.ingress.kubernetes.io/canary-weight æ³¨è§£çš„å€¼ä¿®æ”¹ä¸º 0ï¼ŒåŒæ—¶å°†æ—§ç”Ÿäº§ç¯å¢ƒçš„ Service çš„é€‰æ‹©å™¨ä¿®æ”¹ä¸ºåŒ¹é…é‡‘ä¸é›€ç¯å¢ƒçš„ Podï¼Œæœ€åå†å°†æ—§çš„ç”Ÿäº§ç¯å¢ƒçš„ ReplicaSet ç¼©å®¹ä¸º 0ï¼Œè¾¾åˆ°å°†é‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºç”Ÿäº§ç¯å¢ƒçš„ç›®çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/23/12/238b354dccb56fab627aff5b5955d812.jpg?wh=1920x882\" alt=\"å›¾ç‰‡\"></p><h2>æ€»ç»“</h2><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä¸ºä½ ä»‹ç»äº†ä»€ä¹ˆæ˜¯é‡‘ä¸é›€å‘å¸ƒä»¥åŠå¦‚ä½•é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼æ¥å®è·µå®ƒã€‚å®ƒå’Œè“ç»¿å‘å¸ƒæœ‰ä¸€ç‚¹ç±»ä¼¼ï¼Œæ¯”å¦‚åœ¨å‘å¸ƒè¿‡ç¨‹éƒ½éœ€è¦åŒæ—¶éƒ¨ç½²ä¸¤å¥—ç¯å¢ƒã€‚ä¸åŒçš„æ˜¯ï¼Œé‡‘ä¸é›€å‘å¸ƒçš„æ ¸å¿ƒæ˜¯é€šè¿‡ä¸º Ingress-Nginx æ·»åŠ æ³¨è§£æ¥å®ç°çš„ã€‚</p><p>åœ¨é‡‘ä¸é›€å‘å¸ƒçš„è¿‡ç¨‹ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç§æµé‡åˆ†å‘æ–¹å¼ã€‚ç¬¬ä¸€ç§æ˜¯é€šè¿‡æµé‡çš„æ¯”ä¾‹è¿›è¡Œåˆ†å‘ï¼Œç¬¬äºŒç§æ˜¯é€šè¿‡ç‰¹å®šçš„ Header æ¥è¯†åˆ«ã€‚</p><p>ä»¥æ‰‹åŠ¨çš„æ–¹å¼æ¥å®æ–½é‡‘ä¸é›€éƒ¨ç½²æ¯”è¾ƒç¹çï¼Œå¹¶ä¸”æ•ˆç‡ä½ä¸‹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜ä»‹ç»äº†å¦‚ä½•é€šè¿‡ Argo Rollout æ¥è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹ã€‚</p><p>é€šè¿‡ Rollout å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé‡‘ä¸é›€å‘å¸ƒçš„è¿‡ç¨‹å®Œæ•´åœ°å®šä¹‰å‡ºæ¥ï¼Œæ¯”å¦‚å°†é‡‘ä¸é›€å‘å¸ƒåˆ†æˆè‹¥å¹²ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µä½¿ç”¨ä¸åŒçš„æµé‡æ¯”ä¾‹å¹¶ä¸”æŒç»­ä¸åŒçš„æ—¶é—´ã€‚åŒæ—¶ï¼Œè¿˜å¯ä»¥ä¸ºé‡‘ä¸é›€å‘å¸ƒé…ç½®æ‰‹åŠ¨ç¡®è®¤çš„è¿‡ç¨‹ã€‚</p><p>åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šå°½é‡æ‹‰é•¿é‡‘ä¸é›€å‘å¸ƒçš„æ—¶é—´ï¼Œæ¯”å¦‚æŒç»­æ•°å°æ—¶æ¸è¿›å¼åœ°å‘å¸ƒï¼Œä»¥ä¾¿æ›´å¤šçš„æµé‡æµå‘é‡‘ä¸é›€ç¯å¢ƒã€‚å…¶æ¬¡ï¼Œé€šè¿‡ç‰¹å®šçš„ Header æ¥è¯†åˆ«æµé‡æ˜¯ä¸€ç§éå¸¸å¥½çš„å·¥ç¨‹å®è·µï¼Œæ¯”å¦‚ä½ å¯ä»¥å°†ç‰¹å®šåœ°åŸŸã€æ€§åˆ«ã€å¹´é¾„çš„ç”¨æˆ·ä½œä¸ºç›®æ ‡ç¾¤ä½“æ¥è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒï¼Œè®©ç‰¹å®šçš„ç”¨æˆ·æ‰èƒ½è®¿é—®æ–°çš„ç‰ˆæœ¬ã€‚å¦‚æœä½ ä»”ç»†ç•™æ„è¿‡ï¼Œä¼šå‘ç°è‡ªå·±åœ¨ä½¿ç”¨ä¸€äº›å¤§å‹åº”ç”¨çš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½éƒ½ä½œä¸ºâ€œç°åº¦â€ç”¨æˆ·æ›¾ç»å‚ä¸äº†é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹ã€‚</p><p>æœ€åï¼Œè¦åœ¨ GitOps å®è·µé‡‘ä¸é›€å‘å¸ƒä¹Ÿéå¸¸å®¹æ˜“ï¼Œä½ åªéœ€è¦å°†å·¥ä½œè´Ÿè½½çš„ Kind å’Œ apiVersion å­—æ®µåˆ†åˆ«ä¿®æ”¹æˆ Rollout å’Œ argoproj.io/v1alpha1 å°±å¯ä»¥äº†ã€‚ç»“åˆ ArgoCDï¼Œä½ å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨ GitOps å·¥ä½œæµä¸­ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒäº†ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜å§ã€‚</p><p>åœ¨æ‰‹åŠ¨å®æ–½è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•å°†é‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºç”Ÿäº§ç¯å¢ƒï¼Ÿ</p><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":368261,"user_name":"FelixFly","can_delete":false,"product_type":"c1","uid":1160461,"ip_address":"å®‰å¾½","ucode":"1D39A7C3D0E31F","user_header":"https://static001.geekbang.org/account/avatar/00/11/b5/0d/0e65dee6.jpg","comment_is_top":false,"comment_ctime":1676078738,"is_pvip":true,"replies":[{"id":134092,"content":"å¯ä»¥å®ç°ï¼Œéœ€è¦é…åˆ Service Mesh åšåŠ¨æ€çš„è·¯ç”±ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨è¯·æ±‚é‡Œé¢å¸¦ä¸Šç‰¹æ®Šçš„æ ‡è¯†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1676084909,"ip_address":"å¹¿ä¸œ","comment_id":368261,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œè‹¥æ˜¯å•ä¸€é“¾è·¯æœ‰10ä¸ªå¾®æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥å®ç°æŸä¸€ä¸ªé‡‘ä¸é›€æœåŠ¡è°ƒç”¨ä¹ˆï¼Ÿè¿˜æ˜¯è¯´è¿™10ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦éƒ¨ç½²é‡‘ä¸é›€","like_count":4,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603293,"discussion_content":"å¯ä»¥å®ç°ï¼Œéœ€è¦é…åˆ Service Mesh åšåŠ¨æ€çš„è·¯ç”±ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨è¯·æ±‚é‡Œé¢å¸¦ä¸Šç‰¹æ®Šçš„æ ‡è¯†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676084909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":378840,"user_name":"æœ¨æ‰","can_delete":false,"product_type":"c1","uid":1526521,"ip_address":"å¹¿ä¸œ","ucode":"8268CB01ECA44F","user_header":"https://static001.geekbang.org/account/avatar/00/17/4a/f9/3309a50b.jpg","comment_is_top":false,"comment_ctime":1690873446,"is_pvip":false,"replies":[{"id":138041,"content":"æ˜¯çš„ï¼Œä¸€èˆ¬é…åˆæ¡ä»¶è·¯ç”±ç­–ç•¥ä½¿ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1690884422,"ip_address":"å¹¿ä¸œ","comment_id":378840,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"å…¶å®æµç¨‹çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä½†å®é™…ä¸Šéœ€è¦è€ƒè™‘çš„ä¸œè¥¿è¿˜æœ‰å¾ˆå¤šï¼Œç°åº¦å‘å¸ƒå¹¶ä¸æ˜¯å•å•åœ¨cicdä¸€ä¾§å°±å¯ä»¥è§£å†³çš„ï¼Œæ¯”å¦‚æŒ‰ç…§ç®€å•çš„50%-50%æµé‡åŒºåˆ†æ–°è€ç‰ˆæœ¬ï¼Œ1ä¸ªæµè§ˆå™¨çš„å‰ç«¯è¯·æ±‚ä¼šåœ¨2ä¸ªç‰ˆæœ¬ä¸Šæ¢æ¥æ¢å»ï¼Œè€Œä¸æ˜¯åŒä¸€ä¸ªæµè§ˆå™¨çš„è¯·æ±‚å§‹ç»ˆè·¯ç”±åˆ°åŒä¸€ç‰ˆæœ¬ï¼Œä¼šå¯¼è‡´1ä¸ªç”¨æˆ·åœ¨2ä¸ªç‰ˆæœ¬ä¸åœåˆ‡æ¥åˆ‡å»ï¼Œå¼•å‘å¾ˆå¤šé—®é¢˜ï¼Œå‰ç«¯æ˜¯è¿™æ ·ï¼Œåç«¯ä¹Ÿå¦‚æ­¤ã€‚","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624738,"discussion_content":"æ˜¯çš„ï¼Œä¸€èˆ¬é…åˆæ¡ä»¶è·¯ç”±ç­–ç•¥ä½¿ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1690884422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371137,"user_name":"é‚µæ¶µ","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"åŒ—äº¬","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1679567804,"is_pvip":false,"replies":[{"id":135396,"content":"1. Rollout çš„å‘å¸ƒè¿‡ç¨‹å’Œåˆ›å»ºäº†ä¸¤ä¸ª Deployment æœ‰ç‚¹ç±»ä¼¼ï¼Œä½ å¯ä»¥é€šè¿‡ HPA æ¥æ§åˆ¶å‰¯æœ¬æ•°ï¼Œå‚è€ƒï¼šhttps:&#47;&#47;argoproj.github.io&#47;argo-rollouts&#47;features&#47;hpa-support&#47;ã€‚\n2. å¯ä»¥è¿™æ ·åšã€‚\n3. å¯ä»¥é€šè¿‡å®éªŒéªŒè¯ä¸€ä¸‹ï¼ŒæŠ±æ­‰æˆ‘æ²¡æœ‰ç•™æ„è¿™ä¸ªç»†èŠ‚ã€‚\n4. æ£€æŸ¥ ingress å¯¹è±¡ä¸­å®šä¹‰çš„æ³¨è§£å’Œä½ å®é™…éƒ¨ç½² nginx-ingress å®ä¾‹æ˜¯å¦ä¸€è‡´ï¼ˆkubernetes.io&#47;ingress.class: nginxï¼‰ï¼Œå¦å¤– ingress-nginx çš„éƒ¨ç½²ç‰ˆæœ¬æ˜¯å¦å¤§äºè¯¾ç¨‹éƒ¨ç½²çš„ç‰ˆæœ¬ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1679574431,"ip_address":"å¹¿ä¸œ","comment_id":371137,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"å‡ ä¸ªé—®é¢˜ï¼š\n1. ä½¿ç”¨Rolloutçš„è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒæµç¨‹ä¸­ï¼Œé‡‘ä¸é›€ç¯å¢ƒé‡Œçš„podæ•°é‡ä¹Ÿæ˜¯å’Œç”Ÿäº§ç¯å¢ƒä¸­çš„podä¸€æ ·å¤šï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£æœ‰æ²¡æœ‰è®©ç”Ÿäº§ç¯å¢ƒpodæ•°é‡é€’å‡ã€é‡‘ä¸é›€ç¯å¢ƒpodé€’å¢çš„æ–¹å¼ï¼Ÿå°±åƒdeploymentæœ¬èº«çš„æ›´æ–°é‚£æ ·æ¸è¿›å¼æ›´æ–°podã€podæ€»é‡å‡ ä¹ä¸å˜\n2. å¦‚æœåªä½¿ç”¨headerçš„è½¬å‘è§„åˆ™ï¼Œä¸ä½¿ç”¨ç™¾åˆ†æ¯”æƒé‡çš„æ–¹å¼ï¼Œé‚£åœ¨strategy.canary.stepsä¸‹ï¼Œæ˜¯å°±åªå®šä¹‰pauseå°±å¯ä»¥äº†ï¼Ÿ\n3. è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒè¿‡ç¨‹ä¸­ï¼ŒArgo Rolloutè‡ªåŠ¨ä¸ºé‡‘ä¸é›€ç¯å¢ƒåˆ›å»ºçš„ingressï¼Œåœ¨å…¶nginx.ingress.kubernetes.io&#47;canary-weightå°†ä¸º0ä¹‹åï¼Œä¼šè¢«åˆ é™¤å—ï¼Ÿè¿˜æ˜¯ç•™ç»™ä¸‹æ¬¡é‡‘ä¸é›€å‘å¸ƒå¤ç”¨ï¼Ÿ\n4. å¯¹äºæ‰‹åŠ¨é‡‘ä¸é›€å‘å¸ƒçš„ä¾‹å­ï¼Œæˆ‘å®éªŒçš„ç»“æœæ˜¯ååˆ›å»ºçš„é‡‘ä¸é›€ç¯å¢ƒçš„ingressä¸èµ·ä½œç”¨ï¼Œä¸€ç›´éƒ½æ˜¯è“è‰²çš„ï¼Œåªæœ‰åˆ æ‰ç”Ÿäº§ç¯å¢ƒçš„ingressï¼Œé‡‘ä¸é›€ç¯å¢ƒçš„ingressæ‰èµ·ä½œç”¨ï¼Œä½†ä¹Ÿå°±éƒ½æ˜¯ç»¿è‰²çš„äº†ï¼Œæ²¡æœ‰è“è‰²äº†ï¼Œè¿™ä¸ªåŸå› å¤§æ¦‚å¯èƒ½æ˜¯ä»€ä¹ˆï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610469,"discussion_content":"1. Rollout çš„å‘å¸ƒè¿‡ç¨‹å’Œåˆ›å»ºäº†ä¸¤ä¸ª Deployment æœ‰ç‚¹ç±»ä¼¼ï¼Œä½ å¯ä»¥é€šè¿‡ HPA æ¥æ§åˆ¶å‰¯æœ¬æ•°ï¼Œå‚è€ƒï¼šhttps://argoproj.github.io/argo-rollouts/features/hpa-support/ã€‚\n2. å¯ä»¥è¿™æ ·åšã€‚\n3. å¯ä»¥é€šè¿‡å®éªŒéªŒè¯ä¸€ä¸‹ï¼ŒæŠ±æ­‰æˆ‘æ²¡æœ‰ç•™æ„è¿™ä¸ªç»†èŠ‚ã€‚\n4. æ£€æŸ¥ ingress å¯¹è±¡ä¸­å®šä¹‰çš„æ³¨è§£å’Œä½ å®é™…éƒ¨ç½² nginx-ingress å®ä¾‹æ˜¯å¦ä¸€è‡´ï¼ˆkubernetes.io/ingress.class: nginxï¼‰ï¼Œå¦å¤– ingress-nginx çš„éƒ¨ç½²ç‰ˆæœ¬æ˜¯å¦å¤§äºè¯¾ç¨‹éƒ¨ç½²çš„ç‰ˆæœ¬ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679574431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371136,"user_name":"é‚µæ¶µ","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"åŒ—äº¬","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1679566969,"is_pvip":false,"replies":[{"id":135398,"content":"æ­£ç¡®ï¼Œæ“ä½œèµ·æ¥æ˜¯éå¸¸éº»çƒ¦çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1679574758,"ip_address":"å¹¿ä¸œ","comment_id":371136,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"â€œåœ¨æ‰‹åŠ¨å®æ–½è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•å°†é‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºç”Ÿäº§ç¯å¢ƒï¼Ÿâ€\nè¿™é‡Œæ˜¯è¯´æ‰‹åŠ¨å®æ–½â€œé‡‘ä¸é›€å‘å¸ƒâ€å—ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆä¸€ä¸ªæ¯”è¾ƒå¿«é€Ÿçš„æ–¹å¼å¯èƒ½æ˜¯å°†ç”Ÿäº§ç¯å¢ƒçš„ingressçš„serviceæ”¹ä¸ºé‡‘ä¸é›€ç¯å¢ƒçš„serviceï¼Œå¹¶å°†é‡‘ä¸é›€ç¯å¢ƒçš„ingressçš„canary-weighté™ä¸º0ï¼Œå°†åŸç”Ÿäº§ç¯å¢ƒçš„deploymentçš„replicasé™ä¸º0ã€‚ä¸è¿‡è¿™æ ·åšå­˜åœ¨çš„é—®é¢˜æ˜¯ä¸‹æ¬¡æ‰§è¡Œé‡‘ä¸é›€å‘å¸ƒæ—¶ï¼Œä¸èƒ½ç”¨å®Œå…¨ç›¸åŒçš„æ ‡ç­¾å»åˆ›å»ºé‡‘ä¸é›€ç¯å¢ƒçš„serviceã€deployment","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610477,"discussion_content":"æ­£ç¡®ï¼Œæ“ä½œèµ·æ¥æ˜¯éå¸¸éº»çƒ¦çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679574758,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370034,"user_name":"Noel ZHANG","can_delete":false,"product_type":"c1","uid":1983237,"ip_address":"æ±Ÿè‹","ucode":"DF4E7E1FAFB509","user_header":"https://static001.geekbang.org/account/avatar/00/1e/43/05/3fbf26cf.jpg","comment_is_top":false,"comment_ctime":1678287425,"is_pvip":false,"replies":[{"id":134915,"content":"æ˜¯çš„ï¼Œå–å†³äº ingress çš„æµé‡è°ƒåº¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1678333095,"ip_address":"å¹¿ä¸œ","comment_id":370034,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"çœ‹èµ·æ¥è¿™ä¸¤ä¸ªserviceæ˜¯å¹¶åˆ—çš„äº¤æ›¿èŒè´£çš„å…³ç³»ï¼Œå¹¶ä¸æ˜¯demo-canaryçš„å°±ä¸€å®šåˆ†æ‹…canary podsçš„æµé‡ã€‚æ˜¯è¿™æ ·ä¹ˆï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608222,"discussion_content":"æ˜¯çš„ï¼Œå–å†³äº ingress çš„æµé‡è°ƒåº¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678333095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368902,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"åŒ—äº¬","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1676878722,"is_pvip":false,"replies":[{"id":134353,"content":"ğŸ‘ğŸ»å¾ˆæ£’çš„æ€»ç»“ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1676884049,"ip_address":"å¹¿ä¸œ","comment_id":368902,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100312001,"comment_content":"1. è“ç»¿å‘å¸ƒç›¸å¯¹äºé‡‘ä¸é›€å‘å¸ƒï¼ˆç°åº¦å‘å¸ƒï¼‰ç¼ºç‚¹æ˜¯æµé‡å°†è¿›è¡Œå…¨é‡åˆ‡æ¢æ—¶æ— æ³•å¯¹æ–°ç¯å¢ƒè¿›è¡Œå°è§„æ¨¡çš„æµé‡éªŒè¯ã€‚\n\n2. æ‰‹åŠ¨è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒéƒ¨ç½²å¯¹è±¡æ˜¯deploymentï¼Œé‡ç‚¹æ˜¯åœ¨Ingressé…ç½®ç­–ç•¥ã€‚\napiVersion: networking.k8s.io&#47;v1\nkind: Ingress\nmetadata:\n  name: canary-ingress-canary\n  annotations:\n    kubernetes.io&#47;ingress.class: nginx\n    nginx.ingress.kubernetes.io&#47;canary: &quot;true&quot;\n    nginx.ingress.kubernetes.io&#47;canary-weight: &quot;20&quot;\n    nginx.ingress.kubernetes.io&#47;canary-by-header: &quot;X-Canary&quot;\n\n3. è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒé‡ç‚¹æ˜¯crdâ€”â€”Rollout å¯¹è±¡ã€‚å¯ä»¥è‡ªå®šä¹‰é…ç½®å‘å¸ƒç­–ç•¥ã€‚\n  strategy:\n    canary:\n      canaryService: canary-demo-canary\n      stableService: canary-demo\n      canaryMetadata:\n        labels:\n          deployment: canary\n      stableMetadata:\n        labels:\n          deployment: stable\n      trafficRouting:\n        nginx:\n          stableIngress: canary-demo\n          additionalIngressAnnotations:\n            canary-by-header: X-Canary\n      steps:\n        - setWeight: 20\n        - pause: {}\n        - setWeight: 50\n        - pause:\n            duration: 30s\n        - setWeight: 70\n        - pause:\n            duration: 30s\n\n4. é‡ç‚¹é‡‘ä¸é›€é…ç½®ç†è§£ï¼š\ncanaryService è¡¨ç¤ºé‡‘ä¸é›€ Service çš„åç§°ï¼Œæˆ‘ä»¬ä¼šåœ¨ç¨ååˆ›å»ºå®ƒã€‚\nstableService è¡¨ç¤ºç”Ÿäº§ç¯å¢ƒ Service çš„åç§°ï¼ŒåŒæ ·ä¹Ÿéœ€è¦åœ¨ç¨ååˆ›å»ºã€‚\ncanaryMetadata å’Œ stableMetadata å­—æ®µè¡¨ç¤ºåœ¨é‡‘ä¸é›€å‘å¸ƒæ—¶ï¼Œä¼šå°†é¢å¤–çš„æ ‡ç­¾å¢åŠ åˆ° Pod ä¸­ï¼Œå®ƒå¯ä»¥åŒºåˆ†ä¸åŒç¯å¢ƒçš„ Podã€‚\ntrafficRouting.nginx å­—æ®µè¡¨ç¤ºä½¿ç”¨ Ingress-Nginx æ¥ç®¡ç†æµé‡\ntrafficRouting.nginx.stableIngress å­—æ®µç”¨æ¥æŒ‡å®š Ingress åç§°ï¼Œè¿™ä¸ª Ingress éœ€è¦æˆ‘ä»¬æå‰åˆ›å»ºã€‚trafficRouting.nginx.additionalIngressAnnotations å­—æ®µç”¨æ¥é…ç½®ç‰¹å®šçš„é‡‘ä¸é›€æµé‡è¯†åˆ«ç­–ç•¥ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯å½“è¯·æ±‚å¤´å‡ºç° X-Canary æ—¶ï¼Œå°±å°†æµé‡è½¬å‘åˆ°é‡‘ä¸é›€ç¯å¢ƒä¸­ã€‚\næ­¤å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹é‡è¦çš„é…ç½®ï¼šcanary.stepsï¼Œå®ƒæ˜¯ç”¨æ¥æè¿°å¦‚ä½•è¿›è¡Œè‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè‡ªåŠ¨åŒ–é‡‘ä¸é›€çš„é…ç½®å¦‚ä¸‹ã€‚\nå°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹é…ç½®ä¸º 20%ã€‚\næš‚åœé‡‘ä¸é›€å‘å¸ƒï¼Œç›´åˆ°æ‰‹åŠ¨æ‰¹å‡†ã€‚\nå°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹é…ç½®ä¸º 50%ï¼Œå¹¶æŒç»­ 30 ç§’\nã€‚å°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹é…ç½®ä¸º 70%ï¼Œå¹¶æŒç»­ 30 ç§’ã€‚\n","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606010,"discussion_content":"ğŸ‘ğŸ»å¾ˆæ£’çš„æ€»ç»“ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676884049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":379270,"user_name":"Sophia-ç™¾é‘«","can_delete":false,"product_type":"c1","uid":1269105,"ip_address":"ä¸Šæµ·","ucode":"070DC977441003","user_header":"https://static001.geekbang.org/account/avatar/00/13/5d/71/4f6aad17.jpg","comment_is_top":false,"comment_ctime":1691642511,"is_pvip":false,"replies":[{"id":138206,"content":"å¯ä»¥åœ¨ ago rollout æ§åˆ¶å°ç›´æ¥å›æ»š","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1691718948,"ip_address":"å¹¿ä¸œ","comment_id":379270,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆå¥½ï¼Œå¦‚æœcanary å‘å¸ƒå®Œæˆåï¼Œå‘ç°prod ç¯å¢ƒæœ‰é—®é¢˜ï¼Œéœ€è¦ç«‹å³å›æ»šç‰ˆæœ¬ã€‚è¿™æ—¶çš„åº”æ€¥å¤„ç†æˆ‘èƒ½æƒ³åˆ°çš„æ˜¯ ä¿®æ”¹rollout.yaml ä¸­image ç‰ˆæœ¬å’Œä¿®æ”¹steps ä¸­å‘å¸ƒç­–ç•¥ï¼ŒsetWeightï¼š100%ï¼Œå…¶ä»–æ­¥éª¤éƒ½åˆ æ‰ã€‚ æ˜¯è¿™æ ·å—ï¼Ÿæ˜¯å¦è¿˜æœ‰å…¶ä»–æ–¹æ³•ï¼Ÿ\n","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":625460,"discussion_content":"å¯ä»¥åœ¨ ago rollout æ§åˆ¶å°ç›´æ¥å›æ»š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1691718948,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2608728,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","nickname":"Dexter","note":"","ucode":"909CABC4AC4AC9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644681,"discussion_content":"kubectl argo rollout undo ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715419584,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368589,"user_name":"æ¾","can_delete":false,"product_type":"c1","uid":1521961,"ip_address":"å¤©æ´¥","ucode":"1F092C4862BB40","user_header":"https://static001.geekbang.org/account/avatar/00/17/39/29/a3b4c6e9.jpg","comment_is_top":false,"comment_ctime":1676462675,"is_pvip":false,"replies":[{"id":134250,"content":"çœ‹è¿™ä¸ªæŠ¥é”™å¯èƒ½å’Œåä¸ºäº‘æœ‰ä¸€äº›ç‰¹æ®Šæœºåˆ¶æœ‰å…³ï¼Œæˆ‘æš‚æ—¶ä¹Ÿæ²¡æœ‰æ’æŸ¥æ€è·¯ã€‚é‡‘ä¸é›€å®éªŒä¸ä¾èµ–äº‘å‚å•†çš„æœåŠ¡ï¼Œä½ å¯ä»¥å°è¯•æœ¬åœ°çš„ KiND é›†ç¾¤æ¥å®éªŒï¼Œå¦å¤–ä¹Ÿå¯ä»¥æäº¤ä¸€ä¸ªå·¥å•è®©äº‘å‚å•†å¸®å¿™æ’æŸ¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1676507359,"ip_address":"å¹¿ä¸œ","comment_id":368589,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆï¼Œç”¨ä½ çš„ä¾‹å­åœ¨åä¸ºäº‘é›†ç¾¤åšéªŒè¯ï¼Œåˆ›å»ºå¹¶æŸ¥è¯¢ rollout æ—¶æŠ¥error creating canary ingress `canary-demo-canary-demo-canary`: ingresses.extensions &quot;canary-demo-canary-demo-canary&quot; is forbidden: service &quot;canary-demo-canary&quot; not foundï¼Œèƒ½å¦æä¾›ä¸€ä¸‹äº›æ’æŸ¥æ€è·¯ï¼Ÿcanary-demo-canaryæˆ‘å·²ç»åˆ›å»ºè¿‡äº†","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":604924,"discussion_content":"çœ‹è¿™ä¸ªæŠ¥é”™å¯èƒ½å’Œåä¸ºäº‘æœ‰ä¸€äº›ç‰¹æ®Šæœºåˆ¶æœ‰å…³ï¼Œæˆ‘æš‚æ—¶ä¹Ÿæ²¡æœ‰æ’æŸ¥æ€è·¯ã€‚é‡‘ä¸é›€å®éªŒä¸ä¾èµ–äº‘å‚å•†çš„æœåŠ¡ï¼Œä½ å¯ä»¥å°è¯•æœ¬åœ°çš„ KiND é›†ç¾¤æ¥å®éªŒï¼Œå¦å¤–ä¹Ÿå¯ä»¥æäº¤ä¸€ä¸ªå·¥å•è®©äº‘å‚å•†å¸®å¿™æ’æŸ¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676507359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368382,"user_name":"yuer","can_delete":false,"product_type":"c1","uid":1399084,"ip_address":"åŒ—äº¬","ucode":"A07F502444D400","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTInib3sUCjqGjskNVcLwblFKnk1hxclXpGJYuwBNmcYfEkz8PicdicPBo1s16gaRal4PrZ3fPAQqTibsA/132","comment_is_top":false,"comment_ctime":1676273258,"is_pvip":false,"replies":[{"id":134166,"content":"å¯ä»¥çš„ï¼Œåªæ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”è‡ªå·±å†™çš„è„šæœ¬ä¸ä¸€å®šèƒ½å¾ˆå¥½åœ°æ”¯æŒå¹‚ç­‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1676279297,"ip_address":"å¹¿ä¸œ","comment_id":368382,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆï¼ŒåŸç”Ÿçš„k8så®ç°é‡‘ä¸é›€çš„å‘éƒ¨æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å†™è„šæœ¬å®Œæˆè‡ªåŠ¨åŒ–å‘éƒ¨ã€‚","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603768,"discussion_content":"å¯ä»¥çš„ï¼Œåªæ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”è‡ªå·±å†™çš„è„šæœ¬ä¸ä¸€å®šèƒ½å¾ˆå¥½åœ°æ”¯æŒå¹‚ç­‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676279297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}