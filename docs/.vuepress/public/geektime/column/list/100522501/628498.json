{"id":628498,"title":"15ï½œç»„ä»¶ç›‘æ§ï¼šKafkaçš„å…³é”®æŒ‡æ ‡åŠé‡‡é›†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç§¦æ™“è¾‰ã€‚</p><p>å‰é¢ä¸¤è®²æˆ‘ä»¬ä»‹ç»äº† MySQL å’Œ Redis çš„ç›‘æ§ï¼Œæ ¸å¿ƒåŸç†å°±æ˜¯è¿åˆ°å®ä¾‹ä¸Šæ‰§è¡Œç‰¹å®šè¯­å¥å‘½ä»¤æ‹‰å–æ•°æ®ï¼Œç±»ä¼¼çš„è¿˜æœ‰ MongoDBï¼Œè¿™ç®—æ˜¯ä¸€ç±»ç›‘æ§åœºæ™¯ã€‚è¿™ä¸€è®²æˆ‘ä»¬ä»‹ç»ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸å¸¸ç”¨çš„ç»„ä»¶â€”â€”Kafkaï¼ŒåŒæ—¶å¼•å‡º JMX ç›‘æ§åœºæ™¯ï¼Œä¸°å¯Œä½ çš„æ•°æ®é‡‡é›†å·¥å…·ç®±ã€‚</p><p>è¦åšå¥½ Kafka çš„ç›‘æ§ï¼Œé¦–å…ˆè¦äº†è§£ Kafka çš„<a href=\"https://time.geekbang.org/column/article/99318\">åŸºç¡€æ¦‚å¿µ</a>ï¼Œæ¯”å¦‚ Topicï¼ˆä¸»é¢˜ï¼‰ã€Partitionï¼ˆåˆ†åŒºï¼‰ã€Replicaï¼ˆå‰¯æœ¬ï¼‰ã€ARï¼ˆAssigned Replicasï¼‰ã€ISRï¼ˆIn-Sync Replicasï¼‰ã€OSRï¼ˆOut-of-Sync Replicasï¼‰ã€HWï¼ˆHigh Watermarkï¼‰ã€LEOï¼ˆLog End Offsetï¼‰ç­‰ç­‰ã€‚å…¶æ¬¡æ˜¯è¦äº†è§£ Kafka çš„æ¶æ„ï¼Œé€šè¿‡æ¶æ„æ‰èƒ½çŸ¥é“è¦é‡ç‚¹ç›‘æ§å“ªäº›ç»„ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸€ä¸‹ Kafka çš„æ¶æ„å›¾ã€‚</p><h2>Kafka æ¶æ„</h2><p><img src=\"https://static001.geekbang.org/resource/image/d6/84/d691yye35395bb878227c002dfcc7a84.png?wh=2306x1303\" alt=\"\" title=\"å›¾ç‰‡æ¥è‡ªç½‘ç»œ\"></p><p>ä¸Šé¢ç»¿è‰²éƒ¨åˆ† PRODUCERï¼ˆç”Ÿäº§è€…ï¼‰å’Œä¸‹é¢ç´«è‰²éƒ¨åˆ† CONSUMERï¼ˆæ¶ˆè´¹è€…ï¼‰æ˜¯ä¸šåŠ¡ç¨‹åºï¼Œé€šå¸¸ç”±ç ”å‘äººå‘˜åŸ‹ç‚¹è§£å†³ç›‘æ§é—®é¢˜ï¼Œå¦‚æœæ˜¯ Java å®¢æˆ·ç«¯ä¹Ÿä¼šæš´éœ² JMX æŒ‡æ ‡ã€‚ç»„ä»¶è¿ç»´ç›‘æ§å±‚é¢ç€é‡å…³æ³¨è“è‰²éƒ¨åˆ†çš„ BROKERï¼ˆKafka èŠ‚ç‚¹ï¼‰å’Œçº¢è‰²éƒ¨åˆ†çš„ ZOOKEEPERã€‚</p><p>ZooKeeper ä¹Ÿæ˜¯ Java è¯­è¨€å†™çš„ï¼Œç›‘æ§ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥å¤ç”¨ä¸‹é¢ä»‹ç»çš„ JMX ç›‘æ§æ–¹å¼ï¼Œå¦å¤– ZooKeeper æ”¯æŒ mntr å››å­—å‘½ä»¤ï¼Œå¯ä»¥è·å– ZooKeeper å†…éƒ¨å¥åº·çŠ¶å†µã€‚æ–°ç‰ˆ ZooKeeper è¿å››å­—å‘½ä»¤éƒ½ä¸éœ€è¦äº†ï¼Œç›´æ¥å†…ç½®æš´éœ²äº† Prometheus åè®®çš„ metrics æ¥å£ï¼Œç›´æ¥æŠ“å–å³å¯ã€‚</p><!-- [[[read_end]]] --><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ Broker èŠ‚ç‚¹çš„ç›‘æ§ï¼Œä¹Ÿå°±æ˜¯ Kafka è‡ªèº«çš„ç›‘æ§ï¼Œé€šå¸¸ä»å››ä¸ªæ–¹é¢ç€æ‰‹ã€‚</p><ul>\n<li>Kafka è¿›ç¨‹æ‰€åœ¨æœºå™¨çš„ç›‘æ§ï¼Œè¿™ä¸ªå‚è€ƒå‰é¢<a href=\"https://time.geekbang.org/column/article/625436\">ç¬¬ 11 è®²</a>çš„å†…å®¹ï¼Œé‡ç‚¹å…³æ³¨CPUã€ç¡¬ç›˜I/Oã€ç½‘ç»œI/Oã€‚</li>\n<li>JVM ç›‘æ§ï¼ŒKafka æ˜¯ä¸ª Java è¿›ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å¸¸è§„çš„ JVM ç›‘æ§ï¼Œé€šè¿‡ JMX æ–¹å¼æš´éœ²ã€‚</li>\n<li>Kafka è‡ªèº«çš„æŒ‡æ ‡ã€ä¹Ÿæ˜¯é€šè¿‡ JMX æ–¹å¼æš´éœ²ï¼Œæ¯”å¦‚æ¶ˆæ¯æ•°é‡ã€æµé‡ã€åˆ†åŒºã€å‰¯æœ¬çš„æ•°é‡ç­‰ã€‚</li>\n<li>å„ä¸ª consumer çš„ lag ç›‘æ§ï¼Œå³æ¶ˆæ¯å †ç§¯é‡ï¼Œæ˜¯å„ç±»MQéƒ½åº”è¯¥ç›‘æ§çš„æŒ‡æ ‡ã€‚</li>\n</ul><p>JVM å’Œ Kafka ç›¸å…³çš„æŒ‡æ ‡ï¼Œéƒ½é€šè¿‡ JMX æ–¹å¼æš´éœ²ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯ JMXï¼Œä»¥åŠ Kafka å¦‚ä½•å¼€å¯ JMXã€‚</p><h2>JMX ç®€ä»‹</h2><p>JMXï¼ˆJava Management Extensionsï¼‰æ˜¯ä¸€ä¸ªä¸ºåº”ç”¨ç¨‹åºæ¤å…¥ç®¡ç†åŠŸèƒ½çš„æ¡†æ¶ã€‚Java ç¨‹åºæ¥å…¥ JMX æ¡†æ¶ä¹‹åï¼Œå¯ä»¥æŠŠä¸€äº›ç±»çš„å±æ€§å’Œæ–¹æ³•æš´éœ²å‡ºæ¥ï¼Œç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨ JMX ç›¸å…³å·¥å…·æ¥è¯»å–æˆ–æ“ä½œè¿™äº›ç±»ã€‚</p><p>æ¯”å¦‚ä¸€ä¸ªç±»æ˜¯ Personï¼Œæœ‰ Name å’Œ Age ä¸¤ä¸ªå±æ€§ï¼Œå¦‚æœæŠŠ Person åšæˆä¸€ä¸ª MBeanï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ JConsoleé‡Œç›´æ¥æŸ¥åˆ° Person å±æ€§çš„å€¼ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹è¿™äº›å±æ€§ã€‚</p><p><span class=\"reference\">æ³¨ï¼šMBeanè¢«ç®¡ç†çš„Javaå¯¹è±¡ï¼ŒJConsoleæ˜¯JMXçš„ä¸€ä¸ªç®¡ç†å·¥å…·ã€‚</span></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ JConsole ç›´æ¥æ“ä½œ JavaBeanï¼Œé‚£JConsole å¯¹ JavaBeanæ¥è¯´æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æ‰“ä¸ªæ¯”æ–¹å§ï¼Œå…¶å®å°±åƒæ˜¯PHPMyAdmin ä¹‹äº MySQLï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ PHPMyAdmin ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œè¿™æ ·è¯´ä½ å¤§æ¦‚èƒ½ç†è§£äº†å§ã€‚å¦‚æœä½ æ²¡æœ‰ç†è§£ä¹Ÿæ²¡å…³ç³»ï¼Œä»ç›‘æ§çš„è§’åº¦ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“å¦‚ä½•é€šè¿‡ JMX è¯»å– Kafka çš„æŒ‡æ ‡å³å¯ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹ Kafka å¦‚ä½•å¼€å¯ JMX ç«¯å£ã€‚</p><h2>Kafka å¼€å¯ JMX</h2><p>Kafka çš„é…ç½®æ–‡ä»¶åœ¨ config ç›®å½•ï¼Œå„ç§è„šæœ¬åœ¨ bin ç›®å½•ï¼Œè¦è®© Kafka å¼€å¯ JMXï¼Œè‚¯å®šæ˜¯è¦ä¿®æ”¹æŸä¸ªé…ç½®é¡¹æˆ–è€…è°ƒæ•´æŸä¸ªè„šæœ¬çš„ï¼Œå…·ä½“è°ƒæ•´å“ªé‡Œå‘¢ï¼Ÿæˆ‘ä»¬åœ¨ Kafka çš„éƒ¨ç½²ç›®å½•æœç´¢ä¸€ä¸‹çœ‹çœ‹ã€‚</p><pre><code class=\"language-json\">grep -i jmx -r config\ngrep -i jmx -r bin\n</code></pre><p>åœ¨ config ç›®å½•æœç´¢ jmx å‘ç°ä»€ä¹ˆéƒ½æ‰¾ä¸åˆ°ï¼Œçœ‹æ¥ä¸æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¤„ç†çš„ã€‚åœ¨ bin ç›®å½•ä¸‹æœç´¢ jmxï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªè„šæœ¬å‡ºç°äº†è¿™ä¸ªå…³é”®å­—ï¼Œä¸€ä¸ªæ˜¯ bin/kafka-run-class.shï¼Œå¦ä¸€ä¸ªæ˜¯ bin/windows/kafka-run-class.batã€‚æ˜¾ç„¶ bat ç»“å°¾çš„æ–‡ä»¶æ˜¯ Windows ç¯å¢ƒçš„æ‰¹å¤„ç†æ–‡ä»¶ï¼Œsh ç»“å°¾çš„æ‰æ˜¯ Linuxã€Mac ä¸‹ä½¿ç”¨çš„è„šæœ¬æ–‡ä»¶ã€‚æˆ‘æœ¬åœ°æ˜¯ Mac ç¯å¢ƒï¼Œæ‰“å¼€ kafka-run-class.sh çœ‹ä¸€ä¸‹é‡Œè¾¹çš„å…³é”®é…ç½®ã€‚</p><pre><code class=\"language-json\"># JMX settings\nif [ -z \"$KAFKA_JMX_OPTS\" ]; then\n&nbsp; KAFKA_JMX_OPTS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false&nbsp; -Dcom.sun.management.jmxremote.ssl=false \"\nfi\n\n# JMX port to use\nif [&nbsp; $JMX_PORT ]; then\n&nbsp; KAFKA_JMX_OPTS=\"$KAFKA_JMX_OPTS -Dcom.sun.management.jmxremote.port=$JMX_PORT \"\nfi\n\n...\n\n# Launch mode\nif [ \"x$DAEMON_MODE\" = \"xtrue\" ]; then\n&nbsp; nohup \"$JAVA\" $KAFKA_HEAP_OPTS $KAFKA_JVM_PERFORMANCE_OPTS $KAFKA_GC_LOG_OPTS $KAFKA_JMX_OPTS $KAFKA_LOG4J_OPTS -cp \"$CLASSPATH\" $KAFKA_OPTS \"$@\" &gt; \"$CONSOLE_OUTPUT_FILE\" 2&gt;&amp;1 &lt; /dev/null &amp;\nelse\n&nbsp; exec \"$JAVA\" $KAFKA_HEAP_OPTS $KAFKA_JVM_PERFORMANCE_OPTS $KAFKA_GC_LOG_OPTS $KAFKA_JMX_OPTS $KAFKA_LOG4J_OPTS -cp \"$CLASSPATH\" $KAFKA_OPTS \"$@\"\nfi\n</code></pre><p>å¦‚æœ KAFKA_JMX_OPTS å˜é‡ä¸ºç©ºï¼Œå°±ç»™å®ƒèµ‹å€¼ï¼Œèµ‹å€¼çš„é‚£ä¸€è¡Œå†…å®¹ï¼Œå®é™…å°±æ˜¯å¼€å¯ JMX çš„å…³é”®å‚æ•°ã€‚å¦‚æœ JMX_PORT å˜é‡ä¸ä¸ºç©ºï¼Œå°±å†åŠ ä¸Š -Dcom.sun.management.jmxremote.port è¿™ä¸ªå‚æ•°ï¼Œé€šè¿‡æŸä¸ªç«¯å£æš´éœ² JMX æ•°æ®ï¼Œæœ€åæŠŠ KAFKA_JMX_OPTS æ”¾åˆ°å¯åŠ¨å‘½ä»¤é‡Œã€‚</p><p>è¿™å°±å¾ˆæ¸…æ™°äº†ï¼Œåªè¦å¯åŠ¨ Kafka ä¹‹å‰ï¼Œåœ¨ç¯å¢ƒå˜é‡é‡ŒåµŒå…¥ JMX_PORT å˜é‡ï¼ŒKafka å°±ä¼šç›‘å¬è¿™ä¸ªç«¯å£ï¼Œæš´éœ² JMX æ•°æ®ï¼Œæˆ‘ä»¬è¯•è¯•ã€‚</p><pre><code class=\"language-json\">export JMX_PORT=3457; ./bin/kafka-server-start.sh config/server.properties\n</code></pre><p>å¯åŠ¨ä¹‹åï¼Œæ£€æŸ¥ Kafka çš„ç«¯å£ç›‘å¬ï¼Œå°±ä¼šå‘ç°é™¤äº†åŸæœ¬ç›‘å¬çš„ 9092 ç«¯å£ï¼Œç°åœ¨ä¹Ÿç›‘å¬äº† 3457 ç«¯å£ï¼Œæˆ‘ä»¬ä½¿ç”¨ JConsole å·¥å…·è¿ä¸Šæ¥çœ‹çœ‹ã€‚å¦‚æœä½ ä¹‹å‰å®‰è£…è¿‡ JDKï¼Œç›´æ¥åœ¨å‘½ä»¤è¡Œé‡Œè¾“å…¥ jconsole å°±èƒ½æ‰“å¼€ JConsole é¡µé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/37/a5/3760f24d0d92d5d5db79edb58d8fbca5.png?wh=2425x2111\" alt=\"\"></p><p>æˆ‘ä»¬é€‰æ‹©è¿œç¨‹è¿›ç¨‹ï¼Œè¾“å…¥ localhost:3457ï¼Œç„¶åç‚¹å‡»è¿æ¥ï¼Œé€‰æ‹©ä¸å®‰å…¨çš„è¿æ¥ï¼Œå°±è¿›å…¥äº† JConsole ä¸»é¡µé¢ã€‚é»˜è®¤è¿›æ¥æ˜¯æ¦‚è§ˆé¡µé¢ï¼Œæˆ‘ä»¬é€‰æ‹© MBeanï¼Œå·¦ä¾§å°±çœ‹åˆ°äº†ä¸€ä¸ªæ ‘å½¢ç»“æ„çš„å¤šä¸ªå¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¾æ¬¡ç‚¹å‡» kafka.serverã€ReplicaManagerã€OfflineReplicaCountï¼Œå³ä¾§ä¼šå±•ç¤º MBeanInfoï¼Œé‡Œè¾¹å°¤å…¶è¦æ³¨æ„çš„æ˜¯ ObjectNameï¼Œåé¢æˆ‘ä»¬è·å– JMX æ•°æ®çš„æ—¶å€™ï¼Œä¼šé¢‘ç¹ç”¨åˆ°è¿™ä¸ªå±æ€§ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/63/a6/638d5f5c37f17d920e036dd14fcf33a6.png?wh=1746x1520\" alt=\"å›¾ç‰‡\"></p><p>OfflineReplicaCount æ˜¯ Broker çš„ä¸€ä¸ªå…³é”®æŒ‡æ ‡ï¼Œç‚¹å‡»ä¸‹é¢çš„å±æ€§ï¼Œå°±å¯ä»¥çœ‹åˆ°å…·ä½“çš„å€¼ã€‚</p><p>é€šè¿‡ JConsole çš„é¡µé¢ç¡®å®å¯ä»¥æŸ¥åˆ°å„ä¸ªç›‘æ§æŒ‡æ ‡çš„æ•°æ®ï¼Œä½†çœŸæ­£å’Œç›‘æ§ç³»ç»Ÿå¯¹æ¥çš„è¯ï¼Œè¿˜æ˜¯éœ€è¦ä½¿ç”¨ç¼–ç¨‹çš„æ–¹å¼æ¥è·å–ã€‚JMX çš„ç«¯å£èµ°çš„æ˜¯ RMI åè®®ï¼Œæ˜¯Javaç‹¬æœ‰çš„RPCåè®®ï¼Œå…¶ä»–è¯­è¨€æ²¡æ³•è°ƒç”¨ã€‚å¥½åœ¨æœ‰å·¥å…·å¯ä»¥æŠŠå®ƒè½¬ä¸º HTTP åè®®ï¼Œå¸¸è§çš„å·¥å…·æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ Prometheus ç”Ÿæ€çš„ <a href=\"https://github.com/prometheus/jmx_exporter\">jmx_exporter_javaagent</a>ï¼Œä¸€ä¸ªæ˜¯ <a href=\"https://jolokia.org/\">Jolokia</a>ã€‚Jolokia ä¹Ÿæ˜¯ä¸ª JavaAgentï¼Œjmx_exporter å¯ä»¥æŠŠ JMX æŒ‡æ ‡å¯¼å‡ºä¸º Prometheus metrics æ ¼å¼ï¼ŒJolokia å¯ä»¥æŠŠ JMX æŒ‡æ ‡å¯¼å‡ºä¸º JSON æ ¼å¼ï¼Œå·®åˆ«ä¸å¤§ã€‚</p><p>ä¸è¿‡ Kafka æš´éœ²çš„ JMX æŒ‡æ ‡å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå¦‚æœä¸è¿‡æ»¤å…¨éƒ¨å¯¼å‡ºï¼Œæ¯ä¸ª Broker è½»è½»æ¾æ¾å°±å‡ ä¸‡ä¸ªJMX æŒ‡æ ‡ï¼Œå¤§å‹äº’è”ç½‘å…¬å¸çš„è¯ï¼ŒåŸºæœ¬ä¸Šéƒ½æœ‰å‡ ç™¾ä¸ª Brokerï¼Œè¿™ä¸ªé‡å°±æœ‰ç‚¹å„¿å¤§äº†ã€‚</p><p>è¿‡æ»¤æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯è¿‡æ»¤ MBeanï¼Œé€šè¿‡ç™½åå•çš„æ–¹å¼æŒ‡å®šï¼Œè¿™äº› MBean é‡‡é›†çš„æ•°æ®å¦‚æœæœ‰äº›è¿˜ä¸æƒ³è¦ï¼Œå°±åšäºŒæ¬¡è¿‡æ»¤ï¼Œé€šè¿‡é»‘åå•çš„æ–¹å¼æŒ‡å®šï¼Œæ¯”å¦‚æ ¹æ®æŒ‡æ ‡åå­—åšè¿‡æ»¤ã€‚jmx_exporter æŒ‡å®š MBean è¿‡æ»¤è§„åˆ™æ˜¯é€šè¿‡ä¸€ä¸ªé…ç½®æ–‡ä»¶å®ç°çš„ï¼Œå¦‚æœè¿™ä¸ªé…ç½®æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œå°±è¦é‡å¯ Java è¿›ç¨‹ï¼ŒåŠ¨ä½œæœ‰ç‚¹å„¿é‡ã€‚</p><p>è€Œ Jolokia çš„è¿‡æ»¤è§„åˆ™éƒ½å¯ä»¥åœ¨é‡‡é›†å™¨ agent ä¾§å®ç°ï¼Œä¿®æ”¹è¿‡æ»¤è§„åˆ™åªéœ€è¦é‡å¯é‡‡é›†å™¨å³å¯ï¼Œä¸éœ€è¦é‡å¯è¦ç›‘æ§çš„ Java è¿›ç¨‹ï¼ŒåŠ¨ä½œç›¸å¯¹è½»ä¸€äº›ã€‚æ‰€ä»¥æˆ‘ä¸ªäººå€¾å‘ä½¿ç”¨ Jolokiaã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä¸º Kafka å¼•å…¥ Jolokia æ”¯æŒã€‚</p><h2>Kafka å¼€å¯ Jolokia</h2><p>é¦–å…ˆä¸‹è½½ Jolokia çš„ <a href=\"https://download.flashcat.cloud/jolokia-jvm-1.6.2-agent.jar.zip\">javaagent jar åŒ…</a>ï¼Œè§£å‹åˆ° /opt/jolokia ç›®å½•ä¸‹ã€‚ç„¶ååœ¨ kafka-run-class.sh æ‰¾åˆ° JMX ç›¸å…³çš„é…ç½®ï¼Œåœ¨ JMX_PORT ç›¸å…³é€»è¾‘ä¸‹é¢å¢åŠ ä¸‰è¡Œã€‚</p><pre><code class=\"language-json\"># JMX settings\nif [ -z \"$KAFKA_JMX_OPTS\" ]; then\n&nbsp; KAFKA_JMX_OPTS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false&nbsp; -Dcom.sun.management.jmxremote.ssl=false \"\nfi\n\n# JMX port to use\nif [&nbsp; $JMX_PORT ]; then\n&nbsp; KAFKA_JMX_OPTS=\"$KAFKA_JMX_OPTS -Dcom.sun.management.jmxremote.port=$JMX_PORT \"\nfi\n\n########## adding lines\nif [ \"x$JOLOKIA\" != \"x\" ]; then\n&nbsp; KAFKA_JMX_OPTS=\"$KAFKA_JMX_OPTS -javaagent:/opt/jolokia/jolokia-jvm-1.6.2-agent.jar=host=0.0.0.0,port=3456\"\nfi\n</code></pre><p>ä¾‹å­é‡Œçš„ 3456 æ˜¯ Jolokia ç›‘å¬çš„ç«¯å£ï¼Œå¯ä»¥æ¢æˆåˆ«çš„ï¼Œåªè¦åˆ«è·Ÿæœºå™¨ä¸Šçš„å…¶ä»–ç«¯å£å†²çªå°±è¡Œã€‚åŠ äº†ä¸€ä¸ª JOLOKIA å˜é‡çš„åˆ¤æ–­ï¼Œå¦‚æœè¿™ä¸ªå˜é‡ä¸ä¸ºç©ºï¼Œå°±å¼€å¯ Jolokiaï¼›å¦‚æœå˜é‡ä¸ºç©ºå°±ä¸å¼€å¯ï¼Œæ–¹ä¾¿åœ¨å¤–éƒ¨æ§åˆ¶ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥é‡æ–°å¯åŠ¨ Kafkaã€‚</p><pre><code class=\"language-json\">export JOLOKIA=true; export JMX_PORT=3457; nohup ./bin/kafka-server-start.sh config/server.properties &amp;&gt; stdout.log &amp;\n</code></pre><p>éªŒè¯ Jolokia æ˜¯å¦åœ¨æ­£å¸¸å·¥ä½œï¼Œè¯·æ±‚å…¶ /jolokia/version æ¥å£å³å¯ã€‚ä¸‹é¢æ˜¯æˆ‘çš„ç¯å¢ƒçš„è¯·æ±‚ç¤ºä¾‹ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p><pre><code class=\"language-json\"># curl -s 10.206.16.8:3456/jolokia/version | jq .\n{\n&nbsp; \"request\": {\n&nbsp; &nbsp; \"type\": \"version\"\n&nbsp; },\n&nbsp; \"value\": {\n&nbsp; &nbsp; \"agent\": \"1.6.2\",\n&nbsp; &nbsp; \"protocol\": \"7.2\",\n&nbsp; &nbsp; \"config\": {\n&nbsp; &nbsp; &nbsp; \"listenForHttpService\": \"true\",\n&nbsp; &nbsp; &nbsp; \"maxCollectionSize\": \"0\",\n&nbsp; &nbsp; &nbsp; \"authIgnoreCerts\": \"false\",\n&nbsp; &nbsp; &nbsp; \"agentId\": \"10.206.16.8-2012615-50134894-jvm\",\n&nbsp; &nbsp; &nbsp; \"debug\": \"false\",\n&nbsp; &nbsp; &nbsp; \"agentType\": \"jvm\",\n&nbsp; &nbsp; &nbsp; \"policyLocation\": \"classpath:/jolokia-access.xml\",\n&nbsp; &nbsp; &nbsp; \"agentContext\": \"/jolokia\",\n&nbsp; &nbsp; &nbsp; \"serializeException\": \"false\",\n&nbsp; &nbsp; &nbsp; \"mimeType\": \"text/plain\",\n&nbsp; &nbsp; &nbsp; \"maxDepth\": \"15\",\n&nbsp; &nbsp; &nbsp; \"authMode\": \"basic\",\n&nbsp; &nbsp; &nbsp; \"authMatch\": \"any\",\n&nbsp; &nbsp; &nbsp; \"discoveryEnabled\": \"true\",\n&nbsp; &nbsp; &nbsp; \"streaming\": \"true\",\n&nbsp; &nbsp; &nbsp; \"canonicalNaming\": \"true\",\n&nbsp; &nbsp; &nbsp; \"historyMaxEntries\": \"10\",\n&nbsp; &nbsp; &nbsp; \"allowErrorDetails\": \"true\",\n&nbsp; &nbsp; &nbsp; \"allowDnsReverseLookup\": \"true\",\n&nbsp; &nbsp; &nbsp; \"realm\": \"jolokia\",\n&nbsp; &nbsp; &nbsp; \"includeStackTrace\": \"true\",\n&nbsp; &nbsp; &nbsp; \"maxObjects\": \"0\",\n&nbsp; &nbsp; &nbsp; \"useRestrictorService\": \"false\",\n&nbsp; &nbsp; &nbsp; \"debugMaxEntries\": \"100\"\n&nbsp; &nbsp; },\n&nbsp; &nbsp; \"info\": {\n&nbsp; &nbsp; &nbsp; \"product\": \"jetty\",\n&nbsp; &nbsp; &nbsp; \"vendor\": \"Eclipse\",\n&nbsp; &nbsp; &nbsp; \"version\": \"9.4.43.v20210629\"\n&nbsp; &nbsp; }\n&nbsp; },\n&nbsp; \"timestamp\": 1669277907,\n&nbsp; \"status\": 200\n}\n</code></pre><p>ä¸Šé¢è¿”å›çš„å†…å®¹è¡¨ç¤º Jolokia åœ¨æ­£å¸¸å·¥ä½œï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ç›‘æ§ agent æ¥é‡‡é›† Jolokia çš„æ•°æ®äº†ã€‚JMX æ•°æ®åˆ†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å’Œ JVM ç›¸å…³çš„ï¼Œä¸€ç±»æ˜¯å’Œ Kafka ç›¸å…³çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ JVM ç›¸å…³çš„é‡‡é›†è§„åˆ™ã€‚</p><h2>JVM æŒ‡æ ‡</h2><p>Categraf çš„é…ç½®ç›®å½• conf ä¸‹é¢ï¼Œé»˜è®¤æœ‰ä¸€ä¸ª input.jolokia_agent_kafka çš„ç›®å½•ï¼Œæ”¾ç½®äº† Kafka çš„ Jolokia æ‹‰å–è§„åˆ™çš„æ ·ä¾‹ã€‚æŠŠ  input.jolokia_agent_kafka é‡å‘½åä¸º  input.jolokia_agentï¼Œç„¶åä¿®æ”¹æ­¤ç›®å½•ä¸‹é¢çš„ kafka.tomlï¼Œé‡ç‚¹å…³æ³¨ urls å’Œ labels ä¸¤ä¸ªé…ç½®ã€‚</p><pre><code class=\"language-json\">[[instances]]\nurls = [\"http://localhost:3456/jolokia\"]\nlabels = { cluster = \"kafka-cluster-demo\" }\n</code></pre><p>è¿™é‡Œæˆ‘å»ºè®®ä½ ç”¨ Categraf é‡‡é›†æœ¬æœºçš„ Kafkaï¼Œå¹¶ä¸ºé‡‡é›†çš„æ•°æ®é™„åŠ ä¸€ä¸ªåä¸º cluster çš„æ ‡ç­¾ã€‚å› ä¸ºä¸€ä¸ªå…¬å¸é€šå¸¸æœ‰å¤šä¸ª Kafka é›†ç¾¤ï¼Œä½¿ç”¨ cluster æ ‡ç­¾å¯ä»¥åšå‡ºåŒºåˆ†ã€‚é€šè¿‡ test å‚æ•°æµ‹è¯•ä¸€ä¸‹é‡‡é›†çš„æŒ‡æ ‡æ˜¯å¦æ­£å¸¸ã€‚</p><pre><code class=\"language-json\">./categraf --test --inputs jolokia_agent\n</code></pre><p>å¦‚æœè¾“å‡ºå¤§é‡çš„æŒ‡æ ‡ï¼Œå°±è¯´æ˜é‡‡é›†é€»è¾‘æ˜¯æ­£å¸¸çš„ï¼Œç¨ç­‰ç‰‡åˆ»ï¼Œé‡å¯ Categrafï¼Œå†å»ç›‘æ§ç³»ç»ŸæŸ¥è¯¢ä¸€ä¸‹ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦æ­£å¸¸ä¸ŠæŠ¥äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/62/c4/6232732758e3d64f9ba42c1d9ce497c4.png?wh=2972x1119\" alt=\"\"></p><p>æˆ‘ä»¬çœ‹ä¸‹å›¾ä¸­çš„æŒ‡æ ‡ï¼ŒThreadCount è¡¨ç¤º JVM é‡Œçš„çº¿ç¨‹æ•°ï¼Œç±»ä¼¼çš„è¿˜æœ‰ DaemonThreadCountï¼Œè¡¨ç¤ºåå°çº¿ç¨‹æ•°ï¼ŒPeakThreadCountè¡¨ç¤ºå†å²å³°å€¼çº¿ç¨‹æ•°ã€‚JVM è¦é‡ç‚¹å…³æ³¨ GC çš„æƒ…å†µå’Œå†…å­˜çš„æƒ…å†µï¼Œæˆ‘ä»¬çœ‹ä¸‹ç›¸å…³æŒ‡æ ‡ã€‚</p><p>GC ä¸»è¦çœ‹æ¬¡æ•°å’Œæ—¶é—´ï¼Œåˆ†ä¸º YongGC å’Œ FullGCï¼ŒYongGC å¾ˆæ­£å¸¸ï¼Œé¢‘ç‡ä¹Ÿæ¯”è¾ƒé«˜ï¼ŒFullGC æ­£å¸¸æƒ…å†µä¸‹å¾ˆå°‘å‘ç”Ÿï¼Œå¦‚æœç»å¸¸å‘ç”Ÿï¼ŒFullGC ç¨‹åºçš„æ€§èƒ½å°±ä¼šå—å½±å“ã€‚GC æ¬¡æ•°çš„æŒ‡æ ‡æ˜¯kafka_java_garbage_collector_CollectionCountï¼Œæ˜¯ä¸€ä¸ª Counter ç±»å‹å•è°ƒé€’å¢çš„å€¼ã€‚GC æ—¶é—´çš„æŒ‡æ ‡æ˜¯ kafka_java_garbage_collector_CollectionTimeï¼Œä¹Ÿæ˜¯ä¸€ä¸ª Counter ç±»å‹å•è°ƒé€’å¢çš„å€¼ã€‚è¿™ç±»æŒ‡æ ‡æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ increase æˆ– irate å‡½æ•°è®¡ç®—å¢é‡æˆ–é€Ÿç‡ï¼Œä¸å…³å¿ƒå½“å‰å€¼æ˜¯å¤šå°‘ã€‚</p><p>å†…å­˜çš„æŒ‡æ ‡æ˜¯ kafka_java_memory_pool_Usage_usedï¼Œå•ä½æ˜¯ byteã€‚æœ‰ä¸ª name æ ‡ç­¾æ ‡è¯†äº†å…·ä½“æ˜¯å“ªä¸ªåŒºåŸŸçš„å†…å­˜å¤§å°ï¼Œæ¯”å¦‚ Eden åŒºã€Survivor åŒºã€Old åŒºã€‚ä¸‹é¢ä»ªè¡¨ç›˜çš„ä¸­é—´éƒ¨åˆ†ï¼Œå°±æ˜¯è¿™ä¸ªå†…å­˜æŒ‡æ ‡ï¼Œå˜åŒ–æ¯”è¾ƒå‰§çƒˆçš„æ˜¯ Eden åŒºï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼š GC ä¸€æ¬¡ï¼ŒEden åŒºçš„å†…å­˜ä½¿ç”¨é‡å°±ä¼šé™ä¸‹æ¥ï¼Œè¿‡æ®µæ—¶é—´åˆä¼šéšç€ä½¿ç”¨è€Œä¸Šå‡ï¼Œç„¶åå†æ¬¡ GCï¼Œé‡åˆä¼šé™ä¸‹æ¥ï¼Œå¾ªç¯å¾€å¤ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c9/18/c969cb5166a66c3a6a02f907c9f2fc18.png?wh=2990x1534\" alt=\"\"></p><p>æ‰€æœ‰ Java ç±»ç¨‹åºï¼Œéƒ½éœ€è¦å…³æ³¨è¿™äº› JVM çš„æŒ‡æ ‡ï¼Œç›¸å…³æŒ‡æ ‡çš„é‡‡é›†æ–¹æ³•åœ¨ kafka.toml ä¸­æœ‰æ ·ä¾‹ï¼Œå°±æ˜¯è¿™äº› java.lang æ‰“å¤´çš„ MBeanã€‚</p><pre><code class=\"language-json\">[[instances.metric]]\n  name  = \"java_runtime\"\n  mbean = \"java.lang:type=Runtime\"\n  paths = [\"Uptime\"]\n\n[[instances.metric]]\n  name  = \"java_memory\"\n  mbean = \"java.lang:type=Memory\"\n  paths = [\"HeapMemoryUsage\", \"NonHeapMemoryUsage\", \"ObjectPendingFinalizationCount\"]\n\n[[instances.metric]]\n  name     = \"java_garbage_collector\"\n  mbean    = \"java.lang:name=*,type=GarbageCollector\"\n  paths    = [\"CollectionTime\", \"CollectionCount\"]\n  tag_keys = [\"name\"]\n\n[[instances.metric]]\n  name  = \"java_last_garbage_collection\"\n  mbean = \"java.lang:name=G1 Young Generation,type=GarbageCollector\"\n  paths = [\"LastGcInfo/duration\"]\n  # paths = [\"LastGcInfo/duration\", \"LastGcInfo/GcThreadCount\", \"LastGcInfo/memoryUsageAfterGc\"]\n\n[[instances.metric]]\n  name  = \"java_threading\"\n  mbean = \"java.lang:type=Threading\"\n  paths = [\"TotalStartedThreadCount\", \"ThreadCount\", \"DaemonThreadCount\", \"PeakThreadCount\"]\n\n[[instances.metric]]\n  name  = \"java_class_loading\"\n  mbean = \"java.lang:type=ClassLoading\"\n  paths = [\"LoadedClassCount\", \"UnloadedClassCount\", \"TotalLoadedClassCount\"]\n\n[[instances.metric]]\n  name     = \"java_memory_pool\"\n  mbean    = \"java.lang:name=*,type=MemoryPool\"\n  paths    = [\"Usage\", \"PeakUsage\", \"CollectionUsage\"]\n  tag_keys = [\"name\"]\n</code></pre><p>åˆ°è¿™é‡Œï¼ŒJVM çš„å¸¸è§„æŒ‡æ ‡æˆ‘ä»¬å°±è®²å®Œäº†ã€‚å¦‚æœä½ æƒ³é‡‡é›†å…¶ä»–æŒ‡æ ‡ï¼Œå¯ä»¥ä½¿ç”¨ JConsole è¿åˆ° JMX ç«¯å£ï¼ŒæŸ¥çœ‹ç›¸å…³ MBean çš„ä¿¡æ¯ï¼Œåœ¨ Categraf é‡Œæ–°å¢  <code>[[instances.metric]]</code> çš„é…ç½®å³å¯ã€‚kafka.toml ä¸­è¿˜æœ‰å¾ˆå¤š Kafka Broker çš„ JMX æŒ‡æ ‡ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ¢ç©¶ç«Ÿã€‚</p><h2>Kafka æŒ‡æ ‡</h2><p>Kafka çš„æŒ‡æ ‡å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå…¶ä¸­æœ‰äº›æŒ‡æ ‡åªæ˜¯ä¸ºäº†è°ƒè¯•è€Œè®¾ç½®çš„ã€‚å“ªäº›æŒ‡æ ‡æ›´ä¸ºå…³é”®ï¼Œåº”è¯¥é…ç½®å‘Šè­¦ï¼Œå“ªäº›åº”è¯¥æ”¾åˆ°ä»ªè¡¨ç›˜é‡Œï¼Œå“ªäº›å‹æ ¹å°±æ— éœ€å…³æ³¨ï¼Œæ¯”è¾ƒéš¾æ¢³ç†ï¼Œå¥½åœ¨ç›®å‰è¿™æ–¹é¢çš„èµ„æ–™æ¯”è¾ƒä¸°å¯Œï¼Œä¸€å®šç¨‹åº¦ä¸Šæ˜¯æœ‰å…±è¯†çš„ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥è®²ä¸€ä¸‹è¿™äº›å…±è¯†æ€§çš„å…³é”®æŒ‡æ ‡ã€‚</p><h3>æ´»è·ƒæ§åˆ¶å™¨æ•°é‡</h3><p><strong>MBeanï¼šbroker kafka.controller:type=KafkaController,name=ActiveControllerCount</strong></p><p>ä¸€ä¸ª Kafka é›†ç¾¤æœ‰å¤šä¸ª Brokerï¼Œæ­£å¸¸æ¥è®²å…¶ä¸­ä¸€ä¸ª Broker ä¼šæ˜¯æ´»è·ƒæ§åˆ¶å™¨ï¼Œä¸”åªèƒ½æœ‰ä¸€ä¸ªã€‚ä»æ•´ä¸ªé›†ç¾¤è§’åº¦æ¥çœ‹ï¼ŒSUM æ‰€æœ‰ Broker çš„è¿™ä¸ªæŒ‡æ ‡ï¼Œç»“æœåº”è¯¥ä¸º1ã€‚å¦‚æœSUMçš„ç»“æœä¸º2ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰ä¸¤ä¸ª Broker éƒ½è®¤ä¸ºè‡ªå·±æ˜¯æ´»è·ƒæ§åˆ¶å™¨ã€‚è¿™å¯èƒ½æ˜¯ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„ï¼Œéœ€è¦é‡å¯ Kafka Broker è¿›ç¨‹ã€‚å¦‚æœé‡å¯äº†ä¸å¥½ä½¿ï¼Œå¯èƒ½æ˜¯ä¾èµ–çš„ ZooKeeper å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œéœ€è¦å…ˆå»è§£å†³ ZooKeeper çš„é—®é¢˜ï¼Œç„¶åé‡å¯ Broker è¿›ç¨‹ã€‚</p><h3>éåŒæ­¥åˆ†åŒºæ•°é‡</h3><p><strong>MBeanï¼škafka.server:type=ReplicaManager,name=UnderReplicatedPartitions</strong></p><p>è¿™ä¸ªæŒ‡æ ‡æ˜¯å¯¹æ¯ä¸ª Topic çš„æ¯ä¸ªåˆ†åŒºçš„ç»Ÿè®¡ï¼Œå¦‚æœæŸä¸ªåˆ†åŒºä¸»ä»åŒæ­¥å‡ºç°é—®é¢˜ï¼Œå¯¹åº”çš„æ•°å€¼å°±ä¼šå¤§äº0ã€‚å¸¸è§çš„åŸå› æ¯”å¦‚æŸä¸ª Broker å‡ºé—®é¢˜äº†ï¼Œä¸€èˆ¬æ˜¯Kafka è¿›ç¨‹é—®é¢˜æˆ–è€…æ‰€åœ¨æœºå™¨çš„ç¡¬ä»¶é—®é¢˜ï¼Œé‚£ä¹ˆè·Ÿè¿™ä¸ª Broker ç›¸å…³çš„åˆ†åŒºå°±å…¨éƒ¨éƒ½æœ‰é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å‡ºé—®é¢˜çš„åˆ†åŒºæ•°é‡å¤§è‡´æ˜¯æ’å®šçš„ã€‚å¦‚æœå‡ºé—®é¢˜çš„åˆ†åŒºæ•°é‡ä¸æ’å®šï¼Œå¯èƒ½æ˜¯é›†ç¾¤æ€§èƒ½é—®é¢˜å¯¼è‡´çš„ï¼Œéœ€è¦æ£€æŸ¥ç¡¬ç›˜I/Oã€CPUä¹‹ç±»çš„æŒ‡æ ‡ã€‚</p><h3>ç¦»çº¿åˆ†åŒºæ•°é‡</h3><p><strong>MBeanï¼škafka.controller:type=KafkaController,name=OfflinePartitionsCount</strong></p><p>è¿™ä¸ªæŒ‡æ ‡åªæœ‰é›†ç¾¤æ§åˆ¶å™¨æ‰æœ‰ï¼Œå…¶ä»– Broker è¿™ä¸ªæŒ‡æ ‡çš„å€¼æ˜¯ 0ï¼Œè¡¨ç¤ºé›†ç¾¤é‡Œæ²¡æœ‰ leader çš„åˆ†åŒºæ•°é‡ã€‚Kafka ä¸»è¦é  leader å‰¯æœ¬æä¾›è¯»å†™èƒ½åŠ›ï¼Œå¦‚æœæœ‰äº›åˆ†åŒºæ²¡æœ‰ leader å‰¯æœ¬äº†ï¼Œæ˜¾ç„¶å°±æ— æ³•è¯»å†™äº†ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ã€‚</p><h3>ç¦»çº¿æ—¥å¿—ç›®å½•æ•°é‡</h3><p><strong>MBeanï¼škafka.log:type=LogManager,name=OfflineLogDirectoryCount</strong></p><p>Kafka æ˜¯æŠŠæ”¶åˆ°çš„æ¶ˆæ¯å­˜å…¥ log ç›®å½•ï¼Œå¦‚æœ log ç›®å½•æœ‰é—®é¢˜ï¼Œæ¯”å¦‚å†™æ»¡äº†ï¼Œå°±ä¼šè¢«ç½®ä¸º Offlineï¼ŒåŠæ—¶ç›‘æ§ç¦»çº¿æ—¥å¿—ç›®å½•çš„æ•°é‡æ˜¾ç„¶éå¸¸æœ‰å¿…è¦ã€‚å¦‚æœè¿™ä¸ªå€¼å¤§äº 0ï¼Œæˆ‘ä»¬æƒ³è¿›ä¸€æ­¥çŸ¥é“å…·ä½“æ˜¯å“ªä¸ªç›®å½•å‡ºé—®é¢˜äº†ï¼Œå¯ä»¥æŸ¥è¯¢ MBeanï¼škafka.log:type=LogManager,name=LogDirectoryOffline,logDirectory=*\"ï¼ŒLogDirectory å­—æ®µä¼šæ ‡æ˜å…·ä½“æ˜¯å“ªä¸ªç›®å½•ã€‚</p><h3>æµå…¥æµå‡ºå­—èŠ‚å’Œæµå…¥æ¶ˆæ¯</h3><p>è¿™æ˜¯å…¸å‹çš„ååæŒ‡æ ‡ï¼Œæ—¢æœ‰ Broker ç²’åº¦çš„ï¼Œä¹Ÿæœ‰ Topic ç²’åº¦çš„ï¼Œåå­—éƒ½ä¸€æ ·ï¼ŒTopic ç²’åº¦çš„æŒ‡æ ‡æ•°æ® MBean ObjectName ä¼šå¤šä¸€ä¸ª topic=xx çš„åç¼€ã€‚</p><h4>æµå…¥å­—èŠ‚</h4><p><strong>MBeanï¼škafka.server:type=BrokerTopicMetrics,name=BytesInPerSec</strong></p><p>è¿™ä¸ªæŒ‡æ ‡ Kafka åœ¨ä½¿ç”¨ Yammer Metrics åŸ‹ç‚¹çš„æ—¶å€™ï¼Œè®¾ç½®ä¸ºäº† Meter ç±»å‹ï¼Œæ‰€ä»¥ Yammer ä¼šè‡ªåŠ¨è®¡ç®—å‡º Countã€OneMinuteRateã€FiveMinuteRateã€FifteenMinuteRateã€MeanRate ç­‰æŒ‡æ ‡ï¼Œä¹Ÿå°±æ˜¯1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿå†…çš„å¹³å‡æµå…¥é€Ÿç‡ï¼Œä»¥åŠæ•´ä½“å¹³å‡æµå…¥é€Ÿç‡ã€‚è€Œ Count è¡¨ç¤ºæ€»é‡ï¼Œå¦‚æœæ—¶åºåº“æ”¯æŒ PromQLï¼Œæˆ‘ä»¬å°±åªé‡‡é›† Countï¼Œå…¶ä»–çš„ä¸ç”¨é‡‡é›†ï¼Œåé¢ä½¿ç”¨ PromQL å¯¹ Count å€¼åš irate è®¡ç®—å³å¯ã€‚</p><h4>æµå‡ºå­—èŠ‚</h4><p><strong>MBeanï¼škafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec</strong></p><p>å’Œ BytesInPerSec ç±»ä¼¼ï¼Œè¡¨ç¤ºå‡ºå‘æµé‡ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæµå‡ºå­—èŠ‚é™¤äº†æ™®é€šæ¶ˆè´¹è€…çš„æ¶ˆè´¹æµé‡ï¼Œä¹ŸåŒ…å«äº†å‰¯æœ¬åŒæ­¥æµé‡ã€‚</p><h4>æµå…¥æ¶ˆæ¯</h4><p><strong>MBeanï¼škafka.server:type=BrokerTopicMetrics,name=MessagesInPerSec</strong></p><p>BytesInPerSec å’Œ BytesOutPerSec éƒ½æ˜¯ä»¥ byte ä¸ºå•ä½ç»Ÿè®¡çš„ï¼Œè€ŒMessagesInPerSec æ˜¯ä»¥æ¶ˆæ¯ä¸ªæ•°ä¸ºå•ä½ç»Ÿè®¡çš„ï¼Œä¹Ÿæ˜¯ Meter ç±»å‹ï¼Œç›¸å…³å±æ€§éƒ½ä¸€æ ·ã€‚</p><p>éœ€è¦è§£é‡Šä¸€ä¸‹çš„æ˜¯ï¼ŒKafka ä¸æä¾› MessagesOutPerSecï¼Œä½ å¯èƒ½è§‰å¾—æœ‰ç‚¹å„¿å¥‡æ€ªï¼Œæœ‰å…¥å°±å¾—æœ‰å‡ºæ‰æ­£å¸¸å˜›ã€‚è¿™æ˜¯å› ä¸ºæ¶ˆæ¯è¢«æ‹‰å–çš„æ—¶å€™ï¼ŒBroker ä¼šæŠŠæ•´ä¸ªâ€œæ¶ˆæ¯æ‰¹æ¬¡â€å‘é€ç»™æ¶ˆè´¹è€…ï¼Œå¹¶ä¸ä¼šå±•å¼€â€œæ‰¹æ¬¡â€ï¼Œä¹Ÿå°±æ²¡æ³•è®¡ç®—å…·ä½“æœ‰å¤šå°‘æ¡æ¶ˆæ¯äº†ã€‚</p><h3>åˆ†åŒºæ•°é‡</h3><p><strong>MBeanï¼škafka.server:type=ReplicaManager,name=PartitionCount</strong></p><p>è¿™ä¸ªæŒ‡æ ‡è¡¨ç¤ºæŸä¸ª Broker ä¸Šé¢æ€»å…±æœ‰å¤šå°‘ä¸ªåˆ†åŒºï¼ŒåŒ…æ‹¬ leader åˆ†åŒºå’Œ follower åˆ†åŒºã€‚å¦‚æœå¤šä¸ª Broker åˆ†åŒºä¸å‡è¡¡ï¼Œå¯èƒ½ä¼šé€ æˆæœ‰äº› Broker æ¶ˆè€—ç¡¬ç›˜ç©ºé—´è¿‡å¿«ï¼Œè¿™æ˜¯éœ€è¦æ³¨æ„çš„ã€‚</p><h3>leader åˆ†åŒºæ•°é‡</h3><p><strong>MBeanï¼škafka.server:type=ReplicaManager,name=LeaderCount</strong></p><p>è¿™ä¸ªæŒ‡æ ‡è¡¨ç¤ºæŸä¸ª Broker ä¸Šé¢æ€»å…±æœ‰å¤šå°‘ä¸ª leader åˆ†åŒºï¼Œleader åˆ†åŒºè´Ÿè´£æ•°æ®è¯»å†™ï¼Œæ‰¿æ¥æµé‡ï¼Œæ‰€ä»¥ leader åˆ†åŒºå¦‚æœä¸å‡è¡¡ï¼Œä¼šå¯¼è‡´æŸäº› Broker è¿‡åˆ†ç¹å¿™è€Œå¦ä¸€äº› Broker è¿‡åˆ†ç©ºé—²ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯éœ€è¦æˆ‘ä»¬æ³¨æ„çš„ã€‚</p><p>é’ˆå¯¹ä»¥ä¸Šå…³é”®æŒ‡æ ‡æˆ‘åˆ¶ä½œäº†ä¸€å¼ <a href=\"https://github.com/flashcatcloud/categraf/blob/main/inputs/kafka/dashboard-key-metrics.json\">ä»ªè¡¨ç›˜</a>ï¼Œä¾›ä½ å‚è€ƒï¼ŒåŒæ—¶ä¹Ÿæ¬¢è¿ä½ ä¸€èµ·æ¥å®Œå–„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/63/5a/63e093297a9a094fb706e9660a9f0e5a.png?wh=2972x1100\" alt=\"\"></p><p>Kafka JMX å…³é”®æŒ‡æ ‡ï¼Œæˆ‘ä»¬å°±è®²è§£åˆ°è¿™é‡Œã€‚æœ€åä¸€ä¸ªå…³é”®ç‚¹æ˜¯ consumer lag ç›‘æ§ï¼Œä¿—ç§°æ¶ˆæ¯é˜Ÿåˆ—å †ç§¯ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ã€‚</p><h2>Lag ç›‘æ§</h2><p>æ¯ä¸ª Topic ä¼šåˆ†æˆå¤šä¸ª Partitionï¼Œæ¯ä¸ª Partition éƒ½æœ‰ä¸€ä¸ªå½“å‰çš„ offsetï¼Œè¡¨ç¤ºç”Ÿäº§çš„æ¶ˆæ¯å·²ç»å †ç§¯åˆ°äº†ä»€ä¹ˆä½ç½®ã€‚æ¯ä¸ª Partition å¯ä»¥è¢«å¤šä¸ª consumergroup æ¶ˆè´¹ï¼Œconsumergroup æ¶ˆè´¹çš„æ—¶å€™ï¼Œé’ˆå¯¹æŸä¸ª Partition ä¹Ÿä¼šæœ‰ä¸€ä¸ª offset è¡¨ç¤ºæ¶ˆè´¹ä½ç½®ã€‚ç”Ÿäº§è€…çš„ offset å‡å» consumergroup çš„ offsetï¼Œå°±è¡¨ç¤ºæ»åé‡ã€‚</p><p>è¿™ä¸ªæ»åé‡å¦‚æœè¿‡å¤§ï¼Œå°±è¡¨ç¤ºæ¶ˆè´¹è€…å¯èƒ½é‡åˆ°äº†é—®é¢˜ï¼Œæ²¡æœ‰åŠæ—¶å¹²æ´»ï¼Œè¿™æ˜¯ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚æ¯”å¦‚ç›‘æ§æ•°æ®å¯¹å³æ—¶æ€§è¦æ±‚å°±å¾ˆé«˜ï¼Œå¦‚æœé€šè¿‡ Kafka ä¼ è¾“ç›‘æ§æ•°æ®ï¼Œä½†æ»åé‡å¾ˆå¤§ï¼Œæœ€åå‘ˆç°ç»™ç”¨æˆ·çš„å›¾è¡¨å¯èƒ½æ˜¯å‡ åˆ†é’Ÿä¹‹å‰çš„æ•°æ®ï¼Œé‚£æ„ä¹‰å°±ä¸å¤§äº†ã€‚</p><p>ç›‘æ§ Lag æ•°æ®æœ‰ä¸¤ä¸ªåŠæ³•ï¼Œä¸€ä¸ªæ˜¯ä» consumer çš„ JMX ä¸­è·å–ï¼Œä¸è¿‡åªæœ‰ Java çš„ç¨‹åºæ‰èƒ½è¿™ä¹ˆåšï¼›ä¸€ä¸ªæ˜¯é€šè¿‡ç½‘ç»œä¸Šçš„ä¸€äº› Exporterè·å–ï¼Œå› ä¸º Lag æ•°æ®å¤ªé‡è¦äº†ï¼Œæ‰€ä»¥æœ‰äººä¸“é—¨å†™äº† Exporter æ¥é‡‡é›†ã€‚å¾ˆå¤š consumer éƒ½æ˜¯é Java è¯­è¨€å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é‡ç‚¹ä»‹ç» Exporter çš„æ–¹æ¡ˆã€‚</p><p>æ»åæ€§ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·®å€¼æ•°é‡ï¼Œè¿™ä¸ªä¸å¤ªæ–¹ä¾¿è®¾ç½®å‘Šè­¦è§„åˆ™ï¼Œå› ä¸ºä¸€äº›æ¶ˆæ¯é‡å·¨å¤§çš„ Topic Lag å€¼çœ‹èµ·æ¥å¾ˆå¤§ï¼Œä½†æ˜¯å¾ˆå¿«å°±æ¶ˆè´¹å®Œäº†ï¼Œæœ‰äº›æ¶ˆæ¯é‡å¾ˆå°çš„ Topicï¼Œconsumer å¯èƒ½éƒ½æŒ‚äº†ï¼Œä½†æ˜¯ Lag å€¼ä»ç„¶å¾ˆå°ã€‚è¦æ˜¯èƒ½é¢„ä¼°ä¸€ä¸‹é˜Ÿåˆ—é‡Œçš„æ¶ˆè´¹æ—¶é•¿å°±å¥½äº†ï¼Œå‚è€ƒå†å²æ•°æ®æƒ…å†µè¿›è¡Œé¢„ä¼°ï¼Œå¦‚æœè¿™ä¸ªé¢„ä¼°çš„æ—¶é•¿å˜å¤§äº†ï¼Œå°±è¡¨ç¤ºæœ‰é—®é¢˜äº†ã€‚å…¶å®ï¼Œè¿˜çœŸæœ‰è¿™æ ·çš„ <a href=\"https://github.com/davidmparrott/kafka_exporter\">Exporter</a>ï¼ŒCategraf å°±ç›´æ¥é›†æˆçš„è¿™ä¸ª Exporter çš„ä»£ç ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p>Categraf ä¸­æ€ä¹ˆé…ç½® Kafka çš„ Lag ç›‘æ§å‘¢ï¼Ÿä½¿ç”¨ kafka é‡‡é›†æ’ä»¶ï¼Œé…ç½®æ–‡ä»¶åœ¨ conf/input.kafka/kafka.tomlï¼Œæœ€æ ¸å¿ƒçš„é…ç½®æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ labelsï¼Œä¸€ä¸ªæ˜¯ kafka_urisï¼Œä½ å¯ä»¥çœ‹ä¸‹é…ç½®æ ·ä¾‹ã€‚</p><pre><code class=\"language-json\">[[instances]]\nlabels = { cluster=\"tencent-dev\" }\nlog_level = \"error\"\nkafka_uris = [\"10.206.16.3:9092\"]\n</code></pre><p>åœ¨ labels ä¸­ï¼Œæˆ‘è¿˜æ˜¯å»ºè®®ä½ åŠ ä¸€ä¸ª cluster æ ‡ç­¾ã€‚å› ä¸ºä¸€ä¸ªå…¬å¸ä¸€èˆ¬æœ‰å¤šä¸ª Kafka é›†ç¾¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ ‡ç­¾åŒºåˆ†ï¼Œå…¶æ¬¡å°±æ˜¯ kafka_urisï¼Œä¸€èˆ¬å†™ä¸€ä¸¤ä¸ªå°±å¯ä»¥äº†ï¼Œä¸ç”¨æŠŠæ‰€æœ‰ Broker åœ°å€å…¨éƒ¨å†™ä¸Šï¼ŒCategraf ä¼šä½œä¸ºä¸€ä¸ª Kafka client è¿ä¸Šé›†ç¾¤ï¼Œè¯»å– offset æ•°æ®ã€‚å¦‚æœæ˜¯è€é›†ç¾¤ï¼Œoffset ä¿¡æ¯å­˜åœ¨ ZooKeeper ä¸Šï¼Œè¿™ä¸ªæ—¶å€™å°±è¦è®¾ç½® use_zookeeper_lag = trueï¼Œå¹¶é€šè¿‡ zookeeper_uris æ”¹å†™ ZooKeeper çš„è¿æ¥åœ°å€ã€‚</p><p>Kafka è¿™ä¸ªé‡‡é›†æ’ä»¶ï¼Œé‡‡é›†çš„æœ€æ ¸å¿ƒçš„æŒ‡æ ‡æ˜¯ kafka_consumer_lag_millisï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹æ ·ä¾‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/13/fb/13e9c573061a675a223131cfd18bd7fb.png?wh=3950x1658\" alt=\"\"></p><p>æŒ‡æ ‡å•ä½æ˜¯æ¯«ç§’ï¼Œå°±æ˜¯ä¸€ä¸ªé¢„ä¼°æ¶ˆè´¹æ—¶é•¿ï¼Œè¿™ä¸ªæŒ‡æ ‡æˆ‘ä¹Ÿæ”¾åˆ°äº†<a href=\"https://github.com/flashcatcloud/categraf/blob/main/inputs/kafka/dashboard-key-metrics.json\">ä»ªè¡¨ç›˜</a>ä¸­ï¼Œä½ å¯ä»¥ç›´æ¥å¯¼å…¥å¤œèºä½¿ç”¨ï¼Œæˆ–è€…å‚è€ƒé‡Œè¾¹çš„ PromQL è‡ªå·±åˆ¶ä½œ Grafana å¤§ç›˜ã€‚åˆ°è¿™é‡Œï¼ŒKafka ç›‘æ§çš„å…³é”®ç‚¹å°±ä»‹ç»å®Œäº†ï¼Œè¿™ä¸€è®²çš„å†…å®¹æœ‰ç‚¹å„¿é•¿ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åšä¸€ä¸ªæ€»ç»“ã€‚</p><h2>å°ç»“</h2><p>Kafka æ˜¯ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸­éå¸¸å¸¸è§çš„ç»„ä»¶ï¼ŒKafka è¿è¡Œæ˜¯å¦æ­£å¸¸ï¼Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯å¦æ­£å¸¸ï¼Œéƒ½éœ€è¦é‡ç‚¹å…³æ³¨ã€‚ç›‘æ§å¯ä»¥ä»4ä¸ªå±‚é¢ç€æ‰‹ï¼Œæœºå™¨ã€JVMã€Kafka Brokerã€Lagã€‚å½“ç„¶ï¼ŒZooKeeper ä½œä¸º Kafka é‡åº¦ä¾èµ–ç»„ä»¶ï¼Œä¹Ÿéœ€è¦ç›‘æ§ï¼Œè¿˜æœ‰å°±æ˜¯ producer å’Œ consumer ä¹Ÿæ˜¯éœ€è¦ç›‘æ§çš„ã€‚ä¸è¿‡é‚£æ˜¯åº”ç”¨ç¨‹åºå±‚é¢çš„ç›‘æ§äº†ï¼Œéœ€è¦ç ”å‘äººå‘˜ååŒæ¥åšï¼Œä½œä¸ºç»„ä»¶å¹³å°æ–¹æ¥è®²ï¼Œæˆ‘ä»¬é‡ç‚¹è¿˜æ˜¯æ”¾åœ¨ Broker å±‚é¢ã€‚</p><p>æœºå™¨ç›‘æ§å±‚é¢ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨CPUã€ç¡¬ç›˜I/Oã€ç½‘ç»œI/Oï¼Œä»¥åŠ Kafka è¿›ç¨‹å±‚é¢å ç”¨çš„èµ„æºï¼Œæ¯”å¦‚æ‰“å¼€äº†å¤šå°‘æ–‡ä»¶å¥æŸ„ï¼Œæœ€å¤§å¯ä»¥æ‰“å¼€å¤šå°‘å¥æŸ„ç­‰ã€‚</p><p>JVM ç›‘æ§å±‚é¢ï¼Œé‡ç‚¹å…³æ³¨ GC å’Œå†…å­˜çš„æƒ…å†µï¼Œå¦‚æœé¢‘ç¹å‘ç”Ÿ Old åŒº Full GCï¼ŒKafka æ€§èƒ½è‚¯å®šä¼šå—å½±å“ã€‚æ‰€æœ‰ Java ç¨‹åºéƒ½åº”è¯¥ç›‘æ§ JVMï¼Œæ¯”å¦‚ Tomcatã€JBossã€Hadoopï¼Œèµ° JMX è¿™ä¸ªè·¯å¾„æ˜¯ä¸€ä¸ªå…¸å‹çš„æ–¹å¼ã€‚</p><p>Kafka Broker JMX æŒ‡æ ‡ï¼Œé‡ç‚¹å…³æ³¨ä¸€äº›å¤§é¢ä¸Šçš„å¼‚å¸¸æŒ‡æ ‡ï¼ŒKafka æš´éœ²äº†å¤ªå¤šçš„ JMX æŒ‡æ ‡ï¼Œå¦‚æœæ— æ³•æŠ“å–åˆ°å…³é”®æŒ‡æ ‡ï¼ŒKafka ç›‘æ§ç»å¯¹æ˜¯å™©æ¢¦ã€‚</p><p>Lag ç›‘æ§ï¼Œä¹Ÿå°±æ˜¯ Topic Partition çš„æ¶ˆè´¹è€…æ»åç›‘æ§ï¼Œæ˜¯ Queue ç±»ç¨‹åºéœ€è¦å…³æ³¨çš„å…¸å‹æŒ‡æ ‡ã€‚å› ä¸ºä¸€æ—¦æ¶ˆè´¹è€…è·Ÿä¸ä¸Šç”Ÿäº§è€…çš„é€Ÿåº¦ï¼Œæ¶ˆæ¯å°±ä¼šç§¯å‹ï¼Œæ•°æ®å³æ—¶æ€§ä¹Ÿå°±ä¼šå—å¾ˆå¤§å½±å“ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4y/61/4yy986291dd9dfe6976d839bcbcc9161.jpg?wh=2339x2470\" alt=\"\"></p><h2>äº’åŠ¨æ—¶åˆ»</h2><p>Kafka Broker çš„ JMX æŒ‡æ ‡å¾ˆå¤šï¼Œé™¤äº†è¿™ä¸€è®²æˆ‘ä»¬ä»‹ç»çš„è¿™äº›ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸å°‘å…³é”®æŒ‡æ ‡ï¼Œæ¯”å¦‚é’ˆå¯¹ Kafka Broker æ”¶åˆ°çš„ requestï¼Œå°±æœ‰æŒ‡æ ‡æ¥ç»Ÿè®¡ååå’Œå»¶æ—¶ã€‚ä½ èƒ½å¦é€šè¿‡ JConsole æ‰¾åˆ° ListGroups è¿™ä¸ª request æ¯ç§’è¯·æ±‚æ•°çš„ MBeanï¼Ÿèƒ½å¦ç…§çŒ«ç”»è™ç»™å‡º Jolokia æŠ“å–è¿™ä¸ª MBean çš„é…ç½®ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„ç­”æ¡ˆï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>","neighbors":{"left":{"article_title":"14ï½œç»„ä»¶ç›‘æ§ï¼šRedisçš„å…³é”®æŒ‡æ ‡åŠé‡‡é›†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ","id":627869},"right":{"article_title":"16ï½œç»„ä»¶ç›‘æ§ï¼šElasticsearchçš„å…³é”®æŒ‡æ ‡åŠé‡‡é›†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ","id":628847}},"comments":[{"had_liked":false,"id":368217,"user_name":"å·´è¾‰ç‰¹","can_delete":false,"product_type":"c1","uid":1001078,"ip_address":"åŒ—äº¬","ucode":"DCBB150A99548D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","comment_is_top":true,"comment_ctime":1676015519,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"å…³äº jmx_exporter çš„æè¿°æœ‰è¯¯ï¼Œç‰¹åšå‹˜è¯¯ï¼Œå…·ä½“æµ‹è¯•è¿‡ç¨‹å¦‚ä¸‹ï¼šhttps:&#47;&#47;mp.weixin.qq.com&#47;s&#47;_RLYGuGdz-gvuqZfg1_rFg ä¾›å„ä½å°ä¼™ä¼´å‚è€ƒ","like_count":0},{"had_liked":false,"id":368187,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1675993492,"is_pvip":false,"replies":[{"id":134062,"content":"1ï¼Œjolokiaæˆ–è€…jmx_exporteréƒ½æ˜¯javaagentï¼Œæ³¨å…¥åˆ°kafkaçš„jvmé‡Œè¿è¡Œçš„ï¼Œjolokiaæš´éœ²httpæ¥å£ï¼Œcategrafä»è¿™ä¸ªhttpæ¥å£æŠ“æ•°æ®ï¼Œç„¶åä¸ŠæŠ¥ç»™ç›‘æ§æœåŠ¡ç«¯\n\n2ï¼Œç†è®ºä¸Šï¼Œè¿›æ¥å¤šå°‘æµé‡ï¼Œå°±å¾—åŒæ­¥å¤šå°‘æµé‡ç»™å‰¯æœ¬ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼ŒBytesOutPerSec - BytesInPerSec*1 å°±æ˜¯ä¸šåŠ¡æ¶ˆè´¹æµé‡ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼ŒBytesOutPerSec - BytesInPerSec*2 å°±æ˜¯ä¸šåŠ¡æ¶ˆè´¹æµé‡\n\n3ï¼Œæ˜¯å¤œèºçš„ï¼Œä¸è¿‡ä¹Ÿæ˜¯åŸºäºPromQLçš„ï¼Œå¯ä»¥æ‰‹å·¥è½¬æˆGrafanaçš„å¤§ç›˜ã€‚Prometheusè‡ªèº«æ˜¯æ²¡æœ‰å¤§ç›˜çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1676003561,"ip_address":"åŒ—äº¬","comment_id":368187,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š\nQ1ï¼šæµç¨‹ç†è§£æ˜¯å¦å¯¹ï¼Ÿ\nA categraféƒ¨ç½²åœ¨kafkaä¸Šï¼Œé‡‡é›†æŒ‡æ ‡æ•°æ®ï¼Œç„¶åå‘é€ç»™jolokiaï¼Œjolokiaå°†æ•°æ®è½¬æ¢ä¸ºHTTPåè®®åå‘é€åˆ°ç›‘æ§ç³»ç»Ÿã€‚B categrafå’Œjolokiaéƒ½ä½äºkafkaç«¯ï¼Œç›‘æ§ç³»ç»Ÿç±»ä¼¼äºserverç«¯ã€‚ è¿™æ ·ç†è§£å¯¹å—ï¼Ÿ\nQ2ï¼šæ€ä¹ˆçŸ¥é“æ¶ˆè´¹æµé‡ï¼Ÿ\nBytesOutPerSecé™¤äº†åŒ…å«æ™®é€šæ¶ˆè´¹è€…çš„æ¶ˆè´¹æµé‡ï¼Œä¹ŸåŒ…å«äº†å‰¯æœ¬åŒæ­¥æµé‡ï¼Œé‚£ä¹ˆæ€ä¹ˆçŸ¥é“æ™®é€šæ¶ˆè´¹è€…çš„æ¶ˆè´¹æµé‡ï¼Ÿ\nQ3ï¼šå…³é”®æŒ‡æ ‡çš„ä»ªè¡¨ç›˜æ˜¯Prometheusçš„å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603175,"discussion_content":"1ï¼Œjolokiaæˆ–è€…jmx_exporteréƒ½æ˜¯javaagentï¼Œæ³¨å…¥åˆ°kafkaçš„jvmé‡Œè¿è¡Œçš„ï¼Œjolokiaæš´éœ²httpæ¥å£ï¼Œcategrafä»è¿™ä¸ªhttpæ¥å£æŠ“æ•°æ®ï¼Œç„¶åä¸ŠæŠ¥ç»™ç›‘æ§æœåŠ¡ç«¯\n\n2ï¼Œç†è®ºä¸Šï¼Œè¿›æ¥å¤šå°‘æµé‡ï¼Œå°±å¾—åŒæ­¥å¤šå°‘æµé‡ç»™å‰¯æœ¬ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼ŒBytesOutPerSec - BytesInPerSec*1 å°±æ˜¯ä¸šåŠ¡æ¶ˆè´¹æµé‡ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼ŒBytesOutPerSec - BytesInPerSec*2 å°±æ˜¯ä¸šåŠ¡æ¶ˆè´¹æµé‡\n\n3ï¼Œæ˜¯å¤œèºçš„ï¼Œä¸è¿‡ä¹Ÿæ˜¯åŸºäºPromQLçš„ï¼Œå¯ä»¥æ‰‹å·¥è½¬æˆGrafanaçš„å¤§ç›˜ã€‚Prometheusè‡ªèº«æ˜¯æ²¡æœ‰å¤§ç›˜çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676003561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368451,"user_name":"Geek_f31e99","can_delete":false,"product_type":"c1","uid":2909697,"ip_address":"ä¸Šæµ·","ucode":"77BAA66D9636EF","user_header":"","comment_is_top":false,"comment_ctime":1676353192,"is_pvip":false,"replies":[{"id":134224,"content":"å¯ä»¥å…ˆè®¾ç½®ä¸º5minï¼Œç„¶åæ…¢æ…¢è°ƒæ•´ä¸ºæ›´åˆç†çš„å€¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001078,"ctime":1676439532,"ip_address":"åŒ—äº¬","comment_id":368451,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"è¯·é—®è€å¸ˆï¼ kafka_consumer_lag_millisè¿™ä¸ªæŠ¥è­¦å€¼ï¼Œè®¾ç½®å¤šå¤§æ¯”è¾ƒåˆé€‚ï¼","like_count":0,"discussions":[{"author":{"id":1001078,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/46/76/67e111da.jpg","nickname":"å·´è¾‰ç‰¹","note":"","ucode":"DCBB150A99548D","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":604806,"discussion_content":"å¯ä»¥å…ˆè®¾ç½®ä¸º5minï¼Œç„¶åæ…¢æ…¢è°ƒæ•´ä¸ºæ›´åˆç†çš„å€¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676439532,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368327,"user_name":"å†·å¦‚å†°","can_delete":false,"product_type":"c1","uid":3296032,"ip_address":"å¹¿ä¸œ","ucode":"5E0000620B3F33","user_header":"https://static001.geekbang.org/account/avatar/00/32/4b/20/8a289101.jpg","comment_is_top":false,"comment_ctime":1676205996,"is_pvip":false,"replies":[{"id":134164,"content":"å› ä¸ºè¿™ä¸æ˜¯è§†é¢‘è¯¾å‘€å®å­ï¼Œè¿™æ˜¯ä¸“æ è¯¾ï¼Œæ˜¯å›¾æ–‡+éŸ³é¢‘å½¢å¼çš„å“¦ï½","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":2843479,"ctime":1676278956,"ip_address":"åŒ—äº¬","comment_id":368327,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"ä¸ºä»€ä¹ˆå…¨æ˜¯è¯­éŸ³ã€‚ã€‚ã€‚æ²¡è§†é¢‘ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2843479,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/57/cba4c68b.jpg","nickname":"å°è™å­ğŸ¯","note":"","ucode":"4C9530B3FB407B","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603766,"discussion_content":"å› ä¸ºè¿™ä¸æ˜¯è§†é¢‘è¯¾å‘€å®å­ï¼Œè¿™æ˜¯ä¸“æ è¯¾ï¼Œæ˜¯å›¾æ–‡+éŸ³é¢‘å½¢å¼çš„å“¦ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676278956,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368664,"user_name":"StackOverflow","can_delete":false,"product_type":"c1","uid":1014821,"ip_address":"ä¸Šæµ·","ucode":"BAFA303CE70366","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/25/19cbcd56.jpg","comment_is_top":false,"comment_ctime":1676537266,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100522501,"comment_content":"å¦‚æœæ˜¯k8sé›†ç¾¤éƒ¨ç½²çš„ kafkaï¼Œæ˜¯ä¸æ˜¯ä½¿èƒ½ metricsï¼Œç„¶åç›‘æ§ç›¸åº”æŒ‡æ ‡ï¼Ÿ","like_count":0}]}