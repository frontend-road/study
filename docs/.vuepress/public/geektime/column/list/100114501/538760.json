{"id":538760,"title":"21｜Ingress：集群进出流量的总管","content":"<p>你好，我是Chrono。</p><p>上次课里我们学习了Service对象，它是Kubernetes内置的负载均衡机制，使用静态IP地址代理动态变化的Pod，支持域名访问和服务发现，是微服务架构必需的基础设施。</p><p>Service很有用，但也只能说是“基础设施”，它对网络流量的管理方案还是太简单，离复杂的现代应用架构需求还有很大的差距，所以Kubernetes就在Service之上又提出了一个新的概念：Ingress。</p><p>比起Service，Ingress更接近实际业务，对它的开发、应用和讨论也是社区里最火爆的，今天我们就来看看Ingress，还有与它关联的Ingress Controller、Ingress Class等对象。</p><h2>为什么要有Ingress</h2><p>通过上次课程的讲解，我们知道了Service的功能和运行机制，它本质上就是一个由kube-proxy控制的四层负载均衡，在TCP/IP协议栈上转发流量（<a href=\"https://kubernetes.io/zh/docs/concepts/services-networking/service/\">Service工作原理示意图</a>）：</p><p><img src=\"https://static001.geekbang.org/resource/image/03/74/0347a0b3bae55fb9ef6c07469e964b74.png?wh=1622x1214\" alt=\"图片\"></p><p>但在四层上的负载均衡功能还是太有限了，只能够依据IP地址和端口号做一些简单的判断和组合，而我们现在的绝大多数应用都是跑在七层的HTTP/HTTPS协议上的，有更多的高级路由条件，比如主机名、URI、请求头、证书等等，而这些在TCP/IP网络栈里是根本看不见的。</p><!-- [[[read_end]]] --><p>Service还有一个缺点，它比较适合代理集群内部的服务。如果想要把服务暴露到集群外部，就只能使用NodePort或者LoadBalancer这两种方式，而它们都缺乏足够的灵活性，难以管控，这就导致了一种很无奈的局面：我们的服务空有一身本领，却没有合适的机会走出去大展拳脚。</p><p>该怎么解决这个问题呢？</p><p>Kubernetes还是沿用了Service的思路，既然Service是四层的负载均衡，那么我再引入一个新的API对象，在七层上做负载均衡是不是就可以了呢？</p><p><strong>不过除了七层负载均衡，这个对象还应该承担更多的职责，也就是作为流量的总入口，统管集群的进出口数据</strong>，“扇入”“扇出”流量（也就是我们常说的“南北向”），让外部用户能够安全、顺畅、便捷地访问内部服务（<a href=\"https://bishoylabib.com/exposing-your-application-to-the-public-ingress/\">图片来源</a>）：</p><p><img src=\"https://static001.geekbang.org/resource/image/e6/55/e6ce31b027ba2a8d94cdc553a2c97255.png?wh=1288x834\" alt=\"图片\"></p><p>所以，这个API对象就顺理成章地被命名为 <code>Ingress</code>，意思就是集群内外边界上的入口。</p><h2>为什么要有Ingress Controller</h2><p>再对比一下Service我们就能更透彻地理解Ingress。</p><p>Ingress可以说是在七层上另一种形式的Service，它同样会代理一些后端的Pod，也有一些路由规则来定义流量应该如何分配、转发，只不过这些规则都使用的是HTTP/HTTPS协议。</p><p>你应该知道，Service本身是没有服务能力的，它只是一些iptables规则，<strong>真正配置、应用这些规则的实际上是节点里的kube-proxy组件</strong>。如果没有kube-proxy，Service定义得再完善也没有用。</p><p>同样的，Ingress也只是一些HTTP路由规则的集合，相当于一份静态的描述文件，真正要把这些规则在集群里实施运行，还需要有另外一个东西，这就是 <code>Ingress Controller</code>，它的作用就相当于Service的kube-proxy，能够读取、应用Ingress规则，处理、调度流量。</p><p>按理来说，Kubernetes应该把Ingress Controller内置实现，作为基础设施的一部分，就像kube-proxy一样。</p><p><strong>不过Ingress Controller要做的事情太多，与上层业务联系太密切，所以Kubernetes把Ingress Controller的实现交给了社区</strong>，任何人都可以开发Ingress Controller，只要遵守Ingress规则就好。</p><p>这就造成了Ingress Controller“百花齐放”的盛况。</p><p>由于Ingress Controller把守了集群流量的关键入口，掌握了它就拥有了控制集群应用的“话语权”，所以众多公司纷纷入场，精心打造自己的Ingress Controller，意图在Kubernetes流量进出管理这个领域占有一席之地。</p><p>这些实现中最著名的，就是老牌的反向代理和负载均衡软件Nginx了。从Ingress Controller的描述上我们也可以看到，HTTP层面的流量管理、安全控制等功能其实就是经典的反向代理，而Nginx则是其中稳定性最好、性能最高的产品，所以它也理所当然成为了Kubernetes里应用得最广泛的Ingress Controller。</p><p>不过，因为Nginx是开源的，谁都可以基于源码做二次开发，所以它又有很多的变种，比如社区的Kubernetes Ingress Controller（<a href=\"https://github.com/kubernetes/ingress-nginx\">https://github.com/kubernetes/ingress-nginx</a>）、Nginx公司自己的Nginx Ingress Controller（<a href=\"https://github.com/nginxinc/kubernetes-ingress\">https://github.com/nginxinc/kubernetes-ingress</a>）、还有基于OpenResty的Kong Ingress Controller（<a href=\"https://github.com/Kong/kubernetes-ingress-controller\">https://github.com/Kong/kubernetes-ingress-controller</a>）等等。</p><p>根据Docker Hub上的统计，<strong>Nginx公司的开发实现是下载量最多的Ingress Controller</strong>，所以我将以它为例，讲解Ingress和Ingress Controller的用法。</p><p>下面的<a href=\"https://www.nginx.com/products/nginx-ingress-controller/\">这张图</a>就来自Nginx官网，比较清楚地展示了Ingress Controller在Kubernetes集群里的地位：</p><p><img src=\"https://static001.geekbang.org/resource/image/eb/f8/ebebd12312fa5e6eb1ea90c930bd5ef8.png?wh=1920x706\" alt=\"图片\"></p><h2>为什么要有IngressClass</h2><p>那么到现在，有了Ingress和Ingress Controller，我们是不是就可以完美地管理集群的进出流量了呢？</p><p>最初Kubernetes也是这么想的，一个集群里有一个Ingress Controller，再给它配上许多不同的Ingress规则，应该就可以解决请求的路由和分发问题了。</p><p>但随着Ingress在实践中的大量应用，很多用户发现这种用法会带来一些问题，比如：</p><ul>\n<li>由于某些原因，项目组需要引入不同的Ingress Controller，但Kubernetes不允许这样做；</li>\n<li>Ingress规则太多，都交给一个Ingress Controller处理会让它不堪重负；</li>\n<li>多个Ingress对象没有很好的逻辑分组方式，管理和维护成本很高；</li>\n<li>集群里有不同的租户，他们对Ingress的需求差异很大甚至有冲突，无法部署在同一个Ingress Controller上。</li>\n</ul><p>所以，Kubernetes就又提出了一个 <code>Ingress Class</code> 的概念，让它插在Ingress和Ingress Controller中间，作为流量规则和控制器的协调人，解除了Ingress和Ingress Controller的强绑定关系。</p><p>现在，<strong>Kubernetes用户可以转向管理Ingress Class，用它来定义不同的业务逻辑分组，简化Ingress规则的复杂度</strong>。比如说，我们可以用Class A处理博客流量、Class B处理短视频流量、Class C处理购物流量。</p><p><img src=\"https://static001.geekbang.org/resource/image/88/0e/8843704c6314706c9b6f4f2399ca940e.jpg?wh=1920x1306\" alt=\"图片\"></p><p>这些Ingress和Ingress Controller彼此独立，不会发生冲突，所以上面的那些问题也就随着Ingress Class的引入迎刃而解了。</p><h2>如何使用YAML描述Ingress/Ingress Class</h2><p>我们花了比较多的篇幅学习Ingress、 Ingress Controller、Ingress Class这三个对象，全是理论，你可能觉得学得有点累。但这也是没办法的事情，毕竟现实的业务就是这么复杂，而且这个设计架构也是社区经过长期讨论后达成的一致结论，是我们目前能获得的最佳解决方案。</p><p>好，了解了这三个概念之后，我们就可以来看看如何为它们编写YAML描述文件了。</p><p>和之前学习Deployment、Service对象一样，首先应当用命令 <code>kubectl api-resources</code> 查看它们的基本信息，输出列在这里了：</p><pre><code class=\"language-plain\">kubectl api-resources\n\nNAME&nbsp; &nbsp; &nbsp; \t\tSHORTNAMES&nbsp; &nbsp;APIVERSION&nbsp; &nbsp; &nbsp; &nbsp;\t\tNAMESPACED&nbsp; &nbsp;KIND\ningresses&nbsp; &nbsp; &nbsp; &nbsp;ing&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; networking.k8s.io/v1&nbsp; &nbsp;true&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Ingress\ningressclasses&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;networking.k8s.io/v1&nbsp; &nbsp;false&nbsp; &nbsp; &nbsp; &nbsp; IngressClass\n</code></pre><p>你可以看到，Ingress和Ingress Class的apiVersion都是“<strong>networking.k8s.io/v1</strong>”，而且Ingress有一个简写“<strong>ing</strong>”，但Ingress Controller怎么找不到呢？</p><p>这是因为Ingress Controller和其他两个对象不太一样，它不只是描述文件，是一个要实际干活、处理流量的应用程序，而应用程序在Kubernetes里早就有对象来管理了，那就是Deployment和DaemonSet，所以我们只需要再学习Ingress和Ingress Class的的用法就可以了。</p><p>先看Ingress。</p><p>Ingress也是可以使用 <code>kubectl create</code> 来创建样板文件的，和Service类似，它也需要用两个附加参数：</p><ul>\n<li><code>--class</code>，指定Ingress从属的Ingress Class对象。</li>\n<li><code>--rule</code>，指定路由规则，基本形式是“URI=Service”，也就是说是访问HTTP路径就转发到对应的Service对象，再由Service对象转发给后端的Pod。</li>\n</ul><p>好，现在我们就执行命令，看看Ingress到底长什么样：</p><pre><code class=\"language-plain\">export out=\"--dry-run=client -o yaml\"\nkubectl create ing ngx-ing --rule=\"ngx.test/=ngx-svc:80\" --class=ngx-ink $out\n</code></pre><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n&nbsp; name: ngx-ing\n&nbsp;&nbsp;\nspec:\n\n&nbsp; ingressClassName: ngx-ink\n&nbsp;&nbsp;\n&nbsp; rules:\n&nbsp; - host: ngx.test\n&nbsp; &nbsp; http:\n&nbsp; &nbsp; &nbsp; paths:\n      - path: /\n        pathType: Exact\n&nbsp; &nbsp; &nbsp;   backend:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; service:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name: ngx-svc\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; number: 80\n</code></pre><p>在这份Ingress的YAML里，有两个关键字段：“<strong>ingressClassName</strong>”和“<strong>rules</strong>”，分别对应了命令行参数，含义还是比较好理解的。</p><p>只是“rules”的格式比较复杂，嵌套层次很深。不过仔细点看就会发现它是把路由规则拆散了，有host和http path，在path里又指定了路径的匹配方式，可以是精确匹配（Exact）或者是前缀匹配（Prefix），再用backend来指定转发的目标Service对象。</p><p>不过我个人觉得，Ingress YAML里的描述还不如 <code>kubectl create</code> 命令行里的 <code>--rule</code> 参数来得直观易懂，而且YAML里的字段太多也很容易弄错，建议你还是让kubectl来自动生成规则，然后再略作修改比较好。</p><p>有了Ingress对象，那么与它关联的Ingress Class是什么样的呢？</p><p>其实Ingress Class本身并没有什么实际的功能，只是起到联系Ingress和Ingress Controller的作用，所以它的定义非常简单，在“<strong>spec</strong>”里只有一个必需的字段“<strong>controller</strong>”，表示要使用哪个Ingress Controller，具体的名字就要看实现文档了。</p><p>比如，如果我要用Nginx开发的Ingress Controller，那么就要用名字“<strong>nginx.org/ingress-controller</strong>”：</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: IngressClass\nmetadata:\n&nbsp; name: ngx-ink\n\nspec:\n&nbsp; controller: nginx.org/ingress-controller\n</code></pre><p>Ingress和Service、Ingress Class的关系我也画成了一张图，方便你参考：</p><p><img src=\"https://static001.geekbang.org/resource/image/6b/af/6bd934a9c8c81a9f194d2d90ede172af.jpg?wh=1920x1005\" alt=\"图片\"></p><h2>如何在Kubernetes里使用Ingress/Ingress Class</h2><p>因为Ingress Class很小，所以我把它与Ingress合成了一个YAML文件，让我们用 <code>kubectl apply</code> 创建这两个对象：</p><pre><code class=\"language-plain\">kubectl apply -f ingress.yml\n</code></pre><p>然后我们用 <code>kubectl get</code> 来查看对象的状态：</p><pre><code class=\"language-plain\">kubectl get ingressclass\nkubectl get ing\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/f9/b9/f9396112f84076528d9072e358d1ebb9.png?wh=1510x366\" alt=\"图片\"></p><p>命令 <code>kubectl describe</code> 可以看到更详细的Ingress信息：</p><pre><code class=\"language-plain\">kubectl describe ing ngx-ing\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/b7/13/b708b7d41ef44844af7bf02cbb334313.png?wh=1576x664\" alt=\"图片\"></p><p>可以看到，Ingress对象的路由规则Host/Path就是在YAML里设置的域名“ngx.test/”，而且已经关联了第20讲里创建的Service对象，还有Service后面的两个Pod。</p><p>另外，不要对Ingress里“Default backend”的错误提示感到惊讶，在找不到路由的时候，它被设计用来提供一个默认的后端服务，但不设置也不会有什么问题，所以大多数时候我们都忽略它。</p><h2>如何在Kubernetes里使用Ingress Controller</h2><p>准备好了Ingress和Ingress Class，接下来我们就需要部署真正处理路由规则的Ingress Controller。</p><p>你可以在GitHub上找到Nginx Ingress Controller的项目（<a href=\"https://github.com/nginxinc/kubernetes-ingress\">https://github.com/nginxinc/kubernetes-ingress</a>），因为它以Pod的形式运行在Kubernetes里，所以同时支持Deployment和DaemonSet两种部署方式。这里我选择的是Deployment，相关的YAML也都在我们课程的项目（<a href=\"https://github.com/chronolaw/k8s_study/tree/master/ingress\">https://github.com/chronolaw/k8s_study/tree/master/ingress</a>）里复制了一份。</p><p>Nginx Ingress Controller的安装略微麻烦一些，有很多个YAML需要执行，但如果只是做简单的试验，就只需要用到4个YAML：</p><pre><code class=\"language-plain\">kubectl apply -f common/ns-and-sa.yaml\nkubectl apply -f rbac/rbac.yaml\nkubectl apply -f common/nginx-config.yaml\nkubectl apply -f common/default-server-secret.yaml\n</code></pre><p>前两条命令为Ingress Controller创建了一个独立的名字空间“nginx-ingress”，还有相应的账号和权限，这是为了访问apiserver获取Service、Endpoint信息用的；后两条则是创建了一个ConfigMap和Secret，用来配置HTTP/HTTPS服务。</p><p>部署Ingress Controller不需要我们自己从头编写Deployment，Nginx已经为我们提供了示例YAML，但创建之前为了适配我们自己的应用还必须要做几处小改动：</p><ul>\n<li>metadata里的name要改成自己的名字，比如 <code>ngx-kic-dep</code>。</li>\n<li>spec.selector和template.metadata.labels也要修改成自己的名字，比如还是用 <code>ngx-kic-dep</code>。</li>\n<li>containers.image可以改用apline版本，加快下载速度，比如 <code>nginx/nginx-ingress:2.2-alpine</code>。</li>\n<li>最下面的args要加上 <code>-ingress-class=ngx-ink</code>，也就是前面创建的Ingress Class的名字，这是让Ingress Controller管理Ingress的关键。</li>\n</ul><p>修改完之后，Ingress Controller的YAML大概是这个样子：</p><pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n&nbsp; name: ngx-kic-dep\n&nbsp; namespace: nginx-ingress\n\nspec:\n&nbsp; replicas: 1\n&nbsp; selector:\n&nbsp; &nbsp; matchLabels:\n&nbsp; &nbsp; &nbsp; app: ngx-kic-dep\n\n&nbsp; template:\n&nbsp; &nbsp; metadata:\n&nbsp; &nbsp; &nbsp; labels:\n&nbsp; &nbsp; &nbsp; &nbsp; app: ngx-kic-dep\n    ...\n&nbsp; &nbsp; spec:\n&nbsp; &nbsp; &nbsp; containers:\n&nbsp; &nbsp; &nbsp; - image: nginx/nginx-ingress:2.2-alpine\n        ...\n&nbsp; &nbsp; &nbsp; &nbsp; args:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - -ingress-class=ngx-ink\n</code></pre><p>有了Ingress Controller，这些API对象的关联就更复杂了，你可以用下面的这张图来看出它们是如何使用对象名字联系起来的：</p><p><img src=\"https://static001.geekbang.org/resource/image/bb/14/bb7a911e10c103fb839e01438e184914.jpg?wh=1920x736\" alt=\"图片\"></p><p>确认Ingress Controller 的YAML修改完毕之后，就可以用 <code>kubectl apply</code> 创建对象：</p><pre><code class=\"language-plain\">kubectl apply -f kic.yml\n</code></pre><p>注意Ingress Controller位于名字空间“<strong>nginx-ingress</strong>”，所以查看状态需要用“<strong>-n</strong>”参数显式指定，否则我们只能看到“default”名字空间里的Pod：</p><pre><code class=\"language-plain\">kubectl get deploy -n nginx-ingress\nkubectl get pod -n nginx-ingress\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/63/a6/6389033863c8f809b4c0048be44903a6.png?wh=1476x364\" alt=\"图片\"></p><p>现在Ingress Controller就算是运行起来了。</p><p>不过还有最后一道工序，因为Ingress Controller本身也是一个Pod，想要向外提供服务还是要依赖于Service对象。所以你至少还要再为它定义一个Service，使用NodePort或者LoadBalancer暴露端口，才能真正把集群的内外流量打通。这个工作就交给你课下自己去完成了。</p><p>这里，我就用<a href=\"https://time.geekbang.org/column/article/534644\">第15讲</a>里提到的<strong>命令</strong><code>kubectl port-forward</code><strong>，它可以直接把本地的端口映射到Kubernetes集群的某个Pod里</strong>，在测试验证的时候非常方便。</p><p>下面这条命令就把本地的8080端口映射到了Ingress Controller Pod的80端口：</p><pre><code class=\"language-plain\">kubectl port-forward -n nginx-ingress ngx-kic-dep-8859b7b86-cplgp 8080:80 &amp;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/1f/67/1f9cyy6e78d19e23db9594a272fa4267.png?wh=1920x349\" alt=\"图片\"></p><p>我们在curl发测试请求的时候需要注意，因为Ingress的路由规则是HTTP协议，所以就不能用IP地址的方式访问，必须要用域名、URI。</p><p>你可以修改 <code>/etc/hosts</code> 来手工添加域名解析，也可以使用 <code>--resolve</code> 参数，指定域名的解析规则，比如在这里我就把“ngx.test”强制解析到“127.0.0.1”，也就是被 <code>kubectl port-forward</code> 转发的本地地址：</p><pre><code class=\"language-plain\">curl --resolve ngx.test:8080:127.0.0.1 http://ngx.test:8080\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/24/ec/2410bb40faa73be25e8d9b3c46c6deec.png?wh=1920x767\" alt=\"图片\"></p><p>把这个访问结果和上一节课里的Service对比一下，你会发现最终效果是一样的，都是把请求转发到了集群内部的Pod，但Ingress的路由规则不再是IP地址，而是HTTP协议里的域名、URI等要素。</p><h2>小结</h2><p>好了，今天就讲到这里，我们学习了Kubernetes里七层的反向代理和负载均衡对象，包括Ingress、Ingress Controller、Ingress Class，它们联合起来管理了集群的进出流量，是集群入口的总管。</p><p>小结一下今天的主要内容：</p><ol>\n<li>Service是四层负载均衡，能力有限，所以就出现了Ingress，它基于HTTP/HTTPS协议定义路由规则。</li>\n<li>Ingress只是规则的集合，自身不具备流量管理能力，需要Ingress Controller应用Ingress规则才能真正发挥作用。</li>\n<li>Ingress Class解耦了Ingress和Ingress Controller，我们应当使用Ingress Class来管理Ingress资源。</li>\n<li>最流行的Ingress Controller是Nginx Ingress Controller，它基于经典反向代理软件Nginx。</li>\n</ol><p>再补充一点，目前的Kubernetes流量管理功能主要集中在Ingress Controller上，已经远不止于管理“入口流量”了，它还能管理“出口流量”，也就是 <code>egress</code>，甚至还可以管理集群内部服务之间的“东西向流量”。</p><p>此外，Ingress Controller通常还有很多的其他功能，比如TLS终止、网络应用防火墙、限流限速、流量拆分、身份认证、访问控制等等，完全可以认为它是一个全功能的反向代理或者网关，感兴趣的话你可以找找这方面的资料。</p><h2>课下作业</h2><p>最后是课下作业时间，给你留两个思考题：</p><ol>\n<li>四层负载均衡（Service）与七层负载均衡（Ingress）有哪些异同点？</li>\n<li>你认为Ingress Controller作为集群的流量入口还应该做哪些事情？</li>\n</ol><p>欢迎留言写下你的想法，思考题闭环是你巩固所学的第一步，进步从完成开始。</p><p>下节课是我们这个章节的实战演练课，我们下节课再见。</p><p><img src=\"https://static001.geekbang.org/resource/image/6a/08/6a373b5b5e8c0869f6b77bc8d5b35708.jpg?wh=1920x2856\" alt=\"\"></p>","neighbors":{"left":{"article_title":"20｜Service：微服务架构的应对之道","id":536829},"right":{"article_title":"22｜实战演练：玩转Kubernetes（2）","id":539420}},"comments":[{"had_liked":false,"id":353918,"user_name":"Jasper","can_delete":false,"product_type":"c1","uid":1316025,"ip_address":"北京","ucode":"06640157207187","user_header":"https://static001.geekbang.org/account/avatar/00/14/14/b9/47377590.jpg","comment_is_top":false,"comment_ctime":1659926461,"is_pvip":false,"replies":[{"id":"128710","content":"good","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1659929530,"ip_address":"北京","comment_id":353918,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44609599421","product_id":100114501,"comment_content":"四层架构简单，无需解析消息内容，在网络吞吐量及处理性能上高于七层。<br>而七层负载优势在于功能多，控制灵活强大。","like_count":10,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583142,"discussion_content":"good","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659929530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354521,"user_name":"Grey","can_delete":false,"product_type":"c1","uid":1663898,"ip_address":"北京","ucode":"D63D36C9A7F16B","user_header":"https://static001.geekbang.org/account/avatar/00/19/63/9a/6872c932.jpg","comment_is_top":false,"comment_ctime":1660485331,"is_pvip":false,"replies":[{"id":"128942","content":"脚本里用的YAML 比较多，还创建了crd资源。","user_name":"作者回复","user_name_real":"作者","uid":"1181974","ctime":1660519181,"ip_address":"北京","comment_id":354521,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14545387219","product_id":100114501,"comment_content":"Nginx Ingress Controller 只用那4个不行，看了23节，跟着老师用bash脚本全部弄进去了才把kic起了起来","like_count":3,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583940,"discussion_content":"脚本里用的YAML 比较多，还创建了crd资源。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660519181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3171798,"avatar":"https://static001.geekbang.org/account/avatar/00/30/65/d6/20670fd5.jpg","nickname":"Obscure","note":"","ucode":"8A7464990F4178","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":586631,"discussion_content":"官网上好像提到了，默认是必须创建crd（自定义资源定义）的，否则pod一直不会READY。除非在kic.yml中，将-enable-custom-resources命令行参数配置为false。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662384174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":583940,"ip_address":"浙江"},"score":586631,"extra":""}]}]},{"had_liked":false,"id":353990,"user_name":"新时代农民工","can_delete":false,"product_type":"c1","uid":1225689,"ip_address":"上海","ucode":"0AA60DEDF6C062","user_header":"https://static001.geekbang.org/account/avatar/00/12/b3/d9/cf061262.jpg","comment_is_top":false,"comment_ctime":1659974507,"is_pvip":false,"replies":[{"id":"128749","content":"good","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660011251,"ip_address":"上海","comment_id":353990,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10249909099","product_id":100114501,"comment_content":"文末的kic.yml是来自 https:&#47;&#47;github.com&#47;nginxinc&#47;kubernetes-ingress&#47;blob&#47;main&#47;deployments&#47;deployment&#47;nginx-ingress.yaml","like_count":2,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583271,"discussion_content":"good","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660011251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353927,"user_name":"李一","can_delete":false,"product_type":"c1","uid":1524952,"ip_address":"北京","ucode":"EEB7C5099C566C","user_header":"https://static001.geekbang.org/account/avatar/00/17/44/d8/708a0932.jpg","comment_is_top":false,"comment_ctime":1659929372,"is_pvip":true,"replies":[{"id":"128709","content":"四层协议可以由Ingress Controller的crd资源来定义，比如Nginx Ingress Controller的Transport Server，可以参考它们的相关文档，比如：https:&#47;&#47;docs.nginx.com&#47;nginx-ingress-controller&#47;configuration&#47;transportserver-resource&#47;","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1659929521,"ip_address":"北京","comment_id":353927,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10249863964","product_id":100114501,"comment_content":"老师，请问 Ingress 工作在7层协议中，指针对http(s)应用层协议进行控制，那如果 我的应用是需要长链接的 不如IM通讯相关，那是不是Ingress就无法满足了，只能通过service 定义吗？","like_count":2,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583141,"discussion_content":"四层协议可以由Ingress Controller的crd资源来定义，比如Nginx Ingress Controller的Transport Server，可以参考它们的相关文档，比如：https://docs.nginx.com/nginx-ingress-controller/configuration/transportserver-resource/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659929521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356780,"user_name":"pyhhou","can_delete":false,"product_type":"c1","uid":1256496,"ip_address":"上海","ucode":"31EF8D50CF91A5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ibZVAmmdAibBeVpUjzwId8ibgRzNk7fkuR5pgVicB5mFSjjmt2eNadlykVLKCyGA0GxGffbhqLsHnhDRgyzxcKUhjg/132","comment_is_top":false,"comment_ctime":1662589648,"is_pvip":false,"replies":[{"id":"129848","content":"应该先创建Ingress Class对象吧，可以参考一下后面的视频课。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1662603044,"ip_address":"上海","comment_id":356780,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5957556944","product_id":100114501,"comment_content":"老师，setup Ingress Controller 那里有个问题不知道如何解决，看到评论区里也有很多同学有一样的问题<br><br>$ kubectl logs ngx-kic-dep-75f4f5c7c-v9lt8 -n nginx-ingress<br>I0907 22:10:01.222921       1 main.go:213] Starting NGINX Ingress Controller Version=2.2.2 GitCommit=a88b7fe6dbde5df79593ac161749afc1e9a009c6 Date=2022-05-24T00:33:34Z Arch=linux&#47;arm64 PlusFlag=false<br>I0907 22:10:01.233010       1 main.go:344] Kubernetes version: 1.23.3<br>F0907 22:10:01.233818       1 main.go:357] Error when getting IngressClass ngx-ink: ingressclasses.networking.k8s.io &quot;ngx-ink&quot; is forbidden: User &quot;system:serviceaccount:nginx-ingress:default&quot; cannot get resource &quot;ingressclasses&quot; in API group &quot;networking.k8s.io&quot; at the cluster scope<br><br>pod 的状态是 CrashLoopBackOff<br><br>我是直接执行你 GitHub 上面的 setup.sh 脚本的，然后再执行 kic.yaml 的，所以 rbac.yaml 也是执行了的。或者说 rbac.yaml 文件中的参数需要更改？","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586908,"discussion_content":"应该先创建Ingress Class对象吧，可以参考一下后面的视频课。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662603044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1140265,"avatar":"https://static001.geekbang.org/account/avatar/00/11/66/29/8b471f9d.jpg","nickname":"半缘君","note":"","ucode":"1266C4E35180A2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589651,"discussion_content":"在ing-controller.yaml中没有指定serviceAccountName: nginx-ingress，使用了默认的ngx-ingress:default，因此没有权限","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665220339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355735,"user_name":"stefen","can_delete":false,"product_type":"c1","uid":1202047,"ip_address":"上海","ucode":"7C9AAE829E7802","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oib0a89lqtOhJL1UvfUp4uTsRLrDbhoGk9jLiciazxMu0COibJsFCZDypK1ZFcHEJc9d9qgbjvgR41ImL6FNPoVlWA/132","comment_is_top":false,"comment_ctime":1661701224,"is_pvip":false,"replies":[{"id":"129474","content":"可以的，后面的实战就是这么做的。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1661743949,"ip_address":"上海","comment_id":355735,"utype":1}],"discussion_count":1,"race_medal":1,"score":"5956668520","product_id":100114501,"comment_content":"最后ingress-controller运行起来的pod 可以看作是一个pod的nginx反向代理的VIP， 由于pod网络隔离的原因，需要还套娃一个service, 对外提供统一的管理入口，是否可以换种思路， 在启动这种ingress-controller运行起来的pod的，设置pod的网络为host，就是公用宿主机网卡，这样就不用套娃service了.","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585644,"discussion_content":"可以的，后面的实战就是这么做的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661743949,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354860,"user_name":"许飞","can_delete":false,"product_type":"c1","uid":2789963,"ip_address":"上海","ucode":"2579B1A828D8BC","user_header":"https://static001.geekbang.org/account/avatar/00/2a/92/4b/1262f052.jpg","comment_is_top":false,"comment_ctime":1660826265,"is_pvip":true,"replies":[{"id":"129103","content":"好像是没有安装Nginx Ingress Controller的rbac，再把它相关的安装YAML 都执行一下。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660890663,"ip_address":"上海","comment_id":354860,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5955793561","product_id":100114501,"comment_content":"F0818 12:36:23.718350       1 main.go:357] Error when getting IngressClass ngx-ink: ingressclasses.networking.k8s.io &quot;ngx-ink&quot; is forbidden: User &quot;system:serviceaccount:nginx-ingress:default&quot; cannot get resource &quot;ingressclasses&quot; in API group &quot;networking.k8s.io&quot; at the cluster scope<br>老师这报错是为啥","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584518,"discussion_content":"好像是没有安装Nginx Ingress Controller的rbac，再把它相关的安装YAML 都执行一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660890663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354366,"user_name":"YueShi","can_delete":false,"product_type":"c1","uid":1625530,"ip_address":"北京","ucode":"8F7AFAE4641A7D","user_header":"https://static001.geekbang.org/account/avatar/00/18/cd/ba/3a348f2d.jpg","comment_is_top":false,"comment_ctime":1660300826,"is_pvip":true,"replies":[{"id":"128889","content":"great","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660307014,"ip_address":"北京","comment_id":354366,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5955268122","product_id":100114501,"comment_content":"service方式如下：<br><br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: ingress-svc<br>  namespace: nginx-ingress<br>spec:<br>  selector:<br>    app: ngx-kic-dep<br>  ports:<br>  - port: 80<br>    targetPort: 80<br>  type: NodePort<br><br><br>请求 后面的端口要根据kubectl get svc -n nginx-ingress 查看<br><br>curl --resolve ngx.test:31967:127.0.0.1 http:&#47;&#47;ngx.test:31967","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583715,"discussion_content":"great","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660307014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354057,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"北京","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1660049517,"is_pvip":true,"replies":[{"id":"128793","content":"<br>1. taint是对pod生效的，所以也会影响Deployment。<br><br>2.前面4个是安装Nginx Ingress Controller，是必须要做的，有顺序要求。<br><br>3.用git clone，把这个项目下载下来。<br><br>4.用kubectl describe&#47;logs看原因。<br><br>遇到错误是好事，排查错误的过程就能够涨经验。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660092693,"ip_address":"北京","comment_id":354057,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5955016813","product_id":100114501,"comment_content":"请教老师几个问题：<br>Q1：taint是在daemonset部分讲的，节点的taint会影响pod是否会部署到节点上。<br>但是，对于deployment，taint会影响吗？<br><br>Q2：第21讲最后一部分是搭建ingress controller。 这部分提到了五个yml文件。 是先执行前面四个，然后再执行最后一个来创建ingress controller吗？ 还是只执行“kubectl apply -f kic.yml”？ （如果先执行前面四个文件，这四个文件有顺序吗？）<br><br>Q3：github上的四个文件，看不到下载按钮。是因为没有登录吗？ 如果不是因为登录，是否能提供下载按钮？（现在的方法是拷贝文件内容，比较麻烦）<br><br>Q4：运行controller后，查看deploy和POD的状态都不正常。<br>先执行github上的四个文件，顺序是文中列出的顺序，创建都成功了。然后启动controller。<br>查看结果如下：<br>kubectl get pod -n nginx-ingress，状态是：CrashLoopBackOff<br>kubectl get deploy -n nginx-ingress： Ready是 0&#47;1<br>可能是什么原因？ （这个问题有点笼统，不太具体，老师给出一点建议即可。）","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583389,"discussion_content":"\n1. taint是对pod生效的，所以也会影响Deployment。\n\n2.前面4个是安装Nginx Ingress Controller，是必须要做的，有顺序要求。\n\n3.用git clone，把这个项目下载下来。\n\n4.用kubectl describe/logs看原因。\n\n遇到错误是好事，排查错误的过程就能够涨经验。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660092693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353902,"user_name":"潜光隐耀","can_delete":false,"product_type":"c1","uid":1809457,"ip_address":"上海","ucode":"8A2FDDEFCB1863","user_header":"https://static001.geekbang.org/account/avatar/00/1b/9c/31/e4677275.jpg","comment_is_top":false,"comment_ctime":1659921063,"is_pvip":false,"replies":[{"id":"128699","content":"现在Gateway 已经是beta版了，可能会以加餐的形式，","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1659924801,"ip_address":"上海","comment_id":353902,"utype":1}],"discussion_count":4,"race_medal":0,"score":"5954888359","product_id":100114501,"comment_content":"请问下，会不会介绍下gateway api？","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583126,"discussion_content":"现在Gateway 已经是beta版了，可能会以加餐的形式，","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1659924801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583139,"discussion_content":"是的，YAML 太多确实不好管理，但helm也不是万能的，具体要怎么用还是得根据自己的实际情况来选择。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659928339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1013728,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/77/e0/81db900c.jpg","nickname":"Null","note":"","ucode":"3A0BC281632DD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583138,"discussion_content":"老师，问你们生生产环境都是怎么使用K8s的。主要想问的服务管理方面，感觉服务稍微一多就需要写很多yaml ，特别不方便，那么类似helm包管理工具正式生产环境的使用的多吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659927308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江"},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1087243,"avatar":"https://static001.geekbang.org/account/avatar/00/10/97/0b/a943bcb3.jpg","nickname":"zhou","note":"","ucode":"E1CE8575B3F106","race_medal":3,"user_type":1,"is_pvip":false},"reply_author":{"id":1013728,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/77/e0/81db900c.jpg","nickname":"Null","note":"","ucode":"3A0BC281632DD9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591884,"discussion_content":"生产环境，一般就直接拉uat的镜像部署了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666915764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":583138,"ip_address":"浙江"},"score":591884,"extra":""}]}]},{"had_liked":false,"id":360289,"user_name":"Xu.","can_delete":false,"product_type":"c1","uid":1817449,"ip_address":"上海","ucode":"7163195EA638FA","user_header":"https://static001.geekbang.org/account/avatar/00/1b/bb/69/a8bb7a4a.jpg","comment_is_top":false,"comment_ctime":1666406392,"is_pvip":false,"replies":[{"id":"131100","content":"good solution！ ","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1666583327,"ip_address":"上海","comment_id":360289,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1666406392","product_id":100114501,"comment_content":"老师，我在安装文档里找到了大多数同学遇到的问题的解决方法：<br>https:&#47;&#47;docs.nginx.com&#47;nginx-ingress-controller&#47;installation&#47;installation-with-manifests&#47;<br>Create Custom Resources 这一节<br><br>注意：默认情况下，需要为 VirtualServer, VirtualServerRoute, TransportServer and Policy 创建自定义资源的定义。否则，Ingress Controller Pod 将不会变为 Ready 状态。如果要禁用该要求，请将 -enable-custom-resources 命令行参数配置为 Readyfalse 并跳过此部分。<br><br>也就是说可以 kubectl apply -f 下面几个文件：<br><br>$ kubectl apply -f common&#47;crds&#47;k8s.nginx.org_virtualservers.yaml<br>$ kubectl apply -f common&#47;crds&#47;k8s.nginx.org_virtualserverroutes.yaml<br>$ kubectl apply -f common&#47;crds&#47;k8s.nginx.org_transportservers.yaml<br>$ kubectl apply -f common&#47;crds&#47;k8s.nginx.org_policies.yaml<br><br>然后就启动成功了。<br><br>也可以将 -enable-custom-resources 命令行参数配置为 Readyfalse ","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591398,"discussion_content":"good solution！ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666583327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360263,"user_name":"chuanshen","can_delete":false,"product_type":"c1","uid":1401511,"ip_address":"上海","ucode":"02B565DFA534A6","user_header":"https://static001.geekbang.org/account/avatar/00/15/62/a7/595b36f8.jpg","comment_is_top":false,"comment_ctime":1666354383,"is_pvip":false,"replies":[{"id":"131149","content":"这个是Kubernetes之外的问题了，属于传统的负载均衡解决方案，也就是健康检查。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1666588561,"ip_address":"上海","comment_id":360263,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1666354383","product_id":100114501,"comment_content":"集群外部访问集群内部，不管使用 Ingress 还是 Service，外部请求都是靠节点的 NodeIP 来访问集群内部的服务的。为了高可用，可以在多个节点上使用多个NodeIP 对外暴露服务。但如果其中一个节点故障了，客户端并不知道，通过域名或node IP 还向这个节点发报，路由到这个 NodeIP 的数据都会丢失. 这时应如何处理，是在集群外部在使用 Nginx的 upstream 在代理一下两个地址么，或者使用负载均衡，有什么更好的方法么？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591453,"discussion_content":"这个是Kubernetes之外的问题了，属于传统的负载均衡解决方案，也就是健康检查。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666588561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360260,"user_name":"Frank","can_delete":false,"product_type":"c1","uid":1111985,"ip_address":"上海","ucode":"9DADD72C193296","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/b1/982ea185.jpg","comment_is_top":false,"comment_ctime":1666350206,"is_pvip":true,"replies":[{"id":"131152","content":"直接用就行，这个default server其实没太大作用。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1666588709,"ip_address":"上海","comment_id":360260,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1666350206","product_id":100114501,"comment_content":"kubectl apply -f common&#47;default-server-secret.yaml   里面data tls.crt , tls.key 需要配置本机的吗？还是直接使用yaml里面的哦。","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591456,"discussion_content":"直接用就行，这个default server其实没太大作用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666588709,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358914,"user_name":"小江爱学术","can_delete":false,"product_type":"c1","uid":2628601,"ip_address":"北京","ucode":"554F40C6627AF4","user_header":"https://static001.geekbang.org/account/avatar/00/28/1b/f9/018197f1.jpg","comment_is_top":false,"comment_ctime":1665022061,"is_pvip":false,"replies":[{"id":"130540","content":"Ingress基于http协议，有更丰富的路由规则，能够更精细地管理流量。而且有了Ingress，只需要对外暴露一个Service对象就可以了，也更加安全。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1665059586,"ip_address":"北京","comment_id":358914,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1665022061","product_id":100114501,"comment_content":"一个小问题老师，service基于四层转发，会暴露ip。基于这些缺点我们引入了ingress，基于七层网络协议转发，但是为了外部服务访问，需要在ingress前再暴露一个nodeport类型的service，那我们这么做的意义在哪里捏，最外层的入口处不还是service吗。","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589519,"discussion_content":"Ingress基于http协议，有更丰富的路由规则，能够更精细地管理流量。而且有了Ingress，只需要对外暴露一个Service对象就可以了，也更加安全。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1665059586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1087243,"avatar":"https://static001.geekbang.org/account/avatar/00/10/97/0b/a943bcb3.jpg","nickname":"zhou","note":"","ucode":"E1CE8575B3F106","race_medal":3,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592013,"discussion_content":"如果以nodePord的方式暴露Ingress，是否真实情况前面还是要加一层nginx做负载均衡，不然单节点挂了怎么办","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667029974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358476,"user_name":"alexgreenbar","can_delete":false,"product_type":"c1","uid":1003655,"ip_address":"北京","ucode":"87ED7233E2767C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/50/87/dde718fa.jpg","comment_is_top":false,"comment_ctime":1664348005,"is_pvip":true,"replies":[{"id":"130448","content":"是的，所以我感觉这方面Kubernetes设计的还是不太完美。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1664406328,"ip_address":"北京","comment_id":358476,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1664348005","product_id":100114501,"comment_content":"service对外暴露服务通过NodePort方式不太好，然后引入了ingress，但是ingress本身是deployment的话，还得再给配置一个针对ingress的service，暴露服务依然不方便，虽然的确通过ingress增强了路由配置","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589087,"discussion_content":"是的，所以我感觉这方面Kubernetes设计的还是不太完美。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664406328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358450,"user_name":"陈斯佳","can_delete":false,"product_type":"c1","uid":1259323,"ip_address":"北京","ucode":"C236F874FC767A","user_header":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","comment_is_top":false,"comment_ctime":1664330397,"is_pvip":false,"replies":[{"id":"130429","content":"helm很流行，不过因为我不是做运维管理，所以用的不多，它本质上还是用的YAML ，是否用还是要看自己公司的决策。<br><br>个人感觉helm比较简单，和deb安装包类似，会了Kubernetes学helm还是挺容易的。<br><br>以后有机会可以讲讲我自己的体会。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1664338566,"ip_address":"北京","comment_id":358450,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1664330397","product_id":100114501,"comment_content":"老师 现在nginx的部署是不是最好都用helm来部署呢？是的话需要如何学习Helm呢？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589016,"discussion_content":"helm很流行，不过因为我不是做运维管理，所以用的不多，它本质上还是用的YAML ，是否用还是要看自己公司的决策。\n\n个人感觉helm比较简单，和deb安装包类似，会了Kubernetes学helm还是挺容易的。\n\n以后有机会可以讲讲我自己的体会。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1664338566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1259323,"avatar":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","nickname":"陈斯佳","note":"","ucode":"C236F874FC767A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":589188,"discussion_content":"期待您的分享！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664505712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":589016,"ip_address":"加拿大"},"score":589188,"extra":""}]}]},{"had_liked":false,"id":358382,"user_name":"alexgreenbar","can_delete":false,"product_type":"c1","uid":1003655,"ip_address":"北京","ucode":"87ED7233E2767C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/50/87/dde718fa.jpg","comment_is_top":false,"comment_ctime":1664262257,"is_pvip":true,"replies":[{"id":"130419","content":"好像是没有安装VirtualServerRoute 、TransportServer等crd资源，可以用GitHub项目里的setup脚本完全安装一下。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1664319324,"ip_address":"北京","comment_id":358382,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1664262257","product_id":100114501,"comment_content":"nginx ingress controller 总是不ready, 看了下log，发现错误如下，换成版本 2.3.1也是同样错误<br><br>2022&#47;09&#47;27 07:01:20 [notice] 12#12: getrlimit(RLIMIT_NOFILE): 1048576:1048576<br>2022&#47;09&#47;27 07:01:20 [notice] 12#12: start worker processes<br>2022&#47;09&#47;27 07:01:20 [notice] 12#12: start worker process 13<br>I0927 07:01:20.820385       1 leaderelection.go:248] attempting to acquire leader lease nginx-ingress&#47;nginx-ingress-leader-election...<br>W0927 07:01:20.842772       1 reflector.go:324] pkg&#47;mod&#47;k8s.io&#47;client-go@v0.23.11&#47;tools&#47;cache&#47;reflector.go:167: failed to list *v1.VirtualServerRoute: the server could not find the requested resource (get virtualserverroutes.k8s.nginx.org)<br>E0927 07:01:20.843127       1 reflector.go:138] pkg&#47;mod&#47;k8s.io&#47;client-go@v0.23.11&#47;tools&#47;cache&#47;reflector.go:167: Failed to watch *v1.VirtualServerRoute: failed to list *v1.VirtualServerRoute: the server could not find the requested resource (get virtualserverroutes.k8s.nginx.org)<br>W0927 07:01:20.846511       1 reflector.go:324] pkg&#47;mod&#47;k8s.io&#47;client-go@v0.23.11&#47;tools&#47;cache&#47;reflector.go:167: failed to list *v1alpha1.TransportServer: the server could not find the requested resource (get transportservers.k8s.nginx.org)","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588993,"discussion_content":"好像是没有安装VirtualServerRoute 、TransportServer等crd资源，可以用GitHub项目里的setup脚本完全安装一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664319325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1003655,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/87/dde718fa.jpg","nickname":"alexgreenbar","note":"","ucode":"87ED7233E2767C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589015,"discussion_content":"我的情况下，文中提到的4个yaml是不够的，需要额外配置crd，也都在项目的common/crds目录下\n\n&gt; kubectl get crd\nNAME                                CREATED AT\npolicies.k8s.nginx.org              2022-09-28T03:42:28Z\ntransportservers.k8s.nginx.org      2022-09-28T03:37:19Z\nvirtualserverroutes.k8s.nginx.org   2022-09-28T03:37:46Z\nvirtualservers.k8s.nginx.org        2022-09-28T03:37:33Z","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664336827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357749,"user_name":"Sam.张朝","can_delete":false,"product_type":"c1","uid":1132448,"ip_address":"北京","ucode":"FB20554D94B250","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg","comment_is_top":false,"comment_ctime":1663597265,"is_pvip":true,"replies":[{"id":"130227","content":"Nginx Ingress Controller支持灰度发布，可以参考它的官方文档，用CRD实现。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1663639355,"ip_address":"北京","comment_id":357749,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1663597265","product_id":100114501,"comment_content":" 我们k8s 里有自己的全局网关，app-&gt;通过域名请求-&gt;经过网关用户token验证-&gt;分发到最终的服务 。这种情况用 ingress nginx 实现灰度发布，老师有好的设计思路么？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588262,"discussion_content":"Nginx Ingress Controller支持灰度发布，可以参考它的官方文档，用CRD实现。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663639355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357562,"user_name":"Sam.张朝","can_delete":false,"product_type":"c1","uid":1132448,"ip_address":"北京","ucode":"FB20554D94B250","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg","comment_is_top":false,"comment_ctime":1663396328,"is_pvip":true,"replies":[{"id":"130157","content":"应该不会吧，minikube和标准的Kubernetes没有不同，照着课程里操作就行了，不要用它自己的addon。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1663456475,"ip_address":"北京","comment_id":357562,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1663396328","product_id":100114501,"comment_content":"minikube 安装 ingress-nginx 真难<br>addons.go:383] Verifying addon ingress=true in &quot;minikube&quot;<br>I0917 13:49:04.897142   37252 out.go:177] 🔎  Verifying ingress addon...<br>I0917 13:49:04.899186   37252 kapi.go:75] Waiting for pod with label &quot;app.kubernetes.io&#47;name=ingress-nginx&quot; in ns &quot;ingress-nginx&quot; ...<br>I0917 13:49:04.916151   37252 kapi.go:86] Found 3 Pods for label selector app.kubernetes.io&#47;name=ingress-nginx<br>I0917 13:49:04.916164   37252 kapi.go:96] waiting for pod &quot;app.kubernetes.io&#47;name=ingress-nginx&quot;, current state: Pending: [&lt;nil&gt;]","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588008,"discussion_content":"应该不会吧，minikube和标准的Kubernetes没有不同，照着课程里操作就行了，不要用它自己的addon。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663456475,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357516,"user_name":"王朝","can_delete":false,"product_type":"c1","uid":1313316,"ip_address":"北京","ucode":"073DBCB52CC570","user_header":"https://static001.geekbang.org/account/avatar/00/14/0a/24/f283ec40.jpg","comment_is_top":false,"comment_ctime":1663323970,"is_pvip":false,"replies":[{"id":"130113","content":"当然了，这个是Ingress的路由规则，只有匹配了条件才会转发到后面的服务。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1663332829,"ip_address":"北京","comment_id":357516,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1663323970","product_id":100114501,"comment_content":"老师你好，请问外界通过ingress访问服务时，必须要通过ingress规则里定义的host吗?","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587876,"discussion_content":"当然了，这个是Ingress的路由规则，只有匹配了条件才会转发到后面的服务。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663332829,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1313316,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/24/f283ec40.jpg","nickname":"王朝","note":"","ucode":"073DBCB52CC570","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":587878,"discussion_content":"那么公网调用一定要能够域名解析这个host，否则就要指定节点ip:port，是这样吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663333050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":587876,"ip_address":"北京"},"score":587878,"extra":""}]}]},{"had_liked":false,"id":356582,"user_name":"Obscure","can_delete":false,"product_type":"c1","uid":3171798,"ip_address":"北京","ucode":"8A7464990F4178","user_header":"https://static001.geekbang.org/account/avatar/00/30/65/d6/20670fd5.jpg","comment_is_top":false,"comment_ctime":1662437420,"is_pvip":false,"replies":[{"id":"129808","content":"注意这个是Nginx公司的Ingress Controller，不是Kubernetes社区的。<br><br>文档在这里：https:&#47;&#47;docs.nginx.com&#47;nginx-ingress-controller&#47;configuration&#47;global-configuration&#47;command-line-arguments&#47;#-ingress-class-string","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1662457200,"ip_address":"北京","comment_id":356582,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1662437420","product_id":100114501,"comment_content":"老师，这句话“最下面的 args 要加上 -ingress-class=ngx-ink，也就是前面创建的 Ingress Class 的名字，这是让 Ingress Controller 管理 Ingress 的关键。”的出处在哪里啊？我看了官网上的安装指南，没找到。。。","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586717,"discussion_content":"注意这个是Nginx公司的Ingress Controller，不是Kubernetes社区的。\n\n文档在这里：https://docs.nginx.com/nginx-ingress-controller/configuration/global-configuration/command-line-arguments/#-ingress-class-string","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662457200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3171798,"avatar":"https://static001.geekbang.org/account/avatar/00/30/65/d6/20670fd5.jpg","nickname":"Obscure","note":"","ucode":"8A7464990F4178","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":586796,"discussion_content":"好的，谢谢老师。我是按照https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-manifests/安装的。原来这几个参数都有默认 值啊，感觉还是都用默认值，最方便了。ingress controller的yaml中命令行参数 -ingress-class不写，保持默认，ingress calss的yaml也保持官方给的，资源的名字就叫nginx，不做修改。ingress的yaml中甚至都可以忽略ingressClassName这个字段了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662519210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":586717,"ip_address":"浙江"},"score":586796,"extra":""}]}]},{"had_liked":false,"id":354981,"user_name":"Matthew","can_delete":false,"product_type":"c1","uid":2843865,"ip_address":"北京","ucode":"96093089773740","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKSVuNarJuDhBSvHY0giaq6yriceEBKiaKuc04wCYWOuso50noqDexaPJJibJN7PHwvcQppnzsDia1icZkw/132","comment_is_top":false,"comment_ctime":1660931145,"is_pvip":true,"replies":[{"id":"129123","content":"503是后端服务有问题吧，用kubectl logs看看Nginx的日志。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660956930,"ip_address":"北京","comment_id":354981,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1660931145","product_id":100114501,"comment_content":"按照老师文中的方法一步一步执行，在成功创建 Ingress Controller 后，执行：<br>kubectl get deploy -n nginx-ingress<br>kubectl get pod -n nginx-ingress<br>发现：<br>NAME          READY   UP-TO-DATE   AVAILABLE   AGE<br>ngx-kic-dep   0&#47;1     1            0           17s<br><br>NAME                          READY   STATUS    RESTARTS   AGE<br>ngx-kic-dep-8859b7b86-s5b4l   0&#47;1     Running   0          43s<br><br>然后执行：<br>kubectl describe pod ngx-kic-dep-8859b7b86-s5b4l -n nginx-ingress<br>发现：<br>Events:<br>  Type     Reason     Age                 From               Message<br>  ----     ------     ----                ----               -------<br>  Normal   Scheduled  103s                default-scheduler  Successfully assigned nginx-ingress&#47;ngx-kic-dep-8859b7b86-s5b4l to worker<br>  Normal   Pulling    102s                kubelet            Pulling image &quot;nginx&#47;nginx-ingress:2.2-alpine&quot;<br>  Normal   Pulled     82s                 kubelet            Successfully pulled image &quot;nginx&#47;nginx-ingress:2.2-alpine&quot; in 19.632847723s<br>  Normal   Created    81s                 kubelet            Created container nginx-ingress<br>  Normal   Started    81s                 kubelet            Started container nginx-ingress<br>  Warning  Unhealthy  61s (x21 over 80s)  kubelet            Readiness probe failed: HTTP probe failed with statuscode: 503<br><br>最后的 Warning 显示：Readiness probe failed: HTTP probe failed with statuscode: 503<br>这是什么问题呢？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584584,"discussion_content":"503是后端服务有问题吧，用kubectl logs看看Nginx的日志。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660956930,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2843865,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKSVuNarJuDhBSvHY0giaq6yriceEBKiaKuc04wCYWOuso50noqDexaPJJibJN7PHwvcQppnzsDia1icZkw/132","nickname":"Matthew","note":"","ucode":"96093089773740","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584769,"discussion_content":"执行了老师github上的setup.sh就好了，应该是要把crd里的资源都创建才能，只按照课程里的语句执行还不够。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661098923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354812,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"北京","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1660800835,"is_pvip":true,"replies":[{"id":"129083","content":"应该是安装的时候向Kubernetes注册的，具体可能要看源码了。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660813342,"ip_address":"北京","comment_id":354812,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1660800835","product_id":100114501,"comment_content":"Ingressclass 里面的 spec.controller 的值 nginx.org&#47;ingress-controller 是怎么 和 ingress controller  关联起来的？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584431,"discussion_content":"应该是安装的时候向Kubernetes注册的，具体可能要看源码了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660813342,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354622,"user_name":"马以","can_delete":false,"product_type":"c1","uid":1344431,"ip_address":"北京","ucode":"3FEA06CA14DE28","user_header":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","comment_is_top":false,"comment_ctime":1660618283,"is_pvip":false,"replies":[{"id":"128965","content":"可能Nginx Ingress Controller的行为有改变，那就把crd里的资源也都创建了吧。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660623004,"ip_address":"北京","comment_id":354622,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1660618283","product_id":100114501,"comment_content":"我是搭在云服务器中的，这里搭建nginx-ingress的时候，要创建crds才行，不然成功不了","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584077,"discussion_content":"可能Nginx Ingress Controller的行为有改变，那就把crd里的资源也都创建了吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660623004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354557,"user_name":"dao","can_delete":false,"product_type":"c1","uid":1087879,"ip_address":"北京","ucode":"4181FB270462CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","comment_is_top":false,"comment_ctime":1660543185,"is_pvip":true,"replies":[{"id":"128958","content":"crd不是必须的，不安装也可以。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660546826,"ip_address":"北京","comment_id":354557,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1660543185","product_id":100114501,"comment_content":"补充一下，在文稿里安装 Nginx Ingress Controller 处，除了四个 YAML 外，还需要安装它使用的 定制资源（crds）。 ","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583983,"discussion_content":"crd不是必须的，不安装也可以。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660546826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1087879,"avatar":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","nickname":"dao","note":"","ucode":"4181FB270462CF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583992,"discussion_content":"不安装 crds ，ingress controller pod 跑不起来，会抛出类似下面的错误（如果没有错误，是因为机器已经装了 :) ）\nFailed to watch *v1.VirtualServerRoute: failed to list *v1.VirtualServerRoute: the server could not find the requested resource","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660550984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"新加坡"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354463,"user_name":"ppd0705","can_delete":false,"product_type":"c1","uid":1155646,"ip_address":"北京","ucode":"EB63D4E3FD1E9A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","comment_is_top":false,"comment_ctime":1660442472,"is_pvip":false,"replies":[{"id":"128938","content":"setup.sh里的kubectl命令也都写在正文里了，可以用脚本，也可以手动执行命令。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660519073,"ip_address":"北京","comment_id":354463,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1660442472","product_id":100114501,"comment_content":"老师，文章中还是需要提一下 需要执行 ingress目录 setup.sh 脚本， 这一步很关键呀！","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583936,"discussion_content":"setup.sh里的kubectl命令也都写在正文里了，可以用脚本，也可以手动执行命令。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660519073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1155646,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","nickname":"ppd0705","note":"","ucode":"EB63D4E3FD1E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":583941,"discussion_content":"文章里面说只要四个文件，但是crds目录的文件好像也是必需的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660520144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":583936,"ip_address":"湖南"},"score":583941,"extra":""}]}]},{"had_liked":false,"id":354273,"user_name":"非主流码农","can_delete":false,"product_type":"c1","uid":2709653,"ip_address":"北京","ucode":"47F137CF78A849","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/ygRfx93LO1ziazydV4eZRGWfnxc6ZJUo0dUcboASfduibJByytVyhKvLd7suhmPYernHv1C1jy8sOtlRTzuO36iag/132","comment_is_top":false,"comment_ctime":1660232589,"is_pvip":true,"replies":[{"id":"128873","content":"先看一下Ingress Controller的日志，感觉像是Ingress没有配置好，Nginx找不到转发的路由。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660283662,"ip_address":"北京","comment_id":354273,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1660232589","product_id":100114501,"comment_content":"老师您好，我运行了curl --resolve ngx.test:8080:127.0.0.1 http:&#47;&#47;ngx.test:8080后提示：<br>Handling connection for 8080<br>&lt;html&gt;<br>&lt;head&gt;&lt;title&gt;404 Not Found&lt;&#47;title&gt;&lt;&#47;head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;&#47;h1&gt;&lt;&#47;center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&#47;1.21.6&lt;&#47;center&gt;<br>&lt;&#47;body&gt;<br>&lt;&#47;html&gt;<br>报404是哪个步骤出了问题呢？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583668,"discussion_content":"先看一下Ingress Controller的日志，感觉像是Ingress没有配置好，Nginx找不到转发的路由。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660283662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1087879,"avatar":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","nickname":"dao","note":"","ucode":"4181FB270462CF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583976,"discussion_content":"curl --resolve ngx.test:8080:127.0.0.1 http://ngx.test:8080\n这个 ngx.test 要和 ingress 里 host 相同。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660542470,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"新加坡"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2709653,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/ygRfx93LO1ziazydV4eZRGWfnxc6ZJUo0dUcboASfduibJByytVyhKvLd7suhmPYernHv1C1jy8sOtlRTzuO36iag/132","nickname":"非主流码农","note":"","ucode":"47F137CF78A849","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583669,"discussion_content":"感谢老师百忙中的回复，我再研究研究","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660283865,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"重庆"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354082,"user_name":"西门吹牛","can_delete":false,"product_type":"c1","uid":1508990,"ip_address":"北京","ucode":"E5D3624DDE1E83","user_header":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","comment_is_top":false,"comment_ctime":1660088827,"is_pvip":false,"replies":[{"id":"128791","content":"说的很好，不过在七层里不是“多了一次握手操作”，而是多了一层协议的处理，它底层还是基于tcp&#47;ip的。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660092497,"ip_address":"北京","comment_id":354082,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1660088827","product_id":100114501,"comment_content":"七层负载更加灵活，建立在应用层之上，能拿到应用程序相关的信息，可以根据应用信息为依据做负载，但性能肯定不如四层，相比四层负载毕竟多了一次握手操作。<br>四层灵活性不好，根据ip 活Mac 地址负载，但性能好，只是简单的换个ip 或Mac地址，越简单性能越好，但是换ip ，意味着要走nat 网关","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583387,"discussion_content":"说的很好，不过在七层里不是“多了一次握手操作”，而是多了一层协议的处理，它底层还是基于tcp/ip的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660092498,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354078,"user_name":"悟远","can_delete":false,"product_type":"c1","uid":1912923,"ip_address":"北京","ucode":"3BD9C748698888","user_header":"https://static001.geekbang.org/account/avatar/00/1d/30/5b/4f4b0a40.jpg","comment_is_top":false,"comment_ctime":1660060504,"is_pvip":true,"replies":[{"id":"128788","content":"Ingress只支持http&#47;1.1，其他的协议需要用Ingress Controller的CRD来定义。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660092369,"ip_address":"北京","comment_id":354078,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1660060504","product_id":100114501,"comment_content":"老师，请问Ingress可以针对http2.0进行控制吗？如gRPC，我试验gPRC时通过kubectl port-forward映射到本地，再加hosts，访问gRPC时失败了","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583384,"discussion_content":"Ingress只支持http/1.1，其他的协议需要用Ingress Controller的CRD来定义。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660092369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1912923,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/30/5b/4f4b0a40.jpg","nickname":"悟远","note":"","ucode":"3BD9C748698888","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583394,"discussion_content":"Kubernetes Ingress Controller是支持的吗？我看这里https://kubernetes.github.io/ingress-nginx/examples/grpc/是有例子的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660094068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354050,"user_name":"啊树","can_delete":false,"product_type":"c1","uid":1281551,"ip_address":"北京","ucode":"F1072F4610B6F8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/pZ5ibu3jOPTfWVtzTeNTiaL2PiabGT2Y2yKd2TNDcZMkIY34T5fhGcSnBjgpkd54Q3S6b3gRW3yYTxZk0QHYB0qnw/132","comment_is_top":false,"comment_ctime":1660042188,"is_pvip":true,"replies":[{"id":"128786","content":"Ingress早就是生产环境的标配了。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660092319,"ip_address":"北京","comment_id":354050,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1660042188","product_id":100114501,"comment_content":"现在商用环境是否适用Ingress了？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583382,"discussion_content":"Ingress早就是生产环境的标配了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660092319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354045,"user_name":"yhtyht308","can_delete":false,"product_type":"c1","uid":1230354,"ip_address":"北京","ucode":"9A054290B8B284","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/dotGbXAlAZg0bhCq4P96A40mdyavzR33jSqIHk8xLlic4B5PYNDIP5MEa1Fk9yxzdz9scHUM7IUNR71nVZNoV7Q/132","comment_is_top":false,"comment_ctime":1660039691,"is_pvip":false,"replies":[{"id":"128782","content":"kubectl logs -n nginx-ingress xxx看看日志，然后再对照一下课程正文，是否漏了什么步骤。<br><br>503好像是后台服务没起来，是否没有创建之前的Deployment、Service对象？","user_name":"作者回复","user_name_real":"作者","uid":"1181974","ctime":1660042687,"ip_address":"北京","comment_id":354045,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1660039691","product_id":100114501,"comment_content":"老师：执行<br>kubectl apply -f kic.yml后，一直没有起来，kubectl describe pod nginx-kic-（就是你pod名字） -n nginx-ingress里，看到错误信息： Warning  Unhealthy  1s (x5 over 4s)         kubelet            Readiness probe failed: HTTP probe failed with statuscode: 503,请问这怎么处理？<br><br>","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583342,"discussion_content":"kubectl logs -n nginx-ingress xxx看看日志，然后再对照一下课程正文，是否漏了什么步骤。\n\n503好像是后台服务没起来，是否没有创建之前的Deployment、Service对象？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660042688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1087879,"avatar":"https://static001.geekbang.org/account/avatar/00/10/99/87/98ebb20e.jpg","nickname":"dao","note":"","ucode":"4181FB270462CF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583969,"discussion_content":"我也出现这个问题，我的原因是没有安装 ingress/common/crds ,安装后 nginx-ingress 就运行了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660538346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"新加坡"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354030,"user_name":"李一","can_delete":false,"product_type":"c1","uid":1524952,"ip_address":"上海","ucode":"EEB7C5099C566C","user_header":"https://static001.geekbang.org/account/avatar/00/17/44/d8/708a0932.jpg","comment_is_top":false,"comment_ctime":1660031911,"is_pvip":true,"replies":[{"id":"128778","content":"好像是没有创建好RBAC，可能是Nginx相关的yaml没有部署好，确保它的那几个YAML 都已经执行了。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660036579,"ip_address":"上海","comment_id":354030,"utype":1}],"discussion_count":7,"race_medal":0,"score":"1660031911","product_id":100114501,"comment_content":"老师您好，一步步跟踪操作，但创建ingressController的时候报错了 Error when getting IngressClass ngx-ink: ingressclasses.networking.k8s.io &quot;ngx-ink&quot; is forbidden: User &quot;system:serviceaccount:nginx-ingress:default&quot; cannot get resource &quot;ingressclasses&quot; in API group &quot;networking.k8s.io&quot; at the cluster scope","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583328,"discussion_content":"好像是没有创建好RBAC，可能是Nginx相关的yaml没有部署好，确保它的那几个YAML 都已经执行了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660036579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1235690,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJ47Wh1RiazQVR3egTUV2dXV3MLibic1bdg7UV0tDoAfYxDUypF9t2VChMHib3kSEzITzuGSE5HFqYBeA/132","nickname":"Geek_207554","note":"","ucode":"F8C5A81328A4AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583858,"discussion_content":"存在同样的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660450621,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1155646,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","nickname":"ppd0705","note":"","ucode":"EB63D4E3FD1E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583521,"discussion_content":"我也遇到这个问题了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660179810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1524952,"avatar":"https://static001.geekbang.org/account/avatar/00/17/44/d8/708a0932.jpg","nickname":"李一","note":"","ucode":"EEB7C5099C566C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583395,"discussion_content":"老师，好像大家都存在这个问题。有同学改了 rbac.yaml 里面的内容才启动的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660095563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"密码123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1524952,"avatar":"https://static001.geekbang.org/account/avatar/00/17/44/d8/708a0932.jpg","nickname":"李一","note":"","ucode":"EEB7C5099C566C","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":583432,"discussion_content":"怎么改的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660115676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":583395,"ip_address":"江苏"},"score":583432,"extra":""}]},{"author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"密码123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583347,"discussion_content":"重新执行好像没用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660046344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"密码123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583346,"discussion_content":"我也有这个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660046309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354021,"user_name":"花花大脸猫","can_delete":false,"product_type":"c1","uid":1117318,"ip_address":"上海","ucode":"8ABDB3F7F4FB0F","user_header":"https://static001.geekbang.org/account/avatar/00/11/0c/86/8e52afb8.jpg","comment_is_top":false,"comment_ctime":1660024491,"is_pvip":true,"replies":[{"id":"128777","content":"Ingress Controller有很多实现，apisix也可以适配进Kubernetes作为Ingress Controller。<br><br>东西向是指集群内部Pod的流量，最常见的就是Service Mesh。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1660035591,"ip_address":"上海","comment_id":354021,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1660024491","product_id":100114501,"comment_content":"老师，问个问题，现在市面上的APISIX是不是也是Ingress Controller的一个实现？ 还有南北向的流量我能明白，东西向主要是处理哪种情况下的逻辑的？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583327,"discussion_content":"Ingress Controller有很多实现，apisix也可以适配进Kubernetes作为Ingress Controller。\n\n东西向是指集群内部Pod的流量，最常见的就是Service Mesh。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660035591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353910,"user_name":"Cue","can_delete":false,"product_type":"c1","uid":1516991,"ip_address":"上海","ucode":"A5CB460B54FDB0","user_header":"https://static001.geekbang.org/account/avatar/00/17/25/bf/1e9c853f.jpg","comment_is_top":false,"comment_ctime":1659922381,"is_pvip":false,"replies":[{"id":"128704","content":"<br>1. ingress设计只支持http，但现在的Ingress Controller都有扩展，通过crd来支持tcp。<br><br>2.感觉这个理解不太正确，Ingress只是定义了流量的分配规则，基于http那就得用七层里的信息去分流，本质上还是tcp&#47;ip协议栈。","user_name":"作者回复","user_name_real":"编辑","uid":"1181974","ctime":1659925743,"ip_address":"上海","comment_id":353910,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1659922381","product_id":100114501,"comment_content":"老师，两个疑问。<br>1、如果部署的pod就是四层TCP服务，不是HTTP的，那么ingress还适用吗？<br>2、为什么传统架构比如一个http请求是先到lvs（四层）-&gt;nginx（七层），在k8s架构里面就是先到七层，再到四层？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583131,"discussion_content":"\n1. ingress设计只支持http，但现在的Ingress Controller都有扩展，通过crd来支持tcp。\n\n2.感觉这个理解不太正确，Ingress只是定义了流量的分配规则，基于http那就得用七层里的信息去分流，本质上还是tcp/ip协议栈。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659925743,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}