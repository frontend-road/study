{"id":307469,"title":"15 | å†…å­˜æ¨¡å‹ï¼šGoå¦‚ä½•ä¿è¯å¹¶å‘è¯»å†™çš„é¡ºåºï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>Goå®˜æ–¹æ–‡æ¡£é‡Œä¸“é—¨ä»‹ç»äº†Goçš„<a href=\"https://golang.org/ref/mem\">å†…å­˜æ¨¡å‹</a>ï¼Œä½ ä¸è¦è¯¯è§£è¿™é‡Œçš„å†…å­˜æ¨¡å‹çš„å«ä¹‰ï¼Œå®ƒå¹¶ä¸æ˜¯æŒ‡Goå¯¹è±¡çš„å†…å­˜åˆ†é…ã€å†…å­˜å›æ”¶å’Œå†…å­˜æ•´ç†çš„è§„èŒƒï¼Œå®ƒæè¿°çš„æ˜¯å¹¶å‘ç¯å¢ƒä¸­å¤šgoroutineè¯»ç›¸åŒå˜é‡çš„æ—¶å€™ï¼Œå˜é‡çš„å¯è§æ€§æ¡ä»¶ã€‚å…·ä½“ç‚¹è¯´ï¼Œå°±æ˜¯æŒ‡ï¼Œåœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹ï¼Œgoroutineåœ¨è¯»å–ä¸€ä¸ªå˜é‡çš„å€¼çš„æ—¶å€™ï¼Œèƒ½å¤Ÿçœ‹åˆ°å…¶å®ƒgoroutineå¯¹è¿™ä¸ªå˜é‡è¿›è¡Œçš„å†™çš„ç»“æœã€‚</p><p>ç”±äºCPUæŒ‡ä»¤é‡æ’å’Œå¤šçº§Cacheçš„å­˜åœ¨ï¼Œä¿è¯å¤šæ ¸è®¿é—®åŒä¸€ä¸ªå˜é‡è¿™ä»¶äº‹å„¿å˜å¾—éå¸¸å¤æ‚ã€‚æ¯•ç«Ÿï¼Œä¸åŒCPUæ¶æ„ï¼ˆx86/amd64ã€ARMã€Powerç­‰ï¼‰çš„å¤„ç†æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œå†åŠ ä¸Šç¼–è¯‘å™¨çš„ä¼˜åŒ–ä¹Ÿå¯èƒ½å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’ï¼Œæ‰€ä»¥ç¼–ç¨‹è¯­è¨€éœ€è¦ä¸€ä¸ªè§„èŒƒï¼Œæ¥æ˜ç¡®å¤šçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªå˜é‡çš„å¯è§æ€§å’Œé¡ºåºï¼ˆ Russ Coxåœ¨éº»çœç†å·¥å­¦é™¢ <a href=\"https://pdos.csail.mit.edu/6.824/\">6.824 åˆ†å¸ƒå¼ç³»ç»ŸDistributed Systemsè¯¾ç¨‹</a> çš„ä¸€è¯¾ï¼Œä¸“é—¨ä»‹ç»äº†ç›¸å…³çš„<a href=\"http://nil.csail.mit.edu/6.824/2016/notes/gomem.pdf\">çŸ¥è¯†</a>ï¼‰ã€‚åœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œè¿™ä¸ªè§„èŒƒè¢«å«åšå†…å­˜æ¨¡å‹ã€‚</p><p>é™¤äº†Goï¼ŒJavaã€C++ã€Cã€C#ã€Rustç­‰ç¼–ç¨‹è¯­è¨€ä¹Ÿæœ‰å†…å­˜æ¨¡å‹ã€‚ä¸ºä»€ä¹ˆè¿™äº›ç¼–ç¨‹è¯­è¨€éƒ½è¦å®šä¹‰å†…å­˜æ¨¡å‹å‘¢ï¼Ÿåœ¨æˆ‘çœ‹æ¥ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªç›®çš„ã€‚</p><ul>\n<li>å‘å¹¿å¤§çš„ç¨‹åºå‘˜æä¾›ä¸€ç§ä¿è¯ï¼Œä»¥ä¾¿ä»–ä»¬åœ¨åšè®¾è®¡å’Œå¼€å‘ç¨‹åºæ—¶ï¼Œé¢å¯¹åŒä¸€ä¸ªæ•°æ®åŒæ—¶è¢«å¤šä¸ªgoroutineè®¿é—®çš„æƒ…å†µï¼Œå¯ä»¥åšä¸€äº›ä¸²è¡ŒåŒ–è®¿é—®çš„æ§åˆ¶ï¼Œæ¯”å¦‚ä½¿ç”¨Channelæˆ–è€…syncåŒ…å’Œsync/atomicåŒ…ä¸­çš„å¹¶å‘åŸè¯­ã€‚</li>\n<li>å…è®¸ç¼–è¯‘å™¨å’Œç¡¬ä»¶å¯¹ç¨‹åºåšä¸€äº›ä¼˜åŒ–ã€‚è¿™ä¸€ç‚¹å…¶å®ä¸»è¦æ˜¯ä¸ºç¼–è¯‘å™¨å¼€å‘è€…æä¾›çš„ä¿è¯ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿ä»–ä»¬å¯¹Goçš„ç¼–è¯‘å™¨åšä¼˜åŒ–ã€‚</li>\n</ul><!-- [[[read_end]]] --><p>æ—¢ç„¶å†…å­˜æ¨¡å‹è¿™ä¹ˆé‡è¦ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥èŠ±ä¸€èŠ‚è¯¾çš„æ—¶é—´å­¦ä¹ ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å…ˆå¼„æ˜ç™½é‡æ’å’Œå¯è§æ€§çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬å½±å“ç€ç¨‹åºå®é™…æ‰§è¡Œçš„é¡ºåºå…³ç³»ã€‚</p><h1>é‡æ’å’Œå¯è§æ€§çš„é—®é¢˜</h1><p><strong>ç”±äºæŒ‡ä»¤é‡æ’ï¼Œä»£ç å¹¶ä¸ä¸€å®šä¼šæŒ‰ç…§ä½ å†™çš„é¡ºåºæ‰§è¡Œ</strong>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå½“ä¸¤ä¸ªgoroutineåŒæ—¶å¯¹ä¸€ä¸ªæ•°æ®è¿›è¡Œè¯»å†™æ—¶ï¼Œå‡è®¾goroutine g1å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œå†™æ“ä½œwï¼Œgoroutine g2åŒæ—¶å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œè¯»æ“ä½œrï¼Œé‚£ä¹ˆï¼Œå¦‚æœg2åœ¨æ‰§è¡Œè¯»æ“ä½œrçš„æ—¶å€™ï¼Œå·²ç»çœ‹åˆ°äº†g1å†™æ“ä½œwçš„ç»“æœï¼Œé‚£ä¹ˆï¼Œä¹Ÿä¸æ„å‘³ç€g2èƒ½çœ‹åˆ°åœ¨wä¹‹å‰çš„å…¶å®ƒçš„å†™æ“ä½œã€‚è¿™æ˜¯ä¸€ä¸ªåç›´è§‚çš„ç»“æœï¼Œä¸è¿‡çš„ç¡®å¯èƒ½ä¼šå­˜åœ¨ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å†ä¸¾å‡ ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œå¸¦ä½ æ¥æ„Ÿå—ä¸€ä¸‹ï¼Œé‡æ’ä»¥åŠå¤šæ ¸CPUå¹¶å‘æ‰§è¡Œå¯¼è‡´ç¨‹åºçš„è¿è¡Œå’Œä»£ç çš„ä¹¦å†™é¡ºåºä¸ä¸€æ ·çš„æƒ…å†µã€‚</p><p>å…ˆçœ‹ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>var a, b int\n\nfunc f() {\n\ta = 1 // wä¹‹å‰çš„å†™æ“ä½œ\n\tb = 2 // å†™æ“ä½œw\n}\n\nfunc g() {\n\tprint(b) // è¯»æ“ä½œr\n\tprint(a) // ???\n}\n\nfunc main() {\n\tgo f() //g1\n\tg() //g2\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬9è¡Œæ˜¯è¦æ‰“å°bçš„å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿è¿™é‡Œæ‰“å°å‡ºçš„å€¼æ˜¯2ï¼Œä½†æ˜¯ä¾ç„¶å¯èƒ½åœ¨æ‰“å°açš„å€¼æ—¶ï¼Œæ‰“å°å‡ºåˆå§‹å€¼0ï¼Œè€Œä¸æ˜¯1ã€‚è¿™æ˜¯å› ä¸ºï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œä¸èƒ½ä¿è¯g2çœ‹åˆ°çš„aå’Œbçš„èµ‹å€¼æœ‰å…ˆåå…³ç³»ã€‚</p><p>å†æ¥çœ‹ä¸€ä¸ªç±»ä¼¼çš„ä¾‹å­ã€‚</p><pre><code>var a string\nvar done bool\n\nfunc setup() {\n\ta = &quot;hello, world&quot;\n\tdone = true\n}\n\nfunc main() {\n\tgo setup()\n\tfor !done {\n\t}\n\tprint(a)\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œä¸»goroutine mainå³ä½¿è§‚å¯Ÿåˆ°doneå˜æˆtrueäº†ï¼Œæœ€åè¯»å–åˆ°çš„açš„å€¼ä»ç„¶å¯èƒ½ä¸ºç©ºã€‚</p><p>æ›´ç³Ÿç³•çš„æƒ…å†µæ˜¯ï¼Œmainæ ¹æœ¬å°±è§‚å¯Ÿä¸åˆ°å¦ä¸€ä¸ªgoroutineå¯¹doneçš„å†™æ“ä½œï¼Œè¿™å°±ä¼šå¯¼è‡´mainç¨‹åºä¸€ç›´è¢«hangä½ã€‚ç”šè‡³å¯èƒ½è¿˜ä¼šå‡ºç°<strong>åŠåˆå§‹åŒ–</strong>çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼š</p><pre><code>type T struct {\n\tmsg string\n}\n\nvar g *T\n\nfunc setup() {\n\tt := new(T)\n\tt.msg = &quot;hello, world&quot;\n\tg = t\n}\n\nfunc main() {\n\tgo setup()\n\tfor g == nil {\n\t}\n\tprint(g.msg)\n}\n</code></pre><p>å³ä½¿main goroutineè§‚å¯Ÿåˆ°gä¸ä¸ºnilï¼Œä¹Ÿå¯èƒ½æ‰“å°å‡ºç©ºçš„msgï¼ˆç¬¬17è¡Œï¼‰ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½è¦è¯´äº†ï¼Œæˆ‘éƒ½è¿è¡Œè¿™ä¸ªç¨‹åºå‡ ç™¾ä¸‡æ¬¡äº†ï¼Œæ€ä¹ˆä¹Ÿæ²¡æœ‰è§‚å¯Ÿåˆ°è¿™ç§ç°è±¡ï¼Ÿæˆ‘å¯ä»¥è¿™ä¹ˆå‘Šè¯‰ä½ ï¼Œèƒ½ä¸èƒ½è§‚å¯Ÿåˆ°å’Œæä¾›ä¿è¯ï¼ˆguaranteeï¼‰æ˜¯ä¸¤ç äº‹å„¿ã€‚ç”±äºCPUæ¶æ„å’ŒGoç¼–è¯‘å™¨çš„ä¸åŒï¼Œå³ä½¿ä½ è¿è¡Œç¨‹åºæ—¶æ²¡æœ‰é‡åˆ°è¿™äº›ç°è±¡ï¼Œä¹Ÿä¸ä»£è¡¨Goå¯ä»¥100%ä¿è¯ä¸ä¼šå‡ºç°è¿™äº›é—®é¢˜ã€‚</p><p>åˆšåˆšè¯´äº†ï¼Œç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œä¸¤ä¸ªæ“ä½œçš„é¡ºåºå¯èƒ½ä¸ä¼šå¾—åˆ°ä¿è¯ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘è¦å¸¦ä½ äº†è§£ä¸€ä¸‹Goå†…å­˜æ¨¡å‹ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼šhappens-beforeï¼Œè¿™æ˜¯ç”¨æ¥æè¿°ä¸¤ä¸ªæ—¶é—´çš„é¡ºåºå…³ç³»çš„ã€‚å¦‚æœæŸäº›æ“ä½œèƒ½æä¾›happens-beforeå…³ç³»ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥100%ä¿è¯å®ƒä»¬ä¹‹é—´çš„é¡ºåºã€‚</p><h1>happens-before</h1><p><span class=\"orange\">åœ¨ä¸€ä¸ªgoroutineå†…éƒ¨ï¼Œç¨‹åºçš„æ‰§è¡Œé¡ºåºå’Œå®ƒä»¬çš„ä»£ç æŒ‡å®šçš„é¡ºåºæ˜¯ä¸€æ ·çš„ï¼Œå³ä½¿ç¼–è¯‘å™¨æˆ–è€…CPUé‡æ’äº†è¯»å†™é¡ºåºï¼Œä»è¡Œä¸ºä¸Šæ¥çœ‹ï¼Œä¹Ÿå’Œä»£ç æŒ‡å®šçš„é¡ºåºä¸€æ ·</span>ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ä¿è¯ï¼Œæˆ‘ä»¬ä¸€å®šè¦è®°ä½ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå³ä½¿ç¼–è¯‘å™¨æˆ–è€…CPUå¯¹aã€bã€cçš„åˆå§‹åŒ–è¿›è¡Œäº†é‡æ’ï¼Œä½†æ˜¯æ‰“å°ç»“æœä¾ç„¶èƒ½ä¿è¯æ˜¯1ã€2ã€3ï¼Œè€Œä¸ä¼šå‡ºç°1ã€0ã€0æˆ–1ã€0ã€1ç­‰æƒ…å†µã€‚</p><pre><code>func foo() {\n    var a = 1\n    var b = 2\n    var c = 3\n\n    println(a)\n    println(b)\n    println(c)\n}\n</code></pre><p>ä½†æ˜¯ï¼Œå¯¹äºå¦ä¸€ä¸ªgoroutineæ¥è¯´ï¼Œé‡æ’å´ä¼šäº§ç”Ÿéå¸¸å¤§çš„å½±å“ã€‚<strong>å› ä¸ºGoåªä¿è¯goroutineå†…éƒ¨é‡æ’å¯¹è¯»å†™çš„é¡ºåºæ²¡æœ‰å½±å“</strong>ï¼Œæ¯”å¦‚åˆšåˆšæˆ‘ä»¬åœ¨è®²â€œå¯è§æ€§â€é—®é¢˜æ—¶æåˆ°çš„ä¸‰ä¸ªä¾‹å­ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™å°±è¦ç”¨åˆ°happens-beforeå…³ç³»äº†ã€‚</p><p>å¦‚æœä¸¤ä¸ªactionï¼ˆread æˆ–è€… writeï¼‰æœ‰æ˜ç¡®çš„happens-beforeå…³ç³»ï¼Œä½ å°±å¯ä»¥ç¡®å®šå®ƒä»¬ä¹‹é—´çš„æ‰§è¡Œé¡ºåºï¼ˆæˆ–è€…æ˜¯è¡Œä¸ºè¡¨ç°ä¸Šçš„é¡ºåºï¼‰ã€‚</p><p>Goå†…å­˜æ¨¡å‹é€šè¿‡happens-beforeå®šä¹‰ä¸¤ä¸ªäº‹ä»¶ï¼ˆè¯»ã€å†™actionï¼‰çš„é¡ºåºï¼šå¦‚æœäº‹ä»¶e1  happens before äº‹ä»¶e2ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯´äº‹ä»¶e2åœ¨äº‹ä»¶e1ä¹‹åå‘ç”Ÿï¼ˆhappens afterï¼‰ã€‚å¦‚æœe1 ä¸æ˜¯happens before e2ï¼Œ åŒæ—¶ä¹Ÿä¸happens after e2ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯´äº‹ä»¶e1å’Œe2æ˜¯åŒæ—¶å‘ç”Ÿçš„ã€‚</p><p>å¦‚æœè¦ä¿è¯å¯¹â€œå˜é‡<strong>v</strong>çš„è¯»æ“ä½œ<strong>r</strong>â€èƒ½å¤Ÿè§‚å¯Ÿåˆ°ä¸€ä¸ªå¯¹â€œå˜é‡<strong>v</strong>çš„å†™æ“ä½œ<strong>w</strong>â€ï¼Œå¹¶ä¸”<strong>r</strong>åªèƒ½è§‚å¯Ÿåˆ°<strong>w</strong>å¯¹å˜é‡<strong>v</strong>çš„å†™ï¼Œæ²¡æœ‰å…¶å®ƒå¯¹vçš„å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦ä¿è¯<strong>r</strong>ç»å¯¹èƒ½è§‚å¯Ÿåˆ°<strong>w</strong>æ“ä½œçš„ç»“æœï¼Œé‚£ä¹ˆå°±éœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol>\n<li>w happens before rï¼›</li>\n<li>å…¶å®ƒå¯¹vçš„å†™æ“ä½œï¼ˆw2ã€w3ã€w4, ......ï¼‰ è¦ä¹ˆhappens before wï¼Œè¦ä¹ˆhappens after rï¼Œç»å¯¹ä¸ä¼šå’Œwã€råŒæ—¶å‘ç”Ÿï¼Œæˆ–è€…æ˜¯åœ¨å®ƒä»¬ä¹‹é—´å‘ç”Ÿã€‚</li>\n</ol><p>ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿™æ˜¯å¾ˆæ˜¾ç„¶çš„äº‹æƒ…å•Šï¼Œä½†æˆ‘è¦å’Œä½ è¯´çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸¥æ ¼ã€ä¸¥è°¨çš„æ•°å­¦å®šä¹‰ã€‚</p><p>å¯¹äºå•ä¸ªçš„goroutineæ¥è¯´ï¼Œå®ƒæœ‰ä¸€ä¸ªç‰¹æ®Šçš„happens-beforeå…³ç³»ï¼ŒGoå†…å­˜æ¨¡å‹ä¸­æ˜¯è¿™ä¹ˆè®²çš„ï¼š</p><blockquote>\n<p>Within a single goroutine, the happens-before order is the order expressed by the program.</p>\n</blockquote><p>æˆ‘æ¥è§£é‡Šä¸‹è¿™å¥è¯ã€‚å®ƒçš„æ„æ€æ˜¯ï¼Œåœ¨å•ä¸ªçš„goroutineå†…éƒ¨ï¼Œ happens-beforeçš„å…³ç³»å’Œä»£ç ç¼–å†™çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</p><p>å…¶å®ï¼Œåœ¨è¿™ä¸€ç« çš„å¼€å¤´æˆ‘å·²ç»ç”¨æ©™è‰²æŠŠè¿™å¥è¯æ ‡æ³¨å‡ºæ¥äº†ã€‚æˆ‘å†å…·ä½“è§£é‡Šä¸‹ã€‚</p><p>åœ¨goroutineå†…éƒ¨å¯¹ä¸€ä¸ªå±€éƒ¨å˜é‡vçš„è¯»ï¼Œä¸€å®šèƒ½è§‚å¯Ÿåˆ°æœ€è¿‘ä¸€æ¬¡å¯¹è¿™ä¸ªå±€éƒ¨å˜é‡vçš„å†™ã€‚å¦‚æœè¦ä¿è¯å¤šä¸ªgoroutineä¹‹é—´å¯¹ä¸€ä¸ªå…±äº«å˜é‡çš„è¯»å†™é¡ºåºï¼Œåœ¨Goè¯­è¨€ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¹¶å‘åŸè¯­ä¸ºè¯»å†™æ“ä½œå»ºç«‹happens-beforeå…³ç³»ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯é¡ºåºäº†ã€‚</p><p>è¯´åˆ°è¿™å„¿ï¼Œæˆ‘æƒ³å…ˆç»™ä½ è¡¥å……ä¸‰ä¸ªGoè¯­è¨€ä¸­å’Œå†…å­˜æ¨¡å‹æœ‰å…³çš„å°çŸ¥è¯†ï¼ŒæŒæ¡äº†è¿™äº›ï¼Œä½ å°±èƒ½æ›´å¥½åœ°ç†è§£ä¸‹é¢çš„å†…å®¹ã€‚</p><ol>\n<li>åœ¨Goè¯­è¨€ä¸­ï¼Œå¯¹å˜é‡è¿›è¡Œé›¶å€¼çš„åˆå§‹åŒ–å°±æ˜¯ä¸€ä¸ªå†™æ“ä½œã€‚</li>\n<li>å¦‚æœå¯¹è¶…è¿‡æœºå™¨wordï¼ˆ64bitã€32bitæˆ–è€…å…¶å®ƒï¼‰å¤§å°çš„å€¼è¿›è¡Œè¯»å†™ï¼Œé‚£ä¹ˆï¼Œå°±å¯ä»¥çœ‹ä½œæ˜¯å¯¹æ‹†æˆwordå¤§å°çš„å‡ ä¸ªè¯»å†™æ— åºè¿›è¡Œã€‚</li>\n<li>Goå¹¶ä¸æä¾›ç›´æ¥çš„CPUå±éšœï¼ˆCPU fenceï¼‰æ¥æç¤ºç¼–è¯‘å™¨æˆ–è€…CPUä¿è¯é¡ºåºæ€§ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸åŒæ¶æ„çš„å†…å­˜å±éšœæŒ‡ä»¤æ¥å®ç°ç»Ÿä¸€çš„å¹¶å‘åŸè¯­ã€‚</li>\n</ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦ä½ å­¦ä¹ ä¸‹Goè¯­è¨€ä¸­æä¾›çš„happens-beforeå…³ç³»ä¿è¯ã€‚</p><h1>Goè¯­è¨€ä¸­ä¿è¯çš„happens-beforeå…³ç³»</h1><p>é™¤äº†å•ä¸ªgoroutineå†…éƒ¨æä¾›çš„happens-beforeä¿è¯ï¼ŒGoè¯­è¨€ä¸­è¿˜æä¾›äº†ä¸€äº›å…¶å®ƒçš„happens-beforeå…³ç³»çš„ä¿è¯ï¼Œä¸‹é¢æˆ‘æ¥ä¸€ä¸ªä¸€ä¸ªä»‹ç»ä¸‹ã€‚</p><h2>initå‡½æ•°</h2><p>åº”ç”¨ç¨‹åºçš„åˆå§‹åŒ–æ˜¯åœ¨å•ä¸€çš„goroutineæ‰§è¡Œçš„ã€‚å¦‚æœåŒ…på¯¼å…¥äº†åŒ…qï¼Œé‚£ä¹ˆï¼Œqçš„initå‡½æ•°çš„æ‰§è¡Œä¸€å®š happens before  pçš„ä»»ä½•åˆå§‹åŒ–ä»£ç ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µéœ€è¦ä½ è®°ä½ï¼š<strong>mainå‡½æ•°ä¸€å®šåœ¨å¯¼å…¥çš„åŒ…çš„initå‡½æ•°ä¹‹åæ‰§è¡Œ</strong>ã€‚</p><p>åŒ…çº§åˆ«çš„å˜é‡åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºé€ä¸ªåˆå§‹åŒ–çš„ï¼Œé™¤éåˆå§‹åŒ–å®ƒçš„æ—¶å€™ä¾èµ–å…¶å®ƒçš„å˜é‡ã€‚åŒä¸€ä¸ªåŒ…ä¸‹çš„å¤šä¸ªæ–‡ä»¶ï¼Œä¼šæŒ‰ç…§æ–‡ä»¶åçš„æ’åˆ—é¡ºåºè¿›è¡Œåˆå§‹åŒ–ã€‚è¿™ä¸ªé¡ºåºè¢«å®šä¹‰åœ¨<a href=\"https://golang.org/ref/spec#Program_initialization_and_execution\">Goè¯­è¨€è§„èŒƒ</a>ä¸­ï¼Œè€Œä¸æ˜¯Goçš„å†…å­˜æ¨¡å‹è§„èŒƒä¸­ã€‚ä½ å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ä¸­å„ä¸ªå˜é‡çš„å€¼ï¼š</p><pre><code>var (\n\ta = c + b  // == 9\n\tb = f()    // == 4\n\tc = f()    // == 5\n\td = 3      // == 5 å…¨éƒ¨åˆå§‹åŒ–å®Œæˆå\n)\n\nfunc f() int {\n\td++\n\treturn d\n}\n</code></pre><p>å…·ä½“æ€ä¹ˆå¯¹è¿™äº›å˜é‡è¿›è¡Œåˆå§‹åŒ–å‘¢ï¼ŸGoé‡‡ç”¨çš„æ˜¯ä¾èµ–åˆ†ææŠ€æœ¯ã€‚ä¸è¿‡ï¼Œä¾èµ–åˆ†ææŠ€æœ¯ä¿è¯çš„é¡ºåºåªæ˜¯é’ˆå¯¹åŒä¸€åŒ…ä¸‹çš„å˜é‡ï¼Œè€Œä¸”ï¼Œåªæœ‰å¼•ç”¨å…³ç³»æ˜¯æœ¬åŒ…å˜é‡ã€å‡½æ•°å’Œéæ¥å£çš„æ–¹æ³•ï¼Œæ‰èƒ½ä¿è¯å®ƒä»¬çš„é¡ºåºæ€§ã€‚</p><p>åŒä¸€ä¸ªåŒ…ä¸‹å¯ä»¥æœ‰å¤šä¸ªinitå‡½æ•°ï¼Œç”šè‡³ä¸€ä¸ªæ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥åŒ…å«å¤šä¸ªç›¸åŒç­¾åçš„initå‡½æ•°ã€‚</p><p>åˆšåˆšè®²çš„è¿™äº›éƒ½æ˜¯ä¸åŒåŒ…çš„initå‡½æ•°æ‰§è¡Œé¡ºåºï¼Œä¸‹é¢æˆ‘ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼ŒæŠŠè¿™äº›å†…å®¹ä¸²èµ·æ¥ï¼Œä½ ä¸€çœ‹å°±æ˜ç™½äº†ã€‚</p><p>è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ª<strong>main</strong>ç¨‹åºï¼Œå®ƒä¾èµ–åŒ…p1ï¼ŒåŒ…p1ä¾èµ–åŒ…p2ï¼ŒåŒ…p2ä¾èµ–p3ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d5/2a/d5059fab1977602934339e18f9eddb2a.jpg?wh=3214*1645\" alt=\"\"></p><p>ä¸ºäº†è¿½è¸ªåˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¹¶è¾“å‡ºæœ‰æ„ä¹‰çš„æ—¥å¿—ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œæ‰“å°å‡ºæ—¥å¿—å¹¶è¿”å›ä¸€ä¸ªç”¨æ¥åˆå§‹åŒ–çš„æ•´æ•°å€¼ï¼š</p><pre><code>func Trace(t string, v int) int {\n    fmt.Println(t, &quot;:&quot;, v)\n    return v\n}\n</code></pre><p>åŒ…<strong>p3</strong>åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«å®šä¹‰äº†ä¸€ä¸ªinitå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼Œè¿™ä¸¤ä¸ªå˜é‡çš„å€¼è¿˜ä¼šåœ¨initå‡½æ•°ä¸­è¿›è¡Œä¿®æ”¹ã€‚</p><p>æˆ‘ä»¬æ¥åˆ†åˆ«çœ‹ä¸‹åŒ…p3çš„è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼š</p><pre><code>// lib1.go in p3\n\nvar V1_p3 = trace.Trace(&quot;init v1_p3&quot;, 3)\nvar V2_p3 = trace.Trace(&quot;init v2_p3&quot;, 3)\n\n\nfunc init() {\n    fmt.Println(&quot;init func in p3&quot;)\n    V1_p3 = 300\n    V2_p3 = 300\n}\n</code></pre><pre><code>// lib2.go in p3\n\nfunc init() {\n    fmt.Println(&quot;another init func in p3&quot;)\n}\n</code></pre><p>ä¸‹é¢å†æ¥çœ‹çœ‹åŒ…p2ã€‚åŒ…p2å®šä¹‰äº†å˜é‡å’Œinitå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå˜é‡åˆå§‹åŒ–ä¸º2ï¼Œå¹¶åœ¨initå‡½æ•°ä¸­æ›´æ”¹ä¸º200ã€‚ç¬¬äºŒä¸ªå˜é‡æ˜¯å¤åˆ¶çš„p3.V2_p3ã€‚</p><pre><code>var V1_p2 = trace.Trace(&quot;init v1_p2&quot;, 2)\nvar V2_p2 = trace.Trace(&quot;init v2_p2&quot;, p3.V2_p3)\n\nfunc init() {\n    fmt.Println(&quot;init func in p2&quot;)\n    V1_p2 = 200\n}\n</code></pre><p>åŒ…<strong>p1</strong>å®šä¹‰äº†å˜é‡å’Œinitå‡½æ•°ã€‚å®ƒçš„ä¸¤ä¸ªå˜é‡çš„å€¼æ˜¯å¤åˆ¶çš„p2å¯¹åº”çš„ä¸¤ä¸ªå˜é‡å€¼ã€‚</p><pre><code>var V1_p1 = trace.Trace(&quot;init v1_p1&quot;, p2.V1_p2)\nvar V2_p1 = trace.Trace(&quot;init v2_p1&quot;, p2.V2_p2)\n\nfunc init() {\n    fmt.Println(&quot;init func in p1&quot;)\n}\n</code></pre><p><strong>main</strong>å®šä¹‰äº†initå‡½æ•°å’Œmainå‡½æ•°ã€‚</p><pre><code>func init() {\n    fmt.Println(&quot;init func in main&quot;)\n}\n\n\nfunc main() {\n    fmt.Println(&quot;V1_p1:&quot;, p1.V1_p1)\n    fmt.Println(&quot;V2_p1:&quot;, p1.V2_p1)\n}\n</code></pre><p>è¿è¡Œmainå‡½æ•°ä¼šä¾æ¬¡è¾“å‡ºp3ã€p2ã€p1ã€mainçš„åˆå§‹åŒ–å˜é‡æ—¶çš„æ—¥å¿—ï¼ˆå˜é‡åˆå§‹åŒ–æ—¶çš„æ—¥å¿—å’Œinitå‡½æ•°è°ƒç”¨æ—¶çš„æ—¥å¿—ï¼‰ï¼š</p><pre><code>// åŒ…p3çš„å˜é‡åˆå§‹åŒ–\ninit v1_p3 : 3\ninit v2_p3 : 3\n// p3çš„initå‡½æ•°\ninit func in p3\n// p3çš„å¦ä¸€ä¸ªinitå‡½æ•° \nanother init func in p3\n\n// åŒ…p2çš„å˜é‡åˆå§‹åŒ–\ninit v1_p2 : 2\ninit v2_p2 : 300\n// åŒ…p2çš„initå‡½æ•°\ninit func in p2\n\n// åŒ…p1çš„å˜é‡åˆå§‹åŒ–\ninit v1_p1 : 200\ninit v2_p1 : 300\n// åŒ…p1çš„initå‡½æ•°\ninit func in p1\n\n// åŒ…mainçš„initå‡½æ•°\ninit func in main\n// mainå‡½æ•°\nV1_p1: 200\nV2_p1: 300\n</code></pre><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹goroutineå¯¹happens-beforeå…³ç³»çš„ä¿è¯æƒ…å†µã€‚</p><h2>goroutine</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ä¸ªè§„åˆ™ï¼š<strong>å¯åŠ¨goroutineçš„goè¯­å¥çš„æ‰§è¡Œï¼Œä¸€å®šhappens beforeæ­¤goroutineå†…çš„ä»£ç æ‰§è¡Œã€‚</strong></p><p>æ ¹æ®è¿™ä¸ªè§„åˆ™ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼Œå¦‚æœgoè¯­å¥ä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªå‡½æ•°ä¸€å®šå…ˆäºgoroutineå†…éƒ¨çš„ä»£ç è¢«æ‰§è¡Œã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œç¬¬8è¡Œaçš„èµ‹å€¼å’Œç¬¬9è¡Œçš„goè¯­å¥æ˜¯åœ¨åŒä¸€ä¸ªgoroutineä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ï¼Œåœ¨ä¸»goroutineçœ‹æ¥ï¼Œç¬¬8è¡Œè‚¯å®šhappens before ç¬¬9è¡Œï¼Œåˆç”±äºåˆšæ‰çš„ä¿è¯ï¼Œç¬¬9è¡Œå­goroutineçš„å¯åŠ¨happens before ç¬¬4è¡Œçš„å˜é‡è¾“å‡ºï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¨æ–­å‡ºï¼Œç¬¬8è¡Œhappens before ç¬¬4è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¬¬4è¡Œæ‰“å°açš„å€¼çš„æ—¶å€™ï¼Œè‚¯å®šä¼šæ‰“å°å‡ºâ€œhello worldâ€ã€‚</p><pre><code>var a string\n\nfunc f() {\n\tprint(a)\n}\n\nfunc hello() {\n\ta = &quot;hello, world&quot;\n\tgo f()\n}\n</code></pre><p>åˆšåˆšè¯´çš„æ˜¯å¯åŠ¨goroutineçš„æƒ…å†µï¼Œgoroutineé€€å‡ºçš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰ä»»ä½•happens-beforeä¿è¯çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³è§‚å¯ŸæŸä¸ªgoroutineçš„æ‰§è¡Œæ•ˆæœï¼Œä½ éœ€è¦ä½¿ç”¨åŒæ­¥æœºåˆ¶å»ºç«‹happens-beforeå…³ç³»ï¼Œæ¯”å¦‚Mutexæˆ–è€…Channelã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šè®²Channelçš„happens-beforeçš„å…³ç³»ä¿è¯ã€‚</p><h2>Channel</h2><p>Channelæ˜¯goroutineåŒæ­¥äº¤æµçš„ä¸»è¦æ–¹æ³•ã€‚å¾€ä¸€ä¸ªChannelä¸­å‘é€ä¸€æ¡æ•°æ®ï¼Œé€šå¸¸å¯¹åº”ç€å¦ä¸€ä¸ªgoroutineä»è¿™ä¸ªChannelä¸­æ¥æ”¶ä¸€æ¡æ•°æ®ã€‚</p><p>é€šç”¨çš„Channel happens-beforeå…³ç³»ä¿è¯æœ‰4æ¡è§„åˆ™ï¼Œæˆ‘åˆ†åˆ«æ¥ä»‹ç»ä¸‹ã€‚</p><p><strong>ç¬¬1æ¡è§„åˆ™æ˜¯</strong>ï¼Œå¾€Channelä¸­çš„å‘é€æ“ä½œï¼Œhappens before ä»è¯¥Channelæ¥æ”¶ç›¸åº”æ•°æ®çš„åŠ¨ä½œå®Œæˆä¹‹å‰ï¼Œå³ç¬¬nä¸ªsendä¸€å®šhappens beforeç¬¬nä¸ªreceiveçš„å®Œæˆã€‚</p><pre><code>var ch = make(chan struct{}, 10) // bufferedæˆ–è€…unbuffered\nvar s string\n\nfunc f() {\n\ts = &quot;hello, world&quot;\n\tch &lt;- struct{}{}\n}\n\nfunc main() {\n\tgo f()\n\t&lt;-ch\n\tprint(s)\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œsçš„åˆå§‹åŒ–ï¼ˆç¬¬5è¡Œï¼‰happens before å¾€chä¸­å‘é€æ•°æ®ï¼Œ å¾€chå‘é€æ•°æ® happens beforeä»chä¸­è¯»å–å‡ºä¸€æ¡æ•°æ®ï¼ˆç¬¬11è¡Œï¼‰ï¼Œç¬¬12è¡Œæ‰“å°sçš„å€¼ happens afterç¬¬11è¡Œï¼Œæ‰€ä»¥ï¼Œæ‰“å°çš„ç»“æœè‚¯å®šæ˜¯åˆå§‹åŒ–åçš„sçš„å€¼â€œhello worldâ€ã€‚</p><p><strong>ç¬¬2æ¡è§„åˆ™æ˜¯</strong>ï¼Œcloseä¸€ä¸ªChannelçš„è°ƒç”¨ï¼Œè‚¯å®šhappens before ä»å…³é—­çš„Channelä¸­è¯»å–å‡ºä¸€ä¸ªé›¶å€¼ã€‚</p><p>è¿˜æ˜¯æ‹¿åˆšåˆšçš„è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœä½ æŠŠç¬¬6è¡Œæ›¿æ¢æˆ close(ch)ï¼Œä¹Ÿèƒ½ä¿è¯åŒæ ·çš„æ‰§è¡Œé¡ºåºã€‚å› ä¸ºç¬¬11è¡Œä»å…³é—­çš„chä¸­è¯»å–å‡ºé›¶å€¼åï¼Œç¬¬6è¡Œè‚¯å®šè¢«è°ƒç”¨äº†ã€‚</p><p><strong>ç¬¬3æ¡è§„åˆ™æ˜¯</strong>ï¼Œå¯¹äºunbufferedçš„Channelï¼Œä¹Ÿå°±æ˜¯å®¹é‡æ˜¯0çš„Channelï¼Œä»æ­¤Channelä¸­è¯»å–æ•°æ®çš„è°ƒç”¨ä¸€å®šhappens before å¾€æ­¤Channelå‘é€æ•°æ®çš„è°ƒç”¨å®Œæˆã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ä¸­å‘¢ï¼Œå¦‚æœæƒ³ä¿æŒåŒæ ·çš„æ‰§è¡Œé¡ºåºï¼Œä¹Ÿå¯ä»¥å†™æˆè¿™æ ·ï¼š</p><pre><code>var ch = make(chan int)\nvar s string\n\nfunc f() {\n\ts = &quot;hello, world&quot;\n\t&lt;-ch\n}\n\nfunc main() {\n\tgo f()\n\tch &lt;- struct{}{}\n\tprint(s)\n}\n</code></pre><p>å¦‚æœç¬¬11è¡Œå‘é€è¯­å¥æ‰§è¡ŒæˆåŠŸï¼ˆå®Œæ¯•ï¼‰ï¼Œé‚£ä¹ˆæ ¹æ®è¿™ä¸ªè§„åˆ™ï¼Œç¬¬6è¡Œï¼ˆæ¥æ”¶ï¼‰çš„è°ƒç”¨è‚¯å®šå‘ç”Ÿäº†ï¼ˆæ‰§è¡Œå®Œæˆä¸å®Œæˆä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯è¿™ä¸€å¥â€œè‚¯å®šæ‰§è¡Œäº†â€ï¼‰ï¼Œé‚£ä¹ˆsä¹Ÿè‚¯å®šåˆå§‹åŒ–äº†ï¼Œæ‰€ä»¥ä¸€å®šä¼šæ‰“å°å‡ºâ€œhello worldâ€ã€‚</p><p>è¿™ä¸€æ¡æ¯”è¾ƒæ™¦æ¶©ï¼Œä½†æ˜¯ï¼Œå› ä¸ºChannelæ˜¯unbufferedçš„Channelï¼Œæ‰€ä»¥è¿™ä¸ªè§„åˆ™ä¹Ÿæˆç«‹ã€‚</p><p><strong>ç¬¬4æ¡è§„åˆ™æ˜¯</strong>ï¼Œå¦‚æœChannelçš„å®¹é‡æ˜¯mï¼ˆm&gt;0ï¼‰ï¼Œé‚£ä¹ˆï¼Œç¬¬nä¸ªreceiveä¸€å®šhappens before ç¬¬ n+m ä¸ª sendçš„å®Œæˆã€‚</p><p>å‰ä¸€æ¡è§„åˆ™æ˜¯é’ˆå¯¹unbuffered channelçš„ï¼Œè¿™é‡Œç»™å‡ºäº†æ›´å¹¿æ³›çš„é’ˆå¯¹buffered channelçš„ä¿è¯ã€‚åˆ©ç”¨è¿™ä¸ªè§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¿¡å·é‡ï¼ˆSemaphoreï¼‰çš„å¹¶å‘åŸè¯­ã€‚Channelçš„å®¹é‡ç›¸å½“äºå¯ç”¨çš„èµ„æºï¼Œå‘é€ä¸€æ¡æ•°æ®ç›¸å½“äºè¯·æ±‚ä¿¡å·é‡ï¼Œæ¥æ”¶ä¸€æ¡æ•°æ®ç›¸å½“äºé‡Šæ”¾ä¿¡å·ã€‚å…³äºä¿¡å·é‡è¿™ä¸ªå¹¶å‘åŸè¯­ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€è®²ä¸“é—¨ç»™ä½ ä»‹ç»ä¸€ä¸‹ï¼Œè¿™é‡Œä½ åªéœ€è¦çŸ¥é“å®ƒå¯ä»¥æ§åˆ¶å¤šä¸ªèµ„æºçš„å¹¶å‘è®¿é—®ï¼Œå°±å¯ä»¥äº†ã€‚</p><h2>Mutex/RWMutex</h2><p>å¯¹äºäº’æ–¥é”Mutex mæˆ–è€…è¯»å†™é”RWMutex mï¼Œæœ‰3æ¡happens-beforeå…³ç³»çš„ä¿è¯ã€‚</p><ol>\n<li>ç¬¬næ¬¡çš„m.Unlockä¸€å®šhappens beforeç¬¬n+1 m.Lockæ–¹æ³•çš„è¿”å›ï¼›</li>\n<li>å¯¹äºè¯»å†™é”RWMutex mï¼Œå¦‚æœå®ƒçš„ç¬¬nä¸ªm.Lockæ–¹æ³•çš„è°ƒç”¨å·²è¿”å›ï¼Œé‚£ä¹ˆå®ƒçš„ç¬¬nä¸ªm.Unlockçš„æ–¹æ³•è°ƒç”¨ä¸€å®šhappens before ä»»ä½•ä¸€ä¸ªm.RLockæ–¹æ³•è°ƒç”¨çš„è¿”å›ï¼Œåªè¦è¿™äº›m.RLockæ–¹æ³•è°ƒç”¨ happens after ç¬¬næ¬¡m.Lockçš„è°ƒç”¨çš„è¿”å›ã€‚è¿™å°±å¯ä»¥ä¿è¯ï¼Œåªæœ‰é‡Šæ”¾äº†æŒæœ‰çš„å†™é”ï¼Œé‚£äº›ç­‰å¾…çš„è¯»è¯·æ±‚æ‰èƒ½è¯·æ±‚åˆ°è¯»é”ã€‚</li>\n<li>å¯¹äºè¯»å†™é”RWMutex mï¼Œå¦‚æœå®ƒçš„ç¬¬nä¸ªm.RLockæ–¹æ³•çš„è°ƒç”¨å·²è¿”å›ï¼Œé‚£ä¹ˆå®ƒçš„ç¬¬k ï¼ˆk&lt;=nï¼‰ä¸ªæˆåŠŸçš„m.RUnlockæ–¹æ³•çš„è¿”å›ä¸€å®šhappens before ä»»æ„çš„m.RUnlockLockæ–¹æ³•è°ƒç”¨ï¼Œåªè¦è¿™äº›m.Lockæ–¹æ³•è°ƒç”¨happens afterç¬¬næ¬¡m.RLockã€‚</li>\n</ol><p>è¯»å†™é”çš„ä¿è¯æœ‰ç‚¹ç»•ï¼Œæˆ‘å†å¸¦ä½ çœ‹çœ‹å®˜æ–¹çš„æè¿°ï¼š</p><blockquote>\n<p>å¯¹äºè¯»å†™é”lçš„ l.RLockæ–¹æ³•è°ƒç”¨ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ª<strong>n</strong>ï¼Œè¿™æ¬¡çš„l.RLockè°ƒç”¨ happens after ç¬¬næ¬¡çš„l.Unlockï¼Œé‚£ä¹ˆï¼Œå’Œè¿™ä¸ªRLockç›¸å¯¹åº”çš„l.RUnlockä¸€å®šhappens before ç¬¬n+1æ¬¡l.Lockã€‚æ„æ€æ˜¯ï¼Œè¯»å†™é”çš„Lockå¿…é¡»ç­‰å¾…æ—¢æœ‰çš„è¯»é”é‡Šæ”¾åæ‰èƒ½è·å–åˆ°ã€‚</p>\n</blockquote><p>æˆ‘å†ä¸¾ä¸ªä¾‹å­ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œç¬¬6è¡Œç¬¬ä¸€æ¬¡çš„Unlockä¸€å®šhappens beforeç¬¬äºŒæ¬¡çš„Lockï¼ˆç¬¬12è¡Œï¼‰ï¼Œæ‰€ä»¥è¿™ä¹Ÿèƒ½ä¿è¯æ­£ç¡®åœ°æ‰“å°å‡ºâ€œhello worldâ€ã€‚</p><pre><code>var mu sync.Mutex\nvar s string\n\nfunc foo() {\n\ts = &quot;hello, world&quot;\n\tmu.Unlock()\n}\n\nfunc main() {\n\tmu.Lock()\n\tgo foo()\n\tmu.Lock()\n\tprint(s)\n</code></pre><h2>WaitGroup</h2><p>æ¥ä¸‹æ¥æ˜¯WaitGroupçš„ä¿è¯ã€‚</p><p>å¯¹äºä¸€ä¸ªWaitGroupå®ä¾‹wgï¼Œåœ¨æŸä¸ªæ—¶åˆ»t0æ—¶ï¼Œå®ƒçš„è®¡æ•°å€¼å·²ç»ä¸æ˜¯é›¶äº†ï¼Œå‡å¦‚t0æ—¶åˆ»ä¹‹åè°ƒç”¨äº†ä¸€ç³»åˆ—çš„wg.Add(n)æˆ–è€…wg.Done()ï¼Œå¹¶ä¸”åªæœ‰æœ€åä¸€æ¬¡è°ƒç”¨wgçš„è®¡æ•°å€¼å˜ä¸ºäº†0ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥ä¿è¯è¿™äº›wg.Addæˆ–è€…wg.Done()ä¸€å®š happens before t0æ—¶åˆ»ä¹‹åè°ƒç”¨çš„wg.Waitæ–¹æ³•çš„è¿”å›ã€‚</p><p>è¿™ä¸ªä¿è¯çš„é€šä¿—è¯´æ³•ï¼Œå°±æ˜¯<strong>Waitæ–¹æ³•ç­‰åˆ°è®¡æ•°å€¼å½’é›¶ä¹‹åæ‰è¿”å›</strong>ã€‚</p><h2>Once</h2><p>æˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/301113\">ç¬¬8è®²</a>å­¦è¿‡Onceäº†ï¼Œç›¸ä¿¡ä½ å·²ç»å¾ˆç†Ÿæ‚‰å®ƒçš„åŠŸèƒ½äº†ã€‚å®ƒæä¾›çš„ä¿è¯æ˜¯ï¼š<strong>å¯¹äºonce.Do(f)è°ƒç”¨ï¼Œfå‡½æ•°çš„é‚£ä¸ªå•æ¬¡è°ƒç”¨ä¸€å®šhappens before ä»»ä½•once.Do(f)è°ƒç”¨çš„è¿”å›</strong>ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯å‡½æ•°fä¸€å®šä¼šåœ¨Doæ–¹æ³•è¿”å›ä¹‹å‰æ‰§è¡Œã€‚</p><p>è¿˜æ˜¯ä»¥hello worldçš„ä¾‹å­ä¸ºä¾‹ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨Onceå¹¶å‘åŸè¯­å®ç°ï¼Œå¯ä»¥çœ‹ä¸‹ä¸‹é¢çš„ä»£ç ï¼š</p><pre><code>var s string\nvar once sync.Once\n\nfunc foo() {\n\ts = &quot;hello, world&quot;\n}\n\nfunc twoprint() {\n\tonce.Do(foo)\n\tprint(s)\n}\n</code></pre><p>ç¬¬5è¡Œçš„æ‰§è¡Œä¸€å®šhappens beforeç¬¬9è¡Œçš„è¿”å›ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°ç¬¬10è¡Œçš„æ—¶å€™ï¼Œsdå·²ç»åˆå§‹åŒ–äº†ï¼Œæ‰€ä»¥ä¼šæ­£ç¡®åœ°æ‰“å°â€œhello worldâ€ã€‚</p><p>æœ€åï¼Œæˆ‘å†æ¥è¯´è¯´atomicçš„ä¿è¯ã€‚</p><h2>atomic</h2><p>å…¶å®ï¼ŒGoå†…å­˜æ¨¡å‹çš„å®˜æ–¹æ–‡æ¡£å¹¶æ²¡æœ‰æ˜ç¡®ç»™å‡ºatomicçš„ä¿è¯ï¼Œæœ‰ä¸€ä¸ªç›¸å…³çš„issue <a href=\"https://github.com/golang/go/issues/5045\">go# 5045</a>è®°å½•äº†ç›¸å…³çš„è®¨è®ºã€‚å…‰çœ‹issueå·ï¼Œå°±çŸ¥é“è¿™ä¸ªè®¨è®ºç”±æ¥å·²ä¹…äº†ã€‚Russ Coxæƒ³è®©atomicæœ‰ä¸€ä¸ªå¼±ä¿è¯ï¼Œè¿™æ ·å¯ä»¥ä¸ºä»¥åç•™ä¸‹å……è¶³çš„å¯æ‰©å±•ç©ºé—´ï¼Œæ‰€ä»¥ï¼ŒGoå†…å­˜æ¨¡å‹è§„èŒƒä¸Šå¹¶æ²¡æœ‰ä¸¥æ ¼çš„å®šä¹‰ã€‚</p><p>å¯¹äºGo 1.15çš„å®˜æ–¹å®ç°æ¥è¯´ï¼Œå¯ä»¥ä¿è¯ä½¿ç”¨atomicçš„Load/Storeçš„å˜é‡ä¹‹é—´çš„é¡ºåºæ€§ã€‚</p><p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæ‰“å°å‡ºçš„açš„ç»“æœæ€»æ˜¯1ï¼Œä½†æ˜¯å®˜æ–¹å¹¶æ²¡æœ‰åšä»»ä½•æ–‡æ¡£ä¸Šçš„è¯´æ˜å’Œä¿è¯ã€‚</p><p>ä¾ç…§Ian Lance Taylorçš„è¯´æ³•ï¼ŒGoæ ¸å¿ƒå¼€å‘ç»„çš„æˆå‘˜å‡ ä¹æ²¡æœ‰å…³æ³¨è¿™ä¸ªæ–¹å‘ä¸Šçš„ç ”ç©¶ï¼Œå› ä¸ºè¿™ä¸ªé—®é¢˜å¤ªå¤æ‚ï¼Œæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦å»ç ”ç©¶ï¼Œæ‰€ä»¥ï¼Œç°é˜¶æ®µè¿˜æ˜¯ä¸è¦ä½¿ç”¨atomicæ¥ä¿è¯é¡ºåºæ€§ã€‚</p><pre><code>func main() {\n\tvar a, b int32 = 0, 0\n\n\tgo func() {\n\t\tatomic.StoreInt32(&amp;a, 1)\n\t\tatomic.StoreInt32(&amp;b, 1)\n\t}()\n\n\tfor atomic.LoadInt32(&amp;b) == 0{\n\t\truntime.Gosched()\n\t}\n    fmt.Println(atomic.LoadInt32(&amp;a))\n}\n</code></pre><h1>æ€»ç»“</h1><p>Goçš„å†…å­˜æ¨¡å‹è§„èŒƒä¸­ï¼Œä¸€å¼€å§‹æœ‰è¿™ä¹ˆä¸€æ®µè¯ï¼š</p><blockquote>\n<p>If you must read the rest of this document to understand the behavior of your program, you are being too clever.</p>\n</blockquote><blockquote>\n<p>Don't be clever.</p>\n</blockquote><p>æˆ‘æ¥è¯´è¯´æˆ‘å¯¹è¿™å¥è¯çš„ç†è§£ï¼šä½ é€šè¿‡å­¦ä¹ è¿™èŠ‚è¯¾æ¥ç†è§£ä½ çš„ç¨‹åºçš„è¡Œä¸ºæ˜¯èªæ˜çš„ï¼Œä½†æ˜¯ï¼Œä¸è¦è‡ªä½œèªæ˜ã€‚</p><p>è°¨æ…åœ°ä½¿ç”¨è¿™äº›ä¿è¯ï¼Œèƒ½å¤Ÿè®©ä½ çš„ç¨‹åºæŒ‰ç…§è®¾æƒ³çš„happens-beforeå…³ç³»æ‰§è¡Œï¼Œä½†æ˜¯ä¸è¦ä»¥ä¸ºå®Œå…¨ç†è§£è¿™äº›æ¦‚å¿µå’Œä¿è¯ï¼Œå°±å¯ä»¥éšæ„åœ°åˆ¶é€ æ‰€è°“çš„å„ç§æŠ€å·§ï¼Œå¦åˆ™å°±å¾ˆå®¹æ˜“æ‰è¿›â€œå‘â€é‡Œï¼Œè€Œä¸”ä¼šç»™ä»£ç åŸ‹ä¸‹äº†å¾ˆå¤šçš„â€œå®šæ—¶ç‚¸å¼¹â€ã€‚</p><p>æ¯”å¦‚ï¼ŒGoé‡Œé¢å·²ç»æœ‰å€¼å¾—ä¿¡èµ–çš„äº’æ–¥é”äº†ï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„éœ€æ±‚ï¼Œå°±ä¸è¦ä½¿ç”¨Channelåˆ›é€ å‡ºè‡ªå·±çš„äº’æ–¥é”ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä¹Ÿä¸å¸Œæœ›ä½ ç•æ‰‹ç•è„šåœ°æŠŠæ€æƒ³å±€é™ä½ï¼Œæˆ‘è¿˜æ˜¯å»ºè®®ä½ å»åšä¸€äº›æœ‰æ„ä¹‰çš„å°è¯•ï¼Œæ¯”å¦‚ä½¿ç”¨Channelå®ç°ä¿¡å·é‡ç­‰æ‰©å±•å¹¶å‘åŸè¯­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/dc/4d/dc68fc5f93a4af96c8f4d45d6282104d.jpg?wh=2250*2046\" alt=\"\"></p><h1>æ€è€ƒé¢˜</h1><p>æˆ‘ä»¬çŸ¥é“ï¼ŒChannelå¯ä»¥å®ç°äº’æ–¥é”ï¼Œé‚£ä¹ˆï¼Œæˆ‘æƒ³è¯·ä½ æ€è€ƒä¸€ä¸‹ï¼Œå®ƒæ˜¯å¦‚ä½•åˆ©ç”¨happens-beforeå…³ç³»ä¿è¯é”çš„è¯·æ±‚å’Œé‡Šæ”¾çš„å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","neighbors":{"left":{"article_title":"14 | Channelï¼šé€è¿‡ä»£ç çœ‹å…¸å‹çš„åº”ç”¨æ¨¡å¼","id":306614},"right":{"article_title":"16 | Semaphoreï¼šä¸€ç¯‡æ–‡ç« ææ‡‚ä¿¡å·é‡","id":308399}},"comments":[{"had_liked":false,"id":262876,"user_name":"åšç™½åŒå¼‚","can_delete":false,"product_type":"c1","uid":1375143,"ip_address":"","ucode":"4030C4B64068A6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajZWFgjupJHhmSN3jJ5o9ibecnOQQmJBTxvjwm5ssJjmG1iaNic8XNR6DvZNwIJdjpjkBibicnJYyZUIAnOkw2wwv8w/132","comment_is_top":false,"comment_ctime":1605865812,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"126159917396","product_id":100061801,"comment_content":"If you must read the rest of this document to understand the behavior of your program, you are being too clever.Donâ€™t be clever. çœ‹å®Œæ–‡æ¡£ä¹‹å,å¹´è½»äººä¸è¦å†çŠ¯è¿™æ ·çš„èªæ˜,å°èªæ˜,ç¨‹åºä»¥å’Œä¸ºè´µ,ä¸è¦çªé‡Œæ–—,è€—å­å°¾æ±.","like_count":29,"discussions":[{"author":{"id":1015986,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/80/b2/2e9f442d.jpg","nickname":"æ–‡æ­¦æœ¨å­","note":"","ucode":"348752BDECD65F","race_medal":5,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556204,"discussion_content":"å·®ç‚¹ç¬‘å‡ºå£°ã€‚ã€‚ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647245476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1283052,"avatar":"https://static001.geekbang.org/account/avatar/00/13/93/ec/985675c8.jpg","nickname":"å°é«˜","note":"","ucode":"FCD422249F7355","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383989,"discussion_content":"ä¼˜ç§€ï¼Œå“ˆå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626329866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2111673,"avatar":"https://static001.geekbang.org/account/avatar/00/20/38/b9/b496ff4d.jpg","nickname":"åŠªåŠ›åŠªåŠ›å†åŠªåŠ›","note":"","ucode":"8BBA96AE486FE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376973,"discussion_content":"çœŸæ˜¯ä¸ªäººæ‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622444948,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1445504,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/gVfU7icdia3o5ZNaHjaWAdgkSYIpU1rdhIlVYiahYCvRlDZu2K6oPSvVobNjzwZbUaiayQcKjicZ44WjfWJCj5xdlPA/132","nickname":"çº¢å°˜","note":"","ucode":"CCCD5736755DF5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351412,"discussion_content":"ä¸€å¥è¯æ¦‚æ‹¬ ä¼˜ç§€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614261061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115232,"avatar":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","nickname":"Fan","note":"","ucode":"3BF28670FD9407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337329,"discussion_content":"è¿™ä¸ªç¿»è¯‘æ›´åœ°é“ã€‚ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608876095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":328608,"user_name":"NULL","can_delete":false,"product_type":"c1","uid":1191550,"ip_address":"","ucode":"2A323DD05352BC","user_header":"https://static001.geekbang.org/account/avatar/00/12/2e/7e/ebc28e10.jpg","comment_is_top":false,"comment_ctime":1640788509,"is_pvip":false,"replies":[{"id":"119776","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1640867522,"ip_address":"","comment_id":328608,"utype":1}],"discussion_count":2,"race_medal":0,"score":"31705559581","product_id":100061801,"comment_content":"è¡¥å……ä¸ªgoè¯­è¨€åœ£ç»8.4.1èŠ‚çš„å†…å®¹ï¼šåœ¨è®¨è®ºå¹¶å‘ç¼–ç¨‹æ—¶ï¼Œå½“æˆ‘ä»¬è¯´xäº‹ä»¶åœ¨yäº‹ä»¶ä¹‹å‰å‘ç”Ÿï¼ˆhappens beforeï¼‰ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯è¯´xäº‹ä»¶åœ¨æ—¶é—´ä¸Šæ¯”yæ—¶é—´æ›´æ—©ï¼›æˆ‘ä»¬è¦è¡¨è¾¾çš„æ„æ€æ˜¯è¦ä¿è¯åœ¨æ­¤ä¹‹å‰çš„äº‹ä»¶éƒ½å·²ç»å®Œæˆäº†ï¼Œä¾‹å¦‚åœ¨æ­¤ä¹‹å‰çš„æ›´æ–°æŸäº›å˜é‡çš„æ“ä½œå·²ç»å®Œæˆï¼Œä½ å¯ä»¥æ”¾å¿ƒä¾èµ–è¿™äº›å·²å®Œæˆçš„äº‹ä»¶äº†ã€‚<br><br>å½“æˆ‘ä»¬è¯´xäº‹ä»¶æ—¢ä¸æ˜¯åœ¨yäº‹ä»¶ä¹‹å‰å‘ç”Ÿä¹Ÿä¸æ˜¯åœ¨yäº‹ä»¶ä¹‹åå‘ç”Ÿï¼Œæˆ‘ä»¬å°±è¯´xäº‹ä»¶å’Œyäº‹ä»¶æ˜¯å¹¶å‘çš„ã€‚è¿™å¹¶ä¸æ˜¯æ„å‘³ç€xäº‹ä»¶å’Œyäº‹ä»¶å°±ä¸€å®šæ˜¯åŒæ—¶å‘ç”Ÿçš„ï¼Œæˆ‘ä»¬åªæ˜¯ä¸èƒ½ç¡®å®šè¿™ä¸¤ä¸ªäº‹ä»¶å‘ç”Ÿçš„å…ˆåé¡ºåºã€‚","like_count":8,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542866,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640867522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1090142,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a2/5e/3871ff79.jpg","nickname":"è¿·é€”ä¹¦ç«¥","note":"","ucode":"462BE64D3373DA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583905,"discussion_content":"åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœ x happens before yï¼Œ xå‘ç”Ÿçš„æ—¶é—´ç‚¹æ˜¯åœ¨yå‘ç”Ÿçš„æ—¶é—´ç‚¹ä¹‹å‰è¿˜æ˜¯ä¹‹åï¼Ÿæˆ‘ç›¸ä¿¡è¿™ä¸ªé—®é¢˜åªä¼šæœ‰ä¸€ä¸ªç­”æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660483138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261325,"user_name":"myrfy","can_delete":false,"product_type":"c1","uid":1169401,"ip_address":"","ucode":"2814BAE5D70098","user_header":"","comment_is_top":false,"comment_ctime":1605272027,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23080108507","product_id":100061801,"comment_content":"æ€è€ƒé¢˜ï¼Œä»¥ä»chä¸­æ‹¿åˆ°tokenä¸ºè·å–åˆ°é”ï¼ŒAè·å–åˆ°tokenåæ‰§è¡Œè¢«ä¿æŠ¤çš„å†…å®¹ï¼Œæ­¤æ—¶Bå°è¯•è¯»å–chå¹¶é˜»å¡ï¼Œç”±äºchçš„ç¬¬ä¸€æ¡ï¼ŒAæ”¾å›tokençš„æ“ä½œ happen before Bå®Œæˆè·å–tokençš„æ“ä½œï¼Œæ‰€ä»¥å½“Bè·å–åˆ°tokenæ—¶ï¼Œå¯ä»¥ä¿è¯Açš„ä»£ç æ‰§è¡Œå·²ç»ç¦»å¼€äº†ä¸´ç•ŒåŒºã€‚<br><br>ç¬¬ä¸€æ¬¡é‡åˆ°å†…å­˜æ¨¡å‹æ˜¯åœ¨é˜…è¯»rocksdbçš„æºä»£ç æ—¶ï¼Œäº†è§£åˆ°äº†c++çš„å†…å­˜æ¨¡å‹ï¼Œåæ¥æŸ¥é˜…è¿‡ä¸€äº›åˆ—èµ„æ–™ï¼Œæ¯æ¬¡çœ‹éƒ½æœ‰æ–°çš„ä½“ä¼šï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹æƒ³ç†è§£é€çœŸçš„ä¸å®¹æ˜“ï¼Œä¸è¿‡æ„Ÿè§‰goå¯¹å†…å­˜æ¨¡å‹çš„æŠ½è±¡æ¯”C++ç®€å•äº†å¥½å¤š","like_count":5},{"had_liked":false,"id":261175,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1605234570,"is_pvip":false,"replies":[{"id":"94800","content":"1.æœ‰happen beforeå…³ç³»<br>2.æ²¡æœ‰è§„å®šï¼Œè™½ç„¶å®é™…æ˜¯è¿™æ ·çš„ã€‚ä½ è‚¯å®šä¹Ÿä¸ä¼šä¹Ÿä¸åº”è¯¥åˆ©ç”¨è¿™ä¸ªé¡ºåºåšç‚¹äº‹æƒ…","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605247778,"ip_address":"","comment_id":261175,"utype":1}],"discussion_count":1,"race_medal":1,"score":"18785103754","product_id":100061801,"comment_content":"è¯·é—®è€å¸ˆï¼Œæ–‡ä¸­ä¾‹å­ä¸­åŒ…P3ä¸­lib1å…ˆäºlib2æ‰§è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¸ªé¡ºåºæ˜¯å¦æ˜¯å¦æœ‰happen beforeå‘¢ï¼ŸåŒä¸€ä¸ªpackageå†…æ–‡ä»¶åˆå§‹åŒ–é¡ºåºæ˜¯æŒ‰ç…§æ–‡ä»¶åå­—æ¯åºæ¥æ‰§è¡Œçš„ä¹ˆï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509406,"discussion_content":"1.æœ‰happen beforeå…³ç³»\n2.æ²¡æœ‰è§„å®šï¼Œè™½ç„¶å®é™…æ˜¯è¿™æ ·çš„ã€‚ä½ è‚¯å®šä¹Ÿä¸ä¼šä¹Ÿä¸åº”è¯¥åˆ©ç”¨è¿™ä¸ªé¡ºåºåšç‚¹äº‹æƒ…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605247778,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318689,"user_name":"Jamey","can_delete":false,"product_type":"c1","uid":2344373,"ip_address":"","ucode":"449E4F65339CDE","user_header":"https://static001.geekbang.org/account/avatar/00/23/c5/b5/25179772.jpg","comment_is_top":false,"comment_ctime":1635392727,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5930360023","product_id":100061801,"comment_content":"çœ‹äº†è¿™ç¯‡æ–‡ç« å¯¹æŒ‡ä»¤é‡æ’ã€å˜é‡å¯è§æ€§ã€golangå†…å­˜æ¨¡å‹ æœ‰äº†æ›´æ·±çš„è®¤è¯†","like_count":1},{"had_liked":false,"id":293975,"user_name":"ç§‘ç§‘","can_delete":false,"product_type":"c1","uid":1647304,"ip_address":"","ucode":"7DAE6FE781172E","user_header":"https://static001.geekbang.org/account/avatar/00/19/22/c8/f2892022.jpg","comment_is_top":false,"comment_ctime":1621666145,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"5916633441","product_id":100061801,"comment_content":"æœç„¶æ²¡æœ‰ä»€ä¹ˆä¸œè¥¿æ˜¯ç†æ‰€åº”å½“ï¼Œå¤æ‚çš„ç¡¬ä»¶è¿è¡Œç¯å¢ƒï¼Œå¯¹äºç¨‹åºå‘˜æ¥è¯´åº”è¯¥æ˜¯é€æ˜çš„ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸€ç›®çš„ï¼Œæ¯ä¸ªè¯­è¨€éƒ½è¦è®¾è®¡å‡ºç›¸åº”çš„å†…å­˜æ¨¡å‹ã€‚å…¶å®å¾ˆå¥½ç†è§£ï¼Œæ‰€è°“çš„happens beforeï¼Œå°±æ˜¯è¦æ ¹æ®é€»è¾‘å’Œç¼–ç¨‹é¡ºåºæ¥å»å†³å®šä¸¤æ¬¡æ“ä½œçš„ä¸€ä¸ªå…ˆåé¡ºåºã€‚æŒ‰ç…§æ­£å¸¸é€»è¾‘ï¼Œå¦‚æœè§£é”çš„å‡½æ•°æ­£è¿”å›ï¼Œé‚£å°±è¡¨æ˜è¿™ä¸ªé”ä¹‹å‰è‚¯å®šæ˜¯è¢«åŠ ä¸Šçš„ã€‚æ‰€ä»¥ï¼Œlock  Happens before  unlock.","like_count":1},{"had_liked":false,"id":263082,"user_name":"èœ‰è£","can_delete":false,"product_type":"c1","uid":1229070,"ip_address":"","ucode":"77CF92496855D4","user_header":"https://static001.geekbang.org/account/avatar/00/12/c1/0e/2b987d54.jpg","comment_is_top":false,"comment_ctime":1605973966,"is_pvip":false,"replies":[{"id":"95494","content":"g1çœ‹åˆ°çš„é¡ºåºå’Œç¼–å†™é¡ºåºæ•ˆæœä¸Šçœ‹æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯è€ƒè™‘çš„å¤šæ ¸å’Œä¹±åºæ‰§è¡Œï¼ŒçœŸæ­£è¿è¡Œä¸ä¸€å®šå’Œç¼–å†™é¡ºåºä¸€æ ·","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1606022541,"ip_address":"","comment_id":263082,"utype":1}],"discussion_count":6,"race_medal":0,"score":"5900941262","product_id":100061801,"comment_content":"è€å¸ˆå¥½ï¼Œæˆ‘æœ‰äº›ä¸æ˜ç™½ï¼Œæ—¢ç„¶â€œåœ¨ä¸€ä¸ª goroutine å†…éƒ¨ï¼Œç¨‹åºçš„æ‰§è¡Œé¡ºåºå’Œå®ƒä»¬çš„ä»£ç æŒ‡å®šçš„é¡ºåºæ˜¯ä¸€æ ·çš„â€ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰ â€œç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œä¸èƒ½ä¿è¯ g2 çœ‹åˆ°çš„ a å’Œ b çš„èµ‹å€¼æœ‰å…ˆåå…³ç³»â€ï¼Ÿå‡è®¾ g2 çœ‹åˆ°äº† b=2ï¼Œè¯´æ˜ â€œb=2â€ ä¸€å®šæ‰§è¡Œè¿‡äº†ï¼Œè€Œå•ä¸ª goroutine å†…éƒ¨é¡ºåºæ˜¯æœ‰ä¿è¯ï¼Œæ‰€ä»¥ a=1 ä¹Ÿä¸€å®šæ‰§è¡Œè¿‡äº†ã€‚åŸºäºè¿™æ ·çš„æ€è€ƒï¼Œåé¢æ‰€æœ‰ç¤ºä¾‹æˆ‘åŸºæœ¬éƒ½ç†è§£ä¸äº†â€¦â€¦","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510089,"discussion_content":"g1çœ‹åˆ°çš„é¡ºåºå’Œç¼–å†™é¡ºåºæ•ˆæœä¸Šçœ‹æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯è€ƒè™‘çš„å¤šæ ¸å’Œä¹±åºæ‰§è¡Œï¼ŒçœŸæ­£è¿è¡Œä¸ä¸€å®šå’Œç¼–å†™é¡ºåºä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606022541,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2035702,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/0f/f6/609ded9f.jpg","nickname":"tingting","note":"","ucode":"61E6B0C4EC59C5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585283,"discussion_content":"æˆ‘ä¹Ÿå¡åœ¨äº†è¿™ä¸ªåœ°æ–¹ã€‚ ä¸ºä»€ä¹ˆåé¢çš„ä¾‹å­é‡Œé¢ï¼Œ æ¯”å¦‚è¿™ä¸ªä¾‹å­ï¼š\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œs çš„åˆå§‹åŒ–ï¼ˆç¬¬ 5 è¡Œï¼‰happens before å¾€ ch ä¸­å‘é€æ•°æ®ï¼Œ å¾€ ch å‘é€æ•°æ® happens before ä» ch ä¸­è¯»å–å‡ºä¸€æ¡æ•°æ®ï¼ˆç¬¬ 11 è¡Œï¼‰ï¼Œç¬¬ 12 è¡Œæ‰“å° s çš„å€¼ happens after ç¬¬ 11 è¡Œï¼Œæ‰€ä»¥ï¼Œæ‰“å°çš„ç»“æœè‚¯å®šæ˜¯åˆå§‹åŒ–åçš„ s çš„å€¼â€œhello worldâ€ã€‚\ng2å°±å¯ä»¥çœ‹åˆ°â€œs çš„åˆå§‹åŒ–ï¼ˆç¬¬ 5 è¡Œï¼‰happens before å¾€ ch ä¸­å‘é€æ•°æ®â€å‘¢ï¼Ÿ \n\néå¸¸çš„å›°æƒ‘ï¼Œæ¬¢è¿ç•™è¨€ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661439746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ–°åŠ å¡"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1133945,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4d/79/803537db.jpg","nickname":"æ…¢åŠ¨ä½œ","note":"","ucode":"62C944F4A4D8AC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380770,"discussion_content":"g1å°±ç®—æ‰§è¡Œè¿‡ï¼Œg2ä¹Ÿå¯èƒ½çœ‹ä¸åˆ°å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624693061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2147220,"avatar":"https://static001.geekbang.org/account/avatar/00/20/c3/94/e89ebc50.jpg","nickname":"ç¥æ¯“é€é¥","note":"","ucode":"83351CB18B190E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370514,"discussion_content":"æˆ‘ä¹Ÿè§‰å¾—åº”è¯¥æ›´åŠ æ·±å…¥çš„å›ç­”ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619440065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1811495,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","nickname":"å°è¢","note":"","ucode":"3F5D8721F577D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370424,"discussion_content":"æ„Ÿè§‰è€å¸ˆæ²¡æœ‰æ­£é¢å›ç­”åŒå­¦çš„é—®é¢˜ã€‚éš¾é“goæä¾›çš„é¡ºåºä¿è¯ï¼Œåœ¨ä¸€ä¸ªåç¨‹çœ‹æ¥å·²ç»æ˜¯é¡ºåºä¿è¯ï¼Œä½†åœ¨å¦å¤–ä¸€ä¸ªåç¨‹çœ‹æ¥å¯èƒ½æ˜¯æ²¡æœ‰ä¿è¯çš„ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619406821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1167430,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d0/46/7f9af8de.jpg","nickname":"å¯»","note":"","ucode":"473B2CC14158A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1811495,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","nickname":"å°è¢","note":"","ucode":"3F5D8721F577D9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572460,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652794089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":370424,"ip_address":""},"score":572460,"extra":""}]}]},{"had_liked":false,"id":262256,"user_name":"å¤§æ¼ èƒ¡èåœ","can_delete":false,"product_type":"c1","uid":1198953,"ip_address":"","ucode":"FBE51E4A13EF4F","user_header":"https://static001.geekbang.org/account/avatar/00/12/4b/69/c02eac91.jpg","comment_is_top":false,"comment_ctime":1605677341,"is_pvip":false,"replies":[{"id":"95154","content":"ç¬¬äºŒä¸ªlockæ–¹æ³•çš„è¿”å›ï¼Œä¸æ˜¯ç¬¬äºŒä¸ªlockæ–¹æ³•çš„è°ƒç”¨","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605691237,"ip_address":"","comment_id":262256,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5900644637","product_id":100061801,"comment_content":"æ²¡çœ‹æ˜ç™½ï¼šâ€œç¬¬ n æ¬¡çš„ m.Unlock ä¸€å®š happens before ç¬¬ n+1 m.Lock æ–¹æ³•çš„è¿”å›ï¼›â€<br>ä¸‹é¢çš„ä»£ç ç¬¬äºŒæ¬¡åŠ é”å¯èƒ½å…ˆäºç¬¬ä¸€æ¬¡è§£é”<br>```go<br><br>var mu sync.Mutex<br>var s string<br><br>func foo() {<br>  s = &quot;hello, world&quot;<br>  mu.Unlock()<br>}<br><br>func main() {<br>  mu.Lock()<br>  go foo()<br>  mu.Lock()<br>  print(s)<br>```","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509753,"discussion_content":"ç¬¬äºŒä¸ªlockæ–¹æ³•çš„è¿”å›ï¼Œä¸æ˜¯ç¬¬äºŒä¸ªlockæ–¹æ³•çš„è°ƒç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605691237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1056807,"avatar":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","nickname":"è™¢åœ‹æŠ€é†¬","note":"","ucode":"5A192262AA037E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":345998,"discussion_content":"ç¬¬n+1 m.Locké˜»å¡äº†ï¼Œå¿…é¡»ç­‰ç¬¬næ¬¡å¯¹åº”çš„m.Unlockåï¼Œæ‰èƒ½é‡æ–°ä¸Šé”ï¼Œæ‰€ä»¥ ç¬¬ n æ¬¡çš„ m.Unlock ä¸€å®š happens before ç¬¬ n+1 m.Lock æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611834764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355510,"user_name":"tingting","can_delete":false,"product_type":"c1","uid":2035702,"ip_address":"åŒ—äº¬","ucode":"61E6B0C4EC59C5","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0f/f6/609ded9f.jpg","comment_is_top":false,"comment_ctime":1661439329,"is_pvip":false,"replies":[{"id":"129585","content":"è¿™æ˜¯chanä¿è¯çš„ï¼Œç¬¬ä¸€ä¸ªä¾‹å­æ²¡æœ‰è°å¯ä»¥ä¿è¯","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1661945574,"ip_address":"åŒ—äº¬","comment_id":355510,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1661439329","product_id":100061801,"comment_content":"åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œs çš„åˆå§‹åŒ–ï¼ˆç¬¬ 5 è¡Œï¼‰happens before å¾€ ch ä¸­å‘é€æ•°æ®ï¼Œ å¾€ ch å‘é€æ•°æ® happens before ä» ch ä¸­è¯»å–å‡ºä¸€æ¡æ•°æ®ï¼ˆç¬¬ 11 è¡Œï¼‰ï¼Œç¬¬ 12 è¡Œæ‰“å° s çš„å€¼ happens after ç¬¬ 11 è¡Œï¼Œæ‰€ä»¥ï¼Œæ‰“å°çš„ç»“æœè‚¯å®šæ˜¯åˆå§‹åŒ–åçš„ s çš„å€¼â€œhello worldâ€ã€‚<br><br>ä¸ºä»€ä¹ˆå¦å¤–ä¸€ä¸ªgoroutine è¿™é‡Œå¯ä»¥æ„ŸçŸ¥åˆ°â€œs çš„åˆå§‹åŒ–ï¼ˆç¬¬ 5 è¡Œï¼‰happens before å¾€ ch ä¸­å‘é€æ•°æ®â€?  è·Ÿç¬¬ä¸€ä¸ªä¾‹å­ç±»ä¼¼ï¼Œè¿™é‡Œä¸æ˜¯æœ‰å¯èƒ½æŒ‡ä»¤é‡æ’å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586043,"discussion_content":"è¿™æ˜¯chanä¿è¯çš„ï¼Œç¬¬ä¸€ä¸ªä¾‹å­æ²¡æœ‰è°å¯ä»¥ä¿è¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661945574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355509,"user_name":"tingting","can_delete":false,"product_type":"c1","uid":2035702,"ip_address":"åŒ—äº¬","ucode":"61E6B0C4EC59C5","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0f/f6/609ded9f.jpg","comment_is_top":false,"comment_ctime":1661438989,"is_pvip":false,"replies":[{"id":"129584","content":"a=1 happens before b=2è¿™ä¸ªæ˜¯æ¨æ–­ä¸å‡ºæ¥çš„ã€‚ä»å¦ä¸€ä¸ªgoroutineçœ‹ä¸ä¸€å®š","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1661945489,"ip_address":"åŒ—äº¬","comment_id":355509,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1661438989","product_id":100061801,"comment_content":"ç¬¬ä¸€ä¸ªä¾‹å­ï¼šâ€œå¯ä»¥çœ‹åˆ°ï¼Œç¬¬ 9 è¡Œæ˜¯è¦æ‰“å° b çš„å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿è¿™é‡Œæ‰“å°å‡ºçš„å€¼æ˜¯ 2ï¼Œä½†æ˜¯ä¾ç„¶å¯èƒ½åœ¨æ‰“å° a çš„å€¼æ—¶ï¼Œæ‰“å°å‡ºåˆå§‹å€¼ 0ï¼Œè€Œä¸æ˜¯ 1ã€‚â€<br><br>å¦‚æœæ‰“å°å‡ºæ¥çš„æ˜¯2ï¼Œé‚£æ˜¯ä¸æ˜¯è¯´æ˜å¯¹äºè¯¥æ¬¡æ‰§è¡Œï¼Œb=2 happens before print(b), a=1 happens before b=2,æ‰€ä»¥æ‰“å°å‡ºæ¥çš„åº”è¯¥ä¸€å®šæ˜¯1ã€‚ <br><br>","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586042,"discussion_content":"a=1 happens before b=2è¿™ä¸ªæ˜¯æ¨æ–­ä¸å‡ºæ¥çš„ã€‚ä»å¦ä¸€ä¸ªgoroutineçœ‹ä¸ä¸€å®š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661945489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353204,"user_name":"Geek_a6104e","can_delete":false,"product_type":"c1","uid":1711967,"ip_address":"åŒ—äº¬","ucode":"29A56792216DC8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/GJXKh8OG00U5ial64plAIibbIuwkzhPc8uYic9Hibl8SbqvhnS2JImHgCD4JGvTktiaVnCjHQWbA5wicaxRUN5aTEWnQ/132","comment_is_top":false,"comment_ctime":1659258852,"is_pvip":false,"replies":[{"id":"129155","content":"è°¢è°¢ï¼Œé©¬ä¸Šæ›´æ–°","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1661008522,"ip_address":"åŒ—äº¬","comment_id":353204,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1659258852","product_id":100061801,"comment_content":"æ‰€ä»¥æ‰§è¡Œåˆ°ç¬¬ 10 è¡Œçš„æ—¶å€™ï¼Œsd å·²ç»     æ‰“é”™å­—äº† åº”è¯¥æ˜¯sè€Œä¸æ˜¯sd","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584659,"discussion_content":"è°¢è°¢ï¼Œé©¬ä¸Šæ›´æ–°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661008522,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352918,"user_name":"a","can_delete":false,"product_type":"c1","uid":1417722,"ip_address":"é™•è¥¿","ucode":"CE9F7FFFE17B38","user_header":"https://static001.geekbang.org/account/avatar/00/15/a1/fa/245bf91e.jpg","comment_is_top":false,"comment_ctime":1659009172,"is_pvip":false,"replies":[{"id":"128368","content":"è¿™æ˜¯æœ‰å¾ˆå¤§çš„å¯èƒ½çš„ï¼Œæ–‡ç« ä¸­è¯´è¿˜æœ‰åˆ«çš„å¯èƒ½","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1659095988,"ip_address":"é™•è¥¿","comment_id":352918,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1659009172","product_id":100061801,"comment_content":"ç¬¬ä¸€ä¸ªä¾‹å­æ‰“å°ä¸€ç›´æ˜¯0","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581977,"discussion_content":"è¿™æ˜¯æœ‰å¾ˆå¤§çš„å¯èƒ½çš„ï¼Œæ–‡ç« ä¸­è¯´è¿˜æœ‰åˆ«çš„å¯èƒ½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659095988,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é™•è¥¿"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":342608,"user_name":"666","can_delete":false,"product_type":"c1","uid":1062836,"ip_address":"","ucode":"31E15B351A58A7","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/b4/df897320.jpg","comment_is_top":false,"comment_ctime":1650362742,"is_pvip":false,"replies":[{"id":"126639","content":"å› ä¸ºè¿™æœ¬æ•°å¹¶æ²¡æœ‰å¯¹&quot;additional invariants&quot;æœ‰è¯¦ç»†è§£é‡Šï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä¹Ÿæ— æ³•ç†è§£ä½œè€…çš„çœŸæ­£çš„æ„ä¹‰ã€‚<br><br>ä½†æ˜¯stackoverflow ä¸Šæœ‰ä¸€ä¸ªé—®ç­”ï¼Œæˆ–è®¸å¯¹ä½ æœ‰æ‰€å¸®åŠ©<br>https:&#47;&#47;stackoverflow.com&#47;questions&#47;66195093&#47;could-someone-explain-the-term-invariants-in-mutex-locking","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1653899558,"ip_address":"","comment_id":342608,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1650362742","product_id":100061801,"comment_content":"GOPl é‚£æœ¬è“çš®ä¹¦ï¼Œç¬¬ä¹ç« è®²å…±äº«å˜é‡ï¼Œ9.2 èŠ‚ï¼ˆè‹±æ–‡ç‰ˆ 265 é¡µï¼‰æœ‰ä¸‹é¢è¿™æ®µè¯ï¼š<br><br>There is a good reason Go&#39;s mutexes are not re-entrant. The purpose of a mutex is to ensure that certain invariants of the shared variables are maintained at critical points during program execution. One of the invariants is &quot;no goroutine is accessing the shared variables&quot;, but there may be additional invariants specific to the data structures that the mutex guards. When a goroutine acquires a mutex lock, it may assume that the invirants hold. While it holds the lock, it may update the shared variables so that the invariants are temporarily violated. However, when it releases the lock, it must guarantee that the order has been restored and the invariants hold once again. Although a re-entrant mutex would ensure that no other goroutines are accessing the shared variables, it cannot protect the additional invariants of those variables.<br><br>æ€ä¹ˆç†è§£è¿™é‡Œçš„ invirants å‘¢ï¼Ÿè°¢è°¢è€å¸ˆ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574205,"discussion_content":"å› ä¸ºè¿™æœ¬æ•°å¹¶æ²¡æœ‰å¯¹&#34;additional invariants&#34;æœ‰è¯¦ç»†è§£é‡Šï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä¹Ÿæ— æ³•ç†è§£ä½œè€…çš„çœŸæ­£çš„æ„ä¹‰ã€‚\n\nä½†æ˜¯stackoverflow ä¸Šæœ‰ä¸€ä¸ªé—®ç­”ï¼Œæˆ–è®¸å¯¹ä½ æœ‰æ‰€å¸®åŠ©\nhttps://stackoverflow.com/questions/66195093/could-someone-explain-the-term-invariants-in-mutex-locking","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653899558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062836,"avatar":"https://static001.geekbang.org/account/avatar/00/10/37/b4/df897320.jpg","nickname":"666","note":"","ucode":"31E15B351A58A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565007,"discussion_content":"ç¬”è¯¯ï¼Œåº”è¯¥æ˜¯ invariantsï¼Œæ€ä¹ˆç†è§£è¿™é‡Œçš„ invariants å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650370997,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304764,"user_name":"æƒ˜ é—»","can_delete":false,"product_type":"c1","uid":1181650,"ip_address":"","ucode":"C5909F034BF072","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg","comment_is_top":false,"comment_ctime":1627607153,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627607153","product_id":100061801,"comment_content":"Channelçš„ç¬¬ä¸€æ¡å’Œç¬¬å››æ¡ä¿è¯çš„æœ‰ç¼“å­˜çš„channelä½œä¸ºé”çš„ä¿è¯ï¼Œç¬¬ä¸€æ¡å’Œç¬¬äºŒæ¡ä¿è¯çš„æ— ç¼“å­˜çš„channelä½œä¸ºé”çš„ä¿è¯","like_count":0},{"had_liked":false,"id":290152,"user_name":"å°è¢","can_delete":false,"product_type":"c1","uid":1811495,"ip_address":"","ucode":"3F5D8721F577D9","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","comment_is_top":false,"comment_ctime":1619405246,"is_pvip":false,"replies":[{"id":"105189","content":"å¯¹äºè°ƒç”¨helloæ–¹æ³•çš„goroutineæ¥è¯´ï¼Œå®ƒçœ‹åˆ°çš„ç»“æœåªèƒ½æ˜¯hello world,ä¸ä¼šçœ‹åˆ°ç©ºå€¼","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1619414229,"ip_address":"","comment_id":290152,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1619405246","product_id":100061801,"comment_content":"è¯·é—®ä½œè€…ï¼Œåœ¨ä½ çš„gorotinueçš„ä¾‹å­ä¸­<br>var a string<br>func f() { print(a)}<br>func hello() { a = &quot;hello, world&quot; go f()}<br><br>ä½ è¯´å¯¹å˜é‡açš„å¤åˆ¶ä¸€å®šåœ¨goè¯­å¥ä¹‹å‰ï¼Œè¿™æ˜¯ä¸ºå•¥ï¼Ÿå°†å¯¹å˜é‡açš„å¤åˆ¶æ”¾åœ¨goè¯­å¥ä¹‹åä¹Ÿæ˜¯ä¸å½±å“è¯»å†™çš„é‡æ’ï¼Ÿæ˜¯æˆ‘ç†è§£é”™äº†ä»€ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519126,"discussion_content":"å¯¹äºè°ƒç”¨helloæ–¹æ³•çš„goroutineæ¥è¯´ï¼Œå®ƒçœ‹åˆ°çš„ç»“æœåªèƒ½æ˜¯hello world,ä¸ä¼šçœ‹åˆ°ç©ºå€¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619414229,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1133945,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4d/79/803537db.jpg","nickname":"æ…¢åŠ¨ä½œ","note":"","ucode":"62C944F4A4D8AC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380767,"discussion_content":"ä¸æ˜¯è¿™æ ·çš„ï¼Œæ–‡ç« é‡Œè¯´äº†ä¸ºä»€ä¹ˆã€‚ä¹Ÿå¯ä»¥è‡ªå·±æµ‹è¯•ä¸‹https://play.golang.org/p/_VeSlJaIcG3","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624692319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1869163,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/85/6b/d77946a5.jpg","nickname":"æŸ¯å¯","note":"","ucode":"3D198F1A90C19A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371667,"discussion_content":"è¿™ä¸ªåœ°æ–¹æˆ‘ä¹Ÿæ²¡å¼„æ‡‚ï¼Œè€å¸ˆå¯ä»¥å†è®²æµ…æ˜¾æ˜“æ‡‚ç‚¹å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619890202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277060,"user_name":"KèŒæ— æƒ¨","can_delete":false,"product_type":"c1","uid":2194764,"ip_address":"","ucode":"97A532D588FD49","user_header":"","comment_is_top":false,"comment_ctime":1612250011,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612250011","product_id":100061801,"comment_content":"type Locker struct {<br>\tch chan struct{}<br>}<br><br>func NewLocker() Locker {<br>\treturn Locker{make(chan struct{}, 1)}<br>}<br><br>func (l *Locker) Lock() {<br>\tl.ch &lt;- struct{}{}<br>}<br><br>func (l *Locker) Unlock() {<br>\t&lt;- l.ch<br>}<br>","like_count":0},{"had_liked":false,"id":277058,"user_name":"KèŒæ— æƒ¨","can_delete":false,"product_type":"c1","uid":2194764,"ip_address":"","ucode":"97A532D588FD49","user_header":"","comment_is_top":false,"comment_ctime":1612248366,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612248366","product_id":100061801,"comment_content":"æ€ªä¸å¾—goçš„å¹¶å‘åŸè¯­çš„æºç é‡Œé¢æœ‰è¿™ä¹ˆå¤šå¯¹é”çš„åŒé‡æ£€æŸ¥,åŸæ¥æ˜¯æœ‰happens-beforeçš„ä¿è¯","like_count":0},{"had_liked":false,"id":276679,"user_name":"( ï½¥á·„á½¢ï½¥á·… )","can_delete":false,"product_type":"c1","uid":2234129,"ip_address":"","ucode":"E5F5EDEBB74C46","user_header":"https://static001.geekbang.org/account/avatar/00/22/17/11/a63acc6a.jpg","comment_is_top":false,"comment_ctime":1612075739,"is_pvip":false,"replies":[{"id":"100403","content":"æ— ç¼“å†²ä¸è¡Œã€‚è¦buffer=1","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1612090566,"ip_address":"","comment_id":276679,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1612075739","product_id":100061801,"comment_content":"æˆ‘ä»¬çŸ¥é“ï¼ŒChannel å¯ä»¥å®ç°äº’æ–¥é”ï¼Œé‚£ä¹ˆï¼Œæˆ‘æƒ³è¯·ä½ æ€è€ƒä¸€ä¸‹ï¼Œå®ƒæ˜¯å¦‚ä½•åˆ©ç”¨ happens-before å…³ç³»ä¿è¯é”çš„è¯·æ±‚å’Œé‡Šæ”¾çš„å‘¢ï¼Ÿ<br>ç­”ï¼šæ— ç¼“å†²é€šé“åšä»¤ç‰Œæ–¹å¼ï¼Œæ‹¿åˆ°ä»¤ç‰Œå³ä¸ºLockï¼Œå½’è¿˜ä»¤ç‰Œå³ä¸ºUnlockï¼Œæ­¤æ—¶å’Œäº’æ–¥é”çš„Lockå’ŒUnlockçš„å·®ä¸å¤šäº†","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514790,"discussion_content":"æ— ç¼“å†²ä¸è¡Œã€‚è¦buffer=1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612090566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1647304,"avatar":"https://static001.geekbang.org/account/avatar/00/19/22/c8/f2892022.jpg","nickname":"ç§‘ç§‘","note":"","ucode":"7DAE6FE781172E","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375449,"discussion_content":"å¦‚æœæ²¡æœ‰ç¼“å­˜åŒºï¼Œè°ƒç”¨lockçš„æ—¶å€™å°±ä¼šè¢«é˜»å¡ï¼Œè¦è®¾ç½®ç¼“å­˜åŒºä¸º1ï¼Œç„¶ååœ¨åˆå§‹åŒ–çš„æ—¶å€™å…ˆå¾€é‡Œé¢å†™ä¸€æ¡ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621665856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":276218,"user_name":"è™¢åœ‹æŠ€é†¬","can_delete":false,"product_type":"c1","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1611835579,"is_pvip":false,"replies":[{"id":"100289","content":"å¯¹çš„ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1611875936,"ip_address":"","comment_id":276218,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1611835579","product_id":100061801,"comment_content":"ç»§ç»­è‡ªæˆ‘å’€åš¼ï¼š<br>2ã€â€œç¬¬ n æ¬¡çš„ m.Unlock ä¸€å®š happens before ç¬¬ n+1 m.Lock æ–¹æ³•çš„è¿”å›ï¼›â€ å“åº”ç¬¬ n+1 m.LockæˆåŠŸï¼Œå¿…éœ€ä¿è¯ må·²ç»è§£é”æˆ–æœªä¸Šé”ï¼Œä¸ç„¶ç¬¬ n+1 m.Lockä¼šé˜»å¡ç­‰å¾…ï¼›æ‰€ä»¥ï¼Œç¬¬ n æ¬¡çš„ m.Unlock ä¸€å®šå‘ç”Ÿåœ¨ç¬¬ n+1 m.Lockä¹‹å‰","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514632,"discussion_content":"å¯¹çš„ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611875936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265430,"user_name":"ç–¯ç´","can_delete":false,"product_type":"c1","uid":1099379,"ip_address":"","ucode":"82ACAA4A27753D","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1606896000,"is_pvip":false,"replies":[{"id":"96496","content":"ç”±äºcpu cacheçš„é—®é¢˜ï¼Œä¸æ‰¿è¯ºmainèƒ½çœ‹åˆ°","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1606907485,"ip_address":"","comment_id":265430,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1606896000","product_id":100061801,"comment_content":"è¯·é—®è€å¸ˆï¼Œåœ¨â€œåŠåˆå§‹åŒ–&quot;çš„ä¾‹å­ä¸­ï¼Œä¸ºä»€ä¹ˆä¼šâ€main æ ¹æœ¬å°±è§‚å¯Ÿä¸åˆ°å¦ä¸€ä¸ª goroutine å¯¹ done çš„å†™æ“ä½œâ€œï¼Ÿdoneæ˜¯å…¬å…±å˜é‡ï¼Œmainä¸ºä»€ä¹ˆä¼šè§‚å¯Ÿä¸åˆ°å¯¹å®ƒçš„æ”¹åŠ¨ï¼Ÿå¦‚æœforå¾ªç¯ä¸­åŠ ä¸€å°æ®µç¡çœ æ—¶é—´å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510926,"discussion_content":"ç”±äºcpu cacheçš„é—®é¢˜ï¼Œä¸æ‰¿è¯ºmainèƒ½çœ‹åˆ°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606907485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1118228,"avatar":"https://static001.geekbang.org/account/avatar/00/11/10/14/abb7bfe3.jpg","nickname":"å»ºå›½ä¹‹åä¸è®¸æˆç²¾","note":"","ucode":"8024473644FF41","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379256,"discussion_content":"è¿™é‡Œè¯´çš„åº”è¯¥æ˜¯å¤šæ ¸cpuçš„æƒ…å†µä¸‹ã€‚å¦‚æœæ˜¯å•æ ¸ï¼Œmainä¸€å®šèƒ½è§‚å¯Ÿåˆ°çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623775341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2554951,"avatar":"https://static001.geekbang.org/account/avatar/00/26/fc/47/5fb0d905.jpg","nickname":"å¼ å¥å","note":"","ucode":"577452129C885A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1118228,"avatar":"https://static001.geekbang.org/account/avatar/00/11/10/14/abb7bfe3.jpg","nickname":"å»ºå›½ä¹‹åä¸è®¸æˆç²¾","note":"","ucode":"8024473644FF41","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394018,"discussion_content":"æ„æ€æ˜¯è¯´ï¼Œè¿è¡Œåœ¨å¤šä¸ªcpuçš„ä¸åŒgo routineï¼Œå…¶è‡ªèº«å¯¹å†…å­˜å˜é‡çš„æ›´æ”¹ï¼Œç”±äºcpu ç¼“å­˜çš„å­˜åœ¨ï¼Œæ˜¯æ›´æ”¹åœ¨æœ¬cpuçš„ç¼“å­˜ä¸­ï¼Œæ›´æ”¹åä¸èƒ½ç«‹å³è¢«è¿è¡Œåœ¨å…¶ä»–cpuä¸Šçš„go routineæ„ŸçŸ¥åˆ°ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631690539,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":379256,"ip_address":""},"score":394018,"extra":""}]},{"author":{"id":1099379,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c6/73/abb7bfe3.jpg","nickname":"ç–¯ç´","note":"","ucode":"82ACAA4A27753D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331592,"discussion_content":"è°¢è°¢è€å¸ˆï¼Œæˆ‘æœç´¢semi initiate / half initiateæ²¡æ‰¾åˆ°è¿™æ–¹é¢çš„å†…å®¹ï¼Œè€å¸ˆæœ‰ç›¸å…³çš„æ–‡ç« æ¨èä¹ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606909151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265300,"user_name":"benying","can_delete":false,"product_type":"c1","uid":1247522,"ip_address":"","ucode":"DEBAB485F381CC","user_header":"https://static001.geekbang.org/account/avatar/00/13/09/22/22c0c4fa.jpg","comment_is_top":false,"comment_ctime":1606841394,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1606841394","product_id":100061801,"comment_content":"ä¹‹å‰ç¡®å®ä¸€ç›´ç–‘æƒ‘ä¸ºå•¥å†…å­˜æ¨¡å‹è®²çš„ä¸æ˜¯å†…å­˜åˆ†é…çš„ä¸œè¥¿ã€‚ã€‚ã€‚è°¢è°¢å¤§ä½¬è§£æƒ‘","like_count":0},{"had_liked":false,"id":264795,"user_name":"Kepler","can_delete":false,"product_type":"c1","uid":1214303,"ip_address":"","ucode":"0C9CA3DB8B3CF0","user_header":"https://static001.geekbang.org/account/avatar/00/12/87/5f/6bf8b74a.jpg","comment_is_top":false,"comment_ctime":1606652191,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1606652191","product_id":100061801,"comment_content":"æ€è€ƒé¢˜ï¼Œä½¿ç”¨ä¸€ä¸ªå®¹é‡ä¸º1çš„buffer channelå®ç°mutex ï¼Œåˆ©ç”¨ç¬¬næ¬¡recv(ç¦»å‘é‡Šæ”¾é”)happen before ç¬¬n+1æ¬¡send(å å‘ä¸Šé”)","like_count":0},{"had_liked":false,"id":262783,"user_name":"ç½‘ç®¡","can_delete":false,"product_type":"c1","uid":1176852,"ip_address":"","ucode":"608175DF616365","user_header":"https://static001.geekbang.org/account/avatar/00/11/f5/14/92b373dd.jpg","comment_is_top":false,"comment_ctime":1605841569,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1605841569","product_id":100061801,"comment_content":"ä¸çŸ¥é“ä»¥å‰çš„ç‰ˆæœ¬æ˜¯ä¸æ˜¯ï¼Œä½†æ˜¯åœ¨go 1.13é‡ŒåŒä¸€ä¸ªgoæ–‡ä»¶é‡Œæ˜¯å¯ä»¥å†™å¤šä¸ªinitå‡½æ•°çš„ã€‚","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327476,"discussion_content":"æ˜¯çš„ï¼ŒåŒä¸€ä¸ªæ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªç›¸åŒç­¾åinitå‡½æ•°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605847483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262428,"user_name":"å…š","can_delete":false,"product_type":"c1","uid":1071974,"ip_address":"","ucode":"EE531DB3EA124D","user_header":"https://static001.geekbang.org/account/avatar/00/10/5b/66/ad35bc68.jpg","comment_is_top":false,"comment_ctime":1605716599,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605716599","product_id":100061801,"comment_content":"channaelï¼Œç¬¬ä¸€æ¡æŒ‡çš„æ˜¯å‘é€è¿™ä¸ªåŠ¨ä½œä¸€å®šåœ¨æ¥æ”¶è¿™ä¸ªåŠ¨ä½œä¹‹å‰ï¼Œè€Œç¬¬ä¸‰å››æ¡æŒ‡çš„æ˜¯æ¥æ”¶ä»£ç çš„æ‰§è¡Œä¸€å®šåœ¨å‘é€è¿™ä¸ªä»£ç æ‰§è¡Œçš„å‰è¾¹ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ å…ˆæ‰§è¡Œæ¥æ”¶ä»£ç ï¼Œåœ¨æ‰§è¡Œå‘é€ä»£ç ï¼Œå…ˆæœ‰å‘é€åŠ¨ä½œå†æœ‰æ¥æ”¶åŠ¨ä½œã€‚","like_count":0},{"had_liked":false,"id":262226,"user_name":"GoGoGo","can_delete":false,"product_type":"c1","uid":2316381,"ip_address":"","ucode":"D2E10FB7A4008F","user_header":"https://static001.geekbang.org/account/avatar/00/23/58/5d/97f3a6a8.jpg","comment_is_top":false,"comment_ctime":1605668312,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605668312","product_id":100061801,"comment_content":"è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„","like_count":0},{"had_liked":false,"id":261778,"user_name":"pdf","can_delete":false,"product_type":"c1","uid":1649662,"ip_address":"","ucode":"A44250955878BB","user_header":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","comment_is_top":false,"comment_ctime":1605520353,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1605520353","product_id":100061801,"comment_content":"æ™¦æ¶©éš¾æ‡‚äº†~<br>è¿™ä¸€ç« æœ‰ç‚¹éš¾~","like_count":0,"discussions":[{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326351,"discussion_content":"ç¡®å®æœ‰ç‚¹â€œç„å­¦â€äº†~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605582721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261121,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1605222992,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605222992","product_id":100061801,"comment_content":"æ‰“å¡ã€‚","like_count":0}]}