{"id":112118,"title":"27 | 关于高水位和Leader Epoch的讨论","content":"<p>你好，我是胡夕。今天我要和你分享的主题是：Kafka中的高水位和Leader Epoch机制。</p><p>你可能听说过高水位（High Watermark），但不一定耳闻过Leader Epoch。前者是Kafka中非常重要的概念，而后者是社区在0.11版本中新推出的，主要是为了弥补高水位机制的一些缺陷。鉴于高水位机制在Kafka中举足轻重，而且深受各路面试官的喜爱，今天我们就来重点说说高水位。当然，我们也会花一部分时间来讨论Leader Epoch以及它的角色定位。</p><h2>什么是高水位？</h2><p>首先，我们要明确一下基本的定义：什么是高水位？或者说什么是水位？水位一词多用于流式处理领域，比如，Spark Streaming或Flink框架中都有水位的概念。教科书中关于水位的经典定义通常是这样的：</p><blockquote>\n<p>在时刻T，任意创建时间（Event Time）为T’，且T’≤T的所有事件都已经到达或被观测到，那么T就被定义为水位。</p>\n</blockquote><p>“Streaming System”一书则是这样表述水位的：</p><blockquote>\n<p>水位是一个单调增加且表征最早未完成工作（oldest work not yet completed）的时间戳。</p>\n</blockquote><p>为了帮助你更好地理解水位，我借助这本书里的一张图来说明一下。</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/84/77/8426888d04e1e9917619829b7e3de877.png?wh=1950*624\" alt=\"\"></p><p>图中标注“Completed”的蓝色部分代表已完成的工作，标注“In-Flight”的红色部分代表正在进行中的工作，两者的边界就是水位线。</p><p>在Kafka的世界中，水位的概念有一点不同。Kafka的水位不是时间戳，更与时间无关。它是和位置信息绑定的，具体来说，它是用消息位移来表征的。另外，Kafka源码使用的表述是高水位，因此，今天我也会统一使用“高水位”或它的缩写HW来进行讨论。值得注意的是，Kafka中也有低水位（Low Watermark），它是与Kafka删除消息相关联的概念，与今天我们要讨论的内容没有太多联系，我就不展开讲了。</p><h2>高水位的作用</h2><p>在Kafka中，高水位的作用主要有2个。</p><ol>\n<li>定义消息可见性，即用来标识分区下的哪些消息是可以被消费者消费的。</li>\n<li>帮助Kafka完成副本同步。</li>\n</ol><p>下面这张图展示了多个与高水位相关的Kafka术语。我来详细解释一下图中的内容，同时澄清一些常见的误区。</p><p><img src=\"https://static001.geekbang.org/resource/image/45/db/453ff803a31aa030feedba27aed17ddb.jpg?wh=4000*1583\" alt=\"\"></p><p>我们假设这是某个分区Leader副本的高水位图。首先，请你注意图中的“已提交消息”和“未提交消息”。我们之前在专栏<a href=\"https://time.geekbang.org/column/article/102931\">第11讲</a>谈到Kafka持久性保障的时候，特意对两者进行了区分。现在，我借用高水位再次强调一下。在分区高水位以下的消息被认为是已提交消息，反之就是未提交消息。消费者只能消费已提交消息，即图中位移小于8的所有消息。注意，这里我们不讨论Kafka事务，因为事务机制会影响消费者所能看到的消息的范围，它不只是简单依赖高水位来判断。它依靠一个名为LSO（Log Stable Offset）的位移值来判断事务型消费者的可见性。</p><p>另外，需要关注的是，<strong>位移值等于高水位的消息也属于未提交消息。也就是说，高水位上的消息是不能被消费者消费的</strong>。</p><p>图中还有一个日志末端位移的概念，即Log End Offset，简写是LEO。它表示副本写入下一条消息的位移值。注意，数字15所在的方框是虚线，这就说明，这个副本当前只有15条消息，位移值是从0到14，下一条新消息的位移是15。显然，介于高水位和LEO之间的消息就属于未提交消息。这也从侧面告诉了我们一个重要的事实，那就是：<strong>同一个副本对象，其高水位值不会大于LEO值</strong>。</p><p><strong>高水位和LEO是副本对象的两个重要属性</strong>。Kafka所有副本都有对应的高水位和LEO值，而不仅仅是Leader副本。只不过Leader副本比较特殊，Kafka使用Leader副本的高水位来定义所在分区的高水位。换句话说，<strong>分区的高水位就是其Leader副本的高水位</strong>。</p><h2>高水位更新机制</h2><p>现在，我们知道了每个副本对象都保存了一组高水位值和LEO值，但实际上，在Leader副本所在的Broker上，还保存了其他Follower副本的LEO值。我们一起来看看下面这张图。</p><p><img src=\"https://static001.geekbang.org/resource/image/8b/de/8b1b8474a568e2ae40bf36bb03ca81de.jpg?wh=2347*1648\" alt=\"\"></p><p>在这张图中，我们可以看到，Broker 0上保存了某分区的Leader副本和所有Follower副本的LEO值，而Broker 1上仅仅保存了该分区的某个Follower副本。Kafka把Broker 0上保存的这些Follower副本又称为<strong>远程副本</strong>（Remote Replica）。Kafka副本机制在运行过程中，会更新Broker 1上Follower副本的高水位和LEO值，同时也会更新Broker 0上Leader副本的高水位和LEO以及所有远程副本的LEO，但它不会更新远程副本的高水位值，也就是我在图中标记为灰色的部分。</p><p>为什么要在Broker 0上保存这些远程副本呢？其实，它们的主要作用是，<strong>帮助Leader副本确定其高水位，也就是分区高水位</strong>。</p><p>为了帮助你更好地记忆这些值被更新的时机，我做了一张表格。只有搞清楚了更新机制，我们才能开始讨论Kafka副本机制的原理，以及它是如何使用高水位来执行副本消息同步的。</p><p><img src=\"https://static001.geekbang.org/resource/image/d6/41/d6d2f98c611e06ffb85f01031ca79b41.jpg?wh=3894*2216\" alt=\"\"></p><p>在这里，我稍微解释一下，什么叫与Leader副本保持同步。判断的条件有两个。</p><ol>\n<li>该远程Follower副本在ISR中。</li>\n<li>该远程Follower副本LEO值落后于Leader副本LEO值的时间，不超过Broker端参数replica.lag.time.max.ms的值。如果使用默认值的话，就是不超过10秒。</li>\n</ol><p>乍一看，这两个条件好像是一回事，因为目前某个副本能否进入ISR就是靠第2个条件判断的。但有些时候，会发生这样的情况：即Follower副本已经“追上”了Leader的进度，却不在ISR中，比如某个刚刚重启回来的副本。如果Kafka只判断第1个条件的话，就可能出现某些副本具备了“进入ISR”的资格，但却尚未进入到ISR中的情况。此时，分区高水位值就可能超过ISR中副本LEO，而高水位 &gt; LEO的情形是不被允许的。</p><p>下面，我们分别从Leader副本和Follower副本两个维度，来总结一下高水位和LEO的更新机制。</p><p><strong>Leader副本</strong></p><p>处理生产者请求的逻辑如下：</p><ol>\n<li>写入消息到本地磁盘。</li>\n<li>更新分区高水位值。<br>\ni. 获取Leader副本所在Broker端保存的所有远程副本LEO值（LEO-1，LEO-2，……，LEO-n）。<br>\nii. 获取Leader副本高水位值：currentHW。<br>\niii. 更新 currentHW = max{currentHW, min（LEO-1, LEO-2, ……，LEO-n）}。</li>\n</ol><p>处理Follower副本拉取消息的逻辑如下：</p><ol>\n<li>读取磁盘（或页缓存）中的消息数据。</li>\n<li>使用Follower副本发送请求中的位移值更新远程副本LEO值。</li>\n<li>更新分区高水位值（具体步骤与处理生产者请求的步骤相同）。</li>\n</ol><p><strong>Follower副本</strong></p><p>从Leader拉取消息的处理逻辑如下：</p><ol>\n<li>写入消息到本地磁盘。</li>\n<li>更新LEO值。</li>\n<li>更新高水位值。<br>\ni. 获取Leader发送的高水位值：currentHW。<br>\nii. 获取步骤2中更新过的LEO值：currentLEO。<br>\niii. 更新高水位为min(currentHW, currentLEO)。</li>\n</ol><h2>副本同步机制解析</h2><p>搞清楚了这些值的更新机制之后，我来举一个实际的例子，说明一下Kafka副本同步的全流程。该例子使用一个单分区且有两个副本的主题。</p><p>当生产者发送一条消息时，Leader和Follower副本对应的高水位是怎么被更新的呢？我给出了一些图片，我们一一来看。</p><p>首先是初始状态。下面这张图中的remote LEO就是刚才的远程副本的LEO值。在初始状态时，所有值都是0。</p><p><img src=\"https://static001.geekbang.org/resource/image/1e/36/1ee643ce819a503f72df3d9b4ab04536.jpg?wh=3173*691\" alt=\"\"></p><p>当生产者给主题分区发送一条消息后，状态变更为：</p><p><img src=\"https://static001.geekbang.org/resource/image/73/0b/7317242d7068dbf618866d5974a2d80b.jpg?wh=3147*1271\" alt=\"\"></p><p>此时，Leader副本成功将消息写入了本地磁盘，故LEO值被更新为1。</p><p>Follower再次尝试从Leader拉取消息。和之前不同的是，这次有消息可以拉取了，因此状态进一步变更为：</p><p><img src=\"https://static001.geekbang.org/resource/image/91/0d/910e114abe40f1f9e4a13f6e6083320d.jpg?wh=3167*1013\" alt=\"\"></p><p>这时，Follower副本也成功地更新LEO为1。此时，Leader和Follower副本的LEO都是1，但各自的高水位依然是0，还没有被更新。<strong>它们需要在下一轮的拉取中被更新</strong>，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/80/cb/8066e72733f14d2732a054ed56e373cb.jpg?wh=3081*1560\" alt=\"\"></p><p>在新一轮的拉取请求中，由于位移值是0的消息已经拉取成功，因此Follower副本这次请求拉取的是位移值=1的消息。Leader副本接收到此请求后，更新远程副本LEO为1，然后更新Leader高水位为1。做完这些之后，它会将当前已更新过的高水位值1发送给Follower副本。Follower副本接收到以后，也将自己的高水位值更新成1。至此，一次完整的消息同步周期就结束了。事实上，Kafka就是利用这样的机制，实现了Leader和Follower副本之间的同步。</p><h2>Leader Epoch登场</h2><p>故事讲到这里似乎很完美，依托于高水位，Kafka既界定了消息的对外可见性，又实现了异步的副本同步机制。不过，我们还是要思考一下这里面存在的问题。</p><p>从刚才的分析中，我们知道，Follower副本的高水位更新需要一轮额外的拉取请求才能实现。如果把上面那个例子扩展到多个Follower副本，情况可能更糟，也许需要多轮拉取请求。也就是说，Leader副本高水位更新和Follower副本高水位更新在时间上是存在错配的。这种错配是很多“数据丢失”或“数据不一致”问题的根源。基于此，社区在0.11版本正式引入了Leader Epoch概念，来规避因高水位更新错配导致的各种不一致问题。</p><p>所谓Leader Epoch，我们大致可以认为是Leader版本。它由两部分数据组成。</p><ol>\n<li>Epoch。一个单调增加的版本号。每当副本领导权发生变更时，都会增加该版本号。小版本号的Leader被认为是过期Leader，不能再行使Leader权力。</li>\n<li>起始位移（Start Offset）。Leader副本在该Epoch值上写入的首条消息的位移。</li>\n</ol><p>我举个例子来说明一下Leader Epoch。假设现在有两个Leader Epoch&lt;0, 0&gt;和&lt;1, 120&gt;，那么，第一个Leader Epoch表示版本号是0，这个版本的Leader从位移0开始保存消息，一共保存了120条消息。之后，Leader发生了变更，版本号增加到1，新版本的起始位移是120。</p><p>Kafka Broker会在内存中为每个分区都缓存Leader Epoch数据，同时它还会定期地将这些信息持久化到一个checkpoint文件中。当Leader副本写入消息到磁盘时，Broker会尝试更新这部分缓存。如果该Leader是首次写入消息，那么Broker会向缓存中增加一个Leader Epoch条目，否则就不做更新。这样，每次有Leader变更时，新的Leader副本会查询这部分缓存，取出对应的Leader Epoch的起始位移，以避免数据丢失和不一致的情况。</p><p>接下来，我们来看一个实际的例子，它展示的是Leader Epoch是如何防止数据丢失的。请先看下图。</p><p><img src=\"https://static001.geekbang.org/resource/image/4d/f5/4d97a873fc1bfaf89b5cc8259838f0f5.jpg?wh=2254*2036\" alt=\"\"></p><p>我稍微解释一下，单纯依赖高水位是怎么造成数据丢失的。开始时，副本A和副本B都处于正常状态，A是Leader副本。某个使用了默认acks设置的生产者程序向A发送了两条消息，A全部写入成功，此时Kafka会通知生产者说两条消息全部发送成功。</p><p>现在我们假设Leader和Follower都写入了这两条消息，而且Leader副本的高水位也已经更新了，但Follower副本高水位还未更新——这是可能出现的。还记得吧，Follower端高水位的更新与Leader端有时间错配。倘若此时副本B所在的Broker宕机，当它重启回来后，副本B会执行日志截断操作，将LEO值调整为之前的高水位值，也就是1。这就是说，位移值为1的那条消息被副本B从磁盘中删除，此时副本B的底层磁盘文件中只保存有1条消息，即位移值为0的那条消息。</p><p>当执行完截断操作后，副本B开始从A拉取消息，执行正常的消息同步。如果就在这个节骨眼上，副本A所在的Broker宕机了，那么Kafka就别无选择，只能让副本B成为新的Leader，此时，当A回来后，需要执行相同的日志截断操作，即将高水位调整为与B相同的值，也就是1。这样操作之后，位移值为1的那条消息就从这两个副本中被永远地抹掉了。这就是这张图要展示的数据丢失场景。</p><p>严格来说，这个场景发生的前提是<strong>Broker端参数min.insync.replicas设置为1</strong>。此时一旦消息被写入到Leader副本的磁盘，就会被认为是“已提交状态”，但现有的时间错配问题导致Follower端的高水位更新是有滞后的。如果在这个短暂的滞后时间窗口内，接连发生Broker宕机，那么这类数据的丢失就是不可避免的。</p><p>现在，我们来看下如何利用Leader Epoch机制来规避这种数据丢失。我依然用图的方式来说明。</p><p><img src=\"https://static001.geekbang.org/resource/image/3a/8c/3a2e1131e8244233c076de906c174f8c.jpg?wh=2975*1992\" alt=\"\"></p><p>场景和之前大致是类似的，只不过引用Leader Epoch机制后，Follower副本B重启回来后，需要向A发送一个特殊的请求去获取Leader的LEO值。在这个例子中，该值为2。当获知到Leader LEO=2后，B发现该LEO值不比它自己的LEO值小，而且缓存中也没有保存任何起始位移值 &gt; 2的Epoch条目，因此B无需执行任何日志截断操作。这是对高水位机制的一个明显改进，即副本是否执行日志截断不再依赖于高水位进行判断。</p><p>现在，副本A宕机了，B成为Leader。同样地，当A重启回来后，执行与B相同的逻辑判断，发现也不用执行日志截断，至此位移值为1的那条消息在两个副本中均得到保留。后面当生产者程序向B写入新消息时，副本B所在的Broker缓存中，会生成新的Leader Epoch条目：[Epoch=1, Offset=2]。之后，副本B会使用这个条目帮助判断后续是否执行日志截断操作。这样，通过Leader Epoch机制，Kafka完美地规避了这种数据丢失场景。</p><h2>小结</h2><p>今天，我向你详细地介绍了Kafka的高水位机制以及Leader Epoch机制。高水位在界定Kafka消息对外可见性以及实现副本机制等方面起到了非常重要的作用，但其设计上的缺陷给Kafka留下了很多数据丢失或数据不一致的潜在风险。为此，社区引入了Leader Epoch机制，尝试规避掉这类风险。事实证明，它的效果不错，在0.11版本之后，关于副本数据不一致性方面的Bug的确减少了很多。如果你想深入学习Kafka的内部原理，今天的这些内容是非常值得你好好琢磨并熟练掌握的。</p><p><img src=\"https://static001.geekbang.org/resource/image/98/3f/989d13e4bc4f44618a10b5b7bd6f523f.jpg?wh=2069*2580\" alt=\"\"></p><h2>开放讨论</h2><p>在讲述高水位时，我是拿2个副本举的例子。不过，你应该很容易地扩展到多个副本。现在，请你尝试用3个副本来说明一下副本同步全流程，以及分区高水位被更新的过程。</p><p>欢迎写下你的思考和答案，我们一起讨论。如果你觉得有所收获，也欢迎把文章分享给你的朋友。</p>","comments":[{"had_liked":false,"id":122438,"user_name":"你好旅行者","can_delete":false,"product_type":"c1","uid":1154101,"ip_address":"","ucode":"5C72A428DC28F3","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg","comment_is_top":false,"comment_ctime":1565368113,"is_pvip":false,"discussion_count":10,"race_medal":0,"score":"237788569393","product_id":100029201,"comment_content":"老师列举了数据丢失的场景，我补充一个数据丢失的场景吧：<br><br>假设集群中有两台Broker，Leader为A，Follower为B。A中有两条消息m1和m2，他的HW为1，LEO为2；B中有一条消息m1，LEO和HW都为1.假设A和B同时挂掉，然后B先醒来，成为了Leader（假设此时的min.insync.replicas参数配置为1）。然后B中写入一条消息m3，并且将LEO和HW都更新为2.然后A醒过来了，向B发送FetchrRequest，B发现A的LEO和自己的一样，都是2，就让A也更新自己的HW为2。但是其实，虽然大家的消息都是2条，可是消息的内容是不一致的。一个是(m1,m2),一个是(m1,m3)。<br><br>这个问题也是通过引入leader epoch机制来解决的。<br><br>现在是引入了leader epoch之后的情况：B恢复过来，成为了Leader，之后B中写入消息m3，并且将自己的LEO和HW更新为2，注意这个时候LeaderEpoch已经从0增加到1了。<br>紧接着A也恢复过来成为Follower并向B发送一个OffsetForLeaderEpochRequest请求，这个时候A的LeaderEpoch为0。B根据0这个LeaderEpoch查询到对应的offset为1并返回给A，那么A就要对日志进行截断，删除m2这条消息。然后用FetchRequest从B中同步m3这条消息。这样就解决了数据不一致的问题。<br>","like_count":55,"discussions":[{"author":{"id":1564936,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e1/08/c6629b72.jpg","nickname":"WW","note":"","ucode":"04659AB248AB9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":221137,"discussion_content":"虽然数据是一致了，但是按照这种场景的话m2还是会丢了吧","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1585980179,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104958,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg","nickname":"小崔","note":"","ucode":"4E537416787752","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":231220,"discussion_content":"感觉不太对，应该是现存LeaderEpoch是<0, 0>和<1, 2>，A恢复过来以后取比自己原有大1的epoch的start offset，发现是2，所以把[2, …)位移的数据全删除了，重新拉取。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1586789310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380144,"discussion_content":"结合楼主的例子+文章图+自己的理解，感觉老师在kafka运用leader epoch这个过程上没有说的太清楚，过程我认为应该是这样：\n\n引入leader epoch场景\n（1）B重启，先往A发送epoch=0，A查询返回offset=0，B回退到offset=0（最后一张图，副本B的第一步到第二步offset=1的蓝色变成红色），再向A拉取，拉取offset=1消息（等效为文中所讲的“...因此 B 无需执行任何日志截断操作...”）。\n（2）接着，A宕机，B为leader，B记录新纪元epoch=1和此时offset=2。A恢复后，它只记得自己上次epoch=0，然后发给B，B查询epoch=0是上个纪元的东西，返回offset=0，让A回退到0，然后A再从B拉取offset=1（等效为文中所讲的“...当 A 重启回来后，执行与 B 相同的逻辑判断，发现也不用执行日志截断...”），也就是offset=1这条消息确实没有丢。\n\n（顺带吐槽一下，那几个高水位箭头是在是太干扰理解了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624355897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2642315,"avatar":"","nickname":"Geek_c695c1","note":"","ucode":"FC2AD53F54582D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390907,"discussion_content":"那几个图给我看蒙了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630134169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":380144,"ip_address":""},"score":390907,"extra":""},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531757,"discussion_content":"按照你的步骤1，如果epoch 0有很多数据，岂不是要全部丢弃然后重新拉取？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637408639,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":380144,"ip_address":""},"score":531757,"extra":"{\"user_type\":1}"}]},{"author":{"id":1744338,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/2nvw0GuJKcxfAsMrevuetJ1h2BXVI6K0UnXvSF0svqibGvzN9gqumNLrJ5GKn8GhbZP5AJYswK07xJvrAQiaJnRw/132","nickname":"Geek_c9a4e1","note":"","ucode":"2E3AB34A7B6815","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363024,"discussion_content":"这种说法，当A醒来的时候不是应该先比较LEO和HW吗？LEO=2，HW=1，直接会触发A的日志截断机制，也就是说这种情况，A中的m2就被删除了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617099406,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":578672,"discussion_content":"其实真实运行时，leader节点会保存Map&lt;leader epoch, startOffset&gt;到check point文件 同时也会在内存缓存起来，变量为epochs。所以老师的例子是这样的：如果请求的leader epoch在epochs里存在，就返回当前的LEO，反之取出比请求 epoch大的最小start offset，作为offset。\n也就是强迫follower 此时从最小有效start  offset开始截断 并重新开始同步日志\n\n也就是说如果follower宕机不太久 那么start offset其实没什么意义。相反 我们大多数时候用的就是LEO\n\n代码：LeaderEpochFileCache.endOffsetFor()","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656935782,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1109940,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ef/b4/61fb4dba.jpg","nickname":"胡家鹏","note":"","ucode":"1636F84062948B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41678,"discussion_content":"您好，这样m2会丢失吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572486318,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1621119,"avatar":"https://static001.geekbang.org/account/avatar/00/18/bc/7f/3b75677e.jpg","nickname":"洪东楗","note":"","ucode":"D161432152E967","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1109940,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ef/b4/61fb4dba.jpg","nickname":"胡家鹏","note":"","ucode":"1636F84062948B","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":170089,"discussion_content":"m2的丢失就是老师举的例子了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581668866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":41678,"ip_address":""},"score":170089,"extra":""},{"author":{"id":1081233,"avatar":"https://static001.geekbang.org/account/avatar/00/10/7f/91/962eba1a.jpg","nickname":"唐朝首都","note":"","ucode":"F72655AE0AE4CA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1109940,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ef/b4/61fb4dba.jpg","nickname":"胡家鹏","note":"","ucode":"1636F84062948B","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":547202,"discussion_content":"这样不算丢失，因为B从来没有接收到m2，老师举的例子A、B都收到了消息，但是丢失了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642579098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":41678,"ip_address":""},"score":547202,"extra":""}]}]},{"had_liked":false,"id":120250,"user_name":"QQ怪","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1564815436,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"139003768908","product_id":100029201,"comment_content":"这篇文章有点深度了，看了几遍才看懂","like_count":32,"discussions":[{"author":{"id":1258380,"avatar":"https://static001.geekbang.org/account/avatar/00/13/33/8c/23eef8d7.jpg","nickname":"feifei","note":"","ucode":"BFA3BE8D8773A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332472,"discussion_content":"你看懂了，那你能跟我说下老师说的，b回来时发现的不用截断日志，那它为什么不用截断日志，截断日志的标准是什么","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1607231918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1296063,"avatar":"https://static001.geekbang.org/account/avatar/00/13/c6/bf/52b3f71d.jpg","nickname":"dawn","note":"","ucode":"1757B28F1EF5C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584434,"discussion_content":"leo是log end offset的意思，另外延迟时间也没有描述清楚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660813854,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"新加坡"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1296063,"avatar":"https://static001.geekbang.org/account/avatar/00/13/c6/bf/52b3f71d.jpg","nickname":"dawn","note":"","ucode":"1757B28F1EF5C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584426,"discussion_content":"一共就两参数，他也没能写明白","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660812850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2066119,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/hlgyFUQVCrhaO46VJkrR3fE9hvOWnnwKsAj9gzK4Yp70BmU1a06YkwS1vNexMqkttorodO2ZMtiajBMXo7seD8g/132","nickname":"Geek_Daniel","note":"","ucode":"9AC8E4D12FBC72","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":321329,"discussion_content":"我没看懂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604564933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289210,"discussion_content":"我看了2遍还是晕","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594026808,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2649276,"avatar":"https://static001.geekbang.org/account/avatar/00/28/6c/bc/f751786b.jpg","nickname":"Leo","note":"","ucode":"CEBAD9CDCFC2A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405248,"discussion_content":"因为这文章写的不好","likes_number":15,"is_delete":false,"is_hidden":false,"ctime":1634540553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":289210,"ip_address":""},"score":405248,"extra":""},{"author":{"id":1924882,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/aXnFBB3XD3lwB3jf1A0PQqT66aJy4yycbRupJI3ia2CUFMuLsvYthM41TDopIIjL8kz7k2xE5vrAtQggQ6Jt8Zw/132","nickname":"付磊","note":"","ucode":"719BD0B72FF2AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2649276,"avatar":"https://static001.geekbang.org/account/avatar/00/28/6c/bc/f751786b.jpg","nickname":"Leo","note":"","ucode":"CEBAD9CDCFC2A3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580930,"discussion_content":"我也觉得","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658405344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":405248,"ip_address":""},"score":580930,"extra":""}]}]},{"had_liked":false,"id":125226,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1566123197,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"117530240189","product_id":100029201,"comment_content":"今天的课程很棒，知识密度比较大，小结一下<br>1：啥是高水位？<br>水位，我的理解就是水平面当前的位置，可以表示水的深度。在kafka中水位用于表示消息在分区中的位移或位置，高水位用于表示已提交的消息的分界线的位置，在高水位这个位置之前的消息都是已提交的，在高水位这个位置之后的消息都是未提交的。所以，高水位可以看作是已提交消息和未提交消息之间的分割线，如果把分区比喻为一个竖起来的水容器的话，这个表示就更明显了，在高水位之下的消息都是已提交的，在高水位之上的消息都是未提交的。<br>高水位的英文是High Watermark ，所以其英文缩写为HW。<br>值得注意的是，Kafka 中也有低水位（Low Watermark，英文缩写为LW），它是与 Kafka 删除消息相关联的概念。<br>再加一个概念，LEO——Log End Offset 的缩写——意思是日志末端位移，它表示副本写入下一条消息的位移值——既分区中待写入消息的位置。这个位置和高水位之间的位置包括高水位的那个位置，就是所有未提交消息的全部位置所在啦——未提交的消息是不能被消费者消费的。所以，同一个副本对象，其高水位值不会大于 LEO 值。<br>高水位和 LEO 是副本对象的两个重要属性。Kafka 所有副本都有对应的高水位和 LEO 值，而不仅仅是 Leader 副本。只不过 Leader 副本比较特殊，Kafka 使用 Leader 副本的高水位来定义所在分区的高水位。换句话说，分区的高水位就是其 Leader 副本的高水位。<br><br>2：高水位有啥用？<br>2-1：定义消息可见性，即用来标识分区下的哪些消息是可以被消费者消费的——已提交的消息是可以被消费者消费的。<br>2-2：帮助 Kafka 完成副本同步——明确那些消息已提交那些未提交，才好进行消息的同步。<br><br>3：高水位怎么管理？<br>这个不好简单的描述，牢记高水位的含义，有助于理解更新高水的时机以及具体步骤。<br>高水位——用于界定分区中已提交和未提交的消息。<br><br>4：高水有舍缺陷？<br>Leader 副本高水位更新和 Follower 副本高水位更新在时间上是存在错配的。这种错配是很多“数据丢失”或“数据不一致”问题的根源。<br><br>5：啥是 leader epoch？<br>可以大致认为就是leader的版本。<br>它由两部分数据组成。<br>5-1：Epoch。一个单调增加的版本号。每当副本领导权发生变更时，都会增加该版本号。小版本号的 Leader 被认为是过期 Leader，不能再行使 Leader 权力。<br>5-2：起始位移（Start Offset）。Leader 副本在该 Epoch 值上写入的首条消息的位移。<br><br>6：leader epoch 有啥用？<br>通过 Leader Epoch 机制，Kafka 规避了因为Leader 副本高水位更新和 Follower 副本高水位更新在时间上是存在错配，而引起的很多“数据丢失”或“数据不一致”的问题。<br><br>7：leader epoch 怎么管理？<br>需要再看看，还不能简单描述出来。<br><br>","like_count":27},{"had_liked":false,"id":146901,"user_name":"朱东旭","can_delete":false,"product_type":"c1","uid":1242338,"ip_address":"","ucode":"C48DD620A63868","user_header":"https://static001.geekbang.org/account/avatar/00/12/f4/e2/dbc4a5f2.jpg","comment_is_top":false,"comment_ctime":1572694465,"is_pvip":false,"replies":[{"id":"56779","content":"epoch还有其他的作用，比如执行基本的fencing逻辑等","user_name":"作者回复","comment_id":146901,"uid":"1288090","ip_address":"","utype":1,"ctime":1572769250,"user_name_real":"huxi_2b"}],"discussion_count":3,"race_medal":0,"score":"57407269313","product_id":100029201,"comment_content":"胡老师您好，在您讲的leader epoch机制案例中，在我看来最关键的操作是broker重启后先向leader确认leo,而不是直接基于自己的高水位截断数据，来防止数据不一致。。可是有无leader epoch都可以做这个操作呀，我看不出leader epoch必要性在哪。。<br>","like_count":14,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473050,"discussion_content":"epoch还有其他的作用，比如执行基本的fencing逻辑等","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572769250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327954,"discussion_content":"我感觉关键点也是在重启后要向leader确认LEO","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606025878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1531763,"avatar":"https://static001.geekbang.org/account/avatar/00/17/5f/73/a9346146.jpg","nickname":"陈","note":"","ucode":"8AEF8530530311","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572848,"discussion_content":"感觉epoch是用来当fllower醒来后要判断一下，在他睡眠期间集群有没有发生过leader切换，如果没有，则自己的leo不需要回退，如果有，需要判断下一个版本的leader有没有覆盖掉fllower的高水位到leo的条目","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653010297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121749,"user_name":"常超","can_delete":false,"product_type":"c1","uid":1138665,"ip_address":"","ucode":"4AE7743B4ADF20","user_header":"https://static001.geekbang.org/account/avatar/00/11/5f/e9/95ef44f3.jpg","comment_is_top":false,"comment_ctime":1565218157,"is_pvip":false,"discussion_count":8,"race_medal":0,"score":"48809858413","product_id":100029201,"comment_content":"前面有几个同学提过了，请老师再看一下。<br><br>&gt;与 Leader 副本保持同步的两个判断条件。<br>&gt;1. 该远程 Follower 副本在 ISR 中。<br>&gt;2. ...<br><br>&gt;如果 Kafka 只判断第 1 个条件的话，就可能出现某些副本具备了“进入 ISR”的资格，但却尚未进入到 ISR 中的情况。此时，分区高水位值就可能超过 ISR 中副本 LEO，而高水位 &gt; LEO 的情形是不被允许的。<br><br>应该改成“如果 Kafka 只判断第 2 个条件的话，...” 吧？<br>按照现在的说法，上面那句话可以扩展成，如果只判断远程Follower副本是否在ISR中的话，就可能出现某些副本具备了“进入 ISR”的资格，但却尚未进入到 ISR 中的情况。此时，分区高水位值就可能超过 ISR 中副本 LEO，而高水位 &gt; LEO 的情形是不被允许的。<br>这样是说不通的吧。<br>换个问法，比如，条件1有副本a,b, 条件2有副本b,c（其中c满足进入1的条件，但还没进入1）,老师是想说，“只判断1，a会被误判为同步状态”，还是“只判断2，c会被误判为同步状态”呢？<br>","like_count":11,"discussions":[{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350246,"discussion_content":"看来我不是一个人，读了几遍，确实不知道是什么意思？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1613784762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1817539,"avatar":"","nickname":"乐观的摸摸头","note":"","ucode":"0535CDC1D19CAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":249687,"discussion_content":"同样迷茫","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587952799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1141547,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqxnw92EOgZbyHDGMZ1d1OFDjjJKnBdmpiac8J7kBEN5h3AvvzU85mo5Chj8pkIHQc390dL1mu0neQ/132","nickname":"真锅","note":"","ucode":"D36634359B0BD6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1817539,"avatar":"","nickname":"乐观的摸摸头","note":"","ucode":"0535CDC1D19CAB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":249889,"discussion_content":"我觉得想表达的可能是，如果只判断条件1，c暂时未加入ISR被漏判，根据a和b更新HW，等c加入到ISR之后，出现分区HW的值大于c的LEO，这种情况是不允许的。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1587971767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":249687,"ip_address":""},"score":249889,"extra":""},{"author":{"id":1246200,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/f8/55554b12.jpg","nickname":"kai","note":"","ucode":"CFDC240DA364FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1141547,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqxnw92EOgZbyHDGMZ1d1OFDjjJKnBdmpiac8J7kBEN5h3AvvzU85mo5Chj8pkIHQc390dL1mu0neQ/132","nickname":"真锅","note":"","ucode":"D36634359B0BD6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316158,"discussion_content":"我觉得你说的比较解释的通","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603367981,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":249889,"ip_address":""},"score":316158,"extra":""},{"author":{"id":1246200,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/f8/55554b12.jpg","nickname":"kai","note":"","ucode":"CFDC240DA364FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1141547,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqxnw92EOgZbyHDGMZ1d1OFDjjJKnBdmpiac8J7kBEN5h3AvvzU85mo5Chj8pkIHQc390dL1mu0neQ/132","nickname":"真锅","note":"","ucode":"D36634359B0BD6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316528,"discussion_content":"后来又想了一下，应该不会是这样，因为c想要加入isr的条件就是它自己的leo要大于分区高水位，否则它是加入不进去的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603421274,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":249889,"ip_address":""},"score":316528,"extra":""}]},{"author":{"id":1439569,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f7/51/1bacf04f.jpg","nickname":"Tc","note":"","ucode":"1AB8E0E28E732D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":191603,"discussion_content":"我觉得这段描述怎么解释都解释不通","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583019400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1443078,"avatar":"https://static001.geekbang.org/account/avatar/00/16/05/06/f5979d65.jpg","nickname":"亚洲舞王.尼古拉斯赵四","note":"","ucode":"7159F5D7232696","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":45185,"discussion_content":"这块我也觉得看的很迷茫，觉得想不通，书里面也是这么写的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573010527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206273,"user_name":"李先生","can_delete":false,"product_type":"c1","uid":1237614,"ip_address":"","ucode":"D9039715F7D290","user_header":"https://static001.geekbang.org/account/avatar/00/12/e2/6e/0a300829.jpg","comment_is_top":false,"comment_ctime":1586832037,"is_pvip":false,"replies":[{"id":"77346","content":"1. broker崩溃前可能写入了部分不完整的消息。这部分数据显然不能算做成功提交，因此在重启回来后要执行截断操作，将底层日志调整回到合法的状态上。<br>2. 你可以认为都是pagecache。pagecache落盘完全由OS来完成，不由Kafka控制。","user_name":"作者回复","comment_id":206273,"uid":"1288090","ip_address":"","utype":1,"ctime":1587005058,"user_name_real":"胡夕"}],"discussion_count":2,"race_medal":0,"score":"40241537701","product_id":100029201,"comment_content":"胡哥，有两个问题：<br>1:为什么broker重启要进行日志截断，触发日志截断的前提是什么？目的是什么？<br>2:acks=all,是代表同步到所有isr中broker的pagecache中还是磁盘？min.insync.replicas是配合acks=all来使用的，是一个保证消息可靠性的配置，比如设置为2，是代表在isr中至少两个broker上写入消息，这个写入是写入pagecache中还是磁盘中？如果都是写入pagecache中，kafka是有异步线程来定时从pagecache中拉消息写入磁盘吗？","like_count":9,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491735,"discussion_content":"1. broker崩溃前可能写入了部分不完整的消息。这部分数据显然不能算做成功提交，因此在重启回来后要执行截断操作，将底层日志调整回到合法的状态上。\n2. 你可以认为都是pagecache。pagecache落盘完全由OS来完成，不由Kafka控制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587005058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1944524,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLoJTSB95niaehsYoPzBvoNakgNpr8GCQYuqnaDexIicGa9IjK5hxhE17r94jiaoQxdwJia0WznsBtibTw/132","nickname":"于彪","note":"","ucode":"8C71285866A7FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373448,"discussion_content":"老师你好，这里的broker崩溃前可能写入了部分不完整的消息，和 hw 有关吗？\n感觉最多只有 LEO-1 这一条记录 会有 写入不完整吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620731652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127899,"user_name":"知易","can_delete":false,"product_type":"c1","uid":1246882,"ip_address":"","ucode":"BD3E3F0F0A40EF","user_header":"https://static001.geekbang.org/account/avatar/00/13/06/a2/350c4af0.jpg","comment_is_top":false,"comment_ctime":1566806814,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"40221512478","product_id":100029201,"comment_content":"文中老师举例说明数据丢失场景，其中有一处疑惑。<br>原文。。“当执行完截断操作后，副本 B 开始从 A 拉取消息，执行正常的消息同步。如果就在这个节骨眼上，副本 A 所在的 Broker 宕机了，那么 Kafka 就别无选择，只能让副本 B 成为新的 Leader，此时，当 A 回来后，需要执行相同的日志截断操作，即将高水位调整为与 B 相同的值，也就是 1。这样操作之后，位移值为 1 的那条消息就从这两个副本中被永远地抹掉了。这就是这张图要展示的数据丢失场景。”<br>      其中，A宕机前其高水位为2，此时回来进行日志截断不应该还是2么，为啥要调整为与leaderB一样的水位值？前面B宕机回来的时候，进行日志截断也还是保持其宕机前的值1，并没有调整为与leaderA一样的水位值呢？<br>这里不是没有理解到，请老师解惑。感谢。","like_count":9,"discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390702,"discussion_content":"你不会觉得kafka允许follower副本数据多过leader副本吧？回去好好想想吧，菜鸟","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629979894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2327226,"avatar":"https://static001.geekbang.org/account/avatar/00/23/82/ba/74064f01.jpg","nickname":"5AM","note":"","ucode":"1E0248C1D0FDE8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391564,"discussion_content":"友善的评论是交流的起点","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1630513080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":390702,"ip_address":""},"score":391564,"extra":""}]}]},{"had_liked":false,"id":173087,"user_name":"td901105","can_delete":false,"product_type":"c1","uid":1348830,"ip_address":"","ucode":"32D42A4F36FA02","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/SM4fwn9uFicXU8cQ1rNF2LQdKNbZI1FX1jmdwaE2MTrBawbugj4TQKjMKWG0sGbmqQickyARXZFS8NZtobvoWTHA/132","comment_is_top":false,"comment_ctime":1579422411,"is_pvip":false,"replies":[{"id":"67160","content":"日志截断主要是因为follower必须要与leader保持一致，而一旦某个“落后”的副本成为leader，其他“领先”的follower必须与其保持一致，必须truncate掉自己多余的消息。至于如何在这个过程中保持副本间的一致，社区之前使用高水位机制，但发现有一些固有的缺陷，进而开发了leader epoch。如果你能提出更简单的算法，欢迎写下来：）","user_name":"作者回复","comment_id":173087,"uid":"1288090","ip_address":"","utype":1,"ctime":1579482601,"user_name_real":"huxi_2b"}],"discussion_count":6,"race_medal":0,"score":"35939160779","product_id":100029201,"comment_content":"老师您好,我怎么感觉只需要在副本拉取Leader的LOG就不会产生日志截断的问题了,感觉不需要Leader Epoch?","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481954,"discussion_content":"日志截断主要是因为follower必须要与leader保持一致，而一旦某个“落后”的副本成为leader，其他“领先”的follower必须与其保持一致，必须truncate掉自己多余的消息。至于如何在这个过程中保持副本间的一致，社区之前使用高水位机制，但发现有一些固有的缺陷，进而开发了leader epoch。如果你能提出更简单的算法，欢迎写下来：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579482601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1258380,"avatar":"https://static001.geekbang.org/account/avatar/00/13/33/8c/23eef8d7.jpg","nickname":"feifei","note":"","ucode":"BFA3BE8D8773A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331617,"discussion_content":"老师好像没有正面回答epoch 到底在这个丢失数据的场景中，起了什么作用","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1606915659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1258380,"avatar":"https://static001.geekbang.org/account/avatar/00/13/33/8c/23eef8d7.jpg","nickname":"feifei","note":"","ucode":"BFA3BE8D8773A7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390703,"discussion_content":"根本就没说到，这老师很菜的","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1629980107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":331617,"ip_address":""},"score":390703,"extra":""}]},{"author":{"id":1109389,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ed/8d/377c106a.jpg","nickname":"KW💤","note":"","ucode":"290DD7016F4EE0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":412303,"discussion_content":"选leader不是选日志最多的副本吗？那怎么会不一致？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636123809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1100387,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ca/63/9be9ac89.jpg","nickname":"Allen","note":"","ucode":"5B168A03809557","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389270,"discussion_content":"因为虽然offset一样，但是follower并不知道相同offset那条是不是跟leader上的一样。所以需要truncate掉，然后重新从leader同步；有了epoch之后，根据epoch值follower就知道是同一条了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629198284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1348830,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/SM4fwn9uFicXU8cQ1rNF2LQdKNbZI1FX1jmdwaE2MTrBawbugj4TQKjMKWG0sGbmqQickyARXZFS8NZtobvoWTHA/132","nickname":"td901105","note":"","ucode":"32D42A4F36FA02","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":141544,"discussion_content":"打错了，应该是LEO","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579430104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215730,"user_name":"faunjoe","can_delete":false,"product_type":"c1","uid":1109373,"ip_address":"","ucode":"161EBB18B7F076","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/7d/112bc7e1.jpg","comment_is_top":false,"comment_ctime":1589088573,"is_pvip":false,"replies":[{"id":"80067","content":"Kafka缓存了LeaderEpochCache来保证","user_name":"作者回复","comment_id":215730,"uid":"1288090","ip_address":"","utype":1,"ctime":1589249410,"user_name_real":"胡夕"}],"discussion_count":1,"race_medal":0,"score":"31653859645","product_id":100029201,"comment_content":"多个broker 中的leader epoch 他们是版本号是怎么保持累加的","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494536,"discussion_content":"Kafka缓存了LeaderEpochCache来保证","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589249410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210961,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1587870478,"is_pvip":true,"replies":[{"id":"78508","content":"必须要调整到水位值，因为即使消息被写入到磁盘上了，不代表这条消息就提交成功了。未成功提交的消息即使写入了磁盘也要做截断","user_name":"作者回复","comment_id":210961,"uid":"1288090","ip_address":"","utype":1,"ctime":1587896708,"user_name_real":"胡夕"}],"discussion_count":2,"race_medal":0,"score":"27357674254","product_id":100029201,"comment_content":"倘若此时副本 B 所在的 Broker 宕机，当它重启回来后，副本 B 会执行日志截断操作，将 LEO 值调整为之前的高水位值，也就是 1。<br>-------------------------------------------------------------&gt;<br>老师，请问为什么要将LE0的值设置为HW的值。LEO的值是消息写入磁盘后才被更新的，也就是数据已经落地。重启后继续用LEO的值会有什么问题吗","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493158,"discussion_content":"必须要调整到水位值，因为即使消息被写入到磁盘上了，不代表这条消息就提交成功了。未成功提交的消息即使写入了磁盘也要做截断","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587896708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390704,"discussion_content":"不用纠结了，生产者服务设置acks=all的时候，HW=LEO，散会吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1629980334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205750,"user_name":"Johnson","can_delete":false,"product_type":"c1","uid":1218343,"ip_address":"","ucode":"E05B656B238C33","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/27/385b3e33.jpg","comment_is_top":false,"comment_ctime":1586734875,"is_pvip":false,"replies":[{"id":"76935","content":"leader epoch做不到这点。leader epoch只是保证在执行日志截断时不会出现因leader&#47;follower副本接连宕机导致的不一致性。除此之外的功能依然由HW提供","user_name":"作者回复","comment_id":205750,"uid":"1288090","ip_address":"","utype":1,"ctime":1586764037,"user_name_real":"胡夕"}],"discussion_count":2,"race_medal":0,"score":"27356538651","product_id":100029201,"comment_content":"老师您好，有个疑问，leader epoch怎么做到像hw里的数据可见性的，比如hw可以保证消费端只能消费hw之前提交的消息，leader epoch如何保证这点，谢谢！","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491576,"discussion_content":"leader epoch做不到这点。leader epoch只是保证在执行日志截断时不会出现因leader/follower副本接连宕机导致的不一致性。除此之外的功能依然由HW提供","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586764037,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218343,"avatar":"https://static001.geekbang.org/account/avatar/00/12/97/27/385b3e33.jpg","nickname":"Johnson","note":"","ucode":"E05B656B238C33","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":230752,"discussion_content":"两者一起配合使用，不是取代关系是吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586768893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143580,"user_name":"😈😈😈😈😈","can_delete":false,"product_type":"c1","uid":1197447,"ip_address":"","ucode":"A563EC007FEB7D","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","comment_is_top":false,"comment_ctime":1571736655,"is_pvip":false,"replies":[{"id":"55479","content":"挺好的，没有什么意见：）","user_name":"作者回复","comment_id":143580,"uid":"1288090","ip_address":"","utype":1,"ctime":1571791830,"user_name_real":"huxi_2b"}],"discussion_count":2,"race_medal":0,"score":"27341540431","product_id":100029201,"comment_content":"这个是我理解的HW和LEO更新的机制步骤，有错误的话请大神指明下，非常感谢<br>更新对象 更新时机<br>Broker1上Follower副本 Follwer会从Leader副本不停的拉取数据，但是Leader副本现在的没有数据。所以Leader副本和Follower副本的高水位值和LEO值都是0<br>Broker0上的Leader副本 生产者向Leader副本中写入一条数据，此时LEO值是1,HW值是0。也就是说位移为0的位置上已经有数据了<br>Broker1上Follower副本 由于Leader副本有了数据，所以Follower可以获取到数据写入到自己的日志中，且标记LEO值为1，此时在Followe位移值为0的位置上也有了数据，所以此时Follower的HW=0，LEO=1<br>Broker1上Follower副本 获取到数据之后，再次向Leader副本拉数据，这次请求拉取的数据是位移值1上的数据<br>Broker0上的远程副本 Leader收到Follower的拉取请求后，发现Follower要拉取的数据是在位移值为1的位置上的数据，此时会更新远程副本的LEO值为1。所以所有的远程副本的LEO等于各自对应的Follower副本的LEO值<br>Brober0上的Leader副本 Broker0上的远程副本的LEO已经更新为1了。所以开始更新Leader副本的HW值。HW=max{HW,min(LEO1,LEO2,LEO3......LEON)},更新HW值为1，之后会发送Follower副本请求的数据（如果有数据的话，没有数据的话只发送HW值）并一起发送HW值<br>Broker1上Follower副本 Follwer副本收到Leader返回的数据和HW值（如果Leader返回了数据那么LEO就是2，没有数据的话LEO还是1），用HW值和自己的LEO值比较选择较小作为自己的HW值并更新HW值为1（如果俩个值相等的话HW=LEO）<br>一次副本间的同步过程完成 ","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471603,"discussion_content":"挺好的，没有什么意见：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571791830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1325678,"avatar":"https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg","nickname":"大坏狐狸","note":"","ucode":"5044F89A505C5B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":208821,"discussion_content":"这里 Broker0上Leader 副本高水位更新时机，第一个是Leader副本更新其LEO之后。那既然已经更新了LEO 是不是HW 就是1 而不是0了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584582379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173468,"user_name":"Geek_0819","can_delete":false,"product_type":"c1","uid":1795605,"ip_address":"","ucode":"39324C56899177","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELbKf55SEo9bZ30GAIA09AaaoGvAIibEjNC0rsxpP7r1z4jUUBFz3xepso6CK8bYia6n5wcAyOQUfibA/132","comment_is_top":false,"comment_ctime":1579569542,"is_pvip":false,"replies":[{"id":"67909","content":"配置acks=-1的生产者会等待ISR中所有副本都同步了该消息才会认为消息成功提交。确实，有些情况下生产者会等待一段时间，这通常是线上环境中producer延迟的主要诱因。至于多久则因具体场景而定了~","user_name":"作者回复","comment_id":173468,"uid":"1288090","ip_address":"","utype":1,"ctime":1580368564,"user_name_real":"huxi_2b"}],"discussion_count":3,"race_medal":0,"score":"23054406022","product_id":100029201,"comment_content":"胡老师有个疑问：生产者同步发送消息时指定同步到所有副本，生产者是等待所有副本的LEO都写入成功才返回吗？如果是这样Follower副本从Leader上拉取LEO是有时间间隔的，这样生产者都在这里等待很久吗？还是其他方式的交互？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482078,"discussion_content":"配置acks=-1的生产者会等待ISR中所有副本都同步了该消息才会认为消息成功提交。确实，有些情况下生产者会等待一段时间，这通常是线上环境中producer延迟的主要诱因。至于多久则因具体场景而定了~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580368564,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1284450,"avatar":"https://static001.geekbang.org/account/avatar/00/13/99/62/7e550aa4.jpg","nickname":"EGG","note":"","ucode":"2FF5A9EDA6A310","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335148,"discussion_content":"是会影响吞吐量的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608106268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1284450,"avatar":"https://static001.geekbang.org/account/avatar/00/13/99/62/7e550aa4.jpg","nickname":"EGG","note":"","ucode":"2FF5A9EDA6A310","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390705,"discussion_content":"你觉得呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629980742,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":335148,"ip_address":""},"score":390705,"extra":""}]}]},{"had_liked":false,"id":121385,"user_name":"常超","can_delete":false,"product_type":"c1","uid":1138665,"ip_address":"","ucode":"4AE7743B4ADF20","user_header":"https://static001.geekbang.org/account/avatar/00/11/5f/e9/95ef44f3.jpg","comment_is_top":false,"comment_ctime":1565131247,"is_pvip":false,"replies":[{"id":"44615","content":"AND","user_name":"作者回复","comment_id":121385,"uid":"1288090","ip_address":"","utype":1,"ctime":1565138473,"user_name_real":"huxi_2b"}],"discussion_count":3,"race_medal":0,"score":"23039967727","product_id":100029201,"comment_content":"请问老师，与 Leader 副本保持同步的两个判断条件，是OR还是AND的关系？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461771,"discussion_content":"AND","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565138473,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1230456,"avatar":"https://static001.geekbang.org/account/avatar/00/12/c6/78/3cda8496.jpg","nickname":"我","note":"","ucode":"4FE62C4D622AA4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288738,"discussion_content":"如果是 AND ，对于文中所述情况，对这个未及时 “进入ISR”应该还是判断为与 leader 不同步 ？？？ \n“”如果 Kafka 只判断第 1 个条件的话，就可能出现某些副本具备了“进入 ISR”的资格，但却尚未进入到 ISR 中的情况。此时，分区高水位值就可能超过 ISR 中副本 LEO，而高水位 > LEO 的情形是不被允许的。“”","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1593855615,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1246200,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/f8/55554b12.jpg","nickname":"kai","note":"","ucode":"CFDC240DA364FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1230456,"avatar":"https://static001.geekbang.org/account/avatar/00/12/c6/78/3cda8496.jpg","nickname":"我","note":"","ucode":"4FE62C4D622AA4","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":316532,"discussion_content":"是啊，这里太迷了，两个都判断它还是不满足条件1啊","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603421394,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":288738,"ip_address":""},"score":316532,"extra":""}]}]},{"had_liked":false,"id":233360,"user_name":"店小二#2","can_delete":false,"product_type":"c1","uid":1130925,"ip_address":"","ucode":"6103E9AE52F8E7","user_header":"https://static001.geekbang.org/account/avatar/00/11/41/ad/4ccf4238.jpg","comment_is_top":false,"comment_ctime":1594297113,"is_pvip":false,"replies":[{"id":"86296","content":"你说的是有一定道理的。我只能给出这样的答案：分布式中的交互很多东西其实是不确定的，我们很难穷尽所有的可能性。因此我觉得这里的写法有防御性编程的味道。你可以试着删掉然后改用你的写法跑一遍测试用例看看。也许是一个不错的优化点。","user_name":"作者回复","comment_id":233360,"uid":"1288090","ip_address":"","utype":1,"ctime":1594448683,"user_name_real":"胡夕"}],"discussion_count":1,"race_medal":0,"score":"14479199001","product_id":100029201,"comment_content":"引用一下@thomas与老师交流。<br><br>thomas<br>iii. 更新 currentHW = max{currentHW, min（LEO-1, LEO-2, ……，LEO-n）}<br>-------------------------------------------------------------------------------&lt;<br>老师， LEO-1,LEO-2...LEO-n 都是在ISR集合中的，我认为 currentHW= min（LEO-1, LEO-2, ……，LEO-n就可以，请问在什么场景下currentHW 会大于 min(LEO-1, LEO-2, ……，LEO-n）<br>作者回复: 有些落后很多的follower可能出现这种情况<br><br>====================================================<br>老师的解答的场景我理解了。但是不明白的是，该场景下，恢复过来的follower副本replica.lag.time.max.ms &lt; 10s，且还未到ISR中时，此时的分区高水位不是也大于LEO了么？<br>","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500994,"discussion_content":"你说的是有一定道理的。我只能给出这样的答案：分布式中的交互很多东西其实是不确定的，我们很难穷尽所有的可能性。因此我觉得这里的写法有防御性编程的味道。你可以试着删掉然后改用你的写法跑一遍测试用例看看。也许是一个不错的优化点。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594448683,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":148449,"user_name":"亚洲舞王.尼古拉斯赵四","can_delete":false,"product_type":"c1","uid":1443078,"ip_address":"","ucode":"7159F5D7232696","user_header":"https://static001.geekbang.org/account/avatar/00/16/05/06/f5979d65.jpg","comment_is_top":false,"comment_ctime":1573008700,"is_pvip":false,"replies":[{"id":"57182","content":"在所有需要回复的人当中，你的名字是我最喜欢的，没有之一：）","user_name":"作者回复","comment_id":148449,"uid":"1288090","ip_address":"","utype":1,"ctime":1573028958,"user_name_real":"huxi_2b"}],"discussion_count":3,"race_medal":0,"score":"14457910588","product_id":100029201,"comment_content":"我还奇怪为什么老师讲的和Apache kafka实战这部分内容差不多，还以为是抄袭，后来一看，原来老师就是我看的这本书的作者，😂","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473496,"discussion_content":"在所有需要回复的人当中，你的名字是我最喜欢的，没有之一：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573028958,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1854657,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVIjh4T1akib5iav5IIGjXB9x98p9Y80STRcwpMDqxfGLrMvHamxlxEqLMTpiayWFWSNpBcbGwkRjRw/132","nickname":"马吉辉","note":"","ucode":"4265EFBD2BB7BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":253387,"discussion_content":"人才","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588231246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1503506,"avatar":"https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg","nickname":"你为啥那么牛","note":"","ucode":"1ABC604A54A8F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346367,"discussion_content":"多点发展，果然能收获不少读者，我花钱敬上","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611925907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120384,"user_name":"信信","can_delete":false,"product_type":"c1","uid":1303865,"ip_address":"","ucode":"8DF0EC045579FD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg","comment_is_top":false,"comment_ctime":1564853512,"is_pvip":false,"replies":[{"id":"44244","content":"replica.lag.max.messages已经被移除了，不要看这篇了。你可以看看我之前写的这篇：Kafka副本管理—— 为何去掉replica.lag.max.messages参数（https:&#47;&#47;www.cnblogs.com&#47;huxi2b&#47;p&#47;5903354.html）","user_name":"作者回复","comment_id":120384,"uid":"1288090","ip_address":"","utype":1,"ctime":1564965768,"user_name_real":"huxi_2b"}],"discussion_count":2,"race_medal":0,"score":"14449755400","product_id":100029201,"comment_content":"原文中“如果 Kafka 只判断第 1 个条件的话”--这里应该是：第2个条件？评论区其他人也有提到<br>对这块的个人理解：<br>两个条件之间的关系是与不是或<br>这里想表达的应该是--这个即将进入isr的副本的LEO值比分区高水位小，但满足条件2；<br>文中对条件2的描述好像有点歧义，以下是网上找的一段：<br>假设replica.lag.max.messages设置为4，表明只要follower落后leader不超过3，就不会从同步副本列表中移除。replica.lag.time.max设置为500 ms，表明只要follower向leader发送请求时间间隔不超过500 ms，就不会被标记为死亡,也不会从同步副本列中移除。 ","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461310,"discussion_content":"replica.lag.max.messages已经被移除了，不要看这篇了。你可以看看我之前写的这篇：Kafka副本管理—— 为何去掉replica.lag.max.messages参数（https://www.cnblogs.com/huxi2b/p/5903354.html）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564965768,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1798260,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/70/74/06742258.jpg","nickname":"demnox","note":"","ucode":"C3D8A08ED74ED1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":575546,"discussion_content":"博客中提到“HW表示的是最新一条已提交消息的位移” ，和本文不一致，麻烦更新下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654931065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":461310,"ip_address":""},"score":575546,"extra":""}]}]},{"had_liked":false,"id":120221,"user_name":"我来也","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1564809270,"is_pvip":false,"replies":[{"id":"44259","content":"没写反啊？就是想说只靠第一个条件不充分","user_name":"作者回复","comment_id":120221,"uid":"1288090","ip_address":"","utype":1,"ctime":1564966354,"user_name_real":"huxi_2b"}],"discussion_count":4,"race_medal":0,"score":"14449711158","product_id":100029201,"comment_content":"1.该远程 Follower 副本在 ISR 中。<br><br>如果 Kafka 只判断第 1 个条件的话，就可能出现某些副本具备了“进入 ISR”的资格，但却尚未进入到 ISR 中的情况。<br><br>————————<br>这里是不是把条件的编号写反了？<br>","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461245,"discussion_content":"没写反啊？就是想说只靠第一个条件不充分","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1576654,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0e/ce/9c96fa35.jpg","nickname":"客行","note":"","ucode":"FF508FF1346F1A","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339548,"discussion_content":"作者回复：第一个判断仅仅是资格的判断。大部分情况下可以等同于ISR判断，但是并不100%保证一定就表示在ISR中，所以保险起见做了第二层判断～","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1609729558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1506723,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLz3icr3mGs5ib8FbSPQZ2ic3ib90mHkd1btQrmGacZjJxfYXrerIdaTxglKyCicFzLcEAb6deC2cWjE5Q/132","nickname":"the geek","note":"","ucode":"71DECBC814A539","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275771,"discussion_content":"这种情况不是直接被第一个条件就判断为false了吗？怎么还会需要第二个条件呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590761014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1246200,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/f8/55554b12.jpg","nickname":"kai","note":"","ucode":"CFDC240DA364FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1506723,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLz3icr3mGs5ib8FbSPQZ2ic3ib90mHkd1btQrmGacZjJxfYXrerIdaTxglKyCicFzLcEAb6deC2cWjE5Q/132","nickname":"the geek","note":"","ucode":"71DECBC814A539","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316533,"discussion_content":"是的啊，希望作者解答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603421474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":275771,"ip_address":""},"score":316533,"extra":""}]}]},{"had_liked":false,"id":120180,"user_name":"lmtoo","can_delete":false,"product_type":"c1","uid":1133918,"ip_address":"","ucode":"FCD5B9C941D448","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","comment_is_top":false,"comment_ctime":1564804251,"is_pvip":false,"replies":[{"id":"44262","content":"这套机制防止的是根据HW做日志截断出现数据不一致，不能防止任何情况下副本都正常工作","user_name":"作者回复","comment_id":120180,"uid":"1288090","ip_address":"","utype":1,"ctime":1564966489,"user_name_real":"huxi_2b"}],"discussion_count":3,"race_medal":0,"score":"14449706139","product_id":100029201,"comment_content":"“当获知到 Leader LEO=2 后，B 发现该 LEO值不比它自己的 LEO 值小，而且缓存中也没有保存任何起始位移值 &gt; 2 的 Epoch 条目”是什么意思？<br>如果follower B重启回来之后去取Leader A的LEO，但是此时Leader A已经挂了，这套机制不就玩不转了吗？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461226,"discussion_content":"这套机制防止的是根据HW做日志截断出现数据不一致，不能防止任何情况下副本都正常工作","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1905357,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/12/cd/55e25527.jpg","nickname":"咕咕噜噜","note":"","ucode":"E9045BF11FAB7C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392132,"discussion_content":"同感存在这个问题？而且看下来并没有发现epoch版本号有啥用，关键点在于重启后去leader副本拉取LEO","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1630849865,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1184233,"avatar":"https://static001.geekbang.org/account/avatar/00/12/11/e9/b6aa6364.jpg","nickname":"shenfl","note":"","ucode":"607CD894152241","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308597,"discussion_content":"我觉得有个最常见的场景，LeaderA的HW更新成2后，B的HW还是1，这时A挂了，这样虽然B的LEO是2，但是HW是1，B成为Leader后数据就丢了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601001279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232518,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1594026602,"is_pvip":false,"replies":[{"id":"85924","content":"会。加了delete后缀的日志文件不会被访问到了","user_name":"作者回复","comment_id":232518,"uid":"1288090","ip_address":"","utype":1,"ctime":1594131589,"user_name_real":"胡夕"}],"discussion_count":1,"race_medal":0,"score":"10183961194","product_id":100029201,"comment_content":"老师好，有个问题请教一下：<br>日志段文件在删除时，先被标记为deleted，然后延迟默认1分钟后删除，如果此时我的客户端要访问这个日志文件，那么这个被标记为deleted的日志文件还会被删除吗？物理文件和内存中的文件分别是怎样的？也就是说会不会导致openfiles由于客户端的访问而不被释放掉？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500676,"discussion_content":"会。加了delete后缀的日志文件不会被访问到了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594131589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222363,"user_name":"the geek","can_delete":false,"product_type":"c1","uid":1506723,"ip_address":"","ucode":"71DECBC814A539","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLz3icr3mGs5ib8FbSPQZ2ic3ib90mHkd1btQrmGacZjJxfYXrerIdaTxglKyCicFzLcEAb6deC2cWjE5Q/132","comment_is_top":false,"comment_ctime":1590760953,"is_pvip":false,"replies":[{"id":"82077","content":"不是啊。follower当选了leader还需要用到HW","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1590847873,"ip_address":"","comment_id":222363,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10180695545","product_id":100029201,"comment_content":"看这篇文章的时候一直有个疑惑，follower的HW究竟有什么作用？<br>是版本的遗留吗？原来的追随者HW是用来截断日志的。现在有了Leader Epoch后，其实完全没必要在follower上保存HW。可以这样理解吗？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496765,"discussion_content":"不是啊。follower当选了leader还需要用到HW","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590847873,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180182,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1582206405,"is_pvip":true,"replies":[{"id":"69999","content":"1. 和你说的类似。因为ISR可能缩减为1<br>2. 因为这样使用同一套代码来同时建模所有类型副本，不用单独再写额外的逻辑了，况且也浪费不了多少空间。毕竟副本数不会太多<br>3. 有个Leader epoch cache，定期flush到磁盘上","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1582247324,"ip_address":"","comment_id":180182,"utype":1}],"discussion_count":1,"race_medal":2,"score":"10172140997","product_id":100029201,"comment_content":"1、Leader 副本处理生产者请求时，为什么会更新分区高水位值？理论上这个时候没有必要更新高水位吧（因为领导者的 Leo 是最大的，取 Min 值 HW 不会变化）？除非副本只有1个，那这种应该按特例分析吧，因为也不会有 follow 副本的存在了；<br>2、既然不更新远程副本中 HW 值，那为什么还会存储在那呢？岂不是很浪费空间<br>3、Leader Epoch 是存储在哪的呢？如何保证某个 Broker 挂了之后还能正常处理，是 ZK 么？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484556,"discussion_content":"1. 和你说的类似。因为ISR可能缩减为1\n2. 因为这样使用同一套代码来同时建模所有类型副本，不用单独再写额外的逻辑了，况且也浪费不了多少空间。毕竟副本数不会太多\n3. 有个Leader epoch cache，定期flush到磁盘上","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582247324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":176222,"user_name":"Keep","can_delete":false,"product_type":"c1","uid":1178075,"ip_address":"","ucode":"ADFD481F03AB84","user_header":"https://static001.geekbang.org/account/avatar/00/11/f9/db/51457469.jpg","comment_is_top":false,"comment_ctime":1580994203,"is_pvip":false,"replies":[{"id":"68704","content":"“如果 Kafka 只判断第 1 个条件的话，就可能出现某些副本具备了“进入 ISR”的资格，但却尚未进入到 ISR 中的情况。此时，分区高水位值就可能超过 ISR 中副本 LEO，而高水位 &gt; LEO 的情形是不被允许的”   --- 所以源码中不会只判断1个条件啊","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1581296097,"ip_address":"","comment_id":176222,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10170928795","product_id":100029201,"comment_content":"文中说: 分区高水位值就可能超过 ISR 中副本 LEO，而高水位 &gt; LEO 的情形是不被允许的。这段话是不是有误？因为在生产者设置acks=1时，只要leader副本写入磁盘就算提交，不用等follower同步消息。是有可能存在分区高水位&gt;ISR中的LEO的吧","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483053,"discussion_content":"“如果 Kafka 只判断第 1 个条件的话，就可能出现某些副本具备了“进入 ISR”的资格，但却尚未进入到 ISR 中的情况。此时，分区高水位值就可能超过 ISR 中副本 LEO，而高水位 &amp;gt; LEO 的情形是不被允许的”   --- 所以源码中不会只判断1个条件啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581296097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149789,"user_name":"注定非凡","can_delete":false,"product_type":"c1","uid":1113597,"ip_address":"","ucode":"80673056E131B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg","comment_is_top":false,"comment_ctime":1573378375,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"10163312967","product_id":100029201,"comment_content":"1，高水位概念<br>\tA ：水位：水位一次多用于流式处理领域，如Spark Streaming 或Flink框架中都有水位的概念。<br>\t\t在教科书中关于水位定义：在即刻T，任意创建时间（Event Time）为T ’ ，且T’ &lt;= T的所有事件都已经到达或被观测到，那么T就被定义为水位。<br><br>\t\t在“Streaming System”：一书则是这样表述水位：水位是一个单调增加且表征最早未完成工作（oldest work not yet completed）的时间戳。<br><br>\tB ：kafka的水位概念：kafka的水位不是时间戳，与时间无关。他是和位置信息绑定的，它是用消息位移来表征的。<br>\t\tKafka源码使用的表述是高水位。在Kafka中也有低水位（Low Watermark）,它是与Kafka删除消息相关的概念。<br>\t<br>2 高水位作用<br>\tA ：定义消息可见性，用来标识分区下的哪些消息是可以被消费者消费的。<br>\tB ：帮助Kafka完成副本同步。<br> <br>“已提交消息” 和 “未提交消息”<br>（1）在分区高水位以下的消息被认为是已提交消息，反之就是未提交消息。<br>（2）消费者只能消费已提交消息<br>（3）这不是Kafka的事务，因为事务机制会影响消息者所能看到的消息的范围，他不只是简单依赖高水位来判断。他依靠一个名为LSO(Log Stable Offset)的位移值来判断事务型消费者的可见性。<br>（4）位移值等于高水位的消息也属于为提交消息。即，高水位消息的消息是不能被消费者消费的。<br>（5）日志末端位移的概念：Log End Offset，简写是LEO。他表示副本写入下一条消息的位移值。同一个副本对象，其高水位值不会大于LEO值。<br>（6）高水位和LEO是副本对象的两个重要属性。Kafka所有副本都有对应的高水位和LEO值，而不仅仅是Leader副本。只是Leader副本比较特殊，Kafka使用Leader副本的高水位来定义所在分区的高水位。即，分区的高水位就是其Leader副本的高水位。<br>3 高水位更新机制<br> <br>A ：在Leader副本所在Broker上，还保存了其他Follower副本的LEO值。而其他Broker上仅仅保存该分区的某个Follower副本。Kafka将Leader副本所在Broker上保存的这些Follower副本称为远程副本。<br>\tKafka副本机制在运行过程中，会更新Broker1上Follower副本的高水位和LEO值，同时也会更新Broker0上Leader副本的高水位和LEO，以及所有远程副本的LEO。但它不会更新远程副本的高水位值。<br>\tBroker0上保存这些远程副本的作用是帮助Leader副本确定其高水位，即分区高水位。<br><br>B ：与Leader副本保持同步<br>\t<br>总结：高水位和LEO的更新机制<br>\t一,Leader副本<br>\t\t处理生产者请求的逻辑：<br>\t \ta. 写入消息到本地磁盘。<br>\t \tb. 更新分区高水位值<br>\t\t\t1，获取Leader副本所在Broker端保存的所有远程副本LEO值{LEO-1，LEO-2，……，LEO-n}。<br>\t\t\t2，获取Leader副本高水位值:currentHW。<br>\t\t\t3，更新currentHW = max（currentHW ，min(leo-1,leo-2,……leo-n)）.<br>\t\t<br>处理follwer副本拉取消息的逻辑：<br>a. 读取磁盘（或页缓存）中的消息数据<br>b. 使用Follower副本发送请求中的位移值更新远程副本LEO值。<br>c. 更新分区高水位值（具体步骤与处理生产者请求的步骤相同）<br><br>二 Follower副本<br>\t从Leader拉取消息的处理逻辑：<br>\ta. 写入消息到本地磁盘<br>\tb. 更新LEO值<br>\tc. 更新高水位值<br>\t\t1. 获取Leader发送的高水位值：currentHW。<br>\t\t2. 获取步骤2中更新过的LEO值：currentLEO。<br>\t\t3. 更新高水位为min（currentHW，currentLEO）。<br><br>4 Leader Epoch <br>\tLeader Epoch概念，用来规避因高水位更新错配导致的各种不一种问题。所谓Leader Epoch大致可以认为是Leader版本。<br>\tA ：组成：由两部分数据组成。<br>\t\t1. Epoch。一个单调增加的版本号。每当领导权发生变更时，都会增加该版本号。小版本号的Leader被认为是过期的Leader，不能在行使Leader权利。<br>\t\t2. 起始位移（Start Offset）。Leader副本在改Epoch值上写入的首条消息的位移。<br>\tB ：Kafka Broker会在内存中为每个分区都缓存Leader Epoch数据，同时他还会定期地将这些信息持久化到一个checkpoint文件中。<br>","like_count":2,"discussions":[{"author":{"id":1325994,"avatar":"https://static001.geekbang.org/account/avatar/00/14/3b/aa/e8dfcd7e.jpg","nickname":"AAA_叶子","note":"","ucode":"1E93617D308EE0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":87270,"discussion_content":"“位移值等于高水位的消息也属于为提交消息。即，高水位消息的消息是不能被消费者消费的” 这段高水位的消息为未提交消息。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576657691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277029,"user_name":"山里小龙","can_delete":false,"product_type":"c1","uid":1297635,"ip_address":"","ucode":"4ADA02F1ED59EA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo7R9LibMTe6CF9sVIcZUee5xCVEAxiava7CUb37V3ic6eFYuWBgFelDqeA0wekG2ibA3HFic94PYJHWlA/132","comment_is_top":false,"comment_ctime":1612237275,"is_pvip":false,"replies":[{"id":"101021","content":"高水位=1才说明offset=1的那条消息要被删掉，因为hw以下的消息是已成功提交的","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1612833908,"ip_address":"","comment_id":277029,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5907204571","product_id":100029201,"comment_content":"”当它重启回来后，副本 B 会执行日志截断操作，将 LEO 值调整为之前的高水位值，也就是 1。这就是说，位移值为 1 的那条消息被副本 B 从磁盘中删除，此时副本 B 的底层磁盘文件中只保存有 1 条消息，即位移值为 0 的那条消息。”<br>这里有点不明白，主从的高水位都是1了，说明数据1已经成功同步了，为什么要把1给截断删除呢？follower重启只需要把leo值设置为1就行了，hw不用动了吧！","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514908,"discussion_content":"高水位=1才说明offset=1的那条消息要被删掉，因为hw以下的消息是已成功提交的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612833908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243972,"user_name":"天敌","can_delete":false,"product_type":"c1","uid":1059944,"ip_address":"","ucode":"CD29A622197197","user_header":"https://static001.geekbang.org/account/avatar/00/10/2c/68/c299bc71.jpg","comment_is_top":false,"comment_ctime":1598343029,"is_pvip":false,"replies":[{"id":"89875","content":"它会从leader处拉取最新的leader epoch项对应的end offset，如果是最新的epoch，那么其end offset对应的就是LEO值","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1598407895,"ip_address":"","comment_id":243972,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5893310325","product_id":100029201,"comment_content":"老师，在启用了Leader Epoch机制后，Follower副本B重启回来后，是如何知道Leader得LEO值?这也是Leader Epoch 机制里面得吗？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504444,"discussion_content":"它会从leader处拉取最新的leader epoch项对应的end offset，如果是最新的epoch，那么其end offset对应的就是LEO值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598407895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":242911,"user_name":"Vector","can_delete":false,"product_type":"c1","uid":2088687,"ip_address":"","ucode":"FFCF366130998F","user_header":"","comment_is_top":false,"comment_ctime":1597889899,"is_pvip":false,"replies":[{"id":"89605","content":"错配主要是想说follower更新水位的时机落后于leader端，因为需要额外一轮或几轮RPC","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1597971670,"ip_address":"","comment_id":242911,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5892857195","product_id":100029201,"comment_content":"副本同步机制解析开头的例子并不能说明“Leader 副本高水位更新和 Follower 副本高水位更新在时间上是存在错配的。”吧，因为两者都是在同一次FETCH请求内更新的，如果说在时间上存在错配的话，也应该是FETCH请求在leader副本处理成功，但follower副本所在broker宕机未能处理。但感觉这里表述的不太明确，不知道老是说的时间错配指的是不是在min.insync.replicas=1的情况下发生的。","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504131,"discussion_content":"错配主要是想说follower更新水位的时机落后于leader端，因为需要额外一轮或几轮RPC","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597971670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228972,"user_name":"密码123456","can_delete":false,"product_type":"c1","uid":1126593,"ip_address":"","ucode":"9889463CC0EA71","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","comment_is_top":false,"comment_ctime":1592873871,"is_pvip":false,"replies":[{"id":"84448","content":"嗯，是这个意思。默认acks=1的话，leader获取了消息，其他ISR follower可能尚未获取到，因此一旦leader发生变更，可能会丢消息","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592880981,"ip_address":"","comment_id":228972,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5887841167","product_id":100029201,"comment_content":"在isr同步后就是已提交的消息，isr未同步就是未提交的消息。也就是说必须满足2个条件的原因，让高水位一定小于LEO。也就是使用默认的acks可能丢失数据的原因。这里理解对不对？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499281,"discussion_content":"嗯，是这个意思。默认acks=1的话，leader获取了消息，其他ISR follower可能尚未获取到，因此一旦leader发生变更，可能会丢消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592880981,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223941,"user_name":"会玩code","can_delete":false,"product_type":"c1","uid":1325282,"ip_address":"","ucode":"9220B072AF68C7","user_header":"https://static001.geekbang.org/account/avatar/00/14/38/e2/28aa8e6c.jpg","comment_is_top":false,"comment_ctime":1591236828,"is_pvip":false,"replies":[{"id":"82742","content":"一切以leader的数据为准：）","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1591540564,"ip_address":"","comment_id":223941,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5886204124","product_id":100029201,"comment_content":"老师，有个疑问想请教下，假如有3个副本，leader发生异常后，较为落后的那个副本当选了新的leader，这时候获取epoch的时候发现offset比新leader的leo还高，那这种情况是怎么处理之后的写入呢？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497308,"discussion_content":"一切以leader的数据为准：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591540564,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219313,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1589987698,"is_pvip":true,"replies":[{"id":"81042","content":"有些落后很多的follower可能出现这种情况","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1590024642,"ip_address":"","comment_id":219313,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5884954994","product_id":100029201,"comment_content":"iii. 更新 currentHW = max{currentHW, min（LEO-1, LEO-2, ……，LEO-n）}<br>-------------------------------------------------------------------------------&gt;<br>老师， LEO-1,LEO-2...LEO-n 都是在ISR集合中的，我认为 currentHW= min（LEO-1, LEO-2, ……，LEO-n就可以，请问在什么场景下currentHW 会大于 min(LEO-1, LEO-2, ……，LEO-n）","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495760,"discussion_content":"有些落后很多的follower可能出现这种情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590024642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1016777,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","nickname":"thomas","note":"","ucode":"9AB945308F1B50","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":270747,"discussion_content":"还是没理解，不是只要在ISR中，即使落后很多，currentHW也是取最小的。老师能举个例子吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590047322,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187872,"user_name":"Cv","can_delete":false,"product_type":"c1","uid":1062797,"ip_address":"","ucode":"C77CE172B5AA28","user_header":"","comment_is_top":false,"comment_ctime":1584263572,"is_pvip":false,"replies":[{"id":"72586","content":"1. 实际上远程副本是所有的副本，只是在进行水位更新操作时会进行是否同步的条件测定（主要是ISR测试），故不会受到慢follower拖累<br>2. “提交成功之前的章节” 有点没明白这里的章节是什么意思？如1所说，高水位更新时也会考虑ISR以及是否同步等条件","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1584320059,"ip_address":"","comment_id":187872,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5879230868","product_id":100029201,"comment_content":"看到文中一直说是所有远程副本, 是指保持同步的follower的,还是包括不满足同步2个条件的不同步的也算?<br>如果不同步的也算的话, 那么有一个follower同步的很慢, 不就拖累了整个集群吗?<br>还要一个问题, 提交成功=可以被消费=高水位, 提交成功之前的章节是可以配置几个副本同步完成就算提交成功的, 但是高水位计算时又是所有副本, 这里是不是矛盾了呢?","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487277,"discussion_content":"1. 实际上远程副本是所有的副本，只是在进行水位更新操作时会进行是否同步的条件测定（主要是ISR测试），故不会受到慢follower拖累\n2. “提交成功之前的章节” 有点没明白这里的章节是什么意思？如1所说，高水位更新时也会考虑ISR以及是否同步等条件","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584320059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120391,"user_name":"刘丹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1564878401,"is_pvip":false,"replies":[{"id":"44243","content":"表示A又挂了。。。。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564965697,"ip_address":"","comment_id":120391,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5859845697","product_id":100029201,"comment_content":"请问老师：副本B重启的时候，为什么副本A的图片里有个红色的叉？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461315,"discussion_content":"表示A又挂了。。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564965697,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120354,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564841680,"is_pvip":false,"replies":[{"id":"44252","content":"获取到的leader LEO值不小于自己的LEO。2仅仅是图中举的例子的位移。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564966077,"ip_address":"","comment_id":120354,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5859808976","product_id":100029201,"comment_content":"“当获知到 Leader LEO=2 后，B 发现该 LEO值不比它自己的 LEO 值小，而且缓存中也没有保存任何起始位移值 &gt; 2 的 Epoch 条目”是什么意思？<br><br>老师，leo值不比自己leo知道说明意思，但是后面epoch这句话不理解，如果起始值大于2意味着什么呢？<br>如果大于2，不是应该说follower当前的日志更老吗，更不应该截断日志。麻烦解答下，谢谢，很疑惑<br>","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461299,"discussion_content":"获取到的leader LEO值不小于自己的LEO。2仅仅是图中举的例子的位移。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357884,"user_name":"苏予安","can_delete":false,"product_type":"c1","uid":2944782,"ip_address":"四川","ucode":"1559DA26EBFD05","user_header":"https://static001.geekbang.org/account/avatar/00/2c/ef/0e/55073b27.jpg","comment_is_top":false,"comment_ctime":1663729505,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1663729505","product_id":100029201,"comment_content":"感觉没看懂呢","like_count":0},{"had_liked":false,"id":353581,"user_name":"海贼王路飞","can_delete":false,"product_type":"c1","uid":1318003,"ip_address":"江苏","ucode":"DA2C2B30BB1929","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/skA8yOrlgd2lK3iaWaxwAYU2Kho0IVicfLfLiaguHQbar9rsQEYzVraiaibNKNcibsgp995dWuzQpSTjhW47Shdmtq7Q/132","comment_is_top":false,"comment_ctime":1659581255,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1659581255","product_id":100029201,"comment_content":"远程副本是某个分区副本的follower还是其他分区副本的follower?","like_count":0},{"had_liked":false,"id":350473,"user_name":"凯文小猪","can_delete":false,"product_type":"c1","uid":1980201,"ip_address":"","ucode":"36D8AD0229547F","user_header":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","comment_is_top":false,"comment_ctime":1656935763,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1656935763","product_id":100029201,"comment_content":"其实真实运行时，leader节点会保存Map&lt;leader epoch, startOffset&gt;到check point文件 同时也会在内存缓存起来，变量为epochs。所以老师的例子是这样的：如果请求的leader epoch在epochs里存在，就返回当前的LEO，反之取出比请求 epoch大的最小start offset，作为offset。<br>也就是强迫follower 此时从最小有效start  offset开始截断 并重新开始同步日志<br><br>也就是说如果follower宕机不太久 那么start offset其实没什么意义。相反 我们大多数时候用的就是LEO<br><br>代码：LeaderEpochFileCache.endOffsetFor()","like_count":0},{"had_liked":false,"id":346327,"user_name":"so long","can_delete":false,"product_type":"c1","uid":1449679,"ip_address":"","ucode":"2A6B47BB32FC18","user_header":"https://static001.geekbang.org/account/avatar/00/16/1e/cf/97cd8be1.jpg","comment_is_top":false,"comment_ctime":1653027947,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653027947","product_id":100029201,"comment_content":"老师您好，文中有这么一段：当获知到 Leader LEO=2 后，B 发现该 LEO 值不比它自己的 LEO 值小，而且缓存中也没有保存任何起始位移值 &gt; 2 的 Epoch 条目，因此 B 无需执行任何日志截断操作。<br>我认为应该是缓存中也没有保存任何起始位移值 &lt;2并且&gt;0 的 Epoch 条目才对。<br>举个例子：<br>当前有3个副本A(Leader)、B、C，Leader Epoch&lt;0, 0&gt;，HW=5,A的LEO=15，B的LEO=10，C的LEO=5；<br>这个时候B和A宕机，C成为Leader,生产者往C发送10条消息后，C的LEO=15，Leader Epoch&lt;1, 5&gt;<br>然后B重启，B的LEO=10&lt;C的LEO=15，Leader Epoch=5&lt;B的LEO=10。B的5至9号消息和C的5至9号消息不一样，需要被截断。<br>请老师看一下这个例子是否由问题，谢谢！","like_count":0},{"had_liked":false,"id":339129,"user_name":"Mr.Brooks","can_delete":false,"product_type":"c1","uid":1118650,"ip_address":"","ucode":"D47A6B0236A79F","user_header":"https://static001.geekbang.org/account/avatar/00/11/11/ba/2175bc50.jpg","comment_is_top":false,"comment_ctime":1647933948,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1647933948","product_id":100029201,"comment_content":"一直不太明白replica.lag.max.time怎么被使用。一个是时间，一个是offset。没有速度，如何比较follower是否能赶上leader呢 ？","like_count":0,"discussions":[{"author":{"id":2386531,"avatar":"","nickname":"Geek_f587b1","note":"","ucode":"4877B28585A63A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581939,"discussion_content":"fetch的时间间隔","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659079044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331971,"user_name":"Geek_dc018e","can_delete":false,"product_type":"c1","uid":2866331,"ip_address":"","ucode":"7A414A5829EF99","user_header":"","comment_is_top":false,"comment_ctime":1642929516,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1642929516","product_id":100029201,"comment_content":"Leader 副本保持同步的判断的条件有两个<br>1.该远程 Follower 副本在 ISR 中。<br>2.该远程 Follower 副本 LEO 值落后于 Leader 副本 LEO 值的时间，不超过 Broker 端参数 replica.lag.time.max.ms 的值。如果使用默认值的话，就是不超过 10 秒。<br>这里加入第二个条件作为补充，我的理解是如果只判断第一个条件，此时某个不在isr集合中的follower副本追上了leader副本，拥有了进入isr集合的资格，但是isr的元数据还未变更。不凑巧的是，在isr元数据变更的过程中，这个副本又出现了落后，那么这个副本进入isr时就有可能出现分区HW大于“与leader同步的副本”LEO。所以引入了第二个条件预防这类不凑巧的情况，但如果这个副本是在加入isr操作完成后出现的落后，就算只判断第一个条件也不会有这种情况发生，因为分区HW亦即Leader副本HW取的是”ISR中副本LEO的最小值“。<br>个人浅见，有误的话还请老师指正。","like_count":0},{"had_liked":false,"id":330214,"user_name":"贝影","can_delete":false,"product_type":"c1","uid":1054827,"ip_address":"","ucode":"19545C8DCBF8A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","comment_is_top":false,"comment_ctime":1641867895,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641867895","product_id":100029201,"comment_content":"想咨询下，客户端API中的endOffsets方法到底是获取HW还是LEO？HW定义是消费者能消费到的offset，那endOffsets就不能超出HW所见的范畴吧？","like_count":0},{"had_liked":false,"id":324749,"user_name":"懒猫","can_delete":false,"product_type":"c1","uid":2538092,"ip_address":"","ucode":"094F30C802C0F6","user_header":"","comment_is_top":false,"comment_ctime":1638602523,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1638602523","product_id":100029201,"comment_content":"请问除了对技术的好奇，学习高水位和 Epoch 原理的实际意义是什么，有没有场景会用到这些知识？","like_count":0},{"had_liked":false,"id":315387,"user_name":"北北","can_delete":false,"product_type":"c1","uid":2742641,"ip_address":"","ucode":"962F61D0BADF07","user_header":"https://static001.geekbang.org/account/avatar/00/29/d9/71/23a44e0d.jpg","comment_is_top":false,"comment_ctime":1633873005,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633873005","product_id":100029201,"comment_content":"A B C三个副本，A为leader，生产者向A写入2条数据，这时B C副本hw为2，leo为1<br>然后B向leader A发送一个特殊请求获取leader的leo，在请求之前，leader A宕机，选举到C为leader，但是C的leo为1<br>B又向新leader C去获取leo值，C的leo还是1，那么最终写下的数据为epoch=1 offset=1<br><br>这样还是丢失了原位移值为1的那条消息","like_count":0},{"had_liked":false,"id":313772,"user_name":"Incomparable","can_delete":false,"product_type":"c1","uid":2756871,"ip_address":"","ucode":"7B1892B0151392","user_header":"https://static001.geekbang.org/account/avatar/00/2a/11/07/a227a67f.jpg","comment_is_top":false,"comment_ctime":1632660553,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632660553","product_id":100029201,"comment_content":"老师能解释下，为什么epoch 场景下，b回来时发现不用截断日志，<br>-------------------------------------------------<br>作者回复: 因为不再使用hw值做截断依据了<br>-------------------------------------------------<br>老师，不再使用 hw 值做截断依据，那 b 中的位移值1 的消息，确实是未提交的，那怎么截断呢？<br>","like_count":0},{"had_liked":false,"id":305755,"user_name":"if...else...","can_delete":false,"product_type":"c1","uid":2550743,"ip_address":"","ucode":"D0565908C99695","user_header":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","comment_is_top":false,"comment_ctime":1628150529,"is_pvip":false,"discussion_count":0,"race_medal":4,"score":"1628150529","product_id":100029201,"comment_content":"非常有用的思想，epoch","like_count":0},{"had_liked":false,"id":301832,"user_name":"Flee","can_delete":false,"product_type":"c1","uid":1579193,"ip_address":"","ucode":"E032477C6888F8","user_header":"https://static001.geekbang.org/account/avatar/00/18/18/b9/d74477d1.jpg","comment_is_top":false,"comment_ctime":1625903807,"is_pvip":false,"replies":[{"id":"109454","content":"拿不到了，但这不会造成数据不一致的情况。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1626242188,"ip_address":"","comment_id":301832,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1625903807","product_id":100029201,"comment_content":"针对“每次有 Leader 变更时，新的 Leader 副本会查询这部分缓存，取出对应的 Leader Epoch 的起始位移，以避免数据丢失和不一致的情况。”<br>如果原始 Leader 已经挂了, 那么如何拿到这个 Leader Epoch 信息呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523104,"discussion_content":"拿不到了，但这不会造成数据不一致的情况。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626242188,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301828,"user_name":"Flee","can_delete":false,"product_type":"c1","uid":1579193,"ip_address":"","ucode":"E032477C6888F8","user_header":"https://static001.geekbang.org/account/avatar/00/18/18/b9/d74477d1.jpg","comment_is_top":false,"comment_ctime":1625900591,"is_pvip":false,"replies":[{"id":"109461","content":"hmmm.... 应该这么说，大部分情况下这两个条件说的是一个事。你基本上可以认为是一个防御性编程的写法","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1626242448,"ip_address":"","comment_id":301828,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1625900591","product_id":100029201,"comment_content":"副本是否同步的本质感觉就是第二个条件，进出 ISR 都可能有滞后，而条件 2 本来就是进入 ISR 的条件，那么条件 1 是不是就没有必要了？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523103,"discussion_content":"hmmm.... 应该这么说，大部分情况下这两个条件说的是一个事。你基本上可以认为是一个防御性编程的写法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626242448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300844,"user_name":"被歌唱拯救中","can_delete":false,"product_type":"c1","uid":1153342,"ip_address":"","ucode":"84E73FB0D1E56A","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/3e/8a813e51.jpg","comment_is_top":false,"comment_ctime":1625402733,"is_pvip":false,"replies":[{"id":"109456","content":"那就获取不到了，但这不会造成数据不一致。leader epoch解决的是某些场景下的副本不一致","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1626242268,"ip_address":"","comment_id":300844,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1625402733","product_id":100029201,"comment_content":"“引用 Leader Epoch 机制后，Follower 副本 B 重启回来后，需要向 A 发送一个特殊的请求去获取 Leader 的 LEO 值。”<br>假如这个时候，副本A所在broker宕机怎么做呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522833,"discussion_content":"那就获取不到了，但这不会造成数据不一致。leader epoch解决的是某些场景下的副本不一致","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626242268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1905357,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/12/cd/55e25527.jpg","nickname":"咕咕噜噜","note":"","ucode":"E9045BF11FAB7C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392133,"discussion_content":"为什么不会数据不一致？这个时候重新选举副本B作为Leader，消息一样丢了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630850286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":294816,"user_name":"大力水手Jerry","can_delete":false,"product_type":"c1","uid":1227840,"ip_address":"","ucode":"E4A6C71E275DB5","user_header":"https://static001.geekbang.org/account/avatar/00/12/bc/40/2279cfb5.jpg","comment_is_top":false,"comment_ctime":1622100613,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1622100613","product_id":100029201,"comment_content":"新版本的Kafka已经支持从任意副本读，所以逻辑上发生了较大变化。不过HW和epoch的本质应该没有改变。HW依然表示已经同步到所有ISR副本的最小offset，即当前副本所知的committed的最大offset，可以被用来消费。epoch的主要作用是区分当前leader，避免多主造成的混乱。感觉epoch不能彻底避免消息的丢失，因为follower副本的HW总是不大于leader副本的HW，因此始终存在新leader所认定的Committed的offset小于原leader所认定committed的offset的可能。Kafka通过优化fetch协议，实现HW的无阻塞propagation，就是为了尽量减小不同副本间HW差异。主要参考：https:&#47;&#47;cwiki.apache.org&#47;confluence&#47;display&#47;KAFKA&#47;KIP-392%3A+Allow+consumers+to+fetch+from+closest+replica","like_count":0,"discussions":[{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554417,"discussion_content":"您这里说的新版本主要是从哪个版本开始呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646370019,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1227840,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/40/2279cfb5.jpg","nickname":"大力水手Jerry","note":"","ucode":"E4A6C71E275DB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377031,"discussion_content":"“HW依然表示已经同步到所有ISR副本的最小offset”，应该是“所有ISR副本的最大offset”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622469527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":266190,"user_name":"feifei","can_delete":false,"product_type":"c1","uid":1258380,"ip_address":"","ucode":"BFA3BE8D8773A7","user_header":"https://static001.geekbang.org/account/avatar/00/13/33/8c/23eef8d7.jpg","comment_is_top":false,"comment_ctime":1607231842,"is_pvip":false,"replies":[{"id":"97341","content":"因为不再使用hw值做截断依据了","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1608080551,"ip_address":"","comment_id":266190,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1607231842","product_id":100029201,"comment_content":"老师能解释下，为什么epoch 场景下，b回来时发现不用截断日志，","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511173,"discussion_content":"因为不再使用hw值做截断依据了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608080551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264479,"user_name":"风","can_delete":false,"product_type":"c1","uid":1147929,"ip_address":"","ucode":"AFDBEFA49F269E","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","comment_is_top":false,"comment_ctime":1606474311,"is_pvip":true,"replies":[{"id":"96045","content":"表示消息日志中该位移出尚未写入任何消息","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606698849,"ip_address":"","comment_id":264479,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1606474311","product_id":100029201,"comment_content":"老师,请问Leader Epoch中的几张图里面的黄色块代表的是什么意思","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510577,"discussion_content":"表示消息日志中该位移出尚未写入任何消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606698849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264474,"user_name":"风","can_delete":false,"product_type":"c1","uid":1147929,"ip_address":"","ucode":"AFDBEFA49F269E","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","comment_is_top":false,"comment_ctime":1606473387,"is_pvip":true,"replies":[{"id":"96046","content":"如果是之前的epoch项，那么返回的是下一个epoch项纪录的首条消息的位移，如果是最新的epoch，则返回log end offset","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606698944,"ip_address":"","comment_id":264474,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1606473387","product_id":100029201,"comment_content":"老师，在启用了Leader Epoch机制后，Follower副本B重启回来后，是如何知道Leader得LEO值?这也是Leader Epoch 机制里面得吗？<br>作者回复: 它会从leader处拉取最新的leader epoch项对应的end offset，如果是最新的epoch，那么其end offset对应的就是LEO值<br><br>起始位移不是Leader副本在该Epoch 值上写入的首条消息的位移  首条消息位移为什么会等于LEO","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510575,"discussion_content":"如果是之前的epoch项，那么返回的是下一个epoch项纪录的首条消息的位移，如果是最新的epoch，则返回log end offset","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606698944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264468,"user_name":"风","can_delete":false,"product_type":"c1","uid":1147929,"ip_address":"","ucode":"AFDBEFA49F269E","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","comment_is_top":false,"comment_ctime":1606472199,"is_pvip":true,"replies":[{"id":"96047","content":"为什么是3呢？？","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606698985,"ip_address":"","comment_id":264468,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1606472199","product_id":100029201,"comment_content":"引入leader epoch之后的那张说明图中,为什么新的 Leader  Epoch 条目：[Epoch=1, Offset=2]<br>offset的值为什么是2,生产者向B写入数据,这个时候不是应该是3吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510573,"discussion_content":"为什么是3呢？？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606698985,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1147929,"avatar":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","nickname":"风","note":"","ucode":"AFDBEFA49F269E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330732,"discussion_content":"我以为黄色块是已经写入了消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606699485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256785,"user_name":"Geek6561","can_delete":false,"product_type":"c1","uid":2028940,"ip_address":"","ucode":"D44141D4AD2587","user_header":"","comment_is_top":false,"comment_ctime":1603728999,"is_pvip":false,"replies":[{"id":"93765","content":"分区处于不可用状态","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1604027560,"ip_address":"","comment_id":256785,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603728999","product_id":100029201,"comment_content":"“只不过引用 Leader Epoch 机制后，Follower 副本 B 重启回来后，需要向 A 发送一个特殊的请求去获取 Leader 的 LEO 值”。这个时候A挂了，会怎么样呢","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508119,"discussion_content":"分区处于不可用状态","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604027560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250976,"user_name":"三颗豆子","can_delete":false,"product_type":"c1","uid":2008638,"ip_address":"","ucode":"632CE3E7563666","user_header":"https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg","comment_is_top":false,"comment_ctime":1601296650,"is_pvip":false,"replies":[{"id":"91822","content":"以极客时间的内容为准。那篇帖子写得时间很久远了。另外HW会下降是什么意思？<br>","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1601343354,"ip_address":"","comment_id":250976,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1601296650","product_id":100029201,"comment_content":"有关高水位HW更新，.2.x的parition.scala的maybeIncrementLeaderHW源代码的确是这样写的。<br>但是看到另一篇文章（https:&#47;&#47;www.cnblogs.com&#47;huxi2b&#47;p&#47;7453543.html）说：<br>尝试更新分区HW——此时leader LEO = 1，remote LEO = 1，故分区HW值= min(leader LEO, follower remote LEO) = 1<br>看起来并不是max(leader HW, follower LEO)，请问胡哥怎么看这个说法呢，感觉如果是胡哥在评论区说的“落后很多follower的情况”，这个也是有问题，HW会下降，是不是又有什么历史原因，比如历史版本的是这样写的？谢谢。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506351,"discussion_content":"以极客时间的内容为准。那篇帖子写得时间很久远了。另外HW会下降是什么意思？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601343354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2008638,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg","nickname":"三颗豆子","note":"","ucode":"632CE3E7563666","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309954,"discussion_content":"“HW会下降”指的是按照那篇博客的说法，用HW=min(leader LEO, follower remote LEO) ，当落后很多follower的情况下（同步到10秒内，但是LEO比分区HW小），HW有可能更新出来比以前小，不合理。\n才发现那篇博客也是胡哥写的……真棒。\n所以想问问为啥当时你用了“min(leader LEO, follower remote LEO) ”呢，是0.11.x版本这样写的吗，我感觉除开“落后很多follower”这种情况，理论上还挺通顺的。\n另外同“店小二#2”有同样的疑惑，如果我们一直按照HW=max(leader HW, follower LEO)，那落后的follower进入ISR之后，虽然HW不会减少，但HW大于落后的follower的LEO了，这个不是很奇怪的事情吗？如果这个时候其他机器都宕机，这个落后的follower成为了leader对外提供读写，就像是对外已经告诉consumer我的HW是100，结果自己的LEO才98，这个会有一致性问题的吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601539623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249854,"user_name":"zero","can_delete":false,"product_type":"c1","uid":1116471,"ip_address":"","ucode":"EE02BDCB299EBF","user_header":"https://static001.geekbang.org/account/avatar/00/11/09/37/997cd243.jpg","comment_is_top":false,"comment_ctime":1600831639,"is_pvip":false,"replies":[{"id":"91599","content":"Kafka不会等任何副本落盘才算提交。只要写入到page cache就算写入成功","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1600909172,"ip_address":"","comment_id":249854,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1600831639","product_id":100029201,"comment_content":"你好胡夕，如果acks=1，min.insync.replicaas &gt; 1，kafka是等leader落盘就算已提交，还是isr副本都落盘后才算已提交？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506036,"discussion_content":"Kafka不会等任何副本落盘才算提交。只要写入到page cache就算写入成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600909172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239080,"user_name":"对与错","can_delete":false,"product_type":"c1","uid":1682027,"ip_address":"","ucode":"EF55733E3BD78B","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","comment_is_top":false,"comment_ctime":1596429161,"is_pvip":false,"replies":[{"id":"88414","content":"“请问在收到ack应答之前，是否请求都在&quot;炼狱&quot;里面” --- 不一定。有时候请求已经被处理完成了，放入response队列等待发送。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1596519529,"ip_address":"","comment_id":239080,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1596429161","product_id":100029201,"comment_content":"胡哥，请问producer发送消息之后，返回ack的时候失败了，那么这条消息会被标记已提交吗?或者说会在高水位里面吗?还有就是这条消息会被consumer消费到吗?<br>------------------------------------------------------------------<br>作者回复: 不会。如果response显示失败，那么不是为已提交。也不会被消费掉。Consumer只能消费已提交的消息<br>-----------------------------------------------------------------<br>接上一个问题，请问在收到ack应答之前，是否请求都在&quot;炼狱&quot;里面，并且都不算落到页缓存上面，也就是说相对于leader副本来说，算还没有收到消息？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502970,"discussion_content":"“请问在收到ack应答之前，是否请求都在&amp;quot;炼狱&amp;quot;里面” --- 不一定。有时候请求已经被处理完成了，放入response队列等待发送。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596519529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":238208,"user_name":"对与错","can_delete":false,"product_type":"c1","uid":1682027,"ip_address":"","ucode":"EF55733E3BD78B","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","comment_is_top":false,"comment_ctime":1596095654,"is_pvip":false,"replies":[{"id":"88296","content":"不会。如果response显示失败，那么不是为已提交。也不会被消费掉。Consumer只能消费已提交的消息","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1596426097,"ip_address":"","comment_id":238208,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1596095654","product_id":100029201,"comment_content":"胡哥，请问producer发送消息之后，返回ack的时候失败了，那么这条消息会被标记已提交吗?或者说会在高水位里面吗?还有就是这条消息会被consumer消费到吗?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502674,"discussion_content":"不会。如果response显示失败，那么不是为已提交。也不会被消费掉。Consumer只能消费已提交的消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596426097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":238047,"user_name":"对与错","can_delete":false,"product_type":"c1","uid":1682027,"ip_address":"","ucode":"EF55733E3BD78B","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","comment_is_top":false,"comment_ctime":1596035813,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596035813","product_id":100029201,"comment_content":"胡哥，请问producer发送消息之后，返回ack的时候失败了，那么这条消息会被标记已提交吗?或者说会在高水位里面吗?还有就是这条消息会被consumer消费到吗?","like_count":0},{"had_liked":false,"id":237475,"user_name":"王腾","can_delete":false,"product_type":"c1","uid":1079458,"ip_address":"","ucode":"D2444D44DACAD0","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/a2/016daa1a.jpg","comment_is_top":false,"comment_ctime":1595840793,"is_pvip":true,"replies":[{"id":"87740","content":"谢谢，一起加油~","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1595841225,"ip_address":"","comment_id":237475,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1595840793","product_id":100029201,"comment_content":"精彩，看书看不懂的地方，老师都解释的很清楚明了，赞！！","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502428,"discussion_content":"谢谢，一起加油~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595841225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":235252,"user_name":"张洋","can_delete":false,"product_type":"c1","uid":1182914,"ip_address":"","ucode":"549BE5DEEF8417","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/c2/bad34a50.jpg","comment_is_top":false,"comment_ctime":1594951992,"is_pvip":true,"replies":[{"id":"87082","content":"首先leader要选出来，然后同步给b，b才会向leader拉取数据","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1595213176,"ip_address":"","comment_id":235252,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1594951992","product_id":100029201,"comment_content":"老师假设 AB同时宕机了，B重启后怎么去获取Leader的LEO值呢","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501657,"discussion_content":"首先leader要选出来，然后同步给b，b才会向leader拉取数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595213176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228881,"user_name":"店小二#2","can_delete":false,"product_type":"c1","uid":1130925,"ip_address":"","ucode":"6103E9AE52F8E7","user_header":"https://static001.geekbang.org/account/avatar/00/11/41/ad/4ccf4238.jpg","comment_is_top":false,"comment_ctime":1592833206,"is_pvip":false,"replies":[{"id":"84415","content":"因为follower的HW尚未更新啊","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592874858,"ip_address":"","comment_id":228881,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592833206","product_id":100029201,"comment_content":"老师，问一下HW更新问题。<br>&quot;副本同步机制解析&quot;小节的第3张图，在leader副本的LEO更新为1后，leader副本的HW怎么还是0？leader的HW更新时机之一&quot;leader副本更新LEO后&quot;不是也更新HW么，图3中没体现出来。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499232,"discussion_content":"因为follower的HW尚未更新啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592874858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227769,"user_name":"店小二#2","can_delete":false,"product_type":"c1","uid":1130925,"ip_address":"","ucode":"6103E9AE52F8E7","user_header":"https://static001.geekbang.org/account/avatar/00/11/41/ad/4ccf4238.jpg","comment_is_top":false,"comment_ctime":1592473746,"is_pvip":false,"replies":[{"id":"84346","content":"您能详细指出是那张图吗？","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592794601,"ip_address":"","comment_id":227769,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592473746","product_id":100029201,"comment_content":"讲解副本同步机制那部分，几张图中HW的值是不是有点问题？<br>根据leader副本HW跟新时机（leader副本更新LEO后 或 远程副本更新LEO后），图中在Producer提交第1条消息后，Leader副本的HW是不是就要置为1。但图中怎么在Follower副本fetchOffset=1的时候才更新？<br>感觉文章中总结的Leader 副本HW更新时机与图中对不上。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498772,"discussion_content":"您能详细指出是那张图吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592794601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226572,"user_name":"店小二#2","can_delete":false,"product_type":"c1","uid":1130925,"ip_address":"","ucode":"6103E9AE52F8E7","user_header":"https://static001.geekbang.org/account/avatar/00/11/41/ad/4ccf4238.jpg","comment_is_top":false,"comment_ctime":1592144109,"is_pvip":false,"replies":[{"id":"83431","content":"嗯，是的~","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592182648,"ip_address":"","comment_id":226572,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592144109","product_id":100029201,"comment_content":"iii. 更新 currentHW = max{currentHW, min（LEO-1, LEO-2, ……，LEO-n）}，是修改后的。那么表格中leader副本高水位更新时机的算法描述也需要改为max{HW,min(LEO-1……LEO-N)}吧？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498289,"discussion_content":"嗯，是的~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592182648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226025,"user_name":"石头","can_delete":false,"product_type":"c1","uid":1065776,"ip_address":"","ucode":"87921CA52689DC","user_header":"https://static001.geekbang.org/account/avatar/00/10/43/30/4c12618b.jpg","comment_is_top":false,"comment_ctime":1591930866,"is_pvip":false,"replies":[{"id":"83444","content":"1. 分区将一直不可用<br>2. 同上<br>3. 没有什么时间方面的设置","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592183795,"ip_address":"","comment_id":226025,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591930866","product_id":100029201,"comment_content":"老师好！<br>1）当A很长时间之后才回来<br>2）当A永远不回来呢<br>3）这个时间是怎么设置的<br>kafka是怎么处理的？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498083,"discussion_content":"1. 分区将一直不可用\n2. 同上\n3. 没有什么时间方面的设置","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592183795,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225865,"user_name":"耿嘉艺","can_delete":false,"product_type":"c1","uid":2023401,"ip_address":"","ucode":"727A22BD41E8AF","user_header":"","comment_is_top":false,"comment_ctime":1591877354,"is_pvip":false,"replies":[{"id":"83445","content":"此时A尚未宕机","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592183913,"ip_address":"","comment_id":225865,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591877354","product_id":100029201,"comment_content":"Leader epoch中，副本B向副本A请求的时候，副本A宕机，同样不是也没有返回吗？怎么还会返回2","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498021,"discussion_content":"此时A尚未宕机","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592183913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223121,"user_name":"店小二#2","can_delete":false,"product_type":"c1","uid":1130925,"ip_address":"","ucode":"6103E9AE52F8E7","user_header":"https://static001.geekbang.org/account/avatar/00/11/41/ad/4ccf4238.jpg","comment_is_top":false,"comment_ctime":1591005035,"is_pvip":false,"replies":[{"id":"82333","content":"问题1： 分区高水位值就可能超过 ISR 中副本 LEO是指某些瞬间，不是终态。根本上来说，一个副本的HW是不能越过LEO的<br>问题2：没太明白什么意思。什么叫同步瞬间？","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1591093817,"ip_address":"","comment_id":223121,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591005035","product_id":100029201,"comment_content":"老师讲解leader副本同步条件时，“此时，分区高水位值就可能超过 ISR 中副本 LEO，而高水位 &gt; LEO 的情形是不被允许的。”没明白。<br>同一个副本对象的约束是HW &gt; LEO。但描述中由分区高水位超过ISR中副本LEO，跳到 高水位 &gt; LEO。有些晕。希望老师详细描述描述一下。<br><br>另外对照下边三个Replica问一下，follower Replica1的LEO与leader Replica满足 replica.lag.time.max.ms&lt;=10，会不会出现同步瞬间，如果不会出现，原因是什么？谢谢！<br>leader Replica<br>0  1  2  3  4  5  6  7  8  9<br>                ↑      ↑<br>\t     HW    LEO<br>follower Replica0\t\t<br>0  1  2  3  4  5  6  7  8  9<br>            ↑      ↑\t<br>\t  HW   LEO<br>follower Replica1<br>0  1  2  3  4  5  6  7  8  9<br>    ↑       ↑\t  <br>   HW  LEO","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497017,"discussion_content":"问题1： 分区高水位值就可能超过 ISR 中副本 LEO是指某些瞬间，不是终态。根本上来说，一个副本的HW是不能越过LEO的\n问题2：没太明白什么意思。什么叫同步瞬间？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591093817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219581,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1590046893,"is_pvip":true,"replies":[{"id":"81190","content":"对， 当follower追上了leader的LEO时更新","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1590129053,"ip_address":"","comment_id":219581,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1590046893","product_id":100029201,"comment_content":"private def isFollowerOutOfSync(replicaId: Int,<br>                                  leaderEndOffset: Long,<br>                                  currentTimeMs: Long,<br>                                  maxLagMs: Long): Boolean = {<br>    val followerReplica = getReplicaOrException(replicaId)<br>    followerReplica.logEndOffset != leaderEndOffset &amp;&amp;<br>      (currentTimeMs - followerReplica.lastCaughtUpTimeMs) &gt; maxLagMs<br>  }<br>--------------------------------------------------------------&gt;<br>老师，followerReplica.lastCaughtUpTimeMs 这个值是不是只有在Follower Replica LEO = Leader LEO,才会重置为当前时间吧？ 比如Leader LEO = 10000, 第一次Follower发FetchRequest时F-LEO = 100, Leader会把当前请求时间赋值给followerReplica.lastCaughtUpTimeMs（T1 )， 第二次发FetchRequest时F-LE0 = 500, 在leader側，lastCaughtUpTimeMs依然还是（T1），只有当第N次， F-LEO == 10000, 才会再更新.lastCaughtUpTimeMs这个值吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495860,"discussion_content":"对， 当follower追上了leader的LEO时更新","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590129053,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217363,"user_name":"冷萃浮乐朵","can_delete":false,"product_type":"c1","uid":1134525,"ip_address":"","ucode":"5C3BCBD9E5973D","user_header":"https://static001.geekbang.org/account/avatar/00/11/4f/bd/e08af2e9.jpg","comment_is_top":false,"comment_ctime":1589470114,"is_pvip":false,"replies":[{"id":"80806","content":"如果leader LEO &lt; B的LEO，自然B需要做截断","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1589851005,"ip_address":"","comment_id":217363,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589470114","product_id":100029201,"comment_content":"有个疑问，“当获知到 Leader LEO=2 后，B 发现该 LEO 值不比它自己的 LEO 值小，而且缓存中也没有保存任何起始位移值 &gt; 2 的 Epoch 条目”，为什么在有起始位移值大于LEO的Eopch条目的情况下就截断日志呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495123,"discussion_content":"如果leader LEO &amp;lt; B的LEO，自然B需要做截断","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589851005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208575,"user_name":"空知","can_delete":false,"product_type":"c1","uid":1013283,"ip_address":"","ucode":"C448E98238DD36","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg","comment_is_top":false,"comment_ctime":1587385207,"is_pvip":false,"replies":[{"id":"77923","content":"follower同步之后才算是被成功提交","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1587386190,"ip_address":"","comment_id":208575,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587385207","product_id":100029201,"comment_content":"未提交的消息不能被消费,可以被follower同步嘛?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492519,"discussion_content":"follower同步之后才算是被成功提交","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587386190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":203361,"user_name":"aof","can_delete":false,"product_type":"c1","uid":1062864,"ip_address":"","ucode":"5815D63C4926BC","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","comment_is_top":false,"comment_ctime":1586179468,"is_pvip":false,"replies":[{"id":"76091","content":"写入消息就会抬升LEO值","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1586242869,"ip_address":"","comment_id":203361,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1586179468","product_id":100029201,"comment_content":"这个地方——&gt;处理生产者请求的逻辑如下：<br>...<br>iii. 更新 currentHW = max{currentHW, min（LEO-1, LEO-2, ……，LEO-n）}。<br><br>第三步中什么时候会出现LEO的值大于currentHW的情况？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490845,"discussion_content":"写入消息就会抬升LEO值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586242869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","nickname":"aof","note":"","ucode":"5815D63C4926BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":224331,"discussion_content":"老师回复的真快👍感谢，脑子突然转过来弯了😂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586277369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":197342,"user_name":"ryan007","can_delete":false,"product_type":"c1","uid":1046357,"ip_address":"","ucode":"7D28C589800CAE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f7/55/769bf4fb.jpg","comment_is_top":false,"comment_ctime":1585369666,"is_pvip":false,"replies":[{"id":"74837","content":"目前没有特别好的办法~","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1585533565,"ip_address":"","comment_id":197342,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585369666","product_id":100029201,"comment_content":"低版本的kafka 有没有办法规避高水位数据丢失的问题？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489500,"discussion_content":"目前没有特别好的办法~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585533565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":176219,"user_name":"Keep","can_delete":false,"product_type":"c1","uid":1178075,"ip_address":"","ucode":"ADFD481F03AB84","user_header":"https://static001.geekbang.org/account/avatar/00/11/f9/db/51457469.jpg","comment_is_top":false,"comment_ctime":1580992637,"is_pvip":false,"replies":[{"id":"68705","content":"因为是ISR中所有副本","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1581296128,"ip_address":"","comment_id":176219,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1580992637","product_id":100029201,"comment_content":"最后总结: 分区HW，就是上一轮follower拉取消息后，所有follower中最小的LEO。不知道对不对","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483051,"discussion_content":"因为是ISR中所有副本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581296128,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175706,"user_name":"What for","can_delete":false,"product_type":"c1","uid":1254381,"ip_address":"","ucode":"1308573CE047B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/ed/a4a774a8.jpg","comment_is_top":false,"comment_ctime":1580803181,"is_pvip":false,"replies":[{"id":"68338","content":"那么B副本将无法成为ISR","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1580864523,"ip_address":"","comment_id":175706,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1580803181","product_id":100029201,"comment_content":"老师您好！关于这一句<br>「Follower 副本 B 重启回来后，需要向 A 发送一个特殊的请求去获取 Leader 的 LEO 值」<br>如果在 B 重启的过程中 A 宕机了，B 获取不到 A 的 LEO 值该怎么办？<br>","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482862,"discussion_content":"那么B副本将无法成为ISR","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580864523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169996,"user_name":"the geek","can_delete":false,"product_type":"c1","uid":1506723,"ip_address":"","ucode":"71DECBC814A539","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLz3icr3mGs5ib8FbSPQZ2ic3ib90mHkd1btQrmGacZjJxfYXrerIdaTxglKyCicFzLcEAb6deC2cWjE5Q/132","comment_is_top":false,"comment_ctime":1578490528,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578490528","product_id":100029201,"comment_content":"高水位的概念让人觉得很模糊，根据1.高水位的值取决于最小的副本LEO值2.高水位之下的位移可以消费<br>这2点可以得出：说白了，高水位就是保证消费者能够消费的最大位移数据在每个副本中都同步保存了一份。（这样可以防止Leader变更带来的消费出错问题）","like_count":0},{"had_liked":false,"id":140176,"user_name":"谢特","can_delete":false,"product_type":"c1","uid":1248684,"ip_address":"","ucode":"9C30DBFECFE649","user_header":"https://static001.geekbang.org/account/avatar/00/13/0d/ac/09678490.jpg","comment_is_top":false,"comment_ctime":1570844415,"is_pvip":false,"replies":[{"id":"54225","content":"不会的，不论是你是否消费，消息都会保存在broker端一段时间的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1570869008,"ip_address":"","comment_id":140176,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1570844415","product_id":100029201,"comment_content":"老师，有个问题请教一下，就是最近在写kafka sink connect ，提供了rest api可以暂停消费，请问这样时间长的话，会导致消息堆积，broker会宕机吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470282,"discussion_content":"不会的，不论是你是否消费，消息都会保存在broker端一段时间的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570869008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140096,"user_name":"谢特","can_delete":false,"product_type":"c1","uid":1248684,"ip_address":"","ucode":"9C30DBFECFE649","user_header":"https://static001.geekbang.org/account/avatar/00/13/0d/ac/09678490.jpg","comment_is_top":false,"comment_ctime":1570806448,"is_pvip":false,"replies":[{"id":"54179","content":"嗯嗯，是的。不过是在内存中的对象，并不实际存在于leader副本所在broker的磁盘上","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1570840600,"ip_address":"","comment_id":140096,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1570806448","product_id":100029201,"comment_content":"远程副本指的是和leader副本在一个broker上的副本吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470244,"discussion_content":"嗯嗯，是的。不过是在内存中的对象，并不实际存在于leader副本所在broker的磁盘上","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570840600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":137305,"user_name":"benying","can_delete":false,"product_type":"c1","uid":1247522,"ip_address":"","ucode":"DEBAB485F381CC","user_header":"https://static001.geekbang.org/account/avatar/00/13/09/22/22c0c4fa.jpg","comment_is_top":false,"comment_ctime":1569683511,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1569683511","product_id":100029201,"comment_content":"没看懂leader epoch的作用","like_count":0},{"had_liked":false,"id":129857,"user_name":"被过去推开","can_delete":false,"product_type":"c1","uid":1276690,"ip_address":"","ucode":"8B4F34FE93FD5B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Cib5umA0W17N9pichI08pnrXAExdbyh7AVzH4nEhD6KN3FXuELk4LJJuqUPPD7xmIy9nq5Hjbgnzic7sVZG5BKiaUQ/132","comment_is_top":false,"comment_ctime":1567306279,"is_pvip":false,"replies":[{"id":"48511","content":"不会重复消费的，hw是在所有副本都越过了某个值之后才会前进到该值，但的确有可能造成各副本间不一致","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567386060,"ip_address":"","comment_id":129857,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567306279","product_id":100029201,"comment_content":"没有 epoch时，副本A所在Broker宕机，高水位退回到位移值为1，不是应该会发生重复消费嘛 ？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465681,"discussion_content":"不会重复消费的，hw是在所有副本都越过了某个值之后才会前进到该值，但的确有可能造成各副本间不一致","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567386060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129473,"user_name":"绿箭侠","can_delete":false,"product_type":"c1","uid":1528536,"ip_address":"","ucode":"B994F558A98E29","user_header":"https://static001.geekbang.org/account/avatar/00/17/52/d8/123a4981.jpg","comment_is_top":false,"comment_ctime":1567134430,"is_pvip":false,"replies":[{"id":"48311","content":"不会啊，如果所有follower的LEO都超过了某个值，hw就会前进到那个值，不会永远不更新的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567154840,"ip_address":"","comment_id":129473,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1567134430","product_id":100029201,"comment_content":"老师，文中讲的leader副本的两个更新时机都是使用currentHW = min(currentHW, LEO-1，LEO-n)方法去更新吗？这里有些困惑，第一种理解因为LEO-1,LEO-2会增加，但是在更新currentHW前currentHW是不变，那这个方法的结果是currentHW永远得不到更新？或者说是第二种理解，leader副本会在得到follow副本拉取消息请求后就将currentHW更新为远程副本LEO的最小值，然后在第一种更新时机中，即更新完leader副本LEO后试用上面那个方法更新currentHW？<br>针对这两种理解，请老师指正。<br>","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465490,"discussion_content":"不会啊，如果所有follower的LEO都超过了某个值，hw就会前进到那个值，不会永远不更新的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567154840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1528536,"avatar":"https://static001.geekbang.org/account/avatar/00/17/52/d8/123a4981.jpg","nickname":"绿箭侠","note":"","ucode":"B994F558A98E29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":13997,"discussion_content":"原来只是min和max的区别，编辑写错了！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568720009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125558,"user_name":"无菇朋友","can_delete":false,"product_type":"c1","uid":1035562,"ip_address":"","ucode":"80482C5F0464A3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cd/2a/bdbed6ed.jpg","comment_is_top":false,"comment_ctime":1566203959,"is_pvip":false,"replies":[{"id":"46089","content":"tcpdump可以抓一下，只是都是二进制的字节序列","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1566207823,"ip_address":"","comment_id":125558,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1566203959","product_id":100029201,"comment_content":"老师，文章里出现的请求怎么用抓包工具抓一下","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463607,"discussion_content":"tcpdump可以抓一下，只是都是二进制的字节序列","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566207823,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":123595,"user_name":"空知","can_delete":false,"product_type":"c1","uid":1013283,"ip_address":"","ucode":"C448E98238DD36","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg","comment_is_top":false,"comment_ctime":1565708636,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1565708636","product_id":100029201,"comment_content":"老师,请教下 如果 follower宕机起来之后 发现 leader的 LEO值  &gt; 2 或者 leader epoch的值 也比2大 会发生什么情况?<br> leader epoch的存在 只是为了证明 在follower宕机期间 leader有没有宕机吧,如果没有就说明leader数据是最准确的不需要截断,如果有呢?怎么去判断数据的准确性?","like_count":0,"discussions":[{"author":{"id":1197447,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","nickname":"😈😈😈😈😈","note":"","ucode":"A563EC007FEB7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38159,"discussion_content":"说下我的看法，出现这种情况的话，应该是在等待。但是会更新HW值为新Leader的HW值。直到新Leader可以同步数据过来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571738056,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":123549,"user_name":"What for","can_delete":false,"product_type":"c1","uid":1254381,"ip_address":"","ucode":"1308573CE047B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/ed/a4a774a8.jpg","comment_is_top":false,"comment_ctime":1565699752,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1565699752","product_id":100029201,"comment_content":"有几个问题请老师解惑<br>1. 远程副本中的 HW 值什么时候会更新？<br>2. Leader 副本将消息写入磁盘时尝试更新 Leader Epoch，那 follower 副本的 Leader Epoch 什么时候同步呢？是在 follower 拉取副本的时候么？","like_count":0,"discussions":[{"author":{"id":1197447,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","nickname":"😈😈😈😈😈","note":"","ucode":"A563EC007FEB7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38162,"discussion_content":"说下我的看法：\n第一个问题：HW是在Follower第二次进行拉取数据的时候更新的\n第二个问题：我也有点不太明白，感觉Follower不会同步Leader Epoch","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571738200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121225,"user_name":"A1","can_delete":false,"product_type":"c1","uid":1010873,"ip_address":"","ucode":"3886FEF9895299","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/b9/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1565080532,"is_pvip":false,"replies":[{"id":"44619","content":"不能去掉。currentHW和其他LEO一起参与比较","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1565138530,"ip_address":"","comment_id":121225,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1565080532","product_id":100029201,"comment_content":"Leader 副本<br>处理生产者请求的逻辑如下：<br>1. 写入消息到本地磁盘。<br>2. 更新分区高水位值。<br>i. 获取 Leader 副本所在 Broker 端保存的所有远程副本 LEO 值{LEO-1，LEO-2，……，LEO-n}。<br>ii. 获取 Leader 副本高水位值：currentHW。<br>iii. 更新 currentHW = min(currentHW, LEO-1，LEO-2，……，LEO-n)。<br><br>此处的公式iii是不是应该去掉min(currentHW, LEO-1，LEO-2，……，LEO-n)括号里面的currentHW？？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461691,"discussion_content":"不能去掉。currentHW和其他LEO一起参与比较","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565138530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120685,"user_name":"Geek_edc612","can_delete":false,"product_type":"c1","uid":1564943,"ip_address":"","ucode":"3E01DE3CE4BF3E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUJKviaecwxpAZCAnHWap86kXUichv5JwUoAtrUNy4ugC0kMMmssFDdyayKFgAoA9Z62sqMZaibbvUg/132","comment_is_top":false,"comment_ctime":1564973587,"is_pvip":false,"replies":[{"id":"44535","content":"老师的那篇博客内容有些瑕疵，我们以这次的分享内容为准。","user_name":"编辑回复","user_name_real":"孟朝阳","uid":"1576654","ctime":1565076409,"ip_address":"","comment_id":120685,"utype":2}],"discussion_count":2,"race_medal":0,"score":"1564973587","product_id":100029201,"comment_content":"leader 更新高水位感觉有点冲突，跟老师的另一篇文章<br>本文更新 currentHW = min(currentHW, ...LEOn1...LEOn2）<br><br>另一篇文章https:&#47;&#47;www.cnblogs.com&#47;huxi2b&#47;p&#47;7453543.html<br>有这样一句话：<br>--------------------------<br>尝试更新分区HW——此时leader LEO = 1，remote LEO = 0，故分区HW值= min(leader LEO, follower remote LEO) = 0<br>-----------------------------------------<br>说的是高水位的值是leo相比较得出的最小值，跟当前的hw没关系<br><br><br>","like_count":0,"discussions":[{"author":{"id":1576654,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0e/ce/9c96fa35.jpg","nickname":"客行","note":"","ucode":"FF508FF1346F1A","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461433,"discussion_content":"老师的那篇博客内容有些瑕疵，我们以这次的分享内容为准。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565076409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4041,"discussion_content":"那篇博客有一些瑕疵，有些地方还是不太准确，还是以今天的分享为主吧：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565076050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120481,"user_name":"monkay","can_delete":false,"product_type":"c1","uid":1066182,"ip_address":"","ucode":"07C0BB8A47799A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/pc41FOKAiabVaaKiawibEm7zglvnsYBnYeRiaSAElf9ciczovXmXmI0hOeR6U9RULFtMoqX5kobNttvwXCLsUM9Hbcg/132","comment_is_top":false,"comment_ctime":1564910402,"is_pvip":false,"replies":[{"id":"44240","content":"那要看分区还有其他副本吗，如果有，继续走后面的流程。如果没有，分区不可用了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564965622,"ip_address":"","comment_id":120481,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564910402","product_id":100029201,"comment_content":"关于epoch机制，也是就是文章的最后一个图，有副本B重启完需要向副本A发送一个特殊获取leader的leo值的步骤，如果副本B重启完向副本A发送特殊请求之前副本A就挂了，会是什么情况？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461353,"discussion_content":"那要看分区还有其他副本吗，如果有，继续走后面的流程。如果没有，分区不可用了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564965622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120368,"user_name":"Dovelol","can_delete":false,"product_type":"c1","uid":1253384,"ip_address":"","ucode":"9B5DDF7720F307","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","comment_is_top":false,"comment_ctime":1564844980,"is_pvip":false,"replies":[{"id":"44250","content":"各自有各自的拉取时点，没有规律。<br>HW的更新取的是所有副本LEO的最小值","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564965995,"ip_address":"","comment_id":120368,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564844980","product_id":100029201,"comment_content":"老师好，想问下hw到底是怎么判断的，假如分区有1个leader和3个follower，那这3个follower拉取leader数据的节奏是怎么样的，是每次都同时一起拉还是各拉各的频率，假如当前leader副本的hw是3，LEO是10，会不会出现第一个follower LEO是7的过来拉数据，然后根据min(10,7)把hw设置成7，但是下一个follower可能LEO是5过来拉数据，这样min(10,5) hw又变成了5，我觉得应该不是这样的，但在多个follower交替拉取leader数据的时候，HW的值究竟该怎么判断呢？？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461302,"discussion_content":"各自有各自的拉取时点，没有规律。\nHW的更新取的是所有副本LEO的最小值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564965995,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120366,"user_name":"Dovelol","can_delete":false,"product_type":"c1","uid":1253384,"ip_address":"","ucode":"9B5DDF7720F307","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","comment_is_top":false,"comment_ctime":1564844566,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564844566","product_id":100029201,"comment_content":"老师好，想问下hw到底是怎么判断的，假如分区有1个leader外加3个follower，那这些flower","like_count":0},{"had_liked":false,"id":120361,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564843752,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564843752","product_id":100029201,"comment_content":"发现老师以前一篇关于leo、epoch的文章，可以帮忙大家对比理解。<br>https:&#47;&#47;www.cnblogs.com&#47;huxi2b&#47;p&#47;7453543.html","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4040,"discussion_content":"那篇博客有一些瑕疵，有些地方还是不太准确，还是以今天的分享为主吧：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565076042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120352,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564840795,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564840795","product_id":100029201,"comment_content":"老师，follwer同步leader的时候，是只同步已提交的消息，还是未提交和提交都同步","like_count":0},{"had_liked":false,"id":120346,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564839277,"is_pvip":false,"replies":[{"id":"44253","content":"最后位移也可以通过下一个条目的起始位移计算得出","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564966102,"ip_address":"","comment_id":120346,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564839277","product_id":100029201,"comment_content":"老师，为什么取出对应的 Leader Epoch 的起始位移，以避免数据丢失和不一致的情况？<br><br>只取出开始的位移，但是我们不知道最后的位移的多少，这样是怎么判断的","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461294,"discussion_content":"最后位移也可以通过下一个条目的起始位移计算得出","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120195,"user_name":"球球","can_delete":false,"product_type":"c1","uid":1008759,"ip_address":"","ucode":"E5BD53B7E648D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/64/77/ce921ed4.jpg","comment_is_top":false,"comment_ctime":1564805535,"is_pvip":false,"replies":[{"id":"44260","content":"是的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564966371,"ip_address":"","comment_id":120195,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564805535","product_id":100029201,"comment_content":"胡老师，更新完远副本LEO中的最小值，才更新leader副本hw值，这个是否是所有远副本都有值才做更新呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461234,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966371,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120191,"user_name":"lmtoo","can_delete":false,"product_type":"c1","uid":1133918,"ip_address":"","ucode":"FCD5B9C941D448","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","comment_is_top":false,"comment_ctime":1564804927,"is_pvip":false,"replies":[{"id":"44261","content":"follower去发送特定请求获取的。时机就是重启回来时，因为只是做截断用的。另外offset表示该副本在leader时写入的第一个消息的offset，不是HW也不是LEO","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564966450,"ip_address":"","comment_id":120191,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1564804927","product_id":100029201,"comment_content":"Leader Epoch是怎么产生和传播到其他follower上的？传播的时机是怎样的？还有这个LeaderEpoch的offset表示的是HW还是LEO？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461231,"discussion_content":"follower去发送特定请求获取的。时机就是重启回来时，因为只是做截断用的。另外offset表示该副本在leader时写入的第一个消息的offset，不是HW也不是LEO","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1034204,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","nickname":"ban","note":"","ucode":"E523CE97E48266","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3836,"discussion_content":"Kafka Broker 会在内存中为每个分区都缓存 Leader Epoch 数据，同时它还会定期地将这些信息持久化到一个 checkpoint 文件中。当 Leader 副本写入消息到磁盘时，Broker 会尝试更新这部分缓存。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564848505,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1034204,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","nickname":"ban","note":"","ucode":"E523CE97E48266","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3832,"discussion_content":"应该是成功leader后第一次写入的offer值，跟HW和LEO没有关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564848305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120189,"user_name":"Jason_鹏","can_delete":false,"product_type":"c1","uid":1179329,"ip_address":"","ucode":"4A3DCAAC531724","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/c1/6c99fff4.jpg","comment_is_top":false,"comment_ctime":1564804827,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1564804827","product_id":100029201,"comment_content":"副本同步机制解析那有个问题，Follow分区在拉取offset为1的消息后，leader分区会更新远程副本的LEO为1并要更新高水位，按老师说的Leader 副本更新高水位的逻辑，是 currentHW = min(currentHW, LEO-1，LEO-2，……，LEO-n)，此时leader副本的currentHW为0，也即 currentHW = min(0,1)=0，高水位还是0呀，也不会变成1，我理解应该改成写 currentHW=min(currentLEO, LEO-1，LEO-2，……，LEO-n),currentLEO为leader分区当的LEO值","like_count":0,"discussions":[{"author":{"id":1085297,"avatar":"https://static001.geekbang.org/account/avatar/00/10/8f/71/29fb7bc2.jpg","nickname":"hgf","note":"","ucode":"A9649ECFDBD9E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3965,"discussion_content":"感觉应该是currentHW=min(leaderLEO, LEO-1，LEO-2，……，LEO-n)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565009452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1034204,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","nickname":"ban","note":"","ucode":"E523CE97E48266","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3833,"discussion_content":"我也觉得比较的是currentLEO，跟上图的表格讲的有点出入","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564848342,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120182,"user_name":"球球","can_delete":false,"product_type":"c1","uid":1008759,"ip_address":"","ucode":"E5BD53B7E648D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/64/77/ce921ed4.jpg","comment_is_top":false,"comment_ctime":1564804346,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564804346","product_id":100029201,"comment_content":"讲的真好，之前看书没看明白的现在都清楚了😀😀","like_count":0}]}