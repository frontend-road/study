{"id":622743,"title":"16ï½œè‡ªåŠ¨æ„å»ºï¼šå¦‚ä½•ä½¿ç”¨ GitHub Action æ„å»ºé•œåƒï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚</p><p>å‰é¢å‡ èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†å®¹å™¨åŒ–çš„æœ€ä½³å®è·µã€‚ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬ä¸€ç›´éƒ½åœ¨å­¦ä¹ ç¼–å†™ Dockerfile çš„æŠ€å·§ï¼Œä»¥åŠå¦‚ä½•æ„å»ºå‡ºæ›´é€‚åˆç”Ÿäº§ç¯å¢ƒçš„é•œåƒã€‚</p><p>åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™å®Œ Dockerfile ä¹‹åï¼Œä¼šåœ¨æœ¬åœ°é€šè¿‡ docker build å‘½ä»¤æ¥æ„å»ºé•œåƒï¼Œç„¶åæŠŠå®ƒæ¨é€åˆ° Docker Hub çš„é•œåƒä»“åº“ä¸­ã€‚ä¸è¿‡å®é™…ä¸Šï¼Œåœ¨å®Œæ•´çš„ GitOps çš„ç¯èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šç”¨è¿™ç§æ‰‹åŠ¨çš„æ–¹å¼æ¥æ„å»ºé•œåƒï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨å·¥å…·å®Œæˆè‡ªåŠ¨æ„å»ºã€‚</p><p>å¦‚æœä½ ç†Ÿæ‚‰ DevOps æµç¨‹ï¼Œä¼šçŸ¥é“åœ¨æäº¤ä»£ç ä¹‹åä¼šè§¦å‘ä¸€ä¸ªè‡ªåŠ¨åŒ–æµç¨‹ï¼Œ<strong>å®ƒå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ CI (Continuous integration)ï¼ŒæŒç»­é›†æˆ</strong>ã€‚æŒç»­é›†æˆä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬åšä¸€äº›ç¼–è¯‘ã€æ„å»ºã€æµ‹è¯•å’Œæ‰“åŒ…å·¥ä½œã€‚åœ¨å°†ä¸šåŠ¡è¿›è¡Œå®¹å™¨åŒ–æ”¹é€ ä¹‹åï¼Œæˆ‘ä»¬ä¼šæœ‰æ›´å¤šæ„å»º Docker é•œåƒçš„å·¥ä½œï¼Œæ‰€ä»¥ä¸ºäº†æé«˜æ•ˆç‡ï¼Œåœ¨ GitOps å·¥ä½œæµä¸­ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥åœ¨æŒç»­é›†æˆçš„é˜¶æ®µå®ç°è‡ªåŠ¨åŒ–çš„é•œåƒæ„å»ºã€‚</p><p>æ‰€ä»¥ï¼Œä»è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘å°†å¸¦ä½ å­¦ä¹  GitOps å·¥ä½œæµä¸­çš„ç¬¬ä¸€ä¸ªè‡ªåŠ¨åŒ–é˜¶æ®µï¼šè‡ªåŠ¨æ„å»ºé•œåƒã€‚</p><p>è¿™èŠ‚è¯¾æˆ‘ä¼šä»¥ K8s æç®€å®æˆ˜ä¸­çš„ç¤ºä¾‹åº”ç”¨ä¸ºä¾‹ï¼Œå¸¦ä½ ä»é›¶å¼€å§‹é…ç½® GitHub Action è‡ªåŠ¨æ„å»ºé•œåƒçš„å·¥ä½œæµï¼Œ<strong>å®ƒæ˜¯ç»„æˆ GitOps å·¥ä½œæµä¸­çš„é‡è¦çš„ä¸€ç¯</strong>ã€‚</p><!-- [[[read_end]]] --><h2>ä»€ä¹ˆæ˜¯ GitHub Actionï¼Ÿ</h2><p>åœ¨æ­£å¼ä½¿ç”¨ GitHub Action è‡ªåŠ¨æ„å»ºé•œåƒä¹‹å‰ï¼Œä½ éœ€è¦å…ˆäº†è§£ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬ç›´å…¥ä¸»é¢˜ï¼Œé‡ç‚¹ä»‹ç»è¿™èŠ‚è¯¾ä¼šæ¶‰åŠçš„æ¦‚å¿µå’Œç”¨æ³•ã€‚</p><p>ä¸ºäº†å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ GitHub Actionï¼Œæˆ‘ä¸ºä½ ç”»äº†ä¸€å¼ ç¤ºæ„å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6b/c7/6bb3d5a619a352c89be6356d1220edc7.jpg?wh=1863x1026\" alt=\"å›¾ç‰‡\"></p><p>è¿™å¼ å›¾ä¸­å‡ºç°äº†å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼šWorkflowã€Eventã€Job å’Œ Stepï¼Œæˆ‘ä»¬åˆ†å¼€æ¥è®²è§£ã€‚</p><h3>Workflow</h3><p>Workflow ä¹Ÿå«åšå·¥ä½œæµã€‚å…¶å®ï¼ŒGitHub Action æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ˜¯ä¸€ä¸ª CI/CD å·¥ä½œæµï¼Œè¦ä½¿ç”¨å·¥ä½œæµï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å…ˆå®šä¹‰å®ƒã€‚å’Œ K8s Manifest ä¸€æ ·ï¼ŒGitHub Action å·¥ä½œæµæ˜¯é€šè¿‡ YAML æ¥æè¿°çš„ï¼Œä½ å¯ä»¥åœ¨ä»»ä½• GitHub ä»“åº“åˆ›å»º .github/workflows ç›®å½•ï¼Œå¹¶åˆ›å»º YAML æ–‡ä»¶æ¥å®šä¹‰å·¥ä½œæµã€‚</p><p>æ‰€æœ‰åœ¨ .github/workflows ç›®å½•åˆ›å»ºçš„å·¥ä½œæµæ–‡ä»¶ï¼Œéƒ½å°†è¢« GitHub è‡ªåŠ¨æ‰«æã€‚åœ¨å·¥ä½œæµä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šè¿›ä¸€æ­¥å®šä¹‰ Eventã€Job å’Œ Step å­—æ®µï¼Œå®ƒä»¬è¢«ç”¨æ¥å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ—¶æœºå’Œå…·ä½“è¡Œä¸ºã€‚</p><h3>Event</h3><p>Event ä»å­—é¢ä¸Šçš„ç†è§£æ˜¯â€œäº‹ä»¶â€çš„æ„æ€ï¼Œä½ å¯ä»¥ç®€å•åœ°æŠŠå®ƒç†è§£ä¸ºå®šä¹‰äº†â€œä»€ä¹ˆæ—¶å€™è¿è¡Œå·¥ä½œæµâ€ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œæµçš„è§¦å‘å™¨ã€‚</p><p>åœ¨å®šä¹‰è‡ªåŠ¨åŒ–æ„å»ºé•œåƒçš„å·¥ä½œæµæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæŠŠ Event çš„è§¦å‘å™¨é…ç½®æˆâ€œå½“æŒ‡å®šåˆ†æ”¯æœ‰æ–°çš„æäº¤æ—¶ï¼Œè‡ªåŠ¨è§¦å‘é•œåƒæ„å»ºâ€ã€‚</p><h3>Jobs</h3><p>Jobs çš„å­—é¢æ„æ€æ˜¯ä¸€ä¸ªå…·ä½“çš„ä»»åŠ¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚åœ¨å·¥ä½œæµä¸­ï¼Œå®ƒå¹¶ä¸èƒ½ç›´æ¥å·¥ä½œï¼Œè€Œæ˜¯éœ€è¦é€šè¿‡ Step æ¥å®šä¹‰å…·ä½“çš„è¡Œä¸ºã€‚æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ä¸º Job å®šä¹‰å®ƒçš„è¿è¡Œçš„ç¯å¢ƒï¼Œä¾‹å¦‚ ubuntuã€‚</p><p>åœ¨ä¸€ä¸ª Workflow å½“ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰å¤šä¸ª Jobï¼Œå¤šä¸ª Job ä¹‹é—´å¯ä»¥å¹¶è¡Œè¿è¡Œï¼Œä¹Ÿå¯ä»¥å®šä¹‰ç›¸äº’ä¾èµ–å…³ç³»ã€‚åœ¨è‡ªåŠ¨æ„å»ºé•œåƒç¯èŠ‚ï¼Œé€šå¸¸æˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ª Job å°±å¤Ÿäº†ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢çš„ç¤ºæ„å›¾ä¸­ï¼Œæˆ‘åªç”»å‡ºäº†ä¸€ä¸ª Jobã€‚</p><h3>Step</h3><p>Step éš¶å±äº Jobsï¼Œå®ƒæ˜¯å·¥ä½œæµä¸­æœ€å°çš„ç²’åº¦ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ã€‚é€šå¸¸æ¥è¯´ï¼ŒStep çš„å…·ä½“è¡Œä¸ºæ˜¯æ‰§è¡Œä¸€æ®µ Shell æ¥å®Œæˆä¸€ä¸ªåŠŸèƒ½ã€‚åœ¨åŒä¸€ä¸ª Job é‡Œï¼Œä¸€èˆ¬æˆ‘ä»¬éœ€è¦å®šä¹‰å¤šä¸ª Step æ‰èƒ½å®Œæˆä¸€ä¸ªå®Œæ•´çš„ Jobï¼Œç”±äºå®ƒä»¬æ˜¯åœ¨åŒä¸€ä¸ªç¯å¢ƒä¸‹è¿è¡Œçš„ï¼Œæ‰€ä»¥å½“å®ƒä»¬è¿è¡Œæ—¶ï¼Œå°±ç­‰åŒäºåœ¨åŒä¸€å°è®¾å¤‡ä¸Šæ‰§è¡Œä¸€æ®µ Shellã€‚</p><p>ä»¥è‡ªåŠ¨æ„å»ºé•œåƒä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨ 1 ä¸ª Job ä¸­å®šä¹‰ 3 ä¸ª Stepã€‚</p><ul>\n<li>Step1ï¼Œå…‹éš†ä»“åº“çš„æºç ã€‚</li>\n<li>Step2ï¼Œè¿è¡Œ docker build æ¥æ„å»ºé•œåƒã€‚</li>\n<li>Step3ï¼Œæ¨é€åˆ°é•œåƒä»“åº“ã€‚</li>\n</ul><h3>è´¹ç”¨</h3><p>GitHub Action åœ¨ä½¿ç”¨ä¸Šè™½ç„¶å¾ˆæ–¹ä¾¿ï¼Œä½†å¤©ä¸‹å¹¶æ²¡æœ‰å…è´¹çš„åˆé¤ã€‚å¯¹äº GitHub å…è´¹è´¦æˆ·ï¼Œæ¯ä¸ªæœˆæœ‰ 2000 åˆ†é’Ÿçš„ GitHub Action æ—¶é•¿å¯ä¾›ä½¿ç”¨ï¼ˆLinux ç¯å¢ƒï¼‰ï¼Œè¶…å‡ºæ—¶é•¿åˆ™éœ€è¦æŒ‰é‡ä»˜è´¹ï¼Œä½ å¯ä»¥åœ¨<a href=\"https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#calculating-minute-and-storage-spending\">è¿™é‡Œ</a>æŸ¥çœ‹è¯¦ç»†çš„è®¡è´¹ç­–ç•¥ã€‚</p><h2>ä¸ºç¤ºä¾‹åº”ç”¨åˆ›å»º GitHub Action Workflow</h2><p>äº†è§£äº† GitHub Action çš„ç›¸å…³æ¦‚å¿µï¼Œ<strong>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¿›å…¥åˆ°å®æˆ˜ç¯èŠ‚äº†</strong>ã€‚</p><p>æˆ‘ä»¥ K8s æç®€å®æˆ˜æ¨¡å—çš„ç¤ºä¾‹åº”ç”¨ä¸ºä¾‹ï¼Œçœ‹çœ‹å¦‚ä½•é…ç½®è‡ªåŠ¨æ„å»ºç¤ºä¾‹åº”ç”¨çš„å‰åç«¯é•œåƒå·¥ä½œæµã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å·¥ä½œæµå°†å®ç°ä»¥ä¸‹è¿™äº›æ­¥éª¤ã€‚</p><ul>\n<li>å½“ main åˆ†æ”¯æœ‰æ–°çš„æäº¤æ—¶ï¼Œè§¦å‘å·¥ä½œæµã€‚</li>\n<li>å…‹éš†ä»£ç ã€‚</li>\n<li>åˆå§‹åŒ– Docker æ„å»ºå·¥å…·é“¾ã€‚</li>\n<li>ç™»å½• Docker Hubã€‚</li>\n<li>æ„å»ºå‰åç«¯åº”ç”¨é•œåƒï¼Œå¹¶ä½¿ç”¨ commit id ä½œä¸ºé•œåƒçš„ tagã€‚</li>\n<li>æ¨é€åˆ° Docker Hub é•œåƒä»“åº“ã€‚</li>\n</ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ä¸ºç¤ºä¾‹åº”ç”¨åˆ›å»ºå·¥ä½œæµã€‚</p><h3>åˆ›å»º build.yaml æ–‡ä»¶</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å°†ç¤ºä¾‹åº”ç”¨ä»“åº“å…‹éš†åˆ°æœ¬åœ°ã€‚</p><pre><code class=\"language-yaml\">$ git clone https://github.com/lyzhang1999/kubernetes-example.git\n</code></pre><p>è¿›å…¥ kubernetes-example ç›®å½•ã€‚</p><pre><code class=\"language-yaml\">$ cd kubernetes-example\n</code></pre><p>ç„¶åï¼Œåœ¨å½“å‰ç›®å½•ä¸‹æ–°å»º .github/workflows ç›®å½•ã€‚</p><pre><code class=\"language-yaml\">$ mkdir -p .github/workflows\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œå°†ä¸‹é¢çš„å†…å®¹ä¿å­˜åˆ° .github/workflows/build.yaml æ–‡ä»¶å†…ã€‚</p><pre><code class=\"language-yaml\">name: build\n\non:\n  push:\n    branches:\n      - 'main'\n\nenv:\n  DOCKERHUB_USERNAME: lyzhang1999\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v3\n      - name: Set outputs\n        id: vars\n        run: echo \"::set-output name=sha_short::$(git rev-parse --short HEAD)\"\n      - name: Set up QEMU\n        uses: docker/setup-qemu-action@v2\n      - name: Set up Docker Buildx\n        uses: docker/setup-buildx-action@v2\n      - name: Login to Docker Hub\n        uses: docker/login-action@v2\n        with:\n          username: ${{ env.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      - name: Build backend and push\n        uses: docker/build-push-action@v3\n        with:\n          context: backend\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}/backend:${{ steps.vars.outputs.sha_short }}\n      - name: Build frontend and push\n        uses: docker/build-push-action@v3\n        with:\n          context: frontend\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}/frontend:${{ steps.vars.outputs.sha_short }}\n</code></pre><p>è¯·æ³¨æ„ï¼Œ<strong>ä½ éœ€è¦å°†ä¸Šé¢çš„ env.DOCKERHUB_USERNAME ç¯å¢ƒå˜é‡æ›¿æ¢ä¸ºä½ çš„ Docker Hub ç”¨æˆ·å</strong>ã€‚</p><p>æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªå·¥ä½œæµã€‚</p><p>è¿™é‡Œçš„ name å­—æ®µæ˜¯å·¥ä½œæµçš„åç§°ï¼Œå®ƒä¼šå±•ç¤ºåœ¨ GitHub ç½‘é¡µä¸Šã€‚</p><p>on.push.branches å­—æ®µçš„å€¼ä¸º mainï¼Œè¿™ä»£è¡¨å½“ main åˆ†æ”¯æœ‰æ–°çš„æäº¤ä¹‹åï¼Œä¼šè§¦å‘å·¥ä½œæµã€‚</p><p>env.DOCKERHUB_USERNAME æ˜¯æˆ‘ä»¬ä¸º Job é…ç½®çš„å…¨å±€ç¯å¢ƒå˜é‡ï¼Œç”¨ä½œé•œåƒ Tag çš„å‰ç¼€ã€‚</p><p>jobs.docker å­—æ®µå®šä¹‰äº†ä¸€ä¸ªä»»åŠ¡ï¼Œå®ƒçš„è¿è¡Œç¯å¢ƒæ˜¯ ubuntu-latestï¼Œå¹¶ä¸”ç”± 7 ä¸ª Step ç»„æˆã€‚</p><p>jobs.docker.steps å­—æ®µå®šä¹‰äº† 7 ä¸ªå…·ä½“çš„æ‰§è¡Œé˜¶æ®µã€‚è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œuses å­—æ®µä»£è¡¨ä½¿ç”¨ GitHub Action çš„æŸä¸ªæ’ä»¶ï¼Œä¾‹å¦‚ actions/checkout@v3 æ’ä»¶ä¼šå¸®åŠ©æˆ‘ä»¬æ£€å‡ºä»£ç ã€‚</p><p>åœ¨è¿™ä¸ªå·¥ä½œæµä¸­ï¼Œè¿™ 7 ä¸ªé˜¶æ®µä¼šå…·ä½“æ‰§è¡Œä¸‹é¢å‡ ä»¶äº‹ã€‚</p><ol>\n<li>â€œCheckoutâ€é˜¶æ®µè´Ÿè´£å°†ä»£ç æ£€å‡ºåˆ°è¿è¡Œç¯å¢ƒã€‚</li>\n<li>â€œSet outputsâ€é˜¶æ®µä¼šè¾“å‡º sha_short ç¯å¢ƒå˜é‡ï¼Œå€¼ä¸º short commit idï¼Œè¿™å¯ä»¥æ–¹ä¾¿åœ¨åç»­é˜¶æ®µå¼•ç”¨ã€‚</li>\n<li>â€œSet up QEMUâ€å’Œâ€œSet up Docker Buildxâ€é˜¶æ®µè´Ÿè´£åˆå§‹åŒ– Docker æ„å»ºå·¥å…·é“¾ã€‚</li>\n<li>â€œLogin to Docker Hubâ€é˜¶æ®µé€šè¿‡ docker login æ¥ç™»å½•åˆ° Docker Hubï¼Œä»¥ä¾¿è·å¾—æ¨é€é•œåƒçš„æƒé™ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œwith å­—æ®µæ˜¯å‘æ’ä»¶ä¼ é€’å‚æ•°çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¼ é€’äº† username å’Œ passwordï¼Œå€¼çš„æ¥æºåˆ†åˆ«æ˜¯æˆ‘ä»¬å®šä¹‰çš„ç¯å¢ƒå˜é‡ DOCKERHUB_USERNAME å’Œ GitHub Action Secretï¼Œåè€…æˆ‘ä»¬è¿˜ä¼šåœ¨ç¨åè¿›è¡Œé…ç½®ã€‚</li>\n<li>â€œBuild backend and pushâ€å’Œâ€œBuild frontend and pushâ€é˜¶æ®µè´Ÿè´£æ„å»ºå‰åç«¯é•œåƒï¼Œå¹¶ä¸”å°†é•œåƒæ¨é€åˆ° Docker Hubï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œæˆ‘ä»¬ä¼ é€’äº† contextã€push å’Œ tags å‚æ•°ï¼Œcontext å’Œ tags å®é™…ä¸Šå°±æ˜¯ docker build çš„å‚æ•°ã€‚åœ¨ tags å‚æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¡¨è¾¾å¼ <code>${{ env.DOCKERHUB_USERNAME }}</code> å’Œ <code>${{ steps.vars.outputs.sha_short }}</code> åˆ†åˆ«è¯»å–äº† åœ¨ YAML ä¸­é¢„å®šä¹‰çš„ Docker Hub çš„ç”¨æˆ·åï¼Œä»¥åŠåœ¨â€œSet outputsâ€é˜¶æ®µè¾“å‡ºçš„ short commit idã€‚</li>\n</ol><h3>åˆ›å»º GitHub ä»“åº“å¹¶æ¨é€</h3><p>åˆ›å»ºå®Œ build.yaml æ–‡ä»¶åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦æŠŠç¤ºä¾‹åº”ç”¨æ¨é€åˆ° GitHub ä¸Šã€‚é¦–å…ˆï¼Œä½ éœ€è¦é€šè¿‡<a href=\"https://github.com/new\">è¿™ä¸ªé¡µé¢</a>æ¥ä¸ºè‡ªå·±åˆ›å»ºæ–°çš„ä»£ç ä»“åº“ï¼Œä»“åº“åè®¾ç½®ä¸º kubernetes-exampleã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d7/32/d7a01ee80ef7d4cyy58d6b04393d3632.png?wh=1590x1074\" alt=\"å›¾ç‰‡\"></p><p>åˆ›å»ºå®Œæˆåï¼Œå°†åˆšæ‰å…‹éš†çš„ kubernetes-example ä»“åº“çš„ remote url é…ç½®ä¸ºä½ åˆšæ‰åˆ›å»ºä»“åº“çš„ Git åœ°å€ã€‚</p><pre><code class=\"language-yaml\">$ git remote set-url origin YOUR_GIT_URL\n</code></pre><p>ç„¶åï¼Œå°† kubernetes-example æ¨é€åˆ°ä½ çš„ä»“åº“ã€‚åœ¨è¿™ä¹‹å‰ï¼Œä½ å¯èƒ½è¿˜éœ€è¦é…ç½® SSH Keyï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://docs.github.com/cn/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account\">è¿™ä¸ªé“¾æ¥</a>æ¥é…ç½®ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><pre><code class=\"language-yaml\">$ git add .\n$ git commit -a -m 'first commit'\n$ git branch -M main\n$ git push -u origin main\n</code></pre><h3>åˆ›å»º Docker Hub Secret</h3><p>åˆ›å»ºå®Œ build.yaml æ–‡ä»¶åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º Docker Hub Secretï¼Œå®ƒå°†ä¼šä¸ºå·¥ä½œæµæä¾›æ¨é€é•œåƒçš„æƒé™ã€‚</p><p>é¦–å…ˆï¼Œä½¿ç”¨ä½ æ³¨å†Œçš„è´¦å·å¯†ç ç™»å½• <a href=\"https://hub.docker.com/\">https://hub.docker.com/</a>ã€‚ç„¶åï¼Œç‚¹å‡»å³ä¸Šè§’çš„â€œç”¨æˆ·åâ€ï¼Œé€‰æ‹©â€œAccount Settingsâ€ï¼Œå¹¶è¿›å…¥å·¦ä¾§çš„â€œSecurityâ€èœå•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b7/16/b70fea1a316d6212c858eayyacb67316.png?wh=1920x879\" alt=\"å›¾ç‰‡\"></p><p>ä¸‹ä¸€æ­¥ç‚¹å‡»å³ä¾§çš„â€œNew Access Tokenâ€æŒ‰é’®ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Tokenã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a1/ba/a11f8af16b193fe8f194133d2634e5ba.png?wh=1472x1114\" alt=\"å›¾ç‰‡\"></p><p>è¾“å…¥æè¿°ï¼Œç„¶åç‚¹å‡»â€œGenarateâ€æŒ‰é’®ç”Ÿæˆ Tokenã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/dc/13/dc0d5c4a9bff3c49d81b3d4ab1a8f513.png?wh=1470x1146\" alt=\"å›¾ç‰‡\"></p><p>ç‚¹å‡»â€œCopy and Closeâ€å°† Token å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚<strong>è¯·æ³¨æ„ï¼Œå½“çª—å£å…³é—­åï¼ŒToken æ— æ³•å†æ¬¡æŸ¥çœ‹ï¼Œæ‰€ä»¥è¯·åœ¨å…¶ä»–åœ°æ–¹å…ˆä¿å­˜åˆšæ‰ç”Ÿæˆçš„ Tokenã€‚</strong></p><h3>åˆ›å»º GitHub Action Secret</h3><p>åˆ›å»ºå®Œ Docker Hub Token ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥åˆ›å»º GitHub Action Secret äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦ä¸º Workflow æä¾› secrets.DOCKERHUB_TOKEN å˜é‡å€¼ã€‚</p><p>è¿›å…¥ kubernetes-example ä»“åº“çš„ Settings é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§çš„â€œSecretsâ€ï¼Œè¿›å…¥â€œActionsâ€èœå•ï¼Œç„¶åç‚¹å‡»å³ä¾§â€œNew repository secretâ€åˆ›å»ºæ–°çš„ Secretã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/cy/f6/cyy66105ccd814e72bea4729322744f6.png?wh=1920x877\" alt=\"å›¾ç‰‡\"></p><p>åœ¨ Name è¾“å…¥æ¡†ä¸­è¾“å…¥ DOCKERHUB_TOKENï¼Œè¿™æ ·åœ¨ GitHub Action çš„ Step ä¸­ï¼Œ<strong>å°±å¯ä»¥é€šè¿‡ ${{ secrets.DOCKERHUB_TOKEN }} è¡¨è¾¾å¼æ¥è·å–å®ƒçš„å€¼</strong>ã€‚</p><p>åœ¨ Secret è¾“å…¥æ¡†ä¸­è¾“å…¥åˆšæ‰æˆ‘ä»¬å¤åˆ¶çš„ Docker Hub Tokenï¼Œç‚¹å‡»â€œAdd secretâ€åˆ›å»ºã€‚</p><h3>è§¦å‘ GitHub Action Workflow</h3><p>åˆ°è¿™é‡Œï¼Œå‡†å¤‡å·¥ä½œå·²ç»å…¨éƒ¨å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•è§¦å‘ GitHub Action å·¥ä½œæµã€‚è¿˜è®°å¾—æˆ‘ä»¬åœ¨å·¥ä½œæµé…ç½®çš„ on.push.branches å­—æ®µå—ï¼Ÿå®ƒçš„å€¼ä¸º mainï¼Œä»£è¡¨å½“æœ‰æ–°çš„æäº¤åˆ° main åˆ†æ”¯æ—¶è§¦å‘å·¥ä½œæµã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å‘ä»“åº“æäº¤ä¸€ä¸ªç©º commitã€‚</p><pre><code class=\"language-yaml\">$ git commit --allow-empty -m \"Trigger Build\"\n</code></pre><p>ç„¶åï¼Œä½¿ç”¨ git push æ¥æ¨é€åˆ°ä»“åº“ï¼Œ<strong>è¿™å°†è§¦å‘å·¥ä½œæµ</strong>ã€‚</p><pre><code class=\"language-yaml\">$ git push origin main\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œè¿›å…¥ kubernetes-example ä»“åº“çš„â€œActionsâ€é¡µé¢ï¼Œä½ å°†çœ‹åˆ°æˆ‘ä»¬åˆšæ‰è§¦å‘çš„å·¥ä½œæµã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/17/fc/17e36a14d86485585ed1e283fa22cffc.png?wh=1920x879\" alt=\"å›¾ç‰‡\"></p><p>ä½ å¯ä»¥ç‚¹å‡»å·¥ä½œæµçš„æ ‡é¢˜è¿›å…¥å·¥ä½œæµè¯¦æƒ…é¡µé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/74/ec/7401326152f418e6dc59182753yycdec.png?wh=1920x876\" alt=\"å›¾ç‰‡\"></p><p>åœ¨å·¥ä½œæµçš„è¯¦æƒ…é¡µé¢ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°å·¥ä½œæµçš„æ¯ä¸€ä¸ª Step çš„çŠ¶æ€åŠå…¶è¿è¡Œæ—¶è¾“å‡ºçš„æ—¥å¿—ã€‚</p><p>å½“å·¥ä½œæµè¿è¡Œå®Œæˆåï¼Œè¿›å…¥åˆ° Docker Hub frontend æˆ–è€… backend é•œåƒçš„è¯¦æƒ…é¡µï¼Œä½ å°†çœ‹åˆ°åˆšæ‰ GitHub Action è‡ªåŠ¨æ„å»ºå¹¶æ¨é€çš„æ–°ç‰ˆæœ¬é•œåƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e3/94/e3c7aa048fd003222bc2258d4d35f994.png?wh=1920x877\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¾¿å®Œæˆäº†ä½¿ç”¨ GitHub Action è‡ªåŠ¨æ„å»ºé•œåƒçš„å…¨è¿‡ç¨‹ã€‚æœ€ç»ˆå®ç°æ•ˆæœæ˜¯ï¼Œå½“æˆ‘ä»¬å‘ main åˆ†æ”¯æäº¤ä»£ç æ—¶ï¼ŒGitHub å·¥ä½œæµå°†è‡ªåŠ¨æ„å»º frontend å’Œ backend é•œåƒï¼Œ<strong>å¹¶ä¸”æ¯ä¸€ä¸ª commit id å¯¹åº”ä¸€ä¸ªé•œåƒç‰ˆæœ¬ã€‚</strong></p><h2>æ€»ç»“</h2><p>æ€»ç»“ä¸€ä¸‹ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä¸ºä½ ä»‹ç»äº†æ„æˆ GitOps å·¥ä½œæµçš„ç¬¬ä¸€ä¸ªè‡ªåŠ¨åŒ–é˜¶æ®µï¼šè‡ªåŠ¨åŒ–æ„å»ºé•œåƒã€‚ä¸ºäº†å®ç°è‡ªåŠ¨åŒ–æ„å»ºé•œåƒï¼Œæˆ‘ä»¬å­¦ä¹ äº† GitHub Action å·¥ä½œæµåŠå…¶åŸºæœ¬æ¦‚å¿µï¼Œä¾‹å¦‚ Workflowã€Eventã€Jobs å’Œ Stepsã€‚</p><p>åœ¨ä»‹ç» GitHub Action ç›¸å…³æ¦‚å¿µæ—¶ï¼Œæˆ‘æ•…æ„ç²¾ç®€äº†ä¸€éƒ¨åˆ†æ¦‚å¿µï¼Œæ¯”å¦‚ Runnerã€å¤šä¸ª Jobs ä»¥åŠ Jobs ç›¸äº’ä¾èµ–çš„æƒ…å†µã€‚åœ¨ç°é˜¶æ®µï¼Œæˆ‘ä»¬åªéœ€è¦æŒæ¡æœ€ç®€å•çš„è‡ªåŠ¨æ„å»ºé•œåƒçš„ YAML å†™æ³•ä»¥åŠç›¸å…³æ¦‚å¿µå°±è¶³å¤Ÿäº†ã€‚</p><p>åœ¨å®æˆ˜ç¯èŠ‚ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª build.yaml æ–‡ä»¶ç”¨æ¥å®šä¹‰ GitHub Action å·¥ä½œæµï¼Œæ€»ç»“æ¥è¯´ï¼Œå®ƒå®šä¹‰äº†å·¥ä½œæµçš„ï¼š</p><ol>\n<li>å·¥ä½œæµåç§°</li>\n<li>åœ¨ä»€ä¹ˆæ—¶å€™è§¦å‘</li>\n<li>åœ¨ä»€ä¹ˆç¯å¢ƒä¸‹è¿è¡Œ</li>\n<li>å…·ä½“æ‰§è¡Œçš„æ­¥éª¤æ˜¯ä»€ä¹ˆ</li>\n</ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆ›å»º build.yaml æ–‡ä»¶åï¼Œä½ éœ€è¦åˆ›å»ºè‡ªå·±çš„ä»“åº“ï¼Œå¹¶å°† kubernetes-example çš„å†…å®¹æ¨é€åˆ°ä½ çš„ä»“åº“ä¸­ï¼Œä»¥ä¾¿è¿›è¡Œè§¦å‘å·¥ä½œæµçš„å®éªŒã€‚å…¶æ¬¡ï¼Œä¸ºäº†ç»™ GitHub Action å·¥ä½œæµèµ‹äºˆé•œåƒä»“åº“çš„æ¨é€æƒé™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ Docker Hub ä¸­åˆ›å»º Tokenï¼Œå¹¶å°†å…¶é…ç½®åˆ°ä»“åº“çš„ Secrets ä¸­ã€‚åœ¨é…ç½®æ—¶ï¼Œéœ€è¦æ³¨æ„ Secret Name å’Œå·¥ä½œæµ Step ä¸­çš„ ${{ secrets.DOCKERHUB_TOKEN }} è¡¨è¾¾å¼ç›¸äº’å¯¹åº”ï¼Œä»¥ä¾¿å·¥ä½œæµèƒ½å¤Ÿè·å–åˆ°æ­£ç¡®çš„ Secretsã€‚</p><p>é…ç½®å®Œæˆåï¼Œå½“æˆ‘ä»¬å‘ Main åˆ†æ”¯æ¨é€æ–°çš„æäº¤æ—¶ï¼ŒGitHub Action å·¥ä½œæµå°†ä¼šè¢«è‡ªåŠ¨è§¦å‘ï¼Œå·¥ä½œæµä¼šè‡ªåŠ¨æ„å»º frontend å’Œ backend é•œåƒï¼Œå¹¶ä¸”ä¼šä½¿ç”¨å½“å‰çš„ short commit id ä½œä¸ºé•œåƒçš„ Tag æ¨é€åˆ° Docker Hub ä¸­ã€‚</p><p><strong>è¿™æ„å‘³ç€ï¼Œæ¯ä¸€ä¸ªæäº¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ª Docker é•œåƒï¼Œå®ç°äº†ä»£ç å’Œåˆ¶å“çš„å¯¹åº”å…³ç³»ã€‚</strong>è¿™ç§å¯¹åº”å…³ç³»ç»™æˆ‘ä»¬å¸¦æ¥äº†éå¸¸å¤§çš„å¥½å¤„ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬è¦å›æ»šæˆ–æ›´æ–°åº”ç”¨æ—¶ï¼Œåªéœ€è¦æ‰¾åˆ°ä»£ç çš„ commit id å°±èƒ½å¤Ÿæ‰¾åˆ°å¯¹åº”çš„é•œåƒç‰ˆæœ¬ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€é“ç®€å•çš„æ€è€ƒé¢˜å§ã€‚</p><p>docker/build-push-action æ’ä»¶è¿˜æœ‰å…¶ä»–çš„ä¸€äº›é«˜çº§é…ç½®ï¼Œè¯·ä½ ç»“åˆ docker/build-push-action@v3 <a href=\"https://github.com/docker/build-push-action/blob/master/docs/advanced/multi-platform.md\">æ’ä»¶æ–‡æ¡£</a>ï¼Œå°è¯•æ”¹é€  build.yamlï¼Œä½¿å…¶åŒæ—¶æ”¯æŒæ„å»º linux/amd64 å’Œ linux/arm64 ä¸¤ä¸ªå¹³å°çš„é•œåƒï¼Œå¹¶å’Œæˆ‘åˆ†äº«æ”¹åŠ¨ä¹‹åçš„ YAMLã€‚</p><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"15ï½œå®¹å™¨åŒ–ï¼šå¦‚ä½•é€‰æ‹©æœ€é€‚åˆä¸šåŠ¡çš„åŸºç¡€é•œåƒï¼Ÿ","id":622063},"right":{"article_title":"17ï½œè‡ªåŠ¨æ„å»ºï¼šå¦‚ä½•ä½¿ç”¨ GitLab CI æ„å»ºé•œåƒï¼Ÿ","id":623358}},"comments":[{"had_liked":false,"id":366288,"user_name":"GACÂ·DU","can_delete":false,"product_type":"c1","uid":1385403,"ip_address":"åŒ—äº¬","ucode":"7847FBE1C13740","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg","comment_is_top":false,"comment_ctime":1673562924,"is_pvip":false,"replies":[{"id":133465,"content":"æˆ‘ä»¬çš„å®è·µæ˜¯ç”Ÿäº§é•œåƒç”¨ä¸€ä¸ªç‰¹æ®Šçš„ prefix æ ‡è¯†ï¼Œæ¯”å¦‚ release-v1.0.0ï¼Œå…¶ä»–çš„ç”¨ commit id ä½œä¸º tagã€‚\n\nè¿™é‡Œå›ºå®šçš„è§„èŒƒï¼Œç»“åˆ CI å’Œè‡ªåŠ¨åŒ–ï¼Œé€‰æ‹©é€‚åˆå›¢é˜Ÿçš„å®è·µå°±å¯ä»¥äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1673575188,"ip_address":"å¹¿ä¸œ","comment_id":366288,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆï¼Œæ‚¨åœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œé•œåƒç‰ˆæœ¬æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Ÿæœ‰ç‰¹æ®Šçš„è§„èŒƒå—ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599511,"discussion_content":"æˆ‘ä»¬çš„å®è·µæ˜¯ç”Ÿäº§é•œåƒç”¨ä¸€ä¸ªç‰¹æ®Šçš„ prefix æ ‡è¯†ï¼Œæ¯”å¦‚ release-v1.0.0ï¼Œå…¶ä»–çš„ç”¨ commit id ä½œä¸º tagã€‚\n\nè¿™é‡Œå›ºå®šçš„è§„èŒƒï¼Œç»“åˆ CI å’Œè‡ªåŠ¨åŒ–ï¼Œé€‰æ‹©é€‚åˆå›¢é˜Ÿçš„å®è·µå°±å¯ä»¥äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366315,"user_name":"å†œæ°‘å›­ä¸","can_delete":false,"product_type":"c1","uid":1155913,"ip_address":"å†…è’™å¤","ucode":"6A91EBBC9DCE6C","user_header":"https://static001.geekbang.org/account/avatar/00/11/a3/49/4a488f4c.jpg","comment_is_top":false,"comment_ctime":1673577786,"is_pvip":false,"replies":[{"id":133480,"content":"æˆ‘çš„è¯¾ç¨‹æºç é‡Œæ„å»ºäº†ä¸¤ä¸ªå¹³å°çš„é•œåƒï¼Œä½ å¯ä»¥å°è¯•åˆ é™¤.github&#47;workflows&#47;build.yaml æ–‡ä»¶é‡Œå®šä¹‰çš„ platforms å­—æ®µï¼Œè¿™æ ·å°±åªä¼šæ„å»ºå•ä¸ªå¹³å°çš„é•œåƒäº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1673581268,"ip_address":"å¹¿ä¸œ","comment_id":366315,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è·Ÿç€è€å¸ˆçš„æ•™ç¨‹åšäº†å®éªŒï¼Œå‘ç°ç”Ÿæˆäº†2ä¸ªé•œåƒï¼Œåˆ†åˆ«æ˜¯linux&#47;amd64å’Œlinux&#47;arm64ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599551,"discussion_content":"æˆ‘çš„è¯¾ç¨‹æºç é‡Œæ„å»ºäº†ä¸¤ä¸ªå¹³å°çš„é•œåƒï¼Œä½ å¯ä»¥å°è¯•åˆ é™¤.github/workflows/build.yaml æ–‡ä»¶é‡Œå®šä¹‰çš„ platforms å­—æ®µï¼Œè¿™æ ·å°±åªä¼šæ„å»ºå•ä¸ªå¹³å°çš„é•œåƒäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673581268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366306,"user_name":"jeffery","can_delete":false,"product_type":"c1","uid":1219972,"ip_address":"é™•è¥¿","ucode":"35E2DAA386FB86","user_header":"https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg","comment_is_top":false,"comment_ctime":1673571448,"is_pvip":false,"replies":[{"id":133472,"content":"å›ç­”æ­£ç¡®ğŸ‘ğŸ»\n\nUSERNAME å¯ä»¥ä» env é‡Œè¯»å–ï¼Œä¹Ÿå¯ä»¥é…ç½® github secret è¯»å–ã€‚\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬æ˜¯ç”¨ env è¯»çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1673575859,"ip_address":"å¹¿ä¸œ","comment_id":366306,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"åº”è¯¥éœ€è¦è¿™ä¸ªplatforms: linux&#47;amd64,linux&#47;arm64ã€‚\nå®˜ç½‘åœ°å€ï¼šhttps:&#47;&#47;docs.docker.com&#47;build&#47;ci&#47;github-actions&#47;examples&#47;#multi-platform-images\nä¸çŸ¥é“è¿™å—...\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\næ˜¯ä¸æ˜¯å†™é”™äº†\nwith: \nusername: ${{ env.DOCKERHUB_USERNAME }} \npassword: ${{ secrets.DOCKERHUB_TOKEN }}\nname: ci\n\non:\n  push:\n    branches:\n      - &quot;main&quot;\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      -\n        name: Checkout\n        uses: actions&#47;checkout@v3\n      -\n        name: Set up QEMU\n        uses: docker&#47;setup-qemu-action@v2\n      -\n        name: Set up Docker Buildx\n        uses: docker&#47;setup-buildx-action@v2\n      -\n        name: Login to Docker Hub\n        uses: docker&#47;login-action@v2\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      -\n        name: Build and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: .\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: user&#47;app:latest\n","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599523,"discussion_content":"å›ç­”æ­£ç¡®ğŸ‘ğŸ»\n\nUSERNAME å¯ä»¥ä» env é‡Œè¯»å–ï¼Œä¹Ÿå¯ä»¥é…ç½® github secret è¯»å–ã€‚\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬æ˜¯ç”¨ env è¯»çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369476,"user_name":"dva","can_delete":false,"product_type":"c1","uid":2101988,"ip_address":"å¹¿ä¸œ","ucode":"EE27DAFCBF198D","user_header":"https://static001.geekbang.org/account/avatar/00/20/12/e4/57ade29a.jpg","comment_is_top":false,"comment_ctime":1677576249,"is_pvip":false,"replies":[{"id":134668,"content":"åœ¨é˜¶æ®µä¸­è¾“å‡º sha_short å˜é‡ï¼Œä»¥ä¾¿åœ¨åç»­é˜¶æ®µå¯ä»¥é€šè¿‡è¡¨è¾¾å¼ ${{ steps.vars.outputs.sha_short }} æ¥è·å–è¿™ä¸ªå€¼ã€‚\næ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ç”¨è¿™ä¸ªå†™æ³•æ¥åœ¨é˜¶æ®µä¸­è¾“å‡ºå€¼ï¼šhttps:&#47;&#47;docs.github.com&#47;en&#47;actions&#47;using-jobs&#47;defining-outputs-for-jobs","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1677638492,"ip_address":"å¹¿ä¸œ","comment_id":369476,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆä½ å¥½ï¼Œèƒ½è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªè¯­å¥æ˜¯ä»€ä¹ˆæ„æ€å—ï¼ŸåŒå†’å·æ˜¯ä»€ä¹ˆç‰¹æ®Šå†™æ³•ï¼Ÿ\nrun: echo &quot;::set-output name=sha_short::$(git rev-parse --short HEAD)&quot;","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607138,"discussion_content":"åœ¨é˜¶æ®µä¸­è¾“å‡º sha_short å˜é‡ï¼Œä»¥ä¾¿åœ¨åç»­é˜¶æ®µå¯ä»¥é€šè¿‡è¡¨è¾¾å¼ ${{ steps.vars.outputs.sha_short }} æ¥è·å–è¿™ä¸ªå€¼ã€‚\næ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ç”¨è¿™ä¸ªå†™æ³•æ¥åœ¨é˜¶æ®µä¸­è¾“å‡ºå€¼ï¼šhttps://docs.github.com/en/actions/using-jobs/defining-outputs-for-jobs","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677638492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1259323,"avatar":"https://static001.geekbang.org/account/avatar/00/13/37/3b/495e2ce6.jpg","nickname":"é™ˆæ–¯ä½³","note":"","ucode":"C236F874FC767A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":615848,"discussion_content":"è¿™ä¸ªå†™æ³•åœ¨2023å¹´6æœˆ1æ—¥ä¹‹åå°±ä¼šè¢«ç¦æ­¢äº†ï¼Œè¯¦æƒ…å‚è§https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1682474142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŠ æ‹¿å¤§","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367956,"user_name":"gyl1989113","can_delete":false,"product_type":"c1","uid":1363213,"ip_address":"å››å·","ucode":"B7F2860B3FB101","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","comment_is_top":false,"comment_ctime":1675764231,"is_pvip":false,"replies":[{"id":133986,"content":"æ˜¯çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675777401,"ip_address":"å¹¿ä¸œ","comment_id":367956,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"@v2 @v3æ˜¯å•¥æ„æ€å‘¢ã€‚ã€‚æ’ä»¶ç‰ˆæœ¬å˜›","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602487,"discussion_content":"æ˜¯çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675777402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366390,"user_name":"å¥•","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"å¹¿ä¸œ","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1673688888,"is_pvip":false,"replies":[{"id":133509,"content":"å¯ä»¥ç”¨ ${{ github.repositoryUrl }} è·å–ï¼Œå¦å¤–æ‰€æœ‰å¯ç”¨çš„å†…ç½®å˜é‡å¯ä»¥åœ¨è¿™ä¸ªæ–‡æ¡£é‡ŒæŸ¥è¯¢ï¼šhttps:&#47;&#47;docs.github.com&#47;en&#47;actions&#47;learn-github-actions&#47;contexts","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1673740632,"ip_address":"å¹¿ä¸œ","comment_id":366390,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æ€ä¹ˆè¯»å–  é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Ÿ ä½¿ç”¨ ${{env. GITHUB_REPOSITORY}} è¯»å–ä¸åˆ°","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599718,"discussion_content":"å¯ä»¥ç”¨ ${{ github.repositoryUrl }} è·å–ï¼Œå¦å¤–æ‰€æœ‰å¯ç”¨çš„å†…ç½®å˜é‡å¯ä»¥åœ¨è¿™ä¸ªæ–‡æ¡£é‡ŒæŸ¥è¯¢ï¼šhttps://docs.github.com/en/actions/learn-github-actions/contexts","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673740632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366292,"user_name":"æ— åæ— å§“","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"åŒ—äº¬","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1673568607,"is_pvip":false,"replies":[{"id":133469,"content":"Gitlab è‡ªåŠ¨æ„å»ºåœ¨ä¸‹ä¸€èŠ‚è¯¾ä¼šä»‹ç»å“¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1673575399,"ip_address":"å¹¿ä¸œ","comment_id":366292,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è¿™ä¸ªåœ¨gitlabä¸Šé¢å¯ä»¥ä½¿ç”¨ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599517,"discussion_content":"Gitlab è‡ªåŠ¨æ„å»ºåœ¨ä¸‹ä¸€èŠ‚è¯¾ä¼šä»‹ç»å“¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366287,"user_name":"GACÂ·DU","can_delete":false,"product_type":"c1","uid":1385403,"ip_address":"åŒ—äº¬","ucode":"7847FBE1C13740","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg","comment_is_top":false,"comment_ctime":1673562776,"is_pvip":false,"replies":[{"id":133473,"content":"å›ç­”æ­£ç¡®ï¼Œä¸¤ä¸ªé•œåƒéƒ½é…ç½®äº†ä¸åŒçš„å¹³å°ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1673575905,"ip_address":"å¹¿ä¸œ","comment_id":366287,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"\nname: build\n\non:\n  push:\n    branches:\n      - &#39;main&#39;\n\nenv:\n  DOCKERHUB_USERNAME: lyzhang1999\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions&#47;checkout@v3\n      - name: Set outputs\n        id: vars\n        run: echo &quot;::set-output name=sha_short::$(git rev-parse --short HEAD)&quot;\n      - name: Set up QEMU\n        uses: docker&#47;setup-qemu-action@v2\n      - name: Set up Docker Buildx\n        uses: docker&#47;setup-buildx-action@v2\n      - name: Login to Docker Hub\n        uses: docker&#47;login-action@v2\n        with:\n          username: ${{ env.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      - name: Build backend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: backend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;backend:${{ steps.vars.outputs.sha_short }}\n      - name: Build frontend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: frontend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;frontend:${{ steps.vars.outputs.sha_short }}","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":599524,"discussion_content":"å›ç­”æ­£ç¡®ï¼Œä¸¤ä¸ªé•œåƒéƒ½é…ç½®äº†ä¸åŒçš„å¹³å°ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1673575905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":392808,"user_name":"ã€‚","can_delete":false,"product_type":"c1","uid":1796130,"ip_address":"å¹¿ä¸œ","ucode":"AD9CD56391FB73","user_header":"https://static001.geekbang.org/account/avatar/00/1b/68/22/5762476a.jpg","comment_is_top":false,"comment_ctime":1721835843,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆä½ å¥½ï¼Œå¦‚æœå› ä¸ºdocker hub å›½å†…æ— æ³•è®¿é—®çš„ç½‘ç»œåŸå› å¯¼è‡´é•œåƒæ‹‰ä¸ä¸‹æ¥å¦‚ä½•å¤„ç†ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š\nPulling binfmt Docker image\n  &#47;usr&#47;local&#47;bin&#47;docker pull docker.io&#47;tonistiigi&#47;binfmt:latest\n  latest: Pulling from tonistiigi&#47;binfmt\n  8d4d64c318a5: Pulling fs layer\n  e9c608ddc3cb: Pulling fs layer\n  e9c608ddc3cb: Downloading\n  e9c608ddc3cb: Retrying in 5 seconds\n  8d4d64c318a5: Retrying in 5 seconds\n  e9c608ddc3cb: Retrying in 4 seconds\n  8d4d64c318a5: Retrying in 4 seconds\n  e9c608ddc3cb: Retrying in 3 seconds\n  8d4d64c318a5: Retrying in 3 seconds\n  8d4d64c318a5: Retrying in 2 seconds\n  e9c608ddc3cb: Retrying in 2 seconds\n  e9c608ddc3cb: Retrying in 1 second\n  8d4d64c318a5: Retrying in 1 second\n  8d4d64c318a5: Retrying in 10 seconds\n  e9c608ddc3cb: Retrying in 10 seconds\n  8d4d64c318a5: Retrying in 9 seconds\n  e9c608ddc3cb: Retrying in 9 seconds\n  8d4d64c318a5: Retrying in 8 seconds\n  e9c608ddc3cb: Retrying in 8 seconds\n  8d4d64c318a5: Retrying in 7 seconds\n  e9c608ddc3cb: Retrying in 7 seconds\n  8d4d64c318a5: Retrying in 6 seconds\n  e9c608ddc3cb: Retrying in 6 seconds\n  8d4d64c318a5: Retrying in 5 seconds\n  e9c608ddc3cb: Retrying in 5 seconds\n  8d4d64c318a5: Retrying in 4 seconds\n  e9c608ddc3cb: Retrying in 4 seconds\n  8d4d64c318a5: Retrying in 3 seconds\n  e9c608ddc3cb: Retrying in 3 seconds\n  8d4d64c318a5: Retrying in 2 seconds\n  e9c608ddc3cb: Retrying in 2 seconds\n  8d4d64c318a5: Retrying in 1 second\n  e9c608ddc3cb: Retrying in 1 second\n  error pulling image configuration: download failed after attempts=6: net&#47;http: TLS handshake timeout","like_count":0},{"had_liked":false,"id":388549,"user_name":"å“ˆå°”","can_delete":false,"product_type":"c1","uid":1939451,"ip_address":"ä¸­å›½é¦™æ¸¯","ucode":"1D074B5FD74AC7","user_header":"https://static001.geekbang.org/account/avatar/00/1d/97/fb/9607bdda.jpg","comment_is_top":false,"comment_ctime":1710383679,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"name: build\n\non:\n  push:\n    branches:\n      - &#39;main&#39;\n\nenv:\n  DOCKERHUB_USERNAME: lyzhang1999\n\njobs:\n  docker:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions&#47;checkout@v3\n      - name: Set outputs\n        id: vars\n        run: echo &quot;::set-output name=sha_short::$(git rev-parse --short HEAD)&quot;\n      - name: Set up QEMU\n        uses: docker&#47;setup-qemu-action@v2\n      - name: Set up Docker Buildx\n        uses: docker&#47;setup-buildx-action@v2\n      - name: Login to Docker Hub\n        uses: docker&#47;login-action@v2\n        with:\n          username: ${{ env.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      - name: Build backend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: backend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;backend:${{ steps.vars.outputs.sha_short }}\n      - name: Build frontend and push\n        uses: docker&#47;build-push-action@v3\n        with:\n          context: frontend\n          platforms: linux&#47;amd64,linux&#47;arm64\n          push: true\n          tags: ${{ env.DOCKERHUB_USERNAME }}&#47;frontend:${{ steps.vars.outputs.sha_short }}","like_count":0},{"had_liked":false,"id":382518,"user_name":"BertGeek","can_delete":false,"product_type":"c1","uid":1452799,"ip_address":"é™•è¥¿","ucode":"8E1D72C9F9778C","user_header":"https://static001.geekbang.org/account/avatar/00/16/2a/ff/a9d72102.jpg","comment_is_top":false,"comment_ctime":1697514618,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"github action è‡ªåŠ¨åŒ–å°±æ˜¯æ–¹ä¾¿ï¼Œä½†æ„å»ºé•œåƒæ…¢ï¼Œå°é¡¹ç›®è¿˜å¥½ï¼Œ\nå¤§é¡¹ç›®ï¼Œä»“åº“å¤šï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿè´¹åŠ²","like_count":0}]}