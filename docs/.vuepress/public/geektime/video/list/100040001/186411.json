{"id":186411,"title":"31 | MongoDB安全架构","content":"<p><strong>亲爱的学员：</strong><br>\n你好，在回答学员问题的过程中，我发现大家对于第二章的事务处理, 特别是隔离级别，以及第三章的分片集群有相对较多的问题。在这里我给大家推荐一些补充的学习材料可以从另外一个角度来加深一些这些概念的理解。<br>\nMongoDB事务的原子性<br>\n<a href=\"https://docs.mongodb.com/manual/core/write-operations-atomicity/\">https://docs.mongodb.com/manual/core/write-operations-atomicity/</a><br>\nMongoDB事务的隔离级别和一致性模型<br>\n<a href=\"https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/\">https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/</a><br>\n如果英文不太感冒，在MongoDB中文网站上有不少内容，比如分片相关的：<br>\n<a href=\"http://www.mongoing.com/?s=%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4\">http://www.mongoing.com/?s=分片集群</a></p><p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":205100,"user_name":"李英权","can_delete":false,"product_type":"c3","uid":1076081,"ip_address":"","ucode":"FECAC14A9C414B","user_header":"https://static001.geekbang.org/account/avatar/00/10/6b/71/e833b14a.jpg","comment_is_top":false,"comment_ctime":1586528675,"is_pvip":false,"replies":[{"id":77495,"content":"创建一个用户，指定ip白名单，然后给这个用户指定的权限。不完全是你i想要的，但是应该可以满足业务场景了吧。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1587097437,"ip_address":"","comment_id":205100,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"请问，mongodb能实现根据客户端IP 限制其只能读写某个数据库的权限吗？","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491388,"discussion_content":"创建一个用户，指定ip白名单，然后给这个用户指定的权限。不完全是你i想要的，但是应该可以满足业务场景了吧。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587097437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174226,"user_name":"月迷津渡","can_delete":false,"product_type":"c3","uid":1264111,"ip_address":"","ucode":"2B18B2FE3DAC3B","user_header":"https://static001.geekbang.org/account/avatar/00/13/49/ef/02401473.jpg","comment_is_top":false,"comment_ctime":1580099175,"is_pvip":false,"replies":[{"id":67800,"content":"问题不太清晰。\n\nmongodb启动参数中的logpath指的是mongo系统日志文件路径， 相当于mongodb配置文件中的systemLog.path \n\n\n你可以配置MongoDB写日志到以下目的地：\n1） 本地文件 （命令行参数--logpath，或者配置文件 systemLog.path)\n2)   syslog （命令行参数 --syslog，或者配置文件内的systemLog.syslog)\n3)   标准输出（不用任何参数，默认）\n\n\n参见： https:&#47;&#47;docs.mongodb.com&#47;manual&#47;reference&#47;configuration-options&#47;#systemLog.path","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580253701,"ip_address":"","comment_id":174226,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"syslog 是不是就是mongod 启动的 logpath日志？","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482337,"discussion_content":"问题不太清晰。\n\nmongodb启动参数中的logpath指的是mongo系统日志文件路径， 相当于mongodb配置文件中的systemLog.path \n\n\n你可以配置MongoDB写日志到以下目的地：\n1） 本地文件 （命令行参数--logpath，或者配置文件 systemLog.path)\n2)   syslog （命令行参数 --syslog，或者配置文件内的systemLog.syslog)\n3)   标准输出（不用任何参数，默认）\n\n\n参见： https://docs.mongodb.com/manual/reference/configuration-options/#systemLog.path","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580253701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":179463,"user_name":"hello","can_delete":false,"product_type":"c3","uid":1464199,"ip_address":"","ucode":"854500026E2187","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132","comment_is_top":false,"comment_ctime":1582010049,"is_pvip":false,"replies":[{"id":70059,"content":"1) 索引机制基本不会受影响，因为索引表里存的是密文，你的查询字段会先加密采取索引表匹配，所以是密文匹配密文，一样的机制。有一个例外就是正则表达式的前缀搜索就用不上索引了。   类似于这种查询： { name: &#47;^张&#47; } \n2) 分区字段不建议使用这个功能","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1582338015,"ip_address":"","comment_id":179463,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，请教个问题，针对字段加密，那这种会不会对性能造成影响，比如该字段是个索引字段，按字段加密其实是段密文存储在数据库里面，那原先的索引机制还能一样吗？如果是分区字段，分区字段加密后还能一样吗？","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484268,"discussion_content":"1) 索引机制基本不会受影响，因为索引表里存的是密文，你的查询字段会先加密采取索引表匹配，所以是密文匹配密文，一样的机制。有一个例外就是正则表达式的前缀搜索就用不上索引了。   类似于这种查询： { name: /^张/ } \n2) 分区字段不建议使用这个功能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582338015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239628,"user_name":"Geek_7f0514","can_delete":false,"product_type":"c3","uid":1204498,"ip_address":"","ucode":"5F39443023769A","user_header":"","comment_is_top":false,"comment_ctime":1596599705,"is_pvip":false,"replies":[{"id":88701,"content":"config 集群","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1596804786,"ip_address":"","comment_id":239628,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师 你好，分片的集群通过mongos连接建立的用户是保存在哪里，config集群上面还是每个shard里面也保存？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503168,"discussion_content":"config 集群","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596804786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172993,"user_name":"bb","can_delete":false,"product_type":"c3","uid":1770466,"ip_address":"","ucode":"9E480BA11D4D89","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4fPb1ic9W9IHrz4fxE9t2y9BqRxdibllS5pQfnNiabvib7kc6Ql7YJnVh2PPzxrpXqN3eMsCyvoZrxfw/132","comment_is_top":false,"comment_ctime":1579404139,"is_pvip":false,"replies":[{"id":67151,"content":"1）可以用 it 命令显示更多行\n2)  用 shellBatchSize 配置修改一次显示的行数\n\n\n\n&gt; DBQuery.shellBatchSize = 5;\n5\n&gt; db.test.find()\n{ &quot;_id&quot; : ObjectId(&quot;5e24f106b654ecda1fb72ce4&quot;) }\n{ &quot;_id&quot; : ObjectId(&quot;5e24f106b654ecda1fb72ce5&quot;) }\n{ &quot;_id&quot; : ObjectId(&quot;5e24f106b654ecda1fb72ce6&quot;) }\n{ &quot;_id&quot; : ObjectId(&quot;5e24f106b654ecda1fb72ce7&quot;) }\n{ &quot;_id&quot; : ObjectId(&quot;5e24f108b654ecda1fb72ce8&quot;) }\nType &quot;it&quot; for more\n&gt; \n","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579479415,"ip_address":"","comment_id":172993,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，请问我在操作MongoDB查询数据的时候，数据不能全部显示出，只能显示一部分。MongoDB4.2，在shell和图形工具也是这样的。这个有在那里设置吗","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481924,"discussion_content":"1）可以用 it 命令显示更多行\n2)  用 shellBatchSize 配置修改一次显示的行数\n\n\n\n&amp;gt; DBQuery.shellBatchSize = 5;\n5\n&amp;gt; db.test.find()\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5e24f106b654ecda1fb72ce4&amp;quot;) }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5e24f106b654ecda1fb72ce5&amp;quot;) }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5e24f106b654ecda1fb72ce6&amp;quot;) }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5e24f106b654ecda1fb72ce7&amp;quot;) }\n{ &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5e24f108b654ecda1fb72ce8&amp;quot;) }\nType &amp;quot;it&amp;quot; for more\n&amp;gt; \n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579479415,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356288,"user_name":"风","can_delete":false,"product_type":"c3","uid":1670309,"ip_address":"广东","ucode":"E13FD91633CE0B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKiaPl8VlycfEnmrs5TDJGcZt1rayThs1o9kI4JARbf7Yib5bvJqnDK1Jrkib3KuaE2d1Ed3O9kB3Cug/132","comment_is_top":false,"comment_ctime":1662110567,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"filekey 在什么位置配置啊，百度都是等于号版本，不是冒号的版本，启动不起来配置文件了。","like_count":0},{"had_liked":false,"id":286955,"user_name":"Allen","can_delete":false,"product_type":"c3","uid":1702456,"ip_address":"","ucode":"52244649DB4B49","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83erEcILdkG2yhkBom9WRP7nSeP89NTyJXXY2vkTP7YkogVLKHYwkfY3dJqBYLgPpWY5B5Lb05qUaGg/132","comment_is_top":false,"comment_ctime":1617699583,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"听了之后对字段级加密感兴趣，跑了官方的例子https:&#47;&#47;pkg.go.dev&#47;go.mongodb.org&#47;mongo-driver&#47;mongo#hdr-Client_Side_Encryption。 但是如何对加密的字段进行检索呢？比如对名字进行加密，但是想检索某个姓的所有名字该怎么做呢？把查询条件也加密吗？","like_count":0},{"had_liked":false,"id":210400,"user_name":"姚俊","can_delete":false,"product_type":"c3","uid":1222291,"ip_address":"","ucode":"99D85FDD2D8D1D","user_header":"https://static001.geekbang.org/account/avatar/00/12/a6/93/4aec31b5.jpg","comment_is_top":false,"comment_ctime":1587738076,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，我不确定我的分片集群恢复是否正常，恢复我3个分片平均分布在3个物理机上，2.24G的数据花费了35分钟，不知道这样的速度是否正常，目前没有排查到具体问题，如果不知道是否能够一些排查思路\nmongod --bind_ip 0.0.0.0 --replSet shard3 --dbpath &#47;data&#47;shard3 --logpath &#47;data&#47;shard3&#47;mongod.log --port 27012 --fork --shardsvr --wiredTigerCacheSizeGB 10\n\n恢复数据的命令\nmongorestore --host 192.168.1.154:27017 -d v3_app_data_parsed -c products dump&#47;v3_app_data_parsed&#47;products.bson \n\n\n\n2020-04-24T22:10:04.328+0800 I  COMMAND  [conn5965] command v3_app_data_parsed.products appName: &quot;mongorestore&quot; command: insert { insert: &quot;products&quot;, bypassDocumentValidation: false, ordered: false, documents: 357, shardVersion: [ Timestamp(1, 1), ObjectId(&#39;5e9d68726c33d461a9c9c628&#39;) ], writeConcern: { w: &quot;majority&quot; }, allowImplicitCollectionCreation: false, lsid: { id: UUID(&quot;90b6351d-b870-4fc7-8911-7059fecae22b&quot;), uid: BinData(0, E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855) }, $clusterTime: { clusterTime: Timestamp(1587737420, 1933), signature: { hash: BinData(0, 263167E9F9922575EE1B6566505BD059DECD1D4A), keyId: 6816941335950393361 } }, $client: { driver: { name: &quot;mongo-go-driver&quot;, version: &quot;v1.2.1&quot; }, os: { type: &quot;linux&quot;, architecture: &quot;amd64&quot; }, platform: &quot;go1.12.17&quot;, application: { name: &quot;mongorestore&quot; }, mongos: { host: &quot;localhost.localdomain:27017&quot;, client: &quot;192.168.1.200:49952&quot;, version: &quot;4.2.5&quot; } }, $configServerState: { opTime: { ts: Timestamp(1587737417, 1680), t: 1 } }, $db: &quot;v3_app_data_parsed&quot; } ninserted:357 keysInserted:714 numYields:0 reslen:400 locks:{ ParallelBatchWriterMode: { acquireCount: { r: 6 } }, ReplicationStateTransition: { acquireCount: { w: 6 } }, Global: { acquireCount: { w: 6 } }, Database: { acquireCount: { w: 6 } }, Collection: { acquireCount: { w: 6 } }, Mutex: { acquireCount: { r: 726 } } } flowControl:{ acquireCount: 6, timeAcquiringMicros: 4 } storage:{} protocol:op_msg 319ms\n","like_count":0},{"had_liked":false,"id":194969,"user_name":"追忆似水年华","can_delete":false,"product_type":"c3","uid":1160192,"ip_address":"","ucode":"C1D7C0DD7E7411","user_header":"https://static001.geekbang.org/account/avatar/00/11/b4/00/661fb98d.jpg","comment_is_top":false,"comment_ctime":1585125001,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"MongoDB自带字段级加密，倒是省了我们开发的事了，哈哈~","like_count":0}]}