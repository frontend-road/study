{"id":455412,"title":"39ï½œå¼‚æ­¥å¤„ç†ï¼šasync/awaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>å­¦å®Œä¸Šä¸€è®²ï¼Œæˆ‘ä»¬å¯¹ Future å’Œ async/await çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£äº†ï¼ŒçŸ¥é“åœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¯¥ä½¿ç”¨ Futureã€ä»€ä¹ˆæƒ…å†µä¸‹è¯¥ä½¿ç”¨ Threadï¼Œä»¥åŠ executor å’Œ reactor æ˜¯æ€ä¹ˆè”åŠ¨æœ€ç»ˆè®© Future å¾—åˆ°äº†ä¸€ä¸ªç»“æœã€‚</p><p>ç„¶è€Œï¼Œæˆ‘ä»¬å¹¶ä¸æ¸…æ¥šä¸ºä»€ä¹ˆ async fn æˆ–è€… async block å°±èƒ½å¤Ÿäº§ç”Ÿ Futureï¼Œä¹Ÿå¹¶ä¸æ˜ç™½ Future æ˜¯æ€ä¹ˆè¢« executor å¤„ç†çš„ã€‚ä»Šå¤©æˆ‘ä»¬å°±ç»§ç»­æ·±å…¥ä¸‹å»ï¼Œçœ‹çœ‹ async/await è¿™ä¸¤ä¸ªå…³é”®è¯ç©¶ç«Ÿæ–½äº†ä»€ä¹ˆæ ·çš„é­”æ³•ï¼Œèƒ½å¤Ÿè®©ä¸€åˆ‡å¦‚æ­¤ç®€å•åˆå¦‚æ­¤è‡ªç„¶åœ°è¿è½¬èµ·æ¥ã€‚</p><p>æå‰è¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¼šç»§ç»­å›´ç»•ç€ Future è¿™ä¸ªç®€çº¦å´åˆå¹¶ä¸ç®€å•çš„æ¥å£ï¼Œæ¥æ¢è®¨ä¸€äº›åŸç†æ€§çš„ä¸œè¥¿ï¼Œä¸»è¦æ˜¯ Context å’Œ Pinè¿™ä¸¤ä¸ªç»“æ„ï¼š</p><pre><code class=\"language-rust\">pub trait Future {\n    type Output;\n    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;\n}\n</code></pre><p>è¿™å ‚è¯¾çš„å†…å®¹å³ä¾¿æ²¡æœ‰å®Œå…¨å¼„æ‡‚ï¼Œä¹Ÿå¹¶ä¸å½±å“ä½ ä½¿ç”¨ async/awaitã€‚å¦‚æœç²¾åŠ›æœ‰é™ï¼Œä½ å¯ä»¥ä¸ç”¨ç†è§£æ‰€æœ‰ç»†èŠ‚ï¼Œåªè¦æŠ“ä½è¿™äº›é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠè§£å†³æ–¹æ¡ˆçš„æ€è·¯å³å¯ã€‚</p><h2>Waker çš„è°ƒç”¨æœºåˆ¶</h2><!-- [[[read_end]]] --><p>å…ˆæ¥çœ‹è¿™ä¸ªæ¥å£çš„ Context æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚</p><p>ä¸ŠèŠ‚è¯¾æˆ‘ä»¬ç®€å•è®²è¿‡ executor é€šè¿‡è°ƒç”¨ poll æ–¹æ³•æ¥è®© Future ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚æœ poll æ–¹æ³•è¿”å› Poll::Pendingï¼Œå°±é˜»å¡ Futureï¼Œç›´åˆ° reactor æ”¶åˆ°äº†æŸä¸ªäº‹ä»¶ï¼Œç„¶åè°ƒç”¨ Waker.wake() æŠŠ Future å”¤é†’ã€‚è¿™ä¸ª Waker æ˜¯å“ªæ¥çš„å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œå®ƒéšå«åœ¨ Context ä¸­ï¼š</p><pre><code class=\"language-rust\">pub struct Context&lt;'a&gt; {\n    waker: &amp;'a Waker,\n    _marker: PhantomData&lt;fn(&amp;'a ()) -&gt; &amp;'a ()&gt;,\n}\n</code></pre><p>æ‰€ä»¥ï¼ŒContext å°±æ˜¯ Waker çš„ä¸€ä¸ªå°è£…ã€‚</p><p>å¦‚æœä½ å»çœ‹ Waker çš„å®šä¹‰å’Œç›¸å…³çš„ä»£ç ï¼Œä¼šå‘ç°å®ƒéå¸¸æŠ½è±¡ï¼Œå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª vtable æ¥å…è®¸å„ç§å„æ ·çš„ waker çš„è¡Œä¸ºï¼š</p><pre><code class=\"language-rust\">pub struct RawWakerVTable {\n    clone: unsafe fn(*const ()) -&gt; RawWaker,\n    wake: unsafe fn(*const ()),\n    wake_by_ref: unsafe fn(*const ()),\n    drop: unsafe fn(*const ()),\n}\n</code></pre><p>è¿™ç§æ‰‹å·¥ç”Ÿæˆ vtable çš„åšæ³•ï¼Œæˆ‘ä»¬<a href=\"https://time.geekbang.org/column/article/424017\">ä¹‹å‰</a>é˜…è¯» bytes çš„æºç å·²ç»è§è¯†è¿‡äº†ï¼Œå®ƒå¯ä»¥æœ€å¤§ç¨‹åº¦å…¼é¡¾æ•ˆç‡å’Œçµæ´»æ€§ã€‚</p><p>Rust è‡ªèº«å¹¶ä¸æä¾›å¼‚æ­¥è¿è¡Œæ—¶ï¼Œå®ƒåªåœ¨æ ‡å‡†åº“é‡Œè§„å®šäº†ä¸€äº›åŸºæœ¬çš„æ¥å£ï¼Œè‡³äºæ€ä¹ˆå®ç°ï¼Œå¯ä»¥ç”±å„ä¸ªè¿è¡Œæ—¶ï¼ˆå¦‚ tokioï¼‰è‡ªè¡Œå†³å®šã€‚<strong>æ‰€ä»¥åœ¨æ ‡å‡†åº“ä¸­ï¼Œä½ åªä¼šçœ‹åˆ°è¿™äº›æ¥å£çš„å®šä¹‰ï¼Œä»¥åŠâ€œé«˜å±‚â€æ¥å£çš„å®ç°</strong>ï¼Œæ¯”å¦‚ Waker ä¸‹çš„ wake æ–¹æ³•ï¼Œåªæ˜¯è°ƒç”¨äº† vtable é‡Œçš„ wake() è€Œå·²ï¼š</p><pre><code class=\"language-rust\">impl Waker {\n    /// Wake up the task associated with this `Waker`.\n    #[inline]\n    pub fn wake(self) {\n        // The actual wakeup call is delegated through a virtual function call\n        // to the implementation which is defined by the executor.\n        let wake = self.waker.vtable.wake;\n        let data = self.waker.data;\n\n        // Don't call `drop` -- the waker will be consumed by `wake`.\n        crate::mem::forget(self);\n\n        // SAFETY: This is safe because `Waker::from_raw` is the only way\n        // to initialize `wake` and `data` requiring the user to acknowledge\n        // that the contract of `RawWaker` is upheld.\n        unsafe { (wake)(data) };\n    }\n    ...\n}\n</code></pre><p>å¦‚æœä½ æƒ³é¡ºè—¤æ‘¸ç“œæ‰¾åˆ° vtable æ˜¯æ€ä¹ˆè®¾ç½®çš„ï¼Œå´å‘ç°ä¸€åˆ‡çº¿ç´¢éƒ½æ‚„æ— å£°æ¯åœ°ä¸­æ–­äº†ï¼Œé‚£æ˜¯å› ä¸ºï¼Œå…·ä½“çš„å®ç°å¹¶ä¸åœ¨æ ‡å‡†åº“ä¸­ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸‰æ–¹çš„å¼‚æ­¥è¿è¡Œæ—¶é‡Œï¼Œæ¯”å¦‚ tokioã€‚</p><p>ä¸è¿‡ï¼Œè™½ç„¶æˆ‘ä»¬å¼€å‘æ—¶ä¼šä½¿ç”¨ tokioï¼Œä½†é˜…è¯»ã€ç†è§£ä»£ç æ—¶ï¼Œæˆ‘å»ºè®®çœ‹ futures åº“ï¼Œæ¯”å¦‚ waker vtable çš„<a href=\"https://github.com/rust-lang/futures-rs/blob/master/futures-task/src/waker.rs\">å®šä¹‰</a>ã€‚futures åº“è¿˜æœ‰ä¸€ä¸ªç®€å•çš„ executorï¼Œä¹Ÿéå¸¸é€‚åˆè¿›ä¸€æ­¥é€šè¿‡ä»£ç ç†è§£ executor çš„åŸç†ã€‚</p><h2>asyncç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆï¼Ÿ</h2><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ Pinã€‚è¿™æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„æ•°æ®ç»“æ„ï¼Œæ­£å¸¸æ•°æ®ç»“æ„çš„æ–¹æ³•éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ self / &amp;self / &amp;mut selfï¼Œå¯æ˜¯ poll() å´ä½¿ç”¨äº† Pin&lt;&amp;mut self&gt;ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><p>ä¸ºäº†è®²æ˜ç™½ Pinï¼Œæˆ‘ä»¬å¾—å¾€å‰è¿½è¸ªä¸€æ­¥ï¼Œçœ‹çœ‹äº§ç”Ÿ Futureçš„ä¸€ä¸ª async block/fn å†…éƒ¨ç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆæ ·çš„ä»£ç ï¼Ÿæ¥çœ‹ä¸‹é¢è¿™ä¸ªç®€å•çš„ async å‡½æ•°ï¼š</p><pre><code class=\"language-rust\">async fn write_hello_file_async(name: &amp;str) -&gt; anyhow::Result&lt;()&gt; {\n    let mut file = fs::File::create(name).await?;\n    file.write_all(b\"hello world!\").await?;\n\n    Ok(())\n}\n</code></pre><p>é¦–å…ˆå®ƒåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åå¾€è¿™ä¸ªæ–‡ä»¶é‡Œå†™å…¥ â€œhello world!â€ã€‚è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ª awaitï¼Œåˆ›å»ºæ–‡ä»¶çš„æ—¶å€™ä¼šå¼‚æ­¥åˆ›å»ºï¼Œå†™å…¥æ–‡ä»¶çš„æ—¶å€™ä¼šå¼‚æ­¥å†™å…¥ã€‚æœ€ç»ˆï¼Œæ•´ä¸ªå‡½æ•°å¯¹å¤–è¿”å›ä¸€ä¸ª Futureã€‚</p><p>å…¶å®ƒäººå¯ä»¥è¿™æ ·è°ƒç”¨ï¼š</p><pre><code class=\"language-rust\">write_hello_file_async(\"/tmp/hello\").await?;\n</code></pre><p>æˆ‘ä»¬çŸ¥é“ï¼Œexecutor å¤„ç† Future æ—¶ï¼Œä¼šä¸æ–­åœ°è°ƒç”¨å®ƒçš„ poll() æ–¹æ³•ï¼Œäºæ˜¯ï¼Œä¸Šé¢é‚£å¥å®é™…ä¸Šç›¸å½“äºï¼š</p><pre><code class=\"language-rust\">match write_hello_file_async.poll(cx) {\n    Poll::Ready(result) =&gt; return result,\n    Poll::Pending =&gt; return Poll::Pending\n}\n</code></pre><p>è¿™æ˜¯å•ä¸ª await çš„å¤„ç†æ–¹æ³•ï¼Œé‚£æ›´åŠ å¤æ‚çš„ï¼Œä¸€ä¸ªå‡½æ•°ä¸­æœ‰è‹¥å¹²ä¸ª awaitï¼Œè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿä»¥å‰é¢<code>write_hello_file_async</code> å‡½æ•°çš„å†…éƒ¨å®ç°ä¸ºä¾‹ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬åªæœ‰åœ¨å¤„ç†å®Œ create()ï¼Œæ‰èƒ½å¤„ç† write_all()ï¼Œæ‰€ä»¥ï¼Œåº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p><pre><code class=\"language-rust\">let fut = fs::File::create(name);\nmatch fut.poll(cx) {\n    Poll::Ready(Ok(file)) =&gt; {\n        let fut = file.write_all(b\"hello world!\");\n        match fut.poll(cx) {\n            Poll::Ready(result) =&gt; return result,\n            Poll::Pending =&gt; return Poll::Pending,\n        }\n    }\n    Poll::Pending =&gt; return Poll::Pending,\n}\n</code></pre><p>ä½†æ˜¯ï¼Œå‰é¢è¯´è¿‡ï¼Œasync å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Futureï¼Œæ‰€ä»¥ï¼Œè¿˜éœ€è¦æŠŠè¿™æ ·çš„ä»£ç å°è£…åœ¨ä¸€ä¸ª Future çš„å®ç°é‡Œï¼Œå¯¹å¤–æä¾›å‡ºå»ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒæŠŠå†…éƒ¨çš„çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸ºè¿™ä¸ªæ•°æ®ç»“æ„å®ç° Futureã€‚æ¯”å¦‚ï¼š</p><pre><code class=\"language-rust\">enum WriteHelloFile {\n    // åˆå§‹é˜¶æ®µï¼Œç”¨æˆ·æä¾›æ–‡ä»¶å\n    Init(String),\n    // ç­‰å¾…æ–‡ä»¶åˆ›å»ºï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨\n    // è¿™æ˜¯ä¼ªä»£ç ï¼Œimpl Future ä¸èƒ½ç”¨åœ¨è¿™é‡Œ\n    AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;),\n    // ç­‰å¾…æ–‡ä»¶å†™å…¥ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨\n    AwaitingWrite(impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;),\n    // Future å¤„ç†å®Œæ¯•\n    Done,\n}\n\nimpl WriteHelloFile {\n    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {\n        Self::Init(name.into())\n    }\n}\n\nimpl Future for WriteHelloFile {\n    type Output = Result&lt;(), std::io::Error&gt;;\n\n    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {\n        todo!()\n    }\n}\n\nfn write_hello_file_async(name: &amp;str) -&gt; WriteHelloFile {\n    WriteHelloFile::new(name)\n}\n</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠåˆšæ‰çš„ write_hello_file_async å¼‚æ­¥å‡½æ•°ï¼Œè½¬åŒ–æˆäº†ä¸€ä¸ªè¿”å› WriteHelloFile Future çš„å‡½æ•°ã€‚æ¥çœ‹è¿™ä¸ª Future å¦‚ä½•å®ç°ï¼ˆè¯¦ç»†æ³¨é‡Šäº†ï¼‰ï¼š</p><pre><code class=\"language-rust\">impl Future for WriteHelloFile {\n    type Output = Result&lt;(), std::io::Error&gt;;\n\n    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {\n        let this = self.get_mut();\n        loop {\n            match this {\n                // å¦‚æœçŠ¶æ€æ˜¯ Initï¼Œé‚£ä¹ˆå°±ç”Ÿæˆ create Futureï¼ŒæŠŠçŠ¶æ€åˆ‡æ¢åˆ° AwaitingCreate\n                WriteHelloFile::Init(name) =&gt; {\n                    let fut = fs::File::create(name);\n                    *self = WriteHelloFile::AwaitingCreate(fut);\n                }\n                // å¦‚æœçŠ¶æ€æ˜¯ AwaitingCreateï¼Œé‚£ä¹ˆ poll create Future\n                // å¦‚æœè¿”å› Poll::Ready(Ok(_))ï¼Œé‚£ä¹ˆåˆ›å»º write Future\n                // å¹¶æŠŠçŠ¶æ€åˆ‡æ¢åˆ° Awaiting\n                WriteHelloFile::AwaitingCreate(fut) =&gt; match fut.poll(cx) {\n                    Poll::Ready(Ok(file)) =&gt; {\n                        let fut = file.write_all(b\"hello world!\");\n                        *self = WriteHelloFile::AwaitingWrite(fut);\n                    }\n                    Poll::Ready(Err(e)) =&gt; return Poll::Ready(Err(e)),\n                    Poll::Pending =&gt; return Poll::Pending,\n                },\n                // å¦‚æœçŠ¶æ€æ˜¯ AwaitingWriteï¼Œé‚£ä¹ˆ poll write Future\n                // å¦‚æœè¿”å› Poll::Ready(_)ï¼Œé‚£ä¹ˆçŠ¶æ€åˆ‡æ¢åˆ° Doneï¼Œæ•´ä¸ª Future æ‰§è¡ŒæˆåŠŸ\n                WriteHelloFile::AwaitingWrite(fut) =&gt; match fut.poll(cx) {\n                    Poll::Ready(result) =&gt; {\n                        *self = WriteHelloFile::Done;\n                        return Poll::Ready(result);\n                    }\n                    Poll::Pending =&gt; return Poll::Pending,\n                },\n                // æ•´ä¸ª Future å·²ç»æ‰§è¡Œå®Œæ¯•\n                WriteHelloFile::Done =&gt; return Poll::Ready(Ok(())),\n            }\n        }\n    }\n}\n</code></pre><p>è¿™ä¸ª Future å®Œæ•´å®ç°çš„å†…éƒ¨ç»“æ„ ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºçš„è¿ç§»ã€‚</p><p>è¿™æ®µï¼ˆä¼ªï¼‰ä»£ç å’Œä¹‹å‰å¼‚æ­¥å‡½æ•°æ˜¯ç­‰ä»·çš„ï¼š</p><pre><code class=\"language-rust\">async fn write_hello_file_async(name: &amp;str) -&gt; anyhow::Result&lt;()&gt; {\n    let mut file = fs::File::create(name).await?;\n    file.write_all(b\"hello world!\").await?;\n\n    Ok(())\n}\n</code></pre><p><strong>Rust åœ¨ç¼–è¯‘ async fn æˆ–è€… async block æ—¶ï¼Œå°±ä¼šç”Ÿæˆç±»ä¼¼çš„çŠ¶æ€æœºçš„å®ç°</strong>ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œçœ‹ä¼¼ç®€å•çš„å¼‚æ­¥å¤„ç†ï¼Œå†…éƒ¨éšè—äº†ä¸€å¥—å¹¶ä¸éš¾ç†è§£ã€ä½†æ˜¯å†™èµ·æ¥å¾ˆç”Ÿç¡¬å¾ˆå•°å—¦çš„çŠ¶æ€æœºç®¡ç†ä»£ç ã€‚</p><p>å¥½ææ˜ç™½è¿™ä¸ªé—®é¢˜ï¼Œå›åˆ°pin ã€‚åˆšæ‰æˆ‘ä»¬æ‰‹å†™çŠ¶æ€æœºä»£ç çš„è¿‡ç¨‹ï¼Œèƒ½å¸®ä½ ç†è§£ä¸ºä»€ä¹ˆä¼šéœ€è¦ Pin è¿™ä¸ªé—®é¢˜ã€‚</p><h3>ä¸ºä»€ä¹ˆéœ€è¦ Pinï¼Ÿ</h3><p>åœ¨ä¸Šé¢å®ç° Future çš„çŠ¶æ€æœºä¸­ï¼Œæˆ‘ä»¬å¼•ç”¨äº† file è¿™æ ·ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼š</p><pre><code class=\"language-rust\">WriteHelloFile::AwaitingCreate(fut) =&gt; match fut.poll(cx) {\n    Poll::Ready(Ok(file)) =&gt; {\n        let fut = file.write_all(b\"hello world!\");\n        *self = WriteHelloFile::AwaitingWrite(fut);\n    }\n    Poll::Ready(Err(e)) =&gt; return Poll::Ready(Err(e)),\n    Poll::Pending =&gt; return Poll::Pending,\n}\n</code></pre><p>è¿™ä¸ªä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œfile è¢« fut å¼•ç”¨ï¼Œä½† file ä¼šåœ¨è¿™ä¸ªä½œç”¨åŸŸè¢«ä¸¢å¼ƒã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä¿å­˜åœ¨æ•°æ®ç»“æ„ä¸­ï¼š</p><pre><code class=\"language-rust\">enum WriteHelloFile {\n    // åˆå§‹é˜¶æ®µï¼Œç”¨æˆ·æä¾›æ–‡ä»¶å\n    Init(String),\n    // ç­‰å¾…æ–‡ä»¶åˆ›å»ºï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨\n    AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;),\n    // ç­‰å¾…æ–‡ä»¶å†™å…¥ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨\n    AwaitingWrite(AwaitingWriteData),\n    // Future å¤„ç†å®Œæ¯•\n    Done,\n}\n\nstruct AwaitingWriteData {\n    fut: impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;,\n    file: fs::File,\n}\n</code></pre><p>å¯ä»¥ç”Ÿæˆä¸€ä¸ª AwaitingWriteData æ•°æ®ç»“æ„ï¼ŒæŠŠ file å’Œ fut éƒ½æ”¾è¿›å»ï¼Œç„¶ååœ¨ WriteHelloFile ä¸­å¼•ç”¨å®ƒã€‚æ­¤æ—¶ï¼Œåœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„å†…éƒ¨ï¼Œfut æŒ‡å‘äº†å¯¹ file çš„å¼•ç”¨ï¼Œè¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œå«<strong>è‡ªå¼•ç”¨ç»“æ„ï¼ˆSelf-Referential Structureï¼‰</strong>ã€‚</p><p>è‡ªå¼•ç”¨ç»“æ„æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼šä¸€æ—¦å®ƒè¢«ç§»åŠ¨ï¼ŒåŸæœ¬çš„æŒ‡é’ˆå°±ä¼šæŒ‡å‘æ—§çš„åœ°å€ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/d9/25/d98a5812510307d1274e066d4b663c25.jpg?wh=2067x1164\" alt=\"\"></p><p>æ‰€ä»¥éœ€è¦æœ‰æŸç§æœºåˆ¶æ¥ä¿è¯è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿã€‚Pin å°±æ˜¯ä¸ºè¿™ä¸ªç›®çš„è€Œè®¾è®¡çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥ Pin ä½æŒ‡å‘ä¸€ä¸ª Future çš„æŒ‡é’ˆï¼Œçœ‹æ–‡ç¨¿ä¸­ Pin çš„å£°æ˜ï¼š</p><pre><code class=\"language-rust\">pub struct Pin&lt;P&gt; {\n    pointer: P,\n}\n\nimpl&lt;P: Deref&gt; Deref for Pin&lt;P&gt; {\n    type Target = P::Target;\n    fn deref(&amp;self) -&gt; &amp;P::Target {\n        Pin::get_ref(Pin::as_ref(self))\n    }\n}\n\nimpl&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; DerefMut for Pin&lt;P&gt; {\n    fn deref_mut(&amp;mut self) -&gt; &amp;mut P::Target {\n        Pin::get_mut(Pin::as_mut(self))\n    }\n}\n</code></pre><p>Pin æ‹¿ä½çš„æ˜¯<strong>ä¸€ä¸ªå¯ä»¥è§£å¼•ç”¨æˆ T çš„æŒ‡é’ˆç±»å‹ P</strong>ï¼Œè€Œä¸æ˜¯ç›´æ¥æ‹¿åŸæœ¬çš„ç±»å‹ Tã€‚æ‰€ä»¥ï¼Œå¯¹äº Pin è€Œè¨€ï¼Œä½ çœ‹åˆ°çš„éƒ½æ˜¯ Pin&lt;Box&lt;T&gt;&gt;ã€Pin&lt;&amp;mut T&gt;ï¼Œä½†ä¸ä¼šæ˜¯ Pin&lt;T&gt;ã€‚å› ä¸º Pin çš„ç›®çš„æ˜¯ï¼ŒæŠŠ T çš„å†…å­˜ä½ç½®é”ä½ï¼Œä»è€Œé¿å…ç§»åŠ¨åè‡ªå¼•ç”¨ç±»å‹å¸¦æ¥çš„å¼•ç”¨å¤±æ•ˆé—®é¢˜ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/f2/72/f2ac4b8ebaa25718191f747edca71072.jpg?wh=2067x1164\" alt=\"\"></p><p>è¿™æ ·æ•°æ®ç»“æ„å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œä½†æ˜¯ä½ <strong>æ— æ³•ç›´æ¥</strong>æ‹¿åˆ°åŸæ¥çš„æ•°æ®ç»“æ„è¿›è€Œç§»åŠ¨å®ƒã€‚</p><h3>è‡ªå¼•ç”¨æ•°æ®ç»“æ„</h3><p>å½“ç„¶ï¼Œè‡ªå¼•ç”¨æ•°æ®ç»“æ„å¹¶éåªåœ¨å¼‚æ­¥ä»£ç é‡Œå‡ºç°ï¼Œåªä¸è¿‡å¼‚æ­¥ä»£ç åœ¨å†…éƒ¨ç”Ÿæˆç”¨çŠ¶æ€æœºè¡¨è¿°çš„ Future æ—¶ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿè‡ªå¼•ç”¨ç»“æ„ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªå’Œ Future æ— å…³çš„ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=84d31bad09e9cf0824e07b64fa7930fb\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">#[derive(Debug)]\nstruct SelfReference {\n    name: String,\n    // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name\n    name_ptr: *const String,\n}\n\nimpl SelfReference {\n    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {\n        SelfReference {\n            name: name.into(),\n            name_ptr: std::ptr::null(),\n        }\n    }\n\n    pub fn init(&amp;mut self) {\n        self.name_ptr = &amp;self.name as *const String;\n    }\n\n    pub fn print_name(&amp;self) {\n        println!(\n            \"struct {:p}: (name: {:p} name_ptr: {:p}), name: {}, name_ref: {}\",\n            self,\n            &amp;self.name,\n            self.name_ptr,\n            self.name,\n            // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe\n            // SAFETY: è¿™é‡Œ name_ptr æ½œåœ¨ä¸å®‰å…¨ï¼Œä¼šæŒ‡å‘æ—§çš„ä½ç½®\n            unsafe { &amp;*self.name_ptr },\n        );\n    }\n}\n\nfn main() {\n    let data = move_creates_issue();\n    println!(\"data: {:?}\", data);\n    // å¦‚æœæŠŠä¸‹é¢è¿™å¥æ³¨é‡Šæ‰ï¼Œç¨‹åºè¿è¡Œä¼šç›´æ¥ segment error\n    // data.print_name();\n    print!(\"\\\\n\");\n    mem_swap_creates_issue();\n}\n\nfn move_creates_issue() -&gt; SelfReference {\n    let mut data = SelfReference::new(\"Tyr\");\n    data.init();\n\n    // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸\n    data.print_name();\n\n    let data = move_it(data);\n\n    // move ä¹‹åï¼Œname_ref æŒ‡å‘çš„ä½ç½®æ˜¯å·²ç»å¤±æ•ˆçš„åœ°å€\n    // åªä¸è¿‡ç°åœ¨ move å‰çš„åœ°å€è¿˜æ²¡è¢«å›æ”¶æŒªä½œå®ƒç”¨\n    data.print_name();\n    data\n}\n\nfn mem_swap_creates_issue() {\n    let mut data1 = SelfReference::new(\"Tyr\");\n    data1.init();\n\n    let mut data2 = SelfReference::new(\"Lindsey\");\n    data2.init();\n\n    data1.print_name();\n    data2.print_name();\n\n    std::mem::swap(&amp;mut data1, &amp;mut data2);\n    data1.print_name();\n    data2.print_name();\n}\n\nfn move_it(data: SelfReference) -&gt; SelfReference {\n    data\n}\n</code></pre><p>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè‡ªå¼•ç”¨ç»“æ„ SelfReferenceï¼Œå®ƒé‡Œé¢çš„ name_ref æŒ‡å‘äº† nameã€‚æ­£å¸¸ä½¿ç”¨å®ƒæ—¶ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ä¸€æ—¦å¯¹è¿™ä¸ªç»“æ„åš move æ“ä½œï¼Œname_ref æŒ‡å‘çš„ä½ç½®è¿˜ä¼šæ˜¯ move å‰ name çš„åœ°å€ï¼Œè¿™å°±å¼•å‘äº†é—®é¢˜ã€‚çœ‹ä¸‹å›¾ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/31/07/31002299965d19c7bb014050987f4907.jpg?wh=2067x1164\" alt=\"\"></p><p>åŒæ ·çš„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ std::mem:swapï¼Œä¹Ÿä¼šå‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œä¸€æ—¦ swapï¼Œä¸¤ä¸ªæ•°æ®çš„å†…å®¹äº¤æ¢ï¼Œç„¶è€Œï¼Œç”±äº name_ref æŒ‡å‘çš„åœ°å€è¿˜æ˜¯æ—§çš„ï¼Œæ‰€ä»¥æ•´ä¸ªæŒ‡é’ˆä½“ç³»éƒ½æ··ä¹±äº†ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/42/17/420d3e07c76f9948135857f1d1898d17.jpg?wh=2118x2026\" alt=\"\"></p><p>çœ‹ä»£ç çš„è¾“å‡ºï¼Œè¾…åŠ©ä½ ç†è§£ï¼š</p><pre><code class=\"language-rust\">struct 0x7ffeea91d6e8: (name: 0x7ffeea91d6e8 name_ptr: 0x7ffeea91d6e8), name: Tyr, name_ref: Tyr\nstruct 0x7ffeea91d760: (name: 0x7ffeea91d760 name_ptr: 0x7ffeea91d6e8), name: Tyr, name_ref: Tyr\ndata: SelfReference { name: \"Tyr\", name_ptr: 0x7ffeea91d6e8 }\n\nstruct 0x7ffeea91d6f0: (name: 0x7ffeea91d6f0 name_ptr: 0x7ffeea91d6f0), name: Tyr, name_ref: Tyr\nstruct 0x7ffeea91d710: (name: 0x7ffeea91d710 name_ptr: 0x7ffeea91d710), name: Lindsey, name_ref: Lindsey\nstruct 0x7ffeea91d6f0: (name: 0x7ffeea91d6f0 name_ptr: 0x7ffeea91d710), name: Lindsey, name_ref: Tyr\nstruct 0x7ffeea91d710: (name: 0x7ffeea91d710 name_ptr: 0x7ffeea91d6f0), name: Tyr, name_ref: Lindsey\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œswap ä¹‹åï¼Œname_ref æŒ‡å‘çš„å†…å®¹ç¡®å®å’Œ name ä¸ä¸€æ ·äº†ã€‚è¿™å°±æ˜¯è‡ªå¼•ç”¨ç»“æ„å¸¦æ¥çš„é—®é¢˜ã€‚</p><p>ä½ ä¹Ÿè®¸ä¼šå¥‡æ€ªï¼Œä¸æ˜¯è¯´ move ä¹Ÿä¼šå‡ºé—®é¢˜ä¹ˆï¼Ÿä¸ºä»€ä¹ˆç¬¬äºŒè¡Œæ‰“å° name_ref è¿˜æ˜¯æŒ‡å‘äº† â€œTyrâ€ï¼Ÿè¿™æ˜¯å› ä¸º move åï¼Œä¹‹å‰çš„å†…å­˜å¤±æ•ˆï¼Œä½†æ˜¯å†…å­˜åœ°å€è¿˜æ²¡æœ‰è¢«æŒªä½œå®ƒç”¨ï¼Œæ‰€ä»¥è¿˜èƒ½æ­£å¸¸æ˜¾ç¤º â€œTyrâ€ã€‚<strong>ä½†è¿™æ ·çš„å†…å­˜è®¿é—®æ˜¯ä¸å®‰å…¨çš„</strong>ï¼Œå¦‚æœä½ æŠŠ main ä¸­è¿™å¥ä»£ç æ³¨é‡Šæ‰ï¼Œç¨‹åºå°±ä¼š crashï¼š</p><pre><code class=\"language-rust\">fn main() {\n    let data = move_creates_issue();\n    println!(\"data: {:?}\", data);\n    // å¦‚æœæŠŠä¸‹é¢è¿™å¥æ³¨é‡Šæ‰ï¼Œç¨‹åºè¿è¡Œä¼šç›´æ¥ segment error\n    // data.print_name();\n    print!(\"\\\\n\");\n    mem_swap_creates_issue();\n}\n</code></pre><p>ç°åœ¨ä½ åº”è¯¥äº†è§£åˆ°åœ¨ Rust ä¸‹ï¼Œè‡ªå¼•ç”¨ç±»å‹å¸¦æ¥çš„æ½œåœ¨å±å®³äº†å§ã€‚</p><p>æ‰€ä»¥ï¼ŒPin çš„å‡ºç°ï¼Œå¯¹è§£å†³è¿™ç±»é—®é¢˜å¾ˆå…³é”®ï¼Œå¦‚æœä½ è¯•å›¾ç§»åŠ¨è¢« Pin ä½çš„æ•°æ®ç»“æ„ï¼Œè¦ä¹ˆï¼Œç¼–è¯‘å™¨ä¼šé€šè¿‡ç¼–è¯‘é”™è¯¯é˜»æ­¢ä½ ï¼›è¦ä¹ˆï¼Œä½ å¼ºè¡Œä½¿ç”¨ unsafe Rustï¼Œè‡ªå·±è´Ÿè´£å…¶å®‰å…¨æ€§ã€‚æˆ‘ä»¬æ¥çœ‹ä½¿ç”¨ Pin åå¦‚ä½•é¿å…ç§»åŠ¨å¸¦æ¥çš„é—®é¢˜ï¼š</p><pre><code class=\"language-rust\">use std::{marker::PhantomPinned, pin::Pin};\n\n#[derive(Debug)]\nstruct SelfReference {\n    name: String,\n    // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name\n    name_ptr: *const String,\n    // PhantomPinned å ä½ç¬¦\n    _marker: PhantomPinned,\n}\n\nimpl SelfReference {\n    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {\n        SelfReference {\n            name: name.into(),\n            name_ptr: std::ptr::null(),\n            _marker: PhantomPinned,\n        }\n    }\n\n    pub fn init(self: Pin&lt;&amp;mut Self&gt;) {\n        let name_ptr = &amp;self.name as *const String;\n        // SAFETY: è¿™é‡Œå¹¶ä¸ä¼šæŠŠä»»ä½•æ•°æ®ä» &amp;mut SelfReference ä¸­ç§»èµ°\n        let this = unsafe { self.get_unchecked_mut() };\n        this.name_ptr = name_ptr;\n    }\n\n    pub fn print_name(self: Pin&lt;&amp;Self&gt;) {\n        println!(\n            \"struct {:p}: (name: {:p} name_ptr: {:p}), name: {}, name_ref: {}\",\n            self,\n            &amp;self.name,\n            self.name_ptr,\n            self.name,\n            // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe\n            // SAFETY: å› ä¸ºæ•°æ®ä¸ä¼šç§»åŠ¨ï¼Œæ‰€ä»¥è¿™é‡Œ name_ptr æ˜¯å®‰å…¨çš„\n            unsafe { &amp;*self.name_ptr },\n        );\n    }\n}\n\nfn main() {\n    move_creates_issue();\n}\n\nfn move_creates_issue() {\n    let mut data = SelfReference::new(\"Tyr\");\n    let mut data = unsafe { Pin::new_unchecked(&amp;mut data) };\n    SelfReference::init(data.as_mut());\n\n    // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸\n    data.as_ref().print_name();\n\n    // ç°åœ¨åªèƒ½æ‹¿åˆ° pinned åçš„æ•°æ®ï¼Œæ‰€ä»¥ move ä¸äº†ä¹‹å‰\n    move_pinned(data.as_mut());\n    println!(\"{:?} ({:p})\", data, &amp;data);\n\n    // ä½ æ— æ³•æ‹¿å› Pin ä¹‹å‰çš„ SelfReference ç»“æ„ï¼Œæ‰€ä»¥è°ƒç”¨ä¸äº† move_it\n    // move_it(data);\n}\n\nfn move_pinned(data: Pin&lt;&amp;mut SelfReference&gt;) {\n    println!(\"{:?} ({:p})\", data, &amp;data);\n}\n\n#[allow(dead_code)]\nfn move_it(data: SelfReference) {\n    println!(\"{:?} ({:p})\", data, &amp;data);\n}\n</code></pre><p>ç”±äºæ•°æ®ç»“æ„è¢«åŒ…è£¹åœ¨ Pin å†…éƒ¨ï¼Œæ‰€ä»¥åœ¨å‡½æ•°é—´ä¼ é€’æ—¶ï¼Œå˜åŒ–çš„åªæ˜¯æŒ‡å‘ data çš„ Pinï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/d8/80/d8b774c6c4970abc8dbce29cbb2fde80.jpg?wh=2067x1164\" alt=\"\"></p><p>å­¦ä¹ äº†Pinï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æƒ³èµ· Unpin ã€‚</p><h3>é‚£ä¹ˆï¼ŒUnpin æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</h3><p>æˆ‘ä»¬åœ¨ä»‹ç»<a href=\"https://time.geekbang.org/column/article/421324\">ä¸»è¦çš„ç³»ç»Ÿ trait</a> æ—¶ï¼Œæ›¾ç»æåŠ Unpin è¿™ä¸ª marker traitï¼š</p><pre><code class=\"language-rust\">pub auto trait Unpin {}\n</code></pre><p>Pin æ˜¯ä¸ºäº†è®©æŸä¸ªæ•°æ®ç»“æ„æ— æ³•åˆæ³•åœ°ç§»åŠ¨ï¼Œè€Œ Unpin åˆ™ç›¸å½“äºå£°æ˜æ•°æ®ç»“æ„æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼äº Send / Syncï¼Œé€šè¿‡ç±»å‹çº¦æŸæ¥å‘Šè¯‰ç¼–è¯‘å™¨å“ªäº›è¡Œä¸ºæ˜¯åˆæ³•çš„ã€å“ªäº›ä¸æ˜¯ã€‚</p><p>åœ¨ Rust ä¸­ï¼Œç»å¤§å¤šæ•°æ•°æ®ç»“æ„éƒ½æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½è‡ªåŠ¨å®ç°äº† <a href=\"https://doc.rust-lang.org/std/marker/trait.Unpin.html\">Unpin</a>ã€‚å³ä¾¿è¿™äº›ç»“æ„è¢« Pin åŒ…è£¹ï¼Œå®ƒä»¬ä¾æ—§å¯ä»¥è¿›è¡Œç§»åŠ¨ï¼Œæ¯”å¦‚ï¼š</p><pre><code class=\"language-rust\">use std::mem;\nuse std::pin::Pin;\n\nlet mut string = \"this\".to_string();\nlet mut pinned_string = Pin::new(&amp;mut string);\n\n// We need a mutable reference to call `mem::replace`.\n// We can obtain such a reference by (implicitly) invoking `Pin::deref_mut`,\n// but that is only possible because `String` implements `Unpin`.\nmem::replace(&amp;mut *pinned_string, \"other\".to_string());\n</code></pre><p>å½“æˆ‘ä»¬ä¸å¸Œæœ›ä¸€ä¸ªæ•°æ®ç»“æ„è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ !Unpinã€‚åœ¨ Rust é‡Œï¼Œå®ç°äº† !Unpin çš„ï¼Œé™¤äº†å†…éƒ¨ç»“æ„ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œä¸»è¦å°±æ˜¯ PhantomPinnedï¼š</p><pre><code class=\"language-rust\">pub struct PhantomPinned;\nimpl !Unpin for PhantomPinned {}\n</code></pre><p>æ‰€ä»¥ï¼Œå¦‚æœä½ å¸Œæœ›ä½ çš„æ•°æ®ç»“æ„ä¸èƒ½è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ  PhantomPinned å­—æ®µæ¥éšå¼å£°æ˜ !Unpinã€‚</p><p>å½“æ•°æ®ç»“æ„æ»¡è¶³ Unpin æ—¶ï¼Œåˆ›å»º Pin ä»¥åŠä½¿ç”¨ Pinï¼ˆä¸»è¦æ˜¯ DerefMutï¼‰éƒ½å¯ä»¥ä½¿ç”¨å®‰å…¨æ¥å£ï¼Œå¦åˆ™ï¼Œéœ€è¦ä½¿ç”¨ unsafe æ¥å£ï¼š</p><pre><code class=\"language-rust\">// å¦‚æœå®ç°äº† Unpinï¼Œå¯ä»¥é€šè¿‡å®‰å…¨æ¥å£åˆ›å»ºå’Œè¿›è¡Œ DerefMut\nimpl&lt;P: Deref&lt;Target: Unpin&gt;&gt; Pin&lt;P&gt; {\n    pub const fn new(pointer: P) -&gt; Pin&lt;P&gt; {\n        // SAFETY: the value pointed to is `Unpin`, and so has no requirements\n        // around pinning.\n        unsafe { Pin::new_unchecked(pointer) }\n    }\n    pub const fn into_inner(pin: Pin&lt;P&gt;) -&gt; P {\n        pin.pointer\n    }\n}\n\nimpl&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; DerefMut for Pin&lt;P&gt; {\n    fn deref_mut(&amp;mut self) -&gt; &amp;mut P::Target {\n        Pin::get_mut(Pin::as_mut(self))\n    }\n}\n\n// å¦‚æœæ²¡æœ‰å®ç° Unpinï¼Œåªèƒ½é€šè¿‡ unsafe æ¥å£åˆ›å»ºï¼Œä¸èƒ½ä½¿ç”¨ DerefMut\nimpl&lt;P: Deref&gt; Pin&lt;P&gt; {\n    pub const unsafe fn new_unchecked(pointer: P) -&gt; Pin&lt;P&gt; {\n        Pin { pointer }\n    }\n\n    pub const unsafe fn into_inner_unchecked(pin: Pin&lt;P&gt;) -&gt; P {\n        pin.pointer\n    }\n}\n</code></pre><h2>async äº§ç”Ÿçš„ Future ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹ Future çš„æ¥å£æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„è®¤è¯†ï¼Œä¹ŸçŸ¥é“ async å…³é”®å­—çš„èƒŒåéƒ½å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼š</p><pre><code class=\"language-rust\">pub trait Future {\n    type Output;\n    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;\n}\n</code></pre><p>é‚£ä¹ˆï¼Œå½“ä½ å†™ä¸€ä¸ª async fn æˆ–è€…ä½¿ç”¨äº†ä¸€ä¸ª async block æ—¶ï¼Œç©¶ç«Ÿå¾—åˆ°äº†ä¸€ä¸ªä»€ä¹ˆç±»å‹çš„æ•°æ®å‘¢ï¼Ÿæ¯”å¦‚ï¼š</p><pre><code class=\"language-rust\">let fut = async { 42 };\n</code></pre><p>ä½ è‚¯å®šèƒ½æ‹ç€èƒ¸è„¯è¯´ï¼Œè¿™ä¸ªæˆ‘çŸ¥é“ï¼Œä¸å°±æ˜¯ impl Future&lt;Output = i32&gt; ä¹ˆï¼Ÿ</p><p>å¯¹ï¼Œä½†æ˜¯ impl Future ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»å‹å•Šï¼Œæˆ‘ä»¬è®²è¿‡ï¼Œå®ƒç›¸å½“äº T: Futureï¼Œé‚£ä¹ˆè¿™ä¸ª T ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥å†™æ®µä»£ç æ¢ç´¢ä¸€ä¸‹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=40efb64c5e424e00e6fa57655c5357a1\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">fn main() {\n    let fut = async { 42 };\n\n    println!(\"type of fut is: {}\", get_type_name(&amp;fut));\n}\n\nfn get_type_name&lt;T&gt;(_: &amp;T) -&gt; &amp;'static str {\n    std::any::type_name::&lt;T&gt;()\n}\n</code></pre><p>å®ƒçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">type of fut is: core::future::from_generator::GenFuture&lt;xxx::main::{{closure}}&gt;\n</code></pre><p>å“ˆï¼Œæˆ‘ä»¬ä¼¼ä¹å‘ç°äº†æ–°å¤§é™†ï¼Œå®ç° Future trait çš„æ˜¯ä¸€ä¸ªå« GenFuture çš„ç»“æ„ï¼Œå®ƒå†…éƒ¨æœ‰ä¸€ä¸ªé—­åŒ…ã€‚çŒœæµ‹è¿™ä¸ªé—­åŒ…æ˜¯ <code>async { 42 }</code> äº§ç”Ÿçš„ï¼Ÿ</p><p>æˆ‘ä»¬çœ‹ GenFuture çš„å®šä¹‰ï¼ˆæ„Ÿå…´è¶£å¯ä»¥åœ¨ Rust æºç ä¸­æœ from_generatorï¼‰ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªæ³›å‹ç»“æ„ï¼Œå†…éƒ¨æ•°æ® T è¦æ»¡è¶³ Generator traitï¼š</p><pre><code class=\"language-rust\">struct GenFuture&lt;T: Generator&lt;ResumeTy, Yield = ()&gt;&gt;(T);\n\npub trait Generator&lt;R = ()&gt; {\n    type Yield;\n    type Return;\n    fn resume(\n        self: Pin&lt;&amp;mut Self&gt;, \n        arg: R\n    ) -&gt; GeneratorState&lt;Self::Yield, Self::Return&gt;;\n}\n</code></pre><p><a href=\"https://doc.rust-lang.org/std/ops/trait.Generator.html\">Generator</a> æ˜¯ Rust nightly çš„ä¸€ä¸ª traitï¼Œè¿˜æ²¡æœ‰è¿›å…¥åˆ°æ ‡å‡†åº“ã€‚å¤§è‡´çœ‹çœ‹å®˜ç½‘å±•ç¤ºçš„ä¾‹å­ï¼Œå®ƒæ˜¯æ€ä¹ˆç”¨çš„ï¼š</p><pre><code class=\"language-rust\">#![feature(generators, generator_trait)]\n\nuse std::ops::{Generator, GeneratorState};\nuse std::pin::Pin;\n\nfn main() {\n    let mut generator = || {\n        yield 1;\n        return \"foo\"\n    };\n\n    match Pin::new(&amp;mut generator).resume(()) {\n        GeneratorState::Yielded(1) =&gt; {}\n        _ =&gt; panic!(\"unexpected return from resume\"),\n    }\n    match Pin::new(&amp;mut generator).resume(()) {\n        GeneratorState::Complete(\"foo\") =&gt; {}\n        _ =&gt; panic!(\"unexpected return from resume\"),\n    }\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä½ åˆ›å»ºä¸€ä¸ªé—­åŒ…ï¼Œé‡Œé¢æœ‰ yield å…³é”®å­—ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ª Generatorã€‚å¦‚æœä½ åœ¨ Python ä¸­ä½¿ç”¨è¿‡ yieldï¼ŒäºŒè€…å…¶å®éå¸¸ç±»ä¼¼ã€‚å› ä¸º Generator æ˜¯ä¸€ä¸ªè¿˜æ²¡è¿›å…¥åˆ°ç¨³å®šç‰ˆçš„åŠŸèƒ½ï¼Œå¤§è‡´äº†è§£ä¸€ä¸‹å°±è¡Œï¼Œä»¥åç­‰å®ƒçš„ API ç¨³å®šåå†ä»”ç»†ç ”ç©¶ã€‚</p><h2>å°ç»“</h2><p>è¿™ä¸€è®²æˆ‘ä»¬æ·±å…¥åœ°æ¢è®¨äº† Future æ¥å£å„ä¸ªéƒ¨åˆ†Contextã€Pin/Unpinçš„å«ä¹‰ï¼Œä»¥åŠ async/await è¿™æ ·æ¼‚äº®çš„æ¥å£ä¹‹ä¸‹ä¼šäº§ç”Ÿä»€ä¹ˆæ ·å­çš„ä»£ç ã€‚</p><p>å¯¹ç…§ä¸‹é¢è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹è¿‡å»ä¸¤è®²çš„å†…å®¹ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/e3/4c/e3934324381bc8f90c061bbca629234c.jpg?wh=3022x1724\" alt=\"\"></p><p>å¹¶å‘ä»»åŠ¡è¿è¡Œåœ¨ Future è¿™æ ·çš„åç¨‹ä¸Šæ—¶ï¼Œasync/awaitæ˜¯äº§ç”Ÿå’Œè¿è¡Œå¹¶å‘ä»»åŠ¡çš„æ‰‹æ®µï¼Œasync å®šä¹‰ä¸€ä¸ªå¯ä»¥å¹¶å‘æ‰§è¡Œçš„Futureä»»åŠ¡ï¼Œawait è§¦å‘è¿™ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚å…·ä½“æ¥è¯´ï¼š</p><p>å½“æˆ‘ä»¬ä½¿ç”¨ async å…³é”®å­—æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ª impl Future çš„ç»“æœã€‚å¯¹äºä¸€ä¸ª async block æˆ–è€… async fn æ¥è¯´ï¼Œå†…éƒ¨çš„æ¯ä¸ª await éƒ½ä¼šè¢«ç¼–è¯‘å™¨æ•æ‰ï¼Œå¹¶æˆä¸ºè¿”å›çš„ Future çš„ poll() æ–¹æ³•çš„å†…éƒ¨çŠ¶æ€æœºçš„ä¸€ä¸ªçŠ¶æ€ã€‚</p><p>Rust çš„ Future éœ€è¦å¼‚æ­¥è¿è¡Œæ—¶æ¥è¿è¡Œ Futureï¼Œä»¥ tokio ä¸ºä¾‹ï¼Œå®ƒçš„ executor ä¼šä» run queue ä¸­å–å‡º Future è¿›è¡Œ poll()ï¼Œå½“ poll() è¿”å› Pending æ—¶ï¼Œè¿™ä¸ª Future ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ° reactor å¾—åˆ°äº†æŸä¸ªäº‹ä»¶ï¼Œå”¤é†’è¿™ä¸ª Futureï¼Œå°†å…¶æ·»åŠ å› run queue ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œã€‚</p><p>tokio ä¸€èˆ¬ä¼šåœ¨æ¯ä¸ªç‰©ç†çº¿ç¨‹ï¼ˆæˆ–è€… CPU coreï¼‰ä¸‹è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ run queue æ¥å¤„ç† Futureã€‚ä¸ºäº†æä¾›æœ€å¤§çš„ååé‡ï¼Œtokio å®ç°äº† work stealing schedulerï¼Œè¿™æ ·ï¼Œå½“æŸä¸ªçº¿ç¨‹ä¸‹æ²¡æœ‰å¯æ‰§è¡Œçš„ Futureï¼Œå®ƒä¼šä»å…¶å®ƒçº¿ç¨‹çš„ run queue ä¸­â€œå·â€ä¸€ä¸ªæ‰§è¡Œã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„ T: !Unpinï¼Œæˆ‘ä»¬ä¸ºå…¶ç”Ÿæˆ Box&lt;T&gt;ï¼Œé‚£ä¹ˆ Box&lt;T&gt; æ˜¯ Unpin è¿˜æ˜¯ !Unpin çš„ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„å­¦ä¹ æ„Ÿæ‚Ÿå’Œæ€è€ƒã€‚</p><h3>æ‹“å±•é˜…è¯»</h3><p>è§‚çœ‹ Jon Gjengset çš„ <a href=\"https://www.youtube.com/watch?v=DkMwYxfSYNQ&amp;ab_channel=JonGjengset\">The Why, What, and How of Pinning in Rust</a>ï¼Œè¿›ä¸€æ­¥äº†è§£ Pin å’Œ Unpinã€‚</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æ­å–œä½ å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬39æ¬¡æ‰“å¡ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasync/awaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ","id":455413},"right":{"article_title":"40ï½œå¼‚æ­¥å¤„ç†ï¼šå¦‚ä½•å¤„ç†å¼‚æ­¥IOï¼Ÿ","id":461695}},"comments":[{"had_liked":false,"id":324039,"user_name":"GengTeng","can_delete":false,"product_type":"c1","uid":1224623,"ip_address":"","ucode":"3F926F5EF1D075","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/af/8b03ce2c.jpg","comment_is_top":false,"comment_ctime":1638269367,"is_pvip":false,"replies":[{"id":"118872","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639849374,"ip_address":"","comment_id":324039,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14523171255","product_id":100085301,"comment_content":"æˆ‘ä¹‹å‰è®°å½•å¹¶ç¿»è¯‘è¿‡æ— èˆ¹åŒå¿—ï¼ˆwithoutboatsï¼‰çš„ä¸€ä¸ªè®²åº§ï¼Œä¾›å¤§å®¶å‚è€ƒï¼šhttps:&#47;&#47;gteng.org&#47;2021&#47;01&#47;30&#47;zero-cost-async-io&#47;","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539833,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639849374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111835,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","nickname":"Marvichov","note":"","ucode":"7482099415C41C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537047,"discussion_content":"è§†é¢‘é“¾æ¥: https://youtu.be/skos4B5x7qE","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638945707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323866,"user_name":"ç½—åŒå­¦","can_delete":false,"product_type":"c1","uid":1649119,"ip_address":"","ucode":"909B9EC768B9AD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vHujib2CCrUYNBaia32eIwTyJoAcl27vASZ9KGjSdnH1dJhD7CrSUicBib19Tf8nDibWaHjzIsvIfdqcXX6vGrH8bicw/132","comment_is_top":false,"comment_ctime":1638189315,"is_pvip":false,"replies":[{"id":"118876","content":"æ‰€æœ‰è€…è¿˜æ˜¯ä¹‹å‰çš„å˜é‡ï¼Œåªä¸è¿‡ä¸€èˆ¬ä¼šæŠŠå®ƒ shadow æ‰ï¼Œè¿™æ ·æ²¡æœ‰äººå¯ä»¥æ‹¿åˆ°ã€‚å½“è¿™ä¸ªå˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶è¿˜æ˜¯ä¼šè¢«å›æ”¶ã€‚<br><br>```rust<br>use std::pin::Pin;<br><br>fn main() {<br>    let s = &quot;hello&quot;.to_string();<br>    println!(&quot;addr of s(stack): {:p}&quot;, &amp;s);<br>    let s = Pin::new(s);<br>    println!(&quot;addr of pinned s: {:p}&quot;, &amp;s);<br>}<br>```","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639849850,"ip_address":"","comment_id":323866,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10228123907","product_id":100085301,"comment_content":"Pinäº†åçš„æ•°æ® æ‰€æœ‰è€…å˜æˆè°äº†?","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539837,"discussion_content":"æ‰€æœ‰è€…è¿˜æ˜¯ä¹‹å‰çš„å˜é‡ï¼Œåªä¸è¿‡ä¸€èˆ¬ä¼šæŠŠå®ƒ shadow æ‰ï¼Œè¿™æ ·æ²¡æœ‰äººå¯ä»¥æ‹¿åˆ°ã€‚å½“è¿™ä¸ªå˜é‡ç¦»å¼€ä½œç”¨åŸŸæ—¶è¿˜æ˜¯ä¼šè¢«å›æ”¶ã€‚\n\n```rust\nuse std::pin::Pin;\n\nfn main() {\n    let s = &#34;hello&#34;.to_string();\n    println!(&#34;addr of s(stack): {:p}&#34;, &amp;s);\n    let s = Pin::new(s);\n    println!(&#34;addr of pinned s: {:p}&#34;, &amp;s);\n}\n```","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639849850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336642,"user_name":"è€è€","can_delete":false,"product_type":"c1","uid":1214893,"ip_address":"","ucode":"C32E743518DECD","user_header":"https://static001.geekbang.org/account/avatar/00/12/89/ad/4efd929a.jpg","comment_is_top":false,"comment_ctime":1646271648,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646271648","product_id":100085301,"comment_content":"äºŒåˆ·â€¦è€å¸ˆçš„è¯¾å¤ªè‰¯å¿ƒäº†â€¦","like_count":0},{"had_liked":false,"id":335364,"user_name":"æ¸…é£å¾æ¥","can_delete":false,"product_type":"c1","uid":1202697,"ip_address":"","ucode":"2AAA5B8DE30DF9","user_header":"https://static001.geekbang.org/account/avatar/00/12/5a/09/afa3e112.jpg","comment_is_top":false,"comment_ctime":1645489075,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645489075","product_id":100085301,"comment_content":"æœ‰äº†Pinä¸ºå•¥è¿˜æœ‰!UnPin","like_count":0},{"had_liked":false,"id":331439,"user_name":"JK.Ryan","can_delete":false,"product_type":"c1","uid":1014467,"ip_address":"","ucode":"D1E533F3DEC481","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7a/c3/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1642586000,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642586000","product_id":100085301,"comment_content":"åº–ä¸è§£ç‰›ï¼Œå¾ˆèµ~ğŸ‘ğŸ»","like_count":0},{"had_liked":false,"id":330441,"user_name":"wowotuo","can_delete":false,"product_type":"c1","uid":1141192,"ip_address":"","ucode":"D87BCBD3EA61A9","user_header":"https://static001.geekbang.org/account/avatar/00/11/69/c8/d6f00a46.jpg","comment_is_top":false,"comment_ctime":1641978670,"is_pvip":false,"replies":[{"id":"120691","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1642292939,"ip_address":"","comment_id":330441,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641978670","product_id":100085301,"comment_content":"è®²å¾—å¾ˆç‰›é€¼ï¼Œç°åœ¨ååå¤å¤å¬äº†çœ‹äº†ä¸ä¸‹10æ¬¡","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546300,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642292939,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326934,"user_name":"dva","can_delete":false,"product_type":"c1","uid":2101988,"ip_address":"","ucode":"EE27DAFCBF198D","user_header":"https://static001.geekbang.org/account/avatar/00/20/12/e4/57ade29a.jpg","comment_is_top":false,"comment_ctime":1639763297,"is_pvip":false,"replies":[{"id":"120822","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1642311514,"ip_address":"","comment_id":326934,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639763297","product_id":100085301,"comment_content":"Box&lt;T&gt;æ˜¯Unpinï¼Œå› ä¸ºBox&lt;T&gt;å®ç°äº†Unpin trait","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546467,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642311514,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323784,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1638160092,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1638160092","product_id":100085301,"comment_content":"ä»åŸºç¡€åˆ°åŸç†å¥½å¥½ç ”ç©¶ Futureã€‚","like_count":0},{"had_liked":false,"id":323746,"user_name":"è‰¯å¸ˆç›Šå‹","can_delete":false,"product_type":"c1","uid":1614999,"ip_address":"","ucode":"02B0B2FDDDAE6A","user_header":"https://static001.geekbang.org/account/avatar/00/18/a4/97/bc269801.jpg","comment_is_top":false,"comment_ctime":1638149620,"is_pvip":false,"replies":[{"id":"118877","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639849865,"ip_address":"","comment_id":323746,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638149620","product_id":100085301,"comment_content":"ä»¥å‰åœ¨è¿™é‡Œå¡ä½äº†ï¼Œè¿™æ¬¡è¯´æ˜ç™½äº†ï¼Œæ„Ÿè°¢è€å¸ˆ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539838,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639849866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}