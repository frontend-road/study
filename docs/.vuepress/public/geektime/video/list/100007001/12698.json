{"id":12698,"title":"75 | CAT 埋点案例和代码剖析（Code Review）","content":"无","comments":[{"had_liked":false,"id":56510,"user_name":"javaphe","can_delete":false,"product_type":"c3","uid":1028825,"ip_address":"","ucode":"90D1337CA56BD9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epQjesMialdm5Bib67q9Zpcqvn0MYFdibHFKV5AxuPxWrRUt6ia77n2gMEJ2uiba14ibIwXEdxicZatq01bQ/132","comment_is_top":false,"comment_ctime":1546479583,"is_pvip":false,"replies":[{"id":20560,"content":"你好，课程中为了演示目的，我主要是手工埋点的，实际生产中一般由独立框架团队集中对框架组件（服务框架，消息，缓存，数据访层等）进行集中埋点，业务团队只要用这些框架组件就可以了，一般不用自己埋点，接入成本不高，一旦接入形成规模后价值很大，你可以这样和大家宣讲推广。另外，你的意见已经反馈极客时间，谢谢！","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1546605789,"ip_address":"","comment_id":56510,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师的课讲的还是非常详细！问题:如此埋点业务开发同学不会抗拒吗，怎么去说服他们，而且随着人员流动，怎么保证后来人也遵守？\n给极客时间提几个问题:播放做的真烂，首先没缓存每次都得联网听很不方便，其次根本记不住我学到哪儿，每次再听都得先去找课再拖动，最后也没个对课程点赞，打分等机制，促进学生老师相互了解。","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435081,"discussion_content":"你好，课程中为了演示目的，我主要是手工埋点的，实际生产中一般由独立框架团队集中对框架组件（服务框架，消息，缓存，数据访层等）进行集中埋点，业务团队只要用这些框架组件就可以了，一般不用自己埋点，接入成本不高，一旦接入形成规模后价值很大，你可以这样和大家宣讲推广。另外，你的意见已经反馈极客时间，谢谢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546605789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70557,"user_name":"焦义贵 /::","can_delete":false,"product_type":"c3","uid":1009878,"ip_address":"","ucode":"8EA54F23058F4C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/68/d6/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1551141335,"is_pvip":false,"replies":[{"id":25575,"content":"你好，简单做法，feign支持RequestInterceptor，可以截获request，支持将CAT context上下文向后端传递；另外feign可以启用OkHttpClient，它支持Interceptor，可以同时截获request&#47;response，可以用CAT transaction埋点并向后传递context上下文。如果需要更细致埋点，可以参考spring cloud sleuth的源码，它支持zipkin可以参考，它用到aop等高级技术进行埋点。spring feign可以参考：https:&#47;&#47;cloud.spring.io&#47;spring-cloud-netflix&#47;multi&#47;multi_spring-cloud-feign.html","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1551359122,"ip_address":"","comment_id":70557,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"feign调用怎么埋点","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440691,"discussion_content":"你好，简单做法，feign支持RequestInterceptor，可以截获request，支持将CAT context上下文向后端传递；另外feign可以启用OkHttpClient，它支持Interceptor，可以同时截获request/response，可以用CAT transaction埋点并向后传递context上下文。如果需要更细致埋点，可以参考spring cloud sleuth的源码，它支持zipkin可以参考，它用到aop等高级技术进行埋点。spring feign可以参考：https://cloud.spring.io/spring-cloud-netflix/multi/multi_spring-cloud-feign.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551359122,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":68130,"user_name":"秋之恋歌","can_delete":false,"product_type":"c3","uid":1116360,"ip_address":"","ucode":"6BC5C3C2FB845C","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/c8/85dcaac0.jpg","comment_is_top":false,"comment_ctime":1550423815,"is_pvip":false,"replies":[{"id":24395,"content":"你好，CAT源码里头有个log4j CatAppender，启用后自动把error日志记录在CAT里头，你可以直接用https:&#47;&#47;github.com&#47;dianping&#47;cat&#47;blob&#47;master&#47;cat-client&#47;src&#47;main&#47;java&#47;com&#47;dianping&#47;cat&#47;log4j&#47;CatAppender.java","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1550576414,"ip_address":"","comment_id":68130,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师能讲解下CAT与log4j的集成过程吗？官方文档写的太简单了。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439530,"discussion_content":"你好，CAT源码里头有个log4j CatAppender，启用后自动把error日志记录在CAT里头，你可以直接用https://github.com/dianping/cat/blob/master/cat-client/src/main/java/com/dianping/cat/log4j/CatAppender.java","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550576414,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":25258,"user_name":"sayid","can_delete":false,"product_type":"c3","uid":1101465,"ip_address":"","ucode":"E40E0D86768DCA","user_header":"https://static001.geekbang.org/account/avatar/00/10/ce/99/4382727b.jpg","comment_is_top":false,"comment_ctime":1537279122,"is_pvip":false,"replies":[{"id":9631,"content":"希望对你有帮助，加油💪","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1537674907,"ip_address":"","comment_id":25258,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"学到了cat跨进程调用，上下文记录父子id的方法，谢谢波波老师！","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":424235,"discussion_content":"希望对你有帮助，加油💪","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1537674907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244121,"user_name":"J.Smile","can_delete":false,"product_type":"c3","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg","comment_is_top":false,"comment_ctime":1598405443,"is_pvip":false,"replies":[{"id":90030,"content":"对，你看得很仔细。Interceptor如果new了一个，就不需要@Component注解了，这个注解应该可以去掉。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1598615420,"ip_address":"","comment_id":244121,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"代码中的Interceptor已经new了一个，为啥定义的类上还要加@Component注解嘞？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504490,"discussion_content":"对，你看得很仔细。Interceptor如果new了一个，就不需要@Component注解了，这个注解应该可以去掉。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598615420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103893,"user_name":"💀WILL-beta💀","can_delete":false,"product_type":"c3","uid":1044424,"ip_address":"","ucode":"22DA1271C705B3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ef/c8/9d9581cb.jpg","comment_is_top":false,"comment_ctime":1560560583,"is_pvip":false,"replies":[{"id":37713,"content":"CAT的日志主要是和调用链相关的，一般不建议把所有日志都记录在CAT调用链上，而是有选择性的记录一些，比如异常，或者和调用链有紧密关系的业务上下文日志等。其它日志建议采用ELK，ELK是日志采集和存储标配，它存储容量大，搜索能力强。CAT也不能存大量日志(否则影响性能)，也不支持按需搜索。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1560683102,"ip_address":"","comment_id":103893,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"看到CAT可以用来写日志，尤其是Error，那请问是不是就可以不用专门的日志系统了呢？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454044,"discussion_content":"CAT的日志主要是和调用链相关的，一般不建议把所有日志都记录在CAT调用链上，而是有选择性的记录一些，比如异常，或者和调用链有紧密关系的业务上下文日志等。其它日志建议采用ELK，ELK是日志采集和存储标配，它存储容量大，搜索能力强。CAT也不能存大量日志(否则影响性能)，也不支持按需搜索。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560683102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67168,"user_name":"正是那朵玫瑰","can_delete":false,"product_type":"c3","uid":1048261,"ip_address":"","ucode":"73D630B654573F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg","comment_is_top":false,"comment_ctime":1550107056,"is_pvip":false,"replies":[{"id":24020,"content":"CAT主要目标是调用链监控，在调用链上也可以适当添加一些上下文日志(也称标注annotation)，或者调用异常日志，但日志存储和查询不是CAT强项。常规日志则需要专门的监控系统，业界常用是ElasticSearch&#47;Logstash&#47;Kibana(简称ELK)，这类系统专门为大规模日志存储和查询而设计。实践中，CAT和ELK经常配合使用。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1550317303,"ip_address":"","comment_id":67168,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"业务打印log.info的日志好像没有上传到cat吧，如果要查看这些日志需要另外的额日志收集工具？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439090,"discussion_content":"CAT主要目标是调用链监控，在调用链上也可以适当添加一些上下文日志(也称标注annotation)，或者调用异常日志，但日志存储和查询不是CAT强项。常规日志则需要专门的监控系统，业界常用是ElasticSearch/Logstash/Kibana(简称ELK)，这类系统专门为大规模日志存储和查询而设计。实践中，CAT和ELK经常配合使用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550317303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31339,"user_name":"旺旺","can_delete":false,"product_type":"c3","uid":1071540,"ip_address":"","ucode":"F142788C4B111F","user_header":"https://static001.geekbang.org/account/avatar/00/10/59/b4/ad3f1ffa.jpg","comment_is_top":false,"comment_ctime":1539154552,"is_pvip":false,"replies":[{"id":11723,"content":"CAT里头的logMetric是只给业务大盘用的，统计展示一些较重要业务指标（如登录，下单等）。其它dashboard上展示的matrix等报表是通过分析调用链计算出来的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1539514737,"ip_address":"","comment_id":31339,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"你好，我想请问一下，为什么我加了logMetricForCount和logMetricForSum这个指标统计，在Cat的监控界面没有单独显示的页面，而官方给的例子是有专门的”Mectrics实时报表“展示页面的，谢谢","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":426299,"discussion_content":"CAT里头的logMetric是只给业务大盘用的，统计展示一些较重要业务指标（如登录，下单等）。其它dashboard上展示的matrix等报表是通过分析调用链计算出来的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539514737,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":68726,"user_name":"秋之恋歌","can_delete":false,"product_type":"c3","uid":1116360,"ip_address":"","ucode":"6BC5C3C2FB845C","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/c8/85dcaac0.jpg","comment_is_top":false,"comment_ctime":1550587450,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"谢谢老师提示，现在已经跑起来了，只是一开始缺少很多jar包，需要自己单独去下载引入。记录于此，供后来者参考。","like_count":0}]}