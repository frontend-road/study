{"id":399866,"title":"01 | å¸¦ä½ å¿«é€Ÿæ”»ç•¥Redisæºç çš„æ•´ä½“æ¶æ„","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è’‹å¾·é’§ã€‚ä»ä»Šå¤©è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¼€å¯â€œRedisä»£ç ä¹‹æ—…â€ï¼Œä¸€èµ·æ¥æŒæ¡Redisçš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨æ­£å¼å¼€å§‹æˆ‘ä»¬çš„æ—…ç¨‹ä¹‹å‰ï¼Œè¿˜éœ€è¦å…ˆåšä¸ªâ€œæ”»ç•¥â€ï¼Œä¹Ÿå°±æ˜¯è¦äº†è§£å’ŒæŒæ¡Redisä»£ç çš„æ•´ä½“æ¶æ„ã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼Œä¸€æ—¦æŒæ¡äº†Redisä»£ç çš„æ•´ä½“æ¶æ„ï¼Œå°±ç›¸å½“äºç»™Redisä»£ç ç”»äº†å¼ å…¨æ™¯å›¾ã€‚æœ‰äº†è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å†å»å­¦ä¹ Redisä¸åŒåŠŸèƒ½æ¨¡å—çš„è®¾è®¡ä¸å®ç°æ—¶ï¼Œå°±å¯ä»¥ä»å›¾ä¸Šå¿«é€ŸæŸ¥æ‰¾å’Œå®šä½è¿™äº›åŠŸèƒ½æ¨¡å—å¯¹åº”çš„ä»£ç æ–‡ä»¶ã€‚è€Œä¸”ï¼Œæœ‰äº†ä»£ç çš„å…¨æ™¯å›¾ä¹‹åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹Rediså„æ–¹é¢çš„åŠŸèƒ½ç‰¹æ€§æœ‰ä¸ªå…¨é¢äº†è§£ï¼Œè¿™æ ·ä¹Ÿä¾¿äºæ›´åŠ å…¨é¢åœ°æŒæ¡Redisçš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šé—æ¼æŸä¸€ç‰¹æ€§ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ç©¶ç«Ÿè¯¥å¦‚ä½•å­¦ä¹ Redisçš„ä»£ç æ¶æ„å‘¢ï¼Ÿæˆ‘çš„å»ºè®®æ˜¯è¦æŒæ¡ä»¥ä¸‹ä¸¤æ–¹é¢å†…å®¹ï¼š</p><ul>\n<li><strong>ä»£ç çš„ç›®å½•ç»“æ„å’Œä½œç”¨åˆ’åˆ†</strong>ï¼Œç›®çš„æ˜¯ç†è§£Redisä»£ç çš„æ•´ä½“æ¶æ„ï¼Œä»¥åŠæ‰€åŒ…å«çš„ä»£ç åŠŸèƒ½ç±»åˆ«ï¼›</li>\n<li><strong>ç³»ç»ŸåŠŸèƒ½æ¨¡å—ä¸å¯¹åº”ä»£ç æ–‡ä»¶</strong>ï¼Œç›®çš„æ˜¯äº†è§£Rediså®ä¾‹æä¾›çš„å„é¡¹åŠŸèƒ½åŠå…¶ç›¸åº”çš„å®ç°æ–‡ä»¶ï¼Œä»¥ä¾¿åç»­æ·±å…¥å­¦ä¹ ã€‚</li>\n</ul><p>å®é™…ä¸Šï¼Œå½“ä½ æŒæ¡äº†ä»¥ä¸Šä¸¤æ–¹é¢çš„å†…å®¹ä¹‹åï¼Œå³ä½¿ä½ è¦å»äº†è§£å’Œå­¦ä¹ å…¶ä»–è½¯ä»¶ç³»ç»Ÿçš„ä»£ç æ¶æ„ï¼Œä½ éƒ½å¯ä»¥æŒ‰ç…§â€œå…ˆé¢åç‚¹â€çš„æ–¹æ³•æ¥æ¨è¿›ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…ˆäº†è§£ç›®å½•ç»“æ„ä¸ä½œç”¨ç±»åˆ«ï¼Œå†å¯¹åº”åŠŸèƒ½æ¨¡å—ä¸å®ç°æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿåœ°æŒæ¡ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿçš„ä»£ç å…¨æ™¯ã€‚</p><!-- [[[read_end]]] --><p>æ‰€ä»¥ï¼Œåœ¨åç»­çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œä½ è¦ä»”ç»†è·Ÿä½æˆ‘çš„è„šæ­¥ï¼Œå¹¶ä¸”æ‰‹è¾¹æœ€å¥½èƒ½å¤‡ç€ä¸€å°å¯ä»¥æ–¹ä¾¿æŸ¥çœ‹æºç çš„ç”µè„‘ï¼Œé’ˆå¯¹æˆ‘æåˆ°çš„æºç æ–‡ä»¶ã€å…³é”®æ¨¡å—æˆ–æ˜¯ä»£ç è¿è¡Œï¼Œä¸€å®šè¦å®é™…é˜…è¯»ä¸€éæˆ–æ˜¯å®æ“ä¸€éï¼Œè¿™æ ·ä½ å°±èƒ½å¯¹Redisçš„ä»£ç æ¶æ„å»ºç«‹æ›´æ·±åˆ»çš„è®¤è¯†ã€‚</p><p>å¥½äº†ï¼Œè¯ä¸å¤šè¯´ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä¸€èµ·æ¥å®ŒæˆRedisä»£ç ä¹‹æ—…çš„æ”»ç•¥å§ã€‚</p><h2>Redisç›®å½•ç»“æ„</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹Redisçš„ç›®å½•ç»“æ„ã€‚</p><p>ä¸ºä»€ä¹ˆè¦ä»ç›®å½•ç»“æ„å¼€å§‹äº†è§£å‘¢ï¼Ÿå…¶å®ï¼Œè¿™æ˜¯æˆ‘è‡ªå·±<strong>é˜…è¯»ä»£ç çš„ä¸€ä¸ªå°è¯€çª</strong>ï¼šåœ¨å­¦ä¹ ä¸€ä¸ªå¤§å‹ç³»ç»Ÿè½¯ä»¶çš„ä»£ç æ—¶ï¼Œè¦æƒ³å¿«é€Ÿåœ°å¯¹ä»£ç æœ‰ä¸ªåˆæ­¥è®¤çŸ¥ï¼Œäº†è§£ç³»ç»Ÿæºç çš„æ•´ä½“ç›®å½•ç»“æ„å°±æ˜¯ä¸€ä¸ªè¡Œä¹‹æœ‰æ•ˆçš„æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸ºï¼Œç³»ç»Ÿå¼€å‘è€…é€šå¸¸ä¼šæŠŠå®ŒæˆåŒä¸€æˆ–ç›¸è¿‘åŠŸèƒ½çš„ä»£ç æ–‡ä»¶ï¼ŒæŒ‰ç›®å½•ç»“æ„æ¥ç»„ç»‡ã€‚èƒ½åˆ’å½’åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹çš„ä»£ç æ–‡ä»¶ï¼Œä¸€èˆ¬éƒ½æ˜¯å…·æœ‰ç›¸è¿‘åŠŸèƒ½ç›®æ ‡çš„ã€‚</p><p>æ‰€ä»¥ï¼Œä»ä»£ç çš„ç›®å½•ç»“æ„å¼€å§‹å­¦ä¹ ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä»ç›®å½•å‘½åå’Œç›®å½•å±‚æ¬¡ç»“æ„ä¸­ï¼Œç›´æ¥äº†è§£åˆ°ä¸€ä¸ªç³»ç»Ÿçš„ä¸»è¦ç»„æˆéƒ¨åˆ†ã€‚</p><p>é‚£ä¹ˆå¯¹äºRedisæ¥è¯´ï¼Œåœ¨å®ƒçš„æºç æ€»ç›®å½•ä¸‹ï¼Œä¸€å…±åŒ…å«äº†<a href=\"https://github.com/redis/redis/tree/5.0/deps\">deps</a>ã€<a href=\"https://github.com/redis/redis/tree/5.0/src\">src</a>ã€<a href=\"https://github.com/redis/redis/tree/5.0/tests\">tests</a>ã€<a href=\"https://github.com/redis/redis/tree/5.0/utils\">utils</a>å››ä¸ªå­ç›®å½•ï¼Œè¿™å››ä¸ªå­ç›®å½•åˆ†åˆ«å¯¹åº”äº†Redisä¸­å‘æŒ¥ä¸åŒä½œç”¨çš„ä»£ç ï¼Œä¸‹é¢æˆ‘ä»¬å…·ä½“æ¥çœ‹çœ‹ã€‚</p><h3>depsç›®å½•</h3><p>è¿™ä¸ªç›®å½•ä¸»è¦<strong>åŒ…å«äº†Redisä¾èµ–çš„ç¬¬ä¸‰æ–¹ä»£ç åº“</strong>ï¼ŒåŒ…æ‹¬Redisçš„Cè¯­è¨€ç‰ˆæœ¬å®¢æˆ·ç«¯ä»£ç hiredisã€jemallocå†…å­˜åˆ†é…å™¨ä»£ç ã€readlineåŠŸèƒ½çš„æ›¿ä»£ä»£ç linenoiseï¼Œä»¥åŠluaè„šæœ¬ä»£ç ã€‚</p><p>è¿™éƒ¨åˆ†ä»£ç çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹ï¼Œå°±æ˜¯<strong>å®ƒä»¬å¯ä»¥ç‹¬ç«‹äºRedis srcç›®å½•ä¸‹çš„åŠŸèƒ½æºç è¿›è¡Œç¼–è¯‘</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬å¯ä»¥ç‹¬ç«‹äºRediså­˜åœ¨å’Œå‘å±•ã€‚ä¸‹é¢è¿™å¼ å›¾æ˜¾ç¤ºäº†depsç›®å½•ä¸‹çš„å­ç›®å½•å†…å®¹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/42/c7/4278463fb96f165bf41d6a97ff3216c7.jpg?wh=1945x726\" alt=\"\"></p><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆåœ¨Redisæºç ç»“æ„ä¸­ä¼šæœ‰ç¬¬ä¸‰æ–¹ä»£ç åº“ç›®å½•å‘¢ï¼Ÿå…¶å®ä¸»è¦æœ‰ä¸¤æ–¹é¢çš„åŸå› ã€‚</p><p><strong>ä¸€æ–¹é¢</strong>ï¼ŒRedisä½œä¸ºä¸€ä¸ªç”¨Cè¯­è¨€å†™çš„ç”¨æˆ·æ€ç¨‹åºï¼Œå®ƒçš„ä¸å°‘åŠŸèƒ½æ˜¯ä¾èµ–äºæ ‡å‡†çš„glibcåº“æä¾›çš„ï¼Œæ¯”å¦‚å†…å­˜åˆ†é…ã€è¡Œè¯»å†™ï¼ˆreadlineï¼‰ã€æ–‡ä»¶è¯»å†™ã€å­è¿›ç¨‹/çº¿ç¨‹åˆ›å»ºç­‰ã€‚ä½†æ˜¯ï¼Œglibcåº“æä¾›çš„æŸäº›åŠŸèƒ½å®ç°ï¼Œæ•ˆç‡å¹¶ä¸é«˜ã€‚</p><p>æˆ‘ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œglibcåº“ä¸­å®ç°çš„å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½å°±ä¸æ˜¯å¾ˆé«˜ï¼Œå®ƒçš„å†…å­˜ç¢ç‰‡åŒ–æƒ…å†µä¹Ÿæ¯”è¾ƒä¸¥é‡ã€‚å› æ­¤ä¸ºäº†é¿å…å¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿå½±å“ï¼ŒRedisä½¿ç”¨äº†jemallocåº“æ›¿æ¢äº†glibcåº“çš„å†…å­˜åˆ†é…å™¨ã€‚å¯æ˜¯ï¼Œjemallocåº“æœ¬èº«åˆä¸å±äºRedisç³»ç»Ÿè‡ªèº«çš„åŠŸèƒ½ï¼ŒæŠŠå®ƒå’ŒRedisåŠŸèƒ½æºç æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹å¹¶ä¸åˆé€‚ï¼Œæ‰€ä»¥ï¼ŒRedisä½¿ç”¨äº†ä¸“é—¨çš„depsç›®å½•æ¥ä¿å­˜è¿™éƒ¨åˆ†ä»£ç ã€‚</p><p><strong>å¦ä¸€æ–¹é¢</strong>ï¼Œæœ‰äº›åŠŸèƒ½æ˜¯Redisè¿è¡Œæ‰€éœ€è¦çš„ï¼Œä½†æ˜¯è¿™éƒ¨åˆ†åŠŸèƒ½åˆä¼šç‹¬ç«‹äºRedisè¿›è¡Œå¼€å‘å’Œæ¼”è¿›ã€‚è¿™ç§ç±»å‹æœ€ä¸ºå…¸å‹çš„åŠŸèƒ½ä»£ç ï¼Œå°±æ˜¯Redisçš„å®¢æˆ·ç«¯ä»£ç ã€‚</p><p>Redisä½œä¸ºClient-Serveræ¶æ„çš„ç³»ç»Ÿï¼Œè®¿é—®Redisç¦»ä¸å¼€å®¢æˆ·ç«¯çš„æ”¯æ’‘ã€‚æ­¤å¤–ï¼ŒRedisè‡ªèº«åŠŸèƒ½ä¸­çš„å‘½ä»¤è¡Œredis-cliã€åŸºå‡†æµ‹è¯•ç¨‹åºredis-benchmarkä»¥åŠå“¨å…µï¼Œéƒ½éœ€è¦ç”¨åˆ°å®¢æˆ·ç«¯æ¥è®¿é—®Rediså®ä¾‹ã€‚</p><p>ä¸è¿‡ä½ åº”è¯¥ä¹Ÿæ¸…æ¥šï¼Œé’ˆå¯¹å®¢æˆ·ç«¯çš„å¼€å‘ï¼Œåªè¦ä¿è¯å®¢æˆ·ç«¯å’Œå®ä¾‹äº¤äº’çš„è¿‡ç¨‹æ»¡è¶³RESPåè®®å°±è¡Œï¼Œå®¢æˆ·ç«¯å’Œå®ä¾‹çš„åŠŸèƒ½å¯ä»¥å„è‡ªè¿­ä»£æ¼”è¿›ã€‚æ‰€ä»¥åœ¨Redisæºç ç»“æ„ä¸­ï¼ŒCè¯­è¨€ç‰ˆæœ¬çš„å®¢æˆ·ç«¯hiredisï¼Œå°±è¢«æ”¾åˆ°äº†depsç›®å½•ä¸­ï¼Œä»¥ä¾¿å¼€å‘äººå‘˜è‡ªè¡Œå¼€å‘å’Œæ”¹è¿›å®¢æˆ·ç«¯åŠŸèƒ½ã€‚</p><p>å¥½äº†ï¼Œæ€»è€Œè¨€ä¹‹ï¼Œå¯¹äºdepsç›®å½•æ¥è¯´ï¼Œä½ åªéœ€è¦è®°ä½å®ƒä¸»è¦å­˜æ”¾äº†ä¸‰ç±»ä»£ç ï¼šä¸€æ˜¯Redisä¾èµ–çš„ã€å®ç°æ›´åŠ é«˜æ•ˆçš„åŠŸèƒ½åº“ï¼Œå¦‚å†…å­˜åˆ†é…ï¼›äºŒæ˜¯ç‹¬ç«‹äºRediså¼€å‘æ¼”è¿›çš„ä»£ç ï¼Œå¦‚å®¢æˆ·ç«¯ï¼›ä¸‰æ˜¯luaè„šæœ¬ä»£ç ã€‚åç»­ä½ åœ¨å­¦ä¹ è¿™äº›åŠŸèƒ½çš„è®¾è®¡å®ç°æ—¶ï¼Œå°±å¯ä»¥åœ¨depsç›®å½•æ‰¾åˆ°å®ƒä»¬ã€‚</p><h3>srcç›®å½•</h3><p>è¿™ä¸ªç›®å½•é‡Œé¢<strong>åŒ…å«äº†Redisæ‰€æœ‰åŠŸèƒ½æ¨¡å—çš„ä»£ç æ–‡ä»¶ï¼Œä¹Ÿæ˜¯Redisæºç çš„é‡è¦ç»„æˆéƒ¨åˆ†</strong>ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹srcç›®å½•ä¸‹çš„å­ç›®å½•ç»“æ„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d7/26/d7ac6b01af49047409db5d9e16b6e826.jpg?wh=2187x487\" alt=\"\"></p><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œsrcç›®å½•ä¸‹åªæœ‰ä¸€ä¸ªmoduleså­ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªå®ç°Redis moduleçš„ç¤ºä¾‹ä»£ç ã€‚å‰©ä½™çš„æºç æ–‡ä»¶éƒ½æ˜¯åœ¨srcç›®å½•ä¸‹ï¼Œæ²¡æœ‰å†åˆ†ä¸‹ä¸€çº§å­ç›®å½•ã€‚</p><p>å› ä¸ºRedisçš„åŠŸèƒ½æ¨¡å—å®ç°æ˜¯å…¸å‹çš„Cè¯­è¨€é£æ ¼ï¼Œä¸åŒåŠŸèƒ½æ¨¡å—ä¹‹é—´ä¸å†è®¾ç½®ç›®å½•åˆ†éš”ï¼Œè€Œæ˜¯é€šè¿‡å¤´æ–‡ä»¶åŒ…å«æ¥ç›¸äº’è°ƒç”¨ã€‚è¿™æ ·çš„ä»£ç é£æ ¼åœ¨åŸºäºCè¯­è¨€å¼€å‘çš„ç³»ç»Ÿè½¯ä»¶ä¸­ï¼Œä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œæ¯”å¦‚Memcachedçš„æºç æ–‡ä»¶ä¹Ÿæ˜¯åœ¨åŒä¸€çº§ç›®å½•ä¸‹ã€‚</p><p>æ‰€ä»¥ï¼Œå½“ä½ ä½¿ç”¨Cè¯­è¨€æ¥å¼€å‘è½¯ä»¶ç³»ç»Ÿæ—¶ï¼Œå°±å¯ä»¥å‚è€ƒRedisçš„åŠŸèƒ½æºç ç»“æ„ï¼Œç”¨ä¸€ä¸ªæ‰å¹³çš„ç›®å½•ç»„ç»‡æ‰€æœ‰çš„æºç æ–‡ä»¶ï¼Œè¿™æ ·æ¨¡å—ç›¸äº’é—´çš„å¼•ç”¨ä¹Ÿä¼šå¾ˆæ–¹ä¾¿ã€‚</p><h3>testsç›®å½•</h3><p>åœ¨è½¯ä»¶äº§å“çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé™¤äº†ç¬¬ä¸‰æ–¹ä¾èµ–åº“å’ŒåŠŸèƒ½æ¨¡å—æºç ä»¥å¤–ï¼Œæˆ‘ä»¬é€šå¸¸è¿˜éœ€è¦åœ¨ç³»ç»Ÿæºç ä¸­ï¼Œæ·»åŠ ç”¨äºåŠŸèƒ½æ¨¡å—æµ‹è¯•å’Œå•å…ƒæµ‹è¯•çš„ä»£ç ã€‚è€Œåœ¨Redisçš„ä»£ç ç›®å½•ä¸­ï¼Œå°±å°†è¿™éƒ¨åˆ†ä»£ç ç”¨ä¸€ä¸ªtestsç›®å½•ç»Ÿä¸€ç®¡ç†äº†èµ·æ¥ã€‚</p><p>Rediså®ç°çš„æµ‹è¯•ä»£ç å¯ä»¥åˆ†æˆå››éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯<strong>å•å…ƒæµ‹è¯•</strong>ï¼ˆå¯¹åº”unitå­ç›®å½•ï¼‰ï¼Œ<strong>Redis ClusteråŠŸèƒ½æµ‹è¯•</strong>ï¼ˆå¯¹åº”clusterå­ç›®å½•ï¼‰ã€<strong>å“¨å…µåŠŸèƒ½æµ‹è¯•</strong>ï¼ˆå¯¹åº”sentinelå­ç›®å½•ï¼‰ã€<strong>ä¸»ä»å¤åˆ¶åŠŸèƒ½æµ‹è¯•</strong>ï¼ˆå¯¹åº”integrationå­ç›®å½•ï¼‰ã€‚è¿™äº›å­ç›®å½•ä¸­çš„æµ‹è¯•ä»£ç ä½¿ç”¨äº†Tclè¯­è¨€ï¼ˆé€šç”¨çš„è„šæœ¬è¯­è¨€ï¼‰è¿›è¡Œç¼–å†™ï¼Œä¸»è¦ç›®çš„å°±æ˜¯æ–¹ä¾¿è¿›è¡Œæµ‹è¯•ã€‚</p><p>å¦å¤–ï¼Œæ¯ä¸€éƒ¨åˆ†çš„æµ‹è¯•éƒ½æ˜¯ä¸€ä¸ªæµ‹è¯•é›†åˆï¼Œè¦†ç›–äº†ç›¸åº”åŠŸèƒ½æ¨¡å—ä¸­çš„å¤šé¡¹å­åŠŸèƒ½æµ‹è¯•ã€‚æ¯”å¦‚ï¼Œåœ¨å•å…ƒæµ‹è¯•çš„ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰é’ˆå¯¹è¿‡æœŸkeyçš„æµ‹è¯•ï¼ˆexpire.tclï¼‰ã€æƒ°æ€§åˆ é™¤çš„æµ‹è¯•ï¼ˆlazyfree.tclï¼‰ï¼Œä»¥åŠä¸åŒæ•°æ®ç±»å‹æ“ä½œçš„æµ‹è¯•ï¼ˆtypeå­ç›®å½•ï¼‰ç­‰ã€‚è€Œåœ¨Redis ClusteråŠŸèƒ½æµ‹è¯•çš„ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰é’ˆå¯¹æ•…éšœåˆ‡æ¢çš„æµ‹è¯•ï¼ˆfailover.tclï¼‰ã€å‰¯æœ¬è¿ç§»çš„æµ‹è¯•ï¼ˆreplica-migration.tclï¼‰ç­‰ã€‚</p><p>ä¸è¿‡åœ¨testsç›®å½•ä¸­ï¼Œé™¤äº†æœ‰é’ˆå¯¹ç‰¹å®šåŠŸèƒ½æ¨¡å—çš„æµ‹è¯•ä»£ç å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä»£ç æ˜¯<strong>ç”¨æ¥æ”¯æ’‘æµ‹è¯•åŠŸèƒ½</strong>çš„ï¼Œè¿™äº›ä»£ç åœ¨assetsã€helpersã€modulesã€supportå››ä¸ªç›®å½•ä¸­ã€‚è¿™é‡Œæˆ‘ç”»äº†è¿™å¼ å›¾ï¼Œå±•ç¤ºäº†testsç›®å½•ä¸‹çš„ä»£ç ç»“æ„å’Œå±‚æ¬¡ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/cc/5e/ccb2feae193e4911cc68a0ccb755ac5e.jpg?wh=2250x1111\" alt=\"\"></p><h3>utilsç›®å½•</h3><p>åœ¨Rediså¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€äº›åŠŸèƒ½å±äºè¾…åŠ©æ€§åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨äºåˆ›å»ºRedis Clusterçš„è„šæœ¬ã€ç”¨äºæµ‹è¯•LRUç®—æ³•æ•ˆæœçš„ç¨‹åºï¼Œä»¥åŠå¯è§†åŒ–rehashè¿‡ç¨‹çš„ç¨‹åºã€‚åœ¨Redisä»£ç ç»“æ„ä¸­ï¼Œè¿™äº›åŠŸèƒ½ä»£ç éƒ½è¢«å½’ç±»åˆ°äº†utilsç›®å½•ä¸­ç»Ÿä¸€ç®¡ç†ã€‚ä¸‹å›¾å±•ç¤ºäº†utilsç›®å½•ä¸‹çš„ä¸»è¦å­ç›®å½•ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/b2/3b7933e5f1740ccdc3870ee554faf4b2.jpg?wh=2250x1039\" alt=\"\"></p><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨å¼€å‘ç³»ç»Ÿæ—¶ï¼Œå°±å¯ä»¥å­¦ä¹ Redisçš„ä»£ç ç»“æ„ï¼Œä¹ŸæŠŠå’Œç³»ç»Ÿç›¸å…³çš„è¾…åŠ©æ€§åŠŸèƒ½åˆ’å½’åˆ°utilsç›®å½•ä¸­ç»Ÿä¸€ç®¡ç†ã€‚</p><p>å¥½ï¼Œé™¤äº†depsã€srcã€testsã€utilså››ä¸ªå­ç›®å½•ä»¥å¤–ï¼ŒRedisæºç æ€»ç›®å½•ä¸‹å…¶å®è¿˜åŒ…å«äº†ä¸¤ä¸ªé‡è¦çš„é…ç½®æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯<strong>Rediså®ä¾‹çš„é…ç½®æ–‡ä»¶redis.conf</strong>ï¼Œå¦ä¸€ä¸ªæ˜¯<strong>å“¨å…µçš„é…ç½®æ–‡ä»¶sentinel.conf</strong>ã€‚å½“ä½ éœ€è¦æŸ¥æ‰¾æˆ–ä¿®æ”¹Rediså®ä¾‹æˆ–å“¨å…µçš„é…ç½®æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥å®šä½åˆ°æºç æ€»ç›®å½•ä¸‹ã€‚</p><p>æœ€åå‘¢ï¼Œä½ ä¹Ÿå¯ä»¥å†æ¬¡æ•´ä½“å›é¡¾ä¸‹Redisæºç çš„æ€»ä½“ç»“æ„å±‚æ¬¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/59/35/5975c57d9ac404fe3a774ea28a7ac935.jpg?wh=2238x811\" alt=\"\"></p><p>å¥½ï¼Œåœ¨äº†è§£äº†Redisçš„ä»£ç ç›®å½•å’Œå±‚æ¬¡ä»¥åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é‡ç‚¹å­¦ä¹ ä¸‹åŠŸèƒ½æ¨¡å—çš„æºç æ–‡ä»¶ï¼ˆå³srcç›®å½•ä¸‹çš„æ–‡ä»¶å†…å®¹ï¼‰ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬åœ¨åç»­è¯¾ç¨‹ä¸­å­¦ä¹ Redisçš„ç›¸å…³è®¾è®¡æ€æƒ³æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°å¯¹åº”çš„æºç æ–‡ä»¶ã€‚</p><h2>RedisåŠŸèƒ½æ¨¡å—ä¸æºç å¯¹åº”</h2><p>Redisä»£ç ç»“æ„ä¸­çš„srcç›®å½•ï¼ŒåŒ…å«äº†å®ç°åŠŸèƒ½æ¨¡å—çš„123ä¸ªä»£ç æ–‡ä»¶ã€‚åœ¨è¿™123ä¸ªä»£ç æ–‡ä»¶ä¸­ï¼Œå¯¹äºæŸä¸ªåŠŸèƒ½æ¥è¯´ï¼Œä¸€èˆ¬åŒ…æ‹¬äº†å®ç°è¯¥åŠŸèƒ½çš„ <strong>Cè¯­è¨€æ–‡ä»¶ï¼ˆ.cæ–‡ä»¶ï¼‰</strong> å’Œå¯¹åº”çš„<strong>å¤´æ–‡ä»¶ï¼ˆ.hæ–‡ä»¶ï¼‰</strong>ã€‚æ¯”å¦‚ï¼Œdict.cå’Œdict.hå°±æ˜¯ç”¨äºå®ç°å“ˆå¸Œè¡¨çš„Cæ–‡ä»¶å’Œå¤´æ–‡ä»¶ã€‚</p><blockquote>\n<p>æ³¨æ„ï¼šåœ¨è¯¾ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œæˆ‘ä»‹ç»çš„æºç éƒ½æ˜¯åŸºäºRedis 5.0.8ç‰ˆæœ¬çš„ã€‚</p>\n</blockquote><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å°†è¿™123ä¸ªæ–‡ä»¶å’ŒRedisçš„ä¸»è¦åŠŸèƒ½å¯¹åº”ä¸Šå‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œ<strong>Redisä»£ç æ–‡ä»¶çš„å‘½åéå¸¸è§„èŒƒï¼Œæ–‡ä»¶åä¸­å°±ä½“ç°äº†è¯¥æ–‡ä»¶å®ç°çš„ä¸»è¦åŠŸèƒ½ã€‚</strong>æ¯”å¦‚ï¼Œå¯¹äºrdb.hå’Œrdb.cè¿™ä¸¤ä¸ªä»£ç æ–‡ä»¶æ¥è¯´ï¼Œä»æ–‡ä»¶åä¸Šï¼Œä½ å°±å¯ä»¥çœ‹å‡ºæ¥å®ƒä»¬æ˜¯å®ç°å†…å­˜å¿«ç…§RDBçš„å¯¹åº”ä»£ç ã€‚</p><p>æ‰€ä»¥è¿™é‡Œï¼Œä¸ºäº†è®©ä½ èƒ½å¿«é€Ÿå®šä½æºç ï¼Œæˆ‘åˆ†åˆ«æŒ‰ç…§Redisçš„æœåŠ¡å™¨å®ä¾‹ã€æ•°æ®åº“æ“ä½œã€å¯é æ€§å’Œå¯æ‰©å±•æ€§ä¿è¯ã€è¾…åŠ©åŠŸèƒ½å››ä¸ªç»´åº¦ï¼ŒæŠŠRedisåŠŸèƒ½æºç æ¢³ç†æˆäº†å››æ¡ä»£ç è·¯å¾„ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±æƒ³è¦äº†è§£çš„åŠŸèƒ½ç»´åº¦ï¼Œå¯¹åº”åœ°å­¦ä¹ ç›¸å…³ä»£ç ã€‚</p><h3>æœåŠ¡å™¨å®ä¾‹</h3><p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼ŒRedisåœ¨è¿è¡Œæ—¶æ˜¯ä¸€ä¸ªç½‘ç»œæœåŠ¡å™¨å®ä¾‹ï¼Œå› æ­¤ç›¸åº”åœ°å°±éœ€è¦æœ‰ä»£ç å®ç°æœåŠ¡å™¨å®ä¾‹çš„åˆå§‹åŒ–å’Œä¸»ä½“æ§åˆ¶æµç¨‹ï¼Œè€Œè¿™æ˜¯ç”±server.h/server.cå®ç°çš„ï¼ŒRedisæ•´ä¸ªä»£ç çš„mainå…¥å£å‡½æ•°ä¹Ÿæ˜¯åœ¨server.cä¸­ã€‚<strong>å¦‚æœä½ æƒ³äº†è§£Redisæ˜¯å¦‚ä½•å¼€å§‹è¿è¡Œçš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»server.cçš„mainå‡½æ•°å¼€å§‹çœ‹èµ·ã€‚</strong></p><p>å½“ç„¶ï¼Œå¯¹äºä¸€ä¸ªç½‘ç»œæœåŠ¡å™¨æ¥è¯´ï¼Œå®ƒè¿˜éœ€è¦æä¾›ç½‘ç»œé€šä¿¡åŠŸèƒ½ã€‚Redisä½¿ç”¨äº†<strong>åŸºäºäº‹ä»¶é©±åŠ¨æœºåˆ¶çš„ç½‘ç»œé€šä¿¡æ¡†æ¶</strong>ï¼Œæ¶‰åŠçš„ä»£ç æ–‡ä»¶åŒ…æ‹¬ae.h/ae.cï¼Œae_epoll.cï¼Œae_evport.cï¼Œae_kqueue.cï¼Œae_select.cã€‚å…³äºäº‹ä»¶é©±åŠ¨æ¡†æ¶çš„å…·ä½“è®¾è®¡æ€è·¯ä¸å®ç°æ–¹æ³•ï¼Œæˆ‘ä¼šåœ¨ç¬¬10è®²ä¸­ç»™ä½ è¯¦ç»†ä»‹ç»ã€‚</p><p>è€Œé™¤äº†äº‹ä»¶é©±åŠ¨ç½‘ç»œæ¡†æ¶ä»¥å¤–ï¼Œä¸ç½‘ç»œé€šä¿¡ç›¸å…³çš„åŠŸèƒ½è¿˜åŒ…æ‹¬<strong>åº•å±‚TCPç½‘ç»œé€šä¿¡</strong>å’Œ<strong>å®¢æˆ·ç«¯å®ç°</strong>ã€‚</p><p>Rediså¯¹TCPç½‘ç»œé€šä¿¡çš„Socketè¿æ¥ã€è®¾ç½®ç­‰æ“ä½œè¿›è¡Œäº†å°è£…ï¼Œè¿™äº›å°è£…åçš„å‡½æ•°å®ç°åœ¨anet.h/anet.cä¸­ã€‚è¿™äº›å‡½æ•°åœ¨Redis Clusteråˆ›å»ºå’Œä¸»ä»å¤åˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè¢«è°ƒç”¨å¹¶ç”¨äºå»ºç«‹TCPè¿æ¥ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œå®¢æˆ·ç«¯åœ¨Redisçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¼šè¢«å¹¿æ³›ä½¿ç”¨ï¼Œæ¯”å¦‚å®ä¾‹è¿”å›è¯»å–çš„æ•°æ®ã€ä¸»ä»å¤åˆ¶æ—¶åœ¨ä¸»ä»åº“é—´ä¼ è¾“æ•°æ®ã€Redis Clusterçš„åˆ‡ç‰‡å®ä¾‹é€šä¿¡ç­‰ï¼Œéƒ½ä¼šç”¨åˆ°å®¢æˆ·ç«¯ã€‚Rediså°†å®¢æˆ·ç«¯çš„åˆ›å»ºã€æ¶ˆæ¯å›å¤ç­‰åŠŸèƒ½ï¼Œå®ç°åœ¨äº†networking.cæ–‡ä»¶ä¸­ï¼Œå¦‚æœä½ æƒ³äº†è§£å®¢æˆ·ç«¯çš„è®¾è®¡ä¸å®ç°ï¼Œå¯ä»¥é‡ç‚¹çœ‹ä¸‹è¿™ä¸ªä»£ç æ–‡ä»¶ã€‚</p><p>è¿™é‡Œæˆ‘ä¹Ÿç»™ä½ æ€»ç»“äº†ä¸æœåŠ¡å™¨å®ä¾‹ç›¸å…³çš„åŠŸèƒ½æ¨¡å—åŠå¯¹åº”çš„ä»£ç æ–‡ä»¶ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/51/df/514e63ce6947d382fe7a3152c1c989df.jpg?wh=2250x882\" alt=\"\"></p><p>é‚£ä¹ˆï¼Œåœ¨äº†è§£äº†RedisæœåŠ¡å™¨å®ä¾‹çš„ä¸»è¦åŠŸèƒ½ä»£ç ä¹‹åï¼Œæˆ‘ä»¬å†ä»Rediså†…å­˜æ•°æ®åº“è¿™ä¸€ç‰¹æ€§ç»´åº¦ï¼Œæ¥æ¢³ç†ä¸‹ä¸å®ƒç›¸å…³çš„ä»£ç æ–‡ä»¶ã€‚</p><h3>æ•°æ®åº“æ•°æ®ç±»å‹ä¸æ“ä½œ</h3><p>Redisæ•°æ®åº“æä¾›äº†ä¸°å¯Œçš„é”®å€¼å¯¹ç±»å‹ï¼Œå…¶ä¸­åŒ…æ‹¬äº†Stringã€Listã€Hashã€Setå’ŒSorted Setè¿™äº”ç§åŸºæœ¬é”®å€¼ç±»å‹ã€‚æ­¤å¤–ï¼ŒRedisè¿˜æ”¯æŒä½å›¾ã€HyperLogLogã€Geoç­‰æ‰©å±•æ•°æ®ç±»å‹ã€‚</p><p>è€Œä¸ºäº†æ”¯æŒè¿™äº›æ•°æ®ç±»å‹ï¼ŒRediså°±ä½¿ç”¨äº†å¤šç§æ•°æ®ç»“æ„æ¥ä½œä¸ºè¿™äº›ç±»å‹çš„åº•å±‚ç»“æ„ã€‚æ¯”å¦‚ï¼ŒStringç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯SDSï¼Œè€ŒHashç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„åŒ…æ‹¬å“ˆå¸Œè¡¨å’Œå‹ç¼©åˆ—è¡¨ã€‚</p><p>ä¸è¿‡ï¼Œå› ä¸ºRediså®ç°çš„åº•å±‚æ•°æ®ç»“æ„éå¸¸å¤šï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘æŠŠè¿™äº›åº•å±‚ç»“æ„å’Œå®ƒä»¬å¯¹åº”çš„é”®å€¼å¯¹ç±»å‹ï¼Œä»¥åŠç›¸åº”çš„ä»£ç æ–‡ä»¶åˆ—åœ¨äº†ä¸‹è¡¨ä¸­ï¼Œä½ å¯ä»¥ç”¨è¿™å¼ è¡¨æ¥å¿«é€Ÿå®šä½ä»£ç æ–‡ä»¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0b/57/0be4769a748a22dae5760220d9c05057.jpg?wh=2000x1125\" alt=\"\"></p><p>é™¤äº†å®ç°äº†è¯¸å¤šçš„æ•°æ®ç±»å‹ä»¥å¤–ï¼ŒRedisä½œä¸ºæ•°æ®åº“ï¼Œè¿˜å®ç°äº†å¯¹é”®å€¼å¯¹çš„æ–°å¢ã€æŸ¥è¯¢ã€ä¿®æ”¹å’Œåˆ é™¤ç­‰æ“ä½œæ¥å£ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½æ˜¯åœ¨<strong>db.cæ–‡ä»¶</strong>å®ç°çš„ã€‚</p><p>å½“ç„¶ï¼ŒRedisä½œä¸ºå†…å­˜æ•°æ®åº“ï¼Œå…¶ä¿å­˜çš„æ•°æ®é‡å—é™äºå†…å­˜å¤§å°ã€‚å› æ­¤ï¼Œå†…å­˜çš„é«˜æ•ˆä½¿ç”¨å¯¹äºRedisæ¥è¯´å°±éå¸¸é‡è¦ã€‚</p><p>é‚£ä¹ˆä½ å¯èƒ½å°±è¦é—®äº†ï¼š<strong>Redisæ˜¯å¦‚ä½•ä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„å‘¢ï¼Ÿ</strong></p><p>å®é™…ä¸Šï¼ŒRedisæ˜¯ä»ä¸‰ä¸ªæ–¹é¢æ¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨çš„ï¼Œåˆ†åˆ«æ˜¯å†…å­˜åˆ†é…ã€å†…å­˜å›æ”¶ï¼Œä»¥åŠæ•°æ®æ›¿æ¢ã€‚</p><p>é¦–å…ˆï¼Œåœ¨<strong>å†…å­˜åˆ†é…</strong>æ–¹é¢ï¼ŒRedisæ”¯æŒä½¿ç”¨ä¸åŒçš„å†…å­˜åˆ†é…å™¨ï¼ŒåŒ…æ‹¬glibcåº“æä¾›çš„é»˜è®¤åˆ†é…å™¨tcmallocã€ç¬¬ä¸‰æ–¹åº“æä¾›çš„jemallocã€‚RedisæŠŠå¯¹å†…å­˜åˆ†é…å™¨çš„å°è£…å®ç°åœ¨äº†zmalloc.h/zmalloc.cã€‚</p><p>å…¶æ¬¡ï¼Œåœ¨<strong>å†…å­˜å›æ”¶</strong>ä¸Šï¼ŒRedisæ”¯æŒè®¾ç½®è¿‡æœŸkeyï¼Œå¹¶é’ˆå¯¹è¿‡æœŸkeyå¯ä»¥ä½¿ç”¨ä¸åŒåˆ é™¤ç­–ç•¥ï¼Œè¿™éƒ¨åˆ†ä»£ç å®ç°åœ¨expire.cæ–‡ä»¶ä¸­ã€‚åŒæ—¶ï¼Œä¸ºäº†é¿å…å¤§é‡keyåˆ é™¤å›æ”¶å†…å­˜ï¼Œä¼šå¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿå½±å“ï¼ŒRedisåœ¨lazyfree.cä¸­å®ç°äº†å¼‚æ­¥åˆ é™¤çš„åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨åå°IOçº¿ç¨‹æ¥å®Œæˆåˆ é™¤ï¼Œä»¥é¿å…å¯¹Redisä¸»çº¿ç¨‹çš„å½±å“ã€‚</p><p>æœ€åï¼Œé’ˆå¯¹<strong>æ•°æ®æ›¿æ¢</strong>ï¼Œå¦‚æœå†…å­˜æ»¡äº†ï¼ŒRedisè¿˜ä¼šæŒ‰ç…§ä¸€å®šè§„åˆ™æ¸…é™¤ä¸éœ€è¦çš„æ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯Rediså¯ä»¥ä½œä¸ºç¼“å­˜ä½¿ç”¨çš„åŸå› ã€‚Rediså®ç°çš„<a href=\"https://time.geekbang.org/column/article/294640\">æ•°æ®æ›¿æ¢ç­–ç•¥</a>æœ‰å¾ˆå¤šç§ï¼ŒåŒ…æ‹¬LRUã€LFUç­‰ç»å…¸ç®—æ³•ã€‚è¿™éƒ¨åˆ†çš„ä»£ç å®ç°åœ¨äº†evict.cä¸­ã€‚</p><p>åŒæ ·ï¼Œè¿™é‡Œæˆ‘ä¹ŸæŠŠå’ŒRedisæ•°æ®åº“æ•°æ®ç±»å‹ä¸æ“ä½œç›¸å…³çš„åŠŸèƒ½æ¨¡å—åŠä»£ç æ–‡ä»¶ï¼Œæ€»ç»“æˆäº†ä¸€å¼ å›¾ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/15/f0/158fa224d6a49c7d4702ce3f07dbeff0.jpg?wh=1938x768\" alt=\"\"></p><h3>é«˜å¯é æ€§å’Œé«˜å¯æ‰©å±•æ€§</h3><p>é¦–å…ˆï¼Œè™½ç„¶Redisä¸€èˆ¬æ˜¯ä½œä¸ºå†…å­˜æ•°æ®åº“æ¥ä½¿ç”¨çš„ï¼Œä½†æ˜¯å®ƒä¹Ÿæä¾›äº†å¯é æ€§ä¿è¯ï¼Œè¿™ä¸»è¦ä½“ç°åœ¨Rediså¯ä»¥å¯¹æ•°æ®åšæŒä¹…åŒ–ä¿å­˜ï¼Œå¹¶ä¸”å®ƒè¿˜å®ç°äº†ä¸»ä»å¤åˆ¶æœºåˆ¶ï¼Œä»è€Œå¯ä»¥æä¾›æ•…éšœæ¢å¤çš„åŠŸèƒ½ã€‚</p><p>è¿™éƒ¨åˆ†çš„ä»£ç å®ç°æ¯”è¾ƒé›†ä¸­ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ã€‚</p><ul>\n<li><strong>æ•°æ®æŒä¹…åŒ–å®ç°</strong></li>\n</ul><p>Redisçš„æ•°æ®æŒä¹…åŒ–å®ç°æœ‰ä¸¤ç§æ–¹å¼ï¼š<strong>å†…å­˜å¿«ç…§RDB</strong> å’Œ <strong>AOFæ—¥å¿—</strong>ï¼Œåˆ†åˆ«å®ç°åœ¨äº† <strong>rdb.h/rdb.c</strong> å’Œ <strong>aof.c</strong> ä¸­ã€‚</p><p>æ³¨æ„ï¼Œåœ¨ä½¿ç”¨RDBæˆ–AOFå¯¹æ•°æ®åº“è¿›è¡Œæ¢å¤æ—¶ï¼ŒRDBå’ŒAOFæ–‡ä»¶å¯èƒ½ä¼šå› ä¸ºRediså®ä¾‹æ‰€åœ¨æœåŠ¡å™¨å®•æœºï¼Œè€Œæœªèƒ½å®Œæ•´ä¿å­˜ï¼Œè¿›è€Œä¼šå½±å“åˆ°æ•°æ®åº“æ¢å¤ã€‚å› æ­¤é’ˆå¯¹è¿™ä¸€é—®é¢˜ï¼ŒRedisè¿˜å®ç°äº†<strong>å¯¹è¿™ä¸¤ç±»æ–‡ä»¶çš„æ£€æŸ¥åŠŸèƒ½</strong>ï¼Œå¯¹åº”çš„ä»£ç æ–‡ä»¶åˆ†åˆ«æ˜¯redis-check-rdb.cå’Œredis-check-aof.cã€‚</p><ul>\n<li><strong>ä¸»ä»å¤åˆ¶åŠŸèƒ½å®ç°</strong></li>\n</ul><p>RedisæŠŠä¸»ä»å¤åˆ¶åŠŸèƒ½å®ç°åœ¨äº†<strong>replication.cæ–‡ä»¶</strong>ä¸­ã€‚å¦å¤–ä½ è¿˜éœ€è¦çŸ¥é“çš„æ˜¯ï¼ŒRedisçš„ä¸»ä»é›†ç¾¤åœ¨è¿›è¡Œæ¢å¤æ—¶ï¼Œä¸»è¦æ˜¯ä¾èµ–äºå“¨å…µæœºåˆ¶ï¼Œè€Œè¿™éƒ¨åˆ†åŠŸèƒ½åˆ™ç›´æ¥å®ç°åœ¨äº†sentinel.cæ–‡ä»¶ä¸­ã€‚</p><p>å…¶æ¬¡ï¼Œä¸Rediså®ç°é«˜å¯é æ€§ä¿è¯çš„åŠŸèƒ½ç±»ä¼¼ï¼ŒRedisé«˜å¯æ‰©å±•æ€§ä¿è¯çš„åŠŸèƒ½ï¼Œæ˜¯é€šè¿‡<strong>Redis Cluster</strong>æ¥å®ç°çš„ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¹Ÿéå¸¸é›†ä¸­ï¼Œå°±æ˜¯åœ¨<strong>cluster.h/cluster.cä»£ç æ–‡ä»¶</strong>ä¸­ã€‚æ‰€ä»¥è¿™æ ·ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ Redis Clusterçš„è®¾è®¡ä¸å®ç°æ—¶ï¼Œå°±ä¼šéå¸¸æ–¹ä¾¿ï¼Œä¸ç”¨åœ¨ä¸åŒçš„æ–‡ä»¶ä¹‹é—´æ¥å›è·³è½¬äº†ã€‚</p><h3>è¾…åŠ©åŠŸèƒ½</h3><p>Redisè¿˜å®ç°äº†ä¸€äº›ç”¨äºæ”¯æŒç³»ç»Ÿè¿ç»´çš„è¾…åŠ©åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œä¸ºäº†ä¾¿äºè¿ç»´äººå‘˜æŸ¥çœ‹åˆ†æä¸åŒæ“ä½œçš„å»¶è¿Ÿäº§ç”Ÿæ¥æºï¼ŒRedisåœ¨latency.h/latency.cä¸­å®ç°äº†æ“ä½œå»¶è¿Ÿç›‘æ§çš„åŠŸèƒ½ï¼›ä¸ºäº†ä¾¿äºè¿ç»´äººå‘˜æŸ¥æ‰¾è¿è¡Œè¿‡æ…¢çš„æ“ä½œå‘½ä»¤ï¼ŒRedisåœ¨slowlog.h/slowlog.cä¸­å®ç°äº†æ…¢å‘½ä»¤çš„è®°å½•åŠŸèƒ½ï¼Œç­‰ç­‰ã€‚</p><p>æ­¤å¤–ï¼Œè¿ç»´äººå‘˜æœ‰æ—¶è¿˜éœ€è¦äº†è§£Redisçš„æ€§èƒ½è¡¨ç°ï¼Œä¸ºäº†æ”¯æŒè¿™ä¸€ç›®æ ‡ï¼ŒRediså®ç°äº†å¯¹ç³»ç»Ÿè¿›è¡Œæ€§èƒ½è¯„æµ‹çš„åŠŸèƒ½ï¼Œè¿™éƒ¨åˆ†ä»£ç åœ¨redis-benchmark.cä¸­ã€‚å¦‚æœä½ æƒ³è¦äº†è§£å¦‚ä½•å¯¹Rediså¼€å±•æ€§èƒ½æµ‹è¯•ï¼Œè¿™ä¸ªä»£ç æ–‡ä»¶ä¹Ÿå€¼å¾—ä¸€è¯»ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©æ˜¯æˆ‘ä»¬äº†è§£Redisæºç æ¶æ„å’Œè®¾è®¡æ€æƒ³çš„â€œçƒ­èº«è¯¾â€ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œå°±æ˜¯ç†è§£ä»£ç ç»“æ„ï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬æä¾›RedisåŠŸèƒ½æ¨¡å—çš„å…¨æ™¯å›¾ï¼Œå¹¶æ–¹ä¾¿æˆ‘ä»¬å¿«é€ŸæŸ¥æ‰¾å’Œå®šä½æŸä¸ªå…·ä½“åŠŸèƒ½æ¨¡å—çš„å®ç°æºç ï¼Œè¿™æ ·ä¹Ÿæœ‰åŠ©äºæå‡ä»£ç é˜…è¯»çš„æ•ˆç‡ã€‚</p><p>æˆ‘åœ¨ä¸€å¼€å§‹ï¼Œå…ˆç»™ä½ ä»‹ç»äº†ä¸€ä¸ª<strong>å°è¯€çª</strong>ï¼šé€šè¿‡ç›®å½•å‘½åå’Œå±‚æ¬¡ï¼Œæ¥å¿«é€ŸæŒæ¡ä¸€ä¸ªç³»ç»Ÿè½¯ä»¶çš„ä»£ç ç»“æ„ã€‚è€Œé€šè¿‡å­¦ä¹ Redisçš„ç›®å½•ç»“æ„ï¼Œæˆ‘ä»¬ä¹Ÿå­¦åˆ°äº†ä¸€ä¸ª<strong>é‡è¦çš„ç¼–ç¨‹è§„èŒƒ</strong>ï¼šåœ¨å¼€å‘ç³»ç»Ÿè½¯ä»¶æ—¶ï¼Œä½¿ç”¨ä¸åŒçš„ç›®å½•å¯¹ä»£ç è¿›è¡Œåˆ’åˆ†ã€‚</p><p>å¸¸è§çš„ç›®å½•åŒ…æ‹¬ä¿å­˜ç¬¬ä¸‰æ–¹åº“çš„depsç›®å½•ã€ä¿å­˜æµ‹è¯•ç”¨ä¾‹çš„testsç›®å½•ï¼Œä»¥åŠè¾…åŠ©åŠŸèƒ½å’Œå·¥å…·çš„å¸¸ç”¨ç›®å½•utilsç›®å½•ã€‚æŒ‰ç…§è¿™ä¸ªè§„èŒƒæ¥ç»„ç»‡ä½ çš„ä»£ç ï¼Œå°±å¯ä»¥æå‡ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>å¦å¤–ï¼Œåœ¨å­¦ä¹ RedisåŠŸèƒ½æ¨¡å—çš„ä»£ç ç»“æ„æ—¶ï¼Œé¢å¯¹123ä¸ªä»£ç æ–‡ä»¶ï¼Œæˆ‘ä¹Ÿç»™ä½ åˆ†äº«äº†ä¸€ç§æˆ‘ä¸€ç›´æ¯”è¾ƒæ¨å´‡çš„æ–¹æ³•ï¼š<strong>åˆ†é—¨åˆ«ç±»</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŒ‰ç…§ä¸€å®šçš„ç»´åº¦å°†æ‰€è¦å­¦ä¹ çš„å†…å®¹è¿›è¡Œåˆ†ç±»æè¿°æˆ–æ€»ç»“ã€‚</p><p>åœ¨è¯¾ç¨‹ä¸­ï¼Œæˆ‘æ˜¯æŒ‰ç…§æœåŠ¡å™¨å®ä¾‹ã€æ•°æ®åº“æ•°æ®ç±»å‹ä¸æ“ä½œã€é«˜å¯é ä¸é«˜å¯æ‰©å±•ä¿è¯ï¼Œä»¥åŠè¾…åŠ©åŠŸèƒ½å››ä¸ªç»´åº¦ï¼Œç»™ä½ æ¢³ç†äº†å››æ¡ä»£ç è·¯å¾„ã€‚è¿™å››æ¡ä»£ç è·¯å¾„ä¹ŸåŸºæœ¬æ¶µç›–äº†Redisçš„ä¸»è¦åŠŸèƒ½ä»£ç ï¼Œå¯ä»¥æ–¹ä¾¿ä½ å»æœ‰é€»è¾‘ã€æœ‰ç« æ³•åœ°å­¦ä¹ æŒæ¡Redisæºç ï¼Œä¸è‡³äºé—æ¼é‡è¦ä»£ç ã€‚</p><p>é‚£ä¹ˆåœ¨æœ€åï¼Œæˆ‘è¿˜æƒ³è¯´ä¸€ç‚¹ï¼Œå°±æ˜¯åœ¨ä½ å­¦ä¹ äº†Redisæºç ç»“æ„çš„åŒæ—¶ï¼Œä¹Ÿå¸Œæœ›ä½ èƒ½æŠŠè¿™ä¸ªæ–¹æ³•åº”ç”¨åˆ°å…¶ä»–çš„ä»£ç å­¦ä¹ ä¸­ï¼Œæé«˜å­¦ä¹ æ•ˆç‡ã€‚</p><h2>æ¯è¯¾ä¸€é—®</h2><p>Redisä»4.0ç‰ˆæœ¬å¼€å§‹ï¼Œèƒ½å¤Ÿæ”¯æŒåå°å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œæ¯”å¦‚å¼‚æ­¥åˆ é™¤æ•°æ®ï¼Œä½ èƒ½åœ¨RedisåŠŸèƒ½æºç ä¸­ï¼Œæ‰¾åˆ°å®ç°åå°ä»»åŠ¡çš„ä»£ç æ–‡ä»¶ä¹ˆï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒå’Œæ“ä½œè¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœè§‰å¾—æœ‰æ”¶è·çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"å¼€ç¯‡è¯ | é˜…è¯»Redisæºç èƒ½ç»™ä½ å¸¦æ¥ä»€ä¹ˆï¼Ÿ","id":399839},"right":{"article_title":"02 | é”®å€¼å¯¹ä¸­å­—ç¬¦ä¸²çš„å®ç°ï¼Œç”¨char*è¿˜æ˜¯ç»“æ„ä½“ï¼Ÿ","id":400314}},"comments":[{"had_liked":false,"id":304435,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1627404481,"is_pvip":true,"discussion_count":10,"race_medal":0,"score":"568563087553","product_id":100084301,"comment_content":"é‡æ–°çœ‹äº†ä¸€ä¸‹æºç ç›®å½•ï¼Œç»“åˆè¿™ç¯‡æ–‡ç« çš„å†…å®¹ï¼Œæ•´ç†äº†ä¸€ä¸‹ä»£ç åˆ†ç±»ï¼ˆå¿½ç•¥.hå¤´æ–‡ä»¶ï¼‰ï¼Œè¿™ä¹Ÿæ›´æ¸…æ™°ä¸€äº›ï¼š<br><br>æ•°æ®ç±»å‹ï¼š<br>- Stringï¼ˆt_string.cã€sds.cã€bitops.cï¼‰<br>- Listï¼ˆt_list.cã€ziplist.cï¼‰<br>- Hashï¼ˆt_hash.cã€ziplist.cã€dict.cï¼‰<br>- Setï¼ˆt_set.cã€intset.cï¼‰<br>- Sorted Setï¼ˆt_zset.cã€ziplist.cã€dict.cï¼‰<br>- HyperLogLogï¼ˆhyperloglog.cï¼‰<br>- Geoï¼ˆgeo.cã€geohash.cã€geohash_helper.cï¼‰<br>- Streamï¼ˆt_stream.cã€rax.cã€listpack.cï¼‰<br><br>å…¨å±€ï¼š<br>- Serverï¼ˆserver.cã€anet.cï¼‰<br>- Objectï¼ˆobject.cï¼‰<br>- é”®å€¼å¯¹ï¼ˆdb.cï¼‰<br>- äº‹ä»¶é©±åŠ¨ï¼ˆae.cã€ae_epoll.cã€ae_kqueue.cã€ae_evport.cã€ae_select.cã€networking.cï¼‰<br>- å†…å­˜å›æ”¶ï¼ˆexpire.cã€lazyfree.cï¼‰<br>- æ•°æ®æ›¿æ¢ï¼ˆevict.cï¼‰<br>- åå°çº¿ç¨‹ï¼ˆbio.cï¼‰<br>- äº‹åŠ¡ï¼ˆmulti.cï¼‰<br>- PubSubï¼ˆpubsub.cï¼‰<br>- å†…å­˜åˆ†é…ï¼ˆzmalloc.cï¼‰<br>- åŒå‘é“¾è¡¨ï¼ˆadlist.cï¼‰<br><br>é«˜å¯ç”¨&amp;é›†ç¾¤ï¼š<br>- æŒä¹…åŒ–ï¼šRDBï¼ˆrdb.cã€redis-check-rdb.c)ã€AOFï¼ˆaof.cã€redis-check-aof.cï¼‰<br>- ä¸»ä»å¤åˆ¶ï¼ˆreplication.cï¼‰<br>- å“¨å…µï¼ˆsentinel.cï¼‰<br>- é›†ç¾¤ï¼ˆcluster.cï¼‰<br><br>è¾…åŠ©åŠŸèƒ½ï¼š<br>- å»¶è¿Ÿç»Ÿè®¡ï¼ˆlatency.cï¼‰<br>- æ…¢æ—¥å¿—ï¼ˆslowlog.cï¼‰<br>- é€šçŸ¥ï¼ˆnotify.cï¼‰<br>- åŸºå‡†æ€§èƒ½ï¼ˆredis-benchmark.cï¼‰<br><br>ä¸‹é¢è§£ç­”è¯¾åé—®é¢˜ï¼š<br><br>Redis ä» 4.0 ç‰ˆæœ¬å¼€å§‹ï¼Œèƒ½å¤Ÿæ”¯æŒåå°å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œæ¯”å¦‚å¼‚æ­¥åˆ é™¤æ•°æ®ï¼Œä½ èƒ½åœ¨ Redis åŠŸèƒ½æºç ä¸­ï¼Œæ‰¾åˆ°å®ç°åå°ä»»åŠ¡çš„ä»£ç æ–‡ä»¶ä¹ˆï¼Ÿ<br><br>åå°ä»»åŠ¡çš„ä»£ç åœ¨ bio.c ä¸­ã€‚<br><br>Redis Server åœ¨å¯åŠ¨æ—¶ï¼Œä¼šåœ¨ server.c ä¸­è°ƒç”¨ bioInit å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåˆ›å»º 3 ç±»åå°ä»»åŠ¡ï¼ˆç±»å‹å®šä¹‰åœ¨ bio.h ä¸­ï¼‰ï¼š<br><br>#define BIO_CLOSE_FILE    0 &#47;&#47; åå°çº¿ç¨‹å…³é—­ fd<br>#define BIO_AOF_FSYNC     1 &#47;&#47; AOF é…ç½®ä¸º everysecï¼Œåå°çº¿ç¨‹åˆ·ç›˜<br>#define BIO_LAZY_FREE     2 &#47;&#47; åå°çº¿ç¨‹é‡Šæ”¾ key å†…å­˜<br><br>è¿™ 3 ç±»åå°ä»»åŠ¡ï¼Œå·²ç»æ³¨å†Œå¥½äº†æ‰§è¡Œå›ºå®šçš„å‡½æ•°ï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼š<br><br>- BIO_CLOSE_FILE å¯¹åº”æ‰§è¡Œ close(fd)<br>- BIO_AOF_FSYNC å¯¹åº”æ‰§è¡Œ fsync(fd)<br>- BIO_LAZY_FREE æ ¹æ®å‚æ•°ä¸åŒï¼Œå¯¹åº” 3 ä¸ªå‡½æ•°ï¼ˆfreeObject&#47;freeDatabase&#47;freeSlowsMapï¼‰<br><br>ä¹‹åï¼Œä¸»çº¿ç¨‹å‡¡æ˜¯éœ€è¦æŠŠä¸€ä¸ªä»»åŠ¡äº¤ç»™åå°çº¿ç¨‹å¤„ç†æ—¶ï¼Œå°±ä¼šè°ƒç”¨ bio.c çš„ bioCreateBackgroundJob å‡½æ•°ï¼ˆç›¸å½“äºå‘å¸ƒå¼‚æ­¥ä»»åŠ¡çš„å‡½æ•°ï¼‰ï¼Œå¹¶æŒ‡å®šè¯¥ä»»åŠ¡æ˜¯ä¸Šé¢ 3 ä¸ªçš„å“ªä¸€ç±»ï¼ŒæŠŠä»»åŠ¡æŒ‚åˆ°å¯¹åº”ç±»å‹çš„ã€Œé“¾è¡¨ã€ä¸‹ï¼ˆbio_jobs[type]ï¼‰ï¼Œä»»åŠ¡å³å‘å¸ƒæˆåŠŸï¼ˆç”Ÿäº§è€…ä»»åŠ¡å®Œæˆï¼‰ã€‚<br><br>æ¶ˆè´¹è€…ä»é“¾è¡¨ä¸­æ‹¿åˆ°ç”Ÿäº§è€…å‘è¿‡æ¥çš„ã€Œä»»åŠ¡ç±»å‹ + å‚æ•°ã€ï¼Œæ‰§è¡Œä¸Šé¢ä»»åŠ¡å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚å½“ç„¶ï¼Œç”±äºæ˜¯ã€Œå¤šçº¿ç¨‹ã€è¯»å†™é“¾è¡¨æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯éœ€è¦ã€ŒåŠ é”ã€æ“ä½œçš„ã€‚<br><br>å¦‚æœè¦æ‰¾ã€Œå¼‚æ­¥åˆ é™¤æ•°æ®ã€çš„é€»è¾‘ï¼Œå¯ä»¥ä» server.c çš„ unlink å‘½ä»¤ä¸ºèµ·ç‚¹ï¼Œä¸€è·¯è·Ÿä»£ç è¿›å»ï¼Œå°±ä¼šçœ‹åˆ°è°ƒç”¨äº† lazyfree.c çš„ dbAsyncDelete å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè°ƒåˆ°ä¸Šé¢æåˆ°çš„å‘å¸ƒå¼‚æ­¥ä»»åŠ¡å‡½æ•° bioCreateBackgroundJobï¼Œæ•´ä¸ªé“¾æ¡å°±ä¸²èµ·æ¥äº†ã€‚","like_count":133,"discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386135,"discussion_content":"è¡¥å……ï¼šå…¶å® Redis åœ¨ 2.8 ç‰ˆæœ¬å°±å·²æ”¯æŒäº†ã€Œåå°çº¿ç¨‹ã€ï¼Œä½†å½“æ—¶åªæœ‰ 2 ç±»ï¼šå¼‚æ­¥å…³é—­fdã€AOF åå°åˆ·ç›˜ã€‚\n\nç›´åˆ° 4.0 ç‰ˆæœ¬ï¼ŒåˆåŠ å…¥äº† lazy-free åå°çº¿ç¨‹ã€‚","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1627438591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1043475,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","nickname":"neohope","note":"","ucode":"C0268F6E7E2B6E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545867,"discussion_content":"è¡¥å……å‡ ä¸ªï¼š\n\næ•°æ®ç»“æ„ï¼š\n- å­—ç¬¦ä¸²ï¼ˆt_string.cã€sds.cã€sdsalloc.hï¼‰\n- ä½è¿ç®—ï¼ˆbitops.cï¼‰\n- é“¾è¡¨ï¼ˆt_list.cã€ziplist.cï¼‰\n- åŒå‘é“¾è¡¨ï¼ˆadlist.cã€quicklist.cï¼‰\n- å“ˆå¸Œè¡¨ï¼ˆt_hash.cã€ziplist.cã€dict.cã€zipmap.cï¼‰\n- é›†åˆï¼ˆt_set.cã€intset.cï¼‰\n- æœ‰åºé›†åˆï¼ˆt_zset.cã€ziplist.cã€dict.cï¼‰\n- åŸºæ•°æ ‘ï¼ˆrax.cï¼‰\n- HyperLogLogï¼ˆhyperloglog.cï¼‰\n- ç»çº¬åº¦ï¼ˆgeo.cã€geohash.cã€geohash_helper.cï¼‰\n- æµï¼ˆt_stream.cã€rax.cã€listpack.cï¼‰\n- Rediså¯¹è±¡ï¼ˆobject.cï¼‰\n\nç®—æ³•ï¼š\n- æ’åºï¼ˆSort.cã€pqsort.cï¼‰\n- å“ˆå¸Œï¼ˆspihash.cï¼‰\n- SHAï¼ˆsha1.cã€sha256.cï¼‰\n- CRCï¼ˆcrc16.cã€crc16_slottable.hã€crc64.cã€crcspeed.cï¼‰\n- éšæœºæ•°ï¼ˆrand.cã€mt19937-64.cï¼‰\n- å‹ç¼©ï¼ˆlzf_c.cã€lzf_d.cã€lzf_h.cï¼‰\n- å¾®çº¿å›¾ï¼ˆsparkline.cï¼‰\n\nå…¨å±€åŠŸèƒ½ï¼š\n- Serverå…¥å£ï¼ˆserver.cã€anet.cï¼‰\n- CLIï¼ˆcli-common.cã€reids-cli.cã€help.hã€setproctitle.cï¼‰\n- äº‹ä»¶é©±åŠ¨ï¼ˆae.cã€ae_epoll.cã€ae_kqueue.cã€ae_evport.cã€ae_select.cã€networking.cï¼‰\n- äº‹åŠ¡ï¼ˆmulti.cï¼‰\n- IOï¼ˆsyncio.cã€rio.cï¼‰\n- åå°IOçº¿ç¨‹ï¼ˆbio.cï¼‰\n- é˜»å¡æ“ä½œï¼ˆblocked.cï¼‰\n- DB APIï¼ˆdb.cï¼‰\n- æ—¶é’Ÿç®¡ç†ï¼ˆmonotonic.cã€localtime.cï¼‰\n- ä¼ è¾“ç®¡ç†ï¼ˆanet.cã€networking.cã€connection.cã€connhelpers.hã€gopher.cã€tls.cã€timeout.cï¼‰\n- æƒé™ç®¡ç†ï¼ˆacl.cï¼‰\n- é…ç½®ç®¡ç†ï¼ˆconfig.cï¼‰\n- æ¨¡å—ç®¡ç†ï¼ˆmodule.cï¼‰\n- å®¢æˆ·ç«¯ç¼“å­˜æ”¯æŒï¼ˆtracking.cï¼‰\n\nå†…å­˜ä¸CPUï¼š\n- å†…å­˜åˆ†é…ï¼ˆzmalloc.cï¼‰\n- å†…å­˜å›æ”¶ï¼ˆexpire.cã€lazyfree.cï¼‰\n- å†…å­˜ç¢ç‰‡æ•´ç†ï¼ˆdefrag.cï¼‰\n- å¤§å°ç«¯è½¬æ¢ï¼ˆendinconv.cï¼‰\n- å†…å­˜é…é¢ï¼ˆevict.cï¼‰\n- åŸå­æ“ä½œï¼ˆatomicvar.hï¼‰\n- CPUç»‘å®šï¼ˆsetcpuaffinity.cï¼‰\n\né«˜å¯ç”¨&amp;é›†ç¾¤ï¼š\n- å†…å­˜å¿«ç…§RDBï¼ˆrdb.cã€redis-check-rdb.c)\n- AOFæ—¥å¿—ï¼ˆaof.cã€redis-check-aof.cï¼‰\n- ä¸»ä»å¤åˆ¶ï¼ˆreplication.cï¼‰\n- è®¢é˜…å‘å¸ƒPubSubï¼ˆpubsub.cï¼‰\n- é›†ç¾¤ï¼ˆcluster.cï¼‰\n- å“¨å…µï¼ˆsentinel.cï¼‰\n\nè¾…åŠ©åŠŸèƒ½ï¼š\n- å»¶è¿Ÿç»Ÿè®¡ï¼ˆlatency.cï¼‰\n- æ…¢æ—¥å¿—ï¼ˆslowlog.cï¼‰\n- é€šçŸ¥ï¼ˆnotify.cï¼‰\n- åŸºå‡†æ€§èƒ½ï¼ˆredis-benchmark.cï¼‰\n- è°ƒè¯•å·¥å…·ï¼ˆmemtest.cã€testhelper.cã€redisassert.hã€debug.cã€debugmacro.hï¼‰","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1642067757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3010843,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/f1/1b/0957d4c5.jpg","nickname":"ç‹é£","note":"","ucode":"5F029E870B200F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585358,"discussion_content":"å¤§ä½¬ï¼Œä»ä½ è¿™å­¦ä¹ åˆ°äº†å¾ˆå¤šï¼Œèµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661499294,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2109213,"avatar":"https://static001.geekbang.org/account/avatar/00/20/2f/1d/7793e233.jpg","nickname":"gzh4869","note":"","ucode":"C7472DB064C3B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584125,"discussion_content":"ä¼˜ç§€å•Šè€å“¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660635293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"è¾½å®"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1430524,"avatar":"https://static001.geekbang.org/account/avatar/00/15/d3/fc/e1b29953.jpg","nickname":"æ…¢èµ°å¤œè¡—","note":"","ucode":"CB7B760604428D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388247,"discussion_content":"åˆçœ‹åˆ°å¤§ä½¬äº†ã€‚ã€‚ç¬¬ä¸€å­£å°±ä»ä½ è¿™å­¦ä¹ å¾ˆå¤šï¼ŒçœŸçš„nice","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628667161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1305172,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ea/54/b4f0a77b.jpg","nickname":"lizy","note":"","ucode":"2DB56C2F4D7D39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387539,"discussion_content":"å¤§ä½¬ï¼ŒçœŸæ£’ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628237484,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1365206,"avatar":"https://static001.geekbang.org/account/avatar/00/14/d4/d6/1d4543ac.jpg","nickname":"äº‘æµ·","note":"","ucode":"0C6CA0BE58EA21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386795,"discussion_content":"è¡¥å……ä¸‹ï¼ŒList æ•°æ®ç±»å‹ é‡Œé—æ¼äº† ä¸€ä¸ª quicklist.c","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627805193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1365206,"avatar":"https://static001.geekbang.org/account/avatar/00/14/d4/d6/1d4543ac.jpg","nickname":"äº‘æµ·","note":"","ucode":"0C6CA0BE58EA21","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386845,"discussion_content":"ç¡®å®ï¼Œæ„Ÿè°¢è¡¥å……ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627835827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386795,"ip_address":""},"score":386845,"extra":""}]},{"author":{"id":1131135,"avatar":"","nickname":"Ivy","note":"","ucode":"78156E0D5DEC52","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386282,"discussion_content":"å¤§ä½¬ä½ æ˜¯çœŸçš„å‰å®³ï¼è·Ÿç€ä½ å­¦ä¹ åˆ°å¾ˆå¤šï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627496380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1131135,"avatar":"","nickname":"Ivy","note":"","ucode":"78156E0D5DEC52","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386322,"discussion_content":"ä¸€èµ·å­¦ä¹ ğŸ˜„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627526593,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386282,"ip_address":""},"score":386322,"extra":""}]}]},{"had_liked":false,"id":304290,"user_name":"æ‚Ÿç©ºèŠæ¶æ„","can_delete":false,"product_type":"c1","uid":1123163,"ip_address":"","ucode":"C2F482A0CF8AF1","user_header":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","comment_is_top":false,"comment_ctime":1627317270,"is_pvip":true,"discussion_count":5,"race_medal":0,"score":"44576990230","product_id":100084301,"comment_content":"å›ç­”æ¯è¯¾ä¸€é—®ï¼š<br>Redis ä» 4.0 ç‰ˆæœ¬å¼€å§‹ï¼Œèƒ½å¤Ÿæ”¯æŒåå°å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œæ¯”å¦‚å¼‚æ­¥åˆ é™¤æ•°æ®ï¼Œä½ èƒ½åœ¨ Redis åŠŸèƒ½æºç ä¸­ï¼Œæ‰¾åˆ°å®ç°åå°ä»»åŠ¡çš„ä»£ç æ–‡ä»¶ä¹ˆï¼Ÿ<br><br>æˆ‘ç¿»çœ‹äº† 3.0 çš„æºç ï¼Œå‘ç° 3.0 å°±æ”¯æŒåå°ä»»åŠ¡äº†ã€‚åœ¨æ–‡ä»¶ src\\bio.c é‡Œé¢æœ‰ä¸€ä¸ªåå°ä»»åŠ¡çš„å‡½æ•°ï¼š<br>bioProcessBackgroundJobsï¼Œæ”¯æŒä¸¤ç§åå°ä»»åŠ¡ï¼šå…³é—­æ–‡ä»¶å’Œ AOF æ–‡ä»¶çš„ fsync ä¹Ÿæ˜¯æ”¾åˆ°åå°æ‰§è¡Œçš„ã€‚<br><br>ï¼ˆfsync å°±æ˜¯æ‰§è¡Œå‘½ä»¤åå°†å‘½ä»¤å†™åˆ°æ—¥å¿—ä¸­ï¼Œæä¾›äº†ä¸‰ç§ç­–ç•¥ï¼šAlwaysï¼ŒåŒæ­¥å†™å›ï¼ŒEverysecï¼Œæ¯ç§’å†™å›ï¼ŒNoï¼Œæ“ä½œç³»ç»Ÿæ§åˆ¶çš„å†™å›ã€‚ï¼‰<br><br>ç–‘é—®ï¼šæ ¹æ® 3.0 æºç ï¼ŒRedis 3.0 å…¶å®å°±å·²ç»æœ‰åå°ä»»åŠ¡äº†ï¼Œè€å¸ˆåœ¨æ–‡ä¸­è¯´çš„ 4.0 æ‰å¼€å§‹æ”¯æŒåå°ä»»åŠ¡ï¼Œæˆ‘æ²¡ç†è§£ã€‚<br><br>ç„¶åæˆ‘åˆå»ç¿»äº†ä¸‹ 4.0 çš„æºç ï¼Œå¢åŠ ä¸€ç§åå°ä»»åŠ¡ï¼šBIO_LAZY_FREEã€‚<br><br>å½“ä»»åŠ¡ç±»å‹ç­‰äº BIO_LAZY_FREE æ—¶ï¼Œé’ˆå¯¹ä¸åŒçš„ä¼ å‚ï¼Œå¯ä»¥é‡Šæ”¾å¯¹è±¡ã€æ•°æ®åº“ã€è·³è·ƒè¡¨ã€‚<br><br>å¯¹äºé‡Šæ”¾å¯ä»¥ç¨å¾®è¯´ä¸€ä¸‹ï¼Œé‡Šæ”¾çš„æºç åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼š\\src\\lazyfree.cï¼Œç›¸å¯¹ 3.0 æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯æ–°å¢åŠ çš„ã€‚<br><br>å…³äºå¯¹è±¡çš„é‡Šæ”¾ï¼Œæˆ‘ä»¬å¯ä»¥è”æƒ³åˆ° Java çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼šå¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œä½†æ˜¯ Redis çš„åƒåœ¾å›æ”¶ç®—æ³•ç”¨çš„æ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œå¦å¤– PHP çš„åƒåœ¾å›æ”¶ç®—æ³•ç”¨çš„ä¹Ÿæ˜¯å¼•ç”¨è®¡æ•°ï¼ˆæ‰©å±•ä¸‹ï¼šç”¨äº†å¤šè‰²æ ‡è®°çš„æ–¹å¼ï¼Œæ¥è¯†åˆ«åƒåœ¾ï¼Œè¯¦ç»†å‚è€ƒè¿™é‡Œï¼šhttps:&#47;&#47;mp.weixin.qq.com&#47;s&#47;n6PGIgfZ8vXUZ1rkU5Otogï¼‰ï¼Œæ‰€ä»¥åˆ«å†è¯´å¼•ç”¨è®¡æ•°ä¸èƒ½ç”¨åšåƒåœ¾å›æ”¶äº†å“¦ã€‚<br><br>è€Œå¯¹äº Redis é‡Šæ”¾å¯¹è±¡æ¥è¯´ï¼Œä¼šå‡å°‘å¼•ç”¨çš„æ¬¡æ•°ï¼Œè°ƒç”¨çš„æ˜¯è¿™ä¸ªå‡½æ•°ï¼šdecrRefCount(o); æ ¹æ®å‡½æ•°çš„åå­—ä¹Ÿå®¹æ˜“ç†è§£ã€‚<br><br>åæ§½ä¸‹ï¼šGithub ä¸Šä¸‹è½½æºç æ€»æ˜¯ä¸‹è½½å¤±è´¥ï¼Œä¸ºäº†å…¶ä»–åŒå­¦ä»¬æ–¹ä¾¿ä¸‹è½½ï¼Œæˆ‘æ•´ç†äº†å¤šå¥—æºç çš„ä¸‹è½½åœ°å€ï¼Œéƒ½æ˜¯å›½å†…çš„ç½‘ç›˜é“¾æ¥ï¼Œåªæœ‰å‡ MB å¤§å°ï¼Œä¸‹è½½æ¯”è¾ƒå¿«çš„ã€‚<br><br>http:&#47;&#47;www.passjava.cn&#47;#&#47;12.Redis&#47;00.DownloadRedis","like_count":11,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385978,"discussion_content":"è§åˆ°å¤§ä½¬æœ¬å°Šäº†ï¼Œå‘å¤§ä½¬å­¦ä¹ ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1627370980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2032790,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/9o4qQVZB2FjiaDxwLYZhL3E7HpvRIvETvZKGtF7Wiasc3jNIvTODQ6utnbQFQDYzzicqfwGM2MjNOblIBLLUmWFMQ/132","nickname":"Geek_adf04b","note":"","ucode":"CD709E278D979B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575923,"discussion_content":"å‰å®³","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655190381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1162791,"avatar":"https://static001.geekbang.org/account/avatar/00/11/be/27/f6f45877.jpg","nickname":"æ ‘çŒ«","note":"","ucode":"F6B18589A30AA8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387120,"discussion_content":"è¯¾ä»£è¡¨2.0ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627996355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2397850,"avatar":"https://static001.geekbang.org/account/avatar/00/24/96/9a/0bd88255.jpg","nickname":"é£ç¾½","note":"","ucode":"9CDC1A2D060320","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386037,"discussion_content":"å¤šå¥—æºç æœ‰å¤šå¤šï¼Œæˆ‘è¦æ‰“åä¸ª","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627385853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1123163,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","nickname":"æ‚Ÿç©ºèŠæ¶æ„","note":"","ucode":"C2F482A0CF8AF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2397850,"avatar":"https://static001.geekbang.org/account/avatar/00/24/96/9a/0bd88255.jpg","nickname":"é£ç¾½","note":"","ucode":"9CDC1A2D060320","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":386100,"discussion_content":"é…å¥—æºç å¯ä»¥å…ˆä¸‹è½½ä¸‹æ¥çœ‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627398926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386037,"ip_address":""},"score":386100,"extra":""}]}]},{"had_liked":false,"id":304526,"user_name":"Ethan New","can_delete":false,"product_type":"c1","uid":2063962,"ip_address":"","ucode":"9CA2EF39E58030","user_header":"https://static001.geekbang.org/account/avatar/00/1f/7e/5a/da39f489.jpg","comment_is_top":false,"comment_ctime":1627465601,"is_pvip":true,"discussion_count":0,"race_medal":4,"score":"35987203969","product_id":100084301,"comment_content":"è¯„è®ºåŒºä¹Ÿå¤ªå¼ºäº†å§ï¼Œç‘Ÿç‘Ÿå‘æŠ–","like_count":8},{"had_liked":false,"id":304214,"user_name":"å¯æ€œå¤§ç°ç‹¼","can_delete":false,"product_type":"c1","uid":1928373,"ip_address":"","ucode":"6CA9D6D460B967","user_header":"https://static001.geekbang.org/account/avatar/00/1d/6c/b5/32374f93.jpg","comment_is_top":false,"comment_ctime":1627294420,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"23102130900","product_id":100084301,"comment_content":"æˆ‘çš„ç¬¬ä¸€ååº”åº”è¯¥æ˜¯ä»unlinkå‘½ä»¤å…¥æ‰‹æŸ¥æ‰¾ã€‚é¦–å…ˆè‚¯å®šæ˜¯server.cä¸­redisCommandTable[]ä¸­çš„unlinkCommandï¼Œæ‰¾åˆ°äº†lazyfree.cä¸­dbAsyncDeleteæ–¹æ³•ï¼Œç„¶åæ‰¾åˆ°äº†bio.cä¸­bioCreateBackgroundJobæ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶bio.hä¸­åŠ äº†ä¸€ç§åå°IOä»»åŠ¡ç±»å‹ï¼šBIO_LAZY_FREE=2ã€‚æˆ‘è®°å¾—æˆ‘çœ‹3.0ä»£ç è¿˜åªæœ‰BIO_CLOSE_FILEå’ŒBIO_AOF_FSYNC","like_count":5},{"had_liked":false,"id":304210,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1627293512,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"23102129992","product_id":100084301,"comment_content":"bio.c<br>åœ¨5.xçš„æºç ä¸­ï¼Œåå°å¼‚æ­¥æ‰§è¡Œåˆ3ä¸ªå­çº¿ç¨‹<br>#define BIO_NUM_OPS       3<br>#define BIO_CLOSE_FILE    0 &#47;* Deferred close(2) syscall. *&#47;<br>#define BIO_AOF_FSYNC     1 &#47;* Deferred AOF fsync. *&#47;<br>#define BIO_LAZY_FREE     2 &#47;* Deferred objects freeing. *&#47;<br><br>bioInitæ–¹æ³•ä¸­é€šè¿‡pthread_createåˆ›å»ºBIO_NUM_OPSå­çº¿ç¨‹ï¼Œä¸åŒçº¿ç¨‹çš„ä»»åŠ¡åœ¨static list *bio_jobs[BIO_NUM_OPS]ä¸­å­˜å‚¨ã€‚","like_count":5},{"had_liked":false,"id":304708,"user_name":"é™Œ","can_delete":false,"product_type":"c1","uid":1152678,"ip_address":"","ucode":"13FF1D4B3181F0","user_header":"https://static001.geekbang.org/account/avatar/00/11/96/a6/aac2a550.jpg","comment_is_top":false,"comment_ctime":1627559648,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"14512461536","product_id":100084301,"comment_content":"å…³äºä½œä¸šï¼Œå¦‚æœä¸€å¼€å§‹å¯¹ Redis æºç ä¸ç†Ÿæ‚‰çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿç”¨ GDB å·¥å…·æ¥å›ç­” Redis æœ‰å“ªäº›åå°ä»»åŠ¡:<br><br>1) æ·»åŠ  -g çš„ç¼–ç å‚æ•°ï¼Œå‘ç¼–è¯‘æ–‡ä»¶ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼Œä»¥ä¾¿ä½¿ç”¨ GDBï¼š<br><br>make CFLAGS=&quot;-g -O0&quot;<br><br>2) cd src &amp;&amp; gdb redis-server<br><br>3) åœ¨ aeMain å‡½æ•°å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶åå†ä½¿å¾—ç¨‹åºè¿è¡Œè‡³æ­¤å¤„:<br>break aeMain<br>run<br><br>4) æŸ¥çœ‹çº¿ç¨‹ä¿¡æ¯:<br>info threads<br><br>è¿™æ—¶å€™æˆ‘ä»¬å°±èƒ½å¤Ÿçœ‹åˆ° 4 ä¸ªçº¿ç¨‹çš„ç›¸å…³ä¿¡æ¯ï¼Œåˆ†åˆ«æ˜¯ redis-serverã€bio_close_fileã€bio_aof_fsyncã€bio_lazy_freeï¼Œç„¶åå°±å¯ä»¥æŒ‰çº¿ç¨‹åç§°å†å»æºç ä¸­æŸ¥æ‰¾äº†ã€‚","like_count":4,"discussions":[{"author":{"id":1363671,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ce/d7/5315f6ce.jpg","nickname":"ä¸è´Ÿé’æ˜¥ä¸è´Ÿå·±ğŸ¤˜","note":"","ucode":"A6DD8E8B20EA6E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575158,"discussion_content":"M","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654617575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304218,"user_name":"Kang","can_delete":false,"product_type":"c1","uid":1237655,"ip_address":"","ucode":"088A8DA0A16BDE","user_header":"https://static001.geekbang.org/account/avatar/00/12/e2/97/dfadcc92.jpg","comment_is_top":false,"comment_ctime":1627295061,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14512196949","product_id":100084301,"comment_content":"è¯·é—®ä¸‹è€å¸ˆï¼Œå„ä¸ªæºç ç›®å½•çš„ä½œç”¨æ˜¯ä»é‚£é‡Œè·å–åˆ°çš„ï¼Œmysqlçš„è¯ä¹Ÿä¼šæœ‰ç›¸åº”è§£é‡Šå—","like_count":3,"discussions":[{"author":{"id":2542376,"avatar":"https://static001.geekbang.org/account/avatar/00/26/cb/28/21a8a29e.jpg","nickname":"å¤å¤©","note":"","ucode":"5F224DDAC94DFF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550886,"discussion_content":"GitHub readme å°±æœ‰å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644779574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304348,"user_name":"å°äº”","can_delete":false,"product_type":"c1","uid":1411419,"ip_address":"","ucode":"B7B1F121837CD9","user_header":"https://static001.geekbang.org/account/avatar/00/15/89/5b/b014ce14.jpg","comment_is_top":false,"comment_ctime":1627362722,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10217297314","product_id":100084301,"comment_content":"1 Redis æ”¯æŒ 3 å¤§ç±»å‹çš„åå°ä»»åŠ¡ï¼Œå®ƒä»¬å®šä¹‰åœ¨ bio.h æ–‡ä»¶ä¸­ï¼š<br>&#47;* Background job opcodes åå°ä½œä¸šæ“ä½œç <br> * 1 å¤„ç†å…³é—­æ–‡ä»¶<br> * 2 AOF å¼‚æ­¥åˆ·ç›˜<br> * 3 lazyfree<br> *&#47;<br>#define BIO_CLOSE_FILE    0 &#47;* Deferred close(2) syscall. *&#47;<br>#define BIO_AOF_FSYNC     1 &#47;* Deferred AOF fsync. *&#47;<br>#define BIO_LAZY_FREE     2 &#47;* Deferred objects freeing. *&#47;<br><br>åœ¨ Redis æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œä¼šåˆ›å»ºä»¥ä¸Šä¸‰ç±»åå°çº¿ç¨‹ï¼Œç„¶åé˜»å¡ç­‰å¾…ä»»åŠ¡çš„åˆ°æ¥ã€‚å¤„ç†å…³é—­æ–‡ä»¶å’Œ AOF å¼‚æ­¥åˆ·ç›˜å¼‚æ­¥ä»»åŠ¡æ¯”è¾ƒå¥½ç†è§£ï¼Œlazyfree ç±»å‹çš„å¼‚æ­¥ä»»åŠ¡åœºæ™¯å°±æ¯”è¾ƒå¤šäº†ï¼Œæ¯”å¦‚ä¸‹é¢å‡ ç§æƒ…å†µï¼š<br>1ï¼‰åˆ é™¤æ•°æ®ï¼šé…ç½® lazyfree_lazy_user_del ï¼Œä½¿ç”¨ unlink , éƒ½å¯èƒ½å°†åˆ é™¤å°è£…æˆä»»åŠ¡æ”¾åˆ° bio_jobs ä»»åŠ¡é˜Ÿåˆ—ä¸­<br>2) å®šæœŸåˆ é™¤æ—¶ï¼Œå¦‚æœé…ç½® lazyfree_lazy_expire ï¼Œé‚£ä¹ˆå¯èƒ½å°†åˆ é™¤å°è£…æˆä»»åŠ¡æ”¾åˆ° bio_jobs ä»»åŠ¡é˜Ÿåˆ—ä¸­<br><br>2 åå°åˆ›å»ºçš„ä»¥ä¸Šä¸‰ç§ bio åå°çº¿ç¨‹ä¼šä¸æ–­è½®è¯¢ bio_jobs ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶åˆ†é—¨åˆ«ç±»çš„å¤„ç†å¯¹åº”çš„ä»»åŠ¡ã€‚é€»è¾‘æ“ä½œå®šä¹‰åœ¨ bio.c æ–‡ä»¶ä¸­<br><br>3 åœ¨ Redis 6.0 ä¸­å¢åŠ äº† io å¤šçº¿ç¨‹ï¼Œåœ¨ networking.c ä¸­å®šä¹‰äº† io çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œä»¥åŠåˆ›å»º io_threads_num ä¸ª io çº¿ç¨‹ï¼Œè¿™äº› io çº¿ç¨‹ä¼šä¸æ–­è½®è¯¢ IO è¯»å†™ä»»åŠ¡ã€‚","like_count":2},{"had_liked":false,"id":304235,"user_name":"lison","can_delete":false,"product_type":"c1","uid":1225040,"ip_address":"","ucode":"900FCD4BD518D6","user_header":"https://static001.geekbang.org/account/avatar/00/12/b1/50/678a529b.jpg","comment_is_top":false,"comment_ctime":1627300169,"is_pvip":false,"replies":[{"id":"110489","content":"å’±ä»¬è¿™æ¬¡ä¸“æ é˜…è¯»çš„æºç ç‰ˆæœ¬æ˜¯Redis 5.0.8ï¼Œæºç æ–‡ä»¶å¯ä»¥åœ¨ https:&#47;&#47;github.com&#47;redis&#47;redis&#47;tree&#47;5.0&#47;src ä¸Šä¸‹è½½<br><br>ç¼–è¯‘å¯ä»¥å°±ç”¨gccã€‚<br><br>å¦‚æœåŒæ­¥æœ‰é—®é¢˜ï¼Œå¯ä»¥ç•™è¨€å“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"è’‹å¾·é’§","uid":"1609687","ctime":1628040786,"ip_address":"","comment_id":304235,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5922267465","product_id":100084301,"comment_content":"è€å¸ˆï¼Œæœ‰å¹¸å¬äº†æ‚¨çš„é›†è®­ç­ï¼Œæƒ³å’¨è¯¢ä¸‹ åç»­ç« èŠ‚æ˜¯å¦æœ‰å…·ä½“ç‰ˆæœ¬å’Œç¼–è¯‘å·¥å…·çš„ä»‹ç»ï¼Œåç»­å¥½å’Œæ‚¨ä¿æŒåŒæ­¥","like_count":1,"discussions":[{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"è’‹å¾·é’§","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523987,"discussion_content":"å’±ä»¬è¿™æ¬¡ä¸“æ é˜…è¯»çš„æºç ç‰ˆæœ¬æ˜¯Redis 5.0.8ï¼Œæºç æ–‡ä»¶å¯ä»¥åœ¨ https://github.com/redis/redis/tree/5.0/src ä¸Šä¸‹è½½\n\nç¼–è¯‘å¯ä»¥å°±ç”¨gccã€‚\n\nå¦‚æœåŒæ­¥æœ‰é—®é¢˜ï¼Œå¯ä»¥ç•™è¨€å“ˆ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1628040786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":348857,"user_name":"æ±¤å°é«˜","can_delete":false,"product_type":"c1","uid":1555565,"ip_address":"","ucode":"D4AB7766273D52","user_header":"https://static001.geekbang.org/account/avatar/00/17/bc/6d/f6f0a442.jpg","comment_is_top":false,"comment_ctime":1655467375,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655467375","product_id":100084301,"comment_content":"è€å¸ˆï¼Œèƒ½ä¸èƒ½æä¾›å®Œæ•´è°ƒè¯•çš„æ­å»ºç¯å¢ƒæ–¹æ¡ˆå‘€ï¼Œçœ‹æºç åº”è¯¥éœ€è¦è°ƒè¯•çš„","like_count":0},{"had_liked":false,"id":346580,"user_name":"Geek_25565b","can_delete":false,"product_type":"c1","uid":1592987,"ip_address":"","ucode":"0C3A01C4B0AB66","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/CV9kk5M26pdIuAxwdXvj90ewKECzdSmzO4ibP6iaLXY50hICibefmib4qGvu1wCSfXuRobFC86z7W3OcfncpV8Uevw/132","comment_is_top":false,"comment_ctime":1653257174,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1653257174","product_id":100084301,"comment_content":"ç”¨ä»€ä¹ˆå·¥å…·çœ‹æºç ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2675181,"avatar":"","nickname":"Geek_66617b","note":"","ucode":"D5B468568B8F39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575783,"discussion_content":"ä½¿ç”¨CLionåœ¨Windowsä¸‹è°ƒè¯•Redisè¯¦ç»†æ•™ç¨‹\nhttps://www.maoyingdong.com/redis/debug_redis/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655107101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309940,"user_name":"z","can_delete":false,"product_type":"c1","uid":2753288,"ip_address":"","ucode":"7FE4B1CFB688F1","user_header":"https://static001.geekbang.org/account/avatar/00/2a/03/08/eacfce6a.jpg","comment_is_top":false,"comment_ctime":1630401395,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630401395","product_id":100084301,"comment_content":"bioCreateBackgroundJob è¿™ä¸ªå°±æ˜¯å¼‚æ­¥æ‰§è¡Œé€»è¾‘å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":305960,"user_name":"è‚–é¹","can_delete":false,"product_type":"c1","uid":1302602,"ip_address":"","ucode":"BE1B8BD7053B9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e0/4a/c0a3cb3f.jpg","comment_is_top":false,"comment_ctime":1628243681,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1628243681","product_id":100084301,"comment_content":"å¸Œæœ›äº†è§£ä¸€ä¸‹redis å¤–éƒ¨æ•°æ®ç»“æ„åˆ°å†…éƒ¨æ•°æ®ç»“æ„ä¸­é—´æ˜¯æ€ä¹ˆè½¬æ¢çš„","like_count":0,"discussions":[{"author":{"id":1671992,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/grNrH2wy17bM79B45U5VicTWWgk6kicaX6M5a98tNXg4jC52EvQn3DSLicwgrIYCImCaviaVIiak5ANJc3uvhafBraQ/132","nickname":"Frlyh","note":"","ucode":"E40E475073C451","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391818,"discussion_content":"redisobject","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630643350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305521,"user_name":"ç»“å†°çš„æ°´æ»´","can_delete":false,"product_type":"c1","uid":1350505,"ip_address":"","ucode":"088108D4848353","user_header":"https://static001.geekbang.org/account/avatar/00/14/9b/69/b844df30.jpg","comment_is_top":false,"comment_ctime":1628008145,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"1628008145","product_id":100084301,"comment_content":"çœ‹redisæºç ï¼Œæœ‰å¥½ç”¨çš„IDEä¹ˆï¼Œè€å¸ˆèƒ½ç»™æ¨èä¸€ä¸ªä¹ˆ","like_count":0,"discussions":[{"author":{"id":2675181,"avatar":"","nickname":"Geek_66617b","note":"","ucode":"D5B468568B8F39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575784,"discussion_content":"ä½¿ç”¨CLionåœ¨Windowsä¸‹è°ƒè¯•Redisè¯¦ç»†æ•™ç¨‹\nhttps://www.maoyingdong.com/redis/debug_redis/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655107112,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1224546,"avatar":"https://static001.geekbang.org/account/avatar/00/12/af/62/5eeb9041.jpg","nickname":"é‡Œå’¯ç ´","note":"","ucode":"2DA41A6D44B3C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392417,"discussion_content":"ç°åœ¨clionå¯ä»¥å¾ˆå¥½çš„è°ƒè¯•äº†,ä»¥å‰å¾—ç”¨cmakeç¼–è¯‘,ç°åœ¨èƒ½ç›´æ¥ç¼–è¯‘makefileäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631000070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1349358,"avatar":"https://static001.geekbang.org/account/avatar/00/14/96/ee/9b21c199.jpg","nickname":"å’¸","note":"","ucode":"1F189A2B1A6A71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388143,"discussion_content":"æ‚¨è¿™è¾¹æœ‰å¥½çš„è°ƒè¯•æ–¹æ³•å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628608943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305015,"user_name":"lzh2nix","can_delete":false,"product_type":"c1","uid":1066191,"ip_address":"","ucode":"2B9AC282082F7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","comment_is_top":false,"comment_ctime":1627770939,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627770939","product_id":100084301,"comment_content":"å¦å¤–ä½ è¿˜éœ€è¦çŸ¥é“çš„æ˜¯ï¼ŒRedis çš„ä¸»ä»é›†ç¾¤åœ¨è¿›è¡Œæ¢å¤æ—¶ï¼Œä¸»è¦æ˜¯ä¾èµ–äºå“¨å…µæœºåˆ¶ï¼Œè€Œè¿™éƒ¨åˆ†åŠŸèƒ½åˆ™ç›´æ¥å®ç°åœ¨äº† sentinel.c æ–‡ä»¶ä¸­ã€‚<br><br>è€å¸ˆè¿™é‡Œçš„æè¿°æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Œredisçš„é«˜å¯ç”¨æœ‰ä¸¤ç§æ–¹å¼sentinelæ¨¡å¼å’Œclusteræ¨¡å¼ï¼Œè¿™é‡Œåœ¨clusteræ¨¡å¼ä¸‹çš„ä¸»ä»å¤åˆ¶ä¸ä¾èµ–å“¨å…µæœºåˆ¶å§ï¼Ÿ","like_count":1},{"had_liked":false,"id":305014,"user_name":"lzh2nix","can_delete":false,"product_type":"c1","uid":1066191,"ip_address":"","ucode":"2B9AC282082F7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","comment_is_top":false,"comment_ctime":1627770491,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627770491","product_id":100084301,"comment_content":"redisæ¨¡å—åŒ–åšçš„ç‰¹åˆ«å¥½ï¼Œå¦‚æœæƒ³çœ‹ä¸€ä¸ªæ¨¡å—æˆ‘éƒ½å…ˆçœ‹ä¸‹å¯¹åº”æ¨¡å—.hæ–‡ä»¶ï¼Œ åœ¨.hä¸­å¯ä»¥çœ‹åˆ°å¤–æä¾›é‡Œé‚£äº›èƒ½åŠ›ï¼Œå†å»çœ‹å…·ä½“çš„å®ç°ã€‚æœ€åå›ç­”ä»¥ä¸‹æ¯æ—¥ä¸€é—®é‡Œçš„é—®é¢˜ï¼Œåå°å¼‚æ­¥ç›¸å…³çš„çš„éƒ½æ˜¯å†bio.h&#47;bio.cä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹bio.hä¸­æä¾›äº†ä¸ªé‚£äº›èƒ½åŠ›ã€‚<br><br>void bioInit(void);<br>void bioCreateBackgroundJob(int type, void *arg1, void *arg2, void *arg3);<br>unsigned long long bioPendingJobsOfType(int type);<br>unsigned long long bioWaitStepOfType(int type);<br>time_t bioOlderJobOfType(int type);<br>void bioKillThreads(void);<br><br>&#47;* Background job opcodes *&#47;<br>#define BIO_CLOSE_FILE    0 &#47;* Deferred close(2) syscall. *&#47;<br>#define BIO_AOF_FSYNC     1 &#47;* Deferred AOF fsync. *&#47;<br>#define BIO_LAZY_FREE     2 &#47;* Deferred objects freeing. *&#47;<br>#define BIO_NUM_OPS       3<br><br>åœ¨ç§ç±»å®šä¹‰å¯¹å¤–çš„API(ç®¡ç†BIOç›¸å…³çš„ä»»åŠ¡)ï¼Œ å·²ç»æœ‰ä¸‰ç§backgroup jopï¼Œç„¶åå†å»çœ‹è¿™ä¸ªä¸‰ç§jobçš„å…·ä½“å®ç°ã€‚åœ¨bio.cä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°pthreadçš„ç»å…¸ç”¨æ³•ã€‚","like_count":0},{"had_liked":false,"id":304960,"user_name":"lzh2nix","can_delete":false,"product_type":"c1","uid":1066191,"ip_address":"","ucode":"2B9AC282082F7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","comment_is_top":false,"comment_ctime":1627717981,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1627717981","product_id":100084301,"comment_content":"&quot;åŒ…æ‹¬ glibc åº“æä¾›çš„é»˜è®¤åˆ†é…å™¨ tcmalloc&quot;<br><br>è€å¸ˆè¿™é‡Œæè¿°æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Œ glibcä½¿ç”¨çš„æ˜¯ptmalloc(å‚è€ƒ https:&#47;&#47;www.gnu.org&#47;software&#47;libc&#47;manual&#47;html_node&#47;The-GNU-Allocator.html)ï¼Œtcmallocæ˜¯googleæå‡ºæ¥çš„ï¼Œgolangé»˜è®¤é‡‡ç”¨çš„æ˜¯tcmallocã€‚","like_count":0,"discussions":[{"author":{"id":1188710,"avatar":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","nickname":"LDxy","note":"","ucode":"956432CE7B7761","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391386,"discussion_content":"è¿™ä¸ªçš„æ•ˆç‡å¾ˆä½å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630426640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304452,"user_name":"å†¯ç£Š","can_delete":false,"product_type":"c1","uid":1855112,"ip_address":"","ucode":"4FFB8B984269FB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIYj6Zv3ibicLebxo7lsPMEwpBynHkYp8pLc3FcltUfmOBSRxpmicEwIAgP9OvSKnGGdaxwsZ7yiciaSsQ/132","comment_is_top":false,"comment_ctime":1627433348,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627433348","product_id":100084301,"comment_content":"ç­‰æˆ‘å¤ä¹ ä¸‹cè¯­è¨€ï¼Œé©¬ä¸Šå›æ¥ï¼","like_count":0},{"had_liked":false,"id":304390,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1627380802,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627380802","product_id":100084301,"comment_content":"ä»¥unlinkä¸ºä¾‹å­ï¼Œå…¶å®æ˜¯æœ‰å‡ ä¸ªæ­¥éª¤çš„ï¼š<br>    1ã€é¦–å…ˆåœ¨rediså¯åŠ¨çš„æ—¶å€™ä¼šè°ƒç”¨bioInitåˆå§‹åŒ–å¼‚æ­¥æ‰§è¡Œçš„çº¿ç¨‹ï¼Œç­‰å¾…æ³¨å†Œä»»åŠ¡æ‰§è¡Œï¼ˆæˆªè‡³åˆ°6.xç‰ˆæœ¬ç›®å‰åªåˆå§‹åŒ–ä¸‰ä¸ªçº¿ç¨‹ï¼Œå¯¹åº”ä¸‰ç§å¼‚æ­¥ç±»å‹ï¼Œæ¯ä¸ªçº¿ç¨‹åªå¤„ç†æŒ‡å®šç±»å‹çš„ä»»åŠ¡ï¼Œæ¦‚å¿µä¸Šå’Œçº¿ç¨‹æ± ä¸ä¸€æ ·ï¼‰<br>    2ã€å½“æ‰§è¡Œunlinkçš„æ—¶å€™ï¼Œå…ˆåˆ é™¤keyåœ¨å­—å…¸ä¸Šçš„æŒ‡é’ˆï¼Œå¦‚æœä¸éœ€è¦å¼‚æ­¥ç›´æ¥ä½¿ç”¨dictFreeUnlinkedEntryé‡Šæ”¾å†…å­˜ï¼Œå¦‚æœéœ€è¦ç›´æ¥è·³è¿‡é‡Šæ”¾æ­¥éª¤<br>    3ã€é€šè¿‡lazyfreeGetFreeEffortå‡½æ•°è®¡ç®—åˆ é™¤keyçš„ä»£ä»·ï¼Œå¦‚æœä»£ä»·è¶…è¿‡é˜ˆå€¼åˆ™æ³¨å†Œä¸€ä¸ªbioCreateLazyFreeJob å¹¶æ ‡è®°ç±»å‹ä¸ºBIO_LAZY_FREEç­‰å¾…å¼‚æ­¥æ‰§è¡Œ<br>    4ã€å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œjobé‡Šæ”¾å†…å­˜<br><br><br><br>å®é™…ä»£ç æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š<br>    1ã€unlinkä¸»æµç¨‹ï¼ˆå…è®¸å¼‚æ­¥ï¼‰ï¼šunlinkCommand -&gt; delGenericCommand -&gt; dbAsyncDelete -&gt; dictUnlink -&gt; æ³¨å†ŒbioCreateBackgroundJob<br>    2ã€unlinkä¸»æµç¨‹ï¼ˆä¸ç”¨å¼‚æ­¥ï¼‰ï¼šunlinkCommand -&gt; delGenericCommand -&gt; dbAsyncDelete -&gt; dictUnlink -&gt; dictFreeUnlinkedEntry(ç›´æ¥é‡Šæ”¾å†…å­˜)<br><br>å¯¹åº”çš„ä»£ç åœ¨lazyfree.cå’Œbio.cæ–‡ä»¶ä¸­ï¼Œæ­¤å¤–å¼‚æ­¥æ‰§è¡Œä¸€å…±æ”¯æŒä¸‰ç§ç±»å‹ BIO_CLOSE_FILEï¼ˆå¼‚æ­¥å…³é—­æ–‡ä»¶ï¼‰BIO_AOF_FSYNCï¼ˆAOFå¼‚æ­¥åŒæ­¥ï¼‰ BIO_LAZY_FREEï¼ˆæ‡’åˆ é™¤ï¼‰","like_count":0},{"had_liked":false,"id":304346,"user_name":"sljoai","can_delete":false,"product_type":"c1","uid":1018071,"ip_address":"","ucode":"FF88C4BA265DE0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/88/d7/07f8bc6c.jpg","comment_is_top":false,"comment_ctime":1627362294,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"1627362294","product_id":100084301,"comment_content":"æ²¡ä»€ä¹ˆCè¯­è¨€å¼€å‘ç»éªŒï¼Œè¯·é—®ä¸€ä¸‹å¤§å®¶éƒ½æ˜¯é‡‡ç”¨å“ªç§å¼€å‘å·¥å…·æ¥æŸ¥çœ‹åŠè°ƒè¯•Redisæºç çš„?","like_count":0,"discussions":[{"author":{"id":2187697,"avatar":"https://static001.geekbang.org/account/avatar/00/21/61/b1/8bacdc31.jpg","nickname":"å½“å½“å½“å½“","note":"","ucode":"A5210F5EC47F74","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386142,"discussion_content":"InteliJçš„Clionï¼Œæ„Ÿè§‰ideaç”¨ä¹ æƒ¯äº†ç”¨è¿™ä¸ªéå¸¸èˆ’æœçš„","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1627440855,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1271258,"avatar":"https://static001.geekbang.org/account/avatar/00/13/65/da/0bcc39eb.jpg","nickname":"é«˜è¿›","note":"","ucode":"BB78F1E377A82D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2187697,"avatar":"https://static001.geekbang.org/account/avatar/00/21/61/b1/8bacdc31.jpg","nickname":"å½“å½“å½“å½“","note":"","ucode":"A5210F5EC47F74","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":391567,"discussion_content":"æˆ‘è¿™ä¸ªjavaer ç”¨clion  ï¼Œæ‰‹åˆ°æ“’æ¥ å’Œideaä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630513910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386142,"ip_address":""},"score":391567,"extra":""}]},{"author":{"id":1082412,"avatar":"https://static001.geekbang.org/account/avatar/00/10/84/2c/37064b41.jpg","nickname":"wuyue8hao","note":"","ucode":"6D0FA21784A99B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587077,"discussion_content":"sourceinsight","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662743456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1271812,"avatar":"https://static001.geekbang.org/account/avatar/00/13/68/04/a5d81cb1.jpg","nickname":"å°¹æ”¿","note":"","ucode":"D98663ABE1723C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386160,"discussion_content":"understand","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627454049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1451391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","nickname":"æ›¾è½¼éºŸ","note":"","ucode":"D418371AC11270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386035,"discussion_content":"GDB","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627385576,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304270,"user_name":"Leven","can_delete":false,"product_type":"c1","uid":1701728,"ip_address":"","ucode":"0915094BC4C0C5","user_header":"https://static001.geekbang.org/account/avatar/00/19/f7/60/31c5873e.jpg","comment_is_top":false,"comment_ctime":1627310845,"is_pvip":false,"replies":[{"id":"110491","content":"å»ºè®®è¦æœ‰äº›Cè¯­è¨€çš„è¯­æ³•åŸºç¡€ï¼Œä¾‹å¦‚åŸºæœ¬æ•°æ®ç±»å‹ã€ç»“æ„ä½“ã€è”åˆä½“ã€å®å®šä¹‰ã€æ§åˆ¶åˆ†æ”¯ã€å‡½æ•°è°ƒç”¨ã€æŒ‡é’ˆç­‰è¿™äº›æ¦‚å¿µè¦æœ‰ã€‚<br><br>å¦åˆ™è¯»èµ·æ¥ä¼šæœ‰äº›è¾›è‹¦çš„","user_name":"ä½œè€…å›å¤","user_name_real":"è’‹å¾·é’§","uid":"1609687","ctime":1628041030,"ip_address":"","comment_id":304270,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1627310845","product_id":100084301,"comment_content":"è¯·é—®è€å¸ˆï¼Œæ²¡æœ‰cè¯­è¨€åŸºç¡€é€‚åˆå—","like_count":0,"discussions":[{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"è’‹å¾·é’§","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523998,"discussion_content":"å»ºè®®è¦æœ‰äº›Cè¯­è¨€çš„è¯­æ³•åŸºç¡€ï¼Œä¾‹å¦‚åŸºæœ¬æ•°æ®ç±»å‹ã€ç»“æ„ä½“ã€è”åˆä½“ã€å®å®šä¹‰ã€æ§åˆ¶åˆ†æ”¯ã€å‡½æ•°è°ƒç”¨ã€æŒ‡é’ˆç­‰è¿™äº›æ¦‚å¿µè¦æœ‰ã€‚\n\nå¦åˆ™è¯»èµ·æ¥ä¼šæœ‰äº›è¾›è‹¦çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628041030,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304227,"user_name":"å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1627298193,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627298193","product_id":100084301,"comment_content":"ä¸€è®²è¿™ä¹ˆé•¿ï¼Œå¿…é¡»ä¹°","like_count":0}]}