{"id":111481,"title":"38 | JWT有哪两种主要流程？","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":127288,"user_name":"WL","can_delete":false,"product_type":"c3","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1566636528,"is_pvip":false,"replies":[{"id":47224,"content":"技术上可以实现，比如吊销时，授权服务器发通知消息，网关订阅吊销通知，请求经过网关做令牌验证时，网关看令牌是否已经吊销。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1566746182,"ip_address":"","comment_id":127288,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"请问老师吊销的方式能不能采用是授权服务器请求网关告知网关哪个用户jwt令牌要吊销，这样就实现了呀","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464417,"discussion_content":"技术上可以实现，比如吊销时，授权服务器发通知消息，网关订阅吊销通知，请求经过网关做令牌验证时，网关看令牌是否已经吊销。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566746182,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1066684,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/bc/463cca3f.jpg","nickname":"DDs moving castle","note":"","ucode":"08CA816F665E39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":47594,"discussion_content":"波波老师回复的做法我之前在网上见过，类似黑名单机制，但这种黑名单机制不算把JWT变成了有状态吗？？我不太确定。\n另外为了避免每次到Auth Service校验黑名单，也是需要将黑名单同步订阅到网关的，多少增加了复杂度；\n再另外，如果将之前集中式认证架构中，在Auth Service登录认证后，也在网关这种对认证功能抽取出来的服务上再做一次自动登录，也维护一个登录态，即多登陆态的维护，这样网关再校验是否登录的时候，本身就可以校验了，不用请求Auth Service，这样虽然也会比较复杂，但不是也降低了对Auth Service性能的要求，也可以扩展了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573375686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119502,"user_name":"Continue","can_delete":false,"product_type":"c3","uid":1315789,"ip_address":"","ucode":"C3C260907F6DF5","user_header":"https://static001.geekbang.org/account/avatar/00/14/13/cd/db3e4640.jpg","comment_is_top":false,"comment_ctime":1564620042,"is_pvip":false,"replies":[{"id":43921,"content":"在jwt的公私钥模式中，私钥存在Auth服务器上，不能存客户端，公钥一般也不存客户端(存网关或者后台服务器上)，即使存客户端也没有大关系，公钥本来就是公开的，只不过能够解签jwt，不能篡改数据。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1564673161,"ip_address":"","comment_id":119502,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师，安卓可以被反编译，app端怎么存储公私钥，才能保证不被泄露呢，","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460932,"discussion_content":"在jwt的公私钥模式中，私钥存在Auth服务器上，不能存客户端，公钥一般也不存客户端(存网关或者后台服务器上)，即使存客户端也没有大关系，公钥本来就是公开的，只不过能够解签jwt，不能篡改数据。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564673161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1315789,"avatar":"https://static001.geekbang.org/account/avatar/00/14/13/cd/db3e4640.jpg","nickname":"Continue","note":"","ucode":"C3C260907F6DF5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3682,"discussion_content":"不好意思老师，是我没有描述清楚，现在我们有一个app，服务端给app提供接口，一些重要的接口需要加权限控制（只有我们自己的app可以调用），怎样做才可以防止被爬呢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564707193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":275210,"user_name":"浩仔是程序员","can_delete":false,"product_type":"c3","uid":1104601,"ip_address":"","ucode":"A7E5CF9E1571A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/d9/f051962f.jpg","comment_is_top":false,"comment_ctime":1611390534,"is_pvip":false,"replies":[{"id":100284,"content":"过期了重新登录，或者提前使用refresh token机制获取新的token。\n\n令牌和信用卡&#47;签名支票&#47;身份证有点类似，被别人拿去是可以用的。但是可以通过https和设置合理的token过期时间来减轻风险。\n\n对于传统的web session，session id&#47;cookie之类也可能被截获，道理一样。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1611848457,"ip_address":"","comment_id":275210,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"JWT是怎么过期的？如果我截获了JWT令牌那不是可以一直访问？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514262,"discussion_content":"过期了重新登录，或者提前使用refresh token机制获取新的token。\n\n令牌和信用卡/签名支票/身份证有点类似，被别人拿去是可以用的。但是可以通过https和设置合理的token过期时间来减轻风险。\n\n对于传统的web session，session id/cookie之类也可能被截获，道理一样。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611848457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":189221,"user_name":"彬清","can_delete":false,"product_type":"c3","uid":1220372,"ip_address":"","ucode":"04620BAC60F15F","user_header":"https://static001.geekbang.org/account/avatar/00/12/9f/14/b9505789.jpg","comment_is_top":false,"comment_ctime":1584490220,"is_pvip":false,"replies":[{"id":73407,"content":"有很多提前失效的做法，比如在staffjoy案例应用中，jwt是存在cookie中的，只需要把cookie清掉，就可以看作提前登出，后续必须重新登录，具体看staffjoy源码。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1584789546,"ip_address":"","comment_id":189221,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师好，jwt是不是只有等到有效期到了才会失效？那么用户如何退出登录？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487636,"discussion_content":"有很多提前失效的做法，比如在staffjoy案例应用中，jwt是存在cookie中的，只需要把cookie清掉，就可以看作提前登出，后续必须重新登录，具体看staffjoy源码。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584789546,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1523315,"avatar":"","nickname":"GeekCoder","note":"","ucode":"14BB73CBE28545","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":574347,"discussion_content":"那我在多个地方登录后，岂不是都能用？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653987714,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":487636,"ip_address":"","group_id":0},"score":574347,"extra":""}]}]},{"had_liked":false,"id":282073,"user_name":"美好时光海苔","can_delete":false,"product_type":"c3","uid":1904626,"ip_address":"","ucode":"CD4637BFC8A7C6","user_header":"https://static001.geekbang.org/account/avatar/00/1d/0f/f2/3f3c0946.jpg","comment_is_top":false,"comment_ctime":1615044413,"is_pvip":false,"replies":[{"id":102736,"content":"理论上存在这种情况，如果调B时令牌过期了，那么就返回令牌调用失败响应。\n\n实际情况是：\n1. 一般在令牌过期前，用户端一般会提前刷新令牌，所以调内部服务时你说的这种情况一般是不会发生的。\n2. 一般在前置的网关层集中校验令牌，转换成用户信息header，再向后传递，所以内部不需要再传令牌，而是传用户信息\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1615642074,"ip_address":"","comment_id":282073,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师，如果微服务之间需要相互调用，应该使用 发起请求的用户 的 token 还是 微服务自己的token。\n\n比如 用户请求 -&gt; 服务A -&gt; 服务B，如果 用户的token 在调用服务A时还没有过期 但是在调用B之前 刚好过期了怎么办？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516608,"discussion_content":"理论上存在这种情况，如果调B时令牌过期了，那么就返回令牌调用失败响应。\n\n实际情况是：\n1. 一般在令牌过期前，用户端一般会提前刷新令牌，所以调内部服务时你说的这种情况一般是不会发生的。\n2. 一般在前置的网关层集中校验令牌，转换成用户信息header，再向后传递，所以内部不需要再传令牌，而是传用户信息\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615642074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":123404,"user_name":"亚林","can_delete":false,"product_type":"c3","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1565668706,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"jwt的用户信息直接来自于令牌本身；透明令牌需要拿着令牌去查询用户信息。","like_count":4},{"had_liked":false,"id":188784,"user_name":"钱","can_delete":false,"product_type":"c3","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1584415364,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"jwt自包含用户信息，获取时需要钥匙，安全不敏感的应用适合使用。\n透明令牌就类似一把钥匙，用于获取用户信息，安全敏感的应用适合使用。","like_count":1},{"had_liked":false,"id":373019,"user_name":"芋头","can_delete":false,"product_type":"c3","uid":1227492,"ip_address":"广东","ucode":"A9C875548E4EE5","user_header":"https://static001.geekbang.org/account/avatar/00/12/ba/e4/6df89add.jpg","comment_is_top":false,"comment_ctime":1681923127,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"jwt无状态自包含，减轻认证服务器压力，同时包含用户信息\n透明令牌有状态，集中在认证服务器，类似session id，不包含用户信息","like_count":0},{"had_liked":false,"id":308325,"user_name":"艺超(鲁鸣)","can_delete":false,"product_type":"c3","uid":1029436,"ip_address":"","ucode":"7F749FA543E0F1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg","comment_is_top":false,"comment_ctime":1629536078,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"基于rsa的有点疑问，如果公钥是开放的，那岂不是被拦截后都可以解析到jwt信息了","like_count":0}]}