{"id":424550,"title":"13 | Spark SQLï¼šè®©æˆ‘ä»¬ä»â€œå°æ±½è½¦æ‘‡å·åˆ†æâ€å¼€å§‹","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>åœ¨å¼€ç¯‡è¯æˆ‘ä»¬æå‡ºâ€œå…¥é—¨Sparkéœ€è¦ä¸‰æ­¥èµ°â€ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æºæ‰‹å¹¶è‚©è·¨è¶Šäº†å‰é¢ä¸¤æ­¥ï¼Œé¦–å…ˆæ­å–œä½ å­¦åˆ°è¿™é‡Œï¼ç†Ÿç»ƒæŒæ¡äº†Sparkå¸¸ç”¨ç®—å­ä¸æ ¸å¿ƒåŸç†ä»¥åï¼Œä½ å·²ç»å¯ä»¥è½»æ¾åº”å¯¹å¤§éƒ¨åˆ†æ•°æ®å¤„ç†éœ€æ±‚äº†ã€‚</p><p>ä¸è¿‡ï¼Œæ•°æ®å¤„ç†æ¯•ç«Ÿæ˜¯æ¯”è¾ƒåŸºç¡€çš„æ•°æ®åº”ç”¨åœºæ™¯ï¼Œå°±åƒèµ›è½¦æœ‰ç€ä¸åŒçš„é©¾é©¶åœºæ™¯ï¼Œæƒ³æˆä¸ºSparkçš„èµ„æ·±èµ›è½¦æ‰‹ï¼Œæˆ‘ä»¬è¿˜è¦èµ°å‡ºç¬¬ä¸‰æ­¥â€”â€”å­¦ä¹ Sparkè®¡ç®—å­æ¡†æ¶ã€‚åªæœ‰å®Œæˆè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬æ‰èƒ½æŒæ¡Spark SQLï¼ŒStructured Streamingå’ŒSpark MLlibçš„å¸¸è§„å¼€å‘æ–¹æ³•ï¼Œæ¸¸åˆƒæœ‰ä½™åœ°åº”å¯¹ä¸åŒçš„æ•°æ®åº”ç”¨åœºæ™¯ï¼Œå¦‚æ•°æ®åˆ†æã€æµè®¡ç®—å’Œæœºå™¨å­¦ä¹ ï¼Œç­‰ç­‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6a/a3/6a56c520ab7666d1bb9dd1f0683346a3.jpg?wh=1920x915\" alt=\"å›¾ç‰‡\" title=\"è¿˜å·®ç¬¬ä¸‰æ­¥\"></p><p>é‚£è¿™ä¹ˆå¤šå­æ¡†æ¶ï¼Œä»å“ªé‡Œå…¥æ‰‹æ¯”è¾ƒå¥½å‘¢ï¼Ÿåœ¨æ‰€æœ‰çš„å­æ¡†æ¶ä¸­ï¼ŒSpark SQLæ˜¯ä»£ç é‡æœ€å¤šã€Sparkç¤¾åŒºæŠ•å…¥æœ€å¤§ã€åº”ç”¨èŒƒå›´æœ€å¹¿ã€å½±å“åŠ›æœ€æ·±è¿œçš„é‚£ä¸ªã€‚å°±å­æ¡†æ¶çš„å­¦ä¹ æ¥è¯´ï¼Œæˆ‘ä»¬è‡ªç„¶è¦ä»Spark SQLå¼€å§‹ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬ä»ä¸€ä¸ªä¾‹å­å…¥æ‰‹ï¼Œåœ¨å®æˆ˜ä¸­å¸¦ä½ ç†Ÿæ‚‰æ•°æ®åˆ†æå¼€å‘çš„æ€è·¯å’Œå®ç°æ­¥éª¤ã€‚æœ‰äº†å¯¹Spark SQLçš„ç›´è§‚ä½“éªŒï¼Œæˆ‘ä»¬åé¢å‡ è®²è¿˜ä¼šæ·±å…¥æ¢è®¨Spark SQLçš„ç”¨æ³•ã€ç‰¹æ€§ä¸ä¼˜åŠ¿ï¼Œè®©ä½ é€æ­¥æŒæ¡Spark SQLçš„å…¨è²Œã€‚</p><h2>ä¸šåŠ¡éœ€æ±‚</h2><p>ä»Šå¤©æˆ‘ä»¬è¦è®²çš„å°ä¾‹å­ï¼Œæ¥è‡ªäºåŒ—äº¬å¸‚å°æ±½è½¦æ‘‡å·ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä¸ºäº†é™åˆ¶æœºåŠ¨è½¦ä¿æœ‰é‡ï¼Œä»2011å¹´å¼€å§‹ï¼ŒåŒ—äº¬å¸‚æ”¿åºœæ¨å‡ºäº†å°æ±½è½¦æ‘‡å·æ”¿ç­–ã€‚éšç€æ‘‡å·è¿›ç¨‹çš„æ¨è¿›ï¼Œåœ¨2016å¹´ï¼Œä¸ºäº†ç…§é¡¾é‚£äº›é•¿æ—¶é—´æ²¡æœ‰æ‘‡ä¸­å·ç ç‰Œçš„â€œå‡†å¸æœºâ€ï¼Œæ‘‡å·æ”¿ç­–åˆæ¨å‡ºäº†â€œå€ç‡â€åˆ¶åº¦ã€‚</p><!-- [[[read_end]]] --><p>æ‰€è°“å€ç‡åˆ¶åº¦ï¼Œå®ƒæŒ‡çš„æ˜¯ï¼Œç»“åˆå‚ä¸æ‘‡å·æ¬¡æ•°ï¼Œä¸ºæ¯ä¸ªäººèµ‹äºˆä¸åŒçš„å€ç‡ç³»æ•°ã€‚æœ‰äº†å€ç‡åŠ æŒï¼Œå¤§å®¶çš„ä¸­ç­¾ç‡å°±ç”±åŸæ¥æ•´é½åˆ’ä¸€çš„åŸºç¡€æ¦‚ç‡ï¼Œå˜ä¸ºâ€œ<strong>åŸºç¡€æ¦‚ç‡ * å€ç‡ç³»æ•°</strong>â€ã€‚å‚ä¸æ‘‡å·çš„æ¬¡æ•°è¶Šå¤šï¼Œå€ç‡ç³»æ•°è¶Šå¤§ï¼Œä¸­ç­¾ç‡ä¹Ÿä¼šç›¸åº”å¾—åˆ°æé«˜ã€‚</p><p>ä¸è¿‡ï¼Œèº«è¾¹æ— æ•°çš„â€œå‡†å¸æœºâ€æ€»æ˜¯è·Ÿæˆ‘è¯´ï¼Œå…¶å®å€ç‡è¿™ç©æ„æ²¡ä»€ä¹ˆç”¨ï¼ŒèƒŒäº†8å€ã€10å€çš„å€ç‡ï¼Œç…§æ ·æ‘‡ä¸ä¸Šï¼é‚£ä¹ˆä»Šå¤©è¿™ä¸€è®²ï¼Œå’±ä»¬å°±æ¥å€Ÿç€å­¦ä¹ Spark SQLçš„æœºä¼šï¼Œç”¨æ•°æ®æ¥ä¸ºè¿™äº›è¿˜æ²¡æ‘¸è¿‡è½¦çš„â€œè€å¸æœºâ€ç­”ç–‘è§£æƒ‘ï¼Œå¸®ä»–ä»¬å®šé‡åœ°åˆ†æä¸€ä¸‹ï¼Œå€ç‡ä¸ä¸­ç­¾ç‡ä¹‹é—´ï¼Œåˆ°åº•æœ‰æ²¡æœ‰å…³ç³»ï¼Ÿ</p><h2>å‡†å¤‡å·¥ä½œ</h2><p>å·§å¦‡éš¾ä¸ºæ— ç±³ä¹‹ç‚Šï¼Œæ—¢ç„¶æ˜¯åšæ•°æ®åˆ†æï¼Œé‚£å’±ä»¬å¾—å…ˆæœ‰æ•°æ®æ‰è¡Œã€‚æˆ‘è¿™è¾¹ä¸ºä½ å‡†å¤‡äº†2011å¹´åˆ°2019å¹´åŒ—äº¬å¸‚å°æ±½è½¦çš„æ‘‡å·æ•°æ®ï¼Œä½ å¯ä»¥é€šè¿‡<a href=\"https://pan.baidu.com/s/1Vys1Z1mofQFoU52ye7SKuw\">è¿™ä¸ªåœ°å€</a>ï¼Œä»ç½‘ç›˜è¿›è¡Œä¸‹è½½ï¼Œæå–ç ä¸ºajs6ã€‚</p><p>è¿™ä»½æ•°æ®çš„æ–‡ä»¶åæ˜¯â€œ2011-2019 å°æ±½è½¦æ‘‡å·æ•°æ®.tar.gzâ€ï¼Œè§£å‹ä¹‹åçš„ç›®å½•ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¹ç›®å½•ä¸‹æœ‰applyå’Œluckyä¸¤ä¸ªå­ç›®å½•ï¼Œapplyç›®å½•çš„å†…å®¹æ˜¯ 2011-2019 å¹´å„ä¸ªæ‰¹æ¬¡å‚ä¸æ‘‡å·çš„ç”³è¯·å·ç ï¼Œè€Œluckyç›®å½•åŒ…å«çš„æ˜¯å„ä¸ªæ‰¹æ¬¡ä¸­ç­¾çš„ç”³è¯·å·ç ã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠå‚ä¸è¿‡æ‘‡å·çš„äººå«â€œç”³è¯·è€…â€ï¼ŒæŠŠä¸­ç­¾çš„äººå«â€œä¸­ç­¾è€…â€ã€‚applyå’Œluckyçš„ä¸‹ä¸€çº§å­ç›®å½•æ˜¯å„ä¸ªæ‘‡å·æ‰¹æ¬¡ï¼Œè€Œæ‘‡å·æ‰¹æ¬¡ç›®å½•ä¸‹åŒ…å«çš„æ˜¯Parquetæ ¼å¼çš„æ•°æ®æ–‡ä»¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/65/93/659f18d2e1c851byye56553cbcff7b93.jpg?wh=1920x1389\" alt=\"å›¾ç‰‡\" title=\"æ•°æ®çš„ç›®å½•ç»“æ„\"></p><p>æ•°æ®ä¸‹è½½ã€è§£å‹å®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥å‡†å¤‡è¿è¡Œç¯å¢ƒã€‚</p><p>å’±ä»¬çš„å°ä¾‹å­æ¯”è¾ƒè½»é‡ï¼ŒScalaç‰ˆæœ¬çš„ä»£ç å®ç°ä¸ä¼šè¶…è¿‡20è¡Œï¼Œå†è€…æ‘‡å·æ•°æ®ä½“é‡å¾ˆå°ï¼Œè§£å‹ä¹‹åçš„Parquetæ–‡ä»¶æ€»å¤§å°ä¹Ÿä¸è¶…è¿‡4Gã€‚</p><p>é€‰æ‹©è¿™æ ·çš„ä¾‹å­ä¹Ÿæ˜¯ä¸ºäº†è½»è£…ä¸Šé˜µï¼Œé¿å…ä½ å› ä¸ºç¡¬ä»¶é™åˆ¶è€Œéš¾ä»¥å®éªŒã€‚æƒ³è¦æŠŠç”¨äºåˆ†æå€ç‡çš„åº”ç”¨è·‘èµ·æ¥ï¼Œä½ åœ¨ç¬”è®°æœ¬æˆ–æ˜¯PCä¸Šï¼Œé€šè¿‡å¯åŠ¨æœ¬åœ°spark-shellç¯å¢ƒå°±å¯ä»¥ã€‚ä¸è¿‡ï¼Œå¦‚æœæ¡ä»¶å…è®¸çš„è¯ï¼Œæˆ‘è¿˜æ˜¯é¼“åŠ±ä½ æ­å»ºåˆ†å¸ƒå¼çš„ç‰©ç†é›†ç¾¤ã€‚å…³äºåˆ†å¸ƒå¼é›†ç¾¤çš„æ­å»ºç»†èŠ‚ï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"https://time.geekbang.org/column/article/419200\">ç¬¬4è®²</a>ã€‚</p><p>å¥½å•¦ï¼Œå‡†å¤‡å¥½æ•°æ®ä¸è¿è¡Œç¯å¢ƒä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ­¥å…¥æ­£é¢˜ï¼Œå»å¼€å‘æ¢ç´¢å€ç‡ä¸ä¸­ç­¾ç‡å…³ç³»çš„æ•°æ®åˆ†æåº”ç”¨å•¦ã€‚</p><h2>æ•°æ®æ¢ç´¢</h2><p>ä¸è¿‡ï¼Œå…ˆåˆ«å¿™ç€ç›´æ¥ä¸Šæ‰‹æ•°æ®åˆ†æã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦å¯¹æ•°æ®æ¨¡å¼ï¼ˆData Schemaï¼‰æœ‰æœ€åŸºæœ¬çš„è®¤çŸ¥ï¼Œä¹Ÿå°±æ˜¯æºæ•°æ®éƒ½æœ‰å“ªäº›å­—æ®µï¼Œè¿™äº›å­—æ®µçš„ç±»å‹å’Œå«ä¹‰åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸€æ­¥å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æ•°æ®æ¢ç´¢ã€‚</p><p>æ•°æ®æ¢ç´¢çš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨SparkSessionçš„read APIè¯»å–æºæ•°æ®ã€åˆ›å»ºDataFrameã€‚ç„¶åï¼Œé€šè¿‡è°ƒç”¨DataFrameçš„showæ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½»æ¾è·å–æºæ•°æ®çš„æ ·æœ¬æ•°æ®ï¼Œä»è€Œå®Œæˆæ•°æ®çš„åˆæ­¥æ¢ç´¢ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">import org.apache.spark.sql.DataFrame\n&nbsp;\nval rootPath: String = _\n// ç”³è¯·è€…æ•°æ®\nval hdfs_path_apply: String = s\"${rootPath}/apply\"\n// sparkæ˜¯spark-shellä¸­é»˜è®¤çš„SparkSessionå®ä¾‹\n// é€šè¿‡read APIè¯»å–æºæ–‡ä»¶\nval applyNumbersDF: DataFrame = spark.read.parquet(hdfs_path_apply)\n// æ•°æ®æ‰“å°\napplyNumbersDF.show\n&nbsp;\n// ä¸­ç­¾è€…æ•°æ®\nval hdfs_path_lucky: String = s\"${rootPath}/lucky\"\n// é€šè¿‡read APIè¯»å–æºæ–‡ä»¶\nval luckyDogsDF: DataFrame = spark.read.parquet(hdfs_path_lucky)\n// æ•°æ®æ‰“å°\nluckyDogsDF.show\n</code></pre><p>çœ‹åˆ°è¿™é‡Œï¼Œæƒ³å¿…ä½ å·²ç»çœ‰å¤´ç´§é”ï¼šâ€œSparkSessionï¼ŸDataFrameï¼Ÿè¿™äº›éƒ½æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿä½ å¥½åƒå‹æ ¹å„¿ä¹Ÿæ²¡æœ‰æåˆ°è¿‡è¿™äº›æ¦‚å¿µå‘€ï¼â€åˆ«ç€æ€¥ï¼Œå¯¹äºè¿™äº›å…³é”®æ¦‚å¿µï¼Œæˆ‘ä»¬åœ¨åç»­çš„è¯¾ç¨‹ä¸­éƒ½ä¼šé™†ç»­å±•å¼€ï¼Œä»Šå¤©è¿™ä¸€è®²ï¼Œå’±ä»¬å…ˆæ¥â€œçŸ¥å…¶ç„¶â€ï¼Œâ€œçŸ¥å…¶æ‰€ä»¥ç„¶â€çš„éƒ¨åˆ†å’±ä»¬æ”¾åˆ°åé¢å»è®²ã€‚</p><p>å¯¹äºSparkSessionï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºæ˜¯SparkContextçš„è¿›é˜¶ç‰ˆï¼Œæ˜¯Sparkï¼ˆ2.0ç‰ˆæœ¬ä»¥åï¼‰æ–°ä¸€ä»£çš„å¼€å‘å…¥å£ã€‚SparkContexté€šè¿‡textFile APIæŠŠæºæ•°æ®è½¬æ¢ä¸ºRDDï¼Œè€ŒSparkSessioné€šè¿‡read APIæŠŠæºæ•°æ®è½¬æ¢ä¸ºDataFrameã€‚</p><p>è€ŒDataFrameï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ç§ç‰¹æ®Šçš„RDDã€‚RDDæˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œç°åœ¨å°±æŠŠDataFrameè·ŸRDDåšä¸ªå¯¹æ¯”ï¼Œè®©ä½ å…ˆå¯¹DataFrameæœ‰ä¸ªæ„Ÿæ€§è®¤è¯†ã€‚</p><p>å…ˆä»åŠŸèƒ½åˆ†æï¼Œä¸RDDä¸€æ ·ï¼ŒDataFrameä¹Ÿç”¨æ¥å°è£…åˆ†å¸ƒå¼æ•°æ®é›†ï¼Œå®ƒä¹Ÿæœ‰æ•°æ®åˆ†åŒºçš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯é€šè¿‡ç®—å­æ¥å®ç°ä¸åŒDataFrameä¹‹é—´çš„è½¬æ¢ï¼Œåªä¸è¿‡DataFrameé‡‡ç”¨äº†ä¸€å¥—ä¸RDDç®—å­ä¸åŒçš„ç‹¬ç«‹ç®—å­é›†ã€‚</p><p>å†è€…ï¼Œåœ¨æ•°æ®å†…å®¹æ–¹é¢ï¼Œä¸RDDä¸åŒï¼ŒDataFrameæ˜¯ä¸€ç§å¸¦Schemaçš„åˆ†å¸ƒå¼æ•°æ®é›†ï¼Œå› æ­¤ï¼Œä½ å¯ä»¥ç®€å•åœ°æŠŠDataFrameçœ‹ä½œæ˜¯æ•°æ®åº“ä¸­çš„ä¸€å¼ äºŒç»´è¡¨ã€‚</p><p>æœ€åï¼ŒDataFrameèƒŒåçš„è®¡ç®—å¼•æ“æ˜¯Spark SQLï¼Œè€ŒRDDçš„è®¡ç®—å¼•æ“æ˜¯Spark Coreï¼Œè¿™ä¸€ç‚¹è‡³å…³é‡è¦ã€‚ä¸è¿‡ï¼Œå…³äºè®¡ç®—å¼•æ“ä¹‹é—´çš„å·®å¼‚ï¼Œæˆ‘ä»¬ç•™åˆ°<a href=\"https://time.geekbang.org/column/article/425322\">ä¸‹ä¸€è®²</a>å†å»å±•å¼€ã€‚</p><p>å¥½å•¦ï¼Œè¨€å½’æ­£ä¼ ã€‚ç®€å•äº†è§£äº†SparkSessionä¸DataFrameçš„æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹æ•°æ®æ¢ç´¢ã€‚</p><p>æŠŠä¸Šè¿°ä»£ç ä¸¢è¿›spark-shellä¹‹åï¼Œåˆ†åˆ«åœ¨applyNumbersDFå’ŒluckyDogsDFè¿™ä¸¤ä¸ªDataFrameä¹‹ä¸Šè°ƒç”¨showå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æ ·æœ¬æ•°æ®ã€‚å¯ä»¥çœ‹åˆ°ï¼Œâ€œè¿™ä¸¤å¼ è¡¨â€çš„Schemaæ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬éƒ½åŒ…å«ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯Stringç±»å‹çš„carNumï¼Œå¦ä¸€ä¸ªæ˜¯ç±»å‹ä¸ºIntçš„batchNumã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b4/c5/b490801c4fd89yy7d3bab83539bb36c5.jpg?wh=1467x998\" alt=\"å›¾ç‰‡\" title=\"æºæ•°æ®çš„æ ·æœ¬æ•°æ®\"></p><p>å…¶ä¸­ï¼ŒcarNumçš„å«ä¹‰æ˜¯ç”³è¯·å·ç ã€æˆ–æ˜¯ä¸­ç­¾å·ç ï¼Œè€ŒbatchNumåˆ™ä»£è¡¨æ‘‡å·æ‰¹æ¬¡ï¼Œæ¯”å¦‚201906è¡¨ç¤º2019å¹´çš„æœ€åä¸€æ‰¹æ‘‡å·ï¼Œ201401è¡¨ç¤º2014å¹´çš„ç¬¬ä¸€æ¬¡æ‘‡å·ã€‚</p><p>å¥½å•¦ï¼Œè¿›è¡Œåˆ°è¿™é‡Œï¼Œåˆæ­¥çš„æ•°æ®æ¢ç´¢å·¥ä½œå°±å‘Šä¸€æ®µè½äº†ã€‚</p><h2>ä¸šåŠ¡éœ€æ±‚å®ç°</h2><p>å®Œæˆåˆæ­¥çš„æ•°æ®æ¢ç´¢ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»“åˆæ•°æ®ç‰¹ç‚¹ï¼ˆæ¯”å¦‚ä¸¤å¼ è¡¨çš„Schemaå®Œå…¨ä¸€è‡´ï¼Œä½†æ•°æ®å†…å®¹çš„èŒƒç•´ä¸åŒï¼‰ï¼Œæ¥å®ç°æœ€å¼€å§‹çš„ä¸šåŠ¡éœ€æ±‚ï¼šè®¡ç®—ä¸­ç­¾ç‡ä¸å€ç‡ä¹‹é—´çš„é‡åŒ–å…³ç³»ã€‚</p><p>é¦–å…ˆï¼Œæ—¢ç„¶æ˜¯è¦é‡åŒ–ä¸­ç­¾ç‡ä¸å€ç‡ä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨é‚£äº›ä¸­ç­¾è€…ï¼ˆluckyç›®å½•ä¸‹çš„æ•°æ®ï¼‰çš„å€ç‡å˜åŒ–å°±å¥½äº†ã€‚è€Œå€ç‡çš„è®¡ç®—ï¼Œè¦ä¾èµ–applyç›®å½•ä¸‹çš„æ‘‡å·æ•°æ®ã€‚å› æ­¤ï¼Œè¦åšåˆ°ä»…å…³æ³¨ä¸­ç­¾è€…çš„å€ç‡ï¼Œæˆ‘ä»¬å°±å¿…é¡»è¦ä½¿ç”¨æ•°æ®å…³è”è¿™ä¸ªåœ¨æ•°æ®åˆ†æé¢†åŸŸä¸­æœ€å¸¸è§çš„æ“ä½œã€‚æ­¤å¤–ï¼Œç”±äºå€ç‡åˆ¶åº¦è‡ª2016å¹´æ‰å¼€å§‹æ¨å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¿é—®2016å¹´ä»¥åçš„æ•°æ®å³å¯ã€‚</p><p>åŸºäºä»¥ä¸Šè¿™äº›åˆ†æï¼Œæˆ‘ä»¬å…ˆæŠŠæ•°æ®è¿‡æ»¤ä¸æ•°æ®å…³è”çš„ä»£ç å†™å‡ºæ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">// è¿‡æ»¤2016å¹´ä»¥åçš„ä¸­ç­¾æ•°æ®ï¼Œä¸”ä»…æŠ½å–ä¸­ç­¾å·ç carNumå­—æ®µ\nval filteredLuckyDogs: DataFrame = luckyDogsDF.filter(col(\"batchNum\") &gt;= \"201601\").select(\"carNum\")\n&nbsp;\n// æ‘‡å·æ•°æ®ä¸ä¸­ç­¾æ•°æ®åšå†…å…³è”ï¼ŒJoin Keyä¸ºä¸­ç­¾å·ç carNum\nval jointDF: DataFrame = applyNumbersDF.join(filteredLuckyDogs, Seq(\"carNum\"), \"inner\")\n</code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨filterç®—å­å¯¹luckyDogsDFåšè¿‡æ»¤ï¼Œç„¶åä½¿ç”¨selectç®—å­æå–carNumå­—æ®µã€‚</p><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬åœ¨applyNumbersDFä¹‹ä¸Šè°ƒç”¨joinç®—å­ï¼Œä»è€Œå®Œæˆä¸¤ä¸ªDataFrameçš„æ•°æ®å…³è”ã€‚joinç®—å­æœ‰3ä¸ªå‚æ•°ï¼Œä½ å¯ä»¥å¯¹ç…§å‰é¢ä»£ç çš„ç¬¬5è¡Œæ¥ç†è§£ï¼Œè¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šéœ€è¦å…³è”çš„DataFrameï¼Œç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨Join Keyï¼Œä¹Ÿå°±æ˜¯ä¾æ®å“ªäº›å­—æ®µåšå…³è”ï¼Œè€Œç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šçš„æ˜¯å…³è”å½¢å¼ï¼Œæ¯”å¦‚innerè¡¨ç¤ºå†…å…³è”ï¼Œleftè¡¨ç¤ºå·¦å…³è”ï¼Œç­‰ç­‰ã€‚</p><p>åšå®Œæ•°æ®å…³è”ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥è¯´ä¸€è¯´ï¼Œå€ç‡åº”è¯¥æ€ä¹ˆç»Ÿè®¡ã€‚å¯¹äºå€ç‡è¿™ä¸ªæ•°å€¼ï¼Œå®˜æ–¹çš„å®ç°ç•¥æ˜¾ç²—æš´ï¼Œå¦‚æœå»è§‚å¯Ÿ apply ç›®å½•ä¸‹ 2016 å¹´ä»¥åå„ä¸ªæ‰¹æ¬¡çš„æ–‡ä»¶ï¼Œä½ å°±ä¼šå‘ç°ï¼Œæ‰€è°“çš„å€ç‡ï¼Œå®é™…ä¸Šå°±æ˜¯ç”³è¯·å·ç çš„å‰¯æœ¬æ•°é‡ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œæˆ‘çš„å€ç‡æ˜¯8ï¼Œé‚£ä¹ˆåœ¨å„ä¸ªæ‰¹æ¬¡çš„æ‘‡å·æ–‡ä»¶ä¸­ï¼Œæˆ‘çš„ç”³è¯·å·ç å°±ä¼šå‡ºç°8æ¬¡ã€‚æ˜¯ä¸æ˜¯å¾ˆç²—æš´ï¼Ÿå› æ­¤ï¼Œè¦ç»Ÿè®¡æŸä¸ªç”³è¯·å·ç çš„å€ç‡ï¼Œæˆ‘ä»¬åªéœ€è¦ç»Ÿè®¡å®ƒåœ¨æ‰¹æ¬¡æ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°å°±å¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p><p>æŒ‰ç…§æ‰¹æ¬¡ã€ç”³è¯·å·ç åšç»Ÿè®¡è®¡æ•°ï¼Œæ˜¯ä¸æ˜¯æœ‰ç§ç†Ÿæ‚‰çš„æ„Ÿè§‰ï¼Ÿæ²¡é”™ï¼Œè¿™ä¸å°±æ˜¯æˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„Word Countå—ï¼Ÿå®ƒæœ¬è´¨ä¸Šå…¶å®å°±æ˜¯ä¸€ä¸ªåˆ†ç»„è®¡æ•°çš„è¿‡ç¨‹ã€‚ä¸è¿‡ï¼Œè¿™ä¸€æ¬¡ï¼Œå’±ä»¬ä¸å†ä½¿ç”¨reduceByKeyè¿™ä¸ªRDDç®—å­äº†ï¼Œè€Œæ˜¯ä½¿ç”¨DataFrameçš„é‚£å¥—ç®—å­æ¥å®ç°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä»£ç ã€‚</p><pre><code class=\"language-scala\">val multipliers: DataFrame = jointDF.groupBy(col(\"batchNum\"),col(\"carNum\"))\n.agg(count(lit(1)).alias(\"multiplier\"))\n</code></pre><p>åˆ†ç»„è®¡æ•°</p><p>å¯¹ç…§ä»£ç æˆ‘ç»™ä½ åˆ†æä¸‹æ€è·¯ï¼Œæˆ‘ä»¬å…ˆæ˜¯ç”¨groupByç®—å­æ¥æŒ‰ç…§æ‘‡å·æ‰¹æ¬¡å’Œç”³è¯·å·ç åšåˆ†ç»„ï¼Œç„¶åé€šè¿‡aggå’Œcountç®—å­æŠŠï¼ˆbatchNumï¼ŒcarNumï¼‰å‡ºç°çš„æ¬¡æ•°ï¼Œä½œä¸ºcarNumåœ¨æ‘‡å·æ‰¹æ¬¡batchNumä¸­çš„å€ç‡ï¼Œå¹¶ä½¿ç”¨aliasç®—å­æŠŠå€ç‡é‡å‘½åä¸ºâ€œmultiplierâ€ã€‚</p><p>è¿™ä¹ˆè¯´å¯èƒ½æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨multipliersä¹‹ä¸Šè°ƒç”¨showå‡½æ•°ï¼Œæ¥ç›´è§‚åœ°è§‚å¯Ÿè¿™ä¸€æ­¥çš„è®¡ç®—ç»“æœã€‚ä¸ºäº†æ–¹ä¾¿è¯´æ˜ï¼Œæˆ‘ç”¨è¡¨æ ¼çš„å½¢å¼æ¥è¿›è¡Œç¤ºæ„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/73/dd/73735ac4ec0bc22f4d79153ae38954dd.jpg?wh=1878x1007\" alt=\"å›¾ç‰‡\" title=\"multipliersè®¡ç®—ç»“æœç¤ºæ„å›¾\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŒä¸€ä¸ªç”³è¯·å·ç ï¼Œåœ¨ä¸åŒæ‰¹æ¬¡ä¸­çš„å€ç‡æ˜¯ä¸ä¸€æ ·çš„ã€‚å°±åƒæˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œéšç€æ‘‡å·çš„æ¬¡æ•°å¢åŠ ï¼Œå€ç‡ä¹Ÿä¼šè·Ÿç€æå‡ã€‚ä¸è¿‡ï¼Œè¿™é‡Œå’±ä»¬è¦ç ”ç©¶çš„æ˜¯å€ç‡ä¸ä¸­ç­¾ç‡çš„å…³ç³»ï¼Œæ‰€ä»¥åªéœ€è¦å…³å¿ƒä¸­ç­¾è€…æ˜¯åœ¨å¤šå¤§çš„å€ç‡ä¸‹ä¸­ç­¾çš„å°±è¡Œã€‚å› æ­¤ï¼Œå¯¹äºåŒä¸€ä¸ªç”³è¯·å·ç ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿ç•™å…¶ä¸­æœ€å¤§çš„å€ç‡å°±å¯ä»¥äº†ã€‚</p><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå–æœ€å¤§å€ç‡çš„åšæ³•ï¼Œä¼šæŠŠå€ç‡çš„ç»Ÿè®¡åŸºæ•°å˜å°ï¼Œä»è€Œå¼•å…¥å¹¸å­˜è€…åå·®ã€‚æ›´ä¸¥è°¨çš„åšæ³•ï¼Œåº”è¯¥æŠŠä¸­ç­¾è€…è¿‡å¾€çš„å€ç‡ä¹Ÿéƒ½ç»Ÿè®¡åœ¨å†…ï¼Œè¿™æ ·å€ç‡çš„åŸºæ•°æ‰æ˜¯å‡†ç¡®çš„ã€‚ä¸è¿‡å‘¢ï¼Œç»“åˆå®éªŒï¼Œå¹¸å­˜è€…åå·®å¹¶ä¸å½±å“â€œå€ç‡ä¸ä¸­ç­¾ç‡æ˜¯å¦æœ‰ç›´æ¥å…³ç³»â€è¿™ä¸€ç»“è®ºã€‚å› æ­¤ï¼Œå’±ä»¬ä¸å¦¨é‡‡ç”¨å–æœ€å¤§å€ç‡è¿™ç§æ›´åŠ ç®€ä¾¿çš„åšæ³•ã€‚æ¯•ç«Ÿï¼Œå­¦ä¹ Spark SQLï¼Œæ‰æ˜¯å’±ä»¬çš„é¦–è¦ç›®æ ‡ã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦â€œæŠ¹å»â€batchNumè¿™ä¸ªç»´åº¦ï¼ŒæŒ‰ç…§carNumå¯¹multipliersåšåˆ†ç»„ï¼Œå¹¶æå–å€ç‡çš„æœ€å¤§å€¼ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">val uniqueMultipliers: DataFrame = multipliers.groupBy(\"carNum\")\n.agg(max(\"multiplier\").alias(\"multiplier\"))\n</code></pre><p>åˆ†ç»„èšåˆçš„æ–¹æ³•è·Ÿå‰é¢å·®ä¸å¤šï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆç”¨groupByåšåˆ†ç»„ï¼Œä¸è¿‡è¿™æ¬¡ä»…ç”¨carNumä¸€ä¸ªå­—æ®µåšåˆ†ç»„ï¼Œç„¶åä½¿ç”¨aggå’Œmaxç®—å­æ¥ä¿ç•™å€ç‡æœ€å¤§å€¼ã€‚ç»è¿‡è¿™ä¸€æ­¥çš„è®¡ç®—ä¹‹åï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æ¯ä¸ªç”³è¯·å·ç åœ¨ä¸­ç­¾ä¹‹å‰çš„å€ç‡ç³»æ•°ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/63/d0/633fc65203b70b8528544a14a09633d0.jpg?wh=1920x506\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒuniqueMultipliersè¿™ä¸ªDataFrameä»…åŒ…å«ç”³è¯·å·ç carNumå’Œå€ç‡multiplierè¿™ä¸¤ä¸ªå­—æ®µï¼Œä¸”carNumå­—æ®µä¸å­˜åœ¨é‡å¤å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ä»½æ•°æ®é›†ä¸­ï¼Œä¸€ä¸ªç”³è¯·å·ç ï¼Œåªæœ‰ä¸€ä¸ªæœ€å¤§å€ç‡ä¸ä¹‹å¯¹åº”ã€‚</p><p>å¥½å•¦ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†æ¯ä¸€ä¸ªä¸­ç­¾è€…ï¼Œåœ¨ä¸­ç­¾ä¹‹å‰çš„å€ç‡ç³»æ•°ã€‚æ¥ä¸‹æ¥ï¼Œç»“åˆè¿™ä»½æ•°æ®ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»Ÿè®¡å€ç‡æœ¬èº«çš„åˆ†å¸ƒæƒ…å†µã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“çš„æ˜¯ï¼Œä¸åŒå€ç‡ä¹‹ä¸‹çš„äººæ•°åˆ†å¸ƒæ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬è¦<strong>æŒ‰ç…§å€ç‡æ¥å¯¹æ•°æ®åšåˆ†ç»„</strong>ï¼Œç„¶åè®¡ç®—ä¸åŒå€ç‡ä¸‹çš„ç»Ÿè®¡è®¡æ•°ã€‚ä¸ç”¨è¯´ï¼Œè¿™æ¬¡å’±ä»¬è¿˜æ˜¯å¾—ä»°ä»—groupByå’Œaggè¿™ä¸¤ä¸ªç®—å­ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">val result: DataFrame = uniqueMultipliers.groupBy(\"multiplier\")\n.agg(count(lit(1)).alias(\"cnt\"))\n.orderBy(\"multiplier\")\n&nbsp;\nresult.collect\n</code></pre><p>åœ¨æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬ä¾ç„¶ä½¿ç”¨groupByå’Œaggç®—å­å¦‚æ³•ç‚®åˆ¶ï¼Œå¾—åˆ°æŒ‰ç…§å€ç‡ç»Ÿè®¡çš„äººæ•°åˆ†å¸ƒä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡collectç®—å­æ¥æ”¶é›†è®¡ç®—ç»“æœï¼Œå¹¶åŒæ—¶è§¦å‘ä¸Šè¿°çš„æ‰€æœ‰ä»£ç ä»å¤´è‡³å°¾äº¤ä»˜æ‰§è¡Œã€‚</p><p>è®¡ç®—ç»“æœresultåŒ…å«ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯å€ç‡ï¼Œä¸€ä¸ªæ˜¯æŒæœ‰è¯¥å€ç‡çš„ç»Ÿè®¡äººæ•°ã€‚å¦‚æœæŠŠresultç»“æœæ•°æ®åšæˆæŸ±çŠ¶å›¾çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥æ›´åŠ ç›´è§‚åœ°è§‚å¯Ÿåˆ°ä¸­ç­¾ç‡ä¸å€ç‡ä¹‹é—´çš„å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/41/93/417b1430b64a7c305cb07fb49d3aa993.png?wh=1212x454\" alt=\"å›¾ç‰‡\" title=\"å€ç‡åˆ†å¸ƒ\"></p><p>ä¸éš¾å‘ç°ï¼Œä¸åŒå€ç‡ä¸‹çš„ä¸­ç­¾è€…äººæ•°ï¼Œå‘ˆç°å‡ºæ­£æ€åˆ†å¸ƒã€‚ä¹Ÿå³æ˜¯è¯´ï¼Œå¯¹äºä¸€ä¸ªç”³è¯·è€…æ¥è¯´ï¼Œä»–/å¥¹æœ‰å¹¸æ‘‡ä¸­çš„æ¦‚ç‡ï¼Œå¹¶ä¸ä¼šéšç€å€ç‡çš„å¢åŠ è€Œçº¿æ€§å¢é•¿ã€‚ç”¨èº«è¾¹é‚£äº›â€œè€å¸æœºâ€çš„è¯è¯´ï¼Œä¸­ç­¾è¿™ä»¶äº‹ï¼Œç¡®å®è·Ÿå€ç‡çš„å…³ç³»ä¸å¤§ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¸€èµ·åŠ¨æ‰‹ï¼Œå¼€å‘äº†â€œå€ç‡çš„ç»Ÿè®¡åˆ†å¸ƒâ€è¿™ä¸ªæ•°æ®åˆ†æåº”ç”¨ï¼Œå¹¶è§£ç­”äº†ä¸­ç­¾ç‡ä¸å€ç‡ä¹‹é—´æ˜¯å¦å­˜åœ¨å…³è”å…³ç³»è¿™ä¸€éš¾é¢˜ã€‚</p><p>å°½ç®¡åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€äº›æ–°æ¦‚å¿µå’Œæ–°çš„ç®—å­ï¼Œä½†ä½ ä¸å¿…æ‹…å¿ƒï¼Œæ›´ä¸å¿…ç€æ€¥ã€‚ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œä½ åªéœ€è¦å¯¹Spark SQLæ¡†æ¶ä¸‹çš„åº”ç”¨å¼€å‘æœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†å°±å¯ä»¥äº†ã€‚</p><p>åœ¨Spark SQLçš„å¼€å‘æ¡†æ¶ä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯é€šè¿‡SparkSessionçš„read APIä»æºæ•°æ®åˆ›å»ºDataFrameã€‚ç„¶åï¼Œä»¥DataFrameä¸ºå…¥å£ï¼Œåœ¨DataFrameä¹‹ä¸Šè°ƒç”¨å„å¼å„æ ·çš„è½¬æ¢ç®—å­ï¼Œå¦‚aggã€groupByã€selectã€filterç­‰ç­‰ï¼Œå¯¹DataFrameè¿›è¡Œè½¬æ¢ï¼Œè¿›è€Œå®Œæˆç›¸åº”çš„æ•°æ®åˆ†æã€‚</p><p>ä¸ºäº†åç»­è¯•éªŒæ–¹ä¾¿ï¼Œæˆ‘æŠŠä»Šå¤©æ¶‰åŠçš„ä»£ç ç‰‡æ®µæ•´ç†åˆ°äº†ä¸€èµ·ï¼Œä½ å¯ä»¥æŠŠå®ƒä»¬ä¸¢è¿›spark-shellå»è¿è¡Œï¼Œè§‚å¯Ÿæ¯ä¸ªç¯èŠ‚çš„è®¡ç®—ç»“æœï¼Œä½“ä¼šä¸åŒç®—å­çš„è®¡ç®—é€»è¾‘ä¸æ‰§è¡Œç»“æœä¹‹é—´çš„å…³ç³»ã€‚åŠ æ²¹ï¼Œç¥ä½ å¥½è¿ï¼</p><pre><code class=\"language-scala\">import org.apache.spark.sql.DataFrame\n&nbsp;\nval rootPath: String = _\n// ç”³è¯·è€…æ•°æ®\nval hdfs_path_apply: String = s\"${rootPath}/apply\"\n// sparkæ˜¯spark-shellä¸­é»˜è®¤çš„SparkSessionå®ä¾‹\n// é€šè¿‡read APIè¯»å–æºæ–‡ä»¶\nval applyNumbersDF: DataFrame = spark.read.parquet(hdfs_path_apply)\n&nbsp;\n// ä¸­ç­¾è€…æ•°æ®\nval hdfs_path_lucky: String = s\"${rootPath}/lucky\"\n// é€šè¿‡read APIè¯»å–æºæ–‡ä»¶\nval luckyDogsDF: DataFrame = spark.read.parquet(hdfs_path_lucky)\n&nbsp;\n// è¿‡æ»¤2016å¹´ä»¥åçš„ä¸­ç­¾æ•°æ®ï¼Œä¸”ä»…æŠ½å–ä¸­ç­¾å·ç carNumå­—æ®µ\nval filteredLuckyDogs: DataFrame = luckyDogsDF.filter(col(\"batchNum\") &gt;= \"201601\").select(\"carNum\")\n&nbsp;\n// æ‘‡å·æ•°æ®ä¸ä¸­ç­¾æ•°æ®åšå†…å…³è”ï¼ŒJoin Keyä¸ºä¸­ç­¾å·ç carNum\nval jointDF: DataFrame = applyNumbersDF.join(filteredLuckyDogs, Seq(\"carNum\"), \"inner\")\n&nbsp;\n// ä»¥batchNumã€carNumåšåˆ†ç»„ï¼Œç»Ÿè®¡å€ç‡ç³»æ•°\nval multipliers: DataFrame = jointDF.groupBy(col(\"batchNum\"),col(\"carNum\"))\n.agg(count(lit(1)).alias(\"multiplier\"))\n&nbsp;\n// ä»¥carNumåšåˆ†ç»„ï¼Œä¿ç•™æœ€å¤§çš„å€ç‡ç³»æ•°\nval uniqueMultipliers: DataFrame = multipliers.groupBy(\"carNum\")\n.agg(max(\"multiplier\").alias(\"multiplier\"))\n&nbsp;\n// ä»¥multiplierå€ç‡åšåˆ†ç»„ï¼Œç»Ÿè®¡äººæ•°\nval result: DataFrame = uniqueMultipliers.groupBy(\"multiplier\")\n.agg(count(lit(1)).alias(\"cnt\"))\n.orderBy(\"multiplier\")\n&nbsp;\nresult.collect\n</code></pre><h2>æ¯è¯¾ä¸€ç»ƒ</h2><p>1.è„‘æ´æ—¶é—´ï¼šä½ è§‰å¾—æ±½è½¦æ‘‡å·çš„å€ç‡åˆ¶åº¦åº”è¯¥æ€æ ·è®¾è®¡ï¼Œæ‰æ˜¯æœ€åˆç†çš„ï¼Ÿ</p><p>2.è¯·åœ¨ä½ çš„Sparkç¯å¢ƒä¸­æŠŠä»£ç è¿è¡Œèµ·æ¥ï¼Œå¹¶ç¡®è®¤æ‰§è¡Œç»“æœæ˜¯å¦ä¸resultä¸€è‡´ã€‚</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµäº’åŠ¨ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™ä¸€è®²çš„å†…å®¹åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€åŒäº‹ã€‚æˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","comments":[{"had_liked":false,"id":315864,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1634025578,"is_pvip":true,"replies":[{"id":"114520","content":"è€å¼Ÿåˆ†æå¾—é­è¾Ÿå…¥é‡Œ~<br><br>å®˜æ–¹çš„å€ç‡è®¾è®¡ï¼Œç¡®å®æ¯”è¾ƒç²—ç³™ï¼Œç»Ÿè®¡ä¸‹æ¥ï¼Œç»“è®ºå®é™…ä¸Šä¹Ÿä¸æ˜¯ååˆ†ç‰¢é ã€‚å’±ä»¬è¿™é‡Œç”¨å°æ±½è½¦æ‘‡å·çš„ä¾‹å­ï¼Œåˆè¡·è¿˜æ˜¯æ‰¾ä¸€ä¸ªå¤§å®¶éƒ½ç†Ÿæ‚‰çš„åœºæ™¯ï¼Œæ¥æ›´å¥½åœ°å­¦ä¹ Spark SQLçš„å¼€å‘æµç¨‹~ ","user_name":"ä½œè€…å›å¤","comment_id":315864,"uid":"1043100","ip_address":"","utype":1,"ctime":1634137095,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"40288731242","product_id":100090001,"comment_content":"sparkæ— å…³ã€‚è®¨è®ºä¸‹æ‘‡å·ã€‚<br><br>è¯„è®ºåŒºæœ‰åŒ¿åè¯»è€…è´¨ç–‘æ–‡ä¸­çš„ç»“è®ºã€‚è¿™é‡Œå°è¯•æ¢ä¸ªè§’åº¦ä»£å…¥å…·ä½“çš„æ•°å­—åˆ†æä¸‹ã€‚<br><br>ç®€å•èµ·è§ï¼Œå‡è®¾æ¯è½®æ‘‡å·æœ‰1000äººä¸­ç­¾ï¼Œå¹¶ä¸”å€ç‡å’Œè½®æ¬¡ä¸€è‡´ï¼Œå³ç¬¬ä¸€è½®å¤§å®¶éƒ½æ˜¯1å€ï¼Œç¬¬ä¸€è½®æ²¡ä¸­çš„äººåœ¨ç¬¬äºŒè½®å˜ä¸º2å€ï¼Œç¬¬äºŒè½®åˆæ²¡ä¸­çš„äººåˆ°äº†ç¬¬ä¸‰è½®å°±å˜æˆ3å€ï¼Œä¾æ¬¡ç±»æ¨ã€‚<br><br>å…ˆçœ‹ç¬¬ä¸€è½®çš„1000ä¸ªä¸­ç­¾è€…ï¼Œæ˜¾ç„¶ä»–ä»¬çš„å€ç‡éƒ½æ˜¯1ï¼Œæ²¡æœ‰å…¶ä»–å€ç‡çš„ä¸­ç­¾è€…ï¼Œè®°ä¸º:<br><br>[1000, 0, 0, ...]<br><br>å†çœ‹ç¬¬äºŒè½®çš„1000ä¸ªä¸­ç­¾è€…ã€‚ç”±äºæ–°åŠ å…¥çš„ç”³è¯·è€…å€ç‡ä¸º1ï¼Œç¬¬ä¸€è½®æœªä¸­çš„äººå€ç‡ä¸º2ã€‚æŒ‰ç…§å€ç‡æ‘‡å·çš„è¯ï¼ŒæœŸæœ›çš„ç»“æœå°±æ˜¯ï¼Œå€ç‡ä¸º2çš„ä¸­ç­¾äººæ•°æ˜¯å€ç‡ä¸º1çš„ä¸­ç­¾äººæ•°çš„2å€ï¼Œè®°ä¸ºï¼š<br><br>[333, 667, 0, 0, ...]<br><br>ä»¥æ­¤ç±»æ¨ï¼Œç¬¬ä¸‰è½®å°±æ˜¯ï¼š<br><br>[167, 333, 500, 0, 0, ...]<br><br>å°è¯•æ‘‡ä¸ª10è½®ï¼Œå¯ä»¥å¾—åˆ°ä¸‹è¡¨ï¼š<br><br>[1000, 0, 0, ...]<br>[333, 667, 0, 0, ...]<br>[167, 333, 500, 0, 0, ...]<br>[100, 200, 300, 400, 0, 0, ...]<br>[67, 133, 200, 267, 333, 0, 0, ...]<br>[48, 95, 143, 190, 238, 286, 0, 0, ...]<br>[36, 71, 107, 143, 179, 214, 250, 0, 0, ...]<br>[28, 56, 83, 111, 139, 167, 194, 222, 0, 0, ...]<br>[22, 44, 67, 89, 111, 133, 156, 178, 200, 0, 0, ...]<br>[18, 36, 55, 73, 91, 109, 127, 145, 164, 182, 0, 0, ...]<br><br>å¯ä»¥çœ‹åˆ°åœ¨æ¯ä¸€è½®çš„ä¸­ç­¾è€…ä¸­ï¼Œç¡®å®æ˜¯å€ç‡è¶Šé«˜ä¸­ç­¾çš„äººæ•°è¶Šå¤šã€‚<br><br>è€Œæ–‡ä¸­çš„ç»Ÿè®¡æ–¹æ³•ï¼Œç›¸å½“äºæŠŠè¿™å¼ è¡¨æŒ‰åˆ—æ±‚å’Œï¼š<br><br>[1819, 1635, 1455, 1273, 1091, 909, 727, 545, 364, 182, 0, 0, ...]<br><br>å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€æ¡å•è°ƒé€’å‡çš„æ›²çº¿ã€‚ç„¶è€Œå´ä¸èƒ½åƒæ–‡ä¸­ä¸€æ ·å¾—å‡ºâ€œä¸­ç­¾ç‡æ²¡æœ‰éšç€å€ç‡å¢åŠ â€çš„ç»“è®ºã€‚é«˜å€ç‡çš„ä¸­ç­¾äººæ•°æ¯”ä½å€ç‡çš„äººæ•°å°‘ï¼Œæ˜¯å› ä¸ºèƒ½è¾¾åˆ°é«˜å€ç‡çš„äººæœ¬èº«å°±å°‘ã€‚æ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ï¼Œ10è½®è¿‡å10å€ç‡çš„ä¸­ç­¾è€…åªæœ‰182äººï¼Œæ˜¯å› ä¸ºå‰9è½®æ²¡æœ‰äººèƒ½è¾¾åˆ°10å€ç‡ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ç¬¬ä¸€è½®å°±æœ‰1000ä¸ª1å€ç‡çš„äººä¸­ç­¾ã€‚<br><br>è‡³äºæ–‡ä¸­é…å›¾ä¸ºä»€ä¹ˆä¼šæ˜¯ä¸€æ¡ç±»ä¼¼é’Ÿå‹çš„æ›²çº¿ï¼ŒçŒœæµ‹å¯èƒ½ç¬¬ä¸€æ¬¡å¼•å…¥å€ç‡æ‘‡å·çš„æ—¶å€™ï¼Œå°±å·²ç»ç»™ä¸åŒçš„äººåˆ†é…ä¸åŒçš„å€ç‡äº†ï¼Œè€Œä¸æ˜¯å¤§å®¶ä¸€å¼€å§‹éƒ½æ˜¯1å€ç‡ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœåªå¯¹å5è½®æ±‚å’Œï¼Œå¯ä»¥å¾—åˆ°ï¼š<br><br>[152, 302, 455, 606, 758, 909, 727, 545, 364, 182]<br><br>è¿™æ ·å°±å’Œæ–‡ä¸­çš„é…å›¾æ¯”è¾ƒæ¥è¿‘äº†ã€‚<br><br>æ‰€ä»¥ç»“è®ºå°±æ˜¯è¦éªŒè¯ä¸­ç­¾ç‡å’Œå€ç‡çš„å…³ç³»ï¼Œä¸èƒ½æŒ‰ç…§å€ç‡å»ç´¯åŠ ä¸­ç­¾äººæ•°ï¼Œè€Œæ˜¯è¦çœ‹å•æ¬¡æ‘‡å·ä¸­ä¸åŒå€ç‡çš„ä¸­ç­¾è€…çš„åˆ†å¸ƒã€‚","like_count":10,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528186,"discussion_content":"è€å¼Ÿåˆ†æå¾—é­è¾Ÿå…¥é‡Œ~\n\nå®˜æ–¹çš„å€ç‡è®¾è®¡ï¼Œç¡®å®æ¯”è¾ƒç²—ç³™ï¼Œç»Ÿè®¡ä¸‹æ¥ï¼Œç»“è®ºå®é™…ä¸Šä¹Ÿä¸æ˜¯ååˆ†ç‰¢é ã€‚å’±ä»¬è¿™é‡Œç”¨å°æ±½è½¦æ‘‡å·çš„ä¾‹å­ï¼Œåˆè¡·è¿˜æ˜¯æ‰¾ä¸€ä¸ªå¤§å®¶éƒ½ç†Ÿæ‚‰çš„åœºæ™¯ï¼Œæ¥æ›´å¥½åœ°å­¦ä¹ Spark SQLçš„å¼€å‘æµç¨‹~ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634137095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1667175,"avatar":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","nickname":"qinsi","note":"","ucode":"090D9C4068FF12","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405051,"discussion_content":"å°è¯•çœ‹äº†ä¸‹å•è½®æ‘‡å·ä¸­ç­¾è€…çš„å€ç‡åˆ†å¸ƒï¼š\n\nmultipliers.filter(col(&#34;batchNum&#34;) === &#34;201906&#34;).groupBy(&#34;multiplier&#34;).agg(count(lit(1)).alias(&#34;count&#34;)).orderBy(&#34;multiplier&#34;).show\n+----------+-----+                                                              \n|multiplier|count|\n+----------+-----+\n|         1|  107|\n|         2|  244|\n|         3|  391|\n|         4|  585|\n|         5|  746|\n|         6|  829|\n|         7|  677|\n|         8|  712|\n|         9|  789|\n|        10|  530|\n|        11|  436|\n|        12|  338|\n+----------+-----+\n\nè¿™å°±åªèƒ½å‘µå‘µäº†...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634484580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318343,"user_name":"Alvin-L","can_delete":false,"product_type":"c1","uid":1603052,"ip_address":"","ucode":"5AC96AAB75B720","user_header":"https://static001.geekbang.org/account/avatar/00/18/75/ec/c60b29f5.jpg","comment_is_top":false,"comment_ctime":1635250472,"is_pvip":false,"replies":[{"id":"115463","content":"èµğŸ‘ï¼Œæ„Ÿè°¢è€å¼Ÿæ•´ç†Pythonä»£ç ~","user_name":"ä½œè€…å›å¤","comment_id":318343,"uid":"1043100","ip_address":"","utype":1,"ctime":1635260418,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"14520152360","product_id":100090001,"comment_content":"```<br>import os<br>from pyspark import SparkContext, SparkConf<br>from pyspark.sql.session import SparkSession<br>from pyspark.sql.functions import first, collect_list, mean, count, max<br>import matplotlib.pyplot as plt<br><br>def plot(res):<br>    x = [x[&quot;multiplier&quot;] for x in res]<br>    y = [y[&quot;cnt&quot;] for y in res]<br>    plt.figure(figsize=(8, 5), dpi=100)<br>    plt.xlabel(&#39;å€ç‡&#39;)<br>    plt.ylabel(&#39;äººæ•°&#39;)<br>    plt.rcParams[&#39;font.sans-serif&#39;]=[&#39;SimHei&#39;] <br>    plt.rcParams[&#39;axes.unicode_minus&#39;]=False<br>    plt.bar(x, y, width=0.5)<br>    plt.xticks(x)<br>    plt.show()<br><br># pyæ–‡ä»¶å°±åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹<br>rootPath = os.path.split(os.path.realpath(__file__))[0]<br><br>conf = SparkConf()<br>conf.set(&#39;spark.executor.memory&#39;, &#39;4g&#39;)<br>conf.set(&#39;spark.driver.memory&#39;, &#39;8g&#39;)<br>conf.set(&quot;spark.executor.cores&quot;, &#39;4&#39;)<br>conf.set(&#39;spark.cores.max&#39;, 16)<br>conf.set(&#39;spark.local.dir&#39;, rootPath)<br>spark = SparkSession(SparkContext(conf=conf))<br># ç”³è¯·è€…æ•°æ®<br># Windowsç¯å¢ƒ<br># æ³¨æ„ç‚¹1ï¼šå¢åŠ  option(&quot;basePath&quot;, rootPath) é€‰é¡¹<br># æ³¨æ„ç‚¹2ï¼šè·¯å¾„ hdfs_path_apply éœ€è¦è¿½åŠ  &#47;*&#47;*.parquet<br>hdfs_path_apply = rootPath + &quot;&#47;apply&quot;<br>applyNumbersDF = spark.read.option(&quot;basePath&quot;, rootPath).parquet(<br>    hdfs_path_apply + &quot;&#47;*&#47;*.parquet&quot;<br>)<br># ä¸­ç­¾è€…æ•°æ®<br>hdfs_path_lucky = rootPath + &quot;&#47;lucky&quot;<br>luckyDogsDF = spark.read.option(&quot;basePath&quot;, rootPath).parquet(<br>    hdfs_path_lucky + &quot;&#47;*&#47;*.parquet&quot;<br>)<br># è¿‡æ»¤2016å¹´ä»¥åçš„ä¸­ç­¾æ•°æ®ï¼Œä¸”ä»…æŠ½å–ä¸­ç­¾å·ç carNumå­—æ®µ<br>filteredLuckyDogs = (<br>    luckyDogsDF<br>    .filter(luckyDogsDF[&quot;batchNum&quot;] &gt;= &quot;201601&quot;)<br>    .select(&quot;carNum&quot;)<br>)<br># æ‘‡å·æ•°æ®ä¸ä¸­ç­¾æ•°æ®åšå†…å…³è”ï¼ŒJoin Keyä¸ºä¸­ç­¾å·ç carNum<br>jointDF = applyNumbersDF.join(filteredLuckyDogs, &quot;carNum&quot;, &quot;inner&quot;)<br># ä»¥batchNumã€carNumåšåˆ†ç»„ï¼Œç»Ÿè®¡å€ç‡ç³»æ•°<br>multipliers = (<br>    jointDF<br>    .groupBy([&quot;batchNum&quot;, &quot;carNum&quot;])<br>    .agg(count(&quot;batchNum&quot;).alias(&quot;multiplier&quot;))<br>)<br># ä»¥carNumåšåˆ†ç»„ï¼Œä¿ç•™æœ€å¤§çš„å€ç‡ç³»æ•°<br>uniqueMultipliers = (<br>    multipliers<br>    .groupBy(&quot;carNum&quot;)<br>    .agg(max(&quot;multiplier&quot;).alias(&quot;multiplier&quot;))<br>)<br># ä»¥multiplierå€ç‡åšåˆ†ç»„ï¼Œç»Ÿè®¡äººæ•°<br>result = (<br>    uniqueMultipliers<br>    .groupBy(&quot;multiplier&quot;)<br>    .agg(count(&quot;carNum&quot;).alias(&quot;cnt&quot;))<br>    .orderBy(&quot;multiplier&quot;)<br>)<br>result.show(40)<br>res = result.collect()<br># ç”»å›¾<br>plot(res)<br>```","like_count":4,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529199,"discussion_content":"èµğŸ‘ï¼Œæ„Ÿè°¢è€å¼Ÿæ•´ç†Pythonä»£ç ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635260418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1603052,"avatar":"https://static001.geekbang.org/account/avatar/00/18/75/ec/c60b29f5.jpg","nickname":"Alvin-L","note":"","ucode":"5AC96AAB75B720","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":408641,"discussion_content":"è¯·é—®è€å¸ˆ2ä¸ªé—®é¢˜ï¼š\n1ï¼ˆæˆ‘åœ¨Windowsç¯å¢ƒä¸‹ï¼‰ä¸ºä»€ä¹ˆæˆ‘ç›´æ¥ä½¿ç”¨parquet(hdfs_path_apply)çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œæç¤ºâ€œå¦‚æœæä¾›çš„è·¯å¾„æ˜¯åˆ†åŒºè·¯å¾„ï¼Œé‚£ä¹ˆè¯·åœ¨æ•°æ®æºçš„optionä¸­è®¾ç½®â€œbasePathâ€æ¥å•ç‹¬æŒ‡å®šè¡¨çš„æ ¹è·¯å¾„ï¼›å¦‚æœæ ¹è·¯å¾„ä¸åŒï¼Œé‚£ä¹ˆå°±åˆ†åˆ«åŠ è½½æ•°æ®ï¼Œç„¶åé‡‡ç”¨unionçš„æ–¹å¼åŠ æ•°æ®åˆå¹¶ã€‚â€ï¼Œè€Œä¸”hdfs_path_applyè¦è¿½åŠ &#34;/*/*.parquet&#34;æ‰èƒ½æ­£å¸¸è¯»å–ï¼Œä¸åŠ çš„è¯ä¹Ÿä¼šæŠ¥é”™ã€‚\n2è¿è¡Œåç”Ÿæˆçš„blockmgr-xxxxxæ–‡ä»¶å¤¹æœ‰8Gå¤§ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰éšç¨‹åºå®Œç»“è€Œæ¸…é™¤æ‰ï¼Ÿæ˜¯ä¸æ˜¯æœ‰å“ªäº›è®¾ç½®æ²¡æœ‰è®¾å¯¹å¯¼è‡´ã€‚\nè°¢è°¢è€å¸ˆã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635297254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341611,"user_name":"ç¿¡ç¿ å°å—ç“œ","can_delete":false,"product_type":"c1","uid":1068242,"ip_address":"","ucode":"92503E54E106CD","user_header":"https://static001.geekbang.org/account/avatar/00/10/4c/d2/f12dd0ac.jpg","comment_is_top":false,"comment_ctime":1649734491,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5944701787","product_id":100090001,"comment_content":"ä¸æ‡‚åŒ—äº¬çš„æ‘‡å·è§„åˆ™ï¼Œä¹Ÿæ²¡å†™æ¸…æ¥šï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªæ‰¹æ¬¡å·é‡Œé¢ï¼Œä¸€ä¸ªç”³è¯·å·å¯ä»¥æœ‰å¤šæ¬¡ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1260911,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3d/6f/3a97712e.jpg","nickname":"æ—Curry","note":"","ucode":"55FA1EE95A484F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580191,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657968070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340797,"user_name":"Spoon","can_delete":false,"product_type":"c1","uid":1959822,"ip_address":"","ucode":"2FF9193AD482C2","user_header":"https://static001.geekbang.org/account/avatar/00/1d/e7/8e/318cfde0.jpg","comment_is_top":false,"comment_ctime":1649148070,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5944115366","product_id":100090001,"comment_content":"Javaå®ç°<br>https:&#47;&#47;github.com&#47;Spoon94&#47;spark-practice&#47;blob&#47;master&#47;src&#47;main&#47;java&#47;com&#47;spoon&#47;spark&#47;sql&#47;CarNumAnalyseJob.java","like_count":2},{"had_liked":false,"id":321114,"user_name":"ä¸œå›´å±…å£«","can_delete":false,"product_type":"c1","uid":2144966,"ip_address":"","ucode":"0FDAC3E3053837","user_header":"https://static001.geekbang.org/account/avatar/00/20/ba/c6/10448065.jpg","comment_is_top":false,"comment_ctime":1636683287,"is_pvip":false,"replies":[{"id":"116620","content":"æ£’ğŸ‘ï¼Œæ„Ÿè°¢ï¼~","user_name":"ä½œè€…å›å¤","comment_id":321114,"uid":"1043100","ip_address":"","utype":1,"ctime":1636701414,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"5931650583","product_id":100090001,"comment_content":"è¡¥ä¸€ä¸ªå®Œæ•´çš„ spark ä»£ç ï¼ˆwindowsç¯å¢ƒï¼‰ï¼š<br><br>package spark.basic<br><br>import org.apache.spark.sql.functions.{col,count, lit, max}<br>import org.apache.spark.sql.{DataFrame, SparkSession}<br><br>object Chapter13 {<br>    def main(args: Array[String]): Unit = {<br><br>        val spark: SparkSession = SparkSession.builder().master(&quot;local[*]&quot;).appName(&quot;Chapter13&quot;).getOrCreate()<br>        import spark.implicits._<br><br>        val rootPath: String = &quot;E:\\\\temp\\\\yaohao_home\\\\yaohao&quot;<br>        &#47;&#47; ç”³è¯·è€…æ•°æ®<br>        val hdfs_path_apply: String = s&quot;${rootPath}&#47;apply&quot;<br>        &#47;&#47; sparkæ˜¯spark-shellä¸­é»˜è®¤çš„SparkSessionå®ä¾‹<br>        &#47;&#47; é€šè¿‡read APIè¯»å–æºæ–‡ä»¶<br>        val applyNumbersDF: DataFrame = spark.read.option(&quot;basePath&quot;, rootPath).parquet(hdfs_path_apply + &quot;&#47;*&#47;*.parquet&quot;)<br><br>        &#47;&#47; ä¸­ç­¾è€…æ•°æ®<br>        val hdfs_path_lucky: String = s&quot;${rootPath}&#47;lucky&quot;<br>        &#47;&#47; é€šè¿‡read APIè¯»å–æºæ–‡ä»¶<br>        val luckyDogsDF: DataFrame = spark.read.option(&quot;basePath&quot;, rootPath).parquet(hdfs_path_lucky + &quot;&#47;*&#47;*.parquet&quot;)<br><br>        &#47;&#47; è¿‡æ»¤2016å¹´ä»¥åçš„ä¸­ç­¾æ•°æ®ï¼Œä¸”ä»…æŠ½å–ä¸­ç­¾å·ç carNumå­—æ®µ<br>        val filteredLuckyDogs: DataFrame = luckyDogsDF.filter(col(&quot;batchNum&quot;) &gt;= &quot;201601&quot;).select(&quot;carNum&quot;)<br><br>        &#47;&#47; æ‘‡å·æ•°æ®ä¸ä¸­ç­¾æ•°æ®åšå†…å…³è”ï¼ŒJoin Keyä¸ºä¸­ç­¾å·ç carNum<br>        val jointDF: DataFrame = applyNumbersDF.join(filteredLuckyDogs, Seq(&quot;carNum&quot;), &quot;inner&quot;)<br><br>        &#47;&#47; ä»¥batchNumã€carNumåšåˆ†ç»„ï¼Œç»Ÿè®¡å€ç‡ç³»æ•°<br>        val multipliers: DataFrame = jointDF.groupBy(col(&quot;batchNum&quot;),col(&quot;carNum&quot;))<br>            .agg(count(lit(1)).alias(&quot;multiplier&quot;))<br><br>        &#47;&#47; ä»¥carNumåšåˆ†ç»„ï¼Œä¿ç•™æœ€å¤§çš„å€ç‡ç³»æ•°<br>        val uniqueMultipliers: DataFrame = multipliers.groupBy(&quot;carNum&quot;)<br>            .agg(max(&quot;multiplier&quot;).alias(&quot;multiplier&quot;))<br><br>        &#47;&#47; ä»¥multiplierå€ç‡åšåˆ†ç»„ï¼Œç»Ÿè®¡äººæ•°<br>        val result: DataFrame = uniqueMultipliers.groupBy(&quot;multiplier&quot;)<br>            .agg(count(lit(1)).alias(&quot;cnt&quot;))<br>            .orderBy(&quot;multiplier&quot;)<br><br>        result.collect<br>        result.show()<br>    }<br>}<br>","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530220,"discussion_content":"æ£’ğŸ‘ï¼Œæ„Ÿè°¢ï¼~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636701414,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2845437,"avatar":"","nickname":"Geek5763","note":"","ucode":"D4C8CAEABAA925","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542758,"discussion_content":"æ„Ÿè°¢ï¼Œä¸€ç›´æ— æ³•è¯»å–æ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640835367,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317760,"user_name":"ç«ç‚ç„±ç‡š","can_delete":false,"product_type":"c1","uid":2767491,"ip_address":"","ucode":"DB11784DD94059","user_header":"https://static001.geekbang.org/account/avatar/00/2a/3a/83/74e3fabd.jpg","comment_is_top":false,"comment_ctime":1634951052,"is_pvip":false,"replies":[{"id":"115455","content":"èµğŸ‘ï¼ï¼ï¼æ„Ÿè°¢è€å¼Ÿ~ åç»­æ”¶å½•åˆ°GitHub~","user_name":"ä½œè€…å›å¤","comment_id":317760,"uid":"1043100","ip_address":"","utype":1,"ctime":1635258574,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"5929918348","product_id":100090001,"comment_content":"å¯¹åº”çš„pythonä»£ç ä¸ºï¼š<br><br># åœ¨notebookä¸Šè¿è¡Œæ—¶ï¼ŒåŠ ä¸Šä¸‹é¢çš„é…ç½®<br>from pyspark import SparkContext, SparkConf<br>from pyspark.sql.session import SparkSession<br><br>sc_conf = SparkConf() # sparkå‚æ•°é…ç½®<br># sc_conf.setMaster()<br># sc_conf.setAppName(&#39;my-app&#39;)<br>sc_conf.set(&#39;spark.executor.memory&#39;, &#39;2g&#39;) <br>sc_conf.set(&#39;spark.driver.memory&#39;, &#39;4g&#39;) <br>sc_conf.set(&quot;spark.executor.cores&quot;, &#39;2&#39;) <br>sc_conf.set(&#39;spark.cores.max&#39;, 20)    <br>sc = SparkContext(conf=sc_conf)<br><br># åŠ è½½æ•°æ®ï¼Œè½¬æ¢æˆdataframe<br>rootPath=&#39;~~&#47;RawData&#39;<br>hdfs_path_apply=rootPath+&#39;&#47;apply&#39;<br>spark = SparkSession(sc)<br>applyNumbersDF=spark.read.parquet(hdfs_path_apply)<br># applyNumbersDF.show() # æ‰“å°å‡ºå‰å‡ è¡Œæ•°æ®ï¼ŒæŸ¥çœ‹æ•°æ®ç»“æ„<br><br>hdfs_path_lucky=rootPath+&#39;&#47;lucky&#39;<br>luckyDogsDF=spark.read.parquet(hdfs_path_lucky)<br># luckyDogsDF.show()<br><br>filteredLuckyDogs=luckyDogsDF.filter(luckyDogsDF[&#39;batchNum&#39;]&gt;=&#39;201601&#39;).select(&#39;carNum&#39;)<br>jointDF=applyNumbersDF.join(filteredLuckyDogs,&#39;carNum&#39;,&#39;inner&#39;)<br># joinå‡½æ•°æ¶ˆè€—å†…å­˜è¾ƒå¤§ï¼Œå®¹æ˜“å‡ºç°OOMé”™è¯¯ï¼Œå¦‚æœå‡ºé”™ï¼Œè¦å°†spark.driver.memoryè°ƒå¤§<br># jointDF.show() # æ‰“å°å‡ºjoinä¹‹åçš„dféƒ¨åˆ†æ•°æ®<br><br># è¿›è¡Œå¤šç§groupByæ“ä½œ<br>from pyspark.sql import functions as f<br>multipliers=jointDF.groupBy([&#39;batchNum&#39;,&#39;carNum&#39;]).agg(f.count(&#39;batchNum&#39;).alias(&quot;multiplier&quot;))<br># multipliers.show()<br><br>uniqueMultipliers=multipliers.groupBy(&#39;carNum&#39;).agg(f.max(&#39;multiplier&#39;).alias(&#39;multiplier&#39;))<br># uniqueMultipliers.show()<br><br>result=uniqueMultipliers.groupBy(&#39;multiplier&#39;).agg(f.count(&#39;carNum&#39;).alias(&#39;cnt&#39;)).orderBy(&#39;multiplier&#39;)<br>result2=result.collect()<br><br># ç»˜å›¾<br>import matplotlib.pyplot as plt<br>x=[i[&#39;multiplier&#39;] for i in result2]<br>y=[i[&#39;cnt&#39;] for i in result2]<br>plt.bar(x,y)","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528958,"discussion_content":"èµğŸ‘ï¼ï¼ï¼æ„Ÿè°¢è€å¼Ÿ~ åç»­æ”¶å½•åˆ°GitHub~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635258574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1096652,"avatar":"https://static001.geekbang.org/account/avatar/00/10/bb/cc/fac12364.jpg","nickname":"xxx","note":"","ucode":"E79CEA70430449","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544989,"discussion_content":"å‰å®³å‰å®³ï¼Œæˆ‘ç”¨Scalaæ‰§è¡Œçš„æ—¶å€™è€æ˜¯OOMï¼Œå¢å¤§executor memoryä¹Ÿæ²¡ç”¨ï¼ŒåŸæ¥æ˜¯driver memoryä¸å¤Ÿâ€¦â€¦ ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641796773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315196,"user_name":"Geek_d447af","can_delete":false,"product_type":"c1","uid":2800059,"ip_address":"","ucode":"A86EC7A2B3CE0A","user_header":"","comment_is_top":false,"comment_ctime":1633747560,"is_pvip":false,"replies":[{"id":"114411","content":"æ”¯æŒçš„ï¼Œä¸éœ€è¦Hadoopï¼Œspark-shellæœ¬åœ°å°±èƒ½è·‘","user_name":"ä½œè€…å›å¤","comment_id":315196,"uid":"1043100","ip_address":"","utype":1,"ctime":1633962050,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"5928714856","product_id":100090001,"comment_content":"æ–‡ç« é‡Œçš„ä»£ç éœ€è¦åœ¨ Hadoop ç¯å¢ƒæ‰èƒ½è·‘èµ·æ¥ï¼Œspark æœ¬èº«ä¸æ”¯æŒè§£æ parquet æ–‡ä»¶","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527898,"discussion_content":"æ”¯æŒçš„ï¼Œä¸éœ€è¦Hadoopï¼Œspark-shellæœ¬åœ°å°±èƒ½è·‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633962050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2845437,"avatar":"","nickname":"Geek5763","note":"","ucode":"D4C8CAEABAA925","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":542786,"discussion_content":"è€å¸ˆåº”è¯¥è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨windows localè·‘çš„åŒå­¦ï¼Œç®€å•è¯´æ˜ä¸€ä¸‹ã€‚å¦‚æœæ²¡æœ‰è¯„è®ºåŒºåŒå­¦çš„ä»£ç ï¼Œå°±æ­£ç¡®è¯»å–æ–‡ä»¶æ•°æ®è¿™ä¸€æ­¥å°±å¾—æåŠå¤©å‘¢ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640845417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":527898,"ip_address":""},"score":542786,"extra":""}]}]},{"had_liked":false,"id":351591,"user_name":"æ—Curry","can_delete":false,"product_type":"c1","uid":1260911,"ip_address":"","ucode":"55FA1EE95A484F","user_header":"https://static001.geekbang.org/account/avatar/00/13/3d/6f/3a97712e.jpg","comment_is_top":false,"comment_ctime":1657968320,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657968320","product_id":100090001,"comment_content":"val multipliers: DataFrame = jointDF.groupBy(col(&quot;batchNum&quot;),col(&quot;carNum&quot;)).agg(count(lit(1)).alias(&quot;multiplier&quot;))<br><br>è€å¸ˆï¼Œæœ‰ç‚¹æ²¡æœ‰çœ‹æ‡‚å€ç‡çš„è®¡ç®—æ–¹å¼ï¼Œä»¥batchNumå’ŒcarNumä¸¤ä¸ªå­—æ®µgroupbyçš„è¯ï¼Œè®¡ç®—çš„ä¸å°±æ˜¯ç”³è¯·å·åœ¨å„ä¸ªæ‰¹æ¬¡ä¸­å‡ºç°çš„æ¬¡æ•°ä¹ˆï¼Ÿ éš¾é“ä¸€ä¸ªç”³è¯·å·è¿˜ä¼šåœ¨åŒä¸ªæ‰¹æ¬¡ä¸­å‡ºç°å¤šæ¬¡å—","like_count":0},{"had_liked":false,"id":349149,"user_name":"æ¨å¸…","can_delete":false,"product_type":"c1","uid":1684811,"ip_address":"","ucode":"0A558B1BA62E44","user_header":"","comment_is_top":false,"comment_ctime":1655775263,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1655775263","product_id":100090001,"comment_content":"è€å¸ˆï¼Œæœ¬åœ°æŠ¥é”™ ç±»ä¼¼Caused by: java.io.IOException: Failed to connect to &#47;192.168.1.3:50561ï¼Œè¿™ä¸ªä¸€èˆ¬æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ","like_count":0},{"had_liked":false,"id":342341,"user_name":"çˆ±å­¦ä¹ çš„ç‹å‘±å‘±","can_delete":false,"product_type":"c1","uid":2962972,"ip_address":"","ucode":"F6703C9B1FE6DF","user_header":"https://static001.geekbang.org/account/avatar/00/2d/36/1c/adfeb6c4.jpg","comment_is_top":false,"comment_ctime":1650201781,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650201781","product_id":100090001,"comment_content":"joinçš„æ—¶å€™ä¸€ç›´æç¤ºï¼šã€No offset index for column carNum is available; Unable to do filteringã€‘ç½‘ä¸Šæ²¡æœåˆ°ï¼Œæ±‚å¤§ä½¬ä»¬å¸®å¿™çœ‹çœ‹åŸå› <br><br>sc = SparkContext()<br>spark = SparkSession(sc)<br>root_path = &quot;&#47;Users&#47;admin&#47;Documents&#47;2011-2019å°æ±½è½¦æ‘‡å·æ•°æ®&quot;<br><br>hdfs_path_apply = root_path + &quot;&#47;apply&quot;<br>applyDF = spark.read.parquet(hdfs_path_apply).select(&quot;carNum&quot;)<br># applyDF.show()<br><br>hdfs_path_lucky = root_path + &quot;&#47;lucky&quot;<br>lucyDF = spark.read.parquet(hdfs_path_lucky)<br># lucyDF.show()<br><br><br>lucy_car_num = lucyDF.filter(lucyDF[&#39;batchNum&#39;] &gt;= &#39;201601&#39;).select(&#39;carNum&#39;)<br>all_car_num = applyDF.join(lucy_car_num, &quot;carNum&quot;, &quot;inner&quot;)<br>all_car_num.show()","like_count":0},{"had_liked":false,"id":341070,"user_name":"Geek_9d1801","can_delete":false,"product_type":"c1","uid":2071326,"ip_address":"","ucode":"FCC96B3673A8BA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIfxu4yQEXdQ3icro8QEb0W3Rk014YXqibgw28kAcezVGy0DJzkERd1gXh5uEKL42VnnwomelvgPMDA/132","comment_is_top":false,"comment_ctime":1649327174,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649327174","product_id":100090001,"comment_content":"apply&#47;batchNum=201905&#47;part-00001-f8bb8e7b-904f-42a7-a616-a413406f06fb.c000.snappy.parquet is not a Parquet file. expected magic number at tail [80, 65, 82, 49] but found [14, 14, 14, 14]<br>æ²¡æœ‰äººæŠ¥è¿™ä¸ªé”™è¯¯å—ï¼Ÿæ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ","like_count":0},{"had_liked":false,"id":332581,"user_name":"lightning_å¥³å·«","can_delete":false,"product_type":"c1","uid":1935728,"ip_address":"","ucode":"A6C5B15933A62E","user_header":"","comment_is_top":false,"comment_ctime":1643354143,"is_pvip":true,"replies":[{"id":"121994","content":"ä»stacktraceæ¥çœ‹ï¼ŒæŠ¥é”™åŸå› æ˜¯shuffle writeè¿‡ç¨‹ä¸­ï¼Œå†™shuffleä¸­é—´æ–‡ä»¶çš„æ—¶å€™æŠ¥é”™ï¼Œè€å¼Ÿæ£€æŸ¥ä¸€ä¸‹spark.local.diré…ç½®çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¯¥é…ç½®é¡¹æ²¡æœ‰é…ç½®çš„è¯ï¼ŒSparké»˜è®¤æŠŠä¸­é—´æ–‡ä»¶å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„&#47;tmpç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸€èˆ¬æ¥è¯´ç©ºé—´éƒ½ä¸å¤§ï¼Œå¾ˆå®¹æ˜“å†™çˆ†çš„","user_name":"ä½œè€…å›å¤","comment_id":332581,"uid":"1043100","ip_address":"","utype":1,"ctime":1644671672,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1643354143","product_id":100090001,"comment_content":"æˆ‘åœ¨æœ¬åœ°è·‘è¿™ä¸ªä»£ç ç¢°åˆ°äº†å¦‚ä¸‹é”™è¯¯ï¼Œè¯·é—®å¦‚ä½•è§£å†³ï¼Ÿ<br>22&#47;01&#47;28 15:13:22 ERROR BypassMergeSortShuffleWriter: Error while deleting file &#47;private&#47;var&#47;folders&#47;hk&#47;7j9sqdtn55j3cq_gv5qvp5pm39d49n&#47;T&#47;blockmgr-88ef94e9-943a-4971-a3a8-33d25949886f&#47;1a&#47;temp_shuffle_e0e163fb-852c-4298-b08e-dc4989277ab3<br>22&#47;01&#47;28 15:13:22 ERROR DiskBlockObjectWriter: Uncaught exception while reverting partial writes to file &#47;private&#47;var&#47;folders&#47;hk&#47;7j9sqdtn55j3cq_gv5qvp5pm39d49n&#47;T&#47;blockmgr-88ef94e9-943a-4971-a3a8-33d25949886f&#47;08&#47;temp_shuffle_6c160c23-3395-445f-be03-b29a375e1139<br>java.io.FileNotFoundException: &#47;private&#47;var&#47;folders&#47;hk&#47;7j9sqdtn55j3cq_gv5qvp5pm39d49n&#47;T&#47;blockmgr-88ef94e9-943a-4971-a3a8-33d25949886f&#47;08&#47;temp_shuffle_6c160c23-3395-445f-be03-b29a375e1139 (No such file or directory)<br>\tat java.io.FileOutputStream.open0(Native Method)<br>\tat java.io.FileOutputStream.open(FileOutputStream.java:270)<br>\tat java.io.FileOutputStream.&lt;init&gt;(FileOutputStream.java:213)<br>\tat org.apache.spark.storage.DiskBlockObjectWriter$$anonfun$revertPartialWritesAndClose$2.apply$mcV$sp(DiskBlockObjectWriter.scala:217)<br>\tat org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1369)<br>\tat org.apache.spark.storage.DiskBlockObjectWriter.revertPartialWritesAndClose(DiskBlockObjectWriter.scala:214)<br>\tat org.apache.spark.shuffle.sort.BypassMergeSortShuffleWriter.stop(BypassMergeSortShuffleWriter.java:237)<br>\tat org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:105)<br>\tat org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:55)<br>\tat org.apache.spark.scheduler.Task.run(Task.scala:123)<br>\tat org.apache.spark.executor.Executor$TaskRunner$$anonfun$10.apply(Executor.scala:408)<br>\tat org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1360)<br>\tat org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:414)<br>\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)<br>\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)<br>\tat java.lang.Thread.run(Thread.java:748)","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550689,"discussion_content":"ä»stacktraceæ¥çœ‹ï¼ŒæŠ¥é”™åŸå› æ˜¯shuffle writeè¿‡ç¨‹ä¸­ï¼Œå†™shuffleä¸­é—´æ–‡ä»¶çš„æ—¶å€™æŠ¥é”™ï¼Œè€å¼Ÿæ£€æŸ¥ä¸€ä¸‹spark.local.diré…ç½®çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¯¥é…ç½®é¡¹æ²¡æœ‰é…ç½®çš„è¯ï¼ŒSparké»˜è®¤æŠŠä¸­é—´æ–‡ä»¶å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„/tmpç›®å½•ï¼Œè¿™ä¸ªç›®å½•ä¸€èˆ¬æ¥è¯´ç©ºé—´éƒ½ä¸å¤§ï¼Œå¾ˆå®¹æ˜“å†™çˆ†çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644671672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317598,"user_name":"ä¸œå›´å±…å£«","can_delete":false,"product_type":"c1","uid":2144966,"ip_address":"","ucode":"0FDAC3E3053837","user_header":"https://static001.geekbang.org/account/avatar/00/20/ba/c6/10448065.jpg","comment_is_top":false,"comment_ctime":1634867704,"is_pvip":false,"replies":[{"id":"115135","content":"è€å¼ŸåŠ æˆ‘å¾®ä¿¡å§ï¼Œæœç´¢â€œæ–¹å—Kâ€æˆ–æ˜¯â€œrJuniorâ€ï¼Œæˆ‘QQé‚®ç®±å¤§é‚®ä»¶å‘ä½ ~ åŠ å¾®ä¿¡æ˜¯ç¡®ä¿ä½ æ”¶åˆ°äº†~","user_name":"ä½œè€…å›å¤","comment_id":317598,"uid":"1043100","ip_address":"","utype":1,"ctime":1634889825,"user_name_real":"å´ç£Š"}],"discussion_count":3,"race_medal":0,"score":"1634867704","product_id":100090001,"comment_content":"è€å¸ˆï¼Œæ•°æ®æ–‡ä»¶æ–¹ä¾¿å­˜ä¸€ä»½åˆ°åˆ«çš„åœ°æ–¹å—ï¼Œæ¯”å¦‚é©¬äº‘å®¶çš„ç½‘ç›˜ï¼Œæˆ–è€…åšä¸ªç§å­ä¸‹è½½ä»€ä¹ˆçš„ï¼Œç™¾åº¦ç½‘ç›˜é‚£é€Ÿåº¦çœŸçš„æ˜¯ï¼Œæˆ‘ä¸‹åˆ°ä¸‹åˆä¸‹ç­è¿‡å‘¨æœ«éƒ½ä¸‹ä¸å®Œ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528890,"discussion_content":"è€å¼ŸåŠ æˆ‘å¾®ä¿¡å§ï¼Œæœç´¢â€œæ–¹å—Kâ€æˆ–æ˜¯â€œrJuniorâ€ï¼Œæˆ‘QQé‚®ç®±å¤§é‚®ä»¶å‘ä½ ~ åŠ å¾®ä¿¡æ˜¯ç¡®ä¿ä½ æ”¶åˆ°äº†~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634889825,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1690884,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cd/04/e27b7803.jpg","nickname":"å°æ–°","note":"","ucode":"DCAD04665E2CF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535068,"discussion_content":"å¼ºçƒˆå»ºè®®ä½¿ç”¨é˜¿é‡Œäº‘ç›˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638345061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2144966,"avatar":"https://static001.geekbang.org/account/avatar/00/20/ba/c6/10448065.jpg","nickname":"ä¸œå›´å±…å£«","note":"","ucode":"0FDAC3E3053837","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":407016,"discussion_content":"ä¸‹è½½å®Œå•¦ã€‚ä¸è¿‡é‡åˆ°å¦å¤–çš„é—®é¢˜äº†ï¼Œå°±æ˜¯å¦‚æœç”¨ spark.read.parquet() ç›´æ¥è¯»è§£å‹åˆ°æœ¬åœ°çš„ apply æ–‡ä»¶å¤¹ä¼šæŠ¥é”™ \nscala> spark.read.parquet(&#34;file:///mnt/e/temp/yaohao/apply&#34;)\njava.lang.AssertionError: assertion failed: Conflicting directory structures detected. Suspicious paths:?\n        file:/mnt/e/temp/yaohao/apply\n        file:/mnt/e/temp/yaohao/apply/paxheader\n\nIf provided paths are partition directories, please set &#34;basePath&#34; in the options of the data source to specify the root directory of the table. If there are multiple root directories, please load them separately and then union them.\n  at scala.Predef$.assert(Predef.scala:223)\n  at org.apache.spark.sql.execution.datasources.PartitioningUtils$.parsePartitions(PartitioningUtils.scala:172)\n  at org.apache.spark.sql.execution.datasources.PartitioningUtils$.parsePartitions(PartitioningUtils.scala:104)\n  at org.apache.spark.sql.execution.datasources.PartitioningAwareFileIndex.inferPartitioning(PartitioningAwareFileIndex.scala:161)\n  at org.apache.spark.sql.execution.datasources.InMemoryFileIndex.partitionSpec(InMemoryFileIndex.scala:77)\n  at org.apache.spark.sql.execution.datasources.PartitioningAwareFileIndex.partitionSchema(PartitioningAwareFileIndex.scala:50)\n  at org.apache.spark.sql.execution.datasources.DataSource.getOrInferFileFormatSchema(DataSource.scala:157)\n  at org.apache.spark.sql.execution.datasources.DataSource.resolveRelation(DataSource.scala:408)\n  at org.apache.spark.sql.DataFrameReader.loadV1Source(DataFrameReader.scala:297)\n  at org.apache.spark.sql.DataFrameReader.$anonfun$load$2(DataFrameReader.scala:286)\n  at scala.Option.getOrElse(Option.scala:189)\n  at org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:286)\n  at org.apache.spark.sql.DataFrameReader.parquet(DataFrameReader.scala:755)\n  at org.apache.spark.sql.DataFrameReader.parquet(DataFrameReader.scala:733)\n  ... 47 elided","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634892690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315682,"user_name":"Geek_995b78","can_delete":false,"product_type":"c1","uid":2758010,"ip_address":"","ucode":"F9BD1C78366081","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/w74m73icotZZEiasC6VzRUytfkFkgyYCGAcz16oBWuMXueWOxxVuAnH6IHaZFXkj5OqwlVO1fnocvn9gGYh8gGcw/132","comment_is_top":false,"comment_ctime":1633944480,"is_pvip":false,"replies":[{"id":"114407","content":"å®é™…ä¸Šå°±æ˜¯å¸¸æ•°1ï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯è¡¨ç¤ºä¸€ä¸ªå¸¸æ•°åˆ—ï¼Œè¿™åˆ—çš„æ•°å€¼éƒ½æ˜¯1ã€‚åªä¸è¿‡Spark SQLè¿™é‡Œçš„è¯­æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œå…¶å®å’ŒScalaæ²¡ä»€ä¹ˆå…³ç³»å“ˆ~","user_name":"ä½œè€…å›å¤","comment_id":315682,"uid":"1043100","ip_address":"","utype":1,"ctime":1633961894,"user_name_real":"å´ç£Š"}],"discussion_count":2,"race_medal":0,"score":"1633944480","product_id":100090001,"comment_content":"ç”¨scalaå®ç°ï¼Œlit(1)æ˜¯ä»€ä¹ˆæ„æ€å‘€","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528146,"discussion_content":"å®é™…ä¸Šå°±æ˜¯å¸¸æ•°1ï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯è¡¨ç¤ºä¸€ä¸ªå¸¸æ•°åˆ—ï¼Œè¿™åˆ—çš„æ•°å€¼éƒ½æ˜¯1ã€‚åªä¸è¿‡Spark SQLè¿™é‡Œçš„è¯­æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œå…¶å®å’ŒScalaæ²¡ä»€ä¹ˆå…³ç³»å“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633961894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2758010,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/w74m73icotZZEiasC6VzRUytfkFkgyYCGAcz16oBWuMXueWOxxVuAnH6IHaZFXkj5OqwlVO1fnocvn9gGYh8gGcw/132","nickname":"Geek_995b78","note":"","ucode":"F9BD1C78366081","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404312,"discussion_content":"å¥½çš„ï¼Œè°¢è°¢è€å¸ˆã€‚å…¶å®è¿™æ®µä»£ç æ˜¯åœ¨åšcount(1)ï¼Œåªä¸è¿‡Spark Sql çš„å†™æ³•æ˜¯ count(lit(1)) æ˜¯å§ï¼Ÿå¯ä»¥è¿™ä¹ˆç†è§£å— ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634284870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315150,"user_name":"GACÂ·DU","can_delete":false,"product_type":"c1","uid":1385403,"ip_address":"","ucode":"7847FBE1C13740","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg","comment_is_top":false,"comment_ctime":1633703655,"is_pvip":true,"replies":[{"id":"114412","content":"èµğŸ‘~","user_name":"ä½œè€…å›å¤","comment_id":315150,"uid":"1043100","ip_address":"","utype":1,"ctime":1633962076,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"1633703655","product_id":100090001,"comment_content":"resultå…·ä½“æ•°å€¼ï¼š<br>scala&gt; result.collect<br>res7: Array[org.apache.spark.sql.Row] = Array([1,8967], [2,19174], [3,26952], [4,29755], [5,32988], [6,34119], [7,29707], [8,26123], [9,19476], [10,9616], [11,3930], [12,1212])","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527881,"discussion_content":"èµğŸ‘~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633962076,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315063,"user_name":"Neo-dqy","can_delete":false,"product_type":"c1","uid":1924786,"ip_address":"","ucode":"9BF300EB1DDD00","user_header":"https://static001.geekbang.org/account/avatar/00/1d/5e/b2/aceb3e41.jpg","comment_is_top":false,"comment_ctime":1633677302,"is_pvip":false,"replies":[{"id":"114413","content":"lit(1)è¡¨ç¤ºå¸¸æ•°åˆ—ï¼Œè¿™åˆ—çš„æ•°å€¼éƒ½æ˜¯1ï¼Œæ˜¯Spark SQLçš„è¯­æ³•ï¼Œè·ŸScalaæ— å…³å“ˆ~<br><br>å€ç‡åˆ¶åº¦ç¡®å®éœ€è¦æ›´å¥½çš„è®¾è®¡~ ä¸è¿‡ä¹Ÿåˆ«æ”¾å¼ƒï¼Œå“ˆå“ˆï¼Œä¸‡ä¸€å“ªå¤©æ‘‡ä¸Šäº†å‘¢~","user_name":"ä½œè€…å›å¤","comment_id":315063,"uid":"1043100","ip_address":"","utype":1,"ctime":1633962214,"user_name_real":"å´ç£Š"}],"discussion_count":1,"race_medal":0,"score":"1633677302","product_id":100090001,"comment_content":"ã€.agg(count(lit(1)).alias(&quot;cnt&quot;))ã€‘é—®ä¸‹è€å¸ˆï¼Œè¿™é‡Œcountä¸­çš„lit(1)æ˜¯ä»€ä¹ˆæ„æ€å•Šï¼Ÿ<br>å¯¹äºæ±½è½¦æ‘‡å·çš„å€ç‡åˆ¶åº¦ï¼Œå¦‚æœä¸ºäº†ä¼˜å…ˆè®©å€ç‡é«˜çš„äººæ‘‡åˆ°å·ï¼Œå¯ä»¥æŠŠæ¯ä¸€æœŸçš„èµ„æ ¼åˆ†å¤šæ¬¡æŠ½å–ã€‚å°±æ˜¯è¯´ï¼Œå…ˆæ„å»ºä¸€ä¸ªæ‰€æœ‰äººéƒ½åœ¨é‡Œé¢çš„æ ·æœ¬ï¼ŒæŠ½éƒ¨åˆ†äººï¼›å†å°†å€ç‡é«˜äºæŸä¸ªé˜ˆå€¼çš„äººéƒ½å–å‡ºæ¥ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„æ ·æœ¬ï¼Œå†æŠ½å–éƒ¨åˆ†äººã€‚ï¼ˆå…·ä½“åˆ’åˆ†æˆå‡ ä¸ªæ ·æœ¬å¯ä»¥æŒ‰å€ç‡çš„äººæ•°åˆ†å¸ƒæ¥åˆ’åˆ†ï¼‰å½“ç„¶è¿™æ ·åˆä¼šå¯¹æ–°æ¥çš„äººä¸å…¬å¹³ï¼Œæ‰€ä»¥å¤§å®¶è¿˜æ˜¯æŒ¤åœ°é“å§~~","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527865,"discussion_content":"lit(1)è¡¨ç¤ºå¸¸æ•°åˆ—ï¼Œè¿™åˆ—çš„æ•°å€¼éƒ½æ˜¯1ï¼Œæ˜¯Spark SQLçš„è¯­æ³•ï¼Œè·ŸScalaæ— å…³å“ˆ~\n\nå€ç‡åˆ¶åº¦ç¡®å®éœ€è¦æ›´å¥½çš„è®¾è®¡~ ä¸è¿‡ä¹Ÿåˆ«æ”¾å¼ƒï¼Œå“ˆå“ˆï¼Œä¸‡ä¸€å“ªå¤©æ‘‡ä¸Šäº†å‘¢~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633962214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}