{"id":155138,"title":"加餐 | 数据的迁移应该如何做？","content":"<p>你好，我是唐扬。</p><p>在“<a href=\"https://time.geekbang.org/column/article/145480\">数据库优化方案（二）：写入数据量增加时，如何实现分库分表？</a>”中我曾经提到，由于MySQL不像MongoDB那样支持数据的Auto Sharding（自动分片），所以无论是将MySQL单库拆分成多个数据库，还是由于数据存储的瓶颈，不得不将多个数据库拆分成更多的数据库时你都要考虑如何做数据的迁移。</p><p>其实在实际工作中，不只是对数据库拆分时会做数据迁移，<strong>很多场景都需要你给出数据迁移的方案，</strong>比如说某一天，你的老板想要将应用从自建机房迁移到云上，那么你就要考虑将所有自建机房中的数据，包括MySQL、Redis、消息队列等组件中的数据全部迁移到云上，这无论对哪种规模的公司来说都是一项浩瀚的工程，所以你需要在迁移之前准备完善的迁移方案。</p><p>“数据的迁移”的问题比较重要和繁琐，也是开发和运维同学关注的重点。在课程更新的过程中，我看到有很多同学，比如@每天晒白牙，@枫叶11，@撒旦的堕落等等，在留言区询问如何做数据迁移，所以我策划了一期加餐，准备从数据库迁移和缓存迁移两个方面带你掌握数据迁移的方法，也带你了解数据迁移过程中需要注意的关键点，尽量让你避免踩坑。</p><h2>如何平滑地迁移数据库中的数据</h2><p>你可能会认为：数据迁移无非是将数据从一个数据库拷贝到另一个数据库，可以通过MySQL 主从同步的方式做到准实时的数据拷贝；也可以通过mysqldump工具将源库的数据导出再导入到新库，<strong>这有什么复杂的呢？</strong></p><!-- [[[read_end]]] --><p>其实这两种方式只能支持单库到单库的迁移，无法支持单库到多库多表的场景。而且即便是单库到单库的迁移，迁移过程也需要满足以下几个目标：</p><ul>\n<li>\n<p>迁移应该是在线的迁移，也就是在迁移的同时还会有数据的写入；</p>\n</li>\n<li>\n<p>数据应该保证完整性，也就是说在迁移之后需要保证新的库和旧的库的数据是一致的；</p>\n</li>\n<li>\n<p>迁移的过程需要做到可以回滚，这样一旦迁移的过程中出现问题，可以立刻回滚到源库不会对系统的可用性造成影响。</p>\n</li>\n</ul><p>如果你使用Binlog同步的方式，在同步完成后再修改代码，将主库修改为新的数据库，这样就不满足可回滚的要求，一旦迁移后发现问题，由于已经有增量的数据写入了新库而没有写入旧库，不可能再将数据库改成旧库。</p><p>一般来说，我们有两种方案可以做数据库的迁移。</p><h4>“双写”方案</h4><p>第一种方案我称之为双写，其实说起来也很简单，它可以分为以下几个步骤。</p><ol>\n<li>\n<p>将新的库配置为源库的从库用来同步数据；如果需要将数据同步到多库多表，那么可以使用一些第三方工具获取Binlog的增量日志（比如开源工具Canal），在获取增量日志之后就可以按照分库分表的逻辑写入到新的库表中了。</p>\n</li>\n<li>\n<p>同时我们需要改造业务代码，在数据写入的时候不仅要写入旧库也要写入新库。当然，基于性能的考虑，我们可以异步地写入新库，只要保证旧库写入成功即可。<strong>但是我们需要注意的是，</strong>需要将写入新库失败的数据记录在单独的日志中，这样方便后续对这些数据补写，保证新库和旧库的数据一致性。</p>\n</li>\n<li>\n<p>然后我们就可以开始校验数据了。由于数据库中数据量很大，做全量的数据校验不太现实。你可以抽取部分数据，具体数据量依据总体数据量而定，只要保证这些数据是一致的就可以。</p>\n</li>\n<li>\n<p>如果一切顺利，我们就可以将读流量切换到新库了。由于担心一次切换全量读流量可能会对系统产生未知的影响，所以这里<strong>最好采用灰度的方式来切换，</strong>比如开始切换10%的流量，如果没有问题再切换到50%的流量，最后再切换到100%。</p>\n</li>\n<li>\n<p>由于有双写的存在，所以在切换的过程中出现任何的问题都可以将读写流量随时切换到旧库去，保障系统的性能。</p>\n</li>\n<li>\n<p>在观察了几天发现数据的迁移没有问题之后，就可以将数据库的双写改造成只写新库，数据的迁移也就完成了。</p>\n</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/ad/30/ad9a4aa37afc39ebe0c91144d5ef7630.jpg?wh=1142*871\" alt=\"\"></p><p><strong>其中最容易出问题的步骤就是数据校验的工作，</strong>所以我建议你在未开始迁移数据之前先写好数据校验的工具或者脚本，在测试环境上测试充分之后，再开始正式的数据迁移。</p><p>如果是将数据从自建机房迁移到云上，你也可以使用这个方案，<strong>只是你需要考虑的一个重要的因素是：</strong>自建机房到云上的专线的带宽和延迟，你需要尽量减少跨专线的读操作，所以在切换读流量的时候你需要保证自建机房的应用服务器读取本机房的数据库，云上的应用服务器读取云上的数据库。这样在完成迁移之前，只要将自建机房的应用服务器停掉并且将写入流量都切到新库就可以了。</p><p><img src=\"https://static001.geekbang.org/resource/image/b8/54/b88aefdb07049f2019c922cdb9cb3154.jpg?wh=1142*749\" alt=\"\"></p><p>这种方案是一种比较通用的方案，无论是迁移MySQL中的数据还是迁移Redis中的数据，甚至迁移消息队列都可以使用这种方式，<strong>你在实际的工作中可以直接拿来使用。</strong></p><p>这种方式的好处是：迁移的过程可以随时回滚，将迁移的风险降到了最低。劣势是：时间周期比较长，应用有改造的成本。</p><h4>级联同步方案</h4><p>这种方案也比较简单，比较适合数据从自建机房向云上迁移的场景。因为迁移上云最担心云上的环境和自建机房的环境不一致，会导致数据库在云上运行时因为参数配置或者硬件环境不同出现问题。</p><p>所以我们会在自建机房准备一个备库，在云上环境上准备一个新库，通过级联同步的方式在自建机房留下一个可回滚的数据库，具体的步骤如下：</p><ol>\n<li>先将新库配置为旧库的从库，用作数据同步；</li>\n<li>再将一个备库配置为新库的从库，用作数据的备份；</li>\n<li>等到三个库的写入一致后，将数据库的读流量切换到新库；</li>\n<li>然后暂停应用的写入，将业务的写入流量切换到新库（由于这里需要暂停应用的写入，所以需要安排在业务的低峰期）。</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/3a/2b/3a2e08181177529c3229c789c2081b2b.jpg?wh=1142*663\" alt=\"\"></p><p><strong>这种方案的回滚方案也比较简单，</strong>可以先将读流量切换到备库再暂停应用的写入，将写流量切换到备库，这样所有的流量都切换到了备库，也就是又回到了自建机房的环境，就可以认为已经回滚了。</p><p><img src=\"https://static001.geekbang.org/resource/image/ad/b9/ada8866fda3c3264f495c97c6214ebb9.jpg?wh=1142*843\" alt=\"\"></p><p>上面的级联迁移方案可以应用在将MySQL从自建机房迁移到云上的场景，也可以应用在将Redis从自建机房迁移到云上的场景，<strong>如果你有类似的需求可以直接拿来应用。</strong></p><p>这种方案<strong>优势是</strong>简单易实施，在业务上基本没有改造的成本；<strong>缺点是</strong>在切写的时候需要短暂的停止写入，对于业务来说是有损的，不过如果在业务低峰期来执行切写，可以将对业务的影响降至最低。</p><h2>数据迁移时如何预热缓存</h2><p>另外，在从自建机房向云上迁移数据时，我们也需要考虑缓存的迁移方案是怎样的。那么你可能会说：缓存本来就是作为一个中间的存储而存在的，我只需要在云上部署一个空的缓存节点，云上的请求也会穿透到云上的数据库，然后回种缓存，对于业务是没有影响的。</p><p>你说得没错，但是你还需要考虑的是缓存的命中率。</p><p>如果你部署一个空的缓存，那么所有的请求就都穿透到数据库，数据库可能因为承受不了这么大的压力而宕机，这样你的服务就会不可用了。<strong>所以，缓存迁移的重点是保持缓存的热度。</strong></p><p>刚刚我提到，Redis的数据迁移可以使用双写的方案或者级联同步的方案，所以在这里我就不考虑Redis缓存的同步了，而是以Memcached为例来说明。</p><h4>使用副本组预热缓存</h4><p>在“<a href=\"https://time.geekbang.org/column/article/151949\">缓存的使用姿势（二）：缓存如何做到高可用？</a>”中，我曾经提到为了保证缓存的可用性，我们可以部署多个副本组来尽量将请求阻挡在数据库层之上。</p><p>数据的写入流程是写入Master、Slave和所有的副本组，而在读取数据的时候，会先读副本组的数据，如果读取不到再到Master和Slave里面加载数据，再写入到副本组中。<strong>那么，我们就可以在云上部署一个副本组，</strong>这样，云上的应用服务器读取云上的副本组，如果副本组没有查询到数据，就可以从自建机房部署的主从缓存上加载数据，回种到云上的副本组上。</p><p><img src=\"https://static001.geekbang.org/resource/image/ab/c6/abc0b5e4c80097d8e02000b30e7ea9c6.jpg?wh=1142*473\" alt=\"\"></p><p>当云上部署的副本组足够热之后，也就是缓存的命中率达到至少90%，就可以将云机房上的缓存服务器的主从都指向这个副本组，这时迁移也就完成了。</p><p><strong>这种方式足够简单，不过有一个致命的问题是：</strong>如果云上的请求穿透云上的副本组，到达自建机房的主从缓存时，这个过程是需要跨越专线的。</p><p>这不仅会占用较多专线的带宽，同时专线的延迟相比于缓存的读取时间是比较大的，即使是本地的不同机房之间的延迟也会达到2ms～3ms，那么一次前端请求可能会访问十几次甚至几十次的缓存，一次请求就会平白增加几十毫秒甚至过百毫秒的延迟，会极大地影响接口的响应时间，因此在实际项目中我们很少使用这种方案。</p><p><strong>但是这种方案给了我们思路，</strong>让我们可以通过方案的设计在系统运行中自动完成缓存的预热，所以我们对副本组的方案做了一些改造，以尽量减少对专线带宽的占用。</p><h4>改造副本组方案预热缓存</h4><p>改造后的方案对读写缓存的方式进行改造，步骤是这样的：</p><ol>\n<li>\n<p>在云上部署多组mc的副本组，自建机房在接收到写入请求时，会优先写入自建机房的缓存节点，异步写入云上部署的mc节点；</p>\n</li>\n<li>\n<p>在处理自建机房的读请求时，会指定一定的流量（比如10%）优先走云上的缓存节点，这样虽然也会走专线穿透回自建机房的缓存节点，但是流量是可控的；</p>\n</li>\n<li>\n<p>当云上缓存节点的命中率达到90%以上时，就可以在云上部署应用服务器，让云上的应用服务器完全走云上的缓存节点就可以了。</p>\n</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/7f/f4/7f41a529a322e396232ac7963ec082f4.jpg?wh=1142*435\" alt=\"\"></p><p>使用了这种方式，我们可以实现缓存数据的迁移，又可以尽量控制专线的带宽和请求的延迟情况，<strong>你也可以直接在项目中使用。</strong></p><h2>课程小结</h2><p>以上我提到的数据迁移的方案，都是我在实际项目中经常用到的、经受过实战考验的方案，希望你能通过这节课的学习，将这些方案运用到你的项目中解决实际的问题。与此同时，我想再次跟你强调一下本节课的重点内容：</p><ul>\n<li>\n<p>双写的方案是数据库、Redis迁移的通用方案，<strong>你可以在实际工作中直接加以使用。</strong>双写方案中最重要的，是通过数据校验来保证数据的一致性，这样就可以在迁移过程中随时回滚；</p>\n</li>\n<li>\n<p>如果你需要将自建机房的数据迁移到云上，那么也可以考虑<strong>使用级联复制的方案，</strong>这种方案会造成数据的短暂停写，需要在业务低峰期执行；</p>\n</li>\n<li>\n<p>缓存的迁移重点是保证云上缓存的命中率，你可以<strong>使用改进版的副本组方式来迁移，</strong>在缓存写入的时候异步写入云上的副本组，在读取时放少量流量到云上副本组，从而又可以迁移部分数据到云上副本组，又能尽量减少穿透给自建机房造成专线延迟的问题。</p>\n</li>\n</ul><p><strong>如果你作为项目的负责人，</strong>那么在迁移的过程中，你一定要制定周密的计划：如果是数据库的迁移，那么数据的校验应该是你最需要花费时间来解决的问题。</p><p>如果是自建机房迁移到云上，那么专线的带宽一定是你迁移过程中的一个瓶颈点，你需要在迁移之前梳理清楚有哪些调用需要经过专线，占用带宽的情况是怎样的，带宽的延时是否能够满足要求。你的方案中也需要尽量做到在迁移过程中同机房的服务调用同机房的缓存和数据库，尽量减少对于专线带宽资源的占用。</p><h2>一课一思</h2><p>结合实际工作的经验，你可以和我分享一下在做数据迁移的时候都采用了哪些方案吗？这些方案你觉得它的优势和劣势分别是什么呢？</p><p>最后，感谢你的阅读，如果这篇文章让你有所收获，也欢迎你将它分享给更多的朋友。</p>","neighbors":{"left":{"article_title":"16 | CDN：静态资源如何加速？","id":154490},"right":{"article_title":"17 | 消息队列：秒杀时如何处理每秒上万次的下单请求？","id":156904}},"comments":[{"had_liked":false,"id":144630,"user_name":"约书亚","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1571985536,"is_pvip":false,"replies":[{"id":"55941","content":"双写时加开关，默认关闭双写，上线完成后关闭同步，同时打开开关，在低峰期的话数据丢失的概率不高。再配合数据校验的工作，是可以保证一致性的","user_name":"作者回复","comment_id":144630,"uid":"1448977","ip_address":"","utype":1,"ctime":1572219976,"user_name_real":"唐扬"}],"discussion_count":4,"race_medal":0,"score":"121831069824","product_id":100035801,"comment_content":"a. @_CountingStars的问题提到“双写”方案中主从同步和双写冲突的问题，的回答是双写之前要将同步断掉。<br>假设我们在夜间进行操作，不考虑主从延迟过高的情况。<br>但是，”断掉同步“与”有双写代码的应用，被部署上线能正常执行双写“这两个操作之间，时机也不会配合特别完美吧？<br>如果先断掉同步，就意味着有可能从库丢掉部分数据。<br>如果先上线新代码，就意味着短时间内数据要么冲突，要么对于不幂等的操作，数据变成双份了？<br>b.双写方案的一种隐患是新旧二库在遇到同一资源的并发操作时，执行顺序有可能不一样，进而结果就不一样。这种情况在实践中还要考虑么？<br>c.另外我还疑问，现代的应用部署都是基于灰度的，在写操作的代码发生切换时（从双写到写新库，或者从写旧库到写新库），做灰度发布都会带来问题吧？","like_count":29,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472041,"discussion_content":"双写时加开关，默认关闭双写，上线完成后关闭同步，同时打开开关，在低峰期的话数据丢失的概率不高。再配合数据校验的工作，是可以保证一致性的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572219976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1017837,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/87/ed/b4b1fd64.jpg","nickname":"禅尔、","note":"","ucode":"4B5D2898354866","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370371,"discussion_content":"开启双写前可以吧主库自增序列设置成 1 3 5，从库除了同步数据，可以开启自增序列 2 4 6，这段时间记录下 ，双写结束后 可以删除这段时间自增为1 3 5 的数据","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1619394161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364616,"discussion_content":"灰度发布只能修改应用代码，修改读请求的比例","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617539571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015754,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","nickname":"helloworld","note":"","ucode":"00DF2FEC58D2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":277069,"discussion_content":"可见这种方案虽然丢失的概率不高，也存在数据不一致，最后也需要做数据校验。数据比较大的话，做校验的时间就比较长","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590993010,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144506,"user_name":"mgxian","can_delete":false,"product_type":"c1","uid":1014806,"ip_address":"","ucode":"7B7E77E6A83B87","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/16/4d1e5cc1.jpg","comment_is_top":false,"comment_ctime":1571962017,"is_pvip":false,"replies":[{"id":"55693","content":"双写之前要将同步断掉","user_name":"作者回复","comment_id":144506,"uid":"1448977","ip_address":"","utype":1,"ctime":1571963441,"user_name_real":"唐扬"}],"discussion_count":3,"race_medal":0,"score":"57406536865","product_id":100035801,"comment_content":"双写方案中 由于新库配置为旧库的从库 此时双写肯定会出现数据重复的问题啊 或者 数据写入失败","like_count":14,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471977,"discussion_content":"双写之前要将同步断掉","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571963441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1193337,"avatar":"https://static001.geekbang.org/account/avatar/00/12/35/79/21647da2.jpg","nickname":"Keith","note":"","ucode":"B40774090714D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":40433,"discussion_content":"同问, 什么时候将同步断掉呢? 数据在不断的写入, 在将同步断掉之后和开启双写之前如果有数据写入如何处理?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572190540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1332557,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132","nickname":"饭团","note":"","ucode":"E24F240CC91BE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39601,"discussion_content":"老师，如果是高峰期的话！mysql很难做到完全同步完成！所以这个过程可能会比较长是吧！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571965894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152166,"user_name":"fomy","can_delete":false,"product_type":"c1","uid":1125834,"ip_address":"","ucode":"CD87EA03B1F327","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg","comment_is_top":false,"comment_ctime":1573896054,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"53113503606","product_id":100035801,"comment_content":"基于双写的方案我总结了2种实现：<br>1、基于同步写新库和旧库方案<br>在写入数据的时候，同步写入旧库数据，异步写入新库数据。<br>数据校验，对部分数据进行校验（最容易出问题的地方，需要提前准备好脚本）。<br>使用灰度发布方式将读流量切换到新库。<br>观察几天没问题后，可以改成只写新库。<br>2、基于Canal的迁移方案<br>将新库配置为源库的从库，同步数据。比如使用Canal同步数据。<br>数据校验，对部分数据进行校验（最容易出问题的地方，需要提前准备好脚本）。<br>使用灰度发布方式将读流量切换到新库。<br>暂停应用，将新库作为主库写入，使用Canal同步到旧库。<br>观察几天没问题后，撤销Canal的同步。","like_count":13},{"had_liked":false,"id":160108,"user_name":"星空","can_delete":false,"product_type":"c1","uid":1302360,"ip_address":"","ucode":"0F6A556FC7B40F","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/58/5b73780a.jpg","comment_is_top":false,"comment_ctime":1575871454,"is_pvip":false,"replies":[{"id":"61413","content":"这就更复杂了","user_name":"作者回复","comment_id":160108,"uid":"1448977","ip_address":"","utype":1,"ctime":1576122491,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":0,"score":"48820511710","product_id":100035801,"comment_content":"老师说的方案，和我们前几个月做的方案整体上很想。不过我们的方案和场景更复杂一点，我们是系统升级。老系统为.Net+SqlServer，新系统是Java+Mysql。业务上由于是直接基于标品二次开发，所以存在新老系统的业务兼容和数据兼容，并不能简单的通过双写就解决问题。我们引入了kafka组件。和两个数据同步服务，两个服务之间商定共同认可的统一业务消息体，互相实时发送增量消息，并解析对方发送来的消息结合自己的业务入库。流量在网关层依据某个hander标识字段去分流，用apollo开关可以随时掌控切换的比例。做到随时能进能退。数据校验，对全量我们采用了业务抽检+总数校验。对增量我们才用了T+1后的增长量校验。为了验证新系统的业务准确性，还在网关层做了流量拷贝，响应对比等","like_count":11,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477259,"discussion_content":"这就更复杂了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576122491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146391,"user_name":"小喵喵","can_delete":false,"product_type":"c1","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":false,"comment_ctime":1572512246,"is_pvip":false,"replies":[{"id":"56579","content":"数据的同步可以考虑解析binlog来同步<br><br>校验就真的没辙了，我之前经历的大的数据迁移都是已月为单位的","user_name":"作者回复","comment_id":146391,"uid":"1448977","ip_address":"","utype":1,"ctime":1572565894,"user_name_real":"唐扬"}],"discussion_count":3,"race_medal":0,"score":"35932250614","product_id":100035801,"comment_content":"老师说的迁移是指的旧库迁移到新库，新旧库的表结构基本一样。但是如果系统重构后的迁移就很难做了。我以前遇到一个大的系统，整个db里面有几千张表。重构后采用微服务的方式，原来的一个db分成了10多个db，还做了分表。有些原来旧库的表也做了拆分，合并，字段的增加、减少等。旧库表中的有些字段名字都重新命名了。这样的数据迁移都是狗血的数据迁移。整个公司组建一个数据迁移团队，包括开发，架构师，技术总监，dba，运维等几百人，数据校验也基本都是人工校验。耗几个月才完成了数据迁移。而且问题一大推。面对如何奇葩的数据迁移，老师有什么好的方案？","like_count":9,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472840,"discussion_content":"数据的同步可以考虑解析binlog来同步\n\n校验就真的没辙了，我之前经历的大的数据迁移都是已月为单位的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572565894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1033240,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkwbyTYtSCx6Qc7cQPnnRWv38Jybh3etziaPmuP8gHcgS6FMxcdftrKgWiamH6fc2iciaicDKDVEwcEibQ/132","nickname":"sami","note":"","ucode":"9A66FCA00D8A37","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":208624,"discussion_content":"我做过异构数据库，数据模型变动很大的数据迁移","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584566615,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812818,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/52/263ac4ca.jpg","nickname":"恒律","note":"","ucode":"BA33907BEE0D0F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554049,"discussion_content":"我想问问，现在有什么好的解决方法吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646196833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145376,"user_name":"知行合一","can_delete":false,"product_type":"c1","uid":1090784,"ip_address":"","ucode":"563C4A71D80DA1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJwQvLGE4dMsF4JU0svW3DtGbodpjskbY65FdwF13JdtBYZfgL2IXHlHrdejWzHdjT0RibEIfib4QYA/132","comment_is_top":false,"comment_ctime":1572261005,"is_pvip":false,"replies":[{"id":"56125","content":"比如说从源库随机抽取一定量的数据，从新库中查询看是否一致","user_name":"作者回复","comment_id":145376,"uid":"1448977","ip_address":"","utype":1,"ctime":1572302899,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":0,"score":"35931999373","product_id":100035801,"comment_content":"老师，数据具体怎么校验呢，简单说下常用的校验方式吧，谢谢","like_count":8,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472365,"discussion_content":"比如说从源库随机抽取一定量的数据，从新库中查询看是否一致","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572302899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144755,"user_name":"Victor","can_delete":false,"product_type":"c1","uid":1301853,"ip_address":"","ucode":"FE02A97FF9A007","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/5d/ea2e41d0.jpg","comment_is_top":false,"comment_ctime":1572050435,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27341854211","product_id":100035801,"comment_content":"业务不做改造的话，无论哪种方案，要想新老环境数据一致，都需要短暂的禁写。即使是业务层做改造，按不同的模块双写数据库，同时MySQL新老环境相互同步，但在具体切换的时候，也要考虑主从延迟，从这点来看，其实还是会有一段时间的禁写。","like_count":6},{"had_liked":false,"id":148136,"user_name":"任鹏斌","can_delete":false,"product_type":"c1","uid":1104086,"ip_address":"","ucode":"34319B05EA6E74","user_header":"https://static001.geekbang.org/account/avatar/00/10/d8/d6/47da34bf.jpg","comment_is_top":false,"comment_ctime":1572946853,"is_pvip":false,"replies":[{"id":"57337","content":"是的，是要先停掉同步关系","user_name":"作者回复","comment_id":148136,"uid":"1448977","ip_address":"","utype":1,"ctime":1573170303,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":0,"score":"18752816037","product_id":100035801,"comment_content":"老师有个疑问，数据库的双写方案1,2步之间，切换为双写前是不是应该停掉新旧库的同步关系？","like_count":4,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473411,"discussion_content":"是的，是要先停掉同步关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573170303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144533,"user_name":"Corner","can_delete":false,"product_type":"c1","uid":1446316,"ip_address":"","ucode":"7862D593172536","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/ac/9cc5e692.jpg","comment_is_top":false,"comment_ctime":1571966785,"is_pvip":false,"replies":[{"id":"55937","content":"1. 还真没有，其实改动代码也简单<br>2. 需要断开的，可以在双写的时候加开关，断开同步时立刻打开开关","user_name":"作者回复","comment_id":144533,"uid":"1448977","ip_address":"","utype":1,"ctime":1572219525,"user_name_real":"唐扬"}],"discussion_count":2,"race_medal":0,"score":"14456868673","product_id":100035801,"comment_content":"老师您好，关于双写方案有两个疑问需要请教一下。1.数据同时写入两个数据库怎么做对代码的改动比较小呢？有成熟的工具或中间件来做吗？2.新库在同步追上旧库的binlog后，在开始双写时需要断开吗？不然对于新库会有重复的数据。如果新库需要停止对旧库的binlog同步，和双写的开启时机这里怎么做协调呢？","like_count":3,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471993,"discussion_content":"1. 还真没有，其实改动代码也简单\n2. 需要断开的，可以在双写的时候加开关，断开同步时立刻打开开关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572219525,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1643469,"avatar":"","nickname":"Loony","note":"","ucode":"7A964196C03D77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39775,"discussion_content":"binlog同步到某个时间点断开，同时开启双写","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571983705,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210517,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1587783006,"is_pvip":false,"replies":[{"id":"78855","content":"数据校验好了就可以切新库","user_name":"作者回复","comment_id":210517,"uid":"1448977","ip_address":"","utype":1,"ctime":1588069973,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":0,"score":"10177717598","product_id":100035801,"comment_content":"数据迁移目前还没做过，不过面试时曾经被问到过，给的是双写的方案。<br>关键点：<br>1：数据校验怎么做？<br>2：什么时候换成读新库？<br>3：什么时候不再写旧库？<br>允许停服务，怎么都好说，不能停服务，选择的时机非常关键，那一个时刻判断出数据已经一致了，怎么判断太关键了，线上有可能做不到完全一致，需要做一些线下补偿。<br>怎么判断数据是否一致呢？记录条数加抽样比对，允许一定的误差，不如总有误差就永远切不了啦！然后再去线下补偿。","like_count":2,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493042,"discussion_content":"数据校验好了就可以切新库","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588069973,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282629,"user_name":"torres","can_delete":false,"product_type":"c1","uid":1108761,"ip_address":"","ucode":"34DABCFC7B74EA","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/19/76b0b98c.jpg","comment_is_top":false,"comment_ctime":1615343973,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5910311269","product_id":100035801,"comment_content":"在将本地库迁移到云上库的场景中，为什么需要在本地再建一个云库的备库，然后回滚的时候，切换到这个备库？  为什么不直接切换到原来的旧库？","like_count":1},{"had_liked":false,"id":216631,"user_name":"Geek_c42505","can_delete":false,"product_type":"c1","uid":1232899,"ip_address":"","ucode":"6421EB85640C44","user_header":"https://static001.geekbang.org/account/avatar/00/12/d0/03/2e632d36.jpg","comment_is_top":false,"comment_ctime":1589298590,"is_pvip":false,"replies":[{"id":"82726","content":"我会想在业务低峰期迁移","user_name":"作者回复","comment_id":216631,"uid":"1448977","ip_address":"","utype":1,"ctime":1591538968,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":0,"score":"5884265886","product_id":100035801,"comment_content":"请问老师，迁移redis 有分布式锁的存在，该怎样处理好","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494888,"discussion_content":"我会想在业务低峰期迁移","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591538968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":206271,"user_name":"whiledoing","can_delete":false,"product_type":"c1","uid":1049643,"ip_address":"","ucode":"1BEB769E13F47C","user_header":"https://static001.geekbang.org/account/avatar/00/10/04/2b/68d6ac0d.jpg","comment_is_top":false,"comment_ctime":1586831829,"is_pvip":true,"replies":[{"id":"78263","content":"先迁移，后重构，不香吗 ：）<br><br>如果一起做的话 可以基于消息来做，只是会复杂很多","user_name":"作者回复","comment_id":206271,"uid":"1448977","ip_address":"","utype":1,"ctime":1587623783,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":0,"score":"5881799125","product_id":100035801,"comment_content":"想问一下老师，如果数据的迁移还伴随着领域模型的重构（库表结构差异巨大，单纯基于binlog主从同步无法达到目标，必须业务上实现数据的模型变更，存量迁移和增量同步双写），有没有一些好的实践经验。","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491734,"discussion_content":"先迁移，后重构，不香吗 ：）\n\n如果一起做的话 可以基于消息来做，只是会复杂很多","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587623783,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173066,"user_name":"ちよくん","can_delete":false,"product_type":"c1","uid":1398577,"ip_address":"","ucode":"B71E9B16E4408F","user_header":"https://static001.geekbang.org/account/avatar/00/15/57/31/6772744d.jpg","comment_is_top":false,"comment_ctime":1579419690,"is_pvip":false,"replies":[{"id":"67361","content":"那你们确实比较谨慎：）","user_name":"作者回复","comment_id":173066,"uid":"1448977","ip_address":"","utype":1,"ctime":1579694908,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":0,"score":"5874386986","product_id":100035801,"comment_content":"我做过两次数据同步迁移，使用的双写方案，灰度发布，没有问题后全量切，一般需要半个月。","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481948,"discussion_content":"那你们确实比较谨慎：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579694908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159142,"user_name":"小水","can_delete":false,"product_type":"c1","uid":1104456,"ip_address":"","ucode":"808E8E28BA3827","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/48/0d3cd6fa.jpg","comment_is_top":false,"comment_ctime":1575546887,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5870514183","product_id":100035801,"comment_content":"老师，应该如何做数据库的切流量呢？是在应用层做个全局的计数吗？然后 10&#47;100，40&#47;100这么切分吗？您在场景用是如何做的呢？","like_count":1},{"had_liked":false,"id":157752,"user_name":"la la la","can_delete":false,"product_type":"c1","uid":1188503,"ip_address":"","ucode":"C039AC398EAE07","user_header":"https://static001.geekbang.org/account/avatar/00/12/22/97/708e590a.jpg","comment_is_top":false,"comment_ctime":1575255454,"is_pvip":false,"replies":[{"id":"60611","content":"我目前也在经历上云，物理机和云的互通应该是上云的第一步吧。。<br>","user_name":"作者回复","comment_id":157752,"uid":"1448977","ip_address":"","utype":1,"ctime":1575363569,"user_name_real":"唐扬"}],"discussion_count":2,"race_medal":0,"score":"5870222750","product_id":100035801,"comment_content":"目前正在经历的上云，物理机与云都不互通，需要跳板机一层层的跳，乱七八糟一大堆的东西，就几个人搞，太坑了。","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476520,"discussion_content":"我目前也在经历上云，物理机和云的互通应该是上云的第一步吧。。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575363569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1188503,"avatar":"https://static001.geekbang.org/account/avatar/00/12/22/97/708e590a.jpg","nickname":"la la la","note":"","ucode":"C039AC398EAE07","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":71194,"discussion_content":"不是直连，目前我这要连上云必须得一系列机器代理跳转，感觉很懵逼，不知道到时候要咋迁移","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575387715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144520,"user_name":"黎","can_delete":false,"product_type":"c1","uid":1008946,"ip_address":"","ucode":"B2AB6BB4D7FE9C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/32/74e47b74.jpg","comment_is_top":false,"comment_ctime":1571964992,"is_pvip":false,"replies":[{"id":"55705","content":"👍","user_name":"作者回复","comment_id":144520,"uid":"1448977","ip_address":"","utype":1,"ctime":1571968225,"user_name_real":"唐扬"}],"discussion_count":1,"race_medal":2,"score":"5866932288","product_id":100035801,"comment_content":"有收获","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471985,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571968225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347436,"user_name":"徐凌云","can_delete":false,"product_type":"c1","uid":1066539,"ip_address":"","ucode":"50B5B248414711","user_header":"https://static001.geekbang.org/account/avatar/00/10/46/2b/613bc046.jpg","comment_is_top":false,"comment_ctime":1654039329,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654039329","product_id":100035801,"comment_content":"请问下老师，数据库层面咋灰度，如果新库做灰度，新老库增量数据都不一致le","like_count":0},{"had_liked":false,"id":339030,"user_name":"梦楼","can_delete":false,"product_type":"c1","uid":2093516,"ip_address":"","ucode":"2D0F3050ACC091","user_header":"https://static001.geekbang.org/account/avatar/00/1f/f1/cc/3bd32c6f.jpg","comment_is_top":false,"comment_ctime":1647866419,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647866419","product_id":100035801,"comment_content":"讲的非常好，是我感觉收获最大的一篇了！！！","like_count":0},{"had_liked":false,"id":306178,"user_name":"小胡","can_delete":false,"product_type":"c1","uid":2397964,"ip_address":"","ucode":"1E0DD4138E9D0E","user_header":"","comment_is_top":false,"comment_ctime":1628420112,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628420112","product_id":100035801,"comment_content":"redis的sentinel也可以作为数据迁移方案的一种吧","like_count":0},{"had_liked":false,"id":302316,"user_name":"tongzi","can_delete":false,"product_type":"c1","uid":2002210,"ip_address":"","ucode":"7349A6E42EDF17","user_header":"https://static001.geekbang.org/account/avatar/00/1e/8d/22/0bf540be.jpg","comment_is_top":false,"comment_ctime":1626163984,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1626163984","product_id":100035801,"comment_content":"有个问题，朋友们，级联同步时候，实现回滚时候<br>为什么要先将读请求切换到备库，然后再将写请求切换到备库？<br>不能同时将读请求和写请求，切换到备库嘛","like_count":0,"discussions":[{"author":{"id":1211909,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7e/05/431d380f.jpg","nickname":"鸠摩·智","note":"","ucode":"6CD93CD1DB6955","race_medal":5,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388760,"discussion_content":"读写都切，会造成业务停止","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628939249,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302310,"user_name":"tongzi","can_delete":false,"product_type":"c1","uid":2002210,"ip_address":"","ucode":"7349A6E42EDF17","user_header":"https://static001.geekbang.org/account/avatar/00/1e/8d/22/0bf540be.jpg","comment_is_top":false,"comment_ctime":1626163414,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626163414","product_id":100035801,"comment_content":"你好老师，有个问题，级联同步方案回滚时候<br>为什么要将读流量切到备库，再将写流量切到备库","like_count":0},{"had_liked":false,"id":260860,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1605145353,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1605145353","product_id":100035801,"comment_content":"老师，请教一下，数据迁移之前，是通过表自增主键进行关联。但是迁移之后，新表的自增主键已经不合适关联旧数据。<br>请问，迁移前的旧数据，迁移后如何保持原有的关联关系?<br>谢谢","like_count":0,"discussions":[{"author":{"id":1297630,"avatar":"https://static001.geekbang.org/account/avatar/00/13/cc/de/e28c01e1.jpg","nickname":"剑八","note":"","ucode":"0A09F41DB8A4E7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559882,"discussion_content":"新表加关联字段","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649039828,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1211909,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7e/05/431d380f.jpg","nickname":"鸠摩·智","note":"","ucode":"6CD93CD1DB6955","race_medal":5,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388761,"discussion_content":"先改造系统使用全局id后，再做迁移？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628939508,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253269,"user_name":"聪","can_delete":false,"product_type":"c1","uid":1009831,"ip_address":"","ucode":"9D672A8580A945","user_header":"https://static001.geekbang.org/account/avatar/00/0f/68/a7/c3fd1fd9.jpg","comment_is_top":false,"comment_ctime":1602667373,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602667373","product_id":100035801,"comment_content":"debezium 到kafka也不错","like_count":0},{"had_liked":false,"id":225113,"user_name":"杨领well","can_delete":false,"product_type":"c1","uid":1145650,"ip_address":"","ucode":"3974A03855168C","user_header":"https://static001.geekbang.org/account/avatar/00/11/7b/32/60089a62.jpg","comment_is_top":false,"comment_ctime":1591661231,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591661231","product_id":100035801,"comment_content":"级联同步方案中，停写的部分可以通过更新缓存+消息队列延迟写 DB 的方式来减少影响。","like_count":0},{"had_liked":false,"id":223066,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1015754,"ip_address":"","ucode":"00DF2FEC58D2E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","comment_is_top":false,"comment_ctime":1590993653,"is_pvip":false,"replies":[{"id":"82717","content":"全量数据可以离线导过去","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1591538511,"ip_address":"","comment_id":223066,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1590993653","product_id":100035801,"comment_content":"mysql的binlog是有过期时间的，双写方案中同步binlog的话，也不是全量的binlog，已经存在的全量数据得通过其他的方式迁移到从库中吧？另外关闭双写的时机确实很难把控啊","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497003,"discussion_content":"全量数据可以离线导过去","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591538511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188856,"user_name":"趁早","can_delete":false,"product_type":"c1","uid":1031970,"ip_address":"","ucode":"949FB3AA250D80","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/22/26530e66.jpg","comment_is_top":false,"comment_ctime":1584426829,"is_pvip":false,"replies":[{"id":"73098","content":"其实很多的，毕竟这种方式能实现最快的切换","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1584590619,"ip_address":"","comment_id":188856,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584426829","product_id":100035801,"comment_content":"实际预热的场景一般会很少","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487550,"discussion_content":"其实很多的，毕竟这种方式能实现最快的切换","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584590619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":179644,"user_name":"123456","can_delete":false,"product_type":"c1","uid":1485820,"ip_address":"","ucode":"9F7C4F3E4416BE","user_header":"https://static001.geekbang.org/account/avatar/00/16/ab/fc/38ccd186.jpg","comment_is_top":false,"comment_ctime":1582068525,"is_pvip":false,"replies":[{"id":"69765","content":"其实很难做到一致性~ 所以要做数据校验，校验迁移源和目的是否一致","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1582075036,"ip_address":"","comment_id":179644,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1582068525","product_id":100035801,"comment_content":"老师，双写需要考虑分布式一致性吗，如何比较简单的实现？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484341,"discussion_content":"其实很难做到一致性~ 所以要做数据校验，校验迁移源和目的是否一致","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582075036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":176770,"user_name":"陈斌","can_delete":false,"product_type":"c1","uid":1450358,"ip_address":"","ucode":"B3F3A2117F8455","user_header":"https://static001.geekbang.org/account/avatar/00/16/21/76/0e443bcb.jpg","comment_is_top":false,"comment_ctime":1581161887,"is_pvip":false,"replies":[{"id":"68824","content":"1. 很难保证原子性，所以要做数据校验<br>2.是的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1581334815,"ip_address":"","comment_id":176770,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1581161887","product_id":100035801,"comment_content":"老师，想问下双写的具体实现是怎么做呢？我的理解是<br>1、同步写入旧库和新库，同时需要保证原子性是吗？<br>2、是对原本应用服务器中的所有sql语句进行拦截，如果是写操作，则做多一个写入新库的逻辑？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483206,"discussion_content":"1. 很难保证原子性，所以要做数据校验\n2.是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581334815,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161124,"user_name":"Klaus","can_delete":false,"product_type":"c1","uid":1326597,"ip_address":"","ucode":"BF2683C893E20A","user_header":"https://static001.geekbang.org/account/avatar/00/14/3e/05/cc934cb3.jpg","comment_is_top":false,"comment_ctime":1576122873,"is_pvip":false,"replies":[{"id":"62165","content":"迁移上云之后，旧库和云上的数据库之间的同步就断掉了，因为数据已经往云上写了","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576744499,"ip_address":"","comment_id":161124,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1576122873","product_id":100035801,"comment_content":"老师，级联方案中 备库的作用是什么？问中说是用于回滚，防止云上环境与机房环境不一致。但是，回滚直接回滚到旧库不行吗？三个库的数据是同步的啊？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477607,"discussion_content":"迁移上云之后，旧库和云上的数据库之间的同步就断掉了，因为数据已经往云上写了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576744499,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157196,"user_name":"吴青","can_delete":false,"product_type":"c1","uid":1048965,"ip_address":"","ucode":"26DBF37AAF0000","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/85/a2279772.jpg","comment_is_top":false,"comment_ctime":1575078919,"is_pvip":false,"replies":[{"id":"60623","content":"主从延迟是可以监控的，可以看主从没有延迟了就可以断掉同步了","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1575367573,"ip_address":"","comment_id":157196,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1575078919","product_id":100035801,"comment_content":"老师有个疑问, 关于&quot;双写之前要将同步断掉&quot;, 什么时候将同步断掉呢?这个是怎样判断同步差不多，可以关闭同步，打开双写的","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476359,"discussion_content":"主从延迟是可以监控的，可以看主从没有延迟了就可以断掉同步了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575367573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151667,"user_name":"圣城小石匠","can_delete":false,"product_type":"c1","uid":1530250,"ip_address":"","ucode":"A195F40925257E","user_header":"https://static001.geekbang.org/account/avatar/00/17/59/8a/8dd55381.jpg","comment_is_top":false,"comment_ctime":1573777730,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573777730","product_id":100035801,"comment_content":"老师，假如原有系统架构不满足业务，需要升级系统架构和业务，如何做到平滑切换，回滚，节约成本呢？","like_count":0},{"had_liked":false,"id":145103,"user_name":"Keith","can_delete":false,"product_type":"c1","uid":1193337,"ip_address":"","ucode":"B40774090714D1","user_header":"https://static001.geekbang.org/account/avatar/00/12/35/79/21647da2.jpg","comment_is_top":false,"comment_ctime":1572190583,"is_pvip":false,"replies":[{"id":"55936","content":"所以要做数据的校验和补写，一般双写会加开关，在断掉同步时马上打开双写开关，时间窗口短，数据丢失的不会很多。","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1572219442,"ip_address":"","comment_id":145103,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1572190583","product_id":100035801,"comment_content":"你好, 关于&quot;双写之前要将同步断掉&quot;, 什么时候将同步断掉呢? 数据在不断的写入, 在将同步断掉之后和开启双写之前如果有数据写入如何处理?","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472248,"discussion_content":"所以要做数据的校验和补写，一般双写会加开关，在断掉同步时马上打开双写开关，时间窗口短，数据丢失的不会很多。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572219442,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144896,"user_name":"jack","can_delete":false,"product_type":"c1","uid":1182934,"ip_address":"","ucode":"D3DBD1DC490E1E","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/d6/2677ec43.jpg","comment_is_top":false,"comment_ctime":1572083637,"is_pvip":false,"replies":[{"id":"55945","content":"这个一般对数据不会有那么强烈的需求吧","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1572220161,"ip_address":"","comment_id":144896,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1572083637","product_id":100035801,"comment_content":"没做过数据迁移的工作，有收获！请教老师一个问题，在“双写”方案中，获取binlog增量日志，异步写入新库，如查多个线程消费，如何保证binlog日志有序写入新库呢？难道对binlog日志进行业务改造？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472158,"discussion_content":"这个一般对数据不会有那么强烈的需求吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572220161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144763,"user_name":"彼得.林","can_delete":false,"product_type":"c1","uid":1019306,"ip_address":"","ucode":"445B9751A88554","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/aa/e739c4fa.jpg","comment_is_top":false,"comment_ctime":1572052325,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572052325","product_id":100035801,"comment_content":"请问老师，双写中较验的核心逻辑是怎么样的？","like_count":0},{"had_liked":false,"id":144710,"user_name":"不经意间","can_delete":false,"product_type":"c1","uid":1261493,"ip_address":"","ucode":"C39D98697ACB8B","user_header":"https://static001.geekbang.org/account/avatar/00/13/3f/b5/5fe77e16.jpg","comment_is_top":false,"comment_ctime":1572003741,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572003741","product_id":100035801,"comment_content":"记录错误日志的想法挺好的","like_count":0},{"had_liked":false,"id":144613,"user_name":"longslee","can_delete":false,"product_type":"c1","uid":1465986,"ip_address":"","ucode":"C24E32E5B1B6F5","user_header":"https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg","comment_is_top":false,"comment_ctime":1571980159,"is_pvip":false,"replies":[{"id":"55940","content":"是会等待比较长的时间，如果缓存热了一段时间可以考虑提高流量比例，核心是看专线的带宽和延迟情况对于应用的影响","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1572219892,"ip_address":"","comment_id":144613,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571980159","product_id":100035801,"comment_content":"打卡。老师你好，最后的10%流量方式，可能会要等的时间比较长吧？能否10%运行一段时间后，逐步提高流量比例，这样更快热到90%？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472032,"discussion_content":"是会等待比较长的时间，如果缓存热了一段时间可以考虑提高流量比例，核心是看专线的带宽和延迟情况对于应用的影响","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572219892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144599,"user_name":"刺猬","can_delete":false,"product_type":"c1","uid":1108297,"ip_address":"","ucode":"60C3E38F4F03CC","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/49/29072f9e.jpg","comment_is_top":false,"comment_ctime":1571976123,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571976123","product_id":100035801,"comment_content":"双写方案一部分流量切换到新库时，这部分流量写入时也需要写旧库","like_count":0},{"had_liked":false,"id":144567,"user_name":"Liush","can_delete":false,"product_type":"c1","uid":1670430,"ip_address":"","ucode":"A02C6AD7B2DD8D","user_header":"https://static001.geekbang.org/account/avatar/00/19/7d/1e/ba1a32aa.jpg","comment_is_top":false,"comment_ctime":1571969869,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1571969869","product_id":100035801,"comment_content":"有一点疑问就是：在数据迁移时如何做到不停机，按照我的理解就是，在数据迁移前上线一个应用记录每次insert的或者update的语句，然后将旧库中的数据同步到新库，同步完成后再读取前面记录的日志来保证新库和旧库数据的同步，在决定完全迁移到新库的时候先停掉旧库的写入，再将应用的数据源迁移到新库(这一步保证日志的状态完全和新库同步)。还有一点就是主从同步如果用mysql的自带的主从来做，好像要保持新库和旧库数据的同步，才能开启主从，那这是否意味着需要将旧库的写入停止，等旧库数据完全迁移到新库时再开启旧库写入功能？(因为需要让新旧库数据保持一致后才能做主从)","like_count":0,"discussions":[{"author":{"id":1089732,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a0/c4/4ab49f4e.jpg","nickname":"孔祥鑫","note":"","ucode":"121EC48A798034","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":41681,"discussion_content":"mysql可以在不停机的情况下加从库，mysqldump主库的时候带上MASTER_LOG_POS，从库导入后设置这个pos，然后等从库慢慢追上就行了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572486732,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144551,"user_name":"饭团","can_delete":false,"product_type":"c1","uid":1332557,"ip_address":"","ucode":"E24F240CC91BE8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132","comment_is_top":false,"comment_ctime":1571967969,"is_pvip":false,"replies":[{"id":"55938","content":"1. 是的，需要同步一段时间，看你的数据量大小<br>2. canal是这样的，接收到binlog 再应用到新库<br>3. 可以增加双写开关，断掉同步后立刻开启开关","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1572219651,"ip_address":"","comment_id":144551,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571967969","product_id":100035801,"comment_content":"老师，我有以下疑惑麻烦您解答一下：<br>1）在双写方式下，因为在切换前必须保证新旧库数据必须完全同步一致，所以这个过程可能会持久很长时间是吧！<br>2）在双写情况下，如果是不改变库表结构（就是单库单表还是到单库单表）可以使用主从模式开来同步新的binlog数据！但是如果是存在拆分表是不是执行逻辑就变成了<br>a：导出旧库binlog，使用chanl应用旧数据到新库！<br>b：使用Chanl实时同步新的binlog到新库！直到数据完全一致！<br>没用过Chanl，不知道是不是这么一个原理！如果不能实时同步binlog那就必然存在停服操作！<br>3）在双写模式下，在断掉主从同步，开始双写那一刻。是不是应用修改双写配置，要先于数据库断开主从同步！因为如果反过来，就有可能在那一刻新库丢掉那一刻的数据！<br>","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472004,"discussion_content":"1. 是的，需要同步一段时间，看你的数据量大小\n2. canal是这样的，接收到binlog 再应用到新库\n3. 可以增加双写开关，断掉同步后立刻开启开关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572219651,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144523,"user_name":"小可","can_delete":false,"product_type":"c1","uid":1006735,"ip_address":"","ucode":"8834AF621FA67D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/8f/551b5624.jpg","comment_is_top":false,"comment_ctime":1571965226,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571965226","product_id":100035801,"comment_content":"总结一下数据迁移核心思想：<br>双写、级联同步或异步同步，保证数据一直性；<br>分步切换读写流量，必要时灰度切换，保证迁移可控性。<br>","like_count":0}]}