{"id":625912,"title":"24ï½œç”Ÿäº§ç¨³å®šçš„ç§˜å¯†æ­¦å™¨ï¼šå¦‚ä½•å®æ–½è“ç»¿å‘å¸ƒï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚ä»Šå¤©æ˜¯æˆ‘ä»¬ GitOps é«˜çº§å‘å¸ƒç­–ç•¥çš„ç¬¬ä¸€è¯¾ã€‚</p><p>åœ¨ä¹‹å‰çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬é€šè¿‡æ„å»º GitOps å·¥ä½œæµå®ç°äº†è‡ªåŠ¨å‘å¸ƒã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä¸“é—¨å»å…³æ³¨æ–°è€ç‰ˆæœ¬åœ¨åšæ›´æ–°æ—¶æ˜¯å¦‚ä½•åˆ‡æ¢æµé‡çš„ï¼Œè¿™æ˜¯å› ä¸º Kubernetes çš„ Service å’Œ Pod æ»šåŠ¨æ›´æ–°æœºåˆ¶è‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬å®Œæˆäº†è¿™éƒ¨åˆ†çš„å·¥ä½œã€‚</p><p>åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†æé«˜å‘å¸ƒçš„å¯é æ€§ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å€ŸåŠ©å‘å¸ƒç­–ç•¥æ¥æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶æµé‡åˆ‡æ¢ã€‚åœ¨å‡ ç§å‘å¸ƒç­–ç•¥ä¸­ï¼Œè“ç»¿å‘å¸ƒæ˜¯è¾ƒä¸ºç®€å•ä¸”å®¹æ˜“ç†è§£çš„ä¸€ç§ï¼Œæ‰€ä»¥ï¼Œæˆ‘å°†ä»å®ƒå¼€å§‹æ¥ä»‹ç»å¦‚ä½•åœ¨ GitOps å·¥ä½œæµä¸­å®æ–½è“ç»¿å‘å¸ƒã€‚</p><p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯è“ç»¿å‘å¸ƒå‘¢ï¼Ÿ</p><p>è“ç»¿å‘å¸ƒæ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>ä¸ºåº”ç”¨æä¾›ä¸¤å¥—ç¯å¢ƒï¼Œå¹¶ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹å®ƒä»¬è¿›è¡Œæµé‡åˆ‡æ¢ã€‚</strong></p><p>åœ¨ä¸€æ¬¡å®é™…å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œæ–°ç‰ˆæœ¬çš„åº”ç”¨å°†ä»¥â€œç»¿è‰²â€ç¯å¢ƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½†åœ¨æµé‡åˆ‡æ¢ä¹‹å‰å®ƒå¹¶ä¸æ¥æ”¶å¤–éƒ¨æµé‡ã€‚å½“æˆ‘ä»¬å®Œæˆâ€œç»¿è‰²â€ç¯å¢ƒçš„æµ‹è¯•ä¹‹åï¼Œå¯ä»¥é€šè¿‡æµé‡åˆ‡æ¢çš„æ–¹å¼è®©â€œç»¿è‰²â€ç¯å¢ƒæ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œæ—§çš„â€œè“è‰²â€ç¯å¢ƒå¹¶ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä½œä¸ºç¾å¤‡æ¥ä½¿ç”¨ã€‚ä¸€æ—¦å‘å¸ƒè¿‡ç¨‹äº§ç”Ÿæ•…éšœï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æµé‡ç«‹å³åˆ‡æ¢åˆ°æ—§çš„â€œè“è‰²â€ç¯å¢ƒä¸‹ã€‚</p><p>è¿™ç§éƒ¨ç½²æ–¹å¼æ¯”è¾ƒé€‚åˆé‚£äº›å­˜åœ¨å…¼å®¹é—®é¢˜ï¼Œæˆ–è€…å› ä¸ºçŠ¶æ€åŸå› å¯¼è‡´ä¸èƒ½å¾ˆå¥½åœ°ä½¿ç”¨ Kubernetes æ»šåŠ¨æ›´æ–°çš„åº”ç”¨ã€‚è¿˜æœ‰çš„é¡¹ç›®å¸Œæœ›åœ¨æ›´æ–°æ—¶éƒ¨ç½²ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼ŒåŒæ—¶æ§åˆ¶æµé‡åˆ‡æ¢è¿‡ç¨‹ï¼›æˆ–è€…æ˜¯åœ¨å‘å¸ƒå‡ºç°é—®é¢˜æ—¶å¿«é€Ÿå›æ»šã€‚è“ç»¿å‘å¸ƒä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</p><!-- [[[read_end]]] --><p>åœ¨è¿™èŠ‚è¯¾ï¼Œé¦–å…ˆæˆ‘ä¼šé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¦‚ä½•é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼æ¥å®æ–½è“ç»¿å‘å¸ƒã€‚ç„¶åï¼Œæˆ‘ä¼šç»“åˆ Argo Rollout è¿™æ¬¾å·¥å…·è¿›ä¸€æ­¥å‘ä½ ä»‹ç»å¦‚ä½•è‡ªåŠ¨åŒ–è“ç»¿å‘å¸ƒè¿‡ç¨‹ã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œä½ éœ€è¦å…·å¤‡ä»¥ä¸‹å‰ææ¡ä»¶ã€‚</p><ul>\n<li>æŒ‰ç…§ç¬¬ä¸€ç« <a href=\"https://time.geekbang.org/column/article/612571\">ç¬¬ 2 è®²</a>çš„å†…å®¹åœ¨æœ¬åœ°é…ç½®å¥½ Kind é›†ç¾¤ï¼Œå®‰è£… Ingress-Nginxï¼Œ<strong>å¹¶æš´éœ² 80 å’Œ 443 ç«¯å£ã€‚</strong></li>\n<li>é…ç½®å¥½ Kubectlï¼Œä½¿å…¶èƒ½å¤Ÿè®¿é—® Kind é›†ç¾¤ã€‚</li>\n</ul><h2>è“ç»¿å‘å¸ƒæ¦‚è¿°</h2><p>ä¸ºäº†æ›´å¥½åœ°å¸®åŠ©ä½ ç†è§£è“ç»¿å‘å¸ƒï¼Œåœ¨æ­£å¼è¿›å…¥å®æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£å®ƒçš„æ•´ä½“æ¶æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c5/d3/c594541df106b974d7794a9be97607d3.jpg?wh=1920x1024\" alt=\"å›¾ç‰‡\"></p><p>åœ¨ä¸Šé¢è¿™å¼ æ¶æ„å›¾ä¸­ï¼Œæˆ‘ä»¬å¯¹åŒä¸€ä¸ªåº”ç”¨éƒ¨ç½²äº†ä¸¤ä¸ªç‰ˆæœ¬çš„ç¯å¢ƒï¼Œç§°ä¹‹ä¸ºè“ç»¿ç¯å¢ƒï¼Œæµé‡é€šè¿‡ Ingress-Nginx è¿›å…¥åˆ° Serviceï¼Œç„¶åå†ç”±å®ƒå°†æµé‡è½¬å‘è‡³ Podã€‚åœ¨æ²¡æœ‰åˆ‡æ¢æµé‡ä¹‹å‰ï¼Œâ€œè“è‰²â€ç¯å¢ƒè´Ÿè´£æ¥æ”¶å¤–éƒ¨è¯·æ±‚æµé‡ã€‚</p><p>éœ€è¦è¿›è¡Œæµé‡åˆ‡æ¢æ—¶ï¼Œåªè¦è°ƒæ•´ Ingress ç­–ç•¥å°±å¯ä»¥è®©â€œç»¿è‰²â€ç¯å¢ƒæ¥æ”¶å¤–éƒ¨æµé‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/86/6e/86f788ec96990e9cdb20184e10f4646e.jpg?wh=1920x1020\" alt=\"å›¾ç‰‡\"></p><h2>è“ç»¿å‘å¸ƒå®æˆ˜</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥è“ç»¿å‘å¸ƒå®æˆ˜ã€‚æˆ‘ä¼šé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ Kubernetes åŸç”Ÿçš„ Deployment å’Œ Service æ¥è¿›è¡Œè“ç»¿å‘å¸ƒï¼Œå®æˆ˜è¿‡ç¨‹ä¸»è¦åŒ…å«ä¸‹é¢å‡ ä¸ªæ­¥éª¤ã€‚</p><ol>\n<li>åˆ›å»ºè“è‰²ç¯å¢ƒçš„ Deployment å’Œ Serviceã€‚</li>\n<li>åˆ›å»º Ingress ç­–ç•¥ï¼Œå¹¶æŒ‡å‘è“è‰²ç¯å¢ƒçš„ Serviceã€‚</li>\n<li>è®¿é—®è“è‰²ç¯å¢ƒã€‚</li>\n<li>åˆ›å»ºç»¿è‰²ç¯å¢ƒçš„ Deployment å’Œ Serviceã€‚</li>\n<li>æ›´æ–° Ingress ç­–ç•¥ï¼Œå¹¶æŒ‡å‘ç»¿è‰²ç¯å¢ƒã€‚</li>\n<li>è®¿é—®ç»¿è‰²ç¯å¢ƒã€‚</li>\n</ol><h3>åˆ›å»ºè“è‰²ç¯å¢ƒ</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºè“è‰²ç¯å¢ƒï¼Œå°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º blue_deployment.yamlã€‚</p><pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: blue\n  labels:\n    app: blue\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: blue\n  template:\n    metadata:\n      labels:\n        app: blue\n    spec:\n      containers:\n      - name: demo\n        image: argoproj/rollouts-demo:blue\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: blue-service\n  labels:\n    app: blue\nspec:\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8080\n  selector:\n    app: blue\n  type: ClusterIP\n</code></pre><p>åœ¨ä¸Šé¢è¿™æ®µ Manifest ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† argoproj/rollouts-demo:blue é•œåƒåˆ›å»ºäº†è“è‰²ç¯å¢ƒçš„ Deployment å·¥ä½œè´Ÿè½½ï¼Œå¹¶ä¸”åˆ›å»ºäº†åä¸º blue-service çš„ Service å¯¹è±¡ï¼ŒåŒæ—¶é€šè¿‡ Service é€‰æ‹©å™¨å°† Service å’Œ Pod è¿›è¡Œäº†å…³è”ã€‚</p><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å‘½ä»¤å°†ç¤ºä¾‹åº”ç”¨éƒ¨ç½²åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f blue_deployment.yaml&nbsp;\ndeployment.apps/blue created\nservice/blue-service created\n</code></pre><p>éƒ¨ç½²å®Œæˆåï¼Œç­‰å¾…å·¥ä½œè´Ÿè½½ Readyã€‚</p><pre><code class=\"language-yaml\">$ kubectl wait pods -l app=blue --for condition=Ready --timeout=90s\npod/blue-79c9fb755d-9b6xx condition met\n</code></pre><p>å½“çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºåï¼Œä»£è¡¨ç»¿è‰²ç¯å¢ƒå·²ç»å‡†å¤‡å¥½äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†åˆ›å»ºè“è‰²ç¯å¢ƒçš„ Ingress ç­–ç•¥ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º blue_ingress.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: demo-ingress\nspec:\n  rules:\n  - host: \"bluegreen.demo\"\n    http:\n      paths:\n      - pathType: Prefix\n        path: \"/\"\n        backend:\n          service:\n            name: blue-service\n            port:\n              number: 80\n</code></pre><p>ç„¶åï¼Œé€šè¿‡ kubectl apply å°†å…¶åº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f blue_ingress.yaml&nbsp; &nbsp;\ningress.networking.k8s.io/demo-ingress created\n</code></pre><p>åœ¨ä¸Šé¢åˆ›å»ºçš„ Ingres ç­–ç•¥ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº† bluegreen.info ä½œä¸ºè®¿é—®åŸŸåã€‚æ‰€ä»¥ï¼Œåœ¨è®¿é—®è“è‰²ç¯å¢ƒä¹‹å‰ï¼Œä½ éœ€è¦å…ˆåœ¨æœ¬åœ°é…ç½® Hosts æ‰èƒ½è®¿é—®ã€‚</p><pre><code class=\"language-yaml\">127.0.0.1 bluegreen.demo\n</code></pre><p>å¦‚æœä½ ç”¨çš„æ˜¯ Linux æˆ–è€… MacOS ç³»ç»Ÿï¼Œè¯·å°†ä¸Šé¢çš„å†…å®¹æ·»åŠ åˆ° /etc/hosts æ–‡ä»¶ã€‚</p><p>å¦‚æœä½ ç”¨çš„æ˜¯ Windows ç³»ç»Ÿï¼Œéœ€è¦å°†ä¸Šé¢çš„å†…å®¹æ·»åŠ åˆ° C:\\Windows\\System32\\Drivers\\etc\\hosts æ–‡ä»¶ã€‚</p><p>æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ <a href=\"https://github.com/oldj/SwitchHosts\">SwitchHosts</a> è¿™æ¬¾å¼€æºå·¥å…·æ¥ç®¡ç† Hosts é…ç½®ã€‚</p><h3>è®¿é—®è“è‰²ç¯å¢ƒ</h3><p>é…ç½®å®Œ Hosts ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è®¿é—®è“è‰²ç¯å¢ƒäº†ã€‚ä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://bluegreen.demo\">http://bluegreen.demo</a>ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„é¡µé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/de/fd/de5788dc52f6a0887738e30e662afefd.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>åœ¨è¿™ä¸ªé¡µé¢é‡Œï¼Œæµè§ˆå™¨æ¯ç§’é’Ÿä¼šå‘åç«¯å‘å‡º 50 ä¸ªè¯·æ±‚ï¼Œè“è‰²çš„æ–¹å—ä»£è¡¨åç«¯è¿”å›æ¥å£çš„å†…å®¹ä¸º blueï¼Œå¯¹åº” blue ç‰ˆæœ¬çš„é•œåƒï¼Œä»£è¡¨è“è‰²ç¯å¢ƒã€‚</p><h3>éƒ¨ç½²ç»¿è‰²ç¯å¢ƒ</h3><p>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯éƒ¨ç½²ç»¿è‰²ç¯å¢ƒã€‚ä½ å¯ä»¥å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º green_deployment.yamlã€‚</p><pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: green\n  labels:\n    app: green\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: green\n  template:\n    metadata:\n      labels:\n        app: green\n    spec:\n      containers:\n      - name: demo\n        image: argoproj/rollouts-demo:green\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: green-service\n  labels:\n    app: green\nspec:\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8080\n  selector:\n    app: green\n  type: ClusterIP\n</code></pre><p>åœ¨è¿™æ®µ Manifest ä¸­ï¼Œæˆ‘ä»¬ç”¨ argoproj/rollouts-demo:green é•œåƒåˆ›å»ºç»¿è‰²ç¯å¢ƒçš„ Deploymentï¼Œå¹¶ä¸”åˆ›å»ºäº†åä¸º green-service çš„ Service å¯¹è±¡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ kubectl apply æ¥å°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f green_deployment.yaml&nbsp;\ndeployment.apps/green created\nservice/green-service created\n</code></pre><p>éƒ¨ç½²å®Œæˆåï¼Œç­‰å¾…å·¥ä½œè´Ÿè½½ Readyã€‚</p><pre><code class=\"language-yaml\">$ kubectl wait pods -l app=green --for condition=Ready --timeout=90s\npod/green-79c9fb755d-9b6xx condition met\n</code></pre><p>å½“çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºåï¼Œä»£è¡¨ç»¿è‰²ç¯å¢ƒå·²ç»å‡†å¤‡å¥½äº†ã€‚</p><h3>åˆ‡æ¢åˆ°ç»¿è‰²ç¯å¢ƒ</h3><p>ç°åœ¨ï¼Œå½“ç»¿è‰²ç¯å¢ƒå·²ç»å‡†å¤‡å¥½æ¥æ”¶å¤–éƒ¨æµé‡æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è°ƒæ•´ Ingress ç­–ç•¥æ¥åˆ‡æ¢æµé‡äº†ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º green_ingress.yamlã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: demo-ingress\nspec:\n  rules:\n  - host: \"bluegreen.demo\"\n    http:\n      paths:\n      - pathType: Prefix\n        path: \"/\"\n        backend:\n          service:\n            name: green-service\n            port:\n              number: 80\n</code></pre><p>åœ¨ä¸Šé¢è¿™æ®µ Ingress Manifest ä¸­ï¼Œæˆ‘ä»¬å°† backend.service å­—æ®µç”±åŸæ¥çš„ blue-service ä¿®æ”¹ä¸ºäº† green-serviceï¼Œè¿™è¡¨ç¤ºå°† Ingress æ¥æ”¶åˆ°çš„å¤–éƒ¨è¯·æ±‚è½¬å‘åˆ°ç»¿è‰²ç¯å¢ƒçš„ Service ä¸­ï¼Œä»¥æ­¤è¾¾åˆ°æµé‡åˆ‡æ¢çš„ç›®çš„ã€‚</p><p>ç°åœ¨ï¼Œå°†è¿™æ®µ Ingress ç­–ç•¥åº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f green_ingress.yaml\ningress.networking.k8s.io/demo-ingress configured\n</code></pre><p>é‡æ–°è¿”å›æµè§ˆå™¨ï¼Œä½ å°†ä¼šçœ‹åˆ°è¯·æ±‚å°†é€æ¸ä»è“è‰²åˆ‡æ¢åˆ°ç»¿è‰²ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8f/b6/8fc6a7dd4ec82581ac8byyb6e44d73b6.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>è¿‡å‡ ç§’é’Ÿåï¼Œè¯·æ±‚å·²ç»å®Œå…¨å˜ä¸ºç»¿è‰²ï¼Œè¿™è¡¨ç¤ºæµé‡å·²ç»å®Œå…¨ä»è“è‰²ç¯å¢ƒåˆ‡æ¢åˆ°äº†ç»¿è‰²ç¯å¢ƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e7/9f/e7b73657678ea74f44e37915950b079f.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œè“ç»¿å‘å¸ƒå°±å·²ç»å®Œæˆäº†ã€‚</p><h2>è“ç»¿å‘å¸ƒè‡ªåŠ¨åŒ–</h2><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬éƒ½æ˜¯é€šè¿‡åˆ›å»º Kubernetes åŸç”Ÿå¯¹è±¡å¹¶ä¿®æ”¹ Ingress ç­–ç•¥çš„æ–¹å¼æ¥å®Œæˆè“ç»¿å‘å¸ƒçš„ã€‚è¿™å­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼Œé¦–å…ˆï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªå…³æ³¨é•œåƒç‰ˆæœ¬çš„å˜åŒ–ï¼Œè€Œä¸ä¼šå»æ“ä½œ Ingress ç­–ç•¥ï¼›å…¶æ¬¡ï¼Œè¿™ç§æ–¹å¼ä¸åˆ©äºå°†è“ç»¿å‘å¸ƒå’Œ GitOps æµæ°´çº¿è¿›è¡Œæ•´åˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡ Argo Rollout å·¥å…·æ¥è‡ªåŠ¨åŒ–è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹ã€‚</p><h3>å®‰è£… Argo Rollout</h3><p>Argo Rollout æ˜¯ä¸€æ¬¾ä¸“é—¨æä¾› Kubernetes é«˜çº§éƒ¨ç½²èƒ½åŠ›çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œå®ƒå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å’Œ ArgoCD ååŒåœ¨ GitOps æµæ°´çº¿ä¸­æ¥ä½¿ç”¨ã€‚</p><p>åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®‰è£…å®ƒï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl create namespace argo-rollouts  # åˆ›å»ºå‘½åç©ºé—´\n$ kubectl apply -n argo-rollouts -f https://ghproxy.com/https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml\n</code></pre><p>å®‰è£…å®Œæˆåï¼Œç­‰å¾… Argo Rollout å·¥ä½œè´Ÿè½½å°±ç»ªã€‚</p><pre><code class=\"language-yaml\">$ kubectl wait --for=condition=Ready pods --all -n argo-rollouts --timeout=300s\npod/argo-rollouts-7f75b9fb76-wh4l5 condition met\n</code></pre><p>å½“çœ‹åˆ°ä¸Šé¢çš„è¿™æ®µè¾“å‡ºåï¼Œè¯´æ˜ Argo Rollout å·²ç»å‡†å¤‡å®Œæˆäº†ã€‚</p><h3>åˆ›å»º Rollout å¯¹è±¡</h3><p>å’Œæ‰‹åŠ¨å®æ–½è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹ä¸åŒçš„æ˜¯ï¼Œä¸ºäº†å®ç°è‡ªåŠ¨åŒ–ï¼ŒArgo Rollout é‡‡ç”¨äº†è‡ªå®šä¹‰èµ„æºï¼ˆCRDï¼‰çš„æ–¹å¼æ¥ç®¡ç†å·¥ä½œè´Ÿè½½ã€‚å¦‚æœä½ æš‚æ—¶è¿˜ä¸ç†è§£ CRD ä¹Ÿæ²¡å…³ç³»ï¼Œä½ åªéœ€è¦çŸ¥é“å®ƒæ˜¯ä¸€ç§æ‰©å±• Kubernetes å¯¹è±¡çš„æ–¹å¼å°±å¯ä»¥äº†ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»º Rollout å¯¹è±¡ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º blue-green-service.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: bluegreen-demo\n  labels:\n    app: bluegreen-demo\nspec:\n  replicas: 3\n  revisionHistoryLimit: 1\n  selector:\n    matchLabels:\n      app: bluegreen-demo\n  template:\n    metadata:\n      labels:\n        app: bluegreen-demo\n    spec:\n      containers:\n      - name: bluegreen-demo\n        image: argoproj/rollouts-demo:blue\n        imagePullPolicy: Always\n        ports:\n        - name: http\n          containerPort: 8080\n          protocol: TCP\n        resources:\n          requests:\n            memory: 32Mi\n            cpu: 5m\n  strategy:\n    blueGreen:\n      autoPromotionEnabled: true\n      activeService: bluegreen-demo\n</code></pre><p>å¦‚æœä½ ä»”ç»†è§‚å¯Ÿï¼Œä¼šå‘ç°åœ¨è¿™ä¸ª Rollout å¯¹è±¡ä¸­ï¼Œå®ƒå¤§éƒ¨åˆ†çš„å­—æ®µå®šä¹‰å’Œ Kubernetes åŸç”Ÿçš„ Deployment å·¥ä½œè´Ÿè½½å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œåªæ˜¯å°† apiVersion ä» apps/v1 ä¿®æ”¹ä¸ºäº† argoproj.io/v1alpha1ï¼ŒåŒæ—¶å°† kind å­—æ®µä» Deployment ä¿®æ”¹ä¸ºäº† Rolloutï¼Œå¹¶ä¸”å¢åŠ äº† strategy å­—æ®µã€‚åœ¨å®¹å™¨é…ç½®æ–¹é¢ï¼ŒRollout å¯¹è±¡åŒæ ·ä¹Ÿä½¿ç”¨äº† argoproj/rollouts-demo:blue æ¥åˆ›å»ºè“è‰²ç¯å¢ƒã€‚</p><p>éœ€è¦ç•™æ„çš„æ˜¯ï¼Œstrategy å­—æ®µæ˜¯ç”¨æ¥å®šä¹‰éƒ¨ç½²ç­–ç•¥çš„ã€‚å…¶ä¸­ï¼ŒautoPromotionEnabled å­—æ®µè¡¨ç¤ºè‡ªåŠ¨å®æ–½è“ç»¿å‘å¸ƒï¼ŒactiveService ç”¨æ¥å…³è”è“ç»¿å‘å¸ƒçš„ Serviceï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨åç»­è¦åˆ›å»ºçš„ Service åç§°ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œå½“æˆ‘ä»¬å°†è¿™æ®µ Rollout å¯¹è±¡åº”ç”¨åˆ°é›†ç¾¤å†…ä¹‹åï¼ŒArgo Rollout é¦–å…ˆä¼šåˆ›å»º Kubernetes åŸç”Ÿå¯¹è±¡ ReplicaSetï¼Œç„¶åï¼ŒReplicaSet ä¼šåˆ›å»ºå¯¹åº”çš„ Podã€‚ä¸ºäº†å¸®åŠ©ä½ ç†è§£ï¼Œä½ å¯ä»¥å°†å®ƒä¸ä¹‹å‰æ‰‹åŠ¨å®æ–½è“ç»¿å‘å¸ƒè¿‡ç¨‹ä¸­åˆ›å»ºçš„ Deployment å·¥ä½œè´Ÿè½½è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e5/4a/e50bb350dd7dcd6f2c1283c1a952c84a.jpg?wh=1903x1413\" alt=\"å›¾ç‰‡\"></p><p>ä»ä¸Šé¢è¿™å¼ å›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå®ƒä»¬çš„æœ€æ ¸å¿ƒçš„åŒºåˆ«åœ¨äº ReplicaSet æ˜¯ç”±è°ç®¡ç†çš„ã€‚å¾ˆæ˜¾ç„¶ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒRollout å¯¹è±¡ç®¡ç† ReplicaSet å¯¹è±¡ï¼Œè¿›è€Œè¾¾åˆ°äº†ç®¡ç† Pod çš„ç›®çš„ã€‚</p><p>åœ¨ç†è§£äº†å®ƒä»¬çš„å…³ç³»ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»º Rollout å¯¹è±¡ã€‚å’Œæ™®é€šèµ„æºä¸€æ ·ï¼Œä½ å¯ä»¥é€šè¿‡ kubectl apply æ¥åˆ›å»ºã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f blue-green-rollout.yaml&nbsp;\nrollout.argoproj.io/bluegreen-demo created\n</code></pre><h3>åˆ›å»º Service å’Œ Ingress</h3><p>åˆ›å»ºå¥½ Rollout å¯¹è±¡ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»º Service å’Œ Ingress ç­–ç•¥ï¼Œè¿™å’Œä¹‹å‰æ‰‹åŠ¨å®æ–½è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹æ˜¯ä¸€è‡´çš„ã€‚</p><p>é¦–å…ˆï¼Œåˆ›å»º Serviceã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º blue-green-service.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: bluegreen-demo\n  labels:\n    app: bluegreen-demo\nspec:\n  ports:\n  - port: 80\n    targetPort: http\n    protocol: TCP\n    name: http\n  selector:\n    app: bluegreen-demo\n</code></pre><p>ç„¶åï¼Œå°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f blue-green-service.yaml&nbsp;\nservice/bluegreen-demo created\n</code></pre><p>æœ€åï¼Œåˆ›å»º Ingress å¯¹è±¡ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º blue-green-ingress.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: bluegreen-demo\nspec:\n  rules:\n  - host: \"bluegreen.auto\"\n    http:\n      paths:\n      - pathType: Prefix\n        path: \"/\"\n        backend:\n          service:\n            name: bluegreen-demo\n            port:\n              number: 80\n</code></pre><p>å’Œä¹‹å‰åˆ›å»ºçš„ Ingress å¯¹è±¡ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† bluegreen.auto åŸŸåï¼Œä»¥ä¾¿å’Œä¹‹å‰åˆ›å»ºçš„ Ingress åŸŸååŒºåˆ†å¼€ã€‚</p><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å‘½ä»¤å°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f blue-green-ingress.yaml&nbsp;\ningress.networking.k8s.io/bluegreen-demo created\n</code></pre><p>åŒæ ·åœ°ï¼Œä¸ºäº†èƒ½å¤Ÿè®¿é—® bluegreen.auto åŸŸåï¼Œä½ è¿˜éœ€è¦æ·»åŠ  Hosts ç­–ç•¥ã€‚</p><pre><code class=\"language-yaml\">127.0.0.1 bluegreen.auto\n</code></pre><h3>è®¿é—®è“è‰²ç¯å¢ƒ</h3><p>é…ç½®å®Œ Hosts ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥è®¿é—®ç”± Argo Rollout åˆ›å»ºçš„è“è‰²ç¯å¢ƒäº†ã€‚ä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://bluegreen.auto\">http://bluegreen.auto</a>ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°å’Œæ‰‹åŠ¨å®æ–½è“ç»¿å‘å¸ƒä¸€æ ·çš„é¡µé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2f/55/2fc72993c507575869fc8b9fa07cf955.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><h3>è“ç»¿å‘å¸ƒè‡ªåŠ¨åŒ–</h3><p>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦æ›´æ–°åˆ°ç»¿è‰²ç¯å¢ƒï¼Œåœ¨ Argo Rollout çš„å¸®åŠ©ä¸‹ï¼Œä½ åªéœ€è¦ä¿®æ”¹ Rollout å¯¹è±¡ä¸­çš„é•œåƒç‰ˆæœ¬å°±å¯ä»¥äº†ï¼Œæµé‡åˆ‡æ¢è¿‡ç¨‹å°†ç”± Argo Rollout è‡ªåŠ¨æ§åˆ¶ã€‚</p><p>è¦æ›´æ–°åˆ°ç»¿è‰²ç¯å¢ƒï¼Œä½ éœ€è¦ç¼–è¾‘ blue-green-rollout.yaml æ–‡ä»¶çš„ image å­—æ®µï¼Œå°† blue ä¿®æ”¹ä¸º green ç‰ˆæœ¬ã€‚</p><pre><code class=\"language-yaml\">containers:\n- name: bluegreen-demo\n  image: argoproj/rollouts-demo:green\n</code></pre><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å°†è¿™æ®µ Rollout å¯¹è±¡é‡æ–°åº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f blue-green-rollout.yaml\nrollout.argoproj.io/bluegreen-demo configured\n</code></pre><p>ç°åœ¨ï¼Œè¿”å›åˆ°æµè§ˆå™¨ï¼Œç­‰å¾…åå‡ ç§’åï¼Œä½ åº”è¯¥å°±èƒ½çœ‹åˆ°è¯·æ±‚é‡Œå¼€å§‹å‡ºç°ç»¿è‰²ç¯å¢ƒäº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e6/91/e6e6f39a9a52cb0e5a60f74096e3ab91.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>å‡ ç§’é’Ÿåï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å˜æˆäº†ç»¿è‰²æ–¹æ ¼ï¼Œè¿™è¡¨ç¤ºè“ç»¿å‘å¸ƒçš„è‡ªåŠ¨åŒ–è¿‡ç¨‹å·²ç»å®Œæˆã€‚</p><p>ç›¸æ¯”è¾ƒæ‰‹åŠ¨çš„æ–¹å¼ï¼Œåœ¨ä½¿ç”¨ Argo Rollout è¿›è¡Œè“ç»¿å‘å¸ƒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦æ‰‹åŠ¨å»åˆ‡æ¢æµé‡ï¼Œé™¤äº†æ›´æ–°é•œåƒç‰ˆæœ¬ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿæ— éœ€å…³æ³¨å…¶ä»–çš„ Kubernetes å¯¹è±¡ã€‚</p><h3>è®¿é—® Argo Rollout Dashboard</h3><p>è¦è®¿é—® Argo Rollout Dashboardï¼Œé¦–å…ˆä½ éœ€è¦å®‰è£… Argo Rollout çš„ kubectl æ’ä»¶ï¼Œä»¥ MacOS ä¸ºä¾‹ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥å®‰è£…ã€‚</p><pre><code class=\"language-yaml\">$ brew install argoproj/tap/kubectl-argo-rollouts\n</code></pre><p>Linux æˆ– Windows ç³»ç»Ÿå¯ä»¥é€šè¿‡ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„æ–¹å¼æ¥å®‰è£…ï¼Œä½ å¯ä»¥åœ¨<a href=\"https://github.com/argoproj/argo-rollouts/releases\">è¿™ä¸ªé“¾æ¥</a>ä¸‹è½½ï¼Œå¹¶å°†å®ƒåŠ å…¥åˆ° PATH ç¯å¢ƒå˜é‡ä¸­ï¼Œè¯¦ç»†çš„æ­¥éª¤ä½ å¯ä»¥å‚è€ƒ<a href=\"https://argoproj.github.io/argo-rollouts/installation/#manual\">è¿™ä»½æ–‡æ¡£</a>ã€‚</p><p>æ’ä»¶å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts version\nkubectl-argo-rollouts: v1.3.0+93ed7a4\n&nbsp; BuildDate: 2022-09-19T02:51:42Z\n&nbsp; GitCommit: 93ed7a497b021051bf6845da90907d67c231e703\n&nbsp; GitTreeState: clean\n&nbsp; GoVersion: go1.18.6\n&nbsp; Compiler: gc\n&nbsp; Platform: darwin/amd64\n</code></pre><p>å½“çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºç»“æœåï¼Œè¯´æ˜æ’ä»¶å®‰è£…æˆåŠŸäº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ kubectl argo rollouts dashboard æ¥å¯ç”¨ Dashboardã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts dashboard\nINFO[0000] Argo Rollouts Dashboard is now available at http://localhost:3100/rollouts\n</code></pre><p>ç„¶åï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://localhost:3100/rollouts\">http://localhost:3100/rollouts</a> æ‰“å¼€ Dashboardï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/79/cd/79f9d70eeed935843ab6a6985f0f1dcd.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><p>ç‚¹å‡»è¿›å…¥ Rollout çš„è¯¦æƒ…ç•Œé¢ï¼Œåœ¨è¿™é‡Œï¼Œä½ èƒ½å¤Ÿä»¥å›¾å½¢åŒ–çš„æ–¹å¼æ¥æŸ¥çœ‹ Rollout çš„ä¿¡æ¯æˆ–è¿›è¡Œå›æ»šæ“ä½œã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8a/36/8abcdf5e8c94749d3037050dec909636.png?wh=1920x1038\" alt=\"å›¾ç‰‡\"></p><h2>è‡ªåŠ¨åŒ–åŸç†</h2><p>é‚£ä¹ˆï¼ŒArgo Rollout ä¸ºä»€ä¹ˆèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨åˆ‡æ¢æµé‡å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä¸ºä½ è¯¦ç»†åˆ†æä¸€ä¸‹å®ƒçš„å·¥ä½œåŸç†ã€‚</p><p>åœ¨åˆšå¼€å§‹åˆ›å»ºè“è‰²ç¯å¢ƒæ—¶ï¼ŒIngressã€Service å’Œ Rollout çš„å…³ç³»æ˜¯ä¸‹å›¾è¿™æ ·ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0d/29/0d7c20a2faf5fe6a361yy6c5c0a47529.jpg?wh=1920x492\" alt=\"å›¾ç‰‡\"></p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“ Rollout å¯¹è±¡åˆ›å»ºåï¼ŒArgo Rollout å°†ä¼šéšä¹‹åˆ›å»º ReplicaSet å¯¹è±¡ï¼Œåç§°ä¸º blue-green-fbc7b7f55ï¼Œè¿™ä¸ª ReplicaSet ä¼šåœ¨åˆ›å»º Pod æ—¶é¢å¤–ä¸º Pod æ‰“ä¸Š rollouts-pod-template-hash=fbc7b7f55 çš„æ ‡ç­¾ï¼ŒåŒæ—¶ä¸º Service æ·»åŠ  rollouts-pod-template-hash=fbc7b7f55 é€‰æ‹©å™¨ï¼Œè¿™æ ·ï¼Œå°±æ‰“é€šäº†ä» Ingress åˆ° Pod çš„è¯·æ±‚é“¾è·¯ã€‚</p><p>å½“æˆ‘ä»¬ä¿®æ”¹ Rollout å¯¹è±¡çš„é•œåƒç‰ˆæœ¬åï¼ŒArgo Rollout å°†ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ ReplicaSet å¯¹è±¡ï¼Œåç§°ä¸º bluegreen-demo-7d6459646dï¼Œæ–°çš„ ReplicaSet ä¹Ÿä¼šåœ¨åˆ›å»º Pod æ—¶é¢å¤–ä¸º Pod æ‰“ä¸Š&nbsp;rollouts-pod-template-hash=7d6459646d æ ‡ç­¾ã€‚è¿™æ—¶å€™è“ç»¿ç¯å¢ƒçš„ ReplicaSet åŒæ—¶å­˜åœ¨ã€‚</p><p>å½“ç»¿è‰²ç¯å¢ƒçš„ Pod å…¨éƒ¨å°±ç»ªä¹‹åï¼ŒArgo Rollout ä¼šå°† Service åŸæ¥çš„é€‰æ‹©å™¨åˆ é™¤ï¼Œå¹¶æ·»åŠ  rollouts-pod-template-hash=7d6459646d çš„é€‰æ‹©å™¨ï¼Œè¿™æ ·å°±å°† Service æŒ‡å‘äº†ç»¿è‰²ç¯å¢ƒçš„ Podï¼Œä»è€Œè¾¾åˆ°äº†åˆ‡æ¢æµé‡çš„ç›®çš„ã€‚åŒæ—¶ï¼ŒArgo Rollout è¿˜ä¼šå°†è“è‰²ç¯å¢ƒçš„ ReplicaSet å‰¯æœ¬æ•°ç¼©å®¹ä¸º 0ï¼Œä½†å¹¶ä¸åˆ é™¤å®ƒï¼Œè€Œæ˜¯æŠŠå®ƒä½œä¸ºç¾å¤‡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/70/a9/70c5b94f26ee5ba580ef59af7e2f9fa9.jpg?wh=1920x804\" alt=\"å›¾ç‰‡\"></p><p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬éœ€è¦é‡æ–°å›æ»šåˆ°è“è‰²ç¯å¢ƒæ—¶ï¼ŒArgo Rollout åªéœ€è°ƒæ•´è“è‰²ç¯å¢ƒçš„ ReplicaSet å‰¯æœ¬æ•°å¹¶ä¸”ä¿®æ”¹ Service çš„é€‰æ‹©å™¨ï¼Œå°±å¯ä»¥è¾¾åˆ°å¿«é€Ÿå›æ»šçš„ç›®çš„ã€‚</p><h2>æ€»ç»“</h2><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘é¦–å…ˆé€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼å¸¦ä½ å®è·µäº†è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒæ˜¯éƒ¨ç½²ä¸¤å¥— Deployment å’Œ Serviceï¼ŒåŒæ—¶é€šè¿‡ä¿®æ”¹ Ingress ç­–ç•¥æ¥å®ç°åˆ‡æ¢æµé‡ã€‚</p><p>ä½†æ‰‹åŠ¨çš„æ–¹å¼å¹¶ä¸é€‚åˆä¸ GitOps æµæ°´çº¿ç»“åˆä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆä»‹ç»äº†é€šè¿‡ Argo Rollout å°†è“ç»¿å‘å¸ƒè‡ªåŠ¨åŒ–çš„æ–¹æ³•ã€‚</p><p>è¦å°†æ‰‹åŠ¨è¿‡ç¨‹åˆ‡æ¢åˆ°è‡ªåŠ¨åŒ–è¿‡ç¨‹å…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®‰è£… Argo Rolloutï¼Œå¹¶ä¿®æ”¹ Deployment å¯¹è±¡çš„ apiVersion å’Œ Kind å­—æ®µï¼Œç„¶åå¢åŠ  strategy å­—æ®µé…ç½®è“ç»¿å‘å¸ƒç­–ç•¥å°±å¯ä»¥äº†ã€‚</p><p>ç„¶åï¼Œæˆ‘è¿˜ä¸ºä½ åˆ†æäº† Argo Rollout å®ç°è‡ªåŠ¨åŒ–è“ç»¿å‘å¸ƒçš„åŸç†ã€‚å’Œæ‰‹åŠ¨ä¿®æ”¹ Ingress ç­–ç•¥æ¥å®ç°çš„è“ç»¿å‘å¸ƒä¸åŒçš„æ˜¯ï¼Œå®ƒä¸»è¦æ˜¯é€šè¿‡è‡ªåŠ¨ä¿®æ”¹ Service çš„é€‰æ‹©å™¨æ¥å¯¹æµé‡è¿›è¡Œåˆ‡æ¢çš„ã€‚è¿™ç§æ–¹å¼å°†è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹å˜æˆäº†æ›´æ–°é•œåƒçš„æ“ä½œï¼Œæå¤§é™ä½äº†è“ç»¿å‘å¸ƒçš„é—¨æ§›ã€‚</p><p>æœ€åï¼Œä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ å¸Œæœ›åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹å®æ–½è“ç»¿å‘å¸ƒï¼Œé‚£ä¹ˆæƒ…å†µä¼šå¤æ‚å¾—å¤šï¼Œä½ éœ€è¦å…³æ³¨æ•´ä¸ªå¾®æœåŠ¡é“¾è·¯çš„è“ç»¿æµé‡çš„åˆ‡æ¢è¿‡ç¨‹ï¼Œå¹¶ä¸”åœ¨æ•°æ®åº“å±‚é¢ä¹Ÿéœ€è¦è€ƒè™‘å¯¹è“ç»¿å‘å¸ƒçš„æ”¯æŒå’Œé€‚é…æƒ…å†µï¼Œä½¿æ•°æ®åº“åœ¨å‡çº§è¿‡ç¨‹ä¸­èƒ½å¤ŸåŒæ—¶æ”¯æŒè“ç»¿ï¼ˆæ–°æ—§ï¼‰åº”ç”¨ã€‚</p><p>åœ¨ä¸‹ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä¼šå‘ä½ ä»‹ç»åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æ›´å¸¸è§çš„ä¸€ç§å‘å¸ƒæ–¹å¼ï¼šé‡‘ä¸é›€å‘å¸ƒã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸¤é“æ€è€ƒé¢˜å§ã€‚</p><ol>\n<li>åœ¨æ‰‹åŠ¨å®æ–½è“ç»¿å‘å¸ƒçš„è¿‡ç¨‹ä¸­ï¼Œå½“æµé‡åˆ‡æ¢åˆ°ç»¿è‰²ç¯å¢ƒæ—¶ï¼Œå¦‚ä½•å°†è“è‰²ç¯å¢ƒçš„å‰¯æœ¬æ•°ç¼©å®¹è‡³ 0 ï¼Ÿ</li>\n<li>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¸€æ—¦æ›´æ–° Rollout å¯¹è±¡çš„é•œåƒç‰ˆæœ¬ï¼Œè“ç»¿å‘å¸ƒè¿‡ç¨‹å°±ä¼šè‡ªåŠ¨è¿›è¡Œã€‚è¯·ä½ åŠ¨æ‰‹è¯•è¯•ï¼Œå¦‚ä½•ä½¿ç”¨ Rollout å¯¹è±¡çš„ autoPromotionEnabled å‚æ•°å’Œ Argo Rollout kubectl æ’ä»¶ï¼Œå®ç°æ‰‹åŠ¨æ§åˆ¶è“ç»¿å‘å¸ƒå‘¢ï¼Ÿï¼ˆå°æç¤ºï¼šä½ å¯ä»¥å‚è€ƒ<a href=\"https://argoproj.github.io/argo-rollouts/features/bluegreen/#example\">è¿™ä¸ªé“¾æ¥</a>ã€‚ï¼‰</li>\n</ol><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":370341,"user_name":"äº‰å…‰ Alan","can_delete":false,"product_type":"c1","uid":1336328,"ip_address":"ä¸Šæµ·","ucode":"338534F909AF03","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/08/0287f41f.jpg","comment_is_top":false,"comment_ctime":1678725184,"is_pvip":false,"replies":[{"id":135052,"content":"è¿™ä¸¤ä¸ªé—®é¢˜éƒ½éå¸¸å¥½ã€‚\né¦–å…ˆæ–‡ç« æ¼”ç¤ºçš„è“ç»¿å‘å¸ƒå®é™…ä¸Šæ˜¯å—åŒ—æµé‡çš„è“ç»¿ï¼Œå¾®æœåŠ¡å†…éƒ¨çš„ä¸œè¥¿æµé‡ç°åº¦éœ€è¦å€ŸåŠ© istio æœåŠ¡ç½‘æ ¼æ¥å®ç°ï¼Œå½“ä¸šåŠ¡å†…éƒ¨å‘èµ·æœåŠ¡é—´è°ƒç”¨æ—¶ï¼Œé€ä¼ ç°åº¦æ ‡è¯†ï¼Œè¿™æ ·æ‰èƒ½å¤Ÿå®ç°å…¨é“¾è·¯çš„ç°åº¦ã€‚\nå…¶æ¬¡æ•°æ®åº“çš„ç°åº¦æ›´å¤æ‚ä¸€äº›ï¼Œä¸€èˆ¬çš„å®è·µæ˜¯å¤šå®ä¾‹æˆ–è€…æ‰©å±• istio åè®®ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1678758780,"ip_address":"å¹¿ä¸œ","comment_id":370341,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æˆ‘ç†è§£rolloutå°±æ˜¯ç»™deploymentåšäº†å¢å¼ºï¼Œå¢åŠ äº†ä¸€ç§æ–°ç‰ˆæœ¬åˆ›å»ºæ—¶è€ç‰ˆæœ¬ä¿ç•™çš„èƒ½åŠ›\n\næˆ‘çš„å‡ ä¸ªç–‘æƒ‘\n1. ä¸€èˆ¬ä¸šåŠ¡ä¼šæœ‰å‰æ®µï¼Œåç«¯ï¼Œæ•°æ®åº“ï¼Œå¾®æœåŠ¡æ›´å¤šç»„ä»¶ï¼Œè¿™æ ·çš„åº”ç”¨å¦‚ä½•è¿›è¡Œè“ç»¿ï¼Ÿrolloutå¯ä»¥å¯¹å¤šä¸ªdeploymentåšè“ç»¿å—ï¼Ÿ\n2. æ–°è€ç‰ˆæœ¬å…±å­˜çš„æƒ…å†µä¸‹ï¼Œæ•°æ®åº“æ˜¯åŒä¸€ä¸ªï¼Œæ•°æ®åº“æ–°è€ç‰ˆæœ¬ä¸å…¼å®¹å¦‚ä½•å¤„ç†ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608957,"discussion_content":"è¿™ä¸¤ä¸ªé—®é¢˜éƒ½éå¸¸å¥½ã€‚\né¦–å…ˆæ–‡ç« æ¼”ç¤ºçš„è“ç»¿å‘å¸ƒå®é™…ä¸Šæ˜¯å—åŒ—æµé‡çš„è“ç»¿ï¼Œå¾®æœåŠ¡å†…éƒ¨çš„ä¸œè¥¿æµé‡ç°åº¦éœ€è¦å€ŸåŠ© istio æœåŠ¡ç½‘æ ¼æ¥å®ç°ï¼Œå½“ä¸šåŠ¡å†…éƒ¨å‘èµ·æœåŠ¡é—´è°ƒç”¨æ—¶ï¼Œé€ä¼ ç°åº¦æ ‡è¯†ï¼Œè¿™æ ·æ‰èƒ½å¤Ÿå®ç°å…¨é“¾è·¯çš„ç°åº¦ã€‚\nå…¶æ¬¡æ•°æ®åº“çš„ç°åº¦æ›´å¤æ‚ä¸€äº›ï¼Œä¸€èˆ¬çš„å®è·µæ˜¯å¤šå®ä¾‹æˆ–è€…æ‰©å±• istio åè®®ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678758780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367394,"user_name":"zangchao","can_delete":false,"product_type":"c1","uid":1391250,"ip_address":"å¤©æ´¥","ucode":"ABF6DC270B127C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJat6pp5AbdicOVBUgPrJicTqkaYC0ZnicrdHb2qHAmvicOJKO3NFH2SczHj7fubVHUKSdRbY9jGCr7SQ/132","comment_is_top":false,"comment_ctime":1675212899,"is_pvip":false,"replies":[{"id":133897,"content":"Argo Rollout æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ¯”è¾ƒè½»é‡ã€‚æ­¤å¤–ï¼ŒNetflix å¼€æºçš„ Spinnaker ä¹Ÿå¯ä»¥åšç°åº¦å‘å¸ƒï¼Œä¸è¿‡æ¯”è¾ƒé‡ã€‚\nå¦‚æœä½ çš„ä¸šåŠ¡æœ‰å¾ˆå¤šä¸ªå¾®æœåŠ¡ï¼Œåœ¨ä¸ä¾µå…¥ä¸šåŠ¡çš„æƒ…å†µä¸‹ï¼Œä¸œè¥¿æµé‡ï¼ˆå¾®æœåŠ¡å’Œå¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼‰çš„ç°åº¦è¿˜æ˜¯éœ€è¦å€ŸåŠ© Service Mesh çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675414745,"ip_address":"å¹¿ä¸œ","comment_id":367394,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æ”¶è·å¾ˆå¤šï¼Œå¾ˆæ„Ÿè°¢è€å¸ˆï¼Œæ­£å¥½æœ€è¿‘åœ¨åšæœåŠ¡è¿ç§»K8sï¼Œéœ€è¦å®ç°æœåŠ¡çš„ç°åº¦å‘å¸ƒã€è“ç»¿å‘å¸ƒç­‰ã€‚æƒ³é—®ä¸‹è€å¸ˆå½“å‰åœ¨K8så®ç°ç°åº¦å‘å¸ƒæœ‰å“ªäº›å¼€æºåº“é€‰æ‹©ï¼ŒArgo Rolloutæ˜¯å¦ä¸ºå®ç°K8sç¯å¢ƒä¸‹ç°åº¦å‘å¸ƒçš„æœ€ä¼˜é€‰æ‹©ï¼Ÿä¹‹å‰æˆ‘ä»¬ç”¨Istioåšè¿‡ï¼Œæœ€è¿‘å‡†å¤‡æ”¾å¼ƒIstioäº†","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601800,"discussion_content":"Argo Rollout æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ¯”è¾ƒè½»é‡ã€‚æ­¤å¤–ï¼ŒNetflix å¼€æºçš„ Spinnaker ä¹Ÿå¯ä»¥åšç°åº¦å‘å¸ƒï¼Œä¸è¿‡æ¯”è¾ƒé‡ã€‚\nå¦‚æœä½ çš„ä¸šåŠ¡æœ‰å¾ˆå¤šä¸ªå¾®æœåŠ¡ï¼Œåœ¨ä¸ä¾µå…¥ä¸šåŠ¡çš„æƒ…å†µä¸‹ï¼Œä¸œè¥¿æµé‡ï¼ˆå¾®æœåŠ¡å’Œå¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼‰çš„ç°åº¦è¿˜æ˜¯éœ€è¦å€ŸåŠ© Service Mesh çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675414745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1038646,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d9/36/92d8eb91.jpg","nickname":"Promise","note":"","ucode":"3E07E270EED2E8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603043,"discussion_content":"è€é“åœ¨å¤©æ´¥åšå¼€å‘è¿˜æ˜¯è¿ç»´å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675920457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368167,"user_name":"BertGeek","can_delete":false,"product_type":"c1","uid":1452799,"ip_address":"ä¸Šæµ·","ucode":"8E1D72C9F9778C","user_header":"https://static001.geekbang.org/account/avatar/00/16/2a/ff/a9d72102.jpg","comment_is_top":false,"comment_ctime":1675950054,"is_pvip":false,"replies":[{"id":134049,"content":"1. æ­£å¸¸ç°è±¡ï¼Œä½ å¯ä»¥ç”¨ Lens ä¸€ç±»çš„ UI å·¥å…·æ¥æŸ¥çœ‹\n2. Rollout ä¼¼ä¹ä¸èƒ½æ”¯æŒè¿™ç§ç”¨æ³•\n3. æŸ¥çœ‹è¿™ä¸ªæ–‡æ¡£ï¼šhttps:&#47;&#47;github.com&#47;argoproj&#47;argo-rollouts&#47;blob&#47;master&#47;docs&#47;features&#47;kustomize.md","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675952470,"ip_address":"å¹¿ä¸œ","comment_id":368167,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è¯·é—®è€å¸ˆï¼Œå‡ ä¸ªé—®é¢˜ï¼š\né˜¿é‡Œäº‘ack é›†ç¾¤ï¼ŒArgo Rolloutå®ç°è“ç»¿å‘å¸ƒ\n1. å› ä¸ºdeployment æ”¹ä¸ºäº† Rolloutï¼Œå¯¼è‡´ack çš„æ— çŠ¶æ€é¡µé¢æ— æ³•çœ‹åˆ°pod å®¹å™¨ï¼Œåªèƒ½åœ¨æ§åˆ¶å°å®¹å™¨ç»„ä¸­çœ‹åˆ°ã€‚\n2. Argo Rollout æ˜¯å¦å¯ä»¥ç›‘æµ‹é•œåƒå˜åŒ–ï¼Œè‡ªåŠ¨å‘å¸ƒæ–°ç‰ˆæœ¬ \n3. Argocd + Rollout ï¼Œå¦‚ä½•ä¸ Kustomize é›†æˆã€‚","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603120,"discussion_content":"1. æ­£å¸¸ç°è±¡ï¼Œä½ å¯ä»¥ç”¨ Lens ä¸€ç±»çš„ UI å·¥å…·æ¥æŸ¥çœ‹\n2. Rollout ä¼¼ä¹ä¸èƒ½æ”¯æŒè¿™ç§ç”¨æ³•\n3. æŸ¥çœ‹è¿™ä¸ªæ–‡æ¡£ï¼šhttps://github.com/argoproj/argo-rollouts/blob/master/docs/features/kustomize.md","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675952470,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367395,"user_name":"æ—é¾","can_delete":false,"product_type":"c1","uid":1766285,"ip_address":"å¹¿ä¸œ","ucode":"61A98DC0DC1E8A","user_header":"https://static001.geekbang.org/account/avatar/00/1a/f3/8d/402e0e0f.jpg","comment_is_top":false,"comment_ctime":1675213132,"is_pvip":false,"replies":[{"id":133898,"content":"è“ç»¿å‘å¸ƒåœ¨å‡çº§è¿‡ç¨‹ä¼šä¿ç•™è€çš„ç¯å¢ƒï¼Œæ ¸å¿ƒæ€æƒ³å†—ä½™ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675415045,"ip_address":"å¹¿ä¸œ","comment_id":367395,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼Œè“ç»¿å‘å¸ƒè¿™é‡Œæ¡ˆä¾‹æ˜¯é€šè¿‡ä¿®æ”¹ingressçš„Deploymentä¸­çš„seviceä¿®æ”¹å¯¹åº”çš„åº”ç”¨ã€‚è‡ªåŠ¨åŒ–æ„å»ºçš„è¯æ˜¯é€šè¿‡å¼•å…¥Argo Rolloutï¼Œè¯·é—®è¿™ä¸ªè‡ªåŠ¨åŒ–æ„å»ºæ—¶ä¿®æ”¹Deploymentçš„imagesæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒä¹Ÿæ˜¯ä¼šé€šè¿‡ReplicaSetåˆ›å»ºæ–°çš„podï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–°çš„podåˆ›å»ºæˆåŠŸåæ‰ä¼šæ…¢æ…¢é”€æ¯æ—§çš„pod","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601803,"discussion_content":"è“ç»¿å‘å¸ƒåœ¨å‡çº§è¿‡ç¨‹ä¼šä¿ç•™è€çš„ç¯å¢ƒï¼Œæ ¸å¿ƒæ€æƒ³å†—ä½™ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675415045,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":374060,"user_name":"Da Vinci","can_delete":false,"product_type":"c1","uid":1061671,"ip_address":"å¹¿ä¸œ","ucode":"DB3B7F6A6028C1","user_header":"https://static001.geekbang.org/account/avatar/00/10/33/27/e5a74107.jpg","comment_is_top":false,"comment_ctime":1683540995,"is_pvip":true,"replies":[{"id":136643,"content":"æˆ‘æ²¡æœ‰é‡åˆ°è¿‡ï¼Œä¸è¿‡ä½ å¯ä»¥å°è¯•çœ‹ä¸€ä¸‹è¿™ä¸ª issuesï¼šhttps:&#47;&#47;github.com&#47;argoproj&#47;argo-cd&#47;issues&#47;6048","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1683630567,"ip_address":"å¹¿ä¸œ","comment_id":374060,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"å¯åŠ¨äº†dashboardï¼Œä½†æ˜¯è·å–ä¸åˆ°rolloutï¼Œçœ‹stdoutputï¼Œä¸Šé¢æŠ¥x509: â€œArgo CDâ€ certificate is not trustedï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› å•Š","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":617522,"discussion_content":"æˆ‘æ²¡æœ‰é‡åˆ°è¿‡ï¼Œä¸è¿‡ä½ å¯ä»¥å°è¯•çœ‹ä¸€ä¸‹è¿™ä¸ª issuesï¼šhttps://github.com/argoproj/argo-cd/issues/6048","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683630567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382709,"user_name":"æ‰˜ç“¦æ–¯å…‹ä¸€ğŸ‹","can_delete":false,"product_type":"c1","uid":2904318,"ip_address":"å¹¿ä¸œ","ucode":"3FB99A5F16A09C","user_header":"https://static001.geekbang.org/account/avatar/00/2c/50/fe/992f7354.jpg","comment_is_top":false,"comment_ctime":1697867720,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è¦ä½¿ç”¨ Rollout å¯¹è±¡çš„ `autoPromotionEnabled` å‚æ•°å’Œ Argo Rollout kubectl æ’ä»¶æ¥å®ç°æ‰‹åŠ¨æ§åˆ¶è“ç»¿å‘å¸ƒï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š\n\n1. ç¡®ä¿å·²å®‰è£… Argo Rollout kubectl æ’ä»¶ã€‚æ‚¨å¯ä»¥å‚è€ƒ Argo Rollout æ–‡æ¡£ä¸­çš„å®‰è£…æŒ‡å—æ¥å®‰è£…æ’ä»¶ï¼šhttps:&#47;&#47;argoproj.github.io&#47;argo-rollouts&#47;installation&#47;\n\n2. åˆ›å»ºä¸€ä¸ª Rollout å¯¹è±¡ï¼Œå¹¶è®¾ç½® `autoPromotionEnabled` å‚æ•°ä¸º `false`ï¼Œä»¥ç¦ç”¨è‡ªåŠ¨æ¨è¿›ï¼ˆauto-promotionï¼‰åŠŸèƒ½ã€‚ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š\n\n```yaml\napiVersion: argoproj.io&#47;v1alpha1\nkind: Rollout\nmetadata:\n  name: my-rollout\nspec:\n  strategy:\n    blueGreen:\n      autoPromotionEnabled: false\n  # å…¶ä»–é…ç½®é¡¹...\n```\n\nåœ¨ä¸Šé¢çš„é…ç½®ä¸­ï¼Œæˆ‘ä»¬å°† `autoPromotionEnabled` è®¾ç½®ä¸º `false`ï¼Œä»¥ç¦ç”¨è‡ªåŠ¨æ¨è¿›åŠŸèƒ½ã€‚\n\n3. ä½¿ç”¨ `kubectl` å‘½ä»¤åˆ›å»ºæˆ–æ›´æ–° Rollout å¯¹è±¡ï¼š\n\n```shell\nkubectl apply -f rollout.yaml\n```\n\nç¡®ä¿å°† `rollout.yaml` æ›¿æ¢ä¸ºæ‚¨å®é™…çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚\n\n4. ä½¿ç”¨ Argo Rollout kubectl æ’ä»¶æ¥æ‰‹åŠ¨æ§åˆ¶è“ç»¿å‘å¸ƒè¿‡ç¨‹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ—å‡º Rollout å¯¹è±¡çš„å¯ç”¨æ“ä½œï¼š\n\n```shell\nkubectl argo rollouts list\n```\n\næ­¤å‘½ä»¤å°†æ˜¾ç¤ºå¯ç”¨çš„ Rollout å¯¹è±¡åŠå…¶çŠ¶æ€ã€‚\n\n5. æ‰§è¡Œè“ç»¿å‘å¸ƒçš„æ­¥éª¤ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ¨è¿›è“ç»¿å‘å¸ƒçš„ä¸åŒé˜¶æ®µï¼š\n\n```shell\nkubectl argo rollouts promote my-rollout\n```\n\nè¿™å°†æ¨è¿› Rollout å¯¹è±¡åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„è“ç»¿å‘å¸ƒé˜¶æ®µã€‚\n\n```shell\nkubectl argo rollouts abort my-rollout\n```\n\nè¿™å°†ä¸­æ­¢å½“å‰çš„è“ç»¿å‘å¸ƒè¿‡ç¨‹ã€‚\n\n```shell\nkubectl argo rollouts set image my-rollout my-container=my-image:tag\n```\n\nè¿™å°†æ›´æ–° Rollout å¯¹è±¡ä¸­çš„å®¹å™¨é•œåƒç‰ˆæœ¬ã€‚\n\né€šè¿‡ä½¿ç”¨è¿™äº›å‘½ä»¤ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æ§åˆ¶è“ç»¿å‘å¸ƒçš„ä¸åŒé˜¶æ®µå’Œæ“ä½œï¼Œè€Œä¸ä¾èµ–äº `autoPromotionEnabled` å‚æ•°çš„è‡ªåŠ¨æ¨è¿›åŠŸèƒ½ã€‚\n","like_count":0},{"had_liked":false,"id":368903,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"åŒ—äº¬","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1676880230,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":1,"score":2,"product_id":100312001,"comment_content":"1. ä»€ä¹ˆæ˜¯è“ç»¿å‘å¸ƒï¼Ÿ\nè“ç»¿å‘å¸ƒå‘¢ï¼Ÿè“ç»¿å‘å¸ƒæ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä¸ºåº”ç”¨æä¾›ä¸¤å¥—ç¯å¢ƒï¼Œå¹¶ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹å®ƒä»¬è¿›è¡Œæµé‡åˆ‡æ¢ã€‚åœ¨ä¸€æ¬¡å®é™…å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œæ–°ç‰ˆæœ¬çš„åº”ç”¨å°†ä»¥â€œç»¿è‰²â€ç¯å¢ƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½†åœ¨æµé‡åˆ‡æ¢ä¹‹å‰å®ƒå¹¶ä¸æ¥æ”¶å¤–éƒ¨æµé‡ã€‚å½“æˆ‘ä»¬å®Œæˆâ€œç»¿è‰²â€ç¯å¢ƒçš„æµ‹è¯•ä¹‹åï¼Œå¯ä»¥é€šè¿‡æµé‡åˆ‡æ¢çš„æ–¹å¼è®©â€œç»¿è‰²â€ç¯å¢ƒæ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼Œè€Œæ—§çš„â€œè“è‰²â€ç¯å¢ƒå¹¶ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä½œä¸ºç¾å¤‡æ¥ä½¿ç”¨ã€‚ä¸€æ—¦å‘å¸ƒè¿‡ç¨‹äº§ç”Ÿæ•…éšœï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æµé‡ç«‹å³åˆ‡æ¢åˆ°æ—§çš„â€œè“è‰²â€ç¯å¢ƒä¸‹ã€‚\n\n2. æ‰‹åŠ¨è“ç»¿å‘å¸ƒ\néƒ¨ç½²ä¸¤å¥—ç¯å¢ƒï¼Œé•œåƒtag åˆ†åˆ«ä¸ºblueã€greenï¼Œåˆ‡æ¢æ“ä½œå…¶å®æ˜¯ä¿®æ”¹ingressçš„\nservice: \n        name: blue-service  # æ”¹ä¸ºgreen-service\nè¿™ç§æ“ä½œ Ingress ç­–ç•¥ä¸åˆ©äºå°†è“ç»¿å‘å¸ƒå’Œ GitOps æµæ°´çº¿è¿›è¡Œæ•´åˆã€‚\n\n3. è“ç»¿å‘å¸ƒè‡ªåŠ¨åŒ–\n3.1 åˆ›å»ºå‘½åç©ºé—´\nkubectl create namespace argo-rollouts  \n3.2 å®‰è£… argo-rollouts\nkubectl apply -n argo-rollouts -f https:&#47;&#47;ghproxy.com&#47;https:&#47;&#47;github.com&#47;argoproj&#47;argo-rollouts&#47;releases&#47;latest&#47;download&#47;install.yaml\n3.3 ç­‰å¾…\nkubectl wait --for=condition=Ready pods --all -n argo-rollouts --timeout=300s\n3.4 åˆ›å»º Rollout å¯¹è±¡â€”â€”blue-green-rollout.yaml \né‡ç‚¹ç†è§£ï¼šstrategy å­—æ®µæ˜¯ç”¨æ¥å®šä¹‰éƒ¨ç½²ç­–ç•¥çš„ã€‚å…¶ä¸­ï¼ŒautoPromotionEnabled å­—æ®µè¡¨ç¤ºè‡ªåŠ¨å®æ–½è“ç»¿å‘å¸ƒï¼ŒactiveService ç”¨æ¥å…³è”è“ç»¿å‘å¸ƒçš„ Serviceï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨åç»­è¦åˆ›å»ºçš„ Service åç§°ã€‚\n\n3.5 åˆ›å»º Service å’Œ Ingress\nkubectl apply -f blue-green-service.yaml\nkubectl apply -f blue-green-ingress.yaml\n\n3.6 åˆ‡æ¢æ“ä½œå¯¹è±¡æ˜¯Rolloutsï¼Œæ˜¯ç¼–è¾‘ blue-green-rollout.yaml æ–‡ä»¶çš„ image å­—æ®µï¼Œå°† blue ä¿®æ”¹ä¸º green ç‰ˆæœ¬ï¼Œç„¶åkubectl apply -f blue-green-rollout.yaml\næµé‡åˆ‡æ¢è¿‡ç¨‹å°†ç”± Argo Rollout è‡ªåŠ¨æ§åˆ¶ã€‚\n\n3.7 è®¿é—® Argo Rollout Dashboard\n$ brew install argoproj&#47;tap&#47;kubectl-argo-rollouts\næ£€æŸ¥ç‰ˆæœ¬\nkubectl argo rollouts version\néƒ¨ç½²dashboard\nkubectl argo rollouts dashboard\n\n4. å½“æˆ‘ä»¬éœ€è¦é‡æ–°å›æ»šåˆ°è“è‰²ç¯å¢ƒæ—¶ï¼ŒArgo Rollout åªéœ€è°ƒæ•´è“è‰²ç¯å¢ƒçš„ ReplicaSet å‰¯æœ¬æ•°å¹¶ä¸”ä¿®æ”¹ Service çš„é€‰æ‹©å™¨ï¼Œå°±å¯ä»¥å›æ»š","like_count":0}]}