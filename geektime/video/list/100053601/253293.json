{"id":253293,"title":"10 | PMQ 2.0项目背景","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-distributed\">https://gitee.com/geektime-geekbang/geektime-distributed</a></p>","comments":[{"had_liked":false,"id":229681,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1593097153,"is_pvip":false,"replies":[{"id":84834,"content":"这个不是kafka本身的问题，原来的PMQ 1.0有一个基于Kafka的方案，之前的架构师在Kafka上面包装了一个分发器(Dispatcher)，相当于把Kafka的拉模式又搞成了推模式，目的是想简化消息接收方。但是原来的推模式没有设计好隔离机制，在推消息的过程中，如果某个接收方慢，就会把分发器整个给堵住了，然后其它的消息接收方会受影响收不到消息。\n\n如果采用分发器+推消息方式，要做好隔离机制还是比较难的，需要在分发器上做多线程隔离。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1593189477,"ip_address":"","comment_id":229681,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"不是很懂 kafka没有采取隔离机制 所以会被慢消费者给堵塞住  老师能不能详细解释一下  这里隔离机制是要隔离啥 要采取什么隔离机制？","like_count":6,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499587,"discussion_content":"这个不是kafka本身的问题，原来的PMQ 1.0有一个基于Kafka的方案，之前的架构师在Kafka上面包装了一个分发器(Dispatcher)，相当于把Kafka的拉模式又搞成了推模式，目的是想简化消息接收方。但是原来的推模式没有设计好隔离机制，在推消息的过程中，如果某个接收方慢，就会把分发器整个给堵住了，然后其它的消息接收方会受影响收不到消息。\n\n如果采用分发器+推消息方式，要做好隔离机制还是比较难的，需要在分发器上做多线程隔离。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593189477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1158156,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ac/0c/f3e37765.jpg","nickname":"夏","note":"","ucode":"2DE213960503A8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":576590,"discussion_content":"既然是因为dispatcher的原因，为什么不解决这个问题，用原生kafka的拉模式，而是重新造轮子呢？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1655691860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":499587,"ip_address":"","group_id":0},"score":576590,"extra":""}]}]},{"had_liked":false,"id":274463,"user_name":"龙彦极客","can_delete":false,"product_type":"c3","uid":2272998,"ip_address":"","ucode":"20D380C00D8B05","user_header":"https://static001.geekbang.org/account/avatar/00/22/ae/e6/0c41e48d.jpg","comment_is_top":false,"comment_ctime":1611028183,"is_pvip":false,"replies":[{"id":99756,"content":"个人认为RocketMQ和RabbitMQ能力上基本等价。但是RocketMQ更面向互联网型大流量高性能消息应用，而RabbitMQ更面向传统企业级消息应用，RocketMQ功能更丰富，但是性能和扩展型不如RocketMQ。公司如果刚开始业务不大，可以从RabbitMQ开始，更容易上手，文档资料更多。到达一定体量，可以再考虑升级到RocketMQ。\n\n虽然这两个MQ都可以部署到K8s环境，但是对于MQ这种有状态服务，其重要性和DB相当，建议独立于K8s单独部署&#47;监控和运维。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1611242976,"ip_address":"","comment_id":274463,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"小公司结合阿里云k8s，做微服务电商系统，只要使用消息队列的功能，但是消息可靠性要强，应该用哪个消息队列？RocketMQ？RabbitMQ？能不能讲一讲RocketMQ和RabbitMQ怎么选型？而且想结合阿里云k8s去做的话。","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514024,"discussion_content":"个人认为RocketMQ和RabbitMQ能力上基本等价。但是RocketMQ更面向互联网型大流量高性能消息应用，而RabbitMQ更面向传统企业级消息应用，RocketMQ功能更丰富，但是性能和扩展型不如RocketMQ。公司如果刚开始业务不大，可以从RabbitMQ开始，更容易上手，文档资料更多。到达一定体量，可以再考虑升级到RocketMQ。\n\n虽然这两个MQ都可以部署到K8s环境，但是对于MQ这种有状态服务，其重要性和DB相当，建议独立于K8s单独部署/监控和运维。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611242976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":229699,"user_name":"SnoWalker","can_delete":false,"product_type":"c3","uid":1094726,"ip_address":"","ucode":"826A3DE7E3AEC9","user_header":"https://static001.geekbang.org/account/avatar/00/10/b4/46/686f5abe.jpg","comment_is_top":false,"comment_ctime":1593103556,"is_pvip":false,"replies":[{"id":84836,"content":"你好，我看的RMQ代码还比较早，在2016年底左右，那个时候它还不是Apache孵化项目。RMQ这几年在Apache下应该有不少改进了，所以现在RMQ的代码质量可能已经大大改进了。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1593189786,"ip_address":"","comment_id":229699,"utype":1}],"discussion_count":4,"race_medal":1,"score":2,"product_id":100053601,"comment_content":"RMQ代码质量一般不知道有没有具体的案例或者细节分析呢？\n我也完整的读过，并且也贡献过几个pr，感觉RMQ比Kafka的理解性以及代码整洁度更好。\n所以想听听波波老师的看法，比较好奇您对它代码的哪些部分不满意","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499598,"discussion_content":"你好，我看的RMQ代码还比较早，在2016年底左右，那个时候它还不是Apache孵化项目。RMQ这几年在Apache下应该有不少改进了，所以现在RMQ的代码质量可能已经大大改进了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593189786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046714,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/d28174a9.jpg","nickname":"Geek_zbvt62","note":"","ucode":"81EA27ADD9EC1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287405,"discussion_content":"我算是rmq的粉丝吧，之前基于4.4.x研究过rmq，可以客观公正的说一下。\n觉得确实代码挺乱的。就比如特别爱用map嵌套map再嵌套map的方式来表示一些特别复杂的数据结构，没进行更进一步的抽象，这些数据结构往往都是核心中的核心，阅读起来真的费劲。这种风格我在其他开源项目里也见过，比如seata...(你肯定知道为什么）\n而且rmq在分布式架构层面上的设计，感觉有些“莽”，在一致性的问题上，没有理论基础支持。例如broker与name server的交互。\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1593435339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046172,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f6/9c/b457a937.jpg","nickname":"不能扮演天使","note":"","ucode":"9922330BFF7FFB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294751,"discussion_content":"看了下rmq我就不想再看了，代码逻辑混乱，而且最重要的是作为一个apache的顶级项目居然注释少的可怜，跟kafka根本没法比。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1595988616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1269766,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/fE8wfb8tpSm2nky69OSKGzwaXg2gXJCpn6ibpkDgeBd26WiblTxVt1ZncUuZnZeFR1QzRgDI3mLe5B310sxqV7zQ/132","nickname":"Aries","note":"","ucode":"68A81F6F2A9502","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592751,"discussion_content":"就是喜欢装逼，说别人代码不行，其实自己讲的也很空，没什么东西","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1667656171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234248,"user_name":"托尼斯威特","can_delete":false,"product_type":"c3","uid":1729060,"ip_address":"","ucode":"98A1035527292E","user_header":"https://static001.geekbang.org/account/avatar/00/1a/62/24/07e2507c.jpg","comment_is_top":false,"comment_ctime":1594629709,"is_pvip":false,"replies":[{"id":86552,"content":"看情况。我个人建议如果有条件的话，尽量用云服务，这个长期是确实。除非某些业务场景(比如金融严格要求合规的场景)，或者本来就是自建数据中心，也有一定的研发运维能力，才考虑自己运维。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1594745417,"ip_address":"","comment_id":234248,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"波波老师您对云服务商的消息队列怎么看? 阿里云提供各种MQ, AWS也有SNS+SQS. 技术选型中要不要考虑是用云服务商的服务还是自己去运维? ","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501328,"discussion_content":"看情况。我个人建议如果有条件的话，尽量用云服务，这个长期是确实。除非某些业务场景(比如金融严格要求合规的场景)，或者本来就是自建数据中心，也有一定的研发运维能力，才考虑自己运维。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594745417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232557,"user_name":"蒙奇D路飞","can_delete":false,"product_type":"c3","uid":1099618,"ip_address":"","ucode":"3A6F82688C2711","user_header":"https://static001.geekbang.org/account/avatar/00/10/c7/62/f93c4b0f.jpg","comment_is_top":false,"comment_ctime":1594037098,"is_pvip":false,"replies":[{"id":85860,"content":"对，能不要造轮子就尽量不要造轮子，解决业务问题优先。但是PMQ这个轮子当时必须得造，具体看我视频中的三点说明。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1594048173,"ip_address":"","comment_id":232557,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"老师开发PMQ的初衷是什么呢?架构设计过程中一般不主张重复造轮子","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500688,"discussion_content":"对，能不要造轮子就尽量不要造轮子，解决业务问题优先。但是PMQ这个轮子当时必须得造，具体看我视频中的三点说明。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594048173,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232366,"user_name":"WangBo","can_delete":false,"product_type":"c3","uid":1080812,"ip_address":"","ucode":"8BFCC4E2639175","user_header":"https://static001.geekbang.org/account/avatar/00/10/7d/ec/ccd30c1d.jpg","comment_is_top":false,"comment_ctime":1593968277,"is_pvip":false,"replies":[{"id":85863,"content":"嗯，到一定规模量级，选择开源是捷径，但定制封装也少不了，且需要一定的源码级把控。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1594048557,"ip_address":"","comment_id":232366,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"特别能理解波波老师当时面临的情况，因为底层技术不重视、技术债、历史技术栈选择、团队组织架构汇报关系等原因，同一件事在公司内可能会有多个类似解决方案，造成底层技术基础设施薄弱、技术选型需站队、故障频发、信息割裂。\n好的架构师可以填坑并力挽狂澜！\n我所在的公司在过去数年前也是经历了急速发展，业务过快发展带来的技术基础设施虚胖，好在经过近两年的沉淀和升级，很多基础设施已经趋于完善。MQ我们选择的RocketMQ，并做了内部二次封装。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500614,"discussion_content":"嗯，到一定规模量级，选择开源是捷径，但定制封装也少不了，且需要一定的源码级把控。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594048557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394470,"user_name":"Allan","can_delete":false,"product_type":"c3","uid":1310388,"ip_address":"内蒙古","ucode":"8DA4DBECC2C45C","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/b4/295338e7.jpg","comment_is_top":false,"comment_ctime":1726891962,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"大佬思路真的是过硬啊","like_count":0},{"had_liked":false,"id":348054,"user_name":"尘飞扬","can_delete":false,"product_type":"c3","uid":2252088,"ip_address":"","ucode":"45D2B267E7A150","user_header":"https://static001.geekbang.org/account/avatar/00/22/5d/38/06404738.jpg","comment_is_top":false,"comment_ctime":1654691701,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100053601,"comment_content":"有个疑问，在为什么不用Kafka时，提到了基于文件存储，把业务数据放在文件存储不放心。PMQ采用了基于数据库的存储。数据库底层不还是文件存储吗？所以在存储这点上，没什么本质区别啊","like_count":0}]}