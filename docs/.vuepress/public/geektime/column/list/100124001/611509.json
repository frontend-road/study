{"id":611509,"title":"26ï½œé«˜å¹¶å‘çˆ¬è™«ï¼šæ¨¡å‹ã€æ§åˆ¶ä¸å†²çªæ£€æµ‹","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ‘å»ºå‹‹ã€‚</p><p>ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†åç¨‹å’Œè°ƒåº¦å™¨çš„å·¥ä½œåŸç†ï¼Œåç¨‹çš„ç‰¹æ€§å†³å®šäº†æˆ‘ä»¬æ— æ³•ä¿è¯åç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåºï¼Œç„¶è€Œåœ¨çœŸæ­£çš„å®è·µä¸­ï¼Œåç¨‹æ˜¯æ— æ³•å®Œå…¨éš”ç¦»çš„ã€‚å®ƒä»¬é€šå¸¸éœ€è¦å®Œæˆæ•°æ®çš„å…±äº«ï¼Œæˆ–è€…è¯´è¦å®ŒæˆæŸç§é€šä¿¡ï¼Œè€Œè¿™åˆä¼šå¯¼è‡´æ•°æ®çš„å¹¶å‘å®‰å…¨ç­‰æ–°çš„é—®é¢˜ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚ä½•åˆç†åœ°ç»„ç»‡å¤§é‡çš„åç¨‹ï¼Œåç¨‹ä¹‹é—´å¦‚ä½•è¿›è¡Œé€šä¿¡ï¼Œåç¨‹æ€ä¹ˆä¼˜é›…é€€å‡ºï¼Œå¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨ï¼Œè¿™äº›æ˜¯æˆ‘ä»¬åœ¨è®¾è®¡é«˜å¹¶å‘çš„æ¨¡å‹æ—¶éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚å¥½çš„å¹¶å‘æ¨¡å‹èƒ½å¤Ÿæå‡ç¨‹åºçš„æ€§èƒ½ã€æ‰©å±•æ€§ä¸å®‰å…¨æ€§ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹ä¸€äº›å¯Œæœ‰è¡¨ç°åŠ›çš„é«˜å¹¶å‘æ¨¡å‹ã€‚è®©æˆ‘ä»¬å…ˆä»å¹¶å‘å¸¦æ¥çš„é—®é¢˜è¯´èµ·ã€‚</p><h2>æ•°æ®äº‰ç”¨</h2><p>åœ¨Go è¯­è¨€ä¸­ï¼Œå½“ä¸¤ä¸ªä»¥ä¸Šåç¨‹åŒæ—¶è®¿é—®ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå†™æ“ä½œæ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œè¿™ç§ç°è±¡ä¹Ÿè¢«å«åšæ•°æ®äº‰ç”¨ã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸¤ä¸ªåç¨‹å…±åŒè®¿é—®äº†å…¨å±€å˜é‡countã€‚è¿™ä¸ªç¨‹åºå…¶å®æ˜¯æœ‰æ•°æ®äº‰ç”¨çš„ï¼Œå› ä¸º count çš„æœ€ç»ˆç»“æœæ˜¯ä¸æ˜ç¡®çš„ã€‚</p><pre><code class=\"language-plain\">var count = 0\nfunc add() {\n\tcount++\n}\nfunc main() {\n\tgo add()\n\tgo add()\n}\n</code></pre><p>count++æ“ä½œçœ‹èµ·æ¥æ˜¯ä¸€æ¡æŒ‡ä»¤ï¼Œä½†æ˜¯å¯¹ CPU æ¥è¯´ï¼Œéœ€è¦å…ˆè¯»å– count çš„å€¼ï¼Œæ‰§è¡Œ +1 æ“ä½œï¼Œå†å°† count çš„å€¼å†™å›å†…å­˜ã€‚å¤§éƒ¨åˆ†äººæœŸæœ›çš„æ“ä½œå¯èƒ½æ˜¯ï¼š Râ†0 ä»£è¡¨è¯»å–åˆ°0ï¼Œwâ†’1 ä»£è¡¨å†™å…¥count ä¸º1ï¼›åç¨‹ 1 å†™å…¥æ•°æ® 1 åï¼Œåç¨‹ 2 å†å†™å…¥ï¼Œcount æœ€åçš„å€¼ä¸º 2ã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/f2/b3/f29cafb185aabae82214yye4040a82b3.jpg?wh=1920x595\" alt=\"å›¾ç‰‡\"></p><p>ä½†æ˜¯å½“ä¸¤ä¸ªåç¨‹å¹¶è¡Œæ—¶ï¼Œæƒ…å†µå¼€å§‹å˜å¾—å¤æ‚äº†ã€‚å¦‚æœæ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œé‚£ä¹ˆ count æœ€åçš„å€¼ä¸º1ï¼Œè¿™è¯´æ˜å¦‚æœå¹¶å‘è®¾è®¡ä¸åˆç†ä¼šå¸¦æ¥ä¸ç¡®å®šæ€§çš„ç»“æœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6d/e4/6dabd7026c17570bb8e50c7782d4b4e4.jpg?wh=1920x595\" alt=\"å›¾ç‰‡\"></p><p>æ•°æ®äº‰ç”¨å¯è°“é«˜å¹¶å‘ç¨‹åºä¸­æœ€éš¾æ’æŸ¥çš„é—®é¢˜ã€‚å› ä¸ºå®ƒçš„ç»“æœæ˜¯ä¸æ˜ç¡®çš„ï¼Œè€Œä¸”å¯èƒ½åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹å‡ºé”™ã€‚è¿™å°±å¯¼è‡´å¾ˆéš¾å¤ç°ç›¸åŒçš„é”™è¯¯ï¼Œåœ¨æµ‹è¯•é˜¶æ®µä¹Ÿä¸ä¸€å®šèƒ½æµ‹è¯•å‡ºé—®é¢˜ã€‚è€Œè¦è§£å†³æ•°æ®äº‰ç”¨é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æœºåˆ¶æ¥ä¿è¯æŸä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªåç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œæˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ä¼ ç»Ÿè§£å†³æ‰‹æ®µå°±æ˜¯é”ï¼Œå®ƒåŒ…æ‹¬åŸå­é”ã€äº’æ–¥é”ä¸è¯»å†™é”ã€‚</p><h2>åŸå­é”</h2><p>å°±åƒæˆ‘ä»¬åˆšæ‰çœ‹åˆ°çš„ï¼Œå³ä¾¿æ˜¯ç®€å•çš„åƒ count++ è¿™æ ·çš„æ“ä½œï¼Œåœ¨åº•å±‚ä¹Ÿç»å†äº†è¯»å–æ•°æ®ã€ æ›´æ–° CPU ç¼“å­˜ã€å­˜å…¥å†…å­˜è¿™ä¸€ç³»åˆ—æ“ä½œã€‚è¿™äº›æ“ä½œå¦‚æœå¹¶å‘è¿›è¡Œå¯èƒ½å‡ºç°ä¸¥é‡é”™è¯¯ã€‚è¿™ç§æƒ…å†µå°±å¯ä»¥ç”¨åŸå­é”æ¥ä¿è¯å¹¶å‘çš„å®‰å…¨ã€‚</p><p>è¿˜æœ‰ä¸€äº›æ›´åŠ å¤æ‚çš„åœºæ™¯éœ€è¦ç”¨åˆ°åŸå­é”ã€‚è®¸å¤šç¼–è¯‘å™¨ï¼ˆåœ¨ç¼–è¯‘æ—¶ï¼‰å’ŒCPU å¤„ç†å™¨ï¼ˆåœ¨è¿è¡Œæ—¶ï¼‰é€šè¿‡è°ƒæ•´æŒ‡ä»¤é¡ºåºè¿›è¡Œä¼˜åŒ–ï¼Œå› æ­¤æŒ‡ä»¤æ‰§è¡Œé¡ºåºå¯èƒ½ä¸ä»£ç ä¸­æ˜¾ç¤ºçš„ä¸åŒã€‚ä¾‹å¦‚ï¼Œå¦‚æœå·²çŸ¥æœ‰ä¸¤ä¸ªå†…å­˜å¼•ç”¨å°†åˆ°è¾¾åŒä¸€ä½ç½®ï¼Œå¹¶ä¸”æ²¡æœ‰ä¸­é—´å†™å…¥ä¼šå½±å“è¯¥ä½ç½®ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¯èƒ½åªä½¿ç”¨æœ€åˆè·å–çš„å€¼ã€‚åˆå¦‚ï¼Œåœ¨ç¼–è¯‘æ—¶ï¼Œa + b + c å¹¶ä¸èƒ½ç”¨ä¸€æ¡ CPU æŒ‡ä»¤æ¥æ‰§è¡Œï¼Œæ‰€ä»¥æŒ‰ç…§åŠ æ³•ç»“åˆå¾‹ï¼Œå®ƒå¯èƒ½è¢«æ‹†åˆ†ä¸º b+c å†+a çš„å½¢å¼ã€‚è¿™ç§éåŸå­æ€§çš„æ“ä½œå°±å¯èƒ½ä¼šé‡åˆ°å¹¶å‘é—®é¢˜ã€‚</p><pre><code class=\"language-plain\">sum = a + b + c;\n=&gt;\nsum = b + c;\nsum = a + sum;\n</code></pre><p>å¦å¤–ï¼Œåœ¨ CPU æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸ä»…å¯èƒ½å‡ºç°ç¼–è¯‘å™¨æ‰§è¡Œé¡ºåºæ··ä¹±çš„é—®é¢˜ï¼Œä¹Ÿå¯èƒ½å‘ç”Ÿä¸ç¨‹åºä¸­æ‰§è¡Œé¡ºåºä¸åŒçš„å†…å­˜è®¿é—®ã€‚ä¾‹å¦‚ï¼Œè®¸å¤šå¤„ç†å™¨åŒ…å«å­˜å‚¨ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºä¼šæ¥æ”¶å¯¹å†…å­˜çš„æŒ‚èµ·å†™æ“ä½œï¼Œå†™ç¼“å†²åŒºåŸºæœ¬ä¸Šæ˜¯&lt;åœ°å€ï¼Œæ•°æ®&gt;çš„é˜Ÿåˆ—ã€‚é€šå¸¸ï¼Œè¿™äº›å†™æ“ä½œå¯ä»¥æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†æ˜¯å¦‚æœéšåçš„å†™æ“ä½œåœ°å€å·²ç»å­˜åœ¨äºå†™ç¼“å†²åŒºä¸­äº†ï¼Œé‚£å¯ä»¥å°†æ­¤å†™æ“ä½œä¸å…ˆå‰çš„æŒ‚èµ·å†™æ“ä½œç»„åˆåœ¨ä¸€èµ·ã€‚</p><p>è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¤„ç†å™¨é«˜é€Ÿç¼“å­˜æœªå‘½ä¸­ã€‚è¿™æ—¶ï¼Œè®¸å¤šå¤„ç†å™¨åœ¨ç­‰å¾…å½“å‰æŒ‡ä»¤ä»ä¸»å†…å­˜ä¸­è·å–æ•°æ®æ—¶ï¼Œä¸ºäº†æœ€å¤§ç¨‹åº¦åœ°åˆ©ç”¨èµ„æºï¼Œ ä¼šç»§ç»­æ‰§è¡Œåç»­æŒ‡ä»¤ï¼Œå¯¼è‡´æ“ä½œä¹±åºã€‚å› æ­¤éœ€è¦æœ‰ä¸€ç§æœºåˆ¶è§£å†³å¹¶å‘è®¿é—®æ—¶æ•°æ®å†²çªåŠå†…å­˜æ“ä½œä¹±åºçš„é—®é¢˜ï¼Œå³æä¾›ä¸€ç§åŸå­æ€§çš„æ“ä½œã€‚è¿™é€šå¸¸ä¾èµ–ç¡¬ä»¶çš„æ”¯æŒï¼Œä¾‹å¦‚X86 æŒ‡ä»¤é›†ä¸­çš„LOCK æŒ‡ä»¤ï¼Œå¯¹åº”åˆ° Go è¯­è¨€å°±æ˜¯ sync/atomic åŒ…ã€‚</p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä½¿ç”¨ atomic.AddInt64 å‡½æ•°å°†å˜é‡å¢åŠ äº† 1ï¼Œè¿™ç§åŸå­æ“ä½œä¸ä¼šå‘ç”Ÿå¹¶å‘æ—¶çš„æ•°æ®äº‰ç”¨é—®é¢˜ã€‚</p><pre><code class=\"language-plain\">var count int64 = 0\nfunc add() {\n\tatomic.AddInt64(&amp;count,1)\n}\nfunc main() {\n\tgo add()\n\tgo add()\n}\n</code></pre><p>sync/atomic åŒ…ä¸­è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼šCompareAndSwapï¼Œå®ƒèƒ½å¤Ÿå¯¹æ¯”å¹¶æ›¿æ¢å…ƒç´ å€¼ã€‚<br>\nä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œatomic.CompareAndSwapInt64 ä¼šåˆ¤æ–­flag å˜é‡çš„å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†flag çš„å€¼è®¾ç½®ä¸º1ã€‚è¿™ä¸€ç³»åˆ—æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šå‘ç”Ÿæ•°æ®äº‰ç”¨ï¼Œä¹Ÿä¸ä¼šå‡ºç°å†…å­˜æ“ä½œä¹±åºé—®é¢˜ã€‚é€šè¿‡sync/atomic åŒ…ä¸­çš„åŸå­æ“ä½œï¼Œæˆ‘ä»¬èƒ½æ„å»ºèµ·ä¸€ç§è‡ªæ—‹é”ï¼Œåªæœ‰è·å–è¯¥é”ï¼Œæ‰èƒ½æ‰§è¡ŒåŒºåŸŸä¸­çš„ä»£ç ã€‚ä¸‹é¢è¿™æ®µä»£ç ä½¿ç”¨ä¸€ä¸ª for å¾ªç¯ä¸æ–­è½®è¯¢åŸå­æ“ä½œï¼Œç›´åˆ°åŸå­æ“ä½œæˆåŠŸæ‰è·å–è¯¥é”ã€‚</p><pre><code class=\"language-plain\">var flag int64 = 0\nvar count int64 = 0\nfunc add() {\n\tfor {\n\t\tif atomic.CompareAndSwapInt64(&amp;flag, 0, 1) {\n\t\t\tcount++\n\t\t\tatomic.StoreInt64(&amp;flag, 0)\n\t\t\treturn\n\t\t}\n\t}\n}\nfunc main() {\n\tgo add()\n\tgo add()\n}\n</code></pre><p>è¿™ç§è‡ªæ—‹é”çš„å½¢å¼åœ¨ Go æºä»£ç ä¸­éšå¤„å¯è§ã€‚å…¶å®ï¼ŒåŸå­æ“ä½œæ˜¯ä¿è¯åŒæ­¥çš„æœ€åŸºæœ¬çš„æŠ€æœ¯ï¼Œé€šè¿‡åŸå­æ“ä½œå¯ä»¥æ„å»ºèµ·è®¸å¤šåŒæ­¥åŸè¯­ï¼Œä¾‹å¦‚è‡ªæ—‹é”ã€ä¿¡å·é‡ã€äº’æ–¥é”ç­‰ã€‚</p><h2>äº’æ–¥é”</h2><p>é€šè¿‡åŸå­æ“ä½œæ„å»ºèµ·çš„è‡ªæ—‹é”ï¼Œè™½ç„¶ç®€å•é«˜æ•ˆï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯ä¸‡èƒ½çš„ã€‚ä¾‹å¦‚ï¼Œå½“æŸä¸€ä¸ªåç¨‹é•¿æ—¶é—´éœ¸å é”çš„æ—¶å€™ï¼Œå…¶ä»–åç¨‹ä»åœ¨ç»§ç»­æŠ¢å é”ï¼Œè¿™ä¼šå¯¼è‡´ CPU èµ„æºæŒç»­æ— æ„ä¹‰åœ°è¢«æµªè´¹ã€‚åŒæ—¶ï¼Œå½“æœ‰è®¸å¤šåç¨‹éƒ½åœ¨è·å–é”çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰åç¨‹å§‹ç»ˆæŠ¢å ä¸åˆ°é”ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œæ“ä½œç³»ç»Ÿçš„é”æ¥å£æä¾›äº†ç»ˆæ­¢ä¸å”¤é†’çš„æœºåˆ¶ï¼ˆä¾‹å¦‚ Linux ä¸­çš„pthread mutexï¼‰ï¼Œè¿™å°±é¿å…äº†é¢‘ç¹è‡ªæ—‹é€ æˆçš„æµªè´¹ã€‚ä¸è¿‡ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é”ä¼šé”ä½æ•´ä¸ªçº¿ç¨‹ä½¿ä¹‹æ— æ³•è¿è¡Œï¼Œå¦å¤–é”çš„æŠ¢å è¿˜ä¼šæ¶‰åŠçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚è€ŒGoè¯­è¨€å€ŸåŠ©åç¨‹å®ç°äº†ä¸€ç§æ¯”ä¼ ç»Ÿæ“ä½œç³»ç»Ÿçº§åˆ«çš„é”æ›´åŠ è½»é‡çº§çš„äº’æ–¥é”ï¼Œå®ƒçš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">var count int64 = 0\nvar m sync.Mutex\nfunc add() {\n\tm.Lock()\n\tcount++\n\tm.Unlock()\n}\nfunc main() {\n\tgo add()\n\tgo add()\n}\n</code></pre><p>è¿™é‡Œï¼Œsync.Mutex æ„å»ºèµ·äº†äº’æ–¥é”ï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œåªä¼šæœ‰ä¸€ä¸ªè·å–äº†é”çš„åç¨‹ä¼šç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œå…¶ä»–çš„åç¨‹å°†é™·å…¥ç­‰å¾…çŠ¶æ€ã€‚å€ŸåŠ©åç¨‹çš„ä¼‘çœ ä¸è°ƒåº¦å™¨çš„è°ƒåº¦ï¼Œè¿™ç§é”ä¼šå˜å¾—éå¸¸è½»é‡ã€‚</p><h2>è¯»å†™é”</h2><p>å½“ç„¶ï¼Œäº’æ–¥é”ä¹Ÿå¹¶ä¸æ€»æ˜¯æœ€å¥½çš„ã€‚ç”±äºåœ¨åŒä¸€æ—¶é—´å†…åªèƒ½æœ‰ä¸€ä¸ªåç¨‹è·å–äº’æ–¥é”å¹¶æ‰§è¡Œæ“ä½œï¼Œé‚£ä¹ˆåœ¨å¤šè¯»å°‘å†™çš„æƒ…å†µä¸‹ï¼Œå¦‚æœé•¿æ—¶é—´æ²¡æœ‰å†™æ“ä½œï¼Œè¯»å–åˆ°çš„ä¼šæ˜¯å®Œå…¨ç›¸åŒçš„å€¼ï¼Œä½¿ç”¨äº’æ–¥é”å°±æ˜¾å¾—æ²¡æœ‰å¿…è¦äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä½¿ç”¨è¯»å†™é”åˆ™æ›´åŠ æ°å½“ã€‚</p><p><strong>è¯»å†™é”é€šè¿‡ä¸¤ç§é”æ¥å®ç°ï¼Œä¸€ç§ä¸ºè¯»é”ï¼Œå¦ä¸€ç§ä¸ºå†™é”ã€‚</strong>å½“è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œéœ€è¦åŠ è¯»é”ï¼Œè€Œè¿›è¡Œå†™å…¥æ“ä½œæ—¶åˆ™éœ€è¦åŠ å†™é”ã€‚å¤šä¸ªåç¨‹å¯ä»¥åŒæ—¶è·å¾—è¯»é”å¹¶æ‰§è¡Œã€‚å¦‚æœæ­¤æ—¶æœ‰åç¨‹ç”³è¯·äº†å†™é”ï¼Œé‚£ä¹ˆè¯¥åç¨‹ä¼šç­‰å¾…æ‰€æœ‰çš„è¯»é”éƒ½é‡Šæ”¾åï¼Œæ‰èƒ½è·å–å†™é”å¹¶æ‰§è¡Œã€‚å¦‚æœå½“å‰çš„åç¨‹ç”³è¯·è¯»é”æ—¶å·²ç»å­˜åœ¨å†™é”ï¼Œé‚£ä¹ˆè¯»é”ä¼šç­‰å¾…å†™é”é‡Šæ”¾åå†è·å–è¯»é”å¹¶æ‰§è¡Œã€‚</p><p>æ€»ä¹‹ï¼Œè¯»é”å¿…é¡»èƒ½è§‚å¯Ÿåˆ°ä¸Šä¸€æ¬¡å†™é”å†™å…¥çš„å€¼ï¼Œå†™é”åˆ™è¦åœ¨ä¹‹å‰çš„è¯»é”é‡Šæ”¾åæ‰èƒ½å†™å…¥ã€‚å¯ä»¥æœ‰å¤šä¸ªåç¨‹è·å¾—è¯»é”ï¼Œä½†åªæœ‰ä¸€ä¸ªåç¨‹å¯ä»¥è·å¾—å†™é”ã€‚</p><p>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå“ˆå¸Œè¡¨å¹¶ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œå®ƒåªèƒ½å¤Ÿå¹¶å‘è¯»å–ï¼Œä¸€æ—¦å¹¶å‘å†™å…¥å°±ä¼šå‡ºç°å†²çªã€‚ä¸€ç§ç®€å•çš„è§„é¿æ–¹å¼æ˜¯ï¼Œåœ¨è·å– Map ä¸­çš„æ•°æ®æ—¶åŠ å…¥RLock è¯»é”ï¼Œåœ¨å†™å…¥æ•°æ®æ—¶ä½¿ç”¨Lock å†™é”ã€‚</p><pre><code class=\"language-plain\">type Stat struct {\n\tcounters map[string]int64\n\tmutex sync.RWMutex\n}\nfunc (s *Stat) getCounter(name string) int64 {\n\ts.mutex.RLock()\n\tdefer s.mutex.RUnlock()\n\treturn s.counters[name]\n}\nfunc (s *Stat) SetCounter(name string){\n\ts.mutex.Lock()\n\tdefer s.mutex.Unlock()\n\ts.counters[name]++\n}\n</code></pre><p>å€ŸåŠ©åŸå§‹çš„å¹¶å‘æ§åˆ¶æ‰‹æ®µï¼ŒGoæä¾›äº†ä¸€äº›å¥½ç”¨çš„å¹¶å‘æ§åˆ¶å·¥å…·ï¼ŒåŒ…æ‹¬äº†sync.WaitGroupï¼Œsync.Onceã€sync.Poolã€sync.Condã€‚ä¸‹é¢æˆ‘ä»¬åˆ†å¼€æ¥çœ‹ä¸€ä¸‹ã€‚</p><h2>Goå¹¶å‘æ§åˆ¶åº“</h2><h3>sync.WaitGroup</h3><p>å…ˆæ¥çœ‹è¿™æ ·ä¸€ä¸ªåœºæ™¯ã€‚åœ¨åŠ è½½é…ç½®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥è®©å¤šä¸ªåç¨‹åŒæ—¶åŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯å´å¸Œæœ›ç­‰åˆ°æ‰€æœ‰åç¨‹éƒ½åŠ è½½å®Œæ¯•åæ‰è®©ç¨‹åºæä¾›æœåŠ¡ï¼Œè¿™å¯ä»¥åŠ å¿«ç¨‹åºçš„è¿è¡Œã€‚</p><p>è¿™æ—¶ï¼Œä¸€ç§æ–¹æ¡ˆæ˜¯ä½¿ç”¨sleepä¼‘çœ ï¼Œä½†è¿™æ˜¯ä¸€ç§ä½æ•ˆçš„è§£å†³æ–¹æ³•ã€‚æ›´é«˜æ•ˆçš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨Goæ ‡å‡†åº“ä¸­çš„<code>sync.WaitGroup</code> ï¼Œå®ƒä¼šç­‰å¾…æ‰€æœ‰çš„åç¨‹æ‰§è¡Œå®Œæ¯•åé€€å‡ºã€‚</p><p><code>sync.WaitGroup</code>  æä¾›äº†3ä¸ªAPIã€‚å…¶ä¸­ï¼Œ<code>WaitGroup.Add</code> ä»£è¡¨å°†ç­‰å¾…çš„æ•°é‡åŠ 1ï¼Œ<code>WaitGroup.done</code> ä»£è¡¨å°†ç­‰å¾…çš„æ•°é‡å‡1ï¼Œ<code>WaitGroup.Wait</code> ä»£è¡¨é™·å…¥ç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ•°é‡ä¸º0ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬åœ¨å¼€å¯åç¨‹ä¹‹å‰è°ƒç”¨ <code>WaitGroup.Add</code> ï¼Œç„¶åå¼€å¯å¤šä¸ªå·¥ä½œåç¨‹ï¼›åœ¨æ¯ä¸€ä¸ªåç¨‹ç»“æŸæ—¶å»¶è¿Ÿè°ƒç”¨<code>WaitGroup.done</code> ï¼Œ åœ¨æœ«å°¾è°ƒç”¨ <code>WaitGroup.Wait</code> é™·å…¥å µå¡ï¼Œç­‰å¾…æ‰€æœ‰åç¨‹æ‰§è¡Œå®Œæ¯•ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">package main\n\nimport (\n    \"fmt\"\n    \"sync\"\n    \"time\"\n)\n\nfunc worker(id int) {\n    fmt.Printf(\"Worker %d starting\\\\n\", id)\n\n    time.Sleep(time.Second)\n    fmt.Printf(\"Worker %d done\\\\n\", id)\n}\n\nfunc main() {\n\n    var wg sync.WaitGroup\n\n    for i := 1; i &lt;= 5; i++ {\n        wg.Add(1)\n\n        i := i\n\n        go func() {\n            defer wg.Done()\n            worker(i)\n        }()\n    }\n\n    wg.Wait()\n\n}\n</code></pre><h3>sync.Once</h3><p>sync.Once åˆ™å¯ä»¥ä¿è¯æŸä¸€ä¸ªæ“ä½œåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå®ƒåœ¨å®è·µä¸­çš„ä½¿ç”¨ä¹Ÿéå¸¸å¹¿æ³›ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›é…ç½®çš„åŠ è½½ã€æ—¥å¿—çš„åˆå§‹åŒ–åªåœ¨åˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡ã€‚åˆå¦‚åœ¨é‡Šæ”¾èµ„æºæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›æ–‡ä»¶æè¿°ç¬¦ä¸é€šé“åªå…³é—­ä¸€æ¬¡ï¼Œè¿™æ—¶å€™éƒ½å¯ä»¥ç”¨åˆ° sync.Onceã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½¿ç”¨sync.Onceåªå…è®¸MysSQLæ•°æ®åº“æ‰“å¼€ä¸€æ¬¡ã€‚</p><pre><code class=\"language-plain\">var (\n    once  sync.Once\n)\n\nfunc DbOnce() (*sql.DB, error) {\n    once.Do(func() {\n        fmt.Println(\"Am called\")\n        db, dbErr = sql.Open(\"mysql\", \"root:test@tcp(127.0.0.1:3306)/test\")\n        if dbErr != nil {\n            return\n        }\n        dbErr = db.Ping()\n    })\n    return db, dbErr\n}\n</code></pre><h3>sync.Cond</h3><p><code>sync.Cond</code> æ˜¯Goæä¾›çš„ä¸€ç§ç±»ä¼¼æ¡ä»¶å˜é‡çš„åŒæ­¥æœºåˆ¶ï¼Œå®ƒèƒ½å¤Ÿè®©åç¨‹é™·å…¥é˜»å¡ï¼Œç›´åˆ°æŸä¸ªæ¡ä»¶å‘ç”Ÿåå†ç»§ç»­æ‰§è¡Œã€‚</p><p><code>sync.Cond</code> åŒ…å«äº†3ä¸ªé‡è¦çš„APIï¼š<code>Cond.Wait()</code>ã€<code>Cond.Signal()</code> å’Œ <code>Cond.Broadcast()</code> ã€‚å…¶ä¸­ï¼Œ<code>Cond.Wait()</code> è¡¨ç¤ºé™·å…¥ç­‰å¾…ï¼Œ<code>Cond.Broadcast()</code> ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹ï¼Œ<code>Cond.Signal()</code> åªå”¤é†’ä¸€ä¸ªæœ€å…ˆç­‰å¾…çš„åç¨‹ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨<code>Cond.Wait()</code> ä¹‹å‰å¿…é¡»è¦è°ƒç”¨<code>Cond.L.Lock()</code>è¿›è¡ŒåŠ é”ï¼Œåœ¨ç»“æŸåè¿˜éœ€è¦è°ƒç”¨ <code>Cond.L.UnLock()</code> è¿›è¡Œè§£é”ã€‚</p><p>ä¸€èˆ¬ä½¿ç”¨ <code>sync.Cond</code> çš„æ­£ç¡®å§¿åŠ¿æ˜¯ï¼š åç¨‹Aä¼šç”¨forå¾ªç¯åˆ¤æ–­æ˜¯å¦æ»¡è¶³ Conditionæ¡ä»¶ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™é™·å…¥ä¼‘çœ ã€‚åç¨‹ B ä¼šåœ¨æ°å½“çš„æ—¶å€™è°ƒç”¨ c.Broadcast() å”¤é†’ç­‰å¾…çš„åç¨‹ã€‚ä½¿ç”¨ for å¾ªç¯æ˜¯å› ä¸ºå½“åç¨‹è¢«å”¤é†’æ—¶ï¼Œå¹¶ä¸èƒ½ä¿è¯å½“å‰æ¡ä»¶æ˜¯æ»¡è¶³çš„ã€‚è¿™æ ·åšä¹Ÿå¯ä»¥å®ç°æŸç§ç¨‹åº¦ä¸Šçš„è§£è€¦ï¼Œæ¶ˆæ¯çš„å‘å‡ºè€…å¹¶ä¸éœ€è¦çŸ¥é“å…·ä½“çš„Conditionæ¡ä»¶æ˜¯æ€æ ·çš„ã€‚</p><pre><code class=\"language-plain\">    // åç¨‹A\n    c.L.Lock()\n    for !condition() {\n        c.Wait()\n    }\n    ...\n    c.L.Unlock()\n\n  \n   // åç¨‹B\n   ...\n   c.Broadcast()\n</code></pre><p>ä¸è¿‡ï¼Œåœ¨å®è·µä¸­å¹¶ä¸ç»å¸¸ä½¿ç”¨ <code>sync.Cond</code> ï¼Œå› ä¸ºåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨æ›´ä¸ºå¼ºå¤§çš„é€šé“ã€‚ä¸è¿‡ä¸ºäº†æ›´é€å½»åœ°è®²è§£ <code>sync.Cond</code>ï¼Œæˆ‘ä»¬å†æ¥çœ‹å‡ ä¸ªå¯èƒ½ä¼šç”¨åˆ° <code>sync.Cond</code> çš„ä¾‹å­ã€‚</p><p>ç¬¬ä¸€ä¸ªåœºæ™¯æ˜¯è¿™æ ·çš„ã€‚æˆ‘ä»¬è®¾è®¡çš„è¥é”€ç­–ç•¥å¸Œæœ›å½“åœ¨çº¿ç”¨æˆ·è¾¾åˆ°100äººä¹‹åï¼Œå¯¹å‰10ä½ç”¨æˆ·è¿›è¡Œå¥–åŠ±ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>è¿™é‡Œçš„åˆ¤æ–­æ¡ä»¶å°±æ˜¯ï¼Œç”¨æˆ·æ˜¯å¦è¾¾åˆ°100äººã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰è¾¾åˆ°100äººï¼Œæ‰§è¡Œå°±ä¼šé™·å…¥å µå¡ã€‚ è€Œå¦ä¸€ä¸ªç¨‹åºï¼Œæ¯ä¸ªç”¨æˆ·ä¸Šçº¿åéƒ½ä¼šå‘é€é€šçŸ¥ä¿¡å·ï¼Œå”¤é†’ç­‰å¾…çš„åç¨‹ã€‚</p><pre><code class=\"language-plain\">// åç¨‹A\ncond.L.Lock()\nfor len(users) &lt; 100 {\n    cond.Wait()\n}\ngivePrizes(users[:10])\ncond.L.Unlock()\n\n// åç¨‹B\ncond.L.Lock()\nusers = append(users, newUser)\ncond.L.Unlock()\ncond.Signal()\n</code></pre><p>å¦å¤–ï¼Œå¦‚æœç¨‹åºæ”¶åˆ°äº†ç»ˆæ­¢ä¿¡å·ï¼ˆä¾‹å¦‚å¼€å‘è€…æŒ‰ä¸‹äº†Ctrl+Cï¼‰, æˆ‘ä»¬ä¹Ÿå¸Œæœ›ç¨‹åºèƒ½å¤Ÿé€šçŸ¥æ‰€æœ‰åç¨‹å…³é—­èµ„æºå¹¶é€€å‡ºã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ åˆ¤æ–­æ¡ä»¶ï¼Œåªæœ‰å½“åœ¨çº¿ç”¨æˆ·å°äº100äººå¹¶ä¸”ç¨‹åºæ²¡æœ‰ç»ˆæ­¢æ—¶æ‰ä¼šé™·å…¥å µå¡ã€‚ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">cond.L.Lock()\nfor len(users) &lt; 100 &amp;&amp; !shutdown {\n    cond.Wait()\n}\nif shutdown {\n    cond.L.Unlock()\n    return\n}\ngivePrizes(users[:10])\ncond.L.Unlock()\n</code></pre><p><code>sync.Cond</code> æœ‰å µå¡ä¸å”¤é†’çš„è¯­ä¹‰ï¼Œå¹¶ä¸”å¯ä»¥å°†é€šçŸ¥è€…ä¸ç­‰å¾…è€…è§£è€¦ï¼Œé€šçŸ¥è€…ä¸å¿…çŸ¥é“å…·ä½“çš„æ¡ä»¶ç»†èŠ‚ï¼Œæ‰€ä»¥ç¨‹åºä¼šæ›´åŠ çµæ´»ã€‚å¦‚æœæˆ‘ä»¬é‡åˆ°äº†ç±»ä¼¼çš„åœºæ™¯ï¼Œå¯ä»¥åœ¨åˆé€‚çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>sync.Cond</code> ã€‚ ä¸è¿‡æˆ‘ä»¬ä¹Ÿè¦å°å¿ƒï¼Œä¸€æ—¦å¿˜è®°äº†é‡Šæ”¾é”æˆ–è€…å¿˜è®°äº†å”¤é†’åç¨‹ï¼Œ<code>sync.Cond</code> å¯èƒ½é‡åˆ°æ­»é”é—®é¢˜ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥å‚è€ƒGoæºç å¯¹ <code>sync.Cond</code> çš„ä½¿ç”¨ã€‚ä¾‹å¦‚<a href=\"https://github.com/golang/net/blob/28c70e62bb1d140c3f2579fb7bb5095134d9cb1e/http2/pipe.go\">Goåœ¨æ„å»ºå†…å­˜ç®¡é“æ—¶</a>ä½¿ç”¨äº† <code>sync.Cond</code>ã€‚å…¶ä¸­ï¼Œpipe.Readæ–¹æ³•ä¼šå¾ªç¯è¯»å–ç®¡é“ä¸­çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™é™·å…¥åˆ°ç­‰å¾…ä¸­ã€‚</p><pre><code class=\"language-plain\">func (p *pipe) Read(d []byte) (n int, err error) {\n\tp.mu.Lock()\n\tdefer p.mu.Unlock()\n\tfor {\n\t  ...\n\t\tif p.b != nil &amp;&amp; p.b.Len() &gt; 0 {\n\t\t\treturn p.b.Read(d)\n\t\t}\n\t\tp.c.Wait()\n\t}\n}\n</code></pre><p>è€Œ pipe.Write åˆ™ä¼šåœ¨ç®¡é“å¦ä¸€ç«¯å†™å…¥æ•°æ®åï¼Œå”¤é†’ç¬¬ä¸€ä¸ªç­‰å¾…è¯»å–çš„åç¨‹ã€‚</p><pre><code class=\"language-plain\">func (p *pipe) Write(d []byte) (n int, err error) {\n\tp.mu.Lock()\n\tdefer p.mu.Unlock()\n\tif p.c.L == nil {\n\t\tp.c.L = &amp;p.mu\n\t}\n\tdefer p.c.Signal()\n\tif p.err != nil {\n\t\treturn 0, errClosedPipeWrite\n\t}\n\tif p.breakErr != nil {\n\t\tp.unread += len(d)\n\t\treturn len(d), nil // discard when there is no reader\n\t}\n\treturn p.b.Write(d)\n}\n</code></pre><h2>Goå¹¶å‘æ¨¡å‹</h2><p>ä¹‹å‰æˆ‘ä»¬è®²äº†å¾ˆå¤šä¼ ç»Ÿçš„åŒæ­¥æ¨¡å¼ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®è·µä¸­å»åè°ƒåç¨‹æ—¶ï¼Œä½¿ç”¨å¾—æœ€å¤šçš„è¿˜æ˜¯é€šé“ã€‚ å°±åƒGoè¯­è¨€åœˆå­ä¸­çš„åè¨€æ‰€è¯´çš„é‚£æ ·ï¼š<strong>ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œé€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚</strong></p><p>é€šé“çš„å‰å®³ä¹‹å¤„åœ¨äºï¼Œåœ¨é€šä¿¡çš„è¿‡ç¨‹ä¸­å®Œæˆäº†æ•°æ®æ‰€æœ‰æƒçš„è½¬ç§»ã€‚æ•°æ®åªå¯èƒ½åœ¨æŸä¸€ä¸ªåç¨‹ä¸­æ‰§è¡Œï¼Œè¿™å°±åœ¨æ— å½¢ä¸­æ¶ˆé™¤äº†å¹¶å‘è®¿é—®æ•°æ®çš„é—®é¢˜ï¼Œæ•°æ®äº‰ç”¨é—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œä¾‹å¦‚é€šé“å†…éƒ¨ä»ç„¶éœ€è¦ä½¿ç”¨é”ï¼Œä½†Goè¯­è¨€å·²ç»ä¸ºæˆ‘ä»¬å±è”½äº†åº•å±‚é”å®ç°çš„ç»†èŠ‚ã€‚å€ŸåŠ©é€šé“ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›é€ å‡ºè®¸å¤šæœ‰è¡¨ç°åŠ›çš„é«˜å¹¶å‘æ¨¡å‹ã€‚</p><h3>ping-pongæ¨¡å¼</h3><p>ping-pongæ¨¡å¼å³ä¹’ä¹“çƒæ¨¡å¼ï¼Œå®ƒæ¯”è¾ƒå½¢è±¡åœ°å‘ˆç°äº†æ•°æ®ä¹‹é—´ä¸€æ¥ä¸€å›çš„å…³ç³»ã€‚æ”¶åˆ°æ•°æ®çš„åç¨‹å¯ä»¥åœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè€Œä¸å¿…æ‹…å¿ƒæœ‰å¹¶å‘å†²çªã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7e/57/7ec1514a0d294c7f0958d1e836370657.jpg?wh=1920x1412\" alt=\"å›¾ç‰‡\"></p><p>å®ä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ä¸¤ä¸ªåç¨‹playerå°±ç›¸å½“äºä¸¤ä¸ªçƒå‘˜ï¼Œè€Œé€šé“tableåˆ™ç±»ä¼¼äºçƒæ¡Œã€‚</p><pre><code class=\"language-plain\">func main(){\n\n\tvar Ball int\n\n\ttable:= make(chan int)\n\n\tgo player(table)\n\tgo player(table)\n\n\ttable&lt;-Ball\n\n\ttime.Sleep(1*time.Second)\n\t&lt;-table\n\n}\nfunc player(table chan int) {\n\tfor{\n\t\tball:=&lt;-table\n\t\tball++\n\t\ttime.Sleep(100*time.Millisecond)\n\t\ttable&lt;-ball\n\t}\n}\n</code></pre><p>ä½ å¯ä»¥æƒ³ä¸€æƒ³ï¼Œå¦‚æœæˆ‘ä»¬æŠŠä¸¤ä¸ª player æ‰©å±•ä¸ºå¤šä¸ª playerï¼Œæ˜¯ä¸æ˜¯å°±æœ‰ç‚¹åƒå¾ˆå¤šäººåœ¨è¸¢æ¯½å­äº†ã€‚å½“æˆ‘ä»¬é‡åˆ°ç±»å‹çš„é—®é¢˜ï¼Œå¯ä»¥ç”¨è¿™ä¸€ç®€å•çš„æ¨¡å¼æ¥è¿›è¡ŒæŠ½è±¡ã€‚</p><h3>fan-in æ¨¡å¼</h3><p>fan-inæ¨¡å¼åˆå«æ‰‡å…¥æ¨¡å¼ï¼Œæ„æ€æ˜¯å¤šä¸ªåç¨‹æŠŠæ•°æ®å†™å…¥åˆ°é€šé“ä¸­ï¼Œä½†åªæœ‰ä¸€ä¸ªåç¨‹ç­‰å¾…è¯»å–é€šé“æ•°æ®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/28/a9cc4213619ed3bedc6a660a6fe4bc28.jpg?wh=1920x1242\" alt=\"å›¾ç‰‡\"></p><p>è¿™ç§æ¨¡å¼åœ¨å®è·µä¸­æœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æƒ³æŸ¥æ‰¾æŸä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­æœ‰æ²¡æœ‰ç‰¹æ®Šçš„å…³é”®å­—ã€‚å½“æ–‡ä»¶æ•°é‡å¾ˆå¤šæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¹¶å‘çš„æ–¹å¼å»æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ç»“æœåè¾“å‡ºåˆ°ç›¸åŒçš„é€šé“ä¸­æ‰“å°å‡ºæ¥ã€‚</p><pre><code class=\"language-plain\">func search(ch chan string, msg string) {\n\tvar i int\n\tfor {\n    // æ¨¡æ‹Ÿæ‰¾åˆ°äº†å…³é”®å­—\n\t\tch &lt;- fmt.Sprintf(\"get %s %d\", msg, i)\n\t\ti++\n\t\ttime.Sleep(1000 * time.Millisecond)\n\t}\n}\n\nfunc main() {\n\tch := make(chan string)\n\tgo search(ch, \"jonson\")\n\tgo search(ch, \"olaya\")\n\n\tfor i := range ch {\n\t\tfmt.Println(i)\n\t}\n}\n</code></pre><p>ä¸è¿‡ï¼Œfan-inæ¨¡å¼åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¹¶ä¸æ€»æ˜¯åªæœ‰ä¸€ä¸ªé€šé“ã€‚å®ƒä¹Ÿå¯ä»¥åŒæ—¶è¯»å–å¤šä¸ªé€šé“çš„å†…å®¹ï¼Œä»¥å¤šè·¯å¤ç”¨çš„å½¢å¼å­˜åœ¨ã€‚è®©æˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­æ”¹é€ ä¸€ä¸‹ï¼Œç°åœ¨searchå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæ–°çš„é€šé“ï¼Œå¹¶æ–°å»ºåç¨‹æŠŠæ•°æ®å†™å…¥åˆ°è¿™ä¸ªé€šé“ä¸­ã€‚åœ¨è¯»å–æ•°æ®æ—¶ï¼Œæˆ‘ä»¬è¦ç›‘å¬ch1ã€ch2ä¸¤ä¸ªåç¨‹ï¼Œå¹¶ä½¿ç”¨selectæ¥å®ç°å¤šè·¯å¤ç”¨ã€‚</p><pre><code class=\"language-plain\">func search(msg string) chan string {\n\tvar ch = make(chan string)\n\tgo func() {\n\t\tvar i int\n\t\tfor {\n\t\t\tch &lt;- fmt.Sprintf(\"get %s %d\", msg, i)\n\t\t\ti++\n\t\t\ttime.Sleep(100 * time.Millisecond)\n\t\t}\n\t}()\n\treturn ch\n}\n\nfunc main() {\n\tch1 := search(\"jonson\")\n\tch2 := search(\"olaya\")\n\n\tfor {\n\t\tselect {\n\t\tcase msg := &lt;-ch1:\n\t\t\tfmt.Println(msg)\n\t\tcase msg := &lt;-ch2:\n\t\t\tfmt.Println(msg)\n\t\t}\n\t}\n}\n</code></pre><p>fan-inæ¨¡å¼æ¯”è¾ƒæ¸…æ™°ï¼Œåœ¨å®é™…ä¸­ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¹‹ååœ¨é¡¹ç›®ä¸­ä¼šçœ‹åˆ°ï¼Œé€šè¿‡fan-inæ¨¡å¼æ¥æ•´åˆçˆ¬å–åˆ°çš„æ•°æ®ï¼Œå¹¶å­˜å‚¨èµ·æ¥ã€‚</p><h3>fan-out æ¨¡å¼</h3><p>fan-outæ¨¡å¼ä¸fan-inæ¨¡å¼ç›¸åï¼Œå®ƒæè¿°çš„æ˜¯ä¸€ä¸ªåç¨‹å®Œæˆæ•°æ®çš„å†™å…¥ï¼Œä½†æ˜¯å¤šä¸ªåç¨‹æŠ¢å¤ºåŒä¸€ä¸ªé€šé“ä¸­çš„æ•°æ®çš„åœºæ™¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e3/84/e335ba2984438618a5f51a44342de084.jpg?wh=1920x1242\" alt=\"å›¾ç‰‡\"></p><p><strong>Fan-outæ¨¡å¼é€šå¸¸ä¼šç”¨åœ¨ä»»åŠ¡çš„åˆ†é…ä¸­ã€‚</strong>æ¯”æ–¹è¯´ï¼Œç¨‹åºæ¶ˆè´¹Kafkaã€NATSç­‰ä¸­é—´ä»¶çš„æ•°æ®ï¼Œå¤šä¸ªåç¨‹å°±ä¼šç›‘å¬åŒä¸€ä¸ªé€šé“ä¸­çš„æ•°æ®ï¼Œè¯»åˆ°æ•°æ®åç«‹å³è¿›è¡Œåç»­çš„å¤„ç†ï¼Œå¤„ç†å®Œæ¯•åå†ç»§ç»­è¯»å–ï¼Œå¾ªç¯å¾€å¤ã€‚</p><p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ã€‚å¤šä¸ªWorkerç›‘å¬åŒä¸€ä¸ªåç¨‹ï¼Œè€Œ <code>tasksCh &lt;- i</code> ä¼šæŠŠä»»åŠ¡åˆ†é…åˆ°Workerä¸­å»ã€‚fan-outæ¨¡å¼ä½¿ Worker å¾—åˆ°äº†å……åˆ†çš„åˆ©ç”¨ï¼Œå¹¶ä¸”ä»»åŠ¡çš„åˆ†é…ä¹Ÿå®ç°äº†è´Ÿè½½å‡è¡¡ï¼Œå“ªä¸€ä¸ª Worker é—²ä¸‹æ¥äº†å°±ä¼šè‡ªåŠ¨å»é¢†å–æ–°çš„ä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œç¤ºä¾‹ä»£ç ä¸­çš„ sync.WaitGroup åªæ˜¯ä¸ºäº†é˜²æ­¢mainå‡½æ•°æå‰é€€å‡ºï¼‰ï¼š</p><pre><code class=\"language-plain\">func worker(tasksCh &lt;-chan int, wg *sync.WaitGroup) {\n\tdefer wg.Done()\n\tfor {\n\t\ttask, ok := &lt;-tasksCh\n\t\tif !ok {\n\t\t\treturn\n\t\t}\n\t\td := time.Duration(task) * time.Millisecond\n\t\ttime.Sleep(d)\n\t\tfmt.Println(\"processing task\", task)\n\t}\n}\n\nfunc pool(wg *sync.WaitGroup, workers, tasks int) {\n\ttasksCh := make(chan int)\n\n\tfor i := 0; i &lt; workers; i++ {\n\t\tgo worker(tasksCh, wg)\n\t}\n\n\tfor i := 0; i &lt; tasks; i++ {\n\t\ttasksCh &lt;- i\n\t}\n\n\tclose(tasksCh)\n}\n\nfunc main() {\n\tvar wg sync.WaitGroup\n\twg.Add(36)\n\tgo pool(&amp;wg, 36, 50)\n\twg.Wait()\n}\n</code></pre><p>åœ¨ç”Ÿäº§å®è·µä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­çš„åŸºç¡€ä¸Šæ„å»ºå‡ºæ›´å¤æ‚çš„æ¨¡å‹ï¼Œä¾‹å¦‚æ¯ä¸€ä¸ªWorkerä¸­è¿˜å¯ä»¥åˆ†å‡ºå¤šä¸ªSubwokerã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/77/75/77f551c2e5040bf455eb6d9f16bb5d75.jpg?wh=1920x1027\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å°è¯•åœ¨å‰ä¾‹çš„åŸºç¡€ä¸Šæ„å»ºå‡ºå…·æœ‰Subworkerçš„å¹¶å‘æ¨¡å¼ã€‚</p><p>å¦‚ä¸‹æ‰€ç¤ºï¼ŒWorkerä¹Ÿå˜æˆäº†ç±»ä¼¼è°ƒåº¦çš„æ¨¡å¼ï¼ŒWorkeråˆ›å»ºå‡ºäº†å¤šä¸ªSubworkerçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶é€šè¿‡subtasks &lt;- task1å°†ä»»åŠ¡åˆ†å‘åˆ°äº†Subworkerä¸­ã€‚</p><pre><code class=\"language-plain\">const (\n\tWORKERS    = 5\n\tSUBWORKERS = 3\n\tTASKS      = 20\n\tSUBTASKS   = 10\n)\n\nfunc subworker(subtasks chan int) {\n\tfor {\n\t\ttask, ok := &lt;-subtasks\n\t\tif !ok {\n\t\t\treturn\n\t\t}\n\t\ttime.Sleep(time.Duration(task) * time.Millisecond)\n\t\tfmt.Println(task)\n\t}\n}\n\nfunc worker(tasks &lt;-chan int, wg *sync.WaitGroup) {\n\tdefer wg.Done()\n\tfor {\n\t\ttask, ok := &lt;-tasks\n\t\tif !ok {\n\t\t\treturn\n\t\t}\n\n\t\tsubtasks := make(chan int)\n\t\tfor i := 0; i &lt; SUBWORKERS; i++ {\n\t\t\tgo subworker(subtasks)\n\t\t}\n\t\tfor i := 0; i &lt; SUBTASKS; i++ {\n\t\t\ttask1 := task * i\n\t\t\tsubtasks &lt;- task1\n\t\t}\n\t\tclose(subtasks)\n\t}\n}\n\nfunc main() {\n\tvar wg sync.WaitGroup\n\twg.Add(WORKERS)\n\ttasks := make(chan int)\n\n\tfor i := 0; i &lt; WORKERS; i++ {\n\t\tgo worker(tasks, &amp;wg)\n\t}\n\n\tfor i := 0; i &lt; TASKS; i++ {\n\t\ttasks &lt;- i\n\t}\n\n\tclose(tasks)\n\twg.Wait()\n}\n</code></pre><h3>pipelineæ¨¡å¼</h3><p>pipelineæ¨¡å¼å³ç®¡é“æ¨¡å¼ï¼ŒæŒ‡çš„æ˜¯ç”±é€šé“è¿æ¥çš„ä¸€ç³»åˆ—è¿ç»­çš„é˜¶æ®µï¼Œä»¥ç±»ä¼¼æµçš„å½¢å¼è¿›è¡Œè®¡ç®—ã€‚æ¯ä¸ªé˜¶æ®µæ˜¯ä¸€ç»„æ‰§è¡Œç‰¹å®šä»»åŠ¡çš„åç¨‹ï¼Œæ¯ä¸ªé˜¶æ®µçš„åç¨‹éƒ½ä¼šé€šè¿‡é€šé“è·å–ä»ä¸Šæ¸¸ä¼ é€’è¿‡æ¥çš„å€¼ï¼Œç»è¿‡å¤„ç†åï¼Œå†æŠŠæ–°çš„å€¼å‘é€ç»™ä¸‹æ¸¸ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/97/f8/974340f7b922112b8eeyy9605ee381f8.jpg?wh=1920x428\" alt=\"å›¾ç‰‡\"></p><p>å…¶å®æˆ‘ä»¬å¹³æ—¶çš„å››åˆ™è¿ç®—å°±å¾ˆåƒä¸€ä¸ªç®¡é“ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è¦è®¡ç®— 2*(2*number+1) è¿™ä¸²æ•°å­—å°±å¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼å®ç°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œ<code>multiply(v, 2)</code> é¦–å…ˆè¢«è®¡ç®—å‡ºæ¥ï¼Œè®¡ç®—çš„ç»“æœä¼šç´§æ¥ç€è¢«é€å…¥addå‡½æ•°ä¸­æ‰§è¡ŒåŠ 1æ“ä½œã€‚ä¹‹åï¼Œç”Ÿæˆçš„ç»“æœå°†ç»§ç»­ä½œä¸ºmultiplyå‡½æ•°çš„å‚æ•°è¢«å¤„ç†ã€‚</p><pre><code class=\"language-plain\">func main() {\n\tmultiply := func(value, multiplier int) int {\n\t\treturn value * multiplier\n\t}\n\n\tadd := func(value, additive int) int {\n\t\treturn value + additive\n\t}\n\n\tints := []int{1, 2, 3, 4}\n\tfor _, v := range ints {\n\t\tfmt.Println(multiply(add(multiply(v, 2), 1), 2))\n\t}\n}\n</code></pre><p>ã€ŠConcurrency in Goã€‹ è¿™æœ¬ä¹¦ä¸­ç»™å‡ºäº†å°†ä¸Šä¾‹çš„ç®—æœ¯æ“ä½œè½¬æ¢ä¸ºpipelineæ¨¡å¼çš„ä¾‹å­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬æ¢³ç†ä¸€ä¸‹è¿™æ®µä»£ç ã€‚</p><p>åœ¨è¿™é‡Œï¼Œgeneratorã€multiplyã€addæ˜¯ä¸‰ä¸ªå‡½æ•°ï¼Œä»£è¡¨ç®¡é“çš„ä¸åŒé˜¶æ®µã€‚æ¯ä¸ªé˜¶æ®µä¼šè¿”å›ä¸€ä¸ªé€šé“ä¾›ä¸‹ä¸€ä¸ªé˜¶æ®µæ¶ˆè´¹ã€‚å…¶ä¸­ï¼Œmultiplyä»£è¡¨ä¹˜æ³•æ“ä½œï¼›addä»£è¡¨åŠ æ³•æ“ä½œ ï¼›generatoræ˜¯ç®¡é“çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œä»£è¡¨æ•°æ®çš„äº§ç”Ÿã€‚è€Œåœ¨ä»£ç çš„æœ€åï¼Œ<code>for v := range pipeline</code> ä»£è¡¨ç®¡é“çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œæ¶ˆè´¹æœ€åäº§ç”Ÿçš„ç»“æœã€‚é€šé“ done åˆ™æ˜¯ä¸ºäº†å®ç°åç¨‹çš„é€€å‡ºè€Œè®¾è®¡çš„ã€‚</p><pre><code class=\"language-plain\">func main() {\n\tgenerator := func(done &lt;-chan interface{}, integers ...int) &lt;-chan int {\n\t\tintStream := make(chan int)\n\t\tgo func() {\n\t\t\tdefer close(intStream)\n\t\t\tfor _, i := range integers {\n\t\t\t\tselect {\n\t\t\t\tcase &lt;-done:\n\t\t\t\t\treturn\n\t\t\t\tcase intStream &lt;- i:\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t\treturn intStream\n\t}\n\n\tmultiply := func(\n\t\tdone &lt;-chan interface{},\n\t\tintStream &lt;-chan int,\n\t\tmultiplier int,\n\t) &lt;-chan int {\n\t\tmultipliedStream := make(chan int)\n\t\tgo func() {\n\t\t\tdefer close(multipliedStream)\n\t\t\tfor i := range intStream {\n\t\t\t\tselect {\n\t\t\t\tcase &lt;-done:\n\t\t\t\t\treturn\n\t\t\t\tcase multipliedStream &lt;- i * multiplier:\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t\treturn multipliedStream\n\t}\n\n\tadd := func(\n\t\tdone &lt;-chan interface{},\n\t\tintStream &lt;-chan int,\n\t\tadditive int,\n\t) &lt;-chan int {\n\t\taddedStream := make(chan int)\n\t\tgo func() {\n\t\t\tdefer close(addedStream)\n\t\t\tfor i := range intStream {\n\t\t\t\tselect {\n\t\t\t\tcase &lt;-done:\n\t\t\t\t\treturn\n\t\t\t\tcase addedStream &lt;- i + additive:\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t\treturn addedStream\n\t}\n\n\tdone := make(chan interface{})\n\tdefer close(done)\n\n\tintStream := generator(done, 1, 2, 3, 4)\n\tpipeline := multiply(done, add(done, multiply(done, intStream, 2), 1), 2)\n\n\tfor v := range pipeline {\n\t\tfmt.Println(v)\n\t}\n}\n</code></pre><p>åœ¨ç®¡é“ä¸­è¿˜æœ‰ä¸€ä¸ªç»å…¸çš„æ¡ˆä¾‹ï¼šæ±‚ç´ æ•°ã€‚å¯¹äºä¸€ä¸ªå¤§äº1çš„è‡ªç„¶æ•°ï¼Œé™¤äº†1å’Œå®ƒè‡ªèº«å¤–ï¼Œä¸èƒ½è¢«å…¶ä»–è‡ªç„¶æ•°æ•´é™¤çš„æ•°å°±å«åšç´ æ•°ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆåˆ©ç”¨ç®¡é“æ¥è®¡ç®—å‰1ä¸‡ä¸ªç´ æ•°å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ç®¡é“çš„æ¯ä¸€ä¸ªé˜¶æ®µéƒ½è¿›è¡Œç­›é€‰ã€‚ç¬¬ä¸€ä¸ªé˜¶æ®µä¸ºæ•°å­—çš„ç”Ÿæˆå™¨ï¼Œç¬¬äºŒä¸ªé˜¶æ®µæˆ‘ä»¬é¦–å…ˆæ‰¾åˆ°ç¬¬1ä¸ªç´ æ•°2ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µè¿‡æ»¤å‡ºæ‰€æœ‰èƒ½å¤Ÿè¢«2æ•´é™¤çš„æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±è¿‡æ»¤å‡ºäº† 4ã€6ã€8 ç­‰å¶æ•°ã€‚è¿™æ ·æˆ‘ä»¬ä¹Ÿå°±èƒ½æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸èƒ½è¢«2æ•´é™¤çš„æ•°å­—3ï¼Œå¯ä»¥æ¨æ–­å‡ºå®ƒä¸€å®šæ˜¯ç´ æ•°ã€‚å› æ­¤ç¬¬ä¸‰ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬è¦æ’é™¤æ‰€æœ‰èƒ½å¤Ÿè¢«3æ•´é™¤çš„æ•°å­—ï¼Œè¿™æ ·å°±èƒ½å¤Ÿæ’é™¤9ã€15ç­‰æ•°å­—ï¼Œè€Œä¸‹ä¸€ä¸ªä¸èƒ½è¢«3æ•´é™¤çš„æ•°æ˜¯5ï¼Œå®ƒä¹Ÿä¸€å®šæ˜¯ç´ æ•°ã€‚æŠŠå®ƒä½œä¸ºç¬¬å››ä¸ªé˜¶æ®µç­›é€‰çš„ä¾æ®ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b3/be/b3a0877c44cb343c77f0f08d887cdebe.jpg?wh=1920x1242\" alt=\"å›¾ç‰‡\"></p><p>è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬è¦æ€ä¹ˆç”¨ä»£ç å®ç°å‘¢ï¼Ÿè¿™æ®µä»£ç éå¸¸å·§å¦™ï¼Œæˆ‘å»ºè®®ä½ ç»†ç»†å“å‘³ä¸€ä¸‹ï¼š</p><pre><code class=\"language-plain\">// ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œæ•°å­—çš„ç”Ÿæˆå™¨\nfunc Generate(ch chan&lt;- int) {\n\tfor i := 2; ; i++ {\n\t\tch &lt;- i // Send 'i' to channel 'ch'.\n\t}\n}\n\n// ç­›é€‰ï¼Œæ’é™¤ä¸èƒ½å¤Ÿè¢«primeæ•´é™¤çš„æ•°\nfunc Filter(in &lt;-chan int, out chan&lt;- int, prime int) {\n\tfor {\n\t\ti := &lt;-in // è·å–ä¸Šä¸€ä¸ªé˜¶æ®µçš„\n\t\tif i%prime != 0 {\n\t\t\tout &lt;- i // Send 'i' to 'out'.\n\t\t}\n\t}\n}\n\nfunc main() {\n\tch := make(chan int) \n\tgo Generate(ch)     \n\tfor i := 0; i &lt; 100000; i++ {\n\t\tprime := &lt;-ch  // è·å–ä¸Šä¸€ä¸ªé˜¶æ®µè¾“å‡ºçš„ç¬¬ä¸€ä¸ªæ•°ï¼Œå…¶å¿…ç„¶ä¸ºç´ æ•°\n\t\tfmt.Println(prime)\n\t\tch1 := make(chan int)\n\t\tgo Filter(ch, ch1, prime)\n\t\tch = ch1 // å‰ä¸€ä¸ªé˜¶æ®µçš„è¾“å‡ºä½œä¸ºåä¸€ä¸ªé˜¶æ®µçš„è¾“å…¥ã€‚\n\t}\n}\n</code></pre><p>å‰é¢æˆ‘ä»¬è®²è§£äº†è®¸å¤šç»å…¸çš„å¹¶å‘æ¨¡å‹ã€‚å®é™…ä¸Šï¼Œå……æ»¡åˆ›æ„çš„å¹¶å‘æ¨¡å¼è¿˜æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚ or-channelæ¨¡å¼ã€or-done-channelæ¨¡å¼ã€tee-channelæ¨¡å¼ã€bridge-channelæ¨¡å¼ç­‰ã€‚åœ¨å®é™…ç”Ÿäº§ä¸­ä¹Ÿå¯èƒ½å­˜åœ¨å¤šç§æ¨¡å‹çš„ç»„åˆã€‚å—åˆ°ç¯‡å¹…é™åˆ¶æˆ‘å°±ä¸å†åšè¿‡å¤šè®²è§£äº†ï¼Œå¦‚æœä½ å¯¹è¿™æ–¹é¢æœ‰å…´è¶£ä¹Ÿå¯ä»¥ç»§ç»­æ·±æŒ–ï¼Œç›¸ä¿¡ä¸€å®šä¼šæœ‰æ‰€å¯å‘ã€‚</p><h2>å¹¶å‘æ£€æµ‹</h2><p>Go 1.1 ç‰ˆæœ¬ä¹‹åæä¾›äº†å¼ºå¤§çš„æ£€æŸ¥å·¥å…· race æ¥æ’æŸ¥æ•°æ®äº‰ç”¨é—®é¢˜ã€‚race å¯ä»¥è¢«ç”¨åœ¨å¤šä¸ª Go æŒ‡ä»¤ä¸­ï¼Œå½“æ£€æµ‹å™¨åœ¨ç¨‹åºä¸­æ‰¾åˆ°æ•°æ®äº‰ç”¨æ—¶ï¼Œä¼šæ‰“å°æŠ¥å‘Šã€‚è¿™ä¸ªæŠ¥å‘Šä¼šåŒ…å«å‘ç”Ÿ race å†²çªçš„åç¨‹æ ˆï¼Œä»¥åŠæ­¤æ—¶æ­£åœ¨è¿è¡Œçš„åç¨‹æ ˆã€‚</p><pre><code class=\"language-plain\">$ go test -race mypkg\n$ go run -race mysrc.go\n$ go build -race mycmd\n$ go install -race mypkg\n</code></pre><p>æˆ‘åœ¨åé¢çš„è¯¾ç¨‹ä¸­è¿˜ä¼šä»‹ç»raceçš„ç”¨æ³•ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œè¿™èŠ‚è¯¾çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæ€»ç»“ä¸€ä¸‹ã€‚</p><p>å¹¶å‘åç¨‹é—´çš„æ•°æ®é€šä¿¡è®©æˆ‘ä»¬ä¸å¾—ä¸è€ƒè™‘å¹¶å‘å®‰å…¨çš„é—®é¢˜ã€‚è§£å†³è¿™ä¸€é—®é¢˜çš„æ–¹å¼æœ‰å¾ˆå¤šã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„åŒæ­¥æ‰‹æ®µï¼Œä¾‹å¦‚åŸå­é”ã€äº’æ–¥é”ã€è¯»å†™é”ï¼Œæˆ–è€…æ˜¯syncæ ‡å‡†åº“ä¸­çš„sync.Onceã€sync.Condã€sync.WaitGroupå·¥å…·ã€‚å½“ç„¶ï¼Œåœ¨Goè¯­è¨€ä¸­ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯é€šé“ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©é€šé“æ¥å®ç°ä¸éœ€è¦åŠ é”çš„å¹¶å‘æ¨¡å‹ï¼Œä¾‹å¦‚fan-inã€fan-outã€pipelineç­‰ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚è¿›è¡Œçµæ´»çš„ç»„åˆã€‚</p><h2>è¯¾åé¢˜</h2><p>å­¦å®Œè¿™èŠ‚è¯¾ï¼Œè¯·ä½ æ€è€ƒä¸‹é¢è¿™ä¸ªé—®é¢˜ï¼š</p><p>ä½ è®¤ä¸ºä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨é”ï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨é€šé“ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>","neighbors":{"left":{"article_title":"25 | è¿ç­¹å¸·å¹„: åç¨‹çš„è¿è¡Œæœºåˆ¶ä¸è°ƒåº¦å™¨åŸç†","id":610599},"right":{"article_title":"27ï½œæ˜åœ°ä¸‰å°ºï¼šå®æˆ˜æ·±åº¦ä¸å¹¿åº¦ä¼˜å…ˆæœç´¢ç®—æ³•","id":612328}},"comments":[{"had_liked":false,"id":364955,"user_name":"Geek_c16d38","can_delete":false,"product_type":"c1","uid":2726606,"ip_address":"ä¸­å›½å°æ¹¾","ucode":"A8B1EB366FCD98","user_header":"","comment_is_top":false,"comment_ctime":1671781544,"is_pvip":false,"replies":[{"id":134141,"content":"ğŸ‘Œ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1903914,"ctime":1676216702,"ip_address":"åŒ—äº¬","comment_id":364955,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"\nfunc worker(tasksCh &lt;-chan int, wg *sync.WaitGroup) {\n  defer wg.Done()\n  for {\n    task, ok := &lt;-tasksCh\n    if !ok {\n      return\n    }\n    d := time.Duration(task) * time.Millisecond\n    time.Sleep(d)\n    fmt.Println(&quot;processing task&quot;, task)\n  }\n}\n\nfunc pool(wg *sync.WaitGroup, workers, tasks int) {\n  tasksCh := make(chan int)\n\n  for i := 0; i &lt; workers; i++ {\n    go c(tasksCh, wg)\n  }\n\n  for i := 0; i &lt; tasks; i++ {\n    tasksCh &lt;- i\n  }\n\n  close(tasksCh)\n}\n\nfunc main() {\n  var wg sync.WaitGroup\n  wg.Add(36)\n  go pool(&amp;wg, 36, 50)\n  wg.Wait()\n}\n\né€™å€‹go céŒ¯äº†è¦ä¿®æ­£","like_count":0,"discussions":[{"author":{"id":1903914,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0d/2a/dcb935cf.jpg","nickname":"æ—¶é—´ä¸ºæˆ‘ä»¬è¯æ˜","note":"","ucode":"299438152D9F3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603465,"discussion_content":"ğŸ‘Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676216702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1903914,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0d/2a/dcb935cf.jpg","nickname":"æ—¶é—´ä¸ºæˆ‘ä»¬è¯æ˜","note":"","ucode":"299438152D9F3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603464,"discussion_content":"å¥½çš„ğŸ‘Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676216611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":364092,"user_name":"Realm","can_delete":false,"product_type":"c1","uid":1081299,"ip_address":"æµ™æ±Ÿ","ucode":"30CBEBE619D1A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg","comment_is_top":false,"comment_ctime":1670511448,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"æ•°æ®éœ€è¦ä¼ é€’çš„æ—¶å€™ç”¨channelï¼›\næ•°æ®ä¸åŠ¨çš„æ—¶å€™ï¼Œå¦‚è·å–ã€ä¿®æ”¹çŠ¶æ€ï¼Œç”¨é”ï¼›","like_count":6},{"had_liked":false,"id":366160,"user_name":"konyo","can_delete":false,"product_type":"c1","uid":1222996,"ip_address":"æ±Ÿè‹","ucode":"51DF79A52336B4","user_header":"https://static001.geekbang.org/account/avatar/00/12/a9/54/76b680bc.jpg","comment_is_top":false,"comment_ctime":1673428368,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"æœ€åçš„ä¾‹å­å¥½éš¾æ‡‚å•Š","like_count":0},{"had_liked":false,"id":364035,"user_name":"shuff1e","can_delete":false,"product_type":"c1","uid":1756280,"ip_address":"åŒ—äº¬","ucode":"85601271951B5A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep075ibtmxMf3eOYlBJ96CE9TEelLUwePaLqp8M75gWHEcM3za0voylA0oe9y3NiaboPB891rypRt7w/132","comment_is_top":false,"comment_ctime":1670466704,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100124001,"comment_content":"func pool(wg *sync.WaitGroup, workers, tasks int) { tasksCh := make(chan int) for i := 0; i &lt; workers; i++ { go c(tasksCh, wg) } for i := 0; i &lt; tasks; i++ { tasksCh &lt;- i } close(tasksCh)}\n\ngo cæ”¹æˆgo workerï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1903914,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0d/2a/dcb935cf.jpg","nickname":"æ—¶é—´ä¸ºæˆ‘ä»¬è¯æ˜","note":"","ucode":"299438152D9F3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603463,"discussion_content":"å¥½çš„ğŸ‘Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676216606,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}