{"id":426789,"title":"16 | æ•°æ®è½¬æ¢ï¼šå¦‚ä½•åœ¨DataFrameä¹‹ä¸Šåšæ•°æ®å¤„ç†ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬å­¦ä¹ äº†åˆ›å»ºDataFrameçš„å„ç§é€”å¾„ä¸æ–¹æ³•ï¼Œé‚£ä¹ˆï¼Œæœ‰äº†DataFrameä¹‹åï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åœ¨DataFrameä¹‹ä¸Šåšæ•°æ®æ¢ç´¢ã€æ•°æ®åˆ†æï¼Œä»¥åŠå„å¼å„æ ·çš„æ•°æ®è½¬æ¢å‘¢ï¼Ÿåœ¨æ•°æ®å¤„ç†å®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•åšæ•°æ®å±•ç¤ºä¸æ•°æ®æŒä¹…åŒ–å‘¢ï¼Ÿä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±æ¥è§£ç­”è¿™äº›ç–‘é—®ã€‚</p><p>ä¸ºäº†ç»™å¼€å‘è€…æä¾›è¶³å¤Ÿçš„çµæ´»æ€§ï¼Œå¯¹äºDataFrameä¹‹ä¸Šçš„æ•°æ®å¤„ç†ï¼ŒSpark SQLæ”¯æŒä¸¤ç±»å¼€å‘å…¥å£ï¼šä¸€ä¸ªæ˜¯å¤§å®¶æ‰€ç†ŸçŸ¥çš„ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼šSQLï¼Œå¦ä¸€ç±»æ˜¯DataFrameå¼€å‘ç®—å­ã€‚å°±å¼€å‘æ•ˆç‡ä¸æ‰§è¡Œæ•ˆç‡æ¥è¯´ï¼ŒäºŒè€…å¹¶æ— ä¼˜åŠ£ä¹‹åˆ†ï¼Œé€‰æ‹©å“ªç§å¼€å‘å…¥å£ï¼Œå®Œå…¨å–å†³äºå¼€å‘è€…çš„ä¸ªäººåå¥½ä¸å¼€å‘ä¹ æƒ¯ã€‚</p><p>ä¸RDDç±»ä¼¼ï¼ŒDataFrameæ”¯æŒç§ç±»ç¹å¤šçš„å¼€å‘ç®—å­ï¼Œä½†ç›¸æ¯”SQLè¯­è¨€ï¼ŒDataFrameç®—å­çš„å­¦ä¹ æˆæœ¬ç›¸å¯¹è¦é«˜ä¸€äº›ã€‚å› æ­¤ï¼Œæœ¬ç€å…ˆæ˜“åéš¾çš„æ€è·¯ï¼Œå’±ä»¬å…ˆæ¥è¯´è¯´DataFrameä¸­SQLè¯­å¥çš„ç”¨æ³•ï¼Œç„¶åå†å»ç†è§£DataFrameå¼€å‘ç®—å­ã€‚</p><h2>SQLè¯­å¥</h2><p>å¯¹äºä»»æ„çš„DataFrameï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨createTempViewæˆ–æ˜¯createGlobalTempViewåœ¨Spark SQLä¸­åˆ›å»ºä¸´æ—¶æ•°æ®è¡¨ã€‚</p><p>ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼ŒcreateTempViewåˆ›å»ºçš„ä¸´æ—¶è¡¨ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸä»…é™äºSparkSessionå†…éƒ¨ï¼Œè€ŒcreateGlobalTempViewåˆ›å»ºçš„ä¸´æ—¶è¡¨ï¼Œå¯ä»¥åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­è·¨SparkSessionæä¾›è®¿é—®ã€‚æœ‰äº†ä¸´æ—¶è¡¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨SQLè¯­å¥çµæ´»åœ°å€’è…¾è¡¨æ•°æ®ã€‚</p><!-- [[[read_end]]] --><p>é€šè¿‡åé¢è¿™æ®µä»£ç ï¼Œæˆ‘ä¸ºä½ æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨createTempViewåˆ›å»ºä¸´æ—¶è¡¨ã€‚æˆ‘ä»¬é¦–å…ˆç”¨toDFåˆ›å»ºäº†ä¸€ä¸ªåŒ…å«åå­—å’Œå¹´é¾„çš„DataFrameï¼Œç„¶åè°ƒç”¨createTempViewæ–¹æ³•åˆ›å»ºäº†ä¸´æ—¶è¡¨ã€‚</p><pre><code class=\"language-scala\">import org.apache.spark.sql.DataFrame\nimport spark.implicits._\n&nbsp;\nval seq = Seq((\"Alice\", 18), (\"Bob\", 14))\nval df = seq.toDF(\"name\", \"age\")\n&nbsp;\ndf.createTempView(\"t1\")\nval query: String = \"select * from t1\"\n// sparkä¸ºSparkSessionå®ä¾‹å¯¹è±¡\nval result: DataFrame = spark.sql(query)\n&nbsp;\nresult.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+-----+---+\n| n ame| age|\n+-----+---+\n| Alice| 18|\n| Bob| 14|\n+-----+---+\n*/\n</code></pre><p>ä»¥ä¸Šè¡¨ä¸ºä¾‹ï¼Œæˆ‘ä»¬å…ˆæ˜¯ä½¿ç”¨spark.implicits._éšå¼æ–¹æ³•é€šè¿‡toDFæ¥åˆ›å»ºDataFrameï¼Œç„¶ååœ¨å…¶ä¸Šè°ƒç”¨createTempViewæ¥åˆ›å»ºä¸´æ—¶è¡¨â€œt1â€ã€‚æ¥ä¸‹æ¥ï¼Œç»™å®šSQLæŸ¥è¯¢è¯­å¥â€œqueryâ€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨SparkSessionæä¾›çš„sql APIæ¥æè¯·æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼Œå¾—åˆ°çš„æŸ¥è¯¢ç»“æœè¢«å°è£…ä¸ºæ–°çš„DataFrameã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸RDDçš„å¼€å‘æ¨¡å¼ä¸€æ ·ï¼Œ<strong>DataFrameä¹‹é—´çš„è½¬æ¢ä¹Ÿå±äºå»¶è¿Ÿè®¡ç®—ï¼Œå½“ä¸”ä»…å½“å‡ºç°Actionç±»ç®—å­æ—¶ï¼Œå¦‚ä¸Šè¡¨ä¸­çš„showï¼Œæ‰€æœ‰ä¹‹å‰çš„è½¬æ¢è¿‡ç¨‹æ‰ä¼šäº¤ä»˜æ‰§è¡Œ</strong>ã€‚</p><p>Spark SQLé‡‡ç”¨<a href=\"https://www.antlr.org/\">ANTLR</a>è¯­æ³•è§£æå™¨ï¼Œæ¥è§£æå¹¶å¤„ç†SQLè¯­å¥ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒANTLRæ˜¯ä¸€æ¬¾å¼ºå¤§çš„ã€è·¨è¯­è¨€çš„è¯­æ³•è§£æå™¨ï¼Œå› ä¸ºå®ƒå…¨é¢æ”¯æŒSQLè¯­æ³•ï¼Œæ‰€ä»¥å¹¿æ³›åº”ç”¨äºOracleã€Prestoã€Hiveã€ElasticSearchç­‰åˆ†å¸ƒå¼æ•°æ®ä»“åº“å’Œè®¡ç®—å¼•æ“ã€‚å› æ­¤ï¼ŒåƒHiveæˆ–æ˜¯Prestoä¸­çš„SQLæŸ¥è¯¢è¯­å¥ï¼Œéƒ½å¯ä»¥å¹³æ»‘åœ°è¿ç§»åˆ°Spark SQLã€‚</p><p>ä¸ä»…å¦‚æ­¤ï¼ŒSpark SQLè¿˜æä¾›å¤§é‡Built-in Functionsï¼ˆå†…ç½®å‡½æ•°ï¼‰ï¼Œç”¨äºè¾…åŠ©æ•°æ®å¤„ç†ï¼Œå¦‚array_distinctã€collect_listï¼Œç­‰ç­‰ã€‚ä½ å¯ä»¥æµè§ˆå®˜ç½‘çš„<a href=\"https://spark.apache.org/docs/3.0.1/api/sql/index.html\">Built-in Functionsé¡µé¢</a>æŸ¥æ‰¾å®Œæ•´çš„å‡½æ•°åˆ—è¡¨ã€‚ç»“åˆSQLè¯­å¥ä»¥åŠè¿™äº›çµæ´»çš„å†…ç½®å‡½æ•°ï¼Œä½ å°±èƒ½æ¸¸åˆƒæœ‰ä½™åœ°åº”å¯¹æ•°æ®æ¢ç´¢ã€æ•°æ®åˆ†æè¿™äº›å…¸å‹çš„æ•°æ®åº”ç”¨åœºæ™¯ã€‚</p><p>SQLè¯­å¥ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå­¦ä¹ è·¯å¾„çŸ­ã€æˆæœ¬ä½ï¼Œä½ åªè¦ææ¸…æ¥šå¦‚ä½•æŠŠDataFrameè½¬åŒ–ä¸ºæ•°æ®è¡¨ï¼Œå‰©ä¸‹çš„äº‹å°±æ°´åˆ°æ¸ æˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠä¸»è¦ç²¾åŠ›æ”¾åœ¨DataFrameæ”¯æŒçš„å„ç±»ç®—å­ä¸Šï¼Œè¿™äº›ç®—å­æä¾›çš„åŠŸèƒ½ï¼Œå¾€å¾€èƒ½å¤§å¹…æå‡å¼€å‘æ•ˆç‡ï¼Œè®©æˆ‘ä»¬äº‹åŠåŠŸå€ã€‚</p><h2>DataFrameç®—å­</h2><p>ä¸å¾—ä¸è¯´ï¼ŒDataFrameæ”¯æŒçš„ç®—å­ä¸°å¯Œè€Œåˆå…¨é¢ï¼Œè¿™ä¸»è¦æºäºDataFrameç‰¹æœ‰çš„â€œåŒé¢â€å±æ€§ã€‚ä¸€æ–¹é¢ï¼ŒDataFrameæ¥è‡ªRDDï¼Œä¸RDDå…·æœ‰åŒæºæ€§ï¼Œå› æ­¤RDDæ”¯æŒçš„å¤§éƒ¨åˆ†ç®—å­ï¼ŒDataFrameéƒ½æ”¯æŒã€‚å¦ä¸€æ–¹é¢ï¼ŒDataFrameæºå¸¦Schemaï¼Œæ˜¯ç»“æ„åŒ–æ•°æ®ï¼Œå› æ­¤å®ƒå¿…å®šè¦æä¾›ä¸€å¥—ä¸ç»“æ„åŒ–æŸ¥è¯¢åŒæºçš„è®¡ç®—ç®—å­ã€‚</p><p>æ­£æ˜¯ç”±äºè¿™æ ·â€œåŒé¢â€çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼ŒDataFrameæ‰€æ”¯æŒçš„ç®—å­ï¼Œç”¨â€œç³ç…æ»¡ç›®â€æ¥å½¢å®¹éƒ½ä¸ä¸ºè¿‡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/50/97/50bd70a2dcf01b631eff86c286d9eb97.jpg?wh=1920x442\" alt=\"å›¾ç‰‡\" title=\"DataFrameç®—å­å¤§å…¨\"></p><p>äººç±»çš„å¤§è„‘åå¥½ç»“æ„åŒ–çš„çŸ¥è¯†ï¼Œä¸ºäº†æ–¹ä¾¿ä½ è®°å¿†ä¸ç†è§£ï¼Œæˆ‘æŠŠDataFrameä¸Šè¿°ä¸¤ä¸ªæ–¹é¢çš„ç®—å­ï¼Œè¿›ä¸€æ­¥åˆ’åˆ†ä¸º6å¤§ç±»ï¼Œ<strong>å®ƒä»¬åˆ†åˆ«æ˜¯RDDåŒæºç±»ç®—å­ã€æ¢ç´¢ç±»ç®—å­ã€æ¸…æ´—ç±»ç®—å­ã€è½¬æ¢ç±»ç®—å­ã€åˆ†æç±»ç®—å­å’ŒæŒä¹…åŒ–ç®—å­</strong>ã€‚</p><p>ä½ å¯èƒ½ä¼šå›°æ‰°ï¼šâ€œå¤©å‘ï¼è¿™ä¹ˆå¤šç®—å­è¦å­¦ï¼Œè¿™ä¸æ˜¯é€¼æˆ‘ä»å…¥é—¨åˆ°æ”¾å¼ƒå—ï¼Ÿâ€åˆ«ç€æ€¥ï¼Œä¸Šé¢è¿™å¼ å›¾ï¼Œä½ å¯ä»¥æŠŠå®ƒå½“ä½œæ˜¯â€œDataFrameç®—å­è„‘å›¾â€ï¼Œæˆ–æ˜¯ä¸€æœ¬å­—å…¸ã€‚åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œæ€è·¯æ¯ç«­çš„æ—¶å€™ï¼Œä½ ä¸å¦¨æŠŠå®ƒç¿»å‡ºæ¥ï¼Œçœ‹çœ‹å“ªäº›ç®—å­èƒ½å¤Ÿå¸®ä½ å®ç°ä¸šåŠ¡é€»è¾‘ã€‚</p><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¹Ÿä¼šæ ¹æ®è¿™å¼ â€œè„‘å›¾â€ï¼Œé‡ç‚¹è®²è§£å…¶ä¸­æœ€å¸¸ç”¨ã€æœ€å…³é”®çš„éƒ¨åˆ†ã€‚</p><h3>åŒæºç±»ç®—å­</h3><p>æˆ‘ä»¬ä»DataFrameä¸­çš„RDDåŒæºç±»ç®—å­è¯´èµ·ï¼Œè¿™äº›ç®—å­åœ¨RDDç®—å­é‚£ä¸‰è®²åšè¿‡è¯¦ç»†çš„ä»‹ç»ï¼Œå¦‚æœä½ å¯¹æœ‰å“ªä¸ªç®—å­çš„ä½œç”¨æˆ–å«ä¹‰è®°ä¸æ¸…äº†ï¼Œä¸å¦¨å›çœ‹ä¹‹å‰çš„ä¸‰è®²ã€‚æˆ‘æŒ‰ç…§ä¹‹å‰çš„åˆ†ç±»ï¼ŒæŠŠè¿™äº›ç®—å­æ•´ç†æˆäº†ä¸€å¼ è¡¨æ ¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5c/53/5c377yy9b592e2ae1a31cb68da2d5553.jpg?wh=1592x917\" alt=\"å›¾ç‰‡\" title=\"RDDåŒæºç±»ç®—å­\"></p><h3>æ¢ç´¢ç±»ç®—å­</h3><p>æ¥ä¸‹æ¥å°±æ˜¯DataFrameçš„æ¢ç´¢ç±»ç®—å­ã€‚æ‰€è°“æ¢ç´¢ï¼ŒæŒ‡çš„æ˜¯æ•°æ®æ¢ç´¢ï¼Œè¿™ç±»ç®—å­çš„ä½œç”¨ï¼Œåœ¨äºå¸®åŠ©å¼€å‘è€…åˆæ­¥äº†è§£å¹¶è®¤è¯†æ•°æ®ï¼Œæ¯”å¦‚æ•°æ®çš„æ¨¡å¼ï¼ˆSchemaï¼‰ã€æ•°æ®çš„åˆ†å¸ƒã€æ•°æ®çš„â€œæ¨¡æ ·â€ï¼Œç­‰ç­‰ï¼Œä¸ºåç»­çš„åº”ç”¨å¼€å‘å¥ å®šåŸºç¡€ã€‚</p><p>å¯¹äºå¸¸ç”¨çš„æ¢ç´¢ç±»ç®—å­ï¼Œæˆ‘æŠŠå®ƒä»¬æ•´ç†åˆ°äº†ä¸‹é¢çš„è¡¨æ ¼ä¸­ï¼Œä½ ä¸å¦¨å…ˆçœ‹ä¸€çœ‹ï¼Œå»ºç«‹â€œç¬¬ä¸€å°è±¡â€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7c/15/7c95d03be0a733b1498ba4b99f2e1d15.jpg?wh=1588x789\" alt=\"å›¾ç‰‡\" title=\"æ¢ç´¢ç±»ç®—å­\"></p><p>æˆ‘ä»¬æ¥ä¾æ¬¡â€œé¿è½»å°±é‡â€åœ°è¯´ä¸€è¯´è¿™äº›ç®—å­ã€‚é¦–å…ˆï¼Œcolumns/schema/printSchemaè¿™3ä¸ªç®—å­ç±»ä¼¼ï¼Œéƒ½å¯ä»¥å¸®æˆ‘ä»¬è·å–DataFrameçš„æ•°æ®åˆ—å’ŒSchemaã€‚å°¤å…¶æ˜¯printSchemaï¼Œå®ƒä»¥çº¯æ–‡æœ¬çš„æ–¹å¼å°†Data Schemaæ‰“å°åˆ°å±å¹•ä¸Šï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">import org.apache.spark.sql.DataFrame\nimport spark.implicits._\n&nbsp;\nval employees = Seq((1, \"John\", 26, \"Male\"), (2, \"Lily\", 28, \"Female\"), (3, \"Raymond\", 30, \"Male\"))\nval employeesDF: DataFrame = employees.toDF(\"id\", \"name\", \"age\", \"gender\")\n&nbsp;\nemployeesDF.printSchema\n&nbsp;\n/** ç»“æœæ‰“å°\nroot\n|-- id: integer (nullable = false)\n|-- name: string (nullable = true)\n|-- age: integer (nullable = false)\n|-- gender: string (nullable = true)\n*/\n</code></pre><p>äº†è§£æ•°æ®æ¨¡å¼ä¹‹åï¼Œæˆ‘ä»¬å¾€å¾€æƒ³çŸ¥é“æ•°æ®å…·ä½“é•¿ä»€ä¹ˆæ ·å­ï¼Œå¯¹äºè¿™ä¸ªè¯‰æ±‚ï¼Œshowç®—å­å¯ä»¥å¸®å¿™è¾¾æˆã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œshowä¼šéšæœºæ‰“å°å‡ºDataFrameçš„20æ¡æ•°æ®è®°å½•ã€‚</p><pre><code class=\"language-scala\">employeesDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---+------+\n| id| name|age|gender|\n+---+-------+---+------+\n| 1| John| 26| Male|\n| 2| Lily| 28|Female|\n| 3|Raymond| 30| Male|\n+---+-------+---+------+\n*/\n</code></pre><p>çœ‹æ¸…äº†æ•°æ®çš„â€œæœ¬æ¥é¢ç›®â€ä¹‹åï¼Œä½ è¿˜å¯ä»¥è¿›ä¸€æ­¥åˆ©ç”¨describeå»æŸ¥çœ‹æ•°å€¼åˆ—çš„ç»Ÿè®¡åˆ†å¸ƒã€‚æ¯”å¦‚ï¼Œé€šè¿‡è°ƒç”¨employeesDF.describe(â€œageâ€)ï¼Œä½ å¯ä»¥æŸ¥çœ‹ageåˆ—çš„æå€¼ã€å¹³å‡å€¼ã€æ–¹å·®ç­‰ç»Ÿè®¡æ•°å€¼ã€‚</p><p>åˆæ­¥æŒæ¡äº†æ•°æ®çš„åŸºæœ¬æƒ…å†µä¹‹åï¼Œå¦‚æœä½ å¯¹å½“å‰DataFrameçš„æ‰§è¡Œè®¡åˆ’æ„Ÿå…´è¶£ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨explainç®—å­æ¥è·å¾—Spark SQLç»™å‡ºçš„æ‰§è¡Œè®¡åˆ’ã€‚explainå¯¹äºæ‰§è¡Œæ•ˆç‡çš„è°ƒä¼˜æ¥è¯´ï¼Œæœ‰ç€è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œåç»­è¯¾ç¨‹ä¸­æˆ‘ä»¬è¿˜ä¼šç»“åˆå…·ä½“çš„å®ä¾‹ï¼Œæ¥æ·±å…¥è®²è§£explainçš„ç”¨æ³•å’Œé‡Šä¹‰ï¼Œåœ¨è¿™é‡Œï¼Œä½ ä»…éœ€çŸ¥é“explainæ˜¯ç”¨æ¥æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’çš„å°±å¥½ã€‚</p><h3>æ¸…æ´—ç±»ç®—å­</h3><p>å®Œæˆæ•°æ®æ¢ç´¢ä»¥åï¼Œæˆ‘ä»¬æ­£å¼è¿›å…¥æ•°æ®åº”ç”¨çš„å¼€å‘é˜¶æ®µã€‚åœ¨æ•°æ®å¤„ç†å‰æœŸï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å¯¹æ•°æ®è¿›è¡Œé€‚å½“åœ°â€œæ¸…æ´—â€ï¼Œâ€œæ´—æ‰â€é‚£äº›ä¸ç¬¦åˆä¸šåŠ¡é€»è¾‘çš„â€œè„æ•°æ®â€ã€‚DataFrameæä¾›äº†å¦‚ä¸‹ç®—å­ï¼Œæ¥å¸®æˆ‘ä»¬å®Œæˆè¿™äº›è„æ´»å„¿ã€ç´¯æ´»å„¿ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c1/1b/c1c55259a2f14870606ab4c182d8921b.jpg?wh=1588x789\" alt=\"å›¾ç‰‡\" title=\"æ¸…æ´—ç±»ç®—å­\"></p><p>é¦–å…ˆï¼Œdropç®—å­å…è®¸å¼€å‘è€…ç›´æ¥æŠŠæŒ‡å®šåˆ—ä»DataFrameä¸­äºˆä»¥æ¸…é™¤ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºä¸Šè¿°çš„employeesDFï¼Œå‡è®¾æˆ‘ä»¬æƒ³æŠŠæ€§åˆ«åˆ—æ¸…é™¤ï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨ employeesDF.drop(â€œgenderâ€) å³å¯ã€‚å¦‚æœè¦åŒæ—¶æ¸…é™¤å¤šåˆ—ï¼Œåªéœ€è¦åœ¨dropç®—å­ä¸­ç”¨é€—å·æŠŠå¤šä¸ªåˆ—åéš”å¼€å³å¯ã€‚</p><p>ç¬¬äºŒä¸ªæ˜¯distinctï¼Œå®ƒç”¨æ¥ä¸ºDataFrameä¸­çš„æ•°æ®åšå»é‡ã€‚è¿˜æ˜¯ä»¥employeesDFä¸ºä¾‹ï¼Œå½“æœ‰å¤šæ¡æ•°æ®è®°å½•çš„æ‰€æœ‰å­—æ®µå€¼éƒ½ç›¸åŒæ—¶ï¼Œä½¿ç”¨distinctå¯ä»¥ä»…ä¿ç•™å…¶ä¸­çš„ä¸€æ¡æ•°æ®è®°å½•ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯dropDuplicatesï¼Œå®ƒçš„ä½œç”¨ä¹Ÿæ˜¯å»é‡ã€‚ä¸è¿‡ï¼Œä¸distinctä¸åŒçš„æ˜¯ï¼ŒdropDuplicateså¯ä»¥æŒ‡å®šæ•°æ®åˆ—ï¼Œå› æ­¤åœ¨çµæ´»æ€§ä¸Šæ›´èƒœä¸€ç­¹ã€‚è¿˜æ˜¯æ‹¿employeesDFæ¥ä¸¾ä¾‹ï¼Œè¿™ä¸ªDataFrameåŸæœ¬æœ‰3æ¡æ•°æ®è®°å½•ï¼Œå¦‚æœæˆ‘ä»¬æŒ‰ç…§æ€§åˆ«åˆ—å»é‡ï¼Œæœ€ååªä¼šç•™ä¸‹ä¸¤æ¡è®°å½•ã€‚å…¶ä¸­ï¼Œä¸€æ¡è®°å½•çš„genderåˆ—æ˜¯â€œMaleâ€ï¼Œå¦ä¸€æ¡çš„genderåˆ—ä¸ºâ€œFemaleâ€ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">employeesDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---+------+\n| id| name|age|gender|\n+---+-------+---+------+\n| 1| John| 26| Male|\n| 2| Lily| 28|Female|\n| 3|Raymond| 30| Male|\n+---+-------+---+------+\n*/\n&nbsp;\nemployeesDF.dropDuplicates(\"gender\").show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+----+---+------+\n| id|name|age|gender|\n+---+----+---+------+\n| 2|Lily| 28|Female|\n| 1|John| 26| Male|\n+---+----+---+------+\n*/\n</code></pre><p>è¡¨æ ¼ä¸­çš„æœ€åä¸€ä¸ªç®—å­æ˜¯naï¼Œå®ƒçš„ä½œç”¨æ˜¯é€‰å–DataFrameä¸­çš„nullæ•°æ®ï¼Œnaå¾€å¾€è¦ç»“åˆdropæˆ–æ˜¯fillæ¥ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼ŒemployeesDF.na.dropç”¨äºåˆ é™¤DataFrameä¸­å¸¦nullå€¼çš„æ•°æ®è®°å½•ï¼Œè€ŒemployeesDF.na.fill(0) åˆ™å°†DataFrameä¸­æ‰€æœ‰çš„nullå€¼éƒ½è‡ªåŠ¨å¡«å……ä¸ºæ•´æ•°é›¶ã€‚è¿™ä¸¤ç§ç”¨ä¾‹åœ¨æ•°æ®æ¸…æ´—çš„åœºæ™¯ä¸­éƒ½éå¸¸å¸¸è§ï¼Œå› æ­¤ï¼Œä½ éœ€è¦ç‰¢ç‰¢æŒæ¡na.dropä¸na.fillçš„ç”¨æ³•ã€‚</p><p>æ•°æ®æ¸…æ´—è¿‡åï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä»½â€œæ•´æ´è€Œåˆå¹²å‡€â€çš„æ•°æ®ï¼Œæ¥ä¸‹æ¥ï¼Œå¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ°å»åšå„å¼å„æ ·çš„æ•°æ®è½¬æ¢ï¼Œä»è€Œå®ç°ä¸šåŠ¡é€»è¾‘éœ€æ±‚ã€‚</p><h3>è½¬æ¢ç±»ç®—å­</h3><p>è½¬æ¢ç±»ç®—å­çš„ä¸»è¦ç”¨äºæ•°æ®çš„ç”Ÿæˆã€æå–ä¸è½¬æ¢ã€‚è½¬æ¢ç±»çš„ç®—å­çš„æ•°é‡å¹¶ä¸å¤šï¼Œä½†ä½¿ç”¨æ–¹å¼éå¸¸çµæ´»ï¼Œå¼€å‘è€…å¯ä»¥å˜ç€èŠ±æ ·åœ°å˜æ¢æ•°æ®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4a/77/4a3f705c5bde5a597yy5bf8c78b15e77.jpg?wh=1640x1047\" alt=\"å›¾ç‰‡\" title=\"è½¬æ¢ç±»ç®—å­\"></p><p>é¦–å…ˆï¼Œselectç®—å­è®©æˆ‘ä»¬å¯ä»¥æŒ‰ç…§åˆ—åå¯¹DataFrameåšæŠ•å½±ï¼Œæ¯”å¦‚è¯´ï¼Œå¦‚æœæˆ‘ä»¬åªå…³å¿ƒå¹´é¾„ä¸æ€§åˆ«è¿™ä¸¤ä¸ªå­—æ®µçš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­å¥æ¥å®ç°ã€‚</p><pre><code class=\"language-scala\">employeesDF.select(\"name\", \"gender\").show\n&nbsp;\n/** ç»“æœæ‰“å°\n+-------+------+\n| name|gender|\n+-------+------+\n| John| Male|\n| Lily|Female|\n|Raymond| Male|\n+-------+------+\n*/\n</code></pre><p>ä¸è¿‡ï¼Œè™½ç„¶ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†selectç®—å­åœ¨åŠŸèƒ½æ–¹é¢ä¸å¤Ÿçµæ´»ã€‚åœ¨çµæ´»æ€§è¿™æ–¹é¢ï¼ŒselectExpråšå¾—æ›´å¥½ã€‚æ¯”å¦‚è¯´ï¼ŒåŸºäºidå’Œå§“åï¼Œæˆ‘ä»¬æƒ³æŠŠå®ƒä»¬æ‹¼æ¥èµ·æ¥ç”Ÿæˆä¸€åˆ—æ–°çš„æ•°æ®ã€‚åƒè¿™ç§éœ€æ±‚ï¼Œæ­£æ˜¯selectExprç®—å­çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p><pre><code class=\"language-scala\">employeesDF.selectExpr(\"id\", \"name\", \"concat(id, '_', name) as id_name\").show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---------+\n| id| name| id_name|\n+---+-------+---------+\n| 1| John| 1_John|\n| 2| Lily| 2_Lily|\n| 3|Raymond|3_Raymond|\n+---+-------+---------+\n*/\n</code></pre><p>è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨concatè¿™ä¸ªå‡½æ•°ï¼ŒæŠŠidåˆ—å’Œnameåˆ—æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œç”Ÿæˆæ–°çš„id_nameæ•°æ®åˆ—ã€‚</p><p>æ¥ä¸‹æ¥çš„whereå’ŒwithColumnRenamedè¿™ä¸¤ä¸ªç®—å­æ¯”è¾ƒç®€å•ï¼Œwhereä½¿ç”¨SQLè¯­å¥å¯¹DataFrameåšæ•°æ®è¿‡æ»¤ï¼Œè€ŒwithColumnRenamedçš„ä½œç”¨æ˜¯å­—æ®µé‡å‘½åã€‚</p><p>æ¯”å¦‚ï¼Œæƒ³è¦è¿‡æ»¤å‡ºæ‰€æœ‰æ€§åˆ«ä¸ºç”·çš„å‘˜å·¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨employeesDF.where(â€œgender = â€˜Maleâ€™â€)æ¥å®ç°ã€‚å¦‚æœæ‰“ç®—æŠŠemployeesDFå½“ä¸­çš„â€œgenderâ€é‡å‘½åä¸ºâ€œsexâ€ï¼Œå°±å¯ä»¥ç”¨withColumnRenamedæ¥å¸®å¿™ï¼šemployeesDF.withColumnRenamed(â€œgenderâ€, â€œsexâ€)ã€‚</p><p>ç´§æ¥ç€çš„æ˜¯withColumnï¼Œè™½ç„¶åå­—çœ‹ä¸Šå»å’ŒwithColumnRenamedå¾ˆåƒï¼Œä½†äºŒè€…åœ¨åŠŸèƒ½ä¸Šæœ‰ç€å¤©å£¤ä¹‹åˆ«ã€‚</p><p>withColumnRenamedæ˜¯é‡å‘½åç°æœ‰çš„æ•°æ®åˆ—ï¼Œè€ŒwithColumnåˆ™ç”¨äºç”Ÿæˆæ–°çš„æ•°æ®åˆ—ï¼Œè¿™ä¸€ç‚¹ä¸Šï¼ŒwithColumnå€’æ˜¯å’ŒselectExpræœ‰ç€å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚withColumnä¹Ÿå¯ä»¥å……åˆ†åˆ©ç”¨Spark SQLæä¾›çš„Built-in Functionsæ¥çµæ´»åœ°ç”Ÿæˆæ•°æ®ã€‚</p><p>æ¯”å¦‚ï¼ŒåŸºäºå¹´é¾„åˆ—ï¼Œæˆ‘ä»¬æƒ³ç”Ÿæˆä¸€åˆ—è„±æ•æ•°æ®ï¼Œéšå»çœŸå®å¹´é¾„ï¼Œä½ å°±å¯ä»¥è¿™æ ·æ“ä½œã€‚</p><pre><code class=\"language-scala\">employeesDF.withColumn(\"crypto\", hash($\"age\")).show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---+------+-----------+\n| id| name|age|gender| crypto|\n+---+-------+---+------+-----------+\n| 1| John| 26| Male|-1223696181|\n| 2| Lily| 28|Female|-1721654386|\n| 3|Raymond| 30| Male| 1796998381|\n+---+-------+---+------+-----------+\n*/\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨å†…ç½®å‡½æ•°hashï¼Œç”Ÿæˆä¸€åˆ—åä¸ºâ€œcryptoâ€çš„æ–°æ•°æ®ï¼Œæ•°æ®å€¼æ˜¯å¯¹åº”å¹´é¾„çš„å“ˆå¸Œå€¼ã€‚æœ‰äº†æ–°çš„æ•°æ®åˆ—ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨åˆšåˆšè®²çš„dropï¼ŒæŠŠåŸå§‹çš„ageå­—æ®µä¸¢å¼ƒæ‰ã€‚</p><p>è¡¨æ ¼ä¸­çš„æœ€åä¸€ä¸ªç®—å­æ˜¯explodeï¼Œè¿™ä¸ªç®—å­å¾ˆæœ‰æ„æ€ï¼Œå®ƒçš„ä½œç”¨æ˜¯å±•å¼€æ•°ç»„ç±»å‹çš„æ•°æ®åˆ—ï¼Œæ•°ç»„å½“ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½ä¼šç”Ÿæˆä¸€è¡Œæ–°çš„æ•°æ®è®°å½•ã€‚ä¸ºäº†æ›´å¥½åœ°æ¼”ç¤ºexplodeçš„ç”¨æ³•ä¸æ•ˆæœï¼Œæˆ‘ä»¬æŠŠemployeesDFæ•°æ®é›†åšä¸ªç®€å•çš„è°ƒæ•´ï¼Œç»™å®ƒåŠ ä¸Šä¸€ä¸ªinterestså…´è¶£å­—æ®µã€‚</p><pre><code class=\"language-scala\">val seq = Seq( (1, \"John\", 26, \"Male\", Seq(\"Sports\", \"News\")),\n(2, \"Lily\", 28, \"Female\", Seq(\"Shopping\", \"Reading\")),\n(3, \"Raymond\", 30, \"Male\", Seq(\"Sports\", \"Reading\"))\n)\n&nbsp;\nval employeesDF: DataFrame = seq.toDF(\"id\", \"name\", \"age\", \"gender\", \"interests\")\nemployeesDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---+------+-------------------+\n| id| name|age|gender| interests|\n+---+-------+---+------+-------------------+\n| 1| John| 26| Male| [Sports, News]|\n| 2| Lily| 28|Female|[Shopping, Reading]|\n| 3|Raymond| 30| Male| [Sports, Reading]|\n+---+-------+---+------+-------------------+\n*/\n&nbsp;\nemployeesDF.withColumn(\"interest\", explode($\"interests\")).show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---+------+-------------------+--------+\n| id| name|age|gender| interests|interest|\n+---+-------+---+------+-------------------+--------+\n| 1| John| 26| Male| [Sports, News]| Sports|\n| 1| John| 26| Male| [Sports, News]| News|\n| 2| Lily| 28|Female|[Shopping, Reading]|Shopping|\n| 2| Lily| 28|Female|[Shopping, Reading]| Reading|\n| 3|Raymond| 30| Male| [Sports, Reading]| Sports|\n| 3|Raymond| 30| Male| [Sports, Reading]| Reading|\n+---+-------+---+------+-------------------+--------+\n*/\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¤šåŠ äº†ä¸€ä¸ªå…´è¶£åˆ—ï¼Œåˆ—æ•°æ®çš„ç±»å‹æ˜¯æ•°ç»„ï¼Œæ¯ä¸ªå‘˜å·¥éƒ½æœ‰é›¶åˆ°å¤šä¸ªå…´è¶£ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³æŠŠæ•°ç»„å…ƒç´ å±•å¼€ï¼Œè®©æ¯ä¸ªå…´è¶£éƒ½å¯ä»¥ç‹¬å ä¸€æ¡æ•°æ®è®°å½•ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨explodeï¼Œå†ç»“åˆwithColumnï¼Œç”Ÿæˆä¸€åˆ—æ–°çš„interestæ•°æ®ã€‚è¿™åˆ—æ•°æ®çš„ç±»å‹æ˜¯å•ä¸ªå…ƒç´ çš„Stringï¼Œè€Œä¸å†æ˜¯æ•°ç»„ã€‚æœ‰äº†æ–°çš„interestæ•°æ®åˆ—ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡åˆ©ç”¨dropç®—å­ï¼ŒæŠŠåŸæœ¬çš„interestsåˆ—æŠ›å¼ƒæ‰ã€‚</p><p>æ•°æ®è½¬æ¢å®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ•°æ®çš„å…³è”ã€åˆ†ç»„ã€èšåˆã€æ’åºï¼Œå»åšæ•°æ®åˆ†æï¼Œä»ä¸åŒçš„è§†è§’å‡ºå‘å»æ´å¯Ÿæ•°æ®ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜è¦ä¾èµ–Spark SQLæä¾›çš„å¤šä¸ªåˆ†æç±»ç®—å­ã€‚</p><h3>åˆ†æç±»ç®—å­</h3><p>æ¯«ä¸å¤¸å¼ åœ°è¯´ï¼Œå‰é¢çš„æ¢ç´¢ã€æ¸…æ´—ã€è½¬æ¢ï¼Œéƒ½æ˜¯åœ¨ä¸ºæ•°æ®åˆ†æåšå‡†å¤‡ã€‚<strong>åœ¨å¤§å¤šæ•°çš„æ•°æ®åº”ç”¨ä¸­ï¼Œæ•°æ®åˆ†æå¾€å¾€æ˜¯æœ€ä¸ºå…³é”®çš„é‚£ç¯ï¼Œç”šè‡³æ˜¯åº”ç”¨æœ¬èº«çš„æ ¸å¿ƒç›®çš„</strong>ã€‚å› æ­¤ï¼Œç†Ÿç»ƒæŒæ¡åˆ†æç±»ç®—å­ï¼Œæœ‰åˆ©äºæˆ‘ä»¬æå‡å¼€å‘æ•ˆç‡ã€‚</p><p>Spark SQLçš„åˆ†æç±»ç®—å­çœ‹ä¸Šå»å¹¶ä¸å¤šï¼Œä½†çµæ´»ç»„åˆä½¿ç”¨ï¼Œå°±ä¼šæœ‰â€œåƒå˜ä¸‡åŒ–â€çš„æ•ˆæœï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6f/1c/6f1b2yy4ceb3e7c5bbyyec25e04e791c.jpg?wh=1564x797\" alt=\"å›¾ç‰‡\" title=\"åˆ†æç±»ç®—å­\"></p><p>ä¸ºäº†æ¼”ç¤ºä¸Šè¿°ç®—å­çš„ç”¨æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥å‡†å¤‡ä¸¤å¼ æ•°æ®è¡¨ï¼šemployeeså’Œsalariesï¼Œä¹Ÿå³å‘˜å·¥ä¿¡æ¯è¡¨å’Œè–ªæ°´è¡¨ã€‚æˆ‘ä»¬çš„æƒ³æ³•æ˜¯ï¼Œé€šè¿‡å¯¹ä¸¤å¼ è¡¨åšæ•°æ®å…³è”ï¼Œæ¥åˆ†æå‘˜å·¥è–ªæ°´çš„åˆ†å¸ƒæƒ…å†µã€‚</p><pre><code class=\"language-scala\">import spark.implicits._\nimport org.apache.spark.sql.DataFrame\n&nbsp;\n// åˆ›å»ºå‘˜å·¥ä¿¡æ¯è¡¨\nval seq = Seq((1, \"Mike\", 28, \"Male\"), (2, \"Lily\", 30, \"Female\"), (3, \"Raymond\", 26, \"Male\"))\nval employees: DataFrame = seq.toDF(\"id\", \"name\", \"age\", \"gender\")\n&nbsp;\n// åˆ›å»ºè–ªæ°´è¡¨\nval seq2 = Seq((1, 26000), (2, 30000), (4, 25000), (3, 20000))\nval salaries:DataFrame = seq2.toDF(\"id\", \"salary\")\n&nbsp;\nemployees.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---+------+\n| id| name|age|gender|\n+---+-------+---+------+\n| 1| Mike| 28| Male|\n| 2| Lily| 30|Female|\n| 3|Raymond| 26| Male|\n+---+-------+---+------+\n*/\n&nbsp;\nsalaries.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+\n| id|salary|\n+---+------+\n| 1| 26000|\n| 2| 30000|\n| 4| 25000|\n| 3| 20000|\n+---+------+\n*/\n</code></pre><p>é‚£ä¹ˆé¦–å…ˆï¼Œæˆ‘ä»¬å…ˆç”¨joinç®—å­æŠŠä¸¤å¼ è¡¨å…³è”èµ·æ¥ï¼Œå…³è”é”®ï¼ˆJoin Keysï¼‰æˆ‘ä»¬ä½¿ç”¨ä¸¤å¼ è¡¨å…±æœ‰çš„idåˆ—ï¼Œè€Œå…³è”å½¢å¼ï¼ˆJoin Typeï¼‰è‡ªç„¶æ˜¯å†…å…³è”ï¼ˆInner Joinï¼‰ã€‚</p><pre><code class=\"language-scala\">val jointDF: DataFrame = salaries.join(employees, Seq(\"id\"), \"inner\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+-------+---+------+\n| id|salary| name|age|gender|\n+---+------+-------+---+------+\n| 1| 26000| Mike| 28| Male|\n| 2| 30000| Lily| 30|Female|\n| 3| 20000|Raymond| 26| Male|\n+---+------+-------+---+------+\n*/\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨salariesä¹‹ä¸Šè°ƒç”¨joinç®—å­ï¼Œjoinç®—å­çš„å‚æ•°æœ‰3ç±»ã€‚ç¬¬ä¸€ç±»æ˜¯å¾…å…³è”çš„æ•°æ®è¡¨ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å°±æ˜¯å‘˜å·¥è¡¨employeesã€‚ç¬¬äºŒç±»æ˜¯å…³è”é”®ï¼Œä¹Ÿå°±æ˜¯ä¸¤å¼ è¡¨ä¹‹é—´ä¾æ®å“ªäº›å­—æ®µåšå…³è”ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯idåˆ—ã€‚ç¬¬ä¸‰ç±»æ˜¯å…³è”å½¢å¼ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå…³è”å½¢å¼æœ‰innerã€leftã€rightã€antiã€semiç­‰ç­‰ï¼Œè¿™äº›å…³è”å½¢å¼æˆ‘ä»¬ä¸‹ä¸€è®²å†å±•å¼€ï¼Œè¿™é‡Œä½ åªéœ€è¦çŸ¥é“Spark SQLæ”¯æŒè¿™äº›ç§ç±»ä¸°å¯Œçš„å…³è”å½¢å¼å³å¯ã€‚</p><p>æ•°æ®å®Œæˆå…³è”ä¹‹åï¼Œæˆ‘ä»¬å®é™…å¾—åˆ°çš„ä»…ä»…æ˜¯æœ€ç»†ç²’åº¦çš„äº‹å®æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªå‘˜å·¥æ¯ä¸ªæœˆé¢†å¤šå°‘è–ªæ°´ã€‚è¿™æ ·çš„äº‹å®æ•°æ®æœ¬èº«å¹¶æ²¡æœ‰å¤šå°‘ä»·å€¼ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦ä»ä¸åŒçš„ç»´åº¦å‡ºå‘ï¼Œå¯¹æ•°æ®åšåˆ†ç»„ã€èšåˆï¼Œæ‰èƒ½è·å¾—æ›´æ·±å…¥ã€æ›´æœ‰ä»·å€¼çš„æ•°æ®æ´å¯Ÿã€‚</p><p>æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬æƒ³ä»¥æ€§åˆ«ä¸ºç»´åº¦ï¼Œç»Ÿè®¡ä¸åŒæ€§åˆ«ä¸‹çš„æ€»è–ªæ°´å’Œå¹³å‡è–ªæ°´ï¼Œå€Ÿæ­¤åˆ†æè–ªæ°´ä¸æ€§åˆ«ä¹‹é—´å¯èƒ½å­˜åœ¨çš„å…³è”å…³ç³»ã€‚</p><pre><code class=\"language-scala\">val aggResult = fullInfo.groupBy(\"gender\").agg(sum(\"salary\").as(\"sum_salary\"), avg(\"salary\").as(\"avg_salary\"))\n&nbsp;\naggResult.show\n&nbsp;\n/** æ•°æ®æ‰“å°\n+------+----------+----------+\n|gender|sum_salary|avg_salary|\n+------+----------+----------+\n|Female| 30000| 30000.0|\n| Male| 46000| 23000.0|\n+------+----------+----------+\n*/\n</code></pre><p>è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆæ˜¯ä½¿ç”¨groupByç®—å­æŒ‰ç…§â€œgenderâ€åˆ—åšåˆ†ç»„ï¼Œç„¶åä½¿ç”¨aggç®—å­åšèšåˆè¿ç®—ã€‚åœ¨aggç®—å­ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨sumå’Œavgèšåˆå‡½æ•°æ¥è®¡ç®—è–ªæ°´çš„æ€»æ•°å’Œå¹³å‡å€¼ã€‚Spark SQLå¯¹äºèšåˆå‡½æ•°çš„æ”¯æŒï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡<a href=\"https://spark.apache.org/docs/3.0.1/api/sql/\">Built-in Functionsé¡µé¢</a>æ¥è¿›è¡Œæ£€ç´¢ã€‚ç»“åˆBuilt-in Functionsæä¾›çš„èšåˆå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥çµæ´»åœ°å¯¹æ•°æ®åšç»Ÿè®¡åˆ†æã€‚</p><p>å¾—åˆ°ç»Ÿè®¡ç»“æœä¹‹åï¼Œä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨sortæˆ–æ˜¯orderByç®—å­å¯¹ç»“æœé›†è¿›è¡Œæ’åºï¼ŒäºŒè€…åœ¨ç”¨æ³•ä¸æ•ˆæœä¸Šæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">aggResult.sort(desc(\"sum_salary\"), asc(\"gender\")).show\n&nbsp;\n/** ç»“æœæ‰“å°\n+------+----------+----------+\n|gender|sum_salary|avg_salary|\n+------+----------+----------+\n| Male| 46000| 23000.0|\n|Female| 30000| 30000.0|\n+------+----------+----------+\n*/\n&nbsp;\naggResult.orderBy(desc(\"sum_salary\"), asc(\"gender\")).show\n&nbsp;\n/** ç»“æœæ‰“å°\n+------+----------+----------+\n|gender|sum_salary|avg_salary|\n+------+----------+----------+\n| Male| 46000| 23000.0|\n|Female| 30000| 30000.0|\n+------+----------+----------+\n*/\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œsort / orderByæ”¯æŒæŒ‰ç…§å¤šåˆ—è¿›è¡Œæ’åºï¼Œä¸”å¯ä»¥é€šè¿‡descå’Œascæ¥æŒ‡å®šæ’åºæ–¹å‘ã€‚å…¶ä¸­descè¡¨ç¤ºé™åºæ’åºï¼Œç›¸åº”åœ°ï¼Œascè¡¨ç¤ºå‡åºæ’åºã€‚</p><p>å¥½å•¦ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ²¿ç€æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸï¼Œåˆ†åˆ«æ¢³ç†äº†ç”Ÿå‘½å‘¨æœŸä¸åŒé˜¶æ®µçš„Spark SQLç®—å­ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯æ¢ç´¢ç±»ç®—å­ã€æ¸…æ´—ç±»ç®—å­ã€è½¬æ¢ç±»ç®—å­å’Œåˆ†æç±»ç®—å­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/50/97/50bd70a2dcf01b631eff86c286d9eb97.jpg?wh=1920x442\" alt=\"å›¾ç‰‡\" title=\"æ•°æ®ç”Ÿå‘½å‘¨æœŸä¸DataFrameç®—å­\"></p><p>æ‰€è°“è¡Œç™¾é‡Œè€…åŠä¹åï¼Œçºµè§‚æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬è¿˜å‰©ä¸‹æ•°æ®æŒä¹…åŒ–è¿™ä¸€ä¸ªç¯èŠ‚ã€‚å¯¹äºæœ€åçš„è¿™ä¸ªæŒä¹…åŒ–ç¯èŠ‚ï¼ŒSpark SQLæä¾›äº†write APIï¼Œä¸ä¸Šä¸€è®²ä»‹ç»çš„read APIç›¸å¯¹åº”ï¼Œwrite APIå…è®¸å¼€å‘è€…æŠŠæ•°æ®çµæ´»åœ°ç‰©åŒ–ä¸ºä¸åŒçš„æ–‡ä»¶æ ¼å¼ã€‚</p><h3>æŒä¹…åŒ–ç±»ç®—å­</h3><p>æ²¡æœ‰å¯¹æ¯”å°±æ²¡æœ‰é‰´åˆ«ï¼Œåœ¨å­¦ä¹ write APIä¹‹å‰ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¸Šä¸€è®²ä»‹ç»çš„read APIã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/52/43/525441865dede68fa5a9138cb930de43.jpg?wh=1920x654\" alt=\"å›¾ç‰‡\" title=\"read APIä¸€èˆ¬ç”¨æ³•\"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œread APIæœ‰3ä¸ªå…³é”®ç‚¹ï¼Œä¸€æ˜¯ç”±formatæŒ‡å®šçš„æ–‡ä»¶æ ¼å¼ï¼ŒäºŒæ˜¯ç”±é›¶åˆ°å¤šä¸ªoptionç»„æˆçš„åŠ è½½é€‰é¡¹ï¼Œæœ€åä¸€ä¸ªæ˜¯ç”±loadæ ‡è®°çš„æºæ–‡ä»¶è·¯å¾„ã€‚</p><p>ä¸ä¹‹ç›¸å¯¹ï¼Œwrite APIä¹Ÿæœ‰3ä¸ªå…³é”®ç¯èŠ‚ï¼Œåˆ†åˆ«æ˜¯åŒæ ·ç”±formatå®šä¹‰çš„æ–‡ä»¶æ ¼å¼ï¼Œé›¶åˆ°å¤šä¸ªç”±optionæ„æˆçš„â€œå†™å…¥é€‰é¡¹â€ï¼Œä»¥åŠç”±saveæŒ‡å®šçš„å­˜å‚¨è·¯å¾„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/73/cd/7348bdf46f3d051b891620a0c3f22dcd.jpg?wh=1920x680\" alt=\"å›¾ç‰‡\" title=\"write APIä¸€èˆ¬ç”¨æ³•\"></p><p>è¿™é‡Œçš„formatå’Œsaveï¼Œä¸read APIä¸­çš„formatå’Œloadæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œåˆ†åˆ«ç”¨äºæŒ‡å®šæ–‡ä»¶æ ¼å¼ä¸å­˜å‚¨è·¯å¾„ã€‚å®é™…ä¸Šï¼Œoptioné€‰é¡¹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œé™¤äº†modeä»¥å¤–ï¼Œwrite APIä¸­çš„é€‰é¡¹é”®ä¸read APIä¸­çš„é€‰é¡¹é”®ä¹Ÿæ˜¯ç›¸ä¸€è‡´çš„ï¼Œå¦‚seqç”¨äºæŒ‡å®šCSVæ–‡ä»¶åˆ†éš”ç¬¦ã€dbtableç”¨äºæŒ‡å®šæ•°æ®è¡¨åã€ç­‰ç­‰ï¼Œä½ å¯ä»¥é€šè¿‡å›é¡¾<a href=\"https://time.geekbang.org/column/article/426101\">ä¸Šä¸€è®²</a>æ¥è·å–æ›´å¤šçš„optioné€‰é¡¹ã€‚</p><p>åœ¨read APIä¸­ï¼Œmodeé€‰é¡¹é”®ç”¨äºæŒ‡å®šè¯»å–æ¨¡å¼ï¼Œå¦‚permissive, dropMalformed, failFastã€‚ä½†åœ¨write APIä¸­ï¼Œmodeç”¨äºæŒ‡å®šâ€œå†™å…¥æ¨¡å¼â€ï¼Œåˆ†åˆ«æœ‰Appendã€Overwriteã€ErrorIfExistsã€Ignoreè¿™4ç§æ¨¡å¼ï¼Œå®ƒä»¬çš„å«ä¹‰ä¸æè¿°å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f9/48/f9367e4bb06702f396325183014ef448.jpg?wh=1594x789\" alt=\"å›¾ç‰‡\" title=\"ä¸åŒå†™å…¥æ¨¡å¼çš„å«ä¹‰\"></p><p>æœ‰äº†write APIï¼Œæˆ‘ä»¬å°±å¯ä»¥çµæ´»åœ°æŠŠDataFrameæŒä¹…åŒ–åˆ°ä¸åŒçš„å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œä¸ºæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸç”»ä¸Šä¸€ä¸ªåœ†æ»¡çš„å¥å·ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¸»è¦å›´ç»•æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸï¼Œå­¦ä¹ äº†Spark SQLåœ¨ä¸åŒæ•°æ®é˜¶æ®µæ”¯æŒçš„å¤„ç†ç®—å­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/50/97/50bd70a2dcf01b631eff86c286d9eb97.jpg?wh=1920x442\" alt=\"å›¾ç‰‡\" title=\"Spark SQLç®—å­ä¸€è§ˆ\"></p><p>å›¾ä¸­æ¶‰åŠçš„ç®—å­å¾ˆå¤šï¼Œå°½ç®¡å¤§éƒ¨åˆ†æˆ‘ä»¬éƒ½ä¸¾ä¾‹è®²è¿‡äº†ï¼Œä½†è¦åœ¨çŸ­æ—¶é—´ä¹‹å†…ä¸€ä¸‹å­æŒæ¡è¿™ä¹ˆå¤šå†…å®¹ï¼Œç¡®å®å¼ºäººæ‰€éš¾ã€‚ä¸è¿‡ï¼Œä½ ä¸ç”¨æ‹…å¿ƒï¼Œä»Šå¤©è¿™ä¸€è®²ï¼Œæœ€ä¸»è¦çš„ç›®çš„ï¼Œè¿˜æ˜¯æƒ³è®©ä½ å¯¹Spark SQLæ”¯æŒçš„ç®—å­æœ‰ä¸€ä¸ªæ•´ä½“çš„æŠŠæ¡ã€‚</p><p>è‡³äºæ¯ä¸ªç®—å­å…·ä½“æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Œåœ¨æ—¥åçš„å¼€å‘å·¥ä½œä¸­ï¼Œä½ å¯ä»¥åå¤åœ°ç¿»çœ‹è¿™ä¸€è®²ï¼Œç»“åˆå®è·µæ…¢æ…¢åœ°åŠ æ·±å°è±¡ï¼Œè¿™æ ·å­¦ä¹ æ›´é«˜æ•ˆã€‚æˆ‘ä¹Ÿå¼ºçƒˆå»ºè®®ä½ ç©ºé—²æ—¶æŠŠå®˜ç½‘çš„<a href=\"https://spark.apache.org/docs/3.0.1/api/sql/index.html\">Built-in Functionsåˆ—è¡¨</a>è¿‡ä¸€éï¼Œå¯¹è¿™äº›å†…ç½®å‡½æ•°çš„åŠŸèƒ½åšåˆ°å¿ƒä¸­æœ‰æ•°ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘æ—¶æ‰ä¼šæ‰‹åˆ°æ“’æ¥ã€‚</p><p>é™¤äº†DataFrameæœ¬èº«æ”¯æŒçš„ç®—å­ä¹‹å¤–ï¼Œåœ¨åŠŸèƒ½ä¸Šï¼ŒSQLå®Œå…¨å¯ä»¥å®ç°åŒæ ·çš„æ•°æ®åˆ†æã€‚ç»™å®šDataFrameï¼Œä½ åªéœ€é€šè¿‡createTempViewæˆ–æ˜¯createGlobalTempViewæ¥åˆ›å»ºä¸´æ—¶è¡¨ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡å†™SQLè¯­å¥å»è¿›è¡Œæ•°æ®çš„æ¢ç´¢ã€å€¾æ–œã€è½¬æ¢ä¸åˆ†æã€‚</p><p>æœ€åï¼Œéœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼ŒDataFrameç®—å­ä¸SQLæŸ¥è¯¢è¯­å¥ä¹‹é—´ï¼Œå¹¶æ²¡æœ‰ä¼˜åŠ£ä¹‹åˆ†ï¼Œä»–ä»¬å¯ä»¥å®ç°åŒæ ·çš„æ•°æ®åº”ç”¨ï¼Œè€Œä¸”åœ¨æ‰§è¡Œæ€§èƒ½æ–¹é¢ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç»“åˆä½ çš„å¼€å‘ä¹ æƒ¯ä¸åå¥½ï¼Œè‡ªç”±åœ°åœ¨ä¸¤è€…ä¹‹é—´è¿›è¡Œå–èˆã€‚</p><h2>æ¯è¯¾ä¸€ç»ƒ</h2><p>åœ¨è½¬æ¢ç±»ç®—å­ä¸­ï¼Œæˆ‘ä»¬ä¸¾ä¾‹ä»‹ç»äº†explodeè¿™ä¸ªç®—å­ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŒ‰ç…§ä»¥æ•°ç»„ä¸ºå…ƒç´ çš„æ•°æ®åˆ—ï¼ŒæŠŠä¸€æ¡æ•°æ®å±•å¼€ï¼ˆçˆ†ç‚¸ï¼‰æˆå¤šæ¡æ•°æ®ã€‚ç»“åˆè¿™ä¸ªç®—å­çš„ä½œç”¨ï¼Œä½ èƒ½å¦åˆ†æä¸€ä¸‹ï¼Œexplodeæ“ä½œæ˜¯å¦ä¼šå¼•å…¥Shuffleè®¡ç®—å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµäº’åŠ¨ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™ä¸€è®²åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"15 | æ•°æ®æºä¸æ•°æ®æ ¼å¼ï¼šDataFrameä»ä½•è€Œæ¥ï¼Ÿ","id":426101},"right":{"article_title":"17 | æ•°æ®å…³è”ï¼šä¸åŒçš„å…³è”å½¢å¼ä¸å®ç°æœºåˆ¶è¯¥æ€ä¹ˆé€‰ï¼Ÿ","id":427470}},"comments":[{"had_liked":false,"id":318745,"user_name":"kingcall","can_delete":false,"product_type":"c1","uid":1056982,"ip_address":"","ucode":"508884DC684B5B","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/d6/b9513db0.jpg","comment_is_top":false,"comment_ctime":1635409504,"is_pvip":false,"replies":[{"id":"115575","content":"æ­£è§£ï¼Œæ»¡åˆ†ğŸ’¯","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1635425513,"ip_address":"","comment_id":318745,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23110245984","product_id":100090001,"comment_content":"explode ä¸ä¼šå¼•å…¥shuffle,å› ä¸ºshuffleæ˜¯åœ¨ä¼—å¤šè®¡ç®—èŠ‚ç‚¹è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œexplodeè™½ç„¶ä¼šå¯¼è‡´æ•°æ®æ¡æ•°å˜å¤šä½†æ˜¯éƒ½æ˜¯åœ¨ä¸€å°èŠ‚ç‚¹ä¸Šçš„","like_count":6,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529368,"discussion_content":"æ­£è§£ï¼Œæ»¡åˆ†ğŸ’¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635425513,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2446756,"avatar":"https://static001.geekbang.org/account/avatar/00/25/55/a4/a06abd2d.jpg","nickname":"é’Ÿå¼º","note":"","ucode":"C4227385241E70","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555540,"discussion_content":"è¯·é—®è¿™é‡Œçš„è®¡ç®—èŠ‚ç‚¹æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ worker? executor? task ?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646968838,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341374,"user_name":"Spoon","can_delete":false,"product_type":"c1","uid":1959822,"ip_address":"","ucode":"2FF9193AD482C2","user_header":"https://static001.geekbang.org/account/avatar/00/1d/e7/8e/318cfde0.jpg","comment_is_top":false,"comment_ctime":1649570621,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5944537917","product_id":100090001,"comment_content":"Javaä»£ç å®ç°<br>https:&#47;&#47;github.com&#47;Spoon94&#47;spark-practice&#47;blob&#47;master&#47;src&#47;main&#47;java&#47;com&#47;spoon&#47;spark&#47;sql&#47;DataFrameOperatorJob.java","like_count":2},{"had_liked":false,"id":347074,"user_name":"Geek_b2839b","can_delete":false,"product_type":"c1","uid":2876299,"ip_address":"","ucode":"6D8ABA989AB724","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIw0Nnvrrt9fV1wHVfBlPzrZmxNCRTbWPfNEbCEMtuoj6gw0LlMbbS3gtRLgLMfCoAV3TXsk5giavw/132","comment_is_top":false,"comment_ctime":1653696247,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653696247","product_id":100090001,"comment_content":"è€å¸ˆè¯·é—®ä¸€ä¸‹ï¼Œä½¿ç”¨sparkåŒæ­¥hiveæ•°æ®åˆ°Oracleçš„æ—¶å€™ï¼Œç”±äºexecutorå¤±è´¥é‡è¯•ï¼Œå¯¼è‡´å¶å°”å‡ºç°åŒæ­¥æ—¶hiveæ•°æ®å’ŒOracleæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œè¿™ä¸ªè¯¥æ€ä¹ˆè§£å†³å‘¢","like_count":0},{"had_liked":false,"id":330775,"user_name":"å°æ","can_delete":false,"product_type":"c1","uid":1903790,"ip_address":"","ucode":"30BD251EE1B1E2","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/iaQgtbE98VGIVIyribdo6dgLOnaNoe7ZdUuPr60ibsduibscrzQCTzdW2AfL9nxwe8YlSK75gOnK3YbAJKTaFPxibdg/132","comment_is_top":false,"comment_ctime":1642152517,"is_pvip":false,"replies":[{"id":"120673","content":"è¿™ä¸¤æ¡è¯­å¥çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œåœ¨spark sqlé‡Œé¢çš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œåœ¨æ•ˆæœæ–¹é¢ï¼Œå®Œå…¨ä¸€æ ·ã€‚åƒä½ è¯´çš„ï¼Œä¹Ÿä¼šåšmapç«¯èšåˆï¼Œè¿™äº›ä¼˜åŒ–æœºåˆ¶ï¼Œéƒ½æ˜¯æœ‰çš„~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1642257248,"ip_address":"","comment_id":330775,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1642152517","product_id":100090001,"comment_content":"è¯·é—®ä¸€ä¸‹ï¼šdf.select().groupBy().count()ä¸df.select().groupBy().agg(count(lit(1)))å†…éƒ¨å¤„ç†é€»è¾‘ä¼šä¸ä¸€æ ·å—ï¼Œè¿˜æ˜¯ä¼šéƒ½ä¼šç»è¿‡spark sqlä¼˜åŒ–å¼•æ“ä¼˜åŒ–æˆmapé˜¶æ®µé¢„èšåˆï¼Ÿæ¯”å¦‚ä¼šä¸ä¼šåƒrddçš„aggregateByKeyæˆ–è€…reduceByKeyä¸€æ ·åœ¨shuffle writeé˜¶æ®µåšpartitionå†…çš„é¢„èšåˆã€‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546257,"discussion_content":"è¿™ä¸¤æ¡è¯­å¥çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œåœ¨spark sqlé‡Œé¢çš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œåœ¨æ•ˆæœæ–¹é¢ï¼Œå®Œå…¨ä¸€æ ·ã€‚åƒä½ è¯´çš„ï¼Œä¹Ÿä¼šåšmapç«¯èšåˆï¼Œè¿™äº›ä¼˜åŒ–æœºåˆ¶ï¼Œéƒ½æ˜¯æœ‰çš„~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642257248,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323319,"user_name":"Geek_935079","can_delete":false,"product_type":"c1","uid":2851472,"ip_address":"","ucode":"85BFB004D53AA5","user_header":"","comment_is_top":false,"comment_ctime":1637831977,"is_pvip":false,"replies":[{"id":"117417","content":"æ˜¯çš„~ è¿™é‡Œtypoäº†ï¼Œæ„Ÿè°¢è€å¼Ÿæé†’~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1637987434,"ip_address":"","comment_id":323319,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1637831977","product_id":100090001,"comment_content":"val aggResult = fullInfo.groupByè¿™é‡Œæ˜¯ä¸æ˜¯è¦æ”¹ä¸ºval aggResult = jointDF.groupBy","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":533830,"discussion_content":"æ˜¯çš„~ è¿™é‡Œtypoäº†ï¼Œæ„Ÿè°¢è€å¼Ÿæé†’~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637987434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3078266,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/f8/7a/b3b5e29e.jpg","nickname":"Li,Yanjie","note":"","ucode":"708A4982F272C2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588699,"discussion_content":"å—¯ã€‚æˆ‘è¿˜åœ¨çº³é—·ï¼Œè¿™ä¸ªfullInfoä»å“ªé‡Œæ¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664010319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317800,"user_name":"ç«ç‚ç„±ç‡š","can_delete":false,"product_type":"c1","uid":2767491,"ip_address":"","ucode":"DB11784DD94059","user_header":"https://static001.geekbang.org/account/avatar/00/2a/3a/83/74e3fabd.jpg","comment_is_top":false,"comment_ctime":1634973579,"is_pvip":false,"replies":[{"id":"115458","content":"ğŸ‘ğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1635258628,"ip_address":"","comment_id":317800,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634973579","product_id":100090001,"comment_content":"<br># 5-åˆ†æç±»ç®—å­<br># åˆ›å»ºå‘˜å·¥df<br>seq=[(1,&#39;Mike&#39;,28,&#39;Male&#39;),<br>     (2, &quot;Lily&quot;, 30, &quot;Female&quot;),<br>     (3, &quot;Raymond&quot;, 26, &quot;Male&quot;)]<br>employees=spark.createDataFrame(seq,[&#39;id&#39;,&#39;name&#39;,&#39;age&#39;,&#39;gender&#39;])<br>employees.show()<br><br># åˆ›å»ºè–ªæ°´df<br>seq2=[(1, 26000), (2, 30000), (4, 25000), (3, 20000)]<br>salaries=spark.createDataFrame(seq2,[&#39;id&#39;,&#39;salary&#39;])<br>salaries.show()<br><br># å°†å‘˜å·¥dfå’Œè–ªæ°´dfè¿›è¡Œåˆå¹¶ï¼Œinneræ–¹å¼ï¼š<br>joinDF=salaries.join(employees,&#39;id&#39;,&#39;inner&#39;)<br>joinDF.show()<br><br># æŒ‰ç…§æ€§åˆ«ç»Ÿè®¡å‡ºè–ªæ°´ä¹‹å’Œï¼Œå¹³å‡å€¼<br>from pyspark.sql import functions as f<br>aggResult=joinDF.groupBy(&#39;gender&#39;).agg(f.sum(&#39;salary&#39;).alias(&#39;sum_salary&#39;),f.avg(&#39;salary&#39;).alias(&#39;avg_salary&#39;))<br>aggResult.show()<br><br># æ’åºï¼Œsortæ–¹æ³•å’ŒorderByæ–¹æ³•ä¸€æ ·<br>aggResult.sort(f.desc(&#39;sum_salary&#39;),f.asc(&#39;gender&#39;)).show()<br>aggResult.orderBy(f.desc(&#39;sum_salary&#39;),f.asc(&#39;gender&#39;)).show()","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528980,"discussion_content":"ğŸ‘ğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635258628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317799,"user_name":"ç«ç‚ç„±ç‡š","can_delete":false,"product_type":"c1","uid":2767491,"ip_address":"","ucode":"DB11784DD94059","user_header":"https://static001.geekbang.org/account/avatar/00/2a/3a/83/74e3fabd.jpg","comment_is_top":false,"comment_ctime":1634973566,"is_pvip":false,"replies":[{"id":"115457","content":"è¾›è‹¦è€å¼Ÿ~ å¤ªæ£’äº†ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1635258610,"ip_address":"","comment_id":317799,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634973566","product_id":100090001,"comment_content":"python ä»£ç ä¸ºï¼š<br><br># 1-SQLè¯­å¥ï¼š<br>from pyspark import SparkContext, SparkConf<br>from pyspark.sql.session import SparkSession<br>sc = SparkContext()<br>spark = SparkSession(sc)<br><br>seq=[(&#39;Alice&#39;,18), (&#39;Bob&#39;,14)]<br>column = [&#39;name&#39;,&#39;age&#39;]<br>df=spark.createDataFrame(seq,column)<br>df.createTempView(&#39;t1&#39;)<br>query=&quot;select * from t1&quot;<br>result=spark.sql(query)<br>result.show()<br><br># 2-æ¢ç´¢ç±»ç®—å­ï¼š<br>employees=[(1, &quot;John&quot;, 26, &quot;Male&quot;), (2, &quot;Lily&quot;, 28, &quot;Female&quot;), (3, &quot;Raymond&quot;, 30, &quot;Male&quot;)]<br>employeesDF=spark.createDataFrame(employees,[&#39;id&#39;,&#39;name&#39;,&#39;age&#39;,&#39;gender&#39;])<br>employeesDF.printSchema()<br>employeesDF.show() <br>age_df=employeesDF.describe(&#39;age&#39;)<br>age_df.show()<br><br># 3-æ¸…æ´—ç±»ç®—å­ï¼š<br># åˆ é™¤æŸä¸€åˆ—æ•°æ®<br>employeesDF.drop(&#39;gender&#39;).show()<br># distinctå¯¹æ‰€æœ‰æ•°æ®å»é‡ï¼Œæ³¨æ„æ— æ³•è®¾ç½®åˆ—å<br>employeesDF.distinct().show()<br># dropDuplicateså¯ä»¥å¯¹æŸå‡ åˆ—å»é‡ï¼Œçµæ´»æ€§æ›´é«˜<br>employeesDF.dropDuplicates([&#39;gender&#39;]).show()<br><br># 4-è½¬æ¢ç±»ç®—å­<br># é€‰æ‹©æŸå‡ åˆ—ç»„æˆæ–°çš„df<br>employeesDF.select([&#39;name&#39;,&#39;gender&#39;]).show()<br>employeesDF.select(&#39;name&#39;).show()<br># selectExprç”¨é€‰æ‹©è¡¨è¾¾å¼æ¥ç»„æˆæ–°çš„df<br>employeesDF.selectExpr(&quot;id&quot;, &quot;name&quot;, &quot;concat(id, &#39;_&#39;, name) as id_name&quot;).show()<br># whereé€‰æ‹©æ»¡è¶³æ¡ä»¶çš„å†…å®¹<br>employeesDF.where(&quot;gender=&#39;Male&#39;&quot;).show()<br># å¯¹åˆ—åé‡å‘½åï¼šå°†genderé‡å‘½åä¸ºsex<br>employeesDF.withColumnRenamed(&#39;gender&#39;,&#39;sex&#39;).show() <br># åœ¨åŸåˆ—è¿›è¡Œä¿®æ”¹åç»„æˆæ–°çš„ä¸€åˆ—ï¼Œå°†ageéƒ½+10å²<br>employeesDF.withColumn(&quot;crypto&quot;, employeesDF[&#39;age&#39;]+10).show()<br># dropåˆ é™¤æŸä¸€åˆ—<br>employeesDF.withColumn(&quot;crypto&quot;, employeesDF[&#39;age&#39;]+10).drop(&#39;age&#39;).show()<br><br># explodeæ‹†åˆ†list<br>seq2 =[(1, &quot;John&quot;, 26, &quot;Male&quot;,[&quot;Sports&quot;, &quot;News&quot;]),<br>(2, &quot;Lily&quot;, 28, &quot;Female&quot;, [&quot;Shopping&quot;, &quot;Reading&quot;]),<br>(3, &quot;Raymond&quot;, 30, &quot;Male&quot;, [&quot;Sports&quot;, &quot;Reading&quot;])]<br>employeesDF2=spark.createDataFrame(seq2,[&#39;id&#39;,&#39;name&#39;,&#39;age&#39;,&#39;gender&#39;,&#39;interests&#39;])<br>from pyspark.sql.functions import explode<br>employeesDF2.withColumn(&#39;interest&#39;,explode(employeesDF2[&#39;interests&#39;])).show()","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528979,"discussion_content":"è¾›è‹¦è€å¼Ÿ~ å¤ªæ£’äº†ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635258610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316747,"user_name":"å°ç²é“›ğŸ¯","can_delete":false,"product_type":"c1","uid":2768136,"ip_address":"","ucode":"C9608A91BA66A0","user_header":"https://static001.geekbang.org/account/avatar/00/2a/3d/08/fcf92621.jpg","comment_is_top":false,"comment_ctime":1634539174,"is_pvip":false,"replies":[{"id":"114725","content":"æ²¡é”™ï¼ŒcreateOrReplaceTempViewæ›´å®ç”¨ï¼Œé¿å…é‡å¤å»ºè¡¨å¸¦æ¥çš„æŠ¥é”™~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1634571759,"ip_address":"","comment_id":316747,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634539174","product_id":100090001,"comment_content":"è‡ªå·±å¼€å‘çš„æ—¶å€™createTempViewä¼šåœ¨å†…å­˜ä¸­åˆ›å»ºä¸´æ—¶è¡¨,é‡æ–°è¿è¡Œçš„è¯ä¼šæŠ¥table is exist é”™è¯¯,å»ºè®®ä½¿ç”¨ createOrReplaceTempView","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528486,"discussion_content":"æ²¡é”™ï¼ŒcreateOrReplaceTempViewæ›´å®ç”¨ï¼Œé¿å…é‡å¤å»ºè¡¨å¸¦æ¥çš„æŠ¥é”™~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634571759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316544,"user_name":"GACÂ·DU","can_delete":false,"product_type":"c1","uid":1385403,"ip_address":"","ucode":"7847FBE1C13740","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg","comment_is_top":false,"comment_ctime":1634379265,"is_pvip":true,"replies":[{"id":"114724","content":"è¯´åˆ°Shuffleï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦åˆ†ç±»è®¨è®ºã€‚<br><br>é‡åˆ†åŒºç®—å­repartitionã€ByKeyç®—å­ç¡®å®ä¼šå¼•å…¥Shuffleï¼Œè¿™ä¸ªæ˜¯ç¡®å®šæ€§çš„ã€‚<br><br>ä¸ç¡®å®šçš„æ˜¯joinï¼Œä¸€èˆ¬æ¥è¯´ï¼Œjoinéƒ½ä¼šå¼•å…¥Shuffleã€‚ä¸è¿‡æœ‰ä¸€ç§ç‰¹æ®Šçš„joinï¼Œå­¦åå«Collocated Joinï¼Œè¿™ç§joinæ˜¯ä¸ä¼šå¼•å…¥Shuffleçš„ã€‚<br><br>åå­—å¬ä¸Šå»æŒºå”¬äººï¼Œä½†æœ¬è´¨ä¸Šï¼Œå°±æ˜¯å‚ä¸joinçš„ä¸¤å¼ è¡¨ï¼Œæå‰æŒ‰ç…§join keysï¼Œåšå¥½äº†åˆ†åŒºã€‚å› è€Œåœ¨joinçš„æ—¶å€™ï¼Œè‡ªç„¶å°±ä¸ä¼šæœ‰Shuffleäº†ã€‚ä¸è¿‡å®é™…åº”ç”¨ä¸­ï¼ŒCollocated Joinåœºæ™¯å¹¶ä¸å¤šï¼Œå› æ­¤æš‚æ—¶å¯ä»¥å¿½ç•¥æ‰~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1634571675,"ip_address":"","comment_id":316544,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634379265","product_id":100090001,"comment_content":"Sparkä¸­Shuffleç®—å­çš„åˆ†ç±»ï¼šé‡åˆ†åŒºç®—å­ã€ByKeyç®—å­ã€Joinç®—å­","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528408,"discussion_content":"è¯´åˆ°Shuffleï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦åˆ†ç±»è®¨è®ºã€‚\n\né‡åˆ†åŒºç®—å­repartitionã€ByKeyç®—å­ç¡®å®ä¼šå¼•å…¥Shuffleï¼Œè¿™ä¸ªæ˜¯ç¡®å®šæ€§çš„ã€‚\n\nä¸ç¡®å®šçš„æ˜¯joinï¼Œä¸€èˆ¬æ¥è¯´ï¼Œjoinéƒ½ä¼šå¼•å…¥Shuffleã€‚ä¸è¿‡æœ‰ä¸€ç§ç‰¹æ®Šçš„joinï¼Œå­¦åå«Collocated Joinï¼Œè¿™ç§joinæ˜¯ä¸ä¼šå¼•å…¥Shuffleçš„ã€‚\n\nåå­—å¬ä¸Šå»æŒºå”¬äººï¼Œä½†æœ¬è´¨ä¸Šï¼Œå°±æ˜¯å‚ä¸joinçš„ä¸¤å¼ è¡¨ï¼Œæå‰æŒ‰ç…§join keysï¼Œåšå¥½äº†åˆ†åŒºã€‚å› è€Œåœ¨joinçš„æ—¶å€™ï¼Œè‡ªç„¶å°±ä¸ä¼šæœ‰Shuffleäº†ã€‚ä¸è¿‡å®é™…åº”ç”¨ä¸­ï¼ŒCollocated Joinåœºæ™¯å¹¶ä¸å¤šï¼Œå› æ­¤æš‚æ—¶å¯ä»¥å¿½ç•¥æ‰~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634571675,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}