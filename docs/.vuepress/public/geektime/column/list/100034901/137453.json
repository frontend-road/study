{"id":137453,"title":"11 | æœŸä¸­å®æˆ˜ï¼šåŠ¨æ‰‹å†™ä¸€ä¸ªç®€æ˜“ç‰ˆçš„IMç³»ç»Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è¢æ­¦æ—ã€‚</p><p>åˆ°ä¸Šä¸€è®²ä¸ºæ­¢ï¼ŒIMçš„ç›¸å…³è¯¾ç¨‹å·²ç»è¿›è¡Œè¿‡åŠï¼Œåœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºçš„å¤§éƒ¨åˆ†å†…å®¹éƒ½æ¯”è¾ƒåç†è®ºï¼Œä½ ç†è§£èµ·æ¥å¯èƒ½ä¼šæ¯”è¾ƒæŠ½è±¡ã€‚ä¸ºäº†è®©ä½ å¯¹å‰é¢è®²åˆ°çš„çŸ¥è¯†æœ‰æ›´æ·±å…¥çš„ç†è§£ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å›é¡¾ã€æ¢³ç†è¿‘æœŸå­¦ä¹ çš„å†…å®¹ï¼Œä¸€èµ·å°è¯•æ­å»ºä¸€ä¸ªç®€å•çš„IMèŠå¤©ç³»ç»Ÿã€‚</p><p><strong>åœ¨å¼€å§‹ä¹‹å‰å‘¢ï¼Œæˆ‘å…ˆæ¥è¯´æ˜ä¸€ä¸‹IMè¯¾ç¨‹çš„æœŸä¸­ã€æœŸæœ«å®æˆ˜çš„è¯¾ç¨‹è®¡åˆ’å’Œè®¾è®¡æ€è·¯ã€‚</strong></p><p>æœŸä¸­å’ŒæœŸæœ«å®æˆ˜æ˜¯å¸Œæœ›ä½ ä»¥è‡ªå·±åŠ¨æ‰‹å®ç°ä¸ºä¸»ï¼Œæä¾›çš„Demoä¸»è¦ä½œä¸ºå‚è€ƒï¼Œåœ¨è®¾è®¡å±‚é¢ä¸Šï¼Œå¹¶ä¸èƒ½è®©ä½ ç›´æ¥ç”¨äºçº¿ä¸Šä½¿ç”¨ã€‚</p><p>æœ¬æ¬¡æœŸä¸­å®æˆ˜Demoçš„ä¸»è¦å…³æ³¨ç‚¹æ˜¯ï¼šæ¶ˆæ¯çš„å­˜å‚¨ã€æœªè¯»æ•°çš„è®¾è®¡ï¼Œå¹¶ä»¥â€œçŸ­è½®è¯¢â€çš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯çš„å®æ—¶è§¦è¾¾ã€‚å¸Œæœ›ä½ èƒ½ä»ç”¨æˆ·çš„ä½¿ç”¨åœºæ™¯å‡ºå‘ï¼Œæ¥ç†è§£æ¶ˆæ¯å­˜å‚¨è®¾è®¡çš„æ€è·¯ï¼Œä»¥åŠæœªè¯»æ•°ç‹¬ç«‹ä¸¤å¥—å­˜å‚¨çš„å¿…è¦æ€§ã€‚</p><p>å¦å¤–ï¼Œåœ¨æœŸæœ«å®æˆ˜ä¸­ï¼Œæˆ‘ä¼šä»â€œçŸ­è½®è¯¢â€æ–¹å¼è°ƒæ•´ä¸ºWebSocketé•¿è¿æ¥çš„æ–¹å¼ï¼Œå¹¶ä¸”åŠ ä¸ŠACKæœºåˆ¶ã€åº”ç”¨å±‚å¿ƒè·³ç­‰ç‰¹æ€§ã€‚å¸Œæœ›ä½ èƒ½åœ¨ä¸¤æ¬¡å®æˆ˜ä¸­ï¼Œé€šè¿‡å¯¹æ¯”ï¼ŒçœŸæ­£ç†è§£é•¿è¿æ¥æ–¹å¼ç›¸æ¯”â€œçŸ­è½®è¯¢â€æ–¹å¼çš„ä¼˜åŠ¿ï¼Œå¹¶ä¸”é€šè¿‡ACKæœºåˆ¶å’Œåº”ç”¨å±‚å¿ƒè·³ï¼ŒçœŸæ­£ç†è§£ä¸ºä»€ä¹ˆå®ƒä»¬èƒ½å¤Ÿè§£å†³â€œæ•°æ®ä¸¢å¤±â€å’Œâ€œè¿æ¥å¯é æ€§â€çš„é—®é¢˜ã€‚</p><p>OKï¼Œä¸‹é¢æˆ‘ä»¬è¯´å›æœ¬æ¬¡å®æˆ˜ã€‚</p><p>è¿™ä¸ªèŠå¤©ç³»ç»Ÿè¦æ±‚å¹¶ä¸å¤æ‚ï¼Œåªéœ€è¦æ„å»ºç®€å•çš„Webç•Œé¢ï¼ˆæ²¡æœ‰ç•Œé¢é€šè¿‡å‘½ä»¤è¡Œèƒ½å®ç°ä¹Ÿè¡Œï¼‰ã€‚æˆ‘åœ¨è¿™é‡Œå†™äº†ä¸€ä¸ªç®€æ˜“ç‰ˆçš„Demoï¼Œä¾›ä½ å‚è€ƒã€‚</p><!-- [[[read_end]]] --><p>ç¤ºä¾‹ä»£ç ä½ å¯ä»¥åœ¨<a href=\"https://github.com/coldwalker/Sample\">GitHub</a>ä¸Šä¸‹è½½ã€‚</p><h2>éœ€æ±‚æ¢³ç†</h2><p>è¿™ä¸ªç®€æ˜“èŠå¤©ç³»ç»Ÿçš„å¤§æ¦‚è¦æ±‚æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul>\n<li>æ”¯æŒç”¨æˆ·ç™»å½•ï¼›</li>\n<li>åŒæ–¹æ”¯æŒç®€å•çš„æ–‡æœ¬èŠå¤©ï¼›</li>\n<li>æ”¯æŒæ¶ˆæ¯æœªè¯»æ•°ï¼ˆåŒ…æ‹¬æ€»æœªè¯»å’Œä¼šè¯æœªè¯»ï¼‰ï¼›</li>\n<li>æ”¯æŒè”ç³»äººé¡µå’Œæœªè¯»æ•°æœ‰æ–°æ¶ˆæ¯çš„è‡ªåŠ¨æ›´æ–°ï¼›</li>\n<li>æ”¯æŒèŠå¤©é¡µæœ‰æ–°æ¶ˆæ¯æ—¶è‡ªåŠ¨æ›´æ–°ã€‚</li>\n</ul><h2>éœ€æ±‚åˆ†æ</h2><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹æ•´ä½“éœ€æ±‚ã€‚</p><p><strong>é¦–å…ˆï¼Œè¦æ”¯æŒç”¨æˆ·ç™»å½•ï¼Œå…ˆè¦æœ‰â€œç”¨æˆ·â€</strong>ã€‚å¯¹åº”çš„æ•°æ®åº•å±‚éœ€è¦æœ‰ä¸€ä¸ªç”¨æˆ·è¡¨ï¼Œç”¨æˆ·è¡¨çš„è®¾è®¡å¯ä»¥æ¯”è¾ƒç®€å•ï¼Œèƒ½å¤Ÿæ”¯æŒå”¯ä¸€çš„UIDå’Œå¯†ç ç”¨äºç™»å½•å³å¯ã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰ç”¨æˆ·å¤´åƒä¿¡æ¯ï¼ŒèŠå¤©æ—¶çš„ä½“éªŒä¼šæ›´å¥½ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¹ŸåŠ ä¸€ä¸‹ã€‚ç®€å•çš„åº“è¡¨è®¾è®¡å¯ä»¥æ˜¯è¿™æ ·çš„ï¼š</p><pre><code>CREATE TABLE IM_USER (\nuid INT PRIMARY KEY,\nusername VARCHAR(500) NOT NULL,\npassword VARCHAR(500) NOT NULL,\nemail VARCHAR(250) DEFAULT NULL,\navatar VARCHAR(500) NOT NULL\n);\n</code></pre><p>å¯¹åº”çš„å®ä½“ç±»Userå­—æ®µå’Œåº“è¡¨ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸ç½—åˆ—äº†ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ç”¨æˆ·é€šè¿‡é‚®ç®±å’Œå¯†ç æ¥ç™»å½•ã€‚å› ä¸ºè¯¾ç¨‹ä¸»è¦æ˜¯æ¶‰åŠIMç›¸å…³çš„çŸ¥è¯†ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹ç”¨æˆ·ä¿¡æ¯çš„ç»´æŠ¤å¯ä»¥ä¸åšè¦æ±‚ï¼Œå¯åŠ¨æ—¶å†…ç½®å‡ ä¸ªé»˜è®¤ç”¨æˆ·å³å¯ã€‚</p><p><strong>æœ‰äº†ç”¨æˆ·åï¼Œæ¥ä¸‹æ¥å°±æ˜¯äº’åŠ¨äº†ï¼Œè¿™ä¸€æœŸæˆ‘ä»¬åªéœ€è¦å…³æ³¨ç®€å•çš„æ–‡æœ¬èŠå¤©å³å¯</strong>ã€‚åœ¨è®¾è®¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…·ä½“çš„èŠå¤©æ¶ˆæ¯è¿›è¡Œå­˜å‚¨ï¼Œä¾¿äºåœ¨Webç«¯ä½¿ç”¨ï¼Œå› æ­¤å¯ä»¥ç®€å•åœ°æŒ‰ç…§â€œ<a href=\"https://time.geekbang.org/column/article/127978\">02 | æ¶ˆæ¯æ”¶å‘æ¶æ„ï¼šä¸ºä½ çš„Appï¼ŒåŠ ä¸Šå®æ—¶é€šä¿¡åŠŸèƒ½</a>â€ä¸­è®²åˆ°çš„æ¶ˆæ¯å­˜å‚¨æ¥å®ç°æ­¤é¡¹åŠŸèƒ½ã€‚</p><p>æ¶ˆæ¯çš„å­˜å‚¨å¤§æ¦‚åˆ†ä¸ºæ¶ˆæ¯å†…å®¹è¡¨ã€æ¶ˆæ¯ç´¢å¼•è¡¨ã€è”ç³»äººåˆ—è¡¨ï¼Œè¿™é‡Œæˆ‘ç”¨æœ€åŸºç¡€çš„å­—æ®µæ¥ç»™ä½ æ¼”ç¤ºä¸€ä¸‹ã€‚å•åº“å•è¡¨çš„è®¾è®¡å¦‚ä¸‹ï¼š</p><pre><code>æ¶ˆæ¯å†…å®¹è¡¨ï¼š\n\nCREATE TABLE IM_MSG_CONTENT (\nmid INT AUTO_INCREMENT  PRIMARY KEY,\ncontent VARCHAR(1000) NOT NULL,\nsender_id INT NOT NULL,\nrecipient_id INT NOT NULL,\nmsg_type INT NOT NULL,\ncreate_time TIMESTAMP NOT NUll\n);\n</code></pre><pre><code>æ¶ˆæ¯ç´¢å¼•è¡¨ï¼š\n\nCREATE TABLE IM_MSG_RELATION (\nowner_uid INT NOT NULL,\nother_uid INT NOT NULL,\nmid INT NOT NULL,\ntype INT NOT NULL,\ncreate_time TIMESTAMP NOT NULL,\nPRIMARY KEY (`owner_uid`,`mid`)\n);\nCREATE INDEX `idx_owneruid_otheruid_msgid` ON  IM_MSG_RELATION(`owner_uid`,`other_uid`,`mid`);\n</code></pre><pre><code>è”ç³»äººåˆ—è¡¨ï¼š\n\nCREATE TABLE IM_MSG_CONTACT (\nowner_uid INT NOT NULL,\nother_uid INT NOT NULL,\nmid INT NOT NULL,\ntype INT NOT NULL,\ncreate_time TIMESTAMP NOT NULL,\nPRIMARY KEY (`owner_uid`,`other_uid`)\n);\n</code></pre><ul>\n<li><strong>æ¶ˆæ¯å†…å®¹è¡¨</strong>ï¼šç”±äºåªæ˜¯å•åº“å•è¡¨ï¼Œæ¶ˆæ¯IDé‡‡ç”¨è‡ªå¢ä¸»é”®ï¼Œä¸»è¦åŒ…æ‹¬æ¶ˆæ¯IDå’Œæ¶ˆæ¯å†…å®¹ã€‚</li>\n<li><strong>æ¶ˆæ¯ç´¢å¼•è¡¨</strong>ï¼šä½¿ç”¨äº†ç´¢å¼•â€œå½’å±äººâ€å’Œæ¶ˆæ¯IDä½œä¸ºè”åˆä¸»é”®ï¼Œå¯ä»¥é¿å…é‡å¤å†™å…¥ï¼Œå¹¶å¢åŠ äº†â€œå½’å±äººâ€å’Œâ€œå…³è”äººâ€åŠæ¶ˆæ¯IDçš„ç´¢å¼•ï¼Œç”¨äºæŸ¥è¯¢åŠ é€Ÿã€‚</li>\n<li><strong>è”ç³»äººåˆ—è¡¨</strong>ï¼šå­—æ®µå’Œç´¢å¼•è¡¨ä¸€è‡´ï¼Œä¸åŒç‚¹åœ¨äºé‡‡ç”¨â€œå½’å±äººâ€å’Œâ€œå…³è”äººâ€ä½œä¸ºä¸»é”®ï¼Œå¯ä»¥é¿å…åŒä¸€ä¸ªä¼šè¯æœ‰è¶…è¿‡ä¸€æ¡çš„è”ç³»äººè®°å½•ã€‚</li>\n</ul><p>æ¶ˆæ¯ç›¸å…³å®ä½“å±‚ç±»çš„æ•°æ®ç»“æ„å’Œåº“è¡¨çš„å­—æ®µåŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œä¸å†åˆ—å‡ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸ºäº†æ¼”ç¤ºçš„ç®€å•æ–¹ä¾¿ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰é‡‡ç”¨åˆ†åº“åˆ†è¡¨çš„è®¾è®¡ï¼Œæ‰€ä»¥åˆ†åº“çš„Shardingè§„åˆ™ä½ éœ€è¦ç»“åˆç”¨æˆ·æ¶ˆæ¯æ”¶å‘å’ŒæŸ¥çœ‹çš„åœºæ™¯ï¼Œå¤šåŠ è€ƒè™‘ä¸€ä¸‹åº“è¡¨çš„è®¾è®¡ã€‚</p><p><strong>OKï¼Œæœ‰äº†ç”¨æˆ·å’Œæ¶ˆæ¯å­˜å‚¨åŠŸèƒ½ï¼Œç°åœ¨æ¥çœ‹å¦‚ä½•æ”¯æŒæ¶ˆæ¯æœªè¯»æ•°ã€‚</strong></p><p>åœ¨â€œ<a href=\"https://time.geekbang.org/column/article/132598\">07 | åˆ†å¸ƒå¼é”å’ŒåŸå­æ€§ï¼šä½ çœ‹åˆ°çš„æœªè¯»æ¶ˆæ¯æé†’æ˜¯çœŸçš„å—ï¼Ÿ</a>â€ä¸€è®²ä¸­ï¼Œæˆ‘è®²åˆ°äº†æ¶ˆæ¯æœªè¯»æ•°åœ¨èŠå¤©åœºæ™¯ä¸­çš„é‡è¦æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹ŸæŠŠæœªè¯»æ•°ç›¸å…³çš„åŠŸèƒ½åŠ ä¸Šæ¥ã€‚</p><p>æœªè¯»æ•°åˆ†ä¸ºæ€»æœªè¯»å’Œä¼šè¯æœªè¯»ï¼Œæ€»æœªè¯»è™½ç„¶æ˜¯ä¼šè¯æœªè¯»ä¹‹å’Œï¼Œä½†ç”±äºä½¿ç”¨é¢‘ç‡å¾ˆé«˜ï¼Œä¼šè¯å¾ˆå¤šæ—¶å€™èšåˆèµ·æ¥æ€§èƒ½æ¯”è¾ƒå·®ï¼Œæ‰€ä»¥å†—ä½™äº†æ€»æœªè¯»æ¥å•ç‹¬å­˜å‚¨ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥é‡‡ç”¨Redisæ¥è¿›è¡Œå­˜å‚¨ï¼Œæ€»æœªè¯»å¯ä»¥ä½¿ç”¨ç®€å•çš„K-Vï¼ˆKey-Valueï¼‰ç»“æ„å­˜å‚¨ï¼Œä¼šè¯æœªè¯»ä½¿ç”¨Hashç»“æ„å­˜å‚¨ã€‚å¤§æ¦‚çš„å­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</p><pre><code>æ€»æœªè¯»ï¼š\nowneruid_T, 2\n\nä¼šè¯æœªè¯»ï¼š\nowneruid_C, otheruid1, 1\nowneruid_C, otheruid2, 1\n</code></pre><p><strong>æœ€åï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•æ”¯æŒæ¶ˆæ¯å’Œæœªè¯»è‡ªåŠ¨æ›´æ–°ã€‚</strong></p><p>åœ¨â€œ<a href=\"https://time.geekbang.org/column/article/128942\">03 | è½®è¯¢ä¸é•¿è¿æ¥ï¼šå¦‚ä½•è§£å†³æ¶ˆæ¯çš„å®æ—¶åˆ°è¾¾é—®é¢˜ï¼Ÿ</a>â€ä¸€è®²ä¸­ï¼Œæˆ‘è®²åˆ°äº†ä¿è¯æ¶ˆæ¯å®æ—¶æ€§çš„ä¸‰ç§å¸¸è§æ–¹å¼ï¼šçŸ­è½®è¯¢ã€é•¿è½®è¯¢ã€é•¿è¿æ¥ã€‚å¯¹äºæ¶ˆæ¯å’Œæœªè¯»çš„è‡ªåŠ¨æ›´æ–°çš„è®¾è®¡ï¼Œä½ å¯ä»¥é‡‡ç”¨å…¶ä¸­ä»»æ„ä¸€ç§ï¼Œæˆ‘å®ç°çš„ç®€ç‰ˆä»£ç é‡Œå°±æ˜¯é‡‡ç”¨çš„â€œçŸ­è½®è¯¢â€æ¥åœ¨è”ç³»äººé¡µé¢å’ŒèŠå¤©é¡µé¢è½®è¯¢æœªè¯»å’Œæ–°æ¶ˆæ¯çš„ã€‚å®ç°ä¸Šæ¯”è¾ƒç®€å•ï¼ŒWebç«¯æ ¸å¿ƒä»£ç å’ŒæœåŠ¡ç«¯æ ¸å¿ƒä»£ç å¦‚ä¸‹ã€‚</p><pre><code>Webç«¯æ ¸å¿ƒä»£ç ï¼š\n\nnewMsgLoop = setInterval(queryNewcomingMsg, 3000);\n$.get(\n    '/queryMsgSinceMid',\n    {\n        ownerUid: ownerUid,\n        otherUid: otherUid,\n        lastMid: lastMid\n    },\n    function (msgsJson) {\n        var jsonarray = $.parseJSON(msgsJson);\n        var ul_pane = $('.chat-thread');\n        var owner_uid_avatar, other_uid_avatar;\n        $.each(jsonarray, function (i, msg) {\n            var relation_type = msg.type;\n            owner_uid_avatar = msg.ownerUidAvatar;\n            other_uid_avatar = msg.otherUidAvatar;\n\n\n            var ul_pane = $('.chat-thread');\n            var li_current = $('&lt;li&gt;&lt;/li&gt;');//åˆ›å»ºä¸€ä¸ªli\n            li_current.text(msg.content);\n            ul_pane.append(li_current);\n        });\n    });\n)ï¼›\n</code></pre><pre><code>æœåŠ¡ç«¯æ ¸å¿ƒä»£ç ï¼š\n\nList&lt;MessageVO&gt; msgList = Lists.newArrayList();\nList&lt;MessageRelation&gt; relationList =    relationRepository.findAllByOwnerUidAndOtherUidAndMidIsGreaterThanOrderByMidAsc(ownerUid, otherUid, fromMid);\n\n/** å…ˆæ‹¼æ¥æ¶ˆæ¯ç´¢å¼•å’Œå†…å®¹ */\nUser self = userRepository.findOne(ownerUid);\nUser other = userRepository.findOne(otherUid);\nrelationList.stream().forEach(relation -&gt; {\n    Long mid = relation.getMid();\n    MessageContent contentVO = contentRepository.findOne(mid);\n    if (null != contentVO) {\n        String content = contentVO.getContent();\n        MessageVO messageVO = new MessageVO(mid, content,   relation.getOwnerUid(), relation.getType(), relation.getOtherUid(), relation.getCreateTime(), self.getAvatar(), other.getAvatar());\n    msgList.add(messageVO);\n    }\n});\n\n/** å†å˜æ›´æœªè¯» */\nObject convUnreadObj = redisTemplate.opsForHash().get(ownerUid + Constants.CONVERSION_UNREAD_SUFFIX, otherUid);\nif (null != convUnreadObj) {\n    long convUnread = Long.parseLong((String) convUnreadObj);\n    redisTemplate.opsForHash().delete(ownerUid +    Constants.CONVERSION_UNREAD_SUFFIX, otherUid);\n    long afterCleanUnread =     redisTemplate.opsForValue().increment(ownerUid +    Constants.TOTAL_UNREAD_SUFFIX, -convUnread);\n\n/** ä¿®æ­£æ€»æœªè¯» */\nif (afterCleanUnread &lt;= 0) {\n    redisTemplate.delete(ownerUid + Constants.TOTAL_UNREAD_SUFFIX);\n}\nreturn msgList;\n</code></pre><p><strong>è¿™é‡Œéœ€è¦æ³¨æ„ä¸¤ä¸ªåœ°æ–¹ï¼š</strong></p><ul>\n<li>å…¶ä¸€ï¼Œç”±äºä¸šåŠ¡ä¸Šä½¿ç”¨çš„â€œæ¶ˆæ¯å¯¹è±¡â€å’Œå­˜å‚¨å±‚å¹¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥ä¸€èˆ¬é‡åˆ°è¿™ç§æƒ…å†µï¼Œä½ å¯ä»¥ä¸ºå±•ç°å±‚åœ¨å®ä½“å±‚åŸºç¡€ä¸Šåˆ›å»ºä¸€äº›VOå¯¹è±¡æ¥æ‰¿æ¥å±•ç¤ºéœ€è¦çš„æ•°æ®ã€‚æ¯”å¦‚ï¼Œæˆ‘åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªç”¨äºæ¶ˆæ¯å±•ç°çš„VOå¯¹è±¡MessageVOã€‚</li>\n<li>å…¶äºŒï¼Œåœ¨æœªè¯»æ•°çš„å®ç°ä¸Šï¼Œç”±äºåªæ˜¯æ¼”ç¤ºï¼Œè¿™é‡Œå¹¶æ²¡æœ‰åšåˆ°ä¸¤ä¸ªæœªè¯»çš„åŸå­å˜æ›´ï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæœªè¯»ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› æ­¤ä¸Šæ–¹ä»£ç æœ€åéƒ¨åˆ†æˆ‘ç®€å•å¯¹æ€»æœªè¯»åšäº†ä¸€ä¸ªä¸ºè´Ÿåçš„ä¿®æ­£ã€‚</li>\n</ul><h2>å…¶ä»–å®ç°ä¸Šçš„æ³¨æ„ç‚¹</h2><p>å‰é¢æˆ‘ä»¬ä»éœ€æ±‚æ¢³ç†å‡ºå‘ï¼ŒæŠŠè¿™ä¸ªç®€æ˜“èŠå¤©ç³»ç»Ÿæ ¸å¿ƒéƒ¨åˆ†çš„è®¾è®¡æ€è·¯å’Œæ ¸å¿ƒä»£ç è®²äº†ä¸€ä¸‹ï¼Œä¹Ÿå¼ºè°ƒäº†ä¸€ä¸‹è¿™å¥—ä»£ç å®ç°ä¸­å®¹æ˜“å‡ºç°é—®é¢˜çš„åœ°æ–¹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘å¸Œæœ›åœ¨ä»£ç å®ç°ä¸­ï¼Œä½ è¿˜èƒ½è€ƒè™‘ä»¥ä¸‹è¿™äº›é—®é¢˜ï¼Œè™½ç„¶è¿™äº›ä¸æ˜¯IMç³»ç»Ÿå®ç°ä¸­çš„æ ¸å¿ƒé—®é¢˜ï¼Œä½†å¯¹äºä»£ç çš„æ•´æ´å’Œè®¾è®¡çš„ä¹ æƒ¯åŸ¹å…»ä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜éå¸¸é‡è¦çš„è¦æ±‚ã€‚</p><h3>ä»£ç åˆ†å±‚</h3><p>é¦–å…ˆæ˜¯ä»£ç åˆ†å±‚æ–¹é¢ï¼Œæˆ‘ä»¬åœ¨ä»£ç å®ç°ä¸Šï¼Œåº”è¯¥å°½é‡è®©è¡¨ç°å±‚ã€ä¸šåŠ¡å±‚å’ŒæŒä¹…åŒ–å±‚èƒ½åˆ†ç¦»æ¸…æ¥šï¼Œåšåˆ°æ¯ä¸€å±‚çš„èŒè´£æ¸…æ™°æ˜ç¡®ï¼Œä¹Ÿéš”ç¦»äº†æ¯ä¸€å±‚çš„å®ç°ç»†èŠ‚ï¼Œä¾¿äºå¤šäººåä½œå¼€å‘ã€‚</p><p>è¡¨ç°å±‚æ§åˆ¶æ•°æ®è¾“å…¥å’Œè¾“å‡ºçš„æ ¡éªŒå’Œæ ¼å¼ï¼Œä¸æ¶‰åŠä¸šåŠ¡å¤„ç†ï¼›ä¸šåŠ¡å±‚ä¸æ¶‰åŠå±•ç°ç›¸å…³çš„ä»£ç ï¼Œåªè´Ÿè´£ä¸šåŠ¡é€»è¾‘çš„ç»„åˆï¼›æŒä¹…åŒ–å±‚è´Ÿè´£å’Œåº•å±‚èµ„æºçš„äº¤äº’ï¼Œåªè´Ÿè´£æ•°æ®çš„å†™å…¥ã€å˜æ›´å’Œè·å–ï¼Œä¸æ¶‰åŠå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><h3>ä¾èµ–èµ„æº</h3><p>å¦å¤–ï¼Œå¯¹äºä»£ç ä¸­ä½¿ç”¨åˆ°çš„WebæœåŠ¡å™¨ã€DBèµ„æºã€Redisèµ„æºç­‰ï¼Œæˆ‘ä»¬å°½é‡é€šè¿‡Embeddingçš„æ–¹å¼æ¥æä¾›ï¼Œè¿™æ ·ä¾¿äºåœ¨IDEä¸­æ‰§è¡Œå’Œä»£ç çš„è¿ç§»ä½¿ç”¨ã€‚</p><h2>å°ç»“</h2><p>è¿™ä¸€èŠ‚è¯¾ä¸»è¦æ˜¯å®‰æ’ä¸€æ¬¡å®æˆ˜æµ‹è¯•ï¼Œè®©ä½ æ¥å®ç°ä¸€ä¸ªç®€æ˜“çš„èŠå¤©ç³»ç»Ÿï¼Œæ¶‰åŠçš„IMç›¸å…³çŸ¥è¯†åŒ…æ‹¬ï¼šæ¶ˆæ¯å­˜å‚¨çš„è®¾è®¡ã€æ¶ˆæ¯æœªè¯»çš„è®¾è®¡ã€æ¶ˆæ¯å®æ—¶æ€§çš„å…·ä½“å®ç°ï¼Œç­‰ç­‰ã€‚</p><p>åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œå¸Œæœ›ä½ èƒ½åšåˆ°åˆç†çš„ä»£ç åˆ†å±‚è§„åˆ’ï¼Œé€šè¿‡Embeddingæ–¹å¼æå‡ä»£ç å¯¹IDEçš„å‹å¥½æ€§åŠä»£ç çš„å¯è¿ç§»æ€§ã€‚ç›¸ä¿¡é€šè¿‡è¿™ä¸€æ¬¡ç†è®ºä¸å®è·µç›¸ç»“åˆçš„åŠ¨æ‰‹å®æˆ˜ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ è¿›ä¸€æ­¥åŠ æ·±å¯¹IMç³»ç»Ÿæ ¸å¿ƒæŠ€æœ¯çš„ç†è§£ã€‚</p><p>åƒé‡Œä¹‹è¡Œï¼Œç§¯äºè·¬æ­¥ã€‚é€šè¿‡è„šè¸å®åœ°çš„ä»£ç å®ç°ï¼Œå°†ç†è®ºçŸ¥è¯†å˜æˆçœŸæ­£å¯ç”¨çš„ç³»ç»Ÿï¼Œä½ çš„æˆå°±æ„Ÿä¹Ÿæ˜¯ä¼šå€å¢çš„ã€‚</p><p>æœŸä¸­å®æˆ˜çš„æ¼”ç¤ºä»£ç å¹¶æ²¡æœ‰å®Œå…¨è¦†ç›–ä¹‹å‰è¯¾ç¨‹è®²åˆ°çš„å†…å®¹ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰å…´è¶£ï¼Œä¹Ÿéå¸¸æ¬¢è¿ä½ åœ¨ä»£ç å®ç°æ—¶åŠ å…¥æ›´å¤šçš„ç‰¹æ€§ï¼Œæ¯”å¦‚é•¿è¿æ¥ã€å¿ƒè·³ã€ACKæœºåˆ¶ã€æœªè¯»åŸå­åŒ–å˜æ›´ç­‰ã€‚å¦‚æœä½ å¯¹ä»Šå¤©çš„å†…å®¹æœ‰ä»€ä¹ˆæ€è€ƒä¸è§£è¯»ï¼Œæ¬¢è¿ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·è®¨è®ºã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæˆ‘ä»¬ä¸‹æœŸå†è§ã€‚</p><p></p>","comments":[{"had_liked":false,"id":141936,"user_name":"ç‹è’™","can_delete":false,"product_type":"c1","uid":1642579,"ip_address":"","ucode":"AF623B848877AD","user_header":"https://static001.geekbang.org/account/avatar/00/19/10/53/2230bf9d.jpg","comment_is_top":false,"comment_ctime":1571272075,"is_pvip":false,"replies":[{"id":"54994","content":"å°±æ˜¯åµŒå…¥åˆ°jvmé‡Œçš„ä¸€äº›ä¸­é—´ä»¶å’Œdbï¼Œwebå®¹å™¨è¿™äº›ï¼Œéšç€jvmå¯åŠ¨ä¹Ÿèƒ½è·Ÿç€ä¸€èµ·runèµ·æ¥ï¼Œç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1571403701,"ip_address":"","comment_id":141936,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27341075851","product_id":100034901,"comment_content":"Embeddingæ–¹å¼æ˜¯ä»€ä¹ˆæ„æ€","like_count":6,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470935,"discussion_content":"å°±æ˜¯åµŒå…¥åˆ°jvmé‡Œçš„ä¸€äº›ä¸­é—´ä»¶å’Œdbï¼Œwebå®¹å™¨è¿™äº›ï¼Œéšç€jvmå¯åŠ¨ä¹Ÿèƒ½è·Ÿç€ä¸€èµ·runèµ·æ¥ï¼Œç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571403701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144231,"user_name":"Ricky Fung","can_delete":false,"product_type":"c1","uid":1051363,"ip_address":"","ucode":"7AEA1F8EC4A088","user_header":"https://static001.geekbang.org/account/avatar/00/10/0a/e3/9637bfdb.jpg","comment_is_top":false,"comment_ctime":1571881107,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14456782995","product_id":100034901,"comment_content":"å»ºè®® æœŸä¸­ å’Œ æœŸæœ«è€ƒè¯•ä½œä¸š ä»£ç å¯ä»¥åˆ†ä¸¤ä¸ªåˆ†æ”¯ï¼Œè¿™æ ·å¤§å®¶çœ‹èµ·æ¥æ›´ç›´è§‚ã€‚","like_count":4},{"had_liked":false,"id":134823,"user_name":"ç‡ƒç€çš„åŠæ”¯çƒŸ","can_delete":false,"product_type":"c1","uid":1230837,"ip_address":"","ucode":"23C7B588F400A7","user_header":"https://static001.geekbang.org/account/avatar/00/12/c7/f5/4e9a82e9.jpg","comment_is_top":false,"comment_ctime":1568939829,"is_pvip":false,"replies":[{"id":"51739","content":"æœŸä¸­å®æˆ˜åªæ˜¯ä¸ªç®€æ˜“ç‰ˆdemoå“ˆï¼ŒæœŸæœ«çš„å®æˆ˜ä¼šåŸºäºç›®å‰è½®è¯¢çš„æ–¹å¼è¿›è¡Œé•¿è¿æ¥æ”¹é€ ï¼Œå†åŠ ä¸Šackå’Œå¿ƒè·³ç­‰åŠŸèƒ½ï¼Œè¿™æ ·ä¹Ÿè®©å¤§å®¶èƒ½å¯¹â€œæ¶ˆæ¯æ¨é€å®æ—¶æ€§â€çš„å®ç°æ–¹æ¡ˆæœ‰ä¸€ä¸ªæ¯”å¯¹ã€‚<br>å¦å¤–ï¼Œå®æˆ˜çš„ç›®çš„æ˜¯è®©å¤§å®¶è‡ªå·±å°è¯•ç»“åˆè¯¾ç¨‹å‰é¢çš„å†…å®¹æ¥ç»ƒæ‰‹åŠ æ·±å¯¹çŸ¥è¯†çš„ç†è§£ï¼Œæ‰€ä»¥æä¾›çš„demoå¹¶ä¸å…·å¤‡çº¿ä¸Šå¯ç”¨æ€§ï¼Œåªæ˜¯ä¸€ä¸ªç®€å•çš„å‚è€ƒã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1568953596,"ip_address":"","comment_id":134823,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14453841717","product_id":100034901,"comment_content":"åªæ˜¯åŸºäºrediså—ï¼Ÿæ²¡ç”¨åˆ°nettyå—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467910,"discussion_content":"æœŸä¸­å®æˆ˜åªæ˜¯ä¸ªç®€æ˜“ç‰ˆdemoå“ˆï¼ŒæœŸæœ«çš„å®æˆ˜ä¼šåŸºäºç›®å‰è½®è¯¢çš„æ–¹å¼è¿›è¡Œé•¿è¿æ¥æ”¹é€ ï¼Œå†åŠ ä¸Šackå’Œå¿ƒè·³ç­‰åŠŸèƒ½ï¼Œè¿™æ ·ä¹Ÿè®©å¤§å®¶èƒ½å¯¹â€œæ¶ˆæ¯æ¨é€å®æ—¶æ€§â€çš„å®ç°æ–¹æ¡ˆæœ‰ä¸€ä¸ªæ¯”å¯¹ã€‚\nå¦å¤–ï¼Œå®æˆ˜çš„ç›®çš„æ˜¯è®©å¤§å®¶è‡ªå·±å°è¯•ç»“åˆè¯¾ç¨‹å‰é¢çš„å†…å®¹æ¥ç»ƒæ‰‹åŠ æ·±å¯¹çŸ¥è¯†çš„ç†è§£ï¼Œæ‰€ä»¥æä¾›çš„demoå¹¶ä¸å…·å¤‡çº¿ä¸Šå¯ç”¨æ€§ï¼Œåªæ˜¯ä¸€ä¸ªç®€å•çš„å‚è€ƒã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568953596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186904,"user_name":"kamida","can_delete":false,"product_type":"c1","uid":1904146,"ip_address":"","ucode":"16D7CA59870AC0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/jXbwicoDwia7ooDfwBTRyvNYQkefnVwF1CMicMS8FqKfuFAdvVZo2pqc4ic0R9kSdHTIxaE6YyqxwX8BdNGv5PqSIw/132","comment_is_top":false,"comment_ctime":1583956783,"is_pvip":false,"replies":[{"id":"72297","content":"è¿™ä¸ªæŸ¥è¯¢éœ€æ±‚æ˜¯å­˜åœ¨çš„ï¼Œä½†ç”±äºä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯åˆ†é¡µæŸ¥è¯¢ï¼Œæ‰€ä»¥é’ˆå¯¹æŸä¸€é¡µçš„æ¶ˆæ¯å†…å®¹è¿›è¡Œmulti getçš„å¹¶å‘æŸ¥è¯¢å®é™…ä¸Šæ€§èƒ½ä¸Šä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1584086257,"ip_address":"","comment_id":186904,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5878924079","product_id":100034901,"comment_content":"è€å¸ˆ æˆ‘æƒ³é—®ä¸€ä¸‹ åˆ†åº“åˆ†è¡¨çš„é—®é¢˜ å¦‚æœMSG_CONTENTçš„partitionæ˜¯mid è€ŒMSG_RELATIONçš„partition key æ˜¯onwer id é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¦æŸ¥è¯¢ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´æ‰€æœ‰çš„msgåŠå…¶å†…å®¹çš„è¯ æˆ‘ä»¬éœ€è¦å»æ¯ä¸€ä¸ªDB shardå»æŸ¥æ‰¾msg_content table è¿™æ ·ä¼šä¸ä¼šå¾ˆæ…¢ æˆ–è€…è¿™ä¸ªæŸ¥è¯¢éœ€æ±‚æ˜¯ä¸å¿…è¦çš„ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486911,"discussion_content":"è¿™ä¸ªæŸ¥è¯¢éœ€æ±‚æ˜¯å­˜åœ¨çš„ï¼Œä½†ç”±äºä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯åˆ†é¡µæŸ¥è¯¢ï¼Œæ‰€ä»¥é’ˆå¯¹æŸä¸€é¡µçš„æ¶ˆæ¯å†…å®¹è¿›è¡Œmulti getçš„å¹¶å‘æŸ¥è¯¢å®é™…ä¸Šæ€§èƒ½ä¸Šä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584086257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135440,"user_name":"é£ç¿”","can_delete":false,"product_type":"c1","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1569160603,"is_pvip":true,"replies":[{"id":"52015","content":"åˆ†é¡µçš„æ—¶å€™ä¼šç”¨åˆ°ã€‚æ¯”å¦‚ï¼š<br>select msgid from IM_MSG_RELATION where owner_uid=? and other_uid=? and  mid &lt;= ? order by mid desc limit ?,?","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569237338,"ip_address":"","comment_id":135440,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5864127899","product_id":100034901,"comment_content":"<br>CREATE INDEX `idx_owneruid_otheruid_msgid` ON  IM_MSG_RELATION(`owner_uid`,`other_uid`,`mid`);<br>è€å¸ˆ æ¶ˆæ¯ç´¢å¼•è¡¨ä¸­ ä¸ºä»€ä¹ˆè¦åˆ›ä½œ(`owner_uid`,`other_uid`,`mid`); è¿™ä¸‰ä¸ªçš„è”åˆç´¢å¼•  å‘€","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468195,"discussion_content":"åˆ†é¡µçš„æ—¶å€™ä¼šç”¨åˆ°ã€‚æ¯”å¦‚ï¼š\nselect msgid from IM_MSG_RELATION where owner_uid=? and other_uid=? and  mid &amp;lt;= ? order by mid desc limit ?,?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569237338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135435,"user_name":"é£ç¿”","can_delete":false,"product_type":"c1","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1569159947,"is_pvip":true,"replies":[{"id":"52013","content":"å—¯ï¼Œæ˜¯å†—ä½™äº†ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿ç¦»çº¿ç»Ÿè®¡å’Œåå°ä½¿ç”¨ï¼Œä¸šåŠ¡ä¸Šå¯ä»¥ä¸éœ€è¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569236930,"ip_address":"","comment_id":135435,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5864127243","product_id":100034901,"comment_content":"æ¶ˆæ¯å†…å®¹è¡¨ï¼š<br><br>CREATE TABLE IM_MSG_CONTENT (<br>mid INT AUTO_INCREMENT  PRIMARY KEY,<br>content VARCHAR(1000) NOT NULL,<br>sender_id INT NOT NULL,<br>recipient_id INT NOT NULL,<br>msg_type INT NOT NULL,<br>create_time TIMESTAMP NOT NUll<br>);<br><br><br>è€å¸ˆ æ¶ˆæ¯å†…å®¹è¡¨ä¸­çš„sender_id INT NOT NULL,<br>recipient_id INT NOT NULL, è¿™ä¸¤ä¸ªå­—æ®µæ˜¯ä¸æ˜¯æœ‰äº›å¤šä½™ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468192,"discussion_content":"å—¯ï¼Œæ˜¯å†—ä½™äº†ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿ç¦»çº¿ç»Ÿè®¡å’Œåå°ä½¿ç”¨ï¼Œä¸šåŠ¡ä¸Šå¯ä»¥ä¸éœ€è¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569236930,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135158,"user_name":"å±±å¤´","can_delete":false,"product_type":"c1","uid":1610142,"ip_address":"","ucode":"9CD45A7966F37E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/1R7lHGBvwPTVfb3BAQrPX3AhsYWnXyicbUJUYDgWagWxMGTnsNFvKibzeJ8v7fF2vJLQGf2EY9dV07rnn5Mhv9Uw/132","comment_is_top":false,"comment_ctime":1569047413,"is_pvip":false,"replies":[{"id":"52011","content":"ä¼šå­˜ä¸¤æ¡ï¼Œå’±ä»¬è¯¾ç¨‹2é‡Œé¢æœ‰è®²è¿‡çš„å“¦","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569236795,"ip_address":"","comment_id":135158,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5864014709","product_id":100034901,"comment_content":"æ¶ˆæ¯ç´¢å¼•è¡¨ï¼š<br><br>CREATE TABLE IM_MSG_RELATION (<br>owner_uid INT NOT NULL,<br>other_uid INT NOT NULL,<br>mid INT NOT NULL,<br>type INT NOT NULL,<br>create_time TIMESTAMP NOT NULL,<br>PRIMARY KEY (`owner_uid`,`mid`)<br>);<br>CREATE INDEX `idx_owneruid_otheruid_msgid` ON  IM_MSG_RELATION(`owner_uid`,`other_uid`,`mid`);<br>ownerid otheridæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå¼ ä¸‰ç»™æå››å‘ä¸€æ¡æ¶ˆæ¯ï¼Œåœ¨è¿™ä¸ªè¡¨é‡Œå­˜å‡ æ¡æ•°æ®å‘¢","like_count":1,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468073,"discussion_content":"ä¼šå­˜ä¸¤æ¡ï¼Œå’±ä»¬è¯¾ç¨‹2é‡Œé¢æœ‰è®²è¿‡çš„å“¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569236795,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316463,"user_name":"ahack","can_delete":false,"product_type":"c1","uid":1684003,"ip_address":"","ucode":"6852925FD86234","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epDpMJ1onECmHCzwCV8ULMqnocLC2ZRXtp0LqktWUaAIvOwrTQeavZnaFMMeZAKOAxPhsIZhOuHTw/132","comment_is_top":false,"comment_ctime":1634315053,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1634315053","product_id":100034901,"comment_content":"æ–°æ‰‹ï¼Œredisè¿™ä¸ªè¡¨çœ‹ä¸æ‡‚è¦æ€ä¹ˆå»ºï¼Œæœ‰æ²¡æœ‰å¤§ä½¬jiesä¸€ä¸‹å‘¢","like_count":0},{"had_liked":false,"id":259600,"user_name":"DeenJun","can_delete":false,"product_type":"c1","uid":1026010,"ip_address":"","ucode":"6D40BA39A33C9D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a7/da/f057374c.jpg","comment_is_top":false,"comment_ctime":1604765141,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1604765141","product_id":100034901,"comment_content":"è¯·æ•™ä¸ªé—®é¢˜ï¼šä¹‹å‰è®²çš„IMæœåŠ¡åˆ’åˆ†ä¸ºä¸šåŠ¡é€»è¾‘å’Œè¿æ¥å±‚ä¸¤éƒ¨åˆ†ï¼Œè¿æ¥å±‚è´Ÿè´£ç»´æŠ¤è¿æ¥å’Œç¼–è§£ç æ¶ˆæ¯ã€‚å¹¶ä¸”çœ‹ä¹‹å‰è¯¾ç¨‹è®²ï¼Œä¸€èˆ¬å„å‚éƒ½è®¾è®¡äº†ä¸€å¥—ç§æœ‰åè®®è€Œæ²¡æœ‰ç”¨MQTTï¼Œä½†æ˜¯è¿™éƒ¨åˆ†è®²å¾—æ¯”è¾ƒç•¥ã€‚æˆ‘çš„é—®é¢˜æ˜¯ï¼Œé•¿è¿æ¥çš„ä¸¤ç«¯å‘é€è¯·æ±‚éƒ½æ˜¯onewayçš„å—ï¼Ÿæœ‰req-respæ¨¡å‹å—ï¼Ÿæ¯”å¦‚è¯´å®¢æˆ·ç«¯é€šè¿‡é•¿è¿æ¥å‘é€äº†ä¸€ä¸ªè¯·æ±‚Aï¼Œè¿™æ—¶å€™æœåŠ¡ç«¯åˆæ¨é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åå†å‘é€è¯·æ±‚Aå¯¹åº”çš„responseã€‚å®¢æˆ·ç«¯å°±å¿…é¡»è¦èƒ½å¤ŸåŒºåˆ†å“ªä¸ªåŒ…æ˜¯å¯¹åº”å“ªä¸ªè¯·æ±‚çš„respè¿˜æ˜¯ä»…ä»…æ˜¯æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€çš„ã€‚æœåŠ¡ç«¯ä¹ŸåŒç†ã€‚ä¸€èˆ¬æ˜¯æ€ä¹ˆåšå‘¢ï¼Ÿé•¿è¿æ¥çš„åè®®éœ€è¦è®¾è®¡æˆ oneway + req-respéƒ½æ”¯æŒè¿™ç§æ¨¡å¼ï¼Œè¿˜æ˜¯è¯´å°±ä»…ä»…æ˜¯onewayè¿™ç§æ¨¡å¼ï¼Œæ¨äº†å°±å®Œäº‹å„¿ï¼Œéœ€è¦respçš„è¯·æ±‚èµ°å¦å¤–çš„æœåŠ¡ä¸èµ°é•¿è¿æ¥ï¼Ÿå¦‚æœåœ¨åè®®ä¸­æ”¯æŒï¼Œæœ‰æ¨èçš„å¼€æºåè®®å—ï¼Ÿä¸€èˆ¬é•¿è¿æ¥çš„ç§æœ‰åè®®éœ€è¦è€ƒè™‘è¿æ¥çš„å¤šè·¯å¤ç”¨å—ï¼Ÿé—®é¢˜æœ‰ç‚¹å¤šï¼ŒæœŸå¾…è€å¸ˆçš„å›ç­”â€¦","like_count":0,"discussions":[{"author":{"id":1507215,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOpltlRkCJVWiba5nG0KHticdlp2E95bwepumSquAR2eTibFotGcRkWj5amllmgq4ia7bicEEML9EF5hA/132","nickname":"running+","note":"","ucode":"CAD81A0AC89ABD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368656,"discussion_content":"æˆ‘è§‰å¾—é•¿è¿æ¥è¿™ç±»çš„æœ€å¥½æ˜¯åªç”¨æ¥æ¶ˆæ¯çš„æ”¶å‘ï¼Œåƒrestcallçš„è¿™ç±»apiè¯·æ±‚æ˜¯å®Œå…¨å¯ä»¥ç”¨çŸ­è½®è¯¢çš„æ–¹å¼å¤„ç†ï¼Œä½ è¯´çš„req-responseå’Œæ¨é€çš„å‰åé¡ºåºä»–ä»¬æœ‰å¯¹åº”reqidè¿™ä¸ªåº”è¯¥æ˜¯èƒ½åŒºåˆ†å‡ºæ¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618794225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":151426,"user_name":"Geek_908e99","can_delete":false,"product_type":"c1","uid":1724843,"ip_address":"","ucode":"5E7C4D317F0C73","user_header":"","comment_is_top":false,"comment_ctime":1573717605,"is_pvip":false,"replies":[{"id":"58813","content":"å—¯ï¼Œè¿™ä¸ªdemoæ²¡æœ‰ç”¨luaæ¥ä¿éšœåŸå­æ€§ï¼Œæ‰€ä»¥æ˜¯ä¼šå­˜åœ¨å¹¶å‘æ›´æ–°çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥å°è¯•æ¥ä¼˜åŒ–æ”¹é€ è¯•è¯•å“ˆï¼Œæ ¸å¿ƒluaä»£ç åœ¨æ–‡ç« ä¸­æœ‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1574149372,"ip_address":"","comment_id":151426,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1573717605","product_id":100034901,"comment_content":"è€å¸ˆæˆ‘çœ‹æ›´æ–°æœªè¯»æ•°çš„é€»è¾‘å¹¶æ²¡æœ‰ç”¨åˆ°redisäº‹åŠ¡ï¼Œæˆ‘çœ‹åˆ°çš„å°±æ˜¯ä¸‹é¢ä¸¤è¡Œï¼Œè¿™ä¸ªå®ç°ä¸èƒ½ä¿è¯åŸå­æ€§å§ï¼š<br><br>&#47;**æ›´æœªè¯»æ›´æ–° *&#47;<br>redisTemplate.opsForValue().increment(recipientUid + &quot;_T&quot;, 1); &#47;&#47;åŠ æ€»æœªè¯»<br>redisTemplate.opsForHash().increment(recipientUid + &quot;_C&quot;, senderUid, 1); &#47;&#47;åŠ ä¼šè¯æœªè¯»","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474470,"discussion_content":"å—¯ï¼Œè¿™ä¸ªdemoæ²¡æœ‰ç”¨luaæ¥ä¿éšœåŸå­æ€§ï¼Œæ‰€ä»¥æ˜¯ä¼šå­˜åœ¨å¹¶å‘æ›´æ–°çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥å°è¯•æ¥ä¼˜åŒ–æ”¹é€ è¯•è¯•å“ˆï¼Œæ ¸å¿ƒluaä»£ç åœ¨æ–‡ç« ä¸­æœ‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574149372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142787,"user_name":"äº”ç‚¹åŠå…ˆç”Ÿ","can_delete":false,"product_type":"c1","uid":1408320,"ip_address":"","ucode":"CE820DFE00D0AB","user_header":"https://static001.geekbang.org/account/avatar/00/15/7d/40/2a0ac40f.jpg","comment_is_top":false,"comment_ctime":1571529010,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571529010","product_id":100034901,"comment_content":"æ¬è¿ï¼Œhttps:&#47;&#47;github.com&#47;coldwalker&#47;Sample","like_count":0},{"had_liked":false,"id":142489,"user_name":"Geek_defa2f","can_delete":false,"product_type":"c1","uid":1642714,"ip_address":"","ucode":"FDE59E4CF07725","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJY8V36aWLibUQiaoNIGibDGFQickZficggiaXPO0ejPNnGvYPQ3iciarMn0BnOCRG2kbOON98KwiafWQsNxpw/132","comment_is_top":false,"comment_ctime":1571379176,"is_pvip":false,"replies":[{"id":"55011","content":"æœŸæœ«çš„ä»£ç åŸºæœ¬æ²¡æœ‰è¦†ç›–æœŸä¸­çš„å“ˆï¼Œéƒ½æ˜¯ç‹¬ç«‹çš„åŠŸèƒ½å’Œå®ç°ï¼Œé¡µé¢ä¹Ÿéƒ½æ˜¯ç‹¬ç«‹çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1571405450,"ip_address":"","comment_id":142489,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571379176","product_id":100034901,"comment_content":"èƒ½ä¸èƒ½æœŸä¸­æœŸæœ«å®æˆ˜çš„ä»£ç åˆ†å¼€éƒ¨ç½²åœ¨githubä¸Šï¼Œç°åœ¨æ‰å­¦åˆ°ï¼Œå‘ç°æœŸä¸­çš„ä»£ç è¢«æœŸæœ«çš„ä»£ç è¦†ç›–äº†ã€‚ã€‚ã€‚","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471146,"discussion_content":"æœŸæœ«çš„ä»£ç åŸºæœ¬æ²¡æœ‰è¦†ç›–æœŸä¸­çš„å“ˆï¼Œéƒ½æ˜¯ç‹¬ç«‹çš„åŠŸèƒ½å’Œå®ç°ï¼Œé¡µé¢ä¹Ÿéƒ½æ˜¯ç‹¬ç«‹çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571405450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":138474,"user_name":"yic","can_delete":false,"product_type":"c1","uid":1201577,"ip_address":"","ucode":"C8DC471B7C28B8","user_header":"https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg","comment_is_top":false,"comment_ctime":1570264412,"is_pvip":false,"replies":[{"id":"53732","content":"ç¾¤å‘æ¶ˆæ¯qpså¾ˆé«˜çš„è¯å°±ä¸è¦ç”¨mysqlè¿™ç§å…³ç³»å‹æ•°æ®åº“å•¦ï¼Œå¦å¤–ä¹Ÿä¸éœ€è¦å‘ä»¶äººç»´åº¦çš„æ¶ˆæ¯å­˜å‚¨ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨hbaseè¿™ç±»nosqlæ•°æ®åº“æ¥å­˜å‚¨ç´¢å¼•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1570625582,"ip_address":"","comment_id":138474,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1570264412","product_id":100034901,"comment_content":"æ¶ˆæ¯ç´¢å¼•è¡¨ï¼š<br><br>CREATE TABLE IM_MSG_RELATION (<br>owner_uid INT NOT NULL,<br>other_uid INT NOT NULL,<br>mid INT NOT NULL,<br>type INT NOT NULL,<br>create_time TIMESTAMP NOT NULL,<br>PRIMARY KEY (`owner_uid`,`mid`)<br>);<br>CREATE INDEX `idx_owneruid_otheruid_msgid` ON IM_MSG_RELATION(`owner_uid`,`other_uid`,`mid`);<br>è€å¸ˆï¼Œæ¶ˆæ¯ç´¢å¼•è¡¨è¿™ä¹ˆåˆ›å»ºï¼Œè¯·æ•™ä¸€ä¸‹ç¾¤å‘ï¼ˆ500äººç¾¤ï¼‰æ¶ˆæ¯ï¼Œæ˜¯ä¸æ˜¯è¦æ’å…¥500æ¡è®°å½•ï¼Ÿ å¦‚æœæ˜¯æ’åº“çš„è¯ï¼Œæ€§èƒ½èƒ½ä¿è¯å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469532,"discussion_content":"ç¾¤å‘æ¶ˆæ¯qpså¾ˆé«˜çš„è¯å°±ä¸è¦ç”¨mysqlè¿™ç§å…³ç³»å‹æ•°æ®åº“å•¦ï¼Œå¦å¤–ä¹Ÿä¸éœ€è¦å‘ä»¶äººç»´åº¦çš„æ¶ˆæ¯å­˜å‚¨ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨hbaseè¿™ç±»nosqlæ•°æ®åº“æ¥å­˜å‚¨ç´¢å¼•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570625582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1011156,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/L8Hia5sfiafASmBa3eTLMH8C25gMCHLTXddMkIiaCb0ky48FowibUrLQ9WSeTxSIS3prFsSjiaarwbRp1kTXDbug9eQ/132","nickname":"é»„æµ·","note":"","ucode":"AC45303035622E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":27162,"discussion_content":"è¯·é—®è€å¸ˆ, é’ˆå¯¹ç¾¤å‘å‡ ç™¾äººæ¶ˆæ¯çš„åœºæ™¯, ä¿å­˜æ¶ˆæ¯ç´¢å¼•, é™¤äº† hbase , è¿˜æœ‰å…¶ä»– nosql æ•°æ®åº“æ¨èå—?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570632561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136085,"user_name":"ç‹æ£•ç”Ÿ","can_delete":false,"product_type":"c1","uid":1337944,"ip_address":"","ucode":"901BD0447A871E","user_header":"https://static001.geekbang.org/account/avatar/00/14/6a/58/f2c6d65b.jpg","comment_is_top":false,"comment_ctime":1569341360,"is_pvip":false,"replies":[{"id":"52230","content":"ğŸ˜º è°¢è°¢","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569411762,"ip_address":"","comment_id":136085,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1569341360","product_id":100034901,"comment_content":"æ„Ÿè°¢è€å¸ˆçš„æ€»ç»“å’Œæºç åˆ†äº«ï¼","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468451,"discussion_content":"ğŸ˜º è°¢è°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569411762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136082,"user_name":"YidWang","can_delete":false,"product_type":"c1","uid":1619756,"ip_address":"","ucode":"C91A9117EC3540","user_header":"https://static001.geekbang.org/account/avatar/00/18/b7/2c/e1682683.jpg","comment_is_top":false,"comment_ctime":1569340626,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1569340626","product_id":100034901,"comment_content":"æ¶ˆæ¯ æ²¡æœ‰é‡å¤ è®¾è®¡","like_count":0},{"had_liked":false,"id":135932,"user_name":"Geek_å‘ç°","can_delete":false,"product_type":"c1","uid":1643741,"ip_address":"","ucode":"39C23F2D574A09","user_header":"https://static001.geekbang.org/account/avatar/00/19/14/dd/17892edc.jpg","comment_is_top":false,"comment_ctime":1569306845,"is_pvip":false,"replies":[{"id":"52223","content":"è¿˜æœ‰å…¶ä»–æŠ¥é”™å—ï¼Ÿæ¯”å¦‚â€œThis redis server instance is already running...â€æˆ–è€…â€œFailed to start Redis instanceâ€ã€‚å¯ä»¥æ–­ç‚¹è·Ÿè¿›åˆ°startæ–¹æ³•é‡Œå»çœ‹çœ‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569410942,"ip_address":"","comment_id":135932,"utype":1}],"discussion_count":6,"race_medal":0,"score":"1569306845","product_id":100034901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘å¯åŠ¨é¡¹ç›®æŠ¥é”™org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;embededRedis&#39;: Invocation of init method failed; nested exception is java.lang.RuntimeException: Can&#39;t start redis server. Check logs for details.<br>æˆ‘redisæ˜¯å¯åŠ¨äº†çš„ï¼Œç«¯å£å·ä¹Ÿæ˜¯6379ï¼Œæ€ä¹ˆå›äº‹å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468389,"discussion_content":"è¿˜æœ‰å…¶ä»–æŠ¥é”™å—ï¼Ÿæ¯”å¦‚â€œThis redis server instance is already running...â€æˆ–è€…â€œFailed to start Redis instanceâ€ã€‚å¯ä»¥æ–­ç‚¹è·Ÿè¿›åˆ°startæ–¹æ³•é‡Œå»çœ‹çœ‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569410942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1320902,"avatar":"https://static001.geekbang.org/account/avatar/00/14/27/c6/8b411cd6.jpg","nickname":"ä»˜ sir","note":"","ucode":"2037A063183003","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545040,"discussion_content":" redisServer = RedisServer.builder().setting(&#34;maxheap 500m&#34;).port(6379).setting(&#34;bind localhost&#34;).build();","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1641812321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1647924,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/INc61dATFS9XQ2Hoy1bdNjZZZ18mulDJibF8kib2ZNpX5gdxYjNpWZYePHl6PHea7bTeMkicNBryCkT5ghic4yoSMw/132","nickname":"when","note":"","ucode":"1416E57E1C1531","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":21409,"discussion_content":"RedisServiceåˆ›å»ºæ—¶æŒ‡å®šmaxheapå¯ä»¥è§£å†³é—®é¢˜ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569479895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1501138,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/d2/00470175.jpg","nickname":"zyz","note":"","ucode":"9E6B063F856F4D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1647924,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/INc61dATFS9XQ2Hoy1bdNjZZZ18mulDJibF8kib2ZNpX5gdxYjNpWZYePHl6PHea7bTeMkicNBryCkT5ghic4yoSMw/132","nickname":"when","note":"","ucode":"1416E57E1C1531","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":42073,"discussion_content":"æŒ‡å®šå¤šå¤§å’§ï¼Œæˆ‘æŒ‡å®šè¿‡50ï¼Œ100ï¼Œ200ï¼Œ500ï¼Œ1000méƒ½ä¸è¡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572580727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":21409,"ip_address":""},"score":42073,"extra":""}]},{"author":{"id":1272628,"avatar":"https://static001.geekbang.org/account/avatar/00/13/6b/34/0590865d.jpg","nickname":"threedr3am","note":"","ucode":"9F464BBDCC116D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":30853,"discussion_content":"æ¢ä¸ªç«¯å£ï¼Œé¡¹ç›®ç”¨çš„å†…ç½®redisï¼Œä½ å¤–éƒ¨rediså’Œè¿™ä¸ªå†²çªäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570865356,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1643741,"avatar":"https://static001.geekbang.org/account/avatar/00/19/14/dd/17892edc.jpg","nickname":"Geek_å‘ç°","note":"","ucode":"39C23F2D574A09","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":23393,"discussion_content":"æ„Ÿè°¢ä½ è§£å†³äº†æˆ‘çš„é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569811600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135567,"user_name":"ç»™æˆ‘ç‚¹é˜³å…‰å°±ç¿çƒ‚","can_delete":false,"product_type":"c1","uid":1462209,"ip_address":"","ucode":"F3B0439BE0D062","user_header":"https://static001.geekbang.org/account/avatar/00/16/4f/c1/7f596aba.jpg","comment_is_top":false,"comment_ctime":1569215025,"is_pvip":true,"replies":[{"id":"52021","content":"å­˜æ¶ˆæ¯é˜Ÿåˆ—çš„é—®é¢˜åœ¨äºä½ éœ€ä¸éœ€è¦æŒ‰ä¼šè¯ç»´åº¦å•¥çš„æ¥è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ†é¡µç­‰ç­‰ã€‚å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥åªæ ¹æ®uidç»´åº¦æ¥æš‚å­˜æ¶ˆæ¯å’Œä¿¡ä»¤ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569238420,"ip_address":"","comment_id":135567,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1569215025","product_id":100034901,"comment_content":"å³ä½¿é€šè®¯çš„æ¶ˆæ¯å¯ä¸å¯ä»¥ä¸å­˜åœ¨æ•°æ®åº“ä¸­è€Œå·²æ¶ˆæ¯é˜Ÿåˆ—çš„å½¢å¼ä»£æ›¿å‘¢","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468250,"discussion_content":"å­˜æ¶ˆæ¯é˜Ÿåˆ—çš„é—®é¢˜åœ¨äºä½ éœ€ä¸éœ€è¦æŒ‰ä¼šè¯ç»´åº¦å•¥çš„æ¥è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ†é¡µç­‰ç­‰ã€‚å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥åªæ ¹æ®uidç»´åº¦æ¥æš‚å­˜æ¶ˆæ¯å’Œä¿¡ä»¤ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569238420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135541,"user_name":"leslie","can_delete":false,"product_type":"c1","uid":1324255,"ip_address":"","ucode":"798E7C1CC98CC2","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg","comment_is_top":false,"comment_ctime":1569207546,"is_pvip":false,"replies":[{"id":"52020","content":"å»ºè®®è¿˜æ˜¯åŠ¨æ‰‹å†™ä¸€å†™ï¼Œä¸€ç èƒœåƒè¨€~","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569238311,"ip_address":"","comment_id":135541,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1569207546","product_id":100034901,"comment_content":"     æœŸä¸­è€ƒè¯• ã€ã€ã€è¿˜æ˜¯ç­‰æœŸæœ«è€ƒè¯•çš„æ—¶å€™ä¸€èµ·åšå§ï¼Œçœ‹çš„æ‡‚å†™ä¸æ¥ï¼Œå‡ºå»çš„éƒ½æ˜¯ä¼ªä»£ç ï¼šå¿™èµ·æ¥å°±å‘ç°å†™è¿™ä¸ªä¸œè¥¿è‡ªå·±çš„Codingå¤ªå·®äº†ï¼Œè¢«Codingèƒ½åŠ›æ‹–åè…¿äº†ï¼šè°è®©è¿™æ˜¯DBAå’ŒOPSçš„é€šç—…å‘¢ã€ã€ã€","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468240,"discussion_content":"å»ºè®®è¿˜æ˜¯åŠ¨æ‰‹å†™ä¸€å†™ï¼Œä¸€ç èƒœåƒè¨€~","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569238311,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135469,"user_name":"é£ç¿”","can_delete":false,"product_type":"c1","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1569181686,"is_pvip":true,"replies":[{"id":"52016","content":"æ˜¯çš„ï¼Œredisçš„äº‹åŠ¡åªä¿è¯è¿™äº›å‘½ä»¤åŸå­æ‰§è¡Œï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å°±ç®—æœ‰å‘½ä»¤å¤±è´¥ï¼Œé˜Ÿåˆ—ä¸­çš„å…¶ä»–å‘½ä»¤ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥è°ƒç”¨æ–¹éœ€è¦æ ¹æ®è¿”å›ç»“æœæ¥è¿›è¡ŒäºŒæ¬¡å¤„ç†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"coldwalker","uid":"1297490","ctime":1569237813,"ip_address":"","comment_id":135469,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1569181686","product_id":100034901,"comment_content":"è€å¸ˆ  æœ‰ä¸€ä¸ªé—®é¢˜<br>å¯¹äºredis äº‹åŠ¡<br>        redisTemplate.multi();<br>        redisTemplate.opsForValue().increment(recipientUid + &quot;_T&quot;, 1); &#47;&#47;åŠ æ€»æœªè¯»<br>        redisTemplate.opsForHash().increment(recipientUid + &quot;_C&quot;, senderUid, 1); &#47;&#47;åŠ ä¼šè¯æœªè¯»<br>        redisTemplate.exec();<br><br>å‡è®¾ç¬¬ä¸€ä¸ªåŠ æ€»æœªè¯»å¤±è´¥ï¼Œ äº‹åŠ¡å¹¶ä¸ä¼šåœæ­¢ï¼Œè€Œæ˜¯ç»§ç»­è¿›è¡Œï¼Œç¬¬äºŒä¸ªåŠ ä¼šè¯æœªè¯»ï¼Œ è¿™æ ·ä¸ä¹Ÿæ˜¯æ•°æ®å°±ä¸ä¸€è‡´äº†å˜›ï¼Œ redis äº‹åŠ¡å®Œå…¨å’Œæ²¡æœ‰ä¸€æ ·å‘€ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1297490,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epK1zyWib7IKYCoRSxIa6dDjrcyBqObGfj1lDVia1pOrSVxyltKI7RfGekdXPQNObwaBQg3gwvarlQA/132","nickname":"coldwalker","note":"","ucode":"AF9AF257A745C9","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468206,"discussion_content":"æ˜¯çš„ï¼Œredisçš„äº‹åŠ¡åªä¿è¯è¿™äº›å‘½ä»¤åŸå­æ‰§è¡Œï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å°±ç®—æœ‰å‘½ä»¤å¤±è´¥ï¼Œé˜Ÿåˆ—ä¸­çš„å…¶ä»–å‘½ä»¤ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥è°ƒç”¨æ–¹éœ€è¦æ ¹æ®è¿”å›ç»“æœæ¥è¿›è¡ŒäºŒæ¬¡å¤„ç†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569237813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}