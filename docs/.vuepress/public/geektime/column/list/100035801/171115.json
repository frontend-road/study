{"id":171115,"title":"28 | 多机房部署：跨地域的分布式系统如何做？","content":"<p>你好，我是唐扬。</p><p><strong>来想象这样一个场景：</strong>你的垂直电商系统部署的IDC机房，在某一天发布了公告说，机房会在第二天凌晨做一次网络设备的割接，在割接过程中会不定时出现瞬间或短时间网络中断。</p><p>机房网络的中断肯定会对业务造成不利的影响，即使割接的时间在凌晨（业务的低峰期），作为技术负责人的你，也要尽量思考方案来规避隔离的影响。然而不幸的是，在现有的技术架构下，电商业务全都部署在一个IDC机房中，你并没有好的解决办法。</p><p>而IDC机房的可用性问题是整个系统的阿喀琉斯之踵，一旦IDC机房像一些大厂一样出现很严重的问题，就会对整体服务的可用性造成严重的影响。比如：</p><p>2016年7月，北京联通整顿旗下40多个IDC机房中，不规范的接入情况，大批不合规接入均被断网，这一举动致使脉脉当时使用的蓝汛机房受到影响，脉脉宕机长达15个小时，著名的A站甚至宕机超过48个小时，损失可想而知。</p><p>而目前，单一机房部署的架构特点决定了你的系统可用性受制于机房的可用性，也就是机房掌控了系统的生命线。所以，你开始思考如何通过架构的改造进一步提升系统的可用性。在网上搜索解决方案和学习一些大厂的经验后，你发现“多机房部署”可以解决这个问题。</p><h2>多机房部署的难点是什么</h2><!-- [[[read_end]]] --><p><strong>多机房部署的含义是：</strong>在不同的IDC机房中部署多套服务，这些服务共享同一份业务数据，并且都可以承接来自用户的流量。</p><p>这样，当其中某一个机房出现网络故障、火灾，甚至整个城市发生地震、洪水等大的不可抗的灾难时，你可以随时将用户的流量切换到其它地域的机房中，从而保证系统可以不间断地持续运行。这种架构听起来非常美好，但是在实现上却是非常复杂和困难的，那么它复杂在哪儿呢？</p><p>假如我们有两个机房A和B都部署了应用服务，数据库的主库和从库部署在A机房，那么机房B的应用如何访问到数据呢？有两种思路。</p><p><strong>一个思路是直接跨机房读取A机房的从库：</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/72/b9/72938f06f3193b7bd30223d188475bb9.jpg?wh=1142*1025\" alt=\"\"></p><p><strong>另一个思路是在机房B部署一个从库，跨机房同步主库的数据，然后机房B的应用就可以读取这个从库的数据了：</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/49/4d/4924474ef8379137c6effe923a19e04d.jpg?wh=1142*706\" alt=\"\"></p><p>无论是哪一种思路，<strong>都涉及到跨机房的数据传输，</strong>这就对机房之间延迟情况有比较高的要求了。而机房之间的延迟和机房之间的距离息息相关，你可以记住几个数字。</p><p>1.北京同地双机房之间的专线延迟一般在1ms~3ms。</p><p>这个延迟会造成怎样的影响呢？要知道，我们的接口响应时间需要控制在200ms之内，而一个接口可能会调用几次第三方HTTP服务或者RPC服务。如果这些服务部署在异地机房，那么接口响应时间就会增加几毫秒，是可以接受的。</p><p>一次接口可能会涉及几次的数据库写入，那么如果数据库主库在异地机房，那么接口的响应时间也会因为写入异地机房的主库，增加几毫秒到十几毫秒，也是可以接受的。</p><p>但是，接口读取缓存和数据库的数量可能会达到十几次甚至几十次，那么这就会增加几十毫秒甚至上百毫秒的延迟，就不能接受了。</p><p>2.国内异地双机房之间的专线延迟会在50ms之内。</p><p>具体的延迟数据依据距离的不同而不同。比如，北京到天津的专线延迟会在10ms之内；而北京到上海的延迟就会提高到接近30ms；如果想要在北京和广州部署双机房，那么延迟就会到达50ms了。在这个延迟数据下，要想保证接口的响应时间在200ms之内，就要尽量减少跨机房的服务调用，更要避免跨机房的数据库和缓存操作了。</p><p>3.如果你的业务是国际化的服务，需要部署跨国的双机房，那么机房之间的延迟就更高了，依据各大云厂商的数据来看，比如，从国内想要访问部署在美国西海岸的服务，这个延迟会在100ms~200ms左右。在这个延迟下，就要避免数据跨机房同步调用，而只做异步的数据同步。</p><p>如果你正在考虑多机房部署的架构，那么这些数字都是至关重要的基础数据，<strong>你需要牢牢记住，避免出现跨机房访问数据造成性能衰减问题。</strong></p><p>机房之间的数据延迟在客观上是存在的，你没有办法改变。你可以做的，就是尽量避免数据延迟对于接口响应时间的影响。那么在数据延迟下，你要如何设计多机房部署的方案呢？</p><h2>逐步迭代多机房部署方案</h2><h3>1.同城双活</h3><p>制定多机房部署的方案不是一蹴而就的，而是不断迭代发展的。我在上面提到，同城机房之间的延时在1ms~3ms左右，对于跨机房调用的容忍度比较高，所以，这种同城双活的方案复杂度会比较低。</p><p>但是，它只能做到机房级别的容灾，无法做到城市级别的容灾。不过，相比于城市发生地震、洪水等自然灾害来说，机房网络故障、掉电出现的概率要大得多。所以，如果你的系统不需要考虑城市级别的容灾，一般做到同城双活就足够了。那么，同城双活的方案要如何设计呢？</p><p><strong>假设这样的场景：</strong>你在北京有A和B两个机房，A是联通的机房，B是电信的机房，机房之间以专线连接，方案设计时，核心思想是尽量避免跨机房的调用。具体方案如下。</p><ul>\n<li>\n<p>首先，数据库的主库可以部署在一个机房中，比如部署在A机房中，那么A和B机房数据都会被写入到A机房中。然后，在A、B两个机房中各部署一个从库，通过主从复制的方式，从主库中同步数据，这样双机房的查询请求可以查询本机房的从库。一旦A机房发生故障，可以通过主从切换的方式将B机房的从库提升为主库，达到容灾的目的。</p>\n</li>\n<li>\n<p>缓存也可以部署在两个机房中，查询请求也读取本机房的缓存，如果缓存中数据不存在，就穿透到本机房的从库中加载数据。数据的更新可以更新双机房中的数据，保证数据的一致性。</p>\n</li>\n<li>\n<p>不同机房的RPC服务会向注册中心注册不同的服务组，而不同机房的RPC客户端，也就是Web服务，只订阅同机房的RPC服务组，这样就可以实现RPC调用尽量发生在本机房内，避免跨机房的RPC调用。</p>\n</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/c7/86/c7a4a321ba02cf3ff8c65e9d5bb99686.jpg?wh=1142*454\" alt=\"\"></p><p>你的系统肯定会依赖公司内的其他服务，比如审核、搜索等服务，如果这些服务也是双机房部署的，那么也需要尽量保证只调用本机房的服务，降低调用的延迟。</p><p>使用了同城双活架构之后，可以实现机房级别的容灾，服务的部署也能够突破单一机房的限制。但是，还是会存在跨机房写数据的问题，不过由于写数据的请求量不高，所以在性能上是可以容忍的。</p><h3>2.异地多活</h3><p>上面这个方案足够应对你目前的需要，但是，你的业务是不断发展的，如果有朝一日，你的电商系统的流量达到了京东或者淘宝的级别，那么你就要考虑即使机房所在的城市发生重大的自然灾害，也要保证系统的可用性。<strong>而这时，你需要采用异地多活的方案</strong>（据我所知，阿里和饿了么采用的都是异地多活的方案）。</p><p>在考虑异地多活方案时，你首先要考虑异地机房的部署位置。它部署的不能太近，否则发生自然灾害时，很可能会波及。所以，如果你的主机房在北京，那么异地机房就尽量不要建设在天津，而是可以选择上海、广州这样距离较远的位置。但这就会造成更高的数据传输延迟，同城双活中，使用的跨机房写数据库的方案，就不合适了。</p><p>所以，在数据写入时，你要保证只写本机房的数据存储服务再采取数据同步的方案，将数据同步到异地机房中。<strong>一般来说，数据同步的方案有两种：</strong></p><ul>\n<li>\n<p>一种基于存储系统的主从复制，比如MySQL和Redis。也就是在一个机房部署主库，在异地机房部署从库，两者同步主从复制实现数据的同步。</p>\n</li>\n<li>\n<p>另一种是基于消息队列的方式。一个机房产生写入请求后，会写一条消息到消息队列，另一个机房的应用消费这条消息后再执行业务处理逻辑，写入到存储服务中。</p>\n</li>\n</ul><p><strong>我建议你</strong>采用两种同步相结合的方式，比如，你可以基于消息的方式，同步缓存的数据、HBase数据等。然后基于存储，主从复制同步MySQL、Redis等数据。</p><p>无论是采取哪种方案，数据从一个机房传输到另一个机房都会有延迟，所以，你需要尽量保证用户在读取自己的数据时，读取数据主库所在的机房。为了达到这一点，你需要对用户做分片，让一个用户每次的读写都尽量在同一个机房中。同时，在数据读取和服务调用时，也要尽量调用本机房的服务。<strong>这里有一个场景：</strong>假如在电商系统中，用户A要查看所有订单的信息，而这些订单中，店铺的信息和卖家的信息很可能是存储在异地机房中，那么你应该优先保证服务调用，和数据读取在本机房中进行，即使读取的是跨机房从库的数据，会有一些延迟，也是可以接受的。</p><p><img src=\"https://static001.geekbang.org/resource/image/01/73/0138791e6164ea89380f262467820173.jpg?wh=1142*476\" alt=\"\"></p><h2>课程小结</h2><p>本节课，为了提升系统的可用性和稳定性，我带你探讨了多机房部署的难点以及同城双机房和异地多活的部署架构，<strong>在这里，我想强调几个重点：</strong></p><ul>\n<li>\n<p>不同机房的数据传输延迟是造成多机房部署困难的主要原因，你需要知道，同城多机房的延迟一般在1ms~3ms，异地机房的延迟在50ms以下，而跨国机房的延迟在200ms以下。</p>\n</li>\n<li>\n<p>同城多机房方案可以允许有跨机房数据写入的发生，但是数据的读取和服务的调用应该尽量保证在同一个机房中。</p>\n</li>\n<li>\n<p>异地多活方案则应该避免跨机房同步的数据写入和读取，而是采取异步的方式，将数据从一个机房同步到另一个机房。</p>\n</li>\n</ul><p>多机房部署是一个业务发展到一定规模，对于机房容灾有需求时才会考虑的方案，能不做则尽量不要做。一旦你的团队决定做多机房部署，那么同城双活已经能够满足你的需求了，这个方案相比异地多活要简单很多。而在业界，很少有公司能够搭建一套真正的异步多活架构，这是因为这套架构在实现时过于复杂，<strong>所以，轻易不要尝试。</strong></p><p>总之，架构需要依据系统的量级和对可用性、性能、扩展性的要求，不断演进和调整，盲目地追求架构的“先进性”只能造成方案的复杂，增加运维成本，从而给你的系统维护带来不便。</p><h2>一课一思</h2><p>在实际项目中，你在遇到怎样量级的情况下，才会考虑使用多机房部署的方案呢？在实施的过程中踩到了哪些坑呢？欢迎在留言区与我分享你的经验。</p><p>最后，感谢你的阅读，如果这篇文章让你有所收获，也欢迎你将它分享给更多的朋友。</p>","neighbors":{"left":{"article_title":"27 | API网关：系统的门面要如何做呢？","id":169944},"right":{"article_title":"29 | Service Mesh：如何屏蔽服务化系统的服务治理细节？","id":171182}},"comments":[{"had_liked":false,"id":156141,"user_name":"蓝魔丶","can_delete":false,"product_type":"c1","uid":1219438,"ip_address":"","ucode":"2AE4359E263558","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg","comment_is_top":false,"comment_ctime":1574823751,"is_pvip":false,"replies":[{"id":"60246","content":"1. 如果已经做了主从分离，那么只需要在异地机房配置主库是主机房的主库，从库配置本机房从库即可。主从延迟的问题，可以通过主动写缓存来解决<br>2. 像memcached这样的缓存是没有办法同步的，注册中心可以部署在单机房<br>3. 一般按照用户的属性来分片，比如ID，地域<br>4. 是的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1575016094,"ip_address":"","comment_id":156141,"utype":1}],"discussion_count":1,"race_medal":0,"score":"87474169671","product_id":100035801,"comment_content":"读了两遍，老师有4个问题<br>1.同城双活方案中，应用服务在跨机房写和同机房读的策略下，应用程序是如何实现这种策略的（读写分离），有相关的实现方案吗？并且是如何应对在并发情况下主从延长导致的读同机房数据库无数据问题。<br>2.同城双活方案中，缓存部署架构是在各种机房中创建缓存库，不进行缓存数据的同步吗？还是会与数据库类似建立主从机制保证同步缓存数据。注册中心部署架构是只需要部署到任意一个机房就可以是吗？不需要考虑在双机房都独立部署的情况嘛？<br>3.异地多活方案中，是如何做到对用户进行分片，保证尽量调用本机房的服务的？<br>4.异地多活方案中，最后提到的那个场景，我的理解是本次服务调用需要的数据很可能是存储在异地机房中，这样无法避免的进行远程的服务调用或数据访问，为了保证可用性，只有牺牲性能上延长，但是还是应该尽量避免这种跨异地的远程访问，保证两个异地两个机房中都有对方的所有东西，包括数据和服务等。","like_count":21,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476005,"discussion_content":"1. 如果已经做了主从分离，那么只需要在异地机房配置主库是主机房的主库，从库配置本机房从库即可。主从延迟的问题，可以通过主动写缓存来解决\n2. 像memcached这样的缓存是没有办法同步的，注册中心可以部署在单机房\n3. 一般按照用户的属性来分片，比如ID，地域\n4. 是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575016094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163292,"user_name":"Hinimix","can_delete":false,"product_type":"c1","uid":1316937,"ip_address":"","ucode":"7994136C93BD89","user_header":"https://static001.geekbang.org/account/avatar/00/14/18/49/b1d864e5.jpg","comment_is_top":false,"comment_ctime":1576681076,"is_pvip":false,"replies":[{"id":"62127","content":"是的，注册的名字里面带上机房标识，比如zw-feed-service(兆维-feed-服务)","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576734411,"ip_address":"","comment_id":163292,"utype":1}],"discussion_count":4,"race_medal":0,"score":"31641452148","product_id":100035801,"comment_content":"老师，比如用zk做注册中心，一个服务我在两个机房各部署了一套，我在web服务连接的时候怎么确定是本机房呢，是需要注册时候注册个机房名，然后web选择有这个机房名的吗","like_count":8,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478333,"discussion_content":"是的，注册的名字里面带上机房标识，比如zw-feed-service(兆维-feed-服务)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576734411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1003205,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4e/c5/78626367.jpg","nickname":"型火🔥","note":"","ucode":"C2322918B31E60","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305010,"discussion_content":"兆维什么鬼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599738373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1316937,"avatar":"https://static001.geekbang.org/account/avatar/00/14/18/49/b1d864e5.jpg","nickname":"Hinimix","note":"","ucode":"7994136C93BD89","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1003205,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4e/c5/78626367.jpg","nickname":"型火🔥","note":"","ucode":"C2322918B31E60","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":311123,"discussion_content":"啥兆纬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602230436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":305010,"ip_address":""},"score":311123,"extra":""}]},{"author":{"id":1316937,"avatar":"https://static001.geekbang.org/account/avatar/00/14/18/49/b1d864e5.jpg","nickname":"Hinimix","note":"","ucode":"7994136C93BD89","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100151,"discussion_content":"谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577238809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219817,"user_name":"ICE FROG","can_delete":false,"product_type":"c1","uid":1812082,"ip_address":"","ucode":"31E3DBD22CCC3E","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a6/72/526fd3df.jpg","comment_is_top":false,"comment_ctime":1590106970,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18769976154","product_id":100035801,"comment_content":"假定北京区数据库为A1（master）和A2（slave）；广东区为B1（Master）与B2（Slave）。按照上文所说的，A1同步给B2，B1同步给A2。那其实A1+B2与B1+A2的数据组合根本旧形成了数据孤岛。因为两两Master没有坐数据同步。如果B区挂了，A2会成为拥有B1数据的新Master。此时A1和A2就是两个数据来自不同区域的数据。此时怎么办呢？两个Master做同步的话，逗些得场景，如何解决bin log同步的回环问题呢？ 希望老师可以解答一下我的疑惑","like_count":3,"discussions":[{"author":{"id":1215758,"avatar":"https://static001.geekbang.org/account/avatar/00/12/8d/0e/1f49ade9.jpg","nickname":"大汉_客家族_数据工程_曾院士","note":"","ucode":"AD73C36D617CA1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319088,"discussion_content":"你这叫双主，A1  B1互相同步","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603940262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174640,"user_name":"小山猫","can_delete":false,"product_type":"c1","uid":1369437,"ip_address":"","ucode":"D9A5D96113063B","user_header":"https://static001.geekbang.org/account/avatar/00/14/e5/5d/b6378027.jpg","comment_is_top":false,"comment_ctime":1580305624,"is_pvip":false,"replies":[{"id":"68363","content":"这个根据业务特点定，比如淘宝就是按照uid来分片，饿了么是按照地域来分片","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1580873073,"ip_address":"","comment_id":174640,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14465207512","product_id":100035801,"comment_content":"老师好，异地用户分片用什么方案比较好，比如电商中涉及到用户、商品、商家，用户只看本机房对应的商品吗","like_count":4,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482470,"discussion_content":"这个根据业务特点定，比如淘宝就是按照uid来分片，饿了么是按照地域来分片","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580873073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015754,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","nickname":"helloworld","note":"","ucode":"00DF2FEC58D2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290927,"discussion_content":"我是北京的用户，如果按照uid进行分片的话，北京的用户被分到上海，那我每次请求就很长了吧，因为访问的是上海机房，而不是北京机房！请老师解惑","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1594644625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161756,"user_name":"洋洋洋","can_delete":false,"product_type":"c1","uid":1274903,"ip_address":"","ucode":"931CB27BFC49E0","user_header":"https://static001.geekbang.org/account/avatar/00/13/74/17/c86989cb.jpg","comment_is_top":false,"comment_ctime":1576317088,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14461218976","product_id":100035801,"comment_content":"老师，我感觉你在异地多活方案写的不是很详细，比如异地双机房的主库是否同步，每个机房是保存有全量的数据，以及异地多活的架构题也不是很清晰","like_count":3,"discussions":[{"author":{"id":1024294,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","nickname":"null","note":"","ucode":"F9039EFED6B55D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309513,"discussion_content":"我也觉得，要么前后矛盾，要么毫无逻辑。\n一会不能跨机房写，一会部署一台主库，一会又写各自机房的主库","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601310214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015754,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","nickname":"helloworld","note":"","ucode":"00DF2FEC58D2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290926,"discussion_content":"不是很详细","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594644542,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156952,"user_name":"阿卡牛","can_delete":false,"product_type":"c1","uid":1022247,"ip_address":"","ucode":"0BC43A904C3199","user_header":"https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg","comment_is_top":false,"comment_ctime":1575000225,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14459902113","product_id":100035801,"comment_content":"梦想还是要有的，万一有机会给我实践异地多活呢？","like_count":4,"discussions":[{"author":{"id":1971269,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/oltLEqTrmHm2aJP99BK6tHu5h7hp4aj08wR5Wt6H31iadFduDAVvjYKmhQ2nvGbLV3lkVdiat2GRasgWXoJeTibUg/132","nickname":"杨","note":"","ucode":"7EFEFE285975C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375754,"discussion_content":"我现在正在弄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621841473,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156276,"user_name":"扬一场远远的风","can_delete":false,"product_type":"c1","uid":1357801,"ip_address":"","ucode":"AB47E3D2EAB8A8","user_header":"https://static001.geekbang.org/account/avatar/00/14/b7/e9/5400cdf3.jpg","comment_is_top":false,"comment_ctime":1574847406,"is_pvip":false,"replies":[{"id":"60234","content":"你说的没错，数据是可以同步的，但是异地机房之间延迟比较高，同步也会有延迟的。","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1575015391,"ip_address":"","comment_id":156276,"utype":1}],"discussion_count":3,"race_medal":0,"score":"14459749294","product_id":100035801,"comment_content":"“这里有一个场景：假如在电商系统中，用户 A 要查看所有订单的信息，而这些订单中，店铺的信息和卖家的信息很可能是存储在异地机房中，那么你应该优先保证服务调用，和数据读取在本机房中进行，即使读取的是跨机房从库的数据，会有一些延迟，也是可以接受的。”这句没明白。我理解前文讲的“对于某个固定的乃，服务的调用和数据的读写都应该保证在同一个机房中”。而例子中：本人的基本信息和订单信息主库在机房A中，所以数据读取和服务调用应该保证在机房A ，而店铺信息主库和卖家信息主库在机房B中（机房A异步方式从机房B同步过来），此时，对于店铺信息和卖家信息的读取应该也是在机房A中吧？！","like_count":3,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476054,"discussion_content":"你说的没错，数据是可以同步的，但是异地机房之间延迟比较高，同步也会有延迟的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575015391,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1175507,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ef/d3/d4358103.jpg","nickname":"H-NL2724","note":"","ucode":"25DB114677EF58","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551180,"discussion_content":"大概意思是：“你等着数据库之间同步，而尽量不要自己主动跨机房去读”？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644918769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2756576,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/0f/e0/b53a7701.jpg","nickname":"骑车上天空","note":"","ucode":"364365E2721122","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1175507,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ef/d3/d4358103.jpg","nickname":"H-NL2724","note":"","ucode":"25DB114677EF58","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":583206,"discussion_content":"应该是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659950113,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":551180,"ip_address":"广东"},"score":583206,"extra":""}]}]},{"had_liked":false,"id":158970,"user_name":"被过去推开","can_delete":false,"product_type":"c1","uid":1276690,"ip_address":"","ucode":"8B4F34FE93FD5B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Cib5umA0W17N9pichI08pnrXAExdbyh7AVzH4nEhD6KN3FXuELk4LJJuqUPPD7xmIy9nq5Hjbgnzic7sVZG5BKiaUQ/132","comment_is_top":false,"comment_ctime":1575508494,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10165443086","product_id":100035801,"comment_content":"阿里云有跨区域mysql主从复制，比同机房的主从复制贵了不少","like_count":2,"discussions":[{"author":{"id":1006865,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5d/11/e1f36640.jpg","nickname":"怀朔","note":"","ucode":"52FAC1C2FD37B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292825,"discussion_content":"看你怎么理解这个价值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595342078,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156068,"user_name":"刘冲","can_delete":false,"product_type":"c1","uid":1000439,"ip_address":"","ucode":"0C4F66921AE76C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/43/f7/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1574816878,"is_pvip":false,"replies":[{"id":"60241","content":"数据库同步的方案是一样的，只是同城机房之间的数据延迟小，对于业务的影响小。异地的话数据同步延迟比较高，可能对业务有影响","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1575015715,"ip_address":"","comment_id":156068,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10164751470","product_id":100035801,"comment_content":"同城双机房，数据库同步和异城数据库同步方案有啥区别？图上没看太懂，","like_count":2,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475975,"discussion_content":"数据库同步的方案是一样的，只是同城机房之间的数据延迟小，对于业务的影响小。异地的话数据同步延迟比较高，可能对业务有影响","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575015715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364860,"discussion_content":"分片 + 双向同步","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617631875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1025067,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a4/2b/3ba9f64b.jpg","nickname":"Devin","note":"","ucode":"7BDCD517BD8DD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":63191,"discussion_content":"重点是同城双机房是单向同步，异城双机房是双向同步。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574867738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156028,"user_name":"星空123","can_delete":false,"product_type":"c1","uid":1596920,"ip_address":"","ucode":"E998A7C585671B","user_header":"https://static001.geekbang.org/account/avatar/00/18/5d/f8/7de2c1cc.jpg","comment_is_top":false,"comment_ctime":1574814359,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10164748951","product_id":100035801,"comment_content":"这就是为啥公司买服务器都会买同个大区，同个可用区的原因了。减少两个服务器交互的网络延迟","like_count":2},{"had_liked":false,"id":159711,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1575734538,"is_pvip":false,"replies":[{"id":"61433","content":"是的，通过分片尽量让用户访问本机房的数据","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576131506,"ip_address":"","comment_id":159711,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5870701834","product_id":100035801,"comment_content":"老师请问一下，异地多活的方案中，A机房的主库同步到B机房的从库，B机房的主库同步到A机房的从库。我理解：那A机房的服务看到的是自己机房的主库和对方机房的从库，通过数据库分片，不同的数据路由到不同数据库，是这样的吗？分片在A机房主库中的数据和分片在B机房主库找那个的数据不做同步？","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477148,"discussion_content":"是的，通过分片尽量让用户访问本机房的数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576131506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1274903,"avatar":"https://static001.geekbang.org/account/avatar/00/13/74/17/c86989cb.jpg","nickname":"洋洋洋","note":"","ucode":"931CB27BFC49E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":82070,"discussion_content":"老师。我理解所有机房都是保留全量数据吧，只是用户的请求根据uid分片","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1576316905,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":158520,"user_name":"阿土","can_delete":false,"product_type":"c1","uid":1183019,"ip_address":"","ucode":"2DBEAD80B0CA3C","user_header":"https://static001.geekbang.org/account/avatar/00/12/0d/2b/4814d3db.jpg","comment_is_top":false,"comment_ctime":1575393364,"is_pvip":false,"replies":[{"id":"61448","content":"一般是通过队列来实现","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576132913,"ip_address":"","comment_id":158520,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5870360660","product_id":100035801,"comment_content":"老师，异地多活架构中，数据双向同步如何做？","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476754,"discussion_content":"一般是通过队列来实现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576132913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156134,"user_name":"海罗沃德","can_delete":false,"product_type":"c1","uid":1165364,"ip_address":"","ucode":"8704F1D6980FA0","user_header":"https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg","comment_is_top":false,"comment_ctime":1574823088,"is_pvip":false,"replies":[{"id":"60236","content":"异地多活的方案中，数据的延迟就是坑","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1575015475,"ip_address":"","comment_id":156134,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5869790384","product_id":100035801,"comment_content":"我們使用AWS，跨region部署，會導致緩存不同步，而AWS不支持跨region複製redis數據，而我們又沒有做用戶分片，導致PM，測試都在玩命用同一個用戶側跨region的case","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476001,"discussion_content":"异地多活的方案中，数据的延迟就是坑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575015475,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324947,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1638753130,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638753130","product_id":100035801,"comment_content":"现在搞外包都要同城多活落地了，还要提异地多活方案，才能参与投标😭","like_count":0},{"had_liked":false,"id":306324,"user_name":"belief","can_delete":false,"product_type":"c1","uid":1765541,"ip_address":"","ucode":"563EDA9F2C9214","user_header":"https://static001.geekbang.org/account/avatar/00/1a/f0/a5/ff758400.jpg","comment_is_top":false,"comment_ctime":1628497366,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628497366","product_id":100035801,"comment_content":"12306系统架构是同城双活还是异地多活","like_count":0},{"had_liked":false,"id":297059,"user_name":"阿甘","can_delete":false,"product_type":"c1","uid":1057843,"ip_address":"","ucode":"BC93175B70E05D","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","comment_is_top":false,"comment_ctime":1623295098,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1623295098","product_id":100035801,"comment_content":"老师的意思是按照某种方式对用户进行分片路由，写入都固定在某一个机房，然后同步到其他的机房。如果有某个机房有故障发生，就将流量切换到其他的某个机房，把它原来同步的只读库提升为可以读写的主库对吗？","like_count":0},{"had_liked":false,"id":289944,"user_name":"石头","can_delete":false,"product_type":"c1","uid":2586341,"ip_address":"","ucode":"EB3C9A277C7B0C","user_header":"","comment_is_top":false,"comment_ctime":1619274269,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619274269","product_id":100035801,"comment_content":"作者总结的挺全的。<br>如果业务做大到用户遍布全国且达到亿级别时，从广东调到北京的50ms就有点难以接受了，反正要做多机房，不如把异地多机房也做起来，可以较大提升体验。<br>不过确实这个方案会有根据用户注册地调度不同机房提升体验，从而变成了多机房写，如果进行流量调度会很复杂。所以可以分大区域部署多个同城双机房，尽可能不要跨城流量调度，只要没有城市级别的灾难一般不需要这样做，这个概率非常小。<br>其实最复杂的是海外，因为政策问题需要具备随时跨国家调度流量的能力，还要保证数据同步没问题。国内相对稳定","like_count":0},{"had_liked":false,"id":287689,"user_name":"沙漠之鹰","can_delete":false,"product_type":"c1","uid":1222887,"ip_address":"","ucode":"9FB290B874317F","user_header":"https://static001.geekbang.org/account/avatar/00/12/a8/e7/b86938a1.jpg","comment_is_top":false,"comment_ctime":1618109880,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618109880","product_id":100035801,"comment_content":"A机房全部跪了，写流量直接切到B机房？ 主从同步会有延迟吧，会丢数据，怎么解决","like_count":0},{"had_liked":false,"id":246727,"user_name":"Jaime","can_delete":false,"product_type":"c1","uid":1078333,"ip_address":"","ucode":"904192CC4E916F","user_header":"https://static001.geekbang.org/account/avatar/00/10/74/3d/54bbc1df.jpg","comment_is_top":false,"comment_ctime":1599465763,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1599465763","product_id":100035801,"comment_content":"请教一下老师 mongodb官方说是支持异地多活的，这个方案靠谱，还是说也尽量不要去尝试吗？","like_count":0},{"had_liked":false,"id":232303,"user_name":"初学者","can_delete":false,"product_type":"c1","uid":1312276,"ip_address":"","ucode":"558A27BABA2E11","user_header":"https://static001.geekbang.org/account/avatar/00/14/06/14/0bc20de3.jpg","comment_is_top":false,"comment_ctime":1593951058,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593951058","product_id":100035801,"comment_content":"异地双活的架构中，用消息队列同步缓存的数据的作用是啥？<br>缓存在本地拉取不就可以了么？ <br>难道是为了保证两边的缓存数据的一致性？ <br>有没有可能 <br>机房B的DB数据还没有同步到，但是缓存的数据确有了，然后缓存失效了之后，再次访问机房B的时候，又访问不到这个数据？ 出现了所谓了不可重复读？","like_count":0},{"had_liked":false,"id":224070,"user_name":"Jast","can_delete":false,"product_type":"c1","uid":1500072,"ip_address":"","ucode":"8F563226BF2A3F","user_header":"https://static001.geekbang.org/account/avatar/00/16/e3/a8/249f6d53.jpg","comment_is_top":false,"comment_ctime":1591265491,"is_pvip":false,"replies":[{"id":"82714","content":"是的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1591538346,"ip_address":"","comment_id":224070,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591265491","product_id":100035801,"comment_content":"“另一个思路是在机房 B 部署一个从库，跨机房同步主库的数据，然后机房 B 的应用就可以读取这个从库的数据了” 老师您好，这个机房B写是写到A机房的主库吗","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497353,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591538346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214732,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1588811897,"is_pvip":false,"replies":[{"id":"83127","content":"👍","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1591803972,"ip_address":"","comment_id":214732,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588811897","product_id":100035801,"comment_content":"网络通信主要依赖光和电，光和电的速度是快，不过再快从一个空间到另一个空间也需要时间。并且距离越远耗时越多，不过为了服务的可用性，也没什么好法子只能通过副本或者隔离的方式来提供更高可用的服务，很简单的道理不把鸡蛋放在同一个篮子，防止一次全部打烂。<br>距离远——隔离性好——服务更高可用<br>距离远——数据延迟大——服务架构更复杂——成本更高<br>想要的东西是矛盾的，无法实现都满足，只能选择一个平衡点。所以，什么时候选择同城多活或异地多活，也是一样需要寻找一个平衡点，原则是能不用就不用，逼不得已非用不可了，没得选那就用吧！此时人力物力财力，可能也能支持啦！","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494187,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591803972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207153,"user_name":"GaGi","can_delete":false,"product_type":"c1","uid":1099053,"ip_address":"","ucode":"CC8D22E1DD8CA2","user_header":"https://static001.geekbang.org/account/avatar/00/10/c5/2d/1eebfc3c.jpg","comment_is_top":false,"comment_ctime":1587017830,"is_pvip":false,"replies":[{"id":"78088","content":"是的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1587472867,"ip_address":"","comment_id":207153,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1587017830","product_id":100035801,"comment_content":"对于异地多活中的数据同步方案的第一个，基于存储系统的主从复制，<br>请问是每个机房都有部署一套主数据库和从数据库，<br>然后通过用户分片到不同的机房，写入对应机房的主库，<br>然后通过主从复制，将对应机房主库的数据同步到其他机房的备库吗","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492028,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587472867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099053,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c5/2d/1eebfc3c.jpg","nickname":"GaGi","note":"","ucode":"CC8D22E1DD8CA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":242361,"discussion_content":"谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587477376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":202356,"user_name":"宝仔","can_delete":false,"product_type":"c1","uid":1013493,"ip_address":"","ucode":"A0F17DFF99DB21","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","comment_is_top":false,"comment_ctime":1585974071,"is_pvip":true,"replies":[{"id":"75832","content":"没必要呀 注册中心负载也不高","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1586087896,"ip_address":"","comment_id":202356,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585974071","product_id":100035801,"comment_content":"老师想问下同城双活架构中，注册中心为什么不是一个机房一个，而是多机房共享一个注册中心","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490567,"discussion_content":"没必要呀 注册中心负载也不高","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586087896,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192301,"user_name":"sipom","can_delete":false,"product_type":"c1","uid":1074197,"ip_address":"","ucode":"80411DC49CFA57","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/15/9c9ca35c.jpg","comment_is_top":false,"comment_ctime":1584845901,"is_pvip":false,"replies":[{"id":"73897","content":"👍","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1585019942,"ip_address":"","comment_id":192301,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584845901","product_id":100035801,"comment_content":"一般大公司、大项目，对可用性要求特别高的情况，需要考虑采用异地多活架构。主要挑战：异地通信的延迟远远大于同机房、同城，一般需要在异地机房间做数据同步。","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488363,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585019942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192034,"user_name":"kamida","can_delete":false,"product_type":"c1","uid":1904146,"ip_address":"","ucode":"16D7CA59870AC0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/jXbwicoDwia7ooDfwBTRyvNYQkefnVwF1CMicMS8FqKfuFAdvVZo2pqc4ic0R9kSdHTIxaE6YyqxwX8BdNGv5PqSIw/132","comment_is_top":false,"comment_ctime":1584821320,"is_pvip":false,"replies":[{"id":"73899","content":"数据应该是分片的，一个数据只向一个机房主库写入","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1585019985,"ip_address":"","comment_id":192034,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1584821320","product_id":100035801,"comment_content":"异地多活 每个机房都向自己的主数据库写入 怎么解决冲突的问题呢？ 比如两个机房都修改用一个信息<br>","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488314,"discussion_content":"数据应该是分片的，一个数据只向一个机房主库写入","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585019985,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1666708,"avatar":"","nickname":"Geek_219216","note":"","ucode":"10059F4DE69C30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332764,"discussion_content":"分布式id 或 数据库增长步长区分？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607333978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1904146,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/jXbwicoDwia7ooDfwBTRyvNYQkefnVwF1CMicMS8FqKfuFAdvVZo2pqc4ic0R9kSdHTIxaE6YyqxwX8BdNGv5PqSIw/132","nickname":"kamida","note":"","ucode":"16D7CA59870AC0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211955,"discussion_content":"可以解答一下吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584906878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":189793,"user_name":"芳菲菲兮满堂","can_delete":false,"product_type":"c1","uid":1000860,"ip_address":"","ucode":"C8D89999C201F1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/45/9c/5b06d143.jpg","comment_is_top":false,"comment_ctime":1584551524,"is_pvip":true,"replies":[{"id":"73089","content":"也要考虑自身业务特点，不是大厂的方案就一定适合","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1584590449,"ip_address":"","comment_id":189793,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1584551524","product_id":100035801,"comment_content":"云时代 就可以多接触这种大厂才有的方案","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487796,"discussion_content":"也要考虑自身业务特点，不是大厂的方案就一定适合","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584590449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":185419,"user_name":"Li Yao","can_delete":false,"product_type":"c1","uid":1129838,"ip_address":"","ucode":"703E1E5505F70D","user_header":"https://static001.geekbang.org/account/avatar/00/11/3d/6e/60680aa4.jpg","comment_is_top":false,"comment_ctime":1583579986,"is_pvip":false,"replies":[{"id":"72168","content":"网关","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1584011381,"ip_address":"","comment_id":185419,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1583579986","product_id":100035801,"comment_content":"用户分片一般是通过什么组件做的呢？DNS调度不支持用户ID分片吧？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":486354,"discussion_content":"网关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584011381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178661,"user_name":"我行我素","can_delete":false,"product_type":"c1","uid":1224678,"ip_address":"","ucode":"4C69542FAB0671","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/e6/9c77acff.jpg","comment_is_top":false,"comment_ctime":1581774843,"is_pvip":false,"replies":[{"id":"69662","content":"是的，有的在主库，有的在从库","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1582001497,"ip_address":"","comment_id":178661,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1581774843","product_id":100035801,"comment_content":"不是每个都有完整的数据吗","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483913,"discussion_content":"是的，有的在主库，有的在从库","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582001497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015754,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","nickname":"helloworld","note":"","ucode":"00DF2FEC58D2E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290928,"discussion_content":"只有主库才有全量数据吧？怎么会存在从库比主库还要全的情况？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594644670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178660,"user_name":"我行我素","can_delete":false,"product_type":"c1","uid":1224678,"ip_address":"","ucode":"4C69542FAB0671","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/e6/9c77acff.jpg","comment_is_top":false,"comment_ctime":1581774824,"is_pvip":false,"replies":[{"id":"69661","content":"可以的，会存储在从库中~","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1582001482,"ip_address":"","comment_id":178660,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1581774824","product_id":100035801,"comment_content":"想请问下，在异步多活中为什么会存在 店铺的信息和卖家的信息很可能是存储在异地机房中？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483912,"discussion_content":"可以的，会存储在从库中~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582001482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1480119,"avatar":"https://static001.geekbang.org/account/avatar/00/16/95/b7/15e157ec.jpg","nickname":"路人甲","note":"","ucode":"B720984454AFAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382817,"discussion_content":"我在上海买的东西存在上海机房了，我跑北京买东西存在北京机房了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625730538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364862,"discussion_content":"为什么从库数据会比主库全？\n我理解应当是主库分片","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617632098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161102,"user_name":"👽","can_delete":false,"product_type":"c1","uid":1274117,"ip_address":"","ucode":"D313AF941B412D","user_header":"https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg","comment_is_top":false,"comment_ctime":1576119203,"is_pvip":false,"replies":[{"id":"61428","content":"额 一般也不会有宕机一天对公司没有影响的项目吧<br><br>主要是架构复杂度带来的成本和可用性之间的权衡","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1576131058,"ip_address":"","comment_id":161102,"utype":1}],"discussion_count":5,"race_medal":0,"score":"1576119203","product_id":100035801,"comment_content":"我的理解：还是得分析了流量价值。如果，机房宕机会给公司带来较大损失的时候。就需要考虑多活。但是，如果宕机对系统没什么太大的影响（例如停一天也没什么影响的项目），就并不需要考虑多活。","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477598,"discussion_content":"额 一般也不会有宕机一天对公司没有影响的项目吧\n\n主要是架构复杂度带来的成本和可用性之间的权衡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576131058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1213078,"avatar":"https://static001.geekbang.org/account/avatar/00/12/82/96/aa795685.jpg","nickname":"mghio","note":"","ucode":"74883EDE4FD0DC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":261543,"discussion_content":"这种系统是不是只要在工作日能运行就行了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588982909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1274117,"avatar":"https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg","nickname":"👽","note":"","ucode":"D313AF941B412D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1213078,"avatar":"https://static001.geekbang.org/account/avatar/00/12/82/96/aa795685.jpg","nickname":"mghio","note":"","ucode":"74883EDE4FD0DC","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":266281,"discussion_content":"基本上 是的。人家不用的时候 只要愿意，你可以把服务器停了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589500630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":261543,"ip_address":""},"score":266281,"extra":""},{"author":{"id":1213078,"avatar":"https://static001.geekbang.org/account/avatar/00/12/82/96/aa795685.jpg","nickname":"mghio","note":"","ucode":"74883EDE4FD0DC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1274117,"avatar":"https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg","nickname":"👽","note":"","ucode":"D313AF941B412D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":266586,"discussion_content":"优秀，下班无压力，我们 24 小时监控告警，轮流值班","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589536161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":266281,"ip_address":""},"score":266586,"extra":""}]},{"author":{"id":1274117,"avatar":"https://static001.geekbang.org/account/avatar/00/13/71/05/db554eba.jpg","nickname":"👽","note":"","ucode":"D313AF941B412D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":79981,"discussion_content":"“额 一般也不会有宕机一天对公司没有影响的项目吧” 之前做的政府的项目。下班以后停一晚上都没事，没有人问我们索取赔偿的原因，可能主要是两边领导的关系好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576132361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":158486,"user_name":"longslee","can_delete":false,"product_type":"c1","uid":1465986,"ip_address":"","ucode":"C24E32E5B1B6F5","user_header":"https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg","comment_is_top":false,"comment_ctime":1575382328,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575382328","product_id":100035801,"comment_content":"打卡。emmm，全是大佬经验，跪了","like_count":0},{"had_liked":false,"id":156855,"user_name":"MoonGod","can_delete":false,"product_type":"c1","uid":1254337,"ip_address":"","ucode":"CB39976963F37A","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/c1/54ef6885.jpg","comment_is_top":false,"comment_ctime":1574988699,"is_pvip":false,"replies":[{"id":"60228","content":"是要同步的，因为你很难做到用户完全分片，所有的请求都落入到本机房中","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1575014673,"ip_address":"","comment_id":156855,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1574988699","product_id":100035801,"comment_content":"老师请问一下，异地多活的方案中，两地数据库数据是相互隔离的吗？主从同步的方案只是把本机房的从库放倒对端机房。但对端机房主库写入的数据不会同步到这个从库中吧？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476256,"discussion_content":"是要同步的，因为你很难做到用户完全分片，所有的请求都落入到本机房中","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575014673,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156230,"user_name":"小喵喵","can_delete":false,"product_type":"c1","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":false,"comment_ctime":1574840013,"is_pvip":false,"replies":[{"id":"60235","content":"云服务是有可用区概念的，你可以理解为同城多机房：）","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1575015411,"ip_address":"","comment_id":156230,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1574840013","product_id":100035801,"comment_content":"在小公司，连机房都没有，都是部署在云服务器上。这怎么学习这些架构呢？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476040,"discussion_content":"云服务是有可用区概念的，你可以理解为同城多机房：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575015411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156048,"user_name":"星空123","can_delete":false,"product_type":"c1","uid":1596920,"ip_address":"","ucode":"E998A7C585671B","user_header":"https://static001.geekbang.org/account/avatar/00/18/5d/f8/7de2c1cc.jpg","comment_is_top":false,"comment_ctime":1574815519,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574815519","product_id":100035801,"comment_content":"异步多活架构，这套架构太花钱了","like_count":0}]}