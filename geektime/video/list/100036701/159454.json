{"id":159454,"title":"27 | æºç å‰–æï¼šæ–­å¼€è¿æ¥","content":"<p><strong>è¯¾ä»¶å’ŒDemoåœ°å€</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":204874,"user_name":"delete is create","can_delete":false,"product_type":"c3","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1586485490,"is_pvip":false,"replies":[{"id":79677,"content":"æ‰€ä»¥ä½ è¦å¼•å…¥idleæ£€æµ‹ï¼Œå‘ç°è¿™äº›å› ä¸ºæ–­ç½‘æ–­ç”µè€Œæ— æ•ˆçš„è¿æ¥ï¼Œä»è€Œä¸»åŠ¨æ–­å¼€ï¼ˆchannelHandlerContext.close()ï¼‰,è¿™ä¸ªæ—¶å€™å°±ä¼šè§¦å‘ç›¸åº”çš„æ–¹æ³•äº†ã€‚å¦‚æœæ²¡æœ‰å¼•å…¥ï¼Œå°±ä¸ä»…æ˜¯ç»Ÿä¸€ä¸å‡†çš„é—®é¢˜äº†ï¼Œè¿˜ç­‰äºè¯´å­˜åœ¨èµ„æºæ³„æ¼äº†ï¼ˆâ€œåƒµå°¸â€è¿æ¥ï¼‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"stroller","uid":1638649,"ctime":1588977400,"ip_address":"","comment_id":204874,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"å¦‚ä½•è·å–å½“å‰æ‰€æœ‰è¿æ¥ï¼Œæˆ–è€…å¦‚ä½•ç»Ÿè®¡å½“å‰è¿æ¥æ•°å‘¢ï¼Ÿç›´æ¥åœ¨æ³¨å†Œå’Œæ–­å¼€æ—¶åŠ ä¸€å‡ä¸€ä¸å‡†ï¼Œ  å› ä¸ºå®¢æˆ·ç«¯æ–­ç½‘æ–­ç”µå  è¿™äº›æ–¹æ³•ä¸ä¼šè¢«è§¦å‘","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"å‚…å¥","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491314,"discussion_content":"æ‰€ä»¥ä½ è¦å¼•å…¥idleæ£€æµ‹ï¼Œå‘ç°è¿™äº›å› ä¸ºæ–­ç½‘æ–­ç”µè€Œæ— æ•ˆçš„è¿æ¥ï¼Œä»è€Œä¸»åŠ¨æ–­å¼€ï¼ˆchannelHandlerContext.close()ï¼‰,è¿™ä¸ªæ—¶å€™å°±ä¼šè§¦å‘ç›¸åº”çš„æ–¹æ³•äº†ã€‚å¦‚æœæ²¡æœ‰å¼•å…¥ï¼Œå°±ä¸ä»…æ˜¯ç»Ÿä¸€ä¸å‡†çš„é—®é¢˜äº†ï¼Œè¿˜ç­‰äºè¯´å­˜åœ¨èµ„æºæ³„æ¼äº†ï¼ˆâ€œåƒµå°¸â€è¿æ¥ï¼‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588977400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136188,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/3c/e345522b.jpg","nickname":"xxwy","note":"","ucode":"BA2476EAF31F0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":241820,"discussion_content":"DefaultChannelGroup","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587442531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209025,"user_name":"æ­¦æ–‡æ–‡æ­¦","can_delete":false,"product_type":"c3","uid":1108924,"ip_address":"","ucode":"5288366646A15B","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/bc/6ccac4bb.jpg","comment_is_top":false,"comment_ctime":1587481269,"is_pvip":false,"replies":[{"id":78817,"content":"å›å¤åœ¨æ‚¨ç¬¬äºŒä¸ªæçš„é—®é¢˜ä¸Šäº†ã€‚è¿™é‡Œä¸å†èµ˜è¿°äº†ã€‚è¯·æŸ¥çœ‹ï¼Œæœ‰é—®é¢˜å†æ²Ÿé€šï¼Œè°¢è°¢ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"stroller","uid":1638649,"ctime":1588055296,"ip_address":"","comment_id":209025,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªé—®é¢˜è¯·æ•™ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç”¨nettyåšæœåŠ¡ç«¯ï¼Œå‰ç«¯è®¿é—®æœåŠ¡ç«¯æ˜¯ä»ä¸€ä¸ªè¿æ¥æ± ä¸­æ‹¿è¿æ¥ï¼Œç„¶åè®¿é—®nettyæœåŠ¡ç«¯ï¼Œä½†æ˜¯ç°åœ¨ç”Ÿäº§è¿ç»´æå‡ºè®©æˆ‘å®ç°ä¼˜é›…å…³é—­ï¼Œä¹Ÿå°±æ˜¯åœ¨æœåŠ¡ç«¯å‡çº§çš„æ—¶å€™è¦è®©å®¢æˆ·ç«¯æ— æ„ŸçŸ¥ï¼Œä½†æ˜¯ç”±äºè¿æ¥æ˜¯åŸºäºtcpçš„é•¿è¿æ¥ï¼Œå°±ç®—ç”¨gracefulShutdownä¹Ÿä¿è¯ä¸äº†å®¢æˆ·ç«¯æ— æ„ŸçŸ¥ï¼Œæ‚¨æœ‰ä»€ä¹ˆå¥½çš„å»ºè®®æ¥å®ç°è¿™ç§é•¿è¿æ¥çš„ä¼˜é›…å…³é—­å—ï¼Ÿæ„Ÿè°¢è€å¸ˆçš„æŒ‡æ•™","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"å‚…å¥","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492704,"discussion_content":"å›å¤åœ¨æ‚¨ç¬¬äºŒä¸ªæçš„é—®é¢˜ä¸Šäº†ã€‚è¿™é‡Œä¸å†èµ˜è¿°äº†ã€‚è¯·æŸ¥çœ‹ï¼Œæœ‰é—®é¢˜å†æ²Ÿé€šï¼Œè°¢è°¢ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588055296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258566,"user_name":"å†¬æ¸æš–","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1604484413,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"å…³é—­ä¹‹å‰æµç¨‹ä¸ºï¼š\n1.å¤šè·¯å¤ç”¨å™¨(Selector) æ¥æ”¶åˆ°OP_ READäº‹ä»¶:\n2.å¤„ç†OP_ READäº‹ä»¶: NioSocketChannel.NioSocketChannelUnsafe.read()\nè°ƒç”¨NioSocketChannelUnsafeï¼Œè¿™ä¸ªç±»é‡Œé¢æœ‰ä¸ªé‡è½½æ–¹æ³•prepareToClose(),å®˜æ–¹ä»‹ç»ä¸ºâ€œWe need to cancel this key of the channel so we may not end up in a eventloop spinï¼Œ because we try to read or write until the actual close happens which may be later dueï¼Œ SO_LINGER handling.â€ æ„æ€å¤§æ¦‚å°±æ˜¯æˆ‘å…ˆå»è¯•ä¸‹è¯»æˆ–è€…å†™ï¼Œçœ‹çœ‹ä½ æ˜¯ä¸æ˜¯éª—æˆ‘çš„ï¼Œå¤±è´¥äº†æ‰æ˜¯çœŸæ­£çš„å…³é—­\nä¼˜é›…çš„å…³é—­åŠ¨ä½œï¼š\nunbind nettyåˆ›å»ºçš„æ‰€æœ‰channelã€‚channel.unbind()\nclose nettyåˆ›å»ºçš„æ‰€æœ‰channelã€‚channel.close()\nshutdown nettyçš„çº¿ç¨‹æ‰§è¡Œå™¨ã€‚factory.releaseExternalResources()\næœ¬è´¨æ˜¯\n1.å…ˆå…³channel (åŒ…å«cancelå¤šè·¯å¤ç”¨å™¨çš„key)\n2.æ¸…ç†æ¶ˆæ¯ï¼šæ–°æ¶ˆæ¯å…¨éƒ¨ä¸ç»™è¿›ï¼Œé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ä¹Ÿå…¨éƒ¨æ¸…æ‰\n3.è§¦å‘fireChannellnactiveå’ŒfireChannelUnregistered\n\n\ncloseæ–¹æ³•ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºæ­£å¸¸çš„æŒ¥æ‰‹è¯·æ±‚ï¼Œæ‰§è¡Œpipelineé‡Œé¢çš„inactiveå’Œunregisteræ–¹æ³•ï¼Œå³åœæ­¢è¿è¡Œå’Œå–æ¶ˆæ³¨å†Œã€‚å½“ç„¶ä¹Ÿæœ‰åšä¼˜åŒ–--ã€‹å³å…³é—­è¿æ¥åˆ°ä¸€å®šæ•°é‡(é˜€å€¼)çš„æ—¶å€™ï¼Œåé¢çš„é“¾æ¥å¯èƒ½ä¹Ÿç›¸åº”çš„å…³æ‰äº†ï¼Œæ‰€ä»¥å°±é‡æ–°æ£€æŸ¥ä¸‹æ‰€æœ‰çš„è¿æ¥æœ‰æ²¡æœ‰å…³é—­ï¼Œå¯ä»¥å‡å°‘å…³é—­é‚£äº›å·²ç»è¢«å…³é—­çš„è¿æ¥æ‰€ç”¨çš„æ—¶é—´\n\nè€Œå¼‚å¸¸å…³é—­ï¼Œå®¢æˆ·ç«¯æ¥ä¸åŠå‘å‡ºæŒ¥æ‰‹è¯·æ±‚ï¼Œå‘å‡ºçš„æ˜¯RSTå¤ä½è¯·æ±‚ï¼ŒæœåŠ¡ç«¯åœ¨åˆšæ‰è¯´çš„unsafe.readæ–¹æ³•ä¸­doReadBytes(byteBuf)è¿™å¥ç›´æ¥æŠ›å‡ºI&#47;Oå¼‚å¸¸ï¼Œè¢«æ•æ‰åè¿›å…¥handleReadExceptionæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­æœ‰fireExceptionCaughtè°ƒç”¨pipelineçš„exceptionCaughtæ–¹æ³•ï¼Œè€ŒfireExceptionCaughtä¸‹é¢è¿˜æœ‰ä¹‹å‰è¯´çš„closeOnReadï¼Œæ‰§è¡Œpipelineé‡Œé¢çš„inactiveå’Œunregisteræ–¹æ³•ã€‚\n\nå’Œread writeä¸€æ ·ï¼Œå…³é—­çš„æœ¬è´¨è¿˜æ˜¯è°ƒç”¨äº†jdkçš„java.nio.channels.spi.AbstractInterruptibleChannel\nçš„closeæ–¹æ³•ï¼Œçœ‹æ¸…äº†ï¼Œä¸æ˜¯sun.nio.ch.SocketChannelImpl\n","like_count":3},{"had_liked":false,"id":242608,"user_name":"å¶å³¥ç‘¶","can_delete":false,"product_type":"c3","uid":1797584,"ip_address":"","ucode":"170E0F29BC6D4D","user_header":"","comment_is_top":false,"comment_ctime":1597796966,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"å¦‚æœç¬¬ä¸‰ç« è®²è§£è¿™äº›æµç¨‹çš„æ—¶å€™ï¼Œèƒ½é¡ºä¾¿å¸¦ä¸Šç¬¬äºŒç« ä¸­è®²è§£çš„ä¸€äº›ç‰¹æ€§å°±æ›´å¥½äº†ï¼Œç¬¬ä¸‰ç« è·Ÿç¬¬äºŒç« å¤ªå‰²è£‚äº†ï¼›è¯·é—®ä¸‹è€å¸ˆï¼Œnettyçš„bytebufæ”¯æŒå †å¤–å†…å­˜å’Œå †å†…å†…å­˜ï¼Œé‚£ä»€ä¹ˆåœºæ™¯éœ€è¦ç”¨å †å†…&#47;å †å¤–ï¼Ÿ","like_count":1},{"had_liked":false,"id":233204,"user_name":"delete is create","can_delete":false,"product_type":"c3","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1594260279,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"è€å¸ˆ nettyé›†ç¾¤æ­å»º æ€ä¹ˆåšï¼Ÿ  ç”¨ä»€ä¹ˆåšè´Ÿè½½å‡è¡¡ï¼Ÿ ç”¨ä»€ä¹ˆç®¡ç†channelï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1370304,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLNgTWpN9vEUMZ77xTkiaPibX8E22c2L5GTmkgyP4cajbNiap5zEp28HicvA8eOCQqYo7YDsAhuafict2Q/132","nickname":"Geek_lbv7gj","note":"","ucode":"0CD6F332407936","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532753,"discussion_content":"åŒé—®ï¼Ÿæœ‰æ–¹æ¡ˆäº†å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637677957,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241011,"user_name":"æ˜ŸæœŸå…«","can_delete":false,"product_type":"c3","uid":1185504,"ip_address":"","ucode":"34A37F73A48E7F","user_header":"https://static001.geekbang.org/account/avatar/00/12/16/e0/7abad3cc.jpg","comment_is_top":false,"comment_ctime":1597149479,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"å¦‚æœæ˜¯kill -9å…³é—­ç¨‹åºè¿˜ä¼šè§¦å‘å¼‚å¸¸å…³é—­å¾—è¿‡ç¨‹å—ï¼Ÿ\nå¦‚æœä¸è§¦å‘ï¼Œä¼šä¸ä¼šå‡ºç°å®¢æˆ·ç«¯è¿‡ä¸€ç‚¹æ—¶é—´æ‰ä¼šè‡ªåŠ¨æ–­æ‰å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":174749,"user_name":"ğŸ’¢ æ˜Ÿæ˜ŸğŸ’¢","can_delete":false,"product_type":"c3","uid":1254392,"ip_address":"","ucode":"A402B765222C35","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/f8/24fcccea.jpg","comment_is_top":false,"comment_ctime":1580370360,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"è€å¸ˆï¼Œä½ æœ€åçš„ä»£ç èµ°åˆ° pipeline.fireChannelInactive()ï¼Œpipeline.fireChannelUnregistered()  è¿™äºŒä¸ªäº‹ä»¶æ˜¯å¹²å•¥çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1560646,"avatar":"https://static001.geekbang.org/account/avatar/00/17/d0/46/2a4fec72.jpg","nickname":"èµ°èµ°ï½ åœåœ","note":"","ucode":"083B0027B2DEE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292477,"discussion_content":"è€å¸ˆ, å…¬å¸é¡¹ç›®æ˜¯ç‰©è”ç½‘ç›¸å…³,å®¢æˆ·ç«¯åœ¨æµ·å¤–ä½¿ç”¨æ— çº¿ç½‘å¡è¿æ¥æœåŠ¡å™¨, æœåŠ¡ç«¯è¿”å›è¿æ¥æˆåŠŸ, å®¢æˆ·ç«¯ä¹‹åä¼šæ¯éš”12ç§’å‘é€ä¸€æ¬¡å¿ƒè·³; å½“å®¢æˆ·ç«¯å› ä¸ºç½‘ç»œåŸå› æ–­å¼€, ç­‰ç½‘ç»œæ¢å¤æ­£å¸¸, å®¢æˆ·ç«¯åœ¨é‡è¿æœåŠ¡å™¨, æœåŠ¡ç«¯è¿”å›è¿æ¥æˆåŠŸ, ä½†æ˜¯æœåŠ¡ç«¯é©¬ä¸Šè¿›å…¥channel  inactive æ–­å¼€è¿æ¥,  ä¸šåŠ¡å¤„ç†å°±æ˜¯ç§»é™¤è¿æ¥. ç„¶åå°±é™·å…¥å®¢æˆ·ç«¯é‡è¿æˆåŠŸ,é©¬ä¸Šæ–­å¼€çš„æ­»å¾ªç¯.  æˆ‘åšäº†ä»¥ä¸‹éªŒè¯:\n1.å·²ç»æ’é™¤ç½‘ç»œåŸå› (ipåœ°å€ä¹Ÿæ²¡æœ‰å‘ç”Ÿåˆ‡æ¢,ç½‘ç»œç¨³å®š), \n2.æŠ“åŒ…å‘ç°å®¢æˆ·ç«¯å…ˆå‘é€FIN(åˆ†æäº†å‡ ä¸ª). \n3.é‡å¯æœåŠ¡å™¨è¯¥è®¾å¤‡ä¾ç„¶é‡å¤å»è¿æ¥, \n4.é‡å¯å®¢æˆ·ç«¯åè¿æ¥å°±æ­£å¸¸äº†.  \n\nå¤„ç†æ–¹å¼: ç»Ÿè®¡ä¸€å®šæ—¶é—´ç™»å½•æ¬¡æ•°, å‘é€é‡å¯å®¢æˆ·ç«¯æŒ‡ä»¤, é‡å¯åè¿æ¥æ­£å¸¸.\n\næˆ‘æ€€ç–‘æ˜¯å®¢æˆ·ç«¯ä»£ç æœ‰é—®é¢˜(ç¡¬ä»¶å·¥ç¨‹å¸ˆé‚£è¾¹å¹¶ä¸è®¤å¯), ä½†æ˜¯è¿™ä¸ªé—®é¢˜åªåœ¨çº¿ä¸Šå‡ºç°, æ˜¯ä¸ªæ¦‚ç‡é—®é¢˜, åˆæ²¡æœ‰å¥½çš„åŠæ³•å»å¤ç°. å› ä¸ºnettyå¹¶ä¸ç†Ÿæ‚‰, è¯·é—®è€å¸ˆè¿™ç§æƒ…å†µè¯¥å¦‚ä½•ç³»ç»Ÿæ’æŸ¥,å¹¶ä¸”å®šæ€§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595239551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"å¯†ç 123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":167409,"discussion_content":"æˆ‘è§‰å¾—å¯èƒ½æ˜¯å¯¹æµç¨‹èŠ‚ç‚¹çš„æ‰©å±•ï¼Œåœ¨å®ç°çš„ä¾‹å­é‡Œé¢ç»§æ‰¿äº†ç±»ChannelInboundHandlerAdapter ã€‚é‡Œé¢æœ‰å¯¹è¿™2ä¸ªæ–¹æ³•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581490500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}