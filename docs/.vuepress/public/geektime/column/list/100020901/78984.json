{"id":78984,"title":"29 | æ¡ˆä¾‹ç¯‡ï¼šRediså“åº”ä¸¥é‡å»¶è¿Ÿï¼Œå¦‚ä½•è§£å†³ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¸€èµ·åˆ†æäº†ä¸€ä¸ªåŸºäº MySQL çš„å•†å“æœç´¢æ¡ˆä¾‹ï¼Œå…ˆæ¥å›é¡¾ä¸€ä¸‹ã€‚</p><p>åœ¨è®¿é—®å•†å“æœç´¢æ¥å£æ—¶ï¼Œæˆ‘ä»¬å‘ç°æ¥å£çš„å“åº”ç‰¹åˆ«æ…¢ã€‚é€šè¿‡å¯¹ç³»ç»Ÿ CPUã€å†…å­˜å’Œç£ç›˜ I/O ç­‰èµ„æºä½¿ç”¨æƒ…å†µçš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°è¿™æ—¶å‡ºç°äº†ç£ç›˜çš„ I/O ç“¶é¢ˆï¼Œå¹¶ä¸”æ­£æ˜¯æ¡ˆä¾‹åº”ç”¨å¯¼è‡´çš„ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬å€ŸåŠ© pidstatï¼Œå‘ç°ç½ªé­ç¥¸é¦–æ˜¯ mysqld è¿›ç¨‹ã€‚æˆ‘ä»¬åˆé€šè¿‡ straceã€lsofï¼Œæ‰¾å‡ºäº† mysqld æ­£åœ¨è¯»çš„æ–‡ä»¶ã€‚æ ¹æ®æ–‡ä»¶çš„åå­—å’Œè·¯å¾„ï¼Œæˆ‘ä»¬æ‰¾å‡ºäº† mysqld æ­£åœ¨æ“ä½œçš„æ•°æ®åº“å’Œæ•°æ®è¡¨ã€‚ç»¼åˆè¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬çŒœæµ‹è¿™æ˜¯ä¸€ä¸ªæ²¡åˆ©ç”¨ç´¢å¼•å¯¼è‡´çš„æ…¢æŸ¥è¯¢é—®é¢˜ã€‚</p><p>ä¸ºäº†éªŒè¯çŒœæµ‹ï¼Œæˆ‘ä»¬åˆ° MySQL å‘½ä»¤è¡Œç»ˆç«¯ï¼Œä½¿ç”¨æ•°æ®åº“åˆ†æå·¥å…·å‘ç°ï¼Œæ¡ˆä¾‹åº”ç”¨è®¿é—®çš„å­—æ®µæœç„¶æ²¡æœ‰ç´¢å¼•ã€‚æ—¢ç„¶çŒœæµ‹æ˜¯æ­£ç¡®çš„ï¼Œé‚£å¢åŠ ç´¢å¼•åï¼Œé—®é¢˜å°±è‡ªç„¶è§£å†³äº†ã€‚</p><p>ä»è¿™ä¸ªæ¡ˆä¾‹ä½ ä¼šå‘ç°ï¼ŒMySQL çš„ MyISAM å¼•æ“ï¼Œä¸»è¦ä¾èµ–ç³»ç»Ÿç¼“å­˜åŠ é€Ÿç£ç›˜ I/O çš„è®¿é—®ã€‚å¯å¦‚æœç³»ç»Ÿä¸­è¿˜æœ‰å…¶ä»–åº”ç”¨åŒæ—¶è¿è¡Œï¼Œ MyISAM å¼•æ“å¾ˆéš¾å……åˆ†åˆ©ç”¨ç³»ç»Ÿç¼“å­˜ã€‚ç¼“å­˜å¯èƒ½ä¼šè¢«å…¶ä»–åº”ç”¨ç¨‹åºå ç”¨ï¼Œç”šè‡³è¢«æ¸…ç†æ‰ã€‚</p><p>æ‰€ä»¥ï¼Œä¸€èˆ¬æˆ‘å¹¶ä¸å»ºè®®ï¼ŒæŠŠåº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¼˜åŒ–å®Œå…¨å»ºç«‹åœ¨ç³»ç»Ÿç¼“å­˜ä¸Šã€‚æœ€å¥½èƒ½åœ¨åº”ç”¨ç¨‹åºçš„å†…éƒ¨åˆ†é…å†…å­˜ï¼Œæ„å»ºå®Œå…¨è‡ªä¸»æ§åˆ¶çš„ç¼“å­˜ï¼›æˆ–è€…ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ç¼“å­˜åº”ç”¨ï¼Œæ¯”å¦‚ Memcachedã€Redis ç­‰ã€‚</p><!-- [[[read_end]]] --><p>Redis æ˜¯æœ€å¸¸ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿä¹‹ä¸€ï¼Œå¸¸ç”¨ä½œæ•°æ®åº“ã€é«˜é€Ÿç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—ä»£ç†ç­‰ã€‚Redis åŸºäºå†…å­˜æ¥å­˜å‚¨æ•°æ®ï¼Œä¸è¿‡ï¼Œä¸ºäº†ä¿è¯åœ¨æœåŠ¡å™¨å¼‚å¸¸æ—¶æ•°æ®ä¸ä¸¢å¤±ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦ä¸ºå®ƒé…ç½®æŒä¹…åŒ–ï¼Œè€Œè¿™å°±å¯èƒ½ä¼šå¼•å‘ç£ç›˜ I/O çš„æ€§èƒ½é—®é¢˜ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¥åˆ†æä¸€ä¸ªåˆ©ç”¨ Redis ä½œä¸ºç¼“å­˜çš„æ¡ˆä¾‹ã€‚è¿™åŒæ ·æ˜¯ä¸€ä¸ªåŸºäº Python Flask çš„åº”ç”¨ç¨‹åºï¼Œå®ƒæä¾›äº†ä¸€ä¸ª æŸ¥è¯¢ç¼“å­˜çš„æ¥å£ï¼Œä½†æ¥å£çš„å“åº”æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå¹¶ä¸èƒ½æ»¡è¶³çº¿ä¸Šç³»ç»Ÿçš„è¦æ±‚ã€‚</p><p>éå¸¸æ„Ÿè°¢æºç¨‹ç³»ç»Ÿç ”å‘éƒ¨èµ„æ·±åç«¯å·¥ç¨‹å¸ˆè‘£å›½æ˜Ÿï¼Œå¸®åŠ©æä¾›äº†ä»Šå¤©çš„æ¡ˆä¾‹ã€‚</p><h2>æ¡ˆä¾‹å‡†å¤‡</h2><p>æœ¬æ¬¡æ¡ˆä¾‹è¿˜æ˜¯åŸºäº Ubuntu 18.04ï¼ŒåŒæ ·é€‚ç”¨äºå…¶ä»–çš„ Linux ç³»ç»Ÿã€‚æˆ‘ä½¿ç”¨çš„æ¡ˆä¾‹ç¯å¢ƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul>\n<li>\n<p>æœºå™¨é…ç½®ï¼š2 CPUï¼Œ8GB å†…å­˜</p>\n</li>\n<li>\n<p>é¢„å…ˆå®‰è£… dockerã€sysstat ã€gitã€make ç­‰å·¥å…·ï¼Œå¦‚ apt install <a href=\"http://docker.io\">docker.io</a> sysstat</p>\n</li>\n</ul><p>ä»Šå¤©çš„æ¡ˆä¾‹ç”± Pythonåº”ç”¨+Redis ä¸¤éƒ¨åˆ†ç»„æˆã€‚å…¶ä¸­ï¼ŒPython åº”ç”¨æ˜¯ä¸€ä¸ªåŸºäº Flask çš„åº”ç”¨ï¼Œå®ƒä¼šåˆ©ç”¨ Redis ï¼Œæ¥ç®¡ç†åº”ç”¨ç¨‹åºçš„ç¼“å­˜ï¼Œå¹¶å¯¹å¤–æä¾›ä¸‰ä¸ª HTTP æ¥å£ï¼š</p><ul>\n<li>\n<p>/ï¼šè¿”å› hello redisï¼›</p>\n</li>\n<li>\n<p>/init/<num>ï¼šæ’å…¥æŒ‡å®šæ•°é‡çš„ç¼“å­˜æ•°æ®ï¼Œå¦‚æœä¸æŒ‡å®šæ•°é‡ï¼Œé»˜è®¤çš„æ˜¯ 5000 æ¡ï¼›</num></p>\n</li>\n<li>\n<p>ç¼“å­˜çš„é”®æ ¼å¼ä¸º uuid:<uuid></uuid></p>\n</li>\n<li>\n<p>ç¼“å­˜çš„å€¼ä¸º goodã€bad æˆ– normal ä¸‰è€…ä¹‹ä¸€</p>\n</li>\n<li>\n<p>/get_cache/&lt;type_name&gt;ï¼šæŸ¥è¯¢æŒ‡å®šå€¼çš„ç¼“å­˜æ•°æ®ï¼Œå¹¶è¿”å›å¤„ç†æ—¶é—´ã€‚å…¶ä¸­ï¼Œtype_name å‚æ•°åªæ”¯æŒ good, bad å’Œ normalï¼ˆä¹Ÿå°±æ˜¯æ‰¾å‡ºå…·æœ‰ç›¸åŒ value çš„ key åˆ—è¡¨ï¼‰ã€‚</p>\n</li>\n</ul><p>ç”±äºåº”ç”¨æ¯”è¾ƒå¤šï¼Œä¸ºäº†æ–¹ä¾¿ä½ è¿è¡Œï¼Œæˆ‘æŠŠå®ƒä»¬æ‰“åŒ…æˆäº†ä¸¤ä¸ª Docker é•œåƒï¼Œå¹¶æ¨é€åˆ°äº† <a href=\"https://github.com/feiskyer/linux-perf-examples/tree/master/redis-slow\">Github</a> ä¸Šã€‚è¿™æ ·ä½ å°±åªéœ€è¦è¿è¡Œå‡ æ¡å‘½ä»¤ï¼Œå°±å¯ä»¥å¯åŠ¨äº†ã€‚</p><p>ä»Šå¤©çš„æ¡ˆä¾‹éœ€è¦ä¸¤å°è™šæ‹Ÿæœºï¼Œå…¶ä¸­ä¸€å°ç”¨ä½œæ¡ˆä¾‹åˆ†æçš„ç›®æ ‡æœºå™¨ï¼Œè¿è¡Œ Flask åº”ç”¨ï¼Œå®ƒçš„ IP åœ°å€æ˜¯ 192.168.0.10ï¼›è€Œå¦ä¸€å°ä½œä¸ºå®¢æˆ·ç«¯ï¼Œè¯·æ±‚ç¼“å­˜æŸ¥è¯¢æ¥å£ã€‚æˆ‘ç”»äº†ä¸€å¼ å›¾æ¥è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c8/87/c8e0ca06d70a1c7f1520d103a3edfc87.png?wh=770*519\" alt=\"\"></p><p>æ¥ä¸‹æ¥ï¼Œæ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ« SSH ç™»å½•åˆ°è¿™ä¸¤å°è™šæ‹Ÿæœºä¸­ï¼Œå¹¶åœ¨ç¬¬ä¸€å°è™šæ‹Ÿæœºä¸­å®‰è£…ä¸Šè¿°å·¥å…·ã€‚</p><p>è·Ÿä»¥å‰ä¸€æ ·ï¼Œæ¡ˆä¾‹ä¸­æ‰€æœ‰å‘½ä»¤éƒ½é»˜è®¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œå¦‚æœä½ æ˜¯ç”¨æ™®é€šç”¨æˆ·èº«ä»½ç™»é™†ç³»ç»Ÿï¼Œè¯·è¿è¡Œ sudo su root å‘½ä»¤åˆ‡æ¢åˆ° root ç”¨æˆ·ã€‚</p><p>åˆ°è¿™é‡Œï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­£å¼è¿›å…¥æ“ä½œç¯èŠ‚ã€‚</p><h2>æ¡ˆä¾‹åˆ†æ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œè¿è¡Œæœ¬æ¬¡æ¡ˆä¾‹è¦åˆ†æçš„ç›®æ ‡åº”ç”¨ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š</p><pre><code># æ³¨æ„ä¸‹é¢çš„éšæœºå­—ç¬¦ä¸²æ˜¯å®¹å™¨IDï¼Œæ¯æ¬¡è¿è¡Œå‡ä¼šä¸åŒï¼Œå¹¶ä¸”ä½ ä¸éœ€è¦å…³æ³¨å®ƒ\n$ docker run --name=redis -itd -p 10000:80 feisky/redis-server\nec41cb9e4dd5cb7079e1d9f72b7cee7de67278dbd3bd0956b4c0846bff211803\n$ docker run --name=app --network=container:redis -itd feisky/redis-app\n2c54eb252d0552448320d9155a2618b799a1e71d7289ec7277a61e72a9de5fd0\n</code></pre><p>ç„¶åï¼Œå†è¿è¡Œ docker ps å‘½ä»¤ï¼Œç¡®è®¤ä¸¤ä¸ªå®¹å™¨éƒ½å¤„äºè¿è¡Œï¼ˆUpï¼‰çŠ¶æ€ï¼š</p><pre><code>$ docker ps\nCONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                             NAMES\n2c54eb252d05        feisky/redis-app      &quot;python /app.py&quot;         48 seconds ago      Up 47 seconds                                         app\nec41cb9e4dd5        feisky/redis-server   &quot;docker-entrypoint.sâ€¦&quot;   49 seconds ago      Up 48 seconds       6379/tcp, 0.0.0.0:10000-&gt;80/tcp   redis\n\n</code></pre><p>ä»Šå¤©çš„åº”ç”¨åœ¨ 10000 ç«¯å£ç›‘å¬ï¼Œæ‰€ä»¥ä½ å¯ä»¥é€šè¿‡ <a href=\"http://192.168.0.10:10000\">http://192.168.0.10:10000</a>  ï¼Œæ¥è®¿é—®å‰é¢æåˆ°çš„ä¸‰ä¸ªæ¥å£ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªç»ˆç«¯ï¼Œä½¿ç”¨ curl å·¥å…·ï¼Œè®¿é—®åº”ç”¨é¦–é¡µã€‚å¦‚æœä½ çœ‹åˆ° <code>hello redis</code> çš„è¾“å‡ºï¼Œè¯´æ˜åº”ç”¨æ­£å¸¸å¯åŠ¨ï¼š</p><pre><code>$ curl http://192.168.0.10:10000/\nhello redis\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œç»§ç»­åœ¨ç»ˆç«¯äºŒä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„ curl å‘½ä»¤ï¼Œæ¥è°ƒç”¨åº”ç”¨çš„ /init æ¥å£ï¼Œåˆå§‹åŒ– Redis ç¼“å­˜ï¼Œå¹¶ä¸”æ’å…¥ 5000 æ¡ç¼“å­˜ä¿¡æ¯ã€‚è¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒæ…¢ï¼Œæ¯”å¦‚æˆ‘çš„æœºå™¨å°±èŠ±äº†åå‡ åˆ†é’Ÿæ—¶é—´ã€‚è€å¿ƒç­‰ä¸€ä¼šå„¿åï¼Œä½ ä¼šçœ‹åˆ°ä¸‹é¢è¿™è¡Œè¾“å‡ºï¼š</p><pre><code># æ¡ˆä¾‹æ’å…¥5000æ¡æ•°æ®ï¼Œåœ¨å®è·µæ—¶å¯ä»¥æ ¹æ®ç£ç›˜çš„ç±»å‹é€‚å½“è°ƒæ•´ï¼Œæ¯”å¦‚ä½¿ç”¨SSDæ—¶å¯ä»¥è°ƒå¤§ï¼Œè€ŒHDDå¯ä»¥é€‚å½“è°ƒå°\n$ curl http://192.168.0.10:10000/init/5000\n{&quot;elapsed_seconds&quot;:30.26814079284668,&quot;keys_initialized&quot;:5000}\n</code></pre><p>ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå‘½ä»¤ï¼Œè®¿é—®åº”ç”¨çš„ç¼“å­˜æŸ¥è¯¢æ¥å£ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><pre><code>$ curl http://192.168.0.10:10000/get_cache\n{&quot;count&quot;:1677,&quot;data&quot;:[&quot;d97662fa-06ac-11e9-92c7-0242ac110002&quot;,...],&quot;elapsed_seconds&quot;:10.545469760894775,&quot;type&quot;:&quot;good&quot;}\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªæ¥å£è°ƒç”¨å±…ç„¶è¦èŠ± 10 ç§’ï¼è¿™ä¹ˆé•¿çš„å“åº”æ—¶é—´ï¼Œæ˜¾ç„¶ä¸èƒ½æ»¡è¶³å®é™…çš„åº”ç”¨éœ€æ±‚ã€‚</p><p>åˆ°åº•å‡ºäº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯è¦ç”¨å‰é¢å­¦è¿‡çš„æ€§èƒ½å·¥å…·å’ŒåŸç†ï¼Œæ¥æ‰¾åˆ°è¿™ä¸ªç“¶é¢ˆã€‚</p><p>ä¸è¿‡åˆ«æ€¥ï¼ŒåŒæ ·ä¸ºäº†é¿å…åˆ†æè¿‡ç¨‹ä¸­å®¢æˆ·ç«¯çš„è¯·æ±‚ç»“æŸï¼Œåœ¨è¿›è¡Œæ€§èƒ½åˆ†æå‰ï¼Œæˆ‘ä»¬å…ˆè¦æŠŠ curl å‘½ä»¤æ”¾åˆ°ä¸€ä¸ªå¾ªç¯é‡Œæ¥æ‰§è¡Œã€‚ä½ å¯ä»¥åœ¨ç»ˆç«¯äºŒä¸­ï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><pre><code>$ while true; do curl http://192.168.0.10:10000/get_cache; done\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œå†é‡æ–°å›åˆ°ç»ˆç«¯ä¸€ï¼ŒæŸ¥æ‰¾æ¥å£å“åº”æ…¢çš„â€œç—…å› â€ã€‚</p><p>æœ€è¿‘å‡ ä¸ªæ¡ˆä¾‹çš„ç°è±¡éƒ½æ˜¯å“åº”å¾ˆæ…¢ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è‡ªç„¶å…ˆä¼šæ€€ç–‘ï¼Œæ˜¯ä¸æ˜¯ç³»ç»Ÿèµ„æºå‡ºç°äº†ç“¶é¢ˆã€‚æ‰€ä»¥ï¼Œå…ˆè§‚å¯Ÿ CPUã€å†…å­˜å’Œç£ç›˜ I/O ç­‰çš„ä½¿ç”¨æƒ…å†µè‚¯å®šä¸ä¼šé”™ã€‚</p><p>æˆ‘ä»¬å…ˆåœ¨ç»ˆç«¯ä¸€ä¸­æ‰§è¡Œ top å‘½ä»¤ï¼Œåˆ†æç³»ç»Ÿçš„ CPU ä½¿ç”¨æƒ…å†µï¼š</p><pre><code>$ top\ntop - 12:46:18 up 11 days,  8:49,  1 user,  load average: 1.36, 1.36, 1.04\nTasks: 137 total,   1 running,  79 sleeping,   0 stopped,   0 zombie\n%Cpu0  :  6.0 us,  2.7 sy,  0.0 ni,  5.7 id, 84.7 wa,  0.0 hi,  1.0 si,  0.0 st\n%Cpu1  :  1.0 us,  3.0 sy,  0.0 ni, 94.7 id,  0.0 wa,  0.0 hi,  1.3 si,  0.0 st\nKiB Mem :  8169300 total,  7342244 free,   432912 used,   394144 buff/cache\nKiB Swap:        0 total,        0 free,        0 used.  7478748 avail Mem\n\n  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n 9181 root      20   0  193004  27304   8716 S   8.6  0.3   0:07.15 python\n 9085 systemd+  20   0   28352   9760   1860 D   5.0  0.1   0:04.34 redis-server\n  368 root      20   0       0      0      0 D   1.0  0.0   0:33.88 jbd2/sda1-8\n  149 root       0 -20       0      0      0 I   0.3  0.0   0:10.63 kworker/0:1H\n 1549 root      20   0  236716  24576   9864 S   0.3  0.3  91:37.30 python3\n</code></pre><p>è§‚å¯Ÿ top çš„è¾“å‡ºå¯ä»¥å‘ç°ï¼ŒCPU0 çš„ iowait æ¯”è¾ƒé«˜ï¼Œå·²ç»è¾¾åˆ°äº† 84%ï¼›è€Œå„ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡éƒ½ä¸å¤ªé«˜ï¼Œæœ€é«˜çš„ python å’Œ redis-server ï¼Œä¹Ÿåˆ†åˆ«åªæœ‰ 8% å’Œ 5%ã€‚å†çœ‹å†…å­˜ï¼Œæ€»å†…å­˜ 8GBï¼Œå‰©ä½™å†…å­˜è¿˜æœ‰ 7GBå¤šï¼Œæ˜¾ç„¶å†…å­˜ä¹Ÿæ²¡å•¥é—®é¢˜ã€‚</p><p>ç»¼åˆtopçš„ä¿¡æ¯ï¼Œæœ€æœ‰å«Œç–‘çš„å°±æ˜¯ iowaitã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯è¦ç»§ç»­åˆ†æï¼Œæ˜¯ä¸æ˜¯ I/O é—®é¢˜ã€‚</p><p>è¿˜åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ä¸­ï¼Œå…ˆæŒ‰ä¸‹ Ctrl+Cï¼Œåœæ­¢ top å‘½ä»¤ï¼›ç„¶åï¼Œæ‰§è¡Œä¸‹é¢çš„ iostat å‘½ä»¤ï¼ŒæŸ¥çœ‹æœ‰æ²¡æœ‰ I/O æ€§èƒ½é—®é¢˜ï¼š</p><pre><code>$ iostat -d -x 1\nDevice            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util\n...\nsda              0.00  492.00      0.00   2672.00     0.00   176.00   0.00  26.35    0.00    1.76   0.00     0.00     5.43   0.00   0.00\n</code></pre><p>è§‚å¯Ÿ iostat çš„è¾“å‡ºï¼Œæˆ‘ä»¬å‘ç°ï¼Œç£ç›˜ sda æ¯ç§’çš„å†™æ•°æ®ï¼ˆwkB/sï¼‰ä¸º 2.5MBï¼ŒI/O ä½¿ç”¨ç‡ï¼ˆ%utilï¼‰æ˜¯ 0ã€‚çœ‹æ¥ï¼Œè™½ç„¶æœ‰äº› I/Oæ“ä½œï¼Œä½†å¹¶æ²¡å¯¼è‡´ç£ç›˜çš„ I/O ç“¶é¢ˆã€‚</p><p>æ’æŸ¥ä¸€åœˆå„¿ä¸‹æ¥ï¼ŒCPUå’Œå†…å­˜ä½¿ç”¨æ²¡é—®é¢˜ï¼ŒI/O ä¹Ÿæ²¡æœ‰ç“¶é¢ˆï¼Œæ¥ä¸‹æ¥å¥½åƒå°±æ²¡å•¥åˆ†ææ–¹å‘äº†ï¼Ÿ</p><p>ç¢°åˆ°è¿™ç§æƒ…å†µï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œåæ€ä¸€ä¸‹ï¼Œæ˜¯ä¸æ˜¯åˆæ¼æ‰ä»€ä¹ˆæœ‰ç”¨çº¿ç´¢äº†ã€‚ä½ å¯ä»¥å…ˆè‡ªå·±æ€è€ƒä¸€ä¸‹ï¼Œä»åˆ†æå¯¹è±¡ï¼ˆæ¡ˆä¾‹åº”ç”¨ï¼‰ã€ç³»ç»ŸåŸç†å’Œæ€§èƒ½å·¥å…·è¿™ä¸‰ä¸ªæ–¹å‘ä¸‹åŠŸå¤«ï¼Œå›å¿†å®ƒä»¬çš„ç‰¹æ€§ï¼ŒæŸ¥æ‰¾ç°è±¡çš„å¼‚å¸¸ï¼Œå†ç»§ç»­å¾€ä¸‹èµ°ã€‚</p><p>å›æƒ³ä¸€ä¸‹ï¼Œä»Šå¤©çš„æ¡ˆä¾‹é—®é¢˜æ˜¯ä» Redis ç¼“å­˜ä¸­æŸ¥è¯¢æ•°æ®æ…¢ã€‚å¯¹æŸ¥è¯¢æ¥è¯´ï¼Œå¯¹åº”çš„ I/O åº”è¯¥æ˜¯ç£ç›˜çš„è¯»æ“ä½œï¼Œä½†åˆšæ‰æˆ‘ä»¬ç”¨ iostat çœ‹åˆ°çš„å´æ˜¯å†™æ“ä½œã€‚è™½è¯´ I/O æœ¬èº«å¹¶æ²¡æœ‰æ€§èƒ½ç“¶é¢ˆï¼Œä½†è¿™é‡Œçš„ç£ç›˜å†™ä¹Ÿæ˜¯æ¯”è¾ƒå¥‡æ€ªçš„ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰ç£ç›˜å†™å‘¢ï¼Ÿé‚£æˆ‘ä»¬å°±å¾—çŸ¥é“ï¼Œåˆ°åº•æ˜¯å“ªä¸ªè¿›ç¨‹åœ¨å†™ç£ç›˜ã€‚</p><p>è¦çŸ¥é“ I/Oè¯·æ±‚æ¥è‡ªå“ªäº›è¿›ç¨‹ï¼Œè¿˜æ˜¯è¦é æˆ‘ä»¬çš„è€æœ‹å‹ pidstatã€‚åœ¨ç»ˆç«¯ä¸€ä¸­è¿è¡Œä¸‹é¢çš„ pidstat å‘½ä»¤ï¼Œè§‚å¯Ÿè¿›ç¨‹çš„ I/O æƒ…å†µï¼š</p><pre><code>$ pidstat -d 1\n12:49:35      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command\n12:49:36        0       368      0.00     16.00      0.00      86  jbd2/sda1-8\n12:49:36      100      9085      0.00    636.00      0.00       1  redis-server\n</code></pre><p>ä» pidstat çš„è¾“å‡ºï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼ŒI/O æœ€å¤šçš„è¿›ç¨‹æ˜¯ PID ä¸º 9085 çš„ redis-serverï¼Œå¹¶ä¸”å®ƒä¹Ÿåˆšå¥½æ˜¯åœ¨å†™ç£ç›˜ã€‚è¿™è¯´æ˜ï¼Œç¡®å®æ˜¯ redis-server åœ¨è¿›è¡Œç£ç›˜å†™ã€‚</p><p>å½“ç„¶ï¼Œå…‰æ‰¾åˆ°è¯»å†™ç£ç›˜çš„è¿›ç¨‹è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜è¦å†ç”¨ strace+lsof ç»„åˆï¼Œçœ‹çœ‹ redis-server åˆ°åº•åœ¨å†™ä»€ä¹ˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè¿˜æ˜¯åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œ strace å‘½ä»¤ï¼Œå¹¶ä¸”æŒ‡å®š redis-server çš„è¿›ç¨‹å· 9085ï¼š</p><pre><code># -fè¡¨ç¤ºè·Ÿè¸ªå­è¿›ç¨‹å’Œå­çº¿ç¨‹ï¼Œ-Tè¡¨ç¤ºæ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨çš„æ—¶é•¿ï¼Œ-ttè¡¨ç¤ºæ˜¾ç¤ºè·Ÿè¸ªæ—¶é—´\n$ strace -f -T -tt -p 9085\n[pid  9085] 14:20:16.826131 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 65, NULL, 8) = 1 &lt;0.000055&gt;\n[pid  9085] 14:20:16.826301 read(8, &quot;*2\\r\\n$3\\r\\nGET\\r\\n$41\\r\\nuuid:5b2e76cc-&quot;..., 16384) = 61 &lt;0.000071&gt;\n[pid  9085] 14:20:16.826477 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000063&gt;\n[pid  9085] 14:20:16.826645 write(8, &quot;$3\\r\\nbad\\r\\n&quot;, 9) = 9 &lt;0.000173&gt;\n[pid  9085] 14:20:16.826907 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 65, NULL, 8) = 1 &lt;0.000032&gt;\n[pid  9085] 14:20:16.827030 read(8, &quot;*2\\r\\n$3\\r\\nGET\\r\\n$41\\r\\nuuid:55862ada-&quot;..., 16384) = 61 &lt;0.000044&gt;\n[pid  9085] 14:20:16.827149 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000043&gt;\n[pid  9085] 14:20:16.827285 write(8, &quot;$3\\r\\nbad\\r\\n&quot;, 9) = 9 &lt;0.000141&gt;\n[pid  9085] 14:20:16.827514 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 64, NULL, 8) = 1 &lt;0.000049&gt;\n[pid  9085] 14:20:16.827641 read(8, &quot;*2\\r\\n$3\\r\\nGET\\r\\n$41\\r\\nuuid:53522908-&quot;..., 16384) = 61 &lt;0.000043&gt;\n[pid  9085] 14:20:16.827784 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000034&gt;\n[pid  9085] 14:20:16.827945 write(8, &quot;$4\\r\\ngood\\r\\n&quot;, 10) = 10 &lt;0.000288&gt;\n[pid  9085] 14:20:16.828339 epoll_pwait(5, [{EPOLLIN, {u32=8, u64=8}}], 10128, 63, NULL, 8) = 1 &lt;0.000057&gt;\n[pid  9085] 14:20:16.828486 read(8, &quot;*3\\r\\n$4\\r\\nSADD\\r\\n$4\\r\\ngood\\r\\n$36\\r\\n535&quot;..., 16384) = 67 &lt;0.000040&gt;\n[pid  9085] 14:20:16.828623 read(3, 0x7fff366a5747, 1) = -1 EAGAIN (Resource temporarily unavailable) &lt;0.000052&gt;\n[pid  9085] 14:20:16.828760 write(7, &quot;*3\\r\\n$4\\r\\nSADD\\r\\n$4\\r\\ngood\\r\\n$36\\r\\n535&quot;..., 67) = 67 &lt;0.000060&gt;\n[pid  9085] 14:20:16.828970 fdatasync(7) = 0 &lt;0.005415&gt;\n[pid  9085] 14:20:16.834493 write(8, &quot;:1\\r\\n&quot;, 4) = 4 &lt;0.000250&gt;\n</code></pre><p>è§‚å¯Ÿä¸€ä¼šå„¿ï¼Œæœ‰æ²¡æœ‰å‘ç°ä»€ä¹ˆæœ‰è¶£çš„ç°è±¡å‘¢ï¼Ÿ</p><p>äº‹å®ä¸Šï¼Œä»ç³»ç»Ÿè°ƒç”¨æ¥çœ‹ï¼Œ epoll_pwaitã€readã€writeã€fdatasync è¿™äº›ç³»ç»Ÿè°ƒç”¨éƒ½æ¯”è¾ƒé¢‘ç¹ã€‚é‚£ä¹ˆï¼Œåˆšæ‰è§‚å¯Ÿåˆ°çš„å†™ç£ç›˜ï¼Œåº”è¯¥å°±æ˜¯ write æˆ–è€… fdatasync å¯¼è‡´çš„äº†ã€‚</p><p>æ¥ç€å†æ¥è¿è¡Œ lsof å‘½ä»¤ï¼Œæ‰¾å‡ºè¿™äº›ç³»ç»Ÿè°ƒç”¨çš„æ“ä½œå¯¹è±¡ï¼š</p><pre><code>$ lsof -p 9085\nredis-ser 9085 systemd-network    3r     FIFO   0,12      0t0 15447970 pipe\nredis-ser 9085 systemd-network    4w     FIFO   0,12      0t0 15447970 pipe\nredis-ser 9085 systemd-network    5u  a_inode   0,13        0    10179 [eventpoll]\nredis-ser 9085 systemd-network    6u     sock    0,9      0t0 15447972 protocol: TCP\nredis-ser 9085 systemd-network    7w      REG    8,1  8830146  2838532 /data/appendonly.aof\nredis-ser 9085 systemd-network    8u     sock    0,9      0t0 15448709 protocol: TCP\n</code></pre><p>ç°åœ¨ä½ ä¼šå‘ç°ï¼Œæè¿°ç¬¦ç¼–å·ä¸º 3 çš„æ˜¯ä¸€ä¸ª pipe ç®¡é“ï¼Œ5 å·æ˜¯ eventpollï¼Œ7 å·æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ï¼Œè€Œ 8 å·æ˜¯ä¸€ä¸ª TCP socketã€‚</p><p>ç»“åˆç£ç›˜å†™çš„ç°è±¡ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåªæœ‰ 7 å·æ™®é€šæ–‡ä»¶æ‰ä¼šäº§ç”Ÿç£ç›˜å†™ï¼Œè€Œå®ƒæ“ä½œçš„æ–‡ä»¶è·¯å¾„æ˜¯ /data/appendonly.aofï¼Œç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨åŒ…æ‹¬ write å’Œ fdatasyncã€‚</p><p>å¦‚æœä½ å¯¹ Redis çš„æŒä¹…åŒ–é…ç½®æ¯”è¾ƒç†Ÿï¼Œçœ‹åˆ°è¿™ä¸ªæ–‡ä»¶è·¯å¾„ä»¥åŠ fdatasync çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½ åº”è¯¥èƒ½æƒ³åˆ°ï¼Œè¿™å¯¹åº”ç€æ­£æ˜¯ Redis æŒä¹…åŒ–é…ç½®ä¸­çš„ appendonly å’Œ appendfsync é€‰é¡¹ã€‚å¾ˆå¯èƒ½æ˜¯å› ä¸ºå®ƒä»¬çš„é…ç½®ä¸åˆç†ï¼Œå¯¼è‡´ç£ç›˜å†™æ¯”è¾ƒå¤šã€‚</p><p>æ¥ä¸‹æ¥å°±éªŒè¯ä¸€ä¸‹è¿™ä¸ªçŒœæµ‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Redis çš„å‘½ä»¤è¡Œå·¥å…·ï¼ŒæŸ¥è¯¢è¿™ä¸¤ä¸ªé€‰é¡¹çš„é…ç½®ã€‚</p><p>ç»§ç»­åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥è¯¢ appendonly å’Œ appendfsync çš„é…ç½®ï¼š</p><pre><code>$ docker exec -it redis redis-cli config get 'append*'\n1) &quot;appendfsync&quot;\n2) &quot;always&quot;\n3) &quot;appendonly&quot;\n4) &quot;yes&quot;\n</code></pre><p>ä»è¿™ä¸ªç»“æœä½ å¯ä»¥å‘ç°ï¼Œappendfsync é…ç½®çš„æ˜¯ alwaysï¼Œè€Œ appendonly é…ç½®çš„æ˜¯ yesã€‚è¿™ä¸¤ä¸ªé€‰é¡¹çš„è¯¦ç»†å«ä¹‰ï¼Œä½ å¯ä»¥ä» <a href=\"https://redis.io/topics/persistence\">Redis Persistence</a> çš„æ–‡æ¡£ä¸­æŸ¥åˆ°ï¼Œè¿™é‡Œæˆ‘åšä¸€ä¸‹ç®€å•ä»‹ç»ã€‚</p><p>Redis æä¾›äº†ä¸¤ç§æ•°æ®æŒä¹…åŒ–çš„æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯å¿«ç…§å’Œè¿½åŠ æ–‡ä»¶ã€‚</p><p><strong>å¿«ç…§æ–¹å¼</strong>ï¼Œä¼šæŒ‰ç…§æŒ‡å®šçš„æ—¶é—´é—´éš”ï¼Œç”Ÿæˆæ•°æ®çš„å¿«ç…§ï¼Œå¹¶ä¸”ä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚ä¸ºäº†é¿å…é˜»å¡ä¸»è¿›ç¨‹ï¼ŒRedis è¿˜ä¼š fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ¥è´Ÿè´£å¿«ç…§çš„ä¿å­˜ã€‚è¿™ç§æ–¹å¼çš„æ€§èƒ½å¥½ï¼Œæ— è®ºæ˜¯å¤‡ä»½è¿˜æ˜¯æ¢å¤ï¼Œéƒ½æ¯”è¿½åŠ æ–‡ä»¶å¥½å¾ˆå¤šã€‚</p><p>ä¸è¿‡ï¼Œå®ƒçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ã€‚åœ¨æ•°æ®é‡å¤§æ—¶ï¼Œforkå­è¿›ç¨‹éœ€è¦ç”¨åˆ°æ¯”è¾ƒå¤§çš„å†…å­˜ï¼Œä¿å­˜æ•°æ®ä¹Ÿå¾ˆè€—æ—¶ã€‚æ‰€ä»¥ï¼Œä½ éœ€è¦è®¾ç½®ä¸€ä¸ªæ¯”è¾ƒé•¿çš„æ—¶é—´é—´éš”æ¥åº”å¯¹ï¼Œæ¯”å¦‚è‡³å°‘5åˆ†é’Ÿã€‚è¿™æ ·ï¼Œå¦‚æœå‘ç”Ÿæ•…éšœï¼Œä½ ä¸¢å¤±çš„å°±æ˜¯å‡ åˆ†é’Ÿçš„æ•°æ®ã€‚</p><p><strong>è¿½åŠ æ–‡ä»¶</strong>ï¼Œåˆ™æ˜¯ç”¨åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ è®°å½•çš„æ–¹å¼ï¼Œå¯¹ Redis å†™å…¥çš„æ•°æ®ï¼Œä¾æ¬¡è¿›è¡ŒæŒä¹…åŒ–ï¼Œæ‰€ä»¥å®ƒçš„æŒä¹…åŒ–ä¹Ÿæ›´å®‰å…¨ã€‚</p><p>æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ä¸ªç”¨ appendfsync é€‰é¡¹è®¾ç½® fsync çš„ç­–ç•¥ï¼Œç¡®ä¿å†™å…¥çš„æ•°æ®éƒ½è½åˆ°ç£ç›˜ä¸­ï¼Œå…·ä½“é€‰é¡¹åŒ…æ‹¬ alwaysã€everysecã€no ç­‰ã€‚</p><ul>\n<li>\n<p>alwaysè¡¨ç¤ºï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ fsyncï¼Œæ˜¯æœ€ä¸ºå®‰å…¨çš„æ–¹å¼ï¼›</p>\n</li>\n<li>\n<p>everysecè¡¨ç¤ºï¼Œæ¯ç§’é’Ÿè°ƒç”¨ä¸€æ¬¡ fsync ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å³ä½¿æ˜¯æœ€åæƒ…å†µä¸‹ï¼Œä¹Ÿåªä¸¢å¤±1ç§’çš„æ•°æ®ï¼›</p>\n</li>\n<li>\n<p>è€Œ no è¡¨ç¤ºäº¤ç»™æ“ä½œç³»ç»Ÿæ¥å¤„ç†ã€‚</p>\n</li>\n</ul><p>å›å¿†ä¸€ä¸‹æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„é…ç½®ï¼Œappendfsync é…ç½®çš„æ˜¯ alwaysï¼Œæ„å‘³ç€æ¯æ¬¡å†™æ•°æ®æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ fsyncï¼Œä»è€Œé€ æˆæ¯”è¾ƒå¤§çš„ç£ç›˜ I/O å‹åŠ›ã€‚</p><p>å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥ç”¨ strace ï¼Œè§‚å¯Ÿè¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæƒ…å†µã€‚æ¯”å¦‚é€šè¿‡ -e é€‰é¡¹æŒ‡å®š fdatasync åï¼Œä½ å°±ä¼šå¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p><pre><code>$ strace -f -p 9085 -T -tt -e fdatasync\nstrace: Process 9085 attached with 4 threads\n[pid  9085] 14:22:52.013547 fdatasync(7) = 0 &lt;0.007112&gt;\n[pid  9085] 14:22:52.022467 fdatasync(7) = 0 &lt;0.008572&gt;\n[pid  9085] 14:22:52.032223 fdatasync(7) = 0 &lt;0.006769&gt;\n...\n[pid  9085] 14:22:52.139629 fdatasync(7) = 0 &lt;0.008183&gt;\n</code></pre><p>ä»è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°ï¼Œæ¯éš” 10ms å·¦å³ï¼Œå°±ä¼šæœ‰ä¸€æ¬¡ fdatasync è°ƒç”¨ï¼Œå¹¶ä¸”æ¯æ¬¡è°ƒç”¨æœ¬èº«ä¹Ÿè¦æ¶ˆè€— 7~8msã€‚</p><p>ä¸ç®¡å“ªç§æ–¹å¼ï¼Œéƒ½å¯ä»¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œé…ç½®ç¡®å®ä¸åˆç†ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ‰¾å‡ºäº† Redis æ­£åœ¨è¿›è¡Œå†™å…¥çš„æ–‡ä»¶ï¼Œä¹ŸçŸ¥é“äº†äº§ç”Ÿå¤§é‡ I/O çš„åŸå› ã€‚</p><p>ä¸è¿‡ï¼Œå›åˆ°æœ€åˆçš„ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæŸ¥è¯¢æ—¶ä¼šæœ‰ç£ç›˜å†™å‘¢ï¼ŸæŒ‰ç†æ¥è¯´ä¸åº”è¯¥åªæœ‰æ•°æ®çš„è¯»å–å—ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬å†æ¥å®¡æŸ¥ä¸€ä¸‹ strace -f -T -tt -p 9085 çš„ç»“æœã€‚</p><pre><code>read(8, &quot;*2\\r\\n$3\\r\\nGET\\r\\n$41\\r\\nuuid:53522908-&quot;..., 16384)\nwrite(8, &quot;$4\\r\\ngood\\r\\n&quot;, 10)\nread(8, &quot;*3\\r\\n$4\\r\\nSADD\\r\\n$4\\r\\ngood\\r\\n$36\\r\\n535&quot;..., 16384)\nwrite(7, &quot;*3\\r\\n$4\\r\\nSADD\\r\\n$4\\r\\ngood\\r\\n$36\\r\\n535&quot;..., 67)\nwrite(8, &quot;:1\\r\\n&quot;, 4)\n</code></pre><p>ç»†å¿ƒçš„ä½ åº”è¯¥è®°å¾—ï¼Œæ ¹æ® lsof çš„åˆ†æï¼Œæ–‡ä»¶æè¿°ç¬¦ç¼–å·ä¸º 7 çš„æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ /data/appendonly.aofï¼Œè€Œç¼–å·ä¸º 8 çš„æ˜¯ TCP socketã€‚è€Œè§‚å¯Ÿä¸Šé¢çš„å†…å®¹ï¼Œ8 å·å¯¹åº”çš„ TCP è¯»å†™ï¼Œæ˜¯ä¸€ä¸ªæ ‡å‡†çš„â€œè¯·æ±‚-å“åº”â€æ ¼å¼ï¼Œå³ï¼š</p><ul>\n<li>\n<p>ä» socket è¯»å– GET uuid:53522908-â€¦ åï¼Œå“åº” goodï¼›</p>\n</li>\n<li>\n<p>å†ä» socket è¯»å– SADD good 535â€¦ åï¼Œå“åº” 1ã€‚</p>\n</li>\n</ul><p>å¯¹ Redis æ¥è¯´ï¼ŒSADDæ˜¯ä¸€ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥ Redis è¿˜ä¼šæŠŠå®ƒä¿å­˜åˆ°ç”¨äºæŒä¹…åŒ–çš„ appendonly.aof æ–‡ä»¶ä¸­ã€‚</p><p>è§‚å¯Ÿæ›´å¤šçš„ strace ç»“æœï¼Œä½ ä¼šå‘ç°ï¼Œæ¯å½“ GET è¿”å› good æ—¶ï¼Œéšåéƒ½ä¼šæœ‰ä¸€ä¸ª SADD æ“ä½œï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†ï¼Œæ˜æ˜æ˜¯æŸ¥è¯¢æ¥å£ï¼ŒRedis å´æœ‰å¤§é‡çš„ç£ç›˜å†™ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±æ‰¾å‡ºäº† Redis å†™ç£ç›˜çš„åŸå› ã€‚ä¸è¿‡ï¼Œåœ¨ä¸‹æœ€ç»ˆç»“è®ºå‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦ç¡®è®¤ä¸€ä¸‹ï¼Œ8 å· TCP socket å¯¹åº”çš„ Redis å®¢æˆ·ç«¯ï¼Œåˆ°åº•æ˜¯ä¸æ˜¯æˆ‘ä»¬çš„æ¡ˆä¾‹åº”ç”¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç»™ lsof å‘½ä»¤åŠ ä¸Š -i é€‰é¡¹ï¼Œæ‰¾å‡º TCP socket å¯¹åº”çš„ TCP è¿æ¥ä¿¡æ¯ã€‚ä¸è¿‡ï¼Œç”±äº Redis å’Œ Python åº”ç”¨éƒ½åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦è¿›å…¥å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´å†…éƒ¨ï¼Œæ‰èƒ½çœ‹åˆ°å®Œæ•´çš„ TCP è¿æ¥ã€‚</p><blockquote>\n<p>æ³¨æ„ï¼šä¸‹é¢çš„å‘½ä»¤ç”¨åˆ°çš„ <a href=\"http://man7.org/linux/man-pages/man1/nsenter.1.html\">nsenter</a>  å·¥å…·ï¼Œå¯ä»¥è¿›å…¥å®¹å™¨å‘½åç©ºé—´ã€‚å¦‚æœä½ çš„ç³»ç»Ÿæ²¡æœ‰å®‰è£…ï¼Œè¯·è¿è¡Œä¸‹é¢å‘½ä»¤å®‰è£… nsenterï¼š<br>\ndocker run --rm -v /usr/local/bin:/target jpetazzo/nsenter</p>\n</blockquote><p>è¿˜æ˜¯åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><pre><code># ç”±äºè¿™ä¸¤ä¸ªå®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¿›å…¥appçš„ç½‘ç»œå‘½åç©ºé—´å³å¯\n$ PID=$(docker inspect --format {{.State.Pid}} app)\n# -iè¡¨ç¤ºæ˜¾ç¤ºç½‘ç»œå¥—æ¥å­—ä¿¡æ¯\n$ nsenter --target $PID --net -- lsof -i\nCOMMAND    PID            USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME\nredis-ser 9085 systemd-network    6u  IPv4 15447972      0t0  TCP localhost:6379 (LISTEN)\nredis-ser 9085 systemd-network    8u  IPv4 15448709      0t0  TCP localhost:6379-&gt;localhost:32996 (ESTABLISHED)\npython    9181            root    3u  IPv4 15448677      0t0  TCP *:http (LISTEN)\npython    9181            root    5u  IPv4 15449632      0t0  TCP localhost:32996-&gt;localhost:6379 (ESTABLISHED)\n\n</code></pre><p>è¿™æ¬¡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œredis-server çš„ 8 å·æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¹åº” TCP è¿æ¥ localhost:6379-&gt;localhost:32996ã€‚å…¶ä¸­ï¼Œ localhost:6379 æ˜¯ redis-server è‡ªå·±çš„ç›‘å¬ç«¯å£ï¼Œè‡ªç„¶ localhost:32996 å°±æ˜¯ redis çš„å®¢æˆ·ç«¯ã€‚å†è§‚å¯Ÿæœ€åä¸€è¡Œï¼Œlocalhost:32996 å¯¹åº”çš„ï¼Œæ­£æ˜¯æˆ‘ä»¬çš„ Python åº”ç”¨ç¨‹åºï¼ˆè¿›ç¨‹å·ä¸º 9181ï¼‰ã€‚</p><p>å†ç»å„ç§æ³¢æŠ˜ï¼Œæˆ‘ä»¬æ€»ç®—æ‰¾å‡ºäº† Redis å“åº”å»¶è¿Ÿçš„æ½œåœ¨åŸå› ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ‰¾åˆ°ä¸¤ä¸ªé—®é¢˜ã€‚</p><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒRedis é…ç½®çš„ appendfsync æ˜¯ alwaysï¼Œè¿™å°±å¯¼è‡´ Redis æ¯æ¬¡çš„å†™æ“ä½œï¼Œéƒ½ä¼šè§¦å‘ fdatasync ç³»ç»Ÿè°ƒç”¨ã€‚ä»Šå¤©çš„æ¡ˆä¾‹ï¼Œæ²¡å¿…è¦ç”¨è¿™ä¹ˆé«˜é¢‘çš„åŒæ­¥å†™ï¼Œä½¿ç”¨é»˜è®¤çš„ 1s æ—¶é—´é—´éš”ï¼Œå°±è¶³å¤Ÿäº†ã€‚</p><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼ŒPython åº”ç”¨åœ¨æŸ¥è¯¢æ¥å£ä¸­ä¼šè°ƒç”¨ Redis çš„ SADD å‘½ä»¤ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯ä¸åˆç†ä½¿ç”¨ç¼“å­˜å¯¼è‡´çš„ã€‚</p><p>å¯¹äºç¬¬ä¸€ä¸ªé…ç½®é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŠŠ appendfsync æ”¹æˆ everysecï¼š</p><pre><code>$ docker exec -it redis redis-cli config set appendfsync everysec\nOK\n</code></pre><p>æ”¹å®Œåï¼Œåˆ‡æ¢åˆ°ç»ˆç«¯äºŒä¸­æŸ¥çœ‹ï¼Œä½ ä¼šå‘ç°ï¼Œç°åœ¨çš„è¯·æ±‚æ—¶é—´ï¼Œå·²ç»ç¼©çŸ­åˆ°äº† 0.9sï¼š</p><pre><code>{..., &quot;elapsed_seconds&quot;:0.9368953704833984,&quot;type&quot;:&quot;good&quot;}\n</code></pre><p>è€Œç¬¬äºŒä¸ªé—®é¢˜ï¼Œå°±è¦æŸ¥çœ‹åº”ç”¨çš„æºç äº†ã€‚ç‚¹å‡» <a href=\"https://github.com/feiskyer/linux-perf-examples/blob/master/redis-slow/app.py\">Github</a>  ï¼Œä½ å°±å¯ä»¥æŸ¥çœ‹æ¡ˆä¾‹åº”ç”¨çš„æºä»£ç ï¼š</p><pre><code>def get_cache(type_name):\n    '''handler for /get_cache'''\n    for key in redis_client.scan_iter(&quot;uuid:*&quot;):\n        value = redis_client.get(key)\n        if value == type_name:\n            redis_client.sadd(type_name, key[5:])\n    data = list(redis_client.smembers(type_name))\n    redis_client.delete(type_name)\n    return jsonify({&quot;type&quot;: type_name, 'count': len(data), 'data': data})\n</code></pre><p>æœç„¶ï¼ŒPython åº”ç”¨æŠŠ Redis å½“æˆä¸´æ—¶ç©ºé—´ï¼Œç”¨æ¥å­˜å‚¨æŸ¥è¯¢è¿‡ç¨‹ä¸­æ‰¾åˆ°çš„æ•°æ®ã€‚ä¸è¿‡æˆ‘ä»¬çŸ¥é“ï¼Œè¿™äº›æ•°æ®æ”¾å†…å­˜ä¸­å°±å¯ä»¥äº†ï¼Œå®Œå…¨æ²¡å¿…è¦å†é€šè¿‡ç½‘ç»œè°ƒç”¨å­˜å‚¨åˆ° Redis ä¸­ã€‚</p><p>åŸºäºè¿™ä¸ªæ€è·¯ï¼Œæˆ‘æŠŠä¿®æ”¹åçš„ä»£ç ä¹Ÿæ¨é€åˆ°äº†ç›¸åŒçš„æºç æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ <a href=\"http://192.168.0.10:10000/get_cache_data\">http://192.168.0.10:10000/get_cache_data</a> è¿™ä¸ªæ¥å£æ¥è®¿é—®å®ƒã€‚</p><p>æˆ‘ä»¬åˆ‡æ¢åˆ°ç»ˆç«¯äºŒï¼ŒæŒ‰ Ctrl+C åœæ­¢ä¹‹å‰çš„ curl å‘½ä»¤ï¼›ç„¶åæ‰§è¡Œä¸‹é¢çš„ curl å‘½ä»¤ï¼Œè°ƒç”¨ <a href=\"http://192.168.0.10:10000/get_cache_data\">http://192.168.0.10:10000/get_cache_data</a>  æ–°æ¥å£ï¼š</p><pre><code>$ while true; do curl http://192.168.0.10:10000/get_cache_data; done\n{...,&quot;elapsed_seconds&quot;:0.16034674644470215,&quot;type&quot;:&quot;good&quot;}\n</code></pre><p>ä½ å¯ä»¥å‘ç°ï¼Œè§£å†³ç¬¬äºŒä¸ªé—®é¢˜åï¼Œæ–°æ¥å£çš„æ€§èƒ½åˆæœ‰äº†è¿›ä¸€æ­¥çš„æå‡ï¼Œä»åˆšæ‰çš„ 0.9s ï¼Œå†æ¬¡ç¼©çŸ­æˆäº†ä¸åˆ° 0.2sã€‚</p><p>å½“ç„¶ï¼Œæ¡ˆä¾‹æœ€åï¼Œä¸è¦å¿˜è®°æ¸…ç†æ¡ˆä¾‹åº”ç”¨ã€‚ä½ å¯ä»¥åˆ‡æ¢åˆ°ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œæ¸…ç†ï¼š</p><pre><code>$ docker rm -f app redis\n</code></pre><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘å¸¦ä½ ä¸€èµ·åˆ†æäº†ä¸€ä¸ª Redis ç¼“å­˜çš„æ¡ˆä¾‹ã€‚</p><p>æˆ‘ä»¬å…ˆç”¨ topã€iostat ï¼Œåˆ†æäº†ç³»ç»Ÿçš„ CPU ã€å†…å­˜å’Œç£ç›˜ä½¿ç”¨æƒ…å†µï¼Œä¸è¿‡å´å‘ç°ï¼Œç³»ç»Ÿèµ„æºå¹¶æ²¡æœ‰å‡ºç°ç“¶é¢ˆã€‚è¿™ä¸ªæ—¶å€™æƒ³è¦è¿›ä¸€æ­¥åˆ†æçš„è¯ï¼Œè¯¥ä»å“ªä¸ªæ–¹å‘ç€æ‰‹å‘¢ï¼Ÿ</p><p>é€šè¿‡ä»Šå¤©çš„æ¡ˆä¾‹ä½ ä¼šå‘ç°ï¼Œä¸ºäº†è¿›ä¸€æ­¥åˆ†æï¼Œå°±éœ€è¦ä½ å¯¹ç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å·¥ä½œåŸç†æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>æ¯”å¦‚ï¼Œä»Šå¤©çš„æ¡ˆä¾‹ä¸­ï¼Œè™½ç„¶ç£ç›˜ I/O å¹¶æ²¡æœ‰å‡ºç°ç“¶é¢ˆï¼Œä½†ä» Redis çš„åŸç†æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜æ—¶ä¸åº”è¯¥å‡ºç°å¤§é‡çš„ç£ç›˜ I/O å†™æ“ä½œã€‚</p><p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬ç»§ç»­å€ŸåŠ© pidstatã€straceã€lsofã€nsenter ç­‰ä¸€ç³»åˆ—çš„å·¥å…·ï¼Œæ‰¾å‡ºäº†ä¸¤ä¸ªæ½œåœ¨é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ Redis çš„ä¸åˆç†é…ç½®ï¼Œå¦ä¸€ä¸ªæ˜¯ Python åº”ç”¨å¯¹ Redis çš„æ»¥ç”¨ã€‚æ‰¾åˆ°ç“¶é¢ˆåï¼Œç›¸åº”çš„ä¼˜åŒ–å·¥ä½œè‡ªç„¶å°±æ¯”è¾ƒè½»æ¾äº†ã€‚</p><h2>æ€è€ƒ</h2><p>æœ€åç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ã€‚ä»ä¸Šä¸€èŠ‚ MySQL åˆ°ä»Šå¤© Redis çš„æ¡ˆä¾‹åˆ†æï¼Œä½ æœ‰æ²¡æœ‰å‘ç° I/O æ€§èƒ½é—®é¢˜çš„åˆ†æè§„å¾‹å‘¢ï¼Ÿå¦‚æœä½ æœ‰ä»»ä½•æƒ³æ³•æˆ–å¿ƒå¾—ï¼Œéƒ½å¯ä»¥è®°å½•ä¸‹æ¥ã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸¤ä¸ªæ¡ˆä¾‹è¿™å¹¶ä¸èƒ½æ¶µç›–æ‰€æœ‰çš„ I/O æ€§èƒ½é—®é¢˜ã€‚ä½ åœ¨å®é™…å·¥ä½œä¸­ï¼Œè¿˜ç¢°åˆ°è¿‡å“ªäº› I/O æ€§èƒ½é—®é¢˜å—ï¼Ÿä½ åˆæ˜¯æ€ä¹ˆåˆ†æçš„å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"28 | æ¡ˆä¾‹ç¯‡ï¼šä¸€ä¸ªSQLæŸ¥è¯¢è¦15ç§’ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ","id":78633},"right":{"article_title":"30 | å¥—è·¯ç¯‡ï¼šå¦‚ä½•è¿…é€Ÿåˆ†æå‡ºç³»ç»ŸI/Oçš„ç“¶é¢ˆåœ¨å“ªé‡Œï¼Ÿ","id":79001}},"comments":[{"had_liked":false,"id":63443,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1548375671,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"250656478839","product_id":100020901,"comment_content":"æ‰“å¡day30<br>ioé—®é¢˜ä¸€èˆ¬éƒ½æ˜¯å…ˆtopå‘å±•iowaitæ¯”è¾ƒé«˜ï¼Œç„¶åiostatçœ‹æ˜¯å“ªä¸ªè¿›ç¨‹æ¯”è¾ƒé«˜ï¼Œç„¶åå†é€šè¿‡straceï¼Œlsofæ‰¾å‡ºè¿›ç¨‹åœ¨è¯»å†™çš„å…·ä½“æ–‡ä»¶ï¼Œç„¶åå¯¹åº”çš„åˆ†æ","like_count":59},{"had_liked":false,"id":63552,"user_name":"æåš","can_delete":false,"product_type":"c1","uid":1119919,"ip_address":"","ucode":"04C2DE916B84AB","user_header":"https://static001.geekbang.org/account/avatar/00/11/16/af/bada0f59.jpg","comment_is_top":false,"comment_ctime":1548397972,"is_pvip":false,"replies":[{"id":"22588","content":"iowaitä¸ä»£è¡¨ç£ç›˜I&#47;Oå­˜åœ¨ç“¶é¢ˆï¼Œåªæ˜¯ä»£è¡¨CPUä¸ŠI&#47;Oæ“ä½œçš„æ—¶é—´å ç”¨çš„ç™¾åˆ†æ¯”ã€‚å‡å¦‚è¿™æ—¶å€™æ²¡æœ‰å…¶ä»–è¿›ç¨‹åœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¾ˆå°çš„I&#47;Oå°±ä¼šå¯¼è‡´iowaitå‡é«˜","user_name":"ä½œè€…å›å¤","comment_id":63552,"uid":"1001282","ip_address":"","utype":1,"ctime":1548576945,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":3,"race_medal":0,"score":"186231991700","product_id":100020901,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜å’¨è¯¢ä¸‹ï¼Œä¸ºä»€ä¹ˆtopæ˜¾ç¤º iowaitæ¯”è¾ƒé«˜ï¼Œä½†æ˜¯ä½¿ç”¨iostatå´å‘ç°ioçš„ä½¿ç”¨ç‡å¹¶ä¸é«˜é‚£ï¼Ÿ","like_count":43,"discussions":[{"author":{"id":1099881,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c8/69/ce605c29.jpg","nickname":"è½¶","note":"","ucode":"FA0483DF79E37D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":17510,"discussion_content":"%iowait è¡¨ç¤ºåœ¨ä¸€ä¸ªé‡‡æ ·å‘¨æœŸå†…æœ‰ç™¾åˆ†ä¹‹å‡ çš„æ—¶é—´å±äºä»¥ä¸‹æƒ…å†µï¼šCPUç©ºé—²ã€å¹¶ä¸”æœ‰ä»æœªå®Œæˆçš„I/Oè¯·æ±‚ã€‚\n\nå¯¹ %iowait å¸¸è§çš„è¯¯è§£æœ‰ä¸¤ä¸ªï¼š\nã€€ã€€ä¸€æ˜¯è¯¯ä»¥ä¸º %iowait è¡¨ç¤ºCPUä¸èƒ½å·¥ä½œçš„æ—¶é—´ï¼Œ\nã€€ã€€äºŒæ˜¯è¯¯ä»¥ä¸º %iowait è¡¨ç¤ºI/Oæœ‰ç“¶é¢ˆã€‚\n\né¦–å…ˆ %iowait å‡é«˜å¹¶ä¸èƒ½è¯æ˜ç­‰å¾…I/Oçš„è¿›ç¨‹æ•°é‡å¢å¤šäº†ï¼Œä¹Ÿä¸èƒ½è¯æ˜ç­‰å¾…I/Oçš„æ€»æ—¶é—´å¢åŠ äº†ã€‚\nã€€ã€€ä¾‹å¦‚ï¼Œåœ¨CPUç¹å¿™æœŸé—´å‘ç”Ÿçš„I/Oï¼Œæ— è®ºIOæ˜¯å¤šè¿˜æ˜¯å°‘ï¼Œ%iowaitéƒ½ä¸ä¼šå˜ï¼›å½“CPUç¹å¿™ç¨‹åº¦ä¸‹é™æ—¶ï¼Œæœ‰ä¸€éƒ¨åˆ†IOè½å…¥CPUç©ºé—²æ—¶é—´æ®µå†…ï¼Œå¯¼è‡´%iowaitå‡é«˜ã€‚\nã€€ã€€å†æ¯”å¦‚ï¼ŒIOçš„å¹¶å‘åº¦ä½ï¼Œ%iowaitå°±é«˜ï¼›IOçš„å¹¶å‘åº¦é«˜ï¼Œ%iowaitå¯èƒ½å°±æ¯”è¾ƒä½ã€‚\n\nå¯è§%iowaitæ˜¯ä¸€ä¸ªéå¸¸æ¨¡ç³Šçš„æŒ‡æ ‡ï¼Œå¦‚æœçœ‹åˆ° %iowait å‡é«˜ï¼Œè¿˜éœ€æ£€æŸ¥I/Oé‡æœ‰æ²¡æœ‰æ˜æ˜¾å¢åŠ ï¼Œavserv/avwait/avqueç­‰æŒ‡æ ‡æœ‰æ²¡æœ‰æ˜æ˜¾å¢å¤§ï¼Œåº”ç”¨æœ‰æ²¡æœ‰æ„Ÿè§‰å˜æ…¢ï¼Œå¦‚æœéƒ½æ²¡æœ‰ï¼Œå°±æ²¡ä»€ä¹ˆå¥½æ‹…å¿ƒçš„ã€‚","likes_number":22,"is_delete":false,"is_hidden":false,"ctime":1568968668,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437632,"discussion_content":"iowaitä¸ä»£è¡¨ç£ç›˜I/Oå­˜åœ¨ç“¶é¢ˆï¼Œåªæ˜¯ä»£è¡¨CPUä¸ŠI/Oæ“ä½œçš„æ—¶é—´å ç”¨çš„ç™¾åˆ†æ¯”ã€‚å‡å¦‚è¿™æ—¶å€™æ²¡æœ‰å…¶ä»–è¿›ç¨‹åœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¾ˆå°çš„I/Oå°±ä¼šå¯¼è‡´iowaitå‡é«˜","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1548576945,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2129632,"avatar":"https://static001.geekbang.org/account/avatar/00/20/7e/e0/ff046b55.jpg","nickname":"æå…µ","note":"","ucode":"291243E3AB889F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391067,"discussion_content":"iowaitæˆ‘ç†è§£å’Œcpuloadæœ‰ç‚¹åŒæ ·çš„æ„Ÿè§‰ï¼Œéƒ½æ˜¯è´Ÿè½½ç¹å¿™çš„ä½“ç°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630258520,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65498,"user_name":"Geek_33409b","can_delete":false,"product_type":"c1","uid":1112756,"ip_address":"","ucode":"9C64C42F799403","user_header":"https://static001.geekbang.org/account/avatar/00/10/fa/b4/6892eabe.jpg","comment_is_top":false,"comment_ctime":1549419623,"is_pvip":false,"replies":[{"id":"23251","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":65498,"uid":"1001282","ip_address":"","utype":1,"ctime":1549636305,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":4,"race_medal":0,"score":"108923602023","product_id":100020901,"comment_content":"æ‰“å¡day30 <br>IOæ€§èƒ½é—®é¢˜é¦–å…ˆå¯ä»¥é€šè¿‡top æŸ¥çœ‹æœºå™¨çš„æ•´ä½“è´Ÿè½½æƒ…å†µï¼Œä¸€èˆ¬ä¼šå‡ºç°CPU çš„iowait è¾ƒé«˜çš„ç°è±¡<br>ç„¶åä½¿ç”¨ pidstat -d 1 æ‰¾åˆ°è¯»å†™ç£ç›˜è¾ƒé«˜çš„è¿›ç¨‹<br>ç„¶åé€šè¿‡ strace -f -TT è¿›è¡Œè·Ÿè¸ªï¼ŒæŸ¥çœ‹ç³»ç»Ÿè¯»å†™è°ƒç”¨çš„é¢‘ç‡å’Œæ—¶é—´<br>é€šè¿‡lsof æ‰¾åˆ° strace ä¸­çš„æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ–‡ä»¶ opensnoopå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„é—®é¢˜ä½ç½®<br>æ¨æµ‹ å¯¹åº”çš„é—®é¢˜ï¼Œmysql æ¡ˆä¾‹ä¸­çš„å¤§é‡è¯»ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰å»ºç«‹ç´¢å¼•å¯¼è‡´çš„å…¨è¡¨æŸ¥è¯¢ï¼Œä»è€Œå½¢æˆäº†æ…¢æŸ¥è¯¢çš„ç°è±¡ã€‚redis ä¸­åˆ™æ˜¯å› ä¸º å¤‡ä»½æ–‡ä»¶è®¾ç½®çš„ä¸åˆç†å¯¼è‡´çš„æ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šå†™ç£ç›˜ã€‚å½“ç„¶ä¸åŒçš„é—®é¢˜è¿˜éœ€è¦ç»“åˆå¯¹åº”çš„æƒ…å†µè¿›è¡Œåˆ†æ<br>","like_count":25,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438476,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549636305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1063958,"avatar":"","nickname":"å’•å™œ","note":"","ucode":"38A512132BB5B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320252,"discussion_content":"è¿™ä½åŒå­¦ï¼Œæˆ‘æœ‰ä¸ªæœ‹å‹æƒ³è®¤è¯†ä¸‹ä½  ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604302021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2099588,"avatar":"https://static001.geekbang.org/account/avatar/00/20/09/84/0effdd87.jpg","nickname":"é±¼æˆ‘æ‰€æ¬²","note":"","ucode":"2A5D3CCCFC21D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1063958,"avatar":"","nickname":"å’•å™œ","note":"","ucode":"38A512132BB5B7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330255,"discussion_content":"è¿™ä¸ªæœ‹å‹æ€•æ˜¯ä½ è‡ªå·±é¢[666]","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606550486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":320252,"ip_address":""},"score":330255,"extra":""},{"author":{"id":1063958,"avatar":"","nickname":"å’•å™œ","note":"","ucode":"38A512132BB5B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2099588,"avatar":"https://static001.geekbang.org/account/avatar/00/20/09/84/0effdd87.jpg","nickname":"é±¼æˆ‘æ‰€æ¬²","note":"","ucode":"2A5D3CCCFC21D1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330295,"discussion_content":"è·Ÿè¿™ä½å…„å¼ŸåŒåçš„ä¸€ä¸ªæœ‹å‹âŠ™_âŠ™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606559067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":330255,"ip_address":""},"score":330295,"extra":""}]}]},{"had_liked":false,"id":63481,"user_name":"Christmas","can_delete":false,"product_type":"c1","uid":1219172,"ip_address":"","ucode":"F48F6BE4A7595B","user_header":"https://static001.geekbang.org/account/avatar/00/12/9a/64/ad837224.jpg","comment_is_top":false,"comment_ctime":1548381466,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"78857792794","product_id":100020901,"comment_content":"è¿›ç¨‹iowaité«˜ï¼Œç£ç›˜iowaitä¸é«˜ï¼Œè¯´æ˜æ˜¯å•ä¸ªè¿›ç¨‹ä½¿ç”¨äº†ä¸€äº›blockingçš„ç£ç›˜æ‰“å¼€æ–¹å¼ï¼Œæ¯”å¦‚æ¯æ¬¡éƒ½fsync","like_count":18},{"had_liked":false,"id":77115,"user_name":"yungoo","can_delete":false,"product_type":"c1","uid":1060805,"ip_address":"","ucode":"D9BB84A75047CB","user_header":"https://static001.geekbang.org/account/avatar/00/10/2f/c5/aaacb98f.jpg","comment_is_top":false,"comment_ctime":1552837911,"is_pvip":false,"replies":[{"id":"28155","content":"è°¢è°¢åˆ†äº«","user_name":"ä½œè€…å›å¤","comment_id":77115,"uid":"1001282","ip_address":"","utype":1,"ctime":1552902994,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"44502510871","product_id":100020901,"comment_content":"nsenteræŠ¥äº†loadlocale.c assertionè®¾ç½®<br><br>export LC_ALL=C<br><br>å³å¯","like_count":11,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443585,"discussion_content":"è°¢è°¢åˆ†äº«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552902994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66126,"user_name":"____çš„æˆ‘","can_delete":false,"product_type":"c1","uid":1061683,"ip_address":"","ucode":"8A4F5468136E48","user_header":"https://static001.geekbang.org/account/avatar/00/10/33/33/30fb3ac3.jpg","comment_is_top":false,"comment_ctime":1549882458,"is_pvip":false,"replies":[{"id":"23700","content":"è°¢è°¢åˆ†äº«æ€§èƒ½æ’æŸ¥çš„ç»éªŒğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":66126,"uid":"1001282","ip_address":"","utype":1,"ctime":1550067932,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"44499555418","product_id":100020901,"comment_content":"å‰æ®µæ—¶é—´åˆšæ‰¾åˆ°ä¸€ä¸ªç”±äºå†…å­˜æ•°æ®è¢«äº¤æ¢åˆ°swapæ–‡ä»¶ä¸­å¯¼è‡´å†…å­˜æ•°æ®éå†æ•ˆç‡å˜ä½çš„é—®é¢˜ é—®é¢˜å®šä½è¿‡ç¨‹æ˜¯ä½¿ç”¨pidstatå‘½ä»¤å‘ç°è¿›ç¨‹cpuä½¿ç”¨ç‡å˜ä½ mpstatå‘½ä»¤è§‚å¯Ÿåˆ°ç³»ç»Ÿiowaitå‡é«˜ ç”±æ­¤æ€€ç–‘è·Ÿioæœ‰ä»€ä¹ˆå…³ç³» perfå‘½ä»¤è§‚å¯Ÿå‘ç°å†…å­˜æ•°æ®éå†è¿‡ç¨‹ä¸­swapç›¸å…³è°ƒç”¨æ—¶é—´å æ¯”æœ‰ç‚¹å¼‚å¸¸ ç„¶åä½¿ç”¨pidstatå‘½ä»¤+rå‚æ•° ä¹Ÿè§‚å¯Ÿåˆ°è¿›ç¨‹åœ¨é‚£æ®µæ—¶é—´ä¸»ç¼ºé¡µä¸­æ–­å‡é«˜ ç”±æ­¤ç¡®å®šé—®é¢˜<br><br>è€å¸ˆçš„è¯¾ç¨‹éå¸¸æœ‰ç”¨ å¤šå¤šå‘æ‚¨å­¦ä¹  å¸Œæœ›è€å¸ˆèƒ½å¤šåˆ†äº«ä¸€äº›å®šä½ç½‘ç»œå»¶è¿Ÿé—®é¢˜çš„æ–¹æ³• ä¸ä»…ä»…å±€é™åœ¨pingæ¢æµ‹","like_count":11,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438715,"discussion_content":"è°¢è°¢åˆ†äº«æ€§èƒ½æ’æŸ¥çš„ç»éªŒğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550067932,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71364,"user_name":"æ­¦æ–‡æ–‡æ­¦","can_delete":false,"product_type":"c1","uid":1108924,"ip_address":"","ucode":"5288366646A15B","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/bc/6ccac4bb.jpg","comment_is_top":false,"comment_ctime":1551328094,"is_pvip":false,"replies":[{"id":"26299","content":"å—¯ï¼Œå®é™…ä½¿ç”¨ä¸­ï¼Œä½¿ç”¨ç±»ä¼¼nmonè¿™ç§ç›‘æ§ç³»ç»Ÿæ˜¯æ›´æ¨èçš„åšæ³•ã€‚ä¸è¿‡ï¼Œåœ¨ç›‘æ§ç³»ç»Ÿçš„é—´éš”æ—¶é—´ä¸å¤Ÿå°ï¼Œæˆ–è€…æŒ‡æ ‡ä¸å¤Ÿå…¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦åˆ°ç³»ç»Ÿä¸Šå»æŠ“å–æ›´å¤šçš„ç»†èŠ‚","user_name":"ä½œè€…å›å¤","comment_id":71364,"uid":"1001282","ip_address":"","utype":1,"ctime":1551702649,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":2,"race_medal":0,"score":"31616099166","product_id":100020901,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œä¸€ç›´åœ¨å¬æ‚¨çš„è§†é¢‘ï¼Œå‘ç°æ‚¨ç”¨äº†å¾ˆå¤šçš„å°å·¥å…·æ¥æ£€æŸ¥ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ï¼Œè€Œæˆ‘ä»¬å…¬å¸ä½¿ç”¨nmonå·¥å…·ï¼Œå°±èƒ½ä¸€æ¬¡æ€§å°†å‡ ä¹æ‰€æœ‰å¸¸ç”¨çš„æŒ‡æ ‡å…¨éƒ¨è·å–åˆ°äº†ï¼Œè€Œä¸”è¿˜èƒ½æ‹¿åˆ°å†å²æ•°æ®ï¼Œè¯·é—®æˆ‘ä»¬ç”¨nmonæ˜¯å¦å°±èƒ½åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹å–åˆ°äº†æ‚¨è¯´çš„top pidstatç­‰å·¥å…·å‘¢ï¼Œå¦‚æœä¸å¯ä»¥é‚£æ‚¨èƒ½è¯´è¯´åŸå› å—ï¼Ÿéå¸¸æ„Ÿè°¢","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441126,"discussion_content":"å—¯ï¼Œå®é™…ä½¿ç”¨ä¸­ï¼Œä½¿ç”¨ç±»ä¼¼nmonè¿™ç§ç›‘æ§ç³»ç»Ÿæ˜¯æ›´æ¨èçš„åšæ³•ã€‚ä¸è¿‡ï¼Œåœ¨ç›‘æ§ç³»ç»Ÿçš„é—´éš”æ—¶é—´ä¸å¤Ÿå°ï¼Œæˆ–è€…æŒ‡æ ‡ä¸å¤Ÿå…¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦åˆ°ç³»ç»Ÿä¸Šå»æŠ“å–æ›´å¤šçš„ç»†èŠ‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551702649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2066801,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/W0VEO7Hxzd61mia6Ls2EpBmaZ0l9q7SFUAErbu4XKIjWLmlALr4ybpicDoI8SoXY8XJNKmk04Ep1ibTCuFvfCF8GQ/132","nickname":"Chen","note":"","ucode":"5D0F3DF807706E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340436,"discussion_content":"nmonä¸èƒ½å®æ—¶ç›‘æ§ï¼Œæ„Ÿè§‰è¿™ç‚¹åšå¾—ä¸æ˜¯å¾ˆå¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610006422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63649,"user_name":"åˆ©ä¿Šæ°","can_delete":false,"product_type":"c1","uid":1142080,"ip_address":"","ucode":"FCB93D7EF8365D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/j0gBKF8EKfQ4TjoSTeRPoWia56RMCevYDauMGS9iaw4TnpC0dp2Viaict75T8TebKzAcUruWiazkyiaCQPqKZxar2M6Q/132","comment_is_top":false,"comment_ctime":1548433120,"is_pvip":false,"replies":[{"id":"22590","content":"è°¢è°¢åˆ†äº«","user_name":"ä½œè€…å›å¤","comment_id":63649,"uid":"1001282","ip_address":"","utype":1,"ctime":1548577014,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"23023269600","product_id":100020901,"comment_content":"nsenter --target $PID -- lsof -i<br>æ‰§è¡Œå¤±è´¥ï¼Œæç¤ºï¼šloadlocale.c:130: _nl_intern_locale_data: Assertion `cnt &lt; (sizeof (_nl_value_type_LC_COLLATE) &#47; sizeof (_nl_value_type_LC_COLLATE[0]))&#39; failed<br>å¯ä»¥å‚è€ƒä¸‹https:&#47;&#47;stackoverflow.com&#47;questions&#47;37121895&#47;yocto-build-loadlocale-c-130<br>é…ç½®<br>LANG=&#47;usr&#47;lib&#47;locale&#47;en_US<br>","like_count":5,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437670,"discussion_content":"è°¢è°¢åˆ†äº«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548577014,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63495,"user_name":"å¼€å§‹æ‡‚äº†","can_delete":false,"product_type":"c1","uid":1252479,"ip_address":"","ucode":"90B533935C4EF1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJKkThulMFj6MNsgk6Tps4Ll1pzrricPDqAyuFkmFYMDcPgUbGuUnMYACIICRTRPWLPtib2z6V6XdBg/132","comment_is_top":false,"comment_ctime":1548384188,"is_pvip":false,"replies":[{"id":"22585","content":"&#47;init&#47; åé¢éœ€è¦ä¸€ä¸ªæ•°å­—","user_name":"ä½œè€…å›å¤","comment_id":63495,"uid":"1001282","ip_address":"","utype":1,"ctime":1548576648,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"18728253372","product_id":100020901,"comment_content":" curl http:&#47;&#47;10.39.25.7:10000&#47;init&#47;get_cache<br>&lt;!DOCTYPE HTML PUBLIC &quot;-&#47;&#47;W3C&#47;&#47;DTD HTML 3.2 Final&#47;&#47;EN&quot;&gt;<br>&lt;title&gt;500 Internal Server Error&lt;&#47;title&gt;<br>&lt;h1&gt;Internal Server Error&lt;&#47;h1&gt;<br>&lt;p&gt;The server encountered an internal error and was unable to complete your request.  Either the server is overloaded or there is an error in the application.&lt;&#47;p&gt;","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437609,"discussion_content":"/init/ åé¢éœ€è¦ä¸€ä¸ªæ•°å­—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548576648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241457,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1597300463,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10187235055","product_id":100020901,"comment_content":"åˆ†æè§„å¾‹å°±æ˜¯ï¼š<br>* æ ¹æ®topå‘ç°cpu0çš„iowaitåé«˜<br>* iostat -d -x 1è§‚å¯Ÿç³»ç»Ÿç£ç›˜IOæƒ…å†µæœ‰æ— å¼‚å¸¸<br>* pidstat -d 1è§‚å¯Ÿè¿›ç¨‹çš„IOå…¶æ¦‚å†µ<br>* ç”¨ strace+lsof ç»„åˆï¼šstrace -f -T -tt -p pid  å’Œ  lsof -p pidè§‚å¯Ÿç³»ç»Ÿè°ƒç”¨æƒ…å†µå®šä½ç£ç›˜IOå‘ç”Ÿçš„ç°åœº","like_count":3},{"had_liked":false,"id":232920,"user_name":"ä»è¿œæ–¹è¿‡æ¥","can_delete":false,"product_type":"c1","uid":1797551,"ip_address":"","ucode":"4791DBC7E05B1D","user_header":"","comment_is_top":false,"comment_ctime":1594169776,"is_pvip":false,"replies":[{"id":"86945","content":"æ˜¯çš„ï¼Œstraceä¼šå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä½¿ç”¨å®ƒæ¥åšç›‘æ§ã€‚ä½†æ˜¯åœ¨å·²ç»å‡ºç°ä¸¥é‡æ€§èƒ½é—®é¢˜çš„æ—¶å€™ï¼Œä½¿ç”¨å®ƒæ¥æ’æŸ¥é—®é¢˜è¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":232920,"uid":"1001282","ip_address":"","utype":1,"ctime":1594995035,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"10184104368","product_id":100020901,"comment_content":"è€å¸ˆï¼Œä½ è¿™å‡ ç¯‡æ–‡ç« å¤§é‡ä½¿ç”¨äº†straceï¼Œå®ƒçš„è´Ÿè½½ä¸æ˜¯å¾ˆé«˜ä¹ˆï¼Ÿåœ¨ç”Ÿäº§ä¸Šå¯ä»¥ä½¿ç”¨ä¹ˆï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500813,"discussion_content":"æ˜¯çš„ï¼Œstraceä¼šå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä½¿ç”¨å®ƒæ¥åšç›‘æ§ã€‚ä½†æ˜¯åœ¨å·²ç»å‡ºç°ä¸¥é‡æ€§èƒ½é—®é¢˜çš„æ—¶å€™ï¼Œä½¿ç”¨å®ƒæ¥æ’æŸ¥é—®é¢˜è¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594995035,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63627,"user_name":"å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1548420672,"is_pvip":false,"replies":[{"id":"22589","content":"cloneè¦æŒ‡å®šä»£ç ä»“åº“çš„è·¯å¾„ï¼Œè€Œä¸æ˜¯å­ç›®å½•:<br><br>git clone https:&#47;&#47;github.com&#47;feiskyer&#47;linux-perf-examples","user_name":"ä½œè€…å›å¤","comment_id":63627,"uid":"1001282","ip_address":"","utype":1,"ctime":1548576999,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"10138355264","product_id":100020901,"comment_content":"git clone https:&#47;&#47;github.com&#47;feiskyer&#47;linux-perf-examples&#47;tree&#47;master&#47;redis-slow<br>Initialized empty Git repository in &#47;root&#47;redis-slow&#47;.git&#47;<br>error: The requested URL returned error: 403 Forbidden while accessing https:&#47;&#47;github.com&#47;feiskyer&#47;linux-perf-examples&#47;tree&#47;master&#47;redis-slow&#47;info&#47;refs<br><br>ä»£ç æ€ä¹ˆå…‹éš†ä¸ä¸‹æ¥","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437659,"discussion_content":"cloneè¦æŒ‡å®šä»£ç ä»“åº“çš„è·¯å¾„ï¼Œè€Œä¸æ˜¯å­ç›®å½•:\n\ngit clone https://github.com/feiskyer/linux-perf-examples","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548576999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63435,"user_name":"Cranliu","can_delete":false,"product_type":"c1","uid":1304302,"ip_address":"","ucode":"DC2DE84B142FDA","user_header":"https://static001.geekbang.org/account/avatar/00/13/e6/ee/e3c4c9b3.jpg","comment_is_top":false,"comment_ctime":1548373181,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10138307773","product_id":100020901,"comment_content":"topã€iostatã€pidstatã€straceï¼Œä»¥åŠå¯¹åº”ç”¨ç¨‹åºçš„äº†è§£ï¼ŒMySQLã€Redisæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€æ¬¾åº”ç”¨ç¨‹åºã€‚","like_count":2},{"had_liked":false,"id":308085,"user_name":"æ™´å¤©é›¨ä¼","can_delete":false,"product_type":"c1","uid":1236002,"ip_address":"","ucode":"F14D8133A1C077","user_header":"https://static001.geekbang.org/account/avatar/00/12/dc/22/bb8e93b4.jpg","comment_is_top":false,"comment_ctime":1629384604,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5924351900","product_id":100020901,"comment_content":"nsenterè¿™ä¸ªå‘½ä»¤å¤ªæ£’äº†ã€‚","like_count":1},{"had_liked":false,"id":303246,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/5a9277f1.jpg","comment_is_top":false,"comment_ctime":1626685404,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5921652700","product_id":100020901,"comment_content":"top-------&gt;iowait<br>iostat -d -x 1-----&gt;w<br>pidstat  -d 1<br>strace -f -t -TT &lt;pid&gt;<br>lsof -p &lt;pid&gt;<br>nsenter --target $PID --net -- lsof -i<br>config set appendfsync everysec<br>python: <br>redis_client.sadd(type_name, key[5:])   æŠŠ Redis å½“æˆä¸´æ—¶ç©ºé—´ï¼Œç”¨æ¥å­˜å‚¨æŸ¥è¯¢è¿‡ç¨‹ä¸­æ‰¾åˆ°çš„æ•°","like_count":1},{"had_liked":false,"id":294187,"user_name":"noisyes","can_delete":false,"product_type":"c1","uid":2538540,"ip_address":"","ucode":"94EC310B284AD2","user_header":"https://static001.geekbang.org/account/avatar/00/26/bc/2c/963688bb.jpg","comment_is_top":false,"comment_ctime":1621823336,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5916790632","product_id":100020901,"comment_content":"ä¸ºä»€ä¹ˆç£ç›˜æ€§èƒ½æ²¡æœ‰è¾¾åˆ°æ€§èƒ½ç“¶é¢ˆï¼Œæ¥å£è¿”å›å¾—è¿™ä¹ˆæ…¢å‘¢","like_count":1,"discussions":[{"author":{"id":1013424,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/76/b0/14fec62f.jpg","nickname":"ä¸äº†å³°","note":"","ucode":"E23B96D6A3D4EC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551673,"discussion_content":"å•çº¿ç¨‹è¯»ä¹Ÿæœ‰ä»–æœ€å¤§çš„ååé‡å˜›","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1645080384,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63736,"user_name":"æˆ‘æ¥ä¹Ÿ","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1548480690,"is_pvip":false,"replies":[{"id":"22592","content":"å¦‚æœèƒ½ä¸€ä¸ªå¥—è·¯æŸ¥éæ‰€æœ‰é—®é¢˜å°±å¥½äº†ğŸ˜“æˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½æœŸå¾…è¿™æ ·","user_name":"ä½œè€…å›å¤","comment_id":63736,"uid":"1001282","ip_address":"","utype":1,"ctime":1548577121,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"5843447986","product_id":100020901,"comment_content":"[D29æ‰“å¡]<br>æ„Ÿè§‰æ¯æ¬¡åˆ†æçš„å¥—è·¯éƒ½å·®ä¸å¤š.<br>1.ç”¨topæŸ¥çœ‹æŒ‡æ ‡,å‘ç° [ç³»ç»Ÿ] æœ‰i&#47;oç“¶é¢ˆ æˆ–è€… cpuç“¶é¢ˆ.<br>2.ä½¿ç”¨iostatè¾…åŠ©çœ‹ä¸‹ç£ç›˜i&#47;oè¯»å†™é€Ÿåº¦å’Œå¤§å°ç­‰æŒ‡æ ‡.<br>3.ç”¨pidstatåˆ¤æ–­æ˜¯å“ªä¸ª [è¿›ç¨‹] å¯¼è‡´çš„. æ—¢å¯ä»¥çœ‹è¿›ç¨‹å„çº¿ç¨‹çš„cpuä¸­æ–­æ•°,ä¹Ÿå¯ä»¥çœ‹ç£ç›˜ioæ•°.<br>4.ç”¨straceè¿½è¸ªè¿›ç¨‹åŠå„çº¿ç¨‹çš„ [ç³»ç»Ÿè°ƒç”¨].(ä»¥å‰ç»å¸¸åˆ°è¿™é‡Œå°±çŸ¥é“äº†æ˜¯æ“ä½œçš„ä»€ä¹ˆæ–‡ä»¶)<br>5.ç»§ç»­ç”¨lsofæŸ¥çœ‹è¯¥è¿›ç¨‹æ‰“å¼€çš„ [æ–‡ä»¶] .linuxä¸‹ä¸€åˆ‡çš†æ–‡ä»¶,åˆ™å¯ä»¥æŸ¥çœ‹çš„ä¸œè¥¿å°±å¾ˆå¤šå¾ˆå¤šäº†.è¿è¿›ç¨‹ä¿æŒçš„socketç­‰ä¿¡æ¯ä¹Ÿä¸€ç›®äº†ç„¶.<br>6.æœ¬ä¾‹å› ä¸ºç”¨åˆ°äº†å®¹å™¨,æ‰€ä»¥ç”¨åˆ°äº†nsenterè¿›å…¥å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´,æŸ¥çœ‹å¯¹åº”çš„socketä¿¡æ¯.<br>7.æ ¹æ®ç¬¬4.5æ­¥è·å–çš„ä¿¡æ¯,æ‰¾æºç æˆ–çœ‹ç³»ç»Ÿé…ç½®.ç¡®å®šé—®é¢˜,åšå‡ºè°ƒæ•´.ç„¶åæ”¶å·¥.","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437699,"discussion_content":"å¦‚æœèƒ½ä¸€ä¸ªå¥—è·¯æŸ¥éæ‰€æœ‰é—®é¢˜å°±å¥½äº†ğŸ˜“æˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½æœŸå¾…è¿™æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548577121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351664,"user_name":"trprebel","can_delete":false,"product_type":"c1","uid":3004171,"ip_address":"","ucode":"914093A63195D8","user_header":"https://static001.geekbang.org/account/avatar/00/2d/d7/0b/e92b2c13.jpg","comment_is_top":false,"comment_ctime":1658067458,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1658067458","product_id":100020901,"comment_content":"è€å¸ˆï¼Œè¿‡äº†è¿™ä¹ˆé•¿æ—¶é—´æ¥æé—®ä¸çŸ¥é“æ‚¨æ˜¯å¦è¿˜èƒ½çœ‹åˆ°ï¼Œè¿™ä¸ªæ¡ˆä¾‹çš„é—®é¢˜æˆ‘åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­è§‰å¾—åˆ†æè¿‡ç¨‹æœ‰äº›è¹Šè··ï¼Œå½“ç³»ç»Ÿå‡ºç°å¼‚å¸¸æ—¶<br>1ã€æˆ‘ä»¬ä½¿ç”¨topå‘½ä»¤å‘ç°cpuæœ‰ä¸€ä¸ªæ ¸ä½¿ç”¨ç‡éå¸¸é«˜ï¼Œç„¶åæœ‰84.7%æ˜¯iowaitï¼Œè¿™æ˜¯æˆ‘ä»¬å¾—åˆ°çš„ç¬¬ä¸€ä¸ªçº¿ç´¢<br>2ã€ç„¶åä½¿ç”¨iostatï¼Œpidstatï¼Œlsofç­‰å·¥å…·æŸ¥çœ‹ï¼Œè¿™äº›å·¥å…·æŸ¥çœ‹å®Œï¼Œå¦‚æ‚¨æ‰€è¯´ï¼Œåªèƒ½è¯´æ˜æœ‰ioæ“ä½œï¼Œå¹¶ä¸èƒ½è¯´æ˜æ˜¯æœ‰ioç“¶é¢ˆï¼Œå¹¶ä¸”è¿™äº›æŒ‡æ ‡ä¹Ÿæ²¡æœ‰è·Ÿç¬¬ä¸€ä¸ªçº¿ç´¢å…³è”èµ·æ¥ï¼Œæˆ–è€…ç›¸äº’ä½è¯<br>3ã€æœ€åæˆ‘ä»¬é€šè¿‡çŒœæµ‹è¯»è¯·æ±‚é‡Œé¢ä¸åº”è¯¥æœ‰å¤§é‡å†™æ“ä½œæ¥ç¡®å®šå†™æ“ä½œçš„å¼‚å¸¸ï¼Œè™½ç„¶è¯´å®šä½å¹¶è§£å†³äº†é—®é¢˜ï¼Œä½†æ„Ÿè§‰è§£å†³æ–¹æ¡ˆä¸é—®é¢˜å’Œçº¿ç´¢å¹¶æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¸å¯èƒ½åªæœ‰è¯»æ“ä½œï¼Œä¹Ÿæœ‰ä¸ä¼šæœ‰â€œè¯»æ“ä½œé‡Œé¢ä¸åº”è¯¥æœ‰å¤§é‡å†™æ“ä½œâ€çš„æ¨æ–­ï¼Œé‚£å¦‚æœç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬åº”è¯¥å¦‚ä½•åˆ†æå‘¢<br>æ„Ÿè§‰æ˜¯ä¸æ˜¯åº”è¯¥ç»§ç»­ä»è¿™ä¸¤ä¸ªæ–¹å‘ç»§ç»­åˆ†æ<br>1ã€é—®é¢˜ï¼šRTæ—¶é—´è¿‡é•¿ï¼Œè¿›ç¨‹&#47;çº¿ç¨‹åœ¨å¹²ä»€ä¹ˆï¼Œå¯¼è‡´ä¸€ç›´æ— æ³•å“åº”<br>2ã€çº¿ç´¢ï¼šæ˜¯å“ªä¸ªè¿›ç¨‹&#47;çº¿ç¨‹å¯¼è‡´iowaitå¦‚æ­¤é«˜ï¼Œä»¥åŠè¿™ä¸ªè¿›ç¨‹&#47;çº¿ç¨‹åœ¨åšä»€ä¹ˆ<br>æœ€åæ‰å®šä½åˆ°redisçš„aofæ“ä½œ","like_count":0},{"had_liked":false,"id":351060,"user_name":"maple-0406","can_delete":false,"product_type":"c1","uid":1197608,"ip_address":"","ucode":"7191D06449B6B6","user_header":"https://static001.geekbang.org/account/avatar/00/12/46/28/14ef7207.jpg","comment_is_top":false,"comment_ctime":1657506175,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657506175","product_id":100020901,"comment_content":"1.å¯»æ‰¾å¯ç–‘ç‚¹ï¼Œéœ€è¦ä½¿ç”¨ç±»ä¼¼TOPçš„å‘½ä»¤ï¼Œå¯»æ‰¾ç›¸å¯¹å¯ç–‘ç‚¹ã€‚ä»¥ioé—®é¢˜ä¸ºä¾‹ï¼Œé€šå¸¸è¡¨ç°ä¸ºiowaité«˜ï¼Œcpuä½¿ç”¨ç‡æ­£å¸¸ï¼Œå†…å­˜ç›¸å¯¹æ¯”è¾ƒå¯Œè£•ã€‚<br>2.ç¡®å®šå¯ç–‘ç‚¹åï¼Œä½¿ç”¨iostat æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹ä½¿ç”¨è¾ƒé«˜ï¼Œä½†æ˜¯iostatå¯èƒ½æ— æ³•å…¨éƒ¨çœ‹å®Œæ•´ï¼ˆä¾‹å¦‚çº¿ç¨‹è¯»å†™ç›´æ¥é”€æ¯ï¼‰<br>3.æ¥ä¸‹æ¥ä½¿ç”¨strace ï¼ˆæ³¨æ„ä½¿ç”¨-få‚æ•°ï¼ŒåŒæ—¶å±•ç¤ºçº¿ç¨‹è¯»å†™æƒ…å†µï¼‰ï¼Œlsof  æŸ¥åˆ°å…·ä½“è¯»å†™çš„æ–‡ä»¶ã€‚<br>å¦‚éœ€è¦è¿›ä¸€æ­¥æŸ¥çœ‹ç»†èŠ‚ï¼Œopensnoop ï¼ˆopenç³»ç»Ÿè°ƒç”¨ï¼‰nsenterï¼ˆå®¹å™¨ç½‘ç»œnsï¼‰","like_count":0},{"had_liked":false,"id":309711,"user_name":"å°å°èœé¸Ÿ","can_delete":false,"product_type":"c1","uid":1229617,"ip_address":"","ucode":"1CECC0A664CFD1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK009KMmXKFVSEdjicpDD4ick3NZpM3JdIUibWGB03lG6yicibad0tGmQD7E3DpZ0sVRenxWNfd7iaPdp7g/132","comment_is_top":false,"comment_ctime":1630309324,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630309324","product_id":100020901,"comment_content":"æ•´ä½“æ€è·¯<br>ä¸¤ç§ï¼š1ã€ä»ç°è±¡çœ‹æœ¬è´¨ï¼š<br>å…ˆæ•´ä½“çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨ï¼Œåˆæ­¥ç¡®å®šé—®é¢˜ï¼›<br>å†æ¬¡è¿›ä¸€æ­¥ï¼Œç¡®å®šè¿›ç¨‹ï¼›<br>å†ç¡®å®šçº¿ç¨‹æˆ–æ˜¯å‡½æ•°ï¼Œæ‰¾å‡ºé—®é¢˜ï¼›<br>2ã€ä»æœ¬è´¨æ¨å‡ºç°è±¡ï¼Œè¿™ä¸€èˆ¬é€šè¿‡æœ‰ç»éªŒçš„ä»£ç èµ°è¯»æˆ–æ˜¯è¯„å®¡ï¼Œé¡ºæ¨ï¼›<br>æˆ‘çš„ç†è§£ä¸ä¸€å®šå‡†ç¡®ï¼Œåªæ˜¯ä¸ªäººæ„è§ã€‚","like_count":0},{"had_liked":false,"id":256537,"user_name":"ä¼Ÿå•Šä¼Ÿ","can_delete":false,"product_type":"c1","uid":1876981,"ip_address":"","ucode":"32F9F89668CF4E","user_header":"https://static001.geekbang.org/account/avatar/00/1c/a3/f5/458d277b.jpg","comment_is_top":false,"comment_ctime":1603672744,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603672744","product_id":100020901,"comment_content":"æœ‰ä¸ªé—®é¢˜ï¼Œç”Ÿäº§ç¯å¢ƒä¸­å¾€å¾€ä¸å¯èƒ½åªæœ‰ä¸€ç±»æ“ä½œã€‚åƒæ–‡ä¸­å‘å±•cpu ioéƒ½æ²¡é—®é¢˜çš„æ—¶å€™ï¼Œå¦‚æœä¸æ˜¯æå‰çŸ¥é“åº”ç”¨åº”è¯¥åªæœ‰è¯»æ“ä½œï¼ˆç”Ÿäº§ä¸å¯èƒ½ï¼‰ï¼Œå¦‚ä½•èƒ½å¿«é€Ÿå®šä½åˆ°å¯ç–‘ç‚¹å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2066801,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/W0VEO7Hxzd61mia6Ls2EpBmaZ0l9q7SFUAErbu4XKIjWLmlALr4ybpicDoI8SoXY8XJNKmk04Ep1ibTCuFvfCF8GQ/132","nickname":"Chen","note":"","ucode":"5D0F3DF807706E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340437,"discussion_content":"åŒç–‘æƒ‘ï¼Œå¯èƒ½å…·ä½“é—®é¢˜è¿˜æ˜¯è¦å…·ä½“å»åˆ†æ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610006485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":202325,"user_name":"æ–‘é©¬Z","can_delete":false,"product_type":"c1","uid":1500262,"ip_address":"","ucode":"ABB55B4652452F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0K9AM6xxDzVV6pF66jyus5NuuxZzT9icad8AQDMKibwUOy3UnoZIZdyKIKd9sA06rgFnIWwiakSeOQ/132","comment_is_top":false,"comment_ctime":1585968638,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1585968638","product_id":100020901,"comment_content":"ç¬”è®°å«å‘½ä»¤ï¼Œå­—æ•°å¤ªå¤šï¼Œå‘ä¸ä¸Šæ¥äº†ï¼Œæœ‰ä¸€å®šç–‘é—®è¯·è€å¸ˆç­”ç–‘ã€‚<br>æˆ‘çš„redis-serverè¿›ç¨‹å·23497<br>lsof -p 23497  ä¹‹åæœ‰å¤§é‡çš„<br>lsof: no pwd entry for UID 100<br>ä½†æ˜¯æˆ‘çš„~ # cat &#47;etc&#47;passwd|grep 100<br>games:x:12:100:games:&#47;usr&#47;games:&#47;sbin&#47;nologin<br>å­˜åœ¨uidä¸º100çš„ç”¨æˆ·ï¼Œæˆ‘ä¹‹ååˆ lsof -u games  ,è¿™é‡Œæœ‰æŠ¥é”™lsof: no pwd entry for UID  1337ï¼Œè¿™ä¸ªuidä¸º1337çš„æˆ‘ç¡®å®æ²¡æœ‰ã€‚<br>è¯´çš„æœ‰ç‚¹ç»•ï¼Œæ€»ä¹‹è¯·é—®è€å¸ˆæŠ¥é”™lsof: no pwd entry for UID *** ä¸ºä»€ä¹ˆä¼šå‡ºç°ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2066801,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/W0VEO7Hxzd61mia6Ls2EpBmaZ0l9q7SFUAErbu4XKIjWLmlALr4ybpicDoI8SoXY8XJNKmk04Ep1ibTCuFvfCF8GQ/132","nickname":"Chen","note":"","ucode":"5D0F3DF807706E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":340439,"discussion_content":"games:x:12:100:games:/usr/games:/sbin/nologin\ngamesçš„uidæ˜¯12,100æ˜¯ä»–çš„gidå‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610006660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2021302,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/d7/b6/534c036e.jpg","nickname":"å¯ä»¥å‘Šè¯‰æˆ‘ä½ åå­—å˜›","note":"","ucode":"AAAA58E95F54D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283418,"discussion_content":"ä½ è¿™ä¸ªuidä¸º12,gidä¸º100, `id ç”¨æˆ·å`è·å–ç”¨æˆ·å’Œç»„id,\nno pwd entry æ˜¯å› ä¸ºåœ¨dockeré‡Œå§,å¹¶ä¸å½±å“ä»€ä¹ˆçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592270799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171532,"user_name":"Lucianoæé‘«","can_delete":false,"product_type":"c1","uid":1329995,"ip_address":"","ucode":"5FBE5F86FD5B2C","user_header":"https://static001.geekbang.org/account/avatar/00/14/4b/4b/97926cba.jpg","comment_is_top":false,"comment_ctime":1578963263,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578963263","product_id":100020901,"comment_content":"å¯æ˜¯æˆ‘è§‰çš„ä¸€ä¸ªåŸºäºredisè¯·æ±‚200æ¯«ç§’ä¹Ÿæ…¢äº†ç‚¹","like_count":0},{"had_liked":false,"id":170465,"user_name":"cornor","can_delete":false,"product_type":"c1","uid":1021877,"ip_address":"","ucode":"AB5B7E161576C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/97/b5/663cde8b.jpg","comment_is_top":false,"comment_ctime":1578617864,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578617864","product_id":100020901,"comment_content":"æ„Ÿè°¢ å­¦åˆ°äº†ä¸€å¥—æŸ¥è¯¢é—®é¢˜çš„æ–¹å¼","like_count":0},{"had_liked":false,"id":131597,"user_name":"é¥­ç²’","can_delete":false,"product_type":"c1","uid":1153455,"ip_address":"","ucode":"4C3220B0D43997","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg","comment_is_top":false,"comment_ctime":1567821852,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567821852","product_id":100020901,"comment_content":"éå¸¸å¥½çš„æ¡ˆä¾‹ï¼Œè¿˜é¡ºå¤ä¹ äº† redis çŸ¥è¯†ã€‚æˆ‘çš„ç¯å¢ƒæŠŠåˆå§‹ç¼“å­˜æ•°æ®åŠ åˆ° 10000 åï¼Œiowait ä¹Ÿä¸æ˜¯å¾ˆé«˜...","like_count":0},{"had_liked":false,"id":76206,"user_name":"å¦‚æœ","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1552549208,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552549208","product_id":100020901,"comment_content":"DAY29ï¼Œæ‰“å¡","like_count":0},{"had_liked":false,"id":73825,"user_name":"äº‘å­¦","can_delete":false,"product_type":"c1","uid":1027233,"ip_address":"","ucode":"366AE90BA06356","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ac/a1/43d83698.jpg","comment_is_top":false,"comment_ctime":1552010702,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552010702","product_id":100020901,"comment_content":"éå¸¸ç»å…¸çš„redisæŸ¥è¯¢å“åº”æ…¢é—®é¢˜å®šä½","like_count":0},{"had_liked":false,"id":69090,"user_name":"Chn.K","can_delete":false,"product_type":"c1","uid":1285191,"ip_address":"","ucode":"F82E8CE20C16FA","user_header":"https://static001.geekbang.org/account/avatar/00/13/9c/47/50cf2cab.jpg","comment_is_top":false,"comment_ctime":1550658905,"is_pvip":false,"replies":[{"id":"24535","content":"è¿™ä¸ªIO 99%è·Ÿä½ æƒ³çš„ç£ç›˜IOä½¿ç”¨99%æ˜¯ä¸ä¸€æ ·çš„ï¼Œå…·ä½“å«ä¹‰ä½ å¯ä»¥å»æŸ¥ä¸€ä¸‹iotopçš„æ–‡æ¡£","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1550675424,"ip_address":"","comment_id":69090,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1550658905","product_id":100020901,"comment_content":"è¯·æ•™ä¸ªé—®é¢˜ï¼šæˆ‘ç”¨iotopè§‚æµ‹IOä½¿ç”¨æƒ…å†µï¼Œå‘ç°æŸè¿›ç¨‹çš„DISK READ å’ŒDISK WRITEéƒ½æ˜¯0ï¼Œä½†æ˜¯IOå·²ç»åˆ°99.99%äº†ï¼Œé€šè¿‡top&#47;iostatå¯¹cpu&#47;ç£ç›˜çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œè§‚æµ‹ï¼Œå‡æœªå‘ç°ä»€ä¹ˆå¼‚å¸¸ï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ<br>Total DISK READ :      18.14 M&#47;s | Total DISK WRITE :      31.59 M&#47;s<br>Actual DISK READ:      18.02 M&#47;s | Actual DISK WRITE:      15.60 M&#47;s<br>  PID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN      IO    COMMAND<br>  148 be&#47;4 root        0.00 B&#47;s    0.00 B&#47;s  0.00 % 99.99 % [ksoftirqd&#47;17]<br>23655 be&#47;4 root        0.00 B&#47;s  988.19 K&#47;s  0.00 %  0.00 % .&#47;xxxx ..&#47;etc&#47;base.conf<br>17535 be&#47;4 root       18.14 M&#47;s   30.63 M&#47;s  0.00 %  0.00 % xxxx<br>","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439946,"discussion_content":"è¿™ä¸ªIO 99%è·Ÿä½ æƒ³çš„ç£ç›˜IOä½¿ç”¨99%æ˜¯ä¸ä¸€æ ·çš„ï¼Œå…·ä½“å«ä¹‰ä½ å¯ä»¥å»æŸ¥ä¸€ä¸‹iotopçš„æ–‡æ¡£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550675424,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2068424,"avatar":"","nickname":"Geek_9815f1","note":"","ucode":"34EE8566A53F10","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291980,"discussion_content":"è¯·é—®è¿™ä¸ªio 99% æ˜¯æŒ‡è¯¥ksoftirqd å ioçš„ç™¾åˆ†ç™¾ã€‚ è·Ÿç£ç›˜åˆ©ç”¨ç‡utitl ä¸ä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595038784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67058,"user_name":"é¥¼å­","can_delete":false,"product_type":"c1","uid":1085953,"ip_address":"","ucode":"981A44836A5216","user_header":"https://static001.geekbang.org/account/avatar/00/10/92/01/c723d180.jpg","comment_is_top":false,"comment_ctime":1550063703,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1550063703","product_id":100020901,"comment_content":"å­¦ä¹ æ‰“å¡","like_count":0},{"had_liked":false,"id":64339,"user_name":"æé€é¥","can_delete":false,"product_type":"c1","uid":1109750,"ip_address":"","ucode":"DB74823527E203","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/xzHDjCSFicNY3MUMECtNz6sM8yDJhBoyGk5IRoOtUat6ZIkGzxjqEqwqKYWMD3GjehScKvMjicGOGDog5FF18oyg/132","comment_is_top":false,"comment_ctime":1548749329,"is_pvip":false,"replies":[{"id":"22973","content":"ä¸€èˆ¬æ¥è¯´æ˜¯çš„ã€‚ä¸è¿‡å¦‚æœç£ç›˜æ”¯æŒå¹¶å‘å†™çš„è¯ï¼Œå®é™…ä¸Šè¿™æ—¶å€™ç£ç›˜è¿˜æ˜¯å¯ä»¥ç»§ç»­æ¥å—å…¶ä»–çš„å†™è¯·æ±‚ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯ç»å¯¹çš„ã€‚æœ€å¥½æ˜¯åšä¸ªåŸºå‡†æµ‹è¯•ï¼Œè¿™æ ·ä»¥åå†è§‚å¯Ÿçš„æ—¶å€™å°±æœ‰äº†å¯¹æ¯”çš„åŸºå‡†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1548942756,"ip_address":"","comment_id":64339,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548749329","product_id":100020901,"comment_content":"Device:         rrqm&#47;s   wrqm&#47;s     r&#47;s     w&#47;s    rkB&#47;s    wkB&#47;s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util<br>vda               0.00   392.00    0.00 1103.00     0.00  5984.00    10.85     1.00    0.58    0.00    0.58   0.91 100.00<br>æˆ‘è¿™è¾¹ %utilåˆ°äº†100%ï¼Œè¯´æ˜ç£ç›˜æœ‰ç“¶é¢ˆäº†å—ï¼Ÿï¼ˆè¯·æ±‚å‚æ•°ä¸€è‡´ï¼‰<br>","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437964,"discussion_content":"ä¸€èˆ¬æ¥è¯´æ˜¯çš„ã€‚ä¸è¿‡å¦‚æœç£ç›˜æ”¯æŒå¹¶å‘å†™çš„è¯ï¼Œå®é™…ä¸Šè¿™æ—¶å€™ç£ç›˜è¿˜æ˜¯å¯ä»¥ç»§ç»­æ¥å—å…¶ä»–çš„å†™è¯·æ±‚ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯ç»å¯¹çš„ã€‚æœ€å¥½æ˜¯åšä¸ªåŸºå‡†æµ‹è¯•ï¼Œè¿™æ ·ä»¥åå†è§‚å¯Ÿçš„æ—¶å€™å°±æœ‰äº†å¯¹æ¯”çš„åŸºå‡†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548942756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63500,"user_name":"å¤¹å¿ƒé¢åŒ…","can_delete":false,"product_type":"c1","uid":1301957,"ip_address":"","ucode":"002BBA49D83D17","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJCscgdVibmoPyRLRaicvk6rjTJxePZ6VFHvGjUQvtfhCS6kO4OZ1AVibbhNGKlWZmpEFf2yA6ptsqHw/132","comment_is_top":false,"comment_ctime":1548385014,"is_pvip":false,"replies":[{"id":"22586","content":"åªç”¨iowaitä¸èƒ½è¯´æ˜ç£ç›˜ç“¶é¢ˆï¼Œéœ€è¦ç”¨ iostat ","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1548576688,"ip_address":"","comment_id":63500,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548385014","product_id":100020901,"comment_content":"æƒ³è¯·é—®ä¸‹è€å¸ˆ,é€šè¿‡topè§‚å¯Ÿä¸‹çš„iowaitåˆ°è¾¾ç™¾åˆ†ä¹‹å¤šå°‘æ‰ç®—ç£ç›˜ç“¶é¢ˆ,æœ‰æ²¡æœ‰ä¸šç•Œçš„ç»Ÿä¸€æ ‡å‡†,ç£ç›˜çš„utilå€¼è‚¯å®šæ˜¯100%,è¿˜æ˜¯å¾—è€ƒè™‘IOPS,åªé€šè¿‡iowaitåˆ¤æ–­è¡Œä¸è¡Œ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437612,"discussion_content":"åªç”¨iowaitä¸èƒ½è¯´æ˜ç£ç›˜ç“¶é¢ˆï¼Œéœ€è¦ç”¨ iostat ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548576688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}