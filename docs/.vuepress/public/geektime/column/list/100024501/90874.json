{"id":90874,"title":"18 | æ€ä¹ˆå‡å°‘ App ç”µé‡æ¶ˆè€—ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æˆ´é“­ã€‚</p><p>æ‰‹æœºè®¾å¤‡ç”µé‡æœ‰é™ï¼ŒApp å¼€å‘æ—¶å¦‚ä¸æ³¨æ„ç”µé‡çš„çš„æ¶ˆè€—ï¼Œå½“ç”¨æˆ·å‘ç°ä½ çš„ App æ˜¯è€—ç”µå¤§æˆ·æ—¶ï¼Œå°±ä¼šæ¯«ä¸çŠ¹è±«åœ°å°†å…¶æŠ›å¼ƒã€‚æ‰€ä»¥ï¼Œæ¯æ¬¡å¼€å‘å®Œï¼Œæˆ‘ä»¬éƒ½éœ€è¦å»æ£€æŸ¥è‡ªå·±çš„Appæœ‰æ²¡æœ‰è€—ç”µçš„é—®é¢˜ã€‚</p><p>è€—ç”µçš„åŸå› æœ‰åƒä¸‡ç§ï¼Œå¦‚æœæ¯æ¬¡é‡åˆ°è€—ç”µè¿‡å¤šçš„é—®é¢˜ï¼Œæˆ‘ä»¬éƒ½ä»å¤´æŸ¥æ‰¾ä¸€ç•ªçš„è¯ï¼Œé‚£å¿…ç„¶ä¼šæ•ˆç‡ä½ä¸‹ã€‚</p><p>å°±æ¯”å¦‚è¯´ï¼Œæµ‹è¯•åŒå­¦è¿‡æ¥è·Ÿä½ è¯´â€œæŸä¸ªé¡µé¢çš„å‰ä¸€ä¸ªç‰ˆæœ¬è¿˜å¥½å¥½çš„ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„è€—ç”µæ€ä¹ˆå¤šäº†é‚£ä¹ˆå¤šâ€ï¼Œé‚£ä¹ˆä½ é¦–å…ˆæƒ³åˆ°å¯èƒ½å°±æ˜¯è¿™ä¸ªé¡µé¢æœ‰æ²¡æœ‰å¼€å¯å®šä½ï¼Œç½‘ç»œè¯·æ±‚æ˜¯ä¸æ˜¯é¢‘ç¹ï¼Œäº¦æˆ–æ˜¯å®šæ—¶ä»»åŠ¡æ—¶é—´æ˜¯ä¸æ˜¯é—´éš”è¿‡å°ã€‚æ¥ä¸‹æ¥ï¼Œä½ ä¼šå»æŸ¥æ‰¾è€—ç”µé—®é¢˜åˆ°åº•æ˜¯æ€ä¹ˆå¼•èµ·çš„ã€‚ä½ å»ç¿»ä»£ç çš„æ—¶å€™å´å‘ç°ï¼Œè¿™ä¸ªé¡µé¢çš„ç›¸å…³åŠŸèƒ½åœ¨å¥½å‡ ä¸ªç‰ˆæœ¬ä¸­éƒ½æ²¡æ”¹è¿‡äº†ã€‚</p><p>é‚£ä¹ˆï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆåŸå› ä½¿å¾—è¿™ä¸€ä¸ªç‰ˆæœ¬çš„è€—ç”µé‡çªç„¶å¢åŠ å‘¢ï¼Ÿä¸å¦‚å°±ä½¿ç”¨æ’é™¤æ³•å§ï¼Œä½ æŠŠåŠŸèƒ½ä¸€ä¸ªä¸ªéƒ½æ³¨é‡Šæ‰ï¼Œå´å‘ç°è€—ç”µé‡è¿˜æ˜¯æ²¡æœ‰å‡å°‘ã€‚è¿™æ—¶ï¼Œä½ åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘å°±åœ¨ä»Šå¤©çš„æ–‡ç« é‡Œé¢å’Œä½ è¯¦ç»†åˆ†äº«ä¸€ä¸‹è¿™ä¸ªé—®é¢˜çš„è§£æ³•å§ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œåªæœ‰è·å–åˆ°ç”µé‡ï¼Œæ‰èƒ½å¤Ÿå‘ç°ç”µé‡é—®é¢˜ã€‚æ‰€ä»¥ï¼Œæˆ‘å°±å…ˆä»å¦‚ä½•è·å–ç”µé‡å’Œä½ è®²èµ·ã€‚</p><h2>å¦‚ä½•è·å–ç”µé‡ï¼Ÿ</h2><p>åœ¨iOSä¸­ï¼ŒIOKit framework æ˜¯ä¸“é—¨ç”¨äºè·Ÿç¡¬ä»¶æˆ–å†…æ ¸æœåŠ¡é€šä¿¡çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡IOKit framework æ¥è·å–ç¡¬ä»¶ä¿¡æ¯ï¼Œè¿›è€Œè·å–åˆ°ç”µé‡æ¶ˆè€—ä¿¡æ¯ã€‚åœ¨ä½¿ç”¨IOKit frameworkæ—¶ï¼Œä½ éœ€è¦ï¼š</p><!-- [[[read_end]]] --><ul>\n<li>é¦–å…ˆï¼ŒæŠŠIOPowerSources.hã€IOPSKeys.hå’ŒIOKit è¿™ä¸‰ä¸ªæ–‡ä»¶å¯¼å…¥åˆ°å·¥ç¨‹ä¸­ï¼›</li>\n<li>ç„¶åï¼ŒæŠŠbatteryMonitoringEnabledç½®ä¸ºtrueï¼›</li>\n<li>æœ€åï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è·å–1%ç²¾ç¡®åº¦çš„ç”µé‡ä¿¡æ¯ã€‚</li>\n</ul><pre><code>#import &quot;IOPSKeys.h&quot;\n#import &quot;IOPowerSources.h&quot;\n\n-(double) getBatteryLevel{\n    // è¿”å›ç”µé‡ä¿¡æ¯\n    CFTypeRef blob = IOPSCopyPowerSourcesInfo();\n    // è¿”å›ç”µé‡å¥æŸ„åˆ—è¡¨æ•°æ®\n    CFArrayRef sources = IOPSCopyPowerSourcesList(blob);\n    CFDictionaryRef pSource = NULL;\n    const void *psValue;\n    // è¿”å›æ•°ç»„å¤§å°\n    int numOfSources = CFArrayGetCount(sources);\n    // è®¡ç®—å¤§å°å‡ºé”™å¤„ç†\n    if (numOfSources == 0) {\n        NSLog(@&quot;Error in CFArrayGetCount&quot;);\n        return -1.0f;\n    }\n\n    // è®¡ç®—æ‰€å‰©ç”µé‡\n    for (int i=0; i&lt;numOfSources; i++) {\n        // è¿”å›ç”µæºå¯è¯»ä¿¡æ¯çš„å­—å…¸\n        pSource = IOPSGetPowerSourceDescription(blob, CFArrayGetValueAtIndex(sources, i));\n        if (!pSource) {\n            NSLog(@&quot;Error in IOPSGetPowerSourceDescription&quot;);\n            return -1.0f;\n        }\n        psValue = (CFStringRef) CFDictionaryGetValue(pSource, CFSTR(kIOPSNameKey));\n\n        int curCapacity = 0;\n        int maxCapacity = 0;\n        double percentage;\n\n        psValue = CFDictionaryGetValue(pSource, CFSTR(kIOPSCurrentCapacityKey));\n        CFNumberGetValue((CFNumberRef)psValue, kCFNumberSInt32Type, &amp;curCapacity);\n\n        psValue = CFDictionaryGetValue(pSource, CFSTR(kIOPSMaxCapacityKey));\n        CFNumberGetValue((CFNumberRef)psValue, kCFNumberSInt32Type, &amp;maxCapacity);\n\n        percentage = ((double) curCapacity / (double) maxCapacity * 100.0f);\n        NSLog(@&quot;curCapacity : %d / maxCapacity: %d , percentage: %.1f &quot;, curCapacity, maxCapacity, percentage);\n        return percentage;\n    }\n    return -1.\n</code></pre><p>è¯´å®Œè€—ç”µé‡çš„è·å–æ–¹æ³•ï¼Œæˆ‘ä»¬å†ç»§ç»­çœ‹å¦‚ä½•è§£å†³ç”µé‡é—®é¢˜ã€‚</p><h2>å¦‚ä½•è¯Šæ–­ç”µé‡é—®é¢˜ï¼Ÿ</h2><p>å›åˆ°æœ€å¼€å§‹çš„é—®é¢˜ï¼Œå½“ä½ ç”¨æ’é™¤æ³•å°†æ‰€æœ‰åŠŸèƒ½æ³¨é‡Šæ‰åï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆè¿™ä¸ªè€—ç”µä¸€å®šæ˜¯ç”±å…¶ä»–çº¿ç¨‹å¼•èµ·çš„ã€‚åˆ›å»ºè¿™ä¸ªè€—ç”µçº¿ç¨‹çš„åœ°æ–¹å¯èƒ½æ˜¯åœ¨å…¶ä»–åœ°æ–¹ï¼Œæ¯”å¦‚æ˜¯ç”±ç¬¬ä¸‰æ–¹åº“å¼•èµ·ï¼Œæˆ–è€…æ˜¯å…¬å¸å…¶ä»–å›¢é˜Ÿå¼€å‘çš„åº“ã€‚</p><p>æ‰€ä»¥ï¼Œä½ éœ€è¦é€†å‘åœ°å»æ€è€ƒè¿™ä¸ªé—®é¢˜ã€‚è¿™é‡Œï¼Œä½ ä¸å¦¨å›é¡¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨ç¬¬12ç¯‡æ–‡ç« â€œ<a href=\"https://time.geekbang.org/column/article/88600\">iOSå´©æºƒåƒå¥‡ç™¾æ€ªï¼Œå¦‚ä½•å…¨é¢ç›‘æ§</a>â€ä¸­æ˜¯æ€ä¹ˆå®šä½é—®é¢˜çš„ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆåè¿‡æ¥çœ‹çœ‹å‡ºç°ç”µé‡é—®é¢˜çš„æœŸé—´ï¼Œå“ªä¸ªçº¿ç¨‹æ˜¯æœ‰é—®é¢˜çš„ã€‚é€šè¿‡ä¸‹é¢çš„è¿™æ®µä»£ç ï¼Œä½ å°±å¯ä»¥è·å–åˆ°æ‰€æœ‰çº¿ç¨‹çš„ä¿¡æ¯ï¼š</p><pre><code>thread_act_array_t threads;\nmach_msg_type_number_t threadCount = 0;\nconst task_t thisTask = mach_task_self();\nkern_return_t kr = task_threads(thisTask, &amp;threads, &amp;threadCount);\n</code></pre><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡ task_threads å‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå¾—åˆ°æ‰€æœ‰çš„çº¿ç¨‹ä¿¡æ¯æ•°ç»„ threadsï¼Œä»¥åŠçº¿ç¨‹æ€»æ•° threadCountã€‚threads æ•°ç»„é‡Œçš„çº¿ç¨‹ä¿¡æ¯ç»“æ„ä½“ thread_basic_info é‡Œæœ‰ä¸€ä¸ªè®°å½• CPU ä½¿ç”¨ç™¾åˆ†æ¯”çš„å­—æ®µ cpu_usageã€‚thread_basic_infoç»“æ„ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>struct thread_basic_info {\n        time_value_t    user_time;      /* user è¿è¡Œçš„æ—¶é—´ */\n        time_value_t    system_time;    /* system è¿è¡Œçš„æ—¶é—´ */\n        integer_t       cpu_usage;      /* CPU ä½¿ç”¨ç™¾åˆ†æ¯” */\n        policy_t        policy;         /* æœ‰æ•ˆçš„è®¡åˆ’ç­–ç•¥ */\n        integer_t       run_state;      /* run state (see below) */\n        integer_t       flags;          /* various flags (see below) */\n        integer_t       suspend_count;  /* suspend count for thread */\n        integer_t       sleep_time;     /* ä¼‘çœ æ—¶é—´ */\n};\n</code></pre><p>æœ‰äº†è¿™ä¸ª cpu_usage å­—æ®µï¼Œä½ å°±å¯ä»¥é€šè¿‡éå†æ‰€æœ‰çº¿ç¨‹ï¼Œå»æŸ¥çœ‹æ˜¯å“ªä¸ªçº¿ç¨‹çš„ CPU ä½¿ç”¨ç™¾åˆ†æ¯”è¿‡é«˜äº†ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹çš„CPUä½¿ç”¨ç‡é•¿æ—¶é—´éƒ½æ¯”è¾ƒé«˜çš„è¯ï¼Œæ¯”å¦‚è¶…è¿‡äº†90%ï¼Œå°±èƒ½å¤Ÿæ¨æ–­å‡ºå®ƒæ˜¯æœ‰é—®é¢˜çš„ã€‚è¿™æ—¶ï¼Œå°†å…¶æ–¹æ³•å †æ ˆè®°å½•ä¸‹æ¥ï¼Œä½ å°±å¯ä»¥çŸ¥é“åˆ°åº•æ˜¯å“ªæ®µä»£ç è®©ä½  App çš„ç”µé‡æ¶ˆè€—å¤šäº†ã€‚</p><p>é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œä½ å°±å¯ä»¥å¿«é€Ÿå®šä½åˆ°é—®é¢˜ï¼Œæœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œä»£ç ä¼˜åŒ–ã€‚å¤šçº¿ç¨‹ CPU ä½¿ç”¨ç‡æ£€æŸ¥çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>// è½®è¯¢æ£€æŸ¥å¤šä¸ªçº¿ç¨‹ CPU æƒ…å†µ\n+ (void)updateCPU {\n    thread_act_array_t threads;\n    mach_msg_type_number_t threadCount = 0;\n    const task_t thisTask = mach_task_self();\n    kern_return_t kr = task_threads(thisTask, &amp;threads, &amp;threadCount);\n    if (kr != KERN_SUCCESS) {\n        return;\n    }\n    for (int i = 0; i &lt; threadCount; i++) {\n        thread_info_data_t threadInfo;\n        thread_basic_info_t threadBaseInfo;\n        mach_msg_type_number_t threadInfoCount = THREAD_INFO_MAX;\n        if (thread_info((thread_act_t)threads[i], THREAD_BASIC_INFO, (thread_info_t)threadInfo, &amp;threadInfoCount) == KERN_SUCCESS) {\n            threadBaseInfo = (thread_basic_info_t)threadInfo;\n            if (!(threadBaseInfo-&gt;flags &amp; TH_FLAGS_IDLE)) {\n                integer_t cpuUsage = threadBaseInfo-&gt;cpu_usage / 10;\n                if (cpuUsage &gt; 90) {\n                    //cup æ¶ˆè€—å¤§äº 90 æ—¶æ‰“å°å’Œè®°å½•å †æ ˆ\n                    NSString *reStr = smStackOfThread(threads[i]);\n                    //è®°å½•æ•°æ®åº“ä¸­\n                    [[[SMLagDB shareInstance] increaseWithStackString:reStr] subscribeNext:^(id x) {}];\n                    NSLog(@&quot;CPU useage overload thread stackï¼š\\n%@&quot;,reStr);\n                }\n            }\n        }\n    }\n}\n</code></pre><h2>ä¼˜åŒ–ç”µé‡</h2><p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†åœ¨çº¿ä¸Šç¢°åˆ°ç”µé‡é—®é¢˜æ—¶ï¼Œåº”è¯¥å¦‚ä½•è§£å†³ï¼Œä½†æ˜¯ç”µé‡çš„ä¸åˆç†æ¶ˆè€—ä¹Ÿå¯èƒ½æ¥è‡ªå…¶ä»–æ–¹é¢ã€‚CPU æ˜¯è€—ç”µçš„å¤§å¤´ï¼Œå¼•èµ· CPU è€—ç”µçš„å•ç‚¹é—®é¢˜å¯ä»¥é€šè¿‡ç›‘æ§æ¥è§£å†³ï¼Œä½†ç‚¹æ»´æ±‡èšç»ˆæˆå¤§æµ·ï¼Œæ¯ä¸€ä¸ªä¸åˆç†çš„å°çš„ç”µé‡æ¶ˆè€—ï¼Œæœ€ç»ˆéƒ½å¯èƒ½ä¼šé€ æˆå¤§çš„ç”µé‡æµªè´¹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å¹³æ—¶çš„å¼€å‘å·¥ä½œä¸­ï¼Œæ—¶åˆ»å…³æ³¨å¯¹è€—ç”µé‡çš„ä¼˜åŒ–ä¹Ÿéå¸¸é‡è¦ã€‚</p><p>å¯¹ CPU çš„ä½¿ç”¨è¦ç²¾æ‰“ç»†ç®—ï¼Œè¦é¿å…è®© CPU åšå¤šä½™çš„äº‹æƒ…ã€‚å¯¹äºå¤§é‡æ•°æ®çš„å¤æ‚è®¡ç®—ï¼Œåº”è¯¥æŠŠæ•°æ®ä¼ åˆ°æœåŠ¡å™¨å»å¤„ç†ï¼Œå¦‚æœå¿…é¡»è¦åœ¨ App å†…å¤„ç†å¤æ‚æ•°æ®è®¡ç®—ï¼Œå¯ä»¥é€šè¿‡ GCD çš„ dispatch_block_create_with_qos_class æ–¹æ³•æŒ‡å®šé˜Ÿåˆ—çš„ Qos ä¸º QOS_CLASS_UTILITYï¼Œå°†è®¡ç®—å·¥ä½œæ”¾åˆ°è¿™ä¸ªé˜Ÿåˆ—çš„ block é‡Œã€‚åœ¨ QOS_CLASS_UTILITY è¿™ç§ Qos æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿé’ˆå¯¹å¤§é‡æ•°æ®çš„è®¡ç®—ï¼Œä»¥åŠå¤æ‚æ•°æ®å¤„ç†ä¸“é—¨åšäº†ç”µé‡ä¼˜åŒ–ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†çœ‹çœ‹<strong>é™¤äº† CPU ä¼šå½±å“è€—ç”µï¼Œå¯¹ç”µé‡å½±å“è¾ƒå¤§çš„å› ç´ è¿˜æœ‰å“ªäº›å‘¢ï¼Ÿ</strong></p><p>é™¤äº† CPUï¼ŒI/Oæ“ä½œä¹Ÿæ˜¯è€—ç”µå¤§æˆ·ã€‚ä»»ä½•çš„ I/O æ“ä½œï¼Œéƒ½ä¼šç ´åæ‰ä½åŠŸè€—çŠ¶æ€ã€‚é‚£ä¹ˆï¼Œé’ˆå¯¹ I/O æ“ä½œè¦æ€ä¹ˆä¼˜åŒ–å‘¢ï¼Ÿ</p><p>ä¸šå†…çš„æ™®éåšæ³•æ˜¯ï¼Œå°†ç¢ç‰‡åŒ–çš„æ•°æ®ç£ç›˜å­˜å‚¨æ“ä½œå»¶åï¼Œå…ˆåœ¨å†…å­˜ä¸­èšåˆï¼Œç„¶åå†è¿›è¡Œç£ç›˜å­˜å‚¨ã€‚ç¢ç‰‡åŒ–çš„æ•°æ®è¿›è¡Œèšåˆï¼Œåœ¨å†…å­˜ä¸­è¿›è¡Œå­˜å‚¨çš„æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ NSCache æ¥å®Œæˆã€‚</p><p>NSCache æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒNSCache ä¼šåœ¨åˆ°è¾¾é¢„è®¾ç¼“å­˜ç©ºé—´å€¼æ—¶æ¸…ç†ç¼“å­˜ï¼Œè¿™æ—¶ä¼šè§¦å‘ cache:willEvictObject: æ–¹æ³•çš„å›è°ƒï¼Œåœ¨è¿™ä¸ªå›è°ƒé‡Œå°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œ I/O æ“ä½œï¼Œè¾¾åˆ°å°†èšåˆçš„æ•°æ® I/O å»¶åçš„ç›®çš„ã€‚I/O æ“ä½œçš„æ¬¡æ•°å‡å°‘äº†ï¼Œå¯¹ç”µé‡çš„æ¶ˆè€—ä¹Ÿå°±å‡å°‘äº†ã€‚</p><p>SDWebImage å›¾ç‰‡åŠ è½½æ¡†æ¶ï¼Œåœ¨å›¾ç‰‡çš„è¯»å–ç¼“å­˜å¤„ç†æ—¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ I/Oï¼Œè€Œæ˜¯ä½¿ç”¨äº†NSCacheã€‚ä½¿ç”¨ NSCache çš„ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>- (UIImage *)imageFromMemoryCacheForKey:(NSString *)key {\n    return [self.memCache objectForKey:key];\n}\n\n- (UIImage *)imageFromDiskCacheForKey:(NSString *)key {\n    // æ£€æŸ¥ NSCache é‡Œæ˜¯å¦æœ‰\n    UIImage *image = [self imageFromMemoryCacheForKey:key];\n    if (image) {\n        return image;\n    }\n    // ä»ç£ç›˜é‡Œè¯»\n    UIImage *diskImage = [self diskImageForKey:key];\n    if (diskImage &amp;&amp; self.shouldCacheImagesInMemory) {\n        NSUInteger cost = SDCacheCostForImage(diskImage);\n        [self.memCache setObject:diskImage forKey:key cost:cost];\n    }\n    return diskImage;\n}\n</code></pre><p>å¯ä»¥çœ‹å‡ºï¼ŒSDWebImage å°†è·å–çš„å›¾ç‰‡æ•°æ®éƒ½æ”¾åˆ°äº† NSCache é‡Œï¼Œåˆ©ç”¨ NSCache ç¼“å­˜ç­–ç•¥è¿›è¡Œå›¾ç‰‡ç¼“å­˜å†…å­˜çš„ç®¡ç†ã€‚æ¯æ¬¡è¯»å–å›¾ç‰‡æ—¶ï¼Œä¼šæ£€æŸ¥ NSCache æ˜¯å¦å·²ç»å­˜åœ¨å›¾ç‰‡æ•°æ®ï¼šå¦‚æœæœ‰ï¼Œå°±ç›´æ¥ä» NSCache é‡Œè¯»å–ï¼›å¦‚æœæ²¡æœ‰ï¼Œæ‰ä¼šé€šè¿‡ I/O è¯»å–ç£ç›˜ç¼“å­˜å›¾ç‰‡ã€‚</p><p>ä½¿ç”¨äº† NSCache å†…å­˜ç¼“å­˜èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘ I/O æ“ä½œï¼Œä½ åœ¨å†™ç±»ä¼¼åŠŸèƒ½æ—¶ä¹Ÿå¯ä»¥é‡‡ç”¨è¿™æ ·çš„æ€è·¯ï¼Œè®©ä½ çš„ App æ›´çœç”µã€‚</p><p><strong>CPU å’Œ I/O è¿™ä¸¤å¤§è€—ç”µé—®é¢˜éƒ½è§£å†³åï¼Œè¿˜æœ‰ä»€ä¹ˆè¦æ³¨æ„çš„å‘¢ï¼Ÿ</strong>è¿™é‡Œè¿˜æœ‰ä¸¤ä»½å…³äºAppç”µé‡æ¶ˆè€—çš„èµ„æ–™ï¼Œä½ å¯ä»¥å¯¹ç…§ä½ çš„Appæ¥æŸ¥çœ‹ã€‚</p><p>è‹¹æœå…¬å¸ä¸“é—¨ç»´æŠ¤äº†ä¸€ä¸ªç”µé‡ä¼˜åŒ–æŒ‡å—â€œ<a href=\"https://developer.apple.com/library/archive/documentation/Performance/Conceptual/EnergyGuide-iOS/\">Energy Efficiency Guide for iOS Apps</a>â€ï¼Œåˆ†åˆ«ä» CPUã€è®¾å¤‡å”¤é†’ã€ç½‘ç»œã€å›¾å½¢ã€åŠ¨ç”»ã€è§†é¢‘ã€å®šä½ã€åŠ é€Ÿåº¦è®¡ã€é™€èºä»ªã€ç£åŠ›è®¡ã€è“ç‰™ç­‰å¤šæ–¹é¢å› ç´ æå‡ºäº†ç”µé‡ä¼˜åŒ–æ–¹é¢çš„å»ºè®®ã€‚æ‰€ä»¥ï¼Œå½“ä½¿ç”¨äº†è‹¹æœå…¬å¸çš„ç”µé‡ä¼˜åŒ–æŒ‡å—é‡Œæåˆ°çš„åŠŸèƒ½æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§æŒ‡å—é‡Œçš„æœ€ä½³å®è·µå»åšå°±èƒ½å¤Ÿä¿è¯è¿™äº›åŠŸèƒ½ä¸ä¼šå¼•èµ·ä¸åˆç†çš„ç”µé‡æ¶ˆè€—ã€‚</p><p>åŒæ—¶ï¼Œè‹¹æœå…¬å¸åœ¨2017å¹´ WWDC çš„ Session 238 ä¹Ÿåˆ†äº«äº†ä¸€ä¸ªå…³äºå¦‚ä½•ç¼–å†™èŠ‚èƒ½ App çš„ä¸»é¢˜â€œ<a href=\"https://developer.apple.com/videos/play/wwdc2017/238/\">Writing Energy Efficient Apps</a>â€ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘è·Ÿä½ åˆ†äº«äº†å¦‚ä½•é€šè¿‡è·å–çº¿ç¨‹ä¿¡æ¯é‡Œçš„cpu_usage å­—æ®µæ¥åˆ¤æ–­è€—ç”µçº¿ç¨‹ï¼Œè¿›è€Œå¾—åˆ°å½“å‰çº¿ç¨‹æ‰§è¡Œæ–¹æ³•å †æ ˆï¼Œä»è€Œç²¾å‡†ã€å¿«é€Ÿåœ°å®šä½åˆ°å¼•èµ·è€—ç”µçš„å…·ä½“æ–¹æ³•ã€‚æˆ‘æ›¾ç»ç”¨è¿™ä¸ªæ–¹æ³•è§£å†³äº†å‡ èµ·éš¾ä»¥å®šä½çš„è€—ç”µé—®é¢˜ï¼Œè¿™äº›é—®é¢˜éƒ½å‡ºåœ¨äºŒæ–¹åº“ä¸Šã€‚é€šè¿‡è·å–åˆ°çš„æ–¹æ³•å †æ ˆï¼Œæˆ‘å°±æœ‰äº†å……è¶³çš„è¯æ®å»æ¨åŠ¨å…¶ä»–å›¢é˜Ÿè¿›è¡Œç”µé‡ä¼˜åŒ–ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è¿˜è·Ÿä½ ä»‹ç»äº†å¦‚ä½•åœ¨å¹³æ—¶å¼€å‘ä¸­å…³æ³¨ç”µé‡çš„é—®é¢˜ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œå‡å°‘ App è€—ç”µä¹Ÿæ˜¯å¼€å‘è€…çš„å¤©èŒï¼Œä¸ç„¶å¦‚ä½•å‘æˆ‘ä»¬å¯çˆ±çš„ç”¨æˆ·äº¤ä»£å‘¢ã€‚</p><h2>è¯¾åå°ä½œä¸š</h2><p>è¯·ä½ ä½¿ç”¨æˆ‘ä»Šå¤©åˆ†äº«çš„è€—ç”µæ£€æŸ¥æ–¹æ³•ï¼Œæ£€æŸ¥ä¸€ä¸‹ä½ çš„ Appï¼Œçœ‹çœ‹å“ªä¸ªæ–¹æ³•æœ€è€—ç”µã€‚</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç»™æˆ‘ç•™è¨€åˆ†äº«ä½ çš„è§‚ç‚¹ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p>","comments":[{"had_liked":false,"id":87901,"user_name":"æ³½ä¸ƒ","can_delete":false,"product_type":"c1","uid":1453863,"ip_address":"","ucode":"37199E28ABA3D5","user_header":"https://static001.geekbang.org/account/avatar/00/16/2f/27/9a606b3e.jpg","comment_is_top":false,"comment_ctime":1555747432,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"169059471976","product_id":100024501,"comment_content":"è·å–ç”µé‡ä¸ºä»€ä¹ˆä¸ç”¨ [[UIDevice currentDevice] batteryLevel] å‘¢ï¼Ÿ","like_count":40},{"had_liked":false,"id":93426,"user_name":"åŒ…ç½—ä¸‡è±¡","can_delete":false,"product_type":"c1","uid":1087130,"ip_address":"","ucode":"29AFA27338F0FB","user_header":"https://static001.geekbang.org/account/avatar/00/10/96/9a/78f2af55.jpg","comment_is_top":false,"comment_ctime":1557468819,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31622239891","product_id":100024501,"comment_content":"iokitå·²ç»æ— æ³•å¯¼å…¥äº†ï¼Œè¯·é—®è€å¸ˆè¿™ç§æƒ…å†µä½ æ˜¯æ€ä»¬å¤„ç†çš„ï¼Ÿ","like_count":7},{"had_liked":false,"id":94972,"user_name":"cp_kong","can_delete":false,"product_type":"c1","uid":1454783,"ip_address":"","ucode":"407F50CF9A6588","user_header":"https://static001.geekbang.org/account/avatar/00/16/32/bf/5f4681b6.jpg","comment_is_top":false,"comment_ctime":1557932787,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14442834675","product_id":100024501,"comment_content":"IOKit Frameworks ç›®å‰åœ¨iOSé¡¹ç›®ä¸­æ— æ³•å¯¼å…¥äº†ï¼Œè¦è‡ªå·±æ–°å»ºä¸€ä¸ªmacé¡¹ç›®ï¼Œç„¶åä»é‚£ä¸ªé¡¹ç›®å¯¼å…¥ï¼Œå†æ‹·åˆ°iOSé¡¹ç›®ä¸­","like_count":3,"discussions":[{"author":{"id":1147205,"avatar":"https://static001.geekbang.org/account/avatar/00/11/81/45/9aa91b75.jpg","nickname":"çŸ®ä¸ªå­å…ˆç”ŸğŸ˜","note":"","ucode":"2242A457B0E10D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3308,"discussion_content":"iokitæ˜¯æœ‰,ä½†æ˜¯æ²¡æœ‰IOPSKeys.h  å’Œ IOPowerSources.h","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1564390605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":88764,"user_name":"cocoakc","can_delete":false,"product_type":"c1","uid":1216851,"ip_address":"","ucode":"5785552C55935B","user_header":"https://static001.geekbang.org/account/avatar/00/12/91/53/ebf6a6ac.jpg","comment_is_top":false,"comment_ctime":1555995623,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14440897511","product_id":100024501,"comment_content":"IOKit framework æ˜¯Mac çš„æ¡†æ¶ï¼Ÿå‚è€ƒçš„è¿™ä¸ªå—ï¼Ÿhttps:&#47;&#47;blog.csdn.net&#47;uxyheaven&#47;article&#47;details&#47;38167509","like_count":3},{"had_liked":false,"id":153184,"user_name":"ç¹æ˜Ÿmind","can_delete":false,"product_type":"c1","uid":1455441,"ip_address":"","ucode":"387B67F75303AA","user_header":"https://static001.geekbang.org/account/avatar/00/16/35/51/ed895596.jpg","comment_is_top":false,"comment_ctime":1574175983,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10164110575","product_id":100024501,"comment_content":"ç”µé‡ä¼˜åŒ– https:&#47;&#47;www.jianshu.com&#47;p&#47;bd2c1ce5c02a","like_count":2},{"had_liked":false,"id":153452,"user_name":"æ˜Ÿè¾°","can_delete":false,"product_type":"c1","uid":1472359,"ip_address":"","ucode":"7BC303BA20C134","user_header":"https://static001.geekbang.org/account/avatar/00/16/77/67/10063e76.jpg","comment_is_top":false,"comment_ctime":1574238006,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574238006","product_id":100024501,"comment_content":"è€å¸ˆä½ å¥½ï¼ŒIOKitä¸­æ‹¿åˆ°çš„ç”µæ± ç”µé‡ä¸UIDeviceä¸­è·å–åˆ°çš„ç”µæ± ç”µé‡ç›¸æ¯”è°çš„ç²¾åº¦æ›´é«˜å‘¢","like_count":0},{"had_liked":false,"id":102839,"user_name":"Alexander","can_delete":false,"product_type":"c1","uid":1459781,"ip_address":"","ucode":"7E1B422B18E212","user_header":"https://static001.geekbang.org/account/avatar/00/16/46/45/570163e0.jpg","comment_is_top":false,"comment_ctime":1560310623,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560310623","product_id":100024501,"comment_content":"è·å–ç”µé‡çš„forå¾ªç¯ç›´æ¥returnäº†ã€‚","like_count":0},{"had_liked":false,"id":93484,"user_name":"æœˆè½æ³‰","can_delete":false,"product_type":"c1","uid":1458702,"ip_address":"","ucode":"FC03912F1EBB83","user_header":"https://static001.geekbang.org/account/avatar/00/16/42/0e/21b8025f.jpg","comment_is_top":false,"comment_ctime":1557479380,"is_pvip":false,"replies":[{"id":"35022","content":"https:&#47;&#47;github.com&#47;ming1016&#47;GCDFetchFeed<br>GCDFetchFeed&#47;GCDFetchFeed&#47;GCDFetchFeed&#47;Lib&#47;SMLagMonitor&#47;SMCallStack.m","user_name":"ä½œè€…å›å¤","user_name_real":"æˆ´é“­","uid":"1140280","ctime":1558851877,"ip_address":"","comment_id":93484,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1557479380","product_id":100024501,"comment_content":"smStackOfThreadè¿™ä¸ªæ–¹æ³•å“ªæœ‰å•Š","like_count":0,"discussions":[{"author":{"id":1140280,"avatar":"https://static001.geekbang.org/account/avatar/00/11/66/38/f9999b2b.jpg","nickname":"æˆ´é“­","note":"","ucode":"D61E685F962387","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449652,"discussion_content":"https://github.com/ming1016/GCDFetchFeed\nGCDFetchFeed/GCDFetchFeed/GCDFetchFeed/Lib/SMLagMonitor/SMCallStack.m","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558851877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90703,"user_name":"doâ€†.åˆ©å†›","can_delete":false,"product_type":"c1","uid":1472173,"ip_address":"","ucode":"7F51BD387E7056","user_header":"https://static001.geekbang.org/account/avatar/00/16/76/ad/1dbf46f5.jpg","comment_is_top":false,"comment_ctime":1556612674,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556612674","product_id":100024501,"comment_content":"Stack of thread: 771:<br>CPU used: 34.0 percent<br>user time: 542025 second<br>libsystem_kernel.dylib         0x111e6617a mach_msg_trap + 10<br>libsystem_kernel.dylib         0x111e696a2 thread_get_state + 421<br>Stock                          0x102e35f7e smStackOfThread + 878<br>Stock                          0x102f0fea8 +[SMCPUMonitor updateCPU] + 296<br>Stock                          0x1038d097f -[AppDelegate updateCPUInfo] + 47<br>Foundation                     0x10bd2a135 __NSFireTimer + 83<br>CoreFoundation                 0x10a8613e4 __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 20<br>CoreFoundation                 0x10a860ff2 __CFRunLoopDoTimer + 1026<br>CoreFoundation                 0x10a86085a __CFRunLoopDoTimers + 266<br>CoreFoundation                 0x10a85aefc __CFRunLoopRun + 2220<br>CoreFoundation                 0x10a85a302 CFRunLoopRunSpecific + 626<br>GraphicsServices               0x1127d52fe GSEventRunModal + 65<br>UIKitCore                      0x11b5dfba2 UIApplicationMain + 140<br>Stock                          0x103ff37d0 main + 112<br>libdyld.dylib                  0x111b48541 start + 1<br><br>æˆ‘æ£€æµ‹åˆ°çš„ä¿¡æ¯å¦‚ä¸Šï¼Œ+åè¾¹çš„æ•°å­—æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ•°å€¼è¶Š=å¤§ï¼Œè¡¨ç¤ºå ç”¨è¶Šå¤šï¼Ÿ","like_count":0},{"had_liked":false,"id":90641,"user_name":"å¥½é¥¿æ—©çŸ¥é“é€å¤–å–äº†","can_delete":false,"product_type":"c1","uid":1132304,"ip_address":"","ucode":"AED22DB5BF8FC7","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/10/2d673601.jpg","comment_is_top":false,"comment_ctime":1556593990,"is_pvip":false,"replies":[{"id":"32660","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æˆ´é“­","uid":"1140280","ctime":1556889731,"ip_address":"","comment_id":90641,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1556593990","product_id":100024501,"comment_content":"QOS_CLASS_UTILITYæŒ‡å®šblockçš„Qosï¼Œæ˜¯ä¸æ˜¯å’Œè®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§æ•ˆæœä¸€æ ·ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1140280,"avatar":"https://static001.geekbang.org/account/avatar/00/11/66/38/f9999b2b.jpg","nickname":"æˆ´é“­","note":"","ucode":"D61E685F962387","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448606,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1556889731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":90183,"user_name":"å­¤ç‹¬çš„ç è€…","can_delete":false,"product_type":"c1","uid":1457459,"ip_address":"","ucode":"0D94261EE3CF34","user_header":"https://static001.geekbang.org/account/avatar/00/16/3d/33/97fde9a0.jpg","comment_is_top":false,"comment_ctime":1556442826,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556442826","product_id":100024501,"comment_content":"iOSéœ€è¦å¼ºåˆ¶å¯¼å…¥IOKitæ¡†æ¶å—","like_count":0},{"had_liked":false,"id":89485,"user_name":"Calabash_Boy","can_delete":false,"product_type":"c1","uid":1453760,"ip_address":"","ucode":"19E4D819792983","user_header":"","comment_is_top":false,"comment_ctime":1556183441,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556183441","product_id":100024501,"comment_content":"è·å–ç”µé‡æ–¹æ³•é‡Œ,ä¸ºä»€ä¹ˆå¾ªç¯é‡Œæœ‰ä¸ªreturnå‘¢?é‚£å°±æ²¡æœ‰å¿…è¦å†™å¾ªç¯äº†å§","like_count":0},{"had_liked":false,"id":88751,"user_name":"èµ«å°åƒ§","can_delete":false,"product_type":"c1","uid":1454471,"ip_address":"","ucode":"58A77BF59616F5","user_header":"https://static001.geekbang.org/account/avatar/00/16/31/87/1a0377fa.jpg","comment_is_top":false,"comment_ctime":1555991979,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555991979","product_id":100024501,"comment_content":"è¯·æ•™ä¸ªé—®é¢˜, dispatch_block_create_with_qos_class è¿™ç§æ–¹å¼åˆ›å»ºå‡ºçš„é˜Ÿåˆ—è¿›è¡Œå¤æ‚è®¡ç®—çš„æ—¶å€™å¯¹ç”µé‡æœ‰ä¼˜åŒ–. ç›¸å…³ä¿¡æ¯å¯ä»¥å»å“ªæŸ¥çœ‹å‘¢?<br><br>","like_count":0},{"had_liked":false,"id":88440,"user_name":"å­™å¯è¶…","can_delete":false,"product_type":"c1","uid":1015696,"ip_address":"","ucode":"8055EFE5B5E6CF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/90/0249f424.jpg","comment_is_top":false,"comment_ctime":1555918673,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555918673","product_id":100024501,"comment_content":"è¯·é—®è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼Œä¸‹é¢è¿™æ®µä»£ç å¦‚ä½•åœ¨æ–­ç‚¹æ—¶æ’å…¥åˆ°æœ‰é—®é¢˜çš„æ–¹æ³•ä¸­ï¼š<br>thread_act_array_t threads;<br>mach_msg_type_number_t threadCount = 0;<br>const task_t thisTask = mach_task_self();<br>kern_return_t kr = task_threads(thisTask, &amp;threads, &amp;threadCount);<br>","like_count":0},{"had_liked":false,"id":88038,"user_name":"Ant","can_delete":false,"product_type":"c1","uid":1079563,"ip_address":"","ucode":"07E6374F91F61E","user_header":"https://static001.geekbang.org/account/avatar/00/10/79/0b/4346a253.jpg","comment_is_top":false,"comment_ctime":1555821609,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555821609","product_id":100024501,"comment_content":"å—æ•™äº†","like_count":0},{"had_liked":false,"id":87829,"user_name":"é»„æ˜","can_delete":false,"product_type":"c1","uid":1038157,"ip_address":"","ucode":"37F8BE14148608","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d7/4d/d74ffb1f.jpg","comment_is_top":false,"comment_ctime":1555725852,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555725852","product_id":100024501,"comment_content":"cpuä½¿ç”¨é‡ç¡®å®æ˜¯è€—ç”µçš„é‡å¤§åŸå› ã€‚ä¸åˆç†çš„åŠ¨ç”»å¯èƒ½å¯¼è‡´cpuæš´æ¶¨ï¼Œç”µé‡æŸè€—å·¨å¤§ã€‚","like_count":1}]}