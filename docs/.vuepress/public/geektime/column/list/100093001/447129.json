{"id":447129,"title":"15 | æµé‡éš”ç¦»ï¼šMySQLæ•°æ®åº“éš”ç¦»æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é«˜æ¥¼ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬è¯¦ç»†è®²è®²æ€æ ·åŸºäºå¾®æœåŠ¡æŠ€æœ¯è¿›è¡Œ MySQL æ•°æ®åº“éš”ç¦»çš„è½åœ°ã€‚</p><p>å¯¹çº¿ä¸Šå‹æµ‹æ¥è¯´ï¼Œæœ€é‡è¦çš„ç¯èŠ‚å°±æ˜¯<strong>æµé‡éš”ç¦»</strong>äº†ï¼Œè€Œè¿™å…¶ä¸­æœ€æ ¸å¿ƒçš„åˆæ˜¯<strong>æ•°æ®åº“éš”ç¦»</strong>ï¼Œåªæœ‰è¯†åˆ«å¹¶éš”ç¦»æ­£å¼æµé‡ä¸å‹æµ‹æµé‡æ‰èƒ½é¿å…äº§ç”Ÿ<strong>è„æ•°æ®</strong>ã€‚</p><h2>ä¸ºä»€ä¹ˆè¦åšæ•°æ®åº“éš”ç¦»ï¼Ÿ</h2><p><strong>ä¸ºä»€ä¹ˆåšæ•°æ®åº“éš”ç¦»å‘¢ï¼Ÿ</strong>æˆ‘ç»™ä½ ä¸¾ä¸ªä¾‹å­ã€‚è®°å¾—å‡ å¹´å‰ï¼Œæˆ‘å½“æ—¶æ‰€åœ¨çš„å…¬å¸åšçº¿ä¸Šå‹æµ‹ã€‚å½“æ—¶å›¢é˜Ÿå¹¶æ²¡æœ‰åšæ•°æ®åº“éš”ç¦»ï¼Œè€Œæ˜¯ç›´æ¥åœ¨çº¿ä¸Šç”Ÿäº§åº“è¿›è¡Œå‹æµ‹ï¼Œå¯¼è‡´äº§ç”Ÿäº†å¾ˆå¤šè„æ•°æ®ã€‚ç»“æœèŠ±è´¹äº†å¾ˆé•¿æ—¶é—´å»æ¸…ç†æ•°æ®ï¼Œä½†æœ€ç»ˆä¹Ÿæ²¡æœ‰å®Œå…¨æ¸…ç†å¹²å‡€ï¼Œå®ƒä¸ä»…æ±¡æŸ“äº†ç”Ÿäº§æ•°æ®è¿˜å¯¹çº¿ä¸Šä¸šåŠ¡äº§ç”Ÿäº†ä¸å¥½çš„å½±å“ï¼Œå½±å“äº†ç”¨æˆ·ä½“éªŒã€‚<strong>æ‰€ä»¥è¯´åšçº¿ä¸Šå‹æµ‹ï¼Œæ•°æ®åº“éš”ç¦»æ˜¯å¿…é¡»åšçš„ä¸€ä¸ªç¯èŠ‚</strong>ã€‚</p><p>å½“ç„¶äº†ï¼Œå¦‚æœä½ çš„å…¬å¸ä¸å·®é’±ï¼Œä¹Ÿå¯ä»¥ç›´æ¥éš”ç¦»å‡ºä¸€å¥—çº¿ä¸‹1:1é•œåƒç¯å¢ƒåšå‹æµ‹ã€‚ä½†æ˜¯å¤§éƒ¨åˆ†å…¬å¸å¹¶æ²¡æœ‰è¿™ä¹ˆâ€œåœŸè±ªâ€ï¼Œè¿˜å¾—ä½¿ç”¨ç›®å‰çš„ç”Ÿäº§åå¢ƒåšå‹æµ‹ï¼Œé‚£ä¹ˆæ•°æ®åº“éš”ç¦»æŠ€æœ¯å°±å¿…ä¸å¯å°‘äº†ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘æ¢³ç†äº†ä¸€ä¸‹ç›®å‰ä¸šç•Œå¯¹äºæ•°æ®åº“éš”ç¦»çš„ä¸»è¦è§£å†³æ–¹æ¡ˆï¼Œä»¥åŠå®ƒä»¬çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/dd/e96da5730379c3c94215f327069674dd.jpg?wh=1920x1080\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®ä¸åŒçš„é¡¹ç›®æƒ…å†µï¼Œå¯ä»¥é€‰æ‹©ä¸åŒçš„æŠ€æœ¯æ–¹æ¡ˆï¼Œ<strong>è¿™é‡Œæœ€ä¼˜ã€æœ€å®‰å…¨çš„æ–¹æ¡ˆå½“ç„¶é¦–æ¨å½±å­åº“</strong>ï¼Œå…·ä½“çš„ä¼˜ç¼ºç‚¹ä¸Šé¢è¡¨æ ¼å·²ç»å†™å¾—éå¸¸æ¸…æ¥šäº†ã€‚â€‹</p><p>å…¶å®ï¼Œä¸Šé¢è¿™ä¸‰ç§æ•°æ®åº“éš”ç¦»æŠ€æœ¯ç°åœ¨éƒ½å·²ç»å¾ˆæˆç†Ÿäº†ï¼Œè¦åšåˆ°å¹¶ä¸å¤ªéš¾ã€‚ä½†æ˜¯å‡ºäºå„æ–¹é¢çš„åŸå› ï¼Œæˆ‘ä»¬åœ¨ç½‘ä¸Šå¾ˆå°‘çœ‹åˆ°è¿‡å®Œæ•´çš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆï¼Œè€Œæœ‰äº›å…¬å¸æŠŠå®ƒä»¬è§†ä½œâ€œç‹¬é—¨ç§˜æ–¹â€ï¼Œæ‰€ä»¥æ•°æ®åº“éš”ç¦»è¿˜è¿œè¿œè°ˆä¸ä¸Šæ™®åŠã€‚ä¸è¿‡éšç€å¸‚åœºçš„å‘å±•ï¼Œæ•°æ®åº“éš”ç¦»çš„é¢çº±è¿Ÿæ—©ä¼šç¼“ç¼“æ­å¼€ã€‚</p><!-- [[[read_end]]] --><p>å¯¹äºæˆ‘ä»¬è¿™ä¸ªç”µå•†é¡¹ç›®ï¼Œæˆ‘é€‰æ‹©é‡‡ç”¨å½±å­åº“ã€‚å› ä¸ºæ•°æ®åç§»ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œä¸å€¼å¾—é€‰æ‹©ï¼Œè€Œå½±å­è¡¨ä»£ç ä¿®æ”¹é‡å¤§ï¼Œé£é™©å¤§ä¸å¥½æ§åˆ¶ã€‚å½±å­åº“å‘¢ï¼Œé£é™©å°ï¼Œæ”¹åŠ¨é‡å°ã€‚ç»¼åˆæƒè¡¡åï¼Œæˆ‘ä»¬è®¤ä¸ºé‡‡ç”¨å½±å­åº“æ€§ä»·æ¯”æ›´é«˜ã€‚</p><p>åœ¨è¿›è¡Œå½±å­åº“çš„æ”¹é€ ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ç›®å‰é¡¹ç›®çš„ç³»ç»Ÿé“¾è·¯å›¾ã€‚å¿ƒä¸­æœ‰é“¾è·¯å›¾ï¼Œæ‰èƒ½çŸ¥é“åœ¨å“ªäº›åœ°æ–¹æ”¹é€ ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/76/67/7619f4a70f6f8ee62dfa8fd43711dc67.png?wh=1920x826\" alt=\"å›¾ç‰‡\"></p><p>ä¸Šé¢æ˜¯ç®€å•çš„é“¾è·¯å›¾ï¼Œä½ å¯ä»¥å¾ˆæ¸…æ¥šåœ°çŸ¥é“ï¼Œå“ªäº›æœåŠ¡ä¸ MySQL æ•°æ®åº“æœ‰å…³ç³»ã€‚ä¸ºäº†æ–¹ä¾¿ä½ æ›´ç›´è§‚åœ°ç†è§£ï¼Œæˆ‘ç»™ä½ ç”»äº†ä¸ªæ€ç»´å¯¼å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/96/6c/964818d5c9363fb9eab7d26fc40f0b6c.jpg?wh=1876x1688\" alt=\"å›¾ç‰‡\"></p><p>æœ‰äº†é“¾è·¯å›¾åšæŒ‡å¯¼ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¿®æ”¹å„ä¸ªæ¨¡å—ï¼Œè¿›è¡Œå…·ä½“çš„ä»£ç æ”¹é€ å·¥ä½œäº†ã€‚ä¸ºäº†å‡å°‘é£é™©ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™ä¸€ä¸ª demo åšåˆ†åº“å®ä¾‹æ¼”ç¤ºã€‚å¦‚æœ demo æ²¡é—®é¢˜ï¼Œå†ä¿®æ”¹ä¸€ä¸ªçº¿ä¸Šå®ä¾‹åšå®éªŒã€‚éªŒè¯å®Œæ¯•å¹¶æƒè¡¡é£é™©åï¼Œå†åŒæ­¥å…¶ä»–æœåŠ¡ï¼Œåªæœ‰è¿™æ ·åå¤éªŒè¯æ‰èƒ½æŠŠæ”¹é€ é£é™©é™åˆ°æœ€ä½ã€‚</p><h2>å½±å­åº“æŠ€æœ¯é¢„æ¼”</h2><p>åœ¨åšå½±å­åº“æ”¹é€ ä¹‹å‰ï¼Œéœ€è¦è°ƒç ”å¯ä»¥ç”¨ä»€ä¹ˆæŠ€æœ¯åšï¼Œå¿ƒä¸­æœ‰æ€è·¯æ‰å¥½ä¸‹æ‰‹å®è·µã€‚</p><h3>å‡†å¤‡å·¥ä½œ</h3><p>é¦–å…ˆï¼Œæ‰“å¼€å¼€å‘å·¥å…·ï¼ˆå¦‚ Ideaï¼‰æ–°å»º SpringBoot å·¥ç¨‹ï¼ˆè¯´æ˜ï¼šè¿™é‡Œç”¨ä»€ä¹ˆå·¥å…·ä¸ä»€ä¹ˆå·¥ç¨‹æ— æ‰€è°“ï¼Œåªè¦è¾¾åˆ°åˆ†åº“çš„ç›®çš„å°±è¡Œï¼‰ã€‚æ—¢ç„¶æ˜¯åˆ†åº“å·¥ä½œï¼Œå°±éœ€è¦åœ¨ MySQL æ•°æ®åº“ä¸­æ–°å»ºä¸¤ä¸ªæ•°æ®åº“ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8d/e8/8d3f9d1e7506333533d673c52de7f3e8.png?wh=1722x534\" alt=\"å›¾ç‰‡\"></p><p>æ–°å»ºæ•°æ®åº“å‚è€ƒè¯­å¥å¦‚ä¸‹ï¼š</p><pre><code class=\"language-sql\">--æ­£å¼åº“\nCREATE SCHEMA `mall_master` DEFAULT CHARACTER SET utf8mb4 ;\n--å½±å­åº“\nCREATE SCHEMA `mall_shadow` DEFAULT CHARACTER SET utf8mb4 ;\n</code></pre><p>æ–°å»ºæˆåŠŸåå¦‚ä¸‹å›¾ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/fa/3d/faafe66d254a94a18936867c97d92a3d.png?wh=590x152\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œæ•°æ®åº“å°±å»ºå®Œäº†ï¼Œä½†æ˜¯å…‰æœ‰åº“æ²¡æœ‰è¡¨æ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¸¤ä¸ªæ–°çš„æ•°æ®åº“ä¸­æ–°å»ºä¸€æ ·çš„è¡¨ï¼Œå‚è€ƒè¯­å¥å¦‚ä¸‹ï¼š</p><pre><code class=\"language-sql\">DROP TABLE IF EXISTS `ums_admin`;\n\nCREATE TABLE `ums_admin` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `user_name` varchar(64) DEFAULT NULL COMMENT 'ç”¨æˆ·å',\n  `pass_word` varchar(64) DEFAULT NULL  COMMENT 'å¯†ç ',\n  `icon` varchar(500) DEFAULT NULL COMMENT ' Header åƒ',\n  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',\n  `nick_name` varchar(200) DEFAULT NULL COMMENT 'æ˜µç§°',\n  `note` varchar(500) DEFAULT NULL COMMENT 'å¤‡æ³¨ä¿¡æ¯',\n  `create_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',\n  `login_time` datetime DEFAULT NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',\n  `status` int(1) DEFAULT '1' COMMENT 'å¸å·å¯ç”¨çŠ¶æ€ï¼š0-&gt;ç¦ç”¨ï¼›1-&gt;å¯ç”¨',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='ç®¡ç†å‘˜ç”¨æˆ·è¡¨';\n</code></pre><p>æ‰“å¼€é¡¹ç›®ï¼Œåœ¨ resources ç›®å½•ä¸‹æ–°å»º application.ymlæ–‡ä»¶ï¼Œå› ä¸ºè¿™æ¬¡ demo çš„ç›®çš„æ˜¯è¦ä½¿ç”¨ä¸¤ä¸ªæ•°æ®æºåšæ•°æ®åº“éš”ç¦»ï¼Œæ‰€ä»¥è¦é…ç½®ä¸¤ä¸ªæ•°æ®æºã€‚ä½ å¯ä»¥å‚è€ƒæˆ‘ç»™ä½ æä¾›çš„ application.yml é…ç½®æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">spring:\n  datasource:\n    master: # æ•°æ®æº1\n      url: jdbc:mysql://localhost:3306/mall_master?characterEncoding=utf8&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=GMT%2B8\n      username: root\n      password: lw123root\n      driver-class-name: com.mysql.cj.jdbc.Driver\n      type: com.alibaba.druid.pool.DruidDataSource\n      druid:\n        initialSize: 5\n        minIdle: 5\n        maxActive: 20\n        maxWait: 60000\n        timeBetweenEvictionRunsMillis: 60000\n        minEvictableIdleTimeMillis: 300000\n        validationQuery: SELECT 1 FROM DUAL\n        testWhileIdle: true\n        testOnBorrow: false\n        testOnReturn: false\n        poolPreparedStatements: true\n        #   é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlæ— æ³•ç»Ÿè®¡ï¼Œ'wall'ç”¨äºé˜²ç«å¢™\n        filters: stat,wall,log4j\n        maxPoolPreparedStatementPerConnectionSize: 20\n        useGlobalDataSourceStat: true\n        connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500\n    shadow: # æ•°æ®æº2\n      url: jdbc:mysql://localhost:3306/mall_shadow?characterEncoding=utf8&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=GMT%2B8\n      username: root\n      password: lw123root\n      driver-class-name: com.mysql.cj.jdbc.Driver\n      type: com.alibaba.druid.pool.DruidDataSource\n      druid:\n        initialSize: 5\n        minIdle: 5\n        maxActive: 20\n        maxWait: 60000\n        timeBetweenEvictionRunsMillis: 60000\n        minEvictableIdleTimeMillis: 300000\n        validationQuery: SELECT 1 FROM DUAL\n        testWhileIdle: true\n        testOnBorrow: false\n        testOnReturn: false\n        poolPreparedStatements: true\n        #   é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlæ— æ³•ç»Ÿè®¡ï¼Œ'wall'ç”¨äºé˜²ç«å¢™\n        filters: stat,wall,log4j\n        maxPoolPreparedStatementPerConnectionSize: 20\n        useGlobalDataSourceStat: true\n        connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500\n</code></pre><p>æœ‰äº†æ•°æ®æºé…ç½®æ–‡ä»¶ï¼Œè¿˜éœ€è¦è¯»å–é…ç½®æ–‡ä»¶çš„é…ç½®ç±»ã€‚å¦‚æœæ˜¯å•åº“å®ä¾‹æ•°æ®æºï¼Œç”¨ä¸‹é¢çš„ä»£ç è¯»å–æ•°æ®æºé…ç½®ï¼Œé¡¹ç›®å°±å¯ä»¥ç›´æ¥æ“ä½œæ•°æ®åº“äº†ã€‚</p><pre><code class=\"language-java\"> @ConfigurationProperties(prefix = \"spring.datasource\")\n    @Bean\n    public DataSource druid() {\n        return new DruidDataSource();\n    }\n</code></pre><p>ä½†æ˜¯å¦‚æœæ˜¯å¤šåº“æ•°æ®æºï¼Œå°±ä¸èƒ½æŒ‰è¿™ä¸ªæ–¹å¼è¯»å–æ•°æ®æºäº†ã€‚é‚£ä¹ˆåº”è¯¥æ€ä¹ˆè¯»å–æ•°æ®æºå‘¢ï¼Ÿæˆ‘ä»¬æ¥ä»”ç»†çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ã€‚</p><p>SpringBoot åœ¨è¯»å–é…ç½®æ–‡ä»¶æ—¶ï¼Œå¤§é‡é‡‡ç”¨ @ConfigurationProperties æ³¨è§£ï¼Œä»ä»£ç ä¸­å¯ä»¥å¾—çŸ¥ï¼Œå•ä¸ªè¯»å–å®ä¾‹é‡‡ç”¨è¿™ä¸€æ³¨è§£å°±å¯ä»¥è¯»å–åˆ°æ•°æ®é…ç½®æ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŸ¥çœ‹æºç çŸ¥é“ï¼Œè¯¥æ³¨è§£å¸¦äº†ä¸€ä¸ª â€œprefix â€å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å±æ€§è¯»å–æ•°æ®æºã€‚å¦å¤–ï¼Œä¸ºäº†åŒºåˆ†æ•°æ®æºï¼Œå¯ä»¥ç»™ä¸åŒè¯»å–æ•°æ®æºå–ä¸åŒçš„æ–¹æ³•åå­—ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/63/ac/63d5c6e03485a782195925e5f7bf51ac.png?wh=708x402\" alt=\"å›¾ç‰‡\"></p><p>ä½ å¯ä»¥å‚è€ƒæˆ‘çš„ä»£ç ã€‚</p><pre><code class=\"language-java\">package com.dunshan.data.config;\n\nimport com.alibaba.druid.pool.DruidDataSource;\nimport com.alibaba.druid.support.http.StatViewServlet;\nimport com.alibaba.druid.support.http.WebStatFilter;\nimport lombok.extern.log4j.Log4j2;\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.boot.web.servlet.FilterRegistrationBean;\nimport org.springframework.boot.web.servlet.ServletRegistrationBean;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Primary;\nimport javax.sql.DataSource;\nimport java.util.HashMap;\nimport java.util.Map;\n\n/**\n * @author dunshan\n * @description: æ•°æ®åº“é…ç½®æ–‡ä»¶\n * @date 2021-08-15 11:01:31\n */\n \n@Log4j2\n@Configuration\npublic class DynamicDataSourceConfig {\n\n    /**\n     * åˆ›å»º shadow æ•°æ®æº\n     */\n    @Bean(name = \"shadowDataSource\")\n    @ConfigurationProperties(prefix = \"spring.datasource.shadow\")\n    public DataSource shadowDataSource() {\n        return new DruidDataSource();\n    }\n    \n    /**\n     * åˆ›å»º master æ•°æ®æº\n     */\n    @Bean(name = \"masterDataSource\")\n    @ConfigurationProperties(prefix = \"spring.datasource.master\")\n    public DataSource masterDataSource() {\n        return new DruidDataSource();\n    }\n    \n}\n</code></pre><p>æ•°æ®æºé…ç½®è¯»å–æˆåŠŸåï¼Œè¿˜å¾—å»æ€è€ƒæ€ä¹ˆæŠŠæ•°æ®æºæ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œåªæœ‰æˆåŠŸæ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­æ‰èƒ½ä½¿ç”¨è¯¥æ•°æ®ï¼Œæ“ä½œæ•°æ®åº“ä¸­çš„è¡¨ã€‚ä½†æ˜¯æ³¨å…¥æˆåŠŸåï¼Œè¦æ ¹æ®ä»€ä¹ˆåˆ‡æ¢æ•°æ®æºå‘¢ï¼Ÿ<br>\nåœ¨åˆ‡æ¢æ•°æ®æºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¹‹å‰åšçš„ demoã€‚æˆ‘ä»¬åš demo æ˜¯ä¸ºäº†è¯†åˆ«æµé‡æ ‡è®°ï¼Œé‚£æ€ä¹ˆäº§ç”Ÿæµé‡æ ‡è®°å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬åªéœ€è¦åœ¨ Http è¯·æ±‚ä¸­å¢åŠ  Header ä¿¡æ¯ï¼Œä¸šåŠ¡å±‚ä¼šæ ¹æ® Header ä¿¡æ¯åˆ¤æ–­ç‰¹å®šæ ‡è®°æ¥åˆ‡æ¢æ•°æ®æºï¼Œå¦‚ JMeter ä¸­ HTTP Header Manager å°±å¯ä»¥å¢åŠ  Header ä¿¡æ¯æ ‡è®°ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/59/a7/5932e537d1338b0a2c09010cfdbeb6a7.png?wh=1622x366\" alt=\"å›¾ç‰‡\"></p><h3>æ•°æ®æºä¸Šä¸‹æ–‡çš„å®ç°</h3><p>åœ¨ç›®å‰çš„ Spring å¼€å‘ä¸­ï¼Œå¤šå¤šå°‘å°‘éƒ½ä¼šæ¶‰åŠ AOPï¼ˆAspect-Oriented Programmingï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹)ï¼Œè¿™é‡Œåªç”¨å…¶ä¸­ä¸€ä¸ªç‰¹æ€§ï¼Œå¤§å®¶æ…¢æ…¢å¾€ä¸‹çœ‹å°±çŸ¥é“äº†ã€‚</p><p>å¦å¤–ï¼Œåœ¨åˆ‡æ¢æ•°æ®æºä¸­è¿˜éœ€è¦ä½¿ç”¨ä¸€ä¸ªæŠ€æœ¯å°±æ˜¯&nbsp;ThreadLocalã€‚ä½†æ˜¯å› ä¸º ThreadLocal æœ‰ç‚¹ç¼ºé™·ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªåœºæ™¯ä½¿ç”¨ TransmittableThreadLocal åšæ•°æ®æºä¿å­˜å¯¹è±¡ä¿¡æ¯ã€‚è¿™ä¸ªåœ¨ <a href=\"https://time.geekbang.org/column/article/444794\">ç¬¬13è®²</a>å·²ç»è®²å¾—å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘å°±ä¸å¤šèµ˜è¿°äº†ã€‚</p><p>åŠ¨æ€æ•°æ®æº TransmittableThreadLocal çš„ä»£ç å®ç°ï¼Œä½ å¯ä»¥çœ‹çœ‹æˆ‘ç»™å‡ºçš„ä¾‹å­ã€‚</p><pre><code class=\"language-java\">package com.dunshan.data.config;\n\nimport com.alibaba.ttl.TransmittableThreadLocal;\nimport org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;\nimport javax.sql.DataSource;\nimport java.util.Map;\n\n/**\n * @author dunshan\n * @description: åŠ¨æ€æ•°æ®æºåˆ‡æ¢\n * @date 2021-08-15 12:35:14\n */\npublic class DynamicDataSource extends AbstractRoutingDataSource {\n   \n     private static final TransmittableThreadLocal&lt;String&gt; contextHolder = new TransmittableThreadLocal&lt;&gt;();\n    \n    /**\n     * é…ç½®DataSource, defaultTargetDataSourceä¸ºä¸»æ•°æ®åº“\n     */\n    public DynamicDataSource(DataSource defaultTargetDataSource, Map&lt;Object, Object&gt; targetDataSources) {\n        super.setDefaultTargetDataSource(defaultTargetDataSource);\n        super.setTargetDataSources(targetDataSources);\n        super.afterPropertiesSet();\n    }\n    \n    @Override\n    protected Object determineCurrentLookupKey() {\n        return getDataSource();\n    }\n    \n    public static void setDataSource(String dataSource) {\n        contextHolder.set(dataSource);\n    }\n    \n    public static String getDataSource() {\n        return contextHolder.get();\n    }\n    \n    public static void clearDataSource() {\n        contextHolder.remove();\n    }\n}\n\n</code></pre><p>æ¥ä¸‹æ¥è¦æŠŠæ•°æ®æºæ³¨å…¥ä¸Šä¸‹æ–‡ä¸­ï¼Œåªæœ‰è¿™æ ·æ•°æ®æºæ‰èƒ½åœ¨ç³»ç»Ÿä¸­çµæ´»ä½¿ç”¨ã€‚</p><pre><code class=\"language-java\">    /**\n     * å¦‚æœè¿˜æœ‰æ•°æ®æº,åœ¨è¿™ç»§ç»­æ·»åŠ  DataSource Bean\n     */\n     \n    @Bean\n    @Primary\n    public DynamicDataSource dataSource(DataSource masterDataSource, DataSource shadowDataSource) {\n        Map&lt;Object, Object&gt; targetDataSources = new HashMap&lt;&gt;(2);\n      targetDataSources.put(DataSourceNames.SHADOW, shadowDataSource);\n      targetDataSources.put(DataSourceNames.MASTER, masterDataSource);\n        // è¿˜æœ‰æ•°æ®æº,åœ¨targetDataSourcesä¸­ç»§ç»­æ·»åŠ \n        log.info(\"DataSources:\" + targetDataSources);\n        return new DynamicDataSource(masterDataSource, targetDataSources);\n    }\n</code></pre><p>åšå¥½ä»¥ä¸Šè¿™äº›å‡†å¤‡å·¥ä½œåï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å®ç°å…·ä½“çš„æ ‡è®°è¯†åˆ«å’Œæ•°æ®åº“éš”ç¦»åŠ¨ä½œäº†ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸»è¦åšä»¥ä¸‹ä¸¤ç§è·å–æ ‡è®°æ–¹æ¡ˆçš„æŠ€æœ¯é¢„æ¼”ï¼š</p><ul>\n<li>HttpRequest Headerï¼šä» HttpRequest Header ä¸­è·å–æ ‡è®°ï¼Œé€‚åˆå•æœåŠ¡ã€å•ä¸€ HTTP åè®®çš„åœºæ™¯ï¼›</li>\n<li>æ•°æ®ä¸Šä¸‹æ–‡ï¼šä»æ•°æ®ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­è·å–æ ‡è®°ï¼Œ<strong>è¿™æ˜¯æ›´ä¸ºæ¨èçš„å¾®æœåŠ¡æ ‡è®°é€ä¼ æ–¹æ¡ˆ</strong>ã€‚</li>\n</ul><h3>ç¬¬ä¸€ç§ï¼šHttpRequest Header æ–¹æ¡ˆ</h3><p>ä¸»è¦é€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3d/a9/3d52080337e01b054be1aa3eb821dca9.jpg?wh=617x877\" alt=\"å›¾ç‰‡\"></p><p>æ•°æ®æºæ³¨å…¥ä¸Šä¸‹æ–‡åï¼Œåˆšæ‰æåˆ°çš„ AOP å°±æ´¾ä¸Šç”¨åœºäº†ã€‚è¿™é‡Œä½ éœ€è¦å…ˆå­¦ä¹  AOP åˆ‡é¢ç¼–ç¨‹ï¼Œä½¿ç”¨åˆ‡é¢ç¼–ç¨‹æ‹¦æˆªå¹¶è·å– Header ä¿¡æ¯ã€‚å†ç»“åˆ TransmittableThreadLocal çš„ç‰¹æ€§è¿›è¡Œæ•°æ®æºåˆ‡æ¢ã€‚</p><pre><code class=\"language-java\">package com.dunshan.data.config;\n\nimport lombok.extern.log4j.Log4j2;\nimport org.aspectj.lang.JoinPoint;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Before;\nimport org.aspectj.lang.annotation.Pointcut;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.context.request.RequestContextHolder;\nimport org.springframework.web.context.request.ServletRequestAttributes;\n\nimport javax.servlet.http.HttpServletRequest;\nimport java.util.Arrays;\n\n/**\n * @author dunshan\n * @description: æ•°æ®æºåˆ‡æ¢\n * @date 2021-08-15 12:46:32\n */\n \n@Log4j2\n@Aspect\n@Component\npublic class DataSourceAspect {\n\n\n\n    /**\n     * åˆ‡ç‚¹: æ‰€æœ‰é…ç½® DataSource æ³¨è§£çš„æ–¹æ³•\n     */\n    @Pointcut(\"execution(public * com.dunshan.data.controller..*.*(..))\")\n    public void controllerAspect() {\n    }\n\n    // è¯·æ±‚methodå‰æ‰“å°å†…å®¹\n    @Before(value = \"controllerAspect()\")\n    public void methodBefore(JoinPoint joinPoint) {\n        ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder\n                .getRequestAttributes();\n        HttpServletRequest request = requestAttributes.getRequest();\n       \n         //è·å– Header æ ‡è®°\n        String header = request.getHeader(\"dunshan\");\n        \n        // æ‰“å°è¯·æ±‚å†…å®¹\n        log.info(\"===============è¯·æ±‚å†…å®¹===============\");\n        log.info(\"è¯·æ±‚åœ°å€:\" + request.getRequestURL().toString());\n        log.info(\"è¯·æ±‚æ–¹å¼:\" + request.getMethod());\n        log.info(\"è¯·æ±‚ç±»æ–¹æ³•:\" + joinPoint.getSignature());\n        log.info(\"è¯·æ±‚ç±»æ–¹æ³•å‚æ•°:\" + Arrays.toString(joinPoint.getArgs()));\n        log.info(\"è¯·æ±‚ç±»æ–¹æ³• Header ä¿¡æ¯:\" + header);\n\n        // é€šè¿‡ Header ä¿¡æ¯åˆ¤æ–­\n        if (header != null &amp;&amp; header.equals(\"7DGroup\")) {\n              DynamicDataSource.setDataSource(DataSourceNames.SHADOW);\n        } else {\n              DynamicDataSource.setDataSource(DataSourceNames.MASTER);\n        }\n\n    }\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ ¹æ® Header ä¿¡æ¯ä¸­åŒ…å«çš„å…³é”®å­—â€œ7DGroupâ€åšæµé‡åˆ¤æ–­ã€‚<br>\nä¸Šé¢çš„æŠ€æœ¯é¢„æ¼”å·¥ä½œå·²ç»åŒ…å«äº†æ•´ä¸ª demo çš„å…³é”®éƒ¨åˆ†ï¼Œä¹‹åå°±è¦éªŒè¯ demo èƒ½ä¸èƒ½è¿è¡ŒæˆåŠŸäº†ã€‚å¦‚æœèƒ½æˆåŠŸï¼Œå°±å¯ä»¥ç§»æ¤åˆ°ç›®å‰çš„å·¥ç¨‹ä¸­å»äº†ã€‚</p><ul>\n<li>ç»“æœéªŒè¯</li>\n</ul><p>å¥½äº†ï¼Œæˆ‘ä»¬è¿™å°±æ¥éªŒè¯ä¸€ä¸‹ã€‚</p><p>å…ˆéªŒè¯æ•°æ®æºè¯»å–æ˜¯å¦æ­£å¸¸ï¼šå¯åŠ¨å·¥ç¨‹ï¼ŒæŸ¥çœ‹æ—¥å¿—ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/20/ed/20e48d67b4ac08a19a2964635174c4ed.png?wh=1320x711\" alt=\"å›¾ç‰‡\"></p><p>è§‚å¯Ÿå¯åŠ¨ä¿¡æ¯ï¼Œæ ‡ç¤ºä¸¤ä¸ªæ•°æ®æºå·²ç»è¯»å–æˆåŠŸã€‚å¥½ï¼Œæ¥ä¸‹æ¥å°±è¦éªŒè¯æ“ä½œèƒ½ä¸èƒ½æˆåŠŸäº†ã€‚</p><ul>\n<li>æ­£å¼è¯·æ±‚ï¼ˆæœªåŠ æ ‡è®°çš„è¯·æ±‚ï¼‰</li>\n</ul><p>ä¸Šé¢çš„ä»£ç å·²ç»ä¿®æ”¹å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬è¦æ¥éªŒè¯ä¸€ä¸‹æ˜¯å¦ä¿®æ”¹æˆåŠŸã€‚ç›®å‰æˆ‘ä»¬ä½¿ç”¨ JMeter åšéªŒè¯å·¥å…·ï¼Œåœ¨ JMeter ä¸­å¢åŠ æ’å…¥æ¥å£è¯·æ±‚ï¼Œå¹¶ä¸”å†™å…¥ä¸‹é¢æ•°æ®ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/7a/8c/7ac95dbc0d1ac174yye8d518fc373c8c.png?wh=1920x610\" alt=\"å›¾ç‰‡\"></p><p>åœ¨ body ä¸­çš„â€œæ˜µç§°â€ä¸­å†™å…¥â€œæ€§èƒ½æµ‹è¯•-æˆ‘æ˜¯æ­£å¸¸æµé‡â€ï¼Œè¯·æ±‚æˆåŠŸæ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/5e/f5/5ea87c5418d16448168bd861a968ccf5.png?wh=1404x570\" alt=\"å›¾ç‰‡\"></p><p>ä¸ºäº†éªŒè¯æ˜¯å¦æ’å…¥æˆåŠŸï¼Œéœ€è¦æ‰“å¼€ MySQL è¾“å…¥æŸ¥è¯¢è¯­å¥ã€‚åœ¨æŸ¥è¯¢å‰ï¼Œè¦å…ˆé€šè¿‡æ—¥å¿—åˆ¤æ–­å‡ºè¦ä½¿ç”¨å“ªä¸ªæ•°æ®åº“ï¼Œè¿™æ ·æ‰èƒ½æŸ¥åˆ°ç»“æœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/85/32/85cc2af8da0ef0yydb8d5d3befab1332.png?wh=1511x212\" alt=\"å›¾ç‰‡\"></p><p>ä¸Šé¢çš„æ—¥å¿—ä¸­ï¼Œ Header ä¿¡æ¯ä¸º nullï¼Œæ ¹æ®æ—©å…ˆçš„è®¾è®¡ï¼Œ Header ä¿¡æ¯ä¸º null ä¼šèµ° masterï¼ˆæ­£å¼åº“ï¼‰ æ•°æ®æº ï¼Œä¹Ÿå°±æ˜¯ mall_master åº“ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæ‰“å¼€æ•°æ®åº“å·¥å…·æ‰§è¡Œ SQLï¼ŒéªŒè¯æ•°æ®æ˜¯å¦å·²ç»æ’å…¥æˆåŠŸã€‚</p><pre><code class=\"language-sql\">SELECT * FROM mall_master.ums_admin;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/4d/15/4d36793754b8f2bfd2b9dd4c3f5f3f15.png?wh=1490x225\" alt=\"å›¾ç‰‡\"></p><p>ä»ç•Œé¢æˆªå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ˜¾ç¤ºçš„æ•°æ®ä¸å‹åŠ›å·¥å…·æ‰§è¡Œçš„æ•°æ®ä¸€è‡´ã€‚</p><ul>\n<li>å‹æµ‹è¯·æ±‚ï¼ˆåŠ æ ‡è®°çš„è¯·æ±‚ï¼‰</li>\n</ul><p>åœ¨ JMeter ä¸­å¢åŠ  HTTP Header Manager ç»„ä»¶ï¼Œå¹¶ä¸”åœ¨ Header ä¿¡æ¯å¢åŠ å¦‚ä¸‹æ ‡å¿—ï¼Œå†æ¬¡æ‰§è¡Œæ“ä½œï¼ŒéªŒè¯æ•°æ®æ˜¯å¦è¿›å…¥å‹æµ‹æ•°æ®åº“ã€‚å¦‚æœæˆåŠŸï¼Œè¯´æ˜ç›®å‰çš„ demo æ˜¯æœ‰æ•ˆçš„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/74/62/742584f24110d6025b50693b98d23d62.png?wh=1242x400\" alt=\"å›¾ç‰‡\"></p><p>æ‰“å¼€ JMeterï¼Œåœ¨ View Results Tree ä¸­æŸ¥çœ‹ç»“æœã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/85/a3/854be53a09b5b366596cf72da3d4d5a3.png?wh=1398x572\" alt=\"å›¾ç‰‡\"></p><p>åœ¨ SpringBoot å·¥ç¨‹ä¸­æŸ¥çœ‹è¯·æ±‚æ—¥å¿—ï¼ŒéªŒè¯æ˜¯å¦æˆåŠŸåˆ‡æ¢æ•°æ®æºï¼Œæ—¥å¿—æ˜¾ç¤ºç›®å‰çš„æ ‡è®°ä¸º 7DGroup ï¼Œå› è€Œåº”è¯¥èµ° shadowï¼ˆå½±å­åº“ï¼‰æ•°æ®æºï¼Œä¹Ÿå°±æ˜¯æ•°æ®æºä¸­çš„ mall_shadow åº“ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/yy/d1/yy268e668bbec292069312dc10b92ed1.png?wh=1502x247\" alt=\"å›¾ç‰‡\"></p><p>æ ¹æ®æ—¥å¿—æ˜¾ç¤ºçš„ä¿¡æ¯ï¼Œæ‰“å¼€ mall_shadow æ•°æ®åº“æ‰§è¡Œ SQL ï¼ŒéªŒè¯æ•°æ®æ˜¯å¦å·²ç»æ’å…¥è¯¥æ•°æ®åº“ã€‚</p><pre><code class=\"language-sql\">SELECT * FROM mall_shadow.ums_admin;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/f2/d8/f248b5bb921a22f8688aa18de1655dd8.png?wh=1500x211\" alt=\"å›¾ç‰‡\"></p><p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œç›®å‰çš„æ•°æ®å·²ç»è¿›å…¥é¢„æœŸçš„æ•°æ®åº“ï¼Œä¹Ÿè¾¾æˆäº† demo æŠ€æœ¯é¢„æ¼”ç›®æ ‡ã€‚ä¹‹å‰å·²ç»è¯´è¿‡ï¼Œåªè¦ demo èƒ½å®Œæˆæ•°æ®åº“åˆ‡æ¢ï¼Œå¹¶ä¸”æ•°æ®æ­£å¸¸ï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠç›®å‰çš„é…ç½®æ–‡ä»¶å’Œç›¸å…³ç±»ç§»æ¤åˆ°æ­£å¼ç³»ç»Ÿä¸­å»ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½ä½é£é™©å®Œæˆç³»ç»Ÿæ”¹é€ ã€‚</p><h3>ç¬¬äºŒç§ï¼šæ•°æ®ä¸Šä¸‹æ–‡æ–¹æ¡ˆ</h3><p>åœ¨ç¬¬ä¸€ç§æ–¹æ¡ˆä¸­ï¼Œæœ€å…³é”®çš„ä¸€ç‚¹æ˜¯è¦é€šè¿‡ AOP æ‹¦æˆªåˆ‡æ¢ï¼Œè€Œæˆ‘ä»¬ä¸‹é¢è¿™ä¸ªæ–¹æ¡ˆï¼Œåˆ™æ˜¯é€šè¿‡æ•°æ®ä¸Šä¸‹æ–‡åˆ‡æ¢è·å–å‹æµ‹æ ‡è®°å’Œ AOP åˆ‡æ¢æ•°æ®æºï¼Œå…¶å®ƒçš„å†…å®¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>åœ¨å¼€å§‹æ¼”ç¤ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ä¸Šä¸€è®²æåˆ°è¿‡çš„æ–¹æ¡ˆå›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/99/05/99ee4d4daa9fe5fe78d99c2d8fdc8105.jpg?wh=1920x1922\" alt=\"å›¾ç‰‡\"></p><p>è¿™é‡Œå®ç°çš„æ ¸å¿ƒé€»è¾‘å›¾å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/4e/bf/4e09a1ca5e528b306697eccc9f0eedbf.jpg?wh=1165x2065\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ä¸Šä¸€èŠ‚è¯¾æ­å»ºçš„ç¯å¢ƒï¼Œå¦‚æœå¿˜äº†è¿™ä¸ªç¯å¢ƒæ€ä¹ˆæ­ï¼Œä½ å¯ä»¥åˆ°ä¸Šä¸€è®²å¤ä¹ ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆï¼Œå¯åŠ¨é¡¹ç›®ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/38/e1/3818be42a830468aa5147b1bfbcee3e1.png?wh=300x98\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒNacos æ³¨å†Œä¸­å¿ƒæœ‰ç½‘å…³ã€ä¼šå‘˜ã€è´­ç‰©è½¦ã€è®¢å•æœåŠ¡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b9/ac/b9c1c74f093289ee0d0e5a8152d110ac.png?wh=1920x504\" alt=\"å›¾ç‰‡\"></p><p>åœ¨ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å·²ç»æŠŠæ ‡è®°ä¼ å…¥åˆ°äº†æ¯ä¸ªæœåŠ¡ä¸­ï¼ŒåŒæ—¶è¿˜å­˜å…¥äº†å¯¹åº”çš„æ•°æ®ä¸Šä¸‹æ–‡é‡Œï¼Œæ‰€ä»¥åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªè¦åœ¨ä¸šåŠ¡å±‚è·å–æ ‡è®°ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å‹æµ‹æ ‡è®°ï¼Œç„¶ååšå¯¹åº”çš„æ•°æ®æºåˆ‡æ¢åŠ¨ä½œå°±å¯ä»¥äº†ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬æ‰“å¼€ä¸Šä¸€èŠ‚è¯¾çš„é¡¹ç›®ï¼Œåœ¨è®¢å•æœåŠ¡ä¸­çš„ application.yml æ–‡ä»¶ä¸­æ·»åŠ åŒæ•°æ®åº“é“¾æ¥ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„é…ç½®ï¼š</p><pre><code class=\"language-yaml\">spring:\n  datasource:\n    master: # æ•°æ®æº1\n      username: root\n      password: dunshan123root\n      url: jdbc:mysql://localhost:3306/mall_master?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC&amp;queryInterceptors=brave.mysql8.TracingQueryInterceptor&amp;zipkinServiceName=mall_master\n      type: com.alibaba.druid.pool.DruidDataSource\n      druid:\n        initialSize: 5\n        minIdle: 5\n        maxActive: 20\n        maxWait: 60000\n        timeBetweenEvictionRunsMillis: 60000\n        minEvictableIdleTimeMillis: 300000\n        validationQuery: SELECT 1 FROM DUAL\n        testWhileIdle: true\n        testOnBorrow: false\n        testOnReturn: false\n        poolPreparedStatements: true\n        #   é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlæ— æ³•ç»Ÿè®¡ï¼Œ'wall'ç”¨äºé˜²ç«å¢™\n        filters: stat,wall,log4j\n        maxPoolPreparedStatementPerConnectionSize: 20\n        useGlobalDataSourceStat: true\n        connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500\n    shadow: # æ•°æ®æº2\n      url: jdbc:mysql://localhost:3306/mall_shadow?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC&amp;queryInterceptors=brave.mysql8.TracingQueryInterceptor&amp;zipkinServiceName=mall_shadow\n      username: root\n      password: dunshan123root\n      druid:\n        initial-size: 10 #è¿æ¥æ± åˆå§‹åŒ–å¤§å°\n        min-idle: 10 #æœ€å°ç©ºé—²è¿æ¥æ•°\n        max-active: 20 #æœ€å¤§è¿æ¥æ•°\n        web-stat-filter:\n          exclusions: \"*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*\" #ä¸ç»Ÿè®¡è¿™äº›è¯·æ±‚æ•°æ®\n        stat-view-servlet: #è®¿é—®ç›‘æ§ç½‘é¡µçš„ç™»å½•ç”¨æˆ·åå’Œå¯†ç \n          login-username: druid\n          login-password: druid\n</code></pre><p>æƒ³æƒ³ä¸ŠèŠ‚è¯¾æˆ‘ä»¬è®²çš„ï¼Œåº”è¯¥åœ¨ä»€ä¹ˆåœ°æ–¹è·å–å’Œè®¾ç½®æ ‡è®°ã€‚è¿™æ ·å¯ä»¥æ–¹ä¾¿ä¸‹ä¸€æ­¥æ“ä½œã€‚å…·ä½“æ“ä½œå¯ä»¥å‚è€ƒæˆ‘åœ¨æ–‡ç¨¿ä¸­ç»™å‡ºçš„æˆªå›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1f/55/1fc2d15d66b86e9d780f5a7f70b8d155.png?wh=1920x924\" alt=\"å›¾ç‰‡\"></p><p>ç®€å•è§£é‡Šä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå…¨å±€ Filter æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå…¨éƒ¨è¯·æ±‚ï¼Œé€šè¿‡ BaggageField.getByName(â€œdunshanâ€) è·å–é€ä¼ æ ‡è®°ï¼Œå†æŠŠæ ‡è®°æ”¾å…¥æ•°æ®ä¸Šä¸‹æ–‡ä¸­ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹æ•°æ®ä¸Šä¸‹æ–‡ç±»ï¼Œè¿™ä¸ªç±»çš„ä¸»è¦ç›®çš„æ˜¯æŠŠå‹æµ‹æ ‡è®°ä¿å­˜åˆ° TransmittableThreadLocal ä¸­å»ã€‚</p><pre><code class=\"language-java\">\n/**\n * @author dunshan\n * @description: æ•°æ®ä¸Šä¸‹æ–‡\n * @date 2021-11-18 23:12:10\n */\npublic class AppContext implements Serializable {\n    private static final TransmittableThreadLocal&lt;AppContext&gt; contextdunshan = new TransmittableThreadLocal&lt;&gt;();\n    private String flag;\n    public static AppContext getContext() {\n        return contextdunshan.get();\n    }\n    public static void setContext(AppContext context) {\n        contextdunshan.set(context);\n    }\n    public static void removeContext() {\n        contextdunshan.remove();\n    }\n    public String getFlag() {\n        return flag;\n    }\n    public void setFlag(String flag) {\n        this.flag = flag;\n    }\n}\n\n</code></pre><p>ä¸‹ä¸€æ­¥è¿˜æ˜¯ä½¿ç”¨ AOP åˆ¤æ–­è¯·æ±‚ï¼Œè¿™æ¬¡ï¼Œæˆ‘ä»¬é€šè¿‡æ•°æ®ä¸Šä¸‹æ–‡è·å–æ ‡è®°æ¥åˆ‡æ¢æ•°æ®æºé“¾æ¥ï¼Œä½ å¯ä»¥å‚è€ƒæˆ‘ç»™å‡ºçš„ä»£ç ï¼š</p><pre><code class=\"language-java\">@Log4j2\n@Component\n@Aspect\npublic class AopMyDbSwitch {\n    /**\n     * æ‹¦æˆªå…¥å£ä¸‹æ‰€æœ‰çš„ publicæ–¹æ³•\n     */\n    @Pointcut(\"execution(public * com.dunshan.order.controller..*(..))\")\n    public void pointCutAround() {\n    }\n    /**\n     *æ ¹æ®æ•°æ®ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°æ®æº\n     */\n    @Before(value = \"pointCutAround()\")\n    public void around(JoinPoint point) {\n        AppContext context = AppContext.getContext();\n        String flag = context.getFlag();\n        \n        if (StringUtils.isNotEmpty(flag) &amp;&amp; flag.equals(DataSourceNames.HEAD)) {\n            //å½±å­åº“\n            MDC.put(\"dunshan\", \"shadow\");\n            DynamicDataSource.setDataSource(DataSourceNames.SHADOW);\n        } else {\n            //æ­£å¼åº“\n            MDC.put(\"dunshan\", \"produce\");\n            DynamicDataSource.setDataSource(DataSourceNames.MASTER);\n        }\n    }\n}\n</code></pre><p><strong>æ³¨æ„ï¼šé™¤äº†åˆšæ‰æ‰€è®²çš„è¿™äº›ä¸ä¸€æ ·çš„åœ°æ–¹ä»¥å¤–ï¼Œå…¶ä»–é…ç½®ä¸ç¬¬ä¸€ç§æ–¹æ¡ˆéƒ½æ˜¯ä¸€æ ·çš„ã€‚</strong><br>\næœ‰ä¸Šé¢çš„é…ç½®åï¼Œæˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹æ•°æ®åº“è¡¨æ˜¯å¦åšäº†åŒºåˆ†ã€‚å…ˆçœ‹ mall_master ä¸­çš„ ums_adminè¡¨ï¼Œå†çœ‹ mall_shadow ä¸­çš„ ums_admin è¡¨ã€‚</p><p>mall_master æ•°æ®åº“ä¸­ ums_admin è¡¨æ˜¾ç¤ºä¸€æ¡å†…å®¹ä¸º masterï¼š</p><pre><code class=\"language-sql\">use mall_master;\nselect * from ums_admin;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/cc/75/cc57a1046256f398dda747ca31762475.png?wh=1600x360\" alt=\"å›¾ç‰‡\"></p><p>mall_shadow æ•°æ®åº“ä¸­çš„ ums_admin æ•°æ®æ˜¾ç¤ºæœ‰ä¸€æ¡è®°å½•åŒ…å« shadowï¼š</p><pre><code class=\"language-sql\">use mall_shadow;\nSELECT * FROM ums_admin;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/e3/46/e357e0000c110d16674bd31db2d08746.png?wh=1498x398\" alt=\"å›¾ç‰‡\"></p><p>æ•°æ®åº“åŒºåˆ†å®Œæ¯•åï¼Œæˆ‘ä»¬å†è®¾è®¡ä¸€ä¸ªè¯·æ±‚ï¼Œç”¨æ¥æ¨¡æ‹Ÿæ­£å¼æµé‡ä¸å‹æµ‹æµé‡æŸ¥è¯¢è¿™ä¸¤ä¸ªè¡¨ï¼Œåœ¨ä¼šå‘˜ç³»ç»Ÿä¸­å¢åŠ æŸ¥è¯¢è¯·æ±‚ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">/**\n * æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯\n *\n * @return\n */\n@GetMapping(\"/admin/info\")\npublic Object selectAdmin() {\n    return cartFeignClient.selectInfo();\n}\n</code></pre><p>é“¾è·¯è°ƒç”¨å…³ç³»ä¸ºç½‘å…³ -&gt; ç”¨æˆ·-&gt; è´­ç‰©è½¦ -&gt; è®¢å• -&gt; æ•°æ®åº“ã€‚<br>\nè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ JMeter æ¨¡æ‹Ÿå‹æµ‹æµé‡ä¸æ­£å¸¸æµé‡ï¼Œä½ å¯ä»¥å‚è€ƒæˆ‘ç»™å‡ºçš„è¯·æ±‚ä¿¡æ¯ã€‚</p><ul>\n<li>ä¸æ·»åŠ è¯·æ±‚ Header æ ‡è®°ï¼ˆæ­£å¼è¯·æ±‚ï¼‰</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/68/37/68a37aa327227c471d328d386eb40637.png?wh=1920x518\" alt=\"å›¾ç‰‡\"></p><ul>\n<li>æ·»åŠ è¯·æ±‚ Header æ ‡è®°ï¼ˆå‹æµ‹è¯·æ±‚ï¼‰</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/2c/95/2c03d9e1dac6bba26597aa65af01e295.png?wh=1920x396\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦éªŒè¯ç»“æœæ˜¯å¦è·Ÿé¢„æœŸæƒ³çš„ä¸€è‡´ã€‚ç‚¹å‡» JMeter è¯·æ±‚ï¼Œåœ¨å“åº”ç»“æœä¸­æŸ¥çœ‹ç»“æœã€‚</p><ul>\n<li>ä¸æ·»åŠ è¯·æ±‚ Header æ ‡è®°ï¼ˆæ­£å¼è¯·æ±‚ï¼‰</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/1e/ce/1e9512fdf1db5b43168ea9c3ceccfbce.png?wh=1134x572\" alt=\"å›¾ç‰‡\"></p><ul>\n<li>æ·»åŠ è¯·æ±‚ Header æ ‡è®°ï¼ˆå‹æµ‹è¯·æ±‚ï¼‰</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/55/a3/554656e57b399f4794da157e049b7aa3.png?wh=1244x670\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®å·²ç»æŒ‰é¢„æœŸæ˜¾ç¤ºå‡ºæ¥äº†ã€‚</p><p>æˆ‘ä»¬å†æ‰“å¼€ Zipkin è¿æ¥è·Ÿè¸ªï¼ŒéªŒè¯ä¸‹é“¾è·¯è¿½è¸ªç»“æœã€‚</p><ul>\n<li>ä¸æ·»åŠ è¯·æ±‚ Header æ ‡è®°ï¼ˆæ­£å¼åº“ï¼‰</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/64/e2/648f9be5f21048e2ba920516973797e2.png?wh=1920x438\" alt=\"å›¾ç‰‡\"></p><ul>\n<li>æ·»åŠ è¯·æ±‚ Header æ ‡è®°ï¼ˆå½±å­åº“ï¼‰</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/74/3a/7427433a234112c83453212cdc59123a.png?wh=1920x481\" alt=\"å›¾ç‰‡\"></p><p>Zipkin é“¾è·¯å…¨è²Œå›¾ä¸ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/6b/f4/6bd3dca5622bd201b0505424470364f4.png?wh=1920x434\" alt=\"å›¾ç‰‡\"></p><p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œç›®å‰çš„æ•°æ®å·²ç»è¿›å…¥åˆ°äº†é¢„æœŸçš„æ•°æ®åº“ä¸­ï¼Œä¹Ÿè¾¾æˆäº†é€šè¿‡è·å–æ•°æ®ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°æ®åº“æŠ€æœ¯é¢„æ¼”çš„ç›®æ ‡ã€‚ä¹‹å‰å·²ç»è¯´è¿‡äº†ï¼Œåªè¦ demo èƒ½å®Œæˆæ•°æ®åº“åˆ‡æ¢ï¼Œå¹¶ä¸”æ•°æ®æ­£å¸¸ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠç›®å‰çš„é…ç½®æ–‡ä»¶å’Œç›¸å…³ç±»ç§»æ¤åˆ°æ­£å¼ç³»ç»Ÿä¸­å»äº†ã€‚</p><h2>ç³»ç»Ÿæ”¹é€ </h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹çœŸå®ç³»ç»Ÿçš„æ”¹é€ ã€‚</p><p>é¦–å…ˆå¯¹ mall-memberï¼ˆä¼šå‘˜ç³»ç»Ÿï¼‰è¿›è¡Œæ”¹é€ ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¿«é€ŸæŠŠ demo çš„ç±»ä¸é…ç½®ç§»æ¤åˆ°å¯¹åº”å·¥ç¨‹ä¸­å»ã€‚</p><h3>æ·»åŠ å…¨å±€ Filter è¿‡æ»¤å™¨</h3><p>å› ä¸ºæˆ‘ä»¬ä¸Šä¸€è®²å·²ç»æ¼”ç¤ºè¿‡åœ¨å…¨å±€ Filter ä¸­æŠŠæ ‡è®°åŠ å…¥åˆ°æ•°æ®ä¸Šä¸‹æ–‡ä¸­çš„é€»è¾‘ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ”¹é€ å°±æ¯”è¾ƒè½»æ¾äº†ã€‚æˆ‘ä»¬å¯ä»¥å¿«é€Ÿåœ¨æœåŠ¡ä¸­æ·»åŠ å…¨å±€ Filte è¿‡æ»¤å™¨ ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9a/4b/9ab23782cb816823a2989f732254764b.png?wh=1274x1184\" alt=\"å›¾ç‰‡\"></p><h3>é…ç½® AOP åˆ‡é¢</h3><p>ç„¶åï¼Œåœ¨ AOP ç±»ä¸­ä¿®æ”¹ Pointcut ç±»ä¸­çš„æ³¨è§£ã€‚éœ€è¦æ³¨æ„ä¿®æ”¹ä¸­é—´çš„æ–‡æœ¬æ¡†ï¼Œå…¶å®ƒåœ°æ–¹ä¸ demo ä¸­ä¿æŒä¸€è‡´å³å¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/38/c9/3870db5171b3726536e4477e03143ec9.png?wh=1400x266\" alt=\"å›¾ç‰‡\"></p><p>å…·ä½“çš„ä»£ç ä½ å¯ä»¥å‚è€ƒæˆ‘ç»™å‡ºçš„å›¾ç‰‡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6e/2d/6e2fa4716ebca9507edd64e6f9d70e2d.png?wh=1486x1682\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬é€šè¿‡ AOP æ‹¦æˆªæœåŠ¡è¯·æ±‚ï¼Œå®æ—¶åˆ¤æ–­æ•°æ®ä¸Šä¸‹æ–‡çš„æ ‡è®°ç±»å‹ï¼Œå¹¶å­˜å…¥è®¾ç½®å¯¹åº”çš„æ•°æ®æºä¸Šä¸‹æ–‡ã€‚</p><h3>é…ç½®å¤šæ•°æ®æº</h3><p>AOP é…ç½®ç±»æ›¿æ¢æˆåŠŸåï¼Œå†æŠŠ application.yml æ–‡ä»¶ä¿®æ”¹æˆå¤šæ•°æ®æºï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½å®ç°æ•°æ®æºåˆ‡æ¢ã€‚å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/19/0b/19c6a67f0db592d6bb434336f404ee0b.png?wh=1920x1015\" alt=\"å›¾ç‰‡\"></p><p>æ”¹é€ å®Œæˆåï¼Œæˆ‘ä»¬å¯åŠ¨å·¥ç¨‹ï¼ŒéªŒè¯æ•°æ®åº“æ˜¯å¦æˆåŠŸã€‚å› ä¸ºè¿™ä¸ªå·¥ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯åŠ¨ç½‘å…³æœåŠ¡å’Œè®¤è¯æœåŠ¡ï¼Œå¯åŠ¨çš„æ•°æ®åº“å¯åŠ¨æ—¥å¿—å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/2c/34/2c9d888af95a3a8d02b2d0659ff7c734.png?wh=1160x459\" alt=\"å›¾ç‰‡\"></p><p>å¯åŠ¨ç³»ç»Ÿå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/f2/03/f2d3f60cc9496204aec733878ea3a903.png?wh=801x255\" alt=\"å›¾ç‰‡\"></p><h3>éªŒè¯æ”¹é€ ç»“æœ</h3><p>æ‰“å¼€æ¥å£æ–‡æ¡£ï¼Œåœ¨ JMeter ä¸­æ¨¡æ‹Ÿæ³¨å†Œç”¨æˆ·æ¥å£ï¼Œå…³äºæ³¨å†Œæ¥å£æ€ä¹ˆå¼€å‘ï¼Œä½ å¯ä»¥å‚è€ƒã€Š<a href=\"https://mp.weixin.qq.com/s/KHGfK7DUbSBcNOF6J8mb6Q\">é«˜æ¥¼çš„æ€§èƒ½å·¥ç¨‹å®æˆ˜è¯¾ä¹‹è„šæœ¬å¼€å‘</a>ã€‹ï¼ŒéªŒè¯ mall-member ï¼ˆä¼šå‘˜ç³»ç»Ÿï¼‰æ•°æ®æºæ˜¯å¦åˆ‡æ¢æˆåŠŸã€‚</p><ul>\n<li>å‹æµ‹è¯·æ±‚ï¼ˆå¸¦ Header æ ‡è®°ï¼‰</li>\n</ul><p>è„šæœ¬ç¼–å†™æˆåŠŸåï¼Œæ‰§è¡Œæ³¨å†Œæµç¨‹ï¼Œæ‰§è¡ŒæˆåŠŸåæ‰“å¼€å·¥ç¨‹æŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/ed/16/ed791084acb7b389a0f9f93f5a6e5116.png?wh=1500x366\" alt=\"å›¾ç‰‡\"></p><p>åœ¨æˆ‘ç»™å‡ºçš„æ—¥å¿—æˆªå›¾ä¸­ï¼Œ7dTest005 æ˜¯æ–°æ³¨å†Œçš„ç”¨æˆ·åã€‚7DGroup æ˜¯ HTTP Header æ ‡è®°ï¼Œè¿™æ˜¯å‹æµ‹æ ‡è®°ï¼Œå¸¦æœ‰å®ƒçš„æ•°æ®éƒ½è¦è¿›å…¥ shadowï¼ˆå½±å­ï¼‰æ•°æ®åº“ã€‚</p><p>æ ¹æ®æç¤ºä¸é…ç½®ä¿¡æ¯ï¼Œå†åˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®æ˜¯å¦æ³¨å†ŒæˆåŠŸï¼Œä»”ç»†è§‚å¯Ÿç›®å‰çš„ç”¨æˆ·åä¸º7dTest005ã€‚æ‰§è¡Œ SQL è¯­å¥ä¹‹å‰ï¼Œå…ˆåˆ†æä¸‹ç›®å‰æ‰§è¡Œçš„æ•°æ®åº“æ˜¯å“ªä¸ªï¼Ÿ</p><p>ä¸Šé¢çš„æ—¥å¿—ä¿¡æ¯æç¤ºçš„æ˜¯å‹æµ‹æµé‡æ ‡è®°ï¼Œæ‰¾åˆ°æ•°æ®æºä¸º shadowï¼Œæ‰§è¡Œç”¨æˆ·å SQL è¯­å¥ã€‚æ£€æŸ¥ä¸€ä¸‹æ—¥å¿—ä¸­ç”¨æˆ· 7dTest005 æ˜¯å¦å·²ç»æ³¨å†ŒæˆåŠŸã€‚</p><pre><code class=\"language-sql\">select * from shadow.ums_member;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/6b/c5/6bd630049yydcdb64ba3d52109cd92c5.png?wh=1334x584\" alt=\"å›¾ç‰‡\"></p><p>åˆšæ‰è®²çš„æ˜¯å¸¦ Header æ ‡è®°éªŒè¯ï¼Œæˆ‘ä»¬æ ¹æ® SQL æŸ¥è¯¢ç»“æœçŸ¥é“å·²ç»æ³¨å†ŒæˆåŠŸäº†ã€‚è¿™è¯´æ˜æµé‡å¸¦å‹æµ‹æ ‡è®°è¿›å…¥äº†å½±å­åº“ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥éªŒè¯ä¸å¸¦æ ‡è®°æ˜¯å¦ä¹Ÿä¼šæ­£å¸¸è¿›å…¥æ­£å¼åº“ã€‚</p><ul>\n<li>æ­£å¸¸è¯·æ±‚ï¼ˆæ—  Header æ ‡è®°ï¼‰</li>\n</ul><p>æˆ‘ä»¬æŠŠæ³¨å†Œè„šæœ¬ä¸­çš„ Header æ ‡è®°å»æ‰ï¼Œä¿®æ”¹ç”¨æˆ·åæ‰§è¡Œè„šæœ¬è¯·æ±‚ï¼ŒæˆåŠŸåæŸ¥çœ‹å·¥ç¨‹æ—¥å¿—ã€‚å¦‚æœæ²¡æœ‰Header æ ‡è®°ä¹Ÿèƒ½æˆåŠŸæ³¨å†Œè„šæœ¬ï¼Œè¡¨ç¤º mall-member ç³»ç»Ÿæ”¹é€ æˆåŠŸã€‚</p><p>æ‰§è¡ŒæˆåŠŸåæŸ¥çœ‹æ—¥å¿—ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3d/76/3dbf27fd57f57c99e4b3fafb6af71a76.png?wh=1500x362\" alt=\"å›¾ç‰‡\"></p><p>ä»æˆ‘ç»™å‡ºçš„æ—¥å¿—æˆªå›¾å¯ä»¥çœ‹å‡ºï¼Œç›®å‰æµé‡æ­£å¸¸ï¼Œè€Œä¸”æ³¨å†Œçš„ç”¨æˆ·åæ˜¯ 7dTest1188ï¼Œæ ¹æ®ä»£ç å¯çŸ¥ç›®å‰èµ°çš„æ•°æ®æºæ˜¯ masterï¼ˆæ­£å¼åº“ï¼‰ã€‚æ‰§è¡Œç”¨æˆ· SQLï¼ŒéªŒè¯æ•°æ®æ˜¯å¦å·²ç»èµ°å…¥ master æ•°æ®åº“ï¼Œ</p><p>ä»ä¸‹å›¾æ‰§è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œç›®å‰æ•°æ®å·²ç»æ’å…¥é¢„æœŸçš„æ•°æ®åº“ä¸­ã€‚</p><pre><code class=\"language-sql\">select * from master.ums_member;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/13/10/1316923170f0fda99cc1e5e9e267e410.png?wh=1495x592\" alt=\"å›¾ç‰‡\"></p><p>å®Œæˆäº†ä¸Šè¿°ä¸€ç³»åˆ—æ“ä½œåï¼Œå¯¹ mall-member ï¼ˆä¼šå‘˜ç³»ç»Ÿï¼‰çš„æ”¹é€ å°±å®Œæˆäº†ã€‚æœ‰äº†æˆåŠŸæ”¹é€  mall-member å½±å­åº“çš„ç»éªŒï¼Œæˆ‘ä»¬å°±å¯ä»¥æ²¿ç”¨è¿™ç§æ–¹æ³•è½åœ°æ”¹é€ åˆ°å…¶ä»–ç³»ç»Ÿä¸­å»äº†ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œæˆ‘ä»¬ä»Šå¤©å°±è®²åˆ°è¿™é‡Œäº†ã€‚åœ¨è¯¾ç¨‹çš„æœ€åï¼Œæˆ‘å†å¸¦ä½ å›é¡¾ä¸€ä¸‹è¯¾ç¨‹å†…å®¹ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸»è¦è®²äº†è½åœ° MySQL æ•°æ®åº“éš”ç¦»çš„æ–¹æ³•ã€‚</p><p>è¿™é‡Œæœ‰å‡ ä¸ªè¦ç‚¹å¸Œæœ›ä½ èƒ½è®°ä½ï¼š</p><ol>\n<li>\n<p>å¤šæ•°æ®æºæ˜¯å®ç°å½±å­åº“çš„åŸºç¡€ï¼›</p>\n</li>\n<li>\n<p>ä»æ•°æ®ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­è·å–æ ‡è®°ï¼Œè¿™æ˜¯æ›´ä¸ºæ¨èçš„å¾®æœåŠ¡æ ‡è®°é€ä¼ æ–¹æ¡ˆï¼›</p>\n</li>\n<li>\n<p>AOP ç»“åˆ TransmittableThreadLocal æ˜¯å®ç°æ•°æ®æºåŠ¨æ€åˆ‡æ¢çš„å¥½ç»„åˆï¼›</p>\n</li>\n<li>\n<p>ä»é£é™©ç®¡æ§çš„è§’åº¦ï¼Œæˆ‘å»ºè®®ä½ å…ˆåš demo æŠ€æœ¯é¢„æ¼”ï¼Œå†åšå•ä¸ªç³»ç»Ÿæ”¹é€ ï¼Œæœ€åå†åŒæ­¥å…¶ä½™ç³»ç»Ÿã€‚</p>\n</li>\n</ol><p>å¯ä»¥è¯´ï¼Œåœ¨å…¨é“¾è·¯å‹æµ‹ä¸­ï¼Œ<strong>æ•°æ®åº“éš”ç¦»æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªæ”¹é€ ç¯èŠ‚äº†</strong>ã€‚å› ä¸ºåšå¾—ä¸åˆ°ä½ï¼Œå‹æµ‹æµé‡å°±ä¼šæ±¡æŸ“ç”Ÿäº§æ•°æ®ï¼Œå¯¼è‡´çš„åæœéå¸¸ä¸¥é‡ã€‚è¿™èŠ‚è¯¾ç»™å‡ºçš„å½±å­åº“æ–¹æ¡ˆï¼Œæ˜¯æ”¹é€ æˆæœ¬ä½ï¼Œæ•ˆæœæœ€å¥½çš„ä¸€ç§æ–¹å¼ã€‚å¸Œæœ›ä½ èƒ½å¤Ÿå……åˆ†åœ°ç†è§£å¹¶ç”¨å¥½å®ƒã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œæˆ‘æƒ³è¯·ä½ æ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š</p><ol>\n<li>\n<p>ä¸ºä»€ä¹ˆè¯´æ•°æ®åº“éš”ç¦»æ˜¯å…¨é“¾è·¯å‹æµ‹ä¸­æ”¹é€ çš„æ ¸å¿ƒç¯èŠ‚ï¼Ÿ</p>\n</li>\n<li>\n<p>é™¤äº†æˆ‘åˆ—å‡ºçš„è¿™ä¸‰ç§ï¼Œä½ è¿˜æœ‰æ²¡æœ‰å…¶ä»–æ–¹å¼å¯ä»¥å®ç°æ•°æ®åº“éš”ç¦»ï¼Ÿ</p>\n</li>\n</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘äº¤æµè®¨è®ºã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œæˆ–è®¸å¯ä»¥ç¢°æ’å‡ºæ›´å¤šæ–°çš„æƒ³æ³•ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"14 | æ ‡è®°é€ä¼ ï¼šå¦‚ä½•åŸºäºå¾®æœåŠ¡æŠ€æœ¯è¿›è¡Œæ ‡è®°é€ä¼ ï¼Ÿ","id":446320},"right":{"article_title":"16 | æµé‡éš”ç¦»ï¼šRedis ç¼“å­˜éš”ç¦»æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ","id":448848}},"comments":[{"had_liked":false,"id":341192,"user_name":"Geek_e5142c","can_delete":false,"product_type":"c1","uid":1702111,"ip_address":"","ucode":"86C834E238DDED","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLVZRHorm7z6zn6KVDAbelR0tiby4UfuxCmpUjNTiaN1NHEcrGJ2wrRiaypam832kskRThiac90Aibr7ew/132","comment_is_top":false,"comment_ctime":1649411875,"is_pvip":false,"replies":[{"id":"124904","content":"å†™å†™è¯•è¯•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1785562","ctime":1649913927,"ip_address":"","comment_id":341192,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1649411875","product_id":100093001,"comment_content":"å½±å­è¡¨ä¹Ÿå¯ä»¥åšæ•°æ®éš”ç¦»<br>1ï¼Œmybatis æ‹¦æˆªå™¨ Interceptor ï¼Œè§£æsql ï¼ŒæŠŠè¡¨éƒ½æ”¹æˆå¸¦å‰ç¼€çš„å½±å­è¡¨( æˆ‘æ²¡å®è·µè¿‡ğŸ˜„)<br>","like_count":0,"discussions":[{"author":{"id":1785562,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/3e/da/e686a72b.jpg","nickname":"é«˜æ¥¼(Zee)","note":"","ucode":"149202404A5ABC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562947,"discussion_content":"å†™å†™è¯•è¯•ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649913927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341191,"user_name":"Geek_e5142c","can_delete":false,"product_type":"c1","uid":1702111,"ip_address":"","ucode":"86C834E238DDED","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLVZRHorm7z6zn6KVDAbelR0tiby4UfuxCmpUjNTiaN1NHEcrGJ2wrRiaypam832kskRThiac90Aibr7ew/132","comment_is_top":false,"comment_ctime":1649411605,"is_pvip":false,"replies":[{"id":"124905","content":"çœ‹æ¥æ˜¯è®¤çœŸå­¦ä¹ äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1785562","ctime":1649913950,"ip_address":"","comment_id":341191,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1649411605","product_id":100093001,"comment_content":"1. ä¸ºä»€ä¹ˆè¯´æ•°æ®åº“éš”ç¦»æ˜¯å…¨é“¾è·¯å‹æµ‹ä¸­æ”¹é€ çš„æ ¸å¿ƒç¯èŠ‚ï¼Ÿ<br>   å› ä¸ºæ•°æ®åº“ä¸€èˆ¬æ˜¯æ•°æ®çš„æœ€ç»ˆè½è„šç‚¹<br>2. AbstractRoutingDataSource +DataSourceAspect è¿™ç§æ–¹å¼é‡åˆ°äº‹åŠ¡å°±ä¸è¡Œäº†ï¼Œéœ€è¦é‡å†™äº‹åŠ¡ç®¡ç†å™¨DataSourceTransactionManager<br>   è¿™é‡Œ","like_count":0,"discussions":[{"author":{"id":1785562,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/3e/da/e686a72b.jpg","nickname":"é«˜æ¥¼(Zee)","note":"","ucode":"149202404A5ABC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562948,"discussion_content":"çœ‹æ¥æ˜¯è®¤çœŸå­¦ä¹ äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649913950,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326559,"user_name":"å†’å†’","can_delete":false,"product_type":"c1","uid":2666416,"ip_address":"","ucode":"5DB92E076ED511","user_header":"https://static001.geekbang.org/account/avatar/00/28/af/b0/a05c5dda.jpg","comment_is_top":false,"comment_ctime":1639561751,"is_pvip":false,"replies":[{"id":"118685","content":"æˆ‘ä»¬ç”¨çš„å°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå“‡ã€‚ æ‰€æœ‰è¿™é‡Œé¢ç”¨çš„æŠ€æœ¯éƒ½æ˜¯åœ¨åˆ†å¸ƒå¼çš„åŸºç¡€ä¸Šçš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1785562","ctime":1639630583,"ip_address":"","comment_id":326559,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639561751","product_id":100093001,"comment_content":"é«˜è€å¸ˆï¼Œèƒ½æ¥ä¸€äº›åˆ†å¸ƒå¼ç³»ç»Ÿçš„åˆ†ææ¡ˆä¾‹ä¹ˆ","like_count":0,"discussions":[{"author":{"id":1785562,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/3e/da/e686a72b.jpg","nickname":"é«˜æ¥¼(Zee)","note":"","ucode":"149202404A5ABC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539171,"discussion_content":"æˆ‘ä»¬ç”¨çš„å°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå“‡ã€‚ æ‰€æœ‰è¿™é‡Œé¢ç”¨çš„æŠ€æœ¯éƒ½æ˜¯åœ¨åˆ†å¸ƒå¼çš„åŸºç¡€ä¸Šçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639630583,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326358,"user_name":"é»‘å±±è€å¦–","can_delete":false,"product_type":"c1","uid":1115958,"ip_address":"","ucode":"A1659F99C5BE1E","user_header":"https://static001.geekbang.org/account/avatar/00/11/07/36/d677e741.jpg","comment_is_top":false,"comment_ctime":1639482171,"is_pvip":false,"replies":[{"id":"118613","content":"ç¯å¢ƒæ­å»ºé‚£ç¯‡æ˜¯æœ‰çš„ã€‚æ–¹æ¡ˆé‚£ç¯‡ä¹Ÿæ˜¯æœ‰çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1785562","ctime":1639567154,"ip_address":"","comment_id":326358,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639482171","product_id":100093001,"comment_content":"è®²çš„éå¸¸å¥½ï¼Œå®ä¾‹ä»£ç åœ¨å“ªé‡Œå¯ä»¥è·å¾—ã€‚","like_count":0,"discussions":[{"author":{"id":1785562,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/3e/da/e686a72b.jpg","nickname":"é«˜æ¥¼(Zee)","note":"","ucode":"149202404A5ABC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538971,"discussion_content":"ç¯å¢ƒæ­å»ºé‚£ç¯‡æ˜¯æœ‰çš„ã€‚æ–¹æ¡ˆé‚£ç¯‡ä¹Ÿæ˜¯æœ‰çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639567154,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}