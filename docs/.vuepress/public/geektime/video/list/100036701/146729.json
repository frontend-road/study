{"id":146729,"title":"05 | 为什么孤注一掷：独选Netty？","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":148656,"user_name":"Zer01ne","can_delete":false,"product_type":"c3","uid":1661564,"ip_address":"","ucode":"71ED3A6DD5AB8A","user_header":"https://static001.geekbang.org/account/avatar/00/19/5a/7c/990cf251.jpg","comment_is_top":false,"comment_ctime":1573045275,"is_pvip":false,"replies":[{"id":57858,"content":"不好意思回复迟了，最近一直忙录课，没来得及好好给您回复，我把你这个问题单独记录下来，以后做个netty 100问什么的到时候再集中发您，这里我先把我的理解总结下贴给您：\n这个问题其实不是 Netty 专属问题，类似问题：一个服务器或者客户端能创建多少连接，以 linux 为例：\n\n一个连接是由：客户端【IP + PORT】+ 服务器 【IP（固定的） + PORT（固定的）】 四个元素决定的，所以支持多少，要从两个角度分析：\n\n（1）对于单个客户端（IP地址固定）而言：\n    理论值：单个客户端连接到一个服务器最多连接数取决于本地可用端口数（因为其他3个元素固定了）： 65535（报文中端口占用字节数是16，所以最大端口数65535）- 1024(保留端口，不给用) 约 64K。\n    实际值：取决于以下三个方面：\n            1）TCP层：ip_local_port_range (参考&#47;proc&#47;sys&#47;net&#47;ipv4&#47;ip_local_port_range)，可调整，最大65535-1024\n            2）系统限制：最大文件句柄数（参考&#47;etc&#47;security&#47;limits.conf），可调整，最大21亿\n            3）资源限制：内存等资源有限，例如连接本身占用资源，Netty本身的socket相关的对象也占用jvm，需要根据机器做测试。\n\n（2）对于服务器而言：\n    理论值： 最大连接数 = 客户端数量（IP地址数量） * 单个客户端的最多连接数（约64K），不考虑资源限制，最多21亿，实际以资源限制为准, 100万连接就要占用3G以上了。\n    实际值： 受限于三个方面：\n            1）TCP层： IPv4使用32位（4字节）地址，因此地址空间中只有4,294,967,296（约43亿），所以乘以单个客户端最大64K, 数量惊人。\n            1）系统限制：同上，最大21亿\n            2）资源限制：同上\n\n总结：\n（1）对于客户端，6万多点，对于服务器，100万到1000万，再多，内存就要30G以上了，所以网上经常说百万连接。当然，如果你机器内存1G不到的话，那也搞不了了。\n（2）单纯看连接多少意义不是很大，因为连接是为了做事情，光能连上很多，但是占用资源过大导致基本已经不能动弹的话，意义就不大了，不过这个问题本身有趣。\n\n扩展：\n（1）查看ip_local_port_range方法：\n    [root@netty ~]# cat &#47;proc&#47;sys&#47;net&#47;ipv4&#47;ip_local_port_range\n    16384\t61000   \n\n（2）服务器支持1200万连接的案例：\n    https:&#47;&#47;mrotaru.wordpress.com&#47;2013&#47;06&#47;20&#47;12-million-concurrent-connections-with-migratorydata-websocket-server&#47;\n (3) 最大文件句柄数的最大值受另外一个参数控制：\n        [root@netty ~]# cat &#47;proc&#47;sys&#47;fs&#47;nr_open\n            1048576\n    设置超过的话：\n        [root@netty ~]# ulimit -Hn 9000000\n    -       bash: ulimit: open files: cannot modify limit: Operation not permitted\n    所以如果想改的更大，这需要修改这个参数（默认百万：1048576（1024 * 1024））：\n        sysctl -w fs.nr_open=100000000\n    那这参数最大值，可以到多少呢？2147483584 （即7FFFFFC0，也就是在MAXINT（2147483647）基础上按64字节对齐）\n（4）linux系统下，一个socket连接一般占用3K,所以100万连接至少需要3G，而1000万就要30G了，所以可以看下（2）引用连接文章里的内存大小，很大。\n\n格式有点乱，先将就看看，等课程结束，我排版好，做个小册子发你们。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573548476,"ip_address":"","comment_id":148656,"utype":1}],"discussion_count":6,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，一般的netty服务端能支持多少长连接？","like_count":75,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473567,"discussion_content":"不好意思回复迟了，最近一直忙录课，没来得及好好给您回复，我把你这个问题单独记录下来，以后做个netty 100问什么的到时候再集中发您，这里我先把我的理解总结下贴给您：\n这个问题其实不是 Netty 专属问题，类似问题：一个服务器或者客户端能创建多少连接，以 linux 为例：\n\n一个连接是由：客户端【IP + PORT】+ 服务器 【IP（固定的） + PORT（固定的）】 四个元素决定的，所以支持多少，要从两个角度分析：\n\n（1）对于单个客户端（IP地址固定）而言：\n    理论值：单个客户端连接到一个服务器最多连接数取决于本地可用端口数（因为其他3个元素固定了）： 65535（报文中端口占用字节数是16，所以最大端口数65535）- 1024(保留端口，不给用) 约 64K。\n    实际值：取决于以下三个方面：\n            1）TCP层：ip_local_port_range (参考/proc/sys/net/ipv4/ip_local_port_range)，可调整，最大65535-1024\n            2）系统限制：最大文件句柄数（参考/etc/security/limits.conf），可调整，最大21亿\n            3）资源限制：内存等资源有限，例如连接本身占用资源，Netty本身的socket相关的对象也占用jvm，需要根据机器做测试。\n\n（2）对于服务器而言：\n    理论值： 最大连接数 = 客户端数量（IP地址数量） * 单个客户端的最多连接数（约64K），不考虑资源限制，最多21亿，实际以资源限制为准, 100万连接就要占用3G以上了。\n    实际值： 受限于三个方面：\n            1）TCP层： IPv4使用32位（4字节）地址，因此地址空间中只有4,294,967,296（约43亿），所以乘以单个客户端最大64K, 数量惊人。\n            1）系统限制：同上，最大21亿\n            2）资源限制：同上\n\n总结：\n（1）对于客户端，6万多点，对于服务器，100万到1000万，再多，内存就要30G以上了，所以网上经常说百万连接。当然，如果你机器内存1G不到的话，那也搞不了了。\n（2）单纯看连接多少意义不是很大，因为连接是为了做事情，光能连上很多，但是占用资源过大导致基本已经不能动弹的话，意义就不大了，不过这个问题本身有趣。\n\n扩展：\n（1）查看ip_local_port_range方法：\n    [root@netty ~]# cat /proc/sys/net/ipv4/ip_local_port_range\n    16384\t61000   \n\n（2）服务器支持1200万连接的案例：\n    https://mrotaru.wordpress.com/2013/06/20/12-million-concurrent-connections-with-migratorydata-websocket-server/\n (3) 最大文件句柄数的最大值受另外一个参数控制：\n        [root@netty ~]# cat /proc/sys/fs/nr_open\n            1048576\n    设置超过的话：\n        [root@netty ~]# ulimit -Hn 9000000\n    -       bash: ulimit: open files: cannot modify limit: Operation not permitted\n    所以如果想改的更大，这需要修改这个参数（默认百万：1048576（1024 * 1024））：\n        sysctl -w fs.nr_open=100000000\n    那这参数最大值，可以到多少呢？2147483584 （即7FFFFFC0，也就是在MAXINT（2147483647）基础上按64字节对齐）\n（4）linux系统下，一个socket连接一般占用3K,所以100万连接至少需要3G，而1000万就要30G了，所以可以看下（2）引用连接文章里的内存大小，很大。\n\n格式有点乱，先将就看看，等课程结束，我排版好，做个小册子发你们。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573548476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301065,"discussion_content":"请问《netty 100问》小册子出来了没？","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1598398942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1123043,"avatar":"https://static001.geekbang.org/account/avatar/00/11/22/e3/510b69f9.jpg","nickname":"benny","note":"","ucode":"E2F30AF0C808D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546650,"discussion_content":"请问《netty 100问》小册子出来了没？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642383887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1048525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ff/cd/9c44f2d5.jpg","nickname":"Mong狗","note":"","ucode":"9DF0D65D75984E","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539660,"discussion_content":"65535（报文中端口占用字节数是16，所以最大端口数65535） 应该是：字节数为2，16位","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639802052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2744868,"avatar":"","nickname":"麻花","note":"","ucode":"FCCD929A8B47DC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390707,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629982001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338556,"discussion_content":"对于服务器而言，理论最大连接数为什么是21亿？\n客户端数量（IP地址数量）为2^32，已经接近43亿了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609311943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140780,"user_name":"吃饭饭","can_delete":false,"product_type":"c3","uid":1231549,"ip_address":"","ucode":"95CFA07CDA2957","user_header":"https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg","comment_is_top":false,"comment_ctime":1571047693,"is_pvip":false,"replies":[{"id":54420,"content":"严格来说，确实不是一个层次的东西，侧重点也不同，但是看很多人经常把这二个混淆，而且确实，表面看他们也经常呈现出类似的效果，比如netty + http codec 约等于 tomcat+servlet实现web服务器， 考虑到这点，所以内容编排上放一起做了一个区分和比较;\nnetty核心确实主要是提供传输层的支撑，但是它也提供了很多应用层协议的编解码支持。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1571055517,"ip_address":"","comment_id":140780,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"Tomcat 和 Jetty 是 web 容器，虽然 netty 也能实现，但是并不完善；Netty 的主要应用是针对传输层的，我感觉 这里拿Tomcat 和 Jetty 比较 Netty 并不合适吧","like_count":5,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470553,"discussion_content":"严格来说，确实不是一个层次的东西，侧重点也不同，但是看很多人经常把这二个混淆，而且确实，表面看他们也经常呈现出类似的效果，比如netty + http codec 约等于 tomcat+servlet实现web服务器， 考虑到这点，所以内容编排上放一起做了一个区分和比较;\nnetty核心确实主要是提供传输层的支撑，但是它也提供了很多应用层协议的编解码支持。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571055517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139722,"user_name":"helloworld","can_delete":false,"product_type":"c3","uid":1015754,"ip_address":"","ucode":"00DF2FEC58D2E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","comment_is_top":false,"comment_ctime":1570711258,"is_pvip":false,"replies":[{"id":54125,"content":"真的是这样，选择要“跟风”且果断","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1570792577,"ip_address":"","comment_id":139722,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"只听说过Mina，Tomcat，Jetty和Netty，Java领域高性能网络通讯框架看来非Netty不可了","like_count":5,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470075,"discussion_content":"真的是这样，选择要“跟风”且果断","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570792577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":190504,"user_name":"小陈","can_delete":false,"product_type":"c3","uid":1009385,"ip_address":"","ucode":"A03A299310AD18","user_header":"https://static001.geekbang.org/account/avatar/00/0f/66/e9/814d057a.jpg","comment_is_top":false,"comment_ctime":1584665535,"is_pvip":false,"replies":[{"id":78842,"content":"说实话，不知道，但是其实不用看的，肯定netty居多，我不信有人会自己实现一套，如果有，也是历史产品。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1588057329,"ip_address":"","comment_id":190504,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"不错不错，原来还有这么多网络通信框架，老师，像华为这种大公司用什么网络通信框架呢？","like_count":3,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487993,"discussion_content":"说实话，不知道，但是其实不用看的，肯定netty居多，我不信有人会自己实现一套，如果有，也是历史产品。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588057329,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":147118,"user_name":"fomy","can_delete":false,"product_type":"c3","uid":1125834,"ip_address":"","ucode":"CD87EA03B1F327","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg","comment_is_top":false,"comment_ctime":1572798636,"is_pvip":false,"replies":[{"id":57931,"content":"是不同层次的东西，但是经常搞混淆，所以我就把这个放进来了比较了下，有点类似雷锋和雷峰塔的比较了（不过有点夸张了，虽然不同层次，但是能实现类似的东西，所以才放一起做了比较。）","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573569879,"ip_address":"","comment_id":147118,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"Netty是基于Socket抽象层（传输层）通信的，而Tomcat是基于HTTP协议（应用层）通信的，它们是不是不可以类比呢？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473156,"discussion_content":"是不同层次的东西，但是经常搞混淆，所以我就把这个放进来了比较了下，有点类似雷锋和雷峰塔的比较了（不过有点夸张了，虽然不同层次，但是能实现类似的东西，所以才放一起做了比较。）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573569879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1108924,"avatar":"https://static001.geekbang.org/account/avatar/00/10/eb/bc/6ccac4bb.jpg","nickname":"武文文武","note":"","ucode":"5288366646A15B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":83181,"discussion_content":"老师您好，我觉得netty和tomcat比较没什么问题啊，除了通信协议不一样，功能可以是一样的啊，都可以实现服务端，接收海量的客户端请求，然后快速处理并反馈给客户端，为何我看你给很多人留言都否定了2者比较的意义呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576418417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":297269,"user_name":"Allan","can_delete":false,"product_type":"c3","uid":1310388,"ip_address":"","ucode":"8DA4DBECC2C45C","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/b4/295338e7.jpg","comment_is_top":false,"comment_ctime":1623399478,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"https:&#47;&#47;stackoverflow.com&#47;questions&#47;1637752&#47;netty-vs-apache-mina trustin ","like_count":0},{"had_liked":false,"id":222530,"user_name":"jhren","can_delete":false,"product_type":"c3","uid":1596987,"ip_address":"","ucode":"60F7CCEA1E2C88","user_header":"https://static001.geekbang.org/account/avatar/00/18/5e/3b/845fb641.jpg","comment_is_top":false,"comment_ctime":1590829041,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"请问老师，Netty跟Apache HttpComponents是一个层面的框架吗？能比较一下吗？","like_count":0},{"had_liked":false,"id":209027,"user_name":"厉害了我的国","can_delete":false,"product_type":"c3","uid":1052191,"ip_address":"","ucode":"CD0A54A1B998AA","user_header":"https://static001.geekbang.org/account/avatar/00/10/0e/1f/d0472177.jpg","comment_is_top":false,"comment_ctime":1587481277,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"幽默","like_count":0},{"had_liked":false,"id":185095,"user_name":"喵喵喵","can_delete":false,"product_type":"c3","uid":1211713,"ip_address":"","ucode":"E3AD8BF42E19DF","user_header":"https://static001.geekbang.org/account/avatar/00/12/7d/41/3c5b770b.jpg","comment_is_top":false,"comment_ctime":1583480840,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"打卡～","like_count":0},{"had_liked":false,"id":146495,"user_name":"大牙","can_delete":false,"product_type":"c3","uid":1206791,"ip_address":"","ucode":"D4E869BF61DD61","user_header":"https://static001.geekbang.org/account/avatar/00/12/6a/07/96c1e57f.jpg","comment_is_top":false,"comment_ctime":1572540093,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"“关键问题是  Netty就从类没有输过”。老师一本正经的幽默还真的很幽默","like_count":0}]}