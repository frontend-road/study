{"id":393022,"title":"19 | 错误处理（下）：如何设计错误包？","content":"<p>你好，我是孔令飞。</p><p>在Go项目开发中，错误是我们必须要处理的一个事项。除了我们上一讲学习过的错误码，处理错误也离不开错误包。</p><p>业界有很多优秀的、开源的错误包可供选择，例如Go标准库自带的<code>errors</code>包、<code>github.com/pkg/errors</code>包。但是这些包目前还不支持业务错误码，很难满足生产级应用的需求。所以，在实际开发中，我们有必要开发出适合自己错误码设计的错误包。当然，我们也没必要自己从0开发，可以基于一些优秀的包来进行二次封装。</p><p>这一讲里，我们就来一起看看，如何设计一个错误包来适配上一讲我们设计的错误码，以及一个错误码的具体实现。</p><h2>错误包需要具有哪些功能？</h2><p>要想设计一个优秀的错误包，我们首先得知道一个优秀的错误包需要具备哪些功能。在我看来，至少需要有下面这六个功能：</p><p><strong>首先，应该能支持错误堆栈。</strong>我们来看下面一段代码，假设保存在<a href=\"https://github.com/marmotedu/gopractise-demo/blob/master/errors/bad.go\">bad.go</a>文件中：</p><pre><code>package main\n\nimport (\n\t&quot;fmt&quot;\n\t&quot;log&quot;\n)\n\nfunc main() {\n\tif err := funcA(); err != nil {\n\t\tlog.Fatalf(&quot;call func got failed: %v&quot;, err)\n\t\treturn\n\t}\n\n\tlog.Println(&quot;call func success&quot;)\n}\n\nfunc funcA() error {\n\tif err := funcB(); err != nil {\n\t\treturn err\n\t}\n\n\treturn fmt.Errorf(&quot;func called error&quot;)\n}\n\nfunc funcB() error {\n\treturn fmt.Errorf(&quot;func called error&quot;)\n}\n</code></pre><p>执行上面的代码：</p><pre><code>$ go run bad.go\n2021/07/02 08:06:55 call func got failed: func called error\nexit status 1\n</code></pre><p>这时我们想定位问题，但不知道具体是哪行代码报的错误，只能靠猜，还不一定能猜到。为了解决这个问题，我们可以加一些Debug信息，来协助我们定位问题。这样做在测试环境是没问题的，但是在线上环境，一方面修改、发布都比较麻烦，另一方面问题可能比较难重现。这时候我们会想，要是能打印错误的堆栈就好了。例如：</p><!-- [[[read_end]]] --><pre><code>2021/07/02 14:17:03 call func got failed: func called error\nmain.funcB\n\t/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:27\nmain.funcA\n\t/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:19\nmain.main\n\t/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:10\nruntime.main\n\t/home/colin/go/go1.16.2/src/runtime/proc.go:225\nruntime.goexit\n\t/home/colin/go/go1.16.2/src/runtime/asm_amd64.s:1371\nexit status 1\n</code></pre><p>通过上面的错误输出，我们可以很容易地知道是哪行代码报的错，从而极大提高问题定位的效率，降低定位的难度。所以，在我看来，一个优秀的errors包，首先需要支持错误堆栈。</p><p><strong>其次，能够支持不同的打印格式。</strong>例如<code>%+v</code>、<code>%v</code>、<code>%s</code>等格式，可以根据需要打印不同丰富度的错误信息。</p><p><strong>再次，能支持Wrap/Unwrap功能，也就是在已有的错误上，追加一些新的信息。</strong>例如<code>errors.Wrap(err, \"open file failed\")</code> 。Wrap通常用在调用函数中，调用函数可以基于被调函数报错时的错误Wrap一些自己的信息，丰富报错信息，方便后期的错误定位，例如：</p><pre><code>func funcA() error {\n    if err := funcB(); err != nil {\n        return errors.Wrap(err, &quot;call funcB failed&quot;)\n    }\n\n    return errors.New(&quot;func called error&quot;)\n}\n\nfunc funcB() error {\n    return errors.New(&quot;func called error&quot;)\n}\n</code></pre><p>这里要注意，不同的错误类型，Wrap函数的逻辑也可以不同。另外，在调用Wrap时，也会生成一个错误堆栈节点。我们既然能够嵌套error，那有时候还可能需要获取被嵌套的error，这时就需要错误包提供<code>Unwrap</code>函数。</p><p><strong>还有，错误包应该有<code>Is</code>方法</strong>。在实际开发中，我们经常需要判断某个error是否是指定的error。在Go 1.13之前，也就是没有wrapping error的时候，我们要判断error是不是同一个，可以使用如下方法：</p><pre><code>if err == os.ErrNotExist {\n\t// normal code\n}\n</code></pre><p>但是现在，因为有了wrapping error，这样判断就会有问题。因为你根本不知道返回的err是不是一个嵌套的error，嵌套了几层。这种情况下，我们的错误包就需要提供<code>Is</code>函数：</p><pre><code>func Is(err, target error) bool\n</code></pre><p>当err和target是同一个，或者err是一个wrapping error的时候，如果target也包含在这个嵌套error链中，返回true，否则返回fasle。</p><p><strong>另外，错误包应该支持</strong>  <code>As</code>  <strong>函数。</strong></p><p>在Go 1.13之前，没有wrapping error的时候，我们要把error转为另外一个error，一般都是使用type assertion或者type switch，也就是类型断言。例如：</p><pre><code>if perr, ok := err.(*os.PathError); ok {\n\tfmt.Println(perr.Path)\n}\n</code></pre><p>但是现在，返回的err可能是嵌套的error，甚至好几层嵌套，这种方式就不能用了。所以，我们可以通过实现 <code>As</code> 函数来完成这种功能。现在我们把上面的例子，用 <code>As</code> 函数实现一下：</p><pre><code>var perr *os.PathError\nif errors.As(err, &amp;perr) {\n\tfmt.Println(perr.Path)\n}\n</code></pre><p>这样就可以完全实现类型断言的功能，而且还更强大，因为它可以处理wrapping error。</p><p><strong>最后，能够支持两种错误创建方式：非格式化创建和格式化创建。</strong>例如：</p><pre><code>errors.New(&quot;file not found&quot;)\nerrors.Errorf(&quot;file %s not found&quot;, &quot;iam-apiserver&quot;)\n</code></pre><p>上面，我们介绍了一个优秀的错误包应该具备的功能。一个好消息是，Github上有不少实现了这些功能的错误包，其中<code>github.com/pkg/errors</code>包最受欢迎。所以，我基于<code>github.com/pkg/errors</code>包进行了二次封装，用来支持上一讲所介绍的错误码。</p><h2>错误包实现</h2><p>明确优秀的错误包应该具备的功能后，我们来看下错误包的实现。实现的源码存放在<a href=\"https://github.com/marmotedu/errors\">github.com/marmotedu/errors</a>。</p><p>我通过在文件<a href=\"https://github.com/marmotedu/errors/blob/master/errors.go#L299\">github.com/pkg/errors/errors.go</a>中增加新的<code>withCode</code>结构体，来引入一种新的错误类型，该错误类型可以记录错误码、stack、cause和具体的错误信息。</p><pre><code>type withCode struct {\n    err   error // error 错误\n    code  int // 业务错误码\n    cause error // cause error\n    *stack // 错误堆栈\n}\n</code></pre><p>下面，我们通过一个示例，来了解下<code>github.com/marmotedu/errors</code>所提供的功能。假设下述代码保存在<code>errors.go</code>文件中：</p><pre><code>package main\n\nimport (\n\t&quot;fmt&quot;\n\n\t&quot;github.com/marmotedu/errors&quot;\n\tcode &quot;github.com/marmotedu/sample-code&quot;\n)\n\nfunc main() {\n\tif err := bindUser(); err != nil {\n\t\t// %s: Returns the user-safe error string mapped to the error code or the error message if none is specified.\n\t\tfmt.Println(&quot;====================&gt; %s &lt;====================&quot;)\n\t\tfmt.Printf(&quot;%s\\n\\n&quot;, err)\n\n\t\t// %v: Alias for %s.\n\t\tfmt.Println(&quot;====================&gt; %v &lt;====================&quot;)\n\t\tfmt.Printf(&quot;%v\\n\\n&quot;, err)\n\n\t\t// %-v: Output caller details, useful for troubleshooting.\n\t\tfmt.Println(&quot;====================&gt; %-v &lt;====================&quot;)\n\t\tfmt.Printf(&quot;%-v\\n\\n&quot;, err)\n\n\t\t// %+v: Output full error stack details, useful for debugging.\n\t\tfmt.Println(&quot;====================&gt; %+v &lt;====================&quot;)\n\t\tfmt.Printf(&quot;%+v\\n\\n&quot;, err)\n\n\t\t// %#-v: Output caller details, useful for troubleshooting with JSON formatted output.\n\t\tfmt.Println(&quot;====================&gt; %#-v &lt;====================&quot;)\n\t\tfmt.Printf(&quot;%#-v\\n\\n&quot;, err)\n\n\t\t// %#+v: Output full error stack details, useful for debugging with JSON formatted output.\n\t\tfmt.Println(&quot;====================&gt; %#+v &lt;====================&quot;)\n\t\tfmt.Printf(&quot;%#+v\\n\\n&quot;, err)\n\n\t\t// do some business process based on the error type\n\t\tif errors.IsCode(err, code.ErrEncodingFailed) {\n\t\t\tfmt.Println(&quot;this is a ErrEncodingFailed error&quot;)\n\t\t}\n\n\t\tif errors.IsCode(err, code.ErrDatabase) {\n\t\t\tfmt.Println(&quot;this is a ErrDatabase error&quot;)\n\t\t}\n\n\t\t// we can also find the cause error\n\t\tfmt.Println(errors.Cause(err))\n\t}\n}\n\nfunc bindUser() error {\n\tif err := getUser(); err != nil {\n\t\t// Step3: Wrap the error with a new error message and a new error code if needed.\n\t\treturn errors.WrapC(err, code.ErrEncodingFailed, &quot;encoding user 'Lingfei Kong' failed.&quot;)\n\t}\n\n\treturn nil\n}\n\nfunc getUser() error {\n\tif err := queryDatabase(); err != nil {\n\t\t// Step2: Wrap the error with a new error message.\n\t\treturn errors.Wrap(err, &quot;get user failed.&quot;)\n\t}\n\n\treturn nil\n}\n\nfunc queryDatabase() error {\n\t// Step1. Create error with specified error code.\n\treturn errors.WithCode(code.ErrDatabase, &quot;user 'Lingfei Kong' not found.&quot;)\n}\n</code></pre><p>上述代码中，通过<a href=\"https://github.com/marmotedu/errors/blob/v1.0.2/errors.go#L306\">WithCode</a>函数来创建新的withCode类型的错误；通过<a href=\"https://github.com/marmotedu/errors/blob/v1.0.2/errors.go#L314\">WrapC</a>来将一个error封装成一个withCode类型的错误；通过<a href=\"https://github.com/marmotedu/errors/blob/v1.0.2/code.go#L121\">IsCode</a>来判断一个error链中是否包含指定的code。</p><p>withCode错误实现了一个<code>func (w *withCode) Format(state fmt.State, verb rune)</code>方法，该方法用来打印不同格式的错误信息，见下表：</p><p><img src=\"https://static001.geekbang.org/resource/image/18/5c/18a93313e017d4f3b21370099d011c5c.png?wh=1755x1198\" alt=\"\"></p><p>例如，<code>%+v</code>会打印以下错误信息：</p><pre><code>get user failed. - #1 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:19 (main.getUser)] (100101) Database error; user 'Lingfei Kong' not found. - #0 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:26 (main.queryDatabase)] (100101) Database error\n</code></pre><p>那么你可能会问，这些错误信息中的<code>100101</code>错误码，还有<code>Database error</code>这种对外展示的报错信息等等，是从哪里获取的？这里我简单解释一下。</p><p>首先， <code>withCode</code> 中包含了int类型的错误码，例如<code>100101</code>。</p><p>其次，当使用<code>github.com/marmotedu/errors</code>包的时候，需要调用<code>Register</code>或者<code>MustRegister</code>，将一个Coder注册到<code>github.com/marmotedu/errors</code>开辟的内存中，数据结构为：</p><pre><code>var codes = map[int]Coder{}\n</code></pre><p>Coder是一个接口，定义为：</p><pre><code>type Coder interface {\n    // HTTP status that should be used for the associated error code.\n    HTTPStatus() int\n\n    // External (user) facing error text.\n    String() string\n\n    // Reference returns the detail documents for user.\n    Reference() string\n\n    // Code returns the code of the coder\n    Code() int\n}\n</code></pre><p>这样 <code>withCode</code> 的<code>Format</code>方法，就能够通过 <code>withCode</code> 中的code字段获取到对应的Coder，并通过Coder提供的HTTPStatus、String、Reference、Code函数，来获取 <code>withCode</code> 中code的详细信息，最后格式化打印。</p><p>这里要注意，我们实现了两个注册函数：<code>Register</code>和<code>MustRegister</code>，二者唯一区别是：当重复定义同一个错误Code时，<code>MustRegister</code>会panic，这样可以防止后面注册的错误覆盖掉之前注册的错误。在实际开发中，建议使用<code>MustRegister</code>。</p><p><code>XXX()</code>和<code>MustXXX()</code>的函数命名方式，是一种Go代码设计技巧，在Go代码中经常使用，例如Go标准库中<code>regexp</code>包提供的<code>Compile</code>和<code>MustCompile</code>函数。和<code>XXX</code>相比，<code>MustXXX</code> 会在某种情况不满足时panic。因此使用<code>MustXXX</code>的开发者看到函数名就会有一个心理预期：使用不当，会造成程序panic。</p><p>最后，我还有一个建议：在实际的生产环境中，我们可以使用JSON格式打印日志，JSON格式的日志可以非常方便的供日志系统解析。我们可以根据需要，选择<code>%#-v</code>或<code>%#+v</code>两种格式。</p><p>错误包在代码中，经常被调用，所以我们要保证错误包一定要是高性能的，否则很可能会影响接口的性能。这里，我们再来看下<code>github.com/marmotedu/errors</code>包的性能。</p><p>在这里，我们把这个错误包跟go标准库的 <code>errors</code> 包，以及 <code>github.com/pkg/errors</code> 包进行对比，来看看它们的性能：</p><pre><code>$  go test -test.bench=BenchmarkErrors -benchtime=&quot;3s&quot;\ngoos: linux\ngoarch: amd64\npkg: github.com/marmotedu/errors\nBenchmarkErrors/errors-stack-10-8         \t57658672\t        61.8 ns/op\t      16 B/op\t       1 allocs/op\nBenchmarkErrors/pkg/errors-stack-10-8     \t 2265558\t      1547 ns/op\t     320 B/op\t       3 allocs/op\nBenchmarkErrors/marmot/errors-stack-10-8  \t 1903532\t      1772 ns/op\t     360 B/op\t       5 allocs/op\nBenchmarkErrors/errors-stack-100-8        \t 4883659\t       734 ns/op\t      16 B/op\t       1 allocs/op\nBenchmarkErrors/pkg/errors-stack-100-8    \t 1202797\t      2881 ns/op\t     320 B/op\t       3 allocs/op\nBenchmarkErrors/marmot/errors-stack-100-8 \t 1000000\t      3116 ns/op\t     360 B/op\t       5 allocs/op\nBenchmarkErrors/errors-stack-1000-8       \t  505636\t      7159 ns/op\t      16 B/op\t       1 allocs/op\nBenchmarkErrors/pkg/errors-stack-1000-8   \t  327681\t     10646 ns/op\t     320 B/op\t       3 allocs/op\nBenchmarkErrors/marmot/errors-stack-1000-8         \t  304160\t     11896 ns/op\t     360 B/op\t       5 allocs/op\nPASS\nok  \tgithub.com/marmotedu/errors\t39.200s\n</code></pre><p>可以看到<code>github.com/marmotedu/errors</code>和<code>github.com/pkg/errors</code>包的性能基本持平。在对比性能时，重点关注<strong>ns/op</strong>，也即每次error操作耗费的纳秒数。另外，我们还需要测试不同error嵌套深度下的error操作性能，嵌套越深，性能越差。例如：在嵌套深度为10的时候， <code>github.com/pkg/errors</code> 包ns/op值为1547， <code>github.com/marmotedu/errors</code> 包ns/op值为1772。可以看到，二者性能基本保持一致。</p><p>具体性能数据对比见下表：</p><p><img src=\"https://static001.geekbang.org/resource/image/a6/5e/a6a794d7523bc1edfa459d3a49f9685e.png?wh=1737x1145\" alt=\"\"></p><p>我们是通过<a href=\"https://github.com/marmotedu/errors/blob/v1.0.2/bench_test.go#L39\">BenchmarkErrors</a>测试函数来测试error包性能的，你感兴趣可以打开链接看看。</p><h2>如何记录错误？</h2><p>上面，我们一起看了怎么设计一个优秀的错误包，那如何用我们设计的错误包来记录错误呢？</p><p>根据我的开发经验，我推荐两种记录错误的方式，可以帮你快速定位问题。</p><p>方式一：通过<code>github.com/marmotedu/errors</code>包提供的错误堆栈能力，来跟踪错误。</p><p>具体你可以看看下面的代码示例。以下代码保存在<a href=\"https://github.com/marmotedu/gopractise-demo/blob/master/errors/errortrack_errors.go\">errortrack_errors.go</a>中。</p><pre><code>package main\n\nimport (\n\t&quot;fmt&quot;\n\n\t&quot;github.com/marmotedu/errors&quot;\n\n\tcode &quot;github.com/marmotedu/sample-code&quot;\n)\n\nfunc main() {\n\tif err := getUser(); err != nil {\n\t\tfmt.Printf(&quot;%+v\\n&quot;, err)\n\t}\n}\n\nfunc getUser() error {\n\tif err := queryDatabase(); err != nil {\n\t\treturn errors.Wrap(err, &quot;get user failed.&quot;)\n\t}\n\n\treturn nil\n}\n\nfunc queryDatabase() error {\n\treturn errors.WithCode(code.ErrDatabase, &quot;user 'Lingfei Kong' not found.&quot;)\n}\n</code></pre><p>执行上述的代码：</p><pre><code>$ go run errortrack_errors.go\nget user failed. - #1 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:19 (main.getUser)] (100101) Database error; user 'Lingfei Kong' not found. - #0 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:26 (main.queryDatabase)] (100101) Database error\n</code></pre><p>可以看到，打印的日志中打印出了详细的错误堆栈，包括错误发生的函数、文件名、行号和错误信息，通过这些错误堆栈，我们可以很方便地定位问题。</p><p>你使用这种方法时，我推荐的用法是，在错误最开始处使用 <code>errors.WithCode()</code> 创建一个 withCode类型的错误。上层在处理底层返回的错误时，可以根据需要，使用Wrap函数基于该错误封装新的错误信息。如果要包装的error不是用<code>github.com/marmotedu/errors</code>包创建的，建议用 <code>errors.WithCode()</code> 新建一个error。</p><p>方式二：在错误产生的最原始位置调用日志包记录函数，打印错误信息，其他位置直接返回（当然，也可以选择性的追加一些错误信息，方便故障定位）。示例代码（保存在<a href=\"https://github.com/marmotedu/gopractise-demo/blob/master/errors/errortrack_log.go\">errortrack_log.go</a>）如下：</p><pre><code>package main\n\nimport (\n\t&quot;fmt&quot;\n\n\t&quot;github.com/marmotedu/errors&quot;\n\t&quot;github.com/marmotedu/log&quot;\n\n\tcode &quot;github.com/marmotedu/sample-code&quot;\n)\n\nfunc main() {\n\tif err := getUser(); err != nil {\n\t\tfmt.Printf(&quot;%v\\n&quot;, err)\n\t}\n}\n\nfunc getUser() error {\n\tif err := queryDatabase(); err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\nfunc queryDatabase() error {\n\topts := &amp;log.Options{\n\t\tLevel:            &quot;info&quot;,\n\t\tFormat:           &quot;console&quot;,\n\t\tEnableColor:      true,\n\t\tEnableCaller:     true,\n\t\tOutputPaths:      []string{&quot;test.log&quot;, &quot;stdout&quot;},\n\t\tErrorOutputPaths: []string{},\n\t}\n\n\tlog.Init(opts)\n\tdefer log.Flush()\n\n\terr := errors.WithCode(code.ErrDatabase, &quot;user 'Lingfei Kong' not found.&quot;)\n\tif err != nil {\n\t\tlog.Errorf(&quot;%v&quot;, err)\n\t}\n\treturn err\n}\n</code></pre><p>执行以上代码：</p><pre><code>$ go run errortrack_log.go\n2021-07-03 14:37:31.597\tERROR\terrors/errortrack_log.go:41\tDatabase error\nDatabase error\n</code></pre><p>当错误发生时，调用log包打印错误。通过log包的caller功能，可以定位到log语句的位置，也就是定位到错误发生的位置。你使用这种方式来打印日志时，我有两个建议。</p><ul>\n<li>只在错误产生的最初位置打印日志，其他地方直接返回错误，一般不需要再对错误进行封装。</li>\n<li>当代码调用第三方包的函数时，第三方包函数出错时打印错误信息。比如：</li>\n</ul><pre><code>if err := os.Chdir(&quot;/root&quot;); err != nil {\n    log.Errorf(&quot;change dir failed: %v&quot;, err)\n}\n</code></pre><h2>一个错误码的具体实现</h2><p>接下来，我们看一个依据上一讲介绍的错误码规范的具体错误码实现<code>github.com/marmotedu/sample-code</code>。</p><p><code>sample-code</code>实现了两类错误码，分别是通用错误码（<a href=\"https://github.com/marmotedu/sample-code/blob/master/base.go\">sample-code/base.go</a>）和业务模块相关的错误码（<a href=\"https://github.com/marmotedu/sample-code/blob/master/apiserver.go\">sample-code/apiserver.go</a>）。</p><p>首先，我们来看通用错误码的定义：</p><pre><code>// 通用: 基本错误\n// Code must start with 1xxxxx\nconst (\n    // ErrSuccess - 200: OK.\n    ErrSuccess int = iota + 100001\n\n    // ErrUnknown - 500: Internal server error.\n    ErrUnknown\n\n    // ErrBind - 400: Error occurred while binding the request body to the struct.\n    ErrBind\n\n    // ErrValidation - 400: Validation failed.\n    ErrValidation\n\n    // ErrTokenInvalid - 401: Token invalid.\n    ErrTokenInvalid\n)\n</code></pre><p>在代码中，我们通常使用整型常量（ErrSuccess）来代替整型错误码（100001），因为使用ErrSuccess时，一看就知道它代表的错误类型，可以方便开发者使用。</p><p>错误码用来指代一个错误类型，该错误类型需要包含一些有用的信息，例如对应的HTTP Status Code、对外展示的Message，以及跟该错误匹配的帮助文档。所以，我们还需要实现一个Coder来承载这些信息。这里，我们定义了一个实现了<code>github.com/marmotedu/errors.Coder</code>接口的<code>ErrCode</code>结构体：</p><pre><code>// ErrCode implements `github.com/marmotedu/errors`.Coder interface.\ntype ErrCode struct {\n    // C refers to the code of the ErrCode.\n    C int\n\n    // HTTP status that should be used for the associated error code.\n    HTTP int\n\n    // External (user) facing error text.\n    Ext string\n\n    // Ref specify the reference document.\n    Ref string\n}\n</code></pre><p>可以看到<code>ErrCode</code>结构体包含了以下信息：</p><ul>\n<li>int类型的业务码。</li>\n<li>对应的HTTP Status Code。</li>\n<li>暴露给外部用户的消息。</li>\n<li>错误的参考文档。</li>\n</ul><p>下面是一个具体的Coder示例：</p><pre><code>coder := &amp;ErrCode{\n    C:    100001,\n    HTTP: 200,\n    Ext:  &quot;OK&quot;,\n    Ref:  &quot;https://github.com/marmotedu/sample-code/blob/master/README.md&quot;,\n}\n</code></pre><p>接下来，我们就可以调用<code>github.com/marmotedu/errors</code>包提供的<code>Register</code>或者<code>MustRegister</code>函数，将Coder注册到<code>github.com/marmotedu/errors</code>包维护的内存中。</p><p>一个项目有很多个错误码，如果每个错误码都手动调用<code>MustRegister</code>函数会很麻烦，这里我们通过代码自动生成的方法，来生成register函数调用：</p><pre><code>//go:generate codegen -type=int\n//go:generate codegen -type=int -doc -output ./error_code_generated.md\n</code></pre><p><code>//go:generate codegen -type=int</code> 会调用<a href=\"https://github.com/marmotedu/iam/tree/master/tools/codegen\">codegen</a>工具，生成<a href=\"https://github.com/marmotedu/sample-code/blob/master/sample_code_generated.go\">sample_code_generated.go</a>源码文件：</p><pre><code>func init() {\n\tregister(ErrSuccess, 200, &quot;OK&quot;)\n\tregister(ErrUnknown, 500, &quot;Internal server error&quot;)\n\tregister(ErrBind, 400, &quot;Error occurred while binding the request body to the struct&quot;)\n\tregister(ErrValidation, 400, &quot;Validation failed&quot;)\n    // other register function call\n}\n</code></pre><p>这些<a href=\"https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/code/code.go#L58\">register</a>调用放在init函数中，在加载程序的时候被初始化。</p><p>这里要注意，在注册的时候，我们会检查HTTP Status Code，只允许定义200、400、401、403、404、500这6个HTTP错误码。这里通过程序保证了错误码是符合HTTP Status Code使用要求的。</p><p><code>//go:generate codegen -type=int -doc -output ./error_code_generated.md</code>会生成错误码描述文档 <a href=\"https://github.com/marmotedu/sample-code/blob/master/error_code_generated.md\">error_code_generated.md</a>。当我们提供API文档时，也需要记着提供一份错误码描述文档，这样客户端才可以根据错误码，知道请求是否成功，以及具体发生哪类错误，好针对性地做一些逻辑处理。</p><p><code>codegen</code>工具会根据错误码注释生成<code>sample_code_generated.go</code>和<code>error_code_generated.md</code>文件：</p><pre><code>// ErrSuccess - 200: OK.\n ErrSuccess int = iota + 100001\n</code></pre><p>codegen工具之所以能够生成<code>sample_code_generated.go</code>和<code>error_code_generated.md</code>，是因为我们的错误码注释是有规定格式的：<code>// &lt;错误码整型常量&gt; - &lt;对应的HTTP Status Code&gt;: &lt;External Message&gt;.</code>。</p><p>codegen工具可以在IAM项目根目录下，执行以下命令来安装：</p><pre><code>$ make tools.install.codegen\n</code></pre><p>安装完 <code>codegen</code> 工具后，可以在 <code>github.com/marmotedu/sample-code</code> 包根目录下执行 <code>go generate</code> 命令，来生成<code>sample_code_generated.go</code>和<code>error_code_generated.md</code>。这里有个技巧需要你注意：生成的文件建议统一用  <code>xxxx_generated.xx</code> 来命名，这样通过 <code>generated</code> ，我们就知道这个文件是代码自动生成的，有助于我们理解和使用。</p><p>在实际的开发中，我们可以将错误码独立成一个包，放在 <code>internal/pkg/code/</code>目录下，这样可以方便整个应用调用。例如IAM的错误码就放在IAM项目根目录下的<a href=\"https://github.com/marmotedu/iam/tree/master/internal/pkg/code\">internal/pkg/code/</a>目录下。</p><p>我们的错误码是分服务和模块的，所以这里建议你把相同的服务放在同一个Go源文件中，例如IAM的错误码存放文件：</p><pre><code>$ ls base.go apiserver.go authzserver.go \napiserver.go  authzserver.go  base.go\n</code></pre><p>一个应用中会有多个服务，例如IAM应用中，就包含了iam-apiserver、iam-authz-server、iam-pump三个服务。这些服务有一些通用的错误码，为了便于维护，可以将这些通用的错误码统一放在base.go源码文件中。其他的错误码，我们可以按服务分别放在不同的文件中：iam-apiserver服务的错误码统一放在apiserver.go文件中；iam-authz-server的错误码统一存放在authzserver.go文件中。其他服务以此类推。</p><p>另外，同一个服务中不同模块的错误码，可以按以下格式来组织：相同模块的错误码放在同一个const代码块中，不同模块的错误码放在不同的const代码块中。每个const代码块的开头注释就是该模块的错误码定义。例如：</p><pre><code>// iam-apiserver: user errors.\nconst (\n    // ErrUserNotFound - 404: User not found.\n    ErrUserNotFound int = iota + 110001\n\n    // ErrUserAlreadyExist - 400: User already exist.\n    ErrUserAlreadyExist\n)\n\n// iam-apiserver: secret errors.\nconst (\n    // ErrEncrypt - 400: Secret reach the max count.\n    ErrReachMaxCount int = iota + 110101\n\n    //  ErrSecretNotFound - 404: Secret not found.\n    ErrSecretNotFound\n)\n</code></pre><p>最后，我们还需要将错误码定义记录在项目的文件中，供开发者查阅、遵守和使用，例如IAM项目的错误码定义记录文档为<a href=\"https://github.com/marmotedu/iam/blob/master/docs/guide/zh-CN/api/code_specification.md\">code_specification.md</a>。这个文档中记录了错误码说明、错误描述规范和错误记录规范等。</p><h2>错误码实际使用方法示例</h2><p>上面，我讲解了错误包和错误码的实现方式，那你一定想知道在实际开发中我们是如何使用的。这里，我就举一个在gin web框架中使用该错误码的例子：</p><pre><code>// Response defines project response format which in marmotedu organization.\ntype Response struct {\n    Code      errors.Code `json:&quot;code,omitempty&quot;`\n    Message   string      `json:&quot;message,omitempty&quot;`\n    Reference string      `json:&quot;reference,omitempty&quot;`\n    Data      interface{} `json:&quot;data,omitempty&quot;`\n}\n\n// WriteResponse used to write an error and JSON data into response.\nfunc WriteResponse(c *gin.Context, err error, data interface{}) {\n    if err != nil {\n        coder := errors.ParseCoder(err)\n\n        c.JSON(coder.HTTPStatus(), Response{\n            Code:      coder.Code(),\n            Message:   coder.String(),\n            Reference: coder.Reference(),\n            Data:      data,\n        })\n    }\n\n    c.JSON(http.StatusOK, Response{Data: data})\n}\n\nfunc GetUser(c *gin.Context) {\n    log.Info(&quot;get user function called.&quot;, &quot;X-Request-Id&quot;, requestid.Get(c))\n    // Get the user by the `username` from the database.\n    user, err := store.Client().Users().Get(c.Param(&quot;username&quot;), metav1.GetOptions{})\n    if err != nil {\n        core.WriteResponse(c, errors.WithCode(code.ErrUserNotFound, err.Error()), nil)\n        return\n    }\n\n    core.WriteResponse(c, nil, user)\n}\n</code></pre><p>上述代码中，通过<code>WriteResponse</code>统一处理错误。在 <code>WriteResponse</code> 函数中，如果<code>err != nil</code>，则从error中解析出Coder，并调用Coder提供的方法，获取错误相关的Http Status Code、int类型的业务码、暴露给用户的信息、错误的参考文档链接，并返回JSON格式的信息。如果 <code>err == nil</code> 则返回200和数据。</p><h2>总结</h2><p>记录错误是应用程序必须要做的一件事情，在实际开发中，我们通常会封装自己的错误包。一个优秀的错误包，应该能够支持错误堆栈、不同的打印格式、Wrap/Unwrap/Is/As等函数，并能够支持格式化创建error。</p><p>根据这些错误包设计要点，我基于 <code>github.com/pkg/errors</code> 包设计了IAM项目的错误包 <code>github.com/marmotedu/errors</code> ，该包符合我们上一讲设计的错误码规范。</p><p>另外，本讲也给出了一个具体的错误码实现 sample-code ， sample-code 支持业务Code码、HTTP Status Code、错误参考文档、可以对内对外展示不同的错误信息。</p><p>最后，因为错误码注释是有固定格式的，所以我们可以通过codegen工具解析错误码的注释，生成register函数调用和错误码文档。这种做法也体现了我一直强调的low code思想，可以提高开发效率，减少人为失误。</p><h2>课后练习</h2><ol>\n<li>在这门课里，我们定义了base、iam-apiserver服务的错误码，请试着定义iam-authz-server服务的错误码，并生成错误码文档。</li>\n<li>思考下，这门课的错误包和错误码设计能否满足你当前的项目需求，如果觉得不能满足，可以在留言区分享你的看法。</li>\n</ol><p>欢迎你在留言区与我交流讨论，我们下一讲见。</p>","comments":[{"had_liked":false,"id":301443,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1625702213,"is_pvip":false,"replies":[{"id":"109216","content":"感谢pedro支持","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1625850425,"ip_address":"","comment_id":301443,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35985440581","product_id":100079601,"comment_content":"以推荐老师的项目给组里其它小伙伴，一起学习沉淀打磨为自己的实用标准，多谢老师","like_count":8,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522998,"discussion_content":"感谢pedro支持","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625850425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323549,"user_name":"yandongxiao","can_delete":false,"product_type":"c1","uid":1017700,"ip_address":"","ucode":"D397F4DB0109C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg","comment_is_top":false,"comment_ctime":1637984623,"is_pvip":false,"replies":[{"id":"117667","content":"总结的很全，很到位！","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1638361149,"ip_address":"","comment_id":323549,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14522886511","product_id":100079601,"comment_content":"总结：<br>1. 为什么业务要开发自己的错误包？因为开源的error包中，没有业务错误码，不方便使用。<br>2. 如何区分内部错误和外部错误？<br>    1. 将错误分为两部分，是一个非常好的设计，通过 error code 联系在一起<br>    2. 将 error code, response code, external error message 注册到一张大表上<br>    3. github.com&#47;marmotedu&#47;errors 包提供的 WitheCode 和 Wrap 方法，构建错误链（嵌套关系）<br>    4. 通过 format 的各种形式，控制 error 的输出信息<br>3. 如何自动生成全局的错误码文档，方便排查问题和联调？ 使用 codegen 工具。<br>4. 如何打印错误？只在错误最原始位置打印错误。","like_count":3,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535139,"discussion_content":"总结的很全，很到位！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638361149,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304454,"user_name":"漂泊的小飘","can_delete":false,"product_type":"c1","uid":1222578,"ip_address":"","ucode":"25C0CA4887D8AD","user_header":"https://static001.geekbang.org/account/avatar/00/12/a7/b2/274a4192.jpg","comment_is_top":false,"comment_ctime":1627433874,"is_pvip":false,"replies":[{"id":"110215","content":"老哥，加油!","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1627597616,"ip_address":"","comment_id":304454,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14512335762","product_id":100079601,"comment_content":"感觉需要看着源码再学一遍。。。","like_count":3,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524049,"discussion_content":"老哥，加油!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627597616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344761,"user_name":"树建","can_delete":false,"product_type":"c1","uid":2458903,"ip_address":"","ucode":"468528274F34E8","user_header":"https://static001.geekbang.org/account/avatar/00/25/85/17/91ad99c3.jpg","comment_is_top":false,"comment_ctime":1651754583,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"10241689175","product_id":100079601,"comment_content":"文中提到withCode实现了format方法，但是看了errors.go中只查看withMessage实现了format","like_count":2,"discussions":[{"author":{"id":1107155,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e4/d3/bdb08936.jpg","nickname":"session","note":"","ucode":"B2F847B2B0A7F7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575351,"discussion_content":"我也有这个疑惑，望老师给解答下","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1654765165,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2864352,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/b4/e0/4b2a4837.jpg","nickname":"ちょうらい","note":"","ucode":"C790EDB9B76CDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1107155,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e4/d3/bdb08936.jpg","nickname":"session","note":"","ucode":"B2F847B2B0A7F7","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":586931,"discussion_content":"在format.go那个文件里实现的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662616976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":575351,"ip_address":"上海"},"score":586931,"extra":""}]}]},{"had_liked":false,"id":310166,"user_name":"随风而过","can_delete":false,"product_type":"c1","uid":2654999,"ip_address":"","ucode":"FFD17BAA3B2312","user_header":"https://static001.geekbang.org/account/avatar/00/28/83/17/df99b53d.jpg","comment_is_top":false,"comment_ctime":1630508803,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10220443395","product_id":100079601,"comment_content":"错误码的设计很合理，和其他语言的错误设计大相径庭，很规范，老师这套错误可以引入到企业开发项目当中","like_count":2},{"had_liked":false,"id":351339,"user_name":"大利","can_delete":false,"product_type":"c1","uid":1608364,"ip_address":"","ucode":"271BE88C4124FE","user_header":"https://static001.geekbang.org/account/avatar/00/18/8a/ac/82699bc8.jpg","comment_is_top":false,"comment_ctime":1657709515,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5952676811","product_id":100079601,"comment_content":"withCode 没有实现 Format() 方法呀？","like_count":1},{"had_liked":false,"id":348318,"user_name":".","can_delete":false,"product_type":"c1","uid":2878938,"ip_address":"","ucode":"CCED7B9015BD70","user_header":"https://static001.geekbang.org/account/avatar/00/2b/ed/da/78a0e68f.jpg","comment_is_top":false,"comment_ctime":1654955555,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5949922851","product_id":100079601,"comment_content":"看完了git中withCode错误的实现逻辑对于 WitCode需要分开cause和err 两个errors，很是迷惑。起初看完代码在猜想cause这个应该是为了递归打印，实现上个章节的”科学设计错误包“内容“ 错误码100101， 10: 服务。01: 某个服务下的某个模块。01: 模块下的错误码序号，每个模块可以注册 100 个错误。” 的功能，但是看了函数IsCode的逻辑，彻底懵逼了，code只对比了第一层的code就return，显然不是为了实现上一章节的内容，所以多个cause  errors感觉是一个特别累赘的设计。<br><br>另外WithCode和WithStack 的入参都是error 接口。 如果一个error起初是go原生库的error， 先withCode再WithMessgge, 在执行err. Error() 会丢失打印不出完整的错误栈。这块是原本iam的就是业务设计就是如此吗？WithMessgge会直接决定了err. Error() 值，不管前面被With了多少次？","like_count":1},{"had_liked":false,"id":311147,"user_name":"倪昊","can_delete":false,"product_type":"c1","uid":1236631,"ip_address":"","ucode":"790CB649341D37","user_header":"https://static001.geekbang.org/account/avatar/00/12/de/97/cda3f551.jpg","comment_is_top":false,"comment_ctime":1631088003,"is_pvip":true,"replies":[{"id":"112822","content":"是个bug，感谢老哥反馈，已经修复","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1631178081,"ip_address":"","comment_id":311147,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5926055299","product_id":100079601,"comment_content":"错误码实际使用方法实例里的WriteResponse，如果err != nil，if分支执行完，还是会继续执行下面的c.JSON，这样不就返回两个Response结构了吗？","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526492,"discussion_content":"是个bug，感谢老哥反馈，已经修复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631178081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306561,"user_name":"Sch0ng","can_delete":false,"product_type":"c1","uid":1145554,"ip_address":"","ucode":"73F6113931B1AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg","comment_is_top":false,"comment_ctime":1628608092,"is_pvip":false,"replies":[{"id":"111434","content":"对的","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1629251574,"ip_address":"","comment_id":306561,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5923575388","product_id":100079601,"comment_content":"把错误处理落地成简单实用的错误处理包，有助于错误码的长期治理。","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524812,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629251574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305352,"user_name":"大刘","can_delete":false,"product_type":"c1","uid":1386285,"ip_address":"","ucode":"7768F2DD4C4ED0","user_header":"https://static001.geekbang.org/account/avatar/00/15/27/2d/120c21ef.jpg","comment_is_top":false,"comment_ctime":1627916180,"is_pvip":false,"replies":[{"id":"110654","content":"1. 没问题的<br>2. 已经更新啦，感谢反馈！","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1628166565,"ip_address":"","comment_id":305352,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5922883476","product_id":100079601,"comment_content":"错误码实际使用方法示例中<br>1.type Response struct { Code errors.Code `json:&quot;code,omitempty&quot;` Message string `json:&quot;message,omitempty&quot;` Reference string `json:&quot;reference,omitempty&quot;` Data interface{} `json:&quot;data,omitempty&quot;`}<br><br>Code errors.Code 是不是应该改为Code int<br>2.if err != nil { core.WriteResponse(c, code.ErrUserNotFound.Error(), nil) return }<br>code.ErrUserNotFound.Error()  这个Error方法是从哪里来的？ ErrUserNotFound按照上面所说应该只是一个int值吧？","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524360,"discussion_content":"1. 没问题的\n2. 已经更新啦，感谢反馈！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628166565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304752,"user_name":"ppd0705","can_delete":false,"product_type":"c1","uid":1155646,"ip_address":"","ucode":"EB63D4E3FD1E9A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","comment_is_top":false,"comment_ctime":1627600306,"is_pvip":false,"replies":[{"id":"110252","content":"要魔改error包了，支持自定义ext信息。老哥，感兴趣可以魔改下。","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1627612372,"ip_address":"","comment_id":304752,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5922567602","product_id":100079601,"comment_content":"请问一下老师，当一个接口有多个用户输入参数，其中某个参数错误, 如果需要告诉用户具体哪个参数有问题，这样CODE.Ext是动态的，该怎么处理好呢？ <br><br><br>","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524149,"discussion_content":"要魔改error包了，支持自定义ext信息。老哥，感兴趣可以魔改下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627612372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1155646,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","nickname":"ppd0705","note":"","ucode":"EB63D4E3FD1E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386508,"discussion_content":"明白了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627621132,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302858,"user_name":"你赖东东不错嘛","can_delete":false,"product_type":"c1","uid":2426387,"ip_address":"","ucode":"3B11CA3BD80F3E","user_header":"https://static001.geekbang.org/account/avatar/00/25/06/13/e4f9f79b.jpg","comment_is_top":false,"comment_ctime":1626410091,"is_pvip":false,"replies":[{"id":"109743","content":"这个地方可以根据需要选择是否在上层直接返回err，还是再添加一些信息。<br><br>一般情况下直接返回err即可。但可能也有些业务逻辑需要在上层追加一些额外的信息，来帮助排障。","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1626683460,"ip_address":"","comment_id":302858,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5921377387","product_id":100079601,"comment_content":"记录错误方式二：在err发生处打印了log，却依旧把err上抛，而最外层又对err进行了一次处理，这样可能导致日志里写了两份重复的err信息。望解惑！","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523458,"discussion_content":"这个地方可以根据需要选择是否在上层直接返回err，还是再添加一些信息。\n\n一般情况下直接返回err即可。但可能也有些业务逻辑需要在上层追加一些额外的信息，来帮助排障。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626683460,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302136,"user_name":"8.13.3.27.30","can_delete":false,"product_type":"c1","uid":1556358,"ip_address":"","ucode":"2DE3CE3E338BAB","user_header":"https://static001.geekbang.org/account/avatar/00/17/bf/86/c0cb35f0.jpg","comment_is_top":false,"comment_ctime":1626095441,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5921062737","product_id":100079601,"comment_content":"非常实用的东西、老师讲的东西在实际应用中、真真切切的用到了、可惜当时老师没有出这个教程、现在只能下次重构的时候再使用了","like_count":1},{"had_liked":false,"id":302103,"user_name":"Daiver","can_delete":false,"product_type":"c1","uid":1466447,"ip_address":"","ucode":"9B1A03AFBC79BC","user_header":"https://static001.geekbang.org/account/avatar/00/16/60/4f/db0e62b3.jpg","comment_is_top":false,"comment_ctime":1626081454,"is_pvip":false,"replies":[{"id":"109335","content":"codegen是我写的一个解析程序。主要是通过解析ast语法树，来获取其中的注释，然后根据注释自动生成文档和Go源文件，具体实现方式你就可以参考codegen源代码","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1626143003,"ip_address":"","comment_id":302103,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5921048750","product_id":100079601,"comment_content":"还是不清楚，codegen是怎么生成注册代码的","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523182,"discussion_content":"codegen是我写的一个解析程序。主要是通过解析ast语法树，来获取其中的注释，然后根据注释自动生成文档和Go源文件，具体实现方式你就可以参考codegen源代码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626143003,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301594,"user_name":"happychap","can_delete":false,"product_type":"c1","uid":1388033,"ip_address":"","ucode":"C872B959BF2F3D","user_header":"https://static001.geekbang.org/account/avatar/00/15/2e/01/14a478bb.jpg","comment_is_top":false,"comment_ctime":1625755353,"is_pvip":true,"replies":[{"id":"109212","content":"内容来源，是产研总结的Q&amp;A。链接中的文档可以放在docs&#47;guide&#47;zh-CN&#47;faq&#47;目录下。","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1625849624,"ip_address":"","comment_id":301594,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5920722649","product_id":100079601,"comment_content":"老师，您好，学习了您的专栏受益良多，谢谢您的付出！有个问题还不太明白，烦请解答一下，就是：接口请问返回给error处理ref链接内容来源是怎么形成的或该如何维护管理它们呢？","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523036,"discussion_content":"内容来源，是产研总结的Q&amp;amp;A。链接中的文档可以放在docs/guide/zh-CN/faq/目录下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625849624,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1388033,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2e/01/14a478bb.jpg","nickname":"happychap","note":"","ucode":"C872B959BF2F3D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383121,"discussion_content":"明白了，谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625910697,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358407,"user_name":"season","can_delete":false,"product_type":"c1","uid":2894734,"ip_address":"浙江","ucode":"1CBBFCC58A245E","user_header":"https://static001.geekbang.org/account/avatar/00/2c/2b/8e/4d24c872.jpg","comment_is_top":false,"comment_ctime":1664275590,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1664275590","product_id":100079601,"comment_content":"如何记录错误 章节中的两种记录错误的方式更推荐哪个呢？<br>或者说两种方式各自的使用场景是怎样的？改如何进行选择？","like_count":0},{"had_liked":false,"id":358294,"user_name":"zzq","can_delete":false,"product_type":"c1","uid":1234584,"ip_address":"北京","ucode":"03FE20B812D15D","user_header":"https://static001.geekbang.org/account/avatar/00/12/d6/98/e2d8f2a9.jpg","comment_is_top":false,"comment_ctime":1664176478,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1664176478","product_id":100079601,"comment_content":"偶偶、 老师、 刚才提交的留言是关于 注释首字母必须大写的问题、 我自己编译一下把正则 首字母大写去掉了。 <br><br>学习了很多， 大佬牛批～～～～。","like_count":0},{"had_liked":false,"id":358290,"user_name":"zzq","can_delete":false,"product_type":"c1","uid":1234584,"ip_address":"北京","ucode":"03FE20B812D15D","user_header":"https://static001.geekbang.org/account/avatar/00/12/d6/98/e2d8f2a9.jpg","comment_is_top":false,"comment_ctime":1664175501,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1664175501","product_id":100079601,"comment_content":"老师、我在单独练习 codegen -type=int 生成错误码时、发现<br><br>&#47;&#47; ErrSuccess - 200: 成功.<br>ErrSuccess int = iota + 100001<br><br>生成失败 是因为 成功这个要求首字母大写， 我想使用纯汉字的描述 应该怎么做。 ","like_count":0},{"had_liked":false,"id":350933,"user_name":"Geek_25f93f","can_delete":false,"product_type":"c1","uid":2917509,"ip_address":"","ucode":"D5932373E8EEA2","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/5JKZO1Ziax3Ky03noshpVNyEvZw0pUwjLcHrHRo1XNPKXdmCE88homb6ltA15CdVRnjzjgGs3Ex42CaDbeYzNuQ/132","comment_is_top":false,"comment_ctime":1657360042,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657360042","product_id":100079601,"comment_content":"要写这么一个codegen工具应该要废很多时间","like_count":0},{"had_liked":false,"id":342606,"user_name":"Geek_c2089d","can_delete":false,"product_type":"c1","uid":1489545,"ip_address":"","ucode":"C66D345042525F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/4Lprf2mIWpJOPibgibbFCicMtp5bpIibyLFOnyOhnBGbusrLZC0frG0FGWqdcdCkcKunKxqiaOHvXbCFE7zKJ8TmvIA/132","comment_is_top":false,"comment_ctime":1650362529,"is_pvip":false,"replies":[{"id":"125523","content":"相同目录下，stack.go文件中","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1651078103,"ip_address":"","comment_id":342606,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1650362529","product_id":100079601,"comment_content":"func New(message string) error {<br>\treturn &amp;fundamental{<br>\t\tmsg:   message,<br>\t\tstack: callers(),<br>\t}<br>}<br>老师，想问一下errors&#47;code.go 的包里面的callers()函数，哪里来的","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568214,"discussion_content":"相同目录下，stack.go文件中","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651078104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340301,"user_name":"Geek_4c858e","can_delete":false,"product_type":"c1","uid":2937108,"ip_address":"","ucode":"4758B5E84BD653","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/ZdeWzNbp2uzsrib04NWIteb3hAX6vojc7X1uuW52jZupC4WvXV63lwASxEl41EHtIjFKzdyQHFRiauH0wcBzH4Zg/132","comment_is_top":false,"comment_ctime":1648731868,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648731868","product_id":100079601,"comment_content":"错误包试了几次，我想用在gin项目上，还没明白。希望再给个例子。谢谢","like_count":0},{"had_liked":false,"id":339348,"user_name":"打工人yyds","can_delete":false,"product_type":"c1","uid":2094061,"ip_address":"","ucode":"6E79D669C88379","user_header":"https://static001.geekbang.org/account/avatar/00/1f/f3/ed/46299341.jpg","comment_is_top":false,"comment_ctime":1648041301,"is_pvip":true,"replies":[{"id":"125556","content":"这里不好设置统一格式。<br>","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1651080070,"ip_address":"","comment_id":339348,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1648041301","product_id":100079601,"comment_content":"老师，我看您的源码，apiservere的gin-jwt认证那块的返回(Unauthorized)并没有使用统一错误格式。请问这块一般不设置吗？","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568253,"discussion_content":"这里不好设置统一格式。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651080070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334623,"user_name":"types","can_delete":false,"product_type":"c1","uid":2449777,"ip_address":"","ucode":"8B50927EF1804F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132","comment_is_top":false,"comment_ctime":1645022016,"is_pvip":false,"replies":[{"id":"123442","content":"跟github.com&#47;pkg&#47;errors包兼容","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1647039251,"ip_address":"","comment_id":334623,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1645022016","product_id":100079601,"comment_content":"github.com&#47;marmotedu&#47;errors是基于https:&#47;&#47;github.com&#47;pkg&#47;errors进行的修改<br>1.感觉代码风格跟pkg&#47;errors不是很一致<br>2. error包需要支持code，这个很好，但是不清楚为什么还要保留原理的withMessage, withStack, 然后花大量代码来处理， 只保留withCode相关的是否会更好，更加简洁？？ ","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555702,"discussion_content":"跟github.com/pkg/errors包兼容","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647039252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325141,"user_name":"莫林","can_delete":false,"product_type":"c1","uid":1086720,"ip_address":"","ucode":"9F733B4622E7E8","user_header":"https://static001.geekbang.org/account/avatar/00/10/95/00/a7001873.jpg","comment_is_top":false,"comment_ctime":1638841374,"is_pvip":false,"replies":[{"id":"118478","content":"内容有点多，后面考虑出个加餐。","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1639455165,"ip_address":"","comment_id":325141,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638841374","product_id":100079601,"comment_content":"老师能介绍一下如何适配gprc 的 status 响应吗？","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538618,"discussion_content":"内容有点多，后面考虑出个加餐。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639455165,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320358,"user_name":"宙斯","can_delete":false,"product_type":"c1","uid":2041396,"ip_address":"","ucode":"80DF36BAD298AD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","comment_is_top":false,"comment_ctime":1636275512,"is_pvip":true,"replies":[{"id":"116856","content":"withMessage没有用到，所以没讲","user_name":"作者回复","user_name_real":"编辑","uid":"1167883","ctime":1637061970,"ip_address":"","comment_id":320358,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636275512","product_id":100079601,"comment_content":"为什么我们在讲解错误码实现时，只讲了withCode没有讲withMessage，并且文中提到withCode有formater，但实际上只有withMessage有formater函数呢？","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530373,"discussion_content":"withMessage没有用到，所以没讲","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637061970,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316217,"user_name":"授人以🐟，不如授人以渔","can_delete":false,"product_type":"c1","uid":1193874,"ip_address":"","ucode":"BD53829E924B66","user_header":"https://static001.geekbang.org/account/avatar/00/12/37/92/961ba560.jpg","comment_is_top":false,"comment_ctime":1634202803,"is_pvip":true,"replies":[{"id":"114942","content":"是的，这个之前修改过，应该编辑没有更新上去，我找编辑再更新下。感谢反馈！","user_name":"作者回复","user_name_real":"孔令飞","uid":"1167883","ctime":1634742903,"ip_address":"","comment_id":316217,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634202803","product_id":100079601,"comment_content":"WriteResponse 函数定义中，如果 err != nil 的情况下，调用 c.JSON 后是需要 return 的。","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528315,"discussion_content":"是的，这个之前修改过，应该编辑没有更新上去，我找编辑再更新下。感谢反馈！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634742903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307829,"user_name":"陈麒文","can_delete":false,"product_type":"c1","uid":2187256,"ip_address":"","ucode":"41475885FA5AD5","user_header":"https://static001.geekbang.org/account/avatar/00/21/5f/f8/1d16434b.jpg","comment_is_top":false,"comment_ctime":1629274504,"is_pvip":false,"replies":[{"id":"112027","content":"cool！","user_name":"作者回复","user_name_real":"CK1.0","uid":"1167883","ctime":1630113389,"ip_address":"","comment_id":307829,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1629274504","product_id":100079601,"comment_content":"直接拿老师的这个errors包，用起来","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"孔令飞","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525305,"discussion_content":"cool！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630113389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302197,"user_name":"Realm","can_delete":false,"product_type":"c1","uid":1081299,"ip_address":"","ucode":"30CBEBE619D1A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/d3/b5896293.jpg","comment_is_top":false,"comment_ctime":1626134465,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1626134465","product_id":100079601,"comment_content":"很强大！很实用！","like_count":0},{"had_liked":false,"id":301458,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1625706430,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625706430","product_id":100079601,"comment_content":"优秀","like_count":0}]}