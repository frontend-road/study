{"id":157583,"title":"45 | ZooKeeper的Zab协议","content":"<p><strong>课件和Demo地址</strong></p><p><a href=\"https://gitee.com/geektime-geekbang/geekbang-zk-course\">https://gitee.com/geektime-geekbang/geekbang-zk-course</a></p>","comments":[{"had_liked":false,"id":198139,"user_name":"朱东旭","can_delete":false,"product_type":"c3","uid":1242338,"ip_address":"","ucode":"C48DD620A63868","user_header":"https://static001.geekbang.org/account/avatar/00/12/f4/e2/dbc4a5f2.jpg","comment_is_top":false,"comment_ctime":1585411637,"is_pvip":false,"replies":[{"id":79232,"content":"是的。\u0005","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1588583108,"ip_address":"","comment_id":198139,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"您好，老师，我带着&quot;如果follower节点已经与leader节点数据不一致了如何处理?&quot;这个问题来阅读源码，看到了如下逻辑：\nfollower在收到leader的proposql请求之后，会向FollowerZooKeeperServer.pendingTxns入列zxid\nfollower在收到leadr的commit请求之后,会从FollowerZooKeeperServer.pendingTxns出列zxid，如果这个出列的zxid与\ncommit请求的zxid不一致。则执行如下代码：\n        if (firstElementZxid != zxid) {\n            LOG.error(&quot;Committing zxid 0x&quot; + Long.toHexString(zxid)\n                    + &quot; but next pending txn 0x&quot;\n                    + Long.toHexString(firstElementZxid));\n            System.exit(12);\n        }\n\n这里的System.exit(12)是什么意思呢，莫非follower检测到自己有漏提交的事务，就会关闭自己？？","like_count":2,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489654,"discussion_content":"是的。\u0005","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588583108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":197573,"user_name":"朱东旭","can_delete":false,"product_type":"c3","uid":1242338,"ip_address":"","ucode":"C48DD620A63868","user_header":"https://static001.geekbang.org/account/avatar/00/12/f4/e2/dbc4a5f2.jpg","comment_is_top":false,"comment_ctime":1585386012,"is_pvip":false,"replies":[{"id":79233,"content":"过半提交意味着leader不需要等到所有的follower给响应就可以继续，但是Leader会向所有的follower发送PROPOSAL和COMMIT消息。TCP协议会使用重发机制尽力把消息发送出去。如果发生了以下两种情况之一，follower会停止运行。\n\n1. syncLimit参数控制follower可以落后leader多少tick。如果一个follower的落后时间超过了syncLimit，就会停止。\n2. 和leader的socket通讯出现了其他异常。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1588583958,"ip_address":"","comment_id":197573,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"您好,老师,过半提交意味着总有follower与leader的数据不一致,请问在不手动触发sync的情况下,follower是如何从leader同步数据解决不一致的呢.","like_count":1,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489548,"discussion_content":"过半提交意味着leader不需要等到所有的follower给响应就可以继续，但是Leader会向所有的follower发送PROPOSAL和COMMIT消息。TCP协议会使用重发机制尽力把消息发送出去。如果发生了以下两种情况之一，follower会停止运行。\n\n1. syncLimit参数控制follower可以落后leader多少tick。如果一个follower的落后时间超过了syncLimit，就会停止。\n2. 和leader的socket通讯出现了其他异常。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588583958,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2431977,"avatar":"","nickname":"Geek_0f174f","note":"","ucode":"F2A19556DE0EB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346843,"discussion_content":"那如果follower收到commit，但在处理commit的时候失败了，这样就导致follower与leader数据不一致了，这怎么办呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612080836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":303924,"user_name":"机车","can_delete":false,"product_type":"c3","uid":1881786,"ip_address":"","ucode":"CD32A645AE310A","user_header":"https://static001.geekbang.org/account/avatar/00/1c/b6/ba/f76d996b.jpg","comment_is_top":false,"comment_ctime":1627098672,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师您好，leader收到过半ACK就会提交，那一个getData请求发到没有同步的follower，这不就数据不同步了吗？zookeeper是怎么处理这种情况的呢？\n","like_count":2},{"had_liked":false,"id":150607,"user_name":"13761642169","can_delete":false,"product_type":"c3","uid":1232334,"ip_address":"","ucode":"68137695FC2120","user_header":"","comment_is_top":false,"comment_ctime":1573567344,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"看了下代码，初步跟了下 leader 和 follower 的两阶段提交，先 propose，ack 过半，则 commit。如果 follower 不 ack，ack 数不到半数，leader 会怎么处理？","like_count":0,"discussions":[{"author":{"id":1242338,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f4/e2/dbc4a5f2.jpg","nickname":"朱东旭","note":"","ucode":"C48DD620A63868","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":216269,"discussion_content":"ack不到半数，leader就会一直全局阻塞，后面的写请求无法提交。长时间不能收到半数ack，很可能leader已经\n与半数以上follower失联了，此时集群会进入崩溃恢复模式，重新开始选举。在选举期间整个zookeeper集群不\n对外提供服务。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585411123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}