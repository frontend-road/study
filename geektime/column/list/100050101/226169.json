{"id":226169,"title":"04 | ç´¢å¼•ï¼ˆä¸Šï¼‰ï¼šæ”¹è¿›çš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•åœ¨Kafkaç´¢å¼•çš„åº”ç”¨","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©ï¼Œæˆ‘æ¥å¸¦ä½ å­¦ä¹ ä¸€ä¸‹Kafkaæºç ä¸­çš„ç´¢å¼•å¯¹è±¡ï¼Œä»¥åŠæ”¹è¿›ç‰ˆäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼ˆBinary Search Algorithmï¼‰åœ¨ç´¢å¼•ä¸­çš„åº”ç”¨ã€‚</p><h2>ä¸ºä»€ä¹ˆè¦é˜…è¯»ç´¢å¼•æºç ï¼Ÿ</h2><p>å¦ç‡åœ°è¯´ï¼Œä½ åœ¨Kafkaä¸­ç›´æ¥æ¥è§¦ç´¢å¼•æˆ–ç´¢å¼•æ–‡ä»¶çš„åœºæ™¯å¯èƒ½ä¸æ˜¯å¾ˆå¤šã€‚ç´¢å¼•æ˜¯ä¸€ä¸ªå¾ˆç¥ç§˜çš„ç»„ä»¶ï¼ŒKafkaå®˜æ–¹æ–‡æ¡£ä¹Ÿæ²¡æœ‰æ€ä¹ˆæè¿‡å®ƒã€‚ä½ å¯èƒ½ä¼šè¯´ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œæˆ‘è¿˜æœ‰å¿…è¦è¯»ç´¢å¼•å¯¹è±¡çš„æºç å—ï¼Ÿå…¶å®æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼æˆ‘ç»™ä½ åˆ†äº«ä¸€ä¸ªçœŸå®çš„ä¾‹å­ã€‚</p><p>æœ‰ä¸€æ¬¡ï¼Œæˆ‘ç”¨Kafkaçš„DumpLogSegmentsç±»å»æŸ¥çœ‹åº•å±‚æ—¥å¿—æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶çš„å†…å®¹æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡â€”â€”æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶çš„å†…å®¹ä¸éœ€è¦sudoæƒé™ï¼Œè€ŒæŸ¥çœ‹ç´¢å¼•æ–‡ä»¶çš„å†…å®¹å¿…é¡»è¦æœ‰sudoæƒé™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>  $ sudo ./kafka-run-class.sh kafka.tools.DumpLogSegments  --files ./00000000000000000000.index\n    Dumping 00000000000000000000.index\n    offset: 0 position: 0\n    \n    \n    $ ./kafka-run-class.sh kafka.tools.DumpLogSegments --files 00000000000000000000.index\n    Dumping 00000000000000000000.index\n    Exception in thread &quot;main&quot; java.io.FileNotFoundException: 00000000000000000000.index (Permission denied)\n    ......\n</code></pre><p>çœ‹äº†ç´¢å¼•æºç ä¹‹åï¼Œæˆ‘æ‰çŸ¥é“ï¼ŒåŸæ¥Kafkaè¯»å–ç´¢å¼•æ–‡ä»¶æ—¶ä½¿ç”¨çš„æ‰“å¼€æ–¹å¼æ˜¯rwã€‚å®é™…ä¸Šï¼Œè¯»å–æ–‡ä»¶ä¸éœ€è¦wæƒé™ï¼Œåªè¦ræƒé™å°±è¡Œäº†ã€‚è¿™æ˜¾ç„¶æ˜¯Kafkaçš„ä¸€ä¸ªBugã€‚ä½ çœ‹ï¼Œé€šè¿‡é˜…è¯»æºç ï¼Œæˆ‘æ‰¾åˆ°äº†é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œè¿˜é¡ºä¾¿ä¿®å¤äº†Kafkaçš„ä¸€ä¸ªé—®é¢˜ï¼ˆ<a href=\"https://issues.apache.org/jira/browse/KAFKA-5104\">KAFKA-5104</a>ï¼‰ã€‚</p><p>é™¤äº†èƒ½å¸®æˆ‘ä»¬è§£å†³å®é™…é—®é¢˜ä¹‹å¤–ï¼Œç´¢å¼•è¿™ä¸ªç»„ä»¶çš„æºç è¿˜æœ‰ä¸€ä¸ªäº®ç‚¹ï¼Œé‚£å°±æ˜¯<strong>å®ƒåº”ç”¨äº†è€³ç†Ÿèƒ½è¯¦çš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•æ¥å¿«é€Ÿå®šä½ç´¢å¼•é¡¹</strong>ã€‚å…³äºç®—æ³•ï¼Œæˆ‘ä¸€ç›´è§‰å¾—å¾ˆé—æ†¾çš„æ˜¯ï¼Œ<strong>æˆ‘ä»¬å¹³æ—¶å¤ªæ³¨é‡ç®—æ³•æœ¬èº«ï¼Œå´å¿½ç•¥äº†å®ƒä»¬åœ¨å®é™…åœºæ™¯ä¸­çš„åº”ç”¨</strong>ã€‚</p><!-- [[[read_end]]] --><p>æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¤ªå¤šçš„æ’åºç®—æ³•ï¼Œä½†æ˜¯ï¼Œå¯¹äºæ™®é€šçš„åº”ç”¨å¼€å‘äººå‘˜æ¥è¯´ï¼Œäº²è‡ªä½¿ç”¨è¿™äº›ç®—æ³•å®Œæˆç¼–ç¨‹ä»»åŠ¡çš„æœºä¼šå®åœ¨å¤ªå°‘äº†ã€‚è¯´èµ·æ•°ç»„æ’åºï¼Œä½ å¯èƒ½åªè®°å¾—è°ƒç”¨Collections.sortæ–¹æ³•äº†ï¼Œä½†å®ƒåº•å±‚åº”ç”¨äº†ä»€ä¹ˆæ’åºç®—æ³•ï¼Œå…¶å®å¹¶ä¸æ¸…æ¥šã€‚</p><p>éš¾å¾—çš„æ˜¯ï¼ŒKafkaçš„ç´¢å¼•ç»„ä»¶ä¸­åº”ç”¨äº†äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œè€Œä¸”ç¤¾åŒºè¿˜é’ˆå¯¹Kafkaè‡ªèº«çš„ç‰¹ç‚¹å¯¹å…¶è¿›è¡Œäº†æ”¹è‰¯ã€‚è¿™éš¾é“ä¸å€¼å¾—æˆ‘ä»¬å¥½å¥½å­¦ä¸Šä¸€å­¦å—ï¼Ÿï¼è¯ä¸å¤šè¯´ï¼Œç°åœ¨æˆ‘ä»¬å°±å¼€å§‹å­¦ä¹ å§ã€‚</p><h2>ç´¢å¼•ç±»å›¾åŠæºæ–‡ä»¶ç»„ç»‡æ¶æ„</h2><p>åœ¨Kafkaæºç ä¸­ï¼Œè·Ÿç´¢å¼•ç›¸å…³çš„æºç æ–‡ä»¶æœ‰5ä¸ªï¼Œå®ƒä»¬éƒ½ä½äºcoreåŒ…çš„/src/main/scala/kafka/logè·¯å¾„ä¸‹ã€‚æˆ‘ä»¬ä¸€ä¸€æ¥çœ‹ä¸‹ã€‚</p><ul>\n<li>AbstractIndex.scalaï¼šå®ƒå®šä¹‰äº†æœ€é¡¶å±‚çš„æŠ½è±¡ç±»ï¼Œè¿™ä¸ªç±»å°è£…äº†æ‰€æœ‰ç´¢å¼•ç±»å‹çš„å…¬å…±æ“ä½œã€‚</li>\n<li>LazyIndex.scalaï¼šå®ƒå®šä¹‰äº†AbstractIndexä¸Šçš„ä¸€ä¸ªåŒ…è£…ç±»ï¼Œå®ç°ç´¢å¼•é¡¹å»¶è¿ŸåŠ è½½ã€‚è¿™ä¸ªç±»ä¸»è¦æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ã€‚</li>\n<li>OffsetIndex.scalaï¼šå®šä¹‰ä½ç§»ç´¢å¼•ï¼Œä¿å­˜â€œ&lt;ä½ç§»å€¼ï¼Œæ–‡ä»¶ç£ç›˜ç‰©ç†ä½ç½®&gt;â€å¯¹ã€‚</li>\n<li>TimeIndex.scalaï¼šå®šä¹‰æ—¶é—´æˆ³ç´¢å¼•ï¼Œä¿å­˜â€œ&lt;æ—¶é—´æˆ³ï¼Œä½ç§»å€¼&gt;â€å¯¹ã€‚</li>\n<li>TransactionIndex.scalaï¼šå®šä¹‰äº‹åŠ¡ç´¢å¼•ï¼Œä¸ºå·²ä¸­æ­¢äº‹åŠ¡ï¼ˆAborted Transcationï¼‰ä¿å­˜é‡è¦çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚åªæœ‰å¯ç”¨Kafkaäº‹åŠ¡åï¼Œè¿™ä¸ªç´¢å¼•æ‰æœ‰å¯èƒ½å‡ºç°ã€‚</li>\n</ul><p>è¿™äº›ç±»çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/34/e8/347480a2d1ae659d0ecf590b01d091e8.jpg?wh=2069*1169\" alt=\"\"></p><p>å…¶ä¸­ï¼ŒOffsetIndexã€TimeIndexå’ŒTransactionIndexéƒ½ç»§æ‰¿äº†AbstractIndexç±»ï¼Œè€Œä¸Šå±‚çš„LazyIndexä»…ä»…æ˜¯åŒ…è£…äº†ä¸€ä¸ªAbstractIndexçš„å®ç°ç±»ï¼Œç”¨äºå»¶è¿ŸåŠ è½½ã€‚å°±åƒæˆ‘ä¹‹å‰è¯´çš„ï¼ŒLazyIndexçš„ä½œç”¨æ˜¯ä¸ºäº†æå‡æ€§èƒ½ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåŠŸèƒ½ä¸Šçš„æ”¹è¿›ã€‚</p><p>æ‰€ä»¥ä»Šå¤©ï¼Œæˆ‘å…ˆå’Œä½ è®²ä¸€è®²AbstractIndexè¿™ä¸ªæŠ½è±¡çˆ¶ç±»çš„ä»£ç ã€‚ä¸‹èŠ‚è¯¾ï¼Œæˆ‘å†é‡ç‚¹å’Œä½ åˆ†äº«å…·ä½“çš„ç´¢å¼•å®ç°ç±»ã€‚</p><h2>AbstractIndexä»£ç ç»“æ„</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹AbstractIndexçš„ç±»å®šä¹‰ï¼š</p><pre><code>  abstract class AbstractIndex(@volatile var file: File, val baseOffset: Long, val maxIndexSize: Int = -1, val writable: Boolean) extends Closeable {\n    ......\n    }        \n</code></pre><p>AbstractIndexå®šä¹‰äº†4ä¸ªå±æ€§å­—æ®µã€‚ç”±äºæ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œå®ƒçš„æ‰€æœ‰å­ç±»è‡ªåŠ¨åœ°ç»§æ‰¿äº†è¿™4ä¸ªå­—æ®µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒKafkaæ‰€æœ‰ç±»å‹çš„ç´¢å¼•å¯¹è±¡éƒ½å®šä¹‰äº†è¿™äº›å±æ€§ã€‚æˆ‘å…ˆç»™ä½ è§£é‡Šä¸‹è¿™äº›å±æ€§çš„å«ä¹‰ã€‚</p><ol>\n<li><strong>ç´¢å¼•æ–‡ä»¶</strong>ï¼ˆfileï¼‰ã€‚æ¯ä¸ªç´¢å¼•å¯¹è±¡åœ¨ç£ç›˜ä¸Šéƒ½å¯¹åº”äº†ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ã€‚ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œè¿™ä¸ªå­—æ®µæ˜¯varå‹ï¼Œè¯´æ˜å®ƒæ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ã€‚éš¾é“ç´¢å¼•å¯¹è±¡è¿˜èƒ½åŠ¨æ€æ›´æ¢åº•å±‚çš„ç´¢å¼•æ–‡ä»¶å—ï¼Ÿæ˜¯çš„ã€‚è‡ª1.1.0ç‰ˆæœ¬ä¹‹åï¼ŒKafkaå…è®¸è¿ç§»åº•å±‚çš„æ—¥å¿—è·¯å¾„ï¼Œæ‰€ä»¥ï¼Œç´¢å¼•æ–‡ä»¶è‡ªç„¶è¦æ˜¯å¯ä»¥æ›´æ¢çš„ã€‚</li>\n<li><strong>èµ·å§‹ä½ç§»å€¼</strong>ï¼ˆbaseOffsetï¼‰ã€‚ç´¢å¼•å¯¹è±¡å¯¹åº”æ—¥å¿—æ®µå¯¹è±¡çš„èµ·å§‹ä½ç§»å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æŸ¥çœ‹Kafkaæ—¥å¿—è·¯å¾„çš„è¯ï¼Œå°±ä¼šå‘ç°ï¼Œæ—¥å¿—æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶éƒ½æ˜¯æˆç»„å‡ºç°çš„ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœæ—¥å¿—æ–‡ä»¶æ˜¯00000000000000000123.logï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€å®šè¿˜æœ‰ä¸€ç»„ç´¢å¼•æ–‡ä»¶00000000000000000123.indexã€00000000000000000123.timeindexç­‰ã€‚è¿™é‡Œçš„â€œ123â€å°±æ˜¯è¿™ç»„æ–‡ä»¶çš„èµ·å§‹ä½ç§»å€¼ï¼Œä¹Ÿå°±æ˜¯baseOffsetå€¼ã€‚</li>\n<li><strong>ç´¢å¼•æ–‡ä»¶æœ€å¤§å­—èŠ‚æ•°</strong>ï¼ˆmaxIndexSizeï¼‰ã€‚å®ƒæ§åˆ¶ç´¢å¼•æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ã€‚Kafkaæºç ä¼ å…¥è¯¥å‚æ•°çš„å€¼æ˜¯Brokerç«¯å‚æ•°segment.index.bytesçš„å€¼ï¼Œå³10MBã€‚è¿™å°±æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰Kafkaç´¢å¼•æ–‡ä»¶å¤§å°éƒ½æ˜¯10MBçš„åŸå› ã€‚</li>\n<li><strong>ç´¢å¼•æ–‡ä»¶æ‰“å¼€æ–¹å¼</strong>ï¼ˆwritableï¼‰ã€‚â€œTrueâ€è¡¨ç¤ºä»¥â€œè¯»å†™â€æ–¹å¼æ‰“å¼€ï¼Œâ€œFalseâ€è¡¨ç¤ºä»¥â€œåªè¯»â€æ–¹å¼æ‰“å¼€ã€‚å¦‚æœæˆ‘æ²¡è®°é”™çš„è¯ï¼Œè¿™ä¸ªå‚æ•°åº”è¯¥æ˜¯æˆ‘åŠ ä¸Šå»çš„ï¼Œå°±æ˜¯ä¸ºäº†ä¿®å¤æˆ‘åˆšåˆšæåˆ°çš„é‚£ä¸ªBugã€‚</li>\n</ol><p>AbstractIndexæ˜¯æŠ½è±¡çš„ç´¢å¼•å¯¹è±¡ç±»ã€‚å¯ä»¥è¯´ï¼Œå®ƒæ˜¯æ‰¿è½½ç´¢å¼•é¡¹çš„å®¹å™¨ï¼Œè€Œæ¯ä¸ªç»§æ‰¿å®ƒçš„å­ç±»è´Ÿè´£å®šä¹‰å…·ä½“çš„ç´¢å¼•é¡¹ç»“æ„ã€‚æ¯”å¦‚ï¼ŒOffsetIndexçš„ç´¢å¼•é¡¹æ˜¯&lt;ä½ç§»å€¼ï¼Œç‰©ç†ç£ç›˜ä½ç½®&gt;å¯¹ï¼ŒTimeIndexçš„ç´¢å¼•é¡¹æ˜¯&lt;æ—¶é—´æˆ³ï¼Œä½ç§»å€¼&gt;å¯¹ã€‚åŸºäºè¿™æ ·çš„è®¾è®¡ç†å¿µï¼ŒAbstractIndexç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³•entrySizeæ¥è¡¨ç¤ºä¸åŒç´¢å¼•é¡¹çš„å¤§å°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code> protected def entrySize: Int\n</code></pre><p>å­ç±»å®ç°è¯¥æ–¹æ³•æ—¶éœ€è¦ç»™å®šè‡ªå·±ç´¢å¼•é¡¹çš„å¤§å°ï¼Œå¯¹äºOffsetIndexè€Œè¨€ï¼Œè¯¥å€¼å°±æ˜¯8ï¼›å¯¹äºTimeIndexè€Œè¨€ï¼Œè¯¥å€¼æ˜¯12ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>    // OffsetIndex\n    override def entrySize = 8\n    // TimeIndex\n    override def entrySize = 12\n</code></pre><p>è¯´åˆ°è¿™å„¿ï¼Œä½ è‚¯å®šä¼šé—®ï¼Œä¸ºä»€ä¹ˆæ˜¯8å’Œ12å‘¢ï¼Ÿæˆ‘æ¥è§£é‡Šä¸€ä¸‹ã€‚</p><p>åœ¨OffsetIndexä¸­ï¼Œä½ç§»å€¼ç”¨4ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œç‰©ç†ç£ç›˜ä½ç½®ä¹Ÿç”¨4ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œæ‰€ä»¥æ€»å…±æ˜¯8ä¸ªå­—èŠ‚ã€‚ä½ å¯èƒ½ä¼šè¯´ï¼Œä½ç§»å€¼ä¸æ˜¯é•¿æ•´å‹å—ï¼Œåº”è¯¥æ˜¯8ä¸ªå­—èŠ‚æ‰å¯¹å•Šã€‚</p><p>è¿˜è®°å¾—AbstractIndexå·²ç»ä¿å­˜äº†baseOffsetäº†å—ï¼Ÿè¿™é‡Œçš„ä½ç§»å€¼ï¼Œå®é™…ä¸Šæ˜¯ç›¸å¯¹äºbaseOffsetçš„ç›¸å¯¹ä½ç§»å€¼ï¼Œå³çœŸå®ä½ç§»å€¼å‡å»baseOffsetçš„å€¼ã€‚ä¸‹èŠ‚è¯¾æˆ‘ä¼šç»™ä½ é‡ç‚¹è®²ä¸€ä¸‹å®ƒï¼Œè¿™é‡Œä½ åªéœ€è¦çŸ¥é“<strong>ä½¿ç”¨ç›¸å¯¹ä½ç§»å€¼èƒ½å¤Ÿæœ‰æ•ˆåœ°èŠ‚çœç£ç›˜ç©ºé—´</strong>å°±è¡Œäº†ã€‚è€ŒBrokerç«¯å‚æ•°log.segment.bytesæ˜¯æ•´å‹ï¼Œè¿™è¯´æ˜ï¼ŒKafkaä¸­æ¯ä¸ªæ—¥å¿—æ®µæ–‡ä»¶çš„å¤§å°ä¸ä¼šè¶…è¿‡2^32ï¼Œå³4GBï¼Œè¿™å°±è¯´æ˜åŒä¸€ä¸ªæ—¥å¿—æ®µæ–‡ä»¶ä¸Šçš„ä½ç§»å€¼å‡å»baseOffsetçš„å·®å€¼ä¸€å®šåœ¨æ•´æ•°èŒƒå›´å†…ã€‚å› æ­¤ï¼Œæºç åªéœ€è¦4ä¸ªå­—èŠ‚ä¿å­˜å°±è¡Œäº†ã€‚</p><p>åŒç†ï¼ŒTimeIndexä¸­çš„æ—¶é—´æˆ³ç±»å‹æ˜¯é•¿æ•´å‹ï¼Œå ç”¨8ä¸ªå­—èŠ‚ï¼Œä½ç§»ä¾ç„¶ä½¿ç”¨ç›¸å¯¹ä½ç§»å€¼ï¼Œå ç”¨4ä¸ªå­—èŠ‚ï¼Œå› æ­¤æ€»å…±éœ€è¦12ä¸ªå­—èŠ‚ã€‚</p><p>å¦‚æœæœ‰äººé—®ä½ ï¼ŒKafkaä¸­çš„ç´¢å¼•åº•å±‚çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿä½ å¯ä»¥å¤§å£°åœ°å‘Šè¯‰ä»–ï¼š<strong>å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œå³Javaä¸­çš„MappedByteBuffer</strong>ã€‚</p><p>ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºï¼Œå®ƒæœ‰å¾ˆé«˜çš„I/Oæ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯å¯¹äºç´¢å¼•è¿™æ ·çš„å°æ–‡ä»¶æ¥è¯´ï¼Œç”±äºæ–‡ä»¶å†…å­˜è¢«ç›´æ¥æ˜ å°„åˆ°ä¸€æ®µè™šæ‹Ÿå†…å­˜ä¸Šï¼Œè®¿é—®å†…å­˜æ˜ å°„æ–‡ä»¶çš„é€Ÿåº¦è¦å¿«äºæ™®é€šçš„è¯»å†™æ–‡ä»¶é€Ÿåº¦ã€‚</p><p>å¦å¤–ï¼Œåœ¨å¾ˆå¤šæ“ä½œç³»ç»Ÿä¸­ï¼ˆæ¯”å¦‚Linuxï¼‰ï¼Œè¿™æ®µæ˜ å°„çš„å†…å­˜åŒºåŸŸå®é™…ä¸Šå°±æ˜¯å†…æ ¸çš„é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰ã€‚è¿™å°±æ„å‘³ç€ï¼Œé‡Œé¢çš„æ•°æ®ä¸éœ€è¦é‡å¤æ‹·è´åˆ°ç”¨æˆ·æ€ç©ºé—´ï¼Œé¿å…äº†å¾ˆå¤šä¸å¿…è¦çš„æ—¶é—´ã€ç©ºé—´æ¶ˆè€—ã€‚</p><p>åœ¨AbstractIndexä¸­ï¼Œè¿™ä¸ªMappedByteBufferå°±æ˜¯åä¸ºmmapçš„å˜é‡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ç”¨æ³¨é‡Šçš„æ–¹å¼ï¼Œå¸¦ä½ æ·±å…¥äº†è§£ä¸‹è¿™ä¸ªmmapçš„ä¸»è¦æµç¨‹ã€‚</p><pre><code> @volatile\n      protected var mmap: MappedByteBuffer = {\n        // ç¬¬1æ­¥ï¼šåˆ›å»ºç´¢å¼•æ–‡ä»¶\n        val newlyCreated = file.createNewFile()\n        // ç¬¬2æ­¥ï¼šä»¥writableæŒ‡å®šçš„æ–¹å¼ï¼ˆè¯»å†™æ–¹å¼æˆ–åªè¯»æ–¹å¼ï¼‰æ‰“å¼€ç´¢å¼•æ–‡ä»¶\n        val raf = if (writable) new RandomAccessFile(file, &quot;rw&quot;) else new RandomAccessFile(file, &quot;r&quot;)\n        try {\n          if(newlyCreated) {\n            if(maxIndexSize &lt; entrySize) // é¢„è®¾çš„ç´¢å¼•æ–‡ä»¶å¤§å°ä¸èƒ½å¤ªå°ï¼Œå¦‚æœè¿ä¸€ä¸ªç´¢å¼•é¡¹éƒ½ä¿å­˜ä¸äº†ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸\n              throw new IllegalArgumentException(&quot;Invalid max index size: &quot; + maxIndexSize)\n            // ç¬¬3æ­¥ï¼šè®¾ç½®ç´¢å¼•æ–‡ä»¶é•¿åº¦ï¼ŒroundDownToExactMultipleè®¡ç®—çš„æ˜¯ä¸è¶…è¿‡maxIndexSizeçš„æœ€å¤§æ•´æ•°å€entrySize\n            // æ¯”å¦‚maxIndexSize=1234567ï¼ŒentrySize=8ï¼Œé‚£ä¹ˆè°ƒæ•´åçš„æ–‡ä»¶é•¿åº¦ä¸º1234560\n            raf.setLength(roundDownToExactMultiple(maxIndexSize, entrySize))\n          }\n    \n    \n          // ç¬¬4æ­¥ï¼šæ›´æ–°ç´¢å¼•é•¿åº¦å­—æ®µ_length\n          _length = raf.length()\n          // ç¬¬5æ­¥ï¼šåˆ›å»ºMappedByteBufferå¯¹è±¡\n          val idx = {\n            if (writable)\n              raf.getChannel.map(FileChannel.MapMode.READ_WRITE, 0, _length)\n            else\n              raf.getChannel.map(FileChannel.MapMode.READ_ONLY, 0, _length)\n          }\n          /* set the position in the index for the next entry */\n          // ç¬¬6æ­¥ï¼šå¦‚æœæ˜¯æ–°åˆ›å»ºçš„ç´¢å¼•æ–‡ä»¶ï¼Œå°†MappedByteBufferå¯¹è±¡çš„å½“å‰ä½ç½®ç½®æˆ0\n          // å¦‚æœç´¢å¼•æ–‡ä»¶å·²å­˜åœ¨ï¼Œå°†MappedByteBufferå¯¹è±¡çš„å½“å‰ä½ç½®è®¾ç½®æˆæœ€åä¸€ä¸ªç´¢å¼•é¡¹æ‰€åœ¨çš„ä½ç½®\n          if(newlyCreated)\n            idx.position(0)\n          else\n            idx.position(roundDownToExactMultiple(idx.limit(), entrySize))\n          // ç¬¬7æ­¥ï¼šè¿”å›åˆ›å»ºçš„MappedByteBufferå¯¹è±¡\n          idx\n        } finally {\n          CoreUtils.swallow(raf.close(), AbstractIndex) // å…³é—­æ‰“å¼€ç´¢å¼•æ–‡ä»¶å¥æŸ„\n        }\n      }\n</code></pre><p>è¿™äº›ä»£ç æœ€ä¸»è¦çš„ä½œç”¨å°±æ˜¯åˆ›å»ºmmapå¯¹è±¡ã€‚è¦çŸ¥é“ï¼ŒAbstractIndexå…¶ä»–å¤§éƒ¨åˆ†çš„æ“ä½œéƒ½æ˜¯å’Œmmapç›¸å…³ã€‚</p><p>æˆ‘ä¸¾ä¸¤ä¸ªç®€å•çš„å°ä¾‹å­ã€‚</p><p>ä¾‹1ï¼šå¦‚æœæˆ‘ä»¬è¦è®¡ç®—ç´¢å¼•å¯¹è±¡ä¸­å½“å‰æœ‰å¤šå°‘ä¸ªç´¢å¼•é¡¹ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰§è¡Œä¸‹åˆ—è®¡ç®—å³å¯ï¼š</p><pre><code>    protected var _entries: Int = mmap.position() / entrySize\n</code></pre><p>ä¾‹2ï¼šå¦‚æœæˆ‘ä»¬è¦è®¡ç®—ç´¢å¼•æ–‡ä»¶æœ€å¤šèƒ½å®¹çº³å¤šå°‘ä¸ªç´¢å¼•é¡¹ï¼Œåªè¦å®šä¹‰ä¸‹é¢çš„å˜é‡å°±è¡Œäº†ï¼š</p><pre><code>   private[this] var _maxEntries: Int = mmap.limit() / entrySize\n</code></pre><p>å†è¿›ä¸€æ­¥ï¼Œæœ‰äº†è¿™ä¸¤ä¸ªå˜é‡ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥åˆ¤æ–­å½“å‰ç´¢å¼•æ–‡ä»¶æ˜¯å¦å·²ç»å†™æ»¡ï¼š</p><pre><code> def isFull: Boolean = _entries &gt;= _maxEntries\n</code></pre><p>æ€»ä¹‹ï¼Œ<strong>AbstractIndexä¸­æœ€é‡è¦çš„å°±æ˜¯è¿™ä¸ªmmapå˜é‡äº†</strong>ã€‚äº‹å®ä¸Šï¼ŒAbstractIndexç»§æ‰¿ç±»å®ç°æ·»åŠ ç´¢å¼•é¡¹çš„ä¸»è¦é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯<strong>å‘mmapä¸­æ·»åŠ å¯¹åº”çš„å­—æ®µ</strong>ã€‚</p><h2>å†™å…¥ç´¢å¼•é¡¹</h2><p>ä¸‹é¢è¿™æ®µä»£ç æ˜¯OffsetIndexçš„appendæ–¹æ³•ï¼Œç”¨äºå‘ç´¢å¼•æ–‡ä»¶ä¸­å†™å…¥æ–°ç´¢å¼•é¡¹ã€‚</p><pre><code> def append(offset: Long, position: Int): Unit = {\n        inLock(lock) {\n          // ç¬¬1æ­¥ï¼šåˆ¤æ–­ç´¢å¼•æ–‡ä»¶æœªå†™æ»¡\n          require(!isFull, &quot;Attempt to append to a full index (size = &quot; + _entries + &quot;).&quot;)\n          // ç¬¬2æ­¥ï¼šå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€æ‰å…è®¸å†™å…¥ç´¢å¼•é¡¹ï¼š\n          // æ¡ä»¶1ï¼šå½“å‰ç´¢å¼•æ–‡ä»¶ä¸ºç©º\n          // æ¡ä»¶2ï¼šè¦å†™å…¥çš„ä½ç§»å¤§äºå½“å‰æ‰€æœ‰å·²å†™å…¥çš„ç´¢å¼•é¡¹çš„ä½ç§»â€”â€”Kafkaè§„å®šç´¢å¼•é¡¹ä¸­çš„ä½ç§»å€¼å¿…é¡»æ˜¯å•è°ƒå¢åŠ çš„\n          if (_entries == 0 || offset &gt; _lastOffset) {\n            trace(s&quot;Adding index entry $offset =&gt; $position to ${file.getAbsolutePath}&quot;)\n            mmap.putInt(relativeOffset(offset)) // ç¬¬3æ­¥Aï¼šå‘mmapä¸­å†™å…¥ç›¸å¯¹ä½ç§»å€¼\n            mmap.putInt(position) // ç¬¬3æ­¥Bï¼šå‘mmapä¸­å†™å…¥ç‰©ç†ä½ç½®ä¿¡æ¯\n            // ç¬¬4æ­¥ï¼šæ›´æ–°å…¶ä»–å…ƒæ•°æ®ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚å½“å‰ç´¢å¼•é¡¹è®¡æ•°å™¨_entrieså’Œå½“å‰ç´¢å¼•é¡¹æœ€æ–°ä½ç§»å€¼_lastOffset\n            _entries += 1\n            _lastOffset = offset\n            // ç¬¬5æ­¥ï¼šæ‰§è¡Œæ ¡éªŒã€‚å†™å…¥çš„ç´¢å¼•é¡¹æ ¼å¼å¿…é¡»ç¬¦åˆè¦æ±‚ï¼Œå³ç´¢å¼•é¡¹ä¸ªæ•°*å•ä¸ªç´¢å¼•é¡¹å ç”¨å­—èŠ‚æ•°åŒ¹é…å½“å‰æ–‡ä»¶ç‰©ç†å¤§å°ï¼Œå¦åˆ™è¯´æ˜æ–‡ä»¶å·²æŸå\n            require(_entries * entrySize == mmap.position(), entries + &quot; entries but file position in index is &quot; + mmap.position() + &quot;.&quot;)\n          } else {\n            // å¦‚æœç¬¬2æ­¥ä¸­ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œä¸èƒ½æ‰§è¡Œå†™å…¥ç´¢å¼•é¡¹æ“ä½œï¼ŒæŠ›å‡ºå¼‚å¸¸\n            throw new InvalidOffsetException(s&quot;Attempt to append an offset ($offset) to position $entries no larger than&quot; +\n              s&quot; the last offset appended (${_lastOffset}) to ${file.getAbsolutePath}.&quot;)\n          }\n        }\n      }\n</code></pre><p>æˆ‘ä½¿ç”¨ä¸€å¼ å›¾æ¥æ€»ç»“ä¸‹appendæ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼Œå¸Œæœ›å¯ä»¥å¸®ä½ æ›´å¿«é€Ÿåœ°æŒæ¡å®ƒçš„å®ç°ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/23/ea/236f0731ff2799f0902ff7293cf6ddea.jpg?wh=2048*2063\" alt=\"\"></p><h2>æŸ¥æ‰¾ç´¢å¼•é¡¹</h2><p>ç´¢å¼•é¡¹çš„å†™å…¥é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œéš¾ç‚¹åœ¨äºå¦‚ä½•æŸ¥æ‰¾ç´¢å¼•é¡¹ã€‚AbstractIndexå®šä¹‰äº†æŠ½è±¡æ–¹æ³•<strong>parseEntry</strong>ç”¨äºæŸ¥æ‰¾ç»™å®šçš„ç´¢å¼•é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>protected def parseEntry(buffer: ByteBuffer, n: Int): IndexEntry\n</code></pre><p>è¿™é‡Œçš„â€œnâ€è¡¨ç¤ºè¦æŸ¥æ‰¾ç»™å®šByteBufferä¸­ä¿å­˜çš„ç¬¬nä¸ªç´¢å¼•é¡¹ï¼ˆåœ¨Kafkaä¸­ä¹Ÿç§°ç¬¬nä¸ªæ§½ï¼‰ã€‚IndexEntryæ˜¯æºç å®šä¹‰çš„ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šindexKeyå’ŒindexValueï¼Œåˆ†åˆ«è¿”å›ä¸åŒç±»å‹ç´¢å¼•çš„&lt;Keyï¼ŒValue&gt;å¯¹ã€‚</p><p>OffsetIndexå®ç°parseEntryçš„é€»è¾‘å¦‚ä¸‹ï¼š</p><pre><code>   override protected def parseEntry(buffer: ByteBuffer, n: Int): OffsetPosition = {\n        OffsetPosition(baseOffset + relativeOffset(buffer, n), physical(buffer, n))\n      }\n</code></pre><p>OffsetPositionæ˜¯å®ç°IndexEntryçš„å®ç°ç±»ï¼ŒKeyå°±æ˜¯ä¹‹å‰è¯´çš„ä½ç§»å€¼ï¼Œè€ŒValueå°±æ˜¯ç‰©ç†ç£ç›˜ä½ç½®å€¼ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œä½ èƒ½çœ‹åˆ°ä»£ç è°ƒç”¨äº†relativeOffset(buffer, n) + baseOffsetè®¡ç®—å‡ºç»å¯¹ä½ç§»å€¼ï¼Œä¹‹åè°ƒç”¨physical(buffer, n)è®¡ç®—ç‰©ç†ç£ç›˜ä½ç½®ï¼Œæœ€åå°†å®ƒä»¬å°è£…åˆ°ä¸€èµ·ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç´¢å¼•é¡¹è¿”å›ã€‚</p><p><strong>æˆ‘å»ºè®®ä½ å»çœ‹ä¸‹relativeOffsetå’Œphysicalæ–¹æ³•çš„å®ç°ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•è®¡ç®—ç›¸å¯¹ä½ç§»å€¼å’Œç‰©ç†ç£ç›˜ä½ç½®ä¿¡æ¯çš„</strong>ã€‚</p><p>æœ‰äº†parseEntryæ–¹æ³•ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿæ ¹æ®ç»™å®šçš„næ¥æŸ¥æ‰¾ç´¢å¼•é¡¹äº†ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œé‚£å°±æ˜¯ï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šè¦æ‰¾çš„ç´¢å¼•é¡¹åœ¨ç¬¬nä¸ªæ§½ä¸­å‘¢ï¼Ÿå…¶å®æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªç®—æ³•é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ä»ä¸€ç»„å·²æ’åºçš„æ•°ä¸­å¿«é€Ÿå®šä½ç¬¦åˆæ¡ä»¶çš„é‚£ä¸ªæ•°ã€‚</p><h2>äºŒåˆ†æŸ¥æ‰¾ç®—æ³•</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»å·²æ’åºæ•°ç»„ä¸­å¯»æ‰¾æŸä¸ªæ•°å­—æœ€å¿«é€Ÿçš„ç®—æ³•å°±æ˜¯äºŒåˆ†æŸ¥æ‰¾äº†ï¼Œå®ƒèƒ½åšåˆ°O(lgN)çš„æ—¶é—´å¤æ‚åº¦ã€‚Kafkaçš„ç´¢å¼•ç»„ä»¶å°±åº”ç”¨äº†äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ã€‚</p><p>æˆ‘å…ˆç»™å‡ºåŸç‰ˆçš„å®ç°ç®—æ³•ä»£ç ã€‚</p><pre><code>  private def indexSlotRangeFor(idx: ByteBuffer, target: Long, searchEntity: IndexSearchEntity): (Int, Int) = {\n        // ç¬¬1æ­¥ï¼šå¦‚æœå½“å‰ç´¢å¼•ä¸ºç©ºï¼Œç›´æ¥è¿”å›&lt;-1,-1&gt;å¯¹\n        if(_entries == 0)\n          return (-1, -1)\n    \n    \n        // ç¬¬2æ­¥ï¼šè¦æŸ¥æ‰¾çš„ä½ç§»å€¼ä¸èƒ½å°äºå½“å‰æœ€å°ä½ç§»å€¼\n        if(compareIndexEntry(parseEntry(idx, 0), target, searchEntity) &gt; 0)\n          return (-1, 0)\n    \n    \n        // binary search for the entry\n        // ç¬¬3æ­¥ï¼šæ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾ç®—æ³•\n        var lo = 0\n        var hi = _entries - 1\n        while(lo &lt; hi) {\n          val mid = ceil(hi/2.0 + lo/2.0).toInt\n          val found = parseEntry(idx, mid)\n          val compareResult = compareIndexEntry(found, target, searchEntity)\n          if(compareResult &gt; 0)\n            hi = mid - 1\n          else if(compareResult &lt; 0)\n            lo = mid\n          else\n            return (mid, mid)\n        }\n    \n    \n        (lo, if (lo == _entries - 1) -1 else lo + 1)\n</code></pre><p>è¿™æ®µä»£ç çš„æ ¸å¿ƒæ˜¯ï¼Œç¬¬3æ­¥çš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ã€‚ç†Ÿæ‚‰Binary Searchçš„è¯ï¼Œä½ å¯¹è¿™æ®µä»£ç ä¸€å®šä¸ä¼šæ„Ÿåˆ°é™Œç”Ÿã€‚</p><p>è®²åˆ°è¿™é‡Œï¼Œä¼¼ä¹ä¸€åˆ‡å¾ˆå®Œç¾ï¼šKafkaç´¢å¼•åº”ç”¨äºŒåˆ†æŸ¥æ‰¾ç®—æ³•å¿«é€Ÿå®šä½å¾…æŸ¥æ‰¾ç´¢å¼•é¡¹ä½ç½®ï¼Œä¹‹åè°ƒç”¨parseEntryæ¥è¯»å–ç´¢å¼•é¡¹ã€‚ä¸è¿‡ï¼Œè¿™çœŸçš„å°±æ˜¯æ— æ‡ˆå¯å‡»çš„è§£å†³æ–¹æ¡ˆäº†å—ï¼Ÿ</p><h2>æ”¹è¿›ç‰ˆäºŒåˆ†æŸ¥æ‰¾ç®—æ³•</h2><p>æ˜¾ç„¶ä¸æ˜¯ï¼æˆ‘å‰é¢è¯´è¿‡äº†ï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿä½¿ç”¨é¡µç¼“å­˜æ¥å®ç°å†…å­˜æ˜ å°„ï¼Œè€Œç›®å‰å‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½ä½¿ç”¨LRUï¼ˆLeast Recently Usedï¼‰æˆ–ç±»ä¼¼äºLRUçš„æœºåˆ¶æ¥ç®¡ç†é¡µç¼“å­˜ã€‚</p><p>Kafkaå†™å…¥ç´¢å¼•æ–‡ä»¶çš„æ–¹å¼æ˜¯åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ å†™å…¥ï¼Œè€Œå‡ ä¹æ‰€æœ‰çš„ç´¢å¼•æŸ¥è¯¢éƒ½é›†ä¸­åœ¨ç´¢å¼•çš„å°¾éƒ¨ã€‚è¿™ä¹ˆæ¥çœ‹çš„è¯ï¼ŒLRUæœºåˆ¶æ˜¯éå¸¸é€‚åˆKafkaçš„ç´¢å¼•è®¿é—®åœºæ™¯çš„ã€‚</p><p>ä½†ï¼Œè¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œå½“Kafkaåœ¨æŸ¥è¯¢ç´¢å¼•çš„æ—¶å€™ï¼ŒåŸç‰ˆçš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•å¹¶æ²¡æœ‰è€ƒè™‘åˆ°ç¼“å­˜çš„é—®é¢˜ï¼Œå› æ­¤å¾ˆå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä¸å¿…è¦çš„ç¼ºé¡µä¸­æ–­ï¼ˆPage Faultï¼‰ã€‚æ­¤æ—¶ï¼ŒKafkaçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç­‰å¾…å¯¹åº”çš„ç´¢å¼•é¡¹ä»ç‰©ç†ç£ç›˜ä¸­è¯»å‡ºå¹¶æ”¾å…¥åˆ°é¡µç¼“å­˜ä¸­ã€‚</p><p>ä¸‹é¢æˆ‘ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹è¿™ä¸ªæƒ…å†µã€‚å‡è®¾Kafkaçš„æŸä¸ªç´¢å¼•å ç”¨äº†æ“ä½œç³»ç»Ÿé¡µç¼“å­˜13ä¸ªé¡µï¼ˆPageï¼‰ï¼Œå¦‚æœå¾…æŸ¥æ‰¾çš„ä½ç§»å€¼ä½äºæœ€åä¸€ä¸ªé¡µä¸Šï¼Œä¹Ÿå°±æ˜¯Page 12ï¼Œé‚£ä¹ˆæ ‡å‡†çš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ä¼šä¾æ¬¡è¯»å–é¡µå·0ã€6ã€9ã€11å’Œ12ï¼Œå…·ä½“çš„æ¨æ¼”æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e4/85/e4fc56a301b13afae4dda303e5366085.jpg?wh=3160*2572\" alt=\"\"></p><p>é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªé¡µä¸Šä¿å­˜äº†æˆç™¾ä¸Šåƒçš„ç´¢å¼•é¡¹æ•°æ®ã€‚éšç€ç´¢å¼•æ–‡ä»¶ä¸æ–­è¢«å†™å…¥ï¼ŒPage #12ä¸æ–­åœ°è¢«å¡«å……æ–°çš„ç´¢å¼•é¡¹ã€‚å¦‚æœæ­¤æ—¶ç´¢å¼•æŸ¥è¯¢æ–¹éƒ½æ¥è‡ªISRå‰¯æœ¬æˆ–Lagå¾ˆå°çš„æ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆè¿™äº›æŸ¥è¯¢å¤§å¤šé›†ä¸­åœ¨å¯¹Page #12çš„æŸ¥è¯¢ï¼Œå› æ­¤ï¼ŒPage #0ã€6ã€9ã€11ã€12ä¸€å®šç»å¸¸æ€§åœ°è¢«æºç è®¿é—®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›é¡µä¸€å®šä¿å­˜åœ¨é¡µç¼“å­˜ä¸Šã€‚åé¢å½“æ–°çš„ç´¢å¼•é¡¹å¡«æ»¡äº†Page #12ï¼Œé¡µç¼“å­˜å°±ä¼šç”³è¯·ä¸€ä¸ªæ–°çš„Pageæ¥ä¿å­˜ç´¢å¼•é¡¹ï¼Œå³Page #13ã€‚</p><p>ç°åœ¨ï¼Œæœ€æ–°ç´¢å¼•é¡¹ä¿å­˜åœ¨Page #13ä¸­ã€‚å¦‚æœè¦æŸ¥æ‰¾æœ€æ–°ç´¢å¼•é¡¹ï¼ŒåŸç‰ˆäºŒåˆ†æŸ¥æ‰¾ç®—æ³•å°†ä¼šä¾æ¬¡è®¿é—®Page #0ã€7ã€10ã€12å’Œ13ã€‚æ­¤æ—¶ï¼Œé—®é¢˜æ¥äº†ï¼šPage 7å’Œ10å·²ç»å¾ˆä¹…æ²¡æœ‰è¢«è®¿é—®è¿‡äº†ï¼Œå®ƒä»¬å¤§æ¦‚ç‡ä¸åœ¨é¡µç¼“å­˜ä¸­ï¼Œå› æ­¤ï¼Œä¸€æ—¦ç´¢å¼•å¼€å§‹å¾ç”¨Page #13ï¼Œå°±ä¼šå‘ç”ŸPage Faultï¼Œç­‰å¾…é‚£äº›å†·é¡µæ•°æ®ä»ç£ç›˜ä¸­åŠ è½½åˆ°é¡µç¼“å­˜ã€‚æ ¹æ®å›½å¤–ç”¨æˆ·çš„æµ‹è¯•ï¼Œè¿™ç§åŠ è½½è¿‡ç¨‹å¯èƒ½é•¿è¾¾1ç§’ã€‚</p><p>æ˜¾ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„é—®é¢˜ï¼Œå³æ¯å½“ç´¢å¼•æ–‡ä»¶å ç”¨Pageæ•°å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šå¼ºè¡Œå˜æ›´äºŒåˆ†æŸ¥æ‰¾çš„æœç´¢è·¯å¾„ï¼Œä»è€Œå‡ºç°ä¸åœ¨é¡µç¼“å­˜çš„å†·æ•°æ®å¿…é¡»è¦åŠ è½½åˆ°é¡µç¼“å­˜çš„æƒ…å½¢ï¼Œè€Œè¿™ç§åŠ è½½è¿‡ç¨‹æ˜¯éå¸¸è€—æ—¶çš„ã€‚</p><p>åŸºäºè¿™ä¸ªé—®é¢˜ï¼Œç¤¾åŒºæå‡ºäº†æ”¹è¿›ç‰ˆçš„äºŒåˆ†æŸ¥æ‰¾ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜å‹å¥½çš„æœç´¢ç®—æ³•ã€‚æ€»ä½“çš„æ€è·¯æ˜¯ï¼Œä»£ç å°†æ‰€æœ‰ç´¢å¼•é¡¹åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼šçƒ­åŒºï¼ˆWarm Areaï¼‰å’Œå†·åŒºï¼ˆCold Areaï¼‰ï¼Œç„¶ååˆ†åˆ«åœ¨è¿™ä¸¤ä¸ªåŒºåŸŸå†…æ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e1/8e/e135f0a6b3fb43ead51db4ddbad1638e.jpg?wh=2153*1355\" alt=\"\"></p><p>ä¹ä¸€çœ‹ï¼Œè¯¥ç®—æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆé«˜å¤§ä¸Šçš„æ”¹è¿›ï¼Œä»…ä»…æ˜¯æŠŠæœå¯»åŒºåŸŸåˆ†æˆäº†å†·ã€çƒ­ä¸¤ä¸ªåŒºåŸŸï¼Œç„¶åæœ‰æ¡ä»¶åœ°åœ¨ä¸åŒåŒºåŸŸæ‰§è¡Œæ™®é€šçš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ç½¢äº†ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ”¹è¿›ç‰ˆç®—æ³•æä¾›äº†ä¸€ä¸ªé‡è¦çš„ä¿è¯ï¼š<strong>å®ƒèƒ½ä¿è¯é‚£äº›ç»å¸¸éœ€è¦è¢«è®¿é—®çš„Pageç»„åˆæ˜¯å›ºå®šçš„</strong>ã€‚</p><p>æƒ³æƒ³åˆšæ‰çš„ä¾‹å­ï¼ŒåŒæ ·æ˜¯æŸ¥è¯¢æœ€çƒ­çš„é‚£éƒ¨åˆ†æ•°æ®ï¼Œä¸€æ—¦ç´¢å¼•å ç”¨äº†æ›´å¤šçš„Pageï¼Œè¦éå†çš„Pageç»„åˆå°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚è¿™æ˜¯å¯¼è‡´æ€§èƒ½ä¸‹é™çš„ä¸»è¦åŸå› ã€‚</p><p>è¿™ä¸ªæ”¹è¿›ç‰ˆç®—æ³•çš„æœ€å¤§å¥½å¤„åœ¨äºï¼Œ<strong>æŸ¥è¯¢æœ€çƒ­é‚£éƒ¨åˆ†æ•°æ®æ‰€éå†çš„Pageæ°¸è¿œæ˜¯å›ºå®šçš„ï¼Œå› æ­¤å¤§æ¦‚ç‡åœ¨é¡µç¼“å­˜ä¸­ï¼Œä»è€Œé¿å…æ— æ„ä¹‰çš„Page Fault</strong>ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å®é™…çš„ä»£ç ã€‚æˆ‘ç”¨æ³¨é‡Šçš„æ–¹å¼è§£é‡Šäº†æ”¹è¿›ç‰ˆç®—æ³•çš„å®ç°é€»è¾‘ã€‚ä¸€æ—¦ä½ äº†è§£äº†å†·åŒºçƒ­åŒºçš„åˆ†å‰²åŸç†ï¼Œå‰©ä¸‹çš„å°±ä¸éš¾äº†ã€‚</p><pre><code>   private def indexSlotRangeFor(idx: ByteBuffer, target: Long, searchEntity: IndexSearchEntity): (Int, Int) = {\n        // ç¬¬1æ­¥ï¼šå¦‚æœç´¢å¼•ä¸ºç©ºï¼Œç›´æ¥è¿”å›&lt;-1,-1&gt;å¯¹\n        if(_entries == 0)\n          return (-1, -1)\n    \n    \n        // å°è£…åŸç‰ˆçš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•\n        def binarySearch(begin: Int, end: Int) : (Int, Int) = {\n          // binary search for the entry\n          var lo = begin\n          var hi = end\n          while(lo &lt; hi) {\n            val mid = (lo + hi + 1) &gt;&gt;&gt; 1\n            val found = parseEntry(idx, mid)\n            val compareResult = compareIndexEntry(found, target, searchEntity)\n            if(compareResult &gt; 0)\n              hi = mid - 1\n            else if(compareResult &lt; 0)\n              lo = mid\n            else\n              return (mid, mid)\n          }\n          (lo, if (lo == _entries - 1) -1 else lo + 1)\n        }\n    \n    \n        // ç¬¬3æ­¥ï¼šç¡®è®¤çƒ­åŒºé¦–ä¸ªç´¢å¼•é¡¹ä½äºå“ªä¸ªæ§½ã€‚_warmEntrieså°±æ˜¯æ‰€è°“çš„åˆ†å‰²çº¿ï¼Œç›®å‰å›ºå®šä¸º8192å­—èŠ‚å¤„\n        // å¦‚æœæ˜¯OffsetIndexï¼Œ_warmEntries = 8192 / 8 = 1024ï¼Œå³ç¬¬1024ä¸ªæ§½\n        // å¦‚æœæ˜¯TimeIndexï¼Œ_warmEntries = 8192 / 12 = 682ï¼Œå³ç¬¬682ä¸ªæ§½\n        val firstHotEntry = Math.max(0, _entries - 1 - _warmEntries)\n        // ç¬¬4æ­¥ï¼šåˆ¤æ–­targetä½ç§»å€¼åœ¨çƒ­åŒºè¿˜æ˜¯å†·åŒº\n        if(compareIndexEntry(parseEntry(idx, firstHotEntry), target, searchEntity) &lt; 0) {\n          return binarySearch(firstHotEntry, _entries - 1) // å¦‚æœåœ¨çƒ­åŒºï¼Œæœç´¢çƒ­åŒº\n        }\n    \n    \n        // ç¬¬5æ­¥ï¼šç¡®ä¿targetä½ç§»å€¼ä¸èƒ½å°äºå½“å‰æœ€å°ä½ç§»å€¼\n        if(compareIndexEntry(parseEntry(idx, 0), target, searchEntity) &gt; 0)\n          return (-1, 0)\n    \n    \n        // ç¬¬6æ­¥ï¼šå¦‚æœåœ¨å†·åŒºï¼Œæœç´¢å†·åŒº\n        binarySearch(0, firstHotEntry)\n</code></pre><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ è¯¦ç»†å­¦ä¹ äº†Kafkaä¸­çš„ç´¢å¼•æœºåˆ¶ï¼Œä»¥åŠç¤¾åŒºå¦‚ä½•åº”ç”¨äºŒåˆ†æŸ¥æ‰¾ç®—æ³•å®ç°å¿«é€Ÿå®šä½ç´¢å¼•é¡¹ã€‚æœ‰ä¸¤ä¸ªé‡ç‚¹ï¼Œä½ ä¸€å®šè¦è®°ä½ã€‚</p><ol>\n<li>AbstractIndexï¼šè¿™æ˜¯Kafkaæ‰€æœ‰ç±»å‹ç´¢å¼•çš„æŠ½è±¡çˆ¶ç±»ï¼Œé‡Œé¢çš„mmapå˜é‡æ˜¯å®ç°ç´¢å¼•æœºåˆ¶çš„æ ¸å¿ƒï¼Œä½ ä¸€å®šè¦æŒæ¡å®ƒã€‚</li>\n<li>æ”¹è¿›ç‰ˆäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼šç¤¾åŒºåœ¨æ ‡å‡†åŸç‰ˆçš„åŸºç¡€ä¸Šï¼Œå¯¹äºŒåˆ†æŸ¥æ‰¾ç®—æ³•æ ¹æ®å®é™…è®¿é—®åœºæ™¯åšäº†å®šåˆ¶åŒ–çš„æ”¹è¿›ã€‚ä½ éœ€è¦ç‰¹åˆ«å…³æ³¨æ”¹è¿›ç‰ˆåœ¨æå‡ç¼“å­˜æ€§èƒ½æ–¹é¢åšäº†å“ªäº›åŠªåŠ›ã€‚æ”¹è¿›ç‰ˆèƒ½å¤Ÿæœ‰æ•ˆåœ°æå‡é¡µç¼“å­˜çš„ä½¿ç”¨ç‡ï¼Œä»è€Œåœ¨æ•´ä½“ä¸Šé™ä½ç‰©ç†I/Oï¼Œç¼“è§£ç³»ç»Ÿè´Ÿè½½ç“¶é¢ˆã€‚ä½ æœ€å¥½èƒ½å¤Ÿä»ç´¢å¼•è¿™ä¸ªç»´åº¦å»æ€è€ƒç¤¾åŒºåœ¨è¿™æ–¹é¢æ‰€åšçš„å·¥ä½œã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/31/22/31e35198818b0bbc05ef333b5897b022.jpg?wh=2581*3727\" alt=\"\"></p><p>å®é™…ä¸Šï¼Œæ— è®ºæ˜¯AbstractIndexè¿˜æ˜¯å®ƒä½¿ç”¨çš„äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œå®ƒä»¬éƒ½å±äºKafkaç´¢å¼•å…±æ€§çš„ä¸œè¥¿ï¼Œå³æ‰€æœ‰Kafkaç´¢å¼•éƒ½å…·å¤‡è¿™äº›ç‰¹ç‚¹æˆ–ç‰¹æ€§ã€‚é‚£ä¹ˆï¼Œä½ æ˜¯å¦æƒ³äº†è§£ä¸åŒç±»å‹ç´¢å¼•ä¹‹é—´çš„åŒºåˆ«å‘¢ï¼Ÿæ¯”å¦‚ä½ç§»ç´¢å¼•å’Œæ—¶é—´æˆ³ç´¢å¼•æœ‰å“ªäº›å¼‚åŒä¹‹å¤„ã€‚è¿™äº›é—®é¢˜çš„ç­”æ¡ˆæˆ‘ä¼šåœ¨ä¸‹èŠ‚è¯¾æ­æ™“ï¼Œä½ åƒä¸‡ä¸è¦é”™è¿‡ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>ç›®å‰ï¼Œå†·åŒºå’Œçƒ­åŒºçš„åˆ†å‰²çº¿è®¾å®šåœ¨8192å­—èŠ‚å¤„ï¼Œè¯·ç»“åˆæºç æ³¨é‡Šä»¥åŠä½ è‡ªå·±çš„ç†è§£ï¼Œè®²ä¸€è®²ä¸ºä»€ä¹ˆè¦è®¾ç½®æˆ8192ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":208745,"user_name":"Jonah","can_delete":false,"product_type":"c1","uid":1079507,"ip_address":"","ucode":"2C4799BD2FF0DE","user_header":"https://static001.geekbang.org/account/avatar/00/10/78/d3/1dc40aa2.jpg","comment_is_top":true,"comment_ctime":1587432129,"is_pvip":true,"replies":[{"id":"77977","content":"ğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587434518,"ip_address":"","comment_id":208745,"utype":1}],"discussion_count":1,"race_medal":0,"score":"9.2233720470321009e+18","product_id":100050101,"comment_content":"æŒ‰ç…§æ³¨é‡Šè®²çš„åˆ†æï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¿è¯çƒ­åŒºçš„é¡µæ•°å°äº3ä¸ªï¼Œå¦å¤–ä¿è¯in-sync çš„æŸ¥æ‰¾éƒ½èƒ½å‘½ä¸­","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492605,"discussion_content":"ğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587434518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209767,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1587610771,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720427373998e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬é‡ç‚¹äº†è§£äº†æ—¥å¿—å¯¹è±¡çš„å¸¸è§æ“ä½œï¼Œè¯¾åæˆ‘è®©ä½ æ€è€ƒä¸‹èƒ½å¦ä¸ºLogæºç æ·»åŠ ä¸€ä¸ªç®€ä¾¿æ–¹æ³•ï¼Œç»Ÿè®¡ä»‹äºé«˜æ°´ä½å€¼å’ŒLEOå€¼ä¹‹é—´çš„æ¶ˆæ¯æ€»æ•°ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„ç­”æ¡ˆï¼š<br>private[log] def messageCountBetweenHWAndLEO: Long = {<br>    logEndOffset - highWatermarkMetadata.messageOffset<br>  }<br><br><br>okayï¼Œä½ æ˜¯æ€ä¹ˆè€ƒè™‘çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":1},{"had_liked":false,"id":263164,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1606028337,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18785897521","product_id":100050101,"comment_content":"å¯¹äºè¿™ä¸ªç‰¹å®šäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ç”±äºä¹‹å‰çš„ç†è§£é”™è¯¯ï¼Œæˆ‘åˆé‡æ–°é˜…è¯»äº†ä¸€éæºç ï¼Œå¾—å‡ºä»¥ä¸‹å‡ ä¸ªå†…å®¹ç‚¹ï¼š<br>1ã€è¿™ä¸ªé—®é¢˜æ˜¯é’ˆå¯¹ã€KAFKA-6432ã€‘è¿™ä¸ªé—®é¢˜çš„ä¼˜åŒ–ï¼ˆä¼˜åŒ–ç´¢å¼•lookupçš„ç¼“å­˜å‹å¥½æ€§ï¼‰<br>2ã€åˆ’åˆ†ä¸º8kbçš„æœ€ä¸»è¦åŸå› æ˜¯å› ä¸ºç¡¬ä»¶å‚å•†æ¶æ„ä¸åŒçš„åŸå› ï¼šx86-32, x86-64, MIPS,SPARC, Power, ARMè¿™äº›æ¶æ„åŸºæœ¬ä¸Šéƒ½æ˜¯4kbçš„page size ã€‚ä¸€èˆ¬è¿™äº›æ¶æ„ä¸‹æœ€å¤šåªå¯èƒ½å­˜åœ¨ ã€3 æˆ–è€…æ›´å°‘ã€‘çš„page å±äºæ‰€è°“çš„ warm page æ‰€æœ‰ 8kbæ˜¯ä¸€ç§æŠ˜è¡·åçš„å†³å®š<br>3ã€è¿™æ®µæºç çš„ä½œè€…æœ‰æç¤ºåˆ°è¿™å—ä»£ç æ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œå› ä¸ºæ²¡åŠæ³•ä¸»åŠ¨è§¦å‘page cache æ‰€ä»¥ç›®å‰åªèƒ½æŒ‰ç…§å‚å•†æ ‡å‡†æ¥åš<br>4ã€è¿™æ®µæºç çš„ä½œè€…æœ‰æåˆ°ï¼Œæœªæ¥å¯ä»¥é€šè¿‡ä¸€ä¸ªåå°çº¿ç¨‹çš„æ–¹å¼ä¸æ–­çš„å»æŠŠ page å˜æˆwarm pageï¼Œè¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼šAã€èƒ½å¤Ÿæ”¯æŒæ›´å¤§è¶…è¿‡8kbçš„warm åŒº   Bã€åœ¨è¾ƒä½QPSçš„ topic-partitions ä¹Ÿèƒ½ä½¿ç”¨page cache çš„çº¢åˆ©<br><br><br>æˆ‘ä¸ªäººçš„çœ‹æ³•ï¼š<br>1ã€kafkaä¸­å¦‚æœå­˜åœ¨å¤ªå¤šçš„ä½QPSçš„topicï¼Œå…¶å®ä¿®å¤è¿™ä¸ªé—®é¢˜ä½œè€…çš„æ–¹æ³•ä¸å¤ªä¼˜é›…<br>2ã€æ˜¯å¦å¯ä»¥æ•ˆä»¿mysqlçš„æ–¹å¼ï¼Œè‡ªè¡Œå®ç°ç‰¹æ®Šçš„page cache å‘¢ï¼Ÿè¿™æ ·ä¸ä¼šè¢«å‚å•†çº¦æŸï¼ŒåŒæ—¶èƒ½æœ‰æ›´åŠ çµæ´»çš„å®šåˆ¶","like_count":5,"discussions":[{"author":{"id":2826174,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/1f/be/402a04e5.jpg","nickname":"åº·å®","note":"","ucode":"00EC7266C1619B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":408687,"discussion_content":"é’ˆå¯¹ç¬¬2ç‚¹ï¼Œé„™äººä¹Ÿæœ‰åŒæ„Ÿï¼Œæ¯•ç«Ÿpage cacheä¸æ˜¯ä¸€ç§ä¸¥è°¨çš„å¯ä¾èµ–æ¨¡å¼ï¼›ä¸è¿‡å¦‚æœè‡ªå·±ç»´æŠ¤ä¸€å¥—cacheï¼Œæ˜¯å¦å­˜åœ¨å†…å­˜é‡å¤ä½¿ç”¨çš„é—®é¢˜ï¼Œæ¯•ç«Ÿè‡ªå·±çš„cacheè·Ÿæ“ä½œç³»ç»Ÿçš„page cacheéƒ½å ç”¨çš„æ˜¯æœºå™¨çš„ç‰©ç†å†…å­˜","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635303378,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":219631,"user_name":"ä¸œé£ç¬¬ä¸€æ","can_delete":false,"product_type":"c1","uid":1402697,"ip_address":"","ucode":"0CD0F62E90DAD8","user_header":"https://static001.geekbang.org/account/avatar/00/15/67/49/864dba17.jpg","comment_is_top":false,"comment_ctime":1590053584,"is_pvip":false,"replies":[{"id":"81189","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1590128966,"ip_address":"","comment_id":219631,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18769922768","product_id":100050101,"comment_content":"è¯¾åä½œä¸šï¼š1. ä¸»æµçš„å¤„ç†å™¨æ¶æ„ä¸­4096ä¸€èˆ¬æ˜¯æœ€å°çš„é¡µé¢å¤§å°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯é¡µæ•°å°äºä¸‰ï¼Œåœ¨äºŒåˆ†æŸ¥æ‰¾æ—¶ï¼Œå¯ä»¥å‘½ä¸­æ‰€æœ‰çš„é¡µé¢ã€‚<br>2. 8KBçš„ç´¢å¼•ï¼Œå¯ä»¥è¦†ç›–4Mæ•°æ®ï¼ˆoffset indexï¼‰æˆ–è€…2.7Mæ•°æ®ï¼ˆtime indexï¼‰è¶³å¤Ÿä¿è¯in-syncçš„æŸ¥æ‰¾çš„å†…å®¹éƒ½åœ¨çƒ­åŒº","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495881,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590128966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213219,"user_name":"å°å´”","can_delete":false,"product_type":"c1","uid":1104958,"ip_address":"","ucode":"4E537416787752","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1588334745,"is_pvip":false,"replies":[{"id":"79124","content":"å—¯ï¼Œæ˜¯è¿™ä¸ªæ„æ€ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588399050,"ip_address":"","comment_id":213219,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18768203929","product_id":100050101,"comment_content":"å†·çƒ­åˆ†ç¦»å¦‚ä½•ç”Ÿæ•ˆçš„ï¼Œåˆšå¼€å§‹çœ‹æ–‡ç« æ²¡çœ‹æ‡‚ï¼Œåˆç¿»äº†æºç æ³¨é‡Šï¼Œæ‰æ˜ç™½äº†ã€‚è¿™é‡Œæ¢³ç†ä¸€ä¸‹æˆ‘è§‰å¾—æ›´æ˜“æ‡‚çš„è¯´æ³•ï¼šå¤§éƒ¨åˆ†æŸ¥è¯¢é›†ä¸­åœ¨ç´¢å¼•é¡¹å°¾éƒ¨-&gt;æŠŠå°¾éƒ¨çš„8192å­—èŠ‚è®¾ç½®ä¸ºçƒ­åŒºï¼Œæ°¸è¿œä¿å­˜åœ¨ç¼“å­˜ä¸­-&gt;å¦‚æœæŸ¥è¯¢targetåœ¨çƒ­åŒºç´¢å¼•é¡¹èŒƒå›´ï¼Œç›´æ¥æŸ¥çƒ­åŒºï¼Œé¿å…é¡µä¸­æ–­ã€‚","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493714,"discussion_content":"å—¯ï¼Œæ˜¯è¿™ä¸ªæ„æ€ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588399050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209442,"user_name":"ByteFeng","can_delete":false,"product_type":"c1","uid":1162364,"ip_address":"","ucode":"BD852FAA947726","user_header":"https://static001.geekbang.org/account/avatar/00/11/bc/7c/f6a6fb47.jpg","comment_is_top":false,"comment_ctime":1587549728,"is_pvip":false,"replies":[{"id":"78227","content":"å—¯å—¯ï¼Œä¹‹å‰ç¡®å®æœ‰è¿‡å¯¹ç…§ç€IDEAç›´æ¥è®²æºç çš„æƒ³æ³•ã€‚å› ä¸ºè§‰å¾—ç›´æ¥æ¼”ç¤ºæ€ä¹ˆæ­å»ºç¯å¢ƒã€æ€ä¹ˆä¿®æ”¹æºç ã€æ€ä¹ˆå†™æµ‹è¯•ç”¨ä¾‹å¯èƒ½æ¯”æ–‡å­—æ¥çš„æœ‰å†²å‡»åŠ›ã€‚åç»­æˆ‘ä¼šè®¤çœŸè€ƒè™‘çœ‹çœ‹çš„ã€‚è°¢è°¢æ‚¨çš„å»ºè®®ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587604552,"ip_address":"","comment_id":209442,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18767418912","product_id":100050101,"comment_content":"èƒ¡å¤•è€å¸ˆï¼Œä½ èƒ½ä¸èƒ½å‡ºä¸ªkafkaè§†é¢‘è¯¾ç¨‹å‘€???æ–‡å­—ä¸“æ ç†è®ºæ€§æ¯”è¾ƒå¼ºï¼Œè§†é¢‘è¯¾ç¨‹çš„å®æˆ˜æ€§æ¯”è¾ƒå¼ºã€‚ã€‚ã€‚ã€‚ã€‚","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492798,"discussion_content":"å—¯å—¯ï¼Œä¹‹å‰ç¡®å®æœ‰è¿‡å¯¹ç…§ç€IDEAç›´æ¥è®²æºç çš„æƒ³æ³•ã€‚å› ä¸ºè§‰å¾—ç›´æ¥æ¼”ç¤ºæ€ä¹ˆæ­å»ºç¯å¢ƒã€æ€ä¹ˆä¿®æ”¹æºç ã€æ€ä¹ˆå†™æµ‹è¯•ç”¨ä¾‹å¯èƒ½æ¯”æ–‡å­—æ¥çš„æœ‰å†²å‡»åŠ›ã€‚åç»­æˆ‘ä¼šè®¤çœŸè€ƒè™‘çœ‹çœ‹çš„ã€‚è°¢è°¢æ‚¨çš„å»ºè®®ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587604552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262620,"user_name":"Geek_14e7f8","can_delete":false,"product_type":"c1","uid":1798629,"ip_address":"","ucode":"5DF998E9F25FF9","user_header":"","comment_is_top":false,"comment_ctime":1605782221,"is_pvip":false,"replies":[{"id":"95337","content":"å•ä¸ªæ—¥å¿—æ®µæ˜¯2GBï¼Œæ—¥å¿—å½“ç„¶å¯ä»¥æ— é™å¤§å°","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1605838114,"ip_address":"","comment_id":262620,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5900749517","product_id":100050101,"comment_content":"è€Œ Broker ç«¯å‚æ•° log.segment.bytes æ˜¯æ•´å‹ï¼Œè¿™è¯´æ˜ï¼ŒKafka ä¸­æ¯ä¸ªæ—¥å¿—æ®µæ–‡ä»¶çš„å¤§å°ä¸ä¼šè¶…è¿‡ 2^32ï¼Œå³ 4GBï¼Œè¿™å°±è¯´æ˜åŒä¸€ä¸ªæ—¥å¿—æ®µæ–‡ä»¶ä¸Šçš„ä½ç§»å€¼å‡å» baseOffset çš„å·®å€¼ä¸€å®šåœ¨æ•´æ•°èŒƒå›´å†…ã€‚<br><br>ä½ å¥½ï¼Œ å…³äºè¿™é‡Œæ—¥å¿—å¤§å°æœ‰ç‚¹ç–‘é—®ï¼Œjavaä¸­æ•´å½¢æœ€å¤§å€¼æ˜¯ 2^31 - 1 ï¼Œæ‰€ä»¥å•ä¸ªæ—¥å¿—æœ€å¤§åº”è¯¥æ˜¯2Gå§ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509900,"discussion_content":"å•ä¸ªæ—¥å¿—æ®µæ˜¯2GBï¼Œæ—¥å¿—å½“ç„¶å¯ä»¥æ— é™å¤§å°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605838114,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241471,"user_name":"å¼ å­æ¶µ","can_delete":false,"product_type":"c1","uid":1743397,"ip_address":"","ucode":"57C509EA32B916","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg","comment_is_top":false,"comment_ctime":1597304924,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5892272220","product_id":100050101,"comment_content":"è¯»å®Œè¿™ç« çœ‹åˆ°é—®é¢˜çš„æ—¶å€™ï¼Œå®Œå…¨æ²¡æœ‰å¤´ç»ªï¼ŒäºŒåˆ†ç®—æ³•åŠç´¢å¼•å†·çƒ­åˆ†åŒºæ€æƒ³éƒ½æ‡‚ï¼Œè¿˜æ˜¯è®¡ç®—æœºåŸºç¡€æ¯”è¾ƒå·®ï¼Œå¯¹äº8192è¿™æ ·çš„æ•°æ®ä¸å¤ªæ•æ„Ÿï¼Œè¦ç»§ç»­åŠ æ²¹","like_count":1},{"had_liked":false,"id":232280,"user_name":"å†¯ç£Š","can_delete":false,"product_type":"c1","uid":1855112,"ip_address":"","ucode":"4FFB8B984269FB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIYj6Zv3ibicLebxo7lsPMEwpBynHkYp8pLc3FcltUfmOBSRxpmicEwIAgP9OvSKnGGdaxwsZ7yiciaSsQ/132","comment_is_top":false,"comment_ctime":1593942892,"is_pvip":false,"replies":[{"id":"85768","content":"å—¯å—¯ï¼Œä¼šæœ‰çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593998974,"ip_address":"","comment_id":232280,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5888910188","product_id":100050101,"comment_content":"æ—¥å¿—æ®µæœ‰ä¸ªå‚æ•°indexIntervalBytesï¼Œ å¯ä»¥ç†è§£ä¸ºæ’äº†å¤šå°‘æ¡æ¶ˆæ¯ä¹‹åå†å»ºä¸€ä¸ªç´¢å¼•ï¼Œç”±æ­¤çœ‹å‡ºkafkaçš„ç´¢å¼•å…¶å®æ˜¯ç¨€ç–ç´¢å¼•ã€‚é‚£ä¹Ÿå°±æ˜¯è¯´äºŒåˆ†æŸ¥æ‰¾ä¹‹åï¼Œè¿˜æœ‰ä¸€ä¸ªé¡ºåºéå†æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶çš„è¿‡ç¨‹ã€‚æˆ‘è¿™æ ·ç†è§£å¯¹å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500593,"discussion_content":"å—¯å—¯ï¼Œä¼šæœ‰çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593998974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210525,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1587783878,"is_pvip":false,"replies":[{"id":"78470","content":"1. æ‰€ä»¥ä¸è¦è´¸ç„¶ä¿®æ”¹è¿™ä¸ªé»˜è®¤å€¼ï¼šï¼‰<br><br>2. è¿™ä¸ªç®—æ³•ä¿è¯ä¸»è¦ä¿è¯non-lagging consumerçš„æ€§èƒ½ã€‚lagging consumerç¡®å®äº«å—ä¸åˆ°ï¼Œç”šè‡³æ˜¯æ‹–ç´¯å…¶ä»–consumerï¼Œå› ä¸ºå®ƒä¼šâ€œæ±¡æŸ“â€é¡µç¼“å­˜","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587868034,"ip_address":"","comment_id":210525,"utype":1}],"discussion_count":5,"race_medal":0,"score":"5882751174","product_id":100050101,"comment_content":"æˆ‘å¯¹8192çš„ç†è§£æ˜¯è¿™æ ·çš„ï¼š<br>brokeré»˜è®¤çš„ç´¢å¼•æ–‡ä»¶å¤§å°segment.index.bytes = 10 MBï¼Œ8192åˆšå¥½å¤§çº¦æ˜¯10MBçš„80%ï¼Œæ ¹æ®2&#47;8å®šå¾‹ï¼Œæœ€æ–°çš„20%çš„æ•°æ®å¯èƒ½ä¼šæ˜¯çƒ­ç‚¹æ•°æ®æ‰€ä»¥è®¾ç½®ä¸º8192åˆ‡åˆ†å†·åŒºå’Œçƒ­åŒºã€‚<br><br>ä½†æ˜¯è¿™é‡Œä¹Ÿæœ‰ä¸¤ä¸ªé—®é¢˜å¸Œæœ›èƒ½å¾—åˆ°è€å¸ˆçš„çœ‹æ³•ï¼š<br>1ã€å¦‚æœæˆ‘ä¿®æ”¹äº†segment.index.byteså¤§å°æˆ–è€…ä¿®æ”¹äº†Linuxçš„é¡µç¼“å­˜å¤§å°è®¾ç½®ï¼Œä¼šä¸ä¼šå¯¼è‡´å†·çƒ­åŒºæŸ¥è¯¢æ€§èƒ½å¤±å»äº†ï¼Œæ¯•ç«Ÿä»£ç æ˜¯å†™æ­»çš„8196.<br>2ã€å¦‚æœæˆ‘é¢‘ç¹èŒƒå›´å†·åŒºï¼Œå½“é¡µç¼“å­˜æ»¡çš„æ—¶å€™ï¼Œçƒ­åŒºæœ¬èº«ä¹Ÿä¼šå¤±æ•ˆå‡å…¥æœ‰ä¸¤ä¸ªconsumer-groupï¼Œä¸€å…±æ¶ˆè´¹èƒ½åŠ›å¼ºçš„åœ¨æ¶ˆæ¯å‘é€å‡ºæ¥åèƒ½ç«‹å³æ¶ˆè´¹ï¼Œå¦ä¸€ä¸ªæ¶ˆè´¹èƒ½åŠ›å¼±ï¼Œè¿˜åœ¨æ¶ˆè´¹æ˜¨å¤©çš„æ•°æ®ï¼Œçš„æƒ…å†µä¸‹åº”è¯¥è¿˜æ˜¯ä¼šå‡ºç°è¿™ç§é¡µç¼“å­˜å¸¦æ¥çš„æ€§èƒ½é—®é¢˜å§","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493047,"discussion_content":"1. æ‰€ä»¥ä¸è¦è´¸ç„¶ä¿®æ”¹è¿™ä¸ªé»˜è®¤å€¼ï¼šï¼‰\n\n2. è¿™ä¸ªç®—æ³•ä¿è¯ä¸»è¦ä¿è¯non-lagging consumerçš„æ€§èƒ½ã€‚lagging consumerç¡®å®äº«å—ä¸åˆ°ï¼Œç”šè‡³æ˜¯æ‹–ç´¯å…¶ä»–consumerï¼Œå› ä¸ºå®ƒä¼šâ€œæ±¡æŸ“â€é¡µç¼“å­˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587868034,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1386201,"avatar":"https://static001.geekbang.org/account/avatar/00/15/26/d9/f7e96590.jpg","nickname":"yes","note":"","ucode":"612BF6884ED6CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286873,"discussion_content":"è€å“¥ï¼Œ1MB=1024KBï¼Œ8192å­—èŠ‚=8KB","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1593314517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1451391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","nickname":"æ›¾è½¼éºŸ","note":"","ucode":"D418371AC11270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1386201,"avatar":"https://static001.geekbang.org/account/avatar/00/15/26/d9/f7e96590.jpg","nickname":"yes","note":"","ucode":"612BF6884ED6CC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301303,"discussion_content":"ä¸å¥½æ„æ€æˆ‘ç†è§£é”™äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598487191,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":286873,"ip_address":""},"score":301303,"extra":""}]},{"author":{"id":1181055,"avatar":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","nickname":"z.l","note":"","ucode":"805CC5784D3F76","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301278,"discussion_content":"è€å“¥ï¼Œ1MB=1024KBï¼Œ8192å­—èŠ‚=8KB","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598457163,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1451391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","nickname":"æ›¾è½¼éºŸ","note":"","ucode":"D418371AC11270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181055,"avatar":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","nickname":"z.l","note":"","ucode":"805CC5784D3F76","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301302,"discussion_content":"ä¸å¥½æ„æ€æˆ‘ç†è§£é”™äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598487183,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":301278,"ip_address":""},"score":301302,"extra":""}]}]},{"had_liked":false,"id":292622,"user_name":"QAQ","can_delete":false,"product_type":"c1","uid":2307937,"ip_address":"","ucode":"6E47215CBB81F5","user_header":"https://static001.geekbang.org/account/avatar/00/23/37/61/51e10a30.jpg","comment_is_top":false,"comment_ctime":1620899776,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620899776","product_id":100050101,"comment_content":"å’Œmysqlçš„çƒ­ç‚¹æ•°æ®æƒ³æ³•ç±»ä¼¼","like_count":1},{"had_liked":false,"id":259748,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1604825092,"is_pvip":false,"replies":[{"id":"94405","content":"å—¯å—¯ï¼Œæºç çš„ç¡®åœ¨ä¸æ–­æ¼”è¿›ä¸­ã€‚ç°åœ¨çš„ä¼˜åŒ–æ€è·¯æ˜¯æœç€å»¶è¿Ÿåˆå§‹åŒ–ç´¢å¼•ï¼ŒæœŸæœ›å¿«é€Ÿç¼©çŸ­brokerå¯åŠ¨æ—¶é—´","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1604886404,"ip_address":"","comment_id":259748,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1604825092","product_id":100050101,"comment_content":"è€å¸ˆï¼ŒTransactionIndexå¥½åƒå·²ç»æ²¡æœ‰ç»§æ‰¿äºï¼ŒAbstractIndexäº†ã€‚TransactionIndexå¥½åƒå˜æˆäº†ä¸€ç§ç‰¹æ®Šçš„ç´¢å¼•äº†ï¼Œæ˜¯ç‹¬ç«‹çš„ï¼ŒTimeIndex å’Œ OffsetIndex æ˜¯ä½œä¸ºæ³›å‹ç»™ LazyIndex ä½¿ç”¨çš„","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509013,"discussion_content":"å—¯å—¯ï¼Œæºç çš„ç¡®åœ¨ä¸æ–­æ¼”è¿›ä¸­ã€‚ç°åœ¨çš„ä¼˜åŒ–æ€è·¯æ˜¯æœç€å»¶è¿Ÿåˆå§‹åŒ–ç´¢å¼•ï¼ŒæœŸæœ›å¿«é€Ÿç¼©çŸ­brokerå¯åŠ¨æ—¶é—´","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604886404,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":252476,"user_name":"KèŒæ— æƒ¨","can_delete":false,"product_type":"c1","uid":2194764,"ip_address":"","ucode":"97A532D588FD49","user_header":"","comment_is_top":false,"comment_ctime":1602315616,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602315616","product_id":100050101,"comment_content":"å—ç›ŠåŒªæµ…","like_count":0},{"had_liked":false,"id":249156,"user_name":"Geek_633432","can_delete":false,"product_type":"c1","uid":2153827,"ip_address":"","ucode":"2FC0D25CB69A99","user_header":"","comment_is_top":false,"comment_ctime":1600482895,"is_pvip":false,"replies":[{"id":"91430","content":"å¯ä»¥æ¶ˆè´¹åˆ°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1600523290,"ip_address":"","comment_id":249156,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1600482895","product_id":100050101,"comment_content":"è¯·é—®è€å¸ˆï¼Œleaderæ”¶åˆ°ç”Ÿäº§è¯·æ±‚ï¼Œå‘æœ¬åœ°å†™å…¥æ¶ˆæ¯ï¼Œå¦‚æœæ­¤æ—¶æ¶ˆæ¯è¿˜åœ¨ç¼“å­˜ä¸­ï¼Œè¿˜æ²¡æœ‰åŒæ­¥åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆfollowerå’Œæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹è¿™éƒ¨åˆ†æ•°æ®å—","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505851,"discussion_content":"å¯ä»¥æ¶ˆè´¹åˆ°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600523290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243356,"user_name":"Bryant.C","can_delete":false,"product_type":"c1","uid":1172363,"ip_address":"","ucode":"0DF832373CFA97","user_header":"https://static001.geekbang.org/account/avatar/00/11/e3/8b/27f875ba.jpg","comment_is_top":false,"comment_ctime":1598071240,"is_pvip":false,"replies":[{"id":"89764","content":"æ›´å¤šè¿˜æ˜¯ä»ä¼˜åŒ–consumerç€æ‰‹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å¤„ç†é€»è¾‘è¿‡é‡å¯¼è‡´çš„","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1598232731,"ip_address":"","comment_id":243356,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1598071240","product_id":100050101,"comment_content":"è€å¸ˆå¥½ï¼Œå¦‚æœKafkaé›†ç¾¤ä¸­å­˜åœ¨æ¯”è¾ƒå¤šçš„lagging consumerï¼Œç«™åœ¨Kafkaçš„è§’åº¦æœ‰ä»€ä¹ˆæ¯”è¾ƒå¥½çš„ä¼˜åŒ–æ€è·¯å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504267,"discussion_content":"æ›´å¤šè¿˜æ˜¯ä»ä¼˜åŒ–consumerç€æ‰‹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å¤„ç†é€»è¾‘è¿‡é‡å¯¼è‡´çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598232731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239421,"user_name":"yic","can_delete":false,"product_type":"c1","uid":1201577,"ip_address":"","ucode":"C8DC471B7C28B8","user_header":"https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg","comment_is_top":false,"comment_ctime":1596528982,"is_pvip":false,"replies":[{"id":"88974","content":"1. 8KB = 8092B, æ¯ä¸ªä½ç§»ç´¢å¼•é¡¹å¤§å°æ˜¯8Bï¼Œæ‰€ä»¥è¿™ä¸ªçƒ­åŒºèƒ½å¤Ÿä¿å­˜1024ä¸ªç´¢å¼•é¡¹ã€‚ç”±äºé»˜è®¤æ¯4KBå†™å…¥ä¸€ä¸ªç´¢å¼•é¡¹ï¼Œå› æ­¤8KBçš„çƒ­åŒºèƒ½å¤Ÿè¦†ç›–1024 * 4KB = 4MBçš„æ—¥å¿—æ•°æ®<br>2. åŒæ„~","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1597111477,"ip_address":"","comment_id":239421,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1596528982","product_id":100050101,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³é—®2ä¸ªé—®é¢˜ï¼š<br>1. ä¸ºä»€ä¹ˆ8K index offsetå¯ä»¥è¦†ç›–4Mçš„æ•°æ®ï¼Ÿ<br>2. 8Kå…¶å®æ˜¯ä¸€ä¸ªç»éªŒå€¼å§ï¼Ÿè€ƒè™‘çš„ç‚¹ä¸»è¦æ˜¯non-lagging consumerçš„æ€§èƒ½å’Œå ç”¨çš„ç¼“å­˜ç©ºé—´ã€‚","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503101,"discussion_content":"1. 8KB = 8092B, æ¯ä¸ªä½ç§»ç´¢å¼•é¡¹å¤§å°æ˜¯8Bï¼Œæ‰€ä»¥è¿™ä¸ªçƒ­åŒºèƒ½å¤Ÿä¿å­˜1024ä¸ªç´¢å¼•é¡¹ã€‚ç”±äºé»˜è®¤æ¯4KBå†™å…¥ä¸€ä¸ªç´¢å¼•é¡¹ï¼Œå› æ­¤8KBçš„çƒ­åŒºèƒ½å¤Ÿè¦†ç›–1024 * 4KB = 4MBçš„æ—¥å¿—æ•°æ®\n2. åŒæ„~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597111477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1201577,"avatar":"https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg","nickname":"yic","note":"","ucode":"C8DC471B7C28B8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297927,"discussion_content":"è°¢è°¢èƒ¡è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597112735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239420,"user_name":"EternityÂ°","can_delete":false,"product_type":"c1","uid":1473891,"ip_address":"","ucode":"CDE334BF392DCE","user_header":"https://static001.geekbang.org/account/avatar/00/16/7d/63/b9660319.jpg","comment_is_top":false,"comment_ctime":1596528736,"is_pvip":false,"replies":[{"id":"88510","content":"å—¯ï¼Œåº”è¯¥æ˜¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1596614750,"ip_address":"","comment_id":239420,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1596528736","product_id":100050101,"comment_content":"å­¦ä¹ rocketmqæ˜¯ å‘ç°çš„ä¹Ÿæ˜¯ç”¨çš„å†…å­˜æ˜ å°„ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªç›¸ä¼¼ç‚¹ä¹ˆ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503100,"discussion_content":"å—¯ï¼Œåº”è¯¥æ˜¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596614750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230931,"user_name":"æ‡‚ç å“¥(GerryWen)","can_delete":false,"product_type":"c1","uid":2049910,"ip_address":"","ucode":"55CD1C9AAD87CD","user_header":"","comment_is_top":false,"comment_ctime":1593525197,"is_pvip":false,"replies":[{"id":"85366","content":"äºŒåˆ†æŸ¥æ‰¾ç®—æ³•åº”è¯¥è¿˜æ¯”è¾ƒç†Ÿæ‚‰å§ï¼Œå¯ä»¥å¯¹ç…§ç€æ ‡å‡†çš„ç®—æ³•äºKafkaæºç æ¯”è¾ƒä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593607077,"ip_address":"","comment_id":230931,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593525197","product_id":100050101,"comment_content":"å­¦åˆ°è¿™è¾¹å¼€å§‹æ™•äº†ï¼Œè¯»ç€è¯»ç€å°±ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500080,"discussion_content":"äºŒåˆ†æŸ¥æ‰¾ç®—æ³•åº”è¯¥è¿˜æ¯”è¾ƒç†Ÿæ‚‰å§ï¼Œå¯ä»¥å¯¹ç…§ç€æ ‡å‡†çš„ç®—æ³•äºKafkaæºç æ¯”è¾ƒä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593607077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213214,"user_name":"å°å´”","can_delete":false,"product_type":"c1","uid":1104958,"ip_address":"","ucode":"4E537416787752","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/3e/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1588332628,"is_pvip":false,"replies":[{"id":"79125","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588399055,"ip_address":"","comment_id":213214,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588332628","product_id":100050101,"comment_content":"æœ¬æ¥åŸç‰ˆäºŒåˆ†ç®—æ³•å®ç°æ„Ÿè§‰æœ‰bugï¼Œåæ¥å‘ç°ceilæ˜¯å‘ä¸Šå–æ•´ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493712,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588399055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213141,"user_name":"æ®‹æœˆ@è¯—é›¨","can_delete":false,"product_type":"c1","uid":1111415,"ip_address":"","ucode":"38DA6C1BC808D5","user_header":"https://static001.geekbang.org/account/avatar/00/10/f5/77/7e852c51.jpg","comment_is_top":false,"comment_ctime":1588312036,"is_pvip":false,"replies":[{"id":"79129","content":"ç›®å‰å°±æ˜¯è¿™æ ·çš„è®¾è®¡æ€è·¯ã€‚å°†æ•´ä¸ªç´¢å¼•åŒºåˆ†ä¸ºå‰åä¸¤ä¸ªåŒº","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1588399565,"ip_address":"","comment_id":213141,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588312036","product_id":100050101,"comment_content":"æ²¡æ‡‚å‘€ï¼Œï¼Œï¼Œä¸ºä»€ä¹ˆåˆ†æˆä¸¤ä¸ªåŒºï¼Œåé¢é‚£ä¸ªåŒºå°±æ˜¯çƒ­åŒºï¼Œå‰é¢é‚£ä¸ªåŒºå°±æ˜¯å†·åŒºï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493692,"discussion_content":"ç›®å‰å°±æ˜¯è¿™æ ·çš„è®¾è®¡æ€è·¯ã€‚å°†æ•´ä¸ªç´¢å¼•åŒºåˆ†ä¸ºå‰åä¸¤ä¸ªåŒº","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588399565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208682,"user_name":"Jupiter","can_delete":false,"product_type":"c1","uid":1207177,"ip_address":"","ucode":"7BA8A60E7834CB","user_header":"https://static001.geekbang.org/account/avatar/00/12/6b/89/10fad700.jpg","comment_is_top":false,"comment_ctime":1587400909,"is_pvip":false,"replies":[{"id":"78138","content":"hmmmï¼Œç®—æ³•åŠŸåº•è¿˜æ˜¯å¼º<br>","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1587518960,"ip_address":"","comment_id":208682,"utype":1}],"discussion_count":1,"race_medal":1,"score":"1587400909","product_id":100050101,"comment_content":"è¿™ä¸€ç« æ‰¾å›äº†ä¸€ç‚¹è‡ªä¿¡","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492575,"discussion_content":"hmmmï¼Œç®—æ³•åŠŸåº•è¿˜æ˜¯å¼º\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587518960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}