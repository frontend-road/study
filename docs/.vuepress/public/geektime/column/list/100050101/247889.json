{"id":247889,"title":"21 | AbstractFetcherThreadï¼šæ‹‰å–æ¶ˆæ¯åˆ†å‡ æ­¥ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬æ­£å¼è¿›å…¥åˆ°ç¬¬5å¤§æ¨¡å—â€œå‰¯æœ¬ç®¡ç†æ¨¡å—â€æºç çš„å­¦ä¹ ã€‚</p><p>åœ¨Kafkaä¸­ï¼Œå‰¯æœ¬æ˜¯æœ€é‡è¦çš„æ¦‚å¿µä¹‹ä¸€ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿåœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘æ›¾åå¤æåˆ°è¿‡å‰¯æœ¬æœºåˆ¶æ˜¯Kafkaå®ç°æ•°æ®é«˜å¯é æ€§çš„åŸºç¡€ã€‚å…·ä½“çš„å®ç°æ–¹å¼å°±æ˜¯ï¼ŒåŒä¸€ä¸ªåˆ†åŒºä¸‹çš„å¤šä¸ªå‰¯æœ¬åˆ†æ•£åœ¨ä¸åŒçš„Brokeræœºå™¨ä¸Šï¼Œå®ƒä»¬ä¿å­˜ç›¸åŒçš„æ¶ˆæ¯æ•°æ®ä»¥å®ç°é«˜å¯é æ€§ã€‚å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œä¸€ä¸ªå¿…é¡»è¦è§£å†³çš„é—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•ç¡®ä¿æ‰€æœ‰å‰¯æœ¬ä¸Šçš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæœ€å¸¸è§çš„æ–¹æ¡ˆå½“å±Leader/Followerå¤‡ä»½æœºåˆ¶ï¼ˆLeader/Follower Replicationï¼‰ã€‚åœ¨Kafkaä¸­ï¼Œ åˆ†åŒºçš„æŸä¸ªå‰¯æœ¬ä¼šè¢«æŒ‡å®šä¸ºLeaderï¼Œè´Ÿè´£å“åº”å®¢æˆ·ç«¯çš„è¯»å†™è¯·æ±‚ã€‚å…¶ä»–å‰¯æœ¬è‡ªåŠ¨æˆä¸ºFollowerï¼Œè¢«åŠ¨åœ°åŒæ­¥Leaderå‰¯æœ¬ä¸­çš„æ•°æ®ã€‚</p><p>è¿™é‡Œæ‰€è¯´çš„è¢«åŠ¨åŒæ­¥ï¼Œæ˜¯æŒ‡Followerå‰¯æœ¬ä¸æ–­åœ°å‘Leaderå‰¯æœ¬å‘é€è¯»å–è¯·æ±‚ï¼Œä»¥è·å–Leaderå¤„å†™å…¥çš„æœ€æ–°æ¶ˆæ¯æ•°æ®ã€‚</p><p>é‚£ä¹ˆåœ¨æ¥ä¸‹æ¥çš„ä¸¤è®²ï¼Œæˆ‘ä»¬å°±ä¸€èµ·å­¦ä¹ ä¸‹Followerå‰¯æœ¬æ˜¯å¦‚ä½•é€šè¿‡æ‹‰å–çº¿ç¨‹åšåˆ°è¿™ä¸€ç‚¹çš„ã€‚å¦å¤–ï¼ŒFollowerå‰¯æœ¬åœ¨å‰¯æœ¬åŒæ­¥çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜å¯èƒ½å‘ç”Ÿåä¸ºæˆªæ–­ï¼ˆTruncationï¼‰çš„æ“ä½œã€‚æˆ‘ä»¬ä¸€å¹¶æ¥çœ‹ä¸‹å®ƒçš„å®ç°åŸç†ã€‚</p><!-- [[[read_end]]] --><h2>è¯¾å‰æ¡ˆä¾‹</h2><p>å¦ç‡åœ°è¯´ï¼Œè¿™éƒ¨åˆ†æºç éå¸¸è´´è¿‘åº•å±‚è®¾è®¡æ¶æ„åŸç†ã€‚ä½ å¯èƒ½åœ¨æƒ³ï¼šé˜…è¯»å®ƒå¯¹æˆ‘å®é™…æœ‰ä»€ä¹ˆå¸®åŠ©å—ï¼Ÿæˆ‘ä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥è¯´æ˜ä¸‹ã€‚</p><p>æˆ‘ä»¬æ›¾ç»åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‘ç°ï¼Œä¸€æ—¦Brokerä¸Šçš„å‰¯æœ¬æ•°è¿‡å¤šï¼ŒBrokerèŠ‚ç‚¹çš„å†…å­˜å ç”¨å°±ä¼šéå¸¸é«˜ã€‚æŸ¥è¿‡HeapDumpä¹‹åï¼Œæˆ‘ä»¬å‘ç°æ ¹æºåœ¨äºReplicaFetcherThreadæ–‡ä»¶ä¸­çš„buildFetchæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•é‡Œæœ‰è¿™æ ·ä¸€å¥ï¼š</p><pre><code>val builder = fetchSessionHandler.newBuilder()\n</code></pre><p>è¿™æ¡è¯­å¥åº•å±‚ä¼šå®ä¾‹åŒ–ä¸€ä¸ªLinkedHashMapã€‚å¦‚æœåˆ†åŒºæ•°å¾ˆå¤šçš„è¯ï¼Œè¿™ä¸ªMapä¼šè¢«æ‰©å®¹å¾ˆå¤šæ¬¡ï¼Œå› æ­¤å¸¦æ¥äº†å¾ˆå¤šä¸å¿…è¦çš„æ•°æ®æ‹·è´ã€‚è¿™æ ·æ—¢å¢åŠ äº†å†…å­˜çš„Footprintï¼Œä¹Ÿæµªè´¹äº†CPUèµ„æºã€‚</p><p>ä½ çœ‹ï¼Œé€šè¿‡æŸ¥è¯¢æºç ï¼Œæˆ‘ä»¬å®šä½åˆ°äº†è¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚åæ¥ï¼Œæˆ‘ä»¬é€šè¿‡å°†è´Ÿè½½è½¬ç§»åˆ°å…¶ä»–Brokerçš„æ–¹æ³•è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p><p>å…¶å®ï¼ŒKafkaç¤¾åŒºä¹Ÿå‘ç°äº†è¿™ä¸ªBugï¼Œæ‰€ä»¥å½“ä½ ç°åœ¨å†çœ‹è¿™éƒ¨åˆ†æºç çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°è¿™è¡Œè¯­å¥å·²ç»è¢«ä¿®æ­£äº†ã€‚å®ƒç°åœ¨é•¿è¿™ä¸ªæ ·å­ï¼Œä½ å¯ä»¥ä½“ä¼šä¸‹å’Œä¹‹å‰æœ‰ä»€ä¹ˆä¸åŒï¼š</p><pre><code>val builder = fetchSessionHandler.newBuilder(partitionMap.size, false)\n</code></pre><p>ä½ å¯èƒ½ä¹Ÿçœ‹å‡ºæ¥äº†ï¼Œä¿®æ”¹å‰åæœ€å¤§çš„ä¸åŒï¼Œå…¶å®åœ¨äºä¿®æ”¹åçš„è¿™æ¡è¯­å¥ç›´æ¥ä¼ å…¥äº†FETCHè¯·æ±‚ä¸­æ€»çš„åˆ†åŒºæ•°ï¼Œå¹¶ç›´æ¥å°†å…¶ä¼ ç»™LinkedHashMapï¼Œå…å¾—å†æ‰§è¡Œæ‰©å®¹æ“ä½œäº†ã€‚</p><p>ä½ çœ‹ï¼Œæœ‰çš„æ—¶å€™æ”¹è¿›ä¸€è¡Œæºç å°±èƒ½è§£å†³å®é™…é—®é¢˜ã€‚è€Œä¸”ï¼Œä½ åƒä¸‡ä¸è¦ä»¥ä¸ºä¿®æ”¹æºç æ˜¯ä¸€ä»¶å¤šä¹ˆç¥ç§˜çš„äº‹æƒ…ï¼Œææ‡‚äº†åŸç†ä¹‹åï¼Œå°±å¯ä»¥æœ‰é’ˆå¯¹æ€§åœ°è°ƒæ•´ä»£ç äº†ï¼Œè¿™å…¶å®æ˜¯ä¸€ä»¶éå¸¸æ„‰æ‚¦çš„äº‹æƒ…ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬è¯´å›Followerå‰¯æœ¬ä»Leaderå‰¯æœ¬æ‹‰å–æ•°æ®è¿™ä»¶äº‹å„¿ã€‚ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œæˆ‘åœ¨å‰é¢çš„ä¾‹å­æåˆ°äº†ä¸€ä¸ªåå­—ï¼šReplicaFetcherThreadï¼Œä¹Ÿå°±æ˜¯å‰¯æœ¬è·å–çº¿ç¨‹ã€‚æ²¡é”™ï¼ŒKafkaæºç å°±æ˜¯é€šè¿‡è¿™ä¸ªçº¿ç¨‹å®ç°çš„æ¶ˆæ¯æ‹‰å–åŠå¤„ç†ã€‚</p><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å…ˆä»æŠ½è±¡åŸºç±»AbstractFetcherThreadå­¦èµ·ï¼Œçœ‹çœ‹å®ƒçš„ç±»å®šä¹‰å’Œä¸‰ä¸ªé‡è¦æ–¹æ³•ã€‚ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä»¬å†ç»§ç»­å­¦ä¹ AbstractFetcherThreadç±»çš„ä¸€ä¸ªé‡è¦æ–¹æ³•ï¼Œä»¥åŠå­ç±»ReplicaFetcherThreadçš„æºç ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½å½»åº•ææ˜ç™½Followerç«¯åŒæ­¥Leaderç«¯æ¶ˆæ¯çš„åŸç†ã€‚</p><h2>æŠ½è±¡åŸºç±»ï¼šAbstractFetcherThread</h2><p>ç­‰ç­‰ï¼Œæˆ‘ä»¬ä¸æ˜¯è¦å­¦ReplicaFetcherThreadå—ï¼Ÿä¸ºä»€ä¹ˆè¦å…ˆä»å®ƒçš„çˆ¶ç±»AbstractFetcherThreadå¼€å§‹å­¦ä¹ å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œè¿™é‡Œçš„åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œé‚£å°±æ˜¯å› ä¸ºAbstractFetcherThreadç±»æ˜¯ReplicaFetcherThreadçš„æŠ½è±¡åŸºç±»ã€‚å®ƒé‡Œé¢å®šä¹‰å’Œå®ç°äº†å¾ˆå¤šé‡è¦çš„å­—æ®µå’Œæ–¹æ³•ï¼Œæ˜¯æˆ‘ä»¬å­¦ä¹ ReplicaFetcherThreadæºç çš„åŸºç¡€ã€‚åŒæ—¶ï¼ŒAbstractFetcherThreadç±»çš„æºç ç»™å‡ºäº†å¾ˆå¤šå­ç±»éœ€è¦å®ç°çš„æ–¹æ³•ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦äº‹å…ˆäº†è§£è¿™ä¸ªæŠ½è±¡åŸºç±»ï¼Œå¦åˆ™ä¾¿æ— æ³•é¡ºç•…è¿‡æ¸¡åˆ°å…¶å­ç±»æºç çš„å­¦ä¹ ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬æ¥æ­£å¼è®¤è¯†ä¸‹AbstractFetcherThreadå§ã€‚å®ƒçš„æºç ä½äºserveråŒ…ä¸‹çš„AbstractFetcherThread.scalaæ–‡ä»¶ä¸­ã€‚ä»åå­—æ¥çœ‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°çš„åŠŸèƒ½æ˜¯ä»Brokerè·å–å¤šä¸ªåˆ†åŒºçš„æ¶ˆæ¯æ•°æ®ï¼Œè‡³äºè·å–ä¹‹åå¦‚ä½•å¯¹è¿™äº›æ•°æ®è¿›è¡Œå¤„ç†ï¼Œåˆ™äº¤ç”±å­ç±»æ¥å®ç°ã€‚</p><h3>ç±»å®šä¹‰åŠå­—æ®µ</h3><p>æˆ‘ä»¬çœ‹ä¸‹AbstractFetcherThreadç±»çš„å®šä¹‰å’Œä¸€äº›é‡è¦çš„å­—æ®µï¼š</p><pre><code>abstract class AbstractFetcherThread(\n  name: String,  // çº¿ç¨‹åç§°\n  clientId: String,  // Client Idï¼Œç”¨äºæ—¥å¿—è¾“å‡º\n  val sourceBroker: BrokerEndPoint,  // æ•°æ®æºBrokeråœ°å€\n  failedPartitions: FailedPartitions,  // å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°å¤±è´¥çš„åˆ†åŒº\n  fetchBackOffMs: Int = 0,  // è·å–æ“ä½œé‡è¯•é—´éš”\n  isInterruptible: Boolean = true,  // çº¿ç¨‹æ˜¯å¦å…è®¸è¢«ä¸­æ–­\n  val brokerTopicStats: BrokerTopicStats) // Brokerç«¯ä¸»é¢˜ç›‘æ§æŒ‡æ ‡\n  extends ShutdownableThread(name, isInterruptible) {\n  // å®šä¹‰FetchDataç±»å‹è¡¨ç¤ºè·å–çš„æ¶ˆæ¯æ•°æ®\n  type FetchData = FetchResponse.PartitionData[Records]\n  // å®šä¹‰EpochDataç±»å‹è¡¨ç¤ºLeader Epochæ•°æ®\n  type EpochData = OffsetsForLeaderEpochRequest.PartitionData\n  private val partitionStates = new PartitionStates[PartitionFetchState]\n  ......\n}\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹AbstractFetcherThreadçš„æ„é€ å‡½æ•°æ¥æ”¶çš„å‡ ä¸ªé‡è¦å‚æ•°çš„å«ä¹‰ã€‚</p><ul>\n<li>nameï¼šçº¿ç¨‹åå­—ã€‚</li>\n<li>sourceBrokerï¼šæºBrokerèŠ‚ç‚¹ä¿¡æ¯ã€‚æºBrokeræ˜¯æŒ‡æ­¤çº¿ç¨‹è¦ä»å“ªä¸ªBrokerä¸Šè¯»å–æ•°æ®ã€‚</li>\n<li>failedPartitionsï¼šçº¿ç¨‹å¤„ç†è¿‡ç¨‹æŠ¥é”™çš„åˆ†åŒºé›†åˆã€‚</li>\n<li>fetchBackOffMsï¼šå½“è·å–åˆ†åŒºæ•°æ®å‡ºé”™åçš„ç­‰å¾…é‡è¯•é—´éš”ï¼Œé»˜è®¤æ˜¯Brokerç«¯å‚æ•°replica.fetch.backoff.mså€¼ã€‚</li>\n<li>brokerTopicStatsï¼šBrokerç«¯ä¸»é¢˜çš„å„ç±»ç›‘æ§æŒ‡æ ‡ï¼Œå¸¸è§çš„æœ‰MessagesInPerSecã€BytesInPerSecç­‰ã€‚</li>\n</ul><p>è¿™äº›å­—æ®µä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<strong>sourceBroker</strong>ï¼Œå› ä¸ºå®ƒå†³å®šFollowerå‰¯æœ¬ä»å“ªä¸ªBrokeræ‹‰å–æ•°æ®ï¼Œä¹Ÿå°±æ˜¯Leaderå‰¯æœ¬æ‰€åœ¨çš„Brokeræ˜¯å“ªå°ã€‚</p><p>é™¤äº†æ„é€ å‡½æ•°çš„è¿™å‡ ä¸ªå­—æ®µå¤–ï¼ŒAbstractFetcherThreadç±»è¿˜å®šä¹‰äº†ä¸¤ä¸ªtypeç±»å‹ã€‚ç”¨å…³é”®å­—typeå®šä¹‰ä¸€ä¸ªç±»å‹ï¼Œå±äºScalaæ¯”è¾ƒé«˜é˜¶çš„è¯­æ³•ç‰¹æ€§ã€‚ä»æŸç§ç¨‹åº¦ä¸Šï¼Œä½ å¯ä»¥æŠŠå®ƒå½“æˆä¸€ä¸ªå¿«æ·æ–¹å¼ï¼Œæ¯”å¦‚FetchDataè¿™å¥ï¼š</p><pre><code>type FetchData = FetchResponse.PartitionData[Records]\n</code></pre><p>è¿™è¡Œè¯­å¥ç±»ä¼¼äºä¸€ä¸ªå¿«æ·æ–¹å¼ï¼šä»¥åå‡¡æ˜¯æºç ä¸­éœ€è¦ç”¨åˆ°FetchResponse.PartitionData[Records]çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ç®€å•åœ°ä½¿ç”¨FetchDataæ›¿æ¢æ‰ï¼Œéå¸¸ç®€æ´æ–¹ä¾¿ã€‚è‡ªå®šä¹‰ç±»å‹EpochDataï¼Œä¹Ÿæ˜¯åŒæ ·çš„ç”¨æ³•ã€‚</p><p>FetchDataå®šä¹‰é‡Œçš„PartitionDataç±»å‹ï¼Œæ˜¯å®¢æˆ·ç«¯clientså·¥ç¨‹ä¸­FetchResponseç±»å®šä¹‰çš„åµŒå¥—ç±»ã€‚FetchResponseç±»å°è£…çš„æ˜¯FETCHè¯·æ±‚çš„Responseå¯¹è±¡ï¼Œè€Œé‡Œé¢çš„PartitionDataç±»æ˜¯ä¸€ä¸ªPOJOç±»ï¼Œä¿å­˜çš„æ˜¯Responseä¸­å•ä¸ªåˆ†åŒºæ•°æ®æ‹‰å–çš„å„é¡¹æ•°æ®ï¼ŒåŒ…æ‹¬ä»è¯¥åˆ†åŒºçš„Leaderå‰¯æœ¬æ‹‰å–å›æ¥çš„æ¶ˆæ¯ã€è¯¥åˆ†åŒºçš„é«˜æ°´ä½å€¼å’Œæ—¥å¿—èµ·å§‹ä½ç§»å€¼ç­‰ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹å®ƒçš„ä»£ç ï¼š</p><pre><code>public static final class PartitionData&lt;T extends BaseRecords&gt; {\n    public final Errors error;           // é”™è¯¯ç \n    public final long highWatermark;     // é«˜æ°´ä½å€¼\n    public final long lastStableOffset;  // æœ€æ–°LSOå€¼ \n    public final long logStartOffset;    // æœ€æ–°Log Start Offsetå€¼\n    // æœŸæœ›çš„Read Replica\n    // KAFKA 2.4ä¹‹åæ”¯æŒéƒ¨åˆ†Followerå‰¯æœ¬å¯ä»¥å¯¹å¤–æä¾›è¯»æœåŠ¡\n    public final Optional&lt;Integer&gt; preferredReadReplica;\n    // è¯¥åˆ†åŒºå¯¹åº”çš„å·²ç»ˆæ­¢äº‹åŠ¡åˆ—è¡¨\n    public final List&lt;AbortedTransaction&gt; abortedTransactions;\n    // æ¶ˆæ¯é›†åˆï¼Œæœ€é‡è¦çš„å­—æ®µï¼\n    public final T records;\n    // æ„é€ å‡½æ•°......\n}\n</code></pre><p>PartitionDataè¿™ä¸ªç±»å®šä¹‰çš„å­—æ®µä¸­ï¼Œé™¤äº†æˆ‘ä»¬å·²ç»éå¸¸ç†Ÿæ‚‰çš„highWatermarkå’ŒlogStartOffsetç­‰å­—æ®µå¤–ï¼Œè¿˜æœ‰ä¸€äº›å±äºæ¯”è¾ƒé«˜é˜¶çš„ç”¨æ³•ï¼š</p><ul>\n<li>preferredReadReplicaï¼Œç”¨äºæŒ‡å®šå¯å¯¹å¤–æä¾›è¯»æœåŠ¡çš„Followerå‰¯æœ¬ï¼›</li>\n<li>abortedTransactionsï¼Œç”¨äºä¿å­˜è¯¥åˆ†åŒºå½“å‰å·²ç»ˆæ­¢äº‹åŠ¡åˆ—è¡¨ï¼›</li>\n<li>lastStableOffsetæ˜¯æœ€æ–°çš„LSOå€¼ï¼Œå±äºKafkaäº‹åŠ¡çš„æ¦‚å¿µã€‚</li>\n</ul><p>å…³äºè¿™å‡ ä¸ªå­—æ®µï¼Œä½ åªè¦äº†è§£å®ƒä»¬çš„åŸºæœ¬ä½œç”¨å°±å¯ä»¥äº†ã€‚å®é™…ä¸Šï¼Œåœ¨PartitionDataè¿™ä¸ªç±»ä¸­ï¼Œæœ€éœ€è¦ä½ é‡ç‚¹å…³æ³¨çš„æ˜¯<strong>recordså­—æ®µ</strong>ã€‚å› ä¸ºå®ƒä¿å­˜å®é™…çš„æ¶ˆæ¯é›†åˆï¼Œè€Œè¿™æ˜¯æˆ‘ä»¬æœ€å…³å¿ƒçš„æ•°æ®ã€‚</p><p>è¯´åˆ°è¿™é‡Œï¼Œå¦‚æœä½ å»æŸ¥çœ‹EpochDataçš„å®šä¹‰ï¼Œèƒ½å‘ç°å®ƒä¹Ÿæ˜¯PartitionDataç±»å‹ã€‚ä½†ï¼Œä½ ä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼ŒEpochDataçš„PartitionDataæ˜¯OffsetsForLeaderEpochRequestçš„PartitionDataç±»å‹ã€‚</p><p>äº‹å®ä¸Šï¼Œ<strong>åœ¨Kafkaæºç ä¸­ï¼Œæœ‰å¾ˆå¤šåä¸ºPartitionDataçš„åµŒå¥—ç±»</strong>ã€‚å¾ˆå¤šè¯·æ±‚ç±»å‹ä¸­çš„æ•°æ®éƒ½æ˜¯æŒ‰åˆ†åŒºå±‚çº§è¿›è¡Œåˆ†ç»„çš„ï¼Œå› æ­¤æºç å¾ˆè‡ªç„¶åœ°åœ¨è¿™äº›è¯·æ±‚ç±»ä¸­åˆ›å»ºäº†åŒåçš„åµŒå¥—ç±»ã€‚æˆ‘ä»¬åœ¨æŸ¥çœ‹æºç æ—¶ï¼Œä¸€å®šè¦æ³¨æ„åŒºåˆ†PartitionDataåµŒå¥—ç±»æ˜¯å®šä¹‰åœ¨å“ªç±»è¯·æ±‚ä¸­çš„ï¼Œä¸åŒç±»å‹è¯·æ±‚ä¸­çš„PartitionDataç±»å­—æ®µæ˜¯å®Œå…¨ä¸åŒçš„ã€‚</p><h3>åˆ†åŒºè¯»å–çŠ¶æ€ç±»</h3><p>å¥½äº†ï¼Œæˆ‘ä»¬æŠŠè§†çº¿æ‹‰å›åˆ°AbstractFetcherThreadç±»ã€‚åœ¨è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒè¿˜å°è£…äº†ä¸€ä¸ªåä¸º<strong>PartitionStates[PartitionFetchState]</strong>ç±»å‹çš„å­—æ®µã€‚</p><p>æ˜¯ä¸æ˜¯çœ‹ä¸Šå»æœ‰äº›å¤æ‚ï¼Ÿä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬åˆ†å¼€æ¥çœ‹ï¼Œå…ˆçœ‹å®ƒæ³›å‹çš„å‚æ•°ç±»å‹PartitionFetchStateç±»ã€‚ç›´è§‚ä¸Šç†è§£ï¼Œå®ƒæ˜¯è¡¨å¾åˆ†åŒºè¯»å–çŠ¶æ€çš„ï¼Œä¿å­˜çš„æ˜¯åˆ†åŒºçš„å·²è¯»å–ä½ç§»å€¼å’Œå¯¹åº”çš„å‰¯æœ¬çŠ¶æ€ã€‚</p><p>æ³¨æ„è¿™é‡Œçš„çŠ¶æ€æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯åˆ†åŒºè¯»å–çŠ¶æ€ï¼Œä¸€ä¸ªæ˜¯å‰¯æœ¬è¯»å–çŠ¶æ€ã€‚å‰¯æœ¬è¯»å–çŠ¶æ€ç”±ReplicaStateæ¥å£è¡¨ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>sealed trait ReplicaState\n// æˆªæ–­ä¸­\ncase object Truncating extends ReplicaState\n// è·å–ä¸­\ncase object Fetching extends ReplicaState\n</code></pre><p>å¯è§ï¼Œå‰¯æœ¬è¯»å–çŠ¶æ€æœ‰æˆªæ–­ä¸­å’Œè·å–ä¸­ä¸¤ä¸ªï¼šå½“å‰¯æœ¬æ‰§è¡Œæˆªæ–­æ“ä½œæ—¶ï¼Œå‰¯æœ¬çŠ¶æ€è¢«è®¾ç½®æˆTruncatingï¼›å½“å‰¯æœ¬è¢«è¯»å–æ—¶ï¼Œå‰¯æœ¬çŠ¶æ€è¢«è®¾ç½®æˆFetchingã€‚</p><p>è€Œåˆ†åŒºè¯»å–çŠ¶æ€æœ‰3ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul>\n<li>å¯è·å–ï¼Œè¡¨æ˜å‰¯æœ¬è·å–çº¿ç¨‹å½“å‰èƒ½å¤Ÿè¯»å–æ•°æ®ã€‚</li>\n<li>æˆªæ–­ä¸­ï¼Œè¡¨æ˜åˆ†åŒºå‰¯æœ¬æ­£åœ¨æ‰§è¡Œæˆªæ–­æ“ä½œï¼ˆæ¯”å¦‚è¯¥å‰¯æœ¬åˆšåˆšæˆä¸ºFollowerå‰¯æœ¬ï¼‰ã€‚</li>\n<li>è¢«æ¨è¿Ÿï¼Œè¡¨æ˜å‰¯æœ¬è·å–çº¿ç¨‹è·å–æ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼Œéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ã€‚</li>\n</ul><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåˆ†åŒºè¯»å–çŠ¶æ€ä¸­çš„å¯è·å–ã€æˆªæ–­ä¸­ä¸å‰¯æœ¬è¯»å–çŠ¶æ€çš„è·å–ä¸­ã€æˆªæ–­ä¸­ä¸¤ä¸ªçŠ¶æ€å¹¶éä¸¥æ ¼å¯¹åº”çš„ã€‚æ¢å¥è¯è¯´ï¼Œå‰¯æœ¬è¯»å–çŠ¶æ€å¤„äºè·å–ä¸­ï¼Œå¹¶ä¸ä¸€å®šè¡¨ç¤ºåˆ†åŒºè¯»å–çŠ¶æ€å°±æ˜¯å¯è·å–çŠ¶æ€ã€‚å¯¹äºåˆ†åŒºè€Œè¨€ï¼Œå®ƒæ˜¯å¦èƒ½å¤Ÿè¢«è·å–çš„æ¡ä»¶è¦æ¯”å‰¯æœ¬ä¸¥æ ¼ä¸€äº›ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™3ç±»åˆ†åŒºè·å–çŠ¶æ€çš„æºç å®šä¹‰ï¼š</p><pre><code>case class PartitionFetchState(fetchOffset: Long,\n  lag: Option[Long],\n  currentLeaderEpoch: Int,\n  delay: Option[DelayedItem],\n  state: ReplicaState) {\n  // åˆ†åŒºå¯è·å–çš„æ¡ä»¶æ˜¯å‰¯æœ¬å¤„äºFetchingä¸”æœªè¢«æ¨è¿Ÿæ‰§è¡Œ\n  def isReadyForFetch: Boolean = state == Fetching &amp;&amp; !isDelayed\n  // å‰¯æœ¬å¤„äºISRçš„æ¡ä»¶ï¼šæ²¡æœ‰lag\n  def isReplicaInSync: Boolean = lag.isDefined &amp;&amp; lag.get &lt;= 0\n  // åˆ†åŒºå¤„äºæˆªæ–­ä¸­çŠ¶æ€çš„æ¡ä»¶ï¼šå‰¯æœ¬å¤„äºTruncatingçŠ¶æ€ä¸”æœªè¢«æ¨è¿Ÿæ‰§è¡Œ\n  def isTruncating: Boolean = state == Truncating &amp;&amp; !isDelayed\n  // åˆ†åŒºè¢«æ¨è¿Ÿè·å–æ•°æ®çš„æ¡ä»¶ï¼šå­˜åœ¨æœªè¿‡æœŸçš„å»¶è¿Ÿä»»åŠ¡\n  def isDelayed: Boolean = \n    delay.exists(_.getDelay(TimeUnit.MILLISECONDS) &gt; 0)\n  ......\n}\n</code></pre><p>è¿™æ®µæºç ä¸­æœ‰4ä¸ªæ–¹æ³•ï¼Œä½ åªè¦é‡ç‚¹äº†è§£isReadyForFetchå’ŒisTruncatingè¿™ä¸¤ä¸ªæ–¹æ³•å³å¯ã€‚å› ä¸ºå‰¯æœ¬è·å–çº¿ç¨‹åšçš„äº‹æƒ…å°±æ˜¯è¿™ä¸¤ä»¶ï¼šæ—¥å¿—æˆªæ–­å’Œæ¶ˆæ¯è·å–ã€‚</p><p>è‡³äºisReplicaInSyncï¼Œå®ƒè¢«ç”¨äºå‰¯æœ¬é™æµï¼Œå‡ºé•œç‡ä¸é«˜ã€‚è€ŒisDelayedï¼Œæ˜¯ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ¨è¿Ÿè·å–å¯¹åº”åˆ†åŒºçš„æ¶ˆæ¯ã€‚æºç ä¼šä¸æ–­åœ°è°ƒæ•´é‚£äº›ä¸éœ€è¦æ¨è¿Ÿçš„åˆ†åŒºçš„è¯»å–é¡ºåºï¼Œä»¥ä¿è¯è¯»å–çš„å…¬å¹³æ€§ã€‚</p><p>è¿™ä¸ªå…¬å¹³æ€§ï¼Œå…¶å®å°±æ˜¯åœ¨partitionStateså­—æ®µçš„ç±»å‹PartitionStatesç±»ä¸­å®ç°çš„ã€‚è¿™ä¸ªç±»æ˜¯åœ¨clientså·¥ç¨‹ä¸­å®šä¹‰çš„ã€‚å®ƒæœ¬è´¨ä¸Šä¼šæ¥æ”¶ä¸€ç»„è¦è¯»å–çš„ä¸»é¢˜åˆ†åŒºï¼Œç„¶åä»¥è½®è¯¢çš„æ–¹å¼ä¾æ¬¡è¯»å–è¿™äº›åˆ†åŒºä»¥ç¡®ä¿å…¬å¹³æ€§ã€‚</p><p>é‰´äºå’±ä»¬è¿™é—¨å„¿è¯¾èšç„¦äºBrokerç«¯æºç ï¼Œå› æ­¤ï¼Œè¿™é‡Œæˆ‘åªæ˜¯ç®€å•å’Œä½ è¯´ä¸‹è¿™ä¸ªç±»çš„å®ç°åŸç†ã€‚å¦‚æœä½ æƒ³è¦æ·±å…¥ç†è§£è¿™éƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥ç¿»å¼€clientsç«¯å·¥ç¨‹çš„æºç ï¼Œè‡ªè¡Œå»æ¢ç´¢ä¸‹è¿™éƒ¨åˆ†çš„æºç ã€‚</p><pre><code>public class PartitionStates&lt;S&gt; {\n    private final LinkedHashMap&lt;TopicPartition, S&gt; map = new LinkedHashMap&lt;&gt;();\n    ......\n    public void updateAndMoveToEnd(TopicPartition topicPartition, S state) {\n      map.remove(topicPartition);\n      map.put(topicPartition, state);\n      updateSize();\n    }\n    ......\n}\n</code></pre><p>å‰é¢è¯´è¿‡äº†ï¼ŒPartitionStatesç±»ç”¨è½®è¯¢çš„æ–¹å¼æ¥å¤„ç†è¦è¯»å–çš„å¤šä¸ªåˆ†åŒºã€‚é‚£å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¾é LinkedHashMapæ•°æ®ç»“æ„æ¥ä¿å­˜æ‰€æœ‰ä¸»é¢˜åˆ†åŒºã€‚LinkedHashMapä¸­çš„å…ƒç´ æœ‰æ˜ç¡®çš„è¿­ä»£é¡ºåºï¼Œé€šå¸¸å°±æ˜¯å…ƒç´ è¢«æ’å…¥çš„é¡ºåºã€‚</p><p>å‡è®¾Kafkaè¦è¯»å–5ä¸ªåˆ†åŒºä¸Šçš„æ¶ˆæ¯ï¼šAã€Bã€Cã€Då’ŒEã€‚å¦‚æœæ’å…¥é¡ºåºå°±æ˜¯ABCDEï¼Œé‚£ä¹ˆè‡ªç„¶é¦–å…ˆè¯»å–åˆ†åŒºAã€‚ä¸€æ—¦Aè¢«è¯»å–ä¹‹åï¼Œä¸ºäº†ç¡®ä¿å„ä¸ªåˆ†åŒºéƒ½æœ‰åŒç­‰æœºä¼šè¢«è¯»å–åˆ°ï¼Œä»£ç éœ€è¦å°†Aæ’å…¥åˆ°åˆ†åŒºåˆ—è¡¨çš„æœ€åä¸€ä½ï¼Œè¿™å°±æ˜¯updateAndMoveToEndæ–¹æ³•è¦åšçš„äº‹æƒ…ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯æŠŠAä»mapä¸­ç§»é™¤æ‰ï¼Œç„¶åå†æ’å›å»ï¼Œè¿™æ ·Aè‡ªç„¶å°±å¤„äºåˆ—è¡¨çš„æœ€åä¸€ä½äº†ã€‚å¤§ä½“ä¸Šï¼ŒPartitionStatesç±»å°±æ˜¯åšè¿™ä¸ªç”¨çš„ã€‚</p><h3>é‡è¦æ–¹æ³•</h3><p>è¯´å®Œäº†AbstractFetcherThreadç±»çš„å®šä¹‰ï¼Œæˆ‘ä»¬å†çœ‹ä¸‹å®ƒæä¾›çš„ä¸€äº›é‡è¦æ–¹æ³•ã€‚</p><p>è¿™ä¸ªç±»æ€»å…±å°è£…äº†è¿‘40ä¸ªæ–¹æ³•ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘å°±æŒ‰ç…§è¿™äº›æ–¹æ³•å¯¹äºä½ ä½¿ç”¨Kafkaã€è§£å†³Kafkaé—®é¢˜çš„é‡è¦ç¨‹åº¦ï¼Œç²¾é€‰å‡º4ä¸ªæ–¹æ³•åšé‡ç‚¹è®²è§£ï¼Œåˆ†åˆ«æ˜¯processPartitionDataã€truncateã€buildFetchå’ŒdoWorkã€‚è¿™4ä¸ªæ–¹æ³•æ¶µç›–äº†æ‹‰å–çº¿ç¨‹æ‰€åšçš„æœ€é‡è¦çš„3ä»¶äº‹å„¿ï¼šæ„å»ºFETCHè¯·æ±‚ã€æ‰§è¡Œæˆªæ–­æ“ä½œã€å¤„ç†æ‹‰å–åçš„ç»“æœã€‚è€ŒdoWorkæ–¹æ³•ï¼Œå…¶å®æ˜¯ä¸²è”èµ·äº†å‰é¢çš„è¿™3ä¸ªæ–¹æ³•ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹çœ‹å§ã€‚</p><p><strong>é¦–å…ˆæ˜¯å®ƒæœ€é‡è¦çš„æ–¹æ³•processPartitionData</strong>ï¼Œç”¨äºå¤„ç†è¯»å–å›æ¥çš„æ¶ˆæ¯é›†åˆã€‚å®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå› æ­¤éœ€è¦å­ç±»å®ç°å®ƒçš„é€»è¾‘ã€‚å…·ä½“åˆ°Followerå‰¯æœ¬è€Œè¨€ï¼Œ æ˜¯ç”±ReplicaFetcherThreadç±»å®ç°çš„ã€‚ä»¥ä¸‹æ˜¯å®ƒçš„æ–¹æ³•ç­¾åï¼š</p><pre><code>protected def processPartitionData(\n  topicPartition: TopicPartition,  // è¯»å–å“ªä¸ªåˆ†åŒºçš„æ•°æ®\n  fetchOffset: Long,               // è¯»å–åˆ°çš„æœ€æ–°ä½ç§»å€¼\n  partitionData: FetchData         // è¯»å–åˆ°çš„åˆ†åŒºæ¶ˆæ¯æ•°æ®\n): Option[LogAppendInfo]           // å†™å…¥å·²è¯»å–æ¶ˆæ¯æ•°æ®å‰çš„å…ƒæ•°æ®\n</code></pre><p>æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„å­—æ®µæ˜¯ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼Option[LogAppendInfo]ï¼š</p><ul>\n<li>å¯¹äºFollowerå‰¯æœ¬è¯»æ¶ˆæ¯å†™å…¥æ—¥å¿—è€Œè¨€ï¼Œä½ å¯ä»¥å¿½ç•¥è¿™é‡Œçš„Optionï¼Œå› ä¸ºå®ƒè‚¯å®šä¼šè¿”å›å…·ä½“çš„LogAppendInfoå®ä¾‹ï¼Œè€Œä¸ä¼šæ˜¯Noneã€‚</li>\n<li>è‡³äºLogAppendInfoç±»ï¼Œæˆ‘ä»¬åœ¨â€œæ—¥å¿—æ¨¡å—â€ä¸­å·²ç»ä»‹ç»è¿‡äº†ã€‚å®ƒå°è£…äº†å¾ˆå¤šæ¶ˆæ¯æ•°æ®è¢«å†™å…¥åˆ°æ—¥å¿—å‰çš„é‡è¦å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ¯”å¦‚é¦–æ¡æ¶ˆæ¯çš„ä½ç§»å€¼ã€æœ€åä¸€æ¡æ¶ˆæ¯ä½ç§»å€¼ã€æœ€å¤§æ—¶é—´æˆ³ç­‰ã€‚</li>\n</ul><p>é™¤äº†processPartitionDataæ–¹æ³•ï¼Œ<strong>å¦ä¸€ä¸ªé‡è¦çš„æ–¹æ³•æ˜¯truncateæ–¹æ³•</strong>ï¼Œå…¶ç­¾åä»£ç å¦‚ä¸‹ï¼š</p><pre><code>protected def truncate(\n  topicPartition: TopicPartition, // è¦å¯¹å“ªä¸ªåˆ†åŒºä¸‹å‰¯æœ¬æ‰§è¡Œæˆªæ–­æ“ä½œ\n  truncationState: OffsetTruncationState  // Offset + æˆªæ–­çŠ¶æ€\n): Unit\n</code></pre><p>è¿™é‡Œçš„OffsetTruncationStateç±»å°è£…äº†ä¸€ä¸ªä½ç§»å€¼å’Œä¸€ä¸ªæˆªæ–­å®Œæˆä¸å¦çš„å¸ƒå°”å€¼çŠ¶æ€ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼Œå‘Šè¯‰Kafkaè¦æŠŠæŒ‡å®šåˆ†åŒºä¸‹å‰¯æœ¬æˆªæ–­åˆ°å“ªä¸ªä½ç§»å€¼ã€‚</p><p><strong>ç¬¬3ä¸ªé‡è¦çš„æ–¹æ³•æ˜¯buildFetchæ–¹æ³•</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>protected def buildFetch(\n  // ä¸€ç»„è¦è¯»å–çš„åˆ†åŒºåˆ—è¡¨\n  // åˆ†åŒºæ˜¯å¦å¯è¯»å–å–å†³äºPartitionFetchStateä¸­çš„çŠ¶æ€\n  partitionMap: Map[TopicPartition, PartitionFetchState]): \n// å°è£…FetchRequest.Builderå¯¹è±¡\nResultWithPartitions[Option[ReplicaFetch]]\n</code></pre><p>buildFetchæ–¹æ³•çš„è¿”å›å€¼çœ‹ä¼¼å¾ˆå¤æ‚ï¼Œä½†å…¶å®å¦‚æœä½ é˜…è¯»æºç çš„è¯ï¼Œå°±ä¼šå‘ç°buildFetchçš„æœ¬è´¨å°±æ˜¯ï¼Œä¸ºæŒ‡å®šåˆ†åŒºæ„å»ºå¯¹åº”çš„FetchRequest.Builderå¯¹è±¡ï¼Œè€Œè¯¥å¯¹è±¡æ˜¯æ„å»ºFetchRequestçš„æ ¸å¿ƒç»„ä»¶ã€‚Kafkaä¸­ä»»ä½•ç±»å‹çš„æ¶ˆæ¯è¯»å–ï¼Œéƒ½æ˜¯é€šè¿‡ç»™æŒ‡å®šBrokerå‘é€FetchRequestè¯·æ±‚æ¥å®Œæˆçš„ã€‚</p><p><strong>ç¬¬4ä¸ªé‡è¦çš„æ–¹æ³•æ˜¯doWork</strong>ã€‚è™½ç„¶å®ƒçš„ä»£ç è¡Œæ•°ä¸å¤šï¼Œä½†å´<strong>æ˜¯ä¸²è”å‰é¢3ä¸ªæ–¹æ³•çš„ä¸»è¦å…¥å£æ–¹æ³•ï¼Œä¹Ÿæ˜¯AbstractFetcherThread</strong>ç±»çš„æ ¸å¿ƒæ–¹æ³•ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¦å¤šèŠ±ç‚¹æ—¶é—´ï¼Œå¼„æ˜ç™½è¿™äº›æ–¹æ³•æ˜¯æ€ä¹ˆç»„åˆåœ¨ä¸€èµ·å…±åŒå·¥ä½œçš„ã€‚æˆ‘ä¼šåœ¨ä¸‹èŠ‚è¯¾å’Œä½ è¯¦ç»†æ‹†è§£è¿™é‡Œé¢çš„ä»£ç åŸç†ã€‚</p><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ äº†Kafkaçš„å‰¯æœ¬åŒæ­¥æœºåˆ¶å’Œå‰¯æœ¬ç®¡ç†å™¨ç»„ä»¶ã€‚ç›®å‰ï¼ŒKafkaå‰¯æœ¬ä¹‹é—´çš„æ¶ˆæ¯åŒæ­¥æ˜¯ä¾é ReplicaFetcherThreadçº¿ç¨‹å®Œæˆçš„ã€‚æˆ‘ä»¬é‡ç‚¹é˜…è¯»äº†å®ƒçš„æŠ½è±¡åŸºç±»AbstractFetcherThreadçº¿ç¨‹ç±»çš„ä»£ç ã€‚ä½œä¸ºæ‹‰å–çº¿ç¨‹çš„å…¬å…±åŸºç±»ï¼ŒAbstractFetcherThreadç±»å®šä¹‰äº†å¾ˆå¤šé‡è¦æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚</p><ul>\n<li>AbstractFetcherThreadç±»ï¼šæ‹‰å–çº¿ç¨‹çš„æŠ½è±¡åŸºç±»ã€‚å®ƒå®šä¹‰äº†å…¬å…±æ–¹æ³•æ¥å¤„ç†æ‰€æœ‰æ‹‰å–çº¿ç¨‹éƒ½è¦å®ç°çš„é€»è¾‘ï¼Œå¦‚æ‰§è¡Œæˆªæ–­æ“ä½œï¼Œè·å–æ¶ˆæ¯ç­‰ã€‚</li>\n<li>æ‹‰å–çº¿ç¨‹é€»è¾‘ï¼šå¾ªç¯æ‰§è¡Œæˆªæ–­æ“ä½œå’Œè·å–æ•°æ®æ“ä½œã€‚</li>\n<li>åˆ†åŒºè¯»å–çŠ¶æ€ï¼šå½“å‰ï¼Œæºç å®šä¹‰äº†3ç±»åˆ†åŒºè¯»å–çŠ¶æ€ã€‚æ‹‰å–çº¿ç¨‹åªèƒ½æ‹‰å–å¤„äºå¯è¯»å–çŠ¶æ€çš„åˆ†åŒºçš„æ•°æ®ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/75/8d/750998c099f3d3575f6ba4c418bfce8d.jpg?wh=2250*1874\" alt=\"\"></p><p>ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä¼šå¸¦ä½ ä¸€èµ·å¯¹ç…§ç€doWorkæ–¹æ³•çš„ä»£ç ï¼ŒæŠŠæ‹‰å–çº¿ç¨‹çš„å®Œæ•´æ‰§è¡Œé€»è¾‘ä¸²è”ä¸€éï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±èƒ½å½»åº•æŒæ¡Followerå‰¯æœ¬æ‹‰å–çº¿ç¨‹çš„å·¥ä½œåŸç†äº†ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šé™†ç»­æ¥è§¦åˆ°ReplicaFetcherThreadç±»æºç çš„3ä¸ªé‡è¦æ–¹æ³•çš„ä»£ç ã€‚ä½ éœ€è¦ç†è§£å®ƒä»¬çš„å®ç°æœºåˆ¶ä»¥åŠdoWorkæ˜¯æ€ä¹ˆæŠŠå®ƒä»¬ç»„ç»‡åœ¨ä¸€èµ·çš„ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>è¯·ç®€å•æè¿°ä¸€ä¸‹handlePartitionsWithErrorsæ–¹æ³•çš„å®ç°åŸç†ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"20 | DelayedOperationï¼šBrokeræ˜¯æ€ä¹ˆå»¶æ—¶å¤„ç†è¯·æ±‚çš„ï¼Ÿ","id":245869},"right":{"article_title":"22 | ReplicaFetcherThreadï¼šFollowerå¦‚ä½•æ‹‰å–Leaderæ¶ˆæ¯ï¼Ÿ","id":248311}},"comments":[{"had_liked":false,"id":226685,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1592184821,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720427418993e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬ç»“åˆæºç é‡ç‚¹äº†è§£äº†Brokeræ˜¯å¦‚ä½•å¤„ç†å»¶æ—¶è¯·æ±‚çš„ã€‚è¯¾åæˆ‘æŒ‘äº†advanceClockæ–¹æ³•ä¸­çš„ä¸€ä¸ªè¯­å¥è®©ä½ å»åˆ†æå®ƒçš„ç›®çš„ã€‚è¿™è¡Œè¯­å¥è®¡ç®—ä½ çš„äº‹æ˜¯watcherListä¸­æ€»çš„å·²å®Œæˆçš„è¯·æ±‚æ•°ã€‚å¦å¤–åœ¨éå†watcherListçš„åŒæ—¶ï¼Œä»£ç è¿˜ä¼šå°†è¿™äº›å·²å®Œæˆçš„ä»»åŠ¡ä»é“¾è¡¨ä¸­ç§»é™¤ã€‚<br><br>okayï¼Œä½ åŒæ„è¿™ä¸ªè¯´æ³•å—ï¼Ÿæˆ–è€…è¯´ä½ æœ‰å…¶ä»–çš„çœ‹æ³•å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":1},{"had_liked":false,"id":226416,"user_name":"ä¼¯å®‰çŸ¥å¿ƒ","can_delete":false,"product_type":"c1","uid":1961835,"ip_address":"","ucode":"6C17706658672C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg","comment_is_top":false,"comment_ctime":1592089577,"is_pvip":false,"replies":[{"id":"83437","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1592182903,"ip_address":"","comment_id":226416,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5887056873","product_id":100050101,"comment_content":"handlePartitionsWithErrorsæ–¹æ³•ç®€å•æ¥è¯´å°±æ˜¯ï¼Œå¦‚æœå¯èƒ½å‡ºç°leaderåˆ‡æ¢ï¼Œå»¶è¿Ÿå¤„ç†å¸¦é”™è¯¯çš„partitionsï¼Œå¹¶ä¸”å»¶è¿Ÿå¤„ç†è¿‡ç¨‹åŠ äº†ä¸­æ–­ä¼˜å…ˆå¤„ç†çš„é”ï¼Œ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498232,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592182903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352493,"user_name":"æ¨é€¸æ—","can_delete":false,"product_type":"c1","uid":1167233,"ip_address":"","ucode":"4BF3CF3E2F1AC7","user_header":"https://static001.geekbang.org/account/avatar/00/11/cf/81/96f656ef.jpg","comment_is_top":false,"comment_ctime":1658729740,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658729740","product_id":100050101,"comment_content":"è€å¸ˆï¼ŒsourceBroker è¿™ä¸ªé…ç½®æ˜¯ä» Zookeeper &#47;broker&#47;ids&#47;[0-n] è¿™ä¸ªèŠ‚ç‚¹ä¸‹æ‹¿çš„é…ç½®å§ï¼Œå¦‚æœé…ç½®äº† advertised.listener é‚£å°±ä¼šå˜æˆè¿™ä¸ªé…ç½®çš„åœ°å€ï¼Œæ˜¯è¿™æ ·å—ï¼Ÿæˆ‘ç°åœ¨é‡åˆ°çš„é—®é¢˜å°±æ˜¯å†…å¤–ç½‘éåŒç½‘å¡çš„æƒ…å†µï¼Œå¤šå‰¯æœ¬çš„ Topic å‘é€æ¶ˆæ¯å°±ä¼šå¯¼è‡´ Broker æŠ¥é”™ã€‚","like_count":0},{"had_liked":false,"id":245279,"user_name":"æ¢èªæ˜","can_delete":false,"product_type":"c1","uid":2053611,"ip_address":"","ucode":"712FAD6E071585","user_header":"https://static001.geekbang.org/account/avatar/00/1f/55/eb/a441eda8.jpg","comment_is_top":false,"comment_ctime":1598882879,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598882879","product_id":100050101,"comment_content":"handlePartitionsWithErrors æ–¹æ³•çš„å®ç°åŸç†<br>1ã€å½“partitionsä¸ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨delayPartitionsæ–¹æ³•<br>2ã€è·å–æ¯ä¸ªåˆ†åŒºçš„partitionStatesï¼Œå¦‚æœå½“å‰åˆ†åŒºçŠ¶æ€ä¸æ˜¯isDelayedåˆ™å°†è¯¥åˆ†åŒºç§»åŠ¨è‡³æœ«å°¾ï¼Œè¿›è¡Œå»¶è¿Ÿå¤„ç†","like_count":0},{"had_liked":false,"id":244573,"user_name":"å¼ å­æ¶µ","can_delete":false,"product_type":"c1","uid":1743397,"ip_address":"","ucode":"57C509EA32B916","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg","comment_is_top":false,"comment_ctime":1598584568,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598584568","product_id":100050101,"comment_content":"handlePartitionsWithErrorsæ–¹æ³•æºç å¦‚ä¸‹ï¼š<br> &#47;&#47; å¤„ç†å¯èƒ½ç”±äºé¢†å¯¼å±‚å˜æ›´è€Œå¯¼è‡´çš„é”™è¯¯åˆ†åŒº<br>  private def handlePartitionsWithErrors(partitions: Iterable[TopicPartition], methodName: String): Unit = {<br>    if (partitions.nonEmpty) {<br>      debug(s&quot;Handling errors in $methodName for partitions $partitions&quot;)<br>      delayPartitions(partitions, fetchBackOffMs)<br>    }<br>  }<br>åº•å±‚è°ƒç”¨delayPartitionsæ–¹æ³•<br>def delayPartitions(partitions: Iterable[TopicPartition], delay: Long): Unit = {<br>    partitionMapLock.lockInterruptibly()<br>    try {<br>      for (partition &lt;- partitions) {<br>        Option(partitionStates.stateValue(partition)).foreach { currentFetchState =&gt;<br>          if (!currentFetchState.isDelayed) {<br>            partitionStates.updateAndMoveToEnd(partition, PartitionFetchState(currentFetchState.fetchOffset,<br>              currentFetchState.lag, currentFetchState.currentLeaderEpoch, Some(new DelayedItem(delay)), currentFetchState.state))<br>          }<br>        }<br>      }<br>      partitionMapCond.signalAll()<br>    } finally partitionMapLock.unlock()<br>  }","like_count":0}]}