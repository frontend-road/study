{"id":287040,"title":"22 | Watermark实践原理","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-Flink\">https://gitee.com/geektime-geekbang/geektime-Flink</a></p>","comments":[{"had_liked":false,"id":251603,"user_name":"大大王阿","can_delete":false,"product_type":"c3","uid":1973465,"ip_address":"","ucode":"7FFD139D467E90","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erf883jgR7BowWITPGPwoIYibxuA08NelA18ABItje4SV5Pb8WjKLseUIClEK8icibZygmR5zZykTFFA/132","comment_is_top":false,"comment_ctime":1601715041,"is_pvip":false,"replies":[{"id":92268,"content":"主要是看怎么波动，Watermark是单调递增的，主要会影响计算的正确性，如果数据乱序过于严重 那是不适合用流式方式处理的","user_name":"作者回复","user_name_real":"张利兵","uid":1119779,"ctime":1602406606,"ip_address":"","comment_id":251603,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"如果source的业务时间未经校验导致watermark的值异常大。是否会导致后续的计算全部失效？","like_count":1,"discussions":[{"author":{"id":1119779,"avatar":"https://static001.geekbang.org/account/avatar/00/11/16/23/99c7ede5.jpg","nickname":"张利兵","note":"","ucode":"DBAE17970AB143","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506558,"discussion_content":"主要是看怎么波动，Watermark是单调递增的，主要会影响计算的正确性，如果数据乱序过于严重 那是不适合用流式方式处理的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602406606,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249859,"user_name":"Allan","can_delete":false,"product_type":"c3","uid":1310388,"ip_address":"","ucode":"8DA4DBECC2C45C","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/b4/295338e7.jpg","comment_is_top":false,"comment_ctime":1600832086,"is_pvip":false,"replies":[{"id":93559,"content":"对的，也可以这么理解，就是增加了一个调整的时间，让数据按照原来的顺序处理","user_name":"作者回复","user_name_real":"张利兵","uid":1119779,"ctime":1603844797,"ip_address":"","comment_id":249859,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"watermark如何解决的乱序？mq接收到的数据是乱序的？如何把他们变成最后的有序？是通过设置watermark + window窗口，然后把数据全部聚集到一起，通过排序时间，这样输出有序的结果嘛？","like_count":0,"discussions":[{"author":{"id":1119779,"avatar":"https://static001.geekbang.org/account/avatar/00/11/16/23/99c7ede5.jpg","nickname":"张利兵","note":"","ucode":"DBAE17970AB143","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506038,"discussion_content":"对的，也可以这么理解，就是增加了一个调整的时间，让数据按照原来的顺序处理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603844797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288133,"user_name":"suke","can_delete":false,"product_type":"c3","uid":1007753,"ip_address":"","ucode":"C0287C31A4F45B","user_header":"","comment_is_top":false,"comment_ctime":1618314340,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"老师，watermark没说清楚啊，您的解释是较早时间到达是因为较早时间到达，感觉老师自己有点不知所云了","like_count":8,"discussions":[{"author":{"id":2630632,"avatar":"https://static001.geekbang.org/account/avatar/00/28/23/e8/9f445339.jpg","nickname":"章潘","note":"","ucode":"1A24E1B3084450","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538313,"discussion_content":"个人愚见：watermark跟事件时间和处理时间一样，本质上都是时间戳。watermark作为状态值，记录了当前流中可容忍的最小时间戳，如果有事件时间戳比watermark还小，就放弃该事件并触发窗口操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639398166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":381861,"user_name":"Emile_Lin","can_delete":false,"product_type":"c3","uid":1335178,"ip_address":"浙江","ucode":"1F182DE8F547C0","user_header":"https://static001.geekbang.org/account/avatar/00/14/5f/8a/f800167a.jpg","comment_is_top":false,"comment_ctime":1696045499,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"最大容忍时间 是否可以理解为 如果最大容忍时间为0，相当于只要数据event time小于watermark 即不纳入计算，最大程度避免乱序的时延，但是统计结果准确性会比较低；反之 如果最大容忍时间设置很大，则数据准确性可以保障，但时延会很高？ ","like_count":0},{"had_liked":false,"id":333088,"user_name":"Geek_007","can_delete":false,"product_type":"c3","uid":2416776,"ip_address":"","ucode":"795DA86106F9C4","user_header":"","comment_is_top":false,"comment_ctime":1644056087,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"最贴切的解释","like_count":0},{"had_liked":false,"id":284040,"user_name":"Geek_igahxw","can_delete":false,"product_type":"c3","uid":1335296,"ip_address":"","ucode":"A669272C4C249D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKJTudS4N3YSSfUzKf3ibMs3f4LmFRJ8jJXP0MEd8s4BkHkxicXQnoBGQpcsp75HgXFVOjHocQpgzaw/132","comment_is_top":false,"comment_ctime":1616047888,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"老师有几个问题，比如说“并行中的watermark”这张图中，map2把watermark发送给了window1和window2。那map1也会把自己的watermark发送给window1和window2。那么如图中所示，当前window1的timeservice是14，即将从map1接收到W(29)，也即将从map2接收到W(17)。\n1.window1的timeservice会变成什么样？\n2.在shuffle过程中，watermark是同时发送给下游算子所有的subtask吗？\n3.按照视频里所讲的，在使用processing time的情况下，实际上是基于本地的系统时间来作为window的触发条件依据，那么在使用event time的情况下，实际上使用的是每个算子的subtask中的timeservice中的通过watermark更新的时间来作为window的触发条件对吗？","like_count":0},{"had_liked":false,"id":280326,"user_name":"Allan","can_delete":false,"product_type":"c3","uid":1310388,"ip_address":"","ucode":"8DA4DBECC2C45C","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/b4/295338e7.jpg","comment_is_top":false,"comment_ctime":1614159919,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"到接入的数据是按照顺序的时候，就不需要我们设置watermark了。每个算子中的时钟服务都有一个TimeService，当进入算子的watermark流会更新当前的时钟时间。对于延迟的数据如何处理呢？","like_count":0},{"had_liked":false,"id":278443,"user_name":"追梦","can_delete":false,"product_type":"c3","uid":1183831,"ip_address":"","ucode":"54C6E76E8FE033","user_header":"https://static001.geekbang.org/account/avatar/00/12/10/57/1adfd4f7.jpg","comment_is_top":false,"comment_ctime":1612944084,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"老师是一个窗口已处理吗？实例中14已经到了W(17)中了，这个晚于W(13)的17呢？ 这个不会造成错误吗","like_count":0},{"had_liked":false,"id":260876,"user_name":"Geek_e3a3f6","can_delete":false,"product_type":"c3","uid":1204903,"ip_address":"","ucode":"2BC9AAF6725960","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJgiaIRyuaugicob1q2c64m06NwAj88EC1LJRxV457owqHZhJfYTQ4oO93f3bQv5kZHFJ9f6778JHXQ/132","comment_is_top":false,"comment_ctime":1605146809,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100058801,"comment_content":"并行中的时钟如何保证所有Operator的时钟是最新的？","like_count":0}]}