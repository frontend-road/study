{"id":374764,"title":"29 | å¤§è¡¨Joinå¤§è¡¨ï¼ˆäºŒï¼‰ï¼šä»€ä¹ˆæ˜¯è´Ÿéš…é¡½æŠ—çš„è°ƒä¼˜æ€è·¯ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬è¯´äº†åº”å¯¹â€œå¤§è¡¨Joinå¤§è¡¨â€çš„ç¬¬ä¸€ç§è°ƒä¼˜æ€è·¯æ˜¯åˆ†è€Œæ²»ä¹‹ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸€ä¸ªåºå¤§è€Œåˆå¤æ‚çš„Shuffle Joinè½¬åŒ–ä¸ºå¤šä¸ªè½»é‡çš„Broadcast Joinsã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬æ¥ç€æ¥è®²ç¬¬äºŒç§è°ƒä¼˜æ€è·¯ï¼šè´Ÿéš…é¡½æŠ—ã€‚</p><p>è´Ÿéš…é¡½æŠ—æŒ‡çš„æ˜¯ï¼Œå½“å†…è¡¨æ²¡æ³•åšåˆ°å‡åŒ€æ‹†åˆ†ï¼Œæˆ–æ˜¯å¤–è¡¨å‹æ ¹å°±æ²¡æœ‰åˆ†åŒºé”®ï¼Œä¸èƒ½åˆ©ç”¨DPPï¼Œåªèƒ½ä¾èµ–Shuffle Joinï¼Œå»å®Œæˆå¤§è¡¨ä¸å¤§è¡¨çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨çš„è°ƒä¼˜æ–¹æ³•å’Œæ‰‹æ®µã€‚è¿™ç±»æ–¹æ³•æ¯”è¾ƒåºæ‚ï¼Œé€‚ç”¨çš„åœºæ™¯å„ä¸ç›¸åŒã€‚ä»æ•°æ®åˆ†å¸ƒçš„è§’åº¦å‡ºå‘ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬åˆ†ä¸¤ç§å¸¸è§çš„æƒ…å†µæ¥è®¨è®ºï¼Œåˆ†åˆ«æ˜¯æ•°æ®åˆ†å¸ƒå‡åŒ€å’Œæ•°æ®å€¾æ–œã€‚</p><p>æˆ‘ä»¬å…ˆæ¥è¯´è¯´ï¼Œåœ¨æ•°æ®åˆ†å¸ƒå‡åŒ€çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•åº”å¯¹â€œå¤§è¡¨Joinå¤§è¡¨â€çš„è®¡ç®—åœºæ™¯ã€‚</p><h2>æ•°æ®åˆ†å¸ƒå‡åŒ€</h2><p>åœ¨ç¬¬27è®²çš„æœ€åï¼Œæˆ‘ä»¬è¯´è¿‡ï¼Œå½“å‚ä¸å…³è”çš„å¤§è¡¨ä¸å°è¡¨æ»¡è¶³å¦‚ä¸‹æ¡ä»¶çš„æ—¶å€™ï¼ŒShuffle Hash Joinçš„æ‰§è¡Œæ•ˆç‡ï¼Œå¾€å¾€æ¯”Spark SQLé»˜è®¤çš„Shuffle Sort Merge Joinæ›´å¥½ã€‚</p><ul>\n<li>ä¸¤å¼ è¡¨æ•°æ®åˆ†å¸ƒå‡åŒ€ã€‚</li>\n<li>å†…è¡¨æ‰€æœ‰æ•°æ®åˆ†ç‰‡ï¼Œèƒ½å¤Ÿå®Œå…¨æ”¾å…¥å†…å­˜ã€‚</li>\n</ul><p>å®é™…ä¸Šï¼Œè¿™ä¸ªè°ƒä¼˜æŠ€å·§åŒæ ·é€‚ç”¨äºâ€œå¤§è¡¨Joinå¤§è¡¨â€çš„åœºæ™¯ï¼ŒåŸå› å…¶å®å¾ˆç®€å•ï¼Œè¿™ä¸¤ä¸ªæ¡ä»¶ä¸æ•°æ®è¡¨æœ¬èº«çš„å°ºå¯¸æ— å…³ï¼Œåªä¸å…¶æ˜¯å¦åˆ†å¸ƒå‡åŒ€æœ‰å…³ã€‚ä¸è¿‡ï¼Œä¸ºäº†ç¡®ä¿Shuffle Hash Joinè®¡ç®—çš„ç¨³å®šæ€§ï¼Œæˆ‘ä»¬éœ€è¦ç‰¹åˆ«æ³¨æ„ä¸Šé¢åˆ—å‡ºçš„ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯å†…è¡¨æ‰€æœ‰çš„æ•°æ®åˆ†ç‰‡éƒ½èƒ½å¤Ÿæ”¾å…¥å†…å­˜ã€‚</p><!-- [[[read_end]]] --><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆç¡®ä¿ç¬¬äºŒä¸ªæ¡ä»¶å¾—ä»¥æˆç«‹å‘¢ï¼Ÿå…¶å®ï¼Œåªè¦å¤„ç†å¥½å¹¶è¡Œåº¦ã€å¹¶å‘åº¦ä¸æ‰§è¡Œå†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©å†…è¡¨çš„æ¯ä¸€ä¸ªæ•°æ®åˆ†ç‰‡éƒ½æ°å¥½æ”¾å…¥æ‰§è¡Œå†…å­˜ä¸­ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å…ˆæ ¹æ®å¹¶å‘åº¦ä¸æ‰§è¡Œå†…å­˜ï¼Œè®¡ç®—å‡ºå¯ä¾›æ¯ä¸ªTaskæ¶ˆè€—çš„å†…å­˜ä¸Šä¸‹é™ï¼Œç„¶åç»“åˆåˆ†å¸ƒå¼æ•°æ®é›†å°ºå¯¸ä¸ä¸Šä¸‹é™ï¼Œå€’æ¨å‡ºä¸ä¹‹åŒ¹é…çš„å¹¶è¡Œåº¦ã€‚æ›´è¯¦ç»†çš„å†…å®¹ä½ å¯ä»¥å»çœ‹çœ‹<a href=\"https://time.geekbang.org/column/article/362710\">ç¬¬14è®²</a>ã€‚</p><p>é‚£æˆ‘ä»¬è¯¥å¦‚ä½•å¼ºåˆ¶Spark SQLåœ¨è¿è¡Œæ—¶é€‰æ‹©Shuffle Hash Joinæœºåˆ¶å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åˆ©ç”¨Join Hintsã€‚è¿™ä¸ªæŠ€å·§æˆ‘ä»¬è®²è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œæ‰€ä»¥è¿™é‡Œï¼Œæˆ‘ç›´æ¥ä»¥ä¸Šä¸€è®²ä¸­çš„æŸ¥è¯¢ä¸ºä¾‹ï¼ŒæŠŠå®ƒçš„ä½¿ç”¨æ–¹æ³•å†™åœ¨äº†ä¸‹é¢ï¼Œæ–¹ä¾¿ä½ å¤ä¹ ã€‚</p><pre><code>//æŸ¥è¯¢è¯­å¥ä¸­ä½¿ç”¨Join hints\nselect /*+ shuffle_hash(orders) */ sum(tx.price * tx.quantity) as revenue, o.orderId\nfrom transactions as tx inner join orders as o\non tx.orderId = o.orderId\nwhere o.status = â€˜COMPLETEâ€™\nand o.date between â€˜2020-01-01â€™ and â€˜2020-03-31â€™\ngroup by o.orderId\n</code></pre><h2>æ•°æ®å€¾æ–œ</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†è¯´è¯´ï¼Œå½“å‚ä¸Joinçš„ä¸¤å¼ è¡¨å­˜åœ¨æ•°æ®å€¾æ–œé—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åº”å¯¹â€œå¤§è¡¨Joinå¤§è¡¨â€çš„è®¡ç®—åœºæ™¯ã€‚å¯¹äºâ€œå¤§è¡¨Joinå¤§è¡¨â€çš„æ•°æ®å€¾æ–œé—®é¢˜ï¼Œæ ¹æ®å€¾æ–œä½ç½®çš„ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥åˆ†ä¸º3ç§æƒ…å†µæ¥è®¨è®ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/be/73/beb46de87f456924fc1414b93f8c0a73.jpeg?wh=1256*588\" alt=\"\" title=\"å¤§è¡¨Joinå¤§è¡¨æ•°æ®å€¾æ–œçš„3ç§æƒ…å†µ\"></p><p>å…¶å®ï¼Œä¸ç®¡å“ªç§è¡¨å€¾æ–œï¼Œå®ƒä»¬çš„è°ƒä¼˜æŠ€å·§éƒ½æ˜¯ç±»ä¼¼çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±ä»¥ç¬¬ä¸€ç§æƒ…å†µä¸ºä¾‹ï¼Œä¹Ÿå°±æ˜¯å¤–è¡¨å€¾æ–œã€å†…è¡¨åˆ†å¸ƒå‡åŒ€çš„æƒ…å†µï¼Œå»æ¢è®¨æ•°æ®å€¾æ–œçš„åº”å¯¹æ–¹æ³•ã€‚</p><h3>ä»¥Taskä¸ºç²’åº¦è§£å†³æ•°æ®å€¾æ–œ</h3><p>å­¦è¿‡AQEä¹‹åï¼Œè¦åº”å¯¹æ•°æ®å€¾æ–œï¼Œæƒ³å¿…ä½ å¾ˆå¿«å°±ä¼šæƒ³åˆ°AQEçš„ç‰¹æ€§ï¼šè‡ªåŠ¨å€¾æ–œå¤„ç†ã€‚ç»™å®šå¦‚ä¸‹é…ç½®é¡¹å‚æ•°ï¼ŒSpark SQLåœ¨è¿è¡Œæ—¶å¯ä»¥å°†ç­–ç•¥OptimizeSkewedJoinæ’å…¥åˆ°ç‰©ç†è®¡åˆ’ä¸­ï¼Œè‡ªåŠ¨å®ŒæˆJoinè¿‡ç¨‹ä¸­å¯¹äºæ•°æ®å€¾æ–œçš„å¤„ç†ã€‚</p><ul>\n<li>spark.sql.adaptive.skewJoin.skewedPartitionFactorï¼Œåˆ¤å®šå€¾æ–œçš„è†¨èƒ€ç³»æ•°ã€‚</li>\n<li>spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytesï¼Œåˆ¤å®šå€¾æ–œçš„æœ€ä½é˜ˆå€¼ã€‚</li>\n<li>spark.sql.adaptive.advisoryPartitionSizeInBytesï¼Œä»¥å­—èŠ‚ä¸ºå•ä½å®šä¹‰æ‹†åˆ†ç²’åº¦ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/33/a9/33a112480b1c1bf8b21d26412a7857a9.jpg?wh=4359*1224\" alt=\"\" title=\"AQEä¸­çš„è‡ªåŠ¨å€¾æ–œå¤„ç†\"></p><p>Joinè¿‡ç¨‹ä¸­çš„è‡ªåŠ¨å€¾æ–œå¤„ç†å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“AQEæ£€æµ‹åˆ°å¤–è¡¨å­˜åœ¨å€¾æ–œåˆ†åŒºä¹‹åï¼Œå®ƒä¼šä»¥spark.sql.adaptive.advisoryPartitionSizeInBytesé…ç½®çš„æ•°å€¼ä¸ºæ‹†åˆ†ç²’åº¦ï¼ŒæŠŠå€¾æ–œåˆ†åŒºæ‹†åˆ†ä¸ºå¤šä¸ªæ•°æ®åˆ†åŒºã€‚ä¸æ­¤åŒæ—¶ï¼ŒAQEè¿˜éœ€è¦å¯¹å†…è¡¨ä¸­å¯¹åº”çš„æ•°æ®åˆ†åŒºè¿›è¡Œå¤åˆ¶ï¼Œæ¥ä¿æŠ¤ä¸¤è¡¨ä¹‹é—´çš„å…³è”å…³ç³»ã€‚</p><p>æœ‰äº†AQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†ç‰¹æ€§ï¼Œåœ¨åº”å¯¹æ•°æ®å€¾æ–œé—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç¡®å®èƒ½å¤Ÿå¤§å¹…èŠ‚çœå¼€å‘æˆæœ¬ã€‚ä¸è¿‡ï¼Œå¤©ä¸‹æ²¡æœ‰å…è´¹çš„åˆé¤ï¼ŒAQEçš„å€¾æ–œå¤„ç†æ˜¯ä»¥Taskä¸ºç²’åº¦çš„ï¼Œè¿™æ„å‘³ç€åŸæœ¬Executorsä¹‹é—´çš„è´Ÿè½½å€¾æ–œå¹¶æ²¡æœ‰å¾—åˆ°æ ¹æœ¬æ”¹å–„ã€‚è¿™åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><p><img src=\"https://static001.geekbang.org/resource/image/f4/72/f4fe3149112466174bdefcc0ee573d72.jpg?wh=2889*1614\" alt=\"\" title=\"ä»¥Taskä¸ºç²’åº¦çš„è´Ÿè½½å‡è¡¡\"></p><p>æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æŸå¼ è¡¨åœ¨Shuffleè¿‡åæœ‰ä¸¤ä¸ªå€¾æ–œåˆ†åŒºå¦‚ä¸Šå›¾ï¼Œå®ƒä»¬åˆåˆšå¥½éƒ½è¢«Shuffleåˆ°äº†åŒä¸€ä¸ªæ‰§è¡Œå™¨ï¼šExecutor 0ã€‚åœ¨AQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†æœºåˆ¶ä¸‹ï¼Œä¸¤ä¸ªå€¾æ–œåˆ†åŒºåˆ†åˆ«è¢«æ‹†åˆ†å˜æˆäº†4ä¸ªå°ºå¯¸é€‚ä¸­çš„æ•°æ®åˆ†åŒºã€‚å¦‚æ­¤ä¸€æ¥ï¼ŒExecutor 0ä¸­æ‰€æœ‰Taskçš„è®¡ç®—è´Ÿè½½éƒ½å¾—åˆ°äº†å¹³è¡¡ã€‚ä½†æ˜¯ï¼Œç›¸æ¯”Executor 1ï¼ŒExecutor 0æ•´ä½“çš„è®¡ç®—è´Ÿè½½è¿˜æ˜¯é‚£ä¹ˆå¤šï¼Œå¹¶æ²¡æœ‰å› ä¸ºAQEçš„è‡ªåŠ¨å¤„ç†è€Œå¾—åˆ°ä»»ä½•ç¼“è§£ã€‚</p><h3>ä»¥Executorä¸ºç²’åº¦è§£å†³æ•°æ®å€¾æ–œ</h3><p>ä½ ä¹Ÿè®¸ä¼šè¯´ï¼šâ€œå“ªä¼šé‚£ä¹ˆå‡‘å·§ï¼Œå€¾æ–œçš„åˆ†åŒºåˆšå¥½å…¨éƒ½è½åœ¨åŒä¸€ä¸ªExecutorä¸Šï¼Ÿâ€ç¡®å®ï¼Œåˆšæ‰çš„ä¾‹å­ä¸»è¦æ˜¯ä¸ºäº†å¸®ä½ è§£é‡Šæ¸…æ¥šå€¾æ–œç²’åº¦è¿™ä¸ªæ¦‚å¿µï¼Œå¦‚æœå®é™…åº”ç”¨ä¸­å€¾æ–œåˆ†åŒºåœ¨é›†ç¾¤ä¸­çš„åˆ†å¸ƒæ¯”è¾ƒå¹³å‡çš„è¯ï¼ŒAQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†æœºåˆ¶ç¡®å®å°±æ˜¯å¼€å‘è€…çš„â€œçµä¸¹å¦™è¯â€ã€‚</p><p>ç„¶è€Œï¼Œå‡¡äº‹æ€»æœ‰ä¸ªä¸‡ä¸€ï¼Œæˆ‘ä»¬åœ¨æ¢è®¨è°ƒä¼˜æ–¹æ¡ˆçš„æ—¶å€™ï¼Œè¿˜æ˜¯è¦è€ƒè™‘å‘¨å…¨ï¼šå¦‚æœä½ çš„åœºæ™¯å°±å’Œå’±ä»¬çš„ä¾‹å­ä¸€æ ·ï¼Œå€¾æ–œåˆ†åŒºåˆšå¥½è½åœ¨é›†ç¾¤ä¸­å°‘æ•°çš„Executorsä¸Šï¼Œä½ è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šâ€œåˆ†è€Œæ²»ä¹‹â€å’Œâ€œä¸¤é˜¶æ®µShuffleâ€ã€‚</p><p>è¿™é‡Œçš„åˆ†è€Œæ²»ä¹‹ä¸ä¸Šä¸€è®²çš„åˆ†è€Œæ²»ä¹‹åœ¨æ€æƒ³ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯ä»¥ä»»åŠ¡åˆ†è§£çš„æ–¹å¼æ¥è§£å†³å¤æ‚é—®é¢˜ã€‚åŒºåˆ«åœ¨äºæˆ‘ä»¬ä»Šå¤©è¦è®²çš„ï¼Œæ˜¯ä»¥Join Keyæ˜¯å¦å€¾æ–œä¸ºä¾æ®æ¥æ‹†è§£å­ä»»åŠ¡ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºå¤–è¡¨ä¸­æ‰€æœ‰çš„Join Keysï¼Œæˆ‘ä»¬å…ˆæŒ‰ç…§æ˜¯å¦å­˜åœ¨å€¾æ–œæŠŠå®ƒä»¬åˆ†ä¸ºä¸¤ç»„ã€‚ä¸€ç»„æ˜¯å­˜åœ¨å€¾æ–œé—®é¢˜çš„Join Keysï¼Œå¦ä¸€ç»„æ˜¯åˆ†å¸ƒå‡åŒ€çš„Join Keysã€‚å› ä¸ºç»™å®šä¸¤ç»„ä¸åŒçš„Join Keysï¼Œç›¸åº”åœ°æˆ‘ä»¬æŠŠå†…è¡¨çš„æ•°æ®ä¹Ÿåˆ†ä¸ºä¸¤ä»½ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c2/e2/c22de99104b0a9cb0d5cfdffebd42ee2.jpg?wh=4899*1449\" alt=\"\" title=\"åˆ†è€Œæ²»ä¹‹ï¼šæŒ‰ç…§Join Keysæ˜¯å¦å€¾æ–œå¯¹æ•°æ®è¿›è¡Œåˆ†ç»„\"></p><p>é‚£ä¹ˆï¼Œåˆ†è€Œæ²»ä¹‹çš„å«ä¹‰å°±æ˜¯ï¼Œå¯¹äºå†…å¤–è¡¨ä¸­ä¸¤ç»„ä¸åŒçš„æ•°æ®ï¼Œæˆ‘ä»¬åˆ†åˆ«é‡‡ç”¨ä¸åŒçš„æ–¹æ³•åšå…³è”è®¡ç®—ï¼Œç„¶åé€šè¿‡Unionæ“ä½œï¼Œå†æŠŠä¸¤ä¸ªå…³è”è®¡ç®—çš„ç»“æœé›†åšåˆå¹¶ï¼Œæœ€ç»ˆå¾—åˆ°â€œå¤§è¡¨Joinå¤§è¡¨â€çš„è®¡ç®—ç»“æœï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>å¯¹äºJoin Keysåˆ†å¸ƒå‡åŒ€çš„æ•°æ®éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥æ²¿ç”¨æŠŠShuffle Sort Merge Joinè½¬åŒ–ä¸ºShuffle Hash Joinçš„æ–¹æ³•ã€‚å¯¹äºJoin Keyså­˜åœ¨å€¾æ–œé—®é¢˜çš„æ•°æ®éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°±éœ€è¦å€ŸåŠ©â€œä¸¤é˜¶æ®µShuffleâ€çš„è°ƒä¼˜æŠ€å·§ï¼Œæ¥å¹³è¡¡Executorsä¹‹é—´çš„å·¥ä½œè´Ÿè½½ã€‚é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯â€œä¸¤é˜¶æ®µShuffleâ€å‘¢ï¼Ÿ</p><h4>å¦‚ä½•ç†è§£â€œä¸¤é˜¶æ®µShuffleâ€ï¼Ÿ</h4><p>ç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬ï¼Œâ€œä¸¤é˜¶æ®µShuffleâ€æŒ‡çš„æ˜¯ï¼Œé€šè¿‡â€œåŠ ç›ã€Shuffleã€å…³è”ã€èšåˆâ€ä¸â€œå»ç›åŒ–ã€Shuffleã€èšåˆâ€è¿™ä¸¤ä¸ªé˜¶æ®µçš„è®¡ç®—è¿‡ç¨‹ï¼Œåœ¨ä¸ç ´ååŸæœ‰å…³è”å…³ç³»çš„å‰æä¸‹ï¼Œåœ¨é›†ç¾¤èŒƒå›´å†…ä»¥Executorsä¸ºç²’åº¦å¹³è¡¡è®¡ç®—è´Ÿè½½ ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/34/21/348ddabcd5f9980de114ae9d5b96d321.jpg?wh=5394*1689\" alt=\"\" title=\"ä¸¤é˜¶æ®µShuffle\"></p><p>æˆ‘ä»¬å…ˆæ¥è¯´è¯´ç¬¬ä¸€é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯â€œåŠ ç›ã€Shuffleã€å…³è”ã€èšåˆâ€çš„è®¡ç®—è¿‡ç¨‹ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸ªé˜¶æ®µçš„è®¡ç®—åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼Œå…¶ä¸­æœ€ä¸ºå…³é”®çš„å°±æ˜¯ç¬¬ä¸€æ­¥çš„åŠ ç›ã€‚åŠ ç›æ¥æºäºå•è¯Saltingï¼Œå¬ä¸Šå»æŒºç„ä¹ï¼Œå®é™…ä¸Šå°±æ˜¯ç»™å€¾æ–œçš„Join Keysæ·»åŠ åç¼€ã€‚åŠ ç›çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯æŠŠåŸæœ¬é›†ä¸­å€¾æ–œçš„Join Keysæ‰“æ•£ï¼Œåœ¨è¿›è¡ŒShuffleæ“ä½œçš„æ—¶å€™ï¼Œè®©åŸæœ¬åº”è¯¥åˆ†å‘åˆ°æŸä¸€ä¸ªExecutorçš„å€¾æ–œæ•°æ®ï¼Œå‡æ‘Šåˆ°é›†ç¾¤ä¸­çš„å¤šä¸ªExecutorsä¸Šï¼Œä»è€Œä»¥è¿™ç§æ–¹å¼æ¥æ¶ˆé™¤å€¾æ–œã€å¹³è¡¡Executorsä¹‹é—´çš„è®¡ç®—è´Ÿè½½ã€‚</p><p>å¯¹äºåŠ ç›æ“ä½œï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç¡®å®šåŠ ç›çš„ç²’åº¦ï¼Œæ¥æ§åˆ¶æ•°æ®æ‰“æ•£çš„ç¨‹åº¦ï¼Œç²’åº¦è¶Šé«˜ï¼ŒåŠ ç›åçš„æ•°æ®è¶Šåˆ†æ•£ã€‚ç”±äºåŠ ç›çš„åˆè¡·æ˜¯ä»¥Executorsä¸ºç²’åº¦å¹³è¡¡è®¡ç®—è´Ÿè½½ï¼Œå› æ­¤é€šå¸¸æ¥è¯´ï¼Œå–Executorsæ€»æ•°#Nä½œä¸ºåŠ ç›ç²’åº¦å¾€å¾€æ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ã€‚å…¶æ¬¡ï¼Œä¸ºäº†ä¿æŒå†…å¤–è¡¨çš„å…³è”å…³ç³»ä¸è¢«ç ´åï¼Œå¤–è¡¨å’Œå†…è¡¨éœ€è¦åŒæ—¶åšåŠ ç›å¤„ç†ï¼Œä½†å¤„ç†æ–¹æ³•ç¨æœ‰ä¸åŒã€‚</p><p>å¤–è¡¨çš„å¤„ç†ç§°ä½œâ€œéšæœºåŠ ç›â€ï¼Œå…·ä½“çš„æ“ä½œæ–¹æ³•æ˜¯ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªå€¾æ–œçš„Join Keyï¼Œæˆ‘ä»¬éƒ½ç»™å®ƒåŠ ä¸Š1åˆ°#Nä¹‹é—´çš„ä¸€ä¸ªéšæœºåç¼€ã€‚ä»¥Join Key = â€˜é»„å°ä¹™â€™æ¥ä¸¾ä¾‹ï¼Œå‡è®¾N = 5ï¼Œé‚£ä¹ˆå¤–è¡¨åŠ ç›ä¹‹åï¼ŒåŸå…ˆJoin Key = â€˜é»„å°ä¹™â€™çš„æ‰€æœ‰æ•°æ®è®°å½•ï¼Œå°±éƒ½è¢«æ‰“æ•£æˆäº†Join Keyä¸ºï¼ˆâ€˜é»„å°ä¹™_1â€™ï¼Œâ€˜é»„å°ä¹™_2â€™ï¼Œâ€˜é»„å°ä¹™_3â€™ï¼Œâ€˜é»„å°ä¹™_4â€™ï¼Œâ€˜é»„å°ä¹™_5â€™ï¼‰çš„æ•°æ®è®°å½•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/4f/cd1858531a08371047481120b0c3544f.jpg?wh=2724*579\" alt=\"\" title=\"å¤–è¡¨åŠ ç›\"></p><p>å†…è¡¨çš„å¤„ç†ç§°ä¸ºâ€œå¤åˆ¶åŠ ç›â€ï¼Œå…·ä½“çš„æ“ä½œæ–¹æ³•æ˜¯ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªå€¾æ–œçš„Join Keyï¼Œæˆ‘ä»¬éƒ½æŠŠåŸæ•°æ®å¤åˆ¶ï¼ˆ#N â€“ 1ï¼‰ä»½ï¼Œä»è€Œå¾—åˆ°#Nä»½æ•°æ®å‰¯æœ¬ã€‚å¯¹äºæ¯ä¸€ä»½å‰¯æœ¬ï¼Œæˆ‘ä»¬ä¸ºå…¶Join Keyè¿½åŠ 1åˆ°#Nä¹‹é—´çš„å›ºå®šåç¼€ï¼Œè®©å®ƒä¸æ‰“æ•£åçš„å¤–è¡¨æ•°æ®ä¿æŒä¸€è‡´ã€‚å¯¹äºåˆšåˆšJoin Key = â€˜é»„å°ä¹™â€™çš„ä¾‹å­æ¥è¯´ï¼Œåœ¨å†…è¡¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠâ€˜é»„å°ä¹™â€™çš„æ•°æ®å¤åˆ¶4ä»½ï¼Œç„¶åä¾æ¬¡ä¸ºæ¯ä»½æ•°æ®çš„Join Keyè¿½åŠ 1åˆ°5çš„å›ºå®šåç¼€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8d/22/8d843fb98d834df38080a68064522322.jpg?wh=2724*579?wh=2724*579\" alt=\"\" title=\"å†…è¡¨åŠ ç›\"></p><p>å†…å¤–è¡¨åˆ†åˆ«åŠ ç›ä¹‹åï¼Œæ•°æ®å€¾æ–œé—®é¢˜å°±è¢«æ¶ˆé™¤äº†ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¸¸è§„ä¼˜åŒ–æ–¹æ³•ï¼Œæ¯”å¦‚ï¼Œå°†Shuffle Sort Merge Joinè½¬åŒ–ä¸ºShuffle Hash Joinï¼Œå»ç»§ç»­æ‰§è¡ŒShuffleã€å…³è”å’Œèšåˆæ“ä½œã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œâ€œä¸¤é˜¶æ®µShuffleâ€ çš„ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œå®Œæ¯•ï¼Œæˆ‘ä»¬å¾—åˆ°äº†åˆæ­¥çš„èšåˆç»“æœï¼Œè¿™äº›ç»“æœæ˜¯ä»¥æ‰“æ•£çš„Join Keysä¸ºç²’åº¦è¿›è¡Œè®¡ç®—å¾—åˆ°çš„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8d/22/8d843fb98d834df38080a68064522322.jpg?wh=2724*579?wh=2724*579\" alt=\"\" title=\"ä¸€é˜¶æ®µShuffleã€å…³è”ã€èšåˆ\"></p><p>æˆ‘ä»¬åˆšåˆšè¯´ï¼Œç¬¬ä¸€é˜¶æ®µåŠ ç›çš„ç›®çš„åœ¨äºå°†æ•°æ®æ‰“æ•£ã€å¹³è¡¡è®¡ç®—è´Ÿè½½ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»å¾—åˆ°äº†æ•°æ®æ‰“æ•£ä¹‹ååˆæ­¥çš„èšåˆç»“æœï¼Œç¦»æœ€ç»ˆçš„è®¡ç®—ç»“æœä»…æœ‰ä¸€æ­¥ä¹‹é¥ã€‚ä¸è¿‡ï¼Œä¸ºäº†è¿˜åŸæœ€åˆçš„è®¡ç®—é€»è¾‘ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠä¹‹å‰åŠ ä¸Šçš„â€œç›ç²’â€å†å»æ‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/36/53/36d1829e2b550a3079707eee9712d253.jpg?wh=2319*1359\" alt=\"\" title=\"äºŒé˜¶æ®µShuffleã€èšåˆ\"></p><p>ç¬¬äºŒé˜¶æ®µçš„è®¡ç®—åŒ…å«â€œå»ç›åŒ–ã€Shuffleã€èšåˆâ€è¿™3ä¸ªæ­¥éª¤ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠæ¯ä¸€ä¸ªJoin Keyçš„åç¼€å»æ‰ï¼Œè¿™ä¸€æ­¥å«åšâ€œå»ç›åŒ–â€ã€‚ç„¶åï¼Œæˆ‘ä»¬æŒ‰ç…§åŸæ¥çš„Join Keyå†åšä¸€éShuffleå’Œèšåˆè®¡ç®—ï¼Œè¿™ä¸€æ­¥è®¡ç®—å¾—åˆ°çš„ç»“æœï¼Œå°±æ˜¯â€œåˆ†è€Œæ²»ä¹‹â€å½“ä¸­å€¾æ–œéƒ¨åˆ†çš„è®¡ç®—ç»“æœã€‚</p><p>ç»è¿‡â€œä¸¤é˜¶æ®µShuffleâ€çš„è®¡ç®—ä¼˜åŒ–ï¼Œæˆ‘ä»¬ç»ˆäºå¾—åˆ°äº†å€¾æ–œéƒ¨åˆ†çš„å…³è”ç»“æœã€‚å°†è¿™éƒ¨åˆ†ç»“æœä¸â€œåˆ†è€Œæ²»ä¹‹â€å½“ä¸­å‡åŒ€éƒ¨åˆ†çš„è®¡ç®—ç»“æœåˆå¹¶ï¼Œæˆ‘ä»¬å°±èƒ½å®Œæˆå­˜åœ¨å€¾æ–œé—®é¢˜çš„â€œå¤§è¡¨Joinå¤§è¡¨â€çš„è®¡ç®—åœºæ™¯ã€‚</p><h4>ä»¥Executorsä¸ºç²’åº¦çš„è°ƒä¼˜å®æˆ˜</h4><p>åº”è¯¥è¯´ï¼Œä»¥Executorsä¸ºç²’åº¦å¹³è¡¡è®¡ç®—è´Ÿè½½çš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œæ˜¯æˆ‘ä»¬å­¦ä¹ è¿‡çš„è°ƒä¼˜æŠ€å·§ä¸­æœ€å¤æ‚çš„ã€‚å› æ­¤ï¼Œå’±ä»¬æœ‰å¿…è¦ç»“åˆå®é™…çš„åº”ç”¨æ¡ˆä¾‹ï¼Œæ¥è¯¦ç»†è®²è§£å…·ä½“çš„å®ç°æ–¹æ³•ã€‚ä¸ºäº†æ–¹ä¾¿ä½ å¯¹ä¸åŒçš„è°ƒä¼˜æ–¹æ³•åšå¯¹æ¯”ï¼Œæˆ‘ä»¬ä¸å¦¨ä»¥ä¸Šä¸€è®²è·¨å¢ƒç”µå•†çš„åœºæ™¯ä¸ºä¾‹æ¥è®²ã€‚</p><p>å’±ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹è¿™å®¶ç”µå•†çš„ä¸šåŠ¡éœ€æ±‚ï¼Œç»™å®šorderså’Œtransactionsä¸¤å¼ ä½“é‡éƒ½åœ¨TBçº§åˆ«çš„äº‹å®è¡¨ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±è®¡ç®—ä¸€æ¬¡ä¸Šä¸€ä¸ªå­£åº¦æ‰€æœ‰è®¢å•çš„äº¤æ˜“é¢ï¼Œå…·ä½“çš„ä¸šåŠ¡ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//ç»Ÿè®¡è®¢å•äº¤æ˜“é¢çš„ä»£ç å®ç°\nval txFile: String = _\nval orderFile: String = _\n \nval transactions: DataFrame = spark.read.parquent(txFile)\nval orders: DataFrame = spark.read.parquent(orderFile)\n \ntransactions.createOrReplaceTempView(â€œtransactionsâ€)\norders.createOrReplaceTempView(â€œordersâ€)\n \nval query: String = â€œ\nselect sum(tx.price * tx.quantity) as revenue, o.orderId\nfrom transactions as tx inner join orders as o\non tx.orderId = o.orderId\nwhere o.status = â€˜COMPLETEâ€™\nand o.date between â€˜2020-01-01â€™ and â€˜2020-03-31â€™\ngroup by o.orderId\nâ€\n \nval outFile: String = _\nspark.sql(query).save.parquet(outFile)\n\n</code></pre><p>å¯¹äºè¿™æ ·ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°åˆšåˆšè¯´è¿‡çš„ä¼˜åŒ–è¿‡ç¨‹å‘¢ï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬å…ˆéµå¾ªâ€œåˆ†è€Œæ²»ä¹‹â€çš„æ€æƒ³ï¼ŒæŠŠå†…å¤–è¡¨çš„æ•°æ®åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ç¬¬ä¸€éƒ¨åˆ†åŒ…å«æ‰€æœ‰å­˜åœ¨å€¾æ–œé—®é¢˜çš„Join KeysåŠå…¶å¯¹åº”çš„Payloadsï¼Œç¬¬äºŒéƒ¨åˆ†ä¿ç•™çš„æ˜¯åˆ†å¸ƒå‡åŒ€çš„Join Keyså’Œç›¸åº”çš„Payloadsã€‚å‡è®¾æˆ‘ä»¬æŠŠæ‰€æœ‰å€¾æ–œçš„orderIdï¼Œä¹Ÿå°±æ˜¯Join Keyä¿å­˜åœ¨æ•°ç»„skewOrderIdsä¸­ï¼Œè€ŒæŠŠåˆ†å¸ƒå‡åŒ€çš„orderIdä¿æŒåœ¨æ•°ç»„evenOrderIdsä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªæ•°ç»„ï¼ŒæŠŠå†…å¤–è¡¨å„è‡ªæ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚</p><pre><code>//æ ¹æ®Join Keysæ˜¯å¦å€¾æ–œã€å°†å†…å¤–è¡¨åˆ†åˆ«æ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†\nimport org.apache.spark.sql.functions.array_contains\n \n//å°†Join Keysåˆ†ä¸ºä¸¤ç»„ï¼Œå­˜åœ¨å€¾æ–œçš„ã€å’Œåˆ†å¸ƒå‡åŒ€çš„\nval skewOrderIds: Array[Int] = _\nval evenOrderIds: Array[Int] = _\n \nval skewTx: DataFrame = transactions.filter(array_contains(lit(skewOrderIds),$&quot;orderId&quot;))\nval evenTx: DataFrame = transactions.filter(array_contains(lit(evenOrderIds),$&quot;orderId&quot;))\n \nval skewOrders: DataFrame = orders.filter(array_contains(lit(skewOrderIds),$&quot;orderId&quot;))\nval evenOrders: DataFrame = orders.filter(array_contains(lit(evenOrderIds),$&quot;orderId&quot;))\n</code></pre><p>æ‹†åˆ†å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å»¶ç»­â€œåˆ†è€Œæ²»ä¹‹â€çš„æ€æƒ³ï¼Œåˆ†åˆ«å¯¹è¿™ä¸¤éƒ¨åˆ†åº”ç”¨ä¸åŒçš„è°ƒä¼˜æŠ€å·§ã€‚å¯¹äºåˆ†å¸ƒå‡åŒ€çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æŠŠShuffle Sort Merge Joinè½¬åŒ–ä¸ºShuffle Hash Joinã€‚</p><pre><code>//å°†åˆ†å¸ƒå‡åŒ€çš„æ•°æ®åˆ†åˆ«æ³¨å†Œä¸ºä¸´æ—¶è¡¨\nevenTx.createOrReplaceTempView(â€œevenTxâ€)\nevenOrders.createOrReplaceTempView(â€œevenOrdersâ€)\n \nval evenQuery: String = â€œ\nselect /*+ shuffle_hash(orders) */ sum(tx.price * tx.quantity) as revenue, o.orderId\nfrom evenTx as tx inner join evenOrders as o\non tx.orderId = o.orderId\nwhere o.status = â€˜COMPLETEâ€™\nand o.date between â€˜2020-01-01â€™ and â€˜2020-03-31â€™\ngroup by o.orderId\nâ€\nval evenResults: DataFrame = spark.sql(evenQuery)\n</code></pre><p>å¯¹äºå­˜åœ¨å€¾æ–œçš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¦ç¥­å‡ºâ€œä¸¤é˜¶æ®µShuffleâ€çš„æ€æ‰‹é”ã€‚é¦–å…ˆï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ç»™ä¸¤å¼ è¡¨åˆ†åˆ«åŠ ç›ï¼Œå¯¹å¤–è¡¨ï¼ˆäº¤æ˜“è¡¨ï¼‰åšâ€œéšæœºåŠ ç›â€ï¼Œå¯¹å†…è¡¨ï¼ˆè®¢å•è¡¨ï¼‰åšâ€œå¤åˆ¶åŠ ç›â€ã€‚</p><pre><code>import org.apache.spark.sql.functions.udf\n \n//å®šä¹‰è·å–éšæœºç›ç²’çš„UDF\nval numExecutors: Int = _\nval rand = () =&gt; scala.util.Random.nextInt(numExecutors)\nval randUdf = udf(rand)\n \n//ç¬¬ä¸€é˜¶æ®µçš„åŠ ç›æ“ä½œã€‚æ³¨æ„ï¼šä¿ç•™orderIdå­—æ®µï¼Œç”¨äºåæœŸç¬¬äºŒé˜¶æ®µçš„å»ç›åŒ–\n \n//å¤–è¡¨éšæœºåŠ ç›\nval saltedSkewTx = skewTx.withColumn(â€œjoinKeyâ€, concat($â€œorderIdâ€, lit(â€œ_â€), randUdf()))\n \n//å†…è¡¨å¤åˆ¶åŠ ç›\nvar saltedskewOrders = skewOrders.withColumn(â€œjoinKeyâ€, concat($â€œorderIdâ€, lit(â€œ_â€), lit(1)))\nfor (i &lt;- 2 to numExecutors) {\nsaltedskewOrders = saltedskewOrders union skewOrders.withColumn(â€œjoinKeyâ€, concat($â€œorderIdâ€, lit(â€œ_â€), lit(i)))\n}\n</code></pre><p>ä¸¤å¼ è¡¨åˆ†åˆ«åšå®ŒåŠ ç›å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¸ä¹‹å‰ç±»ä¼¼çš„æŸ¥è¯¢è¯­å¥ï¼Œå¯¹å®ƒä»¬æ‰§è¡Œåç»­çš„Shuffleã€å…³è”ä¸èšåˆç­‰æ“ä½œã€‚</p><pre><code>//å°†åŠ ç›åçš„æ•°æ®åˆ†åˆ«æ³¨å†Œä¸ºä¸´æ—¶è¡¨\nsaltedSkewTx.createOrReplaceTempView(â€œsaltedSkewTxâ€)\nsaltedskewOrders.createOrReplaceTempView(â€œsaltedskewOrdersâ€)\n \nval skewQuery: String = â€œ\nselect /*+ shuffle_hash(orders) */ sum(tx.price * tx.quantity) as initialRevenue, o.orderId, o.joinKey\nfrom saltedSkewTx as tx inner join saltedskewOrders as o\non tx.joinKey = o.joinKey\nwhere o.status = â€˜COMPLETEâ€™\nand o.date between â€˜2020-01-01â€™ and â€˜2020-03-31â€™\ngroup by o.joinKey\nâ€\n//ç¬¬ä¸€é˜¶æ®µåŠ ç›ã€Shuffleã€å…³è”ã€èšåˆåçš„åˆæ­¥ç»“æœ\nval skewInitialResults: DataFrame = spark.sql(skewQuery)\n</code></pre><p>å¾—åˆ°ç¬¬ä¸€é˜¶æ®µçš„åˆæ­¥ç»“æœä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ‰§è¡Œç¬¬äºŒé˜¶æ®µçš„è®¡ç®—äº†ï¼Œä¹Ÿå°±æ˜¯â€œå»ç›åŒ–ã€Shuffleä¸èšåˆâ€è¿™ä¸‰ä¸ªæ“ä½œã€‚å»ç›åŒ–çš„ç›®çš„å®é™…ä¸Šå°±æ˜¯æŠŠè®¡ç®—çš„ç²’åº¦ï¼Œä»åŠ ç›çš„joinKeyæ¢å¤ä¸ºåŸæ¥çš„orderIdã€‚ç”±äºåœ¨æœ€åˆåŠ ç›çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯¹orderIdå­—æ®µè¿›è¡Œäº†ä¿ç•™ï¼Œå› æ­¤åœ¨ç¬¬äºŒé˜¶æ®µçš„è®¡ç®—ä¸­ï¼Œæˆ‘ä»¬åªè¦åœ¨orderIdå­—æ®µä¹‹ä¸Šæ‰§è¡Œèšåˆæ“ä½œï¼Œå°±èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„â€œå»ç›åŒ–â€æ•ˆæœã€‚</p><pre><code>val skewResults: DataFrame = skewInitialResults.select(â€œinitialRevenueâ€, â€œorderIdâ€)\n.groupBy(col(â€œorderIdâ€)).agg(sum(col(â€œinitialRevenueâ€)).alias(â€œrevenueâ€))\n</code></pre><p>åœ¨å®Œæˆäº†ç¬¬äºŒé˜¶æ®µçš„è®¡ç®—ä¹‹åï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†â€œä¸¤é˜¶æ®µShuffleâ€çš„è®¡ç®—ç»“æœã€‚æœ€ç»ˆï¼Œåªéœ€è¦æŠŠè¿™ä»½ç»“æœä¸å…ˆå‰å‡åŒ€éƒ¨åˆ†çš„å…³è”ç»“æœè¿›è¡Œåˆå¹¶ï¼Œæˆ‘ä»¬å°±èƒ½å®ç°ä»¥Executorsä¸ºç²’åº¦å¹³è¡¡è®¡ç®—è´Ÿè½½çš„ä¼˜åŒ–è¿‡ç¨‹ã€‚</p><pre><code>evenResults union skewResults\n</code></pre><h4>æ‰§è¡Œæ€§èƒ½ä¸å¼€å‘æˆæœ¬çš„åšå¼ˆ</h4><p>ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œæˆ‘çš„å¤©å‘ï¼ä¸ºäº†ä¼˜åŒ–è¿™ä¸ªåœºæ™¯çš„è®¡ç®—ï¼Œè¿™å¾—èŠ±å¤šå¤§çš„å¼€å‘æˆæœ¬å•Šï¼åˆæ˜¯åˆ†è€Œæ²»ä¹‹ï¼Œåˆæ˜¯ä¸¤é˜¶æ®µShuffleçš„ï¼Œè¿™ä¹ˆå¤§çš„å¼€å‘æŠ•å…¥çœŸçš„å€¼å¾—å—ï¼Ÿâ€</p><p>è¿™ä¸ªé—®é¢˜éå¸¸å¥½ã€‚æˆ‘ä»¬è¦æ˜ç¡®çš„æ˜¯ï¼Œåˆ†è€Œæ²»ä¹‹å¤–åŠ ä¸¤é˜¶æ®µShuffleçš„è°ƒä¼˜æŠ€å·§çš„åˆè¡·ï¼Œæ˜¯ä¸ºäº†è§£å†³AQEæ— æ³•ä»¥Executorsä¸ºç²’åº¦å¹³è¡¡è®¡ç®—è´Ÿè½½çš„é—®é¢˜ã€‚å› æ­¤ï¼Œè¿™é¡¹æŠ€å·§å–èˆçš„å…³é”®å°±åœ¨äºï¼ŒExecutorsä¹‹é—´çš„è´Ÿè½½å€¾æ–œæ˜¯å¦æ„æˆæ•´ä¸ªå…³è”è®¡ç®—çš„æ€§èƒ½ç“¶é¢ˆã€‚å¦‚æœè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæˆ‘ä»¬çš„æŠ•å…¥å°±æ˜¯å€¼å¾—çš„ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œä½ éœ€è¦æŒæ¡ä»¥Shuffle Joinçš„æ–¹å¼å»åº”å¯¹â€œå¤§è¡¨Joinå¤§è¡¨â€çš„è®¡ç®—åœºæ™¯ã€‚æ•°æ®åˆ†å¸ƒä¸åŒï¼Œåº”å¯¹æ–¹æ³•ä¹Ÿä¸å°½ç›¸åŒã€‚</p><p>å½“å‚ä¸Joinçš„ä¸¤å¼ è¡¨æ•°æ®åˆ†å¸ƒæ¯”è¾ƒå‡åŒ€ï¼Œè€Œä¸”å†…è¡¨çš„æ•°æ®åˆ†ç‰‡èƒ½å¤Ÿå®Œå…¨æ”¾å…¥å†…å­˜ï¼ŒShuffle Hash Joinçš„è®¡ç®—æ•ˆç‡å¾€å¾€é«˜äºShuffle Sort Merge Joinï¼Œåè€…æ˜¯Spark SQLé»˜è®¤çš„å…³è”æœºåˆ¶ã€‚ä½ å¯ä»¥ä½¿ç”¨å…³é”®å­—â€œshuffle_hashâ€çš„Join Hintsï¼Œå¼ºåˆ¶Spark SQLåœ¨è¿è¡Œæ—¶é€‰æ‹©Shuffle Hash Joinå®ç°æœºåˆ¶ã€‚å¯¹äºå†…è¡¨æ•°æ®åˆ†ç‰‡ä¸èƒ½æ”¾å…¥å†…å­˜çš„æƒ…å†µï¼Œä½ å¯ä»¥ç»“åˆâ€œä¸‰è¶³é¼ç«‹â€çš„è°ƒä¼˜æŠ€å·§ï¼Œè°ƒæ•´å¹¶è¡Œåº¦ã€å¹¶å‘åº¦ä¸æ‰§è¡Œå†…å­˜è¿™ä¸‰ç±»å‚æ•°ï¼Œæ¥æ»¡è¶³è¿™ä¸€å‰ææ¡ä»¶ã€‚</p><p>å½“å‚ä¸Joinçš„ä¸¤å¼ è¡¨å­˜åœ¨æ•°æ®å€¾æ–œæ—¶ï¼Œå¦‚æœå€¾æ–œçš„æƒ…å†µåœ¨é›†ç¾¤å†…çš„Executorsä¹‹é—´è¾ƒä¸ºå‡è¡¡ï¼Œé‚£ä¹ˆæœ€ä½³çš„å¤„ç†æ–¹æ³•å°±æ˜¯ï¼Œåˆ©ç”¨AQEæä¾›çš„è‡ªåŠ¨å€¾æ–œå¤„ç†æœºåˆ¶ã€‚ä½ åªéœ€è¦è®¾ç½®å¥½ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„äº‹æƒ…äº¤ç»™AQEå°±å¥½äº†ã€‚</p><ul>\n<li>spark.sql.adaptive.skewJoin.skewedPartitionFactorï¼Œåˆ¤å®šå€¾æ–œçš„è†¨èƒ€ç³»æ•°ã€‚</li>\n<li>spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytesï¼Œåˆ¤å®šå€¾æ–œçš„æœ€ä½é˜ˆå€¼ã€‚</li>\n<li>spark.sql.adaptive.advisoryPartitionSizeInBytesï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œå®šä¹‰æ‹†åˆ†ç²’åº¦ã€‚</li>\n</ul><p>ä½†æ˜¯ï¼Œå¦‚æœå€¾æ–œé—®é¢˜ä»…é›†ä¸­åœ¨å°‘æ•°çš„å‡ ä¸ªExecutorsä¸­ï¼Œè€Œä¸”è¿™äº›è´Ÿè½½è¿‡é«˜çš„Executorså·²ç„¶æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œæˆ‘ä»¬å°±éœ€è¦é‡‡ç”¨â€œåˆ†è€Œæ²»ä¹‹â€å¤–åŠ â€œä¸¤é˜¶æ®µShuffleâ€çš„è°ƒä¼˜æŠ€å·§å»åº”å¯¹ã€‚â€œåˆ†è€Œæ²»ä¹‹â€æŒ‡çš„æ˜¯æ ¹æ®Join Keysçš„å€¾æ–œä¸å¦ï¼Œå°†å†…å¤–è¡¨çš„æ•°æ®åˆ†ä¸ºä¸¤éƒ¨åˆ†åˆ†åˆ«å¤„ç†ã€‚å…¶ä¸­ï¼Œå‡åŒ€çš„éƒ¨åˆ†å¯ä»¥ä½¿ç”¨Shuffle Hash Joinæ¥å®Œæˆè®¡ç®—ï¼Œå€¾æ–œçš„éƒ¨åˆ†éœ€è¦ç”¨â€œä¸¤é˜¶æ®µShuffleâ€è¿›è¡Œå¤„ç†ã€‚</p><p>ä¸¤é˜¶æ®µShuffleçš„å…³é”®åœ¨äºåŠ ç›å’Œå»ç›åŒ–ã€‚åŠ ç›çš„ç›®çš„æ˜¯æ‰“æ•£æ•°æ®åˆ†å¸ƒã€å¹³è¡¡Executorsä¹‹é—´çš„è®¡ç®—è´Ÿè½½ï¼Œä»è€Œæ¶ˆé™¤Executorså•ç‚¹ç“¶é¢ˆã€‚å»ç›åŒ–çš„ç›®çš„æ˜¯è¿˜åŸåŸå§‹çš„å…³è”é€»è¾‘ã€‚å°½ç®¡ä¸¤é˜¶æ®µShuffleçš„å¼€å‘æˆæœ¬è¾ƒé«˜ï¼Œä½†åªè¦è·å¾—çš„æ€§èƒ½æ”¶ç›Šè¶³å¤Ÿæ˜¾è‘—ï¼Œæˆ‘ä»¬çš„æŠ•å…¥å°±æ˜¯å€¼å¾—çš„ã€‚</p><h2>æ¯æ—¥ä¸€ç»ƒ</h2><ol>\n<li>å½“å°è¯•å°†Join Keysæ˜¯å¦å€¾æ–œä½œä¸ºâ€œåˆ†è€Œæ²»ä¹‹â€çš„åˆ’åˆ†ä¾æ®æ—¶ï¼Œä½ è§‰å¾—æˆ‘ä»¬è¯¥ä¾æ®ä»€ä¹ˆæ ‡å‡†æŠŠJoin Keysåˆ’åˆ†ä¸ºå€¾æ–œç»„å’Œéå€¾æ–œç»„å‘¢ï¼Ÿ</li>\n<li>æ— è®ºæ˜¯AQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†ï¼Œè¿˜æ˜¯å¼€å‘è€…çš„â€œä¸¤é˜¶æ®µShuffleâ€ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡â€œåŠ ç›â€ä¸â€œå»ç›åŒ–â€çš„ä¸¤æ­¥èµ°ï¼Œåœ¨ç»´æŒå…³è”å…³ç³»çš„åŒæ—¶å¹³è¡¡ä¸åŒç²’åº¦ä¸‹çš„è®¡ç®—è´Ÿè½½ã€‚é‚£ä¹ˆï¼Œè¿™ç§â€œåŠ ç›â€ä¸â€œå»ç›åŒ–â€çš„ä¼˜åŒ–æŠ€å·§ï¼Œæ˜¯å¦é€‚ç”¨äºæ‰€æœ‰çš„å…³è”åœºæ™¯ï¼Ÿå¦‚æœä¸æ˜¯ï¼Œéƒ½æœ‰å“ªäº›åœºæ™¯æ²¡åŠæ³•åˆ©ç”¨AQEçš„è‡ªåŠ¨å€¾æ–œå¤„ç†ï¼Œæˆ–æ˜¯æˆ‘ä»¬çš„â€œä¸¤é˜¶æ®µShuffleâ€å‘¢ï¼Ÿ</li>\n</ol><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","neighbors":{"left":{"article_title":"28 | å¤§è¡¨Joinå¤§è¡¨ï¼ˆä¸€ï¼‰ï¼šä»€ä¹ˆæ˜¯â€œåˆ†è€Œæ²»ä¹‹â€çš„è°ƒä¼˜æ€è·¯ï¼Ÿ","id":374729},"right":{"article_title":"30ï½œåº”ç”¨å¼€å‘ï¼šåŒ—äº¬å¸‚å°å®¢è½¦ï¼ˆæ±½æ²¹è½¦ï¼‰æ‘‡å·è¶‹åŠ¿åˆ†æ","id":374776}},"comments":[{"had_liked":false,"id":294517,"user_name":"å¯¹æ–¹æ­£åœ¨è¾“å…¥ã€‚ã€‚ã€‚","can_delete":false,"product_type":"c1","uid":1179298,"ip_address":"","ucode":"7B0DEB4D9B43D2","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/a2/5252a278.jpg","comment_is_top":false,"comment_ctime":1621989793,"is_pvip":false,"replies":[{"id":"106959","content":"ç¬¬ä¸€é¢˜æ»¡åˆ†ğŸ’¯~<br><br>ç¬¬äºŒé¢˜è¯´çš„éå¸¸å¥½ï¼æ€è€ƒçš„ç›¸å½“åˆ°ä½~ ä½ è¯´çš„æ²¡é”™ï¼Œå’±ä»¬æ–‡ä¸­çš„ä¾‹å­ï¼Œç‰¹æ®Šçš„åœ°æ–¹åœ¨äºï¼Œæ¶‰åŠaggregateçš„å­—æ®µï¼Œéƒ½æ˜¯æ¥è‡ªTransactionsè¡¨ï¼Œä¹Ÿå°±æ˜¯sum(tx.price * tx.quantity)ï¼Œå› æ­¤ç¡®å®å¯ä»¥æŒ‰ç…§ä½ è¯´çš„åŠæ³•ï¼Œå…ˆåšMapç«¯èšåˆï¼Œç„¶åå†å’ŒOrdersè¡¨åšå…³è”ã€‚<br><br>ä¸è¿‡ï¼Œå…¶å®â€œä¸¤é˜¶æ®µShuffleâ€çš„è°ƒä¼˜æ€è·¯ï¼Œæ›´å¤šåœ°æ˜¯ç»™å¤§å®¶æä¾›ä¸€ç§é¢å¯¹æç«¯åœºæ™¯çš„è§£å†³åŠæ³•ã€‚<br><br>å®é™…ä¸Šï¼Œåœ¨å¤§å¤šæ•°çš„Joinåœºæ™¯ä¸­ï¼ŒæŸ¥è¯¢æ¶‰åŠçš„aggregateå¾€å¾€æ¥è‡ªä¸¤å¼ è¡¨çš„å­—æ®µï¼Œæ¯”å¦‚æŠŠæˆ‘ä»¬çš„ä¾‹å­ç¨å¾®è°ƒæ•´ä¸€ä¸‹ï¼Œèšåˆè®¡ç®—æ”¹æˆï¼šsum(tx.price * o.batches)ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±æ²¡åŠæ³•å†å……åˆ†åˆ©ç”¨Mapç«¯èšåˆäº†ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å¿…é¡»è¦å…ˆå®Œæˆä¸¤å¼ è¡¨çš„Shuffleï¼Œç„¶ååœ¨Reduceç«¯å®Œæˆèšåˆè®¡ç®—ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1622043001,"ip_address":"","comment_id":294517,"utype":1}],"discussion_count":3,"race_medal":0,"score":"18801858977","product_id":100073401,"comment_content":"ç¬¬ä¸€é¢˜ï¼šå¯ä»¥å…ˆç»Ÿè®¡æ¯ä¸ªkeyçš„æ¡ç›®æ•°ï¼Œç„¶åæ ¹æ®æ¡ç›®æ•°ä»å°åˆ°å¤§æ’åºï¼Œåå–å…¶åºåˆ—ä¹‹ä¸­ä½æ•°ï¼Œç„¶åæ‰¾å‡ºæ¯”ä¸­ä½æ•°å¤§nå€ï¼ŒåŒæ—¶æ¡ç›®æ•°å¤§äºä¸€å®šé˜ˆå€¼çš„key<br><br>ç¬¬äºŒé¢˜ï¼šè€å¸ˆï¼Œæˆ‘è§‰å¾—åŠ ç›çš„æ“ä½œå¥½åƒæ ¹æœ¬æ²¡å•¥ç”¨ï¼ŒåŠ ç›çš„åœºæ™¯é€‚åˆèšåˆæ“ä½œï¼Œä½†æ˜¯å§ï¼Œä¸€æ—¦æœ‰äº†aggregatorï¼ŒsortShuffuleçš„æ—¶å€™å·²ç»åœ¨mapç«¯æå‰èšåˆäº†ï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿå€¾æ–œäº†ã€‚æ¯”å¦‚ï¼Œæœ¬æ–‡çš„ä¾‹å­ï¼Œè§£å†³è¿™ä¸ªå€¾æ–œçš„é—®é¢˜ï¼Œæˆ‘ç†è§£æ˜¯ä¸æ˜¯å¯ä»¥äº‹å…ˆå¯¹äº¤æ˜“è¡¨ä½œgroupç„¶åæ±‚å…¶sumå€¼ç­‰ï¼Œè¿™ä¸ªé˜¶æ®µå› ä¸ºä¼šåœ¨mapé˜¶æ®µäº‹å…ˆèšåˆï¼Œæ‰€ä»¥å¹¶ä¸ä¼šå€¾æ–œï¼Œç„¶åå†å°†èšåˆçš„ç»“æœå’Œordersåšjoin","like_count":5,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520690,"discussion_content":"ç¬¬ä¸€é¢˜æ»¡åˆ†ğŸ’¯~\n\nç¬¬äºŒé¢˜è¯´çš„éå¸¸å¥½ï¼æ€è€ƒçš„ç›¸å½“åˆ°ä½~ ä½ è¯´çš„æ²¡é”™ï¼Œå’±ä»¬æ–‡ä¸­çš„ä¾‹å­ï¼Œç‰¹æ®Šçš„åœ°æ–¹åœ¨äºï¼Œæ¶‰åŠaggregateçš„å­—æ®µï¼Œéƒ½æ˜¯æ¥è‡ªTransactionsè¡¨ï¼Œä¹Ÿå°±æ˜¯sum(tx.price * tx.quantity)ï¼Œå› æ­¤ç¡®å®å¯ä»¥æŒ‰ç…§ä½ è¯´çš„åŠæ³•ï¼Œå…ˆåšMapç«¯èšåˆï¼Œç„¶åå†å’ŒOrdersè¡¨åšå…³è”ã€‚\n\nä¸è¿‡ï¼Œå…¶å®â€œä¸¤é˜¶æ®µShuffleâ€çš„è°ƒä¼˜æ€è·¯ï¼Œæ›´å¤šåœ°æ˜¯ç»™å¤§å®¶æä¾›ä¸€ç§é¢å¯¹æç«¯åœºæ™¯çš„è§£å†³åŠæ³•ã€‚\n\nå®é™…ä¸Šï¼Œåœ¨å¤§å¤šæ•°çš„Joinåœºæ™¯ä¸­ï¼ŒæŸ¥è¯¢æ¶‰åŠçš„aggregateå¾€å¾€æ¥è‡ªä¸¤å¼ è¡¨çš„å­—æ®µï¼Œæ¯”å¦‚æŠŠæˆ‘ä»¬çš„ä¾‹å­ç¨å¾®è°ƒæ•´ä¸€ä¸‹ï¼Œèšåˆè®¡ç®—æ”¹æˆï¼šsum(tx.price * o.batches)ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±æ²¡åŠæ³•å†å……åˆ†åˆ©ç”¨Mapç«¯èšåˆäº†ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å¿…é¡»è¦å…ˆå®Œæˆä¸¤å¼ è¡¨çš„Shuffleï¼Œç„¶ååœ¨Reduceç«¯å®Œæˆèšåˆè®¡ç®—ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622043001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1179298,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fe/a2/5252a278.jpg","nickname":"å¯¹æ–¹æ­£åœ¨è¾“å…¥ã€‚ã€‚ã€‚","note":"","ucode":"7B0DEB4D9B43D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376277,"discussion_content":"å—¯ï¼Œè€å¸ˆæ‰€è¨€ç”šæ˜¯ã€‚å“ï¼Œè€å¸ˆï¼Œèˆä¸å¾—ï¼Œå°±è¿™æ ·ç»“æŸäº†ã€‚æˆ‘ä¼šåœ¨åœŸè±†é¡¹ç›®ä¸Šé¢æŒç»­å‘è€å¸ˆå­¦ä¹ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622043991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1179298,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fe/a2/5252a278.jpg","nickname":"å¯¹æ–¹æ­£åœ¨è¾“å…¥ã€‚ã€‚ã€‚","note":"","ucode":"7B0DEB4D9B43D2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378827,"discussion_content":"äº’ç›¸å­¦ä¹ ï¼ŒåŠ æ²¹è€å¼Ÿ~ çœŸå¿ƒæ„Ÿè°¢è€å¼Ÿçš„é™ªä¼´å’Œè®¤å¯ï¼Œå’±ä»¬é’å±±ä¸æ”¹ã€ç»¿æ°´é•¿æµï¼Œæ¥æ—¥æ–¹é•¿ï¼Œåä¼šå¿…å®šæœ‰æœŸ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623421580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":376277,"ip_address":""},"score":378827,"extra":""}]}]},{"had_liked":false,"id":305516,"user_name":"ulysses","can_delete":false,"product_type":"c1","uid":1527771,"ip_address":"","ucode":"EB617C1E586CA7","user_header":"https://static001.geekbang.org/account/avatar/00/17/4f/db/3d589d18.jpg","comment_is_top":false,"comment_ctime":1628006107,"is_pvip":false,"replies":[{"id":"110611","content":"è¿™å—æ˜¯è¿™æ ·çš„ï¼ŒskewOrderIdså’ŒevenOrderIdsè¿™ä¸¤ä¸ªåˆ—è¡¨æ˜¯ç”¨æ¥è®°å½•æœ‰å€¾æ–œå’Œæ²¡æœ‰å€¾æ–œçš„OrderIdsï¼›åé¢é‚£ä¸¤å¥å°±æ˜¯DataFrameçš„è¯­æ³•ï¼Œè¿™é‡Œé¢ç”¨äº†filterç®—å­ï¼Œç”¨æ¥å¯¹transactionsåšè¿‡æ»¤ï¼Œå…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒå®˜æ–¹APIå“ˆã€‚<br><br>å…¶å®è¿™é‡Œé¢å…³é”®çš„æ˜¯å‰é¢é‚£ä¸¤å¥ï¼Œå°±æ˜¯æ€ä¹ˆè·å¾—å€¾æ–œåˆ—è¡¨å’Œéå€¾æ–œåˆ—è¡¨ï¼Œè¿™å—å¯ä»¥äº‹å…ˆé€šè¿‡åˆ†ç»„è®¡æ•°æ¥è·å¾—ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1628146241,"ip_address":"","comment_id":305516,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14512907995","product_id":100073401,"comment_content":"è€å¸ˆæƒ³é—®ä¸‹é¢ä¸€æ®µä»£ç ï¼Œæ€ä¹ˆèƒ½å¤Ÿç­›é€‰å»å“ªäº›æ˜¯skewçš„æ•°æ®ï¼Œå“ªäº›æ˜¯evençš„ æ•°æ®ï¼Œå¯¹scalaè¯­æ³•ä¸å¤ªç†Ÿæ‚‰ã€‚<br>val skewOrderIds: Array[Int] = _<br>val evenOrderIds: Array[Int] = _ <br>val skewTx: DataFrame = transactions.filter(array_contains(lit(skewOrderIds),$&quot;orderId&quot;))<br>val evenTx: DataFrame = transactions.filter(array_contains(lit(evenOrderIds),$&quot;orderId&quot;))","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524412,"discussion_content":"è¿™å—æ˜¯è¿™æ ·çš„ï¼ŒskewOrderIdså’ŒevenOrderIdsè¿™ä¸¤ä¸ªåˆ—è¡¨æ˜¯ç”¨æ¥è®°å½•æœ‰å€¾æ–œå’Œæ²¡æœ‰å€¾æ–œçš„OrderIdsï¼›åé¢é‚£ä¸¤å¥å°±æ˜¯DataFrameçš„è¯­æ³•ï¼Œè¿™é‡Œé¢ç”¨äº†filterç®—å­ï¼Œç”¨æ¥å¯¹transactionsåšè¿‡æ»¤ï¼Œå…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒå®˜æ–¹APIå“ˆã€‚\n\nå…¶å®è¿™é‡Œé¢å…³é”®çš„æ˜¯å‰é¢é‚£ä¸¤å¥ï¼Œå°±æ˜¯æ€ä¹ˆè·å¾—å€¾æ–œåˆ—è¡¨å’Œéå€¾æ–œåˆ—è¡¨ï¼Œè¿™å—å¯ä»¥äº‹å…ˆé€šè¿‡åˆ†ç»„è®¡æ•°æ¥è·å¾—ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628146241,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1527771,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4f/db/3d589d18.jpg","nickname":"ulysses","note":"","ucode":"EB617C1E586CA7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389398,"discussion_content":"åŸæ¥skew å’Œevenä¸¤ä¸ªæ•°ç»„çš„æ•°æ®æ˜¯ä»¥å‰è®¡ç®—å¾—åˆ°çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629262210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":294030,"user_name":"aof","can_delete":false,"product_type":"c1","uid":1062864,"ip_address":"","ucode":"5815D63C4926BC","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","comment_is_top":false,"comment_ctime":1621689717,"is_pvip":false,"replies":[{"id":"106655","content":"ç¬¬ä¸€é¢˜çš„æ€è·¯éå¸¸èµï¼Œå’Œä¼ ç»Ÿçš„å…ˆç”¨åˆ†ç»„è®¡æ•°è¿™ç§â€œå…ˆéªŒâ€çš„æ–¹æ³•ä¸åŒï¼Œä½ çš„æ€è·¯æ˜¯ä¸€ç§æ›´ç›´æ¥ã€æ›´å•åˆ€ç›´å…¥çš„â€œåéªŒâ€æ–¹æ³•ã€‚ä¸è¿‡ï¼Œæˆ‘å¾ˆå¥½å¥‡ï¼Œè¿™ä¸ªå…·ä½“æ€ä¹ˆè®¡ç®—ï¼Ÿæˆ‘ä»¬ç¡®å®å¯ä»¥é€šè¿‡Spark UIæ¥åˆ¤æ–­å“ªäº›Tasksæ˜¯å‡åŒ€çš„ã€å“ªäº›æ˜¯å€¾æ–œçš„ï¼Œä½†æ˜¯æ€ä¹ˆçŸ¥é“ä¸åŒçš„Taskså†…éƒ¨ï¼Œå¤„ç†çš„éƒ½æ˜¯å“ªäº›Join Keyså‘¢ï¼ŸæœŸå¾…ä½ çš„ç­”å¤~<br><br>ç¬¬äºŒé¢˜æ²¡é—®é¢˜ï¼ŒåŠ ç›ä¹‹åä¸ä¿åºï¼Œæ‰€ä»¥å‡¡æ˜¯ä»¥æ’åºä¸ºå‰æçš„èšåˆç±»æ“ä½œï¼Œå°±éƒ½ä¸èƒ½ç›´æ¥å»ç”¨â€œä¸¤é˜¶æ®µShuffleâ€ï¼Œæ¯”å¦‚åƒä½ è¿™ä¸ªä¾‹å­ï¼Œè¿˜éœ€è¦åœ¨å»ç›åŒ–çš„è¿‡ç¨‹ä¸­åšå½’å¹¶æ’åº~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621725515,"ip_address":"","comment_id":294030,"utype":1}],"discussion_count":5,"race_medal":0,"score":"5916657013","product_id":100073401,"comment_content":"ç¬¬ä¸€é¢˜ï¼šä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨ä»£ç ä¸€å‡ºç°Joinçš„åœ°æ–¹å°±è¿›è¡ŒKeyæ•°é‡çš„ç»Ÿè®¡ï¼Œä¸€èˆ¬æ˜¯æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œç»“åˆSpark WebUIä¸ŠæŸ¥çœ‹æŸä¸ªStageä¸­çš„Tasksçš„è€—æ—¶æ’è¡Œï¼Œæ¯”å¦‚æŸä¸ªTaskæˆ–æŸäº›Taskçš„è€—æ—¶æ˜¯å…¶ä»–Taskè€—æ—¶çš„ä¸¤å€ä»¥ä¸Šï¼Œé‚£æˆ‘ä»¬å°±çŸ¥é“å‡ºç°äº†æ•°æ®å€¾æ–œï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ ¹æ®stageå¯¹åº”çš„ä»£ç ä½ç½®æ¥æ’æŸ¥æ˜¯å“ªäº›keyå‡ºç°äº†å€¾æ–œ<br>ç¬¬äºŒé¢˜ï¼šå¦‚æœæ˜¯å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„æ’åºè¿™ç§æƒ…å†µï¼ŒæŸä¸ªKeyå¯¹åº”ç»„çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œå¦‚æœè¿›è¡ŒåŠ ç›çš„è¯ï¼Œæ˜¯æ— æ³•ä¿è¯æ•´ä¸ªç»„å†…çš„æ•°æ®æ˜¯æœ‰åºçš„ã€‚åŠ ç›ä¹‹åä¸€ç»„åˆ†ä¸ºNç»„ï¼Œæ¯ä¸ªç»„æ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯æœ€åå»ç›åˆå¹¶çš„æ—¶å€™ï¼Œéœ€è¦è¿›è¡Œå½’å¹¶æ’åºã€‚","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520473,"discussion_content":"ç¬¬ä¸€é¢˜çš„æ€è·¯éå¸¸èµï¼Œå’Œä¼ ç»Ÿçš„å…ˆç”¨åˆ†ç»„è®¡æ•°è¿™ç§â€œå…ˆéªŒâ€çš„æ–¹æ³•ä¸åŒï¼Œä½ çš„æ€è·¯æ˜¯ä¸€ç§æ›´ç›´æ¥ã€æ›´å•åˆ€ç›´å…¥çš„â€œåéªŒâ€æ–¹æ³•ã€‚ä¸è¿‡ï¼Œæˆ‘å¾ˆå¥½å¥‡ï¼Œè¿™ä¸ªå…·ä½“æ€ä¹ˆè®¡ç®—ï¼Ÿæˆ‘ä»¬ç¡®å®å¯ä»¥é€šè¿‡Spark UIæ¥åˆ¤æ–­å“ªäº›Tasksæ˜¯å‡åŒ€çš„ã€å“ªäº›æ˜¯å€¾æ–œçš„ï¼Œä½†æ˜¯æ€ä¹ˆçŸ¥é“ä¸åŒçš„Taskså†…éƒ¨ï¼Œå¤„ç†çš„éƒ½æ˜¯å“ªäº›Join Keyså‘¢ï¼ŸæœŸå¾…ä½ çš„ç­”å¤~\n\nç¬¬äºŒé¢˜æ²¡é—®é¢˜ï¼ŒåŠ ç›ä¹‹åä¸ä¿åºï¼Œæ‰€ä»¥å‡¡æ˜¯ä»¥æ’åºä¸ºå‰æçš„èšåˆç±»æ“ä½œï¼Œå°±éƒ½ä¸èƒ½ç›´æ¥å»ç”¨â€œä¸¤é˜¶æ®µShuffleâ€ï¼Œæ¯”å¦‚åƒä½ è¿™ä¸ªä¾‹å­ï¼Œè¿˜éœ€è¦åœ¨å»ç›åŒ–çš„è¿‡ç¨‹ä¸­åšå½’å¹¶æ’åº~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621725515,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","nickname":"aof","note":"","ucode":"5815D63C4926BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375550,"discussion_content":"è€å¸ˆï¼Œä¸å¥½æ„æ€ï¼Œæˆ‘æ„æ€æ˜¯ï¼Œé€šè¿‡Spark Web UIæ‰¾åˆ°æ˜¯å“ªä¸ªStageä¸­çš„taskå‡ºç°äº†æ•°æ®å€¾æ–œï¼Œç„¶åæ‰¾åˆ°è¿™ä¸ªstageå¯¹åº”çš„ä»£ç æ®µï¼ˆJoinæˆ–è€…Groupbyç­‰ï¼‰ï¼Œä¹‹åçš„è§£å†³æ–¹æ³•å…¶å®è¿˜æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ï¼šåœ¨å‡ºç°å€¾æ–œçš„ä»£ç ä½ç½®ï¼Œæ¯”å¦‚æ˜¯Joinçš„è¯ï¼Œå°±å¯¹å…³è”çš„ä¸¤ä¸ªè¡¨åˆ†åˆ«è¿›è¡Œkeyçš„æ•°é‡ç»Ÿè®¡ï¼Œæœ€ç»ˆæ‰¾å‡ºå€¾æ–œçš„keyã€‚\n\nå…¶å®æˆ‘æƒ³è¡¨è¾¾çš„æ˜¯ï¼Œåœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåº”ç”¨ä¸­ä¼šæœ‰å¾ˆå¤šçš„joinå…³è”ï¼Œè€Œæ•°æ®å€¾æ–œçš„æƒ…å†µä¸€èˆ¬å¯èƒ½åªå‡ºç°åœ¨å°‘æ•°çš„å‡ ä¸ªjoinå…³è”ä¸­ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ‰€æœ‰å‡ºç°Joinçš„åœ°æ–¹éƒ½æ¥ç»Ÿè®¡Join Keyçš„æ•°é‡ï¼Œæ„Ÿè§‰æˆæœ¬å¾ˆå¤§ï¼Œç›¸åçš„ï¼Œè¿˜ä¸å¦‚åœ¨è¿è¡Œä»»åŠ¡çš„æ—¶å€™å†å»åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å‡ºç°äº†æ•°æ®å€¾æ–œï¼Œå› ä¸ºæˆ‘ä»¬çš„ä»»åŠ¡åœ¨ä¸Šçº¿ä¹‹å‰è‚¯å®šéƒ½æ˜¯è¦å…ˆè·‘é€šå…ˆæµ‹è¯•å˜›ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621740869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1062864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","nickname":"aof","note":"","ucode":"5815D63C4926BC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375929,"discussion_content":"å“¦å“¦æ˜ç™½äº†ï¼Œå°±æ˜¯ç”¨Spark UIæ¥å…ˆå®šä½å“ªé‡Œå‡ºç°äº†å€¾æ–œï¼Œå†å»ç»Ÿè®¡Keyçš„åˆ†å¸ƒã€‚æˆ‘è¿˜ä»¥ä¸ºå¯ä»¥é€šè¿‡Spark UIä¸Šé¢Taskçš„å€¾æ–œï¼Œå¯ä»¥ç”¨æŸç§æ–¹æ³•æ¥å€’æ¨Join Keyçš„åˆ†å¸ƒï¼Œé‚£æ ·å°±å‰å®³äº†ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621871308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375550,"ip_address":""},"score":375929,"extra":""}]},{"author":{"id":1051904,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PNmB3mOQ4jTSoDMGPwp5j8a2NL1Mibu4iaebBNnuDQltb2yZ3sygJpxTHuLrG9ewCDLEialorSK3pzXBCQ3JFCZPA/132","nickname":"æœå­","note":"","ucode":"0A669B6DE26F21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393120,"discussion_content":"hiveé‡Œé¢å¯ä»¥é€šè¿‡yarnç•Œé¢jbnameå®šä½å“ªä¸ªstageå‘ç”Ÿå€¾æ–œï¼Œç„¶åexplainå…·ä½“åˆ°æŸä¸ªstageä¸€èˆ¬éƒ½æ˜¯joinæˆ–group byå®šä½åˆ°è¿™æ®µä»£ç ï¼Œç„¶åå†å»yarnç•Œé¢è§‚å¯Ÿjobæ‰§è¡Œæƒ…å†µï¼Œæœ‰ä¸ªæ—¶é—´å¦‚æœæ¯”å…¶ä»–ä»»åŠ¡æ—¶é—´éƒ½å¤šå¥½å‡ å€ï¼ŒåŸºæœ¬å°±æ˜¯äº†ï¼Œç„¶åå†è¿›å»çœ‹ä»»åŠ¡æ—¥å¿—ï¼Œæ‰¾åˆ°inforä¿¡æ¯ï¼ŒæŸ¥çœ‹çœ‹æ—¶é—´è·¨åº¦ï¼Œå¦‚æœæ—¶é—´è·¨åº¦å¾ˆé•¿çš„è¯ï¼Œåé¢çš„joinforkeyé‡Œé¢çš„keyå€¼å°±æ˜¯å€¾æ–œçš„keyï¼Œæ­¤æ—¶åˆ†è€Œæ²»ä¹‹ï¼Œå°†è¯¥å€¾æ–œkeyè¿›è¡Œmapjoinï¼Œå…¶ä»–çš„æ­£å¸¸reduce joinå†unionèµ·æ¥ï¼Œé—®é¢˜è§£å†³äº†ï¼Œä¸€ç§å€¾æ–œçš„å¤„ç†æ€è·¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631259453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1529153,"avatar":"https://static001.geekbang.org/account/avatar/00/17/55/41/b68df312.jpg","nickname":"å†œå¤«ä¸‰æ‹³","note":"","ucode":"9778194A7CD44E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380699,"discussion_content":"ç›´æ¥æ•°æ®é‡‡æ · æ˜¯ä¸æ˜¯å¯ä»¥å¾—åˆ°å€¾æ–œçš„key","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624635422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359340,"user_name":"Ebdaoli","can_delete":false,"product_type":"c1","uid":1722878,"ip_address":"ä¸Šæµ·","ucode":"E45C113C1AFD12","user_header":"https://static001.geekbang.org/account/avatar/00/1a/49/fe/48846a6d.jpg","comment_is_top":false,"comment_ctime":1665455588,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665455588","product_id":100073401,"comment_content":"å¯¹äºåˆ†è€Œæ²»ä¹‹è¿™é‡Œï¼Œæˆ‘æœ‰ç‚¹å›°æƒ‘ï¼Œå‡è®¾ä¸¤å¼ è¡¨éƒ½æ˜¯TBçº§åˆ«çš„ï¼Œè¡¨tableAçš„æ•°æ®ä¸ºï¼ˆ1,2,3,4,4,4,4...ï¼‰ï¼Œè¡¨tableBçš„æ•°æ®ä¸ºï¼ˆ1,1,1,1,2,3,4...ï¼‰ï¼Œsqlä¸ºï¼šselect a.key, a.value from tableA inner join tableB on a.key=b.keyï¼›æ ¹æ®å‡åŒ€çš„tableAå’Œå‡åŒ€çš„tableBè¿›è¡Œå…³è”ï¼Œè¿™æ—¶å€™ï¼ŒtableAçš„å‡åŒ€keyéƒ¨åˆ†å°±æ˜¯(1,2,3...) å»ä¸tableBçš„å‡åŒ€keyéƒ¨åˆ†(2,3,4...)è¿›è¡Œå…³è”ï¼Œå€¾æ–œéƒ¨åˆ†æ˜¯tableAçš„ï¼ˆ4,4,4,4ï¼‰ä¸tableBçš„ï¼ˆ1,1,1,1)è¿›è¡Œå…³è”ï¼Œå³ä½¿æ˜¯åŠ ç›ä¹Ÿå…³è”ä¸ä¸Šï¼Œæœ€åå†è¿›è¡Œunion ä¸¤éƒ¨åˆ†ç»“æœï¼Œè¿™æ—¶å€™çš„å®é™…æ˜¯å€¾æ–œéƒ¨åˆ†æ— æ³•å…³è”ä¸Šï¼Œç»“æœä¸ºNULLï¼Œå‡åŒ€éƒ¨åˆ†tableAçš„4å’ŒtableBçš„1ä¹Ÿå…³è”ä¸ä¸Šï¼Œæœ€ç»ˆçš„union è¿™ä¸¤éƒ¨åˆ†çš„ç»“æœå®é™…ä¸Šå¹¶ä¸æ˜¯ç¬¦åˆåŸå§‹sqlçš„ç»“æœï¼Œè¯·ç£Šå“¥å¸®å¿™è§£ç­”ä¸‹è¿™ç§æƒ…å†µï¼Œè°¢è°¢ï¼","like_count":0},{"had_liked":false,"id":352448,"user_name":"ä½ æŒºæ·˜å•Š","can_delete":false,"product_type":"c1","uid":1247915,"ip_address":"","ucode":"8C9CAF63A14CC2","user_header":"https://static001.geekbang.org/account/avatar/00/13/0a/ab/4d0cd508.jpg","comment_is_top":false,"comment_ctime":1658675995,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658675995","product_id":100073401,"comment_content":"åŠ ç›çš„å€æ•°æ˜¯é€šè¿‡executoræ•°æ¥ç¡®è®¤ï¼Œexecutoræ•°æ€ä¹ˆç¡®è®¤å‘¢ï¼Ÿè¿™ä¸ªä¸æ˜¯åŠ¨æ€å˜åŒ–çš„å—ï¼Ÿæ¯”å¦‚è®¾ç½®minexecutorå’Œmaxå€¼ï¼Ÿ","like_count":0},{"had_liked":false,"id":331689,"user_name":"Unknown element","can_delete":false,"product_type":"c1","uid":2028277,"ip_address":"","ucode":"34A129800D0238","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","comment_is_top":false,"comment_ctime":1642726435,"is_pvip":false,"replies":[{"id":"121206","content":"å¯¹ï¼Œå¦‚æœæ˜¯çº¯SQLçš„è¯ï¼Œåªèƒ½ä¾é è°ƒå‚å’Œå¼•æ“æœ¬èº«çš„ç‰¹æ€§æ¥å®ç°ä¼˜åŒ–ï¼Œæ¯”å¦‚è¯´Hiveçš„map side joinæœºåˆ¶ï¼Œç­‰ç­‰ã€‚åƒä¸¤é˜¶æ®µShuffleè¿™ç§æ¯”è¾ƒå®šåˆ¶åŒ–çš„æ–¹æ¡ˆï¼Œè¿˜æ˜¯éœ€è¦å¼€å‘è€…è‡ªå·±æ¥å®ç°","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1642780539,"ip_address":"","comment_id":331689,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1642726435","product_id":100073401,"comment_content":"è€å¸ˆæ‚¨å¥½ è¿™ä¸¤è®²ä»‹ç»çš„ä¼˜åŒ–æ–¹æ³•å¥½åƒåªé€‚ç”¨äºç”¨sparkåŸç”ŸAPIå¼€å‘çš„æƒ…å†µï¼Ÿå¦‚æœæ˜¯hive SQLæ˜¯ä¸æ˜¯å°±åªèƒ½é€šè¿‡è°ƒå‚æ¥ä¼˜åŒ–äº†ï¼Ÿè°¢è°¢è€å¸ˆ~","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547654,"discussion_content":"å¯¹ï¼Œå¦‚æœæ˜¯çº¯SQLçš„è¯ï¼Œåªèƒ½ä¾é è°ƒå‚å’Œå¼•æ“æœ¬èº«çš„ç‰¹æ€§æ¥å®ç°ä¼˜åŒ–ï¼Œæ¯”å¦‚è¯´Hiveçš„map side joinæœºåˆ¶ï¼Œç­‰ç­‰ã€‚åƒä¸¤é˜¶æ®µShuffleè¿™ç§æ¯”è¾ƒå®šåˆ¶åŒ–çš„æ–¹æ¡ˆï¼Œè¿˜æ˜¯éœ€è¦å¼€å‘è€…è‡ªå·±æ¥å®ç°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642780539,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331616,"user_name":"Monster","can_delete":false,"product_type":"c1","uid":1904517,"ip_address":"","ucode":"2C2C023DCE29CD","user_header":"https://static001.geekbang.org/account/avatar/00/1d/0f/85/e2944235.jpg","comment_is_top":false,"comment_ctime":1642670870,"is_pvip":false,"replies":[{"id":"121205","content":"å…¶å®å°±æ˜¯æŠŠå†…è¡¨æ•°æ®å¤åˆ¶Nä»½ï¼Œæ¯ä»½çš„åç¼€éƒ½ä¸åŒï¼Œç¬¬ä¸€ä»½åç¼€æ˜¯1ï¼Œç¬¬äºŒä»½åç¼€æ˜¯2ï¼Œä»¥æ­¤ç±»æ¨ï¼›ç›®çš„å’Œä½ è¯´çš„ä¸€æ ·ï¼Œè¦ä¿æŒå’Œå¤–è¡¨çš„ä¸€è‡´æ€§ã€‚å¤–è¡¨åŠ äº†ç›ï¼Œå†…è¡¨ä¹Ÿéœ€è¦åŠ ç›ï¼Œåªä¸è¿‡å†…è¡¨éœ€è¦â€œå¤åˆ¶+åŠ ç›â€ï¼Œè€Œå¤–è¡¨çš„éšæœºåŠ ç›æœ‰æ‰€ä¸åŒ~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1642780456,"ip_address":"","comment_id":331616,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1642670870","product_id":100073401,"comment_content":"&#47;&#47;å†…è¡¨å¤åˆ¶åŠ ç›<br>var saltedskewOrders = skewOrders.withColumn(â€œjoinKeyâ€, concat($â€œorderIdâ€, lit(â€œ_â€), lit(1)))for (i &lt;- 2 to numExecutors) {saltedskewOrders = saltedskewOrders union skewOrders.withColumn(â€œjoinKeyâ€, concat($â€œorderIdâ€, lit(â€œ_â€), lit(i)))}<br><br>å¯¹å†…è¡¨å¤åˆ¶åŠ ç›è¿™å—çš„ä»£ç è¿˜æ˜¯æ²¡å¤ªç†è§£ï¼Œè€å¸ˆå¯å¦å†æŒ‡å¯¼ä¸‹ï¼Ÿ<br>ä¸¾ä¸ªä¾‹å­è¯´ä¸‹ï¼Œæˆ‘ç†è§£çš„è¿™ä¸ªéƒ¨åˆ†çš„ä»£ç å®ç°ç›®çš„ï¼š<br>ä¾‹å¦‚order_id=12345ï¼Œåœ¨å¤–è¡¨åŠ ç›åå˜æˆï¼š12345_1ï¼Œé‚£ä¹ˆå†…è¡¨å¤åˆ¶åŠ ç›åä¹Ÿåº”è¯¥æ˜¯ï¼š12345_1ï¼Œå¦åˆ™joinæ—¶å€™å…³è”æ¡ä»¶ä¼šå…³è”ä¸åˆ°ã€‚ä½†è¿˜æ˜¯æ²¡çœ‹æ‡‚è¿™ä¸ªå†…è¡¨å¤åˆ¶åŠ ç›çš„ä»£ç é€»è¾‘æ˜¯æ€ä¹ˆå®ç°çš„ã€‚æ±‚è€å¸ˆè§£ç­”ï¼Œéå¸¸æ„Ÿè°¢ï¼","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547653,"discussion_content":"å…¶å®å°±æ˜¯æŠŠå†…è¡¨æ•°æ®å¤åˆ¶Nä»½ï¼Œæ¯ä»½çš„åç¼€éƒ½ä¸åŒï¼Œç¬¬ä¸€ä»½åç¼€æ˜¯1ï¼Œç¬¬äºŒä»½åç¼€æ˜¯2ï¼Œä»¥æ­¤ç±»æ¨ï¼›ç›®çš„å’Œä½ è¯´çš„ä¸€æ ·ï¼Œè¦ä¿æŒå’Œå¤–è¡¨çš„ä¸€è‡´æ€§ã€‚å¤–è¡¨åŠ äº†ç›ï¼Œå†…è¡¨ä¹Ÿéœ€è¦åŠ ç›ï¼Œåªä¸è¿‡å†…è¡¨éœ€è¦â€œå¤åˆ¶+åŠ ç›â€ï¼Œè€Œå¤–è¡¨çš„éšæœºåŠ ç›æœ‰æ‰€ä¸åŒ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642780456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323299,"user_name":"å­å…®","can_delete":false,"product_type":"c1","uid":2767208,"ip_address":"","ucode":"BA213EAB26DF16","user_header":"https://static001.geekbang.org/account/avatar/00/2a/39/68/56dfc8c0.jpg","comment_is_top":false,"comment_ctime":1637824890,"is_pvip":false,"replies":[{"id":"117434","content":"ä¸¤é˜¶æ®µShuffleï¼Œç›®çš„æ˜¯æ¶ˆé™¤æ‰Executorsçº§åˆ«çš„è´Ÿè½½å‡è¡¡é—®é¢˜ï¼ŒåŠ ç›ä¹‹åï¼Œå®é™…ä¸Šæ•°æ®å°±ä¸å†å€¾æ–œï¼Œè¿™ä¸ªæ—¶å€™Shuffleï¼Œæ•°æ®åœ¨Executorsçš„åˆ†å¸ƒå¼å‡è¡¡çš„ï¼Œå› æ­¤è´Ÿè½½ä¹Ÿæ˜¯å‡è¡¡çš„ã€‚è¿™æ ·çš„è¯ï¼Œèšåˆä¹‹åï¼ŒåŸå§‹keyçš„æ•°é‡ï¼Œä¼šå‘ˆæŒ‡æ•°çº§é”å‡ã€‚æ¯”å¦‚ï¼ŒåŸæ¥çš„key=-1ï¼ŒCardinalityæ˜¯10ï¼Œè€Œæ•°é‡æ˜¯1äº¿ï¼Œåœ¨åŠ ç›ã€reduceè¿‡åï¼Œæ•°é‡å°±é€€åŒ–ä¸º10ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¸åŒkeyä¹‹é—´ï¼Œæ•°é‡å…¶å®éƒ½å·®ä¸å¤ªå¤šï¼Œå€¾æ–œé—®é¢˜ä¸å†äº†ã€‚ç„¶åï¼ŒæŠŠrandomå»æ‰ï¼Œä¹Ÿå°±æ˜¯å»ç›åŒ–ï¼Œå†shuffleã€èšåˆä¸€æ¬¡ï¼Œä¹Ÿä¸ä¼šæœ‰å€¾æ–œé—®é¢˜ï¼Œè€Œè®¡ç®—çš„é€»è¾‘ï¼Œä¸åŸæ¥ä¿æŒä¸€è‡´ï¼Œå¯è°“ä¸¤å…¨å…¶ç¾","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1638066602,"ip_address":"","comment_id":323299,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1637824890","product_id":100073401,"comment_content":"è€å¸ˆï¼Œâ€œä¸¤é˜¶æ®µ Shuffleâ€æŒ‡çš„æ˜¯ï¼Œé€šè¿‡â€œåŠ ç›ã€Shuffleã€å…³è”ã€èšåˆâ€ä¸â€œå»ç›åŒ–ã€Shuffleã€èšåˆâ€è¿™ä¸¤ä¸ªé˜¶æ®µçš„è®¡ç®—è¿‡ç¨‹ï¼Œç¬¬äºŒé˜¶æ®µå»ç›åè¿›è¡Œshuffleï¼Œä¸æ˜¯ä»ç„¶ä¼šæŠŠä¸€ä¸ªkey çš„æ‰€æœ‰å€¼æ‹‰åˆ°ä¸€èµ·å—ï¼Ÿè¿™å’Œç›´æ¥joinæœ€åçš„ç»“æœä¸€æ ·çš„å‘€ï¼Ÿåº”è¯¥æ˜¯å»ç›åä¸å†è¿›è¡Œshuffleç±»çš„æ“ä½œè¿™ç§åŠ ç›çš„æ“ä½œæ‰æœ‰æ„ä¹‰ï¼Œå¦‚ç†è§£æœ‰è¯¯ï¼Œè¿˜è¯·è€å¸ˆè§£ç­”ï¼Œè°¢è°¢","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":533997,"discussion_content":"ä¸¤é˜¶æ®µShuffleï¼Œç›®çš„æ˜¯æ¶ˆé™¤æ‰Executorsçº§åˆ«çš„è´Ÿè½½å‡è¡¡é—®é¢˜ï¼ŒåŠ ç›ä¹‹åï¼Œå®é™…ä¸Šæ•°æ®å°±ä¸å†å€¾æ–œï¼Œè¿™ä¸ªæ—¶å€™Shuffleï¼Œæ•°æ®åœ¨Executorsçš„åˆ†å¸ƒå¼å‡è¡¡çš„ï¼Œå› æ­¤è´Ÿè½½ä¹Ÿæ˜¯å‡è¡¡çš„ã€‚è¿™æ ·çš„è¯ï¼Œèšåˆä¹‹åï¼ŒåŸå§‹keyçš„æ•°é‡ï¼Œä¼šå‘ˆæŒ‡æ•°çº§é”å‡ã€‚æ¯”å¦‚ï¼ŒåŸæ¥çš„key=-1ï¼ŒCardinalityæ˜¯10ï¼Œè€Œæ•°é‡æ˜¯1äº¿ï¼Œåœ¨åŠ ç›ã€reduceè¿‡åï¼Œæ•°é‡å°±é€€åŒ–ä¸º10ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¸åŒkeyä¹‹é—´ï¼Œæ•°é‡å…¶å®éƒ½å·®ä¸å¤ªå¤šï¼Œå€¾æ–œé—®é¢˜ä¸å†äº†ã€‚ç„¶åï¼ŒæŠŠrandomå»æ‰ï¼Œä¹Ÿå°±æ˜¯å»ç›åŒ–ï¼Œå†shuffleã€èšåˆä¸€æ¬¡ï¼Œä¹Ÿä¸ä¼šæœ‰å€¾æ–œé—®é¢˜ï¼Œè€Œè®¡ç®—çš„é€»è¾‘ï¼Œä¸åŸæ¥ä¿æŒä¸€è‡´ï¼Œå¯è°“ä¸¤å…¨å…¶ç¾","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638066602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319330,"user_name":"To_Drill","can_delete":false,"product_type":"c1","uid":1415245,"ip_address":"","ucode":"7E6FFAF1986EC8","user_header":"https://static001.geekbang.org/account/avatar/00/15/98/4d/582d24f4.jpg","comment_is_top":false,"comment_ctime":1635748307,"is_pvip":false,"replies":[{"id":"115949","content":"è€å¼Ÿè¯´çš„â€œä»¥æ’åºä¸ºå‰æçš„èšåˆç±»æ“ä½œâ€ï¼Œèƒ½ä¸¾å‡ ä¸ªä¾‹å­ä¹ˆï¼Ÿæ–¹ä¾¿åˆ¤æ–­ä½ è¯´çš„è¿™äº›æ“ä½œï¼Œé€‚ä¸é€‚åˆåšâ€œåŠ ç›å¤„ç†â€ï¼Œå¦‚æœè®¾è®¡å¾—å½“çš„è¯ï¼Œæˆ‘è§‰å¾—â€œåŠ ç›â€ä¹‹åï¼Œåˆ†è€Œæ²»ä¹‹ï¼Œè¿˜æ˜¯èƒ½æ”¹å–„é—®é¢˜çš„","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1635955417,"ip_address":"","comment_id":319330,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1635748307","product_id":100073401,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæƒ³è¯·æ•™ä¸‹ï¼Œåƒä»¥æ’åºä¸ºå‰æçš„èšåˆç±»æ“ä½œï¼ˆä¸€èˆ¬éƒ½ä¼šè¿›è¡Œå…¨å±€æ’åºï¼‰å¦‚æœå‘ç”Ÿæ•°æ®å€¾æ–œäº†ï¼Œåœ¨èµ„æºå›ºå®šçš„å‰æä¸‹æœ‰å•¥æœ‰æ•ˆçš„æ–¹æ³•ä¼˜åŒ–å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529594,"discussion_content":"è€å¼Ÿè¯´çš„â€œä»¥æ’åºä¸ºå‰æçš„èšåˆç±»æ“ä½œâ€ï¼Œèƒ½ä¸¾å‡ ä¸ªä¾‹å­ä¹ˆï¼Ÿæ–¹ä¾¿åˆ¤æ–­ä½ è¯´çš„è¿™äº›æ“ä½œï¼Œé€‚ä¸é€‚åˆåšâ€œåŠ ç›å¤„ç†â€ï¼Œå¦‚æœè®¾è®¡å¾—å½“çš„è¯ï¼Œæˆ‘è§‰å¾—â€œåŠ ç›â€ä¹‹åï¼Œåˆ†è€Œæ²»ä¹‹ï¼Œè¿˜æ˜¯èƒ½æ”¹å–„é—®é¢˜çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635955417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293881,"user_name":"ç‹å¤©é›¨","can_delete":false,"product_type":"c1","uid":2531597,"ip_address":"","ucode":"C2E4D769DA0BFA","user_header":"","comment_is_top":false,"comment_ctime":1621586011,"is_pvip":false,"replies":[{"id":"106619","content":"å¹³å‡æ•°æ˜¯æ²¡é—®é¢˜çš„ï¼Œå¹³å‡æ•°çš„è®¡ç®—ä¸æ’åºæ— å…³ï¼Œå…¶å®èšåˆå¤šå°‘æ¬¡éƒ½æ˜¯OKçš„ã€‚è¿™é‡Œçš„å…³é”®æ˜¯â€œèšåˆçš„å‰ææ˜¯æ’åºâ€ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æ±‚åˆ†ä½æ•°ï¼Œ25%åˆ†ä½ã€75%åˆ†ä½æˆ–æ˜¯ä¸­ä½æ•°ï¼Œç­‰ç­‰ï¼Œè¿™äº›è®¡ç®—æ˜¯éœ€è¦å…ˆè¿›è¡Œå…¨å±€æ’åºï¼Œç„¶åæ‰å¯ä»¥è®¡ç®—çš„ã€‚åƒè¿™äº›å¯¹äºæ’åºæœ‰ä¾èµ–çš„èšåˆè®¡ç®—ï¼Œå°±ä¸é€‚åˆâ€œä¸¤é˜¶æ®µShuffleâ€~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621691582,"ip_address":"","comment_id":293881,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1621586011","product_id":100073401,"comment_content":"2ã€æ¯”å¦‚èšåˆæ“ä½œæ˜¯å–å¹³å‡æ•° ï¼Œå°±ä¸é€‚åˆäºŒæ¬¡èšåˆäº†å§","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520412,"discussion_content":"å¹³å‡æ•°æ˜¯æ²¡é—®é¢˜çš„ï¼Œå¹³å‡æ•°çš„è®¡ç®—ä¸æ’åºæ— å…³ï¼Œå…¶å®èšåˆå¤šå°‘æ¬¡éƒ½æ˜¯OKçš„ã€‚è¿™é‡Œçš„å…³é”®æ˜¯â€œèšåˆçš„å‰ææ˜¯æ’åºâ€ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æ±‚åˆ†ä½æ•°ï¼Œ25%åˆ†ä½ã€75%åˆ†ä½æˆ–æ˜¯ä¸­ä½æ•°ï¼Œç­‰ç­‰ï¼Œè¿™äº›è®¡ç®—æ˜¯éœ€è¦å…ˆè¿›è¡Œå…¨å±€æ’åºï¼Œç„¶åæ‰å¯ä»¥è®¡ç®—çš„ã€‚åƒè¿™äº›å¯¹äºæ’åºæœ‰ä¾èµ–çš„èšåˆè®¡ç®—ï¼Œå°±ä¸é€‚åˆâ€œä¸¤é˜¶æ®µShuffleâ€~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621691582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254277,"avatar":"https://static001.geekbang.org/account/avatar/00/13/23/85/e19f8833.jpg","nickname":"tony","note":"","ucode":"D5BBFBEB576BE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392991,"discussion_content":"è€å¸ˆï¼Œmapç«¯ä¸èƒ½æ±‚å¹³å‡æ•°å§ï¼Ÿ\n\n1 4 7 8 2 1  5  4  avg:4\n\n1 4 7  avg:4\n8 2  avg:5       4+5+3.33 / 3 !=4\n1 5 4 avg:3.33","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631197861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293467,"user_name":"æ¯›èª","can_delete":false,"product_type":"c1","uid":1950404,"ip_address":"","ucode":"7119424A7A4E68","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJHUiaEqkvVd7ByrjHznN9mPqPskLUtUHdliaxq7MVDicEoWQqOB9f8w2BIdhn5AP5QGiaAhXcRdrIZ7w/132","comment_is_top":false,"comment_ctime":1621396314,"is_pvip":false,"replies":[{"id":"106297","content":"ç¬¬ä¸€é¢˜æ»¡åˆ†ğŸ’¯~<br><br>ç¬¬äºŒé¢˜å†æƒ³æƒ³å“ˆ~ å†…è¡¨è™½ç„¶ç¡®å®å¤šäº†ä¸å°‘å‰¯æœ¬ï¼Œä½†æ˜¯ç»“åˆä¹‹å‰æˆ‘ä»¬è®²çš„â€œä¸‰è¶³é¼ç«‹â€ï¼Œç”±äºå¹¶è¡Œåº¦è·Ÿç€å˜å¤§äº†ï¼Œæ‰€ä»¥æ¯ä¸ªæ•°æ®åˆ†ç‰‡çš„å¤§å°å¹¶æ²¡æœ‰å˜åŒ–ï¼Œå› æ­¤å®é™…ä¸Šå¹¶ä¸å­˜åœ¨OOMçš„éšæ‚£ã€‚<br><br>æœç€æ’åºçš„æ–¹å‘æƒ³ä¸€æƒ³ï¼Œå¦‚æœShuffleä¸­æ¶‰åŠçš„èšåˆè®¡ç®—éœ€è¦ä»¥æ’åºä¸ºå‰æï¼Œé‚£ä¹ˆåŠ ç›ä¹‹åçš„ä¼˜åŒ–æ‰‹æ®µï¼Œä¹Ÿå°±æ˜¯â€œä¸¤é˜¶æ®µShuffleâ€ï¼Œä¼šä¸ä¼šç ´ååŸå…ˆçš„è®¡ç®—é€»è¾‘ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621422239,"ip_address":"","comment_id":293467,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1621396314","product_id":100073401,"comment_content":"1.å¯ä»¥å°†Join Keyså…ˆgroup byç»Ÿè®¡ä¸€ä¸‹å„ä¸ªä¸åŒçš„ç»„åˆçš„æ•°æ®é‡ï¼Œå¯ä»¥å–å‡ºå‰å‡ ä¸ªæ•°æ®é‡ç‰¹åˆ«å¤§çš„ä½œä¸ºå€¾æ–œç»„ï¼Œå‰©ä½™çš„ä½œä¸ºéå€¾æ–œç»„ã€‚<br>2.â€œä¸¤é˜¶æ®µShuffleâ€è¦å¯¹å†…è¡¨è¿›è¡Œâ€œå¤åˆ¶åŠ ç›â€ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´å†…è¡¨çš„å¤§å°å˜å¾—å¤ªå¤§ï¼Œå¦‚æœå†…è¡¨åŸæ¥çš„å¤§å°å°±è¶…è¿‡å•ä¸ªExecutorçš„å¤§å°ï¼Œâ€œå¤åˆ¶åŠ ç›â€ååº”è¯¥ä¼šå¯¼è‡´OOMã€‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520226,"discussion_content":"ç¬¬ä¸€é¢˜æ»¡åˆ†ğŸ’¯~\n\nç¬¬äºŒé¢˜å†æƒ³æƒ³å“ˆ~ å†…è¡¨è™½ç„¶ç¡®å®å¤šäº†ä¸å°‘å‰¯æœ¬ï¼Œä½†æ˜¯ç»“åˆä¹‹å‰æˆ‘ä»¬è®²çš„â€œä¸‰è¶³é¼ç«‹â€ï¼Œç”±äºå¹¶è¡Œåº¦è·Ÿç€å˜å¤§äº†ï¼Œæ‰€ä»¥æ¯ä¸ªæ•°æ®åˆ†ç‰‡çš„å¤§å°å¹¶æ²¡æœ‰å˜åŒ–ï¼Œå› æ­¤å®é™…ä¸Šå¹¶ä¸å­˜åœ¨OOMçš„éšæ‚£ã€‚\n\næœç€æ’åºçš„æ–¹å‘æƒ³ä¸€æƒ³ï¼Œå¦‚æœShuffleä¸­æ¶‰åŠçš„èšåˆè®¡ç®—éœ€è¦ä»¥æ’åºä¸ºå‰æï¼Œé‚£ä¹ˆåŠ ç›ä¹‹åçš„ä¼˜åŒ–æ‰‹æ®µï¼Œä¹Ÿå°±æ˜¯â€œä¸¤é˜¶æ®µShuffleâ€ï¼Œä¼šä¸ä¼šç ´ååŸå…ˆçš„è®¡ç®—é€»è¾‘ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621422239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1950404,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJHUiaEqkvVd7ByrjHznN9mPqPskLUtUHdliaxq7MVDicEoWQqOB9f8w2BIdhn5AP5QGiaAhXcRdrIZ7w/132","nickname":"æ¯›èª","note":"","ucode":"7119424A7A4E68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375306,"discussion_content":"æƒ³åˆ°ä¸€ä¸ªåœºæ™¯ï¼Œæ˜¯çª—å£å‡½æ•°ä¸­çš„èšåˆè®¡ç®—ï¼Œå¦‚æœéœ€è¦ç”¨æ’åºçš„è¯ï¼ŒåŠ ç›ä¼šç ´ååŸå…ˆé€»è¾‘ï¼Œå¦‚sum(col1) over(partition by col2 order by col3)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621568697,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1950404,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJHUiaEqkvVd7ByrjHznN9mPqPskLUtUHdliaxq7MVDicEoWQqOB9f8w2BIdhn5AP5QGiaAhXcRdrIZ7w/132","nickname":"æ¯›èª","note":"","ucode":"7119424A7A4E68","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375522,"discussion_content":"æ²¡é”™~ ä»¥æ’åºä¸ºå‰æçš„èšåˆï¼Œå°±ä¸èƒ½å†ç”¨â€œä¸¤é˜¶æ®µShuffleâ€äº†~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621724722,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375306,"ip_address":""},"score":375522,"extra":""}]}]},{"had_liked":false,"id":293424,"user_name":"abuff","can_delete":false,"product_type":"c1","uid":1182066,"ip_address":"","ucode":"4916C25D81833C","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/72/7293dd69.jpg","comment_is_top":false,"comment_ctime":1621388122,"is_pvip":false,"replies":[{"id":"106259","content":"éƒ½å¯ä»¥çš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯æŠŠJon Keysæ‰“æ•£ï¼Œè¿™æ ·å“ˆå¸Œè¿‡åï¼Œä»–ä»¬ä¼šè¢«Shuffleåˆ°ä¸åŒçš„Executorsä¸­å»ã€‚æ‰€ä»¥è¯´ï¼Œç›ç²’åŠ åœ¨å‰ã€åä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ï¼ŒåŠ ç›ä¹‹åçš„Join Keysï¼Œå·²ç»è¢«æ‰“æ•£äº†ï¼ŒShuffleè¿‡åçš„æ•°æ®åˆ†å¸ƒæ›´å‡åŒ€~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1621399601,"ip_address":"","comment_id":293424,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1621388122","product_id":100073401,"comment_content":"åŠ ç›ä¸åº”è¯¥æ˜¯åŠ åœ¨å‰ç¼€å—ï¼Ÿæ–‡ç« æ€ä¹ˆå†™æ˜¯åç¼€å‘¢","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520210,"discussion_content":"éƒ½å¯ä»¥çš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯æŠŠJon Keysæ‰“æ•£ï¼Œè¿™æ ·å“ˆå¸Œè¿‡åï¼Œä»–ä»¬ä¼šè¢«Shuffleåˆ°ä¸åŒçš„Executorsä¸­å»ã€‚æ‰€ä»¥è¯´ï¼Œç›ç²’åŠ åœ¨å‰ã€åä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ï¼ŒåŠ ç›ä¹‹åçš„Join Keysï¼Œå·²ç»è¢«æ‰“æ•£äº†ï¼ŒShuffleè¿‡åçš„æ•°æ®åˆ†å¸ƒæ›´å‡åŒ€~","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621399601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1950404,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJHUiaEqkvVd7ByrjHznN9mPqPskLUtUHdliaxq7MVDicEoWQqOB9f8w2BIdhn5AP5QGiaAhXcRdrIZ7w/132","nickname":"æ¯›èª","note":"","ucode":"7119424A7A4E68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374856,"discussion_content":"æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä¸ºäº†æ‰“æ•£æ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621391044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1950404,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJHUiaEqkvVd7ByrjHznN9mPqPskLUtUHdliaxq7MVDicEoWQqOB9f8w2BIdhn5AP5QGiaAhXcRdrIZ7w/132","nickname":"æ¯›èª","note":"","ucode":"7119424A7A4E68","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375521,"discussion_content":"æ­£è§£~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621724587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":374856,"ip_address":""},"score":375521,"extra":""}]}]}]}