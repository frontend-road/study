{"id":107209,"title":"46 | å‘é€ç½‘ç»œåŒ…ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•è¡¨è¾¾æˆ‘ä»¬æƒ³è®©åˆä½œä¼™ä¼´åšä»€ä¹ˆï¼Ÿ","content":"<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²ç½‘ç»œåŒ…çš„å‘é€ï¼Œè®²äº†ä¸ŠåŠéƒ¨åˆ†ï¼Œä¹Ÿå³ä»VFSå±‚ä¸€ç›´åˆ°IPå±‚ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬æ¥ç€çœ‹ä¸‹å»ï¼Œçœ‹IPå±‚å’ŒMACå±‚æ˜¯å¦‚ä½•å‘é€æ•°æ®çš„ã€‚</p><h2>è§£æip_queue_xmitå‡½æ•°</h2><p>ä»ip_queue_xmitå‡½æ•°å¼€å§‹ï¼Œæˆ‘ä»¬å°±è¦è¿›å…¥IPå±‚çš„å‘é€é€»è¾‘äº†ã€‚</p><pre><code>int ip_queue_xmit(struct sock *sk, struct sk_buff *skb, struct flowi *fl)\n{\n    struct inet_sock *inet = inet_sk(sk);\n    struct net *net = sock_net(sk);\n    struct ip_options_rcu *inet_opt;\n    struct flowi4 *fl4;\n    struct rtable *rt;\n    struct iphdr *iph;\n    int res;\n\n    inet_opt = rcu_dereference(inet-&gt;inet_opt);\n    fl4 = &amp;fl-&gt;u.ip4;\n    rt = skb_rtable(skb);\n    /* Make sure we can route this packet. */\n    rt = (struct rtable *)__sk_dst_check(sk, 0);\n    if (!rt) {\n        __be32 daddr;\n        /* Use correct destination address if we have options. */\n        daddr = inet-&gt;inet_daddr;\n ......\n        rt = ip_route_output_ports(net, fl4, sk,\n                       daddr, inet-&gt;inet_saddr,\n                       inet-&gt;inet_dport,\n                       inet-&gt;inet_sport,\n                       sk-&gt;sk_protocol,\n                       RT_CONN_FLAGS(sk),\n                       sk-&gt;sk_bound_dev_if);\n        if (IS_ERR(rt))\n            goto no_route;\n        sk_setup_caps(sk, &amp;rt-&gt;dst);\n    }\n    skb_dst_set_noref(skb, &amp;rt-&gt;dst);\n\npacket_routed:\n    /* OK, we know where to send it, allocate and build IP header. */\n    skb_push(skb, sizeof(struct iphdr) + (inet_opt ? inet_opt-&gt;opt.optlen : 0));\n    skb_reset_network_header(skb);\n    iph = ip_hdr(skb);\n    *((__be16 *)iph) = htons((4 &lt;&lt; 12) | (5 &lt;&lt; 8) | (inet-&gt;tos &amp; 0xff));\n    if (ip_dont_fragment(sk, &amp;rt-&gt;dst) &amp;&amp; !skb-&gt;ignore_df)\n        iph-&gt;frag_off = htons(IP_DF);\n    else\n        iph-&gt;frag_off = 0;\n    iph-&gt;ttl      = ip_select_ttl(inet, &amp;rt-&gt;dst);\n    iph-&gt;protocol = sk-&gt;sk_protocol;\n    ip_copy_addrs(iph, fl4);\n\n    /* Transport layer set skb-&gt;h.foo itself. */\n\n    if (inet_opt &amp;&amp; inet_opt-&gt;opt.optlen) {\n        iph-&gt;ihl += inet_opt-&gt;opt.optlen &gt;&gt; 2;\n        ip_options_build(skb, &amp;inet_opt-&gt;opt, inet-&gt;inet_daddr, rt, 0);\n    }\n\n    ip_select_ident_segs(net, skb, sk,\n                 skb_shinfo(skb)-&gt;gso_segs ?: 1);\n\n    /* TODO : should we use skb-&gt;sk here instead of sk ? */\n    skb-&gt;priority = sk-&gt;sk_priority;\n    skb-&gt;mark = sk-&gt;sk_mark;\n\n    res = ip_local_out(net, sk, skb);\n......\n}\n</code></pre><p>åœ¨ip_queue_xmitä¸­ï¼Œä¹Ÿå³IPå±‚çš„å‘é€å‡½æ•°é‡Œé¢ï¼Œæœ‰ä¸‰éƒ¨åˆ†é€»è¾‘ã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†ï¼Œé€‰å–è·¯ç”±ï¼Œä¹Ÿå³æˆ‘è¦å‘é€è¿™ä¸ªåŒ…åº”è¯¥ä»å“ªä¸ªç½‘å¡å‡ºå»ã€‚</p><p>è¿™ä»¶äº‹æƒ…ä¸»è¦ç”±ip_route_output_portså‡½æ•°å®Œæˆã€‚æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šip_route_output_ports-&gt;ip_route_output_flow-&gt;__ip_route_output_key-&gt;ip_route_output_key_hash-&gt;ip_route_output_key_hash_rcuã€‚</p><pre><code>struct rtable *ip_route_output_key_hash_rcu(struct net *net, struct flowi4 *fl4, struct fib_result *res, const struct sk_buff *skb)\n{\n\tstruct net_device *dev_out = NULL;\n\tint orig_oif = fl4-&gt;flowi4_oif;\n\tunsigned int flags = 0;\n\tstruct rtable *rth;\n......\n    err = fib_lookup(net, fl4, res, 0);\n......\nmake_route:\n\trth = __mkroute_output(res, fl4, orig_oif, dev_out, flags);\n......\n}\n</code></pre><p>ip_route_output_key_hash_rcuå…ˆä¼šè°ƒç”¨fib_lookupã€‚</p><p><strong>FIB</strong>å…¨ç§°æ˜¯Forwarding Information Baseï¼Œ<strong>è½¬å‘ä¿¡æ¯è¡¨ã€‚</strong>å…¶å®å°±æ˜¯å’±ä»¬å¸¸è¯´çš„è·¯ç”±è¡¨ã€‚</p><pre><code>static inline int fib_lookup(struct net *net, const struct flowi4 *flp, struct fib_result *res, unsigned int flags)\n{\tstruct fib_table *tb;\n......\n\ttb = fib_get_table(net, RT_TABLE_MAIN);\n\tif (tb)\n\t\terr = fib_table_lookup(tb, flp, res, flags | FIB_LOOKUP_NOREF);\n......\n}\n\n</code></pre><p>è·¯ç”±è¡¨å¯ä»¥æœ‰å¤šä¸ªï¼Œä¸€èˆ¬ä¼šæœ‰ä¸€ä¸ªä¸»è¡¨ï¼ŒRT_TABLE_MAINã€‚ç„¶åfib_table_lookupå‡½æ•°åœ¨è¿™ä¸ªè¡¨é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ã€‚</p><!-- [[[read_end]]] --><p>è·¯ç”±è¡¨æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„å‘¢ï¼Ÿ</p><p>è·¯ç”±å°±æ˜¯åœ¨LinuxæœåŠ¡å™¨ä¸Šçš„è·¯ç”±è¡¨é‡Œé¢é…ç½®çš„ä¸€æ¡ä¸€æ¡è§„åˆ™ã€‚è¿™äº›è§„åˆ™å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼šæƒ³è®¿é—®æŸä¸ªç½‘æ®µï¼Œä»æŸä¸ªç½‘å¡å‡ºå»ï¼Œä¸‹ä¸€è·³æ˜¯æŸä¸ªIPã€‚</p><p>ä¹‹å‰æˆ‘ä»¬è®²è¿‡ä¸€ä¸ªç®€å•çš„æ‹“æ‰‘å›¾ï¼Œé‡Œé¢çš„ä¸‰å°Linuxæœºå™¨çš„è·¯ç”±è¡¨éƒ½å¯ä»¥é€šè¿‡ip routeå‘½ä»¤æŸ¥çœ‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f6/0e/f6982eb85dc66bd04200474efb3a050e.png?wh=3650*2255\" alt=\"\"></p><pre><code># LinuxæœåŠ¡å™¨A\ndefault via 192.168.1.1 dev eth0\n192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.100 metric 100\n\n# LinuxæœåŠ¡å™¨B\ndefault via 192.168.2.1 dev eth0\n192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.100 metric 100\n\n# LinuxæœåŠ¡å™¨åšè·¯ç”±å™¨\n192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.1  \n192.168.2.0/24 dev eth1 proto kernel scope link src 192.168.2.1  \n</code></pre><p>å…¶å®ï¼Œå¯¹äºä¸¤ç«¯çš„æœåŠ¡å™¨æ¥è®²ï¼Œæˆ‘ä»¬æ²¡æœ‰å¤ªå¤šè·¯ç”±å¯ä»¥é€‰ï¼Œä½†æ˜¯å¯¹äºä¸­é—´çš„LinuxæœåŠ¡å™¨åšè·¯ç”±å™¨æ¥è®²ï¼Œè¿™é‡Œæœ‰ä¸¤æ¡è·¯å¯ä»¥é€‰ï¼Œä¸€ä¸ªæ˜¯å¾€å·¦é¢è½¬å‘ï¼Œä¸€ä¸ªæ˜¯å¾€å³é¢è½¬å‘ï¼Œå°±éœ€è¦è·¯ç”±è¡¨çš„æŸ¥æ‰¾ã€‚</p><p>fib_table_lookupçš„ä»£ç é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå¥½åœ¨æ³¨é‡Šæ¯”è¾ƒæ¸…æ¥šã€‚å› ä¸ºè·¯ç”±è¡¨è¦æŒ‰ç…§å‰ç¼€è¿›è¡ŒæŸ¥è¯¢ï¼Œå¸Œæœ›æ‰¾åˆ°æœ€é•¿åŒ¹é…çš„é‚£ä¸€ä¸ªï¼Œä¾‹å¦‚192.168.2.0/24å’Œ192.168.0.0/16éƒ½èƒ½åŒ¹é…192.168.2.100/24ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨192.168.2.0/24çš„è¿™ä¸€æ¡ã€‚</p><p>ä¸ºäº†æ›´æ–¹é¢çš„åšè¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Trieæ ‘è¿™ç§ç»“æ„ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ç³»åˆ—çš„å­—ç¬¦ä¸²ï¼š{bcs#, badge#, baby#, back#, badger#, badness#}ã€‚ä¹‹æ‰€ä»¥æ¯ä¸ªå­—ç¬¦ä¸²éƒ½åŠ ä¸Š#ï¼Œæ˜¯å¸Œæœ›ä¸è¦ä¸€ä¸ªå­—ç¬¦ä¸²æˆä¸ºå¦å¤–ä¸€ä¸ªå­—ç¬¦ä¸²çš„å‰ç¼€ã€‚ç„¶åæˆ‘ä»¬æŠŠå®ƒä»¬æ”¾åœ¨Trieæ ‘ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3f/11/3f0a99cf1c47afcd0bd740c4b7802511.png?wh=1543*2143\" alt=\"\"></p><p>å¯¹äºå°†IPåœ°å€è½¬æˆäºŒè¿›åˆ¶æ”¾å…¥trieæ ‘ï¼Œä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå¯ä»¥å¾ˆå¿«è¿›è¡Œè·¯ç”±çš„æŸ¥è¯¢ã€‚</p><p>æ‰¾åˆ°äº†è·¯ç”±ï¼Œå°±çŸ¥é“äº†åº”è¯¥ä»å“ªä¸ªç½‘å¡å‘å‡ºå»ã€‚</p><p>ç„¶åï¼Œip_route_output_key_hash_rcuä¼šè°ƒç”¨__mkroute_outputï¼Œåˆ›å»ºä¸€ä¸ªstruct rtableï¼Œè¡¨ç¤ºæ‰¾åˆ°çš„è·¯ç”±è¡¨é¡¹ã€‚è¿™ä¸ªç»“æ„æ˜¯ç”±rt_dst_allocå‡½æ•°åˆ†é…çš„ã€‚</p><pre><code>struct rtable *rt_dst_alloc(struct net_device *dev,\n\t\t\t    unsigned int flags, u16 type,\n\t\t\t    bool nopolicy, bool noxfrm, bool will_cache)\n{\n\tstruct rtable *rt;\n\n\trt = dst_alloc(&amp;ipv4_dst_ops, dev, 1, DST_OBSOLETE_FORCE_CHK,\n\t\t       (will_cache ? 0 : DST_HOST) |\n\t\t       (nopolicy ? DST_NOPOLICY : 0) |\n\t\t       (noxfrm ? DST_NOXFRM : 0));\n\n\tif (rt) {\n\t\trt-&gt;rt_genid = rt_genid_ipv4(dev_net(dev));\n\t\trt-&gt;rt_flags = flags;\n\t\trt-&gt;rt_type = type;\n\t\trt-&gt;rt_is_input = 0;\n\t\trt-&gt;rt_iif = 0;\n\t\trt-&gt;rt_pmtu = 0;\n\t\trt-&gt;rt_gateway = 0;\n\t\trt-&gt;rt_uses_gateway = 0;\n\t\trt-&gt;rt_table_id = 0;\n\t\tINIT_LIST_HEAD(&amp;rt-&gt;rt_uncached);\n\n\t\trt-&gt;dst.output = ip_output;\n\t\tif (flags &amp; RTCF_LOCAL)\n\t\t\trt-&gt;dst.input = ip_local_deliver;\n\t}\n\n\treturn rt;\n}\n</code></pre><p>æœ€ç»ˆè¿”å›struct rtableå®ä¾‹ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¹Ÿå°±å®Œæˆäº†ã€‚</p><p>ç¬¬äºŒéƒ¨åˆ†ï¼Œå°±æ˜¯å‡†å¤‡IPå±‚çš„å¤´ï¼Œå¾€é‡Œé¢å¡«å……å†…å®¹ã€‚è¿™å°±è¦å¯¹ç€IPå±‚çš„å¤´çš„æ ¼å¼è¿›è¡Œç†è§£ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6b/2b/6b2ea7148a8e04138a2228c5dbc7182b.png?wh=1066*1666\" alt=\"\"></p><p>åœ¨è¿™é‡Œé¢ï¼ŒæœåŠ¡ç±»å‹è®¾ç½®ä¸ºtosï¼Œæ ‡è¯†ä½é‡Œé¢è®¾ç½®æ˜¯å¦å…è®¸åˆ†ç‰‡frag_offã€‚å¦‚æœä¸å…è®¸ï¼Œè€Œé‡åˆ°MTUå¤ªå°è¿‡ä¸å»çš„æƒ…å†µï¼Œå°±å‘é€ICMPæŠ¥é”™ã€‚TTLæ˜¯è¿™ä¸ªåŒ…çš„å­˜æ´»æ—¶é—´ï¼Œä¸ºäº†é˜²æ­¢ä¸€ä¸ªIPåŒ…è¿·è·¯ä»¥åä¸€ç›´å­˜æ´»ä¸‹å»ï¼Œæ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨TTLéƒ½å‡ä¸€ï¼Œå‡ä¸ºé›¶åˆ™â€œæ­»å»â€ã€‚è®¾ç½®protocolï¼ŒæŒ‡çš„æ˜¯æ›´ä¸Šå±‚çš„åè®®ï¼Œè¿™é‡Œæ˜¯TCPã€‚æºåœ°å€å’Œç›®æ ‡åœ°å€ç”±ip_copy_addrsè®¾ç½®ã€‚æœ€åï¼Œè®¾ç½®optionsã€‚</p><p>ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå°±æ˜¯è°ƒç”¨ip_local_outå‘é€IPåŒ…ã€‚</p><pre><code>int ip_local_out(struct net *net, struct sock *sk, struct sk_buff *skb)\n{\n\tint err;\n\n\terr = __ip_local_out(net, sk, skb);\n\tif (likely(err == 1))\n\t\terr = dst_output(net, sk, skb);\n\n\treturn err;\n}\n\nint __ip_local_out(struct net *net, struct sock *sk, struct sk_buff *skb)\n{\n\tstruct iphdr *iph = ip_hdr(skb);\n\tiph-&gt;tot_len = htons(skb-&gt;len);\n\tskb-&gt;protocol = htons(ETH_P_IP);\n\n\treturn nf_hook(NFPROTO_IPV4, NF_INET_LOCAL_OUT,\n\t\t       net, sk, skb, NULL, skb_dst(skb)-&gt;dev,\n\t\t       dst_output);\n}\n</code></pre><p>ip_local_outå…ˆæ˜¯è°ƒç”¨__ip_local_outï¼Œç„¶åé‡Œé¢è°ƒç”¨äº†nf_hookã€‚è¿™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿnfçš„æ„æ€æ˜¯Netfilterï¼Œè¿™æ˜¯Linuxå†…æ ¸çš„ä¸€ä¸ªæœºåˆ¶ï¼Œç”¨äºåœ¨ç½‘ç»œå‘é€å’Œè½¬å‘çš„å…³é”®èŠ‚ç‚¹ä¸ŠåŠ ä¸Šhookå‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ä»¥æˆªè·æ•°æ®åŒ…ï¼Œå¯¹æ•°æ®åŒ…è¿›è¡Œå¹²é¢„ã€‚</p><p>ä¸€ä¸ªè‘—åçš„å®ç°ï¼Œå°±æ˜¯å†…æ ¸æ¨¡å—ip_tablesã€‚åœ¨ç”¨æˆ·æ€ï¼Œè¿˜æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åºiptablesï¼Œç”¨å‘½ä»¤è¡Œæ¥å¹²é¢„å†…æ ¸çš„è§„åˆ™ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/75/4d/75c8257049eed99499e802fcc2eacf4d.png?wh=2416*1423\" alt=\"\"></p><p>iptablesæœ‰è¡¨å’Œé“¾çš„æ¦‚å¿µï¼Œæœ€ç»ˆè¦çš„æ˜¯ä¸¤ä¸ªè¡¨ã€‚</p><p>filterè¡¨å¤„ç†è¿‡æ»¤åŠŸèƒ½ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªé“¾ã€‚</p><ul>\n<li>INPUTé“¾ï¼šè¿‡æ»¤æ‰€æœ‰ç›®æ ‡åœ°å€æ˜¯æœ¬æœºçš„æ•°æ®åŒ…</li>\n<li>FORWARDé“¾ï¼šè¿‡æ»¤æ‰€æœ‰è·¯è¿‡æœ¬æœºçš„æ•°æ®åŒ…</li>\n<li>OUTPUTé“¾ï¼šè¿‡æ»¤æ‰€æœ‰ç”±æœ¬æœºäº§ç”Ÿçš„æ•°æ®åŒ…</li>\n</ul><p>natè¡¨ä¸»è¦å¤„ç†ç½‘ç»œåœ°å€è½¬æ¢ï¼Œå¯ä»¥è¿›è¡ŒSNATï¼ˆæ”¹å˜æºåœ°å€ï¼‰ã€DNATï¼ˆæ”¹å˜ç›®æ ‡åœ°å€ï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªé“¾ã€‚</p><ul>\n<li>PREROUTINGé“¾ï¼šå¯ä»¥åœ¨æ•°æ®åŒ…åˆ°è¾¾æ—¶æ”¹å˜ç›®æ ‡åœ°å€</li>\n<li>OUTPUTé“¾ï¼šå¯ä»¥æ”¹å˜æœ¬åœ°äº§ç”Ÿçš„æ•°æ®åŒ…çš„ç›®æ ‡åœ°å€</li>\n<li>POSTROUTINGé“¾ï¼šåœ¨æ•°æ®åŒ…ç¦»å¼€æ—¶æ”¹å˜æ•°æ®åŒ…çš„æºåœ°å€</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/76/da/765e5431fe4b17f62b1b5712cc82abda.png?wh=2143*943\" alt=\"\"></p><p>åœ¨è¿™é‡Œï¼Œç½‘ç»œåŒ…é©¬ä¸Šå°±è¦å‘å‡ºå»äº†ï¼Œå› è€Œæ˜¯NF_INET_LOCAL_OUTï¼Œä¹Ÿå³ouputé“¾ï¼Œå¦‚æœç”¨æˆ·æ›¾ç»åœ¨iptablesé‡Œé¢å†™è¿‡æŸäº›è§„åˆ™ï¼Œå°±ä¼šåœ¨nf_hookè¿™ä¸ªå‡½æ•°é‡Œé¢èµ·ä½œç”¨ã€‚</p><p>ip_local_outå†è°ƒç”¨dst_outputï¼Œå°±æ˜¯çœŸæ­£çš„å‘é€æ•°æ®ã€‚</p><pre><code>/* Output packet to network from transport.  */\nstatic inline int dst_output(struct net *net, struct sock *sk, struct sk_buff *skb)\n{\n\treturn skb_dst(skb)-&gt;output(net, sk, skb);\n}\n</code></pre><p>è¿™é‡Œè°ƒç”¨çš„å°±æ˜¯struct rtableæˆå‘˜dstçš„ouputå‡½æ•°ã€‚åœ¨rt_dst_allocä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œoutputå‡½æ•°æŒ‡å‘çš„æ˜¯ip_outputã€‚</p><pre><code>int ip_output(struct net *net, struct sock *sk, struct sk_buff *skb)\n{\n\tstruct net_device *dev = skb_dst(skb)-&gt;dev;\n\tskb-&gt;dev = dev;\n\tskb-&gt;protocol = htons(ETH_P_IP);\n\n\treturn NF_HOOK_COND(NFPROTO_IPV4, NF_INET_POST_ROUTING,\n\t\t\t    net, sk, skb, NULL, dev,\n\t\t\t    ip_finish_output,\n\t\t\t    !(IPCB(skb)-&gt;flags &amp; IPSKB_REROUTED));\n}\n</code></pre><p>åœ¨ip_outputé‡Œé¢ï¼Œæˆ‘ä»¬åˆçœ‹åˆ°äº†ç†Ÿæ‚‰çš„NF_HOOKã€‚è¿™ä¸€æ¬¡æ˜¯NF_INET_POST_ROUTINGï¼Œä¹Ÿå³POSTROUTINGé“¾ï¼Œå¤„ç†å®Œä¹‹åï¼Œè°ƒç”¨ip_finish_outputã€‚</p><h2>è§£æip_finish_outputå‡½æ•°</h2><p>ä»ip_finish_outputå‡½æ•°å¼€å§‹ï¼Œå‘é€ç½‘ç»œåŒ…çš„é€»è¾‘ç”±ç¬¬ä¸‰å±‚åˆ°è¾¾ç¬¬äºŒå±‚ã€‚ip_finish_outputæœ€ç»ˆè°ƒç”¨ip_finish_output2ã€‚</p><pre><code>static int ip_finish_output2(struct net *net, struct sock *sk, struct sk_buff *skb)\n{\n\tstruct dst_entry *dst = skb_dst(skb);\n\tstruct rtable *rt = (struct rtable *)dst;\n\tstruct net_device *dev = dst-&gt;dev;\n\tunsigned int hh_len = LL_RESERVED_SPACE(dev);\n\tstruct neighbour *neigh;\n\tu32 nexthop;\n......\n\tnexthop = (__force u32) rt_nexthop(rt, ip_hdr(skb)-&gt;daddr);\n\tneigh = __ipv4_neigh_lookup_noref(dev, nexthop);\n\tif (unlikely(!neigh))\n\t\tneigh = __neigh_create(&amp;arp_tbl, &amp;nexthop, dev, false);\n\tif (!IS_ERR(neigh)) {\n\t\tint res;\n\t\tsock_confirm_neigh(skb, neigh);\n\t\tres = neigh_output(neigh, skb);\n\t\treturn res;\n\t}\n......\n}\n</code></pre><p>åœ¨ip_finish_output2ä¸­ï¼Œå…ˆæ‰¾åˆ°struct rtableè·¯ç”±è¡¨é‡Œé¢çš„ä¸‹ä¸€è·³ï¼Œä¸‹ä¸€è·³ä¸€å®šå’Œæœ¬æœºåœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­ï¼Œå¯ä»¥é€šè¿‡äºŒå±‚è¿›è¡Œé€šä¿¡ï¼Œå› è€Œé€šè¿‡__ipv4_neigh_lookup_norefï¼ŒæŸ¥æ‰¾å¦‚ä½•é€šè¿‡äºŒå±‚è®¿é—®ä¸‹ä¸€è·³ã€‚</p><pre><code>static inline struct neighbour *__ipv4_neigh_lookup_noref(struct net_device *dev, u32 key)\n{\n\treturn ___neigh_lookup_noref(&amp;arp_tbl, neigh_key_eq32, arp_hashfn, &amp;key, dev);\n}\n</code></pre><p>__ipv4_neigh_lookup_norefæ˜¯ä»æœ¬åœ°çš„ARPè¡¨ä¸­æŸ¥æ‰¾ä¸‹ä¸€è·³çš„MACåœ°å€ã€‚ARPè¡¨çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>struct neigh_table arp_tbl = {\n    .family     = AF_INET,\n    .key_len    = 4,    \n    .protocol   = cpu_to_be16(ETH_P_IP),\n    .hash       = arp_hash,\n    .key_eq     = arp_key_eq,\n    .constructor    = arp_constructor,\n    .proxy_redo = parp_redo,\n    .id     = &quot;arp_cache&quot;,\n......\n    .gc_interval    = 30 * HZ, \n    .gc_thresh1 = 128,  \n    .gc_thresh2 = 512,  \n    .gc_thresh3 = 1024,\n};\n</code></pre><p>å¦‚æœåœ¨ARPè¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„é¡¹ï¼Œåˆ™è°ƒç”¨__neigh_createè¿›è¡Œåˆ›å»ºã€‚</p><pre><code>struct neighbour *__neigh_create(struct neigh_table *tbl, const void *pkey, struct net_device *dev, bool want_ref)\n{\n    u32 hash_val;\n    int key_len = tbl-&gt;key_len;\n    int error;\n    struct neighbour *n1, *rc, *n = neigh_alloc(tbl, dev);\n    struct neigh_hash_table *nht;\n\n    memcpy(n-&gt;primary_key, pkey, key_len);\n    n-&gt;dev = dev;\n    dev_hold(dev);\n\n    /* Protocol specific setup. */\n    if (tbl-&gt;constructor &amp;&amp; (error = tbl-&gt;constructor(n)) &lt; 0) {\n......\n    }\n......\n    if (atomic_read(&amp;tbl-&gt;entries) &gt; (1 &lt;&lt; nht-&gt;hash_shift))\n        nht = neigh_hash_grow(tbl, nht-&gt;hash_shift + 1);\n\n    hash_val = tbl-&gt;hash(pkey, dev, nht-&gt;hash_rnd) &gt;&gt; (32 - nht-&gt;hash_shift);\n\n    for (n1 = rcu_dereference_protected(nht-&gt;hash_buckets[hash_val],\n                        lockdep_is_held(&amp;tbl-&gt;lock));\n         n1 != NULL;\n         n1 = rcu_dereference_protected(n1-&gt;next,\n            lockdep_is_held(&amp;tbl-&gt;lock))) {\n        if (dev == n1-&gt;dev &amp;&amp; !memcmp(n1-&gt;primary_key, pkey, key_len)) {\n            if (want_ref)\n                neigh_hold(n1);\n            rc = n1;\n            goto out_tbl_unlock;\n        }\n    }\n......\n    rcu_assign_pointer(n-&gt;next,\n               rcu_dereference_protected(nht-&gt;hash_buckets[hash_val],\n                             lockdep_is_held(&amp;tbl-&gt;lock)));\n    rcu_assign_pointer(nht-&gt;hash_buckets[hash_val], n);\n......\n}\n</code></pre><p>__neigh_createå…ˆè°ƒç”¨neigh_allocï¼Œåˆ›å»ºä¸€ä¸ªstruct neighbourç»“æ„ï¼Œç”¨äºç»´æŠ¤MACåœ°å€å’ŒARPç›¸å…³çš„ä¿¡æ¯ã€‚è¿™ä¸ªåå­—ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå¤§å®¶éƒ½æ˜¯åœ¨ä¸€ä¸ªå±€åŸŸç½‘é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡MACåœ°å€è®¿é—®åˆ°ï¼Œå½“ç„¶æ˜¯é‚»å±…äº†ã€‚</p><pre><code>static struct neighbour *neigh_alloc(struct neigh_table *tbl, struct net_device *dev)\n{\n\tstruct neighbour *n = NULL;\n\tunsigned long now = jiffies;\n\tint entries;\n......\n\tn = kzalloc(tbl-&gt;entry_size + dev-&gt;neigh_priv_len, GFP_ATOMIC);\n\tif (!n)\n\t\tgoto out_entries;\n\n\t__skb_queue_head_init(&amp;n-&gt;arp_queue);\n\trwlock_init(&amp;n-&gt;lock);\n\tseqlock_init(&amp;n-&gt;ha_lock);\n\tn-&gt;updated\t  = n-&gt;used = now;\n\tn-&gt;nud_state\t  = NUD_NONE;\n\tn-&gt;output\t  = neigh_blackhole;\n\tseqlock_init(&amp;n-&gt;hh.hh_lock);\n\tn-&gt;parms\t  = neigh_parms_clone(&amp;tbl-&gt;parms);\n\tsetup_timer(&amp;n-&gt;timer, neigh_timer_handler, (unsigned long)n);\n\n\tNEIGH_CACHE_STAT_INC(tbl, allocs);\n\tn-&gt;tbl\t\t  = tbl;\n\trefcount_set(&amp;n-&gt;refcnt, 1);\n\tn-&gt;dead\t\t  = 1;\n......\n}\n</code></pre><p>åœ¨neigh_allocä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ†é…ä¸€ä¸ªstruct neighbourç»“æ„å¹¶ä¸”åˆå§‹åŒ–ã€‚è¿™é‡Œé¢æ¯”è¾ƒé‡è¦çš„æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯arp_queueï¼Œæ‰€ä»¥ä¸Šå±‚æƒ³é€šè¿‡ARPè·å–MACåœ°å€çš„ä»»åŠ¡ï¼Œéƒ½æ”¾åœ¨è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢ã€‚å¦ä¸€ä¸ªæ˜¯timerå®šæ—¶å™¨ï¼Œæˆ‘ä»¬è®¾ç½®æˆï¼Œè¿‡ä¸€æ®µæ—¶é—´å°±è°ƒç”¨neigh_timer_handlerï¼Œæ¥å¤„ç†è¿™äº›ARPä»»åŠ¡ã€‚</p><p>__neigh_createç„¶åè°ƒç”¨äº†arp_tblçš„constructorå‡½æ•°ï¼Œä¹Ÿå³è°ƒç”¨äº†arp_constructorï¼Œåœ¨è¿™é‡Œé¢å®šä¹‰äº†ARPçš„æ“ä½œarp_hh_opsã€‚</p><pre><code>static int arp_constructor(struct neighbour *neigh)\n{\n\t__be32 addr = *(__be32 *)neigh-&gt;primary_key;\n\tstruct net_device *dev = neigh-&gt;dev;\n\tstruct in_device *in_dev;\n\tstruct neigh_parms *parms;\n......\n\tneigh-&gt;type = inet_addr_type_dev_table(dev_net(dev), dev, addr);\n\n\tparms = in_dev-&gt;arp_parms;\n\t__neigh_parms_put(neigh-&gt;parms);\n\tneigh-&gt;parms = neigh_parms_clone(parms);\n......\n\tneigh-&gt;ops = &amp;arp_hh_ops;\n......\n\tneigh-&gt;output = neigh-&gt;ops-&gt;output;\n......\n}\n\nstatic const struct neigh_ops arp_hh_ops = {\n\t.family =\t\tAF_INET,\n\t.solicit =\t\tarp_solicit,\n\t.error_report =\t\tarp_error_report,\n\t.output =\t\tneigh_resolve_output,\n\t.connected_output =\tneigh_resolve_output,\n};\n</code></pre><p>__neigh_createæœ€åæ˜¯å°†åˆ›å»ºçš„struct neighbourç»“æ„æ”¾å…¥ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œä»é‡Œé¢çš„ä»£ç é€»è¾‘æ¯”è¾ƒå®¹æ˜“çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„åŠ é“¾è¡¨çš„é“¾å¼å“ˆå¸Œè¡¨ï¼Œå…ˆè®¡ç®—å‡ºå“ˆå¸Œå€¼hash_valï¼Œå¾—åˆ°ç›¸åº”çš„é“¾è¡¨ï¼Œç„¶åå¾ªç¯è¿™ä¸ªé“¾è¡¨æ‰¾åˆ°å¯¹åº”çš„é¡¹ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±åœ¨æœ€åæ’å…¥ä¸€é¡¹ã€‚</p><p>æˆ‘ä»¬å›åˆ°ip_finish_output2ï¼Œåœ¨__neigh_createä¹‹åï¼Œä¼šè°ƒç”¨neigh_outputå‘é€ç½‘ç»œåŒ…ã€‚</p><pre><code>static inline int neigh_output(struct neighbour *n, struct sk_buff *skb)\n{\n......\n\treturn n-&gt;output(n, skb);\n}\n\n</code></pre><p>æŒ‰ç…§ä¸Šé¢å¯¹äºstruct neighbourçš„æ“ä½œå‡½æ•°arp_hh_ops çš„å®šä¹‰ï¼Œoutputè°ƒç”¨çš„æ˜¯neigh_resolve_outputã€‚</p><pre><code>int neigh_resolve_output(struct neighbour *neigh, struct sk_buff *skb)\n{\n\tif (!neigh_event_send(neigh, skb)) {\n......\n\t\trc = dev_queue_xmit(skb);\n\t}\n......\n}\n</code></pre><p>åœ¨neigh_resolve_outputé‡Œé¢ï¼Œé¦–å…ˆneigh_event_sendè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œçœ‹èƒ½å¦æ¿€æ´»ARPã€‚</p><pre><code>int __neigh_event_send(struct neighbour *neigh, struct sk_buff *skb)\n{\n\tint rc;\n\tbool immediate_probe = false;\n\n\tif (!(neigh-&gt;nud_state &amp; (NUD_STALE | NUD_INCOMPLETE))) {\n\t\tif (NEIGH_VAR(neigh-&gt;parms, MCAST_PROBES) +\n\t\t    NEIGH_VAR(neigh-&gt;parms, APP_PROBES)) {\n\t\t\tunsigned long next, now = jiffies;\n\n\t\t\tatomic_set(&amp;neigh-&gt;probes,\n\t\t\t\t   NEIGH_VAR(neigh-&gt;parms, UCAST_PROBES));\n\t\t\tneigh-&gt;nud_state     = NUD_INCOMPLETE;\n\t\t\tneigh-&gt;updated = now;\n\t\t\tnext = now + max(NEIGH_VAR(neigh-&gt;parms, RETRANS_TIME),\n\t\t\t\t\t HZ/2);\n\t\t\tneigh_add_timer(neigh, next);\n\t\t\timmediate_probe = true;\n\t\t} \n......\n\t} else if (neigh-&gt;nud_state &amp; NUD_STALE) {\n\t\tneigh_dbg(2, &quot;neigh %p is delayed\\n&quot;, neigh);\n\t\tneigh-&gt;nud_state = NUD_DELAY;\n\t\tneigh-&gt;updated = jiffies;\n\t\tneigh_add_timer(neigh, jiffies +\n\t\t\t\tNEIGH_VAR(neigh-&gt;parms, DELAY_PROBE_TIME));\n\t}\n\n\tif (neigh-&gt;nud_state == NUD_INCOMPLETE) {\n\t\tif (skb) {\n.......\n\t\t\t__skb_queue_tail(&amp;neigh-&gt;arp_queue, skb);\n\t\t\tneigh-&gt;arp_queue_len_Bytes += skb-&gt;truesize;\n\t\t}\n\t\trc = 1;\n\t}\nout_unlock_bh:\n\tif (immediate_probe)\n\t\tneigh_probe(neigh);\n.......\n}\n</code></pre><p>åœ¨__neigh_event_sendä¸­ï¼Œæ¿€æ´»ARPåˆ†ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æƒ…å†µæ˜¯é©¬ä¸Šæ¿€æ´»ï¼Œä¹Ÿå³immediate_probeã€‚å¦ä¸€ç§æƒ…å†µæ˜¯å»¶è¿Ÿæ¿€æ´»åˆ™ä»…ä»…è®¾ç½®ä¸€ä¸ªtimerã€‚ç„¶åå°†ARPåŒ…æ”¾åœ¨arp_queueä¸Šã€‚å¦‚æœé©¬ä¸Šæ¿€æ´»ï¼Œå°±ç›´æ¥è°ƒç”¨neigh_probeï¼›å¦‚æœå»¶è¿Ÿæ¿€æ´»ï¼Œåˆ™å®šæ—¶å™¨åˆ°äº†å°±ä¼šè§¦å‘neigh_timer_handlerï¼Œåœ¨è¿™é‡Œé¢è¿˜æ˜¯ä¼šè°ƒç”¨neigh_probeã€‚</p><p>æˆ‘ä»¬å°±æ¥çœ‹neigh_probeçš„å®ç°ï¼Œåœ¨è¿™é‡Œé¢ä¼šä»arp_queueä¸­æ‹¿å‡ºARPåŒ…æ¥ï¼Œç„¶åè°ƒç”¨struct neighbourçš„solicitæ“ä½œã€‚</p><pre><code>static void neigh_probe(struct neighbour *neigh)\n        __releases(neigh-&gt;lock)\n{\n        struct sk_buff *skb = skb_peek_tail(&amp;neigh-&gt;arp_queue);\n......\n        if (neigh-&gt;ops-&gt;solicit)\n                neigh-&gt;ops-&gt;solicit(neigh, skb);\n......\n}\n</code></pre><p>æŒ‰ç…§ä¸Šé¢å¯¹äºstruct neighbourçš„æ“ä½œå‡½æ•°arp_hh_ops çš„å®šä¹‰ï¼Œsolicitè°ƒç”¨çš„æ˜¯arp_solicitï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹äºarp_send_dstçš„è°ƒç”¨ï¼Œåˆ›å»ºå¹¶å‘é€ä¸€ä¸ªarpåŒ…ï¼Œå¾—åˆ°ç»“æœæ”¾åœ¨struct dst_entryé‡Œé¢ã€‚</p><pre><code>static void arp_send_dst(int type, int ptype, __be32 dest_ip,\n                         struct net_device *dev, __be32 src_ip,\n                         const unsigned char *dest_hw,\n                         const unsigned char *src_hw,\n                         const unsigned char *target_hw,\n                         struct dst_entry *dst)\n{\n        struct sk_buff *skb;\n......\n        skb = arp_create(type, ptype, dest_ip, dev, src_ip,\n                         dest_hw, src_hw, target_hw);\n......\n        skb_dst_set(skb, dst_clone(dst));\n        arp_xmit(skb);\n}\n\n</code></pre><p>æˆ‘ä»¬å›åˆ°neigh_resolve_outputä¸­ï¼Œå½“ARPå‘é€å®Œæ¯•ï¼Œå°±å¯ä»¥è°ƒç”¨dev_queue_xmitå‘é€äºŒå±‚ç½‘ç»œåŒ…äº†ã€‚</p><pre><code>/**\n *\t__dev_queue_xmit - transmit a buffer\n *\t@skb: buffer to transmit\n *\t@accel_priv: private data used for L2 forwarding offload\n *\n *\tQueue a buffer for transmission to a network device. \n */\nstatic int __dev_queue_xmit(struct sk_buff *skb, void *accel_priv)\n{\n\tstruct net_device *dev = skb-&gt;dev;\n\tstruct netdev_queue *txq;\n\tstruct Qdisc *q;\n......\n\ttxq = netdev_pick_tx(dev, skb, accel_priv);\n\tq = rcu_dereference_bh(txq-&gt;qdisc);\n\n\tif (q-&gt;enqueue) {\n\t\trc = __dev_xmit_skb(skb, q, dev, txq);\n\t\tgoto out;\n\t}\n......\n}\n</code></pre><p>å°±åƒå’±ä»¬åœ¨è®²è¿°ç¡¬ç›˜å—è®¾å¤‡çš„æ—¶å€™è®²è¿‡ï¼Œæ¯ä¸ªå—è®¾å¤‡éƒ½æœ‰é˜Ÿåˆ—ï¼Œç”¨äºå°†å†…æ ¸çš„æ•°æ®æ”¾åˆ°é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åè®¾å¤‡é©±åŠ¨ä»é˜Ÿåˆ—é‡Œé¢å–å‡ºåï¼Œå°†æ•°æ®æ ¹æ®å…·ä½“è®¾å¤‡çš„ç‰¹æ€§å‘é€ç»™è®¾å¤‡ã€‚</p><p>ç½‘ç»œè®¾å¤‡ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå¯¹äºå‘é€æ¥è¯´ï¼Œæœ‰ä¸€ä¸ªå‘é€é˜Ÿåˆ—struct netdev_queue *txqã€‚</p><p>è¿™é‡Œè¿˜æœ‰å¦ä¸€ä¸ªå˜é‡å«åšstruct Qdiscï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬åœ¨ä¸€å°Linuxæœºå™¨ä¸Šè¿è¡Œip addrï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°å¯¹äºä¸€ä¸ªç½‘å¡ï¼Œéƒ½æœ‰ä¸‹é¢çš„è¾“å‡ºã€‚</p><pre><code># ip addr\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1400 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether fa:16:3e:75:99:08 brd ff:ff:ff:ff:ff:ff\n    inet 10.173.32.47/21 brd 10.173.39.255 scope global noprefixroute dynamic eth0\n       valid_lft 67104sec preferred_lft 67104sec\n    inet6 fe80::f816:3eff:fe75:9908/64 scope link \n       valid_lft forever preferred_lft forever\n</code></pre><p>è¿™é‡Œé¢æœ‰ä¸ªå…³é”®å­—qdisc pfifo_fastæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿqdiscå…¨ç§°æ˜¯queueing disciplineï¼Œä¸­æ–‡å«æ’é˜Ÿè§„åˆ™ã€‚å†…æ ¸å¦‚æœéœ€è¦é€šè¿‡æŸä¸ªç½‘ç»œæ¥å£å‘é€æ•°æ®åŒ…ï¼Œéƒ½éœ€è¦æŒ‰ç…§ä¸ºè¿™ä¸ªæ¥å£é…ç½®çš„qdiscï¼ˆæ’é˜Ÿè§„åˆ™ï¼‰æŠŠæ•°æ®åŒ…åŠ å…¥é˜Ÿåˆ—ã€‚</p><p>æœ€ç®€å•çš„qdiscæ˜¯pfifoï¼Œå®ƒä¸å¯¹è¿›å…¥çš„æ•°æ®åŒ…åšä»»ä½•çš„å¤„ç†ï¼Œæ•°æ®åŒ…é‡‡ç”¨å…ˆå…¥å…ˆå‡ºçš„æ–¹å¼é€šè¿‡é˜Ÿåˆ—ã€‚pfifo_fastç¨å¾®å¤æ‚ä¸€äº›ï¼Œå®ƒçš„é˜Ÿåˆ—åŒ…æ‹¬ä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰ã€‚åœ¨æ¯ä¸ªæ³¢æ®µé‡Œé¢ï¼Œä½¿ç”¨å…ˆè¿›å…ˆå‡ºè§„åˆ™ã€‚</p><p>ä¸‰ä¸ªæ³¢æ®µçš„ä¼˜å…ˆçº§ä¹Ÿä¸ç›¸åŒã€‚band 0çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œband 2çš„æœ€ä½ã€‚å¦‚æœband 0é‡Œé¢æœ‰æ•°æ®åŒ…ï¼Œç³»ç»Ÿå°±ä¸ä¼šå¤„ç†band 1é‡Œé¢çš„æ•°æ®åŒ…ï¼Œband 1å’Œband 2ä¹‹é—´ä¹Ÿæ˜¯ä¸€æ ·ã€‚</p><p>æ•°æ®åŒ…æ˜¯æŒ‰ç…§æœåŠ¡ç±»å‹ï¼ˆType of Serviceï¼ŒTOSï¼‰è¢«åˆ†é…åˆ°ä¸‰ä¸ªæ³¢æ®µé‡Œé¢çš„ã€‚TOSæ˜¯IPå¤´é‡Œé¢çš„ä¸€ä¸ªå­—æ®µï¼Œä»£è¡¨äº†å½“å‰çš„åŒ…æ˜¯é«˜ä¼˜å…ˆçº§çš„ï¼Œè¿˜æ˜¯ä½ä¼˜å…ˆçº§çš„ã€‚</p><p>pfifo_faståˆ†ä¸ºä¸‰ä¸ªå…ˆå…¥å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬èƒ½ç§°ä¸ºä¸‰ä¸ªBandã€‚æ ¹æ®ç½‘ç»œåŒ…é‡Œé¢çš„TOSï¼Œçœ‹è¿™ä¸ªåŒ…åˆ°åº•åº”è¯¥è¿›å…¥å“ªä¸ªé˜Ÿåˆ—ã€‚TOSæ€»å…±å››ä½ï¼Œæ¯ä¸€ä½è¡¨ç¤ºçš„æ„æ€ä¸åŒï¼Œæ€»å…±åå…­ç§ç±»å‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ab/d9/ab6af2f9e1a64868636080a05cfde0d9.png?wh=1948*853\" alt=\"\"></p><p>é€šè¿‡å‘½ä»¤è¡Œtc qdisc show dev eth0ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å‡ºç»“æœpriomapï¼Œä¹Ÿæ˜¯åå…­ä¸ªæ•°å­—ã€‚åœ¨0åˆ°2ä¹‹é—´ï¼Œå’ŒTOSçš„åå…­ç§ç±»å‹å¯¹åº”èµ·æ¥ã€‚ä¸åŒçš„TOSå¯¹åº”ä¸åŒçš„é˜Ÿåˆ—ã€‚å…¶ä¸­Band 0ä¼˜å…ˆçº§æœ€é«˜ï¼Œå‘é€å®Œæ¯•åæ‰è½®åˆ°Band 1å‘é€ï¼Œæœ€åæ‰æ˜¯Band 2ã€‚</p><pre><code># tc qdisc show dev eth0\nqdisc pfifo_fast 0: root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œ__dev_xmit_skbå¼€å§‹è¿›è¡Œç½‘ç»œåŒ…å‘é€ã€‚</p><pre><code>static inline int __dev_xmit_skb(struct sk_buff *skb, struct Qdisc *q,\n                 struct net_device *dev,\n                 struct netdev_queue *txq)\n{\n......\n    rc = q-&gt;enqueue(skb, q, &amp;to_free) &amp; NET_XMIT_MASK;\n    if (qdisc_run_begin(q)) {\n......\n        __qdisc_run(q);\n    }\n......    \n}\n\nvoid __qdisc_run(struct Qdisc *q)\n{\n    int quota = dev_tx_weight;\n    int packets;\n     while (qdisc_restart(q, &amp;packets)) {\n        /*\n         * Ordered by possible occurrence: Postpone processing if\n         * 1. we've exceeded packet quota\n         * 2. another process needs the CPU;\n         */\n        quota -= packets;\n        if (quota &lt;= 0 || need_resched()) {\n            __netif_schedule(q);\n            break;\n        }\n     }\n     qdisc_run_end(q);\n}\n</code></pre><p>__dev_xmit_skbä¼šå°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ï¼Œç„¶åè°ƒç”¨__qdisc_runå¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚qdisc_restartç”¨äºæ•°æ®çš„å‘é€ã€‚æ ¹æ®æ³¨é‡Šä¸­çš„è¯´æ³•ï¼Œqdiscçš„å¦ä¸€ä¸ªåŠŸèƒ½æ˜¯ç”¨äºæ§åˆ¶ç½‘ç»œåŒ…çš„å‘é€é€Ÿåº¦ï¼Œå› è€Œå¦‚æœè¶…è¿‡é€Ÿåº¦ï¼Œå°±éœ€è¦é‡æ–°è°ƒåº¦ï¼Œåˆ™ä¼šè°ƒç”¨__netif_scheduleã€‚</p><pre><code>static void __netif_reschedule(struct Qdisc *q)\n{\n    struct softnet_data *sd;\n    unsigned long flags;\n    local_irq_save(flags);\n    sd = this_cpu_ptr(&amp;softnet_data);\n    q-&gt;next_sched = NULL;\n    *sd-&gt;output_queue_tailp = q;\n    sd-&gt;output_queue_tailp = &amp;q-&gt;next_sched;\n    raise_softirq_irqoff(NET_TX_SOFTIRQ);\n    local_irq_restore(flags);\n}\n</code></pre><p>__netif_scheduleä¼šè°ƒç”¨__netif_rescheduleï¼Œå‘èµ·ä¸€ä¸ªè½¯ä¸­æ–­NET_TX_SOFTIRQã€‚å’±ä»¬è®²è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ—¶å€™è®²è¿‡ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºå¤„ç†ä¸­æ–­ï¼Œåˆ†ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä¸€ä¸ªæ˜¯å±è”½ä¸­æ–­çš„å…³é”®å¤„ç†é€»è¾‘ï¼Œä¸€ä¸ªæ˜¯å»¶è¿Ÿå¤„ç†é€»è¾‘ã€‚å½“æ—¶è¯´å·¥ä½œé˜Ÿåˆ—æ˜¯å»¶è¿Ÿå¤„ç†é€»è¾‘çš„å¤„ç†æ–¹æ¡ˆï¼Œè½¯ä¸­æ–­ä¹Ÿæ˜¯ä¸€ç§æ–¹æ¡ˆã€‚</p><p>åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰è½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ã€‚ä¾‹å¦‚ï¼ŒNET_TX_SOFTIRQçš„å¤„ç†å‡½æ•°æ˜¯net_tx_actionï¼Œç”¨äºå‘é€ç½‘ç»œåŒ…ã€‚è¿˜æœ‰ä¸€ä¸ªNET_RX_SOFTIRQçš„å¤„ç†å‡½æ•°æ˜¯net_rx_actionï¼Œç”¨äºæ¥æ”¶ç½‘ç»œåŒ…ã€‚æ¥æ”¶ç½‘ç»œåŒ…çš„è¿‡ç¨‹å’±ä»¬ä¸‹ä¸€èŠ‚è§£æã€‚</p><pre><code>open_softirq(NET_TX_SOFTIRQ, net_tx_action);\nopen_softirq(NET_RX_SOFTIRQ, net_rx_action);\n\n</code></pre><p>è¿™é‡Œæˆ‘ä»¬æ¥è§£æä¸€ä¸‹net_tx_actionã€‚</p><pre><code>static __latent_entropy void net_tx_action(struct softirq_action *h)\n{\n    struct softnet_data *sd = this_cpu_ptr(&amp;softnet_data);\n......\n    if (sd-&gt;output_queue) {\n        struct Qdisc *head;\n\n        local_irq_disable();\n        head = sd-&gt;output_queue;\n        sd-&gt;output_queue = NULL;\n        sd-&gt;output_queue_tailp = &amp;sd-&gt;output_queue;\n        local_irq_enable();\n\n        while (head) {\n            struct Qdisc *q = head;\n            spinlock_t *root_lock;\n\n            head = head-&gt;next_sched;\n......\n            qdisc_run(q);\n        }\n    }\n}\n</code></pre><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œnet_tx_actionè¿˜æ˜¯è°ƒç”¨äº†qdisc_runï¼Œè¿˜æ˜¯ä¼šè°ƒç”¨__qdisc_runï¼Œç„¶åè°ƒç”¨qdisc_restartå‘é€ç½‘ç»œåŒ…ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹qdisc_restartçš„å®ç°ã€‚</p><pre><code>static inline int qdisc_restart(struct Qdisc *q, int *packets)\n{\n        struct netdev_queue *txq;\n        struct net_device *dev;\n        spinlock_t *root_lock;\n        struct sk_buff *skb;\n        bool validate;\n\n        /* Dequeue packet */\n        skb = dequeue_skb(q, &amp;validate, packets);\n        if (unlikely(!skb))\n                return 0;\n\n        root_lock = qdisc_lock(q);\n        dev = qdisc_dev(q);\n        txq = skb_get_tx_queue(dev, skb);\n\n        return sch_direct_xmit(skb, q, dev, txq, root_lock, validate);\n}\n</code></pre><p>qdisc_restartå°†ç½‘ç»œåŒ…ä»Qdiscçš„é˜Ÿåˆ—ä¸­æ‹¿ä¸‹æ¥ï¼Œç„¶åè°ƒç”¨sch_direct_xmitè¿›è¡Œå‘é€ã€‚</p><pre><code>int sch_direct_xmit(struct sk_buff *skb, struct Qdisc *q,\n            struct net_device *dev, struct netdev_queue *txq,\n            spinlock_t *root_lock, bool validate)\n{\n    int ret = NETDEV_TX_BUSY;\n\n    if (likely(skb)) {\n        if (!netif_xmit_frozen_or_stopped(txq))\n            skb = dev_hard_start_xmit(skb, dev, txq, &amp;ret); \n    } \n......\n    if (dev_xmit_complete(ret)) {\n        /* Driver sent out skb successfully or skb was consumed */\n        ret = qdisc_qlen(q);\n    } else {\n        /* Driver returned NETDEV_TX_BUSY - requeue skb */\n        ret = dev_requeue_skb(skb, q);\n    }   \n......\n}\n</code></pre><p>åœ¨sch_direct_xmitä¸­ï¼Œè°ƒç”¨dev_hard_start_xmitè¿›è¡Œå‘é€ï¼Œå¦‚æœå‘é€ä¸æˆåŠŸï¼Œä¼šè¿”å›NETDEV_TX_BUSYã€‚è¿™è¯´æ˜ç½‘ç»œå¡å¾ˆå¿™ï¼Œäºæ˜¯å°±è°ƒç”¨dev_requeue_skbï¼Œé‡æ–°æ”¾å…¥é˜Ÿåˆ—ã€‚</p><pre><code>struct sk_buff *dev_hard_start_xmit(struct sk_buff *first, struct net_device *dev, struct netdev_queue *txq, int *ret) \n{\n    struct sk_buff *skb = first;\n    int rc = NETDEV_TX_OK;\n\n    while (skb) {\n        struct sk_buff *next = skb-&gt;next;\n        rc = xmit_one(skb, dev, txq, next != NULL);\n        skb = next; \n        if (netif_xmit_stopped(txq) &amp;&amp; skb) {\n            rc = NETDEV_TX_BUSY;\n            break;      \n        }       \n    }   \n......\n}\n</code></pre><p>åœ¨dev_hard_start_xmitä¸­ï¼Œæ˜¯ä¸€ä¸ªwhileå¾ªç¯ã€‚æ¯æ¬¡åœ¨é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªsk_buffï¼Œè°ƒç”¨xmit_oneå‘é€ã€‚</p><p>æ¥ä¸‹æ¥çš„è°ƒç”¨é“¾ä¸ºï¼šxmit_one-&gt;netdev_start_xmit-&gt;__netdev_start_xmitã€‚</p><pre><code>static inline netdev_tx_t __netdev_start_xmit(const struct net_device_ops *ops, struct sk_buff *skb, struct net_device *dev, bool more)          \n{\n    skb-&gt;xmit_more = more ? 1 : 0;\n    return ops-&gt;ndo_start_xmit(skb, dev);\n}\n</code></pre><p>è¿™ä¸ªæ—¶å€™ï¼Œå·²ç»åˆ°äº†è®¾å¤‡é©±åŠ¨å±‚äº†ã€‚æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œdrivers/net/ethernet/intel/ixgb/ixgb_main.cé‡Œé¢æœ‰å¯¹äºè¿™ä¸ªç½‘å¡çš„æ“ä½œçš„å®šä¹‰ã€‚</p><pre><code>static const struct net_device_ops ixgb_netdev_ops = {\n        .ndo_open               = ixgb_open,\n        .ndo_stop               = ixgb_close,\n        .ndo_start_xmit         = ixgb_xmit_frame,\n        .ndo_set_rx_mode        = ixgb_set_multi,\n        .ndo_validate_addr      = eth_validate_addr,\n        .ndo_set_mac_address    = ixgb_set_mac,\n        .ndo_change_mtu         = ixgb_change_mtu,\n        .ndo_tx_timeout         = ixgb_tx_timeout,\n        .ndo_vlan_rx_add_vid    = ixgb_vlan_rx_add_vid,\n        .ndo_vlan_rx_kill_vid   = ixgb_vlan_rx_kill_vid,\n        .ndo_fix_features       = ixgb_fix_features,\n        .ndo_set_features       = ixgb_set_features,\n};\n</code></pre><p>åœ¨è¿™é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹äºndo_start_xmitçš„å®šä¹‰ï¼Œè°ƒç”¨ixgb_xmit_frameã€‚</p><pre><code>static netdev_tx_t\nixgb_xmit_frame(struct sk_buff *skb, struct net_device *netdev)\n{\n    struct ixgb_adapter *adapter = netdev_priv(netdev);\n......\n    if (count) {\n        ixgb_tx_queue(adapter, count, vlan_id, tx_flags);\n        /* Make sure there is space in the ring for the next send. */\n        ixgb_maybe_stop_tx(netdev, &amp;adapter-&gt;tx_ring, DESC_NEEDED);\n\n    } \n......\n    return NETDEV_TX_OK;\n}\n</code></pre><p>åœ¨ixgb_xmit_frameä¸­ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™ä¸ªç½‘å¡å¯¹åº”çš„é€‚é…å™¨ï¼Œç„¶åå°†å…¶æ”¾å…¥ç¡¬ä»¶ç½‘å¡çš„é˜Ÿåˆ—ä¸­ã€‚</p><p>è‡³æ­¤ï¼Œæ•´ä¸ªå‘é€æ‰ç®—ç»“æŸã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬ç»§ç»­è§£æäº†å‘é€ä¸€ä¸ªç½‘ç»œåŒ…çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ•´ä¸ªè¿‡ç¨‹çš„å›¾ç”»åœ¨äº†ä¸‹é¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/79/6f/79cc42f3163d159a66e163c006d9f36f.png?wh=6064*7303\" alt=\"\"></p><p>è¿™ä¸ªè¿‡ç¨‹åˆ†æˆå‡ ä¸ªå±‚æ¬¡ã€‚</p><ul>\n<li>VFSå±‚ï¼šwriteç³»ç»Ÿè°ƒç”¨æ‰¾åˆ°struct fileï¼Œæ ¹æ®é‡Œé¢çš„file_operationsçš„å®šä¹‰ï¼Œè°ƒç”¨sock_write_iterå‡½æ•°ã€‚sock_write_iterå‡½æ•°è°ƒç”¨sock_sendmsgå‡½æ•°ã€‚</li>\n<li>Socketå±‚ï¼šä»struct fileé‡Œé¢çš„private_dataå¾—åˆ°struct socketï¼Œæ ¹æ®é‡Œé¢opsçš„å®šä¹‰ï¼Œè°ƒç”¨inet_sendmsgå‡½æ•°ã€‚</li>\n<li>Sockå±‚ï¼šä»struct socketé‡Œé¢çš„skå¾—åˆ°struct sockï¼Œæ ¹æ®é‡Œé¢sk_protçš„å®šä¹‰ï¼Œè°ƒç”¨tcp_sendmsgå‡½æ•°ã€‚</li>\n<li>TCPå±‚ï¼štcp_sendmsgå‡½æ•°ä¼šè°ƒç”¨tcp_write_xmitå‡½æ•°ï¼Œtcp_write_xmitå‡½æ•°ä¼šè°ƒç”¨tcp_transmit_skbï¼Œåœ¨è¿™é‡Œå®ç°äº†TCPå±‚é¢å‘è¿æ¥çš„é€»è¾‘ã€‚</li>\n<li>IPå±‚ï¼šæ‰©å±•struct sockï¼Œå¾—åˆ°struct inet_connection_sockï¼Œæ ¹æ®é‡Œé¢icsk_af_opsçš„å®šä¹‰ï¼Œè°ƒç”¨ip_queue_xmitå‡½æ•°ã€‚</li>\n<li>IPå±‚ï¼šip_route_output_portså‡½æ•°é‡Œé¢ä¼šè°ƒç”¨fib_lookupæŸ¥æ‰¾è·¯ç”±è¡¨ã€‚FIBå…¨ç§°æ˜¯Forwarding Information Baseï¼Œè½¬å‘ä¿¡æ¯è¡¨ï¼Œä¹Ÿå°±æ˜¯è·¯ç”±è¡¨ã€‚</li>\n<li>åœ¨IPå±‚é‡Œé¢è¦åšçš„å¦ä¸€ä¸ªäº‹æƒ…æ˜¯å¡«å†™IPå±‚çš„å¤´ã€‚</li>\n<li>åœ¨IPå±‚è¿˜è¦åšçš„ä¸€ä»¶äº‹æƒ…å°±æ˜¯é€šè¿‡iptablesè§„åˆ™ã€‚</li>\n<li>MACå±‚ï¼šIPå±‚è°ƒç”¨ip_finish_outputè¿›è¡ŒMACå±‚ã€‚</li>\n<li>MACå±‚éœ€è¦ARPè·å¾—MACåœ°å€ï¼Œå› è€Œè¦è°ƒç”¨___neigh_lookup_norefæŸ¥æ‰¾å±äºåŒä¸€ä¸ªç½‘æ®µçš„é‚»å±…ï¼Œä»–ä¼šè°ƒç”¨neigh_probeå‘é€ARPã€‚</li>\n<li>æœ‰äº†MACåœ°å€ï¼Œå°±å¯ä»¥è°ƒç”¨dev_queue_xmitå‘é€äºŒå±‚ç½‘ç»œåŒ…äº†ï¼Œå®ƒä¼šè°ƒç”¨__dev_xmit_skbä¼šå°†è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ã€‚</li>\n<li>è®¾å¤‡å±‚ï¼šç½‘ç»œåŒ…çš„å‘é€ä¼šè§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­NET_TX_SOFTIRQæ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°æ˜¯net_tx_actionã€‚</li>\n<li>åœ¨è½¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä¼šå°†ç½‘ç»œåŒ…ä»é˜Ÿåˆ—ä¸Šæ‹¿ä¸‹æ¥ï¼Œè°ƒç”¨ç½‘ç»œè®¾å¤‡çš„ä¼ è¾“å‡½æ•°ixgb_xmit_frameï¼Œå°†ç½‘ç»œåŒ…å‘åˆ°è®¾å¤‡çš„é˜Ÿåˆ—ä¸Šå»ã€‚</li>\n</ul><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ä¸Šä¸€èŠ‚ä½ åº”è¯¥é€šè¿‡tcpdumpçœ‹åˆ°äº†TCPåŒ…å¤´çš„æ ¼å¼ï¼Œè¿™ä¸€èŠ‚ï¼Œè¯·ä½ æŸ¥çœ‹ä¸€ä¸‹IPåŒ…çš„æ ¼å¼ä»¥åŠARPçš„è¿‡ç¨‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659\" alt=\"\"></p>","neighbors":{"left":{"article_title":"45 | å‘é€ç½‘ç»œåŒ…ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•è¡¨è¾¾æˆ‘ä»¬æƒ³è®©åˆä½œä¼™ä¼´åšä»€ä¹ˆï¼Ÿ","id":106490},"right":{"article_title":"47 | æ¥æ”¶ç½‘ç»œåŒ…ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•ææ˜ç™½åˆä½œä¼™ä¼´è®©æˆ‘ä»¬åšä»€ä¹ˆï¼Ÿ","id":107485}},"comments":[{"had_liked":false,"id":152726,"user_name":"humor","can_delete":false,"product_type":"c1","uid":1181867,"ip_address":"","ucode":"9B48C4C7BEC92C","user_header":"https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg","comment_is_top":false,"comment_ctime":1574070526,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40228776190","product_id":100024701,"comment_content":"è¿™ä¹ˆå¤æ‚çš„è°ƒç”¨å…³ç³»ï¼Œè€å¸ˆæ˜¯æ€ä¹ˆè®°ä½çš„å•Šï¼Ÿ æˆ‘çœ‹ä¸€éå°±ä¼šå¿˜æ‰â€¦â€¦","like_count":9},{"had_liked":false,"id":113529,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1563069455,"is_pvip":false,"replies":[{"id":"46668","content":"å‘èµ·è½¯ä¸­æ–­å°±è¿”å›","user_name":"ä½œè€…å›å¤","comment_id":113529,"uid":"1001590","ip_address":"","utype":1,"ctime":1566378168,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"40217775119","product_id":100024701,"comment_content":"è€å¸ˆã€‚åº”ç”¨å±‚è°ƒç”¨socket  æ¥å£å‘é€æ•°æ®æ˜¯åˆ°å“ªä¸ªé˜¶æ®µå°±è¿”å›äº†ï¼Ÿæ˜¯æ•°æ®å†™åˆ°qdiscä¸­åº”ç”¨å°±å¯ä»¥è¿”å›äº†å—ï¼Ÿè¿˜æ˜¯è¦ç­‰åˆ°å†™åˆ°ç¡¬ä»¶ç½‘å¡ä¸­ï¼Ÿ","like_count":9,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458260,"discussion_content":"å‘èµ·è½¯ä¸­æ–­å°±è¿”å›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566378168,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":216856,"user_name":"Mhy","can_delete":false,"product_type":"c1","uid":1287774,"ip_address":"","ucode":"DE19BCAD1F856E","user_header":"https://static001.geekbang.org/account/avatar/00/13/a6/5e/b05254a6.jpg","comment_is_top":false,"comment_ctime":1589355706,"is_pvip":false,"replies":[{"id":"83471","content":"è¦ç­‰å¾…è¿”å›ï¼Œè¦ä¸ç„¶ä¸çŸ¥é“macå‘ä¸å‡ºå»","user_name":"ä½œè€…å›å¤","comment_id":216856,"uid":"1001590","ip_address":"","utype":1,"ctime":1592186471,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"18769224890","product_id":100024701,"comment_content":"è€å¸ˆè¯·é—®neigh_probe å‘é€ ARPåè¿˜éœ€è¦é˜»å¡ç­‰å¾…å…¶ä»–ä¸»æœºè¿”å›macå—ï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°å‘¢","like_count":4,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494969,"discussion_content":"è¦ç­‰å¾…è¿”å›ï¼Œè¦ä¸ç„¶ä¸çŸ¥é“macå‘ä¸å‡ºå»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592186471,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2401422,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/NyFOEueITjaGLpakMEuWAqVQjo1uDIXlpDdpCxXGfaWiaXzibLQ3WgOFCe8D9FvCmyjsGT7jDsLUbkt8jt2aVs9g/132","nickname":"geek","note":"","ucode":"FF0845140D72A9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372928,"discussion_content":"æ²¡æ”¶åˆ°å¯èƒ½ä¼šæ˜¯è¶…æ—¶å¤±è´¥å§ï¼Œæˆ‘ç†è§£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620527892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112995,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1562862654,"is_pvip":false,"replies":[{"id":"46682","content":"åªè¦é€šè¿‡æœ¬åœ°çš„å­ç½‘æ©ç ç®—ä¸€ä¸‹ã€‚192.168.2.100çš„å‰16ä½èƒ½å¤Ÿå’Œ192.168ï¼ˆ192.168.0.0&#47;16ï¼‰å®Œå…¨ä¸€è‡´ï¼Œåˆ™è¯´æ˜èƒ½å¤ŸåŒ¹é…192.168.0.0&#47;16ã€‚åŒç†192.168.2.100çš„å‰24ä½èƒ½å¤Ÿå’Œ192.168.2ï¼ˆ192.168.2.0&#47;24ï¼‰å®Œå…¨ä¸€è‡´ï¼Œåˆ™è¯´æ˜èƒ½å¤ŸåŒ¹é…192.168.2.0&#47;24","user_name":"ä½œè€…å›å¤","comment_id":112995,"uid":"1001590","ip_address":"","utype":1,"ctime":1566379743,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":3,"race_medal":0,"score":"10152797246","product_id":100024701,"comment_content":"ä¾‹å¦‚ 192.168.2.0&#47;24 å’Œ 192.168.0.0&#47;16 éƒ½èƒ½åŒ¹é… 192.168.2.100&#47;24ã€‚<br>      192.168.0.0&#47;16ä¸ºä»€ä¹ˆèƒ½åŒ¹é…192.168.2.100&#47;24 å‘¢ï¼Ÿå…¶å®å¯¹äºç›®çš„IPæˆ‘ä»¬æ˜¯ä¸çŸ¥é“å­ç½‘æ©ç çš„ï¼Œæ‰€ä»¥192.168.2.100&#47;24è¿™é‡Œçš„24æ„Ÿè§‰æœ‰ç‚¹è¿·æƒ‘ï¼Œå¦‚æœç¡®å®šå®ƒçš„æ©ç æ˜¯24ä½ï¼Œé‚£å’Œ16ä½æ©ç çš„é‚£ä¸ªè§„åˆ™å°±ä¸åŒ¹é…äº†å§ã€‚","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458002,"discussion_content":"åªè¦é€šè¿‡æœ¬åœ°çš„å­ç½‘æ©ç ç®—ä¸€ä¸‹ã€‚192.168.2.100çš„å‰16ä½èƒ½å¤Ÿå’Œ192.168ï¼ˆ192.168.0.0/16ï¼‰å®Œå…¨ä¸€è‡´ï¼Œåˆ™è¯´æ˜èƒ½å¤ŸåŒ¹é…192.168.0.0/16ã€‚åŒç†192.168.2.100çš„å‰24ä½èƒ½å¤Ÿå’Œ192.168.2ï¼ˆ192.168.2.0/24ï¼‰å®Œå…¨ä¸€è‡´ï¼Œåˆ™è¯´æ˜èƒ½å¤ŸåŒ¹é…192.168.2.0/24","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566379743,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1609871,"avatar":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","nickname":"å¥”è·‘çš„ç ä»”","note":"","ucode":"AB3B02B07B8B8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":35778,"discussion_content":"1.ç½‘ç»œåŒ…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯æ²¡æœ‰æ©ç ä¿¡æ¯çš„ã€‚\n2.æ©ç æ˜¯ç”¨äºæœ¬åœ°å­ç½‘è®¡ç®—çš„ã€‚\n3.IPåŒ…è·¯ç”±æ—¶æŒ‰ç…§æœ€é•¿åŒ¹é…åŸåˆ™è¿›è¡Œé€‰è·¯ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§é™åº¦çš„å‡å°‘ç½‘ç»œåŒ…é€‰è·¯æ¬¡æ•°ï¼Œä»è€Œç¼©çŸ­ç½‘ç»œçš„è¾“å‡ºæ—¶é—´ã€‚","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1571304357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1222003,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a5/73/3ddc7c77.jpg","nickname":"Brave Shine","note":"","ucode":"CBB1BAF89DB936","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1943,"discussion_content":"ç›®çš„åœ°çŸ¥é“å‘€ï¼Œè·¯ç”±è§„åˆ™é‡Œï¼Œå¦‚æœä½ è¯´è·¯ç”±è§„åˆ™é‡Œçš„è§„åˆ™æ€ä¹ˆäº§ç”Ÿç±»ä¼¼xxx.xxx.xxx.xxx/xx,ä»¥æˆ‘ç›®å‰æµ…è–„çš„è®¤çŸ¥å­˜åœ¨æ‰‹åŠ¨å’Œä¸»åŠ¨&#34;å­¦ä¹ &#34;çš„æƒ…å†µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563113418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":310616,"user_name":"Slience-0Â°C","can_delete":false,"product_type":"c1","uid":1151612,"ip_address":"","ucode":"B50665EC6A80F5","user_header":"https://static001.geekbang.org/account/avatar/00/11/92/7c/12c571b6.jpg","comment_is_top":false,"comment_ctime":1630792826,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5925760122","product_id":100024701,"comment_content":"ä¸æ˜¯å¾ˆè¶£å‘³å•Š","like_count":2},{"had_liked":false,"id":231599,"user_name":"æåœ£æ‚¦","can_delete":false,"product_type":"c1","uid":1638427,"ip_address":"","ucode":"C1786C98824E50","user_header":"https://static001.geekbang.org/account/avatar/00/19/00/1b/eee13196.jpg","comment_is_top":false,"comment_ctime":1593735445,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5888702741","product_id":100024701,"comment_content":"å‘ä¸ªåŒ…å°±å¹²äº†è¿™ä¹ˆå¤šäº‹ï¼æ‰€ä»¥æ€§èƒ½å¹¶ä¸å¾ˆå¥½ï¼Œè¿½æ±‚æ€§èƒ½è¿˜æ˜¯è¦ç”¨dpdk","like_count":1,"discussions":[{"author":{"id":1002005,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","nickname":"stackWarn","note":"","ucode":"89672E452DEBA5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312243,"discussion_content":"linuxå†…æ ¸æ˜¯é€šç”¨å‹çš„ï¼Œä½¿ç”¨è¿˜æ˜¯è¾ƒå¹¿ï¼ŒåŸºç¡€è®¾æ–½ç­‰ä¸“ç”¨çš„å¯ä»¥ä¸Šdpdkæˆ–bpf","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1602639090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213658,"user_name":"æœ‰ç±³","can_delete":false,"product_type":"c1","uid":1005042,"ip_address":"","ucode":"C9A10B7A67BC12","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg","comment_is_top":false,"comment_ctime":1588502613,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5883469909","product_id":100024701,"comment_content":"è°ƒç”¨æµç¨‹å·²ç»æ˜ç™½äº†ï¼Œä½†è¿˜ä¸å¤ªæ˜ç™½æ•°æ®çš„ç‰©ç†ç©ºé—´æ˜¯æ€ä¹ˆæµåŠ¨çš„ï¼Ÿæ¯”å¦‚æˆ‘ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œæ˜¯ä»ç£ç›˜æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç„¶åæ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œå†æ‹·è´åˆ°ç½‘å¡ç¼“å­˜ï¼Ÿç»“åˆé›¶æ‹·è´åŸç†æ¥çœ‹ï¼Œè¿˜æ˜¯æœ‰ç‚¹æ¨¡ç³Šã€‚è¯·è€å¸ˆå¸®å¿™æ‹ä¸€æ‹","like_count":1},{"had_liked":false,"id":114414,"user_name":"ä¸€ç¬”ä¸€ç”»","can_delete":false,"product_type":"c1","uid":1495254,"ip_address":"","ucode":"2B9BC8ADF97106","user_header":"https://static001.geekbang.org/account/avatar/00/16/d0/d6/f335954b.jpg","comment_is_top":false,"comment_ctime":1563293403,"is_pvip":false,"replies":[{"id":"46603","content":"ä¸éœ€è¦ï¼Œæ˜¯å†…æ ¸çš„åŠŸèƒ½","user_name":"ä½œè€…å›å¤","comment_id":114414,"uid":"1001590","ip_address":"","utype":1,"ctime":1566364035,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5858260699","product_id":100024701,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸‹qosåŠŸèƒ½æ˜¯å¦ä¹Ÿå’Œç¡¬ä»¶æœ‰å…³ç³»ï¼Ÿpfifo_fastæ˜¯éœ€è¦ç¡¬ä»¶æ”¯æŒçš„å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458650,"discussion_content":"ä¸éœ€è¦ï¼Œæ˜¯å†…æ ¸çš„åŠŸèƒ½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566364035,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113524,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1563067414,"is_pvip":false,"replies":[{"id":"46669","content":"èµï¼Œè‡ªå·±å®ç°RTPï¼Œç‰›","user_name":"ä½œè€…å›å¤","comment_id":113524,"uid":"1001590","ip_address":"","utype":1,"ctime":1566378187,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5858034710","product_id":100024701,"comment_content":"æœ€è¿‘ç”¨goå®ç°äº†rtpçš„åè®®ï¼Œåè®®å¤´å¡«å……å’Œå­—èŠ‚å¤§å°è®¡ç®—ç­‰ç­‰å¾ˆç±»ä¼¼ï¼Œè¿™èŠ‚å†…å®¹æœ‰ç§ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œå€Ÿé‰´ä¸‹å¯ä»¥å®ç°çš„æ›´ç‰›é€¼ï¼Œå“ˆ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458258,"discussion_content":"èµï¼Œè‡ªå·±å®ç°RTPï¼Œç‰›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566378187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112996,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1562862866,"is_pvip":false,"replies":[{"id":"46681","content":"å†…æ ¸åè®®æ ˆåŠ ä¸Šçš„ã€‚macåœ°å€å¯ä»¥é€šè¿‡å‘½ä»¤ä¿®æ”¹çš„","user_name":"ä½œè€…å›å¤","comment_id":112996,"uid":"1001590","ip_address":"","utype":1,"ctime":1566379486,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5857830162","product_id":100024701,"comment_content":"å‘é€æ•°æ®åŒ…æ—¶ï¼ŒæºMacåœ°å€æ˜¯ç”±åè®®æ ˆè½¯ä»¶åŠ ä¸Šçš„å—ï¼Œè¿˜æ˜¯ç­‰æ•°æ®åŒ…åˆ°ç½‘å¡åç”±ç½‘å¡ç¡¬ä»¶è‡ªåŠ¨åŠ ä¸Šçš„ï¼Ÿ<br><br>æºMacåœ°å€ç°åœ¨ä¸€èˆ¬æ˜¯å†™æ­»åœ¨ç½‘å¡é‡Œçš„å—ï¼Ÿè¿˜æ˜¯ç»´æŠ¤åœ¨è½¯ä»¶åè®®æ ˆé‡Œçš„ä¸€ä¸ªå˜é‡ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458003,"discussion_content":"å†…æ ¸åè®®æ ˆåŠ ä¸Šçš„ã€‚macåœ°å€å¯ä»¥é€šè¿‡å‘½ä»¤ä¿®æ”¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566379486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358189,"user_name":"Aå…å¸…å«å“¥","can_delete":false,"product_type":"c1","uid":2058258,"ip_address":"å¹¿ä¸œ","ucode":"76D2522E602AEF","user_header":"https://static001.geekbang.org/account/avatar/00/1f/68/12/031a05c3.jpg","comment_is_top":false,"comment_ctime":1664014597,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1664014597","product_id":100024701,"comment_content":"å°†ARPåŒ…æ”¾åˆ°arp_queueï¼Œè¿™é‡Œåº”è¯¥æ˜¯æè¿°é”™äº†ï¼Œarp_queueä¸­ä¿å­˜çš„æ˜¯çœŸå®çš„æ•°æ®åŒ…ï¼Œä¸æ˜¯arpåŒ…ï¼Œå¾…æ¥æ”¶åˆ°arpå“åº”ä¹‹åå†å»å¤„ç†arp_queueçš„æ•°æ®åŒ…ï¼Œé€ä¸ªå‘é€ï¼Œã€‚åœ¨neighprobeçš„æ—¶å€™ï¼Œæ‰ä¼šç”ŸæˆarpåŒ…ï¼Œå¹¶å‘é€ã€‚","like_count":0},{"had_liked":false,"id":351582,"user_name":"LiL","can_delete":false,"product_type":"c1","uid":2923131,"ip_address":"","ucode":"23BE4E0181E80D","user_header":"https://static001.geekbang.org/account/avatar/00/2c/9a/7b/aa937172.jpg","comment_is_top":false,"comment_ctime":1657956748,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657956748","product_id":100024701,"comment_content":"è¯·é—®åˆ˜è€å¸ˆï¼Œè¾“å…¥ä¸€ä¸ªæ— æ•ˆIPï¼Œè·¯ç”±å™¨æ˜¯æ€ä¹ˆåˆ¤å®šä»–æ˜¯æ— æ•ˆçš„ï¼Ÿæ‰€æœ‰è·¯ç”±è·¯å¾„å°è¯•ä¸€è¾¹éƒ½å¤±è´¥æ‰ç®—ï¼Ÿè¿˜æ˜¯æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":330914,"user_name":"æ˜æœˆåƒé‡Œ","can_delete":false,"product_type":"c1","uid":1128928,"ip_address":"","ucode":"C8D31CAA2A2D6A","user_header":"https://static001.geekbang.org/account/avatar/00/11/39/e0/8b74c083.jpg","comment_is_top":false,"comment_ctime":1642293521,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1642293521","product_id":100024701,"comment_content":"å¤ªç¡¬æ ¸äº†","like_count":0},{"had_liked":false,"id":287051,"user_name":"å‡Œç©ºé£èµ·çš„å‰ªåˆ€è…¿","can_delete":false,"product_type":"c1","uid":1243680,"ip_address":"","ucode":"16FBBF4A3B54C6","user_header":"https://static001.geekbang.org/account/avatar/00/12/fa/20/0f06b080.jpg","comment_is_top":false,"comment_ctime":1617760457,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617760457","product_id":100024701,"comment_content":"socket---&gt;route list----&gt;netfilter(iptables)--&gt;tc---&gt;mac","like_count":0},{"had_liked":false,"id":185090,"user_name":"Geek_211784","can_delete":false,"product_type":"c1","uid":1900451,"ip_address":"","ucode":"E0E75054688218","user_header":"","comment_is_top":false,"comment_ctime":1583480424,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583480424","product_id":100024701,"comment_content":"æ‚¨å¥½ï¼Œæˆ‘è¯•ç€å¾ªç¯alloc_skbåˆ›å»ºskbå¹¶è°ƒç”¨ip_queue_xmitå‘å‡ºå»ï¼Œæ¥æ”¶ç«¯èƒ½æ”¶åˆ°åŒ…ï¼Œä½†å¾ªç¯30æ¬¡ï¼Œå‘ç°è€—æ—¶æœ€å°‘éƒ½æœ‰4100usä¹Ÿå°±æ˜¯4æ¯«ç§’å¤šï¼Œæ„Ÿè§‰è¿™ä¸ªè€—æ—¶å¾ˆå¤§ï¼Œæ˜¯ä¸æ˜¯æœ‰å•¥é—®é¢˜ã€‚","like_count":0},{"had_liked":false,"id":164173,"user_name":"skye","can_delete":false,"product_type":"c1","uid":1027840,"ip_address":"","ucode":"C55C9F52C78A00","user_header":"https://static001.geekbang.org/account/avatar/00/0f/af/00/9b49f42b.jpg","comment_is_top":false,"comment_ctime":1576900744,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576900744","product_id":100024701,"comment_content":"è¯·é—®è€å¸ˆï¼Œnets tat çœ‹åˆ°çš„recv-q å’Œsend-qæ˜¯å±äºç½‘å¡çš„é˜Ÿåˆ—å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":141446,"user_name":"ä¸€ç¬”ä¸€ç”»","can_delete":false,"product_type":"c1","uid":1495254,"ip_address":"","ucode":"2B9BC8ADF97106","user_header":"https://static001.geekbang.org/account/avatar/00/16/d0/d6/f335954b.jpg","comment_is_top":false,"comment_ctime":1571155167,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1571155167","product_id":100024701,"comment_content":"è¯·æ•™ä¸‹ï¼ŒMACå±‚ä¹Ÿè´Ÿè´£vlan tagçš„å¡«å……å—","like_count":0,"discussions":[{"author":{"id":1674555,"avatar":"https://static001.geekbang.org/account/avatar/00/19/8d/3b/42d9c669.jpg","nickname":"è‰¾ç‘å…‹å°éœ¸ç‹","note":"","ucode":"58FCCAC0F675E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":77469,"discussion_content":"vlanæ˜¯äºŒå±‚äº¤æ¢æœºå¯¹ç«¯å£è®¾ç½®çš„ï¼Œæ˜¯åœ¨äº¤æ¢æœºä¸Šè¿›è¡Œçš„å¡«å……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575903852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1002005,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","nickname":"stackWarn","note":"","ucode":"89672E452DEBA5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1674555,"avatar":"https://static001.geekbang.org/account/avatar/00/19/8d/3b/42d9c669.jpg","nickname":"è‰¾ç‘å…‹å°éœ¸ç‹","note":"","ucode":"58FCCAC0F675E1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312244,"discussion_content":"å¦‚æœé…ç½®äº†vlanå­æ¥å£å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602639132,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":77469,"ip_address":""},"score":312244,"extra":""}]}]},{"had_liked":false,"id":134547,"user_name":"ZYecho","can_delete":false,"product_type":"c1","uid":1356589,"ip_address":"","ucode":"9D156DD30C581E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLh73kPzAKhz7YxUribqF6QKFiahhVAbwpgVLSRicA68c6ZFA7vUBJY1ves3LVvibrypROyI7awv47eSA/132","comment_is_top":false,"comment_ctime":1568862755,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568862755","product_id":100024701,"comment_content":"è€å¸ˆï¼Œå†…æ ¸ä¸­è¿˜æœ‰ä¸ªfdbè¡¨ï¼Œè¯·é—®è¿™ä¸ªè¡¨æ˜¯ç”¨æ¥å¹²å˜›çš„ï¼Ÿåœ¨å“ªä¸ªç¯èŠ‚çš„å¤„ç†è¿‡ç¨‹ä¸­ä¼šè¢«ä½¿ç”¨åˆ°ï¼Ÿ","like_count":0},{"had_liked":false,"id":113335,"user_name":"Linuxer","can_delete":false,"product_type":"c1","uid":1153978,"ip_address":"","ucode":"272D9D8089C3D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg","comment_is_top":false,"comment_ctime":1562977264,"is_pvip":false,"replies":[{"id":"46672","content":"æ˜¯çš„ï¼Œè°¢è°¢æŒ‡æ­£","user_name":"ä½œè€…å›å¤","comment_id":113335,"uid":"1001590","ip_address":"","utype":1,"ctime":1566378270,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1562977264","product_id":100024701,"comment_content":"è®¾å¤‡å±‚ï¼šç½‘ç»œåŒ…çš„å‘é€å›(è¿™é‡Œåº”è¯¥æ˜¯ä¼šå§ï¼Ÿ)è§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­ NET_TX_SOFTIRQ æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°æ˜¯ net_tx_actionã€‚<br>åœ¨è½¯ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä¼šå°†ç½‘ç»œåŒ…ä»é˜Ÿåˆ—ä¸Šæ‹¿ä¸‹æ¥ï¼Œè°ƒç”¨ç½‘ç»œè®¾å¤‡çš„ä¼ è¾“å‡½æ•° ixgb_xmit_frameï¼Œå°†ç½‘ç»œåŒ…å‘çš„(è¿™é‡Œåº”è¯¥æ˜¯åˆ°å§ï¼Ÿ)è®¾å¤‡çš„é˜Ÿåˆ—ä¸Šå»","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458173,"discussion_content":"æ˜¯çš„ï¼Œè°¢è°¢æŒ‡æ­£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566378270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}