{"id":424017,"title":"20ï½œ4 Steps ï¼šå¦‚ä½•æ›´å¥½åœ°é˜…è¯»Rustæºç ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒRust çš„åŸºç¡€çŸ¥è¯†æˆ‘ä»¬å°±å­¦å¾—å·®ä¸å¤šäº†ã€‚è¿™å€’ä¸æ˜¯è¯´å·²ç»åƒç”¨ç­›å­ä¸€æ ·ï¼ŒæŠŠåŸºç¡€çŸ¥è¯†ä»”ç»†ç­›äº†ä¸€éï¼Œæ¯•ç«Ÿæˆ‘åªèƒ½ç»™ä½ æä¾›å­¦ä¹ Rustçš„æ€è·¯ï¼Œæ‰«æ¸…å…¥é—¨éšœç¢ã€‚è€è¯è¯´å¾—å¥½ï¼Œå¸ˆå‚…é¢†è¿›é—¨ä¿®è¡Œé ä¸ªäººï¼Œåœ¨ Rust ä¸–ç•Œé‡Œæ‰“æ€ªå‡çº§ï¼Œè¿˜è¦é ä½ è‡ªå·±å»æ¢ç´¢ã€å»åŠªåŠ›ã€‚</p><p>è™½ç„¶ä¸èƒ½å¸®ä½ æ‰“æ€ªï¼Œä½†æ˜¯æ‰“æ€ªçš„åŸºæœ¬æŠ€å·§å¯ä»¥èŠä¸€èŠã€‚æ‰€ä»¥åœ¨å¼€å§‹é˜¶æ®µå®æ“å¼•å…¥å¤§é‡æ–°ç¬¬ä¸‰æ–¹åº“ä¹‹å‰ï¼Œæˆ‘ä»¬éå¸¸æœ‰å¿…è¦å…ˆèŠä¸€ä¸‹è¿™ä¸ªå¾ˆé‡è¦çš„æŠ€å·§ï¼š<strong>å¦‚ä½•æ›´å¥½åœ°é˜…è¯»æºç </strong>ã€‚</p><p>å…¶å®ä¼šè¯»æºç æ˜¯ä¸ªç»ˆç”Ÿå—ç›Šçš„å¼€å‘æŠ€èƒ½ï¼Œå´å¾€å¾€è¢«å¿½ç•¥ã€‚åœ¨æˆ‘è¯»è¿‡çš„ç»å¤§å¤šæ•°çš„ç¼–ç¨‹ä¹¦ç±é‡Œï¼Œå¾ˆå°‘æœ‰è®²å¦‚ä½•é˜…è¯»ä»£ç çš„ï¼Œå°±åƒä¸–é—´çš„ä¹¦ç±åƒåƒä¸‡ä¸‡ï¼Œâ€œå¦‚ä½•é˜…è¯»ä¸€æœ¬ä¹¦â€è¿™æ ·çš„é¢˜æå´å‡¤æ¯›éºŸè§’ã€‚</p><p>å½“ç„¶ï¼Œåœ¨è§£å†³â€œå¦‚ä½•â€ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆææ˜ç™½â€œä¸ºä»€ä¹ˆâ€ã€‚</p><h2>ä¸ºä»€ä¹ˆè¦é˜…è¯»æºç ï¼Ÿ</h2><p>å¦‚æœè¯¾ç¨‹çš„æ¯ä¸€è®²ä½ éƒ½è®¤çœŸçœ‹è¿‡ï¼Œä¼šå‘ç°æ—¶åˆ»éƒ½åœ¨å¼•ç”¨æ ‡å‡†åº“çš„æºç ï¼Œè®©æˆ‘ä»¬åœ¨é˜…è¯»çš„æ—¶å€™ï¼Œä¸å…‰å­¦åŸºç¡€çŸ¥è¯†ï¼Œè¿˜èƒ½å›´ç»•å®ƒçš„ç¬¬ä¸€æ‰‹èµ„æ–™ä¹Ÿå°±æ˜¯æºä»£ç å±•å¼€è®¨è®ºã€‚</p><p>å¦‚æœè¯´ä»–äººæ€»ç»“çš„çŸ¥è¯†æ˜¯æœå®ï¼Œé‚£æºä»£ç å°±æ˜¯ç»“å‡ºè¿™æœå®çš„ç§å­ã€‚åªæ‘˜æœå­åƒï¼Œå°±æ˜¯ç­‰ä»–äººèµé¥­ï¼Œéå¸¸è¢«åŠ¨ï¼Œä¹Ÿä¸å®¹æ˜“åˆ†æ¸…æœå­çš„å¥½åï¼›å¦‚æœé æœ´ç´ çš„æºç ç§å­ç»“å‡ºäº†è‡ªå·±çš„æœå®ï¼Œç¡®å®å‰æœŸè¦è€å¾—ä½å¯‚å¯æ–½è‚¥æµ‡æ°´ï¼Œä½†æ”¶å‰²çš„æ—¶åˆ»ï¼Œä¸€åˆ‡å°½åœ¨è‡ªå·±çš„æŒæ§ä¹‹ä¸­ã€‚</p><!-- [[[read_end]]] --><p>ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬æ¯å¤©éƒ½å’Œä»£ç æ‰“äº¤é“ã€‚ç»è¿‡æ•°å¹´çš„åŸºç¡€æ•™è‚²å’ŒèŒä¸šåŸ¹è®­ï¼Œæˆ‘ä»¬éƒ½ä¼šâ€œå†™â€ä»£ç ï¼Œæˆ–è€…è‡³å°‘ä¼šæŠ„ä»£ç å’Œæ”¹ä»£ç ã€‚ä½†æ˜¯ï¼Œä¼šè¯»ä»£ç çš„å…¶å®å¹¶ä¸å¤šï¼Œä¼šè¯»ä»£ç åˆçœŸæ­£èƒ½è¯»æ‡‚ä¸€äº›å¤§é¡¹ç›®æºç çš„ï¼Œå°‘ä¹‹åˆå°‘ã€‚</p><p>è¿™ç§æ€ªçŠ¶ï¼ŒçœŸè¦è¿½ç©¶èµ·æ¥ï¼Œå°±æ˜¯å› ä¸º<strong>å‰æœŸæˆ‘ä»¬æ‰€æœ‰çš„æ•™è‚²å’ŒåŸ¹è®­éƒ½åœ¨å¼ºè°ƒæ€ä¹ˆå†™ä»£ç </strong>ï¼Œå¹¶æ²¡æœ‰æ•™æ€ä¹ˆè¯»ä»£ç ï¼Œè€Œèµ°å…¥å·¥ä½œåï¼Œå¤§å¤šæ•°åœºæ™¯ä¹Ÿéƒ½æ˜¯ä¸€ä¸ªèåœä¸€ä¸ªå‘ï¼Œ<strong>æˆ‘ä»¬åªéœ€è¦äº†è§£ç³»ç»Ÿçš„ä¸€ä¸ªå±€éƒ¨å°±èƒ½å¼€å±•å·¥ä½œï¼Œè¯»å’Œå·¥ä½œå†…å®¹ä¸ç›¸å¹²çš„ä»£ç ï¼Œä¼¼ä¹æ²¡ä»€ä¹ˆç”¨</strong>ã€‚</p><p>é‚£æ²¡æœ‰è¯»è¿‡å¤§é‡ä»£ç ç©¶ç«Ÿæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ¯•ç«Ÿå·¥ä½œå¥½åƒè¿˜æ˜¯èƒ½æ­£å¸¸å¼€å±•ï¼Ÿå°±æ‹¿è·Ÿå†™ä»£ç æœ‰å¾ˆå¤šç›¸é€šä¹‹å¤„çš„å†™ä½œæ¥å¯¹æ¯”ã€‚</p><p>å°æ—¶å€™æˆ‘ä»¬éƒ½ç»å†è¿‡è¯»è¯¾æ–‡ã€èƒŒè¯¾æ–‡ã€å†™ä½œæ–‡çš„è¿‡ç¨‹ã€‚é™¤äº†å­¦ä¹ è¯­æ³•å’Œæ–‡æ³•çŸ¥è¯†å¤–ï¼Œä»å°å­¦å¼€å§‹ï¼Œç»å¹´ç´¯æœˆï¼Œé˜…è¯»å„ç§åå®¶ä½œå“ï¼Œç»è¿‡å„ç§å†™ä½œè®­ç»ƒï¼Œæ‰ç´¯ç§¯å‡ºè‡ªå·±çš„å†™ä½œèƒ½åŠ›ã€‚æ‰€ä»¥å¯ä»¥è¯´ï¼Œå†™ä½œå»ºç«‹åœ¨å¤§é‡é˜…è¯»åŸºç¡€ä¸Šã€‚</p><p>è€Œæˆ‘ä»¬å†™ä»£ç çš„è¿‡ç¨‹å°±å¾ˆä¸åŒäº†ï¼Œåœ¨å­¦ä¼šåŸºç¡€çš„è¯­æ³•å’Œè¯•éªŒäº†è‹¥å¹² example åï¼Œè·³è¿‡äº†å¤§é‡é˜…è¯»åå®¶ä½œå“çš„é˜¶æ®µï¼Œç›´æ¥åç«ç®­èˆ¬è¹¿åˆ°è‡ªå·±å¼€å§‹å†™ä¸šåŠ¡ä»£ç ã€‚</p><p>è¿™æ ·è·³è¿‡äº†å¤§é‡çš„ä»£ç é˜…è¯»æœ‰ä¸‰ä¸ªé—®é¢˜ï¼š</p><p>é¦–å…ˆæ²¡æœ‰è¶³å¤Ÿç§¯ç´¯ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“<strong>å…»æˆ StackOverflow driven çš„å†™ä»£ç ä¹ æƒ¯</strong>ã€‚</p><p>é‡åˆ°ä¸çŸ¥å¦‚ä½•å†™çš„ä»£ç ï¼Œä»ç½‘ä¸Šæ‰¾ç°æˆçš„ç­”æ¡ˆï¼Œæ‰¾ä¸ªé«˜ç¥¨çš„å¤åˆ¶ç²˜è´´ï¼Œæ”¹ä¸€æ”¹å‡‘æ´»ç€ç”¨ï¼Œå…ˆå®ŒæˆåŠŸèƒ½å†è¯´ã€‚å†™ä»£ç çš„è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå°±å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œè¦ä¹ˆè®¾ç½®æ— æ•°æ–­ç‚¹ä¸€æ­¥æ­¥è·Ÿè¸ªï¼Œè¦ä¹ˆåˆ°å¤„æ‰“å°ä¿¡æ¯è¯•å›¾ä¸ºæ»¡æ˜¯çªŸçª¿çš„ä»£ç æ‰“ä¸Šè¡¥ä¸ï¼Œå¯¼è‡´å†™ä»£ç çš„æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€éƒ¨è°ƒä»£ç çš„è¡€æ³ªå²ã€‚</p><p>å…¶æ¬¡ï¼Œ<strong>å› ä¸ºå¹³æ—¶åŸºç¡€ä¸ç‰¢é ï¼Œæˆ‘ä»¬é è¾¹å†™è¾¹å­¦çš„è¿›æ­¥æ˜¯æœ€æ…¢çš„</strong>ã€‚é“ç†å¾ˆç®€å•ï¼Œå‰è¾ˆä»¬è¸©è¿‡å‘æ€»ç»“çš„ç»éªŒæ•™è®­ï¼Œéƒ½ä¸å¾—ä¸äº²è‡ªç”¨æœ€æ…¢çš„æ³•å­ä¸€ç‚¹ç‚¹è¯•ç€è¸©ä¸€éã€‚</p><p>æœ€åè¿˜æœ‰ä¸€ä¸ªéå¸¸å®¹æ˜“è¢«å¿½ç•¥çš„å¤©èŠ±æ¿é—®é¢˜ï¼Œ<strong>å‘¨å›´èƒ½è§¦è¾¾çš„é‚£ä¸ªæœ€å¼ºå·¥ç¨‹å¸ˆå¼€å‘æ°´å¹³çš„ä¸Šé™ï¼Œå°±æ˜¯æˆ‘ä»¬çš„ä¸Šé™</strong>ã€‚</p><p>ä½†æ˜¯å¦‚æœé‡è§†è¯»æºç å¹³æ—¶ç§¯ç´¯ï¼Œå¹¶ä¸”å…·å¤‡ä¸€å®šé˜…è¯»æŠ€å·§ï¼Œè¿™ä¸‰ä¸ªé—®é¢˜å°±èƒ½è¿åˆƒè€Œè§£ã€‚å°±åƒå†™ä½œæ–‡å½¢å®¹ç¾å¥³æ—¶ï¼Œä½ ç«‹å³èƒ½æƒ³åˆ°â€œè‚Œè‚¤èƒœé›ªã€æ˜çœ¸å–„çã€é½¿å¦‚å«è´ã€æ°”è‹¥å¹½å…°â€¦â€¦â€ï¼Œè€Œä¸æ˜¯æ†‹äº†åŠå¤©å°±ä¸‰å­—â€œå“‡ç¾å¥³â€ã€‚ä¸ºäº†è®©æˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œæ‘†è„±åªä¼šâ€œå“‡ç¾å¥³â€è¿™æ ·çš„åˆçº§é˜¶æ®µï¼Œå¤šè¯»æºç éå¸¸å…³é”®ã€‚</p><h3>ä¸‰å¤§åŠŸç”¨</h3><p>è¯»æºç çš„ç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œ<strong>çŸ¥è¯†çš„æºå¤´åœ¨ä½ è¿™é‡Œï¼Œä½ å¯ä»¥æ ¹æ®äº‹å®æ¥åˆ†è¾¨æ˜¯éï¼Œè€Œä¸æ˜¯è¿·ä¿¡æƒå¨</strong>ã€‚æ¯”å¦‚è¯´ä¹‹å‰è®² Rc æ—¶ï¼ˆ<a href=\"https://time.geekbang.org/column/article/416722\">ç¬¬9è®²</a>ï¼‰ï¼Œæˆ‘ä»¬é€šè¿‡æºç å¼•å‡º Box::leak ï¼Œå›ç­”äº†ä¸ºå•¥ Rc å¯ä»¥çªç ´ Rust å•ä¸€æ‰€æœ‰æƒçš„æ¡æ¢ï¼›è°ˆåˆ° FnOnce æ—¶ï¼ˆ<a href=\"https://time.geekbang.org/column/article/424009\">ç¬¬19è®²</a>ï¼‰ï¼Œé€šè¿‡æºç ä¸€çœ¼çœ‹é€ä¸ºå•¥ FnOnce åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚</p><p>æœªæ¥ä½ åœ¨è·Ÿåˆ«äººåˆ†äº«çš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆè‡ªä¿¡åœ°å›ç­”è¿™äº›é—®é¢˜ï¼Œè€Œä¸å¿…è¯´å› ä¸ºã€Šé™ˆå¤©çš„ Rust ç¬¬ä¸€è¯¾ã€‹é‡Œæ˜¯è¿™ä¹ˆè¯´çš„ï¼Œè¿™ä¹Ÿè§£å†³äº†åˆšæ‰çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p><p>é€šè¿‡æºç æˆ‘ä»¬è¿˜å­¦åˆ°äº†å¾ˆå¤šæŠ€å·§ã€‚æ¯”å¦‚ Rc::clone() å¦‚ä½•ä½¿ç”¨å†…éƒ¨å¯å˜æ€§æ¥ä¿æŒ Clone trait çš„ä¸å¯å˜çº¦æŸï¼ˆ<a href=\"https://time.geekbang.org/column/article/416722\">ç¬¬9è®²</a>ï¼‰ï¼›Iterator é‡Œçš„æ–¹æ³•å¦‚ä½•é€šè¿‡ä¸æ–­æ„é€ æ–°çš„ Iterator æ•°æ®ç»“æ„ï¼Œæ¥æ”¯æŒ lazy evaluation ï¼ˆ<a href=\"https://time.geekbang.org/column/article/422975\">ç¬¬16è®²</a>ï¼‰ã€‚</p><p>æœªæ¥ä½ åœ¨å†™ä»£ç æ—¶ï¼Œè¿™äº›æŠ€å·§éƒ½å¯ä»¥ä½¿ç”¨ï¼Œä»â€œå“‡ç¾å¥³â€çš„åˆçº§æ°´å¹³åˆ°å¯ä»¥è¯•ç€ä½¿ç”¨â€œä¸€ç¬‘å€¾åŸï¼Œå†ç¬‘å€¾å›½â€çš„åœ°æ­¥ã€‚è¿™æ˜¯è¯»æºç çš„ç¬¬äºŒä¸ªå¥½å¤„ï¼Œ<strong>çœ‹åˆ«äººçš„ä»£ç ï¼Œç§¯ç´¯äº†ç´ æï¼Œå¼€æ‹“äº†æ€è·¯ï¼Œè‡ªå·±å†™ä»£ç æ—¶å¯ä»¥â€œæ–‡æ€å¦‚æ³‰æ¶Œï¼Œä¸‹ç¬”å¦‚æœ‰ç¥â€</strong>ã€‚</p><p>æœ€åä¸€ä¸ªèƒ½è§£å†³çš„é—®é¢˜å°±æ˜¯æ‰“ç ´å¤©èŠ±æ¿äº†ã€‚ç´¯ç§¯ç´ ææ˜¯åŸºç¡€ï¼Œè¢«å¯å‘å‡ºæ¥çš„æ€è·¯å°†è¿™äº›ç´ æä¸²æˆçº¿ï¼Œæ‰å½¢æˆäº†è‡ªå·±çš„çŸ¥è¯†ã€‚</p><p>ä¼˜ç§€çš„ä»£ç è¯»å¾—è¶Šå¤šï¼Œè¶Šèƒ½å¼•å‘æ€è€ƒï¼Œä»è€Œå¼•å‘æ›´å¤šçš„é˜…è¯»ï¼Œå½¢æˆä¸€ä¸ªé£è½®æ•ˆåº”ï¼Œè®©è‡ªå·±çš„çŸ¥è¯†å˜å¾—è¶Šæ¥è¶Šä¸°å¯Œã€‚è€ŒçŸ¥è¯†çš„èä¼šè´¯é€šï¼Œæœ€ç»ˆå½¢æˆè¯»ä»£ç çš„ç¬¬ä¸‰å¤§åŠŸç”¨ï¼š<strong>é€šè¿‡äº†è§£ã€å¸æ”¶åˆ«äººçš„æ€æƒ³ï¼Œå»èŠœå­˜èï¼Œæœ€ç»ˆå½¢æˆè‡ªå·±çš„æ€æƒ³æˆ–è€…è¯´æ™ºæ…§</strong>ã€‚</p><p>å½“ç„¶ä»ç´ æã€åˆ°çŸ¥è¯†ã€å†åˆ°æ™ºæ…§ï¼Œè¦é•¿æœŸç§¯ç´¯ï¼Œå¹¶éä¸€æœä¸€å¤•ä¹‹åŠŸã€‚ææ˜ç™½â€œä¸ºä»€ä¹ˆâ€ç»™åˆ°æˆ‘ä»¬çš„ä¸‰ä¸ªå­¦ä¹ æ–¹å‘ï¼Œæ‰€ä»¥ç°åœ¨æ¥è¿›ä¸€æ­¥è§£å†³â€œå¦‚ä½•â€ï¼Œåˆ†äº«ä¸€ä¸‹æˆ‘çš„æ–¹æ³•è®ºï¼Œä¸ºä½ çš„ç§¯ç´¯åŠ©åŠ©åŠ›ã€‚</p><h2>å¦‚ä½•é˜…è¯»æºç å‘¢ï¼Ÿ</h2><p>æˆ‘ä»¬ä»¥ç¬¬ä¸‰æ–¹åº“ <a href=\"https://docs.rs/bytes/1.1.0/bytes/\">Bytes</a> ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹å¦‚ä½•é˜…è¯»æºç ã€‚å¸Œæœ›ä½ è·Ÿç€ä»Šå¤©çš„èŠ‚å¥èµ°ï¼Œä¸ç®¡æ˜¯å¦å…³å¿ƒ bytes çš„å®ç°ï¼Œéƒ½å…ˆä»¥å®ƒä¸ºè“æœ¬ï¼ŒæŠŠåŸºæœ¬æ–¹æ³•ç†Ÿæ‚‰ä¸€éï¼Œå†æ‰©å±•åˆ°æ›´å¤šä»£ç çš„é˜…è¯»ï¼Œæ¯”å¦‚ <a href=\"https://github.com/hyperium/hyper\">hyper</a>ã€<a href=\"https://github.com/Geal/nom\">nom</a>ã€<a href=\"https://github.com/tokio-rs/tokio\">tokio</a>ã€<a href=\"https://github.com/hyperium/tonic\">tonic</a> ç­‰ã€‚</p><p>Bytes æ˜¯ tokio ä¸‹ä¸€ä¸ªé«˜æ•ˆå¤„ç†ç½‘ç»œæ•°æ®çš„åº“ï¼Œä»£ç æœ¬èº« 3.5k LoCï¼ˆä¸åŒ…æ‹¬ 2.1k LoC æ³¨é‡Šï¼‰ï¼ŒåŠ ä¸Šæµ‹è¯• 5.3kã€‚ä»£ç ç»“æ„éå¸¸ç®€å•ï¼š</p><pre><code class=\"language-plain\">â¯ tree src\nsrc\nâ”œâ”€â”€ buf\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ buf_impl.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ buf_mut.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ chain.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ iter.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ limit.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ mod.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ reader.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ take.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ uninit_slice.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ vec_deque.rs\nâ”‚&nbsp;&nbsp; â””â”€â”€ writer.rs\nâ”œâ”€â”€ bytes.rs\nâ”œâ”€â”€ bytes_mut.rs\nâ”œâ”€â”€ fmt\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ debug.rs\nâ”‚&nbsp;&nbsp; â”œâ”€â”€ hex.rs\nâ”‚&nbsp;&nbsp; â””â”€â”€ mod.rs\nâ”œâ”€â”€ lib.rs\nâ”œâ”€â”€ loom.rs\nâ””â”€â”€ serde.rs\n</code></pre><p>èƒ½çœ‹åˆ°ï¼Œè„‰ç»œå¾ˆæ¸…æ™°ï¼Œæ˜¯å¾ˆå®¹æ˜“é˜…è¯»çš„ä»£ç ã€‚</p><p>å…ˆç®€å•è®²ä¸€ä¸‹è¯» Rust ä»£ç çš„é¡ºåºï¼šä» crate çš„å¤§çº²å¼€å§‹ï¼Œå…ˆäº†è§£ç›®æ ‡ä»£ç èƒ½å¹²ä»€ä¹ˆã€æ€ä¹ˆç”¨ï¼›ç„¶åå­¦ä¹ æ ¸å¿ƒ traitï¼Œçœ‹çœ‹å®ƒæ”¯æŒå“ªäº›åŠŸèƒ½ï¼›ä¹‹åå†æŒæ¡ä¸»è¦çš„æ•°æ®ç»“æ„ï¼Œå¼€å§‹å†™ä¸€äº›ç¤ºä¾‹ä»£ç ï¼›æœ€åå›´ç»•è‡ªå·±æ„Ÿå…´è¶£çš„æƒ…æ™¯æ·±å…¥é˜…è¯»ã€‚</p><p>è‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆè¯»ï¼Œæˆ‘ä»¬è¾¹è¯»è¾¹å…·ä½“è¯´æ˜ã€‚</p><h3>step1ï¼šä»å¤§çº²å¼€å§‹</h3><p>æˆ‘ä»¬å…ˆä»æ–‡æ¡£çš„å¤§çº²å…¥æ‰‹ã€‚Rust çš„æ–‡æ¡£ç³»ç»Ÿæ˜¯æ‰€æœ‰ç¼–ç¨‹è¯­è¨€ä¸­å¤„åœ¨ç¬¬ä¸€æ¢¯é˜Ÿçš„ï¼Œå³ä¾¿ä¸æ˜¯æœ€å¥½çš„ï¼Œä¹Ÿæ˜¯æœ€å¥½ä¹‹ä¸€ã€‚å®ƒçš„æ–‡æ¡£å’Œä»£ç ç»“åˆåœ°å¾ˆç´§å¯†ï¼Œå¯ä»¥æ¥å›è·³è½¬ã€‚</p><p>Rust å‡ ä¹æ‰€æœ‰åº“çš„æ–‡æ¡£éƒ½åœ¨ <a href=\"http://docs.rs\">docs.rs</a> ä¸‹ï¼Œæ¯”å¦‚ Bytes çš„æ–‡æ¡£å¯ä»¥é€šè¿‡ <a href=\"http://docs.rs/bytes\">docs.rs/bytes</a> è®¿é—®ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/90/0d/906b0aa11a124a1f57044180d2f4e30d.png?wh=2000x1623\" alt=\"\"></p><p>é¦–å…ˆé˜…è¯» crate çš„æ–‡æ¡£ï¼Œè¿™æ ·å¯ä»¥å¿«é€Ÿäº†è§£è¿™ä¸ª crate æ˜¯åšä»€ä¹ˆçš„ï¼Œå°±åƒé˜…è¯»ä¸€æœ¬ä¹¦çš„æ—¶å€™ï¼Œå¯ä»¥ä»ä¹¦çš„åºå’Œå‰è¨€å…¥æ‰‹äº†è§£æ¢—æ¦‚ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹ä¸€ä¸‹æºç æ ¹ç›®å½•ä¸‹çš„ <a href=\"https://github.com/tokio-rs/bytes\">README.md</a>ï¼Œä½œä¸ºè¡¥å……èµ„æ–™ã€‚</p><p>æœ‰äº†å¤§è‡´äº†è§£åï¼Œä½ å°±å¯ä»¥æ·±å…¥äº†è§£è‡ªå·±æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æˆ‘ä»¬å°±æŒ‰ç…§åˆå­¦çš„é¡ºåºæ¥çœ‹ã€‚</p><p>å¯¹äº Bytesï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒæœ‰ä¸¤ä¸ª trait Buf / BufMut ä»¥åŠä¸¤ä¸ªæ•°æ®ç»“æ„ Bytes/BytesMutï¼Œæ²¡æœ‰ crate çº§åˆ«çš„å‡½æ•°ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ·±å…¥é˜…è¯»ä»£ç äº†ã€‚</p><p>æˆ‘çœ‹çš„é¡ºåºä¸€èˆ¬æ˜¯ï¼štrait â†’ struct â†’ å‡½æ•°/æ–¹æ³•ã€‚å› ä¸ºè¿™å’Œæˆ‘ä»¬å†™ä»£ç çš„æ€è€ƒæ–¹å¼éå¸¸ç±»ä¼¼ï¼š</p><ul>\n<li>å…ˆä»éœ€æ±‚çš„æµç¨‹ä¸­æ•²å®šç³»ç»Ÿçš„è¡Œä¸ºï¼Œéœ€è¦å®šä¹‰ä»€ä¹ˆæ¥å£ traitï¼›</li>\n<li>å†è€ƒè™‘ç³»ç»Ÿæœ‰ä»€ä¹ˆçŠ¶æ€ï¼Œå®šä¹‰äº†å“ªäº›æ•°æ®ç»“æ„structï¼›</li>\n<li>æœ€ååˆ°å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬å¦‚ä½•ä¸ºæ•°æ®ç»“æ„å®ç° traitã€æ•°æ®ç»“æ„è‡ªèº«æœ‰ä»€ä¹ˆç®—æ³•ã€å¦‚ä½•æŠŠæ•´ä¸ªæµç¨‹ä¸²èµ·æ¥ç­‰ç­‰ã€‚</li>\n</ul><h3>step2ï¼šç†Ÿæ‚‰æ ¸å¿ƒ trait çš„è¡Œä¸º</h3><p>æ‰€ä»¥å…ˆçœ‹traitï¼Œæˆ‘ä»¬ä»¥ Buf trait ä¸ºä¾‹ã€‚ç‚¹è¿›å»çœ‹æ–‡æ¡£ï¼Œä¸»é¡µé¢ç»™äº†è¿™ä¸ª trait çš„å®šä¹‰å’Œä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/ed/6f/ed1233fce110cdfcdd1dceafa39c686f.png?wh=2000x1678\" alt=\"\"></p><p>æ³¨æ„å·¦ä¾§å¯¼èˆªæ çš„ â€œrequired Methodsâ€ å’Œ â€œProvided Methodsâ€ï¼Œå‰è€…æ˜¯å®ç°è¿™ä¸ª trait éœ€è¦å®ç°çš„æ–¹æ³•ï¼Œåè€…æ˜¯ç¼ºçœæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´æ•°æ®ç»“æ„åªè¦å®ç°äº†è¿™ä¸ª trait çš„ä¸‰ä¸ªæ–¹æ³•ï¼šadvance()ã€chunk() å’Œ remaining()ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°æ‰€æœ‰çš„ç¼ºçœæ–¹æ³•ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é‡è½½æŸä¸ªç¼ºçœæ–¹æ³•ã€‚</p><p>å¯¼èˆªæ ç»§ç»­å¾€ä¸‹æ‹‰ï¼Œå¯ä»¥çœ‹åˆ° bytes ä¸ºå“ªäº› â€œforeign typesâ€ å®ç°äº† Buf traitï¼Œä»¥åŠå½“å‰æ¨¡å—æœ‰å“ªäº› implementorsã€‚è¿™äº›ä¿¡æ¯å¾ˆé‡è¦ï¼Œè¯´æ˜äº†è¿™ä¸ª trait çš„ç”Ÿæ€ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/fa/52/fa15aba380f6ef942cc6143c6a90cc52.png?wh=2000x1655\" alt=\"\"></p><p>å¯¹äºå…¶å®ƒæ•°æ®ç±»å‹ï¼ˆforeign typeï¼‰ï¼š</p><ul>\n<li>åˆ‡ç‰‡ &amp;[u8]ã€VecDeque&lt;u8&gt; éƒ½å®ç°äº† Buf traitï¼›</li>\n<li>å¦‚æœ T æ»¡è¶³ Buf traitï¼Œé‚£ä¹ˆ &amp;mut Tã€Box&lt;T&gt; ä¹Ÿå®ç°äº† Buf traitï¼›</li>\n<li>å¦‚æœ T å®ç°äº† AsRef&lt;[u8]&gt;ï¼Œé‚£ Cursor&lt;T&gt; ä¹Ÿå®ç°äº† Buf traitã€‚</li>\n</ul><p>æ‰€ä»¥å›è¿‡å¤´æ¥ï¼Œä¸Šä¸€å¹…å›¾æ–‡æ¡£ç»™åˆ°çš„ç¤ºä¾‹ï¼Œä¸€ä¸ª &amp;[u8] å¯ä»¥ä½¿ç”¨ Buf trait é‡Œçš„æ–¹æ³•å°±é¡ºç†æˆç« äº†ï¼š</p><pre><code class=\"language-rust\">use bytes::Buf;\n\nlet mut buf = &amp;b\"hello world\"[..];\n\nassert_eq!(b'h', buf.get_u8());\nassert_eq!(b'e', buf.get_u8());\nassert_eq!(b'l', buf.get_u8());\n\nlet mut rest = [0; 8];\nbuf.copy_to_slice(&amp;mut rest);\n\nassert_eq!(&amp;rest[..], &amp;b\"lo world\"[..]);\n</code></pre><p>è€Œä¸”ä¹ŸçŸ¥é“äº†ï¼Œå¦‚æœæœªæ¥ä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„ T å®ç° Buf traitï¼Œé‚£ä¹ˆæˆ‘ä»¬æ— éœ€ä¸º Box&lt;T&gt;ï¼Œ&amp;mut T å®ç° Buf traitï¼Œè¿™çœå»äº†åœ¨å„ç§åœºæ™¯ä¸‹ä½¿ç”¨ T çš„è¯¸å¤šéº»çƒ¦ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç›®å‰è¿˜æ²¡æœ‰æ·±å…¥æºç ï¼Œä½†å·²ç»å¯ä»¥å­¦ä¹ åˆ°é«˜æ‰‹å®šä¹‰ trait çš„ä¸€äº›æ€è·¯ï¼š</p><ul>\n<li>å®šä¹‰å¥½ trait åï¼Œ<strong>å¯ä»¥è€ƒè™‘ä¸€ä¸‹æ ‡å‡†åº“çš„æ•°æ®ç»“æ„</strong>ï¼Œå“ªäº›å¯ä»¥å®ç°è¿™ä¸ª traitã€‚</li>\n<li>å¦‚æœæœªæ¥åˆ«äººçš„æŸä¸ªç±»å‹ T ï¼Œå®ç°äº†ä½ çš„ traitï¼Œ<strong>é‚£ä»–çš„ &amp;Tã€&amp;mut Tã€Box&lt;T&gt; ç­‰è¡ç”Ÿç±»å‹ï¼Œæ˜¯å¦èƒ½å¤Ÿè‡ªåŠ¨å®ç°è¿™ä¸ª trait</strong>ã€‚</li>\n</ul><p>å¥½ï¼Œæ¥ç€çœ‹å·¦ä¾§å¯¼èˆªæ ä¸­çš„ â€œimplementorsâ€ï¼ŒBytesã€BytesMutã€Chainã€Take éƒ½å®ç°äº† Buf traitï¼Œè¿™æ ·æˆ‘ä»¬çŸ¥é“äº†åœ¨è¿™ä¸ª crate é‡Œï¼Œå“ªäº›æ•°æ®ç»“æ„å®ç°äº†è¿™ä¸ª traitï¼Œä¹‹åé‡åˆ°å®ƒä»¬å°±çŸ¥é“éƒ½èƒ½ç”¨æ¥åšä»€ä¹ˆäº†ã€‚</p><p>ç°åœ¨ï¼Œå¯¹ Buf trait ä»¥åŠå›´ç»•ç€å®ƒçš„ç”Ÿæ€ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†ï¼Œåé¢ä½ å¯ä»¥ä»å‡ ä¸ªæ–¹å‘æ·±å…¥å­¦ä¹ ï¼š</p><ul>\n<li>Buf trait æŸä¸ªç¼ºçœæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ¯”å¦‚ <a href=\"https://docs.rs/bytes/1.1.0/src/bytes/buf/buf_impl.rs.html#287-292\">get_u8()</a>ã€‚</li>\n<li>å…¶å®ƒç±»å‹æ˜¯å¦‚ä½•å®ç° Buf trait çš„ï¼Œæ¯”å¦‚ <a href=\"https://docs.rs/bytes/1.1.0/src/bytes/buf/buf_impl.rs.html#1021-1036\">&amp;[u8]</a>ã€‚</li>\n</ul><p>ä½ ç”šè‡³ä¸ç”¨ clone bytes çš„æºç ï¼Œåœ¨ <a href=\"http://docs.rs\">docs.rs</a> é‡Œå°±å¯ä»¥ç›´æ¥å®Œæˆè¿™äº›ä»£ç çš„é˜…è¯»ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p><h3>step3ï¼šæŒæ¡ä¸»è¦çš„struct</h3><p>æ‰«å®Œ trait çš„åŸºæœ¬åŠŸèƒ½åï¼Œæˆ‘ä»¬å†æ¥çœ‹æ•°æ®ç»“æ„ã€‚ä»¥ Bytes è¿™ä¸ªç»“æ„ä¸ºä¾‹ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/bf/c5/bfcb8eb1288a30101bf4912dc52b1fc5.png?wh=2000x1580\" alt=\"\"></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¥½çš„æ–‡æ¡£ä¼šç»™å‡ºæ•°æ®ç»“æ„çš„ä»‹ç»ã€ç”¨æ³•ã€ä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹ï¼Œä»¥åŠä¸€äº›ä»£ç ç¤ºä¾‹ã€‚äº†è§£äº†æ•°æ®ç»“æ„çš„åŸºæœ¬ä»‹ç»åï¼Œç»§ç»­çœ‹çœ‹å®ƒçš„å†…éƒ¨ç»“æ„ï¼š</p><pre><code class=\"language-rust\">/// ```text\n///\n///    Arc ptrs                   +---------+\n///    ________________________ / | Bytes 2 |\n///   /                           +---------+\n///  /          +-----------+     |         |\n/// |_________/ |  Bytes 1  |     |         |\n/// |           +-----------+     |         |\n/// |           |           | ___/ data     | tail\n/// |      data |      tail |/              |\n/// v           v           v               v\n/// +-----+---------------------------------+-----+\n/// | Arc |     |           |               |     |\n/// +-----+---------------------------------+-----+\n/// ```\npub struct Bytes {\n    ptr: *const u8,\n    len: usize,\n    // inlined \"trait object\"\n    data: AtomicPtr&lt;()&gt;,\n    vtable: &amp;'static Vtable,\n}\n\npub(crate) struct Vtable {\n    /// fn(data, ptr, len)\n    pub clone: unsafe fn(&amp;AtomicPtr&lt;()&gt;, *const u8, usize) -&gt; Bytes,\n    /// fn(data, ptr, len)\n    pub drop: unsafe fn(&amp;mut AtomicPtr&lt;()&gt;, *const u8, usize),\n}\n</code></pre><p>æ•°æ®ç»“æ„çš„ä»£ç å¾€å¾€ä¼šæœ‰ä¸€äº›æ³¨é‡Šï¼Œå¸®åŠ©ä½ ç†è§£å®ƒçš„è®¾è®¡ã€‚å¯¹äº Bytes æ¥è¯´ï¼Œé¡ºç€ä»£ç å¾€ä¸‹çœ‹ï¼š</p><ul>\n<li>å®ƒå†…éƒ¨ä½¿ç”¨äº†è£¸æŒ‡é’ˆå’Œé•¿åº¦ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªåˆ‡ç‰‡ï¼ŒæŒ‡å‘å†…å­˜ä¸­çš„ä¸€ç‰‡è¿ç»­åœ°å€ï¼›</li>\n<li>åŒæ—¶ï¼Œè¿˜ä½¿ç”¨äº† AtomicPtr å’Œæ‰‹å·¥æ‰“é€ çš„ Vtable æ¥æ¨¡æ‹Ÿäº† trait object çš„è¡Œä¸ºã€‚</li>\n<li>çœ‹ Vtable çš„æ ·å­ï¼Œå¤§æ¦‚å¯ä»¥æ¨æ–­å‡º Bytes çš„ clone() å’Œ drop() çš„è¡Œä¸ºæ˜¯åŠ¨æ€çš„ï¼Œè¿™æ˜¯ä¸ªå¾ˆæœ‰æ„æ€çš„å‘ç°ã€‚</li>\n</ul><p>ä¸è¿‡å…ˆä¸å¿™ç»§ç»­æ¢ç´¢å®ƒå¦‚ä½•å®ç°è¿™ä¸ªè¡Œä¸ºçš„ï¼Œç»§ç»­çœ‹æ–‡æ¡£ã€‚</p><p>å’Œ trait ç±»ä¼¼çš„ï¼Œåœ¨å·¦ä¾§çš„å¯¼èˆªæ ï¼Œæœ‰ä¸€äº›å€¼å¾—å…³æ³¨çš„ä¿¡æ¯ï¼ˆä¸Šå›¾+ä¸‹å›¾ï¼‰ï¼šè¿™ä¸ªæ•°æ®ç»“æ„æœ‰å“ªäº›æ–¹æ³•ï¼ˆMethodsï¼‰ã€å®ç°äº†å“ªäº› traitï¼ˆTrait implementationsï¼‰ï¼Œä»¥åŠ Auto trait / Blanket trait çš„å®ç°ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/1e/f7/1e296bc11a95d7d3b293a426a4f95af7.png?wh=2000x1579\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒBytes é™¤äº†å®ç°äº†åˆšæ‰è®²è¿‡çš„ Buf trait å¤–ï¼Œè¿˜å®ç°äº†å¾ˆå¤šæ ‡å‡† traitã€‚</p><p>è¿™ä¹Ÿå¸¦ç»™æˆ‘ä»¬æ–°çš„å¯å‘ï¼š<strong>æˆ‘ä»¬è‡ªå·±çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿåº”è¯¥å°½å¯èƒ½å®ç°éœ€è¦çš„æ ‡å‡† trait</strong>ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šAsRefã€Borrowã€Cloneã€Debugã€Defaultã€Derefã€Dropã€PartialEq/Eqã€From&lt;T&gt;ã€Hashã€IntoIteratorï¼ˆå¦‚æœæ˜¯ä¸ªé›†åˆç±»å‹ï¼‰ã€PartialOrd/Ord ç­‰ã€‚</p><p>æ³¨æ„ï¼Œé™¤äº†è¿™äº› trait å¤–ï¼ŒBytes è¿˜å®ç°äº† Send / Syncã€‚å¦‚æœçœ‹å¾ˆå¤šæˆ‘ä»¬æ¥è§¦è¿‡çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ Vec&lt;T&gt;ï¼Œ<a href=\"https://doc.rust-lang.org/std/vec/struct.Vec.html#impl-Send\">Send / Sync æ˜¯è‡ªåŠ¨å®ç°çš„</a>ï¼Œä½† Bytes éœ€è¦æ‰‹å·¥å®ç°ï¼š</p><pre><code class=\"language-rust\">unsafe impl Send for Bytes {}\nunsafe impl Sync for Bytes {}\n</code></pre><p>è¿™æ˜¯å› ä¸ºä¹‹å‰è®²è¿‡ï¼Œå¦‚æœä½ çš„æ•°æ®ç»“æ„é‡Œä½¿ç”¨äº†ä¸æ”¯æŒ Send / Sync çš„ç±»å‹ï¼Œç¼–è¯‘å™¨é»˜è®¤è¿™ä¸ªæ•°æ®ç»“æ„ä¸èƒ½è·¨çº¿ç¨‹å®‰å…¨ä½¿ç”¨ï¼Œä¸ä¼šè‡ªåŠ¨æ·»åŠ  Send / Sync trait çš„å®ç°ã€‚ä½†å¦‚æœä½ èƒ½ç¡®ä¿è·¨çº¿ç¨‹çš„å®‰å…¨æ€§ï¼Œå¯ä»¥æ‰‹å·¥é€šè¿‡ unsafe impl å®ç°å®ƒä»¬ã€‚</p><p>äº†è§£ä¸€ä¸ªæ•°æ®ç»“æ„å®ç°äº†å“ªäº› traitï¼Œéå¸¸æœ‰åŠ©äºç†è§£å®ƒå¦‚ä½•ä½¿ç”¨ã€‚æ‰€ä»¥ï¼Œ<strong>æ ‡å‡†åº“é‡Œçš„ä¸»è¦ trait æˆ‘ä»¬ä¸€å®šè¦å¥½å¥½å­¦ä¹ ï¼Œå¤šå¤šä½¿ç”¨ï¼Œæœ€å¥½èƒ½å½¢æˆè‚Œè‚‰è®°å¿†</strong>ã€‚è¿™æ ·ï¼Œå­¦ä¹ åˆ«äººçš„ä»£ç æ—¶ï¼Œæ•ˆç‡ä¼šå¾ˆé«˜ã€‚æ¯”å¦‚æˆ‘çœ‹ Bytes è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œæ‰«ä¸€ä¸‹å®ƒå®ç°äº†å“ªäº› traitï¼Œå°±åŸºæœ¬èƒ½çŸ¥é“ï¼š</p><ul>\n<li>ä»€ä¹ˆæ•°æ®ç»“æ„å¯ä»¥è½¬åŒ–æˆ Bytesï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ç”Ÿæˆ Bytes ç»“æ„ï¼›</li>\n<li>Bytes å¯ä»¥è·Ÿè°æ¯”è¾ƒï¼›</li>\n<li>Bytes æ˜¯å¦å¯ä»¥è·¨çº¿ç¨‹ä½¿ç”¨ï¼›</li>\n<li>åœ¨ä½¿ç”¨ä¸­ï¼ŒBytes çš„è¡Œä¸ºå’Œè°æ¯”è¾ƒåƒï¼ˆçœ‹ Deref traitï¼‰ã€‚</li>\n</ul><p>è¿™å°±æ˜¯è‚Œè‚‰è®°å¿†çš„å¥½å¤„ã€‚ä½ å¯ä»¥å» <a href=\"http://crates.io\">crates.io</a> çš„ <a href=\"https://crates.io/categories/data-structures\">Data structures</a> ç±»åˆ«ä¸‹å¤šç¿»ç¿»ä¸åŒçš„åº“ï¼Œæ¯”å¦‚ <a href=\"https://docs.rs/indexmap/1.7.0/indexmap/map/struct.IndexMap.html\">IndexMap</a>ï¼Œçœ‹çœ‹å®ƒå®ç°äº†å“ªäº›æ ‡å‡† traitï¼Œä¸äº†è§£çš„å°±çœ‹çœ‹é‚£äº› trait çš„æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥å›é¡¾<a href=\"https://time.geekbang.org/column/article/421324\">ç¬¬ 14 è®²</a>ï¼ˆæœ‰å“ªäº›å¿…é¡»æŒæ¡çš„ traitï¼‰ã€‚</p><p>å½“ä½ äº†è§£äº†æ•°æ®ç»“æ„çš„åŸºæœ¬æ–‡æ¡£ï¼ŒçŸ¥é“å®ƒå®ç°äº†å“ªäº›æ–¹æ³•å’Œå“ªäº› trait åï¼ŒåŸºæœ¬ä¸Šï¼Œè¿™ä¸ªæ•°æ®ç»“æ„çš„ä½¿ç”¨å°±ä¸åœ¨è¯ä¸‹äº†ã€‚ä½ ä¹Ÿå¯ä»¥çœ‹æºä»£ç é‡Œçš„ examples ç›®å½•æˆ–è€… tests ç›®å½•ï¼Œçœ‹çœ‹æ•°æ®ç»“æ„å¯¹å¤–æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œä½œä¸ºå‚è€ƒã€‚</p><p>å¯¹äº bytes åº“ï¼Œå®ƒæ²¡æœ‰é¢å¤–çš„ examples ç›®å½•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹ <a href=\"https://github.com/tokio-rs/bytes/blob/master/tests/test_bytes.rs\">tests/test_bytes.rs</a> æ¥ç†è§£ Bytes ç±»å‹å¯ä»¥å¦‚ä½•ä½¿ç”¨ã€‚ç°åœ¨ï¼Œä½ åº”è¯¥èƒ½æ¯”è¾ƒä»å®¹åœ°ä½¿ç”¨è¿™ä¸ªBytes åº“äº†ï¼Œä¸å¦¨å°è¯•å†™ä¸€äº›è‡ªå·±çš„ç¤ºä¾‹ä»£ç ï¼Œæ„Ÿå—å®ƒçš„èƒ½åŠ›ã€‚</p><h3>step4ï¼šæ·±å…¥ç ”ç©¶å®ç°é€»è¾‘</h3><p>å½“ trait å’Œæ•°æ®ç»“æ„éƒ½æŒæ¡å¥½ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä»å®ƒçš„æ¥å£ä¸Šå­¦åˆ°å¾ˆå¤šå¼€å‘ä¸Šçš„æ€æƒ³å’ŒæŠ€å·§ï¼Œä¸€äº›å…³é”®æ¥å£ï¼Œä¹Ÿäº†è§£äº†è¶³å¤Ÿå¤šçš„å®ç°ç»†èŠ‚ã€‚è·å¾—çš„çŸ¥è¯†å¯¹ä½¿ç”¨è¿™ä¸ªåº“æ¥åšä¸€äº›äº‹æƒ…å·²ç»ç»°ç»°æœ‰ä½™ã€‚</p><p>å¤§éƒ¨åˆ†å¯¹æºä»£ç çš„å­¦ä¹ ï¼Œå¯ä»¥å°±æ­¤æ­¢æ­¥ã€‚å› ä¸ºå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œæ²¡æœ‰å¤ªå¯Œä½™çš„æ—¶é—´æŠŠæ¯ä¸ªé‡åˆ°çš„åº“éƒ½ä»å¤´åˆ°å°¾ç ”ç©¶ä¸€ç•ªï¼Œåªè¦ææ˜ç™½å¦‚ä½•ä½¿ç”¨å¥½ Rust ç”Ÿæ€ä¸­å¯ç”¨çš„åº“æ¥æ„å»ºæƒ³æ„å»ºçš„ç³»ç»Ÿï¼Œå°±è¶³å¤Ÿäº†ã€‚</p><p>ä½†æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ›´æ·±å…¥ä¸€æ­¥ã€‚</p><p>æ¯”å¦‚è¯´æƒ³æ›´å¥½åœ°ä½¿ç”¨è¿™ä¸ªåº“ï¼Œå¸Œæœ›è¿›ä¸€æ­¥äº†è§£ Bytes æ˜¯å¦‚ä½•åšåˆ°åœ¨å¤šçº¿ç¨‹ä¸­å¯ä»¥å…±äº«æ•°æ®çš„ï¼Œå®ƒè·Ÿ Arc&lt;Vec<u8>&gt; æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œ Arc&lt;Vec<u8>&gt; æ˜¯ä¸æ˜¯å¯ä»¥å®Œæˆ Bytes çš„å·¥ä½œï¼Ÿåˆæˆ–è€…è¯´ï¼Œåœ¨å®ç°æŸä¸ªç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿæƒ³åƒ Bytes è¿™æ ·ï¼Œå®ç°æ•°æ®ç»“æ„è‡ªå·±çš„ vtableï¼Œè®©æ•°æ®ç»“æ„æ›´çµæ´»ã€‚</u8></u8></p><p>è¿™æ—¶å°±è¦å»æ·±å…¥æŒ‰ä¸»é¢˜é˜…è¯»ä»£ç äº†ã€‚è¿™é‡Œæˆ‘æ¨è<strong>â€œä¸»é¢˜é˜…è¯»â€æˆ–è€…è¯´â€œæƒ…å¢ƒé˜…è¯»â€ï¼Œå°±æ˜¯å›´ç»•ç€ä¸€ä¸ªç‰¹å®šçš„ä½¿ç”¨åœºæ™¯ï¼Œä»¥è¿™ä¸ªåœºæ™¯çš„ä¸»æµç¨‹ä¸ºè„‰ç»œï¼Œææ˜ç™½å®ç°åŸç†</strong>ã€‚</p><p>è¿™æ—¶ï¼Œå…‰é  <a href=\"http://docs.rs\">docs.rs</a> ä¸Šçš„ä»£ç å·²ç»æ»¡è¶³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è¦æŠŠä»£ç  clone ä¸‹æ¥ï¼Œç”¨ VS Code æ‰“å¼€ä»”ç»†ç ”ç©¶ã€‚ä¸‹å›¾å±•ç¤ºäº†æœ¬åœ° ~/projects/opensource/rust ç›®å½•ä¸‹çš„ä»£ç ï¼Œå®ƒä»¬éƒ½æ˜¯æˆ‘åœ¨ä¸åŒæ—¶æœŸï¼Œä¸ºäº†ä¸åŒçš„ç›®çš„ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹é˜…è¯»è¿‡çš„æºä»£ç ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/f4/72/f40b8b4661582f593781a9ab6c1d8e72.png?wh=2000x305\" alt=\"\"></p><p>æˆ‘ä»¬å°±ç»§ç»­ä»¥ Bytes å¦‚ä½•å®ç°è‡ªå·±çš„ vtable ä¸ºä¾‹ï¼Œæ·±å…¥çœ‹ Bytes æ˜¯å¦‚ä½• clone çš„ï¼Ÿçœ‹ clone çš„å®ç°ï¼š</p><pre><code class=\"language-rust\">impl Clone for Bytes {\n    #[inline]\n    fn clone(&amp;self) -&gt; Bytes {\n        unsafe { (self.vtable.clone)(&amp;self.data, self.ptr, self.len) }\n    }\n}\n</code></pre><p>å®ƒç”¨äº† vtable çš„ clone æ–¹æ³•ï¼Œä¼ å…¥äº† data ï¼ŒæŒ‡å‘æ•°æ®çš„æŒ‡é’ˆä»¥åŠé•¿åº¦ã€‚æ ¹æ®è¿™ä¸ªä¿¡æ¯ï¼Œæˆ‘ä»¬å¦‚æœèƒ½æ‰¾åˆ° Bytes å®šä¹‰çš„æ‰€æœ‰ vtableï¼Œä»¥åŠæ¯ä¸ª vtable çš„ clone() åšäº†ä»€ä¹ˆäº‹ï¼Œå°±è¶³ä»¥äº†è§£ Bytes æ˜¯å¦‚ä½•å®ç° vtable çš„äº†ã€‚</p><p>å› ä¸ºè¿™ä¸€è®²å¹¶éè®²è§£ Bytes æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå°±ä¸è¯¦ç»†ä¸€æ­¥æ­¥å¸¦è¯»ä»£ç äº†ã€‚ç›¸ä¿¡ä½ å¾ˆå¿«ä»ä»£ç ä¸­èƒ½å¤Ÿæ‰¾åˆ° STATIC_VTABLEã€PROMOTABLE_EVEN_VTABLEã€PROMOTABLE_ODD_VTABLE å’Œ SHARED_VTABLE è¿™å››å¼ è¡¨ã€‚</p><p>åä¸‰å¼ è¡¨æ˜¯å¤„ç†åŠ¨æ€æ•°æ®çš„ï¼Œåœ¨ä½¿ç”¨æ—¶å¦‚æœ Bytes çš„æ¥æºæ˜¯ Vec&lt;u8&gt;ã€Box&lt;[u8]&gt; æˆ–è€… Stringï¼Œå®ƒä»¬ç»Ÿç»Ÿè¢«è½¬æ¢æˆ Box&lt;[u8]&gt;ï¼Œå¹¶åœ¨ç¬¬ä¸€æ¬¡ clone() æ—¶ï¼Œç”Ÿæˆç±»ä¼¼ Arc&lt;T&gt; çš„ Shared ç»“æ„ï¼Œç»´æŠ¤å¼•ç”¨è®¡æ•°ã€‚</p><p>ç”±äº Bytes çš„ ptr æŒ‡å‘è¿™ä¸ª Bytes çš„èµ·å§‹åœ°å€ï¼Œè€Œ data æŒ‡å‘å¼•ç”¨è®¡æ•°çš„åœ°å€ï¼Œæ‰€ä»¥ï¼Œä½ å¯ä»¥åœ¨è¿™æ®µå†…å­˜ä¸Šï¼Œç”Ÿæˆä»»æ„å¤šçš„ã€å¤§å°ä¸åŒã€èµ·å§‹ä½ç½®ä¸ä¸€æ ·çš„ Bytes ç»“æ„ï¼Œå®ƒä»¬éƒ½</p><p>ç”¨åŒä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚è¿™è¦æ¯” Arc&lt;Vec<t>&gt; è¦çµæ´»å¾—å¤šã€‚å…·ä½“æµç¨‹ï¼Œä½ å¯ä»¥çœ‹ä¸‹å›¾ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/6f/56/6f951352fbff84e0c2b93e84cea53d56.jpg?wh=3225x2485\" alt=\"\"></t></p><p>åœ¨å›´ç»•ç€æƒ…æ™¯è¯»ä»£ç æ—¶ï¼Œ<strong>å»ºè®®ä½ ä½¿ç”¨ç»˜å›¾å·¥å…·ï¼Œè¾¹è¯»è¾¹è®°å½•</strong>ï¼ˆæˆ‘ç”¨çš„excalidrawï¼‰ï¼Œéå¸¸æœ‰åŠ©äºä½ ç†è§£ä»£ç è„‰ç»œï¼Œä¸è‡³äºåœ¨æ— ç©·æ— å°½çš„è·³è½¬ä¸­è¿·å¤±äº†æ–¹å‘ã€‚</p><p>åŒæ—¶ï¼Œå–„ç”¨ gdb ç­‰å·¥å…·æ¥è¾…åŠ©é˜…è¯»ï¼Œå°±åƒç¬¬ 17 è®²æˆ‘ä»¬å‰–æ HashMap ç»“æ„é‚£æ ·ã€‚ä¸€ä¸ªåœºæ™¯ç†è§£å®Œæ¯•ï¼Œè¿™å¼ è„‰ç»œå›¾ä¹Ÿå‡ºæ¥äº†ï¼Œä½ å¯ä»¥å¯¹å®ƒç¨ä½œæ•´ç†ï¼Œä½¿å…¶æˆä¸ºè‡ªå·±çŸ¥è¯†åº“çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ä½ ä¹Ÿå¯ä»¥åœ¨å›¢é˜Ÿå†…éƒ¨çš„åˆ†äº«ä¼šä¸Šï¼Œå¯¹ç€å›¾æ¥åˆ†äº«ä»£ç ï¼Œå¸®åŠ©å›¢é˜Ÿæ›´å¥½åœ°ç†è§£æŸäº›å¤æ‚çš„é€»è¾‘ã€‚æ‰€è°“ learning by teachingï¼Œåœ¨åˆ†äº«çš„è¿‡ç¨‹ä¸­ï¼Œç›¸å½“äºåˆå­¦äº†ä¸€éï¼Œä¹Ÿè®¸ä¹‹å‰è¿·èŒ«çš„åœ°æ–¹ä¼šèŒ…å¡é¡¿å¼€ï¼Œä¹Ÿè®¸åˆ«äººä¸€ä¸ªä¸ç»æ„çš„é—®é¢˜ä¼šè®©ä½ æ€è€ƒä¹‹å‰æ²¡æœ‰æƒ³åˆ°çš„ç‚¹ã€‚</p><h2>å°ç»“</h2><p>é˜…è¯»åˆ«äººçš„ä»£ç ï¼Œå°¤å…¶æ˜¯ä¼˜ç§€çš„ä»£ç ï¼Œèƒ½å¸®åŠ©ä½ å¿«é€Ÿåœ°æˆé•¿ã€‚</p><p>Rust ä¸ºäº†è®©ä»£ç å’Œæ–‡æ¡£å¯è¯»æ€§æ›´å¼ºï¼Œåœ¨å·¥å…·é“¾ä¸Šåšäº†å·¨å¤§çš„åŠªåŠ›ï¼Œè®©æˆ‘ä»¬åœ¨è¯»æºç æˆ–è€…åˆ«äººä»£ç çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“å˜æ¸…ä»£ç çš„ä¸»è¦æµç¨‹å’Œä½¿ç”¨æ–¹å¼ã€‚ä»Šå¤©è®²çš„é˜…è¯»ä»£ç å°¤å…¶æ˜¯é˜…è¯» Rust ä»£ç çš„å¾ˆå¤šæŠ€å·§ï¼Œå°‘æœ‰äººåˆ†äº«ä½†åˆå¾ˆé‡è¦ï¼ŒæŒæ¡å¥½å®ƒï¼Œä½ å°±æŒæ¡äº†é€šå‘å¤§ç‰›ä¹‹è·¯çš„é’¥åŒ™ã€‚</p><p>æ³¨æ„é˜…è¯»çš„é¡ºåºï¼šä»å¤§çº²å¼€å§‹ï¼Œå…ˆäº†è§£ç›®æ ‡ä»£ç èƒ½å¹²ä»€ä¹ˆï¼Œæ€ä¹ˆç”¨ï¼›ç„¶åå­¦ä¹ å®ƒçš„ä¸»è¦ traitï¼›ä¹‹åæ˜¯æ•°æ®ç»“æ„ï¼Œææ˜ç™½åå†çœ‹çœ‹ç¤ºä¾‹ä»£ç ï¼ˆexamplesï¼‰æˆ–è€…é›†æˆæµ‹è¯•ï¼ˆtestsï¼‰ï¼Œè‡ªå·±å†™ä¸€äº›ç¤ºä¾‹ä»£ç ï¼›æœ€åï¼Œå›´ç»•ç€è‡ªå·±æ„Ÿå…´è¶£çš„æƒ…æ™¯æ·±å…¥é˜…è¯»ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä»£ç éƒ½éœ€è¦èµ°åˆ°æœ€åä¸€æ­¥ï¼Œä½ è¦æ ¹æ®è‡ªå·±çš„éœ€è¦å’Œç²¾åŠ›é‡åŠ›è€Œè¡Œã€‚</p><h3>æ€è€ƒé¢˜</h3><p>1.æˆ‘ä»¬ä¸€èµ·å¤§è‡´åˆ†æäº† Bytes çš„ clone() çš„ä½¿ç”¨çš„åœºæ™¯ï¼Œä½ èƒ½ç”¨ç±»ä¼¼çš„æ–¹å¼ç ”ç©¶ä¸€ä¸‹ drop() æ˜¯æ€ä¹ˆå·¥ä½œçš„ä¹ˆï¼Ÿ</p><p>2.ä»”ç»†çœ‹ Buf trait é‡Œçš„æ–¹æ³•ï¼Œæƒ³æƒ³ä¸ºä»€ä¹ˆå®ƒä¸º &amp;mut T å®ç°äº† Buf traitï¼Œä½†æ²¡æœ‰ä¸º &amp;T å®ç° Buf trait å‘¢ï¼Ÿå¦‚æœä½ è®¤ä¸ºä½ æ‰¾åˆ°äº†ç­”æ¡ˆï¼Œå†æƒ³æƒ³ä¸ºä»€ä¹ˆå®ƒå¯ä»¥ä¸º &amp;[u8] å®ç° Buf trait å‘¢ï¼Ÿ</p><p>3.èŠ±ç‚¹æ—¶é—´çœ‹çœ‹ BufMut trait çš„æ–‡æ¡£ã€‚Vec<u8> å¯ä»¥ä½¿ç”¨ BufMut ä¹ˆï¼Ÿå¦‚æœå¯ä»¥ï¼Œè¯•ç€å†™å†™ä»£ç åœ¨ Vec<u8> ä¸Šè°ƒç”¨ BufMut çš„å„ç§æ¥å£ï¼Œæ„Ÿå—ä¸€ä¸‹ã€‚</u8></u8></p><p>4.å¦‚æœæœ‰ä½™åŠ›ï¼Œå¯ä»¥ç ”ç©¶ä¸€ä¸‹ BytesMutã€‚é‡ç‚¹çœ‹ä¸€ä¸‹ split_off() æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«è‡ªå·±è¯»æºç çš„ä¸€äº›æ•…äº‹ï¼Œæ¬¢è¿æŠ¢ç­”æ€è€ƒé¢˜ã€‚æ„Ÿè°¢ä½ çš„ä¸€è·¯åšæŒï¼Œä»Šå¤©ä½ å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬20æ¬¡æ‰“å¡ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å¼€å§‹ç¬¬ä¸€ä¸ªé˜¶æ®µçš„å®æ“ï¼Œä¸‹èŠ‚è¯¾è§ï½</p><h2>å‚è€ƒèµ„æ–™</h2><p>å¦‚æœåœ¨é˜…è¯» Bytes çš„ clone() åœºæ™¯æ—¶ï¼Œå¯¹äº PROMOTABLE_EVEN_VTABLEã€PROMOTABLE_ODD_VTABLE è¿™ä¸¤å¼ è¡¨æ¯”è¾ƒè¿·æƒ‘ï¼Œä¸”ä¸æ˜ç™½ä¸ºä»€ä¹ˆä¼šæ ¹æ® ptr &amp; 0x1 æ˜¯å¦ç­‰äº 0 æ¥æä¾›ä¸åŒçš„ vtableï¼š</p><pre><code class=\"language-rust\">impl From&lt;Box&lt;[u8]&gt;&gt; for Bytes {\n    fn from(slice: Box&lt;[u8]&gt;) -&gt; Bytes {\n        // Box&lt;[u8]&gt; doesn't contain a heap allocation for empty slices,\n        // so the pointer isn't aligned enough for the KIND_VEC stashing to\n        // work.\n        if slice.is_empty() {\n            return Bytes::new();\n        }\n\n        let len = slice.len();\n        let ptr = Box::into_raw(slice) as *mut u8;\n\n        if ptr as usize &amp; 0x1 == 0 {\n            let data = ptr as usize | KIND_VEC;\n            Bytes {\n                ptr,\n                len,\n                data: AtomicPtr::new(data as *mut _),\n                vtable: &amp;PROMOTABLE_EVEN_VTABLE,\n            }\n        } else {\n            Bytes {\n                ptr,\n                len,\n                data: AtomicPtr::new(ptr as *mut _),\n                vtable: &amp;PROMOTABLE_ODD_VTABLE,\n            }\n        }\n    }\n}\n</code></pre><p>è¿™æ˜¯å› ä¸ºï¼ŒBox&lt;[u8]&gt; æ˜¯ 1 å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥ Box&lt;[u8]&gt; æŒ‡å‘çš„å †åœ°å€å¯èƒ½æœ«å°¾æ˜¯ 0 æˆ–è€… 1ã€‚è€Œ data è¿™ä¸ª AtomicPtr æŒ‡é’ˆï¼Œåœ¨æŒ‡å‘ Shared ç»“æ„æ—¶ï¼Œè¿™ä¸ªç»“æ„çš„å¯¹é½æ˜¯ 2/4/8 å­—èŠ‚ï¼ˆ16/32/64 ä½ CPU ä¸‹ï¼‰ï¼Œæœ«å°¾ä¸€å®šä¸º 0ï¼š</p><pre><code class=\"language-rust\">struct Shared {\n    // holds vec for drop, but otherwise doesnt access it\n    _vec: Vec&lt;u8&gt;,\n    ref_cnt: AtomicUsize,\n}\n</code></pre><p>æ‰€ä»¥è¿™é‡Œç”¨äº†ä¸€ä¸ªå°æŠ€å·§ï¼Œä»¥ data æŒ‡é’ˆæœ«å°¾æ˜¯å¦ä¸º 0x1 æ¥åŒºåˆ«ï¼Œå½“å‰çš„ Bytes æ˜¯å‡çº§æˆå…±äº«ï¼Œç±»ä¼¼äº Arc çš„ç»“æ„ï¼ˆKIND_ARCï¼‰ï¼Œè¿˜æ˜¯ä¾æ—§åœç•™åœ¨éå…±äº«çš„ï¼Œç±»ä¼¼ Vec çš„ç»“æ„ï¼ˆKIND_VECï¼‰ã€‚<br>\nè¿™ä¸ªå¤ç”¨æŒ‡é’ˆæœ€åå‡ ä¸ª bit è®°å½•ä¸€äº› flag çš„å°æŠ€å·§ï¼Œåœ¨å¾ˆå¤šç³»ç»Ÿä¸­éƒ½ä¼šä½¿ç”¨ã€‚æ¯”å¦‚ Erlang VMï¼Œåœ¨å­˜å‚¨ list æ—¶ï¼Œå› ä¸ºåœ°å€çš„å¯¹é½ï¼Œæœ€åä¸¤ä¸ª bit ä¸ä¼šè¢«ç”¨åˆ°ï¼Œæ‰€ä»¥å½“æœ€åä¸€ä¸ª bit æ˜¯ 1 æ—¶ï¼Œä»£è¡¨è¿™æ˜¯ä¸ªæŒ‡å‘ list å…ƒç´ çš„åœ°å€ã€‚è¿™ç§æŠ€å·§ï¼Œå¦‚æœä½ ä¸çŸ¥é“çš„è¯ï¼Œçœ‹ä»£ç ä¼šå¾ˆæ‡µï¼Œä¸€æ—¦äº†è§£å°±æ²¡é‚£ä¹ˆç¥ç§˜äº†ã€‚</p><p>å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œæ¬¢è¿åˆ†äº«ï½</p>","neighbors":{"left":{"article_title":"19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ","id":424009},"right":{"article_title":"21ï½œé˜¶æ®µå®æ“ï¼ˆ1ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-åŸºæœ¬æµç¨‹","id":425001}},"comments":[{"had_liked":false,"id":315962,"user_name":"Geek_1b6d74","can_delete":false,"product_type":"c1","uid":2420574,"ip_address":"","ucode":"A0847D91919B7F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Fr0y2ad4CLZNN0iaokfdyfAGwzMdttoIVfgzjBlwaCW2YB26mZta4v6pI2DV0OibCeC1OhME7NmrZo9OoRAfIhwQ/132","comment_is_top":false,"comment_ctime":1634088259,"is_pvip":false,"replies":[{"id":"115283","content":"è¿‡å¥–äº†ï¼:)","user_name":"ä½œè€…å›å¤","comment_id":315962,"uid":"1079375","ip_address":"","utype":1,"ctime":1635132445,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"35993826627","product_id":100085301,"comment_content":"é™ˆå¤©å¤§ç¥å¤ªå¼ºäº†ï¼Œå­¦ä¹ ä»–çš„è¯¾ç¨‹ä¸ä»…å­¦ä¹ äº†ä¸€é—¨æ–°çš„è¯­è¨€ï¼Œè¿˜å¼„æ˜ç™½äº†å¾ˆå¤šç¼–ç¨‹åº•å±‚åŸç†","like_count":9,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528216,"discussion_content":"è¿‡å¥–äº†ï¼:)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322476,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1637405892,"is_pvip":false,"replies":[{"id":"118905","content":":) æŒæ¡å¥½è¿™ä¸€ç« å°±å¥½äº†å•Š","user_name":"ä½œè€…å›å¤","comment_id":322476,"uid":"1079375","ip_address":"","utype":1,"ctime":1639851974,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"23112242372","product_id":100085301,"comment_content":"è€å¸ˆï¼Œä¸“é—¨å¼€ä¸€æœŸå¦‚ä½•è¯»å¼€æºé¡¹ç›®æºç å§ï¼ŒçœŸçš„ï¼Œè¿™ä¸ªæ¯”æ‡‚ä»»ä½•æŠ€å·§éƒ½æ›´æœ‰æ„ä¹‰ï¼Œç›®å‰ä¹Ÿæ²¡æœ‰æ•™è¿™ä¸ªçš„ã€‚","like_count":6,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539866,"discussion_content":":) æŒæ¡å¥½è¿™ä¸€ç« å°±å¥½äº†å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639851974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319156,"user_name":"æ¸æçº¢èŒ¶","can_delete":false,"product_type":"c1","uid":2738941,"ip_address":"","ucode":"03D80953AF984E","user_header":"https://static001.geekbang.org/account/avatar/00/29/ca/fd/4e6dd31c.jpg","comment_is_top":false,"comment_ctime":1635645889,"is_pvip":false,"replies":[{"id":"116392","content":"å“ˆå“ˆï¼Œæ”¾ä¸‹ä½ æ³¡å¥½æ¸æçº¢èŒ¶çš„ä¿æ¸©æ¯ï¼Œä¸€èµ·æ­»ç£• Rust :)","user_name":"ä½œè€…å›å¤","comment_id":319156,"uid":"1079375","ip_address":"","utype":1,"ctime":1636556597,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"10225580481","product_id":100085301,"comment_content":"æˆ‘åŸæœ¬å‡†å¤‡å»è¶…å¸‚æ‘¸é±¼ï¼Œé™ˆå¤©è€å¸ˆç»™æˆ‘æ¸”èˆ¹æŠŠæˆ‘æ‰”åˆ°äº†å¤§æµ·é‡Œ","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529524,"discussion_content":"å“ˆå“ˆï¼Œæ”¾ä¸‹ä½ æ³¡å¥½æ¸æçº¢èŒ¶çš„ä¿æ¸©æ¯ï¼Œä¸€èµ·æ­»ç£• Rust :)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636556597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320478,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1636348291,"is_pvip":false,"replies":[{"id":"116396","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":320478,"uid":"1079375","ip_address":"","utype":1,"ctime":1636556969,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"5931315587","product_id":100085301,"comment_content":"1. æˆ‘ä»¬ä¸€èµ·å¤§è‡´åˆ†æäº† Bytes çš„ clone() çš„ä½¿ç”¨çš„åœºæ™¯ï¼Œä½ èƒ½ç”¨ç±»ä¼¼çš„æ–¹å¼ç ”ç©¶ä¸€ä¸‹ drop() æ˜¯æ€ä¹ˆå·¥ä½œçš„ä¹ˆï¼Ÿ<br><br>å¦‚æœæ˜¯Shared, å°±åƒArcé‚£æ ·decrease counter; å¦‚æœæ˜¯KIND_VEC, with unique ownership, deallocate memory immediately.<br><br>    unsafe fn promotable_odd_drop(data: &amp;mut AtomicPtr&lt;()&gt;, ptr: *const u8, len: usize) {<br>        data.with_mut(|shared| {<br>            let shared = *shared;<br>            let kind = shared as usize &amp; KIND_MASK;<br>            if kind == KIND_ARC {<br>                release_shared(shared as *mut Shared);<br>            } else {<br>                debug_assert_eq!(kind, KIND_VEC);<br>                drop(rebuild_boxed_slice(shared as *mut u8, ptr, len));<br>            }<br>        });<br>    }<br><br>2. ä»”ç»†çœ‹ Buf trait é‡Œçš„æ–¹æ³•ï¼Œæƒ³æƒ³ä¸ºä»€ä¹ˆå®ƒä¸º &amp;mut T å®ç°äº† Buf traitï¼Œä½†æ²¡æœ‰ä¸º &amp;T å®ç° Buf trait å‘¢ï¼Ÿå¦‚æœä½ è®¤ä¸ºä½ æ‰¾åˆ°äº†ç­”æ¡ˆï¼Œå†æƒ³æƒ³ä¸ºä»€ä¹ˆå®ƒå¯ä»¥ä¸º &amp;[u8] å®ç° Buf trait å‘¢ï¼Ÿ<br><br>å› ä¸ºadvance methodéœ€è¦æ›´æ”¹Tå†…éƒ¨çŠ¶æ€<br><br>    fn advance(&amp;mut self, cnt: usize) {<br><br>3. èŠ±ç‚¹æ—¶é—´çœ‹çœ‹ BufMut trait çš„æ–‡æ¡£ã€‚Vec å¯ä»¥ä½¿ç”¨ BufMut ä¹ˆï¼Ÿå¦‚æœå¯ä»¥ï¼Œè¯•ç€å†™å†™ä»£ç åœ¨ Vec ä¸Šè°ƒç”¨ BufMut çš„å„ç§æ¥å£ï¼Œæ„Ÿå—ä¸€ä¸‹ã€‚<br><br>åªèƒ½åœ¨`Vec&lt;u8&gt;` ä¸Šç”¨; è·Ÿç€docè¯•äº†ä¸€ä¸‹.<br><br>å€¼å¾—æ³¨æ„çš„æ˜¯, `advance_mut`æ˜¯ `unsafe`:<br><br>        #[inline]<br>        unsafe fn advance_mut(&amp;mut self, cnt: usize) {<br>            let len = self.len();<br>            let remaining = self.capacity() - len;<br>            assert!(<br>                cnt &lt;= remaining,<br>                &quot;cannot advance past `remaining_mut`: {:?} &lt;= {:?}&quot;,<br>                cnt,<br>                remaining<br>            );<br>            self.set_len(len + cnt);<br>        }<br><br>4. å¦‚æœæœ‰ä½™åŠ›ï¼Œå¯ä»¥ç ”ç©¶ä¸€ä¸‹ BytesMutã€‚é‡ç‚¹çœ‹ä¸€ä¸‹ split_off() æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚<br><br>`split_off` ä¹Ÿæ˜¯æ ¹æ®kindæ¥:<br><br>- å¦‚æœæ˜¯KIND_VEC, å°±å˜æˆä¸¤ä¸ªArc, å…±äº«åŒä¸€ä¸ªbuf pointer<br>- å¦‚æœæ˜¯KIND_ARC, å°±increase ref count, è®¾ç½®ä¸åŒçš„start, end<br><br>æ„Ÿè§‰çœŸæ­£å›°éš¾çš„æ˜¯ `reserve` å’Œ `resize`; è¿™ä¸¤ä¸ªmethodè¦æ±‚KIND_ARC; è¿™æ ·, æ‰€æœ‰outgoingçš„`BytesMut` èƒ½view underlying Vec pointer change during reallocation","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530006,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636556969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320038,"user_name":"Geek_b52974","can_delete":false,"product_type":"c1","uid":1298252,"ip_address":"","ucode":"59884399646620","user_header":"","comment_is_top":false,"comment_ctime":1636048045,"is_pvip":true,"replies":[{"id":"116346","content":"å¯¹","user_name":"ä½œè€…å›å¤","comment_id":320038,"uid":"1079375","ip_address":"","utype":1,"ctime":1636526167,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"5931015341","product_id":100085301,"comment_content":"çœ‹å¾Œé¢çš„è§£é‡‹é‚„æ˜¯æœ‰é»æ‡µï¼Œæˆ‘è©¦è‘—ç…§è‡ªå·±çš„ç†è§£èªªæ˜<br>æœ€å¾Œä¸€ä½æ˜¯ç”¨ä¾†è¨˜éŒ„æ˜¯å¦æ˜¯ shared<br>ä½†æ˜¯æˆ‘å€‘æœƒéœ€è¦çŸ¥é“å‡ç´šæˆ shared å‰æœ€å¾Œä¸€ä½æ˜¯ odd é‚„æ˜¯ event æ‰€ä»¥ç”¨   PROMOTABLE_ODD_VTABLE PROMOTABLE_EVENT_VTABLE ä¾†åšä¸åŒçš„ clone æ–¹å¼<br><br>```<br>unsafe fn promotable_even_clone(data: &amp;AtomicPtr&lt;()&gt;, ptr: *const u8, len: usize) -&gt; Bytes {<br>    let shared = data.load(Ordering::Acquire);<br>    let kind = shared as usize &amp; KIND_MASK;<br><br>    if kind == KIND_ARC {<br>        shallow_clone_arc(shared as _, ptr, len)<br>    } else {<br>        debug_assert_eq!(kind, KIND_VEC);<br>        let buf = (shared as usize &amp; !KIND_MASK) as *mut u8;<br>        shallow_clone_vec(data, shared, buf, ptr, len)<br>    }<br>}<br>```<br>promotable_event_clone ç›¸æ¯” promotable_odd_clone å¤šäº†ä¸‹é¢é€™å€‹æ“ä½œ<br>let buf = (shared as usize &amp; !KIND_MASK) as *mut u8;<br><br>å…ˆæŠŠæœ€å¾Œä¸€ä½é‚„åŸæˆåŸæœ¬çš„æ¨£å­ï¼Œå†é€²è¡Œ clone<br>ä¸çŸ¥é“é€™æ¨£ç†è§£å°ä¸å°","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529850,"discussion_content":"å¯¹","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636526167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315008,"user_name":"Geek2014","can_delete":false,"product_type":"c1","uid":2028957,"ip_address":"","ucode":"9EB356D8DF287E","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f5/9d/104bb8ea.jpg","comment_is_top":false,"comment_ctime":1633657343,"is_pvip":false,"replies":[{"id":"114114","content":"å•Šï¼Œå¤šè°¢å‘ç°ï¼è¿™é‡Œæ˜¯ç¬”è¯¯ï¼Œåº”è¯¥æ˜¯ä¸€å®šä¸º 0ã€‚ä¸º 0 æ‰å¯ä»¥å€Ÿç”¨æœ€åä¸€ä½è®¾ç½®æ˜¯å¦æ˜¯ shared æ ‡å¿—ã€‚è¿™æ˜¯ä¸Šä¸‹æ–‡çš„é€»è¾‘ã€‚æˆ‘è®©ç¼–è¾‘æ›´æ–°ä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","comment_id":315008,"uid":"1079375","ip_address":"","utype":1,"ctime":1633709404,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"5928624639","product_id":100085301,"comment_content":"è€Œ data è¿™ä¸ª AtomicPtr æŒ‡é’ˆï¼Œåœ¨æŒ‡å‘ Shared ç»“æ„æ—¶ï¼Œè¿™ä¸ªç»“æ„çš„å¯¹é½æ˜¯ 2&#47;4&#47;8 å­—èŠ‚ï¼ˆ16&#47;32&#47;64 ä½ CPU ä¸‹ï¼‰ï¼Œæœ«å°¾ä¸€å®šä¸ä¸º 0ï¼š<br><br>è€å¸ˆï¼Œä¸ºå•¥å¯¹é½2&#47;4&#47;8å­—èŠ‚ï¼Œæœ«å°¾ä¸€å®šä¸ä¸º0å‘¢","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527855,"discussion_content":"å•Šï¼Œå¤šè°¢å‘ç°ï¼è¿™é‡Œæ˜¯ç¬”è¯¯ï¼Œåº”è¯¥æ˜¯ä¸€å®šä¸º 0ã€‚ä¸º 0 æ‰å¯ä»¥å€Ÿç”¨æœ€åä¸€ä½è®¾ç½®æ˜¯å¦æ˜¯ shared æ ‡å¿—ã€‚è¿™æ˜¯ä¸Šä¸‹æ–‡çš„é€»è¾‘ã€‚æˆ‘è®©ç¼–è¾‘æ›´æ–°ä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633709404,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358123,"user_name":"è¿›å‡»çš„Lancelot","can_delete":false,"product_type":"c1","uid":2620407,"ip_address":"å¹¿ä¸œ","ucode":"3BCC355801DC61","user_header":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","comment_is_top":false,"comment_ctime":1663921267,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1663921267","product_id":100085301,"comment_content":"é’ˆå¯¹æ€è€ƒé¢˜ï¼š<br><br>1.æ¥çœ‹ä¸€æ®µ promotable_even_drop çš„ä»£ç ï¼Œå®ƒä¼šå…ˆåˆ¤æ–­ä¿å­˜åœ¨ data(AtomicPtr) ä¸­çš„æ•°æ®æ˜¯å¦æ˜¯å…±äº«çš„ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è°ƒç”¨ release_shared è¿›è¡Œé‡Šæ”¾(shared_drop ç›´æ¥æ‰§è¡Œè¿™ä¸€æ­¥å³å¯)ï¼›å¦‚æœä¸æ˜¯å…±äº«æ•°æ®ï¼Œåˆ™å…ˆæ¶ˆé™¤ data ä¸­æ•°æ®æœ€åä¸€ä½çš„ flagï¼Œç„¶åè°ƒç”¨free_boxed_slice è¿›è¡Œé‡Šæ”¾<br>unsafe fn promotable_even_drop(data: &amp;mut AtomicPtr&lt;()&gt;, ptr: *const u8, len: usize) {<br>    data.with_mut(|shared| {<br>        let shared = *shared;<br>        let kind = shared as usize &amp; KIND_MASK;<br><br>        if kind == KIND_ARC {<br>            release_shared(shared.cast());<br>        } else {<br>            debug_assert_eq!(kind, KIND_VEC);<br>            let buf = ptr_map(shared.cast(), |addr| addr &amp; !KIND_MASK);<br>            free_boxed_slice(buf, ptr, len);<br>        }<br>    });<br>} <br>2. å› ä¸º Buf Trait ä¸­æœ‰ advance è¿™æ ·çš„æ–¹æ³•ï¼Œå…¶ reveiver type æ˜¯ &amp;mut selfï¼Œå¦‚æœä¸º T&amp; å®ç°äº† Buf Traitï¼Œé‚£ä¹ˆå®ƒæ— æ³•è°ƒç”¨ advanceï¼Œä¼šäº§ç”Ÿ immutable borrow cannot be borrowed as mutable è¿™æ ·çš„é”™è¯¯ã€‚è€Œä¹‹æ‰€ä»¥å¯ä»¥ä¸º &amp;[u8] å®ç° Buf Traitï¼Œæ˜¯å› ä¸º advance å¯ä»¥ç›´æ¥é€šè¿‡åˆ‡ç‰‡çš„æ–¹å¼å¯¹ *self è¿›è¡Œä¿®æ”¹ï¼Œå³ advance(&amp;mut self, cnt) =&gt; *self= &amp;self[cnt..]<br>3. Vec å¯ä»¥ä½¿ç”¨ BufMutï¼Œå› ä¸º Vec[u8] å®ç°äº† BufMut Traitï¼Œæ–‡æ¡£ä¸­ BufMut çš„ç¬¬ä¸€ä¸ªä¾‹å­å°±æ˜¯åœ¨ vec ä¸Šä½¿ç”¨ BufMut<br>4. split_off çš„æ ¸å¿ƒåœ¨äº shallow_clone å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå…ˆåˆ¤æ–­ self çš„ç±»å‹æ˜¯å¦ä¸ºå…±äº«ï¼Œå¦‚æœæ˜¯ï¼Œå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å…ˆå°†å…¶å‡çº§ä¸ºå…±äº«æ•°æ®ï¼Œç„¶åè¿”å› BytesMut å¯¹è±¡ã€‚ä½†è¿™ä¸ªæ–¹æ³•æœ¬èº«æ˜¯ä¸å®‰å…¨çš„ï¼Œéœ€è¦è°ƒç”¨è€…è‡ªå·±å»ä¿è¯è¿”å›çš„ BytesMut å’ŒåŸæ¥çš„ BytesMut ä¹‹é—´æ²¡æœ‰é‡å çš„è§†å›¾","like_count":0},{"had_liked":false,"id":353174,"user_name":"çº¦ä¹¦äºš","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"å¤©æ´¥","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1659234715,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659234715","product_id":100085301,"comment_content":"æ²¡æƒ³é€šä¸ºä»€ä¹ˆæ²¡ä¸ºVec&lt;u8&gt;å®ç°Bufè€Œåªå®ç°äº†BufMut","like_count":0},{"had_liked":false,"id":350860,"user_name":"25ma","can_delete":false,"product_type":"c1","uid":1303713,"ip_address":"","ucode":"AB5435B9DB52C9","user_header":"https://static001.geekbang.org/account/avatar/00/13/e4/a1/178387da.jpg","comment_is_top":false,"comment_ctime":1657260797,"is_pvip":false,"replies":[{"id":"127651","content":"ğŸ‘","user_name":"ç¼–è¾‘å›å¤","comment_id":350860,"uid":"2547771","ip_address":"","utype":2,"ctime":1657270753,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1657260797","product_id":100085301,"comment_content":"å€¼å¾—åå¤æ·±åº¦é˜…è¯»ï¼Œå¾ˆæœ‰æ”¶è·","like_count":0,"discussions":[{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579261,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657270753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344619,"user_name":"é¹…å¸®é€®","can_delete":false,"product_type":"c1","uid":2755534,"ip_address":"","ucode":"A6DB1BEFDA5D9A","user_header":"https://static001.geekbang.org/account/avatar/00/2a/0b/ce/f0c520d1.jpg","comment_is_top":false,"comment_ctime":1651674764,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651674764","product_id":100085301,"comment_content":"mark,é˜…è¯»æºç å¯¹äºæˆ‘è¿˜æ˜¯æœ‰ç‚¹éš¾åº¦ï¼Œåé¢ä¼šå†æ¥å¤ä¹ ","like_count":0},{"had_liked":false,"id":331684,"user_name":"äº¤æµä¼š","can_delete":false,"product_type":"c1","uid":2022072,"ip_address":"","ucode":"EA82C16C86FAEE","user_header":"https://static001.geekbang.org/account/avatar/00/1e/da/b8/3f80b8a5.jpg","comment_is_top":false,"comment_ctime":1642724417,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642724417","product_id":100085301,"comment_content":"è€å¸ˆæ‚¨å¥½,è¯·é—®matchçš„æºç å®ç°ä»å“ªé‡Œæ‰¾å‘¢,å¸Œæœ›èƒ½æä¾›ä¸‹æŸ¥æ‰¾çš„æ€è·¯å°±å¯ä»¥,doc.rsçš„srcé‡Œåªæœ‰å¤§å †çš„æ³¨é‡Šå’Œè¯´æ˜,å´æ²¡çœ‹åˆ°æºç ,æ‰¾äº†å¾ˆä¹…ä¹Ÿæ²¡æ‰¾åˆ°...","like_count":0},{"had_liked":false,"id":327013,"user_name":"æ–½æ³°åš","can_delete":false,"product_type":"c1","uid":2718966,"ip_address":"","ucode":"E88E4E737398EF","user_header":"https://static001.geekbang.org/account/avatar/00/29/7c/f6/028f80a8.jpg","comment_is_top":false,"comment_ctime":1639838170,"is_pvip":false,"replies":[{"id":"120824","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":327013,"uid":"1079375","ip_address":"","utype":1,"ctime":1642311531,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1639838170","product_id":100085301,"comment_content":"çœ‹å®Œæˆ‘è§‰å¾—å€¼å¾—ï¼Œå¾—åå¤çœ‹å¾ˆå¤šç¼–äº†ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546469,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642311531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325750,"user_name":"overheat","can_delete":false,"product_type":"c1","uid":2675695,"ip_address":"","ucode":"DD82D9194C26D0","user_header":"https://static001.geekbang.org/account/avatar/00/28/d3/ef/b3b88181.jpg","comment_is_top":false,"comment_ctime":1639116579,"is_pvip":true,"replies":[{"id":"118820","content":"ä¸æ”¯æŒï¼Œä½ éœ€è¦å…ˆåš reverse  çš„æ“ä½œ","user_name":"ä½œè€…å›å¤","comment_id":325750,"uid":"1079375","ip_address":"","utype":1,"ctime":1639805255,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"1639116579","product_id":100085301,"comment_content":"Byteså¯ä»¥æ”¯æŒååºå—ï¼Ÿæˆ‘æƒ³è¦ä»ç»“å°¾å¾€å¼€å¤´æ“ä½œã€‚ã€‚ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539693,"discussion_content":"ä¸æ”¯æŒï¼Œä½ éœ€è¦å…ˆåš reverse  çš„æ“ä½œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639805255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2675695,"avatar":"https://static001.geekbang.org/account/avatar/00/28/d3/ef/b3b88181.jpg","nickname":"overheat","note":"","ucode":"DD82D9194C26D0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538261,"discussion_content":"ç ”ç©¶ä¸‹æ¥ï¼ŒByteså¯¹&amp;&#39;static [u8]åšäº†ç‰¹æ®Šçš„ä¼˜åŒ–ã€‚å¹¶ä¸”ï¼Œâ€œåˆ‡ç‰‡ &amp;[u8]ã€VecDeque&lt;u8&gt; éƒ½å®ç°äº† Buf traitï¼›â€ æ„Ÿè§‰æˆ‘æƒ³è¦çš„reverse byteså¯ä»¥å…ˆç®€åŒ–ä¸ºreverse &amp;[u8]ï¼Œå®ç°çœ‹çœ‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639386204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2675695,"avatar":"https://static001.geekbang.org/account/avatar/00/28/d3/ef/b3b88181.jpg","nickname":"overheat","note":"","ucode":"DD82D9194C26D0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538230,"discussion_content":"æˆ‘è‡ªå·±cloneäº†bytesçš„æºç ï¼Œç„¶åæŠŠBytes.rs copy ä¸€ä»½ä¸ºrBytes.rsï¼Œé€šè¿‡é‡å†™äº†Buf traitçš„advanceæ–¹æ³•ï¼Œå®ç°äº†ååºæ“ä½œã€‚\nä½†æ˜¯ï¼Œå¦‚æœæˆ‘æƒ³å†™ä¸€ä¸ªæ–°çš„crateå®ç°å¦‚ä¸ŠåŠŸèƒ½ï¼Œè¯¥å¦‚ä½•å¼€å§‹å‘¢ï¼Ÿå› ä¸ºrustæ²¡æœ‰ç»§æ‰¿ï¼Œæ˜¯ä¸æ˜¯æˆ‘è¦æŠŠbytesçš„vtableç­‰å®ç°éƒ½åœ¨æ–°çš„crateä¸­å†copyä¸€éï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639375465,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321354,"user_name":"å°åº·","can_delete":false,"product_type":"c1","uid":1485752,"ip_address":"","ucode":"2445F7BB91387C","user_header":"https://static001.geekbang.org/account/avatar/00/16/ab/b8/0a979678.jpg","comment_is_top":false,"comment_ctime":1636810050,"is_pvip":false,"replies":[{"id":"118930","content":"1. ç›®å‰æ˜¯ï¼Œä»¥ååŸºç¡€è½¯ä»¶ä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„ Rust èŒä½<br>2. ä¸ä¼š","user_name":"ä½œè€…å›å¤","comment_id":321354,"uid":"1079375","ip_address":"","utype":1,"ctime":1639853775,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1636810050","product_id":100085301,"comment_content":"è€å¸ˆï¼Œç›®å‰ä¸­å›½rustå²—ä½å¾ˆå¤šéƒ½æ˜¯åŒºå—é“¾ç›¸å…³çš„æŠ€æœ¯å²—ä½å‘€ï¼Ÿï¼Ÿï¼Ÿjavaè½¬Rustè·¨åº¦ä¼šä¸ä¼šå¤ªå¤§ï¼Ÿï¼Ÿï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539891,"discussion_content":"1. ç›®å‰æ˜¯ï¼Œä»¥ååŸºç¡€è½¯ä»¶ä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„ Rust èŒä½\n2. ä¸ä¼š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853775,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320485,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1636350162,"is_pvip":false,"replies":[{"id":"116575","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":320485,"uid":"1079375","ip_address":"","utype":1,"ctime":1636641735,"user_name_real":"Tyr"}],"discussion_count":1,"race_medal":0,"score":"1636350162","product_id":100085301,"comment_content":"æŒ‰ç…§è€å¸ˆä¸ªæ­¥éª¤, ä¸€æ­¥ä¸€æ­¥æ¥, å—ç›ŠåŒªæµ…!<br><br>è¯•äº†è¯•resize:<br><br>```<br>    use bytes::BytesMut;<br>    <br>    fn main() {<br>        let mut buf = BytesMut::from(&amp;b&quot;hello world&quot;[..]);<br>        let cap_orig = buf.capacity();<br>        let other = buf.split_off(5);<br>        assert_eq!(buf, &amp;b&quot;hello&quot;[..]);<br>        assert_eq!(buf.as_ptr() as usize + 5, other.as_ptr() as usize);<br>    <br>        buf.resize(cap_orig + 10, b&#39;w&#39;);<br>        println!(&quot;{:?}&quot;, buf);<br>        println!(&quot;{:?}&quot;, other);<br>        assert_ne!(buf.as_ptr() as usize + 5, other.as_ptr() as usize);<br>    }<br>  ```  <br><br>output<br><br>```<br>b&quot;hellowwwwwwwwwwwwwwww&quot;<br>b&quot; world&quot;<br>```<br><br>æœ¬ä»¥ä¸ºresizeäº†ç¬¬ä¸€ä¸ªbuf, ä¼šè¦†ç›–æ‰otherçš„éƒ¨åˆ†, æ¯•ç«Ÿä»–ä»¬ä¹‹å‰å…±äº«ä¸€ä¸ªstorage...<br><br>ç»“æœç¬¬ä¸€ä¸ªbufæ–°å¼€äº†memory, å’Œotherå°±æ’‡æ¸…å…³ç³»äº†...<br><br>BytesMutçœŸçš„å¤ªéš¾äº†...ä¸è¿‡bytesè¿™ä¸ªcrateçœŸçš„å¾ˆé€‚åˆç²¾è¯»...é‡Œé¢æœ‰å„ç§åº•å±‚æŠ€å·§â€¦","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530010,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636641735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317023,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1634643089,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1634643089","product_id":100085301,"comment_content":"ç”±äºç¼–è¯‘ proto åœ¨ Windows ä¸­æ–‡ç”¨æˆ·åç§°ä¸Šå‡ºé—®é¢˜ï¼Œæˆ‘æ‰“ç®—å…ˆé˜…è¯» prost-build çš„æºç ","like_count":0}]}