{"id":485702,"title":"12ï½œé«˜æ€§èƒ½ç½‘ç»œå®æˆ˜ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å¼€å‘ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¢³ç†äº† eBPF çš„å®‰å…¨èƒ½åŠ›ï¼Œå¹¶æ•™ä½ ä½¿ç”¨ eBPF åˆ†æå’Œé˜»æ­¢äº†å®¹å™¨è¿›ç¨‹çš„å®‰å…¨é—®é¢˜ã€‚åœ¨å¼€ç¯‡è¯ä¸­æˆ‘å°±æåˆ°ï¼ŒeBPF çš„ä¸»è¦åº”ç”¨åœºæ™¯æ¶µç›–äº†æ•…éšœè¯Šæ–­ã€æ€§èƒ½ç›‘æ§ã€å®‰å…¨æ§åˆ¶ä»¥åŠç½‘ç»œä¼˜åŒ–ç­‰ã€‚ä»<a href=\"https://time.geekbang.org/column/article/484207\"> 07 è®²</a> è¿›å…¥å®æˆ˜è¿›é˜¶ç¯‡å¼€å§‹ï¼Œæˆ‘å·²ç»ä¸ºä½ ä»‹ç»äº†åº”ç”¨äºå‰ä¸‰ä¸ªåœºæ™¯ä¸­çš„å†…æ ¸è·Ÿè¸ªã€ç”¨æˆ·æ€è·Ÿè¸ªã€ç½‘ç»œè·Ÿè¸ªä»¥åŠå®‰å…¨æ§åˆ¶ç­‰ã€‚é‚£ä¹ˆï¼Œå¯¹äºæœ€åä¸€ä¸ªåœºæ™¯ï¼Œç½‘ç»œæ€§èƒ½ä¼˜åŒ–ï¼ŒeBPF æ˜¯å¦‚ä½•å‘æŒ¥ä½œç”¨çš„å‘¢ï¼Ÿ</p><p>ä»Šå¤©ï¼Œæˆ‘å°±ä»¥æœ€å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡å™¨ä¸ºä¾‹ï¼Œå¸¦ä½ ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•å€ŸåŠ© eBPF æ¥ä¼˜åŒ–ç½‘ç»œçš„æ€§èƒ½ã€‚</p><h2>Nginx è´Ÿè½½å‡è¡¡å™¨</h2><p>æ—¢ç„¶è¦ä¼˜åŒ–è´Ÿè½½å‡è¡¡å™¨çš„ç½‘ç»œæ€§èƒ½ï¼Œé‚£ä¹ˆé¦–å…ˆå°±éœ€è¦æœ‰ä¸€ä¸ªä¼˜åŒ–çš„ç›®æ ‡ï¼Œå³åˆå§‹ç‰ˆçš„è´Ÿè½½å‡è¡¡å™¨ã€‚åœ¨ä»Šå¤©çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¸¸ç”¨çš„åå‘ä»£ç†å’Œ Web æœåŠ¡å™¨ Nginx ä½œä¸ºåˆå§‹ç‰ˆçš„è´Ÿè½½å‡è¡¡å™¨ï¼ŒåŒæ—¶ä¹Ÿä½¿ç”¨è‡ªå®šä¹‰çš„ Nginx ä½œä¸ºåç«¯çš„ Web æœåŠ¡å™¨ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ç¯å¢ƒçš„é‡ç°ï¼Œè´Ÿè½½å‡è¡¡å™¨ã€ Web æœåŠ¡å™¨ä»¥åŠå®¢æˆ·ç«¯éƒ½è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œå®ƒä»¬çš„ IP å’Œ MAC ç­‰åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/15/e923026f577f7b991be2610734f9e415.jpg?wh=1920x1706\" alt=\"å›¾ç‰‡\"></p><p>å‚è€ƒ Nginx å®˜æ–¹æ–‡æ¡£ä¸­ <a href=\"https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/\">HTTP è´Ÿè½½å‡è¡¡</a>çš„é…ç½®æ–¹æ³•ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ æ­¥æ¥æ­å»ºä¸Šè¿°çš„æ¡ˆä¾‹ç¯å¢ƒã€‚</p><p>1ï¼‰æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ›å»ºä¸Šå›¾ä¸­çš„4ä¸ªå®¹å™¨ï¼š</p><pre><code class=\"language-bash\"># Webserver (å“åº”æ˜¯hostnameï¼Œå¦‚ http1 æˆ– http2)\ndocker run -itd --name=http1 --hostname=http1 feisky/webserver\ndocker run -itd --name=http2 --hostname=http2 feisky/webserver\n\n# Client\ndocker run -itd --name=client alpine\n\n# Nginx\ndocker run -itd --name=nginx nginx\n</code></pre><!-- [[[read_end]]] --><p>æ³¨æ„ï¼Œè¿™å„¿å¯åŠ¨çš„ Nginx å®¹å™¨ä½¿ç”¨çš„è¿˜æ˜¯å®˜æ–¹é•œåƒï¼Œè¿˜éœ€è¦é¢å¤–çš„æ­¥éª¤æ›´æ–°å®ƒçš„è´Ÿè½½å‡è¡¡é…ç½®ã€‚</p><blockquote>\n<p>å°æç¤ºï¼šåœ¨é»˜è®¤å®‰è£…çš„ Docker ç¯å¢ƒä¸­ï¼Œå‡å¦‚ä½ æ²¡æœ‰è¿è¡Œå…¶ä»–å®¹å™¨ï¼Œè¿è¡Œä¸Šè¿°å‘½ä»¤åå¾—åˆ°çš„ IP åœ°å€è·Ÿå›¾ä¸­æ˜¯ç›¸åŒçš„ã€‚</p>\n</blockquote><p>2ï¼‰æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥è¯¢ä¸¤ä¸ª Web æœåŠ¡å™¨çš„ IP åœ°å€ï¼š</p><pre><code class=\"language-bash\">IP1=$(docker inspect http1 -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')\nIP2=$(docker inspect http2 -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')\necho \"Webserver1's IP: $IP1\"\necho \"Webserver2's IP: $IP2\"\n</code></pre><p>å‘½ä»¤æ‰§è¡Œåï¼Œä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">Webserver1's IP: 172.17.0.2\nWebserver2's IP: 172.17.0.3\n</code></pre><p>3ï¼‰æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œç”Ÿæˆå¹¶æ›´æ–° Nginx é…ç½®ï¼š</p><pre><code class=\"language-c++\"># ç”Ÿæˆnginx.confæ–‡ä»¶\ncat&gt;nginx.conf &lt;&lt;EOF\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log notice;\npid        /var/run/nginx.pid;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n   include       /etc/nginx/mime.types;\n   default_type  application/octet-stream;\n\n    upstream webservers {\n        server $IP1;\n        server $IP2;\n    }\n\n    server {\n        listen 80;\n\n        location / {\n            proxy_pass http://webservers;\n        }\n    }\n}\nEOF\n\n# æ›´æ–°Nginxé…ç½®\ndocker cp nginx.conf nginx:/etc/nginx/nginx.conf\ndocker exec nginx nginx -s reload\n</code></pre><p>é…ç½®å®Œæˆåï¼Œå†æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒéªŒè¯è´Ÿè½½å‡è¡¡å™¨æ˜¯ä¸æ˜¯ç”Ÿæ•ˆäº†ï¼ˆ<code>/ #</code> è¡¨ç¤ºåœ¨å®¹å™¨ç»ˆç«¯ä¸­æ‰§è¡Œå‘½ä»¤ï¼‰ï¼š</p><pre><code class=\"language-bash\"># æŸ¥è¯¢Nginxå®¹å™¨IPï¼ˆè¾“å‡ºä¸º172.17.0.5ï¼‰\ndocker inspect nginx -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'\n\n# è¿›å…¥clientå®¹å™¨ç»ˆç«¯ï¼Œå®‰è£…curlä¹‹åè®¿é—®Nginx\ndocker exec -it client sh\n\n# (ä»¥ä¸‹å‘½ä»¤è¿è¡Œåœ¨clientå®¹å™¨ä¸­)\n/ # apk add curl wrk --update\n/ # curl \"http://172.17.0.5\"\n</code></pre><p>å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¤šæ¬¡æ‰§è¡Œ curl å‘½ä»¤åï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼Œå³é€šè¿‡ Nginx æˆåŠŸè·å¾—äº†ä¸¤ä¸ª Web æœåŠ¡å™¨çš„è¾“å‡ºï¼Œè¯´æ˜è´Ÿè½½å‡è¡¡å™¨é…ç½®æˆåŠŸäº†ï¼š</p><pre><code class=\"language-bash\">/ # curl \"http://172.17.0.5\"\nHostname: http1\n\n/ # curl \"http://172.17.0.5\"\nHostname: http2\n</code></pre><p>è´Ÿè½½å‡è¡¡å™¨é…ç½®æˆåŠŸåï¼Œå®ƒçš„æ€§èƒ½æ€ä¹ˆæ ·å‘¢ï¼Ÿè¿›å…¥ client å®¹å™¨ç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥ä½¿ç”¨ <a href=\"https://github.com/wg/wrk\">wrk</a> ç»™å®ƒåšä¸ªæ€§èƒ½æµ‹è¯•ï¼š</p><pre><code class=\"language-bash\">/ # apk add wrk --update\n/ # wrk -c100 \"http://172.17.0.5\"\n</code></pre><p>ç¨ç­‰ä¸€ä¼šï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Šï¼š</p><pre><code class=\"language-bash\">Running 10s test @ http://172.17.0.5\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     7.53ms    4.96ms  39.33ms   70.78%\n    Req/Sec     6.96k   514.59     8.88k    74.00%\n  138711 requests in 10.05s, 21.83MB read\nRequests/sec:  13798.11\nTransfer/sec:      2.17MB\n</code></pre><p>ä»æŠ¥å‘Šä¸­ä½ å¯ä»¥å‘ç°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ€»çš„å¹³å‡æ¯ç§’è¯·æ±‚æ•°æ˜¯ 13798ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„å¹³å‡è¯·æ±‚æ•°å’Œè¯·æ±‚å»¶è¿Ÿæ˜¯ 6.96k å’Œ 7.53 æ¯«ç§’ï¼ˆåœ¨ä½ çš„ç¯å¢ƒä¸‹å¯èƒ½çœ‹åˆ°ä¸åŒæ•°å€¼ï¼Œå…·ä½“çš„æ€§èƒ½æŒ‡æ ‡å–å†³äºè¿è¡Œç¯å¢ƒå’Œé…ç½®ï¼‰ã€‚ä½ å¯ä»¥è®°å½•ä¸€ä¸‹è¿™äº›æ•°å€¼ï¼Œä»¥ä¾¿åé¢è·Ÿ eBPF è¿›è¡Œæ¯”è¾ƒã€‚</p><h2>å¦‚ä½•ä½¿ç”¨ eBPF ä¼˜åŒ–è´Ÿè½½å‡è¡¡æ€§èƒ½ï¼Ÿ</h2><p>æœ‰äº†å¾…ä¼˜åŒ–çš„ eBPF è´Ÿè½½å‡è¡¡å™¨ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨ eBPF è¿›è¡Œä¼˜åŒ–äº†ã€‚åœ¨å¼€å§‹æ¥ä¸‹æ¥çš„å†…å®¹ä¹‹å‰ï¼Œä½ å¯ä»¥å…ˆå›é¡¾ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰è¯¾ç¨‹çš„å†…å®¹ï¼Œæ€è€ƒæœ‰å“ªäº›å¯èƒ½çš„æ–¹æ¡ˆå¯ä»¥ç”¨åœ¨è´Ÿè½½å‡è¡¡çš„æ€§èƒ½ä¼˜åŒ–åœºæ™¯ä¸­ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/483364\"> 06 è®²</a> ä¸­æˆ‘æ›¾æåˆ°è¿‡ï¼Œæ¯ä¸ª eBPF ç¨‹åºéƒ½å±äºç‰¹å®šçš„ç±»å‹ï¼Œä¸åŒç±»å‹ eBPF ç¨‹åºçš„è§¦å‘äº‹ä»¶æ˜¯ä¸åŒçš„ã€‚æ—¢ç„¶æ˜¯ç½‘ç»œçš„æ€§èƒ½ä¼˜åŒ–ï¼Œè‡ªç„¶åº”è¯¥å»è€ƒè™‘ç½‘ç»œç±»çš„ eBPF ç¨‹åºã€‚æ ¹æ®è§¦å‘äº‹ä»¶çš„ä¸åŒï¼Œç½‘ç»œç±» eBPF ç¨‹åºå¯ä»¥åˆ†ä¸º XDPç¨‹åºã€TCç¨‹åºã€å¥—æ¥å­—ç¨‹åºä»¥åŠ cgroup ç¨‹åºã€‚è¿™å‡ ç±»ç¨‹åºçš„è§¦å‘äº‹ä»¶å’Œå¸¸ç”¨åœºæ™¯åˆ†åˆ«ä¸ºï¼š</p><ul>\n<li>XDP ç¨‹åºåœ¨ç½‘ç»œé©±åŠ¨ç¨‹åºåˆšåˆšæ”¶åˆ°æ•°æ®åŒ…çš„æ—¶å€™è§¦å‘æ‰§è¡Œï¼Œæ”¯æŒå¸è½½åˆ°ç½‘å¡ç¡¬ä»¶ï¼Œå¸¸ç”¨äºé˜²ç«å¢™å’Œå››å±‚è´Ÿè½½å‡è¡¡ï¼›</li>\n<li>TC ç¨‹åºåœ¨ç½‘å¡é˜Ÿåˆ—æ¥æ”¶æˆ–å‘é€çš„æ—¶å€™è§¦å‘æ‰§è¡Œï¼Œè¿è¡Œåœ¨å†…æ ¸åè®®æ ˆä¸­ï¼Œå¸¸ç”¨äºæµé‡æ§åˆ¶ï¼›</li>\n<li>å¥—æ¥å­—ç¨‹åºåœ¨å¥—æ¥å­—å‘ç”Ÿåˆ›å»ºã€ä¿®æ”¹ã€æ”¶å‘æ•°æ®ç­‰å˜åŒ–çš„æ—¶å€™è§¦å‘æ‰§è¡Œï¼Œè¿è¡Œåœ¨å†…æ ¸åè®®æ ˆä¸­ï¼Œå¸¸ç”¨äºè¿‡æ»¤ã€è§‚æµ‹æˆ–é‡å®šå‘å¥—æ¥å­—ç½‘ç»œåŒ…ã€‚å…¶ä¸­ï¼ŒBPF_PROG_TYPE_SOCK_OPSã€BPF_PROG_TYPE_SK_SKBã€BPF_PROG_TYPE_SK_MSG ç­‰éƒ½å¯ä»¥ç”¨äºå¥—æ¥å­—é‡å®šå‘ï¼›</li>\n<li>cgroup ç¨‹åºåœ¨ cgroup å†…æ‰€æœ‰è¿›ç¨‹çš„å¥—æ¥å­—åˆ›å»ºã€ä¿®æ”¹é€‰é¡¹ã€è¿æ¥ç­‰æƒ…å†µä¸‹è§¦å‘æ‰§è¡Œï¼Œå¸¸ç”¨äºè¿‡æ»¤å’Œæ§åˆ¶ cgroup å†…å¤šä¸ªè¿›ç¨‹çš„å¥—æ¥å­—ã€‚</li>\n</ul><p>æ ¹æ®è¿™äº›è§¦å‘äº‹ä»¶ï¼Œä½ å¯ä»¥å‘ç°è¿™å‡ ç±»ç½‘ç»œç¨‹åºéƒ½æœ‰å¯èƒ½ç”¨åœ¨ç½‘ç»œæ€§èƒ½ä¼˜åŒ–ä¸Šã€‚å…¶ä¸­ï¼Œç”±äºæ”¯æŒå¸è½½åˆ°ç¡¬ä»¶ï¼ŒXDP çš„æ€§èƒ½åº”è¯¥æ˜¯æœ€å¥½çš„ï¼›è€Œç”±äºç›´æ¥ä½œç”¨åœ¨å¥—æ¥å­—ä¸Šï¼Œå¥—æ¥å­—ç¨‹åºå’Œ cgroup ç¨‹åºæ˜¯æœ€æ¥è¿‘åº”ç”¨çš„ã€‚</p><p>æ—¢ç„¶æœ‰å¤šç§ä¸åŒçš„æ€§èƒ½ä¼˜åŒ–æ–¹å¼ï¼Œæˆ‘å°±ä»¥å¥—æ¥å­—å’Œ XDP è¿™ä¸¤ç§æ–¹å¼ä¸ºä¾‹ï¼Œå¸¦ä½ ä¼˜åŒ–è´Ÿè½½å‡è¡¡çš„æ€§èƒ½ã€‚ç”±äºå†…å®¹æ¯”è¾ƒå¤šï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…ˆçœ‹å¥—æ¥å­— eBPF ç¨‹åºçš„ä¼˜åŒ–æ–¹æ³•ï¼Œè€Œ XDP æ–¹æ³•æˆ‘ä¼šåœ¨ä¸‹ä¸€è®²ä¸­ä¸ºä½ ä»‹ç»ã€‚</p><h2>ä½¿ç”¨å¥—æ¥å­— eBPF ç¨‹åºä¼˜åŒ–ç½‘ç»œæ€§èƒ½</h2><p>æ ¹æ®åŸç†çš„ä¸åŒï¼Œå¥—æ¥å­— eBPF ç¨‹åºåˆåˆ†ä¸ºå¾ˆå¤šä¸åŒçš„ç±»å‹ã€‚å…¶ä¸­ï¼ŒBPF_PROG_TYPE_SOCK_OPSã€BPF_PROG_TYPE_SK_SKBã€BPF_PROG_TYPE_SK_MSG ç­‰ç±»å‹çš„ eBPF ç¨‹åºå¯ä»¥ä¸å¥—æ¥å­—æ˜ å°„ï¼ˆå¦‚ BPF_MAP_TYPE_SOCKMAP æˆ– BPF_MAP_TYPE_SOCKHASHï¼‰é…åˆï¼Œå®ç°å¥—æ¥å­—çš„è½¬å‘ã€‚</p><p>å¥—æ¥å­— eBPF ç¨‹åºå·¥ä½œåœ¨å†…æ ¸ç©ºé—´ä¸­ï¼Œæ— éœ€æŠŠç½‘ç»œæ•°æ®å‘é€åˆ°ç”¨æˆ·ç©ºé—´å°±èƒ½å®Œæˆè½¬å‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçŒœæµ‹ï¼Œå®ƒåº”è¯¥æ˜¯å¯ä»¥æå‡ç½‘ç»œè½¬å‘çš„æ€§èƒ½ï¼ˆå½“ç„¶ï¼Œå…·ä½“èƒ½ä¸èƒ½æå‡ï¼Œè¿˜éœ€è¦æ¥ä¸‹æ¥çš„æµ‹è¯•éªŒè¯ï¼‰ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨å¥—æ¥å­—æ˜ å°„è½¬å‘ç½‘ç»œåŒ…éœ€è¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol>\n<li>åˆ›å»ºå¥—æ¥å­—æ˜ å°„ï¼›</li>\n<li>åœ¨ BPF_PROG_TYPE_SOCK_OPS ç±»å‹çš„ eBPF ç¨‹åºä¸­ï¼Œå°†æ–°åˆ›å»ºçš„å¥—æ¥å­—å­˜å…¥å¥—æ¥å­—æ˜ å°„ä¸­ï¼›</li>\n<li>åœ¨æµè§£æç±»çš„ eBPF ç¨‹åºï¼ˆå¦‚ BPF_PROG_TYPE_SK_SKB æˆ– BPF_PROG_TYPE_SK_MSG ï¼‰ä¸­ï¼Œä»å¥—æ¥å­—æ˜ å°„ä¸­æå–å¥—æ¥å­—ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨ BPF è¾…åŠ©å‡½æ•°è½¬å‘ç½‘ç»œåŒ…ï¼›</li>\n<li>åŠ è½½å¹¶æŒ‚è½½ eBPF ç¨‹åºåˆ°å¥—æ¥å­—äº‹ä»¶ã€‚</li>\n</ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹çœ‹å…·ä½“æ¯ä¸€æ­¥è¯¥å¦‚ä½•æ“ä½œã€‚</p><h3>åˆ›å»ºå¥—æ¥å­—æ˜ å°„</h3><p>é¦–å…ˆï¼Œç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ç±»å‹çš„æ˜ å°„ã€‚ä»¥ BPF_MAP_TYPE_SOCKHASH ç±»å‹çš„å¥—æ¥å­—æ˜ å°„ä¸ºä¾‹ï¼Œå®ƒçš„å€¼æ€»æ˜¯å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œé”®åˆ™éœ€è¦æˆ‘ä»¬å»å®šä¹‰ã€‚æ¯”å¦‚ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªåŒ…å« IP åè®®äº”å…ƒç»„çš„ç»“æ„ä½“ï¼Œä½œä¸ºå¥—æ¥å­—æ˜ å°„çš„é”®ç±»å‹ï¼š</p><pre><code class=\"language-c++\">struct sock_key\n{\n    __u32 sip;    //æºIP\n    __u32 dip;    //ç›®çš„IP\n    __u32 sport;  //æºç«¯å£\n    __u32 dport;  //ç›®çš„ç«¯å£\n    __u32 family; //åè®®\n};\n</code></pre><p>æœ‰äº†é”®ç±»å‹ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>SEC</code> å…³é”®å­—æ¥å®šä¹‰å¥—æ¥å­—æ˜ å°„äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">#include &lt;linux/bpf.h&gt;\n\nstruct bpf_map_def SEC(\"maps\") sock_ops_map = {\n    .type = BPF_MAP_TYPE_SOCKHASH,\n    .key_size = sizeof(struct sock_key),\n    .value_size = sizeof(int),\n    .max_entries = 65535,\n    .map_flags = 0,\n};\n</code></pre><p>ä¸ºäº†æ–¹ä¾¿åç»­åœ¨ eBPF ç¨‹åºä¸­å¼•ç”¨è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œä½ å¯ä»¥æŠŠå®ƒä»¬ä¿å­˜åˆ°ä¸€ä¸ªå¤´æ–‡ä»¶ <code>sockops.h</code> ä¸­ï¼ˆä½ è¿˜å¯ä»¥åœ¨ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/loadbalancer/sockops/sockops.h\">GitHub</a> ä¸­æ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼‰ã€‚</p><h3>æ›´æ–°å¥—æ¥å­—æ˜ å°„</h3><p>å¥—æ¥å­—æ˜ å°„å‡†å¤‡å¥½ä¹‹åï¼Œç¬¬äºŒæ­¥å°±æ˜¯åœ¨ BPF_PROG_TYPE_SOCK_OPS ç±»å‹çš„ eBPF ç¨‹åºä¸­è·Ÿè¸ªå¥—æ¥å­—äº‹ä»¶ï¼Œå¹¶æŠŠå¥—æ¥å­—ä¿¡æ¯ä¿å­˜åˆ° SOCKHASH æ˜ å°„ä¸­ã€‚</p><p>å‚è€ƒå†…æ ¸ä¸­ BPF_PROG_TYPE_SOCK_OPS ç¨‹åºç±»å‹çš„<a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/linux/bpf_types.h#L29\">å®šä¹‰æ ¼å¼</a>ï¼Œå®ƒçš„å‚æ•°æ ¼å¼ä¸º <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L5506\">struct bpf_sock_ops</a>ï¼š</p><pre><code class=\"language-c++\">#define BPF_PROG_TYPE(_id, _name, prog_ctx_type, kern_ctx_type)\n\nBPF_PROG_TYPE(BPF_PROG_TYPE_SOCK_OPS, sock_ops,\n    struct bpf_sock_ops, struct bpf_sock_ops_kern)\n</code></pre><p>å› æ­¤ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼æ¥å®šä¹‰è¿™ä¸ª eBPF ç¨‹åºï¼š</p><pre><code class=\"language-c++\">SEC(\"sockops\")\nint bpf_sockmap(struct bpf_sock_ops *skops)\n{\n  // TODO: æ·»åŠ å¥—æ¥å­—æ˜ å°„æ›´æ–°æ“ä½œ\n}\n</code></pre><p>åœ¨æ·»åŠ å…·ä½“çš„å¥—æ¥å­—æ˜ å°„æ›´æ–°é€»è¾‘ä¹‹å‰ï¼Œè¿˜éœ€è¦ä½ å…ˆä» <code>struct bpf_sock_ops</code>ä¸­è·å–ä½œä¸ºé”®ç±»å‹çš„äº”å…ƒç»„ã€‚å‚è€ƒå†…æ ¸ä¸­ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L5506\">struct bpf_sock_ops</a> çš„å®šä¹‰ï¼Œå¦‚ä¸‹çš„å‡ ä¸ªå­—æ®µåˆšå¥½å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼š</p><pre><code class=\"language-c++\">struct bpf_sock_ops {\n  __u32 family;\n  __u32 remote_ip4;\t/* Stored in network byte order */\n  __u32 local_ip4;\t/* Stored in network byte order */\n  __u32 remote_port;/* Stored in network byte order */\n  __u32 local_port;\t/* stored in host byte order */\n  ...\n}\n</code></pre><p>å› æ­¤ï¼Œä½ å°±å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬æ¥å®šä¹‰æ˜ å°„ä¸­æ‰€éœ€è¦çš„é”®ã€‚ä¸‹é¢å°±æ˜¯ <code>sock_key</code> çš„å®šä¹‰æ–¹æ³•ï¼Œæ³¨æ„è¿™é‡ŒæŠŠ <code>local_port</code> è½¬æ¢ä¸ºäº†åŒå…¶ä»–å­—æ®µä¸€æ ·çš„ç½‘ç»œå­—èŠ‚åºï¼š</p><pre><code class=\"language-c++\">struct sock_key key = {\n  .dip = skops-&gt;remote_ip4,\n  .sip = skops-&gt;local_ip4,\n  .sport = bpf_htonl(skops-&gt;local_port),\n  .dport = skops-&gt;remote_port,\n  .family = skops-&gt;family,\n};\n</code></pre><p>æœ‰äº†é”®ä¹‹åï¼Œè¿˜ä¸èƒ½ç«‹åˆ»å°±å»æ›´æ–°å¥—æ¥å­—æ˜ å°„ã€‚è¿™æ˜¯å› ä¸º BPF_PROG_TYPE_SOCK_OPS ç¨‹åºè·Ÿè¸ªäº†æ‰€æœ‰ç±»å‹çš„å¥—æ¥å­—æ“ä½œï¼Œè€Œæˆ‘ä»¬åªéœ€è¦æŠŠæ–°åˆ›å»ºçš„å¥—æ¥å­—æ›´æ–°åˆ°æ˜ å°„ä¸­ã€‚</p><p><code>struct bpf_sock_ops</code> ä¸­åŒ…å«çš„ <code>op</code> å­—æ®µå¯ç”¨äºåˆ¤æ–­å¥—æ¥å­—æ“ä½œç±»å‹ï¼Œå…¶å®šä¹‰æ ¼å¼å¯ä»¥å‚è€ƒ<a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L5638\">è¿™é‡Œçš„å†…æ ¸å¤´æ–‡ä»¶</a>ã€‚å†…æ ¸å¤´æ–‡ä»¶ä¸­å·²ç»ä¸ºæ¯ç§æ“ä½œçš„å…·ä½“å«ä¹‰åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼Œå¯¹äºæ–°åˆ›å»ºçš„è¿æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªçŠ¶æ€ï¼ˆå³ä¸»åŠ¨è¿æ¥å’Œè¢«åŠ¨è¿æ¥ï¼‰ä½œä¸ºåˆ¤æ–­æ¡ä»¶ï¼š</p><pre><code class=\"language-c++\">/* skip if it is not established op */\nif (skops-&gt;op != BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB &amp;&amp; skops-&gt;op != BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB) {\n  return BPF_OK;\n}\n</code></pre><p>åˆ°è¿™é‡Œï¼Œè¯´æ˜å¥—æ¥å­—å·²ç»å±äºæ–°åˆ›å»ºçš„è¿æ¥äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ BPF è¾…åŠ©å‡½æ•°å»æ›´æ–°å¥—æ¥å­—æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">bpf_sock_hash_update(skops, &amp;sock_ops_map, &amp;key, BPF_NOEXIST);\n</code></pre><p>å…¶ä¸­ï¼Œ<code>BPF_NOEXIST</code>  è¡¨ç¤ºé”®ä¸å­˜åœ¨çš„æ—¶å€™æ‰æ·»åŠ æ–°å…ƒç´ ã€‚</p><p>å†åŠ ä¸Šå¿…è¦çš„å¤´æ–‡ä»¶ï¼Œå®Œæ•´çš„ eBPF ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">#include &lt;linux/bpf.h&gt;\n#include &lt;bpf/bpf_endian.h&gt;\n#include &lt;bpf/bpf_helpers.h&gt;\n#include &lt;sys/socket.h&gt;\n#include \"sockops.h\"\n\nSEC(\"sockops\")\nint bpf_sockmap(struct bpf_sock_ops *skops)\n{\n    /* skip if the packet is not ipv4 */\n    if (skops-&gt;family != AF_INET)\n    {\n        return BPF_OK;\n    }\n\n    /* skip if it is not established op */\n    if (skops-&gt;op != BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB &amp;&amp; skops-&gt;op != BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB) {\n        return BPF_OK;\n    }\n\n    struct sock_key key = {\n        .dip = skops-&gt;remote_ip4,\n        .sip = skops-&gt;local_ip4,\n        /* convert to network byte order */\n        .sport = (bpf_htonl(skops-&gt;local_port)),\n        .dport = skops-&gt;remote_port,\n        .family = skops-&gt;family,\n    };\n\n    bpf_sock_hash_update(skops, &amp;sock_ops_map, &amp;key, BPF_NOEXIST);\n    return BPF_OK;\n}\n\nchar LICENSE[] SEC(\"license\") = \"Dual BSD/GPL\";\n</code></pre><p>æŠŠä¸Šè¿°ä»£ç ä¿å­˜åˆ° <code>sockops.bpf.c</code> æ–‡ä»¶ä¸­ï¼ˆä½ è¿˜å¯ä»¥åœ¨ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/loadbalancer/sockops/sockops.bpf.c\">GitHub</a> ä¸­æ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼‰ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°†å…¶ç¼–è¯‘ä¸º BPF å­—èŠ‚ç ï¼š</p><pre><code class=\"language-bash\">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I/usr/include/x86_64-linux-gnu -I. -c sockops.bpf.c -o sockops.bpf.o\n</code></pre><p>åˆ°è¿™é‡Œï¼Œå¥—æ¥å­—æ›´æ–°çš„ eBPF ç¨‹åºå°±å‡†å¤‡å¥½äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è½¬å‘å¥—æ¥å­—ã€‚</p><h3>å¥—æ¥å­—è½¬å‘</h3><p>ç¬¬ä¸‰æ­¥çš„å¥—æ¥å­—è½¬å‘å¯ä»¥ä½¿ç”¨ BPF_PROG_TYPE_SK_MSG ç±»å‹çš„ eBPF ç¨‹åºï¼Œæ•è·å¥—æ¥å­—ä¸­çš„å‘é€æ•°æ®åŒ…ï¼Œå¹¶æ ¹æ®ä¸Šè¿°çš„å¥—æ¥å­—æ˜ å°„è¿›è¡Œè½¬å‘ã€‚æ ¹æ®å†…æ ¸å¤´æ–‡ä»¶ä¸­çš„<a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/linux/bpf_types.h#L33\">å®šä¹‰æ ¼å¼</a>ï¼Œå®ƒçš„å‚æ•°æ ¼å¼ä¸º <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L5328\">struct sk_msg_md</a>ã€‚<code>struct sk_msg_md</code> çš„å®šä¹‰æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼Œä¹Ÿå·²ç»åŒ…å«äº†å¥—æ¥å­—æ˜ å°„æ‰€éœ€çš„äº”å…ƒç»„ä¿¡æ¯ï¼š</p><pre><code class=\"language-c++\">struct sk_msg_md {\n  ...\n  __u32 family;\n  __u32 remote_ip4;  /* Stored in network byte order */\n  __u32 local_ip4;   /* Stored in network byte order */\n  __u32 remote_port; /* Stored in network byte order */\n  __u32 local_port;  /* stored in host byte order */\n  ...\n};\n</code></pre><p>äº†è§£æ¸…æ¥šæ•°æ®ç»“æ„çš„å®šä¹‰æ ¼å¼ä¹‹åï¼Œè¿˜éœ€è¦ä½ æ³¨æ„ä¸€ç‚¹ï¼šBPF_PROG_TYPE_SK_MSG è·Ÿ BPF_PROG_TYPE_SOCK_OPS å±äºä¸åŒçš„ eBPF ç¨‹åºã€‚è™½ç„¶ä½ å¯ä»¥æŠŠå¤šä¸ª eBPF ç¨‹åºæ”¾å…¥åŒä¸€ä¸ªæºç æ–‡ä»¶ï¼Œå¹¶ç¼–è¯‘åˆ°åŒä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶(å³ <code>æ–‡ä»¶å.o</code>ï¼‰ä¸­ï¼Œä½†ç”±äºå®ƒä»¬çš„åŠ è½½å’ŒæŒ‚è½½æ ¼å¼éƒ½æ˜¯ä¸åŒçš„ï¼Œæˆ‘æ¨èä½ æŠŠä¸åŒçš„ eBPF ç¨‹åºæ”¾å…¥ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ç®¡ç†èµ·æ¥æ›´ä¸ºæ–¹ä¾¿ã€‚</p><p>å› æ­¤ï¼Œæ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼ˆå¦‚ <code>sockredir.bpf.c</code>ï¼‰ï¼Œç”¨äºä¿å­˜ BPF_PROG_TYPE_SK_MSG ç¨‹åºã€‚æ·»åŠ å¦‚ä¸‹çš„ä»£ç ï¼Œå°±å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>bpf_redir</code> çš„ eBPF ç¨‹åºï¼š</p><pre><code class=\"language-c++\">SEC(\"sk_msg\")\nint bpf_redir(struct sk_msg_md *msg)\n{\n    //TODO: æ·»åŠ å¥—æ¥å­—è½¬å‘é€»è¾‘\n}\n</code></pre><p>åœ¨è¿™ä¸ª eBPF ç¨‹åºä¸­ï¼Œæ—¢ç„¶è¿˜è¦è®¿é—®ç›¸åŒçš„å¥—æ¥å­—æ˜ å°„ï¼Œä¹Ÿå°±éœ€è¦ä»å‚æ•° <code>struct sk_msg_md</code> ä¸­æå–äº”å…ƒç»„ä¿¡æ¯ï¼Œå¹¶å­˜å…¥å¥—æ¥å­—æ˜ å°„æ‰€éœ€è¦çš„é”® <code>struct sock_key</code> ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬å°±å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ <code>struct sock_key</code>ï¼ˆæ³¨æ„ï¼Œè¿™é‡ŒåŒæ ·éœ€è¦æŠŠ <code>local_port</code> è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºï¼‰ï¼š</p><pre><code class=\"language-c++\">struct sock_key key = {\n  .sip = msg-&gt;remote_ip4,\n  .dip = msg-&gt;local_ip4,\n  .dport = bpf_htonl(msg-&gt;local_port),\n  .sport = msg-&gt;remote_port,\n  .family = msg-&gt;family,\n};\n</code></pre><p>éœ€è¦ä½ æ³¨æ„çš„æ˜¯ï¼Œè¿™å„¿çš„æº IP å’Œæºç«¯å£å¯¹åº”ä¸Šè¿° eBPF ç¨‹åºçš„ç›®çš„ IP å’Œç›®çš„ç«¯å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€æ–¹å‘åˆšå¥½æ˜¯ç›¸åçš„ã€‚ä¸ºä»€ä¹ˆæ˜¯ç›¸åçš„å‘¢ï¼Ÿæ¥çœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼ŒåŸå› å°±å¾ˆæ¸…æ¥šäº†ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/70/3c2419d6a357eca924fe6b94ed5b0970.jpg?wh=1920x1809\" alt=\"å›¾ç‰‡\"></p><p>å›¾ä¸­ï¼Œç°è‰²ç®­å¤´æ˜¯å¥—æ¥å­—è½¬å‘ä¹‹å‰çš„ç½‘ç»œæµå‘ï¼Œè€Œç»¿è‰²ç®­å¤´åˆ™æ˜¯å¥—æ¥å­—è½¬å‘åçš„ç½‘ç»œæµå‘ã€‚ä»è¿™å¼ å›¾ä¸­ä½ å¯ä»¥å‘ç°ï¼š</p><ul>\n<li>åœ¨å¥—æ¥å­—è½¬å‘ä¹‹å‰ï¼Œå³ä¾¿æ˜¯åœ¨åŒä¸€å°æœºå™¨çš„ä¸¤ä¸ªå®¹å™¨ä¸­ï¼Œè´Ÿè½½å‡è¡¡å™¨å’Œ Web æœåŠ¡å™¨çš„ä¸¤ä¸ªå¥—æ¥å­—é€šä¿¡è¿˜æ˜¯éœ€è¦é€šè¿‡å®Œæ•´çš„å†…æ ¸åè®®æ ˆè¿›è¡Œå¤„ç†çš„ï¼›</li>\n<li>è€Œåœ¨å¥—æ¥å­—è½¬å‘ä¹‹åï¼Œæ¥è‡ªå‘é€ç«¯å¥—æ¥å­— 1 çš„ç½‘ç»œåŒ…åœ¨å¥—æ¥å­—å±‚å°±äº¤ç»™äº†æ¥æ”¶ç«¯çš„å¥—æ¥å­— 2ï¼Œä»è€Œé¿å…äº†é¢å¤–çš„å†…æ ¸åè®®æ ˆå¤„ç†è¿‡ç¨‹ã€‚</li>\n</ul><p>ç”±äºè¿™ä¸¤ä¸ªå¥—æ¥å­—ä¸€ä¸ªæ˜¯å‘é€ï¼Œä¸€ä¸ªæ˜¯æ¥æ”¶ï¼Œå› è€Œå®ƒä»¬çš„æ–¹å‘æ˜¯ç›¸åçš„ï¼Œæ‰€ä»¥åœ¨æ„é€ è½¬å‘å¥—æ¥å­—çš„é”®æ—¶ï¼Œå°±éœ€è¦æŠŠæºå’Œç›®çš„äº¤æ¢ã€‚</p><p>æœ‰äº†å¥—æ¥å­—æ˜ å°„æ‰€éœ€è¦çš„é”®ä¹‹åï¼Œæœ€åè¿˜å‰©ä¸‹æ·»åŠ å¥—æ¥å­—è½¬å‘é€»è¾‘çš„æ­¥éª¤ã€‚å‚è€ƒ BPF è¾…åŠ©å‡½æ•°æ–‡æ¡£ï¼ˆä½ å¯ä»¥æ‰§è¡Œ <code>man bpf-helpers</code> æŸ¥è¯¢ï¼‰ï¼Œ<code>bpf_msg_redirect_hash()</code> æ­£å¥½è·Ÿæˆ‘ä»¬çš„éœ€æ±‚å®Œå…¨åŒ¹é…ã€‚ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘æŠŠå®ƒçš„ä½¿ç”¨æ–‡æ¡£ä¹Ÿè´´ä¸€ä¸‹ï¼š</p><pre><code class=\"language-c++\">long bpf_msg_redirect_hash(struct sk_msg_buff *msg, struct bpf_map *map, void *key, u64 flags)\n\nDescription\nThis helper is used in programs implementing policies at the socket  level.  If  the\nmessage  msg  is allowed to pass (i.e. if the verdict eBPF program returns SK_PASS),\nredirect it to the socket referenced by map (of  type  BPF_MAP_TYPE_SOCKHASH)  using\nhash  key.  Both  ingress  and  egress  interfaces  can be used for redirection. The\nBPF_F_INGRESS value in flags is used to make the distinction (ingress  path  is  seâ€\nlected  if  the  flag is present, egress path otherwise). This is the only flag supâ€\nported for now.\n\nReturn SK_PASS on success, or SK_DROP on error.\n</code></pre><p>æ¦‚æ‹¬æ¥è¯´ï¼Œ<code>bpf_msg_redirect_hash()</code> çš„ä½œç”¨å°±æ˜¯æŠŠå½“å‰å¥—æ¥å­—è½¬å‘ç»™å¥—æ¥å­—æ˜ å°„ä¸­çš„å¥—æ¥å­—ã€‚è€Œå‚æ•° <code>key</code> ç”¨äºä»å¥—æ¥å­—æ˜ å°„ä¸­æŸ¥è¯¢å¾…è½¬å‘çš„å¥—æ¥å­—ï¼Œ<code>flags</code> ç”¨äºåŒºåˆ†å…¥å£æˆ–å‡ºå£è·¯å¾„ã€‚</p><p>æ ¹æ®æ¯ä¸ªå‚æ•°çš„å…·ä½“æ ¼å¼ï¼Œä½ å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿›è¡Œå¥—æ¥å­—è½¬å‘ã€‚æ³¨æ„ï¼Œå¯¹äºè´Ÿè½½å‡è¡¡çš„åœºæ™¯æ¥è¯´ï¼Œåªéœ€è¦å¯¹å…¥å£è·¯å¾„è¿›è¡Œå¤„ç†ï¼Œå› è€Œè¿™å„¿è®¾ç½®äº† <code>BPF_F_INGRESS</code>ã€‚</p><pre><code class=\"language-c++\">bpf_msg_redirect_hash(msg, &amp;sock_ops_map, &amp;key, BPF_F_INGRESS);\n</code></pre><p>å†åŠ ä¸Šå¿…è¦çš„å¤´æ–‡ä»¶ä¹‹åï¼Œå®Œæ•´çš„ eBPF ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">#include &lt;linux/bpf.h&gt;\n#include &lt;bpf/bpf_endian.h&gt;\n#include &lt;bpf/bpf_helpers.h&gt;\n#include &lt;sys/socket.h&gt;\n#include \"sockops.h\"\n\n\n\nSEC(\"sk_msg\")\nint bpf_redir(struct sk_msg_md *msg)\n{\n    struct sock_key key = {\n        .sip = msg-&gt;remote_ip4,\n        .dip = msg-&gt;local_ip4,\n        .dport = bpf_htonl(msg-&gt;local_port),\n        .sport = msg-&gt;remote_port,\n        .family = msg-&gt;family,\n    };\n\n    bpf_msg_redirect_hash(msg, &amp;sock_ops_map, &amp;key, BPF_F_INGRESS);\n    return SK_PASS;\n}\n\nchar LICENSE[] SEC(\"license\") = \"Dual BSD/GPL\";\n</code></pre><p>æŠŠä¸Šè¿°ä»£ç ä¿å­˜åˆ°æ–‡ä»¶ <code>sockredir.bpf.c</code> ä¸­ï¼ˆä½ è¿˜å¯ä»¥åœ¨ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/loadbalancer/sockops/sockredir.bpf.c\">GitHub</a> ä¸­æ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼‰ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°†å…¶ç¼–è¯‘ä¸º BPF å­—èŠ‚ç ï¼š</p><pre><code class=\"language-bash\">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I/usr/include/x86_64-linux-gnu -I. -c sockredir.bpf.c -o sockredir.bpf.o\n</code></pre><h3>åŠ è½½ eBPF ç¨‹åº</h3><p>å¾—åˆ°å¥—æ¥å­—æ˜ å°„æ›´æ–°å’Œè½¬å‘è¿™ä¸¤ä¸ª BPF å­—èŠ‚ç ä¹‹åï¼Œè¿˜éœ€è¦æŠŠå®ƒä»¬åŠ è½½åˆ°å†…æ ¸ä¹‹ä¸­ï¼Œå†æŒ‚è½½åˆ°ç‰¹å®šçš„å†…æ ¸äº‹ä»¶ä¹‹åæ‰ä¼šç”Ÿæ•ˆã€‚åœ¨ä¹‹å‰çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»‹ç»çš„æ–¹æ³•æ˜¯åˆ©ç”¨ BCCã€libbpf ç­‰æä¾›çš„åº“å‡½æ•°ã€‚ä»Šå¤©ï¼Œæˆ‘å†ä¸ºä½ ä»‹ç»å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œå³é€šè¿‡å‘½ä»¤è¡Œå·¥å…· bpftool åŠ è½½å’ŒæŒ‚è½½ eBPF ç¨‹åºã€‚</p><p>é¦–å…ˆï¼Œå¯¹äº sockops ç¨‹åº <code>sockops.bpf.o</code> æ¥è¯´ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°†å…¶åŠ è½½åˆ°å†…æ ¸ä¸­ï¼š</p><pre><code class=\"language-bash\">sudo bpftool prog load sockops.bpf.o /sys/fs/bpf/sockops type sockops pinmaps /sys/fs/bpf\n</code></pre><p>è¿™æ¡å‘½ä»¤å°† <code>sockops.bpf.o</code> ä¸­çš„ eBPF ç¨‹åºå’Œæ˜ å°„åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œå¹¶å›ºå®šåˆ° BPF æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚å›ºå®šåˆ° BPF æ–‡ä»¶ç³»ç»Ÿçš„å¥½å¤„æ˜¯ï¼Œå³ä¾¿ bpftool å‘½ä»¤å·²ç»æ‰§è¡Œç»“æŸï¼ŒeBPF ç¨‹åºè¿˜ä¼šç»§ç»­åœ¨å†…æ ¸ä¸­è¿è¡Œï¼Œå¹¶ä¸” eBPF æ˜ å°„ä¹Ÿä¼šç»§ç»­å­˜åœ¨å†…æ ¸å†…å­˜ä¸­ã€‚</p><p>åŠ è½½æˆåŠŸåï¼Œä½ è¿˜å¯ä»¥æ‰§è¡Œ <code>bpftool prog show</code> å’Œ <code>bpftool map show</code> å‘½ä»¤ç¡®è®¤å®ƒä»¬çš„åŠ è½½ç»“æœã€‚æ‰§è¡ŒæˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºï¼š</p><pre><code class=\"language-bash\">$ sudo bpftool prog show name bpf_sockmap\n1062: sock_ops  name bpf_sockmap  tag e37ef726a3a85a2e  gpl\n\tloaded_at 2022-02-04T13:07:28+0000  uid 0\n\txlated 256B  jited 140B  memlock 4096B  map_ids 90\n\tbtf_id 234\n\n$ sudo bpftool map show name sock_ops_map\n90: sockhash  name sock_ops_map  flags 0x0\n\tkey 20B  value 4B  max_entries 65535  memlock 1572864B\n</code></pre><p>BPF å­—èŠ‚ç åŠ è½½æˆåŠŸä¹‹åï¼Œå…¶ä¸­çš„ eBPF ç¨‹åºè¿˜ä¸ä¼šè‡ªåŠ¨è¿è¡Œï¼Œå› ä¸ºè¿™æ—¶å€™å®ƒè¿˜æ²¡æœ‰ä¸å†…æ ¸äº‹ä»¶æŒ‚è½½ã€‚</p><p>å¯¹ sockops ç¨‹åºæ¥è¯´ï¼Œå®ƒæ”¯æŒæŒ‚è½½åˆ° cgroupsï¼Œä»è€Œå¯¹ cgroups æ‰€æ‹¥æœ‰çš„æ‰€æœ‰è¿›ç¨‹ç”Ÿæ•ˆï¼Œè¿™è·Ÿæˆ‘ä»¬æ¡ˆä¾‹çš„å®¹å™¨åœºæ™¯ä¹Ÿæ˜¯åŒ¹é…çš„ã€‚</p><p>è™½ç„¶ Docker æ”¯æŒæŠŠæ–°å®¹å™¨æŒ‚è½½åˆ° cgroups å­ç³»ç»Ÿä¸­ï¼Œä½†åœ¨æ¡ˆä¾‹å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®š cgroups å­ç³»ç»Ÿã€‚æ­¤æ—¶ï¼ŒDocker ä¼šè‡ªåŠ¨æŠŠæ‰€æœ‰å®¹å™¨éƒ½æ·»åŠ åˆ°ç³»ç»Ÿ cgroups å­ç³»ç»Ÿä¸­ã€‚æ‰€ä»¥ï¼Œå¯¹ sockops ç¨‹åºæ¥è¯´ï¼Œå°±å¯ä»¥æŠŠå®ƒæŒ‚è½½åˆ°ç³»ç»Ÿ cgroups ä¸­ï¼Œä»è€Œå¯¹åŒ…æ‹¬å®¹å™¨åº”ç”¨åœ¨å†…çš„æ‰€æœ‰è¿›ç¨‹ç”Ÿæ•ˆã€‚</p><p>ä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„ <code>mount</code> å‘½ä»¤ï¼ŒæŸ¥è¯¢å½“å‰ç³»ç»Ÿçš„ cgroups çš„æŒ‚è½½è·¯å¾„ï¼š</p><pre><code class=\"language-bash\">$ mount | grep cgroup\ncgroup2 on /sys/fs/cgroup type cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot)\n</code></pre><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸»æµçš„å‘è¡Œç‰ˆéƒ½ä¼šæŠŠ cgroups æŒ‚è½½åˆ° <code>/sys/fs/cgroup</code> è·¯å¾„ä¸‹ã€‚æ¥ç€ï¼Œå†æ‰§è¡Œä¸‹é¢çš„ <code>bpftool cgroup attach</code> å‘½ä»¤ï¼ŒæŠŠ sockops ç¨‹åºæŒ‚è½½åˆ° cgroups è·¯å¾„ä¸­ï¼š</p><pre><code class=\"language-bash\">sudo bpftool cgroup attach /sys/fs/cgroup/ sock_ops pinned /sys/fs/bpf/sockops\n</code></pre><p>åˆ°è¿™é‡Œï¼Œsockops ç¨‹åºçš„åŠ è½½å’ŒæŒ‚è½½å°±å®Œæˆäº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå†æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ŒåŠ è½½å¹¶æŒ‚è½½ sk_msg ç¨‹åº <code>sockredir.bpf.o</code>ï¼š</p><pre><code class=\"language-bash\">sudo bpftool prog load sockredir.bpf.o /sys/fs/bpf/sockredir type sk_msg map name sock_ops_map pinned /sys/fs/bpf/sock_ops_map\nsudo bpftool prog attach pinned /sys/fs/bpf/sockredir msg_verdict pinned /sys/fs/bpf/sock_ops_map\n</code></pre><p>ä»è¿™ä¸¤æ¡å‘½ä»¤ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œsk_msg ç¨‹åºçš„åŠ è½½å’ŒæŒ‚è½½è¿‡ç¨‹è·Ÿ sockops ç¨‹åºæ˜¯ç±»ä¼¼çš„ï¼ŒåŒºåˆ«åªåœ¨äºå®ƒä»¬çš„ç¨‹åºç±»å‹å’ŒæŒ‚è½½ç±»å‹ä¸åŒï¼š</p><ul>\n<li>sockops ç¨‹åºçš„ç±»å‹æ˜¯ <code>sock_ops</code>ï¼Œsk_msg ç¨‹åºçš„ç±»å‹æ˜¯ <code>sk_msg</code>ï¼›</li>\n<li>sockops ç¨‹åºçš„æŒ‚è½½ç±»å‹æ˜¯ <code>cgroup</code> ï¼ˆå¯¹åº” <code>bpftool cgroup attach</code> å‘½ä»¤ï¼‰ï¼Œsk_msg ç¨‹åºçš„æŒ‚è½½ç±»å‹æ˜¯ <code>msg_verdict</code>ï¼ˆå¯¹åº” <code>bpftool prog attach</code> å‘½ä»¤ï¼‰ã€‚</li>\n</ul><p>ç”±äº sk_msg ç¨‹åºéœ€è¦è®¿é—® sockops ç¨‹åºåˆ›å»ºçš„å¥—æ¥å­—æ˜ å°„ï¼Œæ‰€ä»¥ä¸Šè¿°å‘½ä»¤é€šè¿‡ BPF æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ <code>/sys/fs/bpf/sock_ops_map</code> å¯¹å¥—æ¥å­—æ˜ å°„è¿›è¡Œäº†ç»‘å®šã€‚</p><p>åˆ°è¿™é‡Œï¼Œä¸¤ä¸ª eBPF ç¨‹åºçš„åŠ è½½å’ŒæŒ‚è½½å°±éƒ½å®Œæˆäº†ã€‚</p><p>é‚£ä¹ˆï¼Œå®ƒä»¬æ˜¯ä¸æ˜¯çœŸçš„å¯ä»¥æå‡ç½‘ç»œè½¬å‘çš„æ€§èƒ½å‘¢ï¼Ÿå›æƒ³ä¸€ä¸‹ Nginx è´Ÿè½½å‡è¡¡çš„æµ‹è¯•æ­¥éª¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•å†åšä¸ªæ€§èƒ½æµ‹è¯•ï¼Œå°±å¯ä»¥çŸ¥é“äº†ã€‚</p><h3>æ€§èƒ½æµ‹è¯•</h3><p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›å…¥ client å®¹å™¨ç»ˆç«¯ï¼Œå¹¶åœ¨å®¹å™¨ç»ˆç«¯ä¸­æ‰§è¡Œ <code>wrk</code> å‘½ä»¤ï¼š</p><pre><code class=\"language-bash\">docker exec -it client sh\n/ # wrk -c100 \"http://172.17.0.5\"\n</code></pre><p>ç¨ç­‰ä¸€ä¼šï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼ˆåœ¨ä½ çš„ç¯å¢ƒä¸‹å¯èƒ½çœ‹åˆ°ä¸åŒæ•°å€¼ï¼Œå…·ä½“çš„æ€§èƒ½æŒ‡æ ‡å–å†³äºè¿è¡Œç¯å¢ƒå’Œé…ç½®ï¼‰ï¼š</p><pre><code class=\"language-bash\">Running 10s test @ http://172.17.0.5\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     6.88ms    4.71ms  46.08ms   70.77%\n    Req/Sec     7.70k   548.11     9.10k    66.50%\n  153466 requests in 10.03s, 24.15MB read\nRequests/sec:  15300.71\nTransfer/sec:      2.41MB\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ–°çš„å¹³å‡æ¯ç§’è¯·æ±‚æ•°æ˜¯ 15300ï¼Œç›¸æ¯”ä¼˜åŒ–ä¹‹å‰çš„ 13798 æå‡äº† 10.8%ï¼›è€Œæ¯ä¸ªçº¿ç¨‹çš„å¹³å‡å»¶è¿Ÿ 6.88ms ä¹Ÿæ¯”ä¹‹å‰çš„ 7.53ms é™ä½äº† 8.6%ã€‚è¿™è¯´æ˜ï¼ŒeBPF çœŸçš„ä¼˜åŒ–äº†è´Ÿè½½å‡è¡¡å™¨çš„è½¬å‘æ€§èƒ½ï¼Œè¿™è·Ÿæˆ‘ä»¬ä¸€å¼€å§‹çš„çŒœæƒ³æ˜¯ä¸€è‡´çš„ã€‚</p><h3>æ¡ˆä¾‹æ¸…ç†</h3><p>æ¡ˆä¾‹çš„æœ€åï¼Œä¸è¦å¿˜è®°æ¸…ç†ä»Šå¤©æ‰€åŠ è½½çš„ eBPF ç¨‹åºä»¥åŠå®¹å™¨ç¯å¢ƒã€‚</p><p>å¯¹äº eBPF ç¨‹åºæ¥è¯´ï¼Œæ¸…ç†è¿‡ç¨‹éœ€è¦å¸è½½ï¼ˆdetachï¼‰å’Œåˆ é™¤ï¼ˆunloadï¼‰ä¸¤ä¸ªæ­¥éª¤ã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°±å¯ä»¥å¸è½½å’Œåˆ é™¤ skops å’Œ sk_msg è¿™ä¸¤ä¸ªç¨‹åºï¼š</p><pre><code class=\"language-bash\"># cleanup skops prog and sock_ops_map\nsudo bpftool cgroup detach /sys/fs/cgroup/ sock_ops name bpf_sockmap\nsudo rm -f /sys/fs/bpf/sockops /sys/fs/bpf/sock_ops_map\n\n# cleanup sk_msg prog\nsudo bpftool prog detach pinned /sys/fs/bpf/sockredir msg_verdict pinned /sys/fs/bpf/sock_ops_map\nsudo rm -f /sys/fs/bpf/sockredir\n</code></pre><p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œä¸ <code>attach</code> ç›¸å¯¹åº”çš„æ¸…ç†æ“ä½œä¸º <code>detach</code>ï¼Œä½† bpftool å¹¶æ²¡æœ‰ä¸€ä¸ªä¸ <code>load</code> ç›¸å¯¹åº”çš„ <code>unload</code> å­å‘½ä»¤ã€‚è¿™æ˜¯å› ä¸ºï¼ŒeBPF ç¨‹åºå’Œæ˜ å°„éƒ½æ˜¯ä¸ BPF æ–‡ä»¶ç³»ç»Ÿç»‘å®šçš„ï¼Œæ–‡ä»¶åˆ é™¤åï¼Œå®ƒä»¬å¼•ç”¨è®¡æ•°é™ä¸º 0 ï¼Œå°±ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨æ¸…ç†äº†ï¼Œæ‰€ä»¥åˆ é™¤è¿‡ç¨‹åªéœ€è¦æŠŠ BPF æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶åˆ é™¤å³å¯ã€‚</p><p>è€Œå¯¹äºå®¹å™¨çš„æ¸…ç†å°±æ›´å®¹æ˜“äº†ï¼Œåªéœ€è¦æ‰§è¡Œä¸‹é¢çš„ <code>docker rm</code> å‘½ä»¤å³å¯ï¼š</p><pre><code class=\"language-bash\">docker rm -f http1 http2 client nginx\n</code></pre><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ æ­å»ºäº†ä¸€ä¸ªæœ€ç®€å•çš„è´Ÿè½½å‡è¡¡ç¨‹åºï¼Œå¹¶å€ŸåŠ©å¥—æ¥å­— eBPF ç¨‹åºå¯¹å®ƒçš„æ€§èƒ½è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p><p>å€ŸåŠ© sockops å’Œ sk_msg ç­‰å¥—æ¥å­— eBPF ç¨‹åºï¼Œä½ å¯ä»¥åœ¨å†…æ ¸æ€ä¸­ç›´æ¥å°†ç½‘ç»œåŒ…è½¬å‘ç»™ç›®çš„åº”ç”¨çš„å¥—æ¥å­—ï¼Œè·³è¿‡å¤æ‚çš„å†…æ ¸åè®®æ ˆï¼Œä»è€Œæå‡ç½‘ç»œè½¬å‘çš„æ€§èƒ½ã€‚</p><p>åœ¨éœ€è¦åŠ è½½å’ŒæŒ‚è½½ eBPF ç¨‹åºæˆ–æ˜ å°„æ—¶ï¼Œé™¤äº†å¯ä»¥åˆ©ç”¨ BCCã€libbpf ç­‰æä¾›çš„åº“å‡½æ•°ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ bpftool è¿™ä¸ªå·¥å…·æ¥å®ç°ã€‚ç”±äº eBPF ç¨‹åºåŠç›¸å…³çš„å·¥å…·è¿˜åœ¨å¿«é€Ÿè¿›åŒ–ä¸­ï¼Œåœ¨ç¢°åˆ°ä¸ç¡®å®šçš„ç–‘é—®æ—¶ï¼Œæˆ‘æ¨èä½ å‚è€ƒè·Ÿå½“å‰å†…æ ¸ç‰ˆæœ¬åŒ¹é…çš„å†…æ ¸å¤´æ–‡ä»¶å®šä¹‰ã€man æ‰‹å†Œç­‰ï¼Œå»æŸ¥è¯¢å…³äºå®ƒä»¬çš„è¯¦ç»†æ–‡æ¡£ï¼Œè€Œä¸è¦å•çº¯ä¾èµ–äºç½‘ç»œæœç´¢ã€‚</p><p>å½“ç„¶ï¼Œå¯¹äºç½‘ç»œä¼˜åŒ–æ¥è¯´ï¼Œé™¤äº†å¥—æ¥å­— eBPF ç¨‹åºä¹‹å¤–ï¼ŒXDP ç¨‹åºå’Œ TC ç¨‹åºä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼Œæˆ‘å°†åœ¨ä¸‹ä¸€è®²ä¸­ä¸ºä½ ä»‹ç» XDP ç¨‹åºçš„è¯¦ç»†ä½¿ç”¨æ–¹æ³•ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åçš„æ€è€ƒé¢˜ç¯èŠ‚ï¼Œæˆ‘ä»¬æ¥æ¢è®¨å…³äºæ’æŸ¥å¥—æ¥å­—æ˜ å°„çš„é—®é¢˜ã€‚</p><p>ç”±äºä»Šå¤©çš„æ¡ˆä¾‹ä¸­æ²¡æœ‰æ·»åŠ æ—¥å¿—ï¼Œæ‰€ä»¥è¦æƒ³è§‚å¯Ÿ eBPF ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œåªèƒ½é€šè¿‡å¥—æ¥å­—æ˜ å°„ï¼Œè€Œ <code>bpftool map dump</code> å‘½ä»¤åˆ™æä¾›äº†æŸ¥çœ‹å¥—æ¥å­—æ˜ å°„å†…å®¹çš„åŠŸèƒ½ã€‚</p><p>åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä¸‹é¢çš„ <code>nc</code> å‘½ä»¤ï¼Œæ–°å»ºä¸€ä¸ªåˆ° Nginx å®¹å™¨çš„è¿æ¥ï¼š</p><pre><code class=\"language-bash\">nc 172.17.0.5 80\n</code></pre><p>ç„¶åæ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ï¼Œæ‰§è¡Œä¸‹é¢çš„ <code>bpftool map dump</code> å‘½ä»¤ï¼š</p><pre><code class=\"language-bash\">sudo bpftool map dump name sock_ops_map\n</code></pre><p>æ¥ç€ï¼Œä½ å°±ä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">key:\nac 11 00 01 ac 11 00 05  00 00 be 12 00 00 00 50\n02 00 00 00\nvalue:\nNo space left on device\nkey:\nac 11 00 05 ac 11 00 01  00 00 00 50 00 00 be 12\n02 00 00 00\nvalue:\nNo space left on device\n</code></pre><p>ç”±äº value å¯¹åº”çš„æ˜¯å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œbpftool æ— æ³•æ˜¾ç¤ºå®ƒçš„å†…å®¹ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¿½ç•¥ <code>No space left on device</code> çš„é”™è¯¯ï¼ˆå®é™…ä¸Šè¿™ä¸ªé”™è¯¯ä¿¡æ¯æ˜¯ä¸å‡†ç¡®çš„ï¼Œæ–°ç‰ˆæœ¬ä¸­å·²ç»ä¿®å¤äº†é”™è¯¯ä¿¡æ¯ï¼‰ã€‚</p><p>è€Œå¯¹äº key æ¥è¯´ï¼Œåˆ™æ˜¯ä¸€é•¿ä¸²çš„åå…­è¿›åˆ¶æ•°å€¼ã€‚è¿™é‡Œæˆ‘æƒ³è¯·ä½ æ€è€ƒä¸¤ä¸ªé—®é¢˜ï¼š</p><ol>\n<li>è¿™äº›åå…­è¿›åˆ¶æ•°å€¼æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå®ƒä»¬æ˜¯å¦‚ä½•è·Ÿ eBPF ç¨‹åºä¸­å®šä¹‰çš„ <code>struct sock_key</code> å…³è”çš„ï¼Ÿ</li>\n<li>ä½ å¯ä»¥å°è¯•æŠŠè¿™äº›åå…­è¿›åˆ¶æ•°å€¼è½¬æ¢æˆ <code>struct sock_key</code> æ•°æ®ç»“æ„ï¼Œå¹¶è®¡ç®—å‡ºæ¯ä¸ªå±æ€§çš„å€¼å—ï¼Ÿ</li>\n</ol><p>æœŸå¾…ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p>","neighbors":{"left":{"article_title":"11 | å®¹å™¨å®‰å…¨ï¼šå¦‚ä½•ä½¿ç”¨eBPFå¢å¼ºå®¹å™¨å®‰å…¨ï¼Ÿ","id":485101},"right":{"article_title":"13ï½œé«˜æ€§èƒ½ç½‘ç»œå®æˆ˜ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•å®Œå–„è´Ÿè½½å‡è¡¡å™¨ï¼Ÿ","id":486353}},"comments":[{"had_liked":false,"id":333814,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1644546961,"is_pvip":false,"replies":[{"id":122040,"content":"è§£æçš„éå¸¸æ­£ç¡®ã€‚\n\nå¯¹äºä½ çš„ç–‘é—®ï¼Œå…¶å®ä½ åˆ°å®¢æˆ·ç«¯å®¹å™¨ä¸­æ‰§è¡Œç›¸åŒçš„ncå‘½ä»¤ï¼Œå†è§‚å¯Ÿä¸€ä¸‹æ˜ å°„ä¸­çš„å†…å®¹ï¼Œç­”æ¡ˆè‡ªç„¶å°±æœ‰äº†ã€‚è¿™å„¿çœ‹åˆ°172.17.0.1æ˜¯å› ä¸ºæ€è€ƒé¢˜ä¸­çš„ncå‘½ä»¤æ˜¯åœ¨ä¸»æœºç»ˆç«¯ä¸­æ‰§è¡Œçš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644733190,"ip_address":"","comment_id":333814,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"key:\nac 11 00 05 ac 11 00 01 00 00 00 50 00 00 be 12\n02 00 00 00\n\nä»¥è¯¥ key ä¸ºä¾‹ï¼Œstruct sock_key å…± 5 ä¸ª u32 ç±»å‹çš„å­—æ®µï¼Œæ¯ä¸ªå­—æ®µå››ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­ï¼š\n\nac 11 00 05  -&gt;    sipï¼Œç½‘ç»œå­—èŠ‚åºï¼Œæº IP 172.17.0.5ï¼Œå¯¹åº”è´Ÿè½½å‡è¡¡å™¨å®¹å™¨ IP\nac 11 00 01   -&gt;    dip, ç½‘ç»œå­—èŠ‚åºï¼Œç›®çš„ IP 172.17.0.1ï¼Œå¯¹åº” Docker ç½‘æ¡¥ docker0 IP åœ°å€ï¼Œå³æœ¬æœºæ‰€æœ‰å®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚\n00 00 00 50 -&gt; sport, ç½‘ç»œå­—èŠ‚åºï¼Œæºç«¯å£ 80ã€‚\n00 00 be 12  -&gt; dport, ç½‘ç»œå­—èŠ‚åºï¼Œç›®çš„ç«¯å£ 48658ã€‚\n02 00 00 00 -&gt; familyï¼Œä¸»æœºå­—èŠ‚åºï¼ŒAF_INET åè®®ï¼Œå…·ä½“å®šä¹‰ä¸ºï¼š #define AF_INET  2\t  &#47;* Internet IP Protocol *&#47;\n\nå¯¹ SKB ç±»å‹çš„ BPF ç¨‹åºäº†è§£ä¸å¤šï¼Œè¿™é‡Œæƒ³è¯·æ•™ä¸‹å€ªè€å¸ˆï¼Œç›®çš„ IP (172.17.0.1) ä¸ºä»€ä¹ˆæ˜¯ Docker ç½‘æ¡¥çš„ IP ï¼Ÿè·Ÿ sk_msg è½¬å‘é€»è¾‘æœ‰å…³ä¹ˆï¼Ÿæˆ‘ç†è§£æ­£å¸¸æƒ…å†µä¸‹ç›®çš„ IP åº”è¯¥æ˜¯å®¢æˆ·ç«¯å®¹å™¨ IPã€‚","like_count":7,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550796,"discussion_content":"è§£æçš„éå¸¸æ­£ç¡®ã€‚\n\nå¯¹äºä½ çš„ç–‘é—®ï¼Œå…¶å®ä½ åˆ°å®¢æˆ·ç«¯å®¹å™¨ä¸­æ‰§è¡Œç›¸åŒçš„ncå‘½ä»¤ï¼Œå†è§‚å¯Ÿä¸€ä¸‹æ˜ å°„ä¸­çš„å†…å®¹ï¼Œç­”æ¡ˆè‡ªç„¶å°±æœ‰äº†ã€‚è¿™å„¿çœ‹åˆ°172.17.0.1æ˜¯å› ä¸ºæ€è€ƒé¢˜ä¸­çš„ncå‘½ä»¤æ˜¯åœ¨ä¸»æœºç»ˆç«¯ä¸­æ‰§è¡Œçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644733190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":1007254,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","nickname":"è«å","note":"","ucode":"E28F2602BA25DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":550805,"discussion_content":"æ„Ÿè°¢å€ªè€å¸ˆçš„è§£æƒ‘ã€‚é‚£å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œè·³è¯»äº†åé¢çš„å†…å®¹æ²¡çœ‹åˆ°æ‰§è¡Œ nc å‘½ä»¤ã€‚åœ¨å®¿ä¸»æœºä¸Šé¢æ‰§è¡Œ ncï¼Œèµ°è·¯ç”±è§„åˆ™ 172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644740270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550796,"ip_address":"","group_id":0},"score":550805,"extra":""},{"author":{"id":2840236,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/56/ac/a047a944.jpg","nickname":"ææ¸…æ³‰ğŸ»","note":"","ucode":"376F9F294307E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":645403,"discussion_content":"è€å¸ˆï¼Œæˆ‘æ²¡çœ‹æ‡‚ï¼Œä¸ºä»€ä¹ˆè®¾ç½®send_msgæ—¶ï¼Œå°†local_ip local_portä½œä¸ºç°åœ¨é‡å®šå‘çš„socket çš„keyå‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1716112201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550796,"ip_address":"å¹¿ä¸œ","group_id":0},"score":645403,"extra":""},{"author":{"id":2840236,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/56/ac/a047a944.jpg","nickname":"ææ¸…æ³‰ğŸ»","note":"","ucode":"376F9F294307E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1007254,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","nickname":"è«å","note":"","ucode":"E28F2602BA25DD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":645404,"discussion_content":"è€å¸ˆï¼Œæˆ‘æ²¡çœ‹æ‡‚ï¼Œä¸ºä»€ä¹ˆè®¾ç½®send_msgæ—¶ï¼Œå°†local_ip local_portä½œä¸ºç°åœ¨é‡å®šå‘çš„socket çš„keyå‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1716112207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550805,"ip_address":"å¹¿ä¸œ","group_id":0},"score":645404,"extra":""}]}]},{"had_liked":false,"id":338455,"user_name":"Geek9635","can_delete":false,"product_type":"c1","uid":2845507,"ip_address":"","ucode":"742198F80001DF","user_header":"","comment_is_top":false,"comment_ctime":1647508055,"is_pvip":false,"replies":[{"id":124035,"content":"è¿™æ˜¯æœ‰æœ‰å¯èƒ½çš„ã€‚å¦‚æœç³»ç»Ÿæœ¬èº«çš„æ€§èƒ½å°±ä¸å¤ªå¥½ï¼Œä¸å€ŸåŠ©ç¡¬ä»¶offloadæ–¹å¼çš„ä¼˜åŒ–æ–¹æ³•æœ‰å¯èƒ½æ”¶ç›Šå¹¶ä¸æ˜æ˜¾ã€‚æ¯”å¦‚ï¼Œå¾ˆå¤šåº”ç”¨æœ¬èº«å°±æœ‰è¯¸å¦‚CPUã€å¤šçº¿ç¨‹æˆ–è€…ç£ç›˜I&#47;Oç­‰æ–¹é¢çš„ç“¶é¢ˆï¼Œå†…æ ¸åè®®æ ˆå¸¦æ¥çš„æ€§èƒ½æŸå¤±åœ¨æ•´ä¸ªåº”ç”¨çš„æ€§èƒ½ä¸­æœ‰å¯èƒ½å¾ˆå°ï¼Œè¿™æ—¶å€™å†å»ä¼˜åŒ–å†…æ ¸åè®®æ ˆï¼Œå½“ç„¶ä¹Ÿå¾ˆéš¾è·å¾—å¾ˆå¤§çš„æ€§èƒ½ä¼˜åŒ–æ•ˆæœã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1648039268,"ip_address":"","comment_id":338455,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"åœ¨å®é™…åº”ç”¨sockmapæ—¶ï¼Œé‡åˆ°ä¸€ä¸ªæ€§èƒ½é—®é¢˜\næˆ‘çš„ä¸šåŠ¡æ¨¡å‹æ˜¯åŒä¸€ä¸ªpodå†…ï¼Œéƒ¨ç½²nginxåŠä¸€ä¸ªjavaå†™çš„api-proxyç¨‹åºï¼Œä¸¤è€…ä¹‹é—´é€šè¿‡127.0.0.1é€šä¿¡ï¼ˆé•¿è¿æ¥ï¼‰\næƒ³ä½¿ç”¨sockmapèƒ½åŠ›åœ¨è¿›ç¨‹ä¹‹é—´åŠ é€Ÿï¼Œå®é™…æµ‹è¯•ç”¨wrkæ‰“æµï¼ˆé€šè¿‡åŸŸåï¼‰åˆ°podçš„nginxï¼Œå‘ç°ä½¿ç”¨sockmapå¹¶æ²¡æœ‰å¸¦æ¥æ€§èƒ½çš„æå‡ï¼ˆä»sarçœ‹podå†…loå£æµé‡æ˜¯0ï¼‰\næŠ“å–sock_sendmsgåˆ°sock_recvmsgä¹‹é—´çš„æ—¶é—´åˆ†å¸ƒè§åï¼š\nnginxæ˜¯å¤šè¿›ç¨‹å•çº¿ç¨‹çš„ï¼Œé‚£ä¸ªjavaç¨‹åºæ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹çš„ï¼ˆæŠ“å–çš„æ—¶é—´åˆ†å¸ƒæ˜¯ä¸¤è€…ä¹‹é—´çš„send-&gt;revcæ—¶é—´å·®ï¼Œç¬¬ä¸€åˆ—æ˜¯è€—æ—¶åŒºé—´ï¼Œç¬¬äºŒåˆ—æ˜¯æ¬¡æ•°ï¼‰\n\nä»è€—æ—¶åˆ†å¸ƒæƒ…å†µçœ‹ï¼Œsockmapå¹¶æ²¡ç”¨æ˜æ˜¾ä¼˜åŠ¿ï¼ˆä¸šåŠ¡cpuå·²åŸºæœ¬æ‰“æ»¡ï¼‰\nä½†å¦‚æœç®€å•ç”¨netperf tcp_rræµ‹è¯•ï¼ŒsockmapåŸºæœ¬è€—æ—¶åˆ†å¸ƒåœ¨8-16usecsï¼Œæ— socketmapåŸºæœ¬åœ¨16-32usecs\n\næƒ³è¯·æ•™è€å¸ˆï¼Œè¿™æ˜¯sockmapæœ¬èº«çš„æ€§èƒ½é—®é¢˜ï¼ˆå®ç°sockä¹‹é—´æŠ¥æ–‡è½¬å‘çš„æµç¨‹ä¹ŸæŒºå¤æ‚çš„ï¼‰ï¼Œè¿˜æ˜¯ä½¿ç”¨æ–¹å¼æ–¹æ³•ä¸å¯¹ï¼Ÿ\nè¿™ç§å¤æ‚æ¨¡å‹çš„æ€§èƒ½åˆ†æä¹Ÿéå¸¸éš¾ï¼Œè€å¸ˆæ˜¯å¦æœ‰æ¯•ç«Ÿå¥½çš„æ–¹æ³•ï¼Œè°¢è°¢\n\n@normal(usecs): \t\t\t\t\n[4, 8)                37 |\n[8, 16)           131639 |\n[16, 32)         2206394 |\n[32, 64)          796467 |\n[64, 128)         511059 |\n[128, 256)        378776 |\n[256, 512)        294895 |\n[512, 1K)         140723 |\n[1K, 2K)           26766 |\n[2K, 4K)           10600 |\n[4K, 8K)            8053 |\n[8K, 16K)           2607 |\n[16K, 32K)             6 |\n\n@ebpf sockmap(usecs): \n[4, 8)             20150 |\n[8, 16)          1046770 |\n[16, 32)         1597489 |\n[32, 64)          574600 |\n[64, 128)         425788 |\n[128, 256)        369249 |\n[256, 512)        327745 |\n[512, 1K)         187195 |\n[1K, 2K)           32752 |\n[2K, 4K)            9646 |\n[4K, 8K)            7825 |\n[8K, 16K)           2140 |\n[16K, 32K)           187 |\n","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557995,"discussion_content":"è¿™æ˜¯æœ‰æœ‰å¯èƒ½çš„ã€‚å¦‚æœç³»ç»Ÿæœ¬èº«çš„æ€§èƒ½å°±ä¸å¤ªå¥½ï¼Œä¸å€ŸåŠ©ç¡¬ä»¶offloadæ–¹å¼çš„ä¼˜åŒ–æ–¹æ³•æœ‰å¯èƒ½æ”¶ç›Šå¹¶ä¸æ˜æ˜¾ã€‚æ¯”å¦‚ï¼Œå¾ˆå¤šåº”ç”¨æœ¬èº«å°±æœ‰è¯¸å¦‚CPUã€å¤šçº¿ç¨‹æˆ–è€…ç£ç›˜I/Oç­‰æ–¹é¢çš„ç“¶é¢ˆï¼Œå†…æ ¸åè®®æ ˆå¸¦æ¥çš„æ€§èƒ½æŸå¤±åœ¨æ•´ä¸ªåº”ç”¨çš„æ€§èƒ½ä¸­æœ‰å¯èƒ½å¾ˆå°ï¼Œè¿™æ—¶å€™å†å»ä¼˜åŒ–å†…æ ¸åè®®æ ˆï¼Œå½“ç„¶ä¹Ÿå¾ˆéš¾è·å¾—å¾ˆå¤§çš„æ€§èƒ½ä¼˜åŒ–æ•ˆæœã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648039268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1287556,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKnrjcKrRp5atleQiaD4yYw1sjguFOCCwldjE4T2cicicQaT9ELfKFhmUibT0m9gUicyHIDP9ZBdBwZk5w/132","nickname":"crezov","note":"","ucode":"F580279E92CA1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624250,"discussion_content":"è¯·é—®ç¨‹åºæ‰€ä½¿ç”¨çš„Linuxå‘è¡Œç‰ˆæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘æµ‹è¯•ç”¨äº†Alpineå‘è¡Œç‰ˆï¼ˆå®¹å™¨ï¼‰ï¼Œé€šè¿‡åœ¨sock_ops.bpf.cä¸­æ‰“logï¼Œå‘ç°æœ¬æœºé€šä¿¡æ—¶ï¼Œä¸ä¼šè§¦å‘BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CBï¼Œå¯¼è‡´sock_redir.bpf.cä¸­é‡å®šå‘å¤±è´¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1690363284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333951,"user_name":"maosd199554","can_delete":false,"product_type":"c1","uid":2079873,"ip_address":"","ucode":"B34D78FF9CB378","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlibz5085KSjlsAqSrYKiboLvzm3TYibVAMHjbCz6ibpcUWMa2AOUctyvVRSuVe3HP7YwYcwzwYmh5GQ/132","comment_is_top":false,"comment_ctime":1644635286,"is_pvip":false,"replies":[{"id":122036,"content":"å—¯å—¯ï¼Œæ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644731867,"ip_address":"","comment_id":333951,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œè¿™ç§åªé€‚åˆLBè·ŸæœåŠ¡éƒ¨ç½²åŒä¸€ä¸ªæœåŠ¡å™¨å§ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550788,"discussion_content":"å—¯å—¯ï¼Œæ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644731868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1665832,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/pJJpwhFRpXm1NFJ8HuiapckC8IibS0eHY99XqnAUtpicHXDdiajK3ObthbnenMTwRDGgvfv86LPEjKq06wzd9o8sHQ/132","nickname":"Geek_c0ea3b","note":"","ucode":"3F054407CDCF40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588799,"discussion_content":"æˆ‘ç†è§£çš„æ˜¯ä»–ä»¬åœ¨ä¸€ä¸ªvlanå°±è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664115678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1665832,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/pJJpwhFRpXm1NFJ8HuiapckC8IibS0eHY99XqnAUtpicHXDdiajK3ObthbnenMTwRDGgvfv86LPEjKq06wzd9o8sHQ/132","nickname":"Geek_c0ea3b","note":"","ucode":"3F054407CDCF40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588798,"discussion_content":"æˆ‘æŠŠLBå’ŒnginxæœåŠ¡åˆ†å¼€éƒ¨ç½²ï¼Œç¡®å®ä¸è¡Œã€‚å¤§ä½¬ï¼Œè¯·æ•™ä¸€ä¸‹ä¸ºä»€ä¹ˆåªé€‚åˆLBè·ŸæœåŠ¡éƒ¨ç½²åŒä¸€ä¸ªæœåŠ¡å™¨å§å‘¢ï¼Ÿ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664115612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338624,"user_name":"Geek9635","can_delete":false,"product_type":"c1","uid":2845507,"ip_address":"","ucode":"742198F80001DF","user_header":"","comment_is_top":false,"comment_ctime":1647604826,"is_pvip":false,"replies":[{"id":124034,"content":"ä½¿ç”¨wrkæµ‹è¯•çš„ç»“æœæ˜¯å¤šå°‘ï¼Ÿå¦‚æœæœºå™¨æœ¬èº«çš„æ€§èƒ½ä¸å¤ªå¥½ï¼ˆæ¯”å¦‚CPUèµ„æºæœ¬èº«å°±ä¸è¶³çš„æƒ…å†µä¸‹ï¼‰ï¼Œä½¿ç”¨sockmapæˆ–è€…å…¶ä»–çš„eBPFæŠ€æœ¯å¸¦æ¥çš„æ€§èƒ½æ”¶ç›Šçš„ç¡®æœ‰å¯èƒ½æ˜¯ä¸æ˜æ˜¾çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1648039000,"ip_address":"","comment_id":338624,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æœ‰äººèƒ½å¤ç°è€å¸ˆçš„æµ‹è¯•ç»“æœä¹ˆï¼Ÿ\næˆ‘åœ¨centos8.3ä¸Šæµ‹è¯•ï¼Œæ€§èƒ½æ²¡æœ‰å¤ªå¤§å˜åŒ–ï¼ˆæŠ“åŒ…ç¡®è®¤sockmapåŠŸèƒ½ç”Ÿæ•ˆï¼‰\n\nnsenter -t 201559 -n sar -n DEV 1\nAverage:        IFACE   rxpck&#47;s   txpck&#47;s    rxkB&#47;s    txkB&#47;s   rxcmp&#47;s   txcmp&#47;s  rxmcst&#47;s   %ifutil\nAverage:           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00\nAverage:         eth0  20805.67  20663.00   1595.32   2001.95      0.00      0.00      0.00      0.00\n\næµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œnginx cpuå ç”¨éå¸¸é«˜\nTasks: 645 total,  12 running, 633 sleeping,   0 stopped,   0 zombie\n%Cpu(s):  1.9 us, 31.2 sy,  0.0 ni, 65.2 id,  0.2 wa,  0.3 hi,  1.2 si,  0.0 st\nMiB Mem : 385191.7 total, 336110.5 free,   9242.4 used,  39838.9 buff&#47;cache\nMiB Swap:      0.0 total,      0.0 free,      0.0 used. 361619.3 avail Mem\n\n   PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                            \n373492 101       20   0    9388   3504   2076 R  97.1   0.0   4:40.45 nginx                                                                              \n373493 101       20   0    9388   3508   2076 R  97.1   0.0   4:14.85 nginx                                                                              \n373495 101       20   0    9388   3496   2076 R  97.1   0.0   6:18.71 nginx                                                                              \n373496 101       20   0    9388   3476   2076 R  97.1   0.0   5:07.61 nginx                                                                              \n373498 101       20   0    9388   3504   2076 R  97.1   0.0   5:28.36 nginx                                                                              \n373501 101       20   0    9388   3480   2076 R  97.1   0.0   6:23.90 nginx                                                                             \n373503 101       20   0    9388   3476   2076 R  97.1   0.0   5:37.27 nginx                                                                           \n","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557994,"discussion_content":"ä½¿ç”¨wrkæµ‹è¯•çš„ç»“æœæ˜¯å¤šå°‘ï¼Ÿå¦‚æœæœºå™¨æœ¬èº«çš„æ€§èƒ½ä¸å¤ªå¥½ï¼ˆæ¯”å¦‚CPUèµ„æºæœ¬èº«å°±ä¸è¶³çš„æƒ…å†µä¸‹ï¼‰ï¼Œä½¿ç”¨sockmapæˆ–è€…å…¶ä»–çš„eBPFæŠ€æœ¯å¸¦æ¥çš„æ€§èƒ½æ”¶ç›Šçš„ç¡®æœ‰å¯èƒ½æ˜¯ä¸æ˜æ˜¾çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648039000,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1287556,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKnrjcKrRp5atleQiaD4yYw1sjguFOCCwldjE4T2cicicQaT9ELfKFhmUibT0m9gUicyHIDP9ZBdBwZk5w/132","nickname":"crezov","note":"","ucode":"F580279E92CA1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624252,"discussion_content":"è¯·é—®ç¨‹åºæ‰€ä½¿ç”¨çš„Linuxå‘è¡Œç‰ˆæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘æµ‹è¯•ç”¨äº†Alpineå‘è¡Œç‰ˆï¼ˆå®¹å™¨ï¼‰ï¼Œé€šè¿‡åœ¨sock_ops.bpf.cä¸­æ‰“logï¼Œå‘ç°æœ¬æœºé€šä¿¡æ—¶ï¼Œä¸ä¼šè§¦å‘BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CBï¼Œå¯¼è‡´sock_redir.bpf.cä¸­é‡å®šå‘å¤±è´¥ï¼Œè¿›è€Œå¯¼è‡´æ€§èƒ½æ²¡æœ‰æå‡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1690363461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335694,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1645629748,"is_pvip":true,"replies":[{"id":122797,"content":"ğŸ‘ è°¢è°¢åˆ†äº«é…ç½®çš„ç»éªŒã€‚ä½ çš„å‘è¡Œç‰ˆæ˜¯ä»€ä¹ˆï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1645878409,"ip_address":"","comment_id":335694,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¦å¼€å¯cgroup v2ï¼Œgrubä¿®æ”¹é‡å¯æ‰æå®šğŸ˜…","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553405,"discussion_content":"ğŸ‘ è°¢è°¢åˆ†äº«é…ç½®çš„ç»éªŒã€‚ä½ çš„å‘è¡Œç‰ˆæ˜¯ä»€ä¹ˆï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1645878409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1066752,"avatar":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","nickname":"piboye","note":"","ucode":"7CFD8712857A85","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":553615,"discussion_content":"å…¬å¸å†…éƒ¨çš„tlinuxï¼ŒåŸºäºcentos","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645979928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":553405,"ip_address":"","group_id":0},"score":553615,"extra":""}]}]},{"had_liked":false,"id":337762,"user_name":"ä»è¿œæ–¹è¿‡æ¥","can_delete":false,"product_type":"c1","uid":1797551,"ip_address":"","ucode":"4791DBC7E05B1D","user_header":"","comment_is_top":false,"comment_ctime":1647021425,"is_pvip":false,"replies":[{"id":123549,"content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1647165776,"ip_address":"","comment_id":337762,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œæœ¬ç¤ºä¾‹ç›´æ¥å°†msgä»ä¸€ä¸ªsockè½¬å‘åˆ°å¦ä¸€ä¸ªsock, é‚£æ˜¯ä¸æ˜¯è¯´è·³è¿‡äº†å†…æ ¸å¤„ç†?","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556021,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647165776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335942,"user_name":"ç‰›é‡‘éœ–","can_delete":false,"product_type":"c1","uid":1149616,"ip_address":"","ucode":"DBBE2E0EEE9FB2","user_header":"https://static001.geekbang.org/account/avatar/00/11/8a/b0/6ab66f1b.jpg","comment_is_top":false,"comment_ctime":1645780067,"is_pvip":false,"replies":[{"id":122794,"content":"æˆ‘ä»¬è¯¾ç¨‹ç¬¬5è®²å’Œç¬¬6è®²å·²ç»ä»‹ç»äº†å¾ˆå¤šç¨‹åºç±»å‹å’Œå„ç§MAPä½¿ç”¨æ–¹æ³•","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1645878209,"ip_address":"","comment_id":335942,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨å“ªå„¿èƒ½çœ‹åˆ°å„ç§å„ç±»å‹çš„BPFç¨‹åºçš„ä½œç”¨å’Œç”Ÿæ•ˆæ¡ä»¶ã€‚\n\nè¿˜æœ‰å°±æ˜¯å„ç§MAPçš„é€‚ç”¨åœºæ™¯å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553402,"discussion_content":"æˆ‘ä»¬è¯¾ç¨‹ç¬¬5è®²å’Œç¬¬6è®²å·²ç»ä»‹ç»äº†å¾ˆå¤šç¨‹åºç±»å‹å’Œå„ç§MAPä½¿ç”¨æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645878209,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372435,"user_name":"Bachue Zhou","can_delete":false,"product_type":"c1","uid":1494491,"ip_address":"ä¸Šæµ·","ucode":"3175754775CA32","user_header":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","comment_is_top":false,"comment_ctime":1681132456,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æœ‰ä¸¤ä¸ªé—®é¢˜è¯·æ•™ä¸‹è€å¸ˆï¼š\n1. ä¸ºä»€ä¹ˆ skops-&gt;local_port è¿™ä¸ªå­—æ®µå°±è¦è½¬æˆç½‘ç»œåºï¼Œskops-&gt;remote_port å°±ä¸éœ€è¦ï¼Ÿ\n2. æˆ‘å‘ç°åœ¨å¯ç”¨äº†è¿™ä¸¤ä¸ª BPF ç¨‹åºåï¼Œå¦‚æœ nginx å®¹å™¨è¢«å…³é—­ï¼Œwrk ä¾ç„¶æ— æ³•æ­£å¸¸å·¥ä½œï¼Œé‚£ nginx å®¹å™¨åœ¨ BPF ç¨‹åºå†…æ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2312635,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKibRgfH78amFE0jViamLicHhZJXbgAw8O0ZR4kyF2QTRY56gmAOtKjnw9iahdRrL9DF6x3rxWdibjiaUqA/132","nickname":"Geek_8aa82a","note":"","ucode":"A9CE475BE942AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633257,"discussion_content":"å†…æ ¸æºç ä¸­å®šä¹‰äº†ï¼Œå­˜å‚¨local_portå’Œremote_portçš„å­—èŠ‚åºæ˜¯ä¸ä¸€æ ·çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701937660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1287556,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKnrjcKrRp5atleQiaD4yYw1sjguFOCCwldjE4T2cicicQaT9ELfKFhmUibT0m9gUicyHIDP9ZBdBwZk5w/132","nickname":"crezov","note":"","ucode":"F580279E92CA1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624251,"discussion_content":"1ã€å¯ä»¥çœ‹ä¸€ä¸‹å†…æ ¸æºç ä¸­çš„å®šä¹‰ï¼šhttps://elixir.bootlin.com/linux/v5.15/source/include/uapi/linux/bpf.h#L5691ï¼›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1690363369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390730,"user_name":"ææ¸…æ³‰ğŸ»","can_delete":false,"product_type":"c1","uid":2840236,"ip_address":"å¹¿ä¸œ","ucode":"376F9F294307E2","user_header":"https://static001.geekbang.org/account/avatar/00/2b/56/ac/a047a944.jpg","comment_is_top":false,"comment_ctime":1716114315,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿˜æ˜¯æ²¡çœ‹æ‡‚ï¼Œæ€ä¹ˆé‡å®šå‘çš„æ—¶å€™ç”¨çš„æ˜¯msg-&gt;local_portä½œä¸ºè¦é‡å®šå‘çš„socketçš„ç›®æ ‡å‘¢ï¼Ÿæˆ‘ä»¬åº”è¯¥ä¸çŸ¥é“å¯¹æ–¹è¦å‘åˆ°å“ªä¸ªIP portå§ï¼Ÿ","like_count":0},{"had_liked":false,"id":388701,"user_name":"ææ¸…æ³‰ğŸ»","can_delete":false,"product_type":"c1","uid":2840236,"ip_address":"å¹¿ä¸œ","ucode":"376F9F294307E2","user_header":"https://static001.geekbang.org/account/avatar/00/2b/56/ac/a047a944.jpg","comment_is_top":false,"comment_ctime":1710740548,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œèƒ½å‡ºè§†é¢‘ä¹ˆï¼Œæˆ‘åŸºç¡€ä¸å¥½ï¼Œçœ‹å¾—ä¸å¤ªæ‡‚","like_count":0},{"had_liked":false,"id":381339,"user_name":"ï½ï½","can_delete":false,"product_type":"c1","uid":1463768,"ip_address":"ä¸Šæµ·","ucode":"52797D415A538D","user_header":"https://static001.geekbang.org/account/avatar/00/16/55/d8/610fae56.jpg","comment_is_top":false,"comment_ctime":1695056526,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è¯·é—®è¿™é‡ŒæŒ‚è½½åˆ°&#47;sys&#47;fs&#47;cgroupæ˜¯ä¸æ˜¯åªå¯¹å®¹å™¨è¿›ç¨‹ç”Ÿæ•ˆ, å¦‚æœæˆ‘ç”¨shellæ‰“å¼€ä¸€ä¸ªè¿›ç¨‹, æ˜¯ä¸æ˜¯ä¸èƒ½ç”Ÿæ•ˆ. æˆ‘å‘ç°opsç¨‹åºåªèƒ½è§‚æµ‹åˆ°å®¹å™¨çš„ç½‘ç»œæ“ä½œ","like_count":0},{"had_liked":false,"id":376548,"user_name":"fqh","can_delete":false,"product_type":"c1","uid":1191805,"ip_address":"å¹¿ä¸œ","ucode":"3C3B9AAEB20254","user_header":"https://static001.geekbang.org/account/avatar/00/12/2f/7d/a2f23b0d.jpg","comment_is_top":false,"comment_ctime":1686909886,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"æ‰€ä»¥è¿™ä¸ªcaseé‡Œé¢æ˜¯ æŠŠ socket bpf æŒ‚è½½åˆ°äº† å®¿ä¸»å±‚é¢çš„ å¥—æ¥å­—å±‚é¢ï¼Ÿ \n\nä¸ºä»€ä¹ˆä¸åƒåé¢xdp case é‚£æ ·ï¼Œæ˜¯æŠŠ socket bpf æ”¾åˆ°ç‹¬ç«‹çš„ä¸€ä¸ªå®¹å™¨å†…éƒ¨ï¼Ÿ","like_count":0},{"had_liked":false,"id":342578,"user_name":"Geek_6aca30","can_delete":false,"product_type":"c1","uid":2977151,"ip_address":"","ucode":"1126A955813247","user_header":"","comment_is_top":false,"comment_ctime":1650352227,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"ä¸ºä»€ä¹ˆè¿™é‡Œçš„æ“ä½œæ²¡åƒä¸‹ç¯‡ä¸€æ ·å½±å“åˆ°ç³»ç»Ÿå…¶å®ƒç½‘ç»œè¿æ¥å‘¢ï¼Ÿçœ‹ä»£ç æ˜¯å¯¹æ‰€æœ‰æ–°å»ºçš„è¿æ¥éƒ½è¿›è¡Œäº†è½¬å‘ã€‚","like_count":0}]}