{"id":423131,"title":"09 | RDDå¸¸ç”¨ç®—å­ï¼ˆä¸‰ï¼‰ï¼šæ•°æ®çš„å‡†å¤‡ã€é‡åˆ†å¸ƒä¸æŒä¹…åŒ–","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>åœ¨RDDå¸¸ç”¨ç®—å­çš„å‰ä¸¤è®²ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«ä»‹ç»äº†ç”¨äºRDDå†…éƒ¨è½¬æ¢ä¸èšåˆçš„è¯¸å¤šç®—å­ï¼Œä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ç»§ç»­æ¥ä»‹ç»è¡¨æ ¼ä¸­å‰©ä½™éƒ¨åˆ†çš„ç®—å­ã€‚</p><p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œè¡¨æ ¼ä¸­çš„ç®—å­æˆ‘ä»¬ä¸ä¼šå…¨éƒ½ä»‹ç»ï¼Œè€Œæ˜¯åªæŒ‘é€‰å…¶ä¸­æœ€å¸¸ç”¨ã€æœ€å…·ä»£è¡¨æ€§çš„è¿›è¡Œè®²è§£ã€‚ä»Šå¤©è¦è®²çš„ç®—å­ï¼Œæˆ‘ç”¨åŠ ç²—å­—ä½“è¿›è¡Œäº†é«˜äº®æ˜¾ç¤ºï¼Œä½ ä¸å¦¨å…ˆæ‰«ä¸€çœ¼ï¼Œåšåˆ°å¿ƒä¸­æœ‰æ•°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4e/d3/4ebaf6b9762b2d7ba64d21d8664080d3.jpg?wh=1920x1506\" alt=\"å›¾ç‰‡\" title=\"RDDç®—å­åˆ†ç±»è¡¨\"></p><p>ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œè¿™äº›é«˜äº®æ˜¾ç¤ºçš„ç®—å­ä¹ä¸€çœ‹ä¹Ÿæ²¡ä»€ä¹ˆå…³è”å•Šï¼Ÿä½†å¦‚æœæˆ‘ä»¬ä»æ•°æ®ç”Ÿå‘½å‘¨æœŸçš„è§’åº¦å…¥æ‰‹ï¼Œç»™å®ƒä»¬å½’å½’ç±»ï¼Œå¾ˆå®¹æ˜“å°±ä¼šå‘ç°è¿™äº›ç®—å­åˆ†åˆ«éš¶å±äºç”Ÿå‘½å‘¨æœŸçš„æŸä¸ªé˜¶æ®µã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8f/cb/8fc62a1795606466f1fe391d098731cb.jpg?wh=1920x737\" alt=\"å›¾ç‰‡\" title=\"æ•°æ®ç”Ÿå‘½å‘¨æœŸ\"></p><p>ç»“åˆä¸Šå›¾ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹çœ‹æ¯ä¸ªç®—å­æ‰€åœ¨çš„ç”Ÿå‘½å‘¨æœŸå’Œå®ƒä»¬å®ç°çš„åŠŸèƒ½ã€‚</p><p>é¦–å…ˆï¼Œåœ¨æ•°æ®å‡†å¤‡é˜¶æ®µï¼Œunionä¸sampleç”¨äºå¯¹ä¸åŒæ¥æºçš„æ•°æ®è¿›è¡Œåˆå¹¶ä¸æ‹†åˆ†ã€‚</p><p>æˆ‘ä»¬ä»å·¦å¾€å³æ¥ç€çœ‹ï¼Œæ¥ä¸‹æ¥æ˜¯æ•°æ®é¢„å¤„ç†ç¯èŠ‚ã€‚è¾ƒä¸ºå‡è¡¡çš„æ•°æ®åˆ†å¸ƒï¼Œå¯¹åé¢æ•°æ®å¤„ç†é˜¶æ®µæå‡CPUåˆ©ç”¨ç‡æ›´æœ‰å¸®åŠ©ï¼Œå¯ä»¥æ•´ä½“æå‡æ‰§è¡Œæ•ˆç‡ã€‚é‚£è¿™ç§å‡è¡¡è¦æ€ä¹ˆå®ç°å‘¢ï¼Ÿæ²¡é”™ï¼Œè¿™æ—¶å°±è¦coalesceä¸repartitionç™»åœºäº†ï¼Œå®ƒä»¬çš„ä½œç”¨å°±æ˜¯é‡æ–°è°ƒæ•´RDDæ•°æ®åˆ†å¸ƒã€‚</p><p>åœ¨æ•°æ®å¤„ç†å®Œæ¯•ã€è®¡ç®—å®Œæˆä¹‹åï¼Œæˆ‘ä»¬è‡ªç„¶è¦å¯¹è®¡ç®—ç»“æœè¿›è¡Œæ”¶é›†ã€‚Sparkæä¾›äº†ä¸¤ç±»ç»“æœæ”¶é›†ç®—å­ï¼Œä¸€ç±»æ˜¯åƒtakeã€firstã€collectè¿™æ ·ï¼ŒæŠŠç»“æœç›´æ¥æ”¶é›†åˆ°Driverç«¯ï¼›å¦ä¸€ç±»åˆ™æ˜¯ç›´æ¥å°†è®¡ç®—ç»“æœæŒä¹…åŒ–åˆ°ï¼ˆåˆ†å¸ƒå¼ï¼‰æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚å’±ä»¬è¿™ä¸€è®²ä¼šæåˆ°çš„saveAsTextFileã€‚</p><!-- [[[read_end]]] --><p>å¥½å•¦ï¼Œæ¸…æ¥šäº†æˆ‘ä»¬ä»Šå¤©è¦è®²å“ªäº›ç®—å­ï¼Œä»¥åŠå®ƒä»¬å¤§è‡´çš„å®šä½ä¸åŠŸç”¨ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ­£å¼æ¥è®²è®²è¿™äº›ç®—å­çš„å…·ä½“ç”¨æ³•ã€‚</p><h2>æ•°æ®å‡†å¤‡</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥è¯´è¯´æ•°æ®å‡†å¤‡é˜¶æ®µçš„unionå’Œsampleã€‚</p><h3>union</h3><p>åœ¨æˆ‘ä»¬æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œunionéå¸¸å¸¸è§ï¼Œå®ƒå¸¸å¸¸ç”¨äºæŠŠä¸¤ä¸ªç±»å‹ä¸€è‡´ã€ä½†æ¥æºä¸åŒçš„RDDè¿›è¡Œåˆå¹¶ï¼Œä»è€Œæ„æˆä¸€ä¸ªç»Ÿä¸€çš„ã€æ›´å¤§çš„åˆ†å¸ƒå¼æ•°æ®é›†ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸä¸ªæ•°æ®åˆ†æåœºæ™¯ä¸­ï¼Œä¸€ä»½æ•°æ®æºæ¥è‡ªè¿œç«¯æ•°æ®åº“ï¼Œè€Œå¦ä¸€ä»½æ•°æ®æºæ¥è‡ªæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œè¦å°†ä¸¤ä»½æ•°æ®è¿›è¡Œåˆå¹¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°unionè¿™ä¸ªæ“ä½œã€‚</p><p>å…·ä½“æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿæˆ‘æ¥ä¸¾ä¸ªä¾‹å­ã€‚ç»™å®šä¸¤ä¸ªRDDï¼šrdd1å’Œrdd2ï¼Œè°ƒç”¨rdd1.union(rdd2)æˆ–æ˜¯rdd1 union rdd2ï¼Œå…¶ç»“æœéƒ½æ˜¯ä¸¤ä¸ªRDDçš„å¹¶é›†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-scala\">// Tï¼šæ•°æ®ç±»å‹\nval rdd1: RDD[T] = _\nval rdd2: RDD[T] = _\nval rdd = rdd1.union(rdd2)\n// æˆ–è€…rdd1 union rdd2\n</code></pre><p>éœ€è¦ç‰¹åˆ«å¼ºè°ƒçš„æ˜¯ï¼Œunionæ“ä½œèƒ½å¤Ÿæˆç«‹çš„å‰æï¼Œå°±æ˜¯<strong>å‚ä¸åˆå¹¶çš„ä¸¤ä¸ªRDDçš„ç±»å‹å¿…é¡»å®Œå…¨ä¸€è‡´</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒRDD[String]åªèƒ½ä¸RDD[String]åˆå¹¶åˆ°ä¸€èµ·ï¼Œå´æ— æ³•ä¸é™¤RDD[String]ä»¥å¤–çš„ä»»ä½•RDDç±»å‹ï¼ˆå¦‚RDD[Int]ã€ç”šè‡³æ˜¯RDD[UserDefinedClass]ï¼‰åšåˆå¹¶ã€‚</p><p>å¯¹äºå¤šä¸ªç±»å‹ä¸€è‡´çš„RDDï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿ç»­è°ƒç”¨unionæŠŠæ‰€æœ‰æ•°æ®é›†åˆå¹¶åœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ï¼Œç»™å®šç±»å‹ä¸€è‡´çš„3ä¸ªRDDï¼šrdd1ã€rdd2å’Œrdd3ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æŠŠå®ƒä»¬åˆå¹¶åœ¨ä¸€èµ·ã€‚</p><pre><code class=\"language-scala\">// Tï¼šæ•°æ®ç±»å‹\nval rdd1: RDD[T] = _\nval rdd2: RDD[T] = _\nval rdd3: RDD[T] = _\n&nbsp;\nval rdd = (rdd1.union(rdd2)).union(rdd3)\n// æˆ–è€… val rdd = rdd1 union rdd2 union rdd3\n</code></pre><p>ä¸éš¾å‘ç°ï¼Œunionçš„å…¸å‹ä½¿ç”¨åœºæ™¯ï¼Œæ˜¯æŠŠå¤šä»½â€œå°æ•°æ®â€ï¼Œåˆå¹¶ä¸ºä¸€ä»½â€œå¤§æ•°æ®â€ï¼Œä»è€Œå……åˆ†åˆ©ç”¨Sparkåˆ†å¸ƒå¼å¼•æ“çš„å¹¶è¡Œè®¡ç®—ä¼˜åŠ¿ã€‚</p><p>ä¸ä¹‹ç›¸åï¼Œåœ¨ä¸€èˆ¬çš„æ•°æ®æ¢ç´¢åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€åªéœ€è¦å¯¹ä¸€ä»½æ•°æ®çš„å­é›†æœ‰åŸºæœ¬çš„äº†è§£å³å¯ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä»½ä½“é‡åœ¨TBçº§åˆ«çš„æ•°æ®é›†ï¼Œæˆ‘ä»¬åªæƒ³éšæœºæå–å…¶éƒ¨åˆ†æ•°æ®ï¼Œç„¶åè®¡ç®—è¿™éƒ¨åˆ†å­é›†çš„ç»Ÿè®¡å€¼ï¼ˆå‡å€¼ã€æ–¹å·®ç­‰ï¼‰ã€‚</p><p>é‚£ä¹ˆï¼Œé¢å¯¹è¿™ç±»æŠŠâ€œå¤§æ•°æ®â€å˜æˆ â€œå°æ•°æ®â€çš„è®¡ç®—éœ€æ±‚ï¼ŒSparkåˆå¦‚ä½•è¿›è¡Œæ”¯æŒå‘¢ï¼Ÿè¿™å°±è¦è¯´åˆ°RDDçš„sampleç®—å­äº†ã€‚</p><h3>sample</h3><p>RDDçš„sampleç®—å­ç”¨äºå¯¹RDDåšéšæœºé‡‡æ ·ï¼Œä»è€ŒæŠŠä¸€ä¸ªè¾ƒå¤§çš„æ•°æ®é›†å˜ä¸ºä¸€ä»½â€œå°æ•°æ®â€ã€‚ç›¸è¾ƒå…¶ä»–ç®—å­ï¼Œsampleçš„å‚æ•°æ¯”è¾ƒå¤šï¼Œåˆ†åˆ«æ˜¯withReplacementã€fractionå’Œseedã€‚å› æ­¤ï¼Œè¦åœ¨RDDä¹‹ä¸Šå®Œæˆæ•°æ®é‡‡æ ·ï¼Œä½ éœ€è¦ä½¿ç”¨å¦‚ä¸‹çš„æ–¹å¼æ¥è°ƒç”¨sampleç®—å­ï¼šsample(withReplacement, fraction, seed)ã€‚</p><p>å…¶ä¸­ï¼ŒwithReplacementçš„ç±»å‹æ˜¯Booleanï¼Œå®ƒçš„å«ä¹‰æ˜¯â€œé‡‡æ ·æ˜¯å¦æœ‰æ”¾å›â€ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°çš„å€¼æ˜¯trueï¼Œé‚£ä¹ˆé‡‡æ ·ç»“æœä¸­å¯èƒ½ä¼šåŒ…å«é‡å¤çš„æ•°æ®è®°å½•ï¼Œç›¸åï¼Œå¦‚æœè¯¥å€¼ä¸ºfalseï¼Œé‚£ä¹ˆé‡‡æ ·ç»“æœä¸å­˜åœ¨é‡å¤è®°å½•ã€‚</p><p>fractionå‚æ•°æœ€å¥½ç†è§£ï¼Œå®ƒçš„ç±»å‹æ˜¯Doubleï¼Œå€¼åŸŸä¸º0åˆ°1ï¼Œå…¶å«ä¹‰æ˜¯é‡‡æ ·æ¯”ä¾‹ï¼Œä¹Ÿå°±æ˜¯ç»“æœé›†ä¸åŸæ•°æ®é›†çš„å°ºå¯¸æ¯”ä¾‹ã€‚seedå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå®ƒçš„ç±»å‹æ˜¯Longï¼Œä¹Ÿå°±æ˜¯é•¿æ•´å‹ï¼Œç”¨äºæ§åˆ¶æ¯æ¬¡é‡‡æ ·çš„ç»“æœæ˜¯å¦ä¸€è‡´ã€‚å…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç»“åˆä¸€äº›ç¤ºä¾‹ï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½åœ°ç†è§£sampleç®—å­çš„ç”¨æ³•ã€‚</p><pre><code class=\"language-scala\">// ç”Ÿæˆ0åˆ°99çš„æ•´å‹æ•°ç»„\nval arr = (0 until 100).toArray\n// ä½¿ç”¨parallelizeç”ŸæˆRDD\nval rdd = sc.parallelize(arr)\n&nbsp;\n// ä¸å¸¦seedï¼Œæ¯æ¬¡é‡‡æ ·ç»“æœéƒ½ä¸åŒ\nrdd.sample(false, 0.1).collect\n// ç»“æœé›†ï¼šArray(11, 13, 14, 39, 43, 63, 73, 78, 83, 88, 89, 90)\nrdd.sample(false, 0.1).collect\n// ç»“æœé›†ï¼šArray(6, 9, 10, 11, 17, 36, 44, 53, 73, 74, 79, 97, 99)\n&nbsp;\n// å¸¦seedï¼Œæ¯æ¬¡é‡‡æ ·ç»“æœéƒ½ä¸€æ ·\nrdd.sample(false, 0.1, 123).collect\n// ç»“æœé›†ï¼šArray(3, 11, 26, 59, 82, 89, 96, 99)\nrdd.sample(false, 0.1, 123).collect\n// ç»“æœé›†ï¼šArray(3, 11, 26, 59, 82, 89, 96, 99)\n&nbsp;\n// æœ‰æ”¾å›é‡‡æ ·ï¼Œé‡‡æ ·ç»“æœå¯èƒ½åŒ…å«é‡å¤å€¼\nrdd.sample(true, 0.1, 456).collect\n// ç»“æœé›†ï¼šArray(7, 11, 11, 23, 26, 26, 33, 41, 57, 74, 96)\nrdd.sample(true, 0.1, 456).collect\n// ç»“æœé›†ï¼šArray(7, 11, 11, 23, 26, 26, 33, 41, 57, 74, 96)\n</code></pre><p>æˆ‘ä»¬çš„å®éªŒåˆ†ä¸º3ç»„ï¼Œå‰ä¸¤ç»„ç”¨æ¥å¯¹æ¯”æ·»åŠ seedå‚æ•°ä¸å¦çš„å·®å¼‚ï¼Œæœ€åä¸€ç»„ç”¨äºè¯´æ˜withReplacementå‚æ•°çš„ä½œç”¨ã€‚</p><p>ä¸éš¾å‘ç°ï¼Œåœ¨ä¸å¸¦seedå‚æ•°çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è°ƒç”¨sampleä¹‹åçš„è¿”å›ç»“æœéƒ½ä¸ä¸€æ ·ã€‚è€Œå½“æˆ‘ä»¬ä½¿ç”¨åŒæ ·çš„seedè°ƒç”¨ç®—å­æ—¶ï¼Œä¸è®ºæˆ‘ä»¬è°ƒç”¨sampleå¤šå°‘æ¬¡ï¼Œæ¯æ¬¡çš„è¿”å›ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ã€‚å¦å¤–ï¼Œä»”ç»†è§‚å¯Ÿç¬¬3ç»„å®éªŒï¼Œä½ ä¼šå‘ç°ç»“æœé›†ä¸­æœ‰é‡å¤çš„æ•°æ®è®°å½•ï¼Œè¿™æ˜¯å› ä¸ºwithReplacementè¢«ç½®ä¸ºtrueï¼Œé‡‡æ ·çš„è¿‡ç¨‹æ˜¯â€œæœ‰æ”¾å›çš„â€ã€‚</p><p>å¥½å•¦ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ•°æ®å‡†å¤‡é˜¶æ®µå¸¸ç”¨çš„ä¸¤ä¸ªç®—å­æˆ‘ä»¬å°±è®²å®Œäº†ã€‚æœ‰äº†unionå’Œsampleï¼Œä½ å°±å¯ä»¥éšæ„åœ°è°ƒæ•´åˆ†å¸ƒå¼æ•°æ®é›†çš„å°ºå¯¸ï¼ŒçœŸæ­£åšåˆ°æ”¶æ”¾è‡ªå¦‚ã€‚</p><h2>æ•°æ®é¢„å¤„ç†</h2><p>æ¥ä¸‹æ¥ï¼Œåœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µï¼Œæˆ‘ä»¬å†æ¥è¯´è¯´è´Ÿè´£æ•°æ®é‡åˆ†å¸ƒçš„ä¸¤ä¸ªç®—å­ï¼šrepartitionå’Œcoalesceã€‚</p><p>åœ¨äº†è§£è¿™ä¸¤ä¸ªç®—å­ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆç†è§£å¹¶è¡Œåº¦è¿™ä¸ªæ¦‚å¿µã€‚æ‰€è°“å¹¶è¡Œåº¦ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯RDDçš„æ•°æ®åˆ†åŒºæ•°é‡ã€‚è¿˜è®°å¾—å—ï¼ŸRDDçš„partitionså±æ€§ï¼Œè®°å½•æ­£æ˜¯RDDçš„æ‰€æœ‰æ•°æ®åˆ†åŒºã€‚å› æ­¤ï¼ŒRDDçš„å¹¶è¡Œåº¦ä¸å…¶partitionså±æ€§ç›¸ä¸€è‡´ã€‚</p><p>å¼€å‘è€…å¯ä»¥ä½¿ç”¨repartitionç®—å­éšæ„è°ƒæ•´ï¼ˆæå‡æˆ–é™ä½ï¼‰RDDçš„å¹¶è¡Œåº¦ï¼Œè€Œcoalesceç®—å­åˆ™åªèƒ½ç”¨äºé™ä½RDDå¹¶è¡Œåº¦ã€‚æ˜¾ç„¶ï¼Œåœ¨æ•°æ®åˆ†å¸ƒçš„è°ƒæ•´æ–¹é¢ï¼Œrepartitionçµæ´»åº¦æ›´é«˜ã€åº”ç”¨åœºæ™¯æ›´å¤šï¼Œæˆ‘ä»¬å…ˆå¯¹å®ƒè¿›è¡Œä»‹ç»ï¼Œä¹‹åå†å»çœ‹çœ‹coalesceæœ‰ä»€ä¹ˆç”¨æ­¦ä¹‹åœ°ã€‚</p><h3>repartition</h3><p>ä¸€æ—¦ç»™å®šäº†RDDï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è°ƒç”¨repartition(n)æ¥éšæ„è°ƒæ•´RDDå¹¶è¡Œåº¦ã€‚å…¶ä¸­å‚æ•°nçš„ç±»å‹æ˜¯Intï¼Œä¹Ÿå°±æ˜¯æ•´å‹ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»»æ„æ•´æ•°ä¼ é€’ç»™repartitionã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œå’±ä»¬è¿˜æ˜¯ç»“åˆç¤ºä¾‹ç†Ÿæ‚‰ä¸€ä¸‹repartitionçš„ç”¨æ³•ã€‚</p><pre><code class=\"language-scala\">// ç”Ÿæˆ0åˆ°99çš„æ•´å‹æ•°ç»„\nval arr = (0 until 100).toArray\n// ä½¿ç”¨parallelizeç”ŸæˆRDD\nval rdd = sc.parallelize(arr)\n&nbsp;\nrdd.partitions.length\n// 4\n&nbsp;\nval rdd1 = rdd.repartition(2)\nrdd1.partitions.length\n// 2\n&nbsp;\nval rdd2 = rdd.repartition(8)\nrdd2.partitions.length\n// 8\n</code></pre><p>é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡æ•°ç»„åˆ›å»ºç”¨äºå®éªŒçš„RDDï¼Œä»è¿™æ®µä»£ç é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¯¥RDDçš„é»˜è®¤å¹¶è¡Œåº¦æ˜¯4ã€‚åœ¨æˆ‘ä»¬åˆ†åˆ«ç”¨2å’Œ8æ¥è°ƒæ•´RDDçš„å¹¶è¡Œåº¦ä¹‹åï¼Œé€šè¿‡è®¡ç®—RDD partitionså±æ€§çš„é•¿åº¦ï¼Œæˆ‘ä»¬å‘ç°æ–°RDDçš„å¹¶è¡Œåº¦åˆ†åˆ«è¢«ç›¸åº”åœ°è°ƒæ•´ä¸º2å’Œ8ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½è¿˜æœ‰ç–‘é—®ï¼šâ€œæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è°ƒæ•´RDDçš„å¹¶è¡Œåº¦å‘¢ï¼Ÿ2å’Œ8çœ‹ä¸Šå»ä¹Ÿæ²¡ä»€ä¹ˆå®è´¨æ€§çš„åŒºåˆ«å‘€â€ã€‚</p><p>åœ¨RDDé‚£ä¸€è®²ï¼ˆ<a href=\"https://time.geekbang.org/column/article/417164\">ç¬¬2è®²</a>ï¼‰ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡ï¼Œæ¯ä¸ªRDDçš„æ•°æ®åˆ†åŒºï¼Œéƒ½å¯¹åº”ç€ä¸€ä¸ªåˆ†å¸ƒå¼Taskï¼Œè€Œæ¯ä¸ªTaskéƒ½éœ€è¦ä¸€ä¸ªCPUçº¿ç¨‹å»æ‰§è¡Œã€‚</p><p>å› æ­¤ï¼ŒRDDçš„å¹¶è¡Œåº¦ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­CPUçš„ä½¿ç”¨æ•ˆç‡ï¼Œè¿›è€Œè¿˜ä¼šå½±å“åˆ†å¸ƒå¼ç³»ç»Ÿå¹¶è¡Œè®¡ç®—çš„æ‰§è¡Œæ•ˆç‡ã€‚å¹¶è¡Œåº¦è¿‡é«˜æˆ–æ˜¯è¿‡ä½ï¼Œéƒ½ä¼šé™ä½CPUåˆ©ç”¨ç‡ï¼Œä»è€Œç™½ç™½æµªè´¹æ‰å®è´µçš„åˆ†å¸ƒå¼è®¡ç®—èµ„æºï¼Œå› æ­¤ï¼Œåˆç†æœ‰æ•ˆåœ°è®¾ç½®RDDå¹¶è¡Œåº¦ï¼Œè‡³å…³é‡è¦ã€‚</p><p>è¿™æ—¶ä½ å¯èƒ½ä¼šè¿½é—®ï¼šâ€œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£ä¹ˆæˆ‘è¯¥å¦‚ä½•åˆç†åœ°è®¾ç½®RDDçš„å¹¶è¡Œåº¦å‘¢ï¼Ÿâ€å¦ç™½åœ°è¯´ï¼Œè¿™ä¸ªé—®é¢˜å¹¶æ²¡æœ‰å›ºå®šçš„ç­”æ¡ˆï¼Œå®ƒå–å†³äºç³»ç»Ÿå¯ç”¨èµ„æºã€åˆ†å¸ƒå¼æ•°æ®é›†å¤§å°ï¼Œç”šè‡³è¿˜ä¸æ‰§è¡Œå†…å­˜æœ‰å…³ã€‚</p><p>ä¸è¿‡ï¼Œç»“åˆç»éªŒæ¥è¯´ï¼Œ<strong>æŠŠå¹¶è¡Œåº¦è®¾ç½®ä¸ºå¯ç”¨CPUçš„2åˆ°3å€ï¼Œå¾€å¾€æ˜¯ä¸ªä¸é”™çš„å¼€å§‹</strong>ã€‚ä¾‹å¦‚ï¼Œå¯åˆ†é…ç»™Sparkä½œä¸šçš„Executorsä¸ªæ•°ä¸ºNï¼Œæ¯ä¸ªExecutorsé…ç½®çš„CPUä¸ªæ•°ä¸ºCï¼Œé‚£ä¹ˆæ¨èè®¾ç½®çš„å¹¶è¡Œåº¦åè½åœ¨N<em>C</em>2åˆ°N<em>C</em>3è¿™ä¸ªèŒƒå›´ä¹‹é—´ã€‚</p><p>å°½ç®¡repartitionéå¸¸çµæ´»ï¼Œä½ å¯ä»¥ç”¨å®ƒéšæ„åœ°è°ƒæ•´RDDå¹¶è¡Œåº¦ï¼Œä½†æ˜¯ä½ ä¹Ÿéœ€è¦æ³¨æ„ï¼Œè¿™ä¸ªç®—å­æœ‰ä¸ªè‡´å‘½çš„å¼Šç«¯ï¼Œé‚£å°±æ˜¯å®ƒä¼šå¼•å…¥Shuffleã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼ˆ<a href=\"https://time.geekbang.org/column/article/420399\">ç¬¬6è®²</a>è¯¦ç»†è®²è¿‡ï¼‰ï¼Œç”±äºShuffleåœ¨è®¡ç®—çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶ˆè€—æ‰€æœ‰ç±»å‹çš„ç¡¬ä»¶èµ„æºï¼Œå°¤å…¶æ˜¯å…¶ä¸­çš„ç£ç›˜I/Oä¸ç½‘ç»œI/Oï¼Œå› æ­¤Shuffleå¾€å¾€æ˜¯ä½œä¸šæ‰§è¡Œæ•ˆç‡çš„ç“¶é¢ˆã€‚æ­£æ˜¯å‡ºäºè¿™ä¸ªåŸå› ï¼Œåœ¨åšåº”ç”¨å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”å½“æåŠ›é¿å…Shuffleçš„å¼•å…¥ã€‚</p><p>ä½†ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œå¦‚æœæ•°æ®é‡åˆ†å¸ƒæ˜¯åˆšéœ€ï¼Œè€Œrepartitionåˆå¿…å®šä¼šå¼•å…¥Shuffleï¼Œæˆ‘è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿâ€å¦‚æœä½ æƒ³å¢åŠ å¹¶è¡Œåº¦ï¼Œé‚£æˆ‘ä»¬è¿˜çœŸçš„åªèƒ½ä»°ä»—repartitionï¼ŒShuffleçš„é—®é¢˜è‡ªç„¶ä¹Ÿå°±æ— æ³•é¿å…ã€‚ä½†å‡è®¾ä½ çš„éœ€æ±‚æ˜¯é™ä½å¹¶è¡Œåº¦ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠç›®å…‰æŠ•å‘repartitionçš„å­ªç”Ÿå…„å¼Ÿï¼šcoalesceã€‚</p><h3>coalesce</h3><p>åœ¨ç”¨æ³•ä¸Šï¼Œcoalesceä¸repartitionä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯é€šè¿‡æŒ‡å®šä¸€ä¸ªIntç±»å‹çš„å½¢å‚ï¼Œå®Œæˆå¯¹RDDå¹¶è¡Œåº¦çš„è°ƒæ•´ï¼Œå³coalesce (n)ã€‚é‚£ä¸¤è€…çš„ç”¨æ³•åˆ°åº•æœ‰ä»€ä¹ˆå·®åˆ«å‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨ç»“åˆåˆšåˆšçš„ä»£ç ç¤ºä¾‹ï¼Œæ¥å¯¹æ¯”coalesceä¸repartitionã€‚</p><pre><code class=\"language-scala\">// ç”Ÿæˆ0åˆ°99çš„æ•´å‹æ•°ç»„\nval arr = (0 until 100).toArray\n// ä½¿ç”¨parallelizeç”ŸæˆRDD\nval rdd = sc.parallelize(arr)\n&nbsp;\nrdd.partitions.length\n// 4\n&nbsp;\nval rdd1 = rdd.repartition(2)\nrdd1.partitions.length\n// 2\n&nbsp;\nval rdd2 = rdd.coalesce(2)\nrdd2.partitions.length\n// 2\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç”¨æ³•ä¸Šï¼Œcoalesceä¸repartitionå¯ä»¥äº’æ¢ï¼ŒäºŒè€…çš„æ•ˆæœæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬å»è§‚å¯ŸäºŒè€…çš„DAGï¼Œä¼šå‘ç°åŒæ ·çš„è®¡ç®—é€»è¾‘ï¼Œå´æœ‰ç€è¿¥ç„¶ä¸åŒçš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/36/2d/36bc7990bcbc9e17b2af1193f9db022d.png?wh=1194x472\" alt=\"å›¾ç‰‡\" title=\"coalesceä¸repartitionæœ‰ç€ä¸åŒçš„æ‰§è¡Œè®¡åˆ’\"></p><p>åœ¨RDDä¹‹ä¸Šè°ƒç”¨toDebugStringï¼ŒSparkå¯ä»¥å¸®æˆ‘ä»¬æ‰“å°å‡ºå½“å‰RDDçš„DAGã€‚å°½ç®¡å›¾ä¸­çš„æ‰“å°æ–‡æœ¬çœ‹ä¸Šå»æœ‰äº›å‡Œä¹±ï¼Œä½†ä½ åªè¦æŠ“ä½å…¶ä¸­çš„ä¸€ä¸ªå…³é”®è¦ç‚¹å°±å¯ä»¥äº†ã€‚</p><p>è¿™ä¸ªå…³é”®è¦ç‚¹å°±æ˜¯ï¼Œåœ¨toDebugStringçš„è¾“å‡ºæ–‡æœ¬ä¸­ï¼Œæ¯ä¸€ä¸ªå¸¦æ•°å­—çš„å°æ‹¬å·ï¼Œæ¯”å¦‚rdd1å½“ä¸­çš„â€œ(2)â€å’Œâ€œ(4)â€ï¼Œéƒ½ä»£è¡¨ç€ä¸€ä¸ªæ‰§è¡Œé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯DAGä¸­çš„Stageã€‚è€Œä¸”ï¼Œä¸åŒçš„Stageä¹‹é—´ï¼Œä¼šé€šè¿‡åˆ¶è¡¨ç¬¦ï¼ˆTabï¼‰ç¼©è¿›è¿›è¡ŒåŒºåˆ†ï¼Œæ¯”å¦‚å›¾ä¸­çš„â€œ(4)â€æ˜¾ç„¶è¦æ¯”â€œ(2)â€ç¼©è¿›äº†ä¸€æ®µè·ç¦»ã€‚</p><p>å¯¹äºtoDebugStringçš„è§£è¯»ï¼Œä½ åªéœ€è¦æŒæ¡åˆ°è¿™é‡Œå°±è¶³å¤Ÿäº†ã€‚å­¦ä¹ è¿‡è°ƒåº¦ç³»ç»Ÿä¹‹åï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œåœ¨åŒä¸€ä¸ªDAGå†…ï¼Œä¸åŒStagesä¹‹é—´çš„è¾¹ç•Œæ˜¯Shuffleã€‚å› æ­¤ï¼Œè§‚å¯Ÿä¸Šé¢çš„æ‰“å°æ–‡æœ¬ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ¸…æ¥šåœ°çœ‹åˆ°ï¼Œrepartitionä¼šå¼•å…¥Shuffleï¼Œè€Œcoalesceä¸ä¼šã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒåŒæ ·æ˜¯é‡åˆ†å¸ƒçš„æ“ä½œï¼Œä¸ºä»€ä¹ˆrepartitionä¼šå¼•å…¥Shuffleï¼Œè€Œcoalesceä¸ä¼šå‘¢ï¼ŸåŸå› åœ¨äºï¼ŒäºŒè€…çš„å·¥ä½œåŸç†æœ‰ç€æœ¬è´¨çš„ä¸åŒã€‚</p><p>ç»™å®šRDDï¼Œå¦‚æœç”¨repartitionæ¥è°ƒæ•´å…¶å¹¶è¡Œåº¦ï¼Œä¸è®ºå¢åŠ è¿˜æ˜¯é™ä½ï¼Œå¯¹äºRDDä¸­çš„æ¯ä¸€æ¡æ•°æ®è®°å½•ï¼Œrepartitionå¯¹å®ƒä»¬çš„å½±å“éƒ½æ˜¯æ— å·®åˆ«çš„æ•°æ®åˆ†å‘ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œç»™å®šä»»æ„ä¸€æ¡æ•°æ®è®°å½•ï¼Œrepartitionçš„è®¡ç®—è¿‡ç¨‹éƒ½æ˜¯å…ˆå“ˆå¸Œã€å†å–æ¨¡ï¼Œå¾—åˆ°çš„ç»“æœä¾¿æ˜¯è¯¥æ¡æ•°æ®çš„ç›®æ ‡åˆ†åŒºç´¢å¼•ã€‚å¯¹äºç»å¤§å¤šæ•°çš„æ•°æ®è®°å½•ï¼Œç›®æ ‡åˆ†åŒºå¾€å¾€åè½åœ¨å¦ä¸€ä¸ªExecutorã€ç”šè‡³æ˜¯å¦ä¸€ä¸ªèŠ‚ç‚¹ä¹‹ä¸Šï¼Œå› æ­¤Shuffleè‡ªç„¶ä¹Ÿå°±ä¸å¯é¿å…ã€‚</p><p>coalesceåˆ™ä¸ç„¶ï¼Œåœ¨é™ä½å¹¶è¡Œåº¦çš„è®¡ç®—ä¸­ï¼Œå®ƒé‡‡å–çš„æ€è·¯æ˜¯æŠŠåŒä¸€ä¸ªExecutorå†…çš„ä¸åŒæ•°æ®åˆ†åŒºè¿›è¡Œåˆå¹¶ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œæ•°æ®å¹¶ä¸éœ€è¦è·¨Executorsã€è·¨èŠ‚ç‚¹è¿›è¡Œåˆ†å‘ï¼Œå› è€Œè‡ªç„¶ä¸ä¼šå¼•å…¥Shuffleã€‚</p><p>è¿™é‡Œæˆ‘è¿˜ç‰¹æ„å‡†å¤‡äº†ä¸€å¼ ç¤ºæ„å›¾ï¼Œæ›´ç›´è§‚åœ°ä¸ºä½ å±•ç¤ºrepartitionä¸coalesceçš„è®¡ç®—è¿‡ç¨‹ï¼Œå›¾ç‰‡æ–‡å­—åŒç®¡é½ä¸‹ï¼Œç›¸ä¿¡ä½ ä¸€å®šèƒ½å¤Ÿæ›´åŠ æ·±å…¥åœ°ç†è§£repartitionä¸coalesceä¹‹é—´çš„åŒºåˆ«ä¸è”ç³»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e7/90/e776b77d36725728f44905d4dfe7f390.jpg?wh=1920x602\" alt=\"å›¾ç‰‡\" title=\"repartitionä¸coalesceè®¡ç®—åŸç†ç¤ºæ„å›¾\"></p><p>å¥½å•¦ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œåœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µï¼Œç”¨äºå¯¹RDDåšé‡åˆ†å¸ƒçš„ä¸¤ä¸ªç®—å­æˆ‘ä»¬å°±è®²å®Œäº†ã€‚æŒæ¡äº†repartitionå’Œcoalesceè¿™ä¸¤ä¸ªç®—å­ï¼Œç»“åˆæ•°æ®é›†å¤§å°ä¸é›†ç¾¤å¯ç”¨èµ„æºï¼Œä½ å°±å¯ä»¥éšæ„åœ°å¯¹RDDçš„å¹¶è¡Œåº¦è¿›è¡Œè°ƒæ•´ï¼Œè¿›è€Œæå‡CPUåˆ©ç”¨ç‡ä¸ä½œä¸šçš„æ‰§è¡Œæ€§èƒ½ã€‚</p><h2>ç»“æœæ”¶é›†</h2><p>é¢„å¤„ç†å®Œæˆä¹‹åï¼Œæ•°æ®ç”Ÿå‘½å‘¨æœŸçš„ä¸‹ä¸€ä¸ªé˜¶æ®µæ˜¯æ•°æ®å¤„ç†ï¼Œåœ¨è¿™ä¸ªç¯èŠ‚ï¼Œä½ å¯ä»¥ä½¿ç”¨RDDå¸¸ç”¨ç®—å­ï¼ˆäºŒï¼‰<a href=\"https://time.geekbang.org/column/article/421566\">é‚£ä¸€è®²</a>ä»‹ç»çš„å„ç±»ç®—å­ï¼Œå»å¯¹æ•°æ®è¿›è¡Œå„å¼å„æ ·çš„å¤„ç†ï¼Œæ¯”å¦‚æ•°æ®è½¬æ¢ã€æ•°æ®è¿‡æ»¤ã€æ•°æ®èšåˆï¼Œç­‰ç­‰ã€‚å®Œæˆå¤„ç†ä¹‹åï¼Œæˆ‘ä»¬è‡ªç„¶è¦æ”¶é›†è®¡ç®—ç»“æœã€‚</p><p>åœ¨ç»“æœæ”¶é›†æ–¹é¢ï¼ŒSparkä¹Ÿä¸ºæˆ‘ä»¬å‡†å¤‡äº†ä¸°å¯Œçš„ç®—å­ã€‚æŒ‰ç…§æ”¶é›†è·¯å¾„åŒºåˆ†ï¼Œè¿™äº›ç®—å­ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šç¬¬ä¸€ç±»æ˜¯æŠŠè®¡ç®—ç»“æœä»å„ä¸ªExecutorsæ”¶é›†åˆ°Driverç«¯ï¼Œç¬¬äºŒä¸ªç±»æ˜¯æŠŠè®¡ç®—ç»“æœé€šè¿‡Executorsç›´æ¥æŒä¹…åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨å¤§æ•°æ®å¤„ç†é¢†åŸŸï¼Œæ–‡ä»¶ç³»ç»Ÿå¾€å¾€æŒ‡çš„æ˜¯åƒHDFSæˆ–æ˜¯S3è¿™æ ·çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚</p><h3>firstã€takeå’Œcollect</h3><p>æˆ‘ä»¬ä»Šå¤©è¦ä»‹ç»çš„ç¬¬ä¸€ç±»ç®—å­æœ‰firstã€takeå’Œcollectï¼Œå®ƒä»¬çš„ç”¨æ³•éå¸¸ç®€å•ï¼ŒæŒ‰ç…§è€è§„çŸ©ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ä»£ç ç¤ºä¾‹è¿›è¡Œè®²è§£ã€‚è¿™é‡Œæˆ‘ä»¬ç»“åˆç¬¬1è®²çš„Word Countï¼Œåˆ†åˆ«ä½¿ç”¨firstã€takeå’Œcollectè¿™ä¸‰ä¸ªç®—å­å¯¹ä¸åŒé˜¶æ®µçš„RDDè¿›è¡Œæ•°æ®æ¢ç´¢ã€‚</p><pre><code class=\"language-scala\">import org.apache.spark.rdd.RDD\nval rootPath: String = _\nval file: String = s\"${rootPath}/wikiOfSpark.txt\"\n// è¯»å–æ–‡ä»¶å†…å®¹\nval lineRDD: RDD[String] = spark.sparkContext.textFile(file)\n&nbsp;\nlineRDD.first\n// res1: String = Apache Spark\n&nbsp;\n// ä»¥è¡Œä¸ºå•ä½åšåˆ†è¯\nval wordRDD: RDD[String] = lineRDD.flatMap(line =&gt; line.split(\" \"))\nval cleanWordRDD: RDD[String] = wordRDD.filter(word =&gt; !word.equals(\"\"))\n&nbsp;\ncleanWordRDD.take(3)\n// res2: Array[String] = Array(Apache, Spark, From)\n// æŠŠRDDå…ƒç´ è½¬æ¢ä¸ºï¼ˆKeyï¼ŒValueï¼‰çš„å½¢å¼\nval kvRDD: RDD[(String, Int)] = cleanWordRDD.map(word =&gt; (word, 1))\n// æŒ‰ç…§å•è¯åšåˆ†ç»„è®¡æ•°\nval wordCounts: RDD[(String, Int)] = kvRDD.reduceByKey((x, y) =&gt; x + y)\n&nbsp;\nwordCounts.collect\n// res3: Array[(String, Int)] = Array((Because,1), (Open,1), (impl...\n</code></pre><p>å…¶ä¸­ï¼Œfirstç”¨äºæ”¶é›†RDDæ•°æ®é›†ä¸­çš„ä»»æ„ä¸€æ¡æ•°æ®è®°å½•ï¼Œè€Œtake(n: Int)åˆ™ç”¨äºæ”¶é›†å¤šæ¡è®°å½•ï¼Œè®°å½•çš„æ•°é‡ç”±Intç±»å‹çš„å‚æ•°næ¥æŒ‡å®šã€‚</p><p>ä¸éš¾å‘ç°ï¼Œfirstä¸takeçš„ä¸»è¦ä½œç”¨ï¼Œåœ¨äºæ•°æ®æ¢ç´¢ã€‚å¯¹äºRDDçš„æ¯ä¸€æ­¥è½¬æ¢ï¼Œæ¯”å¦‚Word Countä¸­ä»æ–‡æœ¬è¡Œåˆ°å•è¯ã€ä»å•è¯åˆ°KVè½¬æ¢ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨firstæˆ–æ˜¯takeæ¥è·å–å‡ æ¡è®¡ç®—ç»“æœï¼Œä»è€Œç¡®ä¿è½¬æ¢é€»è¾‘ä¸é¢„æœŸä¸€è‡´ã€‚</p><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œcollectæ‹¿åˆ°çš„ä¸æ˜¯éƒ¨åˆ†ç»“æœï¼Œè€Œæ˜¯å…¨é‡æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æŠŠRDDçš„è®¡ç®—ç»“æœå…¨é‡åœ°æ”¶é›†åˆ°Driverç«¯ã€‚åœ¨ä¸Šé¢Word Countçš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”±äºå…¨é‡ç»“æœè¾ƒå¤§ï¼Œå±å¹•æ‰“å°åªå¥½åšæˆªæ–­å¤„ç†ã€‚</p><p>ä¸ºäº†è®©ä½ æ›´æ·±å…¥åœ°ç†è§£collectç®—å­çš„å·¥ä½œåŸç†ï¼Œæˆ‘æŠŠå®ƒçš„è®¡ç®—è¿‡ç¨‹ç”»åœ¨äº†åé¢çš„ç¤ºæ„å›¾ä¸­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/61/65/61684b05fbefcc777e995f644c9cfe65.jpg?wh=1920x653\" alt=\"å›¾ç‰‡\" title=\"collectç®—å­å·¥ä½œåŸç†\"></p><p>ç»“åˆç¤ºæ„å›¾ï¼Œä¸éš¾å‘ç°ï¼Œcollectç®—å­æœ‰ä¸¤å¤„æ€§èƒ½éšæ‚£ï¼Œ<strong>ä¸€ä¸ªæ˜¯æ‹‰å–æ•°æ®è¿‡ç¨‹ä¸­å¼•å…¥çš„ç½‘ç»œå¼€é”€ï¼Œå¦ä¸€ä¸ªDriverçš„OOMï¼ˆå†…å­˜æº¢å‡ºï¼ŒOut of Memoryï¼‰</strong>ã€‚</p><p>ç½‘ç»œå¼€é”€å¾ˆå¥½ç†è§£ï¼Œæ—¢ç„¶æ•°æ®çš„æ‹‰å–å’Œæ¬è¿æ˜¯è·¨è¿›ç¨‹ã€è·¨èŠ‚ç‚¹çš„ï¼Œé‚£ä¹ˆå’ŒShuffleç±»ä¼¼ï¼Œè¿™ä¸ªè¿‡ç¨‹å¿…ç„¶ä¼šå¼•å…¥ç½‘ç»œå¼€é”€ã€‚</p><p>å†è€…ï¼Œé€šå¸¸æ¥è¯´ï¼ŒDriverç«¯çš„é¢„è®¾å†…å­˜å¾€å¾€åœ¨GBé‡çº§ï¼Œè€ŒRDDçš„ä½“é‡ä¸€èˆ¬éƒ½åœ¨æ•°åGBã€ç”šè‡³ä¸Šç™¾GBï¼Œå› æ­¤ï¼ŒOOMçš„éšæ‚£ä¸è¨€è€Œå–»ã€‚collectç®—å­å°è¯•æŠŠRDDå…¨é‡ç»“æœæ‹‰å–åˆ°Driverï¼Œå½“ç»“æœé›†å°ºå¯¸è¶…è¿‡Driveré¢„è®¾çš„å†…å­˜å¤§å°æ—¶ï¼ŒSparkè‡ªç„¶ä¼šæŠ¥OOMçš„å¼‚å¸¸ï¼ˆExceptionï¼‰ã€‚</p><p>æ­£æ˜¯å‡ºäºè¿™äº›åŸå› ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨collectç®—å­ä¹‹å‰ï¼ŒåŠ¡å¿…è¦æ…é‡ã€‚ä¸è¿‡ï¼Œä½ å¯èƒ½ä¼šé—®ï¼šâ€œå¦‚æœä¸šåŠ¡é€»è¾‘å°±æ˜¯éœ€è¦æ”¶é›†å…¨é‡ç»“æœï¼Œè€Œcollectç®—å­åˆä¸å¥½ç”¨ï¼Œé‚£æˆ‘è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿâ€åˆ«ç€æ€¥ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚</p><h3>saveAsTextFile</h3><p>å¯¹äºå…¨é‡çš„ç»“æœé›†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç¬¬äºŒç±»ç®—å­æŠŠå®ƒä»¬ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚åœ¨è¿™ç±»ç®—å­ä¸­ï¼Œæœ€å…·ä»£è¡¨æ€§çš„ésaveAsTextFileè«å±ï¼Œå®ƒçš„ç”¨æ³•éå¸¸ç®€å•ï¼Œç»™å®šRDDï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨saveAsTextFile(path: String)å³å¯ã€‚å…¶ä¸­pathä»£è¡¨çš„æ˜¯ç›®æ ‡æ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼Œå®ƒå¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥æ˜¯HDFSã€Amazon S3ç­‰åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>ä¸ºäº†è®©ä½ åŠ æ·±å¯¹äºç¬¬äºŒç±»ç®—å­çš„ç†è§£ï¼Œæˆ‘æŠŠå®ƒä»¬çš„å·¥ä½œåŸç†ä¹Ÿæ•´ç†åˆ°äº†ä¸‹é¢çš„ç¤ºæ„å›¾ä¸­ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä»¥saveAsTextFileä¸ºä»£è¡¨çš„ç®—å­ï¼Œç›´æ¥é€šè¿‡Executorså°†RDDæ•°æ®åˆ†åŒºç‰©åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸æ¶‰åŠä¸Driverç«¯çš„ä»»ä½•äº¤äº’ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/28/e0/2892b89238d64006be177fd7fde531e0.jpg?wh=1920x684\" alt=\"å›¾ç‰‡\" title=\"saveAsTextFileå·¥ä½œåŸç†\"></p><p>ç”±äºæ•°æ®çš„æŒä¹…åŒ–ä¸Driveræ— å…³ï¼Œå› æ­¤è¿™ç±»ç®—å­å¤©ç„¶åœ°é¿å¼€äº†collectç®—å­å¸¦æ¥çš„ä¸¤ä¸ªæ€§èƒ½éšæ‚£ã€‚</p><p>å¥½å•¦ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œç”¨äºç»“æœæ”¶é›†çš„ç®—å­æˆ‘ä»¬å°±ä»‹ç»å®Œäº†ï¼ŒæŒæ¡äº†firstã€takeã€collectå’ŒsaveAsTextFileç­‰ç®—å­ä¹‹åï¼Œä½ å¯ä»¥å…ˆç”¨firstã€takeç­‰ç®—å­éªŒè¯è®¡ç®—é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œç„¶åå†ä½¿ç”¨saveAsTextFileç®—å­æŠŠå…¨é‡ç»“æœæŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä»¥å¤‡ä¹‹åä½¿ç”¨ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä»‹ç»å¹¶è®²è§£äº†å¾ˆå¤šRDDç®—å­ï¼Œè¿™äº›ç®—å­å¯ä»¥åˆ†åˆ«å½’ç±»åˆ°æ•°æ®ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µï¼Œç®—å­ä¸é˜¶æ®µçš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8f/cb/8fc62a1795606466f1fe391d098731cb.jpg?wh=1920x737\" alt=\"å›¾ç‰‡\" title=\"æ•°æ®ç”Ÿå‘½å‘¨æœŸ\"></p><p>åœ¨æ•°æ®å‡†å¤‡é˜¶æ®µï¼Œä½ å¯ä»¥ä½¿ç”¨unionå’Œsampleæ¥æ‰©å¼ æˆ–æ˜¯ç¼©å°åˆ†å¸ƒå¼æ•°æ®é›†ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œ<strong>å‚ä¸unionçš„å¤šä¸ªRDDåœ¨ç±»å‹ä¸Šå¿…é¡»ä¿æŒä¸€è‡´</strong>ã€‚</p><p>åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µï¼Œä½ å¯ä»¥åˆ©ç”¨repartitionå’Œcoalesceæ¥è°ƒæ•´RDDçš„å¹¶è¡Œåº¦ã€‚RDDå¹¶è¡Œåº¦å¯¹äºCPUåˆ©ç”¨ç‡è‡³å…³é‡è¦ï¼Œå®ƒåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šç€å¹¶è¡Œè®¡ç®—çš„æ‰§è¡Œæ•ˆç‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç»™å®šExecutorsä¸ªæ•°Nï¼Œä»¥åŠCPU/Executoré…ç½®ä¸ªæ•°Cï¼Œé‚£ä¹ˆæˆ‘ä¼š<strong>æ¨èä½ æŠŠRDDçš„å¹¶è¡Œåº¦è®¾ç½®åœ¨N<em>C</em>2åˆ°N<em>C</em>3ä¹‹é—´</strong>ã€‚</p><p>æœ€åï¼Œåœ¨ç»“æœæ”¶é›†é˜¶æ®µï¼Œä½ å¯ä»¥ä½¿ç”¨firstã€takeã€collectç­‰ç®—å­æ¥æ¢ç´¢æ•°æ®ï¼Œè¿™äº›ç®—å­å¯ä»¥ç”¨æ¥éªŒè¯è®¡ç®—è¿‡ç¨‹ä¸­çš„è½¬æ¢é€»è¾‘æ˜¯å¦ä¸é¢„æœŸä¸€è‡´ã€‚å½“ä½ ç¡®è®¤è®¡ç®—é€»è¾‘å‡†ç¡®æ— è¯¯ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨saveAsTextFileç­‰ç®—å­å°†å…¨é‡ç»“æœé›†æŒä¹…åŒ–åˆ°ï¼ˆåˆ†å¸ƒå¼ï¼‰æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>åˆ°ä»Šå¤©ä¸ºæ­¢ï¼Œæˆ‘ä»¬ç”¨ä¸‰è®²çš„ç¯‡å¹…ï¼Œå­¦ä¹ äº†RDDå¼€å‘APIä¸­çš„å¤§éƒ¨åˆ†ç®—å­ã€‚çµæ´»åœ°è¿ç”¨è¿™äº›ç®—å­ï¼Œä½ å°±èƒ½è½»æ¾åº”å¯¹æ—¥å¸¸å¼€å‘ä¸­å¤§éƒ¨åˆ†çš„ä¸šåŠ¡éœ€æ±‚ã€‚ä¸ºäº†æ–¹ä¾¿ä½ éšæ—¶å›é¡¾ã€æŸ¥é˜…ï¼Œæˆ‘æŠŠæˆ‘ä»¬ä¸€èµ·å­¦è¿‡çš„è¿™äº›ç®—å­æ•´ç†åˆ°äº†åé¢çš„è¡¨æ ¼ä¸­ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/71/bc/71742561e52b2b3edeedee5d3d6913bc.jpg?wh=1920x1695\" alt=\"å›¾ç‰‡\" title=\"RDDå¸¸ç”¨ç®—å­ä¸€è§ˆ\"></p><h2>æ¯è¯¾ä¸€ç»ƒ</h2><p>1.ç»™å®š3ä¸ªRDDï¼Œé™¤äº†ä½¿ç”¨rdd1 union rdd2 union rdd3æŠŠå®ƒä»¬åˆå¹¶åœ¨ä¸€èµ·ä¹‹å¤–ï¼Œä½ è®¤ä¸ºè¿˜æœ‰å…¶ä»–æ›´åŠ ä¼˜é›…çš„å†™æ³•å—ï¼Ÿï¼ˆæç¤ºï¼šreduceï¼‰</p><p>2.ç›¸æ¯”repartitionï¼Œcoalesceæœ‰å“ªäº›å¯èƒ½çš„æ½œåœ¨éšæ‚£ï¼Ÿï¼ˆæç¤ºï¼šæ•°æ®åˆ†å¸ƒï¼‰</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµäº’åŠ¨ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™ä¸€è®²åˆ†äº«ç»™æ›´å¤šçš„åŒäº‹ã€æœ‹å‹ï¼Œå¸®ä»–ç†æ¸…RDDçš„å¸¸ç”¨ç®—å­ã€‚</p>","neighbors":{"left":{"article_title":"08 | å†…å­˜ç®¡ç†ï¼šSparkå¦‚ä½•ä½¿ç”¨å†…å­˜ï¼Ÿ","id":422400},"right":{"article_title":"10 | å¹¿æ’­å˜é‡ & ç´¯åŠ å™¨ï¼šå…±äº«å˜é‡æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿ","id":423878}},"comments":[{"had_liked":false,"id":314206,"user_name":"GACÂ·DU","can_delete":false,"product_type":"c1","uid":1385403,"ip_address":"","ucode":"7847FBE1C13740","user_header":"https://static001.geekbang.org/account/avatar/00/15/23/bb/a1a61f7c.jpg","comment_is_top":true,"comment_ctime":1632898208,"is_pvip":true,"replies":[{"id":"113804","content":"ä¼˜ç§€ï¼ğŸ‘ğŸ‘ğŸ‘ æ»¡åˆ†ğŸ’¯ï¼Œç½®é¡¶ğŸ”","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1632911785,"ip_address":"","comment_id":314206,"utype":1}],"discussion_count":1,"race_medal":0,"score":"9.2233720857323008e+18","product_id":100090001,"comment_content":"#åˆå¹¶RDD<br>æµ‹è¯•äº†ä¸‰ç§æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯unionã€reduceã€++ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨toDebugStringæ–¹æ³•æŸ¥çœ‹ï¼Œæ˜¾ç¤ºç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä¸‹é¢çš„ä»£ç æ˜¯åœ¨spark-shellä¸Šæµ‹è¯•çš„<br>```scala<br>scala&gt; val rdd1 = spark.sparkContext.parallelize(1 to 10)<br><br>scala&gt; val rdd2 = spark.sparkContext.parallelize(20 to 30)<br>scala&gt; val unionRDD = rdd1 union rdd2<br><br>scala&gt; unionRDD.collect<br>res3: Array[Int] = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30)<br>scala&gt; unionRDD.toDebugString<br>res4: String =<br>(16) UnionRDD[2] at union at &lt;console&gt;:27 []<br> |   ParallelCollectionRDD[0] at parallelize at &lt;console&gt;:23 []<br> |   ParallelCollectionRDD[1] at parallelize at &lt;console&gt;:23 []<br><br>scala&gt; val data = Seq(rdd1, rdd2)<br>scala&gt; data.foreach(println)<br>ParallelCollectionRDD[0] at parallelize at &lt;console&gt;:23<br>ParallelCollectionRDD[1] at parallelize at &lt;console&gt;:23<br>scala&gt; val reduceRDD = data.reduce(_ union _)<br>scala&gt; reduceRDD.collect<br>res6: Array[Int] = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30)<br>scala&gt; reduceRDD.toDebugString<br>res7: String =<br>(16) UnionRDD[3] at union at &lt;console&gt;:25 []<br> |   ParallelCollectionRDD[0] at parallelize at &lt;console&gt;:23 []<br> |   ParallelCollectionRDD[1] at parallelize at &lt;console&gt;:23 []<br><br>scala&gt; val addRDD = rdd1 ++ rdd2<br>scala&gt; addRDD.collect<br>res15: Array[Int] = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30)<br>scala&gt; addRDD.toDebugString<br>res16: String =<br>(16) UnionRDD[7] at $plus$plus at &lt;console&gt;:27 []<br> |   ParallelCollectionRDD[0] at parallelize at &lt;console&gt;:23 []<br> |   ParallelCollectionRDD[1] at parallelize at &lt;console&gt;:23 []<br>```<br># coalesce æ½œåœ¨éšæ‚£<br>repartitionå’Œcoalesceç›¸æ¯”è¾ƒï¼Œrepartitionç”±äºå¼•å…¥äº†shuffleæœºåˆ¶ï¼Œå¯¹æ•°æ®è¿›è¡Œæ‰“æ•£ï¼Œæ··æ´—ï¼Œé‡æ–°å¹³å‡åˆ†é…ï¼Œæ‰€ä»¥repartitionæ“ä½œè¾ƒé‡ï¼Œä½†æ˜¯æ•°æ®åˆ†é…å‡åŒ€ã€‚è€Œcoalesceåªæ˜¯ç²—åŠ›åº¦ç§»åŠ¨æ•°æ®ï¼Œæ²¡æœ‰å¹³å‡åˆ†é…çš„è¿‡ç¨‹ï¼Œä¼šå¯¼è‡´æ•°æ®åˆ†å¸ƒä¸å‡åŒ€ï¼Œåœ¨è®¡ç®—æ—¶å‡ºç°æ•°æ®å€¾æ–œã€‚<br>","like_count":12,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527613,"discussion_content":"ä¼˜ç§€ï¼ğŸ‘ğŸ‘ğŸ‘ æ»¡åˆ†ğŸ’¯ï¼Œç½®é¡¶ğŸ”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632911785,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315232,"user_name":"ç«ç‚ç„±ç‡š","can_delete":false,"product_type":"c1","uid":2767491,"ip_address":"","ucode":"DB11784DD94059","user_header":"https://static001.geekbang.org/account/avatar/00/2a/3a/83/74e3fabd.jpg","comment_is_top":false,"comment_ctime":1633760241,"is_pvip":false,"replies":[{"id":"114418","content":"å¥½é—®é¢˜ï¼Œä½ è¯´çš„æ²¡é”™ï¼ŒSparkçš„é‡‡æ ·ï¼Œç¡®å®ä¸ä¼šç²¾ç¡®åœ°æ§åˆ¶ä¸ªæ•°ã€‚è¿™è·Ÿä»–çš„é‡‡æ ·åŸç†æœ‰å…³ï¼ŒSparké‡‡ç”¨ä¼¯åŠªåˆ©æˆ–æ˜¯æ³Šæ¾åˆ†å¸ƒæ¥åšé‡‡æ ·ï¼Œå¯¹äºæ¯ä¸€ä¸ªæ•°æ®å…ƒç´ çš„é‡‡æ ·ï¼Œéƒ½æ˜¯ç‹¬ç«‹çš„ã€‚æ¯”å¦‚è¿™é‡Œçš„0.1ï¼Œä¹Ÿå°±æ˜¯10%çš„é‡‡æ ·ç‡ï¼ŒSparkä¼šå¯¹RDDæ¯ä¸ªå…ƒç´ æŠ›ä¸ªéª°å­ï¼Œéª°å­å€¼å°äº10%ï¼Œæ‰ä¼šæŠŠè¿™ä¸ªå…ƒç´ é‡‡é›†å‡ºå»ã€‚å› æ­¤ï¼Œ10%è¿™ä¸ªæ¯”ä¾‹åªæ˜¯åœ¨ç»Ÿè®¡ä¸Šçš„ä¸€ç§è¿‘ä¼¼ï¼Œè€Œä¸ä¼šç²¾ç¡®åœ°ä¿è¯æ¯æ¬¡é‡‡æ ·çš„ä¸ªæ•°ï¼Œä¸€å®šæ˜¯åŸæ•°æ®çš„10%ã€‚ä¸€ä¸ªtipsæ˜¯ï¼Œé‡‡æ ·ç‡è¶Šé«˜ï¼Œç²¾ç¡®ç‡è¶Šé«˜ï¼Œè¿™ä¸ªè¿˜æ˜¯é‚£å¥è¯ï¼Œè·Ÿåˆšæ‰çš„é‡‡æ ·åŸç†æœ‰å…³~<br><br>å¦‚æœæƒ³ç²¾ç¡®é‡‡æ ·çš„è¯ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š<br>rdd.takeSample(false, 1000)<br>è¿™æ ·å¾—åˆ°çš„ç»“æœï¼Œä¸€å®šæ˜¯é‡‡é›†1000ä¸ªæ•°å€¼ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„è¿”å›ç»“æœï¼Œä¸å†æ˜¯RDDï¼Œè€Œæ˜¯arrayã€‚takeSampleçš„å®ç°ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨sampleç®—å­ï¼Œåªä¸è¿‡åœ¨æœ€åï¼ŒåŠ å…¥äº†å…ƒç´ ä¸ªæ•°ä¸Šçš„æ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯é‡‡æ ·ç»“æœï¼Œä¸€å®šæ˜¯è¿™é‡ŒæŒ‡å®šçš„1000ã€‚æœ€åï¼Œè¦å¼ºè°ƒçš„æ˜¯ï¼ŒtakeSampleä¼šæŠŠç»“æœæ”¶é›†åˆ°Driverç«¯ï¼Œæ‰€ä»¥è¦æ³¨æ„å®ƒå¯¹äºDriverç«¯å†…å­˜çš„æ¶ˆè€—~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1633963756,"ip_address":"","comment_id":315232,"utype":1}],"discussion_count":1,"race_medal":0,"score":"40288465905","product_id":100090001,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿™å„¿é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸å¤ªæ˜ç™½ï¼Œä¸€å…±æœ‰100ä¸ªæ•°å­—ï¼Œæ¯æ¬¡sampleï¼ˆFalseï¼Œ0.1ï¼‰ç†è®ºä¸Šåº”è¯¥ä¼šè·å–10ä¸ªæ•°å­—ï¼Œä½†è¿è¡Œå‡ æ¬¡å¾—åˆ°çš„æ•°å­—ä¸ªæ•°éƒ½ä¸åŒï¼Œæœ‰çš„æ˜¯8ä¸ªï¼Œæœ‰çš„11ä¸ªï¼Œè¿™æ˜¯ä¸ºå•¥ï¼Ÿsparkä¸­sampleçš„åŸç†ä¸ä¼šç²¾ç¡®æ§åˆ¶ä¸ªæ•°å—ï¼Ÿ<br>è¿è¡Œä»£ç ï¼š<br>&gt;&gt;&gt; rdd.sample(False,0.1).collect()<br>[1, 18, 23, 25, 31, 52, 59, 73, 95, 96, 97]<br>&gt;&gt;&gt; rdd.sample(False,0.1).collect()<br>[11, 12, 13, 36, 40, 50, 51, 77, 90]<br>&gt;&gt;&gt; rdd.sample(False,0.1).collect()<br>[2, 13, 21, 33, 51, 59, 73, 80, 84, 88]<br>&gt;&gt;&gt; rdd.sample(False,0.1).collect()<br>[3, 18, 41, 44, 67, 87, 89, 91]<br>&gt;&gt;&gt; rdd.sample(False,0.1).collect()<br>[35, 41, 69, 75, 87, 92, 99]<br>","like_count":10,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527910,"discussion_content":"å¥½é—®é¢˜ï¼Œä½ è¯´çš„æ²¡é”™ï¼ŒSparkçš„é‡‡æ ·ï¼Œç¡®å®ä¸ä¼šç²¾ç¡®åœ°æ§åˆ¶ä¸ªæ•°ã€‚è¿™è·Ÿä»–çš„é‡‡æ ·åŸç†æœ‰å…³ï¼ŒSparké‡‡ç”¨ä¼¯åŠªåˆ©æˆ–æ˜¯æ³Šæ¾åˆ†å¸ƒæ¥åšé‡‡æ ·ï¼Œå¯¹äºæ¯ä¸€ä¸ªæ•°æ®å…ƒç´ çš„é‡‡æ ·ï¼Œéƒ½æ˜¯ç‹¬ç«‹çš„ã€‚æ¯”å¦‚è¿™é‡Œçš„0.1ï¼Œä¹Ÿå°±æ˜¯10%çš„é‡‡æ ·ç‡ï¼ŒSparkä¼šå¯¹RDDæ¯ä¸ªå…ƒç´ æŠ›ä¸ªéª°å­ï¼Œéª°å­å€¼å°äº10%ï¼Œæ‰ä¼šæŠŠè¿™ä¸ªå…ƒç´ é‡‡é›†å‡ºå»ã€‚å› æ­¤ï¼Œ10%è¿™ä¸ªæ¯”ä¾‹åªæ˜¯åœ¨ç»Ÿè®¡ä¸Šçš„ä¸€ç§è¿‘ä¼¼ï¼Œè€Œä¸ä¼šç²¾ç¡®åœ°ä¿è¯æ¯æ¬¡é‡‡æ ·çš„ä¸ªæ•°ï¼Œä¸€å®šæ˜¯åŸæ•°æ®çš„10%ã€‚ä¸€ä¸ªtipsæ˜¯ï¼Œé‡‡æ ·ç‡è¶Šé«˜ï¼Œç²¾ç¡®ç‡è¶Šé«˜ï¼Œè¿™ä¸ªè¿˜æ˜¯é‚£å¥è¯ï¼Œè·Ÿåˆšæ‰çš„é‡‡æ ·åŸç†æœ‰å…³~\n\nå¦‚æœæƒ³ç²¾ç¡®é‡‡æ ·çš„è¯ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š\nrdd.takeSample(false, 1000)\nè¿™æ ·å¾—åˆ°çš„ç»“æœï¼Œä¸€å®šæ˜¯é‡‡é›†1000ä¸ªæ•°å€¼ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„è¿”å›ç»“æœï¼Œä¸å†æ˜¯RDDï¼Œè€Œæ˜¯arrayã€‚takeSampleçš„å®ç°ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨sampleç®—å­ï¼Œåªä¸è¿‡åœ¨æœ€åï¼ŒåŠ å…¥äº†å…ƒç´ ä¸ªæ•°ä¸Šçš„æ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯é‡‡æ ·ç»“æœï¼Œä¸€å®šæ˜¯è¿™é‡ŒæŒ‡å®šçš„1000ã€‚æœ€åï¼Œè¦å¼ºè°ƒçš„æ˜¯ï¼ŒtakeSampleä¼šæŠŠç»“æœæ”¶é›†åˆ°Driverç«¯ï¼Œæ‰€ä»¥è¦æ³¨æ„å®ƒå¯¹äºDriverç«¯å†…å­˜çš„æ¶ˆè€—~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633963756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314346,"user_name":"Geek_2dfa9a","can_delete":false,"product_type":"c1","uid":1435535,"ip_address":"","ucode":"B5FE7971F5E773","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epGTSTvn7r4ibk1PuaUrSvvLdviaLcne50jbvvfiaxKkM5SLibeP6jibA2bCCQBqETibvIvcsOhAZlwS8kQ/132","comment_is_top":false,"comment_ctime":1632982370,"is_pvip":false,"replies":[{"id":"113941","content":"æ­£è§£ï¼Œæ»¡åˆ†ğŸ’¯ ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1633167390,"ip_address":"","comment_id":314346,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23107818850","product_id":100090001,"comment_content":"ç¬¬ä¸€é¢˜<br>æ²¡æ˜ç™½è€ƒç‚¹æ˜¯å•¥ï¼Œè€ƒçš„æ˜¯scalaçš„è¯­æ³•ä¹ˆï¼Ÿ<br>val rdd1 = sc.textFile(&quot;&quot;)<br>val rdd2 = sc.textFile(&quot;&quot;)<br>val rdd3 = sc.textFile(&quot;&quot;)<br>val unionRdd = rdd1.union(rdd2).union(rdd3)<br>val unionRdd2 = Seq(rdd1, rdd2, rdd3).reduce(_.union(_))<br><br>ç¬¬äºŒé¢˜<br>repartitionä¹Ÿæ˜¯é€šè¿‡colesceå®ç°çš„ï¼Œåªä¸è¿‡repartitioné»˜è®¤æ˜¯è¦shuffleçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œrepartitionè‚¯å®šæ˜¯ä¼šé€šè¿‡å“ˆå¸Œé‡åˆ†åŒºçš„ï¼Œ<br>ä¸ç®¡åˆ†åŒºå‰æ•°æ®åˆ†å¸ƒæ˜¯å¦å‡åŒ€ï¼Œåˆ†åŒºåæ•°æ®åˆ†å¸ƒä¼šæ¯”è¾ƒå‡åŒ€ï¼Œä½†æ˜¯colesceå°±æœªå¿…äº†ï¼Œcolesceé»˜è®¤æ˜¯ä¸shuffleçš„ï¼Œä¼šå°½é‡åœ¨localåˆå¹¶åˆ†åŒºï¼Œ<br>  å¦‚æœcolesceä¹‹å‰æ•°æ®æ˜¯åˆ†å¸ƒä¸å‡åŒ€çš„ï¼Œé‚£colesceä¹‹åæ•°æ®åˆ†å¸ƒè¿˜æ˜¯ä¸å‡åŒ€çš„ï¼Œè¿™ç§æƒ…å†µä¸‹æŒ‡å®šæ–¹æ³•å…¥å‚shuffle=trueå°±è§£å†³äº†ã€‚<br>","like_count":6,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527654,"discussion_content":"æ­£è§£ï¼Œæ»¡åˆ†ğŸ’¯ ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633167390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1096652,"avatar":"https://static001.geekbang.org/account/avatar/00/10/bb/cc/fac12364.jpg","nickname":"xxx","note":"","ucode":"E79CEA70430449","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544860,"discussion_content":"æˆ‘æ‰¿è®¤ï¼Œä½ æ˜¯ç§€å„¿ğŸ‘†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641737939,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314230,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1632907353,"is_pvip":true,"replies":[{"id":"113802","content":"éå¸¸å¥½çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥ç»†è¯´è¯´~ å–å†³äºä½ å¦‚ä½•è°ƒç”¨coalesce(1, shuffle = false&#47;true)ï¼Œåˆ†ä¸¤ç§æƒ…å†µã€‚<br><br>1. shuffle = falseï¼Œè¿™ä¸ªæ—¶å€™ï¼Œcoalesceä¸ä¼šå¼•å…¥Shuffleï¼Œä½†æ˜¯ï¼Œæ‰€æœ‰æ“ä½œï¼Œä»ä¸€å¼€å§‹ï¼Œå¹¶è¡Œåº¦éƒ½æ˜¯1ï¼Œéƒ½åœ¨ä¸€ä¸ªexecutorè®¡ç®—ï¼Œæ˜¾ç„¶ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ•´ä¸ªä½œä¸šéå¸¸æ…¢ï¼Œå¥‡æ…¢æ— æ¯”<br><br>2. shuffle = trueï¼Œè¿™ä¸ªæ—¶å€™ï¼Œcoalesceå°±ä¼šå¼•å…¥shuffleï¼Œåˆ‡å‰²stageã€‚coalesceä¹‹å‰ï¼Œç”¨æºæ•°æ®DataFrameçš„å¹¶è¡Œåº¦ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯å¤šä¸ªExecutorsçœŸæ­£çš„å¹¶è¡Œè®¡ç®—ï¼›coalesceä¹‹åï¼Œä¹Ÿå°±æ˜¯shuffleä¹‹åï¼Œå¹¶è¡Œåº¦ä¸‹é™ä¸º1ï¼Œæ‰€æœ‰çˆ¶RDDçš„åˆ†åŒºï¼Œå…¨éƒ¨shuffleåˆ°ä¸€ä¸ªexecutorï¼Œäº¤ç»™ä¸€ä¸ªtaskå»è®¡ç®—ã€‚<br><br>æ˜¾ç„¶ï¼Œç›¸æ¯”å‰ä¸€ç§ï¼Œè¿™ç§å®ç°åœ¨æ‰§è¡Œæ•ˆç‡ä¸Šï¼Œæ›´å¥½ä¸€äº›ã€‚å› æ­¤ï¼Œå¦‚æœä¸šåŠ¡åº”ç”¨å¿…é¡»è¦è¿™ä¹ˆåšï¼Œæ¨èè¿™ä¸€ç§å®ç°æ–¹æ³•ã€‚å›ç­”ä½ æœ€åˆçš„é—®é¢˜ï¼Œæ²¡é”™ï¼Œcoalesce(1)å¿…ç„¶ä¼šæŠŠæ•°æ®éƒ½æ”¾å…¥åŒä¸€ä¸ªExecutoré‡Œ","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1632911611,"ip_address":"","comment_id":314230,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23107743833","product_id":100090001,"comment_content":"ä»æ–‡ä¸­çš„æè¿°æ¥çœ‹ï¼Œcoalesceä¼¼ä¹å¹¶ä¸èƒ½é¿å…shuffleï¼Ÿæç«¯çš„ä¾‹å­ï¼Œcoalesce(1)å¿…ç„¶ä¼šæŠŠæ•°æ®éƒ½æ”¾å…¥åŒä¸€ä¸ªExecutoré‡Œï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527618,"discussion_content":"éå¸¸å¥½çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥ç»†è¯´è¯´~ å–å†³äºä½ å¦‚ä½•è°ƒç”¨coalesce(1, shuffle = false/true)ï¼Œåˆ†ä¸¤ç§æƒ…å†µã€‚\n\n1. shuffle = falseï¼Œè¿™ä¸ªæ—¶å€™ï¼Œcoalesceä¸ä¼šå¼•å…¥Shuffleï¼Œä½†æ˜¯ï¼Œæ‰€æœ‰æ“ä½œï¼Œä»ä¸€å¼€å§‹ï¼Œå¹¶è¡Œåº¦éƒ½æ˜¯1ï¼Œéƒ½åœ¨ä¸€ä¸ªexecutorè®¡ç®—ï¼Œæ˜¾ç„¶ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ•´ä¸ªä½œä¸šéå¸¸æ…¢ï¼Œå¥‡æ…¢æ— æ¯”\n\n2. shuffle = trueï¼Œè¿™ä¸ªæ—¶å€™ï¼Œcoalesceå°±ä¼šå¼•å…¥shuffleï¼Œåˆ‡å‰²stageã€‚coalesceä¹‹å‰ï¼Œç”¨æºæ•°æ®DataFrameçš„å¹¶è¡Œåº¦ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯å¤šä¸ªExecutorsçœŸæ­£çš„å¹¶è¡Œè®¡ç®—ï¼›coalesceä¹‹åï¼Œä¹Ÿå°±æ˜¯shuffleä¹‹åï¼Œå¹¶è¡Œåº¦ä¸‹é™ä¸º1ï¼Œæ‰€æœ‰çˆ¶RDDçš„åˆ†åŒºï¼Œå…¨éƒ¨shuffleåˆ°ä¸€ä¸ªexecutorï¼Œäº¤ç»™ä¸€ä¸ªtaskå»è®¡ç®—ã€‚\n\næ˜¾ç„¶ï¼Œç›¸æ¯”å‰ä¸€ç§ï¼Œè¿™ç§å®ç°åœ¨æ‰§è¡Œæ•ˆç‡ä¸Šï¼Œæ›´å¥½ä¸€äº›ã€‚å› æ­¤ï¼Œå¦‚æœä¸šåŠ¡åº”ç”¨å¿…é¡»è¦è¿™ä¹ˆåšï¼Œæ¨èè¿™ä¸€ç§å®ç°æ–¹æ³•ã€‚å›ç­”ä½ æœ€åˆçš„é—®é¢˜ï¼Œæ²¡é”™ï¼Œcoalesce(1)å¿…ç„¶ä¼šæŠŠæ•°æ®éƒ½æ”¾å…¥åŒä¸€ä¸ªExecutoré‡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632911611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314189,"user_name":"Geek_038655","can_delete":false,"product_type":"c1","uid":1657319,"ip_address":"","ucode":"495F542A729F1F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIjUDIRQ0gRictgQpjWia38qjN3pYicfzahAwbntWq93CorhjiaIOVh7j2Fj6a9WxUW85icMxF3r2Ymblg/132","comment_is_top":false,"comment_ctime":1632891893,"is_pvip":false,"replies":[{"id":"113798","content":"å¹¶æ— ä¼˜åŠ£ä¹‹åˆ†~<br><br>foreachPartitionæ›´å¤šåœ°ç”¨æ¥å†™DBå’ŒKafkaï¼›è€ŒsaveAsTextFileç”¨æ¥å†™æ–‡ä»¶ç³»ç»Ÿã€‚æ•°æ®å†™å…¥æ ‡çš„ä¸åŒè€Œå·²ï¼Œæ²¡æœ‰ä¼˜åŠ£ä¸Šçš„å·®åˆ«ã€‚<br><br>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨foreachPartitionæ¥å†™æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¸å¦‚ç›´æ¥è°ƒç”¨saveAsTextFileè¿™ç±»ç®—å­æ–¹ä¾¿ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1632909427,"ip_address":"","comment_id":314189,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14517793781","product_id":100090001,"comment_content":"collectå¯¹äºå¤§æ•°æ®åˆ†æç»“æœè¿‡å¤§å¯¼è‡´çš„OOMé—®é¢˜ï¼Œç”¨saveAsTextFileè§£å†³æ˜¯ä¸æ˜¯è¿‡äºè¿å°±ï¼Ÿ<br>ä¸ºä»€ä¹ˆä¸ç”¨foreashPartition?","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527604,"discussion_content":"å¹¶æ— ä¼˜åŠ£ä¹‹åˆ†~\n\nforeachPartitionæ›´å¤šåœ°ç”¨æ¥å†™DBå’ŒKafkaï¼›è€ŒsaveAsTextFileç”¨æ¥å†™æ–‡ä»¶ç³»ç»Ÿã€‚æ•°æ®å†™å…¥æ ‡çš„ä¸åŒè€Œå·²ï¼Œæ²¡æœ‰ä¼˜åŠ£ä¸Šçš„å·®åˆ«ã€‚\n\nå½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨foreachPartitionæ¥å†™æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¸å¦‚ç›´æ¥è°ƒç”¨saveAsTextFileè¿™ç±»ç®—å­æ–¹ä¾¿ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632909427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314176,"user_name":"çˆ±åƒçŒ«çš„é±¼","can_delete":false,"product_type":"c1","uid":1515374,"ip_address":"","ucode":"494EA47546CF02","user_header":"https://static001.geekbang.org/account/avatar/00/17/1f/6e/7a6788f3.jpg","comment_is_top":false,"comment_ctime":1632886256,"is_pvip":false,"replies":[{"id":"113805","content":"æƒ³å¿…è€å¼Ÿå¯¹coalesce(1, shuffle = false&#47;true)çš„ç”¨æ³•å’ŒåŒºåˆ«ï¼Œå·²ç»äº†å¦‚æŒ‡æŒï¼Œä¸å†èµ˜è¿°ã€‚<br><br>é—æ†¾çš„æ˜¯ï¼Œé©´å’Œç†ŠçŒ«ä¸å¯å…¼å¾—ï¼Œæƒ³è¦é«˜æ€§èƒ½çš„åŒæ—¶åšåˆ°ä¿åºï¼Œç¡®å®ä¸å®¹æ˜“ã€‚shuffle = false&#47;trueï¼Œå‰è€…ä¿åºï¼Œåè€…é«˜æ€§èƒ½ï¼Œç¡®å®ä¸¤è€…å¾ˆéš¾å…¼å¾—ã€‚<br><br>å®åœ¨å¯¹ä¸ä½ï¼Œå¯¹äºä¸¤è€…éƒ½éœ€è¦çš„åœºæ™¯ï¼Œæˆ‘æš‚æ—¶è¿˜çœŸæƒ³ä¸åˆ°ç‰¹åˆ«å¥½çš„åŠæ³•ï¼Œé™¤äº†ä½ è¯´çš„â€œå…ˆshuffle -&gt; coalesce(1, shuffle = true) -&gt; å†æ’åº -&gt; å†æ”¶é›†â€ä¹‹å¤–ï¼Œæˆ‘ç°åœ¨è¿˜çœŸæƒ³ä¸åˆ°æ›´å¥½çš„åŠæ³•ï¼ŒæŠ±æ­‰","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1632912166,"ip_address":"","comment_id":314176,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10222820848","product_id":100090001,"comment_content":"coalesce ä¼šé™ä½åŒä¸€ä¸ª stage è®¡ç®—çš„å¹¶è¡Œåº¦ï¼Œå¯¼è‡´ cpu åˆ©ç”¨ç‡ä¸é«˜ï¼Œä»»åŠ¡æ‰§è¡Œæ—¶é—´å˜é•¿ã€‚æˆ‘ä»¬ç›®å‰æœ‰ä¸€ä¸ªå®ç°æ˜¯éœ€è¦å°†æœ€ç»ˆçš„ç»“æœå†™æˆå•ä¸ª avro æ–‡ä»¶ï¼Œå‰é¢çš„è½¬æ¢è¿‡ç¨‹å¯èƒ½æ˜¯å„ç§å„æ ·çš„ï¼Œæˆ‘ä»¬åœ¨æœ€åé˜¶æ®µåŠ ä¸Š repartition(1).write().format(&#39;avro&#39;).mode(&#39;overwrite&#39;).save(&#39;path&#39;)ã€‚æœ€è¿‘å‘ç°æœ‰æ—¶å‰é¢çš„è½¬æ¢è¿‡ç¨‹ä¸­æœ‰æ’åºæ—¶ï¼Œä½¿ç”¨ repartition(1) æœ‰æ—¶å†™å¾—å•æ–‡ä»¶é¡ºåºä¸å¯¹ï¼Œä½¿ç”¨ coalesce(1) é¡ºåºæ˜¯å¯¹çš„ï¼Œä½† coalesce(1) æœ‰æ€§èƒ½é—®é¢˜ã€‚ç›®å‰æƒ³åˆ°å¯ä»¥ collect åˆ° driver è‡ªå·±å†™ avro æ–‡ä»¶ï¼Œä½†å¯èƒ½å­˜åœ¨ä»¥ä¸Šæåˆ°çš„å†…å­˜é—®é¢˜ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Ÿ ","like_count":2,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527601,"discussion_content":"æƒ³å¿…è€å¼Ÿå¯¹coalesce(1, shuffle = false/true)çš„ç”¨æ³•å’ŒåŒºåˆ«ï¼Œå·²ç»äº†å¦‚æŒ‡æŒï¼Œä¸å†èµ˜è¿°ã€‚\n\né—æ†¾çš„æ˜¯ï¼Œé©´å’Œç†ŠçŒ«ä¸å¯å…¼å¾—ï¼Œæƒ³è¦é«˜æ€§èƒ½çš„åŒæ—¶åšåˆ°ä¿åºï¼Œç¡®å®ä¸å®¹æ˜“ã€‚shuffle = false/trueï¼Œå‰è€…ä¿åºï¼Œåè€…é«˜æ€§èƒ½ï¼Œç¡®å®ä¸¤è€…å¾ˆéš¾å…¼å¾—ã€‚\n\nå®åœ¨å¯¹ä¸ä½ï¼Œå¯¹äºä¸¤è€…éƒ½éœ€è¦çš„åœºæ™¯ï¼Œæˆ‘æš‚æ—¶è¿˜çœŸæƒ³ä¸åˆ°ç‰¹åˆ«å¥½çš„åŠæ³•ï¼Œé™¤äº†ä½ è¯´çš„â€œå…ˆshuffle -&amp;gt; coalesce(1, shuffle = true) -&amp;gt; å†æ’åº -&amp;gt; å†æ”¶é›†â€ä¹‹å¤–ï¼Œæˆ‘ç°åœ¨è¿˜çœŸæƒ³ä¸åˆ°æ›´å¥½çš„åŠæ³•ï¼ŒæŠ±æ­‰","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632912166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1076487,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIKoEicqUZTJly55qoUXRmK4wia7YbnibsMncJaO6tKgKAQNJRfpMsibvfeiaukIibsCsuaic8QjQ3gOoTGA/132","nickname":"å¼ å¯å¤«æ–¯åŸº","note":"","ucode":"3B8DF6D98583F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556031,"discussion_content":"å¯ä»¥æ¢ä¸€ä¸‹æ€è·¯ï¼Œå…ˆé‡‡æ ·è·å–æ•°æ®çš„åˆ†å¸ƒèŒƒå›´ï¼Œæ¯”å¦‚0~10ã€11~20ï¼Œå°½é‡ä¿æŒèŒƒå›´å†…æ•°æ®é‡çš„å‡è¡¡ï¼Œæ¯ä¸ªèŒƒå›´ç”Ÿæˆä¸€ä¸ªæ’å¥½åºçš„æ–‡ä»¶ï¼Œç„¶åä»å°åˆ°å¤§ä¸²è”è¿™äº›æ–‡ä»¶ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647170815,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1515374,"avatar":"https://static001.geekbang.org/account/avatar/00/17/1f/6e/7a6788f3.jpg","nickname":"çˆ±åƒçŒ«çš„é±¼","note":"","ucode":"494EA47546CF02","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":399620,"discussion_content":"è°¢è°¢è€å¸ˆï¼æœ‰ä¸ªç»“è®ºä¹Ÿæ˜¯å¥½çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633007101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314704,"user_name":"Unknown element","can_delete":false,"product_type":"c1","uid":2028277,"ip_address":"","ucode":"34A129800D0238","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","comment_is_top":false,"comment_ctime":1633337957,"is_pvip":false,"replies":[{"id":"114054","content":"å¥½é—®é¢˜~ <br><br>coalesce(1ï¼Œshuffle = false)ï¼Œé¦–å…ˆï¼Œshuffle = falseï¼Œé€šå¸¸æ˜¯ä¸ºäº†ä¿åºï¼Œå¦åˆ™æ²¡å¿…è¦ã€‚ç„¶åï¼Œcoalesce(1ï¼Œshuffle = false)ï¼Œå®ƒçš„ç›®æ ‡ï¼Œæ˜¯æŠŠåˆ†åŒºæ•°é™ä½ä¸º1ã€‚è¦åšåˆ°æ²¡æœ‰Shuffleï¼Œé‚£åªæœ‰ä»æºå¤´ä¸Šå°±å¼€å§‹é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæºå¤´ä¸Šçš„å¹¶è¡Œåº¦ï¼Œå°±æ˜¯1ã€‚åªæœ‰è¿™æ ·ï¼Œæ‰èƒ½åšåˆ°æœ€ååœ¨æ²¡æœ‰Shuffleçš„æƒ…å†µä¸‹ï¼ŒæŠŠå¹¶è¡Œåº¦é™ä½ä¸º1ã€‚<br><br>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ç§â€œéªšæ“ä½œâ€ä¼šæ‹–ç´¯æ•´ä¸ªä½œä¸šçš„æ‰§è¡Œæ€§èƒ½ï¼Œå¦‚éå¿…è¦ï¼Œç»ä¸æ¨èè¿™ä¹ˆåš~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1633613801,"ip_address":"","comment_id":314704,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5928305253","product_id":100090001,"comment_content":"è€å¸ˆæˆ‘çœ‹äº†è¯„è®ºåŒºé‚£ä¸ªå…³äºcoalesce(1ï¼Œshuffle = false)çš„é—®é¢˜ï¼Œæ‚¨è¯´è¿™ä¸ªæ—¶å€™coalesceä¸ä¼šå¼•å…¥Shuffleï¼Œä½†æ˜¯æ‰€æœ‰æ“ä½œå¹¶è¡Œåº¦éƒ½æ˜¯1ï¼Œéƒ½åœ¨ä¸€ä¸ªexecutorè®¡ç®—ï¼›è¿™é‡Œæˆ‘ä¸å¤ªæ˜ç™½ï¼Œæ—¢ç„¶æ•°æ®æ˜¯åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œåˆä¸èƒ½ç”¨shuffleï¼Œé‚£æ•°æ®æ˜¯æ€ä¹ˆè¢«æ±‡é›†åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527767,"discussion_content":"å¥½é—®é¢˜~ \n\ncoalesce(1ï¼Œshuffle = false)ï¼Œé¦–å…ˆï¼Œshuffle = falseï¼Œé€šå¸¸æ˜¯ä¸ºäº†ä¿åºï¼Œå¦åˆ™æ²¡å¿…è¦ã€‚ç„¶åï¼Œcoalesce(1ï¼Œshuffle = false)ï¼Œå®ƒçš„ç›®æ ‡ï¼Œæ˜¯æŠŠåˆ†åŒºæ•°é™ä½ä¸º1ã€‚è¦åšåˆ°æ²¡æœ‰Shuffleï¼Œé‚£åªæœ‰ä»æºå¤´ä¸Šå°±å¼€å§‹é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæºå¤´ä¸Šçš„å¹¶è¡Œåº¦ï¼Œå°±æ˜¯1ã€‚åªæœ‰è¿™æ ·ï¼Œæ‰èƒ½åšåˆ°æœ€ååœ¨æ²¡æœ‰Shuffleçš„æƒ…å†µä¸‹ï¼ŒæŠŠå¹¶è¡Œåº¦é™ä½ä¸º1ã€‚\n\néœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ç§â€œéªšæ“ä½œâ€ä¼šæ‹–ç´¯æ•´ä¸ªä½œä¸šçš„æ‰§è¡Œæ€§èƒ½ï¼Œå¦‚éå¿…è¦ï¼Œç»ä¸æ¨èè¿™ä¹ˆåš~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633613801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1950765,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/qmdZbyxrRD5qQLKjWkmdp3PCVhwmWTcp0cs04s39pic2RcNw0nNKTDgKqedSQ54bAGWjAVSc9p4vWP8RJRKB6nA/132","nickname":"å†¯æ°","note":"","ucode":"61C92D62D49A66","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":403545,"discussion_content":"åœ¨æºå¤´çš„å¹¶è¡Œåº¦æ§åˆ¶æˆ1ï¼Œå‡è®¾æºå¤´æ˜¯hdfsæ–‡ä»¶ï¼Œè¦åˆå¹¶æˆ1ä¹Ÿåªèƒ½æŠŠæ•°æ®æ‹‰åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†ï¼Œè¿™ä¸ä¹Ÿæ¶‰åŠåˆ°äº†æ•°æ®çš„ä¼ è¾“å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634105811,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2851750,"avatar":"","nickname":"Geek_a7acc4","note":"","ucode":"791C7A828F0B5D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1950765,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/qmdZbyxrRD5qQLKjWkmdp3PCVhwmWTcp0cs04s39pic2RcNw0nNKTDgKqedSQ54bAGWjAVSc9p4vWP8RJRKB6nA/132","nickname":"å†¯æ°","note":"","ucode":"61C92D62D49A66","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532721,"discussion_content":"è¿™ç‚¹æˆ‘ä¹Ÿå¾ˆå›°æƒ‘ï¼Œæˆ‘ç›®å‰çš„ç†è§£æ˜¯æ•°æ®ä¼ è¾“ä¸ç­‰åŒäºshuffleï¼Œä¸çŸ¥é“æ˜¯å¦æ­£ç¡®ï¼Œå¸Œæœ›çŸ¥é“çš„åŒå­¦èƒ½è¯´æ˜ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637673771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":403545,"ip_address":""},"score":532721,"extra":"{\"user_type\":1}"}]}]},{"had_liked":false,"id":357044,"user_name":"æ— éš…","can_delete":false,"product_type":"c1","uid":1058801,"ip_address":"å¹¿ä¸œ","ucode":"756E8D6E915FF0","user_header":"https://static001.geekbang.org/account/avatar/00/10/27/f1/e4fc57a3.jpg","comment_is_top":false,"comment_ctime":1662883539,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1662883539","product_id":100090001,"comment_content":"è€å¸ˆè¯´çš„å¤ªæ£’äº†","like_count":0},{"had_liked":false,"id":323794,"user_name":"å®æ•°","can_delete":false,"product_type":"c1","uid":2637725,"ip_address":"","ucode":"697BEAFCE929D2","user_header":"https://static001.geekbang.org/account/avatar/00/28/3f/9d/c59c12ad.jpg","comment_is_top":false,"comment_ctime":1638164940,"is_pvip":false,"replies":[{"id":"117607","content":"ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ç¬¬6è®²çš„é—®é¢˜é‡Œé¢å›å¤äº†å“ˆ~ ç¬¬6è®²ï¼š06 | Shuffleç®¡ç†ï¼Œå…¶å®å°±æ˜¯åœ¨ä»‹ç»Sort-based shuffleçš„å·¥ä½œåŸç†ï¼Œåªä¸è¿‡ä½œä¸ºå…¥é—¨è¯¾ï¼Œæˆ‘ä»¬æ²¡æœ‰ç‰¹åˆ«ç‚¹æ˜ã€‚bypass mergesortï¼Œå®é™…ä¸Šå°±æ˜¯å½“reduceåˆ†åŒºæ•°å°äºä¸€å®šé˜ˆå€¼ã€ä¸”è®¡ç®—ä¸­ä¸å­˜åœ¨Aggregateæ“ä½œï¼ŒSparkå°±æŠŠSort-based shuffleé€€åŒ–ä¸ºHash-based shuffleï¼Œå› æ­¤ï¼Œbypass mergesortå®é™…çš„åº”ç”¨åœºæ™¯éå¸¸æœ‰é™ï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´ï¼Œæ•°æ®åˆ†æéƒ½å°‘ä¸äº†æ•°æ®èšåˆï¼Œä¹Ÿå°±å°‘ä¸äº†Aggregateæ“ä½œã€‚<br><br>unsafe shuffleï¼Œå…¶å®åº•å­è¿˜æ˜¯Sort-based shuffleï¼Œä½†æ˜¯åˆ©ç”¨äº†Tungstençš„æ•°æ®ç»“æ„æ¥åšä¼˜åŒ–ï¼ŒTungstenç›¸å…³å†…å­˜ï¼Œè€å¼Ÿå¯ä»¥å‚è€ƒï¼š14 | å°å‰å¹•åï¼šDataFrameä¸Spark SQLçš„ç”±æ¥","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1638285247,"ip_address":"","comment_id":323794,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638164940","product_id":100090001,"comment_content":"sortshuufleæ˜¯ä¸æ˜¯èƒ½ä¿è¯å…¨å±€æœ‰åºå‘¢  ç¬¬ä¸€ä»£çš„hashshuffleå¥½åƒæ˜¯ä¸æ˜¯åºŸå¼ƒäº† ï¼Œè€å¸ˆæœ‰ç©ºèƒ½ä¸èƒ½è®²ä¸‹bypass mergesortã€unsafeã€sort shuffle ï¼Œè¿™ä¸‰ä¸ªç¡®å®ä¸æ‡‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534852,"discussion_content":"ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ç¬¬6è®²çš„é—®é¢˜é‡Œé¢å›å¤äº†å“ˆ~ ç¬¬6è®²ï¼š06 | Shuffleç®¡ç†ï¼Œå…¶å®å°±æ˜¯åœ¨ä»‹ç»Sort-based shuffleçš„å·¥ä½œåŸç†ï¼Œåªä¸è¿‡ä½œä¸ºå…¥é—¨è¯¾ï¼Œæˆ‘ä»¬æ²¡æœ‰ç‰¹åˆ«ç‚¹æ˜ã€‚bypass mergesortï¼Œå®é™…ä¸Šå°±æ˜¯å½“reduceåˆ†åŒºæ•°å°äºä¸€å®šé˜ˆå€¼ã€ä¸”è®¡ç®—ä¸­ä¸å­˜åœ¨Aggregateæ“ä½œï¼ŒSparkå°±æŠŠSort-based shuffleé€€åŒ–ä¸ºHash-based shuffleï¼Œå› æ­¤ï¼Œbypass mergesortå®é™…çš„åº”ç”¨åœºæ™¯éå¸¸æœ‰é™ï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´ï¼Œæ•°æ®åˆ†æéƒ½å°‘ä¸äº†æ•°æ®èšåˆï¼Œä¹Ÿå°±å°‘ä¸äº†Aggregateæ“ä½œã€‚\n\nunsafe shuffleï¼Œå…¶å®åº•å­è¿˜æ˜¯Sort-based shuffleï¼Œä½†æ˜¯åˆ©ç”¨äº†Tungstençš„æ•°æ®ç»“æ„æ¥åšä¼˜åŒ–ï¼ŒTungstenç›¸å…³å†…å­˜ï¼Œè€å¼Ÿå¯ä»¥å‚è€ƒï¼š14 | å°å‰å¹•åï¼šDataFrameä¸Spark SQLçš„ç”±æ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638285247,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321412,"user_name":"Andy","can_delete":false,"product_type":"c1","uid":1119133,"ip_address":"","ucode":"4BCA899B8E4E85","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/9d/0ff43179.jpg","comment_is_top":false,"comment_ctime":1636859585,"is_pvip":false,"replies":[{"id":"116846","content":"ç¡®å®ï¼Œç¬¬ä¸€é¢˜è·Ÿscalaè¯­æ³•æ¯”è¾ƒç›¸å…³ï¼Œå¯ä»¥å‚è€ƒGeek_2dfa9aåŒå­¦ç»™å‡ºçš„ç­”æ¡ˆå“ˆï¼šval unionRdd2 = Seq(rdd1, rdd2, rdd3).reduce(_.union(_))ã€‚<br><br>ç¬¬äºŒé¢˜æ»¡åˆ†ğŸ’¯~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1637059036,"ip_address":"","comment_id":321412,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636859585","product_id":100090001,"comment_content":"å¦‚å‰ä¸€ç« å†…å­˜ï¼Œæˆ‘çœ‹è¿‡ä¸€äº›åšå®¢æ–‡ç« ä¹Ÿæ²¡çœ‹æ˜ç™½ï¼Œè€å¸ˆä¸€è®²æˆ‘å°±ç†è§£äº†ã€‚æœ¬ç« è€å¸ˆå’ŒåŒå­¦çš„è¯„è®ºï¼Œè¿›ä¸€æ­¥åŠ å¼ºäº†å¯¹coalesceè§£é‡Š(shuffleå’Œéshuffleçš„åŒºåˆ«)ï¼Œå¦‚coalesce(1) shuffleæ˜¯å¤šä¸ªexecuterè¾“å‡ºæ•°æ®åˆ°ä¸€ä¸ªexecuterä¸ä¿è¯æ•°æ®é¡ºåºï¼Œä½†è¿è¡Œé€Ÿåº¦å¿«ã€‚æœ¬ç« ç¬¬ä¸€é¢˜æ²¡è¾¾å‡ºæ¥ï¼Œçœ‹å®˜ç½‘æ–‡æ¡£å’Œç™¾åº¦ä¹Ÿæ²¡è¾¾ä¸Šæ¥ã€‚åº”è¯¥æ˜¯æˆ‘å¯¹scalaè¯­æ³•ä¸ç†Ÿã€‚ç¬¬äºŒé¢˜æˆ‘çš„ç­”æ¡ˆæ˜¯å¯èƒ½ä¼šå¯¼è‡´åˆ†åŒºæ•°æ®ä¸å‡ï¼Œä¸¥é‡çš„ä¼šå¯¼è‡´æ•°æ®å€¾æ–œè®¡ç®—æ…¢æˆ–å†…å­˜æº¢å‡ºã€‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530360,"discussion_content":"ç¡®å®ï¼Œç¬¬ä¸€é¢˜è·Ÿscalaè¯­æ³•æ¯”è¾ƒç›¸å…³ï¼Œå¯ä»¥å‚è€ƒGeek_2dfa9aåŒå­¦ç»™å‡ºçš„ç­”æ¡ˆå“ˆï¼šval unionRdd2 = Seq(rdd1, rdd2, rdd3).reduce(_.union(_))ã€‚\n\nç¬¬äºŒé¢˜æ»¡åˆ†ğŸ’¯~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637059036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316008,"user_name":"å†¯æ°","can_delete":false,"product_type":"c1","uid":1950765,"ip_address":"","ucode":"61C92D62D49A66","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/qmdZbyxrRD5qQLKjWkmdp3PCVhwmWTcp0cs04s39pic2RcNw0nNKTDgKqedSQ54bAGWjAVSc9p4vWP8RJRKB6nA/132","comment_is_top":false,"comment_ctime":1634105726,"is_pvip":false,"replies":[{"id":"114513","content":"æœ€ä¸»è¦çš„åŒºåˆ«ï¼Œå…¶å®ä¸æ˜¯çœ‹coalesceæœ¬èº«ï¼Œè€Œæ˜¯çœ‹ç»“æœé›†éœ€ä¸éœ€è¦æ’åºï¼Œå¦‚æœæœ‰ä¿åºéœ€æ±‚çš„è¯ï¼Œå°±éœ€è¦æŠŠShuffleé€‰é¡¹ç½®ä¸ºfalseï¼ŒåŸå› å…¶å®å¾ˆç®€å•ï¼Œcoalesceçš„æ—¶å€™å¼•å…¥Shuffleï¼Œå¿…ç„¶ä¸èƒ½ä¿åºã€‚<br><br>ç›¸åï¼Œå¦‚æœæ²¡æœ‰ä¿åºçš„åˆšéœ€ï¼Œé‚£å…¶å®æ¨èæŠŠShuffleé€‰é¡¹ç½®ä¸ºtrueï¼Œè¿™æ ·Sparkåœ¨è¿è¡Œæ—¶ä¼šå°Šé‡åŸæ¥çš„å¹¶è¡Œåº¦ï¼Œä¸å½±å“å¹¶è¡Œè®¡ç®—æ•ˆç‡ã€‚<br><br>å½“ç„¶ï¼Œä¸Šé¢è¯´çš„è¿™äº›ï¼Œéƒ½æ˜¯coalesce(1)çš„æƒ…å†µï¼Œæˆ–æ˜¯næ¯”è¾ƒå°çš„æƒ…å†µï¼ˆä¹Ÿå°±æ˜¯å¹¶è¡Œåº¦æ¯”è¾ƒå°ï¼‰ï¼Œnå¦‚æœæ¯”è¾ƒå¤§çš„è¯ï¼Œè‚¯å®šè¿˜æ˜¯ä¸Shuffleçš„å¥½ï¼Œæ¯•ç«Ÿï¼Œè¿™ä¸ªæ˜¯coalesceç›¸æ¯”repartitionçš„ä¼˜åŠ¿æ‰€åœ¨å˜›ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1634135831,"ip_address":"","comment_id":316008,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634105726","product_id":100090001,"comment_content":"å…³äºcoalesceï¼Œæœ‰ä¸ªç–‘é—®ã€‚ æŒ‰ç…§è€å¸ˆçš„è¯´æ³•ï¼Œcoalesceä¼šå¼•å…¥ä¸¤ç§æ“ä½œï¼Œä¸€ç§åœ¨stageå¼€å¤´å°†æ•°æ®é›†æ”¾åœ¨ä¸€ä¸ªexecutorè¿ç®—ï¼›ä¸€ç§æ˜¯æŒ‰æ•°æ®é›†çš„å­˜å‚¨ä½ç½®å‚ä¸è¿ç®—ï¼Œå¹¶åœ¨æœ€åå°†exectuorå†…çš„åˆ†åŒºåˆå¹¶ã€‚  å…·ä½“é€‰ç”¨å“ªç§æ–¹å¼ï¼Œå¥½åƒä¹Ÿåªèƒ½æ ¹æ®coalesceçš„å‚æ•°næ¥åˆ¤æ–­äº†ï¼Œä½†å…·ä½“çš„é€»è¾‘æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528234,"discussion_content":"æœ€ä¸»è¦çš„åŒºåˆ«ï¼Œå…¶å®ä¸æ˜¯çœ‹coalesceæœ¬èº«ï¼Œè€Œæ˜¯çœ‹ç»“æœé›†éœ€ä¸éœ€è¦æ’åºï¼Œå¦‚æœæœ‰ä¿åºéœ€æ±‚çš„è¯ï¼Œå°±éœ€è¦æŠŠShuffleé€‰é¡¹ç½®ä¸ºfalseï¼ŒåŸå› å…¶å®å¾ˆç®€å•ï¼Œcoalesceçš„æ—¶å€™å¼•å…¥Shuffleï¼Œå¿…ç„¶ä¸èƒ½ä¿åºã€‚\n\nç›¸åï¼Œå¦‚æœæ²¡æœ‰ä¿åºçš„åˆšéœ€ï¼Œé‚£å…¶å®æ¨èæŠŠShuffleé€‰é¡¹ç½®ä¸ºtrueï¼Œè¿™æ ·Sparkåœ¨è¿è¡Œæ—¶ä¼šå°Šé‡åŸæ¥çš„å¹¶è¡Œåº¦ï¼Œä¸å½±å“å¹¶è¡Œè®¡ç®—æ•ˆç‡ã€‚\n\nå½“ç„¶ï¼Œä¸Šé¢è¯´çš„è¿™äº›ï¼Œéƒ½æ˜¯coalesce(1)çš„æƒ…å†µï¼Œæˆ–æ˜¯næ¯”è¾ƒå°çš„æƒ…å†µï¼ˆä¹Ÿå°±æ˜¯å¹¶è¡Œåº¦æ¯”è¾ƒå°ï¼‰ï¼Œnå¦‚æœæ¯”è¾ƒå¤§çš„è¯ï¼Œè‚¯å®šè¿˜æ˜¯ä¸Shuffleçš„å¥½ï¼Œæ¯•ç«Ÿï¼Œè¿™ä¸ªæ˜¯coalesceç›¸æ¯”repartitionçš„ä¼˜åŠ¿æ‰€åœ¨å˜›ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634135831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314564,"user_name":"é’±é¹ Allen","can_delete":false,"product_type":"c1","uid":2518863,"ip_address":"","ucode":"7E95E82C0717DA","user_header":"https://static001.geekbang.org/account/avatar/00/26/6f/4f/3cf1e9c4.jpg","comment_is_top":false,"comment_ctime":1633230059,"is_pvip":true,"replies":[{"id":"114049","content":"æ­£è§£ï¼Œæ»¡åˆ†ğŸ’¯~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1633602060,"ip_address":"","comment_id":314564,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1633230059","product_id":100090001,"comment_content":"1. æ–¹æ³•ä¸€ï¼šSeq(rdd1,rdd2).reduce(_ union _) æ–¹æ³•äºŒï¼š rdd1  ++  rdd2   (é«˜èµç²¾ç®€ç‰ˆæœ¬)<br>2.å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œç›¸æ¯” repartitionï¼Œcoalesceæ²¡æœ‰shuffleï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®å€¾æ–œï¼Œå³ä¸€ä¸ªåˆ†åŒºä¸Šæœ‰ç€å¤§é‡çš„æ•°æ®ï¼Œè€Œå¦å¤–ä¸€ä¸ªå¯èƒ½æ²¡æœ‰å¤šå°‘æ•°æ®ã€‚","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527720,"discussion_content":"æ­£è§£ï¼Œæ»¡åˆ†ğŸ’¯~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633602060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2518863,"avatar":"https://static001.geekbang.org/account/avatar/00/26/6f/4f/3cf1e9c4.jpg","nickname":"é’±é¹ Allen","note":"","ucode":"7E95E82C0717DA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":401243,"discussion_content":"è°¢è°¢å´è€å¸ˆSparké›†å›¢çš„åˆ†äº«ï¼Œç”ŸåŠ¨å¥½è®°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633611050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}