{"id":184040,"title":"29 | MongoDB备份与恢复","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":178150,"user_name":"Geek_8bab89","can_delete":false,"product_type":"c3","uid":1637279,"ip_address":"","ucode":"255D8ABF151B73","user_header":"https://static001.geekbang.org/account/avatar/00/18/fb/9f/7875854f.jpg","comment_is_top":false,"comment_ctime":1581598252,"is_pvip":false,"replies":[{"id":69150,"content":"这个就是RPO指标决定的。Recovery Point Objective. 如果是定期备份，你的RPO就是你的备份间隔时间，比如说24小时。这样的话你由可能丢失24小时的数据。\n\n如果你希望RPO最小化，就要启用实时备份oplog的方式。MongoDB官方提供OpsManager可以实现，数据可以恢复到故障之前一分钟。\n\n然后，一般需要恢复的场景不是宕机。宕机这种比较常见的场景在MongoDB里面是通过复制集来解决的。一个节点宕机不影响业务，重启就好了。 \n\n备份恢复通常是出现一些数据问题，比如说，有人删库跑路。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1581648151,"ip_address":"","comment_id":178150,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，MongoDB备份只备份某一时刻的数据。如果发生宕机时用备份进行数据恢复也只能回复到备份的那一时刻。那岂不是备完成到宕机这段时间的数据不就丢失了吗？","like_count":4,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483684,"discussion_content":"这个就是RPO指标决定的。Recovery Point Objective. 如果是定期备份，你的RPO就是你的备份间隔时间，比如说24小时。这样的话你由可能丢失24小时的数据。\n\n如果你希望RPO最小化，就要启用实时备份oplog的方式。MongoDB官方提供OpsManager可以实现，数据可以恢复到故障之前一分钟。\n\n然后，一般需要恢复的场景不是宕机。宕机这种比较常见的场景在MongoDB里面是通过复制集来解决的。一个节点宕机不影响业务，重启就好了。 \n\n备份恢复通常是出现一些数据问题，比如说，有人删库跑路。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581648151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205537,"user_name":"book尾汁","can_delete":false,"product_type":"c3","uid":1446375,"ip_address":"","ucode":"AE2B8DFC643ACC","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","comment_is_top":false,"comment_ctime":1586666236,"is_pvip":false,"replies":[{"id":77493,"content":"oplog是有幂等性的。回放的时候，t1 的数据+oplog的一条，合在一起，还是一条。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1587097277,"ip_address":"","comment_id":205537,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"mongo的全量备份的时候，如果有插入或删除数据呢，比如我在t0开始全量备份，t1时插入了一条数据，t2时备份到刚插入的数据，t3时完成备份，事后我用全量的备份数据加上期间的oplog的话，不就多插入一条数据了吗","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491506,"discussion_content":"oplog是有幂等性的。回放的时候，t1 的数据+oplog的一条，合在一起，还是一条。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587097277,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172790,"user_name":"hal","can_delete":false,"product_type":"c3","uid":1359844,"ip_address":"","ucode":"98E625F7327FD9","user_header":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","comment_is_top":false,"comment_ctime":1579313084,"is_pvip":false,"replies":[{"id":67846,"content":"集群不会丢失数据，但是你的延迟节点会出现故障，无法工作。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1580275501,"ip_address":"","comment_id":172790,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师早上好，延迟节点做备份，如果oplog时间窗口很小，延迟的时间很长，比如延迟1小时，但是oplog日志大小只有10分钟内的，这时候延迟节点是不是数据就缺失了","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481855,"discussion_content":"集群不会丢失数据，但是你的延迟节点会出现故障，无法工作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580275501,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1359844,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bf/e4/45758517.jpg","nickname":"hal","note":"","ucode":"98E625F7327FD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":155805,"discussion_content":"好的👌，谢谢老师解答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580291974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201661,"user_name":"早早凡","can_delete":false,"product_type":"c3","uid":1161584,"ip_address":"","ucode":"4AA7CAB2CAF20D","user_header":"https://static001.geekbang.org/account/avatar/00/11/b9/70/c454312c.jpg","comment_is_top":false,"comment_ctime":1585817639,"is_pvip":false,"replies":[{"id":75800,"content":"需要提供更多信息排查\n- show dbs 输出\n- dump 命令\n- restore 命令\n- restore 以后的show dbs","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1586080872,"ip_address":"","comment_id":201661,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"Dump的数据为什么比show dbs少几十倍？\n\n我有个库. show dbs 10G，dump后文件289m，restore到新服务器99m.\n\n备份和恢复中没有报错\n\n备份版本为4.0.6，恢复的版本4.2.5","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490392,"discussion_content":"需要提供更多信息排查\n- show dbs 输出\n- dump 命令\n- restore 命令\n- restore 以后的show dbs","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586080872,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173050,"user_name":"Geek_f7ecaa","can_delete":false,"product_type":"c3","uid":1476575,"ip_address":"","ucode":"0D5375FA7537D1","user_header":"","comment_is_top":false,"comment_ctime":1579417682,"is_pvip":false,"replies":[{"id":67150,"content":"有影响。延迟节点是一个数据节点，会响应writeConcern。只不过它一定要过了slaveDelay的时间段才会写数据，响应。所以如果你在一个3节点复制集群使用writeConcern:3 ，其中有一个是延迟30分钟的话，你可能要等30分钟才能返回。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579477851,"ip_address":"","comment_id":173050,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"复制延迟节点对Write Concern有没有影响，W&gt;1的情况，是等从节点拿到oplog就返回，还是需要等从节点执行完成才返回呢？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481940,"discussion_content":"有影响。延迟节点是一个数据节点，会响应writeConcern。只不过它一定要过了slaveDelay的时间段才会写数据，响应。所以如果你在一个3节点复制集群使用writeConcern:3 ，其中有一个是延迟30分钟的话，你可能要等30分钟才能返回。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579477851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386477,"user_name":"陆美芳","can_delete":false,"product_type":"c3","uid":2084000,"ip_address":"广东","ucode":"8C3F5FB3A8B3DA","user_header":"https://static001.geekbang.org/account/avatar/00/1f/cc/a0/bd31d495.jpg","comment_is_top":false,"comment_ctime":1704931199,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"目前遇到的问题是，机房断电导致容器启动不了，有关日志 {&quot;t&quot;:{&quot;$date&quot;:&quot;2024-01-10T06:59:49.076+00:00&quot;},&quot;s&quot;:&quot;F&quot;,  &quot;c&quot;:&quot;ASSERT&quot;,   &quot;id&quot;:23089,   &quot;ctx&quot;:&quot;initandlisten&quot;,&quot;msg&quot;:&quot;Fatal assertion&quot;,&quot;attr&quot;:{&quot;msgid&quot;:50853,&quot;file&quot;:&quot;src&#47;mongo&#47;db&#47;storage&#47;wiredtiger&#47;wiredtiger_util.cpp&quot;,&quot;line&quot;:652}}\n{&quot;t&quot;:{&quot;$date&quot;:&quot;2024-01-10T06:59:49.076+00:00&quot;},&quot;s&quot;:&quot;F&quot;,  &quot;c&quot;:&quot;ASSERT&quot;,   &quot;id&quot;:23090,   &quot;ctx&quot;:&quot;initandlisten&quot;,&quot;msg&quot;:&quot;\\n\\n***aborting after fassert() failure\\n\\n&quot;}\n{&quot;t&quot;:{&quot;$date&quot;:&quot;2024-01-10T06:59:49.076+00:00&quot;},&quot;s&quot;:&quot;F&quot;,  &quot;c&quot;:&quot;CONTROL&quot;,  &quot;id&quot;:6384300, &quot;ctx&quot;:&quot;initandlisten&quot;,&quot;msg&quot;:&quot;Writing fatal message&quot;,&quot;attr&quot;:{&quot;message&quot;:&quot;Got signal: 6 (Aborted).\\n&quot;}}\n最快的解决方案是什么呢？好久没管mongodb了，又生疏了","like_count":0},{"had_liked":false,"id":349321,"user_name":"Tzen","can_delete":false,"product_type":"c3","uid":1270838,"ip_address":"","ucode":"341F08152EFC0C","user_header":"https://static001.geekbang.org/account/avatar/00/13/64/36/f14efbe7.jpg","comment_is_top":false,"comment_ctime":1655886006,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，能不能将一下分片集群的备份方案","like_count":0},{"had_liked":false,"id":346946,"user_name":"Geek_c4e8a7","can_delete":false,"product_type":"c3","uid":2718664,"ip_address":"","ucode":"B8B7F6C3D77360","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/BD5O3DV5ZDuL8tGIVicPB99tLjE1MyKoudWjI0OGhUCTPYQ4KWpgC7BmbFwBJ7lK8nMaSicWDbtUYBBsfLpZwXjQ/132","comment_is_top":false,"comment_ctime":1653555004,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师 Mogodb 分片集群备份（对所有分片备份）    怎么保证每个分片 数据的一致性（即在同一时刻）","like_count":0},{"had_liked":false,"id":307858,"user_name":"黄继立","can_delete":false,"product_type":"c3","uid":1201686,"ip_address":"","ucode":"18948D6458E719","user_header":"https://static001.geekbang.org/account/avatar/00/12/56/16/f8b22bf5.jpg","comment_is_top":false,"comment_ctime":1629284900,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，mongodb分片集群如何做到一致性备份呀？","like_count":0},{"had_liked":false,"id":284529,"user_name":"CPP","can_delete":false,"product_type":"c3","uid":1074165,"ip_address":"","ucode":"2313F6BD693F48","user_header":"https://static001.geekbang.org/account/avatar/00/10/63/f5/9c7ef5ce.jpg","comment_is_top":false,"comment_ctime":1616320286,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"Linux下安装了一个4.4.4的版本，发现没有dump，这是怎么回事呢","like_count":0},{"had_liked":false,"id":282259,"user_name":"玖月","can_delete":false,"product_type":"c3","uid":2367247,"ip_address":"","ucode":"427737A95CAE0C","user_header":"https://static001.geekbang.org/account/avatar/00/24/1f/0f/4fe3788e.jpg","comment_is_top":false,"comment_ctime":1615175190,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"唐老师，你好！请教您几个问题：\n1、mongodb 在实现增量备份时，会增加 --query 参数来确定备份时间范围，开始时间好获取只要小于等于上个全量备份时间戳（可以获取到）即可，结束的时间自定义，如果备份增量数据太多，或者备份过程有大量数据写入会出现什么异常？\n2、增量备份时的时间范围应该如何设置才合理，是一天一次增量备份，还是一天分几次增量备份好？\n3、增量备份是采用 mongodump --host 127.0.0.1 -d local -c oplog.rs --query ..... 还是采用 mongodump -h 127.0.0.1:27017 --oplog --query ..... 呢？\n还请老师不吝赐教，谢谢！","like_count":0},{"had_liked":false,"id":276669,"user_name":"流转的时光","can_delete":false,"product_type":"c3","uid":2408889,"ip_address":"","ucode":"26B743CC217954","user_header":"https://static001.geekbang.org/account/avatar/00/24/c1/b9/0d3e01d3.jpg","comment_is_top":false,"comment_ctime":1612073192,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"老师请问下mongos集群每个shard分片和config server如何在一次全备之后，实时备份oplog文件？","like_count":0},{"had_liked":false,"id":194216,"user_name":"冷脚","can_delete":false,"product_type":"c3","uid":1101601,"ip_address":"","ucode":"C693E75F417D3C","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/21/87888b61.jpg","comment_is_top":false,"comment_ctime":1585038155,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"主节点的 oplog 时间窗t应满足：t &gt;= 延迟时间 + 48小时，老师，这个怎么理解，看你视频里没有讲，但是PPT里有","like_count":0}]}