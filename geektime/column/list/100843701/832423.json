{"id":832423,"title":"03ï½œå•æœºååä¼˜åŒ–ï¼ˆä¸€ï¼‰ï¼šæ— éœ€ç¡¬ä»¶å‡çº§ä¹Ÿèƒ½æå‡åå","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¾é€¸ã€‚</p><p>é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬äº†è§£äº†æ€§èƒ½ä¼˜åŒ–çš„æµç¨‹å’ŒGolangæ€§èƒ½ä¼˜åŒ–å·¥å…·ã€‚</p><p>è¿™èŠ‚è¯¾å¼€å§‹æˆ‘å°†å¸¦ä½ æŒæ¡å·¥ä½œä¸­å¸¸è§çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼Œè¿™ä¹Ÿæ˜¯æœåŠ¡æ€§èƒ½ä¼˜åŒ–æµç¨‹ç¬¬å››æ­¥â€”â€”æ€§èƒ½è°ƒä¼˜çš„åŸºç¡€ã€‚åªæœ‰æŒæ¡äº†ä¸€å®šçš„æŠ€å·§ï¼Œå½“æˆ‘ä»¬å®šä½åˆ°ç“¶é¢ˆåŸå› æ—¶ï¼Œæ‰èƒ½æ›´å¿«åœ°æƒ³å‡ºæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼Œè½»æ¾åº”å¯¹å¸¸è§çš„æ€§èƒ½é—®é¢˜ã€‚</p><p>åœ¨ä»‹ç»å…·ä½“çš„ä¼˜åŒ–æŠ€å·§ä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬æƒ³ä¸€æƒ³ï¼Œå½“ä½ éœ€è¦æå‡å•æœºååæ—¶ï¼Œä½ ä¼šæ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬é€šå¸¸çš„æ€è·¯æ˜¯å®šä½åˆ°å•æœºç“¶é¢ˆèµ„æºã€‚å¯¹äºç“¶é¢ˆèµ„æºæœ‰ä¸¤ç§å¤„ç†æ–¹æ³•ï¼Œä¸€æ˜¯å¢åŠ èµ„æºï¼Œæ¯”å¦‚æå‡å•æœºCPUã€å†…å­˜ç­‰èµ„æºçš„è§„æ ¼ï¼›äºŒæ˜¯å‡å°‘å•ä¸ªè¯·æ±‚å¯¹ç“¶é¢ˆèµ„æºçš„æ¶ˆè€—ï¼Œè®©ç›¸åŒçš„èµ„æºå¯ä»¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚</p><p>åœ¨æœåŠ¡å™¨æ•°ç›®æ¯”è¾ƒå¤šæ—¶ï¼Œéœ€è¦å¢åŠ å¾ˆå¤šæœºå™¨æˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»Šå¤©å°±æ¥çœ‹çœ‹ä¸æå‡å•æœºCPUå’Œå†…å­˜è§„æ ¼çš„å‰æä¸‹ï¼Œæœ‰å“ªäº›å¸¸ç”¨çš„é«˜æ€§èƒ½æŠ€å·§ã€‚å› ä¸ºåœ¨Golangé‡Œå®¹å™¨ç±»å‹æ¯”è¾ƒå¸¸ç”¨ï¼Œæ‰€ä»¥åé¢è¯¾ç¨‹é‡Œæˆ‘ä»¬å°±æŠŠå®ƒä½œä¸ºç ”ç©¶å¯¹è±¡ã€‚</p><h2>å®éªŒè®¾è®¡</h2><p>ä¸ºäº†æ¨¡æ‹Ÿçº¿ä¸Šçš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ã€‚æˆ‘ä»¬å…ˆæ„é€ ä¸€ä¸ªhttpæœåŠ¡ã€‚è¿™ä¸ªæœåŠ¡åŒ…å«ä¸€ä¸ªè¯·æ±‚å¤„ç†æ–¹æ³•Handlerã€‚æ–¹æ³•é‡Œæœ‰ä¸¤ä¸ªé€»è¾‘ï¼Œä¸€ä¸ªæ˜¯å¾ªç¯å¾€åˆ‡ç‰‡appendæ•°æ®ï¼Œå¦ä¸€ä¸ªæ˜¯ç”¨mapç±»å‹æ„é€ ä¸€ä¸ªé›†åˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åŸºäºè¿™ä¸ªæ¥å£çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼Œå¸¦ä½ å­¦ä¹ ä¸€äº›å®ç”¨çš„é«˜æ€§èƒ½æŠ€å·§ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-go\">package main\n\nimport (\n    \"fmt\"\n    \"net/http\"\n    _ \"net/http/pprof\"\n)\n\nfunc Handler(w http.ResponseWriter, r *http.Request) {\n    slices := getRawSlices()\n    getRawSet(slices)\n    // è®¾ç½®å“åº”å¤´ï¼Œè¿™é‡Œè®¾ç½®Content-Typeä¸ºtext/plainï¼Œè¡¨ç¤ºè¿”å›çº¯æ–‡æœ¬å†…å®¹\n    w.Header().Set(\"Content-Type\", \"text/plain\")\n    // å‘å®¢æˆ·ç«¯å†™å…¥å“åº”å†…å®¹\n    fmt.Fprintln(w, \"hh\")\n}\nfunc main() {\n    // æ³¨å†Œè·¯ç”±ï¼Œå½“å®¢æˆ·ç«¯è®¿é—®æ ¹è·¯å¾„\"/\"æ—¶ï¼Œä¼šè°ƒç”¨Handlerå‡½æ•°è¿›è¡Œå¤„ç†\n    http.HandleFunc(\"/\", Handler)\n    err := http.ListenAndServe(\":8888\", nil)\n    if err != nil {\n        panic(err)\n    }\n}\n\n// getRawSlices å¾ªç¯å¾€åˆ‡ç‰‡appendæ•°æ®\nfunc getRawSlices() []int {\n    n := 10000\n    slices := make([]int, 0)\n    for i := 0; i &lt; n; i++ {\n        slices = append(slices, i)\n    }\n    return slices\n}\n\n// æ„é€ é›†åˆ\nfunc getRawSet(slices []int) map[int]bool {\n    set := make(map[int]bool, 0)\n    for _, item := range slices {\n        set[item] = true\n    }\n    return set\n}\n</code></pre><p>ç°åœ¨è®©æˆ‘ä»¬ç”¨abå·¥å…·ï¼ˆApache Benchï¼‰æ¨¡æ‹Ÿçº¿ä¸Šç”¨æˆ·ï¼Œå¯¹è¿™ä¸ªhttpæœåŠ¡å‘èµ·è¯·æ±‚å‹æµ‹ã€‚</p><pre><code class=\"language-shell\">-n è¯·æ±‚æ•°é‡ \n-c å¹¶å‘æ•°é‡\nab -n 30000 -c 2 http://127.0.0.1:8888/\n</code></pre><p>å‡å¦‚åœ¨abå·¥å…·å‹æµ‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°å†…å­˜èµ„æºå ç”¨æ¯”è¾ƒé«˜ï¼Œå¯ä»¥ç”¨<a href=\"https://time.geekbang.org/column/article/831211\">ä¸ŠèŠ‚è¯¾</a>å­¦ä¹ åˆ°çš„pprofå·¥å…·ï¼Œé‡‡é›†å•æœºå†…å­˜æ€§èƒ½æŠ¥å‘Šå¹¶ç”Ÿæˆä¸‹é¢çš„å†…å­˜ç«ç„°å›¾ã€‚</p><pre><code class=\"language-shell\">curl \"http://127.0.0.1:8888/debug/pprof/heap?seconds=30\" &gt; heap.pprof\n\ngo tool pprof -http :8889 heap.pprof\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/5f/1a/5f125ecec3f413f7959b6432dfb08c1a.jpg?wh=2902x628\" alt=\"\" title=\"å›¾1 åŸå§‹å‡½æ•°å†…å­˜ç«ç„°å›¾\"></p><p>ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨åº”ç”¨å†…éƒ¨çš„å¤„ç†é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯Handleræ–¹æ³•é‡Œï¼ŒgetRawSetå‡½æ•°æ˜¯å†…å­˜æ¶ˆè€—æœ€å¤§çš„å‡½æ•°ã€‚æ¥ç€ï¼Œæˆ‘ä»¬ç‚¹å‡»ç«ç„°å›¾çš„æœ€åä¸€è¡Œè¿›å…¥getRawSetå‡½æ•°å†…éƒ¨æŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å›¾ï¼Œæ¶ˆè€—å†…å­˜èµ„æºçš„çƒ­ç‚¹ä»£ç æ˜¯mapèµ‹å€¼è¿™è¡Œä»£ç ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/06/30/0625f65ce35d116708e5754d26158a30.jpg?wh=1538x820\" alt=\"\" title=\"å›¾2 å†…å­˜åˆ†é…çƒ­ç‚¹ä»£ç \"></p><p>ç»“åˆè¿™è¡Œä»£ç çš„ä¸Šä¸‹æ–‡ï¼Œå¯çŸ¥è¿™æ®µä»£ç é€»è¾‘çš„ç›®çš„æ˜¯ç”¨mapæ„é€ ä¸€ä¸ªé›†åˆã€‚é‚£è¿™é‡Œé¢æœ‰æ²¡æœ‰ä»€ä¹ˆä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªæ–¹å‘å¯»æ‰¾ç­”æ¡ˆï¼š</p><ul>\n<li>\n<p>å…ˆè€ƒè™‘å­˜å…¥mapçš„æ•°æ®èƒ½ä¸èƒ½å°½é‡å°‘ã€‚</p>\n</li>\n<li>\n<p>é™¤äº†æˆ‘ä»¬å­˜å…¥çš„æ•°æ®ä¹‹å¤–ï¼Œmapèµ‹å€¼æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ï¼Œé‡Œé¢æ˜¯å¦å­˜åœ¨è€—å†…å­˜çš„åŠ¨ä½œï¼Œæœ‰çš„è¯èƒ½å¦å‡å°‘ç”šè‡³è§„é¿æ‰ï¼Ÿ</p>\n</li>\n</ul><p>å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªæ–¹å‘ã€‚</p><h2>ç©ºç»“æ„ä½“ï¼šé›†åˆè¡¨ç¤ºå¦‚ä½•çœå†…å­˜ï¼Ÿ</h2><p>ä»é›†åˆçš„ä½¿ç”¨åœºæ™¯æ¥çœ‹ï¼Œæˆ‘ä»¬è¦ä¹ˆåˆ¤æ–­ä¸€ä¸ªkeyæ˜¯ä¸æ˜¯åœ¨mapä¸­ï¼Œè¦ä¹ˆè·å–mapé‡Œé¢çš„æ‰€æœ‰keyï¼Œè€Œmapé‡Œé¢çš„valueå€¼ï¼Œåœ¨é›†åˆçš„ä½¿ç”¨åœºæ™¯ä¸­å¹¶ä¸éœ€è¦ã€‚é‚£æœ‰æ²¡æœ‰åŠæ³•æ¶ˆé™¤mapé‡Œé¢çš„valueæ‰€å çš„å†…å­˜ç©ºé—´å‘¢ï¼Ÿ</p><p><strong>åœ¨ Go è¯­è¨€é‡Œï¼Œæä¾›äº†ç©ºç»“æ„ä½“ç±»å‹struct{}ï¼Œè€Œç©ºç»“æ„ä½“å¯¹è±¡æ‰€å çš„ç©ºé—´å¤§å°ä¸º0</strong>ã€‚å’±ä»¬å¯ä»¥å†™ä¸ªå°æµ‹è¯•æ¥çœ‹çœ‹ï¼š</p><pre><code class=\"language-go\">func TestSize(t *testing.T) {\n    fmt.Printf(\"struct {} size: %d byte\\n\", unsafe.Sizeof(struct{}{}))\n}\n</code></pre><p>è¿è¡Œè¿™ä¸ªæµ‹è¯•å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°ç©ºç»“æ„ä½“ç±»å‹çš„ç¡®ä¸å å†…å­˜ç©ºé—´ã€‚</p><pre><code class=\"language-shell\">=== RUN   TestSize\nstruct {} size: 0 byte\n</code></pre><p>å› æ­¤å’±ä»¬å¯ä»¥æŠŠmapçš„valueç±»å‹ï¼Œä»boolç±»å‹æ”¹ä¸ºç©ºç»“æ„ä½“ç±»å‹ï¼Œå°±åƒä¸‹é¢çš„ä»£ç ä¸€æ ·ã€‚</p><pre><code class=\"language-go\">// valueç”¨ç©ºç»“æ„ä½“ç±»å‹\nfunc getEmptyStructSet(slices []int) map[int]struct{} {\n    set := make(map[int]struct{}, 0)\n    for _, item := range slices {\n        set[item] = struct{}{}\n    }\n    return set\n}\n</code></pre><p>é‚£ä¹ˆä½¿ç”¨ç©ºç»“æ„ä½“ç±»å‹ï¼Œèƒ½ç»™æˆ‘ä»¬å¸¦æ¥å¤šå¤§çš„æ€§èƒ½æå‡å‘¢ï¼Ÿæˆ‘ä»¬ç”¨ Benchmark æ¥æµ‹ä¸€æµ‹ã€‚Benchmarkè„šæœ¬å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-go\">var slices []int\n\nfunc init() {\n    slices = getRawSlices()\n}\n\nfunc BenchmarkGetRawSet(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        getRawSet(slices)\n    }\n}\n\nfunc BenchmarkGetEmptyStructSet(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        getEmptyStructSet(slices)\n    }\n}\n</code></pre><p>æµ‹è¯•ç»“æœå‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>valueç”¨ç©ºç»“æ„ä½“ç±»å‹ï¼Œæ€§èƒ½æœ‰äº†ä¸€å®šç¨‹åº¦çš„æå‡</strong>ã€‚ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œvalueç”¨boolç±»å‹ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦427596å­—èŠ‚å†…å­˜ï¼Œè€Œç”¨ç©ºç»“æ„ä½“ç±»å‹ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦389449å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 9% å·¦å³çš„å†…å­˜èµ„æºã€‚</p><pre><code class=\"language-shell\">killianxu@KILLIANXU-MB0 3 % go test -bench='.' -benchmem -benchtime=10s\nwarning: GOPATH set to GOROOT (/usr/local/go) has no effect\ngoos: darwin\ngoarch: amd64\npkg: server-go/3\ncpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz\nBenchmarkGetRawSet-4               17214            608437 ns/op          427596 B/op        319 allocs/op\nBenchmarkGetEmptyStructSet-4       19430            563814 ns/op          389449 B/op        255 allocs/op\n</code></pre><p>ç°åœ¨è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹å†…å­˜ç«ç„°å›¾ï¼Œçœ‹çœ‹ç»è¿‡ç©ºç»“æ„ä½“ç±»å‹çš„ä¼˜åŒ–åï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/2a/yy/2ae951758abb784f769082bf168fc1yy.jpg?wh=2886x728\" alt=\"\" title=\"å›¾3 ç©ºç»“æ„ä½“ä¼˜åŒ–åå†…å­˜ç«ç„°å›¾\"></p><p>ä»ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨ç©ºç»“æ„ä½“ä¼˜åŒ–åï¼Œæ„é€ é›†åˆçš„getEmptyStructSetå‡½æ•°ï¼Œä¾ç„¶æ˜¯æœ€æ¶ˆè€—å†…å­˜çš„å‡½æ•°ã€‚</p><p>å‰é¢æˆ‘æåˆ°å¯ä»¥ä»ä¸¤ä¸ªæ–¹å‘æ‰¾ç­”æ¡ˆï¼Œå¹¶ä¸”é€šè¿‡å°†valueçš„ç±»å‹ï¼Œä»boolæ”¹ä¸ºç©ºç»“æ„ä½“ï¼Œå‡å°‘äº†å­˜å…¥mapçš„æ•°æ®å¤§å°ã€‚ä¸ºäº†ç»§ç»­é™ä½mapçš„å†…å­˜èµ„æºæ¶ˆè€—ï¼Œç°åœ¨è®©æˆ‘ä»¬ä»ç¬¬äºŒä¸ªæ–¹å‘â€”â€”mapèµ‹å€¼æ“ä½œçš„æ–¹å‘æ‰¾ç­”æ¡ˆã€‚</p><h2>æŒ‡å®šå®¹é‡ï¼šå®¹å™¨æ“ä½œå¦‚ä½•é¿å…æ‰©å®¹è¿ç§»ï¼Ÿ</h2><p>åœ¨ææ˜ç™½mapèµ‹å€¼æ“ä½œçš„é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£mapçš„æ•°æ®ç»“æ„ã€‚å°±åƒä¸‹é¢çš„å›¾å±•ç¤ºçš„ä¸€æ ·ï¼Œ<strong>mapåº•å±‚å…¶å®æ˜¯ä»¥æ•°ç»„+é“¾è¡¨çš„æ•°æ®ç»“æ„å­˜å‚¨key-valueå¯¹çš„</strong>ã€‚ä¸ºäº†æè¿°æ–¹ä¾¿ï¼Œæ•°ç»„çš„æ¯ä¸€ä¸ªä½ç½®ï¼Œé€šå¸¸æˆ‘ä»¬ç§°å®ƒä¸ºæ¡¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/43/e8/4358fc1588d7ece96fb69b03547665e8.jpg?wh=1714x903\" alt=\"\" title=\"å›¾4 map å†…éƒ¨æ•°æ®ç»“æ„\"></p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“å¾€mapä¸­å†™å…¥ket-valueå¯¹æ—¶ï¼ŒGoåº•å±‚ä¼šæ ¹æ®keyåšhashï¼Œå®šä½åˆ°éœ€è¦å†™å…¥key-valueå¯¹çš„æ¡¶ï¼Œå¹¶æ’å…¥æ¡¶å¯¹åº”çš„é“¾è¡¨ä¸­ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/bb/2b/bbb0bf899974264b2505ae93441bca2b.jpg?wh=2584x884\" alt=\"\" title=\"å›¾5 map å†™å…¥æ“ä½œ\"></p><p>ä½†æ˜¯å½“mapé‡Œé¢å†™å…¥çš„æ•°æ®è¿‡å¤šæ—¶ï¼Œæ•°ç»„é‡Œé¢çš„æ¡¶é“¾è¡¨ä¼šè¶Šæ¥è¶Šé•¿ã€‚è€Œmapçš„å†™å…¥å’Œè¯»å–ï¼Œéƒ½éœ€è¦éå†æ¡¶é“¾è¡¨ï¼Œå› æ­¤è¿‡é•¿çš„æ¡¶é“¾è¡¨ä¼šå½±å“mapçš„è¯»å†™æ€§èƒ½ã€‚</p><p>ä¸ºäº†ç¼“è§£è¿™ç§æƒ…å†µï¼Œåœ¨å¾€mapå†™å…¥æ•°æ®æ—¶ï¼Œå¦‚æœmapä¸­çš„æ•°æ®é‡å·²ç»æ¯”è¾ƒå¤šäº†ï¼ŒGoåº•å±‚è¿˜æœ‰ä¸ªæ‰©å®¹è¿å¾™çš„åˆ†æ”¯é€»è¾‘ï¼Œè¿™ä¸ªæ‰©å®¹è¿ç§»çš„åˆ†æ”¯é€»è¾‘æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><p>æ‰©å®¹è¿ç§»çš„é€»è¾‘åˆ†æˆ2æ­¥ï¼Œæˆ‘ä»¬ç»“åˆåé¢è¿™å¼ å›¾æ¥ç†è§£æ›´ç›´è§‚ä¸€äº›ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/c5/28/c5ba996164c294003e7118ff83875a28.jpg?wh=2774x1978\" alt=\"\" title=\"å›¾6 map å†™å…¥è§¦å‘æ‰©å®¹è¿ç§»\"></p><p>é¦–å…ˆ<strong>ç”³è¯·æ›´å¤§çš„æ•°ç»„ç©ºé—´ã€‚</strong></p><p>ç„¶åå°†æ—§æ•°ç»„ç©ºé—´æ•°æ®è¿ç§»åˆ°æ–°æ•°ç»„ç©ºé—´ã€‚<strong>Goé‡‡å–äº†æ¸è¿›å¼hashçš„æ€æƒ³ï¼Œæ¯æ¬¡å¾€mapå†™å…¥æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ä»æ—§æ•°ç»„ç©ºé—´å¾€æ–°æ•°ç»„ç©ºé—´è¿ç§»ä¸¤ä¸ªæ¡¶é“¾è¡¨æ•°æ®ï¼Œä»è€Œé¿å…ä¸€æ¬¡è¿ç§»å…¨é‡æ•°æ®å¯¼è‡´mapå†™è¯·æ±‚å»¶æ—¶æŠ–åŠ¨ï¼Œç›´åˆ°æ—§æ•°ç»„ç©ºé—´çš„æ‰€æœ‰æ¡¶é“¾è¡¨è¿ç§»å®Œä¸ºæ­¢ã€‚</strong></p><p>è™½ç„¶é€šè¿‡æ‰©å®¹è¿ç§»ï¼Œå°†åŸå…ˆåœ¨åŒä¸€ä¸ªæ¡¶é“¾è¡¨é‡Œçš„æ•°æ®ï¼Œé‡æ–°hashåˆ°æ–°æ•°ç»„ä¸åŒçš„æ¡¶é“¾è¡¨ä¸­ï¼Œå¯ä»¥å‡å°‘æ¡¶é“¾è¡¨é•¿åº¦ï¼Œé¿å…mapè¯»å†™æ€§èƒ½å¤§å¹…åº¦è£‚åŒ–ã€‚ä½†æ˜¯æ‰©å®¹è¿ç§»å±äºæ¶ˆè€—å†…å­˜å’ŒCPUèµ„æºçš„æ“ä½œï¼Œå¦‚æœå¾ªç¯å¾€mapå†™å…¥ï¼Œå¯èƒ½ä¼šè§¦å‘å¤šæ¬¡æ‰©å®¹è¿ç§»ï¼Œæ¶ˆè€—å¤§é‡å†…å­˜å’ŒCPUèµ„æºã€‚</p><p>é‚£æœ‰æ²¡æœ‰åŠæ³•é¿å…å†™å…¥è¿‡ç¨‹è§¦å‘æ‰©å®¹è¿ç§»å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œ<strong>åˆ›å»ºmapçš„makeå‡½æ•°æä¾›äº†ä¸€ä¸ªsizeå‚æ•°ã€‚Goåº•å±‚åœ¨åˆ›å»ºmapå¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„sizeå‚æ•°ç”³è¯·æ•°ç»„ç©ºé—´ã€‚å› æ­¤åªè¦æˆ‘ä»¬èƒ½æå‰çŸ¥é“mapè¦å­˜å‚¨çš„æ•°æ®é‡ï¼Œå°±èƒ½ä¼ å…¥è¿™ä¸ªsizeå‚æ•°ï¼Œä»è€Œé¿å…å†™å…¥è¿‡ç¨‹é¢‘ç¹æ‰©å®¹ã€‚</strong></p><p>å°±åƒä¸‹é¢çš„ä»£ç ä¸€æ ·ï¼Œç”±äºæˆ‘ä»¬çš„åˆ‡ç‰‡é‡Œæ²¡æœ‰é‡å¤æ•°æ®ï¼Œå› æ­¤å½“æˆ‘ä»¬ç”¨makeå‡½æ•°æ„é€ mapæ—¶ï¼Œå¯ä»¥å°†åˆ‡ç‰‡é•¿åº¦ä½œä¸ºsizeå‚æ•°ä¼ å…¥ã€‚</p><pre><code class=\"language-go\">// æå‰æŒ‡å®šå®¹é‡\nfunc getCapacitySet(slices []int) map[int]struct{} {\n    set := make(map[int]struct{}, len(slices))\n    for _, item := range slices {\n        set[item] = struct{}{}\n    }\n    return set\n}\n</code></pre><p>é‚£ä¹ˆæ„é€ mapæ—¶ï¼ŒæŒ‡å®šsizeçš„æ–¹å¼ï¼Œåˆèƒ½ç»™å’±ä»¬å¸¦æ¥å¤šå¤§çš„æ€§èƒ½æå‡å‘¢ï¼Ÿå’±ä»¬ç»§ç»­ç”¨Benchmarkæ¥æµ‹ä¸€æµ‹ã€‚</p><p>ä¸‹é¢æ˜¯Benchmarkè„šæœ¬ï¼š</p><pre><code class=\"language-go\">func BenchmarkGetEmptyStructSet(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        getEmptyStructSet(slices)\n    }\n}\n\nfunc BenchmarkGetCapacitySet(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        getCapacitySet(slices)\n    }\n}\n</code></pre><p>ç„¶åä½ ä¼šå‘ç°ï¼Œ<strong>æŒ‡å®šmapå®¹é‡çš„æ–¹å¼ï¼Œæ€§èƒ½æå‡å¾ˆæ˜æ˜¾ã€‚</strong>æˆ‘ä»¬ä¾ç„¶ç”¨æ•°æ®è¯´è¯ã€‚</p><pre><code class=\"language-shell\">killianxu@KILLIANXU-MB0 3 % go test -bench='.' -benchmem -benchtime=10s   \nwarning: GOPATH set to GOROOT (/usr/local/go) has no effect\ngoos: darwin\ngoarch: amd64\npkg: server-go/3\ncpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz\nBenchmarkGetEmptyStructSet-4       21218            563814 ns/op          389461 B/op        255 allocs/op\nBenchmarkGetCapacitySet-4          41742            287038 ns/op          182480 B/op         11 allocs/op\n</code></pre><ul>\n<li>ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œä¸æŒ‡å®šmapå®¹é‡çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦389461å­—èŠ‚å†…å­˜ï¼Œè€ŒæŒ‡å®šå®¹é‡çš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦182480å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 53% å·¦å³çš„å†…å­˜èµ„æºã€‚</li>\n<li>ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œä¸æŒ‡å®šmapå®¹é‡çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦563814nsï¼Œè€ŒæŒ‡å®šå®¹é‡çš„æ–¹å¼åªè¦287038nsï¼ŒèŠ‚çº¦äº† 49% å·¦å³çš„ CPU èµ„æºã€‚</li>\n</ul><p>ç°åœ¨è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹å†…å­˜ç«ç„°å›¾ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„ä»£ç æ˜¯å¦è¿˜æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–ç©ºé—´ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b0/77/b0daf4f8a700d8010ea20feebda95277.jpg?wh=2908x558\" alt=\"\" title=\"å›¾7 æŒ‡å®š map å®¹é‡ä¼˜åŒ–åçš„ç«ç„°å›¾\"></p><p>ä»å†…å­˜ç«ç„°å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œé™¤äº†å·²ç»ä¼˜åŒ–åçš„é›†åˆæ„é€ å‡½æ•°getCapacitySetï¼Œç°åœ¨æœ€æ¶ˆè€—å†…å­˜çš„æ˜¯åˆ‡ç‰‡ç”Ÿæˆå‡½æ•°getRawSliceã€‚</p><p>ç°åœ¨æˆ‘ä»¬ä»ç«ç„°å›¾è¿›å…¥getRawSliceå‡½æ•°å†…éƒ¨ï¼Œå°±ä¼šçœ‹åˆ°ä¸‹é¢çš„å›¾ï¼Œæ¶ˆè€—å†…å­˜èµ„æºçš„çƒ­ç‚¹ä»£ç æ˜¯åˆ‡ç‰‡appendè¿™è¡Œä»£ç ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/7b/28/7b6bc457b5fff6afe4af0b4a654b9828.jpg?wh=1688x717\" alt=\"\" title=\"å›¾8 getRawSlice å‡½æ•°å†…éƒ¨çƒ­ç‚¹ä»£ç \"></p><p>ç»“åˆè¿™è¡Œä»£ç çš„ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥çŸ¥é“è¿™æ®µä»£ç é€»è¾‘æ˜¯åœ¨å¾ªç¯åœ°å¾€åˆ‡ç‰‡é‡Œé¢åšappendæ“ä½œã€‚é‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶ä¼šæƒ³åˆ°ï¼Œå¯ä»¥å»çœ‹çœ‹åˆ‡ç‰‡çš„appendæ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ï¼Œè¿™é‡Œé¢æœ‰æ²¡æœ‰å•¥ä¼˜åŒ–ç©ºé—´å‘¢ï¼Ÿ</p><p><strong>åˆ‡ç‰‡åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”¨ä¸€ä¸ªæ•°ç»„å­˜å‚¨æ•°æ®çš„</strong>ï¼Œé€šå¸¸è¿›è¡Œappendæ“ä½œæ—¶ï¼Œä¼šå¾€æ•°ç»„æœ«å°¾æ’å…¥æ•°æ®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d7/7b/d7cdc766f5b62ab9e1b6efa14488f97b.jpg?wh=1165x654\" alt=\"\" title=\"å›¾9 append æ“ä½œ\"></p><p>ä½†æ˜¯å½“<strong>æ•°ç»„ç©ºé—´ä¸å¤Ÿæ—¶ï¼Œappendæ“ä½œä¼šè§¦å‘æ‰©å®¹è¿ç§»ï¼Œç”³è¯·æ›´å¤§çš„æ•°ç»„ç©ºé—´ï¼Œå¹¶å°†æ—§æ•°ç»„æ•°æ®æ‹·è´åˆ°æ–°æ•°ç»„ï¼Œä»¥ä¾¿å­˜æ”¾æ›´å¤šçš„æ•°æ®</strong>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/53/8b/53d702086c76a117e8a96fc907cb918b.jpg?wh=1552x886\" alt=\"\" title=\"å›¾10 append è§¦å‘æ‰©å®¹\"></p><p>æˆ‘ä»¬ä»æ‰©å®¹è¿ç§»çš„è¿‡ç¨‹å¯ä»¥çœ‹å‡ºæ¥ï¼Œ<strong>æ‰©å®¹è¿ç§»å­˜åœ¨å†…å­˜åˆ†é…å’Œæ•°æ®æ‹·è´æ“ä½œï¼Œéœ€è¦æ¶ˆè€—å†…å­˜å’ŒCPUèµ„æº</strong>ã€‚å½“å¾ªç¯åšåˆ‡ç‰‡appendæ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šè§¦å‘é¢‘ç¹æ‰©å®¹è¿ç§»ï¼Œæ¶ˆè€—å¤§é‡çš„å†…å­˜å’ŒCPUèµ„æºã€‚</p><p>é‚£åˆ‡ç‰‡appendæ“ä½œæœ‰æ²¡æœ‰åŠæ³•é¿å…æ‰©å®¹è¿ç§»å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œå’Œmapä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºåˆ‡ç‰‡å¯¹è±¡æ—¶ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥å®¹é‡å­—æ®µã€‚å°±åƒä¸‹é¢çš„ä»£ç ä¸€æ ·ï¼Œè¿™æ ·åˆ‡ç‰‡å°±ä¼šä¸€æ¬¡æ€§ç”³è¯·è¶³å¤Ÿæ•°ç»„ç©ºé—´ï¼Œä»è€Œé¿å…åç»­å†™å…¥è¿‡ç¨‹å‘ç”Ÿæ‰©å®¹è¿ç§»ã€‚</p><pre><code class=\"language-go\">// getCapacitySlices æå‰æŒ‡å®šå®¹é‡\nfunc getCapacitySlices() []int {\n    n := 10000\n    slices := make([]int, 0, n)\n    for i := 0; i &lt; n; i++ {\n        slices = append(slices, i)\n    }\n    return slices\n}\n</code></pre><p>åˆ‡ç‰‡åˆ›å»ºæ—¶æŒ‡å®šå®¹é‡çš„æ–¹å¼ï¼Œåˆèƒ½ç»™å’±ä»¬å¸¦æ¥å¤šå¤§çš„æ€§èƒ½æå‡å‘¢ï¼ŸBenchmarkè„šæœ¬å¦‚ä¸‹ï¼Œæˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹ã€‚</p><pre><code class=\"language-go\">func BenchmarkGetRawSlices(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        getRawSlices()\n    }\n}\n\nfunc BenchmarkGetCapacitySlices(b *testing.B) {\n    for n := 0; n &lt; b.N; n++ {\n        getCapacitySlices()\n    }\n}\n</code></pre><p><strong>æœç„¶ï¼ŒæŒ‡å®šåˆ‡ç‰‡å®¹é‡çš„æ–¹å¼ï¼Œæ€§èƒ½æå‡éå¸¸æ˜æ˜¾ã€‚</strong></p><pre><code class=\"language-shell\">killianxu@KILLIANXU-MB0 3 % go test -bench='.' -benchmem -benchtime=10s\nwarning: GOPATH set to GOROOT (/usr/local/go) has no effect\ngoos: darwin\ngoarch: amd64\npkg: server-go/3\ncpu: Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz\nBenchmarkGetRawSlices-4           209412             55297 ns/op          357626 B/op         19 allocs/op\nBenchmarkGetCapacitySlices-4      844266             13318 ns/op           81920 B/op          1 allocs/op\n</code></pre><ul>\n<li>\n<p>ä»å†…å­˜æ¶ˆè€—æ¥çœ‹ï¼Œä¸æŒ‡å®šåˆ‡ç‰‡å®¹é‡çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦357626å­—èŠ‚å†…å­˜ï¼Œè€ŒæŒ‡å®šå®¹é‡çš„æ–¹å¼ï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åªè¦81920å­—èŠ‚å†…å­˜ï¼ŒèŠ‚çº¦äº† 77% å·¦å³çš„å†…å­˜èµ„æºã€‚</p>\n</li>\n<li>\n<p>ä» CPU èµ„æºæ¶ˆè€—æ¥çœ‹ï¼Œä¸æŒ‡å®šåˆ‡ç‰‡å®¹é‡çš„æ–¹å¼ï¼Œå•æ¬¡å‡½æ•°è°ƒç”¨è¦55297nsï¼Œè€ŒæŒ‡å®šå®¹é‡çš„æ–¹å¼ï¼Œåªè¦13318nsï¼ŒèŠ‚çº¦äº† 76% å·¦å³çš„ CPU èµ„æºã€‚</p>\n</li>\n</ul><p>è®©æˆ‘ä»¬ç”¨ç«ç„°å›¾å†çœ‹çœ‹æˆ‘ä»¬çš„å‡½æ•°æ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/93/7f/93c6521d7e75c892cd2239d86yy1287f.jpg?wh=2908x547\" alt=\"\" title=\"å›¾11 æŒ‡å®šå®¹é‡ä¼˜åŒ–åå†…å­˜ç«ç„°å›¾\"></p><p>ä»ç«ç„°å›¾ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œç»è¿‡å‰é¢å‡ æ¬¡çš„ä¼˜åŒ–ï¼Œåº”ç”¨å†…éƒ¨æœ€è€—æ—¶çš„å‡½æ•°å°±åªå‰©ä¸‹å·²ç»ä¼˜åŒ–è¿‡ä¹‹åçš„getCapacitySetå’ŒgetCapacitySliceså‡½æ•°ï¼Œæ²¡æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´äº†ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¥ä¸€æ®µå¾…ä¼˜åŒ–çš„httpæœåŠ¡æ¥å£ä¸ºä¾‹ï¼Œåœ¨é€æ­¥ä¼˜åŒ–å…¶å¯¹å†…å­˜èµ„æºçš„æ¶ˆè€—è¿‡ç¨‹ä¸­ï¼Œå‘ä½ å±•ç¤ºäº†èƒ½é™ä½å†…å­˜å’ŒCPUèµ„æºæ¶ˆè€—çš„2ä¸ªé«˜æ€§èƒ½å®¹å™¨ç±»å‹çš„ä½¿ç”¨æŠ€å·§ã€‚</p><ul>\n<li>\n<p>å½“ç”¨mapæ„é€ é›†åˆæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†valueç±»å‹è®¾ç½®ä¸ºç©ºç»“æ„ä½“ç±»å‹ï¼Œ<strong>ç©ºç»“æ„ä½“ç±»å‹ä¸å ç”¨å†…å­˜ç©ºé—´</strong>ï¼Œè¿™æ ·å°±èƒ½å¸®æˆ‘ä»¬é™ä½å†…å­˜èµ„æºæ¶ˆè€—ã€‚</p>\n</li>\n<li>\n<p>å½“åˆ›å»ºmapå’Œåˆ‡ç‰‡å¯¹è±¡æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥<strong>æå‰ç¡®å®šå®¹å™¨å®¹é‡</strong>ï¼Œå°±å¯ä»¥ä¼ å…¥makeå‡½æ•°ä¸­ï¼Œä»è€Œ<strong>é¿å…å¾€é›†åˆä¸­æ·»åŠ æ•°æ®æ—¶è§¦å‘æ‰©å®¹è¿ç§»ï¼Œè¾¾åˆ°é™ä½å†…å­˜å’ŒCPUèµ„æºæ¶ˆè€—çš„ç›®çš„</strong>ã€‚</p>\n</li>\n</ul><p>å¸Œæœ›ä½ å¥½å¥½ä½“ä¼šè¿™ä¸ªä»çº¿ä¸ŠæœåŠ¡è·å–å†…å­˜ç«ç„°å›¾å¯»æ‰¾ç“¶é¢ˆï¼Œå†ç»“åˆGoè¯­è¨€åº•å±‚å®ç°åˆ†æå¯»æ‰¾æ›´ä¼˜æ–¹æ¡ˆçš„è¿‡ç¨‹ã€‚åœ¨é‡åˆ°å†…å­˜å’ŒCPUç“¶é¢ˆæ—¶ï¼Œåˆ«å¿˜äº†å°è¯•è¿ç”¨è¿™ä¸¤ä¸ªå®¹å™¨ç±»å‹çš„ä½¿ç”¨æŠ€å·§ï¼Œå¸®ä½ èŠ‚çº¦æ›´å¤šå†…å­˜å’ŒCPUèµ„æºï¼Œæå‡å•æœºååã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å¯¹äºå®¹å™¨ç±»å‹ï¼Œé™¤äº†è¿™èŠ‚è¯¾è®²åˆ°çš„2ç§é«˜æ€§èƒ½ä½¿ç”¨æŠ€å·§ï¼Œä½ è¿˜çŸ¥é“å“ªäº›é«˜æ€§èƒ½çš„ä½¿ç”¨æŠ€å·§å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åœ¨è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":396382,"user_name":"é™ˆå§è™«","can_delete":false,"product_type":"c1","uid":1481979,"ip_address":"æµ™æ±Ÿ","ucode":"44BB84712436AB","user_header":"https://static001.geekbang.org/account/avatar/00/16/9c/fb/7fe6df5b.jpg","comment_is_top":false,"comment_ctime":1734232303,"is_pvip":false,"replies":[{"id":143912,"content":"ğŸ‘ğŸ‘ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1313417,"ctime":1734359033,"ip_address":"å¹¿ä¸œ","comment_id":396382,"utype":1}],"discussion_count":1,"race_medal":5,"score":2,"product_id":100843701,"comment_content":"å¬å®Œè€å¸ˆçš„è¯¾æŸ¥äº†ä¸€ä¸‹èµ„æ–™ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œä¸è¶³ä¹‹å¤„è¯·è€å¸ˆæŒ‡æ­£ï¼Œå®¹å™¨ç±»å‹ä¼˜åŒ–çš„å…¶å®ƒæŠ€å·§ï¼š\n1. å°½é‡é¿å…é¢‘ç¹å¯¹ map å’Œ slice çš„å¢åˆ ï¼Œè¿™ä¼šè§¦å‘åº•å±‚ç»“æ„é‡æ–°åˆ†é…\n2. å¹¶å‘åœºæ™¯ä¸‹ å‡å°‘é”äº‰ç”¨ï¼Œæ¯”å¦‚ä½¿ç”¨å¹¶å‘å®‰å…¨çš„ sync.map æˆ–è€… é€šè¿‡åˆ†ç‰‡æŠ€æœ¯å°†å¤§ map åˆ†ä¸ºå° map \n3. éœ€è¦å¤§é‡çŸ­ç”Ÿå‘½å‘¨æœŸå®¹å™¨å¯¹è±¡æ—¶ï¼Œé€šè¿‡ sync.pool å¤ç”¨å¯¹è±¡ï¼Œå‡å°‘é¢‘ç¹çš„å†…å­˜é‡æ–°åˆ†é…\n4. åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ sync.once ä¼˜åŒ–åˆå§‹åŒ–æ“ä½œï¼Œä¿è¯åªæ‰§è¡Œä¸€æ¬¡\n5. å®¹å™¨å…ƒç´ ä¸º å¤§å¯¹è±¡ æˆ–è€… å¤æ‚ç»“æ„ä½“ï¼Œä¼ é€’æŒ‡é’ˆè€Œä¸æ˜¯å€¼ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ‹·è´çš„å¼€é”€ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½œä¸ºå‡½æ•°å‚æ•°æ—¶\n6. å¯¹äºç»“æ„ä½“æ¥è¯´ï¼ŒæŒ‰ç…§å­—æ®µçš„å¤§å°é™åºæ’åˆ—ï¼Œå¯ä»¥é™ä½å†…å­˜å¯¹é½æ—¶çš„å¡«å……æµªè´¹","like_count":2,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655195,"discussion_content":"ğŸ‘ğŸ‘ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734359033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":396410,"user_name":"Geek_b9db3a","can_delete":false,"product_type":"c1","uid":2800436,"ip_address":"å¤©æ´¥","ucode":"4E6E8809384E86","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM5urtPqOYes73XMicgz1JokicicckysAtasEjibbETF34uVRN4oSOUlPUSzibicMI2rwawbJe8bscvahPjA/132","comment_is_top":false,"comment_ctime":1734330655,"is_pvip":false,"replies":[{"id":143907,"content":"æŠ¥é”™æ˜¯è§£ææ–‡ä»¶å¤±è´¥äº†ï¼Œä¸€èˆ¬æ˜¯ç”Ÿæˆçš„æ–‡ä»¶æœ‰é—®é¢˜ã€‚å¯ä»¥çœ‹ä¸‹curl &quot;http:&#47;&#47;127.0.0.1:8888&#47;debug&#47;pprof&#47;heap?seconds=30&quot; &gt; heap.pprofç”Ÿæˆçš„è¿‡ç¨‹æœ‰æ²¡æœ‰æŠ¥ä»€ä¹ˆé”™ï¼Œæ¯”å¦‚Failed to connectä¹‹ç±»çš„ï¼Œå¯¼è‡´æ–‡ä»¶å†…å®¹å­˜å‚¨çš„ä¸æ˜¯ç«ç„°å›¾ï¼Œè€Œæ˜¯æŠ¥é”™çš„æ–‡æœ¬å†…å®¹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1313417,"ctime":1734352029,"ip_address":"å¹¿ä¸œ","comment_id":396410,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100843701,"comment_content":"curl &quot;http:&#47;&#47;127.0.0.1:8888&#47;debug&#47;pprof&#47;heap?seconds=30&quot; &gt; heap.pprof\ngo tool pprof -http :8889 heap.pprof\nheap.pprof: parsing profile: unrecognized profile format\nfailed to fetch any source profiles","like_count":0,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655188,"discussion_content":"æŠ¥é”™æ˜¯è§£ææ–‡ä»¶å¤±è´¥äº†ï¼Œä¸€èˆ¬æ˜¯ç”Ÿæˆçš„æ–‡ä»¶æœ‰é—®é¢˜ã€‚å¯ä»¥çœ‹ä¸‹curl &#34;http://127.0.0.1:8888/debug/pprof/heap?seconds=30&#34; &gt; heap.pprofç”Ÿæˆçš„è¿‡ç¨‹æœ‰æ²¡æœ‰æŠ¥ä»€ä¹ˆé”™ï¼Œæ¯”å¦‚Failed to connectä¹‹ç±»çš„ï¼Œå¯¼è‡´æ–‡ä»¶å†…å®¹å­˜å‚¨çš„ä¸æ˜¯ç«ç„°å›¾ï¼Œè€Œæ˜¯æŠ¥é”™çš„æ–‡æœ¬å†…å®¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734352029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2882695,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/fc/87/d37106d5.jpg","nickname":"æµ·æ¢¦","note":"","ucode":"DA2ADE2DED464D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655362,"discussion_content":"æˆ‘ä¹Ÿæœ‰åŒæ ·çš„æŠ¥é”™ï¼Œcurl &#34;http://127.0.0.1:8888/debug/pprof/heap?seconds=30&#34; &gt; heap.pprofæ‰§è¡Œçš„æ—¶å€™æ²¡æœ‰ä»»ä½•å†…å®¹ï¼ŒæŸ¥çœ‹æ–‡ä»¶å†…å®¹StatusCode: 200ï¼Œåº”è¯¥æ²¡æŠ¥é”™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734684240,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":396397,"user_name":"å¿«å«æˆ‘å°ç™½","can_delete":false,"product_type":"c1","uid":3571201,"ip_address":"ä¸Šæµ·","ucode":"7CAD65E36601A2","user_header":"https://static001.geekbang.org/account/avatar/00/36/7e/01/1660e1e8.jpg","comment_is_top":false,"comment_ctime":1734278146,"is_pvip":false,"replies":[{"id":143916,"content":"1.benchmarkæ˜¯å¾ªç¯næ¬¡ï¼Œè¾“å‡ºçš„æ˜¯å¹³å‡æ¯æ¬¡å‡½æ•°è°ƒç”¨åˆ†é…çš„å†…å­˜å’Œåˆ†é…æ¬¡æ•°\n2.ç”¨benchmarkæµ‹è¯•çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†å¯¹æ¯”åŒä¸€ä¸ªåŠŸèƒ½çš„å‡½æ•°ï¼Œä¼˜åŒ–å‰åå†…å­˜åˆ†é…é‡æ˜¯å¦æœ‰é™ä½(è¿™é‡Œé¢ä¹ŸåŒ…å«äº†ä¸´æ—¶å†…å­˜)ã€‚\n3.ä½ çš„è¯´æ³•ï¼Œçœ‹å³°å€¼æ˜¯æ²¡æœ‰é”™çš„ï¼Œä½†æ˜¯å³°å€¼æœ¬èº«æœ‰å¾ˆå¤šå°±æ˜¯GCæ¥ä¸åŠå›æ”¶çš„ä¸´æ—¶å¯¹è±¡å ç”¨çš„ï¼Œé™ä½å•ä¸ªè¯·æ±‚å‡½æ•°é‡Œé¢çš„å†…å­˜åˆ†é…ï¼Œå¯ä»¥é™å³°å€¼ã€‚\n4.é™¤äº†å³°å€¼ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é™ä½å †å†…å­˜åˆ†é…ï¼Œå› ä¸ºå †å†…å­˜åˆ†é…å’ŒGCå›æ”¶ï¼Œä¼šæ¶ˆè€—CPUèµ„æºï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦åˆ©ç”¨å¯¹è±¡æ± (sync.Pool)åšå¤ç”¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡é‡æ–°åˆ†é…å¯¹è±¡çš„åŸå› ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1313417,"ctime":1734448773,"ip_address":"å¹¿ä¸œ","comment_id":396397,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100843701,"comment_content":"æˆ‘ä¸ç¡®å®šæˆ‘çš„ç†è§£æ˜¯å¦æ­£ç¡®ï¼Œbenchmarkä¸Šå†…å­˜æ¶ˆè€—æƒ…å†µæŒ‡çš„æ˜¯ä»ç¨‹åºè¿è¡Œåˆ°ç»“æŸåˆ†é…è¿‡çš„å†…å­˜æ€»å­—èŠ‚æ•°ï¼Œè€Œä¸æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æŸä¸€æ—¶åˆ»çš„æœ€å¤§ä½¿ç”¨å†…å­˜å­—èŠ‚æ•°ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨åšå†…å­˜æ€§èƒ½ä¼˜åŒ–æ—¶è¿½æ±‚çš„ã€å¹¶ä¸”è¡¡é‡ä¸€ä¸ªç¨‹åºå†…å­˜ä½¿ç”¨æ•ˆç‡çš„å¥½åçš„æŒ‡æ ‡éƒ½æ˜¯å‰è€…ï¼Ÿè·Ÿæˆ‘ä¸€ç›´çš„ç†è§£æœ‰ç‚¹å‡ºå…¥ï¼Œæˆ‘ä»¥ä¸ºé‡Šæ”¾æ‰çš„å†…å­˜ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥åªè¦ç¡®ä¿å†…å­˜ä½¿ç”¨å³°å€¼ä¸è¦è¿‡é«˜å°±å¥½äº†ï¼ŒğŸ˜‚å¦‚æœæˆ‘çš„ç†è§£æœ‰è¯¯å¸Œæœ›è€å¸ˆèƒ½æŒ‡æ­£ä¸€ä¸‹ï½","like_count":0,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655235,"discussion_content":"1.benchmarkæ˜¯å¾ªç¯næ¬¡ï¼Œè¾“å‡ºçš„æ˜¯å¹³å‡æ¯æ¬¡å‡½æ•°è°ƒç”¨åˆ†é…çš„å†…å­˜å’Œåˆ†é…æ¬¡æ•°\n2.ç”¨benchmarkæµ‹è¯•çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†å¯¹æ¯”åŒä¸€ä¸ªåŠŸèƒ½çš„å‡½æ•°ï¼Œä¼˜åŒ–å‰åå†…å­˜åˆ†é…é‡æ˜¯å¦æœ‰é™ä½(è¿™é‡Œé¢ä¹ŸåŒ…å«äº†ä¸´æ—¶å†…å­˜)ã€‚\n3.ä½ çš„è¯´æ³•ï¼Œçœ‹å³°å€¼æ˜¯æ²¡æœ‰é”™çš„ï¼Œä½†æ˜¯å³°å€¼æœ¬èº«æœ‰å¾ˆå¤šå°±æ˜¯GCæ¥ä¸åŠå›æ”¶çš„ä¸´æ—¶å¯¹è±¡å ç”¨çš„ï¼Œé™ä½å•ä¸ªè¯·æ±‚å‡½æ•°é‡Œé¢çš„å†…å­˜åˆ†é…ï¼Œå¯ä»¥é™å³°å€¼ã€‚\n4.é™¤äº†å³°å€¼ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é™ä½å †å†…å­˜åˆ†é…ï¼Œå› ä¸ºå †å†…å­˜åˆ†é…å’ŒGCå›æ”¶ï¼Œä¼šæ¶ˆè€—CPUèµ„æºï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦åˆ©ç”¨å¯¹è±¡æ± (sync.Pool)åšå¤ç”¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡é‡æ–°åˆ†é…å¯¹è±¡çš„åŸå› ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1734448773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":396370,"user_name":"lJ","can_delete":false,"product_type":"c1","uid":2562558,"ip_address":"æ±Ÿè‹","ucode":"CC29D06A16FF93","user_header":"https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg","comment_is_top":false,"comment_ctime":1734146996,"is_pvip":false,"replies":[{"id":143894,"content":"ğŸ‘ğŸ‘ğŸ‘ï¼Œå…¶å®slice appendå†…éƒ¨ï¼Œå°±æ˜¯ç”¨å€æ•°æ‰©å®¹çš„æœºåˆ¶å®ç°çš„ã€‚sync.Mapçš„ä½¿ç”¨æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œåœ¨åé¢æœ‰ä¸€èŠ‚ä¸“é—¨ä¼šè®²","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1313417,"ctime":1734326937,"ip_address":"å¹¿ä¸œ","comment_id":396370,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100843701,"comment_content":"å¯¹äºsliceï¼Œå¦‚æœæ— æ³•é¢„ä¼°æ‰€æœ‰æ•°æ®å¤§å°ï¼Œå¯ä»¥é€šè¿‡æ¯æ¬¡æ‰©å±•æ—¶æˆå€å¢åŠ å®¹é‡ï¼Œå‡å°‘é¢‘ç¹æ‰©å®¹å¸¦æ¥çš„å¼€é”€ã€‚\nåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¦‚æœéœ€è¦å¯¹ map è¿›è¡Œé¢‘ç¹çš„å¤šæ¬¡è¯»ä¸€æ¬¡å†™æ“ä½œï¼Œæ¨èä½¿ç”¨ sync.Mapã€‚å¦‚æœæ˜¯å¤šæ¬¡è¯»å†™æƒ…å†µï¼Œæ¨èä½¿ç”¨concurrent-mapã€‚\nmap çš„æ€§èƒ½é«˜åº¦ä¾èµ–äºé”®çš„å“ˆå¸Œåˆ†å¸ƒï¼Œå°½é‡é€‰æ‹©èƒ½é¿å…å“ˆå¸Œå†²çªçš„é”®ã€‚\nå¯¹äºä»»ä½•å®¹å™¨ç±»å‹ï¼Œå¦‚æœéœ€è¦é¢‘ç¹åˆ›å»ºå’Œé”€æ¯å¯¹è±¡ï¼Œéƒ½ä¼šå¯¼è‡´ GC å‹åŠ›å¢åŠ ï¼Œå¯ä»¥ä½¿ç”¨ sync.Pool å®ç°å¯¹è±¡çš„é‡ç”¨ã€‚","like_count":0,"discussions":[{"author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655147,"discussion_content":"ğŸ‘ğŸ‘ğŸ‘ï¼Œå…¶å®slice appendå†…éƒ¨ï¼Œå°±æ˜¯ç”¨å€æ•°æ‰©å®¹çš„æœºåˆ¶å®ç°çš„ã€‚sync.Mapçš„ä½¿ç”¨æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œåœ¨åé¢æœ‰ä¸€èŠ‚ä¸“é—¨ä¼šè®²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734326937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":2562558,"avatar":"https://static001.geekbang.org/account/avatar/00/27/19/fe/d31344db.jpg","nickname":"lJ","note":"","ucode":"CC29D06A16FF93","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1313417,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/89/eb8c28a4.jpg","nickname":"å¾é€¸","note":"","ucode":"DCFDEE08FD263A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":655252,"discussion_content":"è€å¸ˆï¼Œç¿»å€æ‰©å®¹æ˜¯æœ‰æ¡ä»¶çš„ï¼Œåœ¨å®¹é‡å°äº 256 æ—¶ï¼Œç›´æ¥é‡‡ç”¨ç¿»å€ç­–ç•¥ã€‚è¶…è¿‡ 256 åï¼Œåˆ‡ç‰‡çš„å®¹é‡æŒ‰ç…§çº¦ 1.25 å€é€æ­¥å¢é•¿ï¼Œå®æµ‹å‘ç°ä¹Ÿå¹¶ä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§1.25å€ã€‚https://github.com/golang/go/blob/95b433eed428afbb4ab32f0f2541774e939989c7/src/runtime/slice.go#L289","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734502504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":655147,"ip_address":"æ±Ÿè‹","group_id":0},"score":655252,"extra":""}]}]}]}