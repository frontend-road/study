{"id":324122,"title":"17ï½œå®¹å™¨ç½‘ç»œé…ç½®ï¼ˆ2ï¼‰ï¼šå®¹å™¨ç½‘ç»œå»¶æ—¶è¦æ¯”å®¿ä¸»æœºä¸Šçš„é«˜å—?","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç¨‹è¿œã€‚</p><p>åœ¨ä¸Šä¸€è®²é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†åœ¨å®¹å™¨ä¸­çš„ç½‘ç»œæ¥å£é…ç½®ï¼Œé‡ç‚¹è®²è§£çš„æ˜¯vethçš„æ¥å£é…ç½®æ–¹å¼ï¼Œè¿™ä¹Ÿæ˜¯ç»å¤§éƒ¨åˆ†å®¹å™¨ç”¨çš„ç¼ºçœçš„ç½‘ç»œé…ç½®æ–¹å¼ã€‚</p><p>ä¸è¿‡å‘¢ï¼Œä»vethçš„è¿™ç§ç½‘ç»œæ¥å£é…ç½®ä¸Šçœ‹ï¼Œä¸€ä¸ªæ•°æ®åŒ…è¦ä»å®¹å™¨é‡Œå‘é€åˆ°å®¿ä¸»æœºå¤–ï¼Œéœ€è¦å…ˆä»å®¹å™¨é‡Œçš„eth0 (veth_container) æŠŠåŒ…å‘é€åˆ°å®¿ä¸»æœºä¸Šveth_hostï¼Œç„¶åå†åœ¨å®¿ä¸»æœºä¸Šé€šè¿‡natæˆ–è€…è·¯ç”±çš„æ–¹å¼ï¼Œç»è¿‡å®¿ä¸»æœºä¸Šçš„eth0å‘å¤–å‘é€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2f/be/2fba246fb4aaa6315661a11996fa04be.jpg?wh=3200*1800\" alt=\"\"></p><p>è¿™ç§å®¹å™¨å‘å¤–å‘é€æ•°æ®åŒ…çš„è·¯å¾„ï¼Œç›¸æ¯”å®¿ä¸»æœºä¸Šç›´æ¥å‘å¤–å‘é€æ•°æ®åŒ…çš„è·¯å¾„ï¼Œå¾ˆæ˜æ˜¾è¦å¤šäº†ä¸€æ¬¡æ¥å£å±‚çš„å‘é€å’Œæ¥æ”¶ã€‚å°½ç®¡vethæ˜¯è™šæ‹Ÿç½‘ç»œæ¥å£ï¼Œåœ¨è½¯ä»¶ä¸Šè¿˜æ˜¯ä¼šå¢åŠ ä¸€äº›å¼€é”€ã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯¹ç½‘ç»œæ€§èƒ½æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼Œç‰¹åˆ«æ˜¯ä¹‹å‰è¿è¡Œåœ¨ç‰©ç†æœºå™¨ä¸Šï¼Œç°åœ¨è¿ç§»åˆ°å®¹å™¨ä¸Šçš„ï¼Œå¦‚æœç½‘ç»œé…ç½®é‡‡ç”¨vethæ–¹å¼ï¼Œå°±ä¼šå‡ºç°ç½‘ç»œå»¶æ—¶å¢åŠ çš„ç°è±¡ã€‚</p><p>é‚£ä»Šå¤©æˆ‘ä»¬å°±æ¥èŠä¸€èŠï¼Œå®¹å™¨ç½‘ç»œæ¥å£å¯¹äºå®¹å™¨ä¸­åº”ç”¨ç¨‹åºç½‘ç»œå»¶æ—¶æœ‰æ€æ ·çš„å½±å“ï¼Œè¿˜æœ‰è¿™ä¸ªé—®é¢˜åº”è¯¥æ€ä¹ˆè§£å†³ã€‚</p><h2>é—®é¢˜é‡ç°</h2><p>å¯¹äºè¿™ç§vethæ¥å£é…ç½®å¯¼è‡´ç½‘ç»œå»¶æ—¶å¢åŠ çš„ç°è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œ<a href=\"https://hewlettpackard.github.io/netperf/\">netperf</a>ï¼ˆNetperfæ˜¯ä¸€ä¸ªè¡¡é‡ç½‘ç»œæ€§èƒ½çš„å·¥å…·ï¼Œå®ƒå¯ä»¥æä¾›å•å‘ååé‡å’Œç«¯åˆ°ç«¯å»¶è¿Ÿçš„æµ‹è¯•ï¼‰æ¥æ¨¡æ‹Ÿä¸€ä¸‹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸¤å°è™šæ‹Ÿæœºæˆ–è€…ç‰©ç†æœºï¼Œè¿™ä¸¤å°æœºå™¨éœ€è¦åŒå¤„äºä¸€ä¸ªäºŒå±‚çš„ç½‘ç»œä¸­ã€‚</p><!-- [[[read_end]]] --><p>å…·ä½“çš„é…ç½®ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/24/20/24bc885e34e6477cd69324f67e65f120.jpeg?wh=3200*1800\" alt=\"\"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¬¬ä¸€å°æœºå™¨ä¸Šå¯åŠ¨ä¸€ä¸ªvethæ¥å£çš„å®¹å™¨ï¼Œå®¹å™¨çš„å¯åŠ¨å’Œå®¿ä¸»æœºä¸Šçš„é…ç½®ä½ å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™é‡Œçš„<a href=\"https://github.com/chengyli/training/blob/master/net/latency/start_container.sh\">è„šæœ¬</a>ã€‚åœ¨ç¬¬äºŒå°æœºå™¨ä¸Šï¼Œæˆ‘ä»¬åªè¦å¯åŠ¨ä¸€ä¸ªnetserverå°±å¯ä»¥äº†ã€‚</p><p>ç„¶åå‘¢ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨å®¹å™¨é‡Œå’Œå®¿ä¸»æœºä¸Šè¿è¡Œä¸netserveräº¤äº’çš„netperfï¼Œå†æ¯”è¾ƒä¸€ä¸‹å®ƒä»¬å»¶æ—¶çš„å·®å¼‚ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è¿è¡Œnetperfçš„TCP_RRæµ‹è¯•ç”¨ä¾‹ï¼ŒTCP_RRæ˜¯netperfé‡Œä¸“é—¨ç”¨æ¥æµ‹è¯•ç½‘ç»œå»¶æ—¶çš„ï¼Œç¼ºçœæ¯æ¬¡è¿è¡Œ10ç§’é’Ÿã€‚è¿è¡Œä»¥åï¼Œæˆ‘ä»¬è¿˜è¦è®¡ç®—å¹³å‡æ¯ç§’é’ŸTCP request/responseçš„æ¬¡æ•°ï¼Œè¿™ä¸ªæ¬¡æ•°è¶Šé«˜ï¼Œå°±è¯´æ˜å»¶æ—¶è¶Šå°ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆåœ¨ç¬¬ä¸€å°æœºå™¨çš„å®¿ä¸»æœºä¸Šç›´æ¥è¿è¡Œnetperfçš„TCP_RRæµ‹è¯•ç”¨ä¾‹3è½®ï¼Œå¾—åˆ°çš„å€¼åˆ†åˆ«æ˜¯2504.92ï¼Œ2410.14å’Œ2422.81ï¼Œè®¡ç®—ä¸€ä¸‹å¯ä»¥å¾—åˆ°ä¸‰è½®Transactionså¹³å‡å€¼æ˜¯2446/sã€‚</p><pre><code class=\"language-shell\"># ./netperf -H 192.168.0.194 -t TCP_RR\nMIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.194 () port 0 AF_INET : first burst 0\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n16384  131072 1        1       10.00    2504.92\n16384  131072\n# ./netperf -H 192.168.0.194 -t TCP_RR\nMIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.194 () port 0 AF_INET : first burst 0\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n16384  131072 1        1       10.00    2410.14\n16384  131072\n \n# ./netperf -H 192.168.0.194 -t TCP_RR\nMIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.194 () port 0 AF_INET : first burst 0\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n16384  131072 1        1       10.00    2422.81\n16384  131072\n</code></pre><p>åŒæ ·ï¼Œæˆ‘ä»¬å†åœ¨å®¹å™¨ä¸­è¿è¡Œä¸€ä¸‹netperfçš„TCP_RRï¼Œä¹Ÿä¸€æ ·è¿è¡Œä¸‰è½®ï¼Œè®¡ç®—ä¸€ä¸‹è¿™ä¸‰æ¬¡çš„å¹³å‡å€¼ï¼Œå¾—åˆ°çš„å€¼æ˜¯2141ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬æ‹¿è¿™æ¬¡å®¹å™¨ç¯å¢ƒä¸­çš„å¹³å‡å€¼å’Œå®¿ä¸»æœºä¸Šå¾—åˆ°çš„å€¼2446åšæ¯”è¾ƒï¼Œä¼šå‘ç°Transactionsä¸‹é™äº†å¤§æ¦‚12.5%ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œçš„å»¶æ—¶è¶…è¿‡äº†10%ã€‚</p><pre><code class=\"language-shell\">[root@4150e2a842b5 /]# ./netperf -H 192.168.0.194 -t TCP_RR\nMIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.194 () port 0 AF_INET : first burst 0\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n16384  131072 1        1       10.00    2104.68\n16384  131072\n \n[root@4150e2a842b5 /]# ./netperf -H 192.168.0.194 -t TCP_RR\nMIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.194 () port 0 AF_INET : first burst 0\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n16384  131072 1        1       10.00    2146.34\n16384  131072\n \n[root@4150e2a842b5 /]# ./netperf -H 192.168.0.194 -t TCP_RR\nMIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 192.168.0.194 () port 0 AF_INET : first burst 0\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n16384  131072 1        1       10.00    2173.79\n16384  131072\n</code></pre><h2>åˆ†æé—®é¢˜</h2><p>åˆšæ‰æˆ‘ä»¬å·²ç»å¾—åˆ°äº†æµ‹è¯•çš„æ•°å€¼ï¼Œæˆ‘ä»¬å‘ç°vethæ–¹å¼çš„ç¡®å¸¦æ¥äº†å¾ˆé«˜çš„ç½‘ç»œå»¶æ—¶ã€‚é‚£ç°åœ¨æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆvethä¼šå¸¦æ¥è¿™ä¹ˆå¤§çš„ç½‘ç»œå»¶æ—¶ï¼Œç„¶åå†çœ‹çœ‹æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥é™ä½å®¹å™¨é‡Œçš„ç½‘ç»œå»¶æ—¶ã€‚</p><p>æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹å®¹å™¨é‡Œvethæ¥å£çš„é…ç½®ï¼Œè¿˜æ˜¯æ‹¿æˆ‘ä»¬ä¸Šä¸€è®²é‡Œå®¹å™¨vethçš„å›¾ä½œä¸ºä¾‹å­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/56/89/569287c365c99d3778858b7bc42b5989.jpeg?wh=1920*1339\" alt=\"\"></p><p>ä¸Šä¸€è®²ä¸­æˆ‘æåˆ°è¿‡ï¼Œvethçš„è™šæ‹Ÿç½‘ç»œæ¥å£ä¸€èˆ¬éƒ½æ˜¯æˆå¯¹å‡ºç°ï¼Œå°±åƒä¸Šé¢å›¾é‡Œçš„veth_containerå’Œveth_hostä¸€æ ·ã€‚</p><p>åœ¨æ¯æ¬¡ç½‘ç»œä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åŒ…éƒ½éœ€è¦é€šè¿‡veth_containerè¿™ä¸ªæ¥å£å‘å¤–å‘é€ï¼Œè€Œä¸”å¿…é¡»ä¿è¯veth_hostå…ˆæ¥æ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…ã€‚</p><p>è™½ç„¶vethæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œæ¥å£ï¼Œä½†æ˜¯åœ¨æ¥æ”¶æ•°æ®åŒ…çš„æ“ä½œä¸Šï¼Œè¿™ä¸ªè™šæ‹Ÿæ¥å£å’ŒçœŸå®çš„ç½‘è·¯æ¥å£å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚è¿™é‡Œé™¤äº†æ²¡æœ‰ç¡¬ä»¶ä¸­æ–­çš„å¤„ç†ï¼Œå…¶ä»–æ“ä½œéƒ½å·®ä¸å¤šï¼Œç‰¹åˆ«æ˜¯è½¯ä¸­æ–­ï¼ˆsoftirqï¼‰çš„å¤„ç†éƒ¨åˆ†å…¶å®å°±å’ŒçœŸå®çš„ç½‘ç»œæ¥å£æ˜¯ä¸€æ ·çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡é˜…è¯»Linuxå†…æ ¸é‡Œçš„vethçš„é©±åŠ¨ä»£ç ï¼ˆ<a href=\"https://github.com/torvalds/linux/blob/v5.4/drivers/net/veth.c\">drivers/net/veth.c</a>ï¼‰ç¡®è®¤ä¸€ä¸‹ã€‚</p><p>vethå‘é€æ•°æ®çš„å‡½æ•°æ˜¯veth_xmit()ï¼Œå®ƒé‡Œé¢çš„ä¸»è¦æ“ä½œå°±æ˜¯æ‰¾åˆ°veth peerè®¾å¤‡ï¼Œç„¶åè§¦å‘peerè®¾å¤‡å»æ¥æ”¶æ•°æ®åŒ…ã€‚</p><p>æ¯”å¦‚veth_containerè¿™ä¸ªæ¥å£è°ƒç”¨äº†veth_xmit()æ¥å‘é€æ•°æ®åŒ…ï¼Œæœ€åå°±æ˜¯è§¦å‘äº†å®ƒçš„peerè®¾å¤‡veth_hostå»è°ƒç”¨netif_rx()æ¥æ¥æ”¶æ•°æ®åŒ…ã€‚ä¸»è¦çš„ä»£ç æˆ‘åˆ—åœ¨ä¸‹é¢äº†ï¼š</p><pre><code class=\"language-shell\">static netdev_tx_t veth_xmit(struct sk_buff *skb, struct net_device *dev)\n{\nâ€¦\n       /* æ‹¿åˆ°veth peerè®¾å¤‡çš„net_device */\n       rcv = rcu_dereference(priv-&gt;peer);\nâ€¦\n       /* å°†æ•°æ®é€åˆ°veth peerè®¾å¤‡ */ \n       if (likely(veth_forward_skb(rcv, skb, rq, rcv_xdp) == NET_RX_SUCCESS)) {\n \n \nâ€¦\n}\n \nstatic int veth_forward_skb(struct net_device *dev, struct sk_buff *skb,\n                            struct veth_rq *rq, bool xdp)\n{\n        /* è¿™é‡Œæœ€åè°ƒç”¨äº† netif_rx() */\n        return __dev_forward_skb(dev, skb) ?: xdp ?\n                veth_xdp_rx(rq, skb) :\n                netif_rx(skb);\n}\n</code></pre><p>è€Œnetif_rx()æ˜¯ä¸€ä¸ªç½‘ç»œè®¾å¤‡é©±åŠ¨é‡Œé¢æ ‡å‡†çš„æ¥æ”¶æ•°æ®åŒ…çš„å‡½æ•°ï¼Œnetif_rx()é‡Œé¢ä¼šä¸ºè¿™ä¸ªæ•°æ®åŒ…raiseä¸€ä¸ªsoftirqã€‚</p><pre><code>   __raise_softirq_irqoff(NET_RX_SOFTIRQ);\n</code></pre><p>å…¶å®softirqè¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨<a href=\"https://time.geekbang.org/column/article/311054\">CPUçš„æ¨¡å—</a>ä¸­ä¹Ÿæåˆ°è¿‡ã€‚åœ¨å¤„ç†ç½‘ç»œæ•°æ®çš„æ—¶å€™ï¼Œä¸€äº›è¿è¡Œæ—¶é—´è¾ƒé•¿è€Œä¸”ä¸èƒ½åœ¨ç¡¬ä¸­æ–­ä¸­å¤„ç†çš„å·¥ä½œï¼Œå°±ä¼šé€šè¿‡softirqæ¥å¤„ç†ã€‚</p><p>ä¸€èˆ¬åœ¨ç¡¬ä»¶ä¸­æ–­å¤„ç†ç»“æŸä¹‹åï¼Œç½‘ç»œsoftirqçš„å‡½æ•°æ‰ä¼šå†å»æ‰§è¡Œæ²¡æœ‰å®Œæˆçš„åŒ…çš„å¤„ç†å·¥ä½œã€‚å³ä½¿è¿™é‡Œsoftirqçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œè¿˜æ˜¯ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚</p><p><strong>æ‰€ä»¥ï¼Œæ ¹æ®vethè¿™ä¸ªè™šæ‹Ÿç½‘ç»œè®¾å¤‡çš„å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå¿…ç„¶ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œè¿™æ ·å°±ä¼šå¢åŠ æ•°æ®åŒ…çš„ç½‘ç»œå»¶æ—¶ã€‚</strong></p><h2>è§£å†³é—®é¢˜</h2><p>é‚£ä¹ˆæˆ‘ä»¬æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å‡å°‘å®¹å™¨çš„ç½‘ç»œå»¶æ—¶å‘¢ï¼Ÿä½ å¯èƒ½ä¼šæƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä¸å¯ä»¥ä¸ä½¿ç”¨vethè¿™ä¸ªæ–¹å¼é…ç½®ç½‘ç»œæ¥å£ï¼Œè€Œæ˜¯æ¢æˆåˆ«çš„æ–¹å¼å‘¢ï¼Ÿ</p><p>çš„ç¡®æ˜¯è¿™æ ·ï¼Œå…¶å®é™¤äº†vethä¹‹å¤–ï¼Œå®¹å™¨è¿˜å¯ä»¥é€‰æ‹©å…¶ä»–çš„ç½‘ç»œé…ç½®æ–¹å¼ã€‚åœ¨Dockerçš„æ–‡æ¡£ä¸­æåˆ°äº†macvlançš„é…ç½®æ–¹å¼ï¼Œå’Œmacvlanå¾ˆç±»ä¼¼çš„æ–¹å¼è¿˜æœ‰ipvlanã€‚</p><p>é‚£æˆ‘ä»¬å…ˆæ¥ç®€å•çœ‹ä¸€ä¸‹macvlanå’Œipvlançš„å¼‚åŒç‚¹ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸¤ä¸ªæ–¹å¼çš„ç›¸åŒä¹‹å¤„ï¼Œæ— è®ºæ˜¯macvlanè¿˜æ˜¯ipvlanï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨ä¸€ä¸ªç‰©ç†çš„ç½‘ç»œæ¥å£ä¸Šå†é…ç½®å‡ ä¸ªè™šæ‹Ÿçš„ç½‘ç»œæ¥å£ã€‚åœ¨è¿™äº›è™šæ‹Ÿçš„ç½‘ç»œæ¥å£ä¸Šï¼Œéƒ½å¯ä»¥é…ç½®ç‹¬ç«‹çš„IPï¼Œå¹¶ä¸”è¿™äº›IPå¯ä»¥å±äºä¸åŒçš„Namespaceã€‚</p><p>ç„¶åæˆ‘å†è¯´è¯´å®ƒä»¬çš„ä¸åŒç‚¹ã€‚<strong>å¯¹äºmacvlanï¼Œæ¯ä¸ªè™šæ‹Ÿç½‘ç»œæ¥å£éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„macåœ°å€ï¼›è€Œipvlançš„è™šæ‹Ÿç½‘ç»œæ¥å£æ˜¯å’Œç‰©ç†ç½‘ç»œæ¥å£å…±äº«åŒä¸€ä¸ªmacåœ°å€ã€‚</strong>è€Œä¸”å®ƒä»¬éƒ½æœ‰è‡ªå·±çš„L2/L3çš„é…ç½®æ–¹å¼ï¼Œä¸è¿‡æˆ‘ä»¬ä¸»è¦æ˜¯æ‹¿macvlan/ipvlanæ¥å’Œvethåšæ¯”è¾ƒï¼Œè¿™é‡Œå¯ä»¥å…ˆå¿½ç•¥macvlan/ipvlanè¿™äº›è¯¦ç»†çš„ç‰¹æ€§ã€‚</p><p>æˆ‘ä»¬å°±ä»¥ipvlanä¸ºä¾‹ï¼Œè¿è¡Œä¸‹é¢çš„è¿™ä¸ªè„šæœ¬ï¼Œä¸ºå®¹å™¨æ‰‹åŠ¨é…ç½®ä¸Šipvlançš„ç½‘ç»œæ¥å£ã€‚</p><pre><code class=\"language-shell\">docker run --init --name lat-test-1 --network none -d registry/latency-test:v1 sleep 36000\n \npid1=$(docker inspect lat-test-1 | grep -i Pid | head -n 1 | awk '{print $2}' | awk -F \",\" '{print $1}')\necho $pid1\nln -s /proc/$pid1/ns/net /var/run/netns/$pid1\n \nip link add link eth0 ipvt1 type ipvlan mode l2\nip link set dev ipvt1 netns $pid1\n \nip netns exec $pid1 ip link set ipvt1 name eth0\nip netns exec $pid1 ip addr add 172.17.3.2/16 dev eth0\nip netns exec $pid1 ip link set eth0 up\n</code></pre><p>åœ¨è¿™ä¸ªè„šæœ¬é‡Œï¼Œæˆ‘ä»¬å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨\"â€”network none\"çš„æ–¹å¼æ¥å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯åœ¨å®¹å™¨ä¸­æ²¡æœ‰é…ç½®ä»»ä½•çš„ç½‘ç»œæ¥å£ã€‚</p><p>æ¥ç€æˆ‘ä»¬åœ¨å®¿ä¸»æœºeth0çš„æ¥å£ä¸Šå¢åŠ ä¸€ä¸ªipvlanè™šæ‹Ÿç½‘ç»œæ¥å£ipvt1ï¼Œå†æŠŠå®ƒåŠ å…¥åˆ°å®¹å™¨çš„Network Namespaceé‡Œé¢ï¼Œé‡å‘½åä¸ºå®¹å™¨å†…çš„eth0ï¼Œå¹¶ä¸”é…ç½®ä¸ŠIPã€‚è¿™æ ·æˆ‘ä»¬å°±é…ç½®å¥½äº†ç¬¬ä¸€ä¸ªç”¨ipvlanç½‘ç»œæ¥å£çš„å®¹å™¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼é…ç½®ç¬¬äºŒä¸ªå®¹å™¨ï¼Œè¿™æ ·ä¸¤ä¸ªå®¹å™¨å¯ä»¥ç›¸äº’pingä¸€ä¸‹IPï¼Œçœ‹çœ‹ç½‘ç»œæ˜¯å¦é…ç½®æˆåŠŸäº†ã€‚è„šæœ¬ä½ å¯ä»¥åœ¨<a href=\"https://github.com/chengyli/training/blob/main/net/latency/create_ipvlan.sh\">è¿™é‡Œ</a>å¾—åˆ°ã€‚</p><p>ä¸¤ä¸ªå®¹å™¨é…ç½®å¥½ä¹‹åï¼Œå°±åƒä¸‹é¢å›¾ä¸­æè¿°çš„ä¸€æ ·äº†ã€‚ä»è¿™å¼ å›¾é‡Œï¼Œä½ å¾ˆå®¹æ˜“å°±èƒ½çœ‹å‡ºmacvlan/ipvlanä¸vethç½‘ç»œé…ç½®æœ‰ä»€ä¹ˆä¸ä¸€æ ·ã€‚å®¹å™¨çš„è™šæ‹Ÿç½‘ç»œæ¥å£ï¼Œç›´æ¥è¿æ¥åœ¨äº†å®¿ä¸»æœºçš„ç‰©ç†ç½‘ç»œæ¥å£ä¸Šäº†ï¼Œå½¢æˆäº†ä¸€ä¸ªç½‘ç»œäºŒå±‚çš„è¿æ¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1e/a0/1e78d66a93e7a0aab1315056c4b937a0.jpeg?wh=3200*1800\" alt=\"\"></p><p>å¦‚æœä»å®¹å™¨é‡Œå‘å®¿ä¸»æœºå¤–å‘é€æ•°æ®ï¼Œçœ‹ä¸Šå»é€šè¿‡çš„æ¥å£è¦æ¯”vethå°‘äº†ï¼Œé‚£ä¹ˆå®é™…æƒ…å†µæ˜¯ä¸æ˜¯è¿™æ ·å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ipvlanæ¥å£å‘é€æ•°æ®çš„ä»£ç ã€‚</p><p>ä»ä¸‹é¢çš„ipvlanæ¥å£çš„å‘é€ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯å¾€å®¿ä¸»æœºå¤–å‘é€æ•°æ®ï¼Œå‘é€å‡½æ•°ä¼šç›´æ¥æ‰¾åˆ°ipvlanè™šæ‹Ÿæ¥å£å¯¹åº”çš„ç‰©ç†ç½‘ç»œæ¥å£ã€‚</p><p>æ¯”å¦‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªç‰©ç†æ¥å£å°±æ˜¯å®¿ä¸»æœºä¸Šçš„eth0ï¼Œç„¶åç›´æ¥è°ƒç”¨dev_queue_xmit()ï¼Œé€šè¿‡ç‰©ç†æ¥å£æŠŠæ•°æ®ç›´æ¥å‘é€å‡ºå»ã€‚</p><pre><code class=\"language-shell\">static int ipvlan_xmit_mode_l2(struct sk_buff *skb, struct net_device *dev)\n{\nâ€¦\n        if (!ipvlan_is_vepa(ipvlan-&gt;port) &amp;&amp;\n            ether_addr_equal(eth-&gt;h_dest, eth-&gt;h_source)) {\nâ€¦\n        } else if (is_multicast_ether_addr(eth-&gt;h_dest)) {\nâ€¦\n        }\n        /* \n         * å¯¹äºæ™®é€šçš„å¯¹å¤–å‘é€æ•°æ®ï¼Œä¸Šé¢çš„if å’Œ else ifä¸­çš„æ¡ä»¶éƒ½ä¸æˆç«‹ï¼Œ\n         * æ‰€ä»¥ä¼šæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œæ‹¿åˆ°ipvlanå¯¹åº”çš„ç‰©ç†ç½‘è·¯æ¥å£è®¾å¤‡ï¼Œ\n         * ç„¶åç›´æ¥ä»è¿™ä¸ªè®¾å¤‡å‘é€æ•°æ®ã€‚\n         */ \n        skb-&gt;dev = ipvlan-&gt;phy_dev;\n        return dev_queue_xmit(skb);\n}\n</code></pre><p>å’Œvethæ¥å£ç›¸æ¯”ï¼Œæˆ‘ä»¬ç”¨ipvlanå‘é€å¯¹å¤–æ•°æ®å°±è¦ç®€å•å¾—å¤šï¼Œå› ä¸ºè¿™ç§æ–¹å¼æ²¡æœ‰å†…éƒ¨é¢å¤–çš„softirqå¤„ç†å¼€é”€ã€‚</p><p>ç°åœ¨æˆ‘ä»¬è¿˜å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºè·‘åœ¨ä½¿ç”¨vethæ¥å£çš„å®¹å™¨ä¸­ï¼Œè·Ÿè¿™ä¸ªåº”ç”¨ç¨‹åºè·‘åœ¨ä½¿ç”¨ipvlanæ¥å£çš„å®¹å™¨ä¸­ï¼Œä¸¤è€…çš„ç½‘ç»œå»¶æ—¶å·®å¼‚æ˜¯æ€æ ·çš„ã€‚</p><p>ä¸‹é¢è¿™å¼ å›¾æ˜¯ç½‘ç»œå»¶æ—¶çš„ç›‘æ§å›¾ï¼Œå›¾é‡Œè“è‰²çš„çº¿è¡¨ç¤ºç¨‹åºè¿è¡Œåœ¨vethå®¹å™¨ä¸­ï¼Œé»„è‰²çº¿è¡¨ç¤ºç¨‹åºè¿è¡Œåœ¨ipvlançš„å®¹å™¨é‡Œï¼Œç»¿è‰²çš„çº¿ä»£è¡¨ç¨‹åºç›´æ¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Šã€‚</p><p>ä»è¿™å¼ å»¶æ—¶ï¼ˆLatencyï¼‰å›¾é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨vethå®¹å™¨é‡Œç¨‹åºçš„ç½‘ç»œå»¶æ—¶è¦æ˜æ˜¾é«˜ä¸€äº›ï¼Œè€Œç¨‹åºåœ¨ipvlanå®¹å™¨é‡Œçš„ç½‘ç»œå»¶æ—¶å·²ç»æ¯”è¾ƒæ¥è¿‘ç‰©ç†æœºä¸Šçš„ç½‘ç»œå»¶æ—¶äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5d/18/5de6462780275acca261d63661b9e018.png?wh=1142*472\" alt=\"\"></p><p>æ‰€ä»¥å¯¹äºç½‘ç»œå»¶æ—¶æ•æ„Ÿçš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ipvlan/macvlançš„å®¹å™¨ç½‘ç»œé…ç½®æ–¹å¼æ¥æ›¿æ¢ç¼ºçœçš„vethç½‘ç»œé…ç½®ã€‚</p><h2>é‡ç‚¹å°ç»“</h2><p>å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹è®²å®Œäº†ï¼Œæˆ‘ä»¬æ¥åšä¸ªæ€»ç»“ã€‚ä»Šå¤©æˆ‘ä»¬ä¸»è¦è®¨è®ºäº†å®¹å™¨ç½‘ç»œæ¥å£å¯¹å®¹å™¨ä¸­åº”ç”¨ç¨‹åºç½‘ç»œå»¶æ—¶çš„å½±å“ã€‚</p><p>å®¹å™¨é€šå¸¸ç¼ºçœä½¿ç”¨vethè™šæ‹Ÿç½‘ç»œæ¥å£ï¼Œä¸è¿‡vethæ¥å£ä¼šæœ‰æ¯”è¾ƒå¤§çš„ç½‘ç»œå»¶æ—¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨netperfè¿™ä¸ªå·¥å…·æ¥æ¯”è¾ƒç½‘ç»œå»¶æ—¶ï¼Œç›¸æ¯”ç‰©ç†æœºä¸Šçš„ç½‘ç»œå»¶æ—¶ï¼Œä½¿ç”¨vethæ¥å£å®¹å™¨çš„ç½‘ç»œå»¶æ—¶ä¼šå¢åŠ è¶…è¿‡10%ã€‚</p><p>æˆ‘ä»¬é€šè¿‡å¯¹vethå®ç°çš„ä»£ç åšåˆ†æï¼Œå¯ä»¥çœ‹åˆ°ç”±äºvethæ¥å£æ˜¯æˆå¯¹å·¥ä½œï¼Œ<strong>åœ¨å¯¹å¤–å‘é€æ•°æ®çš„æ—¶å€™ï¼Œpeer vethæ¥å£éƒ½ä¼šraise softirqæ¥å®Œæˆä¸€æ¬¡æ”¶åŒ…æ“ä½œï¼Œè¿™æ ·å°±ä¼šå¸¦æ¥æ•°æ®åŒ…å¤„ç†çš„é¢å¤–å¼€é”€ã€‚</strong></p><p>å¦‚æœè¦å‡å°å®¹å™¨ç½‘ç»œå»¶æ—¶ï¼Œå°±å¯ä»¥ç»™å®¹å™¨é…ç½®ipvlan/macvlançš„ç½‘ç»œæ¥å£æ¥æ›¿ä»£vethç½‘ç»œæ¥å£ã€‚Ipvlan/macvlanç›´æ¥åœ¨ç‰©ç†ç½‘ç»œæ¥å£ä¸Šè™šæ‹Ÿå‡ºæ¥å£ï¼Œåœ¨å‘é€å¯¹å¤–æ•°æ®åŒ…çš„æ—¶å€™å¯ä»¥ç›´æ¥é€šè¿‡ç‰©ç†æ¥å£å®Œæˆï¼Œæ²¡æœ‰èŠ‚ç‚¹å†…éƒ¨ç±»ä¼¼vethçš„é‚£ç§softirqçš„å¼€é”€ã€‚<strong>å®¹å™¨ä½¿ç”¨ipvlan/maclançš„ç½‘ç»œæ¥å£ï¼Œå®ƒçš„ç½‘ç»œå»¶æ—¶å¯ä»¥éå¸¸æ¥è¿‘ç‰©ç†ç½‘ç»œæ¥å£çš„å»¶æ—¶ã€‚</strong></p><p>å¯¹äºå»¶æ—¶æ•æ„Ÿçš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ipvlan/macvlanç½‘ç»œæ¥å£çš„å®¹å™¨ã€‚ä¸è¿‡ï¼Œç”±äºipvlan/macvlanç½‘ç»œæ¥å£ç›´æ¥æŒ‚è½½åœ¨ç‰©ç†ç½‘ç»œæ¥å£ä¸Šï¼Œå¯¹äºéœ€è¦ä½¿ç”¨iptablesè§„åˆ™çš„å®¹å™¨ï¼Œæ¯”å¦‚Kubernetesé‡Œä½¿ç”¨serviceçš„å®¹å™¨ï¼Œå°±ä¸èƒ½å·¥ä½œäº†ã€‚è¿™å°±éœ€è¦ä½ ç»“åˆå®é™…åº”ç”¨çš„éœ€æ±‚åšä¸ªåˆ¤æ–­ï¼Œå†é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚</p><h2>æ€è€ƒé¢˜</h2><p>åœ¨è¿™èŠ‚è¯¾çš„æœ€åï¼Œæˆ‘æåˆ°â€œç”±äºipvlan/macvlanç½‘ç»œæ¥å£ç›´æ¥æŒ‚è½½åœ¨ç‰©ç†ç½‘ç»œæ¥å£ä¸Šï¼Œå¯¹äºéœ€è¦ä½¿ç”¨iptablesè§„åˆ™çš„å®¹å™¨ï¼Œæ¯”å¦‚Kubernetesé‡Œä½¿ç”¨serviceçš„å®¹å™¨ï¼Œå°±ä¸èƒ½å·¥ä½œäº†â€ï¼Œè¯·ä½ æ€è€ƒä¸€ä¸‹è¿™ä¸ªåˆ¤æ–­èƒŒåçš„å…·ä½“åŸå› ã€‚</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç–‘é—®ã€‚å¦‚æœè¿™ç¯‡æ–‡ç« è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œä¸€èµ·äº¤æµè¿›æ­¥ã€‚</p>","neighbors":{"left":{"article_title":"16 | å®¹å™¨ç½‘ç»œé…ç½®ï¼ˆ1ï¼‰ï¼šå®¹å™¨ç½‘ç»œä¸é€šäº†è¦æ€ä¹ˆè°ƒè¯•?","id":323325},"right":{"article_title":"18 | å®¹å™¨ç½‘ç»œé…ç½®ï¼ˆ3ï¼‰ï¼šå®¹å™¨ä¸­çš„ç½‘ç»œä¹±åºåŒ…æ€ä¹ˆè¿™ä¹ˆé«˜ï¼Ÿ","id":324357}},"comments":[{"had_liked":false,"id":269585,"user_name":"è±†è±†","can_delete":false,"product_type":"c1","uid":1745589,"ip_address":"","ucode":"249C55D3481682","user_header":"https://static001.geekbang.org/account/avatar/00/1a/a2/b5/c68d9439.jpg","comment_is_top":false,"comment_ctime":1608707396,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"53148314948","product_id":100063801,"comment_content":"æ€è€ƒé¢˜ï¼Œå› ä¸ºä»–ä»¬ä½¿ç”¨ä¸åŒçš„ç½‘ç»œåç§°ç©ºé—´ï¼ŒMACVLAN ä¼šèµ°å•ç‹¬çš„åè®®æ ˆï¼Œiptables è§„åˆ™æ˜¯åœ¨ä¸»æœºçš„ç½‘ç»œåç§°ç©ºé—´ï¼Œæ‰€ä»¥ä¸ä¼šç”Ÿæ•ˆçš„ï¼Œé™¤éå•ç‹¬ç»™å®¹å™¨çš„ç½‘ç»œåç§°ç©ºé—´é…ç½®iptables è§„åˆ™","like_count":12,"discussions":[{"author":{"id":1701572,"avatar":"https://static001.geekbang.org/account/avatar/00/19/f6/c4/e14686d4.jpg","nickname":"shk1230","note":"","ucode":"9E39279C23FF8F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552673,"discussion_content":"å…¶å®ä¹Ÿå¯ä»¥ç†è§£ä¸ºå®¹å™¨çš„IPç›´æ¥æš´éœ²åˆ°äº†ç‰©ç†ç½‘ç»œä¸Šï¼Œæ— æ³•åšä»£ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645542741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270087,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1608898419,"is_pvip":false,"replies":[{"id":"97996","content":"@è«åï¼Œ<br><br>&gt; é™¤äº† softirq çš„æ€§èƒ½æŸåï¼Œåº”è¯¥è¿˜åŒ…æ‹¬ docker0 ç½‘æ¡¥çš„è‡ªèº«å¤„ç†é€»è¾‘ï¼ˆä½œä¸º veth_container çš„ä¸»è®¾å¤‡æ¥ç®¡å…¶æ•°æ®åŒ…çš„å¤„ç†æƒï¼‰ä»¥åŠ docker0 -&gt; eth0 çš„è½¬å‘é€»è¾‘ã€‚<br><br>æ²¡é”™ï¼ŒLinux bridgeä»¥åŠdocker0 -&gt; eth0çš„L3å±‚çš„æ“ä½œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œä¸è¿‡ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œveth pair softirqçš„å¤„ç†å¸¦æ¥çš„å¼€é”€è¦æ›´æ˜æ˜¾ä¸€äº›ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CY","uid":"2070138","ctime":1609055974,"ip_address":"","comment_id":270087,"utype":1}],"discussion_count":3,"race_medal":0,"score":"40263604083","product_id":100063801,"comment_content":"netif_rx é€šå¸¸åœ¨ç¡¬ä»¶ä¸­æ–­å¤„ç†é€»è¾‘ä¸­è°ƒç”¨ã€‚loopbackã€veth ç­‰è®¾å¤‡é©±åŠ¨æ˜¯ç‰¹ä¾‹ï¼Œé€šè¿‡è°ƒç”¨ netif_rx æ¨¡æ‹Ÿæ•°æ®åŒ…çš„æ¥æ”¶ã€‚<br><br>é™¤äº† softirq çš„æ€§èƒ½æŸåï¼Œåº”è¯¥è¿˜åŒ…æ‹¬ docker0 ç½‘æ¡¥çš„è‡ªèº«å¤„ç†é€»è¾‘ï¼ˆä½œä¸º veth_container çš„ä¸»è®¾å¤‡æ¥ç®¡å…¶æ•°æ®åŒ…çš„å¤„ç†æƒï¼‰ä»¥åŠ docker0 -&gt; eth0 çš„è½¬å‘é€»è¾‘ã€‚<br><br>docker inspect è¾“å‡ºä¸º json æ ¼å¼ï¼Œæ¨èä½¿ç”¨ jq å‘½ä»¤æŸ¥çœ‹ Pid ï¼Œå‘½ä»¤æ¯”è¾ƒç®€æ´ï¼Œç¼ºç‚¹æ˜¯é»˜è®¤æœ«å®‰è£…ï¼š<br>docker inspect lat-test-1 | jq .[0].State.Pid","like_count":9,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512514,"discussion_content":"@è«åï¼Œ\n\n&amp;gt; é™¤äº† softirq çš„æ€§èƒ½æŸåï¼Œåº”è¯¥è¿˜åŒ…æ‹¬ docker0 ç½‘æ¡¥çš„è‡ªèº«å¤„ç†é€»è¾‘ï¼ˆä½œä¸º veth_container çš„ä¸»è®¾å¤‡æ¥ç®¡å…¶æ•°æ®åŒ…çš„å¤„ç†æƒï¼‰ä»¥åŠ docker0 -&amp;gt; eth0 çš„è½¬å‘é€»è¾‘ã€‚\n\næ²¡é”™ï¼ŒLinux bridgeä»¥åŠdocker0 -&amp;gt; eth0çš„L3å±‚çš„æ“ä½œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œä¸è¿‡ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œveth pair softirqçš„å¤„ç†å¸¦æ¥çš„å¼€é”€è¦æ›´æ˜æ˜¾ä¸€äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609055974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1198332,"avatar":"https://static001.geekbang.org/account/avatar/00/12/48/fc/f46062b6.jpg","nickname":"abc","note":"","ucode":"A4E989E85848D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":395535,"discussion_content":"æŠŠhost eth0ä¹Ÿç»™æŒ‚åˆ°docker0è¿™ä¸ªbridgeä¸Šä¼šæ˜¯å•¥æ•ˆæœ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632313102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1007254,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","nickname":"è«å","note":"","ucode":"E28F2602BA25DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337825,"discussion_content":"å—¯ï¼Œæ˜¯çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609080934,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272246,"user_name":"morse","can_delete":false,"product_type":"c1","uid":1001529,"ip_address":"","ucode":"E22E5FA291B9AA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/39/4e95e7b9.jpg","comment_is_top":false,"comment_ctime":1610004916,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"23084841396","product_id":100063801,"comment_content":"Kubernetes çš„ service æ˜¯é  Kube-proxyå®ç°, <br><br>L2æ¨¡å¼ä¸‹, å‡ºå…¥æµé‡ä¸ä¼šç»è¿‡ host namespace, é‚£ä¹ˆkube-proxyå°±æ— æ³•å·¥ä½œ.<br><br>L3æ¨¡å¼ä¸‹, å•å…¥æ–¹å‘ä¸ç»è¿‡ host namespace. æ— æ³•æ”¯æŒKube-proxy.<br>","like_count":6,"discussions":[{"author":{"id":1132009,"avatar":"https://static001.geekbang.org/account/avatar/00/11/45/e9/133553d1.jpg","nickname":"æ™´å¤©ğŸƒ","note":"","ucode":"5AE4A042B94010","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542294,"discussion_content":"ç°åœ¨kuber-proxyä½œç”¨ç±»ä¼¼ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œæ§åˆ¶ipvsæˆ–è€…iptablesè§„åˆ™çš„ç”Ÿæˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640704102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269661,"user_name":"è°¢å“ˆå“ˆ","can_delete":false,"product_type":"c1","uid":2326880,"ip_address":"","ucode":"5AADE70B5AFE27","user_header":"https://static001.geekbang.org/account/avatar/00/23/81/60/71ed6ac7.jpg","comment_is_top":false,"comment_ctime":1608730662,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"23083567142","product_id":100063801,"comment_content":"åœ¨iptablesæ ‡è®°åŒ…ä¹‹å‰å°±è¢«å®¿ä¸»æœºä¸Šçš„è·¯ç”±å±‚é¢ç»™å¤„ç†å®Œäº†ï¼Œåœ¨mangleè¡¨å’Œnatè¡¨çš„PREROUTING å’ŒPOSTROUTINGé“¾ä¸Šçš„è§„åˆ™å°±åŒ¹é…ä¸åˆ°äº†","like_count":5,"discussions":[{"author":{"id":2608728,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","nickname":"Dexter","note":"","ucode":"909CABC4AC4AC9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539183,"discussion_content":"host route decisionåšå®Œï¼Œåº”è¯¥å°±æ˜¯è¿›å…¥outout chainå§ï¼Œä½ çš„è¯´æ³•ä¸å¤ªå¯¹å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639636322,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1313840,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0c/30/bb4bfe9d.jpg","nickname":"lyonger","note":"","ucode":"E89A75DADEA2A1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393724,"discussion_content":"è¯·é—®ä¸‹ï¼Œä¸ºå•¥å…ˆè¢«å®¿ä¸»æœºå™¨çš„è·¯ç”±å¤„ç†ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631580550,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329816,"user_name":"swordholder","can_delete":false,"product_type":"c1","uid":1002569,"ip_address":"","ucode":"3D1361126AD3CB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/49/d21c134f.jpg","comment_is_top":false,"comment_ctime":1641548975,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18821418159","product_id":100063801,"comment_content":"Kubernetesçš„serviceæ˜¯é€šè¿‡åœ¨iptablesä¸­è®¾ç½®DNATè§„åˆ™å®ç°çš„ï¼Œè€Œ DNAT è§„åˆ™æ˜¯åœ¨ PREROUTING æ£€æŸ¥ç‚¹ï¼Œä¹Ÿå°±æ˜¯åœ¨è·¯ç”±ä¹‹å‰ã€‚ <br>è€Œipvlan&#47;macvlan ç½‘ç»œæ¥å£ç›´æ¥æŒ‚è½½åœ¨ç‰©ç†ç½‘ç»œæ¥å£ä¸Šï¼Œå‘é€å‡½æ•°ä¼šç›´æ¥æ‰¾åˆ°è™šæ‹Ÿæ¥å£å¯¹åº”çš„ç‰©ç†ç½‘ç»œæ¥å£ï¼Œä¸ä¼šå†ç»è¿‡iptablesçš„DNAT è§„åˆ™ã€‚<br>","like_count":5},{"had_liked":false,"id":354544,"user_name":"JianXu","can_delete":false,"product_type":"c1","uid":1033219,"ip_address":"ä¸Šæµ·","ucode":"2A61BDBB573BDC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c4/03/f753fda7.jpg","comment_is_top":false,"comment_ctime":1660527524,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660527524","product_id":100063801,"comment_content":"ä¸èƒ½ä½¿ç”¨service ä¸æ˜¯ä½¿å¾—Kubernetes å¾ˆå—é™åˆ¶äº†å—ï¼Ÿæœ‰ä»€ä¹ˆä¸¤å…¨å…¶ç¾çš„åŠæ³•å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":340140,"user_name":"é¡¾éª¨","can_delete":false,"product_type":"c1","uid":1131165,"ip_address":"","ucode":"3F6BA592AB7723","user_header":"https://static001.geekbang.org/account/avatar/00/11/42/9d/c36b7ef7.jpg","comment_is_top":false,"comment_ctime":1648625046,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1648625046","product_id":100063801,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œé…ç½®IPVLANåï¼Œå®¿ä¸»æœºå’Œå®¹å™¨ç½‘ç»œè²Œä¼¼æ˜¯ä¸é€šçš„ï¼Œè¿™ä¸ªæ€ä¹ˆæ‰“é€šå®¿ä¸»æœºå’Œå®¹å™¨çš„ç½‘ç»œå‘¢","like_count":0,"discussions":[{"author":{"id":1208044,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6e/ec/14d93177.jpg","nickname":"kof11321","note":"","ucode":"3E38D3A8C3F9F0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559700,"discussion_content":"åŒé—®ï¼Œåœ¨å®¹å™¨å†…pingå¤–ç½‘åœ°å€ï¼Œä¸é€š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648886885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1192616,"avatar":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","nickname":"éƒ‘æµ·æˆ","note":"","ucode":"B0363EA4B2C646","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1208044,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6e/ec/14d93177.jpg","nickname":"kof11321","note":"","ucode":"3E38D3A8C3F9F0","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":565227,"discussion_content":"å®¿ä¸»æœºçš„ip_forwardå†…æ ¸å‚æ•°è®¾ç½®ä¸º1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650417632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":559700,"ip_address":""},"score":565227,"extra":""}]}]},{"had_liked":false,"id":337934,"user_name":"å°Y","can_delete":false,"product_type":"c1","uid":1739621,"ip_address":"","ucode":"24A43BB71805F8","user_header":"https://static001.geekbang.org/account/avatar/00/1a/8b/65/0f1f9a10.jpg","comment_is_top":false,"comment_ctime":1647164498,"is_pvip":false,"replies":[{"id":"123835","content":"è¿™ä¸ªå¯ä»¥ä»å‡ ä¸ªæ–¹é¢è€ƒè™‘ï¼Œæ”¶å‘è¿›ç¨‹éƒ½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œç½‘ç»œèµ°çš„æ˜¯loopback deviceäº†ï¼Œè¿›ç¨‹è°ƒåº¦çš„å½±å“å¯èƒ½ä¼šæ›´å¤§ä¸€ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„å¤„ç†å™¨ä¸ªæ•°ï¼Œå…¶ä»–ç›¸å…³çš„è¿›ç¨‹ï¼Œç”šè‡³äº‘æœºå™¨çš„HVçš„loadéƒ½æœ‰å¯èƒ½æœ‰å½±å“ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2070138","ctime":1647784413,"ip_address":"","comment_id":337934,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1647164498","product_id":100063801,"comment_content":"æ™•ï¼Œæˆ‘æœ‰ä¸ªé—®é¢˜ã€‚ æˆ‘å‘ç° æˆ‘åªæœ‰ä¸€å°ç‰©ç†&#47;äº‘æœºå™¨ï¼Œæˆ‘åœ¨å…¶ä¸Šå¯åŠ¨äº†netserverï¼Œç„¶åå¯åŠ¨äº†æµ‹è¯•å®¹å™¨lat-test-1ã€‚ä½¿ç”¨netperfï¼Œæˆ‘åœ¨å®¹å™¨ä¸­è¯·æ±‚æœºå™¨ipæµ‹è¯•å’Œ åœ¨ æœºå™¨ä¸Šè¯·æ±‚è‡ªå·±IPæµ‹è¯•ï¼Œæƒ…å†µ åè€…çš„å»¶æ—¶åè€Œæ›´å¤§äº†ã€‚ã€‚ã€‚ è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557385,"discussion_content":"è¿™ä¸ªå¯ä»¥ä»å‡ ä¸ªæ–¹é¢è€ƒè™‘ï¼Œæ”¶å‘è¿›ç¨‹éƒ½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œç½‘ç»œèµ°çš„æ˜¯loopback deviceäº†ï¼Œè¿›ç¨‹è°ƒåº¦çš„å½±å“å¯èƒ½ä¼šæ›´å¤§ä¸€ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„å¤„ç†å™¨ä¸ªæ•°ï¼Œå…¶ä»–ç›¸å…³çš„è¿›ç¨‹ï¼Œç”šè‡³äº‘æœºå™¨çš„HVçš„loadéƒ½æœ‰å¯èƒ½æœ‰å½±å“ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1647784413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1739621,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/8b/65/0f1f9a10.jpg","nickname":"å°Y","note":"","ucode":"24A43BB71805F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2070138,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/96/7a/8a14d008.jpg","nickname":"CY","note":"","ucode":"4AF98230985918","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":582497,"discussion_content":"å¥½çš„ï¼Œå—æ•™ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659460856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":557385,"ip_address":"åŒ—äº¬"},"score":582497,"extra":""}]},{"author":{"id":1634585,"avatar":"https://static001.geekbang.org/account/avatar/00/18/f1/19/5ab39436.jpg","nickname":"é™Œè·¯äº¤é›†","note":"","ucode":"DACDD1312106D7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568532,"discussion_content":"è€å¸ˆï¼Œè¯·é—®æœ¬ç« å»¶æ—¶å¯¹æ¯”æ˜¯é€šè¿‡ä»€ä¹ˆè½¯ä»¶æµ‹è¯•çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651156712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}