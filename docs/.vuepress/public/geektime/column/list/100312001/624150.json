{"id":624150,"title":"19ï½œè‡ªæ‰˜ç®¡æ„å»ºï¼šå¦‚ä½•ä½¿ç”¨ Harbor æ­å»ºä¼ä¸šçº§é•œåƒä»“åº“ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘å¸¦ä½ å­¦ä¹ äº† Tekton çš„åŸºæœ¬æ¦‚å¿µä»¥åŠå¦‚ä½•ä½¿ç”¨ Tekton æ„å»ºé•œåƒã€‚è¿™ç§æ–¹æ¡ˆæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥ç›´æ¥åœ¨ Kubernetes é›†ç¾¤ä¸­æ„å»ºï¼Œæˆ‘ä»¬ä¸å†éœ€è¦å•ç‹¬ä¸ºé•œåƒæ„å»ºä»˜è´¹ã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨ä¹‹å‰çš„æ„å»ºæ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬æ˜¯å°†é•œåƒæ¨é€åˆ°äº† Docker Hub é•œåƒä»“åº“ã€‚å®é™…ä¸Šï¼ŒDocker Hub ä¹Ÿæ˜¯ä¸€ä¸ªæ”¶è´¹çš„æœåŠ¡ï¼Œå¯¹äºå…è´¹ç”¨æˆ·æ¥è¯´ï¼Œå®ƒé™åˆ¶æ¯ 6 å°æ—¶æœ€å¤šæ‹‰å– 200 æ¬¡é•œåƒï¼Œæ˜¾ç„¶ï¼Œè¿™å¯¹å›¢é˜Ÿæ¥è¯´æ˜¯å®Œå…¨ä¸å¤Ÿç”¨çš„ã€‚</p><p>åœ¨è¿™èŠ‚è¯¾ï¼Œæˆ‘å°±å¸¦ä½ å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Harbor æ¥æ­å»ºä¼ä¸šçº§çš„é•œåƒä»“åº“ï¼Œå°†å®ƒé›†æˆåˆ°æˆ‘ä»¬ä¸Šä¸€èŠ‚è¯¾åˆ›å»ºçš„ Tekton Pipeline æµç¨‹ä¸­ï¼Œæœ€ç»ˆæ›¿æ¢ Docker Hubï¼Œè¿›ä¸€æ­¥é™ä½é•œåƒå­˜å‚¨çš„æˆæœ¬ã€‚æ­¤å¤–ï¼Œåœ¨å®‰è£… Harbor çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘è¿˜ä¼šé¦–æ¬¡ä»‹ç» Helm å·¥å…·çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><p>åœ¨å¼€å§‹ä»Šå¤©çš„å­¦ä¹ ä¹‹å‰ï¼Œä½ éœ€è¦æŒ‰ç…§ä¸Šä¸€èŠ‚è¯¾çš„å†…å®¹å‡†å¤‡å¥½ä¸€ä¸ªäº‘å‚å•†çš„ Kubernetes é›†ç¾¤ï¼Œå®‰è£… Ingress-Nginx å’Œ Tektonï¼Œå¹¶é…ç½®å¥½ Pipeline å’Œ GitHub Webookã€‚</p><p>æ­¤å¤–ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼ŒHarbor ä¸€èˆ¬éƒ½ä¼šå¼€å¯ TLSï¼Œ<strong>æ‰€ä»¥ä½ è¿˜éœ€è¦å‡†å¤‡ä¸€ä¸ªå¯ç”¨çš„åŸŸåã€‚</strong></p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬è¿›å…¥ä»Šå¤©çš„å®æˆ˜ç¯èŠ‚ã€‚</p><h2>å®‰è£… Helm</h2><p>åœ¨æˆ‘ä»¬ä¹‹å‰çš„å®è·µä¸­ï¼Œåƒæ˜¯å®‰è£… Tekton å’Œ Ingress-Nginx éƒ½æ˜¯é€šè¿‡ Kubernetes Manifest æ¥å®Œæˆçš„ã€‚å®é™…ä¸Šï¼Œå®‰è£… Kubernetes åº”ç”¨å¹¶ä¸åªæœ‰ä¸€ç§æ–¹æ¡ˆï¼Œè¿™é‡Œæˆ‘ä»¬ä»‹ç»ç¬¬äºŒç§æ–¹æ¡ˆã€‚<strong>Helm</strong>ã€‚</p><!-- [[[read_end]]] --><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å…ˆå­¦ä¼šä½¿ç”¨Helmå°±å¯ä»¥äº†ï¼Œæ›´è¯¦ç»†çš„å†…å®¹æˆ‘ä»¬ä¼šåœ¨åç»­çš„è¯¾ç¨‹åšä»‹ç»ã€‚</p><p>è¦ä½¿ç”¨ Helmï¼Œé¦–å…ˆéœ€è¦å®‰è£…å®ƒï¼Œä½ å¯ä»¥é€šè¿‡<a href=\"https://helm.sh/docs/intro/install/\">è¿™ä¸ªé“¾æ¥</a>æŸ¥çœ‹ä¸åŒå¹³å°çš„å®‰è£…æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨å®˜æ–¹æä¾›çš„è„šæœ¬æ¥å®‰è£…ã€‚</p><pre><code class=\"language-powershell\">$ curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash\n</code></pre><p>å®‰è£…å¥½ Helm ä¹‹åï¼Œåœ¨æ­£å¼ä½¿ç”¨ä¹‹å‰ï¼Œä½ è¿˜è¦ç¡®ä¿æœ¬åœ° Kubectl å’Œé›†ç¾¤çš„è¿é€šæ€§ï¼ŒHelm å’Œ Kubectl é»˜è®¤è¯»å–çš„ Kubeconfig æ–‡ä»¶è·¯å¾„éƒ½æ˜¯ ~/.kube/configã€‚</p><h2>å®‰è£… Cert-manager</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å®‰è£… Cert-managerï¼Œå®ƒä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç­¾å‘å…è´¹çš„ Letâ€™s Encrypt HTTPS è¯ä¹¦ï¼Œå¹¶åœ¨è¿‡æœŸå‰è‡ªåŠ¨ç»­æœŸã€‚</p><p>é¦–å…ˆï¼Œè¿è¡Œ helm repo add å‘½ä»¤æ·»åŠ å®˜æ–¹ Helm ä»“åº“ã€‚</p><pre><code class=\"language-powershell\">$ helm repo add jetstack https://charts.jetstack.io\n\"jetstack\" has been added to your repositories\n</code></pre><p>ç„¶åï¼Œè¿è¡Œ helm repo update æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚</p><pre><code class=\"language-powershell\">$ helm repo update\n...Successfully got an update from the \"jetstack\" chart repository\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œè¿è¡Œ helm install æ¥å®‰è£… Cert-managerã€‚</p><pre><code class=\"language-powershell\">$ helm install cert-manager jetstack/cert-manager \\\n--namespace cert-manager \\\n--create-namespace \\\n--version v1.10.0 \\\n--set ingressShim.defaultIssuerName=letsencrypt-prod \\\n--set ingressShim.defaultIssuerKind=ClusterIssuer \\\n--set ingressShim.defaultIssuerGroup=cert-manager.io \\\n--set installCRDs=true\n\nNAME: cert-manager\nLAST DEPLOYED: Mon Oct 17 21:26:44 2022\nNAMESPACE: cert-manager\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\ncert-manager v1.10.0 has been deployed successfully!\n</code></pre><p>æ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸º Cert-manager åˆ›å»º ClusterIssuerï¼Œç”¨æ¥æä¾›ç­¾å‘æœºæ„ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º cluster-issuer.yamlã€‚</p><pre><code class=\"language-powershell\">apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    server: https://acme-v02.api.letsencrypt.org/directory\n    email: \"wangwei@gmail.com\"\n    privateKeySecretRef:\n      name: letsencrypt-prod\n    solvers:    \n    - http01:\n        ingress:\n          class: nginx\n</code></pre><p><strong>æ³¨æ„ï¼Œè¿™é‡Œä½ éœ€è¦å°† spec.acme.email æ›¿æ¢ä¸ºä½ çœŸå®çš„é‚®ç®±åœ°å€ã€‚</strong>ç„¶åè¿è¡Œ kubectl apply æäº¤åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-powershell\">$ kubectl apply -f cluster-issuer.yaml\nclusterissuer.cert-manager.io/letsencrypt-prod created\n</code></pre><p>åˆ°è¿™é‡Œï¼ŒCert-manager å°±å·²ç»é…ç½®å¥½äº†ã€‚</p><h2>å®‰è£…å’Œé…ç½® Harbor</h2><h3>å®‰è£… Harbor</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬åŒæ ·ä½¿ç”¨ Helm æ¥å®‰è£… Harborï¼Œé¦–å…ˆæ·»åŠ  Harbor å®˜æ–¹ä»“åº“ã€‚</p><pre><code class=\"language-powershell\">$ helm repo add harbor https://helm.goharbor.io\n\"harbor\" has been added to your repositories\n</code></pre><p>ç„¶åï¼Œæ›´æ–°æœ¬åœ° Helm ç¼“å­˜ã€‚</p><pre><code class=\"language-powershell\">$ helm repo update\n...Successfully got an update from the \"jetstack\" chart repository\n...Successfully got an update from the \"harbor\" chart repository\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œç”±äºæˆ‘ä»¬éœ€è¦å®šåˆ¶åŒ–å®‰è£… Harborï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ Harbor çš„å®‰è£…å‚æ•°ï¼Œå°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º values.yamlã€‚</p><pre><code class=\"language-yaml\">expose:\n  type: ingress\n  tls:\n    enabled: true\n    certSource: secret\n    secret:\n      secretName: \"harbor-secret-tls\"\n      notarySecretName: \"notary-secret-tls\"\n  ingress:\n    hosts:\n      core: harbor.n7t.dev\n      notary: notary.n7t.dev\n    className: nginx\n    annotations:\n      kubernetes.io/tls-acme: \"true\"\npersistence:\n  persistentVolumeClaim:\n    registry:\n      size: 20Gi\n    chartmuseum:\n      size: 10Gi\n    jobservice:\n      jobLog:\n        size: 10Gi\n      scanDataExports:\n        size: 10Gi\n    database:\n      size: 10Gi\n    redis:\n      size: 10Gi\n    trivy:\n      size: 10Gi\n</code></pre><p>æ³¨æ„ï¼Œç”±äºè…¾è®¯äº‘çš„ PVC æœ€å° 10G èµ·å”®ï¼Œæ‰€ä»¥ï¼Œé™¤äº† registry çš„å®¹é‡ä»¥å¤–ï¼Œæˆ‘å°†å®‰è£…å‚æ•°ä¸­å…¶ä»–çš„æŒä¹…åŒ–å·å®¹é‡éƒ½é…ç½®ä¸ºäº† 10Gï¼Œä½ å¯ä»¥æ ¹æ®å®‰è£…é›†ç¾¤çš„å®é™…æƒ…å†µåšè°ƒæ•´ã€‚</p><p>å¦å¤–ï¼Œæˆ‘è¿˜ä¸º Harbor é…ç½®äº† ingress è®¿é—®åŸŸåï¼Œåˆ†åˆ«æ˜¯ harbor.n7t.dev å’Œ notary.n7t.devï¼Œ<strong>ä½ éœ€è¦å°†å®ƒä»¬åˆ†åˆ«æ›¿æ¢æˆä½ çš„çœŸå®åŸŸåã€‚</strong></p><p>ç„¶åï¼Œå†é€šè¿‡ helm install å‘½ä»¤æ¥å®‰è£… Harborï¼Œ<strong>å¹¶æŒ‡å®šå‚æ•°é…ç½®æ–‡ä»¶ values.yaml</strong>ã€‚</p><pre><code class=\"language-powershell\">$ helm install harbor harbor/harbor -f values.yaml --namespace harbor --create-namespace\nNAME: harbor\nLAST DEPLOYED: Mon Oct 17 21:53:28 2022\nNAMESPACE: harbor\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nPlease wait for several minutes for Harbor deployment to complete.\nThen you should be able to visit the Harbor portal at https://core.harbor.domain\nFor more details, please visit https://github.com/goharbor/harbor\n</code></pre><p>ç­‰å¾…æ‰€æœ‰ Pod å¤„äºå°±ç»ªçŠ¶æ€ã€‚</p><pre><code class=\"language-powershell\">$ kubectl wait --for=condition=Ready pods --all -n harbor --timeout 600s\npod/cm-acme-http-solver-4v4zz condition met\npod/harbor-chartmuseum-79f49f5b4-8f4mb condition met\npod/harbor-core-6c6bc7fb4f-4822f condition met\npod/harbor-database-0 condition met\npod/harbor-jobservice-85d448d5c9-gn5pk condition met\npod/harbor-notary-server-848bcc7ccd-m5m5v condition met\npod/harbor-notary-signer-6897444589-6vssq condition met\npod/harbor-portal-588b64cbdb-gqlbn condition met\npod/harbor-redis-0 condition met\npod/harbor-registry-5c7d58c87c-6bgsj condition met\npod/harbor-trivy-0 condition met\n</code></pre><p>åˆ°è¿™é‡Œï¼ŒHarbor å°±å·²ç»å®‰è£…å®Œæˆäº†ã€‚</p><h3>é…ç½® DNS è§£æ</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºåŸŸåé…ç½® DNS è§£æã€‚é¦–å…ˆï¼Œè·å– Ingress-Nginx Loadbalancer çš„å¤–ç½‘ IPã€‚</p><pre><code class=\"language-powershell\">$ kubectl get services --namespace ingress-nginx ingress-nginx-controller --output jsonpath='{.status.loadBalancer.ingress[0].ip}'\n43.135.82.249\n</code></pre><p>ç„¶åï¼Œä¸ºåŸŸåé…ç½® DNS è§£æã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘éœ€è¦åˆ†åˆ«ä¸º harbor.n7t.dev å’Œ notary.n7t.dev é…ç½® A è®°å½•ï¼Œå¹¶æŒ‡å‘ 43.135.82.249ã€‚</p><h3>è®¿é—® Harbor Dashboard</h3><p>åœ¨è®¿é—® Harbor Dashboard ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬è¦ç¡®è®¤ Cert-manager æ˜¯å¦å·²ç»æˆåŠŸç­¾å‘äº† HTTPS è¯ä¹¦ï¼Œä½ å¯ä»¥é€šè¿‡ kubectl get certificate å‘½ä»¤æ¥ç¡®è®¤ã€‚</p><pre><code class=\"language-yaml\">$ kubectl get certificate -A&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\nNAMESPACE&nbsp; &nbsp;NAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; READY&nbsp; &nbsp;SECRET&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AGE\nharbor&nbsp; &nbsp; &nbsp; harbor-secret-tls&nbsp; &nbsp;True&nbsp; &nbsp; harbor-secret-tls&nbsp; &nbsp;8s\nharbor&nbsp; &nbsp; &nbsp; notary-secret-tls&nbsp; &nbsp;True&nbsp; &nbsp; notary-secret-tls&nbsp; &nbsp;8s\n</code></pre><p>ç”±äºæˆ‘ä»¬åœ¨éƒ¨ç½² Harbor çš„æ—¶å€™éœ€è¦é…ç½®ä¸¤ä¸ªåŸŸåï¼Œæ‰€ä»¥è¿™é‡Œä¼šå‡ºç°ä¸¤ä¸ªè¯ä¹¦ã€‚å½“è¿™ä¸¤ä¸ªè¯ä¹¦çš„ Ready çŠ¶æ€éƒ½ä¸º True æ—¶ï¼Œè¯´æ˜ HTTPS è¯ä¹¦å·²ç»ç­¾å‘æˆåŠŸäº†ã€‚æ­¤å¤–ï¼Œ<strong>Cert-manager è‡ªåŠ¨ä» Ingress å¯¹è±¡ä¸­è¯»å–äº† tls é…ç½®</strong>ï¼Œè¿˜è‡ªåŠ¨åˆ›å»ºäº†åä¸º harbor-secret-tls å’Œ notary-secret-tls ä¸¤ä¸ªåŒ…å«è¯ä¹¦ä¿¡æ¯çš„ Secretã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæ‰“å¼€ <a href=\"https://harbor.n7t.dev\">https://harbor.n7t.dev</a> è¿›å…¥ Harbor Dashboardï¼Œä½¿ç”¨é»˜è®¤è´¦å· admin å’Œ Harbor12345 å³å¯ç™»å½•æ§åˆ¶å°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/36/06/366ca200b019c17960c1c44032a3cf06.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>Harbor å·²ç»è‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºäº† library é¡¹ç›®ï¼Œæˆ‘ä»¬åœ¨åç»­çš„é˜¶æ®µå°†ç›´æ¥ä½¿ç”¨å®ƒã€‚</p><h3>æ¨é€é•œåƒæµ‹è¯•</h3><p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥å°è¯•å°†æœ¬åœ°çš„é•œåƒæ¨é€åˆ° Harbor ä»“åº“ã€‚é¦–å…ˆï¼Œåœ¨æœ¬åœ°æ‹‰å– busybox é•œåƒã€‚</p><pre><code class=\"language-yaml\">$ docker pull busybox\nUsing default tag: latest\nlatest: Pulling from library/busybox\nf5b7ce95afea: Pull complete\nDigest: sha256:9810966b5f712084ea05bf28fc8ba2c8fb110baa2531a10e2da52c1efc504698\nStatus: Downloaded newer image for busybox:latest\ndocker.io/library/busybox:latest\n</code></pre><p>ç„¶åï¼Œè¿è¡Œ docker login å‘½ä»¤ç™»å½•åˆ° Harbor ä»“åº“ï¼Œä½¿ç”¨é»˜è®¤çš„è´¦å·å¯†ç ã€‚</p><pre><code class=\"language-yaml\">$ docker login harbor.n7t.dev\nusername: admin\npassword: Harbor12345\nLogin Succeeded\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œé‡æ–°ç»™ busybox é•œåƒæ‰“æ ‡ç­¾ï¼ŒæŒ‡å‘ Harbor é•œåƒä»“åº“ã€‚</p><pre><code class=\"language-yaml\">$ docker tag busybox:latest harbor.n7t.dev/library/busybox:latest\n</code></pre><p>å’Œæ¨é€åˆ° Docker Hub çš„ Tag ç›¸æ¯”ï¼Œæ¨é€åˆ° Harbor éœ€è¦æŒ‡å®šå®Œæ•´çš„<strong>é•œåƒä»“åº“åœ°å€ã€é¡¹ç›®åå’Œé•œåƒå</strong>ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨äº†é»˜è®¤çš„ library é¡¹ç›®ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶å°† library æ›¿æ¢ä¸ºæ–°çš„é¡¹ç›®åã€‚</p><p>æœ€åï¼Œå°†é•œåƒæ¨é€åˆ°ä»“åº“ã€‚</p><pre><code class=\"language-yaml\">$ docker push harbor.n7t.dev/library/busybox:latest\nThe push refers to repository [harbor.n7t.dev/library/busybox]\n0b16ab2571f4: Pushed\nlatest: digest: sha256:7bd0c945d7e4cc2ce5c21d449ba07eb89c8e6c28085edbcf6f5fa4bf90e7eedc size: 527\n</code></pre><p>é•œåƒæ¨é€æˆåŠŸåï¼Œè®¿é—® Harbor æ§åˆ¶å°ï¼Œè¿›å…¥ library é¡¹ç›®è¯¦æƒ…ï¼Œä½ å°†çœ‹åˆ°æˆ‘ä»¬åˆšæ‰æ¨é€çš„é•œåƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/fc/c1/fc9bc8754c476e31937fdf269d4c25c1.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼ŒHarbor é•œåƒä»“åº“å°±å·²ç»é…ç½®å¥½äº†ã€‚</p><h2>åœ¨ Tekton Pipeline ä¸­ä½¿ç”¨ Harbor</h2><p>è¦åœ¨ Tekton Pipeline ä¸­ä½¿ç”¨ Harborï¼Œæˆ‘ä»¬éœ€è¦å°† Pipeline ä¸­çš„ spec.params.registry_url å˜é‡å€¼ç”± docker.io ä¿®æ”¹ä¸º harbor.n7t.devï¼Œå¹¶ä¸”å°† spec.params.registry_mirror å˜é‡å€¼ä¿®æ”¹ä¸º libraryã€‚ä½ å¯ä»¥ä½¿ç”¨ kubectl edit å‘½ä»¤æ¥ä¿®æ”¹ã€‚</p><pre><code class=\"language-yaml\">$ kubectl edit Pipeline github-trigger-pipeline\n......\n&nbsp; params:\n&nbsp; - default: harbor.n7t.dev  # ä¿®æ”¹ä¸º harbor.n7t.dev\n&nbsp; &nbsp; name: registry_url\n&nbsp; &nbsp; type: string\n  - default: \"library\"  # ä¿®æ”¹ä¸º library\n&nbsp; &nbsp; name: registry_mirror\n&nbsp; &nbsp; type: string\n\npipeline.tekton.dev/github-trigger-pipeline edited\n</code></pre><p>ï¼ˆæç¤ºï¼šæŒ‰ä¸‹ i è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œä¿®æ”¹å®Œæˆåï¼ŒæŒ‰ä¸‹ ESC é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œç„¶åè¾“å…¥ :wq ä¿å­˜ç”Ÿæ•ˆã€‚ï¼‰</p><p>ç„¶åï¼Œå†ä¿®æ”¹é•œåƒä»“åº“çš„å‡­æ®ï¼Œä¹Ÿå°±æ˜¯ registry-auth Secretã€‚</p><pre><code class=\"language-yaml\">$ kubectl edit secret registry-auth\napiVersion: v1\ndata:\n&nbsp; password: SGFyYm9yMTIzNDUK   # ä¿®æ”¹ä¸º Base64 ç¼–ç ï¼šHarbor12345\n&nbsp; username: YWRtaW4K           # ä¿®æ”¹ä¸º Base64 ç¼–ç ï¼šadmin\nkind: Secret\n\nsecret/registry-auth edited\n</code></pre><p>ä¿å­˜åç”Ÿæ•ˆã€‚</p><p>ç°åœ¨ï¼Œå›åˆ°æœ¬åœ°ç¤ºä¾‹åº”ç”¨ kubernetes-example ç›®å½•ï¼Œå‘ä»“åº“æ¨é€ä¸€ä¸ªç©ºçš„ commit æ¥è§¦å‘ Tekton æµæ°´çº¿ã€‚</p><pre><code class=\"language-yaml\">$ git commit --allow-empty -m \"Trigger Build\"\n[main e42ac45] Trigger Build\n\n$ git push origin main\n</code></pre><p>è¿›å…¥ Tekton Dashboard <a href=\"http://tekton.k8s.local/\">http://tekton.k8s.local/</a>ï¼Œå¹¶æŸ¥çœ‹æµæ°´çº¿è¿è¡ŒçŠ¶æ€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/08/66/087705da1bce016491b814faa355ef66.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>å½“æµæ°´çº¿è¿è¡Œç»“æŸåï¼Œæˆ‘ä»¬è¿›å…¥ Harbor Dashboard ä¼šçœ‹åˆ°åˆšæ‰ Tekton æ¨é€çš„æ–°é•œåƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d4/cc/d494cc826214ec0bcd4e069a575a37cc.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼ŒHarbor çš„å®‰è£…å’Œé…ç½®å°±å®Œæˆäº†ã€‚åœ¨æœ€å¼€å§‹ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡æœ€å°åŒ–çš„é…ç½®å®‰è£… Harborï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½ å¯èƒ½éœ€è¦æ³¨æ„ä¸€äº›é¢å¤–çš„é…ç½®ã€‚</p><h2>Harbor ç”Ÿäº§å»ºè®®</h2><p>Harbor çš„å®‰è£…é…ç½®ç›¸å¯¹è¾ƒå¤šï¼Œè¿™é‡Œæˆ‘ä¹Ÿæä¾›å‡ ç‚¹ç”Ÿäº§å»ºè®®ä¾›ä½ å‚è€ƒã€‚</p><ol>\n<li>ç¡®è®¤ PVC æ˜¯å¦æ”¯æŒåœ¨çº¿æ‰©å®¹ã€‚</li>\n<li>å°½é‡ä½¿ç”¨ S3 ä½œä¸ºé•œåƒå­˜å‚¨ç³»ç»Ÿã€‚</li>\n<li>ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å’Œ Redisã€‚</li>\n<li>å¼€å¯è‡ªåŠ¨é•œåƒæ‰«æå’Œé˜»æ­¢æ¼æ´é•œåƒã€‚</li>\n</ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹æ¯ä¸€é¡¹è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚</p><h3>ç¡®è®¤ PVC æ˜¯å¦æ”¯æŒåœ¨çº¿æ‰©å®¹</h3><p>å¦‚æœä½ æ˜¯æŒ‰ç…§è¿™èŠ‚è¯¾çš„å®‰è£…æ–¹å¼ä½¿ç”¨ PVC æŒä¹…å·æ¥å­˜å‚¨é•œåƒçš„ï¼Œé‚£ä¹ˆéšç€é•œåƒæ•°é‡çš„å¢åŠ ï¼Œä½ éœ€è¦é¢å¤–æ³¨æ„ Harbor ä»“åº“å­˜å‚¨å®¹é‡çš„é—®é¢˜ã€‚</p><p>ä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆæ˜¯åœ¨ Harbor å®‰è£…å‰ï¼Œæå‰ç¡®è®¤ StorageClass æ˜¯å¦æ”¯æŒåœ¨çº¿æ‰©å®¹ï¼Œä»¥ä¾¿åç»­å¯¹å­˜å‚¨é•œåƒçš„æŒä¹…å·è¿›è¡ŒåŠ¨æ€æ‰©å®¹ã€‚ä½ å¯ä»¥ä½¿ç”¨ kubectl get storageclass å‘½ä»¤æ¥ç¡®è®¤ã€‚</p><pre><code class=\"language-yaml\">$ kubectl get storageclass\nNAME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PROVISIONER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RECLAIMPOLICY&nbsp; &nbsp;VOLUMEBINDINGMODE&nbsp; &nbsp;ALLOWVOLUMEEXPANSION&nbsp; &nbsp;AGE\ncbs (default)&nbsp; &nbsp;com.tencent.cloud.csi.cbs&nbsp; &nbsp;Delete&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Immediate&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;true\n</code></pre><p>åœ¨è¿”å›å†…å®¹ä¸­ï¼Œå¦‚æœ ALLOWVOLUMEEXPANSION ä¸º trueï¼Œå°±è¯´æ˜æ”¯æŒåœ¨çº¿æ‰©å®¹ã€‚å¦åˆ™ï¼Œä½ éœ€è¦æ‰‹åŠ¨ä¸º StorageClass æ·»åŠ  AllowVolumeExpansion å­—æ®µã€‚</p><pre><code class=\"language-yaml\">$ kubectl patch storageclass cbs -p '{\"allowVolumeExpansion\": true}'\n</code></pre><h3>æ¨èä½¿ç”¨ S3 å­˜å‚¨é•œåƒ</h3><p>é™¤äº†ä½¿ç”¨æŒä¹…å·æ¥å­˜å‚¨é•œåƒä»¥å¤–ï¼ŒHarbor è¿˜æ”¯æŒå¤–éƒ¨å­˜å‚¨ã€‚å¦‚æœä½ å¸Œæœ›å¤§è§„æ¨¡ä½¿ç”¨ Harbor åˆä¸æƒ³å…³æ³¨å­˜å‚¨é—®é¢˜ï¼Œé‚£ä¹ˆä½¿ç”¨å¤–éƒ¨å­˜å‚¨æ˜¯ä¸€ä¸ªéå¸¸çš„é€‰æ‹©ã€‚ä¾‹å¦‚ä½¿ç”¨ AWS S3 å­˜å‚¨æ¡¶æ¥å­˜å‚¨é•œåƒã€‚</p><p>S3 å­˜å‚¨æ–¹æ¡ˆçš„ä¼˜åŠ¿æ˜¯ï¼Œå®ƒèƒ½ä¸ºæˆ‘ä»¬æä¾›æ¥è¿‘æ— é™å­˜å‚¨å®¹é‡çš„å­˜å‚¨ç³»ç»Ÿï¼Œå¹¶ä¸”æŒ‰é‡è®¡è´¹çš„æ–¹å¼æˆæœ¬ä¹Ÿç›¸å¯¹å¯æ§ï¼ŒåŒæ—¶å®ƒè¿˜å…·å¤‡é«˜å¯ç”¨æ€§å’Œå®¹ç¾èƒ½åŠ›ã€‚</p><p>è¦ä½¿ç”¨ S3 æ¥å­˜å‚¨é•œåƒï¼Œä½ éœ€è¦åœ¨å®‰è£…æ—¶ä¿®æ”¹ Harbor çš„å®‰è£…é…ç½® values.yamlã€‚</p><pre><code class=\"language-yaml\">expose:\n  type: ingress\n  tls:\n    enabled: true\n    certSource: secret\n    secret:\n      secretName: \"harbor-secret-tls\"\n      notarySecretName: \"notary-secret-tls\"\n  ingress:\n    hosts:\n      core: harbor.n7t.dev\n      notary: notary.n7t.dev\n    className: nginx\n    annotations:\n      kubernetes.io/tls-acme: \"true\"\npersistence:\n  imageChartStorage:\n    type: s3\n    s3:\n      region: us-west-1\n      bucket: bucketname\n      accesskey: AWS_ACCESS_KEY_ID\n      secretkey: AWS_SECRET_ACCESS_KEY\n      rootdirectory: /harbor\n  persistentVolumeClaim:\n    chartmuseum:\n      size: 10Gi\n    jobservice:\n      jobLog:\n        size: 10Gi\n      scanDataExports:\n        size: 10Gi\n     ......\n</code></pre><p>æ³¨æ„ï¼Œè¦å°† S3 ç›¸å…³é…ç½® regionã€bucketã€accesskeyã€secretkey å’Œ rootdirectory å­—æ®µä¿®æ”¹ä¸ºå®é™…çš„å€¼ã€‚</p><p>ç„¶åï¼Œå†ä½¿ç”¨ helm install -f values.yaml æ¥å®‰è£…ã€‚</p><h3>ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å’Œ Redis</h3><p>åœ¨å®‰è£… Harbor æ—¶ï¼Œä¼šé»˜è®¤è‡ªåŠ¨å®‰è£…æ•°æ®åº“å’Œ Redisã€‚ä½†æ˜¯ä¸ºäº†ä¿è¯ç¨³å®šæ€§å’Œé«˜å¯ç”¨ï¼Œæˆ‘å»ºè®®ä½ ä½¿ç”¨äº‘å‚å•†æä¾›çš„ Postgres å’Œ Redis æ‰˜ç®¡æœåŠ¡ã€‚</p><p>è¦ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å’Œ Redisï¼Œä½ åŒæ ·å¯ä»¥åœ¨ values.yaml æ–‡ä»¶ä¸­ç›´æ¥æŒ‡å®šã€‚</p><pre><code class=\"language-yaml\">expose:\n  type: ingress\n  tls:\n    enabled: true\n    certSource: secret\n    secret:\n      secretName: \"harbor-secret-tls\"\n      notarySecretName: \"notary-secret-tls\"\n  ingress:\n    hosts:\n      core: harbor.n7t.dev\n      notary: notary.n7t.dev\n    className: nginx\n    annotations:\n      kubernetes.io/tls-acme: \"true\"\ndatabase:\n  type: external\n  external:\n\thost: \"192.168.0.1\"\n\tport: \"5432\"\n\tusername: \"user\"\n    password: \"password\"\n\tcoreDatabase: \"registry\"\n\tnotaryServerDatabase: \"notary_server\"\n\tnotarySignerDatabase: \"notary_signer\"\nredis:\n  type: external\n  external:\n\taddr: \"192.168.0.2:6379\"\n    password: \"\"\npersistence:\n  ......\n</code></pre><p>æ³¨æ„ï¼Œè¦å°† database å’Œ redis å­—æ®µçš„è¿æ¥ä¿¡æ¯ä¿®æ”¹ä¸ºå®é™…çš„å†…å®¹ï¼Œå¹¶æå‰åˆ›å»ºå¥½ registryã€notary_server å’Œ notary_signer æ•°æ®åº“ã€‚</p><h3>å¼€å¯è‡ªåŠ¨é•œåƒæ‰«æå’Œé˜»æ­¢æ¼æ´é•œåƒ</h3><p>æœ€åä¸€ä¸ªå»ºè®®ã€‚ç”±äºHarbor è‡ªå¸¦ Trivy é•œåƒæ‰«æåŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘ç°é•œåƒçš„æ¼æ´ï¼Œå¹¶æä¾›ä¿®å¤å»ºè®®ã€‚å› æ­¤åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘æ¨èä½ å¼€å¯â€œè‡ªåŠ¨é•œåƒæ‰«æâ€å’Œâ€œé˜»æ­¢æ½œåœ¨æ¼æ´é•œåƒâ€åŠŸèƒ½ï¼Œä½ å¯ä»¥è¿›å…¥é¡¹ç›®çš„â€œé…ç½®ç®¡ç†â€èœå•å¼€å¯å®ƒä»¬ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ac/10/acde313e0579f068321064576ac5fb10.png?wh=1920x1108\" alt=\"å›¾ç‰‡\"></p><p>å¼€å¯â€œè‡ªåŠ¨æ‰«æé•œåƒâ€åŠŸèƒ½åï¼Œæ‰€æœ‰æ¨é€åˆ° Harbor çš„é•œåƒéƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œæ‰«æï¼Œä½ å¯ä»¥è¿›å…¥é•œåƒè¯¦æƒ…æŸ¥çœ‹é•œåƒæ¼æ´æ•°é‡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/db/3bba757da66a4e0d2929d66a4b3116db.png?wh=1920x441\" alt=\"å›¾ç‰‡\"></p><p>è¿›å…¥â€œArtifactsâ€è¯¦æƒ…å¯ä»¥æŸ¥çœ‹æ¼æ´è¯¦æƒ…å’Œä¿®å¤å»ºè®®ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8b/96/8b3d0ac5a486edd9be0d70646160c796.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>å¼€å¯â€œé˜»æ­¢æ½œåœ¨æ¼æ´é•œåƒâ€åŠŸèƒ½ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•åœ¨æœ¬åœ°æ‹‰å– frontend é•œåƒï¼Œä¼šå‘ç° Harbor é˜»æ­¢äº†è¿™ä¸ªè¡Œä¸ºã€‚</p><pre><code class=\"language-powershell\">$ docker pull harbor.n7t.dev/library/frontend:8d64515\nError response from daemon: unknown: current image with 14 vulnerabilities cannot be pulled due to configured policy in 'Prevent images with vulnerability severity of \"Low\" or higher from running.' To continue with pull, please contact your project administrator to exempt matched vulnerabilities through configuring the CVE allowlist.\n</code></pre><h2>æ€»ç»“</h2><p>åœ¨è¿™èŠ‚è¯¾ï¼Œæˆ‘å‘ä½ ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ Harbor æ­å»ºä¼ä¸šçº§é•œåƒä»“åº“ï¼Œåœ¨å®‰è£… Harbor çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘è¿˜ç®€å•ä»‹ç»äº† Helm å·¥å…·çš„ä½¿ç”¨æ–¹æ³•ï¼ŒåŒ…æ‹¬æ·»åŠ  Helm ä»“åº“å’Œå®‰è£…åº”ç”¨ã€‚</p><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨ HTTPS åè®®æ¥åŠ å¯†è®¿é—®è¯·æ±‚ï¼Œæ‰€ä»¥åœ¨å®‰è£… Harbor ä¹‹å‰ï¼Œæˆ‘å‘ä½ ä»‹ç»äº† Cert-manager ç»„ä»¶ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨ç­¾å‘ Letâ€™s Encrypt HTTPS è¯ä¹¦ï¼Œå¹¶æŒ‰ç…§ Ingress çš„é…ç½®ç”Ÿæˆ Secretã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒLetâ€™s Encrypt è¯ä¹¦çš„æœ‰æ•ˆæœŸæ˜¯ 90 å¤©ï¼Œä¸è¿‡ Cert-manager åœ¨åˆ°æœŸå‰ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ç»­æœŸï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</p><p>å…¶æ¬¡ï¼Œæˆ‘è¿˜ä»‹ç»äº†å¦‚ä½•åœ¨ Tekton Pipeline ä¸­ä½¿ç”¨ Harborï¼Œè¿™é‡Œçš„é‡ç‚¹æ˜¯è¦ä¿®æ”¹ Pipeline çš„ä»“åº“åœ°å€ä»¥åŠåœ¨ Secret ä¸­é…ç½®çš„é•œåƒä»“åº“ç”¨æˆ·åå’Œå¯†ç ï¼Œä»¥ä¾¿ Tekton èƒ½é¡ºåˆ©åœ°å°†é•œåƒæ¨é€åˆ° Harbor ä»“åº“ä¸­ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå½“æˆ‘ä»¬å°†é•œåƒæ¨é€åˆ° Docker Hub æ—¶ï¼Œåªéœ€è¦åœ¨é•œåƒ Tag å‰é¢åŠ ä¸Šç”¨æˆ·åå‰ç¼€ï¼Œä¾‹å¦‚ lyzhang1999/frontend:latest å³å¯ã€‚ä½†å½“æˆ‘ä»¬éœ€è¦å°†é•œåƒæ¨é€åˆ°å…¶ä»–é•œåƒä»“åº“æ—¶ï¼Œåˆ™éœ€è¦æŠŠ Tag é…ç½®ä¸ºå®Œæ•´çš„åœ°å€ï¼Œä¾‹å¦‚harbor.n7t.dev/library/frontend:latest æ‰èƒ½å¤Ÿæ¨é€ã€‚</p><p>æœ€åï¼Œæˆ‘è¿˜ç»™ä½ æäº† 4 ä¸ª Harbor çš„ç”Ÿäº§å»ºè®®ï¼Œä½ å¯ä»¥ç»“åˆé¡¹ç›®çš„å®é™…æƒ…å†µæ¥é€‰æ‹©æ€§åœ°é‡‡ç”¨ã€‚</p><p>åˆ°è¿™é‡Œï¼Œè‡ªåŠ¨åŒ–é•œåƒæ„å»ºè¿™ä¸ªç« èŠ‚å°±å…¨éƒ¨ç»“æŸäº†ã€‚åœ¨æ¥ä¸‹æ¥çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä¼šä¸ºä½ ä»‹ç» Manifest ä»¥å¤–å…¶ä»–ä¸¤ç§æ›´é«˜çº§çš„åº”ç”¨å®šä¹‰æ ¼å¼ï¼šKustomize å’Œ Helm Chartã€‚æ˜¾ç„¶ï¼Œè¿™èŠ‚è¯¾æåˆ°çš„ Cert-manager å’Œ Harbor å°±æ˜¯ä»¥ Helm Chart çš„æ–¹å¼æ¥å®šä¹‰çš„ã€‚åŒæ—¶ï¼Œæˆ‘ä¹Ÿä¼šå°†ç¤ºä¾‹åº”ç”¨ä»¥è¿™ä¸¤ç§æ–¹å¼è¿›è¡Œå°è£…æ”¹é€ ï¼Œå¸¦ä½ æ·±å…¥äº†è§£ Kubernetes çš„åº”ç”¨å®šä¹‰ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜å§ã€‚</p><p>è¯·ä½ å°è¯•æ”¹é€ <a href=\"https://time.geekbang.org/column/article/622743\">ç¬¬ 16 è®²</a>ä¸­ GitHub Action Workflowï¼Œå®ç°å°†é•œåƒæ¨é€åˆ° Harbor ä¸­ã€‚</p><p>æç¤ºï¼šä¸º docker/login-action@v2 æ’ä»¶å¢åŠ  registry å‚æ•°ï¼Œå¹¶å°† docker/build-push-action@v3 æ’ä»¶çš„ Tag å­—æ®µä¿®æ”¹ä¸ºåŒ…å«å®Œæ•´ Harbor ä»“åº“çš„ URLã€‚</p><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":367276,"user_name":"Noel ZHANG","can_delete":false,"product_type":"c1","uid":1983237,"ip_address":"æ±Ÿè‹","ucode":"DF4E7E1FAFB509","user_header":"https://static001.geekbang.org/account/avatar/00/1e/43/05/3fbf26cf.jpg","comment_is_top":false,"comment_ctime":1675088898,"is_pvip":false,"replies":[{"id":133902,"content":"æ˜¯çš„ï¼Œå¯¹å°å›¢é˜Ÿæ¥è¯´ç›´æ¥ç”¨äº‘å‚å•†çš„é•œåƒä»“åº“æ›´å¥½ï¼Œå…¨æ‰˜ç®¡ã€‚\næœ‰ä¸€äº›å›¢é˜Ÿå¯èƒ½ä¼šè€ƒè™‘å­˜å‚¨æˆæœ¬å’Œé•œåƒæ‰«æå’Œå®‰å…¨æ€§ï¼ŒHarbor åœ¨è¿™å—åšçš„æŒºä¸é”™çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675415219,"ip_address":"å¹¿ä¸œ","comment_id":367276,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"Harboræ­å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨äº†å¤§é‡çš„äº‘å‚å•†ç»„ä»¶ï¼Œè€Œä¸”è¿˜æœ‰æ•°å€çš„è¿ç»´å·¥ä½œã€‚æˆ‘ä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨äº‘å‚å•†çš„é•œåƒåº“ã€‚","like_count":4,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601807,"discussion_content":"æ˜¯çš„ï¼Œå¯¹å°å›¢é˜Ÿæ¥è¯´ç›´æ¥ç”¨äº‘å‚å•†çš„é•œåƒä»“åº“æ›´å¥½ï¼Œå…¨æ‰˜ç®¡ã€‚\næœ‰ä¸€äº›å›¢é˜Ÿå¯èƒ½ä¼šè€ƒè™‘å­˜å‚¨æˆæœ¬å’Œé•œåƒæ‰«æå’Œå®‰å…¨æ€§ï¼ŒHarbor åœ¨è¿™å—åšçš„æŒºä¸é”™çš„ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1675415219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1027152,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ac/50/71c25e34.jpg","nickname":"èµµå…ˆç”Ÿ","note":"","ucode":"A8E7EE3D400698","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603122,"discussion_content":"å°å›¢é˜Ÿçš„è¯ï¼Œk8sçš„Harbor+ceph pvç›´æ¥å°±æ˜¯å¯é æ€§å¾ˆé«˜çš„æœåŠ¡äº†ï¼Œå†æ¥ä¸ªå¤‡ä»½çš„ä»“åº“ï¼Œå°±åŸºæœ¬æ»¡è¶³éœ€æ±‚ï¼Œè·‘èµ·æ¥ä¹‹åæ²¡æœ‰å¤ªå¤šçš„è¿ç»´å·¥ä½œäº†ï¼ŒæŒºçœå¿ƒçš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1675955098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367464,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"åŒ—äº¬","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1675248885,"is_pvip":false,"replies":[{"id":133899,"content":"ğŸ‘ğŸ»å¾ˆå¥½çš„ç»éªŒåˆ†äº«~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675415062,"ip_address":"å¹¿ä¸œ","comment_id":367464,"utype":1}],"discussion_count":2,"race_medal":1,"score":2,"product_id":100312001,"comment_content":"è®°å½•ä¸€æ¬¡éƒ¨ç½²é‡åˆ°çš„é—®é¢˜ï¼š\nå®‰è£… Cert-manageræŒ‡å®šäº†è‡ªå·±çš„email\næˆ‘www.namesilo.comç”³è¯·äº†geekcloudnative.comåŸŸåï¼Œåˆ†åˆ«ä¸ºäºŒçº§åŸŸå `harbor.geekcloudnative.com` å’Œ `notary.geekcloudnative.com` é…ç½® A è®°å½•ï¼Œå¹¶æŒ‡å‘è‡ªå·±çš„ip \nä½†æˆ‘çš„kubectl get certificate -A  çš„READYä¸€ç›´æ˜¯Falseï¼Œ\nNAMESPACE   NAME                READY   SECRET              AGE\nharbor      harbor-secret-tls   False   harbor-secret-tls   29s\nharbor      notary-secret-tls   False   notary-secret-tls   29s\n\nkubectl get certificate -n harbor harbor-secret-tls -oyamlæ˜¾ç¤º message: Issuing certificate as Secret does not existï¼Œ\n\nk  logs cert-manager-5d595f9fdf-mnw9n -n cert-manager å‘ç° ä»¥ä¸‹æŠ¥é”™æ—¥å¿—\nerror&quot;=&quot;failed to perform self check GET request &#39;http:&#47;&#47;harbor.geekcloudnative.com&#47;.well-known&#47;acme-challenge&#47;ldnFkzhB2euqIZdtrTo7-ryM492_HCrmpcnWOBH6TmI&#39;: Get \\&quot;http:&#47;&#47;harbor.geekcloudnative.com&#47;.well-known&#47;acme-challenge&#47;ldnFkzhB2euqIZdtrTo7-ryM492_HCrmpcnWOBH6TmI\\&quot;: dial tcp: lookup harbor.geekcloudnative.com on 172.16.253.166:53: no such host&quot; \n\né€šè¿‡æŠ¥é”™å¯ä»¥åˆ¤æ–­æœ¬åœ°æ²¡æœ‰åšåŸŸåè§£æã€‚åœ¨&#47;etc&#47;hostsæ·»åŠ \n&lt;ip&gt; harbor.geekcloudnative.com notary.geekcloudnative.com\nREADYä¸ºfalseå¾—åˆ°è§£å†³ã€‚","like_count":3,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601804,"discussion_content":"ğŸ‘ğŸ»å¾ˆå¥½çš„ç»éªŒåˆ†äº«~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675415062,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1308196,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","nickname":"ghostwritten","note":"","ucode":"AE512F2E24A1A0","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601541,"discussion_content":"è¿™æ ·åšè™½ç„¶å˜æˆtrueï¼Œä½†ä¼¼ä¹æ˜¯ä¸ªå‡è±¡ï¼Œå¯èƒ½æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºharborç™»é™†ä¸äº†äº†ï¼Œæˆ‘åˆ é™¤äº†/etc/hostsçš„&lt;ip&gt; harbor.geekcloudnative.com notary.geekcloudnative.comï¼Œæˆ‘é‡æ–°éƒ¨ç½²äº†ä¸€éï¼Œä½†æ²¡æœ‰å‘ç°READYå˜æˆfalseçš„é—®é¢˜äº†ã€‚æ˜¯å› ä¸ºæˆ‘åˆšç”³è¯·çš„åŸŸååŸå› å—ï¼Ÿè¿˜æ˜¯ç¬¬ä¸€æ¬¡kubectl apply -f cluster-issuer.yamlçŠ¯è¿‡ä¸€æ¬¡æœªæ”¹emailçš„é—®é¢˜ï¼Œå³ä¾¿ä¿®æ”¹emailå†applyå¹¶æ²¡æœ‰å¯¼è‡´æ•´ä¸ªåº•å±‚è¿æ¥è´¯é€šã€‚ä»å¤´å†æ¥å´éƒ½å¥½äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675266400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369169,"user_name":"éƒ‘æµ·æˆ","can_delete":false,"product_type":"c1","uid":1192616,"ip_address":"åŒ—äº¬","ucode":"B0363EA4B2C646","user_header":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","comment_is_top":false,"comment_ctime":1677198826,"is_pvip":true,"replies":[{"id":134501,"content":"æœ‰å…·ä½“çš„é—®é¢˜æè¿°å—ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1677216654,"ip_address":"å¹¿ä¸œ","comment_id":369169,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆï¼Œä¸éœ€è¦å°†è¯ä¹¦ä¿å­˜åœ¨dockerç›®å½•ä¸‹ï¼Œåˆ›å»ºè·ŸåŸŸåç›¸åŒçš„å­ç›®å½•è¿™ä¸ªæ“ä½œå—ï¼Ÿæˆ‘çœ‹ç²¾é€‰ç•™è¨€ç¬¬ä¸‰æ¡çš„æœ‹å‹ä¹Ÿé‡åˆ°äº†","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606558,"discussion_content":"æœ‰å…·ä½“çš„é—®é¢˜æè¿°å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677216654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1192616,"avatar":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","nickname":"éƒ‘æµ·æˆ","note":"","ucode":"B0363EA4B2C646","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":606589,"discussion_content":"å’ŒgostwrittenåŒå­¦æè¿°çš„ç°è±¡ä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677231012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":606558,"ip_address":"åŒ—äº¬","group_id":0},"score":606589,"extra":""},{"author":{"id":1192616,"avatar":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","nickname":"éƒ‘æµ·æˆ","note":"","ucode":"B0363EA4B2C646","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":606591,"discussion_content":"PS C:\\Users\\Desktop&gt; docker login harbor.gitops.com:31137\nUsername: admin\nPassword:\nError response from daemon: Get &#34;https://harbor.gitops.com:31137/v2/&#34;: Get &#34;https://core.harbor.domain/service/token?account=admin&amp;client_id=docker&amp;offline_token=true&amp;service=harbor-registry&#34;: Failed to lookup host: core.harbor.domain\nPS C:\\Users\\Desktop&gt;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677231669,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":606558,"ip_address":"åŒ—äº¬","group_id":0},"score":606591,"extra":""}]}]},{"had_liked":false,"id":367117,"user_name":"Jich","can_delete":false,"product_type":"c1","uid":2485491,"ip_address":"ä¸Šæµ·","ucode":"7127C10EBB27F0","user_header":"https://static001.geekbang.org/account/avatar/00/25/ec/f3/f140576e.jpg","comment_is_top":false,"comment_ctime":1674959373,"is_pvip":false,"replies":[{"id":133906,"content":"æ£€æŸ¥ä¸€ä¸‹å®‰è£… Cert-manager çš„æ­¥éª¤ä»¥åŠåˆ›å»º ClusterIssuer çš„æ­¥éª¤ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675415480,"ip_address":"å¹¿ä¸œ","comment_id":367117,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"kubectl get certificate æˆ‘æœ¬åœ°æŠ¥ Issuing certificate as Secret does not exist","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601811,"discussion_content":"æ£€æŸ¥ä¸€ä¸‹å®‰è£… Cert-manager çš„æ­¥éª¤ä»¥åŠåˆ›å»º ClusterIssuer çš„æ­¥éª¤ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675415480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366996,"user_name":"æ©™æ±","can_delete":false,"product_type":"c1","uid":1332257,"ip_address":"åŒ—äº¬","ucode":"EC3FF10D708C9D","user_header":"https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg","comment_is_top":false,"comment_ctime":1674784364,"is_pvip":false,"replies":[{"id":133915,"content":"é˜¿é‡Œäº‘æ²¡è¯•è¿‡ï¼Œæœ‰ç»éªŒå¯ä»¥åˆ†äº«å—","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1675416142,"ip_address":"å¹¿ä¸œ","comment_id":366996,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"åœ¨é˜¿é‡Œäº‘çš„k8sä¸Šä½¿ç”¨cert-manageréœ€è¦accesskeyæ¥éªŒè¯åŸŸåå½’å±å’Œdnsè®°å½•éªŒè¯ï¼Œæ–‡ç« é‡Œæ²¡çœ‹åˆ° æ˜¯åŸŸåçš„å…³ç³»å—ï¼Œåç»­è·Ÿè¯¾ç¨‹ä¹ŸéªŒè¯ä¸‹","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601820,"discussion_content":"é˜¿é‡Œäº‘æ²¡è¯•è¿‡ï¼Œæœ‰ç»éªŒå¯ä»¥åˆ†äº«å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367495,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"åŒ—äº¬","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1675262701,"is_pvip":false,"replies":null,"discussion_count":3,"race_medal":1,"score":2,"product_id":100312001,"comment_content":"ç•Œé¢httpså¯ä»¥ç™»é™†ã€‚ä½†å‘½ä»¤è¡Œç™»é™†ï¼šdocker login harbor.geekcloudnative.com -u admin -p Harbor12345\nWARNING! Using --password via the CLI is insecure. Use --password-stdin.\nError response from daemon: Get &quot;https:&#47;&#47;harbor.geekcloudnative.com&#47;v2&#47;&quot;: Get &quot;https:&#47;&#47;core.harbor.domain&#47;service&#47;token?account=admin&amp;client_id=docker&amp;offline_token=true&amp;service=harbor-registry&quot;: dial tcp: lookup core.harbor.domain on 8.8.8.8:53: no such host","like_count":0,"discussions":[{"author":{"id":1192616,"avatar":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","nickname":"éƒ‘æµ·æˆ","note":"","ucode":"B0363EA4B2C646","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606505,"discussion_content":"æˆ‘ä¹Ÿé‡åˆ°ç›¸åŒçš„é—®é¢˜ï¼Œè§£å†³äº†å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677198578,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1308196,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","nickname":"ghostwritten","note":"","ucode":"AE512F2E24A1A0","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1192616,"avatar":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","nickname":"éƒ‘æµ·æˆ","note":"","ucode":"B0363EA4B2C646","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":606908,"discussion_content":"æˆ‘è®°å¾—è¿™ç¯‡æˆ‘éƒ½è·‘é€šäº†ï¼Œè¿™ç‚¹æ—¶é—´ä¹…æœ‰ç‚¹å¿˜äº†ï¼š\n1. /etc/sysctl.conf é…ç½®net.ipv4.ip_forward = 1æ£€æŸ¥ä¸€ä¸‹ ï¼›\n2. DNSåŸŸåè§£æé…ç½®æ£€æŸ¥ä¸€ä¸‹ï¼›\n3. Cert-manager æ—¥å¿—çœ‹çœ‹æœ‰æ²¡æœ‰æŠ¥é”™ \n4. cluster-issuer.yaml é‚®ç®±æœ‰æ²¡æœ‰å¿˜æ”¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677485712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":606505,"ip_address":"åŒ—äº¬","group_id":0},"score":606908,"extra":""},{"author":{"id":1446375,"avatar":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","nickname":"bookå°¾æ±","note":"","ucode":"AE2B8DFC643ACC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1192616,"avatar":"https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg","nickname":"éƒ‘æµ·æˆ","note":"","ucode":"B0363EA4B2C646","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":616223,"discussion_content":"kubectl edit cm  harbor-core  -n harbor ï¼ŒæŠŠé‡Œé¢çš„é‚£ä¸ª ext_urlæ¢æˆä½ è‡ªå·±çš„å°±å¯ä»¥äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1682650370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":606505,"ip_address":"åŒ—äº¬","group_id":0},"score":616223,"extra":""}]}]}]}