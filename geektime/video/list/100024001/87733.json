{"id":87733,"title":"36 | Benchmark","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":162644,"user_name":"苏格拉没底","can_delete":false,"product_type":"c3","uid":1476300,"ip_address":"","ucode":"282B56405AE1B9","user_header":"https://static001.geekbang.org/account/avatar/00/16/86/cc/d63bb0f2.jpg","comment_is_top":false,"comment_ctime":1576572010,"is_pvip":false,"replies":[{"id":63266,"content":"最简单的方法是：\ngo test -v polymorphsim_test.go &gt;&gt; 1.txt","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1577355147,"ip_address":"","comment_id":162644,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"请问能否将终端的输出结果写入到一个文件中？以做后续的分析处理，谢谢","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478117,"discussion_content":"最简单的方法是：\ngo test -v polymorphsim_test.go &amp;gt;&amp;gt; 1.txt","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577355147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363821,"user_name":"slssdhs","can_delete":false,"product_type":"c3","uid":1138058,"ip_address":"湖北","ucode":"6644520A415C69","user_header":"https://static001.geekbang.org/account/avatar/00/11/5d/8a/894479c1.jpg","comment_is_top":false,"comment_ctime":1670225674,"is_pvip":false,"replies":[{"id":141644,"content":"赞👍","user_name":"作者回复","user_name_real":"编辑","uid":1008262,"ctime":1712158152,"ip_address":"北京","comment_id":363821,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"如果发现运行 go test -bench=. 仅给出一行类似\nok      Study&#47;src&#47;ch35&#47;benchmark        0.037s \n这样的输出 请确认是否使用的是Windows PowerShell 如果是请切换到 命令行 或者说 CMD 执行 就能获得与视频一样的输出了","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":641096,"discussion_content":"赞👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1712158152,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":299218,"user_name":"FR","can_delete":false,"product_type":"c3","uid":1226754,"ip_address":"","ucode":"E111881ED789C1","user_header":"https://static001.geekbang.org/account/avatar/00/12/b8/02/7bcba09e.jpg","comment_is_top":false,"comment_ctime":1624516253,"is_pvip":false,"replies":[{"id":113329,"content":"加上-v的参数","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1632020920,"ip_address":"","comment_id":299218,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，请问下为什么我的benchmark输出参数只有PASS\nok      trgo&#47;src&#47;ch35&#47;benchmark 0.224s，执行的命令也是go test -bench=.","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522367,"discussion_content":"加上-v的参数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632020920,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143312,"user_name":"sasmiditer","can_delete":false,"product_type":"c3","uid":1158519,"ip_address":"","ucode":"C82AE609CFB223","user_header":"https://static001.geekbang.org/account/avatar/00/11/ad/77/f81c61d6.jpg","comment_is_top":false,"comment_ctime":1571666648,"is_pvip":false,"replies":[{"id":55914,"content":"&quot;for i := 0; i &lt; b.N; i++ &quot; 外面这个循环是用来控制测试次数的","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1572177238,"ip_address":"","comment_id":143312,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"...buff那个函数，变量buf的声明是否应该放在循环外面？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471482,"discussion_content":"&amp;quot;for i := 0; i &amp;lt; b.N; i++ &amp;quot; 外面这个循环是用来控制测试次数的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572177238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83340,"user_name":"cfanbo","can_delete":false,"product_type":"c3","uid":1043738,"ip_address":"","ucode":"39D8D71453E575","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ed/1a/269eb3d6.jpg","comment_is_top":false,"comment_ctime":1554540137,"is_pvip":false,"replies":[{"id":30144,"content":"代码被运行的次数，单次的运行时间","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1554597216,"ip_address":"","comment_id":83340,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"-benchmem 参数的输出结果那两列表示的什么意思？一直没有找到比较详情的解释","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445984,"discussion_content":"代码被运行的次数，单次的运行时间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554597216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118030,"user_name":"虢國技醬","can_delete":false,"product_type":"c3","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1564214817,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"B&#47;op:每次操作分配的内存字节数\nallocs&#47;op:每次操作分配内存的次数","like_count":13},{"had_liked":false,"id":287654,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1618070485,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"Benchmark 用于对代码片段或者第三方库进行性能测试\n\n- 方法名以 Benchmark 开头\n- 参数类型是 *testing.B\n- 用 b.ResetTimer( ) 和 b.StopTimer() 来隔离与性能测试无关的代码\n- 性能测试交给 framework 来做，将需要测试的代码放在循环中，循环的次数由 framework 来返回\n\n在留言里面看到关于将  buf 的声明是否放在性能测试中，也就是外层 for  循环的讨论\n\n```\nvar buf bytes.Buff\n```\n\n如果从性能比较上来讲，buf 和 str 的声明都应该放在控制测试次数的 for 循环内。\n\n但是如果把 buf 和 str 的声明都挪到 for 循环的外面，可以看到对于 str 的影响会更大一些，但是这个和本次性能测试无关，应该是由 string 和 bytes.Buff 的特性决定的。","like_count":2},{"had_liked":false,"id":367536,"user_name":"聪","can_delete":false,"product_type":"c3","uid":2058233,"ip_address":"广东","ucode":"BB979E798CC247","user_header":"https://static001.geekbang.org/account/avatar/00/1f/67/f9/b81705cf.jpg","comment_is_top":false,"comment_ctime":1675308299,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"刚测试了一下，测试将测试程序代码段单独封装\n\nfunc ConcatStringByAdd(elems []string) string{\n\tret := &quot;&quot;\n\tfor _, elem := range elems {\n\t\tret += elem\n\t}\n\treturn ret\n}\n\nfunc ConcatStringByBytesBuffer(elems []string) string{\n\tvar buf bytes.Buffer\n\tfor _, elem := range elems {\n\t\tbuf.WriteString(elem)\n\t}\n\treturn buf.String()\n}\n\n然后进行对比测试，发现buffstirng 操作了多一次内存分配，是什么原因呢？\n\nfunc BenchmarkConcatStringByAdd(b *testing.B) {\n\telems := []string{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;}\n\tb.ResetTimer()\n\tfor i := 0; i &lt; b.N; i++ {\n\t\tret := &quot;&quot;\n\t\tfor _, elem := range elems {\n\t\t\tret += elem\n\t\t}\n\n\t}\n\tb.StopTimer()\n}\n\nfunc BenchmarkConcatStringByAddFunc(b *testing.B) {\n\telems := []string{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;}\n\tb.ResetTimer()\n\tfor i := 0; i &lt; b.N; i++ {\n\t\tConcatStringByAdd(elems)\n\t}\n\tb.StopTimer()\n}\nfunc BenchmarkConcatStringByBytesBuffer(b *testing.B) {\n\telems := []string{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;}\n\tb.ResetTimer()\n\tfor i := 0; i &lt; b.N; i++ {\n\t\tvar buf bytes.Buffer\n\t\tfor _, elem := range elems {\n\t\t\tbuf.WriteString(elem)\n\t\t}\n\t}\n\tb.StopTimer()\n}\nfunc BenchmarkConcatStringByBytesBufferFunc(b *testing.B) {\n\telems := []string{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;}\n\tb.ResetTimer()\n\tfor i := 0; i &lt; b.N; i++ {\n\t\tConcatStringByBytesBuffer(elems)\n\t}\n\tb.StopTimer()\n}\n\n测试结果：\n\ngoos: windows\ngoarch: amd64\npkg: ch35&#47;benchmark\ncpu: 11th Gen Intel(R) Core(TM) i5-1135G7 @ 2.40GHz\nBenchmarkConcatStringByAdd-8                    11933446                97.55 ns&#47;op           16 B&#47;op          4 allocs&#47;op\nBenchmarkConcatStringByAddFunc-8                12663584                97.21 ns&#47;op           16 B&#47;op          4 allocs&#47;op\nBenchmarkConcatStringByBytesBuffer-8            23991170                50.52 ns&#47;op           64 B&#47;op          1 allocs&#47;op\nBenchmarkConcatStringByBytesBufferFunc-8        17990841                64.41 ns&#47;op           69 B&#47;op          2 allocs&#47;op\nPASS\nok      ch35&#47;benchmark  5.486s","like_count":0},{"had_liked":false,"id":337433,"user_name":"Return12321","can_delete":false,"product_type":"c3","uid":1134694,"ip_address":"","ucode":"F7A3C5ED02E1D9","user_header":"https://static001.geekbang.org/account/avatar/00/11/50/66/047ee060.jpg","comment_is_top":false,"comment_ctime":1646820487,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"完全可以把输出的结果字段解释补上的","like_count":0},{"had_liked":false,"id":306485,"user_name":"噼里啪啦啪啦噼里噼里啪啦","can_delete":false,"product_type":"c3","uid":1109143,"ip_address":"","ucode":"2A4B86D38F7E11","user_header":"https://static001.geekbang.org/account/avatar/00/10/ec/97/58e7bc9a.jpg","comment_is_top":false,"comment_ctime":1628581326,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"func concatStringByAdd(elems []string) string {\n\tretString := &quot;&quot;\n\tfor _, elem := range elems {\n\t\tretString += elem\n\t}\n\treturn retString\n}\n\nfunc concatStringByBytesBuffer(elems []string) string {\n\tvar buf bytes.Buffer\n\tfor _, elem := range elems {\n\t\tbuf.WriteString(elem)\n\t}\n\treturn buf.String()\n}\n\n老师，请问我把函数单独定义了，没有写道Test里. 然后用go test -bench=. -benchmem就没有相关信息了。请问是为什么呢\n$ go test -bench=. -benchmem\ngoos: windows\ngoarch: amd64\ncpu: Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz\nBenchmarkConcatStringByAdd-8            1000000000             0 B&#47;op          0 allocs&#47;op\nBenchmarkConcatStringByBytesBuffer-8    1000000000             0 B&#47;op          0 allocs&#47;op\nPASS\nok      _&#47;F_&#47;Work&#47;open_courses&#47;learninggo&#47;Chao_s_55_Sessions_of_Golang&#47;ch29&#47;benchmark   0.134s\n","like_count":0}]}