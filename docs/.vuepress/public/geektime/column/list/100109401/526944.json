{"id":526944,"title":"42ï½œRESTful Web Servicesï¼ˆ6ï¼‰ï¼šå¦‚ä½•å¤„ç†JAX-RSå®šä¹‰çš„å¼‚å¸¸ç±»ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¾æ˜Šã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨TDDçš„æ–¹å¼å®ç°RESTful Web Servicesã€‚</p><h2>å›é¡¾æ¶æ„æ„¿æ™¯ä¸ä»»åŠ¡åˆ—è¡¨</h2><p>ç›®å‰æˆ‘ä»¬çš„æ¶æ„æ„¿æ™¯å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/ed/2e/ed95e0629105b3fe661590be6ab4af2e.jpg?wh=2284x1285\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/aa/56/aacdc2230e337d593308c0184b799956.jpg?wh=2284x1285\" alt=\"\"></p><p>ä»»åŠ¡åˆ—è¡¨ä¸ºï¼š</p><ul>\n<li>\n<p>ResourceServlet</p>\n<ul>\n<li>\n<p>å°†è¯·æ±‚æ´¾åˆ†ç»™å¯¹åº”çš„èµ„æºï¼ˆResourceï¼‰ï¼Œå¹¶æ ¹æ®è¿”å›çš„çŠ¶æ€ã€è¶…åª’ä½“ç±»å‹ã€å†…å®¹ï¼Œå“åº”Httpè¯·æ±‚</p>\n<ul>\n<li><s>ä½¿ç”¨OutboundResponseçš„statusä½œä¸ºHttp Responseçš„çŠ¶æ€</s></li>\n<li><s>ä½¿ç”¨OutboundResponseçš„headersä½œä¸ºHttp Responseçš„Http Headers</s></li>\n<li><s>é€šè¿‡MessageBodyWriterå°†OutboundResponseçš„GenericEntityå†™å›ä¸ºBody</s></li>\n<li>å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„MessageBodyï¼Œåˆ™è¿”å›500æ—é”™è¯¯</li>\n</ul>\n</li>\n<li>\n<p>å½“èµ„æºæ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œæ ¹æ®å¼‚å¸¸å½±å“Httpè¯·æ±‚</p>\n<ul>\n<li>å¦‚æœæŠ›å‡ºWebApplicationExceptionï¼Œä¸”responseä¸ä¸ºnullï¼Œåˆ™ä½¿ç”¨responseå“åº”Http</li>\n<li>å¦‚æœæŠ›å‡ºWebApplicationExceptionï¼Œè€Œresponseä¸ºnullï¼Œåˆ™é€šè¿‡å¼‚å¸¸çš„å…·ä½“ç±»å‹æŸ¥æ‰¾ExceptionMapperï¼Œç”Ÿäº§responseå“åº”Httpè¯·æ±‚</li>\n<li>å¦‚æœæŠ›å‡ºçš„ä¸æ˜¯WebApplicationExceptionï¼Œåˆ™é€šè¿‡å¼‚å¸¸çš„å…·ä½“ç±»å‹æŸ¥æ‰¾ExceptionMapperï¼Œç”Ÿäº§responseå“åº”Httpè¯·æ±‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>RuntimeDelegate</p>\n<ul>\n<li>ä¸ºMediaTypeæä¾›HeaderDelegate</li>\n<li>ä¸ºCacheControlæä¾›HeaderDelegate</li>\n<li>ä¸ºCookieæä¾›HeaderDelegates</li>\n<li>ä¸ºEntityTagæä¾›HeaderDelegate</li>\n<li>ä¸ºLinkæä¾›HeaderDelegate</li>\n<li>ä¸ºNewCookieæä¾›HeaderDelegate</li>\n<li>ä¸ºDateæä¾›HeaderDelegate</li>\n</ul>\n</li>\n</ul><!-- [[[read_end]]] --><p>ä»£ç ä¸ºï¼š</p><pre><code>package geektime.tdd.rest;\n\nimport jakarta.servlet.ServletException;\nimport jakarta.servlet.http.HttpServlet;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport jakarta.ws.rs.core.GenericEntity;\nimport jakarta.ws.rs.core.MultivaluedMap;\nimport jakarta.ws.rs.ext.MessageBodyWriter;\nimport jakarta.ws.rs.ext.Providers;\nimport jakarta.ws.rs.ext.RuntimeDelegate;\nimport java.io.IOException;\n\npublic class ResourceServlet extends HttpServlet {\n\n    private Runtime runtime;\n    \n    public ResourceServlet(Runtime runtime) {\n        this.runtime = runtime;\n    }\n    \n    @Override\n    protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {\n        ResourceRouter router = runtime.getResourceRouter();\n        Providers providers = runtime.getProviders();\n        \n        OutboundResponse response = router.dispatch(req, runtime.createResourceContext(req, resp));\n        \n        resp.setStatus(response.getStatus());\n        \n        MultivaluedMap&lt;String, Object&gt; headers = response.getHeaders();\n        for (String name : headers.keySet())\n            for (Object value : headers.get(name)) {\n                RuntimeDelegate.HeaderDelegate headerDelegate = RuntimeDelegate.getInstance().createHeaderDelegate(value.getClass());\n                resp.addHeader(name, headerDelegate.toString(value));\n            }\n            \n        GenericEntity entity = response.getGenericEntity();\n        MessageBodyWriter writer = providers.getMessageBodyWriter(entity.getRawType(), entity.getType(), response.getAnnotations(), response.getMediaType());\n        writer.writeTo(entity.getEntity(), entity.getRawType(), entity.getType(), response.getAnnotations(), response.getMediaType(),\n                response.getHeaders(), resp.getOutputStream());\n    }\n}\n</code></pre><h2>è§†é¢‘æ¼”ç¤º</h2><p>ä¸‹é¢è®©æˆ‘ä»¬ç»§ç»­ï¼š</p><p><video poster=\"https://media001.geekbang.org/6de8f3214bbd4fb4a66906e2fe8b885d/snapshots/349caa7a035948adb602bc2e962e2b42-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/14eee078-1815c76fcab-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/60f75862b6f14550825a85176c218b32/60d3a01ba6ab4faf829e3c79d5d72fde-07082fb65ff7b2e68b5a5b7d2f5869eb-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><h2>æ€è€ƒé¢˜</h2><p>åœ¨è¿›å…¥ä¸‹èŠ‚è¯¾ä¹‹å‰ï¼Œå¸Œæœ›ä½ èƒ½è®¤çœŸæ€è€ƒå¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚</p><ol>\n<li>ç›®å‰çš„Sad Pathä»»åŠ¡æ˜¯å¦è¶³å¤Ÿï¼Ÿè¿˜æœ‰å“ªäº›Sad Pathçš„æƒ…å†µï¼Ÿ</li>\n<li>åœ¨è¿™èŠ‚è¯¾çš„å­¦ä¹ ä¸­ï¼Œä½ æœ€å¤§çš„æ”¶è·æ˜¯ä»€ä¹ˆï¼Ÿ</li>\n</ol><p>æ¬¢è¿æŠŠä½ çš„æƒ³æ³•åˆ†äº«åœ¨ç•™è¨€åŒºï¼Œä¹Ÿæ¬¢è¿æŠŠä½ çš„é¡¹ç›®ä»£ç åˆ†äº«å‡ºæ¥ã€‚ç›¸ä¿¡ç»è¿‡ä½ çš„æ€è€ƒä¸å®æ“ï¼Œå­¦ä¹ æ•ˆæœä¼šæ›´å¥½ï¼</p>","neighbors":{"left":{"article_title":"41ï½œRESTful Web Servicesï¼ˆ5ï¼‰ï¼šå¦‚ä½•é€šè¿‡å¯¹æ•°æ®æµ‹è¯•çš„ç®¡ç†æ¥å‡¸æ˜¾æ„å›¾ï¼Ÿ","id":526940},"right":{"article_title":"43ï½œRESTful Web Servicesï¼ˆ7ï¼‰ï¼šå‰©ä¸‹ä¸¤ä¸ªSad Pathåœºæ™¯è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ","id":526946}},"comments":[{"had_liked":false,"id":349197,"user_name":"å¼ é“æ—","can_delete":false,"product_type":"c1","uid":1108258,"ip_address":"","ucode":"4AB8BC6CDAC0A3","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/22/7606c6ba.jpg","comment_is_top":false,"comment_ctime":1655793085,"is_pvip":false,"replies":[{"id":127084,"content":"good jobï¼é€ä½ ä¸€æœµå°çº¢èŠ±ï¼","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":2189689,"ctime":1655798250,"ip_address":"","comment_id":349197,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100109401,"comment_content":"https:&#47;&#47;github.com&#47;vfbiby&#47;tdd-restful&#47;blob&#47;main&#47;doc&#47;Geektime%20TDD%2042.md\nè¿™æ˜¯æ“ä½œæ­¥éª¤ï¼Œæˆ‘æ˜¯å…ˆçœ‹è§†é¢‘çºªå½•ï¼Œå†è‡ªå·±è·Ÿç€æ­¥éª¤åšï¼Œç›¸å½“äºæ£€æŸ¥äº†ä¸€éã€‚\nè¿™ç« åšäº†3æ¬¡æäº¤ï¼Œ","like_count":1,"discussions":[{"author":{"id":2189689,"avatar":"https://static001.geekbang.org/account/avatar/00/21/69/79/b4132042.jpg","nickname":"ğŸ‘","note":"","ucode":"DE34B3B14287D1","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576816,"discussion_content":"good jobï¼é€ä½ ä¸€æœµå°çº¢èŠ±ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655798250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":349120,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1655738826,"is_pvip":false,"replies":[{"id":127085,"content":"å“å‘€å‘€ å¤ªæ£’äº†ï¼ä¹Ÿé€ä½ ä¸€æœµå°çº¢èŠ±ğŸŒº","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":2189689,"ctime":1655798272,"ip_address":"","comment_id":349120,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100109401,"comment_content":"ä»£ç  https:&#47;&#47;github.com&#47;wyyl1&#47;geektime-tdd-framework&#47;tree&#47;6","like_count":1,"discussions":[{"author":{"id":2189689,"avatar":"https://static001.geekbang.org/account/avatar/00/21/69/79/b4132042.jpg","nickname":"ğŸ‘","note":"","ucode":"DE34B3B14287D1","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576817,"discussion_content":"å“å‘€å‘€ å¤ªæ£’äº†ï¼ä¹Ÿé€ä½ ä¸€æœµå°çº¢èŠ±ğŸŒº","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1655798272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]}]}