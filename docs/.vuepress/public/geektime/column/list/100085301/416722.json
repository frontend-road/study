{"id":416722,"title":"09ï½œæ‰€æœ‰æƒï¼šä¸€ä¸ªå€¼å¯ä»¥æœ‰å¤šä¸ªæ‰€æœ‰è€…ä¹ˆï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ä¹‹å‰ä»‹ç»çš„å•ä¸€æ‰€æœ‰æƒè§„åˆ™ï¼Œèƒ½æ»¡è¶³æˆ‘ä»¬å¤§éƒ¨åˆ†åœºæ™¯ä¸­åˆ†é…å’Œä½¿ç”¨å†…å­˜çš„éœ€æ±‚ï¼Œè€Œä¸”åœ¨ç¼–è¯‘æ—¶ï¼Œé€šè¿‡ Rust å€Ÿç”¨æ£€æŸ¥å™¨å°±èƒ½å®Œæˆé™æ€æ£€æŸ¥ï¼Œä¸ä¼šå½±å“è¿è¡Œæ—¶æ•ˆç‡ã€‚</p><p>ä½†æ˜¯ï¼Œè§„åˆ™æ€»ä¼šæœ‰ä¾‹å¤–ï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­æœ‰äº›ç‰¹æ®Šæƒ…å†µè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><ul>\n<li>ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ä¸­ï¼ŒæŸä¸ªèŠ‚ç‚¹å¯èƒ½æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„èŠ‚ç‚¹æŒ‡å‘å®ƒï¼Œè¿™ä¸ªæŒ‰ç…§æ‰€æœ‰æƒæ¨¡å‹æ€ä¹ˆè¡¨è¿°ï¼Ÿ</li>\n<li>å¤šä¸ªçº¿ç¨‹è¦è®¿é—®åŒä¸€å—å…±äº«å†…å­˜ï¼Œæ€ä¹ˆåŠï¼Ÿ</li>\n</ul><p>æˆ‘ä»¬çŸ¥é“ï¼Œè¿™äº›é—®é¢˜åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ‰ä¼šé‡åˆ°ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œæ‰€æœ‰æƒçš„é™æ€æ£€æŸ¥æ— æ³•å¤„ç†å®ƒä»¬ï¼Œæ‰€ä»¥ä¸ºäº†æ›´å¥½çš„çµæ´»æ€§ï¼ŒRust æä¾›äº†<strong>è¿è¡Œæ—¶çš„åŠ¨æ€æ£€æŸ¥</strong>ï¼Œæ¥æ»¡è¶³ç‰¹æ®Šåœºæ™¯ä¸‹çš„éœ€æ±‚ã€‚</p><p>è¿™ä¹Ÿæ˜¯ Rust å¤„ç†å¾ˆå¤šé—®é¢˜çš„æ€è·¯ï¼šç¼–è¯‘æ—¶ï¼Œå¤„ç†å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯ï¼Œä¿è¯å®‰å…¨æ€§å’Œæ•ˆç‡ï¼›è¿è¡Œæ—¶ï¼Œå¤„ç†æ— æ³•åœ¨ç¼–è¯‘æ—¶å¤„ç†çš„åœºæ™¯ï¼Œä¼šç‰ºç‰²ä¸€éƒ¨åˆ†æ•ˆç‡ï¼Œæé«˜çµæ´»æ€§ã€‚åç»­è®²åˆ°é™æ€åˆ†å‘å’ŒåŠ¨æ€åˆ†å‘ä¹Ÿä¼šæœ‰ä½“ç°ï¼Œè¿™ä¸ªæ€è·¯å¾ˆå€¼å¾—æˆ‘ä»¬å€Ÿé‰´ã€‚</p><p>é‚£å…·ä½“å¦‚ä½•åœ¨è¿è¡Œæ—¶åšåŠ¨æ€æ£€æŸ¥å‘¢ï¼Ÿè¿è¡Œæ—¶çš„åŠ¨æ€æ£€æŸ¥åˆå¦‚ä½•ä¸ç¼–è¯‘æ—¶çš„é™æ€æ£€æŸ¥è‡ªæ´½å‘¢ï¼Ÿ</p><p>Rust çš„ç­”æ¡ˆæ˜¯ä½¿ç”¨å¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆï¼š<strong>Rcï¼ˆReference counterï¼‰ å’Œ Arcï¼ˆAtomic reference counterï¼‰</strong>ã€‚è¿™é‡Œè¦ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼ŒArc å’Œ ObjC/Swift é‡Œçš„ ARCï¼ˆAutomatic Reference Countingï¼‰ä¸æ˜¯ä¸€ä¸ªæ„æ€ï¼Œä¸è¿‡å®ƒä»¬è§£å†³é—®é¢˜çš„æ‰‹æ®µç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°å®Œæˆçš„ã€‚</p><!-- [[[read_end]]] --><h2>Rc</h2><p>æˆ‘ä»¬å…ˆçœ‹ Rcã€‚å¯¹æŸä¸ªæ•°æ®ç»“æ„ Tï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¼•ç”¨è®¡æ•° Rcï¼Œä½¿å…¶æœ‰å¤šä¸ªæ‰€æœ‰è€…ã€‚Rc ä¼šæŠŠå¯¹åº”çš„æ•°æ®ç»“æ„åˆ›å»ºåœ¨å †ä¸Šï¼Œæˆ‘ä»¬åœ¨ç¬¬äºŒè®²è°ˆåˆ°è¿‡ï¼Œå †æ˜¯å”¯ä¸€å¯ä»¥è®©åŠ¨æ€åˆ›å»ºçš„æ•°æ®è¢«åˆ°å¤„ä½¿ç”¨çš„å†…å­˜ã€‚</p><pre><code class=\"language-rust\">use std::rc::Rc;\nfn main() {    \n  let a = Rc::new(1);\n}\n</code></pre><p>ä¹‹åï¼Œå¦‚æœæƒ³å¯¹æ•°æ®åˆ›å»ºæ›´å¤šçš„æ‰€æœ‰è€…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ clone() æ¥å®Œæˆã€‚</p><p><strong>å¯¹ä¸€ä¸ª Rc ç»“æ„è¿›è¡Œ clone()ï¼Œä¸ä¼šå°†å…¶å†…éƒ¨çš„æ•°æ®å¤åˆ¶ï¼Œåªä¼šå¢åŠ å¼•ç”¨è®¡æ•°</strong>ã€‚è€Œå½“ä¸€ä¸ª Rc ç»“æ„ç¦»å¼€ä½œç”¨åŸŸè¢« drop() æ—¶ï¼Œä¹Ÿåªä¼šå‡å°‘å…¶å¼•ç”¨è®¡æ•°ï¼Œç›´åˆ°å¼•ç”¨è®¡æ•°ä¸ºé›¶ï¼Œæ‰ä¼šçœŸæ­£æ¸…é™¤å¯¹åº”çš„å†…å­˜ã€‚</p><pre><code class=\"language-rust\">use std::rc::Rc;\nfn main() {\n    let a = Rc::new(1);\n    let b = a.clone();\n    let c = a.clone();\n}\n</code></pre><p>ä¸Šé¢çš„ä»£ç æˆ‘ä»¬åˆ›å»ºäº†ä¸‰ä¸ª Rcï¼Œåˆ†åˆ«æ˜¯ aã€b å’Œ cã€‚å®ƒä»¬å…±åŒæŒ‡å‘å †ä¸Šç›¸åŒçš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå †ä¸Šçš„æ•°æ®æœ‰äº†ä¸‰ä¸ªå…±äº«çš„æ‰€æœ‰è€…ã€‚åœ¨è¿™æ®µä»£ç ç»“æŸæ—¶ï¼Œc å…ˆ dropï¼Œå¼•ç”¨è®¡æ•°å˜æˆ 2ï¼Œç„¶å b dropã€a dropï¼Œå¼•ç”¨è®¡æ•°å½’é›¶ï¼Œå †ä¸Šå†…å­˜è¢«é‡Šæ”¾ã€‚<img src=\"https://static001.geekbang.org/resource/image/a3/8c/a3510f9b565577bc74bc0dcda0b3e78c.jpg?wh=1920x1300\" alt=\"å›¾ç‰‡\"></p><p>ä½ ä¹Ÿè®¸ä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬ç”Ÿæˆäº†å¯¹åŒä¸€å—å†…å­˜çš„å¤šä¸ªæ‰€æœ‰è€…ï¼Œä½†æ˜¯ï¼Œç¼–è¯‘å™¨ä¸æŠ±æ€¨æ‰€æœ‰æƒå†²çªå‘¢ï¼Ÿ</p><p>ä»”ç»†çœ‹è¿™æ®µä»£ç ï¼šé¦–å…ˆ a æ˜¯ Rc::new(1) çš„æ‰€æœ‰è€…ï¼Œè¿™æ¯‹åº¸ç½®ç–‘ï¼›ç„¶å b å’Œ c éƒ½è°ƒç”¨äº† a.clone()ï¼Œåˆ†åˆ«å¾—åˆ°äº†ä¸€ä¸ªæ–°çš„ Rcï¼Œæ‰€ä»¥ä»ç¼–è¯‘å™¨çš„è§’åº¦ï¼Œabc éƒ½å„è‡ªæ‹¥æœ‰ä¸€ä¸ª Rcã€‚å¦‚æœæ–‡å­—ä½ è§‰å¾—ç¨å¾®æœ‰ç‚¹ç»•ï¼Œçœ‹çœ‹ Rc çš„ clone() å‡½æ•°çš„å®ç°ï¼Œå°±å¾ˆæ¸…æ¥šäº†ï¼ˆ<a href=\"https://doc.rust-lang.org/src/alloc/rc.rs.html#1433-1453\">æºä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">fn clone(&amp;self) -&gt; Rc&lt;T&gt; {\n    // å¢åŠ å¼•ç”¨è®¡æ•°\n    self.inner().inc_strong();\n    // é€šè¿‡ self.ptr ç”Ÿæˆä¸€ä¸ªæ–°çš„ Rc ç»“æ„\n    Self::from_inner(self.ptr)\n}\n</code></pre><p>æ‰€ä»¥ï¼ŒRc çš„ clone() æ­£å¦‚æˆ‘ä»¬åˆšæ‰è¯´çš„ï¼Œä¸å¤åˆ¶å®é™…çš„æ•°æ®ï¼Œåªæ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„å¢åŠ ã€‚</p><p>ä½ å¯èƒ½ç»§ç»­ä¼šç–‘æƒ‘ï¼šRc æ˜¯æ€ä¹ˆäº§ç”Ÿåœ¨å †ä¸Šçš„ï¼Ÿå¹¶ä¸”ä¸ºä»€ä¹ˆè¿™æ®µå †å†…å­˜ä¸å—æ ˆå†…å­˜ç”Ÿå‘½å‘¨æœŸçš„æ§åˆ¶å‘¢ï¼Ÿ</p><h3>Box::leak()æœºåˆ¶</h3><p>ä¸Šä¸€è®²æˆ‘ä»¬è®²åˆ°ï¼Œåœ¨æ‰€æœ‰æƒæ¨¡å‹ä¸‹ï¼Œå †å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸï¼Œå’Œåˆ›å»ºå®ƒçš„æ ˆå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚æ‰€ä»¥ Rc çš„å®ç°ä¼¼ä¹ä¸æ­¤æ ¼æ ¼ä¸å…¥ã€‚çš„ç¡®ï¼Œå¦‚æœå®Œå…¨æŒ‰ç…§ä¸Šä¸€è®²çš„å•ä¸€æ‰€æœ‰æƒæ¨¡å‹ï¼ŒRust æ˜¯æ— æ³•å¤„ç† Rc è¿™æ ·çš„å¼•ç”¨è®¡æ•°çš„ã€‚</p><p>Rustå¿…é¡»æä¾›ä¸€ç§æœºåˆ¶ï¼Œè®©ä»£ç å¯ä»¥åƒ C/C++ é‚£æ ·ï¼Œ<strong>åˆ›å»ºä¸å—æ ˆå†…å­˜æ§åˆ¶çš„å †å†…å­˜</strong>ï¼Œä»è€Œç»•è¿‡ç¼–è¯‘æ—¶çš„æ‰€æœ‰æƒè§„åˆ™ã€‚Rust æä¾›çš„æ–¹å¼æ˜¯ Box::leak()ã€‚</p><p>Box æ˜¯ Rust ä¸‹çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒå¯ä»¥å¼ºåˆ¶æŠŠä»»ä½•æ•°æ®ç»“æ„åˆ›å»ºåœ¨å †ä¸Šï¼Œç„¶ååœ¨æ ˆä¸Šæ”¾ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œä½†æ­¤æ—¶å †å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸä»ç„¶æ˜¯å—æ§çš„ï¼Œè·Ÿæ ˆä¸Šçš„æŒ‡é’ˆä¸€è‡´ã€‚æˆ‘ä»¬åç»­è®²åˆ°æ™ºèƒ½æŒ‡é’ˆæ—¶ä¼šè¯¦ç»†ä»‹ç» Boxã€‚</p><p>Box::leak()ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒåˆ›å»ºçš„å¯¹è±¡ï¼Œä»å †å†…å­˜ä¸Šæ³„æ¼å‡ºå»ï¼Œä¸å—æ ˆå†…å­˜æ§åˆ¶ï¼Œæ˜¯ä¸€ä¸ªè‡ªç”±çš„ã€ç”Ÿå‘½å‘¨æœŸå¯ä»¥å¤§åˆ°å’Œæ•´ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´çš„å¯¹è±¡ã€‚<img src=\"https://static001.geekbang.org/resource/image/9f/cd/9f1a17dea75f9cae596a56f51d007ccd.jpg?wh=1920x881\" alt=\"å›¾ç‰‡\"></p><p>æ‰€ä»¥æˆ‘ä»¬ç›¸å½“äºä¸»åŠ¨æ’•å¼€äº†ä¸€ä¸ªå£å­ï¼Œå…è®¸å†…å­˜æ³„æ¼ã€‚æ³¨æ„ï¼Œåœ¨ C/C++ ä¸‹ï¼Œå…¶å®ä½ é€šè¿‡ malloc åˆ†é…çš„æ¯ä¸€ç‰‡å †å†…å­˜ï¼Œéƒ½ç±»ä¼¼ Rust ä¸‹çš„ Box::leak()ã€‚æˆ‘å¾ˆå–œæ¬¢ Rust è¿™æ ·çš„è®¾è®¡ï¼Œå®ƒç¬¦åˆæœ€å°æƒé™åŸåˆ™ï¼ˆ<a href=\"https://en.wikipedia.org/wiki/Principle_of_least_privilege\">Principle of least privilege</a>ï¼‰ï¼Œæœ€å¤§ç¨‹åº¦å¸®åŠ©å¼€å‘è€…æ’°å†™å®‰å…¨çš„ä»£ç ã€‚</p><p><strong>æœ‰äº† Box::leak()ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·³å‡º Rust ç¼–è¯‘å™¨çš„é™æ€æ£€æŸ¥</strong>ï¼Œä¿è¯ Rc æŒ‡å‘çš„å †å†…å­˜ï¼Œæœ‰æœ€å¤§çš„ç”Ÿå‘½å‘¨æœŸï¼Œç„¶åæˆ‘ä»¬å†é€šè¿‡å¼•ç”¨è®¡æ•°ï¼Œåœ¨åˆé€‚çš„æ—¶æœºï¼Œç»“æŸè¿™æ®µå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ <a href=\"https://doc.rust-lang.org/src/alloc/rc.rs.html#342-350\">Rc::new() çš„æºç </a>ã€‚</p><p>æ’ä¸€å¥ï¼Œåœ¨å­¦ä¹ è¯­è¨€çš„è¿‡ç¨‹ä¸­ï¼Œä¸è¦å› ä¸ºè§‰å¾—è‡ªå·±æ˜¯ä¸ªåˆå­¦è€…ï¼Œå°±ä¸æ•¢ç¿»é˜…æ ‡å‡†åº“çš„æºç ï¼Œç›¸åï¼Œé‡åˆ°ä¸æ‡‚çš„åœ°æ–¹ï¼Œå¦‚æœä½ å»çœ‹å¯¹åº”çš„æºç ï¼Œå¾—åˆ°çš„æ˜¯ç¬¬ä¸€æ‰‹çš„çŸ¥è¯†ï¼Œä¸€æ—¦ææ˜ç™½ï¼Œå°±ä¼šå­¦å¾—éå¸¸æ‰å®ï¼Œå—ç›Šæ— ç©·ã€‚</p><p>ææ˜ç™½äº† Rcï¼Œæˆ‘ä»¬å°±è¿›ä¸€æ­¥ç†è§£ Rust æ˜¯å¦‚ä½•è¿›è¡Œæ‰€æœ‰æƒçš„é™æ€æ£€æŸ¥å’ŒåŠ¨æ€æ£€æŸ¥äº†ï¼š</p><ul>\n<li>é™æ€æ£€æŸ¥ï¼Œé ç¼–è¯‘å™¨ä¿è¯ä»£ç ç¬¦åˆæ‰€æœ‰æƒè§„åˆ™ï¼›</li>\n<li>åŠ¨æ€æ£€æŸ¥ï¼Œé€šè¿‡ Box::leak è®©å †å†…å­˜æ‹¥æœ‰ä¸å—é™çš„ç”Ÿå‘½å‘¨æœŸï¼Œç„¶ååœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å¯¹å¼•ç”¨è®¡æ•°çš„æ£€æŸ¥ï¼Œä¿è¯è¿™æ ·çš„å †å†…å­˜æœ€ç»ˆä¼šå¾—åˆ°é‡Šæ”¾ã€‚</li>\n</ul><h3>å®ç° DAG</h3><p>ç°åœ¨æˆ‘ä»¬ç”¨ Rc æ¥å®ç°ä¹‹å‰æ— æ³•å®ç°çš„ DAGã€‚</p><p>å‡è®¾ Node å°±åªåŒ…å« id å’ŒæŒ‡å‘ä¸‹æ¸¸ï¼ˆdownstreamï¼‰çš„æŒ‡é’ˆï¼Œå› ä¸º DAG ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½è¢«å¤šä¸ªå…¶å®ƒèŠ‚ç‚¹æŒ‡å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨  <code>Rc&lt;Node&gt;</code> æ¥è¡¨è¿°å®ƒï¼›ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ²¡æœ‰ä¸‹æ¸¸èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨  <code>Option&lt;Rc&lt;Node&gt;&gt;</code> æ¥è¡¨è¿°å®ƒã€‚<img src=\"https://static001.geekbang.org/resource/image/0c/ab/0c5b0ff12963792a55baa43d3b3054ab.jpg?wh=1920x982\" alt=\"å›¾ç‰‡\"></p><p>è¦å»ºç«‹è¿™æ ·ä¸€ä¸ª DAGï¼Œæˆ‘ä»¬éœ€è¦ä¸º Node æä¾›ä»¥ä¸‹æ–¹æ³•ï¼š</p><ul>\n<li>new()ï¼šå»ºç«‹ä¸€ä¸ªæ–°çš„ Nodeã€‚</li>\n<li>update_downstream()ï¼šè®¾ç½® Node çš„ downstreamã€‚</li>\n<li>get_downstream()ï¼šclone ä¸€ä»½ Node é‡Œçš„ downstreamã€‚</li>\n</ul><p>æœ‰äº†è¿™äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºå‡ºæ‹¥æœ‰ä¸Šå›¾å…³ç³»çš„ DAG äº†ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=455a14b85949d11a3368019aec7b238b\">ä»£ç 1</a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::rc::Rc;\n\n#[derive(Debug)]\nstruct Node {\n    id: usize,\n    downstream: Option&lt;Rc&lt;Node&gt;&gt;,\n}\n\nimpl Node {\n    pub fn new(id: usize) -&gt; Self {\n        Self {\n            id,\n            downstream: None,\n        }\n    }\n\n    pub fn update_downstream(&amp;mut self, downstream: Rc&lt;Node&gt;) {\n        self.downstream = Some(downstream);\n    }\n\n    pub fn get_downstream(&amp;self) -&gt; Option&lt;Rc&lt;Node&gt;&gt; {\n        self.downstream.as_ref().map(|v| v.clone())\n    }\n}\n\nfn main() {\n    let mut node1 = Node::new(1);\n    let mut node2 = Node::new(2);\n    let mut node3 = Node::new(3);\n    let node4 = Node::new(4);\n    node3.update_downstream(Rc::new(node4));\n\n    node1.update_downstream(Rc::new(node3));\n    node2.update_downstream(node1.get_downstream().unwrap());\n    println!(\"node1: {:?}, node2: {:?}\", node1, node2);\n}\n</code></pre><h2>RefCell</h2><p>åœ¨è¿è¡Œä¸Šè¿°ä»£ç æ—¶ï¼Œç»†å¿ƒçš„ä½ ä¹Ÿè®¸ä¼šç–‘æƒ‘ï¼šæ•´ä¸ª DAG åœ¨åˆ›å»ºå®Œæˆåè¿˜èƒ½ä¿®æ”¹ä¹ˆï¼Ÿ</p><p>æŒ‰æœ€ç®€å•çš„å†™æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢çš„ä»£ç 1çš„  <code>main()</code> å‡½æ•°åï¼ŒåŠ å…¥è¿™æ®µä»£ç ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=5fc82318fefff9f736391aaac84fbf52\">ä»£ç 2</a>ï¼‰ï¼Œæ¥ä¿®æ”¹ Node3 ä½¿å…¶æŒ‡å‘ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ Node5ï¼š</p><pre><code class=\"language-rust\">let node5 = Node::new(5);\nlet node3 = node1.get_downstream().unwrap();\nnode3.update_downstream(Rc::new(node5));\n\nprintln!(\"node1: {:?}, node2: {:?}\", node1, node2);\n</code></pre><p>ç„¶è€Œï¼Œå®ƒæ— æ³•ç¼–è¯‘é€šè¿‡ï¼Œç¼–è¯‘å™¨ä¼šå‘Šè¯‰ä½ â€œnode3 cannot borrow as mutableâ€ã€‚</p><p>è¿™æ˜¯å› ä¸º<strong>Rc æ˜¯ä¸€ä¸ªåªè¯»çš„å¼•ç”¨è®¡æ•°å™¨</strong>ï¼Œä½ æ— æ³•æ‹¿åˆ° Rc ç»“æ„å†…éƒ¨æ•°æ®çš„å¯å˜å¼•ç”¨ï¼Œæ¥ä¿®æ”¹è¿™ä¸ªæ•°æ®ã€‚è¿™å¯æ€ä¹ˆåŠï¼Ÿ</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ RefCellã€‚</p><p>å’Œ Rc ç±»ä¼¼ï¼ŒRefCell ä¹Ÿç»•è¿‡äº† Rust ç¼–è¯‘å™¨çš„é™æ€æ£€æŸ¥ï¼Œå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶ï¼Œå¯¹æŸä¸ªåªè¯»æ•°æ®è¿›è¡Œå¯å˜å€Ÿç”¨ã€‚è¿™å°±æ¶‰åŠ Rust å¦ä¸€ä¸ªæ¯”è¾ƒç‹¬ç‰¹ä¸”æœ‰ç‚¹éš¾æ‡‚çš„æ¦‚å¿µï¼š<a href=\"https://doc.rust-lang.org/book/ch15-05-interior-mutability.html\">å†…éƒ¨å¯å˜æ€§ï¼ˆinterior mutabilityï¼‰</a>ã€‚</p><h3>å†…éƒ¨å¯å˜æ€§</h3><p>æœ‰å†…éƒ¨å¯å˜æ€§ï¼Œè‡ªç„¶èƒ½è”æƒ³åˆ°å¤–éƒ¨å¯å˜æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹è¿™ä¸ªæ›´ç®€å•çš„å®šä¹‰ï¼Œå¯¹æ¯”ç€å­¦ã€‚</p><p>å½“æˆ‘ä»¬ç”¨  <code>let mut</code> æ˜¾å¼åœ°å£°æ˜ä¸€ä¸ªå¯å˜çš„å€¼ï¼Œæˆ–è€…ï¼Œç”¨  <code>&amp;mut</code> å£°æ˜ä¸€ä¸ªå¯å˜å¼•ç”¨æ—¶ï¼Œç¼–è¯‘å™¨å¯ä»¥åœ¨ç¼–è¯‘æ—¶è¿›è¡Œä¸¥æ ¼åœ°æ£€æŸ¥ï¼Œä¿è¯åªæœ‰å¯å˜çš„å€¼æˆ–è€…å¯å˜çš„å¼•ç”¨ï¼Œæ‰èƒ½ä¿®æ”¹å€¼å†…éƒ¨çš„æ•°æ®ï¼Œè¿™è¢«ç§°ä½œå¤–éƒ¨å¯å˜æ€§ï¼ˆexterior mutabilityï¼‰ï¼Œå¤–éƒ¨å¯å˜æ€§é€šè¿‡ <code>mut</code> å…³é”®å­—å£°æ˜ã€‚</p><p>ç„¶è€Œï¼Œè¿™æ ·ä¸å¤Ÿçµæ´»ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿç»•å¼€è¿™ä¸ªç¼–è¯‘æ—¶çš„æ£€æŸ¥ï¼Œå¯¹å¹¶æœªå£°æ˜æˆ  <code>mut</code> çš„å€¼æˆ–è€…å¼•ç”¨ï¼Œä¹Ÿæƒ³è¿›è¡Œä¿®æ”¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åœ¨ç¼–è¯‘å™¨çš„çœ¼é‡Œï¼Œå€¼æ˜¯åªè¯»çš„ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œè¿™ä¸ªå€¼å¯ä»¥å¾—åˆ°å¯å˜å€Ÿç”¨ï¼Œä»è€Œä¿®æ”¹å†…éƒ¨çš„æ•°æ®</strong>ï¼Œè¿™å°±æ˜¯  <code>RefCell</code> çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=99c4faa2e3f3a976d3c61c3f82764e28\">ä»£ç 2</a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::cell::RefCell;\n\nfn main() {\n    let data = RefCell::new(1);\n    {\n        // è·å¾— RefCell å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨\n        let mut v = data.borrow_mut();\n        *v += 1;\n    }\n    println!(\"data: {:?}\", data.borrow());\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œdata æ˜¯ä¸€ä¸ª RefCellï¼Œå…¶åˆå§‹å€¼ä¸º 1ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¹¶æœªå°† data å£°æ˜ä¸ºå¯å˜å˜é‡ã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ RefCell çš„ <code>borrow_mut()</code> æ–¹æ³•ï¼Œæ¥è·å¾—ä¸€ä¸ªå¯å˜çš„å†…éƒ¨å¼•ç”¨ï¼Œç„¶åå¯¹å®ƒåšåŠ  1 çš„æ“ä½œã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ RefCell çš„  <code>borrow()</code> æ–¹æ³•ï¼Œè·å¾—ä¸€ä¸ªä¸å¯å˜çš„å†…éƒ¨å¼•ç”¨ï¼Œå› ä¸ºåŠ äº† 1ï¼Œæ­¤æ—¶å®ƒçš„å€¼ä¸º 2ã€‚</p><p>ä½ ä¹Ÿè®¸å¥‡æ€ªï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦æŠŠè·å–å’Œæ“ä½œå¯å˜å€Ÿç”¨çš„ä¸¤å¥ä»£ç ï¼Œç”¨èŠ±æ‹¬å·åˆ†è£…åˆ°ä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Ÿ</p><p>å› ä¸ºæ ¹æ®æ‰€æœ‰æƒè§„åˆ™ï¼Œåœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Œæˆ‘ä»¬<strong>ä¸èƒ½åŒæ—¶æœ‰æ´»è·ƒçš„å¯å˜å€Ÿç”¨å’Œä¸å¯å˜å€Ÿç”¨</strong>ã€‚é€šè¿‡è¿™å¯¹èŠ±æ‹¬å·ï¼Œæˆ‘ä»¬æ˜ç¡®åœ°ç¼©å°äº†å¯å˜å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸è‡³äºå’Œåç»­çš„ä¸å¯å˜å€Ÿç”¨å†²çªã€‚</p><p>è¿™é‡Œå†æƒ³ä¸€æ­¥ï¼Œå¦‚æœæ²¡æœ‰è¿™å¯¹èŠ±æ‹¬å·ï¼Œè¿™æ®µä»£ç æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡ï¼Ÿè¿˜æ˜¯è¿è¡Œæ—¶ä¼šå‡ºé”™ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=0af48f1237504aaadbe7da1f1853a838\">ä»£ç 3</a>ï¼‰ï¼Ÿ</p><pre><code class=\"language-rust\">use std::cell::RefCell;\n\nfn main() {\n&nbsp; &nbsp; let data = RefCell::new(1);\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; let mut v = data.borrow_mut();\n&nbsp; &nbsp; *v += 1;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; println!(\"data: {:?}\", data.borrow());\n}\n</code></pre><p>å¦‚æœä½ è¿è¡Œä»£ç 3ï¼Œç¼–è¯‘æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†åœ¨è¿è¡Œåˆ°ç¬¬ 9 è¡Œæ—¶ï¼Œä¼šå¾—åˆ°ï¼šâ€œalready mutably borrowed: BorrowErrorâ€ è¿™æ ·çš„é”™è¯¯ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰æƒçš„å€Ÿç”¨è§„åˆ™åœ¨æ­¤ä¾æ—§æœ‰æ•ˆï¼Œåªä¸è¿‡å®ƒåœ¨è¿è¡Œæ—¶æ£€æµ‹ã€‚</p><p>è¿™å°±æ˜¯å¤–éƒ¨å¯å˜æ€§å’Œå†…éƒ¨å¯å˜æ€§çš„é‡è¦åŒºåˆ«ï¼Œæˆ‘ä»¬ç”¨ä¸‹è¡¨æ¥æ€»ç»“ä¸€ä¸‹ï¼š<img src=\"https://static001.geekbang.org/resource/image/94/3c/94bd27a93210ea829482663c9138de3c.jpg?wh=3402x1017\" alt=\"\"></p><h3>å®ç°å¯ä¿®æ”¹DAG</h3><p>å¥½ï¼Œç°åœ¨æˆ‘ä»¬å¯¹ RefCell æœ‰ä¸€ä¸ªç›´è§‚çš„å°è±¡ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨å®ƒå’Œ Rc æ¥è®©ä¹‹å‰çš„ DAG å˜å¾—å¯ä¿®æ”¹ã€‚</p><p>é¦–å…ˆæ•°æ®ç»“æ„çš„ downstream éœ€è¦ Rc å†…éƒ¨åµŒå¥—ä¸€ä¸ª RefCellï¼Œè¿™æ ·ï¼Œå°±å¯ä»¥åˆ©ç”¨ RefCell çš„å†…éƒ¨å¯å˜æ€§ï¼Œæ¥è·å¾—æ•°æ®çš„å¯å˜å€Ÿç”¨äº†ï¼ŒåŒæ—¶ Rc è¿˜å…è®¸å€¼æœ‰å¤šä¸ªæ‰€æœ‰è€…ã€‚<img src=\"https://static001.geekbang.org/resource/image/62/46/6264d51da5c5e9025abf28d7c0dd2e46.jpg?wh=1920x1324\" alt=\"å›¾ç‰‡\"></p><p>å®Œæ•´çš„ä»£ç æˆ‘æ”¾åˆ°è¿™é‡Œäº†ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=abbb6881ed94a9881ed96ace779d3734\">ä»£ç 4</a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::cell::RefCell;\nuse std::rc::Rc;\n\n#[derive(Debug)]\nstruct Node {\n    id: usize,\n    // ä½¿ç”¨ Rc&lt;RefCell&lt;T&gt;&gt; è®©èŠ‚ç‚¹å¯ä»¥è¢«ä¿®æ”¹\n    downstream: Option&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,\n}\n\nimpl Node {\n    pub fn new(id: usize) -&gt; Self {\n        Self {\n            id,\n            downstream: None,\n        }\n    }\n\n    pub fn update_downstream(&amp;mut self, downstream: Rc&lt;RefCell&lt;Node&gt;&gt;) {\n        self.downstream = Some(downstream);\n    }\n\n    pub fn get_downstream(&amp;self) -&gt; Option&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt; {\n        self.downstream.as_ref().map(|v| v.clone())\n    }\n}\n\nfn main() {\n    let mut node1 = Node::new(1);\n    let mut node2 = Node::new(2);\n    let mut node3 = Node::new(3);\n    let node4 = Node::new(4);\n\n    node3.update_downstream(Rc::new(RefCell::new(node4)));\n    node1.update_downstream(Rc::new(RefCell::new(node3)));\n    node2.update_downstream(node1.get_downstream().unwrap());\n    println!(\"node1: {:?}, node2: {:?}\", node1, node2);\n\n    let node5 = Node::new(5);\n    let node3 = node1.get_downstream().unwrap();\n    // è·å¾—å¯å˜å¼•ç”¨ï¼Œæ¥ä¿®æ”¹ downstream\n    node3.borrow_mut().downstream = Some(Rc::new(RefCell::new(node5)));\n\n    println!(\"node1: {:?}, node2: {:?}\", node1, node2);\n}\n\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ä½¿ç”¨  <code>Rc&lt;RefCell&lt;T&gt;&gt;</code> è¿™æ ·çš„åµŒå¥—ç»“æ„ï¼Œæˆ‘ä»¬çš„ DAG ä¹Ÿå¯ä»¥æ­£å¸¸ä¿®æ”¹äº†ã€‚</p><h2>Arc å’Œ Mutex/RwLock</h2><p>æˆ‘ä»¬ç”¨ Rc å’Œ RefCell è§£å†³äº† DAG çš„é—®é¢˜ï¼Œé‚£ä¹ˆï¼Œå¼€å¤´æåˆ°çš„å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€å—å†…å­˜çš„é—®é¢˜ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥ä½¿ç”¨ Rc æ¥å¤„ç†å‘¢ï¼Ÿ</p><p>ä¸è¡Œã€‚å› ä¸º Rc ä¸ºäº†æ€§èƒ½ï¼Œä½¿ç”¨çš„ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°å™¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆï¼šArcï¼Œå®ƒå®ç°äº†çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°å™¨ã€‚</p><p>Arc å†…éƒ¨çš„å¼•ç”¨è®¡æ•°ä½¿ç”¨äº† <a href=\"https://doc.rust-lang.org/src/alloc/sync.rs.html#303-312\">Atomic Usize</a> ï¼Œè€Œéæ™®é€šçš„ usizeã€‚ä»åç§°ä¸Šä¹Ÿå¯ä»¥æ„Ÿè§‰å‡ºæ¥ï¼ŒAtomic Usize æ˜¯ usize çš„åŸå­ç±»å‹ï¼Œå®ƒä½¿ç”¨äº† CPU çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œæ¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨ã€‚å¦‚æœä½ å¯¹åŸå­ç±»å‹æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ <a href=\"https://doc.rust-lang.org/std/sync/atomic/index.html\">std::sync::atomic çš„æ–‡æ¡£</a>ã€‚</p><p>Rust å®ç°ä¸¤å¥—ä¸åŒçš„å¼•ç”¨è®¡æ•°æ•°æ®ç»“æ„ï¼Œå®Œå…¨æ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ„Ÿå—åˆ° Rust å¯¹æ€§èƒ½çš„æè‡´æ¸´æ±‚ã€‚<strong>å¦‚æœä¸ç”¨è·¨çº¿ç¨‹è®¿é—®ï¼Œå¯ä»¥ç”¨æ•ˆç‡éå¸¸é«˜çš„ Rcï¼›å¦‚æœè¦è·¨çº¿ç¨‹è®¿é—®ï¼Œé‚£ä¹ˆå¿…é¡»ç”¨ Arc</strong>ã€‚</p><p>åŒæ ·çš„ï¼ŒRefCell ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œä½¿ç”¨å†…éƒ¨å¯å˜æ€§ï¼ŒRust æä¾›äº† Mutex å’Œ RwLockã€‚</p><p>è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„ä½ åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼ŒMutexæ˜¯äº’æ–¥é‡ï¼Œè·å¾—äº’æ–¥é‡çš„çº¿ç¨‹å¯¹æ•°æ®ç‹¬å è®¿é—®ï¼ŒRwLockæ˜¯è¯»å†™é”ï¼Œè·å¾—å†™é”çš„çº¿ç¨‹å¯¹æ•°æ®ç‹¬å è®¿é—®ï¼Œä½†å½“æ²¡æœ‰å†™é”çš„æ—¶å€™ï¼Œå…è®¸æœ‰å¤šä¸ªè¯»é”ã€‚è¯»å†™é”çš„è§„åˆ™å’Œ Rust çš„å€Ÿç”¨è§„åˆ™éå¸¸ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ç±»æ¯”ç€å­¦ã€‚</p><p>Mutex å’Œ RwLock éƒ½ç”¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯¹å…±äº«æ•°æ®è®¿é—®çš„ä¿æŠ¤ä¸Šã€‚åˆšæ‰ä¸­æˆ‘ä»¬æ„å»ºçš„ DAG å¦‚æœè¦ç”¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œéœ€è¦æŠŠ  <code>Rc&lt;RefCell&lt;T&gt;&gt;</code> æ›¿æ¢ä¸º  <code>Arc&lt;Mutex&lt;T&gt;&gt;</code> æˆ–è€…  <code>Arc&lt;RwLock&lt;T&gt;&gt;</code>ã€‚æ›´å¤šæœ‰å…³ Arc/Mutex/RwLock çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬ä¼šåœ¨å¹¶å‘ç¯‡è¯¦ç»†ä»‹ç»ã€‚</p><h2>å°ç»“</h2><p>æˆ‘ä»¬å¯¹æ‰€æœ‰æƒæœ‰äº†æ›´æ·±å…¥çš„äº†è§£ï¼ŒæŒæ¡äº† Rc / Arcã€RefCell / Mutex / RwLock è¿™äº›æ•°æ®ç»“æ„çš„ç”¨æ³•ã€‚</p><p>å¦‚æœæƒ³ç»•è¿‡â€œä¸€ä¸ªå€¼åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…â€çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong>Rc / Arc è¿™æ ·å¸¦å¼•ç”¨è®¡æ•°çš„æ™ºèƒ½æŒ‡é’ˆ</strong>ã€‚å…¶ä¸­ï¼ŒRc æ•ˆç‡å¾ˆé«˜ï¼Œä½†åªèƒ½ä½¿ç”¨åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼›Arc ä½¿ç”¨äº†åŸå­ç»“æ„ï¼Œæ•ˆç‡ç•¥ä½ï¼Œä½†å¯ä»¥å®‰å…¨ä½¿ç”¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ã€‚</p><p>ç„¶è€Œï¼ŒRc / Arc æ˜¯ä¸å¯å˜çš„ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹å†…éƒ¨çš„æ•°æ®ï¼Œ<strong>éœ€è¦å¼•å…¥å†…éƒ¨å¯å˜æ€§</strong>ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯ä»¥åœ¨ Rc å†…éƒ¨ä½¿ç”¨ RefCellï¼›åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ Arc åµŒå¥— Mutex æˆ–è€… RwLock çš„æ–¹æ³•ã€‚</p><p>ä½ å¯ä»¥çœ‹è¿™å¼ è¡¨å¿«é€Ÿå›é¡¾ï¼š<img src=\"https://static001.geekbang.org/resource/image/fc/86/fc524d667fabeec0a8a22d0e10531086.jpg?wh=3387x1982\" alt=\"\"></p><h3>æ€è€ƒé¢˜</h3><ol>\n<li>è¿è¡Œä¸‹é¢çš„ä»£ç ï¼ŒæŸ¥çœ‹é”™è¯¯ï¼Œå¹¶é˜…è¯» <a href=\"https://doc.rust-lang.org/std/thread/fn.spawn.html\">std::thread::spawn</a> çš„æ–‡æ¡£ï¼Œæ‰¾åˆ°é—®é¢˜çš„åŸå› åï¼Œä¿®æ”¹ä»£ç ä½¿å…¶ç¼–è¯‘é€šè¿‡ã€‚</li>\n</ol><pre><code class=\"language-rust\">fn main() {\n&nbsp; let arr = vec![1];\n\n&nbsp; std::thread::spawn(|| {\n&nbsp; &nbsp; println!(\"{:?}\", arr);\n&nbsp; });\n}\n</code></pre><ol start=\"2\">\n<li>\n<p>ä½ å¯ä»¥å†™ä¸€æ®µä»£ç ï¼Œåœ¨ main() å‡½æ•°é‡Œç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡  <code>std::thread::spawn</code> åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè®© main() å‡½æ•°æ‰€åœ¨çš„ä¸»çº¿ç¨‹å’Œæ–°çš„çº¿ç¨‹å…±äº«è¿™ä¸ªå­—ç¬¦ä¸²ä¹ˆï¼Ÿæç¤ºï¼šä½¿ç”¨ <a href=\"https://doc.rust-lang.org/std/sync/struct.Arc.html\">std::sync::Arc</a>ã€‚</p>\n</li>\n<li>\n<p>æˆ‘ä»¬çœ‹åˆ°äº† Rc çš„ clone() æ–¹æ³•çš„å®ç°ï¼š</p>\n</li>\n</ol><pre><code class=\"language-rust\">fn clone(&amp;self) -&gt; Rc&lt;T&gt; {\n    // å¢åŠ å¼•ç”¨è®¡æ•°\n    self.inner().inc_strong();\n    // é€šè¿‡ self.ptr ç”Ÿæˆä¸€ä¸ªæ–°çš„ Rc ç»“æ„\n    Self::from_inner(self.ptr)\n}\n</code></pre><p>ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•ä¼ å…¥çš„å‚æ•°æ˜¯  <code>&amp;self</code> ï¼Œæ˜¯ä¸ªä¸å¯å˜å¼•ç”¨ï¼Œç„¶è€Œå®ƒè°ƒç”¨äº†  <code>self.inner().inc_strong()</code> ï¼Œå…‰çœ‹å‡½æ•°åå­—ï¼Œå®ƒç”¨æ¥å¢åŠ  self çš„å¼•ç”¨è®¡æ•°ï¼Œå¯æ˜¯ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œå¯¹ self çš„ä¸å¯å˜å¼•ç”¨å¯ä»¥æ”¹å˜ self çš„å†…éƒ¨æ•°æ®å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æ­å–œä½ å®Œæˆäº† Rust å­¦ä¹ çš„ç¬¬ä¹æ¬¡æ‰“å¡ï¼Œå¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€TAä¸€èµ·è®¨è®ºã€‚</p><h2>å‚è€ƒèµ„æ–™</h2><ol>\n<li>clone() å‡½æ•°çš„<a href=\"https://doc.rust-lang.org/src/alloc/rc.rs.html#1433-1453\">å®ç°æºç </a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Principle_of_least_privilege\">æœ€å°æƒé™åŸåˆ™</a></li>\n<li>Rc::new() çš„<a href=\"https://doc.rust-lang.org/src/alloc/rc.rs.html#342-350\">æºç </a></li>\n<li>Arc å†…éƒ¨çš„å¼•ç”¨è®¡æ•°ä½¿ç”¨äº† <a href=\"https://doc.rust-lang.org/src/alloc/sync.rs.html#303-312\">Atomic Usize</a></li>\n<li>Atomic Usize æ˜¯ usize çš„åŸå­ç±»å‹ï¼š <a href=\"https://doc.rust-lang.org/std/sync/atomic/index.html\">std::sync::atomic çš„æ–‡æ¡£</a></li>\n<li>å†…éƒ¨å¯å˜æ€§ï¼šé™¤äº† RefCell  ä¹‹å¤–ï¼ŒRust è¿˜æä¾›äº† Cellã€‚å¦‚æœä½ æƒ³å¯¹ RefCell å’Œ Cell è¿›ä¸€æ­¥äº†è§£ï¼Œå¯ä»¥çœ‹ Rust æ ‡å‡†åº“é‡Œ<a href=\"https://doc.rust-lang.org/std/cell/index.html\">cell çš„æ–‡æ¡£</a>ã€‚</li>\n</ol>","neighbors":{"left":{"article_title":"08ï½œæ‰€æœ‰æƒï¼šå€¼çš„å€Ÿç”¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ","id":415988},"right":{"article_title":"10ï½œç”Ÿå‘½å‘¨æœŸï¼šä½ åˆ›å»ºçš„å€¼ç©¶ç«Ÿèƒ½æ´»å¤šä¹…ï¼Ÿ","id":417384}},"comments":[{"had_liked":false,"id":311592,"user_name":"æœ‰é“­","can_delete":false,"product_type":"c1","uid":1046302,"ip_address":"","ucode":"2C7CB36CA5C04C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132","comment_is_top":true,"comment_ctime":1631328099,"is_pvip":false,"replies":[{"id":"112999","content":"è¿™ä¸ªä¸–ç•Œæœ¬å°±ä¸çº¯ç²¹ï¼Œæ²¡æœ‰ç»å¯¹çš„å®Œç¾ã€‚æ‰€æœ‰çš„è¯­è¨€éƒ½ä¼šæ’•å¼€ä¸€é“å£å­ï¼ŒHaskell ä¹Ÿéœ€è¦ IO Monad å’Œå¤–ç•Œæ‰“äº¤é“ï¼ŒErlang VM ä¹Ÿå¾—å¿ç€å¯èƒ½ crash VM çš„é£é™©å¼•å…¥ NIF (native function) ç­‰ç­‰ã€‚ä¸å…‰è¯­è¨€å¦‚æ­¤ï¼Œæ¡†æ¶ä¹Ÿå¦‚æ­¤ï¼Œç»™ä½ è§£å†³ 80% é—®é¢˜çš„åˆ©å™¨ï¼Œä¹Ÿä¿ç•™è®©ä½ è§£å†³å‰©ä¸‹ 20% é—®é¢˜çš„çµæ´»åº¦ã€‚è¿™è¿˜åªæ˜¯ä¸€ä¸ª Box:leak&#47;Box::into_raw&#47;ManuallyDropï¼ŒRust è¿˜æœ‰ unsafe å‘¢...åˆ«ç€æ€¥ä¸‹ç»“è®ºï¼Œè®©å­å¼¹é£ä¸€ä¼šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631516186,"ip_address":"","comment_id":311592,"utype":1}],"discussion_count":5,"race_medal":0,"score":"9.2233722661193994e+18","product_id":100085301,"comment_content":"ä»Šå¤©è¿™ç« æˆ‘çœ‹å®Œä»¥åæ„Ÿè§‰æœ‰ä¸€è‚¡éå¸¸é—æ†¾çš„æƒ…ç»ªï¼š<br>æˆ‘åŸæœ¬ä»¥ä¸ºrustçœŸçš„ç”¨ç¼–è¯‘æ—¶æ£€æŸ¥è§£å†³äº†å½“å¹´C++é¢ä¸´çš„é‚£äº›é—®é¢˜ã€‚ç»“æœæœ€åè¿˜æ˜¯å¦¥åæ’•å¼€äº†ä¸€é“å£å­å¼€äº†åé—¨ï¼Œè€Œä¸”è¿™ä¸ªåé—¨å¼€çš„å¾ˆå¤æ‚ï¼Œæˆ‘çš„æ„Ÿè§‰ï¼Œè¿™ä¸ªç‰¹æ€§ï¼Œå°†æ¥è¦ä¹ˆå°±æ˜¯æ²¡ä»€ä¹ˆäººç”¨ï¼Œè¦ä¹ˆå°±æ˜¯è¢«äººæ»¥ç”¨ã€‚è¿™ä¸ªä¸œè¥¿å¯¹äººçš„è‡ªæ§è¦æ±‚å¤ªé«˜äº†","like_count":54,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526672,"discussion_content":"è¿™ä¸ªä¸–ç•Œæœ¬å°±ä¸çº¯ç²¹ï¼Œæ²¡æœ‰ç»å¯¹çš„å®Œç¾ã€‚æ‰€æœ‰çš„è¯­è¨€éƒ½ä¼šæ’•å¼€ä¸€é“å£å­ï¼ŒHaskell ä¹Ÿéœ€è¦ IO Monad å’Œå¤–ç•Œæ‰“äº¤é“ï¼ŒErlang VM ä¹Ÿå¾—å¿ç€å¯èƒ½ crash VM çš„é£é™©å¼•å…¥ NIF (native function) ç­‰ç­‰ã€‚ä¸å…‰è¯­è¨€å¦‚æ­¤ï¼Œæ¡†æ¶ä¹Ÿå¦‚æ­¤ï¼Œç»™ä½ è§£å†³ 80% é—®é¢˜çš„åˆ©å™¨ï¼Œä¹Ÿä¿ç•™è®©ä½ è§£å†³å‰©ä¸‹ 20% é—®é¢˜çš„çµæ´»åº¦ã€‚è¿™è¿˜åªæ˜¯ä¸€ä¸ª Box:leak/Box::into_raw/ManuallyDropï¼ŒRust è¿˜æœ‰ unsafe å‘¢...åˆ«ç€æ€¥ä¸‹ç»“è®ºï¼Œè®©å­å¼¹é£ä¸€ä¼šã€‚","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1631516186,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":1642586,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/5a/3411221e.jpg","nickname":"Heidi","note":"","ucode":"2751FD284068AA","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":590213,"discussion_content":"ç¡®å®æ²¡å¹çš„é‚£ä¹ˆå®Œç¾ï¼Œè€Œä¸”å¼€å‘æ•ˆç‡ä¹Ÿå¹¶ä¸é«˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665624688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":526672,"ip_address":"ä¸Šæµ·"},"score":590213,"extra":""},{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":1642586,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/5a/3411221e.jpg","nickname":"Heidi","note":"","ucode":"2751FD284068AA","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":590217,"discussion_content":"æ©ä»»ä½•è¯­è¨€éƒ½æœ‰ä¼˜åŠ£åŠ¿ï¼Œæ ¹æ®å®é™…å¼€å‘éœ€è¦ï¼Œç†æ€§é€‰æ‹©","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665625768,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":590213,"ip_address":"åŒ—äº¬"},"score":590217,"extra":""},{"author":{"id":1050018,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/a2/721ae4c6.jpg","nickname":"Jervis","note":"","ucode":"86C02C483449CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"discussion":{"id":591553,"discussion_content":"å­˜åœ¨è¿™ç§å¯èƒ½å—ï¼Ÿåªè¦èƒ½ç”¨javaçš„ï¼Œä¸æ˜¯javaæ¢­å“ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666658681,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":590217,"ip_address":"å¹¿ä¸œ"},"score":591553,"extra":""}]},{"author":{"id":1050018,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/a2/721ae4c6.jpg","nickname":"Jervis","note":"","ucode":"86C02C483449CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591554,"discussion_content":"çœ‹åˆ°è¿™é‡ŒåŒæ„Ÿï¼Œç¡®å®ç”Ÿäº§åŠ›ä¸å‹å¥½ã€‚ä¸çŸ¥é“æœ‰æ²¡æœ‰ä¼˜åŒ–çš„è®¡åˆ’ã€‚  @Tyr","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666658809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338602,"user_name":"æ¸…é£å¾æ¥","can_delete":false,"product_type":"c1","uid":1202697,"ip_address":"","ucode":"2AAA5B8DE30DF9","user_header":"https://static001.geekbang.org/account/avatar/00/12/5a/09/afa3e112.jpg","comment_is_top":true,"comment_ctime":1647590878,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"9.2233720900419994e+18","product_id":100085301,"comment_content":"è€å¸ˆé—®ä¸€ä¸ªé¢å¤–çš„é—®é¢˜<br>ä»¥anyhowã€clapåº“ä¸ºä¾‹ï¼Œé€šç¯‡çœ‹rustæŠ€æœ¯æ–‡æ¡£æœ‰ä¸€ç§å¾ˆè’™è”½çš„æ„Ÿè§‰ï¼Œæ„Ÿè§‰æ–‡æ¡£åªæ˜¯æŠŠæŠ€æœ¯ç‚¹æ‹†çš„å¾ˆé›¶ç¢è¿›è¡Œè¯´æ˜ï¼ˆå¦‚ï¼šæœ‰å“ªäº›structã€traitç­‰ï¼‰ï¼Œå¤–åŠ ä¸€ä¸ªæ²¡æœ‰å®è´¨æ€§å¸®åŠ©çš„ä¸ºä¾‹æ–‡æ¡£ä»£ç ï¼Œæ„Ÿè§‰å’Œå…¶ä»–è¯­è¨€çš„æŠ€æœ¯æ–‡æ¡£å¾ˆä¸ä¸€æ ·ï¼›ä¸€å¥è¯æ¥è¯´æ˜ï¼šæ–‡æ¡£æè¿°æ‹†çš„å¾ˆé›¶ç¢ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªæ¸…æ™°åœ°æ•´ä½“çš„ç»Ÿä¸€ä½¿ç”¨è¯´æ˜ï¼Œè‡´ä½¿æ— ä»ä¸‹æ‰‹ï¼›è¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿï¼Ÿï¼Ÿ","like_count":13,"discussions":[{"author":{"id":1200299,"avatar":"https://static001.geekbang.org/account/avatar/00/12/50/ab/6584e520.jpg","nickname":"é™ˆé¡ºå‰","note":"","ucode":"315732AEA35CD1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565357,"discussion_content":"æ–‡æ¡£åªæ˜¯ç”Ÿæˆå‡ºæ¥çš„ï¼Œè¿™ä¸ªå®Œå…¨å°±æ˜¯åº“ä½œè€…å·æ‡’ï¼Œä¸æ„¿æ„å†™æ–‡æ¡£","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1650447951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2412264,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ce/e8/8b3126d0.jpg","nickname":"å°å¥¶ç²¾","note":"","ucode":"EB264B3ADC20AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557591,"discussion_content":"åŒæ ·æœ‰è¿™æ ·çš„æ„Ÿå—ï¼Œåœ¨ç¬¬ä¸€æ¬¡ç¿»çœ‹æŸä¸ªåº“æ–‡æ¡£æ—¶ï¼Œå¾€å¾€å¾ˆéš¾æ‰¾åˆ°ä¸€ä¸ªæ•´ä½“çš„æŠ“æ‰‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647873836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2126729,"avatar":"https://static001.geekbang.org/account/avatar/00/20/73/89/3082c8a1.jpg","nickname":"Jin Se","note":"","ucode":"B731A09BA1BC16","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2412264,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ce/e8/8b3126d0.jpg","nickname":"å°å¥¶ç²¾","note":"","ucode":"EB264B3ADC20AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":578495,"discussion_content":"æŠ“æ‰‹ ä½ æ˜¯é˜¿é‡Œçš„å—ğŸ¶","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1656832813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":557591,"ip_address":""},"score":578495,"extra":""}]}]},{"had_liked":false,"id":311405,"user_name":"åƒå›ç™¾è½¬æ— åŠ«å±±","can_delete":false,"product_type":"c1","uid":1456256,"ip_address":"","ucode":"2C249889C00929","user_header":"","comment_is_top":false,"comment_ctime":1631209153,"is_pvip":true,"replies":[{"id":"112849","content":"èµï¼éå¸¸æ£’çš„å›ç­”ã€‚ç¬¬ 3 é¢˜å…¶å®ä¸ç”¨çœ‹ä»£ç ä¹Ÿå¯ä»¥å°è¯•çŒœä¸€ä¸‹ï¼šå½“ä¸€ä¸ªåªè¯»å¼•ç”¨å¯ä»¥ä¿®æ”¹å†…éƒ¨æ•°æ®æ—¶ï¼Œå®ƒä¸€å®šæ˜¯ç”¨äº†å†…éƒ¨å¯å˜æ€§ã€‚:)<br><br>ä¸€ä¸ªå®é™…ä½¿ç”¨çš„ç³»ç»Ÿä¸€å®šæ˜¯ç¬¦åˆäºŒå…«å®šå¾‹çš„ï¼šå¯ä»¥ç”¨å°‘é‡è§„åˆ™æ¥æ»¡è¶³ 80%çš„åº”ç”¨åœºæ™¯ã€‚ä½†æ€»è¿˜æœ‰ä¾‹å¤–éœ€è¦å¤„ç†ã€‚æ‰€ä»¥ç¼–è¯‘æœŸå°½ç®¡èƒ½è§£å†³ç»å¤§å¤šæ•°çš„åº”ç”¨åœºæ™¯ï¼Œä½†æ˜¯è§£å†³ä¸äº†çš„æ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦è¿è¡ŒæœŸçš„æ£€æŸ¥æ¥å¼¥è¡¥ã€‚<br><br>è¿™å°±æ¶‰åŠåˆ°å¦‚ä½•æƒè¡¡äº†ã€‚Rust çš„é€‰æ‹©æ˜¯æœ€å°æƒé™åŸåˆ™ï¼Œä½ åªæœ‰æ˜¾å¼åœ°è¦æ±‚ï¼ˆæ¯”å¦‚æ•°æ®ç»“æ„ç”¨ Arc&lt;T&gt; å°è£…ï¼‰ï¼Œæ‰ä¼šè¿›è¡Œé¢å¤–çš„å¤„ç†ï¼ˆç»´æŠ¤å¼•ç”¨è®¡æ•°ï¼‰ã€‚å…¶å®è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ’°å†™è½¯ä»¶ç³»ç»Ÿæ—¶åº”è¯¥éµå¾ªçš„åŸåˆ™ã€‚<br><br>è°ˆåˆ°æ»¥ç”¨ï¼Œæœ€å°æƒé™åŸåˆ™æ°æ°æ˜¯ä¸ºäº†é˜²æ­¢æ»¥ç”¨ã€‚æ¯”å¦‚ mutï¼Œå½“ä½ å®é™…ä¸éœ€è¦çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥è­¦ã€‚Rc&#47;Arc ä¸å¿…è¦çš„ cloneï¼Œclippyï¼ˆRust çš„ linting å·¥å…·ï¼‰ ä¼šæç¤ºã€‚<br><br>å¦‚æœã€Œæ»¥ç”¨ã€æ™ºèƒ½æŒ‡é’ˆï¼Œå¹¶ä¸ä¼šå¯¼è‡´å†…å­˜å®‰å…¨æ— æ³•ä¿è¯ï¼Œæ¯”å¦‚ä½ åœ¨ä¸éœ€è¦çš„æ—¶å€™ä½¿ç”¨ Arcï¼ŒæŸå¤±çš„æ˜¯ atomic compare_and_swap æ—¶çš„æ€§èƒ½ï¼Œä½†ä¸ä¼šå¸¦æ¥å®‰å…¨é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631237370,"ip_address":"","comment_id":311405,"utype":1}],"discussion_count":3,"race_medal":0,"score":"130480228033","product_id":100085301,"comment_content":"1. é”™è¯¯ä¸ºçº¿ç¨‹å€Ÿç”¨çš„arrç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¼šé•¿äºmainå‡½æ•°ä¸­çš„arrï¼Œç®€å•å¤„ç†çš„è¯æŠŠmainä¸­arrçš„æ‰€æœ‰æƒmoveåˆ°çº¿ç¨‹é‡Œå³å¯ï¼Œç¼–è¯‘å™¨å¯¹æ­¤æœ‰è¯¦å°½çš„æç¤ºï¼š<br>```rust<br>fn main() {<br>    let arr = vec![1];<br><br>    std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    });<br>}<br>```<br>2. è¿™ä¸ªé—®é¢˜å…¶å®æ˜¯ç¬¬1ä¸ªé—®é¢˜çš„å»¶ç»­ï¼Œå¦‚æœå°†mainä¸­å˜é‡çš„æ‰€æœ‰æƒmoveåˆ°çº¿ç¨‹ä¸­ï¼Œé‚£ä¹ˆåœ¨mainä¸­å°†æ— æ³•è®¿é—®ï¼Œæ‰€ä»¥ä½¿ç”¨Arcè¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆå³å¯å®ç°å…±äº«æ‰€æœ‰æƒï¼š<br>```rust<br>use std::sync::Arc;<br>fn main() {<br>    let s = Arc::new(&quot;rust rocks!&quot;);<br>    let s1 = s.clone();<br><br>    let handler = std::thread::spawn(move || {<br>        println!(&quot;thread: {:?}&quot;, s1);<br>    });<br>    println!(&quot;main: {:?}&quot;, s);<br>    handler.join().unwrap();<br>}<br>```<br>3. ä¸å¤ªç¡®å®šï¼ŒæŸ¥æ–‡æ¡£çœ‹è°ƒç”¨é“¾æ˜¯inneræ–¹æ³•è¿”å›äº†RcBoxï¼ŒRcBoxè°ƒç”¨çš„inc_strongæ˜¯RcInnerPtrè¿™ä¸ªtraitçš„æ–¹æ³•ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨è¯¥traitçš„strong_refæ–¹æ³•è¿”å›cellï¼Œè€Œcellæ˜¯ä¸€ä¸ªå¯å˜çš„å…±äº«å®¹å™¨ï¼Œå³æœ€ç»ˆé€šè¿‡cellå…±äº«å†…å­˜æ¥æ”¹å˜å†…éƒ¨æ•°æ®ã€‚<br><br>çœ‹å®Œè¿™ä¸€å°èŠ‚äº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼Œæœ¬å°èŠ‚ä»‹ç»çš„æ™ºèƒ½æŒ‡é’ˆéƒ½æ˜¯ä¸ºäº†çªç ´rustç¼–è¯‘æœŸçš„æ‰€æœ‰æƒè§„åˆ™é™åˆ¶ã€‚é‚£ä¸ºä»€ä¹ˆè¦å…ˆåšé™åˆ¶å†æä¾›çªç ´é™åˆ¶çš„æ–¹æ³•å‘¢ï¼Ÿè¿™æ ·åšçš„æ„ä¹‰æ˜¯å¦å¯ä»¥ç†è§£ä¸ºå°±åƒunsafeæˆ–è€…æœ€å°æƒé™åŸåˆ™ä¸€æ ·ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéµå¾ªæ‰€æœ‰æƒè§„åˆ™ï¼Œä»…åœ¨å¿…è¦çš„æ—¶å€™ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆæ¥çªç ´é™åˆ¶ï¼Ÿå¦‚æœç”¨æˆ·æ»¥ç”¨äº†æ™ºèƒ½æŒ‡é’ˆï¼Œé‚£ä¹ˆæ˜¯å¦å°±åƒæ»¥ç”¨äº†unsafeä¸€æ ·ï¼Œrustå†…å­˜å®‰å…¨ç­‰ç‰¹æ€§å°±æ— æ³•ä¿è¯äº†ï¼Ÿ","like_count":30,"discussions":[{"author":{"id":1456256,"avatar":"","nickname":"åƒå›ç™¾è½¬æ— åŠ«å±±","note":"","ucode":"2C249889C00929","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393071,"discussion_content":"æ˜ç™½äº†ï¼Œä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆå’Œä½¿ç”¨unsafeè¿˜æ˜¯ä¸åŒçš„ï¼Œæ„Ÿè°¢è€å¸ˆçš„å›å¤å’Œlisiurçš„è¯„è®ºï¼","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1631240500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1201350,"avatar":"https://static001.geekbang.org/account/avatar/00/12/54/c6/c2481790.jpg","nickname":"lisiur","note":"","ucode":"CEB2DBCE29CAA7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393062,"discussion_content":"æˆ‘ä¸ªäººè§‰å¾—ï¼Œå¦‚æœä¸æ¶‰åŠunsafeï¼Œå³ä½¿æ»¥ç”¨æ™ºèƒ½æŒ‡é’ˆä¹Ÿä¸ä¼šå¯¼è‡´å†…å­˜å®‰å…¨é—®é¢˜ï¼ˆå†…å­˜æ³„æ¼åœ¨rusté‡Œä¸ç®—å†…å­˜å®‰å…¨é—®é¢˜ï¼‰ï¼Œå†…éƒ¨å¯å˜æ€§åœ¨é™æ€è¯­æ³•ä¸Šæ²¡æœ‰çªç ´æ‰€æœ‰æƒè§„åˆ™ï¼Œåœ¨è¿è¡Œæ—¶å…¶å®ä¹Ÿè¿˜æ˜¯æœ‰åŠ¨æ€çš„æ‰€æœ‰æƒè§„åˆ™çº¦æŸï¼Œä¸€æ—¦å‡ºç°é—®é¢˜å°±ä¼šæŠ¥é”™ã€‚","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1631238867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526588,"discussion_content":"èµï¼éå¸¸æ£’çš„å›ç­”ã€‚ç¬¬ 3 é¢˜å…¶å®ä¸ç”¨çœ‹ä»£ç ä¹Ÿå¯ä»¥å°è¯•çŒœä¸€ä¸‹ï¼šå½“ä¸€ä¸ªåªè¯»å¼•ç”¨å¯ä»¥ä¿®æ”¹å†…éƒ¨æ•°æ®æ—¶ï¼Œå®ƒä¸€å®šæ˜¯ç”¨äº†å†…éƒ¨å¯å˜æ€§ã€‚:)\n\nä¸€ä¸ªå®é™…ä½¿ç”¨çš„ç³»ç»Ÿä¸€å®šæ˜¯ç¬¦åˆäºŒå…«å®šå¾‹çš„ï¼šå¯ä»¥ç”¨å°‘é‡è§„åˆ™æ¥æ»¡è¶³ 80%çš„åº”ç”¨åœºæ™¯ã€‚ä½†æ€»è¿˜æœ‰ä¾‹å¤–éœ€è¦å¤„ç†ã€‚æ‰€ä»¥ç¼–è¯‘æœŸå°½ç®¡èƒ½è§£å†³ç»å¤§å¤šæ•°çš„åº”ç”¨åœºæ™¯ï¼Œä½†æ˜¯è§£å†³ä¸äº†çš„æ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦è¿è¡ŒæœŸçš„æ£€æŸ¥æ¥å¼¥è¡¥ã€‚\n\nè¿™å°±æ¶‰åŠåˆ°å¦‚ä½•æƒè¡¡äº†ã€‚Rust çš„é€‰æ‹©æ˜¯æœ€å°æƒé™åŸåˆ™ï¼Œä½ åªæœ‰æ˜¾å¼åœ°è¦æ±‚ï¼ˆæ¯”å¦‚æ•°æ®ç»“æ„ç”¨ Arc&amp;lt;T&amp;gt; å°è£…ï¼‰ï¼Œæ‰ä¼šè¿›è¡Œé¢å¤–çš„å¤„ç†ï¼ˆç»´æŠ¤å¼•ç”¨è®¡æ•°ï¼‰ã€‚å…¶å®è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ’°å†™è½¯ä»¶ç³»ç»Ÿæ—¶åº”è¯¥éµå¾ªçš„åŸåˆ™ã€‚\n\nè°ˆåˆ°æ»¥ç”¨ï¼Œæœ€å°æƒé™åŸåˆ™æ°æ°æ˜¯ä¸ºäº†é˜²æ­¢æ»¥ç”¨ã€‚æ¯”å¦‚ mutï¼Œå½“ä½ å®é™…ä¸éœ€è¦çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥è­¦ã€‚Rc/Arc ä¸å¿…è¦çš„ cloneï¼Œclippyï¼ˆRust çš„ linting å·¥å…·ï¼‰ ä¼šæç¤ºã€‚\n\nå¦‚æœã€Œæ»¥ç”¨ã€æ™ºèƒ½æŒ‡é’ˆï¼Œå¹¶ä¸ä¼šå¯¼è‡´å†…å­˜å®‰å…¨æ— æ³•ä¿è¯ï¼Œæ¯”å¦‚ä½ åœ¨ä¸éœ€è¦çš„æ—¶å€™ä½¿ç”¨ Arcï¼ŒæŸå¤±çš„æ˜¯ atomic compare_and_swap æ—¶çš„æ€§èƒ½ï¼Œä½†ä¸ä¼šå¸¦æ¥å®‰å…¨é—®é¢˜ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1631237370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311441,"user_name":"lisiur","can_delete":false,"product_type":"c1","uid":1201350,"ip_address":"","ucode":"CEB2DBCE29CAA7","user_header":"https://static001.geekbang.org/account/avatar/00/12/54/c6/c2481790.jpg","comment_is_top":false,"comment_ctime":1631238553,"is_pvip":false,"replies":[{"id":"112855","content":"è°¢è°¢ä½ è¿™ä¹ˆæœ‰æ·±åº¦çš„æ€è€ƒï¼<br><br>ç¼–è¯‘å™¨æ˜¯ä¸€ä¸ªä¸æ–­è¿›åŒ–çš„è¿‡ç¨‹ï¼Œåœ¨åŸºæœ¬çš„è§„åˆ™ä¸‹ï¼Œå®ƒå¯ä»¥å°½å¯èƒ½å¤šåœ°æŠŠå¸¸è§çš„ï¼Œå¹¶ä¸”åˆæ³•çš„æƒ…å†µå¤„ç†æ‰ï¼Œä¸ç»™å¼€å‘è€…å¤ªå¤šçš„è´Ÿæ‹…ã€‚æ‰€ä»¥å¯ä»¥å¼•ç”¨å¼•å…¥äº†æ˜¯å¦æ´»è·ƒçš„æ¦‚å¿µï¼Œä»¥åŠ NLLï¼ˆhttps:&#47;&#47;rust-lang.github.io&#47;rfcs&#47;2094-nll.htmlï¼‰ã€‚<br><br>å¯¹äºæ–‡ä¸­çš„å†…éƒ¨å¯å˜æ€§çš„ä¾‹å­ï¼Œæ£€æŸ¥å®Œå…¨æœ‰èµ–æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°æ¥ç¡®ä¿ã€‚çš„ç¡®ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼Œåœ¨ç¼–è¯‘æœŸå®Œå…¨æœ‰å¯èƒ½æŠŠåŸæœ¬åœ¨ä½œç”¨åŸŸç»“æŸæ—¶ drop çš„ v æå‰åˆ° v ä½¿ç”¨å®Œçš„åœ°æ–¹ï¼š<br><br>```rust<br><br>use std::cell::RefCell;<br><br>fn main() {<br>    let data = RefCell::new(1);<br>    <br>    &#47;&#47; è·å¾— RefCell å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨<br>    let mut v = data.borrow_mut();<br>    *v += 1;<br>    &#47;&#47; æå‰ drop å¯å˜å¼•ç”¨<br>    drop(v);<br>    <br>    println!(&quot;data: {:?}&quot;, data.borrow());<br>    <br>    &#47;&#47; éšå«çš„ drop<br>    &#47;&#47; åŸæœ¬ drop(v) å‘ç”Ÿåœ¨è¿™é‡Œ<br>    drop(data);<br>}<br>```<br><br>è¿™æ ·å¯ä»¥é¿å…é¢å¤–çš„ä½œç”¨åŸŸã€‚<br><br>ä½†æ˜¯ï¼Œå¦‚æœè¿™æ ·åšï¼Œç¼–è¯‘å™¨å°±æ˜¯åœ¨ä¸ºæŸä¸ªç‰¹å®šçš„æ•°æ®ç»“æ„ RefCellï¼Œè€Œé Rust çš„è¯­æ³•å•å…ƒ &amp;mut æ¥åšä¼˜åŒ–äº†ã€‚ä»ç³»ç»Ÿè®¾è®¡çš„è§’åº¦ï¼Œé™¤éèƒ½æ‰¾åˆ°ä¸€ç§å¾ˆé€šç”¨çš„æ–¹æ³•ï¼ˆæ¯”å¦‚è®¾è®¡ä¸€ä¸ªæ–°çš„åƒ Send&#47;Sync&#47;Unpin è¿™æ ·çš„ auto trait å¯¹æ‰€æœ‰å®ç°äº†è¿™ä¸ª auto trait çš„æ•°æ®ç»“æ„è¿›è¡Œä¼˜åŒ–ï¼‰ï¼Œå¦åˆ™ï¼Œç¼–è¯‘å™¨éœ€è¦çŸ¥é“å“ªä¸ªæ•°æ®ç»“æ„åœ¨åšå“ªä¸ªæ“ä½œçš„æ—¶å€™éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚è¿™å°±ä¼šè®©ç¼–è¯‘å™¨æœ¬èº«çš„è®¾è®¡å˜å¾—å¤æ‚ã€‚<br><br>ä¸ªäººæ„è§ï¼Œä¸ä»£è¡¨ç¼–è¯‘å™¨å›¢é˜Ÿçš„æ€è·¯ :)<br><br><br>","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631242018,"ip_address":"","comment_id":311441,"utype":1}],"discussion_count":3,"race_medal":0,"score":"117595355545","product_id":100085301,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œåœ¨ä»£ç 3é‡Œï¼ŒæŠŠå†…éƒ¨ä½œç”¨åŸŸå»æ‰ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨æ™®é€šçš„å€Ÿç”¨æ–¹å¼åƒè¿™æ ·ï¼š<br><br>```rust<br>fn main() {<br>    let mut data = 1;<br>    let v = &amp;mut data;<br>    *v += 1;<br>    println!(&quot;data: {:?}&quot;, &amp;data);<br>}<br>```<br><br>å´ä¸éœ€è¦ä½¿ç”¨å¤šä½™çš„ä½œç”¨åŸŸã€‚<br><br>æˆ‘çš„ç†è§£æ˜¯æ™®é€šçš„å€Ÿç”¨æ–¹å¼èµ°çš„æ˜¯ç¼–è¯‘æœŸæ£€æŸ¥ï¼Œç¼–è¯‘å™¨æ ‡è®°å€Ÿç”¨çš„ç”Ÿå‘½æœŸçš„ç²’åº¦æ¯”ä½œç”¨åŸŸè¦å°ï¼Œæ¯”å¦‚ä¸Šè¿°ä»£ç çš„ mut å€Ÿç”¨ï¼Œæ­£å¸¸çš„ç”Ÿå‘½æœŸåº”è¯¥æ˜¯åˆ°mainå‡½æ•°ç»“æŸï¼Œä½†æ˜¯ç¼–è¯‘å™¨åº”è¯¥æ˜¯æŠŠå®ƒç¼©å°åˆ°äº† println ä»£ç ä¹‹å‰çš„ä½ç½®ï¼Œæ‰€ä»¥ println çš„ä¸å¯å˜å€Ÿç”¨å¹¶ä¸å’Œä¸Šé¢çš„å¯å˜å€Ÿç”¨å†²çªã€‚ä½†æ˜¯è¿è¡Œæ—¶çš„&quot;ç”Ÿå‘½æœŸæ£€æŸ¥&quot;åº”è¯¥å°±æ˜¯ä½œç”¨åŸŸç²’åº¦çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨é¢å¤–çš„ä½œç”¨åŸŸæ¥è¾¾åˆ°æ‰‹åŠ¨ drop å¯å˜å€Ÿç”¨çš„æ•ˆæœã€‚<br><br>æˆ‘çš„æƒ³æ³•æ˜¯ï¼Œæ—¢ç„¶ç¼–è¯‘æœŸèƒ½å¤Ÿåšåˆ°å°½å¯èƒ½å°çš„ç¼©å°å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ç¼–è¯‘å™¨èƒ½ä¸èƒ½è‡ªåŠ¨å¯¹è¿™ç§ç‰¹æ®Šçš„å†…éƒ¨å¯å˜æ€§çš„å€Ÿç”¨åœ¨åˆé€‚çš„ä½ç½®æ’å…¥dropä»£ç ï¼Œä½¿å¾—ä¸ä½¿ç”¨é¢å¤–çš„ä½œç”¨åŸŸä¹Ÿèƒ½æ»¡è¶³è¿è¡Œæ—¶æ£€æŸ¥å‘¢ï¼Ÿ","like_count":27,"discussions":[{"author":{"id":2709342,"avatar":"https://static001.geekbang.org/account/avatar/00/29/57/5e/2565df70.jpg","nickname":"æ½ä½™æœˆ","note":"","ucode":"D75ABAA841C23A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549584,"discussion_content":"å¯ä»¥ç®€åŒ–ä¸€ä¸‹ä»£ç ï¼Œè®©å®ƒåœ¨å½“å‰ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰æ‰€æœ‰è€…ï¼š\n*data.borrow_mut() += 1;","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1644115154,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526605,"discussion_content":"è°¢è°¢ä½ è¿™ä¹ˆæœ‰æ·±åº¦çš„æ€è€ƒï¼\n\nç¼–è¯‘å™¨æ˜¯ä¸€ä¸ªä¸æ–­è¿›åŒ–çš„è¿‡ç¨‹ï¼Œåœ¨åŸºæœ¬çš„è§„åˆ™ä¸‹ï¼Œå®ƒå¯ä»¥å°½å¯èƒ½å¤šåœ°æŠŠå¸¸è§çš„ï¼Œå¹¶ä¸”åˆæ³•çš„æƒ…å†µå¤„ç†æ‰ï¼Œä¸ç»™å¼€å‘è€…å¤ªå¤šçš„è´Ÿæ‹…ã€‚æ‰€ä»¥å¯ä»¥å¼•ç”¨å¼•å…¥äº†æ˜¯å¦æ´»è·ƒçš„æ¦‚å¿µï¼Œä»¥åŠ NLLï¼ˆhttps://rust-lang.github.io/rfcs/2094-nll.htmlï¼‰ã€‚\n\nå¯¹äºæ–‡ä¸­çš„å†…éƒ¨å¯å˜æ€§çš„ä¾‹å­ï¼Œæ£€æŸ¥å®Œå…¨æœ‰èµ–æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°æ¥ç¡®ä¿ã€‚çš„ç¡®ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼Œåœ¨ç¼–è¯‘æœŸå®Œå…¨æœ‰å¯èƒ½æŠŠåŸæœ¬åœ¨ä½œç”¨åŸŸç»“æŸæ—¶ drop çš„ v æå‰åˆ° v ä½¿ç”¨å®Œçš„åœ°æ–¹ï¼š\n\n```rust\n\nuse std::cell::RefCell;\n\nfn main() {\n    let data = RefCell::new(1);\n    \n    // è·å¾— RefCell å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨\n    let mut v = data.borrow_mut();\n    *v += 1;\n    // æå‰ drop å¯å˜å¼•ç”¨\n    drop(v);\n    \n    println!(&amp;quot;data: {:?}&amp;quot;, data.borrow());\n    \n    // éšå«çš„ drop\n    // åŸæœ¬ drop(v) å‘ç”Ÿåœ¨è¿™é‡Œ\n    drop(data);\n}\n```\n\nè¿™æ ·å¯ä»¥é¿å…é¢å¤–çš„ä½œç”¨åŸŸã€‚\n\nä½†æ˜¯ï¼Œå¦‚æœè¿™æ ·åšï¼Œç¼–è¯‘å™¨å°±æ˜¯åœ¨ä¸ºæŸä¸ªç‰¹å®šçš„æ•°æ®ç»“æ„ RefCellï¼Œè€Œé Rust çš„è¯­æ³•å•å…ƒ &amp;amp;mut æ¥åšä¼˜åŒ–äº†ã€‚ä»ç³»ç»Ÿè®¾è®¡çš„è§’åº¦ï¼Œé™¤éèƒ½æ‰¾åˆ°ä¸€ç§å¾ˆé€šç”¨çš„æ–¹æ³•ï¼ˆæ¯”å¦‚è®¾è®¡ä¸€ä¸ªæ–°çš„åƒ Send/Sync/Unpin è¿™æ ·çš„ auto trait å¯¹æ‰€æœ‰å®ç°äº†è¿™ä¸ª auto trait çš„æ•°æ®ç»“æ„è¿›è¡Œä¼˜åŒ–ï¼‰ï¼Œå¦åˆ™ï¼Œç¼–è¯‘å™¨éœ€è¦çŸ¥é“å“ªä¸ªæ•°æ®ç»“æ„åœ¨åšå“ªä¸ªæ“ä½œçš„æ—¶å€™éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚è¿™å°±ä¼šè®©ç¼–è¯‘å™¨æœ¬èº«çš„è®¾è®¡å˜å¾—å¤æ‚ã€‚\n\nä¸ªäººæ„è§ï¼Œä¸ä»£è¡¨ç¼–è¯‘å™¨å›¢é˜Ÿçš„æ€è·¯ :)\n\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1631242018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1069346,"avatar":"https://static001.geekbang.org/account/avatar/00/10/51/22/d12f7a72.jpg","nickname":"TheLudlows","note":"","ucode":"64895727505014","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":413104,"discussion_content":"è¿™é‡Œæ‰¾åˆ°ç­”æ¡ˆäº† ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636382373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315922,"user_name":"dotfiles","can_delete":false,"product_type":"c1","uid":1217723,"ip_address":"","ucode":"F915599EC2F6E5","user_header":"https://static001.geekbang.org/account/avatar/00/12/94/bb/1c8384a0.jpg","comment_is_top":false,"comment_ctime":1634046776,"is_pvip":false,"replies":[{"id":"115285","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635132489,"ip_address":"","comment_id":315922,"utype":1}],"discussion_count":1,"race_medal":0,"score":"53173654328","product_id":100085301,"comment_content":"1. rustç”±äºæ‰€æœ‰æƒä»¥åŠé»˜è®¤ä¸å¯å˜ç­‰é™åˆ¶,å¯¼è‡´æœ€å¸¸è§çš„æ•°æ®ç»“æ„---é“¾è¡¨çš„å®ç°å˜å¾—ç›¸å½“å¤æ‚,å¸¸è§çš„å®ç°ä½¿ç”¨äº†3å±‚ç»“æ„ä½“.<br>Option&lt;&gt;æä¾›ç©ºå’Œéç©º,ç›¸å…³: Some&#47;None<br>Rc&lt;T&gt;æä¾›å¼•ç”¨è®¡æ•°,ç›¸å…³: New&#47;clone; å¦‚æœä¸ºäº†é¿å…å¾ªç¯å¼•ç”¨,è¿˜è¦è€ƒè™‘downgrade&#47;upgrade; è¿™å—å’Œcppçš„shared_ptr&#47;weak_ptrç±»ä¼¼.<br>RefCell&lt;T&gt;æä¾›å†…éƒ¨å¯å˜æ€§,åŸºäºunsafeæœºåˆ¶,æä¾›è¿è¡Œæ—¶æ£€æŸ¥. ç›¸å…³: borrow&#47;borrow_mut<br><br>2. å†…éƒ¨å¯å˜æ€§<br>Rcçš„å¼•ç”¨è®¡æ•°å™¨å’ŒRefCellä¸­çš„æ•°æ®å¯å˜,éƒ½æ˜¯åŸºäºunsafeå®ç°çš„.<br>æˆ‘ä»¬ä»¥Rcå¼•ç”¨è®¡æ•°å™¨çš„æ›´æ–°ä¸ºä¾‹:<br>```<br>impl&lt;T&gt; Cell&lt;T&gt; {<br>    pub fn replace(&amp;self, val: T) -&gt; T {<br>        mem::replace(unsafe { &amp;mut *self.value.get() }, val)<br>    }<br>}<br>```<br>å¦‚ä¸Šå¯ä»¥çœ‹åˆ°,å³ä½¿replaceçš„å‚æ•°selfæ˜¯ä¸å¯å˜çš„,ä¹Ÿå¯ä»¥é€šè¿‡unsafeå»æ”¹å˜å…¶ä¸­çš„å€¼.ä¹Ÿå°±æ˜¯è¯´rusté€šè¿‡unsafeå…·æœ‰å®Œå…¨çš„c&#47;c++ç±»ä¼¼çš„èƒ½åŠ›.<br>åŒç†,å¯ä»¥çœ‹åˆ°Refcellè·å–å¯å˜å¼•ç”¨,ä¹Ÿæ˜¯é€šè¿‡unsafeå°†æŒ‡é’ˆç›´æ¥è½¬æˆå¯å˜å¼•ç”¨.å¯ä»¥æƒ³è±¡çš„æ˜¯,åœ¨RefCellä¸­,è¿˜éœ€è¦é€šè¿‡é¢å¤–çš„ä»£ç æ¥å¤„ç†å¯è¯»ä¸å¯å†™,å¯å†™ä¸å¯è¯»çš„ç±»ä¼¼è¯»å†™é”çš„é—®é¢˜.<br>```<br>impl&lt;T: ?Sized&gt; RefCell&lt;T&gt; {<br>    pub fn try_borrow_mut(&amp;self) -&gt; Result&lt;RefMut&lt;&#39;_, T&gt;, BorrowMutError&gt; {<br>                ...<br>                Ok(RefMut { value: unsafe { &amp;mut *self.value.get() }, borrow: b })<br>                ...<br>}<br>```<br>åœ¨rustçš„è®¾è®¡ä¸­,æ˜æ˜¾æ¨å´‡å°†é—®é¢˜å°½é‡åœ¨é™æ€ç¼–è¯‘æœŸè§£å†³.å®åœ¨æä¸å®šçš„,å°±æ˜¯é€šè¿‡unsafeå’Œé¢å¤–çš„å¤„ç†æ¨è¿Ÿåˆ°è¿è¡ŒæœŸè§£å†³.","like_count":12,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528203,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635132489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311447,"user_name":"noisyes","can_delete":false,"product_type":"c1","uid":2538540,"ip_address":"","ucode":"94EC310B284AD2","user_header":"https://static001.geekbang.org/account/avatar/00/26/bc/2c/963688bb.jpg","comment_is_top":false,"comment_ctime":1631239992,"is_pvip":false,"replies":[{"id":"112858","content":"è¿™å°±æ˜¯è¿è¡ŒæœŸæ£€æŸ¥å’Œç¼–è¯‘æœŸæ£€æŸ¥çš„åŒºåˆ«ã€‚data.borrow_mut() äº§ç”Ÿçš„ v ä¼šä¸€ç›´æ´»è·ƒåˆ°ä½œç”¨åŸŸç»“æŸï¼Œè€Œå¯¹äº &amp;mut ç¼–è¯‘å™¨å¯ä»¥æ£€æŸ¥å®ƒæ˜¯å¦æ´»è·ƒä»è€Œè®©æˆ‘ä»¬æ’°å†™ä»£ç æ—¶ä¸éœ€è¦é¢å¤–çš„ä½œç”¨åŸŸã€‚ä½ å¯ä»¥çœ‹çœ‹æˆ‘å’Œå¦ä¸€ä¸ªåŒå­¦å…³äºè¿™ä¸ªé—®é¢˜çš„è¯¦ç»†è®¨è®ºã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631242637,"ip_address":"","comment_id":311447,"utype":1}],"discussion_count":1,"race_medal":0,"score":"40285945656","product_id":100085301,"comment_content":"fn main() {<br>    &#47;*let data = RefCell::new(1);<br><br>    let mut v = data.borrow_mut();<br>    *v += 1;<br><br>    println!(&quot;data: {:?}&quot;, data.borrow());<br>    *&#47;<br>    let mut v = vec![1, 2, 3];<br>    let data1 = &amp;mut v[1];<br>    *data1 = 2;<br>    let data2 = &amp;v[1];<br>    println!(&quot;{}&quot;, data2);<br>}<br><br>è€å¸ˆè¿™æ®µä»£ç æ³¨é‡Šçš„éƒ¨åˆ†ï¼Œè¿è¡Œæ—¶ä¸èƒ½é€šè¿‡ï¼Œå¯å˜å€Ÿç”¨å’Œä¸å¯å˜å€Ÿç”¨å¹¶æ²¡æœ‰å†²çªå‘€ï¼ˆvå¹¶æ²¡åœ¨borrowä¹‹åä½¿ç”¨ï¼ŒåŒä¸€æ—¶åˆ»å¹¶æ²¡æœ‰åŒæ—¶æœ‰å¯å˜å€Ÿç”¨å’Œä¸å¯å˜å€Ÿç”¨ï¼‰ï¼Œæˆ‘è‡ªå·±å†™çš„è¿™éƒ¨åˆ†å°±æ˜¯å¯ä»¥ç¼–è¯‘è¿è¡Œçš„ã€‚","like_count":9,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526607,"discussion_content":"è¿™å°±æ˜¯è¿è¡ŒæœŸæ£€æŸ¥å’Œç¼–è¯‘æœŸæ£€æŸ¥çš„åŒºåˆ«ã€‚data.borrow_mut() äº§ç”Ÿçš„ v ä¼šä¸€ç›´æ´»è·ƒåˆ°ä½œç”¨åŸŸç»“æŸï¼Œè€Œå¯¹äº &amp;amp;mut ç¼–è¯‘å™¨å¯ä»¥æ£€æŸ¥å®ƒæ˜¯å¦æ´»è·ƒä»è€Œè®©æˆ‘ä»¬æ’°å†™ä»£ç æ—¶ä¸éœ€è¦é¢å¤–çš„ä½œç”¨åŸŸã€‚ä½ å¯ä»¥çœ‹çœ‹æˆ‘å’Œå¦ä¸€ä¸ªåŒå­¦å…³äºè¿™ä¸ªé—®é¢˜çš„è¯¦ç»†è®¨è®ºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631242637,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311680,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1631386297,"is_pvip":false,"replies":[{"id":"113008","content":"å¥½é—®é¢˜ã€‚strong ä¸º 0 æ—¶ï¼Œptr::drop_in_place å·²ç»æŠŠå¤§éƒ¨åˆ†å†…å­˜é‡Šæ”¾ã€‚ä½†æ­¤æ—¶å¯ä»¥è¿˜æœ‰å­¤æ‚¬çš„ weak referenceï¼Œå®ƒä»¬è¿˜æ˜¯å¯ç”¨çš„ï¼Œä½†æ— æ³• upgradeã€‚å¯ä»¥çœ‹è¿™ä¸ªä»£ç ï¼š<br><br>```rust<br>use std::rc::{Rc, Weak};<br><br>#[derive(Debug)]<br>struct Foo {<br>    bar: &amp;&#39;static str,<br>}<br><br>impl Drop for Foo {<br>    fn drop(&amp;mut self) {<br>        println!(&quot;dropped!&quot;);<br>    }<br>}<br><br>fn main() {<br>    let foo = Rc::new(Foo { bar: &quot;hello&quot; });<br>    let weak_foo = Rc::downgrade(&amp;foo);<br>    let other_weak_foo = Weak::clone(&amp;weak_foo);<br>    <br>    drop(weak_foo); &#47;&#47; ä¸ä¼š drop<br>    drop(foo);      &#47;&#47; æ‰“å° dropped!<br>    <br>    &#47;&#47; æ­¤æ—¶è¿˜æœ‰ weak ref å­˜åœ¨<br>    println!(&quot;other weak foo: {:?}&quot;, other_weak_foo);<br>    <br>    &#47;&#47; æ— æ³• upgrade<br>    assert!(other_weak_foo.upgrade().is_none());    <br>}<br>```<br><br>playground: https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ffd75a38877cfd78b6c66d0b13dc1d90","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631517441,"ip_address":"","comment_id":311680,"utype":1}],"discussion_count":3,"race_medal":0,"score":"27401190073","product_id":100085301,"comment_content":"ä¸ºå•¥è¦week == 0çš„æ—¶å€™æ‰deallocateæ‰€æœ‰å†…å­˜å‘¢? è¿™æ ·æ˜¯ä¸æ˜¯ä¸å¤ªé«˜æ•ˆ?<br><br>```<br>fn drop(&amp;mut self) {<br>    unsafe {<br>        self.inner().dec_strong();<br>        if self.inner().strong() == 0 {<br>            &#47;&#47; destroy the contained object<br>            ptr::drop_in_place(Self::get_mut_unchecked(self));<br><br>            &#47;&#47; remove the implicit &quot;strong weak&quot; pointer now that we&#39;ve<br>            &#47;&#47; destroyed the contents.<br>            self.inner().dec_weak();<br><br>            if self.inner().weak() == 0 {<br>                Global.deallocate(self.ptr.cast(), Layout::for_value(self.ptr.as_ref()));<br>            }<br>        }<br>    }<br>}<br>```","like_count":6,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526702,"discussion_content":"å¥½é—®é¢˜ã€‚strong ä¸º 0 æ—¶ï¼Œptr::drop_in_place å·²ç»æŠŠå¤§éƒ¨åˆ†å†…å­˜é‡Šæ”¾ã€‚ä½†æ­¤æ—¶å¯ä»¥è¿˜æœ‰å­¤æ‚¬çš„ weak referenceï¼Œå®ƒä»¬è¿˜æ˜¯å¯ç”¨çš„ï¼Œä½†æ— æ³• upgradeã€‚å¯ä»¥çœ‹è¿™ä¸ªä»£ç ï¼š\n\n```rust\nuse std::rc::{Rc, Weak};\n\n#[derive(Debug)]\nstruct Foo {\n    bar: &amp;amp;&amp;#39;static str,\n}\n\nimpl Drop for Foo {\n    fn drop(&amp;amp;mut self) {\n        println!(&amp;quot;dropped!&amp;quot;);\n    }\n}\n\nfn main() {\n    let foo = Rc::new(Foo { bar: &amp;quot;hello&amp;quot; });\n    let weak_foo = Rc::downgrade(&amp;amp;foo);\n    let other_weak_foo = Weak::clone(&amp;amp;weak_foo);\n    \n    drop(weak_foo); // ä¸ä¼š drop\n    drop(foo);      // æ‰“å° dropped!\n    \n    // æ­¤æ—¶è¿˜æœ‰ weak ref å­˜åœ¨\n    println!(&amp;quot;other weak foo: {:?}&amp;quot;, other_weak_foo);\n    \n    // æ— æ³• upgrade\n    assert!(other_weak_foo.upgrade().is_none());    \n}\n```\n\nplayground: https://play.rust-lang.org/?version=stable&amp;amp;mode=debug&amp;amp;edition=2018&amp;amp;gist=ffd75a38877cfd78b6c66d0b13dc1d90","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1631517441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1390032,"avatar":"https://static001.geekbang.org/account/avatar/00/15/35/d0/f2ac6d91.jpg","nickname":"é˜¿æˆ","note":"","ucode":"CEC3CD65FB9333","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":408789,"discussion_content":"è¿›ä¸€æ­¥è§£é‡Šä¸€ä¸‹ï¼š\ndrop_in_place é‚£ä¸€æ­¥åº”è¯¥æ˜¯è°ƒç”¨ T çš„ Drop::drop æ–¹æ³•ï¼Œå¦‚æœ T æ˜¯ Vecï¼Œé‚£å †ä¸Šçš„å†…å­˜å°±è¢«é‡Šæ”¾äº†ï¼Œå¯å¦‚æœ T æ˜¯ [usize; 10000]ï¼Œå®ƒæ²¡æœ‰å®ç° Drop traitï¼ˆæˆ‘çŒœå“ˆï¼‰ï¼Œåªèƒ½åœ¨ Global.deallocate è¿™ä¸€æ­¥æ‰èƒ½é‡Šæ”¾å†…å­˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635324782,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111835,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","nickname":"Marvichov","note":"","ucode":"7482099415C41C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397361,"discussion_content":"æ„Ÿè°¢è€å¸ˆ! çœ‹äº†ä¸‹æºç , å¦‚æœ `Rc<T>` ä¸­, Tçš„sizeå¾ˆå¤§, è€Œä¸”å€¼éƒ½åœ¨structå†…éƒ¨, æ²¡æœ‰è¢«é‡Šæ”¾, æ¯”å¦‚Tæ˜¯`[usize; 10_000]`; å¦‚æœTæ˜¯Vecç±»å‹, æ•°æ®å°±ä¼šè¢«æå‰é‡Šæ”¾, since data is stored indirectly in another location.\n\n```\npub unsafe fn get_mut_unchecked(this: &amp;mut Self) -> &amp;mut T {\n    // We are careful to *not* create a reference covering the &#34;count&#34; fields, as\n    // this would conflict with accesses to the reference counts (e.g. by `Weak`).\n    unsafe { &amp;mut (*this.ptr.as_ptr()).value }\n}\n\nfn drop(&amp;mut self) {\n    unsafe {\n        self.inner().dec_strong();\n        if self.inner().strong() == 0 {\n            // destroy the contained object\n            ptr::drop_in_place(Self::get_mut_unchecked(self));\n            // remove the implicit &#34;strong weak&#34; pointer now that we&#39;ve\n            // destroyed the contents.\n            self.inner().dec_weak();\n            if self.inner().weak() == 0 {\n                Global.deallocate(self.ptr.cast(), Layout::for_value(self.ptr.as_ref()));\n            }\n        }\n    }\n}\n```","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632596967,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315333,"user_name":"æ¸æçº¢èŒ¶","can_delete":false,"product_type":"c1","uid":2738941,"ip_address":"","ucode":"03D80953AF984E","user_header":"https://static001.geekbang.org/account/avatar/00/29/ca/fd/4e6dd31c.jpg","comment_is_top":false,"comment_ctime":1633840081,"is_pvip":false,"replies":[{"id":"115299","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635133450,"ip_address":"","comment_id":315333,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18813709265","product_id":100085301,"comment_content":"1. çº¿ç¨‹çš„è¿è¡Œæ—¶é—´å¯èƒ½ä¼šæ¯”å½“å‰å‡½æ•°è¿˜è¦é•¿ï¼Œè€Œé—­åŒ…ä¸­åˆå€Ÿç”¨äº†arrï¼Œä½¿ç”¨moveå°†å½“å‰å‡½æ•°çš„arræ‰€æœ‰æƒè½¬ç§»ç»™çº¿ç¨‹ã€‚<br>```<br>use std::thread;<br><br>fn main() {<br>    let arr = vec![1];<br><br>    let handler = thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    });<br>    handler.join().unwrap();<br>}<br>```<br>2. <br>```<br>use std::thread;<br>use std::sync::Arc;<br><br>fn main() {<br>    let five = Arc::new(&quot;hello Tyr&quot;);<br><br>    {<br>        let give_me_five = five.clone();<br>        let handler = thread::spawn(move || {<br>            println!(&quot;thread greeting: {:?}&quot;, give_me_five);<br>        });<br>        handler.join().unwrap();<br>    }<br>    println!(&quot;main greeting: {:?}&quot;, five);<br>}<br>```<br>3. Rcæºç ä¸­æœ‰è¿™ä¹ˆä¸€æ®µï¼Œ<br>```<br>#[doc(hidden)]<br>trait RcInnerPtr {<br>    fn weak_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;<br>    fn strong_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;<br><br>    #[inline]<br>    fn strong(&amp;self) -&gt; usize {<br>        self.strong_ref().get()<br>    }<br><br>    #[inline]<br>    fn inc_strong(&amp;self) {<br>        let strong = self.strong();<br><br>        &#47;&#47; We want to abort on overflow instead of dropping the value.<br>        &#47;&#47; The reference count will never be zero when this is called;<br>        &#47;&#47; nevertheless, we insert an abort here to hint LLVM at<br>        &#47;&#47; an otherwise missed optimization.<br>        if strong == 0 || strong == usize::MAX {<br>            abort();<br>        }<br>        self.strong_ref().set(strong + 1);<br>    }<br>    ...<br>}<br>```<br>å¢åŠ è®¡æ•°å™¨```self.inner().inc_strong();```è°ƒç”¨çš„```inc_strong```å‡½æ•°ä¿®æ”¹çš„æ˜¯```strong_ref()```ï¼Œå±äºCellç±»å‹ï¼ŒShareable mutable containersï¼Œå¯å…±äº«å¯ä¿®æ”¹çš„å®¹å™¨ã€‚","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527937,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635133450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311756,"user_name":"Kerry","can_delete":false,"product_type":"c1","uid":2061524,"ip_address":"","ucode":"92F809EC998FC6","user_header":"https://static001.geekbang.org/account/avatar/00/1f/74/d4/38d813f0.jpg","comment_is_top":false,"comment_ctime":1631446439,"is_pvip":false,"replies":[{"id":"112992","content":"1ã€2 æ­£ç¡®ï¼3 è·Ÿ unsafe å…³ç³»ä¸å¤§ï¼Œè·Ÿ strong æ˜¯ Cell&lt;usize&gt; å®ç°äº†å†…éƒ¨å¯å˜æ€§æœ‰å…³ã€‚ï¼ˆå½“ç„¶ï¼Œå†…éƒ¨å¯å˜æ€§åº•å±‚çš„å®ç°æ˜¯ unsafeï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631515163,"ip_address":"","comment_id":311756,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18811315623","product_id":100085301,"comment_content":"è¯¾åæ€è€ƒé¢˜ï¼š<br><br>1. ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼Œä¸»çº¿ç¨‹å¯èƒ½æ¯”æ´¾ç”Ÿçº¿ç¨‹æ›´æ—©ç»“æŸï¼Œå¯¼è‡´æ´¾ç”Ÿçº¿ç¨‹å¼•ç”¨äº†è¿‡æœŸçš„å€¼ã€‚<br><br>ä½ ä¹Ÿè®¸ä¼šæƒ³åˆ°åŠ ä¸Šjoinå¼ºåˆ¶æ´¾ç”Ÿçº¿ç¨‹å…ˆäºä¸»çº¿ç¨‹ç»“æŸï¼Œä»¥æ­¤è§£å†³ç¼–è¯‘é—®é¢˜ã€‚ç„¶è€Œè¿™æ˜¯è¡Œä¸é€šçš„ã€‚è¿™é‡Œçš„é—®é¢˜æ˜¯è¯­æ³•å±‚é¢çš„ï¼Œè€Œä¸æ˜¯è¯­ä¹‰å±‚é¢çš„ã€‚<br><br>è§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼šä¸€æ˜¯moveï¼ŒäºŒæ˜¯ç”¨ARCã€‚æ–¹æ³•ä¸€çš„ä»£ç å¦‚ä¸‹ï¼š<br><br>fn main() {<br>    let arr = vec![1];<br><br>    std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    }).join().unwrap();<br>}<br><br>æ–¹æ³•äºŒå‚è€ƒæ€è€ƒé¢˜2å³å¯ã€‚<br><br>2. å¦‚ä¸‹æ‰€ç¤ºï¼Œç”¨ARCåŒ…ä¸€ä¸‹è¦å…±äº«çš„èµ„æºï¼š<br><br>use std::sync::{Arc, RwLock};<br>use std::rc::Rc;<br><br>fn main() {<br>    let s = Arc::new(RwLock::new(&quot;Hello&quot;));<br><br>    let r = s.clone();<br>    std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, r.as_ref().read().unwrap());<br>    }).join().unwrap();<br><br>    println!(&quot;{:?}&quot;, s.as_ref().read().unwrap());<br>}<br><br>3. æ˜¯æ—¶å€™æ­¥å…¥unsafeçš„ä¸–ç•Œäº†~ç¼–è¯‘å™¨ç»ˆç©¶åªæ˜¯å¸®æˆ‘ä»¬å¹²æ´»ï¼Œè§„åˆ™å†ä¸¥æ ¼ï¼Œé‚£éƒ½æ˜¯æ­»çš„ã€‚ä¸ºäº†æä¾›ä¸€å®šçµæ´»æ€§ï¼Œä¼šåƒRefCellè¿™æ ·æä¾›ä¸€äº›æœºåˆ¶ç»™æˆ‘ä»¬åšä¸€äº›ä¸å®‰å…¨çš„æ“ä½œã€‚é€šè¿‡é˜…è¯»self.inner().inc_strong()çš„æºç ï¼Œå¯ä»¥çŸ¥é“åº•å±‚æ˜¯é€šè¿‡unsafeå®ç°ä¸å¯å˜è½¬å¯å˜å¼•ç”¨çš„ï¼š<br><br>unsafe { &amp;mut *self.value.get() }<br><br><br>","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526730,"discussion_content":"1ã€2 æ­£ç¡®ï¼3 è·Ÿ unsafe å…³ç³»ä¸å¤§ï¼Œè·Ÿ strong æ˜¯ Cell&amp;lt;usize&amp;gt; å®ç°äº†å†…éƒ¨å¯å˜æ€§æœ‰å…³ã€‚ï¼ˆå½“ç„¶ï¼Œå†…éƒ¨å¯å˜æ€§åº•å±‚çš„å®ç°æ˜¯ unsafeï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631515163,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2061524,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/74/d4/38d813f0.jpg","nickname":"Kerry","note":"","ucode":"92F809EC998FC6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393644,"discussion_content":"è¿™æ ·çœ‹æ¥Rustçš„å†…éƒ¨å¯è§æ€§ï¼Œè·ŸC++çš„çš„â€œconstç»“æ„ä½“å¯ä»¥æœ‰mutableçš„æˆå‘˜â€æ˜¯ç±»ä¼¼çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631531679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311453,"user_name":"å¤æ´›å…‹Moriaty","can_delete":false,"product_type":"c1","uid":2754785,"ip_address":"","ucode":"49BA020F04AB16","user_header":"https://static001.geekbang.org/account/avatar/00/2a/08/e1/b4748943.jpg","comment_is_top":false,"comment_ctime":1631241152,"is_pvip":false,"replies":[{"id":"112875","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631284174,"ip_address":"","comment_id":311453,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18811110336","product_id":100085301,"comment_content":"ç»ˆäºç†è§£äº†Rcçš„æœ¬è´¨äº†ï¼Œä»¥å‰åªæ˜¯çŸ¥é“å®ç°äºŒå‰æ ‘è¿™ç§æ•°æ®ç»“æ„å¿…é¡»ç”¨Rcï¼Œå› ä¸ºä»–å…è®¸æœ‰å¤šä¸ªæ‰€æœ‰è€…ã€‚ä½†æ˜¯ä¸ç†è§£æˆ–è€…è¯´ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦æœ‰å†…éƒ¨å¯å˜æ€§å’Œè¿è¡Œæ—¶æ£€æŸ¥è¿™ä¸ªä¸œè¥¿ï¼Œä»Šå¤©çœ‹äº†Box::leak() æœºåˆ¶çš„è§£é‡Šç»ˆäºæ˜ç™½äº†ã€‚","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526610,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631284174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311663,"user_name":"Arthur","can_delete":false,"product_type":"c1","uid":1784009,"ip_address":"","ucode":"1C064405490769","user_header":"https://static001.geekbang.org/account/avatar/00/1b/38/c9/63ea8fe6.jpg","comment_is_top":false,"comment_ctime":1631371995,"is_pvip":true,"replies":[{"id":"112995","content":"åœ¨ä½ ç”¨èŠ±æ‹¬å·æ‹¬èµ· v çš„é‚£å¥ï¼Œv çš„æ‰€æœ‰æƒè¢«è½¬ç§»ç»™äº† {} ä½œç”¨åŸŸå†…éƒ¨ï¼Œå¹¶ä¸”ç”±äºæ²¡æœ‰äººä½¿ç”¨è¿™ä¸ªèŠ±æ‹¬å·çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ v è¢« drop äº†ã€‚ä¹‹åå†ç”¨ v å°±ä¼šæŠ¥é”™ï¼š<br>```rust<br>fn main() {<br>    let mut v = vec![1, 2, 3];<br>    {<br>        v            &#47;&#47; ç¼–è¯‘ä¸é€šè¿‡<br>    };<br>    v.push(4);<br>}<br>```<br><br>è€Œä½¿ç”¨ v.push()ï¼Œè¿™é‡Œä½¿ç”¨äº† v çš„å¯å˜å¼•ç”¨ï¼Œæ²¡æœ‰é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631515596,"ip_address":"","comment_id":311663,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14516273883","product_id":100085301,"comment_content":"è€å¸ˆå¥½ï¼Œå…³äºä½¿ç”¨èŠ±æ‹¬å·æå‰ç»“æŸç”Ÿå‘½å‘¨æœŸè¿™ç‚¹æœ‰ä¸€ç‚¹ä¸æ˜ç™½<br>```rust<br>fn main() {<br>    let mut v = vec![1, 2, 3];<br>    {<br>        v            &#47;&#47; ç¼–è¯‘ä¸é€šè¿‡<br>        v.push(3); &#47;&#47;ç¼–è¯‘é€šè¿‡<br>    };<br>    v.push(4);<br>}<br>```<br>èŠ±æ‹¬å·ä¸­çš„ä¸¤ç§å†™æ³•ï¼Œä¸€ç§ä¸é€šè¿‡ï¼ŒæŠ¥é”™error[E0382]: borrow of moved value: `v`ï¼›ä¸€ç§åˆå¯ä»¥é€šè¿‡ï¼Œæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä½¿ç”¨ä¸€ä¸ªèŠ±æ‹¬å·å¢åŠ äº†ä¸€ä¸ªä½œç”¨åŸŸä»¥åï¼Œå¯¹äºä½œç”¨åŸŸå†…ä½¿ç”¨çš„å¤–éƒ¨å˜é‡çš„æ‰€æœ‰æƒåˆ°åº•äº§ç”Ÿäº†æ€æ ·çš„å½±å“å‘¢ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526695,"discussion_content":"åœ¨ä½ ç”¨èŠ±æ‹¬å·æ‹¬èµ· v çš„é‚£å¥ï¼Œv çš„æ‰€æœ‰æƒè¢«è½¬ç§»ç»™äº† {} ä½œç”¨åŸŸå†…éƒ¨ï¼Œå¹¶ä¸”ç”±äºæ²¡æœ‰äººä½¿ç”¨è¿™ä¸ªèŠ±æ‹¬å·çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ v è¢« drop äº†ã€‚ä¹‹åå†ç”¨ v å°±ä¼šæŠ¥é”™ï¼š\n```rust\nfn main() {\n    let mut v = vec![1, 2, 3];\n    {\n        v            // ç¼–è¯‘ä¸é€šè¿‡\n    };\n    v.push(4);\n}\n```\n\nè€Œä½¿ç”¨ v.push()ï¼Œè¿™é‡Œä½¿ç”¨äº† v çš„å¯å˜å¼•ç”¨ï¼Œæ²¡æœ‰é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631515596,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311452,"user_name":"noisyes","can_delete":false,"product_type":"c1","uid":2538540,"ip_address":"","ucode":"94EC310B284AD2","user_header":"https://static001.geekbang.org/account/avatar/00/26/bc/2c/963688bb.jpg","comment_is_top":false,"comment_ctime":1631241085,"is_pvip":false,"replies":[{"id":"112874","content":"æ­£ç¡®ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631284143,"ip_address":"","comment_id":311452,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10221175677","product_id":100085301,"comment_content":"æ€è€ƒé¢˜ï¼š<br>1. fn main() {<br>    let arr = vec![1];<br>    let handler = std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    });<br>    handler.join().unwrap();<br>}<br><br>2. fn main() {<br>    let ss = Arc::new(String::from(&quot;hello world&quot;));<br>    let ss1 = ss.clone();<br>    let handler = std::thread::spawn(move || {<br>        println!(&quot;{}&quot;, ss1);<br>    });<br>    println!(&quot;{}&quot;, ss);<br>    handler.join().unwrap();<br>}<br><br>3. è¿˜æ²¡çœ‹æºç  åº”è¯¥å°±æ˜¯å†…éƒ¨å¯å˜æ€§å§","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526609,"discussion_content":"æ­£ç¡®ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631284143,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311440,"user_name":"è‘¡è„","can_delete":false,"product_type":"c1","uid":1018673,"ip_address":"","ucode":"6E8597D1B09807","user_header":"http://thirdwx.qlogo.cn/mmopen/ajNVdqHZLLDoDeeNST87MZEdfT8n7yEWp06KsFCTs2ssFh2tbHu413nibrRObOia1Zn9pqiaHgIicVkSHRZM3LHOEA/132","comment_is_top":false,"comment_ctime":1631238429,"is_pvip":false,"replies":[{"id":"112856","content":"éå¸¸æ­£ç¡®ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631242079,"ip_address":"","comment_id":311440,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10221173021","product_id":100085301,"comment_content":"3. Rcç±»åˆ›å»º<br>Box::leak(box RcBox { strong: Cell::new(1), weak: Cell::new(1), value })<br>self.inner().inc_strong()<br>è·å¾—äº†Rcé‡Œ strong, ä¹Ÿå°±æ˜¯Cellå¯¹è±¡ï¼ŒCellæ˜¯å†…éƒ¨å¯å˜çš„ï¼Œä½¿ç”¨setæ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚<br>fn inc_strong(&amp;self) {<br>        let strong = self.strong();<br>        self.strong_ref().set(strong + 1);<br>    }","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526604,"discussion_content":"éå¸¸æ­£ç¡®ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631242079,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330566,"user_name":"chyuwei","can_delete":false,"product_type":"c1","uid":1361377,"ip_address":"","ucode":"19687765E6DE5D","user_header":"","comment_is_top":false,"comment_ctime":1642045168,"is_pvip":false,"replies":[{"id":"120686","content":"å¯¹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1642292650,"ip_address":"","comment_id":330566,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5937012464","product_id":100085301,"comment_content":"ä¸ªäººæ„Ÿè§‰å°±æ˜¯ æ‰€æœ‰æƒå¯¼è‡´ä¸èƒ½å‡ºç°å¤šä¸ªå¯å˜å¼•ç”¨ï¼Œ <br>å€Ÿé‰´äº†å¤šçº¿ç¨‹é‡Œé¢çš„mutexï¼Œæ‰€ä»¥æœ‰äº†è¿™ä¸ªæ‰€è°“çš„å†…éƒ¨å¯å˜æ€§ã€‚<br>å¯¹äºmutexï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ä¿è¯ç‹¬å æ€§ï¼Œ<br>å¯¹äºrefcellåº”è¯¥å°±æ˜¯åº“ä»£ç å»ä¿è¯ã€‚<br><br>è‡³äºæœ‰äº›åŒå­¦è¯´æ’•å£å­è¿™ä¸ªäº‹ï¼Œ safe rustå¯ä»¥å†™ç»å¤§å¤šæ•°ç¨‹åºäº†ã€‚<br>å½“ä½ ä¸å¾—ä¸å»æ’•å£å­ï¼Œå†™unsafeæ—¶ï¼Œå…¶å®å’Œc++å°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546295,"discussion_content":"å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642292650,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323617,"user_name":"dch666","can_delete":false,"product_type":"c1","uid":1318336,"ip_address":"","ucode":"21E3890CD66485","user_header":"https://static001.geekbang.org/account/avatar/00/14/1d/c0/978fc470.jpg","comment_is_top":false,"comment_ctime":1638024716,"is_pvip":true,"replies":[{"id":"118882","content":"æ²¡åŒºåˆ«","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639850054,"ip_address":"","comment_id":323617,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5932992012","product_id":100085301,"comment_content":"åœ¨ä»£ç 1ä¸­ï¼Œæˆ‘æŠŠ self.downstream.as_ref().map(|v| v.clone()) æ”¹æˆäº† self.downstream.clone() çœ‹åˆ° print è¾“å‡ºç»“æœæ˜¯ä¸€æ ·çš„ï¼Œæƒ³é—®ä¸‹è¿™ä¸¤ç§å†™æ³•æœ‰åŒºåˆ«å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539843,"discussion_content":"æ²¡åŒºåˆ«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639850054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320568,"user_name":"TheLudlows","can_delete":false,"product_type":"c1","uid":1069346,"ip_address":"","ucode":"64895727505014","user_header":"https://static001.geekbang.org/account/avatar/00/10/51/22/d12f7a72.jpg","comment_is_top":false,"comment_ctime":1636382232,"is_pvip":false,"replies":[{"id":"116304","content":"ç¬¬ä¸€æ®µä»£ç ç¼–è¯‘å™¨å¯ä»¥æ£€æŸ¥å‡º p åœ¨åšå®Œ *p += 2 ä¹‹åå°±ä¸æ´»è·ƒäº†ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ´»è·ƒçš„å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨å¹¶å­˜çš„æƒ…å†µã€‚è¿™æ˜¯ä¸€ç§ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼›ç¬¬äºŒç§æ— æ³•ä¼˜åŒ–ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636478640,"ip_address":"","comment_id":320568,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5931349528","product_id":100085301,"comment_content":"é™ˆå¤©è€å¸ˆéº»çƒ¦é—®ä¸‹ä¸ºä»€ä¹ˆä¸‹é¢è¿™æ®µå¯ä»¥ç¼–è¯‘<br>```rust<br>fn main() {<br>    let mut data = 1;<br>    let p = &amp;mut data;<br>    *p += 2;<br>    println!(&quot;data: {:?}&quot;, &amp;data);<br>}<br>```<br>è€Œä¾‹å­ä¸­çš„è¿™æ®µä¸èƒ½ç¼–è¯‘å‘¢<br>use std::cell::RefCell;<br><br>fn main() {<br>    let data = RefCell::new(1);<br>    <br>    let mut v = data.borrow_mut();<br>    *v += 1;<br>    <br>    println!(&quot;data: {:?}&quot;, data.borrow());<br>}","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530052,"discussion_content":"ç¬¬ä¸€æ®µä»£ç ç¼–è¯‘å™¨å¯ä»¥æ£€æŸ¥å‡º p åœ¨åšå®Œ *p += 2 ä¹‹åå°±ä¸æ´»è·ƒäº†ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ´»è·ƒçš„å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨å¹¶å­˜çš„æƒ…å†µã€‚è¿™æ˜¯ä¸€ç§ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼›ç¬¬äºŒç§æ— æ³•ä¼˜åŒ–ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636478640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":312447,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1631805487,"is_pvip":false,"replies":[{"id":"113221","content":"downstream  æ˜¯ä¸€ä¸ª Option&lt;Node&gt;ï¼Œas_ref() åå˜æˆ Option&lt;&amp;Nonde&gt;ï¼ŒOption æœ‰ map æ–¹æ³•ï¼Œå¯ä»¥å¯¹é‡Œé¢çš„ Some(v) çš„ v è¿›è¡Œ map å¤„ç†ã€‚å¯ä»¥çœ‹ï¼šhttps:&#47;&#47;doc.rust-lang.org&#47;std&#47;option&#47;enum.Option.html#method.map","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631844703,"ip_address":"","comment_id":312447,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5926772783","product_id":100085301,"comment_content":"ä»£ç 1å’Œ4ä¸­ç•™æ„ä¸€ä¸‹struct å’Œimpléƒ½æ˜¯Nodeï¼Œè¿™æ ·çš„å†™æ³•çœ‹èµ·æ¥æ¯”è¾ƒç®€æ´ã€‚<br>å¦å¤–ä»£ç ä¸­æœ‰ä¸€å¥<br>self.downstream.as_ref().map(|v| v.clone())<br>è¿™é‡Œçš„mapè¯­æ³•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæ²¡å¤ªçœ‹æ‡‚ï¼Œå¤šè°¢äº†","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526969,"discussion_content":"downstream  æ˜¯ä¸€ä¸ª Option&amp;lt;Node&amp;gt;ï¼Œas_ref() åå˜æˆ Option&amp;lt;&amp;amp;Nonde&amp;gt;ï¼ŒOption æœ‰ map æ–¹æ³•ï¼Œå¯ä»¥å¯¹é‡Œé¢çš„ Some(v) çš„ v è¿›è¡Œ map å¤„ç†ã€‚å¯ä»¥çœ‹ï¼šhttps://doc.rust-lang.org/std/option/enum.Option.html#method.map","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631844703,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311407,"user_name":"Geek_364411","can_delete":false,"product_type":"c1","uid":1441429,"ip_address":"","ucode":"64BB3CF51166B3","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/AqCAY0eAVuCLIiafWWUv871EsRhEnhYT1cy1g7CGBtYJgLxiajw68l2fff4Lu7FMmjKXuchlhcCKOqd2ghibcJgHA/132","comment_is_top":false,"comment_ctime":1631226641,"is_pvip":false,"replies":[{"id":"112850","content":"1&#47;2 æ­£ç¡®ï¼<br><br>3. å…¶å®æ˜¯æƒ³å¸®åŠ©æˆ‘ä»¬å›é¡¾å†…éƒ¨å¯å˜æ€§ã€‚å½“ä¸€ä¸ªä¸å¯å˜çš„å¼•ç”¨å¯ä»¥ä¿®æ”¹å†…éƒ¨çŠ¶æ€æ—¶ï¼Œå®ƒä¸€å®šä½¿ç”¨äº†æŸç§å†…éƒ¨å¯å˜æ€§çš„æ–¹æ³•ã€‚ä½ çš„ä»£ç å¹¶æ²¡æœ‰è§£å†³ clone() é¢ä¸´çš„é—®é¢˜ï¼Œå› ä¸ºä»æ¥å£çœ‹ï¼Œä½ è¦ä¿®æ”¹çš„ dst æ˜¯ä¸€ä¸ª &amp;mut Tã€‚clone() ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ &amp;selfï¼Œä¸æ˜¯ &amp;mut selfã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631237637,"ip_address":"","comment_id":311407,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5926193937","product_id":100085301,"comment_content":"1.<br>fn main() {<br>  let arr = vec![1];<br><br>  std::thread::spawn(move || {<br>    println!(&quot;{:?}&quot;, arr);<br>  });<br>}<br>2.<br>fn main() {<br>    let name = &quot;Hello&quot;;<br>    let m_name = Arc::new(name);<br>    let clone_name = m_name.clone();<br>    std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, clone_name);<br>    });<br>    println!(&quot;{:?}&quot;, m_name);<br>}<br>3.ä½¿ç”¨äº†è£¸æŒ‡é’ˆæ¥ä¿®æ”¹<br>pub fn replace&lt;T&gt;(dest: &amp;mut T, src: T) -&gt; T {<br>    unsafe {<br>        let result = ptr::read(dest);<br>        ptr::write(dest, src);<br>        result<br>    }<br>}","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526589,"discussion_content":"1/2 æ­£ç¡®ï¼\n\n3. å…¶å®æ˜¯æƒ³å¸®åŠ©æˆ‘ä»¬å›é¡¾å†…éƒ¨å¯å˜æ€§ã€‚å½“ä¸€ä¸ªä¸å¯å˜çš„å¼•ç”¨å¯ä»¥ä¿®æ”¹å†…éƒ¨çŠ¶æ€æ—¶ï¼Œå®ƒä¸€å®šä½¿ç”¨äº†æŸç§å†…éƒ¨å¯å˜æ€§çš„æ–¹æ³•ã€‚ä½ çš„ä»£ç å¹¶æ²¡æœ‰è§£å†³ clone() é¢ä¸´çš„é—®é¢˜ï¼Œå› ä¸ºä»æ¥å£çœ‹ï¼Œä½ è¦ä¿®æ”¹çš„ dst æ˜¯ä¸€ä¸ª &amp;amp;mut Tã€‚clone() ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ &amp;amp;selfï¼Œä¸æ˜¯ &amp;amp;mut selfã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631237637,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359875,"user_name":"Neo","can_delete":false,"product_type":"c1","uid":1070189,"ip_address":"æµ™æ±Ÿ","ucode":"A2B2E2F8780557","user_header":"https://static001.geekbang.org/account/avatar/00/10/54/6d/c947ef55.jpg","comment_is_top":false,"comment_ctime":1666003585,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1666003585","product_id":100085301,"comment_content":"é—®é¢˜1: æ–°çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ¯”ä¸»çº¿ç¨‹é•¿ï¼Œæ–°çº¿ç¨‹å€Ÿç”¨äº†arrä¼šè¶…å‡ºä¸»çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ<br>    let arr =vec![1];<br><br>    std::thread::spawn(move || {<br>        println!(&quot;arr1: {:?}&quot;, arr);<br>    }).join().unwrap();<br><br>é—®é¢˜2:<br>    let arr =Arc::new(vec![1]);<br>    let arr1 = arr.clone();<br>    std::thread::spawn(move || {<br>        println!(&quot;arr1: {:?}&quot;, arr1);<br>    }).join().unwrap();<br><br>    println!(&quot;arr: {:?}&quot;, arr);","like_count":0},{"had_liked":false,"id":353577,"user_name":"Shanks-ç‹å†²","can_delete":false,"product_type":"c1","uid":1042983,"ip_address":"å¹¿ä¸œ","ucode":"C4B90A17850E20","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ea/27/a3737d61.jpg","comment_is_top":false,"comment_ctime":1659579352,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659579352","product_id":100085301,"comment_content":"æ€è€ƒé¢˜<br><br>1. https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7ae64f30bcc966e0bdd6d4e57bb4c0e4<br>```<br>fn main() {<br>    let arr = vec![1];<br><br>    std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    });<br><br>}<br>```<br>2. https:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=99716788245b49b5c94d975c94b39380<br>```<br>use std::{cell::RefCell, sync::Arc};<br><br>fn main() {<br>    let hello = &quot;hello&quot;.to_owned();<br>    let arc = Arc::new(hello);<br><br>    {<br>        let arc_copy = arc.clone();<br>        std::thread::spawn(move || {<br>            println!(&quot;In thread, arc copy value: {:?}&quot;, arc_copy);<br>        });<br>    }<br><br>    println!(&quot;arc value: {}&quot;, arc);<br>}<br>```<br>3. å¼ºå¼•ç”¨è®¡æ•°çš„å€¼ï¼Œå­˜å‚¨åœ¨ RcBox ç»“æ„ä½“ä¸­çš„ strong:Cell&lt;usize&gt; å­—æ®µä¸­ï¼Œè€Œ Cell&lt;usize&gt; å¯åšç®€å•çš„ getå’Œsetæ–¹æ³•ï¼Œå¼•ç”¨è®¡æ•° +1 æ“ä½œåœ¨ RcInnerPtr trait çš„ inc_strong()é»˜è®¤å®ç°ä¸­å®Œæˆã€‚","like_count":0},{"had_liked":false,"id":348729,"user_name":"NorthWind","can_delete":false,"product_type":"c1","uid":1037669,"ip_address":"","ucode":"459ADF3B0945E7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d5/65/1c9f1530.jpg","comment_is_top":false,"comment_ctime":1655353940,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655353940","product_id":100085301,"comment_content":"java é‡Œä¸€å †çš„å¼ºå¼±å¼•ç”¨ä¹Ÿæ˜¯å®ç°ç±»ä¼¼çš„è¿™ä¸ªåŠŸèƒ½çš„ä¹ˆ","like_count":0},{"had_liked":false,"id":346250,"user_name":"ONLY","can_delete":false,"product_type":"c1","uid":1049147,"ip_address":"","ucode":"180990E586D060","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/3b/b4a47f63.jpg","comment_is_top":false,"comment_ctime":1652945924,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652945924","product_id":100085301,"comment_content":"æ„Ÿè§‰rustçš„å€Ÿç”¨æ£€æŸ¥ä¸æ™ºèƒ½ï¼Œè™½ç„¶åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸï¼Œä½†æ˜¯å¯å˜å€Ÿç”¨å·²ç»å®Œæˆäº†ä¸ä¼šå¯¹æ•°æ®æœ‰å‰¯ä½œç”¨äº†ï¼Œåé¢å†ä½¿ç”¨ä¸å¯å˜å€Ÿç”¨åº”è¯¥æ˜¯å…è®¸çš„ï¼Œä¸ç„¶è¿™ä¸ªä¼šæœ‰å¾ˆå¤šæ— æ„ä¹‰çš„ä»£ç å°±æ˜¯ä¸ºäº†è§„é¿ç¼–è¯‘å™¨çš„è¿™ä¸ªå€Ÿç”¨æ£€æŸ¥","like_count":0},{"had_liked":false,"id":342854,"user_name":"â—‘â–‚â—","can_delete":false,"product_type":"c1","uid":1338732,"ip_address":"","ucode":"42E6C1191FF63B","user_header":"https://static001.geekbang.org/account/avatar/00/14/6d/6c/81fa79a2.jpg","comment_is_top":false,"comment_ctime":1650508473,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650508473","product_id":100085301,"comment_content":"è€å¸ˆæœ‰ä¸€ä¸ªåˆçº§é—®é¢˜è¯·æ•™ä¸‹ï¼šself.downstream.as_ref().map(|v| v.clone())  ä¸­çš„ |v| æ˜¯ä»£è¡¨ä»€ä¹ˆè¯­æ³•ï¼›æˆ‘æ‰¾äº†å¾ˆå¤šrustç›¸å…³çš„è¯­æ³•çŸ¥è¯†éƒ½æ²¡æœ‰æ‰¾åˆ°ã€‚æˆ–è€…è€å¸ˆè¿™ä¸€å—æœ‰ä»€ä¹ˆä¹¦ç±å¯ä»¥æ¨èçš„ ","like_count":0},{"had_liked":false,"id":342237,"user_name":"ä¹ æƒ¯","can_delete":false,"product_type":"c1","uid":2183344,"ip_address":"","ucode":"2E61B2C235B6FE","user_header":"https://static001.geekbang.org/account/avatar/00/21/50/b0/9e80e838.jpg","comment_is_top":false,"comment_ctime":1650121752,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650121752","product_id":100085301,"comment_content":"è¿™ç§æ˜¯åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸæ—¢æœ‰å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨å—<br>    let mut s = String::from(&quot;hello&quot;);<br>    let s1 = &amp;mut s;<br>    s1.push_str(&quot; world&quot;);<br>    println!(&quot;{}&quot;, s);<br>    let s2 = &amp;s;<br>    println!(&quot;{}&quot;, s2);<br><br>çœ‹äº†RefCellçš„borrow()çš„å’Œborrow_mut()çš„ä»£ç ï¼Œåœ¨åŒä¸€ä½œç”¨åŸŸåˆ†åˆ«æ‰§è¡Œborrow_mut()å’Œborrow()æ—¶ï¼Œåœ¨å†…éƒ¨è°ƒç”¨æ—¶éƒ½ä¼šæ‰§è¡Œä¸€ä¸ªtry_çš„æ–¹æ³•ï¼Œå½“é¦–æ¬¡æ‰§è¡Œborrow_mut()æ—¶,ä¼šå°†å¸¸é‡UnUsedå‡1èµ‹å€¼ç»™RefCellä¸­çš„å±æ€§borrowï¼Œå³ä¸º-1ï¼Œç„¶åå†åŒä¸€ä½œç”¨åŸŸå†è°ƒç”¨RefCellçš„borrow()æ—¶ä¼šé€šè¿‡is_reading()åˆ¤æ–­è¿™ä¸ªRefCellçš„borrowå’Œå¸¸é‡UnUsedçš„å¤§å°ï¼ŒæŒ‰ä»¥ä¸Šæµç¨‹èµ°æ—¶ä¼šè¿”å›é”™è¯¯ï¼Œå¯¼è‡´è¿è¡Œæ—¶panicï¼Œä¹‹æ‰€ä»¥å†ä¸åŒä½œç”¨åŸŸè¿›è¡Œè¯»å†™ï¼Œæ˜¯å› ä¸ºRefMutä¸­çš„borrowå±æ€§çš„BorrowRefMutç±»å‹å®ç°äº†Drop,åœ¨å…¶å®ç°çš„dropå†…éƒ¨ä¸­å°†borrowå±æ€§åˆç½®ä¸ºäº†åˆå§‹å€¼ï¼Œæ‰€ä»¥å†…éƒ¨ä½œç”¨åŸŸç»“æŸåï¼Œè‡ªåŠ¨è°ƒç”¨drop(),åœ¨å¤–éƒ¨çš„ä½œç”¨åŸŸå°±å¯ä»¥æ­£å¸¸è®¿é—®RefCellçš„borrow()æ–¹æ³•äº†ï¼ŒRefCellé€šè¿‡ä»£ç æ§åˆ¶å®ç°äº†åœ¨åŒä¸€ä½œç”¨åŸŸåªèƒ½å­˜åœ¨ä¸€ä¸ªborrow_mut()æ–¹æ³•æˆ–è€…å¤šä¸ªborrow()æ–¹æ³•ï¼Œä½†æ˜¯åƒä¸Šé¢çš„ä»£ç Stringåœ¨åŒä¸€ä½œç”¨åŸŸå¯ä»¥å­˜åœ¨ä¸€ä¸ªå¯å˜å¼•ç”¨ä¹Ÿå¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªä¸å¯å˜å¼•ç”¨ï¼Œè¿™æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¸ä¸€æ ·å•Šï¼Œå°±æ„Ÿè§‰æœ‰ç‚¹çŸ›ç›¾ï¼Œè¿™é‡Œè€å¸ˆè¯´æ˜¯æ ¹æ®æ‰€æœ‰æƒè§„åˆ™ï¼ŒåŒä¸€ä½œç”¨åŸŸä¸èƒ½åŒæ—¶å­˜åœ¨æ´»è·ƒçš„å¯å˜å’Œä¸å¯å˜å¼•ç”¨å•Šï¼Œä½†æ˜¯Stringåˆå¯ä»¥ï¼Œä¸€ä¸ªå¤´ä¸¤ä¸ªå¤§å•Šï¼Œæ–°æ‰‹åˆ†æï¼Œå¸Œæœ›è€å¸ˆæŒ‡æ­£","like_count":0},{"had_liked":false,"id":340581,"user_name":"ç™»é«˜","can_delete":false,"product_type":"c1","uid":1068600,"ip_address":"","ucode":"CD40046238BA18","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/38/3faa8377.jpg","comment_is_top":false,"comment_ctime":1648951579,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1648951579","product_id":100085301,"comment_content":"å°†rusté‡åˆ°çš„é—®é¢˜åˆ†æˆç¼–è¯‘æœŸå’Œè¿è¡ŒæœŸï¼Œç¼–è¯‘å™¨å®Œå…¨éµå¾ªä¸€ä¸ªå€¼æœ‰ä¸”åªæœ‰ä¸€ä¸ªowerçš„åŸåˆ™ï¼Œä½†æ˜¯åœ¨è¿è¡ŒæœŸæœ‰éœ€è¦çªç ´è¿™ä¸ªé™åˆ¶çš„æ—¶å€™ï¼Œäºæ˜¯æä¾›äº†Rcæ™ºèƒ½æ™ºèƒ½æŒ‡é’ˆï¼ŒRcæ™ºèƒ½æŒ‡é’ˆæ˜¯åªè¯»çš„å¼•ç”¨ï¼Œä¸ºäº†å®ç°å¯ä»¥ä¿®æ”¹çš„åŠŸèƒ½å¼•å…¥äº†RefCellã€‚<br><br>è¿™ä¸€èŠ‚çœ‹ä¸‹æ¥ï¼Œruståœ¨ç¼–è¯‘æœŸéµå¾ªè§„åˆ™ï¼Œåœ¨è¿è¡Œæ—¶ç‰ºç‰²ä¸€å®šçš„æ€§èƒ½æ¥æ‰“ç ´è§„åˆ™ï¼Œè¿è¡Œæ—¶è™½ç„¶æ‰“ç ´äº†è§„åˆ™ï¼Œä½†æœ‰ä¸€å¥—è¿è¡Œæ—¶çš„è§„åˆ™æ›¿ä»£ç¼–è¯‘è§„åˆ™æ¥ä¿è¯å®‰å…¨ã€‚<br><br>å®é™…ä½¿ç”¨éœ€è¦å¤šç»ƒä¹ æ‰èƒ½è‡ªå¦‚çš„ç”¨èµ·æ¥","like_count":0},{"had_liked":false,"id":337081,"user_name":"è¾£ä¹ˆå¤§","can_delete":false,"product_type":"c1","uid":1396951,"ip_address":"","ucode":"AB308B6DCA0108","user_header":"https://static001.geekbang.org/account/avatar/00/15/50/d7/f82ed283.jpg","comment_is_top":false,"comment_ctime":1646613985,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646613985","product_id":100085301,"comment_content":"ç¬¬ä¸‰é¢˜ï¼šself.inner().inc_strong() è°ƒç”¨äº† self.strong_ref().set(strong + 1)ï¼Œstrong_refæ˜¯ä¸€ä¸ªCellç±»å‹ï¼Œ æ˜¯å¯å˜çš„ã€‚<br><br>fn strong_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;<br>rc.rsæ–‡æ¡£çš„å¼€å¤´æœ‰è¿™ä¹ˆä¸€æ®µè¯ï¼š<br>&#47;&#47;! Shared references in Rust disallow mutation by default, and [`Rc`]<br>&#47;&#47;! is no exception: you cannot generally obtain a mutable reference to<br>&#47;&#47;! something inside an [`Rc`]. If you need mutability, put a [`Cell`]<br>&#47;&#47;! or [`RefCell`] inside the [`Rc`]; see [an example of mutability<br>&#47;&#47;! inside an `Rc`][mutability].<br><br>    fn inc_strong(&amp;self) {<br>        let strong = self.strong();<br><br>        &#47;&#47; We want to abort on overflow instead of dropping the value.<br>        &#47;&#47; The reference count will never be zero when this is called;<br>        &#47;&#47; nevertheless, we insert an abort here to hint LLVM at<br>        &#47;&#47; an otherwise missed optimization.<br>        if strong == 0 || strong == usize::MAX {<br>            abort();<br>        }<br>        self.strong_ref().set(strong + 1);<br>    }<br>","like_count":0},{"had_liked":false,"id":334194,"user_name":"adgjlä¸¶","can_delete":false,"product_type":"c1","uid":2889982,"ip_address":"","ucode":"A26A0C0F894F96","user_header":"https://static001.geekbang.org/account/avatar/00/2c/18/fe/1100a1f5.jpg","comment_is_top":false,"comment_ctime":1644806544,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644806544","product_id":100085301,"comment_content":"è€å¸ˆå¥½ï¼Œrustå¼•ç”¨è®¡æ•°å¯ä»¥å¤„ç†å¾ªç¯å¼•ç”¨å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":333228,"user_name":"Zero","can_delete":false,"product_type":"c1","uid":1077442,"ip_address":"","ucode":"A94F43EF1BF3A7","user_header":"https://static001.geekbang.org/account/avatar/00/10/70/c2/2031a595.jpg","comment_is_top":false,"comment_ctime":1644222386,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644222386","product_id":100085301,"comment_content":"```<br>fn main() {<br>    let arr = vec![1, 2, 2, 3, 3, 4, 4, 5, 5];<br><br>    let handler = std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    });<br>    handler.join().unwrap();<br>}<br>```<br>å¦‚æœä¸ä½¿ç”¨moveï¼Œé—­åŒ…ä¸èƒ½å¤Ÿæ‹¥æœ‰arrçš„æ‰€æœ‰æƒï¼Œéœ€è¦å°†arrçš„æ‰€æœ‰æƒè½¬äº¤ç»™é—­åŒ…ã€‚è¿™é‡Œä¹Ÿå°±æ˜¯æ¶‰åŠåˆ°arrçš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜ã€‚ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œè¯´æ˜ç¼–è¯‘å™¨å¹¶ä¸èƒ½åˆ¤æ–­å‡ºé—­åŒ…å’Œarrçš„ç”Ÿå‘½å‘¨æœŸè°æ›´é•¿ã€‚","like_count":0},{"had_liked":false,"id":333125,"user_name":"æ½ä½™æœˆ","can_delete":false,"product_type":"c1","uid":2709342,"ip_address":"","ucode":"D75ABAA841C23A","user_header":"https://static001.geekbang.org/account/avatar/00/29/57/5e/2565df70.jpg","comment_is_top":false,"comment_ctime":1644115544,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644115544","product_id":100085301,"comment_content":"è€å¸ˆï¼Œæˆ‘æƒ³è¯·é—®ä¸€ä¸‹<br>`self.downstream.as_ref.map(|v| v.clone())`<br>è¿™ä¸€å¥ä»£ç æ˜¯å¹²å˜›çš„ï¼ŸClippyæç¤ºæˆ‘å¯ä»¥ç®€åŒ–ä¸º`self.downstream.as_ref.cloned()`ï¼Œæˆ‘ç›´æ¥`self.downstream.clone()`ä¹Ÿå¯ä»¥","like_count":0},{"had_liked":false,"id":332133,"user_name":"Curricane","can_delete":false,"product_type":"c1","uid":1243961,"ip_address":"","ucode":"3778B96444874E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/VLB1WPGVDnicKaMGUcFZdtDQOXSib3LhFv6YqCZA16qfy2KHUAGL0ichSEE6rSu8HXSibGdg8vzIQ7qWlk9BZOeJjQ/132","comment_is_top":false,"comment_ctime":1643033803,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643033803","product_id":100085301,"comment_content":"use std::cell::RefCell;fn main() {    let data = RefCell::new(1);        let mut v = data.borrow_mut();    *v += 1;        println!(&quot;data: {:?}&quot;, data.borrow());}<br>è¿è¡Œæ—¶æŠ¥é”™<br>ä¸çŸ¥ æ˜¯RefCell æœ‰äº›ä¼¼ä¹æœ‰äº›ç‰¹æ®Šï¼Œè¿˜æ˜¯ç¼–è¯‘å™¨å¯¹ æ™®é€šçš„ å€Ÿç”¨åšäº†ä¼˜åŒ–ï¼Œå¦‚ä¸‹ä»£ç æ˜¯å¯ä»¥é€šè¿‡ç¼–è¯‘ä¸”æ­£å¸¸è¿è¡Œçš„<br><br>fn main() {<br>    let mut data = [1, 2];<br>    let data1 = &amp;mut data;<br>    data1[0] = -1;<br>    let data2 = &amp;data;<br>    println!(&quot;data2 {:?}&quot;, data2);<br><br>}<br><br>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ ","like_count":0},{"had_liked":false,"id":331580,"user_name":"è…¾è¾¾","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1642662001,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642662001","product_id":100085301,"comment_content":"å¯¹ä¸€ä¸ª Rc ç»“æ„è¿›è¡Œ clone(), ç”¨ï¼šRc::clone(..) è¿˜æ˜¯ a.clone() ?","like_count":0},{"had_liked":false,"id":331575,"user_name":"è…¾è¾¾","can_delete":false,"product_type":"c1","uid":1079876,"ip_address":"","ucode":"72F9CFBA44FDEE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9hlAIKQ1sGDu16oWLOHyCSicr18XibygQSMLMjuDvKk73deDlH9aMphFsj41WYJh121aniaqBLiaMNg/132","comment_is_top":false,"comment_ctime":1642660844,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642660844","product_id":100085301,"comment_content":"```rust<br>node3.borrow_mut().downstream  &#47;&#47; è¿™é‡Œä¸ºä»€ä¹ˆå¿…é¡»ä¸€æ°”å‘µæˆï¼Ÿä¸èƒ½ let mut aa =node3.borrow_mut();  aa.downstream=.....<br>```","like_count":0},{"had_liked":false,"id":321248,"user_name":"Ignis","can_delete":false,"product_type":"c1","uid":2837051,"ip_address":"","ucode":"94A55C81E2F86C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEL7ibAFViaJqhTRquzLKhS0SebmHON4RKeaL9I9R9wKHWt6ehcu0QtN8icvmPicU8wvDYIZiaaxqGWSxlw/132","comment_is_top":false,"comment_ctime":1636725264,"is_pvip":false,"replies":[{"id":"118934","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639853824,"ip_address":"","comment_id":321248,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636725264","product_id":100085301,"comment_content":"1. å°†arrç§»åŠ¨åˆ°å­çº¿ç¨‹ï¼š<br>```rust<br>fn main() {<br>    let arr = vec![1];<br>    std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    });<br>}<br>```<br><br>2. ä½¿ç”¨ArcåŒ…ä¸€ä¸‹Stringï¼š<br>```rust<br>use std::sync::Arc;<br><br>fn main() {<br>    let s1 = Arc::new(String::from(&quot;arc&quot;));<br>    let s2 = s1.clone();<br>    let h = std::thread::spawn(move || {<br>        println!(&quot;child thread: {:?}&quot;, s2);<br>    });<br>    println!(&quot;main thread: {:?}&quot;, s1);<br>    h.join().unwrap();<br>}<br>```<br><br>3. æ„Ÿè§‰è¿™ä¸ªç±»ä¼¼Cè¯­è¨€é‡Œé¢çš„constæŒ‡é’ˆï¼ŒæŒ‡é’ˆæœ¬èº«çš„å€¼ä¸èƒ½æ›´æ”¹ï¼Œä½†æ˜¯å…¶æŒ‡å‘çš„å†…å®¹æ˜¯å¯ä»¥æ›´æ”¹çš„ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539895,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639853824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313784,"user_name":"æ³¡æ²«çš„å¿«ä¹","can_delete":false,"product_type":"c1","uid":1165936,"ip_address":"","ucode":"44B2014D815DAE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ5MUYIZAaFTyrvLgNptib49zGW5SvqUxYmSC7qib4ibQF6GUiafsoHRqGQQvGicial7q5Bg9n11rLTNicHw/132","comment_is_top":false,"comment_ctime":1632664986,"is_pvip":false,"replies":[{"id":"113721","content":"ä¸»è¦æ˜¯å› ä¸ºè¿™æ ·æ–¹ä¾¿ç”Ÿæˆåœ¨æ ˆä¸Šæ“ä½œçš„æŒ‡ä»¤ã€‚æ¯”å¦‚ä½ ä¼ ç»™å‡½æ•°ä¸€ä¸ªä¸ç¡®å®šé•¿åº¦çš„æ•°æ®ï¼Œåœ¨ç”Ÿæˆæ–°çš„æ ˆå¸§æ—¶ï¼Œå‚æ•°ç©¶ç«Ÿè¦å å¤šå¤§çš„åŒºåŸŸï¼Œè¯¥ç”¨ä»€ä¹ˆæŒ‡ä»¤æ¥æ“ä½œè¿™ä¸ªæ•°æ®ï¼Œè¿™äº›éƒ½å¾ˆéº»çƒ¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632796446,"ip_address":"","comment_id":313784,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632664986","product_id":100085301,"comment_content":"è€å¸ˆæ‚¨å¥½ã€‚ æˆ‘ä¸å¤ªæ˜ç™½ï¼Œä¸ºä»€ä¹ˆæ ˆåªèƒ½å­˜æ”¾ ç¡®å®šå ç”¨å¤šå°‘å†…å­˜ çš„ç±»å‹ï¼Ÿ  ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527470,"discussion_content":"ä¸»è¦æ˜¯å› ä¸ºè¿™æ ·æ–¹ä¾¿ç”Ÿæˆåœ¨æ ˆä¸Šæ“ä½œçš„æŒ‡ä»¤ã€‚æ¯”å¦‚ä½ ä¼ ç»™å‡½æ•°ä¸€ä¸ªä¸ç¡®å®šé•¿åº¦çš„æ•°æ®ï¼Œåœ¨ç”Ÿæˆæ–°çš„æ ˆå¸§æ—¶ï¼Œå‚æ•°ç©¶ç«Ÿè¦å å¤šå¤§çš„åŒºåŸŸï¼Œè¯¥ç”¨ä»€ä¹ˆæŒ‡ä»¤æ¥æ“ä½œè¿™ä¸ªæ•°æ®ï¼Œè¿™äº›éƒ½å¾ˆéº»çƒ¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632796446,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313273,"user_name":".nil?","can_delete":false,"product_type":"c1","uid":1070750,"ip_address":"","ucode":"33459B799640BF","user_header":"https://static001.geekbang.org/account/avatar/00/10/56/9e/020797cd.jpg","comment_is_top":false,"comment_ctime":1632361577,"is_pvip":false,"replies":[{"id":"113528","content":"éå¸¸æ­£ç¡®ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1632464601,"ip_address":"","comment_id":313273,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632361577","product_id":100085301,"comment_content":"ç¬¬1é¢˜. æ ¹æ®é”™è¯¯æç¤ºå¯ä»¥çœ‹å‡ºï¼Œé—­åŒ…ä¸­å€Ÿç”¨çš„arrç”Ÿå‘½å‘¨æœŸå¤§äºmainå‡½æ•°ä¸­arrçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ ¹æ®æç¤ºæ·»åŠ moveå°±å¯ä»¥<br>```<br>fn main() {<br>  let arr = vec![1];<br><br>  std::thread::spawn(move || {<br>    println!(&quot;{:?}&quot;, arr);<br>  });<br>}<br>```<br><br>ç¬¬2é¢˜<br>```<br>use std::sync::Arc;<br>fn main() {<br>  let s1 = Arc::new(&quot;test str&quot;);<br>  let s2 = s1.clone();<br><br>  let hander = std::thread::spawn(move || {<br>    println!(&quot;thread s is {:?}&quot;, s2);<br>  });<br>  println!(&quot;s1 is {:?}&quot;, s1);<br>  hander.join().unwrap();<br>}<br>```<br><br>ç¬¬3é¢˜ï¼Œç¿»çœ‹æºä»£ç ï¼Œå¯¹äº inc_strong() å‡½æ•°ä¸­è°ƒç”¨çš„ strong_ref()ï¼Œå®ƒçš„è¿”å›ç±»å‹æ˜¯ Cellï¼Œè€Œ Cell æ˜¯å†…éƒ¨å¯å˜<br>```<br>    fn strong_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;<br><br>    #[inline]<br>    fn strong(&amp;self) -&gt; usize {<br>        self.strong_ref().get()<br>    }<br><br>    #[inline]<br>    fn inc_strong(&amp;self) {<br>        let strong = self.strong();<br><br>        &#47;&#47; We want to abort on overflow instead of dropping the value.<br>        &#47;&#47; The reference count will never be zero when this is called;<br>        &#47;&#47; nevertheless, we insert an abort here to hint LLVM at<br>        &#47;&#47; an otherwise missed optimization.<br>        if strong == 0 || strong == usize::MAX {<br>            abort();<br>        }<br>        self.strong_ref().set(strong + 1);<br>    }<br>```","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527299,"discussion_content":"éå¸¸æ­£ç¡®ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632464601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":312277,"user_name":"è®°äº‹æœ¬","can_delete":false,"product_type":"c1","uid":1401568,"ip_address":"","ucode":"FA942636EE0CC8","user_header":"https://static001.geekbang.org/account/avatar/00/15/62/e0/d2ff52da.jpg","comment_is_top":false,"comment_ctime":1631713861,"is_pvip":false,"replies":[{"id":"113162","content":"æ–‡ä¸­è®²è¿‡äº†ï¼Œ&amp;mut x ç¼–è¯‘æ—¶ç¼–è¯‘å™¨å¯ä»¥æ£€æŸ¥æ˜¯å¦è¿èƒŒæ‰€æœ‰æƒè§„åˆ™ï¼Œborrow_mut() æ˜¯ä¸ªå‡½æ•°ï¼Œåªæœ‰è¿è¡Œåˆ°è¿™ä¸€åˆ»ï¼Œæ‰çŸ¥é“æ˜¯å¦è¿èƒŒæ‰€æœ‰æƒè§„åˆ™ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631758481,"ip_address":"","comment_id":312277,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631713861","product_id":100085301,"comment_content":" x.borrow_mut() å’Œ &amp;mut x å¥½åƒç»“æœä¸€æ ·ä»–ä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526923,"discussion_content":"æ–‡ä¸­è®²è¿‡äº†ï¼Œ&amp;amp;mut x ç¼–è¯‘æ—¶ç¼–è¯‘å™¨å¯ä»¥æ£€æŸ¥æ˜¯å¦è¿èƒŒæ‰€æœ‰æƒè§„åˆ™ï¼Œborrow_mut() æ˜¯ä¸ªå‡½æ•°ï¼Œåªæœ‰è¿è¡Œåˆ°è¿™ä¸€åˆ»ï¼Œæ‰çŸ¥é“æ˜¯å¦è¿èƒŒæ‰€æœ‰æƒè§„åˆ™ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631758481,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311776,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1631457094,"is_pvip":false,"replies":[{"id":"112990","content":"æ ‡å‡†åº“é‡Œå¾ˆå¤š unsafe éƒ½æ˜¯ä¸ºäº†æ€§èƒ½æ‰€åšçš„å¦¥åã€‚è¯»ä»£ç ï¼Œé¦–å…ˆçœ‹æ•°æ®ç»“æ„å’Œæ¥å£ï¼Œç„¶åå†çœ‹å®ç°ç»†èŠ‚ï¼Œå¾ˆå¤šæ ‡å‡†åº“ä¸‹çš„unsafeï¼Œå®ç°ç»†èŠ‚å¹¶ä¸å¤æ‚ï¼Œå¦‚æœçœ‹ä¸æ‡‚ï¼Œå¼„æ˜ç™½æ¥å£åœ¨å¹²å˜›ä¹Ÿå°±å¯ä»¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631515008,"ip_address":"","comment_id":311776,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1631457094","product_id":100085301,"comment_content":"å¬å–è€å¸ˆå»ºè®®ï¼Œè¯»æºç ï¼Œçœ‹åˆ° cell.rs é‡Œé¢æœ‰å¾ˆå¤šçš„ unsafeï¼Œä»£ç ä»”ç»†é˜…è¯»ä¹Ÿæ²¡æœ‰é‚£ä¹ˆéš¾ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526737,"discussion_content":"æ ‡å‡†åº“é‡Œå¾ˆå¤š unsafe éƒ½æ˜¯ä¸ºäº†æ€§èƒ½æ‰€åšçš„å¦¥åã€‚è¯»ä»£ç ï¼Œé¦–å…ˆçœ‹æ•°æ®ç»“æ„å’Œæ¥å£ï¼Œç„¶åå†çœ‹å®ç°ç»†èŠ‚ï¼Œå¾ˆå¤šæ ‡å‡†åº“ä¸‹çš„unsafeï¼Œå®ç°ç»†èŠ‚å¹¶ä¸å¤æ‚ï¼Œå¦‚æœçœ‹ä¸æ‡‚ï¼Œå¼„æ˜ç™½æ¥å£åœ¨å¹²å˜›ä¹Ÿå°±å¯ä»¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631515008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311710,"user_name":"0@1","can_delete":false,"product_type":"c1","uid":1549191,"ip_address":"","ucode":"932A4139DB8169","user_header":"https://static001.geekbang.org/account/avatar/00/17/a3/87/eb923eb3.jpg","comment_is_top":false,"comment_ctime":1631419209,"is_pvip":false,"replies":[{"id":"112949","content":"è¯¾ç¨‹æ‰€æœ‰çš„ç›®å½•ï¼Ÿæœ‰å•Šï¼Œåœ¨è¯¾ç¨‹é¦–é¡µå°±æœ‰ä¸€å¼ ç›®å½•é•¿å›¾ã€‚<br><br>æœ€è¿‘ç•™è¨€åŒºæçš„ä¸€äº›é—®é¢˜éƒ½è¦åœ¨åé¢æ‰ä¼šå­¦åˆ°ã€‚<br>ä¸€éƒ¨åˆ†æ˜¯å› ä¸ºRustçš„è®¾è®¡æ˜¯ç¯ç¯ç›¸æ‰£çš„ï¼Œæ‰€ä»¥ä¹‹å‰çš„é—®é¢˜æ¶‰åŠåé¢çš„çŸ¥è¯†ï¼›ä¸€éƒ¨åˆ†ä¹Ÿæ˜¯å› ä¸ºæœ‰äº›åŒå­¦éå¸¸æ£’ï¼Œä¸€æ­¥æ­¥è¿½é—®æ€è€ƒï¼Œå­¦ä¹ è¿›åº¦ä¹Ÿå¾ˆä¸é”™ï¼Œæ‰€ä»¥ä¼šé—®åˆ°ç›®å‰çš„è¶…çº²å†…å®¹ã€‚é—®äº†çš„ï¼Œè€å¸ˆçœ‹åˆ°ä¹Ÿéƒ½è®¤çœŸè¡¥å……äº†ã€‚","user_name":"ç¼–è¾‘å›å¤","user_name_real":"å¶å¦‚èŠŠ","uid":"2547771","ctime":1631440067,"ip_address":"","comment_id":311710,"utype":2}],"discussion_count":1,"race_medal":0,"score":"1631419209","product_id":100085301,"comment_content":"è€å¸ˆï¼Œèƒ½ä¸èƒ½æå‰åˆ—å‡ºæ‰€æœ‰çš„è¯¾ç¨‹ç›®å½•ï¼Œè¿™æ ·ä¹Ÿå¥½æ–¹ä¾¿é—®é—®é¢˜ï¼Œ æœ‰äº›é—®é¢˜å¯èƒ½éœ€è¦åœ¨ç‰¹å®šè¯¾ç¨‹ç›®å½•ä¸‹é—®æ¯”è¾ƒåˆé€‚ã€‚","like_count":0,"discussions":[{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526712,"discussion_content":"è¯¾ç¨‹æ‰€æœ‰çš„ç›®å½•ï¼Ÿæœ‰å•Šï¼Œåœ¨è¯¾ç¨‹é¦–é¡µå°±æœ‰ä¸€å¼ ç›®å½•é•¿å›¾ã€‚\n\næœ€è¿‘ç•™è¨€åŒºæçš„ä¸€äº›é—®é¢˜éƒ½è¦åœ¨åé¢æ‰ä¼šå­¦åˆ°ã€‚\nä¸€éƒ¨åˆ†æ˜¯å› ä¸ºRustçš„è®¾è®¡æ˜¯ç¯ç¯ç›¸æ‰£çš„ï¼Œæ‰€ä»¥ä¹‹å‰çš„é—®é¢˜æ¶‰åŠåé¢çš„çŸ¥è¯†ï¼›ä¸€éƒ¨åˆ†ä¹Ÿæ˜¯å› ä¸ºæœ‰äº›åŒå­¦éå¸¸æ£’ï¼Œä¸€æ­¥æ­¥è¿½é—®æ€è€ƒï¼Œå­¦ä¹ è¿›åº¦ä¹Ÿå¾ˆä¸é”™ï¼Œæ‰€ä»¥ä¼šé—®åˆ°ç›®å‰çš„è¶…çº²å†…å®¹ã€‚é—®äº†çš„ï¼Œè€å¸ˆçœ‹åˆ°ä¹Ÿéƒ½è®¤çœŸè¡¥å……äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631440067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311552,"user_name":"Tyler","can_delete":false,"product_type":"c1","uid":1209108,"ip_address":"","ucode":"6C94C462D69EC6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL8Rzicd8f8GlIiaLQ6bYKPdhFJ3tvXw96rMicPv4s2rXEanYKjKdEewjCUAnwfJiaN53WyexhYLu1bbQ/132","comment_is_top":false,"comment_ctime":1631281468,"is_pvip":false,"replies":[{"id":"112880","content":"å¯¹ï¼ç¬¬ 3 é¢˜å’Œ unsafe å…³ç³»ä¸å¤§ï¼Œå’Œå†…éƒ¨å¯å˜æ€§æœ‰å…³ã€‚ä¸€ä¸ªåªè¯»å¼•ç”¨ï¼ˆ&amp;selfï¼‰ä¿®æ”¹æŸä¸ªå†…éƒ¨æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªå†…éƒ¨æ•°æ®ä¸€å®šä½¿ç”¨äº†å†…éƒ¨å¯å˜æ€§ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631284662,"ip_address":"","comment_id":311552,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631281468","product_id":100085301,"comment_content":"1ã€åœ¨é—­åŒ…å‰åŠ moveå…³é”®å­—ã€‚  ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶æœ‰é”™è¯¯æç¤ºå¹¶æä¾›äº†ä¸€ä¸ªè§£å†³çš„æ–¹æ³•ã€‚<br>2ã€<br>use std::sync::Arc;<br><br>fn main() {<br>  let s = Arc::new(String::from(&quot;Hello World&quot;));<br>  let s1 = s.clone();<br>  let h = std::thread::spawn(move || {<br>    println!(&quot;thread: {:?}&quot;, s1);<br>  });<br>  <br>  println!(&quot;{:?}&quot;, s);<br>  h.join().unwrap();<br>}<br>```<br>3ã€æŸ¥çœ‹æºç inner()çš„å®ç°ä½¿ç”¨äº†unsafe <br><br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526659,"discussion_content":"å¯¹ï¼ç¬¬ 3 é¢˜å’Œ unsafe å…³ç³»ä¸å¤§ï¼Œå’Œå†…éƒ¨å¯å˜æ€§æœ‰å…³ã€‚ä¸€ä¸ªåªè¯»å¼•ç”¨ï¼ˆ&amp;amp;selfï¼‰ä¿®æ”¹æŸä¸ªå†…éƒ¨æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªå†…éƒ¨æ•°æ®ä¸€å®šä½¿ç”¨äº†å†…éƒ¨å¯å˜æ€§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631284662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311551,"user_name":"Custer","can_delete":false,"product_type":"c1","uid":1020822,"ip_address":"","ucode":"8AEA5544C94D57","user_header":"https://static001.geekbang.org/account/avatar/00/0f/93/96/575d42c3.jpg","comment_is_top":false,"comment_ctime":1631280712,"is_pvip":true,"replies":[{"id":"113001","content":"éå¸¸æ­£ç¡®ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631516291,"ip_address":"","comment_id":311551,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631280712","product_id":100085301,"comment_content":"1.<br>fn main() {<br>  let arr = vec![1];<br><br>  std::thread::spawn(move || {<br>    println!(&quot;{:?}&quot;, arr);<br>  });<br>}<br>2.<br>   1 â”‚ use std::sync::Arc;<br>   2 â”‚<br>   3 â”‚ fn main() {<br>   4 â”‚ let str = Arc::new(String::from(&quot;å…±äº«å­—ç¬¦ä¸²&quot;));<br>   5 â”‚ let a = str.clone();<br>   6 â”‚ let b = Arc::clone(&amp;str);<br>   7 â”‚<br>   8 â”‚ std::thread::spawn(move || {<br>   9 â”‚ println!(&quot;çº¿ç¨‹: {:?}&quot;, b);<br>  10 â”‚ });<br>  11 â”‚ println!(&quot;main: {:?}&quot;, a);<br>  12 â”‚ }<br>3.<br>æŸ¥çœ‹æºä»£ç <br>```rust<br>impl&lt;T: ?Sized&gt; Clone for Rc&lt;T&gt; {<br>    #[inline]<br>    fn clone(&amp;self) -&gt; Rc&lt;T&gt; {<br>        self.inner().inc_strong();<br>        Self::from_inner(self.ptr)<br>    }<br>}<br>```<br><br>```rust<br>impl&lt;T: ?Sized&gt; Rc&lt;T&gt; {<br>    #[inline(always)]<br>    fn inner(&amp;self) -&gt; &amp;RcBox&lt;T&gt; {<br>        &#47;&#47; This unsafety is ok because while this Rc is alive we&#39;re guaranteed<br>        &#47;&#47; that the inner pointer is valid.<br>        unsafe { self.ptr.as_ref() }<br>    }<br>...<br>```<br><br>```rust<br>#[doc(hidden)]<br>trait RcInnerPtr {<br>    fn weak_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;<br>    fn strong_ref(&amp;self) -&gt; &amp;Cell&lt;usize&gt;;<br><br>    #[inline]<br>    fn strong(&amp;self) -&gt; usize { self.strong_ref().get() }<br><br>    #[inline]<br>    fn inc_strong(&amp;self) {<br>        let strong = self.strong();<br><br>        if strong == 0 || strong == usize::MAX {<br>            abort();<br>        }<br>        self.strong_ref().set(strong + 1);<br>    }<br>```<br><br>çœ‹æºä»£ç çŒœæµ‹â€œè¿™é‡Œå¯¹ self çš„ä¸å¯å˜å¼•ç”¨å¯ä»¥æ”¹å˜ self çš„å†…éƒ¨æ•°æ®â€æ˜¯å› ä¸ºï¼š<br>åœ¨ unsafe ä»£ç å—ä¸­è·å–äº† self çš„æŒ‡é’ˆï¼Œè¿”å›äº† `RcBox&lt;T&gt;` çš„å¼•ç”¨ç±»å‹ï¼Œç„¶ååœ¨ `inc_strong()` å‡½æ•°ä¸­ï¼Œé€šè¿‡ `self.strong_ref()` ä½¿ç”¨ `Cellï¼œTï¼` å†…éƒ¨å¯å˜å®¹å™¨ï¼Œé€šè¿‡å¯¹å¤–æš´éœ²çš„ `set` æ–¹æ³•å®ç°äº†å¯¹å†…éƒ¨å€¼çš„ä¿®æ”¹ï¼Œè€Œå…¶æœ¬èº«å´æ˜¯ä¸å¯å˜çš„ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Š `Cellï¼œTï¼` åŒ…è£¹çš„Tæœ¬èº«åˆæ³•åœ°é¿å¼€äº†å€Ÿç”¨æ£€æŸ¥ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526658,"discussion_content":"éå¸¸æ­£ç¡®ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631516291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311459,"user_name":"jin","can_delete":false,"product_type":"c1","uid":1202896,"ip_address":"","ucode":"DCA0E9C1F7838F","user_header":"https://static001.geekbang.org/account/avatar/00/12/5a/d0/5be738e0.jpg","comment_is_top":false,"comment_ctime":1631242661,"is_pvip":false,"replies":[{"id":"113003","content":"è¿™æ˜¯è¿™ä¸ªä¾‹å­çš„å†™æ³•é—®é¢˜ï¼Œå®ƒåªæ˜¯ä¸ºäº†å±•ç¤º Rc &#47; RefCellã€‚å¦‚æœè¦çœŸå†™ä¸€ä¸ª DAGï¼Œå¯ä»¥çœ‹ daggy è¿™ä¸ªé¡¹ç›®ï¼Œè¿™æ˜¯å®ƒçš„ç”¨æ³•ï¼šhttps:&#47;&#47;github.com&#47;mitchmindtree&#47;daggy&#47;blob&#47;master&#47;tests&#47;add_edges.rs","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631516495,"ip_address":"","comment_id":311459,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631242661","product_id":100085301,"comment_content":"è€å¸ˆå¥½ï¼Œæ–‡ç« æ„é€ DAGæ—¶ï¼Œæ˜¯å…ˆæ„å»ºäº†Node1ï¼Œ3ï¼Œ4çš„å…³ç³»ï¼Œå†æŠŠ2åŠ è¿›å»ã€‚ä½†è®©æˆ‘ç›´è§‰ä¸Šéš¾ä»¥æ¥å—çš„æ˜¯ï¼ŒåŠ è¿›å»çš„æ—¶å€™å´ç”¨åˆ°äº†Node1ï¼Œå› ä¸ºéœ€è¦è°ƒç”¨Rc.clone()å¢åŠ å¼•ç”¨è®¡æ•°ã€‚åœ¨å®é™…çš„å›¾è®ºé—®é¢˜ä¸­ï¼Œå‡è®¾æˆ‘ä»¬è¦æ’å…¥ç‚¹2ï¼Œæ‰¾åˆ°äº†ç‚¹3ï¼Œéš¾é“è¿˜è¦O(n)éå†æ‰€æœ‰ç‚¹ï¼Œä»è€Œæ‰¾åˆ°ç‚¹2çš„referenceå—ï¼Ÿæ„Ÿè§‰è¿™ä¸ªç¡®å®æœ‰ç‚¹é™åˆ¶çµæ´»æ€§äº†ï¼Œè¯·é—®æ‚¨æ€ä¹ˆçœ‹å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526614,"discussion_content":"è¿™æ˜¯è¿™ä¸ªä¾‹å­çš„å†™æ³•é—®é¢˜ï¼Œå®ƒåªæ˜¯ä¸ºäº†å±•ç¤º Rc / RefCellã€‚å¦‚æœè¦çœŸå†™ä¸€ä¸ª DAGï¼Œå¯ä»¥çœ‹ daggy è¿™ä¸ªé¡¹ç›®ï¼Œè¿™æ˜¯å®ƒçš„ç”¨æ³•ï¼šhttps://github.com/mitchmindtree/daggy/blob/master/tests/add_edges.rs","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631516495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311458,"user_name":"Christian","can_delete":false,"product_type":"c1","uid":1089000,"ip_address":"","ucode":"D84F866015BA07","user_header":"https://static001.geekbang.org/account/avatar/00/10/9d/e8/39433235.jpg","comment_is_top":false,"comment_ctime":1631242659,"is_pvip":false,"replies":[{"id":"112876","content":"æ­£ç¡®ï¼ä¸è¿‡ç¬¬ 2 é¢˜åœ¨çº¿ç¨‹é‡Œçš„é—­åŒ…æ²¡æœ‰å¿…è¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1631284257,"ip_address":"","comment_id":311458,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631242659","product_id":100085301,"comment_content":"1. spawn è¦æ±‚é—­åŒ…å…·æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸã€‚ä½†ä¼ å…¥çš„é—­åŒ…æ•è·äº† arr çš„å¼•ç”¨ï¼Œç”Ÿå‘½å‘¨æœŸä¸ä¼šè¶…å‡º main å‡½æ•°ã€‚ä¿®å¤ï¼š<br>```rust<br>fn main() {<br>    let arr = vec![1];<br>    std::thread::spawn(move || {<br>        println!(&quot;{:?}&quot;, arr);<br>    });<br>}<br>```<br><br>2. <br>```rust<br>use std::sync::Arc;<br><br>fn main() {<br>    let s = Arc::new(&quot;foo&quot;.to_string());<br><br>    let handle = std::thread::spawn({<br>        let s = s.clone();<br><br>        move || {<br>            println!(&quot;{:?}&quot;, s);<br>        }<br>    });<br><br>    println!(&quot;{:?}&quot;, s);<br><br>    handle.join().unwrap();<br>}<br>```<br><br>3. inner() çš„è¿”å›ç±»å‹å…·æœ‰å†…éƒ¨å¯å˜è¡Œã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526613,"discussion_content":"æ­£ç¡®ï¼ä¸è¿‡ç¬¬ 2 é¢˜åœ¨çº¿ç¨‹é‡Œçš„é—­åŒ…æ²¡æœ‰å¿…è¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631284257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}