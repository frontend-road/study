{"id":86544,"title":"31 | 仅需任意任务完成","content":"<h1>课件及源代码地址</h1><p><a href=\"https://gitee.com/geektime-geekbang/go_learning\">https://gitee.com/geektime-geekbang/go_learning</a></p><h2>书目推荐</h2><p><a href=\"time://mall?url=https%3A%2F%2Fh5.youzan.com%2Fv2%2Fgoods%2F1ycmk3uob0ryw\">《计算机程序的构造和解释》</a></p>","comments":[{"had_liked":false,"id":79768,"user_name":"NEVER SETTLE","can_delete":false,"product_type":"c3","uid":1101894,"ip_address":"","ucode":"9C86BDAFDBF768","user_header":"https://static001.geekbang.org/account/avatar/00/10/d0/46/1a9229b3.jpg","comment_is_top":false,"comment_ctime":1553555674,"is_pvip":false,"replies":[{"id":29192,"content":"我也希望尽量这样。主要是后面的课程内容相对前面的每一课都多不少，为满足平台对时长的限制，只能将一些代码事先准备好。也建议可以下载我们github上的代码在机器上运行和调试。谢谢","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553605410,"ip_address":"","comment_id":79768,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"我比较喜欢老师一边敲代码，一边讲。这样我可以完全跟着思路走，一边就能懂。但是老师提前写好代码，上来直接讲，我有点懵，我每次得暂停把代码看明白了，再继续往下走，有时候再播放第二遍。","like_count":11,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444614,"discussion_content":"我也希望尽量这样。主要是后面的课程内容相对前面的每一课都多不少，为满足平台对时长的限制，只能将一些代码事先准备好。也建议可以下载我们github上的代码在机器上运行和调试。谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553605410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227943,"user_name":"www","can_delete":false,"product_type":"c3","uid":1898338,"ip_address":"","ucode":"ADC9BC655EA16C","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f7/62/947004d0.jpg","comment_is_top":false,"comment_ctime":1592529047,"is_pvip":false,"replies":[{"id":84119,"content":"谢谢🙏","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1592567557,"ip_address":"","comment_id":227943,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"之前看了网上几套讲解Golang语言基础教程，感觉讲解得不那么透彻。直到这套课程，虽然间断，不会十分详细，需要自己下来多查资料，但逻辑清晰，例子很实用，逐渐能够体会到Golang的独特之处，感谢蔡生，希望多出视频","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498851,"discussion_content":"谢谢🙏","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592567557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1078098,"avatar":"https://static001.geekbang.org/account/avatar/00/10/73/52/8a4cf5e9.jpg","nickname":"骷髅骨头","note":"","ucode":"9FCBA47EFD37F6","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360798,"discussion_content":"呵呵","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1616517328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":82461,"user_name":"NIXUS","can_delete":false,"product_type":"c3","uid":1000060,"ip_address":"","ucode":"853763C229A5AA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/7c/8ef14715.jpg","comment_is_top":false,"comment_ctime":1554217717,"is_pvip":false,"replies":[{"id":30034,"content":"在检查协程数之前sleep一秒试试，让协程有时间完成和释放","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1554473766,"ip_address":"","comment_id":82461,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师, 如果使用sync.WaitGroup的话, 发现每次输出的, After的gorountine的数量都是不同的, 这个应该怎么理解呢?\n\npackage ch22\n\nimport (\n\t&quot;fmt&quot;\n\t&quot;runtime&quot;\n\t&quot;sync&quot;\n\t&quot;testing&quot;\n\t&quot;time&quot;\n)\n\nvar wg sync.WaitGroup\n\nfunc runTask(id int) string {\n\ttime.Sleep(time.Millisecond * 10)\n\treturn fmt.Sprintf(&quot;The result is from %d&quot;, id)\n}\n\nfunc FirstResponse() string {\n\tnumOfRunner := 10\n\tch := make(chan string, numOfRunner)\n\tfor i := 0; i &lt; numOfRunner; i++ {\n\t\tgo func(i int) {\n\t\t\tch &lt;- runTask(i)\n\t\t}(i)\n\t}\n\tabc := &lt;-ch\n\twg.Done()\n\treturn abc\n}\n\nfunc TestFirstResponse(t *testing.T) {\n\tt.Log(&quot;Before:&quot;, runtime.NumGoroutine())\n\twg.Add(1)\n\tt.Log(FirstResponse())\n\twg.Wait()\n\t&#47;&#47; time.Sleep(time.Second)\n\tt.Log(&quot;After:&quot;, runtime.NumGoroutine())\n}\n","like_count":2,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445600,"discussion_content":"在检查协程数之前sleep一秒试试，让协程有时间完成和释放","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554473766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287585,"user_name":"escray","can_delete":false,"product_type":"c3","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1618040674,"is_pvip":true,"replies":[{"id":104460,"content":"至于使用buffered chan还是使用阻塞chan，重点也要看看你要不要发送者和接收者见同步","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1618103476,"ip_address":"","comment_id":287585,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"我觉的 Go 语言的作者，其实是把并发编程中的一些痛点拿出来，做了专门的优化，比如这一讲的“仅需任意任务完成”。\n\n我对于 WaitGroup 和 Channel close 部分的代码似乎有些混淆，希望后面能慢慢理清楚。\n\n使用 buffer channel 可以避免协程泄漏，那么是不是在大部分的情况下，都应该优先 buffer channel 而不是 unbuffered channel？\n\n老师在留言里面回复了大部分的代码问题，这个还是挺难得的，当然总体留言数目不多。\n\n我也从留言里面学到很多。","like_count":1,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518357,"discussion_content":"至于使用buffered chan还是使用阻塞chan，重点也要看看你要不要发送者和接收者见同步","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618103476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394750,"user_name":"Clark Chen","can_delete":false,"product_type":"c3","uid":1939363,"ip_address":"辽宁","ucode":"C0E5AECA4CE7C5","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL212ET0q3e8U5xXuYe7LCBlrpdBFkrgedibfdao2fMUKnCWwxm2I05RB7EyDcgeL0g60ib88cn2dmQ/132","comment_is_top":false,"comment_ctime":1728100434,"is_pvip":false,"replies":[{"id":143539,"content":"你注意看代码中在创建buffered channel的时候，buffer的长度确定要根据goroutine数量。","user_name":"作者回复","user_name_real":"编辑","uid":1008262,"ctime":1730616939,"ip_address":"北京","comment_id":394750,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"感觉这种做法并没有解决泄漏， 如果goRouting的数量大于缓存的数量，也有相同的问题。有更好的方法解决这个问题吗？比如说通过close 这个channel来解决","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":653293,"discussion_content":"你注意看代码中在创建buffered channel的时候，buffer的长度确定要根据goroutine数量。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1730616939,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":283040,"user_name":"Geek_ea3747","can_delete":false,"product_type":"c3","uid":2027802,"ip_address":"","ucode":"22C908580C0925","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f1/1a/b1de30c8.jpg","comment_is_top":false,"comment_ctime":1615528676,"is_pvip":false,"replies":[{"id":104461,"content":"是的，那个协程会被阻塞。这就造成了携程泄漏","user_name":"作者回复","user_name_real":"蔡超","uid":1008262,"ctime":1618103999,"ip_address":"","comment_id":283040,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"func getFirst() string {\n\tch := make(chan string)\n\tfor i := 0; i &lt; 2; i++ {\n\t\tgo func(i int) {\n\t\t\tfmt.Println(&quot;start:&quot; + strconv.Itoa(i))\n\t\t\ttime.Sleep(500 * time.Millisecond)\n\t\t\tch &lt;- &quot;return:&quot; + strconv.Itoa(i)\n\t\t\tfmt.Println(&quot;finish:&quot; + strconv.Itoa(i))\n\n\t\t}(i)\n\t}\n\treturn &lt;-ch\n}\n\nfunc TestFirstRes(t *testing.T) {\n\tfmt.Println(getFirst())\n\ttime.Sleep(5 * time.Second)\n}\n打印结果类似:\nstart:1\nstart:0\nfinish:0\nreturn:0\n\n有一个一直没有执行到finish ,  没有结束的那个携程会因为一直无法写入chan而等待吗 ? 如果程序一直不结束, 这个携程的最终结果会怎么样 ?","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516919,"discussion_content":"是的，那个协程会被阻塞。这就造成了携程泄漏","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618103999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1020525,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","nickname":"escray","note":"","ucode":"1F4204930E47C4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366344,"discussion_content":"似乎是 channel 被阻塞了，把 channel 改为 buffer channel 即可\n\nch := make(chan string, 2)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618040319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270484,"user_name":"Geek_62f799","can_delete":false,"product_type":"c3","uid":2312427,"ip_address":"","ucode":"AFED1798E94638","user_header":"","comment_is_top":false,"comment_ctime":1609144306,"is_pvip":false,"replies":[{"id":98365,"content":"粘贴一下你的实验代码","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1609563441,"ip_address":"","comment_id":270484,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师 不使用channel buffer的时候我这里为什么始终都是返回0啊。如果改改task时间可能会变，但是在task时间不变的情况下，返回的协程号始终是一样的","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512644,"discussion_content":"粘贴一下你的实验代码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609563441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268550,"user_name":"寒溪","can_delete":false,"product_type":"c3","uid":1001970,"ip_address":"","ucode":"67B9F1A1C15A20","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/f2/25cfa472.jpg","comment_is_top":false,"comment_ctime":1608255045,"is_pvip":false,"replies":[{"id":97496,"content":"判断是否有问题的核心就是是不是有协程被阻塞","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1608340022,"ip_address":"","comment_id":268550,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"那么问题来了如何确保buffer&gt;协程数量\n否则依然有泄露的风险","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511967,"discussion_content":"判断是否有问题的核心就是是不是有协程被阻塞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608340022,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":224411,"user_name":"未来","can_delete":false,"product_type":"c3","uid":1747981,"ip_address":"","ucode":"BACF4564DD28D4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epuP7Mw3tY0jb4RzKZQIoYo3icV0vZPzpvibOfib19FicxANUibGvzdssOzIZpGkIWcYNNQH7TzmXEZSfg/132","comment_is_top":false,"comment_ctime":1591371966,"is_pvip":false,"replies":[{"id":84177,"content":"是的。还有其他协程。","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1592638617,"ip_address":"","comment_id":224411,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"老师，不是很理解为什么before :2 ，当第一个数据放入ch中并被取走后，after 为什么还是2，不是应该所有携程都释放了？是因为执行输出after的时候，其他协程还没开始吗？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497466,"discussion_content":"是的。还有其他协程。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592638617,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1890825,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/da/09/5fc3b526.jpg","nickname":"郭泽鑫🐤","note":"","ucode":"40B9981EEC524F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652059,"discussion_content":"主协程和go test的辅助协程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728179946,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":198449,"user_name":"gofer","can_delete":false,"product_type":"c3","uid":1614922,"ip_address":"","ucode":"246CD48AF018BA","user_header":"https://static001.geekbang.org/account/avatar/00/18/a4/4a/25c60a94.jpg","comment_is_top":false,"comment_ctime":1585452221,"is_pvip":false,"replies":[{"id":75404,"content":"t.Log(&quot;Before:&quot;, runtime.NumGoroutine())\n\tt.Log(FirstResponse())\n\ttime.Sleep(time.Second * 1)\n\tt.Log(&quot;After:&quot;, runtime.NumGoroutine())\n\n你是不是没有Sleep呢，协程还没有释放回收","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1585831375,"ip_address":"","comment_id":198449,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100024001,"comment_content":"API server listening at: 127.0.0.1:58598\n=== RUN   TestFirstResponse\n    TestFirstResponse: first_response_test.go:28: Before: 2\n    TestFirstResponse: first_response_test.go:29: The result is from 5\n    TestFirstResponse: first_response_test.go:30: The result is from 4\n    TestFirstResponse: first_response_test.go:31: The result is from 0\n    TestFirstResponse: first_response_test.go:33: After: 11\n--- PASS: TestFirstResponse (0.03s)\n老师，麻饭您解释下，用完协程反而变多了的原因？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489705,"discussion_content":"t.Log(&amp;quot;Before:&amp;quot;, runtime.NumGoroutine())\n\tt.Log(FirstResponse())\n\ttime.Sleep(time.Second * 1)\n\tt.Log(&amp;quot;After:&amp;quot;, runtime.NumGoroutine())\n\n你是不是没有Sleep呢，协程还没有释放回收","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585831375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172885,"user_name":"风骑","can_delete":false,"product_type":"c3","uid":1017289,"ip_address":"","ucode":"D96526F7F37442","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDe7Ep3YW87sWJLc9GzgA2z1CSyHI3iaZQpCLzM2O1e30CQywGsMj5cQyh6pTGybvFgN0bTuWE8nA/132","comment_is_top":false,"comment_ctime":1579351517,"is_pvip":false,"replies":[{"id":67372,"content":"你运行的是下面代码，由于协程的调度是随机的，所以第一个返回channel的结果也是随机的，你可以多运行几次看看，可以通过命令行 go test -v 试试。\npackage concurrency\n\nimport (\n\t&quot;fmt&quot;\n\t&quot;runtime&quot;\n\t&quot;testing&quot;\n\t&quot;time&quot;\n)\n\nfunc runTask(id int) string {\n\ttime.Sleep(10 * time.Millisecond)\n\treturn fmt.Sprintf(&quot;The result is from %d&quot;, id)\n}\n\nfunc FirstResponse() string {\n\tnumOfRunner := 10\n\tch := make(chan string, numOfRunner)\n\tfor i := 0; i &lt; numOfRunner; i++ {\n\t\tgo func(i int) {\n\t\t\tret := runTask(i)\n\t\t\tch &lt;- ret\n\t\t}(i)\n\t}\n\treturn &lt;-ch\n}\n\nfunc TestFirstResponse(t *testing.T) {\n\tt.Log(&quot;Before:&quot;, runtime.NumGoroutine())\n\tt.Log(FirstResponse())\n\ttime.Sleep(time.Second * 1)\n\tt.Log(&quot;After:&quot;, runtime.NumGoroutine())\n\n}\n","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1579701810,"ip_address":"","comment_id":172885,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"我按照第一种方式测试，一直都是输出的同一个结果，我问了同事，他说是channel里面有个队列机制，希望老师能解答下这个问题吧，周围也没咨询到能够给出答案的人，麻烦老师了","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481890,"discussion_content":"你运行的是下面代码，由于协程的调度是随机的，所以第一个返回channel的结果也是随机的，你可以多运行几次看看，可以通过命令行 go test -v 试试。\npackage concurrency\n\nimport (\n\t&amp;quot;fmt&amp;quot;\n\t&amp;quot;runtime&amp;quot;\n\t&amp;quot;testing&amp;quot;\n\t&amp;quot;time&amp;quot;\n)\n\nfunc runTask(id int) string {\n\ttime.Sleep(10 * time.Millisecond)\n\treturn fmt.Sprintf(&amp;quot;The result is from %d&amp;quot;, id)\n}\n\nfunc FirstResponse() string {\n\tnumOfRunner := 10\n\tch := make(chan string, numOfRunner)\n\tfor i := 0; i &amp;lt; numOfRunner; i++ {\n\t\tgo func(i int) {\n\t\t\tret := runTask(i)\n\t\t\tch &amp;lt;- ret\n\t\t}(i)\n\t}\n\treturn &amp;lt;-ch\n}\n\nfunc TestFirstResponse(t *testing.T) {\n\tt.Log(&amp;quot;Before:&amp;quot;, runtime.NumGoroutine())\n\tt.Log(FirstResponse())\n\ttime.Sleep(time.Second * 1)\n\tt.Log(&amp;quot;After:&amp;quot;, runtime.NumGoroutine())\n\n}\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579701810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1078528,"avatar":"https://static001.geekbang.org/account/avatar/00/10/75/00/618b20da.jpg","nickname":"徐海浪","note":"","ucode":"21801C420D0610","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":176582,"discussion_content":"因为测试并没有被实际运行，显示的是之前缓存的测试结果。\n你可以稍微改一下fmt.Sprintf字符串试试，或者加上-count=1关闭go test的缓存。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582037871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79862,"user_name":"cfanbo","can_delete":false,"product_type":"c3","uid":1043738,"ip_address":"","ucode":"39D8D71453E575","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ed/1a/269eb3d6.jpg","comment_is_top":false,"comment_ctime":1553565363,"is_pvip":false,"replies":[{"id":29171,"content":"是的。只是第一个结果回来就返回接在做下面的事了","user_name":"作者回复","user_name_real":"ChaoCai2010","uid":1008262,"ctime":1553601512,"ip_address":"","comment_id":79862,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"这个虽然只使用了一个结果，但实际上后端也是返回了多个结果的吧？","like_count":0,"discussions":[{"author":{"id":1008262,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/86/632ad029.jpg","nickname":"蔡超","note":"","ucode":"4C281BBF511238","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444657,"discussion_content":"是的。只是第一个结果回来就返回接在做下面的事了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553601512,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145270,"user_name":"天狼星","can_delete":false,"product_type":"c3","uid":1710022,"ip_address":"","ucode":"44AA9A9213B7B3","user_header":"https://static001.geekbang.org/account/avatar/00/1a/17/c6/ab383933.jpg","comment_is_top":false,"comment_ctime":1572241638,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"这么操作的话，还是有资源浪费的隐患，10个协程实际都完成了处理，应该是取回一个结果后，其他协程取消之后的处理才好。","like_count":10,"discussions":[{"author":{"id":1019568,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8e/b0/ef201991.jpg","nickname":"CcczzZ","note":"","ucode":"5F46DA5053D2BB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":182688,"discussion_content":"Context可实现线程中断执行","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582448209,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1522000,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/pV7g6NclSVCnQFX3EyQLsI0BtopYGIjmvBFSB3pXiawdxKOFn0Zhvb2l5UEGjukVAkll83amjOyM9RZK8wU191A/132","nickname":"Geek_tgq","note":"","ucode":"CA1F4AA5F2D8D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":174604,"discussion_content":"要是有中断goroutine的操作就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581930053,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186196,"user_name":"james","can_delete":false,"product_type":"c3","uid":1049208,"ip_address":"","ucode":"5701899403917C","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","comment_is_top":false,"comment_ctime":1583794818,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"其他协程也是往 chan 写数据了, 只不过没有人消费, 那这些垃圾数据如何处理呢","like_count":4,"discussions":[{"author":{"id":1627670,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d6/16/107f0d04.jpg","nickname":"山青","note":"","ucode":"904AE3C23D3B92","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385645,"discussion_content":"所以比较笨的做法就是搞个数量等于或者更大的buffer然后 保证每个chan最后都能取到数据 我就想如果有一个chan确实取不到数据最后咋办 或者说百度不管怎样都不会返回数据。最终会怎么样。 还是会阻塞。觉得还是要close比较好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627193055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288603,"user_name":"文公","can_delete":false,"product_type":"c3","uid":1059905,"ip_address":"","ucode":"32045D40E962F0","user_header":"https://static001.geekbang.org/account/avatar/00/10/2c/41/48cfdf89.jpg","comment_is_top":false,"comment_ctime":1618557349,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"为什么开始有两个协程呢？一开始不应该只有主协程么？","like_count":3,"discussions":[{"author":{"id":1510177,"avatar":"https://static001.geekbang.org/account/avatar/00/17/0b/21/f1aea35b.jpg","nickname":"let_me_go","note":"","ucode":"A5936F5C5E3D65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376278,"discussion_content":"我猜应该是这样的：老师的代码都是在测试中运行的，测试中运行时可能会在主协程中再创建一个协程来运行测试任务，所以是两个协程。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622044703,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1510177,"avatar":"https://static001.geekbang.org/account/avatar/00/17/0b/21/f1aea35b.jpg","nickname":"let_me_go","note":"","ucode":"A5936F5C5E3D65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376269,"discussion_content":"是呀，我也有这个疑问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622042525,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81068,"user_name":"Zen","can_delete":false,"product_type":"c3","uid":1044292,"ip_address":"","ucode":"32DB75B62FE095","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ef/44/5e172496.jpg","comment_is_top":false,"comment_ctime":1553792012,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"因为struct是空的， 你往里边随便丢一个成员，不加once输出的地址就不一样了","like_count":2},{"had_liked":false,"id":234744,"user_name":"郭星","can_delete":false,"product_type":"c3","uid":1182219,"ip_address":"","ucode":"8A0F5DF80E0C61","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/0b/985d3800.jpg","comment_is_top":false,"comment_ctime":1594785060,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"怎么才能对channel 进行优雅关闭; 因为我仅需要任意一个任务成功,channel中有一个消息时,任务就直接返回了,但其他的协程还是会继续往channel中写入消息;\n如果不复用channel,我们如何对channel进行关闭?\n如果复用channel,如何清除channel中的无效消息?","like_count":1},{"had_liked":false,"id":340058,"user_name":"Geek2353","can_delete":false,"product_type":"c3","uid":2689527,"ip_address":"","ucode":"7A8598D38F455C","user_header":"","comment_is_top":false,"comment_ctime":1648562383,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"讲的很好","like_count":0},{"had_liked":false,"id":270307,"user_name":"Geek__xyq","can_delete":false,"product_type":"c3","uid":1465668,"ip_address":"","ucode":"9935656B290D3D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKHjIl0sKCy1xEHExnLWRcZoJvfTZicBbmod0k1JZ82OC9Fpy65EK1OBY2YSzX5ctBAIkdR9Smkd3g/132","comment_is_top":false,"comment_ctime":1609059202,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100024001,"comment_content":"这里buffer的长度是否设置成numOfRunner-1也可以？","like_count":0,"discussions":[{"author":{"id":1935187,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/87/53/4fe8b852.jpg","nickname":"阿丽塔～","note":"","ucode":"982FEB3A33905C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":598538,"discussion_content":"可以的，因为阻塞的那个会在channel取数返回后，继续放到channel中，你可以设置主协程的sleep时间验证","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1672897258,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}