{"id":440695,"title":"25ï½œGORMï¼ˆä¸Šï¼‰ï¼šæ•°æ®åº“çš„ä½¿ç”¨å¿…ä¸å¯å°‘","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚</p><p>ä¸€ä¸ª Web åº”ç”¨ï¼Œæœ‰å¾ˆå¤§éƒ¨åˆ†åŠŸèƒ½æ˜¯å¯¹æ•°æ®åº“ä¸­æ•°æ®çš„è·å–å’ŒåŠ å·¥ã€‚æ¯”å¦‚ä¸€ä¸ªç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡ä»£ç ä¸­éœ€è¦é¢‘ç¹å¢åŠ ç”¨æˆ·ã€åˆ é™¤ç”¨æˆ·ã€ä¿®æ”¹ç”¨æˆ·ç­‰ï¼Œè€Œç”¨æˆ·çš„æ•°æ®éƒ½å­˜æ”¾åœ¨æ•°æ®åº“ä¸­ã€‚æ‰€ä»¥å¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ï¼Œæ˜¯åš Web åº”ç”¨å¿…é¡»å®ç°çš„åŠŸèƒ½ã€‚è€Œæˆ‘ä»¬çš„ hade æ¡†æ¶å¦‚ä½•æ›´å¥½åœ°æ”¯æŒæ•°æ®åº“æ“ä½œå‘¢ï¼Ÿè¿™ä¸¤èŠ‚è¯¾æˆ‘ä»¬å°±è¦è®¨è®ºè¿™ä¸ªå†…å®¹ã€‚</p><h2>ORM</h2><p>æåˆ°æ•°æ®åº“ï¼Œå°±ä¸å¾—ä¸æORMäº†ï¼Œæœ‰çš„åŒå­¦ä¸€æ¥è§¦ Web å¼€å‘ï¼Œå°±ä¸Šæ‰‹ä½¿ç”¨ ORM äº†ï¼Œè¿™é‡Œæˆ‘ä»¬è¦æ˜ç¡®ä¸€ç‚¹ï¼šORM å¹¶ä¸ç­‰åŒäºæ•°æ®åº“æ“ä½œã€‚</p><p>æ•°æ®åº“æ“ä½œï¼Œæœ¬è´¨ä¸Šæ˜¯ä½¿ç”¨ SQL è¯­å¥å¯¹æ•°æ®åº“å‘é€å‘½ä»¤æ¥æ“ä½œæ•°æ®ã€‚è€Œ ORM æ˜¯ä¸€ç§å°†æ•°æ®åº“ä¸­çš„æ•°æ®æ˜ å°„åˆ°ä»£ç ä¸­å¯¹è±¡çš„æŠ€æœ¯ï¼Œè¿™ä¸ªæŠ€æœ¯çš„éœ€æ±‚å‡ºå‘ç‚¹å°±æ˜¯ï¼Œ<strong>ä»£ç ä¸­æœ‰ç±»ï¼Œæ•°æ®åº“ä¸­æœ‰æ•°æ®è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç±»å’Œæ•°æ®è¡¨è¿›è¡Œæ˜ å°„ï¼Œä»è€Œä½¿å¾—åœ¨ä»£ç ä¸­æ“ä½œç±»å°±ç­‰åŒäºæ“ä½œæ•°æ®åº“ä¸­çš„æ•°æ®è¡¨äº†</strong>ã€‚</p><p>ORM è¿™ä¸ªæ¦‚å¿µå‡ºç°çš„æ—¶é—´æ— ä»è€ƒç©¶äº†ï¼ŒåŸºæœ¬ä¸Šä»é¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€æƒ³å‡ºæ¥çš„æ—¶å€™å°±æœ‰è®¨è®ºäº†ã€‚ä½†æ˜¯åˆ°ç°åœ¨ï¼Œæ˜¯å¦è¦ä½¿ç”¨ ORM çš„è®¨è®ºä¹Ÿä¸€ç›´æ²¡æœ‰åœæ­¢ã€‚</p><p>ä¸æ”¯æŒä½¿ç”¨ ORM çš„é˜µè¥çš„è§‚ç‚¹åŸºæœ¬ä¸Šæ˜¯ä½¿ç”¨ ORM ä¼šå½±å“æ€§èƒ½ï¼Œä¸”ä¼šè®©ä½¿ç”¨è€…ä¸äº†è§£åº•å±‚çš„å…·ä½“æœ€ç»ˆæ‹¼æ¥å‡ºæ¥çš„SQLï¼Œå®¹æ˜“é€ æˆç”¨ä¸ä¸Šç´¢å¼•æˆ–è€…æœ€ç»ˆæ‹¼æ¥é”™è¯¯çš„æƒ…å†µã€‚è€Œæ”¯æŒä½¿ç”¨ ORM çš„é˜µè¥çš„è§‚ç‚¹ä¸»è¦æ˜¯å®ƒèƒ½åˆ‡åˆ‡å®å®åŠ é€Ÿåº”ç”¨å¼€å‘ã€‚</p><!-- [[[read_end]]] --><p>å°±æˆ‘ä¸ªäººçš„è§‚ç‚¹å’Œç»éªŒï¼Œæˆ‘è¿˜æ˜¯æ”¯æŒä½¿ç”¨ ORM çš„ã€‚æˆ‘è®¤ä¸º ORM ä¸ä»…ä»…æ˜¯ä¸€ç§æ˜ å°„æŠ€æœ¯ï¼Œä¹Ÿæ˜¯ä¸€ç§å»ºæ¨¡æ€æƒ³ã€‚<strong>å› ä¸ºæ•°æ®åº“æ˜¯å’Œä¸šåŠ¡ç´§å¯†å…³è”èµ·æ¥çš„ï¼Œå»ºç«‹æ•°æ®åº“è¡¨ç»“æ„çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å»ºç«‹äº†ä¸€ä¸ªä¸šåŠ¡æ¨¡å‹</strong>ã€‚ä½¿ç”¨ä»£ç ä¸­çš„ç±»å®šä¹‰ï¼Œæ¯”å¦‚å®šä¹‰äº†ä¸€ä¸ª User ç±»ï¼ŒåŸºæœ¬ä¸Šå°±å®šä¹‰äº†ä¸€ä¸ª User è¡¨ï¼Œè¿™æ ·ä¹Ÿæ˜¯ä¸€ä¸ªå»ºç«‹ä¸šåŠ¡æ¨¡å‹çš„è¿‡ç¨‹ã€‚</p><p>å…¶å®ä¸è®º ORM çš„è®¨è®ºå¦‚ä½•æ¿€çƒˆï¼ŒåŸºæœ¬ä¸Šå„ä¸ªè¯­è¨€éƒ½å·²ç»æœ‰äº† ORM çš„å®ç°ï¼Œæ¯”å¦‚ Java çš„ Hibernateã€PHP çš„ Doctrineã€Ruby çš„ ActiveRecordã€‚è€Œåœ¨ Golang ä¸­ï¼Œç°åœ¨æœ€æµè¡Œçš„ ORM åº“æ˜¯å›½äººçš„å¼€æºé¡¹ç›®<a href=\"https://github.com/go-gorm/gorm\">Gorm</a> ã€‚</p><p>Gorm ä½œè€… Jinzhu ç›®å‰æ˜¯å­—èŠ‚è·³åŠ¨çš„å‘˜å·¥ï¼Œä»–åœ¨ GitHub ä¸Šå¼€æºå…±äº«äº†è¯¸å¦‚ copierã€configer ç­‰å¼€æºé¡¹ç›®ï¼ŒGorm ç›®å‰ star æ•°æœ‰ 26k ä¹‹å¤šï¼Œä½¿ç”¨ MIT çš„è®¸å¯è¯åè®®ï¼Œé¡¹ç›®å¯åŠ¨äº 2013 å¹´ï¼Œç›®å‰æ˜¯ v2 ç‰ˆæœ¬ã€‚</p><p>è¿™ä¸ª <strong>v2 ç‰ˆæœ¬å¯¹åº” Gorm GitHub ä¸Š v1.20 ä»¥ä¸Šçš„ tag</strong>ï¼Œè¿™ç‚¹æˆ‘ä»¬è¦é¢å¤–æ³¨æ„ã€‚å› ä¸ºç½‘ä¸Šçš„åˆ†ææ–‡ç« å¾ˆå¤šéƒ½æ˜¯åŸºäºGorm çš„ v1 ç‰ˆæœ¬å†™çš„ï¼Œä½†Gorm çš„ v1 å’Œ v2 ç‰ˆæœ¬ç›¸å·®æ¯”è¾ƒå¤§ã€‚æ‰€ä»¥åœ¨çœ‹ Gorm æ–‡ç« çš„æ—¶å€™éœ€è¦å…ˆæ˜ç¡®ä¸‹æ˜¯ä»€ä¹ˆç‰ˆæœ¬ã€‚</p><p>æˆ‘ä»¬çš„æ¡†æ¶ä¾§é‡äºæ•´åˆï¼Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šæ‰æ›´ç¬¦åˆç°ä»£åŒ–æ¡†æ¶çš„è¦æ±‚ã€‚åŸºäºæ­¤ï¼Œ hade æ¡†æ¶å¹¶ä¸æ‰“ç®—é‡æ–°å¼€å‘ä¸€å¥— ORM æ¡†æ¶ï¼Œè€Œæ˜¯ä¼šç›´æ¥èåˆ Gorm æ¡†æ¶æˆä¸ºæˆ‘ä»¬å®¹å™¨ä¸­çš„ä¸€ä¸ªæœåŠ¡ orm serviceã€‚</p><p>ç‰ˆæœ¬é€‰æ‹©çš„æ˜¯ Gorm æˆªæ­¢ 2021/10/23 æ—¥æœ€æ–°çš„ v1.21.16 çš„ tagã€‚æ¯•ç«Ÿ Gorm æ˜¯ä¸ªæœ‰ä¸€å®šä½“é‡çš„é¡¹ç›®ï¼Œè€Œä¸”ç†è§£å®ƒçš„é‡ç‚¹éƒ¨åˆ†æºç çš„å®ç°åŸç†ï¼Œå¯¹ä½¿ç”¨è€…æ¥è¯´éå¸¸é‡è¦ï¼Œå€¼å¾—æˆ‘ä»¬å…ˆèŠ±ä¸€ç« æ¥å­¦ä¹ ç†è§£ã€‚å¦‚ä½•èåˆ Gormï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾ç»§ç»­å­¦ã€‚</p><h2>Gorm</h2><p>ä¸€ä¸ª ORM åº“ï¼Œæœ€æ ¸å¿ƒè¦äº†è§£ä¸¤ä¸ªéƒ¨åˆ†ã€‚ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ•°æ®åº“è¿æ¥ï¼Œå®ƒæ˜¯æ€ä¹ˆå’Œæ•°æ®åº“å»ºç«‹è¿æ¥çš„ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯æ•°æ®åº“æ“ä½œï¼Œå³å®ƒæ˜¯æ€ä¹ˆæ“ä½œæ•°æ®åº“çš„ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸ªæœ€ç²¾ç®€çš„ Gorm çš„ä½¿ç”¨ä¾‹å­ï¼š</p><pre><code class=\"language-go\">package main\n\nimport (\n  \"gorm.io/gorm\"\n  \"gorm.io/driver/mysql\"\n)\n\n// å®šä¹‰ä¸€ä¸ª gorm ç±»\ntype User struct {\n   ID           uint\n   Name         string\n}\n\nfunc main() {\n  // åˆ›å»º mysql è¿æ¥\n  dsn := \"xxxxxxx\"\n  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n  ...\n\n  // æ’å…¥ä¸€æ¡æ•°æ®\n  db.Create(&amp;User{Name: \"jianfengye\"})\n\n  ...\n}\n</code></pre><p>main å‡½æ•°ï¼Œå…ˆåˆ›å»ºä¸€ä¸ª MySQL è¿æ¥ï¼Œå†æ’å…¥ä¸€æ¡æ•°æ®ï¼Œè¿™ä¸ª User æ•°æ®æ˜¯é€šè¿‡äº‹å…ˆå®šä¹‰å¥½çš„ User ç»“æ„æ¥è¿›è¡Œè®¾ç½®çš„ã€‚<strong>å…¶ä¸­çš„ gorm.Open å°±æ˜¯ä¸€ä¸ªå¿«é€Ÿè¿æ¥æ•°æ®åº“çš„æ¥å£ï¼Œè€Œåç»­çš„ Create æ˜¯å¦‚ä½•æ“ä½œæ•°æ®åº“çš„æ¥å£</strong>ã€‚</p><p>æˆ‘ä»¬ä»Šå¤©çš„ä»»åŠ¡å°±æ˜¯ç†è§£è¿™å‡ è¡Œä»£ç çš„å®ç°åŸç†ï¼Œåé¢ä¼šä¸æ–­æ‹¿è¿™ä¸ªä¾‹å­ä¸¾ä¾‹ã€‚</p><h2>æ•°æ®ç»“æ„</h2><p>å…ˆæŠŠé‡ç‚¹æ”¾åœ¨ç†è§£è¿™ä¸ª Open å‡½æ•°ä¸Šï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°åŒ…å«äº† Gorm ä¸­å…³é”®çš„å‡ ä¸ªå¯¹è±¡ï¼ŒæŠŠè¿™äº›å…³é”®æ•°æ®ç»“æ„ä¸€ä¸€ç†è§£é€ï¼Œå†è·Ÿè¸ªå…·ä½“çš„æºç èƒ½äº‹åŠåŠŸå€ã€‚å¦å¤–ä¹Ÿæ¨èä½ è¾¹çœ‹è¾¹è‡ªå·±ç”»å‡ºè¿™å‡ ä¸ªå…³é”®å‚æ•°çš„å…³ç³»ï¼Œéå¸¸æœ‰åŠ©äºç†è§£å’Œè®°å¿†ï¼Œæ¯ä¸ªå‚æ•°è®²å®Œä¹‹åæˆ‘ä¹Ÿä¼šå±•ç¤ºä¸€ä¸‹æˆ‘ç”»çš„åˆ†æå›¾ä¾›ä½ å‚è€ƒã€‚</p><p>æ¥çœ‹å®ƒçš„æºç å®šä¹‰ï¼š</p><pre><code class=\"language-go\">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥\nfunc Open(dialector Dialector, opts ...Option) (db *DB, err error)\n</code></pre><p>è¿™ä¸ªåˆå§‹åŒ–æ•°æ®åº“é“¾æ¥çš„Openå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°dialectorã€optsï¼Œå’Œä¸¤ä¸ªè¿”å›å€¼gorm.DBã€errorã€‚æˆ‘ä»¬å…ˆç†è§£ä¸‹è¿™å‡ ä¸ªå‚æ•°çš„æ„ä¹‰ã€‚</p><h2>Dialector</h2><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Dialectorï¼Œè¿™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒä»£è¡¨æ•°æ®åº“è¿æ¥å™¨ã€‚è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªé¢å‘æ¥å£ç¼–ç¨‹çš„æ€æƒ³ï¼Œè¿æ¥å™¨ç»“æ„ Dialector æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»£è¡¨å¦‚æœä½ è¦ä½¿ç”¨ Gorm æ¥è¿æ¥ä½ çš„æ•°æ®åº“ï¼Œé‚£ä¹ˆï¼Œåªéœ€è¦å®ç°è¿™ä¸ªæ¥å£å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ï¼Œå°±å¯ä»¥ä½¿ç”¨ Gorm æ¥æ“ä½œä½ çš„æ•°æ®åº“äº†ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™ä¸ªæ¥å£ Dialecotor ä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ï¼Œéƒ½æ˜¯åœ¨åç»­çš„æŸ¥è¯¢ã€æ›´æ–°ã€æ•°æ®åº“è¿ç§»ç­‰æ“ä½œä¸­ä¼šä½¿ç”¨åˆ°çš„ã€‚å…·ä½“æ¯ä¸ªæ–¹æ³•åœ¨å“ªé‡Œä½¿ç”¨åˆ°çš„ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£å¯ä»¥è·Ÿè¸ªä¸‹å»ï¼Œå¦‚æœä½ ä¸æ„Ÿå…´è¶£ä¹Ÿæ— æ‰€è°“ï¼Œåªéœ€è¦è®°å¾—åœ¨åç»­æŸä¸ª gorm æ¥å£çš„å…·ä½“å®ç°ä¸­ä¼šç”¨åˆ°å°±è¡Œã€‚</p><pre><code class=\"language-go\">// Dialector GORM database dialector\ntype Dialector interface {\n   Name() string // è¿æ¥å™¨åç§°\n   Initialize(*DB) error // è¿æ¥å™¨åˆå§‹åŒ–è¿æ¥æ–¹æ³•\n   Migrator(db *DB) Migrator // æ•°æ®åº“è¿ç§»æ–¹æ³•\n   DataTypeOf(*schema.Field) string // ç±»ä¸­æ¯ä¸ªå­—æ®µçš„ç±»å‹å¯¹åº”åˆ° sql è¯­å¥\n   DefaultValueOf(*schema.Field) clause.Expression // æ¯ä¸ªå­—æ®µçš„é»˜è®¤å€¼å¯¹åº”åˆ° sql è¯­å¥\n   BindVarTo(writer clause.Writer, stmt *Statement, v interface{}) // ä½¿ç”¨é¢„ç¼–è¯‘æ¨¡å¼çš„æ—¶å€™ä½¿ç”¨\n   QuoteTo(clause.Writer, string) // å°†ç±»ä¸­çš„æ³¨é‡Šå¯¹åº”åˆ° sql è¯­å¥ä¸­\n   Explain(sql string, vars ...interface{}) string // å°†æœ‰å ä½ç¬¦çš„ sql è§£æä¸ºæ— å ä½ç¬¦ sqlï¼Œå¸¸ç”¨äºæ—¥å¿—æ‰“å°ç­‰\n}\n</code></pre><p>ä¸åŒçš„æ•°æ®åº“æœ‰ä¸åŒçš„ Dialector å®ç°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œé©±åŠ¨â€ã€‚æ¯ä¸ªæ•°æ®åº“çš„é©±åŠ¨ï¼Œéƒ½æœ‰ä¸€ä¸ª git åœ°å€è¿›è¡Œå­˜æ”¾ã€‚ç›®å‰ gorm å®˜æ–¹æ”¯æŒäº”ç§æ•°æ®åº“é©±åŠ¨ï¼š</p><ul>\n<li>MySQL çš„ Gorm é©±åŠ¨åœ°å€ä¸º<a href=\"http://gorm.io/driver/mysql\"> </a>gorm.io/driver/mysql</li>\n<li>Postgres çš„ Gorm é©±åŠ¨åœ°å€ä¸º gorm.io/driver/postgres</li>\n<li>SQLite çš„ gorm é©±åŠ¨åœ°å€ä¸º gorm.io/driver/sqlite</li>\n<li>SQL Server çš„ gorm é©±åŠ¨åœ°å€ä¸º gorm.io/driver/sqlserver</li>\n<li>ClickHouse çš„ gorm é©±åŠ¨åœ°å€ä¸º gorm.io/driver/clickhouse</li>\n</ul><p><strong>å¦‚æœè¦åˆ›å»ºå¯¹åº”æ•°æ®åº“çš„è¿æ¥ï¼Œè¦å…ˆå¼•å…¥å¯¹åº”çš„é©±åŠ¨</strong>ã€‚è€Œåœ¨å¯¹åº”çš„é©±åŠ¨åº“ä¸­éƒ½æœ‰ä¸€ä¸ªçº¦å®šçš„ Open æ–¹æ³•ï¼Œæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“é©±åŠ¨ã€‚æ¯”å¦‚è¦åˆ›å»º MySQL çš„è¿æ¥ï¼Œä½¿ç”¨ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-go\">import (\n  \"gorm.io/driver/mysql\"\n  \"gorm.io/gorm\"\n)\n\n// åˆ›å»ºè¿æ¥\ndsn := \"gorm:gorm@tcp(localhost:9910)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local\"\ndb, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œæœ‰ä¸ª mysql.Openï¼Œå°±æ˜¯åˆ›å»ºMySQL çš„ Gorm é©±åŠ¨ç”¨çš„ã€‚è€Œè¿™ä¸ª Open å‡½æ•°åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•° DSNï¼Œè¿™ä¸ªå‚æ•°å¯èƒ½æœ‰çš„åŒå­¦è¿˜ä¸æ˜¯å¾ˆäº†è§£ï¼Œæˆ‘ä»¬ä¸€èµ·ç ”ç©¶ä¸‹ã€‚</p><h4>DSN</h4><p>DSN å…¨ç§°å« Data Source Nameï¼Œæ•°æ®åº“çš„æºåç§°ã€‚</p><p>DSN å®šä¹‰äº†ä¸€ä¸ªæ•°æ®åº“çš„è¿æ¥æ–¹å¼åŠä¿¡æ¯ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ã€æ•°æ®åº“ IPã€æ•°æ®åº“ç«¯å£ã€æ•°æ®åº“å­—ç¬¦é›†ã€æ•°æ®åº“æ—¶åŒºç­‰ä¿¡æ¯ã€‚å¯ä»¥è¯´<strong>ä¸€ä¸ª DSN å°±æ˜¯ä¸€ä¸ªæ•°æ®æºçš„æè¿°</strong>ã€‚ä½†æ˜¯ DSN å¹¶æ²¡æœ‰æ˜ç¡®çš„å®˜æ–¹æ–‡æ¡£è¦æ±‚å…¶æ ¼å¼ï¼Œæ¯ä¸ªè¯­è¨€ã€æ¯ä¸ªå¹³å°éƒ½å¯ä»¥è‡ªå·±å®šä¹‰ DSN æ ¼å¼ï¼Œåªè¦å®šä¹‰å’Œè§£æèƒ½å¯¹å¾—ä¸Šå°±è¡Œã€‚</p><p>åœ¨ç¤¾åŒºä¸­ï¼Œå¤§å®¶æ™®éä¼šæŒ‰ç…§ä»¥ä¸‹è¿™ç§æ ¼å¼æ¥è¿›è¡Œå®šä¹‰ï¼š</p><pre><code class=\"language-plain\">scheme://username:password@host:port/dbname?param1=value1&amp;param2=value2&amp;...\n</code></pre><p>æ¯”å¦‚é€šè¿‡ Unix çš„ socket å¥æŸ„è¿æ¥æœ¬æœº MySQLï¼š</p><pre><code class=\"language-plain\">mysql://user@unix(/path/to/socket)/dbname\n</code></pre><p>é€šè¿‡ TCP è¿æ¥è¿œç«¯ postgresï¼š</p><pre><code class=\"language-plain\">pgsql://user:pass@tcp(localhost:5555)/dbname\n</code></pre><p>DSNåœ¨gormä¸­çš„ä½¿ç”¨å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªdsnç»“åˆå…·ä½“çš„é©±åŠ¨æ¥ç”ŸæˆOpenå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ•°æ®åº“è¿æ¥å™¨ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/64/e0/6484f9f91a60120d485a0ea2020fb7e0.jpg?wh=2185x1256\" alt=\"\"></p><p>åœ¨å…·ä½“ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥ç›´æ¥æ‰§è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæ¥æ‹¼æ¥å‡ºä¸€ä¸ª DSNï¼Œä½†æ˜¯æˆ‘ä»¬æ›´å¸Œæœ›èƒ½<strong>é€šè¿‡å®šä¹‰ä¸€ä¸ª Golang çš„æ•°æ®ç»“æ„è‡ªåŠ¨æ‹¼æ¥å‡ºä¸€ä¸ª DSNï¼Œæˆ–è€…æ˜¯ä»ä¸€ä¸ª DSN å­—ç¬¦ä¸²ååºåˆ—åŒ–ç”Ÿæˆè¿™ä¸ªæ•°æ®ç»“æ„</strong>ã€‚</p><p>åœ¨ Golang ä¸­æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ github.com/go-sql-driver/mysql å°±æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ã€‚è¿™ä¸ªåº“ç”¨æ¥å¯¹ Go ä¸­çš„ SQL æä¾› MySQL é©±åŠ¨ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€ä¸ª Config ç»“æ„ï¼Œèƒ½æ˜ å°„åˆ° DSN å­—ç¬¦ä¸²ã€‚Config ç»“æ„ä¸­ä¸€äº›æ¯”è¾ƒé‡è¦çš„å­—æ®µè¯´æ˜ï¼Œæˆ‘å†™åœ¨æ³¨é‡Šä¸­äº†ï¼š</p><pre><code class=\"language-go\">type Config struct {\n   User             string            // ç”¨æˆ·å\n   Passwd           string            // å¯†ç  (requires User)\n   Net              string            // ç½‘ç»œç±»å‹\n   Addr             string            // åœ°å€ (requires Net)\n   DBName           string            // æ•°æ®åº“å\n   Params           map[string]string // å…¶ä»–è¿æ¥å‚æ•°\n   Collation        string            // å­—ç¬¦é›†\n   Loc              *time.Location    // æ—¶åŒº\n   MaxAllowedPacket int               // æœ€å¤§åŒ…å¤§å°\n   ServerPubKey     string            // è¿æ¥å…¬é’¥åç§°\n   pubKey           *rsa.PublicKey    // è¿æ¥å…¬é’¥ key\n   TLSConfig        string            // TLS çš„é…ç½®åç§°\n   tls              *tls.Config       // TLS çš„é…ç½®é¡¹\n   Timeout          time.Duration     // è¿æ¥è¶…æ—¶\n   ReadTimeout      time.Duration     // è¯»è¶…æ—¶\n   WriteTimeout     time.Duration     // å†™è¶…æ—¶\n\n   ...\n   CheckConnLiveness       bool // åœ¨ä½¿ç”¨è¿æ¥å‰ç¡®è®¤è¿æ¥å¯ç”¨\n   ...\n   ParseTime               bool // æ˜¯å¦è§£ææ—¶é—´æ ¼å¼\n   ...\n}\n</code></pre><p>ä» DSN åˆ°è¿™ä¸ª Config ç»“æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ github.com/go-sql-driver/mysql çš„ <a href=\"https://github.com/go-sql-driver/mysql/blob/master/dsn.go\">ParseDSN</a> ï¼Œè€Œä» Config ç»“æ„åˆ° DSN æˆ‘ä»¬ä½¿ç”¨ <a href=\"https://github.com/go-sql-driver/mysql/blob/master/dsn.go\">FormatDSN</a> æ–¹æ³•ï¼š</p><pre><code class=\"language-go\">// è§£æ dsn\nfunc ParseDSN(dsn string) (cfg *Config, err error) \n\n// ç”Ÿæˆ dsn\nfunc (cfg *Config) FormatDSN() string\n</code></pre><p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å…ˆè®°ä¸‹ï¼Œä¸‹èŠ‚è¯¾ä¼šç”¨åˆ°ã€‚</p><h2>Option</h2><p>ç¬¬ä¸€ä¸ªåˆå§‹åŒ–æ•°æ®åº“çš„å‚æ•° dialector ä»¥åŠä¹‹å‰å¿…è¦çš„é©±åŠ¨å¼•å…¥ç›¸å…³å‚æ•°DSNï¼Œå°±è®²è§£åˆ°è¿™é‡Œã€‚æˆ‘ä»¬å›å¤´ç»§ç»­çœ‹ Open å‡½æ•°ï¼š</p><pre><code class=\"language-go\">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥\nfunc Open(dialector Dialector, opts ...Option) (db *DB, err error)\n</code></pre><p>ç¬¬äºŒä¸ªå‚æ•° optsæ˜¯ Option çš„å¯å˜å‚æ•°ï¼Œè€Œè¿™ä¸ª Option æ˜¯ä¸€ä¸ªå®ç°äº† Apply å’Œ AfterInitialize çš„æ¥å£ï¼š</p><pre><code class=\"language-go\">// Option æ¥å£\ntype Option interface {\n   Apply(*Config) error\n   AfterInitialize(*DB) error\n}\n</code></pre><p>è¿™ç§å¯å˜å‚æ•°å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹ Open çš„æºç ï¼š</p><pre><code class=\"language-go\">// Open åˆå§‹åŒ– DB çš„ Session\nfunc Open(dialector Dialector, opts ...Option) (db *DB, err error) {\n   config := &amp;Config{}\n\n   ...\n\n   for _, opt := range opts {\n      if opt != nil {\n         // å…ˆè°ƒç”¨ Apply åˆå§‹åŒ– Config\n         if err := opt.Apply(config); err != nil {\n            return nil, err\n         }\n         // Open æœ€åç»“æŸåè°ƒç”¨ AfterInitialize\n         defer func(opt Option) {\n            if errr := opt.AfterInitialize(db); errr != nil {\n               err = errr\n            }\n         }(opt)\n      }\n   }\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹æ¯ä¸€ä¸ªoptionï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨å®ƒçš„Applyæ–¹æ³•æ¥å¯¹æ•°æ®åº“çš„é…ç½®configè¿›è¡Œä¿®æ”¹ã€‚Option çš„è¿™ç§ç¼–ç¨‹æ–¹å¼å¸¸ç”¨åœ¨åˆå§‹åŒ–ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ç»“æ„é‡Œé¢ã€‚</p><p>æ¯”å¦‚è¿™é‡Œåœ¨ Gorm ä¸­ï¼Œè¦åˆå§‹åŒ–ä¸€ä¸ª Gorm çš„æ„é€ é…ç½® gorm.Configï¼Œè€Œè¿™ä¸ª Config ç»“æ„æœ‰éå¸¸å¤šçš„é…ç½®é¡¹ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨åˆ›å»ºåˆå§‹åŒ–çš„æ—¶å€™ï¼Œèƒ½å¯¹è¿™ä¸ªé…ç½®è¿›è¡Œè°ƒæ•´ã€‚æ‰€ä»¥å°±å¯ä»¥åœ¨ Option æ–¹æ³•ä¸­å†å®šä¹‰ä¸€ä¸ª Apply æ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ gorm.Config æŒ‡é’ˆï¼š</p><pre><code class=\"language-plain\">func (c *Config) Apply(config *Config) error\n</code></pre><p>è¿™æ ·ï¼Œå¯ä»¥éå†æ‰€æœ‰çš„ Optionï¼ŒæŒ¨ä¸ªè°ƒç”¨å®ƒä»¬çš„ Apply æ–¹æ³•å¯¹ Config è¿›è¡Œè®¾ç½®ï¼Œæœ€ç»ˆæˆ‘ä»¬è·å–çš„å°±æ˜¯ç»è¿‡æ‰€æœ‰ Option å¤„ç†åçš„ Configã€‚</p><p>è¿™ç§ Option çš„ç¼–ç¨‹æ–¹æ³•åœ¨ Golang ä¸­ååˆ†å¸¸ç”¨ï¼Œè¦å¥½å¥½æŒæ¡ï¼Œä¸‹ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¹Ÿä¼šç”¨è¿™ç§æ–¹å¼ä¸º hade çš„ ORM æœåŠ¡æ¥æ³¨å†Œå‚æ•°ã€‚</p><p>Gorm è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå·§å¦™çš„è®¾è®¡ï¼ŒConfig ç»“æ„æœ¬èº«ä¹Ÿå®ç°äº† Option æ¥å£ã€‚æŒ‰ç…§è¿™ä¸ªè®¾è®¡å®ç°ä¹‹åï¼Œä½ ä¼šå‘ç°ï¼ŒConfig æœ¬èº«ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ª Option åœ¨ Open çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­å‡ºç°ã€‚</p><pre><code class=\"language-go\">func (c *Config) Apply(config *Config) error {\n   if config != c {\n      *config = *c\n   }\n   return nil\n}\n\nfunc (c *Config) AfterInitialize(db *DB) error {\n   if db != nil {\n      for _, plugin := range c.Plugins {\n         if err := plugin.Initialize(db); err != nil {\n            return err\n         }\n      }\n   }\n   return nil\n}\n</code></pre><p>è®²åˆ°è¿™é‡Œç›¸ä¿¡ä½ èƒ½ç”»å‡ºç¬¬äºŒä¸ªå‚æ•°çš„è¦ç‚¹äº†ï¼ŒGormå®ç°çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯gorm.Configï¼Œä¹‹æ‰€ä»¥å®ƒå¯ä»¥åŒ¹é…Openå‡½æ•°å®šä¹‰çš„Optionçš„å‚æ•°çš„åŸå› æ˜¯Configç»“æ„æœ¬èº«ä¹Ÿå®ç°äº†Optionæ¥å£ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/de/76/deda009d08f4bf80e384f85dc0d9ce76.jpg?wh=2185x1256\" alt=\"\"></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å°±ç†è§£äº†Openå‡½æ•°åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å’Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¦‚ä½•å¯¹åº”å‡½æ•°å®šä¹‰ä¸¤ä¸ªå‚æ•°çš„äº†ã€‚</p><p>æ‰€ä»¥ Gorm å®˜æ–¹è¿æ¥<a href=\"https://gorm.io/zh_CN/docs/connecting_to_the_database.html\">MySQLçš„ç¤ºä¾‹</a>å°±å¾ˆå¥½ç†è§£äº†ï¼Œçœ‹æ³¨é‡Šï¼š</p><pre><code class=\"language-go\">import (\n  \"gorm.io/driver/mysql\"\n  \"gorm.io/gorm\"\n)\nfunc main() {\n  // å‚è€ƒ https://github.com/go-sql-driver/mysql#dsn-data-source-name è·å–è¯¦æƒ…\n  dsn := \"user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"\n  // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ dialector\n  // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ optionï¼Œä½†æ˜¯ç”±äº gorm.Config å®ç°äº† optionï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆä½¿ç”¨\n  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n}\n</code></pre><h2>gorm.DB</h2><p>ä¸¤ä¸ªä¼ å…¥å‚æ•°è®²å®Œäº†ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹Open çš„è¿”å›ç»“æ„ï¼Œé™¤äº†å¸¸è§„çš„ error å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª gorm.DB çš„ç»“æ„æŒ‡é’ˆï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">type DB struct {\n\t*Config\n\tError&nbsp; &nbsp; &nbsp; &nbsp; error\n\tRowsAffected int64\n\tStatement&nbsp; &nbsp; *Statement\n\t// Has unexported fields.\n}\n</code></pre><p>å®ƒå…·æœ‰ä¸°å¯Œçš„æ“ä½œæ•°æ®åº“çš„æ–¹æ³•ï¼Œæ¯”å¦‚å¢åŠ æ•°æ®çš„ Create æ–¹æ³•ã€æ›´æ–°æ•°æ®çš„ Update æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬ç ”ç©¶ä¸‹ gorm.DB çš„ç»“æ„ï¼Œå®ƒåµŒå¥—äº†ä¸€å±‚ gorm.Config ç»“æ„ï¼Œé‡Œé¢æœ‰å‡ ä¸ªå…³é”®å­—æ®µï¼š</p><pre><code class=\"language-go\">// Config GORM config\ntype Config struct {\n   ...\n   // gorm çš„æ—¥å¿—è¾“å‡º\n   Logger logger.Interface\n   ...\n   \n   // db çš„å…·ä½“è¿æ¥\n   ConnPool ConnPool\n   // db é©±åŠ¨å™¨\n   Dialector\n   ...\n\n   callbacks  *callbacks  // å›è°ƒæ–¹æ³•\n   ...\n}\n</code></pre><p>å…¶ä¸­çš„ Logger ã€ ConnPool å’Œ Callbackå­—æ®µï¼Œå€¼å¾—è¯¦ç»†ç ”ç©¶ä¸€ä¸‹ã€‚</p><h3>Logger</h3><p>æˆ‘ä»¬ä» Open çœ‹åˆ°äº†ï¼Œä¸€ä¸ª gorm.DB ç»“æ„å°±ä»£è¡¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œè€Œè¿™ä¸ªæ•°æ®åº“è¿æ¥çš„æ‰€æœ‰æ—¥å¿—æ“ä½œè¾“å‡ºåœ¨å“ªé‡Œå‘¢ï¼Ÿå°±æ˜¯é€šè¿‡è¿™ä¸ª Logger å­—æ®µé…ç½®çš„ã€‚</p><p>Logger å­—æ®µæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè¡¨ç¤ºå¦‚æœæœ‰ä¸€ä¸ªå®ç°äº† logger.Interface æ¥å£çš„æ—¥å¿—è¾“å‡ºç±»ï¼Œæˆ‘å°±èƒ½è®©è¿™ä¸ª DB çš„æ‰€æœ‰æ•°æ®åº“æ“ä½œçš„æ—¥å¿—ï¼Œéƒ½è¾“å‡ºåˆ°è¿™ä¸ªç±»ä¸­ã€‚</p><pre><code class=\"language-go\">// Interface logger interface\ntype Interface interface {\n   LogMode(LogLevel) Interface\n   Info(context.Context, string, ...interface{})\n   Warn(context.Context, string, ...interface{})\n   Error(context.Context, string, ...interface{})\n   Trace(ctx context.Context, begin time.Time, fc func() (sql string, rowsAffected int64), err error)\n}\n</code></pre><p>Gorm ä½¿ç”¨ Logger æ¥å£çš„æ–¹æ³•ï¼Œå’Œæˆ‘ä»¬ hade æ¡†æ¶å®šä¹‰ Logger æœåŠ¡çš„æ–¹æ³•å¦‚å‡ºä¸€è¾™ï¼Œå®ƒ<strong>ä¸å®šä¹‰å…·ä½“çš„å®ç°ç±»ï¼Œè€Œæ˜¯å®šä¹‰äº†å…·ä½“çš„æ¥å£</strong>ã€‚æ‰€ä»¥ä¸‹ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°† Gorm èåˆè¿›å…¥ hade æ¡†æ¶çš„æ—¶å€™ï¼Œè¦åšçš„äº‹æƒ…å°±æ˜¯å°è£…ä¸€ä¸ªå®ç°äº† Gorm çš„ logger.Interface æ¥å£çš„å®ç°ç±»ï¼Œè€Œè¿™ä¸ªå®ç°ç±»çš„å…·ä½“å®ç°æ–¹æ³•ï¼Œä½¿ç”¨ hade æ¡†æ¶çš„æ—¥å¿—æœåŠ¡ç±»æ¥å®ç°ã€‚</p><h3>ConnPool</h3><p>ConnPool ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œå®ƒä»£è¡¨æ•°æ®åº“çš„çœŸå®è¿æ¥æ‰€åœ¨çš„è¿æ¥æ± ã€‚è¿™ä¸ªæ¥å£çš„å®šä¹‰ï¼Œæˆ‘è®¤ä¸ºæ˜¯Gorm ä¸­æœ€ç²¾å¦™çš„ä¸€ä¸ªåœ°æ–¹äº†ï¼š</p><pre><code class=\"language-go\">// ConnPool db conns pool interface\ntype ConnPool interface {\n   PrepareContext(ctx context.Context, query string) (*sql.Stmt, error)\n   ExecContext(ctx context.Context, query string, args ...interface{}) (sql.Result, error)\n   QueryContext(ctx context.Context, query string, args ...interface{}) (*sql.Rows, error)\n   QueryRowContext(ctx context.Context, query string, args ...interface{}) *sql.Row\n}\n</code></pre><p>è¿™ä¸ªæ¥å£å®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼Œä½†å®ƒä»¬å¹¶ä¸æ˜¯éšä¾¿å®šä¹‰çš„ï¼Œè€Œæ˜¯æ ¹æ® Golang æ ‡å‡†åº“çš„ database/sql çš„ Conn ç»“æ„æ¥å®šä¹‰çš„ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼ŒGolang çš„æ ‡å‡†åº“ database/sql å…¶å®å®šä¹‰äº†ä¸€å¥—æ•°æ®åº“è¿æ¥è§„èŒƒã€‚å®˜æ–¹çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ï¼Œæ•°æ®åº“çš„ç§ç±»éå¸¸å¤šï¼Œæˆ‘ä¸å¯èƒ½å¯¹æ¯ä¸€ä¸ªæ•°æ®åº“éƒ½å®ç°ä¸€å¥—å®šåˆ¶åŒ–çš„ç±»åº“ï¼Œæ‰€ä»¥æˆ‘å®šä¹‰ä¸€å¥—åŸºæœ¬æ•°æ®ç»“æ„å’Œæ–¹æ³•ï¼Œå¹¶ä¸”æä¾›æ¯ä¸ªæ•°æ®åº“éœ€è¦å®ç°çš„é©±åŠ¨æ¥å£ã€‚<strong>ä½¿ç”¨è€…åªéœ€è¦å®ç°é©±åŠ¨æ¥å£ï¼Œå°±èƒ½ä½¿ç”¨è¿™å¥—åŸºæœ¬æ•°æ®ç»“æ„å’Œæ–¹æ³•äº†</strong>ã€‚</p><p>æ˜¯ä¸æ˜¯å’Œå‰é¢è¯´çš„ Gorm çš„é©±åŠ¨é€»è¾‘ä¸€æ ·ï¼Ÿæ˜¯çš„ã€‚Golang ä¸­æ‰€æœ‰çš„ ORM åº“ï¼Œåº•å±‚éƒ½æ˜¯åŸºäºæ ‡å‡†åº“çš„ database/sql æ¥å®ç°æ•°æ®åº“çš„è¿æ¥å’ŒåŸºæœ¬æ“ä½œã€‚åªæ˜¯åœ¨å…·ä½“æ“ä½œä¸Šï¼Œä¼šå°è£…ä¸€å±‚é€»è¾‘ï¼Œå½“ä½¿ç”¨ä¸åŒé©±åŠ¨æ¥å£çš„æ—¶å€™ï¼Œå®ç°ä¸ä¸€æ ·çš„æ¥å£æ“ä½œã€‚</p><p>è¿™é‡Œçš„ ConnPool å°±æ˜¯ Gorm å¯¹ database/sql çš„æ•°æ®ç»“æ„çš„å°è£…ã€‚æ¢å¥è¯è¯´ï¼Œå¼€å¤´çš„ Gorm ä½¿ç”¨ä¾‹å­ï¼Œåœ¨åº•å±‚ database/sql çš„ç®€è¦å®ç°å¤§è‡´å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">package main\n\nimport (\n\t\"database/sql\"\n)\n\nfunc main() {\n\t\n\tdsn := \"xxxx\"\n\t...\n\tdb, err = sql.Open(\"mysql\", *dsn)\n\t...\n    \n    result, err := db.ExecContext(ctx, \"INSERT INTO user (name) values ('jianfengye')\")\n    ...\n}\n</code></pre><p>è¿™é‡Œ sql.Open åˆ›å»ºçš„ sql.DB ç»“æ„ï¼Œå°±åŒ…å« ConnPool ä¸­å®šä¹‰çš„å››ä¸ªæ¥å£ï¼šPrepareContextã€ExecContextã€QueryContextã€QueryRowContextã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š<strong>database/sql çš„ sql.DB ç»“æ„å®ç°äº† Gorm åº“çš„ ConnPool æ¥å£</strong>ã€‚</p><p>è€Œå®é™…ä¸Šï¼Œdatabase/sql é‡Œé¢çš„ sql.DB ç»“æ„å°±æ˜¯ä¸€ä¸ªè¿æ¥æ± ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å››ä¸ªæ–¹æ³•è®¾ç½®è¿æ¥æ± çš„ä¸åŒå±æ€§ï¼š</p><pre><code class=\"language-go\">// è®¾ç½®è¿æ¥çš„æœ€å¤§ç©ºé—²æ—¶é•¿\nfunc (db *DB) SetConnMaxIdleTime(d time.Duration)\n// è®¾ç½®è¿æ¥çš„æœ€å¤§ç”Ÿå‘½æ—¶é•¿\nfunc (db *DB) SetConnMaxLifetime(d time.Duration)\n// è®¾ç½®æœ€å¤§ç©ºé—²è¿æ¥æ•°\nfunc (db *DB) SetMaxIdleConns(n int)\n// è®¾ç½®æœ€å¤§æ‰“å¼€è¿æ¥æ•°\nfunc (db *DB) SetMaxOpenConns(n int)\n</code></pre><p>æ‰€ä»¥ gorm.DB é‡Œé¢çš„ ConnPool å®é™…ä¸Šå­˜æ”¾çš„å°±æ˜¯ database/sql çš„ sql.DB ç»“æ„ã€‚</p><h3>callbacks</h3><p>æœ€åçœ‹ gorm.DB é‡Œé¢çš„ callbacks å­—æ®µï¼Œå®ƒå­˜æ”¾çš„æ˜¯æ‰€æœ‰å…·ä½“å‡½æ•°çš„è°ƒç”¨æ–¹æ³•ã€‚callback æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ç»“æ„ä¹Ÿæ˜¯å«åšåŒåçš„ callbacksï¼š</p><pre><code class=\"language-go\">// callbacks gorm callbacks manager\ntype callbacks struct {\n   processors map[string]*processor\n}\n</code></pre><p>å®ƒé‡Œé¢ä½¿ç”¨çš„ map åŒ…å«å¤šä¸ª processorã€‚ä¸€ä¸ª processor å°±æ˜¯ä¸€ç§æ“ä½œçš„å¤„ç†å™¨ã€‚processer çš„ç»“æ„å®šä¹‰ä¸ºï¼š</p><pre><code class=\"language-go\">type processor struct {\n   db        *DB // å¯¹åº”çš„ gorm.DB\n   Clauses   []string  // å¤„ç†å™¨å¯¹åº”çš„ sql ç‰‡æ®µ\n   fns       []func(*DB) // è¿™ä¸ªå¤„ç†å™¨å¯¹åº”çš„å¤„ç†å‡½æ•°\n   callbacks []*callback // è¿™ä¸ªå¤„ç†å™¨å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼Œç”Ÿæˆ fns\n}\n</code></pre><p>å¼€å¤´çš„é‚£ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è°ƒç”¨äº† gorm.DB çš„ Create æ–¹æ³•ï¼Œå®ƒä¼šå» gorm.DB çš„ callbacks ä¸­çš„ processors é‡Œï¼Œå¯»æ‰¾ key ä¸ºâ€œcreateâ€çš„å¤„ç†å™¨ processorã€‚ç„¶åé€ä¸ªè°ƒç”¨å¤„ç†å™¨ä¸­è®¾ç½®å¥½çš„ fnsã€‚ä¸‹é¢åˆ†ææºç çš„æ—¶å€™ä¹Ÿä¼šçœ‹åˆ°å…·ä½“çš„å®ç°é€»è¾‘ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/59/9c/591e738e8aa8af160fac58fd44d8639c.jpg?wh=2185x1256\" alt=\"\"></p><h2>æºç </h2><p>ç°åœ¨ç†è§£äº† Gorm åœ¨åˆ›å»ºè¿æ¥è¿‡ç¨‹ä¸­æ¶‰åŠçš„å‡ ä¸ªå…³é”®å¯¹è±¡ï¼Œæˆ‘ä»¬å°±å†ä»æºç å¼€å§‹æ¢³ç†ä¸€ä¸‹ Gorm çš„æ ¸å¿ƒé€»è¾‘ï¼Œç†è§£ä¸‹ Gorm æ˜¯æ€ä¹ˆä½¿ç”¨ Open åˆ›å»ºæ•°æ®åº“è¿æ¥ã€æ€ä¹ˆä½¿ç”¨åˆ›å»ºçš„æ•°æ®åº“è¿æ¥çš„ Create æ–¹æ³•æ¥åˆ›å»ºä¸€æ¡æ•°æ®çš„ã€‚å†æŠŠå¼€å¤´å®˜ç½‘çš„ä¾‹å­æ‹¿å‡ºæ¥ã€‚</p><pre><code class=\"language-go\">package main\n\nimport (\n  \"gorm.io/gorm\"\n  \"gorm.io/driver/mysql\"\n)\n\ntype Product struct {\n  gorm.Model\n  Code  string\n  Price uint\n}\n\nfunc main() {\n  dsn := \"xxxxxxx\"\n  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n  if err != nil {\n    panic(\"failed to connect database\")\n  }\n\n  ...\n\n  // Create\n  db.Create(&amp;Product{Code: \"D42\", Price: 100})\n\n  ...\n}\n</code></pre><p>ç”¨ç¬¬ä¸€èŠ‚è¯¾æ•™çš„æ€ç»´å¯¼å›¾çš„æ–¹å¼æ¥åˆ†æè¿™ä¸ª Gorm çš„ä¸»æµç¨‹ï¼Œä¸»è¦å°±æ˜¯ gorm.Open å’Œ db.Create ä¸¤ä¸ªæ–¹æ³•ã€‚</p><h3>gorm.Open</h3><p>é¦–å…ˆæ˜¯ gorm.Openï¼š</p><pre><code class=\"language-go\">  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})\n</code></pre><p>æˆ‘ä»¬å°†å‡½æ•°æºç åˆ†ä¸ºå››ä¸ªå¤§æ­¥ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/a9/cf/a9afa90a5dba63aa3f2c341c47517ecf.png?wh=1356x1364\" alt=\"\"></p><p>ç¬¬ä¸€å¤§æ­¥ï¼Œåˆå§‹åŒ– gorm.Config ç»“æ„ã€‚é€šè¿‡ä½¿ç”¨å‚æ•°ä¸­çš„ Option å¯å˜å‚æ•°çš„ Apply æ¥å£ï¼Œå¯¹æœ€ç»ˆçš„é…ç½®ç»“æ„ gorm.Configè¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼Œå…¶ä¸­åŒ…æ‹¬ä¿®æ”¹è¾“å‡ºçš„ Logger ç»“æ„ã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œåˆå§‹åŒ– gorm.DB ç»“æ„ï¼š</p><pre><code class=\"language-plain\">db = &amp;DB{Config: config, clone: 1}\n</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œåˆå§‹åŒ– gorm.DB çš„ callbacksã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/f4/4a/f482ff99aa62eb3cd3991867d967f74a.png?wh=1920x814\" alt=\"\"></p><p>è¿™é‡Œæˆ‘ä»¬åªæ‹†è§£äº†è¿™ä¸ªä¾‹å­çš„ create å‡½æ•°ç›¸å…³çš„ callbackã€‚æ ¸å¿ƒçš„å…³é”®å‡½æ•°åœ¨ Gorm åº“ callback.go çš„ RegisterDefaultCallbacks æ–¹æ³•ã€‚æ¯”å¦‚ä¸‹åˆ—çš„ä»£ç ï¼Œå°±æ˜¯åˆ›å»º create ç›¸å…³çš„æ‰§è¡Œæ–¹æ³• fnsï¼š</p><pre><code class=\"language-go\">createCallback := db.Callback().Create()\ncreateCallback.Match(enableTransaction).Register(\"gorm:begin_transaction\", BeginTransaction)\ncreateCallback.Register(\"gorm:before_create\", BeforeCreate)\ncreateCallback.Register(\"gorm:save_before_associations\", SaveBeforeAssociations(true))\ncreateCallback.Register(\"gorm:create\", Create(config))\ncreateCallback.Register(\"gorm:save_after_associations\", SaveAfterAssociations(true))\ncreateCallback.Register(\"gorm:after_create\", AfterCreate)\ncreateCallback.Match(enableTransaction).Register(\"gorm:commit_or_rollback_transaction\", CommitOrRollbackTransaction)\nif len(config.CreateClauses) == 0 {\n   config.CreateClauses = createClauses\n}\ncreateCallback.Clauses = config.CreateClauses\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒGorm åœ¨ä¸€ä¸ª create æ–¹æ³•ï¼Œå®šä¹‰äº† 7 ä¸ªæ‰§è¡Œæ–¹æ³• fnsï¼Œåˆ†åˆ«æ˜¯ï¼šBeginTransactionã€BeforeCreateã€SaveBeforeAssociationsã€Createã€SaveAfterAssociationsã€AfterCreateã€CommitOrRollbackTransactionã€‚è¿™ä¸ƒä¸ªæ‰§è¡Œæ–¹æ³•å°±æ˜¯æŒ‰ç…§é¡ºåºï¼Œä»ä¸Šåˆ°ä¸‹æ¯ä¸ª Create å‡½æ•°éƒ½ä¼šæ‰§è¡Œçš„æ–¹æ³•ã€‚</p><p>å…¶ä¸­å…³æ³¨ä¸€ä¸‹ Create æ–¹æ³•ï¼Œå®ƒåˆåˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/74/97/74168a832a7ea27fc84548cc980d1297.png?wh=1920x719\" alt=\"\"></p><p>æˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„ ExecContent å‡½æ•°ï¼Œè¿™ä¸ªå°±å¯¹åº”ä¸Šäº† Golang æ ‡å‡†åº“çš„ database/sql ä¸­ sql.DB çš„ ExecContext æ–¹æ³•ã€‚åŸæ¥å®ƒè—åœ¨è¿™é‡Œï¼</p><p>é‚£å‰é¢è¯´çš„ database/sql çš„ sql.DB çš„ Open æ–¹æ³•ï¼Œåˆæ”¾åœ¨å“ªé‡Œå‘¢ï¼Ÿå°±åœ¨ gorm.Open çš„ç¬¬å››å¤§æ­¥ä¸­ï¼š</p><pre><code class=\"language-plain\">db.ConnPool, err = sql.Open(dialector.DriverName, dialector.DSN)\n</code></pre><p>å°† database/sql ä¸­ç”Ÿæˆçš„ sql.DB ç»“æ„ï¼Œè®¾ç½®åœ¨äº† gorm.DB çš„ ConnPool ä¸Šã€‚</p><h3>db.Create</h3><p>ä¸‹é¢å†æ¥çœ‹ gorm.DB çš„ Create æ–¹æ³•ã€‚å®ƒçš„ä»»åŠ¡å°±å¾ˆç®€å•äº†ï¼šè§¦å‘å¯åŠ¨ processor ä¸­çš„ fns æ–¹æ³•ã€‚å…·ä½“æœ€æ ¸å¿ƒçš„ä»£ç å°±åœ¨ Gorm çš„ callback.go ä¸­çš„ Execute å‡½æ•°é‡Œã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/d4/7a/d41214f972f885c9c18da6aeb7e2e77a.png?wh=1920x566\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Execute å‡½æ•°ä¸­ï¼Œæœ€æ ¸å¿ƒçš„æ˜¯éå† fnsï¼Œè°ƒç”¨ fn(db) æ–¹æ³•ï¼Œå…¶ä¸­å°±æœ‰æˆ‘ä»¬å‰é¢å®šä¹‰çš„ Create æ–¹æ³•äº†ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº† database/sql çš„ db.ExecContext æ–¹æ³•ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å°±æ ¹æ®æ€ç»´å¯¼å›¾æ‰¾åˆ°äº† Gorm å°è£…çš„ database/sql çš„ä¸¤ä¸ªå…³é”®æ­¥éª¤ï¼š</p><ul>\n<li>sql.Open</li>\n<li>db.ExecContext</li>\n</ul><p>ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±åŸºæœ¬ç†è§£äº† Gorm æœ€æ ¸å¿ƒçš„å®ç°åŸç†äº†ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/ee/88/eec03fdb85d622202f8e7c8ac7e70488.jpg?wh=4861x3258\" alt=\"\"></p><p>å½“ç„¶ Gorm ä¸­è¿˜æœ‰ä¸€ä¸ªéƒ¨åˆ†ï¼Œæ˜¯å°†æˆ‘ä»¬å®šä¹‰çš„ Modelè§£ææˆä¸º SQL è¯­å¥ï¼Œè¿™é‡Œåˆæ˜¯ Gorm å®šä¹‰çš„ä¸€å¥—éå¸¸åºå¤§çš„æ•°æ®ç»“æ„æ”¯æ’‘çš„äº†ï¼Œå…¶ä¸­åŒ…æ‹¬ Statementã€Schemaã€Fieldã€Relationship ç­‰å’Œæ•°æ®è¡¨æ“ä½œç›¸å…³çš„æ•°æ®ç»“æ„ã€‚</p><p>è¿™éœ€è¦ç”¨å¦å¤–ä¸€ä¸ªç¯‡å¹…æ¥æè¿°äº†ã€‚ä¸è¿‡è¿™å— Model è§£æï¼Œå¯¹æˆ‘ä»¬ä¸‹ä¸€ç«  hade æ¡†æ¶èåˆ Gorm çš„å½±å“å¹¶ä¸å¤§ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¿½ç€ä¸Šè¿° Create æ–¹æ³•ä¸­çš„ stmt.Parse æ–¹æ³•è¿›ä¸€æ­¥åˆ†æã€‚</p><p>ä»Šå¤©æˆ‘ä»¬è¿˜æ²¡æœ‰æ¶‰åŠä»£ç ä¿®æ”¹ï¼Œæ€ç»´å¯¼å›¾ä¿å­˜åœ¨ GitHub ä¸Šçš„ <a href=\"https://github.com/gohade/coredemo/tree/geekbang/25\">geekbang/25</a> åˆ†æ”¯ä¸­æ ¹ç›®å½•çš„ mysql.xmind ä¸­äº†ã€‚</p><h2>å°ç»“</h2><p>æˆ‘ä»¬åˆ†æäº† Gorm çš„å…·ä½“æ•°æ®ç»“æ„å’Œåˆ›å»ºè¿æ¥çš„æ ¸å¿ƒæºç æµç¨‹ã€‚æƒ³è¦æ£€éªŒè‡ªå·±æ˜¯å¦ç†è§£è¿™èŠ‚è¯¾ä¹Ÿå¾ˆç®€å•ï¼Œä½ å¯ä»¥å¯¹ç…§å¼€å¤´ä¸º user è¡¨æ’å…¥ä¸€è¡Œçš„ä»£ç ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ¸…æ™°åˆ†æå‡ºå®ƒçš„åº•å±‚æ˜¯å¦‚ä½•å°è£…æ ‡å‡†åº“çš„ database/sql æ¥å®ç°çš„ã€‚</p><p>æˆ‘ä»¬åœ¨é˜…è¯» Gorm æºç çš„åŒæ—¶ï¼Œä¹Ÿæ˜¯åœ¨å­¦ä¹ å®ƒçš„ä¼˜ç§€ç¼–ç æ–¹å¼ï¼Œæ¯”å¦‚ä»Šå¤©è®²åˆ°çš„ Option æ–¹å¼ã€å®šä¹‰é©±åŠ¨ã€ConnPool å®šä¹‰å®ç°æ ‡å‡†åº“æ–¹æ³•çš„æ¥å£ã€‚è¿™äº›éƒ½æ˜¯ Gorm è®¾è®¡ç²¾å¦™çš„åœ°æ–¹ã€‚</p><p>å½“ç„¶ Gorm çš„ä»£ç è¿œä¸æ˜¯ä¸€ç¯‡æ–‡ç« èƒ½è¯´é€çš„ã€‚å…¶ä¸­åŒ…å«çš„ Model è§£æï¼Œä»¥åŠæ›´å¤šçš„å…·ä½“ç»†èŠ‚å®ç°ï¼Œéƒ½å¾—é ä½ åœ¨åç»­ä½¿ç”¨è¿‡ç¨‹ä¸­å¤šçœ‹<a href=\"https://gorm.io/zh_CN/\">å®˜ç½‘</a>ã€å¤šæ€è€ƒã€å¤šè§£æï¼Œæ‰èƒ½å®Œå…¨åƒé€è¿™ä¸ªåº“ã€‚</p><h3>æ€è€ƒé¢˜</h3><p>GORM æœ‰ä¸€ä¸ªåŠŸèƒ½æˆ‘éå¸¸å–œæ¬¢ï¼ŒDryRun ç©ºè·‘ï¼Œè¿™ä¸ªè®¾ç½®æ˜¯åœ¨ gorm.DB ç»“æ„ä¸­çš„ã€‚å¦‚æœæˆ‘ä»¬è®¾ç½®äº† gorm.DB çš„ DryRunï¼Œèƒ½è®©æˆ‘åœ¨è¿™ä¸ª DB ä¸­çš„æ‰€æœ‰ SQL æ“ä½œå¹¶ä¸çœŸæ­£æ‰§è¡Œï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨è°ƒè¯•çš„æ—¶å€™æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä½ èƒ½å†é¡ºç€æ€ç»´å¯¼å›¾ï¼Œåˆ†æå‡º DryRun æ˜¯æ€ä¹ˆåšåˆ°è¿™ä¸€ç‚¹çš„ä¹ˆï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€è¯·ä»–ä¸€èµ·å­¦ä¹ ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï½</p>","neighbors":{"left":{"article_title":"24ï½œç®¡ç†è¿›ç¨‹ï¼šå¦‚ä½•è®¾è®¡å®Œå–„çš„è¿è¡Œå‘½ä»¤ï¼Ÿ","id":440646},"right":{"article_title":"26ï½œGORMï¼ˆä¸‹ï¼‰ï¼šæ•°æ®åº“çš„ä½¿ç”¨å¿…ä¸å¯å°‘","id":440701}},"comments":[{"had_liked":false,"id":330647,"user_name":"ç‰›ç‰å¯Œ","can_delete":false,"product_type":"c1","uid":1231623,"ip_address":"","ucode":"DD962676F8FAF6","user_header":"https://static001.geekbang.org/account/avatar/00/12/cb/07/482b7155.jpg","comment_is_top":false,"comment_ctime":1642083021,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642083021","product_id":100090601,"comment_content":"æœ¬ç¯‡åˆ‡å…¥curdæ­£é¢˜äº†ğŸ˜„","like_count":0},{"had_liked":false,"id":326293,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1639461906,"is_pvip":false,"replies":[{"id":"118640","content":"æ˜¯çš„ï¼Œè·Ÿåˆ°æºç å°±èƒ½æ‰¾åˆ°äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1069186","ctime":1639584124,"ip_address":"","comment_id":326293,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639461906","product_id":100090601,"comment_content":"fns ä¸­ çœŸæ­£çš„ Create é‡Œé¢æœ‰åˆ¤æ–­ dryRun ","like_count":0,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539062,"discussion_content":"æ˜¯çš„ï¼Œè·Ÿåˆ°æºç å°±èƒ½æ‰¾åˆ°äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639584125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326292,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1639461814,"is_pvip":false,"replies":[{"id":"118641","content":"æ­å–œå°å“¥ï¼Œæ‰¾åˆ°äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1069186","ctime":1639584138,"ip_address":"","comment_id":326292,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639461814","product_id":100090601,"comment_content":"isDryRun := !db.DryRun &amp;&amp; db.Error == nil<br>\t\tif !isDryRun {<br>\t\t\treturn<br>\t\t}","like_count":0,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539063,"discussion_content":"æ­å–œå°å“¥ï¼Œæ‰¾åˆ°äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639584138,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321653,"user_name":"Vincent","can_delete":false,"product_type":"c1","uid":1241581,"ip_address":"","ucode":"9B70BE6908EB3B","user_header":"https://static001.geekbang.org/account/avatar/00/12/f1/ed/4e249c6b.jpg","comment_is_top":false,"comment_ctime":1636979006,"is_pvip":false,"replies":[{"id":"117997","content":"æ˜¯çš„ï¼Œgormç¡®å®å€¼å¾—å¤šçœ‹å‡ é","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1069186","ctime":1638842695,"ip_address":"","comment_id":321653,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1636979006","product_id":100090601,"comment_content":"å¯¹ä¼˜ç§€çš„å¼€æºä»£ç ï¼Œåº”è¯¥åƒé€","like_count":1,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536663,"discussion_content":"æ˜¯çš„ï¼Œgormç¡®å®å€¼å¾—å¤šçœ‹å‡ é","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638842695,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"å‹","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"discussion":{"id":538296,"discussion_content":"é‚£å¿…é¡»ç‹ ç‹ çš„é˜…è¯»ä¸€ä¸‹ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639396813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":536663,"ip_address":""},"score":538296,"extra":""}]}]}]}