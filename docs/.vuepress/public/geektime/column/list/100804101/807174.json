{"id":807174,"title":"08｜RAG效果提升：检索精度的优化与RAG效果评估","content":"<blockquote>\n<p><span class=\"reference\">本门课程为精品小课，不标配音频。</span></p>\n</blockquote><p>你好，我是常扬。</p><p>在之前的课程中，我们已经学习了RAG的完整流程。<strong>RAG索引阶段</strong>，首先解析文档，并将文档进行分块处理，接着通过嵌入模型将这些文本块向量化，最终将生成的向量存储在向量数据库中。在 <strong>RAG检索阶段</strong>，RAG系统会将用户查询向量化，并在向量数据库中进行语义相似度匹配，筛选出与查询最相似的多个文本块。最后，在 <strong>RAG生成阶段</strong>，系统将用户的查询与检索出的文本块进行指令组合和设计，并通过大模型的理解生成最终回答，至此完成整个RAG流程。</p><p><img src=\"https://static001.geekbang.org/resource/image/7d/a9/7dbd8139d7508bbb4d3de0aa073c33a9.jpg?wh=1920x1666\" alt=\"图片\"></p><p>上述内容的讲解实际上已经涵盖了一些能够提升 RAG 检索效果的关键技术。这些技术包括：处理多种文档格式、版面布局及阅读顺序还原的高精度、高效率<strong>文档解析技术</strong>，适用于特定场景的多样化<strong>分块策略</strong>，综合考虑特定领域精度、效率和文本块长度的<strong>嵌入模型</strong>，支持高效索引、检索和存储的<strong>向量数据库</strong>，结合多种检索技术的<strong>混合检索方法</strong>，以及能够捕捉查询词与文档块相关性的<strong>重排序技术</strong>。每个技术的细节优化都可以进一步提升整体检索精度。</p><p>这节课我们会在之前课程的基础上，进一步补充优化检索精度的方法。</p><h2>数据清洗和预处理</h2><p>在RAG索引流程中，文档解析之后、文本块切分之前，进行数据清洗和预处理能够有效<strong>减少脏数据和噪声</strong>，<strong>提升文本的整体质量和信息密度</strong>。通过清除冗余信息、统一格式、处理异常字符等手段，数据清洗和预处理过程确保文档更加规范和高质量，从而提高RAG系统的检索效果和信息准确性。</p><!-- [[[read_end]]] --><p>以下是其中一些方法及其示例：</p><p><strong>处理冗余的模板内容</strong></p><p>在企业内部文档中，特别是合同或报告等类型的文档，通常会出现大量的重复段落，例如多个合同中包含相同的法律条款或说明性文字。这类重复内容会增加向量数据库的存储负担，并影响检索效率。通过去除冗余内容，能够减少不必要的干扰，提升检索速度和相关性。</p><p>处理前：</p><pre><code class=\"language-plain\">……\n第一条：责任条款\n第二条：服务条款\n第一条：责任条款  # 重复的内容\n第二条：服务条款 # 重复的内容\n……\n</code></pre><p>处理后：</p><pre><code class=\"language-plain\">……\n第一条：责任条款\n第二条：服务条款\n……\n</code></pre><p><strong>消除文档中的额外空白和格式不一致</strong></p><p>文档中可能存在多余的空行、缩进或其他格式不一致的情况，这些多余的空白和格式会影响文本块的切分和向量化过程。通过清理这些格式化问题，能够确保文本块的划分更加精准，减少分块过程中的误差。</p><p>处理前：</p><pre><code class=\"language-plain\">产品介绍：\n\n\n   我们的产品……\n</code></pre><p>处理后：</p><pre><code class=\"language-plain\">产品介绍：我们的产品……\n</code></pre><p><strong>去除文档脚注、页眉页脚、版权信息</strong></p><p>在文档解析时，可能会从网页或PDF中提取出脚注、版权声明、页眉页脚等无关信息。这些内容会增加数据的噪声，影响向量生成的精度。去除这些无关的页脚和版权信息，有助于提升文本块的语义密度。</p><p>处理前：</p><pre><code class=\"language-plain\">版权所有 © 2024 公司名称\n</code></pre><p>处理后：</p><pre><code class=\"language-plain\">\n\n</code></pre><h2>查询扩展</h2><p>在RAG系统的典型检索步骤中，用户的查询会转化为向量后进行检索，但单个向量查询只能覆盖向量空间中的一个有限区域。如果查询中的嵌入向量未能包含所有关键信息，那么检索到的文档块可能不相关或缺乏必要的上下文。因此，单点查询的局限性会限制系统在庞大文档库中的搜索范围，导致错失与查询语义相关的内容。</p><p>查询扩展策略通过大模型从原始查询语句<strong>生成多个语义相关的查询</strong>，可以<strong>覆盖向量空间中的不同区域</strong>，从而提高检索的全面性和准确性。这些查询在嵌入后能够击中不同的语义区域，确保系统能够从更广泛的文档中检索到与用户需求相关的有用信息。</p><p>以下是查询扩展的指令模版：</p><pre><code class=\"language-plain\">你是一个AI语言模型助手。\n你的任务是生成五个不同版本的用户问题，以便从向量数据库中检索相关文档。\n通过从多个角度生成用户问题，你的目标是帮助用户克服基于距离的相似性搜索的一些局限性。\n请将这些替代问题用换行符分隔。原始问题：{查询原文}\n</code></pre><p>假设原始查询问题为：“下面报告中涉及了哪几个行业的案例以及总结各自面临的挑战？”</p><p>通过查询扩展指令，GPT-4o生成如下结果：</p><pre><code class=\"language-plain\">请问报告中提到的案例涉及了哪些行业？这些行业各自面临的挑战有哪些？\n报告中有哪些行业的案例被讨论？每个行业在报告中描述的挑战是什么？\n这个报告中具体提到了哪些行业的案例？能否总结一下这些行业当前面临的主要挑战？\n该报告中涵盖了哪些行业案例，并对各行业的挑战进行了哪些讨论？\n在报告中提到的行业案例有哪些？这些行业分别遇到的主要问题和挑战是什么？\n</code></pre><p>通过这种查询扩展策略，原始问题被分解为多个子查询，<strong>每个子查询独立检索相关文档并生成相应的结果</strong>。随后，系统将所有子查询的检索结果进行<strong>合并和重新排序</strong>。此方法能够有效扩展用户的查询意图，确保在复杂信息库中进行更全面的文档检索，从而避免遗漏与查询语义密切相关的重要内容。</p><h2>自查询</h2><p>在将用户查询转化为向量的过程中，无法确保查询中的所有关键信息都被充分捕捉到向量中。例如，若希望检索结果依赖于查询中的标签，直接通过嵌入向量进行检索并不能确保这些标签在向量表示中被完整表达，或者在与其他向量的距离计算中占有足够的权重。这种不足可能会导致检索结果缺乏相关性和准确性。</p><p>自查询策略通过大语言模型自动提取查询中对业务场景至关重要的<strong>元数据字段</strong>（如标签、作者ID、评论数量等关键信息），并将这些信息结合到嵌入检索过程中。通过这种方式，可以确保嵌入向量中包含这些关键信息，从而提高检索的全面性与精确性。</p><p>以下是自查询的指令模版：</p><pre><code class=\"language-plain\">你是一个AI语言模型助手。  \n你的任务是从用户问题中提取关键信息，你的回复应仅包含提取的关键信息。  \n用户问题：{查询原文}\n</code></pre><p>假设原始查询问题为：“下面报告中涉及了哪几个行业的案例以及总结各自面临的挑战？”</p><p>通过自查询指令，GPT-4o生成如下结果：</p><pre><code class=\"language-plain\">行业，案例，挑战\n</code></pre><p>通过这种自查询策略，系统能够<strong>精准提取查询中的关键信息</strong>，结合<strong>关键词检索及向量检索</strong>，确保这些元数据在向量检索中得以充分利用，从而提高检索结果的相关性和准确性。</p><h2>提示压缩</h2><p>提示压缩旨在<strong>减少上下文中的噪声，并突出最相关的信息</strong>，从而提高检索精度和生成质量。在RAG系统中，检索到的文档通常包含大量无关的文本，这些无关内容可能会掩盖与查询高度相关的信息，导致生成结果的相关性下降。提示压缩通过精简上下文、过滤掉不相关的信息，确保系统<strong>只处理与查询最相关、最重要的内容</strong>。</p><p>以下是提示压缩的指令模版：</p><pre><code class=\"language-plain\">你是一个AI语言模型助手，负责对检索到的文档进行上下文压缩。\n你的目标是从文档中提取与用户查询高度相关的段落，并删除与查询无关或噪声较大的部分。\n你应确保保留所有能够直接回答用户查询的问题核心信息。\n\n输入：\n用户查询：{用户的原始查询}\n检索到的文档：{检索到的文档内容}\n\n输出要求：\n提取与用户查询最相关的段落和信息。\n删除所有与查询无关的内容，包括噪声、背景信息或扩展讨论。\n压缩后的内容应简洁清晰，直指用户的核心问题。\n\n输出格式：\n{压缩段落1}\n{压缩段落2}\n{压缩段落3}\n</code></pre><p>通过提示压缩，系统能够准确提取出与查询高度相关的核心信息，去除冗余内容，并返回简洁的压缩结果。组合成为新的指令，输入大模型获得回复，提高RAG系统答案准确度。</p><h2>RAG效果评估</h2><p>在RAG系统的开发、优化与应用过程中，<strong>RAG效果评估</strong>是其中不可或缺的一环。通过建立<strong>统一的评估标准</strong>，能够公平、客观地比较不同RAG系统及其优化方法，从而识别出最佳实践。这套评估体系不仅帮助开发者发现系统的优劣，亦为后续的改进提供了有力的参考依据。</p><p>下面我介绍一种在真实应用场景中采用的RAG效果评估标准与方法。</p><p><strong>评估方式：</strong></p><ol>\n<li><strong>大模型打分</strong>：通过使用大语言模型对RAG的输出进行自动评分。这类评估方式效率高，能够快速处理大规模的评估任务，但在准确性上可能受到模型本身偏差的影响。</li>\n<li><strong>人工打分</strong>：由人类评审员对RAG的输出进行逐一打分。人工评估方式可以提供更为精确、细致的反馈，特别是在检测生成答案中的细微错误和幻觉时，但其耗时较长，成本较高。</li>\n</ol><p><strong>评估指标：</strong></p><ol>\n<li><strong>CR 检索相关性（Context Relevancy）</strong>：该指标用于测量检索到的信息与查询上下文的相关性。如果检索到的信息偏离了原始查询，后续的生成任务就会受到负面影响。</li>\n<li><strong>AR 答案相关性（Answer Relevancy）</strong>：衡量生成答案与原始问题之间的相关性。该指标主要评估生成的答案是否能够解决用户的问题，且内容是否逻辑连贯。</li>\n<li><strong>F 可信度（Faithfulness）</strong>：评估生成的答案中是否存在幻觉（hallucination）或不准确之处。这一指标尤为重要，因为虚假的答案会极大影响用户对RAG系统的信任度。</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/fe/19/fea79ced7b186a2c1efa402cdedf0d19.jpg?wh=1920x648\" alt=\"图片\"></p><p><strong>打分标准：</strong></p><ol>\n<li><strong>完美（Perfect）</strong>1.0分</li>\n<li><strong>可接受（Acceptable）</strong>0.75分</li>\n<li><strong>缺失（Missing）</strong>0.5分</li>\n<li><strong>错误（Incorrect）</strong>0分</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/8d/2e/8d143bcedc56acdc66e034b60024ef2e.png?wh=1736x1496\" alt=\"图片\"></p><p><strong>RAG效果评估是RAG系统完成搭建后的一个持续优化流程</strong>。通过设定打分标准和评估指标，综合评分能够准确反映RAG系统的整体性能。针对不同的应用场景，还可以引入更多评估指标，如 <strong>Top5 召回率</strong>、<strong>Top3 召回率</strong>、<strong>Top1 召回率</strong>以及其他常用的 <strong>NLP 评估指标</strong>。通过灵活组合这些评估方式与指标，可以更加精确地衡量RAG系统在特定场景中的表现，并为后续优化提供方向。</p><h2>总结</h2><p>这节课我们讲解了RAG系统检索精度的优化方法及效果评估。</p><ol>\n<li><strong>检索精度的优化</strong></li>\n</ol><p>既往课程中文档解析技术、分块策略、嵌入模型、向量数据库、混合检索方法、重排序技术均可优化检索精度，在此基础上补充了四种优化检索精度的方法。</p><p><strong>数据清洗和预处理</strong>，通过清除冗余信息、统一格式和处理异常字符，有效提升文档质量和信息密度，减少噪声干扰。常用的方法包括去除重复内容、清理空白和格式不一致、移除无关的页眉页脚和版权信息。</p><p><strong>查询扩展</strong>，通过生成多个语义相关的查询覆盖不同向量空间，扩展检索范围，确保检索结果更全面和准确，避免遗漏重要信息。</p><p><strong>自查询</strong>，从查询中提取关键信息，如标签和元数据，并结合向量检索，提高检索的精准度，确保关键元素在检索过程中得到充分利用。</p><p><strong>提示压缩</strong>，通过压缩检索到的文档上下文，去除无关内容，保留核心信息，减少噪声，提升生成答案的相关性和准确性。</p><ol start=\"2\">\n<li><strong>RAG效果评估</strong></li>\n</ol><p><strong>RAG效果评估在持续优化过程中至关重要。</strong>我们今天介绍了一套评估标准与方法，涵盖大模型打分和人工打分两种评估方式，以及检索相关性、答案相关性和可信度评估指标，配以打分标准。最终通过多项指标综合评分来评估系统性能，以指导后续优化方向。</p><h2>思考题</h2><p>除了我们这节课提及的优化方法与评估维度外，还有哪些RAG检索精度的优化方法和评估维度？欢迎你在留言区分享，和我一起讨论，也欢迎你把这节课的内容分享给对RAG感兴趣的朋友，我们下节课再见！</p>","neighbors":{"left":{"article_title":"07｜RAG生成：大模型与Prompt提示工程","id":807144},"right":{"article_title":"09｜进阶（一）：Advanced RAG与Modular RAG","id":808229}},"comments":[{"had_liked":false,"id":395293,"user_name":"张申傲","can_delete":false,"product_type":"c1","uid":1182372,"ip_address":"北京","ucode":"22D46BC529BA8A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg","comment_is_top":false,"comment_ctime":1730113739,"is_pvip":false,"replies":[{"id":143527,"content":"是的","user_name":"作者回复","user_name_real":"编辑","uid":3954065,"ctime":1730455103,"ip_address":"上海","comment_id":395293,"utype":1}],"discussion_count":1,"race_medal":2,"score":2,"product_id":100804101,"comment_content":"第8讲打卡~\n对RAG效果的评估，还可以考虑增加用户反馈的机制，让用户可以对每一个回复结果进行打分和反馈。","like_count":1,"discussions":[{"author":{"id":3954065,"avatar":"https://static001.geekbang.org/account/avatar/00/3c/55/91/e3c96b88.jpg","nickname":"常扬","note":"","ucode":"11B62CDABBE875","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":653228,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1730455103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394889,"user_name":"edward","can_delete":false,"product_type":"c1","uid":1604798,"ip_address":"湖南","ucode":"09F7A5B8D2E7BD","user_header":"","comment_is_top":false,"comment_ctime":1728691700,"is_pvip":false,"replies":[{"id":143407,"content":"课程中在打分标准下有一个具体打分结果的示例，可以查阅参考。","user_name":"作者回复","user_name_real":"编辑","uid":3954065,"ctime":1728898296,"ip_address":"上海","comment_id":394889,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100804101,"comment_content":"请问下老师 RAG评估这块内容 可以给出一个示例么？","like_count":0,"discussions":[{"author":{"id":3954065,"avatar":"https://static001.geekbang.org/account/avatar/00/3c/55/91/e3c96b88.jpg","nickname":"常扬","note":"","ucode":"11B62CDABBE875","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652424,"discussion_content":"课程中在打分标准下有一个具体打分结果的示例，可以查阅参考。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1728898296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3920101,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/d0/e5/0a3ee17c.jpg","nickname":"kevin","note":"","ucode":"19E83C631DF25E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":653573,"discussion_content":"有相关案例链接吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1731237680,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}