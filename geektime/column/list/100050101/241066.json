{"id":241066,"title":"16 | TopicDeletionManagerï¼š Topicæ˜¯æ€ä¹ˆè¢«åˆ é™¤çš„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ­£å¼è¿›å…¥åˆ°ç¬¬å››å¤§æ¨¡å—â€œçŠ¶æ€æœºâ€çš„å­¦ä¹ ã€‚</p><p>Kafkaæºç ä¸­æœ‰å¾ˆå¤šçŠ¶æ€æœºå’Œç®¡ç†å™¨ï¼Œæ¯”å¦‚ä¹‹å‰æˆ‘ä»¬å­¦è¿‡çš„Controlleré€šé“ç®¡ç†å™¨ControllerChannelManagerã€å¤„ç†Controlleräº‹ä»¶çš„ControllerEventManagerï¼Œç­‰ç­‰ã€‚è¿™äº›ç®¡ç†å™¨å’ŒçŠ¶æ€æœºï¼Œå¤§å¤šä¸å„è‡ªçš„â€œå®¿ä¸»â€ç»„ä»¶å…³ç³»å¯†åˆ‡ï¼Œå¯ä»¥è¯´æ˜¯å¤§å°ä¸åŒã€åŠŸèƒ½å„å¼‚ã€‚å°±æ¯”å¦‚Controllerçš„è¿™ä¸¤ä¸ªç®¡ç†å™¨ï¼Œå¿…é¡»è¦ä¸Controllerç»„ä»¶ç´§è€¦åˆåœ¨ä¸€èµ·æ‰èƒ½å®ç°å„è‡ªçš„åŠŸèƒ½ã€‚</p><p>ä¸è¿‡ï¼ŒKafkaä¸­è¿˜æ˜¯æœ‰ä¸€äº›çŠ¶æ€æœºå’Œç®¡ç†å™¨å…·æœ‰ç›¸å¯¹ç‹¬ç«‹çš„åŠŸèƒ½æ¡†æ¶ï¼Œä¸ä¸¥é‡ä¾èµ–ä½¿ç”¨æ–¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘åœ¨è¿™ä¸ªæ¨¡å—ä¸ºä½ ç²¾é€‰çš„TopicDeletionManagerï¼ˆä¸»é¢˜åˆ é™¤ç®¡ç†å™¨ï¼‰ã€ReplicaStateMachineï¼ˆå‰¯æœ¬çŠ¶æ€æœºï¼‰å’ŒPartitionStateMachineï¼ˆåˆ†åŒºçŠ¶æ€æœºï¼‰ã€‚</p><ul>\n<li>TopicDeletionManagerï¼šè´Ÿè´£å¯¹æŒ‡å®šKafkaä¸»é¢˜æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œæ¸…é™¤å¾…åˆ é™¤ä¸»é¢˜åœ¨é›†ç¾¤ä¸Šçš„å„ç±»â€œç—•è¿¹â€ã€‚</li>\n<li>ReplicaStateMachineï¼šè´Ÿè´£å®šä¹‰Kafkaå‰¯æœ¬çŠ¶æ€ã€åˆæ³•çš„çŠ¶æ€è½¬æ¢ï¼Œä»¥åŠç®¡ç†çŠ¶æ€ä¹‹é—´çš„è½¬æ¢ã€‚</li>\n<li>PartitionStateMachineï¼šè´Ÿè´£å®šä¹‰Kafkaåˆ†åŒºçŠ¶æ€ã€åˆæ³•çš„çŠ¶æ€è½¬æ¢ï¼Œä»¥åŠç®¡ç†çŠ¶æ€ä¹‹é—´çš„è½¬æ¢ã€‚</li>\n</ul><!-- [[[read_end]]] --><p>æ— è®ºæ˜¯ä¸»é¢˜ã€åˆ†åŒºï¼Œè¿˜æ˜¯å‰¯æœ¬ï¼Œå®ƒä»¬åœ¨Kafkaä¸­çš„ç”Ÿå‘½å‘¨æœŸé€šå¸¸éƒ½æœ‰å¤šä¸ªçŠ¶æ€ã€‚è€Œè¿™3ä¸ªçŠ¶æ€æœºï¼Œå°±æ˜¯æ¥ç®¡ç†è¿™äº›çŠ¶æ€çš„ã€‚è€Œå¦‚ä½•å®ç°æ­£ç¡®ã€é«˜æ•ˆçš„ç®¡ç†ï¼Œå°±æ˜¯æºç è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å…ˆæ¥å­¦ä¹ TopicDeletionManagerï¼Œçœ‹ä¸€ä¸‹Kafkaæ˜¯å¦‚ä½•åˆ é™¤ä¸€ä¸ªä¸»é¢˜çš„ã€‚</p><h2>è¯¾å‰å¯¼è¯»</h2><p>åˆšå¼€å§‹å­¦ä¹ Kafkaçš„æ—¶å€™ï¼Œæˆ‘å¯¹Kafkaåˆ é™¤ä¸»é¢˜çš„è®¤è¯†éå¸¸â€œæµ…è–„â€ã€‚ä¹‹å‰æˆ‘ä»¥ä¸ºæˆåŠŸæ‰§è¡Œäº†kafka-topics.sh --deleteå‘½ä»¤åï¼Œä¸»é¢˜å°±ä¼šè¢«åˆ é™¤ã€‚æˆ‘ç›¸ä¿¡ï¼Œå¾ˆå¤šäººå¯èƒ½éƒ½æœ‰è¿‡è¿™æ ·çš„é”™è¯¯ç†è§£ã€‚</p><p>è¿™ç§ä¸æ­£ç¡®çš„è®¤çŸ¥äº§ç”Ÿçš„ä¸€ä¸ªç»“æœå°±æ˜¯ï¼Œæˆ‘ä»¬ç»å¸¸å‘ç°ä¸»é¢˜æ²¡æœ‰è¢«åˆ é™¤å¹²å‡€ã€‚äºæ˜¯ï¼Œç½‘ä¸Šæµä¼ ç€ä¸€å¥—ç»ˆæâ€œæ­¦æ—ç§˜ç±â€ï¼šæ‰‹åŠ¨åˆ é™¤ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶ï¼Œä»¥åŠæ‰‹åŠ¨åˆ é™¤ZooKeeperä¸‹å…³äºä¸»é¢˜çš„å„ä¸ªèŠ‚ç‚¹ã€‚</p><p>å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘å§‹ç»ˆä¸æ¨èä½ ä½¿ç”¨è¿™å¥—â€œç§˜ç±â€ï¼Œç†ç”±æœ‰äºŒï¼š</p><ul>\n<li>å®ƒå¹¶ä¸å®Œæ•´ã€‚äº‹å®ä¸Šï¼Œé™¤éä½ é‡å¯Brokerï¼Œå¦åˆ™ï¼Œè¿™å¥—â€œç§˜ç±â€æ— æ³•æ¸…ç†Controllerç«¯å’Œå„ä¸ªBrokerä¸Šå…ƒæ•°æ®ç¼“å­˜ä¸­çš„å¾…åˆ é™¤ä¸»é¢˜çš„ç›¸å…³æ¡ç›®ã€‚</li>\n<li>å®ƒå¹¶æ²¡æœ‰è¢«å®˜æ–¹æ‰€è®¤è¯ï¼Œæ¢å¥è¯è¯´å°±æ˜¯åæœè‡ªè´Ÿã€‚ä»æŸç§ç¨‹åº¦ä¸Šè¯´ï¼Œå®ƒä¼šå¸¦æ¥ä»€ä¹ˆä¸å¥½çš„ç»“æœï¼Œæ˜¯ä½ æ²¡æ³•æŠŠæ§çš„ã€‚</li>\n</ul><p>æ‰€è°“â€œæœ¬äº‹å¤§ä¸å¦‚ä¸æ‘Šä¸Šâ€ï¼Œæˆ‘ä»¬ä¸å…¶ç¢ç£¨åˆ é™¤ä¸»é¢˜å¤±è´¥ä¹‹åæ€ä¹ˆè‡ªæ•‘ï¼Œä¸å¦‚è¸è¸å®å®åœ°ç ”ç©¶ä¸‹Kafkaåº•å±‚æ˜¯æ€ä¹ˆæ‰§è¡Œè¿™ä¸ªæ“ä½œçš„ã€‚ææ˜ç™½å®ƒçš„åŸç†ä¹‹åï¼Œå†æœ‰é’ˆå¯¹æ€§åœ°ä½¿ç”¨â€œç§˜ç±â€ï¼Œæ‰èƒ½åšåˆ°æœ‰çš„æ”¾çŸ¢ã€‚ä½ è¯´æ˜¯ä¸æ˜¯ï¼Ÿ</p><h2>TopicDeletionManageræ¦‚è§ˆ</h2><p>å¥½äº†ï¼Œæˆ‘ä»¬å°±æ­£å¼å¼€å§‹å­¦ä¹ TopicDeletionManagerå§ã€‚</p><p>è¿™ä¸ªç®¡ç†å™¨ä½äºkafka.controlleråŒ…ä¸‹ï¼Œæ–‡ä»¶åæ˜¯TopicDeletionManager.scalaã€‚åœ¨æ€»å…±ä¸åˆ°400è¡Œçš„æºç ä¸­ï¼Œå®ƒå®šä¹‰äº†3ä¸ªç±»ç»“æ„ä»¥åŠ20å¤šä¸ªæ–¹æ³•ã€‚æ€»ä½“è€Œè¨€ï¼Œå®ƒè¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“å­¦ä¹ çš„ã€‚</p><p>ä¸ºäº†è®©ä½ å…ˆæœ‰ä¸ªæ„Ÿæ€§è®¤è¯†ï¼Œæˆ‘ç”»äº†ä¸€å¼ TopicDeletionManager.scalaçš„ä»£ç UMLå›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/52/f9/52032b5ccf820b10090b5a4ad78d8ff9.jpg?wh=3208*2957\" alt=\"\"></p><p>TopicDeletionManager.scalaè¿™ä¸ªæºæ–‡ä»¶ï¼ŒåŒ…æ‹¬3ä¸ªéƒ¨åˆ†ã€‚</p><ul>\n<li>DeletionClientæ¥å£ï¼šè´Ÿè´£å®ç°åˆ é™¤ä¸»é¢˜ä»¥åŠåç»­çš„åŠ¨ä½œï¼Œæ¯”å¦‚æ›´æ–°å…ƒæ•°æ®ç­‰ã€‚è¿™ä¸ªæ¥å£é‡Œå®šä¹‰äº†4ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯deleteTopicã€deleteTopicDeletionsã€mutePartitionModificationså’ŒsendMetadataUpdateã€‚æˆ‘ä»¬åé¢å†è¯¦ç»†å­¦ä¹ å®ƒä»¬çš„ä»£ç ã€‚</li>\n<li>ControllerDeletionClientç±»ï¼šå®ç°DeletionClientæ¥å£çš„ç±»ï¼Œåˆ†åˆ«å®ç°äº†åˆšåˆšè¯´åˆ°çš„é‚£4ä¸ªæ–¹æ³•ã€‚</li>\n<li>TopicDeletionManagerç±»ï¼šä¸»é¢˜åˆ é™¤ç®¡ç†å™¨ç±»ï¼Œå®šä¹‰äº†è‹¥å¹²ä¸ªæ–¹æ³•ç»´æŠ¤ä¸»é¢˜åˆ é™¤å‰åé›†ç¾¤çŠ¶æ€çš„æ­£ç¡®æ€§ã€‚æ¯”å¦‚ï¼Œä»€ä¹ˆæ—¶å€™æ‰èƒ½åˆ é™¤ä¸»é¢˜ã€ä»€ä¹ˆæ—¶å€™ä¸»é¢˜ä¸èƒ½è¢«åˆ é™¤ã€ä¸»é¢˜åˆ é™¤è¿‡ç¨‹ä¸­è¦è§„é¿å“ªäº›æ“ä½œï¼Œç­‰ç­‰ã€‚</li>\n</ul><h2>DeletionClientæ¥å£åŠå…¶å®ç°</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€ä¸€è®¨è®ºä¸‹è¿™3éƒ¨åˆ†ã€‚é¦–å…ˆæ˜¯DeletionClientæ¥å£åŠå…¶å®ç°ç±»ã€‚</p><p>å°±åƒå‰é¢è¯´çš„ï¼ŒDeletionClientæ¥å£å®šä¹‰çš„æ–¹æ³•ç”¨äºåˆ é™¤ä¸»é¢˜ï¼Œå¹¶å°†åˆ é™¤ä¸»é¢˜è¿™ä»¶äº‹å„¿åŒæ­¥ç»™å…¶ä»–Brokerã€‚</p><p>ç›®å‰ï¼ŒDeletionClientè¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œå³ControllerDeletionClientã€‚æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªå®ç°ç±»çš„ä»£ç ï¼š</p><pre><code>class ControllerDeletionClient(controller: KafkaController, zkClient: KafkaZkClient) extends DeletionClient {\n  // åˆ é™¤ç»™å®šä¸»é¢˜\n  override def deleteTopic(topic: String, epochZkVersion: Int): Unit = {\n    // åˆ é™¤/brokers/topics/&lt;topic&gt;èŠ‚ç‚¹\n    zkClient.deleteTopicZNode(topic, epochZkVersion)\n    // åˆ é™¤/config/topics/&lt;topic&gt;èŠ‚ç‚¹\n    zkClient.deleteTopicConfigs(Seq(topic), epochZkVersion)\n    // åˆ é™¤/admin/delete_topics/&lt;topic&gt;èŠ‚ç‚¹\n    zkClient.deleteTopicDeletions(Seq(topic), epochZkVersion)\n  }\n  // åˆ é™¤/admin/delete_topicsä¸‹çš„ç»™å®štopicå­èŠ‚ç‚¹\n  override def deleteTopicDeletions(topics: Seq[String], epochZkVersion: Int): Unit = {\n    zkClient.deleteTopicDeletions(topics, epochZkVersion)\n  }\n  // å–æ¶ˆ/brokers/topics/&lt;topic&gt;èŠ‚ç‚¹æ•°æ®å˜æ›´çš„ç›‘å¬\n  override def mutePartitionModifications(topic: String): Unit = {\n    controller.unregisterPartitionModificationsHandlers(Seq(topic))\n  }\n  // å‘é›†ç¾¤Brokerå‘é€æŒ‡å®šåˆ†åŒºçš„å…ƒæ•°æ®æ›´æ–°è¯·æ±‚\n  override def sendMetadataUpdate(partitions: Set[TopicPartition]): Unit = {\n    controller.sendUpdateMetadataRequest(\n      controller.controllerContext.liveOrShuttingDownBrokerIds.toSeq, partitions)\n  }\n}\n</code></pre><p>è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå­—æ®µã€‚åŒæ—¶ï¼Œç”±äºæ˜¯DeletionClientæ¥å£çš„å®ç°ç±»ï¼Œå› è€Œè¯¥ç±»å®ç°äº†DeletionClientæ¥å£å®šä¹‰çš„å››ä¸ªæ–¹æ³•ã€‚</p><p>å…ˆæ¥è¯´æ„é€ å‡½æ•°çš„ä¸¤ä¸ªå­—æ®µï¼šKafkaControllerå®ä¾‹å’ŒKafkaZkClientå®ä¾‹ã€‚KafkaControllerå®ä¾‹ï¼Œæˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œå°±æ˜¯Controllerç»„ä»¶å¯¹è±¡ï¼›è€ŒKafkaZkClientå®ä¾‹ï¼Œå°±æ˜¯Kafkaä¸ZooKeeperäº¤äº’çš„å®¢æˆ·ç«¯å¯¹è±¡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†ç»“åˆä»£ç çœ‹ä¸‹DeletionClientæ¥å£å®ç°ç±»ControllerDeletionClientå®šä¹‰çš„4ä¸ªæ–¹æ³•ã€‚æˆ‘æ¥ç®€å•ä»‹ç»ä¸‹è¿™4ä¸ªæ–¹æ³•å¤§è‡´æ˜¯åšä»€ä¹ˆçš„ã€‚</p><p><strong>1.deleteTopic</strong></p><p>å®ƒç”¨äºåˆ é™¤ä¸»é¢˜åœ¨ZooKeeperä¸Šçš„æ‰€æœ‰â€œç—•è¿¹â€ã€‚å…·ä½“æ–¹æ³•æ˜¯ï¼Œåˆ†åˆ«è°ƒç”¨KafkaZkClientçš„3ä¸ªæ–¹æ³•å»åˆ é™¤ZooKeeperä¸‹/brokers/topics/<topic>èŠ‚ç‚¹ã€/config/topics/<topic>èŠ‚ç‚¹å’Œ/admin/delete_topics/<topic>èŠ‚ç‚¹ã€‚</topic></topic></topic></p><p><strong>2.deleteTopicDeletions</strong></p><p>å®ƒç”¨äºåˆ é™¤ZooKeeperä¸‹å¾…åˆ é™¤ä¸»é¢˜çš„æ ‡è®°èŠ‚ç‚¹ã€‚å…·ä½“æ–¹æ³•æ˜¯ï¼Œè°ƒç”¨KafkaZkClientçš„deleteTopicDeletionsæ–¹æ³•ï¼Œæ‰¹é‡åˆ é™¤ä¸€ç»„ä¸»é¢˜åœ¨/admin/delete_topicsä¸‹çš„å­èŠ‚ç‚¹ã€‚æ³¨æ„ï¼ŒdeleteTopicDeletionsè¿™ä¸ªæ–¹æ³•åç»“å°¾çš„Deletionsï¼Œè¡¨ç¤º/admin/delete_topicsä¸‹çš„å­èŠ‚ç‚¹ã€‚æ‰€ä»¥ï¼ŒdeleteTopicæ˜¯åˆ é™¤ä¸»é¢˜ï¼ŒdeleteTopicDeletionsæ˜¯åˆ é™¤/admin/delete_topicsä¸‹çš„å¯¹åº”å­èŠ‚ç‚¹ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•é‡Œéƒ½æœ‰ä¸€ä¸ªepochZkVersionçš„å­—æ®µï¼Œä»£è¡¨æœŸæœ›çš„Controller Epochç‰ˆæœ¬å·ã€‚å¦‚æœä½ ä½¿ç”¨ä¸€ä¸ªæ—§çš„Epochç‰ˆæœ¬å·æ‰§è¡Œè¿™äº›æ–¹æ³•ï¼ŒZooKeeperä¼šæ‹’ç»ï¼Œå› ä¸ºå’Œå®ƒè‡ªå·±ä¿å­˜çš„ç‰ˆæœ¬å·ä¸åŒ¹é…ã€‚å¦‚æœä¸€ä¸ªControllerçš„Epochå€¼å°äºZooKeeperä¸­ä¿å­˜çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªControllerå¾ˆå¯èƒ½æ˜¯å·²ç»è¿‡æœŸçš„Controllerã€‚è¿™ç§Controllerå°±è¢«ç§°ä¸ºZombie Controllerã€‚epochZkVersionå­—æ®µçš„ä½œç”¨ï¼Œå°±æ˜¯éš”ç¦»Zombie Controllerå‘é€çš„æ“ä½œã€‚</p><p><strong>3.mutePartitionModifications</strong></p><p>å®ƒçš„ä½œç”¨æ˜¯å±è”½ä¸»é¢˜åˆ†åŒºæ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œå…·ä½“å®ç°åŸç†å…¶å®å°±æ˜¯å–æ¶ˆ/brokers/topics/<topic>èŠ‚ç‚¹æ•°æ®å˜æ›´çš„ç›‘å¬ã€‚è¿™æ ·å½“è¯¥ä¸»é¢˜çš„åˆ†åŒºæ•°æ®å‘ç”Ÿå˜æ›´åï¼Œç”±äºå¯¹åº”çš„ZooKeeperç›‘å¬å™¨å·²ç»è¢«å–æ¶ˆäº†ï¼Œå› æ­¤ä¸ä¼šè§¦å‘Controllerç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚</topic></p><p>é‚£ä¸ºä»€ä¹ˆè¦å–æ¶ˆè¿™ä¸ªç›‘å¬å™¨å‘¢ï¼Ÿå…¶å®ï¼Œä¸»è¦æ˜¯ä¸ºäº†é¿å…æ“ä½œä¹‹é—´çš„ç›¸äº’å¹²æ‰°ã€‚è®¾æƒ³ä¸‹ï¼Œç”¨æˆ·Aå‘èµ·äº†ä¸»é¢˜åˆ é™¤ï¼Œè€ŒåŒæ—¶ç”¨æˆ·Bä¸ºè¿™ä¸ªä¸»é¢˜æ–°å¢äº†åˆ†åŒºã€‚æ­¤æ—¶ï¼Œè¿™ä¸¤ä¸ªæ“ä½œå°±ä¼šç›¸äº’å†²çªï¼Œå¦‚æœå…è®¸ControlleråŒæ—¶å¤„ç†è¿™ä¸¤ä¸ªæ“ä½œï¼ŒåŠ¿å¿…ä¼šé€ æˆé€»è¾‘ä¸Šçš„æ··ä¹±ä»¥åŠçŠ¶æ€çš„ä¸ä¸€è‡´ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼Œåœ¨ç§»é™¤ä¸»é¢˜å‰¯æœ¬å’Œåˆ†åŒºå¯¹è±¡å‰ï¼Œä»£ç è¦å…ˆæ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œä»¥ç¡®ä¿ä¸å†å“åº”ç”¨æˆ·å¯¹è¯¥ä¸»é¢˜çš„å…¶ä»–æ“ä½œã€‚</p><p>mutePartitionModificationsæ–¹æ³•çš„å®ç°åŸç†å¾ˆç®€å•ï¼Œå®ƒä¼šè°ƒç”¨unregisterPartitionModificationsHandlersï¼Œå¹¶æ¥ç€è°ƒç”¨KafkaZkClientçš„unregisterZNodeChangeHandleræ–¹æ³•ï¼Œå–æ¶ˆZooKeeperä¸Šå¯¹ç»™å®šä¸»é¢˜çš„åˆ†åŒºèŠ‚ç‚¹æ•°æ®å˜æ›´çš„ç›‘å¬ã€‚</p><p><strong>4.sendMetadataUpdate</strong></p><p>å®ƒä¼šè°ƒç”¨KafkaControllerçš„sendUpdateMetadataRequestæ–¹æ³•ï¼Œç»™é›†ç¾¤æ‰€æœ‰Brokerå‘é€æ›´æ–°è¯·æ±‚ï¼Œå‘Šè¯‰å®ƒä»¬ä¸è¦å†ä¸ºå·²åˆ é™¤ä¸»é¢˜çš„åˆ†åŒºæä¾›æœåŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>override def sendMetadataUpdate(partitions: Set[TopicPartition]): Unit = {\n  // ç»™é›†ç¾¤æ‰€æœ‰Brokerå‘é€UpdateMetadataRequest\n  // é€šçŸ¥å®ƒä»¬ç»™å®špartitionsçš„çŠ¶æ€å˜åŒ–\n  controller.sendUpdateMetadataRequest(\n    controller.controllerContext.liveOrShuttingDownBrokerIds.toSeq, partitions)\n}\n</code></pre><p>è¯¥æ–¹æ³•ä¼šç»™é›†ç¾¤ä¸­çš„æ‰€æœ‰Brokerå‘é€æ›´æ–°å…ƒæ•°æ®è¯·æ±‚ï¼Œå‘ŠçŸ¥å®ƒä»¬è¦åŒæ­¥ç»™å®šåˆ†åŒºçš„çŠ¶æ€ã€‚</p><h2>TopicDeletionManagerå®šä¹‰åŠåˆå§‹åŒ–</h2><p>æœ‰äº†è¿™äº›é“ºå«ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸»é¢˜åˆ é™¤ç®¡ç†å™¨çš„ä¸»è¦å…¥å£ï¼šTopicDeletionManagerç±»ã€‚è¿™ä¸ªç±»çš„å®šä¹‰ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><pre><code>class TopicDeletionManager(\n  // KafkaConfigç±»ï¼Œä¿å­˜Brokerç«¯å‚æ•°\n  config: KafkaConfig, \n  // é›†ç¾¤å…ƒæ•°æ®\n  controllerContext: ControllerContext,\n  // å‰¯æœ¬çŠ¶æ€æœºï¼Œç”¨äºè®¾ç½®å‰¯æœ¬çŠ¶æ€\n  replicaStateMachine: ReplicaStateMachine,\n  // åˆ†åŒºçŠ¶æ€æœºï¼Œç”¨äºè®¾ç½®åˆ†åŒºçŠ¶æ€\n  partitionStateMachine: PartitionStateMachine,\n  // DeletionClientæ¥å£ï¼Œå®ç°ä¸»é¢˜åˆ é™¤\n  client: DeletionClient) extends Logging {\n  this.logIdent = s&quot;[Topic Deletion Manager ${config.brokerId}] &quot;\n  // æ˜¯å¦å…è®¸åˆ é™¤ä¸»é¢˜\n  val isDeleteTopicEnabled: Boolean = config.deleteTopicEnable\n  ......\n}\n</code></pre><p>è¯¥ç±»ä¸»è¦çš„å±æ€§æœ‰6ä¸ªï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹çœ‹ã€‚</p><ul>\n<li>configï¼šKafkaConfigå®ä¾‹ï¼Œå¯ä»¥ç”¨ä½œè·å–Brokerç«¯å‚æ•°delete.topic.enableçš„å€¼ã€‚è¯¥å‚æ•°ç”¨äºæ§åˆ¶æ˜¯å¦å…è®¸åˆ é™¤ä¸»é¢˜ï¼Œé»˜è®¤å€¼æ˜¯trueï¼Œå³Kafkaé»˜è®¤å…è®¸ç”¨æˆ·åˆ é™¤ä¸»é¢˜ã€‚</li>\n<li>controllerContextï¼šControllerç«¯ä¿å­˜çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚åˆ é™¤ä¸»é¢˜å¿…ç„¶è¦å˜æ›´é›†ç¾¤å…ƒæ•°æ®ä¿¡æ¯ï¼Œå› æ­¤TopicDeletionManageréœ€è¦ç”¨åˆ°controllerContextçš„æ–¹æ³•ï¼Œå»æ›´æ–°å®ƒä¿å­˜çš„æ•°æ®ã€‚</li>\n<li>replicaStateMachineå’ŒpartitionStateMachineï¼šå‰¯æœ¬çŠ¶æ€æœºå’Œåˆ†åŒºçŠ¶æ€æœºã€‚å®ƒä»¬å„è‡ªè´Ÿè´£å‰¯æœ¬å’Œåˆ†åŒºçš„çŠ¶æ€è½¬æ¢ï¼Œä»¥ä¿æŒå‰¯æœ¬å¯¹è±¡å’Œåˆ†åŒºå¯¹è±¡åœ¨é›†ç¾¤ä¸Šçš„ä¸€è‡´æ€§çŠ¶æ€ã€‚è¿™ä¸¤ä¸ªçŠ¶æ€æœºæ˜¯åé¢ä¸¤è®²çš„é‡è¦çŸ¥è¯†ç‚¹ã€‚</li>\n<li>clientï¼šå‰é¢ä»‹ç»çš„DeletionClientæ¥å£ã€‚TopicDeletionManageré€šè¿‡è¯¥æ¥å£æ‰§è¡ŒZooKeeperä¸ŠèŠ‚ç‚¹çš„ç›¸åº”æ›´æ–°ã€‚</li>\n<li>isDeleteTopicEnabledï¼šè¡¨æ˜ä¸»é¢˜æ˜¯å¦å…è®¸è¢«åˆ é™¤ã€‚å®ƒæ˜¯Brokerç«¯å‚æ•°delete.topic.enableçš„å€¼ï¼Œé»˜è®¤æ˜¯trueï¼Œè¡¨ç¤ºKafkaå…è®¸åˆ é™¤ä¸»é¢˜ã€‚æºç ä¸­å¤§é‡ä½¿ç”¨è¿™ä¸ªå­—æ®µåˆ¤æ–­ä¸»é¢˜çš„å¯åˆ é™¤æ€§ã€‚å‰é¢çš„configå‚æ•°çš„ä¸»è¦ç›®çš„å°±æ˜¯è®¾ç½®è¿™ä¸ªå­—æ®µçš„å€¼ã€‚è¢«è®¾å®šä¹‹åï¼Œconfigå°±ä¸å†è¢«æºç ä½¿ç”¨äº†ã€‚</li>\n</ul><p>å¥½äº†ï¼ŒçŸ¥é“è¿™äº›å­—æ®µçš„å«ä¹‰ï¼Œæˆ‘ä»¬å†çœ‹çœ‹TopicDeletionManagerç±»å®ä¾‹æ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„ã€‚</p><p>å®é™…ä¸Šï¼Œè¿™ä¸ªå®ä¾‹æ˜¯åœ¨KafkaControllerç±»åˆå§‹åŒ–æ—¶è¢«åˆ›å»ºçš„ã€‚åœ¨KafkaControllerç±»çš„æºç ä¸­ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰¾åˆ°è¿™è¡Œä»£ç ï¼š</p><pre><code>val topicDeletionManager = new TopicDeletionManager(config, controllerContext, replicaStateMachine,\n  partitionStateMachine, new ControllerDeletionClient(this, zkClient))\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œä»£ç å®ä¾‹åŒ–äº†ä¸€ä¸ªå…¨æ–°çš„ControllerDeletionClientå¯¹è±¡ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ªå¯¹è±¡å®ä¾‹å’ŒreplicaStateMachineã€partitionStateMachineï¼Œä¸€èµ·åˆ›å»ºTopicDeletionManagerå®ä¾‹ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘å†ç»™ä½ ç”»ä¸€å¼ æµç¨‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/89/e6/89733b9e03df6e1450ba81e082187ce6.jpg?wh=1449*2175\" alt=\"\"></p><h2>TopicDeletionManageré‡è¦æ–¹æ³•</h2><p>é™¤äº†ç±»å®šä¹‰å’Œåˆå§‹åŒ–ï¼ŒTopicDeletionManagerç±»è¿˜å®šä¹‰äº†16ä¸ªæ–¹æ³•ã€‚åœ¨è¿™äº›æ–¹æ³•ä¸­ï¼Œæœ€é‡è¦çš„å½“å±resumeDeletionsæ–¹æ³•ã€‚å®ƒæ˜¯é‡å¯ä¸»é¢˜åˆ é™¤æ“ä½œè¿‡ç¨‹çš„æ–¹æ³•ã€‚</p><p>ä¸»é¢˜å› ä¸ºæŸäº›äº‹ä»¶å¯èƒ½ä¸€æ—¶æ— æ³•å®Œæˆåˆ é™¤ï¼Œæ¯”å¦‚ä¸»é¢˜åˆ†åŒºæ­£åœ¨è¿›è¡Œå‰¯æœ¬é‡åˆ†é…ç­‰ã€‚ä¸€æ—¦è¿™äº›äº‹ä»¶å®Œæˆåï¼Œä¸»é¢˜é‡æ–°å…·å¤‡å¯åˆ é™¤çš„èµ„æ ¼ã€‚æ­¤æ—¶ï¼Œä»£ç å°±éœ€è¦è°ƒç”¨resumeDeletionsé‡å¯åˆ é™¤æ“ä½œã€‚</p><p>è¿™ä¸ªæ–¹æ³•ä¹‹æ‰€ä»¥å¾ˆé‡è¦ï¼Œæ˜¯å› ä¸ºå®ƒè¿˜ä¸²è”äº†TopicDeletionManagerç±»çš„å¾ˆå¤šæ–¹æ³•ï¼Œå¦‚completeDeleteTopicå’ŒonTopicDeletionç­‰ã€‚å› æ­¤ï¼Œä½ å®Œå…¨å¯ä»¥ä»resumeDeletionsæ–¹æ³•å¼€å§‹ï¼Œé€æ¸æ·±å…¥åˆ°å…¶ä»–æ–¹æ³•ä»£ç çš„å­¦ä¹ ã€‚</p><p>é‚£æˆ‘ä»¬å°±å…ˆå­¦ä¹ resumeDeletionsçš„å®ç°ä»£ç å§ã€‚</p><pre><code>private def resumeDeletions(): Unit = {\n  // ä»å…ƒæ•°æ®ç¼“å­˜ä¸­è·å–è¦åˆ é™¤çš„ä¸»é¢˜åˆ—è¡¨\n  val topicsQueuedForDeletion = Set.empty[String] ++ controllerContext.topicsToBeDeleted\n  // å¾…é‡è¯•ä¸»é¢˜åˆ—è¡¨\n  val topicsEligibleForRetry = mutable.Set.empty[String]\n  // å¾…åˆ é™¤ä¸»é¢˜åˆ—è¡¨\n  val topicsEligibleForDeletion = mutable.Set.empty[String]\n  if (topicsQueuedForDeletion.nonEmpty)\n    info(s&quot;Handling deletion for topics ${topicsQueuedForDeletion.mkString(&quot;,&quot;)}&quot;)\n  // éå†æ¯ä¸ªå¾…åˆ é™¤ä¸»é¢˜\n  topicsQueuedForDeletion.foreach { topic =&gt;\n    // å¦‚æœè¯¥ä¸»é¢˜æ‰€æœ‰å‰¯æœ¬å·²ç»æ˜¯ReplicaDeletionSuccessfulçŠ¶æ€\n    // å³è¯¥ä¸»é¢˜å·²ç»è¢«åˆ é™¤  \n    if (controllerContext.areAllReplicasInState(topic, ReplicaDeletionSuccessful)) {\n      // è°ƒç”¨completeDeleteTopicæ–¹æ³•å®Œæˆåç»­æ“ä½œå³å¯\n      completeDeleteTopic(topic)\n      info(s&quot;Deletion of topic $topic successfully completed&quot;)\n     // å¦‚æœä¸»é¢˜åˆ é™¤å°šæœªå¼€å§‹å¹¶ä¸”ä¸»é¢˜å½“å‰æ— æ³•æ‰§è¡Œåˆ é™¤çš„è¯\n    } else if (!controllerContext.isAnyReplicaInState(topic, ReplicaDeletionStarted)) {\n      if (controllerContext.isAnyReplicaInState(topic, ReplicaDeletionIneligible)) {\n        // æŠŠè¯¥ä¸»é¢˜åŠ åˆ°å¾…é‡è¯•ä¸»é¢˜åˆ—è¡¨ä¸­ç”¨äºåç»­é‡è¯•\n        topicsEligibleForRetry += topic\n      }\n    }\n    // å¦‚æœè¯¥ä¸»é¢˜èƒ½å¤Ÿè¢«åˆ é™¤\n    if (isTopicEligibleForDeletion(topic)) {\n      info(s&quot;Deletion of topic $topic (re)started&quot;)\n      topicsEligibleForDeletion += topic\n    }\n  }\n  // é‡è¯•å¾…é‡è¯•ä¸»é¢˜åˆ—è¡¨ä¸­çš„ä¸»é¢˜åˆ é™¤æ“ä½œ\n  if (topicsEligibleForRetry.nonEmpty) {\n    retryDeletionForIneligibleReplicas(topicsEligibleForRetry)\n  }\n  // è°ƒç”¨onTopicDeletionæ–¹æ³•ï¼Œå¯¹å¾…åˆ é™¤ä¸»é¢˜åˆ—è¡¨ä¸­çš„ä¸»é¢˜æ‰§è¡Œåˆ é™¤æ“ä½œ\n  if (topicsEligibleForDeletion.nonEmpty) {\n    onTopicDeletion(topicsEligibleForDeletion)\n  }\n}\n</code></pre><p>é€šè¿‡ä»£ç æˆ‘ä»¬å‘ç°ï¼Œè¿™ä¸ªæ–¹æ³•<strong>é¦–å…ˆ</strong>ä»å…ƒæ•°æ®ç¼“å­˜ä¸­è·å–è¦åˆ é™¤çš„ä¸»é¢˜åˆ—è¡¨ï¼Œä¹‹åå®šä¹‰äº†ä¸¤ä¸ªç©ºçš„ä¸»é¢˜åˆ—è¡¨ï¼Œåˆ†åˆ«ä¿å­˜å¾…é‡è¯•åˆ é™¤ä¸»é¢˜å’Œå¾…åˆ é™¤ä¸»é¢˜ã€‚</p><p><strong>ç„¶å</strong>ï¼Œä»£ç éå†æ¯ä¸ªè¦åˆ é™¤çš„ä¸»é¢˜ï¼Œå»çœ‹å®ƒæ‰€æœ‰å‰¯æœ¬çš„çŠ¶æ€ã€‚å¦‚æœå‰¯æœ¬çŠ¶æ€éƒ½æ˜¯ReplicaDeletionSuccessfulï¼Œå°±è¡¨æ˜è¯¥ä¸»é¢˜å·²ç»è¢«æˆåŠŸåˆ é™¤ï¼Œæ­¤æ—¶ï¼Œå†è°ƒç”¨completeDeleteTopicæ–¹æ³•ï¼Œå®Œæˆåç»­çš„æ“ä½œå°±å¯ä»¥äº†ã€‚å¯¹äºé‚£äº›åˆ é™¤æ“ä½œå°šæœªå¼€å§‹ï¼Œå¹¶ä¸”æš‚æ—¶æ— æ³•æ‰§è¡Œåˆ é™¤çš„ä¸»é¢˜ï¼Œæºç ä¼šæŠŠè¿™ç±»ä¸»é¢˜åŠ åˆ°å¾…é‡è¯•ä¸»é¢˜åˆ—è¡¨ä¸­ï¼Œç”¨äºåç»­é‡è¯•ï¼›å¦‚æœä¸»é¢˜æ˜¯èƒ½å¤Ÿè¢«åˆ é™¤çš„ï¼Œå°±å°†å…¶åŠ å…¥åˆ°å¾…åˆ é™¤åˆ—è¡¨ä¸­ã€‚</p><p><strong>æœ€å</strong>ï¼Œè¯¥æ–¹æ³•è°ƒç”¨retryDeletionForIneligibleReplicasæ–¹æ³•ï¼Œæ¥é‡è¯•å¾…é‡è¯•ä¸»é¢˜åˆ—è¡¨ä¸­çš„ä¸»é¢˜åˆ é™¤æ“ä½œã€‚å¯¹äºå¾…åˆ é™¤ä¸»é¢˜åˆ—è¡¨ä¸­çš„ä¸»é¢˜åˆ™è°ƒç”¨onTopicDeletionåˆ é™¤ä¹‹ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒretryDeletionForIneligibleReplicasæ–¹æ³•ç”¨äºé‡è¯•ä¸»é¢˜åˆ é™¤ã€‚è¿™æ˜¯é€šè¿‡å°†å¯¹åº”ä¸»é¢˜å‰¯æœ¬çš„çŠ¶æ€ï¼Œä»ReplicaDeletionIneligibleå˜æ›´åˆ°OfflineReplicaæ¥å®Œæˆçš„ã€‚è¿™æ ·ï¼Œåç»­å†æ¬¡è°ƒç”¨resumeDeletionsæ—¶ï¼Œä¼šå°è¯•é‡æ–°åˆ é™¤ä¸»é¢˜ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¬¡å‘ç°ï¼ŒKafkaçš„æ–¹æ³•å‘½åçœŸçš„æ˜¯éå¸¸è§„èŒƒã€‚å¾—ç›Šäºè¿™ä¸€ç‚¹ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¸ç”¨æ·±å…¥åˆ°æ–¹æ³•å†…éƒ¨ï¼Œå°±èƒ½çŸ¥é“è¿™ä¸ªæ–¹æ³•å¤§è‡´æ˜¯åšä»€ä¹ˆç”¨çš„ã€‚æ¯”å¦‚ï¼š</p><ul>\n<li>topicsQueuedForDeletionæ–¹æ³•ï¼Œåº”è¯¥æ˜¯ä¿å­˜å¾…åˆ é™¤çš„ä¸»é¢˜åˆ—è¡¨ï¼›</li>\n<li>controllerContext.isAnyReplicaInStateæ–¹æ³•ï¼Œåº”è¯¥æ˜¯åˆ¤æ–­æŸä¸ªä¸»é¢˜ä¸‹æ˜¯å¦æœ‰å‰¯æœ¬å¤„äºæŸç§çŠ¶æ€ï¼›</li>\n<li>è€ŒonTopicDeletionæ–¹æ³•ï¼Œåº”è¯¥å°±æ˜¯æ‰§è¡Œä¸»é¢˜åˆ é™¤æ“ä½œç”¨çš„ã€‚</li>\n</ul><p>è¿™æ—¶ï¼Œä½ å†å»é˜…è¯»è¿™3ä¸ªæ–¹æ³•çš„æºç ï¼Œå°±ä¼šå‘ç°å®ƒä»¬çš„ä½œç”¨ç¡®å®å¦‚å…¶åå­—æ ‡è¯†çš„é‚£æ ·ã€‚è¿™ä¹Ÿå†æ¬¡è¯æ˜äº†Kafkaæºç è´¨é‡æ˜¯éå¸¸ä¸é”™çš„ã€‚å› æ­¤ï¼Œä¸ç®¡ä½ æ˜¯ä¸æ˜¯Kafkaçš„ä½¿ç”¨è€…ï¼Œéƒ½å¯ä»¥æŠŠKafkaçš„æºç ä½œä¸ºé˜…è¯»å¼€æºæ¡†æ¶æºç ã€æå‡è‡ªå·±ç«äº‰åŠ›çš„ä¸€ä¸ªé€‰æ‹©ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘å†ç”¨ä¸€å¼ å›¾æ¥è§£é‡Šä¸‹resumeDeletionsæ–¹æ³•çš„æ‰§è¡Œæµç¨‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d1/34/d165193d4f27ffe18e038643ea050534.jpg?wh=2504*3969\" alt=\"\"></p><p>åˆ°è¿™é‡Œï¼ŒresumeDeletionsæ–¹æ³•çš„é€»è¾‘æˆ‘å°±è®²å®Œäº†ï¼Œå®ƒæœç„¶æ˜¯ä¸²è”èµ·äº†TopicDeletionMangerä¸­å®šä¹‰çš„å¾ˆå¤šæ–¹æ³•ã€‚å…¶ä¸­ï¼Œæ¯”è¾ƒå…³é”®çš„ä¸¤ä¸ªæ“ä½œæ˜¯<strong>completeDeleteTopic</strong>å’Œ<strong>onTopicDeletion</strong>ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åˆ†åˆ«çœ‹çœ‹ã€‚</p><p>å…ˆæ¥çœ‹completeDeleteTopicæ–¹æ³•ä»£ç ï¼Œæˆ‘ç»™æ¯è¡Œä»£ç éƒ½åŠ æ ‡äº†æ³¨è§£ã€‚</p><pre><code>private def completeDeleteTopic(topic: String): Unit = {\n  // ç¬¬1æ­¥ï¼šæ³¨é”€åˆ†åŒºå˜æ›´ç›‘å¬å™¨ï¼Œé˜²æ­¢åˆ é™¤è¿‡ç¨‹ä¸­å› åˆ†åŒºæ•°æ®å˜æ›´\n  // å¯¼è‡´ç›‘å¬å™¨è¢«è§¦å‘ï¼Œå¼•èµ·çŠ¶æ€ä¸ä¸€è‡´\n  client.mutePartitionModifications(topic)\n  // ç¬¬2æ­¥ï¼šè·å–è¯¥ä¸»é¢˜ä¸‹å¤„äºReplicaDeletionSuccessfulçŠ¶æ€çš„æ‰€æœ‰å‰¯æœ¬å¯¹è±¡ï¼Œ\n  // å³æ‰€æœ‰å·²ç»è¢«æˆåŠŸåˆ é™¤çš„å‰¯æœ¬å¯¹è±¡\n  val replicasForDeletedTopic = controllerContext.replicasInState(topic, ReplicaDeletionSuccessful)\n  // ç¬¬3æ­¥ï¼šåˆ©ç”¨å‰¯æœ¬çŠ¶æ€æœºå°†è¿™äº›å‰¯æœ¬å¯¹è±¡è½¬æ¢æˆNonExistentReplicaçŠ¶æ€ã€‚\n  // ç­‰åŒäºåœ¨çŠ¶æ€æœºä¸­åˆ é™¤è¿™äº›å‰¯æœ¬\n  replicaStateMachine.handleStateChanges(\n    replicasForDeletedTopic.toSeq, NonExistentReplica)\n  // ç¬¬4æ­¥ï¼šæ›´æ–°å…ƒæ•°æ®ç¼“å­˜ä¸­çš„å¾…åˆ é™¤ä¸»é¢˜åˆ—è¡¨å’Œå·²å¼€å§‹åˆ é™¤çš„ä¸»é¢˜åˆ—è¡¨\n  // å› ä¸ºä¸»é¢˜å·²ç»æˆåŠŸåˆ é™¤äº†ï¼Œæ²¡æœ‰å¿…è¦å‡ºç°åœ¨è¿™ä¸¤ä¸ªåˆ—è¡¨ä¸­äº†\n  controllerContext.topicsToBeDeleted -= topic\n  controllerContext.topicsWithDeletionStarted -= topic\n  // ç¬¬5æ­¥ï¼šç§»é™¤ZooKeeperä¸Šå…³äºè¯¥ä¸»é¢˜çš„ä¸€åˆ‡â€œç—•è¿¹â€\n  client.deleteTopic(topic, controllerContext.epochZkVersion)\n  // ç¬¬6æ­¥ï¼šç§»é™¤å…ƒæ•°æ®ç¼“å­˜ä¸­å…³äºè¯¥ä¸»é¢˜çš„ä¸€åˆ‡â€œç—•è¿¹â€\n  controllerContext.removeTopic(topic)\n}\n</code></pre><p>æ•´ä¸ªè¿‡ç¨‹å¦‚è¡Œäº‘æµæ°´èˆ¬ä¸€æ°”å‘µæˆï¼Œéå¸¸å®¹æ˜“ç†è§£ï¼Œæˆ‘å°±ä¸å¤šè§£é‡Šäº†ã€‚</p><p>å†æ¥çœ‹çœ‹onTopicDeletionæ–¹æ³•çš„ä»£ç ï¼š</p><pre><code>private def onTopicDeletion(topics: Set[String]): Unit = {\n  // æ‰¾å‡ºç»™å®šå¾…åˆ é™¤ä¸»é¢˜åˆ—è¡¨ä¸­é‚£äº›å°šæœªå¼€å¯åˆ é™¤æ“ä½œçš„æ‰€æœ‰ä¸»é¢˜\n  val unseenTopicsForDeletion = topics.diff(controllerContext.topicsWithDeletionStarted)\n  if (unseenTopicsForDeletion.nonEmpty) {\n    // è·å–åˆ°è¿™äº›ä¸»é¢˜çš„æ‰€æœ‰åˆ†åŒºå¯¹è±¡\n    val unseenPartitionsForDeletion = unseenTopicsForDeletion.flatMap(controllerContext.partitionsForTopic)\n    // å°†è¿™äº›åˆ†åŒºçš„çŠ¶æ€ä¾æ¬¡è°ƒæ•´æˆOfflinePartitionå’ŒNonExistentPartition\n    // ç­‰åŒäºå°†è¿™äº›åˆ†åŒºä»åˆ†åŒºçŠ¶æ€æœºä¸­åˆ é™¤\n    partitionStateMachine.handleStateChanges(\n      unseenPartitionsForDeletion.toSeq, OfflinePartition)\n    partitionStateMachine.handleStateChanges(\n      unseenPartitionsForDeletion.toSeq, NonExistentPartition)\n    // æŠŠè¿™äº›ä¸»é¢˜åŠ åˆ°â€œå·²å¼€å¯åˆ é™¤æ“ä½œâ€ä¸»é¢˜åˆ—è¡¨ä¸­\n    controllerContext.beginTopicDeletion(unseenTopicsForDeletion)\n  }\n  // ç»™é›†ç¾¤æ‰€æœ‰Brokerå‘é€å…ƒæ•°æ®æ›´æ–°è¯·æ±‚ï¼Œå‘Šè¯‰å®ƒä»¬ä¸è¦å†ä¸ºè¿™äº›ä¸»é¢˜å¤„ç†æ•°æ®äº†\n  client.sendMetadataUpdate(\n    topics.flatMap(controllerContext.partitionsForTopic))\n  // åˆ†åŒºåˆ é™¤æ“ä½œä¼šæ‰§è¡Œåº•å±‚çš„ç‰©ç†ç£ç›˜æ–‡ä»¶åˆ é™¤åŠ¨ä½œ\n  onPartitionDeletion(topics)\n}\n</code></pre><p>æˆ‘åœ¨ä»£ç ä¸­ç”¨æ³¨é‡Šçš„æ–¹å¼ï¼Œå·²ç»æŠŠonTopicDeletionæ–¹æ³•çš„é€»è¾‘è§£é‡Šæ¸…æ¥šäº†ã€‚ä½ å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæ–¹æ³•ä¹ŸåŸºæœ¬æ˜¯ä¸²è¡ŒåŒ–çš„æµç¨‹ï¼Œæ²¡ä»€ä¹ˆéš¾ç†è§£çš„ã€‚æˆ‘å†ç»™ä½ æ¢³ç†ä¸‹å…¶ä¸­çš„æ ¸å¿ƒç‚¹ã€‚</p><p>onTopicDeletionæ–¹æ³•ä¼šå¤šæ¬¡ä½¿ç”¨åˆ†åŒºçŠ¶æ€æœºï¼Œæ¥è°ƒæ•´å¾…åˆ é™¤ä¸»é¢˜çš„åˆ†åŒºçŠ¶æ€ã€‚åœ¨åä¸¤è®²çš„åˆ†åŒºçŠ¶æ€æœºå’Œå‰¯æœ¬çŠ¶æ€æœºçš„è¯¾é‡Œé¢ï¼Œæˆ‘è¿˜ä¼šå’Œä½ è¯¦ç»†è®²è§£å®ƒä»¬ï¼ŒåŒ…æ‹¬å®ƒä»¬éƒ½å®šä¹‰äº†å“ªäº›çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€å½¼æ­¤ä¹‹é—´çš„è½¬æ¢è§„åˆ™éƒ½æ˜¯ä»€ä¹ˆï¼Œç­‰ç­‰ã€‚</p><p>onTopicDeletionæ–¹æ³•çš„æœ€åä¸€è¡Œè°ƒç”¨äº†onPartitionDeletionæ–¹æ³•ï¼Œæ¥æ‰§è¡ŒçœŸæ­£çš„åº•å±‚ç‰©ç†ç£ç›˜æ–‡ä»¶åˆ é™¤ã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯é€šè¿‡å‰¯æœ¬çŠ¶æ€æœºçŠ¶æ€è½¬æ¢æ“ä½œå®Œæˆçš„ã€‚ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä¼šå’Œä½ è¯¦ç»†èŠèŠè¿™ä¸ªäº‹æƒ…ã€‚</p><p>å­¦åˆ°è¿™é‡Œï¼Œæˆ‘è¿˜æƒ³æé†’ä½ çš„æ˜¯ï¼Œåœ¨å­¦ä¹ TopicDeletionManageræ–¹æ³•çš„æ—¶å€™ï¼Œéå¸¸é‡è¦ä¸€ç‚¹çš„æ˜¯ï¼Œä½ è¦ç†è§£ä¸»é¢˜åˆ é™¤çš„è„‰ç»œã€‚å¯¹äºå…¶ä»–éƒ¨åˆ†çš„æºç ï¼Œä¹Ÿæ˜¯è¿™ä¸ªé“ç†ã€‚ä¸€æ—¦ä½ æŒæ¡äº†æ•´ä½“çš„æµç¨‹ï¼Œé˜…è¯»é‚£äº›ç»†ææœ«èŠ‚çš„æ–¹æ³•ä»£ç å°±æ²¡æœ‰ä»»ä½•éš¾åº¦äº†ã€‚ç…§ç€è¿™ä¸ªæ–¹æ³•å»è¯»æºç ï¼Œææ‡‚Kafkaæºç ä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹ï¼</p><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ äº†TopicDeletionManager.scalaä¸­å…³äºä¸»é¢˜åˆ é™¤çš„ä»£ç ã€‚è¿™é‡Œæœ‰å‡ ä¸ªè¦ç‚¹ï¼Œéœ€è¦ä½ è®°ä½ã€‚</p><ul>\n<li>åœ¨ä¸»é¢˜åˆ é™¤è¿‡ç¨‹ä¸­ï¼ŒKafkaä¼šè°ƒæ•´é›†ç¾¤ä¸­ä¸‰ä¸ªåœ°æ–¹çš„æ•°æ®ï¼šZooKeeperã€å…ƒæ•°æ®ç¼“å­˜å’Œç£ç›˜æ—¥å¿—æ–‡ä»¶ã€‚åˆ é™¤ä¸»é¢˜æ—¶ï¼ŒZooKeeperä¸Šä¸è¯¥ä¸»é¢˜ç›¸å…³çš„æ‰€æœ‰ZNodeèŠ‚ç‚¹å¿…é¡»è¢«æ¸…é™¤ï¼›Controllerç«¯å…ƒæ•°æ®ç¼“å­˜ä¸­çš„ç›¸å…³é¡¹ï¼Œä¹Ÿå¿…é¡»è¦è¢«å¤„ç†ï¼Œå¹¶ä¸”è¦è¢«åŒæ­¥åˆ°é›†ç¾¤çš„å…¶ä»–Brokerä¸Šï¼›è€Œç£ç›˜æ—¥å¿—æ–‡ä»¶ï¼Œæ›´æ˜¯è¦æ¸…ç†çš„é¦–è¦ç›®æ ‡ã€‚è¿™ä¸‰ä¸ªåœ°æ–¹å¿…é¡»è¦ç»Ÿä¸€å¤„ç†ï¼Œå°±å¥½ä¼¼æˆ‘ä»¬å¸¸è¯´çš„åŸå­æ€§æ“ä½œä¸€æ ·ã€‚ç°åœ¨å›æƒ³ä¸‹å¼€ç¯‡æåˆ°çš„é‚£ä¸ªâ€œç§˜ç±â€ï¼Œä½ å°±ä¼šå‘ç°å®ƒç¼ºå°‘äº†éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œé‚£å°±æ˜¯ï¼š<strong>æ— æ³•æ¸…é™¤Controllerç«¯çš„å…ƒæ•°æ®ç¼“å­˜é¡¹</strong>ã€‚å› æ­¤ï¼Œä½ è¦å°½åŠ›é¿å…ä½¿ç”¨è¿™ä¸ªâ€œå¤§æ‹›â€ã€‚</li>\n<li>DeletionClientæ¥å£çš„ä½œç”¨ï¼Œä¸»è¦æ˜¯æ“ä½œZooKeeperï¼Œå®ç°ZooKeeperèŠ‚ç‚¹çš„åˆ é™¤ç­‰æ“ä½œã€‚</li>\n<li>TopicDeletionManagerï¼Œæ˜¯åœ¨KafkaControlleråˆ›å»ºè¿‡ç¨‹ä¸­è¢«åˆå§‹åŒ–çš„ï¼Œä¸»è¦é€šè¿‡ä¸å…ƒæ•°æ®ç¼“å­˜è¿›è¡Œäº¤äº’çš„æ–¹å¼ï¼Œæ¥æ›´æ–°å„ç±»æ•°æ®ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/3a/3c/3a47958f44b81cef7b502da53495ef3c.jpg?wh=2250*1332\" alt=\"\"></p><p>ä»Šå¤©æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ä¸­å‡ºç°äº†å¤§é‡çš„replicaStateMachineå’ŒpartitionStateMachineï¼Œå…¶å®è¿™å°±æ˜¯æˆ‘ä»Šå¤©åå¤æåˆ°çš„å‰¯æœ¬çŠ¶æ€æœºå’Œåˆ†åŒºçŠ¶æ€æœºã€‚æ¥ä¸‹æ¥ä¸¤è®²ï¼Œæˆ‘ä¼šé€æ­¥å¸¦ä½ èµ°è¿›å®ƒä»¬çš„ä»£ç ä¸–ç•Œï¼Œè®©ä½ é¢†ç•¥ä¸‹Kafkaé€šè¿‡çŠ¶æ€æœºæœºåˆ¶ç®¡ç†å‰¯æœ¬å’Œåˆ†åŒºçš„é£é‡‡ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ processTopicDeletionæ–¹æ³•çš„ä»£ç æ—¶ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªåä¸ºmarkTopicIneligibleForDeletionçš„æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯å’Œä¸»é¢˜åˆ é™¤ç›¸å…³çš„æ–¹æ³•ã€‚ç°åœ¨ï¼Œä½ èƒ½è¯´è¯´ï¼Œå®ƒæ˜¯åšä»€ä¹ˆç”¨çš„ã€å®ƒçš„å®ç°åŸç†åˆæ˜¯æ€æ ·çš„å—ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":222223,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1590719746,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720384455004e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œå’±ä»¬ç»“åˆæºç é‡ç‚¹äº†è§£äº†Controlleråœ¨é›†ç¾¤ä¸­çš„ä½œç”¨ã€‚è¯¾åæˆ‘è¯·ä½ æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨è„šæœ¬å‘½ä»¤å¢åŠ ä¸€ä¸ªä¸»é¢˜çš„åˆ†åŒºï¼Œä½ çŸ¥é“åº”è¯¥ç”¨KafkaControllerç±»ä¸­çš„å“ªä¸ªæ–¹æ³•å—ï¼Ÿå…¶å®ï¼ŒKafkaControllerçš„onNewPartitionCreationæ–¹æ³•æ˜¯å¤„ç†æ–°åˆ†åŒºå¢åŠ é€»è¾‘çš„ã€‚å®ƒåŒ…æ‹¬è¦å°†æ–°åˆ†åŒºçŠ¶æ€è°ƒæ•´åˆ°OnlineçŠ¶æ€ä»¥åŠå°†å¯¹åº”å‰¯æœ¬çš„çŠ¶æ€è®¾ç½®æˆOnlineã€‚<br><br>okayï¼Œä½ åŒæ„è¿™ä¸ªè¯´æ³•å—ï¼Ÿæˆ–è€…è¯´ä½ æœ‰å…¶ä»–çš„çœ‹æ³•å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":0},{"had_liked":false,"id":272851,"user_name":"æ˜¯ç”·äººå°±å¼€å·´å·´æ‰˜æ–¯","can_delete":false,"product_type":"c1","uid":1352006,"ip_address":"","ucode":"C65873BBB28D05","user_header":"https://static001.geekbang.org/account/avatar/00/14/a1/46/3136ac25.jpg","comment_is_top":false,"comment_ctime":1610332805,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5905300101","product_id":100050101,"comment_content":"mutePartitionModificationsæ˜¯ä¸ºäº†ä¸è¦è®©watcherå“åº”zk topicå„ä¸ªåˆ†åŒºå­èŠ‚ç‚¹é€ä¸ªè¢«åˆ é™¤çš„å˜åŒ–ã€‚<br>åˆ é™¤æ˜¯ä»åˆ†åŒºèŠ‚ç‚¹åˆ°topicèŠ‚ç‚¹é€’å½’æ‰§è¡Œçš„ï¼Œå› ä¸ºzkä¸èƒ½åœ¨æœ‰å­èŠ‚ç‚¹çš„æƒ…å†µä¸‹ç›´æ¥åˆ é™¤çˆ¶èŠ‚ç‚¹ã€‚<br><br>æ–°åŠ åˆ†åŒºä¸åˆ é™¤topicèŠ‚ç‚¹çš„äº’æ–¥è¿˜æ˜¯åœ¨handleCreatePartitionsRequestå‡½æ•°é‡Œåšçš„checkã€‚","like_count":2,"discussions":[{"author":{"id":1181055,"avatar":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","nickname":"z.l","note":"","ucode":"805CC5784D3F76","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586644,"discussion_content":"æˆ‘è§‰å¾—ä½ è¿™ä¸ªæ›´æœ‰é“ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662393842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261706,"user_name":"flyCoder","can_delete":false,"product_type":"c1","uid":1074897,"ip_address":"","ucode":"82FB7B60775978","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/d1/8664c464.jpg","comment_is_top":false,"comment_ctime":1605496306,"is_pvip":true,"replies":[{"id":"95343","content":"æ‰“å¼€æ–‡ä»¶æ•°å¤ªå¤šè¿™ä»¶äº‹ç¤¾åŒºæ›¾ç»æœ‰å‡ ä¸ªbugè·Ÿè¿‡ï¼Œåœ¨æ–°ä¸€ç‚¹çš„ç‰ˆæœ¬ï¼ˆæ¯”å¦‚2.0ä¹‹åï¼‰ä¹‹åå·²ç»ä¸å¤ªå¸¸è§äº†ï¼Œä¸å¦¨å‡çº§ä¸‹çœ‹çœ‹ã€‚å¦å¤–ulimit -n ä¸å¦¨è®¾ç½®å¤§ä¸€ç‚¹ã€‚","user_name":"ä½œè€…å›å¤","comment_id":261706,"uid":"1288090","ip_address":"","utype":1,"ctime":1605838567,"user_name_real":"èƒ¡å¤•"}],"discussion_count":2,"race_medal":0,"score":"1605496306","product_id":100050101,"comment_content":"èƒ¡è€å¸ˆï¼Œé‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œèƒ½å¸®å¿™åˆ†æä¸‹å—ï¼Ÿhttps:&#47;&#47;www.orchome.com&#47;1085","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509574,"discussion_content":"æ‰“å¼€æ–‡ä»¶æ•°å¤ªå¤šè¿™ä»¶äº‹ç¤¾åŒºæ›¾ç»æœ‰å‡ ä¸ªbugè·Ÿè¿‡ï¼Œåœ¨æ–°ä¸€ç‚¹çš„ç‰ˆæœ¬ï¼ˆæ¯”å¦‚2.0ä¹‹åï¼‰ä¹‹åå·²ç»ä¸å¤ªå¸¸è§äº†ï¼Œä¸å¦¨å‡çº§ä¸‹çœ‹çœ‹ã€‚å¦å¤–ulimit -n ä¸å¦¨è®¾ç½®å¤§ä¸€ç‚¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605838567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1074897,"avatar":"https://static001.geekbang.org/account/avatar/00/10/66/d1/8664c464.jpg","nickname":"flyCoder","note":"","ucode":"82FB7B60775978","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328184,"discussion_content":"ulimit -nå‚æ•°æœ‰è°ƒæ•´è¿‡ï¼Œè¿˜æ˜¯ä¼šå‡ºç°æ‰“å¼€è¿‡å¤šçš„æƒ…å†µï¼Œæˆ‘ç›®å‰å‡çº§åˆ°2.0ä»¥åçš„ç‰ˆæœ¬äº†ï¼Œå†è§‚å¯Ÿä¸€æ®µæ—¶é—´","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606097292,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243971,"user_name":"å¼ å­æ¶µ","can_delete":false,"product_type":"c1","uid":1743397,"ip_address":"","ucode":"57C509EA32B916","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg","comment_is_top":false,"comment_ctime":1598342929,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598342929","product_id":100050101,"comment_content":"def enqueueTopicsForDeletion(topics: Set[String]): Unit = {<br>    if (isDeleteTopicEnabled) {<br>      controllerContext.queueTopicDeletion(topics)<br>      resumeDeletions()<br>    }<br>  }åˆšå»ç ”ç©¶äº†ä¸€ä¸‹enqueueTopicsForDeletionæ–¹æ³•æºç <br>val isDeleteTopicEnabled: Boolean = config.deleteTopicEnable<br><br> def queueTopicDeletion(topics: Set[String]): Unit = {<br>    topicsToBeDeleted ++= topics<br>}<br>å¯ä»¥åˆ é™¤çš„topicä¼šæ·»åŠ è¿›åˆ é™¤é˜Ÿåˆ—ï¼Œä¸å¯åˆ é™¤çš„ä¼šé‡æ–°è°ƒç”¨resumeDeletionsæ–¹æ³•<br>","like_count":0},{"had_liked":false,"id":243965,"user_name":"å¼ å­æ¶µ","can_delete":false,"product_type":"c1","uid":1743397,"ip_address":"","ucode":"57C509EA32B916","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg","comment_is_top":false,"comment_ctime":1598341969,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598341969","product_id":100050101,"comment_content":"if (config.deleteTopicEnable) {<br>      if (topicsToBeDeleted.nonEmpty) {<br>        info(s&quot;Starting topic deletion for topics ${topicsToBeDeleted.mkString(&quot;,&quot;)}&quot;)<br>        &#47;&#47; mark topic ineligible for deletion if other state changes are in progress<br>        topicsToBeDeleted.foreach { topic =&gt;<br>          val partitionReassignmentInProgress =<br>            controllerContext.partitionsBeingReassigned.map(_.topic).contains(topic)<br>          if (partitionReassignmentInProgress)<br>            topicDeletionManager.markTopicIneligibleForDeletion(Set(topic),<br>              reason = &quot;topic reassignment in progress&quot;)<br>        }<br>        &#47;&#47; add topic to deletion list<br>        topicDeletionManager.enqueueTopicsForDeletion(topicsToBeDeleted)<br>      }  <br>â‘ æ ¹æ®é…ç½®ä¿¡æ¯æ˜¯å¦è¿›è¡Œä¸»é¢˜åˆ é™¤ æ˜¯åˆ™è¿›è¡Œä¸‹ä¸€æ­¥<br>â‘¡åˆ¤æ–­è¦åˆ é™¤çš„ä¸»é¢˜æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è¿›è¡Œä¸‹ä¸€æ­¥<br>â‘¢è¿›è¡Œè¿­ä»£åˆ¤æ–­ï¼Œä¸»é¢˜æ˜¯å¦åœ¨partitionsBeingReassignedé›†åˆä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å°†ä¸»é¢˜æ·»åŠ è¿›markTopicIneligibleForDeletion æ ‡å¿—ä¸ºä¸»é¢˜æ­£åœ¨é‡æ–°åˆ†é… ä¸å¯åˆ é™¤<br><br>æœ‰ä¸€ç‚¹ç–‘é—®æ˜¯ä¸ºä»€ä¹ˆæ²¡æœ‰ä»topicsToBeDeletedé›†åˆä¸­æŠŠä¸å¯åˆ é™¤ä¸»é¢˜ç§»é™¤çš„æ­¥éª¤ï¼Œç„¶åå°±ç›´æ¥å°†topicsToBeDeletedæ·»åŠ è¿›åˆ é™¤é˜Ÿåˆ—äº†","like_count":0},{"had_liked":false,"id":232065,"user_name":"å°åˆ€","can_delete":false,"product_type":"c1","uid":1070261,"ip_address":"","ucode":"785923D8F0D46A","user_header":"https://static001.geekbang.org/account/avatar/00/10/54/b5/310dae7b.jpg","comment_is_top":false,"comment_ctime":1593848152,"is_pvip":false,"replies":[{"id":"85769","content":"æ²¡æœ‰å¤ªå¥½çš„æ–¹æ³•","user_name":"ä½œè€…å›å¤","comment_id":232065,"uid":"1288090","ip_address":"","utype":1,"ctime":1593998979,"user_name_real":"èƒ¡å¤•"}],"discussion_count":2,"race_medal":0,"score":"1593848152","product_id":100050101,"comment_content":"stream DSLä¸­é™¤äº†é€šè¿‡ç¼©çŸ­æ—¶é—´çª—å£å¯ä»¥å‡å°state.dirï¼ˆ&#47;tmp&#47;kafka-streamsï¼‰çš„å¤§å°ä¹‹å¤–è¿˜æœ‰åˆ«çš„æ–¹å¼ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500495,"discussion_content":"æ²¡æœ‰å¤ªå¥½çš„æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593998979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1070261,"avatar":"https://static001.geekbang.org/account/avatar/00/10/54/b5/310dae7b.jpg","nickname":"å°åˆ€","note":"","ucode":"785923D8F0D46A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288908,"discussion_content":"æˆ‘è‡ªå·±å›ç­”ä¸‹ï¼ŒKIP-479ï¼Œstream join streamåœ¨2.4ç‰ˆæœ¬ä¹‹åæ‰æ·»åŠ äº†Materialized","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593929224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230135,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1593272209,"is_pvip":false,"replies":[{"id":"85032","content":"â€œcontrollerContextç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå¯èƒ½ä¼šå’Œå½“å‰çš„çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µâ€  æ¯”å¦‚ï¼Ÿèƒ½å¦ä¸¾ä¸ªä¾‹å­ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":230135,"uid":"1288090","ip_address":"","utype":1,"ctime":1593388547,"user_name_real":"èƒ¡å¤•"}],"discussion_count":1,"race_medal":0,"score":"1593272209","product_id":100050101,"comment_content":"controllerContext ä¸­çš„ topicsToBeDeleted ï¼ˆå¾…åˆ é™¤ä¸»é¢˜åˆ—è¡¨ï¼‰å’Œ zkä¸­çš„ &#47;delete_topicsåˆ—è¡¨ è¿›è¡Œ &amp;å¾—åˆ°æš‚æ—¶ä¸å¯åˆ é™¤çš„topicã€‚<br>æš‚æ—¶ä¸å¯åˆ é™¤çš„åŸå› ï¼š<br>1ã€topicå­˜åœ¨çš„éƒ¨åˆ†å‰¯æœ¬downäº†<br>2ã€å½“å‰topicçš„éƒ¨åˆ†åˆ†åŒºæ­£åœ¨reassignment<br>æˆ‘ç†è§£ä¸ºæ˜¯controllerContextç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå¯èƒ½ä¼šå’Œå½“å‰çš„çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499774,"discussion_content":"â€œcontrollerContextç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå¯èƒ½ä¼šå’Œå½“å‰çš„çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µâ€  æ¯”å¦‚ï¼Ÿèƒ½å¦ä¸¾ä¸ªä¾‹å­ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593388547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222407,"user_name":"ä¼¯å®‰çŸ¥å¿ƒ","can_delete":false,"product_type":"c1","uid":1961835,"ip_address":"","ucode":"6C17706658672C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg","comment_is_top":false,"comment_ctime":1590796738,"is_pvip":false,"replies":[{"id":"82075","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":222407,"uid":"1288090","ip_address":"","utype":1,"ctime":1590847811,"user_name_real":"èƒ¡å¤•"}],"discussion_count":1,"race_medal":0,"score":"1590796738","product_id":100050101,"comment_content":"ä¸ç¬¦åˆåˆ é™¤çš„æ¡ä»¶ åœ¨è¿™é‡Œå®ç°ï¼Œå‰¯æœ¬å…³é—­åœæ­¢åˆ é™¤ï¼Œæ­£åœ¨é‡æ–°åˆ†åŒºï¼ˆæ‰©å®¹åˆ°æ–°çš„brokerï¼‰çš„ä¸å¯åˆ é™¤ã€‚ä¸»è¦åšé€»è¾‘ä¸â€œ&amp;â€æ“ä½œå¾—åˆ°ä¸ç¬¦åˆåˆ é™¤çš„topicã€‚ä¸ç¬¦åˆåˆ é™¤çš„æ¡ä»¶ åœ¨è¿™é‡Œå®ç°ï¼Œå‰¯æœ¬å…³é—­åœæ­¢åˆ é™¤ï¼Œæ­£åœ¨é‡æ–°åˆ†åŒºï¼ˆæ‰©å®¹åˆ°æ–°çš„brokerï¼‰çš„ä¸å¯åˆ é™¤ã€‚ä¸»è¦åšé€»è¾‘ä¸â€œ&amp;â€æ“ä½œå¾—åˆ°ä¸ç¬¦åˆåˆ é™¤çš„topicã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496781,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590847811,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}