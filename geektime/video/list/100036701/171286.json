{"id":171286,"title":"46 | 优化使用：如何让应用丝般“平滑”？","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":161522,"user_name":"Peter","can_delete":false,"product_type":"c3","uid":1595382,"ip_address":"","ucode":"A77322C4E07B2D","user_header":"https://static001.geekbang.org/account/avatar/00/18/57/f6/2c7ac1ad.jpg","comment_is_top":false,"comment_ctime":1576222914,"is_pvip":false,"replies":[{"id":61540,"content":"确实是个好东西，只是大多项目都不开启，一方面没场景，另外一个因素在于大多项目是通用组件也不知道设置多少合适，设置太大了吧等于没设置，设置太小了误伤，带来延时增大许多，你说的预估方法还是要根据具体需求来，特别要考虑的是对下游的冲击，如果你在某个流量下会冲垮下游，那这个值就是最大值。\n另外。如果你要设置。建议可配置，到时候加上前面介绍的监控，持续观察并调整就好了。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576234419,"ip_address":"","comment_id":161522,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师问题时间：流量整形是个好东西，可是我们有什么办法能准确预估出我们的读写限制呢？业界有什么常用的工具或者方法吗？","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477748,"discussion_content":"确实是个好东西，只是大多项目都不开启，一方面没场景，另外一个因素在于大多项目是通用组件也不知道设置多少合适，设置太大了吧等于没设置，设置太小了误伤，带来延时增大许多，你说的预估方法还是要根据具体需求来，特别要考虑的是对下游的冲击，如果你在某个流量下会冲垮下游，那这个值就是最大值。\n另外。如果你要设置。建议可配置，到时候加上前面介绍的监控，持续观察并调整就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576234419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159506,"user_name":"Gary","can_delete":false,"product_type":"c3","uid":1218372,"ip_address":"","ucode":"12265D6A578113","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/44/3929e620.jpg","comment_is_top":false,"comment_ctime":1575640903,"is_pvip":false,"replies":[{"id":61732,"content":"netty本身不好抽象出这个功能，因为netty不关心业务数据本身，而qos的决定是由业务数据（报文）决定的，所以不好添加这样的handler；\n如果加了，也有点奇怪。因为现在对于大多协议的支持都是停留在codec层，而handler包才是脱离具体应用层协议最通用的。所以加哪都不合适。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576482684,"ip_address":"","comment_id":159506,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"确实全面，比我们自己实现考虑的东西更多，不知道有没有跟mqtt类似的质量控制，当然也可以自己实现了，不过这种通用的、可以抽象出来的机制还是应该支持的","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477082,"discussion_content":"netty本身不好抽象出这个功能，因为netty不关心业务数据本身，而qos的决定是由业务数据（报文）决定的，所以不好添加这样的handler；\n如果加了，也有点奇怪。因为现在对于大多协议的支持都是停留在codec层，而handler包才是脱离具体应用层协议最通用的。所以加哪都不合适。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576482684,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218372,"avatar":"https://static001.geekbang.org/account/avatar/00/12/97/44/3929e620.jpg","nickname":"Gary","note":"","ucode":"12265D6A578113","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":74345,"discussion_content":"qos","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575643270,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157376,"user_name":"Stephen","can_delete":false,"product_type":"c3","uid":1129549,"ip_address":"","ucode":"6210B499F0A8E5","user_header":"https://static001.geekbang.org/account/avatar/00/11/3c/4d/0db7b5dc.jpg","comment_is_top":false,"comment_ctime":1575125089,"is_pvip":false,"replies":[{"id":61255,"content":"是的，准确的说背压是流控的手段之一，还有别的。别人直接丢数据的节流等等","user_name":"作者回复","user_name_real":"傅健","uid":1638649,"ctime":1575960967,"ip_address":"","comment_id":157376,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师说的流量整形也就是网上说的背压吗？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476411,"discussion_content":"是的，准确的说背压是流控的手段之一，还有别的。别人直接丢数据的节流等等","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575960967,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157279,"user_name":"空白","can_delete":false,"product_type":"c3","uid":1147753,"ip_address":"","ucode":"65DA67B52A16B9","user_header":"https://static001.geekbang.org/account/avatar/00/11/83/69/77256c74.jpg","comment_is_top":false,"comment_ctime":1575102368,"is_pvip":false,"replies":[{"id":60344,"content":"是的，比如设置的太低了，所以很多开源软件都没用，一方面不定有这个需求，另外一方面，设置多少合适呢？都是一个问题，当然功能本身还是很酷的，也很有用，缺点就你说的，整过了就翻船了……","user_name":"作者回复","user_name_real":"傅健","uid":1638649,"ctime":1575150446,"ip_address":"","comment_id":157279,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"服务端触发流量整形，对于客户端表现是不是会出现延迟增大，甚至部分的请求超时呢？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476384,"discussion_content":"是的，比如设置的太低了，所以很多开源软件都没用，一方面不定有这个需求，另外一方面，设置多少合适呢？都是一个问题，当然功能本身还是很酷的，也很有用，缺点就你说的，整过了就翻船了……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575150446,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222319,"user_name":"orange","can_delete":false,"product_type":"c3","uid":1069002,"ip_address":"","ucode":"BD004762AEEB5A","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/ca/3ac60658.jpg","comment_is_top":false,"comment_ctime":1590746244,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"使用了UnorderedThreadPoolEventExecutor导致内存溢出了，老师帮忙看看是啥原因呢？，这个是 eclipse memory  analyse, MAT分析的结果。\nOne instance of &quot;io.netty.util.concurrent.UnorderedThreadPoolEventExecutor&quot; loaded by &quot;sun.misc.Launcher$AppClassLoader @ 0x9f84590&quot; occupies 205,586,736 (88.96%) bytes. The memory is accumulated in one instance of &quot;java.util.concurrent.RunnableScheduledFuture[]&quot; loaded by &quot;&lt;system class loader&gt;&quot;.\n\nKeywords\nio.netty.util.concurrent.UnorderedThreadPoolEventExecutor\njava.util.concurrent.RunnableScheduledFuture[]\nsun.misc.Launcher$AppClassLoader @ 0x9f84590","like_count":0},{"had_liked":false,"id":176765,"user_name":"美美","can_delete":false,"product_type":"c3","uid":1148422,"ip_address":"","ucode":"44CC95C45AF345","user_header":"https://static001.geekbang.org/account/avatar/00/11/86/06/72b01bb7.jpg","comment_is_top":false,"comment_ctime":1581159071,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"size&gt;0 需要写暂停，且 单个channel缓存的数据 是4M（maxWriteSize）\n\n暂停writeAndFlush的数据，是先缓存到Queue里，然后用Schedule定时再写 ？","like_count":0}]}