{"id":120172,"title":"65 | Docker Compose服务部署文件剖析","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":137377,"user_name":"亚林","can_delete":false,"product_type":"c3","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1569726414,"is_pvip":false,"replies":[{"id":52839,"content":"mysql数据库可以住在docker&#47;k8s中，但是建议容器中一般住无状态应用，生产环境有状态的应用建议住在物理或虚拟机。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1569766543,"ip_address":"","comment_id":137377,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"mysql数据库服务一般不放在docker里面吧？\n","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469058,"discussion_content":"mysql数据库可以住在docker/k8s中，但是建议容器中一般住无状态应用，生产环境有状态的应用建议住在物理或虚拟机。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569766543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144012,"user_name":"dingdongfm","can_delete":false,"product_type":"c3","uid":1564213,"ip_address":"","ucode":"7D17D2BC392A66","user_header":"","comment_is_top":false,"comment_ctime":1571824302,"is_pvip":false,"replies":[{"id":55563,"content":"你好，回答你的问题：\n1. docker-compose主要是在单机上玩的。但是现在v3版本的docker-compose.yml文件也支持在docker swarm集群上运行，要用docker stack命令，同时对yml文件也有一些限制，参考：https:&#47;&#47;stackoverflow.com&#47;questions&#47;40737389&#47;docker-compose-deploying-service-in-multiple-hosts\n\n2. 在可用内存4g的宿主机上，可以同时运行两个指定3G内存的容器，只要两个容器实际使用的内存都不会超过3g(当然两者总和也不能超过4g，否则会被OS杀掉)，你可以尝试下打开两个终端，同时运行：\ndocker run -m 20G -it ubuntu bash\n\n3. CPU&#47;MEM限制，具体可以参考docker官方文档，写得很详细：\nhttps:&#47;&#47;docs.docker.com&#47;config&#47;containers&#47;resource_constraints&#47;\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1571830685,"ip_address":"","comment_id":144012,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"您好，请教一些问题：\n1、docker-compose只能在一台宿主机上执行么？\n2、假设宿主机内存为4G，有两个docker容器，每台都指定使用3G内存，那么这两个容器可以正常运行么？\n3、docker容器对宿主机硬件资源（CPU，内存）的占用需要如何设置呢？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471777,"discussion_content":"你好，回答你的问题：\n1. docker-compose主要是在单机上玩的。但是现在v3版本的docker-compose.yml文件也支持在docker swarm集群上运行，要用docker stack命令，同时对yml文件也有一些限制，参考：https://stackoverflow.com/questions/40737389/docker-compose-deploying-service-in-multiple-hosts\n\n2. 在可用内存4g的宿主机上，可以同时运行两个指定3G内存的容器，只要两个容器实际使用的内存都不会超过3g(当然两者总和也不能超过4g，否则会被OS杀掉)，你可以尝试下打开两个终端，同时运行：\ndocker run -m 20G -it ubuntu bash\n\n3. CPU/MEM限制，具体可以参考docker官方文档，写得很详细：\nhttps://docs.docker.com/config/containers/resource_constraints/\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571830685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":138387,"user_name":"Young","can_delete":false,"product_type":"c3","uid":1619635,"ip_address":"","ucode":"B6CD7E4CF3220D","user_header":"https://static001.geekbang.org/account/avatar/00/18/b6/b3/f626885f.jpg","comment_is_top":false,"comment_ctime":1570191373,"is_pvip":false,"replies":[{"id":53557,"content":"可以参考这个链接提供的一种解决办法：\nhttps:&#47;&#47;8thlight.com&#47;blog&#47;dariusz-pasciak&#47;2016&#47;10&#47;17&#47;docker-compose-wait-for-dependencies.html\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1570533467,"ip_address":"","comment_id":138387,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"docker compose的容器depends on只能保证在被依赖的容器启动完成之后启动依赖的容器，但被依赖的容器启动完成并不代表该容器中的服务已经准备就绪可以使用，如果被依赖的容器中服务启动比较缓慢，在这种情况下就可能会出现以下场景：假设容器B中服务依赖容器A中服务，A容器启动完了但该容器中的服务还在启动，而此时B容器启动可能会导致由于A容器中服务未就绪而导致B容器中服务启动出错，请问老师这种情况该怎么处理","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469503,"discussion_content":"可以参考这个链接提供的一种解决办法：\nhttps://8thlight.com/blog/dariusz-pasciak/2016/10/17/docker-compose-wait-for-dependencies.html\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570533467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167153,"user_name":"btshanghaib","can_delete":false,"product_type":"c3","uid":1270638,"ip_address":"","ucode":"825FDD05F32421","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/iaQZhTib9pUoE6icavnTy9YCC3aZNxxZtfKPRS51icicxqzzcQVnmVCMzv3bLZqx0kibicYd4e86E2IfXpE9gpyHW8vyA/132","comment_is_top":false,"comment_ctime":1577700064,"is_pvip":false,"replies":[{"id":64986,"content":"faraday有一个配置：enable_programmatic_mapping，这个配置只有在dev环境为false，其它环境都是true。换句话说，只有dev环境会用application-dev.yml里头的静态配置路由，而其它环境都会用动态可编程路由方式～路由配置在程序代码里头，具体参考：ProgrammaticMappingsProvider这个类。两种路由方式的配置生效在FaradayConfiguration文件里头。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1577798278,"ip_address":"","comment_id":167153,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"请教老师一个问题，在docker-compose的环境里，faraday网关里面使用的profile是test，里面没有配置任意一个 mapping；那前端页面发送过来的 如app.staffjoy-v2.local 这样的域名它是根据什么来转发的？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479761,"discussion_content":"faraday有一个配置：enable_programmatic_mapping，这个配置只有在dev环境为false，其它环境都是true。换句话说，只有dev环境会用application-dev.yml里头的静态配置路由，而其它环境都会用动态可编程路由方式～路由配置在程序代码里头，具体参考：ProgrammaticMappingsProvider这个类。两种路由方式的配置生效在FaradayConfiguration文件里头。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577798278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}