{"id":427082,"title":"23ï½œç±»å‹ç³»ç»Ÿï¼šå¦‚ä½•åœ¨å®æˆ˜ä¸­ä½¿ç”¨æ³›å‹ç¼–ç¨‹ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ä»è¿™ä¸€è®²å¼€å§‹ï¼Œæˆ‘ä»¬å°±åˆ°è¿›é˜¶ç¯‡äº†ã€‚åœ¨è¿›é˜¶ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä¼šå…ˆè¿›ä¸€æ­¥å¤¯å®å¯¹ç±»å‹ç³»ç»Ÿçš„ç†è§£ï¼Œç„¶åå†å±•å¼€ç½‘ç»œå¤„ç†ã€Unsafe Rustã€FFI ç­‰ä¸»é¢˜ã€‚</p><p>ä¸ºä»€ä¹ˆè¦æŠŠç±»å‹ç³»ç»Ÿä½œä¸ºè¿›é˜¶ç¯‡çš„åŸºçŸ³ï¼Ÿä¹‹å‰è®²è§£ rgrep çš„ä»£ç æ—¶ä½ å¯ä»¥çœ‹åˆ°ï¼Œå½“è¦æ„å»ºå¯è¯»æ€§æ›´å¼ºã€æ›´åŠ çµæ´»ã€æ›´åŠ å¯æµ‹è¯•çš„ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬éƒ½è¦æˆ–å¤šæˆ–å°‘ä½¿ç”¨ trait å’Œæ³›å‹ç¼–ç¨‹ã€‚</p><p>æ‰€ä»¥å¯ä»¥è¯´åœ¨ Rust å¼€å‘ä¸­ï¼Œæ³›å‹ç¼–ç¨‹æ˜¯æˆ‘ä»¬å¿…é¡»æŒæ¡çš„ä¸€é¡¹æŠ€èƒ½ã€‚åœ¨ä½ æ„å»ºæ¯ä¸€ä¸ªæ•°æ®ç»“æ„æˆ–è€…å‡½æ•°æ—¶ï¼Œæœ€å¥½éƒ½é—®é—®è‡ªå·±ï¼šæˆ‘æ˜¯å¦æœ‰å¿…è¦åœ¨æ­¤åˆ»å°±æŠŠç±»å‹å®šæ­»ï¼Ÿæ˜¯ä¸æ˜¯å¯ä»¥æŠŠè¿™ä¸ªå†³ç­–å»¶è¿Ÿåˆ°å°½å¯èƒ½é åçš„æ—¶åˆ»ï¼Œè¿™æ ·å¯ä»¥ä¸ºæœªæ¥ç•™æœ‰ä½™åœ°ï¼Ÿ</p><p>åœ¨ã€Šæ¶æ„æ•´æ´ä¹‹é“ã€‹é‡Œ Uncle Bob è¯´ï¼š<strong>æ¶æ„å¸ˆçš„å·¥ä½œä¸æ˜¯ä½œå‡ºå†³ç­–ï¼Œè€Œæ˜¯å°½å¯èƒ½ä¹…åœ°æ¨è¿Ÿå†³ç­–ï¼Œåœ¨ç°åœ¨ä¸ä½œå‡ºé‡å¤§å†³ç­–çš„æƒ…å†µä¸‹æ„å»ºç¨‹åºï¼Œä»¥ä¾¿ä»¥åæœ‰è¶³å¤Ÿä¿¡æ¯æ—¶å†ä½œå‡ºå†³ç­–</strong>ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬èƒ½é€šè¿‡æ³›å‹æ¥æ¨è¿Ÿå†³ç­–ï¼Œç³»ç»Ÿçš„æ¶æ„å°±å¯ä»¥è¶³å¤Ÿçµæ´»ï¼Œå¯ä»¥æ›´å¥½åœ°é¢å¯¹æœªæ¥çš„å˜æ›´ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥è®²è®²å¦‚ä½•åœ¨å®æˆ˜ä¸­ä½¿ç”¨æ³›å‹ç¼–ç¨‹ï¼Œæ¥å»¶è¿Ÿå†³ç­–ã€‚å¦‚æœä½ å¯¹ Rust çš„æ³›å‹ç¼–ç¨‹æŒæ¡åœ°è¿˜ä¸å¤Ÿç‰¢é ï¼Œå»ºè®®å†æ¸©ä¹ ä¸€ä¸‹ç¬¬ <a href=\"https://time.geekbang.org/column/article/420021\">12</a> å’Œ <a href=\"https://time.geekbang.org/column/article/420028\">13</a> è®²ï¼Œä¹Ÿå¯ä»¥é˜…è¯» The Rust Programming Language <a href=\"https://doc.rust-lang.org/book/ch10-00-generics.html\">ç¬¬ 10 ç« </a>ä½œä¸ºè¾…åŠ©ã€‚</p><h2>æ³›å‹æ•°æ®ç»“æ„çš„é€æ­¥çº¦æŸ</h2><!-- [[[read_end]]] --><p>åœ¨è¿›å…¥æ­£é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬ä»¥æ ‡å‡†åº“çš„ <a href=\"https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#48-53\">BufReader</a> ç»“æ„ä¸ºä¾‹ï¼Œå…ˆç®€å•å›é¡¾ä¸€ä¸‹ï¼Œåœ¨å®šä¹‰æ•°æ®ç»“æ„å’Œå®ç°æ•°æ®ç»“æ„æ—¶ï¼Œå¦‚æœä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œåˆ°åº•æœ‰ä»€ä¹ˆæ ·çš„å¥½å¤„ã€‚</p><p>çœ‹è¿™ä¸ªå®šä¹‰çš„å°ä¾‹å­ï¼š</p><pre><code class=\"language-rust\">pub struct BufReader&lt;R&gt; {\n    inner: R,\n    buf: Box&lt;[u8]&gt;,\n    pos: usize,\n    cap: usize,\n}\n</code></pre><p>BufReader å¯¹è¦è¯»å–çš„ R åšäº†ä¸€ä¸ªæ³›å‹çš„æŠ½è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒR æ­¤åˆ»æ˜¯ä¸ª Fileï¼Œè¿˜æ˜¯ä¸€ä¸ª Cursorï¼Œæˆ–è€…ç›´æ¥æ˜¯ Vec&lt;u8&gt;ï¼Œéƒ½ä¸é‡è¦ã€‚åœ¨å®šä¹‰ struct çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æœªå¯¹ R åšè¿›ä¸€æ­¥çš„é™åˆ¶ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„ä½¿ç”¨æ³›å‹çš„æ–¹å¼ã€‚</p><p>åˆ°äº†å®ç°é˜¶æ®µï¼Œæ ¹æ®ä¸åŒçš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º R åšä¸åŒçš„é™åˆ¶ã€‚è¿™ä¸ªé™åˆ¶éœ€è¦ç»†è‡´åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿåªéœ€è¦æ·»åŠ åˆšå¥½æ»¡è¶³å®ç°éœ€è¦çš„é™åˆ¶å³å¯ã€‚</p><p>æ¯”å¦‚åœ¨æä¾› capacity()ã€buffer() è¿™äº›ä¸éœ€è¦ä½¿ç”¨ R çš„ä»»ä½•ç‰¹æ®Šèƒ½åŠ›çš„æ—¶å€™ï¼Œå¯ä»¥<a href=\"https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#102-230\">ä¸åšä»»ä½•é™åˆ¶</a>ï¼š</p><pre><code class=\"language-rust\">impl&lt;R&gt; BufReader&lt;R&gt; {\n    pub fn capacity(&amp;self) -&gt; usize { ... }\n    pub fn buffer(&amp;self) -&gt; &amp;[u8] { ... }\n}\n</code></pre><p>ä½†åœ¨å®ç° new() çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨äº† Read trait é‡Œçš„æ–¹æ³•ï¼Œæ‰€ä»¥è¿™æ—¶éœ€è¦æ˜ç¡®ä¼ è¿›æ¥çš„ <a href=\"https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#55-100\">R æ»¡è¶³ Read çº¦æŸ</a>ï¼š</p><pre><code class=\"language-rust\">impl&lt;R: Read&gt; BufReader&lt;R&gt; {\n    pub fn new(inner: R) -&gt; BufReader&lt;R&gt; { ... }\n    pub fn with_capacity(capacity: usize, inner: R) -&gt; BufReader&lt;R&gt; { ... }\n}\n</code></pre><p>åŒæ ·ï¼Œåœ¨å®ç° Debug æ—¶ï¼Œä¹Ÿå¯ä»¥è¦æ±‚ <a href=\"https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html#333-344\">R æ»¡è¶³ Debug trait çš„çº¦æŸ</a>ï¼š</p><pre><code class=\"language-rust\">impl&lt;R&gt; fmt::Debug for BufReader&lt;R&gt;\nwhere\n    R: fmt::Debug\n{\n    fn fmt(&amp;self, fmt: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result { ... }\n}\n</code></pre><p>å¦‚æœä½ å¤šèŠ±ä¸€äº›æ—¶é—´ï¼ŒæŠŠ <a href=\"https://doc.rust-lang.org/src/std/io/buffered/bufreader.rs.html\">bufreader.rs</a> å¯¹æ¥å£çš„æ‰€æœ‰å®ç°éƒ½è¿‡ä¸€éï¼Œè¿˜ä¼šå‘ç° BufReader åœ¨å®ç°è¿‡ç¨‹ä¸­ä½¿ç”¨äº† Seek traitã€‚</p><p>æ•´ä½“è€Œè¨€ï¼Œimpl BufReader çš„ä»£ç æ ¹æ®ä¸åŒçš„çº¦æŸï¼Œåˆ†æˆäº†ä¸åŒçš„ä»£ç å—ã€‚è¿™æ˜¯ä¸€ç§éå¸¸å…¸å‹çš„å®ç°æ³›å‹ä»£ç çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¹ èµ·æ¥ï¼Œåœ¨è‡ªå·±çš„ä»£ç ä¸­ä¹Ÿåº”ç”¨è¿™ç§æ–¹æ³•ã€‚</p><p>é€šè¿‡ä½¿ç”¨æ³›å‹å‚æ•°ï¼ŒBufReader æŠŠå†³ç­–äº¤ç»™ä½¿ç”¨è€…ã€‚æˆ‘ä»¬åœ¨ä¸Šä¸€è®²æœŸä¸­è€ƒè¯•çš„ rgrep å®ç°ä¸­ä¹Ÿçœ‹åˆ°äº†ï¼Œåœ¨æµ‹è¯•å’Œ rgrep çš„å®ç°ä»£ç ä¸­ï¼Œæ˜¯å¦‚ä½•ä¸º BufReader æä¾›ä¸åŒçš„ç±»å‹æ¥æ»¡è¶³ä¸åŒçš„ä½¿ç”¨åœºæ™¯çš„ã€‚</p><h2>æ³›å‹å‚æ•°çš„ä¸‰ç§ä½¿ç”¨åœºæ™¯</h2><p>æ³›å‹å‚æ•°çš„ä½¿ç”¨å’Œé€æ­¥çº¦æŸå°±ç®€å•å¤ä¹ åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å·²ç»æŒæ¡å¾—æ¯”è¾ƒå¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„é‡å¤´æˆï¼Œæ¥å­¦ä¹ å®æˆ˜ä¸­å¦‚ä½•ä½¿ç”¨æ³›å‹ç¼–ç¨‹ã€‚</p><p>å…ˆçœ‹æ³›å‹å‚æ•°ï¼Œå®ƒæœ‰ä¸‰ç§å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼š</p><ul>\n<li>ä½¿ç”¨æ³›å‹å‚æ•°å»¶è¿Ÿæ•°æ®ç»“æ„çš„ç»‘å®šï¼›</li>\n<li>ä½¿ç”¨æ³›å‹å‚æ•°å’Œ PhantomDataï¼Œå£°æ˜æ•°æ®ç»“æ„ä¸­ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†åœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ç±»å‹ï¼›</li>\n<li>ä½¿ç”¨æ³›å‹å‚æ•°è®©åŒä¸€ä¸ªæ•°æ®ç»“æ„å¯¹åŒä¸€ä¸ª trait å¯ä»¥æ‹¥æœ‰ä¸åŒçš„å®ç°ã€‚</li>\n</ul><h3>ç”¨æ³›å‹å‚æ•°åšå»¶è¿Ÿç»‘å®š</h3><p>å…ˆæ¥çœ‹æˆ‘ä»¬å·²ç»æ¯”è¾ƒç†Ÿæ‚‰çš„ï¼Œç”¨æ³›å‹å‚æ•°åšå»¶è¿Ÿç»‘å®šã€‚åœ¨ KV server çš„<a href=\"https://time.geekbang.org/column/article/425001\">ä¸Šç¯‡</a>ä¸­ï¼Œæˆ‘æ„å»ºäº†ä¸€ä¸ª Service æ•°æ®ç»“æ„ï¼š</p><pre><code class=\"language-rust\">/// Service æ•°æ®ç»“æ„\npub struct Service&lt;Store = MemTable&gt; {\n    inner: Arc&lt;ServiceInner&lt;Store&gt;&gt;,\n}\n</code></pre><p>å®ƒä½¿ç”¨äº†ä¸€ä¸ªæ³›å‹å‚æ•° Storeï¼Œå¹¶ä¸”è¿™ä¸ªæ³›å‹å‚æ•°æœ‰ä¸€ä¸ªç¼ºçœå€¼ MemTableã€‚æŒ‡å®šäº†æ³›å‹å‚æ•°ç¼ºçœå€¼çš„å¥½å¤„æ˜¯ï¼Œåœ¨ä½¿ç”¨æ—¶ï¼Œå¯ä»¥ä¸å¿…æä¾›æ³›å‹å‚æ•°ï¼Œç›´æ¥ä½¿ç”¨ç¼ºçœå€¼ã€‚è¿™ä¸ªæ³›å‹å‚æ•°åœ¨éšåçš„å®ç°ä¸­å¯ä»¥è¢«é€æ¸çº¦æŸï¼š</p><pre><code class=\"language-rust\">impl&lt;Store&gt; Service&lt;Store&gt; {\n    pub fn new(store: Store) -&gt; Self { ... }\n}\n\nimpl&lt;Store: Storage&gt; Service&lt;Store&gt; {\n    pub fn execute(&amp;self, cmd: CommandRequest) -&gt; CommandResponse { ... }\n}\n</code></pre><p>åŒæ ·çš„ï¼Œåœ¨æ³›å‹å‡½æ•°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ impl Storage æˆ–è€… &lt;Store: Storage&gt; çš„æ–¹å¼å»çº¦æŸï¼š</p><pre><code class=\"language-rust\">pub fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse { ... }\n// ç­‰ä»·äº\npub fn dispatch&lt;Store: Storage&gt;(cmd: CommandRequest, store: &amp;Store) -&gt; CommandResponse { ... }\n</code></pre><p>è¿™ç§ç”¨æ³•ï¼Œæƒ³å¿…ä½ ç°åœ¨å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå¯ä»¥åœ¨å¼€å‘ä¸­ä½¿ç”¨æ³›å‹å‚æ•°æ¥å¯¹ç±»å‹è¿›è¡Œå»¶è¿Ÿç»‘å®šã€‚</p><h3>ä½¿ç”¨æ³›å‹å‚æ•°å’Œå¹½çµæ•°æ®ï¼ˆPhantomDataï¼‰æä¾›é¢å¤–ç±»å‹</h3><p>åœ¨ç†Ÿæ‚‰äº†æ³›å‹å‚æ•°çš„åŸºæœ¬ç”¨æ³•åï¼Œæˆ‘æ¥è€ƒè€ƒä½ ï¼šç°åœ¨è¦è®¾è®¡ä¸€ä¸ª User å’Œ Product æ•°æ®ç»“æ„ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ª u64 ç±»å‹çš„ idã€‚ç„¶è€Œæˆ‘å¸Œæœ›æ¯ä¸ªæ•°æ®ç»“æ„çš„ id åªèƒ½å’ŒåŒç§ç±»å‹çš„ id æ¯”è¾ƒï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ user.id å’Œ product.id æ¯”è¾ƒï¼Œç¼–è¯‘å™¨å°±èƒ½ç›´æ¥æŠ¥é”™ï¼Œæ‹’ç»è¿™ç§è¡Œä¸ºã€‚è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p><p>ä½ å¯ä»¥åœä¸‹æ¥å…ˆæƒ³ä¸€æƒ³ã€‚</p><p>å¾ˆå¯èƒ½ä¼šç«‹åˆ»æƒ³åˆ°è¿™ä¸ªåŠæ³•ã€‚å…ˆç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ Identifier&lt;T&gt; æ¥è¡¨ç¤º idï¼š</p><pre><code class=\"language-rust\">pub struct Identifier&lt;T&gt; {\n    inner: u64,\n}\n</code></pre><p>ç„¶åï¼Œåœ¨ User å’Œ Product ä¸­ï¼Œå„è‡ªç”¨ Identifier&lt;Self&gt; æ¥è®© Identifier å’Œè‡ªå·±çš„ç±»å‹ç»‘å®šï¼Œè¾¾åˆ°è®©ä¸åŒç±»å‹çš„ id æ— æ³•æ¯”è¾ƒçš„ç›®çš„ã€‚æœ‰äº†è¿™ä¸ªæ„æƒ³ï¼Œä½ å¯ä»¥å¾ˆå¿«å†™å‡ºè¿™æ ·çš„ä»£ç ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d80dd549f6b57c7643381f75539ff1ca\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">#[derive(Debug, Default, PartialEq, Eq)]\npub struct Identifier&lt;T&gt; {\n    inner: u64,\n}\n\n#[derive(Debug, Default, PartialEq, Eq)]\npub struct User {\n    id: Identifier&lt;Self&gt;,\n}\n\n#[derive(Debug, Default, PartialEq, Eq)]\npub struct Product {\n    id: Identifier&lt;Self&gt;,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn id_should_not_be_the_same() {\n        let user = User::default();\n        let product = Product::default();\n\n        // ä¸¤ä¸ª id ä¸èƒ½æ¯”è¾ƒï¼Œå› ä¸ºä»–ä»¬å±äºä¸åŒçš„ç±»å‹\n        // assert_ne!(user.id, product.id);\n\n        assert_eq!(user.id.inner, product.id.inner);\n    }\n}\n</code></pre><p>ç„¶è€Œå®ƒæ— æ³•ç¼–è¯‘é€šè¿‡ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å› ä¸º Identifier&lt;T&gt; åœ¨å®šä¹‰æ—¶ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨æ³›å‹å‚æ•° Tï¼Œç¼–è¯‘å™¨è®¤ä¸º T æ˜¯å¤šä½™çš„ï¼Œæ‰€ä»¥åªèƒ½æŠŠ T åˆ é™¤æ‰æ‰èƒ½ç¼–è¯‘é€šè¿‡ã€‚ä½†æ˜¯ï¼Œåˆ é™¤æ‰ Tï¼ŒUser  å’Œ Product çš„ id å°±å¯ä»¥æ¯”è¾ƒäº†ï¼Œæˆ‘ä»¬å°±æ— æ³•å®ç°æƒ³è¦çš„åŠŸèƒ½äº†ï¼Œæ€ä¹ˆåŠï¼Ÿå”‰ï¼Œåˆšåˆšè¿˜è¸Œèº‡æ»¡å¿—è§‰å¾—å¯ä»¥ç”¨æ³›å‹æ¥æŒ‡ç‚¹æ±Ÿå±±ï¼Œç°åœ¨é¢å¯¹è¿™ä¹ˆä¸ªå°é—®é¢˜å´ä¸‡å¿µä¿±ç­ï¼Ÿ</p><p>åˆ«æ€¥ã€‚å¦‚æœä½ ä½¿ç”¨è¿‡ä»»ä½•å…¶ä»–æ”¯æŒæ³›å‹çš„è¯­è¨€ï¼Œæ— è®ºæ˜¯ Javaã€Swift è¿˜æ˜¯ TypeScriptï¼Œå¯èƒ½éƒ½æ¥è§¦è¿‡<strong>Phantom Typeï¼ˆå¹½çµç±»å‹ï¼‰</strong>çš„æ¦‚å¿µã€‚åƒåˆšæ‰çš„å†™æ³•ï¼ŒSwift / TypeScript ä¼šè®©å…¶é€šè¿‡ï¼Œå› ä¸ºå®ƒä»¬çš„ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æŠŠå¤šä½™çš„æ³›å‹å‚æ•°å½“æˆ Phantom type æ¥ç”¨ï¼Œæ¯”å¦‚ä¸‹é¢ TypeScript çš„ä¾‹å­ï¼Œå¯ä»¥ç¼–è¯‘ï¼š</p><pre><code class=\"language-typescript\">// NotUsed is allowed\nclass MyNumber&lt;T, NotUsed&gt; {\n    inner: T;\n    add: (x: T, y: T) =&gt; T;\n}\n</code></pre><p>ä½† Rust å¯¹æ­¤æœ‰æ´ç™–ã€‚Rust å¹¶ä¸å¸Œæœ›åœ¨å®šä¹‰ç±»å‹æ—¶ï¼Œå‡ºç°ç›®å‰è¿˜æ²¡ä½¿ç”¨ï¼Œä½†æœªæ¥ä¼šè¢«ä½¿ç”¨çš„æ³›å‹å‚æ•°ï¼Œæ‰€ä»¥ Rust ç¼–è¯‘å™¨å¯¹æ­¤æ— æƒ…æ‹’ç»ï¼ŒæŠŠé—¨å…³å¾—ä¸¥ä¸¥å®å®ã€‚</p><p>ä¸è¿‡ï¼Œåˆ«æ‹…å¿ƒï¼Œä½œä¸ºè¿‡æ¥äººï¼ŒRust çŸ¥é“ Phantom Type çš„å¿…è¦æ€§ï¼Œæ‰€ä»¥å¼€äº†ä¸€æ‰‡å« <a href=\"https://doc.rust-lang.org/std/marker/struct.PhantomData.html\">PhantomData</a> çš„çª—æˆ·ï¼šè®©æˆ‘ä»¬å¯ä»¥ç”¨ PhantomData æ¥æŒæœ‰ Phantom Typeã€‚PhantomData ä¸­æ–‡ä¸€èˆ¬ç¿»è¯‘æˆå¹½çµæ•°æ®ï¼Œè¿™åå­—é€ç€ä¸€è‚¡è®©äººä¸æ•¢äº²è¿‘çš„é‚ªé­…ï¼Œä½†å®ƒ<strong>è¢«å¹¿æ³›ç”¨åœ¨å¤„ç†ï¼Œæ•°æ®ç»“æ„å®šä¹‰è¿‡ç¨‹ä¸­ä¸éœ€è¦ï¼Œä½†æ˜¯åœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦çš„æ³›å‹å‚æ•°</strong>ã€‚</p><p>æˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ï¼š</p><pre><code class=\"language-rust\">use std::marker::PhantomData;\n\n#[derive(Debug, Default, PartialEq, Eq)]\npub struct Identifier&lt;T&gt; {\n    inner: u64,\n    _tag: PhantomData&lt;T&gt;,\n}\n\n#[derive(Debug, Default, PartialEq, Eq)]\npub struct User {\n    id: Identifier&lt;Self&gt;,\n}\n\n#[derive(Debug, Default, PartialEq, Eq)]\npub struct Product {\n    id: Identifier&lt;Self&gt;,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn id_should_not_be_the_same() {\n        let user = User::default();\n        let product = Product::default();\n\n        // ä¸¤ä¸ª id ä¸èƒ½æ¯”è¾ƒï¼Œå› ä¸ºä»–ä»¬å±äºä¸åŒçš„ç±»å‹\n        // assert_ne!(user.id, product.id);\n\n        assert_eq!(user.id.inner, product.id.inner);\n    }\n}\n</code></pre><p>Bingoï¼ç¼–è¯‘é€šè¿‡ï¼åœ¨ä½¿ç”¨äº† PhantomData åï¼Œç¼–è¯‘å™¨å…è®¸æ³›å‹å‚æ•° T çš„å­˜åœ¨ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ç¡®è®¤äº†ï¼š<strong>åœ¨å®šä¹‰æ•°æ®ç»“æ„æ—¶ï¼Œå¯¹äºé¢å¤–çš„ã€æš‚æ—¶ä¸éœ€è¦çš„æ³›å‹å‚æ•°ï¼Œç”¨ PhantomData æ¥â€œæ‹¥æœ‰â€å®ƒä»¬ï¼Œè¿™æ ·å¯ä»¥è§„é¿ç¼–è¯‘å™¨çš„æŠ¥é”™</strong>ã€‚PhantomData æ­£å¦‚å…¶åï¼Œå®ƒå®é™…ä¸Šé•¿åº¦ä¸ºé›¶ï¼Œæ˜¯ä¸ª ZSTï¼ˆZero-Sized Typeï¼‰ï¼Œå°±åƒä¸å­˜åœ¨ä¸€æ ·ï¼Œå”¯ä¸€ä½œç”¨å°±æ˜¯ç±»å‹çš„æ ‡è®°ã€‚</p><p>å†æ¥å†™ä¸€ä¸ªä¾‹å­ï¼ŒåŠ æ·±å¯¹ PhantomData çš„ç†è§£ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d7ae09e39026cba20b6bc0c4a92f458f\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::{\n    marker::PhantomData,\n    sync::atomic::{AtomicU64, Ordering},\n};\n\nstatic NEXT_ID: AtomicU64 = AtomicU64::new(1);\n\npub struct Customer&lt;T&gt; {\n    id: u64,\n    name: String,\n    _type: PhantomData&lt;T&gt;,\n}\n\npub trait Free {\n    fn feature1(&amp;self);\n    fn feature2(&amp;self);\n}\n\npub trait Personal: Free {\n    fn advance_feature(&amp;self);\n}\n\nimpl&lt;T&gt; Free for Customer&lt;T&gt; {\n    fn feature1(&amp;self) {\n        println!(\"feature 1 for {}\", self.name);\n    }\n\n    fn feature2(&amp;self) {\n        println!(\"feature 2 for {}\", self.name);\n    }\n}\n\nimpl Personal for Customer&lt;PersonalPlan&gt; {\n    fn advance_feature(&amp;self) {\n        println!(\n            \"Dear {}(as our valuable customer {}), enjoy this advanced feature!\",\n            self.name, self.id\n        );\n    }\n}\n\npub struct FreePlan;\npub struct PersonalPlan(f32);\n\nimpl&lt;T&gt; Customer&lt;T&gt; {\n    pub fn new(name: String) -&gt; Self {\n        Self {\n            id: NEXT_ID.fetch_add(1, Ordering::Relaxed),\n            name,\n            _type: PhantomData::default(),\n        }\n    }\n}\n\nimpl From&lt;Customer&lt;FreePlan&gt;&gt; for Customer&lt;PersonalPlan&gt; {\n    fn from(c: Customer&lt;FreePlan&gt;) -&gt; Self {\n        Self::new(c.name)\n    }\n}\n\n/// è®¢é˜…æˆä¸ºä»˜è´¹ç”¨æˆ·\npub fn subscribe(customer: Customer&lt;FreePlan&gt;, payment: f32) -&gt; Customer&lt;PersonalPlan&gt; {\n    let _plan = PersonalPlan(payment);\n    // å­˜å‚¨ plan åˆ° DB\n    // ...\n    customer.into()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_customer() {\n        // ä¸€å¼€å§‹æ˜¯ä¸ªå…è´¹ç”¨æˆ·\n        let customer = Customer::&lt;FreePlan&gt;::new(\"Tyr\".into());\n        // ä½¿ç”¨å…è´¹ feature\n        customer.feature1();\n        customer.feature2();\n        // ç”¨ç€ç”¨ç€è§‰å¾—äº§å“ä¸é”™æ„¿æ„ä»˜è´¹\n        let customer = subscribe(customer, 6.99);\n        customer.feature1();\n        customer.feature1();\n        // ä»˜è´¹ç”¨æˆ·è§£é”äº†æ–°æŠ€èƒ½\n        customer.advance_feature();\n    }\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼ŒCustomer æœ‰ä¸ªé¢å¤–çš„ç±»å‹ Tã€‚</p><p>é€šè¿‡ç±»å‹ Tï¼Œæˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·åˆ†æˆä¸åŒçš„ç­‰çº§ï¼Œæ¯”å¦‚å…è´¹ç”¨æˆ·æ˜¯ Customer&lt;FreePlan&gt;ã€ä»˜è´¹ç”¨æˆ·æ˜¯ Customer&lt;PersonalPlan&gt;ï¼Œå…è´¹ç”¨æˆ·å¯ä»¥è½¬åŒ–æˆä»˜è´¹ç”¨æˆ·ï¼Œè§£é”æ›´å¤šæƒç›Šã€‚ä½¿ç”¨ PhantomData å¤„ç†è¿™æ ·çš„çŠ¶æ€ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æœŸåšçŠ¶æ€çš„æ£€æµ‹ï¼Œé¿å…è¿è¡ŒæœŸæ£€æµ‹çš„è´Ÿæ‹…å’Œæ½œåœ¨çš„é”™è¯¯ã€‚</p><h3>ä½¿ç”¨æ³›å‹å‚æ•°æ¥æä¾›å¤šä¸ªå®ç°</h3><p>ç”¨æ³›å‹å‚æ•°åšå»¶è¿Ÿç»‘å®šã€ç»“åˆPhantomDataæ¥æä¾›é¢å¤–ç±»å‹ï¼Œæ˜¯æˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°çš„æ³›å‹å‚æ•°çš„ç”¨æ³•ã€‚</p><p>æœ‰æ—¶å€™ï¼Œå¯¹äºåŒä¸€ä¸ª traitï¼Œæˆ‘ä»¬æƒ³è¦æœ‰ä¸åŒçš„å®ç°ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚ä¸€ä¸ªæ–¹ç¨‹ï¼Œå®ƒå¯ä»¥æ˜¯çº¿æ€§æ–¹ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒæ¬¡æ–¹ç¨‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ºä¸åŒçš„ç±»å‹å®ç°ä¸åŒ Iteratorã€‚å¯ä»¥è¿™æ ·åšï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=123d1c5c030d1719d5d2de39bb5f8b10\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use std::marker::PhantomData;\n\n#[derive(Debug, Default)]\npub struct Equation&lt;IterMethod&gt; {\n    current: u32,\n    _method: PhantomData&lt;IterMethod&gt;,\n}\n\n// çº¿æ€§å¢é•¿\n#[derive(Debug, Default)]\npub struct Linear;\n\n// äºŒæ¬¡å¢é•¿\n#[derive(Debug, Default)]\npub struct Quadratic;\n\nimpl Iterator for Equation&lt;Linear&gt; {\n    type Item = u32;\n\n    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {\n        self.current += 1;\n        if self.current &gt;= u32::MAX {\n            return None;\n        }\n\n        Some(self.current)\n    }\n}\n\nimpl Iterator for Equation&lt;Quadratic&gt; {\n    type Item = u32;\n\n    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {\n        self.current += 1;\n        if self.current &gt;= u16::MAX as u32 {\n            return None;\n        }\n\n        Some(self.current * self.current)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_linear() {\n        let mut equation = Equation::&lt;Linear&gt;::default();\n        assert_eq!(Some(1), equation.next());\n        assert_eq!(Some(2), equation.next());\n        assert_eq!(Some(3), equation.next());\n    }\n\n    #[test]\n    fn test_quadratic() {\n        let mut equation = Equation::&lt;Quadratic&gt;::default();\n        assert_eq!(Some(1), equation.next());\n        assert_eq!(Some(4), equation.next());\n        assert_eq!(Some(9), equation.next());\n    }\n}\n</code></pre><p>è¿™ä¸ªä»£ç å¾ˆå¥½ç†è§£ï¼Œä½†ä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸æ„å»ºä¸¤ä¸ªæ•°æ®ç»“æ„ LinearEquation å’Œ QuadraticEquationï¼Œåˆ†åˆ«å®ç° Iterator å‘¢ï¼Ÿ</p><p>çš„ç¡®ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­ï¼Œä½¿ç”¨æ³›å‹çš„æ„ä¹‰å¹¶ä¸å¤§ï¼Œå› ä¸º Equation è‡ªèº«æ²¡æœ‰å¾ˆå¤šå…±äº«çš„ä»£ç ã€‚ä½†å¦‚æœ Equationï¼Œåªé™¤äº†å®ç° Iterator çš„é€»è¾‘ä¸ä¸€æ ·ï¼Œå…¶å®ƒå¤§é‡çš„ä»£ç éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”æœªæ¥é™¤äº†ä¸€æ¬¡æ–¹ç¨‹å’ŒäºŒæ¬¡æ–¹ç¨‹ï¼Œè¿˜ä¼šæ”¯æŒä¸‰æ¬¡ã€å››æ¬¡â€¦â€¦ï¼Œé‚£ä¹ˆï¼Œ<strong>ç”¨æ³›å‹æ•°æ®ç»“æ„æ¥ç»Ÿä¸€ç›¸åŒçš„é€»è¾‘ï¼Œç”¨æ³›å‹å‚æ•°çš„å…·ä½“ç±»å‹æ¥å¤„ç†å˜åŒ–çš„é€»è¾‘</strong>ï¼Œå°±éå¸¸æœ‰å¿…è¦äº†ã€‚</p><p>æ¥çœ‹ä¸€ä¸ªçœŸå®å­˜åœ¨çš„ä¾‹å­<a href=\"https://docs.rs/async-prost/0.2.1/src/async_prost/reader.rs.html#26-31\">AsyncProstReader</a>ï¼Œå®ƒæ¥è‡ªä¹‹å‰æˆ‘ä»¬åœ¨ KV server é‡Œç”¨è¿‡çš„ <a href=\"https://docs.rs/async-prost/0.2.1/async_prost/\">async-prost</a> åº“ã€‚async-prost åº“ï¼Œå¯ä»¥æŠŠ TCP æˆ–è€…å…¶ä»–åè®®ä¸­çš„ stream é‡Œä¼ è¾“çš„æ•°æ®ï¼Œåˆ†æˆä¸€ä¸ªä¸ª frame å¤„ç†ã€‚å…¶ä¸­çš„ AsyncProstReader ä¸º AsyncDestination å’Œ AsyncFrameDestination æä¾›äº†ä¸åŒçš„å®ç°ï¼Œä½ å¯ä»¥ä¸ç”¨å…³å¿ƒå®ƒå…·ä½“åšäº†äº›ä»€ä¹ˆï¼Œåªè¦å­¦ä¹ å®ƒçš„æ¥å£çš„è®¾è®¡ï¼š</p><pre><code class=\"language-rust\">/// A marker that indicates that the wrapping type is compatible with `AsyncProstReader` with Prost support.\n#[derive(Debug)]\npub struct AsyncDestination;\n\n/// a marker that indicates that the wrapper type is compatible with `AsyncProstReader` with Framed support.\n#[derive(Debug)]\npub struct AsyncFrameDestination;\n\n/// A wrapper around an async reader that produces an asynchronous stream of prost-decoded values\n#[derive(Debug)]\npub struct AsyncProstReader&lt;R, T, D&gt; {\n    reader: R,\n    pub(crate) buffer: BytesMut,\n    into: PhantomData&lt;T&gt;,\n    dest: PhantomData&lt;D&gt;,\n}\n</code></pre><p>è¿™ä¸ªæ•°æ®ç»“æ„è™½ç„¶ä½¿ç”¨äº†ä¸‰ä¸ªæ³›å‹å‚æ•°ï¼Œå…¶å®æ•°æ®ç»“æ„ä¸­çœŸæ­£ç”¨åˆ°çš„åªæœ‰ä¸€ä¸ª Rï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå®ç°äº† AsyncRead çš„æ•°æ®ç»“æ„ï¼ˆç¨åä¼šçœ‹åˆ°ï¼‰ã€‚<strong>å¦å¤–ä¸¤ä¸ªæ³›å‹å‚æ•° T å’Œ Dï¼Œåœ¨æ•°æ®ç»“æ„å®šä¹‰çš„æ—¶å€™å…¶å®å¹¶ä¸éœ€è¦ï¼Œåªæ˜¯åœ¨æ•°æ®ç»“æ„çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œæ‰éœ€è¦ç”¨åˆ°å®ƒä»¬çš„çº¦æŸ</strong>ã€‚å…¶ä¸­ï¼Œ</p><ul>\n<li>T æ˜¯ä» R ä¸­è¯»å–å‡ºçš„æ•°æ®ååºåˆ—åŒ–å‡ºæ¥çš„ç±»å‹ï¼Œåœ¨å®ç°æ—¶ç”¨ prost::Message çº¦æŸã€‚</li>\n<li>D æ˜¯ä¸€ä¸ªç±»å‹å ä½ç¬¦ï¼Œå®ƒä¼šæ ¹æ®éœ€è¦è¢«å…·ä½“åŒ–ä¸º AsyncDestination æˆ–è€… AsyncFrameDestinationã€‚</li>\n</ul><p>ç±»å‹å‚æ•° D å¦‚ä½•ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæƒ³åƒä¸€ä¸‹ã€‚å®ç° AsyncProstReader çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ä½¿ç”¨ AsyncDestination æ—¶ï¼Œæä¾›ä¸€ç§å®ç°ï¼Œè€Œåœ¨ä½¿ç”¨ AsyncFrameDestination æ—¶ï¼Œæä¾›å¦ä¸€ç§å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œçš„ç±»å‹å‚æ•° Dï¼Œåœ¨ impl çš„æ—¶å€™ï¼Œä¼šè¢«å…·ä½“åŒ–æˆæŸä¸ªç±»å‹ã€‚</p><p>æ‹¿ç€è¿™ä¸ªæƒ³æ³•ï¼Œæ¥çœ‹ AsyncProstReader åœ¨å®ç° <a href=\"https://docs.rs/futures/0.3.17/futures/prelude/trait.Stream.html\">Stream</a> æ—¶ï¼ŒD æ˜¯å¦‚ä½•å…·ä½“åŒ–çš„ã€‚è¿™é‡Œä½ ä¸ç”¨å…³å¿ƒ Stream å…·ä½“æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•å®ç°ã€‚å®ç°çš„ä»£ç ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æ¥å£ï¼ˆ<a href=\"https://docs.rs/async-prost/0.2.1/src/async_prost/reader.rs.html#81-105\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">impl&lt;R, T&gt; Stream for AsyncProstReader&lt;R, T, AsyncDestination&gt;\nwhere\n    T: Message + Default,\n    R: AsyncRead + Unpin,\n{\n    type Item = Result&lt;T, io::Error&gt;;\n\n    fn poll_next(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt; {\n        ...\n    }\n}\n</code></pre><p>å†çœ‹å¯¹å¦å¤–ä¸€ä¸ªå¯¹ D çš„å…·ä½“å®ç°ï¼š</p><pre><code class=\"language-rust\">impl&lt;R, T&gt; Stream for AsyncProstReader&lt;R, T, AsyncFrameDestination&gt;\nwhere\n    R: AsyncRead + Unpin,\n    T: Framed + Default,\n{\n    type Item = Result&lt;T, io::Error&gt;;\n\n    fn poll_next(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt; {\n        ...\n    }\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œé™¤äº† Stream çš„å®ç°ä¸åŒå¤–ï¼ŒAsyncProstReader çš„å…¶å®ƒå®ç°éƒ½æ˜¯å…±äº«çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰å¿…è¦ä¸ºå…¶å¢åŠ ä¸€ä¸ªæ³›å‹å‚æ•° Dï¼Œä½¿å…¶å¯ä»¥æ ¹æ®ä¸åŒçš„ D çš„ç±»å‹ï¼Œæ¥æä¾›ä¸åŒçš„ Stream å®ç°ã€‚</p><p>AsyncProstReader ç»¼åˆä½¿ç”¨äº†æ³›å‹çš„ä¸‰ç§ç”¨æ³•ï¼Œæ„Ÿå…´è¶£çš„è¯ä½ å¯ä»¥çœ‹æºä»£ç ã€‚å¦‚æœä½ æ— æ³•ä¸€ä¸‹å­é¢†æ‚Ÿå®ƒçš„ä»£ç ï¼Œä¹Ÿä¸å¿…æ‹…å¿ƒã€‚å¾ˆå¤šæ—¶å€™ï¼Œè¿™æ ·çš„é«˜çº§æŠ€å·§åœ¨é˜…è¯»ä»£ç æ—¶ç”¨é€”ä¼šæ›´å¤§ä¸€äº›ï¼Œèµ·ç ä½ èƒ½ææ˜ç™½åˆ«äººçš„ä»£ç ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ã€‚è‡³äºè‡ªå·±å†™çš„æ—¶å€™æ˜¯å¦è¦è¿™ä¹ˆç”¨ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±æŒæ¡çš„ç¨‹åº¦æ¥å†³å®šã€‚</p><p>æ¯•ç«Ÿï¼Œ<strong>æˆ‘ä»¬å†™ä»£ç çš„é¦–è¦ç›®æ ‡æ˜¯æ­£ç¡®åœ°å®ç°æ‰€éœ€è¦çš„åŠŸèƒ½</strong>ï¼Œåœ¨æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œä¼˜é›…ç®€æ´çš„è¡¨è¾¾æ‰æœ‰æ„ä¹‰ã€‚</p><h2>æ³›å‹å‡½æ•°çš„é«˜çº§æŠ€å·§</h2><p>å¦‚æœä½ æŒæ¡äº†æ³›å‹æ•°æ®ç»“æ„çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆæ³›å‹å‡½æ•°å¹¶ä¸å¤æ‚ï¼Œå› ä¸ºåœ¨ä½¿ç”¨æ³›å‹å‚æ•°å’Œå¯¹æ³›å‹å‚æ•°è¿›è¡Œçº¦æŸæ–¹é¢æ˜¯ä¸€è‡´çš„ã€‚</p><p>ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»åœ¨å‡½æ•°å‚æ•°ä¸­å¤šæ¬¡ä½¿ç”¨æ³›å‹å‚æ•°äº†ï¼Œæƒ³å¿…ä½ å·²ç»æœ‰è¶³å¤Ÿçš„æŒæ¡ã€‚å…³äºæ³›å‹å‡½æ•°ï¼Œæˆ‘ä»¬è®²ä¸¤ç‚¹ï¼Œä¸€æ˜¯è¿”å›å€¼å¦‚æœæƒ³è¿”å›æ³›å‹å‚æ•°ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼ŸäºŒæ˜¯å¯¹äºå¤æ‚çš„æ³›å‹å‚æ•°ï¼Œè¯¥å¦‚ä½•å£°æ˜ï¼Ÿ</p><h3>è¿”å›å€¼æºå¸¦æ³›å‹å‚æ•°æ€ä¹ˆåŠï¼Ÿ</h3><p>åœ¨ KV server ä¸­ï¼Œæ„å»º Storage trait çš„ get_iter æ¥å£æ—¶ï¼Œæˆ‘ä»¬å·²ç»è§åˆ°äº†è¿™æ ·çš„ç”¨æ³•ï¼š</p><pre><code class=\"language-rust\">pub trait Storage {\n    ...\n    /// éå† HashTableï¼Œè¿”å› kv pair çš„ Iterator\n    fn get_iter(&amp;self, table: &amp;str) -&gt; \n\t\t    Result&lt;Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt;, KvError&gt;;\n}\n</code></pre><p>å¯¹äº get_iter() æ–¹æ³•ï¼Œå¹¶ä¸å…³å¿ƒè¿”å›å€¼æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„ Iteratorï¼Œåªè¦å®ƒèƒ½å¤Ÿå…è®¸æˆ‘ä»¬ä¸æ–­è°ƒç”¨ next() æ–¹æ³•ï¼Œè·å¾—ä¸€ä¸ª Kvpair çš„ç»“æ„ï¼Œå°±å¯ä»¥äº†ã€‚åœ¨å®ç°é‡Œï¼Œä½¿ç”¨äº† trait objectã€‚</p><p>ä½ ä¹Ÿè®¸ä¼šæœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨ impl Iterator å‘¢ï¼Ÿ</p><pre><code class=\"language-plain\">// ç›®å‰ trait è¿˜ä¸æ”¯æŒ\nfn get_iter(&amp;self, table: &amp;str) -&gt; Result&lt;impl Iterator&lt;Item = Kvpair&gt;, KvError&gt;;\n</code></pre><p>åŸå› æ˜¯ Rust ç›®å‰è¿˜ä¸æ”¯æŒåœ¨ trait é‡Œä½¿ç”¨ impl trait åšè¿”å›å€¼ï¼š</p><pre><code class=\"language-rust\">pub trait ImplTrait {\n    // å…è®¸\n    fn impl_in_args(s: impl Into&lt;String&gt;) -&gt; String {\n        s.into()\n    }\n\n    // ä¸å…è®¸\n    fn impl_as_return(s: String) -&gt; impl Into&lt;String&gt; {\n        s\n    }\n}\n</code></pre><p>é‚£ä¹ˆä½¿ç”¨æ³›å‹å‚æ•°åšè¿”å›å€¼å‘¢ï¼Ÿå¯ä»¥ï¼Œä½†æ˜¯åœ¨å®ç°çš„æ—¶å€™ä¼šå¾ˆéº»çƒ¦ï¼Œä½ å¾ˆéš¾åœ¨å‡½æ•°ä¸­æ­£ç¡®æ„é€ ä¸€ä¸ªè¿”å›æ³›å‹å‚æ•°çš„è¯­å¥ï¼š</p><pre><code class=\"language-rust\">// å¯ä»¥æ­£ç¡®ç¼–è¯‘\npub fn generics_as_return_working(i: u32) -&gt; impl Iterator&lt;Item = u32&gt; {\n    std::iter::once(i)\n}\n\n// æœŸå¾…æ³›å‹ç±»å‹ï¼Œå´è¿”å›ä¸€ä¸ªå…·ä½“ç±»å‹\npub fn generics_as_return_not_working&lt;T: Iterator&lt;Item = u32&gt;&gt;(i: u32) -&gt; T {\n    std::iter::once(i)\n}\n</code></pre><p>é‚£æ€ä¹ˆåŠï¼Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å› trait objectï¼Œå®ƒæ¶ˆé™¤äº†ç±»å‹çš„å·®å¼‚ï¼ŒæŠŠæ‰€æœ‰ä¸åŒçš„å®ç° Iterator çš„ç±»å‹éƒ½ç»Ÿä¸€åˆ°ä¸€ä¸ªç›¸åŒçš„ trait object ä¸‹ï¼š</p><pre><code class=\"language-rust\">// è¿”å› trait object\npub fn trait_object_as_return_working(i: u32) -&gt; Box&lt;dyn Iterator&lt;Item = u32&gt;&gt; {\n    Box::new(std::iter::once(i))\n}\n</code></pre><p>æ˜ç™½äº†è¿™ä¸€ç‚¹ï¼Œå›åˆ°åˆšæ‰ KV serverçš„ Storage traitï¼š</p><pre><code class=\"language-rust\">pub trait Storage {\n    ...\n    /// éå† HashTableï¼Œè¿”å› kv pair çš„ Iterator\n    fn get_iter(&amp;self, table: &amp;str) -&gt; \n\t\t    Result&lt;Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt;, KvError&gt;;\n}\n</code></pre><p>ç°åœ¨ä½ æ˜¯ä¸æ˜¯æ›´å¥½åœ°ç†è§£äº†ï¼Œåœ¨è¿™ä¸ª trait é‡Œï¼Œä¸ºä½•æˆ‘ä»¬éœ€è¦ä½¿ç”¨ Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt; ï¼Ÿ</p><p>ä¸è¿‡ä½¿ç”¨ trait object æ˜¯æœ‰é¢å¤–çš„ä»£ä»·çš„ï¼Œé¦–å…ˆè¿™é‡Œæœ‰ä¸€æ¬¡é¢å¤–çš„å †åˆ†é…ï¼Œå…¶æ¬¡åŠ¨æ€åˆ†æ´¾ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚</p><h3>å¤æ‚çš„æ³›å‹å‚æ•°è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</h3><p>åœ¨æ³›å‹å‡½æ•°ä¸­ï¼Œæœ‰æ—¶å€™æ³›å‹å‚æ•°å¯ä»¥éå¸¸å¤æ‚ã€‚æ¯”å¦‚æ³›å‹å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œé—­åŒ…è¿”å›ä¸€ä¸ª Iteratorï¼ŒIterator ä¸­çš„ Item åˆæœ‰æŸä¸ªçº¦æŸã€‚çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š</p><pre><code class=\"language-rust\">pub fn comsume_iterator&lt;F, Iter,  T&gt;(mut f: F)\nwhere\n    F: FnMut(i32) -&gt; Iter, // F æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œæ¥å— i32ï¼Œè¿”å› Iter ç±»å‹\n    Iter: Iterator&lt;Item = T&gt;, // Iter æ˜¯ä¸€ä¸ª Iteratorï¼ŒItem æ˜¯ T ç±»å‹\n    T: std::fmt::Debug, // T å®ç°äº† Debug trait\n{\n    // æ ¹æ® F çš„ç±»å‹ï¼Œf(10) è¿”å› iteratorï¼Œæ‰€ä»¥å¯ä»¥ç”¨ for å¾ªç¯\n    for item in f(10) {\n        println!(\"{:?}\", item); // item å®ç°äº† Debug traitï¼Œæ‰€ä»¥å¯ä»¥ç”¨ {:?} æ‰“å°\n    }\n}\n</code></pre><p>è¿™ä¸ªä»£ç çš„æ³›å‹å‚æ•°è™½ç„¶éå¸¸å¤æ‚ï¼Œä¸è¿‡ä¸€æ­¥æ­¥åˆ†è§£ï¼Œå…¶å®å¹¶ä¸éš¾ç†è§£å…¶å®è´¨ï¼š</p><ol>\n<li>å‚æ•° F æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œæ¥å— i32ï¼Œè¿”å› Iter ç±»å‹ï¼›</li>\n<li>å‚æ•° Iter æ˜¯ä¸€ä¸ª Iteratorï¼ŒItem æ˜¯ T ç±»å‹ï¼›</li>\n<li>å‚æ•° T æ˜¯ä¸€ä¸ªå®ç°äº† Debug trait çš„ç±»å‹ã€‚</li>\n</ol><p>è¿™ä¹ˆåˆ†è§£ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œä¸ºä½•è¿™æ®µä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å†™å‡ºåˆé€‚çš„æµ‹è¯•ç¤ºä¾‹ï¼Œæ¥æµ‹è¯•å®ƒï¼š</p><pre><code class=\"language-rust\">#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_consume_iterator() {\n        // ä¸ä¼š panic æˆ–è€…å‡ºé”™\n        comsume_iterator(|i| (0..i).into_iter())\n    }\n}\n</code></pre><h2>å°ç»“</h2><p>æ³›å‹ç¼–ç¨‹åœ¨ Rust å¼€å‘ä¸­å æ®ç€ä¸¾è¶³è½»é‡çš„åœ°ä½ï¼Œå‡ ä¹ä½ å†™çš„æ¯ä¸€æ®µä»£ç éƒ½æˆ–å¤šæˆ–å°‘ä¼šä½¿ç”¨åˆ°æ³›å‹æœ‰å…³çš„ç»“æ„ï¼Œæ¯”å¦‚æ ‡å‡†åº“çš„ Vec&lt;T&gt;ã€HashMap&lt;K, V&gt; ç­‰ã€‚å½“æˆ‘ä»¬è‡ªå·±æ„å»ºæ•°æ®ç»“æ„å’Œå‡½æ•°æ—¶è¦æ€è€ƒï¼Œæ˜¯å¦ä½¿ç”¨æ³›å‹å‚æ•°ï¼Œè®©ä»£ç æ›´åŠ çµæ´»ã€å¯æ‰©å±•æ€§æ›´å¼ºã€‚</p><p>å½“ç„¶ï¼Œæ³›å‹ç¼–ç¨‹ä¹Ÿæ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚ä»»ä½•æ—¶å€™ï¼Œå½“æˆ‘ä»¬å¼•å…¥æŠ½è±¡ï¼Œå³ä¾¿èƒ½åšåˆ°é›¶æˆæœ¬æŠ½è±¡ï¼Œè¦è®°å¾—æŠ½è±¡æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§æˆæœ¬ã€‚</p><p>å½“æˆ‘ä»¬æŠŠä»£ç æŠ½è±¡æˆå‡½æ•°ã€æŠŠæ•°æ®ç»“æ„æŠ½è±¡æˆæ³›å‹ç»“æ„ï¼Œå³ä¾¿è¿è¡Œæ—¶å‡ ä¹å¹¶æ— æ·»åŠ é¢å¤–æˆæœ¬ï¼Œå®ƒè¿˜æ˜¯ä¼šå¸¦æ¥è®¾è®¡æ—¶çš„æˆæœ¬ï¼Œå¦‚æœæŠ½è±¡å¾—ä¸å¥½ï¼Œè¿˜ä¼šå¸¦æ¥æ›´å¤§çš„ç»´æŠ¤ä¸Šçš„æˆæœ¬ã€‚<strong>åšç³»ç»Ÿè®¾è®¡ï¼Œæˆ‘ä»¬è€ƒè™‘ ROIï¼ˆReturn On Investmentï¼‰æ—¶ï¼Œè¦æŠŠ TCOï¼ˆTotal Cost of Ownershipï¼‰ä¹Ÿè€ƒè™‘è¿›å»</strong>ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿‡åº¦è®¾è®¡çš„ç³»ç»Ÿå’Œä¸åšè®¾è®¡çš„ç³»ç»Ÿï¼Œå®ƒä»¬é•¿æœŸçš„ TCO éƒ½éå¸¸ç³Ÿç³•ã€‚</p><p>å»ºè®®ä½ åœ¨è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨å¤æ‚çš„æ³›å‹ç»“æ„å‰ï¼Œæœ€å¥½å…ˆåšä¸€äº›å‡†å¤‡ã€‚</p><p>é¦–å…ˆï¼Œè‡ªç„¶æ˜¯äº†è§£ä½¿ç”¨æ³›å‹çš„åœºæ™¯ï¼Œä»¥åŠä¸»è¦çš„æ¨¡å¼ï¼Œå°±åƒæœ¬æ–‡ä»‹ç»çš„é‚£æ ·ï¼›ä¹‹åï¼Œå¯ä»¥å¤šè¯»åˆ«äººçš„ä»£ç ï¼Œå¤šçœ‹ä¼˜ç§€çš„ç³»ç»Ÿï¼Œéƒ½æ˜¯å¦‚ä½•ä½¿ç”¨æ³›å‹æ¥è§£å†³å®é™…é—®é¢˜çš„ã€‚åŒæ—¶ï¼Œä¸è¦ç€æ€¥æŠŠå¤æ‚çš„æ³›å‹å¼•å…¥åˆ°ä½ è‡ªå·±çš„ç³»ç»Ÿä¸­ï¼Œå¯ä»¥å…ˆå¤šå†™ä¸€äº›å°çš„ã€æµ‹è¯•æ€§è´¨çš„ä»£ç ï¼Œå°±åƒæ–‡ä¸­çš„é‚£äº›ç¤ºä¾‹ä»£ç ä¸€æ ·ï¼Œä»å°å¤„ç€æ‰‹ï¼Œå»æ›´æ·±å…¥åœ°ç†è§£æ³›å‹ï¼›</p><p>æœ‰äº†è¿™äº›å‡†å¤‡æ‰“åº•ï¼Œæœ€ååœ¨ä½ çš„å¤§å‹é¡¹ç›®ä¸­ï¼Œéœ€è¦çš„æ—¶å€™å¼•å…¥è‡ªå·±çš„æ³›å‹æ•°æ®ç»“æ„æˆ–è€…å‡½æ•°ï¼Œå»è§£å†³å®é™…é—®é¢˜ã€‚</p><h3>æ€è€ƒé¢˜</h3><p>å¦‚æœä½ ç†è§£äº†ä»Šå¤©è®²çš„æ³›å‹çš„ç”¨æ³•ï¼Œé‚£ä¹ˆé˜…è¯» <a href=\"https://docs.rs/futures/0.3.17\">futures</a> åº“æ—¶ï¼Œé‡åˆ°ç±»ä¼¼çš„å¤æ‚æ³›å‹å£°æ˜ï¼Œæ¯”å¦‚è¯´ <a href=\"https://docs.rs/futures/0.3.17/futures/stream/trait.StreamExt.html\">StreamExt</a> trait çš„ <a href=\"https://docs.rs/futures/0.3.17/futures/stream/trait.StreamExt.html#method.for_each_concurrent\">for_each_concurrent</a>ï¼Œä½ èƒ½ææ˜ç™½å®ƒçš„å‚æ•° f ä»£è¡¨ä»€ä¹ˆå—ï¼Ÿä½ è¯¥æ€ä¹ˆä½¿ç”¨è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿ</p><pre><code class=\"language-rust\">fn for_each_concurrent&lt;Fut, F&gt;(\n    self,\n    limit: impl Into&lt;Option&lt;usize&gt;&gt;,\n    f: F,\n) -&gt; ForEachConcurrent&lt;Self, Fut, F&gt;\nwhere\n    F: FnMut(Self::Item) -&gt; Fut,\n    Fut: Future&lt;Output = ()&gt;,\n    Self: Sized,\n{\n{ ... }\n</code></pre><p>ä»Šå¤©ä½ å·²ç»å®Œæˆäº†Rustå­¦ä¹ çš„ç¬¬23æ¬¡æ‰“å¡ã€‚å¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"åŠ é¤ï½œæœŸä¸­æµ‹è¯•ï¼šå‚è€ƒå®ç°è®²è§£","id":425015},"right":{"article_title":"24ï½œç±»å‹ç³»ç»Ÿï¼šå¦‚ä½•åœ¨å®æˆ˜ä¸­ä½¿ç”¨trait objectï¼Ÿ","id":428018}},"comments":[{"had_liked":false,"id":317328,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1634742246,"is_pvip":false,"replies":[{"id":"115240","content":"ğŸ‘ æ˜¯çš„ï¼Œéå¸¸å‰å®³ï¼è¿™ä¸ª bug æˆ‘ä¹Ÿæ˜¯åˆçœ‹äº†ä¸€éä»£ç æ‰å‘ç°ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1635121984,"ip_address":"","comment_id":317328,"utype":1}],"discussion_count":1,"race_medal":2,"score":"31699513318","product_id":100085301,"comment_content":"impl Iterator for Equation&lt;Quadratic&gt; åˆ¤æ–­è¿”å› None çš„åœ°æ–¹æ˜¯ä¸æ˜¯åº”è¯¥å†™æˆ `if self.current &gt;= u16::MAX as u32`ï¼Œä¸ç„¶ä¼šæœ‰é€»è¾‘é”™è¯¯ã€‚","like_count":8,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528767,"discussion_content":"ğŸ‘ æ˜¯çš„ï¼Œéå¸¸å‰å®³ï¼è¿™ä¸ª bug æˆ‘ä¹Ÿæ˜¯åˆçœ‹äº†ä¸€éä»£ç æ‰å‘ç°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635121984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316700,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1634518938,"is_pvip":false,"replies":[{"id":"114679","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1634537586,"ip_address":"","comment_id":316700,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23109355418","product_id":100085301,"comment_content":"å’Œè€å¸ˆçš„å¯¹åº”ä¸‹...<br><br>1. ä½¿ç”¨æ³›å‹å‚æ•°å»¶è¿Ÿæ•°æ®ç»“æ„çš„ç»‘å®šï¼›<br>2. ä½¿ç”¨æ³›å‹å‚æ•°å’Œ PhantomDataï¼Œå£°æ˜æ•°æ®ç»“æ„ä¸­ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†åœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ç±»å‹<br>3. ä½¿ç”¨æ³›å‹å‚æ•°è®©åŒä¸€ä¸ªæ•°æ®ç»“æ„å¯¹åŒä¸€ä¸ª trait å¯ä»¥æ‹¥æœ‰ä¸åŒçš„å®ç°ã€‚<br><br>1. é¢å‘interfaceç¼–ç¨‹; åªä¸è¿‡é™æ€å¤šæ€<br>2. å¼•å…¥è‡ªç”±å‚æ•° -&gt; å¤§éƒ¨åˆ†implå…±äº«; å‰©ä¸‹çš„, æ ¹æ®è‡ªç”±å‚æ•°ç±»å‹çš„ä¸åŒåštemplate specialization -&gt; æ¯”å¦‚tag struct -&gt; æœ¬è´¨è¿˜æ˜¯ä»£ç å…±äº«<br>3. NewTypePattern; ä¸€å¥—ä»£ç ç»™å¤šä¸ªä¸åŒçš„typeå…±ç”¨; è¿™ä¸ªblogé‡Œé¢çš„ä¾‹å­æ¯”è¾ƒç”ŸåŠ¨: https:&#47;&#47;www.greyblake.com&#47;blog&#47;2021-10-11-phantom-types-in-rust&#47;; golangé‡Œé¢ä¹Ÿç»å¸¸ç”¨kilometer, mileæ¥åšä¾‹å­, ç±»ä¼¼äº`type mile i32`;","like_count":6,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528463,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634537586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316685,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1634510634,"is_pvip":false,"replies":[{"id":"114684","content":"æˆ‘çš„ç†è§£æ˜¯å¤§éƒ¨åˆ†æ—¶å€™ PhantomData è·Ÿå…¶å®ƒè¯­è¨€çš„ Phantom Type æ˜¯ä¸€ä¸ªä½œç”¨ï¼Œä¸ºæ•°æ®ç»“æ„æä¾›å£°æ˜æ—¶æ²¡ç”¨ç”¨åˆ°ï¼Œä½†åœ¨å®ç°æ—¶éœ€è¦ç”¨åˆ°çš„ç±»å‹ã€‚å› ä¸ºè¿™é‡Œä½ å®å®åœ¨åœ¨å°±åªç”¨ T æ¥ä¿è¯ç±»å‹çš„æ­£ç¡®æ€§ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ° owershipã€‚<br><br>ä½†åœ¨æœ‰äº›åœºåˆä¸‹ï¼Œæ¯”å¦‚ Unique&lt;T&gt;ï¼Œè¿™é‡Œï¼Œå¦‚æœæ²¡ç”¨ PhantomData&lt;T&gt;çš„è¯ï¼Œä½ æƒ³æƒ³ Unique&lt;T&gt; æ˜¯å¦ own Tï¼Ÿå¹¶ä¸ ownï¼Œå› ä¸º pointer æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œæ‰€ä»¥ä»ç±»å‹ä¸Šï¼ŒUnique&lt;T&gt; ä¸ own Tï¼Œä½†è¿™é‡Œ Unique&lt;T&gt; åº”è¯¥ own T æ‰å¯¹ã€‚æ‰€ä»¥ Rust ä½¿ç”¨ PhantomData æ¥è¡¨è¿°è¿™ä¸ªä½œç”¨ï¼Œè§ï¼šhttps:&#47;&#47;github.com&#47;rust-lang&#47;rfcs&#47;blob&#47;master&#47;text&#47;0769-sound-generic-drop.md#phantom-data<br><br>```Rust<br>pub struct Unique&lt;T: ?Sized&gt; {<br>    pointer: *const T,<br>    _marker: PhantomData&lt;T&gt;,<br>}<br>```<br><br>è¿™å±äº PhantomData çš„é«˜çº§ç”¨æ³•ï¼Œå¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬ç”¨ç±»å‹ç³»ç»Ÿè§£å†³é—®é¢˜éœ€è¦ä½¿ç”¨ PhantomData æ—¶ï¼Œéƒ½æ˜¯å¤§å®¶åœ¨å…¶ä»–è¯­è¨€ä¸­æƒ¯å¸¸çš„ç”¨æ³•ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰æè¿™ä¸ª owership çš„ç”¨æ³•ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1634539075,"ip_address":"","comment_id":316685,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14519412522","product_id":100085301,"comment_content":"Cppé‡Œé¢ç”¨tagå’Œå¤šgeneric paramçš„ä¾‹å­ä¹Ÿå¾ˆå¤šâ€¦<br><br>æ¯”å¦‚Cppçš„iterator, å¤šä¸ªæ³›å‹åšå‚æ•°, ä¸éœ€è¦PhantomData; <br><br>    template&lt;<br>        class Category,  &#47;&#47; tag data, ç±»ä¼¼äº AsyncProstReader D<br>        class T,<br>        class Distance = std::ptrdiff_t,<br>        class Pointer = T*,<br>        class Reference = T&amp;<br>    &gt; struct iterator;<br><br>æ‰€ä»¥, æ„Ÿè§‰PhantomDataçš„ä¸»è¦ç”¨é€”æ˜¯compile time ownership check;<br><br>æˆ‘çš„ç–‘é—®ä¹Ÿå°±ä¸»è¦é›†ä¸­åœ¨ownership...<br><br>é—®é¢˜1:<br><br>from PhantomData doc:<br>&gt; Adding a PhantomData field to your type tells the compiler that your type acts as though it stores a value of type T, even though it doesnâ€™t really. <br><br>ä¸å¤ªæ˜ç™½, ä¸ºå•¥éœ€è¦ownership. æ¯”å¦‚AsyncProstReaderçš„Tæ˜¯çº¦æŸRçš„return typeçš„, æŒ‰ç†è¯´ä¸ç”¨own T;  è€Œä¸”intoå’Œdest memberå…¨ç¨‹æ²¡è¢«è°ƒç”¨è¿‡<br><br><br>    &#47;&#47;&#47; A wrapper around an async reader that produces an asynchronous stream of prost-decoded values<br>    #[derive(Debug)]<br>    pub struct AsyncProstReader&lt;R, T, D&gt; {<br>        reader: R,<br>        pub(crate) buffer: BytesMut,<br>        into: PhantomData&lt;T&gt;,<br>        dest: PhantomData&lt;D&gt;,<br>    }<br><br>å¦‚æœä¸éœ€è¦å¯¹T, Dçš„ownership, ä¸ºå•¥ä¸æ¥ä¸ª`PhantomDataNotOwned`æ¥æ»¡è¶³è¿™æ ·çš„åœºæ™¯: ä¸éœ€è¦ownership, ä½†æ˜¯è¿™ä¸ªgeneric type Tä¸æ˜¯å¤šä½™çš„å‘¢?<br><br>----<br><br>é—®é¢˜2:<br><br>&gt; This information is used when computing certain safety properties.<br><br>è¿™å¥ç›®å‰ç†è§£ä¸äº†â€¦å‡è®¾å¯¹Tæœ‰ownership, æ²¡çœ‹å‡ºæœ‰å•¥ç‰¹æ®Šçš„safetyéœ€æ±‚<br>","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528458,"discussion_content":"æˆ‘çš„ç†è§£æ˜¯å¤§éƒ¨åˆ†æ—¶å€™ PhantomData è·Ÿå…¶å®ƒè¯­è¨€çš„ Phantom Type æ˜¯ä¸€ä¸ªä½œç”¨ï¼Œä¸ºæ•°æ®ç»“æ„æä¾›å£°æ˜æ—¶æ²¡ç”¨ç”¨åˆ°ï¼Œä½†åœ¨å®ç°æ—¶éœ€è¦ç”¨åˆ°çš„ç±»å‹ã€‚å› ä¸ºè¿™é‡Œä½ å®å®åœ¨åœ¨å°±åªç”¨ T æ¥ä¿è¯ç±»å‹çš„æ­£ç¡®æ€§ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ° owershipã€‚\n\nä½†åœ¨æœ‰äº›åœºåˆä¸‹ï¼Œæ¯”å¦‚ Unique&amp;lt;T&amp;gt;ï¼Œè¿™é‡Œï¼Œå¦‚æœæ²¡ç”¨ PhantomData&amp;lt;T&amp;gt;çš„è¯ï¼Œä½ æƒ³æƒ³ Unique&amp;lt;T&amp;gt; æ˜¯å¦ own Tï¼Ÿå¹¶ä¸ ownï¼Œå› ä¸º pointer æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œæ‰€ä»¥ä»ç±»å‹ä¸Šï¼ŒUnique&amp;lt;T&amp;gt; ä¸ own Tï¼Œä½†è¿™é‡Œ Unique&amp;lt;T&amp;gt; åº”è¯¥ own T æ‰å¯¹ã€‚æ‰€ä»¥ Rust ä½¿ç”¨ PhantomData æ¥è¡¨è¿°è¿™ä¸ªä½œç”¨ï¼Œè§ï¼šhttps://github.com/rust-lang/rfcs/blob/master/text/0769-sound-generic-drop.md#phantom-data\n\n```Rust\npub struct Unique&amp;lt;T: ?Sized&amp;gt; {\n    pointer: *const T,\n    _marker: PhantomData&amp;lt;T&amp;gt;,\n}\n```\n\nè¿™å±äº PhantomData çš„é«˜çº§ç”¨æ³•ï¼Œå¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬ç”¨ç±»å‹ç³»ç»Ÿè§£å†³é—®é¢˜éœ€è¦ä½¿ç”¨ PhantomData æ—¶ï¼Œéƒ½æ˜¯å¤§å®¶åœ¨å…¶ä»–è¯­è¨€ä¸­æƒ¯å¸¸çš„ç”¨æ³•ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰æè¿™ä¸ª owership çš„ç”¨æ³•ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1634539075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111835,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","nickname":"Marvichov","note":"","ucode":"7482099415C41C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405541,"discussion_content":"æ„Ÿè°¢è€å¸ˆğŸ™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634573347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344926,"user_name":"A.Y.","can_delete":false,"product_type":"c1","uid":2029589,"ip_address":"","ucode":"7A9701DD436547","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f8/15/2724d7ec.jpg","comment_is_top":false,"comment_ctime":1651880966,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5946848262","product_id":100085301,"comment_content":"å…³äºç¬¬ä¸‰ç‚¹ä½¿ç”¨åœºæ™¯ï¼Œä¼¼ä¹å¯ä»¥ç”¨äºæ›¿ä»£å…¶ä»–é¢å‘å¯¹è±¡è¯­è¨€ä¸­æœ‰è€Œrustä¸æ”¯æŒçš„ç±»ç»§æ‰¿ã€‚","like_count":1},{"had_liked":false,"id":357067,"user_name":"ğŸ²ç¤sir","can_delete":false,"product_type":"c1","uid":1016004,"ip_address":"å››å·","ucode":"6AF330B5B9C2CC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/80/c4/1c0e3b84.jpg","comment_is_top":false,"comment_ctime":1662903654,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1662903654","product_id":100085301,"comment_content":"ç»ˆäºæ˜ç™½substrateçš„frame&#47;executiv&#47;src&#47;lib.rsé‡Œé¢è¿™æ®µä»£ç çš„ç”¨æ„ï¼š","like_count":0,"discussions":[{"author":{"id":1016004,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/80/c4/1c0e3b84.jpg","nickname":"ğŸ²ç¤sir","note":"","ucode":"6AF330B5B9C2CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587371,"discussion_content":"ä¸Šæ¬¡è¯„è®ºæ²¡æœ‰è´´æˆåŠŸï¼Œè¿™é‡ŒåŠ ä¸€ä¸‹ï¼š\n\npub struct Executive&lt;\n    System,\n    Block,\n    Context,\n    UnsignedValidator,\n    AllPalletsWithSystem,\n    OnRuntimeUpgrade = (),\n&gt;(\n    PhantomData&lt;(\n        System,\n        Block,\n        Context,\n        UnsignedValidator,\n        AllPalletsWithSystem,\n        OnRuntimeUpgrade,\n    )&gt;,\n);","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662997826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354510,"user_name":"zahi","can_delete":false,"product_type":"c1","uid":1447887,"ip_address":"åŒ—äº¬","ucode":"F64ABEB63C6D1F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIofiaCAziajdQnbvrfpEkpCKVFgO62y6zicamhjF1BAWZSRcCVaTBXLIerLsGeZCic7XS7KOEkTN4fRg/132","comment_is_top":false,"comment_ctime":1660478150,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1660478150","product_id":100085301,"comment_content":"phantom type çš„ä¾‹å­ï¼Œæ„Ÿè§‰åƒjavaä¸­çš„ç»§æ‰¿ã€‚","like_count":0},{"had_liked":false,"id":345857,"user_name":"Geek_7c0961","can_delete":false,"product_type":"c1","uid":2277181,"ip_address":"","ucode":"B1482E64FF9E4E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8aLz0tWdsZuMiaNUAd0dicSD9M6A77seMGFdHgvsQwOzN8ztYPiaJSo53DcbjQWUQpw4pf4rI2f7vg/132","comment_is_top":false,"comment_ctime":1652641224,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1652641224","product_id":100085301,"comment_content":"è€å¸ˆç°åœ¨implement trait ç”¨åœ¨è¿”å›å€¼çš„ç±»å‹äº†,é‚£ä¹ˆ trait obejctè¿˜æœ‰ä»€ä¹ˆç”¨å¤„ä¹ˆ?å®ƒçš„æ€§èƒ½é‚£ä¹ˆå·®.<br>https:&#47;&#47;doc.rust-lang.org&#47;rust-by-example&#47;trait&#47;impl_trait.html","like_count":0},{"had_liked":false,"id":330926,"user_name":"æ¸¡é¸¦10086","can_delete":false,"product_type":"c1","uid":2491000,"ip_address":"","ucode":"58D72C8B5E9B98","user_header":"https://static001.geekbang.org/account/avatar/00/26/02/78/4d40b4b2.jpg","comment_is_top":false,"comment_ctime":1642303432,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1642303432","product_id":100085301,"comment_content":"å…³äºæ€è€ƒé¢˜ï¼š<br>f æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä»¥ `Self::Item` ç±»å‹ä½œä¸ºè¾“å…¥ï¼Œä»¥ä¸€ä¸ªå®ç°äº† `Future` trait çš„ç±»å‹ Fut ä½œä¸ºè¾“å‡ºï¼Œå…¶ä¸­`Future` çš„å…³è”ç±»å‹ `Output` æ˜¯ unit ç±»å‹","like_count":0},{"had_liked":false,"id":318810,"user_name":"Custer","can_delete":false,"product_type":"c1","uid":1020822,"ip_address":"","ucode":"8AEA5544C94D57","user_header":"https://static001.geekbang.org/account/avatar/00/0f/93/96/575d42c3.jpg","comment_is_top":false,"comment_ctime":1635431584,"is_pvip":true,"replies":[{"id":"116407","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"Tyr","uid":"1079375","ctime":1636558021,"ip_address":"","comment_id":318810,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1635431584","product_id":100085301,"comment_content":"1. å‚æ•° F æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œæ¥æ”¶ Self::Item,è¿”å› Fut ç±»å‹ï¼›<br>2. å‚æ•° Fut æ˜¯ä¸€ä¸ª Future&lt;Output=()&gt;;<br><br>æ‰€ä»¥ f æ˜¯ä¸€ä¸ªé—­åŒ…æ¥æ”¶ Self::Item é—­åŒ…çš„è¿”å›å€¼æ˜¯ Future&lt;Output=()&gt;<br><br>ä½¿ç”¨å‚è€ƒæºä»£ç ï¼š<br><br>```rust<br>.for_each_concurrent(<br>    &#47;* limit *&#47; 2,<br>    |rx| async move {<br>        rx.await.unwrap();<br>    }<br>)<br>```<br>","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529386,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636558021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}