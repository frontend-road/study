{"id":486353,"title":"13ï½œé«˜æ€§èƒ½ç½‘ç»œå®æˆ˜ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•å®Œå–„è´Ÿè½½å‡è¡¡å™¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ ä½¿ç”¨ sockops å’Œ sk_msg ç­‰å¥—æ¥å­— eBPF ç¨‹åºï¼Œåœ¨å†…æ ¸æ€å¯¹å¥—æ¥å­—è¿›è¡Œè½¬å‘ï¼Œæå‡äº†è´Ÿè½½å‡è¡¡çš„æ€§èƒ½ã€‚</p><p>å¯¹äºç½‘ç»œä¼˜åŒ–æ¥è¯´ï¼Œé™¤äº†å¥—æ¥å­— eBPF ç¨‹åºï¼ŒXDP ç¨‹åºå’Œ TC ç¨‹åºä¹Ÿå¯ä»¥ç”¨æ¥ä¼˜åŒ–ç½‘ç»œçš„æ€§èƒ½ã€‚ç‰¹åˆ«æ˜¯ XDP ç¨‹åºï¼Œç”±äºå®ƒåœ¨ Linux å†…æ ¸åè®®æ ˆä¹‹å‰å°±å¯ä»¥å¤„ç†ç½‘ç»œåŒ…ï¼Œåœ¨è´Ÿè½½å‡è¡¡ã€é˜²ç«å¢™ç­‰éœ€è¦é«˜æ€§èƒ½ç½‘ç»œçš„åœºæ™¯ä¸­å·²ç»å¾—åˆ°å¤§é‡çš„åº”ç”¨ã€‚</p><p>XDP ç¨‹åºåœ¨å†…æ ¸åè®®æ ˆåˆå§‹åŒ–ä¹‹å‰è¿è¡Œï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åœ¨ XDP ç¨‹åºä¸­ï¼Œä½ å¹¶ä¸èƒ½åƒåœ¨ sockops ç­‰ç¨‹åºä¸­é‚£æ ·ç›´æ¥è·å¾—å¥—æ¥å­—çš„è¯¦ç»†ä¿¡æ¯ã€‚ä½¿ç”¨ XDP ç¨‹åºåŠ é€Ÿè´Ÿè½½å‡è¡¡ï¼Œé€šå¸¸ä¹Ÿå°±æ„å‘³ç€éœ€è¦ä»å¤´å¼€å‘ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç¨‹åºã€‚è¿™æ˜¯ä¸æ˜¯è¯´ XDP çš„ä½¿ç”¨å°±ç‰¹åˆ«å¤æ‚ï¼Œéœ€è¦é‡æ–°å®ç°å†…æ ¸åè®®æ ˆçš„å¾ˆå¤šé€»è¾‘å‘¢ï¼Ÿä¸è¦æ‹…å¿ƒï¼Œ<strong>XDP å¤„ç†è¿‡çš„æ•°æ®åŒ…è¿˜å¯ä»¥æ­£å¸¸é€šè¿‡å†…æ ¸åè®®æ ˆç»§ç»­å¤„ç†ï¼Œæ‰€ä»¥ä½ åªéœ€è¦åœ¨ XDP ç¨‹åºä¸­å®ç°æœ€æ ¸å¿ƒçš„ç½‘ç»œé€»è¾‘å°±å¯ä»¥äº†</strong>ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘å°±ä»¥ XDP ç¨‹åºä¸ºä¾‹ï¼Œå¸¦ä½ ç»§ç»­ä¼˜åŒ–å’Œå®Œå–„è´Ÿè½½å‡è¡¡å™¨çš„æ€§èƒ½ã€‚</p><h2>æ¡ˆä¾‹å‡†å¤‡</h2><p>è·Ÿä¸Šä¸€è®²ç±»ä¼¼ï¼Œä¸ºäº†æ–¹ä¾¿ç¯å¢ƒçš„é‡ç°ï¼Œè´Ÿè½½å‡è¡¡å™¨ã€Web æœåŠ¡å™¨ä»¥åŠå®¢æˆ·ç«¯éƒ½è¿˜æ˜¯è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œå®ƒä»¬çš„ IP å’Œ MAC ç­‰åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/15/e923026f577f7b991be2610734f9e415.jpg?wh=1920x1706\" alt=\"å›¾ç‰‡\"><br>\næ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯åŠ¨è¿™å‡ ä¸ªå®¹å™¨ï¼š</p><pre><code class=\"language-bash\"># Webserver\ndocker run -itd --name=http1 --hostname=http1 feisky/webserver\ndocker run -itd --name=http2 --hostname=http2 feisky/webserver\n\n# Client\ndocker run -itd --name=client alpine\n\n# LB\ndocker run -itd --name=lb --privileged -v /sys/kernel/debug:/sys/kernel/debug alpine\n</code></pre><!-- [[[read_end]]] --><blockquote>\n<p>å°æç¤ºï¼šåœ¨é»˜è®¤å®‰è£…çš„ Docker ç¯å¢ƒä¸­ï¼Œå‡å¦‚ä½ æ²¡æœ‰è¿è¡Œå…¶ä»–å®¹å™¨ï¼Œè¿è¡Œä¸Šè¿°å‘½ä»¤åå¾—åˆ°çš„ IP åœ°å€è·Ÿå›¾ä¸­æ˜¯ç›¸åŒçš„ã€‚</p>\n</blockquote><p>æ³¨æ„ï¼Œæˆ‘ä»¬æŠŠä½œä¸ºè´Ÿè½½å‡è¡¡å™¨çš„ Nginx æ¢æˆäº†åŸºäº alpine é•œåƒçš„ SHELL å®¹å™¨ï¼Œå¹¶ä¸”ä»¥ç‰¹æƒå®¹å™¨çš„æ–¹å¼è¿è¡Œï¼Œä»¥ä¾¿æœ‰è¶³å¤Ÿçš„æƒé™åŠ è½½å¹¶è¿è¡Œ XDP ç¨‹åºã€‚</p><p>æŠŠ XDP ç¨‹åºæ”¾å…¥å®¹å™¨ä¸­ï¼Œé™¤äº†å®¹æ˜“å¤ç°æ¡ˆä¾‹ç¯å¢ƒä¹‹å¤–ï¼Œåœ¨å¼€å‘å’Œè°ƒè¯• XDP ç¨‹åºçš„è¿‡ç¨‹ä¸­ä¹Ÿä¸ä¼šå½±å“ä¸»æœºçš„ç½‘ç»œï¼ˆå¦åˆ™ï¼Œé”™è¯¯çš„ XDP ç¨‹åºå¯èƒ½å¯¼è‡´ä¸»æœºç½‘ç»œä¸­æ–­ï¼Œè¿›è€Œä¹Ÿä¼šå½±å“è¿œç¨‹ SSH è¿æ¥ï¼‰ã€‚</p><p>ç”±äºè´Ÿè½½å‡è¡¡å®¹å™¨åªå¯åŠ¨äº†ä¸€ä¸ª SHELL ç¯å¢ƒï¼Œå¹¶æ²¡æœ‰è¿è¡ŒçœŸæ­£çš„è´Ÿè½½å‡è¡¡æœåŠ¡ã€‚æ­¤æ—¶ï¼Œè®¿é—®è´Ÿè½½å‡è¡¡å™¨çš„ TCP 80 ç«¯å£ä¼šç›´æ¥å¤±è´¥ã€‚ä½ å¯ä»¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤åˆ°å®¢æˆ·ç«¯å®¹å™¨ä¸­éªŒè¯ï¼ˆ<code>/ #</code> åçš„å‘½ä»¤è¡¨ç¤ºåœ¨å®¹å™¨ç»ˆç«¯ä¸­è¿è¡Œï¼‰ï¼š</p><pre><code class=\"language-bash\">docker exec -it client sh\n/ # apk add curl --update\n/ # curl \"http://172.17.0.5\"\ncurl: (7) Failed to connect to 172.17.0.5 port 80 after 1 ms: Connection refused\n</code></pre><p>æ¡ˆä¾‹æ‰€éœ€çš„å®¹å™¨ç¯å¢ƒå¯åŠ¨å®Œæ¯•åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹çœ‹ï¼Œå¦‚ä½•ä½¿ç”¨ XDP å¼€å‘ä¸€ä¸ªè´Ÿè½½å‡è¡¡æœåŠ¡ã€‚ç”±äºéœ€è¦æŠŠ XDP å­—èŠ‚ç æ”¾åˆ°å®¹å™¨ä¸­è¿è¡Œï¼Œæœ¬ç€æœ€å°ä¾èµ–çš„åŸåˆ™ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ libbpf ä½œä¸º XDP çš„åŸºç¡€åº“ï¼Œè¿™æ ·åªéœ€è¦æŠŠç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾å…¥å®¹å™¨ä¸­å³å¯è¿è¡Œã€‚</p><h2>å¦‚ä½•ç”¨ XDP å¼€å‘ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Ÿ</h2><p>è¿˜è®°å¾—æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/484372\"> 08 è®²</a> ä¸­æåˆ°è¿‡çš„åŸºäº libbpf å¼€å‘ eBPF ç¨‹åºçš„åŸºæœ¬æ­¥éª¤å—ï¼Ÿä¸è®°å¾—ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹ã€‚ libbpf çš„ä½¿ç”¨é€šå¸¸åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ol>\n<li>å¼€å‘ eBPF ç¨‹åºï¼Œå¹¶æŠŠæºæ–‡ä»¶å‘½åä¸º <code>&lt;ç¨‹åºå&gt;.bpf.c</code>ï¼›</li>\n<li>ç¼–è¯‘ eBPF ç¨‹åºä¸ºå­—èŠ‚ç ï¼Œç„¶åå†è°ƒç”¨&nbsp;<code>bpftool gen skeleton</code>&nbsp;ä¸º eBPF å­—èŠ‚ç ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶ï¼›</li>\n<li>å¼€å‘ç”¨æˆ·æ€ç¨‹åºï¼Œå¼•å…¥ç”Ÿæˆçš„è„šæ‰‹æ¶å¤´æ–‡ä»¶åï¼ŒåŠ è½½ eBPF ç¨‹åºå¹¶æŒ‚è½½åˆ°ç›¸åº”çš„å†…æ ¸äº‹ä»¶ä¸­ã€‚</li>\n</ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æŒ‰è¿™å‡ ä¸ªæ­¥éª¤æ¥å¼€å‘ XDP è´Ÿè½½å‡è¡¡ç¨‹åºã€‚</p><h3>å¼€å‘ XDP eBPF ç¨‹åº</h3><p>ç¬¬ä¸€æ­¥æ˜¯å¼€å‘ä¸€ä¸ªè¿è¡Œåœ¨å†…æ ¸æ€çš„ eBPF ç¨‹åºã€‚å‚è€ƒå†…æ ¸ä¸­ BPF_PROG_TYPE_XDP ç¨‹åºç±»å‹çš„<a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/linux/bpf_types.h#L11\">å®šä¹‰æ ¼å¼</a>ï¼Œå®ƒçš„å‚æ•°ç±»å‹ä¸º <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L5283\">struct xdp_md</a>ï¼š</p><pre><code class=\"language-c++\">#define BPF_PROG_TYPE(_id, _name, prog_ctx_type, kern_ctx_type)\n\nBPF_PROG_TYPE(BPF_PROG_TYPE_XDP, xdp,\n       struct xdp_md, struct xdp_buff)\n</code></pre><p>å› è€Œï¼Œä½ å°±å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼æ¥å®šä¹‰è¿™ä¸ª XDP ç¨‹åºï¼š</p><pre><code class=\"language-c++\">SEC(\"xdp\")\nint xdp_proxy(struct xdp_md *ctx)\n{\n  // TODO: æ·»åŠ XDPè´Ÿè½½å‡è¡¡é€»è¾‘\n}\n</code></pre><p>è¿™æ®µä»£ç ä¸­ï¼Œ<code>SEC(\"xdp\")</code> è¡¨ç¤ºç¨‹åºçš„ç±»å‹ä¸º XDP ç¨‹åºã€‚ä½ å¯ä»¥åœ¨ libbpf ä¸­ <a href=\"https://github.com/libbpf/libbpf/blob/master/src/libbpf.c#L8599-L8675\">section_defs</a>æ‰¾åˆ°æ‰€æœ‰ eBPF ç¨‹åºç±»å‹å¯¹åº”çš„æ®µåç§°æ ¼å¼ã€‚</p><p>å‚è€ƒ <code>linux/bpf.h</code> å¤´æ–‡ä»¶ä¸­ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L5283\">struct xdp_md</a> çš„å®šä¹‰æ ¼å¼ï¼Œä½ å¯ä»¥å‘ç°ï¼Œå®ƒæ¯”ä¸Šä¸€è®²ç”¨åˆ°çš„ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/bpf.h#L5506\">struct bpf_sock_ops</a> ç®€å•å¤šäº†ï¼ŒåªåŒ…å«äº†å¦‚ä¸‹çš„å‡ ä¸ªå­—æ®µï¼š</p><pre><code class=\"language-c++\">struct xdp_md {\n  __u32 data;\n  __u32 data_end;\n  __u32 data_meta;\n  /* Below access go through struct xdp_rxq_info */\n  __u32 ingress_ifindex; /* rxq-&gt;dev-&gt;ifindex */\n  __u32 rx_queue_index;  /* rxq-&gt;queue_index  */\n  __u32 egress_ifindex;  /* txq-&gt;dev-&gt;ifindex */\n};\n</code></pre><p>ä» <code>struct xdp_md</code> çš„å®šä¹‰ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯æ•´å‹æ•°å€¼ï¼Œå…¶ä¸­å‰ä¸‰ä¸ªè¡¨ç¤ºæ•°æ®æŒ‡é’ˆä¿¡æ¯ï¼ˆåŒ…æ‹¬å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€å…ƒæ•°æ®ä½ç½®ï¼‰ï¼Œè€Œåä¸‰ä¸ªè¡¨ç¤ºå…³è”ç½‘å¡çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…¥å£ç½‘å¡ã€å…¥å£ç½‘å¡é˜Ÿåˆ—ä»¥åŠå‡ºå£ç½‘å¡çš„ç¼–å·ï¼‰ã€‚</p><p>ç”±äº <code>struct xdp_md</code> ä¸­å¹¶ä¸åŒ…å« skb æ•°æ®ç»“æ„ï¼Œåœ¨ XDP ç¨‹åºä¸­ï¼Œä½ åªèƒ½é€šè¿‡ <code>data</code> å’Œ <code>data_end</code> è¿™ä¸¤ä¸ªæŒ‡é’ˆå»è®¿é—®ç½‘ç»œæŠ¥æ–‡æ•°æ®ã€‚è€Œè¦æƒ³åˆ©ç”¨åŸå§‹ç½‘ç»œæ•°æ®æŒ‡é’ˆæ¥è®¿é—®ç½‘ç»œæ•°æ®ï¼Œå°±éœ€è¦ä½ äº†è§£ TCP/IP ç½‘ç»œæŠ¥æ–‡çš„åŸºæœ¬æ ¼å¼ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œæ ‡è®°äº†ä»¥å¤ªç½‘å¤´ã€IP å¤´ä»¥åŠ TCP å¤´ç­‰ç›¸å¯¹äº <code>struct xdp_md</code> ä¸­æ•°æ®æŒ‡é’ˆçš„ä½ç½®å…³ç³»ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/yy/91/yy7887570f06c1d075eb31701924e791.jpg?wh=1920x577\" alt=\"å›¾ç‰‡\"><br>\næœ‰äº†è¿™äº›å¯¹åº”å…³ç³»ï¼Œè¦è®¿é—® TCP/IP åè®®æŸä¸€å±‚çš„å¤´ç»“æ„ï¼Œå°±å¯ä»¥ä½¿ç”¨å¼€å§‹æŒ‡é’ˆ <code>data</code> å†åŠ ä¸Šå®ƒä¹‹å‰æ‰€æœ‰å¤´ç»“æ„å¤§å°çš„åç§»ã€‚</p><p>æ¯”å¦‚ï¼Œå¯¹äºä»¥å¤ªç½‘å¤´ï¼Œå®ƒçš„ä½ç½®è·Ÿå¼€å§‹ä½ç½® <code>data</code> æ˜¯ç›¸åŒçš„ï¼Œå› è€Œä½ å°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼ï¼ŒæŠŠå®ƒè½¬æ¢ä¸ºæŒ‡é’ˆæ ¼å¼è¿›è¡Œè®¿é—®ï¼š</p><pre><code class=\"language-c++\">void *data = (void *)(long)ctx-&gt;data;\nvoid *data_end = (void *)(long)ctx-&gt;data_end;\n\nstruct ethhdr *eth = data;\nif (data + sizeof(struct ethhdr) &gt; data_end)\n{\n  return XDP_ABORTED;\n}\n</code></pre><p>ä¸ºäº†å¸®åŠ© eBPF æ ¡éªŒå™¨éªŒè¯æ•°æ®è®¿é—®çš„åˆæ³•æ€§ï¼Œåœ¨è®¿é—®ä»¥å¤ªç½‘å¤´æ•°æ®ç»“æ„ <code>struct ethhdr</code> ä¹‹å‰ï¼Œä½ éœ€è¦æ£€æŸ¥æ•°æ®æŒ‡é’ˆæ˜¯å¦è¶Šç•Œã€‚å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°±è¦è¿”å›ä¸€ä¸ªé”™è¯¯ï¼ˆè¿™å„¿è¿”å›çš„ <code>XDP_ABORTED</code> è¡¨ç¤ºä¸¢å¼ƒæ•°æ®åŒ…å¹¶è®°å½•é”™è¯¯è¡Œä¸ºä»¥ä¾¿æ’é”™ï¼‰ã€‚</p><p>äº†è§£äº†å¤ªç½‘å¤´çš„è®¿é—®æ ¼å¼ä¹‹åï¼ŒIP å¤´çš„è®¿é—®ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚åœ¨å¼€å§‹æŒ‡é’ˆ <code>data</code> ä¹‹ååŠ ä¸Šå¤ªç½‘å¤´æ•°æ®ç»“æ„çš„é•¿åº¦åç§»ï¼Œå°±æ˜¯ IP å¤´æ‰€æŒ‡å‘çš„ä½ç½®ã€‚æ‹¿åˆ° IP å¤´ä¹‹åï¼Œä½ è¿˜å¯ä»¥å¯¹ç½‘ç»œæ•°æ®è¿›è¡Œåˆæ­¥çš„æ ¡éªŒï¼Œæ¯”å¦‚å¿½ç•¥ IPv6ã€UDP ç­‰æˆ‘ä»¬ä¸å…³å¿ƒçš„æ•°æ®ï¼Œåªå¤„ç† TCP æ•°æ®åŒ…ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-c++\">struct iphdr *iph = data + sizeof(struct ethhdr);\nif (data + sizeof(struct ethhdr) + sizeof(struct iphdr) &gt; data_end)\n{\n  return XDP_ABORTED;\n}\n\nif (eth-&gt;h_proto != bpf_htons(ETH_P_IP))\n{\n  return XDP_PASS;\n}\n\nif (iph-&gt;protocol != IPPROTO_TCP)\n{\n  return XDP_PASS;\n}\n</code></pre><p>è¿™æ®µä»£ç ä¸­è¿”å›çš„ <code>XDP_PASS</code> è¡¨ç¤ºæŠŠç½‘ç»œåŒ…ä¼ é€’ç»™å†…æ ¸åè®®æ ˆï¼Œå†…æ ¸åè®®æ ˆæ¥æ”¶åˆ°ç½‘ç»œåŒ…åï¼ŒæŒ‰æ­£å¸¸æµç¨‹ç»§ç»­å¤„ç†ã€‚</p><p>è¿›è¡Œäº†åŸºæœ¬çš„æ ¡éªŒä¹‹åï¼Œå†æ¥ä¸‹æ¥å°±æ˜¯å®ç°è´Ÿè½½å‡è¡¡çš„é€»è¾‘äº†ã€‚ç”±äºæˆ‘ä»¬æƒ³è¦å®ç°çš„æ˜¯ä¸€ä¸ªå››å±‚è´Ÿè½½å‡è¡¡ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œè´Ÿè½½å‡è¡¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ä¹‹åï¼Œéœ€è¦æŠŠç›®çš„åœ°å€ï¼ˆåŒ…æ‹¬ IP å’Œ MACï¼‰æ›¿æ¢æˆåç«¯ Webserver çš„åœ°å€ï¼Œå†é‡æ–°å‘åˆ°å†…æ ¸åè®®æ ˆä¸­ç»§ç»­å¤„ç†ã€‚</p><p>å‚è€ƒå†…æ ¸ä¸­<a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/if_ether.h#L165\">ä»¥å¤ªç½‘å¤´</a>å’Œ <a href=\"https://elixir.bootlin.com/linux/v5.13/source/include/uapi/linux/ip.h#L86\">IP å¤´</a>çš„å®šä¹‰æ ¼å¼ï¼Œ IP åœ°å€éƒ½æ˜¯ä»¥ <code>__be16</code> ç±»å‹çš„å¤§ç«¯æ ¼å¼å­˜å‚¨ï¼Œè€Œ MAC åœ°å€åˆ™æ˜¯ä»¥å­—ç¬¦æ•°ç»„ <code>unsigned char h_dest[6]</code> çš„å½¢å¼å­˜å‚¨ã€‚å› è€Œï¼ŒMAC åœ°å€å¯ä»¥ç›´æ¥é€šè¿‡æ•°æ®ä¸‹æ ‡è¿›è¡Œè®¿é—®ï¼Œè€Œæˆ‘ä»¬æ¡ˆä¾‹å¼€å§‹æ—¶åˆ—å‡ºçš„ IP åœ°å€ï¼Œè¿˜éœ€è¦å…ˆè½¬æ¢ä¸º <code>__be16</code> æ ¼å¼çš„å¤§ç«¯å­˜å‚¨æ ¼å¼ã€‚</p><p>å¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰ IP åœ°å€çš„è½¬æ¢æ–¹æ³•ï¼Œé‚£å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¨‹åºï¼Œè°ƒç”¨ <code>inet_addr()</code> åº“å‡½æ•°å¸®ä½ å®Œæˆè½¬æ¢ï¼š</p><pre><code class=\"language-c++\">#include &lt;stdio.h&gt;\n#include &lt;arpa/inet.h&gt;\n\nint main() {\n  unsigned int a1 = inet_addr(\"172.17.0.2\");\n  unsigned int a2 = inet_addr(\"172.17.0.3\");\n  unsigned int a3 = inet_addr(\"172.17.0.4\");\n  unsigned int a4 = inet_addr(\"172.17.0.5\");\n  printf(\"0x%x 0x%x 0x%x 0x%x\\n\", a1, a2, a3, a4);\n}\n</code></pre><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£æ¥ä¸‹æ¥çš„ç¨‹åºï¼Œæˆ‘æŠŠè½¬æ¢åçš„å®¹å™¨åœ°å€ä¿¡æ¯æ•´ç†æˆäº†ä¸€ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥åœ¨åç»­çš„å¼€å‘å’Œé—®é¢˜æ’æŸ¥è¿‡ç¨‹ä¸­å‚è€ƒï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d3/bb/d31389c380dc3dddf2128495d35b6ebb.jpg?wh=2284x1510\" alt=\"\"></p><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯è´Ÿè½½å‡è¡¡çš„å®ç°è¿‡ç¨‹äº†ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®è¯·æ±‚çš„æ¥æºï¼ŒæŠŠç›®çš„åœ°å€ä¿®æ”¹ä¸º Webserver çš„åœ°å€ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºçš„å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„è´Ÿè½½å‡è¡¡å®ç°é€»è¾‘ï¼š</p><pre><code class=\"language-c++\">/* 1. å¸¸é‡å®šä¹‰ */\n#define CLIENT_IP 0x40011ac\n#define LOADBALANCER_IP 0x50011ac\n#define ENDPOINT1_IP 0x20011ac\n#define ENDPOINT2_IP 0x30011ac\n#define CLIENT_MAC_SUFFIX 0x04\n#define LOADBALANCER_MAC_SUFFIX 0x05\n#define ENDPOINT1_MAC_SUFFIX 0x02\n#define ENDPOINT2_MAC_SUFFIX 0x03\n\n/* 2. ä»å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚ï¼Œç›®çš„åœ°å€æ”¹ä¸ºåç«¯ Webserver çš„åœ°å€ */\nif (iph-&gt;saddr == CLIENT_IP)\n{\n  iph-&gt;daddr = ENDPOINT1_IP;\n  eth-&gt;h_dest[5] = ENDPOINT1_MAC_SUFFIX; /* Only need to update the last byte */\n\n  /* æ¨¡æ‹Ÿä»ä¸¤ä¸ªWebserveréšæœºé€‰æ‹© */\n  if ((bpf_ktime_get_ns() &amp; 0x1) == 0x1)\n  {\n    iph-&gt;daddr = ENDPOINT2_IP;\n    eth-&gt;h_dest[5] = ENDPOINT2_MAC_SUFFIX;\n  }\n}\nelse /* 3. åä¹‹ï¼Œç›®çš„åœ°å€æ”¹ä¸ºå®¢æˆ·ç«¯ */\n{\n  iph-&gt;daddr = CLIENT_IP;\n  eth-&gt;h_dest[5] = CLIENT_MAC_SUFFIX;\n}\n\n/* 4. ä¿®æ”¹åŸåœ°å€ä¸ºLBåœ°å€ */\niph-&gt;saddr = LOADBALANCER_IP;\neth-&gt;h_source[5] = LOADBALANCER_MAC_SUFFIX;\n</code></pre><p>è¿™æ®µä»£ç ä¸­å„éƒ¨åˆ†çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul>\n<li>ç¬¬ 1 éƒ¨åˆ†ï¼Œå°†å®¹å™¨åœ°å€ä¿¡æ¯å®šä¹‰ä¸ºå¸¸é‡ï¼Œæ–¹ä¾¿åç»­å¼•ç”¨å’Œç†è§£ã€‚æ³¨æ„ï¼ŒMAC åœ°å€æ˜¯ä¸€ä¸ªåŒ…å«6 ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œè€Œå‰ 5 ä¸ªå…ƒç´ çš„å€¼éƒ½æ˜¯ç›¸åŒçš„ã€‚å› è€Œï¼Œåœ¨æ›´æ–°ç›®çš„ MAC åœ°å€æ—¶ï¼Œåªéœ€è¦æ›´æ–°æœ€åä¸€ä¸ªå…ƒç´ å³å¯ã€‚æ‰€ä»¥ï¼Œå¸¸é‡å®šä¹‰é‡Œé¢ä¹ŸåªåŒ…å«äº†æœ€åä¸€ä¸ªå­—èŠ‚çš„å€¼ã€‚</li>\n<li>ç¬¬ 2 éƒ¨åˆ†ï¼Œå¯¹äºä»å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚ï¼Œå°†ç›®çš„åœ°å€æ”¹ä¸ºåç«¯ Webserver çš„åœ°å€ã€‚ç”±äºåªæœ‰ä¸¤ä¸ªåç«¯ Webserverï¼Œè¿™å„¿ä½¿ç”¨æ—¶é—´æˆ³æœ€åä¸€ä½çš„å€¼æ¨¡æ‹Ÿå®ƒä»¬çš„éšæœºé€‰æ‹©è¿‡ç¨‹ã€‚</li>\n<li>ç¬¬ 3 éƒ¨åˆ†ï¼Œå¯¹äºä» Webserver å‘é€è¿‡æ¥çš„å“åº”ï¼Œç›®çš„åœ°å€æ”¹ä¸ºå®¢æˆ·ç«¯åœ°å€ã€‚</li>\n<li>ç¬¬ 4 éƒ¨åˆ†ï¼Œå°†åŸåœ°å€éƒ½æ”¹ä¸ºè´Ÿè½½å‡è¡¡å™¨çš„åœ°å€ã€‚</li>\n</ul><p>åˆ°è¿™é‡Œï¼Œ eBPF ç¨‹åºæ˜¯ä¸æ˜¯å·²ç»å¼€å‘å¥½äº†å‘¢ï¼Ÿå…¶å®ï¼Œå¦‚æœä½ äº†è§£è¿‡ IP åè®®çš„åŸºæœ¬åŸç†ï¼Œä½ å°±çŸ¥é“è¿˜æœ‰ä¸€ä¸ªæ­¥éª¤ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼šç”±äºä¿®æ”¹äº† IP å¤´çš„æ•°æ®ï¼ŒIP å¤´çš„æ ¡éªŒå’Œï¼ˆchecksumï¼‰å°±éœ€è¦é‡æ–°è®¡ç®—ï¼Œå¦åˆ™ç½‘ç»œåŒ…ä¼šè¢«å†…æ ¸ç›´æ¥ä¸¢å¼ƒã€‚</p><p>å¦‚æœä½ ä¸ç†Ÿæ‚‰ IP å¤´æ ¡éªŒå’Œçš„è®¡ç®—æ–¹æ³•ä¹Ÿæ²¡å…³ç³»ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“ä»æˆç†Ÿçš„å¼€æºé¡¹ç›®ä¸­æŸ¥æ‰¾åˆ°ç›¸å…³çš„è®¡ç®—æ–¹æ³•ã€‚æ¯”å¦‚ï¼Œå‚è€ƒ Facebook å¼€æºçš„ <a href=\"https://github.com/facebookincubator/katran/blob/main/katran/lib/bpf/csum_helpers.h#L30\">Katran</a>ï¼Œä½ å¯ä»¥å®šä¹‰å¦‚ä¸‹çš„ <code>ipv4_csum()</code> å‡½æ•°æ¥è®¡ç®—æ ¡éªŒå’Œï¼š</p><pre><code class=\"language-c++\">static __always_inline __u16 csum_fold_helper(__u64 csum)\n{\n  int i;\n#pragma unroll\n  for (i = 0; i &lt; 4; i++)\n  {\n  if (csum &gt;&gt; 16)\n    csum = (csum &amp; 0xffff) + (csum &gt;&gt; 16);\n  }\n  return ~csum;\n}\n\nstatic __always_inline __u16 ipv4_csum(struct iphdr *iph)\n{\n  iph-&gt;check = 0;\n  unsigned long long csum = bpf_csum_diff(0, 0, (unsigned int *)iph, sizeof(struct iphdr), 0);\n  return csum_fold_helper(csum);\n}\n</code></pre><p>å…³äºæ ¡éªŒå’Œçš„å…·ä½“ç®—æ³•ï¼Œä½ å¯ä»¥å‚è€ƒ TCP/IP åè®®ç›¸å…³çš„åŸç†ä¹¦ç±ï¼ˆå¦‚ã€ŠTCP/IPè¯¦è§£ã€‹ï¼‰æ¥ç†è§£ï¼Œè¿™é‡Œæˆ‘å°±ä¸è¯¦ç»†å±•å¼€äº†ã€‚</p><p>æœ‰äº†æ ¡éªŒå’Œçš„è®¡ç®—æ–¹æ³•ä¹‹åï¼Œæœ€åæ›´æ–° IP å¤´çš„ checksumï¼Œå†è¿”å› <code>XDP_TX</code> æŠŠæ•°æ®åŒ…ä»åŸç½‘å¡å‘é€å‡ºå»ï¼Œäº¤ç»™å†…æ ¸å»è½¬å‘å°±å¯ä»¥äº†ã€‚ä¸‹é¢å±•ç¤ºçš„å°±æ˜¯æ›´æ–°æ ¡éªŒå’Œçš„å®ç°æ–¹æ³•ï¼š</p><pre><code class=\"language-c++\">SEC(\"xdp\")\nint xdp_proxy(struct xdp_md *ctx)\n{\n  ...\n  /* é‡æ–°è®¡ç®—æ ¡éªŒå’Œ */\n  iph-&gt;check = ipv4_csum(iph);\n\n  /* æŠŠæ•°æ®åŒ…ä»åŸç½‘å¡å‘é€å‡ºå» */\n  return XDP_TX;\n}\n</code></pre><p>æŠŠä¸Šè¿°ä»£ç ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ <code>xdp-proxy.bpf.c</code> ä¸­ï¼Œå°±å®Œæˆäº† XDP eBPF ç¨‹åºçš„å¼€å‘ï¼ˆä½ è¿˜å¯ä»¥åœ¨ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/loadbalancer/xdp/xdp-proxy.bpf.c\">GitHub</a> ä¸­æ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼‰ã€‚</p><h3>ç¼–è¯‘å¹¶ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶</h3><p>æœ‰äº† XDP ç¨‹åºä¹‹åï¼Œæ¥ä¸‹æ¥çš„ç¬¬äºŒæ­¥å°±æ¯”è¾ƒç®€å•äº†ã€‚æˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä¸‹é¢çš„ <code>clang</code> å‘½ä»¤ï¼ŒæŠŠ XDP ç¨‹åºç¼–è¯‘æˆå­—èŠ‚ç ï¼Œå†æ‰§è¡Œ <code>bpftool gen skeleton</code> å‘½ä»¤ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶å³å¯ï¼š</p><pre><code class=\"language-bash\">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I/usr/include/x86_64-linux-gnu -I. -c xdp-proxy.bpf.c -o xdp-proxy.bpf.o\nbpftool gen skeleton xdp-proxy.bpf.o &gt; xdp-proxy.skel.h\n</code></pre><h3>å¼€å‘ç”¨æˆ·æ€ç¨‹åº</h3><p>å¯¹äºç¬¬ä¸‰æ­¥ç”¨æˆ·æ€ç¨‹åºçš„å¼€å‘ï¼Œå®ƒçš„åŸºæœ¬æµç¨‹è·Ÿ <a href=\"https://time.geekbang.org/column/article/484372\">08 è®²</a> ä¸­çš„å†…æ ¸è·Ÿè¸ªæ¡ˆä¾‹æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯éœ€è¦å¼•å…¥è„šæ‰‹æ¶å¤´æ–‡ä»¶ã€å¢å¤§ RLIMIT_MEMLOCKã€åˆå§‹åŒ–å¹¶åŠ è½½ BPF å­—èŠ‚ç ï¼Œæœ€åå†æŒ‚è½½ XDP ç¨‹åºè¿™å‡ ä¸ªæ­¥éª¤ã€‚å¿½ç•¥é”™è¯¯å¤„ç†æ­¥éª¤ï¼Œæœ€æ ¸å¿ƒçš„å®ç°æ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">// 1. å¼•å…¥è„šæ‰‹æ¶å¤´æ–‡ä»¶\n#include \"xdp-proxy.skel.h\"\n\n// Cè¯­è¨€ä¸»å‡½æ•°\nint main(int argc, char **argv)\n{\n    // 2. å¢å¤§ RLIMIT_MEMLOCKï¼ˆé»˜è®¤å€¼é€šå¸¸å¤ªå°ï¼Œä¸è¶³ä»¥å­˜å…¥BPFæ˜ å°„çš„å†…å®¹ï¼‰\n    struct rlimit rlim_new = {\n      .rlim_cur = RLIM_INFINITY,\n      .rlim_max = RLIM_INFINITY,\n    };\n    err = setrlimit(RLIMIT_MEMLOCK, &amp;rlim_new);\n\n    // 3. åˆå§‹åŒ–BPFç¨‹åº\n    struct xdp_proxy_bpf *obj = xdp_proxy_bpf__open();\n\n    // 4. åŠ è½½BPFå­—èŠ‚ç \n    err = xdp_proxy_bpf__load(obj);\n\n    // 5. TODO: æŒ‚è½½XDPç¨‹åºåˆ°eth0ç½‘å¡\n}\n</code></pre><p>è¿™æ®µä»£ç ä¸­ï¼Œå‰é¢ 4 ä¸ªæ­¥éª¤è·Ÿ<a href=\"https://time.geekbang.org/column/article/484372\"> 08 è®²</a> ä¸­çš„<a href=\"https://time.geekbang.org/column/article/484372\">å†…æ ¸è·Ÿè¸ªæ¡ˆä¾‹</a>æ˜¯ä¸€æ ·çš„ï¼Œè¿™å„¿ä¸å†è¯¦ç»†å±•å¼€ã€‚</p><p>è€Œå¯¹äºç¬¬ 5 æ­¥çš„æŒ‚è½½è¿‡ç¨‹ï¼Œæˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/483364\"> 06 è®²</a> ä¸­æ›¾ç»æåˆ°ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>ip link</code> å‘½ä»¤æ¥æŒ‚è½½ XDP ç¨‹åºã€‚å½“æ—¶è®²åˆ°çš„æ˜¯åœ¨ä¸»æœºä¸­æŒ‚è½½ XDP çš„æ­¥éª¤ï¼Œè€Œåœ¨å®¹å™¨ä¸­çš„æ­¥éª¤å…¶å®ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ˆæ³¨æ„ï¼Œåœ¨å®¹å™¨ä¸­çš„è™šæ‹Ÿç½‘å¡ä¸Šï¼Œåªæ”¯æŒä»¥é€šç”¨æ¨¡å¼æŒ‚è½½ï¼‰ã€‚</p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºçš„å°±æ˜¯æŠŠ XDP å­—èŠ‚ç å¤åˆ¶åˆ°è´Ÿè½½å‡è¡¡å®¹å™¨å¹¶æŒ‚è½½åˆ° eth0 ç½‘å¡çš„è¿‡ç¨‹ï¼š</p><pre><code class=\"language-bash\"># å¤åˆ¶å­—èŠ‚ç åˆ°å®¹å™¨ä¸­\ndocker cp xdp-proxy.bpf.o lb:/\n\n# åœ¨å®¹å™¨ä¸­å®‰è£…iproute2å‘½ä»¤è¡Œå·¥å…·\ndocker exec -it lb apk add iproute2 --update\n\n# åœ¨å®¹å™¨ä¸­æŒ‚è½½XDPç¨‹åºåˆ°eth0ç½‘å¡\ndocker exec -it lb ip link set dev eth0 xdpgeneric object xdp-proxy.bpf.o sec xdp\n</code></pre><p>é™¤äº†ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­è°ƒç”¨åº“å‡½æ•°æ¥æŒ‚è½½ XDP ç¨‹åºï¼Œä»è€Œé¿å…å¼•å…¥é¢å¤–çš„å‘½ä»¤è¡Œå·¥å…·ä¾èµ–ï¼ˆæ¯”å¦‚ï¼Œä¸å†éœ€è¦å®‰è£… iproute2 ç³»ç»Ÿå·¥å…·ï¼‰ã€‚</p><p>libbpf æä¾›äº†ä¸€ä¸ª <code>bpf_set_link_xdp_fd(int ifindex, int fd, __u32 flags)</code> å‡½æ•°ï¼Œå¯ç”¨äºæŠŠ XDP ç¨‹åºæŒ‚è½½åˆ°ç½‘å¡ã€‚è¿™ä¸ªå‡½æ•°éœ€è¦ç½‘å¡åºå·å’Œ XDP ç¨‹åºæ–‡ä»¶æè¿°ç¬¦ä½œä¸ºå‚æ•°ï¼ŒæŸ¥è¯¢è¿™äº›å‚æ•°å¹¶æŒ‚è½½ XDP çš„è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">    unsigned int ifindex = if_nametoindex(\"eth0\");\n    int prog_id = bpf_program__fd(obj-&gt;progs.xdp_proxy);\n    err = bpf_set_link_xdp_fd(ifindex, prog_id, XDP_FLAGS_UPDATE_IF_NOEXIST|XDP_FLAGS_SKB_MODE);\n</code></pre><p>è¿™æ®µä»£ç ä¸­ï¼ŒæŒ‚è½½å‚æ•°æ ‡å¿— <code>XDP_FLAGS_SKB_MODE</code> ç­‰åŒäº <code>ip link</code> å‘½ä»¤ä¸­çš„ <code>xdpgeneric</code>ï¼Œè¡¨ç¤ºä»¥é€šç”¨æ¨¡å¼æŒ‚è½½ã€‚</p><p>æŠŠä¸Šè¿°ä»£ç ä¿å­˜åˆ° <code>xdp-proxy.c</code> æ–‡ä»¶ä¸­ï¼ˆä½ è¿˜å¯ä»¥åœ¨ <a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/loadbalancer/xdp/xdp-proxy.c\">GitHub</a> ä¸­æ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼‰ï¼Œå†æ‰§è¡Œä¸‹é¢çš„ç¼–è¯‘å‘½ä»¤ï¼Œå°±å¯ä»¥å°†å…¶ç¼–è¯‘ä¸ºé™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚é‡‡ç”¨é™æ€é“¾æ¥çš„ä¸€ä¸ªå¥½å¤„æ˜¯å®¹æ˜“åœ¨å®¹å™¨ä¸­åˆ†å‘ï¼Œåªéœ€è¦æŠŠæœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾å…¥å®¹å™¨ä¸­å³å¯è¿è¡Œï¼Œä¸å†éœ€è¦å®‰è£…é¢å¤–çš„ä¾èµ–ç¯å¢ƒã€‚</p><pre><code class=\"language-bash\">clang -g -O2 -Wall -I. -c xdp-proxy.c -o xdp-proxy.o\nclang -Wall -O2 -g xdp-proxy.o -static -lbpf -lelf -lz -o xdp-proxy\n</code></pre><p>åˆ°è¿™é‡Œï¼Œå®Œæ•´çš„ eBPF ç¨‹åºå°±å¼€å‘å¥½äº†ã€‚å®ƒæ˜¯ä¸æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œå‘¢ï¼Ÿå¦‚æœå¯ä»¥æ­£å¸¸å·¥ä½œï¼Œæ€§èƒ½åˆä¼šæ€ä¹ˆæ ·ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¾åˆ°å®¹å™¨ä¸­æµ‹è¯•ä¸€ä¸‹çœ‹çœ‹ã€‚</p><h3>æ€§èƒ½æµ‹è¯•</h3><p>åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä¸‹é¢çš„ docker å‘½ä»¤ï¼ŒæŠŠ XDP ç¨‹åºå¤åˆ¶åˆ°è´Ÿè½½å‡è¡¡å®¹å™¨ä¸­ï¼Œå¹¶æ‰§è¡Œ XDP ç¨‹åºï¼š</p><pre><code class=\"language-bash\"># å¤åˆ¶XDPç¨‹åºåˆ°å®¹å™¨\ndocker cp xdp-proxy lb:/\n\n# åœ¨å®¹å™¨ä¸­åŠ è½½XDPç¨‹åº\ndocker exec -it lb /xdp-proxy\n</code></pre><p>ç„¶åï¼Œè¿›å…¥å®¢æˆ·ç«¯å®¹å™¨ç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œ <code>apk</code> å‘½ä»¤å®‰è£… <code>curl</code> å’Œ <code>wrk</code> å·¥å…·ï¼Œæ¥ç€å†ä½¿ç”¨ <code>curl</code> è®¿é—®è´Ÿè½½å‡è¡¡å™¨ï¼š</p><pre><code class=\"language-bash\">docker exec -it client sh\n\n# (ä»¥ä¸‹å‘½ä»¤è¿è¡Œåœ¨clientå®¹å™¨ä¸­)\n/ # curl \"http://172.17.0.5\"\n</code></pre><p>å¦‚æœä½ çœ‹åˆ° <code>Hostname: http1</code> æˆ–è€… <code>Hostname: http12</code> çš„è¾“å‡ºï¼Œè¯´æ˜ XDP å·²ç»æˆåŠŸè¿è¡Œï¼Œå¹¶ä¸”å®ƒçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œç»§ç»­åœ¨å®¢æˆ·ç«¯å®¹å™¨ç»ˆç«¯ä¸­æ‰§è¡Œ <code>wrk</code> å‘½ä»¤ï¼Œç»™è´Ÿè½½å‡è¡¡å™¨åšä¸ªæ€§èƒ½æµ‹è¯•ï¼š</p><pre><code class=\"language-bash\"># (ä»¥ä¸‹å‘½ä»¤è¿è¡Œåœ¨clientå®¹å™¨ä¸­)\n\n# å®‰è£…wrkå·¥å…·\n/ # apk add curl wrk --update\n\n# æ‰§è¡Œæ€§èƒ½æµ‹è¯•\n/ # wrk -c100 \"http://172.17.0.5\"\n</code></pre><p>ç¨ç­‰ä¸€ä¼šï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼ˆåœ¨ä½ çš„ç¯å¢ƒä¸‹å¯èƒ½çœ‹åˆ°ä¸åŒæ•°å€¼ï¼Œå…·ä½“çš„æ€§èƒ½æŒ‡æ ‡å–å†³äºè¿è¡Œç¯å¢ƒå’Œé…ç½®ï¼‰ï¼š</p><pre><code class=\"language-bash\">Running 10s test @ http://172.17.0.5\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency     6.37ms   11.17ms 295.43ms   98.97%\n    Req/Sec     9.09k   422.06    10.09k    75.00%\n  180889 requests in 10.02s, 31.39MB read\nRequests/sec:  18048.65\nTransfer/sec:      3.13MB\n</code></pre><p>ä»è¾“å‡ºä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œå¹³å‡æ¯ç§’è¯·æ±‚æ•°æ˜¯ 18048ï¼Œæ¯ä¸ªçº¿ç¨‹çš„å¹³å‡å»¶è¿Ÿæ˜¯ 6.37msã€‚å›é¡¾ä¸€ä¸‹ <a href=\"https://time.geekbang.org/column/article/485702?cid=100104501\">12 è®²</a> ä¸­çš„å¥—æ¥å­— eBPF ç¨‹åºçš„æ€§èƒ½æµ‹è¯•ç»“æœï¼Œå®ƒçš„å¹³å‡æ¯ç§’è¯·æ±‚æ•°æ˜¯ 15300ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„å¹³å‡å»¶è¿Ÿæ˜¯ 6.88msã€‚è¿™è¯´æ˜ï¼Œç›¸æ¯”å¥—æ¥å­—ç¨‹åºï¼ŒXDP ç¨‹åºåœ¨å¹³å‡æ¯ç§’è¯·æ±‚æ•°ä¸Šæå‡äº† 18%ã€‚</p><p>æœ€åï¼Œä¸è¦å¿˜è®°æ¸…ç†ä»Šå¤©çš„æ¡ˆä¾‹ç¯å¢ƒã€‚ç”±äºæ‰€æœ‰æœåŠ¡éƒ½è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œåˆ é™¤ä»Šå¤©åˆ›å»ºçš„æ‰€æœ‰å®¹å™¨ï¼Œå³å¯å®Œæˆæ¸…ç†å·¥ä½œï¼š</p><pre><code class=\"language-bash\">docker rm -f lb client http1 http2\n</code></pre><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘å¸¦ä½ ä½¿ç”¨ libbpf å¼€å‘äº†ä¸€ä¸ªåŸºäº XDP çš„è´Ÿè½½å‡è¡¡æœåŠ¡ã€‚</p><p>XDP ç¨‹åºåœ¨ç½‘ç»œé©±åŠ¨ç¨‹åºåˆšåˆšæ”¶åˆ°æ•°æ®åŒ…çš„æ—¶å€™è§¦å‘æ‰§è¡Œã€‚ç”±äºè¿˜æœªåˆ†é…å†…æ ¸ SKB æ•°æ®ç»“æ„ï¼ŒXDP ç¨‹åºåªèƒ½æ ¹æ® TCP/IP åè®®çš„å°åŒ…æ ¼å¼ï¼Œä»åŸå§‹ç½‘ç»œåŒ…ä¸­æå–æ‰€éœ€åè®®å±‚çš„æ•°æ®ï¼Œè¿›è€Œå†æŒ‰ç…§éœ€è¦è¿›è¡Œæ”¹å†™æˆ–è½¬å‘ã€‚XDP ç¨‹åºä¿®æ”¹è¿‡çš„æ•°æ®åŒ…å¯ä»¥è½¬å‘ç»™ç›¸åŒæˆ–ä¸åŒçš„ç½‘å¡ï¼Œå†äº¤ç»™å†…æ ¸åè®®æ ˆç»§ç»­å¤„ç†ï¼›æˆ–è€…ï¼Œè·Ÿå¤„ç†é€»è¾‘æ— å…³çš„åŒ…ä¸åšä»»ä½•å¤„ç†ï¼Œç›´æ¥äº¤ç»™å†…æ ¸åè®®æ ˆè¿›è¡Œå¤„ç†ã€‚</p><p>ä»Šå¤©çš„æ¡ˆä¾‹æŠŠ XDP ç¨‹åºæŒ‚è½½åˆ°äº†å®¹å™¨çš„è™šæ‹Ÿç½‘å¡ä¸Šï¼Œç”±äºé‡‡ç”¨äº†é€šç”¨æ¨¡å¼æŒ‚è½½ï¼Œå®ƒçš„æ‰§è¡Œè¿‡ç¨‹å…¶å®è¿˜æ˜¯åœ¨å†…æ ¸ä¸­è¿è¡Œçš„ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ å¯ä»¥ä»¥åŸç”Ÿæ¨¡å¼æˆ–å¸è½½æ¨¡å¼æŠŠ XDP ç¨‹åºæŒ‚è½½åˆ°æ”¯æŒ XDP çš„ç½‘å¡ä¸Šï¼Œä»è€Œè·å¾—æœ€ä¼˜çš„ç½‘ç»œæ€§èƒ½ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ æ¥èŠä¸€èŠï¼š</p><ol>\n<li>åœ¨ä»Šå¤©çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æŠŠ XDP ç¨‹åºæŒ‚è½½åˆ°äº†è´Ÿè½½å‡è¡¡å®¹å™¨ä¸­çš„ç½‘å¡ä¸Šã€‚å¦‚æœæŠŠå®ƒç›´æ¥æŒ‚è½½åˆ°ä¸»æœºçš„ eth0 ç½‘å¡ï¼Œä¼šæœ‰ä»€ä¹ˆæ ·çš„ç°è±¡ï¼Ÿ</li>\n<li>é’ˆå¯¹ä»Šå¤©çš„è´Ÿè½½å‡è¡¡åœºæ™¯ï¼Œè¿˜æœ‰å“ªäº›æ–¹æ³•å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ– XDP ç¨‹åºçš„æ€§èƒ½ï¼Ÿ</li>\n</ol><p>æœŸå¾…ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p>","neighbors":{"left":{"article_title":"12ï½œé«˜æ€§èƒ½ç½‘ç»œå®æˆ˜ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å¼€å‘ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Ÿ","id":485702},"right":{"article_title":"å¤§å’–åŠ©åœºï½œæç¨‹è¿œï¼šè°ˆè°ˆeBPFåœ¨äº‘åŸç”Ÿä¸­çš„çºµä¸æ¨ª","id":492456}},"comments":[{"had_liked":false,"id":334324,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1644888935,"is_pvip":false,"replies":[{"id":122219,"content":"éå¸¸èµçš„ç­”æ¡ˆğŸ‘ å¦‚æœèƒ½æŠŠè¿™äº›æ€è·¯å†éƒ½å®ç°äº†å°±æ›´å¥½äº†ğŸ˜Š","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1645019082,"ip_address":"","comment_id":334324,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"1. æŒ‚åœ¨å®¿ä¸»æœºçš„ eth0 ç½‘å¡ï¼Œä¼šå¯¼è‡´å®¿ä¸»æœºç½‘ç»œå—å½±å“ï¼Œæœ€ç›´æ¥çš„å½±å“æ˜¯æ¥è‡ªå¤–éƒ¨çš„ ssh è¿æ¥å¼‚å¸¸ï¼Œä¹‹åå†æ‰§è¡Œ ssh ä¹Ÿç™»ä¸è¿›å®¿ä¸»æœºã€‚ï¼ˆåŸå› æ˜¯æº IP ä¸æ˜¯ CLIENT_IP æ—¶å°†ç›®çš„ IP ç›´æ¥ä¿®æ”¹ä¸º CLIENT_IPï¼Œæº IP æ— è®ºå¦‚ä½•å‡ä¿®æ”¹ä¸º LOADBALANCER_IPï¼Œè¿›æ¥çš„æ•°æ®åŒ…æ— æ³•æ­£å¸¸è¢«æ¥æ”¶ä¸å“åº”ï¼‰\n\n2. ç›®å‰çš„å®ç°æœ‰äº› hardcodeï¼Œä¸åˆ©äºæ‰©å±•ï¼Œè´Ÿè½½å‡è¡¡å™¨é€šå¸¸è¿è¡Œé…ç½®å¤šä¸ª vipï¼Œæ¯ä¸ª vip å¯¹åº”è‹¥å¹²çœŸæ­£çš„åç«¯æœåŠ¡ã€‚è§‰å¾—æ”¹è¿›æªæ–½å¯ä»¥ç”¨ BPF map ç±»å‹å­˜å‚¨ï¼Œæœ€å¥½æœ‰ä¸ªæ–‡æœ¬æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç¨‹åºåŠ è½½å‰è§£æè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¡«å…… BPF mapã€‚xdp ç¨‹åºä¸­æ ¹æ® keyï¼ˆæ¯”å¦‚ vip æˆ–è€… UUIDï¼‰æŸ¥æ‰¾çœŸæ­£çš„åç«¯æœåŠ¡ï¼Œå¦‚æœèƒ½å¤Ÿæ‰¾åˆ°åˆ™ä»ä¸­è¯»å– IPã€Mac ç­‰ä¿¡æ¯ã€‚","like_count":15,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551460,"discussion_content":"éå¸¸èµçš„ç­”æ¡ˆğŸ‘ å¦‚æœèƒ½æŠŠè¿™äº›æ€è·¯å†éƒ½å®ç°äº†å°±æ›´å¥½äº†ğŸ˜Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645019083,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336182,"user_name":"L33K","can_delete":false,"product_type":"c1","uid":1046063,"ip_address":"","ucode":"2F8E105F44E347","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/2f/d3f1dae6.jpg","comment_is_top":false,"comment_ctime":1645975935,"is_pvip":false,"replies":[{"id":122899,"content":"å—¯ XDPæ˜¯æœ‰ä¸€äº›é™åˆ¶çš„ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ªPPTï¼š https:&#47;&#47;lpc.events&#47;event&#47;11&#47;contributions&#47;939&#47;attachments&#47;771&#47;1551&#47;xdp-multi-buff.pdf","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1646047472,"ip_address":"","comment_id":336182,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å¦‚æœä¸€ä¸ªä¸Šå±‚çš„å¤§åŒ…è¢«æ‹†æˆä¸€ä¸ªå¤šä¸ªåŒ…å‘è¿‡æ¥ï¼Œç›®å‰è¿™ç§è´Ÿè½½å‡è¡¡æ–¹å¼æ˜¯ä¸æ˜¯å¯èƒ½å°±æœ‰é—®é¢˜äº†ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553742,"discussion_content":"å—¯ XDPæ˜¯æœ‰ä¸€äº›é™åˆ¶çš„ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ªPPTï¼š https://lpc.events/event/11/contributions/939/attachments/771/1551/xdp-multi-buff.pdf","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1646047472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367533,"user_name":"Aiolos","can_delete":false,"product_type":"c1","uid":3173598,"ip_address":"è‹±å›½","ucode":"D00DE9E6A0F2F4","user_header":"https://static001.geekbang.org/account/avatar/00/30/6c/de/693fce23.jpg","comment_is_top":false,"comment_ctime":1675307940,"is_pvip":false,"replies":[{"id":134630,"content":"å¾ˆæœ‰å¯èƒ½æ˜¯ç”¨äº†è™šæ‹Ÿæœºå¯¼è‡´çš„ã€‚æ¡ˆä¾‹ä¸­ä½¿ç”¨çš„æ˜¯é€šç”¨æŒ‚è½½æ¨¡å¼ï¼Œå®é™…ç”Ÿäº§ä¸­ä½¿ç”¨åŸç”Ÿæ¨¡å¼æˆ–å¸è½½æ¨¡å¼æ‰èƒ½è·å¾—æ¯”è¾ƒå¥½çš„åŠ é€Ÿæ•ˆæœã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1677499927,"ip_address":"ä¸Šæµ·","comment_id":367533,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"åŸç”Ÿnginxå’Œsock_ops+sk_msgä¼˜åŒ–å‡æ˜¯2000QPSï¼Œä½†æ˜¯ä½¿ç”¨XDPä¼˜åŒ–åé™åˆ°äº†400QPSï¼Œè¯·é—®è¿™æ˜¯ä»€ä¹ˆåŸå› ï¼Œå¦‚ä½•ä¿®æ­£","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606941,"discussion_content":"å¾ˆæœ‰å¯èƒ½æ˜¯ç”¨äº†è™šæ‹Ÿæœºå¯¼è‡´çš„ã€‚æ¡ˆä¾‹ä¸­ä½¿ç”¨çš„æ˜¯é€šç”¨æŒ‚è½½æ¨¡å¼ï¼Œå®é™…ç”Ÿäº§ä¸­ä½¿ç”¨åŸç”Ÿæ¨¡å¼æˆ–å¸è½½æ¨¡å¼æ‰èƒ½è·å¾—æ¯”è¾ƒå¥½çš„åŠ é€Ÿæ•ˆæœã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677499928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334634,"user_name":"codejw","can_delete":false,"product_type":"c1","uid":1201492,"ip_address":"","ucode":"8D12EE69A4DA4C","user_header":"https://static001.geekbang.org/account/avatar/00/12/55/54/97419b60.jpg","comment_is_top":false,"comment_ctime":1645025167,"is_pvip":false,"replies":[{"id":122633,"content":"å¦‚æœæ˜¯ä¸åŒçš„ç½‘å¡ï¼Œå¤šæ¬¡è°ƒç”¨æŒ‚è½½å’ŒåŠ è½½çš„å‡½æ•°æˆ–è€…ç”¨ ip link set å‘½ä»¤éƒ½å¯ä»¥ã€‚ä½†å¦‚æœæƒ³æŒ‚è½½å¤šä¸ªXDPç¨‹åºåˆ°ç›¸åŒçš„ç½‘å¡ï¼Œé‚£å°±éœ€è¦5.10æ–°å¢çš„freplaceç±»å‹ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒ https:&#47;&#47;lpc.events&#47;event&#47;7&#47;contributions&#47;671&#47;attachments&#47;561&#47;992&#47;xdp-multiprog.pdf","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1645618507,"ip_address":"","comment_id":334634,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œå¦‚æœæœ‰å¤šä¸ªxdpç¨‹åºå¦‚ä½•æŒ‚è½½å‘¢ï¼Œæˆ‘æœ‰å¤šä¸ª.oéƒ½æŒ‚è½½åˆ°xdp","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552869,"discussion_content":"å¦‚æœæ˜¯ä¸åŒçš„ç½‘å¡ï¼Œå¤šæ¬¡è°ƒç”¨æŒ‚è½½å’ŒåŠ è½½çš„å‡½æ•°æˆ–è€…ç”¨ ip link set å‘½ä»¤éƒ½å¯ä»¥ã€‚ä½†å¦‚æœæƒ³æŒ‚è½½å¤šä¸ªXDPç¨‹åºåˆ°ç›¸åŒçš„ç½‘å¡ï¼Œé‚£å°±éœ€è¦5.10æ–°å¢çš„freplaceç±»å‹ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒ https://lpc.events/event/7/contributions/671/attachments/561/992/xdp-multiprog.pdf","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645618507,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336394,"user_name":"yuan","can_delete":false,"product_type":"c1","uid":1173752,"ip_address":"","ucode":"C6995865D13E1B","user_header":"https://static001.geekbang.org/account/avatar/00/11/e8/f8/2c1958b6.jpg","comment_is_top":false,"comment_ctime":1646127116,"is_pvip":false,"replies":[{"id":122997,"content":"ç¼ºå°‘ä¾èµ–åº“ï¼Œå‚è€ƒæ ¹ç›®å½•çš„ReadmeæŠŠä¾èµ–åº“å®‰è£…ä¸€ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1646225338,"ip_address":"","comment_id":336394,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆå¥½ï¼Œæˆ‘ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘é™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶æŠ¥é”™äº†ï¼Œä»£ç ç”¨çš„æ˜¯githubä¸­çš„ä»£ç ï¼Œè¯·é—®æœ‰å•¥æ€è·¯å—ï¼Ÿ\nå‘½ä»¤ï¼šclang -Wall -O2 -g xdp-proxy-v2.o -static -lbpf -lelf -lz -o xdp-proxy-v2\nç»“æœï¼š&#47;usr&#47;bin&#47;ld: cannot find -lbpf\n&#47;usr&#47;bin&#47;ld: cannot find -lelf\n&#47;usr&#47;bin&#47;ld: cannot find -lz\n&#47;usr&#47;bin&#47;ld: cannot find -lc\nclang-13: error: linker command failed with exit code 1 (use -v to see invocation)\n\nå¦å¤–ç”¨ip linkæŒ‚è½½ä¹Ÿä¸è¡Œ\nå‘½ä»¤ï¼šsudo ip link set dev eth0 xdpgeneric object xdp-proxy-v2.bpf.o sec xdp\nç»“æœï¼š\nBTF debug data section &#39;.BTF&#39; rejected: Invalid argument (22)!\n - Length:       1817\nVerifier analysis:\n... ...\nProg section &#39;xdp&#39; rejected: Permission denied (13)!\n - Type:         6\n - Instructions: 151 (0 over limit)\n - License:      GPL\n\nVerifier analysis:\n... ...\nprocessed 25 insns (limit 1000000) max_states_per_insn 0 total_states 1 peak_states 1 mark_read 1\n\nError fetching program&#47;map!\n\nå†…æ ¸ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š\n5.14.10-300.fc35.x86_64\nFedora release 35 (Thirty Five)","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554132,"discussion_content":"ç¼ºå°‘ä¾èµ–åº“ï¼Œå‚è€ƒæ ¹ç›®å½•çš„ReadmeæŠŠä¾èµ–åº“å®‰è£…ä¸€ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646225338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2620407,"avatar":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","nickname":"è¿›å‡»çš„Lancelot","note":"","ucode":"3BCC355801DC61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589721,"discussion_content":"è¿™ä¸ªé—®é¢˜å‘ç”Ÿçš„åŸå› ä¸»è¦æ˜¯å› ä¸ºåˆ›å»ºå‡ºæ¥çš„ bpf map åœ¨å®¹å™¨ä¸­ä¸å¯è®¿é—®ï¼Œæœ‰ä¸¤ä¸ªè§£å†³æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä¸è¦ä½¿ç”¨ v2 çš„ç‰ˆæœ¬ï¼Œç”¨ v1 ä¸å¸¦ map çš„ç‰ˆæœ¬å°±å¯ä»¥åœ¨å®¹å™¨ä¸­æŒ‚è½½ xdpï¼Œç¬¬äºŒä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ç”¨ nsenter è¿›å…¥åˆ°å®¹å™¨çš„ network namespace å½“ä¸­ï¼Œç„¶åå†åŠ è½½ xdp ç¨‹åºï¼Œæ“ä½œè¿‡ç¨‹ï¼š\n```bash\n# æ‰¾åˆ° lb çš„ pid\n$ sudo docker inspect lb | grep -i pid\n$ sudo nsenter -t ${pid} -n\n$ ip link set dev eth0 xdpgeneric object xdp-proxy.bpf.o sec xdp\n```","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1665283738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344551,"user_name":"ä¹Œæ‹‰å‘†zyb","can_delete":false,"product_type":"c1","uid":2649439,"ip_address":"","ucode":"D324583C9CE2EF","user_header":"https://static001.geekbang.org/account/avatar/00/28/6d/5f/a937f7f1.jpg","comment_is_top":false,"comment_ctime":1651645705,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å€ªè€å¸ˆï¼Œè¯·é—®ä¸ºä»€ä¹ˆå°†XDP eBPFç¨‹åºæŒ‚è½½ä¸Šå»ä¹‹åï¼Œä¼˜åŒ–æ•ˆæœåè€Œå¤§å¤§åœ°ä¸‹é™äº†ï¼Ÿä¼˜åŒ–å‰ Requests&#47;sec æ˜¯7500å·¦å³ï¼›XDPä¼˜åŒ–å Requests&#47;sec æ˜¯250 å·¦å³ï¼›ä»£ç éƒ½æ˜¯githubä¸Šçš„ä»£ç ï¼›ä¸¤ä¸ªç‰ˆæœ¬çš„éƒ½è¯•è¿‡äº†ï¼Œéƒ½æ˜¯åå‘ä¼˜åŒ–ï¼Œä¸çŸ¥é“ä¸ºå•¥ ^~^","like_count":4,"discussions":[{"author":{"id":2959301,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/27/c5/d4d00da2.jpg","nickname":"ä¸ºäº†ç»´æŠ¤ä¸–ç•Œå’Œå¹³","note":"","ucode":"A7254895BA8B68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580585,"discussion_content":"æˆ‘ä¹Ÿæœ‰è¿™æ ·çš„ç–‘é—®ï¼Œé€Ÿåº¦åè€Œæ…¢äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658280184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351889,"user_name":"ä¸ºäº†ç»´æŠ¤ä¸–ç•Œå’Œå¹³","can_delete":false,"product_type":"c1","uid":2959301,"ip_address":"","ucode":"A7254895BA8B68","user_header":"https://static001.geekbang.org/account/avatar/00/2d/27/c5/d4d00da2.jpg","comment_is_top":false,"comment_ctime":1658280319,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å€ªè€å¸ˆä½ å¥½ï¼Œä½¿ç”¨XDP é€Ÿåº¦æ…¢äº†ï¼Œè¿™å¤§æ¦‚ä»€ä¹ˆåŸå› å‘¢\n&#47; # wrk -c100 &quot;http:&#47;&#47;172.17.0.5&quot;\nRunning 10s test @ http:&#47;&#47;172.17.0.5\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +&#47;- Stdev\n    Latency   272.26ms  386.46ms   1.70s    86.32%\n    Req&#47;Sec   122.51     90.04   580.00     73.65%\n  2483 requests in 10.06s, 441.31KB read\n  Socket errors: connect 0, read 0, write 0, timeout 53\nRequests&#47;sec:    246.73\nTransfer&#47;sec:     43.85KB\n","like_count":2},{"had_liked":false,"id":346719,"user_name":"aith","can_delete":false,"product_type":"c1","uid":2350328,"ip_address":"","ucode":"271057D21C2107","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erBT5LK5f0w6MHCyX7Tuc1aytDlSazDkFPibwZ113Luz8qLviccotz4k3oIePQzrZhHEBWSDKUIjw7A/132","comment_is_top":false,"comment_ctime":1653378554,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"XDPç¨‹åºæŠŠæ•°æ®åŒ…éšæœºè°ƒåº¦åˆ°æŸä¸ªWebserverï¼Œæ²¡æœ‰ä¼šè¯ä¿æŒï¼Œä¼šä¸ä¼šå¯¼è‡´åŒä¸€æ¬¡è¯·æ±‚çš„æ•°æ®åŒ…ï¼Œå‘é€åˆ°ä¸åŒçš„åç«¯Webserverä¸Šé¢,ä»è€Œä¸èƒ½æ­£å¸¸ç›¸åº”ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1665832,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/pJJpwhFRpXm1NFJ8HuiapckC8IibS0eHY99XqnAUtpicHXDdiajK3ObthbnenMTwRDGgvfv86LPEjKq06wzd9o8sHQ/132","nickname":"Geek_c0ea3b","note":"","ucode":"3F054407CDCF40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590169,"discussion_content":"è‚¯å®šä¼šçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665562893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344571,"user_name":"ä¹Œæ‹‰å‘†zyb","can_delete":false,"product_type":"c1","uid":2649439,"ip_address":"","ucode":"D324583C9CE2EF","user_header":"https://static001.geekbang.org/account/avatar/00/28/6d/5f/a937f7f1.jpg","comment_is_top":false,"comment_ctime":1651652530,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"å€ªè€å¸ˆï¼Œè¿˜æƒ³è¯·æ•™æ‚¨ä¸€ä¸ªé—®é¢˜ï¼š åŠ è½½XDP eBPFç¨‹åºåï¼Œcurl &quot;http:&#47;&#47;172.17.0.5&quot; æµ‹è¯•æ­£å¸¸ï¼Œæœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼›ä½† wrk -c 100 &quot;http:&#47;&#47;172.17.0.5&quot; çš„æµ‹è¯•ç»“æœä¸­æœ‰Socker errorsçš„è¿æ¥è¶…æ—¶çš„æŠ¥é”™å¦‚ä¸‹ï¼š\n&#47; # wrk -c 100 &quot;http:&#47;&#47;172.17.0.5&quot;\nRunning 10s test @ http:&#47;&#47;172.17.0.5\n  2 threads and 100 connections\n  Thread Stats   Avg      Stdev     Max   +&#47;- Stdev\n    Latency   274.75ms  384.76ms   1.70s    86.88%\n    Req&#47;Sec   127.44     86.42   530.00     69.19%\n  2640 requests in 10.09s, 469.22KB read\n  Socket errors: connect 0, read 0, write 0, timeout 56\nRequests&#47;sec:    261.64\nTransfer&#47;sec:     46.50KB\n&#47; # ","like_count":2,"discussions":[{"author":{"id":1342730,"avatar":"https://static001.geekbang.org/account/avatar/00/14/7d/0a/332fa5f7.jpg","nickname":"è®¸å¼ä½©","note":"","ucode":"A4391CA492B7F9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595491,"discussion_content":"è¶…æ—¶æ˜¯æ²¡æœ‰ä¼šè¯æœºåˆ¶å¯¼è‡´çš„å§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670147423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2959301,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/27/c5/d4d00da2.jpg","nickname":"ä¸ºäº†ç»´æŠ¤ä¸–ç•Œå’Œå¹³","note":"","ucode":"A7254895BA8B68","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580586,"discussion_content":"æˆ‘çš„è¾“å‡ºä¹Ÿæ˜¯è¿™æ ·çš„æ•°é‡çº§ï¼Œé€Ÿåº¦æ…¢äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658280218,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372643,"user_name":"Bachue Zhou","can_delete":false,"product_type":"c1","uid":1494491,"ip_address":"ä¸Šæµ·","ucode":"3175754775CA32","user_header":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","comment_is_top":false,"comment_ctime":1681378415,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¿™ä¸ªç¨‹åºå¯¹ libbpf çš„ç‰ˆæœ¬è¦æ±‚å¾ˆé«˜å•Šï¼Œæˆ‘è¿™è¾¹ç”¨çš„æ˜¯ Ubuntu 22.04 éƒ½ä¸è¡Œï¼Œå¾ˆå¤š symbol æ‰¾ä¸åˆ°çš„ã€‚","like_count":1,"discussions":[{"author":{"id":3867215,"avatar":"","nickname":"Geek_6acaf8","note":"","ucode":"1306723C3B23D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":639847,"discussion_content":"æœ€åæ€ä¹ˆè§£å†³çš„å“‡ï¼Œæˆ‘ç°åœ¨ä¹Ÿå¡åœ¨è¿™é‡Œäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1710947810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ±Ÿè‹","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340157,"user_name":"æ—é–","can_delete":false,"product_type":"c1","uid":1232564,"ip_address":"","ucode":"A1F79AAEF091B8","user_header":"https://static001.geekbang.org/account/avatar/00/12/ce/b4/bb5d7f90.jpg","comment_is_top":false,"comment_ctime":1648633673,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"å€ªéƒ½ä½ å¥½ï¼Œæˆ‘å‚è€ƒtc-bpfæ‰‹å†Œç¼–è¯‘äº†ä¸€ä¸ªtcç¨‹åºï¼Œæºç å¦‚ä¸‹ï¼š\n#include &lt;linux&#47;bpf.h&gt;\n\n           #ifndef __section\n           # define __section(x)  __attribute__((section(x), used))\n           #endif\n\n           __section(&quot;classifier&quot;) int cls_main(struct __sk_buff *skb)\n           {\n                   return -1;\n           }\n\n           char __license[] __section(&quot;license&quot;) = &quot;GPL&quot;;\nç¼–è¯‘å®Œç”¨tcåŠ è½½çš„æ—¶å€™æŠ¥å¦‚ä¸‹é”™è¯¯ï¼š\ntc filter add dev eth0 parent 1: bpf obj bcc.o verbose flowid 1:1 skip_sw\nlibbpf: loading bcc.o\nlibbpf: elf: section(3) classifier, size 24, link 0, flags 6, type=1\nlibbpf: elf: section(4) license, size 4, link 0, flags 3, type=1\nlibbpf: license of bcc.o is GPL\nlibbpf: elf: section(5) .eh_frame, size 48, link 0, flags 2, type=1\nlibbpf: elf: skipping unrecognized data section(5) .eh_frame\nlibbpf: elf: section(6) .rel.eh_frame, size 16, link 7, flags 0, type=9\nlibbpf: elf: skipping relo section(6) .rel.eh_frame for section(5) .eh_frame\nlibbpf: elf: section(7) .symtab, size 96, link 1, flags 0, type=2\nlibbpf: looking for externs among 4 symbols...\nlibbpf: collected 0 externs total\nobject file doesn&#39;t contain sec classifier\nUnable to load program\n\nè¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆå›äº‹ï¼Œæ‰¾äº†ä¸€ä¸‹åˆéƒ½æ²¡æœ‰å‘ç°é—®é¢˜å‡ºåœ¨å“ª\n","like_count":1},{"had_liked":false,"id":388823,"user_name":"Geek_6acaf8","can_delete":false,"product_type":"c1","uid":3867215,"ip_address":"æ±Ÿè‹","ucode":"1306723C3B23D5","user_header":"","comment_is_top":false,"comment_ctime":1710934715,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"xdp-proxy-v2.c:78:2: warning: implicit declaration of function &#39;LIBBPF_OPTS&#39; is invalid in C99 [-Wimplicit-function-declaration]\n        LIBBPF_OPTS(bpf_xdp_attach_opts, attach_opts);\n        ^\nxdp-proxy-v2.c:78:14: error: use of undeclared identifier &#39;bpf_xdp_attach_opts&#39;\n        LIBBPF_OPTS(bpf_xdp_attach_opts, attach_opts);\n                    ^\nxdp-proxy-v2.c:78:35: error: use of undeclared identifier &#39;attach_opts&#39;\n        LIBBPF_OPTS(bpf_xdp_attach_opts, attach_opts);\n                                         ^\nxdp-proxy-v2.c:79:8: warning: implicit declaration of function &#39;bpf_xdp_attach&#39; is invalid in C99 [-Wimplicit-function-declaration]\n        err = bpf_xdp_attach(ifindex, prog_id, xdp_flags, &amp;attach_opts);\n              ^\nxdp-proxy-v2.c:79:53: error: use of undeclared identifier &#39;attach_opts&#39;\n        err = bpf_xdp_attach(ifindex, prog_id, xdp_flags, &amp;attach_opts);\n                                                           ^\nxdp-proxy-v2.c:91:2: warning: implicit declaration of function &#39;bpf_xdp_detach&#39; is invalid in C99 [-Wimplicit-function-declaration]\n        bpf_xdp_detach(ifindex, xdp_flags, &amp;attach_opts);\n        ^\nxdp-proxy-v2.c:91:38: error: use of undeclared identifier &#39;attach_opts&#39;\n        bpf_xdp_detach(ifindex, xdp_flags, &amp;attach_opts);\nåœ¨ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶çš„æ—¶å€™æ€»æ˜¯æŠ¥é”™ï¼Œä¹‹å‰çš„ä¾èµ–ä¹Ÿéƒ½å®‰è£…äº†","like_count":0},{"had_liked":false,"id":345844,"user_name":"Geek_5aa343","can_delete":false,"product_type":"c1","uid":2635369,"ip_address":"","ucode":"535F96029C1EB7","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/pNKoOAa1QXibrykHNXibW4tyaIIhicocPGXtcVnEianCyOQY9bl0P2JQ3wSialUaolcLVEWycCEBz1Oe4Tj4yghH9yw/132","comment_is_top":false,"comment_ctime":1652627580,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"libbpfä¸­çš„section_defsé“¾æ¥æ›´æ–°ä¸‹ï¼šhttps:&#47;&#47;github.com&#47;libbpf&#47;libbpf&#47;blob&#47;master&#47;src&#47;libbpf.c#L9003-L9080","like_count":0},{"had_liked":false,"id":340159,"user_name":"æ—é–","can_delete":false,"product_type":"c1","uid":1232564,"ip_address":"","ucode":"A1F79AAEF091B8","user_header":"https://static001.geekbang.org/account/avatar/00/12/ce/b4/bb5d7f90.jpg","comment_is_top":false,"comment_ctime":1648634817,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"æˆ‘çŸ¥é“äº† åº”è¯¥æ˜¯æˆ‘iproute2æœ‰é—®é¢˜","like_count":0}]}