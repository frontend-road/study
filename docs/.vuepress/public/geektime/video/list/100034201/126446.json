{"id":126446,"title":"18 | ZooKeeper节点是如何存储数据的?","content":"<p><strong>课件和Demo地址</strong></p><p><a href=\"https://gitee.com/geektime-geekbang/geekbang-zk-course\">https://gitee.com/geektime-geekbang/geekbang-zk-course</a></p>","comments":[{"had_liked":false,"id":154788,"user_name":"welike","can_delete":false,"product_type":"c3","uid":1222362,"ip_address":"","ucode":"7AECBFB172919D","user_header":"https://static001.geekbang.org/account/avatar/00/12/a6/da/e64e080a.jpg","comment_is_top":false,"comment_ctime":1574564403,"is_pvip":false,"replies":[{"id":60478,"content":"多谢您的建议。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1575262477,"ip_address":"","comment_id":154788,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师的这个课讲的跳跃性太大了，知识点有点干巴巴","like_count":4,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475577,"discussion_content":"多谢您的建议。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575262477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131874,"user_name":"天使梦泪","can_delete":false,"product_type":"c3","uid":1235750,"ip_address":"","ucode":"782991747DD424","user_header":"https://static001.geekbang.org/account/avatar/00/12/db/26/3c8d68fb.jpg","comment_is_top":false,"comment_ctime":1567946609,"is_pvip":false,"replies":[{"id":50525,"content":"不是的。ZooKeeper有一个参数snapCount(https:&#47;&#47;zookeeper.apache.org&#47;doc&#47;current&#47;zookeeperAdmin.html)和快照的生成有关，默认是100000。一个ZooKeeper节点会取[snapCount&#47;2+1, snapCount]中间的一个随机数，每当有这个随机数这么多的事务时就生成一个新的快照。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1568044126,"ip_address":"","comment_id":131874,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师好，zk的快照是每一个事务一个快照吗？","like_count":2,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466658,"discussion_content":"不是的。ZooKeeper有一个参数snapCount(https://zookeeper.apache.org/doc/current/zookeeperAdmin.html)和快照的生成有关，默认是100000。一个ZooKeeper节点会取[snapCount/2+1, snapCount]中间的一个随机数，每当有这个随机数这么多的事务时就生成一个新的快照。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568044126,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":138129,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1570047792,"is_pvip":false,"replies":[{"id":53177,"content":"&gt; 老师 求教  如果我有三个zookeeper 组成的cluster， 那么这三个zookeeper里边的数据是一样的嘛？ 也就是master node每次写完了都会同步到其他的节点上？  \n\nZooKeeper要求在commit一个写操作之前就要在集群中大多数节点上进行日志写入。集群中某些节点的数据会稍微旧一些。建设ZooKeeper的3个节点是A，B和C：A是leader。例如，如果A和C的之间的网络很慢，一个写请求就有可能会被A和B处理之后被提交，这样C的数据就会旧一些。\n\n&gt; master node如果死了， 会重新选举，如果slave node死了会怎么样？\n\n只要有大多数节点正常工作，ZooKeeper集群就可以正常工作。slave node死了不会发生选举。如果运维发现有节点有问题应该尽快进行节点的替换，可以通过reconfiguration（http:&#47;&#47;zookeeper.apache.org&#47;doc&#47;r3.5.5&#47;zookeeperReconfig.html)来进行。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1570096448,"ip_address":"","comment_id":138129,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师 求教  如果我有三个zookeeper 组成的cluster， 那么这三个zookeeper里边的数据是一样的嘛？ 也就是master node 每次写完了 都会同步到其他的节点上？  master node如果死了， 会重新选举，如果slave node死了会怎么样？","like_count":1,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469398,"discussion_content":"&amp;gt; 老师 求教  如果我有三个zookeeper 组成的cluster， 那么这三个zookeeper里边的数据是一样的嘛？ 也就是master node每次写完了都会同步到其他的节点上？  \n\nZooKeeper要求在commit一个写操作之前就要在集群中大多数节点上进行日志写入。集群中某些节点的数据会稍微旧一些。建设ZooKeeper的3个节点是A，B和C：A是leader。例如，如果A和C的之间的网络很慢，一个写请求就有可能会被A和B处理之后被提交，这样C的数据就会旧一些。\n\n&amp;gt; master node如果死了， 会重新选举，如果slave node死了会怎么样？\n\n只要有大多数节点正常工作，ZooKeeper集群就可以正常工作。slave node死了不会发生选举。如果运维发现有节点有问题应该尽快进行节点的替换，可以通过reconfiguration（http://zookeeper.apache.org/doc/r3.5.5/zookeeperReconfig.html)来进行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570096448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167995,"user_name":"kkxue","can_delete":false,"product_type":"c3","uid":1159904,"ip_address":"","ucode":"0DCB861D5543D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/b2/e0/bf56878a.jpg","comment_is_top":false,"comment_ctime":1577973390,"is_pvip":false,"replies":[{"id":66862,"content":"是的。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1579174867,"ip_address":"","comment_id":167995,"utype":1}],"discussion_count":1,"race_medal":5,"score":2,"product_id":100034201,"comment_content":"老师好，zk的整个data tree都会加载到内存么？","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480092,"discussion_content":"是的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579174867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":167681,"user_name":"泊浮目","can_delete":false,"product_type":"c3","uid":1067981,"ip_address":"","ucode":"182A7CC2F6BDAB","user_header":"https://static001.geekbang.org/account/avatar/00/10/4b/cd/185e5378.jpg","comment_is_top":false,"comment_ctime":1577892504,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师，请教下——为什么要有快照文件呢？zxid又为什么要设置高低位呢？Epoch文件是用来存储什么数据的？","like_count":6,"discussions":[{"author":{"id":1252813,"avatar":"https://static001.geekbang.org/account/avatar/00/13/1d/cd/3819726f.jpg","nickname":"徐同学呀","note":"","ucode":"03383EE820514D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394040,"discussion_content":"快照文件是对某个时间点所有数据的一个快照，事务日志是增量数据，最新的快照文件和该快照文件之后的事务日志文件一起可以表示zk的全量数据，通过备份快照文件和事务日志文件来恢复数据。zxid 高位是当前leader的纪元，纪元就跟古代皇帝的年号差不多的概念，纪元是递增的，每重选一次leader  纪元+1，zxid低位就是事务id了，epoch有两个文件acceptedEpoch和currentEpoch 存的值一样是当前leader的纪元","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1631694256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287361,"user_name":"追风也曾少年","can_delete":false,"product_type":"c3","uid":1041278,"ip_address":"","ucode":"248D267558E55E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e3/7e/a546d86d.jpg","comment_is_top":false,"comment_ctime":1617901238,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"epoch文件是啥？什么作用？这提了一下就结束了？","like_count":2},{"had_liked":false,"id":274887,"user_name":"惘 闻","can_delete":false,"product_type":"c3","uid":1181650,"ip_address":"","ucode":"C5909F034BF072","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg","comment_is_top":false,"comment_ctime":1611209885,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师讲的再详细点就好了.... 感觉每次就是点一下 然后不铺开讲","like_count":1},{"had_liked":false,"id":170461,"user_name":"WL","can_delete":false,"product_type":"c3","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1578617603,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"Epoch文件的作用是什么？","like_count":1},{"had_liked":false,"id":291367,"user_name":"vivaxiao","can_delete":false,"product_type":"c3","uid":1303080,"ip_address":"","ucode":"B88992C3FF5BA1","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/28/ef7f3d03.jpg","comment_is_top":false,"comment_ctime":1620229729,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师，请教一下，如果zk的所有node都挂了，要怎么处理呢？","like_count":0}]}