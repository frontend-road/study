{"id":113560,"title":"10 | WebRTC NAT穿越原理","content":"<p>在 WebRTC 中， NAT 穿越是非常重要的一部分内容，也是比较有深度、比较难以理解的一部分知识。当然，等你学完本文，并完全理解了这部分知识后，你也会特别有成就感！</p><p>在我们真实的网络环境中，NAT 随处可见，而它的出现主要是出于两个目的。<strong>第一个是解决 IPv4 地址不够用的问题</strong>。在 IPv6 短期内无法替换 IPv4 的情况下，如何能解决 IP 地址不够的问题呢？人们想到的办法是，让多台主机共用一个公网 IP 地址，然后在内部使用内网 IP 进行通信，这种方式大大减缓了 IPv4 地址不够用的问题。<strong>第二个是解决安全问题</strong>，也就是主机隐藏在内网，外面有NAT挡着，这样的话黑客就很难获取到该主机在公网的IP地址和端口，从而达到防护的作用。</p><p>不过凡事有利也有弊，NAT 的引入确实带来了好处，但同时也带来了坏处。如果没有NAT，那么每台主机都可以有一个自己的公网IP地址，这样每台主机之间都可以相互连接。可以想象一下，如果是那种情况的话，互联网是不是会更加繁荣？因为有了公网IP地址后，大大降低了端与端之间网络连接的复杂度，我们也不用再费这么大力气在这里讲 NAT 穿越的原理了。</p><p>如果从哲学的角度来讲，“世上的麻烦都是自己找的”，这句话还是蛮有道理的。</p><!-- [[[read_end]]] --><h2>在WebRTC处理过程中的位置</h2><p>下面我们来看一下本文在 WebRTC 处理过程中所处的位置吧。通过下面这张图，你可以清楚地了解到本文我们主要讲解的是传输相关的内容。</p><p><img src=\"https://static001.geekbang.org/resource/image/38/b9/3885178d5747a92ef95819fd0fe618b9.png?wh=1142*552\" alt=\"\"></p><center><span class=\"reference\">WebRTC 处理过程图</span></center><h2>NAT 的种类</h2><p>随着人们对 NAT 使用的深入，NAT 的设置也越来越复杂。尤其是各种安全的需要，对 NAT 的复杂性起到了推波助澜的作用。</p><p>经过大量研究，现在NAT基本上可以总结成 4 种类型：<strong>完全锥型、IP限制锥型、端口限制锥型和对称型</strong>。</p><p>下面我们就对这 4 种类型的 NAT 做下详细介绍。</p><h3>1. 完全锥型 NAT</h3><p><img src=\"https://static001.geekbang.org/resource/image/88/af/8836f91edfcc9a2420e3fd11098f95af.png?wh=1142*629\" alt=\"\"></p><center><span class=\"reference\">完全锥型 NAT 图</span></center><p>完全锥型 NAT 的特点是，当 host 主机通过 NAT 访问外网的 B 主机时，就会在 NAT 上打个“洞”，所有知道这个“洞”的主机都可以通过它与内网主机上的侦听程序通信。</p><p>实际上，这里<strong>所谓的“打洞”就是在 NAT 上建立一个内外网的映射表</strong>。你可以将该映射表简单地认为是一个 4 元组，即：</p><pre><code>{\n\t内网IP，\n\t内网端口，\n\t映射的外网IP，\n\t映射的外网端口\n}\n</code></pre><p>在 NAT 上有了这张映射表，所有发向这个“洞”的数据都会被 NAT 中转到内网的 host 主机。而在 host 主机上侦听其内网端口的应用程序就可以收到所有的数据了，是不是很神奇？</p><p>还是以上面那张图为例，如果 host 主机与 B 主机“打洞”成功，且 A 与 C 从 B主机那里获得了 host 主机的外网IP及端口，那么A与C就可以向该IP和端口发数据，而 host 主机上侦听对应端口的应用程序就能收到它们发送的数据。</p><p>如果你在网上查找NAT穿越的相关资料，一定会发现大多数打洞都是使用的 UDP 协议。之所以会这样，是因为<strong>UDP是无连接协议</strong>，它没有连接状态的判断，也就是说只要你发送数据给它，它就能收到。而 TCP 协议就做不到这一点，它必须建立连接后，才能收发数据，因此大多数人都选用 UDP 作为打洞协议。</p><h3>2. IP限制锥型 NAT</h3><p><img src=\"https://static001.geekbang.org/resource/image/63/8a/6358816cf33831f22338cb26016d028a.png?wh=1142*617\" alt=\"\"></p><center><span class=\"reference\">IP限制锥型 NAT 图</span></center><p>IP限制锥型要比完全锥型NAT严格得多，它主要的特点是，host 主机在 NAT 上“打洞”后，NAT 会对穿越洞口的 IP 地址做限制。只有登记的 IP 地址才可以通过，也就是说，<strong>只有 host 主机访问过的外网主机才能穿越 NAT</strong>。</p><p>而其他主机即使知道“洞”的位置，也不能与 host 主机通信，因为在通过 NAT 时，NAT 会检查IP地址，如果发现发来数据的 IP 地址没有登记，则直接将该数据包丢弃。</p><p>所以，IP 限制锥型 NAT 的映射表是一个 5 元组，即：</p><pre><code>{\n\t内网IP，\n\t内网端口，\n\t映射的外网IP，\n\t映射的外网端口，\n\t被访问主机的IP\n}\n</code></pre><p>还是以上图为例，host 主机访问 B 主机，那么只有 B 主机发送的数据才能穿越NAT，其他主机 A 和 C 即使从 B 主机那里获得了 host 主机的外网IP和端口，也无法穿越 NAT。因为 NAT 会对通过的每个包做检测，当检查发现发送者的IP地址与映射表中的“被访问主机的IP”不一致，则直接将该数据包丢弃。</p><p>需要注意的是，<strong>IP限制型NAT只限制IP地址</strong>，如果是同一主机的不同端口穿越NAT是没有任何问题的。</p><h3>3. 端口限制锥型</h3><p><img src=\"https://static001.geekbang.org/resource/image/d6/0b/d6490bff17fdad51271266cef074920b.png?wh=1142*617\" alt=\"\"></p><center><span class=\"reference\">端口限制锥型 NAT 图</span></center><p>端口限制锥型比IP限制锥型NAT更加严格，它主要的特点是，不光在 NAT 上对打洞的 IP 地址做了限制，而且还对具体的端口做了限制。因此，端口限制型NAT的映射表是一个 6 元组，其格式如下：</p><pre><code>{\n\t内网IP，\n\t内网端口，\n\t映射的外网IP，\n\t映射的外网端口，\n\t被访问主机的IP,\n\t被访问主机的端口\n}\n</code></pre><p>在该 6 元组中，不光包括了 host 主机内外网的映射关系，还包括了<strong>要访问的主机的 IP 地址及提供服务的应用程序的端口地址</strong>。</p><p>如上图所示，host 主机访问 B 主机的 p1 端口时，只有 B 主机的 p1 端口发送的消息才能穿越 NAT 与 host 主机通信。而其他主机，甚至 B 主机的 p2 端口都无法穿越 NAT。</p><p>从上面的情况你应该看出来了，从完全锥型NAT到端口限制型NAT，一级比一级严格。但其实端口型NAT还不是最严格的，最严格的是接下来要讲解的对称型NAT。</p><h3>4. 对称型NAT</h3><p><img src=\"https://static001.geekbang.org/resource/image/a8/7c/a80a2b1c98b8becce0c99e979fa3ba7c.png?wh=1142*617\" alt=\"\"></p><center><span class=\"reference\">对称型 NAT 图</span></center><p><strong>对称型NAT是所有 NAT 类型中最严格的一种类型</strong>。通过上图你可以看到，host主机访问 B 时它在 NAT 上打了一个“洞”，而这个“洞”只有 B 主机上提供服务的端口发送的数据才能穿越，这一点与端口限制型NAT是一致的。</p><p>但它与端口限制型NAT最大的不同在于，如果 host 主机访问 A 时，它会在 NAT 上重新开一个“洞”，而不会使用之前访问B时打开的“洞”。也就是说对称型 NAT 对每个连接都使用不同的端口，甚至更换IP地址，而端口限制型NAT的多个连接则使用同一个端口，这对称型NAT与端口限制型NAT最大的不同。上面的描述有点抽象，你要好好理解一下。</p><p>它的这种特性为 NAT 穿越造成了很多麻烦，尤其是对称型NAT碰到对称型NAT，或对称型NAT遇到端口限制型NAT时，基本上双方是无法穿越成功的。</p><p>以上就是NAT的 4 种类型，通过对这 4 种NAT类型的了解，你就很容易理解 NAT 该如何穿越了。</p><h2>NAT 类型检测</h2><p>通过上面的介绍，相信你会很容易判断出NAT是哪种类型，但对于每一台主机来说，它怎么知道自己是哪种NAT类型呢？</p><p><img src=\"https://static001.geekbang.org/resource/image/b1/c3/b112ac2cd7e557d86dd5669e2858f6c3.png?wh=1142*857\" alt=\"\"></p><center><span class=\"reference\">NAT类型检测图</span></center><p>上面这张图清楚地表达了主机进行 NAT 类型检测的流程。其中蓝框是几个重要的检测点，通过这几个检测点你就可以很容易地检测出上面介绍的4种不同类型的 NAT了。</p><p>接下来，我们就对上面这张图做下详细的解释。<strong>这里需要注意的是，每台服务器都是双网卡的，而每个网卡都有一个自己的公网IP地址</strong>。</p><h3>第一步，判断是否有NAT防护</h3><ol>\n<li>主机向服务器#1的某个IP和端口发送一个请求，服务器#1收到请求后，会通过同样的IP 和端口返回一个响应消息。</li>\n<li>如果主机收不到服务器#1返回的消息，则说明用户的网络<strong>限制了UDP协议，直接退出</strong>。</li>\n<li>如果能收到包，则判断返回的主机的外网IP地址是否与主机自身的IP地址一样。如果一样，说明主机就是一台<strong>拥有公网地址的主机</strong>；如果不一样，就跳到下面的步骤6。</li>\n<li>如果主机拥有公网IP，则还需要进一步判断其防火墙类型。所以它会再向服务器#1发一次请求，此时，服务器#1从另外一个网卡的IP和不同端口返回响应消息。</li>\n<li>如果主机能收到，说明它是一台没有防护的公网主机；如果收不到，则说明有<strong>对称型的防火墙</strong>保护着它。</li>\n<li>继续分析第3步，如果返回的外网IP地址与主机自身IP不一致，说明主机是处于 NAT 的防护之下，此时就需要对主机的 NAT防护类型做进一步探测。</li>\n</ol><h3>第二步，探测NAT环境</h3><ol>\n<li>在 NAT 环境下，主机向服务器#1发请求，服务器#1通过另一个网卡的IP和不同端口给主机返回响应消息。</li>\n<li>如果此时主机可以收到响应消息，说明它是在一个<strong>完全锥型NAT</strong>之下。如果收不到消息还需要再做进一步判断。</li>\n<li>如果主机收不到消息，它向服务器#2（也就是第二台服务器）发请求，服务器#2使用收到请求的IP地址和端口向主机返回消息。</li>\n<li>主机收到消息后，判断从服务器#2获取的外网IP和端口与之前从服务器#1获取的外网IP和端口是否一致，如果不一致说明该主机是在<strong>对称型NAT</strong>之下。</li>\n<li>如果IP地址一样，则需要再次发送请求。此时主机向服务器#1再次发送请求，服务器#1使用同样的IP和不同的端口返回响应消息。</li>\n<li>此时，如果主机可以收到响应消息说明是<strong>IP 限制型 NAT</strong>，否则就为<strong>端口限制型NAT</strong>。</li>\n</ol><p>至此，主机所在的 NAT 类型就被准确地判断出来了。有了主机的 NAT 类型你就很容易判断两个主机之间到底能不能成功地进行 NAT 穿越了。</p><p>再后面的事件就变得比较容易了，当你知道了 NAT 类型后，如何进行NAT 穿越也就水到渠成了呢！</p><h2>小结</h2><p>通过上面的介绍，我想你应该已经对 NAT 的 4种类型了然于胸了。理解了NAT的4种类型，同时又清楚了主机如何去判断自己的 NAT 类型之后，你应该自己就可以想清楚不同 NAT 类型之间是如何进行 NAT 穿越的了。</p><p>了解了NAT 穿越的理论知识，你就很容易理解 WebRTC 底层是如何进行音视频数据传输了吧？WebRTC中媒体协商完成之后，就会对Candidate pair进行连通性检测，其中非常重要的一项工作就是进行 NAT 穿越。</p><p>它首先通过上面描述的方法进行 NAT 类型检测，当检测到双方理论上是可以通过 NAT 穿越时，就开始真正的 NAT 穿越工作，如果最终真的穿越成功了，通信双方就通过该连接将音视频数据源源不断地发送给对方。最终，你就可以看到音视频了。</p><h2>思考时间</h2><p>为什么对称型 NAT 与对称型 NAT 之间以及对称型 NAT 与端口限制型NAT 之间无法打洞成功呢？如果打洞失败，你又该如何让通信双方实现互联呢？</p><p>欢迎在留言区与我分享你的想法，也欢迎你在留言区记录你的思考过程。感谢阅读，如果你觉得这篇文章对你有帮助的话，也欢迎把它分享给更多的朋友。</p><p></p>","neighbors":{"left":{"article_title":"09 | 让我们揭开WebRTC建立连接的神秘面纱","id":112325},"right":{"article_title":"11 | 如何通过Node.js实现一套最简单的信令系统？","id":114179}},"comments":[{"had_liked":false,"id":121220,"user_name":"花果山の酸梅汤","can_delete":false,"product_type":"c1","uid":1606018,"ip_address":"","ucode":"E4A71E8AD52CB3","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoicwtj6x3l7NEcODqsXHjUTjzbl99pesNbydQUSfR6IywcKKyyaY9AIhBS0bCz3R8icMRIploDdUQA/132","comment_is_top":false,"comment_ctime":1565080210,"is_pvip":false,"replies":[{"id":"44707","content":"非常赞！描述的非常清楚！","user_name":"作者回复","comment_id":121220,"uid":"1507837","ip_address":"","utype":1,"ctime":1565187824,"user_name_real":"garrylee"}],"discussion_count":5,"race_medal":0,"score":"139004033682","product_id":100031801,"comment_content":"类型（A-B）\t建立状况<br>完全锥型-完全锥型\tA通过server获得B的IP:port开始通信<br>完全锥型-IP限制型\tB通过server获得A的IP:port开始通信<br>完全锥型-port限制型\tB通过server获得A的IP:port开始通信<br>完全锥型-对称型\tB通过server获得A的IP:port开始通信<br>IP限制型-IP限制型\tA通过server获得B的IP:port，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，二者之后就可以开始通信。<br>IP限制型-port限制型\tA通过server获得B的IP:port，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，二者之后就可以开始通信。<br>IP限制型-对称型\tA通过server获得B的IP:port1，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，A收到B的UDP包，获得B新的IP:port2；A向B的新地址IP:port2发送数据，可以开始通信。<br>port限制型-对称型\tA通过server获得B的IP:port1，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目；B通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，但由于B更换了新端口port2，A刚建立的映射无法使用，A故此无法收到B为A通信使用的新端口，无法建立NAT映射，两者无法互通。<br>对称型-对称型\t同上，对称型开启新端口对方无法获悉，无法建立链接。<br>无法P2P就需要用TURN服务器转发数据了…","like_count":32,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461687,"discussion_content":"非常赞！描述的非常清楚！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565187824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1156607,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a5/ff/6201122c.jpg","nickname":"Geek_89bbab","note":"","ucode":"B3110D5B3C9500","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204433,"discussion_content":"还差一个port限制型-port限制型: \n1. A:Pa1->B:Pb1 允许B的Pb1端口数据发送过来, 但数据没有发送到B,B的NAT不允许通过\n2. B:Pb1->A:Pa1允许A的Pa1端口数据发送过来，这次可以数据包通过A的NAT到达A.\n3. A也可以发送数据到B了。这个时候A:Pa1和B:Pb1都可以相互通信了","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1584173101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008933,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg","nickname":"斜月浮云","note":"","ucode":"25CECBB175DA02","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":20915,"discussion_content":"这个IP限制和对称通讯的前提是对称NAT的IP不变吧。不然B的udp发不到A的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1569393510,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1081922,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","nickname":"刘丹","note":"","ucode":"66594D1C957E15","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4099,"discussion_content":"IP限制型-IP限制型\t\nA通过server获得B的IP:port，A向B发送UDP包，数据通过自己的NAT时会为B建立NAT映射条目，但B的这个IP只允许与server通信。\nB通过server获得A的IP:port，发送UDP包为A建立NAT映射条目，但A的这个IP只允许与server通信。\nA、B怎样可以直接通信？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1565114302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1066752,"avatar":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","nickname":"piboye","note":"","ucode":"7CFD8712857A85","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352839,"discussion_content":"port限制型-对称型  可以生日攻击解决\n对称型- 对称型   端口预测/ UPnP","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614866319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":147068,"user_name":"李新","can_delete":false,"product_type":"c1","uid":1707670,"ip_address":"","ucode":"C3F5DB56328417","user_header":"https://static001.geekbang.org/account/avatar/00/1a/0e/96/eca820c7.jpg","comment_is_top":false,"comment_ctime":1572785036,"is_pvip":false,"replies":[{"id":"57401","content":"在中国，P2P 成功率很低，尤其是移动互联网。","user_name":"作者回复","comment_id":147068,"uid":"1507837","ip_address":"","utype":1,"ctime":1573191816,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"18752654220","product_id":100031801,"comment_content":"请教一下，除了生日攻击，还有其他方法提高P2P的打洞成功率吗？ ","like_count":4,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473126,"discussion_content":"在中国，P2P 成功率很低，尤其是移动互联网。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573191816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":177608,"user_name":"Benjamin","can_delete":false,"product_type":"c1","uid":1168314,"ip_address":"","ucode":"9650EFA8481B41","user_header":"https://static001.geekbang.org/account/avatar/00/11/d3/ba/75f3b73b.jpg","comment_is_top":false,"comment_ctime":1581433382,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14466335270","product_id":100031801,"comment_content":"https:&#47;&#47;static001.geekbang.org&#47;resource&#47;image&#47;b1&#47;c3&#47;b112ac2cd7e557d86dd5669e2858f6c3.png<br><br>一图胜千言，这图一看到总算搞明白了。","like_count":4},{"had_liked":false,"id":217163,"user_name":"杨凯","can_delete":false,"product_type":"c1","uid":2002116,"ip_address":"","ucode":"310806F849228B","user_header":"https://static001.geekbang.org/account/avatar/00/1e/8c/c4/760934c0.jpg","comment_is_top":false,"comment_ctime":1589429044,"is_pvip":false,"replies":[{"id":"81384","content":"socket的端口实现上代表的是一个应用（一个应用程序）。本来是 25568 这个应用在提供服务，给果有一个包来了说让 25567 对应的应用来提供服务，当你的操作系统收到这个包时，就将数据传给 25567这个应用。但实际上你的系统上就没有 25567 这个应用，那系统怎么办呢？它的作法很简单，就是返回一个reset，告诉发送端这个连接是不存在的，请重新进行三次握手。","user_name":"作者回复","comment_id":217163,"uid":"1507837","ip_address":"","utype":1,"ctime":1590293987,"user_name_real":"音视频专家-李超"}],"discussion_count":1,"race_medal":0,"score":"10179363636","product_id":100031801,"comment_content":"老师您好，请问下：客户端C与服务端S进行socket通讯，TCP握手连接成功后，通过抓包分析端口是25568，然而，S端收到的第一个数据包的端口变成25567，导致C端报错connection reset，能说下什么原因吗？","like_count":2,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495059,"discussion_content":"socket的端口实现上代表的是一个应用（一个应用程序）。本来是 25568 这个应用在提供服务，给果有一个包来了说让 25567 对应的应用来提供服务，当你的操作系统收到这个包时，就将数据传给 25567这个应用。但实际上你的系统上就没有 25567 这个应用，那系统怎么办呢？它的作法很简单，就是返回一个reset，告诉发送端这个连接是不存在的，请重新进行三次握手。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590293987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149706,"user_name":"Happy~张🤔","can_delete":false,"product_type":"c1","uid":1502239,"ip_address":"","ucode":"A3CBB85D902937","user_header":"https://static001.geekbang.org/account/avatar/00/16/ec/1f/cd321f00.jpg","comment_is_top":false,"comment_ctime":1573350880,"is_pvip":false,"replies":[{"id":"58304","content":"WebRTC内部首先会判断对方是否与自己在同一个网段，也就是说先判断通信双方是否在内网。如果是在内容就直接进行通信了。如果不在内网，会偿试 P2P 穿越，一旦穿越成功，双方就直接通信了，后面的传输不会用到 STUN服务器。","user_name":"作者回复","comment_id":149706,"uid":"1507837","ip_address":"","utype":1,"ctime":1573780890,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"10163285472","product_id":100031801,"comment_content":"请问一下，stun服务器作为net打洞，那打洞成功后，后面传输还是会利用stun进行转发媒体信息进行通信吗？如果不是外网信息怎么转到内网的？","like_count":2,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473947,"discussion_content":"WebRTC内部首先会判断对方是否与自己在同一个网段，也就是说先判断通信双方是否在内网。如果是在内容就直接进行通信了。如果不在内网，会偿试 P2P 穿越，一旦穿越成功，双方就直接通信了，后面的传输不会用到 STUN服务器。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573780890,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":147069,"user_name":"李新","can_delete":false,"product_type":"c1","uid":1707670,"ip_address":"","ucode":"C3F5DB56328417","user_header":"https://static001.geekbang.org/account/avatar/00/1a/0e/96/eca820c7.jpg","comment_is_top":false,"comment_ctime":1572785256,"is_pvip":false,"replies":[{"id":"57400","content":"是进行 NAT 探测的，逻辑复杂，但执行速度很快！","user_name":"作者回复","comment_id":147069,"uid":"1507837","ip_address":"","utype":1,"ctime":1573191722,"user_name_real":"garrylee"}],"discussion_count":2,"race_medal":0,"score":"5867752552","product_id":100031801,"comment_content":"请教一下，NAT类型的探测这么复杂，而且需要的时间也久，webrtc在P2P的时候是不是不需要探测NAT类型，而只是对着ICE Candidate相互发包就可以了？","like_count":1,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473127,"discussion_content":"是进行 NAT 探测的，逻辑复杂，但执行速度很快！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573191722,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1707670,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/0e/96/eca820c7.jpg","nickname":"李新","note":"","ucode":"C3F5DB56328417","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":54030,"discussion_content":"你好，请教一下，信令过程有交互nat类型吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574253098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121215,"user_name":"Jason","can_delete":false,"product_type":"c1","uid":1053390,"ip_address":"","ucode":"ABB3F1A63E102A","user_header":"https://static001.geekbang.org/account/avatar/00/10/12/ce/a8c8b5e8.jpg","comment_is_top":false,"comment_ctime":1565079777,"is_pvip":false,"replies":[{"id":"44708","content":"是可以这么理解的。在本文中我讲的一个重点是映射表，从映射表的角度去思考这各种类型的NAT理解起来会更清晰哈！","user_name":"作者回复","comment_id":121215,"uid":"1507837","ip_address":"","utype":1,"ctime":1565188120,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"5860047073","product_id":100031801,"comment_content":"尝试回答思考题，不知道理解的对不对，还请老师指正：<br>对称型NAT之间打洞失败：对称型NAT是内网主机通过STUN服务返回的外网IP：port，只是针对STUN服务的，而跟其他外网设备的链路是直接不能相通的。<br>端口受限型NAT与对称型NAT之间打洞失败：端口受限型NAT是指内网主机通过STUN服务返回的外网IP：port，要求外网设备的IP和端口是不能变的，否则链路不通。但对称型NAT针对内网主机的不同端口而映射出来的外网地址，明显不能保证IP和端口不变。","like_count":1,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461684,"discussion_content":"是可以这么理解的。在本文中我讲的一个重点是映射表，从映射表的角度去思考这各种类型的NAT理解起来会更清晰哈！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565188120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353679,"user_name":"在路上","can_delete":false,"product_type":"c1","uid":1073738,"ip_address":"北京","ucode":"CF737C1E1CF8C6","user_header":"https://static001.geekbang.org/account/avatar/00/10/62/4a/96b8544f.jpg","comment_is_top":false,"comment_ctime":1659670880,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659670880","product_id":100031801,"comment_content":"问题提高「每台服务器都是双网卡的，而每个网卡都有一个自己的公网 IP 地址」 ，公网IP地址可以是一个NAT网关的IP吗？","like_count":0},{"had_liked":false,"id":344101,"user_name":"Vincent.永生","can_delete":false,"product_type":"c1","uid":2079881,"ip_address":"","ucode":"DD907536D53047","user_header":"https://static001.geekbang.org/account/avatar/00/1f/bc/89/391ddcdf.jpg","comment_is_top":false,"comment_ctime":1651239319,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1651239319","product_id":100031801,"comment_content":"老师请教下，按总结，不做nat探测，每个打洞都按端口限制型-端口限制型来穿越就行了？还省了双网卡的服务器","like_count":0},{"had_liked":false,"id":269692,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1608737908,"is_pvip":true,"replies":[{"id":"103807","content":"是的","user_name":"作者回复","comment_id":269692,"uid":"1507837","ip_address":"","utype":1,"ctime":1617073915,"user_name_real":"音视频专家-李超"}],"discussion_count":1,"race_medal":0,"score":"1608737908","product_id":100031801,"comment_content":"对称型可以通过生日悖论来突破吧，只是要尝试的次数太多，时间延迟较大","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512356,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617073915,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154695,"user_name":"SherwinFeng","can_delete":false,"product_type":"c1","uid":1747728,"ip_address":"","ucode":"1754290DCF5CB7","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJoNVHqRL5iatEoMgfFAaGFZxD8ic6CicxKI9Facp4bzAkNMAfaduSENlPOafs6dOGawibhNv3V9lVowQ/132","comment_is_top":false,"comment_ctime":1574513931,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574513931","product_id":100031801,"comment_content":"打洞失败自然就要用relay服务器啦","like_count":0},{"had_liked":false,"id":136239,"user_name":"斜月浮云","can_delete":false,"product_type":"c1","uid":1008933,"ip_address":"","ucode":"25CECBB175DA02","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg","comment_is_top":false,"comment_ctime":1569393752,"is_pvip":false,"replies":[{"id":"52180","content":"A 先给 B发消息。此时，A 的NAT表里会增加这样一条记录&lt;srcIP, srcPort, dstIP&gt;，然后 B再给A发消息。B的消息过来之后，A的 NAT 发现来的这个主机的IP地址在地址表中，所以放行。","user_name":"作者回复","comment_id":136239,"uid":"1507837","ip_address":"","utype":1,"ctime":1569401306,"user_name_real":"garrylee"}],"discussion_count":5,"race_medal":1,"score":"1569393752","product_id":100031801,"comment_content":"请问，如果对称NAT的B每次改变IP和端口，那么IP限制NAT主机A与对称NAT的B怎么建立连接呢？","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468522,"discussion_content":"A 先给 B发消息。此时，A 的NAT表里会增加这样一条记录&amp;lt;srcIP, srcPort, dstIP&amp;gt;，然后 B再给A发消息。B的消息过来之后，A的 NAT 发现来的这个主机的IP地址在地址表中，所以放行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569401306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1377376,"avatar":"https://static001.geekbang.org/account/avatar/00/15/04/60/20c6a3f2.jpg","nickname":"expecting","note":"","ucode":"1528740DC34DF4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551148,"discussion_content":"如果B每次连接都改变IP和端口，那应该是没法和IP限制型A连接的，但实际上IP应该是不经常改变的，老师文中也说了：“……也就是说对称型 NAT 对每个连接都使用不同的端口，甚至更换 IP 地址……”，这就是说IP限制型和对称型大概率可以连接成功。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644910148,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1118102,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/wBibtTTkiaGtcJ3qBeG4BnB4MmaurYf8hZTrXiczmvLHlRrqxJicRaoQPAZ0vw9HHd7yxDH27TLCzBQqqOqyGukw1g/132","nickname":"gen_jin","note":"","ucode":"E282DB98815F13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275474,"discussion_content":"但B发送给A洞，A洞由于发现其不属于一个ip\n,通不过哦。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590719403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1118102,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/wBibtTTkiaGtcJ3qBeG4BnB4MmaurYf8hZTrXiczmvLHlRrqxJicRaoQPAZ0vw9HHd7yxDH27TLCzBQqqOqyGukw1g/132","nickname":"gen_jin","note":"","ucode":"E282DB98815F13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275439,"discussion_content":"应该是B先发消息给A吧，因为B可以通过stun协议知道A洞的(外网)地址。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590715784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1118102,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/wBibtTTkiaGtcJ3qBeG4BnB4MmaurYf8hZTrXiczmvLHlRrqxJicRaoQPAZ0vw9HHd7yxDH27TLCzBQqqOqyGukw1g/132","nickname":"gen_jin","note":"","ucode":"E282DB98815F13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275400,"discussion_content":"A找不到B如何先给B发消息呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590713533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128884,"user_name":"momo","can_delete":false,"product_type":"c1","uid":1337042,"ip_address":"","ucode":"583B97788984CF","user_header":"https://static001.geekbang.org/account/avatar/00/14/66/d2/78ee760d.jpg","comment_is_top":false,"comment_ctime":1566980045,"is_pvip":false,"replies":[{"id":"48411","content":"因为  #1 的第二块网卡后面还要用到，如果同一个网卡有两种用途就无法进行区分了。","user_name":"作者回复","comment_id":128884,"uid":"1507837","ip_address":"","utype":1,"ctime":1567265166,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"1566980045","product_id":100031801,"comment_content":"探测 NAT 环境的时候为什么要向服务器#2发请求， 不能向#1的另外一张网卡发请求吗？","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465154,"discussion_content":"因为  #1 的第二块网卡后面还要用到，如果同一个网卡有两种用途就无法进行区分了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567265166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":123049,"user_name":"恋着歌","can_delete":false,"product_type":"c1","uid":1001048,"ip_address":"","ucode":"CFDC00CB9965D9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/46/58/31205087.jpg","comment_is_top":false,"comment_ctime":1565597504,"is_pvip":false,"replies":[{"id":"45218","content":"这与你们公司用的网关&#47;路由设备的实现有关","user_name":"作者回复","comment_id":123049,"uid":"1507837","ip_address":"","utype":1,"ctime":1565611886,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"1565597504","product_id":100031801,"comment_content":"看了 花果山の酸梅汤 同学的回答。打洞不成功是因为建立了两个连接，但是为什么不用发起者建立的连接来传回数据呢？","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462515,"discussion_content":"这与你们公司用的网关/路由设备的实现有关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565611886,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121817,"user_name":"刘丹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1565227730,"is_pvip":false,"replies":[{"id":"44828","content":"对，只有一个映射的情况是最简单的，如果有多个出口IP的话的，情况会更复杂。","user_name":"作者回复","comment_id":121817,"uid":"1507837","ip_address":"","utype":1,"ctime":1565279174,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"1565227730","product_id":100031801,"comment_content":"是否IP限制型NAT、端口限制型NAT都有一个隐含条件：WebRtc客户端与防火墙之间只有1个NAT映射？","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461959,"discussion_content":"对，只有一个映射的情况是最简单的，如果有多个出口IP的话的，情况会更复杂。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565279174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121564,"user_name":"君","can_delete":false,"product_type":"c1","uid":1607419,"ip_address":"","ucode":"F3051212585BF5","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/u9oss767Kxzbl3SVgibUzngqMiafndGzA43bgPTw8BRvTCGicAl5La5HfZJm9rTYQJBE65TkePiaVEtMDquUIaEOAg/132","comment_is_top":false,"comment_ctime":1565159528,"is_pvip":false,"replies":[{"id":"44712","content":"不太清楚，这个好像与 webrtc 没啥关系！","user_name":"作者回复","comment_id":121564,"uid":"1507837","ip_address":"","utype":1,"ctime":1565188386,"user_name_real":"garrylee"}],"discussion_count":2,"race_medal":0,"score":"1565159528","product_id":100031801,"comment_content":"老师，请教下如何编译resiprocate成ios静态库","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461854,"discussion_content":"不太清楚，这个好像与 webrtc 没啥关系！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565188386,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2731009,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoCbcibDtNsjJYkmHckjiaMSf8gnfztMojXom661844FGxAg0u1RncjkAJckhvZ8YXFWcL6abTGmphg/132","nickname":"洪乐乐","note":"","ucode":"0DB859CECAC5AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388849,"discussion_content":"我们是编译成linux静态库， ios不清楚了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629013190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121277,"user_name":"彭刚","can_delete":false,"product_type":"c1","uid":1250060,"ip_address":"","ucode":"E59D05C1EADB99","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDMOwpv5uMgy4HhoS0VPczxfXQldueafaaq2hznQx51nxZung0kYWukicNP3a3MFrhguVrjBwlwAg/132","comment_is_top":false,"comment_ctime":1565092768,"is_pvip":true,"replies":[{"id":"44703","content":"这块一定要好好看，如果这块没有学好的话，后面很难深入学习 webrtc ","user_name":"作者回复","comment_id":121277,"uid":"1507837","ip_address":"","utype":1,"ctime":1565187151,"user_name_real":"garrylee"}],"discussion_count":2,"race_medal":0,"score":"1565092768","product_id":100031801,"comment_content":"老师,前端这方面实在有点差，前端方面代码就看你的过一遍可以吗。大概能看懂每一步是干嘛的，后端部分认真写","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461720,"discussion_content":"这块一定要好好看，如果这块没有学好的话，后面很难深入学习 webrtc ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565187151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1250060,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDMOwpv5uMgy4HhoS0VPczxfXQldueafaaq2hznQx51nxZung0kYWukicNP3a3MFrhguVrjBwlwAg/132","nickname":"彭刚","note":"","ucode":"E59D05C1EADB99","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4212,"discussion_content":"恩恩 我重头好好掌握下 谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565228638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121228,"user_name":"许童童","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1565081072,"is_pvip":false,"replies":[{"id":"44706","content":"描述的还是不够清楚，在NAT 之后，它要发包是必须要有外网地址的，NAT就是将内网转成外网哈，你再好好理解理解！","user_name":"作者回复","comment_id":121228,"uid":"1507837","ip_address":"","utype":1,"ctime":1565187586,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"1565081072","product_id":100031801,"comment_content":"两端都是NAT时，因为都没有公网IP，所以只能通过中转服务器打洞，但打的打洞却被对称型 NAT限制，需要重新打洞，从而无法打洞成功。此时只能让数据也通过中转服务器传输。","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461692,"discussion_content":"描述的还是不够清楚，在NAT 之后，它要发包是必须要有外网地址的，NAT就是将内网转成外网哈，你再好好理解理解！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565187586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121029,"user_name":"刘丹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1565051748,"is_pvip":false,"replies":[{"id":"44709","content":"打洞就是指 P2P之间打洞呀！也就是两个 WebRTC客户端之间打洞。不能 A 与 B 打通了这后，再让C来与 A通讯，这是不行的。","user_name":"作者回复","comment_id":121029,"uid":"1507837","ip_address":"","utype":1,"ctime":1565188271,"user_name_real":"garrylee"}],"discussion_count":3,"race_medal":0,"score":"1565051748","product_id":100031801,"comment_content":"可以介绍一下WebRtc双方都是端口限制型NAT或者都是IP限制型NAT的情况下，怎样打洞通信的呢？好像打出来的洞只允许中间服务器和WebRtc直接通信，不允许另外一个WebRtc使用？","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461584,"discussion_content":"打洞就是指 P2P之间打洞呀！也就是两个 WebRTC客户端之间打洞。不能 A 与 B 打通了这后，再让C来与 A通讯，这是不行的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565188271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1081922,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","nickname":"刘丹","note":"","ucode":"66594D1C957E15","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4201,"discussion_content":"我还是没想明白，问题是：A、B都是WebRtc的客户端，但他们打洞时，都是与服务器C通信，这样建立的NAT映射是有权限控制的，只允许A和C、B和C通信，A、B之间怎样能直接通信呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565225518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1148770,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIROsBAWicJYLbnzYH3ibiaX2T2am9z4IKxp34uJSgib2ntfh9zKLtndAcfCUJHLZO7Q3jkia3aKu8eOSg/132","nickname":"lqq热爱学习","note":"","ucode":"25795B06CA56A1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1081922,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","nickname":"刘丹","note":"","ucode":"66594D1C957E15","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369525,"discussion_content":"NAT端口限制和IP限制这两种，A往B发送了数据，A就不会对B有限制了，B也是同样的道理。也就是你只要A向B发送了数据，即使B不能接收到，B这个时候可以往A发送数据并且被A接收到。信令服务器只是负责帮你交换candidate信息，连通性检测需要自己做。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619065937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":4201,"ip_address":""},"score":369525,"extra":""}]}]},{"had_liked":false,"id":121025,"user_name":"Beast-Of-Prey","can_delete":false,"product_type":"c1","uid":1615956,"ip_address":"","ucode":"C8BAEB1EFA50EE","user_header":"https://static001.geekbang.org/account/avatar/00/18/a8/54/06da255b.jpg","comment_is_top":false,"comment_ctime":1565051452,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565051452","product_id":100031801,"comment_content":"打卡","like_count":0},{"had_liked":false,"id":121022,"user_name":"刘丹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1565051207,"is_pvip":false,"replies":[{"id":"44710","content":"原理都讲清楚了，你可以自己回答这个问哈！告诉我你思考后的答案。","user_name":"作者回复","comment_id":121022,"uid":"1507837","ip_address":"","utype":1,"ctime":1565188337,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"1565051207","product_id":100031801,"comment_content":"请问李老师：为什么在NAT类型检测图里，要先判断是否完全对称型NAT，然后才判断是否IP限制NAT、端口限制NAT呢？这个次序能变吗？","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461579,"discussion_content":"原理都讲清楚了，你可以自己回答这个问哈！告诉我你思考后的答案。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565188337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":120996,"user_name":"Geek_4b4f4a","can_delete":false,"product_type":"c1","uid":1332203,"ip_address":"","ucode":"DFFD32B2D1741C","user_header":"https://static001.geekbang.org/account/avatar/00/14/53/eb/008f83ad.jpg","comment_is_top":false,"comment_ctime":1565047850,"is_pvip":false,"replies":[{"id":"44711","content":"是的<br>","user_name":"作者回复","comment_id":120996,"uid":"1507837","ip_address":"","utype":1,"ctime":1565188352,"user_name_real":"garrylee"}],"discussion_count":1,"race_medal":0,"score":"1565047850","product_id":100031801,"comment_content":"老师，想问一下，如果想在服务器保留音视频通话记录是不是P2P的连接方式就不能用了？","like_count":0,"discussions":[{"author":{"id":1507837,"avatar":"https://static001.geekbang.org/account/avatar/00/17/01/fd/69869646.jpg","nickname":"音视频专家-李超","note":"","ucode":"5557943CF28441","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461568,"discussion_content":"是的\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565188352,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}