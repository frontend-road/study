{"id":127776,"title":"78 | 将Staffjoy部署到本地Kubernetes环境(下)","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":128619,"user_name":"James 王政","can_delete":false,"product_type":"c3","uid":1600162,"ip_address":"","ucode":"5022CDF2413F04","user_header":"https://static001.geekbang.org/account/avatar/00/18/6a/a2/0a23bc87.jpg","comment_is_top":false,"comment_ctime":1566915099,"is_pvip":false,"replies":[{"id":47887,"content":"node port要求必须在30000以上(不能用80)，30001-&gt;80可以访问，但是会被faraday挡掉，返回unsupported domain，因为staffjoy应用是要求域名+80才能正常访问的。\n\n为了能够用80去访问staffjoy，所以我们再单独给faraday做了一个端口映射 80 -&gt; 80，这样就可以用域名+80正常访问staffjoy了。\n\n课程中我们虽然打开了node port 30001 -&gt; 80映射，但只是对node port的一个演示，实际演示staffjoy应用，我们用的是80 -&gt; 80的端口转发方式。\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1566998473,"ip_address":"","comment_id":128619,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"请问 node port 30001 -&gt; 80 和端口转发的 80 -&gt; 80 关系是什么呢， 好像没看到 30001 端口哪里有用到。","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465025,"discussion_content":"node port要求必须在30000以上(不能用80)，30001-&amp;gt;80可以访问，但是会被faraday挡掉，返回unsupported domain，因为staffjoy应用是要求域名+80才能正常访问的。\n\n为了能够用80去访问staffjoy，所以我们再单独给faraday做了一个端口映射 80 -&amp;gt; 80，这样就可以用域名+80正常访问staffjoy了。\n\n课程中我们虽然打开了node port 30001 -&amp;gt; 80映射，但只是对node port的一个演示，实际演示staffjoy应用，我们用的是80 -&amp;gt; 80的端口转发方式。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566998473,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008312,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/b8/0e1b655e.jpg","nickname":"fireshort","note":"","ucode":"10550CA9C6C730","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594642,"discussion_content":"node port 30001 -&gt; 80映射 这里确实容易误导。我一开始也不明白设置的作用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669253058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268555,"user_name":"瓜瓜","can_delete":false,"product_type":"c3","uid":1108505,"ip_address":"","ucode":"F90A5135A9BB4B","user_header":"https://static001.geekbang.org/account/avatar/00/10/ea/19/14018371.jpg","comment_is_top":false,"comment_ctime":1608256076,"is_pvip":false,"replies":[{"id":97491,"content":"你用的是新版的k8s，发布文件需要做一些调整，apiVersion需要从extensions&#47;v1beta1 调整为 apps&#47;v1，另外发布文件spec部分还要添加相应的selector，细节请参考我在B站上的视频：\nhttps:&#47;&#47;www.bilibili.com&#47;video&#47;BV1Ja4y1x748?p=7\n\n另外上面还有一个错误提示，mysql-svc中的ip地址必须是本机的真实ip地址，不能用127.0.0.1，这样k8s内的容器才能访问这个ip地址。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1608301708,"ip_address":"","comment_id":268555,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"\nkubectl apply -f test的时候，报这个错误是什么意思，该怎么解决\n\nservice&#47;account-service unchanged\nservice&#47;app-service unchanged\nservice&#47;bot-service unchanged\nservice&#47;company-service unchanged\nservice&#47;email-service unchanged\nservice&#47;faraday-service unchanged\nservice&#47;myaccount-service unchanged\nservice&#47;mysql-svc unchanged\nservice&#47;whoami-service unchanged\nservice&#47;www-service unchanged\n[unable to recognize &quot;test\\\\account-svc.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\app-spa.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\bot-svc.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\company-svc.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\email-svc.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\faraday-svc.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\myaccount-spa.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\whoami-svc.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;, unable to recognize &quot;test\\\\www-web.yaml&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#47;v1beta1&quot;]\nError from server (Invalid): error when creating &quot;test\\\\mysql-svc.yaml&quot;: Endpoints &quot;mysql-svc&quot; is invalid: subsets[0].addresses[0].ip: Invalid value: &quot;127.0.0.1&quot;: may not be in the loopback range (127.0.0.0&#47;8)","like_count":2,"discussions":[{"author":{"id":1108505,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ea/19/14018371.jpg","nickname":"瓜瓜","note":"","ucode":"F90A5135A9BB4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335773,"discussion_content":"谢谢波波老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608301921,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286422,"user_name":"json huang","can_delete":false,"product_type":"c3","uid":1332124,"ip_address":"","ucode":"EC669B7C87BC0C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIy7V2GKrAAZn509jDv1gP5NYCqqJ2xCUStvGnRzRQnoe63oIs2jIJDtrv2YibpD4sqe03YurpDO9w/132","comment_is_top":false,"comment_ctime":1617290599,"is_pvip":false,"replies":[{"id":104139,"content":"建议先通过k8s dashboard看下每个service(尤其是www-service)的pod的日志，看是否有启动异常。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1617547223,"ip_address":"","comment_id":286422,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师，您好，访问http:&#47;&#47;www.staffjoy-v2.local&#47;时报Caused by: org.apache.http.conn.HttpHostConnectException: Connect to www-service:80 [www-service&#47;10.108.178.127] failed: Connection refused (Connection refused)\n\tat org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:159)\n\tat org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:373)\n\tat org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:394)\n\tat org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:237)\n\tat org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:185)\n\nwww-service服务也是正常启动，是否跟配置有关呢？谢谢\n\nNAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\naccount-service     ClusterIP   10.97.249.236    &lt;none&gt;        80&#47;TCP         2d2h\napp-service         ClusterIP   10.111.60.205    &lt;none&gt;        80&#47;TCP         2d2h\nbot-service         ClusterIP   10.107.240.129   &lt;none&gt;        80&#47;TCP         2d2h\ncompany-service     ClusterIP   10.100.242.5     &lt;none&gt;        80&#47;TCP         2d2h\nemail-service       ClusterIP   10.101.169.176   &lt;none&gt;        80&#47;TCP         2d2h\nfaraday-service     NodePort    10.96.194.213    &lt;none&gt;        80:30001&#47;TCP   2d2h\nkubernetes          ClusterIP   10.96.0.1        &lt;none&gt;        443&#47;TCP        2d2h\nmyaccount-service   ClusterIP   10.101.67.246    &lt;none&gt;        80&#47;TCP         2d2h\nmysql-svc           ClusterIP   10.106.215.144   &lt;none&gt;        3306&#47;TCP       2d2h\nwhoami-service      ClusterIP   10.100.138.182   &lt;none&gt;        80&#47;TCP         2d2h\nwww-service         ClusterIP   10.108.178.127   &lt;none&gt;        80&#47;TCP         2d2h","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517981,"discussion_content":"建议先通过k8s dashboard看下每个service(尤其是www-service)的pod的日志，看是否有启动异常。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617547223,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280309,"user_name":"Geek_1f19ec","can_delete":false,"product_type":"c3","uid":2451988,"ip_address":"","ucode":"CA2F7C73EC75EB","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqY7LN8EUccmibo4iaalyf3ayK6tzuzr97DpicxT3JaibrohLOzAM4bHc6pewSLOvlcRuvOgo5IEDvnNQ/132","comment_is_top":false,"comment_ctime":1614156990,"is_pvip":false,"replies":[{"id":102204,"content":"本课的58~61节有介绍如何在本地开发环境中手动部署Staffjoy微服务。\n\nStaffjoy的每个微服务支持多种环境(dev&#47;test&#47;uat&#47;prod)的部署，其中appliction-dev.yml是对应本地开发环境部署的配置文件，其中依赖的微服务都直接用localhost+端口方式去连，不需要注册中心的，网关的话Staffjoy直接集成可编程网关Faraday。\n\n所以，建议你的微服务应用也要设计一套和Staffjoy类似的，可以针对不同环境进行部署的不同的配置。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1614785707,"ip_address":"","comment_id":280309,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师有个问题请教一下：\n这种springBoot + k8s 的方式开发微服务，多服务之间调用比如 A调用B  B调用C 等\n本地开发的时候 如何调试啊？\n传统的springCloud系列，我们可以在本地启注册中心&#47;网关等，然后自己注册到本机去调试\n这种springBoot + k8s  如何调试，本地也访问不了k8s内部的吧\n单独的某一个服务调试还好，毕竟只是一个单点项目，自己运行起来就好了，多个服务联调的呢\n老师有没有什么好的方案啊","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516055,"discussion_content":"本课的58~61节有介绍如何在本地开发环境中手动部署Staffjoy微服务。\n\nStaffjoy的每个微服务支持多种环境(dev/test/uat/prod)的部署，其中appliction-dev.yml是对应本地开发环境部署的配置文件，其中依赖的微服务都直接用localhost+端口方式去连，不需要注册中心的，网关的话Staffjoy直接集成可编程网关Faraday。\n\n所以，建议你的微服务应用也要设计一套和Staffjoy类似的，可以针对不同环境进行部署的不同的配置。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614785707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259373,"user_name":"龙彦极客","can_delete":false,"product_type":"c3","uid":2272998,"ip_address":"","ucode":"20D380C00D8B05","user_header":"https://static001.geekbang.org/account/avatar/00/22/ae/e6/0c41e48d.jpg","comment_is_top":false,"comment_ctime":1604715083,"is_pvip":false,"replies":[{"id":94575,"content":"docker-desktop严格讲并不是一个完整的k8s，日志可能会丢失，具体要看机器的资源配置情况，建议用k8s dashboard看，有条件可以尝试在正式的k8s或者阿里云k8s中查看。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1605015636,"ip_address":"","comment_id":259373,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师你好！\n我用mac docker-desktop部署了微服务后，\nkubectl log -f {podname} 为什么有些pod的日志只显示了一点点。\n应用功能是没有问题的。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508918,"discussion_content":"docker-desktop严格讲并不是一个完整的k8s，日志可能会丢失，具体要看机器的资源配置情况，建议用k8s dashboard看，有条件可以尝试在正式的k8s或者阿里云k8s中查看。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605015636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1400908,"avatar":"https://static001.geekbang.org/account/avatar/00/15/60/4c/f2f1cf73.jpg","nickname":"开坦克的贝塔","note":"","ucode":"A0C220A02115E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560475,"discussion_content":"你mac配置多大？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649342389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359609,"user_name":"Sam.张朝","can_delete":false,"product_type":"c3","uid":1132448,"ip_address":"上海","ucode":"FB20554D94B250","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/a0/f12115b7.jpg","comment_is_top":false,"comment_ctime":1665676595,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"[chaozhang@fedora test]$ sudo kubectl port-forward faraday-svc-deployment-597569cc98-t7pmr  80:80\n[sudo] password for chaozhang: \nThe connection to the server localhost:8080 was refused - did you specify the right host or port?\n 不断遇到问题，哈哈","like_count":0},{"had_liked":false,"id":336537,"user_name":"平头哥","can_delete":false,"product_type":"c3","uid":1692725,"ip_address":"","ucode":"C9DFEB2C5F33B8","user_header":"https://static001.geekbang.org/account/avatar/00/19/d4/35/05715cbc.jpg","comment_is_top":false,"comment_ctime":1646205549,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"波波老师，我部署以后收不到邮件，该怎么调整","like_count":0},{"had_liked":false,"id":321994,"user_name":"Hsq","can_delete":false,"product_type":"c3","uid":1539472,"ip_address":"","ucode":"E1D76C0A426F8F","user_header":"https://static001.geekbang.org/account/avatar/00/17/7d/90/59604fc7.jpg","comment_is_top":false,"comment_ctime":1637130156,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"请问一下老师，我的环境是在ubuntu主机上开了三台centos虚拟机(master,node01,node02)。但是运行kubectl port-forward faraday-svc-deployment-b669bd748-f9zzb 80:80后，switchhost是在ubuntu主机上配置域名？还是在虚拟机上配置127.0.0.1 staffjoy-local ...？。并且我在ubuntu&#47;虚拟机上用curl 127.0.0.1&#47;curl {虚拟机物理地址}都显示拒绝访问。请问一下波波老师这个是什么问题呀。","like_count":0}]}