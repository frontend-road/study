{"id":440452,"title":"09 | æ·±å…¥ç†è§£å †ï¼šmallocå’Œå†…å­˜æ± æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æµ·çº³ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/431904\">ç¬¬3èŠ‚è¯¾</a>ï¼Œæˆ‘ä»¬è®²åˆ°çº¿æ€§åœ°å€ç©ºé—´æŒ‰ç…§åŠŸèƒ½çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºä¸åŒçš„åŒºåŸŸã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ç®€å•ä»‹ç»äº†ï¼Œå¦‚ä½•ä½¿ç”¨sbrkå’Œmmapè¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·å †å†…å­˜ã€‚</p><p>å…¶å®ï¼Œå †å†…å­˜æ˜¯ç¨‹åºå‘˜æ‰“äº¤é“æœ€å¤šçš„ä¸€å—åŒºåŸŸï¼Œæ— è®ºæ˜¯å“ªç§ç¼–ç¨‹è¯­è¨€ï¼Œæ­£ç¡®åˆç†å¹¶é«˜æ•ˆåœ°ä½¿ç”¨å †å†…å­˜ï¼Œéƒ½æ˜¯æå…·æŒ‘æˆ˜çš„ä¸€ä»¶äº‹æƒ…ã€‚å¯¹ç¨‹åºè°ƒä¼˜æ˜¯ç³»ç»Ÿç¨‹åºå‘˜å¸¸è§çš„å·¥ä½œä»»åŠ¡ï¼Œè€Œå †å†…å­˜çš„ç®¡ç†å’Œåˆ†é…æ°æ°æ˜¯æœ€å®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆçš„æ¨¡å—ã€‚</p><p>ä¸è¿‡ï¼Œsbrkå’Œmmapè¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜æ•ˆç‡æ¯”è¾ƒä½ï¼Œæˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/435493\">ç¬¬5èŠ‚è¯¾</a>è®²è¿‡ï¼Œè¿›ç¨‹çš„å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åŒºåˆ«ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ˜¯è¦è¿›å…¥å†…æ ¸æ€çš„ï¼Œè¿è¡Œæ€çš„åˆ‡æ¢ä¼šè€—è´¹ä¸å°‘æ—¶é—´ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œäººä»¬å€¾å‘äºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥åˆ†é…å¤§å—å†…å­˜ï¼Œç„¶åå†æŠŠè¿™å—å†…å­˜åˆ†å‰²æˆæ›´å°çš„å—ï¼Œä»¥æ–¹ä¾¿ç¨‹åºå‘˜ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥æå‡åˆ†é…çš„æ•ˆç‡ã€‚</p><p>åœ¨Cè¯­è¨€çš„è¿è¡Œæ—¶åº“é‡Œï¼Œè¿™ä¸ªå·¥ä½œæ˜¯ç”±mallocå‡½æ•°è´Ÿè´£çš„ã€‚ä½†æœ‰æ—¶å€™Cè¯­è¨€çš„åŸç”Ÿmallocå®ç°è¿˜æ˜¯ä¸èƒ½æ»¡è¶³ç‰¹å®šåº”ç”¨çš„æ€§èƒ½è¦æ±‚ï¼Œè¿™å°±éœ€è¦ç¨‹åºå‘˜æ¥å®ç°ç¬¦åˆè‡ªå·±åº”ç”¨è¦æ±‚çš„å†…å­˜æ± ï¼Œä»¥ä¾¿è‡ªå·±è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥å­¦ä¹ ï¼Œå¦‚ä½•å¯¹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç”³è¯·æ¥çš„å¤§å—å†…å­˜è¿›è¡Œæ›´ç²¾ç»†åŒ–çš„ç®¡ç†ã€‚é€šè¿‡è¿™èŠ‚è¯¾çš„å­¦ä¹ ï¼Œä½ å°†äº†è§£åˆ°å †å†…å­˜ç®¡ç†çš„å¸¸ç”¨æ–¹æ³•ï¼Œä»¥åŠå†…å­˜æ³„éœ²ã€double freeç­‰å¸¸è§çš„å†…å­˜é—®é¢˜äº§ç”Ÿçš„åŸå› å’Œæ’æŸ¥æ–¹æ³•ï¼Œä»è€Œæé«˜è‡ªå·±åˆ†æå’Œè§£å†³å†…å­˜é—®é¢˜çš„èƒ½åŠ›ã€‚</p><!-- [[[read_end]]] --><h2>mallocçš„åŸºæœ¬åŠŸèƒ½</h2><p>æ­£å¦‚è¿™èŠ‚è¯¾å¼€å¤´è®²çš„ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·æ¥çš„å¤§å—å†…å­˜ï¼Œéœ€è¦åˆ†å‰²æˆåˆé€‚çš„å¤§å°ï¼Œæ‰èƒ½è®©ç¨‹åºå‘˜æ­£å¸¸ä½¿ç”¨ï¼Œå…¶å®è¿™ä¸ªä»»åŠ¡æ˜¯ç”±glibcæ‰¿æ‹…çš„ã€‚</p><p>glibcæ˜¯Cè¯­è¨€çš„è¿è¡Œæ—¶åº“ï¼ŒCè¯­è¨€ä¸­å¸¸ç”¨çš„å‡½æ•°ï¼Œä¾‹å¦‚printfã€scanfã€memcpyå’Œstrcatç­‰ç­‰ï¼Œå®ƒä»¬çš„å®ç°éƒ½åœ¨glibc.soä¸­ã€‚é€šè¿‡åç¼€åï¼Œä½ å¯èƒ½ä¹ŸçŒœåˆ°äº†ï¼Œglibcæ˜¯ä¸€ç§åŠ¨æ€é“¾æ¥åº“ï¼Œå®ƒçš„å·¥ä½œåŸç†ä¸<a href=\"https://time.geekbang.org/column/article/437653\">ç¬¬7èŠ‚è¯¾</a>å’Œ<a href=\"https://time.geekbang.org/column/article/440471\">ç¬¬8èŠ‚è¯¾</a>é‡Œæ‰€è®²çš„åŠ¨æ€é“¾æ¥åº“æ˜¯ä¸€æ ·çš„ï¼Œä¸æ™®é€šçš„åŠ¨æ€åº“ç›¸æ¯”ï¼Œå®ƒå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ã€‚</p><p>æˆ‘ä»¬ä»Šå¤©è¦è®²çš„å°±æ˜¯glibcä¸­ç”¨äºå†…å­˜ç®¡ç†çš„ä¸¤ä¸ªé‡è¦å‡½æ•°ï¼šmallocå’Œfreeã€‚æˆ‘ä»¬å…ˆå±•ç¤ºä¸€ä¸‹mallocå’Œfreeçš„ç”¨æ³•ï¼Œè¯·çœ‹ä¸‹é¢è¿™æ®µCä»£ç ï¼š</p><pre><code>#include &lt;stdio.h&gt;\n#include &lt;malloc.h&gt;\n\nint main() {\n\tvoid *p = malloc(16)ï¼›\n\tprintf(&quot;%p\\n&quot;, p);\n\tfree(p);\n\treturn 0;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­åº”ç”¨ç¨‹åºé€šè¿‡mallocå‡½æ•°ç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œå¹¶æŠŠè¿™å—å†…å­˜çš„èµ·å§‹åœ°å€æ‰“å°äº†å‡ºæ¥ï¼Œç„¶åå†é€šè¿‡freeå‡½æ•°é‡Šæ”¾è¿™å—å†…å­˜ã€‚é€šè¿‡<a href=\"https://time.geekbang.org/column/article/430073\">ç¬¬1èŠ‚è¯¾</a>å’Œ<a href=\"https://time.geekbang.org/column/article/431904\">ç¬¬3èŠ‚è¯¾</a>çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œæ‰“å°çš„ç»“æœå®é™…ä¸Šæ˜¯ç”³è¯·çš„å†…å­˜å—çš„çº¿æ€§åœ°å€ã€‚æ›´å…·ä½“ä¸€ç‚¹ï¼Œè¿™å—ç©ºé—´ä½äºå †ä¸­ã€‚</p><p>malloc å®ç°çš„åŸºæœ¬åŸç†æ˜¯å…ˆå‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å—æ¯”è¾ƒå¤§çš„å†…å­˜ï¼Œç„¶åå†é€šè¿‡å„ç§ä¼˜åŒ–æ‰‹æ®µè®©å†…å­˜åˆ†é…çš„æ•ˆç‡æœ€å¤§åŒ–ã€‚åœ¨glibcçš„å®ç°é‡Œï¼Œmallocå‡½æ•°åœ¨å‘æ“ä½œç³»ç»Ÿç”³è¯·å †å†…å­˜æ—¶ï¼Œä¼šä½¿ç”¨mmapï¼Œä»¥4Kçš„æ•´æ•°å€ä¸€æ¬¡ç”³è¯·å¤šä¸ªé¡µã€‚è¿™æ ·çš„è¯ï¼Œmmapçš„åŒºåŸŸå°±ä¼šä»¥é¡µå¯¹é½ï¼Œé¡µä¸é¡µä¹‹é—´çš„æ’åˆ—éå¸¸æ•´é½ï¼Œé¿å…äº†å‡ºç°å†…å­˜ç¢ç‰‡ã€‚</p><p>ä»è¿™ä¸ªè§’åº¦çœ‹ï¼Œglibc ä¸­çš„ malloc æ–¹æ³•éå¸¸åƒæ‰¹å‘å•†ï¼Œå®ƒä»ä¾›åº”å•†æ“ä½œç³»ç»Ÿé‚£é‡Œä¸€æ¬¡æ‰¹å‘äº†å¾ˆå¤§çš„å†…å­˜ï¼Œç„¶åä»¥é›¶é”€çš„æ–¹å¼ä¸€ç‚¹ç‚¹åˆ†é…å‡ºå»ï¼Œè€Œä¸”å®ƒä¸å…‰è´Ÿè´£é”€å”®ï¼Œè¿˜è´Ÿè´£å”®åï¼ˆåˆ†é…åˆ°çš„å†…å­˜å¯ä»¥ä½¿ç”¨ free é€€è´§ï¼‰ã€‚</p><p>è¦æƒ³åˆå¥½åˆå¿«åœ°æ­£ç¡®ä½¿ç”¨å †å†…å­˜ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„æ–¹å¼å°±æ˜¯å¯¹å†…å­˜åšç²¾ç»†åŒ–ç®¡ç†ã€‚</p><h2>mallocçš„å®ç°åŸç†</h2><p>å†…å­˜çš„ç²¾ç»†åŒ–ç®¡ç†ï¼Œæˆ‘ä»¬è¦è€ƒè™‘ä¸¤ä¸ªå› ç´ ï¼Œ<strong>ä¸€æ˜¯åˆ†é…å’Œå›æ”¶çš„æ•ˆç‡ï¼ŒäºŒæ˜¯å†…å­˜åŒºåŸŸçš„æœ‰æ•ˆåˆ©ç”¨ç‡</strong>ï¼Œå†…å­˜åŒºåŸŸçš„æœ‰æ•ˆåˆ©ç”¨ç‡åˆåŒ…å«ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ–¹é¢æ˜¯æ¯ä¸€å°å—å†…å­˜å†…éƒ¨æ˜¯å¦è¢«åˆç†åˆ©ç”¨ï¼Œå¦ä¸€ä¸ªæ–¹é¢æ˜¯å—ä¸å—ä¹‹é—´æ˜¯å¦å­˜åœ¨æ— æ³•åˆ©ç”¨çš„å°å—å†…å­˜ã€‚</p><p>ä½ å¯ä»¥ç”¨å»ºç­‘è§„åˆ’æ¥è¿›è¡Œç±»æ¯”ã€‚æˆ‘ä»¬æœ‰ä¸€å—å¾ˆå¹³æ•´çš„åœ°ï¼Œå¦‚æœä¸€ä¸ªå»ºç­‘è®¾è®¡å¾—ä¸åˆç†ï¼Œæ¯”å¦‚æœ¬æ¥åªæœ‰ä¸€åƒä¸ªå­¦ç”Ÿï¼Œä½†å´ä¿®äº†ä¸€ä¸ªäº”åƒäººçš„ä½“è‚²åœºï¼Œè¿™å°±æ˜¯å†…éƒ¨ç©ºé—´çš„æµªè´¹ã€‚å¦‚æœå„ä¸ªå»ºç­‘éƒ½æ˜¯å¥‡å½¢æ€ªçŠ¶çš„ï¼ˆä¸èƒ½å¯¹é½ï¼‰ï¼Œé‚£ä¹ˆå»ºç­‘ä¸å»ºç­‘ä¹‹é—´çš„ä¸å¯ç”¨çš„åœ°å—å°±ä¼šå¢å¤šï¼Œè¿™å°±æ˜¯å¤–éƒ¨ç©ºé—´çš„æµªè´¹ï¼Œæˆ–è€…ç§°ä¸ºç¢ç‰‡ã€‚</p><p>å¯¹å°å—å†…å­˜è¿›è¡Œç²¾ç»†åŒ–ç®¡ç†ï¼Œæœ€å¸¸ç”¨çš„æ•°æ®ç»“æ„å°±æ˜¯é“¾è¡¨ã€‚ä¸ºäº†èƒ½å¤Ÿæ–¹ä¾¿åœ°è¿›è¡Œåˆ†é…å’Œå›æ”¶ï¼Œäººä»¬æŠŠç©ºé—²åŒºåŸŸè®°å½•åˆ°é“¾è¡¨é‡Œï¼Œè¿™å°±æ˜¯ç©ºé—²é“¾è¡¨(free list)ã€‚</p><h3>ç©ºé—²é“¾è¡¨</h3><p>ç©ºé—²é“¾è¡¨é‡Œçš„èŠ‚ç‚¹ä¸»è¦æ˜¯ä¸ºäº†è®°å½•å†…å­˜çš„å¼€å§‹ä½ç½®å’Œé•¿åº¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/f4/e1/f43468e79fd311ca81d3e181d8575ae1.jpg?wh=2284x1147\" alt=\"\"></p><p>å›¾ä¸­å±•ç¤ºäº†ä¸€ä¸ªæ€»é•¿åº¦ä¸º100çš„å†…å­˜åŒºåŸŸï¼Œå·²ç»åˆ†å‰²æˆ16ã€16ã€20ã€16ã€16ã€16å…­ä¸ªå°çš„å†…å­˜å—ã€‚å…¶ä¸­ç€è‰²éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ã€ç¬¬ä¸‰å’Œç¬¬äº”å—å†…å­˜æ˜¯å·²ç»åˆ†é…å‡ºå»çš„ï¼Œæ­£åœ¨ä½¿ç”¨çš„å†…å­˜ï¼Œè€Œç™½è‰²åŒºåŸŸåˆ™æ˜¯å°šæœªåˆ†é…çš„å†…å­˜ã€‚å›¾çš„ä¸ŠåŠéƒ¨åˆ†ä»£è¡¨ç©ºé—²é“¾è¡¨ï¼Œæ¯ä¸€å—æœªåˆ†é…çš„å†…å­˜éƒ½ä¼šç”±ä¸€ä¸ªç©ºé—²é“¾è¡¨çš„èŠ‚ç‚¹è¿›è¡Œç®¡ç†ã€‚ç»“ç‚¹ä¸­è®°å½•äº†è¿™å—ç©ºé—²å†…å­˜åŒºåŸŸçš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ã€‚</p><p>å½“åˆ†é…å†…å­˜çš„è¯·æ±‚åˆ°è¾¾ä»¥åï¼Œæˆ‘ä»¬å°±é€šè¿‡éå†free listæ¥æŸ¥æ‰¾å¯ç”¨çš„ç©ºé—²å†…å­˜åŒºåŸŸï¼Œåœ¨æ‰¾åˆ°åˆé€‚çš„ç©ºé—²åŒºåŸŸä»¥åï¼Œå°±å°†è¿™ä¸€å—åŒºåŸŸä»é“¾è¡¨ä¸­æ‘˜ä¸‹æ¥ã€‚æ¯”å¦‚è¦è¯·æ±‚çš„å¤§å°æ˜¯mï¼Œå°±å°†è¿™ä¸ªç»“ç‚¹ä»é“¾è¡¨ä¸­å–ä¸‹ï¼ŒæŠŠèµ·å§‹ä½ç½®å‘åç§»åŠ¨mï¼Œå¤§å°ä¹Ÿç›¸åº”çš„å‡å°mã€‚å°†ä¿®æ”¹åçš„ç»“ç‚¹é‡æ–°æŒ‚åˆ°é“¾è¡¨ä¸Šã€‚</p><p>åœ¨é‡Šæ”¾çš„æ—¶å€™ï¼Œå°†è¿™å—åŒºåŸŸæŒ‰ç…§èµ·å§‹èµ·å€çš„æ’åºæ”¾å›åˆ°é“¾è¡¨é‡Œï¼Œå¹¶ä¸”æ£€æŸ¥å®ƒçš„å‰åæ˜¯å¦æœ‰ç©ºé—²åŒºåŸŸï¼Œå¦‚æœæœ‰å°±åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„ç©ºé—²åŒºã€‚</p><p>è¿™ç§ç®—æ³•æ‰€ä½¿ç”¨çš„æ•°æ®ç»“æ„æ¯”è¾ƒç®€å•ï¼Œç®—æ³•ä¹Ÿå¾ˆç›´æ¥ï¼Œæˆ‘ä»¬æŠŠè¿™ç§ç®—æ³•ç§°ä¸ºç®€å•ç®—æ³•(Naive Algorithm)ã€‚æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­è¯´æ˜ç®€å•ç®—æ³•çš„è¿è¡Œè¿‡ç¨‹ï¼Œå‡å¦‚åœ¨ç®—æ³•å¼€å§‹æ—¶ï¼Œå†…å­˜çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/61/46/61ec3206f7369287939dbdae24804f46.jpg?wh=2284x1160\" alt=\"\"></p><p>å‡è®¾å¯¹å†…å­˜çš„æ“ä½œåºåˆ—æ˜¯è¿™æ ·çš„ï¼š</p><pre><code>void test() {\n\tvoid* p1 = malloc(16);\n\tvoid* p2 = malloc(16);\n\tvoid* p3 = malloc(20);\n\n\tfree(p2);\n\n\tvoid* p4 = malloc(16);\n\tvoid* p5 = malloc(16);\n\n\tfree(p4);\n}\n</code></pre><p>æ‰§è¡Œå®Œtestå‡½æ•°ä»¥åï¼Œå†…å­˜çš„åˆ’åˆ†å°±ä¼šå’Œè¿™èŠ‚è¯¾çš„ç¬¬ä¸€å¹…å›¾ä¸€æ ·äº†ã€‚åšä¸ºç»ƒä¹ ï¼Œè¯·ä½ è‡ªå·±ç”»å‡ºæ¯ä¸€ä¸ªæ­¥éª¤free listå’Œå†…å­˜çš„å˜åŒ–æƒ…å†µï¼Œè¿™é‡Œä¸å†ç»™å‡ºã€‚</p><p>å¦‚æœæ­¤æ—¶ï¼Œåˆåˆ°è¾¾äº†ä¸€ä¸ªå†…å­˜åˆ†é…è¯·æ±‚ï¼Œè¦ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º20çš„å†…å­˜åŒºåŸŸï¼Œè™½ç„¶æ‰€æœ‰ç©ºé—²åŒºåŸŸçš„å¤§å°ä¹‹å’Œæ˜¯48ï¼Œæ˜¯è¶…è¿‡20çš„ï¼Œä½†æ˜¯ç”±äºè¿™ä¸‰å—ç©ºé—²åŒºåŸŸå¹¶ä¸è¿ç»­ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å·²ç»æ— æ³•ä»è¿™100å­—èŠ‚çš„å†…å­˜ä¸­å†åˆ†é…å‡ºä¸€å—20å­—èŠ‚çš„å†…å­˜åŒºåŸŸäº†ï¼Œç›¸å¯¹äºè¿™æ¬¡è¯·æ±‚ï¼Œè¿™ä¸‰å—16å­—èŠ‚çš„ç©ºé—²åŒºåŸŸå°±æ˜¯<strong>å†…å­˜ç¢ç‰‡</strong>ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ‰€ä»‹ç»çš„ç®€å•ç®—æ³•çš„ç¬¬ä¸€ä¸ªç¼ºé™·ï¼š<strong>ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</strong>ã€‚</p><p>æ¯ä¸€æ¬¡åˆ†é…å†…å­˜æ—¶ï¼Œæˆ‘ä»¬éƒ½éœ€è¦éå†free listï¼Œæœ€å·®æƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦æ˜¾ç„¶æ˜¯O(n)ã€‚å¦‚æœæ˜¯å¤šçº¿ç¨‹åŒæ—¶åˆ†é…çš„è¯ï¼Œfree listä¼šè¢«å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œä¸ºäº†ä¿æŠ¤å®ƒï¼Œå°±å¿…é¡»ä½¿ç”¨å„ç§åŒæ­¥æœºåˆ¶ï¼Œæ¯”å¦‚é”æˆ–è€…æ— é”çš„concurrent linked listç­‰ã€‚å¯è§ä¸Šè¿°ç®—æ³•çš„ç¬¬äºŒä¸ªç¼ºé™·æ˜¯<strong>åˆ†é…æ•ˆç‡ä¸€èˆ¬ï¼Œä¸”å¤šçº¿ç¨‹å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½è¿˜ä¼šæ¶åŒ–</strong>ã€‚</p><p>ä¸ºäº†æ”¹è¿›ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ï¼Œäººä»¬æƒ³äº†å¾ˆå¤šåŠæ³•ï¼Œæˆ‘ä»¬ä¸¾å‡ ä¸ªå†å²ä¸Šæ›¾ç»å‡ºç°çš„æ”¹è¿›æ–¹æ¡ˆã€‚</p><p>å…¶ä¸­ä¸€ç§æ–¹æ¡ˆæ˜¯ç›´æ¥å¯¹ç®€å•ç®—æ³•è¿›è¡Œä¼˜åŒ–ã€‚ç®€å•ç®—æ³•ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„åŒºåŸŸå°±è¿”å›ï¼Œè¿™ä¸ªç­–ç•¥è¢«ç§°ä¸º First Fitï¼Œä¼˜åŒ–çš„å…·ä½“åšæ³•æ˜¯æŠŠå®ƒæ”¹æˆæœ€ä½³åŒ¹é…(Best Fit)ï¼Œæ”¹é€ åï¼Œå®ƒè¦æ‰¾åˆ°èƒ½æ»¡è¶³æ¡ä»¶çš„æœ€å°çš„ç©ºé—²åŒºåŸŸæ‰è¿”å›ã€‚</p><p>ä»ç›´è§‚ä¸Šè¯´ï¼Œè¿™ç§åˆ†é…ç­–ç•¥èƒ½å°½å¯èƒ½åœ°ä¿ç•™å¤§å—å†…å­˜ï¼Œé¿å…å®ƒè¢«å¿«é€Ÿåœ°åˆ†å‰²æˆå°å—å†…å­˜ï¼Œè¿™å°±èƒ½æ›´å¥½åœ°å¯¹æŠ—å†…å­˜ç¢ç‰‡ã€‚ä¸¥æ ¼çš„ç†è®ºè¯æ˜ä¹Ÿè¯æ˜äº†è¿™ä¸€ç‚¹ã€‚ä½†æ˜¯è¿™ç§ç­–ç•¥éœ€è¦éå†æ•´ä¸ªé“¾è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦åè€Œå˜å·®ã€‚</p><p>å¦ä¸€ç§æ–¹æ¡ˆæ˜¯Knuthæå‡ºçš„Next Fitç­–ç•¥ï¼Œå³æ¯æ¬¡æŸ¥æ‰¾ä¸å¿…ä»å¤´å¼€å§‹ï¼Œè€Œæ˜¯ä»ä¸Šä¸€æ¬¡æŸ¥æ‰¾çš„ä½ç½®ç»§ç»­å‘åæŸ¥æ‰¾ã€‚å®éªŒä¹Ÿè¯æ˜ï¼Œè¿™ç§ç­–ç•¥ä¼šæ¯”ä»å¤´å¼€å§‹çš„ç®—æ³•æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚ä½†å®ƒä¾ç„¶ä¸èƒ½è§£å†³å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚</p><p>è¿˜æœ‰ä¸€ç§æ”¹è¿›æ–¹æ¡ˆï¼Œåå­—å«åˆ†æ¡¶å¼ç®¡ç†ï¼Œ<strong>è¿™ç§æ”¹è¿›æ˜¯ä¸€ç§ç›¸å¯¹å‡è¡¡çš„åšæ³•ï¼Œåœ¨å¯¹æŠ—å†…å­˜ç¢ç‰‡å’Œåˆ†é…é‡Šæ”¾çš„æ—¶é—´å¤æ‚åº¦ä¸¤ä¸ªæ–¹å‘éƒ½æœ‰æ”¹å–„</strong>ã€‚è¿™ä¹Ÿæ˜¯åœ¨ç°å®ä¸­è¢«ä½¿ç”¨çš„æœ€å¹¿æ³›çš„ä¸€ç§æ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é‡ç‚¹åˆ†æåˆ†æ¡¶å¼ç®¡ç†ç®—æ³•ã€‚</p><h3>åˆ†æ¡¶å¼å†…å­˜ç®¡ç†</h3><p>åˆ†æ¡¶å¼å†…å­˜ç®¡ç†é‡‡ç”¨äº†å¤šä¸ªé“¾è¡¨ï¼Œå¯¹äºå•ä¸ªé“¾è¡¨ï¼Œå®ƒå†…éƒ¨çš„æ‰€æœ‰ç»“ç‚¹æ‰€å¯¹åº”çš„å†…å­˜åŒºåŸŸçš„å¤§å°æ˜¯ç›¸åŒçš„ã€‚æ¢å¥è¯è¯´ï¼Œç›¸åŒå¤§å°çš„åŒºåŸŸä¼šæŒ‚è½½åˆ°åŒä¸€ä¸ªé“¾è¡¨ä¸Šã€‚</p><p>æœ€å¸¸è§çš„æ–¹å¼æ˜¯ä»¥4å­—èŠ‚ä¸ºæœ€å°å•ä½ï¼ŒæŠŠæ‰€æœ‰4å­—èŠ‚çš„åŒºåŸŸæŒ‚åˆ°åŒä¸€ä¸ªé“¾è¡¨ä¸Šï¼Œå†æŠŠ8å­—èŠ‚çš„åŒºåŸŸæŒ‚åˆ°ä¸€èµ·ï¼Œç„¶åæ˜¯16å­—èŠ‚ï¼Œ32å­—èŠ‚ï¼Œè¿™æ ·ä»¥2æ¬¡å¹‚å‘ä¸Šå¢é•¿ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/c2/cd9deb75706b6e5267e8f7f308c205c2.jpg?wh=2284x1222\" alt=\"\"></p><p>é‡‡ç”¨äº†æ–°çš„æ•°æ®ç»“æ„ä»¥åï¼Œåˆ†é…å’Œå›æ”¶çš„ç®—æ³•ä¹Ÿç›¸åº”åœ°å‘ç”Ÿäº†å˜åŒ–ã€‚</p><p>é¦–å…ˆï¼Œåˆ†é…çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦åªè¦æ‰¾åˆ°èƒ½æ»¡è¶³è¿™ä¸€æ¬¡åˆ†é…è¯·æ±‚çš„æœ€å°åŒºåŸŸï¼Œç„¶åå»ç›¸åº”çš„é“¾è¡¨é‡ŒæŠŠæ•´å—åŒºåŸŸéƒ½å–ä¸‹æ¥ã€‚æ¯”å¦‚ï¼Œåˆ†é…ä¸€ä¸ª7å­—èŠ‚çš„å†…å­˜å—æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»8å­—èŠ‚å¤§å°çš„ç©ºé—²é“¾è¡¨é‡Œç›´æ¥å–å‡ºé“¾è¡¨å¤´ä¸Šçš„é‚£å—åŒºåŸŸï¼Œåˆ†é…ç»™åº”ç”¨ç¨‹åºã€‚ç”±äºä»é“¾è¡¨å¤´ä¸Šåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†é…å†…å­˜çš„æ•ˆç‡å°±å¤§å¤§æé«˜äº†ã€‚</p><p>ç”±äºæ•´ä¸ªå¤§å—å†…å­˜è¢«æå‰åˆ†å‰²æˆäº†æ•´é½çš„å°å—ï¼ˆæ¯”å¦‚æ˜¯ä»¥4å­—èŠ‚å¯¹é½ï¼‰ï¼Œæ‰€ä»¥æ•´ä¸ªåŒºåŸŸé‡Œä¸å­˜åœ¨å—ä¸å—ä¹‹é—´å†…å­˜ç¢ç‰‡ã€‚ä½†æ˜¯è¿™ç§åšæ³•è¿˜æ˜¯ä¼šäº§ç”ŸåŒºåŸŸå†…éƒ¨çš„ç©ºé—´æµªè´¹ï¼Œæ¯”å¦‚ä¸Šé¢ä¸¾çš„ä¾‹å­ï¼Œå½“ç”³è¯·çš„å†…å­˜å¤§å°æ˜¯7æ—¶ï¼ŒæŒ‰å½“å‰ç®—æ³•ï¼Œåªèƒ½åˆ†é…ç»™å®ƒå¤§å°ä¸º8çš„å—ï¼Œè¿™å°±é€ æˆäº†ä¸€ä¸ªå­—èŠ‚çš„å†…éƒ¨æµªè´¹ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºå†…éƒ¨ç¢ç‰‡ã€‚</p><p>å†…éƒ¨ç¢ç‰‡å¸¦æ¥çš„é—®é¢˜æ˜¯å†…å­˜ä½¿ç”¨ç‡æ²¡æœ‰è¾¾åˆ°100%ï¼Œåœ¨æœ€å·®æƒ…å†µä¸‹ï¼Œå¯èƒ½åªæœ‰50%ã€‚ä½†æ˜¯å†…éƒ¨ç¢ç‰‡éšç€è¿™ä¸€å—åŒºåŸŸçš„é‡Šæ”¾ä¹Ÿå°±æ¶ˆå¤±äº†ï¼Œæ‰€ä»¥ä¸ä¼šå› ä¸ºé•¿æ—¶é—´è¿è¡Œè€Œç§¯ç´¯æˆä¸¥é‡çš„é—®é¢˜ã€‚</p><p>é‡Šæ”¾æ—¶ï¼Œåªéœ€è¦æŠŠè¦é‡Šæ”¾çš„å†…å­˜ç›´æ¥æŒ‚è½½åˆ°ç›¸åº”çš„é“¾è¡¨é‡Œå°±å¯ä»¥äº†ã€‚ è¿™ä¸ªé€Ÿåº¦å’Œåˆ†é…æ˜¯ä¸€æ ·çš„ï¼Œæ•ˆç‡éå¸¸é«˜ã€‚</p><p><strong>åˆ†æ¡¶å¼å†…å­˜ç®¡ç†æ¯”ç®€å•ç®—æ³•æ— è®ºæ˜¯åœ¨ç®—æ³•æ•ˆç‡æ–¹é¢ï¼Œè¿˜æ˜¯åœ¨ç¢ç‰‡æ§åˆ¶æ–¹é¢éƒ½æœ‰å¾ˆå¤§çš„æå‡</strong>ã€‚ä½†å®ƒçš„ç¼ºé™·ä¹Ÿå¾ˆæ˜æ˜¾ï¼šåŒºåŸŸå†…éƒ¨çš„ä½¿ç”¨ç‡ä¸å¤Ÿé«˜å’ŒåŠ¨æ€æ‰©å±•èƒ½åŠ›ä¸å¤Ÿå¥½ã€‚ä¾‹å¦‚ï¼Œ4å­—èŠ‚çš„åŒºåŸŸæå‰æ¶ˆè€—å®Œäº†ï¼Œä½†8å­—èŠ‚çš„ç©ºé—²åŒºåŸŸè¿˜æœ‰å¾ˆå¤šï¼Œæ­¤æ—¶å°±ä¼šé¢ä¸´ä¸¤éš¾é€‰æ‹©ï¼Œå¦‚æœç›´æ¥åˆ†é…8å­—èŠ‚çš„åŒºåŸŸï¼Œåˆ™åŒºåŸŸå†…éƒ¨æµªè´¹å°±æ¯”è¾ƒå¤šï¼Œå¦‚æœä¸åˆ†é…ï¼Œåˆ™æ˜æ˜è¿˜æœ‰ç©ºé—²åŒºåŸŸï¼Œå´æ— æ³•æˆåŠŸåˆ†é…ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ï¼Œäººä»¬åœ¨åˆ†æ¡¶çš„åŸºç¡€ä¸Šç»§ç»­æ”¹è¿›ï¼Œè®©å†…å­˜å¯ä»¥æ ¹æ®éœ€æ±‚åŠ¨æ€åœ°å†³å®šå°çš„å†…å­˜åŒºåŸŸå’Œå¤§çš„å†…å­˜åŒºåŸŸçš„æ¯”ä¾‹ã€‚è¿™ç§è®¾è®¡çš„å…¸å‹å°±æ˜¯ä¼™ä¼´ç³»ç»Ÿï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ã€‚</p><h3>ä¼™ä¼´ç³»ç»Ÿ</h3><p>æ­£å¦‚ä¸Šé¢çš„ä¾‹å­æ‰€è®²çš„ï¼Œå½“ç³»ç»Ÿä¸­è¿˜æœ‰å¾ˆå¤š8å­—èŠ‚çš„ç©ºé—²å—ï¼Œè€Œ4å­—èŠ‚çš„ç©ºé—²å—å´å·²ç»è€—å°½ï¼Œè¿™æ—¶å†æœ‰ä¸€ä¸ª4å­—èŠ‚çš„è¯·æ±‚ï¼Œåˆ™ä¼šå‡ºç°mallocå¤±è´¥çš„æƒ…å†µã€‚ä¸ºäº†é¿å…åˆ†é…å¤±è´¥ï¼Œæˆ‘ä»¬å…¶å®è¿˜å¯ä»¥è€ƒè™‘å°†å¤§å—çš„å†…å­˜åšä¸€æ¬¡æ‹†åˆ†ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚åˆ†é…ä¸€å—4å­—èŠ‚å¤§å°çš„ç©ºé—´ï¼Œåœ¨4å­—èŠ‚çš„free listä¸Šæ‰¾ä¸åˆ°ç©ºé—²åŒºåŸŸï¼Œç³»ç»Ÿå°±ä¼šå¾€ä¸Šæ‰¾ï¼Œå‡å¦‚8å­—èŠ‚å’Œ16å­—èŠ‚çš„free listä¸­ä¹Ÿæ²¡æœ‰ç©ºé—²åŒºåŸŸï¼Œå°±ä¼šä¸€ç›´å‘ä¸Šæ‰¾åˆ°32å­—èŠ‚çš„free listã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6f/26/6f9ef8402a8c0d1c9fdb61a3b4d24f26.jpg?wh=2284x1321\" alt=\"\"></p><p>ä¼™ä¼´ç³»ç»Ÿä¸ä¼šç›´æ¥æŠŠ32çš„ç©ºé—²åŒºåŸŸåˆ†é…å‡ºå»ï¼Œå› ä¸ºè¿™æ ·åšçš„è¯ï¼Œä¼šå¸¦æ¥å·¨å¤§çš„æµªè´¹ã€‚å®ƒä¼šå…ˆæŠŠ32å­—èŠ‚åˆ†æˆä¸¤ä¸ª16å­—èŠ‚ï¼ŒæŠŠåè¾¹ä¸€ä¸ªæŒ‚å…¥åˆ°16å­—èŠ‚çš„free list ä¸­ã€‚ç„¶åç»§ç»­æ‹†åˆ†å‰ä¸€åŠã€‚å‰ä¸€åŠç»§ç»­æ‹†æˆä¸¤ä¸ª8å­—èŠ‚ï¼Œå†æŠŠåä¸€åŠæŒ‚å…¥åˆ°8å­—èŠ‚çš„ free listï¼Œæœ€åï¼ŒæŠŠå‰ä¸€åŠ8å­—èŠ‚æ‹¿å»åˆ†é…ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿè¦ç»§ç»­æ‹†åˆ†æˆä¸¤ä¸ª4å­—èŠ‚çš„ç©ºé—²åŒºåŸŸï¼Œå…¶ä¸­ä¸€ä¸ªç”¨äºæœ¬æ¬¡mallocåˆ†é…ï¼Œå¦ä¸€ä¸ªåˆ™æŒ‚å…¥åˆ°4å­—èŠ‚çš„free listã€‚åˆ†é…åçš„å†…å­˜çš„çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/68/fb/68e667bdf6yy507f21e0f2b775cd7dfb.jpg?wh=2284x1273\" alt=\"\"></p><p><strong>è¿™ç§ä¸æ–­åœ°æŠŠä¸€å—å†…å­˜åˆ†å‰²æˆæ›´å°çš„ä¸¤å—å†…å­˜çš„åšæ³•ï¼Œå°±æ˜¯ä¼™ä¼´ç³»ç»Ÿï¼Œè¿™ä¸¤å—æ›´å°çš„å†…å­˜å°±æ˜¯ä¼™ä¼´</strong>ã€‚ å®ƒçš„å¥½å¤„æ˜¯å¯ä»¥åŠ¨æ€åœ°æ ¹æ®åˆ†é…è¯·æ±‚å°†å¤§çš„å†…å­˜åˆ†å‰²æˆå°çš„å†…å­˜ã€‚å½“é‡Šæ”¾å†…å­˜æ—¶ï¼Œå¦‚æœç³»ç»Ÿå‘ç°ä¸è¢«é‡Šæ”¾çš„å†…å­˜ç›¸é‚»çš„é‚£ä¸ªä¼™ä¼´ä¹Ÿæ˜¯ç©ºé—²çš„ï¼Œå°±ä¼šæŠŠå®ƒä»¬åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„è¿ç»­å†…å­˜ã€‚é€šè¿‡è¿™ç§æ‹†åˆ†ï¼Œç³»ç»Ÿå°±å˜å¾—æ›´åŠ å¯Œæœ‰å¼¹æ€§ã€‚</p><p>mallocçš„å®ç°ï¼Œåœ¨å†å²ä¸Šå…ˆåå…±æœ‰å‡ åç§ç­–ç•¥ï¼Œè¿™äº›ç­–ç•¥å¾€å¾€å°±æ˜¯ä¸Šè¿°ä¸‰ç§ç®—æ³•çš„ç»„åˆã€‚å…·ä½“åˆ°glibcä¸­çš„mallocå®ç°ï¼Œå®ƒå°±é‡‡ç”¨äº†åˆ†æ¡¶çš„ç­–ç•¥ï¼Œä½†æ˜¯å®ƒçš„æ¯ä¸ªæ¡¶é‡Œçš„å†…å­˜ä¸æ˜¯å›ºå®šå¤§å°çš„ï¼Œè€Œæ˜¯é‡‡ç”¨äº†å°†1 ~ 4å­—èŠ‚çš„å—æŒ‚åˆ°ç¬¬ä¸€ä¸ªé“¾è¡¨é‡Œï¼Œå°†5 ~ 8å­—èŠ‚çš„å—æŒ‚åˆ°ç¬¬äºŒä¸ªé“¾è¡¨é‡Œï¼Œå°†9~16å­—èŠ‚çš„å—æŒ‚åˆ°ç¬¬ä¸‰ä¸ªé“¾è¡¨é‡Œï¼Œä¾æ¬¡ç±»æ¨ã€‚</p><p>åœ¨å•ä¸ªé“¾è¡¨å†…éƒ¨åˆ™é‡‡ç”¨naiveçš„åˆ†é…æ–¹å¼ï¼Œæ¯”å¦‚è¦åˆ†é…5ä¸ªå­—èŠ‚çš„å†…å­˜å—ï¼Œæˆ‘ä»¬ä¼šå…ˆåœ¨5 ~ 8è¿™ä¸ªé“¾è¡¨é‡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°çš„å†…å­˜å¤§å°æ˜¯8å­—èŠ‚çš„ï¼Œé‚£å°±ä¼šå°†è¿™ä¸ªåŒºåŸŸåˆ†å‰²æˆ5å­—èŠ‚å’Œ3å­—èŠ‚ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­5å­—èŠ‚ç”¨äºåˆ†é…ï¼Œå‰©ä½™çš„3å­—èŠ‚çš„ç©ºé—²åŒºåŸŸåˆ™ä¼šæŒ‚è½½åˆ°1~4è¿™ä¸ªé“¾è¡¨é‡Œã€‚</p><p>å¯è§mallocçš„å®ç°ç­–ç•¥æ˜¯æ¯”è¾ƒçµæ´»çš„ï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œä¸åŒçš„åˆ†é…ç­–ç•¥çš„æ€§èƒ½è¡¨ç°ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚å¾ˆå¤šå…¬å¸çš„åŸºç¡€å¹³å°éƒ½é€‰æ‹©è‡ªå·±å®ç°å†…å­˜æ± æ¥æä¾›mallocæ¥å£ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°æœåŠ¡æœ¬å…¬å¸çš„ä¸šåŠ¡ã€‚æœ€è‘—åçš„ä¾‹å­å°±æ˜¯Googleå…¬å¸å®ç°çš„Tcmallocåº“ã€‚</p><p>Tcmallocç›¸æ¯”èµ·å…¶ä»–çš„mallocå®ç°ï¼Œæœ€å¤§çš„æ”¹è¿›æ˜¯åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹æ€§èƒ½æå‡ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ<strong>åœ¨å¤šçº¿ç¨‹å¹¶å‘åœ°åˆ†é…å†…å­˜æ—¶ï¼Œæ¯æ¬¡åˆ†é…éƒ½è¦å¯¹free listè¿›è¡ŒåŠ é”ä»¥é¿å…å¹¶å‘ç¨‹åºå¸¦æ¥çš„é—®é¢˜ï¼Œè¿™å°±å®¹æ˜“å½¢æˆæ€§èƒ½ç“¶é¢ˆ</strong>ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTcmallocå¼•å…¥äº†çº¿ç¨‹æœ¬åœ°ç¼“å­˜(Thread Local Cache)ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨åˆ†é…å†…å­˜çš„æ—¶å€™éƒ½å…ˆåœ¨è‡ªå·±çš„æœ¬åœ°ç¼“å­˜ä¸­å¯»æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°å°±ç»“æŸï¼Œåªæœ‰æ‰¾ä¸åˆ°çš„æƒ…å†µæ‰ä¼šç»§ç»­å‘å…¨å±€ç®¡ç†å™¨ç”³è¯·ä¸€å—å¤§çš„ç©ºé—²åŒºåŸŸï¼Œç„¶åæŒ‰ç…§ä¼™ä¼´ç³»ç»Ÿçš„æ–¹å¼ç»§ç»­æ·»åŠ åˆ°æœ¬åœ°ç¼“å­˜ä¸­å»ã€‚</p><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°è¿™ä¸¤ä¸ªé—®é¢˜è€ŒæŸæ‰‹æ— ç­–ï¼š</p><ul>\n<li>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œç³»ç»Ÿæ‰€æä¾›çš„mallocï¼Œå…¶æ€§èƒ½ä¸è¶³ä»¥æ”¯æ’‘è‡ªå·±çš„ä¸šåŠ¡ï¼Œæˆ–è€…è‡ªå·±çš„ä¸šåŠ¡åœ¨åˆ†é…å†…å­˜æ—¶æœ‰å…¶ç‰¹æ®Šçš„è§„å¾‹ï¼Œéœ€è¦ä¸ºå®ƒåšä¸“é—¨çš„è®¢åˆ¶å’Œä¼˜åŒ–ï¼›</li>\n<li>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨mallocå’Œfreeé‡Œåšä¸€äº›ç»Ÿè®¡åŠ¨ä½œä»¥æ’æŸ¥é—®é¢˜ï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—ã€‚</li>\n</ul><p>ä¸‹é¢ï¼Œæˆ‘æ¥å¸¦ä½ è‡ªå·±åŠ¨æ‰‹å®ç°å†…å­˜ç®¡ç†åº“ï¼Œè®©ä½ æ›´å¥½è§£å†³å†…å­˜é—®é¢˜çš„åŒæ—¶ï¼Œè¿˜å¯ä»¥æ·±å…¥åœ°ç†è§£å†…å­˜ç®¡ç†çš„æ›´å¤šæŠ€æœ¯ç»†èŠ‚ã€‚</p><h2>è‡ªå·±åŠ¨æ‰‹å®ç°å†…å­˜ç®¡ç†åº“</h2><p>ç¬¬1ä¸ªé—®é¢˜çš„å…¸å‹ä»£è¡¨å°±æ˜¯ä¸Šé¢æ‰€æåˆ°çš„Tcmallocã€‚æˆ‘ä»¬è¿™é‡Œä¸¾ä¸€ä¸ªç¬¬äºŒä¸ªé—®é¢˜çš„ä¾‹å­ã€‚æ¯”å¦‚ï¼Œæˆ‘æ›¾ç»é‡åˆ°è¿‡ä¸€ä¸ªdouble freeçš„é”™è¯¯ï¼Œåœ¨ç”³è¯·äº†ä¸€æ®µå†…å­˜ä»¥åï¼Œç»è¿‡å¤æ‚çš„é€»è¾‘ï¼Œæœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘äº†åŒä¸€å—å†…å­˜ï¼Œå½“æˆ‘å¯¹ä¸¤ä¸ªæŒ‡é’ˆéƒ½è°ƒç”¨freeæ–¹æ³•çš„æ—¶å€™ï¼Œé”™è¯¯å°±å‘ç”Ÿäº†ï¼Œæˆ‘æŠŠè¿™ä¸ªé”™è¯¯ç¤ºä¾‹è¿›è¡Œäº†ç®€åŒ–ï¼Œå¹¶æŠŠå®ƒçš„ä»£ç æ”¾åœ¨ä¸‹é¢ï¼š</p><pre><code>#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n\nint main() {\n    int* p = (int*)malloc(sizeof(int));\n    char* q = (char*)p;\n\n    free(p);\n    free(q);\n}\n</code></pre><p>å¾ˆæ˜æ˜¾ï¼Œç¬¬8è¡Œç¬¬9è¡Œé‡Šæ”¾çš„æ˜¯åŒä¸€å—å†…å­˜ï¼Œè¿è¡Œè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿›ç¨‹ crashäº†ï¼Œå¹¶ä¸”ç³»ç»Ÿæç¤ºä¸ºï¼š</p><pre><code>*** Error in `./dfree': double free or corruption (fasttop): 0x000000000196a010 ***\nAborted\n</code></pre><p>è¿™å°±æ˜¯double freeçš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å—å†…å­˜è¢«é‡Šæ”¾äº†ä¸¤æ¬¡ã€‚è¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åœ¨å¤æ‚é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€å¾ˆéš¾åˆ¤æ–­å¤šä¸ªæŒ‡é’ˆæ˜¯å¦æŒ‡å‘ç›¸åŒçš„åœ°å€ã€‚</p><p>å¦‚æœæˆ‘ä»¬åœ¨æ‰€æœ‰è°ƒç”¨freeçš„åœ°æ–¹å¢åŠ æ—¥å¿—ï¼ŒæŠŠè¦é‡Šæ”¾çš„æŒ‡é’ˆè®°å½•ä¸‹æ¥ï¼Œå°±ä¼šæ¯”è¾ƒæœ‰åŠ©äºåˆ†æå’Œå®šä½é—®é¢˜ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ç¡®å®æœ‰è¿™ç§æ‰‹æ®µï¼Œé‚£å°±æ˜¯Linuxçš„preloadæœºåˆ¶ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/440471\">ç¬¬8èŠ‚è¯¾</a>ï¼Œæˆ‘ä»¬æ·±å…¥åœ°å­¦ä¹ äº†Loaderçš„åŸç†ï¼Œæˆ‘ä»¬çŸ¥é“å¯¹äºæœªå®šä¹‰çš„å¼•ç”¨ï¼ŒåŠ¨æ€é“¾æ¥å™¨è¦å…ˆè¿›è¡Œè§£æï¼Œå®ƒä¼šå…ˆæœç´¢LD_PRELOADç›®å½•ä¸‹çš„åŠ¨æ€åº“ï¼Œç„¶åå†æœç´¢å…¶ä»–çš„åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æœ‰åŠæ³•å¯¹mallocå’Œfreeå‡½æ•°è¿›è¡Œæ›¿æ¢ã€‚æ¯”å¦‚è‡ªå·±æä¾›freeçš„å®ç°ï¼š</p><pre><code>#define _GNU_SOURCE\n#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;dlfcn.h&gt;\n\nvoid free(void *ptr) {\n    void(*freep)() = NULL;\n\n    printf(&quot;ready to do free: %p\\n&quot;, ptr);\n    freep = dlsym(RTLD_NEXT, &quot;free&quot;);\n    freep(ptr);\n    printf(&quot;free done: %p\\n&quot;, ptr);\n}\n</code></pre><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘è¦æé†’ä¸€ä¸‹ä½ ï¼Œç¬¬1è¡Œçš„_GNU_SOURCEæ˜¯ä¸€å®šè¦æ·»åŠ çš„ï¼Œå› ä¸ºç¬¬10è¡Œçš„RTLD_NEXTå®ä¾èµ–äºè¿™ä¸ªå®ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ˆç¬¬7è¡Œï¼‰ï¼Œå®ƒå¯ä»¥æŒ‡å‘çœŸæ­£çš„freeçš„å®ç°ã€‚ç„¶ååˆ†åˆ«åœ¨è°ƒç”¨freeå‰å’Œè°ƒç”¨freeä»¥åæ‰“å°ä¸€æ¬¡è¦é‡Šæ”¾çš„æŒ‡é’ˆï¼ˆç¬¬9è¡Œå’Œç¬¬12è¡Œï¼‰ï¼Œå†é€šè¿‡dlsymæ‰“å¼€äº†glibcä¸­çš„freeæ–¹æ³•ï¼ˆç¬¬10è¡Œï¼‰ï¼Œdlsymçš„ä½œç”¨æ˜¯é€šè¿‡ç¬¦å·åç§°æ‰¾åˆ°ç¬¦å·å¯¹åº”çš„åœ°å€ã€‚</p><p>ä½ è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬10è¡Œä½¿ç”¨RTLD_NEXTå°±æ˜¯å‘Šè¯‰ld-linux.soä¸è¦åœ¨å½“å‰æ–‡ä»¶ä¸­æ‰¾freeè¿™ä¸ªç¬¦å·ï¼Œè€Œæ˜¯è¦æŒ‰ç…§åŠ¨æ€åº“çš„æœç´¢é¡ºåºæ‰¾åˆ°ä¸‹ä¸€ä¸ªåŠ¨æ€åº“ï¼Œå¹¶åœ¨å®ƒé‡Œé¢å¯»æ‰¾freeå‡½æ•°ï¼Œå®é™…ä¸Šï¼Œè¿™é‡Œæ‰¾åˆ°çš„å°±æ˜¯glibcé‡Œçš„freeå‡½æ•°äº†ã€‚</p><p>åˆ†æå®Œè¿™ä¸ªä»£ç ä»¥åï¼Œæˆ‘ä»¬å‘ç°è¿™é‡Œè‡ªå·±å®šä¹‰çš„freeæ–¹æ³•ä¸è¿‡æ˜¯glibcé‡Œçš„freeæ–¹æ³•çš„ä¸€ä¸ªåŒ…è£…(wrapper)ã€‚æ¥ç€ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘myfreeåº“ï¼Œå¹¶è®¾ç½®preloadå†æ‰§è¡Œdfreeç”¨ä¾‹ï¼š</p><pre><code>$ gcc -shared -fpic -o myfree.so myfree.c -ldl\n$ LD_PRELOAD=&quot;./myfree.so&quot; ./dfree\nready to do free: 0x1b44010\nfree done: 0x1b44010\nready to do free: 0x1b44010\n*** Error in `./dfree': double free or corruption (fasttop): 0x0000000001b44010 ***\nAborted\n</code></pre><p>è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ–°æ·»åŠ çš„æ—¥å¿—å·²ç»å¯ä»¥æ­£ç¡®è¾“å‡ºäº†ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°±é‡è½½äº†freeæ–¹æ³•ã€‚å¦‚æœä½ ç‰¹åˆ«æ„Ÿå…´è¶£çš„è¯ï¼Œä½ å¯ä»¥è‡ªå·±é‡æ–°å®ç°ä¸€ä¸ªmallocçš„ä¾‹å­ï¼Œ<a href=\"https://gitee.com/hinus/codelet\">æˆ‘çš„ä»£ç ä»“</a>å¯ä»¥ç»™ä½ ä½œä¸ºå‚è€ƒã€‚</p><h2>æ€»ç»“</h2><p>æˆ‘ä»¬è¿™èŠ‚è¯¾æ·±å…¥åœ°ä»‹ç»äº†mallocæ–¹æ³•çš„å®ç°åŸç†ï¼Œå¹¶ä»¥ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜å¦‚ä½•è®¾è®¡è‡ªå·±çš„åŠ¨æ€å†…å­˜ç®¡ç†å™¨ã€‚</p><p>é€šè¿‡è¿™èŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬äº†è§£åˆ°sbrkå’Œmmapæ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿè°ƒç”¨æ€§èƒ½ä¸å¤Ÿä¸”ä¸èƒ½å¯¹åˆ†é…çš„å†…å­˜è¿›è¡Œæœ‰æ•ˆç®¡ç†ï¼Œæ‰€ä»¥å¿…é¡»æœ‰äººåœ¨ç”¨æˆ·æ€å°†å¤§å—çš„å†…å­˜åˆ†å‰²æˆå°å—ï¼Œç„¶åè¿›è¡Œæ›´ç²¾ç»†çš„åˆ†é…å’Œå›æ”¶ï¼Œè¿™ä¸ªå·¥ä½œé€šå¸¸æƒ…å†µä¸‹æ˜¯ç”±glibcæ‰¿æ‹…çš„ã€‚</p><p>glibcæ‰€æä¾›çš„mallocåœ¨ç®¡ç†å†…å­˜æ—¶ï¼Œé‡‡ç”¨äº†ç©ºé—²é“¾è¡¨(free list)çš„æ–¹å¼ã€‚å¯¹free listçš„ç»„ç»‡æœ‰ç®€å•ç®—æ³•ã€åˆ†æ¡¶ç®¡ç†å’Œä¼™ä¼´ç³»ç»Ÿç­‰ä¸åŒçš„ç­–ç•¥ã€‚</p><p>æˆ‘ä»¬è¯„ä»·ä¸€ä¸ªç®¡ç†å†…å­˜ç®—æ³•çš„å› ç´ ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªç»´åº¦ï¼š</p><ol>\n<li><strong>æ•°æ®ç»“æ„å¦‚ä½•è®¾è®¡ï¼Œæ˜¯å¦å­˜åœ¨å†…å­˜ç¢ç‰‡</strong>ï¼›</li>\n<li><strong>åˆ†é…çš„æ•ˆç‡</strong>ï¼›</li>\n<li><strong>é‡Šæ”¾çš„æ•ˆç‡</strong>ã€‚</li>\n</ol><p>æˆ‘æŠŠä¸‰ç§ç®—æ³•æŒ‰ç…§ä¸Šé¢ä¸‰ä¸ªç»´åº¦æ€»ç»“æˆä»¥ä¸‹è¡¨æ ¼ï¼Œä½ å¯ä»¥å‚è€ƒä¸€ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/68/8c/6860afe12f23d59e9d70f8191aed3b8c.jpg?wh=2284x1387\" alt=\"\"></p><p>ç”±äºåŠ¨æ€é“¾æ¥å™¨åªè¯†åˆ«ç¬¬ä¸€æ¬¡é‡åˆ°çš„ç¬¦å·ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æœ‰æœºä¼šé€šè¿‡é‡å†™glibcä¸­çš„æ–¹æ³•æ¥å®ç°è‡ªå·±çš„å†…å­˜ç®¡ç†åº“ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†æå‡æ€§èƒ½ï¼Œæˆ–è€…æ˜¯ä¸ºäº†æ’æŸ¥é”™è¯¯ã€‚æˆ‘ä»¬ä»¥double freeä¸ºä¾‹ä»‹ç»äº†å…¸å‹çš„å†…å­˜é”™è¯¯ï¼Œå¹¶é€šè¿‡è¦†å†™freeå‡½æ•°æ¥è§£å†³å®ƒã€‚è¿™å±•ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„è®¾è®¡å†…å­˜ç®¡ç†åº“çš„è¿‡ç¨‹ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æˆ‘ä»¬åœ¨å®æˆ˜ç¯èŠ‚ä»‹ç»äº†å¦‚ä½•åœ¨freeæ–¹æ³•é‡Œå¢åŠ logä»¥ç»Ÿè®¡å“ªäº›å†…å­˜æ›¾ç»é‡Šæ”¾è¿‡ï¼Œä»¥ä¾¿äºæ’æŸ¥å“ªäº›å†…å­˜è¢«é‡å¤é‡Šæ”¾äº†ã€‚</p><p>å¦‚æœæˆ‘ä»¬ç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œä½†æ˜¯å¿˜è®°é‡Šæ”¾äº†ï¼Œè¿™ç§æƒ…å†µå°±æ˜¯å†…å­˜æ³„éœ²ã€‚è¯·è‡ªå·±è®¾è®¡ä¸€ä¸ªæ–¹æ¡ˆï¼Œç»Ÿè®¡å†…å­˜æ³„éœ²çš„æƒ…å†µã€‚åªè¦æè¿°åšæ³•å³å¯ï¼Œå¦‚æœä½ ç‰¹åˆ«æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥åœ¨æˆ‘ä»¬è¿™èŠ‚è¯¾çš„ä»£ç é‡Œè‡ªå·±æ·»åŠ å®ç°ã€‚æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æƒ³æ³•å’Œæ”¶è·ï¼Œæˆ‘åœ¨ç•™è¨€åŒºç­‰ä½ ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/bc/bf/bcf35ec9987038716b303079cfa982bf.jpg?wh=2284x1386\" alt=\"\"></p><p>å¥½å•¦ï¼Œè¿™èŠ‚è¯¾åˆ°è¿™å°±ç»“æŸå•¦ã€‚æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹è®¡ç®—æœºå†…å­˜æ„Ÿå…´è¶£çš„æœ‹å‹ã€‚æˆ‘æ˜¯æµ·çº³ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":321102,"user_name":"å¤§è±†","can_delete":false,"product_type":"c1","uid":1350130,"ip_address":"","ucode":"BC78EF2336DBD0","user_header":"https://static001.geekbang.org/account/avatar/00/14/99/f2/c74d24d7.jpg","comment_is_top":false,"comment_ctime":1636680705,"is_pvip":false,"replies":[{"id":"116616","content":"åœ¨è¿›ç¨‹çš„æ˜ å°„åŒºä¸­ã€‚ä¸ç”¨å¤ªåœ¨æ„è¿™ä¸ªæ¦‚å¿µçš„åŒºåˆ†ï¼Œä½ è¦åœ¨æ„çš„æ˜¯ï¼Œmmapå‡ºæ¥çš„å†…å­˜åŒºåŸŸè¢«æ‹¿å»åšä»€ä¹ˆäº†ã€‚å®ƒå¯ä»¥ç”¨äºmallocåˆ†é…å †å†…å­˜ï¼Œä¹Ÿå¯ä»¥ç”¨äºåç¨‹çš„æ ˆå†…å­˜ã€‚æ‰€ä»¥ä¸€å—å†…å­˜åŒºåŸŸåˆ°åº•æ˜¯ä»€ä¹ˆï¼Œå–å†³äºä½ æ€ä¹ˆç”¨ä»–ï¼Œè€Œä¸æ˜¯å®ƒè‡ªå·±çš„åœ°å€åœ¨å“ªé‡Œã€‚æ¢å¥è¯è¯´ï¼Œæ ¹æ®åœ°å€åˆ’åˆ†çš„åŒºåŸŸä¸æ˜¯ç»å¯¹çš„ï¼Œæ ¹æ®å®ƒçš„ä½œç”¨ï¼Œå†…å­˜åŒºåŸŸçš„æ€§è´¨ä¹Ÿæ˜¯å¯ä»¥å‘ç”Ÿå˜åŒ–çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æµ·çº³","uid":"1360512","ctime":1636698155,"ip_address":"","comment_id":321102,"utype":1}],"discussion_count":1,"race_medal":0,"score":"40291386369","product_id":100094901,"comment_content":"è€å¸ˆï¼Œæˆ‘æœ‰ä¸ªç–‘é—®ï¼Œé€šè¿‡mmapåˆ†é…çš„å†…å­˜æ˜¯åœ¨è¿›ç¨‹çš„æ˜ å°„åŒºè¿˜æ˜¯å †ä¸­ï¼Œè¿˜æ˜¯éƒ½æœ‰ï¼Ÿ","like_count":10,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530217,"discussion_content":"åœ¨è¿›ç¨‹çš„æ˜ å°„åŒºä¸­ã€‚ä¸ç”¨å¤ªåœ¨æ„è¿™ä¸ªæ¦‚å¿µçš„åŒºåˆ†ï¼Œä½ è¦åœ¨æ„çš„æ˜¯ï¼Œmmapå‡ºæ¥çš„å†…å­˜åŒºåŸŸè¢«æ‹¿å»åšä»€ä¹ˆäº†ã€‚å®ƒå¯ä»¥ç”¨äºmallocåˆ†é…å †å†…å­˜ï¼Œä¹Ÿå¯ä»¥ç”¨äºåç¨‹çš„æ ˆå†…å­˜ã€‚æ‰€ä»¥ä¸€å—å†…å­˜åŒºåŸŸåˆ°åº•æ˜¯ä»€ä¹ˆï¼Œå–å†³äºä½ æ€ä¹ˆç”¨ä»–ï¼Œè€Œä¸æ˜¯å®ƒè‡ªå·±çš„åœ°å€åœ¨å“ªé‡Œã€‚æ¢å¥è¯è¯´ï¼Œæ ¹æ®åœ°å€åˆ’åˆ†çš„åŒºåŸŸä¸æ˜¯ç»å¯¹çš„ï¼Œæ ¹æ®å®ƒçš„ä½œç”¨ï¼Œå†…å­˜åŒºåŸŸçš„æ€§è´¨ä¹Ÿæ˜¯å¯ä»¥å‘ç”Ÿå˜åŒ–çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636698155,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321185,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1636702347,"is_pvip":true,"replies":[{"id":"116726","content":"å‰å®³ï¼Œä½ è°ƒæŸ¥å¾—å¾ˆæ·±å…¥äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æµ·çº³","uid":"1360512","ctime":1636902408,"ip_address":"","comment_id":321185,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18816571531","product_id":100094901,"comment_content":"çœ‹å®Œæ„Ÿè§‰è‡ªå·±å¯ä»¥å®ç°ä¸ªvalgrindäº†ï¼Œä¸è¿‡åˆè§‰å¾—å°‘äº†äº¿ç‚¹ç‚¹ç»†èŠ‚ã€‚äºæ˜¯æŸ¥äº†ä¸‹valgrindçš„å®ç°ï¼Œå‘ç°åªæœ‰ç”¨åˆ°äº†preloadè¿™ç‚¹æ˜¯ä¸€æ ·çš„ã€‚å‰©ä¸‹çš„éƒ¨åˆ†valgrindç›¸å½“äºå®ç°äº†ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå°†æœºå™¨æŒ‡ä»¤è½¬æˆè™šæ‹ŸæœºIRï¼Œæ’æ¡©ï¼Œå†é€šè¿‡JITç”Ÿæˆæœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚è¿™æ ·çœ‹æ¥Javaå­—èŠ‚ç å¢å¼ºå°±æ˜¯ä¸ªå¼Ÿå¼Ÿé˜¿â€¦<br><br>å¦å¤–llvmå› ä¸ºæœ¬èº«å°±æœ‰IRï¼Œæ‰€ä»¥å°±å¯ä»¥ç›´æ¥åœ¨IRä¸Šåšï¼Œæ®è¯´asanå°±æ˜¯è¿™ä¹ˆå®ç°çš„ã€‚","like_count":5,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530239,"discussion_content":"å‰å®³ï¼Œä½ è°ƒæŸ¥å¾—å¾ˆæ·±å…¥äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636902408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322971,"user_name":"LDxy","can_delete":false,"product_type":"c1","uid":1188710,"ip_address":"","ucode":"956432CE7B7761","user_header":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","comment_is_top":false,"comment_ctime":1637676008,"is_pvip":false,"replies":[{"id":"117269","content":"tcmallocå’Œjemallocéƒ½æ¯”mallocçš„æ€§èƒ½å¥½ã€‚c++ä¹Ÿå¾ˆåœ¨æ„è¿™ä¸€ç‚¹çš„ã€‚javaæ˜¯å†…å­˜å…¨éƒ¨è‡ªå·±æ‰˜ç®¡äº†ã€‚ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1637733427,"ip_address":"","comment_id":322971,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5932643304","product_id":100094901,"comment_content":"è€å¸ˆï¼Œä¸ºä»€ä¹ˆå¾ˆå¤šç”¨Cè¯­è¨€åšå¼€å‘çš„äººéƒ½è¯´glibcé‡Œé¢çš„å†…å­˜åˆ†é…mallocçš„æ€§èƒ½ä¸è¡Œï¼Œæ‰€ä»¥è¦è‡ªå·±å®ç°ä¸€ä¸ªåŠ¨æ€å†…å­˜ç®¡ç†æœºåˆ¶ã€‚å¯æˆ‘ä¹Ÿæ²¡çœ‹å‡ºglibcé‡Œé¢çš„mallocæœ‰å•¥å¤§é—®é¢˜ï¼Œè‡ªå·±å»é‡æ–°å®ç°ä¸€å¥—å†…å­˜ç®¡ç†ï¼ŒçœŸçš„èƒ½æ¯”æ ‡å‡†åº“çš„æ€§èƒ½æå‡å—ï¼Ÿè€Œä¸”ç©¶ç«Ÿè¯¥æ€ä¹ˆæµ‹è¯•åŠ¨æ€å†…å­˜ç®¡ç†æœºåˆ¶çš„æ€§èƒ½ï¼Œä¼¼ä¹ä¹Ÿæ— ä»ä¸‹æ‰‹ã€‚è€Œä¸”ï¼Œå¥½åƒå°±åªæœ‰Cç¨‹åºå‘˜åœ¨æ„åŠ¨æ€å†…å­˜åˆ†é…çš„æ€§èƒ½é—®é¢˜ï¼Œå…¶ä»–è¯­è¨€æ¯”å¦‚C++ï¼ŒJavaçš„ç¨‹åºå‘˜å°±ä¸æ€ä¹ˆå…³å¿ƒåŠ¨æ€å†…å­˜åˆ†é…çš„æ€§èƒ½é—®é¢˜ã€‚","like_count":1,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532920,"discussion_content":"tcmallocå’Œjemallocéƒ½æ¯”mallocçš„æ€§èƒ½å¥½ã€‚c++ä¹Ÿå¾ˆåœ¨æ„è¿™ä¸€ç‚¹çš„ã€‚javaæ˜¯å†…å­˜å…¨éƒ¨è‡ªå·±æ‰˜ç®¡äº†ã€‚ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1637733427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2839104,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/52/40/1fe5be2b.jpg","nickname":"è”é€š","note":"","ucode":"EAA1331CFAFDA3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556566,"discussion_content":"mallocåˆ†é…å†…å­˜æ˜¯ä¸æ…¢çš„ï¼Œä½†æ˜¯å°å†…å­˜ç®¡ç†ä¸å¥½ï¼Œæ‰€ä»¥å°±è‡ªå·±å»å®ç°å†…å­˜çš„ç®¡ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647419556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351063,"user_name":"éª¨æ±¤é¸¡è›‹é¢","can_delete":false,"product_type":"c1","uid":1050002,"ip_address":"","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1657507629,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1657507629","product_id":100094901,"comment_content":"void* p1 = malloc(16);<br>free(p1)<br>freeçš„æ—¶å€™ï¼Œæ ¹æ®å‚æ•°çŸ¥é“ä»åœ°å€p1å¼€å§‹freeï¼Œé‚£å¦‚ä½•çŸ¥é“free 16ä¸ªå­—èŠ‚å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1964512,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/f9/e0/2754365e.jpg","nickname":"æ¢¦é‡Œæ±Ÿå—","note":"","ucode":"E6CBDF858DA389","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579520,"discussion_content":"çŒœæµ‹æ˜¯mallocå†…å­˜åˆ†é…æ—¶ä¼šç»´æŠ¤ä¸€ä¸ªåˆ†é…è¡¨ï¼Œé€šè¿‡è¿”å›çš„æŒ‡é’ˆå€¼å¯ä»¥æ‰¾åˆ°å¯¹åº”åˆ†é…çš„ç©ºé—´ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657514532,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338634,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1647611308,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647611308","product_id":100094901,"comment_content":"ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€æ˜¯æˆ‘æŒ‰ç…§ä¸Šé¢çš„ä»£ç æ¥è·‘æµ‹è¯•ï¼ŒæœªæŒ‰é¢„æœŸè¿è¡Œï¼Œæ‰“å°äº†ä¸€å † ready to do free: (nil)ï¼Œç„¶å Segmentation fault äº†ï¼ˆå¤åˆ¶è€å¸ˆæä¾›çš„ä»£ç ï¼Œè¿è¡Œç»“æœæ˜¯ä¸€è‡´çš„ï¼‰ï¼›äºŒæ˜¯æä¾›çš„ä»£ç ä»“åº“ä¸­æ²¡æœ‰è¿™ä»½ä»£ç ã€‚","like_count":0},{"had_liked":false,"id":336978,"user_name":"ä¼šçˆ†ç‚¸çš„å°ç±³Note","can_delete":false,"product_type":"c1","uid":2150023,"ip_address":"","ucode":"1DA0B740A7C7B7","user_header":"https://static001.geekbang.org/account/avatar/00/20/ce/87/41c44923.jpg","comment_is_top":false,"comment_ctime":1646526982,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646526982","product_id":100094901,"comment_content":"è€å¸ˆå¥½ï¼mmapæ˜¯ç›¸å½“äºåªä¿®æ”¹äº†é¡µè¡¨é¡¹ï¼ŒæŠŠç›¸åº”é¡µé¢çš„é¡µè¡¨é¡¹ä¿®æ”¹æˆå·²åˆ†é…æœªç¼“å­˜çš„çŠ¶æ€ï¼Œç„¶ååœ¨è®¿é—®çš„æ—¶å€™é€šè¿‡ç¼ºé¡µä¸­æ–­åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­å—ï¼Ÿ<br>ç¬¬ä¸€èŠ‚è¯¾ä¸­åŠæ‰“é¢è¯•å®˜çš„éƒ¨åˆ†ä¸­è¯´é€šè¿‡mmapæ„å»ºæ˜ å°„åé€šè¿‡éå†è®¿é—®æ‰èƒ½è®©å†…å­˜commit<br>è¯·æ•™ä¸‹è€å¸ˆæœ‰ä»€ä¹ˆé«˜æ•ˆçš„æ–¹æ³•æ¥è¿›è¡Œè®¿é—®å— ","like_count":0},{"had_liked":false,"id":336906,"user_name":"ä½³ä¼¦","can_delete":false,"product_type":"c1","uid":1064508,"ip_address":"","ucode":"3AE8098B5BE716","user_header":"https://static001.geekbang.org/account/avatar/00/10/3e/3c/fc3ad983.jpg","comment_is_top":false,"comment_ctime":1646460991,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646460991","product_id":100094901,"comment_content":"mallocé€šè¿‡mmapä»æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å—æ¯”è¾ƒå¤§çš„å†…å­˜å†ç²¾ç»†åŒ–ç®¡ç†ï¼Œä½†æ˜¯mmapç”³è¯·åˆ°çš„å†…å­˜å¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œä¹Ÿéœ€è¦ä¼™ä¼´ç®—æ³•æ¥ç®¡ç†ã€‚æ‰€ä»¥ï¼Œå†…å­˜ç®¡ç†ç»å†äº†å¥½å‡ ä¸ªå±‚é¢ï¼Œæ“ä½œç³»ç»Ÿå±‚é¢ã€ç”¨æˆ·å±‚é¢ï¼Œåœ¨ç¡¬ä»¶å±‚å¯èƒ½è¿˜æœ‰ç±»ä¼¼çš„ç®¡ç†æ–¹æ³•ã€‚æ‰€ä»¥å¥—äº†è¿™ä¹ˆå¤šå±‚æ•ˆç‡è‚¯å®šä¼šå—å½±å“","like_count":0},{"had_liked":false,"id":325179,"user_name":"éƒ‘ç«¥æ–‡","can_delete":false,"product_type":"c1","uid":1030733,"ip_address":"","ucode":"3D193715CB8549","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ba/4d/7ba09ff0.jpg","comment_is_top":false,"comment_ctime":1638851299,"is_pvip":false,"replies":[{"id":"118164","content":"ä¸ä¼šmmapï¼Œmallocéƒ½ä¸ä¼šä½¿è™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚åªæœ‰ä½ åœ¨è®¿é—®ä»–çš„æ—¶å€™æ‰ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1639106842,"ip_address":"","comment_id":325179,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638851299","product_id":100094901,"comment_content":"è¯·é—®è€å¸ˆmallocå‡½æ•°ç”¨mmapå‘ç³»ç»Ÿç”³è¯·ä¸€å¤§å—å†…å­˜çš„æ—¶å€™ï¼Œè¿™ä¸€å¤§å—å†…å­˜å°±å·²ç»æ˜ å°„åˆ°ç‰©ç†å†…å­˜äº†å—ï¼Ÿ è¿˜æ˜¯åœ¨mallocä»è¿™ä¸€å¤§å—å†…å­˜ä¸­åˆ†é…ä¸€å°å—å†…å­˜ç»™è¿›ç¨‹æ—¶ï¼Œæ‰ä¼šæŠŠè¿™ä¸€å°å—å†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Ÿ ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537577,"discussion_content":"ä¸ä¼šmmapï¼Œmallocéƒ½ä¸ä¼šä½¿è™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚åªæœ‰ä½ åœ¨è®¿é—®ä»–çš„æ—¶å€™æ‰ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639106842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":322211,"user_name":"ğŸ®","can_delete":false,"product_type":"c1","uid":2112298,"ip_address":"","ucode":"3FAD9EA59E1713","user_header":"https://static001.geekbang.org/account/avatar/00/20/3b/2a/f05e546a.jpg","comment_is_top":false,"comment_ctime":1637238050,"is_pvip":true,"replies":[{"id":"117044","content":"æ–‡ä¸­çš„è¿™ç§åšæ³•å°±æ˜¯é‡è½½äº†glibcä¸­çš„freeå‡½æ•°ã€‚ä½ å¯ä»¥è‡ªå·±åŠ¨æ‰‹è¯•ä¸€ä¸‹å“¦ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1637325513,"ip_address":"","comment_id":322211,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1637238050","product_id":100094901,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼Œè¯·æ•™ä¸ªé—®é¢˜ï¼Œä¹‹å‰å‡½æ•°é‡è½½è¿™å—ä½¿ç”¨æ¯”è¾ƒå¤šçš„æ˜¯é€šè¿‡ç¼–è¯‘å™¨wrapæ–¹å¼é‡è½½ï¼Œä½†è¿™å—åªèƒ½å¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œé‡è½½ï¼Œä¸èƒ½å®ç°glibcé‡è½½ï¼Œè¿™é‡Œæ‰€è¯´çš„LD_PRELOADæ˜¯ä¸æ˜¯ä¹Ÿåªæ˜¯é’ˆå¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œé‡è½½ä¸èƒ½å®ç°åƒåŠ¨æ€åº“é‡è½½ï¼Œå¦‚æœæ˜¯æŸä¸ªglibcä¸­çš„å‡½æ•°ä½¿ç”¨mallocï¼Œè¿™ç§æ–¹æ¡ˆæ˜¯ä¸æ˜¯ä¸èƒ½è¿›è¡Œé‡è½½çš„ï¼›","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531500,"discussion_content":"æ–‡ä¸­çš„è¿™ç§åšæ³•å°±æ˜¯é‡è½½äº†glibcä¸­çš„freeå‡½æ•°ã€‚ä½ å¯ä»¥è‡ªå·±åŠ¨æ‰‹è¯•ä¸€ä¸‹å“¦ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637325513,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2112298,"avatar":"https://static001.geekbang.org/account/avatar/00/20/3b/2a/f05e546a.jpg","nickname":"ğŸ®","note":"","ucode":"3FAD9EA59E1713","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531135,"discussion_content":"æˆ‘å®é™…æµ‹è¯•å¥½åƒåŠ¨æ€åº“ä¹Ÿæ˜¯å¯ä»¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637239314,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321972,"user_name":"æµæµªåœ°çƒ","can_delete":false,"product_type":"c1","uid":1498137,"ip_address":"","ucode":"25210DCD353F97","user_header":"https://static001.geekbang.org/account/avatar/00/16/dc/19/c058bcbf.jpg","comment_is_top":false,"comment_ctime":1637120586,"is_pvip":false,"replies":[{"id":"117049","content":"é¦–å…ˆå›ç­”ä½ çš„é—®é¢˜æ˜¯ï¼Œä¸ä¼šçš„ã€‚ä½†æˆ‘ä¸ç†è§£ä½ ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§è¯¯è§£ï¼Œæˆ‘æ€€ç–‘ä½ æ˜¯å“ªä¸ªæ¦‚å¿µç†è§£é”™äº†æ‰ä¼šè¿™æ ·æé—®çš„ã€‚å»ºè®®åŠ å¾®ä¿¡ç¾¤è¯¦ç»†äº¤æµã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1637325802,"ip_address":"","comment_id":321972,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1637120586","product_id":100094901,"comment_content":"è¯·é—®è€å¸ˆï¼Œtcmallocçš„çº¿ç¨‹æœ¬åœ°ç¼“å­˜ä¼šä¸ä¼šå¯¼è‡´ç›¸åŒçš„ä¸€ä»½ä»£ç äº§ç”Ÿçš„è¿›ç¨‹ï¼Œåˆ†é…çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¼šå¤§ä¸€äº›å‘¢ï¼Ÿçœ‹æè¿°åƒæ˜¯å¢åŠ é¢„åˆ†é…äº†ä¸€äº›ç©ºé—´","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531509,"discussion_content":"é¦–å…ˆå›ç­”ä½ çš„é—®é¢˜æ˜¯ï¼Œä¸ä¼šçš„ã€‚ä½†æˆ‘ä¸ç†è§£ä½ ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§è¯¯è§£ï¼Œæˆ‘æ€€ç–‘ä½ æ˜¯å“ªä¸ªæ¦‚å¿µç†è§£é”™äº†æ‰ä¼šè¿™æ ·æé—®çš„ã€‚å»ºè®®åŠ å¾®ä¿¡ç¾¤è¯¦ç»†äº¤æµã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637325802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":3,"child_discussions":[{"author":{"id":1498137,"avatar":"https://static001.geekbang.org/account/avatar/00/16/dc/19/c058bcbf.jpg","nickname":"æµæµªåœ°çƒ","note":"","ucode":"25210DCD353F97","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":531722,"discussion_content":"è¯·é—®è€å¸ˆå¦‚ä½•å…¥ç¾¤å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637396669,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":531509,"ip_address":""},"score":531722,"extra":"{\"user_type\":1}"},{"author":{"id":1711838,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/1e/de/cdee1780.jpg","nickname":"æˆ‘æ˜¯å†…å­˜","note":"","ucode":"3D763D4F434D50","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1498137,"avatar":"https://static001.geekbang.org/account/avatar/00/16/dc/19/c058bcbf.jpg","nickname":"æµæµªåœ°çƒ","note":"","ucode":"25210DCD353F97","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532167,"discussion_content":"åœ¨è¯¾ç¨‹ä»‹ç»é‡Œé¢æœ‰åŠ å…¥çš„äºŒç»´ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637548540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":531722,"ip_address":""},"score":532167,"extra":"{\"user_type\":1}"},{"author":{"id":2943244,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/e9/0c/40fa7815.jpg","nickname":"ab-ripper","note":"","ucode":"4F09F719887D09","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1711838,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/1e/de/cdee1780.jpg","nickname":"æˆ‘æ˜¯å†…å­˜","note":"","ucode":"3D763D4F434D50","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560885,"discussion_content":"æ²¡æœ‰æ‰¾åˆ°äºŒç»´ç ï¼Œèƒ½æ‹‰ä¸‹å—ï¼Ÿæ„Ÿè°¢ï¼Œå¾®ä¿¡å·ï¼šb-ripper","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649482509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":532167,"ip_address":""},"score":560885,"extra":""}]}]},{"had_liked":false,"id":321122,"user_name":"æ…¢åŠ¨ä½œ","can_delete":false,"product_type":"c1","uid":1133945,"ip_address":"","ucode":"62C944F4A4D8AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/79/803537db.jpg","comment_is_top":false,"comment_ctime":1636683945,"is_pvip":true,"replies":[{"id":"117078","content":"å—¯ã€‚è¿™é‡Œä¸»è¦æ¼”ç¤ºäº†ä¸€ä¸‹å¦‚ä½•åšå‡½æ•°æ›¿æ¢ï¼Œå…¶ä»–çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å½“æ—¶çš„è°ƒç”¨æ ˆä»€ä¹ˆçš„ï¼Œéœ€è¦æ›´å¤šè°ƒè¯•å™¨çš„å®ç°åŸç†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ²¡å†è®²äº†ã€‚å¦‚æœæœ‰å…´è¶£å¯ä»¥å‚è€ƒä¸€ä¸‹gdbå¦‚ä½•æ‰“å°è°ƒç”¨æ ˆï¼Œvalgrindå¦‚ä½•è¿½è¸ªæ³„æ¼å†…å­˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1360512","ctime":1637375754,"ip_address":"","comment_id":321122,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636683945","product_id":100094901,"comment_content":"erroré‡Œä¹Ÿæœ‰åœ°å€ï¼Œè¿™é¢å¤–æ—¥å¿—æ²¡æœ‰ç»™å‡ºé¢å¤–çš„ä¿¡æ¯ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1360512,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c2/80/6ebf32e8.jpg","nickname":"æµ·çº³","note":"","ucode":"AB9F7ADB1428D2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531658,"discussion_content":"å—¯ã€‚è¿™é‡Œä¸»è¦æ¼”ç¤ºäº†ä¸€ä¸‹å¦‚ä½•åšå‡½æ•°æ›¿æ¢ï¼Œå…¶ä»–çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å½“æ—¶çš„è°ƒç”¨æ ˆä»€ä¹ˆçš„ï¼Œéœ€è¦æ›´å¤šè°ƒè¯•å™¨çš„å®ç°åŸç†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ²¡å†è®²äº†ã€‚å¦‚æœæœ‰å…´è¶£å¯ä»¥å‚è€ƒä¸€ä¸‹gdbå¦‚ä½•æ‰“å°è°ƒç”¨æ ˆï¼Œvalgrindå¦‚ä½•è¿½è¸ªæ³„æ¼å†…å­˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637375754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}