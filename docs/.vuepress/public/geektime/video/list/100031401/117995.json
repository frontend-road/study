{"id":117995,"title":"55 | 结构化日志和业务审计日志","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":161693,"user_name":"lester","can_delete":false,"product_type":"c3","uid":1025747,"ip_address":"","ucode":"79BD59B50C97BA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a6/d3/856316dd.jpg","comment_is_top":false,"comment_ctime":1576298609,"is_pvip":false,"replies":[{"id":61652,"content":"你这个不光是技术问题，也是个治理问题，所以不能光用技术解决，还需要研发流程和架构治理配合，日志治理是架构治理的一部分，比方说对开发人员记录日志是否有规范，培训，是否有评审机制等。\n\n技术上，一般日志入ES之前，前置都有一个日志队列(比方说kafka)，这是一个可以做日志收口的点，你就可以做监控治理，比如每个app写入了多少日志，是否合理，敏感数据是否已经清洗，不合理的日志你可以禁入es，限期整改等等。如果用kafka集群做日志队列的话，它就是一个大缓冲，性能一般不成问题，大厂每天缓冲处理超过上T甚至几十T日志都属正常。\n\n\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1576408580,"ip_address":"","comment_id":161693,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师您好，从开发的角度，想把相关日志尽量记录全，出问题便于排查，但从数据安全角度，如一些敏感信息又需要加密记录，在生产环境中，老师您有两者平衡的类似经验么？目前我们在阿里云上通过结合es检索已有日志（直接写），还有会通过send jms 异步记录日志，写日志对于性能的损耗大么？大厂一般如何平衡写与不写？","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477819,"discussion_content":"你这个不光是技术问题，也是个治理问题，所以不能光用技术解决，还需要研发流程和架构治理配合，日志治理是架构治理的一部分，比方说对开发人员记录日志是否有规范，培训，是否有评审机制等。\n\n技术上，一般日志入ES之前，前置都有一个日志队列(比方说kafka)，这是一个可以做日志收口的点，你就可以做监控治理，比如每个app写入了多少日志，是否合理，敏感数据是否已经清洗，不合理的日志你可以禁入es，限期整改等等。如果用kafka集群做日志队列的话，它就是一个大缓冲，性能一般不成问题，大厂每天缓冲处理超过上T甚至几十T日志都属正常。\n\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576408580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":200476,"user_name":"旭东(Frank)","can_delete":false,"product_type":"c3","uid":1024486,"ip_address":"","ucode":"176FA629800062","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a1/e6/50da1b2d.jpg","comment_is_top":false,"comment_ctime":1585608309,"is_pvip":false,"replies":[{"id":75435,"content":"对，有好的实践可以分享给大家。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585839060,"ip_address":"","comment_id":200476,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"审计日志内容中对于对象变化使用整体，这个还可以优化到具体项的变化，方便业务人直观了解","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490040,"discussion_content":"对，有好的实践可以分享给大家。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585839060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":123584,"user_name":"Tomorrow","can_delete":false,"product_type":"c3","uid":1510148,"ip_address":"","ucode":"6F213062369A8D","user_header":"https://static001.geekbang.org/account/avatar/00/17/0b/04/28ae1b31.jpg","comment_is_top":false,"comment_ctime":1565706929,"is_pvip":false,"replies":[{"id":45458,"content":"审计日志一般和重要的业务操作有关，可以手工埋点，实际也不是特别费事。当然，你可以考虑Spring AOP方式截获业务操作自动埋点，比如对Service或者Repository层通过aop截获写审计日志。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1565789243,"ip_address":"","comment_id":123584,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师，您好，关于采用structlog4j进行审计日志时，有很多方法需要记录日志的这种场景，还像staffjoy里这样每个方法埋点，会不会显得比较笨重，有没有好的解决办法？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462736,"discussion_content":"审计日志一般和重要的业务操作有关，可以手工埋点，实际也不是特别费事。当然，你可以考虑Spring AOP方式截获业务操作自动埋点，比如对Service或者Repository层通过aop截获写审计日志。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565789243,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1133918,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","nickname":"lmtoo","note":"","ucode":"FCD5B9C941D448","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4890,"discussion_content":"要想自动记录审计，可以参考一下HIbernate的Envers模块","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1565795906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1595467,"avatar":"https://static001.geekbang.org/account/avatar/00/18/58/4b/8b044dd3.jpg","nickname":"和光同尘","note":"","ucode":"A3195757E45CD5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":16541,"discussion_content":"波波老师,您好,我们现在业务对于审计日志这块也是通过手工的方式,不同的是,我们将业务日志放到了数据库中,方便查看,请问您的方式,记录到日志中,以后要查看该怎么查看呀,好像日志最多只能保存30天","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568899463,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217620,"user_name":"Dustin Volz","can_delete":false,"product_type":"c3","uid":1191649,"ip_address":"","ucode":"4EC53469C8D113","user_header":"https://static001.geekbang.org/account/avatar/00/12/2e/e1/ab6361e4.jpg","comment_is_top":false,"comment_ctime":1589549352,"is_pvip":false,"replies":[{"id":80669,"content":"没有完全理解你的需求，能再解释详细一点？","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1589729488,"ip_address":"","comment_id":217620,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师有啥软件推荐吗？我们的spring 日志不用jason话，可以分平台给开发用web 方式访问就可以了，这种工具有推荐吗？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495196,"discussion_content":"没有完全理解你的需求，能再解释详细一点？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589729488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":191144,"user_name":"钱","can_delete":false,"product_type":"c3","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1584749191,"is_pvip":false,"replies":[{"id":73432,"content":"StructLog4只是在SLF4J上的一层薄薄的封装，SLF4J也只是一个Logging Facade，性能损耗具体要看底层所使用的Logging库，比如logback，log4j等，这些都是很普通常用的日志库。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1584792530,"ip_address":"","comment_id":191144,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"StructLog4J——用于日志结构化，观看和分析都更加方便。不过日志记录是比较耗性能的，对于这个日志结构化工具性能损耗大概有多少呢？尤其对于性能敏感的服务是否可以使用？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488121,"discussion_content":"StructLog4只是在SLF4J上的一层薄薄的封装，SLF4J也只是一个Logging Facade，性能损耗具体要看底层所使用的Logging库，比如logback，log4j等，这些都是很普通常用的日志库。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584792530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127361,"user_name":"硕果阳光","can_delete":false,"product_type":"c3","uid":1064133,"ip_address":"","ucode":"C59841EB675535","user_header":"https://static001.geekbang.org/account/avatar/00/10/3c/c5/92017a7b.jpg","comment_is_top":false,"comment_ctime":1566664410,"is_pvip":false,"replies":[{"id":47225,"content":"这个审计日志底层就是用的slf4j&#47;logback，默认应该是同步的，具体要看你配置的logback的appender，有些appender是支持异步的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1566746442,"ip_address":"","comment_id":127361,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"您好 老师 这个审计log 写入过程是Async的么？ 多谢","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464456,"discussion_content":"这个审计日志底层就是用的slf4j/logback，默认应该是同步的，具体要看你配置的logback的appender，有些appender是支持异步的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566746442,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380759,"user_name":"张振宇","can_delete":false,"product_type":"c3","uid":1130691,"ip_address":"北京","ucode":"7A6FD7294E65FF","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/c3/e545ba80.jpg","comment_is_top":false,"comment_ctime":1694097013,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师，审计日志如何异步入库，有没有案例","like_count":0},{"had_liked":false,"id":360117,"user_name":"Geek_a0a7d8","can_delete":false,"product_type":"c3","uid":3194852,"ip_address":"广东","ucode":"ACCD40D0DF6577","user_header":"","comment_is_top":false,"comment_ctime":1666185921,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"结构化日志跟 直接把对象转json string打印日志好像一样","like_count":0}]}