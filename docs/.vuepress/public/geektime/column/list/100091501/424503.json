{"id":424503,"title":"07ï½œä¹¾å¤å¤§æŒªç§»ï¼šç§’æ€çš„å‰Šå³°å’Œé™æµ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¿—ä¸œï¼Œæ¬¢è¿å’Œæˆ‘ä¸€èµ·ä»é›¶æ‰“é€ ç§’æ€ç³»ç»Ÿã€‚</p><p>å‰é¢ä¸¤èŠ‚è¯¾æˆ‘ä»¬è®²äº†ç§’æ€çš„éš”ç¦»ç­–ç•¥å’Œæµé‡æ§åˆ¶ï¼Œå…¶ç›®çš„æ˜¯é™ä½æµé‡çš„ç›¸äº’è€¦åˆå’Œé‡çº§ï¼Œå‡å°‘å¯¹ç³»ç»Ÿçš„å†²å‡»ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å°†ç»§ç»­ä»<strong>æŠ€æœ¯è§’åº¦</strong>æ¥è®¨è®ºç§’æ€ç³»ç»Ÿçš„å…¶ä»–é«˜å¯ç”¨æ‰‹æ®µâ€”â€”å‰Šå³°å’Œé™æµï¼Œé€šè¿‡å‰Šå³°ï¼Œè®©ç³»ç»Ÿæ›´åŠ ç¨³å¥ã€‚</p><p>å‰Šå³°å¡«è°·æ¦‚å¿µä¸€å¼€å§‹å‡ºç°åœ¨ç”µåŠ›è¡Œä¸šï¼Œæ˜¯è°ƒæ•´ç”¨ç”µè´Ÿè·çš„ä¸€ç§æªæ–½ï¼Œåœ¨äº’è”ç½‘åˆ†å¸ƒå¼é«˜å¯ç”¨æ¶æ„çš„æ¼”è¿›è¿‡ç¨‹ä¸­ï¼Œä¹Ÿç»å¸¸ä¼šé‡‡ç”¨ç±»ä¼¼çš„å‰Šå³°å¡«è°·æ‰‹æ®µæ¥æ„å»ºç¨³å®šçš„ç³»ç»Ÿã€‚</p><p>å‰Šå³°çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¯ä»¥é€šè¿‡ä¸šåŠ¡æ‰‹æ®µæ¥å‰Šå³°ï¼Œæ¯”å¦‚ç§’æ€æµç¨‹ä¸­è®¾ç½®éªŒè¯ç æˆ–è€…é—®ç­”é¢˜ç¯èŠ‚ï¼›ä¹Ÿå¯ä»¥é€šè¿‡æŠ€æœ¯æ‰‹æ®µå‰Šå³°ï¼Œæ¯”å¦‚é‡‡ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åŒ–ç”¨æˆ·è¯·æ±‚ï¼Œæˆ–è€…é‡‡ç”¨é™æµæ¼æ–—å¯¹æµé‡è¿›è¡Œå±‚å±‚è¿‡æ»¤ã€‚å‰Šå³°åˆåˆ†ä¸ºæ— æŸå’Œæœ‰æŸå‰Šå³°ã€‚æœ¬è´¨ä¸Šï¼Œ<strong>é™æµæ˜¯ä¸€ç§æœ‰æŸæŠ€æœ¯å‰Šå³°ï¼›è€Œå¼•å…¥éªŒè¯ç ã€é—®ç­”é¢˜ä»¥åŠå¼‚æ­¥åŒ–æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å½’ä¸ºæ— æŸå‰Šå³°ã€‚</strong></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ç”µå•†å¹³å°çº¿ä¸ŠçœŸå®åœºæ™¯ä¸‹çš„ç§’æ€æµé‡å›¾ï¼Œå› ä¸ºæ•°æ®ä¿å¯†çš„éœ€è¦ï¼Œè¿™é‡Œæˆ‘éšå»äº†å…·ä½“çš„æµé‡æ•°å­—ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªå›¾æœ‰ä¸ªéå¸¸æ˜æ˜¾çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯æ¯›åˆºç‰¹åˆ«å¤§ï¼Œæµé‡å‡ ç§’å†…çˆ¬å‡åˆ°å³°å€¼ï¼Œç„¶åé©¬ä¸Šæ‰ä¸‹æ¥ã€‚ä¸ç®¡æ˜¯å£ç½©ã€èŒ…å°ï¼Œè¿˜æ˜¯æ˜¥è¿çš„ç«è½¦ç¥¨ï¼Œéƒ½ç¬¦åˆè¿™æ ·çš„æµé‡ç‰¹ç‚¹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/35/64/35dc492a82da8e4bbc0188918dcc7964.png?wh=2464x1740\" alt=\"\"></p><p>æˆ‘ä»¬ç°åœ¨éœ€è¦åšçš„å°±æ˜¯é€šè¿‡å‰Šå³°å’Œé™æµï¼ŒæŠŠè¿™è¶…å¤§çš„ç¬æ—¶æµé‡å¹³ç¨³åœ°æ‰¿æ¥ä¸‹æ¥ï¼Œè½åˆ°ç§’æ€ç³»ç»Ÿé‡Œã€‚è¿™å°±çŠ¹å¦‚æ­¦ä¾ å°è¯´é‡Œï¼Œä¼—äººä»é«˜å¡”çºµèº«è·³ä¸‹ï¼Œå¼ æ— å¿Œè¿ç”¨ä¹¾å¤å¤§æŒªç§»ï¼ŒæŠŠå¯¹ä¼—äººä¼¤å®³æå¤§çš„å‚ç›´è‡ªç”±è½ä½“è¿åŠ¨æ”¹å˜ä¸ºæ°´å¹³è¿åŠ¨ï¼Œä½¿ä¹‹å®‰ç„¶è„±é™©ã€‚</p><!-- [[[read_end]]] --><h2>æµé‡å‰Šå³°</h2><p>å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»‹ç»è¿‡ç§’æ€çš„ä¸šåŠ¡ç‰¹ç‚¹æ˜¯åº“å­˜å°‘ï¼Œæœ€ç»ˆèƒ½å¤ŸæŠ¢åˆ°å•†å“çš„äººæ•°å–å†³äºåº“å­˜æ•°é‡ï¼Œè€Œå‚ä¸ç§’æ€çš„äººè¶Šå¤šï¼Œå¹¶å‘æ•°å°±è¶Šé«˜ï¼Œéšä¹‹æ— æ•ˆè¯·æ±‚ä¹Ÿå°±è¶Šå¤šã€‚ä½†ä»ä¸šåŠ¡æ–¹çš„è§’åº¦æ¥è¯´ï¼Œè‚¯å®šæ˜¯å¸Œæœ›æœ‰æ›´å¤šçš„äººå‚ä¸è¿›æ¥ï¼Œç‚¹å‡»â€œç«‹å³ç§’æ€â€æŒ‰é’®ä½“éªŒç§’æ€çš„ä¹è¶£ã€‚</p><p>ä»ä¸Šé¢çš„æµé‡ç›‘æ§å›¾å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç§’æ€å¼€å§‹çš„æ—¶åˆ»ï¼Œä¼šå‡ºç°å·¨å¤§çš„ç¬æ—¶æµé‡ï¼Œè¿™ä¸ªæµé‡å¯¹èµ„æºçš„æ¶ˆè€—ä¹Ÿæ˜¯å·¨å¤§ä¸”ç¬æ—¶çš„ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ”¯æ’‘ç§’æ€ç³»ç»Ÿçš„ç¡¬ä»¶èµ„æºæ˜¯æœ‰é™çš„ï¼Œå®ƒçš„å¤„ç†èƒ½åŠ›æ˜¯æ’å®šçš„ï¼Œå½“æœ‰ç§’æ€æ´»åŠ¨çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“ç¹å¿™å¯¼è‡´è¯·æ±‚å¤„ç†ä¸è¿‡æ¥ï¼Œè€Œæ²¡æœ‰æ´»åŠ¨çš„æ—¶å€™ï¼Œæœºå™¨åˆæ˜¯ä½è´Ÿè½½è¿è½¬ã€‚ä½†æ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·çš„ç§’æ€ä½“éªŒï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬çš„å¤„ç†èµ„æºåªèƒ½æŒ‰ç…§å¿™çš„æ—¶å€™æ¥é¢„ä¼°ï¼Œè¿™ä¼šå¯¼è‡´èµ„æºçš„ä¸€ä¸ªæµªè´¹ã€‚è¿™å°±å¥½æ¯”äº¤é€šå­˜åœ¨æ—©é«˜å³°å’Œæ™šé«˜å³°çš„é—®é¢˜ï¼Œæ‰€ä»¥æœ‰äº†å¤–ç‰Œé™è¡Œã€å°¾å·é™è¡Œç­‰å¤šç§é”™å³°è§£å†³æ–¹æ¡ˆã€‚</p><p>å› æ­¤æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€äº›<strong>è§„åˆ™</strong>ï¼Œå»¶ç¼“å¹¶å‘è¯·æ±‚ï¼Œç”šè‡³è¿‡æ»¤æ‰æ— æ•ˆçš„è¯·æ±‚ï¼Œè®©çœŸæ­£å¯ä»¥ä¸‹å•çš„è¯·æ±‚è¶Šå°‘è¶Šå¥½ã€‚æ€»ç»“æ¥è¯´ï¼Œå‰Šå³°çš„æœ¬è´¨ï¼Œä¸€æ˜¯è®©æœåŠ¡ç«¯å¤„ç†å˜å¾—æ›´åŠ å¹³ç¨³ï¼ŒäºŒæ˜¯èŠ‚çœæœåŠ¡å™¨çš„æœºå™¨æˆæœ¬ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é‡ç‚¹å­¦ä¹ å‡ ä¸ªå¸¸ç”¨çš„å‰Šå³°æ‰‹æ®µï¼šéªŒè¯ç ã€é—®ç­”é¢˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å±‚è¿‡æ»¤å’Œé™æµã€‚é¡ºä¾¿çœ‹çœ‹äº’è”ç½‘å¤§å‚é‡Œéƒ½ä¼šé‡‡ç”¨ä»€ä¹ˆæ ·çš„æ‰‹æ®µï¼Œä»¥åŠèƒŒåçš„æ€è€ƒé€»è¾‘ã€‚</p><h3>éªŒè¯ç å’Œé—®ç­”é¢˜</h3><p>åœ¨ç§’æ€äº¤æ˜“æµç¨‹ä¸­ï¼Œå¼•å…¥éªŒè¯ç å’Œé—®ç­”é¢˜ï¼Œæœ‰ä¸¤ä¸ªç›®çš„ï¼šä¸€æ˜¯å¿«é€Ÿæ‹¦æˆªæ‰éƒ¨åˆ†åˆ·å­æµé‡ï¼Œé˜²æ­¢æœºå™¨ä½œå¼Šï¼Œèµ·åˆ°é˜²åˆ·çš„ä½œç”¨ï¼›äºŒæ˜¯å¹³æ»‘ç§’æ€çš„æ¯›åˆºè¯·æ±‚ï¼Œå»¶ç¼“å¹¶å‘ï¼Œå¯¹æµé‡è¿›è¡Œå‰Šå³°ã€‚</p><p>è®©ç”¨æˆ·åœ¨ç§’æ€å‰è¾“å…¥éªŒè¯ç æˆ–è€…åšé—®ç­”é¢˜ï¼Œä¸åŒç”¨æˆ·çš„æ‰‹é€Ÿæœ‰å¿«æœ‰æ…¢ï¼Œè¿™å°±èµ·åˆ°äº†è®©1sçš„ç¬æ—¶æµé‡å¹³å‡åˆ°30sç”šè‡³1åˆ†é’Ÿçš„å¹³æ»‘æµé‡ä¸­ï¼Œè¿™æ ·å°±ä¸éœ€è¦å †ç§¯è¿‡å¤šçš„æœºå™¨åº”å¯¹1sçš„ç¬æ—¶æµé‡äº†ã€‚</p><p>ä»¥ä¸‹æ˜¯æµç¨‹å›¾ï¼Œæˆ‘æ¥è§£é‡Šä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a7/6d/a7e4c6a0af9c9c22db57d24e8910676d.jpg?wh=2036x1130\" alt=\"\"></p><p>è®¾è®¡éªŒè¯ç æµç¨‹ï¼Œä¸€èˆ¬æ˜¯åœ¨ç”¨æˆ·è¿›å…¥è¯¦æƒ…é¡µæ—¶ï¼Œå…ˆåˆ¤åˆ«ç§’æ€æ´»åŠ¨æ˜¯å¦å·²ç»å¼€å§‹ï¼Œå¦‚æœå·²ç»å¼€å§‹ï¼ŒåŒæ—¶ç§’æ€æ´»åŠ¨ä¹Ÿé…ç½®äº†éœ€è¦æ ¡éªŒéªŒè¯ç æ ‡è¯†ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»ç§’æ€ç³»ç»Ÿè·å–å›¾ç‰‡éªŒè¯ç ï¼Œå¹¶è¿›è¡Œæ¸²æŸ“ï¼›ç”¨æˆ·æ‰‹å·¥è¾“å…¥éªŒè¯ç åï¼Œæäº¤ç»™ç§’æ€ç³»ç»Ÿè¿›è¡ŒéªŒè¯ç æ ¡éªŒï¼Œå¦‚æœé€šè¿‡å°±è·³è½¬è‡³ç§’æ€ç»“ç®—é¡µã€‚</p><p>ä¸Šå›¾å¢åŠ çš„çº¢çº¿éƒ¨åˆ†å°±æ˜¯å¼•å…¥äº†éªŒè¯ç çš„ç§’æ€æµç¨‹ã€‚å½“ç„¶ï¼Œæˆ‘è¿™é‡Œä»‹ç»çš„ï¼Œæ˜¯æŠŠéªŒè¯ç åŠŸèƒ½ä½œä¸ºç§’æ€ç³»ç»Ÿçš„ä¸€ä¸ªæ¨¡å—äº†ï¼Œè€Œå¤§å…¬å¸ä¸€èˆ¬éƒ½ä¼šæœ‰å•ç‹¬çš„éªŒè¯ç æœåŠ¡ï¼Œæˆ‘ä»¬ä¸ç”¨è‡ªå·±é€ è½®å­ï¼Œåªè¦è¿›è¡Œç³»ç»Ÿå¯¹æ¥å°±è¡Œäº†ã€‚</p><p>ä¸‹é¢æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹éªŒè¯ç çš„å®ç°ï¼Œé€šè¿‡ä¸Šå›¾å¾—çŸ¥ï¼ŒéªŒè¯ç æœåŠ¡éœ€æä¾›ä¸¤ä¸ªåŸºæœ¬çš„åŠŸèƒ½ï¼šç”ŸæˆéªŒè¯ç å’Œæ ¡éªŒéªŒè¯ç ã€‚</p><p><strong>ç”ŸæˆéªŒè¯ç </strong><strong>ï¼Œ</strong>å…ˆçœ‹æ¥å£è®¾è®¡å¦‚ä¸‹ï¼š</p><pre><code class=\"language-sql\">POST /seckill/captchas.jpg?skuId=10001\n</code></pre><p>å¯¹åº”çš„åç«¯ä»£ç å®ç°ï¼š</p><pre><code class=\"language-sql\">    /**\n\t * ç”Ÿæˆå›¾ç‰‡éªŒè¯ç \n\t */\n\t@RequestMapping(value=\"/seckill/captchas.jpg\", method=RequestMethod.POST})\n\t@ResponseBody\n\tpublic SeckillResponse&lt;String&gt; genCaptchas(String skuId, HttpServletRequest request, HttpServletResponse response) {\n        //ä»cookieä¸­å–å‡ºuser\n        String user = getUserFromCookie(request);\n        //æ ¹æ®skuIdå’Œuserç”Ÿæˆå›¾ç‰‡\n        BufferedImage img=createCaptchas(user, skuId);\n\t\ttry {\n\t\t\tOutputStream out=response.getOutputStream();\n\t\t\tImageIO.write(img, \"JPEG\", out);\n\t\t\tout.flush();\n\t\t\tout.close();\n\t\t\treturn null;&nbsp;\n\t\t} catch (IOException e) {\n\t\t\te.printStackTrace();\n\t\t\treturn SeckillResponse.error(ErrorMsg.SECKILL_FAIL);\n\t\t}\n\t}\n\n    /**\n     * ç”ŸæˆéªŒè¯ç å›¾ç‰‡æ–¹æ³•\n     */\n    public BufferedImage createCaptchas(String user, String skuId) {\n\t\tint width=90;\n\t\tint height=40;\n\t\tBufferedImage img=new BufferedImage(width,height,BufferedImage.TYPE_INT_RGB);\n\t\tGraphics graph=img.getGraphics();\n\t\tgraph.setColor(new Color(0xDCDCDC));\n\t\tgraph.fillRect(0, 0, width, height);\n\t\tRandom random=new Random();\n\t\t//ç”ŸæˆéªŒè¯ç \n\t\tString formula=createFormula(random);\n\t\tgraph.setColor(new Color(0,100,0));\n\t\tgraph.setFont(new Font(\"Candara\",Font.BOLD,24));\n\t\t//å°†éªŒè¯ç å†™åœ¨å›¾ç‰‡ä¸Š\n\t\tgraph.drawString(formula, 8, 24);\n\t\tgraph.dispose();\n\t\t//è®¡ç®—éªŒè¯ç çš„å€¼\n\t\tint vCode=calc(formula);\n\t\t//å°†è®¡ç®—ç»“æœä¿å­˜åˆ°redisä¸Šé¢å»ï¼Œè¿‡æœŸæ—¶é—´1åˆ†é’Ÿ\n\t\tcacheMgr.set(\"CAPTCHA_\"+user+\"_\"+skuId, vCode, 60000);\n\t\treturn img;\n\t}\n\n\tprivate String createFormula(Random random) {\n\t\tprivate static char[]ops=new char[] {'+','-','*'};\n        //ç”Ÿæˆ10ä»¥å†…çš„éšæœºæ•°\n\t\tint num1=random.nextInt(10);\n\t\tint num2=random.nextInt(10);\n\t\tint num3=random.nextInt(10);\n\t\tchar oper1=ops[random.nextInt(3)];\n\t\tchar oper2=ops[random.nextInt(3)];\n\t\tString exp=\"\"+num1+oper1+num2+oper2+num3;\n\t\treturn exp;\n\t}\n\n    private static int calc(String formula) {\n\t\ttry {\n\t\t\tScriptEngineManager manager=new ScriptEngineManager();\n\t\t\tScriptEngine engine=manager.getEngineByName(\"JavaScript\");\n\t\t\treturn (Integer) engine.eval(formula);\n\t\t}catch(Exception e){\n\t\t\te.printStackTrace();\n\t\t\treturn 0;\n\t\t}\n\t}\n</code></pre><p>ä»¥ä¸Šæ˜¯è‡ªå·±ç”Ÿæˆå›¾ç‰‡éªŒè¯ç çš„æ–¹å¼ï¼Œæ–¹ä¾¿èµ·è§ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨Googleæä¾›çš„KaptchaåŒ…ç”Ÿæˆå›¾ç‰‡éªŒè¯ç ã€‚</p><p>åŒæ—¶ï¼Œä¸ºäº†è®©äº¤äº’æ›´åŠ å®‰å…¨ï¼Œé¿å…è¢«ç¯¡æ”¹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åŠ å…¥ç­¾åæœºåˆ¶ï¼Œåç«¯åœ¨è¿”å›ç»™å‰ç«¯å›¾ç‰‡éªŒè¯ç çš„æ—¶å€™ï¼ŒåŒæ—¶è¿”å›ä¸€ä¸ªç­¾åï¼Œå‰ç«¯åœ¨ç‚¹å‡»â€œæŠ¢è´­â€æŒ‰é’®çš„æ—¶å€™ï¼ŒæŠŠç”¨æˆ·è¾“å…¥çš„éªŒè¯ç ä»¥åŠç­¾åæäº¤ç»™åç«¯æœåŠ¡è¿›è¡ŒéªŒè¯ã€‚è¿™ä¸ªç­¾åå¯ä»¥è®¾è®¡å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">signature=base64(timestamp,md5(timestamp,vCode,skuId,user,randomSalt)\n</code></pre><p>è¿™é‡Œtimestampå–ç”ŸæˆéªŒè¯ç vCodeæ—¶çš„æ—¶é—´æˆ³ï¼ŒrandomSaltå¯ä»¥ç†è§£ä¸ºåç«¯çš„ä¸€ä¸ªç§é’¥ã€‚é‚£ä¹ˆåœ¨å‰é¢ä»£ç çš„ç¬¬44è¡Œï¼Œæˆ‘ä»¬å­˜å…¥Redisçš„å€¼å°±è¦æ¢æˆè¿™ä¸ªsignatureäº†ã€‚</p><p>å½“å‰ç«¯ç‚¹å‡»â€œæŠ¢è´­â€æŒ‰é’®æ—¶ï¼Œè°ƒç”¨åç«¯æœåŠ¡å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">POST /seckill/settlement.html?skuId=10001&amp;signature=ad6543audhhw13dg&amp;timestamp=1345611143&amp;newCode=54\n</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹<strong>æ ¡éªŒéªŒè¯ç </strong><strong>ã€‚</strong>æ ¡éªŒçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä»å‰ç«¯çš„HTTPè¯·æ±‚é‡Œï¼Œå–å¾—skuIdã€userã€signatureã€timestampå’ŒnewCodeï¼Œé¦–å…ˆéªŒè¯timestampæ˜¯å¦å·²ç»è¿‡æœŸï¼Œç„¶åæ ¹æ®ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç å†…å®¹newCodeé‡æ–°è®¡ç®—ç­¾ånewSignatureï¼Œå¹¶å’ŒRedisé‡Œçš„signatureè¿›è¡Œæ¯”å¯¹ï¼Œæ¯”å¯¹ä¸€è‡´è¡¨ç¤ºéªŒè¯ç æ ¡éªŒé€šè¿‡ã€‚ç„¶åæˆ‘ä»¬éœ€è¦åˆ æ‰Redisçš„å†…å®¹ï¼Œé¿å…è¢«é‡å¤éªŒè¯ï¼Œè¿™æ ·çš„è¯ä¸€ä¸ªéªŒè¯ç å°±åªä¼šè¢«éªŒè¯ä¸€æ¬¡äº†ã€‚</p><h3>æ¶ˆæ¯é˜Ÿåˆ—</h3><p>é™¤äº†éªŒè¯ç å’Œé—®ç­”é¢˜ï¼Œå¦ä¸€ç§å‰Šå³°æ–¹å¼æ˜¯<strong>å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚</p><p>å½“æœåŠ¡Aä¾èµ–æœåŠ¡Bæ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹æœåŠ¡Aä¼šç›´æ¥é€šè¿‡RPCè°ƒç”¨æœåŠ¡Bçš„æ¥å£ï¼Œå½“æœåŠ¡Aè°ƒç”¨çš„æµé‡å¯æ§ï¼Œä¸”æœåŠ¡Bçš„TP99å’ŒQPSèƒ½æ»¡è¶³è°ƒç”¨æ—¶ï¼Œè¿™æ˜¯æœ€ç®€å•ç›´æ¥çš„è°ƒç”¨æ–¹å¼ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œç›®å‰å¤§éƒ¨åˆ†çš„å¾®æœåŠ¡é—´è°ƒç”¨ä¹Ÿéƒ½æ˜¯è¿™æ ·åšçš„ã€‚</p><p>ä½†æ˜¯ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæœåŠ¡Açš„æµé‡éå¸¸é«˜ï¼ˆå‡è®¾10ä¸‡QPSï¼‰ï¼Œè¿œè¿œå¤§äºæœåŠ¡Bæ‰€èƒ½æ”¯æŒçš„èƒ½åŠ›ï¼ˆå‡è®¾1ä¸‡QPSï¼‰ï¼Œé‚£ä¹ˆæœåŠ¡Bçš„CPUå¾ˆå¿«å°±ä¼šå‡é«˜ï¼ŒTP99ä¹Ÿéšä¹‹å˜é«˜ï¼Œæœ€ç»ˆæœåŠ¡Bè¢«æœåŠ¡Açš„æµé‡å†²å®ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œæˆ‘ä»¬æŠŠä¸€æ­¥è°ƒç”¨çš„ç›´æ¥ç´§è€¦åˆæ–¹å¼ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ”¹é€ æˆä¸¤æ­¥å¼‚æ­¥è°ƒç”¨ï¼Œè®©è¶…è¿‡æœåŠ¡BèŒƒå›´çš„æµé‡ï¼Œæš‚å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—é‡Œï¼Œç”±Bæ ¹æ®è‡ªå·±çš„æœåŠ¡èƒ½åŠ›æ¥å†³å®šå¤„ç†å¿«æ…¢ï¼Œè¿™å°±æ˜¯é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè°ƒç”¨è§£è€¦çš„å¸¸è§æ‰‹æ®µã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b8/6c/b8f142e7926cd954935497917711ae6c.jpg?wh=1530x807\" alt=\"\"></p><p>å¸¸è§çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—æœ‰Kafkaã€RocketMQå’ŒRabbitMQç­‰ï¼Œå¤§å‚çš„åŸºç¡€ä¸­é—´ä»¶éƒ¨é—¨ä¸€èˆ¬ä¹Ÿä¼šæ ¹æ®è‡ªå·±å…¬å¸çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œè‡ªç ”é€‚åˆè‡ªå·±çš„MQç³»ç»Ÿã€‚å¯¹ä¸€èˆ¬çš„åœºæ™¯æ¥è¯´ï¼Œæˆ‘æ¨èä½ ç”¨RocketMQï¼Œåº”è¯¥èƒ½è§£å†³ä½ å¤§éƒ¨åˆ†çš„é—®é¢˜ã€‚</p><p>ä»¥ä¸Šæ˜¯é€šè¿‡MQè¿›è¡Œè°ƒç”¨è§£è€¦çš„åŸºæœ¬æ€è·¯ï¼Œç°åœ¨æˆ‘ä»¬å›åˆ°ç§’æ€çš„åœºæ™¯ï¼Œçœ‹çœ‹åº”è¯¥æ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿè¯·çœ‹ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/94/df/944yy258d21de2f70b2acc1f0e217edf.jpg?wh=2230x1026\" alt=\"\"></p><p>ä»¥ä¸Šçº¢è‰²å’Œè“è‰²çš„éƒ¨åˆ†ï¼Œå°±æ˜¯é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦åï¼Œè¯¦æƒ…é¡µç³»ç»Ÿå’Œç§’æ€ç³»ç»Ÿå„è‡ªå¤„ç†çš„éƒ¨åˆ†ã€‚å› ä¸ºè§£è€¦äº†ï¼Œæ‰€ä»¥åœ¨ç¬¬6æ­¥ä¸‹å•ä¹‹åï¼Œå…¶å®æ˜¯ä¸çŸ¥é“ç§’æ€ç»“æœçš„ï¼Œå› æ­¤åœ¨ç¬¬11æ­¥ï¼Œéœ€è¦å‰ç«¯å®šæœŸå»æŸ¥è¯¢ç§’æ€ç»“æœåé¦ˆç»™ç”¨æˆ·ã€‚è€Œåœ¨ç§’æ€ç³»ç»Ÿæ‹‰å–æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œä¹Ÿæœ‰ä¸ªå°æŠ€å·§ï¼Œé‚£å°±æ˜¯å½“å‰é¢çš„è¯·æ±‚å·²ç»æŠŠåº“å­˜æ¶ˆè€—å…‰ä¹‹åï¼Œåœ¨ç¼“å­˜é‡Œè®¾ç½®å ä½ç¬¦ï¼Œè®©åç»­çš„è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œä»è€Œæœ€å¿«åœ°è¿›è¡Œå“åº”ã€‚</p><h2>é™æµ</h2><p>å‰Šå³°çš„æ–¹å¼ï¼Œå‰é¢ä»‹ç»äº†éªŒè¯ç /é—®ç­”é¢˜ä»¥åŠæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™äº›æ–¹å¼ä½¿æµé‡å³°å€¼å˜å¾—æ›´åŠ å¹³æ»‘ï¼Œä½†ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†æŠ¢è´­ä½“éªŒï¼Œå®¹æ˜“å¼•å‘ç”¨æˆ·å’¨è¯¢å’ŒæŠ•è¯‰ã€‚é‚£æœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹å¼å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å­¦ä¹ ä¸‹é™æµï¼Œçœ‹çœ‹å¦‚ä½•é€šè¿‡é™æµå®ç°å‰Šå³°ã€‚</p><p>é™æµæ˜¯ç³»ç»Ÿè‡ªæˆ‘ä¿æŠ¤çš„æœ€ç›´æ¥æ‰‹æ®µï¼Œå†å‰å®³çš„ç³»ç»Ÿï¼Œæ€»æœ‰æ‰€èƒ½æ‰¿è½½çš„èƒ½åŠ›ä¸Šé™ï¼Œä¸€æ—¦æµé‡çªç ´è¿™ä¸ªä¸Šé™ï¼Œå°±ä¼šå¼•èµ·å®ä¾‹å®•æœºï¼Œè¿›è€Œå‘ç”Ÿç³»ç»Ÿé›ªå´©ï¼Œå¸¦æ¥ç¾éš¾æ€§åæœã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/420777\">ç¬¬ä¸€è®²</a>çš„æ—¶å€™ï¼Œæˆ‘æœ‰å’Œä½ æåˆ°è¿‡æµé‡æ¼æ–—çš„æ¦‚å¿µï¼Œå¯¹äºç§’æ€æµç¨‹æ¥è¯´ï¼Œä»ç”¨æˆ·å¼€å§‹å‚ä¸ç§’æ€ï¼Œåˆ°ç§’æ€æˆåŠŸæ”¯ä»˜å®Œæˆï¼Œå®é™…ä¸Šç»å†äº†å¾ˆå¤šçš„ç³»ç»Ÿé“¾è·¯è°ƒç”¨ï¼Œä¸­é—´æœ‰éå¸¸åºæ‚çš„ç³»ç»Ÿåœ¨æ”¯æ’‘ï¼Œæ¯”å¦‚æœ‰å•†è¯¦ã€é£æ§ã€ç™»å½•ã€é™è´­ã€è´­ç‰©è½¦ä»¥åŠè®¢å•ç­‰å¾ˆå¤šäº¤æ˜“ç³»ç»Ÿã€‚</p><p>é‚£ä¹ˆå¯¹äºç§’æ€çš„ç¬æ—¶æµé‡ï¼Œå¦‚æœä¸åŠ ç­›é€‰ï¼Œä¸åšé™åˆ¶ï¼Œç›´æ¥æŠŠæµé‡ä¼ é€’ç»™ä¸‹æ¸¸å„ä¸ªç³»ç»Ÿï¼Œå¯¹æ•´ä¸ªäº¤æ˜“ç³»ç»Ÿéƒ½æ˜¯éå¸¸å¤§çš„æŒ‘æˆ˜ï¼Œä¹Ÿæ˜¯å¾ˆå¤§çš„èµ„æºæµªè´¹ï¼Œæ‰€ä»¥ä¸»æµçš„åšæ³•æ˜¯ä»ä¸Šæ¸¸å¼€å§‹ï¼Œå¯¹æµé‡è¿›è¡Œé€çº§é™æµï¼Œåˆ†å±‚è¿‡æ»¤ï¼Œä¼˜è´¨çš„æœ‰æ•ˆçš„æµé‡æœ€ç»ˆæ‰èƒ½å‚ä¸ä¸‹å•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e8/cd/e8e9d01c9e384c8eb7ee6bc908901dcd.jpg?wh=4247x2227\" alt=\"\"></p><p>è¿™æ˜¯ç³»ç»Ÿçš„<strong>æµé‡æ¼æ–—ç¤ºæ„å›¾</strong>ï¼Œé€šè¿‡é£æ§å’Œé˜²åˆ·ç­›é€‰åˆ·å­æµé‡ï¼Œé€šè¿‡é™è´­å’Œé¢„çº¦æ ¡éªŒè¿‡æ»¤æ— æ•ˆæµé‡ï¼Œé€šè¿‡é™æµä¸¢å¼ƒå¤šä½™æµé‡ï¼Œæœ€ç»ˆç§’æ€ç³»ç»Ÿç»™åˆ°ä¸‹æ¸¸çš„æµé‡å°±æ˜¯éå¸¸ä¼˜è´¨ä¸”å°‘é‡çš„äº†ã€‚</p><p>é™æµå¸¸ç”¨çš„ç®—æ³•æœ‰ä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶ï¼Œæœ‰å…³è¿™ä¸¤ä¸ªç®—æ³•çš„ä¸“ä¸šä»‹ç»ï¼Œä½ å¯ä»¥å‚è€ƒï¼š<a href=\"https://hansliu.com/posts/2020/11/what-is-token-bucket-and-leaky-bucket-algorithms.html\">https://hansliu.com/posts/2020/11/what-is-token-bucket-and-leaky-bucket-algorithms.html</a></p><p><img src=\"https://static001.geekbang.org/resource/image/fb/69/fb564594bb1bb523dde77b678822c269.jpg?wh=2028x844\" alt=\"\"></p><p>ä¸‹é¢æˆ‘ä»¬é’ˆå¯¹demo-nginxå’Œdemo-webä¸¤ä¸ªåº”ç”¨ï¼Œä»‹ç»ä¸€ä¸‹å…·ä½“çš„é™æµæ–¹æ³•ã€‚</p><h3><strong>demo-nginxç½‘å…³é™æµ</strong></h3><p>å…ˆå¼€å§‹<strong>å‡†å¤‡å·¥ä½œ</strong>ï¼Œä¿—è¯è¯´ï¼Œå·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œåœ¨å¼€å‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠNginxçš„æ—¥å¿—ç»™é…ç½®èµ·æ¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­å¼€å‘çš„è°ƒè¯•ä¸éªŒè¯ã€‚</p><p></p><p>Nginxæ—¥å¿—é…ç½®ï¼šNginxä¸»è¦æœ‰ä¸¤ç§ç±»å‹çš„æ—¥å¿—æ–‡ä»¶ã€‚</p><p>ä¸€ä¸ªæ˜¯error_logï¼Œç”¨æ¥è®°å½•æˆ‘ä»¬çš„ç³»ç»Ÿæ—¥å¿—ï¼Œä»¥åŠä¸»åŠ¨æ‰“å°çš„ä¸šåŠ¡æ—¥å¿—ï¼Œé…ç½®è¯­æ³•ä¸ºï¼š</p><pre><code class=\"language-sql\">\terror_log &lt;æ—¥å¿—æ–‡ä»¶è·¯å¾„&gt; &lt;æ—¥å¿—çº§åˆ«&gt;;\n</code></pre><p>å¦ä¸€ä¸ªæ˜¯access_logï¼Œè¿™ä¸ªæ—¥å¿—ä¸»è¦ç”¨æ¥è®°å½•æˆ‘ä»¬çš„è¯·æ±‚å’Œè¿”å›ç›¸å…³çš„ä¿¡æ¯ï¼Œé…ç½®è¯­æ³•ä¸ºï¼š</p><pre><code class=\"language-sql\">\taccess_log &lt;æ—¥å¿—æ–‡ä»¶è·¯å¾„&gt; &lt;æ—¥å¿—æ ¼å¼å®šä¹‰çš„åç§°&gt;;\n</code></pre><p>å¦‚æœæƒ³è‡ªå®šä¹‰è¾“å‡ºæ—¥å¿—æ ¼å¼ï¼Œéœ€è¦ä½¿ç”¨log_formatæ¥å®ç°ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥é…ç½®ä¸€ä¸‹è¿™ä¸¤ç§æ—¥å¿—ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åœ¨nginx.confä¸­å®šä¹‰ä¸€ä¸ªåä¸ºaccessçš„æ—¥å¿—æ ¼å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/75/b3/75a292b5508576f439fa7888c2c3e9b3.png?wh=1920x750\" alt=\"å›¾ç‰‡\"></p><p></p><p>ç„¶ååœ¨domain.comä¸­é…ç½®error_logå’Œaccess_logï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/12/39/12f71dfa20538527c923591ff6595639.jpg?wh=1920x509\" alt=\"å›¾ç‰‡\"></p><p></p><p>è¿™é‡Œæˆ‘ä½¿ç”¨äº†å†…ç½®å˜é‡ä»¥åŠè‡ªå®šä¹‰å˜é‡$user_idï¼ˆé€šè¿‡set_by_lua_blockå®šä¹‰å¹¶èµ‹å€¼ï¼‰ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»æŠŠæ—¥å¿—é…ç½®å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹ä»Šå¤©çš„é‡å¤´æˆå§ï¼Œå°±ä»Nginxé™æµå¼€å§‹è®²èµ·ã€‚</p><p>è¿™é‡Œçš„Nginxé™æµï¼Œä¸»è¦æ˜¯ä¾èµ–Nginxè‡ªå¸¦çš„é™æµåŠŸèƒ½ï¼Œé’ˆå¯¹è¯·æ±‚çš„æ¥æºIPæˆ–è€…è‡ªå®šä¹‰çš„ä¸€ä¸ªå…³é”®å‚æ•°æ¥åšé™æµï¼Œæ¯”å¦‚ç”¨æˆ·IDã€‚å…¶é…ç½®é™æµè§„åˆ™çš„è¯­æ³•ä¸ºï¼š</p><pre><code class=\"language-sql\">limit_req_zone &lt;å˜é‡å&gt; zone=&lt;é™æµè§„åˆ™åç§°&gt;:&lt;å†…å­˜å¤§å°&gt; rate=&lt;é€Ÿç‡é˜ˆå€¼&gt;r/s;\n</code></pre><p>è§£é‡Šä¸€ä¸‹ï¼š</p><ul>\n<li>ä»¥ä¸Šlimit_req_zoneæ˜¯å…³é”®å­—ï¼Œ&lt;å˜é‡å&gt;æ˜¯æŒ‡å®šæ ¹æ®ä»€ä¹ˆæ¥é™æµï¼›</li>\n<li>zoneæ˜¯å…³é”®å­—ï¼Œ&lt;é™æµè§„åˆ™åç§°&gt;æ˜¯å®šä¹‰è§„åˆ™åç§°ï¼Œåç»­ä»£ç ä¸­å¯ä»¥æŒ‡å®šä½¿ç”¨å“ªä¸ªè§„åˆ™ï¼›</li>\n<li>&lt;å†…å­˜å¤§å°&gt;æ˜¯æŒ‡å£°æ˜å¤šå¤§å†…å­˜æ¥æ”¯æ’‘é™æµçš„åŠŸèƒ½ï¼›</li>\n<li>rateæ˜¯å…³é”®å­—ï¼Œå¯ä»¥æŒ‡å®šé™æµçš„é˜ˆå€¼ï¼Œå•ä½r/sæ„ä¸ºæ¯ç§’å…è®¸é€šè¿‡çš„è¯·æ±‚ï¼Œè¿™ä¸ªç®—æ³•æ˜¯ä½¿ç”¨ä»¤ç‰Œæ¼æ¡¶çš„æ€æƒ³æ¥å®ç°çš„ã€‚</li>\n</ul><p>é‚£ä¹ˆæ˜ç™½äº†è¯­æ³•ä¹‹åï¼Œä¸‹é¢æˆ‘ä»¬å°±<strong>åŠ¨æ‰‹å®šä¹‰ä¸€ä¸ªé™æµè§„åˆ™</strong>ï¼Œçœ‹çœ‹å®é™…æ•ˆæœã€‚</p><pre><code class=\"language-plain\">http {\n    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s; \n    server {\n        location /search/ {\n            limit_req zone=one burst=2 nodelay;\n        }\n    }\n}  \n</code></pre><p>ä»¥ä¸Šæ˜¯åŸºäºIPåœ°å€è¿›è¡Œé™æµçš„ä¾‹å­ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…çš„æƒ…å†µè°ƒæ•´rateå’Œburstçš„å€¼ï¼Œåœ¨ç§’æ€çš„åœºæ™¯ä¸‹ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šæŠŠrateå’Œburstè®¾ç½®çš„å¾ˆä½ï¼Œå¯ä»¥éƒ½ä¸º1ï¼Œå³è¦æ±‚1ä¸ªIP1ç§’å†…åªèƒ½è®¿é—®1æ¬¡ã€‚</p><p>ä½†æ ¹æ®IPåœ°å€è®¾ç½®é™æµæ—¶è¦æ…é‡ï¼Œä¼šå­˜åœ¨è¯¯æ€çš„æƒ…å†µï¼Œç‰¹åˆ«åƒå…¬å¸å†…ç”¨æˆ·ï¼Œä»–ä»¬çš„å‡ºå£IPå°±é‚£ä¹ˆå‡ ä¸ªï¼Œå¾ˆå®¹æ˜“å°±è§¦å‘äº†é™æµï¼Œæ‰€ä»¥æˆ‘ä¸€èˆ¬åœ¨å‚ä¸é˜¿é‡Œã€è‹å®æˆ–äº¬ä¸œçš„ç§’æ€æ´»åŠ¨æ—¶ï¼Œéƒ½ä¼šåˆ‡æ¢åˆ°4Gç½‘ç»œï¼Œé¿å…ç”¨å…¬å¸ç½‘ç»œã€‚</p><p>é™¤äº†åŸºäºIPé™æµå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾è®¡åŸºäºç”¨æˆ·çš„userIdè¿›è¡Œé™æµã€‚</p><pre><code class=\"language-plain\">limit_req_zone $user_id zone=limit_by_user:10m rate=1r/s; \n</code></pre><h3><strong>demo-webåº”ç”¨å±‚é™æµ</strong></h3><p>ä»¥ä¸Šæ˜¯Nginxç½‘å…³å±‚çš„é™æµï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥åº”ç”¨å±‚çš„é™æµã€‚åº”ç”¨å±‚çš„é™æµæ‰‹æ®µä¹Ÿæ˜¯æ¯”è¾ƒå¤šçš„ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»é€šè¿‡çº¿ç¨‹æ± å’ŒAPIé™æµçš„æ–¹æ³•ã€‚</p><p><strong>çº¿ç¨‹æ± é™æµ</strong></p><p>JavaåŸç”Ÿçš„çº¿ç¨‹æ± åŸç†ç›¸ä¿¡ä½ éå¸¸æ¸…æ¥šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œé…ç½®æœ€å¤§è¿æ¥æ•°ï¼Œä»¥è¯·æ±‚å¤„ç†é˜Ÿåˆ—é•¿åº¦ä»¥åŠæ‹’ç»ç­–ç•¥ç­‰å‚æ•°æ¥è¾¾åˆ°é™æµçš„ç›®çš„ã€‚å½“å¤„ç†é˜Ÿåˆ—æ»¡ï¼Œè€Œä¸”æœ€å¤§çº¿ç¨‹éƒ½åœ¨å¤„ç†æ—¶ï¼Œå¤šä½™çš„è¯·æ±‚å°±ä¼šè¢«æ‹’ç»ç­–ç•¥ä¸¢å¼ƒï¼Œä¹Ÿå°±æ˜¯è¢«é™æµäº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7f/56/7f30154bdbc6d9f085dc92bde0216856.jpg?wh=1385x786\" alt=\"\"></p><p><strong>APIé™æµ</strong></p><p>ä¸Šé¢ä»‹ç»çš„çº¿ç¨‹æ± é™æµå¯ä»¥çœ‹åšæ˜¯ä¸€ç§å¹¶å‘æ•°é™æµï¼Œå¯¹äºå¹¶å‘æ•°é™æµæ¥è¯´ï¼Œå®é™…ä¸ŠæœåŠ¡æä¾›çš„QPSèƒ½åŠ›æ˜¯å’Œåç«¯å¤„ç†çš„å“åº”æ—¶é•¿æœ‰å…³ç³»çš„ï¼Œåœ¨å¹¶å‘æ•°æ’å®šçš„æƒ…å†µä¸‹ï¼ŒTP99è¶Šä½ï¼ŒQPSå°±è¶Šé«˜ã€‚</p><p>ç„¶è€Œå¤§éƒ¨åˆ†æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›æ ¹æ®QPSå¤šå°‘æ¥è¿›è¡Œé™æµï¼Œè¿™æ—¶å°±ä¸èƒ½ç”¨çº¿ç¨‹æ± ç­–ç•¥äº†ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Googleæä¾›çš„RateLimiterå¼€æºåŒ…ï¼Œè‡ªå·±æ‰‹å†™ä¸€ä¸ªåŸºäºä»¤ç‰Œæ¡¶çš„é™æµæ³¨è§£å’Œå®ç°ï¼Œåœ¨ä¸šåŠ¡APIä»£ç é‡Œä½¿ç”¨ã€‚å½“ç„¶äº†ï¼Œå¤§å‚ä¸­éƒ½ä¼šæœ‰é€šç”¨çš„é™æµæœºåˆ¶ï¼Œä½ ç›´æ¥ç”¨å°±è¡Œäº†ã€‚</p><pre><code class=\"language-plain\">/**\t\n * è‡ªå®šä¹‰æ³¨è§£ &nbsp;é™æµ\t\n */\t\n\n@Target({ElementType.PARAMETER, ElementType.METHOD})\t\n@Retention(RetentionPolicy.RUNTIME)\t\n@Documented\t\npublic @interface MyRateLimit {\t\n &nbsp; &nbsp; String description()&nbsp;default \"\";\t\n}\n</code></pre><p>æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªåˆ‡é¢ï¼š</p><pre><code class=\"language-plain\">\n/**\t\n * é™æµ AOP\t\n */\t\n\n@Component\t\n@Scope\t\n@Aspect\t\npublic class LimitAspect {\t\n &nbsp; &nbsp;//å¼•ç”¨RateLimiterï¼Œå†…éƒ¨æ˜¯åŸºäºä»¤ç‰Œæ¡¶å®ç°çš„\t\n &nbsp; &nbsp;private static RateLimiter rateLimiter = RateLimiter.create(100.0);\t\n\n &nbsp; &nbsp;//å®šä¹‰é™æµæ³¨è§£çš„pointcut\t\n &nbsp; &nbsp;@Pointcut(\"@annotation(com.ecommerce.seckill.aop.MyRateLimit)\") &nbsp;\t\n &nbsp; &nbsp;public void MyRateLimitAspect() {\t\n &nbsp; &nbsp;}\t\n\n &nbsp; &nbsp;@Around(\"MyRateLimitAspect()\")\t\n &nbsp; &nbsp;public &nbsp;Object around(ProceedingJoinPoint joinPoint) { \t\n &nbsp; &nbsp; &nbsp; &nbsp;Boolean flag = rateLimiter.tryAcquire();\t\n &nbsp; &nbsp; &nbsp; &nbsp;Object obj = null;\t\n &nbsp; &nbsp; &nbsp; &nbsp;try {\t\n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(flag){\t\n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;obj = joinPoint.proceed();\t\n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}\t\n &nbsp; &nbsp; &nbsp; &nbsp;} catch (Throwable e) {\t\n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;e.printStackTrace();\t\n &nbsp; &nbsp; &nbsp; &nbsp;}\t\n &nbsp; &nbsp; &nbsp; &nbsp;return obj;\t\n &nbsp; &nbsp;}\t\n}\n</code></pre><p>ä¸šåŠ¡å±‚ä»£ç å®ç°ï¼š</p><pre><code class=\"language-plain\">@Override\t\n@MyRateLimit\t\n@Transactional\t\npublic SeckillResponse initData(String skuId, String userName) {\t\n &nbsp; &nbsp;//æ­¤æ¬¡ä¸ºä¸šåŠ¡ä»£ç å®ç°\t\n}\n</code></pre><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬ä»‹ç»äº†å‰Šå³°çš„å¤šç§æ‰‹æ®µï¼Œæœ‰éªŒè¯ç ã€é—®ç­”é¢˜ã€æ¶ˆæ¯é˜Ÿåˆ—ä»¥åŠé™æµç­‰ã€‚å®é™…ä¸Šï¼Œè¿™äº›å‰Šå³°çš„æ–¹å¼éƒ½å¯ä»¥è¾¾åˆ°æ§åˆ¶æµé‡çš„ç›®çš„ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚</p><p>éªŒè¯ç æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„é˜²åˆ·æ‰‹æ®µï¼Œå¤§å¤šæ•°ç½‘ç«™çš„ç™»å½•æ¨¡å—ä¸­ï¼Œä¸ºé¿å…è¢«æœºå™¨äººåˆ·ï¼Œéƒ½ä¼šåŠ å…¥å›¾ç‰‡éªŒè¯ç ã€‚è€Œåœ¨ç§’æ€ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é™¤äº†ç”¨éªŒè¯ç æ¥é˜²åˆ·å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç›®çš„å°±æ˜¯é€šè¿‡éªŒè¯ç è¿›è¡Œå‰Šå³°ï¼Œè¾¾åˆ°æµé‡æ•´å½¢çš„ç›®çš„ã€‚é™¤äº†å›¾ç‰‡éªŒè¯ç ï¼Œä½ ä¸€å®šä¹Ÿè§è¿‡çŸ­ä¿¡å’Œè¯­éŸ³éªŒè¯ç ï¼Œé‚£ä¸ºä»€ä¹ˆåœ¨ç§’æ€ç³»ç»Ÿçš„å‰Šå³°ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé€‰æ‹©å›¾ç‰‡éªŒè¯ç å‘¢ï¼Ÿä¸»è¦è¿˜æ˜¯å‡ºäºæˆæœ¬å’Œç”¨æˆ·ä½“éªŒçš„è€ƒè™‘ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¸¸ç”¨çš„åº”ç”¨è§£è€¦æ–¹å¼ï¼Œé€šè¿‡æŠŠåŒæ­¥è°ƒç”¨æ”¹é€ æˆå¼‚æ­¥æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ–¹å¯ä»¥æ ¹æ®è‡ªå·±çš„èƒ½åŠ›æ¥å¤„ç†è¯·æ±‚ï¼Œè€Œä¸ç”¨æ‹…å¿ƒè¢«ç¬æ—¶æµé‡æ‰“å®ã€‚å½“ç„¶äº†ï¼Œå¦‚æœåº“å­˜å·²ç»å–å®Œï¼Œé‚£ä¹ˆæ¶ˆè´¹æ–¹åœ¨å¤„ç†è¯·æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥å¿«é€Ÿå¤±è´¥ï¼Œè¿™æ ·ä¹Ÿä¸ç”¨æ‹…å¿ƒæ¶ˆæ¯çš„é•¿æœŸç§¯å‹ã€‚</p><p>æœ€åï¼Œæˆ‘ä»‹ç»äº†å‡ ç§é™æµçš„æ–¹å¼ï¼Œå’Œå…¶ä»–å‰Šå³°æ–¹å¼ç›¸æ¯”ï¼Œé™æµæ˜¯æœ‰æŸçš„ã€‚é™æµå®é™…ä¸Šæ˜¯æ ¹æ®æœåŠ¡è‡ªèº«çš„å®¹é‡ï¼Œæ— å·®åˆ«åœ°ä¸¢å¼ƒå¤šä½™æµé‡ï¼Œå¯¹äºè¢«ä¸¢å¼ƒçš„æµé‡æ¥è¯´ï¼Œè¿™å—çš„ä½“éªŒæ˜¯å—æŸçš„ã€‚å¦å¤–ï¼Œå› ä¸ºç§’æ€æµé‡ä¼šç»å†å¾ˆå¤šäº¤æ˜“ç³»ç»Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è®¾è®¡æ—¶éœ€è¦ä»èµ·å§‹æµé‡å¼€å§‹ï¼Œåˆ†å±‚è¿‡æ»¤ï¼Œé€çº§é™æµï¼Œè¿™æ ·æµé‡åœ¨æœ€åçš„ä¸‹å•ç¯èŠ‚å°±æ˜¯å°‘é‡è€Œå¯æ§çš„äº†ã€‚</p><p>å¦å¤–ï¼Œåœ¨è¿™ä¸€èŠ‚è¯¾å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘æœ‰ç•™ä¸‹ä¸€ä¸ªå°ä¼ç¬”ï¼Œå°±æ˜¯åœ¨ä»‹ç»äº†å„ç§å‰Šå³°æ‰‹æ®µåï¼Œäº’è”ç½‘å¤§å‚åœ¨å®è·µä¸­ä¸€èˆ¬éƒ½æ˜¯æ€ä¹ˆé€‰æ‹©çš„å‘¢ï¼Ÿå…¶å®ï¼Œå¦‚æœä½ å»ä½“éªŒä¸‹åƒå¤©çŒ«ã€äº¬ä¸œçš„ç§’æ€ï¼Œå°±ä¼šå‘ç°ä»–ä»¬æ€»ä½“æ˜¯æ¯”è¾ƒç±»ä¼¼çš„ï¼ŒåŸºæœ¬ä¸ä¼šä½¿ç”¨éªŒè¯ç æˆ–ç­”é¢˜è¿™ä¸¤ç§æ–¹å¼ï¼Œå› ä¸ºå¯¹äºå¤´éƒ¨ç”µå•†å¹³å°æ¥è¯´ï¼Œä½“éªŒå¯èƒ½ä¸æ˜¯é‚£ä¹ˆå‹å¥½ã€‚ä»–ä»¬æ¯”è¾ƒåå‘é‡‡ç”¨éå…¬å¹³çš„æŠ¢è´­ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯æœ‰æŸçš„é€çº§é™æµå’Œåˆ†å±‚è¿‡æ»¤ï¼ŒèƒŒåæœ€é‡è¦çš„è€ƒè™‘å…¶å®å°±æ˜¯å…¼é¡¾äº†ä½“éªŒä¸ç³»ç»Ÿèµ„æºã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æˆ‘ä»¬åœ¨ä»‹ç»å‰Šå³°æ‰‹æ®µçš„æ—¶å€™ï¼Œæœ‰æåˆ°è¿‡é—®ç­”é¢˜ä¹Ÿæ˜¯ä¸€ç§å‰Šå³°æ–¹å¼ï¼Œä½†æ˜¯åœ¨è¿™ä¸€è®²ä¸­ï¼Œå› ä¸ºä¸å¸¸ç”¨çš„å…³ç³»ï¼Œæˆ‘ç•¥å»äº†é—®ç­”é¢˜çš„è®¾è®¡ã€‚è¿™é‡Œæˆ‘æƒ³è¯·ä½ æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœè®©ä½ æ¥è®¾è®¡ç§’æ€çš„é—®ç­”é¢˜ç³»ç»Ÿï¼Œå°†å…¶ä½œä¸ºä¸€ç§å‰Šå³°æ–¹å¼ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡å‘¢ï¼Ÿ</p><p>ä»¥ä¸Šå°±æ˜¯è¿™èŠ‚è¯¾çš„å…¨éƒ¨å†…å®¹ï¼Œæ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå’Œæˆ‘è®¨è®ºé—®é¢˜ï¼Œäº¤æµç»éªŒï¼</p>","comments":[{"had_liked":false,"id":314999,"user_name":"è‘£æ°¸æ”¿","can_delete":false,"product_type":"c1","uid":1718942,"ip_address":"","ucode":"AFBB94FA61B85B","user_header":"https://static001.geekbang.org/account/avatar/00/1a/3a/9e/3efae88f.jpg","comment_is_top":true,"comment_ctime":1633654479,"is_pvip":false,"replies":[{"id":"114057","content":"åŒå­¦ä½ å¥½ï¼Œæˆ‘åˆšè¯•äº†ä¸‹å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œéº»çƒ¦ä½ æ£€æŸ¥ä¸‹ç½‘ç»œå“ˆï½æœ‰é—®é¢˜å¯ä»¥å†åé¦ˆï¼<br><br>GitHub åœ°å€ï¼šhttps:&#47;&#47;github.com&#47;sanyecao-seckill","user_name":"ç¼–è¾‘å›å¤","comment_id":314999,"uid":"1356014","ip_address":"","utype":2,"ctime":1633656243,"user_name_real":"ç‹å†¬é’"}],"discussion_count":1,"race_medal":0,"score":"9.2233720384883999e+18","product_id":100091501,"comment_content":"ç»™çš„ç½‘å€è®¿é—®ä¸äº†","like_count":0,"discussions":[{"author":{"id":1356014,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b0/ee/d0871efd.jpg","nickname":"å†¬é’","note":"","ucode":"14576781B499FB","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527852,"discussion_content":"åŒå­¦ä½ å¥½ï¼Œæˆ‘åˆšè¯•äº†ä¸‹å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œéº»çƒ¦ä½ æ£€æŸ¥ä¸‹ç½‘ç»œå“ˆï½æœ‰é—®é¢˜å¯ä»¥å†åé¦ˆï¼\n\nGitHub åœ°å€ï¼šhttps://github.com/sanyecao-seckill","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633656243,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319805,"user_name":"æ·¡æœªç„¶","can_delete":false,"product_type":"c1","uid":2809129,"ip_address":"","ucode":"FBB22891273464","user_header":"https://static001.geekbang.org/account/avatar/00/2a/dd/29/cd589f38.jpg","comment_is_top":false,"comment_ctime":1635949393,"is_pvip":true,"replies":[{"id":"116116","content":"å½“åº“å­˜ç”¨å®Œä¹‹åï¼Œè®¾ç½®å ä½ç¬¦çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…å¤§æµé‡çš„ç¼“å­˜å‡»ç©¿ï¼Œåº“å­˜å®Œäº†å°±ç›´æ¥è¿”å›äº†ï¼Œæ²¡å¿…è¦å†å»æ•°æ®åº“æˆ–redisæŸ¥","user_name":"ä½œè€…å›å¤","comment_id":319805,"uid":"1222758","ip_address":"","utype":1,"ctime":1636200429,"user_name_real":"Zhidong"}],"discussion_count":3,"race_medal":0,"score":"10225883985","product_id":100091501,"comment_content":"é‚£å°±æ˜¯å½“å‰é¢çš„è¯·æ±‚å·²ç»æŠŠåº“å­˜æ¶ˆè€—å…‰ä¹‹åï¼Œåœ¨ç¼“å­˜é‡Œè®¾ç½®å ä½ç¬¦ï¼Œè®©åç»­çš„è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œä»è€Œæœ€å¿«åœ°è¿›è¡Œå“åº”ã€‚   ç¼“å­˜é‡Œè®¾ç½®å ä½ç¬¦ï¼Œä¸å¤ªç†è§£ï¼Œèƒ½è¯¦ç»†è¯´æ˜ä¸€ä¸‹ä¹ˆï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1222758,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a8/66/02ab2ce7.jpg","nickname":"Zhidong","note":"","ucode":"AEBBCE20C242C3","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529774,"discussion_content":"å½“åº“å­˜ç”¨å®Œä¹‹åï¼Œè®¾ç½®å ä½ç¬¦çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…å¤§æµé‡çš„ç¼“å­˜å‡»ç©¿ï¼Œåº“å­˜å®Œäº†å°±ç›´æ¥è¿”å›äº†ï¼Œæ²¡å¿…è¦å†å»æ•°æ®åº“æˆ–redisæŸ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636200429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1155062,"avatar":"https://static001.geekbang.org/account/avatar/00/11/9f/f6/7431e82e.jpg","nickname":"xueerfei007","note":"","ucode":"EF3FE821E5B54A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1222758,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a8/66/02ab2ce7.jpg","nickname":"Zhidong","note":"","ucode":"AEBBCE20C242C3","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":589330,"discussion_content":"å¦‚æœä¸æŸ¥DBæ€ä¹ˆçŸ¥é“åº“å­˜å®Œäº†ï¼Ÿ è®¾ç½®å ä½ç¬¦æ˜¯ä¸åº”è¯¥æ˜¯åœ¨Redisä¸­è®¾ç½®å˜›ï¼Œä¸ç„¶ä¸å°±é€»è¾‘å¯¹ä¸ä¸Šäº†ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664698067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":529774,"ip_address":"æµ™æ±Ÿ"},"score":589330,"extra":""}]},{"author":{"id":2809129,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/dd/29/cd589f38.jpg","nickname":"æ·¡æœªç„¶","note":"","ucode":"FBB22891273464","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":412524,"discussion_content":"è°¢è°¢ï¼Œç†è§£äº†ï¼Œä¹‹å‰æœ‰çœ‹è¿‡ï¼Œä¸€ä¸‹å­æ²¡ååº”è¿‡æ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636200863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315013,"user_name":"å¨","can_delete":false,"product_type":"c1","uid":1068542,"ip_address":"","ucode":"C921CDCB22B9A3","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/fe/882eaf0f.jpg","comment_is_top":false,"comment_ctime":1633658780,"is_pvip":false,"replies":[{"id":"114631","content":"ä¸ºè§„é¿é™æµè®¡æ•°æœ¬èº«æˆä¸ºçƒ­ç‚¹ç“¶é¢ˆå½±å“æ€§èƒ½ï¼Œä¸€èˆ¬é‡‡ç”¨å•æœºé™æµï¼Œå•æœºé™æµqps * å®ä¾‹æ•° = åˆ†å¸ƒå¼ç³»ç»Ÿçš„é™æµæ€»qps","user_name":"ä½œè€…å›å¤","comment_id":315013,"uid":"1222758","ip_address":"","utype":1,"ctime":1634395408,"user_name_real":"Zhidong"}],"discussion_count":1,"race_medal":0,"score":"10223593372","product_id":100091501,"comment_content":"å¦‚æœæ˜¯åˆ†å¸ƒå¼é™æµï¼Œä¸€èˆ¬ä¼šæ€æ ·åšå‘¢","like_count":2,"discussions":[{"author":{"id":1222758,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a8/66/02ab2ce7.jpg","nickname":"Zhidong","note":"","ucode":"AEBBCE20C242C3","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527858,"discussion_content":"ä¸ºè§„é¿é™æµè®¡æ•°æœ¬èº«æˆä¸ºçƒ­ç‚¹ç“¶é¢ˆå½±å“æ€§èƒ½ï¼Œä¸€èˆ¬é‡‡ç”¨å•æœºé™æµï¼Œå•æœºé™æµqps * å®ä¾‹æ•° = åˆ†å¸ƒå¼ç³»ç»Ÿçš„é™æµæ€»qps","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634395408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344208,"user_name":"Sanisy","can_delete":false,"product_type":"c1","uid":1306475,"ip_address":"","ucode":"B2166F1E19D50A","user_header":"","comment_is_top":false,"comment_ctime":1651371600,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5946338896","product_id":100091501,"comment_content":"ç”¨mqå¼‚æ­¥å¤„ç†ï¼Œç»“æœå“åº”æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿå¦‚æœæ¶ˆè´¹æ¯”è¾ƒæ…¢ï¼Œå‰ç«¯è¯·æ±‚è¶…æ—¶äº†ï¼Œåé¢æ€ä¹ˆè¿”å›ç»“æœç»™ç”¨æˆ·","like_count":1},{"had_liked":false,"id":317533,"user_name":"æå¨","can_delete":false,"product_type":"c1","uid":1460961,"ip_address":"","ucode":"3409A9390BD1FD","user_header":"https://static001.geekbang.org/account/avatar/00/16/4a/e1/2a498473.jpg","comment_is_top":false,"comment_ctime":1634827948,"is_pvip":false,"replies":[{"id":"115089","content":"å¦‚æœé™æµè®¾ç½®æ˜¯100ä¸ªqpsï¼Œé‚£ä¹ˆç¬¬ä¸€ç§’æ—¶é—´å†…çš„ç¬¬101ä¸ªä»¥åŠä¹‹åç”¨æˆ·ä¼šè¢«é™æµï¼Œè€Œç¬¬äºŒç§’çš„100ä¹‹å†…çš„ç”¨æˆ·ï¼Œè™½ç„¶æ—¶é—´ç¨å¾®æ…¢äº†ä¸€ç‚¹ï¼Œä½†è‡³å°‘æ²¡æœ‰è¢«é™æµæ‹¦æˆªï¼Œå¯ä»¥å»å‚ä¸æŠ¢è´­","user_name":"ä½œè€…å›å¤","comment_id":317533,"uid":"1222758","ip_address":"","utype":1,"ctime":1634874984,"user_name_real":"Zhidong"}],"discussion_count":2,"race_medal":0,"score":"5929795244","product_id":100091501,"comment_content":"æ–‡ä¸­è¯´å¤´éƒ¨ç”µå•†ä¸€èˆ¬é‡‡ç”¨éå…¬å¹³é™æµç­–ç•¥ï¼Œè¿™ä¸ªéå…¬å¹³å…·ä½“æŒ‡çš„æ˜¯å•¥ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1222758,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a8/66/02ab2ce7.jpg","nickname":"Zhidong","note":"","ucode":"AEBBCE20C242C3","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528850,"discussion_content":"å¦‚æœé™æµè®¾ç½®æ˜¯100ä¸ªqpsï¼Œé‚£ä¹ˆç¬¬ä¸€ç§’æ—¶é—´å†…çš„ç¬¬101ä¸ªä»¥åŠä¹‹åç”¨æˆ·ä¼šè¢«é™æµï¼Œè€Œç¬¬äºŒç§’çš„100ä¹‹å†…çš„ç”¨æˆ·ï¼Œè™½ç„¶æ—¶é—´ç¨å¾®æ…¢äº†ä¸€ç‚¹ï¼Œä½†è‡³å°‘æ²¡æœ‰è¢«é™æµæ‹¦æˆªï¼Œå¯ä»¥å»å‚ä¸æŠ¢è´­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634874984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008257,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/81/ad80f427.jpg","nickname":"Lane","note":"","ucode":"F70459D1BBD9F4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406914,"discussion_content":"ä¸¢å¼ƒå§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634867008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352780,"user_name":"æœ¨å‡ ä¸¶","can_delete":false,"product_type":"c1","uid":2420294,"ip_address":"","ucode":"FFDB958DA64F8C","user_header":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","comment_is_top":false,"comment_ctime":1658922869,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1658922869","product_id":100091501,"comment_content":"nginxçš„limit_req_zoneå¥½åƒæ˜¯æ¼æ¡¶ç®—æ³•ï¼Ÿ<br>http:&#47;&#47;nginx.org&#47;en&#47;docs&#47;http&#47;ngx_http_limit_req_module.html","like_count":0},{"had_liked":false,"id":335729,"user_name":"æ°¸æ˜Œ","can_delete":false,"product_type":"c1","uid":1025006,"ip_address":"","ucode":"A572DDE33DFAD9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a3/ee/636415d8.jpg","comment_is_top":false,"comment_ctime":1645667083,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1645667083","product_id":100091501,"comment_content":"é—®ç­”é¢˜é™æµï¼šå‡†å¤‡ä¸€ä¸ªé¢˜åº“ï¼Œé¢˜åº“åŒ…å«é¢˜ç›®å’Œå†…å®¹ï¼Œç”¨æˆ·å¼€å§‹æŠ¢è´­æ—¶ï¼Œéšæœºä»é¢˜åº“æ‹¿å‡ºä¸€é“é¢˜ï¼Œå¡«å†™ç­”æ¡ˆï¼Œç‚¹å‡»æäº¤æ ¡éªŒå³å¯ã€‚","like_count":0},{"had_liked":false,"id":317592,"user_name":"Lane","can_delete":false,"product_type":"c1","uid":1008257,"ip_address":"","ucode":"F70459D1BBD9F4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/62/81/ad80f427.jpg","comment_is_top":false,"comment_ctime":1634867057,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1634867057","product_id":100091501,"comment_content":"æ²¡å¤ªç†è§£ï¼Œä¸ºä»€ä¹ˆéªŒè¯ç è¦åšç­¾åï¼Œä¸åšç­¾åä¸ºä»€ä¹ˆä¼šè¢«ç¯¡æ”¹","like_count":0,"discussions":[{"author":{"id":1877862,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLu3MgZBAyyiavX2CMF2KRib791j3bBGiaQDzuQwBF2k6AKHANV2uTAAss2vVaeC7xcSYYD8vjmibRpTQ/132","nickname":"çºµä¸æœ½","note":"","ucode":"DB2CA2C46B2EF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590062,"discussion_content":"åŒæ„Ÿï¼Œä¸æ˜ç™½ä¸ºä»€ä¹ˆå°±è¿™ä¸€ä¸ªæ¥å£éœ€è¦åšç­¾å","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665493776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317114,"user_name":"å…¬å·-æŠ€æœ¯å¤œæœªçœ ","can_delete":false,"product_type":"c1","uid":1013683,"ip_address":"","ucode":"83825B57CBD952","user_header":"https://static001.geekbang.org/account/avatar/00/0f/77/b3/991f3f9b.jpg","comment_is_top":false,"comment_ctime":1634690935,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1634690935","product_id":100091501,"comment_content":"è¿™é‡Œ timestamp å–ç”ŸæˆéªŒè¯ç  vCode æ—¶çš„æ—¶é—´æˆ³ï¼ŒrandomSalt å¯ä»¥ç†è§£ä¸ºåç«¯çš„ä¸€ä¸ªç§é’¥ã€‚é‚£ä¹ˆåœ¨å‰é¢ä»£ç çš„ç¬¬ 44 è¡Œï¼Œæˆ‘ä»¬å­˜å…¥ Redis çš„å€¼å°±è¦æ¢æˆè¿™ä¸ª signature äº†ã€‚<br>è¯·é—®è€å¸ˆï¼ŒrandomSaltæ˜¯å¦‚ä½•è·å–çš„äº†ï¼Ÿ","like_count":0},{"had_liked":false,"id":314984,"user_name":"Geek_d0863b","can_delete":false,"product_type":"c1","uid":2617677,"ip_address":"","ucode":"731BA25FE930A6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/g4wzd5sQZzAZBtPqzOhiaX343Bz9Ga2TXr1ibS3mGNCG0uiaNeQho3eKDTqR5YoFib5tt8zjSHibic4TWHgxehZxNuwg/132","comment_is_top":false,"comment_ctime":1633624310,"is_pvip":false,"replies":[{"id":"114072","content":"æ”¶åˆ°ï¼ŒåŠ ç­åŠ ç‚¹æ›´æ–°ä¸­ï½æ„Ÿè°¢è€å¿ƒç­‰å¾…ï¼","user_name":"ç¼–è¾‘å›å¤","comment_id":314984,"uid":"1356014","ip_address":"","utype":2,"ctime":1633662299,"user_name_real":"ç‹å†¬é’"}],"discussion_count":1,"race_medal":0,"score":"1633624310","product_id":100091501,"comment_content":"è€å¸ˆ æ‚¨èƒ½å°½å¿«æ›´æ–°githubä¸Šçš„ä»£ç å˜›ğŸ˜„ è°¢è°¢äº†ï¼","like_count":0,"discussions":[{"author":{"id":1356014,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b0/ee/d0871efd.jpg","nickname":"å†¬é’","note":"","ucode":"14576781B499FB","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527849,"discussion_content":"æ”¶åˆ°ï¼ŒåŠ ç­åŠ ç‚¹æ›´æ–°ä¸­ï½æ„Ÿè°¢è€å¿ƒç­‰å¾…ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633662299,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]}]}