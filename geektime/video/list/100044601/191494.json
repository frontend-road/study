{"id":191494,"title":"12 | 配置变更监听：配置热更新能力的核心","content":"<p><strong>各位亲爱的学员：</strong><br>\n推荐大家阅读一下配置框架的源码，代码量虽然不多，但这里面有不少可以借鉴的设计方法和代码风格，另外其中有一个ChainedConfigurationProvider，是课程里没有提到的，可以思考一下这个提供程序的使用场景。<br>\n源码下载地址：<a href=\"https://github.com/dotnet/extensions\">https://github.com/dotnet/extensions</a></p><p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":175249,"user_name":"Quintos","can_delete":false,"product_type":"c3","uid":1313882,"ip_address":"","ucode":"DD1FB190599279","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/5a/3b01789e.jpg","comment_is_top":false,"comment_ctime":1580629946,"is_pvip":true,"replies":[{"id":68149,"content":"实现上section的changetoken就是root的changetoken，没有区分。\n需要特别区分的，可以自己build一个root对象来做独立配置","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1580695354,"ip_address":"","comment_id":175249,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"在使用ChangeToken 注册 OnChange callback时，第一个参数中的changetoken如果是由某个section来生成的话，\n为什么对配置文件section之外的区域进行修改，也会引起section的onchange事件呢？","like_count":3,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482665,"discussion_content":"实现上section的changetoken就是root的changetoken，没有区分。\n需要特别区分的，可以自己build一个root对象来做独立配置","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580695354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174458,"user_name":"Grour","can_delete":false,"product_type":"c3","uid":1808649,"ip_address":"","ucode":"E688BDC7F305AB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoHXbWPZuBKJBYiayL1qFLwKZCM76CPEwXcREia71QCiaMJ5Im5Iibt9CvQBPunQ01VVOm9xU4ia0zasYQ/132","comment_is_top":false,"comment_ctime":1580215644,"is_pvip":false,"replies":[{"id":67833,"content":"你看看报错是不是因为服务的生命周期冲突了，服务单例时使用IOptionSnapshot会报错，因为IOptionSnapshot是Scoped的，不能被单例服务依赖。\n建议使用IOptionsMonitor&lt;T&gt;，它是单例的。\n\n另外需要注意的是在注册时传入的是T，服务构造函数注入的是IOptionsMonitor&lt;T&gt;，如：\n\nservices.Configure&lt;T&gt;(configuration)","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1580269799,"ip_address":"","comment_id":174458,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师您好:\n我在中间件里想实现某些功能时需要读取配置,故在构造函数中注入IOption&lt;T&gt;,此操作运行没有问题.\n后来尝试使用IOptionSnapshot&lt;T&gt;实现配置文件实时读取,可是程序运行时,却抛出异常.\n1. 为什么会这样?\n2.怎么解决比较合理?\n","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482408,"discussion_content":"你看看报错是不是因为服务的生命周期冲突了，服务单例时使用IOptionSnapshot会报错，因为IOptionSnapshot是Scoped的，不能被单例服务依赖。\n建议使用IOptionsMonitor&amp;lt;T&amp;gt;，它是单例的。\n\n另外需要注意的是在注册时传入的是T，服务构造函数注入的是IOptionsMonitor&amp;lt;T&amp;gt;，如：\n\nservices.Configure&amp;lt;T&amp;gt;(configuration)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580269799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1367474,"avatar":"https://static001.geekbang.org/account/avatar/00/14/dd/b2/ce81de8d.jpg","nickname":"雄鹿 @","note":"","ucode":"9FBF8CF4392829","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":180601,"discussion_content":"老师你好，我在尝试热更新Demo的时候，总是无法进入到 RegisterChangeCallback 函数里面去，请问是怎么回事呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582297618,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231789,"user_name":"Geek_45f590","can_delete":false,"product_type":"c3","uid":2055068,"ip_address":"","ucode":"BAAFB1FCED974E","user_header":"","comment_is_top":false,"comment_ctime":1593769863,"is_pvip":false,"replies":[{"id":85995,"content":"注册为scope生命周期，工厂模式构造，就能够支持热更新。在k8s+微服务架构下，重启应用的代价一般是比较小的，可以滚动更新，配置热更更多用在特殊的场景，例如调整日志输出级别以排查问题","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1594221466,"ip_address":"","comment_id":231789,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"数据库或者redis 连接字符串变化了怎么办？ 就算发现变化了，前面注入到容器的如何替换，而且不影响到现在正在跑的连接。\n","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500439,"discussion_content":"注册为scope生命周期，工厂模式构造，就能够支持热更新。在k8s+微服务架构下，重启应用的代价一般是比较小的，可以滚动更新，配置热更更多用在特殊的场景，例如调整日志输出级别以排查问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594221466,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":177136,"user_name":"ff","can_delete":false,"product_type":"c3","uid":1024545,"ip_address":"","ucode":"2CE7182F48FE01","user_header":"","comment_is_top":false,"comment_ctime":1581300428,"is_pvip":false,"replies":[{"id":68930,"content":"内存提供程序和环境变量提供程序并没有跟踪数据变化，有需求的话可以基于现有的实现重写自定义的监听逻辑。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1581426067,"ip_address":"","comment_id":177136,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"配置变更监听的话，是只能监听配置文件的变化吗？ \n对于内存配置和环境变量配置的变更是否可以监听到呢？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483317,"discussion_content":"内存提供程序和环境变量提供程序并没有跟踪数据变化，有需求的话可以基于现有的实现重写自定义的监听逻辑。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581426067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":176179,"user_name":"ff","can_delete":false,"product_type":"c3","uid":1024545,"ip_address":"","ucode":"2CE7182F48FE01","user_header":"","comment_is_top":false,"comment_ctime":1580980193,"is_pvip":false,"replies":[{"id":68582,"content":"文件系统有关","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1581148189,"ip_address":"","comment_id":176179,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"使用 ChangeToken.OnChange监听配置变化的时候，如果使用VSCode去编辑保存配置文件的时候，监听的回调会被执行两次，如果使用NotePad编辑保存的话就是正常的执行一次，是不是VsCode保存的时候有什么特殊的操作？不知道小伙伴们有没有遇到这个问题？？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483037,"discussion_content":"文件系统有关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581148189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175544,"user_name":"zy","can_delete":false,"product_type":"c3","uid":1817487,"ip_address":"","ucode":"54C318B06B8D3A","user_header":"https://static001.geekbang.org/account/avatar/00/1b/bb/8f/13de6ff8.jpg","comment_is_top":false,"comment_ctime":1580741350,"is_pvip":false,"replies":[{"id":68381,"content":"参考后面Options的章节","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1580891826,"ip_address":"","comment_id":175544,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"有没有办法第一次就加载不需要改变才加载了。这样得写两次加载配置的方法。一次是第一次。另一次就是变更时才处理的","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482790,"discussion_content":"参考后面Options的章节","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580891826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208106,"user_name":"阿晟","can_delete":false,"product_type":"c3","uid":1103765,"ip_address":"","ucode":"690690FDC25F8A","user_header":"https://static001.geekbang.org/account/avatar/00/10/d7/95/5e53e085.jpg","comment_is_top":false,"comment_ctime":1587278671,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"老师  OnChange方法里  有时候会执行两次 这个怎么解决","like_count":2,"discussions":[{"author":{"id":2349098,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK5ibrjAng8wZBWlrpZg2hkOlrCmk6YcCkHofba7zI6wUKT5MjJFM8PWBcl44v9VXcGQU139NNVXag/132","nickname":"开始即结束","note":"","ucode":"DC89EA63A5A7DB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332448,"discussion_content":"确实是这样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607223670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1997325,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/7a/0d/27413925.jpg","nickname":"向洪林","note":"","ucode":"F3DF7D8D3B9186","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":264101,"discussion_content":"真会这样？我找个时间试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589289304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306701,"user_name":"Geek_590cca","can_delete":false,"product_type":"c3","uid":2616085,"ip_address":"","ucode":"D0D6BDC62E5AE8","user_header":"https://static001.geekbang.org/account/avatar/00/27/eb/15/456dcc3d.jpg","comment_is_top":false,"comment_ctime":1628673050,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"关于使用老师的示例无法成功监控文件更改，需要json文件变为不复制，然后在AddJsonFile加载文件时，第一个参数是传入文件的绝对路径，这样不会报错。\n然后文件修改一次，回调函数执行两次依然存在。\nps:我的运行环境是win+ net5.0","like_count":0},{"had_liked":false,"id":246479,"user_name":"犀利鬼","can_delete":false,"product_type":"c3","uid":1600746,"ip_address":"","ucode":"E02388EC88D4ED","user_header":"https://static001.geekbang.org/account/avatar/00/18/6c/ea/65cfa066.jpg","comment_is_top":false,"comment_ctime":1599369168,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"看到很多人碰到，监听onchange时间会触发两次的问题，我在找另外一个问题时，偶然找到这个问题的issue，可以参考一下https:&#47;&#47;github.com&#47;dotnet&#47;aspnetcore&#47;issues&#47;2542","like_count":0},{"had_liked":false,"id":218013,"user_name":"向洪林","can_delete":false,"product_type":"c3","uid":1997325,"ip_address":"","ucode":"F3DF7D8D3B9186","user_header":"https://static001.geekbang.org/account/avatar/00/1e/7a/0d/27413925.jpg","comment_is_top":false,"comment_ctime":1589695370,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"尝试了这里的IChangToken不管注册多少次都是第一次改动后注册的全部方法回掉了！","like_count":0},{"had_liked":false,"id":203356,"user_name":"Miracle","can_delete":false,"product_type":"c3","uid":1926983,"ip_address":"","ucode":"6C3D2386A366C6","user_header":"","comment_is_top":false,"comment_ctime":1586179096,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100044601,"comment_content":"老师你好:\n使用你的源码发现没办法读取到文件的新配置...","like_count":0}]}