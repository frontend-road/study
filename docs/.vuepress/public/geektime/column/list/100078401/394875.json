{"id":394875,"title":"29 | éƒ¨é—¨å»ºç«‹ï¼šå¦‚ä½•åœ¨å†…æ ¸ä¸­æ³¨å†Œè®¾å¤‡ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚</p><p>åœ¨ä¸ŠèŠ‚è¯¾é‡Œï¼Œæˆ‘ä»¬å¯¹è®¾å¤‡è¿›è¡Œäº†åˆ†ç±»ï¼Œå»ºç«‹äº†è®¾å¤‡ä¸é©±åŠ¨çš„æ•°æ®ç»“æ„ï¼ŒåŒæ—¶ä¹Ÿè§„å®šäº†ä¸€ä¸ªé©±åŠ¨ç¨‹åºåº”è¯¥æä¾›å“ªäº›æ ‡å‡†æ“ä½œæ–¹æ³•ï¼Œä¾›æ“ä½œç³»ç»Ÿå†…æ ¸è°ƒç”¨ã€‚è¿™ç›¸å½“äºè®¾è®¡äº†è¡Œæ”¿éƒ¨é—¨çš„è§„ç« åˆ¶åº¦ï¼Œä¸€ä¸ªéƒ¨é—¨å«ä»€ä¹ˆï¼Œåº”è¯¥å¹²ä»€ä¹ˆï¼Œè¿™äº›å°±ç¡®å®šå¥½äº†ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬æ¥ç»§ç»­æ¢ç´¢éƒ¨é—¨çš„å»ºç«‹ï¼Œä¹Ÿå°±æ˜¯è®¾å¤‡åœ¨å†…æ ¸ä¸­æ˜¯å¦‚ä½•æ³¨å†Œçš„ã€‚æˆ‘ä»¬å…ˆä»å…¨å±€äº†è§£ä¸€ä¸‹è®¾å¤‡çš„æ³¨å†Œæµç¨‹ï¼Œç„¶åäº†è§£æ€ä¹ˆåŠ è½½é©±åŠ¨ï¼Œæœ€åæ¢ç´¢æ€ä¹ˆè®©é©±åŠ¨å»ºç«‹ä¸€ä¸ªè®¾å¤‡ï¼Œå¹¶åœ¨å†…æ ¸ä¸­æ³¨å†Œã€‚è®©æˆ‘ä»¬æ­£å¼å¼€å§‹ä»Šå¤©çš„å­¦ä¹ å§ï¼</p><p>è¿™èŠ‚è¯¾é…å¥—ä»£ç ï¼Œä½ å¯ä»¥ä»<a href=\"https://gitee.com/lmos/cosmos/tree/master/lesson28~29/Cosmos\">è¿™é‡Œ</a>ä¸‹è½½ã€‚</p><h2>è®¾å¤‡çš„æ³¨å†Œæµç¨‹</h2><p>ä½ æ˜¯å¦æƒ³è±¡è¿‡ï¼Œä½ åœ¨ç”µè„‘ä¸Šæ’å…¥ä¸€ä¸ªUSBé¼ æ ‡æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šä½œå‡ºæ€æ ·çš„ååº”å‘¢ï¼Ÿ</p><p>æˆ‘æ¥ç®€å•ä½œä¸ªæè¿°ï¼Œ<strong>è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†æˆè¿™æ ·äº”æ­¥ã€‚</strong></p><p>1.æ“ä½œç³»ç»Ÿä¼šæ”¶åˆ°ä¸€ä¸ªä¸­æ–­ã€‚<br>\n2.USBæ€»çº¿é©±åŠ¨çš„ä¸­æ–­å¤„ç†ç¨‹åºä¼šæ‰§è¡Œã€‚<br>\n3.è°ƒç”¨æ“ä½œç³»ç»Ÿå†…æ ¸ç›¸å…³çš„æœåŠ¡ï¼ŒæŸ¥æ‰¾USBé¼ æ ‡å¯¹åº”çš„é©±åŠ¨ç¨‹åºã€‚<br>\n4.æ“ä½œç³»ç»ŸåŠ è½½é©±åŠ¨ç¨‹åºã€‚<br>\n5.é©±åŠ¨ç¨‹åºå¼€å§‹æ‰§è¡Œï¼Œå‘æ“ä½œç³»ç»Ÿå†…æ ¸æ³¨å†Œä¸€ä¸ªé¼ æ ‡è®¾å¤‡ã€‚è¿™å°±æ˜¯ä¸€èˆ¬æ“ä½œç³»ç»ŸåŠ è½½é©±åŠ¨çš„ç²—ç•¥è¿‡ç¨‹ã€‚å¯¹äºå®‰è£…åœ¨ä¸»æ¿ä¸Šçš„è®¾å¤‡ï¼Œæ“ä½œç³»ç»Ÿä¼šæšä¸¾è®¾å¤‡ä¿¡æ¯ï¼Œç„¶ååŠ è½½é©±åŠ¨ç¨‹åºï¼Œè®©é©±åŠ¨ç¨‹åºåˆ›å»ºå¹¶æ³¨å†Œç›¸åº”çš„è®¾å¤‡ã€‚å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥æ‰‹åŠ¨åŠ è½½é©±åŠ¨ç¨‹åºã€‚</p><p>ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬çš„Cosmosä¸ä¼šè¿™æ ·å¤æ‚ï¼Œæš‚æ—¶ä¹Ÿä¸æ”¯æŒè®¾å¤‡çƒ­æ‹¨æ’åŠŸèƒ½ã€‚æˆ‘ä»¬è®©Cosmosè‡ªåŠ¨åŠ è½½é©±åŠ¨ï¼Œåœ¨é©±åŠ¨ä¸­å‘Cosmosæ³¨å†Œç›¸åº”çš„è®¾å¤‡ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§é™ä½é—®é¢˜çš„å¤æ‚åº¦ï¼Œæˆ‘ä»¬å…ˆä»ç®€å•çš„åšèµ·å˜›ï¼Œç›¸ä¿¡ä½ æ˜ç™½äº†åŸç†ä¹‹åï¼Œè¿˜å¯ä»¥è‡ªè¡Œè¿­ä»£ã€‚</p><!-- [[[read_end]]] --><p>ä¸ºäº†è®©ä½ æ›´æ¸…æ¥šåœ°äº†è§£è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä¸ºä½ ç”»äº†ä¸€å¹…å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/eb/9f/ebd6fc28f859c09891cd7dc0a4f0c49f.jpg?wh=3287x4605\" alt=\"\"></p><p>ä¸Šå›¾ä¸­ï¼Œå®Œæ•´å±•ç¤ºäº†Cosmosè‡ªåŠ¨åŠ è½½é©±åŠ¨çš„æ•´ä¸ªæµç¨‹ï¼ŒCosmosåœ¨åˆå§‹åŒ–é©±åŠ¨æ—¶ä¼šæ‰«ææ•´ä¸ªé©±åŠ¨è¡¨ï¼Œç„¶ååŠ è½½è¡¨ä¸­æ¯ä¸ªé©±åŠ¨ï¼Œåˆ†åˆ«è°ƒç”¨å„ä¸ªé©±åŠ¨çš„å…¥å£å‡½æ•°ï¼Œæœ€ååœ¨é©±åŠ¨ä¸­å»ºç«‹è®¾å¤‡å¹¶å‘å†…æ ¸æ³¨å†Œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«è®¨è®ºè¿™äº›æµç¨‹çš„å®ç°ã€‚</p><h2>é©±åŠ¨ç¨‹åºè¡¨</h2><p>ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œä¾¿äºä½ ç†è§£ï¼Œæˆ‘ä»¬æŠŠé©±åŠ¨ç¨‹åºå’Œå†…æ ¸é“¾æ¥åˆ°ä¸€èµ·ï¼Œçœç•¥äº†åŠ è½½é©±åŠ¨ç¨‹åºçš„è¿‡ç¨‹ï¼Œå› ä¸ºåŠ è½½ç¨‹åºä¸ä»…ä»…æ˜¯æŠŠé©±åŠ¨ç¨‹åºæ”¾åœ¨å†…å­˜ä¸­å°±å¯ä»¥äº†ï¼Œè¿˜è¦è¿›è¡Œç¨‹åºé“¾æ¥ç›¸å…³çš„æ“ä½œï¼Œè¿™ä¸ªæ“ä½œæå…¶å¤æ‚ï¼Œæˆ‘ä»¬å…ˆä¸åœ¨è¿™é‡Œç ”ç©¶ï¼Œæ„Ÿå…´è¶£çš„è¯ä½ å¯ä»¥è‡ªè¡Œæ‹“å±•ã€‚</p><p>æ—¢ç„¶æˆ‘ä»¬æŠŠå†…æ ¸å’Œé©±åŠ¨ç¨‹åºé“¾æ¥åœ¨äº†ä¸€èµ·ï¼Œå°±éœ€è¦æœ‰ä¸ªæœºåˆ¶è®©å†…æ ¸çŸ¥é“é©±åŠ¨ç¨‹åºçš„å­˜åœ¨ã€‚è¿™ä¸ªæœºåˆ¶å°±æ˜¯é©±åŠ¨ç¨‹åºè¡¨ï¼Œå®ƒå¯ä»¥è¿™æ ·è®¾è®¡ã€‚</p><pre><code>//cosmos/kernel/krlglobal.c\nKRL_DEFGLOB_VARIABLE(drventyexit_t,osdrvetytabl)[]={NULL};\n</code></pre><p>drventyexit_tç±»å‹ï¼Œåœ¨<a href=\"https://time.geekbang.org/column/intro/100078401\">ä¸Šä¸€è¯¾</a>ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£è¿‡äº†ã€‚å®ƒå°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹ï¼Œè¿™é‡Œå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œè€Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ä¸­æ”¾çš„å°±æ˜¯é©±åŠ¨ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œè€Œå†…æ ¸åªéœ€è¦æ‰«æè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œå°±å¯ä»¥è°ƒç”¨åˆ°æ¯ä¸ªé©±åŠ¨ç¨‹åºäº†ã€‚</p><p>æœ‰äº†è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ¥ç€æˆ‘ä»¬è¿˜éœ€è¦å†™å¥½è¿™ä¸ªé©±åŠ¨ç¨‹åºçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>void init_krldriver()\n{\n    //éå†é©±åŠ¨ç¨‹åºè¡¨ä¸­çš„æ¯ä¸ªé©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°\n    for (uint_t ei = 0; osdrvetytabl[ei] != NULL; ei++)\n    {    //è¿è¡Œä¸€ä¸ªé©±åŠ¨ç¨‹åºå…¥å£\n        if (krlrun_driverentry(osdrvetytabl[ei]) == DFCERRSTUS)\n        {\n            hal_sysdie(&quot;init driver err&quot;);\n        }\n    }\n    return;\n}\nvoid init_krl()\n{\n    init_krlmm();\n    init_krldevice();\n    init_krldriver();\n    //â€¦â€¦\n    return;\n}\n</code></pre><p>åƒä¸Šé¢ä»£ç è¿™æ ·ï¼Œæˆ‘ä»¬çš„åˆå§‹åŒ–é©±åŠ¨çš„ä»£ç å°±å†™å¥½äº†ã€‚init_krldriverå‡½æ•°ä¸»è¦çš„å·¥ä½œå°±æ˜¯<strong>éå†é©±åŠ¨ç¨‹åºè¡¨ä¸­çš„æ¯ä¸ªé©±åŠ¨ç¨‹åºå…¥å£ï¼Œå¹¶æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ ç»™krlrun_driverentryå‡½æ•°ã€‚</strong></p><p>æœ‰äº†init_krldriverå‡½æ•°ï¼Œè¿˜è¦åœ¨init_krlå‡½æ•°ä¸­è°ƒç”¨å®ƒï¼Œä¸»è¦è°ƒç”¨ä¸Šè¿°ä»£ç ä¸­çš„è°ƒç”¨é¡ºåºï¼Œè¯·æ³¨æ„ï¼Œä¸€å®šè¦å…ˆåˆå§‹åŒ–è®¾å¤‡è¡¨ï¼Œç„¶åæ‰èƒ½åˆå§‹åŒ–é©±åŠ¨ç¨‹åºï¼Œå¦åˆ™åœ¨é©±åŠ¨ç¨‹åºä¸­å»ºç«‹çš„è®¾å¤‡å’Œé©±åŠ¨å°±æ— å¤„å®‰æ”¾äº†ã€‚</p><h2>è¿è¡Œé©±åŠ¨ç¨‹åº</h2><p>æˆ‘ä»¬ä½¿ç”¨é©±åŠ¨ç¨‹åºè¡¨ï¼Œè™½ç„¶çœç•¥äº†åŠ è½½é©±åŠ¨ç¨‹åºçš„æ­¥éª¤ï¼Œä½†æ˜¯é©±åŠ¨ç¨‹åºå¿…é¡»è¦è¿è¡Œï¼Œæ‰èƒ½å·¥ä½œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¯¦ç»†çœ‹çœ‹è¿è¡Œé©±åŠ¨ç¨‹åºçš„å…¨è¿‡ç¨‹ã€‚</p><h3>è°ƒç”¨é©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°</h3><p>æˆ‘ä»¬é¦–å…ˆæ¥è§£å†³æ€ä¹ˆè°ƒç”¨é©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°ã€‚ä½ è¦çŸ¥é“ï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨é©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°æ˜¯ä¸è¡Œçš„ï¼Œè¦å…ˆç»™å®ƒå‡†å¤‡ä¸€ä¸ªé‡è¦çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯<strong>é©±åŠ¨æè¿°ç¬¦æŒ‡é’ˆ</strong>ã€‚</p><p>ä¸ºäº†å¸®ä½ è¿›ä¸€æ­¥ç†è§£ï¼Œæˆ‘ä»¬æ¥å†™ä¸€ä¸ªå‡½æ•°æè¿°å†…æ ¸åŠ è½½é©±åŠ¨çš„è¿‡ç¨‹ï¼Œåé¢ä»£ç ä¸­drvpå°±æ˜¯ä¸€ä¸ªé©±åŠ¨æè¿°ç¬¦æŒ‡é’ˆã€‚</p><pre><code>drvstus_t krlrun_driverentry(drventyexit_t drventry)\n{\n    driver_t *drvp = new_driver_dsc();//å»ºç«‹driver_tå®ä¾‹å˜é‡\n    if (drvp == NULL)\n    {\n        return DFCERRSTUS;\n    }\n    if (drventry(drvp, 0, NULL) == DFCERRSTUS)//è¿è¡Œé©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°\n    {\n        return DFCERRSTUS;\n    }\n    if (krldriver_add_system(drvp) == DFCERRSTUS)//æŠŠé©±åŠ¨ç¨‹åºåŠ å…¥ç³»ç»Ÿ\n    {\n        return DFCERRSTUS;\n    }\n    return DFCOKSTUS;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…ˆè°ƒç”¨äº† ä¸€ä¸ªnew_driver_dscå‡½æ•°ï¼Œç”¨æ¥å»ºç«‹ä¸€ä¸ªdriver_tç»“æ„å®ä¾‹å˜é‡ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘å·²ç»å¸®ä½ å†™å¥½äº†ã€‚</p><p>ç„¶åå°±æ˜¯è°ƒç”¨ä¼ é€’è¿›æ¥çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä¸”æŠŠdrvpä½œä¸ºå‚æ•°ä¼ é€è¿›å»ã€‚æ¥ç€å†è¿›å…¥é©±åŠ¨ç¨‹åºä¸­è¿è¡Œï¼Œæœ€åï¼Œå½“é©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¿™ä¸ªé©±åŠ¨ç¨‹åºåŠ å…¥åˆ°æˆ‘ä»¬Cosmosç³»ç»Ÿä¸­äº†ã€‚</p><h3>ä¸€ä¸ªé©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°çš„ä¾‹å­</h3><p>ä¸€ä¸ªé©±åŠ¨ç¨‹åºè¦èƒ½å¤Ÿè¢«æ“ä½œç³»ç»Ÿè°ƒç”¨ï¼Œäº§ç”Ÿå®é™…ä½œç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªé©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°ï¼Œå°±è‡³å°‘æœ‰ä¸€å¥—æ ‡å‡†æµç¨‹è¦èµ°ï¼Œå¦åˆ™åªéœ€è¦è¿”å›ä¸€ä¸ªDFCOKSTUSå°±è¡Œäº†ï¼ŒDFCOKSTUSæ˜¯ä¸ªå®ï¼Œè¡¨ç¤ºæˆåŠŸçš„çŠ¶æ€ã€‚</p><p>è¿™ä¸ªæ ‡å‡†æµç¨‹å°±æ˜¯ï¼Œé¦–å…ˆè¦å»ºç«‹å»ºç«‹ä¸€ä¸ªè®¾å¤‡æè¿°ç¬¦ï¼Œæ¥ç€æŠŠé©±åŠ¨ç¨‹åºçš„åŠŸèƒ½å‡½æ•°è®¾ç½®åˆ°driver_tç»“æ„ä¸­çš„drv_dipfunæ•°ç»„ä¸­ï¼Œå¹¶å°†è®¾å¤‡æŒ‚è½½åˆ°é©±åŠ¨ä¸Šï¼Œç„¶åè¦å‘å†…æ ¸æ³¨å†Œè®¾å¤‡ï¼Œæœ€åé©±åŠ¨ç¨‹åºåˆå§‹åŒ–è‡ªå·±çš„ç‰©ç†è®¾å¤‡ï¼Œå®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°ã€‚</p><p>å…‰æè¿°æµç¨‹ä½ è¿˜æ²¡æœ‰ç›´è§‚æ„Ÿå—ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªé©±åŠ¨ç¨‹åºçš„å®é™…ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>drvstus_t systick_entry(driver_t* drvp,uint_t val,void* p)\n{\n    if(drvp==NULL) //drvpæ˜¯å†…æ ¸ä¼ é€’è¿›æ¥çš„å‚æ•°ï¼Œä¸èƒ½ä¸ºNULL\n    {\n        return DFCERRSTUS;\n    }\n    device_t* devp=new_device_dsc();//å»ºç«‹è®¾å¤‡æè¿°ç¬¦ç»“æ„çš„å˜é‡å®ä¾‹\n    if(devp==NULL)//ä¸èƒ½å¤±è´¥\n    {\n        return DFCERRSTUS;\n    }\n    systick_set_device(devp,drvp);//é©±åŠ¨ç¨‹åºçš„åŠŸèƒ½å‡½æ•°è®¾ç½®åˆ°driver_tç»“æ„ä¸­çš„drv_dipfunæ•°ç»„ä¸­\n    if(krldev_add_driver(devp,drvp)==DFCERRSTUS)//å°†è®¾å¤‡æŒ‚è½½åˆ°é©±åŠ¨ä¸­\n    {\n        if(del_device_dsc(devp)==DFCERRSTUS)//æ³¨æ„é‡Šæ”¾èµ„æº\n        {\n            return DFCERRSTUS;\n        }\n        return DFCERRSTUS;\n    }\n    if(krlnew_device(devp)==DFCERRSTUS)//å‘å†…æ ¸æ³¨å†Œè®¾å¤‡\n    {\n        if(del_device_dsc(devp)==DFCERRSTUS)//æ³¨æ„é‡Šæ”¾èµ„æº\n        {\n            return DFCERRSTUS;\n        }\n        return DFCERRSTUS;\n    }\n    //å®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°systick_handle\n    if(krlnew_devhandle(devp,systick_handle,20)==DFCERRSTUS)\n    {\n        return DFCERRSTUS;  //æ³¨æ„é‡Šæ”¾èµ„æº\n    }\n    init_8254();//åˆå§‹åŒ–ç‰©ç†è®¾å¤‡ \n    if(krlenable_intline(20)==DFCERRSTUS)\n    { \n        return DFCERRSTUS;\n    }\n    return DFCOKSTUS;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç æ˜¯ä¸€ä¸ªçœŸå®è®¾å¤‡é©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°çš„æ ‡å‡†æµç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œä¸èƒ½è¿è¡Œï¼Œæ˜¯ä¸€ä¸ªé©±åŠ¨ç¨‹åºæ¡†æ¶ï¼Œè¿™ä¸ªä¾‹å­å‘Šè¯‰æˆ‘ä»¬ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸è¦ä¸ºé©±åŠ¨ç¨‹åºå¼€å‘è€…<strong>æä¾›å“ªäº›åŠŸèƒ½æ¥å£å‡½æ•°</strong>ï¼Œè¿™åœ¨å¾ˆå¤šé€šç”¨æ“ä½œç³»ç»Ÿä¸Šå«ä½œ<strong>é©±åŠ¨æ¨¡å‹</strong>ã€‚</p><h3>è®¾å¤‡ä¸é©±åŠ¨çš„è”ç³»</h3><p>ä¸Šé¢çš„ä¾‹å­åªæ˜¯æ¼”ç¤ºæµç¨‹çš„ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å†™å¥½ä¾›é©±åŠ¨ç¨‹åºå¼€å‘è€…ä½¿ç”¨çš„æ¥å£å‡½æ•°ï¼Œæˆ‘ä»¬è¿™å°±æ¥å†™å¥½è¿™äº›æ¥å£å‡½æ•°ã€‚</p><p>æˆ‘ä»¬è¦å†™çš„ç¬¬ä¸€ä¸ªæ¥å£å°±æ˜¯å°†è®¾å¤‡æŒ‚è½½åˆ°é©±åŠ¨ä¸Šï¼Œè®©è®¾å¤‡å’Œé©±åŠ¨äº§ç”Ÿè”ç³»ï¼Œç¡®ä¿é©±åŠ¨èƒ½æ‰¾åˆ°è®¾å¤‡ï¼Œè®¾å¤‡èƒ½æ‰¾åˆ°é©±åŠ¨ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t krldev_add_driver(device_t *devp, driver_t *drvp)\n{\n    list_h_t *lst;\n    device_t *fdevp;\n    //éå†è¿™ä¸ªé©±åŠ¨ä¸Šæ‰€æœ‰è®¾å¤‡\n    list_for_each(lst, &amp;drvp-&gt;drv_alldevlist)\n    {\n        fdevp = list_entry(lst, device_t, dev_indrvlst);\n        //æ¯”è¾ƒè®¾å¤‡IDæœ‰ç›¸åŒçš„åˆ™è¿”å›é”™è¯¯\n        if (krlcmp_devid(&amp;devp-&gt;dev_id, &amp;fdevp-&gt;dev_id) == TRUE)\n        {\n            return DFCERRSTUS;\n        }\n    }\n    //å°†è®¾å¤‡æŒ‚è½½åˆ°é©±åŠ¨ä¸Š\n    list_add(&amp;devp-&gt;dev_indrvlst, &amp;drvp-&gt;drv_alldevlist);\n    devp-&gt;dev_drv = drvp;//è®©è®¾å¤‡ä¸­dev_drvå­—æ®µæŒ‡å‘ç®¡ç†è‡ªå·±çš„é©±åŠ¨\n    return DFCOKSTUS;\n}\n</code></pre><p>ç”±äºæˆ‘ä»¬çš„è®¾è®¡ä¸€ä¸ªé©±åŠ¨ç¨‹åºå¯ä»¥ç®¡ç†å¤šä¸ªè®¾å¤‡ï¼Œæ‰€ä»¥åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œè¦éå†é©±åŠ¨è®¾å¤‡é“¾è¡¨ä¸­çš„æ‰€æœ‰è®¾å¤‡ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è®¾å¤‡IDå†²çªã€‚å¦‚æœæ²¡æœ‰å°±æŠŠè¿™ä¸ªè®¾å¤‡è½½å…¥è¿™ä¸ªé©±åŠ¨ä¸­ï¼Œå¹¶æŠŠè®¾å¤‡ä¸­çš„ç›¸å…³å­—æ®µæŒ‡å‘è¿™ä¸ªç®¡ç†è‡ªå·±çš„é©±åŠ¨ï¼Œè¿™æ ·è®¾å¤‡å’Œé©±åŠ¨å°±è”ç³»èµ·æ¥äº†ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Ÿ</p><h3>å‘å†…æ ¸æ³¨å†Œè®¾å¤‡</h3><p>ä¸€ä¸ªè®¾å¤‡è¦æƒ³è¢«å†…æ ¸æ„ŸçŸ¥ï¼Œæœ€ç»ˆä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œå°±è¦å…ˆå‘å†…æ ¸æ³¨å†Œï¼Œè¿™ä¸ªæ³¨å†Œè¿‡ç¨‹åº”è¯¥ç”±å†…æ ¸æ¥å®ç°å¹¶æä¾›æ¥å£ï¼Œåœ¨è¿™ä¸ªæ³¨å†Œè®¾å¤‡çš„è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸ä¼šé€šè¿‡è®¾å¤‡çš„ç±»å‹å’ŒIDï¼ŒæŠŠç”¨æ¥è¡¨ç¤ºè®¾å¤‡çš„device_tç»“æ„æŒ‚è½½åˆ°è®¾å¤‡è¡¨ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å†™å¥½è¿™éƒ¨åˆ†ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t krlnew_device(device_t *devp)\n{\n    device_t *findevp;\n    drvstus_t rets = DFCERRSTUS;\n    cpuflg_t cpufg;\n    list_h_t *lstp;\n    devtable_t *dtbp = &amp;osdevtable;\n    uint_t devmty = devp-&gt;dev_id.dev_mtype;\n    if (devp-&gt;dev_drv == NULL)//æ²¡æœ‰é©±åŠ¨çš„è®¾å¤‡ä¸è¡Œ\n    {\n        return DFCERRSTUS;\n    }\n    krlspinlock_cli(&amp;dtbp-&gt;devt_lock, &amp;cpufg);//åŠ é”\n    //éå†è®¾å¤‡ç±»å‹é“¾è¡¨ä¸Šçš„æ‰€æœ‰è®¾å¤‡\n    list_for_each(lstp, &amp;dtbp-&gt;devt_devclsl[devmty].dtl_list)\n    {\n        findevp = list_entry(lstp, device_t, dev_intbllst);\n        //ä¸èƒ½æœ‰è®¾å¤‡IDç›¸åŒçš„è®¾å¤‡ï¼Œå¦‚æœæœ‰åˆ™å‡ºé”™\n        if (krlcmp_devid(&amp;devp-&gt;dev_id, &amp;findevp-&gt;dev_id) == TRUE)\n        {\n            rets = DFCERRSTUS;\n            goto return_step;\n        }\n    }\n    //å…ˆæŠŠè®¾å¤‡åŠ å…¥è®¾å¤‡è¡¨çš„å…¨å±€è®¾å¤‡é“¾è¡¨\n    list_add(&amp;devp-&gt;dev_intbllst, &amp;dtbp-&gt;devt_devclsl[devmty].dtl_list);\n    //å°†è®¾å¤‡åŠ å…¥å¯¹åº”è®¾å¤‡ç±»å‹çš„é“¾è¡¨ä¸­\n    list_add(&amp;devp-&gt;dev_list, &amp;dtbp-&gt;devt_devlist);\n    dtbp-&gt;devt_devclsl[devmty].dtl_nr++;//è®¾å¤‡è®¡æ•°åŠ ä¸€\n    dtbp-&gt;devt_devnr++;//æ€»çš„è®¾å¤‡æ•°åŠ ä¸€\n    rets = DFCOKSTUS;\nreturn_step:\n    krlspinunlock_sti(&amp;dtbp-&gt;devt_lock, &amp;cpufg);//è§£é”\n    return rets;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œä¸»è¦æ˜¯æ£€æŸ¥åœ¨è®¾å¤‡è¡¨ä¸­æœ‰æ²¡æœ‰è®¾å¤‡IDå†²çªï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±åŠ å…¥è®¾å¤‡ç±»å‹é“¾è¡¨å’Œå…¨å±€è®¾å¤‡é“¾è¡¨ä¸­ï¼Œæœ€åå¯¹å…¶è®¡æ•°å™¨å˜é‡åŠ ä¸€ã€‚å®Œæˆäº†è¿™äº›æ“ä½œä¹‹åï¼Œæˆ‘ä»¬åœ¨æ“ä½œè®¾å¤‡æ—¶ï¼Œé€šè¿‡è®¾å¤‡IDå°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„è®¾å¤‡äº†ã€‚</p><h3>å®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°</h3><p>è®¾å¤‡å¾ˆå¤šæ—¶å€™å¿…é¡»è¦å’ŒCPUè¿›è¡Œé€šä¿¡ï¼Œè¿™æ˜¯é€šè¿‡ä¸­æ–­çš„å½¢å¼è¿›è¡Œçš„ï¼Œä¾‹å¦‚ï¼Œå½“ç¡¬ç›˜çš„æ•°æ®è¯»å–æˆåŠŸã€å½“ç½‘å¡åˆæ¥äº†æ•°æ®ã€æˆ–è€…å®šæ—¶å™¨çš„æ—¶é—´å·²ç»è¿‡æœŸï¼Œè¿™æ—¶å€™è¿™äº›è®¾å¤‡å°±ä¼šå‘å‡ºä¸­æ–­ä¿¡å·ï¼Œä¸­æ–­ä¿¡å·ä¼šè¢«ä¸­æ–­æ§åˆ¶å™¨æ¥å—ï¼Œç„¶åå‘é€ç»™CPUè¯·æ±‚å†…æ ¸å…³æ³¨ã€‚</p><p>æ”¶åˆ°ä¸­æ–­ä¿¡å·åï¼ŒCPUå°±ä¼šå¼€å§‹å¤„ç†ä¸­æ–­ï¼Œè½¬è€Œè°ƒç”¨ä¸­æ–­å¤„ç†æ¡†æ¶å‡½æ•°ï¼Œæœ€åä¼šè°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºæä¾›çš„ä¸­æ–­å›è°ƒå‡½æ•°ï¼Œå¯¹è¯¥è®¾å¤‡å‘å‡ºçš„ä¸­æ–­è¿›è¡Œå…·ä½“å¤„ç†ã€‚</p><p>æ—¢ç„¶ä¸­æ–­å›è°ƒå‡½æ•°æ˜¯é©±åŠ¨ç¨‹åºæä¾›çš„ï¼Œæˆ‘ä»¬å†…æ ¸å°±è¦æä¾›ç›¸åº”çš„<strong>æ¥å£</strong>ç”¨äºå®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°ï¼Œä½¿å¾—é©±åŠ¨ç¨‹åºå¼€å‘è€…ä¸“æ³¨äºè®¾å¤‡æœ¬èº«ï¼Œä¸ç”¨åˆ†å¿ƒå»äº†è§£å†…æ ¸çš„ä¸­æ–­æ¡†æ¶ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å®ç°è¿™ä¸ªå®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°çš„æ¥å£å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//ä¸­æ–­å›è°ƒå‡½æ•°ç±»å‹\ntypedef drvstus_t (*intflthandle_t)(uint_t ift_nr,void* device,void* sframe);\n//å®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°æ¥å£\ndrvstus_t krlnew_devhandle(device_t *devp, intflthandle_t handle, uint_t phyiline)\n{\n    //è°ƒç”¨å†…æ ¸å±‚ä¸­æ–­æ¡†æ¶æ¥å£å‡½æ•°\n    intserdsc_t *sdp = krladd_irqhandle(devp, handle, phyiline);\n    if (sdp == NULL)\n    {\n        return DFCERRSTUS;\n    }\n    cpuflg_t cpufg;\n    krlspinlock_cli(&amp;devp-&gt;dev_lock, &amp;cpufg);\n    //å°†ä¸­æ–­æœåŠ¡æè¿°ç¬¦ç»“æ„æŒ‚å…¥è¿™ä¸ªè®¾å¤‡ç»“æ„ä¸­\n    list_add(&amp;sdp-&gt;s_indevlst, &amp;devp-&gt;dev_intserlst);\n    devp-&gt;dev_intlnenr++;\n    krlspinunlock_sti(&amp;devp-&gt;dev_lock, &amp;cpufg);\n    return DFCOKSTUS;\n}\n</code></pre><p>æˆ‘æ¥ç»™ä½ åšä¸ªè§£è¯»ï¼Œä¸Šè¿°ä»£ç ä¸­ï¼Œkrlnew_devhandleå‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°çš„è®¾å¤‡ï¼Œé©±åŠ¨ç¨‹åºæä¾›çš„ä¸­æ–­å›è°ƒå‡½æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯è®¾å¤‡åœ¨ä¸­æ–­æ§åˆ¶å™¨ä¸­æ–­çº¿çš„å·ç ã€‚</p><p>krlnew_devhandleå‡½æ•°ä¸­ä¸€å¼€å§‹å°±ä¼šè°ƒç”¨å†…æ ¸å±‚çš„ä¸­æ–­æ¡†æ¶æ¥å£ï¼Œä½ å‘ç°äº†ä¹ˆï¼Ÿè¿™ä¸ªæ¥å£è¿˜æ²¡å†™å‘¢ï¼Œæ‰€ä»¥æˆ‘ä»¬é©¬ä¸Šå°±å»å†™å¥½å®ƒï¼Œä½†æ˜¯æˆ‘ä»¬ä¸åº”è¯¥åœ¨krldevice.cæ–‡ä»¶ä¸­å†™ï¼Œè€Œæ˜¯è¦åœ¨cosmos/kernel/ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªkrlintupt.cæ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶æ¨¡å—ä¸­å†™ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>typedef struct s_INTSERDSC{    \n    list_h_t    s_list;        //åœ¨ä¸­æ–­å¼‚å¸¸æè¿°ç¬¦ä¸­çš„é“¾è¡¨\n    list_h_t    s_indevlst;    //åœ¨è®¾å¤‡æè¿°æè¿°ç¬¦ä¸­çš„é“¾è¡¨\n    u32_t       s_flg;         //æ ‡å¿—\n    intfltdsc_t* s_intfltp;    //æŒ‡å‘ä¸­æ–­å¼‚å¸¸æè¿°ç¬¦ \n    void*       s_device;      //æŒ‡å‘è®¾å¤‡æè¿°ç¬¦\n    uint_t      s_indx;        //ä¸­æ–­å›è°ƒå‡½æ•°è¿è¡Œè®¡æ•°\n    intflthandle_t s_handle;   //ä¸­æ–­å¤„ç†çš„å›è°ƒå‡½æ•°æŒ‡é’ˆ\n}intserdsc_t;\n\nintserdsc_t *krladd_irqhandle(void *device, intflthandle_t handle, uint_t phyiline)\n{    //æ ¹æ®è®¾å¤‡ä¸­æ–­çº¿è¿”å›å¯¹åº”ä¸­æ–­å¼‚å¸¸æè¿°ç¬¦\n    intfltdsc_t *intp = hal_retn_intfltdsc(phyiline);\n    if (intp == NULL)\n    {\n        return NULL;\n    }\n    intserdsc_t *serdscp = (intserdsc_t *)krlnew(sizeof(intserdsc_t));//å»ºç«‹ä¸€ä¸ªintserdsc_tç»“æ„ä½“å®ä¾‹å˜é‡\n    if (serdscp == NULL)\n    {\n        return NULL;\n    }\n    //åˆå§‹åŒ–intserdsc_tç»“æ„ä½“å®ä¾‹å˜é‡ï¼Œå¹¶æŠŠè®¾å¤‡æŒ‡é’ˆå’Œå›è°ƒå‡½æ•°æ”¾å…¥å…¶ä¸­\n    intserdsc_t_init(serdscp, 0, intp, device, handle);\n    //æŠŠintserdsc_tç»“æ„ä½“å®ä¾‹å˜é‡æŒ‚è½½åˆ°ä¸­æ–­å¼‚å¸¸æè¿°ç¬¦ç»“æ„ä¸­\n    if (hal_add_ihandle(intp, serdscp) == FALSE)\n    {\n        if (krldelete((adr_t)serdscp, sizeof(intserdsc_t)) == FALSE)\n        {\n            hal_sysdie(&quot;krladd_irqhandle ERR&quot;);\n        }\n        return NULL;\n    }\n    return serdscp;\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­hal_add_ihandleã€hal_retn_intfltdscå‡½æ•°ï¼Œæˆ‘å·²ç»å¸®ä½ å†™å¥½äº†ï¼Œå¦‚æœä½ ä¸æ˜ç™½å…¶ä¸­åŸç†ï¼Œå¯ä»¥å›åˆ°åˆå§‹åŒ–ä¸­æ–­é‚£èŠ‚è¯¾çœ‹çœ‹ã€‚</p><p>krladd_irqhandleå‡½æ•°ï¼Œå®ƒçš„ä¸»è¦å·¥ä½œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªintserdsc_tç»“æ„ï¼Œç”¨æ¥ä¿å­˜è®¾å¤‡å’Œå…¶é©±åŠ¨ç¨‹åºæä¾›çš„ä¸­æ–­å›è°ƒå‡½æ•°ã€‚åŒæ—¶ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œé€šè¿‡intserdsc_tç»“æ„ä¹Ÿè®©ä¸­æ–­å¤„ç†æ¡†æ¶å’Œè®¾å¤‡é©±åŠ¨è”ç³»èµ·æ¥äº†ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œä¸­æ–­æ¥äº†ä»¥åï¼Œåç»­çš„å·¥ä½œå°±èƒ½æœ‰åºå¼€å±•äº†ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ï¼Œä¸­æ–­å¤„ç†æ¡†æ¶æ—¢èƒ½æ‰¾åˆ°å¯¹åº”çš„intserdsc_tç»“æ„ï¼Œåˆèƒ½ä»intserdsc_tç»“æ„ä¸­å¾—åˆ°ä¸­æ–­å›è°ƒå‡½æ•°å’Œå¯¹åº”çš„è®¾å¤‡æè¿°ç¬¦ï¼Œä»è€Œè°ƒç”¨ä¸­æ–­å›è°ƒå‡½æ•°ï¼Œè¿›è¡Œå…·ä½“è®¾å¤‡çš„ä¸­æ–­å¤„ç†ã€‚</p><h3>é©±åŠ¨åŠ å…¥å†…æ ¸</h3><p>å½“æ“ä½œç³»ç»Ÿå†…æ ¸è°ƒç”¨äº†é©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°ï¼Œé©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°å°±ä¼šè¿›è¡Œä¸€ç³»åˆ—æ“ä½œï¼ŒåŒ…æ‹¬å»ºç«‹è®¾å¤‡ï¼Œå®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°ç­‰ç­‰ï¼Œå†ä¹‹åå°±ä¼šè¿”å›åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šæ ¹æ®è¿”å›çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦å°†è¯¥é©±åŠ¨ç¨‹åºåŠ å…¥åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­ã€‚ä½ å¯ä»¥è¿™æ ·ç†è§£ï¼Œæ‰€è°“å°†é©±åŠ¨ç¨‹åºåŠ å…¥åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ— éå°±æ˜¯<strong>å°†driver_tç»“æ„çš„å®ä¾‹å˜é‡æŒ‚è½½åˆ°è®¾å¤‡è¡¨ä¸­</strong>ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥å†™è¿™ä¸ªå®ç°æŒ‚è½½åŠŸèƒ½çš„å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>drvstus_t krldriver_add_system(driver_t *drvp)\n{\n    cpuflg_t cpufg;\n    devtable_t *dtbp = &amp;osdevtable;//è®¾å¤‡è¡¨\n    krlspinlock_cli(&amp;dtbp-&gt;devt_lock, &amp;cpufg);//åŠ é”\n    list_add(&amp;drvp-&gt;drv_list, &amp;dtbp-&gt;devt_drvlist);//æŒ‚è½½\n    dtbp-&gt;devt_drvnr++;//å¢åŠ é©±åŠ¨ç¨‹åºè®¡æ•°\n    krlspinunlock_sti(&amp;dtbp-&gt;devt_lock, &amp;cpufg);//è§£é”\n    return DFCOKSTUS;\n}\n</code></pre><p>é…åˆä»£ç ä¸­çš„æ³¨é‡Šï¼Œç›¸ä¿¡è¿™é‡Œçš„æ€è·¯ä½ å¾ˆå®¹æ˜“å°±èƒ½é¢†ä¼šã€‚ç”±äºé©±åŠ¨ç¨‹åºä¸éœ€è¦åˆ†é—¨åˆ«ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæŠŠå®ƒæŒ‚è½½åˆ°è®¾å¤‡è¡¨ä¸­ä¸€ä¸ªå…¨å±€é©±åŠ¨ç¨‹åºé“¾è¡¨ä¸Šå°±è¡Œäº†ï¼Œæœ€åç®€å•åœ°å¢åŠ ä¸€ä¸‹é©±åŠ¨ç¨‹åºè®¡æ•°å˜é‡ï¼Œç”¨æ¥è¡¨æ˜æœ‰å¤šå°‘ä¸ªé©±åŠ¨ç¨‹åºã€‚</p><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬æ“ä½œç³»ç»Ÿå†…æ ¸å‘é©±åŠ¨ç¨‹åºå¼€å‘äººå‘˜æä¾›çš„å¤§éƒ¨åˆ†åŠŸèƒ½æ¥å£å°±å®ç°äº†ã€‚ä½ è‡ªå·±ä¹Ÿå¯ä»¥å†™é©±åŠ¨ç¨‹åºè¯•è¯•ï¼Œçœ‹çœ‹æ˜¯å¦åªéœ€è¦å…³æ³¨è®¾å¤‡æœ¬èº«ï¼Œè€Œæ— é¡»å…³æ³¨æ“ä½œç³»ç»Ÿå…¶å®ƒçš„éƒ¨ä»¶ã€‚è¿™å°±æ˜¯æˆ‘ä»¬Cosmosçš„é©±åŠ¨æ¨¡å‹ï¼Œè™½ç„¶åšäº†ç®€åŒ–ï¼Œä½†éº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>åˆåˆ°äº†è¯¾ç¨‹ç»“æŸçš„æ—¶å€™ï¼Œä»Šå¤©æˆ‘ä»¬é€šè¿‡è¿™èŠ‚è¯¾å·²ç»äº†è§£åˆ°ï¼Œä¸€ä¸ªé©±åŠ¨ç¨‹åºå¼€å§‹æ˜¯ç”±å†…æ ¸åŠ è½½è¿è¡Œï¼Œç„¶åè°ƒç”¨ç”±å†…æ ¸æä¾›çš„æ¥å£å»ºç«‹è®¾å¤‡ï¼Œæœ€åå‘å†…æ ¸æ³¨å†Œè®¾å¤‡å’Œé©±åŠ¨ï¼Œå®Œæˆé©±åŠ¨å’Œå†…æ ¸çš„æ¡æ‰‹åŠ¨ä½œã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬ä¸€å¼€å§‹ä»å…¨å±€å‡ºå‘ï¼Œäº†è§£äº†è®¾å¤‡çš„å»ºç«‹æµç¨‹ã€‚</p><p>ç„¶åä¸ºäº†ç®€åŒ–å†…æ ¸åŠ è½½é©±åŠ¨ç¨‹åºçš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªé©±åŠ¨ç¨‹åºè¡¨ã€‚</p><p>æœ€åï¼ŒæŒ‰ç…§é©±åŠ¨ç¨‹åºçš„å¼€å‘æµç¨‹ï¼Œæˆ‘ä»¬ç»™é©±åŠ¨ç¨‹åºå¼€å‘è€…æä¾›äº†ä¸€ç³»åˆ—æ¥å£ï¼Œå®ƒä»¬æ˜¯å»ºç«‹æ³¨å†Œè®¾å¤‡ã€è®¾å¤‡åŠ å…¥é©±åŠ¨ã€å®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°ï¼Œé©±åŠ¨åŠ å…¥åˆ°ç³»ç»Ÿç­‰ï¼Œè¿™äº›å…±åŒæ„æˆäº†ä¸€ä¸ªæœ€ç®€åŒ–çš„é©±åŠ¨æ¨¡å‹ã€‚</p><p>ä½ å¯èƒ½ä¼šæ„Ÿè§‰æˆ‘ä»¬è™½ç„¶è§£å†³äº†å»ºç«‹è®¾å¤‡çš„é—®é¢˜ï¼Œå¯æ˜¯æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿè¿™æ­£æ˜¯æˆ‘ä»¬ä¸‹ä¸€è¯¾è¦è®¨è®ºçš„ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·ä½ å†™å‡ºå¸®é©±åŠ¨ç¨‹åºå¼€å‘è€…è‡ªåŠ¨åˆ†é…è®¾å¤‡IDæ¥å£å‡½æ•°ã€‚</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘äº¤æµäº’åŠ¨ã€‚ä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™è‡ªå·±çš„åŒäº‹ã€æœ‹å‹ã€‚</p><p>å¥½ï¼Œæˆ‘æ˜¯LMOSï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>","neighbors":{"left":{"article_title":"28 | éƒ¨é—¨åˆ†ç±»ï¼šå¦‚ä½•è¡¨ç¤ºè®¾å¤‡ç±»å‹ä¸è®¾å¤‡é©±åŠ¨ï¼Ÿ","id":394084},"right":{"article_title":"30 | éƒ¨é—¨å“åº”ï¼šè®¾å¤‡å¦‚ä½•å¤„ç†å†…æ ¸I/OåŒ…ï¼Ÿ","id":395772}},"comments":[{"had_liked":false,"id":303164,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":true,"comment_ctime":1626625910,"is_pvip":false,"replies":[{"id":"109727","content":"è€å“¥ æ€»ç»“çš„å¾ˆå¥½","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1626660332,"ip_address":"","comment_id":303164,"utype":1}],"discussion_count":1,"race_medal":0,"score":"9.2233720599561994e+18","product_id":100078401,"comment_content":"<br>ä¸€ã€æ•°æ®ç»“æ„<br>æœ‰ä¸€ä¸ªå…¨å±€çš„drventyexit_tæ•°ç»„å˜é‡osdrvetytablï¼Œç”¨äºä¿å­˜å…¨éƒ¨é©±åŠ¨ç¨‹åºå…¥å£å‡½æ•°<br>ä¸»è¦æ˜¯ä¸ºäº†ä¾¿äºç†è§£ï¼Œé€šè¿‡å…¨å±€æ•°ç»„æ–¹å¼æšä¸¾å¹¶åŠ è½½é©±åŠ¨ï¼Œä¸éœ€è¦æ¶‰åŠåŠ¨æ€åŠ è½½å†…æ ¸æ¨¡å—çš„ç›¸å…³å†…å®¹<br><br>äºŒã€åˆå§‹åŒ–<br>init_krl-&gt;init_krldriver<br>éå†é©±åŠ¨ç¨‹åºè¡¨ä¸­çš„æ¯ä¸ªé©±åŠ¨ç¨‹åºå…¥å£ï¼Œå¹¶æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ ç»™ krlrun_driverentry å‡½æ•°<br><br>åœ¨krlrun_driverentryå‡½æ•°ä¸­<br>-&gt;new_driver_dsc-&gt;driver_t_initï¼Œåˆå§‹åŒ–é©±åŠ¨ç»“æ„ï¼Œé©±åŠ¨å¤„ç†å‡½æ•°é»˜è®¤æŒ‡å‘drv_defalt_func<br>-&gt;drventryï¼Œè°ƒç”¨é©±åŠ¨å…¥å£å‡½æ•°<br>-&gt;krldriver_add_systemåªéœ€è¦å°†é©±åŠ¨åŠ å…¥è®¾å¤‡è¡¨çš„é©±åŠ¨é“¾è¡¨å°±å¥½äº†<br><br>å…¶ä¸­ï¼Œåœ¨é©±åŠ¨å…¥å£å‡½æ•°drventryä¸­ã€systick_entryä¸ºä¾‹ã€‘ï¼š<br>-&gt;å»ºç«‹è®¾å¤‡æè¿°ç¬¦ç»“æ„<br>-&gt;å°†é©±åŠ¨ç¨‹åºçš„åŠŸèƒ½å‡½æ•°æŒ‡é’ˆï¼Œè®¾ç½®åˆ°driver_tç»“æ„ä¸­çš„drv_dipfunæ•°ç»„ä¸­<br>-&gt;å°†è®¾å¤‡æŒ‚è½½åˆ°é©±åŠ¨ä¸­<br>-&gt;è°ƒç”¨krlnew_deviceå‘å†…æ ¸æ³¨å†Œè®¾å¤‡<br>-&gt;-&gt;ç¡®è®¤æ²¡æœ‰ç›¸åŒè®¾å¤‡IDï¼Œæ³¨å†Œåˆ°å¯¹åº”è®¾å¤‡ç±»å‹çš„åˆ—è¡¨ä»¥åŠå…¨å±€è®¾å¤‡åˆ—è¡¨<br><br>-&gt;è°ƒç”¨krlnew_devhandle-&gt;krladd_irqhandleï¼Œå®‰è£…ä¸­æ–­å›è°ƒå‡½æ•°systick_handle<br>-&gt;-&gt;è·å–è®¾å¤‡ä¸­æ–­phyilineå¯¹åº”çš„ä¸­æ–­å¼‚å¸¸æè¿°ç¬¦intfltdsc_tç»“æ„ä¸­<br>-&gt;-&gt;æ–°å»ºä¸€ä¸ªintserdsc_tç»“æ„ä½“<br>-&gt;-&gt;åˆå§‹åŒ–ç»“æ„ä½“ï¼Œå¹¶è®¾ç½®å¥½å›è°ƒå‡½æ•°<br>-&gt;-&gt;å°†æ–°çš„intserdsc_tç»“æ„ä½“æŒ‚è½½åˆ°å¯¹åº”çš„intfltdsc_tç»“æ„ä¸­<br>-&gt;-&gt;ä¹Ÿå°±æ˜¯æŠŠé©±åŠ¨ç¨‹åºçš„ä¸­æ–­å¤„ç†å›åˆ°å‡½æ•°ï¼ŒåŠ å…¥åˆ°äº†å¯¹åº”ä¸­æ–­å¤„ç†å›è°ƒå‡½æ•°é“¾è¡¨ä¸­<br><br>-&gt;åˆå§‹åŒ–ç‰©ç†è®¾å¤‡<br>-&gt;å¯ç”¨ä¸­æ–­","like_count":5,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523571,"discussion_content":"è€å“¥ æ€»ç»“çš„å¾ˆå¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626660332,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302584,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1626271912,"is_pvip":false,"replies":[{"id":"109515","content":"å“ˆå“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1626312509,"ip_address":"","comment_id":302584,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10216206504","product_id":100078401,"comment_content":"æƒ³å¤æ‚äº†ï¼Œåº”è¯¥å¯ä»¥è¿™æ ·å®ç°ï¼Œå…¨å±€å®šä¹‰ä¸€ä¸ª device_id =0ï¼Œè·å–idçš„æ—¶å€™è¿”å›è¯¥å€¼ï¼Œç„¶å++ï¼Œæ³¨æ„åŠ é”ã€‚<br>æ—©ä¸Šçœ‹çš„æ—¶å€™çŠ¯è¿·ç³Šäº†ğŸ˜‚","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523357,"discussion_content":"å“ˆå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626312509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313270,"user_name":"Oä¿Š","can_delete":false,"product_type":"c1","uid":2132808,"ip_address":"","ucode":"A7CFC18379BF64","user_header":"https://static001.geekbang.org/account/avatar/00/20/8b/48/ea3f84f3.jpg","comment_is_top":false,"comment_ctime":1632358804,"is_pvip":false,"replies":[{"id":"113518","content":"å¯ä»¥ä½¿ç”¨çœ‹é—¨ç‹—å®šæ—¶å™¨æ¥è§£å†³","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1632445504,"ip_address":"","comment_id":313270,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5927326100","product_id":100078401,"comment_content":"å†…æ ¸ä¼šè°ƒç”¨é©±åŠ¨çš„æ¥å£ï¼Œå¦‚æœé©±åŠ¨åšæ­»å¾ªç¯ä¸è¿”å›å†…æ ¸å’‹åŠã€‚","like_count":1,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527298,"discussion_content":"å¯ä»¥ä½¿ç”¨çœ‹é—¨ç‹—å®šæ—¶å™¨æ¥è§£å†³","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632445504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302439,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1626225475,"is_pvip":false,"replies":[{"id":"109422","content":"è¿™ä¸è¡Œå“¦ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1626228109,"ip_address":"","comment_id":302439,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5921192771","product_id":100078401,"comment_content":"uint_t device_id(device_t *devp) {<br>    return devp-&gt;dev_intlnenr<br>}","like_count":1,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523307,"discussion_content":"è¿™ä¸è¡Œå“¦ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626228109,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200704,"avatar":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","nickname":"pedro","note":"","ucode":"F40C839DDFD599","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383739,"discussion_content":"åé¢å†çœ‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626228196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345051,"user_name":"è‰¾æ©å‡","can_delete":false,"product_type":"c1","uid":2950704,"ip_address":"","ucode":"F2B81BF4F0106A","user_header":"https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg","comment_is_top":false,"comment_ctime":1651983232,"is_pvip":false,"replies":[{"id":"125919","content":"é€Ÿåº¦å¾ˆå¿«å˜›ï¼ŒåŠ æ²¹åŠ æ²¹ï½","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":"1501385","ctime":1651993214,"ip_address":"","comment_id":345051,"utype":2}],"discussion_count":1,"race_medal":0,"score":"1651983232","product_id":100078401,"comment_content":"æ‰“å¡ï¼Œ","like_count":0,"discussions":[{"author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"å¬æ°´çš„æ¹–","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570910,"discussion_content":"é€Ÿåº¦å¾ˆå¿«å˜›ï¼ŒåŠ æ²¹åŠ æ²¹ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651993215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305480,"user_name":"Fan","can_delete":false,"product_type":"c1","uid":1115232,"ip_address":"","ucode":"3BF28670FD9407","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","comment_is_top":false,"comment_ctime":1627988500,"is_pvip":false,"replies":[{"id":"110595","content":"åŠ æ²¹ å“ˆå“ˆ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628128262,"ip_address":"","comment_id":305480,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1627988500","product_id":100078401,"comment_content":"ä»£ç æ²¡çœ‹æ‡‚ï¼Œçœ‹æ‡‚çš„å¤§è‡´çš„æµç¨‹ã€‚ğŸ˜‚","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524398,"discussion_content":"åŠ æ²¹ å“ˆå“ˆ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628128262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}