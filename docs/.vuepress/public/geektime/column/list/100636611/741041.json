{"id":741041,"title":"第 16 章 NFS服务配置","content":"\n<p>你会经常用到NFS服务，它用于在网络上共享存储。举例来说，假如有3台机器A、B和C，它们需要访问同一个目录，且目录中都是图片。传统的做法是把这些图片分别放到A、B、C中，但若使用NFS，只需要把图片放到A上，然后A再共享给B和C即可。访问B和C时，是通过网络的方式去访问A上那个目录的。</p>\n<h2 id=\"nav_point_340\">16.1 服务端配置NFS</h2>\n<p>在CentOS上使用NFS服务需要安装两个包（<code>nfs-utils</code>和<code>rpcbind</code>），不过当使用<code>yum</code>工具安装<code>nfs-utils</code>时，也会一并安装<code>rpcbind</code>，如下所示：</p>\n<pre class=\"code-rows\"><code># yum install -y nfs-utils</code></pre>\n<p>早期的CentOS版本是需要安装<code>portmap</code>包的，从CentOS 6开始，就改为安装<code>rpcbind</code>包了。配置NFS比较简单，只需要编辑配置文件 /etc/exports。下面阿铭就先创建一个简单的NFS服务器。</p>\n<p>首先修改配置文件（默认该文件为空），如下所示：</p>\n<pre class=\"code-rows\"><code># vim /etc/exports // 写入如下内容:\n\n/home/nfstestdir 192.168.72.0/24(rw,sync,all_squash,anonuid=1000,anongid=1000)</code></pre>\n<p>这个配置文件就一行，共分为三部分。第一部分是本地要共享出去的目录，第二部分是允许访问的主机（可以是一个IP，也可以是一个IP段），第三部分就是小括号里面的一些权限选项。关于第三部分，阿铭简单介绍一下。</p>\n<ul>\n<li><strong><code>rw</code></strong>：表示读/写。</li>\n<li><strong><code>ro</code></strong>：表示只读。</li>\n<li><strong><code>sync</code></strong>：同步模式，表示把内存中的数据实时写入磁盘。</li>\n<li><strong><code>async</code></strong>：非同步模式，表示把内存中的数据定期写入磁盘。</li>\n<li><strong><code>no_root_squash</code></strong>：加上这个选项后，root用户就会对共享的目录拥有至高的权限控制，就像是对本机的目录操作一样。但这样安全性降低。</li>\n<li><strong><code>root_squash</code></strong>：与<code>no_root_squash</code>选项对应，表示root用户对共享目录的权限不高，只有普通用户的权限，即限制了root。</li>\n<li><strong><code>all_squash</code></strong>：表示不管使用NFS的用户是谁，其身份都会被限定为一个指定的普通用户身份。</li>\n<li><strong><code>anonuid/anongid</code></strong>：要和<code>root_squash</code>以及<code>all_squash</code>选项一同使用，用于指定使用NFS的用户被限定后的<code>uid</code>和<code>gid</code>，但前提是本机的/etc/passwd中存在相应的<code>uid</code>和<code>gid</code>。</li>\n</ul>\n<p>介绍了NFS的相关权限选项后，阿铭再来分析一下刚刚配置的/etc/exports文件。假设要共享的目录为/home/nfstestdir，信任的主机为192.168.72.0/24这个网段，权限为读/写，同步模式，限定所有使用者，并且限定的<code>uid</code>和<code>gid</code>都为<code>1000</code>。</p><!-- [[[read_end]]] -->\n<p>编辑好配置文件后创建相关目录并启动NFS服务，如下所示：</p>\n<pre class=\"code-rows\"><code># mkdir /home/nfstestdir\n# systemctl start rpcbind\n# systemctl start nfs-server\n# systemctl enable rpcbind\n# systemctl enable nfs-server</code></pre>\n<p>在启动NFS服务之前，需要先启动<code>rpcbind</code>服务（CentOS的老版本中为<code>portmap</code>）。</p>\n<h2 id=\"nav_point_341\">16.2 客户端挂载NFS</h2>\n<p>做本节试验最好是打开另外一台虚拟机，如果你的计算机资源吃紧，也可以在一台机器上操作，即客户端、服务端同用一台机器。阿铭的两台虚拟机IP地址分别为192.168.72.128和192.168.72.129，其中提供NFS服务的是192.168.72.128。在客户端挂载NFS之前，我们需要先查看服务端共享了哪些目录。客户端（192.168.72.129）安装<code>nfs-utils</code>包后，可以使用<code>showmount</code>命令查看，如下所示：</p>\n<pre class=\"code-rows\"><code># showmount -e 192.168.72.128\nExport list for 192.168.72.128:\n/home/nfstestdir 192.168.72.0/24</code></pre>\n<p>使用命令<code>showmount -e IP</code>就可以查看NFS的共享情况，从上例我们可以看到192.168.72.128的共享目录为/home/nfstestdir，信任主机为192.168.72.0/24这个网段。</p>\n<p>然后在客户端上（192.168.72.129）挂载NFS，如下所示：</p>\n<pre class=\"code-rows\"><code># mount -t nfs 192.168.72.128:/home/nfstestdir /mnt/\n# df -h\n文件系统 容量 已用 可用 已用% 挂载点\ndevtmpfs 888M 0 888M 0% /dev\ntmpfs 904M 0 904M 0% /dev/shm\ntmpfs 904M 8.7M 895M 1% /run\ntmpfs 904M 0 904M 0% /sys/fs/cgroup\n/dev/sda3 28G 6.2G 22G 23% /\n/dev/sda1 190M 127M 49M 73% /boot\ntmpfs 181M 0 181M 0% /run/user/0\n192.168.72.128:/home/nfstestdir 28G 6.2G 22G 23% /mnt</code></pre>\n<p>使用命令<code>df -h</code>可以看到增加了一个 /mnt分区，它就是NFS共享的目录了。进入 /mnt/ 目录下，并创建测试文件：</p>\n<pre class=\"code-rows\"><code># cd /mnt/\n# touch aminglinux.txt\ntouch: 无法创建\"aminglinux.txt\": 权限不够</code></pre>\n<p>这是因为在服务端（192.168.72.128）上创建的/home/nfstestdir目录权限不合适，挂载后相当于被限制为<code>uid</code>为1000的用户，解决该问题需要在服务端（192.168.72.128）上修改/home/nfstestdir目录权限：</p>\n<pre class=\"code-rows\"><code># chmod 777 /home/nfstestdir/</code></pre>\n<p>然后再到客户端上（192.168.72.129）创建测试文件：</p>\n<pre class=\"code-rows\"><code># cd /mnt/\n# touch aminglinux.txt\n# ls -l\n总用量 0\n-rw-r--r-- 1 mysql mysql 0 7月 1 22:16 aminglinux.txt\n# id aming\nuid=1000(mysql) gid=1000(mysql) 组=1000(mysql)</code></pre>\n<p>可以看到创建的新文件aminglinux.txt的所有者和所属组为mysql，其<code>uid</code>和<code>gid</code>都为<code>1000</code>。</p>\n<h2 id=\"nav_point_342\">16.3 命令<code>exportfs</code></h2>\n<p><code>exportfs</code>命令的常用选项为<code>-a</code>、<code>-r</code>、<code>-u</code>和<code>-v</code>，这些选项的含义如下。</p>\n<ul>\n<li><strong><code>-a</code></strong>：表示全部挂载或者卸载。</li>\n<li><strong><code>-r</code></strong>：表示重新挂载。</li>\n<li><strong><code>-u</code></strong>：表示卸载某一个目录。</li>\n<li><strong><code>-v</code></strong>：表示显示共享的目录。</li>\n</ul>\n<p>当改变 /etc/exports配置文件后，使用<code>exportfs</code>命令挂载时不需要重启NFS服务。接下来阿铭做一个试验，首先修改服务端（192.168.72.128）的配置文件，如下所示：</p>\n<pre class=\"code-rows\"><code># vim /etc/exports // 增加一行\n\n/tmp/ 192.168.72.0/24(rw,sync,no_root_squash)</code></pre>\n<p>然后在服务端（192.168.72.128）上执行如下命令：</p>\n<pre class=\"code-rows\"><code># exportfs -arv\nexporting 192.168.72.0/24:/tmp\nexporting 192.168.72.0/24:/home/nfstestdir</code></pre>\n<p>在上一节用到了<code>mount</code>命令。其实用<code>mount</code>命令来挂载NFS服务是有讲究的，它要用<code>-t nfs</code>来指定挂载的类型为<code>nfs</code>。另外在挂载NFS服务时，常用<code>-o nolock</code>选项（即不加锁）。例如，在客户端（192.168.72.129）上执行如下命令：</p>\n<pre class=\"code-rows\"><code># mkdir /aminglinux\n# mount -t nfs -o nolock 192.168.72.128:/tmp/ /aminglinux/</code></pre>\n<p>你还可以把要挂载的NFS目录写到客户端上的/etc/fstab文件中，挂载时只需要执行<code>mount -a</code>命令。例如在/etc/fstab文件里增加一行，如下所示：</p>\n<pre class=\"code-rows\"><code>192.168.72.128:/tmp/ /aminglinux nfs defaults,nolock 0 0</code></pre>\n<p>由于刚刚已挂载了NFS，需要先卸载，执行如下命令：</p>\n<pre class=\"code-rows\"><code># umount /aminglinux</code></pre>\n<p>然后重新挂载，执行如下命令：</p>\n<pre class=\"code-rows\"><code># mount -a</code></pre>\n<p>这样操作的好处是以后开机会自动挂载NFS。刚刚挂载的/aminglinux/目录在服务端设置为了<code>no_root_squash</code>，它并不会限制root用户，也就是说使用root用户创建文件时，跟在客户端本机上创建的一样。下面是实验过程：</p>\n<pre class=\"code-rows\"><code># cd /aminglinux/\n# touch 1.txt\n# ls -l 1.txt\n-rw-r--r-- 1 root root 1113 7月 1 22:19 1.txt</code></pre>\n<p>可以看到1.txt的所有者和所属组全部为root。关于NFS阿铭就讲这么多，相信你很快就能掌握！</p>\n<h2 id=\"nav_point_343\">16.4 课后习题</h2>\n<p>(1) 配置NFS需要安装哪些包？</p>\n<p>(2) 如果不开启<code>rpcbind</code>服务就启动NFS会怎么样？</p>\n<p>(3) 在NFS配置文件中，<code>no_root_squash</code>、<code>all_squash</code>和<code>root_squash</code>分别表示什么含义？</p>\n<p>(4) 用什么命令来查看某个服务器上的NFS共享信息？</p>\n<p>(5) 如何把远程的共享NFS挂载到本地？如何查看本机已经共享的NFS资源？</p>\n<p>(6) 在NFS服务器上，假如更改了配置文件，如何不重启NFS服务使配置生效？</p>\n<p>(7) 挂载NFS时，经常加上<code>-o nolock</code>选项，它的作用是什么？</p>\n<p>(8) 请按要求修改配置：把/data/123/目录共享，针对192.168.10.0/24网段，限制客户端上的所有用户，并限定为<code>uid=800</code>，<code>gid=800</code>。</p>\n<p>(9) 用哪两种方法可以让客户端开机后自动挂载NFS？</p>\n\n<br style=\"page-break-after:always\" />","neighbors":{"left":{"article_title":"第 15 章 常用MySQL操作","id":741040},"right":{"article_title":"第 17 章 配置FTP服务","id":741042}},"comments":[]}