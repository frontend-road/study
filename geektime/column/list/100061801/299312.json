{"id":299312,"title":"07 | Condï¼šæ¡ä»¶å˜é‡çš„å®ç°æœºåˆ¶åŠé¿å‘æŒ‡å—","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>åœ¨å†™Goç¨‹åºä¹‹å‰ï¼Œæˆ‘æ›¾ç»å†™äº†10å¤šå¹´çš„Javaç¨‹åºï¼Œä¹Ÿé¢è¯•è¿‡ä¸å°‘Javaç¨‹åºå‘˜ã€‚åœ¨Javaé¢è¯•ä¸­ï¼Œç»å¸¸è¢«é—®åˆ°çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹å°±æ˜¯ç­‰å¾…/é€šçŸ¥ï¼ˆwait/notifyï¼‰æœºåˆ¶ã€‚é¢è¯•å®˜ç»å¸¸ä¼šè¿™æ ·è€ƒå¯Ÿå€™é€‰äººï¼šè¯·å®ç°ä¸€ä¸ªé™å®šå®¹é‡çš„é˜Ÿåˆ—ï¼ˆqueueï¼‰ï¼Œå½“é˜Ÿåˆ—æ»¡æˆ–è€…ç©ºçš„æ—¶å€™ï¼Œåˆ©ç”¨ç­‰å¾…/é€šçŸ¥æœºåˆ¶å®ç°é˜»å¡æˆ–è€…å”¤é†’ã€‚</p><p>åœ¨Goä¸­ï¼Œä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªç±»ä¼¼çš„é™å®šå®¹é‡çš„é˜Ÿåˆ—ï¼Œè€Œä¸”å®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªè¦ç”¨æ¡ä»¶å˜é‡ï¼ˆCondï¼‰å¹¶å‘åŸè¯­å°±å¯ä»¥ã€‚Condå¹¶å‘åŸè¯­ç›¸å¯¹æ¥è¯´ä¸æ˜¯é‚£ä¹ˆå¸¸ç”¨ï¼Œä½†æ˜¯åœ¨ç‰¹å®šçš„åœºæ™¯ä½¿ç”¨ä¼šäº‹åŠåŠŸå€ï¼Œæ¯”å¦‚ä½ éœ€è¦åœ¨å”¤é†’ä¸€ä¸ªæˆ–è€…æ‰€æœ‰çš„ç­‰å¾…è€…åšä¸€äº›æ£€æŸ¥æ“ä½œçš„æ—¶å€™ã€‚</p><p>é‚£ä¹ˆä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±å­¦ä¹ ä¸‹Condè¿™ä¸ªå¹¶å‘åŸè¯­ã€‚</p><h2>Goæ ‡å‡†åº“çš„Cond</h2><p>Goæ ‡å‡†åº“æä¾›CondåŸè¯­çš„ç›®çš„æ˜¯ï¼Œä¸ºç­‰å¾…/é€šçŸ¥åœºæ™¯ä¸‹çš„å¹¶å‘é—®é¢˜æä¾›æ”¯æŒã€‚Condé€šå¸¸åº”ç”¨äºç­‰å¾…æŸä¸ªæ¡ä»¶çš„ä¸€ç»„goroutineï¼Œç­‰æ¡ä»¶å˜ä¸ºtrueçš„æ—¶å€™ï¼Œå…¶ä¸­ä¸€ä¸ªgoroutineæˆ–è€…æ‰€æœ‰çš„goroutineéƒ½ä¼šè¢«å”¤é†’æ‰§è¡Œã€‚</p><p>é¡¾åæ€ä¹‰ï¼ŒCondæ˜¯å’ŒæŸä¸ªæ¡ä»¶ç›¸å…³ï¼Œè¿™ä¸ªæ¡ä»¶éœ€è¦ä¸€ç»„goroutineåä½œå…±åŒå®Œæˆï¼Œåœ¨æ¡ä»¶è¿˜æ²¡æœ‰æ»¡è¶³çš„æ—¶å€™ï¼Œæ‰€æœ‰ç­‰å¾…è¿™ä¸ªæ¡ä»¶çš„goroutineéƒ½ä¼šè¢«é˜»å¡ä½ï¼Œåªæœ‰è¿™ä¸€ç»„goroutineé€šè¿‡åä½œè¾¾åˆ°äº†è¿™ä¸ªæ¡ä»¶ï¼Œç­‰å¾…çš„goroutineæ‰å¯èƒ½ç»§ç»­è¿›è¡Œä¸‹å»ã€‚</p><!-- [[[read_end]]] --><p>é‚£è¿™é‡Œç­‰å¾…çš„æ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç­‰å¾…çš„æ¡ä»¶ï¼Œå¯ä»¥æ˜¯æŸä¸ªå˜é‡è¾¾åˆ°äº†æŸä¸ªé˜ˆå€¼æˆ–è€…æŸä¸ªæ—¶é—´ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ç»„å˜é‡åˆ†åˆ«éƒ½è¾¾åˆ°äº†æŸä¸ªé˜ˆå€¼ï¼Œè¿˜å¯ä»¥æ˜¯æŸä¸ªå¯¹è±¡çš„çŠ¶æ€æ»¡è¶³äº†ç‰¹å®šçš„æ¡ä»¶ã€‚æ€»ç»“æ¥è®²ï¼Œç­‰å¾…çš„æ¡ä»¶æ˜¯ä¸€ç§å¯ä»¥ç”¨æ¥è®¡ç®—ç»“æœæ˜¯trueè¿˜æ˜¯falseçš„æ¡ä»¶ã€‚</p><p>ä»å¼€å‘å®è·µä¸Šï¼Œæˆ‘ä»¬çœŸæ­£ä½¿ç”¨Condçš„åœºæ™¯æ¯”è¾ƒå°‘ï¼Œå› ä¸ºä¸€æ—¦é‡åˆ°éœ€è¦ä½¿ç”¨Condçš„åœºæ™¯ï¼Œæˆ‘ä»¬æ›´å¤šåœ°ä¼šä½¿ç”¨Channelçš„æ–¹å¼ï¼ˆæˆ‘ä¼šåœ¨ç¬¬12å’Œç¬¬13è®²å±•å¼€Channelçš„ç”¨æ³•ï¼‰å»å®ç°ï¼Œå› ä¸ºé‚£æ‰æ˜¯æ›´åœ°é“çš„Goè¯­è¨€çš„å†™æ³•ï¼Œç”šè‡³Goçš„å¼€å‘è€…æœ‰ä¸ªâ€œæŠŠCondä»æ ‡å‡†åº“ç§»é™¤â€çš„æè®®ï¼ˆ<a href=\"https://github.com/golang/go/issues/21165\">issue 21165</a>ï¼‰ã€‚è€Œæœ‰çš„å¼€å‘è€…è®¤ä¸ºï¼ŒCondæ˜¯å”¯ä¸€éš¾ä»¥æŒæ¡çš„Goå¹¶å‘åŸè¯­ã€‚è‡³äºå…¶ä¸­åŸå› ï¼Œæˆ‘å…ˆå–ä¸ªå…³å­ï¼Œåˆ°è¿™ä¸€è®²çš„ååŠéƒ¨åˆ†æˆ‘å†å’Œä½ è§£é‡Šã€‚</p><p>ä»Šå¤©ï¼Œè¿™ä¸€è®²æˆ‘ä»¬å°±å¸¦ä½ ä»”ç»†åœ°å­¦ä¸€å­¦Condè¿™ä¸ªå¹¶å‘åŸè¯­å§ã€‚</p><h2>Condçš„åŸºæœ¬ç”¨æ³•</h2><p>æ ‡å‡†åº“ä¸­çš„Condå¹¶å‘åŸè¯­åˆå§‹åŒ–çš„æ—¶å€™ï¼Œéœ€è¦å…³è”ä¸€ä¸ªLockeræ¥å£çš„å®ä¾‹ï¼Œä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨Mutexæˆ–è€…RWMutexã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹Condçš„å®ç°ï¼š</p><pre><code>type Cond\n  func NeWCond(l Locker) *Cond\n  func (c *Cond) Broadcast()\n  func (c *Cond) Signal()\n  func (c *Cond) Wait()\n</code></pre><p>é¦–å…ˆï¼ŒCondå…³è”çš„Lockerå®ä¾‹å¯ä»¥é€šè¿‡c.Lè®¿é—®ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªå…ˆå…¥å…ˆå‡ºçš„ç­‰å¾…é˜Ÿåˆ—ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å®ƒçš„ä¸‰ä¸ªæ–¹æ³•Broadcastã€Signalå’ŒWaitæ–¹æ³•ã€‚</p><p><strong>Signalæ–¹æ³•</strong>ï¼Œå…è®¸è°ƒç”¨è€…Callerå”¤é†’ä¸€ä¸ªç­‰å¾…æ­¤Condçš„goroutineã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰ç­‰å¾…çš„goroutineï¼Œæ˜¾ç„¶æ— éœ€é€šçŸ¥waiterï¼›å¦‚æœCondç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…çš„goroutineï¼Œåˆ™éœ€è¦ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ç¬¬ä¸€ä¸ªgoroutineå¹¶æŠŠå®ƒå”¤é†’ã€‚åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ¯”å¦‚Javaè¯­è¨€ä¸­ï¼ŒSignalæ–¹æ³•ä¹Ÿè¢«å«åšnotifyæ–¹æ³•ã€‚</p><p>è°ƒç”¨Signalæ–¹æ³•æ—¶ï¼Œä¸å¼ºæ±‚ä½ ä¸€å®šè¦æŒæœ‰c.Lçš„é”ã€‚</p><p><strong>Broadcastæ–¹æ³•</strong>ï¼Œå…è®¸è°ƒç”¨è€…Callerå”¤é†’æ‰€æœ‰ç­‰å¾…æ­¤Condçš„goroutineã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰ç­‰å¾…çš„goroutineï¼Œæ˜¾ç„¶æ— éœ€é€šçŸ¥waiterï¼›å¦‚æœCondç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…çš„goroutineï¼Œåˆ™æ¸…ç©ºæ‰€æœ‰ç­‰å¾…çš„goroutineï¼Œå¹¶å…¨éƒ¨å”¤é†’ã€‚åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ¯”å¦‚Javaè¯­è¨€ä¸­ï¼ŒBroadcastæ–¹æ³•ä¹Ÿè¢«å«åšnotifyAllæ–¹æ³•ã€‚</p><p>åŒæ ·åœ°ï¼Œè°ƒç”¨Broadcastæ–¹æ³•æ—¶ï¼Œä¹Ÿä¸å¼ºæ±‚ä½ ä¸€å®šæŒæœ‰c.Lçš„é”ã€‚</p><p><strong>Waitæ–¹æ³•</strong>ï¼Œä¼šæŠŠè°ƒç”¨è€…Calleræ”¾å…¥Condçš„ç­‰å¾…é˜Ÿåˆ—ä¸­å¹¶é˜»å¡ï¼Œç›´åˆ°è¢«Signalæˆ–è€…Broadcastçš„æ–¹æ³•ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶å”¤é†’ã€‚</p><p>è°ƒç”¨Waitæ–¹æ³•æ—¶å¿…é¡»è¦æŒæœ‰c.Lçš„é”ã€‚</p><p>Goå®ç°çš„sync.Condçš„æ–¹æ³•åæ˜¯Waitã€Signalå’ŒBroadcastï¼Œè¿™æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­æ¡ä»¶å˜é‡çš„<a href=\"https://en.wikipedia.org/wiki/Monitor_(synchronization)#Condition_variables_2\">é€šç”¨æ–¹æ³•å</a>ã€‚æ¯”å¦‚ï¼ŒCè¯­è¨€ä¸­å¯¹åº”çš„æ–¹æ³•åæ˜¯pthread_cond_waitã€pthread_cond_signalå’Œ pthread_cond_broadcastã€‚</p><p>çŸ¥é“äº†Condæä¾›çš„ä¸‰ä¸ªæ–¹æ³•åï¼Œæˆ‘ä»¬å†é€šè¿‡ä¸€ä¸ªç™¾ç±³èµ›è·‘å¼€å§‹æ—¶çš„ä¾‹å­ï¼Œæ¥å­¦ä¹ ä¸‹<strong>Condçš„ä½¿ç”¨æ–¹æ³•</strong>ã€‚10ä¸ªè¿åŠ¨å‘˜è¿›å…¥èµ›åœºä¹‹åéœ€è¦å…ˆåšæ‹‰ä¼¸æ´»åŠ¨æ´»åŠ¨ç­‹éª¨ï¼Œå‘è§‚ä¼—å’Œç²‰ä¸æ‹›æ‰‹è‡´æ•¬ï¼Œåœ¨è‡ªå·±çš„èµ›é“ä¸Šåšå¥½å‡†å¤‡ï¼›ç­‰æ‰€æœ‰çš„è¿åŠ¨å‘˜éƒ½å‡†å¤‡å¥½ä¹‹åï¼Œè£åˆ¤å‘˜æ‰ä¼šæ‰“å“å‘ä»¤æªã€‚</p><p>æ¯ä¸ªè¿åŠ¨å‘˜åšå¥½å‡†å¤‡ä¹‹åï¼Œå°†readyåŠ ä¸€ï¼Œè¡¨æ˜è‡ªå·±åšå¥½å‡†å¤‡äº†ï¼ŒåŒæ—¶è°ƒç”¨Broadcastæ–¹æ³•é€šçŸ¥è£åˆ¤å‘˜ã€‚å› ä¸ºè£åˆ¤å‘˜åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç›´æ¥æ›¿æ¢æˆSignalæ–¹æ³•è°ƒç”¨ã€‚è°ƒç”¨Broadcastæ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è¯·æ±‚c.Lé”ï¼Œåªæ˜¯åœ¨æ›´æ”¹ç­‰å¾…å˜é‡çš„æ—¶å€™æ‰ä½¿ç”¨åˆ°äº†é”ã€‚</p><p>è£åˆ¤å‘˜ä¼šç­‰å¾…è¿åŠ¨å‘˜éƒ½å‡†å¤‡å¥½ï¼ˆç¬¬22è¡Œï¼‰ã€‚è™½ç„¶æ¯ä¸ªè¿åŠ¨å‘˜å‡†å¤‡å¥½ä¹‹åéƒ½å”¤é†’äº†è£åˆ¤å‘˜ï¼Œä½†æ˜¯è£åˆ¤å‘˜è¢«å”¤é†’ä¹‹åéœ€è¦æ£€æŸ¥ç­‰å¾…æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼ˆ<strong>è¿åŠ¨å‘˜éƒ½å‡†å¤‡å¥½äº†</strong>ï¼‰ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè£åˆ¤å‘˜è¢«å”¤é†’ä¹‹åä¸€å®šè¦æ£€æŸ¥ç­‰å¾…æ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸æ»¡è¶³è¿˜æ˜¯è¦ç»§ç»­ç­‰å¾…ã€‚</p><pre><code>func main() {\n    c := sync.NewCond(&amp;sync.Mutex{})\n    var ready int\n\n    for i := 0; i &lt; 10; i++ {\n        go func(i int) {\n            time.Sleep(time.Duration(rand.Int63n(10)) * time.Second)\n\n            // åŠ é”æ›´æ”¹ç­‰å¾…æ¡ä»¶\n            c.L.Lock()\n            ready++\n            c.L.Unlock()\n\n            log.Printf(&quot;è¿åŠ¨å‘˜#%d å·²å‡†å¤‡å°±ç»ª\\n&quot;, i)\n            // å¹¿æ’­å”¤é†’æ‰€æœ‰çš„ç­‰å¾…è€…\n            c.Broadcast()\n        }(i)\n    }\n\n    c.L.Lock()\n    for ready != 10 {\n        c.Wait()\n        log.Println(&quot;è£åˆ¤å‘˜è¢«å”¤é†’ä¸€æ¬¡&quot;)\n    }\n    c.L.Unlock()\n\n    //æ‰€æœ‰çš„è¿åŠ¨å‘˜æ˜¯å¦å°±ç»ª\n    log.Println(&quot;æ‰€æœ‰è¿åŠ¨å‘˜éƒ½å‡†å¤‡å°±ç»ªã€‚æ¯”èµ›å¼€å§‹ï¼Œ3ï¼Œ2ï¼Œ1, ......&quot;)\n}\n</code></pre><p>ä½ çœ‹ï¼ŒCondçš„ä½¿ç”¨å…¶å®æ²¡é‚£ä¹ˆç®€å•ã€‚å®ƒçš„å¤æ‚åœ¨äºï¼šä¸€ï¼Œè¿™æ®µä»£ç æœ‰æ—¶å€™éœ€è¦åŠ é”ï¼Œæœ‰æ—¶å€™å¯ä»¥ä¸åŠ ï¼›äºŒï¼ŒWaitå”¤é†’åéœ€è¦æ£€æŸ¥æ¡ä»¶ï¼›ä¸‰ï¼Œæ¡ä»¶å˜é‡çš„æ›´æ”¹ï¼Œå…¶å®æ˜¯éœ€è¦åŸå­æ“ä½œæˆ–è€…äº’æ–¥é”ä¿æŠ¤çš„ã€‚æ‰€ä»¥ï¼Œæœ‰çš„å¼€å‘è€…ä¼šè®¤ä¸ºï¼ŒCondæ˜¯å”¯ä¸€éš¾ä»¥æŒæ¡çš„Goå¹¶å‘åŸè¯­ã€‚</p><p>æˆ‘ä»¬ç»§ç»­çœ‹çœ‹Condçš„å®ç°åŸç†ã€‚</p><h2>Condçš„å®ç°åŸç†</h2><p>å…¶å®ï¼ŒCondçš„å®ç°éå¸¸ç®€å•ï¼Œæˆ–è€…è¯´å¤æ‚çš„é€»è¾‘å·²ç»è¢«Lockeræˆ–è€…runtimeçš„ç­‰å¾…é˜Ÿåˆ—å®ç°äº†ã€‚æˆ‘ä»¬ç›´æ¥çœ‹çœ‹Condçš„æºç å§ã€‚</p><pre><code>type Cond struct {\n    noCopy noCopy\n\n    // å½“è§‚å¯Ÿæˆ–è€…ä¿®æ”¹ç­‰å¾…æ¡ä»¶çš„æ—¶å€™éœ€è¦åŠ é”\n    L Locker\n\n    // ç­‰å¾…é˜Ÿåˆ—\n    notify  notifyList\n    checker copyChecker\n}\n\nfunc NewCond(l Locker) *Cond {\n    return &amp;Cond{L: l}\n}\n\nfunc (c *Cond) Wait() {\n    c.checker.check()\n    // å¢åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­\n    t := runtime_notifyListAdd(&amp;c.notify)\n    c.L.Unlock()\n    // é˜»å¡ä¼‘çœ ç›´åˆ°è¢«å”¤é†’\n    runtime_notifyListWait(&amp;c.notify, t)\n    c.L.Lock()\n}\n\nfunc (c *Cond) Signal() {\n    c.checker.check()\n    runtime_notifyListNotifyOne(&amp;c.notify)\n}\n\nfunc (c *Cond) Broadcast() {\n    c.checker.check()\n    runtime_notifyListNotifyAll(&amp;c.notifyï¼‰\n}\n</code></pre><p>è¿™éƒ¨åˆ†æºç ç¡®å®å¾ˆç®€å•ï¼Œæˆ‘æ¥å¸¦ä½ å­¦ä¹ ä¸‹å…¶ä¸­æ¯”è¾ƒå…³é”®çš„é€»è¾‘ã€‚</p><p>runtime_notifyListXXXæ˜¯è¿è¡Œæ—¶å®ç°çš„æ–¹æ³•ï¼Œå®ç°äº†ä¸€ä¸ªç­‰å¾…/é€šçŸ¥çš„é˜Ÿåˆ—ã€‚å¦‚æœä½ æƒ³æ·±å…¥å­¦ä¹ è¿™éƒ¨åˆ†ï¼Œå¯ä»¥å†å»çœ‹çœ‹runtime/sema.goä»£ç ä¸­ã€‚</p><p>copyCheckeræ˜¯ä¸€ä¸ªè¾…åŠ©ç»“æ„ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ£€æŸ¥Condæ˜¯å¦è¢«å¤åˆ¶ä½¿ç”¨ã€‚</p><p>Signalå’ŒBroadcaståªæ¶‰åŠåˆ°notifyListæ•°æ®ç»“æ„ï¼Œä¸æ¶‰åŠåˆ°é”ã€‚</p><p>WaitæŠŠè°ƒç”¨è€…åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—æ—¶ä¼šé‡Šæ”¾é”ï¼Œåœ¨è¢«å”¤é†’ä¹‹åè¿˜ä¼šè¯·æ±‚é”ã€‚åœ¨é˜»å¡ä¼‘çœ æœŸé—´ï¼Œè°ƒç”¨è€…æ˜¯ä¸æŒæœ‰é”çš„ï¼Œè¿™æ ·èƒ½è®©å…¶ä»–goroutineæœ‰æœºä¼šæ£€æŸ¥æˆ–è€…æ›´æ–°ç­‰å¾…å˜é‡ã€‚</p><p>æˆ‘ä»¬ç»§ç»­çœ‹çœ‹ä½¿ç”¨Condå¸¸è§çš„ä¸¤ä¸ªé”™è¯¯ï¼Œä¸€ä¸ªæ˜¯è°ƒç”¨Waitçš„æ—¶å€™æ²¡æœ‰åŠ é”ï¼Œå¦ä¸€ä¸ªæ˜¯æ²¡æœ‰æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³ç¨‹åºå°±ç»§ç»­æ‰§è¡Œäº†ã€‚</p><h2>ä½¿ç”¨Condçš„2ä¸ªå¸¸è§é”™è¯¯</h2><p>æˆ‘ä»¬å…ˆçœ‹<strong>Condæœ€å¸¸è§çš„ä½¿ç”¨é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨Waitçš„æ—¶å€™æ²¡æœ‰åŠ é”</strong>ã€‚</p><p>ä»¥å‰é¢ç™¾ç±³èµ›è·‘çš„ç¨‹åºä¸ºä¾‹ï¼Œåœ¨è°ƒç”¨cond.Waitæ—¶ï¼ŒæŠŠå‰åçš„Lock/Unlockæ³¨é‡Šæ‰ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ä¸­çš„ç¬¬20è¡Œå’Œç¬¬25è¡Œï¼š</p><pre><code>func main() {\n    c := sync.NewCond(&amp;sync.Mutex{})\n    var ready int\n\n    for i := 0; i &lt; 10; i++ {\n        go func(i int) {\n            time.Sleep(time.Duration(rand.Int63n(10)) * time.Second)\n\n            // åŠ é”æ›´æ”¹ç­‰å¾…æ¡ä»¶\n            c.L.Lock()\n            ready++\n            c.L.Unlock()\n\n            log.Printf(&quot;è¿åŠ¨å‘˜#%d å·²å‡†å¤‡å°±ç»ª\\n&quot;, i)\n            // å¹¿æ’­å”¤é†’æ‰€æœ‰çš„ç­‰å¾…è€…\n            c.Broadcast()\n        }(i)\n    }\n\n    // c.L.Lock()\n    for ready != 10 {\n        c.Wait()\n        log.Println(&quot;è£åˆ¤å‘˜è¢«å”¤é†’ä¸€æ¬¡&quot;)\n    }\n    // c.L.Unlock()\n\n    //æ‰€æœ‰çš„è¿åŠ¨å‘˜æ˜¯å¦å°±ç»ª\n    log.Println(&quot;æ‰€æœ‰è¿åŠ¨å‘˜éƒ½å‡†å¤‡å°±ç»ªã€‚æ¯”èµ›å¼€å§‹ï¼Œ3ï¼Œ2ï¼Œ1, ......&quot;)\n}\n</code></pre><p>å†è¿è¡Œç¨‹åºï¼Œå°±ä¼šæŠ¥é‡Šæ”¾æœªåŠ é”çš„panicï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/47/76/4780dca40087277be0d183674bc42c76.jpeg?wh=877*367\" alt=\"\"></p><p>å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› åœ¨äºï¼Œcond.Waitæ–¹æ³•çš„å®ç°æ˜¯ï¼ŒæŠŠå½“å‰è°ƒç”¨è€…åŠ å…¥åˆ°notifyé˜Ÿåˆ—ä¹‹ä¸­åä¼šé‡Šæ”¾é”ï¼ˆå¦‚æœä¸é‡Šæ”¾é”ï¼Œå…¶ä»–Waitçš„è°ƒç”¨è€…å°±æ²¡æœ‰æœºä¼šåŠ å…¥åˆ°notifyé˜Ÿåˆ—ä¸­äº†ï¼‰ï¼Œç„¶åä¸€ç›´ç­‰å¾…ï¼›ç­‰è°ƒç”¨è€…è¢«å”¤é†’ä¹‹åï¼Œåˆä¼šå»äº‰æŠ¢è¿™æŠŠé”ã€‚å¦‚æœè°ƒç”¨Waitä¹‹å‰ä¸åŠ é”çš„è¯ï¼Œå°±æœ‰å¯èƒ½Unlockä¸€ä¸ªæœªåŠ é”çš„Lockerã€‚æ‰€ä»¥åˆ‡è®°ï¼Œ<strong>è°ƒç”¨cond.Waitæ–¹æ³•ä¹‹å‰ä¸€å®šè¦åŠ é”</strong>ã€‚</p><p>ä½¿ç”¨Condçš„å¦ä¸€ä¸ªå¸¸è§é”™è¯¯æ˜¯ï¼Œåªè°ƒç”¨äº†ä¸€æ¬¡Waitï¼Œæ²¡æœ‰æ£€æŸ¥ç­‰å¾…æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œç»“æœæ¡ä»¶æ²¡æ»¡è¶³ï¼Œç¨‹åºå°±ç»§ç»­æ‰§è¡Œäº†ã€‚å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› åœ¨äºï¼Œè¯¯ä»¥ä¸ºCondçš„ä½¿ç”¨ï¼Œå°±åƒWaitGroupé‚£æ ·è°ƒç”¨ä¸€ä¸‹Waitæ–¹æ³•ç­‰å¾…é‚£ä¹ˆç®€å•ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼ŒæŠŠç¬¬21è¡Œå’Œç¬¬24è¡Œæ³¨é‡Šæ‰ï¼š</p><pre><code>func main() {\n    c := sync.NewCond(&amp;sync.Mutex{})\n    var ready int\n\n    for i := 0; i &lt; 10; i++ {\n        go func(i int) {\n            time.Sleep(time.Duration(rand.Int63n(10)) * time.Second)\n\n            // åŠ é”æ›´æ”¹ç­‰å¾…æ¡ä»¶\n            c.L.Lock()\n            ready++\n            c.L.Unlock()\n\n            log.Printf(&quot;è¿åŠ¨å‘˜#%d å·²å‡†å¤‡å°±ç»ª\\n&quot;, i)\n            // å¹¿æ’­å”¤é†’æ‰€æœ‰çš„ç­‰å¾…è€…\n            c.Broadcast()\n        }(i)\n    }\n\n    c.L.Lock()\n    // for ready != 10 {\n    c.Wait()\n    log.Println(&quot;è£åˆ¤å‘˜è¢«å”¤é†’ä¸€æ¬¡&quot;)\n    // }\n    c.L.Unlock()\n\n    //æ‰€æœ‰çš„è¿åŠ¨å‘˜æ˜¯å¦å°±ç»ª\n    log.Println(&quot;æ‰€æœ‰è¿åŠ¨å‘˜éƒ½å‡†å¤‡å°±ç»ªã€‚æ¯”èµ›å¼€å§‹ï¼Œ3ï¼Œ2ï¼Œ1, ......&quot;)\n}\n</code></pre><p>è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œä½ ä¼šå‘ç°ï¼Œå¯èƒ½åªæœ‰å‡ ä¸ªè¿åŠ¨å‘˜å‡†å¤‡å¥½ä¹‹åç¨‹åºå°±è¿è¡Œå®Œäº†ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„æ‰€æœ‰è¿åŠ¨å‘˜éƒ½å‡†å¤‡å¥½æ‰è¿›è¡Œä¸‹ä¸€æ­¥ã€‚åŸå› åœ¨äºï¼Œæ¯ä¸€ä¸ªè¿åŠ¨å‘˜å‡†å¤‡å¥½ä¹‹åéƒ½ä¼šå”¤é†’æ‰€æœ‰çš„ç­‰å¾…è€…ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„è£åˆ¤å‘˜ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªè¿åŠ¨å‘˜å‡†å¤‡å¥½åå°±å”¤é†’äº†è£åˆ¤å‘˜ï¼Œç»“æœè¿™ä¸ªè£åˆ¤å‘˜å‚»å‚»åœ°æ²¡åšä»»ä½•æ£€æŸ¥ï¼Œä»¥ä¸ºæ‰€æœ‰çš„è¿åŠ¨å‘˜éƒ½å‡†å¤‡å¥½äº†ï¼Œå°±ç»§ç»­æ‰§è¡Œäº†ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸€å®šè¦<strong>è®°ä½</strong>ï¼Œwaiter goroutineè¢«å”¤é†’<strong>ä¸ç­‰äº</strong>ç­‰å¾…æ¡ä»¶è¢«æ»¡è¶³ï¼Œåªæ˜¯æœ‰goroutineæŠŠå®ƒå”¤é†’äº†è€Œå·²ï¼Œç­‰å¾…æ¡ä»¶æœ‰å¯èƒ½å·²ç»æ»¡è¶³äº†ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸æ»¡è¶³ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚ä½ ä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼Œç­‰å¾…è€…è¢«å”¤é†’ï¼Œåªæ˜¯å¾—åˆ°äº†ä¸€æ¬¡æ£€æŸ¥çš„æœºä¼šè€Œå·²ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°ç»“ä¸‹ã€‚å¦‚æœä½ æƒ³åœ¨ä½¿ç”¨Condçš„æ—¶å€™é¿å…çŠ¯é”™ï¼Œåªè¦æ—¶åˆ»è®°ä½è°ƒç”¨cond.Waitæ–¹æ³•ä¹‹å‰ä¸€å®šè¦åŠ é”ï¼Œä»¥åŠwaiter goroutineè¢«å”¤é†’ä¸ç­‰äºç­‰å¾…æ¡ä»¶è¢«æ»¡è¶³è¿™ä¸¤ä¸ªçŸ¥è¯†ç‚¹ã€‚</p><h2>çŸ¥åé¡¹ç›®ä¸­Condçš„ä½¿ç”¨</h2><p>Condåœ¨å®é™…é¡¹ç›®ä¸­è¢«ä½¿ç”¨çš„æœºä¼šæ¯”è¾ƒå°‘ï¼ŒåŸå› æ€»ç»“èµ·æ¥æœ‰ä¸¤ä¸ªã€‚</p><p>ç¬¬ä¸€ï¼ŒåŒæ ·çš„åœºæ™¯æˆ‘ä»¬ä¼šä½¿ç”¨å…¶ä»–çš„å¹¶å‘åŸè¯­æ¥æ›¿ä»£ã€‚Goç‰¹æœ‰çš„Channelç±»å‹ï¼Œæœ‰ä¸€ä¸ªåº”ç”¨å¾ˆå¹¿æ³›çš„æ¨¡å¼å°±æ˜¯é€šçŸ¥æœºåˆ¶ï¼Œè¿™ä¸ªæ¨¡å¼ä½¿ç”¨èµ·æ¥ä¹Ÿç‰¹åˆ«ç®€å•ã€‚æ‰€ä»¥å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨Channelè€Œä¸æ˜¯Condå®ç°wait/notifyæœºåˆ¶ã€‚</p><p>ç¬¬äºŒï¼Œå¯¹äºç®€å•çš„wait/notifyåœºæ™¯ï¼Œæ¯”å¦‚ç­‰å¾…ä¸€ç»„goroutineå®Œæˆä¹‹åç»§ç»­æ‰§è¡Œä½™ä¸‹çš„ä»£ç ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨WaitGroupæ¥å®ç°ã€‚å› ä¸ºWaitGroupçš„ä½¿ç”¨æ–¹æ³•æ›´ç®€å•ï¼Œè€Œä¸”ä¸å®¹æ˜“å‡ºé”™ã€‚æ¯”å¦‚ï¼Œä¸Šé¢ç™¾ç±³èµ›è·‘çš„é—®é¢˜ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä½¿ç”¨WaitGroupæ¥å®ç°ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘åœ¨è¿™ä¸€è®²å¼€å¤´æåˆ°ï¼ŒCondçš„ä½¿ç”¨åœºæ™¯å¾ˆå°‘ã€‚å…ˆå‰çš„æ ‡å‡†åº“å†…éƒ¨æœ‰å‡ ä¸ªåœ°æ–¹ä½¿ç”¨äº†Condï¼Œæ¯”å¦‚io/pipe.goç­‰ï¼Œåæ¥éƒ½è¢«å…¶ä»–çš„å¹¶å‘åŸè¯­ï¼ˆæ¯”å¦‚Channelï¼‰æ›¿æ¢äº†ï¼Œsync.Condçš„è·¯è¶Šèµ°è¶Šçª„ã€‚ä½†æ˜¯ï¼Œè¿˜æ˜¯æœ‰ä¸€æ‰¹å¿ å®çš„â€œç²‰ä¸â€åšæŒåœ¨ä½¿ç”¨Condï¼ŒåŸå› åœ¨äºCondæœ‰ä¸‰ç‚¹ç‰¹æ€§æ˜¯Channelæ— æ³•æ›¿ä»£çš„ï¼š</p><ul>\n<li>Condå’Œä¸€ä¸ªLockerå…³è”ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªLockerå¯¹ç›¸å…³çš„ä¾èµ–æ¡ä»¶æ›´æ”¹æä¾›ä¿æŠ¤ã€‚</li>\n<li>Condå¯ä»¥åŒæ—¶æ”¯æŒSignalå’ŒBroadcastæ–¹æ³•ï¼Œè€ŒChannelåªèƒ½åŒæ—¶æ”¯æŒå…¶ä¸­ä¸€ç§ã€‚</li>\n<li>Condçš„Broadcastæ–¹æ³•å¯ä»¥è¢«é‡å¤è°ƒç”¨ã€‚ç­‰å¾…æ¡ä»¶å†æ¬¡å˜æˆä¸æ»¡è¶³çš„çŠ¶æ€åï¼Œæˆ‘ä»¬åˆå¯ä»¥è°ƒç”¨Broadcastå†æ¬¡å”¤é†’ç­‰å¾…çš„goroutineã€‚è¿™ä¹Ÿæ˜¯Channelä¸èƒ½æ”¯æŒçš„ï¼ŒChannelè¢«closeæ‰äº†ä¹‹åä¸æ”¯æŒå†openã€‚</li>\n</ul><p>å¼€æºé¡¹ç›®ä¸­ä½¿ç”¨sync.Condçš„ä»£ç å°‘ä¹‹åˆå°‘ï¼ŒåŒ…æ‹¬æ ‡å‡†åº“åŸå…ˆä¸€äº›ä½¿ç”¨Condçš„ä»£ç ä¹Ÿæ”¹æˆä½¿ç”¨Channelå®ç°äº†ï¼Œæ‰€ä»¥åˆ«è¯´æ‰¾Condç›¸å…³çš„ä½¿ç”¨Bugäº†ï¼Œæƒ³æ‰¾åˆ°çš„ä¸€ä¸ªä½¿ç”¨çš„ä¾‹å­éƒ½ä¸å®¹æ˜“ï¼Œæˆ‘æ‰¾äº†Kubernetesä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•ä½¿ç”¨Condçš„ã€‚</p><p>Kubernetesé¡¹ç›®ä¸­å®šä¹‰äº†ä¼˜å…ˆçº§é˜Ÿåˆ— <a href=\"https://github.com/kubernetes/kubernetes/blob/master/pkg/scheduler/internal/queue/scheduling_queue.go\">PriorityQueue</a> è¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç”¨æ¥å®ç°Podçš„è°ƒç”¨ã€‚å®ƒå†…éƒ¨æœ‰ä¸‰ä¸ªPodçš„é˜Ÿåˆ—ï¼Œå³activeQã€podBackoffQå’ŒunschedulableQï¼Œå…¶ä¸­activeQå°±æ˜¯ç”¨æ¥è°ƒåº¦çš„æ´»è·ƒé˜Ÿåˆ—ï¼ˆheapï¼‰ã€‚</p><p>Popæ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ªé˜Ÿåˆ—ä¸ºç©ºï¼Œå¹¶ä¸”è¿™ä¸ªé˜Ÿåˆ—æ²¡æœ‰Closeçš„è¯ï¼Œä¼šè°ƒç”¨Condçš„Waitæ–¹æ³•ç­‰å¾…ã€‚</p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨Waitæ–¹æ³•çš„æ—¶å€™ï¼Œè°ƒç”¨è€…æ˜¯æŒæœ‰é”çš„ï¼Œå¹¶ä¸”è¢«å”¤é†’çš„æ—¶å€™æ£€æŸ¥ç­‰å¾…æ¡ä»¶ï¼ˆé˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼‰ã€‚</p><pre><code>// ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ \nfunc (p *PriorityQueue) Pop() (*framework.QueuedPodInfo, error) {\n\t\tp.lock.Lock()\n\t\tdefer p.lock.Unlock()\n\t\tfor p.activeQ.Len() == 0 { // å¦‚æœé˜Ÿåˆ—ä¸ºç©º\n\t\t\tif p.closed {\n\t\t\t\treturn nil, fmt.Errorf(queueClosed)\n\t\t\t}\n\t\t\tp.cond.Wait() // ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’\n\t\t}\n\t\t......\n\t\treturn pInfo, err\n\t}\n\n</code></pre><p>å½“activeQå¢åŠ æ–°çš„å…ƒç´ æ—¶ï¼Œä¼šè°ƒç”¨æ¡ä»¶å˜é‡çš„Boradcastæ–¹æ³•ï¼Œé€šçŸ¥è¢«Popé˜»å¡çš„è°ƒç”¨è€…ã€‚</p><pre><code>// å¢åŠ å…ƒç´ åˆ°é˜Ÿåˆ—ä¸­\nfunc (p *PriorityQueue) Add(pod *v1.Pod) error {\n\t\tp.lock.Lock()\n\t\tdefer p.lock.Unlock()\n\t\tpInfo := p.newQueuedPodInfo(pod)\n\t\tif err := p.activeQ.Add(pInfo); err != nil {//å¢åŠ å…ƒç´ åˆ°é˜Ÿåˆ—ä¸­\n\t\t\tklog.Errorf(&quot;Error adding pod %v to the scheduling queue: %v&quot;, nsNameForPod(pod), err)\n\t\t\treturn err\n\t\t}\n\t\t......\n\t\tp.cond.Broadcast() //é€šçŸ¥å…¶å®ƒç­‰å¾…çš„goroutineï¼Œé˜Ÿåˆ—ä¸­æœ‰å…ƒç´ äº†\n\n\t\treturn nil\n\t}\n</code></pre><p>è¿™ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—è¢«å…³é—­çš„æ—¶å€™ï¼Œä¹Ÿä¼šè°ƒç”¨Broadcastæ–¹æ³•ï¼Œé¿å…è¢«Popé˜»å¡çš„è°ƒç”¨è€…æ°¸è¿œhangä½ã€‚</p><pre><code>func (p *PriorityQueue) Close() {\n\t\tp.lock.Lock()\n\t\tdefer p.lock.Unlock()\n\t\tclose(p.stop)\n\t\tp.closed = true\n\t\tp.cond.Broadcast() //å…³é—­æ—¶é€šçŸ¥ç­‰å¾…çš„goroutineï¼Œé¿å…å®ƒä»¬æ°¸è¿œç­‰å¾…\n}\n</code></pre><p>ä½ å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä½¿ç”¨Condè¿™ä¸ªå¹¶å‘åŸè¯­ï¼Œèƒ½ä¸èƒ½æ¢æˆChannelå®ç°å‘¢ï¼Ÿ</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œæˆ‘ä»¬æ¥åšä¸ªæ€»ç»“ã€‚</p><p>Condæ˜¯ä¸ºç­‰å¾…/é€šçŸ¥åœºæ™¯ä¸‹çš„å¹¶å‘é—®é¢˜æä¾›æ”¯æŒçš„ã€‚å®ƒæä¾›äº†æ¡ä»¶å˜é‡çš„ä¸‰ä¸ªåŸºæœ¬æ–¹æ³•Signalã€Broadcastå’ŒWaitï¼Œä¸ºå¹¶å‘çš„goroutineæä¾›ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚</p><p>åœ¨å®è·µä¸­ï¼Œå¤„ç†ç­‰å¾…/é€šçŸ¥çš„åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šä½¿ç”¨Channelæ›¿æ¢Condï¼Œå› ä¸ºChannelç±»å‹ä½¿ç”¨èµ·æ¥æ›´ç®€æ´ï¼Œè€Œä¸”ä¸å®¹æ˜“å‡ºé”™ã€‚ä½†æ˜¯å¯¹äºéœ€è¦é‡å¤è°ƒç”¨Broadcastçš„åœºæ™¯ï¼Œæ¯”å¦‚ä¸Šé¢Kubernetesçš„ä¾‹å­ï¼Œæ¯æ¬¡å¾€é˜Ÿåˆ—ä¸­æˆåŠŸå¢åŠ äº†å…ƒç´ åå°±éœ€è¦è°ƒç”¨Broadcasté€šçŸ¥æ‰€æœ‰çš„ç­‰å¾…è€…ï¼Œä½¿ç”¨Condå°±å†åˆé€‚ä¸è¿‡äº†ã€‚</p><p>ä½¿ç”¨Condä¹‹æ‰€ä»¥å®¹æ˜“å‡ºé”™ï¼Œå°±æ˜¯Waitè°ƒç”¨éœ€è¦åŠ é”ï¼Œä»¥åŠè¢«å”¤é†’åä¸€å®šè¦æ£€æŸ¥æ¡ä»¶æ˜¯å¦çœŸçš„å·²ç»æ»¡è¶³ã€‚ä½ éœ€è¦ç‰¢è®°è¿™ä¸¤ç‚¹ã€‚</p><p>è™½ç„¶æˆ‘ä»¬è®²åˆ°çš„ç™¾ç±³èµ›è·‘çš„ä¾‹å­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡WaitGroupæ¥å®ç°ï¼Œä½†æ˜¯æœ¬è´¨ä¸ŠWaitGroupå’ŒCondæ˜¯æœ‰åŒºåˆ«çš„ï¼šWaitGroupæ˜¯ä¸»goroutineç­‰å¾…ç¡®å®šæ•°é‡çš„å­goroutineå®Œæˆä»»åŠ¡ï¼›è€ŒCondæ˜¯ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼Œè¿™ä¸ªæ¡ä»¶çš„ä¿®æ”¹å¯ä»¥è¢«ä»»æ„å¤šçš„goroutineæ›´æ–°ï¼Œè€Œä¸”Condçš„Waitä¸å…³å¿ƒä¹Ÿä¸çŸ¥é“å…¶ä»–goroutineçš„æ•°é‡ï¼Œåªå…³å¿ƒç­‰å¾…æ¡ä»¶ã€‚è€Œä¸”Condè¿˜æœ‰å•ä¸ªé€šçŸ¥çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯Signalæ–¹æ³•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/47/5d/477157d2dbe1b7e4511f56c2c9c2105d.jpg?wh=2251*1332\" alt=\"\"></p><h2>æ€è€ƒé¢˜</h2><ol>\n<li>ä¸€ä¸ªCondçš„waiterè¢«å”¤é†’çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆéœ€è¦å†æ£€æŸ¥ç­‰å¾…æ¡ä»¶ï¼Œè€Œä¸æ˜¯å”¤é†’åè¿›è¡Œä¸‹ä¸€æ­¥ï¼Ÿ</li>\n<li>ä½ èƒ½å¦åˆ©ç”¨Condå®ç°ä¸€ä¸ªå®¹é‡æœ‰é™çš„queueï¼Ÿ</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","comments":[{"had_liked":false,"id":256933,"user_name":"Gojustforfun","can_delete":false,"product_type":"c1","uid":1187021,"ip_address":"","ucode":"7513A40F27344F","user_header":"https://static001.geekbang.org/account/avatar/00/12/1c/cd/8d552516.jpg","comment_is_top":false,"comment_ctime":1603787358,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"121862871646","product_id":100061801,"comment_content":"æ€è€ƒé¢˜ï¼š<br>1. å”¤é†’çš„æ–¹å¼æœ‰broadcastï¼Œç¬¬Nä¸ªwaiterè¢«å”¤é†’åéœ€è¦æ£€æŸ¥ç­‰å¾…æ¡ä»¶ï¼Œå› ä¸ºä¸çŸ¥é“å‰N-1ä¸ªè¢«å”¤é†’çš„waiteræ‰€ä½œçš„ä¿®æ”¹æ˜¯å¦ä½¿ç­‰å¾…æ¡ä»¶å†æ¬¡æˆç«‹ã€‚<br>2. ä»¥ä¸‹æ˜¯æˆ‘å®ç°çš„ä¸€ä¸ªï¼Œæœ‰é™å®¹é‡Queueï¼Œæ¬¢è¿è®¨è®ºï¼<br>https:&#47;&#47;play.studygolang.com&#47;p&#47;11K2iPVYErn<br><br>package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;math&#47;rand&quot;<br>\t&quot;strings&quot;<br>\t&quot;sync&quot;<br>)<br><br>type Queue struct {<br>\tcond *sync.Cond<br>\tdata []interface{}<br>\tcapc int<br>\tlogs []string<br>}<br><br>func NewQueue(capacity int) *Queue {<br>\treturn &amp;Queue{cond: &amp;sync.Cond{L: &amp;sync.Mutex{}}, data: make([]interface{}, 0), capc: capacity, logs: make([]string, 0)}<br>}<br><br>func (q *Queue) Enqueue(d interface{}) {<br>\tq.cond.L.Lock()<br>\tdefer q.cond.L.Unlock()<br><br>\tfor len(q.data) == q.capc {<br>\t\tq.cond.Wait()<br>\t}<br>\t&#47;&#47; FIFOå…¥é˜Ÿ<br>\tq.data = append(q.data, d)<br>\t&#47;&#47; è®°å½•æ“ä½œæ—¥å¿—<br>\tq.logs = append(q.logs, fmt.Sprintf(&quot;En %v\\n&quot;, d))<br>\t&#47;&#47; é€šçŸ¥å…¶ä»–waiterè¿›è¡ŒDequeueæˆ–Enqueueæ“ä½œ<br>\tq.cond.Broadcast()<br><br>}<br><br>func (q *Queue) Dequeue() (d interface{}) {<br>\tq.cond.L.Lock()<br>\tdefer q.cond.L.Unlock()<br><br>\tfor len(q.data) == 0 {<br>\t\tq.cond.Wait()<br>\t}<br>\t&#47;&#47; FIFOå‡ºé˜Ÿ<br>\td = q.data[0]<br>\tq.data = q.data[1:]<br>\t&#47;&#47; è®°å½•æ“ä½œæ—¥å¿—<br>\tq.logs = append(q.logs, fmt.Sprintf(&quot;De %v\\n&quot;, d))<br>\t&#47;&#47; é€šçŸ¥å…¶ä»–waiterè¿›è¡ŒDequeueæˆ–Enqueueæ“ä½œ<br>\tq.cond.Broadcast()<br>\treturn<br>}<br><br>func (q *Queue) Len() int {<br>\tq.cond.L.Lock()<br>\tdefer q.cond.L.Unlock()<br>\treturn len(q.data)<br>}<br><br>func (q *Queue) String() string {<br>\tvar b strings.Builder<br>\tfor _, log := range q.logs {<br>\t\t&#47;&#47;fmt.Fprint(&amp;b, log)<br>\t\tb.WriteString(log)<br>\t}<br>\treturn b.String()<br>}","like_count":29,"discussions":[{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"å´å°æ™º","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382775,"discussion_content":"å™¢ï¼Œé‚£æ˜¯ for len(q.data) == q.capc ï¼Œæˆ‘çœ‹æˆ if len(q.data) == q.capc äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625718011,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"å´å°æ™º","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382760,"discussion_content":"è€å“¥ï¼Œwait ä¹‹åä¸ç”¨æ£€æŸ¥äº†å—ï¼Ÿæ¯”å¦‚ç°åœ¨æœ‰ä¸¤ä¸ªå…¥é˜Ÿåˆ—æ“ä½œåœ¨ç­‰å¾…ï¼Œä¸€ä¸ªå‡ºé˜Ÿåˆ—ä¼š Broadcast()ï¼Œé‚£è¿™ä¸¤ä¸ªå…¥é˜Ÿåˆ—çš„æ“ä½œæ˜¯ä¸æ˜¯åŒæ—¶è¢«å”¤é†’äº†ï¼Œç„¶åéƒ½æ‰§è¡Œæ·»åŠ æ“ä½œå°±è¶…é•¿åº¦å•¦ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625714355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1628736,"avatar":"https://static001.geekbang.org/account/avatar/00/18/da/40/bda5ad2b.jpg","nickname":"ChuanBing à¸ˆà¸¸à¹Šà¸š","note":"","ucode":"4482E852FC147A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"å´å°æ™º","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385985,"discussion_content":"wait å”¤é†’å, ä¼šlock, å°±ç®—å¤šä¸ªgoroutine è¢«åŒæ—¶å”¤é†’, ä½†æ˜¯åªæœ‰ä¸€ä¸ªèƒ½å¤Ÿè·å–åˆ°é”","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1627372304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":382760,"ip_address":""},"score":385985,"extra":""}]}]},{"had_liked":false,"id":256566,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1603679567,"is_pvip":false,"replies":[{"id":"93485","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603758891,"ip_address":"","comment_id":256566,"utype":1}],"discussion_count":1,"race_medal":1,"score":"44553352527","product_id":100061801,"comment_content":"è€å¸ˆï¼Œä¸ŠèŠ‚è¯¾ä½ æåˆ°noCopyï¼Œæ˜¯ä¸€ä¸ªè¾…åŠ©çš„ã€ç”¨æ¥å¸®åŠ© vet æ£€æŸ¥ç”¨çš„ç±»å‹ï¼Œè€ŒCondè¿˜æœ‰ä¸ªcopyChecker æ˜¯ä¸€ä¸ªè¾…åŠ©ç»“æ„ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ£€æŸ¥ Cond æ˜¯å¦è¢«å¤åˆ¶ä½¿ç”¨ã€‚<br><br>nocpoyæ˜¯é™æ€æ£€æŸ¥ï¼ŒcopyCheckeræ˜¯è¿è¡Œæ—¶æ£€æŸ¥ï¼Œä¸æ˜¯ç†è§£æ˜¯å¦æ­£ç¡®ï¼Ÿ<br><br>å¦å¤–ä¸æ˜¯æ˜¯å¦æœ‰å…¶ä»–åŒºåˆ«å‘¢ï¼Ÿ","like_count":10,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508055,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603758891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258297,"user_name":"SuperDai","can_delete":false,"product_type":"c1","uid":1289318,"ip_address":"","ucode":"0CA86D253754CA","user_header":"https://static001.geekbang.org/account/avatar/00/13/ac/66/a256008b.jpg","comment_is_top":false,"comment_ctime":1604374390,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18784243574","product_id":100061801,"comment_content":"ä¸Šä¸€ä¸ªè‡ªå·±çš„å®ç°<br><br>package caplimitqueue<br><br>import (<br>\t&quot;sync&quot;<br><br>\t&quot;github.com&#47;gammazero&#47;deque&quot;<br>)<br><br>&#47;&#47; CapLimitQueue é™å®¹é˜Ÿåˆ—<br>type CapLimitQueue struct {<br>\tcond *sync.Cond<br>\tq    deque.Deque<br>\tcap  int<br>}<br><br>&#47;&#47; NewCapLimitQueue è¿”å›CapLimitQueueå®ä¾‹.<br>func NewCapLimitQueue(cap int) *CapLimitQueue {<br>\tif cap == 0 {<br>\t\tcap = 64<br>\t}<br>\tq := &amp;CapLimitQueue{<br>\t\tcap: cap,<br>\t}<br>\tq.cond = sync.NewCond(&amp;sync.Mutex{})<br>\treturn q<br>}<br><br>&#47;&#47; Push å¾€é™å®¹é˜Ÿåˆ—æ·»åŠ æ•°æ®å¯¹è±¡.<br>func (q *CapLimitQueue) Push(elem interface{}) {<br>\tq.cond.L.Lock()<br>\tfor q.q.Len() &gt;= q.cap {<br>\t\t&#47;&#47; (1) é˜Ÿåˆ—å·²æ»¡, ç­‰å¾…æ¶ˆè´¹goroutineå–å‡ºæ•°æ®å¯¹è±¡.<br>\t\tq.cond.Wait()<br>\t}<br>\tdefer q.cond.L.Unlock()<br><br>\tq.q.PushBack(elem)<br>\t&#47;&#47; (2) é€šçŸ¥æ¶ˆè´¹goroutineå·²æœ‰æ•°æ®å¯¹è±¡è¿›é˜Ÿåˆ— -&gt; (3)<br>\tq.cond.Broadcast()<br>}<br><br>&#47;&#47; Pop ä»é™å®¹é˜Ÿåˆ—å–å‡ºæ•°æ®å¯¹è±¡.<br>func (q *CapLimitQueue) Pop(want int) []interface{} {<br>\tq.cond.L.Lock()<br>\tfor q.q.Len() == 0 {<br>\t\t&#47;&#47; (3) é˜Ÿåˆ—ä¸ºç©º, ç­‰å¾…ç”Ÿäº§goroutineæ·»åŠ æ•°æ®å¯¹è±¡.<br>\t\tq.cond.Wait()<br>\t}<br>\tdefer q.cond.L.Unlock()<br><br>\tif want &gt; q.q.Len() {<br>\t\twant = q.q.Len()<br>\t}<br>\toutput := make([]interface{}, want)<br>\tfor i := 0; i &lt; want; i++ {<br>\t\toutput[i] = q.q.PopFront()<br>\t}<br>\t&#47;&#47; (4) é€šçŸ¥ç”Ÿäº§goroutineå·²æœ‰æ•°æ®å¯¹è±¡å‡ºé˜Ÿåˆ— -&gt; (1)<br>\tq.cond.Broadcast()<br><br>\treturn output<br>}<br><br>&#47;&#47; Len è¿”å›é™å®¹é˜Ÿåˆ—å½“å‰é•¿åº¦.<br>func (q *CapLimitQueue) Len() int {<br>\tq.cond.L.Lock()<br>\tdefer q.cond.L.Unlock()<br>\treturn q.q.Len()<br>}<br>","like_count":4},{"had_liked":false,"id":256642,"user_name":"Junes","can_delete":false,"product_type":"c1","uid":1354665,"ip_address":"","ucode":"CD2E829C868970","user_header":"https://static001.geekbang.org/account/avatar/00/14/ab/a9/590d6f02.jpg","comment_is_top":false,"comment_ctime":1603695110,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14488596998","product_id":100061801,"comment_content":"1. æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œæ˜¯çœ‹ä¸šåŠ¡å®ç°çš„éœ€æ±‚å§ï¼š<br>æ¯ä¸ªcallerä¼šå”¤é†’ä¸€ä¸ªæˆ–è€…æ‰€æœ‰çš„waiter<br>callerå’Œwaiterçš„æ•°é‡å¯¹åº”æ˜¯ä¸ç¡®å®šçš„ï¼Œå¦‚N:M<br>waiterå”¤é†’åçš„å¤„ç†é€»è¾‘æ˜¯è‡ªå·±å†³å®šçš„ï¼Œæ¯”å¦‚ç¤ºä¾‹ä¸­çš„readyå’Œé˜Ÿåˆ—é•¿åº¦<br><br>2. æœ‰é•¿åº¦é™åˆ¶çš„é˜Ÿåˆ—ï¼Œä»£ç å¯ä»¥å‚è€ƒç¤ºä¾‹ä¸­çš„PriorityQueue<br>Pushå…¥é˜ŸBroadcastï¼ŒPopå‡ºé˜ŸWait<br>é˜Ÿåˆ—é•¿åº¦æœ‰é™åˆ¶çš„è¯ï¼Œåœ¨Dueueä¸­ç»´æŠ¤ä¸€ä¸ªå˜é‡sizeï¼Œå½“å‰é˜Ÿåˆ—é•¿åº¦å¤§äºç­‰äºsizeæ—¶ï¼ŒPushæ“ä½œç›´æ¥è¿”å›é”™è¯¯<br>æ”¹é€ ï¼šå¦‚æœå¸Œæœ›Dueueæ»¡æ—¶Pushæ“ä½œé˜»å¡ï¼Œå¯ä»¥åœ¨Pushç”¨ä¸ªWaitæ¥é˜»å¡ï¼Œæ”¶åˆ°Broadcaståï¼Œæ£€æµ‹åˆ°å½“å‰é˜Ÿåˆ—å°äºsizeå°±Push<br>é™„ä¸Šä¸€å—ä¼ªä»£ç <br><br>&#47;&#47; ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ <br>func (p *Dueue) Pop() (interface{}, error) {<br>\tp.lock.Lock()<br>\tdefer p.lock.Unlock()<br><br>\t&#47;&#47; å¦‚æœé˜Ÿåˆ—ä¸ºç©º,ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’<br>\tfor p.queue.Len() == 0 {<br>\t\tp.cond.Wait()<br>\t}<br>\treturn p.queue.Pop()<br>}<br><br>&#47;&#47; å¢åŠ å…ƒç´ åˆ°é˜Ÿåˆ—ä¸­(éé˜»å¡æ–¹å¼)<br>func (p *Dueue) Push(e interface{}) error {<br>\tp.lock.Lock()<br>\tdefer p.lock.Unlock()<br><br>\t&#47;&#47; å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œç›´æ¥è¿”å›error(é˜»å¡æ”¹é€ ï¼šåœ¨Popä¸­æ·»åŠ ä¸ªBroadcastæ–¹æ³•ï¼Œè¿™é‡Œæ”¹é€ æˆforå¾ªç¯è¿›è¡Œwait)<br>\tif p.queue.Len() &gt;= p.maxSize {<br>\t\treturn fmt.Errorf(&quot;over size&quot;)<br>\t}<br><br>\t&#47;&#47; æŠŠå…ƒç´ åŠ å…¥åˆ°é˜Ÿåˆ—åï¼Œé€šçŸ¥æ‰€æœ‰çš„waiter<br>\tp.queue.Push(e)<br>\tp.cond.Broadcast()<br>\treturn nil<br>}<br>","like_count":3,"discussions":[{"author":{"id":1187021,"avatar":"https://static001.geekbang.org/account/avatar/00/12/1c/cd/8d552516.jpg","nickname":"Gojustforfun","note":"","ucode":"7513A40F27344F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318368,"discussion_content":"Pushåœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ— æ³•è°ƒç”¨p.cond.Broadcast()ï¼Œé”™è¯¯åªæ˜¯å½“å‰æ—¶åˆ»ä¸èƒ½Pushæ•°æ®ï¼Œä½†æ˜¯é€šçŸ¥å…¶ä»–waiterè°ƒç”¨Popåï¼Œå†æ¬¡é‡è¯•Pushå°±ä¼šæˆåŠŸã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603718634,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257082,"user_name":"myrfy","can_delete":false,"product_type":"c1","uid":1169401,"ip_address":"","ucode":"2814BAE5D70098","user_header":"","comment_is_top":false,"comment_ctime":1603849256,"is_pvip":false,"replies":[{"id":"93637","content":"å› ä¸ºéœ€è¦é‡ç”¨ï¼Œä½¿ç”¨chan closeåæ²¡æ³•é‡ç”¨äº†","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603895168,"ip_address":"","comment_id":257082,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10193783848","product_id":100061801,"comment_content":"è¿˜æ˜¯æ²¡æœ‰æƒ³æ˜ç™½k8sä¸ºä»€ä¹ˆä¸èƒ½ç”¨channelé€šçŸ¥<br>closeå¯ä»¥å®ç°broadcastçš„åŠŸæ•ˆï¼Œåœ¨popçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯åªæœ‰ä¸€ä¸ªgoroutineå¯ä»¥æ‹¿åˆ°æ•°æ®ï¼Œæ„Ÿè§‰é™¤äº†å…³é—­é˜Ÿåˆ—ä¹‹å¤–ï¼Œä¸å­˜åœ¨éœ€è¦broadcastçš„æƒ…å†µã€‚ä¹Ÿå°±æ˜¯æ„Ÿè§‰ä¸éœ€è¦å¤šæ¬¡broadcastï¼Œè¿™æ ·channelåº”è¯¥æ˜¯æ»¡è¶³è¦æ±‚çš„â€¦â€¦è¯·è€å¸ˆæ˜ç¤º","like_count":2,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508212,"discussion_content":"å› ä¸ºéœ€è¦é‡ç”¨ï¼Œä½¿ç”¨chan closeåæ²¡æ³•é‡ç”¨äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603895168,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329604,"user_name":"chongsheng","can_delete":false,"product_type":"c1","uid":1368768,"ip_address":"","ucode":"859DF328FCA608","user_header":"https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg","comment_is_top":false,"comment_ctime":1641443111,"is_pvip":false,"replies":[{"id":"120084","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1641479136,"ip_address":"","comment_id":329604,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5936410407","product_id":100061801,"comment_content":"å…³äºCondè¿˜æœ‰ä¸€ç§ä¼šä¸å°å¿ƒè¯¯ç”¨çš„åœºæ™¯ï¼Œå› ä¸ºä¸€äº›åŸå› å¯¼è‡´Waitæ‰§è¡Œçš„æ—¶å€™ï¼ŒSignal&#47;Broadcastå°±å·²ç»æ‰§è¡Œå®Œäº†ï¼Œå¯¼è‡´Waitä¸€ç›´ç­‰å¾…æ— æ³•å”¤é†’ã€‚æ¯”å¦‚è¿™é‡Œçš„ä¾‹å­<br>https:&#47;&#47;stackoverflow.com&#47;questions&#47;36857167&#47;how-to-correctly-use-sync-cond","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544347,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641479137,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262868,"user_name":"Hurt","can_delete":false,"product_type":"c1","uid":1050946,"ip_address":"","ucode":"DCE7428CCF08EF","user_header":"https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg","comment_is_top":false,"comment_ctime":1605863784,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5900831080","product_id":100061801,"comment_content":"æ‰“å¡","like_count":1},{"had_liked":false,"id":259809,"user_name":"è™¢åœ‹æŠ€é†¬","can_delete":false,"product_type":"c1","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1604845126,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5899812422","product_id":100061801,"comment_content":"ç¬¬ä¸€ä¸ªæ€è€ƒé¢˜å…¶å®ä¸éš¾ï¼Œå…¶ä»–goroutineåªæ˜¯ready++åå”¤é†’ï¼Œå¦‚æœç­‰å¾…çš„ä¸»goroutineä¸æ£€æŸ¥æ¡ä»¶å˜é‡ï¼Œä¸»goroutineåœ¨ç¬¬ä¸€æ¬¡å”¤é†’æ—¶å°±ç»§ç»­æ‰§è¡Œäº†ï¼ä¹Ÿå°±ä½“ç°ä¸å‡ºæ¡ä»¶å˜é‡çš„â€œæ¡ä»¶â€äº†","like_count":1,"discussions":[{"author":{"id":1529249,"avatar":"https://static001.geekbang.org/account/avatar/00/17/55/a1/e77b9612.jpg","nickname":"å³ªäº”","note":"","ucode":"DCF2DC959D0CD7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327036,"discussion_content":"é¸Ÿçªè¯´çš„æ˜¯ c.checker.check()","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605715688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1056807,"avatar":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","nickname":"è™¢åœ‹æŠ€é†¬","note":"","ucode":"5A192262AA037E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":322937,"discussion_content":"è¡¥å……ï¼šready=1æ—¶ä¸»goroutineå°±ç»§ç»­æ‰§è¡Œäº†ï¼Œä½†æˆ‘ä»¬å…¶å®æ˜¯æƒ³è®©å®ƒ=10ï¼›è¿™å…¶å®ä¹Ÿæ˜¯æŠŠæ¡ä»¶å˜é‡çš„æ¡ä»¶äº¤ç»™ä½¿ç”¨çš„äººæ¥æ§åˆ¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604845360,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257207,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1603882043,"is_pvip":false,"discussion_count":1,"race_medal":2,"score":"5898849339","product_id":100061801,"comment_content":"æ–‡ç« è™½ç„¶çœ‹æ˜ç™½äº†ï¼Œä½†æ˜¯è¦å®Œæˆæ€è€ƒé¢˜è¿˜æ˜¯æœ‰ä¸€å®šçš„éš¾åº¦çš„ã€‚<br>","like_count":1,"discussions":[{"author":{"id":1137757,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5c/5d/bf418037.jpg","nickname":"David","note":"","ucode":"3DC0B0F86F7D39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358821,"discussion_content":"è¥¿å®‰ç½—æ°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616055966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256894,"user_name":"moooofly","can_delete":false,"product_type":"c1","uid":1008348,"ip_address":"","ucode":"4A20795C281B6F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","comment_is_top":false,"comment_ctime":1603778951,"is_pvip":false,"replies":[{"id":"93504","content":"ä½ ç¬¬ä¸€å¥ç»™å‡ºäº†ç­”æ¡ˆã€‚åˆ†åˆ«åº”ç”¨ä¸åŒé˜¶æ®µ","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603793503,"ip_address":"","comment_id":256894,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5898746247","product_id":100061801,"comment_content":"è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œnocpoy æ˜¯ç”¨äº vet é™æ€æ£€æŸ¥ï¼ŒcopyChecker æ˜¯ä¸ºäº†è¿è¡Œæ—¶æ£€æŸ¥ï¼Œéƒ½æ˜¯ä¸ºäº†æ£€æŸ¥ copy é—®é¢˜ï¼Œä¸ºå•¥ Cond è¦åœ¨ä¸¤å¤„æ£€æŸ¥ï¼Œè€Œ Mutex åªéœ€è¦ä¸€å¤„ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508157,"discussion_content":"ä½ ç¬¬ä¸€å¥ç»™å‡ºäº†ç­”æ¡ˆã€‚åˆ†åˆ«åº”ç”¨ä¸åŒé˜¶æ®µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603793503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318766,"discussion_content":"å¯èƒ½æˆ‘é—®çš„ä¸å¤Ÿæ¸…æ¥šï¼Œæˆ‘æ¢ä¸ªè¯´æ³•ï¼ŒMutexä¸ºä½•ä¸éœ€è¦è¿è¡Œæ—¶æ£€æŸ¥ï¼Œè€Œ Cond å´éœ€è¦ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603846917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256811,"user_name":"çº¦ä¹¦äºš","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1603758401,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5898725697","product_id":100061801,"comment_content":"ç¬¬ä¸€é¢˜çš„ç­”æ¡ˆåº”è¯¥åº”è¯¥è¿˜åŒ…æ‹¬spurious wakeupçš„å› ç´ ","like_count":1},{"had_liked":false,"id":358265,"user_name":"Geek_b45293","can_delete":false,"product_type":"c1","uid":3185034,"ip_address":"åŒ—äº¬","ucode":"17E6EAD66A8F4E","user_header":"","comment_is_top":false,"comment_ctime":1664156192,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1664156192","product_id":100061801,"comment_content":"æœ‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆ Mutex ä¸ä½¿ç”¨ copyChecker æ¥æ£€æµ‹æ˜¯å¦è¢«å¤åˆ¶å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":329603,"user_name":"chongsheng","can_delete":false,"product_type":"c1","uid":1368768,"ip_address":"","ucode":"859DF328FCA608","user_header":"https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg","comment_is_top":false,"comment_ctime":1641443029,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641443029","product_id":100061801,"comment_content":"å…³äºCondè¿˜æœ‰ä¸€ç§ä¸å°å¿ƒè¯¯ç”¨çš„åœºæ™¯ï¼Œå°±æ˜¯åœ¨Wait()è°ƒç”¨ä¹‹å‰ï¼ŒSignal&#47;Broadcastå°±æ‰§è¡Œå®Œäº†ï¼Œå¯¼è‡´ä¸€ç›´Wait()ã€‚æ¯”å¦‚è¿™é‡Œçš„ä¾‹å­","like_count":0},{"had_liked":false,"id":319755,"user_name":"æˆäººä»¥ğŸŸï¼Œä¸å¦‚æˆäººä»¥æ¸”","can_delete":false,"product_type":"c1","uid":1193874,"ip_address":"","ucode":"BD53829E924B66","user_header":"https://static001.geekbang.org/account/avatar/00/12/37/92/961ba560.jpg","comment_is_top":false,"comment_ctime":1635929517,"is_pvip":true,"replies":[{"id":"117245","content":"å¯¹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1637681981,"ip_address":"","comment_id":319755,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1635929517","product_id":100061801,"comment_content":"æ–‡ç« ä¸­åœ¨æè¿° Cond çš„å¤æ‚æ€§æ—¶ï¼Œè¯´æ˜äº† 3 ç‚¹ï¼Œç¬¬ä¸‰ç‚¹ï¼šã€Œæ¡ä»¶å˜é‡çš„æ›´æ”¹ã€ æ˜¯å¦å¯éœ€æ”¹ä¸ºï¼šã€Œç­‰å¾…æ¡ä»¶çš„æ›´æ”¹ã€ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532778,"discussion_content":"å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637681981,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317099,"user_name":"å¾æ”¹","can_delete":false,"product_type":"c1","uid":1298380,"ip_address":"","ucode":"82276A584AC602","user_header":"https://static001.geekbang.org/account/avatar/00/13/cf/cc/8de5007b.jpg","comment_is_top":false,"comment_ctime":1634688512,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634688512","product_id":100061801,"comment_content":"å…³äºæ€è€ƒé¢˜2ï¼š<br>æˆ‘ä½¿ç”¨äº†ç¯å½¢é˜Ÿåˆ—ï¼Œç”¨æ¥é¿å…çº¿æ€§é˜Ÿåˆ—é˜Ÿæ»¡æƒ…å†µä¸‹å› æ•°æ®æ¬ç§»è€Œå¸¦æ¥çš„æ—¶é—´å¼€é”€:<br>&#47; ç¯å½¢é˜Ÿåˆ—ï¼Œå®ç°é˜»å¡ã€é€šçŸ¥æœºåˆ¶<br>func (queue *PriorityQueue) Add(v interface{}) {<br>\tqueue.cond.L.Lock()<br>\tdefer queue.cond.L.Unlock()<br>\t&#47;&#47; åˆ¤æ–­é˜Ÿæ»¡<br>\tif (queue.tail + 1) % cap(queue.item) == queue.head {<br>\t\tfmt.Println(&quot;ç”Ÿäº§è€…è¢«é˜»å¡&quot;)<br>\t\tqueue.cond.Wait()<br>\t\tfmt.Println(&quot;ç”Ÿäº§è€…è¢«å”¤é†’&quot;)<br>\t}<br>\tfmt.Println(&quot;ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®&quot;)<br>\tqueue.item[queue.tail] = v<br>\tqueue.tail = (queue.tail + 1) % cap(queue.item)<br>\tqueue.cond.Broadcast()<br>}<br><br>func (queue *PriorityQueue) Pop() interface{} {<br>\tqueue.cond.L.Lock()<br>\tdefer queue.cond.L.Unlock()<br>\t&#47;&#47; åˆ¤æ–­é˜Ÿç©º<br>\tif queue.tail == queue.head {<br>\t\tfmt.Println(&quot;æ¶ˆè´¹è€…è¢«é˜»å¡&quot;)<br>\t\tqueue.cond.Wait()<br>\t\tfmt.Println(&quot;æ¶ˆè´¹è€…è¢«å”¤é†’&quot;)<br>\t}<br>\tfmt.Println(&quot;æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®&quot;)<br>\tv := queue.item[queue.head]<br>\tqueue.head = (queue.head + 1) % cap(queue.item)<br>\tqueue.cond.Broadcast()<br>\treturn v<br>}","like_count":0},{"had_liked":false,"id":313460,"user_name":"Allen","can_delete":false,"product_type":"c1","uid":1241621,"ip_address":"","ucode":"57C92E14FF8F24","user_header":"https://static001.geekbang.org/account/avatar/00/12/f2/15/c5be3083.jpg","comment_is_top":false,"comment_ctime":1632451382,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632451382","product_id":100061801,"comment_content":"package main<br><br>import (<br>\t&quot;fmt&quot;<br>\t&quot;sync&quot;<br>\t&quot;time&quot;<br><br>\t&quot;go.uber.org&#47;atomic&quot;<br>)<br><br>type CondQue struct {<br>\tc    *sync.Cond<br>\tsize int<br>\tlist []int<br>}<br><br>func NewCondQue(size int) *CondQue {<br>\treturn &amp;CondQue{size: size, c: sync.NewCond(&amp;sync.Mutex{})}<br>}<br><br>func (q *CondQue) Add(item int) {<br>\tq.c.L.Lock()<br>\tdefer q.c.L.Unlock()<br>\tfor len(q.list) &gt;= q.size { &#47;&#47; å½“å‰é˜Ÿåˆ—é•¿åº¦å·²æ»¡<br>\t\tq.c.Wait() &#47;&#47; ç­‰å¾…<br>\t\tfmt.Printf(&quot;wait for add:%v\\n&quot;, item)<br>\t}<br>\tq.list = append(q.list, item)<br>\tq.c.Broadcast()<br>\tfmt.Printf(&quot;add:%v cur len:%v\\n&quot;, item, len(q.list))<br>}<br><br>func (q *CondQue) Pop() int {<br>\tq.c.L.Lock()<br>\tdefer q.c.L.Unlock()<br>\tfor len(q.list) &lt;= 0 { &#47;&#47; å½“å‰é˜Ÿåˆ—é•¿åº¦å·²ç©º<br>\t\tq.c.Wait() &#47;&#47; ç­‰å¾…<br>\t\tfmt.Printf(&quot;wait for pop\\n&quot;)<br>\t}<br><br>\titem := q.list[0]<br>\tq.list = q.list[1:]<br>\tfmt.Printf(&quot;pop:%v cur len:%v\\n&quot;, item, len(q.list))<br>\treturn item<br>}<br><br>func main() {<br>\tcond := NewCondQue(2)<br>\tvar g atomic.Int32<br>\tfor i := 0; i &lt; 3; i++ {<br>\t\tgo func() {<br>\t\t\tfor {<br>\t\t\t\tg.Add(1)<br>\t\t\t\tcond.Add(int(g.Load()))<br>\t\t\t\ttime.Sleep(time.Second * 1)<br>\t\t\t}<br>\t\t}()<br>\t}<br>\tfor i := 0; i &lt; 2; i++ {<br>\t\tgo func() {<br>\t\t\tfor {<br>\t\t\t\t_ = cond.Pop()<br>\t\t\t\ttime.Sleep(time.Millisecond * 500)<br>\t\t\t}<br>\t\t}()<br>\t}<br>\ttime.Sleep(time.Second * 10)<br>}<br>","like_count":0},{"had_liked":false,"id":303933,"user_name":"bearlu","can_delete":false,"product_type":"c1","uid":1030862,"ip_address":"","ucode":"14F260C8B24E27","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ba/ce/fd45714f.jpg","comment_is_top":false,"comment_ctime":1627107136,"is_pvip":true,"replies":[{"id":"110318","content":"é‚£ä½ lockerå°±æ°¸è¿œæ²¡é‡Šæ”¾å‘—","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1627730803,"ip_address":"","comment_id":303933,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1627107136","product_id":100061801,"comment_content":"è€å¸ˆè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœWaitå‰åŠ é”ï¼Œç„¶åæ‰§è¡Œå®ŒWaitåˆUnlockæœ‰ä»€ä¹ˆä½œç”¨ï¼Œæˆ‘æŠŠWaitåé¢çš„Unlockå»æ‰ï¼Œå¥½ä¼¼ç¨‹åºä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚æ˜¯æˆ‘æ¼äº†ä»€ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523879,"discussion_content":"é‚£ä½ lockerå°±æ°¸è¿œæ²¡é‡Šæ”¾å‘—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627730803,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":301489,"user_name":"å´å°æ™º","can_delete":false,"product_type":"c1","uid":1310798,"ip_address":"","ucode":"C7C9F58B5C9F7B","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","comment_is_top":false,"comment_ctime":1625713687,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625713687","product_id":100061801,"comment_content":"æƒ³é—®è€å¸ˆï¼Œä¸ºä»€ä¹ˆ ready åœ¨ Wait ä¹‹åå¤„ç†ï¼Œä¼šæœ‰æ­»é”çš„æ—¶å€™å‘ç”Ÿï¼Ÿ<br>c.L.Lock()<br>for ready != 10 {<br>\tc.Wait()<br>\tready ++<br>\tfmt.Println(&quot;è£åˆ¤å‘˜è¢«å”¤é†’&quot;,ready)<br>}<br>c.L.Unlock()<br>","like_count":0},{"had_liked":false,"id":293623,"user_name":"å°è™¾ç±³","can_delete":false,"product_type":"c1","uid":1005528,"ip_address":"","ucode":"F543987A7FAB20","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/d8/425e1b0a.jpg","comment_is_top":false,"comment_ctime":1621470113,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621470113","product_id":100061801,"comment_content":"å¦‚æœåœ¨æ‰§è¡Œ    runtime_notifyListWait(&amp;c.notify, t)ä¹‹å‰æœ‰å…¶ä»–åç¨‹broadcastäº†ï¼Œä¼šä¸ä¼šæ°¸è¿œä¸ä¼šé†’æ¥äº†ï¼Ÿ","like_count":0},{"had_liked":false,"id":267225,"user_name":"è‡­çŒ«","can_delete":false,"product_type":"c1","uid":1313181,"ip_address":"","ucode":"5C3D1ED80055B7","user_header":"https://static001.geekbang.org/account/avatar/00/14/09/9d/8af6cb1e.jpg","comment_is_top":false,"comment_ctime":1607654109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607654109","product_id":100061801,"comment_content":"k8sé‡Œï¼Œp.lock.Lock() è¿™ä¸ªåœ¨waitä¹‹å‰çš„é”ï¼Œå¹¶ä¸æ˜¯p.cock.L.Lock()ï¼Œè¿™æ ·ä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ","like_count":0},{"had_liked":false,"id":264988,"user_name":"Eirture","can_delete":false,"product_type":"c1","uid":1308178,"ip_address":"","ucode":"49EC3830989464","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/12/19914d72.jpg","comment_is_top":false,"comment_ctime":1606729220,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606729220","product_id":100061801,"comment_content":"ç®€å•çš„å®ç°ï¼š<br><br>https:&#47;&#47;play.golang.org&#47;p&#47;GqwFSz_F7nL<br>","like_count":0},{"had_liked":false,"id":263250,"user_name":"hetiu","can_delete":false,"product_type":"c1","uid":1056127,"ip_address":"","ucode":"35D9338C3ABD20","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/7f/aabc1b66.jpg","comment_is_top":false,"comment_ctime":1606058836,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606058836","product_id":100061801,"comment_content":"å¦‚æœwaitè¦æ”¯æŒtimeoutï¼Œåªèƒ½ç”¨channelå’Œcontextäº†å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":257963,"user_name":"ç½‘ç®¡","can_delete":false,"product_type":"c1","uid":1176852,"ip_address":"","ucode":"608175DF616365","user_header":"https://static001.geekbang.org/account/avatar/00/11/f5/14/92b373dd.jpg","comment_is_top":false,"comment_ctime":1604226224,"is_pvip":false,"replies":[{"id":"94058","content":"æœ‰é”ï¼Œçœ‹æ–¹æ³•ç¬¬ä¸€äºŒè¡Œ","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1604369601,"ip_address":"","comment_id":257963,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1604226224","product_id":100061801,"comment_content":"è€å¸ˆï¼ŒKubernetes  PriorityQueueçš„é‚£ä¸ªPopæ–¹æ³•é‡Œæ²¡æœ‰ä½¿ç”¨p.cond.L.Lock()æ–¹æ³•ï¼Œä»–ä»¬æ˜¯æ€ä¹ˆé˜²æ­¢ä¸å‡ºç°é‡Šæ”¾æœªåŠ é”çš„panicå•Šã€‚","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508510,"discussion_content":"æœ‰é”ï¼Œçœ‹æ–¹æ³•ç¬¬ä¸€äºŒè¡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604369601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257069,"user_name":"S.S Mr Lin","can_delete":false,"product_type":"c1","uid":1258558,"ip_address":"","ucode":"1DDD5132B0DA64","user_header":"https://static001.geekbang.org/account/avatar/00/13/34/3e/0b1c2b7f.jpg","comment_is_top":false,"comment_ctime":1603847371,"is_pvip":false,"replies":[{"id":"93593","content":"æ”¾åœ¨å¤–é¢çš„åŸå› æ˜¯å¯ä»¥åˆ©ç”¨é”ä¿æŠ¤å…±äº«æ•°æ®çš„è¯»å†™ã€‚waitæ€»æ˜¯éœ€è¦é”","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603862045,"ip_address":"","comment_id":257069,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603847371","product_id":100061801,"comment_content":"æ¯æ¬¡è°ƒç”¨waitå‰éƒ½è¦åŠ é”ï¼Œä¸ºå•¥åŠ é”è¯­å¥æ”¾åœ¨äº†foçš„å¤–é¢ï¼Ÿç¬¬äºŒæ¬¡waitæ˜¯ä¸æ˜¯å°±æ²¡æœ‰åŠ é”äº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508207,"discussion_content":"æ”¾åœ¨å¤–é¢çš„åŸå› æ˜¯å¯ä»¥åˆ©ç”¨é”ä¿æŠ¤å…±äº«æ•°æ®çš„è¯»å†™ã€‚waitæ€»æ˜¯éœ€è¦é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603862045,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256874,"user_name":"ä¼šé£çš„å¤§è±¡","can_delete":false,"product_type":"c1","uid":1520299,"ip_address":"","ucode":"080A36D971E6CF","user_header":"https://static001.geekbang.org/account/avatar/00/17/32/ab/272af78e.jpg","comment_is_top":false,"comment_ctime":1603770303,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1603770303","product_id":100061801,"comment_content":"æ‰“å¡","like_count":0},{"had_liked":false,"id":256699,"user_name":"syuan","can_delete":false,"product_type":"c1","uid":1215879,"ip_address":"","ucode":"D9BBC2ADAB5F2E","user_header":"https://static001.geekbang.org/account/avatar/00/12/8d/87/47d95f4a.jpg","comment_is_top":false,"comment_ctime":1603710665,"is_pvip":false,"replies":[{"id":"93487","content":"å› ä¸ºä¼šè¢«å”¤é†’ï¼Œå”¤é†’ä¹‹åå¦‚æœæ¡ä»¶è¿˜ä¸æ»¡è¶³ï¼Œåˆä¼šè¢«åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603759006,"ip_address":"","comment_id":256699,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603710665","product_id":100061801,"comment_content":"Wait æ–¹æ³•ï¼Œä¼šæŠŠè°ƒç”¨è€… Caller æ”¾å…¥ Cond çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å¹¶é˜»å¡ï¼Œç›´åˆ°è¢« Signal æˆ–è€… Broadcast çš„æ–¹æ³•ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶å”¤é†’ã€‚<br>ç™¾ç±³è·‘ä»£ç ç¬¬22è¡Œ:    c.Wait(),æŠŠè°ƒç”¨è€…åŠ å…¥é˜Ÿåˆ—é˜»å¡ï¼Œä¸ç†è§£? forå¾ªç¯ä¸€ç›´æ£€æŸ¥ï¼Œæ˜¯æŠŠcä¸€ç›´åŠ å…¥é˜»å¡é˜Ÿåˆ—å—ï¼Ÿè¿˜æ˜¯waiteræ–¹æ³•è‡ªå·²ç”Ÿæˆtå¯¹è±¡åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Ÿå¦‚æœæ˜¯ï¼ŒåŒä¸€ä¸ªcå¯¹åº”t( t := runtime_notifyListAdd(&amp;c.notify)å¯¹è±¡å”¯ä¸€å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508087,"discussion_content":"å› ä¸ºä¼šè¢«å”¤é†’ï¼Œå”¤é†’ä¹‹åå¦‚æœæ¡ä»¶è¿˜ä¸æ»¡è¶³ï¼Œåˆä¼šè¢«åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603759006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256666,"user_name":"å„¿æˆ","can_delete":false,"product_type":"c1","uid":1133809,"ip_address":"","ucode":"02956B19F65C7A","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/f1/8dc266ee.jpg","comment_is_top":false,"comment_ctime":1603700477,"is_pvip":false,"replies":[{"id":"93480","content":"çœ‹cpu,å¸¦å®½ï¼Œçœ‹cancenæ˜¯ä¸æ˜¯è¶…æ—¶å¯¼è‡´çš„ï¼Œè®¾å¤§è¶…æ—¶æ—¶é—´ï¼Œçœ‹pprof","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603754526,"ip_address":"","comment_id":256666,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603700477","product_id":100061801,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸ªè¯¾ç¨‹å¤–çš„é—®é¢˜ï¼Œä½¿ç”¨httputil.ReverseProxy åšæ–¹å‘ä»£ç†ï¼Œå‹æµ‹çš„æ—¶å€™å¤§é‡æŠ¥å‡º http: proxy error: context canceled è¿™ä¸ªé”™è¯¯ã€‚linux æ‰“å¼€æ–‡ä»¶æ•°è°ƒæ•´äº†ï¼Œtime_waiteä¹Ÿéƒ½ä¼˜åŒ–è¿‡äº†ï¼Œä¸€ç›´æ²¡æœ‰æ‰¾åˆ°é—®é¢˜ï¼Œæ‚¨çš„åšå®¢ä¹Ÿçœ‹äº†è¿˜æ˜¯ä¸èƒ½å®šä½ï¼Œæ±‚èµæ•™","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508077,"discussion_content":"çœ‹cpu,å¸¦å®½ï¼Œçœ‹cancenæ˜¯ä¸æ˜¯è¶…æ—¶å¯¼è‡´çš„ï¼Œè®¾å¤§è¶…æ—¶æ—¶é—´ï¼Œçœ‹pprof","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603754526,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256594,"user_name":"RRR","can_delete":false,"product_type":"c1","uid":1014991,"ip_address":"","ucode":"F32A579D201EC5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/cf/d5382404.jpg","comment_is_top":false,"comment_ctime":1603686720,"is_pvip":false,"replies":[{"id":"93409","content":"ä¸¤è€…çš„åŒæ­¥åŸè¯­éƒ½æ˜¯ç‹¬ç«‹å®ç°çš„ï¼Œæ²¡æœ‰å¯æ¯”æ€§ã€‚ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œcondå’Œjava notify&#47;waitæœºåˆ¶æ˜¯ç±»ä¼¼çš„ï¼Œå…¶å®ƒè¯­è¨€ä¹Ÿæœ‰å¯¹åº”çš„åŒæ­¥åŸè¯­","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603699478,"ip_address":"","comment_id":256594,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603686720","product_id":100061801,"comment_content":"æ„Ÿè§‰ Cond æ˜¯ä¸æ˜¯å’Œ Java ä¸­çš„ notify &#47; wait æœºåˆ¶å¯¹åº”è€Œå­˜åœ¨çš„å‘¢ï¼ŸGolang å’Œ Java çš„å¼‚æ­¥æ¨¡å¼æœ€å¤§çš„åŒºåˆ«æ˜¯ä¸æ˜¯å°±åœ¨è¿™é‡Œå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508065,"discussion_content":"ä¸¤è€…çš„åŒæ­¥åŸè¯­éƒ½æ˜¯ç‹¬ç«‹å®ç°çš„ï¼Œæ²¡æœ‰å¯æ¯”æ€§ã€‚ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œcondå’Œjava notify/waitæœºåˆ¶æ˜¯ç±»ä¼¼çš„ï¼Œå…¶å®ƒè¯­è¨€ä¹Ÿæœ‰å¯¹åº”çš„åŒæ­¥åŸè¯­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603699478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":256591,"user_name":"ç‰›æ™“ä¸œ","can_delete":false,"product_type":"c1","uid":1607074,"ip_address":"","ucode":"75E08C8AE039BC","user_header":"https://static001.geekbang.org/account/avatar/00/18/85/a2/4d16e2cf.jpg","comment_is_top":false,"comment_ctime":1603685917,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603685917","product_id":100061801,"comment_content":"å’±ä»¬æœ¬èŠ‚è¯¾æœ‰å¾ˆå¤šå›¾ç‰‡ï¼Œé“¾æ¥â€¦â€¦è¿™å¥è¯å¥½æƒ³å†™æˆä¸€ä¸ªå…¬å¼€çš„å‡½æ•°ï¼Œéœ€è¦çš„æ—¶å€™è°ƒä¸€ä¸‹ğŸ˜ƒğŸ˜ƒ<br>è€å¸ˆçœŸçš„å¾ˆç»†å¿ƒï¼Œæ¯æ¬¡éƒ½æé†’ä»¥è¾¾åˆ°æœ€ä½³æ•ˆæœğŸ‘ğŸ‘ğŸ‘","like_count":0},{"had_liked":false,"id":256563,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1603679176,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603679176","product_id":100061801,"comment_content":"æ‰“å¡ã€‚","like_count":0}]}