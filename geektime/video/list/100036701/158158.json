{"id":158158,"title":"25 | 源码剖析：业务处理","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":159444,"user_name":"冬渐暖","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1575625122,"is_pvip":false,"replies":[{"id":61518,"content":"正解","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576206354,"ip_address":"","comment_id":159444,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"pipeline.fireChannelRead(byteBuf)\n如果没有指定，就是workThread来处理这些数据（卑微的打工仔。）\nhandler之间的传播信息通过fireXXX方法：其区别是从哪个节点开始传播。\n默认处理线程就是Channel绑定的NioEventLoop线程，也可以设置其他（其它的线程走的是开个新的定时任务）:\npipeline.addLast(new UnorderedThreadPoolEventExecutor(10), serverHandler)\n\ninbound从head开始，找下一个可以执行channelRead的地方(通过inbound属性轮询出下一个inboundHandlerContext)，一直到尾节点TailContext\noutbound刚好执行顺序反过来。\n\n其实真正处理数据还是在ctx.fireChannelRead(msg)","like_count":4,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477061,"discussion_content":"正解","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576206354,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":203111,"user_name":"雷刚","can_delete":false,"product_type":"c3","uid":1655725,"ip_address":"","ucode":"115FE2BE1AAB61","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/pTD8nS0SsORKiaRD3wB0NK9Bpd0wFnPWtYLPfBRBhvZ68iaJErMlM2NNSeEibwQfY7GReILSIYZXfT9o8iaicibcyw3g/132","comment_is_top":false,"comment_ctime":1586141228,"is_pvip":false,"replies":[{"id":79262,"content":"是的，具体还得看业务的阻塞情况，大多程序都是io等待型的。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1588633550,"ip_address":"","comment_id":203111,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"事件在 pipeline 中的传播，需要关注事件的传播行为和执行线程：\n1. 传播行为：事件执行到某个 Handler 后，如果不手动触发 ctx.fireChannelRead，则传播中断。\n2. 执行线程：业务线程默认是在 NioEventLoop 中执行。如果业务处理有阻塞，需要考虑另起线程执行。","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490769,"discussion_content":"是的，具体还得看业务的阻塞情况，大多程序都是io等待型的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588633550,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146263,"user_name":"欧阳田","can_delete":false,"product_type":"c3","uid":1054491,"ip_address":"","ucode":"24004916354446","user_header":"https://static001.geekbang.org/account/avatar/00/10/17/1b/4a088e67.jpg","comment_is_top":false,"comment_ctime":1572485682,"is_pvip":false,"replies":[{"id":57249,"content":"这个小建议很细致，😂，以后我会尽量追求如此","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573048215,"ip_address":"","comment_id":146263,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"在读小标题的时候，发现读起来不顺口。于是统一成  动词 + 名词：启动服务，构建连接，接收数据，处理业务，发送数据，断开连接，关闭服务。当然，核心的逻辑知识都烂熟于心了，于是提个非常不起眼的小小建议。老师讲得非常好，帮我理清了主线逻辑。学会了怎么欣赏Netty。学习他怎么使用内存？怎么使用锁?怎么使用设计模式？怎么使用双向链表？","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472771,"discussion_content":"这个小建议很细致，😂，以后我会尽量追求如此","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573048215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153572,"user_name":"Standly","can_delete":false,"product_type":"c3","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/a7df049a.jpg","comment_is_top":false,"comment_ctime":1574261140,"is_pvip":false,"replies":[{"id":59041,"content":"准确的说，pipeline中读的处理流水线就结束了，因为echo server hander是最终处理业务了，它处理完，就可以返回结果，返回结果是相当于走pipeline中写的处理线了。所以你这样表述，大体意思对的，就是不够精确，一类pipeline不仅包括读也包括写，你说断了，其实是读的那条线结束了。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574299480,"ip_address":"","comment_id":153572,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，EchoServerHandler的channelRead()方法并没有再调用ctx.fireChannelRead(msg)，是不是pipeline到这里就断了 ？","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475214,"discussion_content":"准确的说，pipeline中读的处理流水线就结束了，因为echo server hander是最终处理业务了，它处理完，就可以返回结果，返回结果是相当于走pipeline中写的处理线了。所以你这样表述，大体意思对的，就是不够精确，一类pipeline不仅包括读也包括写，你说断了，其实是读的那条线结束了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574299480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289138,"user_name":"suntj","can_delete":false,"product_type":"c3","uid":2312457,"ip_address":"","ucode":"4A0A9F7619E765","user_header":"https://static001.geekbang.org/account/avatar/00/23/49/09/bc54d395.jpg","comment_is_top":false,"comment_ctime":1618886738,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":" 如果一个请求数据很大导致读取多次，意味执行多次pipeline.fireChannelRead(byteBuf)，这样业务逻辑执行多次了，不知道理解是否有问题","like_count":0},{"had_liked":false,"id":228575,"user_name":"刘岚乔月","can_delete":false,"product_type":"c3","uid":1095289,"ip_address":"","ucode":"99A9AB4E4E1111","user_header":"https://static001.geekbang.org/account/avatar/00/10/b6/79/22e582a5.jpg","comment_is_top":false,"comment_ctime":1592740901,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师你好，executionMask这个地方有一些疑问，课程中说这个值是在pipeline.add(handler)的时候添加的，这个地方应该怎么理解呢？是所有用过add()方法的都会生成统一的一个mask，还是说不同的handler生成不同的mask，那么在pipeline依次调用handler的过程中，我如何能知道当前读到的数据，应该让哪一个handler处理呢？（有的业务只需要1、2handler处理，有的需要3、4处理）","like_count":0}]}