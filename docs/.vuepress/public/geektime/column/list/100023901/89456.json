{"id":89456,"title":"18 | StampedLockï¼šæœ‰æ²¡æœ‰æ¯”è¯»å†™é”æ›´å¿«çš„é”ï¼Ÿ","content":"<p>åœ¨<a href=\"https://time.geekbang.org/column/article/88909\">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†è¯»å†™é”ï¼Œå­¦ä¹ å®Œä¹‹åä½ åº”è¯¥å·²ç»çŸ¥é“â€œè¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«å˜é‡ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯â€ã€‚é‚£åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸­ï¼Œè¿˜æœ‰æ²¡æœ‰æ›´å¿«çš„æŠ€æœ¯æ–¹æ¡ˆå‘¢ï¼Ÿè¿˜çœŸæœ‰ï¼ŒJavaåœ¨1.8è¿™ä¸ªç‰ˆæœ¬é‡Œï¼Œæä¾›äº†ä¸€ç§å«StampedLockçš„é”ï¼Œå®ƒçš„æ€§èƒ½å°±æ¯”è¯»å†™é”è¿˜è¦å¥½ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥ä»‹ç»ä¸€ä¸‹StampedLockçš„ä½¿ç”¨æ–¹æ³•ã€å†…éƒ¨å·¥ä½œåŸç†ä»¥åŠåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚</p><h2>StampedLockæ”¯æŒçš„ä¸‰ç§é”æ¨¡å¼</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä½¿ç”¨ä¸ŠStampedLockå’Œä¸Šä¸€ç¯‡æ–‡ç« è®²çš„ReadWriteLockæœ‰å“ªäº›åŒºåˆ«ã€‚</p><p>ReadWriteLockæ”¯æŒä¸¤ç§æ¨¡å¼ï¼šä¸€ç§æ˜¯è¯»é”ï¼Œä¸€ç§æ˜¯å†™é”ã€‚è€ŒStampedLockæ”¯æŒä¸‰ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼š<strong>å†™é”</strong>ã€<strong>æ‚²è§‚è¯»é”</strong>å’Œ<strong>ä¹è§‚è¯»</strong>ã€‚å…¶ä¸­ï¼Œå†™é”ã€æ‚²è§‚è¯»é”çš„è¯­ä¹‰å’ŒReadWriteLockçš„å†™é”ã€è¯»é”çš„è¯­ä¹‰éå¸¸ç±»ä¼¼ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–æ‚²è§‚è¯»é”ï¼Œä½†æ˜¯åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”ï¼Œå†™é”å’Œæ‚²è§‚è¯»é”æ˜¯äº’æ–¥çš„ã€‚ä¸åŒçš„æ˜¯ï¼šStampedLocké‡Œçš„å†™é”å’Œæ‚²è§‚è¯»é”åŠ é”æˆåŠŸä¹‹åï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ªstampï¼›ç„¶åè§£é”çš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥è¿™ä¸ªstampã€‚ç›¸å…³çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚</p><pre><code>final StampedLock sl = \n  new StampedLock();\n  \n// è·å–/é‡Šæ”¾æ‚²è§‚è¯»é”ç¤ºæ„ä»£ç \nlong stamp = sl.readLock();\ntry {\n  //çœç•¥ä¸šåŠ¡ç›¸å…³ä»£ç \n} finally {\n  sl.unlockRead(stamp);\n}\n\n// è·å–/é‡Šæ”¾å†™é”ç¤ºæ„ä»£ç \nlong stamp = sl.writeLock();\ntry {\n  //çœç•¥ä¸šåŠ¡ç›¸å…³ä»£ç \n} finally {\n  sl.unlockWrite(stamp);\n}\n</code></pre><p>StampedLockçš„æ€§èƒ½ä¹‹æ‰€ä»¥æ¯”ReadWriteLockè¿˜è¦å¥½ï¼Œå…¶å…³é”®æ˜¯StampedLockæ”¯æŒä¹è§‚è¯»çš„æ–¹å¼ã€‚ReadWriteLockæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†æ˜¯å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å†™æ“ä½œä¼šè¢«é˜»å¡ï¼›è€ŒStampedLockæä¾›çš„ä¹è§‚è¯»ï¼Œæ˜¯å…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯æ‰€æœ‰çš„å†™æ“ä½œéƒ½è¢«é˜»å¡ã€‚</p><!-- [[[read_end]]] --><p>æ³¨æ„è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯â€œä¹è§‚è¯»â€è¿™ä¸ªè¯ï¼Œè€Œä¸æ˜¯â€œä¹è§‚è¯»é”â€ï¼Œæ˜¯è¦æé†’ä½ ï¼Œ<strong>ä¹è§‚è¯»è¿™ä¸ªæ“ä½œæ˜¯æ— é”çš„</strong>ï¼Œæ‰€ä»¥ç›¸æ¯”è¾ƒReadWriteLockçš„è¯»é”ï¼Œä¹è§‚è¯»çš„æ€§èƒ½æ›´å¥½ä¸€äº›ã€‚</p><p>æ–‡ä¸­ä¸‹é¢è¿™æ®µä»£ç æ˜¯å‡ºè‡ªJava SDKå®˜æ–¹ç¤ºä¾‹ï¼Œå¹¶ç•¥åšäº†ä¿®æ”¹ã€‚åœ¨distanceFromOrigin()è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé¦–å…ˆé€šè¿‡è°ƒç”¨tryOptimisticRead()è·å–äº†ä¸€ä¸ªstampï¼Œè¿™é‡Œçš„tryOptimisticRead()å°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ä¹è§‚è¯»ã€‚ä¹‹åå°†å…±äº«å˜é‡xå’Œyè¯»å…¥æ–¹æ³•çš„å±€éƒ¨å˜é‡ä¸­ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºtryOptimisticRead()æ˜¯æ— é”çš„ï¼Œæ‰€ä»¥å…±äº«å˜é‡xå’Œyè¯»å…¥æ–¹æ³•å±€éƒ¨å˜é‡æ—¶ï¼Œxå’Œyæœ‰å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ã€‚å› æ­¤æœ€åè¯»å®Œä¹‹åï¼Œè¿˜éœ€è¦å†æ¬¡éªŒè¯ä¸€ä¸‹æ˜¯å¦å­˜åœ¨å†™æ“ä½œï¼Œè¿™ä¸ªéªŒè¯æ“ä½œæ˜¯é€šè¿‡è°ƒç”¨validate(stamp)æ¥å®ç°çš„ã€‚</p><pre><code>class Point {\n  private int x, y;\n  final StampedLock sl = \n    new StampedLock();\n  //è®¡ç®—åˆ°åŸç‚¹çš„è·ç¦»  \n  int distanceFromOrigin() {\n    // ä¹è§‚è¯»\n    long stamp = \n      sl.tryOptimisticRead();\n    // è¯»å…¥å±€éƒ¨å˜é‡ï¼Œ\n    // è¯»çš„è¿‡ç¨‹æ•°æ®å¯èƒ½è¢«ä¿®æ”¹\n    int curX = x, curY = y;\n    //åˆ¤æ–­æ‰§è¡Œè¯»æ“ä½œæœŸé—´ï¼Œ\n    //æ˜¯å¦å­˜åœ¨å†™æ“ä½œï¼Œå¦‚æœå­˜åœ¨ï¼Œ\n    //åˆ™sl.validateè¿”å›false\n    if (!sl.validate(stamp)){\n      // å‡çº§ä¸ºæ‚²è§‚è¯»é”\n      stamp = sl.readLock();\n      try {\n        curX = x;\n        curY = y;\n      } finally {\n        //é‡Šæ”¾æ‚²è§‚è¯»é”\n        sl.unlockRead(stamp);\n      }\n    }\n    return Math.sqrt(\n      curX * curX + curY * curY);\n  }\n}\n</code></pre><p>åœ¨ä¸Šé¢è¿™ä¸ªä»£ç ç¤ºä¾‹ä¸­ï¼Œå¦‚æœæ‰§è¡Œä¹è§‚è¯»æ“ä½œçš„æœŸé—´ï¼Œå­˜åœ¨å†™æ“ä½œï¼Œä¼šæŠŠä¹è§‚è¯»å‡çº§ä¸ºæ‚²è§‚è¯»é”ã€‚è¿™ä¸ªåšæ³•æŒºåˆç†çš„ï¼Œå¦åˆ™ä½ å°±éœ€è¦åœ¨ä¸€ä¸ªå¾ªç¯é‡Œåå¤æ‰§è¡Œä¹è§‚è¯»ï¼Œç›´åˆ°æ‰§è¡Œä¹è§‚è¯»æ“ä½œçš„æœŸé—´æ²¡æœ‰å†™æ“ä½œï¼ˆåªæœ‰è¿™æ ·æ‰èƒ½ä¿è¯xå’Œyçš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ï¼‰ï¼Œè€Œå¾ªç¯è¯»ä¼šæµªè´¹å¤§é‡çš„CPUã€‚å‡çº§ä¸ºæ‚²è§‚è¯»é”ï¼Œä»£ç ç®€ç»ƒä¸”ä¸æ˜“å‡ºé”™ï¼Œå»ºè®®ä½ åœ¨å…·ä½“å®è·µæ—¶ä¹Ÿé‡‡ç”¨è¿™æ ·çš„æ–¹æ³•ã€‚</p><h2>è¿›ä¸€æ­¥ç†è§£ä¹è§‚è¯»</h2><p>å¦‚æœä½ æ›¾ç»ç”¨è¿‡æ•°æ®åº“çš„ä¹è§‚é”ï¼Œå¯èƒ½ä¼šå‘ç°StampedLockçš„ä¹è§‚è¯»å’Œæ•°æ®åº“çš„ä¹è§‚é”æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚çš„ç¡®æ˜¯è¿™æ ·çš„ï¼Œå°±æ‹¿æˆ‘ä¸ªäººæ¥è¯´ï¼Œæˆ‘æ˜¯å…ˆæ¥è§¦çš„æ•°æ®åº“é‡Œçš„ä¹è§‚é”ï¼Œç„¶åæ‰æ¥è§¦çš„StampedLockï¼Œæˆ‘å°±è§‰å¾—æˆ‘å‰æœŸæ•°æ®åº“é‡Œä¹è§‚é”çš„å­¦ä¹ å¯¹äºåé¢ç†è§£StampedLockçš„ä¹è§‚è¯»æœ‰å¾ˆå¤§å¸®åŠ©ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰å¿…è¦å†ä»‹ç»ä¸€ä¸‹æ•°æ®åº“é‡Œçš„ä¹è§‚é”ã€‚</p><p>è¿˜è®°å¾—æˆ‘ç¬¬ä¸€æ¬¡ä½¿ç”¨æ•°æ®åº“ä¹è§‚é”çš„åœºæ™¯æ˜¯è¿™æ ·çš„ï¼šåœ¨ERPçš„ç”Ÿäº§æ¨¡å—é‡Œï¼Œä¼šæœ‰å¤šä¸ªäººé€šè¿‡ERPç³»ç»Ÿæä¾›çš„UIåŒæ—¶ä¿®æ”¹åŒä¸€æ¡ç”Ÿäº§è®¢å•ï¼Œé‚£å¦‚ä½•ä¿è¯ç”Ÿäº§è®¢å•æ•°æ®æ˜¯å¹¶å‘å®‰å…¨çš„å‘¢ï¼Ÿæˆ‘é‡‡ç”¨çš„æ–¹æ¡ˆå°±æ˜¯ä¹è§‚é”ã€‚</p><p>ä¹è§‚é”çš„å®ç°å¾ˆç®€å•ï¼Œåœ¨ç”Ÿäº§è®¢å•çš„è¡¨ product_doc é‡Œå¢åŠ äº†ä¸€ä¸ªæ•°å€¼å‹ç‰ˆæœ¬å·å­—æ®µ versionï¼Œæ¯æ¬¡æ›´æ–°product_docè¿™ä¸ªè¡¨çš„æ—¶å€™ï¼Œéƒ½å°† version å­—æ®µåŠ 1ã€‚ç”Ÿäº§è®¢å•çš„UIåœ¨å±•ç¤ºçš„æ—¶å€™ï¼Œéœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼Œæ­¤æ—¶å°†è¿™ä¸ª version å­—æ®µå’Œå…¶ä»–ä¸šåŠ¡å­—æ®µä¸€èµ·è¿”å›ç»™ç”Ÿäº§è®¢å•UIã€‚å‡è®¾ç”¨æˆ·æŸ¥è¯¢çš„ç”Ÿäº§è®¢å•çš„id=777ï¼Œé‚£ä¹ˆSQLè¯­å¥ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><pre><code>select idï¼Œ... ï¼Œversion\nfrom product_doc\nwhere id=777\n</code></pre><p>ç”¨æˆ·åœ¨ç”Ÿäº§è®¢å•UIæ‰§è¡Œä¿å­˜æ“ä½œçš„æ—¶å€™ï¼Œåå°åˆ©ç”¨ä¸‹é¢çš„SQLè¯­å¥æ›´æ–°ç”Ÿäº§è®¢å•ï¼Œæ­¤å¤„æˆ‘ä»¬å‡è®¾è¯¥æ¡ç”Ÿäº§è®¢å•çš„ version=9ã€‚</p><pre><code>update product_doc \nset version=version+1ï¼Œ...\nwhere id=777 and version=9\n</code></pre><p>å¦‚æœè¿™æ¡SQLè¯­å¥æ‰§è¡ŒæˆåŠŸå¹¶ä¸”è¿”å›çš„æ¡æ•°ç­‰äº1ï¼Œé‚£ä¹ˆè¯´æ˜ä»ç”Ÿäº§è®¢å•UIæ‰§è¡ŒæŸ¥è¯¢æ“ä½œåˆ°æ‰§è¡Œä¿å­˜æ“ä½œæœŸé—´ï¼Œæ²¡æœ‰å…¶ä»–äººä¿®æ”¹è¿‡è¿™æ¡æ•°æ®ã€‚å› ä¸ºå¦‚æœè¿™æœŸé—´å…¶ä»–äººä¿®æ”¹è¿‡è¿™æ¡æ•°æ®ï¼Œé‚£ä¹ˆç‰ˆæœ¬å·å­—æ®µä¸€å®šä¼šå¤§äº9ã€‚</p><p>ä½ ä¼šå‘ç°æ•°æ®åº“é‡Œçš„ä¹è§‚é”ï¼ŒæŸ¥è¯¢çš„æ—¶å€™éœ€è¦æŠŠ version å­—æ®µæŸ¥å‡ºæ¥ï¼Œæ›´æ–°çš„æ—¶å€™è¦åˆ©ç”¨ version å­—æ®µåšéªŒè¯ã€‚è¿™ä¸ª version å­—æ®µå°±ç±»ä¼¼äºStampedLocké‡Œé¢çš„stampã€‚è¿™æ ·å¯¹æ¯”ç€çœ‹ï¼Œç›¸ä¿¡ä½ ä¼šæ›´å®¹æ˜“ç†è§£StampedLocké‡Œä¹è§‚è¯»çš„ç”¨æ³•ã€‚</p><h2>StampedLockä½¿ç”¨æ³¨æ„äº‹é¡¹</h2><p>å¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯StampedLockæ€§èƒ½å¾ˆå¥½ï¼Œç®€å•çš„åº”ç”¨åœºæ™¯åŸºæœ¬ä¸Šå¯ä»¥æ›¿ä»£ReadWriteLockï¼Œä½†æ˜¯<strong>StampedLockçš„åŠŸèƒ½ä»…ä»…æ˜¯ReadWriteLockçš„å­é›†</strong>ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯æœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚</p><p>StampedLockåœ¨å‘½åä¸Šå¹¶æ²¡æœ‰å¢åŠ Reentrantï¼Œæƒ³å¿…ä½ å·²ç»çŒœæµ‹åˆ°StampedLockåº”è¯¥æ˜¯ä¸å¯é‡å…¥çš„ã€‚äº‹å®ä¸Šï¼Œçš„ç¡®æ˜¯è¿™æ ·çš„ï¼Œ<strong>StampedLockä¸æ”¯æŒé‡å…¥</strong>ã€‚è¿™ä¸ªæ˜¯åœ¨ä½¿ç”¨ä¸­å¿…é¡»è¦ç‰¹åˆ«æ³¨æ„çš„ã€‚</p><p>å¦å¤–ï¼ŒStampedLockçš„æ‚²è§‚è¯»é”ã€å†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡ï¼Œè¿™ä¸ªä¹Ÿéœ€è¦ä½ æ³¨æ„ã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œé‚£å°±æ˜¯ï¼šå¦‚æœçº¿ç¨‹é˜»å¡åœ¨StampedLockçš„readLock()æˆ–è€…writeLock()ä¸Šæ—¶ï¼Œæ­¤æ—¶è°ƒç”¨è¯¥é˜»å¡çº¿ç¨‹çš„interrupt()æ–¹æ³•ï¼Œä¼šå¯¼è‡´CPUé£™å‡ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼Œçº¿ç¨‹T1è·å–å†™é”ä¹‹åå°†è‡ªå·±é˜»å¡ï¼Œçº¿ç¨‹T2å°è¯•è·å–æ‚²è§‚è¯»é”ï¼Œä¹Ÿä¼šé˜»å¡ï¼›å¦‚æœæ­¤æ—¶è°ƒç”¨çº¿ç¨‹T2çš„interrupt()æ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹T2çš„è¯ï¼Œä½ ä¼šå‘ç°çº¿ç¨‹T2æ‰€åœ¨CPUä¼šé£™å‡åˆ°100%ã€‚</p><pre><code>final StampedLock lock\n  = new StampedLock();\nThread T1 = new Thread(()-&gt;{\n  // è·å–å†™é”\n  lock.writeLock();\n  // æ°¸è¿œé˜»å¡åœ¨æ­¤å¤„ï¼Œä¸é‡Šæ”¾å†™é”\n  LockSupport.park();\n});\nT1.start();\n// ä¿è¯T1è·å–å†™é”\nThread.sleep(100);\nThread T2 = new Thread(()-&gt;\n  //é˜»å¡åœ¨æ‚²è§‚è¯»é”\n  lock.readLock()\n);\nT2.start();\n// ä¿è¯T2é˜»å¡åœ¨è¯»é”\nThread.sleep(100);\n//ä¸­æ–­çº¿ç¨‹T2\n//ä¼šå¯¼è‡´çº¿ç¨‹T2æ‰€åœ¨CPUé£™å‡\nT2.interrupt();\nT2.join();\n</code></pre><p>æ‰€ä»¥ï¼Œ<strong>ä½¿ç”¨StampedLockä¸€å®šä¸è¦è°ƒç”¨ä¸­æ–­æ“ä½œï¼Œå¦‚æœéœ€è¦æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä¸€å®šä½¿ç”¨å¯ä¸­æ–­çš„æ‚²è§‚è¯»é”readLockInterruptibly()å’Œå†™é”writeLockInterruptibly()</strong>ã€‚è¿™ä¸ªè§„åˆ™ä¸€å®šè¦è®°æ¸…æ¥šã€‚</p><h2>æ€»ç»“</h2><p>StampedLockçš„ä½¿ç”¨çœ‹ä¸Šå»æœ‰ç‚¹å¤æ‚ï¼Œä½†æ˜¯å¦‚æœä½ èƒ½ç†è§£ä¹è§‚é”èƒŒåçš„åŸç†ï¼Œä½¿ç”¨èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒæµç•…çš„ã€‚å»ºè®®ä½ è®¤çœŸæ£æ‘©Javaçš„å®˜æ–¹ç¤ºä¾‹ï¼Œè¿™ä¸ªç¤ºä¾‹åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªæœ€ä½³å®è·µã€‚æˆ‘ä»¬æŠŠJavaå®˜æ–¹ç¤ºä¾‹ç²¾ç®€åï¼Œå½¢æˆä¸‹é¢çš„ä»£ç æ¨¡æ¿ï¼Œå»ºè®®ä½ åœ¨å®é™…å·¥ä½œä¸­å°½é‡æŒ‰ç…§è¿™ä¸ªæ¨¡æ¿æ¥ä½¿ç”¨StampedLockã€‚</p><p>StampedLockè¯»æ¨¡æ¿ï¼š</p><pre><code>final StampedLock sl = \n  new StampedLock();\n\n// ä¹è§‚è¯»\nlong stamp = \n  sl.tryOptimisticRead();\n// è¯»å…¥æ–¹æ³•å±€éƒ¨å˜é‡\n......\n// æ ¡éªŒstamp\nif (!sl.validate(stamp)){\n  // å‡çº§ä¸ºæ‚²è§‚è¯»é”\n  stamp = sl.readLock();\n  try {\n    // è¯»å…¥æ–¹æ³•å±€éƒ¨å˜é‡\n    .....\n  } finally {\n    //é‡Šæ”¾æ‚²è§‚è¯»é”\n    sl.unlockRead(stamp);\n  }\n}\n//ä½¿ç”¨æ–¹æ³•å±€éƒ¨å˜é‡æ‰§è¡Œä¸šåŠ¡æ“ä½œ\n......\n</code></pre><p>StampedLockå†™æ¨¡æ¿ï¼š</p><pre><code>long stamp = sl.writeLock();\ntry {\n  // å†™å…±äº«å˜é‡\n  ......\n} finally {\n  sl.unlockWrite(stamp);\n}\n</code></pre><h2>è¯¾åæ€è€ƒ</h2><p>StampedLockæ”¯æŒé”çš„é™çº§ï¼ˆé€šè¿‡tryConvertToReadLock()æ–¹æ³•å®ç°ï¼‰å’Œå‡çº§ï¼ˆé€šè¿‡tryConvertToWriteLock()æ–¹æ³•å®ç°ï¼‰ï¼Œä½†æ˜¯å»ºè®®ä½ è¦æ…é‡ä½¿ç”¨ã€‚ä¸‹é¢çš„ä»£ç ä¹Ÿæºè‡ªJavaçš„å®˜æ–¹ç¤ºä¾‹ï¼Œæˆ‘ä»…ä»…åšäº†ä¸€ç‚¹ä¿®æ”¹ï¼Œéšè—äº†ä¸€ä¸ªBugï¼Œä½ æ¥çœ‹çœ‹Bugå‡ºåœ¨å“ªé‡Œå§ã€‚</p><pre><code>private double x, y;\nfinal StampedLock sl = new StampedLock();\n// å­˜åœ¨é—®é¢˜çš„æ–¹æ³•\nvoid moveIfAtOrigin(double newX, double newY){\n long stamp = sl.readLock();\n try {\n  while(x == 0.0 &amp;&amp; y == 0.0){\n    long ws = sl.tryConvertToWriteLock(stamp);\n    if (ws != 0L) {\n      x = newX;\n      y = newY;\n      break;\n    } else {\n      sl.unlockRead(stamp);\n      stamp = sl.writeLock();\n    }\n  }\n } finally {\n  sl.unlock(stamp);\n}\n</code></pre><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p></p>","comments":[{"had_liked":false,"id":83972,"user_name":"linqw","can_delete":false,"product_type":"c1","uid":1134138,"ip_address":"","ucode":"09DCFE98C54DD8","user_header":"https://static001.geekbang.org/account/avatar/00/11/4e/3a/86196508.jpg","comment_is_top":false,"comment_ctime":1554740962,"is_pvip":false,"replies":[{"id":"30307","content":"ğŸ‘<br>","user_name":"ä½œè€…å›å¤","comment_id":83972,"uid":"1269969","ip_address":"","utype":1,"ctime":1554771048,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":5,"race_medal":0,"score":"418166568674","product_id":100023901,"comment_content":"è¯¾åæ€è€ƒé¢˜ï¼šåœ¨é”å‡çº§æˆåŠŸçš„æ—¶å€™ï¼Œæœ€åæ²¡æœ‰é‡Šæ”¾æœ€æ–°çš„å†™é”ï¼Œå¯ä»¥åœ¨ifå—çš„breakä¸ŠåŠ ä¸ªstamp=wsè¿›è¡Œé‡Šæ”¾","like_count":98,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446196,"discussion_content":"ğŸ‘\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554771048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1554995,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ba/33/2d83d174.jpg","nickname":"æ—¶å…‰å®ˆæŠ¤è€…-åŸºå…°","note":"","ucode":"F0B0887B1979D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365751,"discussion_content":"æœ‰ä¸ªç–‘é—®ï¼Œè¿›å…¥åˆ°elseé‡Œé¢æ˜¯å°è¯•å‡çº§é”å¤±è´¥ï¼Œå…ˆé‡Šæ”¾è¯»é”ã€‚å†è·å–å†™é”æ˜¯å› ä¸ºæœ€åfinallyä»£ç å—ä¸­è¦é‡Šæ”¾é”å—","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617875184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2100403,"avatar":"https://static001.geekbang.org/account/avatar/00/20/0c/b3/7e13920b.jpg","nickname":"ğŸ“Dream-seeker","note":"","ucode":"3C8477DE9DD766","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1554995,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ba/33/2d83d174.jpg","nickname":"æ—¶å…‰å®ˆæŠ¤è€…-åŸºå…°","note":"","ucode":"F0B0887B1979D2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558236,"discussion_content":"é˜²æ­¢å…¶ä¸€ç›´å¤„äºå¾ªç¯ä½“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648170459,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":365751,"ip_address":""},"score":558236,"extra":""}]},{"author":{"id":1554995,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ba/33/2d83d174.jpg","nickname":"æ—¶å…‰å®ˆæŠ¤è€…-åŸºå…°","note":"","ucode":"F0B0887B1979D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365749,"discussion_content":"è´´ä¸Šæºç \nvoid moveIfAtOrigin(double newX, double newY) { // upgrade\n  // Could instead start with optimistic, not read mode\n  long stamp = sl.readLock();\n  try {\n    while (x == 0.0 &amp;&amp; y == 0.0) {\n      long ws = sl.tryConvertToWriteLock(stamp);\n      if (ws != 0L) {\n        stamp = ws;\n        x = newX;\n        y = newY;\n        break;\n      }\n      else {\n        sl.unlockRead(stamp);\n        stamp = sl.writeLock();\n      }\n    }\n  } finally {\n    sl.unlock(stamp);\n  }\n}","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617874609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK2Az5uTh9ZGVA7yQCj1BXtXuicPRkvJicA97AoN9xX3bnPcUYglTMXJeZeoVbPQeJA7ICvQhR3KQ0w/132","nickname":"æ—¥ä¸è½å¸å›½","note":"","ucode":"6A11ABBD8AC438","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6430,"discussion_content":"å­¦ä¹ äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566896263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84174,"user_name":"èƒ¡æ¡¥","can_delete":false,"product_type":"c1","uid":1055874,"ip_address":"","ucode":"673C3207614010","user_header":"https://static001.geekbang.org/account/avatar/00/10/1c/82/74ab79df.jpg","comment_is_top":false,"comment_ctime":1554797866,"is_pvip":false,"replies":[{"id":"30394","content":"æ”¹äº†å°±æ”¹äº†ï¼Œè¯»çš„æ•°æ®æ˜¯æ­£ç¡®çš„ä¸€è‡´çš„å°±å¯ä»¥äº†ã€‚å¦‚æœè¿™ä¸ªè§„åˆ™ä¸æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥æ€»äº’æ–¥é”ã€‚ä¸åŒçš„é”ç”¨ä¸åŒåœ°æ–¹ã€‚","user_name":"ä½œè€…å›å¤","comment_id":84174,"uid":"1269969","ip_address":"","utype":1,"ctime":1554820390,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":8,"race_medal":0,"score":"194828326186","product_id":100023901,"comment_content":"ä¹è§‚é”çš„æƒ³æ³•æ˜¯â€œæ²¡äº‹ï¼Œè‚¯å®šæ²¡è¢«æ”¹è¿‡â€ï¼Œäºæ˜¯å°±å¼€å¿ƒåœ°è·å–åˆ°æ•°æ®ï¼Œä¸æ”¾å¿ƒå—ï¼Ÿé‚£å°±å†éªŒè¯ä¸€ä¸‹ï¼Œçœ‹çœ‹çœŸçš„æ²¡è¢«æ”¹è¿‡å§ï¼Ÿè¿™ä¸‹å¯ä»¥æ”¾å¿ƒä½¿ç”¨æ•°æ®äº†ã€‚<br>æˆ‘çš„é—®é¢˜æ˜¯ï¼ŒéªŒè¯å®Œä¹‹åã€ä½¿ç”¨æ•°æ®ä¹‹å‰ï¼Œæ•°æ®è¢«å…¶ä»–çº¿ç¨‹æ”¹äº†æ€ä¹ˆåŠï¼Ÿæˆ‘çœ‹ä¸å‡ºvalidateçš„æ„ä¹‰ã€‚è¿™ä¸ªå’Œæ•°æ®åº“æ›´æ–°å¥½åƒè¿˜ä¸ä¸€æ ·ï¼Œæ•°æ®åº“æ˜¯åœ¨å†™çš„æ—¶å€™å‘ç°å·²ç»è¢«å…¶ä»–äººå†™äº†ã€‚è¿™é‡Œvalidateä¹‹åä¹Ÿéš¾å…æ•°æ®åœ¨è¿›è¡Œä¸šåŠ¡è®¡ç®—ä¹‹å‰å·²ç»è¢«æ”¹æ‰äº†å•Šï¼Ÿ","like_count":45,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446268,"discussion_content":"æ”¹äº†å°±æ”¹äº†ï¼Œè¯»çš„æ•°æ®æ˜¯æ­£ç¡®çš„ä¸€è‡´çš„å°±å¯ä»¥äº†ã€‚å¦‚æœè¿™ä¸ªè§„åˆ™ä¸æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥æ€»äº’æ–¥é”ã€‚ä¸åŒçš„é”ç”¨ä¸åŒåœ°æ–¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554820390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1077931,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Wy62w9wUM6hLpx7wSw0M1SPoT6pKr07yPHOib56CvtzIQ96t7eZkG4UHQ2kgp9jzBJzfxB1mlP8ibosdqxVwicQUw/132","nickname":"ä¸‰è‰¯","note":"","ucode":"1AAAAED847D85E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215701,"discussion_content":"åœ¨ distanceFromOrigin() æ–¹æ³•é‡Œï¼Œéœ€è¦\n    step1.  å…ˆè¯»åˆ° x å’Œy çš„å€¼ï¼Œ\n    step2. ç„¶ååŸºäºx å’Œ y è®¡ç®—è·ç¦» sqrt(x*x+y*y);\nç¤ºä¾‹ä¸­ï¼Œè¯»åˆ° x å’Œ yçš„å€¼åï¼ˆstep1ä¹‹åï¼Œstep2ä¹‹å‰ï¼‰ï¼Œè¿›è¡Œ sl.validate()ï¼Œåªæ˜¯ä¸ºäº†ä¿è¯è¯»åˆ°çš„ x, y åœ¨step1è¯»æœŸé—´æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œå¹¶ä¸ä¿è¯åœ¨step2è®¡ç®—æœŸé—´ä¸å‘ç”Ÿæ”¹å˜ï¼Œè¿™ä¹Ÿæ˜¯ä½œè€…å›å¤çš„â€œæ”¹äº†å°±æ”¹äº†â€ã€‚\n\nâ€œä¿è¯åœ¨step1è¯»æœŸé—´æ²¡æœ‰å‘ç”Ÿæ”¹å˜â€çœ‹ä¼¼æ²¡æ„ä¹‰ï¼Œå®é™…ä¸Šstep1è¯»åˆ°çš„æ˜¯ä¸¤ä¸ªå€¼ã€‚\nå¦‚æœåœ¨è¯»æœŸé—´å‘ç”Ÿæ”¹å˜çš„è¯ï¼Œéœ€è¦æ”¹å˜ä¸¤ä¸ªå˜é‡å€¼ï¼Œä»(x1, y1) å˜ä¸º (x2, y2)ã€‚\nä¿è¯åœ¨step1è¯»æœŸé—´æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œèƒ½å¤Ÿä¿è¯è¿”å›çš„æ•°æ®è¦ä¹ˆæ˜¯ sqrt(x1*x1+y1*y1) è¦ä¹ˆæ˜¯ sqrt(x2*x2+y2*y2)ï¼Œæ— éæ˜¯æ–°å€¼orè€å€¼çš„æƒ…å†µï¼Œæ•°æ®åŸºäºè¯»æ•°æ®çš„æ—¶åˆ»æœ¬èº«æ˜¯æ­£ç¡®çš„\nå¦‚æœä¸ä¿è¯step1è¯»æœŸé—´æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œæœ‰å¯èƒ½è¿”å› sqrt(x1*x1+y2*y2)ï¼Œé‚£è¿”å›çš„æ•°æ®å°±æ˜¯é”™è¯¯çš„æ•°æ®ã€‚\n","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1585372884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"å–œæ¬¢åœ°çƒçš„é˜¿åŸ¹åŒå­¦","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":104156,"discussion_content":"è¿™ä¸ªä¹è§‚è¯»çš„ä¸»è¦ç›®çš„æ˜¯æ•°æ®è¯»å–è¿‡ç¨‹ä¸­æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœè¯¥æ•°æ®è¿˜éœ€è¦è¿›è¡Œåé¢çš„èµ‹å€¼æ“ä½œï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„ï¼Œåªèƒ½é€šè¿‡åŠ é”æˆ–casä¿è¯ã€‚","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1577414983,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1566569,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e7/69/0c426b52.jpg","nickname":"åˆ˜æ˜“å®","note":"","ucode":"EE337683D08B9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":63787,"discussion_content":"æˆ‘çš„ç†è§£æ˜¯ï¼Œè¯»æ•°æ®æœ¬èº«ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œåœ¨è¯»æ•°æ®çš„æ—¶å€™æœ‰æ•°æ®è¢«å†™å…¥ï¼Œæ•°æ®çš„æ­£ç¡®æ€§å°±æ— æ³•ä¿è¯äº†ã€‚æ‰€ä»¥è¦åŠ ä¸€ä¸ªvalidateéªŒè¯æ•°æ®æ˜¯ä¸æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å†™å…¥ï¼Œå¦‚æœè¢«å†™å…¥ï¼Œå°±åŠ é”ä¿è¯å€¼æ•°æ®çš„æ­£ç¡®æ€§","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1574910705,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1247965,"avatar":"https://static001.geekbang.org/account/avatar/00/13/0a/dd/88fa7b52.jpg","nickname":"Geek_41d472","note":"","ucode":"DEC2B6329460CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288141,"discussion_content":"å¯ä»¥ä¿è¯åº¦çš„è¿‡ç¨‹ä¸­æ•°æ®æ²¡æœ‰è¢«ä¿®æ”¹,è¯»å®Œåæ•°æ®æ˜¯å¯èƒ½ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹,è¿™æ˜¯å¾ˆæ­£å¸¸çš„;å’Œæ•°æ®åº“çš„ä¹è§‚é”ç¡®å®æœ‰ç‚¹ç‚¹åŒºåˆ«,æ•°æ®åº“å¦‚æœå‘ç°åˆ«è®¤ä¿®æ”¹äº†,åˆ™éœ€è¦ä»æ–°è·å–æœ€æ–°çš„å€¼;,è€Œè¿™é‡Œè¯»å®Œæ•°æ®å,å¦‚æœå…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ•°æ®,è¿™é‡Œå°±ä¸å†ä»æ–°è·å–æœ€æ–°çš„å€¼è¿›è¡Œç›¸å…³ä¸šåŠ¡æ“ä½œäº†","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1593660605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2154554,"avatar":"","nickname":"koby","note":"","ucode":"16F596A9A963DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380567,"discussion_content":"ç”¨æ‚²è§‚è¯»ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ‚²è§‚è¯»å®Œåï¼Œè¿˜æ²¡ä½¿ç”¨ï¼Œç„¶åæœ‰äººæ¥è·å–å†™é”ï¼Œå½“ç„¶èƒ½è·å–åˆ°ï¼Œç„¶åæ”¹äº†ã€‚ä¸šåŠ¡åœºæ™¯å¦‚æœå°±æ˜¯è¦æ±‚è¯»å†™å®Œå…¨ä¸²è¡Œï¼Œå°±ä¸è¦ç”¨è¯»å†™é”","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624584830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1493907,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cb/93/4adea49a.jpg","nickname":"åŠªåŠ›åŠªåŠ›å†åŠªåŠ›","note":"","ucode":"0C6EEA28FCE8C7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2154554,"avatar":"","nickname":"koby","note":"","ucode":"16F596A9A963DF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581322,"discussion_content":"è¿™è‚¯å®šä¸ä¸€æ ·ï¼Œæ‚²è§‚è¯»çš„è¿‡ç¨‹ä¸­éƒ½è·å–ä¸äº†å†™é”ï¼Œæ— æ³•ä¿®æ”¹å§ã€‚é™¤éä½ è¯»äº†æ•°æ®ï¼Œé‡Šæ”¾é”ä»¥åå†å¤„ç†ï¼Œä½†é‚£æ ·ç”¨é”å°±æ²¡æ„ä¹‰äº†ï¼Œèµ„æºé€¸å‡ºä¸´ç•ŒåŒºäº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1658722801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":380567,"ip_address":""},"score":581322,"extra":""}]},{"author":{"id":1484192,"avatar":"https://static001.geekbang.org/account/avatar/00/16/a5/a0/e0cccf7e.jpg","nickname":"åœ†åœ†æ»¡æ»¡","note":"","ucode":"396E7A822014D1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292887,"discussion_content":"ä¹è§‚é”èƒ½ä¿è¯æ›´æ–°çš„ä¸²è¡ŒåŒ–ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯è¯»çš„ä¸²è¡ŒåŒ–ã€‚ä¸šåŠ¡åœºæ™¯è¦èƒ½æ¥å—å°±å¯ä»¥ç”¨ã€‚å¼ºä¸€è‡´çš„å°±åŠ é”ï¼Œä¹Ÿå°±ç‰ºç‰²äº†æ€§èƒ½ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1595378393,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83979,"user_name":"GrubbyğŸ‘","can_delete":false,"product_type":"c1","uid":1181905,"ip_address":"","ucode":"26B9256226F919","user_header":"https://static001.geekbang.org/account/avatar/00/12/08/d1/3c7747ef.jpg","comment_is_top":false,"comment_ctime":1554748319,"is_pvip":false,"replies":[{"id":"30306","content":"å†…éƒ¨å®ç°é‡Œwhileå¾ªç¯é‡Œé¢å¯¹ä¸­æ–­çš„å¤„ç†æœ‰ç‚¹é—®é¢˜","user_name":"ä½œè€…å›å¤","comment_id":83979,"uid":"1269969","ip_address":"","utype":1,"ctime":1554771033,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"164763505567","product_id":100023901,"comment_content":"è€å¸ˆï¼Œè°ƒç”¨interruptå¼•èµ·cpué£™é«˜çš„åŸå› æ˜¯ä»€ä¹ˆ","like_count":39,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446199,"discussion_content":"å†…éƒ¨å®ç°é‡Œwhileå¾ªç¯é‡Œé¢å¯¹ä¸­æ–­çš„å¤„ç†æœ‰ç‚¹é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554771033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84112,"user_name":"Presley","can_delete":false,"product_type":"c1","uid":1215219,"ip_address":"","ucode":"D8F125835F4903","user_header":"https://static001.geekbang.org/account/avatar/00/12/8a/f3/7c89d00e.jpg","comment_is_top":false,"comment_ctime":1554786884,"is_pvip":false,"replies":[{"id":"30487","content":"ä¸¤ç§åœºæ™¯ï¼Œå¦‚æœå¤„ç†ä¸šåŠ¡éœ€è¦ä¿æŒäº’æ–¥ï¼Œé‚£ä¹ˆå°±ç”¨äº’æ–¥é”ï¼Œå¦‚æœä¸éœ€è¦ä¿æŒäº’æ–¥æ‰å¯ä»¥ç”¨è¯»å†™é”ã€‚ä¸€èˆ¬æ¥è®²ç¼“å­˜æ˜¯ä¸éœ€è¦ä¿æŒäº’æ–¥æ€§çš„ï¼Œèƒ½æ¥å—ç¬é—´çš„ä¸ä¸€è‡´<br>","user_name":"ä½œè€…å›å¤","comment_id":84112,"uid":"1269969","ip_address":"","utype":1,"ctime":1554945102,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"126108838468","product_id":100023901,"comment_content":"è€å¸ˆï¼ŒStampedLock è¯»æ¨¡æ¿ï¼Œå…ˆé€šè¿‡ä¹è§‚è¯»æˆ–è€…æ‚²è§‚è¯»é”è·å–å˜é‡ï¼Œç„¶ååˆ©ç”¨è¿™äº›å˜é‡å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¼šä¸ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨çš„æƒ…å†µå‘¢? æ¯”å¦‚ï¼Œè¯»å‡ºæ¥çš„å˜é‡æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†çš„æ—¶å€™ï¼Œè¿™æ—¶ï¼Œè¯»å‡ºçš„å˜é‡æœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–äº†å§(æ¯”å¦‚è¢«å†™é”æ”¹å†™äº†)ï¼Ÿæ‰€ä»¥ï¼Œå½“ä½¿ç”¨ä¹è§‚è¯»é”æ—¶ï¼Œæ˜¯ä¸æ˜¯ç­‰ä¸šåŠ¡éƒ½å¤„ç†å®Œäº†ï¼ˆæ¯”å¦‚å…ˆåˆ©ç”¨å˜é‡æŠŠè·ç¦»è®¡ç®—å®Œï¼‰ï¼Œå†åˆ¤æ–­å˜é‡æ˜¯å¦è¢«æ”¹å†™ï¼Œå¦‚æœæ²¡æ”¹å†™ï¼Œç›´æ¥return;å¦‚æœå·²ç»æ”¹å†™ï¼Œåˆ™ä½¿ç”¨æ‚²è§‚è¯»é”åšåŒæ ·çš„äº‹æƒ…ã€‚ä¸è¿‡å¦‚æœä¸šåŠ¡æ¯”è¾ƒè€—æ—¶ï¼Œå¯èƒ½æŒæœ‰æ‚²è§‚é”çš„æ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œä¸çŸ¥é“ç†è§£å¯¹ä¸å¯¹","like_count":29,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446256,"discussion_content":"ä¸¤ç§åœºæ™¯ï¼Œå¦‚æœå¤„ç†ä¸šåŠ¡éœ€è¦ä¿æŒäº’æ–¥ï¼Œé‚£ä¹ˆå°±ç”¨äº’æ–¥é”ï¼Œå¦‚æœä¸éœ€è¦ä¿æŒäº’æ–¥æ‰å¯ä»¥ç”¨è¯»å†™é”ã€‚ä¸€èˆ¬æ¥è®²ç¼“å­˜æ˜¯ä¸éœ€è¦ä¿æŒäº’æ–¥æ€§çš„ï¼Œèƒ½æ¥å—ç¬é—´çš„ä¸ä¸€è‡´\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554945102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83980,"user_name":"GrubbyğŸ‘","can_delete":false,"product_type":"c1","uid":1181905,"ip_address":"","ucode":"26B9256226F919","user_header":"https://static001.geekbang.org/account/avatar/00/12/08/d1/3c7747ef.jpg","comment_is_top":false,"comment_ctime":1554748516,"is_pvip":false,"replies":[{"id":"30308","content":"ğŸ‘<br>","user_name":"ä½œè€…å›å¤","comment_id":83980,"uid":"1269969","ip_address":"","utype":1,"ctime":1554771058,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":2,"race_medal":0,"score":"87454094436","product_id":100023901,"comment_content":"bugæ˜¯tryConvertToWriteLockè¿”å›çš„write stampæ²¡æœ‰é‡æ–°èµ‹å€¼ç»™stamp","like_count":20,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446200,"discussion_content":"ğŸ‘\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554771058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK2Az5uTh9ZGVA7yQCj1BXtXuicPRkvJicA97AoN9xX3bnPcUYglTMXJeZeoVbPQeJA7ICvQhR3KQ0w/132","nickname":"æ—¥ä¸è½å¸å›½","note":"","ucode":"6A11ABBD8AC438","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6431,"discussion_content":"å­¦ä¹ å­¦ä¹ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566896394,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85905,"user_name":"å‘æ¡æ©™å­ ã€‚","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":false,"comment_ctime":1555290639,"is_pvip":false,"replies":[{"id":"30901","content":"ä½¿ç”¨finalæ˜¯ä¸ªå¥½ä¹ æƒ¯","user_name":"ä½œè€…å›å¤","comment_id":85905,"uid":"1269969","ip_address":"","utype":1,"ctime":1555300273,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":2,"race_medal":0,"score":"61684832783","product_id":100023901,"comment_content":"è€å¸ˆ ï¼Œ æˆ‘çœ‹äº‹ä¾‹é‡Œé¢æˆå‘˜å˜é‡éƒ½ç»™äº†ä¸€ä¸ª final å…³é”®å­— ã€‚ è¯·é—®è¿™é‡Œç»™å˜é‡åŠ  finalçš„ç”¨æ„æ˜¯ä»€ä¹ˆ ï¼Œä»…ä»…æ˜¯ä¸ºäº†é˜²æ­¢ä¸‹é¢æ–¹æ³•ä¸­ä»£ç ç»™ä»–èµ‹æ–°çš„å¯¹è±¡ä¹ˆ ã€‚ æˆ‘åœ¨å¹³å¸¸å†™ä»£ç ä¸­å¾ˆå°‘æœ‰ç»™å˜é‡åŠ  final çš„ä¹ æƒ¯ï¼Œ å¸Œæœ›è€å¸ˆèƒ½æŒ‡ç‚¹ä¸€ä¸‹ ğŸ˜„","like_count":14,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446861,"discussion_content":"ä½¿ç”¨finalæ˜¯ä¸ªå¥½ä¹ æƒ¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555300273,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1662994,"avatar":"https://static001.geekbang.org/account/avatar/00/19/60/12/d99027df.jpg","nickname":"Zhi","note":"","ucode":"47DB818B2FDF86","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":19535,"discussion_content":"ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œè€å¸ˆç‰¹åœ°è¯´è¿‡finalçš„ä½œç”¨å§ï¼Œæ˜¯ä¸ºäº†å‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªå˜é‡ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥é€šè¿‡æŒ‡ä»¤é‡æ’åºä½¿åŠ²ä¼˜åŒ–ã€‚  åœ¨javaå†…å­˜æ¨¡å‹é‚£ç« ä¸‹åŠéƒ¨åˆ†æåˆ°çš„","likes_number":16,"is_delete":false,"is_hidden":false,"ctime":1569205250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84021,"user_name":"echoï¼¿é™ˆ","can_delete":false,"product_type":"c1","uid":1080794,"ip_address":"","ucode":"EFAEADA8A05906","user_header":"https://static001.geekbang.org/account/avatar/00/10/7d/da/780f149e.jpg","comment_is_top":false,"comment_ctime":1554770331,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35914508699","product_id":100023901,"comment_content":"ä»¥å‰çœ‹è¿‡javaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼Œè®²jdkå¹¶å‘ç±»åº“â€¦â€¦ä¸è¿‡é‚£ä¸ªä¹¦ç±æ˜¯jdk1.7ç‰ˆæœ¬â€¦â€¦æ‰€ä»¥æ˜¯å¤´ä¸€æ¬¡æ¥è§¦StempLockâ€¦â€¦æ¶¨çŸ¥è¯†äº†","like_count":8},{"had_liked":false,"id":93889,"user_name":"å—åŒ—å°‘å¿","can_delete":false,"product_type":"c1","uid":1018958,"ip_address":"","ucode":"DFCC59F2BBD8CE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/4e/b81969fa.jpg","comment_is_top":false,"comment_ctime":1557653479,"is_pvip":false,"replies":[{"id":"33667","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":93889,"uid":"1269969","ip_address":"","utype":1,"ctime":1557757307,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"31622424551","product_id":100023901,"comment_content":"jdkæºç StampedLockä¸­çš„ç¤ºä¾‹ï¼Œif (ws != 0L) æ—¶ä½¿ç”¨äº†stamp=ws","like_count":7,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449811,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557757307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85516,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1555092083,"is_pvip":false,"replies":[{"id":"30844","content":"stampå’Œwsæ²¡å…³ç³»ï¼ŒtryConvertToWriteLock(stamp)è¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šé‡Šæ”¾æ‚²è§‚è¯»é”stampï¼ˆæ¡ä»¶æ˜¯èƒ½å¤Ÿå‡çº§æˆåŠŸï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡Šæ”¾çš„æ˜¯ws","user_name":"ä½œè€…å›å¤","comment_id":85516,"uid":"1269969","ip_address":"","utype":1,"ctime":1555241304,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"31619863155","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼Œ<br>å¦‚æœæˆ‘åœ¨å‰é¢long stamp = sl.readLock();å‡çº§é”ålong ws = sl.tryConvertToWriteLock(stamp);<br>è¿™ä¸ª stampå’Œwsæ˜¯ä»€ä¹ˆå…³ç³»æ¥çš„ï¼Œæ˜¯sl.unlockRead(æ˜¯å…³stampè¿˜æ˜¯ws)ã€‚ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢","like_count":7,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446692,"discussion_content":"stampå’Œwsæ²¡å…³ç³»ï¼ŒtryConvertToWriteLock(stamp)è¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šé‡Šæ”¾æ‚²è§‚è¯»é”stampï¼ˆæ¡ä»¶æ˜¯èƒ½å¤Ÿå‡çº§æˆåŠŸï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡Šæ”¾çš„æ˜¯ws","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555241304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228088,"user_name":"å—åŒ—å°‘å¿","can_delete":false,"product_type":"c1","uid":1018958,"ip_address":"","ucode":"DFCC59F2BBD8CE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/4e/b81969fa.jpg","comment_is_top":false,"comment_ctime":1592552015,"is_pvip":false,"replies":[{"id":"84699","content":"è¿™é‡Œç±»æ¯”å¾ˆç”ŸåŠ¨ğŸ˜„","user_name":"ä½œè€…å›å¤","comment_id":228088,"uid":"1269969","ip_address":"","utype":1,"ctime":1593003351,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"18772421199","product_id":100023901,"comment_content":"è¿™ä¸ªè·å–é”è¿”å›çš„stamp,å¯ä»¥ç†è§£æˆä¸Šé”åçš„é’¥åŒ™å—?","like_count":4,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498916,"discussion_content":"è¿™é‡Œç±»æ¯”å¾ˆç”ŸåŠ¨ğŸ˜„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593003351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188270,"user_name":"å‰å®³äº†æˆ‘çš„å›½","can_delete":false,"product_type":"c1","uid":1052191,"ip_address":"","ucode":"CD0A54A1B998AA","user_header":"https://static001.geekbang.org/account/avatar/00/10/0e/1f/d0472177.jpg","comment_is_top":false,"comment_ctime":1584333494,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18764202678","product_id":100023901,"comment_content":"åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œjavaçš„é”è¿˜æœ‰ç”¨æ­¦ä¹‹åœ°å—ï¼Ÿæ„Ÿè§‰å°±æ˜¯ç©å…·å•Šã€‚ã€‚","like_count":4,"discussions":[{"author":{"id":1441448,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fe/a8/0a202d2f.jpg","nickname":"Vincent","note":"","ucode":"0C0C3DF59FA61A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298671,"discussion_content":"éš¾ä¸æˆæ‰€æœ‰çš„é›†ç¾¤éƒ½æ˜¯å•æ ¸ï¼Ÿ","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1597375023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103768,"user_name":"æ¥Š_å®µå¤œ","can_delete":false,"product_type":"c1","uid":1019302,"ip_address":"","ucode":"7BA0CADC5F23BB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/a6/22c37c91.jpg","comment_is_top":false,"comment_ctime":1560506575,"is_pvip":false,"replies":[{"id":"37541","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":103768,"uid":"1269969","ip_address":"","utype":1,"ctime":1560511833,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"18740375759","product_id":100023901,"comment_content":"ç‹è€å¸ˆ, æ‚¨å¥½, æ–‡ç« ä¸­çš„StampedLockæ¨¡æ¿, åªé€‚ç”¨äºå•æœºåº”ç”¨å§? å¦‚æœæ˜¯é›†ç¾¤éƒ¨ç½², é‚£è¿˜æ˜¯å¾—ç”¨æ•°æ®åº“ä¹è§‚é”, æ˜¯å—??","like_count":4,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453994,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560511833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84724,"user_name":"ttang","can_delete":false,"product_type":"c1","uid":1310486,"ip_address":"","ucode":"15EF6544A64994","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoVRER40LhyAmwlCqszX6s02Ix04Yztia9UIFrcm3JV9gHmbswvffqCW0KentRGVrPJuibyzJlpcW5g/132","comment_is_top":false,"comment_ctime":1554899002,"is_pvip":false,"replies":[{"id":"30455","content":"ä¹è§‚è¯»å‡çº§åˆ°æ‚²è§‚è¯»ï¼Œå°±å’ŒReadWriteLockä¸€æ ·äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":84724,"uid":"1269969","ip_address":"","utype":1,"ctime":1554903998,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":3,"race_medal":0,"score":"18734768186","product_id":100023901,"comment_content":"è€å¸ˆï¼ŒReadWriteLocké”å’ŒStampedLocké”éƒ½æ˜¯å¯ä»¥åŒæ—¶è¯»çš„ï¼ŒåŒºåˆ«æ˜¯StampedLockä¹è§‚è¯»ä¸åŠ é”ã€‚é‚£StampedLockæ¯”ReadWriteLockæ€§èƒ½é«˜çš„åŸå› å°±æ˜¯èŠ‚çœäº†åŠ è¯»é”çš„æ€§èƒ½æŸè€—å—ï¼Ÿå¦å¤–StampedLockç”¨ä¹è§‚è¯»çš„æ—¶å€™æ˜¯å…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”çš„ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºStampedLockå¯¹å†™çš„æ€§èƒ½æ›´é«˜ï¼Œä¼šä¸ä¼šå› ä¸ºå†™é”è·å–æ¦‚ç‡å¢å¤§å¤§ï¼Œå¯¼è‡´ä¸èƒ½è·å–è¯»é”ã€‚å¯¼è‡´StampedLockè¯»æ€§èƒ½åè€Œæ²¡æœ‰ReadWriteLocké«˜ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446430,"discussion_content":"ä¹è§‚è¯»å‡çº§åˆ°æ‚²è§‚è¯»ï¼Œå°±å’ŒReadWriteLockä¸€æ ·äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554903998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1077931,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Wy62w9wUM6hLpx7wSw0M1SPoT6pKr07yPHOib56CvtzIQ96t7eZkG4UHQ2kgp9jzBJzfxB1mlP8ibosdqxVwicQUw/132","nickname":"ä¸‰è‰¯","note":"","ucode":"1AAAAED847D85E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215708,"discussion_content":"æ€§èƒ½çœ‹æ¦‚ç‡ï¼Œä¹Ÿå°±æ˜¯ è¯»æ“ä½œ å’Œ å†™æ“ä½œ å†²çªçš„æ¦‚ç‡ã€‚\nStampedLockåœ¨ ä¹è§‚è¯» çš„åœºæ™¯æ˜¯æ²¡æœ‰åŠ é”çš„ï¼Œéœ€è¦è‡ªå·±é€šè¿‡validate()è¿›è¡Œåˆ¤æ–­ï¼Œå•ç‹¬çš„ä¹è§‚è¯»æ“ä½œ å¼€é”€ è‚¯å®š å°äº ReadWriteLockçš„ReadLockã€‚\nå¦‚æœvalidate()å¤±è´¥ï¼Œéœ€è¦å‡çº§æˆ æ‚²è§‚è¯»é”ï¼Œå•ç‹¬çš„æ‚²è§‚è¯»é” çš„å¼€é”€ å’Œ ReadWriteLockçš„ReadLockä¸€è‡´ã€‚ä½†æ˜¯ å…ˆä¹è§‚è¯» å¤±è´¥å† åŠ æ‚²è§‚è¯»é”ï¼Œç¬¬ä¸€æ¬¡çš„ä¹è§‚è¯»å°±æ˜¯å¤šå‡ºæ¥çš„å¼€é”€ã€‚\nå†™æ¦‚ç‡å¤§çš„åœºæ™¯ï¼Œä¹Ÿå°±ä¸è¯¥ä½¿ç”¨ä¹è§‚é”äº†ã€‚","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1585373716,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1855137,"avatar":"","nickname":"Geek_e6f358","note":"","ucode":"C21E94A90258A2","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1077931,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Wy62w9wUM6hLpx7wSw0M1SPoT6pKr07yPHOib56CvtzIQ96t7eZkG4UHQ2kgp9jzBJzfxB1mlP8ibosdqxVwicQUw/132","nickname":"ä¸‰è‰¯","note":"","ucode":"1AAAAED847D85E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385400,"discussion_content":"åŠ æ‚²è§‚é”ä¹‹åï¼Œä¹Ÿæ˜¯æœ‰åŒºåˆ«å§ã€‚æ‚²è§‚è¯»æ—¶ï¼Œæœ‰å†™çº¿ç¨‹è¿›æ¥ï¼Œå†™çº¿ç¨‹é˜»å¡ç­‰å¾…æ‚²è§‚è¯»é‡Šæ”¾è¯»é”ã€‚å†™çº¿ç¨‹ä¹‹åè¿›æ¥çš„è¯»çº¿ç¨‹ä¼šåœ¨ä¹è§‚è¯»ä¹‹åç»§ç»­æ‰§è¡Œï¼Œè€ŒreadWriteLockä¸­è¯»çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°å†™çº¿ç¨‹é‡Šæ”¾å†™é”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627028156,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":215708,"ip_address":""},"score":385400,"extra":""}]}]},{"had_liked":false,"id":84031,"user_name":"å†¯ä¼ åš","can_delete":false,"product_type":"c1","uid":1177787,"ip_address":"","ucode":"91B9A1EF0FF042","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/bb/8b2ba45d.jpg","comment_is_top":false,"comment_ctime":1554771501,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18734640685","product_id":100023901,"comment_content":"è§£é‡Šä¸€ä¸‹ cpu é£™å‡çš„åŸå› å‘—","like_count":4,"discussions":[{"author":{"id":1687656,"avatar":"https://static001.geekbang.org/account/avatar/00/19/c0/68/314e8306.jpg","nickname":"å¨å…ˆæ£®","note":"","ucode":"5F445C6832274B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363571,"discussion_content":"åœ¨whileé‡Œé¢å¤„ç†ä¸­æ–­çš„ä»£ç æœ‰é—®é¢˜ï¼Œä¸Šé¢çœ‹è€å¸ˆæ˜¯è¿™ä¹ˆå›ç­”çš„","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617239238,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84020,"user_name":"å¯†ç 123456","can_delete":false,"product_type":"c1","uid":1126593,"ip_address":"","ucode":"9889463CC0EA71","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","comment_is_top":false,"comment_ctime":1554770307,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18734639491","product_id":100023901,"comment_content":"æ‚²è§‚é”å’Œä¹è§‚é”ã€‚æ‚²è§‚é”ï¼Œå°±æ˜¯æ™®é€šçš„é”ã€‚ä¹è§‚é”ï¼Œå°±æ˜¯æ— é”ï¼Œä»…å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œåœ¨å–å®Œæ•°æ®éªŒè¯ä¸€ä¸‹ç‰ˆæœ¬å·ã€‚å¦‚æœä¸ä¸€è‡´é‚£ä¹ˆå°±è¿›è¡Œæ‚²è§‚é”è·å–é”ã€‚èƒ½å¤Ÿè¿™ä¹ˆç†è§£å—ï¼Ÿ","like_count":4},{"had_liked":false,"id":85697,"user_name":"å¼ æ´‹","can_delete":false,"product_type":"c1","uid":1182914,"ip_address":"","ucode":"549BE5DEEF8417","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/c2/bad34a50.jpg","comment_is_top":false,"comment_ctime":1555204535,"is_pvip":true,"replies":[{"id":"30814","content":"å¦‚æœç”¨redisï¼Œå°±å®Œå…¨ä¾èµ–redisï¼Œæœ¬åœ°ä¸èƒ½æœ‰ç¼“å­˜ï¼Œæœ‰ç¼“å­˜å°±å¯èƒ½æ•°æ®ä¸ä¸€è‡´ã€‚ä¸æ¸…æ¥šä½ æœ‰æ²¡æœ‰ç”¨æœ¬åœ°ç¼“å­˜ã€‚redisåšç§’æ€æœ‰å¾ˆå¤šæˆç†Ÿçš„æ–¹æ¡ˆï¼Œå¥½åƒéƒ½æ²¡æ³•ç”¨ä¹è§‚è¯»ã€‚","user_name":"ä½œè€…å›å¤","comment_id":85697,"uid":"1269969","ip_address":"","utype":1,"ctime":1555209280,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"14440106423","product_id":100023901,"comment_content":"ç‹è€å¸ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæœ€è¿‘åšä¸€äº›å…³äºç§’æ€çš„ä¸šåŠ¡ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç”¨åˆ°ä¹è§‚è¯»çš„æ€§è´¨ã€‚<br>å°†åº“å­˜é‡æ”¾åœ¨redisé‡Œè¾¹ï¼Œç„¶åæ‰€æœ‰çš„èŠ‚ç‚¹æ“ä½œçš„æ—¶å€™é€šè¿‡ç¼“å­˜è¯»å‡ºæ¥ï¼Œåœ¨ä»£ç é€»è¾‘é‡Œè¾¹å¯¹åº“å­˜åŠ ä¸€ä¸ª<br>ä¹è§‚è¯»çš„æ“ä½œã€‚ç„¶ååº“å­˜é‡ç­‰äº0 çš„æ—¶å€™å†å»å’Œæ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚  è¿™æ ·åšä¼šå­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜å—ã€‚","like_count":3,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446770,"discussion_content":"å¦‚æœç”¨redisï¼Œå°±å®Œå…¨ä¾èµ–redisï¼Œæœ¬åœ°ä¸èƒ½æœ‰ç¼“å­˜ï¼Œæœ‰ç¼“å­˜å°±å¯èƒ½æ•°æ®ä¸ä¸€è‡´ã€‚ä¸æ¸…æ¥šä½ æœ‰æ²¡æœ‰ç”¨æœ¬åœ°ç¼“å­˜ã€‚redisåšç§’æ€æœ‰å¾ˆå¤šæˆç†Ÿçš„æ–¹æ¡ˆï¼Œå¥½åƒéƒ½æ²¡æ³•ç”¨ä¹è§‚è¯»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555209280,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84869,"user_name":"on the way","can_delete":false,"product_type":"c1","uid":1323807,"ip_address":"","ucode":"77B29D60168D7F","user_header":"https://static001.geekbang.org/account/avatar/00/14/33/1f/35b68f47.jpg","comment_is_top":false,"comment_ctime":1554941939,"is_pvip":false,"replies":[{"id":"30663","content":"å°±æ˜¯ç­‰ä¸€ä¼šå„¿ï¼Œä¿è¯å‰é¢çš„å­çº¿ç¨‹å·²ç»å¯åŠ¨åŒ…<br>","user_name":"ä½œè€…å›å¤","comment_id":84869,"uid":"1269969","ip_address":"","utype":1,"ctime":1555118701,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"14439843827","product_id":100023901,"comment_content":"æœ‰ç‚¹æ²¡çœ‹æ˜ç™½ç¤ºä¾‹interrupté‚£ä¸ªä»£ç é‡Œçš„ Thread.sleepï¼ˆ100ï¼‰â€¦","like_count":3,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446477,"discussion_content":"å°±æ˜¯ç­‰ä¸€ä¼šå„¿ï¼Œä¿è¯å‰é¢çš„å­çº¿ç¨‹å·²ç»å¯åŠ¨åŒ…\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555118701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163927,"user_name":"èµ°é©¬","can_delete":false,"product_type":"c1","uid":1251016,"ip_address":"","ucode":"EEFE8F7590FFA4","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/c8/980776fc.jpg","comment_is_top":false,"comment_ctime":1576829161,"is_pvip":false,"replies":[{"id":"62400","content":"è¿™ä¸ªæˆ‘å›ç­”ä¸äº†ğŸ˜‚","user_name":"ä½œè€…å›å¤","comment_id":163927,"uid":"1269969","ip_address":"","utype":1,"ctime":1576909756,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"10166763753","product_id":100023901,"comment_content":"æ‚¨å¥½ï¼Œè€å¸ˆï¼Œæˆ‘ä¸€ç›´æœ‰ä¸ªç–‘æƒ‘ï¼Œ ç±»ä¼¼ERPçš„ç³»ç»Ÿï¼Œå®ƒçš„ç¨‹åºä»£ç æœ¬èº«æ²¡åšå¹¶å‘å¤„ç†ï¼Œä½†æ˜¯å–çš„æ—¶å€™ä¼šå’Œå®¢æˆ·è¯´ä¸åŒå¹¶å‘ä»·æ ¼ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„ ï¼Ÿ æ˜¯ç”±ä¸€ä¸ªç‹¬ç«‹çš„è½¯ä»¶æ¥å¤„ç†å¹¶å‘å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478584,"discussion_content":"è¿™ä¸ªæˆ‘å›ç­”ä¸äº†ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576909756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139055,"user_name":"æ™¯æ¢¦å›­","can_delete":false,"product_type":"c1","uid":1620479,"ip_address":"","ucode":"0A17708457ACB2","user_header":"https://static001.geekbang.org/account/avatar/00/18/b9/ff/ea6c2e86.jpg","comment_is_top":false,"comment_ctime":1570536811,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10160471403","product_id":100023901,"comment_content":"tryConvertToWriteLock<br>public long tryConvertToWriteLock(long stamp)<br>If the lock state matches the given stamp, performs one of the following actions. If the stamp represents holding a write lock, returns it. Or, if a read lock, if the write lock is available, releases the read lock and returns a write stamp. Or, if an optimistic read, returns a write stamp only if immediately available. This method returns zero in all other cases.<br>Parameters:<br>stamp - a stamp<br>Returns:<br>a valid write stamp, or zero on failure","like_count":2},{"had_liked":false,"id":290340,"user_name":"å¤•é˜³æ­¦å£«","can_delete":false,"product_type":"c1","uid":1480522,"ip_address":"","ucode":"DDCF11F69CDAB5","user_header":"https://static001.geekbang.org/account/avatar/00/16/97/4a/0da51831.jpg","comment_is_top":false,"comment_ctime":1619509295,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5914476591","product_id":100023901,"comment_content":"int getAnd() {<br>        long stamp = stampedLock.tryOptimisticRead();<br>        System.out.println(Thread.currentThread().getName() + &quot;,ä¹è§‚è¯»ï¼šx: &quot; + x + &quot;,y: &quot; + y);<br>        if (!stampedLock.validate(stamp)) {<br>            stamp = stampedLock.readLock();<br>            try {<br>                System.out.println(Thread.currentThread().getName() + &quot;,æ‚²è§‚è¯»é”ï¼šx: &quot; + x + &quot;,y: &quot; + y);<br>            } catch (Exception e) {<br>                e.printStackTrace();<br>            } finally {<br>                stampedLock.unlock(stamp);<br>            }<br>        }<br>        return x + y;<br>    }<br><br>    void set(int x, int y) {<br>        long stamp = stampedLock.writeLock();<br>        try {<br>            this.x = x;<br>            this.y = y;<br>            System.out.println(&quot;å†™é”å¼€å§‹èµ‹å€¼ã€‚ã€‚ã€‚ã€‚ã€‚&quot;);<br>        } catch (Exception e) {<br>            e.printStackTrace();<br>        } finally {<br>            stampedLock.unlock(stamp);<br>        }<br>    }<br><br>è¿è¡Œç»“æœï¼š<br>Thread-9927,ä¹è§‚è¯»ï¼šx: 0,y: 0<br>Thread-9920,ä¹è§‚è¯»ï¼šx: 0,y: 0<br>Thread-9923,ä¹è§‚è¯»ï¼šx: 0,y: 0<br>Thread-9902,ä¹è§‚è¯»ï¼šx: 0,y: 0<br>å†™é”å¼€å§‹èµ‹å€¼ã€‚ã€‚ã€‚ã€‚ã€‚<br>Thread-9996,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9993,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9994,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9990,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9997,ä¹è§‚è¯»ï¼šx: 0,y: 0<br>Thread-9899,ä¹è§‚è¯»ï¼šx: 0,y: 0<br>Thread-9987,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9997,æ‚²è§‚è¯»é”ï¼šx: 22,y: 33<br>Thread-9986,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9992,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9891,ä¹è§‚è¯»ï¼šx: 22,y: 33<br>Thread-9899,æ‚²è§‚è¯»é”ï¼šx: 22,y: 33<br>Thread-9983,ä¹è§‚è¯»ï¼šx: 22,y: 33<br><br>å†™ä¸ªdemoéªŒè¯ä¸€ä¸‹ï¼Œä»Thread-9997è¿™ä¸ªçº¿ç¨‹çš„æ”¹å˜ï¼Œå¯ä»¥çœ‹å‡ºå‡çº§é”çš„è¿‡ç¨‹ã€‚","like_count":2},{"had_liked":false,"id":276077,"user_name":"æˆç”µå¸…æ‰","can_delete":false,"product_type":"c1","uid":2139604,"ip_address":"","ucode":"DDE757138F41D2","user_header":"","comment_is_top":false,"comment_ctime":1611766045,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5906733341","product_id":100023901,"comment_content":"çº¿ç¨‹é˜»å¡åœ¨ StampedLock çš„ readLock() æˆ–è€… writeLock() ä¸Šï¼Œè¿™é‡Œçš„é˜»å¡ä¸ä¼šå¯¹åº”é˜»å¡é˜Ÿåˆ—æˆ–è€…åŒæ­¥é˜Ÿåˆ—ä¹ˆï¼Ÿ","like_count":1},{"had_liked":false,"id":260378,"user_name":"xzy","can_delete":false,"product_type":"c1","uid":1002095,"ip_address":"","ucode":"1A44368083A19E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4a/6f/e36b3908.jpg","comment_is_top":false,"comment_ctime":1604994705,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5899962001","product_id":100023901,"comment_content":" ReadWriteLock VS StampedLock<br>- éƒ½é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼ŒStampedLockçš„ä¹è§‚é”æœºåˆ¶ï¼Œæ€§èƒ½æ¯”ReadWriteLockå¥½<br>- StampedLock çš„æ‚²è§‚è¯»é”ã€å†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡<br>- StampedLockä¸­æ–­æ“ä½œä¼šé€ æˆcpu100%","like_count":1},{"had_liked":false,"id":253886,"user_name":"HDJ","can_delete":false,"product_type":"c1","uid":1721981,"ip_address":"","ucode":"07089ED8097D2F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/cc0hNnM5FAIianMn14icicKYviabHDebISCtD8LJXnnZf51jjCXsw49qstulXloS6dVibYRc8ANJ5OjcwnGvUCg9rkA/132","comment_is_top":false,"comment_ctime":1602933247,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5897900543","product_id":100023901,"comment_content":"StampedLock æºç è¯¦è§£å¯ä»¥ç»“åˆ è¿™ç¯‡åšæ–‡ä¸€èµ·é˜…è¯» : https:&#47;&#47;segmentfault.com&#47;a&#47;1190000015808032?utm_source=tag-newest","like_count":1},{"had_liked":false,"id":174929,"user_name":"yalio","can_delete":false,"product_type":"c1","uid":1131862,"ip_address":"","ucode":"FAB63813E4533A","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/56/60ee7623.jpg","comment_is_top":false,"comment_ctime":1580462873,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5875430169","product_id":100023901,"comment_content":"ä¾‹å­ä¸­è·å–x,yå…±äº«å˜é‡çš„å€¼æ—¶ï¼Œæ€ä¹ˆä¿è¯æ˜¯è¯»å–çš„æœ€æ–°çš„å€¼å‘¢ï¼Œå¦‚æœæ˜¯å½“å‰çº¿ç¨‹çš„ç¼“å­˜å€¼æ€ä¹ˆåŠ","like_count":1,"discussions":[{"author":{"id":2697700,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/LFJZ4x47rvShGhsePLIxc8EzdlBxAmVAIjJ2FQZ4NEpo8E4JCZQEOb2NIfOuiaQLL6Otkt7W3Rmu6Tv3AkgYdRA/132","nickname":"é”®ç›˜ä¸Šçš„é­”æœ¯","note":"","ucode":"A731D721FB8D3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558277,"discussion_content":"è€å¸ˆä¹‹å‰è®²reentrantLockæ—¶æœ‰æåˆ°ï¼Œæºç é‡Œæœ‰ä¸ªvolatileçš„stateå­—æ®µï¼Œé€šè¿‡å®ƒä¿è¯å¯è§æ€§ã€‚å…¶å®ƒçš„lockéƒ½æœ‰è¿™ä¹ˆä¸ªå­—æ®µ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648188038,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1077931,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Wy62w9wUM6hLpx7wSw0M1SPoT6pKr07yPHOib56CvtzIQ96t7eZkG4UHQ2kgp9jzBJzfxB1mlP8ibosdqxVwicQUw/132","nickname":"ä¸‰è‰¯","note":"","ucode":"1AAAAED847D85E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215723,"discussion_content":"StampedLockçš„å®ç°é‡Œæœ‰ä¸€ä¸ªå†…éƒ¨å­—æ®µ `volatile long state;`\nå†™é”ä¼šé€šè¿‡Unsafe.cas()ä¿®æ”¹è¯¥å­—æ®µï¼Œæ‚²è§‚è¯»é”å’Œä¹è§‚è¯»éƒ½ä¼šè·å–è¯¥å­—æ®µçš„å€¼ï¼ˆå½“ç„¶æ‚²è§‚è¯»é”ä¼šä¿®æ”¹è¯¥å­—æ®µï¼Œä½†æ˜¯ä¹è§‚è¯»ä¸ä¼šä¿®æ”¹è¯¥å­—æ®µï¼‰ï¼ŒåŸºäºJavaå†…å­˜æ¨¡å‹é‡Œçš„Happens-Beforeè§„åˆ™ï¼Œä¼šä¿è¯å¯è§æ€§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585375491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":122403,"user_name":"ç»…å£«","can_delete":false,"product_type":"c1","uid":1583859,"ip_address":"","ucode":"5B58E5A958F489","user_header":"https://static001.geekbang.org/account/avatar/00/18/2a/f3/b9607a15.jpg","comment_is_top":false,"comment_ctime":1565359108,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5860326404","product_id":100023901,"comment_content":"è€å¸ˆï¼Œæ€è€ƒé¢˜ï¼Œé¦–å…ˆè¯»é”å·²ç»å‡çº§ä¸ºå†™é”äº†ï¼Œç„¶åå†™é”é‡Šæ”¾ï¼Œé‚£æœ€åè¯»é”è¿˜éœ€è¦é‡Šæ”¾å—ï¼Ÿè¿™é‡Œä¸å¤ªæ˜ç™½ï¼Œä¸åº”è¯¥ä¸éœ€è¦é‡Šæ”¾çš„å—","like_count":1,"discussions":[{"author":{"id":1606288,"avatar":"https://static001.geekbang.org/account/avatar/00/18/82/90/295449c4.jpg","nickname":"åŠç”Ÿç“œã€‚","note":"","ucode":"6D4CC445230D19","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5089,"discussion_content":"è€å¸ˆè¯´è¯»é”å’Œå†™é”æ˜¯äº’æ–¥çš„ï¼Œé‚£å°±è¯´æ˜å‡çº§ä¸ºå†™é”åè¯»é”å·²ç»è¢«é‡Šæ”¾ã€‚ç„¶åå†ç”¨å†™é”åŠ é”ï¼Œæ‰€ä»¥åé¢é‡Šæ”¾å†™é”å°±å¯ä»¥äº†ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1565937723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2697700,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/LFJZ4x47rvShGhsePLIxc8EzdlBxAmVAIjJ2FQZ4NEpo8E4JCZQEOb2NIfOuiaQLL6Otkt7W3Rmu6Tv3AkgYdRA/132","nickname":"é”®ç›˜ä¸Šçš„é­”æœ¯","note":"","ucode":"A731D721FB8D3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558278,"discussion_content":"çœ‹ä¸€ä¸‹tryConvertToWriteLockæ–¹æ³•ä¸Šé¢çš„æ³¨é‡Šï¼Œæœ‰ä¸€å¥ï¼šOr, if a read lock, if the write lock is available, releases the read lock and returns a write stamp.  å¦‚æœåŸæ¥æ˜¯æ‚²è§‚è¯»é”ï¼Œéœ€è¦å‡çº§æˆå†™é”ï¼Œä¼šé‡Šæ”¾è¯»é”ï¼Œå¹¶ä¸”è¿”å›è¯»é”çš„stampï¼ˆæ–°å€¼ï¼Œå³wsï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648188267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114725,"user_name":"å°”å†¬æ©™","can_delete":false,"product_type":"c1","uid":1225224,"ip_address":"","ucode":"0B013A49BC18DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/08/92f42622.jpg","comment_is_top":false,"comment_ctime":1563370922,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5858338218","product_id":100023901,"comment_content":"è€å¸ˆï¼Œ if (ws != 0L)è¿™ä¸ªæ˜¯åˆ¤æ–­æ˜¯ä»€ä¹ˆçš„ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2028938,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f5/8a/dc9a23a1.jpg","nickname":"ç»­è´¹ä¸“ç”¨","note":"","ucode":"1B585A131B64B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290794,"discussion_content":"åˆ¤æ–­æ˜¯å¦åŠ é”æˆåŠŸ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594606951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114716,"user_name":"å°”å†¬æ©™","can_delete":false,"product_type":"c1","uid":1225224,"ip_address":"","ucode":"0B013A49BC18DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/08/92f42622.jpg","comment_is_top":false,"comment_ctime":1563369213,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5858336509","product_id":100023901,"comment_content":"è€å¸ˆï¼Œæ‚¨è®¡ç®—è·ç¦»çš„ä»£ç ä¸­æ˜¯ä¸æ˜¯ç±»å‹è¦è½¬æ¢ä¸‹ï¼Ÿreturn (int) Math.sqrt(curX * curX + curY * curY);","like_count":1},{"had_liked":false,"id":103977,"user_name":"linqw","can_delete":false,"product_type":"c1","uid":1134138,"ip_address":"","ucode":"09DCFE98C54DD8","user_header":"https://static001.geekbang.org/account/avatar/00/11/4e/3a/86196508.jpg","comment_is_top":false,"comment_ctime":1560580206,"is_pvip":false,"replies":[{"id":"37618","content":"ğŸ‘ï¼Œæœ‰ç©ºæˆ‘ä¹Ÿå­¦ä¹ ä¸€ä¸‹ğŸ˜„","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1560591652,"ip_address":"","comment_id":103977,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5855547502","product_id":100023901,"comment_content":"ä»å¤´é‡æ–°çœ‹ä¸€ç¯‡ï¼Œä¹Ÿè‡ªå·±å¤§è‡´å†™äº†ä¸‹å¯¹StampedLockçš„æºç åˆ†æhttps:&#47;&#47;juejin.im&#47;editor&#47;posts&#47;5d00a6c8e51d45105d63a4edï¼Œè€å¸ˆæœ‰ç©ºå¸®å¿™çœ‹ä¸‹å“¦","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454078,"discussion_content":"ğŸ‘ï¼Œæœ‰ç©ºæˆ‘ä¹Ÿå­¦ä¹ ä¸€ä¸‹ğŸ˜„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560591652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":91691,"user_name":"ç‹‚é£éª¤é›¨","can_delete":false,"product_type":"c1","uid":1305749,"ip_address":"","ucode":"5CE9B9438FAB3F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKZSibeTatZ2ImL5Xu3QqdTWQs5nyQAxDlsm3m0KicP3TN6icJqYricvhjOFfTB2B3oLInU45CC9LtqMA/132","comment_is_top":false,"comment_ctime":1557073871,"is_pvip":false,"replies":[{"id":"34453","content":"è¯»å†™æ˜¯äº’æ–¥çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1558362024,"ip_address":"","comment_id":91691,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5852041167","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä½ ä¸Šç« è®²çš„ReadWriteLockï¼Œè¯´çš„æ˜¯å½“æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå†™æ“ä½œæ—¶æ‰€æœ‰çš„è¯»çº¿ç¨‹éƒ½è¢«é˜»å¡ï¼Œæœ¬ç« ä½ åˆæäº†ä¸€ä¸‹ReadWriteLockï¼Œè¯´çš„æ˜¯å½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œæ‰€æœ‰çš„å†™æ“ä½œéƒ½è¢«é˜»å¡ï¼Œè¿™æ ·æ˜¯","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448994,"discussion_content":"è¯»å†™æ˜¯äº’æ–¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558362024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84439,"user_name":"èƒ¡æ¡¥","can_delete":false,"product_type":"c1","uid":1055874,"ip_address":"","ucode":"673C3207614010","user_header":"https://static001.geekbang.org/account/avatar/00/10/1c/82/74ab79df.jpg","comment_is_top":false,"comment_ctime":1554863439,"is_pvip":false,"replies":[{"id":"30429","content":"æ²¡æ³•ä¿è¯ä¸¤ä¸ªå˜é‡çš„ä¸€è‡´æ€§<br>","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1554869548,"ip_address":"","comment_id":84439,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5849830735","product_id":100023901,"comment_content":"validateä¹Ÿæ— æ³•ä¿è¯ä¸€è‡´æ€§æ˜¯å—ï¼Ÿå¦‚æœæ˜¯é‚£ä¹ˆåº”è¯¥æ€ä¹ˆç”¨validateï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446361,"discussion_content":"æ²¡æ³•ä¿è¯ä¸¤ä¸ªå˜é‡çš„ä¸€è‡´æ€§\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554869548,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351944,"user_name":"FARO_Z","can_delete":false,"product_type":"c1","uid":2410092,"ip_address":"","ucode":"B33BCC36C2A74E","user_header":"https://static001.geekbang.org/account/avatar/00/24/c6/6c/a400175a.jpg","comment_is_top":false,"comment_ctime":1658304713,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658304713","product_id":100023901,"comment_content":"ä¹è§‚è¯»å‡çº§ä¸ºæ‚²è§‚è¯»ï¼Œæ˜¯ä¸ºäº†ä¿è¯è¯» &quot;å–å¤šä¸ªæˆå‘˜å˜é‡çš„å€¼&quot; è¿™ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œå³ä¸å¸Œæœ›è¯»å–åˆ°ä¿®æ”¹çš„ä¸­é—´å€¼ã€‚<br><br>é‚£å¦‚æœåªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡è¢«è¯»å–å’Œä¿®æ”¹ï¼Œè¿™ä¸ªé”å‡çº§çš„æ“ä½œè¿˜æœ‰å¿…è¦å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":339538,"user_name":"é”®ç›˜ä¸Šçš„é­”æœ¯","can_delete":false,"product_type":"c1","uid":2697700,"ip_address":"","ucode":"A731D721FB8D3A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/LFJZ4x47rvShGhsePLIxc8EzdlBxAmVAIjJ2FQZ4NEpo8E4JCZQEOb2NIfOuiaQLL6Otkt7W3Rmu6Tv3AkgYdRA/132","comment_is_top":false,"comment_ctime":1648176617,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648176617","product_id":100023901,"comment_content":"&quot;å› æ­¤æœ€åè¯»å®Œä¹‹åï¼Œè¿˜éœ€è¦å†æ¬¡éªŒè¯ä¸€ä¸‹æ˜¯å¦å­˜åœ¨å†™æ“ä½œï¼Œè¿™ä¸ªéªŒè¯æ“ä½œæ˜¯é€šè¿‡è°ƒç”¨ validate(stamp) æ¥å®ç°çš„ã€‚&quot;<br><br>è¿™é‡Œçš„&quot;æ˜¯å¦å­˜åœ¨å†™æ“ä½œ&quot;ï¼Œæ˜¯ä¸æ˜¯åº”è¯¥æ”¹æˆ&quot;æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹è·å¾—è¿‡å†™é”&quot;ã€‚ æ¯•ç«Ÿä»å®ç°è§’åº¦è®²ï¼Œ å†™æ“ä½œå¾ˆéš¾æ„ŸçŸ¥åˆ°ï¼Œ è·å¾—è¿‡å†™é”åˆ™å¯ä»¥æ„ŸçŸ¥åˆ°çš„å§ã€‚ ä¹Ÿå°±æ˜¯è¯´å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹ä¸è·å¾—å†™é”ï¼Œå°±ç›´æ¥å†™å…±äº«å˜é‡ï¼Œè¿™ä¸ªvalidateæ–¹æ³•æ„ŸçŸ¥ä¸åˆ°çš„å§<br><br>","like_count":0},{"had_liked":false,"id":312061,"user_name":"åˆ°é“å¯é“","can_delete":false,"product_type":"c1","uid":1031181,"ip_address":"","ucode":"12B94B6C26BE0D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bc/0d/00424e81.jpg","comment_is_top":false,"comment_ctime":1631610787,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1631610787","product_id":100023901,"comment_content":"StampedLockæ˜¯ä»¥åŠ é”æ—¶è¿”å›çš„longå‹stampï¼Œæ¥è¿›è¡Œè§£é”çš„ï¼›ä»£ç ä¸­è¿›è¡Œå†™é”å‡çº§æ—¶ï¼Œé‡‡ç”¨äº†æ–°çš„å˜é‡wsæ¥å­˜å‚¨é”å‡çº§åçš„è¿”å›å€¼ï¼Œä½†ä»£ç ä¸­æ²¡æœ‰é’ˆå¯¹å‡çº§åçš„å†™é”çš„è§£é”ä»£ç ã€‚","like_count":0},{"had_liked":false,"id":303852,"user_name":"Geek_e6f358","can_delete":false,"product_type":"c1","uid":1855137,"ip_address":"","ucode":"C21E94A90258A2","user_header":"","comment_is_top":false,"comment_ctime":1627028395,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1627028395","product_id":100023901,"comment_content":"ä¸è¦åœ¨æˆ‘çš„ä¸´ç•ŒåŒºæ”¹æ•°ï¼Œä½ è¦æ•¢æ”¹ï¼Œæˆ‘å°±åŠ é”ä¸è®©ä½ å†æ”¹ï¼Œç›´åˆ°æˆ‘è¯»å®Œ","like_count":0},{"had_liked":false,"id":285759,"user_name":"Laughing","can_delete":false,"product_type":"c1","uid":1002134,"ip_address":"","ucode":"F68F1E000CA800","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4a/96/99466a06.jpg","comment_is_top":false,"comment_ctime":1617004311,"is_pvip":false,"replies":[{"id":"103700","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1617020190,"ip_address":"","comment_id":285759,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1617004311","product_id":100023901,"comment_content":"è¯¾åé¢˜çš„ä»£ç å°±æ˜¯å®˜æ–¹çš„å®ä¾‹ï¼Œè¿™é‡Œåœ¨æˆåŠŸå‡é”ä¹‹åæ²¡æœ‰æŠŠå¾—åˆ°çš„å†™é”wsèµ‹å€¼ç»™`stamp`å˜é‡ï¼Œè¿™æ ·æœ€åè§£é”æ—¶ä¼šæŠ¥IllegalMonitorStateExceptionçš„å¼‚å¸¸ã€‚","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517772,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617020190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280150,"user_name":"ben harden","can_delete":false,"product_type":"c1","uid":1512500,"ip_address":"","ucode":"6F1AAD00DA1B1B","user_header":"https://static001.geekbang.org/account/avatar/00/17/14/34/6e58aebe.jpg","comment_is_top":false,"comment_ctime":1614094390,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614094390","product_id":100023901,"comment_content":"ä¹è§‚è¯»è¿”å›çš„stampï¼Œåœ¨æœ‰ä¿®æ”¹çš„çš„æ—¶å€™ï¼ˆè¿™ä¸ªæ—¶å€™ä¼šæœ‰å†™é”å—ï¼Ÿï¼Œå¦‚æœæœ‰è¿™ä¸ªå†™é”çš„stampå’Œä¹è§‚è¯»stampæœ‰å…³ç³»å—ï¼Ÿï¼‰","like_count":0},{"had_liked":false,"id":272202,"user_name":"ç™½æ¨","can_delete":false,"product_type":"c1","uid":1743868,"ip_address":"","ucode":"B56DD94706F80B","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9b/fc/a3abbe53.jpg","comment_is_top":false,"comment_ctime":1609987872,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609987872","product_id":100023901,"comment_content":"    &#47;&#47; ä¹è§‚è¯»<br>    long stamp = <br>      sl.tryOptimisticRead();<br><br>    int curX = x, curY = y;<br><br>    if (!sl.validate(stamp)){<br>    <br>    }<br>    return Math.sqrt(<br>      curX * curX + curY * curY);<br>æœ‰ä¸ªç–‘é—®ï¼Œè¿™é‡Œå¦‚æœ  if (!sl.validate(stamp))æ—¶åˆ¤æ–­ä¸ºfalseï¼Œå³åˆ¤æ–­æ²¡æœ‰æ›´æ–°æ“ä½œï¼Œä½†æ˜¯åœ¨Math.sqrt(      curX * curX + curY * curY);ä¹‹å‰å‘ç”Ÿäº†æ›´æ–°ï¼Œæ€ä¹ˆåŠï¼Ÿè¿™é‡Œæ²¡æœ‰é—®é¢˜ä¹ˆ","like_count":0},{"had_liked":false,"id":267166,"user_name":"æ”¾ç‰§äºº","can_delete":false,"product_type":"c1","uid":1980326,"ip_address":"","ucode":"CA248909EFE7E0","user_header":"https://static001.geekbang.org/account/avatar/00/1e/37/a6/3e7c2d5c.jpg","comment_is_top":false,"comment_ctime":1607614563,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607614563","product_id":100023901,"comment_content":"è¯¾åæ€è€ƒé¢˜è¿™é‡Œä¹‹æ‰€ä»¥æœ‰bugï¼Œæ˜¯å› ä¸º tryConvertToWriteLockæ–¹æ³•åœ¨ è¯»é”è·å–å†™é”æ—¶ï¼Œå¦‚æœå†™é”æ˜¯åˆç†çš„ï¼Œä¼šé‡Šæ”¾ä¹‹å‰çš„è¯»é”ï¼Œå¹¶è¿”å›å†™é”çš„ stampï¼Œæ‰€ä»¥è¿™é‡Œå¦‚æœif (ws != 0L) æ„å‘³ç€å‡çº§å†™é”æˆåŠŸï¼Œéœ€è¦é‡Šæ”¾å†™é”å¯¹åº”çš„ stamp å³ unlock(ws)<br>å®˜æ–¹APIåŸæ³¨é‡Š if a read lock, if the write lock is available, releases the read lock and returns a write stamp","like_count":0},{"had_liked":false,"id":264375,"user_name":"Mr.Hwang","can_delete":false,"product_type":"c1","uid":2172620,"ip_address":"","ucode":"26EE6BF8EB1611","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/picb3nrC6rX6t4t6pHP8huAyrBa9g4lXCsY0uz2OicZsVsCfyLRg523CTWxX5AfEptxCMEC9DMuLZcia1cwzawhmg/132","comment_is_top":false,"comment_ctime":1606449781,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606449781","product_id":100023901,"comment_content":"ä¹è§‚è¯»æ˜¯ä¸éœ€è¦è¿›è¡Œé‡Šæ”¾é”çš„ï¼Œåªæœ‰å‡çº§ä¸ºæ‚²è§‚è¯»é”æ—¶ï¼Œæ‰éœ€è¦è¿›è¡Œé”çš„é‡Šæ”¾ã€‚å¯ä»¥ç†è§£ä¸ºä¹è§‚è¯»å…¶å®æ²¡æœ‰åŠ é”ï¼Œç„¶åç”¨ç‰ˆæœ¬å·è¿›è¡Œäº†ä¸€æ¬¡æ¯”å¯¹ï¼Œç¡®å®šæ•°æ®åœ¨è¯»å–æ—¶æ²¡æœ‰æ›´æ”¹ï¼Œå¦åˆ™éœ€è¦åŠ ä¸Šæ‚²è§‚è¯»é”ï¼Œæ¥é˜»æ­¢åç»­çš„å†™æ“ä½œæˆ–ç­‰å¾…å·²ç»è·å–åˆ°å†™é”çš„å†™æ“ä½œå®Œæˆã€‚","like_count":0},{"had_liked":false,"id":260962,"user_name":"nssk","can_delete":false,"product_type":"c1","uid":1007266,"ip_address":"","ucode":"5839E5186900C6","user_header":"","comment_is_top":false,"comment_ctime":1605162300,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605162300","product_id":100023901,"comment_content":"ç±»ä¼¼äºä½¿ç”¨ç‰ˆæœ¬å·æ§åˆ¶ï¼Ÿ","like_count":0},{"had_liked":false,"id":243649,"user_name":"æ–œæœˆæµ®äº‘","can_delete":false,"product_type":"c1","uid":1008933,"ip_address":"","ucode":"25CECBB175DA02","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg","comment_is_top":false,"comment_ctime":1598240094,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1598240094","product_id":100023901,"comment_content":"è¯·é—®stamptedLockä¸æ”¯æŒé‡å…¥çš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿèƒ½è¯¦ç»†è¯´ä¸‹å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":230356,"user_name":"delete is create","can_delete":false,"product_type":"c1","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1593354495,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1593354495","product_id":100023901,"comment_content":"åœ¨é”å‡çº§çš„æ—¶å€™æ²¡æœ‰é‡Šæ”¾å†™é”<br>1. æŠŠå†™é”çš„wsèµ‹å€¼ç»™stamp<br>2. åœ¨finallyä¸­sl.unlock(ws) &#47;&#47;éœ€è¦æŠŠwsç§»åŠ¨åˆ°å¤–è¾¹ã€‚","like_count":0},{"had_liked":false,"id":230352,"user_name":"delete is create","can_delete":false,"product_type":"c1","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1593354090,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1593354090","product_id":100023901,"comment_content":"mysqlä¸­æ‰§è¡Œupdateçš„ä¸åŠ é”ä¹ˆï¼Ÿ","like_count":0},{"had_liked":false,"id":223802,"user_name":"å°å°ç±³","can_delete":false,"product_type":"c1","uid":2011501,"ip_address":"","ucode":"D2928A29154FBD","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoEcoSRAWRtibKK8RHPc7XibzcyGEfDsUFOXRJWtfd2u549Qa4KpicFNpeq16IqK2KSp9rkF2hrMXDLg/132","comment_is_top":false,"comment_ctime":1591183568,"is_pvip":false,"replies":[{"id":"82613","content":"è¿™ä¸ªä¾‹å­è¦çš„æ˜¯x,yä¿è¯ä¸€è‡´æ€§","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1591418320,"ip_address":"","comment_id":223802,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591183568","product_id":100023901,"comment_content":"return Math.sqrt( curX * curX + curY * curY);<br>åœ¨æ‰§è¡Œè¿™å¥çš„æ—¶å€™ï¼Œå› ä¸ºå·²ç»é‡Šæ”¾äº†æ‚²è§‚è¯»é”ï¼Œå˜é‡åˆè¢«å…¶ä»–çº¿ç¨‹æ”¹äº†æ€ä¹ˆåŠï¼Ÿæ˜¯ä¸æ˜¯åº”è¯¥æŠŠè¿™å¥ä¹Ÿæ”¾åœ¨tryå—é‡Œï¼Ÿè¯·è€å¸ˆè§£ç­”ã€‚","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497245,"discussion_content":"è¿™ä¸ªä¾‹å­è¦çš„æ˜¯x,yä¿è¯ä¸€è‡´æ€§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591418320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222662,"user_name":"Shane_ãƒŸæœ¨","can_delete":false,"product_type":"c1","uid":1537249,"ip_address":"","ucode":"01396B247CC8D8","user_header":"https://static001.geekbang.org/account/avatar/00/17/74/e1/623ff8d8.jpg","comment_is_top":false,"comment_ctime":1590884103,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1590884103","product_id":100023901,"comment_content":"è€å¸ˆï¼Œæˆ‘æœ‰ä¸ªç–‘é—®<br>è¯¾åé¢˜ä¸­ï¼Œè‹¥å‡çº§å†™é”å¤±è´¥ï¼Œè¯´æ˜æœ‰äººå†™è¿‡äº†ï¼Œè¿™æ—¶å€™ä¸åº”è¯¥é‡æ–°æ£€æŸ¥xyçš„å€¼å—ï¼Ÿä¸ºå•¥è¦elseé‡Šæ”¾è¯»é”è·å–å†™é”å‘¢ï¼Ÿé‚£å¦‚æœwhileæ£€æŸ¥è¿˜æ˜¯åˆå§‹å€¼ï¼Œè¿˜è¦å†å‡çº§å†™é”ï¼Ÿæ²¡æœ‰çœ‹æ‡‚ã€‚ã€‚","like_count":0,"discussions":[{"author":{"id":1367048,"avatar":"https://static001.geekbang.org/account/avatar/00/14/dc/08/64f5ab52.jpg","nickname":"é™ˆæ–Œ","note":"","ucode":"B639AB5F6AA03D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346833,"discussion_content":"å¦‚æœå‡çº§å¤±è´¥ï¼Œå°±é˜»å¡è·å–å†™é”ï¼Œä¸€ç›´åˆ°è·å–åˆ°å†™é”ä¹‹åï¼Œåœ¨å›åˆ°whileå¾ªç¯ä¸­æ£€æŸ¥xyå€¼æ˜¯å¦è¢«ä¿®æ”¹ï¼Œæ²¡è¢«ä¿®æ”¹å°±ç›´æ¥ç”¨è·å–åˆ°çš„å†™é”å‡çº§å†™é”ï¼ˆä¸€å®šä¼šæˆåŠŸï¼‰ï¼Œå†ç”¨æ–°çš„å†™é”ä¿®æ”¹xyï¼Œæœ€åfinally é‡Šæ”¾å†™é”ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612076826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1447904,"avatar":"https://static001.geekbang.org/account/avatar/00/16/17/e0/018a06cd.jpg","nickname":"RedHair","note":"","ucode":"9E68A6BC7C178E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304644,"discussion_content":"é—®é¢˜ä¸€ï¼šæœ‰äººå†™è¿‡äº†å°±å†™è¿‡äº†å‘—ï¼Œçœ‹é¢˜ç›®çš„æ„æ€åº”è¯¥æ˜¯ä¸€æ¬¡æ€§æ›´æ”¹ã€‚è§£é‡Šï¼šæ‚²è§‚è¯»é”ï¼Œå¯å¤šçº¿ç¨‹è·å–ï¼Œå› æ­¤ï¼Œå‡è®¾T1å’ŒT2çº¿ç¨‹åŒæ—¶è¿è¡Œåˆ°`long ws = sl.tryConvertToWriteLock(stamp);`, ç”±äºåªèƒ½ä¸€ä¸ªçº¿ç¨‹å‡çº§/è·å–åˆ°å†™é”ï¼Œè¿™æ—¶å‡è®¾T1è½¬æ¢å†™é”æˆåŠŸï¼ŒT2çº¿ç¨‹è½¬æ¢å¤±è´¥ï¼ŒT2é˜»å¡ï¼ŒT1å®Œæˆäº†xã€yçš„æ›´æ–°ï¼Œé‡Šæ”¾å†™é”ï¼ŒT2å”¤é†’åï¼Œèµ°äº†ä¸ªelseè¯­å¥ï¼Œç„¶åé‡æ–°è½¬æ¢å†™é”æˆåŠŸï¼Œæ›´æ–°xå’Œyçš„å€¼ï¼Œç»“æŸï¼›\né—®é¢˜äºŒå’Œé—®é¢˜ä¸‰ï¼šä¸å¤ªæ¸…æ¥šï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599633513,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222516,"user_name":"a(à¹‘â‰–à¸´Ù¼â‰–à¸´)âœŒ","can_delete":false,"product_type":"c1","uid":1392431,"ip_address":"","ucode":"AEF9B5CA1605DF","user_header":"https://static001.geekbang.org/account/avatar/00/15/3f/2f/8513c4d3.jpg","comment_is_top":false,"comment_ctime":1590825849,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1590825849","product_id":100023901,"comment_content":"å‡å¦‚æˆ‘åœ¨å†™çš„æ—¶å€™æ²¡åŠ é”ï¼Œæ˜¯ä¸æ˜¯ä¹è§‚è¯» å°±æ²¡æ³•åˆ¤æ–­stampæ˜¯å¦è¢«ä¿®æ”¹è¿‡å•Š","like_count":0},{"had_liked":false,"id":221265,"user_name":"innocent","can_delete":false,"product_type":"c1","uid":1197455,"ip_address":"","ucode":"368659A0DDE7E4","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/8f/a56b2214.jpg","comment_is_top":false,"comment_ctime":1590458680,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590458680","product_id":100023901,"comment_content":"          if (ws != 0L) {<br>            stamp = ws;<br>           x = newX;<br>           y = newY;<br>           break;<br>          }<br>æ¥è‡ªå®˜æ–¹ç¤ºä¾‹","like_count":0},{"had_liked":false,"id":211101,"user_name":"è§å—å±±","can_delete":false,"product_type":"c1","uid":1118111,"ip_address":"","ucode":"6A8BB82B7573CA","user_header":"https://static001.geekbang.org/account/avatar/00/11/0f/9f/f4b06bd5.jpg","comment_is_top":false,"comment_ctime":1587895951,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587895951","product_id":100023901,"comment_content":"è®°å½•ä¸‹:<br> StampedLockè¯»å†™é”éƒ½æ²¡æœ‰æ¡ä»¶å˜é‡;ä¸æ”¯æŒé‡å…¥;æ”¯æŒé”çš„å‡çº§å’Œé™çº§;åœ¨è¯»å†™é”é˜»å¡æ—¶ï¼Œè°ƒç”¨interruptä¼šå¯¼è‡´cpuå†²é«˜ã€‚æ€§èƒ½ä¼˜äºReadWriteLockçš„åŒºåˆ«åœ¨äºæä¾›çš„ä¹è§‚è¯»ã€‚<br>ReadWriteLockå†™é”æœ‰æ¡ä»¶å˜é‡ï¼Œè¯»é”æ²¡æœ‰;æ”¯æŒé‡å…¥;æ”¯æŒé”çš„é™çº§ï¼Œä¸æ”¯æŒé”çš„å‡çº§","like_count":0},{"had_liked":false,"id":199151,"user_name":"ğŸ˜œå“ˆå“ˆ","can_delete":false,"product_type":"c1","uid":1069001,"ip_address":"","ucode":"1FF58FB3A91135","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/c9/88837387.jpg","comment_is_top":false,"comment_ctime":1585480481,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1585480481","product_id":100023901,"comment_content":"é”å‡çº§ä¹‹åæ²¡æœ‰é‡Šæ”¾æœ€æ–°çš„å†™é”","like_count":0},{"had_liked":false,"id":188106,"user_name":"ä¸å°æ˜","can_delete":false,"product_type":"c1","uid":1207622,"ip_address":"","ucode":"CC23857B8D75D5","user_header":"https://static001.geekbang.org/account/avatar/00/12/6d/46/e16291f8.jpg","comment_is_top":false,"comment_ctime":1584321727,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584321727","product_id":100023901,"comment_content":"è€å¸ˆæˆ‘ä¸å¤ªæ˜ç™½ä¸ºä»€ä¹ˆè·å–ä¹è§‚é”ä¹‹åï¼Œåœ¨ä½¿ç”¨æ•°æ®å‰è¿˜è¦åœ¨åˆ¤æ–­ä¸€éæœ‰æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œé‚£å¦‚æœåˆ¤æ–­çš„æ—¶å€™ç¡®å®æ²¡æœ‰å…¶ä»–çº¿ç¨‹å†™ï¼Œä½†æ˜¯åˆ¤æ–­ä¹‹åå…¶ä»–çº¿ç¨‹å†™äº†å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":167371,"user_name":"Guess","can_delete":false,"product_type":"c1","uid":1113416,"ip_address":"","ucode":"E436F153183E25","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/48/241e16a8.jpg","comment_is_top":false,"comment_ctime":1577778345,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1577778345","product_id":100023901,"comment_content":"è€å¸ˆï¼ˆæˆ–å¤§ç‰›ï¼‰èƒ½ä¸èƒ½å¸®å¿™è§£æƒ‘<br>é—®é¢˜æ¥æºæ˜¯StampedLockå’ŒReadWriteLockçš„åŒºåˆ«<br>1. StampedLockä¸ºä»€ä¹ˆä¸æ”¯æŒçº¿ç¨‹é‡å…¥ï¼Ÿï¼ˆèƒ½ä¸èƒ½è§£é‡Šä¸€ä¸‹ï¼‰<br>2. StampedLockçš„æ‚²è§‚é”ã€å†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡ï¼Œè¿™ä¸ªæ¡ä»¶å˜é‡åœ¨ReadWriteLockæŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæ˜¯Conditionå—ï¼Ÿï¼‰<br>3. å¦‚æœçº¿ç¨‹é˜»å¡åœ¨StampedLockçš„readLock || writeLockæ­¤æ—¶è°ƒç”¨è¯¥çº¿ç¨‹çš„interrupt()æ–¹æ³•ä¼šå¯¼è‡´CPUé£™å‡ã€‚æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1447904,"avatar":"https://static001.geekbang.org/account/avatar/00/16/17/e0/018a06cd.jpg","nickname":"RedHair","note":"","ucode":"9E68A6BC7C178E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304646,"discussion_content":"1. æ²¡æœ‰reentrantæ‰“å¤´ï¼Œè¿™ä¸ªè®°å¿†ä¸€ä¸‹å°±è¡Œï¼›å¦‚æœçœŸæ„Ÿå…´è¶£ï¼Œé‚£æŸ¥çœ‹æºç å’Œåˆ«çš„åšå®¢ï¼Œåˆ†æå¯é‡å…¥çš„åˆ†æå’Œå®ç°ï¼›\n2. æ¡ä»¶å˜é‡ï¼Œæ˜¯ä½ è¯´çš„é‚£ä¸ªConditionï¼›\n3. è€å¸ˆå›å¤è¿‡ï¼šå†…éƒ¨å®ç°é‡Œwhileå¾ªç¯é‡Œé¢å¯¹ä¸­æ–­çš„å¤„ç†æœ‰ç‚¹é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599633738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164843,"user_name":"james","can_delete":false,"product_type":"c1","uid":1049208,"ip_address":"","ucode":"5701899403917C","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","comment_is_top":false,"comment_ctime":1577099061,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577099061","product_id":100023901,"comment_content":"è€å¸ˆ validate æˆåŠŸå æ‰§è¡ŒMath æ—¶å€™xå’Œyè¿˜æ˜¯ä¼šè¢«å…¶ä»–çº¿ç¨‹æ”¹äº†å•Š ï¼Œå’Œä¸validate æ²¡å•¥åŒºåˆ«å•Š ","like_count":0},{"had_liked":false,"id":147301,"user_name":"å¨","can_delete":false,"product_type":"c1","uid":1068542,"ip_address":"","ucode":"C921CDCB22B9A3","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/fe/882eaf0f.jpg","comment_is_top":false,"comment_ctime":1572856677,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572856677","product_id":100023901,"comment_content":"åœ¨distanceFromOriginæ–¹æ³•åé¢çš„éƒ¨åˆ†ï¼Œå½“åˆ¤æ–­å®Œä¹è§‚é”æ²¡è¢«ä¿®æ”¹è¿‡åå°±è°ƒç”¨return Math.sqrtï¼Œæ„Ÿè§‰è¿™é‡Œæ˜¯ä¸€ä¸ªcheck-than-actï¼Œä¸æ˜¯åŸå­çš„ï¼Œä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä¸çŸ¥é“æˆ‘ç†è§£æ˜¯å¦æ­£ç¡®","like_count":0},{"had_liked":false,"id":143422,"user_name":"ç§‹å¤©","can_delete":false,"product_type":"c1","uid":1057056,"ip_address":"","ucode":"A7E1D953EF7E17","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg","comment_is_top":false,"comment_ctime":1571707277,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1571707277","product_id":100023901,"comment_content":"ä½¿ç”¨ StampedLock ä¸€å®šä¸è¦è°ƒç”¨ä¸­æ–­æ“ä½œï¼Œå¦‚æœéœ€è¦...<br><br>","like_count":0},{"had_liked":false,"id":139463,"user_name":"ylw666","can_delete":false,"product_type":"c1","uid":1161301,"ip_address":"","ucode":"11BDAB1AF981B3","user_header":"https://static001.geekbang.org/account/avatar/00/11/b8/55/f982a2fb.jpg","comment_is_top":false,"comment_ctime":1570660737,"is_pvip":false,"replies":[{"id":"53773","content":"å¤§éƒ¨åˆ†é—®é¢˜æ•°æ®åº“éƒ½èƒ½è§£å†³ï¼Œè§£å†³ä¸äº†çš„ï¼ŒåŸºæœ¬ä¸Šå°±å¼€å§‹ä½“ç°ç¨‹åºå‘˜çš„ä»·å€¼äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1570663537,"ip_address":"","comment_id":139463,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1570660737","product_id":100023901,"comment_content":"è€å¸ˆå¥½ï¼Œå¯¹äºæ•°æ®åº“çš„ä¹è§‚è¯»é”çš„ä¾‹å­ï¼Œè™½ç„¶å¾ˆå·§å¦™ï¼Œä½†æœ‰ç‚¹ç–‘é—®ï¼Œé™¤éåº”ç”¨åœºæ™¯æ˜¯versionä¸å¯¹å°±ä¸å…è®¸updateï¼Œå¦‚æœåº”ç”¨åœºæ™¯åªæ˜¯äº’æ–¥å¹¶å‘çš„updateï¼Œæˆ‘è§‰å¾—åº”è¯¥åˆ©ç”¨æ•°æ®åº“è‡ªèº«ç‰¹æ€§å°±è¶³å¤Ÿï¼Œä¾‹å¦‚postgresqlä¸­updateè¯­å¥ä¼šé”è¡¨ï¼ˆhttp:&#47;&#47;www.postgres.cn&#47;docs&#47;10&#47;explicit-locking.html#LOCKING-TABLESï¼‰ï¼Œä¸å¤ªéœ€è¦æ‚¨è¯´çš„è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å®ç°å¹¶å‘çš„updateã€‚","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469959,"discussion_content":"å¤§éƒ¨åˆ†é—®é¢˜æ•°æ®åº“éƒ½èƒ½è§£å†³ï¼Œè§£å†³ä¸äº†çš„ï¼ŒåŸºæœ¬ä¸Šå°±å¼€å§‹ä½“ç°ç¨‹åºå‘˜çš„ä»·å€¼äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570663537,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136136,"user_name":"ä¸šä½™è‰","can_delete":false,"product_type":"c1","uid":1126538,"ip_address":"","ucode":"99BDC1E629049D","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg","comment_is_top":false,"comment_ctime":1569371911,"is_pvip":false,"replies":[{"id":"52411","content":"æŠ€æœ¯åªæœ‰åœ¨å®è·µä¸­æ‰èƒ½é”»ç‚¼å‡ºæ¥ï¼Œå†™ä¸šåŠ¡é€»è¾‘çš„ç¡®æœºä¼šå¾ˆå°‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1569496935,"ip_address":"","comment_id":136136,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1569371911","product_id":100023901,"comment_content":"æŒºå¥½çš„ä¸“æ ï¼Œä½†æ˜¯å¤§å¤šæ•°äººå†™ä¸šåŠ¡é€»è¾‘ç”¨ä¸åˆ°è¿™äº›æŠ€æœ¯ï¼","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468475,"discussion_content":"æŠ€æœ¯åªæœ‰åœ¨å®è·µä¸­æ‰èƒ½é”»ç‚¼å‡ºæ¥ï¼Œå†™ä¸šåŠ¡é€»è¾‘çš„ç¡®æœºä¼šå¾ˆå°‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569496935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114703,"user_name":"å°”å†¬æ©™","can_delete":false,"product_type":"c1","uid":1225224,"ip_address":"","ucode":"0B013A49BC18DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/08/92f42622.jpg","comment_is_top":false,"comment_ctime":1563367631,"is_pvip":false,"replies":[{"id":"41901","content":"çœ‹ä¸€ä¸‹tryConvertToWriteLock(stamp)çš„APIæ–‡æ¡£å§ï¼Œä¸»è¦æ˜¯çœ‹å®ƒçš„å‚æ•°å’Œè¿”å›å€¼çš„å…³ç³»","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1563405402,"ip_address":"","comment_id":114703,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563367631","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä¹è§‚è¯»å‡çº§ä¸ºæ‚²è§‚è¯»é”æ˜¯ï¼Œå¦‚æœå†™æ“ä½œè¿˜åœ¨è¿›è¡Œæ€ä¹ˆåŠï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458786,"discussion_content":"çœ‹ä¸€ä¸‹tryConvertToWriteLock(stamp)çš„APIæ–‡æ¡£å§ï¼Œä¸»è¦æ˜¯çœ‹å®ƒçš„å‚æ•°å’Œè¿”å›å€¼çš„å…³ç³»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563405402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114698,"user_name":"å°”å†¬æ©™","can_delete":false,"product_type":"c1","uid":1225224,"ip_address":"","ucode":"0B013A49BC18DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/08/92f42622.jpg","comment_is_top":false,"comment_ctime":1563366335,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1563366335","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä½ è®²çš„æ•°æ®åº“ä¹è§‚é”ä¾‹å­é‚£é‡Œæˆ‘æ²¡æ˜ç™½å“ªé‡Œä½“ç°&quot;ä¹è§‚&quot;äº†","like_count":0,"discussions":[{"author":{"id":1585829,"avatar":"https://static001.geekbang.org/account/avatar/00/18/32/a5/9868cd56.jpg","nickname":"southday","note":"","ucode":"4A8FB63D35F6E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4771,"discussion_content":"æˆ‘çš„ç†è§£ï¼Œâ€œä¹è§‚â€ï¼šæˆ‘ç›¸ä¿¡æ²¡äººä¼šåœ¨æˆ‘æ“ä½œçš„è¿‡ç¨‹ä¸­ä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥æˆ‘å…ˆä¸€é¡¿ç–¯ç‹‚è¾“å‡ºï¼Œæœ€åå†æ ¡éªŒæ•°æ®æ˜¯å¦æœ‰å¯èƒ½è¢«æ”¹äº†ï¼Œï¼ˆå…ˆæ“ä½œï¼Œå†æ ¡éªŒ => ä¹è§‚ï¼‰ï¼Œå¦‚æœæ•°æ®è¢«æ”¹äº†å°±å¾—æ”¾å¼ƒä¹‹å‰çš„æ“ä½œï¼Œé‡æ–°è·å–é”ï¼ˆå‡çº§ä¸ºæ‚²è§‚é”ï¼‰ï¼›â€œæ‚²è§‚â€ï¼šæˆ‘è§‰å¾—ä¸€å®šä¼šæœ‰äººåœ¨æˆ‘æ“ä½œçš„æ—¶å€™ä¿®æ”¹æ•°æ®ï¼Œä»¥é˜²ä¸‡ä¸€ï¼Œå…ˆæŠŠæ•°æ®é”ä½ï¼Œå†ä¿®æ”¹æ•°æ®ï¼Œï¼ˆå…ˆé”ï¼Œå†æ“ä½œ => æ‚²è§‚ï¼‰ã€‚â€œä¹è§‚â€é€‚ç”¨äºâ€œè¯»å¤šå†™å°‘â€çš„æƒ…å†µï¼Œå¦‚æœå°†â€œä¹è§‚â€ç”¨åœ¨â€œå†™å¤šâ€çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡æ“ä½œå®Œï¼Œå‘ç°æ•°æ®è¢«æ”¹è¿‡ï¼Œåˆå¾—æ”¾å¼ƒä¹‹å‰çš„æ“ä½œï¼Œä¸å…çš„æ•ˆç‡ä½ä¸‹ï¼Œè¿˜ä¸å¦‚ä¸€å¼€å§‹å°±å…ˆé”æ•°æ®ï¼ˆæ‚²è§‚é”","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1565709969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112069,"user_name":"VERITAS","can_delete":false,"product_type":"c1","uid":1214964,"ip_address":"","ucode":"CE1277145EDD6C","user_header":"https://static001.geekbang.org/account/avatar/00/12/89/f4/b3dacf1a.jpg","comment_is_top":false,"comment_ctime":1562664050,"is_pvip":true,"replies":[{"id":"40759","content":"jdkæºä»£ç æ³¨é‡Šé‡Œé¢éƒ½æœ‰","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1562675923,"ip_address":"","comment_id":112069,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562664050","product_id":100023901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œè¯·é—®å®˜æ–¹ç¤ºä¾‹URLæ˜¯å¤šå°‘ï¼Œæ²¡æœ‰æ‰¾åˆ°","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457560,"discussion_content":"jdkæºä»£ç æ³¨é‡Šé‡Œé¢éƒ½æœ‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562675923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100659,"user_name":"æ¸¡ç ","can_delete":false,"product_type":"c1","uid":1348536,"ip_address":"","ucode":"8FD8B863D1DA0C","user_header":"https://static001.geekbang.org/account/avatar/00/14/93/b8/6510592e.jpg","comment_is_top":false,"comment_ctime":1559611897,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559611897","product_id":100023901,"comment_content":"è¯·æ•™è€å¸ˆä¸€ä¸‹ï¼Œä¹è§‚è¯»å‡çº§æ‚²è§‚è¯»ä¸šåŠ¡ä¸Šæœ‰äº›ä¸ç†è§£ï¼Œå…¶å®å‡çº§å®Œä¹è§‚è¯»è¯»åˆ°æ•°æ®åè°ƒç”¨math.sqrtè¿™ä¸ªæ—¶å€™å…±äº«æ•°æ®ä»ç„¶è¢«æ”¹ã€‚æ—¢ç„¶æ•°æ®ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«æ”¹ä½•å¿…å¤šè¯»ä¸€æ¬¡ï¼Ÿ","like_count":0},{"had_liked":false,"id":98400,"user_name":"windcaller","can_delete":false,"product_type":"c1","uid":1514157,"ip_address":"","ucode":"1CA3E849805770","user_header":"https://static001.geekbang.org/account/avatar/00/17/1a/ad/faf1bf19.jpg","comment_is_top":false,"comment_ctime":1558982367,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558982367","product_id":100023901,"comment_content":"è§£é”å¯¹è±¡ä¸ä¸€è‡´ï¼Œä¸€å¼€å§‹è¯»é”æ˜¯ stamp åæ¥é”å‡çº§åæ˜¯ ws ã€‚ stampè§£é”äº†ï¼Œ ws å¹¶æ²¡æœ‰","like_count":0},{"had_liked":false,"id":96137,"user_name":"å°è¾‰è¾‰","can_delete":false,"product_type":"c1","uid":1189661,"ip_address":"","ucode":"9FF25E25C85350","user_header":"https://static001.geekbang.org/account/avatar/00/12/27/1d/1cb36854.jpg","comment_is_top":false,"comment_ctime":1558341424,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558341424","product_id":100023901,"comment_content":"æœ€è¿‘çš„é¡¹ç›®é‡Œé¢å°±ç”¨åˆ°è¿‡ä¹è§‚é”ï¼Œç”¨æ¥é˜²æ­¢å¹¶å‘æäº¤æ›´æ–°æ•°æ®ã€‚","like_count":0},{"had_liked":false,"id":88788,"user_name":"WuV1Up","can_delete":false,"product_type":"c1","uid":1285406,"ip_address":"","ucode":"2EC06B4F094FCC","user_header":"https://static001.geekbang.org/account/avatar/00/13/9d/1e/64c532c5.jpg","comment_is_top":false,"comment_ctime":1556000716,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556000716","product_id":100023901,"comment_content":"StampedLock ä½¿ç”¨æ³¨æ„äº‹é¡¹ è¿™ä¸ªå°èŠ‚çš„ä»£ç ï¼Œæˆ‘åœ¨æœ¬åœ°æœºå™¨æµ‹è¯•äº†ä¸‹ï¼ŒT2.interruptæ²¡æœ‰æŸä¸ªCPUåˆ°100%çš„ç°è±¡...  åªæ˜¯CPUç•¥å¾®å‡é«˜äº†ç‚¹ã€‚","like_count":0},{"had_liked":false,"id":87851,"user_name":"xiyuesmiling","can_delete":false,"product_type":"c1","uid":1221692,"ip_address":"","ucode":"2E5AD30B1470D5","user_header":"https://static001.geekbang.org/account/avatar/00/12/a4/3c/121e7f9f.jpg","comment_is_top":false,"comment_ctime":1555731673,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555731673","product_id":100023901,"comment_content":"è€å¸ˆï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹T1å’ŒT2å¦‚æœéƒ½è·å–è¯»é”ï¼ŒT1å…ˆå‡çº§å¤±è´¥è€Œé‡Šæ”¾è¯»é”ï¼Œå¹¶é˜»å¡åœ¨å†™é”ï¼›T2åœ¨1é‡Šæ”¾è¯»é”æ—¶å‡çº§é”æˆåŠŸå¹¶ä¸”æ–°å€¼æ˜¯0.0å’Œ0.0å³ä¸åŸæ¥ä¸€æ ·ï¼Œæœ€åé‡Šæ”¾å†™é”ï¼ŒT1åœ¨T2é‡Šæ”¾å†™é”ä¹‹åè·å–å†™é”ï¼Œä¸‹ä¸€ä¸ªå¾ªç¯T2è‡ªå·±åˆå°è¯•å°†å†™é”å‡çº§ä¸ºå†™é”ï¼Œè¿™å¯¼è‡´æ­»é”ï¼Ÿè¿˜æ˜¯ç›´æ¥å¼‚å¸¸äº†èµ°finallyå‘¢ï¼Ÿæ˜¯ä¸æ˜¯æˆ‘å“ªé‡Œç†è§£é”™äº†ï¼ŸğŸ˜¥","like_count":0},{"had_liked":false,"id":85696,"user_name":"å¼ æ´‹","can_delete":false,"product_type":"c1","uid":1182914,"ip_address":"","ucode":"549BE5DEEF8417","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/c2/bad34a50.jpg","comment_is_top":false,"comment_ctime":1555204172,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1555204172","product_id":100023901,"comment_content":"ç‹è€å¸ˆï¼Œç§’æ€çš„åœºæ™¯ä¸‹ å¯¹è®¢å•çš„æ•°é‡åŠ ä¹è§‚è¯»ã€‚ä¼šä¸ä¼šå‡ºç°æ•°æ®å®‰å…¨çš„é—®é¢˜å‘¢","like_count":0},{"had_liked":false,"id":85459,"user_name":"å†°æ¿€å‡Œçš„çœ¼æ³ª","can_delete":false,"product_type":"c1","uid":1087945,"ip_address":"","ucode":"5DCB974667E93A","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/c9/a7c77746.jpg","comment_is_top":false,"comment_ctime":1555064164,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555064164","product_id":100023901,"comment_content":"è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå‡å°‘äº†åŠ é”æ“ä½œï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡","like_count":0},{"had_liked":false,"id":84567,"user_name":"åŒ…å­","can_delete":false,"product_type":"c1","uid":1089345,"ip_address":"","ucode":"6CC4EBB8CD3924","user_header":"https://static001.geekbang.org/account/avatar/00/10/9f/41/82306dfe.jpg","comment_is_top":false,"comment_ctime":1554877299,"is_pvip":false,"replies":[{"id":"30450","content":"å¦‚æœåªæ˜¯å†™ï¼Œåªæ˜¯è¯»ï¼Œæ²¡æœ‰ä»»ä½•å…¶ä»–é€»è¾‘ï¼Œæ˜¯å¯ä»¥çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1554898609,"ip_address":"","comment_id":84567,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1554877299","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä¸€ç›´æœ‰ä¸ªé—®é¢˜æƒ³ä¸æ˜ç™½ï¼Œå°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡çš„è¯»å’Œå†™æ˜¯å¦ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚<br>æ–‡ç« ä¸­ä¸¾ä¾‹æ˜¯åŒæ—¶å¯¹xå’Œyè¿›è¡Œè¯»å†™æ“ä½œï¼Œé‚£xyçš„è¯»å†™ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°é”ã€‚<br>å¦‚æœæ˜¯å¯¹ä¸€ä¸ªå˜é‡xçš„è¯»å’Œå†™ï¼Œæˆ‘ä»¬å¯¹xåŠ volatileï¼Œä¿è¯å…¶å¤šçº¿ç¨‹çš„å¯è§æ€§æ˜¯ä¸æ˜¯å°±å¯ä»¥äº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446390,"discussion_content":"å¦‚æœåªæ˜¯å†™ï¼Œåªæ˜¯è¯»ï¼Œæ²¡æœ‰ä»»ä½•å…¶ä»–é€»è¾‘ï¼Œæ˜¯å¯ä»¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554898609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84207,"user_name":"ä¸€é“é˜³å…‰","can_delete":false,"product_type":"c1","uid":1239557,"ip_address":"","ucode":"F35207CCCEC6E2","user_header":"https://static001.geekbang.org/account/avatar/00/12/ea/05/c0d8014d.jpg","comment_is_top":false,"comment_ctime":1554803550,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554803550","product_id":100023901,"comment_content":"è€å¸ˆï¼šå¦‚æœçº¿ç¨‹èµ°äº†elseè·å–åˆ°è¯»é”ååˆè¿›å»å¾ªç¯é‡Œï¼Œç„¶åæ‰§è¡Œé”å‡çº§ï¼Œä¼šä¸ä¼šæŠ¥é”™ï¼Ÿ","like_count":0},{"had_liked":false,"id":84181,"user_name":"å¼ å¤©å±¹","can_delete":false,"product_type":"c1","uid":1477612,"ip_address":"","ucode":"8BD6BD6DCF0F4F","user_header":"https://static001.geekbang.org/account/avatar/00/16/8b/ec/dc03f5ad.jpg","comment_is_top":false,"comment_ctime":1554798861,"is_pvip":false,"replies":[{"id":"30393","content":"çœ‹æœ‰æ²¡æœ‰å¤šçº¿ç¨‹å…±äº«çš„å˜é‡ï¼Œæ²¡æœ‰å°±ä¸éœ€è¦ã€‚æ–‡ä¸­æ•°æ®åº“ä¹è§‚é”çš„ä¾‹å­ï¼Œæœ‰æ•°æ®åº“äº‹åŠ¡ä¹Ÿéœ€è¦ä¹è§‚é”ã€‚å…·ä½“é—®é¢˜å…·ä½“åˆ†æ<br>","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1554820153,"ip_address":"","comment_id":84181,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1554798861","product_id":100023901,"comment_content":"è¯´åˆ°æ•°æ®åº“ä¹è§‚é”ï¼Œæœ‰ä¸ªé—®é¢˜æƒ³è¯·æ•™è€å¸ˆï¼Œæ¯”å¦‚springä½¿ç”¨äº‹åŠ¡çš„æ—¶å€™ï¼Œåº•å±‚å°±å·²ç»ä½¿ç”¨äº†è¯»å†™ç›¸å…³çš„é”æ¥ä¿è¯å¹¶å‘äº†ï¼Œåœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­è¿˜éœ€è¦æ˜¾å¼çš„ä½¿ç”¨ä¹è§‚é”æœºåˆ¶æ¥ä¿è¯å¹¶å‘å®‰å…¨å—","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446270,"discussion_content":"çœ‹æœ‰æ²¡æœ‰å¤šçº¿ç¨‹å…±äº«çš„å˜é‡ï¼Œæ²¡æœ‰å°±ä¸éœ€è¦ã€‚æ–‡ä¸­æ•°æ®åº“ä¹è§‚é”çš„ä¾‹å­ï¼Œæœ‰æ•°æ®åº“äº‹åŠ¡ä¹Ÿéœ€è¦ä¹è§‚é”ã€‚å…·ä½“é—®é¢˜å…·ä½“åˆ†æ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554820153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84172,"user_name":"ZOUå¿—ä¼Ÿ","can_delete":false,"product_type":"c1","uid":1029179,"ip_address":"","ucode":"439779871CC992","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b4/3b/a1f7e3a4.jpg","comment_is_top":false,"comment_ctime":1554797545,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554797545","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä¸Šä¸€ç¯‡çš„ç¼“å­˜è·å–çš„ç”¨StampedLockçš„è¯»ä»£ç è¿™æ ·å†™å¯ä»¥å—ï¼Ÿ<br>public V get(K key) {<br>\t\t\tlong stamp = sl.tryOptimisticRead();<br>\t\t\tV value = map.get(key);<br>\t\t\tif (!sl.validate(stamp)) {<br>\t\t\t\tstamp = sl.readLock();<br>\t\t\t\ttry {<br>\t\t\t\t\tvalue = map.get(key);<br>\t\t\t\t} finally {<br>\t\t\t\t\tsl.unlock(stamp);<br>\t\t\t\t}<br>\t\t\t}<br>\t\t\treturn value;<br>\t\t}","like_count":0},{"had_liked":false,"id":84073,"user_name":"æ™“æ°","can_delete":false,"product_type":"c1","uid":1441546,"ip_address":"","ucode":"1174C88EEBF8A6","user_header":"https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg","comment_is_top":false,"comment_ctime":1554778389,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554778389","product_id":100023901,"comment_content":"s1è·å–å†™é”åæ²¡æœ‰é‡Šæ”¾ï¼Œå¯ä»¥åœ¨breakå‰é¢åŠ ä¸Šstamp=wsï¼Œä½¿å†™é”åœ¨finallyè¯­å¥å—è¿›è¡Œé‡Šæ”¾","like_count":0},{"had_liked":false,"id":84048,"user_name":"å¼ å¤©å±¹","can_delete":false,"product_type":"c1","uid":1477612,"ip_address":"","ucode":"8BD6BD6DCF0F4F","user_header":"https://static001.geekbang.org/account/avatar/00/16/8b/ec/dc03f5ad.jpg","comment_is_top":false,"comment_ctime":1554774380,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554774380","product_id":100023901,"comment_content":"ä¹è§‚é”çš„æœ¬è´¨æ˜¯å°½å¯èƒ½æ–­çš„ç¼©çŸ­äº’æ–¥çš„æ—¶é—´ï¼Œå³&lt;1&gt;è¯»&#47;è®¡ç®—&lt;2&gt;åˆ¤æ–­&lt;3&gt;æ›´æ–°ï¼Œåˆ¤æ–­å’Œæ›´æ–°å¿…é¡»æ˜¯åŸå­çš„ã€‚stampedLockçš„ä¹è§‚è¯»å’Œä¹è§‚é”çš„å…±æ€§åœ¨äºéƒ½é€šè¿‡ä¸€ä¸ªæ ‡è®°æ¥åˆ¤æ–­ï¼Œä½†æ˜¯åŒºåˆ«åœ¨äºä¹è§‚é”å› ä¸ºè¦å†™æ‰€ä»¥æœ‰ä¸€æ®µçœŸæ­£äº’æ–¥çš„æ—¶é—´ã€‚<br>æ¯”å¦‚æ•°æ®åº“ä¹è§‚é”çš„update-whereè¿™ä¸€åˆ¤æ–­å’Œæ›´æ–°æ“ä½œé€šè¿‡updateè¯­å¥çš„æ’ä»–é”ä¿è¯åŸå­æ€§<br>æ¯”å¦‚CASçš„åˆ¤æ–­æ›´æ–°æ“ä½œé€šè¿‡åº•å±‚çš„cpuæŒ‡ä»¤çš„åŸå­æ€§æ¥ä¿è¯<br>stampedLockçš„ä¹è§‚è¯»å› ä¸ºä¸ç”¨æ›´æ–°ï¼Œæ‰€ä»¥åªéœ€è¦åˆ¤æ–­ï¼Œå³ä¸ç”¨å®Œå…¨ä¿æŒäº’æ–¥ï¼Œæ‰€ä»¥è€å¸ˆæåˆ°çš„ä¹è§‚è¯»ä¸æ˜¯ä¹è§‚é”å¾ˆå‡†ç¡®","like_count":0},{"had_liked":false,"id":84038,"user_name":"å‘¨æ²»æ…§","can_delete":false,"product_type":"c1","uid":1335293,"ip_address":"","ucode":"7D56C4E66BEE17","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","comment_is_top":false,"comment_ctime":1554772547,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554772547","product_id":100023901,"comment_content":"å½“è¯»é”è½¬æˆå†™é”æˆåŠŸåï¼Œå¯¹åº”çš„é‡Šæ”¾é”çš„stampä¸å¯¹ï¼Œéœ€è¦å†ifå¤„ç†å®Œå˜é‡åbreakä¹‹å‰å¯¹stampé‡è¯»èµ‹å€¼æˆws","like_count":0},{"had_liked":false,"id":84032,"user_name":"å›å“¥èŠæŠ€æœ¯","can_delete":false,"product_type":"c1","uid":1325816,"ip_address":"","ucode":"2C9A22BCE4C79E","user_header":"https://static001.geekbang.org/account/avatar/00/14/3a/f8/c1a939e7.jpg","comment_is_top":false,"comment_ctime":1554771513,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1554771513","product_id":100023901,"comment_content":"elseé‡Œé¢é‡Šæ”¾è¯»é”ï¼Œå¢åŠ å†™é”ï¼Œç„¶åå›åˆ°å¾ªç¯å¼€å§‹å†å‡çº§å†™é”ã€‚<br>è€å¸ˆï¼Œbugæ˜¯ä¸æ˜¯åœ¨è¿™å„¿å•Šï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1600341,"avatar":"https://static001.geekbang.org/account/avatar/00/18/6b/55/2b0f219b.jpg","nickname":"Geek_42f729","note":"","ucode":"76CFFF9DEDDF96","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555360,"discussion_content":"ä¸æ˜¯\n\n1. å‡çº§ä¸ºå†™é”è¿”å›çš„stampå¦‚æœç­‰äº0åˆ™è¯´æ˜è·å–é”å¤±è´¥ï¼Œå°±ä¼šè¿›å…¥elseé€»è¾‘ï¼›\n\n2. elseé€»è¾‘é‡Œä¼šå†æ¬¡å°è¯•è·å–å†™é”ï¼Œç›´åˆ°è·å–æˆåŠŸï¼›\n\n3. elseè·å–å†™é”æˆåŠŸåé‡æ–°è¿›å…¥whileï¼Œå¹¶è°ƒç”¨tryConvertToWriteLockæ–¹æ³•å‡çº§ä¸ºå†™é”ï¼ˆå¦‚æœstampå·²ç»æŒæœ‰å†™é”åˆ™ç›´æ¥è¿”å›è¿™ä¸ªå†™é”-è¿”å›çš„stampä¸ç­‰äº0ï¼‰ï¼›\n\nè¿™é‡Œçš„bugæ˜¯ï¼šlong ws = sl.tryConvertToWriteLock(stamp)  æ–°è·å–çš„wsæ²¡æœ‰é‡Šæ”¾","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646881926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83968,"user_name":"æ‰›ç€é”„å¤´é—¯æ±Ÿæ¹–","can_delete":false,"product_type":"c1","uid":1225243,"ip_address":"","ucode":"F2A2793EC8F1E6","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/1b/947dfcb8.jpg","comment_is_top":false,"comment_ctime":1554740607,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554740607","product_id":100023901,"comment_content":"å…ˆæ‰“ä¸ªå¡","like_count":0}]}