{"id":233615,"title":"29 | 双重保障：为应用设置不同级别的双向TLS","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":275584,"user_name":"Geek_b70b14","can_delete":false,"product_type":"c3","uid":2184195,"ip_address":"","ucode":"B6B47589E77BCF","user_header":"","comment_is_top":false,"comment_ctime":1611590102,"is_pvip":false,"replies":[{"id":100097,"content":"1. 可以通过 istioctl pc secret &lt;pod name&gt; -o json 查看\n2. 1.5之后SDS服务默认开启，会自动管理证书。如果你要在mesh内部手动挂载证书可能需要关闭sds（但这个需求很奇怪，mesh内部应该是可信的）；如果你是指在gateway层面的，参考https:&#47;&#47;istio.io&#47;latest&#47;docs&#47;tasks&#47;traffic-management&#47;ingress&#47;secure-ingress&#47;","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1611716612,"ip_address":"","comment_id":275584,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"请问老师enable mtls后, client pod sleep和server pod httpbin会相互认证各自证书, 但在实际部署中在sleep和httpbin pod中没有找到各自证书.\n1.请问老师enable mtls后 workload的证书在哪里能看到, 是在某个secret么?\n2.workload的证书是会rotation生成, 想问下如何修改使得生成的workload证书加密算法是SHA384和3072bit长度, 我看官网只能用openssl修改生成CA证书的算法(修改下官网给的生成CA的配置文件即可), 但是之后部署istio和httpbin发现生成的workload证书又变成2048bit和SHA256长度了. 参考:https:&#47;&#47;istio.io&#47;latest&#47;docs&#47;tasks&#47;security&#47;cert-management&#47;plugin-ca-cert&#47;, 如何操作修改生成的workload证书算法长度.\n非常感谢!!!","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514405,"discussion_content":"1. 可以通过 istioctl pc secret &amp;lt;pod name&amp;gt; -o json 查看\n2. 1.5之后SDS服务默认开启，会自动管理证书。如果你要在mesh内部手动挂载证书可能需要关闭sds（但这个需求很奇怪，mesh内部应该是可信的）；如果你是指在gateway层面的，参考https://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611716612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269060,"user_name":"吴承祖","can_delete":false,"product_type":"c3","uid":1199747,"ip_address":"","ucode":"8E7DD23FE18E34","user_header":"https://static001.geekbang.org/account/avatar/00/12/4e/83/5338bd77.jpg","comment_is_top":false,"comment_ctime":1608513661,"is_pvip":false,"replies":[{"id":97632,"content":"没错，一般内部系统都是可信的，不需要mTLS。不过不排除有这样的需求，比如你的系统要和财务等更高安全要求的系统对接。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1608560730,"ip_address":"","comment_id":269060,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"应用间内部为什么一般需要用双向呢，是不是太影响性能了，集群内部应该跟外部网络是隔离的吧，感觉不用任何加密也没问题呀","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512130,"discussion_content":"没错，一般内部系统都是可信的，不需要mTLS。不过不排除有这样的需求，比如你的系统要和财务等更高安全要求的系统对接。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608560730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1199747,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4e/83/5338bd77.jpg","nickname":"吴承祖","note":"","ucode":"8E7DD23FE18E34","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336383,"discussion_content":"明白了，感谢老师的解答~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608560848,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232536,"user_name":"Geek_66dcc6","can_delete":false,"product_type":"c3","uid":1317851,"ip_address":"","ucode":"0EC9C087C5008B","user_header":"","comment_is_top":false,"comment_ctime":1594030365,"is_pvip":false,"replies":[{"id":86071,"content":"在destinationrule先关闭tls看一下，tls:  mode: DISABLE\n\n也可以进入调用服务的envoy的log看看什么日志，必要的话可以开debug模式看","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1594281745,"ip_address":"","comment_id":232536,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，我本地用nodeport 的方式安装istio：安装命令如下：\nistioctl install --set addonComponents.grafana.enabled=true  --set addonComponents.kiali.enabled=true  --set addonComponents.tracing.enabled=true  --set values.global.jwtPolicy=first-party-jwt\n安装好后，我想看下ingressgw 的外部访问情况，用第一节示例中的bookinfo 的例子，访问 http:&#47;&#47;xxx&#47;productpage\n在ingressgw 的log 中是下面的log：\nTLS error: 67108971:RSA routines:OPENSSL_internal:BLOCK_TYPE_IS_NOT_01 67109000:RSA routines:OPENSSL_internal:PADDING_CHECK_FAILED 184549382:X.509 certificate routines:OPENSSL_internal:public key routines 268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED&quot; 0 91 35 - &quot;172.28.32.124&quot; &quot;Mozilla&#47;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#47;537.36 (KHTML, like Gecko) Chrome&#47;75.0.3770.100 Safari&#47;537.36&quot; &quot;f7650949-8a7f-4fef-8e73-a45be023622c&quot; &quot;172.28.32.124:31937&quot; &quot;10.42.1.14:9080&quot; outbound|9080||productpage.default.svc.cluster.local - 10.42.1.33:80 172.28.32.124:51684 - -\n\n这个是tls 的问题吗？该怎么解决这个问题呢","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500683,"discussion_content":"在destinationrule先关闭tls看一下，tls:  mode: DISABLE\n\n也可以进入调用服务的envoy的log看看什么日志，必要的话可以开debug模式看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594281745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":224171,"user_name":"xyz","can_delete":false,"product_type":"c3","uid":1592979,"ip_address":"","ucode":"DDDE99420E8047","user_header":"https://static001.geekbang.org/account/avatar/00/18/4e/93/b947574c.jpg","comment_is_top":false,"comment_ctime":1591295108,"is_pvip":false,"replies":[{"id":82572,"content":"双向一般用于应用内部的服务之间通信，毕竟速度要慢","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1591335560,"ip_address":"","comment_id":224171,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"29课 双向mtls使用场景能讲一下吗  按说mtls是加密访问的  比如我购买一个云厂商的k8s集群，然后发布应用，如果不使用mtls，有什么安全隐患呢，能举例说一下吗","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497386,"discussion_content":"双向一般用于应用内部的服务之间通信，毕竟速度要慢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591335560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1592979,"avatar":"https://static001.geekbang.org/account/avatar/00/18/4e/93/b947574c.jpg","nickname":"xyz","note":"","ucode":"DDDE99420E8047","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":279385,"discussion_content":"对 会变慢 那什么情况下才需要呢  能举个例子吗 就是我在阿里云买了一个k8s集群 这种情况下 如果我的k8s应用没有tls有什么安全隐患 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591338116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333609,"user_name":"Geek_8094b4","can_delete":false,"product_type":"c3","uid":1285973,"ip_address":"","ucode":"A77F2700462D9D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKNQSsGIYDDMjtT1YRRMItob6gStfzCh5ib7Ql6tT0Q4KdDdwtBeEZvtQAhNgrNCIa9BicwLUzezUTg/132","comment_is_top":false,"comment_ctime":1644422003,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"Mts为啥不是通过HTTPs访问？","like_count":0}]}