{"id":741815,"title":"14ï½œå¤šåº”ç”¨æ”¯æŒï¼šæ‹†åˆ†Contextã€BootStrapä¸è·¯ç”±è½¬å‘","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniTomcatã€‚</p><p>ä¸ŠèŠ‚è¯¾æˆ‘ä»¬æ–°å¢äº†<strong>è¿‡æ»¤å™¨Filterå’Œç›‘å¬å™¨Listener</strong>ã€‚åˆ©ç”¨è¿‡æ»¤å™¨ï¼Œå¯¹æ¯ä¸€å±‚çš„å¯¹è±¡ä¾æ¬¡è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆæ„å»ºå‡ºè¯·æ±‚å¯¹è±¡å’Œè¿”å›å¯¹è±¡ï¼›è€Œç›‘å¬å™¨çš„å­˜åœ¨ï¼Œåˆ™æ˜¯ä¸ºäº†é…åˆæˆ‘ä»¬ç›®å‰å·²æœ‰çš„Containerã€Sessionç­‰æœºåˆ¶ï¼Œé€šè¿‡ç›‘å¬ç›¸å…³çš„äº‹ä»¶ï¼Œæ¯”å¦‚å¯åŠ¨ã€è¶…æ—¶ã€ç»“æŸç­‰ï¼Œæ›´å¥½åœ°å¯¹æœåŠ¡å™¨è¿›è¡Œç®¡ç†ã€‚</p><p>ç›®å‰æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼Œéƒ½å†™åœ¨/webrootç›®å½•ä¸‹ï¼Œä½†å¦‚æœæœ‰ä¸åŒçš„åº”ç”¨ï¼Œé‚£å°±éƒ½æ··åˆåœ¨åŒä¸€è·¯å¾„ä¸‹äº†ï¼Œè¿™æ ·ä¸åˆ©äºç®¡ç†ã€‚æ‰€ä»¥è¿™èŠ‚è¯¾æˆ‘ä»¬è¿›ä¸€æ­¥è€ƒè™‘<strong>æ”¯æŒå¤šè·¯ç”±çš„è½¬å‘</strong>ï¼Œé€šè¿‡è·¯å¾„çš„åŒºåˆ†ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒåº”ç”¨ä¹‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå¼•å…¥<strong>Context</strong>è¿™ä¸ªæ¦‚å¿µæ¥å®ç°åº”ç”¨çš„ç›¸äº’éš”ç¦»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2c/b7/2c646316dc669f18ef13998bc56065b7.png?wh=1920x1119\" alt=\"å›¾ç‰‡\"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œç”¨æˆ·åœ¨urlä¸­åˆ†åˆ«è¾“å…¥è·¯å¾„hello/å’Œanother/ï¼Œè¿™å°±ä»£è¡¨äº†ä¸¤ä¸ªä¸åŒçš„contextï¼Œä»¥æ­¤è·¯å¾„åˆ†åˆ«å®šä½äºä¸åŒçš„åº”ç”¨ä¸­ã€‚</p><p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å†ä¼˜åŒ–Bootstrapï¼Œå»é™¤å¤šä½™çš„åŠŸèƒ½ï¼Œç¡®ä¿å®ƒåªæ˜¯ä¸€ä¸ªå¯åŠ¨å™¨ï¼Œè´¯å½»å„å¸å…¶èŒçš„è®¾è®¡ç†å¿µã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥åŠ¨æ‰‹å®ç°ã€‚</p><h2>é¡¹ç›®ç»“æ„</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬ä¸»è¦æ–°å¢äº†StandardHostã€StandardHostValveï¼Œä»¥åŠWebappClassClassLoaderç±»ã€‚è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å˜åŒ–æ˜¯åœ¨/webrootç›®å½•ä¸‹æ–°å¢app1å’Œapp2ç›®å½•ï¼Œç”¨æ¥åŒºåˆ†ä¸åŒçš„åº”ç”¨ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹æ”¹åŠ¨åçš„é¡¹ç›®ç»“æ„ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-plain\">MiniTomcat\nâ”œâ”€ src\nâ”‚  â”œâ”€ main\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ com\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ minit\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ connector\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ http\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ DefaultHeaders.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpConnector.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpHeader.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestImpl.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestLine.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponseImpl.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ SocketInputStream.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StatisResourceProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponseFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ core\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ApplicationFilterChain.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ApplicationFilterConfig.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerBase.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerListenerDef.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ FilterDef.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ FilterMap.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardContext.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardContextValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardHost.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardHostValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardPipeline.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardWrapper.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardWrapperValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ WebappClassLoader.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ logger\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ Constants.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ FileLogger.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ LoggerBase.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ SystemErrLogger.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ SystemOutLogger.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ session\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardSession.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardSessionFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ startup\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ BootStrap.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ util\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ CookieTools.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StringManager.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ URLDecoder.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ valves\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ AccessLogValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ValveBase.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Connector.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Container.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerEvent.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Context.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ InstanceEvent.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ InstanceListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Logger.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Pipeline.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Request.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Response.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Session.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ SessionEvent.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ SessionListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Valve.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ValveContext.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Wrapper.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ TestFilter.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ TestListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ TestServlet.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”œâ”€ webroot\nâ”‚  â”œâ”€ app1\nâ”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”‚  â”‚  â”œâ”€ TestFilter.class\nâ”‚  â”‚  â”‚  â”œâ”€ TestListener.class\nâ”‚  â”‚  â”‚  â”œâ”€ TestServlet.class\nâ”‚  â”‚  â”œâ”€ hello.txt\nâ”‚  â”œâ”€ app2\nâ”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”‚  â”‚  â”œâ”€ TestFilter.class\nâ”‚  â”‚  â”‚  â”œâ”€ TestListener.class\nâ”‚  â”‚  â”‚  â”œâ”€ TestServlet.class\nâ”‚  â”‚  â”œâ”€ hello.txt\nâ”œâ”€ pom.xml\n</code></pre><h2>å¼•å…¥å¤šåº”ç”¨</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æ­£å¼è¿›è¡Œå¤šåº”ç”¨çš„æ”¹é€ ï¼Œåœ¨æ”¹é€ å‰æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„ClassLoaderâ€”â€”WebappClassLoaderï¼Œä¸ºåç»­åº”ç”¨æ‹†åˆ†ä»¥åŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨åšå‡†å¤‡ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹WebappClassLoaderçš„å®šä¹‰ã€‚</p><pre><code class=\"language-java\">package com.minit.core;\npublic class WebappClassLoader {\n    ClassLoader classLoader;\n    String path;\n    String docbase;\n    Container container;\n    public Container getContainer() {\n        return container;\n    }\n    public void setContainer(Container container) {\n        this.container = container;\n    }\n    public String getPath() {\n        return path;\n    }\n    public void setPath(String path) {\n        this.path = path;\n    }\n    public String getDocbase() {\n        return docbase;\n    }\n    public void setDocbase(String docbase) {\n        this.docbase = docbase;\n    }\n    public WebappClassLoader() {\n    }\n    public ClassLoader getClassLoader() {\n        return classLoader;\n    }\n    public String getInfo() {\n        return \"A simple loader\";\n    }\n    public void addRepository(String repository) {\n    }\n    public String[] findRepositories() {\n        return null;\n    }\n    public synchronized void start() {\n        System.out.println(\"Starting WebappLoader\");\n        try {\n            // åˆ›å»ºä¸€ä¸ª URLClassLoader\n            URL[] urls = new URL[1];\n            URLStreamHandler streamHandler = null;\n            File classPath = new File(System.getProperty(\"minit.base\"));\n            String repository = (new URL(\"file\", null, classPath.getCanonicalPath() + File.separator)).toString() ;\n            if (docbase!=null &amp;&amp; !docbase.equals(\"\")) {\n                repository = repository + docbase + File.separator;\n            }\n            urls[0] = new URL(null, repository, streamHandler);\n            System.out.println(\"Webapp classloader Repository : \"+repository);\n            classLoader = new URLClassLoader(urls);\n        }\n        catch (Exception e) {\n            System.out.println(e.toString() );\n        }\n    }\n    public void stop() {\n    }\n}\n</code></pre><p>ä»ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªWebappClassLoaderä¸»è¦åŒ…å«äº†å‡ ä¸ªè¦ç´ ï¼šclassLoaderã€docBaseã€containerã€‚è¿™ä¸ªclassLoaderå…¶å®å°±æ˜¯ä¸€ä¸ªURLClassLoaderï¼Œå®ƒçš„å·¥ä½œç›®å½•ç”±docBaseæ¥å†³å®šã€‚</p><p>è¦å®ç°é¡¹ç›®ä¸­/webrootç›®å½•ä¸‹çš„å¤šåº”ç”¨è§£æï¼Œåœ¨æˆ‘ä»¬çš„å®ç°é‡Œï¼Œå…¶å®å¯¹ä½¿ç”¨è€…è€Œè¨€å°±ç›¸å½“äºç›®å½•ä¸Šå¤šäº†ä¸€ä¸ªContextå±‚çº§ï¼Œæ¯”å¦‚è¯·æ±‚ <code>http://localhost:8080/app1/servlet/test.TestServlet</code>ï¼Œä¸»æœºåœ°å€åé¢çš„app1å°±æ˜¯contextï¼Œè¿™æ ·å¯ä»¥æœ‰ä¸¤ä¸ªç‰ˆæœ¬ä¸ä¸€æ ·çš„test.TestServletï¼Œæ¯”å¦‚è¯´å¦ä¸€ä¸ªçš„è¯·æ±‚åœ°å€ä¸º <code>http://localhost:8080/app2/servlet/test.TestServlet</code>ã€‚</p><p>æˆ‘ä»¬éœ€è¦åˆ©ç”¨åˆ°çš„ï¼Œæ­£æ˜¯åˆšåˆšæˆ‘ä»¬å®šä¹‰çš„WebappClassLoaderï¼Œç”±å®ƒæ¥åŠ è½½åº”ç”¨é‡Œçš„å®¢æˆ·ç±»ã€‚æ¯ä¸€ä¸ªWebappClassLoaderéƒ½æœ‰ä¸€ä¸ªdocBaseï¼Œæ¯”å¦‚ä¾‹å­é‡Œçš„app1æˆ–è€…app2ï¼Œä¹Ÿå°±æ˜¯contextçš„ç›®å½•ã€‚æ¯ä¸€ä¸ªcontextéƒ½å¯¹åº”ä¸€ä¸ªä¸åŒçš„WebappClassLoaderï¼Œæ ¹æ®Javaç±»çš„ç®¡ç†æœºåˆ¶ï¼Œ<strong>è¿™äº›ä¸åŒçš„classloaderä¹‹é—´æ˜¯<strong><strong>äº’ç›¸</strong></strong>éš”ç¦»çš„ï¼Œæ‰€ä»¥è¿™äº›contextä»£è¡¨çš„åº”ç”¨ä¹‹é—´ä¹Ÿå°±æ˜¯äº’ç›¸éš”ç¦»çš„</strong>ï¼Œè¿™å°±è¾¾åˆ°äº†æˆ‘ä»¬çš„ç›®çš„ã€‚</p><p>Javaçš„è¿™ä¸ªæœºåˆ¶æ˜¯ï¼šä¸åŒclassloaderåŠ è½½çš„ç±»åœ¨JVMçœ‹æ¥æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ï¼Œå› ä¸º<strong>åœ¨JVMé‡Œä¸€ä¸ªç±»çš„å”¯ä¸€æ ‡è¯†æ˜¯classloader+ç±»å</strong>ã€‚é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å°±èƒ½å¤Ÿå®ç°ç±»ä¹‹é—´çš„éš”ç¦»ï¼Œç”šè‡³å¯ä»¥åŒæ—¶åŠ è½½æŸä¸ªç±»çš„ä¸¤ä¸ªä¸åŒç‰ˆæœ¬ã€‚</p><p>æˆ‘ä»¬ç»“åˆå›¾ç¤ºæ¥çœ‹ä¸€ä¸‹Tomcaté€šè¿‡Contextè¾¾åˆ°åº”ç”¨éš”ç¦»çš„åŸç†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/81/48/81c30e57bf4511120f9ca9ba6dd71048.png?wh=1920x1244\" alt=\"å›¾ç‰‡\"></p><p>è€Œæ•´ä¸ªæœåŠ¡å™¨çš„æ ¹å·¥ä½œç›®å½•å­˜æ”¾åœ¨ <code>System.getProperty(\"minit.base\")</code> é‡Œï¼Œè¿™ä¸ªpropertyæ˜¯BootStrapå¯åŠ¨æ—¶æŒ‡å®šçš„ï¼Œæ‰€ä»¥åœ¨BootStrapä¸­æˆ‘ä»¬è¦å®šä¹‰ <code>System.setProperty(\"minit.base\", WEB_ROOT);</code>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœMinitæ”¾åœ¨d:/minitç›®å½•ä¸‹ï¼Œé‚£ä¹ˆWEB_ROOTç›®å½•ä¸ºd:/minit/webrootï¼Œè€Œapp1çš„webclassloaderçš„docbaseæ˜¯app1, é‚£ä¹ˆå®ƒåŠ è½½çš„ç›®å½•å°±æ˜¯d:/minit/webroot/app1/ã€‚</p><h2>æ–°çš„URIè§£æ</h2><p>æœ‰äº†ä¸Šé¢çš„WebappClassLoaderä½œä¸ºåŸºç¡€ï¼Œæˆ‘ä»¬å†æ¥ç®¡ç†åç«¯åº”ç”¨ç¨‹åºï¼Œä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œå½“ä»–åœ¨å®¢æˆ·ç«¯è¾“å…¥çš„URLæ˜¯ <code>http://localhost:8080/app1/servlet/test.TestServlet</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦ä¿®æ”¹è§£æURLçš„ç¨‹åºï¼Œéœ€è¦æŠŠURIè§£ææˆ/servlet/test.TestServletçš„è¿™éƒ¨åˆ†ï¼Œä¿®æ”¹æˆ/app1/servlet/test.TestServletï¼Œè¿™æ ·å°±èƒ½è¯†åˆ«å‡ºè¿™ä¸ªservletæ˜¯å“ªä¸€ä¸ªcontextä¸‹çš„äº†ã€‚</p><p>è¿™ä¸ªæ­¥éª¤çš„å®ç°ï¼Œæˆ‘ä»¬æ”¾åœ¨HttpRequestImpl.parseRequestLine()è¿™ä¸ªæ–¹æ³•ä¸­è°ƒæ•´ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“è°ƒæ•´çš„æ ¸å¿ƒä»£ç ã€‚</p><pre><code class=\"language-java\">//get context from uri\nint contextslash = uri.indexOf(\"/\", 1);\nif (contextslash != -1) {\n    this.docbase = uri.substring(1, contextslash);\n    uri = uri.substring(contextslash);\n}\n</code></pre><p>å…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æŒ‰ç…§å­—ç¬¦ä¸²åˆ†éš”ç¬¦æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚ä½ å†æ¥çœ‹å®Œæ•´çš„parseRequestLine()æ–¹æ³•ï¼Œåœ¨ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ä¸­éƒ½å¢åŠ äº†è§£æå®ç°ã€‚</p><pre><code class=\"language-java\">package com.minit.connector.http;\npublic class HttpRequestImpl implements HttpServletRequest, Request {\n    String docbase;\n    public String getDocbase() {\n        return docbase;\n    }\n    public void setDocbase(String docbase) {\n        this.docbase = docbase;\n    }\n\n    private void parseRequestLine() {\n        int question = requestLine.indexOf(\"?\");\n        if (question &gt;= 0) {\n            queryString = new String(requestLine.uri, question + 1, requestLine.uriEnd - question - 1);\n            uri = new String(requestLine.uri, 0, question);\n            String tmp = \";\" + DefaultHeaders.JSESSIONID_NAME + \"=\";\n            int semicolon = uri.indexOf(tmp);\n            if (semicolon &gt;= 0) {\n                sessionid = uri.substring(semicolon+tmp.length());\n                uri = uri.substring(0, semicolon);\n            }\n            int contextslash = uri.indexOf(\"/\", 1);\n            if (contextslash != -1) {\n                this.docbase = uri.substring(1, contextslash);\n                uri = uri.substring(contextslash);\n            }\n        } else {\n            queryString = null;\n            uri = new String(requestLine.uri, 0, requestLine.uriEnd);\n            String tmp = \";\" + DefaultHeaders.JSESSIONID_NAME + \"=\";\n            int semicolon = uri.indexOf(tmp);\n            if (semicolon &gt;= 0) {\n                sessionid = uri.substring(semicolon+tmp.length());\n                uri = uri.substring(0, semicolon);\n            }\n            int contextslash = uri.indexOf(\"/\", 1);\n            if (contextslash != -1) {\n                this.docbase = uri.substring(1, contextslash);\n                uri = uri.substring(contextslash);\n            }\n        }\n    }\n}\n</code></pre><p>åˆ°è¿™é‡Œå¤šåº”ç”¨çš„æ”¹é€ å°±å‘Šä¸€æ®µè½äº†ã€‚</p><h2>ç‹¬ç«‹æœåŠ¡å™¨Host</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜è¦ç»§ç»­ç²¾ç®€å¯åŠ¨ç±»çš„å·¥ä½œï¼Œç›®å‰å¯åŠ¨ç±»BootStrapé‡Œï¼Œå·²ç»é›†æˆäº†ç›‘å¬å™¨å’Œè¿‡æ»¤å™¨çš„å¯åŠ¨å·¥ä½œï¼Œå…¶å®è¿™äº›éƒ½æ˜¯æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬è¦è¿›ä¸€æ­¥ç®€åŒ–ã€‚æˆ‘ä»¬çš„æ€è·¯æ˜¯æŠŠBootStrapä»…ä»…å½“æˆä¸€ä¸ªæœåŠ¡å™¨çš„å¯åŠ¨å™¨ï¼Œå®ƒæœ¬èº«ä¸æ˜¯æœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå°±è¦æŠŠæœåŠ¡å™¨çš„åŠŸèƒ½ä»£ç ä»BootStrapä¸­æŠ½åˆ°ä¸€ä¸ªæœåŠ¡å™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ç°æœåŠ¡å™¨çš„ä»£ç å®šä¹‰åœ¨StandardHostç±»é‡Œé¢ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ä»£ç ã€‚</p><pre><code class=\"language-java\">package com.minit.core;\npublic class StandardHost extends ContainerBase{\n    HttpConnector connector = null;\n    //hostä¸­ç”¨ä¸€ä¸ªmapå­˜å‚¨äº†æ‰€ç®¡ç†çš„contextï¼Œä¸€ä¸ªcontextä»£è¡¨äº†ä¸€ä¸ªç‹¬ç«‹çš„webåº”ç”¨\n    Map&lt;String,StandardContext&gt; contextMap = new ConcurrentHashMap&lt;&gt;();//contextName - servletContext\n    //ä¸‹é¢çš„listeneræ˜¯hostæœ¬èº«çš„ç›‘å¬\n    private ArrayList&lt;ContainerListenerDef&gt; listenerDefs = new ArrayList&lt;&gt;();\n    private ArrayList&lt;ContainerListener&gt; listeners = new ArrayList&lt;&gt;();\n    public StandardHost(){\n        super();\n        pipeline.setBasic(new StandardHostValve());\n        log(\"Host created.\");\n    }\n    public String getInfo() {\n        return \"Minit host, vesion 0.1\";\n    }\n    public HttpConnector getConnector() {\n        return connector;\n    }\n    public void setConnector(HttpConnector connector) {\n        this.connector = connector;\n    }\n    public void invoke(Request request, Response response)\n            throws IOException, ServletException {\n        System.out.println(\"StandardHost invoke()\");\n        super.invoke(request, response);\n    }\n    //ä»hostä¸­æ ¹æ®contextå(è·¯å¾„å)æ‰¾åˆ°å¯¹åº”çš„context\n    //å¦‚æœæ‰¾ä¸åˆ°å°±æ–°å»ºä¸€ä¸ªcontext\n    public StandardContext getContext(String name){\n        StandardContext context = contextMap.get(name);\n        if ( context == null) {\n            //åˆ›å»ºæ–°çš„contextï¼Œæœ‰è‡ªå·±ç‹¬ç«‹çš„æ ¹ç›®å½•å’Œç±»åŠ è½½å™¨\n            context = new StandardContext();\n            context.setDocBase(name);\n            context.setConnector(connector);\n            WebappClassLoader loader = new WebappClassLoader();\n            context.setLoader(loader);\n            loader.start();\n            this.contextMap.put(name, context);\n        }\n        return context;\n    }\n    //hostçš„å¯åŠ¨æ–¹æ³•ï¼Œç°åœ¨æ²¡æœ‰åšä»€ä¹ˆäº‹æƒ…ï¼Œä»…ä»…æ˜¯å¯ç”¨ç›‘å¬å™¨\n    //åœ¨MiniTomcatä¸­ï¼ŒHostæ˜¯ä¸€ä¸ªæç®€åŒ–çš„å½¢æ€\n    public void start(){\n        fireContainerEvent(\"Host Started\",this);\n        Logger logger = new FileLogger();\n        setLogger(logger);\n        ContainerListenerDef listenerDef = new ContainerListenerDef();\n        listenerDef.setListenerName(\"TestListener\");\n        listenerDef.setListenerClass(\"test.TestListener\");\n        addListenerDef(listenerDef);\n        listenerStart();\n    }\n    public void addContainerListener(ContainerListener listener) {\n        synchronized (listeners) {\n            listeners.add(listener);\n        }\n    }\n    public void removeContainerListener(ContainerListener listener) {\n        synchronized (listeners) {\n            listeners.remove(listener);\n        }\n    }\n    public void fireContainerEvent(String type, Object data) {\n        if (listeners.size() &lt; 1)\n            return;\n        ContainerEvent event = new ContainerEvent(this, type, data);\n        ContainerListener list[] = new ContainerListener[0];\n        synchronized (listeners) {\n            list = (ContainerListener[]) listeners.toArray(list);\n        }\n        for (int i = 0; i &lt; list.length; i++)\n            ((ContainerListener) list[i]).containerEvent(event);\n    }\n    public void addListenerDef(ContainerListenerDef listenererDef) {\n        synchronized (listenerDefs) {\n            listenerDefs.add(listenererDef);\n        }\n    }\n    //åˆå§‹åŒ–ç›‘å¬å™¨\n    public boolean listenerStart() {\n        System.out.println(\"Listener Start..........\");\n        boolean ok = true;\n        synchronized (listeners) {\n            listeners.clear();\n            Iterator&lt;ContainerListenerDef&gt; defs = listenerDefs.iterator();\n            while (defs.hasNext()) {\n                ContainerListenerDef def = defs.next();\n                ContainerListener listener = null;\n                try {\n                    // Identify the class loader we will be using\n                    String listenerClass = def.getListenerClass();\n                    WebappClassLoader classLoader = null;\n                    //hostå¯¹åº”çš„loaderå°±æ˜¯listenerçš„loader\n                    classLoader = this.getLoader();\n                    ClassLoader oldCtxClassLoader =\n                            Thread.currentThread().getContextClassLoader();\n                    // Instantiate a new instance of this filter and return it\n                    Class&lt;?&gt; clazz = classLoader.getClassLoader().loadClass(listenerClass);\n                    listener = (ContainerListener) clazz.newInstance();\n                    addContainerListener(listener);\n                } catch (Throwable t) {\n                    t.printStackTrace();\n                    ok = false;\n                }\n            }\n        }\n        return (ok);\n    }\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ–°åŠ çš„è¿™ä¸ªStandardHosté‡Œé¢åŒ…å«äº†ä¸€ä¸ªconnectorå’Œä¸‹ä¸€çº§å®¹å™¨Contextï¼Œå¦å¤–Listenerä¹Ÿç”±StandardHostæ¥å¯åŠ¨ã€‚Hostæœ¬èº«ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå¤§çš„å®¹å™¨ï¼ŒæŒ‰ç…§Tomcatçš„åšæ³•ï¼Œç›¸åº”åœ°å®šä¹‰Valveã€‚</p><pre><code class=\"language-java\">package com.minit.core;\npublic class StandardHostValve extends ValveBase{\n    @Override\n    public void invoke(Request request, Response response, ValveContext context) throws IOException, ServletException {\n        System.out.println(\"StandardHostValve invoke()\");\n        String docbase = ((HttpRequestImpl)request).getDocbase();\n        System.out.println(\"StandardHostValve invoke getdocbase : \" + docbase);\n        StandardHost host = (StandardHost)getContainer();\n        StandardContext servletContext = host.getContext(docbase);\n        try {\n            servletContext.invoke(request, response);\n        }\n        catch (Exception e) {\n            System.out.println(e.toString());\n        }\n        catch (Throwable e) {\n            System.out.println(e.toString());\n        }\n    }\n}\n</code></pre><p>é€šè¿‡StandardHostç±»æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè®¸å¤šä»¥å‰åœ¨å¯åŠ¨ç±»ä¸­çš„ä»£ç éƒ½ç§»åˆ°è¿™ä¸ªç±»é‡Œäº†ã€‚è¿‡æ»¤å™¨çš„å¯åŠ¨è¢«åˆ’åœ¨filterStartæ–¹æ³•é‡Œäº†ï¼Œè€Œç›‘å¬å™¨çš„å¯åŠ¨åˆ™ç”±listenerStartæ–¹æ³•è´Ÿè´£ï¼Œåœ¨è°ƒç”¨StandardHostç±»ä¸­çš„startæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠBootStrapä¸­ä¸€å¤§æ®µæœåŠ¡å™¨åŠŸèƒ½çš„å®ç°ï¼Œæ›¿æ¢æˆä½¿ç”¨Hostï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹æ›¿æ¢åçš„mainæ–¹æ³•ã€‚</p><pre><code class=\"language-java\">public static void main(String[] args) {\n    if (debug &gt;= 1)\n        log(\".... startup ....\");\n    System.setProperty(\"minit.base\", WEB_ROOT);\n    HttpConnector connector = new HttpConnector();\n    StandardHost container = new StandardHost();\n    WebappClassLoader loader = new WebappClassLoader();\n    container.setLoader(loader);\n    loader.start();\n    connector.setContainer(container);\n    container.setConnector(connector);\n    container.start();\n    connector.start();\n}\n</code></pre><p>è¿™ä¸ªæ—¶å€™StandardHostçš„startæ–¹æ³•å·²ç»æŠŠä¹‹å‰çš„å¯åŠ¨ä»£ç éƒ½æ¶µç›–äº†ã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªBootStrapç°åœ¨å¾ˆç®€å•ï¼ŒçœŸçš„åªæ˜¯ä¸€ä¸ªå¯åŠ¨å™¨ã€‚</p><h2>æµ‹è¯•</h2><p>åœ¨è¿™èŠ‚è¯¾çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å…ˆæŠŠåŸæ¥/webrootç›®å½•ä¸‹çš„æ–‡ä»¶å…¨éƒ¨ç§»åŠ¨åˆ°/webroot/app1é‡Œï¼Œéšåæˆ‘ä»¬ä¿®æ”¹TestServletï¼Œäººä¸ºåœ°é€ å‡ºä¸¤ä¸ªä¸åŒçš„åº”ç”¨ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹TestServletä¿®æ”¹åçš„ä»£ç ã€‚</p><pre><code class=\"language-java\">package test;\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport javax.servlet.http.HttpSession;\nimport java.io.IOException;\npublic class TestServlet extends HttpServlet{\n    static int count = 0;\n    private static final long serialVersionUID = 1L;\n    @Override\n    public void doGet(HttpServletRequest request, HttpServletResponse response)throws ServletException, IOException {\n        System.out.println(\"Another TestServlet Enter doGet()\");\n        System.out.println(\"Another TestServlet  parameter name : \"+request.getParameter(\"name\"));\n        TestServlet.count++;\n        System.out.println(\"::::::::Another TestServlet call count ::::::::: \" + TestServlet.count);\n        if (TestServlet.count&gt;2) {\n            response.addHeader(\"Connection\", \"close\");\n        }\n        HttpSession session = request.getSession(true);\n        String user = (String) session.getAttribute(\"user\");\n        System.out.println(\"get user from session : \" + user);\n        if (user == null || user.equals(\"\")) {\n            session.setAttribute(\"user\", \"yale\");\n        }\n\n        response.setCharacterEncoding(\"UTF-8\");\n        String doc = \"&lt;!DOCTYPE html&gt; \\n\" +\n                \"&lt;html&gt;\\n\" +\n                \"&lt;head&gt;&lt;meta charset=\\\"utf-8\\\"&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;\\n\"+\n                \"&lt;body bgcolor=\\\"#f0f0f0\\\"&gt;\\n\" +\n                \"&lt;h1 align=\\\"center\\\"&gt;\" + \"Test ä½ å¥½\" + \"&lt;/h1&gt;\\n\";\n        System.out.println(doc);\n        response.getWriter().println(doc);\n    }\n    public void doPost(HttpServletRequest request, HttpServletResponse response)throws ServletException, IOException {\n        System.out.println(\"Enter doGet()\");\n        System.out.println(\"parameter name : \"+request.getParameter(\"name\"));\n        response.setCharacterEncoding(\"UTF-8\");\n        String doc = \"&lt;!DOCTYPE html&gt; \\n\" +\n                \"&lt;html&gt;\\n\" +\n                \"&lt;head&gt;&lt;meta charset=\\\"utf-8\\\"&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;\\n\"+\n                \"&lt;body bgcolor=\\\"#f0f0f0\\\"&gt;\\n\" +\n                \"&lt;h1 align=\\\"center\\\"&gt;\" + \"Test ä½ å¥½\" + \"&lt;/h1&gt;\\n\";\n        System.out.println(doc);\n        response.getWriter().println(doc);\n    }\n}\n</code></pre><p>ä¸»è¦åœ¨äºè¾“å‡ºçš„æ—¥å¿—ä¸åŒï¼Œä¿®æ”¹åç”¨äº†â€œAnother TestServletâ€çš„æ ‡è¯†ï¼Œå°†ä¿®æ”¹åçš„TestServletå•ç‹¬ç¼–è¯‘ï¼Œå‚è€ƒå‰é¢çš„æ­¥éª¤æŠŠè¿™äº›æ–‡ä»¶æ”¾å…¥/webroot/app2é‡Œï¼Œç”¨æ¥åŒºåˆ†ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯¹ä¸¤ä¸ªåº”ç”¨çš„åœºæ™¯è¿›è¡Œæ¨¡æ‹Ÿæµ‹è¯•ã€‚</p><p>æœ€åè¿˜æœ‰ä¸ªå°è°ƒæ•´ï¼Œä¹‹å‰æˆ‘ä»¬åœ¨HttpProcessorçš„process(Socket socket)æ–¹æ³•ä¸­é€šè¿‡Headerå¤´Connectionï¼šCloseåˆ¤æ–­æ˜¯å¦è¦å…³é—­é•¿è¿æ¥ï¼Œç°åœ¨ç®€åŒ–ä¸€ä¸‹ï¼Œç›´æ¥å…³é—­ã€‚</p><pre><code class=\"language-plain\">//if (\"close\".equals(response.getHeader(\"Connection\"))) {\n    keepAlive = false;\n//}\n</code></pre><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬æ–°å¢äº†å¤šåº”ç”¨çš„æ”¯æŒï¼Œæ”¯æŒå¤šè·¯ç”±è½¬å‘ï¼Œé€šè¿‡è·¯å¾„çš„åŒºåˆ†ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒåº”ç”¨ä¹‹ä¸­ã€‚æ¯”å¦‚ç”¨æˆ·åœ¨å®¢æˆ·ç«¯è¾“å…¥åœ°å€ <code>http://address:port/app1/testservlet</code>ï¼Œè¿™ä¸ªurlä¸­ï¼Œapp1å°†å®šä½åˆ°æŸä¸ªåº”ç”¨contextï¼Œtestservletå°†å®šä½åˆ°å…·ä½“çš„æŸä¸ªç¨‹åºã€‚è¿™é‡Œçš„app1/ç›®å½•å°±æ¡†å®šäº†ä¸€ä¸ªåº”ç”¨ï¼Œä¸‹é¢çš„å„ä¸ªç¨‹åºéƒ½æ˜¯åœ¨app1åº”ç”¨ä¸‹è¿è¡Œçš„ã€‚è€Œapp2/ç›®å½•å°±ä»£è¡¨äº†å¦ä¸€ä¸ªåº”ç”¨ã€‚</p><p>å¤šä¸ªåº”ç”¨ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œä½†é‡Œé¢å¯ä»¥æœ‰åŒåçš„ç¨‹åºï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆåŒºåˆ†çš„å‘¢ï¼Ÿè¿™é‡Œåˆ©ç”¨äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„WebappClassLoaderå¯¹é€šç”¨çš„ClassLoaderè¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œå®ç°äº†åº”ç”¨ä¹‹é—´çš„ç›¸äº’éš”ç¦»ï¼Œå¹¶ä¸ºæ¥ä¸‹æ¥çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ‰“ä¸‹äº†åŸºç¡€ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åˆç»§ç»­ä¼˜åŒ–äº†Bootstrapï¼Œå»é™¤äº†å¤šä½™çš„åŠŸèƒ½ï¼Œç¡®ä¿å®ƒåªæ˜¯ä¸€ä¸ªå¯åŠ¨å™¨ã€‚</p><p>è¿™èŠ‚è¯¾ä»£ç å‚è§ï¼š<a href=\"https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter14\">https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter14</a></p><h2>æ€è€ƒé¢˜</h2><p>å­¦å®Œäº†è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šå¯¹äºä¸€ä¸ªå®Œæ•´çš„urlï¼Œæ¯”å¦‚ <code>http://address:port/context/servlet</code>ï¼Œå®ƒçš„æ¯ä¸€éƒ¨åˆ†æ˜¯å¦‚ä½•ä¸Tomcatçš„åŸºæœ¬æ¦‚å¿µå¯¹åº”çš„ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ çš„ç­”æ¡ˆåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":387759,"user_name":"Twein","can_delete":false,"product_type":"c1","uid":1309882,"ip_address":"æµ·å—","ucode":"83498605A39292","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/1G2rlRgNalXbcUnHibRNMibAeHQhWoKNl4e4EgkiawDynZZiaO4W3vSSMtlYEKrt6e7GW4mcu1sjcs7bGKjl0vRhWQ/132","comment_is_top":false,"comment_ctime":1708520119,"is_pvip":false,"replies":[{"id":141265,"content":"æ”¾åˆ°Contexté‡Œé¢çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1708823457,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":387759,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è€å¸ˆï¼Œä¸Šæ¡ç•™è¨€è¯´é”™äº†ï¼Œåº”è¯¥æ˜¯hostçš„startæ–¹æ³•æ²¡æœ‰å¯åŠ¨è¿‡æ»¤å™¨çš„ä»£ç ï¼Œæºç å°‘äº†è¿™å—é€»è¾‘","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":637690,"discussion_content":"æ”¾åˆ°Contexté‡Œé¢çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1708823457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386842,"user_name":"Geek_50a5cc","can_delete":false,"product_type":"c1","uid":1786951,"ip_address":"åŒ—äº¬","ucode":"0F6C1C2552261F","user_header":"","comment_is_top":false,"comment_ctime":1705653162,"is_pvip":false,"replies":[{"id":141017,"content":"è¦åå¤ç¢ç£¨ã€‚å†æ¬¡çœ‹çš„æ—¶å€™ï¼Œä¸è¦æ²‰æµ¸åœ¨ç»†èŠ‚ï¼Œä¸»è¦ç†è§£ç»“æ„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705701093,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386842,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"æ„Ÿè§‰ä¸€è·¯è·Ÿè¿‡æ¥ï¼Œå¥½å¤šæ¦‚å¿µæœ‰ç‚¹æ¨¡ç³Šäº†ï¼Œæœ‰ç©ºå›å¤´å†çœ‹çœ‹","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636153,"discussion_content":"è¦åå¤ç¢ç£¨ã€‚å†æ¬¡çœ‹çš„æ—¶å€™ï¼Œä¸è¦æ²‰æµ¸åœ¨ç»†èŠ‚ï¼Œä¸»è¦ç†è§£ç»“æ„ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1705701093,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386589,"user_name":"HHğŸ·ğŸ ","can_delete":false,"product_type":"c1","uid":1133678,"ip_address":"å¹¿ä¸œ","ucode":"C50172BDA604D5","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","comment_is_top":false,"comment_ctime":1705149550,"is_pvip":false,"replies":[{"id":140974,"content":"address:portå¯¹åº”hostï¼Œhttpå¯¹åº”connectoråè®®å¤„ç†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705401575,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386589,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"http:&#47;&#47;address:port&#47;context&#47;servlet\nä»ä¸€ä¸ªæ•´ä½“å‡ºå‘ï¼Œurl --&gt; HttpRequest,  context --&gt; StandardHost, servlet --&gt; StandardWrapper,  å½“ç„¶èƒŒåè¿˜æœ‰æ¶‰åŠ HttpHeaderã€Filter ç­‰ç­‰","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635958,"discussion_content":"address:portå¯¹åº”hostï¼Œhttpå¯¹åº”connectoråè®®å¤„ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705401575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386393,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1704762829,"is_pvip":false,"replies":[{"id":140992,"content":"Q1ï¼Œæ˜¯çš„ï¼Œä¸åŒçš„åº”ç”¨æœ‰ä¸€ä¸ªä¸åŒçš„ç±»åŠ è½½å™¨å¯¹åº”ï¼Œè¿™ä¹ˆè®¾è®¡æ˜¯Tomcatçš„ç‰¹æ€§æ‰€è¦æ±‚çš„ã€‚å› ä¸ºTomcatæ˜¯ä¸€ä¸ªåº”ç”¨æœåŠ¡å™¨ï¼Œå®ƒéœ€è¦åšåˆ°åº”ç”¨ä¹‹é—´çš„éš”ç¦»ã€‚\nQ2ï¼Œå¯¹ï¼Œåé¢æˆ‘æ”¹æˆäº†webappsç›®å½•ï¼Œè¿™æ ·èƒ½æ›´å¥½åœ°ä¸Tomcatè¿è¡Œæ—¶å¯¹åº”ä¸Šã€‚\nQ3ï¼Œå¯ä»¥åŠ è½½åŒä¸€ä¸ªç±»ï¼Œå› ä¸ºç”¨äº†ä¸åŒçš„classloaderã€‚\nQ4ï¼ŒWebappClasLoaderé‡Œé¢åŒ…å«äº†ä¸€ä¸ªURLClassLoader\nQ5ï¼Œæ‰€æœ‰Gitub&#47;Giteeä¸Šçš„ä»£ç éƒ½æ˜¯å¯ä»¥è¿è¡Œçš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705446682,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386393,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š\nQ1ï¼šä¸åŒåº”ç”¨å¯¹åº”ä¸åŒçš„åŠ è½½ç±»å—ï¼Ÿï¼Ÿ\næœ¬æ–‡ä¸­æœ‰è¿™æ ·ä¸€å¥è¯â€œæ¯ä¸€ä¸ª context éƒ½å¯¹åº”ä¸€ä¸ªä¸åŒçš„ WebappClassLoaderâ€ï¼Œå¯¹äºåŠ è½½ç±»ï¼Œæ˜¯ä¸åŒçš„å®ä¾‹ï¼Ÿè¿˜æ˜¯ä¸åŒçš„ç±»ï¼Ÿ\næ¯”å¦‚context1å’Œcontext2ï¼Œç†è§£1ï¼šcontext1å¯¹åº”WebappClassLoaderAï¼›context2å¯¹åº”WebappClassLoaderBï¼Œæ˜¯ä¸åŒçš„ç±»ã€‚\nç†è§£2ï¼šcontext1å¯¹åº”WebappClassLoaderçš„å®ä¾‹1ï¼›context2å¯¹åº”WebappClassLoaderçš„å®ä¾‹2ï¼Œå³åŒä¸€ä¸ªç±»çš„ä¸åŒå®ä¾‹ã€‚\nQ2ï¼šwebrootç›®å½•ä¸‹çš„æµ‹è¯•ä»£ç ï¼Œåœ¨å®é™…çš„Tomcatä¸­å°±æ˜¯å…·ä½“çš„webåº”ç”¨ï¼Œå¯¹å—ï¼Ÿ\nQ3ï¼šä¸€ä¸ªåº”ç”¨ä¸­ï¼Œä¸¤ä¸ªClassLoaderå¯ä»¥åŠ è½½åŒä¸€ä¸ªç±»(ç‰ˆæœ¬ä¹Ÿç›¸åŒ)å—ï¼Ÿ\nQ4ï¼šWebappClassLoaderä¸éœ€è¦ç»§æ‰¿å·²æœ‰çš„æ¥å£æˆ–æ–¹æ³•å—ï¼Ÿ\nWebappClassLoaderç®—æ˜¯è‡ªå®šä¹‰ClassLoaderå§ã€‚è®°å¾—ä»¥å‰çœ‹è¿‡å…³äºè‡ªå®šä¹‰ClassLoaderçš„æ–‡ç« ï¼Œå¥½åƒè¦ç»§æ‰¿ç³»ç»Ÿå·²æœ‰çš„æ¥å£æˆ–æ–¹æ³•ï¼Œå°±æ˜¯è¯´è¦å’Œå·²æœ‰çš„ä¸œè¥¿å»ºç«‹è”ç³»ã€‚ä½†æœ¬è¯¾ä¸­çš„WebappClassLoaderæ˜¯ä¸ªå•ç‹¬çš„ç±»ï¼Œå¹¶æ— ç»§æ‰¿ã€‚\nQ5ï¼šè¿è¡Œåæ‰¾ä¸åˆ°ç±»ï¼ŒæŠ¥é”™ï¼š\njava.lang.ClassNotFoundException: test.TestListener\n(StandardHost.java:120)\n&#47;&#47; Instantiate a new instance of this filter and return it\n                    Class&lt;?&gt; clazz = classLoader.getClassLoader().loadClass(listenerClass);\nè¿˜æ²¡æœ‰è°ƒè¯•ã€‚è€å¸ˆé‚£è¾¹èƒ½æ­£å¸¸è¿è¡Œå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635989,"discussion_content":"Q1ï¼Œæ˜¯çš„ï¼Œä¸åŒçš„åº”ç”¨æœ‰ä¸€ä¸ªä¸åŒçš„ç±»åŠ è½½å™¨å¯¹åº”ï¼Œè¿™ä¹ˆè®¾è®¡æ˜¯Tomcatçš„ç‰¹æ€§æ‰€è¦æ±‚çš„ã€‚å› ä¸ºTomcatæ˜¯ä¸€ä¸ªåº”ç”¨æœåŠ¡å™¨ï¼Œå®ƒéœ€è¦åšåˆ°åº”ç”¨ä¹‹é—´çš„éš”ç¦»ã€‚\nQ2ï¼Œå¯¹ï¼Œåé¢æˆ‘æ”¹æˆäº†webappsç›®å½•ï¼Œè¿™æ ·èƒ½æ›´å¥½åœ°ä¸Tomcatè¿è¡Œæ—¶å¯¹åº”ä¸Šã€‚\nQ3ï¼Œå¯ä»¥åŠ è½½åŒä¸€ä¸ªç±»ï¼Œå› ä¸ºç”¨äº†ä¸åŒçš„classloaderã€‚\nQ4ï¼ŒWebappClasLoaderé‡Œé¢åŒ…å«äº†ä¸€ä¸ªURLClassLoader\nQ5ï¼Œæ‰€æœ‰Gitub/Giteeä¸Šçš„ä»£ç éƒ½æ˜¯å¯ä»¥è¿è¡Œçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705446683,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1572356,"avatar":"https://static001.geekbang.org/account/avatar/00/17/fe/04/bb427e47.jpg","nickname":"ç å“¥å­—èŠ‚","note":"","ucode":"362103AD52C8E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":653174,"discussion_content":"Q5ç¡®å®æŠ¥é”™äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1730365392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":393694,"user_name":"æ¯›ç«¹","can_delete":false,"product_type":"c1","uid":1987536,"ip_address":"åŒ—äº¬","ucode":"893C87E32AA5AA","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/H6US70MyQlXGVIzSbrgdTiasc0mbJS503AJG9tuGwXL0cLTBmp1ib2yLQ7HeA8BKUX12TKHvgaDS3JfiacmuBBO4w/132","comment_is_top":false,"comment_ctime":1724635303,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"host  startä»£ç é‡Œå¯ç”¨listenerStart è¯»çš„è·¯å¾„æ˜¯ test.TestListener, æœ¬ç« é¡¹ç›®è·¯å¾„é‡Œå¹¶ä¸å­˜åœ¨è¿™ä¸ªè·¯å¾„","like_count":0},{"had_liked":false,"id":392642,"user_name":"silentyears","can_delete":false,"product_type":"c1","uid":1061748,"ip_address":"åŒ—äº¬","ucode":"6E137BFEB874CA","user_header":"https://static001.geekbang.org/account/avatar/00/10/33/74/d9d143fa.jpg","comment_is_top":false,"comment_ctime":1721376020,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"standardContext$start()éƒ½æ²¡æœ‰ä»»ä½•åœ°æ–¹è°ƒç”¨å§","like_count":0}]}