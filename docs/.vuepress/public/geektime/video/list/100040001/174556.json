{"id":174556,"title":"16 | 文档模型设计之二：工况细化","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-mongodb-course\">https://gitee.com/geektime-geekbang/geektime-mongodb-course</a></p>","comments":[{"had_liked":false,"id":159820,"user_name":"奕","can_delete":false,"product_type":"c3","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1575799938,"is_pvip":false,"replies":[{"id":62986,"content":"无法工作了","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577189925,"ip_address":"","comment_id":159820,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"如果被$lookup关联的表分片了，是不是只查询和主表在一个分区的数据了？","like_count":4,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477184,"discussion_content":"无法工作了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577189925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175917,"user_name":"kylexy_0817","can_delete":false,"product_type":"c3","uid":1068372,"ip_address":"","ucode":"392DD9DD5E4B6E","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/54/9c214885.jpg","comment_is_top":false,"comment_ctime":1580885777,"is_pvip":false,"replies":[{"id":68552,"content":"头像图片文件，如果只是几十KB那样，完全可以直接放在JSON里面。除非是大到数个MB，就建议分开存放了。\n\n至于是否文件系统，有别的考量了。文件系统不容易扩展，量达到亿&#47;十亿级别管理会很麻烦。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1581090609,"ip_address":"","comment_id":175917,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师，想问下头像图片文件，不是应该直接文件系统，数据库中只存链接吗？","like_count":2,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482952,"discussion_content":"头像图片文件，如果只是几十KB那样，完全可以直接放在JSON里面。除非是大到数个MB，就建议分开存放了。\n\n至于是否文件系统，有别的考量了。文件系统不容易扩展，量达到亿/十亿级别管理会很麻烦。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581090609,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214004,"user_name":"butterfly","can_delete":false,"product_type":"c3","uid":1392924,"ip_address":"","ucode":"1B724973303FB0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/rRCSdTPyqWcW6U8DO9xL55ictNPlbQ38VAcaBNgibqaAhcH7mn1W9ddxIJLlMiaA5sngBicMX02w2HP5pAWpBAJsag/132","comment_is_top":false,"comment_ctime":1588614598,"is_pvip":false,"replies":[{"id":80142,"content":"如果我是你，我会选择的是保留JSON格式，但是只留group_id字段。这样的话你只需要更新业务代码，不用停服务更新数据库。然后你可以写个语句把JSON字段里面的其他字段删除掉。整个过程都是线上操作，也不会有不一致数据问题。\n\n如果是你的方案，就是彻底改变一个内嵌字段的类型，那就必须要写个脚本，然后最好是停止业务的访问，进行对数据库数据的修改。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1589319224,"ip_address":"","comment_id":214004,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师您好， 关于这一节我想请教下，在开发中我们的需求或者模型是变化的。比如这一节的group_ids对象类型，刚开始的时候是 json对象的数组，后面把这个抽出来使用单独的集合时候，group_ids对象类型变成了 整形数组. 这个变化会有一个开发和上线的一个过程，这里有没有什么好的最佳实践，谢谢老师.\n这个变化，在上线的时候，\n1：是需要再单独写一个脚本去清洗数据的吗？ \n2.  在清洗的时候, mongodb使用的是raft，是CP模型吗？这样的话，服务会暂时的对外不可用吗？？是否会存在像mysql5.6之前的版本处理DML时进行锁表的问题","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493927,"discussion_content":"如果我是你，我会选择的是保留JSON格式，但是只留group_id字段。这样的话你只需要更新业务代码，不用停服务更新数据库。然后你可以写个语句把JSON字段里面的其他字段删除掉。整个过程都是线上操作，也不会有不一致数据问题。\n\n如果是你的方案，就是彻底改变一个内嵌字段的类型，那就必须要写个脚本，然后最好是停止业务的访问，进行对数据库数据的修改。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589319224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170053,"user_name":"进击的矮人","can_delete":false,"product_type":"c3","uid":1711917,"ip_address":"","ucode":"3E2838168F62E9","user_header":"https://static001.geekbang.org/account/avatar/00/1a/1f/2d/90648df8.jpg","comment_is_top":false,"comment_ctime":1578498291,"is_pvip":false,"replies":[{"id":66768,"content":"对这个动态模型就是MongoDB的特色。如果是非强类型语言如python &#47; nodejs 会更加简单，直接JSON入库，JSON可以增加属性。\n\n模型处理mongodb端并不需要做任何工作，主要是你Java里面要能够给一个对象动态增加属性，然后把新对象交给Mongo就可以了","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1579132098,"ip_address":"","comment_id":170053,"utype":1}],"discussion_count":2,"race_medal":2,"score":2,"product_id":100040001,"comment_content":"老师；你好，新手问个问题：假如需求是联系人的属性是动态的，这种要怎么设计。关系型肯定更不好操作吧，比如说页面上有增删联系人属性的功能，这个模型怎么处理，尤其是作为面向对象开发，以Java为例，那这个联系人的属性对应的实体类属性就完全不知道怎么入手了，老师有什么建议吗，我是感觉这种功能好像是mongo数据库比较合适……。","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480824,"discussion_content":"对这个动态模型就是MongoDB的特色。如果是非强类型语言如python / nodejs 会更加简单，直接JSON入库，JSON可以增加属性。\n\n模型处理mongodb端并不需要做任何工作，主要是你Java里面要能够给一个对象动态增加属性，然后把新对象交给Mongo就可以了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579132098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1320243,"avatar":"https://static001.geekbang.org/account/avatar/00/14/25/33/290fcb42.jpg","nickname":"依乐祝","note":"","ucode":"0FAE2C7FE1ECDB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288356,"discussion_content":"为何不用map对象表示","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593737422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166059,"user_name":"firek","can_delete":false,"product_type":"c3","uid":1273501,"ip_address":"","ucode":"FFFDBFB34688EF","user_header":"https://static001.geekbang.org/account/avatar/00/13/6e/9d/29feea6f.jpg","comment_is_top":false,"comment_ctime":1577372414,"is_pvip":false,"replies":[{"id":65205,"content":"之前的版本嵌套超过2层就会导致无法in place update, 需要把整个子文档读到应用端整体修改更新。新版本使用arryFilter可以更新任意深度了，从这个角度上来讲还好。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577968824,"ip_address":"","comment_id":166059,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"文档内嵌的层级基于性能考虑有没有限制，举个例子，比如实际业务中也可能内嵌5层这样的情况出现。","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479378,"discussion_content":"之前的版本嵌套超过2层就会导致无法in place update, 需要把整个子文档读到应用端整体修改更新。新版本使用arryFilter可以更新任意深度了，从这个角度上来讲还好。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577968824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":166058,"user_name":"firek","can_delete":false,"product_type":"c3","uid":1273501,"ip_address":"","ucode":"FFFDBFB34688EF","user_header":"https://static001.geekbang.org/account/avatar/00/13/6e/9d/29feea6f.jpg","comment_is_top":false,"comment_ctime":1577372262,"is_pvip":false,"replies":[{"id":65204,"content":"对的，频繁修改是一个设计的考量，通常这个时候要考虑分出去另外一个集合，通过引用来表示关系。","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1577968553,"ip_address":"","comment_id":166058,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"当数据量非常大的情况下，内嵌文档被频繁修改要遍历所有的顶层文档，如果改为引用设计也只能建立一个关系表对多对多的情况优化的好些，如果是一对多的，除了修改从表的数据外，对从表的增删还是要在主表操作。","like_count":1,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479377,"discussion_content":"对的，频繁修改是一个设计的考量，通常这个时候要考虑分出去另外一个集合，通过引用来表示关系。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577968553,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244215,"user_name":"yue","can_delete":false,"product_type":"c3","uid":2074028,"ip_address":"","ucode":"619C973A039AC7","user_header":"https://static001.geekbang.org/account/avatar/00/1f/a5/ac/dcca12af.jpg","comment_is_top":false,"comment_ctime":1598430925,"is_pvip":false,"replies":[{"id":90008,"content":"可以用gridfs","user_name":"作者回复","user_name_real":"远航的TJ 唐建法","uid":1260017,"ctime":1598586731,"ip_address":"","comment_id":244215,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"老师你好，看到头像存储的案例我联想到假设业务不需要我们改动文件内容，只需要做读写删操作，mongodb提供的gridfs会适合这种情况吗？","like_count":0,"discussions":[{"author":{"id":1260017,"avatar":"https://static001.geekbang.org/account/avatar/00/13/39/f1/6d18a4d1.jpg","nickname":"远航的TJ 唐建法","note":"","ucode":"0719807390250A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504523,"discussion_content":"可以用gridfs","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598586731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":284567,"user_name":"teressa","can_delete":false,"product_type":"c3","uid":1666695,"ip_address":"","ucode":"9AA0C6D45CEC1E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLXQyKrqDG9ATu8ZYDT6iclkAQjcXicSbKEgV3t3c6qOmfO9Hu4vjqWZQyAWenqhVvY153fY4YQA1JQ/132","comment_is_top":false,"comment_ctime":1616345278,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"如果联系人头像这个例子，针对内存缓存空间这一点来说：我针对除头像数据以外其他的字段都建了索引，查询语句指定不读头像数据，实际上也不会将头像数据加载到内存，这种情况还有必要使用引用嘛？  ","like_count":1},{"had_liked":false,"id":194933,"user_name":"追忆似水年华","can_delete":false,"product_type":"c3","uid":1160192,"ip_address":"","ucode":"C1D7C0DD7E7411","user_header":"https://static001.geekbang.org/account/avatar/00/11/b4/00/661fb98d.jpg","comment_is_top":false,"comment_ctime":1585121622,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"看了这一节课程之后，最深的一点感受就是：最主要的工作，其实是在写代码之前的分析、思考、合理设计，把事情想清楚了，把解决方法用对了，最后的代码写起来也很轻松很多。","like_count":1},{"had_liked":false,"id":386054,"user_name":"momo","can_delete":false,"product_type":"c3","uid":2952159,"ip_address":"中国香港","ucode":"BFA966E7CEBAB3","user_header":"https://static001.geekbang.org/account/avatar/00/2d/0b/df/0388b150.jpg","comment_is_top":false,"comment_ctime":1703932895,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100040001,"comment_content":"https:&#47;&#47;www.mongodb.com&#47;docs&#47;manual&#47;release-notes&#47;5.1&#47;#-lookup-and--graphlookup-with-sharded-collections\n\n在5.1及以后版本允许lookup的from字段对sharded集合做引用查询了。\n原文：\n“Starting in MongoDB 5.1, the $lookup and $graphLookup aggregation stages support sharded collections in the from parameter.\n\nIn previous versions of MongoDB, $lookup and $graphLookup only allowed for unsharded from collections.”","like_count":0},{"had_liked":false,"id":312861,"user_name":"黑夜白昼","can_delete":false,"product_type":"c3","uid":1514079,"ip_address":"","ucode":"F6BBDB84E03F85","user_header":"https://static001.geekbang.org/account/avatar/00/17/1a/5f/40993c14.jpg","comment_is_top":false,"comment_ctime":1632064405,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"user 集合里有一个 ava 头像字段， String， 存放 URL。 然后有一天需要想微信那样记录上一次的历史头像， 是新增一个 ava ？还是把 ava 改为 array 好呢？ 如果是改为 array, 又该怎样把线上 ava: url1, 批量改为 ava: [url1, ‘’]呢, 有这样的工具吗？ ","like_count":0},{"had_liked":false,"id":266310,"user_name":"而立斋","can_delete":false,"product_type":"c3","uid":1087258,"ip_address":"","ucode":"5FED6E9E148195","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg","comment_is_top":false,"comment_ctime":1607300478,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100040001,"comment_content":"groups为啥不用_id，而是自己再弄一个id呢","like_count":0,"discussions":[{"author":{"id":3196256,"avatar":"","nickname":"Geek_03197d","note":"","ucode":"1A4CB405EF154A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":653758,"discussion_content":"自己弄一个比较短，可理解吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1731421503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"安徽","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}