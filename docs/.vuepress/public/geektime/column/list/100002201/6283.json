{"id":6283,"title":"57 | 管理设计篇之“部署升级策略”","content":"<p>你好，我是陈皓，网名左耳朵耗子。</p>\n<p>在分布式系统的世界里，一个服务有多个实例，所以部署或是升级一个服务也会变得比较麻烦。今天我们讨论服务部署的模式。一般来说，有如下几种：</p>\n<ul>\n<li>\n<p>停机部署（Big Bang / Recreate）： 把现有版本的服务停机，然后部署新的版本。</p>\n</li>\n<li>\n<p>蓝绿部署（Blue/Green /Stage）：部署好新版本后，把流量从老服务那边切过来。</p>\n</li>\n<li>\n<p>滚动部署（Rolling Update / Ramped）： 一点一点地升级现有的服务。</p>\n</li>\n<li>\n<p>灰度部署（Canary）：把一部分用户切到新版本上来，然后看一下有没有问题。如果没有问题就继续扩大升级，直到全部升级完成。</p>\n</li>\n<li>\n<p>AB测试（A/B Testing）：同时上线两个版本，然后做相关的比较。</p>\n</li>\n</ul>\n<!-- [[[read_end]]] -->\n<p>下面，我们来看一下每种方式的使用场景和优缺点。</p>\n<h1>停机部署</h1>\n<p>停机部署其实是最简单粗暴的方式，就是简单地把现有版本的服务停机，然后部署新的版本。有时候，我们不得不使用这样的方式来部署或升级多个服务。比如，新版本中的服务使用到了和老版本完全不兼容的数据表设计。这个时候，我们对生产有两个变更，一个是数据库，另一个是服务，而且新老版本互不兼容，所以只能使用停机部署的方式。</p>\n<p>这种方式的优势是，在部署过程中不会出现新老版本同时在线的情况，所有状态完全一致。停机部署主要是为了新版本的一致性问题。</p>\n<p>这种方式的问题是会停机，对用户的影响很大。所以，一般来说，这种部署方式需要事前挂公告，选择一个用户访问少的时间段来做。</p>\n<h1>蓝绿部署</h1>\n<p>蓝绿部署与停机部署最大的不同是，其在生产线上部署相同数量的新服务，然后当新的服务测试确认OK后，把流量切到新的服务这边来。蓝绿部署比停机部署好的地方是，它无需停机。</p>\n<p>我们可以看到这种部署方式，就是我们说的预发环境。在我以前的金融公司里，也经常用这种方式，生产线上有两套相同的集群，一套是Prod是真实服务的，另一套是Stage是预发环境，发布发Stage，然后把流量切到Stage这边，于是Stage就成了Prod，而之前的Prod则成了Stage。有点像换页似的。</p>\n<p>这种方式的优点是没有停机，实时发布和升级，也避免有新旧版本同时在线的问题。但这种部署的问题就是有点浪费，因为需要使用双倍的资源（不过，这只是在物理机时代，在云计算时代没事，因为虚拟机部署完就可以释放了）。</p>\n<p>另外，如果我们的服务中有状态，比如一些缓存什么的，停机部署和蓝绿部署都会有问题。</p>\n<h1>滚动部署</h1>\n<p>滚动部署策略是指通过逐个替换应用的所有实例，来缓慢发布应用的一个新版本。通常过程如下：在负载调度后有个版本A的应用实例池，一个版本B的实例部署成功，可以响应请求时，该实例被加入到池中。然后，版本A的一个实例从池中删除并下线。</p>\n<p>这种部署方式直接对现有的服务进行升级，虽然便于操作，而且在缓慢地更新的过程中，对于有状态的服务也是比较友好的，状态可以在更新中慢慢重建起来。但是，这种部署的问题也是比较多的。</p>\n<ul>\n<li>\n<p>在发布过程中，会出现新老两个版本同时在线的情况，同一用户的请求可能在新老版中切换而导致问题。</p>\n</li>\n<li>\n<p>我们的新版程序没有在生产线上经过验证就上线了。</p>\n</li>\n<li>\n<p>在整个过程中，生产环境处于一个新老更替的中间状态，如果有问题要回滚就有点麻烦了。</p>\n</li>\n<li>\n<p>如果在升级过程中，需要做别的一些运维工作，我们还要判断哪些结点是老版本的，哪些结点是新版本的。这太痛苦了。</p>\n</li>\n<li>\n<p>因为新老版本的代码同时在线，所以其依赖的服务需要同时处理两个版本的请求，这可能会带来兼容性问题。</p>\n</li>\n<li>\n<p>而且，我们无法让流量在新老版本中切换。</p>\n</li>\n</ul>\n<h1>灰度部署（金丝雀）</h1>\n<p>灰度部署又叫金丝雀部署。其得名来源于矿井中的金丝雀。17世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱。而当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为&quot;瓦斯检测指标&quot;，以便在危险状况下紧急撤离。</p>\n<p>灰度部署是指逐渐将生产环境流量从老版本切换到新版本。通常流量是按比例分配的。例如90%的请求流向老版本，10%的请求流向新版本。然后没有发现问题，就逐步扩大新版本上的流量，减少老版本上的流量。</p>\n<p>除了切流量外，对于多租户的平台，例如云计算平台，灰度部署也可以将一些新的版本先部署到一些用户上，如果没有问题，扩大部署，直到全部用户。一般的策略是，从内部用户开始，然后是一般用户，最后是大客户。</p>\n<p>这个技术大多数用于缺少足够测试，或者缺少可靠测试，或者对新版本的稳定性缺乏信心的情况下。</p>\n<p>把一部分用户切到新版上来，然后看一下有没有问题。如果没有问题就继续扩大升级，直到全部升级完成。</p>\n<h1>AB测试</h1>\n<p>AB测试和蓝绿部署或是金丝雀灰度部署完全是不一样的。</p>\n<p>AB测试是同时上线两个版本，然后做相关的比较。它是用来测试应用功能表现的方法，例如可用性、受欢迎程度、可见性等。</p>\n<p>蓝绿部署是为了不停机，灰度部署是对新版本的质量没信心。而AB测试是对新版的功能没信心。注意，一个是质量，一个是功能。</p>\n<p>比如，网站UI大改版，推荐算法的更新，流程的改变，我们不知道新的版本否会得到用户青睐或是能得到更好的用户体验，我们需要收集一定的用户数据才能知道。</p>\n<p>于是我们需要在生产线上发布两个版本，拉一部分用户过来当小白鼠，然后通过科学的观测得出来相关的结论。AB测试旨在通过科学的实验设计、采样样本代表性、流量分割与小流量测试等方式来获得具有代表性的实验结论，并确信该结论在推广到全部流量时可信。</p>\n<p>我们可以看到AB测试，其包含了灰度发布的功能。也就是说，我们的观测如果只是观测有没有bug，那就是灰度发布了。当然，如果我们复杂一点，要观测用户的一些数据指标，这完全也可能做成自动化的，如果新版本数据好，就自动化地切一点流量过来，如果不行，就换一批用户（样本）再试试。</p>\n<p>对于灰度发布或是AB测试可以使用下面的技术来选择用户。</p>\n<ul>\n<li>浏览器cookie。</li>\n<li>查询参数。</li>\n<li>地理位置。</li>\n<li>技术支持，如浏览器版本、屏幕尺寸、操作系统等。</li>\n<li>客户端语言。</li>\n</ul>\n<h1>小结</h1>\n<p>部署应用有很多种方法，实际采用哪种方式取决于需求和预算。当发布到开发或者模拟环境时，停机或者滚动部署是一个好选择，因为干净和快速。当发布到生产环境时，滚动部署或者蓝绿部署通常是一个好选择，但新平台的主流程测试是必须的。</p>\n<p>蓝绿部署也不错，但需要额外的资源。如果应用缺乏测试或者对软件的功能和稳定性影响缺乏信心，那么可以使用金丝雀部署或者AB测试发布。如果业务需要根据地理位置、语言、操作系统或者浏览器特征等参数来给一些特定的用户测试，那么可以采用AB测试技术。</p>\n<p><img src=\"https://static001.geekbang.org/resource/image/08/75/08492dde28724d6f0a46ef89b0aec275.jpg?wh=1563x1173\" alt=\"\" /></p>\n<p>好了，我们来总结一下今天分享的主要内容。首先，常见的部署升级策略有停机、蓝绿、滚动、灰度和AB测试这几种。然后，我讲述了每一种部署策略的含义和优缺点。最后，我将它们放在一起做了一个比较。下一讲是《分布式系统设计模式》第三部分——性能设计的第一篇&quot;缓存&quot;。希望对你有帮助。</p>\n<p>也欢迎你分享一下你接触到的部署方式有哪些？在什么场景下使用哪一种部署方式？</p>\n<p>文末给出了《分布式系统设计模式》系列文章的目录，希望你能在这个列表里找到自己感兴趣的内容。</p>\n<ul>\n<li>弹力设计篇\n<ul>\n<li><a href=\"https://time.geekbang.org/column/article/3912\">认识故障和弹力设计</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/3917\">隔离设计Bulkheads</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/3926\">异步通讯设计Asynchronous</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4050\">幂等性设计Idempotency</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4086\">服务的状态State</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4087\">补偿事务Compensating Transaction</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4121\">重试设计Retry</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4241\">熔断设计Circuit Breaker</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4245\">限流设计Throttle</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4252\">降级设计degradation</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/4253\">弹力设计总结</a></li>\n</ul>\n</li>\n<li>管理设计篇\n<ul>\n<li><a href=\"https://time.geekbang.org/column/article/5175\">分布式锁Distributed Lock</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/5819\">配置中心Configuration Management</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/5909\">边车模式Sidecar</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/5920\">服务网格Service Mesh</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/6086\">网关模式Gateway</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/6283\">部署升级策略</a></li>\n</ul>\n</li>\n<li>性能设计篇\n<ul>\n<li><a href=\"https://time.geekbang.org/column/article/6282\">缓存Cache</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/7036\">异步处理Asynchronous</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/7045\">数据库扩展</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/7047\">秒杀Flash Sales</a></li>\n<li><a href=\"https://time.geekbang.org/column/article/7086\">边缘计算Edge Computing</a></li>\n</ul>\n</li>\n</ul>\n","neighbors":{"left":{"article_title":"56 | 管理设计篇之“网关模式”","id":6086},"right":{"article_title":"58 | 性能设计篇之“缓存”","id":6282}},"comments":[{"had_liked":false,"id":8367,"user_name":"画圈圈","can_delete":false,"product_type":"c1","uid":1084607,"ip_address":"","ucode":"800394066132C8","user_header":"https://static001.geekbang.org/account/avatar/00/10/8c/bf/e55c54f2.jpg","comment_is_top":false,"comment_ctime":1526127263,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"121785211551","product_id":100002201,"comment_content":"太笼统了，关键是实现细节。","like_count":29,"discussions":[{"author":{"id":1138576,"avatar":"https://static001.geekbang.org/account/avatar/00/11/5f/90/711efc88.jpg","nickname":"FuriousEric","note":"","ucode":"0A66DA938976F7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312117,"discussion_content":"极客时间里搜一下蓝绿部署啊，极客时间的搜索功能要多用，例如redis分布式锁，有个专栏作者写的我完全看不懂，搜索了一下，发现耗子写的最好，秒懂。马上就找到另外一个专栏写的实践操作了，负载均衡里把蓝色集群全部删除掉，切换到绿色集群(例如阿里云的负载均衡配置），实际上那个专栏里叫做红黑部署，蓝绿部署是另外一种意思","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1602585411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1033748,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c6/14/3f206319.jpg","nickname":"Finch","note":"","ucode":"627124740E3940","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550173,"discussion_content":"高度不同","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644405461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1320487,"avatar":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","nickname":"罗杰","note":"","ucode":"96BAFAA147341F","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546095,"discussion_content":"具体场景具体分析，这篇文章就是来告诉你更新时可选的几中方法，等决策更新策略时使用，没有办法给出实现细节吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642155802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104850,"avatar":"https://static001.geekbang.org/account/avatar/00/10/db/d2/e29f8834.jpg","nickname":"lidashuang","note":"","ucode":"560ABE8032760E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327185,"discussion_content":"细节，不同技术架构实现方案不一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605762217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":322368,"discussion_content":"事实上很不错！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604733252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":10027,"user_name":"shufang","can_delete":false,"product_type":"c1","uid":1055576,"ip_address":"","ucode":"1F16B2D15E0151","user_header":"","comment_is_top":false,"comment_ctime":1527229757,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"53066837309","product_id":100002201,"comment_content":"滚动部署：逐个上；灰度部署：全上，逐步切换；蓝绿部署：全上，预发生产切换；AB测试：全上，同时存在。不知道理解的对不对？","like_count":13},{"had_liked":false,"id":7842,"user_name":"约书亚","can_delete":false,"product_type":"c1","uid":1046714,"ip_address":"","ucode":"81EA27ADD9EC1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","comment_is_top":false,"comment_ctime":1525743358,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31590514430","product_id":100002201,"comment_content":"我觉得现在很多方案混合了蓝绿和灰度，这二者不会细分了。首先微服务架构下，单个服务的部署带来的冗余成本很低。同时也通过网关做流量的逐步迁移。发现问题回滚很快。尤其是基有了容器编排之后就更方便了","like_count":8},{"had_liked":false,"id":253076,"user_name":"FuriousEric","can_delete":false,"product_type":"c1","uid":1138576,"ip_address":"","ucode":"0A66DA938976F7","user_header":"https://static001.geekbang.org/account/avatar/00/11/5f/90/711efc88.jpg","comment_is_top":false,"comment_ctime":1602585439,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10192520031","product_id":100002201,"comment_content":"很多同学说没有实现，我教大家一个方法，极客时间里搜一下蓝绿部署啊，极客时间的搜索功能要多用，例如redis分布式锁，有个专栏作者写的我完全看不懂，搜索了一下，发现耗子写的最好，秒懂。马上就找到另外一个专栏写的实践操作了，负载均衡里把蓝色集群全部删除掉，切换到绿色集群(例如阿里云的负载均衡配置），实际上那个专栏里叫做红黑部署，蓝绿部署是另外一种意思","like_count":2},{"had_liked":false,"id":39946,"user_name":"国诚","can_delete":false,"product_type":"c1","uid":1023292,"ip_address":"","ucode":"7BA8A4B79571BB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9d/3c/1dd238c8.jpg","comment_is_top":false,"comment_ctime":1542417922,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132352514","product_id":100002201,"comment_content":"要是有点能落地的东西就好了","like_count":2},{"had_liked":false,"id":35928,"user_name":"独白","can_delete":false,"product_type":"c1","uid":1192992,"ip_address":"","ucode":"A0EF43ABE1CC28","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/20/d9408a6a.jpg","comment_is_top":false,"comment_ctime":1540863314,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10130797906","product_id":100002201,"comment_content":"对于有修改数据结构，新老版本不兼容，除了停机部署，其他几种部署有没有好的方案？","like_count":2},{"had_liked":false,"id":211235,"user_name":"Geek_CK2020","can_delete":false,"product_type":"c1","uid":1961826,"ip_address":"","ucode":"5DF4BE058F5A58","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ef/62/87d9ef62.jpg","comment_is_top":false,"comment_ctime":1587918641,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5882885937","product_id":100002201,"comment_content":"第一次意识到灰度部署和AB部署的本质区别是，前者是因为质量，后者是因为功能。","like_count":2},{"had_liked":false,"id":173456,"user_name":"ZEROAZERO","can_delete":false,"product_type":"c1","uid":1687735,"ip_address":"","ucode":"018F0CF7DAADC1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLqBI3vIIIEKrkw5luxq446fdOBJltljd4oRjdzLWgQ9rWWUydKCGVhjdPcpkkHhQHXbLJPUMwvVg/132","comment_is_top":false,"comment_ctime":1579566882,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5874534178","product_id":100002201,"comment_content":"灰度和滚动自己有些没分清，","like_count":0},{"had_liked":false,"id":171210,"user_name":"Goal","can_delete":false,"product_type":"c1","uid":1307012,"ip_address":"","ucode":"C337CD4C7E07B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f1/84/7d21bd9e.jpg","comment_is_top":false,"comment_ctime":1578882142,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5873849438","product_id":100002201,"comment_content":"打卡：57 | 管理设计篇之“部署升级策略”<br>针对本节课的内容，让我想起了之前做 k8s里面的 Deploy升级的场景，但是遇到一个问题始终无法解释？<br><br> 默认k8s中升级新版本的策略是滚动更新，这个意思的话，就是服务不会中断的， 但是在我测试中发现并非如此，具体如下：<br>假设，我Deploy 的副本是3个，现在有版本是2的镜像要上线，通过 kubectl images修改 Deploy镜像版本为新的版本2，这时，我在另外一台机器上一直curl接口，发现当有第一个版本2的节点加入到 Deploy对应的 Service的 endpoint上时候，curl会显示 请求被拒绝响应的情况。","like_count":1,"discussions":[{"author":{"id":2281234,"avatar":"","nickname":"Geek_ed8984","note":"","ucode":"D8BE37E995384A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327462,"discussion_content":"为新pod提供 rediness probe 检查，同时对旧pod preStop钩子设定一个时间，来延迟删除旧pod，这样方案应该也可以解决这个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605843857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1554638,"avatar":"https://static001.geekbang.org/account/avatar/00/17/b8/ce/0abbb54d.jpg","nickname":"俊毓","note":"","ucode":"F150D39D00FAAC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":141911,"discussion_content":"这种情况下，最好在deployment添加健康检查，让新的pod健康检查通过后才能提供服务，应该会解决这个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579443904,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":136874,"user_name":"先立个flag，完成才改名的咸鱼","can_delete":false,"product_type":"c1","uid":1470603,"ip_address":"","ucode":"DDD06E7E3587A8","user_header":"https://static001.geekbang.org/account/avatar/00/16/70/8b/67a2baf5.jpg","comment_is_top":false,"comment_ctime":1569546392,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5864513688","product_id":100002201,"comment_content":"蓝绿和灰度有什么区别？","like_count":2,"discussions":[{"author":{"id":1139413,"avatar":"https://static001.geekbang.org/account/avatar/00/11/62/d5/1f5c5ab6.jpg","nickname":"大大大熊myeh","note":"","ucode":"4832C2E7CEB151","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286831,"discussion_content":"蓝绿：新版本上线，测试没问题之后，将所有流量切到新版本。\n灰度：新版本上线，将一部分流量切换到新版本，大部分用户还是用老版本，等过一段时间没啥问题之后，再将所有用户切换到新版本。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1593307094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115853,"user_name":"edisonhuang","can_delete":false,"product_type":"c1","uid":1530167,"ip_address":"","ucode":"BB2F639A779F96","user_header":"https://static001.geekbang.org/account/avatar/00/17/59/37/bd2de0a4.jpg","comment_is_top":false,"comment_ctime":1563757786,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5858725082","product_id":100002201,"comment_content":"部署升级方式有停机，蓝绿，滚动，灰度，AB测试等。不同的方式在资源消耗，状态一致，功能性能验证方面有区别。云时代基本不会使用的是停机部署的方式，对用户影响太大","like_count":1},{"had_liked":false,"id":65912,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1549768174,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5844735470","product_id":100002201,"comment_content":"我们有J-ONE，测试通过，预发布通过，线上一般使用滚动部署的方式发布。","like_count":2,"discussions":[{"author":{"id":1033066,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c3/6a/3272e095.jpg","nickname":"李春恒","note":"","ucode":"F2DCA19EC66DC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":74815,"discussion_content":"跟jdos比起来，差距太大了，","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1575690941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":7778,"user_name":"秋天","can_delete":false,"product_type":"c1","uid":1057056,"ip_address":"","ucode":"A7E1D953EF7E17","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg","comment_is_top":false,"comment_ctime":1525735040,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5820702336","product_id":100002201,"comment_content":"有些东西能不能具体说说实现方式呢？谢谢！","like_count":1,"discussions":[{"author":{"id":2446418,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/zdK3dSkFwicZHtx5CLAKFJRORRibq2YqvHOP0tySLxVx0X1oD9AJanan2wia2hHaswgxdrCzEEGyVgFTVZ8sElTzQ/132","nickname":"Geek_fbfc4f","note":"","ucode":"7010B242A3F474","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374513,"discussion_content":"可能作者也不会吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621225713,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":276337,"user_name":"迷宫中的将军","can_delete":false,"product_type":"c1","uid":1027658,"ip_address":"","ucode":"67D3CD6033BFDE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ae/4a/a71a889b.jpg","comment_is_top":false,"comment_ctime":1611888734,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611888734","product_id":100002201,"comment_content":"红黑部署是现在典型的云上部署方式。","like_count":0},{"had_liked":false,"id":257666,"user_name":"你为啥那么牛","can_delete":false,"product_type":"c1","uid":1503506,"ip_address":"","ucode":"1ABC604A54A8F6","user_header":"https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg","comment_is_top":false,"comment_ctime":1604051281,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604051281","product_id":100002201,"comment_content":"如果数据库表设计发生了变更，金丝雀部署，通过引流得方式升级，会不会有问题了。","like_count":0},{"had_liked":false,"id":220816,"user_name":"liin","can_delete":false,"product_type":"c1","uid":1038705,"ip_address":"","ucode":"92AE8958DDED4E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d9/71/8e38dc01.jpg","comment_is_top":false,"comment_ctime":1590326888,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1590326888","product_id":100002201,"comment_content":"预发布停机部署，生产滚动部署，或灰度","like_count":0},{"had_liked":false,"id":212046,"user_name":"曙光","can_delete":false,"product_type":"c1","uid":1476450,"ip_address":"","ucode":"04D65BF7F19845","user_header":"https://static001.geekbang.org/account/avatar/00/16/87/62/f99b5b05.jpg","comment_is_top":false,"comment_ctime":1588052574,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588052574","product_id":100002201,"comment_content":"感觉灰度部署和AB测试是一种部署，灰度部署强调怎么部署（10%新版本，90%旧版本），而AB测试强调的是新老版本的使用情况，测试比较。","like_count":0},{"had_liked":false,"id":211435,"user_name":"Geek_130e9e","can_delete":false,"product_type":"c1","uid":1587628,"ip_address":"","ucode":"518AAF2F228C17","user_header":"","comment_is_top":false,"comment_ctime":1587962573,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587962573","product_id":100002201,"comment_content":"部署应用有很多种方法，实际采用哪种方式取决于需求和预算。当发布到开发或者模拟环境时，停机或者滚动部署是一个好选择，因为干净和快速。当发布到生产环境时，滚动部署或者蓝绿部署通常是一个好选择，但新平台的主流程测试是必须的。","like_count":0},{"had_liked":false,"id":170742,"user_name":"知行合一","can_delete":false,"product_type":"c1","uid":1521486,"ip_address":"","ucode":"2B8E634FC4CFB7","user_header":"https://static001.geekbang.org/account/avatar/00/17/37/4e/5c3153b2.jpg","comment_is_top":false,"comment_ctime":1578702375,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578702375","product_id":100002201,"comment_content":"停机部署是业务变更比较大并且可控的情况下才会使用，蓝绿部署工作中还很少用到，滚动部署比较常用，但是需要考虑两个版本同时运行这段时间的兼容问题，灰度发布在发app版本的时候用到了，但是服务端还未对人群做灰度，ABtest应用在了一些业务上但是服务发布时还没用到过，实现这所有发布模式的发布系统可畏是很强大了","like_count":0},{"had_liked":false,"id":169199,"user_name":"文刂 氵共 超","can_delete":false,"product_type":"c1","uid":1282813,"ip_address":"","ucode":"C2CE1512D23012","user_header":"https://static001.geekbang.org/account/avatar/00/13/92/fd/6b0e58fe.jpg","comment_is_top":false,"comment_ctime":1578291775,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578291775","product_id":100002201,"comment_content":"坚持学习，学习笔记 https:&#47;&#47;mubu.com&#47;colla&#47;1kM6EcLYQJ0","like_count":0},{"had_liked":false,"id":117134,"user_name":"蜗牛","can_delete":false,"product_type":"c1","uid":1052773,"ip_address":"","ucode":"9810F92816F752","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/65/46cc65d7.jpg","comment_is_top":false,"comment_ctime":1563974718,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563974718","product_id":100002201,"comment_content":"文中介绍的蓝绿部署在切换时候，2个版本都在线。。。。","like_count":0}]}