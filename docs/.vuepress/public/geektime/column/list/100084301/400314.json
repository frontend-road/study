{"id":400314,"title":"02 | é”®å€¼å¯¹ä¸­å­—ç¬¦ä¸²çš„å®ç°ï¼Œç”¨char*è¿˜æ˜¯ç»“æ„ä½“ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è’‹å¾·é’§ã€‚</p><p>å­—ç¬¦ä¸²åœ¨æˆ‘ä»¬å¹³æ—¶çš„åº”ç”¨å¼€å‘ä¸­ååˆ†å¸¸è§ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦è®°å½•ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€çŠ¶æ€ä¿¡æ¯ç­‰ç­‰ï¼Œè¿™äº›éƒ½ä¼šç”¨åˆ°å­—ç¬¦ä¸²ã€‚</p><p>è€Œå¯¹äºRedisæ¥è¯´ï¼Œé”®å€¼å¯¹ä¸­çš„é”®æ˜¯å­—ç¬¦ä¸²ï¼Œå€¼æœ‰æ—¶ä¹Ÿæ˜¯å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬åœ¨Redisä¸­å†™å…¥ä¸€æ¡ç”¨æˆ·ä¿¡æ¯ï¼Œè®°å½•äº†ç”¨æˆ·å§“åã€æ€§åˆ«ã€æ‰€åœ¨åŸå¸‚ç­‰ï¼Œè¿™äº›éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>SET user:id:100 {â€œnameâ€: â€œzhangsanâ€, â€œgenderâ€: â€œMâ€,â€œcityâ€:&quot;beijing&quot;}\n</code></pre><p>æ­¤å¤–ï¼ŒRediså®ä¾‹å’Œå®¢æˆ·ç«¯äº¤äº’çš„å‘½ä»¤å’Œæ•°æ®ï¼Œä¹Ÿéƒ½æ˜¯ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„ã€‚</p><p>é‚£ä¹ˆï¼Œæ—¢ç„¶å­—ç¬¦ä¸²çš„ä½¿ç”¨å¦‚æ­¤å¹¿æ³›å’Œå…³é”®ï¼Œå°±ä½¿å¾—æˆ‘ä»¬åœ¨å®ç°å­—ç¬¦ä¸²æ—¶ï¼Œéœ€è¦å°½é‡æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªè¦æ±‚ï¼š</p><ul>\n<li>èƒ½æ”¯æŒä¸°å¯Œä¸”é«˜æ•ˆçš„å­—ç¬¦ä¸²æ“ä½œï¼Œæ¯”å¦‚å­—ç¬¦ä¸²è¿½åŠ ã€æ‹·è´ã€æ¯”è¾ƒã€è·å–é•¿åº¦ç­‰ï¼›</li>\n<li>èƒ½ä¿å­˜ä»»æ„çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæ¯”å¦‚å›¾ç‰‡ç­‰ï¼›</li>\n<li>èƒ½å°½å¯èƒ½åœ°èŠ‚çœå†…å­˜å¼€é”€ã€‚</li>\n</ul><p>å…¶å®ï¼Œå¦‚æœä½ å¼€å‘è¿‡Cè¯­è¨€ç¨‹åºï¼Œä½ åº”è¯¥å°±çŸ¥é“ï¼Œåœ¨Cè¯­è¨€ä¸­å¯ä»¥ä½¿ç”¨<strong>char*å­—ç¬¦æ•°ç»„</strong>æ¥å®ç°å­—ç¬¦ä¸²ã€‚åŒæ—¶ï¼ŒCè¯­è¨€æ ‡å‡†åº“string.hä¸­ä¹Ÿå®šä¹‰äº†å¤šç§å­—ç¬¦ä¸²çš„æ“ä½œå‡½æ•°ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°strcmpã€å­—ç¬¦ä¸²é•¿åº¦è®¡ç®—å‡½æ•°strlenã€å­—ç¬¦ä¸²è¿½åŠ å‡½æ•°strcatç­‰ï¼Œè¿™æ ·å°±ä¾¿äºå¼€å‘è€…ç›´æ¥è°ƒç”¨è¿™äº›å‡½æ•°æ¥å®Œæˆå­—ç¬¦ä¸²æ“ä½œã€‚</p><p>æ‰€ä»¥è¿™æ ·çœ‹èµ·æ¥ï¼Œ<strong>Rediså¥½åƒå®Œå…¨å¯ä»¥å¤ç”¨Cè¯­è¨€ä¸­å¯¹å­—ç¬¦ä¸²çš„å®ç°å‘€ï¼Ÿ</strong></p><p>ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨Cè¯­è¨€å­—ç¬¦ä¸²æ—¶ï¼Œç»å¸¸éœ€è¦æ‰‹åŠ¨æ£€æŸ¥å’Œåˆ†é…å­—ç¬¦ä¸²ç©ºé—´ï¼Œè€Œè¿™å°±ä¼šå¢åŠ ä»£ç å¼€å‘çš„å·¥ä½œé‡ã€‚è€Œä¸”ï¼Œå›¾ç‰‡ç­‰æ•°æ®è¿˜æ— æ³•ç”¨å­—ç¬¦ä¸²ä¿å­˜ï¼Œä¹Ÿå°±é™åˆ¶äº†åº”ç”¨èŒƒå›´ã€‚</p><!-- [[[read_end]]] --><p>é‚£ä¹ˆï¼Œä»ç³»ç»Ÿè®¾è®¡çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è®¾è®¡å®ç°å­—ç¬¦ä¸²å‘¢ï¼Ÿ</p><p>å…¶å®ï¼ŒRedisè®¾è®¡äº†<strong>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</strong>ï¼ˆSimple Dynamic Stringï¼ŒSDSï¼‰çš„ç»“æ„ï¼Œç”¨æ¥è¡¨ç¤ºå­—ç¬¦ä¸²ã€‚ç›¸æ¯”äºCè¯­è¨€ä¸­çš„å­—ç¬¦ä¸²å®ç°ï¼ŒSDSè¿™ç§å­—ç¬¦ä¸²çš„å®ç°æ–¹å¼ï¼Œä¼š<strong>æå‡å­—ç¬¦ä¸²çš„æ“ä½œæ•ˆç‡ï¼Œå¹¶ä¸”å¯ä»¥ç”¨æ¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®</strong>ã€‚</p><p>æ‰€ä»¥ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘å°±æ¥ç»™ä½ ä»‹ç»ä¸‹SDSç»“æ„çš„è®¾è®¡æ€æƒ³å’Œå®ç°æŠ€å·§ï¼Œè¿™æ ·ä½ å°±æ—¢å¯ä»¥æŒæ¡char*å®ç°æ–¹æ³•çš„ä¸è¶³å’ŒSDSçš„ä¼˜åŠ¿ï¼Œè¿˜èƒ½å­¦ä¹ åˆ°ç´§å‡‘å‹å†…å­˜ç»“æ„çš„å®ç°æŠ€å·§ã€‚å¦‚æœä½ è¦åœ¨è‡ªå·±çš„ç³»ç»Ÿè½¯ä»¶ä¸­å®ç°å­—ç¬¦ä¸²ç±»å‹ï¼Œå°±å¯ä»¥å‚è€ƒRedisçš„è®¾è®¡æ€æƒ³ï¼Œæ¥æ›´å¥½åœ°æå‡æ“ä½œæ•ˆç‡ï¼ŒèŠ‚çœå†…å­˜å¼€é”€ã€‚</p><p>å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ä¸ºä»€ä¹ˆRedisæ²¡æœ‰å¤ç”¨Cè¯­è¨€çš„å­—ç¬¦ä¸²å®ç°æ–¹æ³•ã€‚</p><h2>ä¸ºä»€ä¹ˆRedisä¸ç”¨char*ï¼Ÿ</h2><p>å®é™…ä¸Šï¼Œè¦æƒ³è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“char*å­—ç¬¦ä¸²æ•°ç»„çš„ç»“æ„ç‰¹ç‚¹ï¼Œè¿˜æœ‰Rediså¯¹å­—ç¬¦ä¸²çš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°±æ¥å…·ä½“åˆ†æä¸€ä¸‹ã€‚</p><h3>char*çš„ç»“æ„è®¾è®¡</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹char*å­—ç¬¦æ•°ç»„çš„ç»“æ„ã€‚</p><p><code>char*</code>å­—ç¬¦æ•°ç»„çš„ç»“æ„å¾ˆç®€å•ï¼Œå°±æ˜¯<strong>ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œä¾æ¬¡å­˜æ”¾äº†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦</strong>ã€‚æ¯”å¦‚ï¼Œä¸‹å›¾æ˜¾ç¤ºçš„å°±æ˜¯å­—ç¬¦ä¸²â€œredisâ€çš„<code>char*</code>æ•°ç»„ç»“æ„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0f/03/0f8b2de0dc4b30392e155f0bdca0d003.jpg?wh=2000x608\" alt=\"\"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå­—ç¬¦æ•°ç»„çš„æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯â€œ\\0â€ï¼Œè¿™ä¸ªå­—ç¬¦çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®ï¼ŒCè¯­è¨€åœ¨å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ“ä½œæ—¶ï¼Œchar*æŒ‡é’ˆåªæ˜¯æŒ‡å‘å­—ç¬¦æ•°ç»„çš„èµ·å§‹ä½ç½®ï¼Œè€Œ<strong>å­—ç¬¦æ•°ç»„çš„ç»“å°¾ä½ç½®å°±ç”¨â€œ\\0â€è¡¨ç¤ºï¼Œæ„æ€æ˜¯æŒ‡å­—ç¬¦ä¸²çš„ç»“æŸ</strong>ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼ŒCè¯­è¨€æ ‡å‡†åº“ä¸­å­—ç¬¦ä¸²çš„æ“ä½œå‡½æ•°ï¼Œå°±ä¼šé€šè¿‡æ£€æŸ¥å­—ç¬¦æ•°ç»„ä¸­æ˜¯å¦æœ‰â€œ\\0â€ï¼Œæ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸã€‚æ¯”å¦‚ï¼Œstrlenå‡½æ•°å°±æ˜¯ä¸€ç§å­—ç¬¦ä¸²æ“ä½œå‡½æ•°ï¼Œå®ƒå¯ä»¥è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ã€‚è¿™ä¸ªå‡½æ•°ä¼šéå†å­—ç¬¦æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œå¹¶è¿›è¡Œè®¡æ•°ï¼Œç›´åˆ°æ£€æŸ¥çš„å­—ç¬¦ä¸ºâ€œ\\0â€ã€‚æ­¤æ—¶ï¼Œstrlenå‡½æ•°ä¼šåœæ­¢è®¡æ•°ï¼Œè¿”å›å·²ç»ç»Ÿè®¡åˆ°çš„å­—ç¬¦ä¸ªæ•°ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†strlenå‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/7d/41/7de1b18d30280645c17yydf14afde541.jpg?wh=2000x1125\" alt=\"\"></p><p>æˆ‘ä»¬å†é€šè¿‡ä¸€æ®µä»£ç ï¼Œæ¥çœ‹ä¸‹<strong>â€œ\\0â€ç»“æŸå­—ç¬¦å¯¹å­—ç¬¦ä¸²é•¿åº¦çš„å½±å“</strong>ã€‚è¿™é‡Œæˆ‘åˆ›å»ºäº†ä¸¤ä¸ªå­—ç¬¦ä¸²å˜é‡aå’Œbï¼Œåˆ†åˆ«ç»™å®ƒä»¬èµ‹å€¼ä¸ºâ€œred\\0isâ€å’Œâ€œredis\\0â€ã€‚ç„¶åï¼Œæˆ‘ç”¨strlenå‡½æ•°è®¡ç®—è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>\t#include &lt;stdio.h&gt;\n\t#include &lt;string.h&gt;\n\tint main()\n\t{\n\t   char *a = &quot;red\\0is&quot;;\n\t   char *b = &quot;redis\\0&quot;;\n\t   printf(&quot;%lu\\n&quot;, strlen(a));\n\t   printf(&quot;%lu\\n&quot;, strlen(b));\n\t   return 0;\n\t}\n</code></pre><p>å½“ç¨‹åºæ‰§è¡Œå®Œè¿™æ®µä»£ç åï¼Œè¾“å‡ºçš„ç»“æœåˆ†åˆ«æ˜¯3å’Œ5ï¼Œè¡¨ç¤ºaå’Œbçš„é•¿åº¦åˆ†åˆ«æ˜¯3ä¸ªå­—ç¬¦å’Œ5ä¸ªå­—ç¬¦ã€‚è¿™æ˜¯å› ä¸ºaä¸­åœ¨â€œredâ€è¿™3ä¸ªå­—ç¬¦åï¼Œå°±æœ‰äº†ç»“æŸå­—ç¬¦â€œ\\0â€ï¼Œè€Œbä¸­çš„ç»“æŸå­—ç¬¦æ˜¯åœ¨â€œredisâ€5ä¸ªå­—ç¬¦åã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œchar*å­—ç¬¦ä¸²ä»¥â€œ\\0â€è¡¨ç¤ºå­—ç¬¦ä¸²çš„ç»“æŸï¼Œå…¶å®ä¼šç»™æˆ‘ä»¬ä¿å­˜æ•°æ®å¸¦æ¥ä¸€å®šçš„è´Ÿé¢å½±å“ã€‚å¦‚æœæˆ‘ä»¬è¦ä¿å­˜çš„æ•°æ®ä¸­ï¼Œæœ¬èº«å°±æœ‰â€œ\\0â€ï¼Œé‚£ä¹ˆæ•°æ®åœ¨â€œ\\0â€å¤„å°±ä¼šè¢«æˆªæ–­ï¼Œè€Œè¿™å°±<strong>ä¸ç¬¦åˆRediså¸Œæœ›èƒ½ä¿å­˜ä»»æ„äºŒè¿›åˆ¶æ•°æ®çš„éœ€æ±‚</strong>äº†ã€‚</p><h3>æ“ä½œå‡½æ•°å¤æ‚åº¦</h3><p>è€Œé™¤äº†char*å­—ç¬¦æ•°ç»„ç»“æ„çš„è®¾è®¡é—®é¢˜ä»¥å¤–ï¼Œä½¿ç”¨â€œ\\0â€ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“æŸå­—ç¬¦ï¼Œè™½ç„¶å¯ä»¥è®©å­—ç¬¦ä¸²æ“ä½œå‡½æ•°åˆ¤æ–­å­—ç¬¦ä¸²çš„ç»“æŸä½ç½®ï¼Œä½†å®ƒä¹Ÿä¼šå¸¦æ¥å¦ä¸€æ–¹é¢çš„è´Ÿé¢å½±å“ï¼Œä¹Ÿå°±æ˜¯ä¼šå¯¼è‡´æ“ä½œå‡½æ•°çš„å¤æ‚åº¦å¢åŠ ã€‚</p><p>æˆ‘è¿˜æ˜¯ä»¥strlenå‡½æ•°ä¸ºä¾‹ï¼Œè¯¥å‡½æ•°éœ€è¦éå†å­—ç¬¦æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œæ‰èƒ½å¾—åˆ°å­—ç¬¦ä¸²é•¿åº¦ï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œå‡½æ•°çš„å¤æ‚åº¦æ˜¯O(N)ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹å¦ä¸€ä¸ªå¸¸ç”¨çš„æ“ä½œå‡½æ•°ï¼š<strong>å­—ç¬¦ä¸²è¿½åŠ å‡½æ•°strcat</strong>ã€‚strcatå‡½æ•°æ˜¯å°†ä¸€ä¸ªæºå­—ç¬¦ä¸²srcè¿½åŠ åˆ°ä¸€ä¸ªç›®æ ‡å­—ç¬¦ä¸²çš„æœ«å°¾ã€‚è¯¥å‡½æ•°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>\tchar *strcat(char *dest, const char *src) {\n\t   //å°†ç›®æ ‡å­—ç¬¦ä¸²å¤åˆ¶ç»™tmpå˜é‡\n\t   char *tmp = dest;\n\t   //ç”¨ä¸€ä¸ªwhileå¾ªç¯éå†ç›®æ ‡å­—ç¬¦ä¸²ï¼Œç›´åˆ°é‡åˆ°â€œ\\0â€è·³å‡ºå¾ªç¯ï¼ŒæŒ‡å‘ç›®æ ‡å­—ç¬¦ä¸²çš„æœ«å°¾\n\t   while(*dest)\n\t      dest++;\n\t   //å°†æºå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦é€ä¸€èµ‹å€¼åˆ°ç›®æ ‡å­—ç¬¦ä¸²ä¸­ï¼Œç›´åˆ°é‡åˆ°ç»“æŸå­—ç¬¦\n\t   while((*dest++ = *src++) != '\\0' )\n\t   return tmp;\n\t}\n</code></pre><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œstrcatå‡½æ•°å’Œstrlenå‡½æ•°ç±»ä¼¼ï¼Œå¤æ‚åº¦éƒ½å¾ˆé«˜ï¼Œä¹Ÿéƒ½éœ€è¦å…ˆé€šè¿‡éå†å­—ç¬¦ä¸²æ‰èƒ½å¾—åˆ°ç›®æ ‡å­—ç¬¦ä¸²çš„æœ«å°¾ã€‚ç„¶åå¯¹äºstrcatå‡½æ•°æ¥è¯´ï¼Œè¿˜è¦å†éå†æºå­—ç¬¦ä¸²æ‰èƒ½å®Œæˆè¿½åŠ ã€‚å¦å¤–ï¼Œå®ƒåœ¨æŠŠæºå­—ç¬¦ä¸²è¿½åŠ åˆ°ç›®æ ‡å­—ç¬¦ä¸²æœ«å°¾æ—¶ï¼Œè¿˜éœ€è¦ç¡®è®¤ç›®æ ‡å­—ç¬¦ä¸²å…·æœ‰è¶³å¤Ÿçš„å¯ç”¨ç©ºé—´ï¼Œå¦åˆ™å°±æ— æ³•è¿½åŠ ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™å°±è¦æ±‚å¼€å‘äººå‘˜åœ¨è°ƒç”¨strcatæ—¶ï¼Œè¦ä¿è¯ç›®æ ‡å­—ç¬¦ä¸²æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œä¸ç„¶å°±éœ€è¦å¼€å‘äººå‘˜åŠ¨æ€åˆ†é…ç©ºé—´ï¼Œä»è€Œå¢åŠ äº†ç¼–ç¨‹çš„å¤æ‚åº¦ã€‚è€Œæ“ä½œå‡½æ•°çš„å¤æ‚åº¦ä¸€æ—¦å¢åŠ ï¼Œå°±ä¼šå½±å“å­—ç¬¦ä¸²çš„æ“ä½œæ•ˆç‡ï¼Œè¿™å°±<strong>ä¸ç¬¦åˆRediså¯¹å­—ç¬¦ä¸²é«˜æ•ˆæ“ä½œçš„éœ€æ±‚</strong>äº†ã€‚</p><p>å¥½äº†ï¼Œç»¼åˆä»¥ä¸Šåœ¨Cè¯­è¨€ä¸­ä½¿ç”¨char*å®ç°å­—ç¬¦ä¸²çš„ä¸¤å¤§ä¸è¶³ä¹‹å¤„ä»¥åï¼Œæˆ‘ä»¬ç°åœ¨å°±éœ€è¦æ‰¾åˆ°æ–°çš„å®ç°å­—ç¬¦ä¸²çš„æ–¹å¼äº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸‹ï¼ŒRedisæ˜¯å¦‚ä½•å¯¹å­—ç¬¦ä¸²çš„å®ç°è¿›è¡Œè®¾è®¡è€ƒè™‘çš„ã€‚</p><h2>SDSçš„è®¾è®¡æ€æƒ³</h2><p>å› ä¸ºRedisæ˜¯ä½¿ç”¨Cè¯­è¨€å¼€å‘çš„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯èƒ½å°½é‡å¤ç”¨Cæ ‡å‡†åº“ä¸­çš„å­—ç¬¦ä¸²æ“ä½œå‡½æ•°ï¼ŒRedisä¿ç•™äº†ä½¿ç”¨å­—ç¬¦æ•°ç»„æ¥ä¿å­˜å®é™…çš„æ•°æ®ã€‚ä½†æ˜¯ï¼Œå’ŒCè¯­è¨€ä»…ç”¨å­—ç¬¦æ•°ç»„ä¸åŒï¼ŒRedisè¿˜ä¸“é—¨è®¾è®¡äº†SDSï¼ˆå³ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰çš„æ•°æ®ç»“æ„ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ã€‚</p><h3>SDSç»“æ„è®¾è®¡</h3><p>é¦–å…ˆï¼ŒSDSç»“æ„é‡ŒåŒ…å«äº†ä¸€ä¸ªå­—ç¬¦æ•°ç»„buf[]ï¼Œç”¨æ¥ä¿å­˜å®é™…æ•°æ®ã€‚åŒæ—¶ï¼ŒSDSç»“æ„é‡Œè¿˜åŒ…å«äº†ä¸‰ä¸ªå…ƒæ•°æ®ï¼Œåˆ†åˆ«æ˜¯<strong>å­—ç¬¦æ•°ç»„ç°æœ‰é•¿åº¦len</strong>ã€<strong>åˆ†é…ç»™å­—ç¬¦æ•°ç»„çš„ç©ºé—´é•¿åº¦alloc</strong>ï¼Œä»¥åŠ<strong>SDSç±»å‹flags</strong>ã€‚å…¶ä¸­ï¼ŒRedisç»™lenå’Œallocè¿™ä¸¤ä¸ªå…ƒæ•°æ®å®šä¹‰äº†å¤šç§æ•°æ®ç±»å‹ï¼Œè¿›è€Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºä¸åŒç±»å‹çš„SDSï¼Œç¨åæˆ‘ä¼šç»™ä½ å…·ä½“ä»‹ç»ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†SDSçš„ç»“æ„ï¼Œä½ å¯ä»¥å…ˆçœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/77/a3/772d340bfbfe52de3a66fbb011ac22a3.jpg?wh=1891x647\" alt=\"\"></p><p>å¦å¤–ï¼Œå¦‚æœä½ åœ¨Redisæºç ä¸­æŸ¥æ‰¾è¿‡SDSçš„å®šä¹‰ï¼Œé‚£ä½ å¯èƒ½ä¼šçœ‹åˆ°ï¼ŒRedisä½¿ç”¨typedefç»™char*ç±»å‹å®šä¹‰äº†ä¸€ä¸ªåˆ«åï¼Œè¿™ä¸ªåˆ«åå°±æ˜¯sdsï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>typedef char *sds;\n</code></pre><p>å…¶å®ï¼Œè¿™æ˜¯å› ä¸ºSDSæœ¬è´¨è¿˜æ˜¯å­—ç¬¦æ•°ç»„ï¼Œåªæ˜¯åœ¨å­—ç¬¦æ•°ç»„åŸºç¡€ä¸Šå¢åŠ äº†é¢å¤–çš„å…ƒæ•°æ®ã€‚åœ¨Redisä¸­éœ€è¦ç”¨åˆ°å­—ç¬¦æ•°ç»„æ—¶ï¼Œå°±ç›´æ¥ä½¿ç”¨sdsè¿™ä¸ªåˆ«åã€‚</p><p>åŒæ—¶ï¼Œåœ¨åˆ›å»ºæ–°çš„å­—ç¬¦ä¸²æ—¶ï¼ŒRedisä¼šè°ƒç”¨SDSåˆ›å»ºå‡½æ•°sdsnewlenã€‚sdsnewlenå‡½æ•°ä¼šæ–°å»ºsdsç±»å‹å˜é‡ï¼ˆä¹Ÿå°±æ˜¯char*ç±»å‹å˜é‡ï¼‰ï¼Œå¹¶æ–°å»ºSDSç»“æ„ä½“ï¼ŒæŠŠSDSç»“æ„ä½“ä¸­çš„æ•°ç»„buf[] èµ‹ç»™sdsç±»å‹å˜é‡ã€‚æœ€åï¼Œsdsnewlenå‡½æ•°ä¼šæŠŠè¦åˆ›å»ºçš„å­—ç¬¦ä¸²æ‹·è´ç»™sdså˜é‡ã€‚ä¸‹é¢çš„ä»£ç å°±æ˜¾ç¤ºäº†sdsnewlenå‡½æ•°çš„è¿™ä¸ªæ“ä½œé€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>sds sdsnewlen(const void *init, size_t initlen) {\n    void *sh;  //æŒ‡å‘SDSç»“æ„ä½“çš„æŒ‡é’ˆ\n    sds s;     //sdsç±»å‹å˜é‡ï¼Œå³char*å­—ç¬¦æ•°ç»„\n\n    ...\n    sh = s_malloc(hdrlen+initlen+1);   //æ–°å»ºSDSç»“æ„ï¼Œå¹¶åˆ†é…å†…å­˜ç©ºé—´\n    ...\n    s = (char*)sh+hdrlen;              //sdsç±»å‹å˜é‡æŒ‡å‘SDSç»“æ„ä½“ä¸­çš„bufæ•°ç»„ï¼ŒshæŒ‡å‘SDSç»“æ„ä½“èµ·å§‹ä½ç½®ï¼Œhdrlenæ˜¯SDSç»“æ„ä½“ä¸­å…ƒæ•°æ®çš„é•¿åº¦\n    ...\n    if (initlen &amp;&amp; init)\n        memcpy(s, init, initlen);    //å°†è¦ä¼ å…¥çš„å­—ç¬¦ä¸²æ‹·è´ç»™sdså˜é‡s\n    s[initlen] = '\\0';               //å˜é‡sæœ«å°¾å¢åŠ \\0ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²ç»“æŸ\n    return s;\n</code></pre><p>å¥½äº†ï¼Œäº†è§£äº†SDSç»“æ„çš„å®šä¹‰åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ï¼Œç›¸æ¯”ä¼ ç»ŸCè¯­è¨€å­—ç¬¦ä¸²ï¼ŒSDSæ“ä½œæ•ˆç‡çš„æ”¹è¿›ä¹‹å¤„ã€‚</p><h3>SDSæ“ä½œæ•ˆç‡</h3><p>å› ä¸ºSDSç»“æ„ä¸­è®°å½•äº†å­—ç¬¦æ•°ç»„å·²å ç”¨çš„ç©ºé—´å’Œè¢«åˆ†é…çš„ç©ºé—´ï¼Œè¿™å°±æ¯”ä¼ ç»ŸCè¯­è¨€å®ç°çš„å­—ç¬¦ä¸²èƒ½å¸¦æ¥æ›´é«˜çš„æ“ä½œæ•ˆç‡ã€‚</p><p>æˆ‘è¿˜æ˜¯ä»¥å­—ç¬¦ä¸²è¿½åŠ æ“ä½œä¸ºä¾‹ã€‚Redisä¸­å®ç°å­—ç¬¦ä¸²è¿½åŠ çš„å‡½æ•°æ˜¯sds.cæ–‡ä»¶ä¸­çš„<strong>sdscatlenå‡½æ•°</strong>ã€‚è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸€å…±æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ç›®æ ‡å­—ç¬¦ä¸²sã€æºå­—ç¬¦ä¸²tå’Œè¦è¿½åŠ çš„é•¿åº¦lenï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>sds sdscatlen(sds s, const void *t, size_t len) {\n    //è·å–ç›®æ ‡å­—ç¬¦ä¸²sçš„å½“å‰é•¿åº¦\n    size_t curlen = sdslen(s);\n    //æ ¹æ®è¦è¿½åŠ çš„é•¿åº¦lenå’Œç›®æ ‡å­—ç¬¦ä¸²sçš„ç°æœ‰é•¿åº¦ï¼Œåˆ¤æ–­æ˜¯å¦è¦å¢åŠ æ–°çš„ç©ºé—´\n    s = sdsMakeRoomFor(s,len);\n    if (s == NULL) return NULL;\n    //å°†æºå­—ç¬¦ä¸²tä¸­lené•¿åº¦çš„æ•°æ®æ‹·è´åˆ°ç›®æ ‡å­—ç¬¦ä¸²ç»“å°¾\n    memcpy(s+curlen, t, len);\n    //è®¾ç½®ç›®æ ‡å­—ç¬¦ä¸²çš„æœ€æ–°é•¿åº¦ï¼šæ‹·è´å‰é•¿åº¦curlenåŠ ä¸Šæ‹·è´é•¿åº¦\n    sdssetlen(s, curlen+len);\n    //æ‹·è´åï¼Œåœ¨ç›®æ ‡å­—ç¬¦ä¸²ç»“å°¾åŠ ä¸Š\\0\n    s[curlen+len] = '\\0';\n    return s;\n}\n</code></pre><p>é€šè¿‡åˆ†æè¿™ä¸ªå‡½æ•°çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°sdscatlençš„å®ç°è¾ƒä¸ºç®€å•ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ul>\n<li>é¦–å…ˆï¼Œè·å–ç›®æ ‡å­—ç¬¦ä¸²çš„å½“å‰é•¿åº¦ï¼Œå¹¶è°ƒç”¨sdsMakeRoomForå‡½æ•°ï¼Œæ ¹æ®å½“å‰é•¿åº¦å’Œè¦è¿½åŠ çš„é•¿åº¦ï¼Œåˆ¤æ–­æ˜¯å¦è¦ç»™ç›®æ ‡å­—ç¬¦ä¸²æ–°å¢ç©ºé—´ã€‚è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä¿è¯ï¼Œç›®æ ‡å­—ç¬¦ä¸²æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥æ”¶è¿½åŠ çš„å­—ç¬¦ä¸²ã€‚</li>\n<li>å…¶æ¬¡ï¼Œåœ¨ä¿è¯äº†ç›®æ ‡å­—ç¬¦ä¸²çš„ç©ºé—´è¶³å¤Ÿåï¼Œå°†æºå­—ç¬¦ä¸²ä¸­æŒ‡å®šé•¿åº¦lençš„æ•°æ®è¿½åŠ åˆ°ç›®æ ‡å­—ç¬¦ä¸²ã€‚</li>\n<li>æœ€åï¼Œè®¾ç½®ç›®æ ‡å­—ç¬¦ä¸²çš„æœ€æ–°é•¿åº¦ã€‚</li>\n</ul><p>æˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œæ˜¾ç¤ºäº†sdscatlençš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/84/3d/845fd7e227f419b1e6c084cdf051ec3d.jpg?wh=2000x1125\" alt=\"\"></p><p>æ‰€ä»¥ï¼Œåˆ°è¿™é‡Œä½ å°±èƒ½å‘ç°ï¼Œå’ŒCè¯­è¨€ä¸­çš„å­—ç¬¦ä¸²æ“ä½œç›¸æ¯”ï¼ŒSDSé€šè¿‡è®°å½•å­—ç¬¦æ•°ç»„çš„ä½¿ç”¨é•¿åº¦å’Œåˆ†é…ç©ºé—´å¤§å°ï¼Œé¿å…äº†å¯¹å­—ç¬¦ä¸²çš„éå†æ“ä½œï¼Œé™ä½äº†æ“ä½œå¼€é”€ï¼Œè¿›ä¸€æ­¥å°±å¯ä»¥å¸®åŠ©è¯¸å¤šå­—ç¬¦ä¸²æ“ä½œæ›´åŠ é«˜æ•ˆåœ°å®Œæˆï¼Œæ¯”å¦‚åˆ›å»ºã€è¿½åŠ ã€å¤åˆ¶ã€æ¯”è¾ƒç­‰ï¼Œè¿™ä¸€è®¾è®¡æ€æƒ³éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p><p>æ­¤å¤–ï¼ŒSDSæŠŠç›®æ ‡å­—ç¬¦ä¸²çš„<strong>ç©ºé—´æ£€æŸ¥å’Œæ‰©å®¹å°è£…åœ¨äº†sdsMakeRoomForå‡½æ•°ä¸­</strong>ï¼Œå¹¶ä¸”åœ¨æ¶‰åŠå­—ç¬¦ä¸²ç©ºé—´å˜åŒ–çš„æ“ä½œä¸­ï¼Œå¦‚è¿½åŠ ã€å¤åˆ¶ç­‰ï¼Œä¼šç›´æ¥è°ƒç”¨è¯¥å‡½æ•°ã€‚</p><p>è¿™ä¸€è®¾è®¡å®ç°ï¼Œå°±é¿å…äº†å¼€å‘äººå‘˜å› å¿˜è®°ç»™ç›®æ ‡å­—ç¬¦ä¸²æ‰©å®¹ï¼Œè€Œå¯¼è‡´æ“ä½œå¤±è´¥çš„æƒ…å†µã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨å‡½æ•°strcpy (char *dest, const char *src)æ—¶ï¼Œå¦‚æœsrcçš„é•¿åº¦å¤§äºdestçš„é•¿åº¦ï¼Œä»£ç ä¸­æˆ‘ä»¬ä¹Ÿæ²¡æœ‰åšæ£€æŸ¥çš„è¯ï¼Œå°±ä¼šé€ æˆå†…å­˜æº¢å‡ºã€‚æ‰€ä»¥è¿™ç§å°è£…æ“ä½œçš„è®¾è®¡æ€æƒ³ï¼ŒåŒæ ·å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p><p>é‚£ä¹ˆï¼Œé™¤äº†ä½¿ç”¨å…ƒæ•°æ®è®°å½•å­—ç¬¦ä¸²æ•°ç»„é•¿åº¦å’Œå°è£…æ“ä½œçš„è®¾è®¡æ€æƒ³ï¼ŒSDSè¿˜æœ‰ä»€ä¹ˆä¼˜ç§€çš„è®¾è®¡ä¸å®ç°å€¼å¾—æˆ‘ä»¬å­¦ä¹ å‘¢ï¼Ÿè¿™å°±å’Œæˆ‘åˆšæ‰ç»™ä½ ä»‹ç»çš„Rediså¯¹å†…å­˜èŠ‚çœçš„éœ€æ±‚ç›¸å…³äº†ã€‚</p><p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹SDSåœ¨ç¼–ç¨‹æŠ€å·§ä¸Šæ˜¯å¦‚ä½•å®ç°èŠ‚çœå†…å­˜çš„ã€‚</p><h2>ç´§å‡‘å‹å­—ç¬¦ä¸²ç»“æ„çš„ç¼–ç¨‹æŠ€å·§</h2><p>å‰é¢æˆ‘æåˆ°ï¼ŒSDSç»“æ„ä¸­æœ‰ä¸€ä¸ªå…ƒæ•°æ®flagsï¼Œè¡¨ç¤ºçš„æ˜¯SDSç±»å‹ã€‚äº‹å®ä¸Šï¼ŒSDSä¸€å…±è®¾è®¡äº†5ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯sdshdr5ã€sdshdr8ã€sdshdr16ã€sdshdr32å’Œsdshdr64ã€‚è¿™5ç§ç±»å‹çš„<strong>ä¸»è¦åŒºåˆ«å°±åœ¨äº</strong>ï¼Œå®ƒä»¬æ•°æ®ç»“æ„ä¸­çš„å­—ç¬¦æ•°ç»„ç°æœ‰é•¿åº¦lenå’Œåˆ†é…ç©ºé—´é•¿åº¦allocï¼Œè¿™ä¸¤ä¸ªå…ƒæ•°æ®çš„æ•°æ®ç±»å‹ä¸åŒã€‚</p><p>å› ä¸ºsdshdr5è¿™ä¸€ç±»å‹Rediså·²ç»ä¸å†ä½¿ç”¨äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¸»è¦æ¥äº†è§£ä¸‹å‰©ä½™çš„4ç§ç±»å‹ã€‚ä»¥sdshdr8ä¸ºä¾‹ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>struct __attribute__ ((__packed__)) sdshdr8 {\n    uint8_t len; /* å­—ç¬¦æ•°ç»„ç°æœ‰é•¿åº¦*/\n    uint8_t alloc; /* å­—ç¬¦æ•°ç»„çš„å·²åˆ†é…ç©ºé—´ï¼Œä¸åŒ…æ‹¬ç»“æ„ä½“å’Œ\\0ç»“æŸå­—ç¬¦*/\n    unsigned char flags; /* SDSç±»å‹*/\n    char buf[]; /*å­—ç¬¦æ•°ç»„*/\n};\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç°æœ‰é•¿åº¦lenå’Œå·²åˆ†é…ç©ºé—´allocçš„æ•°æ®ç±»å‹éƒ½æ˜¯uint8_tã€‚<strong>uint8_tæ˜¯8ä½æ— ç¬¦å·æ•´å‹</strong>ï¼Œä¼šå ç”¨1å­—èŠ‚çš„å†…å­˜ç©ºé—´ã€‚å½“å­—ç¬¦ä¸²ç±»å‹æ˜¯sdshdr8æ—¶ï¼Œå®ƒèƒ½è¡¨ç¤ºçš„å­—ç¬¦æ•°ç»„é•¿åº¦ï¼ˆåŒ…æ‹¬æ•°ç»„æœ€åä¸€ä½\\0ï¼‰ä¸ä¼šè¶…è¿‡256å­—èŠ‚ï¼ˆ2çš„8æ¬¡æ–¹ç­‰äº256ï¼‰ã€‚</p><p>è€Œå¯¹äºsdshdr16ã€sdshdr32ã€sdshdr64ä¸‰ç§ç±»å‹æ¥è¯´ï¼Œå®ƒä»¬çš„lenå’Œallocæ•°æ®ç±»å‹åˆ†åˆ«æ˜¯uint16_tã€uint32_tã€uint64_tï¼Œå³å®ƒä»¬èƒ½è¡¨ç¤ºçš„å­—ç¬¦æ•°ç»„é•¿åº¦ï¼Œåˆ†åˆ«ä¸è¶…è¿‡2çš„16æ¬¡æ–¹ã€32æ¬¡æ–¹å’Œ64æ¬¡æ–¹ã€‚è¿™ä¸¤ä¸ªå…ƒæ•°æ®å„è‡ªå ç”¨çš„å†…å­˜ç©ºé—´åœ¨sdshdr16ã€sdshdr32ã€sdshdr64ç±»å‹ä¸­ï¼Œåˆ™åˆ†åˆ«æ˜¯2å­—èŠ‚ã€4å­—èŠ‚å’Œ8å­—èŠ‚ã€‚</p><p>å®é™…ä¸Šï¼Œ<strong>SDSä¹‹æ‰€ä»¥è®¾è®¡ä¸åŒçš„ç»“æ„å¤´ï¼ˆå³ä¸åŒç±»å‹ï¼‰ï¼Œæ˜¯ä¸ºäº†èƒ½çµæ´»ä¿å­˜ä¸åŒå¤§å°çš„å­—ç¬¦ä¸²ï¼Œä»è€Œæœ‰æ•ˆèŠ‚çœå†…å­˜ç©ºé—´ã€‚</strong>å› ä¸ºåœ¨ä¿å­˜ä¸åŒå¤§å°çš„å­—ç¬¦ä¸²æ—¶ï¼Œç»“æ„å¤´å ç”¨çš„å†…å­˜ç©ºé—´ä¹Ÿä¸ä¸€æ ·ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨ä¿å­˜å°å­—ç¬¦ä¸²æ—¶ï¼Œç»“æ„å¤´å ç”¨ç©ºé—´ä¹Ÿæ¯”è¾ƒå°‘ã€‚</p><p>å¦åˆ™ï¼Œå‡è®¾SDSéƒ½è®¾è®¡ä¸€æ ·å¤§å°çš„ç»“æ„å¤´ï¼Œæ¯”å¦‚éƒ½ä½¿ç”¨uint64_tç±»å‹è¡¨ç¤ºlenå’Œallocï¼Œé‚£ä¹ˆå‡è®¾è¦ä¿å­˜çš„å­—ç¬¦ä¸²æ˜¯10ä¸ªå­—èŠ‚ï¼Œè€Œæ­¤æ—¶ç»“æ„å¤´ä¸­lenå’Œallocæœ¬èº«å°±å ç”¨äº†16ä¸ªå­—èŠ‚äº†ï¼Œæ¯”ä¿å­˜çš„æ•°æ®éƒ½å¤šäº†ã€‚æ‰€ä»¥è¿™æ ·çš„è®¾è®¡å¯¹å†…å­˜å¹¶ä¸å‹å¥½ï¼Œä¹Ÿä¸æ»¡è¶³RedisèŠ‚çœå†…å­˜çš„éœ€æ±‚ã€‚</p><p>å¥½äº†ï¼Œé™¤äº†è®¾è®¡ä¸åŒç±»å‹çš„ç»“æ„å¤´ï¼ŒRedisåœ¨ç¼–ç¨‹ä¸Šè¿˜<strong>ä½¿ç”¨äº†ä¸“é—¨çš„ç¼–è¯‘ä¼˜åŒ–æ¥èŠ‚çœå†…å­˜ç©ºé—´</strong>ã€‚åœ¨åˆšæ‰ä»‹ç»çš„sdshdr8ç»“æ„å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨structå’Œsdshdr8ä¹‹é—´ä½¿ç”¨äº†<code>__attribute__ ((__packed__))</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>struct __attribute__ ((__packed__)) sdshdr8\n</code></pre><p>å…¶å®è¿™é‡Œï¼Œ<code>__attribute__ ((__packed__))</code>çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œåœ¨ç¼–è¯‘sdshdr8ç»“æ„æ—¶ï¼Œä¸è¦ä½¿ç”¨å­—èŠ‚å¯¹é½çš„æ–¹å¼ï¼Œè€Œæ˜¯<strong>é‡‡ç”¨ç´§å‡‘çš„æ–¹å¼åˆ†é…å†…å­˜</strong>ã€‚è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæŒ‰ç…§8å­—èŠ‚å¯¹é½çš„æ–¹å¼ï¼Œç»™å˜é‡åˆ†é…å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ä¸€ä¸ªå˜é‡çš„å¤§å°ä¸åˆ°8ä¸ªå­—èŠ‚ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šç»™å®ƒåˆ†é…8ä¸ªå­—èŠ‚ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘ç»™ä½ ä¸¾ä¸ªä¾‹å­ã€‚å‡è®¾æˆ‘å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“s1ï¼Œå®ƒæœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œç±»å‹åˆ†åˆ«æ˜¯charå’Œintï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>\t#include &lt;stdio.h&gt;\n\tint main() {\n\t   struct s1 {\n\t      char a;\n\t      int b;\n\t   } ts1;\n\t   printf(&quot;%lu\\n&quot;, sizeof(ts1));\n\t   return 0;\n\t}\n</code></pre><p>è™½ç„¶charç±»å‹å ç”¨1ä¸ªå­—èŠ‚ï¼Œintç±»å‹å ç”¨4ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å¦‚æœä½ è¿è¡Œè¿™æ®µä»£ç ï¼Œå°±ä¼šå‘ç°æ‰“å°å‡ºæ¥çš„ç»“æœæ˜¯8ã€‚è¿™å°±æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç»™s1ç»“æ„ä½“åˆ†é…8ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œè€Œè¿™æ ·å…¶ä¸­å°±æœ‰3ä¸ªå­—èŠ‚è¢«æµªè´¹æ‰äº†ã€‚</p><p>ä¸ºäº†èŠ‚çœå†…å­˜ï¼ŒRedisåœ¨è¿™æ–¹é¢çš„è®¾è®¡ä¸Šå¯ä»¥è¯´æ˜¯ç²¾æ‰“ç»†ç®—çš„ã€‚æ‰€ä»¥ï¼ŒRedisé‡‡ç”¨äº†<code>__attribute__ ((__packed__))</code>å±æ€§å®šä¹‰ç»“æ„ä½“ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç»“æ„ä½“å®é™…å ç”¨å¤šå°‘å†…å­˜ç©ºé—´ï¼Œç¼–è¯‘å™¨å°±åˆ†é…å¤šå°‘ç©ºé—´ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ç”¨<code>__attribute__ ((__packed__))</code>å±æ€§å®šä¹‰ç»“æ„ä½“s2ï¼ŒåŒæ ·åŒ…å«charå’Œintä¸¤ä¸ªç±»å‹çš„æˆå‘˜å˜é‡ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>\t#include &lt;stdio.h&gt;\n\tint main() {\n\t   struct __attribute__((packed)) s2{\n\t      char a;\n\t      int b;\n\t   } ts2;\n\t   printf(&quot;%lu\\n&quot;, sizeof(ts2));\n\t   return 0;\n\t}\n</code></pre><p>å½“ä½ è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œæ‰“å°çš„ç»“æœæ˜¯5ï¼Œè¡¨ç¤ºç¼–è¯‘å™¨ç”¨äº†ç´§å‡‘å‹å†…å­˜åˆ†é…ï¼Œs2ç»“æ„ä½“åªå ç”¨5ä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚</p><p>å¥½äº†ï¼Œæ€»è€Œè¨€ä¹‹ï¼Œå¦‚æœä½ åœ¨å¼€å‘ç¨‹åºæ—¶ï¼Œå¸Œæœ›èƒ½èŠ‚çœæ•°æ®ç»“æ„çš„å†…å­˜å¼€é”€ï¼Œå°±å¯ä»¥æŠŠ<code>__attribute__ ((__packed__))</code>è¿™ä¸ªç¼–ç¨‹æ–¹æ³•ç”¨èµ·æ¥ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä¸»è¦ç»™ä½ ä»‹ç»äº†Redisä¸­å­—ç¬¦ä¸²çš„è®¾è®¡ä¸å®ç°ã€‚ä½ è¦çŸ¥é“ï¼Œå­—ç¬¦ä¸²çš„å®ç°éœ€è¦è€ƒè™‘æ“ä½œé«˜æ•ˆã€èƒ½ä¿å­˜ä»»æ„äºŒè¿›åˆ¶æ•°æ®ï¼Œä»¥åŠèŠ‚çœå†…å­˜çš„éœ€æ±‚ã€‚è€ŒRedisä¸­è®¾è®¡å®ç°å­—ç¬¦ä¸²çš„æ–¹å¼ï¼Œå°±éå¸¸å€¼å¾—ä½ å­¦ä¹ å’Œå€Ÿé‰´ã€‚</p><p>å› æ­¤è¿™èŠ‚è¯¾ï¼Œä½ éœ€è¦é‡ç‚¹å…³æ³¨ä¸‰ä¸ªè¦ç‚¹ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul>\n<li>Cè¯­è¨€ä¸­ä½¿ç”¨char*å®ç°å­—ç¬¦ä¸²çš„ä¸è¶³ï¼Œä¸»è¦æ˜¯å› ä¸ºä½¿ç”¨â€œ\\0â€è¡¨ç¤ºå­—ç¬¦ä¸²ç»“æŸï¼Œæ“ä½œæ—¶éœ€éå†å­—ç¬¦ä¸²ï¼Œæ•ˆç‡ä¸é«˜ï¼Œå¹¶ä¸”æ— æ³•å®Œæ•´è¡¨ç¤ºåŒ…å«â€œ\\0â€çš„æ•°æ®ï¼Œå› è€Œè¿™å°±æ— æ³•æ»¡è¶³Redisçš„éœ€æ±‚ã€‚</li>\n<li>Redisä¸­å­—ç¬¦ä¸²çš„è®¾è®¡æ€æƒ³ä¸å®ç°æ–¹æ³•ã€‚Redisä¸“é—¨è®¾è®¡äº†SDSæ•°æ®ç»“æ„ï¼Œåœ¨å­—ç¬¦æ•°ç»„çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å­—ç¬¦æ•°ç»„é•¿åº¦å’Œåˆ†é…ç©ºé—´å¤§å°ç­‰å…ƒæ•°æ®ã€‚è¿™æ ·ä¸€æ¥ï¼Œéœ€è¦åŸºäºå­—ç¬¦ä¸²é•¿åº¦è¿›è¡Œçš„è¿½åŠ ã€å¤åˆ¶ã€æ¯”è¾ƒç­‰æ“ä½œï¼Œå°±å¯ä»¥ç›´æ¥è¯»å–å…ƒæ•°æ®ï¼Œæ•ˆç‡ä¹Ÿå°±æå‡äº†ã€‚è€Œä¸”ï¼ŒSDSä¸é€šè¿‡å­—ç¬¦ä¸²ä¸­çš„â€œ\\0â€å­—ç¬¦åˆ¤æ–­å­—ç¬¦ä¸²ç»“æŸï¼Œè€Œæ˜¯ç›´æ¥å°†å…¶ä½œä¸ºäºŒè¿›åˆ¶æ•°æ®å¤„ç†ï¼Œå¯ä»¥ç”¨æ¥ä¿å­˜å›¾ç‰‡ç­‰äºŒè¿›åˆ¶æ•°æ®ã€‚</li>\n<li>SDSä¸­æ˜¯é€šè¿‡è®¾è®¡ä¸åŒSDSç±»å‹æ¥è¡¨ç¤ºä¸åŒå¤§å°çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨<code>__attribute__ ((__packed__))</code>è¿™ä¸ªç¼–ç¨‹å°æŠ€å·§ï¼Œæ¥å®ç°ç´§å‡‘å‹å†…å­˜å¸ƒå±€ï¼Œè¾¾åˆ°èŠ‚çœå†…å­˜çš„ç›®çš„ã€‚</li>\n</ul><p>å­—ç¬¦ä¸²çœ‹èµ·æ¥ç®€å•ï¼Œä½†é€šè¿‡ä»Šå¤©è¿™èŠ‚è¯¾çš„å­¦ä¹ ï¼Œä½ å¯ä»¥çœ‹åˆ°å®ç°å­—ç¬¦ä¸²æœ‰å¾ˆå¤šéœ€è¦ç²¾å·§è®¾è®¡çš„åœ°æ–¹ã€‚Cè¯­è¨€å­—ç¬¦ä¸²çš„å®ç°æ–¹æ³•å’ŒSDSçš„è”ç³»ä¸åŒºåˆ«ï¼Œä¹Ÿæ˜¯Redisé¢è¯•æ—¶ç»å¸¸ä¼šè¢«é—®åˆ°çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿå¸Œæœ›ä½ èƒ½é€šè¿‡ä»Šå¤©è¿™èŠ‚è¯¾ï¼ŒæŒæ¡å¥½å®ƒä¿©çš„åŒºåˆ«ã€‚</p><h2>æ¯è¯¾ä¸€é—®</h2><p>SDSå­—ç¬¦ä¸²åœ¨Rediså†…éƒ¨æ¨¡å—å®ç°ä¸­ä¹Ÿè¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½ èƒ½åœ¨Redis serverå’Œå®¢æˆ·ç«¯çš„å®ç°ä¸­ï¼Œæ‰¾åˆ°ä½¿ç”¨SDSå­—ç¬¦ä¸²çš„åœ°æ–¹ä¹ˆï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒå’Œæ“ä½œè¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":304593,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1627494871,"is_pvip":true,"discussion_count":14,"race_medal":0,"score":"379584616919","product_id":100084301,"comment_content":"char* çš„ä¸è¶³ï¼š<br>- æ“ä½œæ•ˆç‡ä½ï¼šè·å–é•¿åº¦éœ€éå†ï¼ŒO(N)å¤æ‚åº¦<br>- äºŒè¿›åˆ¶ä¸å®‰å…¨ï¼šæ— æ³•å­˜å‚¨åŒ…å« \\0 çš„æ•°æ®<br><br>SDS çš„ä¼˜åŠ¿ï¼š<br>- æ“ä½œæ•ˆç‡é«˜ï¼šè·å–é•¿åº¦æ— éœ€éå†ï¼ŒO(1)å¤æ‚åº¦<br>- äºŒè¿›åˆ¶å®‰å…¨ï¼šå› å•ç‹¬è®°å½•é•¿åº¦å­—æ®µï¼Œæ‰€ä»¥å¯å­˜å‚¨åŒ…å« \\0 çš„æ•°æ®<br>- å…¼å®¹ C å­—ç¬¦ä¸²å‡½æ•°ï¼Œå¯ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸² API<br><br>å¦å¤– Redis åœ¨æ“ä½œ SDS æ—¶ï¼Œä¸ºäº†é¿å…é¢‘ç¹æ“ä½œå­—ç¬¦ä¸²æ—¶ï¼Œæ¯æ¬¡ã€Œç”³è¯·ã€é‡Šæ”¾ã€å†…å­˜çš„å¼€é”€ï¼Œè¿˜åšäº†è¿™äº›ä¼˜åŒ–ï¼š<br>- å†…å­˜é¢„åˆ†é…ï¼šSDS æ‰©å®¹ï¼Œä¼šå¤šç”³è¯·ä¸€äº›å†…å­˜ï¼ˆå°äº 1MB ç¿»å€æ‰©å®¹ï¼Œå¤§äº 1MB æŒ‰ 1MB æ‰©å®¹ï¼‰<br>- å¤šä½™å†…å­˜ä¸é‡Šæ”¾ï¼šSDS ç¼©å®¹ï¼Œä¸é‡Šæ”¾å¤šä½™çš„å†…å­˜ï¼Œä¸‹æ¬¡ä½¿ç”¨å¯ç›´æ¥å¤ç”¨è¿™äº›å†…å­˜<br><br>è¿™ç§ç­–ç•¥ï¼Œæ˜¯ä»¥å¤šå ä¸€äº›å†…å­˜çš„æ–¹å¼ï¼Œæ¢å–ã€Œè¿½åŠ ã€æ“ä½œçš„é€Ÿåº¦ã€‚<br><br>è¿™ä¸ªå†…å­˜é¢„åˆ†é…ç­–ç•¥ï¼Œè¯¦ç»†é€»è¾‘å¯ä»¥çœ‹ sds.c çš„ sdsMakeRoomFor å‡½æ•°ã€‚<br><br>è¯¾åé¢˜ï¼šSDS å­—ç¬¦ä¸²åœ¨ Redis å†…éƒ¨æ¨¡å—å®ç°ä¸­ä¹Ÿè¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½ èƒ½åœ¨ Redis server å’Œå®¢æˆ·ç«¯çš„å®ç°ä¸­ï¼Œæ‰¾åˆ°ä½¿ç”¨ SDS å­—ç¬¦ä¸²çš„åœ°æ–¹ä¹ˆï¼Ÿ<br><br>1ã€Redis ä¸­æ‰€æœ‰ key çš„ç±»å‹å°±æ˜¯ SDSï¼ˆè¯¦è§ db.c çš„ dbAdd å‡½æ•°ï¼‰<br><br>2ã€Redis Server åœ¨è¯»å– Client å‘æ¥çš„è¯·æ±‚æ—¶ï¼Œä¼šå…ˆè¯»åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼Œè¿™ä¸ªç¼“å†²åŒºä¹Ÿæ˜¯ SDSï¼ˆè¯¦è§ server.h ä¸­ struct client çš„ querybuf å­—æ®µï¼‰<br><br>3ã€å†™æ“ä½œè¿½åŠ åˆ° AOF æ—¶ï¼Œä¹Ÿä¼šå…ˆå†™åˆ° AOF ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºä¹Ÿæ˜¯ SDS ï¼ˆè¯¦è§ server.h ä¸­ struct client çš„ aof_buf å­—æ®µï¼‰<br>","like_count":88,"discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386386,"discussion_content":"string é™åˆ¶ 512M å’Œ sds çš„ç»“æ„æ²¡æœ‰ç›´æ¥å…³ç³»çš„ï¼Œ512M è¿™ä¸ªå€¼æ˜¯ Redis ä½œè€…äººä¸ºé™åˆ¶çš„é•¿åº¦ï¼Œä½ å¯ä»¥çœ‹çœ‹ t_string.c çš„ checkStringLength å‡½æ•°ï¼š\n\nstatic int checkStringLength(redisClient *c, long long size) {\n    if (size > 512*1024*1024) {\n        addReplyError(c,&#34;string exceeds maximum allowed size (512MB)&#34;);\n        return REDIS_ERR;\n    }\n    return REDIS_OK;\n}","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1627560441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2328010,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/FKYLNOAwgmAddtEAleFTgv0vvbibummCWW7CZsAKEABMqgB79JHrejzy5eic6T6XLa9HBcz4yCIlr81Na00YEAIQ/132","nickname":"å¬é—»","note":"","ucode":"64AD4D8249DFA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":540034,"discussion_content":"å¯èƒ½å’Œsetbitæœ‰å…³ï¼Ÿ512mçš„bitæœ€å¤§ä½åˆ°äº†uint32æœ€å¤§æ•°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639924195,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386386,"ip_address":""},"score":540034,"extra":""}]},{"author":{"id":2743620,"avatar":"","nickname":"Geek_8d3e0a","note":"","ucode":"D387929EE2B37B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557586,"discussion_content":"æˆ‘çˆ±è¯¾ä»£è¡¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647871845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2532285,"avatar":"","nickname":"Geek_926921","note":"","ucode":"51C3B0178D77E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393784,"discussion_content":"è¯¾ä»£è¡¨æ€»ç»“å¿…çœ‹ç³»åˆ—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631599960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812201,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLm8skz4F7FGGBTXWUMia6qVEc00BddeXapicv5FkAx62GmOnUNEcE4scSR60AmappQoNdIQhccKsBA/132","nickname":"æœ«æ—¥ï¼Œæˆæ¬¢","note":"","ucode":"BBAEBB9C93558A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387687,"discussion_content":"æˆ‘æƒ³é—®ä¸‹sdsçš„char buf[]å’Œchar *pæœ‰å•¥åŒºåˆ«å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628347172,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1009002,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/65/6a/be36c108.jpg","nickname":"ikel","note":"","ucode":"1D5CE7803C1C2B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1812201,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLm8skz4F7FGGBTXWUMia6qVEc00BddeXapicv5FkAx62GmOnUNEcE4scSR60AmappQoNdIQhccKsBA/132","nickname":"æœ«æ—¥ï¼Œæˆæ¬¢","note":"","ucode":"BBAEBB9C93558A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391363,"discussion_content":"åº”è¯¥å¤§å°ä¸ä¸€æ ·ï¼Œä½ å¯ä»¥æ‰“å°å‡ºçœ‹çœ‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630418628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":387687,"ip_address":""},"score":391363,"extra":""}]},{"author":{"id":1390997,"avatar":"https://static001.geekbang.org/account/avatar/00/15/39/95/a72ef023.jpg","nickname":"æœ¨å­","note":"","ucode":"66B9C493F25B11","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386775,"discussion_content":"è¯¾ä»£è¡¨çš„è¯„è®ºæ¯æ¬¡å¿…çœ‹ï¼Œè·Ÿç€è¯¾ä»£è¡¨å¥½å¥½å­¦ä¹ ï¼Œå¥½æƒ³æˆä¸ºè¯¾ä»£è¡¨è¿™æ ·çš„å¤§ç‰›ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627792323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1095445,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b7/15/6a2b6b83.jpg","nickname":"è‘£å®—ç£Š","note":"","ucode":"D7005A328BC2EE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386482,"discussion_content":"static int checkStringLength(client *c, long long size) {\n    if (!(c->flags &amp; CLIENT_MASTER) &amp;&amp; size > server.proto_max_bulk_len) {\n        addReplyError(c,&#34;string exceeds maximum allowed size (proto-max-bulk-len)&#34;);\n        return C_ERR;\n    }\n    return C_OK;\n}\n\n6.2.4 æºç ä¸­ç”¨ server.proto_max_bulk_len   è¿™ä¸ªå†…å®¹ï¼Œæ²¡å¤ªçœ‹æ‡‚å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627609529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1095445,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b7/15/6a2b6b83.jpg","nickname":"è‘£å®—ç£Š","note":"","ucode":"D7005A328BC2EE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386486,"discussion_content":"è¯´æ˜è¿™é‡Œä¸åœ¨ç¡¬ç¼–ç å†™æ­»é™åˆ¶äº†ï¼Œå˜æˆå¯é…ç½®çš„äº†ï¼Œå¯ä»¥çœ‹çœ‹é…ç½®æ–‡ä»¶ï¼šproto-max-bulk-lenï¼Œé»˜è®¤ 512mbï¼Œå¯ä¿®æ”¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627612117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386482,"ip_address":""},"score":386486,"extra":""}]},{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386387,"discussion_content":"å¦å¤– 2^9 ä¸æ˜¯ 512M ... è¿™é‡Œçš„å•ä½æ˜¯å­—èŠ‚å“ˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627560507,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":386395,"discussion_content":"å†™é”™ï¼Œ2^29ï¼Œ å“ˆå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627562002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386387,"ip_address":""},"score":386395,"extra":""}]},{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386342,"discussion_content":"è¯¾ä»£è¡¨ä½ å¥½ï¼Œæˆ‘çœ‹çš„æ˜¯3.0çš„æºç ï¼Œsdsç»“æ„ä¸­å­—ç¬¦æ•°ç»„é•¿åº¦ç”¨intè¡¨ç¤ºï¼Œintæœ€å¤§å¯è¡¨ç¤º2^31-1ï¼Œä½†æ˜¯stringä¸­é™åˆ¶æœ€å¤§é•¿åº¦æ˜¯512Mï¼ˆ2^9ï¼‰ï¼Œè¯·é—®ä¸‹è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627541286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1105387,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/eb/80f9d212.jpg","nickname":"lttzzlll","note":"","ucode":"FA160F7C02ABAA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"discussion":{"id":389976,"discussion_content":"2 ^ 10 ^ 9 = 2 ^ 19","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629551865,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386342,"ip_address":""},"score":389976,"extra":""},{"author":{"id":2542376,"avatar":"https://static001.geekbang.org/account/avatar/00/26/cb/28/21a8a29e.jpg","nickname":"å¤å¤©","note":"","ucode":"5F224DDAC94DFF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"discussion":{"id":551049,"discussion_content":"æ²¡å•¥å«ä¹‰ï¼Œ512må°±æ˜¯ä½œè€…ç»™äº†ä¸ªç»éªŒå€¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644886658,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386342,"ip_address":""},"score":551049,"extra":""}]}]},{"had_liked":false,"id":304685,"user_name":"æ‚Ÿç©ºèŠæ¶æ„","can_delete":false,"product_type":"c1","uid":1123163,"ip_address":"","ucode":"C2F482A0CF8AF1","user_header":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","comment_is_top":false,"comment_ctime":1627549636,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"53167157188","product_id":100084301,"comment_content":"è¯¾åé¢˜ï¼šä½¿ç”¨ SDS å­—ç¬¦ä¸²çš„åœ°æ–¹ï¼Ÿ<br><br>1. server.h æ–‡ä»¶ä¸­çš„ `redisObject` å¯¹è±¡ï¼Œkey å’Œ value éƒ½æ˜¯å¯¹è±¡ï¼Œkey ï¼ˆé”®å¯¹è±¡ï¼‰éƒ½æ˜¯ SDS ç®€å•åŠ¨æ€å­—ç¬¦ä¸²å¯¹è±¡<br>2. cluter.c çš„ clusterGenNodesDescription å‡½æ•°ä¸­ã€‚è¿™ä¸ªå‡½æ•°ä»£è¡¨ä»¥ csv æ ¼å¼è®°å½•å½“å‰èŠ‚ç‚¹å·²çŸ¥æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚<br>3. client.h çš„ clusterLink ç»“æ„ä½“ä¸­ã€‚clusterLink åŒ…å«äº†ä¸å…¶ä»–èŠ‚ç‚¹è¿›è¡Œé€šè®¯æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ï¼Œç”¨ SDS æ¥å­˜å‚¨è¾“å‡ºç¼“å†²åŒºå’Œè¾“å…¥ç¼“å†²åŒºã€‚<br>4. server.h çš„ client ç»“æ„ä½“ä¸­ã€‚ç¼“å†²åŒº querybufã€pending_querybuf ç”¨çš„ sds æ•°æ®ç»“æ„ã€‚<br>5. networking.c ä¸­çš„ catClientInfoString å‡½æ•°ã€‚è·å–å®¢æˆ·ç«¯çš„å„é¡¹ä¿¡æ¯ï¼Œå°†å®ƒä»¬å‚¨å­˜åˆ° sds å€¼ s é‡Œé¢ï¼Œå¹¶è¿”å›ã€‚<br>6. sentinel.c ä¸­çš„ sentinelGetMasterByName å‡½æ•°ã€‚æ ¹æ®åå­—æŸ¥æ‰¾ä¸»æœåŠ¡å™¨ï¼Œè€Œå‚æ•°åå­—ä¼šå…ˆè½¬åŒ–ä¸º SDS åå†å»æ‰¾ä¸»æœåŠ¡å™¨ã€‚<br>7. server.h ä¸­çš„ç»“æ„ä½“ redisServerï¼Œaof_buf ç¼“å­˜åŒºç”¨çš„ æ˜¯ sdsã€‚<br>8. slowlog.h ä¸­çš„ç»“æ„ä½“ slowlogEntryï¼Œç”¨æ¥è®°å½•æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå…¶ä»– client çš„åå­—å’Œ ip åœ°å€ç”¨çš„æ˜¯ sdsã€‚<br><br>è¿˜æœ‰å¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº†ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦åŠ æˆ‘å¥½å‹äº¤æµï¼špassjavaã€‚<br><br>----------------------------------<br><br>è¯¦ç»†è¯´æ˜ï¼š<br><br>ï¼ˆ1ï¼‰Redis ä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å’Œå€¼ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼šä¸€ä¸ªé”®å¯¹è±¡ï¼Œä¸€ä¸ªå€¼å¯¹è±¡ã€‚è€Œé”®å¯¹è±¡éƒ½æ˜¯ SDS ç®€å•åŠ¨æ€å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå€¼å¯¹è±¡å¯ä»¥å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡æˆ–è€…æœ‰åºé›†åˆå¯¹è±¡ã€‚<br><br>å¯¹è±¡çš„æ•°æ®ç»“æ„ï¼š<br><br>server.h æ–‡ä»¶ä¸­çš„ `redisObject` ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š<br><br>```c<br>typedef struct redisObject {<br>    &#47;&#47; ç±»å‹<br>    unsigned type:4;<br>    &#47;&#47; ç¼–ç <br>    unsigned encoding:4;<br>    &#47;&#47; å¯¹è±¡æœ€åä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´<br>    unsigned lru:LRU_BITS; &#47;* LRU time (relative to global lru_clock) or<br>                            * LFU data (least significant 8 bits frequency<br>                            * and most significant 16 bits access time). *&#47;<br>    &#47;&#47; å¼•ç”¨è®¡æ•°<br>    int refcount;<br>    &#47;&#47; æŒ‡å‘å®é™…å€¼çš„æŒ‡é’ˆ<br>    void *ptr;<br>} robj;<br>```<br><br>å†æ¥çœ‹æ·»åŠ é”®å€¼å¯¹çš„æ“ä½œï¼Œåœ¨æ–‡ä»¶ db.c&#47;<br><br>```C<br>void dbAdd(redisDb *db, robj *key, robj *val)<br>```<br><br>ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨è¦æ·»åŠ åˆ°å“ªä¸ªæ•°æ®åº“ï¼ˆRedis é»˜è®¤ä¼šåˆ›å»º 16 ä¸ªæ•°æ®åº“ï¼Œç¬¬äºŒä¸ªä»£è¡¨é”®å¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä»£è¡¨å€¼å¯¹è±¡ã€‚<br><br>dbAdd å‡½æ•°ä¼šè¢«å¾ˆå¤š Redis å‘½ä»¤è°ƒç”¨ï¼Œæ¯”å¦‚ sadd å‘½ä»¤ã€‚<br><br>ï¼ˆRedis sadd å‘½ä»¤å°†ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜å…ƒç´ åŠ å…¥åˆ°é›†åˆä¸­ï¼Œå·²ç»å­˜åœ¨äºé›†åˆçš„æˆå‘˜å…ƒç´ å°†è¢«å¿½ç•¥ã€‚<br><br>å‡å¦‚é›†åˆ key ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªåªåŒ…å«æ·»åŠ çš„å…ƒç´ ä½œæˆå‘˜çš„é›†åˆã€‚<br><br>å½“é›†åˆ key ä¸æ˜¯é›†åˆç±»å‹æ—¶ï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚2ï¼‰<br><br>ç±»ä¼¼è¿™æ ·çš„å‘½ä»¤ï¼šmyset å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚<br>```SH<br>redis 127.0.0.1:6379&gt; SADD myset &quot;hello&quot;<br>```<br><br>ï¼ˆ2ï¼‰é›†ç¾¤ä¸­ä¹Ÿä¼šç”¨åˆ°ï¼Œä»£ç è·¯å¾„ï¼š cluter.c&#47;clusterGenNodesDescription<br><br>æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬å½“å‰èŠ‚ç‚¹è‡ªèº«ï¼‰è¢«ä¿å­˜åˆ°ä¸€ä¸ª sds é‡Œé¢ï¼Œä»¥ csv æ ¼å¼è¿”å›ã€‚<br><br>ï¼ˆ3ï¼‰cluster.h çš„ clusterLink ç»“æ„ä½“ä¸­ã€‚clusterLink åŒ…å«äº†ä¸å…¶ä»–èŠ‚ç‚¹è¿›è¡Œé€šè®¯æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯<br><br>```C<br>&#47;&#47; è¾“å‡ºç¼“å†²åŒºï¼Œä¿å­˜ç€ç­‰å¾…å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼ˆmessageï¼‰ã€‚<br>sds sndbuf;                 &#47;* Packet send buffer *&#47;<br><br>&#47;&#47; è¾“å…¥ç¼“å†²åŒºï¼Œä¿å­˜ç€ä»å…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚<br>sds rcvbuf;     <br>```<br><br>ï¼ˆ4ï¼‰Redis ä¼šç»´æŠ¤æ¯ä¸ª Client çš„çŠ¶æ€ï¼ŒClient å‘é€çš„è¯·æ±‚ï¼Œä¼šè¢«ç¼“å­˜åˆ° querybuf ä¸­ã€‚","like_count":12,"discussions":[{"author":{"id":1123163,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","nickname":"æ‚Ÿç©ºèŠæ¶æ„","note":"","ucode":"C2F482A0CF8AF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386379,"discussion_content":"---------------------------------------\n\nè¡¥å……ä¸‹ SDS å’Œ C å­—ç¬¦ä¸²çš„çŸ¥è¯†ï¼š\n\nï¼ˆ1ï¼‰Redis ä¹Ÿä¼šä½¿ç”¨ C å­—ç¬¦ä¸²ä½œä¸ºå­—é¢é‡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒRedis ä½¿ç”¨ SDS ä½œä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºã€‚\n\nï¼ˆ2ï¼‰SDS å’Œ C å­—ç¬¦ä¸²ç›¸æ¯”å…·æœ‰å“ªäº›ä¼˜åŠ¿ï¼š\n\n- é€šè¿‡å¸¸æ•°æ¥è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œæ—¶é—´å¤æ‚åº¦O(1)ã€‚\n- ç©ºé—´é¢„åˆ†é…ï¼Œæœç»ç¼“å†²åŒºæº¢å‡ºã€‚è‡ªåŠ¨æ‰©å®¹çš„æ–¹å¼ã€‚å…·ä½“çœ‹è¿™ä¸ªå‡½æ•° sds.c/sdsMakeRoomForã€‚\n- å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²é•¿åº¦æ—¶æ‰€éœ€çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ï¼Œå› ä¸ºæ‰©å®¹çš„æ—¶å€™ä¼šæå‰å¤šåˆ†é…ä¸€äº›ç©ºé—´ï¼Œæ‰€ä»¥ä¸æ˜¯æ¯æ¬¡éƒ½æ‰©å®¹ã€‚å°†å†…å­˜é‡åˆ†é…æ¬¡æ•°ä»å¿…å®š N æ¬¡é™ä½ä¸ºæœ€å¤š N æ¬¡ã€‚\n- æƒ°æ€§ç©ºé—´é‡Šæ”¾ã€‚å½“ç¼©çŸ­å­—ç¬¦ä¸²æ—¶ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œå†…å­˜é‡åˆ†é…ï¼Œå‡å°‘å†…å­˜åˆ†é…é€ æˆçš„å¼€é”€ã€‚\n- äºŒè¿›åˆ¶å®‰å…¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥ä¿å­˜ç©ºå­—ç¬¦ `\\0`ã€‚è€Œ C å­—ç¬¦ä¸²åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®ï¼ŒSDS å¯ä»¥ä¿å­˜åƒå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€å‹ç¼©æ–‡ä»¶è¿™æ ·çš„äºŒè¿›åˆ¶æ•°æ®ã€‚\n- å…¼å®¹éƒ¨åˆ†çš„ C å­—ç¬¦ä¸²å‡½æ•°ã€‚ä¸ºä»€ä¹ˆèƒ½å…¼å®¹ï¼Ÿå› ä¸º SDS éµå¾ª C å­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„æƒ¯ä¾‹ï¼Œè¿™æ ·å¯ä»¥è®© SDS å¯ä»¥é‡ç”¨ä¸€éƒ¨åˆ† <string.h>åº“å®šä¹‰çš„å‡½æ•°ã€‚\n\nï¼ˆ3ï¼‰SDS åˆ†é…å†…å­˜çš„ç®—æ³•\n\n- å¦‚æœæ‰©å®¹æ—¶ï¼Œè®¡ç®—æ‰©å®¹å SDS çš„é•¿åº¦å°†å°äº 1MBï¼Œåˆ™ç¿»å€æ‰©å®¹ã€‚\n- å¦‚æœæ‰©å®¹æ—¶ï¼Œè®¡ç®—æ‰©å®¹å SDS çš„é•¿åº¦å°†å¤§äº 1MBï¼Œåˆ™åˆ†é… 1 MB çš„ç©ºé—´ã€‚\n- å¦‚æœéœ€è¦ç¼©å®¹æ—¶ï¼Œä¸ä¼šç«‹å³é‡Šæ”¾å†…å­˜ï¼ˆå†…å­˜é‡åˆ†é…ï¼‰ï¼Œè€Œæ˜¯å°†å†…å­˜ç•™ç»™ä»¥åä½¿ç”¨ï¼Œé¿å…äº†å†…å­˜é‡åˆ†é…ï¼Œæœªå°†æ¥å¯èƒ½æœ‰çš„å¢é•¿æ“ä½œæä¾›äº†ä¼˜åŒ–ã€‚åœ¨æœ‰éœ€è¦æ—¶ï¼Œè°ƒç”¨é‡Šæ”¾å†…å­˜çš„ API å³å¯é‡Šæ”¾ã€‚\n\nï¼ˆ4ï¼‰SDSå¸¸ç”¨çš„å‡½æ•°\n\n- sdsnewï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«ç»™å®š C å­—ç¬¦ä¸²çš„ SDSï¼ŒO(N)\n- sdsemptyï¼šåˆ›å»ºä¸€ä¸ªä¸åŒ…å«ä»»ä½•å†…å®¹çš„ç©º SDSï¼ŒO(1)\n- sdsfreeï¼šé‡Šæ”¾ç»™å®šçš„ SDSï¼ŒO(N)\n- sdslenï¼šè¿”å› SDS çš„å·²ä½¿ç”¨ç©ºé—´å­—èŠ‚æ•°ï¼ŒO(1)\n- sdsavailï¼šè¿”å› SDS çš„æœªä½¿ç”¨ç©ºé—´å­—èŠ‚æ•°ï¼ŒO(1)\n- sdsdupï¼šåˆ›å»ºä¸€ä¸ªç»™å®š SDS çš„å‰¯æœ¬ï¼ŒO(N)\n- sdsclearï¼šæ¸…ç©º SDS ä¿å­˜çš„å­—ç¬¦ä¸²å†…å®¹ï¼ŒO(1)\n- sdscatï¼šå°†ç»™å®š C å­—ç¬¦ä¸²æ‹¼æ¥åˆ° SDS å­—ç¬¦ä¸²çš„æœ«å°¾ï¼ŒO(N)\n- sdscatsdsï¼šå°†ç»™å®š SDS å­—ç¬¦ä¸²æ‹¼æ¥åˆ°å¦ä¸€ä¸ª SDS å­—ç¬¦ä¸²çš„æœ«å°¾ï¼ŒO(N)\n- sdscpyï¼šå°†ç»™å®šçš„ C å­—ç¬¦ä¸²èµ‹å€¼åˆ° SDS é‡Œé¢ï¼Œè¦†ç›– SDS åŸæœ‰çš„å­—ç¬¦ä¸²ï¼ŒO(N)\n- sdsgrowzeoï¼šç”¨ç©ºå­—ç¬¦å°† SDS æ‰©å±•è‡³ç»™å®šé•¿åº¦ï¼ŒO(N)\n- sdsrangeï¼šä¿ç•™ SDS ç»™å®šåŒºé—´å†…çš„æ•°æ®ï¼Œä¸åœ¨åŒºé—´å†…çš„æ•°æ®ä¼šè¢«è¦†ç›–æˆ–æ¸…æ¥šï¼ŒO(N)\n- sdstrimï¼šæ¥å—ä¸€ä¸ª SDS å’Œä¸€ä¸ª C å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œä» SDS å·¦å³ä¸¤ç«¯åˆ†åˆ«ç§»é™¤æ‰€æœ‰åœ¨ C å­—ç¬¦ä¸²ä¸­å‡ºç°è¿‡çš„å­—ç¬¦ï¼ŒOM*N)\n- sdscmpï¼šå¯¹æ¯”ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸åŒã€‚O(N)\n\nï¼ˆ5ï¼‰Redis 3.0 å’Œ 5.0 çš„åŒºåˆ«\n\n- 3.0  SDS æºç \n\n```C\n/*\n * ç±»å‹åˆ«åï¼Œç”¨äºæŒ‡å‘ sdshdr çš„ buf å±æ€§\n */\ntypedef char *sds;\n\n/*\n * ä¿å­˜å­—ç¬¦ä¸²å¯¹è±¡çš„ç»“æ„\n */\nstruct sdshdr {\n    \n    // buf ä¸­å·²å ç”¨ç©ºé—´çš„é•¿åº¦\n    int len;\n\n    // buf ä¸­å‰©ä½™å¯ç”¨ç©ºé—´çš„é•¿åº¦\n    int free;\n\n    // æ•°æ®ç©ºé—´\n    char buf[];\n};\n```\n\n- 5.0 SDS æºç \n\n```C\nstruct __attribute__ ((__packed__)) sdshdr8 {\n    uint8_t len; /* å­—ç¬¦æ•°ç»„ç°æœ‰é•¿åº¦*/\n    uint8_t alloc; /* å­—ç¬¦æ•°ç»„çš„å·²åˆ†é…ç©ºé—´ï¼Œä¸åŒ…æ‹¬ç»“æ„ä½“å’Œ\\0ç»“æŸå­—ç¬¦*/\n    unsigned char flags; /* SDSç±»å‹SDS ä¸€å…±è®¾è®¡äº† 5 ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ sdshdr5ã€sdshdr8ã€sdshdr16ã€sdshdr32 å’Œ sdshdr64*/\n    char buf[];/*å­—ç¬¦æ•°ç»„*/\n};\n```\n\nå¦å¤–ä¹‹å‰å†™è¿‡ä¸€ç¯‡ç”¨æ•…äº‹è®²è§£ SDS çš„æ–‡ç« ï¼Œä½†æ˜¯æ˜¯åŸºäº 3.0 æºç çš„ï¼Œçœ‹äº† 5.0 æºç åï¼Œæ•°æ®ç»“æ„è¿˜æ˜¯æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«çš„ã€‚https://mp.weixin.qq.com/s/qtiE6ddYzMcalf3OfVeRGAã€‚\n\nåæ§½ä¸‹ï¼šGithub ä¸Šä¸‹è½½æºç æ€»æ˜¯ä¸‹è½½å¤±è´¥ï¼Œä¸ºäº†å…¶ä»–åŒå­¦ä»¬æ–¹ä¾¿ä¸‹è½½ï¼Œæˆ‘æ•´ç†äº†å¤šå¥—æºç çš„ä¸‹è½½åœ°å€ï¼ŒåŒ…å«äº†æœ¬ä¸“æ çš„é…å¥—æºç ï¼Œéƒ½æ˜¯å›½å†…çš„ç½‘ç›˜é“¾æ¥ï¼Œåªæœ‰å‡ MB å¤§å°ï¼Œä¸‹è½½æ¯”è¾ƒå¿«çš„ã€‚\n\nhttp://www.passjava.cn/#/12.Redis/0","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1627557070,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1123163,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","nickname":"æ‚Ÿç©ºèŠæ¶æ„","note":"","ucode":"C2F482A0CF8AF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386378,"discussion_content":"å­—æ•°è¶…é™äº†ï¼Œæ¥ç€ä¸Šæ¡ï¼š\n\nè¿™ä¸ªæ–‡ä»¶ï¼šserver.h/typedef struct clientï¼Œæœ‰ä¸¤ä¸ªç¼“å†²åŒº querybufã€pending_querybufç”¨çš„ sds æ•°æ®ç»“æ„ã€‚è¿˜æœ‰ä¸€ä¸ª peeridã€‚\n\n```c\nsds querybuf;           /* Buffer we use to accumulate client queries. */\nsds pending_querybuf;   /* If this client is flagged as master, this buffer represents the                           yet not applied portion of the replication stream that we are                               receiving from the master. */\nsds peerid;             /* Cached peer ID. */\n```\n\nï¼ˆ5ï¼‰networking.c ä¸­çš„ catClientInfoString å‡½æ•°ã€‚è·å–å®¢æˆ·ç«¯çš„å„é¡¹ä¿¡æ¯ï¼Œå°†å®ƒä»¬å‚¨å­˜åˆ° sds å€¼ s é‡Œé¢ï¼Œå¹¶è¿”å›ã€‚\n\nï¼ˆ6ï¼‰sentinel.c ä¸­çš„ sentinelGetMasterByName å‡½æ•°ã€‚æ ¹æ®åå­—æŸ¥æ‰¾ä¸»æœåŠ¡å™¨ï¼Œè€Œå‚æ•°åå­—ä¼šå…ˆè½¬åŒ–ä¸º SDS åå†å»æ‰¾ä¸»æœåŠ¡å™¨ã€‚\n\nï¼ˆ7ï¼‰server.h ä¸­çš„ç»“æ„ä½“ redisServerï¼Œaof_buf ç¼“å­˜åŒºç”¨çš„ æ˜¯ sdsã€‚\n\n```c\nsds aof_buf;      /* AOF buffer, written before entering the event loop */\nsds aof_child_diff;             /* AOF diff accumulator child side. */\n```\n\nï¼ˆ8ï¼‰slowlog.h ä¸­çš„ç»“æ„ä½“ slowlogEntryï¼Œç”¨æ¥è®°å½•æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå…¶ä»– client çš„åå­—å’Œ ip åœ°å€ç”¨çš„æ˜¯ sdsã€‚\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1627556977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1744412,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLFzTL7n7a5wmZ7NicjTFGLk2CdM8t0iaUwm6ZHZ6ZaEfvwgTey9LBmPWA5Yq8kK6cGgPVgbgL24Q6Q/132","nickname":"chutianxia","note":"","ucode":"DE575E94EDEE91","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387111,"discussion_content":"å¾—åˆ°äº†å¾ˆå¥½çš„è¡¥å……å“‡ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627992117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305144,"user_name":"lzh2nix","can_delete":false,"product_type":"c1","uid":1066191,"ip_address":"","ucode":"2B9AC282082F7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","comment_is_top":false,"comment_ctime":1627860842,"is_pvip":false,"replies":[{"id":"110470","content":"æ˜¯çš„ï¼Œè¿™ä¸ªæ˜¯SDSè®¾è®¡å¾—éå¸¸å·§å¦™çš„åœ°æ–¹ï¼Œåç»­ç»™å¤§å®¶åŠ é¤è®²è®²ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"è’‹å¾·é’§","uid":"1609687","ctime":1627981752,"ip_address":"","comment_id":305144,"utype":1}],"discussion_count":2,"race_medal":0,"score":"48872501098","product_id":100084301,"comment_content":"ä¸ªäººè§‰å¾—è¿™é‡Œä½¿ç”¨__attribute__ ((__packed__))é™¤äº†èŠ‚çœå†…å­˜ç©ºé—´ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆç²¾å¦™çš„è®¾è®¡å°±æ˜¯åœ¨packedä¹‹åå¯ä»¥é€šè¿‡ä»¥ä¸‹çš„æ–¹å¼æ¥è·å–flagså­—æ®µ<br><br>\tunsigned char flags = s[-1];<br>    <br>    switch(flags&amp;SDS_TYPE_MASK) {<br>        case SDS_TYPE_5:<br>            return SDS_TYPE_5_LEN(flags);<br>        case SDS_TYPE_8:<br>            return SDS_HDR(8,s)-&gt;len;<br>        case SDS_TYPE_16:<br>            return SDS_HDR(16,s)-&gt;len;<br>        case SDS_TYPE_32:<br>            return SDS_HDR(32,s)-&gt;len;<br>        case SDS_TYPE_64:<br>            return SDS_HDR(64,s)-&gt;len;<br>    }<br><br>ä»è€Œæ›´è¿›ä¸€æ­¥çš„å¾—åˆ°structçš„å…·ä½“ç±»å‹ï¼Œå¦‚æœæ˜¯é1å­—èŠ‚å¯¹é½çš„è¯ï¼Œè¿™é‡Œå°±ä¸èƒ½è¿™æ ·æ“ä½œã€‚è€Œsdsä¸­é€šè¿‡åŸå§‹çš„char* å®šä½åˆ°sdsçš„Headeræ˜¯è®¾è®¡çš„çš„**çµé­‚**","like_count":11,"discussions":[{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"è’‹å¾·é’§","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524295,"discussion_content":"æ˜¯çš„ï¼Œè¿™ä¸ªæ˜¯SDSè®¾è®¡å¾—éå¸¸å·§å¦™çš„åœ°æ–¹ï¼Œåç»­ç»™å¤§å®¶åŠ é¤è®²è®²ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627981752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1732366,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKkFvuiaEntOvrP5Pv2CSBiayjRULB7QdoaDeozRl4hhSbWSP9flNhHu1lPCwM1Yg22bGyEI5iaIS3icQ/132","nickname":"Geek1173","note":"","ucode":"865F0E493E7EDC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387552,"discussion_content":"æˆ‘ä¹Ÿè§‰å¾—è¿™äº›éƒ¨åˆ†åº”è¯¥è¦ä»‹ç»ä¸€ä¸‹ï¼Œ å‘ç°è¿™ä¸ªåœ°æ–¹æœ‰ç¼ºå¤±ï¼ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628239592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305018,"user_name":"lzh2nix","can_delete":false,"product_type":"c1","uid":1066191,"ip_address":"","ucode":"2B9AC282082F7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","comment_is_top":false,"comment_ctime":1627772927,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40282478591","product_id":100084301,"comment_content":"ä¸ªäººè§‰å¾—sdsæœ‰ä¸€ä¸ªå¾ˆä¼˜ç§€çš„è®¾è®¡æ˜¯å¯¹å¤–å’Œchar*ä¿æŒä¸€è‡´ï¼Œåœ¨sdså¤–é¢å¯ä»¥åƒä½¿ç”¨char*ä¸€æ ·æ¥ä½¿ç”¨sdsï¼Œä½†æ˜¯ä½¿ç”¨sdsç›¸å…³å‡½æ•°æ“ä½œçš„æ—¶å€™åˆå¯ä»¥å‘æŒ¥sdsçš„ç‰¹æ€§(é€šè¿‡åç§»é‡æ¥æ‰¾åˆ°sdsçš„header)ã€‚<br><br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨sdsnewlenä¸­è¿”å›çš„æ˜¯char*<br><br>sds sdsnewlen(const void *init, size_t initlen) {<br>    sds s;<br>    sh = s_malloc(hdrlen+initlen+1);<br>    s = (char*)sh+hdrlen;<br>    return s;<br>}<br>è¿™æ ·çš„å®é™…å¯¹å¤–é¢çš„ä½¿ç”¨ç€æ¥è¯´å°±å¾ˆå‹å¥½å¾ˆå‹å¥½çš„ã€‚","like_count":9},{"had_liked":false,"id":304855,"user_name":"frankylee","can_delete":false,"product_type":"c1","uid":1215578,"ip_address":"","ucode":"7C1D04B4E8E9B6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLgsx7Jic0oLzyKcEtk675vnicehGIQGqZiaedh9fdaQjKv6ZJsWviclFakKJicabC2ibV3bibm3gIic5hvtA/132","comment_is_top":false,"comment_ctime":1627639817,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"27397443593","product_id":100084301,"comment_content":"æ—¢ç„¶è¿™ç¯‡æ˜¯è®²è§£SDSçš„,é‚£æŒ‰é“ç†æ¥è¯´   SDSå†…å­˜ç©ºé—´åˆ†é…ç­–ç•¥,ä»¥åŠç©ºé—´é‡Šæ”¾å†Œç½— è¿™å—å°±åº”è¯¥è®²æ¸…æ¥š,ä½†æ˜¯é€šç¯‡è¯»ä¸‹æ¥å¥½åƒå¹¶æ²¡æåˆ°è¿™å—,è¯»å®Œä¸‹é¢çš„ç²¾é€‰ç•™è¨€éƒ¨åˆ†è¯»è€…å¯èƒ½ä»ç„¶äº‘é‡Œé›¾é‡Œ","like_count":6,"discussions":[{"author":{"id":2427363,"avatar":"https://static001.geekbang.org/account/avatar/00/25/09/e3/c9622ddd.jpg","nickname":"summy","note":"","ucode":"8CBA92AFFB55BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583956,"discussion_content":"å†…å­˜çš„ç”³è¯·å’Œé‡Šæ”¾åº”è¯¥æ˜¯é€šè¿‡jemallocæ¥ç®¡ç†çš„ï¼Œredisè¿™ä¸€å—åº”è¯¥æ˜¯å°è£…äº†jemallocçš„æ“ä½œæ¥å£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660527979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1417682,"avatar":"https://static001.geekbang.org/account/avatar/00/15/a1/d2/58110e27.jpg","nickname":"æ…§æ…§ç»™å†²çš„ä¼šå‘˜","note":"","ucode":"E81475678299F7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390111,"discussion_content":"æ˜¯çš„ï¼Œæ„Ÿè§‰è®²çš„ä¸€åŠ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629678097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1312635,"avatar":"https://static001.geekbang.org/account/avatar/00/14/07/7b/db7fa67e.jpg","nickname":"é˜¿æ¢µæ°ï½","note":"","ucode":"EBF291933B16E3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386630,"discussion_content":"ç›®å‰çœ‹ï¼Œç¡®å®æ²¡æœ‰æƒ³è±¡ä¸­çš„å¥½ã€‚ã€‚ã€‚è€å¸ˆä¹Ÿä¸å›å¤è¯„è®º","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627700847,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304648,"user_name":"Milittle","can_delete":false,"product_type":"c1","uid":1045455,"ip_address":"","ucode":"80E566639A8ABB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f3/cf/851dab01.jpg","comment_is_top":false,"comment_ctime":1627532588,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"18807401772","product_id":100084301,"comment_content":"è®¾è®¡ç€å®ç‰›é€¼ï¼š<br>1. ä½¿ç”¨sdsè¿™ä¸ªå­—ç¬¦æ•°ç»„ä¿å­˜æ‰€æœ‰8 16 32 64çš„ç»“æ„ä½“ã€‚<br>2. ç»“æ„ä½“ä¸­çš„len alloc å¯¹åº”ä¸åŒç±»å‹å ä¸åŒå­—èŠ‚æ•°ï¼Œflagså§‹ç»ˆæ˜¯ç›¸åŒçš„ï¼Œåé¢char buf[]å°±æ˜¯çœŸå®çš„å­—ç¬¦ä¸²ã€‚<br>3. SDS_HDR è¿™ä¸ªå®å®šä¹‰ï¼Œä¸€é”®è®©sdså›åˆ°æŒ‡é’ˆåˆå§‹çš„åœ°æ–¹ï¼Œå¯¹å˜é‡è¿›è¡Œè®¾ç½®ã€‚<br>4. ä¸€å¼€å§‹çº³é—·åœ¨å–flagsçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨s[-1],ä¸ä¼šæ•°æ®è¶Šç•Œä¹ˆï¼Œä½†æ˜¯ä½ ä»”ç»†ç§ä¸€ç§ï¼Œå‘ç°è¿™ä¸ªsæŒ‡å‘çš„ä½ç½®ï¼Œåˆšå¥½æ˜¯char buf[]è¿™é‡Œï¼Œ-1 çš„ä½ç½®åˆšå¥½æ˜¯flagsã€‚å®³ï¼Œè¿˜æ˜¯å‘ç°cç‰›é€¼ã€‚ä¸€ä¸ªæŒ‡é’ˆæŒæ§çš„æ­»æ­»çš„ã€‚<br><br>æœ›èµæ•™<br>","like_count":4},{"had_liked":false,"id":305141,"user_name":"lzh2nix","can_delete":false,"product_type":"c1","uid":1066191,"ip_address":"","ucode":"2B9AC282082F7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","comment_is_top":false,"comment_ctime":1627859612,"is_pvip":false,"replies":[{"id":"110469","content":"åº”è¯¥æ˜¯è¿™ä¸¤ä¸ªå…ƒæ•°æ®å„è‡ªå ç”¨çš„å†…å­˜ç©ºé—´æ˜¯2å­—èŠ‚ã€‚ã€‚ã€‚ä¸å¥½æ„æ€ï¼Œå¼•èµ·è¯¯è§£äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"è’‹å¾·é’§","uid":"1609687","ctime":1627981600,"ip_address":"","comment_id":305141,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10217794204","product_id":100084301,"comment_content":"&quot;è¿™ä¸¤ä¸ªå…ƒæ•°æ®å ç”¨çš„å†…å­˜ç©ºé—´åœ¨ sdshdr16ã€sdshdr32ã€sdshdr64 ç±»å‹ä¸­ï¼Œåˆ™åˆ†åˆ«æ˜¯ 2 å­—èŠ‚ã€4 å­—èŠ‚å’Œ 8 å­—èŠ‚&quot;<br><br>è¿™é‡Œçš„æè¿°æ˜¯æ˜¯å¦æœ‰é—®é¢˜ï¼Œ sdshdr16ä¸­lenï¼Œ allocè¿™ä¸¤ä¸ªå…ƒæ•°æ®å ç”¨çš„ç©ºé—´åº”è¯¥æ˜¯4å­—èŠ‚ï¼Œå…¶ä»–ä¸¤ä¸ªç±»æ¨ã€‚<br>struct __attribute__((__packed__))sdshdr16 {<br>        uint16_t len; &#47;*2å­—èŠ‚*&#47;<br>        uint16_t alloc; &#47;* 2å­—èŠ‚*&#47;<br>        unsigned char flags; &#47;* 1å­—èŠ‚ *&#47;<br>        char buf[];<br>    };","like_count":2,"discussions":[{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"è’‹å¾·é’§","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524292,"discussion_content":"åº”è¯¥æ˜¯è¿™ä¸¤ä¸ªå…ƒæ•°æ®å„è‡ªå ç”¨çš„å†…å­˜ç©ºé—´æ˜¯2å­—èŠ‚ã€‚ã€‚ã€‚ä¸å¥½æ„æ€ï¼Œå¼•èµ·è¯¯è§£äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627981600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304634,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1627527358,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10217461950","product_id":100084301,"comment_content":"Redisè®¾è®¡sdsçš„æ„å›¾ï¼š<br>    1ã€æ»¡è¶³å­˜å‚¨ä¼ è¾“äºŒè¿›åˆ¶çš„æ¡ä»¶ï¼ˆé¿å…\\0æ­§ä¹‰ï¼‰<br>    2ã€é«˜æ•ˆæ“ä½œå­—ç¬¦ä¸²ï¼ˆé€šè¿‡lenå’Œalloc,å¿«é€Ÿè·å–å­—ç¬¦é•¿åº¦å¤§å°ä»¥åŠè·³è½¬åˆ°å­—ç¬¦ä¸²æœ«å°¾ï¼‰<br>    3ã€ç´§å‡‘å‹å†…å­˜è®¾è®¡ï¼ˆæŒ‰ç…§å­—ç¬¦ä¸²ç±»å‹ï¼Œlenå’Œallocä½¿ç”¨ä¸åŒçš„ç±»å‹èŠ‚çº¦å†…å­˜ï¼Œå¹¶ä¸”å…³é—­å†…å­˜å¯¹é½æ¥è¾¾åˆ°å†…å­˜é«˜æ•ˆåˆ©ç”¨ï¼Œåœ¨redisä¸­é™¤äº†sdsï¼Œintsetå’Œziplistä¹Ÿæœ‰ç±»ä¼¼çš„ç›®åº•ï¼‰<br>    4ã€é¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…ï¼Œé™¤äº†sdséƒ¨åˆ†ç±»å‹å­˜åœ¨é¢„ç•™ç©ºé—´ï¼Œsdsè®¾è®¡äº†sdsfreeå’Œsdsclearä¸¤ç§å­—ç¬¦ä¸²æ¸…ç†å‡½æ•°ï¼Œå…¶ä¸­sdsclearï¼Œåªæ˜¯ä¿®æ”¹lenä¸º0ä»¥åŠbufä¸º&#39;\\0&#39;ï¼Œå¹¶ä¸ä¼šå®é™…é‡Šæ”¾å†…å­˜ï¼Œé¿å…ä¸‹æ¬¡ä½¿ç”¨å¸¦æ¥çš„å†…å­˜å¼€é”€ï¼ˆè€å¸ˆå¯èƒ½å¿˜è®°æåŠäº†ï¼‰<br><br><br>æ­¤å¤–sdsçš„ä½¿ç”¨å‡ ä¹å¯ä»¥è´¯ç©¿æ•´ä¸ªredisï¼Œåœ¨server.hæ–‡ä»¶ä¸­ä»¥redisServer å’Œ client ä¸ºä¾‹å­ï¼ˆclientæ—¢å¯ä»¥æ˜¯æ™®é€šå®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯slaveï¼‰<br><br>client:<br>    1ã€querybufï¼ˆæŸ¥è¯¢ç¼“å†²åŒºä½¿ç”¨sdsï¼ŒRESPçš„åè®®æ•°æ®ï¼‰<br>    2ã€pending_querybufï¼ˆæ˜“ä¸»æ—¶å€™çš„ç­‰å¾…åŒæ­¥ç¼“å†²åŒºï¼‰<br>    ç­‰ç­‰<br><br><br>redisServerï¼š<br>    1ã€aof_bufï¼ˆaofç¼“å†²åŒºï¼‰<br>    ç­‰ç­‰","like_count":2},{"had_liked":false,"id":347840,"user_name":"JÂ²","can_delete":false,"product_type":"c1","uid":1100048,"ip_address":"","ucode":"17D9D30F90F97C","user_header":"https://static001.geekbang.org/account/avatar/00/10/c9/10/65fe5b06.jpg","comment_is_top":false,"comment_ctime":1654507494,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5949474790","product_id":100084301,"comment_content":"&#47;&#47;å°†æºå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦é€ä¸€èµ‹å€¼åˆ°ç›®æ ‡å­—ç¬¦ä¸²ä¸­ï¼Œç›´åˆ°é‡åˆ°ç»“æŸå­—ç¬¦ <br>while((*dest++ = *src++) != &#39;\\0&#39; )<br>è¿™é‡Œå°‘äº†ä¸ªåˆ†å·ï¼Œåº”è¯¥æ˜¯while((*dest++ = *src++) != &#39;\\0&#39; );","like_count":1},{"had_liked":false,"id":309970,"user_name":"ikel","can_delete":false,"product_type":"c1","uid":1009002,"ip_address":"","ucode":"1D5CE7803C1C2B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/6a/be36c108.jpg","comment_is_top":false,"comment_ctime":1630418771,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5925386067","product_id":100084301,"comment_content":"5å¹´å‰çœ‹redisæºç ï¼Œå½“æ—¶æŠŠsdsç»“æ„ç”¨åˆ°äº†é¡¹ç›®ä¸­æ¥å¤„ç†å­—ç¬¦ä¸²ï¼Œä¹Ÿæ²¡å‡ºè¿‡å•¥å¹ºè›¾å­ï¼Œåªå¯æƒœåæ¥æ²¡æœ‰å†ç»§ç»­çœ‹æºç äº†","like_count":1},{"had_liked":false,"id":305648,"user_name":"Geek4452","can_delete":false,"product_type":"c1","uid":2206777,"ip_address":"","ucode":"7D0B97B58010BA","user_header":"","comment_is_top":false,"comment_ctime":1628087217,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"5923054513","product_id":100084301,"comment_content":"å’Œc++ stringä¸€æ ·ï¼Ÿstd stringä¹Ÿèƒ½æ»¡è¶³ä¸Šè¿°çš„éœ€æ±‚å•Šï¼Œä¸ºå•¥ä¸ç›´æ¥ç”¨","like_count":1,"discussions":[{"author":{"id":2488913,"avatar":"https://static001.geekbang.org/account/avatar/00/25/fa/51/5da91010.jpg","nickname":"Miroticwillbeforever","note":"","ucode":"1DDD8AECD93EA8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388471,"discussion_content":"redisæ˜¯çº¯cå†™çš„ã€‚è€Œä¸” c++çš„ std::stringéƒ½ä¸å’‹ç”¨ï¼Œå¾ˆå¤šä¼ä¸šéƒ½ä¼šè‡ªè¡Œå®ç°ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628776519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1188710,"avatar":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","nickname":"LDxy","note":"","ucode":"956432CE7B7761","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2488913,"avatar":"https://static001.geekbang.org/account/avatar/00/25/fa/51/5da91010.jpg","nickname":"Miroticwillbeforever","note":"","ucode":"1DDD8AECD93EA8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391535,"discussion_content":"è‡ªè¡Œå®ä¹ çš„å¤§éƒ¨åˆ†éƒ½èƒ½æ¯”æ ‡å‡†åº“çš„å¥½ä¹ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630501765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":388471,"ip_address":""},"score":391535,"extra":""},{"author":{"id":2488913,"avatar":"https://static001.geekbang.org/account/avatar/00/25/fa/51/5da91010.jpg","nickname":"Miroticwillbeforever","note":"","ucode":"1DDD8AECD93EA8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1188710,"avatar":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","nickname":"LDxy","note":"","ucode":"956432CE7B7761","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":413052,"discussion_content":"ä¹Ÿä¸èƒ½è¿™æ ·è¯´ï¼Œè¿˜æ˜¯çœ‹éœ€æ±‚æ¥çš„å§ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636372216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":391535,"ip_address":""},"score":413052,"extra":""},{"author":{"id":1120057,"avatar":"https://static001.geekbang.org/account/avatar/00/11/17/39/3274257b.jpg","nickname":"ple","note":"","ucode":"E1C4519C325994","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1188710,"avatar":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","nickname":"LDxy","note":"","ucode":"956432CE7B7761","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534566,"discussion_content":"çœ‹æ˜¯è°è‡ªè¡Œå®ç°çš„å§\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638233864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":391535,"ip_address":""},"score":534566,"extra":""}]}]},{"had_liked":false,"id":357923,"user_name":"ly","can_delete":false,"product_type":"c1","uid":2081789,"ip_address":"å¹¿ä¸œ","ucode":"79F6C3DB9663D1","user_header":"https://static001.geekbang.org/account/avatar/00/1f/c3/fd/8a2a69f2.jpg","comment_is_top":false,"comment_ctime":1663749418,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663749418","product_id":100084301,"comment_content":"è¯·é—®ä¸€ä¸‹ï¼Œsdsé‡‡ç”¨çš„ç´§å‡‘æ¨¡å‹ä¼šä¸ä¼šå’Œå†…å­˜å¯¹é½çŸ›ç›¾å‘¢ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ç´§å‡‘æ¨¡å‹ä¼šä¸ä¼šäº§ç”Ÿå¤§é‡ç¢ç‰‡é€ æˆæ€§èƒ½ä¸‹é™","like_count":0},{"had_liked":false,"id":353651,"user_name":"kobe","can_delete":false,"product_type":"c1","uid":1165831,"ip_address":"æµ™æ±Ÿ","ucode":"AB8B599F3D5521","user_header":"https://static001.geekbang.org/account/avatar/00/11/ca/07/22dd76bf.jpg","comment_is_top":false,"comment_ctime":1659663304,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1659663304","product_id":100084301,"comment_content":"uint8_t æ˜¯ 8 ä½æ— ç¬¦å·æ•´å‹ï¼Œä¼šå ç”¨ 1 å­—èŠ‚çš„å†…å­˜ç©ºé—´ã€‚å½“å­—ç¬¦ä¸²ç±»å‹æ˜¯ sdshdr8 æ—¶ï¼Œå®ƒèƒ½è¡¨ç¤ºçš„å­—ç¬¦æ•°ç»„é•¿åº¦ï¼ˆåŒ…æ‹¬æ•°ç»„æœ€åä¸€ä½\\0ï¼‰ä¸ä¼šè¶…è¿‡ 256 å­—èŠ‚ï¼ˆ2 çš„ 8 æ¬¡æ–¹ç­‰äº 256ï¼‰ã€‚è¿™é‡Œçš„å­—ç¬¦æ•°ç»„é•¿åº¦åº”è¯¥æ˜¯256 è€Œä¸æ˜¯256å­—èŠ‚å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":352087,"user_name":"ğŸ¤","can_delete":false,"product_type":"c1","uid":1804626,"ip_address":"","ucode":"17D997E499E651","user_header":"https://static001.geekbang.org/account/avatar/00/1b/89/52/b96c272d.jpg","comment_is_top":false,"comment_ctime":1658380596,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658380596","product_id":100084301,"comment_content":"çœå†…å­˜æ„Ÿè§‰å‡ºæ¥äº† å¯¹äºä¸€å¼€å§‹å°±ç”¨JAVAçš„äººæ¥è¯´ å°±è§‰å¾—cçš„è¿™ä¸ªå­—ç¬¦ä¸²è®¾è®¡å¾ˆå¥‡æ€ª è¯»é•¿åº¦å±…ç„¶æ˜¯on","like_count":0},{"had_liked":false,"id":348626,"user_name":"ä¼Šè¯º","can_delete":false,"product_type":"c1","uid":1281857,"ip_address":"","ucode":"709E038DD01C17","user_header":"https://static001.geekbang.org/account/avatar/00/13/8f/41/307555ff.jpg","comment_is_top":false,"comment_ctime":1655262513,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655262513","product_id":100084301,"comment_content":"æ‰“æ‰°ä¸€ä¸‹ï¼ŒSDS ä¸é€šè¿‡å­—ç¬¦ä¸²ä¸­çš„â€œ\\0â€å­—ç¬¦åˆ¤æ–­å­—ç¬¦ä¸²ç»“æŸï¼Œä½†æ˜¯æºç é‡Œé¢è€å¸ˆè¯´æœ€åä¼šæ‹¼æ¥ä¸Š&quot;\\o&quot;å­—ç¬¦ã€‚","like_count":0},{"had_liked":false,"id":347192,"user_name":"Young","can_delete":false,"product_type":"c1","uid":2106939,"ip_address":"","ucode":"DCC32A4FC64422","user_header":"https://static001.geekbang.org/account/avatar/00/20/26/3b/c71c197a.jpg","comment_is_top":false,"comment_ctime":1653807706,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653807706","product_id":100084301,"comment_content":"å›å¤´çœ‹äº†ä¸€ä¸‹Redisæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜çš„ç¬¬11èŠ‚â€œä¸‡é‡‘æ²¹çš„string...â€ï¼Œå¯èƒ½ä¹‹å‰è®²åŸç†è®²çš„æ¯”è¾ƒæµ…ä¸€ç‚¹å§ã€åœ¨è®¡ç®—å†…å­˜å ç”¨çš„æ—¶å€™ï¼Œéƒ½æ˜¯æŒ‰æœ€å¤§åˆ†é…çš„ï¼Ÿçœ‹äº†è¿™ä¸€èŠ‚ã€ä¼šæ›´å¥½ç†è§£","like_count":0},{"had_liked":false,"id":344757,"user_name":"æ•°å­¦æ±¤å®¶å‡¤","can_delete":false,"product_type":"c1","uid":2029485,"ip_address":"","ucode":"DE84E777C384AD","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f7/ad/4fd4d867.jpg","comment_is_top":false,"comment_ctime":1651753228,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1651753228","product_id":100084301,"comment_content":"è¯´åˆ°ç»“æ„ä½“ï¼å°±ä¸å¾—ä¸æåˆ°ä¸€é“ç»å…¸é¢˜ç›®<br>typedef struct {<br>    char*  a; &#47;&#47; 8 ä¸ªå­—èŠ‚<br>    short  b; &#47;&#47; 2 ä¸ªå­—èŠ‚<br>\tdouble c; &#47;&#47; 8 ä¸ªå­—èŠ‚<br>\tchar   d; &#47;&#47; 1 ä¸ªå­—èŠ‚<br>\tfloat  e; &#47;&#47; 4 ä¸ªå­—èŠ‚<br>\tchar   f; &#47;&#47; 1 ä¸ªå­—èŠ‚<br>\tlong   g; &#47;&#47; 8 ä¸ªå­—èŠ‚<br>\tint    h; &#47;&#47; 4 ä¸ªå­—èŠ‚<br>} A;<br>é—®ï¼šè¯¥ç»“æ„ä½“å å¤šå°‘å­—èŠ‚ã€‚å¹¶ä¼˜åŒ–è¯¥ç»“æ„ä½“ä½¿å¾—è¯¥ç»“æ„ä½“æ‰€å ç©ºé—´æœ€å°","like_count":0,"discussions":[{"author":{"id":1166969,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ce/79/673f4268.jpg","nickname":"å°æ°","note":"","ucode":"09E29168D53178","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579278,"discussion_content":"æ±‚ç­”æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657275044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341572,"user_name":"å†è§ç†æƒ³","can_delete":false,"product_type":"c1","uid":1245999,"ip_address":"","ucode":"FAC88B3F6F6DFD","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg","comment_is_top":false,"comment_ctime":1649697116,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649697116","product_id":100084301,"comment_content":"æ ¹æ®å­—ç¬¦ä¸²çš„å¤§å°ï¼Œé€šè¿‡flagä¸ºlenå’Œallocè®¾ç½®ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå†…å­˜çš„åˆç†åˆ©ç”¨","like_count":0},{"had_liked":false,"id":341571,"user_name":"å†è§ç†æƒ³","can_delete":false,"product_type":"c1","uid":1245999,"ip_address":"","ucode":"FAC88B3F6F6DFD","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg","comment_is_top":false,"comment_ctime":1649696979,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649696979","product_id":100084301,"comment_content":"Sdsç®€å•åŠ¨æ€å­—ç¬¦ä¸²<br>å¯ä»¥å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ï¼Œå›¾ç‰‡æ•°æ®<br>é€šè¿‡lenç›´æ¥è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼Œè€Œä¸æ˜¯é€šè¿‡æŸ¥æ‰¾&#47;0<br>é¢„åˆ†é…å†…å­˜ï¼Œé˜²æ­¢å­—ç¬¦ä¸²æ“ä½œçš„é¢‘ç¹ç”³è¯·å†…å­˜ï¼Œå°†å­—ç¬¦ä¸²æ“ä½œå˜ä¸ºå®‰å…¨æ“ä½œã€‚é˜²æ­¢è¾¹ç•Œæº¢å‡ºã€‚","like_count":0},{"had_liked":false,"id":330714,"user_name":"nul","can_delete":false,"product_type":"c1","uid":1043499,"ip_address":"","ucode":"2DBF03B2193B76","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/2b/1e059a0f.jpg","comment_is_top":false,"comment_ctime":1642130154,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642130154","product_id":100084301,"comment_content":"ä¼˜åŒ–æ–¹æ¡ˆï¼š<br>1. å¼•å…¥å…ƒæ•°æ®<br>2. ç¼–è¯‘ä¼˜åŒ–<br>ä¼˜åŒ–äº†å•¥ï¼š<br>1. äºŒè¿›åˆ¶å®‰å…¨é—®é¢˜<br>2. æ“ä½œæ•ˆç‡é—®é¢˜<br>3. å†…å­˜èµ„æºä¼˜åŒ–","like_count":0},{"had_liked":false,"id":327707,"user_name":"ç™½èœ","can_delete":false,"product_type":"c1","uid":2230467,"ip_address":"","ucode":"C3AE527ECE970E","user_header":"https://static001.geekbang.org/account/avatar/00/22/08/c3/bf4fe285.jpg","comment_is_top":false,"comment_ctime":1640244971,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1640244971","product_id":100084301,"comment_content":"æœ‰ä¸ªç–‘é—®å¸Œæœ›è€å¸ˆèƒ½è§£ç­”ï¼š<br>Redis å­—ç¬¦ä¸²ç±»å‹æœ€å¤§é•¿åº¦åº”è¯¥æ˜¯ 512Mï¼Œsdshdr32 ç»“æ„ çš„ len å’Œ alloc åˆšå¥½èƒ½å¤Ÿå­˜å‚¨ 512M çš„é•¿åº¦ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹æ‰å¯èƒ½ç”¨åˆ° sdshdr64 å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":312431,"user_name":"Geek_4f06ca","can_delete":false,"product_type":"c1","uid":2331842,"ip_address":"","ucode":"69B37349DE3EC5","user_header":"","comment_is_top":false,"comment_ctime":1631797037,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631797037","product_id":100084301,"comment_content":"åœ¨ä¸€æ¬¡setæ“ä½œä¸­ï¼Œkey åœ¨dbAddçš„æ—¶å€™ä¼šè°ƒç”¨sds copy = sdsdup(key-&gt;ptr) ç”Ÿæˆsds ï¼Œä½†æ˜¯value æ²¡æœ‰æ²¡æœ‰çœ‹åˆ°è½¬æˆsdsçš„æ“ä½œï¼Œåœ¨tryObjectEncoding ä¼šå¯¹å°äº44å­—èŠ‚çš„è¿›è¡Œç¼–ç ï¼Œä½†æ˜¯å¤§äº44çš„æƒ…å†µå¹¶æ²¡æœ‰è½¬æˆsds ï¼Œä¸ºä»€ä¹ˆå€¼ä¸è½¬sdsï¼Ÿæœ‰è°èƒ½è§£ç­”ä¸‹å—ï¼Ÿ<br>","like_count":0},{"had_liked":false,"id":308574,"user_name":"Alba","can_delete":false,"product_type":"c1","uid":2427143,"ip_address":"","ucode":"4963AB08A4AEBC","user_header":"https://static001.geekbang.org/account/avatar/00/25/09/07/44625105.jpg","comment_is_top":false,"comment_ctime":1629687800,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629687800","product_id":100084301,"comment_content":"å†™ä¸€ä¸‹è‡ªå·±çœ‹ä»£ç çš„ç–‘æƒ‘å’Œè§£å†³ã€‚<br>1. sdsnewlen å‡½æ•°è¿”å›çš„æ˜¯ sds ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ char * ç±»å‹ï¼Œè€Œsdsnewlen å‡½æ•°å†…éƒ¨ç”³è¯·äº†sdshdr åŠ ä¸Š å­—ç¬¦ä¸²çš„å†…å­˜å¤§å°ã€‚è¿™é‡Œåˆ©ç”¨äº†æŒ‡é’ˆåç§»ã€‚<br>2. ä½¿ç”¨__attribute__((packed)) ç¡®å®èƒ½å¤Ÿå®ç°å†…å­˜ç´§å‡‘ï¼Œä½†æ˜¯æˆ‘ä»¬æ—¥å¸¸æ™®éç”¨çš„éƒ½æ˜¯ç»“æ„ä½“å†…å­˜å¯¹é½ã€‚ç»“æ„ä½“å†…å­˜å¯¹é½çš„æ„ä¹‰åœ¨äºé˜²æ­¢è®¿é—®ä¸€ä¸ªæ•°æ®æ—¶å†…å­˜è®¿é—®ä¸¤æ¬¡ï¼Œç›¸å½“äºç”¨ç©ºé—´æ¢æ—¶é—´ã€‚é‚£ redis æ”¾å¼ƒäº†ç»“æ„ä½“å†…å­˜å¯¹é½ï¼Œå¯¹å½±å“å†…å­˜è®¿é—®çš„æ•ˆç‡å—ï¼Ÿç›®å‰çœ‹çš„ä»£ç è¿˜å¾ˆå°‘ï¼ŒçŒœæƒ³æ˜¯å¯¹ sdshdr é‡Œçš„å­—æ®µè®¿é—®çš„æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥ä¸ä¼šå½±å“å†…å­˜è®¿é—®çš„æ•ˆç‡ã€‚å¦‚æœå·¥ä½œä¸­å¯¹å†…å­˜ä¼˜åŒ–éœ€æ±‚ä¸æ˜¯å¾ˆå¼ºçƒˆï¼Œè¿˜æ˜¯æ²¡å¿…è¦ä½¿ç”¨å†…å­˜ç´§å‡‘çš„ã€‚<br>3. ç»“æ„ä½“æœ«ç«¯0é•¿åº¦æ•°ç»„ç›¸æ¯”æŒ‡é’ˆçš„å¥½å¤„ã€‚ä¸€ã€æ–¹ä¾¿ç”³è¯·å’Œé‡Šæ”¾ã€‚å¦‚æœç”¨æŒ‡é’ˆï¼Œå°±éœ€è¦å…ˆç”³è¯·ç»“æ„ä½“çš„å†…å­˜ï¼Œå†ç”³è¯·æŒ‡é’ˆæŒ‡å‘å­—ç¬¦ä¸²çš„å†…å­˜ï¼›å…ˆé‡Šæ”¾æŒ‡é’ˆæŒ‡å‘å­—ç¬¦ä¸²çš„å†…å­˜ï¼Œå†é‡Šæ”¾ç»“æ„ä½“çš„å†…å­˜ã€‚è€Œç”¨æ•°ç»„ï¼Œåªç”³è¯·å’Œé‡Šæ”¾ç»“æ„ä½“çš„å†…å­˜å°±å¯ä»¥äº†ã€‚äºŒã€æ•°ç»„é•¿åº¦ä¸º 0 çš„æ—¶å€™ä¸å ç”¨å†…å­˜å¤§å°ï¼Œè€Œä½¿ç”¨æŒ‡é’ˆï¼ŒæŒ‡é’ˆæœ¬èº«å°±å ç”¨ä¸€ä¸ªå­—é•¿ã€‚","like_count":0},{"had_liked":false,"id":308451,"user_name":"ç†ŠçŒ«â„–.47","can_delete":false,"product_type":"c1","uid":1073203,"ip_address":"","ucode":"380F1D26380EF2","user_header":"https://static001.geekbang.org/account/avatar/00/10/60/33/b17c8fb7.jpg","comment_is_top":false,"comment_ctime":1629624582,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629624582","product_id":100084301,"comment_content":"Stringsç±»å‹ï¼šä¸€ä¸ªStringç±»å‹çš„valueæœ€å¤§å¯ä»¥å­˜å‚¨512M<br><br>Listsç±»å‹ï¼šlistçš„å…ƒç´ ä¸ªæ•°æœ€å¤šä¸º2^32-1ä¸ªï¼Œä¹Ÿå°±æ˜¯4294967295ä¸ªã€‚<br><br>Setsç±»å‹ï¼šå…ƒç´ ä¸ªæ•°æœ€å¤šä¸º2^32-1ä¸ªï¼Œä¹Ÿå°±æ˜¯4294967295ä¸ªã€‚<br><br>Hashesç±»å‹ï¼šé”®å€¼å¯¹ä¸ªæ•°æœ€å¤šä¸º2^32-1ä¸ªï¼Œä¹Ÿå°±æ˜¯4294967295ä¸ªã€‚<br><br>Sorted setsç±»å‹ï¼šè·ŸSetsç±»å‹ç›¸ä¼¼ã€‚","like_count":0},{"had_liked":false,"id":305660,"user_name":"ç å°å‘†","can_delete":false,"product_type":"c1","uid":2055809,"ip_address":"","ucode":"44532D6ABF9340","user_header":"https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg","comment_is_top":false,"comment_ctime":1628089507,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"1628089507","product_id":100084301,"comment_content":"__attribute__ ((__packed__)) æ˜¯è¿™ä¹ˆåšåˆ°ç´§å‡‘å‹å†…å­˜å¸ƒå±€çš„å‘¢ï¼Œè¿˜æœ‰ä½œè€…å¤§å¤§ï¼Œæœ‰æ²¡æœ‰å•¥å·¥å…·èƒ½æ›´å¥½çš„çœ‹redisæºç å‘¢ï¼Œè°¢è°¢","like_count":0,"discussions":[{"author":{"id":2029485,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f7/ad/4fd4d867.jpg","nickname":"æ•°å­¦æ±¤å®¶å‡¤","note":"","ucode":"DE84E777C384AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570390,"discussion_content":"è¿™æ˜¯ä¸ªå®ï¼Œç¼–è¯‘å™¨çœ‹åˆ°äº†ï¼Œå°±ä¸å¯¹è¯¥ç»“æ„ä½“åšå¯¹é½ä¼˜åŒ–","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651753327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1188710,"avatar":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","nickname":"LDxy","note":"","ucode":"956432CE7B7761","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391537,"discussion_content":"çœ‹ä»£ç ç”¨sourceinside","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630501990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305341,"user_name":"å‘½è¿å¥³ç¥åœ¨å¾®ç¬‘","can_delete":false,"product_type":"c1","uid":1492301,"ip_address":"","ucode":"249172371DA9F2","user_header":"https://static001.geekbang.org/account/avatar/00/16/c5/4d/3e75e5f1.jpg","comment_is_top":false,"comment_ctime":1627912184,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627912184","product_id":100084301,"comment_content":"sdshdr5ç»“æ„ä¼šè¢«ä½¿ç”¨ï¼Œif (type == SDS_TYPE_5 &amp;&amp; initlen == 0)ï¼Œå½“é•¿åº¦å°äºsdshdr8ä¸”ä¸ä¸ºç©ºçš„æ—¶å€™å°±ä¼šè¢«ä½¿ç”¨ï¼Œå…·ä½“çš„è§£é‡Šå¯ä»¥çœ‹è¿™ä¸ªissue  https:&#47;&#47;github.com&#47;redis&#47;redis&#47;issues&#47;7581ï¼Œ","like_count":0},{"had_liked":false,"id":305104,"user_name":".","can_delete":false,"product_type":"c1","uid":2460839,"ip_address":"","ucode":"1D7B236E828571","user_header":"https://static001.geekbang.org/account/avatar/00/25/8c/a7/3a696385.jpg","comment_is_top":false,"comment_ctime":1627816903,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1627816903","product_id":100084301,"comment_content":"ä¸ºä»€ä¹ˆ\\0å°±ä¸ç¬¦åˆrediså­˜å‚¨äºŒè¿›åˆ¶æ•°æ®çš„è¦æ±‚å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1053934,"avatar":"https://static001.geekbang.org/account/avatar/00/10/14/ee/d72a8222.jpg","nickname":"æ”»åŸæ‹”å¯¨","note":"","ucode":"CBC37183DAB6B2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387326,"discussion_content":"äºŒè¿›åˆ¶æ•°æ®é‡Œé¢å¯èƒ½åŒ…å« \\0ï¼Œè€Œä¸­é—´ \\0 çš„ä½ç½®å°±ä¼šè¢«å½“æˆç»“å°¾ï¼Œç›¸å½“äº \\0 åé¢çš„éƒ½è¢«å¿½ç•¥äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1628126659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304847,"user_name":"BrightLoong","can_delete":false,"product_type":"c1","uid":1165304,"ip_address":"","ucode":"361FB1840C2977","user_header":"https://static001.geekbang.org/account/avatar/00/11/c7/f8/6b311ad9.jpg","comment_is_top":false,"comment_ctime":1627638367,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627638367","product_id":100084301,"comment_content":"macç‰ˆæœ¬è¿‡é«˜ï¼Œ5.0.8ç¼–è¯‘å› ä¸ºdebug.cæ–‡ä»¶æŠ¥é”™çš„é—®é¢˜ï¼Œæˆ‘è¿™è¾¹å‚ç…§æœ€æ–°ç‰ˆæœ¬çš„æºæ–‡ä»¶ä¿®æ”¹äº†ä¸‹ï¼Œç°åœ¨å¯ä»¥ç¼–è¯‘æˆåŠŸäº†ï¼Œæœ‰éœ€è¦å¯ä»¥è‡ªå·±ä¸‹è½½æ›¿æ¢<br>é“¾æ¥: https:&#47;&#47;pan.baidu.com&#47;s&#47;1dKC9n2a9CmaQCkxn2OuZPw æå–ç : 6d6v","like_count":0},{"had_liked":false,"id":304846,"user_name":"ZmJ","can_delete":false,"product_type":"c1","uid":1231959,"ip_address":"","ucode":"904BA721E735CE","user_header":"https://static001.geekbang.org/account/avatar/00/12/cc/57/ca6c7740.jpg","comment_is_top":false,"comment_ctime":1627637993,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1627637993","product_id":100084301,"comment_content":"æˆ‘è®°å¾—sdsè¿˜ç”¨åˆ°äº†cä¸­çš„æŸ”æ€§æ•°ç»„","like_count":0,"discussions":[{"author":{"id":1051873,"avatar":"https://static001.geekbang.org/account/avatar/00/10/0c/e1/f663213e.jpg","nickname":"æ‹¾æ‡æ‹¾æ‡","note":"","ucode":"D775F374C2A1D3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386953,"discussion_content":"ä¸å°±æ˜¯[]bufå—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627908820,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304843,"user_name":"BrightLoong","can_delete":false,"product_type":"c1","uid":1165304,"ip_address":"","ucode":"361FB1840C2977","user_header":"https://static001.geekbang.org/account/avatar/00/11/c7/f8/6b311ad9.jpg","comment_is_top":false,"comment_ctime":1627637040,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627637040","product_id":100084301,"comment_content":"Macç³»ç»Ÿå¤ªæ–°ï¼Œæ— æ³•æˆåŠŸç¼–è¯‘è€ç‰ˆæœ¬çš„æºç ï¼Œæœ€æ–°ç‰ˆæœ¬çš„å¯ä»¥ç¼–è¯‘ï¼Œçœ‹åˆ°æœ€æ–°ç‰ˆæœ¬debug.cé‡Œé¢å¦‚ä¸‹<br>#if defined(__APPLE__) &amp;&amp; !defined(MAC_OS_X_VERSION_10_6)<br>    &#47;* OSX &lt; 10.6 *&#47;<br>    #if defined(__x86_64__)<br>    return (void*) uc-&gt;uc_mcontext-&gt;__ss.__rip;<br>    #elif defined(__i386__)<br>    return (void*) uc-&gt;uc_mcontext-&gt;__ss.__eip;<br>    #else<br>    return (void*) uc-&gt;uc_mcontext-&gt;__ss.__srr0;<br>    #endif<br>#elif defined(__APPLE__) &amp;&amp; defined(MAC_OS_X_VERSION_10_6)<br>    &#47;* OSX &gt;= 10.6 *&#47;<br>    #if defined(_STRUCT_X86_THREAD_STATE64) &amp;&amp; !defined(__i386__)<br>    return (void*) uc-&gt;uc_mcontext-&gt;__ss.__rip;<br>    #elif defined(__i386__)<br>    return (void*) uc-&gt;uc_mcontext-&gt;__ss.__eip;<br>    #else<br>    &#47;* OSX ARM64 *&#47;<br>    return (void*) arm_thread_state64_get_pc(uc-&gt;uc_mcontext-&gt;__ss);<br>    #endif<br>#elif defined(__linux__)<br>    &#47;* Linux *&#47;<br>    #if defined(__i386__) || ((defined(__X86_64__) || defined(__x86_64__)) &amp;&amp; defined(__ILP32__))<br>    return (void*) uc-&gt;uc_mcontext.gregs[14]; &#47;* Linux 32 *&#47;<br>    #elif defined(__X86_64__) || defined(__x86_64__)<br>    return (void*) uc-&gt;uc_mcontext.gregs[16]; &#47;* Linux 64 *&#47;<br>    #elif defined(__ia64__) &#47;* Linux IA64 *&#47;<br>    return (void*) uc-&gt;uc_mcontext.sc_ip;<br>    #elif defined(__arm__) &#47;* Linux ARM *&#47;<br>    return (void*) uc-&gt;uc_mcontext.arm_pc;<br>    #elif defined(__aarch64__) &#47;* Linux AArch64 *&#47;<br>    return (void*) uc-&gt;uc_mcontext.pc;<br>    #endif<br>#elif defined(__FreeBSD__)<br>    &#47;* FreeBSD *&#47;<br>    #if defined(__i386__)<br>    return (void*) uc-&gt;uc_mcontext.mc_eip;<br>    #elif defined(__x86_64__)<br>    return (void*) uc-&gt;uc_mcontext.mc_rip;<br>    #endif<br>#elif defined(__OpenBSD__)<br>    &#47;* OpenBSD *&#47;<br>    #if defined(__i386__)<br>    return (void*) uc-&gt;sc_eip;<br>    #elif defined(__x86_64__)<br>    return (void*) uc-&gt;sc_rip;<br>    #endif<br>#elif defined(__NetBSD__)<br>    #if defined(__i386__)<br>    return (void*) uc-&gt;uc_mcontext.__gregs[_REG_EIP];<br>    #elif defined(__x86_64__)<br>    return (void*) uc-&gt;uc_mcontext.__gregs[_REG_RIP];<br>    #endif<br>#elif defined(__DragonFly__)<br>    return (void*) uc-&gt;uc_mcontext.mc_rip;<br>#else<br>    return NULL;<br>è¯·é—®è€å¸ˆæœ‰ä»€ä¹ˆè§£å†³åŠæ³•å—","like_count":0},{"had_liked":false,"id":304721,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1627567089,"is_pvip":true,"discussion_count":3,"race_medal":1,"score":"1627567089","product_id":100084301,"comment_content":"SDS çš„å®šä¹‰ä¸­ å¦‚ sdshdr16 ä¸­çš„ hdr ä»£è¡¨ä»€ä¹ˆæ„æ€çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1041584,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKUmskEvtO5IBPmfuVVwmMTdG9iavOk4LuxXibiaEick4VoSE2Siav5ibL8lGgtKd0jmyd8ENkjxoLN7LnA/132","nickname":"shishao","note":"","ucode":"E6219D33CDBF58","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386889,"discussion_content":"å¯¹ï¼Œheader çš„ç¼©å†™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627878726,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2094925,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/f7/4d/09554c96.jpg","nickname":"iron bo","note":"","ucode":"4BFB1331637AA3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386776,"discussion_content":"hdrä»£è¡¨sdsç»“æ„ä½“çš„å¤´éƒ¨ï¼Œä½ å¯ä»¥æŸ¥ä¸‹æºç ä¸­æœ‰ä¸€ä¸ªsdslenä»£è¡¨çš„å°±æ˜¯å»æ‰ buf[]åçš„ç»“æ„ä½“é•¿åº¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627793671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1152678,"avatar":"https://static001.geekbang.org/account/avatar/00/11/96/a6/aac2a550.jpg","nickname":"é™Œ","note":"","ucode":"13FF1D4B3181F0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386514,"discussion_content":"æ›´åƒæ˜¯ Header çš„ç¼©å†™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627624760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304695,"user_name":"å¯æ€œå¤§ç°ç‹¼","can_delete":false,"product_type":"c1","uid":1928373,"ip_address":"","ucode":"6CA9D6D460B967","user_header":"https://static001.geekbang.org/account/avatar/00/1d/6c/b5/32374f93.jpg","comment_is_top":false,"comment_ctime":1627553082,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1627553082","product_id":100084301,"comment_content":"å¯¹æ¯”ä¹‹å‰3.0ç‰ˆæœ¬æ”¹å˜ï¼š1.è€ƒè™‘å­—ç¬¦ä¸²ä¸åŒé•¿åº¦çš„åœºæ™¯ã€‚2.æ”¯æŒæœ€å¤§é•¿åº¦ç”±4å­—èŠ‚åˆ°8å­—èŠ‚ã€‚3.freeå˜æˆäº†allocã€‚<br>ä»£ç æ¯”ä¹‹å‰å¤æ‚äº›ï¼Œå‘³é“è¿˜æ˜¯ä¹‹å‰çš„å‘³é“","like_count":0},{"had_liked":false,"id":304638,"user_name":"Milittle","can_delete":false,"product_type":"c1","uid":1045455,"ip_address":"","ucode":"80E566639A8ABB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f3/cf/851dab01.jpg","comment_is_top":false,"comment_ctime":1627528518,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1627528518","product_id":100084301,"comment_content":"ç¬¬ä¸€è¡Œset å‘½ä»¤åé¢çš„dictå¯ä»¥è®¾ç½®è¿›å»ä¹ˆï¼Ÿ ä¸ºå•¥æˆ‘çš„æŠ¥äº†æ ¼å¼é”™è¯¯ï¼š<br>1. æ–‡ä¸­å‘½ä»¤å­˜åœ¨ä¸­æ–‡åŒå¼•å·<br>2. æ–‡ä¸­çš„valueï¼Œæ²¡æœ‰è¿›è¡Œå­—ç¬¦ä¸²çš„åºåˆ—åŒ–ï¼Œæ— æ³•è¯†åˆ«ã€‚<br>æœ›èµæ•™","like_count":0,"discussions":[{"author":{"id":1045455,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f3/cf/851dab01.jpg","nickname":"Milittle","note":"","ucode":"80E566639A8ABB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386481,"discussion_content":"å­—ç¬¦ä¸²éœ€è¦è½¬è¯‘ï¼ŒåŠ å•å¼•å·çš„å½¢å¼æˆ–è€…åŒå¼•å·è½¬è¯‘ï¼š\nset user:id:100 &#39;{&#34;name&#34;:&#34;zhangsan&#34;,&#34;gender&#34;:&#34;M&#34;,&#34;city&#34;:&#34;beijinng&#34;}&#39;","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1627609213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304619,"user_name":"Fan","can_delete":false,"product_type":"c1","uid":1115232,"ip_address":"","ucode":"3BF28670FD9407","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","comment_is_top":false,"comment_ctime":1627524419,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"1627524419","product_id":100084301,"comment_content":"çœ‹redisæºä»£ç ç”¨ä»€ä¹ˆå·¥å…·æ¯”è¾ƒå¥½ç”¨å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2675181,"avatar":"","nickname":"Geek_66617b","note":"","ucode":"D5B468568B8F39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575785,"discussion_content":"ä½¿ç”¨CLionåœ¨Windowsä¸‹è°ƒè¯•Redisè¯¦ç»†æ•™ç¨‹\nhttps://www.maoyingdong.com/redis/debug_redis/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655107237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1271812,"avatar":"https://static001.geekbang.org/account/avatar/00/13/68/04/a5d81cb1.jpg","nickname":"å°¹æ”¿","note":"","ucode":"D98663ABE1723C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386503,"discussion_content":"å»ºè®® understand  é’ˆå¯¹cè¯­è¨€çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627617397,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1123163,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","nickname":"æ‚Ÿç©ºèŠæ¶æ„","note":"","ucode":"C2F482A0CF8AF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386362,"discussion_content":"vscode å°±å¯ä»¥å•Š\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627549663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1451391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","nickname":"æ›¾è½¼éºŸ","note":"","ucode":"D418371AC11270","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386324,"discussion_content":"clionå¯ä»¥è€ƒè™‘ä¸€ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627527397,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1165304,"avatar":"https://static001.geekbang.org/account/avatar/00/11/c7/f8/6b311ad9.jpg","nickname":"BrightLoong","note":"","ucode":"361FB1840C2977","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1451391,"avatar":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","nickname":"æ›¾è½¼éºŸ","note":"","ucode":"D418371AC11270","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386555,"discussion_content":"æJavaçš„ç”¨æƒ¯äº†ideaï¼Œç¡®å®ç”¨clionä¸é”™ï¼Œå¿«æ·é”®å‡ ä¹é€šç”¨ï¼Œè€Œä¸”ç°åœ¨çš„clionå·²ç»æ”¯æŒmakefileäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627635081,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386324,"ip_address":""},"score":386555,"extra":""}]}]},{"had_liked":false,"id":304591,"user_name":"Geek_f71330","can_delete":false,"product_type":"c1","uid":1617615,"ip_address":"","ucode":"40F8CD661E8F59","user_header":"https://static001.geekbang.org/account/avatar/00/18/ae/cf/6186d936.jpg","comment_is_top":false,"comment_ctime":1627493453,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"1627493453","product_id":100084301,"comment_content":"è€å¸ˆä½ å¥½ï¼Œå¯¹ä»Šå¤©è¿™èŠ‚è¯¾çš„ç†è§£æœ‰ä¸‹:<br>1. \\0ä¼šå¯¼è‡´æ— æ³•å­˜å‚¨åŒ…å«\\0çš„å­—ç¬¦ä¸²<br>2. sdsåŠ äº†å½“å‰å­—ç¬¦ä¸²é•¿åº¦ï¼Œåˆ†é…çš„ç©ºé—´å¤§å°ï¼Œä¸»è¦ä½œç”¨æ˜¯ä¸ºäº†åœ¨å¯¹å­—ç¬¦ä¸²è¿›è¡Œä¿®æ”¹æ—¶çš„æ–¹æ³•èƒ½å¤Ÿæ›´é«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†\\0å­—ç¬¦æ— æ³•å­˜å‚¨çš„é—®é¢˜ã€‚å½“ç„¶ï¼Œè¿™æ ·ç›¸å¯¹äºchar*çš„æ–¹å¼ï¼Œè¿™åº”è¯¥æ˜¯å¢åŠ äº†å†…å­˜æ¶ˆè€—ï¼Œä½†è¿™æ˜¯å€¼å¾—çš„ã€‚<br>3. åœ¨ç»“æ„ä½“ä¸­è®¾ç½®flagæ ‡è®°ä½ï¼ŒåŒºåˆ«ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œæ˜¯ä¸ºäº†å‡å°‘ç©ºé—´æµªè´¹ã€‚<br>4. å‘Šè¯‰ç¼–è¯‘å™¨æ‰“åŒ…æ—¶æ›´ç´§å‡‘ï¼Œèƒ½èŠ‚çº¦æ›´å¤šç©ºé—´ã€‚<br><br>æˆ‘æƒ³è¯·é—®è€å¸ˆ:<br>å…³äºç¬¬4ç‚¹ï¼Œè®©ç¼–è¯‘å™¨ä¸ä»¥8ä¸ªå­—èŠ‚ä½œä¸ºå•ä½å»ç”Ÿæˆç»“æ„ä½“å®šä¹‰ï¼Œå›ºç„¶ä¼˜åŒ–äº†ç©ºé—´ï¼Œä½†æ˜¯ä¸æ˜¯ä¼šå¯¼è‡´è¯»å†™å˜æ…¢ï¼Ÿè¿™é‡Œä¸ç†è§£ï¼Œå¦‚æœä»¥8ä¸ªå­—èŠ‚ä¸ºå•ä½æ²¡æœ‰å¥½å¤„ï¼Œä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¼šè¿™ä¹ˆå»åšï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066191,"avatar":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","nickname":"lzh2nix","note":"","ucode":"2B9AC282082F7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386785,"discussion_content":"å¯ä»¥è€ƒè™‘ä¸‹ä¸ºå•¥é»˜è®¤è¦å­—èŠ‚å¯¹é½(4 bytesï¼Œ8 bytes)ï¼Œè¿™é‡Œæ˜¯ç”±äºcpuçš„æ€»çº¿å®½åº¦ï¼Œå¦‚æœå­—èŠ‚å¯¹é½çš„è¯ä¸€ä¸ªå˜é‡çš„è¯»å–å¯ä»¥åœ¨ä¸€ä¸ªcpu cycleä¸­å®Œæˆ(å¯ä»¥æƒ³è±¡ä¸€ä¸ªint64åœ¨ä¸¤ä¸ª8 bytesä¸­é—´çš„åœºæ™¯)ã€‚\n\nè¿™é‡Œ__attribute__ ((__packed__))ä¹‹åstructä¹‹é—´ä»ç„¶éµå¾ªå­—èŠ‚å¯¹é½ï¼Œå†åŠ ä¸Šè¿™äº›headerå æœ‰çš„å†…å­˜æœ‰å¾ˆå°ï¼Œéƒ½èƒ½åœ¨ä¸€ä¸ªcpu cycleå–å‡ºæ¥ï¼Œæ‰€ä»¥åœ¨å†…å­˜å‹ç¼©çš„å‰æä¸‹å¹¶æ²¡æœ‰æŸå¤±æ€§èƒ½ã€‚\n\nä¸ªäººçš„ä¸€ç‚¹ç†è§£ï¼Œå¦‚æœæœ‰é”™è¯¯è¿˜å¸®å¿™æŒ‡æ­£ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1627799813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1818163,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLXDG2ux03bmIyEu9cR1SGX9QnDLJmSpYBg6CcfL6uUiaL90ypGIdmjXaj9uYLaxkQVoKSDeuAiaobQ/132","nickname":"Geek_lijia","note":"","ucode":"321E594550BDEB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1066191,"avatar":"https://static001.geekbang.org/account/avatar/00/10/44/cf/a0315a85.jpg","nickname":"lzh2nix","note":"","ucode":"2B9AC282082F7D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554743,"discussion_content":"æ˜¯çš„ï¼Œæ•´ä¸ªç»“æ„ä½“çš„èµ·å§‹åœ°å€è¿˜æ˜¯ä¼šå­—èŠ‚å¯¹é½ï¼Œåªæ˜¯ç»“æ„ä½“å†…éƒ¨çš„æˆå‘˜ï¼Œä¼šè¿ç»­å­˜å‚¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646577055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386785,"ip_address":""},"score":554743,"extra":""}]},{"author":{"id":1045455,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f3/cf/851dab01.jpg","nickname":"Milittle","note":"","ucode":"80E566639A8ABB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386334,"discussion_content":"ç¼–è¯‘å™¨å¯¹é½åº”è¯¥æ˜¯ä¸ºäº†cpuè®¿é—®å†…å­˜çš„æ—¶å€™ï¼Œèƒ½ä¸€æ¬¡æŠŠç›¸å…³æ•°æ®åŠ è½½è¿›æ¥ï¼Œä½†æ˜¯è¿™é‡Œredisæœ¬èº«æ˜¯å†…å­˜å ç”¨å¤§æˆ·ï¼Œå…¶å®åº”è¯¥å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1627531244,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1051873,"avatar":"https://static001.geekbang.org/account/avatar/00/10/0c/e1/f663213e.jpg","nickname":"æ‹¾æ‡æ‹¾æ‡","note":"","ucode":"D775F374C2A1D3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386954,"discussion_content":"å¯ä»¥çœ‹ä¸‹redisè®¾è®¡ä¸å®ç°ï¼Œè®²çš„è¯¦ç»†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627908913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1386902,"avatar":"https://static001.geekbang.org/account/avatar/00/15/29/96/99344bf1.jpg","nickname":"åŠªåŠ›ä¸å‡è‚¥","note":"","ucode":"C69D08E7EEDCE4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1051873,"avatar":"https://static001.geekbang.org/account/avatar/00/10/0c/e1/f663213e.jpg","nickname":"æ‹¾æ‡æ‹¾æ‡","note":"","ucode":"D775F374C2A1D3","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":410069,"discussion_content":"è¾›è‹¦å‘ŠçŸ¥ä¸€ä¸‹ï¼Œè¿™æœ¬ä¹¦é‚£ä¸€é¡µè®²è§£äº†é—®é¢˜4ï¼Œ æ²¡æœ‰æ‰¾åˆ°ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635586313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":386954,"ip_address":""},"score":410069,"extra":""}]}]}]}