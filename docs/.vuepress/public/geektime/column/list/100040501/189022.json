{"id":189022,"title":"22 | å¤„ç†æ•°æ®ç±»å‹å˜åŒ–å’Œé”™è¯¯ï¼šoptionalã€variantã€expectedå’ŒHerbception","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚</p><p>æˆ‘ä»¬ä¹‹å‰å·²ç»è®¨è®ºäº†å¼‚å¸¸æ˜¯æ¨èçš„ C++ é”™è¯¯å¤„ç†æ–¹å¼ã€‚ä¸è¿‡ï¼ŒC++ é‡Œæœ‰å¦å¤–ä¸€äº›ç»“æ„ä¹Ÿå¾ˆé€‚åˆè¿›è¡Œé”™è¯¯å¤„ç†ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥è®¨è®ºä¸€ä¸‹ã€‚</p><h2>optional</h2><p>åœ¨é¢å‘å¯¹è±¡ï¼ˆå¼•ç”¨è¯­ä¹‰ï¼‰çš„è¯­è¨€é‡Œï¼Œæˆ‘ä»¬æœ‰æ—¶å€™ä¼šä½¿ç”¨ç©ºå€¼ null è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°éœ€è¦çš„å¯¹è±¡ã€‚ä¹Ÿæœ‰äººæ¨èä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ç©ºå¯¹è±¡ï¼Œæ¥é¿å…ç©ºå€¼å¸¦æ¥çš„ä¸€äº›é—®é¢˜ <span class=\"orange\">[1]</span>ã€‚å¯ä¸ç®¡æ˜¯ç©ºå€¼ï¼Œè¿˜æ˜¯ç©ºå¯¹è±¡ï¼Œå¯¹äºä¸€ä¸ªè¿”å›æ™®é€šå¯¹è±¡ï¼ˆå€¼è¯­ä¹‰ï¼‰çš„ C++ å‡½æ•°éƒ½æ˜¯ä¸é€‚ç”¨çš„â€”â€”ç©ºå€¼å’Œç©ºå¯¹è±¡åªèƒ½ç”¨åœ¨è¿”å›å¼•ç”¨/æŒ‡é’ˆçš„åœºåˆï¼Œä¸€èˆ¬æƒ…å†µä¸‹éœ€è¦å †å†…å­˜åˆ†é…ï¼Œåœ¨ C++ é‡Œä¼šå¼•è‡´é¢å¤–çš„å¼€é”€ã€‚</p><p>C++17 å¼•å…¥çš„ <code>optional</code> æ¨¡æ¿ <span class=\"orange\">[2]</span> å¯ä»¥ï¼ˆéƒ¨åˆ†ï¼‰è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¯­ä¹‰ä¸Šæ¥è¯´ï¼Œ<code>optional</code> ä»£è¡¨ä¸€ä¸ªâ€œä¹Ÿè®¸æœ‰æ•ˆâ€â€œå¯é€‰â€çš„å¯¹è±¡ã€‚è¯­æ³•ä¸Šæ¥è¯´ï¼Œä¸€ä¸ª <code>optional</code> å¯¹è±¡æœ‰ç‚¹åƒä¸€ä¸ªæŒ‡é’ˆï¼Œä½†å®ƒæ‰€ç®¡ç†çš„å¯¹è±¡æ˜¯ç›´æ¥æ”¾åœ¨ <code>optional</code> é‡Œçš„ï¼Œæ²¡æœ‰é¢å¤–çš„å†…å­˜åˆ†é…ã€‚</p><p>æ„é€ ä¸€ä¸ª <code>optional&lt;T&gt;</code> å¯¹è±¡æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p><ol>\n<li>ä¸ä¼ é€’ä»»ä½•å‚æ•°ï¼Œæˆ–è€…ä½¿ç”¨ç‰¹æ®Šå‚æ•° <code>std::nullopt</code>ï¼ˆå¯ä»¥å’Œ <code>nullptr</code> ç±»æ¯”ï¼‰ï¼Œå¯ä»¥æ„é€ ä¸€ä¸ªâ€œç©ºâ€çš„ <code>optional</code> å¯¹è±¡ï¼Œé‡Œé¢ä¸åŒ…å«æœ‰æ•ˆå€¼ã€‚</li>\n<li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>std::in_place</code>ï¼Œåé¢è·Ÿæ„é€  <code>T</code> æ‰€éœ€çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ <code>optional</code> å¯¹è±¡ä¸Šç›´æ¥æ„é€ å‡º <code>T</code> çš„æœ‰æ•ˆå€¼ã€‚</li>\n<li>å¦‚æœ <code>T</code> ç±»å‹æ”¯æŒæ‹·è´æ„é€ æˆ–è€…ç§»åŠ¨æ„é€ çš„è¯ï¼Œé‚£åœ¨æ„é€  <code>optional&lt;T&gt;</code> æ—¶ä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ª <code>T</code> çš„å·¦å€¼æˆ–å³å€¼æ¥å°† <code>T</code> å¯¹è±¡æ‹·è´æˆ–ç§»åŠ¨åˆ° <code>optional</code> ä¸­ã€‚</li>\n</ol><!-- [[[read_end]]] --><p>å¯¹äºä¸Šé¢çš„ç¬¬ 1 ç§æƒ…å†µï¼Œ<code>optional</code> å¯¹è±¡é‡Œæ˜¯æ²¡æœ‰å€¼çš„ï¼Œåœ¨å¸ƒå°”å€¼ä¸Šä¸‹æ–‡é‡Œï¼Œä¼šå¾—åˆ° <code>false</code>ï¼ˆç±»ä¼¼äºç©ºæŒ‡é’ˆçš„è¡Œä¸ºï¼‰ã€‚å¯¹äºä¸Šé¢çš„ç¬¬ 2ã€3 ä¸¤ç§æƒ…å†µï¼Œ<code>optional</code> å¯¹è±¡é‡Œæ˜¯æœ‰å€¼çš„ï¼Œåœ¨å¸ƒå°”å€¼ä¸Šä¸‹æ–‡é‡Œï¼Œä¼šå¾—åˆ° <code>true</code>ï¼ˆç±»ä¼¼äºæœ‰æ•ˆæŒ‡é’ˆçš„è¡Œä¸ºï¼‰ã€‚ç±»ä¼¼çš„ï¼Œåœ¨ <code>optional</code> å¯¹è±¡æœ‰å€¼çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç”¨ <code>*</code> å’Œ <code>-&gt;</code> è¿ç®—ç¬¦å»è§£å¼•ç”¨ï¼ˆæ²¡å€¼çš„æƒ…å†µä¸‹ï¼Œç»“æœæ˜¯æœªå®šä¹‰è¡Œä¸ºï¼‰ã€‚</p><p>è™½ç„¶ <code>optional</code> æ˜¯ C++17 æ‰æ ‡å‡†åŒ–çš„ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªç”¨æ³•æ›´æ—©å°±é€šè¡Œäº†ã€‚å› ä¸º <code>optional</code> çš„å®ç°ä¸ç®—å¤æ‚ï¼Œæœ‰äº›åº“é‡Œå°±è‡ªå·±å®ç°äº†ä¸€ä¸ªç‰ˆæœ¬ã€‚æ¯”å¦‚ cpptoml <span class=\"orange\">[3]</span> å°±ç»™å‡ºäº†ä¸‹é¢è¿™æ ·çš„ç¤ºä¾‹ï¼ˆè¿›è¡Œäº†ç¿»è¯‘å’Œé‡æ’ç‰ˆï¼‰ï¼Œç”¨æ³•è·Ÿæ ‡å‡†çš„ <code>optional</code> å®Œå…¨å»åˆï¼š</p><pre><code class=\"language-c++\">auto val = config-&gt;\n  get_as&lt;int64_t&gt;(\"my-int\");\n// val æ˜¯ cpptoml::option&lt;int64_t&gt;\n\nif (val) {\n  // *val æ˜¯ \"my-int\" é”®ä¸‹çš„æ•´æ•°å€¼\n} else {\n  // \"my-int\" ä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•´æ•°\n}\n</code></pre><p>cpptoml é‡Œåªæ˜¯ä¸ªç¼©å¾®ç‰ˆçš„ <code>optional</code>ï¼Œå®ç°åªæœ‰å‡ åè¡Œï¼Œä¹Ÿä¸æ”¯æŒæˆ‘ä»¬ä¸Šé¢è¯´çš„æ‰€æœ‰æ„é€ æ–¹å¼ã€‚æ ‡å‡†åº“çš„ <code>optional</code> ä¸ºäº†æ–¹ä¾¿ç¨‹åºå‘˜ä½¿ç”¨ï¼Œé™¤äº†æˆ‘ç›®å‰æè¿°çš„åŠŸèƒ½ï¼Œè¿˜æ”¯æŒä¸‹é¢çš„æ“ä½œï¼š</p><ul>\n<li>å®‰å…¨çš„ææ„è¡Œä¸º</li>\n<li>æ˜¾å¼çš„ <code>has_value</code> æˆå‘˜å‡½æ•°ï¼Œåˆ¤æ–­ <code>optional</code> æ˜¯å¦æœ‰å€¼</li>\n<li><code>value</code> æˆå‘˜å‡½æ•°ï¼Œè¡Œä¸ºç±»ä¼¼äº <code>*</code>ï¼Œä½†åœ¨ <code>optional</code> å¯¹è±¡æ— å€¼æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ <code>std::bad_optional_access</code></li>\n<li><code>value_or</code> æˆå‘˜å‡½æ•°ï¼Œåœ¨ <code>optional</code> å¯¹è±¡æ— å€¼æ—¶è¿”å›ä¼ å…¥çš„å‚æ•°</li>\n<li><code>swap</code> æˆå‘˜å‡½æ•°ï¼Œå’Œå¦å¤–ä¸€ä¸ª <code>optional</code> å¯¹è±¡è¿›è¡Œäº¤æ¢</li>\n<li><code>reset</code> æˆå‘˜å‡½æ•°ï¼Œæ¸…é™¤ <code>optional</code> å¯¹è±¡åŒ…å«çš„å€¼</li>\n<li><code>emplace</code> æˆå‘˜å‡½æ•°ï¼Œåœ¨ <code>optional</code> å¯¹è±¡ä¸Šæ„é€ ä¸€ä¸ªæ–°çš„å€¼ï¼ˆä¸ç®¡æˆåŠŸä¸å¦ï¼ŒåŸå€¼ä¼šè¢«ä¸¢å¼ƒï¼‰</li>\n<li><code>make_optional</code> å…¨å±€å‡½æ•°ï¼Œäº§ç”Ÿä¸€ä¸ª <code>optional</code> å¯¹è±¡ï¼ˆç±»ä¼¼ <code>make_pair</code>ã€<code>make_unique</code> ç­‰ï¼‰</li>\n<li>å…¨å±€æ¯”è¾ƒæ“ä½œ</li>\n<li>ç­‰ç­‰</li>\n</ul><p>å¦‚æœæˆ‘ä»¬è®¤ä¸ºæ— å€¼å°±æ˜¯æ•°æ®æ— æ•ˆï¼Œåº”å½“è·³è¿‡å‰©ä¸‹çš„å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä¸‹é¢è¿™æ ·çš„é«˜é˜¶å‡½æ•°ï¼š</p><pre><code class=\"language-c++\">template &lt;typename T&gt;\nconstexpr bool has_value(\n  const optional&lt;T&gt;&amp; x) noexcept\n{\n    return x.has_value();\n}\n\ntemplate &lt;typename T,\n          typename... Args&gt;\nconstexpr bool has_value(\n  const optional&lt;T&gt;&amp; first,\n  const optional&lt;\n    Args&gt;&amp;... other) noexcept\n{\n  return first.has_value() &amp;&amp;\n         has_value(other...);\n}\n\ntemplate &lt;typename F&gt;\nauto lift_optional(F&amp;&amp; f)\n{\n  return [f = forward&lt;F&gt;(f)](\n           auto&amp;&amp;... args) {\n    typedef decay_t&lt;decltype(f(\n      forward&lt;decltype(args)&gt;(args)\n        .value()...))&gt;\n      result_type;\n    if (has_value(args...)) {\n      return optional&lt;result_type&gt;(\n        f(forward&lt;decltype(args)&gt;(\n            args)\n            .value()...));\n    } else {\n      return optional&lt;\n        result_type&gt;();\n    }\n  };\n}\n</code></pre><p><code>has_value</code> æ¯”è¾ƒç®€å•ï¼Œå®ƒå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª <code>optional</code> å‚æ•°ï¼Œå¹¶åœ¨æ‰€æœ‰å‚æ•°éƒ½æœ‰å€¼æ—¶è¿”å›çœŸï¼Œå¦åˆ™è¿”å›å‡ã€‚<code>lift_optional</code> ç¨å¤æ‚äº›ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›å¦å¤–ä¸€ä¸ªå‡½æ•°ã€‚åœ¨è¿”å›çš„å‡½æ•°é‡Œï¼Œå‚æ•°æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª <code>optional</code> ç±»å‹ï¼Œ<code>result_type</code> æ˜¯ç”¨å‚æ•°çš„å€¼ï¼ˆ<code>value()</code>ï¼‰å»è°ƒç”¨åŸå…ˆå‡½æ•°æ—¶çš„è¿”å›å€¼ç±»å‹ï¼Œæœ€åè¿”å›çš„åˆ™æ˜¯ <code>result_type</code> çš„ <code>optional</code> å°è£…ã€‚å‡½æ•°å†…éƒ¨ä¼šæ£€æŸ¥æ‰€æœ‰çš„å‚æ•°æ˜¯å¦éƒ½æœ‰å€¼ï¼ˆé€šè¿‡è°ƒç”¨ <code>has_value</code>ï¼‰ï¼šæœ‰å€¼æ—¶ä¼šå»æ‹¿å‚æ•°çš„å€¼å»è°ƒç”¨åŸå…ˆçš„å‡½æ•°ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©ºçš„ <code>optional</code> å¯¹è±¡ã€‚</p><p>è¿™ä¸ªå‡½æ•°èƒ½æŠŠä¸€ä¸ªåŸæœ¬è¦æ±‚å‚æ•°å…¨éƒ¨æœ‰æ•ˆçš„å‡½æ•°æŠ¬å‡ï¼ˆliftï¼‰æˆä¸€ä¸ªæ¥å—å’Œè¿”å› <code>optional</code> å‚æ•°çš„å‡½æ•°ï¼Œå¹¶ä¸”ï¼Œåªåœ¨å‚æ•°å…¨éƒ¨æœ‰æ•ˆæ—¶å»è°ƒç”¨åŸæ¥çš„å‡½æ•°ã€‚è¿™æ˜¯ä¸€ç§éå¸¸å‡½æ•°å¼çš„ç¼–ç¨‹æ–¹å¼ã€‚ä½¿ç”¨ä¸Šé¢å‡½æ•°çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-c++\">#include &lt;iostream&gt;\n#include &lt;functional&gt;\n#include &lt;optional&gt;\n#include &lt;type_traits&gt;\n#include &lt;utility&gt;\n\nusing namespace std;\n\n// éœ€åŒ…å« lift_optional çš„å®šä¹‰\n\nconstexpr int increase(int n)\n{\n    return n + 1;\n}\n\n// æ ‡å‡†åº“æ²¡æœ‰æä¾› optional çš„è¾“å‡º\nostream&amp;\noperator&lt;&lt;(ostream&amp; os,\n           optional&lt;int&gt;(x))\n{\n  if (x) {\n    os &lt;&lt; '(' &lt;&lt; *x &lt;&lt; ')';\n  } else {\n    os &lt;&lt; \"(Nothing)\";\n  }\n  return os;\n}\n\nint main()\n{\n  auto inc_opt =\n    lift_optional(increase);\n  auto plus_opt =\n    lift_optional(plus&lt;int&gt;());\n  cout &lt;&lt; inc_opt(optional&lt;int&gt;())\n       &lt;&lt; endl;\n  cout &lt;&lt; inc_opt(make_optional(41))\n       &lt;&lt; endl;\n  cout &lt;&lt; plus_opt(\n            make_optional(41),\n            optional&lt;int&gt;())\n       &lt;&lt; endl;\n  cout &lt;&lt; plus_opt(\n            make_optional(41),\n            make_optional(1))\n       &lt;&lt; endl;\n}\n</code></pre><p>è¾“å‡ºç»“æœæ˜¯ï¼š</p><blockquote>\n<p><code>(Nothing)</code><br>\n<code>(42)</code><br>\n<code>(Nothing)</code><br>\n<code>(42)</code></p>\n</blockquote><h2>variant</h2><p><code>optional</code> æ˜¯ä¸€ä¸ªéå¸¸ç®€å•è€Œåˆå¥½ç”¨çš„æ¨¡æ¿ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œä½¿ç”¨å®ƒå°±è¶³å¤Ÿè§£å†³é—®é¢˜äº†ã€‚åœ¨æŸç§æ„ä¹‰ä¸Šï¼Œå¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯å…è®¸æœ‰ä¸¤ç§æ•°å€¼çš„å¯¹è±¡ï¼šè¦ä¹ˆæ˜¯ä½ æƒ³æ”¾è¿›å»çš„å¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯ <code>nullopt</code>ï¼ˆå†æ¬¡æé†’ï¼Œè”æƒ³ <code>nullptr</code>ï¼‰ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›é™¤äº†æˆ‘ä»¬æƒ³æ”¾è¿›å»çš„å¯¹è±¡ï¼Œè¿˜å¯ä»¥æ˜¯ <code>nullopt</code> ä¹‹å¤–çš„å¯¹è±¡æ€ä¹ˆåŠå‘¢ï¼ˆæ¯”å¦‚ï¼ŒæŸç§å‡ºé”™çš„çŠ¶æ€ï¼‰ï¼Ÿåˆæ¯”å¦‚ï¼Œå¦‚æœæˆ‘å¸Œæœ›æœ‰ä¸‰ç§æˆ–æ›´å¤šä¸åŒçš„ç±»å‹å‘¢ï¼Ÿè¿™ç§æƒ…å†µä¸‹ï¼Œ<code>variant</code> <span class=\"orange\">[4]</span> å¯èƒ½å°±æ˜¯ä¸€ä¸ªåˆé€‚çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>åœ¨æ²¡æœ‰ <code>variant</code> ç±»å‹ä¹‹å‰ï¼Œä½ è¦è¾¾åˆ°ç±»ä¼¼çš„ç›®çš„ï¼Œææ€•ä¼šä½¿ç”¨ä¸€ç§å«åšå¸¦æ ‡ç­¾çš„è”åˆï¼ˆtagged unionï¼‰çš„æ•°æ®ç»“æ„ã€‚æ¯”å¦‚ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªå¯èƒ½çš„æ•°æ®ç»“æ„å®šä¹‰ï¼š</p><pre><code class=\"language-c++\">struct FloatIntChar {\n  enum {\n    Float,\n    Int,\n    Char\n  } type;\n  union {\n    float float_value;\n    int int_value;\n    char char_value;\n  };\n};\n</code></pre><p>è¿™ä¸ªæ•°æ®ç»“æ„çš„æœ€å¤§é—®é¢˜ï¼Œå°±æ˜¯å®ƒå®é™…ä¸Šæœ‰å¾ˆå¤šå¤æ‚æƒ…å†µéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚å¯¹äºæˆ‘ä»¬ä¸Šé¢ä¾‹å­é‡Œçš„ POD ç±»å‹ï¼Œè¿™ä¹ˆå†™å°±å¯ä»¥äº†ï¼ˆä½†æˆ‘ä»¬ä»éœ€å°å¿ƒä¿è¯æˆ‘ä»¬è®¾ç½®çš„ <code>type</code> å’Œå®é™…ä½¿ç”¨çš„ç±»å‹ä¸€è‡´ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æŠŠå…¶ä¸­ä¸€ä¸ªç±»å‹æ¢æˆé POD ç±»å‹ï¼Œå°±ä¼šæœ‰å¤æ‚é—®é¢˜å‡ºç°ã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„ä»£ç æ˜¯ä¸èƒ½å·¥ä½œçš„ï¼š</p><pre><code class=\"language-c++\">struct StringIntChar {\n  enum {\n    String,\n    Int,\n    Char\n  } type;\n  union {\n    string string_value;\n    int int_value;\n    char char_value;\n  };\n};\n</code></pre><p>ç¼–è¯‘å™¨ä¼šå¾ˆåˆç†åœ°çœ‹åˆ°åœ¨ union é‡Œä½¿ç”¨ <code>string</code> ç±»å‹ä¼šå¸¦æ¥æ„é€ å’Œææ„ä¸Šçš„é—®é¢˜ï¼Œæ‰€ä»¥ä¼šæ‹’ç»å·¥ä½œã€‚è¦è®©è¿™ä¸ªä»£ç å·¥ä½œï¼Œæˆ‘ä»¬å¾—æ‰‹å·¥åŠ ä¸Šææ„å‡½æ•°ï¼Œå¹¶ä¸”ï¼Œåœ¨ææ„å‡½æ•°é‡Œå¾—å°å¿ƒåœ°åˆ¤æ–­å­˜å‚¨çš„æ˜¯ä»€ä¹ˆæ•°å€¼ï¼Œæ¥å†³å®šæ˜¯å¦åº”è¯¥ææ„ï¼ˆå¦åˆ™ï¼Œé»˜è®¤ä¸è°ƒç”¨ä»»ä½• union é‡Œçš„ææ„å‡½æ•°ï¼Œä»è€Œå¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼ï¼‰ï¼š</p><pre><code class=\"language-c++\">  ~StringIntChar()\n  {\n    if (type == String) {\n      string_value.~string();\n    }\n  }\n</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½å®‰å…¨åœ°ä½¿ç”¨å®ƒï¼ˆè¿˜æ˜¯å¾ˆéº»çƒ¦ï¼‰ï¼š</p><pre><code class=\"language-c++\">StringIntChar obj{\n  .type = StringIntChar::String,\n  .string_value = \"Hello world\"};\ncout &lt;&lt; obj.string_value &lt;&lt; endl;\n</code></pre><p>è¿™é‡Œç”¨åˆ°äº†æŒ‰æˆå‘˜åˆå§‹åŒ–çš„è¯­æ³•ï¼ŒæŠŠç±»å‹è®¾ç½®æˆäº†å­—ç¬¦ä¸²ï¼ŒåŒæ—¶è®¾ç½®äº†å­—ç¬¦ä¸²çš„å€¼ã€‚ä¸ç”¨è¯´ï¼Œè¿™æ˜¯ä»¶éº»çƒ¦ã€å®¹æ˜“å‡ºé”™çš„äº‹æƒ…ã€‚åŒæ—¶ï¼Œç»†æŸ¥ä¹‹åæˆ‘å‘ç°ï¼Œè¿™ä¸ªè¯­æ³•è™½ç„¶åœ¨ C99 é‡Œæœ‰ï¼Œä½†åœ¨ C++ é‡Œè¦åœ¨ C++20 æ‰ä¼šè¢«æ ‡å‡†åŒ–ï¼Œå› æ­¤å®é™…æ˜¯æœ‰å…¼å®¹æ€§é—®é¢˜çš„â€”â€”è€ç‰ˆæœ¬çš„ MSVCï¼Œæˆ–æœ€æ–°ç‰ˆæœ¬çš„ MSVC åœ¨æ²¡æœ‰å¼€å¯ C++20 æ”¯æŒæ—¶ï¼Œå°±ä¸æ”¯æŒè¿™ä¸ªè¯­æ³•ã€‚</p><p>æ‰€ä»¥ï¼Œç›®å‰çš„ä¸»æµå»ºè®®æ˜¯ï¼Œåº”è¯¥é¿å…ä½¿ç”¨â€œè£¸â€ union äº†ã€‚æ›¿æ¢æ–¹å¼ï¼Œå°±æ˜¯è¿™ä¸€èŠ‚è¦è¯´çš„ <code>variant</code>ã€‚ä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœç”¨ <code>variant</code> çš„è¯ï¼Œä¼šéå¸¸çš„å¹²å‡€åˆ©è½ï¼š</p><pre><code class=\"language-c++\">variant&lt;string, int, char&gt; obj{\n  \"Hello world\"};\ncout &lt;&lt; get&lt;string&gt;(obj) &lt;&lt; endl;\n</code></pre><p>å¯ä»¥æ³¨æ„åˆ°æˆ‘ä¸Šé¢æ„é€ æ—¶ä½¿ç”¨çš„æ˜¯ <code>const char*</code>ï¼Œä½†æ„é€ å‡½æ•°ä»ç„¶èƒ½å¤Ÿæ­£ç¡®åœ°é€‰æ‹© <code>string</code> ç±»å‹ï¼Œè¿™æ˜¯å› ä¸ºæ ‡å‡†è¦æ±‚å®ç°åœ¨æ²¡æœ‰ä¸€ä¸ªå®Œå…¨åŒ¹é…çš„ç±»å‹çš„æƒ…å†µä¸‹ï¼Œä¼šé€‰æ‹©æˆå‘˜ç±»å‹ä¸­èƒ½å¤Ÿä»¥ä¼ å…¥çš„ç±»å‹æ¥æ„é€ çš„é‚£ä¸ªç±»å‹è¿›è¡Œåˆå§‹åŒ–ï¼ˆæœ‰ä¸”åªæœ‰ä¸€ä¸ªæ—¶ï¼‰ã€‚<code>string</code> ç±»å­˜åœ¨å½¢å¼ä¸º <code>string(const char*)</code> çš„æ„é€ å‡½æ•°ï¼ˆä¸ç²¾ç¡®åœ°è¯´ï¼‰ï¼Œæ‰€ä»¥ä¸Šé¢çš„æ„é€ èƒ½å¤Ÿæ­£ç¡®è¿›è¡Œã€‚</p><p>è·Ÿ <code>tuple</code> ç›¸ä¼¼ï¼Œ<code>variant</code> ä¸Šå¯ä»¥ä½¿ç”¨ <code>get</code> å‡½æ•°æ¨¡æ¿ï¼Œå…¶æ¨¡æ¿å‚æ•°å¯ä»¥æ˜¯ä»£è¡¨åºå·çš„æ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯ç±»å‹ã€‚å¦‚æœç¼–è¯‘æ—¶å¯ä»¥ç¡®å®šåºå·æˆ–ç±»å‹ä¸åˆæ³•ï¼Œæˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶å°±ä¼šå‡ºé”™ã€‚å¦‚æœåºå·æˆ–ç±»å‹åˆæ³•ï¼Œä½†è¿è¡Œæ—¶å‘ç° <code>variant</code> é‡Œå­˜å‚¨çš„å¹¶ä¸æ˜¯è¯¥ç±»å¯¹è±¡ï¼Œæˆ‘ä»¬åˆ™ä¼šå¾—åˆ°ä¸€ä¸ªå¼‚å¸¸ <code>bad_variant_access</code>ã€‚</p><p><code>variant</code> ä¸Šè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æˆå‘˜å‡½æ•°æ˜¯ <code>index</code>ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬èƒ½è·å¾—å½“å‰çš„æ•°å€¼çš„åºå·ã€‚å°±æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­è€Œè¨€ï¼Œ<code>obj.index()</code> å³ä¸º <code>1</code>ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œ<code>variant</code> é‡Œæ€»æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å€¼ï¼ˆç¼ºçœä¸ºç¬¬ä¸€ä¸ªç±»å‹çš„é»˜è®¤æ„é€ ç»“æœï¼‰ï¼Œä½†å¦‚æœ <code>emplace</code> ç­‰ä¿®æ”¹æ“ä½œä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œ<code>variant</code> é‡Œä¹Ÿå¯èƒ½æ²¡æœ‰ä»»ä½•æœ‰æ•ˆæ•°å€¼ï¼Œæ­¤æ—¶ <code>index()</code> å°†ä¼šå¾—åˆ° <code>variant_npos</code>ã€‚</p><p>ä»åŸºæœ¬æ¦‚å¿µæ¥è®²ï¼Œ<code>variant</code> å°±æ˜¯ä¸€ä¸ªå®‰å…¨çš„ unionï¼Œç›¸å½“ç®€å•ï¼Œæˆ‘å°±ä¸å¤šåšå…¶ä»–ä»‹ç»äº†ã€‚ä½ å¯ä»¥è‡ªå·±çœ‹æ–‡æ¡£æ¥äº†è§£è¿›ä¸€æ­¥çš„ä¿¡æ¯ã€‚å…¶ä¸­æ¯”è¾ƒæœ‰è¶£çš„ä¸€ä¸ªéæˆå‘˜å‡½æ•°æ˜¯ <code>visit</code> <span class=\"orange\">[5]</span>ï¼Œæ–‡æ¡£é‡Œå±•ç¤ºäº†ä¸€ä¸ªéå¸¸ç®€æ´çš„ã€å¯æ ¹æ®å½“å‰åŒ…å«çš„å˜é‡ç±»å‹è¿›è¡Œå‡½æ•°åˆ†å‘çš„æ–¹æ³•ã€‚</p><p><strong>å¹³å°ç»†èŠ‚ï¼š</strong>åœ¨è€äº Mojave çš„ macOS ä¸Šç¼–è¯‘å«æœ‰ <code>optional</code> æˆ– <code>variant</code> çš„ä»£ç ï¼Œéœ€è¦åœ¨æ–‡ä»¶å¼€å¤´åŠ ä¸Šï¼š</p><pre><code class=\"language-c++\">#if defined(__clang__) &amp;&amp; defined(__APPLE__)\n#include &lt;__config&gt;\n#undef _LIBCPP_AVAILABILITY_BAD_OPTIONAL_ACCESS\n#undef _LIBCPP_AVAILABILITY_BAD_VARIANT_ACCESS\n#define _LIBCPP_AVAILABILITY_BAD_OPTIONAL_ACCESS\n#define _LIBCPP_AVAILABILITY_BAD_VARIANT_ACCESS\n#endif\n</code></pre><p>åŸå› æ˜¯è‹¹æœåœ¨å¤´æ–‡ä»¶é‡ŒæŠŠ <code>optional</code> å’Œ <code>variant</code> åœ¨æ—©æœŸç‰ˆæœ¬çš„ macOS ä¸Šç¦æ‰äº†ï¼Œè€Œä¸Šé¢çš„ä»£ç å»æ‰äº†è¿™å‡ ä¸ªå®é‡Œå¯¹ä½¿ç”¨ <code>bad_optional_access</code> å’Œ <code>bad_variant_access</code> çš„å¹³å°é™åˆ¶ã€‚æˆ‘çœŸçœ‹ä¸å‡ºä½¿ç”¨è¿™ä¸¤ä¸ªå¤´æ–‡ä»¶è·Ÿ macOS çš„ç‰ˆæœ¬æœ‰å•¥å…³ç³»ã€‚ğŸ˜</p><h2>expected</h2><p>å’Œå‰é¢ä»‹ç»çš„ä¸¤ä¸ªæ¨¡æ¿ä¸åŒï¼Œ<code>expected</code> ä¸æ˜¯ C++ æ ‡å‡†é‡Œçš„ç±»å‹ã€‚ä½†æ¦‚å¿µä¸Šè¿™ä¸‰è€…æœ‰ç›¸å…³æ€§ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿæ”¾åœ¨ä¸€èµ·è®²ä¸€ä¸‹ã€‚</p><p>æˆ‘å‰é¢å·²ç»æåˆ°ï¼Œ<code>optional</code> å¯ä»¥ä½œä¸ºä¸€ç§ä»£æ›¿å¼‚å¸¸çš„æ–¹å¼ï¼šåœ¨åŸæœ¬è¯¥æŠ›å¼‚å¸¸çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹è€Œè¿”å›ä¸€ä¸ªç©ºçš„ <code>optional</code> å¯¹è±¡ã€‚å½“ç„¶ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±åªçŸ¥é“æ²¡æœ‰è¿”å›ä¸€ä¸ªåˆæ³•çš„å¯¹è±¡ï¼Œè€Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰è¿”å›åˆæ³•å¯¹è±¡äº†ã€‚æˆ‘ä»¬å¯ä»¥è€ƒè™‘æ”¹ç”¨ä¸€ä¸ª <code>variant</code>ï¼Œä½†æˆ‘ä»¬æ­¤æ—¶éœ€è¦ç»™é”™è¯¯ç±»å‹ä¸€ä¸ªç‹¬ç‰¹çš„ç±»å‹æ‰è¡Œï¼Œå› ä¸ºè¿™æ˜¯ <code>variant</code> æ¨¡æ¿çš„è¦æ±‚ã€‚æ¯”å¦‚ï¼š</p><pre><code class=\"language-c++\">enum class error_code {\n  success,\n  operation_failure,\n  object_not_found,\n  â€¦\n};\n\nvariant&lt;Obj, error_code&gt;\n  get_object(â€¦);\n</code></pre><p>è¿™å½“ç„¶æ˜¯ä¸€ç§å¯è¡Œçš„é”™è¯¯å¤„ç†æ–¹å¼ï¼šæˆ‘ä»¬å¯ä»¥åˆ¤æ–­è¿”å›å€¼çš„ <code>index()</code>ï¼Œæ¥å†³å®šæ˜¯å¦å‘ç”Ÿäº†é”™è¯¯ã€‚ä½†è¿™ç§æ–¹å¼ä¸é‚£ä¹ˆç›´æˆªäº†å½“ï¼Œä¹Ÿè¦æ±‚å®ç°å¯¹å…è®¸çš„é”™è¯¯ç±»å‹ä½œå‡ºè§„å®šã€‚Andrei Alexandrescu åœ¨ 2012 å¹´é¦–å…ˆæå‡ºçš„ Expected æ¨¡æ¿ <span class=\"orange\">[6]</span>ï¼Œæä¾›äº†å¦å¤–ä¸€ç§é”™è¯¯å¤„ç†æ–¹å¼ã€‚ä»–çš„æ–¹æ³•çš„è¦ç‚¹åœ¨äºï¼ŒæŠŠå®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯æ”¾åœ¨è¿”å›å€¼ï¼Œå¹¶åœ¨å¿…è¦çš„æ—¶å€™ï¼Œå¯ä»¥â€œé‡æ”¾â€å‡ºæ¥ï¼Œæˆ–è€…æ‰‹å·¥æ£€æŸ¥æ˜¯ä¸æ˜¯æŸç§ç±»å‹çš„å¼‚å¸¸ã€‚</p><p>ä»–çš„æ¦‚å¿µå¹¶æ²¡æœ‰è¢«å¹¿æ³›æ¨å¹¿ï¼Œæœ€ä¸»è¦çš„åŸå› å¯èƒ½æ˜¯æ€§èƒ½ã€‚å¼‚å¸¸æœ€è¢«äººè¯Ÿç—…çš„åœ°æ–¹æ˜¯æ€§èƒ½ï¼Œè€Œä»–çš„æ–¹å¼å¯¹æ€§èƒ½å®Œå…¨æ²¡æœ‰å¸®åŠ©ã€‚ä¸è¿‡ï¼Œåé¢çš„ç±»ä¼¼æ¨¡æ¿éƒ½æ±²å–äº†ä»–çš„éƒ¨åˆ†æ€æƒ³ï¼Œè‡³å°‘ä¼šç”¨ä¸€ç§æ˜¾å¼çš„æ–¹å¼æ¥æ˜ç¡®è¯´æ˜å½“å‰æ˜¯å¼‚å¸¸æƒ…å†µè¿˜æ˜¯æ­£å¸¸æƒ…å†µã€‚åœ¨ç›®å‰çš„ expected çš„æ ‡å‡†ææ¡ˆ <span class=\"orange\">[7]</span> é‡Œï¼Œç”¨æ³•æœ‰ç‚¹æ˜¯ <code>optional</code> å’Œ <code>variant</code> çš„æŸç§æ··åˆï¼šæ¨¡æ¿çš„å£°æ˜å½¢å¼åƒ <code>variant</code>ï¼Œä½¿ç”¨æ­£å¸¸è¿”å›å€¼åƒ <code>optional</code>ã€‚</p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ä¸€ä¸ª expected å®ç° <span class=\"orange\">[8]</span> çš„åŸºæœ¬ç”¨æ³•ã€‚</p><pre><code class=\"language-c++\">#include &lt;climits&gt;\n#include &lt;iostream&gt;\n#include &lt;string&gt;\n#include &lt;tl/expected.hpp&gt;\n\nusing namespace std;\nusing tl::expected;\nusing tl::unexpected;\n\n// è¿”å› expected çš„å®‰å…¨é™¤æ³•\nexpected&lt;int, string&gt;\nsafe_divide(int i, int j)\n{\n  if (j == 0)\n    return unexpected(\n      \"divide by zero\"s);\n  if (i == INT_MIN &amp;&amp; j == -1)\n    return unexpected(\n      \"integer divide overflows\"s);\n  if (i % j != 0)\n    return unexpected(\n      \"not integer division\"s);\n  else\n    return i / j;\n}\n\n// ä¸€ä¸ªæµ‹è¯•å‡½æ•°\nexpected&lt;int, string&gt;\ncaller(int i, int j, int k)\n{\n  auto q = safe_divide(j, k);\n  if (q)\n    return i + *q;\n  else\n    return q;\n}\n\n// æ”¯æŒ expected çš„è¾“å‡ºå‡½æ•°\ntemplate &lt;typename T, typename E&gt;\nostream&amp; operator&lt;&lt;(\n  ostream&amp; os,\n  const expected&lt;T, E&gt;&amp; exp)\n{\n  if (exp) {\n    os &lt;&lt; exp.value();\n  } else {\n    os &lt;&lt; \"unexpected: \"\n       &lt;&lt; exp.error();\n  }\n  return os;\n}\n\n// è°ƒè¯•ä½¿ç”¨çš„æ£€æŸ¥å®\n#define CHECK(expr)               \\\n  {                               \\\n    auto result = (expr);         \\\n    cout &lt;&lt; result;               \\\n    if (result ==                 \\\n        unexpected(               \\\n          \"divide by zero\"s)) {   \\\n      cout                        \\\n        &lt;&lt; \": Are you serious?\";  \\\n    } else if (result == 42) {    \\\n      cout &lt;&lt; \": Ha, I got you!\"; \\\n    }                             \\\n    cout &lt;&lt; endl;                 \\\n  }\n\nint main()\n{\n  CHECK(caller(2, 1, 0));\n  CHECK(caller(37, 20, 7));\n  CHECK(caller(39, 21, 7));\n}\n</code></pre><p>è¾“å‡ºæ˜¯ï¼š</p><blockquote>\n<p><code>unexpected: divide by zero: Are you serious?</code><br>\n<code>unexpected: not integer division</code><br>\n<code>42: Ha, I got you!</code></p>\n</blockquote><p>ä¸€ä¸ª <code>expected&lt;T, E&gt;</code> å·®ä¸å¤šå¯ä»¥çœ‹ä½œæ˜¯ <code>T</code> å’Œ <code>unexpected&lt;E&gt;</code> çš„ <code>variant</code>ã€‚åœ¨å­¦è¿‡ä¸Šé¢çš„ <code>variant</code> ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¾ˆå®¹æ˜“çœ‹æ˜ç™½ä¸Šé¢çš„ç¨‹åºäº†ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªéœ€è¦æ³¨æ„ä¸€ä¸‹çš„åœ°æ–¹ï¼š</p><ul>\n<li>å¦‚æœä¸€ä¸ªå‡½æ•°è¦æ­£å¸¸è¿”å›æ•°æ®ï¼Œä»£ç æ— éœ€ä»»ä½•ç‰¹æ®Šå†™æ³•ï¼›å¦‚æœå®ƒè¦è¡¨ç¤ºå‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™å¯ä»¥è¿”å›ä¸€ä¸ª <code>unexpected</code> å¯¹è±¡ã€‚</li>\n<li>è¿™ä¸ªè¿”å›å€¼å¯ä»¥ç”¨æ¥å’Œä¸€ä¸ªæ­£å¸¸å€¼æˆ– unexpected å¯¹è±¡æ¯”è¾ƒï¼Œå¯ä»¥åœ¨å¸ƒå°”å€¼ä¸Šä¸‹æ–‡é‡Œæ£€æŸ¥æ˜¯å¦æœ‰æ­£å¸¸å€¼ï¼Œä¹Ÿå¯ä»¥ç”¨ <code>*</code> è¿ç®—ç¬¦æ¥å–å¾—å…¶ä¸­çš„æ­£å¸¸å€¼â€”â€”ä¸ <code>optional</code> ç±»ä¼¼ï¼Œåœ¨æ²¡æœ‰æ­£å¸¸å€¼çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>*</code> æ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚</li>\n<li>å¯ä»¥ç”¨ <code>value</code> æˆå‘˜å‡½æ•°æ¥å–å¾—å…¶ä¸­çš„æ­£å¸¸å€¼ï¼Œæˆ–ä½¿ç”¨ <code>error</code> æˆå‘˜å‡½æ•°æ¥å–å¾—å…¶ä¸­çš„é”™è¯¯å€¼â€”â€”ä¸ <code>variant</code> ç±»ä¼¼ï¼Œåœ¨ <code>expected</code> ä¸­æ²¡æœ‰å¯¹åº”çš„å€¼æ—¶äº§ç”Ÿå¼‚å¸¸ <code>bad_expected_access</code>ã€‚</li>\n<li>è¿”å›é”™è¯¯è·ŸæŠ›å‡ºå¼‚å¸¸æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ£€æŸ¥æ˜¯å¦å‘ç”Ÿé”™è¯¯çš„ä»£ç è¿˜æ˜¯è¦æ¯”å¼‚å¸¸å¤„ç†å•°å—¦ã€‚</li>\n</ul><h2>Herbception</h2><p>ä¸Šé¢çš„ç”¨æ³•åˆçœ‹è¿˜è¡Œï¼Œä½†çœŸæ­£ç”¨èµ·æ¥ï¼Œä½ ä¼šå‘ç°ä»ç„¶æ²¡æœ‰ä½¿ç”¨å¼‚å¸¸æ–¹ä¾¿ã€‚è¿™åªæ˜¯ä¸ºäº†è§£å†³å¼‚å¸¸åœ¨é”™è¯¯å¤„ç†æ€§èƒ½é—®é¢˜ä¸Šçš„æ— å¥ˆä¹‹ä¸¾ã€‚å¤§éƒ¨åˆ†è¯•å›¾æ›¿æ¢ C++ å¼‚å¸¸çš„æ–¹æ³•éƒ½æ˜¯ç‰ºç‰²ç¼–ç¨‹æ–¹ä¾¿æ€§ï¼Œæ¥æ¢å–æ€§èƒ½ã€‚åªæœ‰ Herb Sutter æå‡ºäº†ä¸€ä¸ªåŸºæœ¬å…¼å®¹å½“å‰ C++ å¼‚å¸¸å¤„ç†æ–¹å¼çš„é”™è¯¯å¤„ç†æ–¹å¼ <span class=\"orange\">[9]</span>ï¼Œè¢«æˆç§°ä¸º Herbceptionã€‚</p><p>ä¸Šé¢ä½¿ç”¨ expected çš„ç¤ºä¾‹ä»£ç ï¼Œå¦‚æœæ”¹ç”¨ Herbception çš„è¯ï¼Œå¯ä»¥å¤§è‡´å¦‚ä¸‹æ”¹é€ ï¼ˆç¤ºæ„ï¼Œå°šæ— æ³•ç¼–è¯‘ï¼‰ï¼š</p><pre><code class=\"language-c++\">int safe_divide(int i, int j) throws\n{\n  if (j == 0)\n    throw arithmetic_errc::\n      divide_by_zero;\n  if (i == INT_MIN &amp;&amp; j == -1)\n    throw arithmetic_errc::\n      integer_divide_overflows;\n  if (i % j != 0)\n    throw arithmetic_errc::\n      not_integer_division;\n  else\n    return i / j;\n}\n\nint caller(int i, int j,\n           int k) throws\n{\n  return i + safe_divide(j, k);\n}\n\n#define CHECK(expr)               \\\n  try {                           \\\n    int result = (expr);          \\\n    cout &lt;&lt; result;               \\\n    if (result == 42) {           \\\n      cout &lt;&lt; \": Ha, I got you!\"; \\\n    }                             \\\n  }                               \\\n  catch (error e) {               \\\n    if (e == arithmetic_errc::    \\\n               divide_by_zero) {  \\\n      cout                        \\\n        &lt;&lt; \"Are you serious? \";   \\\n    }                             \\\n    cout &lt;&lt; \"An error occurred\";  \\\n  }                               \\\n  cout &lt;&lt; endl\n\nint main()\n{\n  CHECK(caller(2, 1, 0));\n  CHECK(caller(37, 20, 7));\n  CHECK(caller(39, 21, 7));\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„ä»£ç å’Œæ™®é€šä½¿ç”¨å¼‚å¸¸çš„ä»£ç éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul>\n<li>å‡½æ•°éœ€è¦ä½¿ç”¨ <code>throws</code>ï¼ˆæ³¨æ„ä¸æ˜¯ <code>throw</code>ï¼‰è¿›è¡Œå£°æ˜ã€‚</li>\n<li>æŠ›å‡ºå¼‚å¸¸çš„è¯­æ³•å’Œä¸€èˆ¬å¼‚å¸¸è¯­æ³•ç›¸åŒï¼Œä½†æŠ›å‡ºçš„æ˜¯ä¸€ä¸ª <code>std::error</code> å€¼ <span class=\"orange\">[10]</span>ã€‚</li>\n<li>æ•æ‰å¼‚å¸¸æ—¶ä¸éœ€è¦ä½¿ç”¨å¼•ç”¨ï¼ˆå› ä¸º <code>std::error</code> æ˜¯ä¸ªâ€œå°â€å¯¹è±¡ï¼‰ï¼Œä¸”ä½¿ç”¨ä¸€èˆ¬çš„æ¯”è¾ƒæ“ä½œæ¥æ£€æŸ¥å¼‚å¸¸â€œç±»å‹â€ï¼Œä¸å†ä½¿ç”¨å¼€é”€å¤§çš„ RTTIã€‚</li>\n</ul><p>è™½ç„¶è¯­æ³•ä¸ŠåŸºæœ¬æ˜¯ä½¿ç”¨å¼‚å¸¸çš„æ ·å­ï¼Œä½† Herb çš„æ–¹æ¡ˆå´æ²¡æœ‰å¼‚å¸¸çš„ä¸ç¡®å®šå¼€é”€ï¼Œæ€§èƒ½å’Œä½¿ç”¨ expected ç›¸ä»¿ã€‚ä»–ç‰ºç‰²äº†å¼‚å¸¸ç±»å‹çš„ä¸°å¯Œï¼Œä½†ä»å®é™…ç¼–ç¨‹ç»éªŒæ¥çœ‹ï¼Œè¶Šæ˜¯ä½“ç°å‡ºå¼‚å¸¸ä¼˜è¶Šæ€§çš„åœ°æ–¹â€”â€”å¼‚å¸¸å¤„ç†ç‚¹å’Œå¼‚å¸¸å‘ç”Ÿç‚¹è·ç¦»è¾ƒè¿œçš„æ—¶å€™â€”â€”è¶Šä¸éœ€è¦å¼‚å¸¸æœ‰ä¸°å¯Œçš„ç±»å‹ã€‚å› æ­¤ï¼Œæ€»ä½“ä¸Šçœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¸å¼•äººçš„æ–¹æ¡ˆã€‚ä¸è¿‡ï¼Œç”±äºææ¡ˆæ—¶é—´è¾ƒæ™šï¼Œäº‰è®®é¢‡å¤šï¼Œè¿™ä¸ªæ–¹æ¡ˆè¦è¿›å…¥æ ‡å‡†è‡³å°‘è¦ C++23 äº†ã€‚æˆ‘ä»¬ç›®å‰ç¨ç¨äº†è§£ä¸€ä¸‹å°±è¡Œã€‚</p><p>æ›´å¤šæŠ€æœ¯ç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹å‚è€ƒèµ„æ–™ã€‚</p><h2>å†…å®¹å°ç»“</h2><p>æœ¬è®²æˆ‘ä»¬è®¨è®ºäº†ä¸¤ä¸ª C++ æ ‡å‡†åº“çš„æ¨¡æ¿ <code>optional</code> å’Œ <code>variant</code>ï¼Œç„¶åè®¨è®ºäº†ä¸¤ä¸ªæ ‡å‡†ææ¡ˆ expected å’Œ Herbceptionã€‚è¿™äº›ç»“æ„éƒ½å¯ä»¥ä½¿ç”¨åœ¨é”™è¯¯å¤„ç†è¿‡ç¨‹ä¸­â€”â€”å‰ä¸‰è€…å½“å‰å¯ç”¨ï¼Œä½†å’Œå¼‚å¸¸ç›¸æ¯”æœ‰ä¸åŒçš„å–èˆï¼›Herbception å½“å‰è¿˜ä¸å¯ç”¨ï¼Œä½†æœ‰å¸Œæœ›åœ¨é”™è¯¯å¤„ç†ä¸Šè¾¾åˆ°æœ€ä½³çš„æƒè¡¡ç‚¹ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>é”™è¯¯å¤„ç†æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„é—®é¢˜ï¼Œåœ¨ C++ è¯ç”Ÿä¹‹åè¿™ä¹ˆå¤šå¹´ä»ç„¶æ²¡æœ‰è¯¥å¦‚ä½•å¤„ç†çš„å®šè®ºã€‚å¦‚ä½•å¯¹æ˜“ç”¨æ€§å’Œæ€§èƒ½è¿›è¡Œå–èˆï¼Œä¸€ç›´æ˜¯ä¸€ä¸ªæœ‰çŸ›ç›¾çš„è€å¤§éš¾é—®é¢˜ã€‚ä½ çš„å®é™…é¡¹ç›®ä¸­æ˜¯å¦‚ä½•é€‰æ‹©çš„ï¼Ÿä½ è§‰å¾—åº”è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„çœ‹æ³•ã€‚</p><h2><span class=\"reference\">å‚è€ƒèµ„æ–™</span></h2><p><span class=\"reference\">[1] Wikipedia, â€œNull object patternâ€. <a href=\"https://en.wikipedia.org/wiki/Null_object_pattern\">https://en.wikipedia.org/wiki/Null_object_pattern</a> </span></p><p><span class=\"reference\">[2] cppreference.com, â€œstd::optionalâ€. <a href=\"https://en.cppreference.com/w/cpp/utility/optional\">https://en.cppreference.com/w/cpp/utility/optional</a> </span></p><p><span class=\"reference\">[2a] cppreference.com, â€œstd::optionalâ€. <a href=\"https://zh.cppreference.com/w/cpp/utility/optional\">https://zh.cppreference.com/w/cpp/utility/optional</a> </span></p><p><span class=\"reference\">[3] Chase Geigle, cpptoml. <a href=\"https://github.com/skystrife/cpptoml\">https://github.com/skystrife/cpptoml</a> </span></p><p><span class=\"reference\">[4] cppreference.com, â€œstd::optionalâ€. <a href=\"https://en.cppreference.com/w/cpp/utility/variant\">https://en.cppreference.com/w/cpp/utility/variant</a> </span></p><p><span class=\"reference\">[4a] cppreference.com, â€œstd::optionalâ€. <a href=\"https://zh.cppreference.com/w/cpp/utility/variant\">https://zh.cppreference.com/w/cpp/utility/variant</a> </span></p><p><span class=\"reference\">[5] cppreference.com, â€œstd::visitâ€. <a href=\"https://en.cppreference.com/w/cpp/utility/variant/visit\">https://en.cppreference.com/w/cpp/utility/variant/visit</a> </span></p><p><span class=\"reference\">[5a] cppreference.com, â€œstd::visitâ€. <a href=\"https://zh.cppreference.com/w/cpp/utility/variant/visit\">https://zh.cppreference.com/w/cpp/utility/variant/visit</a> </span></p><p><span class=\"reference\">[6] Andrei Alexandrescu, â€œSystematic error handling in C++â€. <a href=\"https://channel9.msdn.com/Shows/Going+Deep/C-and-Beyond-2012-Andrei-Alexandrescu-Systematic-Error-Handling-in-C\">https://channel9.msdn.com/Shows/Going+Deep/C-and-Beyond-2012-Andrei-Alexandrescu-Systematic-Error-Handling-in-C</a> </span></p><p><span class=\"reference\">[7] Vicente J. Botet EscribÃ¡ and JF Bastien, â€œUtility class to represent expected objectâ€. <a href=\"http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0323r3.pdf\">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0323r3.pdf</a> </span></p><p><span class=\"reference\">[8] Simon Brand, expected. <a href=\"https://github.com/TartanLlama/expected\">https://github.com/TartanLlama/expected</a> </span></p><p><span class=\"reference\">[9] Herb Sutter, â€œP0709R0: Zero-overhead deterministic exceptions: Throwing valuesâ€. <a href=\"http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0709r0.pdf\">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0709r0.pdf</a> </span></p><p><span class=\"reference\">[10] Niall Douglas, â€œP1028R0: SG14 <code>status_code</code> and standard <code>error object</code> for P0709 Zero-overhead deterministic exceptionsâ€. <a href=\"http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p1028r0.pdf\">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p1028r0.pdf</a> </span></p>","neighbors":{"left":{"article_title":"21 | å·¥å…·æ¼«è°ˆï¼šç¼–è¯‘ã€æ ¼å¼åŒ–ã€ä»£ç æ£€æŸ¥ã€æ’é”™å„æ˜¾èº«æ‰‹","id":187980},"right":{"article_title":"23 | æ•°å­—è®¡ç®—ï¼šä»‹ç»çº¿æ€§ä»£æ•°å’Œæ•°å€¼è®¡ç®—åº“","id":189042}},"comments":[{"had_liked":false,"id":171917,"user_name":"å»–ç†ŠçŒ«","can_delete":false,"product_type":"c1","uid":1141444,"ip_address":"","ucode":"8E8C475CD11FBC","user_header":"https://static001.geekbang.org/account/avatar/00/11/6a/c4/8679ca8a.jpg","comment_is_top":false,"comment_ctime":1579053107,"is_pvip":false,"replies":[{"id":"66699","content":"optional å¯¹åº”çš„æ˜¯ Maybe å§ã€‚expected æ¯”è¾ƒåƒ Eitherã€‚<br><br>ä¸ä¼šè®² monadã€‚è¿™ä¸ªå³ä½¿ä¸“é—¨è®²å‡½æ•°å¼ç¼–ç¨‹ä¹Ÿè¦æ¯”è¾ƒåé¢å‘¢ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1579081359,"ip_address":"","comment_id":171917,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10168987699","product_id":100040501,"comment_content":"æœ‰çš„è¯­è¨€é‡Œé¢æ²¡æœ‰try catchï¼Œç»Ÿä¸€ä½¿ç”¨ç±»ä¼¼optionalçš„ç»“å±€æ–¹æ¡ˆï¼Œæ¯”å¦‚Rusté‡Œé¢çš„Errï¼ŒHaskellä¸­å¯¹åº”çš„åº”è¯¥æ˜¯Eitherç±»å‹ï¼Œè¿™äº›éƒ½æ˜¯å¤„ç†å¯ä»¥æ¢å¤çš„é”™è¯¯ï¼Œä¸å¯æ¢å¤çš„ç›´æ¥å°±è®©ç¨‹åºå´©äº†ã€‚<br>lift_optionalè®©æˆ‘æƒ³èµ·æ¥è¢«Haskellæ”¯é…çš„ææƒ§ (Just (+) ) &lt;*&gt;  Just 41 &lt;*&gt; Just 1<br>ä¸çŸ¥é“è€å¸ˆåé¢ä¼šä¸ä¼šè®²åˆ°monadğŸ˜‚","like_count":2,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481545,"discussion_content":"optional å¯¹åº”çš„æ˜¯ Maybe å§ã€‚expected æ¯”è¾ƒåƒ Eitherã€‚\n\nä¸ä¼šè®² monadã€‚è¿™ä¸ªå³ä½¿ä¸“é—¨è®²å‡½æ•°å¼ç¼–ç¨‹ä¹Ÿè¦æ¯”è¾ƒåé¢å‘¢ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579081359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171863,"user_name":"tt","can_delete":false,"product_type":"c1","uid":1489957,"ip_address":"","ucode":"7753B79AD5A9AC","user_header":"https://static001.geekbang.org/account/avatar/00/16/bc/25/1c92a90c.jpg","comment_is_top":false,"comment_ctime":1579047886,"is_pvip":false,"replies":[{"id":"66752","content":"æ˜¯çš„ã€‚æé«˜å¼€å‘çš„å‹å¥½ç¨‹åº¦ï¼Œå°¤å…¶æ˜¯å¯¹æ–°æ‰‹çš„å‹å¥½ç¨‹åº¦ï¼Œä¸€ç›´æ˜¯ C++ å§”å‘˜ä¼šçš„ç›®æ ‡ã€‚ä½ åº”è¯¥å‘ç°è™½ç„¶è¯­è¨€è¶Šæ¥è¶Šå¤æ‚ï¼Œä½†å¾ˆå¤šä¸œè¥¿å´è¶Šæ¥è¶Šå¥½å†™äº†ã€‚<br><br>å¼‚å¸¸çš„å®ç°éå¸¸å¤æ‚ã€‚æƒ³äº†è§£çš„è¯éœ€è¦èŠ±ç‚¹åŠ›æ°”ã€‚ä¸è¿‡æˆ‘å€’æ˜¯æŸ¥åˆ°æœ‰ç¯‡è¿˜ä¸é”™çš„ä¸­æ–‡æ–‡ç« ï¼Œæ¨èä¸€çœ‹ï¼š<br><br>http:&#47;&#47;baiy.cn&#47;doc&#47;cpp&#47;inside_exception.htm","user_name":"ä½œè€…å›å¤","user_name_real":"å´å’ç‚œ","uid":"1645639","ctime":1579099089,"ip_address":"","comment_id":171863,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10168982478","product_id":100040501,"comment_content":"è€å¸ˆï¼Œå¬äº†æ‚¨çš„è¯¾åï¼Œè§‰å¾—ç°åœ¨C++æ ‡å‡†ææ¡ˆæœ‰å¾ˆå¤šéƒ½æ˜¯åˆ©ç”¨C++çš„è¯­ä¹‰å’Œè¯­æ³•æ¥å†™æå‡ç¼–ç¨‹ä¾¿åˆ©æ€§çš„æ¨¡æ¿ï¼Œæ˜¯è¿™æ ·ä¹ˆï¼Ÿ<br><br>è¿˜æœ‰ï¼Œä¸€ç›´ä¸çŸ¥é“C++çš„å¼‚å¸¸æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿˜æœ‰è¿™é‡Œè¯´çš„å¼‚å¸¸å¤„ç†çš„æ€§èƒ½é—®é¢˜ï¼Œæœ‰æ¨èçš„æ¯”è¾ƒå¥½é˜…è¯»çš„å‚è€ƒæ–‡çŒ®ä¹ˆï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481534,"discussion_content":"æ˜¯çš„ã€‚æé«˜å¼€å‘çš„å‹å¥½ç¨‹åº¦ï¼Œå°¤å…¶æ˜¯å¯¹æ–°æ‰‹çš„å‹å¥½ç¨‹åº¦ï¼Œä¸€ç›´æ˜¯ C++ å§”å‘˜ä¼šçš„ç›®æ ‡ã€‚ä½ åº”è¯¥å‘ç°è™½ç„¶è¯­è¨€è¶Šæ¥è¶Šå¤æ‚ï¼Œä½†å¾ˆå¤šä¸œè¥¿å´è¶Šæ¥è¶Šå¥½å†™äº†ã€‚\n\nå¼‚å¸¸çš„å®ç°éå¸¸å¤æ‚ã€‚æƒ³äº†è§£çš„è¯éœ€è¦èŠ±ç‚¹åŠ›æ°”ã€‚ä¸è¿‡æˆ‘å€’æ˜¯æŸ¥åˆ°æœ‰ç¯‡è¿˜ä¸é”™çš„ä¸­æ–‡æ–‡ç« ï¼Œæ¨èä¸€çœ‹ï¼š\n\nhttp://baiy.cn/doc/cpp/inside_exception.htm","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1579099089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2062252,"avatar":"","nickname":"å¸¸æŒ¯å","note":"","ucode":"D61B40E1CCEFD5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531440,"discussion_content":"å…¶å®æˆ‘è§‰å¾—è¿™äº›æ–°æ¨¡æ¿ã€è¯­æ³•åè€Œæ›´éš¾ç†è§£ï¼Œä¸€ç›´éƒ½ä¸å–œæ¬¢pythonè¿™ç§è¯­è¨€çš„è¯­æ³•ï¼Œè¶ŠåŸå§‹çš„è¯­æ³•åè€Œè¶Šå®¹æ˜“ç†è§£ï¼Œè§„åˆ™å¤ªå¤šäº†å¹¶ä¸å®¹æ˜“è®°å¿†å’Œåº”ç”¨ã€‚æˆ‘è§‰å¾—C++çš„ä¸»è¦é—®é¢˜æ˜¯åº“å¤ªå°‘ï¼Œè½®å­å¤ªå°‘ï¼Œä¸æƒ³é«˜çº§è¯­è¨€é‚£ä¹ˆå¤šç°æˆçš„åº“å¯ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637311663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358385,"user_name":"Ã—22","can_delete":false,"product_type":"c1","uid":2412446,"ip_address":"æ±Ÿè‹","ucode":"68DA918813054E","user_header":"https://static001.geekbang.org/account/avatar/00/24/cf/9e/e695885e.jpg","comment_is_top":false,"comment_ctime":1664262666,"is_pvip":false,"replies":[{"id":"130658","content":"åº”è¯¥æ˜¯å§ã€‚ä½†æˆ‘å¯¹Rustä¸ç†Ÿã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1645639","ctime":1665378866,"ip_address":"æ±Ÿè‹","comment_id":358385,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1664262666","product_id":100040501,"comment_content":"æ„Ÿè§‰optionalå°±å’Œrusté‡Œé¢çš„Option&lt;&gt;ä¸€æ ·ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1645639,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/47/53c48284.jpg","nickname":"å´å’ç‚œ","note":"","ucode":"8C24C10AEC779F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589872,"discussion_content":"åº”è¯¥æ˜¯å§ã€‚ä½†æˆ‘å¯¹Rustä¸ç†Ÿã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665378866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ±Ÿè‹"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}