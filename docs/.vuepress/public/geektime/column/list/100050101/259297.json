{"id":259297,"title":"32 | GroupCoordinatorï¼šåœ¨Rebalanceä¸­ï¼ŒCoordinatorå¦‚ä½•å¤„ç†æˆå‘˜å…¥ç»„ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä¸çŸ¥ä¸è§‰é—´ï¼Œè¯¾ç¨‹å·²ç»æ¥è¿‘å°¾å£°äº†ï¼Œæœ€åè¿™ä¸¤èŠ‚è¯¾ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹æ¶ˆè´¹è€…ç»„çš„Rebalanceæµç¨‹æ˜¯å¦‚ä½•å®Œæˆçš„ã€‚</p><p>æåˆ°Rebalanceï¼Œä½ çš„ç¬¬ä¸€ååº”ä¸€å®šæ˜¯â€œçˆ±æ¨äº¤åŠ â€ã€‚æ¯•ç«Ÿï¼Œå¦‚æœä½¿ç”¨å¾—å½“ï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨å¸®æˆ‘ä»¬å®ç°æ¶ˆè´¹è€…ä¹‹é—´çš„è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ï¼›ä½†å¦‚æœé…ç½®å¤±å½“ï¼Œæˆ‘ä»¬å°±å¯èƒ½è§¦ç¢°åˆ°å®ƒè¢«è¯Ÿç—…å·²ä¹…çš„ç¼ºé™·ï¼šè€—æ—¶é•¿ï¼Œè€Œä¸”ä¼šå‡ºç°æ¶ˆè´¹ä¸­æ–­ã€‚</p><p>åœ¨ä½¿ç”¨æ¶ˆè´¹è€…ç»„çš„å®è·µä¸­ï¼Œä½ è‚¯å®šæƒ³çŸ¥é“ï¼Œåº”è¯¥å¦‚ä½•é¿å…Rebalanceã€‚å¦‚æœä½ ä¸äº†è§£Rebalanceçš„æºç æœºåˆ¶çš„è¯ï¼Œå°±å¾ˆå®¹æ˜“æ‰è¿›å®ƒæ— æ„ä¸­é“ºè®¾çš„â€œé™·é˜±â€é‡Œã€‚</p><p>ä¸¾ä¸ªå°ä¾‹å­ã€‚æœ‰äº›äººè®¤ä¸ºï¼ŒConsumerç«¯å‚æ•°session.timeout.mså†³å®šäº†å®Œæˆä¸€æ¬¡Rebalanceæµç¨‹çš„æœ€å¤§æ—¶é—´ã€‚è¿™ç§è®¤çŸ¥æ˜¯ä¸å¯¹çš„ï¼Œå®é™…ä¸Šï¼Œè¿™ä¸ªå‚æ•°æ˜¯ç”¨äºæ£€æµ‹æ¶ˆè´¹è€…ç»„æˆå‘˜å­˜æ´»æ€§çš„ï¼Œå³å¦‚æœåœ¨è¿™æ®µè¶…æ—¶æ—¶é—´å†…ï¼Œæ²¡æœ‰æ”¶åˆ°è¯¥æˆå‘˜å‘ç»™Coordinatorçš„å¿ƒè·³è¯·æ±‚ï¼Œåˆ™æŠŠè¯¥æˆå‘˜æ ‡è®°ä¸ºDeadï¼Œè€Œä¸”è¦æ˜¾å¼åœ°å°†å…¶ä»æ¶ˆè´¹è€…ç»„ä¸­ç§»é™¤ï¼Œå¹¶è§¦å‘æ–°ä¸€è½®çš„Rebalanceã€‚è€ŒçœŸæ­£å†³å®šå•æ¬¡Rebalanceæ‰€ç”¨æœ€å¤§æ—¶é•¿çš„å‚æ•°ï¼Œæ˜¯Consumerç«¯çš„<strong>max.poll.interval.ms</strong>ã€‚æ˜¾ç„¶ï¼Œå¦‚æœæ²¡æœ‰ææ‡‚è¿™éƒ¨åˆ†çš„æºç ï¼Œä½ å°±æ²¡åŠæ³•ä¸ºè¿™äº›å‚æ•°è®¾ç½®åˆç†çš„æ•°å€¼ã€‚</p><!-- [[[read_end]]] --><p>æ€»ä½“è€Œè¨€ï¼Œ Rebalanceçš„æµç¨‹å¤§è‡´åˆ†ä¸ºä¸¤å¤§æ­¥ï¼šåŠ å…¥ç»„ï¼ˆJoinGroupï¼‰å’Œç»„åŒæ­¥ï¼ˆSyncGroupï¼‰ã€‚</p><p><strong>åŠ å…¥ç»„ï¼Œæ˜¯æŒ‡æ¶ˆè´¹è€…ç»„ä¸‹çš„å„ä¸ªæˆå‘˜å‘Coordinatorå‘é€JoinGroupRequestè¯·æ±‚åŠ å…¥è¿›ç»„çš„è¿‡ç¨‹</strong>ã€‚è¿™ä¸ªè¿‡ç¨‹æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå¦‚æœæœ‰æˆå‘˜åœ¨è¶…æ—¶æ—¶é—´ä¹‹å†…ï¼Œæ— æ³•å®ŒæˆåŠ å…¥ç»„æ“ä½œï¼Œå®ƒå°±ä¼šè¢«æ’é™¤åœ¨è¿™è½®Rebalanceä¹‹å¤–ã€‚</p><p>ç»„åŒæ­¥ï¼Œæ˜¯æŒ‡å½“æ‰€æœ‰æˆå‘˜éƒ½æˆåŠŸåŠ å…¥ç»„ä¹‹åï¼ŒCoordinatoræŒ‡å®šå…¶ä¸­ä¸€ä¸ªæˆå‘˜ä¸ºLeaderï¼Œç„¶åå°†è®¢é˜…åˆ†åŒºä¿¡æ¯å‘ç»™Leaderæˆå‘˜ã€‚æ¥ç€ï¼Œæ‰€æœ‰æˆå‘˜ï¼ˆåŒ…æ‹¬Leaderæˆå‘˜ï¼‰å‘Coordinatorå‘é€SyncGroupRequestè¯·æ±‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>åªæœ‰Leaderæˆå‘˜å‘é€çš„è¯·æ±‚ä¸­åŒ…å«äº†è®¢é˜…åˆ†åŒºæ¶ˆè´¹åˆ†é…æ–¹æ¡ˆï¼Œåœ¨å…¶ä»–æˆå‘˜å‘é€çš„è¯·æ±‚ä¸­ï¼Œè¿™éƒ¨åˆ†çš„å†…å®¹ä¸ºç©º</strong>ã€‚å½“Coordinatoræ¥æ”¶åˆ°åˆ†é…æ–¹æ¡ˆåï¼Œä¼šé€šè¿‡å‘æˆå‘˜å‘é€å“åº”çš„æ–¹å¼ï¼Œé€šçŸ¥å„ä¸ªæˆå‘˜è¦æ¶ˆè´¹å“ªäº›åˆ†åŒºã€‚</p><p>å½“ç»„åŒæ­¥å®Œæˆåï¼ŒRebalanceå®£å‘Šç»“æŸã€‚æ­¤æ—¶ï¼Œæ¶ˆè´¹è€…ç»„å¤„äºæ­£å¸¸å·¥ä½œçŠ¶æ€ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å°±å­¦ä¹ ä¸‹ç¬¬ä¸€å¤§æ­¥ï¼Œä¹Ÿå°±æ˜¯åŠ å…¥ç»„çš„æºç å®ç°ï¼Œå®ƒä»¬ä½äºGroupCoordinator.scalaæ–‡ä»¶ä¸­ã€‚ä¸‹èŠ‚è¯¾ï¼Œæˆ‘ä»¬å†æ·±å…¥åœ°å­¦ä¹ ç»„åŒæ­¥çš„æºç å®ç°ã€‚</p><p>è¦ææ‡‚åŠ å…¥ç»„çš„æºç æœºåˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦å­¦ä¹ 4ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯handleJoinGroupã€doUnknownJoinGroupã€doJoinGroupå’ŒaddMemberAndRebalanceã€‚handleJoinGroupæ˜¯æ‰§è¡ŒåŠ å…¥ç»„çš„é¡¶å±‚æ–¹æ³•ï¼Œè¢«KafkaApisç±»è°ƒç”¨ï¼Œè¯¥æ–¹æ³•ä¾æ®ç»™å®šæ¶ˆè´¹è€…ç»„æˆå‘˜æ˜¯å¦äº†è®¾ç½®æˆå‘˜IDï¼Œæ¥å†³å®šæ˜¯è°ƒç”¨doUnknownJoinGroupè¿˜æ˜¯doJoinGroupï¼Œå‰è€…å¯¹åº”äºæœªè®¾å®šæˆå‘˜IDçš„æƒ…å½¢ï¼Œåè€…å¯¹åº”äºå·²è®¾å®šæˆå‘˜IDçš„æƒ…å½¢ã€‚è€Œè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨addMemberAndRebalanceï¼Œæ‰§è¡ŒçœŸæ­£çš„åŠ å…¥ç»„é€»è¾‘ã€‚ä¸ºäº†å¸®åŠ©ä½ ç†è§£å®ƒä»¬ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œå€Ÿç”¨å®ƒå±•ç¤ºäº†è¿™4ä¸ªæ–¹æ³•çš„è°ƒç”¨é¡ºåºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b7/20/b7ed79cbf4eba29b39f32015b527c220.jpg?wh=2256*2084\" alt=\"\"></p><h2>handleJoinGroupæ–¹æ³•</h2><p>å¦‚æœä½ ç¿»å¼€KafkaApis.scalaè¿™ä¸ªAPIå…¥å£æ–‡ä»¶ï¼Œå°±å¯ä»¥çœ‹åˆ°ï¼Œå¤„ç†JoinGroupRequestè¯·æ±‚çš„æ–¹æ³•æ˜¯handleJoinGroupRequestã€‚è€Œå®ƒçš„ä¸»è¦é€»è¾‘ï¼Œå°±æ˜¯<strong>è°ƒç”¨GroupCoordinatorçš„handleJoinGroupæ–¹æ³•ï¼Œæ¥å¤„ç†æ¶ˆè´¹è€…ç»„æˆå‘˜å‘é€è¿‡æ¥çš„åŠ å…¥ç»„è¯·æ±‚ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å…·ä½“å­¦ä¹ ä¸€ä¸‹handleJoinGroupæ–¹æ³•</strong>ã€‚å…ˆçœ‹å®ƒçš„æ–¹æ³•ç­¾åï¼š</p><pre><code>def handleJoinGroup(\n  groupId: String, // æ¶ˆè´¹è€…ç»„å\n  memberId: String, // æ¶ˆè´¹è€…ç»„æˆå‘˜ID\n  groupInstanceId: Option[String], // ç»„å®ä¾‹IDï¼Œç”¨äºæ ‡è¯†é™æ€æˆå‘˜\n  requireKnownMemberId: Boolean, // æ˜¯å¦éœ€è¦æˆå‘˜IDä¸ä¸ºç©º\n  clientId: String, // client.idå€¼\n  clientHost: String, // æ¶ˆè´¹è€…ç¨‹åºä¸»æœºå\n  rebalanceTimeoutMs: Int, // Rebalanceè¶…æ—¶æ—¶é—´,é»˜è®¤æ˜¯max.poll.interval.mså€¼\n  sessionTimeoutMs: Int, // ä¼šè¯è¶…æ—¶æ—¶é—´\n  protocolType: String, // åè®®ç±»å‹\n  protocols: List[(String, Array[Byte])], // æŒ‰ç…§åˆ†é…ç­–ç•¥åˆ†ç»„çš„è®¢é˜…åˆ†åŒº\n  responseCallback: JoinCallback // å›è°ƒå‡½æ•°\n  ): Unit = {\n  ......\n} \n</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„å‚æ•°æœ‰å¾ˆå¤šï¼Œæˆ‘ä»‹ç»å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„ã€‚æ¥ä¸‹æ¥åœ¨é˜…è¯»å…¶ä»–æ–¹æ³•çš„æºç æ—¶ï¼Œä½ è¿˜ä¼šçœ‹åˆ°è¿™äº›å‚æ•°ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œä½ ä¸€å®šè¦æå‰æŒæ¡å®ƒä»¬çš„å«ä¹‰ã€‚</p><ul>\n<li>groupIdï¼šæ¶ˆè´¹è€…ç»„åã€‚</li>\n<li>memberIdï¼šæ¶ˆè´¹è€…ç»„æˆå‘˜IDã€‚å¦‚æœæˆå‘˜æ˜¯æ–°åŠ å…¥çš„ï¼Œé‚£ä¹ˆè¯¥å­—æ®µæ˜¯ç©ºå­—ç¬¦ä¸²ã€‚</li>\n<li>groupInstanceIdï¼šè¿™æ˜¯ç¤¾åŒºäº2.4ç‰ˆæœ¬å¼•å…¥çš„é™æ€æˆå‘˜å­—æ®µã€‚é™æ€æˆå‘˜çš„å¼•å…¥ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…å› ç³»ç»Ÿå‡çº§æˆ–ç¨‹åºæ›´æ–°è€Œå¯¼è‡´çš„Rebalanceåœºæ™¯ã€‚å®ƒå±äºæ¯”è¾ƒé«˜é˜¶çš„ç”¨æ³•ï¼Œè€Œä¸”ç›®å‰è¿˜æ²¡æœ‰è¢«å¤§è§„æ¨¡ä½¿ç”¨ï¼Œå› æ­¤ï¼Œè¿™é‡Œä½ åªéœ€è¦ç®€å•äº†è§£ä¸€ä¸‹å®ƒçš„ä½œç”¨ã€‚å¦å¤–ï¼Œåé¢åœ¨è®²å…¶ä»–æ–¹æ³•æ—¶ï¼Œæˆ‘ä¼šç›´æ¥çœç•¥é™æ€æˆå‘˜çš„ä»£ç ï¼Œæˆ‘ä»¬åªå…³æ³¨æ ¸å¿ƒé€»è¾‘å°±è¡Œäº†ã€‚</li>\n<li>requireKnownMemberIdï¼šæ˜¯å¦è¦æ±‚æˆå‘˜IDä¸ä¸ºç©ºï¼Œå³æ˜¯å¦è¦æ±‚æˆå‘˜å¿…é¡»è®¾ç½®IDçš„å¸ƒå°”å­—æ®µã€‚è¿™ä¸ªå­—æ®µå¦‚æœä¸ºTrueçš„è¯ï¼Œé‚£ä¹ˆï¼ŒKafkaè¦æ±‚æ¶ˆè´¹è€…ç»„æˆå‘˜å¿…é¡»è®¾ç½®IDã€‚æœªè®¾ç½®IDçš„æˆå‘˜ï¼Œä¼šè¢«æ‹’ç»åŠ å…¥ç»„ã€‚ç›´åˆ°å®ƒè®¾ç½®äº†IDä¹‹åï¼Œæ‰èƒ½é‡æ–°åŠ å…¥ç»„ã€‚</li>\n<li>clientIdï¼šæ¶ˆè´¹è€…ç«¯å‚æ•°client.idå€¼ã€‚Coordinatorä½¿ç”¨å®ƒæ¥ç”ŸæˆmemberIdã€‚memberIdçš„æ ¼å¼æ˜¯clientIdå€¼-UUIDã€‚</li>\n<li>clientHostï¼šæ¶ˆè´¹è€…ç¨‹åºçš„ä¸»æœºåã€‚</li>\n<li>rebalanceTimeoutMsï¼šRebalanceè¶…æ—¶æ—¶é—´ã€‚å¦‚æœåœ¨è¿™ä¸ªæ—¶é—´æ®µå†…ï¼Œæ¶ˆè´¹è€…ç»„æˆå‘˜æ²¡æœ‰å®ŒæˆåŠ å…¥ç»„çš„æ“ä½œï¼Œå°±ä¼šè¢«ç¦æ­¢å…¥ç»„ã€‚</li>\n<li>sessionTimeoutMsï¼šä¼šè¯è¶…æ—¶æ—¶é—´ã€‚å¦‚æœæ¶ˆè´¹è€…ç»„æˆå‘˜æ— æ³•åœ¨è¿™æ®µæ—¶é—´å†…å‘Coordinatoræ±‡æŠ¥å¿ƒè·³ï¼Œé‚£ä¹ˆå°†è¢«è§†ä¸ºâ€œå·²è¿‡æœŸâ€ï¼Œä»è€Œå¼•å‘æ–°ä¸€è½®Rebalanceã€‚</li>\n<li>responseCallbackï¼šå®ŒæˆåŠ å…¥ç»„ä¹‹åçš„å›è°ƒé€»è¾‘æ–¹æ³•ã€‚å½“æ¶ˆè´¹è€…ç»„æˆå‘˜æˆåŠŸåŠ å…¥ç»„ä¹‹åï¼Œéœ€è¦æ‰§è¡Œè¯¥æ–¹æ³•ã€‚</li>\n</ul><p>è¯´å®Œäº†æ–¹æ³•ç­¾åï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„ä¸»ä½“ä»£ç ï¼š</p><pre><code>// éªŒè¯æ¶ˆè´¹è€…ç»„çŠ¶æ€çš„åˆæ³•æ€§\nvalidateGroupStatus(groupId, ApiKeys.JOIN_GROUP).foreach { error =&gt;\n  responseCallback(JoinGroupResult(memberId, error))\n  return\n}\n// ç¡®ä¿sessionTimeoutMsä»‹äº\n// [group.min.session.timeout.mså€¼ï¼Œgroup.max.session.timeout.mså€¼]ä¹‹é—´\n// å¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œè¡¨ç¤ºè¶…æ—¶æ—¶é—´è®¾ç½®æ— æ•ˆ\nif (sessionTimeoutMs &lt; groupConfig.groupMinSessionTimeoutMs ||\n  sessionTimeoutMs &gt; groupConfig.groupMaxSessionTimeoutMs) {\n  responseCallback(JoinGroupResult(memberId, Errors.INVALID_SESSION_TIMEOUT))\n} else {\n  // æ¶ˆè´¹è€…ç»„æˆå‘˜IDæ˜¯å¦ä¸ºç©º\n  val isUnknownMember = memberId == JoinGroupRequest.UNKNOWN_MEMBER_ID\n  // è·å–æ¶ˆè´¹è€…ç»„ä¿¡æ¯ï¼Œå¦‚æœç»„ä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆè´¹è€…ç»„\n  groupManager.getOrMaybeCreateGroup(groupId, isUnknownMember) match {\n    case None =&gt;\n      responseCallback(JoinGroupResult(memberId, Errors.UNKNOWN_MEMBER_ID))\n    case Some(group) =&gt;\n      group.inLock {\n        // å¦‚æœè¯¥æ¶ˆè´¹è€…ç»„å·²æ»¡å‘˜\n        if (!acceptJoiningMember(group, memberId)) {\n          // ç§»é™¤è¯¥æ¶ˆè´¹è€…ç»„æˆå‘˜\n          group.remove(memberId)\n          group.removeStaticMember(groupInstanceId)\n          // å°è£…å¼‚å¸¸è¡¨æ˜ç»„å·²æ»¡å‘˜\n          responseCallback(JoinGroupResult(\n            JoinGroupRequest.UNKNOWN_MEMBER_ID, \n            Errors.GROUP_MAX_SIZE_REACHED))\n        // å¦‚æœæ¶ˆè´¹è€…ç»„æˆå‘˜IDä¸ºç©º\n        } else if (isUnknownMember) {\n          // ä¸ºç©ºIDæˆå‘˜æ‰§è¡ŒåŠ å…¥ç»„æ“ä½œ\n          doUnknownJoinGroup(group, groupInstanceId, requireKnownMemberId, clientId, clientHost, rebalanceTimeoutMs, sessionTimeoutMs, protocolType, protocols, responseCallback)\n        } else {\n          // ä¸ºéç©ºIDæˆå‘˜æ‰§è¡ŒåŠ å…¥ç»„æ“ä½œ\n          doJoinGroup(group, memberId, groupInstanceId, clientId, clientHost, rebalanceTimeoutMs, sessionTimeoutMs, protocolType, protocols, responseCallback)\n        }\n        // å¦‚æœæ¶ˆè´¹è€…ç»„æ­£å¤„äºPreparingRebalanceçŠ¶æ€\n        if (group.is(PreparingRebalance)) {\n          // æ”¾å…¥Purgatoryï¼Œç­‰å¾…åé¢ç»Ÿä¸€å»¶æ—¶å¤„ç†\n          joinPurgatory.checkAndComplete(GroupKey(group.groupId))\n        }\n      }\n  }\n}\n</code></pre><p>ä¸ºäº†æ–¹ä¾¿ä½ æ›´ç›´è§‚åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾æ¥è¯´æ˜å®ƒçš„å®Œæ•´æµç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4b/89/4b4624d5cced2be6a77c7659e048b089.jpg?wh=3476*4352\" alt=\"\"></p><p>ç¬¬1æ­¥ï¼Œè°ƒç”¨validateGroupStatusæ–¹æ³•éªŒè¯æ¶ˆè´¹è€…ç»„çŠ¶æ€çš„åˆæ³•æ€§ã€‚æ‰€è°“çš„åˆæ³•æ€§ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹è€…ç»„ågroupIdä¸èƒ½ä¸ºç©ºï¼Œä»¥åŠJoinGroupRequestè¯·æ±‚å‘é€ç»™äº†æ­£ç¡®çš„Coordinatorï¼Œè¿™ä¸¤è€…å¿…é¡»åŒæ—¶æ»¡è¶³ã€‚å¦‚æœæ²¡æœ‰é€šè¿‡è¿™äº›æ£€æŸ¥ï¼Œé‚£ä¹ˆï¼ŒhandleJoinGroupæ–¹æ³•ä¼šå°è£…ç›¸åº”çš„é”™è¯¯ï¼Œå¹¶è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›ã€‚å¦åˆ™ï¼Œå°±è¿›å…¥åˆ°ä¸‹ä¸€æ­¥ã€‚</p><p>ç¬¬2æ­¥ï¼Œä»£ç æ£€éªŒsessionTimeoutMsçš„å€¼æ˜¯å¦ä»‹äº[group.min.session.timeout.msï¼Œgroup.max.session.timeout.ms]ä¹‹é—´ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±è®¤å®šè¯¥å€¼æ˜¯éæ³•å€¼ï¼Œä»è€Œå°è£…ä¸€ä¸ªå¯¹åº”çš„å¼‚å¸¸è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤ºæ¶ˆè´¹è€…ç»„å…è®¸é…ç½®çš„æœ€å°å’Œæœ€å¤§ä¼šè¯è¶…æ—¶æ—¶é—´ï¼›å¦‚æœæ˜¯çš„è¯ï¼Œå°±è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</p><p>ç¬¬3æ­¥ï¼Œä»£ç è·å–å½“å‰æˆå‘˜çš„IDä¿¡æ¯ï¼Œå¹¶æŸ¥çœ‹å®ƒæ˜¯å¦ä¸ºç©ºã€‚ä¹‹åï¼Œé€šè¿‡GroupMetadataManagerè·å–æ¶ˆè´¹è€…ç»„çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚æœè¯¥ç»„çš„å…ƒæ•°æ®ä¿¡æ¯å­˜åœ¨ï¼Œåˆ™è¿›å…¥åˆ°ä¸‹ä¸€æ­¥ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œä»£ç ä¼šçœ‹å½“å‰æˆå‘˜IDæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºçš„å…ƒæ•°æ®å¯¹è±¡ï¼Œç„¶åè¿›å…¥åˆ°ä¸‹ä¸€æ­¥ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è¿”å›Noneã€‚ä¸€æ—¦è¿”å›äº†Noneï¼ŒhandleJoinGroupæ–¹æ³•ä¼šå°è£…â€œæœªçŸ¥æˆå‘˜IDâ€çš„å¼‚å¸¸ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°è¿”å›ã€‚</p><p>ç¬¬4æ­¥ï¼Œæ£€æŸ¥å½“å‰æ¶ˆè´¹è€…ç»„æ˜¯å¦å·²æ»¡å‘˜ã€‚è¯¥é€»è¾‘æ˜¯é€šè¿‡<strong>acceptJoiningMemberæ–¹æ³•</strong>å®ç°çš„ã€‚è¿™ä¸ªæ–¹æ³•æ ¹æ®<strong>æ¶ˆè´¹è€…ç»„çŠ¶æ€</strong>ç¡®å®šæ˜¯å¦æ»¡å‘˜ã€‚è¿™é‡Œçš„æ¶ˆè´¹è€…ç»„çŠ¶æ€æœ‰ä¸‰ç§ã€‚</p><p><strong>çŠ¶æ€ä¸€</strong>ï¼šå¦‚æœæ˜¯Emptyæˆ–DeadçŠ¶æ€ï¼Œè‚¯å®šä¸ä¼šæ˜¯æ»¡å‘˜ï¼Œç›´æ¥è¿”å›Trueï¼Œè¡¨ç¤ºå¯ä»¥æ¥çº³ç”³è¯·å…¥ç»„çš„æˆå‘˜ï¼›</p><p><strong>çŠ¶æ€äºŒ</strong>ï¼šå¦‚æœæ˜¯PreparingRebalanceçŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œæ‰¹å‡†æˆå‘˜å…¥ç»„çš„æ¡ä»¶æ˜¯å¿…é¡»æ»¡è¶³ä¸€ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ã€‚</p><ul>\n<li>è¯¥æˆå‘˜æ˜¯ä¹‹å‰å·²æœ‰çš„æˆå‘˜ï¼Œä¸”å½“å‰æ­£åœ¨ç­‰å¾…åŠ å…¥ç»„ï¼›</li>\n<li>å½“å‰ç­‰å¾…åŠ å…¥ç»„çš„æˆå‘˜æ•°å°äºBrokerç«¯å‚æ•°group.max.sizeå€¼ã€‚</li>\n</ul><p>åªè¦æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œå½“å‰æ¶ˆè´¹è€…ç»„æˆå‘˜éƒ½ä¼šè¢«æ‰¹å‡†å…¥ç»„ã€‚</p><p><strong>çŠ¶æ€ä¸‰</strong>ï¼šå¦‚æœæ˜¯å…¶ä»–çŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œå…¥ç»„çš„æ¡ä»¶æ˜¯<strong>è¯¥æˆå‘˜æ˜¯å·²æœ‰æˆå‘˜ï¼Œæˆ–è€…æ˜¯å½“å‰ç»„æ€»æˆå‘˜æ•°å°äºBrokerç«¯å‚æ•°group.max.sizeå€¼</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ¯”è¾ƒçš„æ˜¯<strong>ç»„å½“å‰çš„æ€»æˆå‘˜æ•°</strong>ï¼Œè€Œä¸æ˜¯ç­‰å¾…å…¥ç»„çš„æˆå‘˜æ•°ï¼Œè¿™æ˜¯å› ä¸ºï¼Œä¸€æ—¦Rebalanceè¿‡æ¸¡åˆ°CompletingRebalanceä¹‹åï¼Œæ²¡æœ‰å®ŒæˆåŠ å…¥ç»„çš„æˆå‘˜ï¼Œå°±ä¼šè¢«ç§»é™¤ã€‚</p><p>å€˜è‹¥æˆå‘˜ä¸è¢«æ‰¹å‡†å…¥ç»„ï¼Œé‚£ä¹ˆï¼Œä»£ç éœ€è¦å°†è¯¥æˆå‘˜ä»å…ƒæ•°æ®ç¼“å­˜ä¸­ç§»é™¤ï¼ŒåŒæ—¶å°è£…â€œç»„å·²æ»¡å‘˜â€çš„å¼‚å¸¸ï¼Œå¹¶è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›ï¼›å¦‚æœæˆå‘˜è¢«æ‰¹å‡†å…¥ç»„ï¼Œåˆ™æ ¹æ®Member IDæ˜¯å¦ä¸ºç©ºï¼Œå°±æ‰§è¡ŒdoUnknownJoinGroupæˆ–doJoinGroupæ–¹æ³•æ‰§è¡ŒåŠ å…¥ç»„çš„é€»è¾‘ã€‚</p><p>ç¬¬5æ­¥æ˜¯å°è¯•å®ŒæˆJoinGroupRequestè¯·æ±‚çš„å¤„ç†ã€‚å¦‚æœæ¶ˆè´¹è€…ç»„å¤„äºPreparingRebalanceçŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œå°±å°†è¯¥è¯·æ±‚æ”¾å…¥Purgatoryï¼Œå°è¯•ç«‹å³å®Œæˆï¼›å¦‚æœæ˜¯å…¶å®ƒçŠ¶æ€ï¼Œåˆ™æ— éœ€å°†è¯·æ±‚æ”¾å…¥Purgatoryã€‚æ¯•ç«Ÿï¼Œæˆ‘ä»¬å¤„ç†çš„æ˜¯åŠ å…¥ç»„çš„é€»è¾‘ï¼Œè€Œæ­¤æ—¶æ¶ˆè´¹è€…ç»„çš„çŠ¶æ€åº”è¯¥è¦å˜æ›´åˆ°PreparingRebalanceåï¼ŒRebalanceæ‰èƒ½å®ŒæˆåŠ å…¥ç»„æ“ä½œã€‚å½“ç„¶ï¼Œå¦‚æœå»¶æ—¶è¯·æ±‚ä¸èƒ½ç«‹å³å®Œæˆï¼Œåˆ™äº¤ç”±Purgatoryç»Ÿä¸€è¿›è¡Œå»¶æ—¶å¤„ç†ã€‚</p><p>è‡³æ­¤ï¼ŒhandleJoinGroupé€»è¾‘ç»“æŸã€‚</p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒçœŸæ­£æ‰§è¡ŒåŠ å…¥ç»„é€»è¾‘çš„æ˜¯doUnknownJoinGroupå’ŒdoJoinGroupè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><h2>doUnknownJoinGroupæ–¹æ³•</h2><p>å¦‚æœæ˜¯å…¨æ–°çš„æ¶ˆè´¹è€…ç»„æˆå‘˜åŠ å…¥ç»„ï¼Œé‚£ä¹ˆï¼Œå°±éœ€è¦ä¸ºå®ƒä»¬æ‰§è¡ŒdoUnknownJoinGroupæ–¹æ³•ï¼Œå› ä¸ºæ­¤æ—¶ï¼Œå®ƒä»¬çš„Member IDå°šæœªç”Ÿæˆã€‚</p><p>é™¤äº†memberIdä¹‹å¤–ï¼Œè¯¥æ–¹æ³•çš„è¾“å…¥å‚æ•°ä¸handleJoinGroupæ–¹æ³•å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œæˆ‘å°±ä¸ä¸€ä¸€åœ°è¯¦ç»†ä»‹ç»äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹å®ƒçš„æºç ã€‚ä¸ºäº†ä¾¿äºä½ ç†è§£ï¼Œæˆ‘çœç•¥äº†å…³äºé™æ€æˆå‘˜ä»¥åŠDEBUG/INFOè°ƒè¯•çš„éƒ¨åˆ†ä»£ç ã€‚</p><pre><code>group.inLock {\n  // DeadçŠ¶æ€\n  if (group.is(Dead)) {\n    // å°è£…å¼‚å¸¸è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›\n    responseCallback(JoinGroupResult(\n      JoinGroupRequest.UNKNOWN_MEMBER_ID,         \n      Errors.COORDINATOR_NOT_AVAILABLE))\n  // æˆå‘˜é…ç½®çš„åè®®ç±»å‹/åˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥ä¸æ¶ˆè´¹è€…ç»„çš„ä¸åŒ¹é…\n  } else if (!group.supportsProtocols(protocolType, MemberMetadata.plainProtocolSet(protocols))) {\n  responseCallback(JoinGroupResult(JoinGroupRequest.UNKNOWN_MEMBER_ID, Errors.INCONSISTENT_GROUP_PROTOCOL))\n  } else {\n    // æ ¹æ®è§„åˆ™ä¸ºè¯¥æˆå‘˜åˆ›å»ºæˆå‘˜ID\n    val newMemberId = group.generateMemberId(clientId, groupInstanceId)\n    // å¦‚æœé…ç½®äº†é™æ€æˆå‘˜\n    if (group.hasStaticMember(groupInstanceId)) {\n      ......\n    // å¦‚æœè¦æ±‚æˆå‘˜IDä¸ä¸ºç©º\n    } else if (requireKnownMemberId) {\n      ......\n      group.addPendingMember(newMemberId)\n      addPendingMemberExpiration(group, newMemberId, sessionTimeoutMs)\n      responseCallback(JoinGroupResult(newMemberId, Errors.MEMBER_ID_REQUIRED))\n    } else {\n      ......\n      // æ·»åŠ æˆå‘˜\n      addMemberAndRebalance(rebalanceTimeoutMs, sessionTimeoutMs, newMemberId, groupInstanceId,\n        clientId, clientHost, protocolType, protocols, group, responseCallback)\n    }\n  }\n}\n\n</code></pre><p>ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾æ¥å±•ç¤ºä¸‹è¿™ä¸ªæ–¹æ³•çš„æµç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/49/95/497aef4be2afa50f34ddc99a6788b695.jpg?wh=1716*2752\" alt=\"\"></p><p>é¦–å…ˆï¼Œä»£ç ä¼šæ£€æŸ¥æ¶ˆè´¹è€…ç»„çš„çŠ¶æ€ã€‚</p><p>å¦‚æœæ˜¯DeadçŠ¶æ€ï¼Œåˆ™å°è£…å¼‚å¸¸ï¼Œç„¶åè°ƒç”¨å›è°ƒå‡½æ•°è¿”å›ã€‚ä½ å¯èƒ½ä¼šè§‰å¾—å¥‡æ€ªï¼Œæ—¢ç„¶æ˜¯å‘è¯¥ç»„æ·»åŠ æˆå‘˜ï¼Œä¸ºä»€ä¹ˆç»„çŠ¶æ€è¿˜èƒ½æ˜¯Deadå‘¢ï¼Ÿå®é™…ä¸Šï¼Œè¿™ç§æƒ…å†µæ˜¯å¯èƒ½çš„ã€‚å› ä¸ºï¼Œåœ¨æˆå‘˜åŠ å…¥ç»„çš„åŒæ—¶ï¼Œå¯èƒ½å­˜åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå·²ç»æŠŠç»„çš„å…ƒæ•°æ®ä¿¡æ¯ä»Coordinatorä¸­ç§»é™¤äº†ã€‚æ¯”å¦‚ï¼Œç»„å¯¹åº”çš„Coordinatorå‘ç”Ÿäº†å˜æ›´ï¼Œç§»åŠ¨åˆ°äº†å…¶ä»–çš„Brokerä¸Šï¼Œæ­¤æ—¶ï¼Œä»£ç å°è£…ä¸€ä¸ªå¼‚å¸¸è¿”å›ç»™æ¶ˆè´¹è€…ç¨‹åºï¼Œåè€…ä¼šå»å¯»æ‰¾æœ€æ–°çš„Coordinatorï¼Œç„¶åé‡æ–°å‘èµ·åŠ å…¥ç»„æ“ä½œã€‚</p><p>å¦‚æœçŠ¶æ€ä¸æ˜¯Deadï¼Œå°±æ£€æŸ¥è¯¥æˆå‘˜çš„åè®®ç±»å‹ä»¥åŠåˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥ï¼Œæ˜¯å¦ä¸æ¶ˆè´¹è€…ç»„å½“å‰æ”¯æŒçš„æ–¹æ¡ˆåŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œä¾ç„¶æ˜¯å°è£…å¼‚å¸¸ï¼Œç„¶åè°ƒç”¨å›è°ƒå‡½æ•°è¿”å›ã€‚è¿™é‡Œçš„åŒ¹é…ä¸å¦ï¼Œæ˜¯æŒ‡æˆå‘˜çš„åè®®ç±»å‹ä¸æ¶ˆè´¹è€…ç»„çš„æ˜¯å¦ä¸€è‡´ï¼Œä»¥åŠæˆå‘˜è®¾å®šçš„åˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥æ˜¯å¦è¢«æ¶ˆè´¹è€…ç»„ä¸‹çš„å…¶å®ƒæˆå‘˜æ”¯æŒã€‚</p><p>å¦‚æœè¿™äº›æ£€æŸ¥éƒ½é¡ºåˆ©é€šè¿‡ï¼Œæ¥ç€ï¼Œä»£ç å°±ä¼šä¸ºè¯¥æˆå‘˜ç”Ÿæˆæˆå‘˜IDï¼Œç”Ÿæˆè§„åˆ™æ˜¯clientId-UUIDã€‚è¿™ä¾¿æ˜¯generateMemberIdæ–¹æ³•åšçš„äº‹æƒ…ã€‚ç„¶åï¼ŒhandleJoinGroupæ–¹æ³•ä¼šæ ¹æ®requireKnownMemberIdçš„å–å€¼ï¼Œæ¥å†³å®šä¸‹é¢çš„é€»è¾‘è·¯å¾„ï¼š</p><ul>\n<li>å¦‚æœè¯¥å€¼ä¸ºTrueï¼Œåˆ™å°†è¯¥æˆå‘˜åŠ å…¥åˆ°å¾…å†³æˆå‘˜åˆ—è¡¨ï¼ˆPending Member Listï¼‰ä¸­ï¼Œç„¶åå°è£…ä¸€ä¸ªå¼‚å¸¸ä»¥åŠç”Ÿæˆå¥½çš„æˆå‘˜IDï¼Œå°†è¯¥æˆå‘˜çš„å…¥ç»„ç”³è¯·â€œæ‰“å›å»â€ï¼Œä»¤å…¶åˆ†é…å¥½äº†æˆå‘˜IDä¹‹åå†é‡æ–°ç”³è¯·ï¼›</li>\n<li>å¦‚æœä¸ºFalseï¼Œåˆ™æ— éœ€è¿™ä¹ˆè‹›åˆ»ï¼Œç›´æ¥è°ƒç”¨addMemberAndRebalanceæ–¹æ³•å°†å…¶åŠ å…¥åˆ°ç»„ä¸­ã€‚è‡³æ­¤ï¼ŒhandleJoinGroupæ–¹æ³•ç»“æŸã€‚</li>\n</ul><p>é€šå¸¸æ¥è¯´ï¼Œå¦‚æœä½ æ²¡æœ‰å¯ç”¨é™æ€æˆå‘˜æœºåˆ¶çš„è¯ï¼ŒrequireKnownMemberIdçš„å€¼æ˜¯Trueï¼Œè¿™æ˜¯ç”±KafkaApisä¸­handleJoinGroupRequestæ–¹æ³•çš„è¿™è¡Œè¯­å¥å†³å®šçš„ï¼š</p><pre><code>val requireKnownMemberId = joinGroupRequest.version &gt;= 4 &amp;&amp; groupInstanceId.isEmpty\n</code></pre><p>å¯è§ï¼Œ å¦‚æœä½ ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒæ–°çš„Kafkaå®¢æˆ·ç«¯ç‰ˆæœ¬ï¼Œè€Œä¸”æ²¡æœ‰é…ç½®è¿‡Consumerç«¯å‚æ•°group.instance.idçš„è¯ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªå­—æ®µçš„å€¼å°±æ˜¯Trueï¼Œè¿™è¯´æ˜ï¼ŒKafkaè¦æ±‚æ¶ˆè´¹è€…æˆå‘˜åŠ å…¥ç»„æ—¶ï¼Œå¿…é¡»è¦åˆ†é…å¥½æˆå‘˜IDã€‚</p><p>å…³äºaddMemberAndRebalanceæ–¹æ³•çš„æºç ï¼Œä¸€ä¼šå„¿åœ¨å­¦ä¹ doJoinGroupæ–¹æ³•æ—¶ï¼Œæˆ‘å†ç»™ä½ å…·ä½“è§£é‡Šã€‚</p><h2>doJoinGroupæ–¹æ³•</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹doJoinGroupæ–¹æ³•ã€‚è¿™æ˜¯ä¸ºé‚£äº›è®¾ç½®äº†æˆå‘˜IDçš„æˆå‘˜ï¼Œæ‰§è¡ŒåŠ å…¥ç»„é€»è¾‘çš„æ–¹æ³•ã€‚å®ƒçš„è¾“å…¥å‚æ•°å…¨éƒ¨æ‰¿è¢­è‡ªhandleJoinGroupæ–¹æ³•è¾“å…¥å‚æ•°ï¼Œä½ åº”è¯¥å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹å®ƒçš„æºç å®ç°ã€‚ç”±äºä»£ç æ¯”è¾ƒé•¿ï¼Œæˆ‘åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†æ¥ä»‹ç»ã€‚åŒæ—¶ï¼Œæˆ‘å†ç”»ä¸€å¼ å›¾ï¼Œå¸®åŠ©ä½ ç†è§£æ•´ä¸ªæ–¹æ³•çš„é€»è¾‘ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/46/4f/4658881317dc5d8afdeb3bac07cfae4f.jpg?wh=3164*3432\" alt=\"\"></p><h3>ç¬¬1éƒ¨åˆ†</h3><p>è¿™éƒ¨åˆ†ä¸»è¦åšä¸€äº›æ ¡éªŒå’Œæ¡ä»¶æ£€æŸ¥ã€‚</p><pre><code>// å¦‚æœæ˜¯DeadçŠ¶æ€ï¼Œå°è£…COORDINATOR_NOT_AVAILABLEå¼‚å¸¸è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›\nif (group.is(Dead)) {\n  responseCallback(JoinGroupResult(memberId, Errors.COORDINATOR_NOT_AVAILABLE))\n// å¦‚æœåè®®ç±»å‹æˆ–åˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥ä¸æ¶ˆè´¹è€…ç»„çš„ä¸åŒ¹é…\n// å°è£…INCONSISTENT_GROUP_PROTOCOLå¼‚å¸¸è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›\n} else if (!group.supportsProtocols(protocolType, MemberMetadata.plainProtocolSet(protocols))) {\n  responseCallback(JoinGroupResult(memberId, Errors.INCONSISTENT_GROUP_PROTOCOL))\n// å¦‚æœæ˜¯å¾…å†³æˆå‘˜ï¼Œç”±äºè¿™æ¬¡åˆ†é…äº†æˆå‘˜IDï¼Œæ•…å…è®¸åŠ å…¥ç»„\n} else if (group.isPendingMember(memberId)) {\n  if (groupInstanceId.isDefined) {\n    ......\n  } else {\n    ......\n    // ä»¤å…¶åŠ å…¥ç»„\n    addMemberAndRebalance(rebalanceTimeoutMs, sessionTimeoutMs, memberId, groupInstanceId,\n      clientId, clientHost, protocolType, protocols, group, responseCallback)\n  }\n} else {\n  // ç¬¬äºŒéƒ¨åˆ†ä»£ç ......\n}\n</code></pre><p>doJoinGroupæ–¹æ³•å¼€å¤´å’ŒdoUnkwownJoinGroupéå¸¸ç±»ä¼¼ï¼Œä¹Ÿæ˜¯åˆ¤æ–­æ˜¯å¦å¤„äºDeadçŠ¶æ€ï¼Œå¹¶ä¸”æ£€æŸ¥åè®®ç±»å‹å’Œåˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥æ˜¯å¦ä¸æ¶ˆè´¹è€…ç»„çš„ç›¸åŒ¹é…ã€‚</p><p>ä¸åŒçš„æ˜¯ï¼ŒdoJoinGroupè¦åˆ¤æ–­å½“å‰ç”³è¯·å…¥ç»„çš„æˆå‘˜æ˜¯å¦æ˜¯å¾…å†³æˆå‘˜ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆï¼Œè¿™æ¬¡æˆå‘˜å·²ç»åˆ†é…å¥½äº†æˆå‘˜IDï¼Œå› æ­¤ï¼Œå°±ç›´æ¥è°ƒç”¨addMemberAndRebalanceæ–¹æ³•ä»¤å…¶å…¥ç»„ï¼›å¦‚æœä¸æ˜¯çš„è¯ï¼Œé‚£ä¹ˆï¼Œæ–¹æ³•è¿›å…¥åˆ°ç¬¬2éƒ¨åˆ†ï¼Œå³å¤„ç†ä¸€ä¸ªéå¾…å†³æˆå‘˜çš„å…¥ç»„ç”³è¯·ã€‚</p><h3>ç¬¬2éƒ¨åˆ†</h3><p>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>// è·å–è¯¥æˆå‘˜çš„å…ƒæ•°æ®ä¿¡æ¯\nval member = group.get(memberId)\ngroup.currentState match {\n  // å¦‚æœæ˜¯PreparingRebalanceçŠ¶æ€\n  case PreparingRebalance =&gt;\n    // æ›´æ–°æˆå‘˜ä¿¡æ¯å¹¶å¼€å§‹å‡†å¤‡Rebalance\n    updateMemberAndRebalance(group, member, protocols, responseCallback)\n  // å¦‚æœæ˜¯CompletingRebalanceçŠ¶æ€\n  case CompletingRebalance =&gt;\n    // å¦‚æœæˆå‘˜ä»¥å‰ç”³è¯·è¿‡åŠ å…¥ç»„\n    if (member.matches(protocols)) {\n      // ç›´æ¥è¿”å›å½“å‰ç»„ä¿¡æ¯\n      responseCallback(JoinGroupResult(\n        members = if (group.isLeader(memberId)) {\n          group.currentMemberMetadata\n        } else {\n          List.empty\n        },\n        memberId = memberId,\n        generationId = group.generationId,\n        protocolType = group.protocolType,\n        protocolName = group.protocolName,\n        leaderId = group.leaderOrNull,\n        error = Errors.NONE))\n    // å¦åˆ™ï¼Œæ›´æ–°æˆå‘˜ä¿¡æ¯å¹¶å¼€å§‹å‡†å¤‡Rebalance\n    } else {\n      updateMemberAndRebalance(group, member, protocols, responseCallback)\n    }\n  // å¦‚æœæ˜¯StableçŠ¶æ€\n  case Stable =&gt;\n    val member = group.get(memberId)\n    // å¦‚æœæˆå‘˜æ˜¯Leaderæˆå‘˜ï¼Œæˆ–è€…æˆå‘˜å˜æ›´äº†åˆ†åŒºåˆ†é…ç­–ç•¥\n    if (group.isLeader(memberId) || !member.matches(protocols)) {\n      // æ›´æ–°æˆå‘˜ä¿¡æ¯å¹¶å¼€å§‹å‡†å¤‡Rebalance\n      updateMemberAndRebalance(group, member, protocols, responseCallback)\n    } else {\n      responseCallback(JoinGroupResult(\n        members = List.empty,\n        memberId = memberId,\n        generationId = group.generationId,\n        protocolType = group.protocolType,\n        protocolName = group.protocolName,\n        leaderId = group.leaderOrNull,\n        error = Errors.NONE))\n    }\n  // å¦‚æœæ˜¯å…¶å®ƒçŠ¶æ€ï¼Œå°è£…å¼‚å¸¸è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›\n  case Empty | Dead =&gt;\n    warn(s&quot;Attempt to add rejoining member $memberId of group ${group.groupId} in &quot; +\n      s&quot;unexpected group state ${group.currentState}&quot;)\n    responseCallback(JoinGroupResult(memberId, Errors.UNKNOWN_MEMBER_ID))\n}\n</code></pre><p>è¿™éƒ¨åˆ†ä»£ç çš„<strong>ç¬¬1æ­¥</strong>ï¼Œæ˜¯è·å–è¦åŠ å…¥ç»„æˆå‘˜çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚</p><p><strong>ç¬¬2æ­¥</strong>ï¼Œæ˜¯æŸ¥è¯¢æ¶ˆè´¹è€…ç»„çš„å½“å‰çŠ¶æ€ã€‚è¿™é‡Œæœ‰4ç§æƒ…å†µã€‚</p><ol>\n<li>\n<p>å¦‚æœæ˜¯PreparingRebalanceçŠ¶æ€ï¼Œå°±è¯´æ˜æ¶ˆè´¹è€…ç»„æ­£è¦å¼€å¯Rebalanceæµç¨‹ï¼Œé‚£ä¹ˆï¼Œè°ƒç”¨updateMemberAndRebalanceæ–¹æ³•æ›´æ–°æˆå‘˜ä¿¡æ¯ï¼Œå¹¶å¼€å§‹å‡†å¤‡Rebalanceå³å¯ã€‚</p>\n</li>\n<li>\n<p>å¦‚æœæ˜¯CompletingRebalanceçŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œå°±åˆ¤æ–­ä¸€ä¸‹ï¼Œè¯¥æˆå‘˜çš„åˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥ä¸è®¢é˜…åˆ†åŒºåˆ—è¡¨æ˜¯å¦å’Œå·²ä¿å­˜è®°å½•ä¸­çš„ä¸€è‡´ï¼Œå¦‚æœç›¸åŒï¼Œå°±è¯´æ˜è¯¥æˆå‘˜å·²ç»åº”è¯¥å‘èµ·è¿‡åŠ å…¥ç»„çš„æ“ä½œï¼Œå¹¶ä¸”Coordinatorå·²ç»æ‰¹å‡†äº†ï¼Œåªæ˜¯è¯¥æˆå‘˜æ²¡æœ‰æ”¶åˆ°ï¼Œå› æ­¤ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œä»£ç æ„é€ ä¸€ä¸ªJoinGroupResultå¯¹è±¡ï¼Œç›´æ¥è¿”å›å½“å‰çš„ç»„ä¿¡æ¯ç»™æˆå‘˜ã€‚ä½†æ˜¯ï¼Œå¦‚æœprotocolsä¸ç›¸åŒï¼Œé‚£ä¹ˆï¼Œå°±è¯´æ˜æˆå‘˜å˜æ›´äº†è®¢é˜…ä¿¡æ¯æˆ–åˆ†é…ç­–ç•¥ï¼Œå°±è¦è°ƒç”¨updateMemberAndRebalanceæ–¹æ³•ï¼Œæ›´æ–°æˆå‘˜ä¿¡æ¯ï¼Œå¹¶å¼€å§‹å‡†å¤‡æ–°ä¸€è½®Rebalanceã€‚</p>\n</li>\n<li>\n<p>å¦‚æœæ˜¯StableçŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œå°±åˆ¤æ–­è¯¥æˆå‘˜æ˜¯å¦æ˜¯Leaderæˆå‘˜ï¼Œæˆ–è€…æ˜¯å®ƒçš„è®¢é˜…ä¿¡æ¯æˆ–åˆ†é…ç­–ç•¥å‘ç”Ÿäº†å˜æ›´ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œå°±è°ƒç”¨updateMemberAndRebalanceæ–¹æ³•å¼ºè¿«ä¸€æ¬¡æ–°çš„Rebalanceã€‚å¦åˆ™çš„è¯ï¼Œè¿”å›å½“å‰ç»„ä¿¡æ¯ç»™è¯¥æˆå‘˜å³å¯ï¼Œé€šçŸ¥å®ƒä»¬å¯ä»¥å‘èµ·Rebalanceçš„ä¸‹ä¸€æ­¥æ“ä½œã€‚</p>\n</li>\n<li>\n<p>å¦‚æœè¿™äº›çŠ¶æ€éƒ½ä¸æ˜¯ï¼Œè€Œæ˜¯Emptyæˆ–DeadçŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œå°±å°è£…UNKNOWN_MEMBER_IDå¼‚å¸¸ï¼Œå¹¶è°ƒç”¨å›è°ƒå‡½æ•°è¿”å›ã€‚</p>\n</li>\n</ol><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™éƒ¨åˆ†ä»£ç é¢‘ç¹åœ°è°ƒç”¨updateMemberAndRebalanceæ–¹æ³•ã€‚å¦‚æœä½ ç¿»å¼€å®ƒçš„ä»£ç ï¼Œä¼šå‘ç°ï¼Œå®ƒä»…ä»…åšä¸¤ä»¶äº‹æƒ…ã€‚</p><ul>\n<li>æ›´æ–°ç»„æˆå‘˜ä¿¡æ¯ï¼›è°ƒç”¨GroupMetadataçš„updateMemberæ–¹æ³•æ¥æ›´æ–°æ¶ˆè´¹è€…ç»„æˆå‘˜ï¼›</li>\n<li>å‡†å¤‡Rebalanceï¼šè¿™ä¸€æ­¥çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ˜¯å°†æ¶ˆè´¹è€…ç»„çŠ¶æ€å˜æ›´åˆ°PreparingRebalanceï¼Œç„¶ååˆ›å»ºDelayedJoinå¯¹è±¡ï¼Œå¹¶äº¤ç”±Purgatoryï¼Œç­‰å¾…å»¶æ—¶å¤„ç†åŠ å…¥ç»„æ“ä½œã€‚</li>\n</ul><p>è¿™ä¸ªæ–¹æ³•çš„ä»£ç è¡Œæ•°ä¸å¤šï¼Œè€Œä¸”é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å˜æ›´æ¶ˆè´¹è€…ç»„çŠ¶æ€ï¼Œä»¥åŠå¤„ç†å»¶æ—¶è¯·æ±‚å¹¶æ”¾å…¥Purgatoryï¼Œå› æ­¤ï¼Œæˆ‘ä¸å±•å¼€è¯´äº†ï¼Œä½ å¯ä»¥è‡ªè¡Œé˜…è¯»ä¸‹è¿™éƒ¨åˆ†ä»£ç ã€‚</p><h2>addMemberAndRebalanceæ–¹æ³•</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬å­¦ä¹ ä¸‹doUnknownJoinGroupå’ŒdoJoinGroupæ–¹æ³•éƒ½ä¼šç”¨åˆ°çš„addMemberAndRebalanceæ–¹æ³•ã€‚ä»åå­—ä¸Šæ¥çœ‹ï¼Œå®ƒçš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p><ul>\n<li>å‘æ¶ˆè´¹è€…ç»„æ·»åŠ æˆå‘˜ï¼›</li>\n<li>å‡†å¤‡Rebalanceã€‚</li>\n</ul><pre><code>private def addMemberAndRebalance(\n  rebalanceTimeoutMs: Int,\n  sessionTimeoutMs: Int,\n  memberId: String,\n  groupInstanceId: Option[String],\n  clientId: String,\n  clientHost: String,\n  protocolType: String,\n  protocols: List[(String, Array[Byte])],\n  group: GroupMetadata,\n  callback: JoinCallback): Unit = {\n  // åˆ›å»ºMemberMetadataå¯¹è±¡å®ä¾‹\n  val member = new MemberMetadata(\n    memberId, group.groupId, groupInstanceId,\n    clientId, clientHost, rebalanceTimeoutMs,\n    sessionTimeoutMs, protocolType, protocols)\n  // æ ‡è¯†è¯¥æˆå‘˜æ˜¯æ–°æˆå‘˜\n  member.isNew = true\n  // å¦‚æœæ¶ˆè´¹è€…ç»„å‡†å¤‡å¼€å¯é¦–æ¬¡Rebalanceï¼Œè®¾ç½®newMemberAddedä¸ºTrue\n  if (group.is(PreparingRebalance) &amp;&amp; group.generationId == 0)\n    group.newMemberAdded = true\n  // å°†è¯¥æˆå‘˜æ·»åŠ åˆ°æ¶ˆè´¹è€…ç»„\n  group.add(member, callback)\n  // è®¾ç½®ä¸‹æ¬¡å¿ƒè·³è¶…æœŸæ—¶é—´\n  completeAndScheduleNextExpiration(group, member, NewMemberJoinTimeoutMs)\n  if (member.isStaticMember) {\n    info(s&quot;Adding new static member $groupInstanceId to group ${group.groupId} with member id $memberId.&quot;)\n    group.addStaticMember(groupInstanceId, memberId)\n  } else {\n    // ä»å¾…å†³æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤\n    group.removePendingMember(memberId)\n  }\n  // å‡†å¤‡å¼€å¯Rebalance\n  maybePrepareRebalance(group, s&quot;Adding new member $memberId with group instance id $groupInstanceId&quot;)\n}\n</code></pre><p>è¿™ä¸ªæ–¹æ³•çš„å‚æ•°åˆ—è¡¨è™½ç„¶å¾ˆé•¿ï¼Œä½†æˆ‘ç›¸ä¿¡ï¼Œä½ å¯¹å®ƒä»¬å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå®ƒä»¬éƒ½æ˜¯æ‰¿è¢­è‡ªå…¶ä¸Šå±‚è°ƒç”¨æ–¹æ³•çš„å‚æ•°ã€‚</p><p>æˆ‘æ¥ä»‹ç»ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ã€‚</p><p><strong>ç¬¬1æ­¥</strong>ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥å‚æ•°åˆ›å»ºä¸€ä¸ªMemberMetadataå¯¹è±¡å®ä¾‹ï¼Œå¹¶è®¾ç½®isNewå­—æ®µä¸ºTrueï¼Œæ ‡è¯†å…¶æ˜¯ä¸€ä¸ªæ–°æˆå‘˜ã€‚isNewå­—æ®µä¸å¿ƒè·³è®¾ç½®ç›¸å…³è”ï¼Œä½ å¯ä»¥é˜…è¯»ä¸‹MemberMetadataçš„hasSatisfiedHeartbeatæ–¹æ³•çš„ä»£ç ï¼Œææ˜ç™½è¯¥å­—æ®µæ˜¯å¦‚ä½•å¸®åŠ©Coordinatorç¡®è®¤æ¶ˆè´¹è€…ç»„æˆå‘˜å¿ƒè·³çš„ã€‚</p><p><strong>ç¬¬2æ­¥</strong>ï¼Œä»£ç ä¼šåˆ¤æ–­æ¶ˆè´¹è€…ç»„æ˜¯å¦æ˜¯é¦–æ¬¡å¼€å¯Rebalanceã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå°±æŠŠnewMemberAddedå­—æ®µè®¾ç½®ä¸ºTrueï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™æ— éœ€æ‰§è¡Œè¿™ä¸ªèµ‹å€¼æ“ä½œã€‚è¿™ä¸ªå­—æ®µçš„ä½œç”¨ï¼Œæ˜¯Kafkaä¸ºæ¶ˆè´¹è€…ç»„Rebalanceæµç¨‹åšçš„ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–ã€‚å¤§è‡´çš„æ€æƒ³ï¼Œæ˜¯åœ¨æ¶ˆè´¹è€…ç»„é¦–æ¬¡è¿›è¡ŒRebalanceæ—¶ï¼Œè®©Coordinatorå¤šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œä»è€Œè®©æ›´å¤šçš„æ¶ˆè´¹è€…ç»„æˆå‘˜åŠ å…¥åˆ°ç»„ä¸­ï¼Œä»¥å…åæ¥è€…ç”³è¯·å…¥ç»„è€Œåå¤è¿›è¡ŒRebalanceã€‚è¿™æ®µå¤šç­‰å¾…çš„æ—¶é—´ï¼Œå°±æ˜¯Brokerç«¯å‚æ•°<strong>group.initial.rebalance.delay.msçš„å€¼</strong>ã€‚è¿™é‡Œçš„newMemberAddedå­—æ®µï¼Œå°±æ˜¯ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å¤šç­‰å¾…è¿™æ®µæ—¶é—´çš„ä¸€ä¸ªå˜é‡ã€‚</p><p>æˆ‘ä»¬æ¥ç€è¯´å›addMemberAndRebalanceæ–¹æ³•ã€‚è¯¥æ–¹æ³•çš„<strong>ç¬¬3æ­¥</strong>æ˜¯è°ƒç”¨GroupMetadataçš„addæ–¹æ³•ï¼Œå°†æ–°æˆå‘˜ä¿¡æ¯åŠ å…¥åˆ°æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®ä¸­ï¼ŒåŒæ—¶è®¾ç½®è¯¥æˆå‘˜çš„ä¸‹æ¬¡å¿ƒè·³è¶…æœŸæ—¶é—´ã€‚</p><p><strong>ç¬¬4æ­¥</strong>ï¼Œä»£ç å°†è¯¥æˆå‘˜ä»å¾…å†³æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤ã€‚æ¯•ç«Ÿï¼Œå®ƒå·²ç»æ­£å¼åŠ å…¥åˆ°ç»„ä¸­äº†ï¼Œå°±ä¸éœ€è¦å¾…åœ¨å¾…å†³åˆ—è¡¨ä¸­äº†ã€‚</p><p><strong>ç¬¬5æ­¥</strong>ï¼Œè°ƒç”¨maybePrepareRebalanceæ–¹æ³•ï¼Œå‡†å¤‡å¼€å¯Rebalanceã€‚</p><h2>æ€»ç»“</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å­¦å®Œäº†Rebalanceæµç¨‹çš„ç¬¬ä¸€å¤§æ­¥ï¼Œä¹Ÿå°±æ˜¯åŠ å…¥ç»„çš„æºç å­¦ä¹ ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œä½ è¦æ ¼å¤–æ³¨æ„ï¼Œ<strong>åŠ å…¥ç»„æ—¶æ˜¯åŒºåˆ†æœ‰æ— æ¶ˆè´¹è€…ç»„æˆå‘˜ID</strong>ã€‚å¯¹äºæœªè®¾å®šæˆå‘˜IDçš„åˆ†æ”¯ï¼Œä»£ç è°ƒç”¨doUnkwonwJoinGroupä¸ºæˆå‘˜ç”ŸæˆIDä¿¡æ¯ï¼›å¯¹äºå·²è®¾å®šæˆå‘˜IDçš„åˆ†æ”¯ï¼Œåˆ™è°ƒç”¨doJoinGroupæ–¹æ³•ã€‚è€Œè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œåº•å±‚éƒ½æ˜¯è°ƒç”¨addMemberAndRebalanceæ–¹æ³•ï¼Œå®ç°å°†æ¶ˆè´¹è€…ç»„æˆå‘˜æ·»åŠ è¿›ç»„çš„é€»è¾‘ã€‚</p><p>æˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚</p><ul>\n<li>Rebalanceæµç¨‹ï¼šåŒ…æ‹¬JoinGroupå’ŒSyncGroupä¸¤å¤§æ­¥ã€‚</li>\n<li>handleJoinGroupæ–¹æ³•ï¼šCoordinatorç«¯å¤„ç†æˆå‘˜åŠ å…¥ç»„ç”³è¯·çš„æ–¹æ³•ã€‚</li>\n<li>Member Idï¼šæˆå‘˜IDã€‚Kafkaæºç æ ¹æ®æˆå‘˜IDçš„æœ‰æ— ï¼Œå†³å®šè°ƒç”¨å“ªç§åŠ å…¥ç»„é€»è¾‘æ–¹æ³•ï¼Œæ¯”å¦‚doUnknownJoinGroupæˆ–doJoinGroupæ–¹æ³•ã€‚</li>\n<li>addMemberAndRebalanceæ–¹æ³•ï¼šå®ç°åŠ å…¥ç»„åŠŸèƒ½çš„å®é™…æ–¹æ³•ï¼Œç”¨äºå®Œæˆâ€œåŠ å…¥ç»„+å¼€å¯Rebalanceâ€è¿™ä¸¤ä¸ªæ“ä½œã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/41/01/41212f50defaffd79b04f851a278eb01.jpg?wh=2250*1323\" alt=\"\"></p><p>å½“æ‰€æœ‰æˆå‘˜éƒ½æˆåŠŸåŠ å…¥åˆ°ç»„ä¹‹åï¼Œæ‰€æœ‰æˆå‘˜ä¼šå¼€å¯Rebalanceçš„ç¬¬äºŒå¤§æ­¥ï¼šç»„åŒæ­¥ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆå‘˜ä¼šå‘é€SyncGroupRequestè¯·æ±‚ç»™Coordinatorã€‚é‚£ä¹ˆï¼ŒCoordinatoråˆæ˜¯å¦‚ä½•åº”å¯¹çš„å‘¢ï¼Ÿå’±ä»¬ä¸‹èŠ‚è¯¾è§åˆ†æ™“ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬æ›¾å¤šæ¬¡æåˆ°maybePrepareRebalanceæ–¹æ³•ï¼Œä»åå­—ä¸Šçœ‹ï¼Œå®ƒå¹¶ä¸ä¸€å®šä¼šå¼€å¯Rebalanceã€‚é‚£ä¹ˆï¼Œä½ èƒ½å¦ç»“åˆæºç è¯´è¯´çœ‹ï¼Œåˆ°åº•ä»€ä¹ˆæƒ…å†µä¸‹æ‰èƒ½å¼€å¯Rebalanceï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"31 | GroupMetadataManagerï¼šæŸ¥è¯¢ä½ç§»æ—¶ï¼Œä¸ç”¨è¯»å–ä½ç§»ä¸»é¢˜ï¼Ÿ","id":258348},"right":{"article_title":"33 | GroupCoordinatorï¼šåœ¨Rebalanceä¸­ï¼Œå¦‚ä½•è¿›è¡Œç»„åŒæ­¥ï¼Ÿ","id":260468}},"comments":[{"had_liked":false,"id":236051,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1595298860,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"9.2233720384501002e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬é‡ç‚¹å­¦ä¹ äº†GroupMetadataManagerç±»è¯»å†™ä½ç§»ä¸»é¢˜çš„æºç ã€‚è¯¾åæˆ‘è¯·ä½ åˆ†æcleanGroupMetadataæ–¹æ³•çš„æµç¨‹ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨å¸¦å‚æ•°çš„åŒåæ–¹æ³•cleanupGroupMetadataæ¥æ‰§è¡Œç»„ä½ç§»çš„æ¸…é™¤ã€‚åè€…ä¼šéå†ç»™å®šçš„æ‰€æœ‰æ¶ˆè´¹è€…ç»„ï¼Œä¹‹åè°ƒç”¨removeExpiredOffsetsæ–¹æ³•æ‰§è¡Œè¿‡æœŸä½ç§»çš„æ¸…é™¤ã€‚æ¸…é™¤çš„ä¸»è¦ä¾æ®æ˜¯çœ‹å½“å‰æ—¶é—´ä¸ä½ç§»æäº¤çš„æ—¶é—´çš„å·®å€¼æ˜¯å¦è¶Šè¿‡äº†offsets.retention.minuteså‚æ•°å€¼ã€‚å¦‚æœè¶Šè¿‡äº†åˆ™è§†è¯¥ä½ç§»ä¸ºè¿‡æœŸï¼Œéœ€è¦ä»offsetsä¸­ç§»é™¤ã€‚åŒæ—¶ï¼ŒcleanupGroupMetadataæ–¹æ³•è¿˜ä¼šæ„é€ tombstoneæ¶ˆæ¯å¹¶å†™å…¥åˆ°å†…éƒ¨ä½ç§»ä¸»é¢˜æ‰§è¡Œä¸»é¢˜ä¸­çš„è¿‡æœŸä½ç§»æ¶ˆæ¯çš„è¾“å‡ºã€‚<br><br>okayï¼Œä½ åŒæ„è¿™ä¸ªè¯´æ³•å—ï¼Ÿæˆ–è€…è¯´ä½ æœ‰å…¶ä»–çš„çœ‹æ³•å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":0},{"had_liked":false,"id":234333,"user_name":"åŒæ¤’å”å”","can_delete":false,"product_type":"c1","uid":1395385,"ip_address":"","ucode":"9C4B1DB2E693AF","user_header":"https://static001.geekbang.org/account/avatar/00/15/4a/b9/1531ff1c.jpg","comment_is_top":false,"comment_ctime":1594648487,"is_pvip":false,"replies":[{"id":"86593","content":"åˆ é™¤zkä¸­&#47;admin&#47;reassign_partitionsä¸‹å¯¹åº”çš„èŠ‚ç‚¹ç„¶åé‡å¯brokerè¯•è¯•å‘¢<br>","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1594778734,"ip_address":"","comment_id":234333,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5889615783","product_id":100050101,"comment_content":"èƒ¡è€å¸ˆï¼Œæ‚¨å¥½<br>åˆ†åŒºè¿ç§»é‡åˆ°çš„é—®é¢˜æ€ä¹ˆè§£å†³å‘¢<br>1038ï¼Œ1037ï¼Œ1029-----reassign-----&gt;1038,1037,1048<br>å…¶å®å°±æ˜¯1029æœºå­å…ˆå®•æ‰äº†ï¼Œç„¶åæˆ‘æƒ³è¦æŠŠæ­»æ‰çš„1029æœºå­ä¸Šçš„å‰¯æœ¬è¿ç§»åˆ°1048ä¸Š<br><br>ä½†æ˜¯è¿ç§»è®¡åˆ’å¡æ­»äº†ï¼Œä¸€ç›´in progress<br>replicaå˜æˆ1038ï¼Œ1037ï¼Œ1048ï¼Œ1029äº†ï¼ŒISRå˜æˆäº†1038,1048<br><br>ç°åœ¨æˆ‘æƒ³è¦åœ¨replicaä¸­remove1029ï¼Œæˆ‘çœ‹äº†æºç å‘ç°æ˜¯çŠ¶æ€æœºç»´æŠ¤çš„æ¯ä¸€ä¸ªreplicaçŠ¶æ€<br><br>æºç ä¸­<br>1038ï¼Œ1037ï¼Œ1029-----reassign-----&gt;1038,1037,1048<br>è¿ç§»è®¡åˆ’å¡ä½çš„é‚£æ­¥æ˜¯è¿™æ ·çš„<br>è¦æŠŠ1029å‰¯æœ¬çš„çŠ¶æ€ä»replicaä¸­ç§»é™¤æµç¨‹æ˜¯<br>controllerå…ˆæŠŠ1029offline,<br>ç„¶å<br>controllerå‘é€çŠ¶æ€æ”¹å˜è¯·æ±‚ï¼ˆdeletedï¼‰ç»™1029<br><br><br>1ã€first move the replica to offline state (the controller removes it from the ISR)<br><br>2ã€send stop replica command to the old replicas<br><br><br>3ã€Eventually partition reassignment could use a callback that does retries if deletion failed<br><br>å¦‚æœ1029è¿™ä¸ªèŠ‚ç‚¹ä¸åœ¨çº¿çš„è¯å°±ä¼š<br>è¿”å›ä¸€ä¸ªå›è°ƒçŠ¶æ€å€¼NonExistentReplicaï¼ˆå› ä¸º1029ç°åœ¨æ˜¯æ­»äº†çš„çŠ¶æ€ï¼‰ã€‚<br>reassignmenté‚£é‡Œçš„æºç å¤§æ¦‚æˆ‘çœ‹äº†ä¸‹ï¼Œä¸çŸ¥é“ä¸Šé¢çš„ç†è§£å¯¹ä¸å¯¹<br>å°±æƒ³é—®ä¸‹ï¼Œæƒ³è¿™ç§åŸæœ¬3å‰¯æœ¬ï¼Œç°åœ¨æ‰§è¡Œè¿ç§»è®¡åˆ’åï¼Œreplicaä¸­å¤šäº†ä¸€ä¸ªä¸åœ¨çº¿çš„1029ï¼Œç„¶åæ‰§è¡Œè®¡åˆ’ä¸€ç›´in progress<br>é‚£ä¹ˆè¿™ç§æƒ…å†µå¦‚ä½•è§£å†³å‘¢ï¼Ÿ<br>æ˜¯ç›´æ¥åœ¨zkä¸­ä¿®æ”¹è¯¥ä¸»é¢˜çš„é—®é¢˜åˆ†åŒºï¼ˆæ‰§è¡Œè¿ç§»è®¡åˆ’å¡ä¸»çš„é‚£ä¸ªåˆ†åŒºï¼‰å—ï¼Ÿç”Ÿäº§ä¸­1kä¸ªåˆ†åŒºï¼Œzkä¸­ä¸çŸ¥é“æ•¢ä¸æ•¢ä¿®æ”¹","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501355,"discussion_content":"åˆ é™¤zkä¸­/admin/reassign_partitionsä¸‹å¯¹åº”çš„èŠ‚ç‚¹ç„¶åé‡å¯brokerè¯•è¯•å‘¢\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594778734,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358079,"user_name":"z.l","can_delete":false,"product_type":"c1","uid":1181055,"ip_address":"ä¸Šæµ·","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","comment_is_top":false,"comment_ctime":1663900400,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663900400","product_id":100050101,"comment_content":"è¯·æ•™ä¸‹ï¼Œä¸ºä»€ä¹ˆæ¶ˆè´¹è€…ç»„éè¦é€‰å‡ºä¸€ä¸ªLeaderæˆå‘˜ï¼Œç›´æ¥ç”±Coordinatorè®¡ç®—å¥½åˆ†åŒºåˆ†é…æ–¹æ¡ˆå†å‘ç»™æ¯ä¸ªç»„æˆå‘˜ä¸æ˜¯æ›´ç®€å•ä¹ˆï¼ŸLeaderæ˜¯å¦è®¾è®¡å¤æ‚åŒ–äº†ï¼Ÿ","like_count":0},{"had_liked":false,"id":274652,"user_name":"è‚–æ’","can_delete":false,"product_type":"c1","uid":1861000,"ip_address":"","ucode":"50B1118691B222","user_header":"","comment_is_top":false,"comment_ctime":1611112695,"is_pvip":false,"replies":[{"id":"99937","content":"ä¼šåœ¨rebalanceå‰å°è¯•æäº¤ä½ç§»ï¼Œå¦‚æœæˆåŠŸåˆ™okayï¼Œä¸æˆåŠŸå°±åªèƒ½ç­‰å¾…rebalanceç»“æŸäº†","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1611540242,"ip_address":"","comment_id":274652,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1611112695","product_id":100050101,"comment_content":"è¯·æ•™ä¸‹ï¼Œé‡å¹³è¡¡å¼€å¯å‰æ˜¯å¦‚ä½•å¤„ç† offset çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514079,"discussion_content":"ä¼šåœ¨rebalanceå‰å°è¯•æäº¤ä½ç§»ï¼Œå¦‚æœæˆåŠŸåˆ™okayï¼Œä¸æˆåŠŸå°±åªèƒ½ç­‰å¾…rebalanceç»“æŸäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611540242,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272327,"user_name":"å¯¹ä¸é”™","can_delete":false,"product_type":"c1","uid":1682027,"ip_address":"","ucode":"EF55733E3BD78B","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","comment_is_top":false,"comment_ctime":1610033231,"is_pvip":false,"replies":[{"id":"98754","content":"brokeræŒ‚äº†ï¼Œå…¶ä»–å‰¯æœ¬ä¼šæˆä¸ºleaderï¼Œä¹Ÿå°±æ˜¯æ–°çš„Coordinator","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1610089495,"ip_address":"","comment_id":272327,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1610033231","product_id":100050101,"comment_content":"èƒ¡å“¥ï¼Œåè°ƒè€…æ˜¯ä¾æ®ä»€ä¹ˆæ¥çš„ï¼Ÿæ¯”å¦‚ä¸€ä¸ªåè°ƒè€…æ‰€å¯¹åº”çš„brokeræŒ‚äº†ï¼Œé‚£ä¹ˆå…¶ä»–æ¶ˆè´¹è€…æˆå‘˜ä¼šå‘ç”Ÿä»€ä¹ˆ?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513239,"discussion_content":"brokeræŒ‚äº†ï¼Œå…¶ä»–å‰¯æœ¬ä¼šæˆä¸ºleaderï¼Œä¹Ÿå°±æ˜¯æ–°çš„Coordinator","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610089495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1132315,"avatar":"https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg","nickname":"èƒ¡å°ç¦¾","note":"","ucode":"1C23B7492C0C9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542903,"discussion_content":"ç½‘å‹ å¯¹ä¸é”™  åº”è¯¥æƒ³é—®çš„æ˜¯ ä¸€ä¸ªåè°ƒè€…æ‰€å¯¹åº”çš„brokeræŒ‚äº†ï¼Œé‚£ä¹ˆå…¶ä»–æ¶ˆè´¹è€…æˆå‘˜ä¼šä¸ä¼š rebalance å§?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640877858,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268534,"user_name":"ä¸‰é¢—è±†å­","can_delete":false,"product_type":"c1","uid":2008638,"ip_address":"","ucode":"632CE3E7563666","user_header":"https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg","comment_is_top":false,"comment_ctime":1608251649,"is_pvip":false,"replies":[{"id":"97815","content":"èƒ½å‘ä¸‹æˆªå›¾æˆ–å…·ä½“çš„JMX beanå—ï¼Ÿæˆ‘å»çœ‹ä¸‹å¯¹åº”çš„é€»è¾‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1608775122,"ip_address":"","comment_id":268534,"utype":1}],"discussion_count":4,"race_medal":0,"score":"1608251649","product_id":100050101,"comment_content":"ç”Ÿäº§å‘ç°JoinGroupçš„ç›‘æ§æŒ‡æ ‡æ—¶å»¶å¾ˆé«˜ï¼ŒçŸ­çš„å‡ ç§’ï¼Œé•¿çš„1åˆ†é’Ÿï¼Œè¿™ä¸ªæ­£å¸¸å—ï¼Ÿå…¶ä»–çš„å…¨éƒ¨è¯·æ±‚æ—¶å»¶éƒ½åœ¨2ç§’ä»¥ä¸‹ã€‚ä»”ç»†åˆ†ææ˜¯åœ¨remoteé˜¶æ®µçš„æ—¶å»¶å¾ˆé«˜ï¼Œremoteå®ƒåœ¨ç­‰ä»€ä¹ˆå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511961,"discussion_content":"èƒ½å‘ä¸‹æˆªå›¾æˆ–å…·ä½“çš„JMX beanå—ï¼Ÿæˆ‘å»çœ‹ä¸‹å¯¹åº”çš„é€»è¾‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608775122,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1132315,"avatar":"https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg","nickname":"èƒ¡å°ç¦¾","note":"","ucode":"1C23B7492C0C9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542906,"discussion_content":"å½“Consumer group memberæˆå‘˜æ•°é‡æ¯”è¾ƒå¤š,å†åŠ ä¸ŠConsumer é¢‘ç¹ç”Ÿæ­»,ç¡®å®å®¹æ˜“å‡ºç° Rebalanceæ—¶é—´è¾ƒé•¿çš„é—®é¢˜.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640878454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1132315,"avatar":"https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg","nickname":"èƒ¡å°ç¦¾","note":"","ucode":"1C23B7492C0C9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542905,"discussion_content":"K8çš„è‡ªåŠ¨ä¼¸ç¼© åº”è¯¥æ„å‘³ç€ Consumeræ•°é‡çš„ä¸æ–­å˜åŒ–å§? é‚£ä¹ˆè¿™æ˜¯æ— æ³•é¿å…consumer groupçš„rebalance çš„, é™¤éä½¿ç”¨é«˜ç‰ˆæœ¬çš„group.instance.id è¯•è¯•(ç”Ÿäº§æ²¡æœ‰ä½¿ç”¨è¿‡).","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640878105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2008638,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg","nickname":"ä¸‰é¢—è±†å­","note":"","ucode":"632CE3E7563666","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337517,"discussion_content":"è¯„è®ºæ— æ³•å‘æˆªå›¾ï¼Œæˆ‘åœ¨è¯¦ç»†æè¿°ä¸€ä¸‹ã€‚JMXåç§°æ˜¯kafka_network_requestmetrics_remotetimemsï¼Œå…¶ç›‘æ§çš„æŒ‡æ ‡ä¸­ï¼Œå…¶ä»–ç±»å‹çš„è¯·æ±‚éƒ½åœ¨msçº§åˆ«ï¼Œåªæœ‰JoinGroupåœ¨ç§’çº§åˆ«ï¼Œé•¿çš„èƒ½å¤Ÿåˆ°1åˆ†é’Ÿã€‚æˆ‘æ— æ³•åˆ¤æ–­è¿™æ ·çš„ç°è±¡æ˜¯å¦æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯æŒ‰ç…§æˆ‘çš„ç†è§£ï¼ŒJoinGroupæœŸé—´kafkaä»ç„¶å¤„äºåˆ†åŒºé‡åˆ†é…çš„é˜¶æ®µï¼Œæ­¤æ—¶è¯¥ä¸»é¢˜ä¸å¯ç”¨ï¼ˆåº”ç”¨æ— æ³•æ¶ˆè´¹æ¶ˆæ¯ï¼‰ï¼Œå½±å“åº”è¯¥æŒºå¤§çš„ã€‚é€šè¿‡ä»”ç»†åˆ†æï¼Œé•¿è¾¾1åˆ†é’Ÿçš„æ—¶å€™ï¼Œå› ä¸ºK8Sçš„HPAé…ç½®ï¼ŒæŸä¸ªåº”ç”¨åœ¨ä¸´ç•Œå€¼è¾¹ç¼˜å¾˜å¾Šï¼Œé¢‘ç¹è¿›è¡Œæ‰©å®¹/ç¼©å®¹ï¼Œå¯¼è‡´Kafkaé¢‘ç¹è¿›è¡Œåˆ†åŒºé‡åˆ†é…ï¼Œé¢‘ç¹æ‰§è¡ŒJoinGroupã€‚ä½†è¿™ä¸ªç†ç”±åªèƒ½è¯´æ˜å½“æ—¶çš„æ ·æœ¬æ•°é‡æ¯”è¾ƒå¤šï¼Œä½†ä¸èƒ½è§£é‡Šä¸ºä»€ä¹ˆå»¶è¿Ÿæé«˜äº†ã€‚æˆ‘ä»¬æŠŠHPAå†æ‰©äº†ä¸€ç‚¹ï¼Œå‡å°‘å®ƒçš„æ‰©å®¹å’Œç¼©å®¹æ¬¡æ•°å’Œé¢‘ç‡ï¼Œæ—¶å»¶å¥½äº†ä¸€ç‚¹ï¼Œä½†ä¹Ÿæœ‰10sï¼Œè¿™æ˜¯æ­£å¸¸çš„å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦å¤–è§‚å¯Ÿäº†server.logæ—¥å¿—ï¼Œæ²¡æœ‰å‘ç°å¼‚å¸¸ï¼›åŒæ—¶è¯¥é˜¶æ®µæ²¡æœ‰å‘ç”Ÿä»»ä½•è„‘è£‚ã€Controllerå˜æ›´ã€ç½‘ç»œä¸å¥½ã€ç‚¼ç‹±è¯·æ±‚æ•°é‡å †ç§¯ç­‰äº‹æƒ…ï¼Œkafkaé™¤äº†è¿™ä¸ªæŒ‡æ ‡å…¶ä»–éƒ½æ­£å¸¸ã€‚\næ„Ÿè§‰K8Sçš„è‡ªåŠ¨ä¼¸ç¼©å’Œkafkaçš„é‡å¹³è¡¡å°±æ˜¯çŸ›ç›¾çš„ä¸¤ä¸ªç‰¹æ€§ï¼Œè‡ªåŠ¨ä¼¸ç¼©å¾ˆå¥½ç”¨ï¼Œä½†å¿…ç„¶ä¼šäº§ç”Ÿé‡å¹³è¡¡ï¼Œè¿™ä¸ªæœ‰ä»€ä¹ˆåŠæ³•è§£å†³å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608957144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245680,"user_name":"å¼ å­æ¶µ","can_delete":false,"product_type":"c1","uid":1743397,"ip_address":"","ucode":"57C509EA32B916","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg","comment_is_top":false,"comment_ctime":1599025958,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599025958","product_id":100050101,"comment_content":"   private def maybePrepareRebalance(group: GroupMetadata, reason: String): Unit = {<br>    group.inLock {<br>      if (group.canRebalance) <br>        prepareRebalance(group, reason)<br>    }<br>  }<br>  åœ¨GroupMetadataä¸­canRebalanceæ–¹æ³•å®šä¹‰ä¸º<br>   def canRebalance = PreparingRebalance.validPreviousStates.contains(state)<br>  ç„¶åè°ƒç”¨prepareRebalanceæ–¹æ³•<br>     private def prepareRebalance(group: GroupMetadata, reason: String): Unit = {<br>    &#47;&#47;å¦‚æœæœ‰ä»»ä½•æˆå‘˜æ­£åœ¨ç­‰å¾…åŒæ­¥ï¼Œå–æ¶ˆä»–ä»¬çš„è¯·æ±‚å¹¶è®©ä»–ä»¬é‡æ–°åŠ å…¥<br>    if (group.is(CompletingRebalance))<br>      resetAndPropagateAssignmentError(group, Errors.REBALANCE_IN_PROGRESS)<br>    val delayedRebalance = if (group.is(Empty))<br>      new InitialDelayedJoin(this,<br>        joinPurgatory,<br>        group,<br>        groupConfig.groupInitialRebalanceDelayMs,<br>        groupConfig.groupInitialRebalanceDelayMs,<br>        max(group.rebalanceTimeoutMs - groupConfig.groupInitialRebalanceDelayMs, 0))<br>    else<br>      new DelayedJoin(this, group, group.rebalanceTimeoutMs)<br>    group.transitionTo(PreparingRebalance)<br>    info(s&quot;Preparing to rebalance group ${group.groupId} in state ${group.currentState} with old generation &quot; +<br>      s&quot;${group.generationId} (${Topic.GROUP_METADATA_TOPIC_NAME}-${partitionFor(group.groupId)}) (reason: $reason)&quot;)<br>    val groupKey = GroupKey(group.groupId)<br>    joinPurgatory.tryCompleteElseWatch(delayedRebalance, Seq(groupKey))<br>  }<br>","like_count":0},{"had_liked":false,"id":236985,"user_name":"äº‘ç«¯æ¼«æ¼«æ­¥","can_delete":false,"product_type":"c1","uid":1024490,"ip_address":"","ucode":"80C9E1E477E921","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a1/ea/4afba3f1.jpg","comment_is_top":false,"comment_ctime":1595642585,"is_pvip":false,"replies":[{"id":"87676","content":"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1595811002,"ip_address":"","comment_id":236985,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1595642585","product_id":100050101,"comment_content":"GroupStateæ˜¯Stable, CompletingRebalance, Emptyè¿™ä¸‰ç§çš„æƒ…å†µä¸‹æ‰å¯ä»¥","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502279,"discussion_content":"ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595811002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1209939,"avatar":"https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg","nickname":"é²Â·æœ¬","note":"","ucode":"F1DEB30C21B48E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306617,"discussion_content":"è€å¸ˆæ€ä¹ˆè€æ˜¯å›å¤ä¸€å¤§å †é—®å·? æˆ‘ä¹‹å‰çš„è¯„è®ºä¹Ÿæ˜¯å›å¤æˆ‘é—®å·,åˆ°åº•æ˜¯ç­”é”™äº†,è¿˜æ˜¯æˆ‘è¯´çš„è€å¸ˆä¸ç†è§£, è¿˜æ˜¯ç³»ç»Ÿæ˜¾ç¤ºçš„bug?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600331006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236271,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1595382279,"is_pvip":false,"replies":[{"id":"87315","content":"æ‰“å¼€DEBUGæ—¥å¿—ï¼Œä¼šæœ‰éå¸¸è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œé‡ç‚¹çœ‹çœ‹Coordinatoréƒ¨åˆ†çš„DEBUGæ—¥å¿—","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1595386791,"ip_address":"","comment_id":236271,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1595382279","product_id":100050101,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæƒ³é—®ä¸‹å¦‚ä½•èƒ½æ˜ç¡®è§‚å¯Ÿåˆ°reblanceçš„è¿‡ç¨‹ï¼Œå› ä¸ºæœ‰æ—¶å€™çŸ¥é“å‘ç”Ÿäº†reblanceï¼Œä½†æ˜¯ä¸èƒ½ç¡®è®¤æ˜¯ä»€ä¹ˆåŸå› å¼•èµ·çš„reblanceï¼Œæ‰€ä»¥æƒ³é€šè¿‡ä¸€å®šæ‰‹æ®µå®šä½ä¸‹ï¼Œæ¯”å¦‚tcpdumpæŠ“åŒ…ï¼Œä½†æ˜¯ç”¨wiresharkæ‰“å¼€å¹¶è½¬ä¸ºkafkaåè®®å¥½åƒä¹Ÿçœ‹ä¸å‡ºreblanceçš„è¿‡ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘ç”¨çš„ä¸ç†Ÿç»ƒï¼Œæƒ³è¯·è€å¸ˆå¯ä»¥è¡¥å……ä¸‹è¿™æ–¹é¢çš„ï¼Œæ¯•ç«Ÿç†è®ºç»“åˆå®è·µæ‰æ˜¯è§£å†³é—®é¢˜çš„é€”å¾„ã€‚<br>è¡¥å……è¯´ä¸€ä¸‹ï¼Œå¥½åƒserver.logä¹Ÿåªèƒ½çœ‹åˆ°è¯´Reblanceå¼€å§‹äº†ï¼ŒMemberè¢«ç§»é™¤ã€‚ã€‚ä¹‹ç±»ç­‰ç­‰ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502010,"discussion_content":"æ‰“å¼€DEBUGæ—¥å¿—ï¼Œä¼šæœ‰éå¸¸è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œé‡ç‚¹çœ‹çœ‹Coordinatoréƒ¨åˆ†çš„DEBUGæ—¥å¿—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595386791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234188,"user_name":"æ‡‚ç å“¥(GerryWen)","can_delete":false,"product_type":"c1","uid":2049910,"ip_address":"","ucode":"55CD1C9AAD87CD","user_header":"","comment_is_top":false,"comment_ctime":1594614621,"is_pvip":false,"replies":[{"id":"86441","content":"é¢ã€‚ã€‚ã€‚ä¸æ˜¯ä½ æƒ³çš„é‚£æ ·ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1594627675,"ip_address":"","comment_id":234188,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1594614621","product_id":100050101,"comment_content":"èƒ¡å¤§å¤§ï¼Œæ‚¨çš„ç¤¾åŒºåå­—æœ‰ç‚¹æ„æ€ã€‚https:&#47;&#47;issues.apache.org&#47;jira&#47;secure&#47;ViewProfile.jspa?name=huxi_2b<br>ğŸ˜€ğŸ˜ğŸ˜","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501310,"discussion_content":"é¢ã€‚ã€‚ã€‚ä¸æ˜¯ä½ æƒ³çš„é‚£æ ·ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594627675,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233730,"user_name":"ä¼¯å®‰çŸ¥å¿ƒ","can_delete":false,"product_type":"c1","uid":1961835,"ip_address":"","ucode":"6C17706658672C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg","comment_is_top":false,"comment_ctime":1594427605,"is_pvip":false,"replies":[{"id":"86291","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1594448139,"ip_address":"","comment_id":233730,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1594427605","product_id":100050101,"comment_content":"ä»ä»£ç ä¸Šçœ‹ï¼Œè¿›å…¥maybePrepareRebalanceçš„æ—¶å€™ï¼Œé¦–å…ˆæŠŠgroupåŠ å…¥é”ä¸­ï¼Œå› ä¸ºè¿™é‡Œè¦è®¿é—®æ¶ˆè´¹ç»„çš„å…ƒæ•°æ®ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰ï¼Œç„¶ååªæœ‰ä¸€ä¸ªåˆ¤æ–­if (group.canRebalance)ï¼Œè¿™ä¸ªåˆ¤æ–­ä¸»è¦æ˜¯åˆ¤æ–­æ¶ˆè´¹ç»„å…ƒæ•°æ®ä¸­çš„validPreviousStatesçš„mapé›†åˆä¸­æ˜¯å¦å­˜åœ¨PreparingRebalanceçŠ¶æ€çš„æ•°æ®ï¼Œäº‹å®ä¸Šè¿™ä¸ªçŠ¶æ€å°±æ˜¯ä¸€ä¸ªè¿‡æ¸¡çš„ä¸­é—´çŠ¶æ€æ¯”å¦‚æŸäº›æˆå‘˜åŠ å…¥è¶…æ—¶çš„çŠ¶æ€ï¼Œæ‰€æœ‰æˆå‘˜ç¦»å¼€äº†ç»„ï¼Œé€šè¿‡åˆ†åŒºè¿ç§»åˆ é™¤ç»„ã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501145,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594448139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2049910,"avatar":"","nickname":"æ‡‚ç å“¥(GerryWen)","note":"","ucode":"55CD1C9AAD87CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290394,"discussion_content":"ä¼˜ç§€ï¼Œä¸€è·¯è·Ÿè¿‡æ¥ï¼Œå¤§éƒ¨åˆ†è¯„è®ºéƒ½æœ‰ä½ çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594456696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}