{"id":75173,"title":"20 | 幻读是什么，幻读有什么问题？","content":"<p>在上一篇文章最后，我给你留了一个关于加锁规则的问题。今天，我们就从这个问题说起吧。</p><p>为了便于说明问题，这一篇文章，我们就先使用一个小一点儿的表。建表和初始化语句如下（为了便于本期的例子说明，我把上篇文章中用到的表结构做了点儿修改）：</p><pre><code>CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `c` int(11) DEFAULT NULL,\n  `d` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `c` (`c`)\n) ENGINE=InnoDB;\n\ninsert into t values(0,0,0),(5,5,5),\n(10,10,10),(15,15,15),(20,20,20),(25,25,25);\n</code></pre><p>这个表除了主键id外，还有一个索引c，初始化语句在表中插入了6行数据。</p><p>上期我留给你的问题是，下面的语句序列，是怎么加锁的，加的锁又是什么时候释放的呢？</p><pre><code>begin;\nselect * from t where d=5 for update;\ncommit;\n</code></pre><p>比较好理解的是，这个语句会命中d=5的这一行，对应的主键id=5，因此在select 语句执行完成后，id=5这一行会加一个写锁，而且由于两阶段锁协议，这个写锁会在执行commit语句的时候释放。</p><p>由于字段d上没有索引，因此这条查询语句会做全表扫描。那么，其他被扫描到的，但是不满足条件的5行记录上，会不会被加锁呢？</p><p>我们知道，InnoDB的默认事务隔离级别是可重复读，所以本文接下来没有特殊说明的部分，都是设定在可重复读隔离级别下。</p><h1>幻读是什么？</h1><p>现在，我们就来分析一下，如果只在id=5这一行加锁，而其他行的不加锁的话，会怎么样。</p><p>下面先来看一下这个场景（注意：这是我假设的一个场景）：</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/5b/8b/5bc506e5884d21844126d26bbe6fa68b.png?wh=935*496\" alt=\"\"></p><center><span class=\"reference\">图 1 假设只在id=5这一行加行锁</span></center><p>可以看到，session A里执行了三次查询，分别是Q1、Q2和Q3。它们的SQL语句相同，都是select * from t where d=5 for update。这个语句的意思你应该很清楚了，查所有d=5的行，而且使用的是当前读，并且加上写锁。现在，我们来看一下这三条SQL语句，分别会返回什么结果。</p><ol>\n<li>\n<p>Q1只返回id=5这一行；</p>\n</li>\n<li>\n<p>在T2时刻，session B把id=0这一行的d值改成了5，因此T3时刻Q2查出来的是id=0和id=5这两行；</p>\n</li>\n<li>\n<p>在T4时刻，session C又插入一行（1,1,5），因此T5时刻Q3查出来的是id=0、id=1和id=5的这三行。</p>\n</li>\n</ol><p>其中，Q3读到id=1这一行的现象，被称为“幻读”。也就是说，幻读指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行。</p><p>这里，我需要对“幻读”做一个说明：</p><ol>\n<li>\n<p>在可重复读隔离级别下，普通的查询是快照读，是不会看到别的事务插入的数据的。因此，幻读在“当前读”下才会出现。</p>\n</li>\n<li>\n<p>上面session B的修改结果，被session A之后的select语句用“当前读”看到，不能称为幻读。幻读仅专指“新插入的行”。</p>\n</li>\n</ol><p>如果只从第8篇文章<a href=\"https://time.geekbang.org/column/article/70562\">《事务到底是隔离的还是不隔离的？》</a>我们学到的事务可见性规则来分析的话，上面这三条SQL语句的返回结果都没有问题。</p><p>因为这三个查询都是加了for update，都是当前读。而当前读的规则，就是要能读到所有已经提交的记录的最新值。并且，session B和sessionC的两条语句，执行后就会提交，所以Q2和Q3就是应该看到这两个事务的操作效果，而且也看到了，这跟事务的可见性规则并不矛盾。</p><p>但是，这是不是真的没问题呢？</p><p>不，这里还真就有问题。</p><h1>幻读有什么问题？</h1><p><strong>首先是语义上的。</strong>session A在T1时刻就声明了，“我要把所有d=5的行锁住，不准别的事务进行读写操作”。而实际上，这个语义被破坏了。</p><p>如果现在这样看感觉还不明显的话，我再往session B和session C里面分别加一条SQL语句，你再看看会出现什么现象。</p><p><img src=\"https://static001.geekbang.org/resource/image/7a/07/7a9ffa90ac3cc78db6a51ff9b9075607.png?wh=940*545\" alt=\"\"></p><center><span class=\"reference\">图 2 假设只在id=5这一行加行锁--语义被破坏</span></center><p>session B的第二条语句update t set c=5 where id=0，语义是“我把id=0、d=5这一行的c值，改成了5”。</p><p>由于在T1时刻，session A 还只是给id=5这一行加了行锁， 并没有给id=0这行加上锁。因此，session B在T2时刻，是可以执行这两条update语句的。这样，就破坏了 session A 里Q1语句要锁住所有d=5的行的加锁声明。</p><p>session C也是一样的道理，对id=1这一行的修改，也是破坏了Q1的加锁声明。</p><p><strong>其次，是数据一致性的问题。</strong></p><p>我们知道，锁的设计是为了保证数据的一致性。而这个一致性，不止是数据库内部数据状态在此刻的一致性，还包含了数据和日志在逻辑上的一致性。</p><p>为了说明这个问题，我给session A在T1时刻再加一个更新语句，即：update t set d=100 where d=5。</p><p><img src=\"https://static001.geekbang.org/resource/image/dc/92/dcea7845ff0bdbee2622bf3c67d31d92.png?wh=937*568\" alt=\"\"></p><center><span class=\"reference\">图 3 假设只在id=5这一行加行锁--数据一致性问题</span></center><p>update的加锁语义和select …for update 是一致的，所以这时候加上这条update语句也很合理。session A声明说“要给d=5的语句加上锁”，就是为了要更新数据，新加的这条update语句就是把它认为加上了锁的这一行的d值修改成了100。</p><p>现在，我们来分析一下图3执行完成后，数据库里会是什么结果。</p><ol>\n<li>\n<p>经过T1时刻，id=5这一行变成 (5,5,100)，当然这个结果最终是在T6时刻正式提交的;</p>\n</li>\n<li>\n<p>经过T2时刻，id=0这一行变成(0,5,5);</p>\n</li>\n<li>\n<p>经过T4时刻，表里面多了一行(1,5,5);</p>\n</li>\n<li>\n<p>其他行跟这个执行序列无关，保持不变。</p>\n</li>\n</ol><p>这样看，这些数据也没啥问题，但是我们再来看看这时候binlog里面的内容。</p><ol>\n<li>\n<p>T2时刻，session B事务提交，写入了两条语句；</p>\n</li>\n<li>\n<p>T4时刻，session C事务提交，写入了两条语句；</p>\n</li>\n<li>\n<p>T6时刻，session A事务提交，写入了update t set d=100 where d=5 这条语句。</p>\n</li>\n</ol><p>我统一放到一起的话，就是这样的：</p><pre><code>update t set d=5 where id=0; /*(0,0,5)*/\nupdate t set c=5 where id=0; /*(0,5,5)*/\n\ninsert into t values(1,1,5); /*(1,1,5)*/\nupdate t set c=5 where id=1; /*(1,5,5)*/\n\nupdate t set d=100 where d=5;/*所有d=5的行，d改成100*/\n</code></pre><p>好，你应该看出问题了。这个语句序列，不论是拿到备库去执行，还是以后用binlog来克隆一个库，这三行的结果，都变成了 (0,5,100)、(1,5,100)和(5,5,100)。</p><p>也就是说，id=0和id=1这两行，发生了数据不一致。这个问题很严重，是不行的。</p><p>到这里，我们再回顾一下，<strong>这个数据不一致到底是怎么引入的？</strong></p><p>我们分析一下可以知道，这是我们假设“select * from t where d=5 for update这条语句只给d=5这一行，也就是id=5的这一行加锁”导致的。</p><p>所以我们认为，上面的设定不合理，要改。</p><p>那怎么改呢？我们把扫描过程中碰到的行，也都加上写锁，再来看看执行效果。</p><p><img src=\"https://static001.geekbang.org/resource/image/34/47/34ad6478281709da833856084a1e3447.png?wh=935*598\" alt=\"\"></p><center><span class=\"reference\">图 4 假设扫描到的行都被加上了行锁</span></center><p>由于session A把所有的行都加了写锁，所以session B在执行第一个update语句的时候就被锁住了。需要等到T6时刻session A提交以后，session B才能继续执行。</p><p>这样对于id=0这一行，在数据库里的最终结果还是 (0,5,5)。在binlog里面，执行序列是这样的：</p><pre><code>insert into t values(1,1,5); /*(1,1,5)*/\nupdate t set c=5 where id=1; /*(1,5,5)*/\n\nupdate t set d=100 where d=5;/*所有d=5的行，d改成100*/\n\nupdate t set d=5 where id=0; /*(0,0,5)*/\nupdate t set c=5 where id=0; /*(0,5,5)*/\n</code></pre><p>可以看到，按照日志顺序执行，id=0这一行的最终结果也是(0,5,5)。所以，id=0这一行的问题解决了。</p><p>但同时你也可以看到，id=1这一行，在数据库里面的结果是(1,5,5)，而根据binlog的执行结果是(1,5,100)，也就是说幻读的问题还是没有解决。为什么我们已经这么“凶残”地，把所有的记录都上了锁，还是阻止不了id=1这一行的插入和更新呢？</p><p>原因很简单。在T3时刻，我们给所有行加锁的时候，id=1这一行还不存在，不存在也就加不上锁。</p><p><strong>也就是说，即使把所有的记录都加上锁，还是阻止不了新插入的记录，</strong>这也是为什么“幻读”会被单独拿出来解决的原因。</p><p>到这里，其实我们刚说明完文章的标题 ：幻读的定义和幻读有什么问题。</p><p>接下来，我们再看看InnoDB怎么解决幻读的问题。</p><h1>如何解决幻读？</h1><p>现在你知道了，产生幻读的原因是，行锁只能锁住行，但是新插入记录这个动作，要更新的是记录之间的“间隙”。因此，为了解决幻读问题，InnoDB只好引入新的锁，也就是间隙锁(Gap Lock)。</p><p>顾名思义，间隙锁，锁的就是两个值之间的空隙。比如文章开头的表t，初始化插入了6个记录，这就产生了7个间隙。</p><p><img src=\"https://static001.geekbang.org/resource/image/e7/61/e7f7ca0d3dab2f48c588d714ee3ac861.png?wh=1142*550\" alt=\"\"></p><center><span class=\"reference\">图 5 表t主键索引上的行锁和间隙锁</span></center><p>这样，当你执行 select * from t where d=5 for update的时候，就不止是给数据库中已有的6个记录加上了行锁，还同时加了7个间隙锁。这样就确保了无法再插入新的记录。</p><p>也就是说这时候，在一行行扫描的过程中，不仅将给行加上了行锁，还给行两边的空隙，也加上了间隙锁。</p><p>现在你知道了，数据行是可以加上锁的实体，数据行之间的间隙，也是可以加上锁的实体。但是间隙锁跟我们之前碰到过的锁都不太一样。</p><p>比如行锁，分成读锁和写锁。下图就是这两种类型行锁的冲突关系。</p><p><img src=\"https://static001.geekbang.org/resource/image/c4/51/c435c765556c0f3735a6eda0779ff151.png?wh=411*154\" alt=\"\"></p><center><span class=\"reference\">图6 两种行锁间的冲突关系</span></center><p>也就是说，跟行锁有冲突关系的是“另外一个行锁”。</p><p>但是间隙锁不一样，<strong>跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。</strong>间隙锁之间都不存在冲突关系。</p><p>这句话不太好理解，我给你举个例子：</p><p><img src=\"https://static001.geekbang.org/resource/image/7c/98/7c37732d936650f1cda7dbf27daf7498.png?wh=946*210\" alt=\"\"></p><center><span class=\"reference\">图7 间隙锁之间不互锁</span></center><p>这里session B并不会被堵住。因为表t里并没有c=7这个记录，因此session A加的是间隙锁(5,10)。而session B也是在这个间隙加的间隙锁。它们有共同的目标，即：保护这个间隙，不允许插入值。但，它们之间是不冲突的。</p><p>间隙锁和行锁合称next-key lock，每个next-key lock是前开后闭区间。也就是说，我们的表t初始化以后，如果用select * from t for update要把整个表所有记录锁起来，就形成了7个next-key lock，分别是 (-∞,0]、(0,5]、(5,10]、(10,15]、(15,20]、(20, 25]、(25, +supremum]。</p><blockquote>\n<p>备注：这篇文章中，如果没有特别说明，我们把间隙锁记为开区间，把next-key lock记为前开后闭区间。</p>\n</blockquote><p>你可能会问说，这个supremum从哪儿来的呢？</p><p>这是因为+∞是开区间。实现上，InnoDB给每个索引加了一个不存在的最大值supremum，这样才符合我们前面说的“都是前开后闭区间”。</p><p><strong>间隙锁和next-key lock的引入，帮我们解决了幻读的问题，但同时也带来了一些“困扰”。</strong></p><p>在前面的文章中，就有同学提到了这个问题。我把他的问题转述一下，对应到我们这个例子的表来说，业务逻辑这样的：任意锁住一行，如果这一行不存在的话就插入，如果存在这一行就更新它的数据，代码如下：</p><pre><code>begin;\nselect * from t where id=N for update;\n\n/*如果行不存在*/\ninsert into t values(N,N,N);\n/*如果行存在*/\nupdate t set d=N set id=N;\n\ncommit;\n</code></pre><p>可能你会说，这个不是insert … on duplicate key update 就能解决吗？但其实在有多个唯一键的时候，这个方法是不能满足这位提问同学的需求的。至于为什么，我会在后面的文章中再展开说明。</p><p>现在，我们就只讨论这个逻辑。</p><p>这个同学碰到的现象是，这个逻辑一旦有并发，就会碰到死锁。你一定也觉得奇怪，这个逻辑每次操作前用for update锁起来，已经是最严格的模式了，怎么还会有死锁呢？</p><p>这里，我用两个session来模拟并发，并假设N=9。</p><p><img src=\"https://static001.geekbang.org/resource/image/df/be/df37bf0bb9f85ea59f0540e24eb6bcbe.png?wh=944*360\" alt=\"\"></p><center><span class=\"reference\">图8 间隙锁导致的死锁</span></center><p>你看到了，其实都不需要用到后面的update语句，就已经形成死锁了。我们按语句执行顺序来分析一下：</p><ol>\n<li>\n<p>session A 执行select … for update语句，由于id=9这一行并不存在，因此会加上间隙锁(5,10);</p>\n</li>\n<li>\n<p>session B 执行select … for update语句，同样会加上间隙锁(5,10)，间隙锁之间不会冲突，因此这个语句可以执行成功；</p>\n</li>\n<li>\n<p>session B 试图插入一行(9,9,9)，被session A的间隙锁挡住了，只好进入等待；</p>\n</li>\n<li>\n<p>session A试图插入一行(9,9,9)，被session B的间隙锁挡住了。</p>\n</li>\n</ol><p>至此，两个session进入互相等待状态，形成死锁。当然，InnoDB的死锁检测马上就发现了这对死锁关系，让session A的insert语句报错返回了。</p><p>你现在知道了，<strong>间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的</strong>。其实，这还只是一个简单的例子，在下一篇文章中我们还会碰到更多、更复杂的例子。</p><p>你可能会说，为了解决幻读的问题，我们引入了这么一大串内容，有没有更简单一点的处理方法呢。</p><p>我在文章一开始就说过，如果没有特别说明，今天和你分析的问题都是在可重复读隔离级别下的，间隙锁是在可重复读隔离级别下才会生效的。所以，你如果把隔离级别设置为读提交的话，就没有间隙锁了。但同时，你要解决可能出现的数据和日志不一致问题，需要把binlog格式设置为row。这，也是现在不少公司使用的配置组合。</p><p>前面文章的评论区有同学留言说，他们公司就使用的是读提交隔离级别加binlog_format=row的组合。他曾问他们公司的DBA说，你为什么要这么配置。DBA直接答复说，因为大家都这么用呀。</p><p>所以，这个同学在评论区就问说，这个配置到底合不合理。</p><p>关于这个问题本身的答案是，如果读提交隔离级别够用，也就是说，业务不需要可重复读的保证，这样考虑到读提交下操作数据的锁范围更小（没有间隙锁），这个选择是合理的。</p><p>但其实我想说的是，配置是否合理，跟业务场景有关，需要具体问题具体分析。</p><p>但是，如果DBA认为之所以这么用的原因是“大家都这么用”，那就有问题了，或者说，迟早会出问题。</p><p>比如说，大家都用读提交，可是逻辑备份的时候，mysqldump为什么要把备份线程设置成可重复读呢？（这个我在前面的文章中已经解释过了，你可以再回顾下第6篇文章<a href=\"https://time.geekbang.org/column/article/69862\">《全局锁和表锁 ：给表加个字段怎么有这么多阻碍？》</a>的内容）</p><p>然后，在备份期间，备份线程用的是可重复读，而业务线程用的是读提交。同时存在两种事务隔离级别，会不会有问题？</p><p>进一步地，这两个不同的隔离级别现象有什么不一样的，关于我们的业务，“用读提交就够了”这个结论是怎么得到的？</p><p>如果业务开发和运维团队这些问题都没有弄清楚，那么“没问题”这个结论，本身就是有问题的。</p><h1>小结</h1><p>今天我们从上一篇文章的课后问题说起，提到了全表扫描的加锁方式。我们发现即使给所有的行都加上行锁，仍然无法解决幻读问题，因此引入了间隙锁的概念。</p><p>我碰到过很多对数据库有一定了解的业务开发人员，他们在设计数据表结构和业务SQL语句的时候，对行锁有很准确的认识，但却很少考虑到间隙锁。最后的结果，就是生产库上会经常出现由于间隙锁导致的死锁现象。</p><p>行锁确实比较直观，判断规则也相对简单，间隙锁的引入会影响系统的并发度，也增加了锁分析的复杂度，但也有章可循。下一篇文章，我就会为你讲解InnoDB的加锁规则，帮你理顺这其中的“章法”。</p><p>作为对下一篇文章的预习，我给你留下一个思考题。</p><p><img src=\"https://static001.geekbang.org/resource/image/0d/3d/0d796060073668ca169166a8903fbf3d.png?wh=938*308\" alt=\"\"></p><center><span class=\"reference\">图9 事务进入锁等待状态</span></center><p>如果你之前没有了解过本篇文章的相关内容，一定觉得这三个语句简直是风马牛不相及。但实际上，这里session B和session C的insert 语句都会进入锁等待状态。</p><p>你可以试着分析一下，出现这种情况的原因是什么？</p><p>这里需要说明的是，这其实是我在下一篇文章介绍加锁规则后才能回答的问题，是留给你作为预习的，其中session C被锁住这个分析是有点难度的。如果你没有分析出来，也不要气馁，我会在下一篇文章和你详细说明。</p><p>你也可以说说，你的线上MySQL配置的是什么隔离级别，为什么会这么配置？你有没有碰到什么场景，是必须使用可重复读隔离级别的呢？</p><p>你可以把你的碰到的场景和分析写在留言区里，我会在下一篇文章选取有趣的评论跟大家一起分享和分析。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>我们在本文的开头回答了上期问题。有同学的回答中还说明了读提交隔离级别下，在语句执行完成后，是只有行锁的。而且语句执行完成后，InnoDB就会把不满足条件的行行锁去掉。</p><p>当然了，c=5这一行的行锁，还是会等到commit的时候才释放的。</p><p>评论区留言点赞板：</p><blockquote>\n<p>@薛畅 、@张永志同学给出了正确答案。而且提到了在读提交隔离级别下，是只有行锁的。<br>\n@帆帆帆帆帆帆帆帆、@欧阳成 对上期的例子做了验证，需要说明一下，需要在启动配置里面增加performance_schema=on，才能用上这个功能，performance_schema库里的表才有数据。</p>\n</blockquote><p></p>","comments":[{"had_liked":false,"id":54927,"user_name":"令狐少侠","can_delete":false,"product_type":"c1","uid":1334516,"ip_address":"","ucode":"36390E67AF0779","user_header":"https://static001.geekbang.org/account/avatar/00/14/5c/f4/88f107d9.jpg","comment_is_top":true,"comment_ctime":1545982633,"is_pvip":false,"replies":[{"id":"19872","content":"1. 好问题。你可以理解为要在索引c上插入一个(c=5,id=0)这一行，是落在(0,5],(5,10]里面的，11可以对吧<br><br>2. 嗯，主键索引的间隙上也要有Gap lock保护的","user_name":"作者回复","comment_id":54927,"uid":"1264162","ip_address":"","utype":1,"ctime":1545983694,"user_name_real":"林晓斌"}],"discussion_count":87,"race_medal":0,"score":"9.2233724077679002e+18","product_id":100020801,"comment_content":"老师，今天的文章对我影响很大，发现之前掌握的知识有些错误的地方，课后我用你的表结构根据以前不清楚的地方实践了一遍，现在有两个问题，麻烦您解答下<br>1.我在事务1中执行 begin;select * from t where c=5 for update;事务未提交，然后事务2中begin;update t set c=5 where id=0;执行阻塞，替换成update t set c=11 where id=0;执行不阻塞，我觉得原因是事务1执行时产生next-key lock范围是(0,5].(5,10]。我想问下update set操作c=xxx是会加锁吗？以及加锁的原理。<br>2.一直以为gap只会在二级索引上，看了你的死锁案例，发现主键索引上也会有gap锁？","like_count":87,"discussions":[{"author":{"id":2113915,"avatar":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","nickname":"致良知","note":"","ucode":"73C722E31B726A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358908,"discussion_content":"文章中 自始至终都没有 说 间隙锁 什么时候给 二级索引加锁 什么时候给主键索引加锁  哈  \n这一篇文章 是所有文章中最糟糕的文章了  没有之一","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1616073967,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2113915,"avatar":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","nickname":"致良知","note":"","ucode":"73C722E31B726A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":363051,"discussion_content":"留言中找到了答案，间隙锁还是只对索引的。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1617104750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":358908,"ip_address":""},"score":363051,"extra":""},{"author":{"id":2346917,"avatar":"https://static001.geekbang.org/account/avatar/00/23/cf/a5/5224b297.jpg","nickname":"cafe babe","note":"","ucode":"6205DF67AD86F8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371433,"discussion_content":"啥意思？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619768031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":363051,"ip_address":""},"score":371433,"extra":""},{"author":{"id":2945508,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/kTIwKz8eeicPsWibiavOkCnhfys2HkhLFmNKN7hV3ax1GNsjs8Ss2BlH0ekelxFibZz4C3cy1R1YcEMopJhXCghqyQ/132","nickname":"Geek_c22ad7","note":"","ucode":"6A3ACF366C02CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2113915,"avatar":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","nickname":"致良知","note":"","ucode":"73C722E31B726A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556646,"discussion_content":"感觉是老师刻意而为之，每篇文章都不彻底讲透，在评论区解答","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1647436150,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":358908,"ip_address":""},"score":556646,"extra":""}]},{"author":{"id":2497728,"avatar":"https://static001.geekbang.org/account/avatar/00/26/1c/c0/b8ff566a.jpg","nickname":"我是大橙子132","note":"","ucode":"61660568CF07C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565621,"discussion_content":"根据优化2：c=10的行锁会优化掉，最终加的范围是(0,5],(5,10)。\n实践是检验真理的唯一标准：\nSELECT version();-- 5.7.30\n-- session A\n begin;\n select * from t where c=5 for update;\n-- session b\n select * from t where c=5 for update;// blocked\n select * from t where c=10 for update;// success ","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1650504640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1258399,"avatar":"https://static001.geekbang.org/account/avatar/00/13/33/9f/8dbd9558.jpg","nickname":"逆流的鱼","note":"","ucode":"AA3DDE44A83C40","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":13521,"discussion_content":"问下，间隙大小是怎么确定的？","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1568683577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2377275,"avatar":"https://static001.geekbang.org/account/avatar/00/24/46/3b/ac4b8ab0.jpg","nickname":"Stream上的帧","note":"","ucode":"325FBEFF80BD91","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1258399,"avatar":"https://static001.geekbang.org/account/avatar/00/13/33/9f/8dbd9558.jpg","nickname":"逆流的鱼","note":"","ucode":"AA3DDE44A83C40","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":336588,"discussion_content":"数据","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1608629511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":13521,"ip_address":""},"score":336588,"extra":""}]},{"author":{"id":2312325,"avatar":"","nickname":"Geek_9a7aac","note":"","ucode":"3BB66DD0619014","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572542,"discussion_content":"为啥我测试的时候不阻塞","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1652845011,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1144495,"avatar":"https://static001.geekbang.org/account/avatar/00/11/76/af/c4e518ff.jpg","nickname":"布衣不舍","note":"","ucode":"7576087DC22F3B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1948,"discussion_content":"请教一下，为什么事务1产生的next-key lock范围是(0,5].(5,10]呢？不是只有(0，5] 就够了吗","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1563114176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":8,"child_discussions":[{"author":{"id":1357056,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b5/00/f4e8fbaf.jpg","nickname":"chenpiing","note":"","ucode":"C847A30B3FDB8F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1144495,"avatar":"https://static001.geekbang.org/account/avatar/00/11/76/af/c4e518ff.jpg","nickname":"布衣不舍","note":"","ucode":"7576087DC22F3B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2000,"discussion_content":"事务1在c=5这行加行锁，以及在c索引的(0,5)和(5,10)加间隙锁吧，c=10这行没加锁","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1563174507,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1948,"ip_address":""},"score":2000,"extra":""},{"author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1357056,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b5/00/f4e8fbaf.jpg","nickname":"chenpiing","note":"","ucode":"C847A30B3FDB8F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204425,"discussion_content":"C=10没加锁，为什么不能更新为10呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584172457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2000,"ip_address":""},"score":204425,"extra":""},{"author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1357056,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b5/00/f4e8fbaf.jpg","nickname":"chenpiing","note":"","ucode":"C847A30B3FDB8F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204426,"discussion_content":"我的理解也是锁的范围是间隙锁(0,5)+行锁(5)+间隙锁(5,10)这个范围，很奇怪，10也不能更新成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584172518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2000,"ip_address":""},"score":204426,"extra":""}]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434616,"discussion_content":"1. 好问题。你可以理解为要在索引c上插入一个(c=5,id=0)这一行，是落在(0,5],(5,10]里面的，11可以对吧\n\n2. 嗯，主键索引的间隙上也要有Gap lock保护的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545983694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2312325,"avatar":"","nickname":"Geek_9a7aac","note":"","ucode":"3BB66DD0619014","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":572544,"discussion_content":"老师你好，我测试的时候不阻塞 是版本的问题吗","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1652845042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":434616,"ip_address":""},"score":572544,"extra":""}]},{"author":{"id":2459923,"avatar":"https://static001.geekbang.org/account/avatar/00/25/89/13/0d3c5008.jpg","nickname":"最好不过","note":"","ucode":"C7DBCD08402DF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378569,"discussion_content":"关于10为什么锁住可以看这篇文章就明白了，和索引的有序性有关https://helloworlde.github.io/blog/blog/MySQL/MySQL-%E4%B8%AD%E5%85%B3%E4%BA%8Egap-lock-next-key-lock-%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623289945,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1890006,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/d6/d6/5fbb6e00.jpg","nickname":"再忙也要充充电","note":"","ucode":"098F2D9D280D60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2459923,"avatar":"https://static001.geekbang.org/account/avatar/00/25/89/13/0d3c5008.jpg","nickname":"最好不过","note":"","ucode":"C7DBCD08402DF8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378688,"discussion_content":"其实看老师的下一篇就明白了 哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623335047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":378569,"ip_address":""},"score":378688,"extra":""},{"author":{"id":2357566,"avatar":"https://static001.geekbang.org/account/avatar/00/23/f9/3e/0d5f27c4.jpg","nickname":"肥猫不开心","note":"","ucode":"FA9204B84913C0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1890006,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/d6/d6/5fbb6e00.jpg","nickname":"再忙也要充充电","note":"","ucode":"098F2D9D280D60","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384004,"discussion_content":"我就是没懂。。那我接着看了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626334012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":378688,"ip_address":""},"score":384004,"extra":""}]},{"author":{"id":1391166,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3a/3e/53ab11ce.jpg","nickname":"周杰伦的奶茶","note":"","ucode":"343CF19391FB9F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350337,"discussion_content":"select c=5 for update 锁住索引（0,10]，pk(0,10]","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613814383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1622022,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJia6zEsh2u119zJicmq7wApvnricZEKiawaZicice1cOzujWdFicFwPtavlHiaVpCNgCpxBtdl7ynd3y0wkQ/132","nickname":"james_xu","note":"","ucode":"12E50291F5BA89","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1391166,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3a/3e/53ab11ce.jpg","nickname":"周杰伦的奶茶","note":"","ucode":"343CF19391FB9F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381950,"discussion_content":"并没有锁住主键的 (0,10]，我试了，INSERT INTO mydb.t (id, c, d) VALUES (8, 1000, 0);并不会被阻塞。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625316162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":350337,"ip_address":""},"score":381950,"extra":""}]},{"author":{"id":1053154,"avatar":"https://static001.geekbang.org/account/avatar/00/10/11/e2/38feb457.jpg","nickname":"人們說這都是浮雲可是浮雲真美麗。","note":"","ucode":"FA3493020FDB8E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315629,"discussion_content":"如果是等值查询，只需要锁住索引，不能再插入相同索引的数据就行，没想明白为什么用间隙锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603294800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":20,"child_discussions":[{"author":{"id":1275980,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoicSMibHxGmeNXCLAnB6S7icPh814icIsw7VZ5vYzLOyKKUJYmFC5WGPekH5qI7rRbH3n4Y2obiaKlBTQ/132","nickname":"konh","note":"","ucode":"1CAD0D67067CC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1053154,"avatar":"https://static001.geekbang.org/account/avatar/00/10/11/e2/38feb457.jpg","nickname":"人們說這都是浮雲可是浮雲真美麗。","note":"","ucode":"FA3493020FDB8E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315678,"discussion_content":"你再看一下文中关于间隙锁解决binlog日志那段。\n\n文中内容：\n假设不用间隙锁，binlog 中的内容如下。\n\n# session C\ninsert into t values(1,1,5); /*(1,1,5)*/\nupdate t set c=5 where id=1; /*(1,5,5)*/\n\n# session A\nupdate t set d=100 where d=5;/*所有d=5的行，d改成100*/\n\n# session B\nupdate t set d=5 where id=0; /*(0,0,5)*/\nupdate t set c=5 where id=0; /*(0,5,5)*/\n\n因为给表 t 所有行都加锁，所有 session B 必须等 session A 提交才能执行，即 binlog 会写在 session A后面。\n\nsession C 因为最早提交，所以 binlog 在最前面。\n\n如上的 binlog 如果被从库恢复，则 session C 中主库中的值 (1，5，5) 在从库就变为了 （1，5，100），这就是主备数据不一致的情况。\n\n","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1603303707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":315629,"ip_address":""},"score":315678,"extra":""},{"author":{"id":1053154,"avatar":"https://static001.geekbang.org/account/avatar/00/10/11/e2/38feb457.jpg","nickname":"人們說這都是浮雲可是浮雲真美麗。","note":"","ucode":"FA3493020FDB8E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1275980,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoicSMibHxGmeNXCLAnB6S7icPh814icIsw7VZ5vYzLOyKKUJYmFC5WGPekH5qI7rRbH3n4Y2obiaKlBTQ/132","nickname":"konh","note":"","ucode":"1CAD0D67067CC1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315697,"discussion_content":"这个例子我看了，正常sessionA锁表之后，sessionC是不能先插入的，他文中是假设。\n\n我要问的是：\nselect * from t where c = 5 for update; c非唯一索引；为什么要加间隙锁\n这里等值查询为什么不设计成锁住索引c=5，让别的插入c=5的插入阻塞也能解决幻读的吧\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603321595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":315678,"ip_address":""},"score":315697,"extra":""},{"author":{"id":1111805,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f6/fd/2c619dde.jpg","nickname":"Joe","note":"","ucode":"F73CF74433168D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1053154,"avatar":"https://static001.geekbang.org/account/avatar/00/10/11/e2/38feb457.jpg","nickname":"人們說這都是浮雲可是浮雲真美麗。","note":"","ucode":"FA3493020FDB8E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316680,"discussion_content":"如果没有间隙锁，插入c=6不就产生幻读了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603439565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":315697,"ip_address":""},"score":316680,"extra":""}]},{"author":{"id":1026090,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/2a/316b8f17.jpg","nickname":"毒草","note":"","ucode":"DBD67DD3517190","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293584,"discussion_content":"c=-1 也插入不了, 哪位老师能帮忙解释下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595586751,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1155646,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","nickname":"ppd0705","note":"","ucode":"EB63D4E3FD1E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026090,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/2a/316b8f17.jpg","nickname":"毒草","note":"","ucode":"DBD67DD3517190","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":302999,"discussion_content":"我发现c=-1插入不了的原因是我先提交了`update t set c = -5 where id=0;`  看来锁会根据数据动态变化","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599109660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":293584,"ip_address":""},"score":302999,"extra":""},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026090,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/2a/316b8f17.jpg","nickname":"毒草","note":"","ucode":"DBD67DD3517190","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330512,"discussion_content":"会不会是(-OO,0]这个间隙锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606638403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":293584,"ip_address":""},"score":330512,"extra":""},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1026090,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/2a/316b8f17.jpg","nickname":"毒草","note":"","ucode":"DBD67DD3517190","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330526,"discussion_content":"那你查询的点肯定不是5，或者5之前没数据，她是根据索引树去锁定的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606640682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":293584,"ip_address":""},"score":330526,"extra":""}]},{"author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204430,"discussion_content":"不理解为什么10也被锁住了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584172788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":11,"child_discussions":[{"author":{"id":1537865,"avatar":"https://static001.geekbang.org/account/avatar/00/17/77/49/445eea2d.jpg","nickname":"SochiLee","note":"","ucode":"47596594EDF4D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298220,"discussion_content":"不知道我理解的对不对，当insert(c=10,id=0)会对(c=5,c=10](c=10,c=15)和id=0(id=0,id=5)加锁，其中的(c=5,c=10]会和select * from t where c=5 for update给(c=0,c=5](c=5,c=10)和id=5加锁中的(c=5,c=10)冲突，所以它会被阻塞。但作者老师说的索引c上锁是(0,5],(5,10]我也很困惑不知道是为什么。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597221225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":204430,"ip_address":""},"score":298220,"extra":""},{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1537865,"avatar":"https://static001.geekbang.org/account/avatar/00/17/77/49/445eea2d.jpg","nickname":"SochiLee","note":"","ucode":"47596594EDF4D7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300751,"discussion_content":"但 update t set c= 10 where id =25;这样就可以成功执行，不知道为什么","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598255317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":298220,"ip_address":""},"score":300751,"extra":""},{"author":{"id":1447569,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/WtHCCMoLJ2DvzqQwPYZyj2RlN7eibTLMHDMTSO4xIKjfKR1Eh9L98AMkkZY7FmegWyGLahRQJ5ibPzeeFtfpeSow/132","nickname":"脱缰的野马__","note":"","ucode":"D5F993E7232C61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323639,"discussion_content":"看了上下那么多评论，大家都不理解的是为啥c=10的这一行为什么会上锁，也就是为什么会锁(5,10]这个前开后闭next-key lock而不是(5,10)这个间隙锁，两点：1.扫描（访问）过的行都会加锁；2. c为普通索引，我们以c=5这个当条件的时候，mysql在c索引组织结构上访问的时候是会访问到第一个不满足条件的行为止，也就是10这一行（这是前面关于SQL执行流程的相关内容）。所以大家是否明白了？","likes_number":14,"is_delete":false,"is_hidden":false,"ctime":1604977597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":204430,"ip_address":""},"score":323639,"extra":""}]},{"author":{"id":1810051,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0uyg1IicbEhLwsgM2A2ROoyVdWdmUqZfQfs6G67w9m3hdRNBMOQJatQoACj3qNGgj2KVIgricaYiaQ/132","nickname":"木得感情的编码机器","note":"","ucode":"9C6CD47ADCB8E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":189178,"discussion_content":"非常费解，为什么11就不锁？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582856373,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":12,"child_discussions":[{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1810051,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK0uyg1IicbEhLwsgM2A2ROoyVdWdmUqZfQfs6G67w9m3hdRNBMOQJatQoACj3qNGgj2KVIgricaYiaQ/132","nickname":"木得感情的编码机器","note":"","ucode":"9C6CD47ADCB8E6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195365,"discussion_content":"首先分析两部分:主键索引id,普通索引c  在执行事物1的时候查询普通索引c=5的数据,会在c索引上(0,5] (5,10)加锁,对应的id=5 会在id索引上id=5加行锁;当更新为c=5的时候,需要往c索引上插入一个(c=5,id=0)数据是落在c索引的(0,5]的next-key lock上;同理插入一个(c=11,id=0)的数据即不在(0,5] 不在(5,10)也不在id=5的行锁上","likes_number":15,"is_delete":false,"is_hidden":false,"ctime":1583271311,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":189178,"ip_address":""},"score":195365,"extra":""},{"author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204424,"discussion_content":"11可以是因为没在c索引上(0,5)5(5,10)里，更新为10为什么也不可以啊，我理解不是间隙锁+行锁+间隙锁吗，也就是(0,5] (5,10)这个范围，但是老师给的范围是(0,5],(5,10]，为什么包含10呢，事实证明10确实也不能更新\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584172369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":195365,"ip_address":""},"score":204424,"extra":""},{"author":{"id":1172145,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e2/b1/d00399c0.jpg","nickname":"心有林夕","note":"","ucode":"BC6E1AE557BFF4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217570,"discussion_content":"next-key lock 前开后闭，写的很清楚啊","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1585571087,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":204424,"ip_address":""},"score":217570,"extra":""}]},{"author":{"id":1058800,"avatar":"https://static001.geekbang.org/account/avatar/00/10/27/f0/06ecce19.jpg","nickname":"Skysper","note":"","ucode":"164B3CAF81A7C5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":179408,"discussion_content":"自增长主键会有gap lock吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582213166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1058800,"avatar":"https://static001.geekbang.org/account/avatar/00/10/27/f0/06ecce19.jpg","nickname":"Skysper","note":"","ucode":"164B3CAF81A7C5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195367,"discussion_content":"主键会有gap的lock,当主键设置为自增长插入的时候会自增锁具体需要根据innodb_autoinc_lock_model配置的不同,普通insert和批量insert select,批量insert三种情况都不同具体看老师的第40讲","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1583271533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":179408,"ip_address":""},"score":195367,"extra":""},{"author":{"id":1026090,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a8/2a/316b8f17.jpg","nickname":"毒草","note":"","ucode":"DBD67DD3517190","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293583,"discussion_content":"c=-1 也插入不了, 这位老师能帮忙解释下吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595586735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":195367,"ip_address":""},"score":293583,"extra":""}]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":79749,"discussion_content":"测试了一下：把 c 设置 成小于11的都不行，11是一个分界线把，这个是为什么呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576109585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1541014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","nickname":"天亮前说晚安","note":"","ucode":"1D82EE562A7C71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":143384,"discussion_content":"文章中的情况是需要调整三个事物的隔离级别吗？我没怎么太懂，试了也不会出现死锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579503924,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":79749,"ip_address":""},"score":143384,"extra":""},{"author":{"id":2377275,"avatar":"https://static001.geekbang.org/account/avatar/00/24/46/3b/ac4b8ab0.jpg","nickname":"Stream上的帧","note":"","ucode":"325FBEFF80BD91","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":336587,"discussion_content":"c上的数据\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608629503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":79749,"ip_address":""},"score":336587,"extra":""},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1541014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","nickname":"天亮前说晚安","note":"","ucode":"1D82EE562A7C71","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373824,"discussion_content":"都是RR隔离界别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620887545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":143384,"ip_address":""},"score":373824,"extra":""}]},{"author":{"id":1186230,"avatar":"https://static001.geekbang.org/account/avatar/00/12/19/b6/33151697.jpg","nickname":"崔文博","note":"","ucode":"8A2C56A786F016","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1496,"discussion_content":"我这边验证也是11是成功的 ，为什么，11难道不在间隙锁范围之内么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562664988,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1186230,"avatar":"https://static001.geekbang.org/account/avatar/00/12/19/b6/33151697.jpg","nickname":"崔文博","note":"","ucode":"8A2C56A786F016","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":280777,"discussion_content":"肯定不在啊，楼上大家讨论的是边界值10到底该不该锁","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1591610918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1496,"ip_address":""},"score":280777,"extra":""},{"author":{"id":2215215,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL0KHoPPP9kEd9a5P4iaNAMbfe94LH5ZBOXO7nRwz8wFXoBzon4ml3XoBCttOmI7FJ8zfXhBDYdSgg/132","nickname":"Koliday","note":"","ucode":"C5EBA6C28BAA31","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":314680,"discussion_content":"所以为啥只锁到10不锁到11呢，边界怎么定的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603185601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":280777,"ip_address":""},"score":314680,"extra":""},{"author":{"id":1447569,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/WtHCCMoLJ2DvzqQwPYZyj2RlN7eibTLMHDMTSO4xIKjfKR1Eh9L98AMkkZY7FmegWyGLahRQJ5ibPzeeFtfpeSow/132","nickname":"脱缰的野马__","note":"","ucode":"D5F993E7232C61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2215215,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL0KHoPPP9kEd9a5P4iaNAMbfe94LH5ZBOXO7nRwz8wFXoBzon4ml3XoBCttOmI7FJ8zfXhBDYdSgg/132","nickname":"Koliday","note":"","ucode":"C5EBA6C28BAA31","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323638,"discussion_content":"看了上下那么多评论，大家都不理解的是为啥c=10的这一行为什么会上锁，也就是为什么会锁(5,10]这个前开后闭next-key lock而不是(5,10)这个间隙锁，两点：1.扫描（访问）过的行都会加锁；2. c为普通索引，我们以c=5这个当条件的时候，mysql在c索引组织结构上访问的时候是会访问到第一个不满足条件的行为止，也就是10这一行（这是前面关于SQL执行流程的相关内容）。所以大家是否明白了？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1604977577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":314680,"ip_address":""},"score":323638,"extra":""}]}]},{"had_liked":false,"id":64140,"user_name":"xuery","can_delete":false,"product_type":"c1","uid":1027584,"ip_address":"","ucode":"F461B61BE06131","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ae/00/025f37e7.jpg","comment_is_top":true,"comment_ctime":1548675686,"is_pvip":true,"replies":[{"id":"23030","content":"对， innodb_locks_unsafe_for_binlog 这个参数就是这个意思 “不加gap lock”，<br><br>这个已经要被废弃了（8.0就没有了），所以不建议设置哈，容易造成误会。<br><br>如果真的要去掉gap lock，可以考虑改用RC隔离级别+binlog_format=row<br><br>","user_name":"作者回复","comment_id":64140,"uid":"1264162","ip_address":"","utype":1,"ctime":1549004821,"user_name_real":"林晓斌"}],"discussion_count":8,"race_medal":0,"score":"9.2233721801374003e+18","product_id":100020801,"comment_content":"老师之前的留言说错了，重新梳理下：<br>图8：间隙锁导致的死锁；我把innodb_locks_unsafe_for_binlog设置为1之后，session B并不会blocked，session A insert会阻塞住，但是不会提示死锁；然后session B提交执行成功，session A提示主键冲突<br><br>这个是因为将innodb_locks_unsafe_for_binlog设置为1之后，什么原因造成的？","like_count":34,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437879,"discussion_content":"对， innodb_locks_unsafe_for_binlog 这个参数就是这个意思 “不加gap lock”，\n\n这个已经要被废弃了（8.0就没有了），所以不建议设置哈，容易造成误会。\n\n如果真的要去掉gap lock，可以考虑改用RC隔离级别+binlog_format=row\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549004821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331406,"discussion_content":"希望老师看到能回复一下。\n一个表t有两个字段：a，b。它们都是int类型。初始值都是100。\n执行如下更新语句。\nupdate t set a=a-1, b=a-1;\n更新之后为什么b的值是98而不是99？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606865887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373830,"discussion_content":"更新操作是当前读，前面已经执行了a=a-1了，因此此时a的值是99了","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1620889269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":331406,"ip_address":""},"score":373830,"extra":""}]},{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300516,"discussion_content":"谁能告诉我为什么rc就要用row模式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598156286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1386818,"avatar":"https://static001.geekbang.org/account/avatar/00/15/29/42/43d4b1a8.jpg","nickname":"烫烫烫","note":"","ucode":"C06018670DE76A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":319233,"discussion_content":"本文已经说了，没有间隙锁的时候，statement的binlog重放数据不一致","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1603967644,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300516,"ip_address":""},"score":319233,"extra":""},{"author":{"id":1180979,"avatar":"https://static001.geekbang.org/account/avatar/00/12/05/33/c33c0e8a.jpg","nickname":"exception","note":"","ucode":"F35ACB5B921353","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":339290,"discussion_content":"文中已经讲解的很明白了，本篇文章多看几遍，尤其是讲解幻读可能产生的问题的那部分。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609593502,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300516,"ip_address":""},"score":339290,"extra":""},{"author":{"id":1629257,"avatar":"https://static001.geekbang.org/account/avatar/00/18/dc/49/43ae1627.jpg","nickname":"Ansyear","note":"","ucode":"489CE96852EA2C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1180979,"avatar":"https://static001.geekbang.org/account/avatar/00/12/05/33/c33c0e8a.jpg","nickname":"exception","note":"","ucode":"F35ACB5B921353","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":345677,"discussion_content":"哪里说了binlog格式了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611758845,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":339290,"ip_address":""},"score":345677,"extra":""}]}]},{"had_liked":false,"id":54885,"user_name":"杜嘉嘉","can_delete":false,"product_type":"c1","uid":1306430,"ip_address":"","ucode":"C23DE27E7886BD","user_header":"https://static001.geekbang.org/account/avatar/00/13/ef/3e/9c3a8abc.jpg","comment_is_top":false,"comment_ctime":1545976770,"is_pvip":false,"replies":[{"id":"19895","content":"精力花了没事，睡一觉醒来还是一条好汉😄<br>主要还是得大家有收获，我就值了😄","user_name":"作者回复","comment_id":54885,"uid":"1264162","ip_address":"","utype":1,"ctime":1545995007,"user_name_real":"林晓斌"}],"discussion_count":7,"race_medal":0,"score":"1006568324034","product_id":100020801,"comment_content":"说真的，这一系列文章实用性真的很强，老师非常负责，想必牵扯到老师大量精力，希望老师再出好文章，谢谢您了，辛苦了","like_count":235,"discussions":[{"author":{"id":1418968,"avatar":"https://static001.geekbang.org/account/avatar/00/15/a6/d8/bf2405c0.jpg","nickname":"Bruce_gjl","note":"","ucode":"4ACFBE14AC84E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309641,"discussion_content":"买的晚，确实现在只能看看你们的评论记录，感觉评论里的精华也不少啊","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1601375392,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434600,"discussion_content":"精力花了没事，睡一觉醒来还是一条好汉😄\n主要还是得大家有收获，我就值了😄","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1545995007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1261360,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3f/30/23f6b413.jpg","nickname":"五十九秒","note":"","ucode":"1F34F62193CFF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283566,"discussion_content":"想当面给老师点个赞，最负责任的一个","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1592298082,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1261360,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3f/30/23f6b413.jpg","nickname":"五十九秒","note":"","ucode":"1F34F62193CFF6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303806,"discussion_content":"确实，这个老师是挺负责的，要是当时上线就买了就好了，可以直接提问，现在只能翻评论看有没有我所疑惑的东西了","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1599385009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":283566,"ip_address":""},"score":303806,"extra":""},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304326,"discussion_content":"同感","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599547430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303806,"ip_address":""},"score":304326,"extra":""}]},{"author":{"id":1100928,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cc/80/898c1ed1.jpg","nickname":"sea季陪我去看海","note":"","ucode":"D0CA20E815A157","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571991,"discussion_content":"说的跟你不花钱似的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652525826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1576238,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0d/2e/a6865099.jpg","nickname":"SDZ","note":"","ucode":"3353FCAD5B52C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":384041,"discussion_content":"你看懂啥了 ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626342594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55108,"user_name":"薛畅","can_delete":false,"product_type":"c1","uid":1307437,"ip_address":"","ucode":"1B665F467169F3","user_header":"https://static001.geekbang.org/account/avatar/00/13/f3/2d/711d73b2.jpg","comment_is_top":false,"comment_ctime":1546045398,"is_pvip":false,"replies":[{"id":"19994","content":"是的，这个其实就是为啥总结规则有点麻烦，有时候只是因为代码是这么写的😓","user_name":"作者回复","comment_id":55108,"uid":"1264162","ip_address":"","utype":1,"ctime":1546046335,"user_name_real":"林晓斌"}],"discussion_count":23,"race_medal":0,"score":"349438396374","product_id":100020801,"comment_content":"可重复读隔离级别下，经试验：<br>SELECT * FROM t where c&gt;=15 and c&lt;=20 for update; 会加如下锁：<br>next-key lock:(10, 15], (15, 20]<br>gap lock:(20, 25)<br><br>SELECT * FROM t where c&gt;=15 and c&lt;=20  order by c desc for update; 会加如下锁：<br>next-key lock:(5, 10], (10, 15], (15, 20]<br>gap lock:(20, 25)<br><br>session C 被锁住的原因就是根据索引 c 逆序排序后多出的 next-key lock:(5, 10]<br><br>同时我有个疑问：加不加 next-key lock:(5, 10] 好像都不会影响到 session A 可重复读的语义，那么为什么要加这个锁呢？","like_count":82,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434676,"discussion_content":"是的，这个其实就是为啥总结规则有点麻烦，有时候只是因为代码是这么写的😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546046335,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1276373,"avatar":"https://static001.geekbang.org/account/avatar/00/13/79/d5/4a7971fc.jpg","nickname":"Ethan","note":"","ucode":"016F1DEBA895B8","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293357,"discussion_content":"SELECT * FROM t where c>=15 and c<=20 for update;  加的锁应该是：next-key lock:(10, 15], (15, 20], (20, 25] 把","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1595509303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1285652,"avatar":"","nickname":"mycat","note":"","ucode":"6878BD32D042F2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1276373,"avatar":"https://static001.geekbang.org/account/avatar/00/13/79/d5/4a7971fc.jpg","nickname":"Ethan","note":"","ucode":"016F1DEBA895B8","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":331567,"discussion_content":"我也是这么认为的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606902454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":293357,"ip_address":""},"score":331567,"extra":""},{"author":{"id":1272993,"avatar":"https://static001.geekbang.org/account/avatar/00/13/6c/a1/88fd9ea3.jpg","nickname":"孙明平","note":"","ucode":"FE9A99A62048C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1276373,"avatar":"https://static001.geekbang.org/account/avatar/00/13/79/d5/4a7971fc.jpg","nickname":"Ethan","note":"","ucode":"016F1DEBA895B8","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":360270,"discussion_content":"25>20,所以不会加25的行锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616404964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":293357,"ip_address":""},"score":360270,"extra":""},{"author":{"id":2365564,"avatar":"https://static001.geekbang.org/account/avatar/00/24/18/7c/91d6dd83.jpg","nickname":"红高粱","note":"","ucode":"0DD331C8E01A81","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1272993,"avatar":"https://static001.geekbang.org/account/avatar/00/13/6c/a1/88fd9ea3.jpg","nickname":"孙明平","note":"","ucode":"FE9A99A62048C4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377004,"discussion_content":"<= 和 < 后面的id 会锁住，<=的 后面的值还可能会锁住","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622458587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":360270,"ip_address":""},"score":377004,"extra":""}]},{"author":{"id":1987294,"avatar":"","nickname":"WisonHii","note":"","ucode":"620A820528E5E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383089,"discussion_content":"我测试了下，在没有带order by c desc的时候，是有对25的行锁加上了的。我的MySQL版本是Oracle MySQL 8.0.23.\n根据如下测试结果，此时会加上对行c=15，c=20加X锁以及(10,15)，(15,20),(20,25]的区间锁，总的下来就会是(10,15],(15,20],(20,25]加锁。\n\nSession A执行的脚本为：\nbegin;\nselect * from t where c>=15 and c<=20 for update;\n\n在Session B中依次测试：\n###<=10的区间，如下脚本都可以正常执行，证明未向(-∞,10]加锁\nmysql> update t set d=100 where c=10;\nQuery OK, 1 row affected (0.00 sec)\nRows matched: 1  Changed: 1  Warnings: 0\nmysql> insert into t select 9,9,9;\nQuery OK, 1 row affected (0.00 sec)\nRecords: 1  Duplicates: 0  Warnings: 0\n###(10,15]的区间,如下脚本被阻塞，证实有向区间(10,15]加了锁\nmysql> insert into t select 11,11,11;\n^C^C -- query aborted\nERROR 1317 (70100): Query execution was interrupted\nERROR 1317 (70100): Query execution was interrupted\nmysql> update t set d=15 where c=15;\n^C^C -- query aborted\nERROR 1317 (70100): Query execution was interrupted\n###(15,20]的区间，如下脚本被阻塞，证实有向区间(15,20]加了锁\nmysql> insert into t select 16,16,16;\n^C^C -- query aborted\nERROR 1317 (70100): Query execution was interrupted\nmysql> update t set d=20 where c=20;\n^C^C -- query aborted\nERROR 1317 (70100): Query execution was interrupted\n###区间(20,25],如下脚本被阻塞，证实有向区间(20,25]加了锁\nmysql> insert into t select 22,22,22;\n^C^C -- query aborted\nERROR 1317 (70100): Query execution was interrupted\nmysql> update t set d=2500 where c=25;\n^C^C -- query aborted\nERROR 1317 (70100): Query execution was interrupted\n###区间(25,+∞)，如下脚本可以执行，证实未向该区间加锁\nmysql> insert into t select 26,26,26;\nQuery OK, 1 row affected (0.01 sec)\nRecords: 1  Duplicates: 0  Warnings: 0","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1625900025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":403980,"discussion_content":"在 8.0.16 版本上测试了。   select * from t where c >= 15 and c <= 20 order by c desc for update 并没有加(5,10]  这个next-key lock。   ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634203360,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2177756,"avatar":"https://static001.geekbang.org/account/avatar/00/21/3a/dc/8a8a52b2.jpg","nickname":"蒋亭亭","note":"","ucode":"66B4B473CB6DCB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329405,"discussion_content":"为什么最后的25没有加锁呢？按理说是范围查询，不会排除25的行锁","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606380614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120761,"avatar":"https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg","nickname":"Ken","note":"","ucode":"9F829156E855C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288092,"discussion_content":"这个5的间距是固定的？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1593650975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1325297,"avatar":"https://static001.geekbang.org/account/avatar/00/14/38/f1/996a070d.jpg","nickname":"LW","note":"","ucode":"89820332658E98","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1120761,"avatar":"https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg","nickname":"Ken","note":"","ucode":"9F829156E855C8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296396,"discussion_content":"那是因为表里面的数据就是那样的","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1596531883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":288092,"ip_address":""},"score":296396,"extra":""},{"author":{"id":1120761,"avatar":"https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg","nickname":"Ken","note":"","ucode":"9F829156E855C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1325297,"avatar":"https://static001.geekbang.org/account/avatar/00/14/38/f1/996a070d.jpg","nickname":"LW","note":"","ucode":"89820332658E98","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296797,"discussion_content":"嗯，后来发现了。谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596666551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":296396,"ip_address":""},"score":296797,"extra":""}]},{"author":{"id":1295609,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJRFRX8kNzNet7FibNvtavbVpAwK09AhIhrib9k762qWtH6mre8ickP7hM5mgZC4ytr8NnmIfmAhxMSQ/132","nickname":"老大不小","note":"","ucode":"35BCDD3CB13467","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586718,"discussion_content":"为啥间隙锁是（20，25），范围不是[15,20]吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662457585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2805095,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/cd/67/8e8e65ce.jpg","nickname":"安之若素","note":"","ucode":"3B407E50680740","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572147,"discussion_content":"我的理解是扫描到=10的一行数据了，代码层面应该是扫描到就加next-key lock","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652620769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":285638,"discussion_content":"我这边试的结果是sessionB锁住了，sessionC正常执行，没有被锁住。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592900884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2365564,"avatar":"https://static001.geekbang.org/account/avatar/00/24/18/7c/91d6dd83.jpg","nickname":"红高粱","note":"","ucode":"0DD331C8E01A81","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377002,"discussion_content":"锁住了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622457406,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":285638,"ip_address":""},"score":377002,"extra":""}]},{"author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283235,"discussion_content":"为什么逆序排序就会多一个(5, 10]？老师下一遍也没讲这个规则","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592217772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1903708,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0c/5c/b03b2cc1.jpg","nickname":"Geek_db6a4b","note":"","ucode":"E5992D1CF088C4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290488,"discussion_content":"因为c为非唯一索引，扫到15后会继续扫到10，给10加上临建锁（5，10]","likes_number":15,"is_delete":false,"is_hidden":false,"ctime":1594493698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":283235,"ip_address":""},"score":290488,"extra":""},{"author":{"id":1721278,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLAhj2fB8NI2TPI1SNicgiciczuMUHyAb9HHBkkKJHrgtR162fsicaTqdAneHfuVX7icDXaVibDHstM9L47g/132","nickname":"Geek_0c1732","note":"","ucode":"6276D0412CCE51","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337322,"discussion_content":"因为加锁的基本单位是间隙锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608874543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":283235,"ip_address":""},"score":337322,"extra":""},{"author":{"id":1198256,"avatar":"https://static001.geekbang.org/account/avatar/00/12/48/b0/641be1c8.jpg","nickname":"自由de单车","note":"","ucode":"A15CA3DA749B76","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1903708,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0c/5c/b03b2cc1.jpg","nickname":"Geek_db6a4b","note":"","ucode":"E5992D1CF088C4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376376,"discussion_content":"为什么给10加的是next-key-lock  (5,10]，但给20加的却是gap-lock  (20,25)？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1622101307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":290488,"ip_address":""},"score":376376,"extra":""}]},{"author":{"id":1246139,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/bb/c5f139cc.jpg","nickname":"Ethan","note":"","ucode":"ED197A378EE91B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7523,"discussion_content":"请问为什么gap lock怎么算的，有点不明白","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567538459,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1959424,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/e6/00/1c08543c.jpg","nickname":"夏祭。","note":"","ucode":"8B37FB6697FF48","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1246139,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/bb/c5f139cc.jpg","nickname":"Ethan","note":"","ucode":"ED197A378EE91B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":257770,"discussion_content":"根据前后的数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588603719,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":7523,"ip_address":""},"score":257770,"extra":""}]}]},{"had_liked":false,"id":56567,"user_name":"Mr.Strive.Z.H.L","can_delete":false,"product_type":"c1","uid":1030198,"ip_address":"","ucode":"6D97E159E2EECD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg","comment_is_top":false,"comment_ctime":1546493795,"is_pvip":false,"replies":[{"id":"20398","content":"是的，update、delete语句用不上索引是很恐怖的😄","user_name":"作者回复","comment_id":56567,"uid":"1264162","ip_address":"","utype":1,"ctime":1546498441,"user_name_real":"林晓斌"}],"discussion_count":9,"race_medal":0,"score":"285014335331","product_id":100020801,"comment_content":"看了@令狐少侠 提出的问题，对锁有了新的认识：<br>对于非索引字段进行update或select .. for update操作，代价极高。所有记录上锁，以及所有间隔的锁。<br>对于索引字段进行上述操作，代价一般。只有索引字段本身和附近的间隔会被加锁。<br><br>这次终于明白，为什么说update语句的代价高！","like_count":67,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435121,"discussion_content":"是的，update、delete语句用不上索引是很恐怖的😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546498441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2566445,"avatar":"https://static001.geekbang.org/account/avatar/00/27/29/2d/39637017.jpg","nickname":"烟火","note":"","ucode":"2CE0BBFD5E6AC6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376640,"discussion_content":"哇。学习了三遍才意识到非索引字段，是全表加锁","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1622249050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1691516,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cf/7c/2e99d0ad.jpg","nickname":"一新","note":"","ucode":"1915C6C655C31F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":276980,"discussion_content":"想起以前写的代码 集思恐密","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1590978020,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1318914,"avatar":"https://static001.geekbang.org/account/avatar/00/14/20/02/df2bfda9.jpg","nickname":"公共号","note":"","ucode":"4759B517D4CD5E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":216854,"discussion_content":"如果对非索引字段进行更新，其实是在所有记录上添加的写锁吧？那么为什么记录还是可以读的呢？读写锁不是互斥的嘛？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585489509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":2122601,"avatar":"https://static001.geekbang.org/account/avatar/00/20/63/69/e16ed359.jpg","nickname":"木有梦想","note":"","ucode":"6366D107BBA553","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1318914,"avatar":"https://static001.geekbang.org/account/avatar/00/14/20/02/df2bfda9.jpg","nickname":"公共号","note":"","ucode":"4759B517D4CD5E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309378,"discussion_content":"Mvcc实现了读写不互斥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601276256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":216854,"ip_address":""},"score":309378,"extra":""},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1318914,"avatar":"https://static001.geekbang.org/account/avatar/00/14/20/02/df2bfda9.jpg","nickname":"公共号","note":"","ucode":"4759B517D4CD5E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375704,"discussion_content":"你说的是普通读，普通读是通过MVCC实现。如果是当前读，就需要阻塞等待了，严格来说创建一个锁结构并进入等待状态。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1621824110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":216854,"ip_address":""},"score":375704,"extra":""},{"author":{"id":1622022,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJia6zEsh2u119zJicmq7wApvnricZEKiawaZicice1cOzujWdFicFwPtavlHiaVpCNgCpxBtdl7ynd3y0wkQ/132","nickname":"james_xu","note":"","ucode":"12E50291F5BA89","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1318914,"avatar":"https://static001.geekbang.org/account/avatar/00/14/20/02/df2bfda9.jpg","nickname":"公共号","note":"","ucode":"4759B517D4CD5E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381952,"discussion_content":"MySQL通过MVCC实现了普通的读不用加读锁，select * from t for share才会加读锁。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1625316881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":216854,"ip_address":""},"score":381952,"extra":""}]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162228,"discussion_content":"那要是这么说的话，实际开发中，基本是获取一条完整记录，然后update整条记录的。那岂不是难以想象。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580975422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195368,"discussion_content":"根据查询条件加锁的,平时你大部分都是根据主键索引或者唯一索引来更新","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1583271859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":162228,"ip_address":""},"score":195368,"extra":""}]}]},{"had_liked":false,"id":54935,"user_name":"沉浮","can_delete":false,"product_type":"c1","uid":1310165,"ip_address":"","ucode":"7F6D52DA51E309","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/d5/0194ea41.jpg","comment_is_top":false,"comment_ctime":1545984383,"is_pvip":false,"replies":[{"id":"19879","content":"优秀","user_name":"作者回复","comment_id":54935,"uid":"1264162","ip_address":"","utype":1,"ctime":1545988477,"user_name_real":"林晓斌"}],"discussion_count":5,"race_medal":0,"score":"276423891327","product_id":100020801,"comment_content":"通过打印锁日志帮助理解问题<br>锁信息见括号里的说明。<br><br>TABLE LOCK table `guo_test`.`t` trx id 105275 lock mode IX<br>RECORD LOCKS space id 31 page no 4 n bits 80 index c of table `guo_test`.`t` trx id 105275 lock_mode X<br>Record lock, heap no 4 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 \t\t\t\t\t\t\t\t\t\t\t\t----(Next-Key Lock，索引锁c（5，10])<br> 0: len 4; hex 8000000a; asc     ;;<br> 1: len 4; hex 8000000a; asc     ;;<br><br>Record lock, heap no 5 PHYSICAL RECORD: n_fields 2; compact format; info bits 0\t \t\t\t\t\t\t\t\t\t\t     \t----(Next-Key Lock，索引锁c (10,15])\t<br> 0: len 4; hex 8000000f; asc     ;;<br> 1: len 4; hex 8000000f; asc     ;;<br><br>Record lock, heap no 6 PHYSICAL RECORD: n_fields 2; compact format; info bits 0      \t\t\t\t\t\t\t\t\t\t\t----(Next-Key Lock，索引锁c (15,20])\t<br> 0: len 4; hex 80000014; asc     ;;<br> 1: len 4; hex 80000014; asc     ;;<br><br>Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0             \t\t\t\t\t\t\t\t\t----(Next-Key Lock，索引锁c (20,25])\t<br> 0: len 4; hex 80000019; asc     ;;<br> 1: len 4; hex 80000019; asc     ;;<br><br>RECORD LOCKS space id 31 page no 3 n bits 80 index PRIMARY of table `guo_test`.`t` trx id 105275 lock_mode X locks rec but not gap<br>Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0  <br>----(记录锁 锁c=15对应的主键）<br> 0: len 4; hex 8000000f; asc     ;;<br> 1: len 6; hex 0000000199e3; asc       ;;<br> 2: len 7; hex ca000001470134; asc     G 4;;<br> 3: len 4; hex 8000000f; asc     ;;<br> 4: len 4; hex 8000000f; asc     ;;<br><br>Record lock, heap no 6 PHYSICAL RECORD: n_fields 5; compact format; info bits 0<br> 0: len 4; hex 80000014; asc     ;;<br>----(记录锁 锁c=20对应的主键）<br> 1: len 6; hex 0000000199e3; asc       ;;<br> 2: len 7; hex ca000001470140; asc     G @;;<br> 3: len 4; hex 80000014; asc     ;;<br> 4: len 4; hex 80000014; asc     ;;<br>由于字数限制，正序及无排序的日志无法帖出，倒序日志比这两者，多了范围(Next-Key Lock，索引锁c（5，10])，个人理解是，加锁分两次，第一次，即正序的锁，第二次为倒序的锁，即多出的(5,10],在RR隔离级别，<br>innodb在加锁的过程中会默认向后锁一个记录，加上Next-Key Lock,第一次加锁的时候10已经在范围，由于倒序，向后，即向5再加Next-key Lock,即多出的(5,10]范围","like_count":65,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434619,"discussion_content":"优秀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545988477,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1673409,"avatar":"https://static001.geekbang.org/account/avatar/00/19/88/c1/d0136c63.jpg","nickname":"甜公子Timmy","note":"","ucode":"E6E90C518CDAC2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":260917,"discussion_content":"请问怎么开启的锁日志，是指死锁日志么","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588912971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1135537,"avatar":"https://static001.geekbang.org/account/avatar/00/11/53/b1/3d6075cc.jpg","nickname":"王建","note":"","ucode":"2289B282E18826","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1673409,"avatar":"https://static001.geekbang.org/account/avatar/00/19/88/c1/d0136c63.jpg","nickname":"甜公子Timmy","note":"","ucode":"E6E90C518CDAC2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298969,"discussion_content":"设置参数：set global innodb_status_output_locks=1;\n然后使用show engine innodb status\\G 查看，TRANSACTIONS 相关的信息下，就能看到锁信息。","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1597494107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":260917,"ip_address":""},"score":298969,"extra":""}]},{"author":{"id":1194853,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3b/65/3a4fc8cf.jpg","nickname":"prepared","note":"","ucode":"00E54A5C7CDCBE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337310,"discussion_content":"怎么看出来是next-key-lock还是间隙锁，行锁的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608867932,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1194853,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3b/65/3a4fc8cf.jpg","nickname":"prepared","note":"","ucode":"00E54A5C7CDCBE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381781,"discussion_content":"信息里面有锁的模式，例如lock_mode X locks rec but not gap，就是记录锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625209579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":337310,"ip_address":""},"score":381781,"extra":""}]}]},{"had_liked":false,"id":74599,"user_name":"kabuka","can_delete":false,"product_type":"c1","uid":1246009,"ip_address":"","ucode":"932DD1E875D850","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/39/18956b2e.jpg","comment_is_top":false,"comment_ctime":1552265170,"is_pvip":false,"replies":[{"id":"28802","content":"因为d上没有索引，这个语句要走全表扫描","user_name":"作者回复","comment_id":74599,"uid":"1264162","ip_address":"","utype":1,"ctime":1553339852,"user_name_real":"林晓斌"}],"discussion_count":10,"race_medal":0,"score":"212005662674","product_id":100020801,"comment_content":"这样，当你执行 select * from t where  d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 还同时加了 7 个间隙锁<br>---------------------------------------------------------------<br>老師這句話沒看太明白，數據庫只有一條d=5的記錄，為什麼會給6個記錄加上行鎖呢？<br><br> ","like_count":50,"discussions":[{"author":{"id":1275980,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoicSMibHxGmeNXCLAnB6S7icPh814icIsw7VZ5vYzLOyKKUJYmFC5WGPekH5qI7rRbH3n4Y2obiaKlBTQ/132","nickname":"konh","note":"","ucode":"1CAD0D67067CC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315680,"discussion_content":"1.没有索引，主键索引扫描所有行，找到满足d=5的行。同时给所有行加上行锁+间隙锁，防止binlog 数据不一致\n2.有索引，扫描到的行加行锁+间隙锁，参考@薛畅的回答\n区别就是加锁范围不一样。\n\n加表锁，如果是 lock table read，别的事务还能查；如果是 lock table write 则别的事务的读写都堵塞。\n行锁+间隙锁合称 next-key lock。例如(5,10]，间隙锁 (5,10) 区间是不能插入数据，防止幻读。行锁 [10] 可以加读锁，也可以加写锁。多个事务对 [10] 可以并发操作的，因为RR有MVCC保证。\n\n\n","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1603306004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1050411,"avatar":"https://static001.geekbang.org/account/avatar/00/10/07/2b/d111e75d.jpg","nickname":"Lion","note":"","ucode":"21AA6AE4A90789","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1275980,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoicSMibHxGmeNXCLAnB6S7icPh814icIsw7VZ5vYzLOyKKUJYmFC5WGPekH5qI7rRbH3n4Y2obiaKlBTQ/132","nickname":"konh","note":"","ucode":"1CAD0D67067CC1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387422,"discussion_content":"m","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628160099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":315680,"ip_address":""},"score":387422,"extra":""}]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442611,"discussion_content":"因为d上没有索引，这个语句要走全表扫描","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1553339852,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2325111,"avatar":"https://static001.geekbang.org/account/avatar/00/23/7a/77/bb17e879.jpg","nickname":"往事,优雅而已","note":"","ucode":"737776381821F7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":544561,"discussion_content":"为什么我这通过 select * from sys.innodb_lock_waits where locked_table=&#39;&#39;的方式， waiting_lock_mode: X,REC_NOT_GAP返回的是这个，是lock record not gap lock。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1641565676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":442611,"ip_address":""},"score":544561,"extra":""}]},{"author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303809,"discussion_content":"林老师你好！\n这和全表扫描有啥关系呢？全部加锁不就是为了防止数据更新导致的binlog记录的数据和实际不一致的情况吗？而且有数据插入的时候，全部加行锁也不能解决这个问题，所以引入了间隙锁。那么，表中全部行和间隙都加锁，为何不直接使用表锁来做呢？换句话说，这个行锁+间隙锁 和 表锁比起来有哪些优势呢？请老师不吝赐教，十分感谢������","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599386320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1268537,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5b/39/75cbd410.jpg","nickname":"Vince_cheng","note":"","ucode":"9292C0FA3C2F8F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305050,"discussion_content":"我的理解，行锁是针对事务，间隙锁是针对插入数据，防止幻读。如果是表锁，那不影响事务的更新删除操作不就被锁住了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599750023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303809,"ip_address":""},"score":305050,"extra":""},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381782,"discussion_content":"所以为什么让你在执行SQL的时候看下计划任务，尽量用索引啊，这个全表加锁只是为了说明next-key lock、幻读的问题。行锁比表锁的优势很明显并发问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625209927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303809,"ip_address":""},"score":381782,"extra":""}]},{"author":{"id":1272026,"avatar":"https://static001.geekbang.org/account/avatar/00/13/68/da/5bcb83b1.jpg","nickname":"白晨","note":"","ucode":"6D6171B8ECEDDD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583659,"discussion_content":"全表扫描不是说变成表锁，而是对聚簇索引加锁了，还是行锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660277481,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327611,"discussion_content":"没理解为什么是7个不是6个间隙锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605873918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2369545,"avatar":"https://static001.geekbang.org/account/avatar/00/24/28/09/0ac42cff.jpg","nickname":"慕苏","note":"","ucode":"7ED14D00429C21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337103,"discussion_content":"间隙前后各有一个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608797868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":327611,"ip_address":""},"score":337103,"extra":""}]}]},{"had_liked":false,"id":119511,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1564620770,"is_pvip":false,"discussion_count":10,"race_medal":0,"score":"194838149090","product_id":100020801,"comment_content":"课前思考<br>1：幻读是什么？幻读有什么问题？如何避免？<br>幻读我的理解是，读出的数据出现了不一致的现象，在事务的读未提交和读已提交这两种事务的隔离级别下会出现幻读的现象，问题嘛？就是数据不一致了，对于数据严格要求一致的场景是不能够允许的。如何避免？在可重复读和串行化的事务隔离级别下应该不会出现<br>课后思考<br>1：学完此节后发现自己的认知，基本是错的<br>1-1：什么是幻读？<br>幻读是指在同一个事务中，存在前后两次查询同一个范围的数据，但是第二次查询却看到了第一次查询没看到的行。<br>注意，幻读出现的场景<br>第一：事务的隔离级别为可重复读，且是当前读<br>第二：幻读仅专指新插入的行<br>1-2：幻读带来的问题？<br>一是，对行锁语义的破坏<br>二是，破坏了数据一致性<br>1-3：怎么避免幻读？<br>存储引擎采用加间隙锁的方式来避免出现幻读<br>1-4：为啥会出现幻读？<br>行锁只能锁定存在的行，针对新插入的操作没有限定<br>1-5：间隙锁是啥？它怎么避免出现幻读的？它引入了什么新的问题？<br>间隙锁，是专门用于解决幻读这种问题的锁，它锁的了行与行之间的间隙，能够阻塞新插入的操作<br>间隙锁的引入也带来了一些新的问题，比如：降低并发度，可能导致死锁。<br>注意，读读不互斥，读写&#47;写读&#47;写写是互斥的，但是间隙锁之间是不冲突的，间隙锁会阻塞插入操作<br>另外，间隙锁在可重复读级别下才是有效的<br>感谢老师的分享，意料之外的认知很好玩，也纠正了自己的认知偏差。<br>感觉自己明白了，看完评论，感觉自己啥都不懂。","like_count":45,"discussions":[{"author":{"id":2034669,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/0b/ed/4969d2f8.jpg","nickname":"柯南爱上指针","note":"","ucode":"5BF7E8AC28F9CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292377,"discussion_content":"之前理解的可重复读隔离级别是不能解决幻读的，只有在串行化隔离级别下才能解决幻读，发现一直理解就错了。。。。。","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1595209712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":3007210,"avatar":"","nickname":"Geek_a1699c","note":"","ucode":"CF7DB00BE36B77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2034669,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/0b/ed/4969d2f8.jpg","nickname":"柯南爱上指针","note":"","ucode":"5BF7E8AC28F9CF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576231,"discussion_content":"懵了，所以到底解决幻读没有，之前我的八股文都白背了呀","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1655363666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":292377,"ip_address":""},"score":576231,"extra":""},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3007210,"avatar":"","nickname":"Geek_a1699c","note":"","ucode":"CF7DB00BE36B77","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587667,"discussion_content":"可以解决，但是要自己结合业务场景加对应的间隙锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663213011,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":576231,"ip_address":"广东"},"score":587667,"extra":""},{"author":{"id":2542376,"avatar":"https://static001.geekbang.org/account/avatar/00/26/cb/28/21a8a29e.jpg","nickname":"夏天","note":"","ucode":"5F224DDAC94DFF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589909,"discussion_content":"这么说是准确的，“可以解决”，但是要靠自己加 gap lock。但说 RR 本身是没解决幻读的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665391846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":587667,"ip_address":"广东"},"score":589909,"extra":""}]},{"author":{"id":1669182,"avatar":"https://static001.geekbang.org/account/avatar/00/19/78/3e/84b18502.jpg","nickname":"最好的狗焕啊","note":"","ucode":"6F77A37326618F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":23475,"discussion_content":"深有体会，看完评论感觉啥也不懂，然后再看一遍，再看一遍。。。","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1569824130,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1611462,"avatar":"https://static001.geekbang.org/account/avatar/00/18/96/c6/5ae62afe.jpg","nickname":"Change","note":"","ucode":"C65BB004EEAF2B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299525,"discussion_content":"我感觉你还是没有理解到位，想想老师为了对幻读说专指&#34;新插入的行&#34;，为什么这里要用双引号？这个新插入的行是指另外一个事务insert的吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597722257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1142539,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6f/0b/06480912.jpg","nickname":"清风","note":"","ucode":"ED1B6DECC3A102","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555435,"discussion_content":"rr模式下解决了部分的幻读，完全解决还需要串行化","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646901875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327615,"discussion_content":"幻读这块还是没理解到位呀同学，只有串行化才能解决。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605874653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373840,"discussion_content":"RR隔离级别下的当前读通过gap lock已经解决了幻读的问题了，不需要到串行化，这篇文章不就是说的这个呢","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1620891620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":327615,"ip_address":""},"score":373840,"extra":""},{"author":{"id":2497728,"avatar":"https://static001.geekbang.org/account/avatar/00/26/1c/c0/b8ff566a.jpg","nickname":"我是大橙子132","note":"","ucode":"61660568CF07C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565626,"discussion_content":"正常可重复读的隔离级别会有幻读问题，但InnoDB引擎通过间隙锁在这个级别就解决了幻读问题，看你从什么角度学习看待了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1650505361,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":327615,"ip_address":""},"score":565626,"extra":""}]}]},{"had_liked":false,"id":54878,"user_name":"郭江伟","can_delete":false,"product_type":"c1","uid":1313994,"ip_address":"","ucode":"613D638619B5A2","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/ca/6173350b.jpg","comment_is_top":false,"comment_ctime":1545975493,"is_pvip":false,"replies":[{"id":"19897","content":"感觉你下一篇看起来会很轻松了哈👍🏿","user_name":"作者回复","comment_id":54878,"uid":"1264162","ip_address":"","utype":1,"ctime":1545995092,"user_name_real":"林晓斌"}],"discussion_count":9,"race_medal":0,"score":"173344667333","product_id":100020801,"comment_content":"insert into t values(0,0,0),(5,5,5),<br>(10,10,10),(15,15,15),(20,20,20),(25,25,25);<br>运行mysql&gt; begin;<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; select * from t where c&gt;=15 and c&lt;=20 order by c desc for update;<br>c 索引会在最右侧包含主键值，c索引的值为(0,0) (5,5) (10,10) (15,15) (20,20) (25,25)<br>此时c索引上锁的范围其实还要匹配主键值 。<br>思考题答案是，上限会扫到c索引(20,20) 上一个键，为了防止c为20 主键值小于25 的行插入，需要锁定(20,20) (25,25) 两者的间隙；开启另一会话(26,25,25)可以插入，而(24,25,25)会被堵塞。<br>下限会扫描到(15,15)的下一个键也就是(10,10),测试语句会继续扫描一个键就是(5,5) ，此时会锁定，(5,5) 到(15,15)的间隙，由于id是主键不可重复所以下限也是闭区间；<br>在本例的测试数据中添加(21,25,25)后就可以正常插入(24,25,25)","like_count":41,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434596,"discussion_content":"感觉你下一篇看起来会很轻松了哈👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545995092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1112638,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/3e/92d74b38.jpg","nickname":"Attract","note":"","ucode":"DEB10AF9AB5A41","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383482,"discussion_content":"【下限会扫描到(15,15)的下一个键也就是(10,10),测试语句会继续扫描一个键就是(5,5) 】这里有疑问，为啥到了 (10，10)之后还会往下扫呢，这已经是不满足的第一条了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1626109327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2613578,"avatar":"","nickname":"Geek_9189c6","note":"","ucode":"DFF8E517A5A843","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1112638,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/3e/92d74b38.jpg","nickname":"Attract","note":"","ucode":"DEB10AF9AB5A41","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388461,"discussion_content":"大佬看懂了吗 ，可以解释下不，我也没看懂这个地方","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628771978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":383482,"ip_address":""},"score":388461,"extra":""}]},{"author":{"id":1063308,"avatar":"https://static001.geekbang.org/account/avatar/00/10/39/8c/089525aa.jpg","nickname":"小乙哥","note":"","ucode":"C77E79BEA0C325","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":402268,"discussion_content":"我看了下一篇，才看懂这个回答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633850456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2355521,"avatar":"https://static001.geekbang.org/account/avatar/00/23/f1/41/76c0758f.jpg","nickname":"君战","note":"","ucode":"A8619A79A5CED9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350244,"discussion_content":"测试并没有锁主键(20,20)，(25,25)，而是锁的c锁索引上的(20,20)，(25,25)。插入(24,26,26)成功，但插入(23,25,26)失败。(11,1,26)也可以插入成功。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613783726,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1178135,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fa/17/d0b8135f.jpg","nickname":"灰色","note":"","ucode":"869B400BBD520D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334308,"discussion_content":"那是不是说，幻读的现象，还是会出现？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607818024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210265,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","nickname":"奔奔奔跑","note":"","ucode":"F86EC205DCAACE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273032,"discussion_content":"为什么扫到（10，10）还会继续往下扫","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590396940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1229722,"avatar":"https://static001.geekbang.org/account/avatar/00/12/c3/9a/97dfbe96.jpg","nickname":"小辰辰","note":"","ucode":"963D4E3BDA328F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1210265,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Gswh7ibY4tubXhp0BXOmV2pXZ3XsXic1d942ZMAEgWrRSF99bDskOTsG1g172ibORXxSCWTn9HWUX5vSSUVWU5I4A/132","nickname":"奔奔奔跑","note":"","ucode":"F86EC205DCAACE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":280347,"discussion_content":"个人理解，10属于(5,10]的间隙锁，所以锁到这个区域","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1591530393,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":273032,"ip_address":""},"score":280347,"extra":""}]},{"author":{"id":1810609,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a0/b1/720a7688.jpg","nickname":"海的北风","note":"","ucode":"06F91AC99970EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":239192,"discussion_content":"可以详细讲下吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587283453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54712,"user_name":"慧鑫coming","can_delete":false,"product_type":"c1","uid":1324385,"ip_address":"","ucode":"7BAC9CA255630E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLE4LYb3jrH63ZV98Zpc8DompwDgb1O3nffMoZCmiaibauRyEFv6NDNsST9RWxZExvMLMWb50zaanoQ/132","comment_is_top":false,"comment_ctime":1545956646,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"130394975526","product_id":100020801,"comment_content":"这篇需要多读几遍，again","like_count":31},{"had_liked":false,"id":55833,"user_name":"发条橙子 。","can_delete":false,"product_type":"c1","uid":1259218,"ip_address":"","ucode":"ED076F4534FFED","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg","comment_is_top":false,"comment_ctime":1546320688,"is_pvip":false,"replies":[{"id":"20113","content":"其实读提交隔离级别下看到的，严格来说不算。<br>因为这个就是读提交隔离级别下“设计内”的问题😄<br><br>这种感觉就是，对于读提交隔离级别，这个算“feature”,（是不是恨熟悉）<br>对于可重复读，这个是”bug”, 所以要解决，称呼这个bug为幻读😄","user_name":"作者回复","comment_id":55833,"uid":"1264162","ip_address":"","utype":1,"ctime":1546333686,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"108920503088","product_id":100020801,"comment_content":"老师 ， 看到幻读的定义是 ： 幻读是一个事物在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行 。 <br><br>那么我感觉<br>1. 读提交事务隔离级别 <br>2.可重复读事务隔离级别的当前读 <br>这两个都符合这个定义 。 那是不是说 在 1 、 2 条件下都会发生幻读 。<br><br>但是我看一些文章都说幻读是rr级别下的 ，  rc 是不可重复读 。请问是我理解有误还是文章写的不准确","like_count":26,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434854,"discussion_content":"其实读提交隔离级别下看到的，严格来说不算。\n因为这个就是读提交隔离级别下“设计内”的问题😄\n\n这种感觉就是，对于读提交隔离级别，这个算“feature”,（是不是恨熟悉）\n对于可重复读，这个是”bug”, 所以要解决，称呼这个bug为幻读😄","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1546333686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3007210,"avatar":"","nickname":"Geek_a1699c","note":"","ucode":"CF7DB00BE36B77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576234,"discussion_content":"对于可重复读，这个是”bug”, 所以要解决，称呼这个bug为幻读\n\n这个观点和文章中的意思没有匹配吧，文章的意思RR已经解决了幻读的问题？，这里又说是一个BUG，我已经懵懵的了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655364007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1149406,"avatar":"https://static001.geekbang.org/account/avatar/00/11/89/de/ba9f36c6.jpg","nickname":"shawly","note":"","ucode":"FB5E2DB6A78E60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544776,"discussion_content":"解惑了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641707343,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327616,"discussion_content":"还有这种操作-。-","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605874831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57300,"user_name":"hetiu","can_delete":false,"product_type":"c1","uid":1056127,"ip_address":"","ucode":"35D9338C3ABD20","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/7f/aabc1b66.jpg","comment_is_top":false,"comment_ctime":1546738294,"is_pvip":false,"replies":[{"id":"20665","content":"好问题，innodb_auroinc_lock_mode设置为2，binlog_formate设置成row就行，没有表锁问题","user_name":"作者回复","comment_id":57300,"uid":"1264162","ip_address":"","utype":1,"ctime":1546746157,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"78856149622","product_id":100020801,"comment_content":"mysql官方提到自增锁是个表级锁，老师能介绍下这个吗，以及实际项目中高并发insert是否需要避免自增主键？","like_count":18,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435512,"discussion_content":"好问题，innodb_auroinc_lock_mode设置为2，binlog_formate设置成row就行，没有表锁问题","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1546746157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2171678,"avatar":"https://static001.geekbang.org/account/avatar/00/21/23/1e/cc62c8a8.jpg","nickname":"大桃子又好吃","note":"","ucode":"C84EBAB4B1DF15","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306938,"discussion_content":"https://dev.mysql.com/doc/refman/5.7/en/innodb-auto-increment-handling.html\n文档上有讲","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600422313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1299572,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJf3aXIOYKbJq6WicnrPMgm5CpXVBuaWS6UibLUia4ib3QAeUrXvtYdYUfOkaJnics5ME6HlNdic92Ap1hA/132","nickname":"looper","note":"","ucode":"BF60C93A515DAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383135,"discussion_content":"知识盲区 mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625922901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1249616,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/wiaQmkQdIh84RibSLrDkIA3HtibAR4IibpnP3VEmiaLzvpiaibXJQEb2LLUrCD4dM7DjvOFD65IbdZm2Mn68O71FxiaAow/132","nickname":"超级蛋蛋饭","note":"","ucode":"AD2BECE789B365","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360220,"discussion_content":"innodb_autoinc_lock_mode、binlog_format","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616393301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":80087,"user_name":"卡卡","can_delete":false,"product_type":"c1","uid":1335145,"ip_address":"","ucode":"344B1A4FE10596","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIlSe5wRWM6Eoht0iapFo75JTOlwKkDlOzdRicg6kAvMVTUHogkE0Byicxu2GiceNTdm9ahYja0dnAhDQ/132","comment_is_top":false,"comment_ctime":1553603613,"is_pvip":false,"replies":[{"id":"29654","content":"next-key lock = gap lock + record lock<br>间隙锁是一种锁的类型<br>排他是一种锁的行为<br>","user_name":"作者回复","comment_id":80087,"uid":"1264162","ip_address":"","utype":1,"ctime":1554052390,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"61683145757","product_id":100020801,"comment_content":"间歇锁 和 排他锁有关系吗？","like_count":14,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444745,"discussion_content":"next-key lock = gap lock + record lock\n间隙锁是一种锁的类型\n排他是一种锁的行为\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554052390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164050,"user_name":"凡凡是谁爹","can_delete":false,"product_type":"c1","uid":1762093,"ip_address":"","ucode":"FC902F6A76B7CC","user_header":"https://static001.geekbang.org/account/avatar/00/1a/e3/2d/0f8ee254.jpg","comment_is_top":false,"comment_ctime":1576850644,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"57411425492","product_id":100020801,"comment_content":"老师，你有点没详细讲<br>1、那其实不是记录锁和间隙锁的冲突，是意向插入锁和间隙锁的冲突。<br>2、你没有讲什么条件下会gap锁，gap锁是非唯一索引下会加的","like_count":13,"discussions":[{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577789,"discussion_content":"没有索引不加间隙锁?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656334827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1253652,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","nickname":"Steven","note":"","ucode":"3FE64459842015","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568682,"discussion_content":"Gap locking is not needed for statements that lock rows using a unique index to search for a unique row. (This does not include the case that the search condition includes only some columns of a multiple-column unique index; in that case, gap locking does occur.) ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651197416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1407983,"avatar":"https://static001.geekbang.org/account/avatar/00/15/7b/ef/ae5458c7.jpg","nickname":"王骞","note":"","ucode":"E5A88F3BA2634E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":345962,"discussion_content":"表t(id, val)，有值(1, 10)和(3, 20)，语句select * from t where id=2 for update，虽然id是唯一索引，但是一样会加gap锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611823961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1407983,"avatar":"https://static001.geekbang.org/account/avatar/00/15/7b/ef/ae5458c7.jpg","nickname":"王骞","note":"","ucode":"E5A88F3BA2634E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373844,"discussion_content":"会退化成行锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620892586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":345962,"ip_address":""},"score":373844,"extra":""},{"author":{"id":1926122,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/63/ea/1a128e67.jpg","nickname":"来需求了，很忙","note":"","ucode":"B77D1846FC9EED","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380408,"discussion_content":"id = 2都不存在，哪来的行锁？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1624494174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373844,"ip_address":""},"score":380408,"extra":""},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1926122,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/63/ea/1a128e67.jpg","nickname":"来需求了，很忙","note":"","ucode":"B77D1846FC9EED","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":577790,"discussion_content":"id=2位置是唯一的, 不需要锁间隙","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656334937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":380408,"ip_address":""},"score":577790,"extra":""}]}]},{"had_liked":false,"id":55394,"user_name":"郭健","can_delete":false,"product_type":"c1","uid":1102204,"ip_address":"","ucode":"169645EBF3B46C","user_header":"https://static001.geekbang.org/account/avatar/00/10/d1/7c/4639f22c.jpg","comment_is_top":false,"comment_ctime":1546157623,"is_pvip":false,"replies":[{"id":"20048","content":"1. 在锁方面你们dba说的基本是对的。一开始和结束有写锁，执行中间40分钟只有读锁<br>但是1000万的表要做40分钟，可能意味着系统压力大（或者配置偏小），这样可能不是没影响对，比较这个操作还是要吃IO和CPU的<br><br>2. 嗯，innodb引擎是这样的。","user_name":"作者回复","comment_id":55394,"uid":"1264162","ip_address":"","utype":1,"ctime":1546168989,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"48790797879","product_id":100020801,"comment_content":"老师，想请教您几个问题。1.在第六章MDL锁的时候，您说给大表增加字段和增加索引的时候要小心，之前做过测试，给一个一千万的数据增加索引有时需要40分钟，但是增加索引不会对表增加MDL锁吧。除了增加索引慢，还会对数据库有什么影响吗，我问我们dba，他说就开始和结束的时候上一下锁，没什么影响，我个人是持怀疑态度的。2，老师讲到表锁除了MDL锁，还有显示命令lock table的命令的表锁，老师我可以认为，在mysql中如果不显示使用lock table表锁的话，那么mysql是永远不会使用表锁的，如果锁的条件没有索引，使用的是锁住行锁+间隙控制并发。","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434760,"discussion_content":"1. 在锁方面你们dba说的基本是对的。一开始和结束有写锁，执行中间40分钟只有读锁\n但是1000万的表要做40分钟，可能意味着系统压力大（或者配置偏小），这样可能不是没影响对，比较这个操作还是要吃IO和CPU的\n\n2. 嗯，innodb引擎是这样的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546168989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375710,"discussion_content":"增加索引会加MDL写锁吧？不太明白 “开始和结束有写锁，执行中间40分钟只有读锁“ 的意思。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621827606,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381786,"discussion_content":"如果持续加的都是MDL写锁，那online DDL实现不了了就","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625210839,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375710,"ip_address":""},"score":381786,"extra":""},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589493,"discussion_content":"先加MDL写锁，防止DDL并发；然后退化成MDL读锁，可以并发DML操作；在结束时提交变更，MDL读锁又升级成MDL写锁，变更结束，释放锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665042911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375710,"ip_address":"陕西"},"score":589493,"extra":""}]}]},{"had_liked":false,"id":91324,"user_name":"乔纳森","can_delete":false,"product_type":"c1","uid":1045107,"ip_address":"","ucode":"51EC9FAE071388","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f2/73/1c7bceae.jpg","comment_is_top":false,"comment_ctime":1556980034,"is_pvip":true,"discussion_count":9,"race_medal":0,"score":"44506652994","product_id":100020801,"comment_content":"加锁过程的分析，这篇文章也是很棒的；供同学们参考<br>http:&#47;&#47;hedengcheng.com&#47;?p=771","like_count":10,"discussions":[{"author":{"id":1247965,"avatar":"https://static001.geekbang.org/account/avatar/00/13/0a/dd/88fa7b52.jpg","nickname":"Geek_41d472","note":"","ucode":"DEC2B6329460CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287914,"discussion_content":"垃圾广告","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1593587018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2369545,"avatar":"https://static001.geekbang.org/account/avatar/00/24/28/09/0ac42cff.jpg","nickname":"慕苏","note":"","ucode":"7ED14D00429C21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337105,"discussion_content":"应该不会有人花钱在评论里打个广告。哈哈哈","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1608798130,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1357311,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b5/ff/d1f205b0.jpg","nickname":"L","note":"","ucode":"5B847B2378854E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318013,"discussion_content":"已举报！！！","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1603629432,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1357311,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b5/ff/d1f205b0.jpg","nickname":"L","note":"","ucode":"5B847B2378854E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335648,"discussion_content":"应该域名被回收了,没记错的以前是 何登成的博客,好像是阿里的一位数据库大牛","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1608261595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":318013,"ip_address":""},"score":335648,"extra":""}]},{"author":{"id":1636631,"avatar":"https://static001.geekbang.org/account/avatar/00/18/f9/17/63530321.jpg","nickname":"黑无常","note":"","ucode":"36BA416033B3AD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311170,"discussion_content":"垃圾广告不要看！\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1602242976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1114463,"avatar":"","nickname":"starlin","note":"","ucode":"E7DD20382C5F29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303053,"discussion_content":"垃圾广告","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599123567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1465412,"avatar":"https://static001.geekbang.org/account/avatar/00/16/5c/44/d07c0865.jpg","nickname":"Geek_d960af","note":"","ucode":"C59AEF44BD8691","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298763,"discussion_content":"网站挂了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597393421,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103091,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg","nickname":"李二木","note":"","ucode":"30E03BB84ADB27","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372725,"discussion_content":"https://github.com/hedengcheng/tech ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620443603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1182802,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0c/52/f25c3636.jpg","nickname":"长脖子树","note":"","ucode":"D9090EF67EEB1B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350107,"discussion_content":"https://blog.csdn.net/bohu83/article/details/82833171","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613711674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":73695,"user_name":"Cv","can_delete":false,"product_type":"c1","uid":1062797,"ip_address":"","ucode":"C77CE172B5AA28","user_header":"","comment_is_top":false,"comment_ctime":1551960185,"is_pvip":false,"replies":[{"id":"27149","content":"读提交隔离级别一般没有gap lock，不过也有例外情况， 比如insert 出现主键冲突的时候，也可能加间隙锁","user_name":"作者回复","comment_id":73695,"uid":"1264162","ip_address":"","utype":1,"ctime":1552147171,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"44501633145","product_id":100020801,"comment_content":"gap锁是否只会在可重复读的情况下才有?<br>在提交读和有唯一索引的情况下, 我也有遇到过因为gap死锁的情况<br>大致是这种sql<br>session1<br>delete from t where id in (1,3,5);<br>insert into t id(1,3,5);<br>session2<br>delete from t where id in (2,4,6);<br>insert into t id(2,4,6);","like_count":10,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442229,"discussion_content":"读提交隔离级别一般没有gap lock，不过也有例外情况， 比如insert 出现主键冲突的时候，也可能加间隙锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552147171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2055879,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL9aTicYX60mV7ShV6o5jhBW17pOGoO5ZAkkK7WYHJyUc83ynOUtnAGsJHjOgia1GWkS1lu8E5ib0GkA/132","nickname":"sth","note":"","ucode":"2BB53721DF2795","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411017,"discussion_content":"mark\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635830712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375711,"discussion_content":"当唯一二级索引列冲突时，不管哪种隔离级别，都会加S型的next-key 锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621828060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104087,"user_name":"do it","can_delete":false,"product_type":"c1","uid":1309911,"ip_address":"","ucode":"E0753912E8F2AF","user_header":"https://static001.geekbang.org/account/avatar/00/13/fc/d7/b102034a.jpg","comment_is_top":false,"comment_ctime":1560644363,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35920382731","product_id":100020801,"comment_content":"什么是幻读?<br>幻读指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行。（幻读在当前读下才会出现；幻读仅专指新插入的行）<br>如何解决幻读?<br>间隙锁（Gap lock）:（两个值之间的锁）。<br>间隙锁和行锁合称 next-key lock，每个 next-key lock 是前开后闭区间。<br>间隙锁为开区间。<br>next-key-lock为前开后闭区间。<br>间隙锁引入什么问题？<br>可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的。<br>间隙锁在RR级别下才有效，RC级别下无间隙锁。<br>不使用间隙锁方法:<br>使用读提交隔离级别+ binlog_format=row组合。","like_count":8},{"had_liked":false,"id":57659,"user_name":"Geek_89bbab","can_delete":false,"product_type":"c1","uid":1156607,"ip_address":"","ucode":"B3110D5B3C9500","user_header":"https://static001.geekbang.org/account/avatar/00/11/a5/ff/6201122c.jpg","comment_is_top":false,"comment_ctime":1546863583,"is_pvip":false,"replies":[{"id":"20787","content":"好问题<br><br>Insert...select 是会给select部分加读锁的<br><br>这个也是为了保证一致性","user_name":"作者回复","comment_id":57659,"uid":"1264162","ip_address":"","utype":1,"ctime":1546869777,"user_name_real":"林晓斌"}],"discussion_count":5,"race_medal":0,"score":"35906601951","product_id":100020801,"comment_content":"表结构<br>CREATE TABLE `t2` (<br>  `id` int(11) DEFAULT NULL,<br>  `v` int(11) DEFAULT NULL<br>) ENGINE=InnoDB; <br>两个session，<br>session1,   |   session2<br>step1： set session transaction isolation level repeatable read;(session1) |  set session transaction isolation level repeatable read;(session2)<br>step2：  begin;(session1)<br>step3：  begin; (session2)<br>step4：   insert into t2 (id,v) values(1,1); （session1)<br>step5：  insert into t2 (id,v) select 2,2 from dual where not exists(select * from t2 where id=2); (session2) &#47;&#47; 这里为什么会阻塞，直到session1提交呢？<br>step6： commit; (session1) 该句执行完 session2不再阻塞<br>step7：commit;(session2)<br>我的疑惑就是为什么step5 那一步会阻塞？select * from t2 where id=2 不是快照读吗？也没有用for update，share lock 之类的语句，而且insert into 也没有什么唯一键约束，主键约束，怎么用数据库锁和隔离级别的知识来解释这个现象呢？请老师指点","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435689,"discussion_content":"好问题\n\nInsert...select 是会给select部分加读锁的\n\n这个也是为了保证一致性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546869777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2756810,"avatar":"","nickname":"mushan","note":"","ucode":"B57CCB0A1FA653","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":543942,"discussion_content":"测试了一下，select部分只有条件为非索引字段才会阻塞，索引字段则不会，原因是为何呢？老师帮忙解释一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641365484,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":435689,"ip_address":""},"score":543942,"extra":""}]},{"author":{"id":1304123,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e6/3b/6d68cb72.jpg","nickname":"邹涛","note":"","ucode":"B81FF267A59CE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203924,"discussion_content":"按理说，session1 的insert 也是当前读，由于没有索引，会锁住所有行和间隙啊。 为啥session 正常插入还是没问题？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584102119,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1811277,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a3/4d/59390ba9.jpg","nickname":"排骨","note":"","ucode":"A413CF46211E1F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1304123,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e6/3b/6d68cb72.jpg","nickname":"邹涛","note":"","ucode":"B81FF267A59CE9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572115,"discussion_content":"按道理来说这个表都没有建立索引,行锁+间隙锁都全加，相当于表锁了，session2应该插入也要给阻塞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652606222,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":203924,"ip_address":""},"score":572115,"extra":""}]},{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327661,"discussion_content":"如果表没有主键或唯一索引InnoDB内部适用，生成一个隐藏的聚集索引为合成列包含行ID值gen_clust_index.  session a对（1，1）加X locks rec but not gap","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605885458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":237712,"user_name":"咸鱼","can_delete":false,"product_type":"c1","uid":1179028,"ip_address":"","ucode":"5E79636DE48155","user_header":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","comment_is_top":false,"comment_ctime":1595931810,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"27365735586","product_id":100020801,"comment_content":"有了间隙锁是不是就解决了幻读了？那这样的话，串行化的意义在哪呢？解决的又是什么问题呢？以前一直以为串行化是为了解决幻读的问题","like_count":6,"discussions":[{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375717,"discussion_content":"SQL标准有四个隔离级别，每个隔离级别解决的问题不一样。Innodb 是对对标准的实现，一般情况下幻读发生在 RR 隔离级别，而 Innodb 在 RR级别下使用间隙锁就解决了这个问题，这主要考虑到并发度，使用串行化虽然能解决所有问题，但是严重影响了事务的并发度。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621830372,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":3007210,"avatar":"","nickname":"Geek_a1699c","note":"","ucode":"CF7DB00BE36B77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576241,"discussion_content":"多谢，解惑了，是不是可以理解为oracle、sqlserver等都是sql标准的一种实现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655365412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375717,"ip_address":""},"score":576241,"extra":""}]},{"author":{"id":2034587,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/0b/9b/7fb4c3f9.jpg","nickname":"奔跑","note":"","ucode":"EC84EE7C97D965","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348051,"discussion_content":"innodb的一个优势就是在RR隔离级别下解决了幻读","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612414425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2130032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/mpsOZBaHEA5oZ4A43dU21tNsakMyLRcmjn1liaJctPYfVkzB18dspeoOFNUxmEBq7I6Bjib0qPiaoF5uu0icNYek5g/132","nickname":"BestRiven","note":"","ucode":"D2642BC46EE9FC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2034587,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/0b/9b/7fb4c3f9.jpg","nickname":"奔跑","note":"","ucode":"EC84EE7C97D965","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372026,"discussion_content":"但不是RR级别下才有幻读嘛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620134171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":348051,"ip_address":""},"score":372026,"extra":""},{"author":{"id":1368768,"avatar":"https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg","nickname":"chongsheng","note":"","ucode":"859DF328FCA608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2130032,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/mpsOZBaHEA5oZ4A43dU21tNsakMyLRcmjn1liaJctPYfVkzB18dspeoOFNUxmEBq7I6Bjib0qPiaoF5uu0icNYek5g/132","nickname":"BestRiven","note":"","ucode":"D2642BC46EE9FC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400310,"discussion_content":"SQL标准中RR级别存在幻读问题，但是MySQL在RR下解决了幻读","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1633230560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":372026,"ip_address":""},"score":400310,"extra":""}]},{"author":{"id":1334377,"avatar":"https://static001.geekbang.org/account/avatar/00/14/5c/69/1a4fa7d9.jpg","nickname":"beslet","note":"","ucode":"6A95C896558C11","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":400025,"discussion_content":"串行化对读操作也加锁，相当于所有的操作都是当前读，没有快照读的概念; 所有的事务都强制排队执行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633144408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"汉江","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":344305,"discussion_content":"有同样的疑问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611402385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201201,"user_name":"陈家睿","can_delete":false,"product_type":"c1","uid":1830128,"ip_address":"","ucode":"570EEC6AB6CB21","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJSaE2tKBHbZpdvicX7CNiaacXsvEHzcjMRQ5LiauDA7wFIwsCltj0HyggQsYh49VJCj5iciawceZZnl9w/132","comment_is_top":false,"comment_ctime":1585732700,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"27355536476","product_id":100020801,"comment_content":"其实for update加了锁，sessionB根本不会执行，都是推论?<br>","like_count":6,"discussions":[{"author":{"id":3183077,"avatar":"https://static001.geekbang.org/account/avatar/00/30/91/e5/d6491986.jpg","nickname":"tan","note":"","ucode":"6D35E1F622006E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589773,"discussion_content":"感觉这种推论可有可无，直接说结论，然后讲原理就好了，都是写代码的，文字一多就变成了废话","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665306701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1807836,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/95/dc/07195a63.jpg","nickname":"锋","note":"","ucode":"F26BC1F14AB0D7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347794,"discussion_content":"我也同样纳闷呢，明明一样的语句 怎么还上面就可以，下面就不行了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612321710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1119544,"avatar":"https://static001.geekbang.org/account/avatar/00/11/15/38/18c55ff8.jpg","nickname":"TA","note":"","ucode":"C7C7CF2F1E2022","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337157,"discussion_content":"我也觉得，都是推论，我以为是实际结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608806996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1119544,"avatar":"https://static001.geekbang.org/account/avatar/00/11/15/38/18c55ff8.jpg","nickname":"TA","note":"","ucode":"C7C7CF2F1E2022","race_medal":1,"user_type":1,"is_pvip":false},"discussion":{"id":339505,"discussion_content":"文章里说了呀，是假设，为了推出要加间隙锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609691860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":337157,"ip_address":""},"score":339505,"extra":""}]},{"author":{"id":1497164,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLyHHeFsCArmvVRpvfic8uvG6qYJRCZHDb485ZaGzZStdQaexmhNa40xuJAnE5sjxshc067764WWcg/132","nickname":"Geek_3d4013","note":"","ucode":"99D29ED0FB38A8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332718,"discussion_content":"Same here","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607323512,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1435733,"avatar":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","nickname":"MClink","note":"","ucode":"F479190923355C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300540,"discussion_content":"执行的时候发生了阻塞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598165095,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55255,"user_name":"滔滔","can_delete":false,"product_type":"c1","uid":1303342,"ip_address":"","ucode":"6968B5771AF79D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg","comment_is_top":false,"comment_ctime":1546078803,"is_pvip":false,"replies":[{"id":"20021","content":"谢谢你的肯定。<br><br>嗯死锁分析会有一篇专门说。<br><br>不过你可以提前说一下碰到的疑问😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546085302,"ip_address":"","comment_id":55255,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27315882579","product_id":100020801,"comment_content":"老师，听了您的课收获满满～～感谢您的付出！您可不可以在分析死锁的时候讲一下如何分析死锁日志，期待～～😀","like_count":6,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434719,"discussion_content":"谢谢你的肯定。\n\n嗯死锁分析会有一篇专门说。\n\n不过你可以提前说一下碰到的疑问😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546085302,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71107,"user_name":"南友力max先森🌈","can_delete":false,"product_type":"c1","uid":1101805,"ip_address":"","ucode":"A72ECEBD714A0A","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/ed/6d76d9de.jpg","comment_is_top":false,"comment_ctime":1551266943,"is_pvip":false,"replies":[{"id":"25470","content":"看下08篇哦，<br>里面有介绍到行锁<br>还有问题再在那个文章下面发哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551272178,"ip_address":"","comment_id":71107,"utype":1}],"discussion_count":4,"race_medal":0,"score":"23026103423","product_id":100020801,"comment_content":"丁老师，想问下，innodb的行锁是怎么实现的，有单独的数据结构存放哪些数据块记录是被锁的么？还是在聚簇索引上对该行数据进行锁定标记？或者是其他？","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440993,"discussion_content":"看下08篇哦，\n里面有介绍到行锁\n还有问题再在那个文章下面发哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551272178,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325311,"discussion_content":"好问题","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1605268567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375718,"discussion_content":"无论对于哪些锁而言，都会生成一个锁结构。锁结构中记录了事务指针、索引指针（锁类型是行锁的情况下、锁的类型（表锁/行锁）、锁的类型模型（包括锁的模式、锁的类型、锁的详细分类（行锁的情况下）、锁的状态）、记录的heap_no到bit位的映射关系。当然还有其它的一些信息。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621830790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2244755,"avatar":"https://static001.geekbang.org/account/avatar/00/22/40/93/455b1560.jpg","nickname":"CERT","note":"","ucode":"9A0F5785B74851","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338291,"discussion_content":"回去看了下08篇，感觉也没找到答案呀。难道行锁是通过快照视图实现的？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1609233846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55520,"user_name":"en","can_delete":false,"product_type":"c1","uid":1157417,"ip_address":"","ucode":"C14EDEED543AC8","user_header":"https://static001.geekbang.org/account/avatar/00/11/a9/29/dad1f942.jpg","comment_is_top":false,"comment_ctime":1546222903,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"23021059383","product_id":100020801,"comment_content":"老师您好，我mysql的隔离级别是可重复读，数据是(0,0,0),(5,5,5),(10,10,10),(15,15,15),(20,20,20),(25,25,25)，使用了begin;select * from t where c&gt;=15 and c&lt;=20 order by c desc for update;然后sessionB的11阻塞了，但是(6,6,6)的插入成功了这是什么原因呢？","like_count":5,"discussions":[{"author":{"id":1625536,"avatar":"https://static001.geekbang.org/account/avatar/00/18/cd/c0/5120a267.jpg","nickname":"金木","note":"","ucode":"0D73A46DB431A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":273862,"discussion_content":"begin;select * from t where c>=15 and c<=20 order by c desc for update 这条语句 首先 主键为15、20的行满足条件 所以会加间隙锁（10,15]、（15,20]、（20,25）所以插入11会被阻塞，插入6不会被阻塞","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590505309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":138546,"discussion_content":"我测试的都不能插入数据， 5.7.16-log","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1579251785,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2039219,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/1d/b3/05729e06.jpg","nickname":"阿飞","note":"","ucode":"CD3293EEC33F14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311802,"discussion_content":"我的mysql版本5.7.30，seccion C（6,6,6）可以插入，是版本问题吗？？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602492044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1179056,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/b0/e30fd916.jpg","nickname":"京京beaver","note":"","ucode":"C21838D7CA7D6B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6825,"discussion_content":"我测试也是这样的，mysql版本5.7.18.  session C(6,6,6)可以插入成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567131982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55436,"user_name":"老杨同志","can_delete":false,"product_type":"c1","uid":1246199,"ip_address":"","ucode":"3F334F0CFD3DE6","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg","comment_is_top":false,"comment_ctime":1546177911,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23021014391","product_id":100020801,"comment_content":"音频听了两遍，文字看了一遍。相见恨晚啊，林老师你要早点开课，该多好啊。","like_count":5},{"had_liked":false,"id":65090,"user_name":"林","can_delete":false,"product_type":"c1","uid":1310290,"ip_address":"","ucode":"1519B371AF5C99","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/52/4c80282f.jpg","comment_is_top":false,"comment_ctime":1549033895,"is_pvip":false,"replies":[{"id":"23081","content":"👍","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549077883,"ip_address":"","comment_id":65090,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18728903079","product_id":100020801,"comment_content":"总结就是并发加可重复读引起了数据不一致，也就是幻读的产生，通过间隙锁解决。","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438316,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549077883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55065,"user_name":"信信","can_delete":false,"product_type":"c1","uid":1303865,"ip_address":"","ucode":"8DF0EC045579FD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg","comment_is_top":false,"comment_ctime":1546014991,"is_pvip":false,"replies":[{"id":"19993","content":"如果d有索引，而且写法是d=5，那么其他语句要把其他行的d改成5，也是不行的哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546046104,"ip_address":"","comment_id":55065,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18725884175","product_id":100020801,"comment_content":"老师你好，如果图1的字段d有索引，按前面说的T1时刻后，只有id等于5这一行加了写锁。那么session B  操作的是id等于0这一行，应该不会被阻断吧？如果没阻断的话，仍然会产生语义问题及数据不一致的情况啊。想不明白。。。","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434665,"discussion_content":"如果d有索引，而且写法是d=5，那么其他语句要把其他行的d改成5，也是不行的哦","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1546046104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304341,"discussion_content":"d改成5也算插入语句了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599549779,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55014,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1546000550,"is_pvip":false,"replies":[{"id":"19964","content":"嗯嗯下周一见😄<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546008407,"ip_address":"","comment_id":55014,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18725869734","product_id":100020801,"comment_content":"按照我的理解select * from t where c&gt;=15 and c&lt;=20 order by c desc for update;<br>这条语句的加锁顺序的以及范围应该是[25,20),[20,15],(15,10],但是通过实验得出来多了(10,5)gap锁<br>而且不管是用二级索引还是用主键索引,都会加这段gap锁.<br>有点不太清楚为什么倒序扫描就需要加上了这段gap锁,目的又是为了什么?<br>不会气磊,期待老师下一期的答案。😄","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434649,"discussion_content":"嗯嗯下周一见😄\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546008407,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125236,"user_name":"N","can_delete":false,"product_type":"c1","uid":1133657,"ip_address":"","ucode":"3791619172D64F","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/59/c75cb36d.jpg","comment_is_top":false,"comment_ctime":1566127774,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"14451029662","product_id":100020801,"comment_content":"老师您好，gap lock是为了解决幻读问题，但是为什么在可重复读的隔离级别就生效了呢？但是我们知道可重复读是不可避免幻读发生的，请问我们该如何理解这个问题？","like_count":3,"discussions":[{"author":{"id":1417841,"avatar":"https://static001.geekbang.org/account/avatar/00/15/a2/71/16fca8b5.jpg","nickname":"谢明辉","note":"","ucode":"1FEBC40559AF7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286742,"discussion_content":"是的，innodb在RR就解决了幻读，其他的是需要串行化。。不冲突哈","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1593271144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":61085,"discussion_content":"mysql的rr已经解决了幻读了,因为rr默认是nkl","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1574772059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2020865,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/d6/01/eaa50203.jpg","nickname":"zft","note":"","ucode":"74DEC5FBA610B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":277156,"discussion_content":"我觉得准确点说是，InnoDB的RR解决了幻读","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1591009536,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":61085,"ip_address":""},"score":277156,"extra":""}]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375719,"discussion_content":"SQL标准定义的是解决不了，但是MySQL是对这个标准的实现，它支持使用间隙锁解决RR级别下的幻读问题。使用串行话当然也可以，就是并发度受到严重影响。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621831643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":280070,"discussion_content":"补充一下，对于唯一索引并没有解决幻读，唯一索引会降级为rl或gap","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1591487860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":87740,"user_name":"ying","can_delete":false,"product_type":"c1","uid":1364292,"ip_address":"","ucode":"53A11A543B5DAC","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhIRlNpJSEMFOaQPCamszetzsE3LH5aCBqTibNeTdYatfRvtMg9JDu6NTfCjibibsNUfa2zicNLCQcWw/132","comment_is_top":false,"comment_ctime":1555676129,"is_pvip":false,"replies":[{"id":"31594","content":"工作中会用到 update ... where 吧？ 😆<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1555724820,"ip_address":"","comment_id":87740,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14440578017","product_id":100020801,"comment_content":"工作中用不到select for update。举例子都是这个……想请问一下反复讨论这个sql的意义是？是否有更普遍的业务情景","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":447582,"discussion_content":"工作中会用到 update ... where 吧？ 😆\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555724820,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55214,"user_name":"AstonPutting","can_delete":false,"product_type":"c1","uid":1303239,"ip_address":"","ucode":"1DB579A7922964","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/c7/d6a0927a.jpg","comment_is_top":false,"comment_ctime":1546067354,"is_pvip":false,"replies":[{"id":"20023","content":"在MySQL 里单引号和双引号一样的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546085669,"ip_address":"","comment_id":55214,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14430969242","product_id":100020801,"comment_content":"老师，能讲讲引号、单引号、还有数字1左边的那个引号有什么区别吗？","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434701,"discussion_content":"在MySQL 里单引号和双引号一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546085669,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55106,"user_name":"魏春河","can_delete":false,"product_type":"c1","uid":1117048,"ip_address":"","ucode":"DDD2998C157639","user_header":"https://static001.geekbang.org/account/avatar/00/11/0b/78/22410c47.jpg","comment_is_top":false,"comment_ctime":1546045229,"is_pvip":false,"replies":[{"id":"19991","content":"可重复读+间隙锁解决了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546045971,"ip_address":"","comment_id":55106,"utype":1}],"discussion_count":2,"race_medal":1,"score":"14430947117","product_id":100020801,"comment_content":"读了两遍还是没完全掌握。现在MySQL可重复读隔离级别是不存在幻读了吗？MySQL解决可重复读这些间隙锁要配置吗","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434674,"discussion_content":"可重复读+间隙锁解决了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546045971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2351720,"avatar":"https://static001.geekbang.org/account/avatar/00/23/e2/68/ce547a12.jpg","nickname":"zjm1314","note":"","ucode":"63B0EAB7045054","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341605,"discussion_content":"老师我想知道，那在mysql里可重复读其实也没有幻读的问题了，达到跟串行化一样的效果了，那么事务串行化具体又是什么呢，这个您前面没有详细说明过","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1610460651,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54707,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545955769,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"14430857657","product_id":100020801,"comment_content":"总结：for update 是锁住所有行还有间隙锁，但是间隙🔒之间互不冲突，但是互不冲突，为什么插入9这一行会被间隙锁等待，原来没有这一行，这和查询9这一行不是一样？","like_count":3,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162233,"discussion_content":"间隙锁不冲突，但因为有了间隙锁，所以不能再间隙锁间insert","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580975671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375720,"discussion_content":"间隙锁仅用来解决幻读问题，也就是防止对应的插入操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621831762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1066508,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/0c/773ba2f3.jpg","nickname":"下个目标45k","note":"","ucode":"193BA8C3AA9A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335654,"discussion_content":"获取锁并不会冲突,当是针对间隙insert操作会进行锁检测","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608263732,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54673,"user_name":"Justin","can_delete":false,"product_type":"c1","uid":1305601,"ip_address":"","ucode":"D49723FEA66731","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg","comment_is_top":false,"comment_ctime":1545929434,"is_pvip":false,"replies":[{"id":"19840","content":"嗯嗯，就是这些内容😄<br><br>这篇文章末尾的问题如果一眼看懂的同学应该看起来就轻松的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545961565,"ip_address":"","comment_id":54673,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14430831322","product_id":100020801,"comment_content":"下一章老师会不会讲走普通索引，锁普通索引的时候，主键索引，以及其他索引的加锁顺序或者规则呢？很是好奇 ","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434532,"discussion_content":"嗯嗯，就是这些内容😄\n\n这篇文章末尾的问题如果一眼看懂的同学应该看起来就轻松的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545961565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243810,"user_name":"欧阳洲","can_delete":false,"product_type":"c1","uid":1986708,"ip_address":"","ucode":"94606A6315F2BA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKT9Tk01eiaQ9aAhszthzGm6lwruRWPXia1YYFozctrdRvKg0Usp8NbwuKBApwD0D6Fty2tib3RdtFJg/132","comment_is_top":false,"comment_ctime":1598281120,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10188215712","product_id":100020801,"comment_content":"老师，请教一下：<br>我在 SessionB 执行 update t set d=5 where id=0; 的时候会卡住。<br>直到 Session A  commit; 掉，<br>SessionB才能执行成功。","like_count":2,"discussions":[{"author":{"id":1657055,"avatar":"https://static001.geekbang.org/account/avatar/00/19/48/df/5359b4fc.jpg","nickname":"雨落本无晴","note":"","ucode":"E64A60649544B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304877,"discussion_content":"mysql 默认隔离级别是 RR，RR 下用 MVCC 和间隙锁已经解决了幻读的问题，所以 SessionB 执行的时候会被阻塞，把隔离级别改成 RC 再演示就可以了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599704900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375721,"discussion_content":"mysql 默认隔离级别是 RR，在普通读的时候，MVCC 可以解决了幻读的问题。如果是当前读就需要间隙锁了，所以 SessionB 执行的时候会被阻塞。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621831942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231051,"user_name":"Ken","can_delete":false,"product_type":"c1","uid":1120761,"ip_address":"","ucode":"9F829156E855C8","user_header":"https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg","comment_is_top":false,"comment_ctime":1593572025,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10183506617","product_id":100020801,"comment_content":"当前读<br>* select … lock in share mode<br>* select … for update<br>* insert<br>* update<br>* delete","like_count":2},{"had_liked":false,"id":196087,"user_name":"胖虎","can_delete":false,"product_type":"c1","uid":1189627,"ip_address":"","ucode":"16834595992FD2","user_header":"https://static001.geekbang.org/account/avatar/00/12/26/fb/5a19b53e.jpg","comment_is_top":false,"comment_ctime":1585234420,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10175169012","product_id":100020801,"comment_content":"由于字段 d 上没有索引，因此这条查询语句会做全表扫描。那么，其他被扫描到的，但是不满足条件的 5 行记录上，会不会被加锁呢？<br>老师，这个问题你饶了老远，能否直接解答一下呢？","like_count":2},{"had_liked":false,"id":187621,"user_name":"蛋炒饭加鸡蛋","can_delete":false,"product_type":"c1","uid":1628398,"ip_address":"","ucode":"C75E27B9FB3336","user_header":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","comment_is_top":false,"comment_ctime":1584174241,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10174108833","product_id":100020801,"comment_content":"老师，今天的文章对我影响很大，发现之前掌握的知识有些错误的地方，课后我用你的表结构根据以前不清楚的地方实践了一遍，现在有两个问题，麻烦您解答下<br>1.我在事务1中执行 begin;select * from t where c=5 for update;事务未提交，然后事务2中begin;update t set c=5 where id=0;执行阻塞，替换成update t set c=11 where id=0;执行不阻塞，我觉得原因是事务1执行时产生next-key lock范围是(0,5].(5,10]。我想问下update set操作c=xxx是会加锁吗？以及加锁的原理。<br>老师，令狐少侠的问题，我认为C索引的加锁范围是间隙锁(0,5)+行锁(5)+间隙锁(5,10)这个范围，把C值更新成11是可以的，这个没问题，但是为什么插入或者更新一条C=10的记录却不行呢？","like_count":2},{"had_liked":false,"id":176766,"user_name":"御风","can_delete":false,"product_type":"c1","uid":1812807,"ip_address":"","ucode":"51C8212BE06364","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a9/47/ded5da90.jpg","comment_is_top":false,"comment_ctime":1581159922,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10171094514","product_id":100020801,"comment_content":"经测试，在RC级别下，重现出图一的现象。<br>在RR级别下，事务B和C的更新和插入操作陷入等待锁的状态，直到超时报错。","like_count":2,"discussions":[{"author":{"id":1697679,"avatar":"https://static001.geekbang.org/account/avatar/00/19/e7/8f/56387f77.jpg","nickname":"弹簧人","note":"","ucode":"BCB4A6FC76EA17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532314,"discussion_content":"对的，所以这块应该是写错了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637572527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169687,"user_name":"88591","can_delete":false,"product_type":"c1","uid":1254656,"ip_address":"","ucode":"04CE3E46455185","user_header":"https://static001.geekbang.org/account/avatar/00/13/25/00/3afbab43.jpg","comment_is_top":false,"comment_ctime":1578405818,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10168340410","product_id":100020801,"comment_content":"在rr隔离级别下面，mvcc 解决了一致读的问题，gap lock 解决了一致写问题。","like_count":2},{"had_liked":false,"id":162208,"user_name":"样儿","can_delete":false,"product_type":"c1","uid":1640757,"ip_address":"","ucode":"AB01047991559C","user_header":"https://static001.geekbang.org/account/avatar/00/19/09/35/7d2ced23.jpg","comment_is_top":false,"comment_ctime":1576477510,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10166412102","product_id":100020801,"comment_content":"老师，我按图1的做法,复现不出来呀，不知道是什么原因，mysql版本是8.0.15，隔离级别RR","like_count":2},{"had_liked":false,"id":69666,"user_name":"菜鸡一只","can_delete":false,"product_type":"c1","uid":1336004,"ip_address":"","ucode":"5FBA9A68E0E9B9","user_header":"https://static001.geekbang.org/account/avatar/00/14/62/c4/98a9e594.jpg","comment_is_top":false,"comment_ctime":1550805086,"is_pvip":false,"replies":[{"id":"24802","content":"1.默认就有<br>2. 会的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550815632,"ip_address":"","comment_id":69666,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10140739678","product_id":100020801,"comment_content":"1.MySQL默认的是可重复读级别吧，解决幻读的方法是加入了间隙锁，那需要我们操作什么才能开启间隙锁？<br>2.检索条件没有索引，MySQL不是会锁住整张表吗，包括新插入的数据？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440217,"discussion_content":"1.默认就有\n2. 会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550815632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64713,"user_name":"胡楚坚","can_delete":false,"product_type":"c1","uid":1120212,"ip_address":"","ucode":"225883EDF35BED","user_header":"https://static001.geekbang.org/account/avatar/00/11/17/d4/d7a4e6f5.jpg","comment_is_top":false,"comment_ctime":1548865995,"is_pvip":false,"replies":[{"id":"22909","content":"非常正确，就是gap 再加上它右边的那个记录。<br><br>要让整个区间连续，总要有一边闭区间哈，二选一。然后MySQL 一直支持的是升序索引😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548907069,"ip_address":"","comment_id":64713,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10138800587","product_id":100020801,"comment_content":"我对于左开右闭的意义(如果是数学那肯定造的)一直有点迷糊，闭和开有什么区别？然后自己去搜索下:（a，b]代表着会锁住a跟b之间，不让插入数据，还会锁住数据b本身，但不会锁住数据a(即开和闭对应着要不要锁住数据本身)。老师，我理解的对吗？<br><br>至于为什么左开右闭，说是迎合自增主键特性，这就不是很理解了，希望老师有空能回答下。","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438147,"discussion_content":"非常正确，就是gap 再加上它右边的那个记录。\n\n要让整个区间连续，总要有一边闭区间哈，二选一。然后MySQL 一直支持的是升序索引😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548907069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58899,"user_name":"spraith","can_delete":false,"product_type":"c1","uid":1141702,"ip_address":"","ucode":"7FBC54DF0BBF50","user_header":"https://static001.geekbang.org/account/avatar/00/11/6b/c6/2534e14a.jpg","comment_is_top":false,"comment_ctime":1547233912,"is_pvip":false,"replies":[{"id":"21354","content":"你得到了它😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547269346,"ip_address":"","comment_id":58899,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10137168504","product_id":100020801,"comment_content":"以前没用过 for update 语句，我上一个问题的答案应该找到了，原来 select 语句只有加了 for update 语句才会加写锁的","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436246,"discussion_content":"你得到了它😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547269346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54772,"user_name":"可凡不凡","can_delete":false,"product_type":"c1","uid":1296289,"ip_address":"","ucode":"9D42D6C5274D48","user_header":"https://static001.geekbang.org/account/avatar/00/13/c7/a1/273bff58.jpg","comment_is_top":false,"comment_ctime":1545961457,"is_pvip":false,"replies":[{"id":"19848","content":"Tab2满足条件的航上会加读锁","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545962706,"ip_address":"","comment_id":54772,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10135896049","product_id":100020801,"comment_content":"老师<br>update tab1  set name =(select name from tab2 where status =2)...<br>tab2.status 上有二级非唯一索引,rr 隔离级别<br>上述情况<br>tab2.id 上的的索引会被锁吗?<br>实际开发 看到的死锁情况 是这条语句在等待 s 锁 但是没有 gap 锁,也没有设置 semi-consistent read","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434561,"discussion_content":"Tab2满足条件的航上会加读锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545962706,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54738,"user_name":"小新","can_delete":false,"product_type":"c1","uid":1246916,"ip_address":"","ucode":"A5A6F142D7BC44","user_header":"https://static001.geekbang.org/account/avatar/00/13/06/c4/11c9aa38.jpg","comment_is_top":false,"comment_ctime":1545958390,"is_pvip":false,"replies":[{"id":"19839","content":"嗯嗯，而且这篇是下篇的基础😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545961394,"ip_address":"","comment_id":54738,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10135892982","product_id":100020801,"comment_content":"这篇文章真的需要多啃几遍，","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434547,"discussion_content":"嗯嗯，而且这篇是下篇的基础😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545961394,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339301,"user_name":"永远的草莓地","can_delete":false,"product_type":"c1","uid":1034001,"ip_address":"","ucode":"D4BD8DD42350CC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/11/89ba9915.jpg","comment_is_top":false,"comment_ctime":1648027769,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5942995065","product_id":100020801,"comment_content":"【幻读仅专指“新插入的行】，感觉这里【值得商榷】：<br><br>幻读 （phantom）在官方文档中的描述：A row that appears in the result set of a query, but not in the result set of an earlier query. For example, if a query is run twice within a transaction, and in the meantime, another transaction commits after inserting a new row or updating a row so that it matches the WHERE clause of the query.<br><br>&quot;inserting a new row or updating a row &quot;  并没有把幻读限定在 【新插入的行】。<br><br>私以为【幻读】，一个事务前、后两次完全相同的查询所返回的结果集不同（出现新的行），这个新的行是由【其他事务】插入或者修改所产生的，这种现象不符合 ACID 特性。<br><br>在 RR 级别下，普通 SELECT 查询都是快照读，因此不会出现幻读。因为【当前读】是读取已提交的最新值，是有可能出现幻读的。因为 RR 宗旨就是可重复读，所以为了实现这个目的，所以引入 next-key lock 来保证。<br><br>感觉理解了 MySQL 不同事务隔离级别下的宗旨，才能更好理解老师 21 讲要将的加锁规则，才明白MySQL为什么要那么设计加锁规则。<br><br>","like_count":1},{"had_liked":false,"id":284268,"user_name":"夜雨声歇","can_delete":false,"product_type":"c1","uid":1209069,"ip_address":"","ucode":"02A06382BD5CC5","user_header":"https://static001.geekbang.org/account/avatar/00/12/72/ed/1d8398ea.jpg","comment_is_top":false,"comment_ctime":1616144838,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5911112134","product_id":100020801,"comment_content":"有个疑问：行锁和间隙锁边扫描边加锁，有1000万行记录，逐行扫描加锁过程是原子的吗？<br>—— 我理解是原子的，因为如果不是，那就会幻读了。","like_count":1},{"had_liked":false,"id":257981,"user_name":"evan","can_delete":false,"product_type":"c1","uid":1543040,"ip_address":"","ucode":"491B073D5AFEDE","user_header":"https://static001.geekbang.org/account/avatar/00/17/8b/80/8702bd5f.jpg","comment_is_top":false,"comment_ctime":1604234313,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5899201609","product_id":100020801,"comment_content":"老师, 有个问题困惑了很久:<br>1. rr下select for update 和 select交替使用, 也就是当下读和快照读混合使用 还是会出现&quot;幻读&quot;,<br>不知道这里的幻速定义准确吗?  rr隔离级别和pg比较呢?  <br><br>2. rr下mvcc会带来write skew问题, 不知道有没有解决办法?","like_count":1},{"had_liked":false,"id":247389,"user_name":"prepared","can_delete":false,"product_type":"c1","uid":1194853,"ip_address":"","ucode":"00E54A5C7CDCBE","user_header":"https://static001.geekbang.org/account/avatar/00/12/3b/65/3a4fc8cf.jpg","comment_is_top":false,"comment_ctime":1599698566,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5894665862","product_id":100020801,"comment_content":"什么版本的MySQL呢？之前有说明嘛<br>本地复现不了老师的问题<br>MySQL 5.7","like_count":1},{"had_liked":false,"id":246404,"user_name":"ZhaoDW","can_delete":false,"product_type":"c1","uid":1581547,"ip_address":"","ucode":"02304EDB7EC155","user_header":"https://static001.geekbang.org/account/avatar/00/18/21/eb/c66a59ec.jpg","comment_is_top":false,"comment_ctime":1599311556,"is_pvip":false,"replies":[{"id":"92527","content":"可以，这个是彻底解决方案，就是性能不太行������","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1602664414,"ip_address":"","comment_id":246404,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5894278852","product_id":100020801,"comment_content":"串行化可以解决幻度嘛","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505132,"discussion_content":"可以，这个是彻底解决方案，就是性能不太行������","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602664414,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2351720,"avatar":"https://static001.geekbang.org/account/avatar/00/23/e2/68/ce547a12.jpg","nickname":"zjm1314","note":"","ucode":"63B0EAB7045054","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":341606,"discussion_content":"老师，串行化是怎么解决幻读的，讲一下啊，master师父","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610460826,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243517,"user_name":"MClink","can_delete":false,"product_type":"c1","uid":1435733,"ip_address":"","ucode":"F479190923355C","user_header":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","comment_is_top":false,"comment_ctime":1598165560,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5893132856","product_id":100020801,"comment_content":"想问问老师，如果是基于多个字段的update ，实际上也是 select * from t where a=xx and b=xxx and c= xxx for update, 这种多字段的where 条件下的间隙锁是怎么生成的呢？文章都是单字段的比较，是不是根据查的的行记录对应的自增主键ID范围来计算","like_count":1},{"had_liked":false,"id":222386,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1590770122,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5885737418","product_id":100020801,"comment_content":"T1：<br>--Session A： <br>    begin;<br>    select * from t_gap where d=5 for update;<br>    update t_gap set d=100 where d=5;<br><br>T2：<br>--Session B：<br>    update t_gap set d=5 where id=0; <br>    update t_gap set c=5 where id=0;<br><br>T3：<br>--Session A：<br>    select * from t_gap where d=5 for update;<br><br>T4：<br>--Session C：<br>    insert into t_gap values(1,1,5); <br>    update t_gap set c=5 where id=1;<br><br>T5：<br>--Session A：<br>    select * from t_gap where d=5 for update;<br><br>T6：<br>--Session A：<br>    commit；<br><br>结果分析：<br>● T1时刻：由于d没有索引，所以当你执行 select * from t where d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。<br>● T2时刻：update t_gap set d=5 where id=0; 被阻塞直到T6时刻SessionA提交事务才会往下执行.<br>● T3时刻：由于可重复读且在同一视图下，select * from t_gap where d=5 for update;查不到记录，因为在T1时刻update t_gap set d=100 where d=5;已经把d=5都更新为100了只不过没有提交，T5也一样.<br>● T4时刻：由于全表扫描间隙锁的存在，insert语句被阻塞了直到T6时刻SessionA提交事务。整个表会形成7 个 next-key lock： (-∞,0]、(0,5]、(5,10]、(10,15]、(15,20]、(20, 25]、(25, +supremum]， next-key lock是间隙锁和行锁合称。<br><br>binlog日志记录：<br>update t_gap set d=100 where d=5;<br><br>update t_gap set d=5 where id=0; <br>update t_gap set c=5 where id=0;<br><br>insert into t_gap values(1,1,5); <br>update t_gap set c=5 where id=1;<br>","like_count":1},{"had_liked":false,"id":211847,"user_name":"Scorpion 刘波","can_delete":false,"product_type":"c1","uid":1609667,"ip_address":"","ucode":"DF60BC39EA8B56","user_header":"https://static001.geekbang.org/account/avatar/00/18/8f/c3/02801527.jpg","comment_is_top":false,"comment_ctime":1588031042,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5882998338","product_id":100020801,"comment_content":"for update不是只对事务中条件明确的主键查询才会有行锁的效果吗？ 这里对d=5怎么回有行锁效果 这不应该就锁了表了吗？","like_count":1,"discussions":[{"author":{"id":1796870,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/6b/06/8afe6975.jpg","nickname":"Geek_wdy","note":"","ucode":"C5FA74E10ED1BB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289139,"discussion_content":"我也是这个情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594002999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184983,"user_name":"三三","can_delete":false,"product_type":"c1","uid":1054201,"ip_address":"","ucode":"4A76933C29BDA1","user_header":"https://static001.geekbang.org/account/avatar/00/10/15/f9/0b14785a.jpg","comment_is_top":false,"comment_ctime":1583462276,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5878429572","product_id":100020801,"comment_content":"虽然没有别人学的扎实，没有扩展发散，但看了老师的课感觉神清气爽","like_count":1},{"had_liked":false,"id":173319,"user_name":"天亮前说晚安","can_delete":false,"product_type":"c1","uid":1541014,"ip_address":"","ucode":"1D82EE562A7C71","user_header":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","comment_is_top":false,"comment_ctime":1579503725,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5874471021","product_id":100020801,"comment_content":"看不太懂，为啥第一部分是锁住满足条件的行？第二部分是扫描过的行都锁住了，他们语句是一样的啊，间隙锁为啥间隙是(5-10)?是因为相邻的主键是5和10吗？那如果是这样，那我insert数据的主键是11，那不是还会出现幻读吗？","like_count":1},{"had_liked":false,"id":113706,"user_name":"キッド","can_delete":false,"product_type":"c1","uid":1491871,"ip_address":"","ucode":"0773BDAD4ACCEF","user_header":"https://static001.geekbang.org/account/avatar/00/16/c3/9f/2dd26fee.jpg","comment_is_top":false,"comment_ctime":1563123465,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5858090761","product_id":100020801,"comment_content":"记得以前听公司的dba说过，不建议在业务中用select for update 语句容易引起问题。这个语句一般在什么应用场景中会用到呢？","like_count":1,"discussions":[{"author":{"id":2697700,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/LFJZ4x47rvShGhsePLIxc8EzdlBxAmVAIjJ2FQZ4NEpo8E4JCZQEOb2NIfOuiaQLL6Otkt7W3Rmu6Tv3AkgYdRA/132","nickname":"键盘上的魔术","note":"","ucode":"A731D721FB8D3A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543018,"discussion_content":"必须要当前读的情况下用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640933605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102551,"user_name":"业余草","can_delete":false,"product_type":"c1","uid":1126538,"ip_address":"","ucode":"99BDC1E629049D","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg","comment_is_top":false,"comment_ctime":1560249441,"is_pvip":false,"replies":[{"id":"37381","content":"额，这样感觉没有提出具体问题，没发判断对不对😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1560422266,"ip_address":"","comment_id":102551,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5855216737","product_id":100020801,"comment_content":"有人说：不可重复读 的重点是针对 update, delete。而幻读的重点针对的是 insert。这么说是对的吗？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453475,"discussion_content":"额，这样感觉没有提出具体问题，没发判断对不对😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560422266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92016,"user_name":"daydaynobug","can_delete":false,"product_type":"c1","uid":1336773,"ip_address":"","ucode":"C6923405EB62BA","user_header":"https://static001.geekbang.org/account/avatar/00/14/65/c5/97003360.jpg","comment_is_top":false,"comment_ctime":1557154309,"is_pvip":false,"replies":[{"id":"34321","content":"嗯，这个不算幻读哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1558261615,"ip_address":"","comment_id":92016,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5852121605","product_id":100020801,"comment_content":"老师，我之前一直以为之前能看到的记录被其他事务删除了，本事务内后面的当前读查不到也是幻读，所以是我想多了吗。。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449115,"discussion_content":"嗯，这个不算幻读哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558261615,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1082785,"avatar":"https://static001.geekbang.org/account/avatar/00/10/85/a1/2442332c.jpg","nickname":"郭俊杰","note":"","ucode":"D328E5738A4413","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1815,"discussion_content":"你很聪明，是你想多了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562924623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":91360,"user_name":"乔纳森","can_delete":false,"product_type":"c1","uid":1045107,"ip_address":"","ucode":"51EC9FAE071388","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f2/73/1c7bceae.jpg","comment_is_top":false,"comment_ctime":1557015299,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5851982595","product_id":100020801,"comment_content":"&lt;&lt; 在备份期间，备份线程用的是可重复读，而业务线程用的是读提交。同时存在两种事务隔离级别，会不会有问题？<br>&gt;&gt; 当前实验了一下，首先是备份的可用性，备份线上开始时会将事务隔离级别设置为可重复读，并以事务一致性读开启事务，事务视图创建，所以在备份期间其他线程的DML的操作，备份线程不可见，备份数据是一致的，可用的；现在用mydumper来做的备份，mysqldump 备份太慢了；<br>其次，多个事务隔离级别的存在，是否会影响业务，想了又想，没有想到会有影响；<br>老师，您觉得有什么影响么？","like_count":1},{"had_liked":false,"id":70458,"user_name":"miracle","can_delete":false,"product_type":"c1","uid":1276137,"ip_address":"","ucode":"FD7074F1062AE9","user_header":"https://static001.geekbang.org/account/avatar/00/13/78/e9/9d807269.jpg","comment_is_top":false,"comment_ctime":1551101983,"is_pvip":false,"replies":[{"id":"25132","content":"确实没有在生产上见过使用 序列化读的😅","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551108612,"ip_address":"","comment_id":70458,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5846069279","product_id":100020801,"comment_content":"老师 请教一个问题，既然可重复读能够解决幻读的问题，那么序列化读存在的价值是什么呢？望老师有空的时候解答下这个问题，感谢🙏","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440645,"discussion_content":"确实没有在生产上见过使用 序列化读的😅","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551108612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62601,"user_name":"是我的海","can_delete":false,"product_type":"c1","uid":1197457,"ip_address":"","ucode":"4BCE240829676A","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/91/afda3094.jpg","comment_is_top":false,"comment_ctime":1548119141,"is_pvip":false,"replies":[{"id":"22158","content":"Rc是可以的<br>你说的对，我只是在图一介绍里面写了“假设”，应该在文中也写出来，我加一句说明","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548123288,"ip_address":"","comment_id":62601,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5843086437","product_id":100020801,"comment_content":"老师你这图1的前提是没是没有强调清楚这是个假设的情况。看了好几遍总感觉哪里不对，在真实环境中用rc级别是否可以给演示出来？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437273,"discussion_content":"Rc是可以的\n你说的对，我只是在图一介绍里面写了“假设”，应该在文中也写出来，我加一句说明","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548123288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57259,"user_name":"hetiu","can_delete":false,"product_type":"c1","uid":1056127,"ip_address":"","ucode":"35D9338C3ABD20","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/7f/aabc1b66.jpg","comment_is_top":false,"comment_ctime":1546700133,"is_pvip":false,"replies":[{"id":"20644","content":"1. 如果只有主键就是行锁；<br>2. 自增主键只是系统生成主键，之后的加锁流程是一样的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546712469,"ip_address":"","comment_id":57259,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841667429","product_id":100020801,"comment_content":"老师请教下，如果只是单纯insert带主键的记录，会加什么锁; 如果主键是自增ID，又会是什么锁呢？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435493,"discussion_content":"1. 如果只有主键就是行锁；\n2. 自增主键只是系统生成主键，之后的加锁流程是一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546712469,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56486,"user_name":"Stalary","can_delete":false,"product_type":"c1","uid":1101749,"ip_address":"","ucode":"F69AFF7C958D31","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/b5/d1ec6a7d.jpg","comment_is_top":false,"comment_ctime":1546476888,"is_pvip":false,"replies":[{"id":"20367","content":"只有一个唯一索引的时候可以用insert ... on duplicate key update语法代替<br><br>另外，死锁并不是大问题，回滚重试就好了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546481309,"ip_address":"","comment_id":56486,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841444184","product_id":100020801,"comment_content":"看到文中说的那个死锁的场景，记得原来同事遇到过，请问有什么好的解决办法嘛？只能更换事物级别关掉间隙锁，防止并发死锁嘛？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435065,"discussion_content":"只有一个唯一索引的时候可以用insert ... on duplicate key update语法代替\n\n另外，死锁并不是大问题，回滚重试就好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546481309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55483,"user_name":"长杰","can_delete":false,"product_type":"c1","uid":1312212,"ip_address":"","ucode":"DD52C9494005F7","user_header":"https://static001.geekbang.org/account/avatar/00/14/05/d4/e06bf86d.jpg","comment_is_top":false,"comment_ctime":1546213441,"is_pvip":false,"replies":[{"id":"20072","content":"非常好，你这个是精确的范围，没有包含c=10这一行","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546218108,"ip_address":"","comment_id":55483,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5841180737","product_id":100020801,"comment_content":"1.我在事务1中执行 begin;select * from t where c=5 for update;事务未提交，然后事务2中begin;update t set c=5 where id=0;执行阻塞，替换成update t set c=11 where id=0;执行不阻塞，我觉得原因是事务1执行时产生next-key lock范围是(0,5].(5,10]。我想问下update set操作c=xxx是会加锁吗？以及加锁的原理。<br>2.一直以为gap只会在二级索引上，看了你的死锁案例，发现主键索引上也会有gap锁？<br><br><br>这位同学的实验我也重现了一下，事务1执行时产生next-key lock范围应该是(0,5]还有gap lock(5,10）<br>因为我执行插入（28，10，28）是可以执行的，所以next-key lock不包括（5，10]<br>","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434789,"discussion_content":"非常好，你这个是精确的范围，没有包含c=10这一行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546218108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1628398,"avatar":"https://static001.geekbang.org/account/avatar/00/18/d8/ee/17f220b6.jpg","nickname":"蛋炒饭加鸡蛋","note":"","ucode":"C75E27B9FB3336","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204441,"discussion_content":"为什么我这插入或者更新一条c=10的记录被锁住了呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584174126,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55481,"user_name":"Long","can_delete":false,"product_type":"c1","uid":1318970,"ip_address":"","ucode":"2417242560360A","user_header":"https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg","comment_is_top":false,"comment_ctime":1546212549,"is_pvip":false,"replies":[{"id":"20074","content":"这是好问题。<br>1. 无符号数第一位是符号位。1表示正数<br>2. 都是表示(5,10), 参考21讲的最后一个例子<br>3. 表示接下来要打印字符串值，如果是可打印字符会显示出来","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546234662,"ip_address":"","comment_id":55481,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841179845","product_id":100020801,"comment_content":"再发下，留言可能没看到。<br><br>老师你好，我这边有个疑问就是，我能找到和留言中 用户名为 沉浮 ，同学一样的日志，但是怎么就能判断这个是hex 8000000a asc就是(5,10]的gap锁，而不是(10,15]的？是因为左(]固定格式的原因吗？简单来说3个问题，<br>RECORD LOCKS space id 120833 page no 4 n bits 80 index `c` of table `test`.`t` trx id 9562291160 lock_mode X locks gap before rec insert intention waiting<br>Record lock, heap no 4 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>0: len 4; hex 8000000a; asc ;;<br>1: len 4; hex 8000000a; asc ;;<br><br>1. hex以8开头是什么原因啊？<br>2. 日志写的00000a是不是就是确定是(x,10]固定这种方式，还是需要参考其他字段一起判断？x是上一个实际存在的索引值<br>3. asc这个字段在这里有什么特殊含义吗？<br><br>希望老师帮忙解答，多谢","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434788,"discussion_content":"这是好问题。\n1. 无符号数第一位是符号位。1表示正数\n2. 都是表示(5,10), 参考21讲的最后一个例子\n3. 表示接下来要打印字符串值，如果是可打印字符会显示出来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546234662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55252,"user_name":"胡月🌈","can_delete":false,"product_type":"c1","uid":1255734,"ip_address":"","ucode":"D50890B8FF24A9","user_header":"https://static001.geekbang.org/account/avatar/00/13/29/36/c6bb0893.jpg","comment_is_top":false,"comment_ctime":1546078098,"is_pvip":true,"replies":[{"id":"20026","content":"PID是唯一索引吗？ 给一下表结构。这两个语句分别对应的主键ID如果单独查出来分别是多少","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546086836,"ip_address":"","comment_id":55252,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841045394","product_id":100020801,"comment_content":"老师，今天线上遇上了一个死锁的问题，您能帮我分析下吗。<br>根据前面文章的理解：死锁产生的原因如下<br>线程1：update语句where c= 1 然后 update语句where c=2<br>线程2：update语句where c=2然后 update语句where c=1<br>如果线程1获取c=1的锁，等待c=2的锁，线程2获取了c=2的锁，等待c=1的锁，就会产生死锁。<br>但是线上的情况是<br>线程1：update语句where c= 1 然后 update语句where c=2<br>线程2：update语句where c=1然后 update语句where c=2<br>按说不会产生死锁啊，因为如果线程1获取了c=1的锁，线程2就阻塞了。线程1执行完之后，线程2执行就可以了死锁日志如下：<br><br> (1) TRANSACTION:<br>TRANSACTION 9418928, ACTIVE 0.088 sec fetching rows<br>mysql tables in use 1, locked 1<br>LOCK WAIT 66 lock struct(s), heap size 13864, 8 row lock(s)<br>LOCK BLOCKING MySQL thread id: 11495130 block 11105198<br>MySQL thread id 11105198, OS thread handle 0x2b086bf45700, query id 88822589 39.106.161.89 daogou Searching rows for update<br>UPDATE union_pid<br>\t\tSET\tUSE_TIMES = USE_TIMES + 1<br>\t\tWHERE PID = &#39;mm_128160800_40474215_33107450401&#39;<br> (1) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 134 page no 93 n bits 192 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418928 lock_mode X locks rec but not gap waiting<br>Record lock, heap no 86 PHYSICAL RECORD: n_fields 12; compact format; info bits 0<br><br> (2) TRANSACTION:<br>TRANSACTION 9418929, ACTIVE 0.088 sec fetching rows<br>mysql tables in use 1, locked 1<br>280 lock struct(s), heap size 46632, 17 row lock(s), undo log entries 1<br>MySQL thread id 11495130, OS thread handle 0x2b086be41700, query id 88822594 39.106.161.89 daogou Searching rows for update<br>UPDATE union_pid<br>\t\tSET\tUSE_TIMES = USE_TIMES + 1<br>\t\tWHERE PID = &#39;1000501132_0_1432392817&#39;<br>(2) HOLDS THE LOCK(S):<br>RECORD LOCKS space id 134 page no 93 n bits 192 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418929 lock_mode X locks rec but not gap<br>Record lock, heap no 86 PHYSICAL RECORD: n_fields 12; compact format; info bits 0<br><br> (2) WAITING FOR THIS LOCK TO BE GRANTED:<br>RECORD LOCKS space id 134 page no 68 n bits 264 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418929 lock_mode X locks rec but not gap waiting<br>Record lock, heap no 116 PHYSICAL RECORD: n_fields 12; compact format; info bits 0<br><br> WE ROLL BACK TRANSACTION (1)","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434716,"discussion_content":"PID是唯一索引吗？ 给一下表结构。这两个语句分别对应的主键ID如果单独查出来分别是多少","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546086836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55208,"user_name":"峰","can_delete":false,"product_type":"c1","uid":1056019,"ip_address":"","ucode":"C53CB64E8E7D19","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg","comment_is_top":false,"comment_ctime":1546066718,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5841034014","product_id":100020801,"comment_content":"思考题，理论上讲要锁住的是c [15，20]，但又不能单单锁住c等于15或20的记录，因为要防止新的记录c=15或20被插入，所以这个锁就被放大了点，甚至比实际需要的语义放大了，变成了（10，25），当然我这里理解为更好实现点。而session c被有点莫名奇妙了，之少从幻读的层面上来说是不需要锁住的。","like_count":1,"discussions":[{"author":{"id":1357056,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b5/00/f4e8fbaf.jpg","nickname":"chenpiing","note":"","ucode":"C847A30B3FDB8F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1957,"discussion_content":"多出来的(10,15]感觉是因为左开右闭的规定吧，15已经确定要锁住了，因此还要往左扩到10","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563126832,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55170,"user_name":"高枕","can_delete":false,"product_type":"c1","uid":1310312,"ip_address":"","ucode":"20F6CF75EC9AA4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fe/68/e0bebd9a.jpg","comment_is_top":false,"comment_ctime":1546057304,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5841024600","product_id":100020801,"comment_content":"林老师，今天我又回头看第四节 深入浅出谈索引（上），里面有这样一段话：为了让一个查询尽量少地读磁盘，就必须让查询过程访问尽量少的数据块。那么，我们就不应该使用二叉树，而是要使用“N 叉”树。这里，“N 叉”树中的“N”取决于数据块的大小。<br>我想问的是，<br>一 mysql是以page为最小单位的，mysql一次磁盘io能只读一个块吗？还是多个块组成的page？<br>二 若一次只能读一个page，也就是多个块的话，这个N的大小是不是应该取决于page的大小呢？<br>三 主键索引叶子结点存放的实际数据，应该是通过指针跟叶子结点连接的吗？还是直接存在叶子结点所在的页里吗？","like_count":1,"discussions":[{"author":{"id":1593957,"avatar":"https://static001.geekbang.org/account/avatar/00/18/52/65/320eccb3.jpg","nickname":"王斯拉","note":"","ucode":"D00DD3CE432189","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4747,"discussion_content":"1， 一个page=16k，一个块=512字节  一次是要读一整页出来的。\n2，是的\n3，了解一下聚簇索引和B+树","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565702284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55025,"user_name":"nero","can_delete":false,"product_type":"c1","uid":1110627,"ip_address":"","ucode":"BACD4A95B5FA09","user_header":"https://static001.geekbang.org/account/avatar/00/10/f2/63/1f495e51.jpg","comment_is_top":false,"comment_ctime":1546003479,"is_pvip":false,"replies":[{"id":"19962","content":"不是，这两组概念是独立的，你看下08篇","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546008327,"ip_address":"","comment_id":55025,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5840970775","product_id":100020801,"comment_content":"老师快照读、当前读是不分别对应着可重复读和读提交呀？看很多文档都用这两个名词","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434652,"discussion_content":"不是，这两组概念是独立的，你看下08篇","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546008327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6978,"discussion_content":"快照读对应非锁定读，当前读对应锁定读（或UPDATE等修改），可重复读和读提交是事物的隔离级别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567240097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54932,"user_name":"会玩code","can_delete":false,"product_type":"c1","uid":1325282,"ip_address":"","ucode":"9220B072AF68C7","user_header":"https://static001.geekbang.org/account/avatar/00/14/38/e2/28aa8e6c.jpg","comment_is_top":false,"comment_ctime":1545983651,"is_pvip":false,"replies":[{"id":"19881","content":"你是不是漏看字了，where里是等值条件才有这个下降规则吧？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545988623,"ip_address":"","comment_id":54932,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5840950947","product_id":100020801,"comment_content":"老师，我看《innodb存储引擎》相关知识提到如果是唯一索引的话会将next-key lock降为record lock，但降为record lock的话好像防止不了幻读了吧？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434617,"discussion_content":"你是不是漏看字了，where里是等值条件才有这个下降规则吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545988623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2366248,"avatar":"https://static001.geekbang.org/account/avatar/00/24/1b/28/3e7a2916.jpg","nickname":"那那那","note":"","ucode":"04FD2412BB30D3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389460,"discussion_content":"并没有，书里就是说的唯一索引 会降级为行锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629282840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2344609,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c6/a1/3bdcde91.jpg","nickname":"向陽花开花向陽🌸","note":"","ucode":"9FDD01BE0E42CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375732,"discussion_content":"唯一索引查询不会发生幻读问题，因此可以直接降级为 记录锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621834201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54883,"user_name":"HuaMax","can_delete":false,"product_type":"c1","uid":1118488,"ip_address":"","ucode":"2E78DE1AF098AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/11/18/8cee35f9.jpg","comment_is_top":false,"comment_ctime":1545976545,"is_pvip":false,"replies":[{"id":"19896","content":"这个选择题出得不好😄<br>锁都是在索引上的，周一这篇你关注下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545995042,"ip_address":"","comment_id":54883,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5840943841","product_id":100020801,"comment_content":"想请教一下老师，间隙锁是按主键索引区分还是按查询字段的索引区分？这个是不是和第二个问题有关系？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434599,"discussion_content":"这个选择题出得不好😄\n锁都是在索引上的，周一这篇你关注下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545995042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354145,"user_name":"dawn","can_delete":false,"product_type":"c1","uid":1296063,"ip_address":"江苏","ucode":"1757B28F1EF5C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/c6/bf/52b3f71d.jpg","comment_is_top":false,"comment_ctime":1660123142,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660123142","product_id":100020801,"comment_content":"更优雅的做法是精确地锁住查询范围，即便目前没有命中的数据，也把这个范围圈出来，阻止其它线程写入，但mysql没有这样做，而是依据已有的数据圈了一个范围。所以我更认为这是一个临时的补丁性质的解决方案，后续会被迭代掉","like_count":0},{"had_liked":false,"id":353284,"user_name":"Geek_4c5291","can_delete":false,"product_type":"c1","uid":2915440,"ip_address":"广东","ucode":"1A589DF05110A8","user_header":"https://static001.geekbang.org/account/avatar/00/2c/7c/70/7124c4cf.jpg","comment_is_top":false,"comment_ctime":1659331781,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659331781","product_id":100020801,"comment_content":"Mysql8.0.30的间隙锁区间是 左闭右开 [ ,)； 老师可以解释一下吗？","like_count":0},{"had_liked":false,"id":352091,"user_name":"寥若晨星","can_delete":false,"product_type":"c1","uid":1447739,"ip_address":"","ucode":"2E87E43687DE72","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eou1BMETumU21ZI4yiaLenOMSibzkAgkw944npIpsJRicmdicxlVQcgibyoQ00rdGk9Htp1j0dM5CP2Fibw/132","comment_is_top":false,"comment_ctime":1658382677,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658382677","product_id":100020801,"comment_content":"想请教一个问题，事务二insert的数据，事务一的快照读本身是看不到的，但是事务一通过当前读修改到了这个新增行，然后再次select能看到这个行了，这算幻读吗","like_count":0},{"had_liked":false,"id":346405,"user_name":"末日，成欢","can_delete":false,"product_type":"c1","uid":1812201,"ip_address":"","ucode":"BBAEBB9C93558A","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLm8skz4F7FGGBTXWUMia6qVEc00BddeXapicv5FkAx62GmOnUNEcE4scSR60AmappQoNdIQhccKsBA/132","comment_is_top":false,"comment_ctime":1653108101,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653108101","product_id":100020801,"comment_content":"有一个疑问：请教一下大佬们<br>有一个表有100W数据， 但是其中id=20W-40W的数据被干掉了。 <br>此时我用没有索引的字段就更新一行记录，如果按照每一条扫描到的记录进行加锁的话，最终将整个表锁住的话。<br>那么会不会出现， 我才刚刚开始更新的时候， 我直接更新id=100W的那一行，是不是也可以更新成功？","like_count":0},{"had_liked":false,"id":346116,"user_name":"Geek_9a7aac","can_delete":false,"product_type":"c1","uid":2312325,"ip_address":"","ucode":"3BB66DD0619014","user_header":"","comment_is_top":false,"comment_ctime":1652844856,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652844856","product_id":100020801,"comment_content":"老师，我想问一下。我用mysql workbench怎么模拟不出来这种效果。我用的是mysql8.0  根据你的实验，我一个都模拟不出来。间隙锁是要手动开启么？","like_count":0},{"had_liked":false,"id":345312,"user_name":"幼稚园的小朋友","can_delete":false,"product_type":"c1","uid":2725596,"ip_address":"","ucode":"EF63C355BD58A7","user_header":"https://static001.geekbang.org/account/avatar/00/29/96/dc/8adf8971.jpg","comment_is_top":false,"comment_ctime":1652188963,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652188963","product_id":100020801,"comment_content":"老师 今天在生产环境中遇到了这样的问题 明明是rc隔离级别 但是也被mysql加了间隙锁 导致了死锁 排查的时候才看到next-key lock 您能解释下为啥rc也会加间隙锁嘛 老师","like_count":0},{"had_liked":false,"id":345258,"user_name":"KK","can_delete":false,"product_type":"c1","uid":1324863,"ip_address":"","ucode":"FFC31A3FE3A285","user_header":"https://static001.geekbang.org/account/avatar/00/14/37/3f/a9127a73.jpg","comment_is_top":false,"comment_ctime":1652161038,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1652161038","product_id":100020801,"comment_content":"“session B 和 sessionC 的两条语句，执行后就会提交”，这里的提交是指事务的提交，还是记录更新的提交呢？","like_count":0},{"had_liked":false,"id":343982,"user_name":"shinee_x_X","can_delete":false,"product_type":"c1","uid":1605962,"ip_address":"","ucode":"98529C77B052AC","user_header":"https://static001.geekbang.org/account/avatar/00/18/81/4a/dcc563fb.jpg","comment_is_top":false,"comment_ctime":1651153874,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651153874","product_id":100020801,"comment_content":"实在不明白加锁跟索引有什么关系，即使d列有索引，按照老师说的不给其他记录加锁，那老师的例子还是会有问题","like_count":0},{"had_liked":false,"id":343669,"user_name":"大梧桐树","can_delete":false,"product_type":"c1","uid":2250622,"ip_address":"","ucode":"1E910FF0194159","user_header":"https://static001.geekbang.org/account/avatar/00/22/57/7e/453a0db7.jpg","comment_is_top":false,"comment_ctime":1650977568,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650977568","product_id":100020801,"comment_content":"我们业务代码有几个地方使用了replace into，之前每次都是先查询有没有重复的数据，有就删除，然后使用replace into插入。<br>后来我发现这不是多此一举吗，就把查重的操作去掉了，结果数据库出现好几次插入失败的情况。使用命令SHOW ENGINE INNODB STATUS 查询，发现确实是间隙锁使不同的插入语句冲突了。<br>replace into是先插入，如果发现插入失败，就先删除再插入","like_count":0},{"had_liked":false,"id":342864,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1650510458,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650510458","product_id":100020801,"comment_content":"MySQL8把间隙锁场景问题也解决了","like_count":0},{"had_liked":false,"id":342857,"user_name":"亚林","can_delete":false,"product_type":"c1","uid":1018972,"ip_address":"","ucode":"4A5A6D24314B79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg","comment_is_top":false,"comment_ctime":1650509030,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650509030","product_id":100020801,"comment_content":"第一个场景MySQL8已经修了","like_count":0},{"had_liked":false,"id":341910,"user_name":"刘章","can_delete":false,"product_type":"c1","uid":1009693,"ip_address":"","ucode":"7608C518D49AE4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJLxEbhSEziblPNVkr9XFIAzPCib0TQvBxHYwiaKiaib7ExZ8dmUWyqWoibSedACTHCf52INMib80ic92G6wQ/132","comment_is_top":false,"comment_ctime":1649913840,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649913840","product_id":100020801,"comment_content":"假设索引没有间隙，顺序走下来的，会产生间隙锁吗","like_count":0},{"had_liked":false,"id":339505,"user_name":"。。","can_delete":false,"product_type":"c1","uid":2853618,"ip_address":"","ucode":"A52A6043D27D87","user_header":"https://static001.geekbang.org/account/avatar/00/2b/8a/f2/6c6f7886.jpg","comment_is_top":false,"comment_ctime":1648137502,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648137502","product_id":100020801,"comment_content":"有个疑惑的点，在幻读有什么问题那块，说是破坏了语义，这个我应该是理解了。但是按照这个思路想，RC 级别下，同样也会破坏语义哦，RC 用的行锁，sessionA 锁住了 d=5 的行，sessionB 将 id=0 这行的 d 修改成了 5，这个不是也破坏了语义了吗？即便是在 RR 级别下，有间隙锁的存在，假设 d 是有索引的，那么加锁范围应该是 next-key lock (0,5] 和 (5,10)，以及 id 索引上 id=5 这行，那么 sessionB 将 id=0 这行的 d 修改成了 5，sessionA 的锁是拦不住的，这样不是也破坏语义了吗？","like_count":0},{"had_liked":false,"id":338578,"user_name":"卡卡","can_delete":false,"product_type":"c1","uid":1611484,"ip_address":"","ucode":"F0D6471CA06A6C","user_header":"https://static001.geekbang.org/account/avatar/00/18/96/dc/58ccf3f3.jpg","comment_is_top":false,"comment_ctime":1647575596,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647575596","product_id":100020801,"comment_content":"我事务A里有两次查询，但是在这两次查询中，还有一条update语句。事务B在事务Aupdate前一刻插入了一条数据并commit了，那么事务A第二次查询，会看到事务B插入的数据，这个算不算幻读？","like_count":0},{"had_liked":false,"id":337576,"user_name":"清风","can_delete":false,"product_type":"c1","uid":1142539,"ip_address":"","ucode":"ED1B6DECC3A102","user_header":"https://static001.geekbang.org/account/avatar/00/11/6f/0b/06480912.jpg","comment_is_top":false,"comment_ctime":1646901059,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1646901059","product_id":100020801,"comment_content":"丁老师好，没有间隙锁，导致binlog和实际数据不一致， RC模式下没有间隙锁，这个问题是如何解决的呢","like_count":0,"discussions":[{"author":{"id":1324550,"avatar":"https://static001.geekbang.org/account/avatar/00/14/36/06/08c46bcd.jpg","nickname":"聂利","note":"","ucode":"808E064089724D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586638,"discussion_content":"RC, binlog row 模式的时候，只会根据主键来修改指定一条记录，而不会session B，sessioin C插入的记录进行修改","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662388577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582550,"discussion_content":"RC+binlog row模式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659505444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335787,"user_name":"Geek_fb333","can_delete":false,"product_type":"c1","uid":2011553,"ip_address":"","ucode":"F0904774D027A3","user_header":"https://static001.geekbang.org/account/avatar/00/1e/b1/a1/b1fd3903.jpg","comment_is_top":false,"comment_ctime":1645688423,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645688423","product_id":100020801,"comment_content":"【这是因为 +∞是开区间。实现上，InnoDB 给每个索引加了一个不存在的最大值 supremum，这样才符合我们前面说的“都是前开后闭区间】  这里应该是给每个数据库页面都加加了一个不存在的最大值 supremum，","like_count":0},{"had_liked":false,"id":334069,"user_name":"建强","can_delete":false,"product_type":"c1","uid":1397126,"ip_address":"","ucode":"62B03D0E0C64EC","user_header":"https://static001.geekbang.org/account/avatar/00/15/51/86/b5fd8dd8.jpg","comment_is_top":false,"comment_ctime":1644723785,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644723785","product_id":100020801,"comment_content":"思考题：<br>我个人的理解，session A的语句执行后，对表t加了间隙锁，这个间隙锁不只对C在15到20之间的记录加锁。同时还对C小于15的记录加了间隙锁，因此，在Session B插入C=11的记录时，产生事务等待，而Session C在插入记录时，我猜想，是不是也是因为Session B的事务等待，产生了间隙锁，才导致了Session C也进入了等待状态。","like_count":0},{"had_liked":false,"id":333531,"user_name":"Geek_161af7","can_delete":false,"product_type":"c1","uid":2834804,"ip_address":"","ucode":"EF9B2C0B359855","user_header":"","comment_is_top":false,"comment_ctime":1644395452,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1644395452","product_id":100020801,"comment_content":"设计数据库表结构时，怎么减少间隙锁的产生","like_count":0},{"had_liked":false,"id":329525,"user_name":"on the path","can_delete":false,"product_type":"c1","uid":2869085,"ip_address":"","ucode":"D0B59D9F0FC209","user_header":"https://static001.geekbang.org/account/avatar/00/2b/c7/5d/4ce965c4.jpg","comment_is_top":false,"comment_ctime":1641388385,"is_pvip":true,"discussion_count":1,"race_medal":3,"score":"1641388385","product_id":100020801,"comment_content":"有一点没明白，bin log的row模式，也是记录当前行的变化，为啥可以解决rc 的顺序问题？","like_count":0,"discussions":[{"author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561714,"discussion_content":"row模式记录的sql会将非条件字段也作为条件去更新，当然可以解决顺序问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649700167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327784,"user_name":"半年 2号","can_delete":false,"product_type":"c1","uid":2562181,"ip_address":"","ucode":"7F23C4532A5513","user_header":"https://static001.geekbang.org/account/avatar/00/27/18/85/83ac977e.jpg","comment_is_top":false,"comment_ctime":1640306701,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640306701","product_id":100020801,"comment_content":"非索引字段加写锁，是全表锁，因为是全表扫描，扫描过的记录都会加锁。","like_count":0},{"had_liked":false,"id":327726,"user_name":"冬瓜瓜","can_delete":false,"product_type":"c1","uid":1181599,"ip_address":"","ucode":"0EFB780C88F8D3","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/9f/157ed758.jpg","comment_is_top":false,"comment_ctime":1640252769,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640252769","product_id":100020801,"comment_content":"所以现在的mysql，在InnoDB下，RR隔离级别下，还有没有幻读的问题。个人理解了，mysql已经通过MVCC和间隙锁解决了。","like_count":0},{"had_liked":false,"id":325262,"user_name":"lalala","can_delete":false,"product_type":"c1","uid":2730692,"ip_address":"","ucode":"D4FF3B1B616F86","user_header":"https://static001.geekbang.org/account/avatar/00/29/aa/c4/09ebbf20.jpg","comment_is_top":false,"comment_ctime":1638883861,"is_pvip":false,"replies":[{"id":"118293","content":"第八篇里面有详细展开，再看看哈","user_name":"作者回复","user_name_real":"编辑","uid":"1264162","ctime":1639385092,"ip_address":"","comment_id":325262,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638883861","product_id":100020801,"comment_content":"老师 有个问题一直不太明白，可能是我没太看懂，事务隔离级别和锁有啥直接的联系啊","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538257,"discussion_content":"第八篇里面有详细展开，再看看哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639385092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323851,"user_name":"sugar","can_delete":false,"product_type":"c1","uid":2184057,"ip_address":"","ucode":"491906283FC13B","user_header":"https://static001.geekbang.org/account/avatar/00/21/53/79/327ef30e.jpg","comment_is_top":false,"comment_ctime":1638180941,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1638180941","product_id":100020801,"comment_content":"所以在 InnoDB 可重复读的隔离级别下， select * from t where d = 5 for update  就是默认加了行锁和 间隙锁么","like_count":0},{"had_liked":false,"id":322709,"user_name":"弹簧人","can_delete":false,"product_type":"c1","uid":1697679,"ip_address":"","ucode":"BCB4A6FC76EA17","user_header":"https://static001.geekbang.org/account/avatar/00/19/e7/8f/56387f77.jpg","comment_is_top":false,"comment_ctime":1637562055,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637562055","product_id":100020801,"comment_content":"老师，执行<br>begin;<br>select * from t where d=5 for update;<br>后，在另一个session执行update t set d = 5 where id = 0;<br>会被锁住呀。 直接提示lock  wait time exceed","like_count":0},{"had_liked":false,"id":320039,"user_name":"小肥","can_delete":false,"product_type":"c1","uid":1157618,"ip_address":"","ucode":"0CC43CA3CDA880","user_header":"https://static001.geekbang.org/account/avatar/00/11/a9/f2/f3a574c6.jpg","comment_is_top":false,"comment_ctime":1636048145,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636048145","product_id":100020801,"comment_content":"我也举个例子我们生产环境遇到的类似例子吧，delete from t where id = &#39;5&#39;; insert into t values(5,&#39;value&#39;);id=5 不存在时，delete 也产生间隙锁。解决办法，提前select * from t where id = &#39;5&#39; 根据结果判断是否存在，不存在就不delete 。消除了间隙锁的影响。<br> ","like_count":0},{"had_liked":false,"id":319701,"user_name":"Geek_c34046","can_delete":false,"product_type":"c1","uid":2823682,"ip_address":"","ucode":"926DE7D134A870","user_header":"","comment_is_top":false,"comment_ctime":1635916212,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635916212","product_id":100020801,"comment_content":"非当前读会加间隙锁吗？","like_count":0},{"had_liked":false,"id":318747,"user_name":"Hello  World","can_delete":false,"product_type":"c1","uid":1685908,"ip_address":"","ucode":"90DFEA2D041E1E","user_header":"https://static001.geekbang.org/account/avatar/00/19/b9/94/25bfa1ac.jpg","comment_is_top":false,"comment_ctime":1635410115,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1635410115","product_id":100020801,"comment_content":"d这列没有加索引为什么session2可以对表数据进行更新更新","like_count":0},{"had_liked":false,"id":316370,"user_name":"00江","can_delete":false,"product_type":"c1","uid":1391005,"ip_address":"","ucode":"70A0419B0D3D15","user_header":"https://static001.geekbang.org/account/avatar/00/15/39/9d/52107153.jpg","comment_is_top":false,"comment_ctime":1634288811,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634288811","product_id":100020801,"comment_content":"初始化SQL:<br><br>CREATE TABLE IF NOT EXISTS tab_lock (<br>  id bigint(20) NOT NULL AUTO_INCREMENT,<br>  i1 int(11) NOT NULL DEFAULT &#39;0&#39;,<br>  i2 int(11) NOT NULL DEFAULT &#39;0&#39;,<br>  v1 varchar(63) NOT NULL DEFAULT &#39;varchar&#39;,<br>  d1 datetime NOT NULL DEFAULT &#39;2000-01-01 00:00:00&#39;,<br>  PRIMARY KEY (id),<br>  UNIQUE KEY uk_i1 (i1),<br>  KEY k_i2 (i2)<br>) ;<br><br><br>INSERT IGNORE INTO tab_lock VALUES<br>(10,10,10,&#39;varchar_10&#39;,&#39;2021-10-01 10:00:10&#39;),<br>(20,20,20,&#39;varchar_20&#39;,&#39;2021-10-01 10:00:20&#39;),<br>(30,30,30,&#39;varchar_30&#39;,&#39;2021-10-01 10:00:30&#39;),<br>(40,40,40,&#39;varchar_40&#39;,&#39;2021-10-01 10:00:40&#39;),<br>(50,50,50,&#39;varchar_50&#39;,&#39;2021-10-01 10:00:50&#39;);<br><br>案例1：<br><br>[图片]<br><br>案例2： <br><br>[图片]<br><br>问题：  案例1  和  案例2  的  Session A的最终查询结果 是不一样的，案例2 为什么会读到Session B提交的表更？ 如图：<br>[图片]<br>","like_count":0},{"had_liked":false,"id":315705,"user_name":"特立独行的猪","can_delete":false,"product_type":"c1","uid":1465344,"ip_address":"","ucode":"1440F96375740A","user_header":"https://static001.geekbang.org/account/avatar/00/16/5c/00/5d11e68d.jpg","comment_is_top":false,"comment_ctime":1633947149,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1633947149","product_id":100020801,"comment_content":"间隙锁是在可重复读隔离级别下才会生效的。所以，你如果把隔离级别设置为读提交的话，就没有间隙锁了。但同时，你要解决可能出现的数据和日志不一致问题，需要把 binlog 格式设置为 row。--为什么在rr模式下，就不能把binlog日志设置为row","like_count":0,"discussions":[{"author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561715,"discussion_content":"可以，这样也能解决数据和日志不一致的问题，但既然RR有了NKL就能帮忙解决这个问题，就不用改了呗，row模式的日志太消耗空间了嘛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649700380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":315204,"user_name":"柳暗花明","can_delete":false,"product_type":"c1","uid":1151558,"ip_address":"","ucode":"B43FAC763548A8","user_header":"https://static001.geekbang.org/account/avatar/00/11/92/46/79899545.jpg","comment_is_top":false,"comment_ctime":1633748930,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633748930","product_id":100020801,"comment_content":"老是讲得太好了，大有收获","like_count":0},{"had_liked":false,"id":314578,"user_name":"特立独行的猪","can_delete":false,"product_type":"c1","uid":1465344,"ip_address":"","ucode":"1440F96375740A","user_header":"https://static001.geekbang.org/account/avatar/00/16/5c/00/5d11e68d.jpg","comment_is_top":false,"comment_ctime":1633240674,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633240674","product_id":100020801,"comment_content":"终于对锁有个深入的了解了","like_count":0},{"had_liked":false,"id":314458,"user_name":"恒星","can_delete":false,"product_type":"c1","uid":2715095,"ip_address":"","ucode":"C17DD00239780D","user_header":"","comment_is_top":false,"comment_ctime":1633079746,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633079746","product_id":100020801,"comment_content":"老师，我们生产上遇到一个并发导入的问题，在往一张有自增主键、唯一索引的表里，同时load data local infile &#39;&#39; replace into...语句的时候，会出现死锁和锁超时等待，老师能帮忙分析一下是什么原因造成的吗，数据库隔离级别是读取已提交","like_count":0},{"had_liked":false,"id":311464,"user_name":"大明猩","can_delete":false,"product_type":"c1","uid":1494622,"ip_address":"","ucode":"61D330B42AE3C4","user_header":"https://static001.geekbang.org/account/avatar/00/16/ce/5e/b103d538.jpg","comment_is_top":false,"comment_ctime":1631244612,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1631244612","product_id":100020801,"comment_content":"我懵了，就想问，可重复隔离级别下，select * from t；加了哪儿些锁?是加了行锁和间隙锁吗？","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394025,"discussion_content":"如果只是这个语句，是个快照读，不会加锁；假设你改成了当前读，由于是全表扫描会给所有行加行锁并给所有间隙加间隙锁","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1631692158,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309023,"user_name":"Kkkoko","can_delete":false,"product_type":"c1","uid":1069583,"ip_address":"","ucode":"C36729C4659F60","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8BIG7fdqVH3xs2o7yDGpbr9FuT93FVN98CC4cYdojcJamJrPS6q8ObOFQwDgbxygiaYaWnuMk0cw/132","comment_is_top":false,"comment_ctime":1629897357,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629897357","product_id":100020801,"comment_content":"问个问题， 请问是什么版本的MySQL。 我5.6.50，跟5.7都试过。<br><br>begin;<br>select * from t where d = 5 for update;<br>这条语句不是因为d没有索引，然后锁住了整个表嘛。<br>后续B、C会话都在等待锁的释放，执行不了啊。","like_count":0},{"had_liked":false,"id":306196,"user_name":"一木成舟🌊","can_delete":false,"product_type":"c1","uid":1315344,"ip_address":"","ucode":"610EA312D3AAFE","user_header":"https://static001.geekbang.org/account/avatar/00/14/12/10/8ef02bff.jpg","comment_is_top":false,"comment_ctime":1628429746,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628429746","product_id":100020801,"comment_content":"前面没有说明事务的隔离级别，看得有点凌乱了，在 rc隔离级别是没有间隙锁，在rr是有的。现在数据库默认隔离级别是 rr","like_count":0},{"had_liked":false,"id":302976,"user_name":"吴小智","can_delete":false,"product_type":"c1","uid":1310798,"ip_address":"","ucode":"C7C9F58B5C9F7B","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","comment_is_top":false,"comment_ctime":1626490172,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626490172","product_id":100020801,"comment_content":"间隙锁解决了写倾斜的问题吗？","like_count":0},{"had_liked":false,"id":302711,"user_name":"SDZ","can_delete":false,"product_type":"c1","uid":1576238,"ip_address":"","ucode":"3353FCAD5B52C1","user_header":"https://static001.geekbang.org/account/avatar/00/18/0d/2e/a6865099.jpg","comment_is_top":false,"comment_ctime":1626342705,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626342705","product_id":100020801,"comment_content":"看不懂。。。 哈哈，不知道你们怎么通过这篇文章看懂间隙锁的。 ","like_count":0},{"had_liked":false,"id":301857,"user_name":"Attract","can_delete":false,"product_type":"c1","uid":1112638,"ip_address":"","ucode":"DEB10AF9AB5A41","user_header":"https://static001.geekbang.org/account/avatar/00/10/fa/3e/92d74b38.jpg","comment_is_top":false,"comment_ctime":1625921238,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1625921238","product_id":100020801,"comment_content":"老师很奇怪啊，我在图 1 的那个场景，sessionB 的第一个更新语句提交不成功啊，因为 d 没有索引，整张表都被锁了，所有的增删改都执行不成功","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394026,"discussion_content":"图一场景是在基于没有加锁的情况下的假设，就是为了说明没有行锁间隙锁会有问题，实际肯定是复现不出来的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631692364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":299797,"user_name":"刘玉龙","can_delete":false,"product_type":"c1","uid":1500821,"ip_address":"","ucode":"02BCA2E78C1AD7","user_header":"https://static001.geekbang.org/account/avatar/00/16/e6/95/99d51e08.jpg","comment_is_top":false,"comment_ctime":1624863832,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624863832","product_id":100020801,"comment_content":"会对非自增的字符串主键添加间隙锁吗，如果加是怎样加的？","like_count":0},{"had_liked":false,"id":299675,"user_name":"Super~琪琪","can_delete":false,"product_type":"c1","uid":1039225,"ip_address":"","ucode":"5A0FCD19B24EAF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/db/79/9426c6ce.jpg","comment_is_top":false,"comment_ctime":1624789694,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1624789694","product_id":100020801,"comment_content":"老师这边说insert是属于幻读，那对于删除来说算幻读吗？还是算别的呢？这个也是前后条数读取不一致了呢","like_count":0},{"had_liked":false,"id":298644,"user_name":"Geek_chenyz","can_delete":false,"product_type":"c1","uid":2172817,"ip_address":"","ucode":"BBB37F14FF666E","user_header":"","comment_is_top":false,"comment_ctime":1624246840,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624246840","product_id":100020801,"comment_content":"老师，我遇到一个Oracle序列的问题。原本查询很快的查询语句查询列加上序列后查不出来了，DBA也看不出问题来（加上序列是为了insert新表作为主键），网上看到一个人的提问和我的问题非常相似（https:&#47;&#47;zhidao.baidu.com&#47;question&#47;359973724540322492.html?fr=iks&amp;word=oracle+%B2%E9%D1%AF%BC%D3%C9%CF%D0%F2%C1%D0%B1%E4%C2%FD&amp;ie=gbk），但也没得到解决。希望老师不吝指教！","like_count":0},{"had_liked":false,"id":297936,"user_name":"落落彩虹","can_delete":false,"product_type":"c1","uid":1264832,"ip_address":"","ucode":"F4CE1908DF149A","user_header":"https://static001.geekbang.org/account/avatar/00/13/4c/c0/73d52c05.jpg","comment_is_top":false,"comment_ctime":1623847663,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1623847663","product_id":100020801,"comment_content":"不得不说，这个课程太值了。","like_count":0},{"had_liked":false,"id":296974,"user_name":"最好不过","can_delete":false,"product_type":"c1","uid":2459923,"ip_address":"","ucode":"C7DBCD08402DF8","user_header":"https://static001.geekbang.org/account/avatar/00/25/89/13/0d3c5008.jpg","comment_is_top":false,"comment_ctime":1623245755,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1623245755","product_id":100020801,"comment_content":"看了下一讲，以及评论中的@令狐少侠的问题， begin;select * from t where c=5 for update;这个事务会锁住10感觉和下一讲讲的有矛盾；<br>这个符合优化2：等值判断，向右遍历，最后一个值不满足c=5这个等值条件，因此退化成间隙锁(5,10)","like_count":0},{"had_liked":false,"id":296206,"user_name":"鲁迅","can_delete":false,"product_type":"c1","uid":2650008,"ip_address":"","ucode":"F042325F6F6FB3","user_header":"https://static001.geekbang.org/account/avatar/00/28/6f/98/1aa65bef.jpg","comment_is_top":false,"comment_ctime":1622805932,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622805932","product_id":100020801,"comment_content":"作者您好 对于以下一个实践想请教您以下<br>有如下一张表三个字段 主键索引id ，普通索引username，普通列password<br>id username password<br>1   a              123<br>2   b              123<br>3   c               123<br><br>A 事务开启 SELECT * FROM admin_ WHERE username=&#39;a&#39; LOCK in share MODE;<br>B 事务开启  INSERT admin_ VALUES(4,&#39;a&#39;,5)会阻塞<br><br>原因是不是 inset这条记录 索引a字段插入进去 在b+树中 a的区间被锁所以会阻塞，而不是锁的表中的区间，因为表中的区间实际上【负无穷，b）已经结束了。 ","like_count":0},{"had_liked":false,"id":295951,"user_name":"唐朝首都","can_delete":false,"product_type":"c1","uid":1081233,"ip_address":"","ucode":"F72655AE0AE4CA","user_header":"https://static001.geekbang.org/account/avatar/00/10/7f/91/962eba1a.jpg","comment_is_top":false,"comment_ctime":1622681688,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1622681688","product_id":100020801,"comment_content":"为啥我的实验结果是：<br>可重复读隔离级别下：<br>SELECT * FROM t where c&gt;=15 and c&lt;=20 for update; 会加如下锁：<br>next-key lock:(10, 15], (15, 20]，(20,25]<br><br><br>SELECT * FROM t where c&gt;=15 and c&lt;=20 order by c desc for update; 会加如下锁：<br>next-key lock:(5, 10], (10, 15], (15, 20]<br>gap lock:(20, 25)<br><br>与之前的一位同学（薛畅）不一样，实验环境：MySQL 8.0","like_count":0,"discussions":[{"author":{"id":1987294,"avatar":"","nickname":"WisonHii","note":"","ucode":"620A820528E5E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383093,"discussion_content":"我和你的测试结果一样。MySQL 8.0.23","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625902012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295514,"user_name":"红高粱","can_delete":false,"product_type":"c1","uid":2365564,"ip_address":"","ucode":"0DD331C8E01A81","user_header":"https://static001.geekbang.org/account/avatar/00/24/18/7c/91d6dd83.jpg","comment_is_top":false,"comment_ctime":1622457311,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622457311","product_id":100020801,"comment_content":"后面两个会话都锁住了 mysql  -7  管的太宽了吧","like_count":0},{"had_liked":false,"id":294784,"user_name":"Geek_477b71","can_delete":false,"product_type":"c1","uid":2631930,"ip_address":"","ucode":"B722D3C86DF4AE","user_header":"","comment_is_top":false,"comment_ctime":1622090024,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622090024","product_id":100020801,"comment_content":"老师您好，日志那块有个疑问，在第二篇中讲的是先往日志中写入update语句，然后再提交事务；在本篇里面则是提交事务了再往日志中写入update语句。我想知道是我哪里理解错了吗？","like_count":0},{"had_liked":false,"id":293346,"user_name":"王位庆","can_delete":false,"product_type":"c1","uid":1180978,"ip_address":"","ucode":"D480AEA92894FE","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/32/7440d47d.jpg","comment_is_top":false,"comment_ctime":1621342248,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621342248","product_id":100020801,"comment_content":"想问个问题，MySQL的rr级别也解决幻读了吗？看完也不知道是否解决了，若解决了那串行化有什么用呢？","like_count":0},{"had_liked":false,"id":292529,"user_name":"吴小智","can_delete":false,"product_type":"c1","uid":1310798,"ip_address":"","ucode":"C7C9F58B5C9F7B","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","comment_is_top":false,"comment_ctime":1620871435,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1620871435","product_id":100020801,"comment_content":"为什么只有在可重复读级别下，才需要间隙锁呢？读已提交级别下，不是会有同样的问题吗？","like_count":0,"discussions":[{"author":{"id":1987294,"avatar":"","nickname":"WisonHii","note":"","ucode":"620A820528E5E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383094,"discussion_content":"因为在RC模式下，不重复读可以叫feature。但是在RR模式下，这个就算一个BUG，所以就需要GAP锁了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625902079,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290781,"user_name":"NotFoundMoneyException:¥0","can_delete":false,"product_type":"c1","uid":2596556,"ip_address":"","ucode":"D454002955D09C","user_header":"https://static001.geekbang.org/account/avatar/00/27/9e/cc/1d57f923.jpg","comment_is_top":false,"comment_ctime":1619751724,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1619751724","product_id":100020801,"comment_content":"可重复读下为什么不能用binlog row模式去解决主备数据不一致问题，非得用间隙锁？","like_count":0,"discussions":[{"author":{"id":1171004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/3c/96c1bc62.jpg","nickname":"卢建文","note":"","ucode":"900A0CE253F2BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372737,"discussion_content":"不加gaplock 解决不了幻读","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620447760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288609,"user_name":"孤傲的虎王","can_delete":false,"product_type":"c1","uid":2536451,"ip_address":"","ucode":"FE9B90D6EEBAFB","user_header":"https://static001.geekbang.org/account/avatar/00/26/b4/03/677fd301.jpg","comment_is_top":false,"comment_ctime":1618560377,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618560377","product_id":100020801,"comment_content":"我就想问，为什么我的数据库上重现，和文章中的不一样呢","like_count":0},{"had_liked":false,"id":287612,"user_name":"🎈🎈🎈","can_delete":false,"product_type":"c1","uid":1941362,"ip_address":"","ucode":"EE93D4ED7677BD","user_header":"https://static001.geekbang.org/account/avatar/00/1d/9f/72/f56939b2.jpg","comment_is_top":false,"comment_ctime":1618049522,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618049522","product_id":100020801,"comment_content":"老师，我有个疑问：<br>update t set d=d+1 where id=10;<br>加锁过程：<br>1.分析:要找到id=10的行，id字段等值查询，因此本该是 next-key lock(5,10]。 <br>2.根据优化1，主键id上的等值条件，退化成行锁，只加了id=10这一行的行锁。<br>3.向右遍历时且最后一个值不满足等值条件的时候，继续找，找到 id=15 因此需要加 next-key lock(10,15]<br>4.根据优化2:索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，next-key lock <br>  退化为间隙锁，id=10不满足等值条件(10!=15)。最后的next-key lock会退化为间隙锁:(10,15)<br>加锁结果：<br>行锁id=10, 间隙锁:(10,15)<br>是这样的吗？","like_count":0},{"had_liked":false,"id":284657,"user_name":"Geek_36f5c3","can_delete":false,"product_type":"c1","uid":2438476,"ip_address":"","ucode":"9D70A4327DD02E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM6XSZ46OTeK4GcduTccADRicLR3UsVsAyLd0c8Ms8vlFdgqZlxdF9aZvZHKcf7BuiaoKpDUNOhiaPT2w/132","comment_is_top":false,"comment_ctime":1616406361,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616406361","product_id":100020801,"comment_content":"图4：由于 session A 把所有的行都加了写锁，所以 session B 在执行第一个 update 语句的时候就被锁住了。需要等到 T6 时刻 session A 提交以后，session B 才能继续执行。session A 的语句是有条件的怎么会给所有的行加锁呢？","like_count":0},{"had_liked":false,"id":284132,"user_name":"致良知","can_delete":false,"product_type":"c1","uid":2113915,"ip_address":"","ucode":"73C722E31B726A","user_header":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","comment_is_top":false,"comment_ctime":1616073780,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1616073780","product_id":100020801,"comment_content":"指出作者 不足之处：间隙锁 是给谁加锁 是主键索引还是二级索引 如果没有索引呢  没有明确说明 好像作者完全沉醉在自己的世界里哈","like_count":0,"discussions":[{"author":{"id":1171004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/3c/96c1bc62.jpg","nickname":"卢建文","note":"","ucode":"900A0CE253F2BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372738,"discussion_content":"查看 innodb可以确定是主键索引还是二级索引的，有index和primary index 标识的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620447900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":284124,"user_name":"致良知","can_delete":false,"product_type":"c1","uid":2113915,"ip_address":"","ucode":"73C722E31B726A","user_header":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","comment_is_top":false,"comment_ctime":1616072031,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1616072031","product_id":100020801,"comment_content":"为什么一开始不围绕间隙锁才进行呢  加间隙锁的具体逻辑是什么呢 一带而过  重点的地方 一带而过  这里面还有很多人 干货满满 不知道 他们是不是一瓶子不满半瓶子晃荡呢<br><br>","like_count":0,"discussions":[{"author":{"id":1171004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/3c/96c1bc62.jpg","nickname":"卢建文","note":"","ucode":"900A0CE253F2BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372739,"discussion_content":"因为要可重复读要解决幻读才加入间歇锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620447960,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":284123,"user_name":"致良知","can_delete":false,"product_type":"c1","uid":2113915,"ip_address":"","ucode":"73C722E31B726A","user_header":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","comment_is_top":false,"comment_ctime":1616071948,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616071948","product_id":100020801,"comment_content":"这一章内容 在讲的时候 能实验成功吗 前两个例子 没有说明前提 什么前提呢： 没有间隙锁的前提 就开始操作了  那我在前面 应不应该 考虑间隙锁呢。  这一篇文章 给差评  逻辑不够严密   很混乱哈","like_count":0},{"had_liked":false,"id":284121,"user_name":"致良知","can_delete":false,"product_type":"c1","uid":2113915,"ip_address":"","ucode":"73C722E31B726A","user_header":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","comment_is_top":false,"comment_ctime":1616071795,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616071795","product_id":100020801,"comment_content":"老杨同志<br>愉快的做一下思考题<br>begin;<br>select * from t where c=5 for update;<br>commit;<br>历史知识的结论是，innodb先锁全表的所有行，返回server层，判断c是否等于5，然后释放c！=5的行锁。<br>验证方法：<br>事务A执行 锁住一行c！=5的记录 比如id =3 c=3<br> select * from t where id = 3 for update 或者 update t set c=4 where id =3<br>然后启动新事务B执行上面的语句select * from t where c=5 for update; 看看有没有被阻塞。<br>用于判断事务B的语句会不会试图锁不满足条件的记录。<br>然后把事务A和事务B的执行顺序对调一下，也就是先执行B在执行A。看看有没有阻塞，<br>判断在事务B加锁成功的情况下会不会释放不满足查询条件记录的行锁。<br>作者回复: 👍🏿 思路清晰<br><br><br>隔离级别再愉快地改成RR试试😄<br><br>这是上一篇作者的回复  这一片 有没有考虑”innodb先锁全表的所有行，返回server层，判断c是否等于5，然后释放c！=5的行锁。“  怎么感觉好矛盾啊","like_count":0},{"had_liked":false,"id":284120,"user_name":"致良知","can_delete":false,"product_type":"c1","uid":2113915,"ip_address":"","ucode":"73C722E31B726A","user_header":"https://static001.geekbang.org/account/avatar/00/20/41/7b/cda2e622.jpg","comment_is_top":false,"comment_ctime":1616071684,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616071684","product_id":100020801,"comment_content":"非索引字段检索 回锁全表，又说 不符合条件的 在server层会释放  感觉是不是矛盾？","like_count":0},{"had_liked":false,"id":281746,"user_name":"jiaozhuchen","can_delete":false,"product_type":"c1","uid":1510471,"ip_address":"","ucode":"65A696D75C0577","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI9cqxrtYLlu0XvlU6J7LwEn67cL9fbnJrI6UjankWwbhiaeDQ8fI2LtjMMVMFIGKSlUyeKmN29SMg/132","comment_is_top":false,"comment_ctime":1614868406,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614868406","product_id":100020801,"comment_content":"之前数据库理论里，可重复读隔离级别下：仍然有幻读问题，按老师的文章，mysql的可重复读隔离级别解决了幻读问题？","like_count":0},{"had_liked":false,"id":281523,"user_name":"杰sir","can_delete":false,"product_type":"c1","uid":1098505,"ip_address":"","ucode":"80BB56B3BFB71A","user_header":"https://static001.geekbang.org/account/avatar/00/10/c3/09/dc368335.jpg","comment_is_top":false,"comment_ctime":1614773591,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1614773591","product_id":100020801,"comment_content":"同时存在两种事务隔离级别，会不会有问题？<br>“用读提交就够了”这个结论是怎么得到的？<br><br>脑袋不够用了！","like_count":0},{"had_liked":false,"id":276056,"user_name":"Ansyear","can_delete":false,"product_type":"c1","uid":1629257,"ip_address":"","ucode":"489CE96852EA2C","user_header":"https://static001.geekbang.org/account/avatar/00/18/dc/49/43ae1627.jpg","comment_is_top":false,"comment_ctime":1611759353,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1611759353","product_id":100020801,"comment_content":"RC级别+row格式的binlog没有了间隙所，但能解决幻读的问题吗？不能吧","like_count":0,"discussions":[{"author":{"id":1171004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/de/3c/96c1bc62.jpg","nickname":"卢建文","note":"","ucode":"900A0CE253F2BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372740,"discussion_content":"这个主要解决主从不一致问题吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620448102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":275669,"user_name":"大湿兄","can_delete":false,"product_type":"c1","uid":1660151,"ip_address":"","ucode":"587EBBBED90182","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL17rDiannrcyaUB5X6haqLic1183mfwyunJicRO8IYV9U8MaYiaZp8jRnW5kLQIqRmwTaPGIEVQZL5Uw/132","comment_is_top":false,"comment_ctime":1611639789,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611639789","product_id":100020801,"comment_content":"老师，你好<br>按照你的过程我实验了一遍，发现有个问题：<br>1，开启A事务：<br>     begin;<br>     select * from t where d=5 for update;<br>      results:(5,5,5)<br>2，开启B事务：<br>     update t set d=5 where id=0;<br>     A事务执行：<br>     select * from t where d=5 for update;<br>     results(0,0,5)(5,5,5,)<br>3，开启C事务：<br>    insert into t values (1,1,5);<br>   此时SQL执行不成功，报错：<br>  1205 - Lock wait timeout exceeded; try restarting transaction<br><br>数据库的事务隔离模式是RR<br><br>这是为什么","like_count":0},{"had_liked":false,"id":275206,"user_name":"汉江","can_delete":false,"product_type":"c1","uid":1788647,"ip_address":"","ucode":"01622D984B8F9B","user_header":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","comment_is_top":false,"comment_ctime":1611389339,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611389339","product_id":100020801,"comment_content":"mysql 版本 5.7.17 隔离级别 RR<br>针对老师最后提出的问题实验：<br>插入  INSERT into t VALUES (3,3,3); 和  INSERT into t VALUES (26,26,26); 均不会阻塞<br>针对本文的next-key 区间 （-&amp;,0]、(0,5]、(5,10]、(10,15]、(15,20]、(20,25]、(25,superme],猜测它不仅不锁住自身所在的区间还会锁住相邻的区间，所以INSERT into t VALUES (6,6,6);是插入不进去的，因为它属于(10,15]相邻的区间(5,10]，同理INSERT into t VALUES (22,22,22)也是插入不进去的","like_count":0},{"had_liked":false,"id":271709,"user_name":"skying","can_delete":false,"product_type":"c1","uid":1041865,"ip_address":"","ucode":"E7CFF50AB64BB1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e5/c9/1061582b.jpg","comment_is_top":false,"comment_ctime":1609764903,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1609764903","product_id":100020801,"comment_content":"老师，你好，我在本地测试，线程2中执行的 update t2 set d=5 where id = 0;<br>会被阻塞。<br>如果线程1的 查询语句改成  select * from t2 where id=5 for update;  则线程2的update不会阻塞。<br><br>请问下 这是什么原因？","like_count":0},{"had_liked":false,"id":270889,"user_name":"FR","can_delete":false,"product_type":"c1","uid":1226754,"ip_address":"","ucode":"E111881ED789C1","user_header":"https://static001.geekbang.org/account/avatar/00/12/b8/02/7bcba09e.jpg","comment_is_top":false,"comment_ctime":1609312602,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609312602","product_id":100020801,"comment_content":"老师，请问下如果字段的值是uuid，next-key lock也是算区间吗？如果不是的话是怎么样的","like_count":0},{"had_liked":false,"id":266601,"user_name":"大湿兄","can_delete":false,"product_type":"c1","uid":1660151,"ip_address":"","ucode":"587EBBBED90182","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL17rDiannrcyaUB5X6haqLic1183mfwyunJicRO8IYV9U8MaYiaZp8jRnW5kLQIqRmwTaPGIEVQZL5Uw/132","comment_is_top":false,"comment_ctime":1607412121,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607412121","product_id":100020801,"comment_content":"观后总结：<br>1，数据不一致的前提是binlog模式是非row下，这个模式是记录sql上下文执行顺序<br>2，rr模式下，只有当前读才可能有幻读，普通读是快照读，不会有幻读<br>3，update类似select * for update","like_count":0},{"had_liked":false,"id":266252,"user_name":"学好习，做好人","can_delete":false,"product_type":"c1","uid":1205294,"ip_address":"","ucode":"C991643DB458E2","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/2e/e70a317a.jpg","comment_is_top":false,"comment_ctime":1607257751,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607257751","product_id":100020801,"comment_content":"老师，创建了一个表，按照上面的例子，有个字段没加索引，发现没有发生死锁，加上普通索引之后并发执行才发生死锁，不知道为啥原因呢？这个字段是varchar类型的","like_count":0},{"had_liked":false,"id":265314,"user_name":"mycat","can_delete":false,"product_type":"c1","uid":1285652,"ip_address":"","ucode":"6878BD32D042F2","user_header":"","comment_is_top":false,"comment_ctime":1606866167,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606866167","product_id":100020801,"comment_content":"希望老师看到能回复一下。<br>一个表t有两个字段：a，b。它们都是int类型。初始值都是100。t表只有一行。<br>执行如下更新语句。<br>update t set a=a-1, b=a-1;<br>更新之后为什么b的值是98而不是99？<br>下面的语句为何结果都是99了呢？<br>update t set b=a-1, a=a-1;<br>这个和当前读有关系吗？字段的更新顺序会有关系吗？会根据set的顺序而先更新某个而后更新某个吗？<br>","like_count":0},{"had_liked":false,"id":264532,"user_name":"x-ray","can_delete":false,"product_type":"c1","uid":1140175,"ip_address":"","ucode":"8363F0C4D0AC0B","user_header":"https://static001.geekbang.org/account/avatar/00/11/65/cf/326c0eea.jpg","comment_is_top":false,"comment_ctime":1606492125,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606492125","product_id":100020801,"comment_content":"幻读在语义上有什么问题那一段。如果自己做例子，应该是要在表字段d上加索引，而且要把模式改成RC。<br>老师这里想表达的是：实际上我想锁住d=5所有的行，sessionA，的确是锁住了d=5所有的行，即id=5这行。而id=0这行，原本的d=0，所以默认是不锁住的。sessionB通过update语句，把id=0这行的字段d，从0改成5，这样一来，d=5的行变成了两行，但id=0这行因为是新改的，不是原来就存在的，在RC模式下，只有行锁，所以不会被锁住。这个时候继续对id=0这行进行其它操作，都是可以行的通的，比如把这一行的c值改成5。这就违背了sessionA语义的初衷了。<br>在RR模式下，因为间隙锁的存在，对id=0这一行，想把d的值改成5是不行的，这就符合了sessionA语义的初衷了。","like_count":0},{"had_liked":false,"id":261308,"user_name":"Cloud_July","can_delete":false,"product_type":"c1","uid":1003699,"ip_address":"","ucode":"98646F7142CBFF","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL8L7Am3u37GO6CWKqBbI02DZ2ss3IZb0F9OLewAS446vh3aicndQ255HjEDzIldBUhRpUbL04rnDA/132","comment_is_top":false,"comment_ctime":1605264903,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605264903","product_id":100020801,"comment_content":"本来对幻读、间隙锁这些概念已经理解的差不多了，然后看留言里面置顶的例子，感觉又懵逼了，什么时候会阻塞，什么时候不阻塞是固定的么。。。","like_count":0},{"had_liked":false,"id":258547,"user_name":"飞飞走走","can_delete":false,"product_type":"c1","uid":1304493,"ip_address":"","ucode":"E9BCBA6D00C226","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK1V6BNbTzjPMFPXQLia7jGpKiczxASA2ooAy1tcTkVzbF4upxMZLTxj6GoIlJibudSrJUBCgB0pj9bA/132","comment_is_top":false,"comment_ctime":1604479146,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604479146","product_id":100020801,"comment_content":"老师，图1中的案例我做了两次实验，第一次，执行T4时间的时候阻塞了；第二次，执行到T2时间，sessionB的操作就被锁住了，没有复现您的结果，无法理解","like_count":0},{"had_liked":false,"id":256498,"user_name":"飞翔","can_delete":false,"product_type":"c1","uid":1184658,"ip_address":"","ucode":"0641211EE9DA5C","user_header":"https://static001.geekbang.org/account/avatar/00/12/13/92/0b4c8e30.jpg","comment_is_top":false,"comment_ctime":1603639154,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1603639154","product_id":100020801,"comment_content":"今天面字节问到间隙锁了，可惜当时看这篇专栏没太看懂，再回过头啃啃","like_count":0},{"had_liked":false,"id":254846,"user_name":"502 Bad Gateway","can_delete":false,"product_type":"c1","uid":1919552,"ip_address":"","ucode":"B8953BF8B5E9EC","user_header":"https://static001.geekbang.org/account/avatar/00/1d/4a/40/62638647.jpg","comment_is_top":false,"comment_ctime":1603198459,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603198459","product_id":100020801,"comment_content":"我测试死锁的时候发现一个事务报死锁异常， 之后另外一个事务成功了； 我想问下如果是这种情况那么失败的事务在成功的事务执行后再重试一次不就成功了，","like_count":0},{"had_liked":false,"id":254501,"user_name":"大饶Raysir","can_delete":false,"product_type":"c1","uid":1589208,"ip_address":"","ucode":"0AFA191420A30D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTITcwicqBDYzXtLibUtian172tPs7rJpqG1Vab4oGjnguA9ziaYjDCILSGaS6qRiakvRdUEhdmSG0BGPKw/132","comment_is_top":false,"comment_ctime":1603120512,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603120512","product_id":100020801,"comment_content":"第二遍重刷这个专栏了，上一次没看太懂的这次懂了！","like_count":0},{"had_liked":false,"id":253101,"user_name":"Czc超","can_delete":false,"product_type":"c1","uid":2095510,"ip_address":"","ucode":"1554169AAD6E9C","user_header":"https://static001.geekbang.org/account/avatar/00/1f/f9/96/b3c44e65.jpg","comment_is_top":false,"comment_ctime":1602597989,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602597989","product_id":100020801,"comment_content":"老师，您上述分析的例子都是不带索引的，所以第一次select where.... for update能锁住全表，是因为不走索引，第二个事务的就会被阻塞，所以不会出现数据不一致问题。但是如果第一次select  where..... for  update 这个查询走索引的话，就不会锁住全表，只会用行锁，这样就还是会出现数据不一致问题吧。","like_count":0},{"had_liked":false,"id":249571,"user_name":"木子00","can_delete":false,"product_type":"c1","uid":1314724,"ip_address":"","ucode":"8F78CA722EB29B","user_header":"https://static001.geekbang.org/account/avatar/00/14/0f/a4/0b49469f.jpg","comment_is_top":false,"comment_ctime":1600694748,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1600694748","product_id":100020801,"comment_content":"这一节有点难消化，需要多读几篇了。","like_count":0},{"had_liked":false,"id":247102,"user_name":"Java垒墙工程师","can_delete":false,"product_type":"c1","uid":1937062,"ip_address":"","ucode":"E76AE44A9C76AE","user_header":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","comment_is_top":false,"comment_ctime":1599608891,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599608891","product_id":100020801,"comment_content":"为什么间隙锁记为开区间，把 next-key lock 记为前开后闭区间。","like_count":0},{"had_liked":false,"id":246015,"user_name":"蓝先锋","can_delete":false,"product_type":"c1","uid":1887201,"ip_address":"","ucode":"43693C879BB217","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PQtystrICzfgcXCbPNOxSnGwfsEUv3vcGmSk8K5WBTNVuHYEGicSQfRP8bvrGDCFsNoUMSTCibSE9iczVTY5HV1Hg/132","comment_is_top":false,"comment_ctime":1599133274,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599133274","product_id":100020801,"comment_content":"再问一个问题：select * from t where d = 5 for update ； d上无索引，有说法是这种情况是加了表锁， 想问问老师，这个代码实现上究竟是加了表锁还是加了行锁+间隙锁啊？","like_count":0},{"had_liked":false,"id":246012,"user_name":"蓝先锋","can_delete":false,"product_type":"c1","uid":1887201,"ip_address":"","ucode":"43693C879BB217","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PQtystrICzfgcXCbPNOxSnGwfsEUv3vcGmSk8K5WBTNVuHYEGicSQfRP8bvrGDCFsNoUMSTCibSE9iczVTY5HV1Hg/132","comment_is_top":false,"comment_ctime":1599132154,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599132154","product_id":100020801,"comment_content":"老师您好，想问一下，为啥间隙锁设计为不互斥呢？如本讲最后的例子中，就直接导致了死锁。","like_count":0},{"had_liked":false,"id":245964,"user_name":"蓝先锋","can_delete":false,"product_type":"c1","uid":1887201,"ip_address":"","ucode":"43693C879BB217","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PQtystrICzfgcXCbPNOxSnGwfsEUv3vcGmSk8K5WBTNVuHYEGicSQfRP8bvrGDCFsNoUMSTCibSE9iczVTY5HV1Hg/132","comment_is_top":false,"comment_ctime":1599122205,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599122205","product_id":100020801,"comment_content":"这一系列文章，十分切题 -- “实战”，这才是我们真正想看到的实战教学","like_count":0},{"had_liked":false,"id":245385,"user_name":"考拉出山","can_delete":false,"product_type":"c1","uid":1303954,"ip_address":"","ucode":"917E35FD7B2D06","user_header":"https://wx.qlogo.cn/mmopen/vi_32/1mOvT5fApeicXppMP3zADG6XIPicNt5D9dL6y46SF5UUcH0hicG21LM6xSgHJj5oAdzCyeGtLZYHYmlvaFwecrGOA/132","comment_is_top":false,"comment_ctime":1598929116,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598929116","product_id":100020801,"comment_content":"图3 图4 的假设似乎有之前讲都mvcc 版本管理对应不起来，因为就算不是假设那样加锁，用mvcc版本管理去推，也推不出“文中那个数据一致性的结果”。图3 图4 的假设总是让 一个session 的语句在 commit的时候再去对数据进行操作，无论语句发生的时刻。就好比所有的session 语句根据commit时间点再串行执行一样。","like_count":0},{"had_liked":false,"id":245380,"user_name":"考拉出山","can_delete":false,"product_type":"c1","uid":1303954,"ip_address":"","ucode":"917E35FD7B2D06","user_header":"https://wx.qlogo.cn/mmopen/vi_32/1mOvT5fApeicXppMP3zADG6XIPicNt5D9dL6y46SF5UUcH0hicG21LM6xSgHJj5oAdzCyeGtLZYHYmlvaFwecrGOA/132","comment_is_top":false,"comment_ctime":1598928511,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598928511","product_id":100020801,"comment_content":"&quot;图 3 假设只在 id=5 这一行加行锁 -- 数据一致性问题&quot; 然后得出结论“所有d=5的行，d改成100”这个得出结论的过程都是假设或者意想出来的吗？ 还是我理解的不对？ 。 根据假设，仅仅让id=5这一行加锁，那么把隔离级别切换到 rc（rc就是会发生幻读），依据图3 的流程去执行，所有的session 都没有发生阻塞，结果也不会和推论那样“所有d=5的行，d改成100”, 所以这里有两个疑问：1. 是不是文章中关于这个推论没有说清楚。 2： 如果这个推论是依据事实推出来的，也就是只给id=5加锁会出错，那么rc级别下又做了什么处理让结果符合预期呢？","like_count":0},{"had_liked":false,"id":244486,"user_name":"mumu","can_delete":false,"product_type":"c1","uid":1371095,"ip_address":"","ucode":"E409BDA36091A3","user_header":"https://static001.geekbang.org/account/avatar/00/14/eb/d7/712912a7.jpg","comment_is_top":false,"comment_ctime":1598533555,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598533555","product_id":100020801,"comment_content":"老师您好，请问，可重复读情况下，非索引字段加锁是行锁+间隙锁锁住全表的，为什么没有升级为表锁呢？请问什么情况下行锁会升级为表锁？","like_count":0},{"had_liked":false,"id":243715,"user_name":"moonfox","can_delete":false,"product_type":"c1","uid":1526355,"ip_address":"","ucode":"902BFF40EFA9FA","user_header":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","comment_is_top":false,"comment_ctime":1598255650,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1598255650","product_id":100020801,"comment_content":"在Session A 中执行 begin; select * from t where c=5 for update;事务未提交。在Session B：begin;执行 update t set c= 10 where id =0;被阻塞。但执行  update t set c= 10 where id =25;成功执行，请问这是为什么呀？","like_count":0,"discussions":[{"author":{"id":1346546,"avatar":"https://static001.geekbang.org/account/avatar/00/14/8b/f2/a6abbe45.jpg","nickname":"笼鱼","note":"","ucode":"CED5914D2C2964","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301596,"discussion_content":"session A 当前读会锁住(0,0~5,5],(5~5,10~10),session b相当于把(0,0)->(0,5)这是在next-lock范围之内的，而update t set c= 10 where id =25是把(25,25)->(25,10)这是在next-lock范围之外的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598584654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":242422,"user_name":"FRJ","can_delete":false,"product_type":"c1","uid":1907433,"ip_address":"","ucode":"213342BBC39600","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/4Ih0qGQzLOtPwEk6CtUshSn9jOmfH3qmoXH6on2RGXRUsNoAWZgLy26zh2CvWeXoYhX6U5bztWKMicVib9VyzYhA/132","comment_is_top":false,"comment_ctime":1597717988,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597717988","product_id":100020801,"comment_content":"读已提交与可重复读的区别是读已提交在同一个事务中不保证每次读的结果都一致，可以读到其他事务新commit的且符合查询条件的结果，但是可重复读隔离级别需要保证同一个事务中每次读的结果都一致，如果事务只对符合查询条件的记录加上锁，新插入的符合查询条件的行并不会被加锁，则这个事务加锁的语义被破坏了，（如果当前事务需要对符合查询条件的行进行当前读并修改，但是RR隔离级别并不支持读到启动视图后新增加的结果，则冲突了），所以RR隔离级别在有索引的条件下需要将在事务中可能导致冲突的间隙与记录全部加锁，以保证加锁语义的正确性与文章中分析的binlog的问题。<br>因为RR隔离级别要保证这个特性，所以加的锁比读已提交的多，所以事务的并发度更差。","like_count":0},{"had_liked":false,"id":240529,"user_name":"梦楼","can_delete":false,"product_type":"c1","uid":2093516,"ip_address":"","ucode":"2D0F3050ACC091","user_header":"https://static001.geekbang.org/account/avatar/00/1f/f1/cc/3bd32c6f.jpg","comment_is_top":false,"comment_ctime":1596961331,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1596961331","product_id":100020801,"comment_content":"“这样，当你执行 select * from t where d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。”<br>这句话说的不对，执行“select * from t where d=5 for update”，并没有加了7个间隙锁，仅仅对(0,5],(5,10)加锁了。","like_count":0,"discussions":[{"author":{"id":1246200,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/f8/55554b12.jpg","nickname":"kai","note":"","ucode":"CFDC240DA364FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297690,"discussion_content":"d是没有加索引的字段，需要扫描整个索引的，所以会加上7个间隙锁，你自己测试一下就知道了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597024913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":240528,"user_name":"梦楼","can_delete":false,"product_type":"c1","uid":2093516,"ip_address":"","ucode":"2D0F3050ACC091","user_header":"https://static001.geekbang.org/account/avatar/00/1f/f1/cc/3bd32c6f.jpg","comment_is_top":false,"comment_ctime":1596961255,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596961255","product_id":100020801,"comment_content":"“这样，当你执行 select * from t where d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。”","like_count":0},{"had_liked":false,"id":240316,"user_name":"木羊","can_delete":false,"product_type":"c1","uid":1196120,"ip_address":"","ucode":"DBD5A16E4F2EDD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJ5Aicia5agFotqo6Gm7IUv1rwkdJMCss4dZpx8BnNe7F9K8sOncYdhAZDvgN1dicEwa7f1qksplVN3g/132","comment_is_top":false,"comment_ctime":1596858501,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596858501","product_id":100020801,"comment_content":"间隙锁和间隙锁之间，如果是插入会有冲突，那么删除呢，删除同一个间隙的数据会有冲突吗？","like_count":0},{"had_liked":false,"id":237615,"user_name":"jugg","can_delete":false,"product_type":"c1","uid":1639286,"ip_address":"","ucode":"3CD779C93609CF","user_header":"https://static001.geekbang.org/account/avatar/00/19/03/76/55df3b09.jpg","comment_is_top":false,"comment_ctime":1595901513,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595901513","product_id":100020801,"comment_content":"老师，请问一个问题。听过一个说法，在 rc 级别下，同一个事务里面 select 语句是快照读，update和 insert 语句是当前读。不知道这个说法有没有什么问题<br>","like_count":0},{"had_liked":false,"id":237209,"user_name":"yesir","can_delete":false,"product_type":"c1","uid":1017689,"ip_address":"","ucode":"CFFE7D36ADBEBA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/59/b457f370.jpg","comment_is_top":false,"comment_ctime":1595738985,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595738985","product_id":100020801,"comment_content":"老师，看你前面的回复说有了Mdl锁，意向锁没有作用，是什么意思啊，那MySQL意向锁是完全没意义了吗，那为什么要设计出来","like_count":0},{"had_liked":false,"id":236926,"user_name":"毒草","can_delete":false,"product_type":"c1","uid":1026090,"ip_address":"","ucode":"DBD67DD3517190","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a8/2a/316b8f17.jpg","comment_is_top":false,"comment_ctime":1595588357,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595588357","product_id":100020801,"comment_content":"思考题 (图9) mysql 8.0 下测试, session C执行成功. 老师能说一下吗","like_count":0},{"had_liked":false,"id":232729,"user_name":"世默","can_delete":false,"product_type":"c1","uid":1148513,"ip_address":"","ucode":"3536944F69B21F","user_header":"https://static001.geekbang.org/account/avatar/00/11/86/61/4875efb7.jpg","comment_is_top":false,"comment_ctime":1594103584,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1594103584","product_id":100020801,"comment_content":"老师我想请教下 为什么mysql有mvcc机制可以实现类似快照的功能解决幻读，那为什么还要引入间歇锁呢？","like_count":0,"discussions":[{"author":{"id":2366248,"avatar":"https://static001.geekbang.org/account/avatar/00/24/1b/28/3e7a2916.jpg","nickname":"那那那","note":"","ucode":"04FD2412BB30D3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389463,"discussion_content":"默认的是用快照MVCC就可以解决了，另外一种场景是这种举例的显示加锁的场景快照无法解决的，这就是next-key locking的场景","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629283177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232493,"user_name":"吉吉","can_delete":false,"product_type":"c1","uid":1126111,"ip_address":"","ucode":"5A5DAB5B49D0F1","user_header":"https://static001.geekbang.org/account/avatar/00/11/2e/df/59725073.jpg","comment_is_top":false,"comment_ctime":1594018570,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1594018570","product_id":100020801,"comment_content":"版本号5.7.15，实际测试是sessionB锁住了，sessionC正常执行，没有被锁住。。。。。。","like_count":0},{"had_liked":false,"id":231872,"user_name":"melo","can_delete":false,"product_type":"c1","uid":1030449,"ip_address":"","ucode":"BF381B18E75867","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b9/31/636e9007.jpg","comment_is_top":false,"comment_ctime":1593793475,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593793475","product_id":100020801,"comment_content":"面试问到了，忘了，特地又来看一下，理解了百分之95","like_count":0},{"had_liked":false,"id":231322,"user_name":"Ken","can_delete":false,"product_type":"c1","uid":1120761,"ip_address":"","ucode":"9F829156E855C8","user_header":"https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg","comment_is_top":false,"comment_ctime":1593651973,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1593651973","product_id":100020801,"comment_content":"需要请教老师的，经典的数据库教程(不特指MySQL)，RR是不能解决幻读的，幻读由序列化隔离级别保证。是否可以理解，MySQL在RR引入间隙锁在RR下，是为了保证一定的并发性能的情况下解决，是一种vendor-custom的优化呢？","like_count":0,"discussions":[{"author":{"id":1120761,"avatar":"https://static001.geekbang.org/account/avatar/00/11/19/f9/62ae32d7.jpg","nickname":"Ken","note":"","ucode":"9F829156E855C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289343,"discussion_content":"期待老师的解答","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594076631,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231160,"user_name":"jiaozhuchen","can_delete":false,"product_type":"c1","uid":1510471,"ip_address":"","ucode":"65A696D75C0577","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI9cqxrtYLlu0XvlU6J7LwEn67cL9fbnJrI6UjankWwbhiaeDQ8fI2LtjMMVMFIGKSlUyeKmN29SMg/132","comment_is_top":false,"comment_ctime":1593595602,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1593595602","product_id":100020801,"comment_content":"老师，今天文章有两个疑问想请教一下<br>1.InnoDB 在可重复读隔离下有间隙锁，您举的第一个例子，在update时是应该被锁住的，但例子中没有锁住，是因为您设置的是RC隔离级别吗？<br>2.既然InnoDB在RR隔离级别下，间隙锁就是用来解决幻读问题的，是不是可以理解虽然的SQL的标准RR隔离级别下有幻读存在，但InnoDB存储引擎，RR隔离级别不存在幻读？","like_count":0,"discussions":[{"author":{"id":1346546,"avatar":"https://static001.geekbang.org/account/avatar/00/14/8b/f2/a6abbe45.jpg","nickname":"笼鱼","note":"","ucode":"CED5914D2C2964","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301598,"discussion_content":"1.老师标明了是假设的场景\n2.老师在其他问题下回答过：可重复读+间隙锁解决","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598584936,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":228245,"user_name":"Geek_9d8be5","can_delete":false,"product_type":"c1","uid":1742868,"ip_address":"","ucode":"20181C54A2C589","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/JVOiclOoyFvgJHNXRgqB9RDyDueBHEP5lwATC47nFXRJibtK8ibU8phJPiav3BsPCUAssM1X82mnGtEe7bF91p39eA/132","comment_is_top":false,"comment_ctime":1592622942,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592622942","product_id":100020801,"comment_content":"老师，问一个衍生出来的问题。<br>一个库存表，并发量大的情况下 使用 <br>update stock_table set stock = stock - 1;<br>为什么这个也会出现库存异常问题呢 ?<br>(我觉得下面这个语句正确并且不会增加排他锁影响效率)","like_count":0},{"had_liked":false,"id":228094,"user_name":"大空翼","can_delete":false,"product_type":"c1","uid":1523795,"ip_address":"","ucode":"B56CB3F3B1B407","user_header":"","comment_is_top":false,"comment_ctime":1592553202,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592553202","product_id":100020801,"comment_content":"mysql 8.0 session A insert会阻塞住，然后session B提交执行成功，session A提示主键冲突,不会报死锁","like_count":0},{"had_liked":false,"id":227865,"user_name":"JC","can_delete":false,"product_type":"c1","uid":1227913,"ip_address":"","ucode":"2608394E5DA212","user_header":"https://static001.geekbang.org/account/avatar/00/12/bc/89/99bf7952.jpg","comment_is_top":false,"comment_ctime":1592498024,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592498024","product_id":100020801,"comment_content":"图4和图3都一样，图4怎么就是给所有行都加上了锁？","like_count":0},{"had_liked":false,"id":226833,"user_name":"图灵机","can_delete":false,"product_type":"c1","uid":2034632,"ip_address":"","ucode":"EB02DB653AD591","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0b/c8/15f055d3.jpg","comment_is_top":false,"comment_ctime":1592212900,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1592212900","product_id":100020801,"comment_content":"为什么RC级别加binlog_format  row 可以解决数据和日志数据一致性问题","like_count":0},{"had_liked":false,"id":224644,"user_name":"大鹏","can_delete":false,"product_type":"c1","uid":1118211,"ip_address":"","ucode":"6A16A2B2E9D61B","user_header":"https://static001.geekbang.org/account/avatar/00/11/10/03/9ea1ce01.jpg","comment_is_top":false,"comment_ctime":1591495973,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591495973","product_id":100020801,"comment_content":"那怎么改呢？我们把扫描过程中碰到的行，也都加上写锁，再来看看执行效果。——这句话是怎么加的写锁，我看跟之前的语句一样啊","like_count":0},{"had_liked":false,"id":223644,"user_name":"Anthony","can_delete":false,"product_type":"c1","uid":1309908,"ip_address":"","ucode":"9E0C98A9123365","user_header":"https://static001.geekbang.org/account/avatar/00/13/fc/d4/743d3f02.jpg","comment_is_top":false,"comment_ctime":1591147692,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591147692","product_id":100020801,"comment_content":"老师，您说的行锁的冲突，我理解的是读锁和写锁之间应该是不冲突的吧,为什么您那儿写的读锁和写锁也是冲突的呢？","like_count":0},{"had_liked":false,"id":223114,"user_name":"shiziwen","can_delete":false,"product_type":"c1","uid":1016917,"ip_address":"","ucode":"ADADC770D82D66","user_header":"https://static001.geekbang.org/account/avatar/00/0f/84/55/1e40bd61.jpg","comment_is_top":false,"comment_ctime":1591003789,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591003789","product_id":100020801,"comment_content":"文中提到“当你执行 select * from t where d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁”，这里的间隙锁，是针对主键id而言，还是针对针对二级索引c而言的呢？文中例子，id和c的值是一样的，所以不太明白。<br>因此，在判断文中例子session会占用哪些间隙锁时，也就没有明白。<br><br>另外，判断间隙锁时，是根据语句，找到相应的主键或者索引（前提是搞清楚间隙锁时针对谁而言的），然后判断其区间，进而得出间隙锁的范围，是吧？<br>","like_count":0},{"had_liked":false,"id":220055,"user_name":"f(x)","can_delete":false,"product_type":"c1","uid":1224568,"ip_address":"","ucode":"3680BBD50AFAE4","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/78/07d3e282.jpg","comment_is_top":false,"comment_ctime":1590145436,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1590145436","product_id":100020801,"comment_content":"老师，您讲到可重复读级别下才用间隙锁解决幻读，那么串行化级别下，select*from table where id&gt;10; 这种范围查询加的是什么锁呢？","like_count":0,"discussions":[{"author":{"id":1346546,"avatar":"https://static001.geekbang.org/account/avatar/00/14/8b/f2/a6abbe45.jpg","nickname":"笼鱼","note":"","ucode":"CED5914D2C2964","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301600,"discussion_content":"串行化不存在并发不需要加锁了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598585056,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":220015,"user_name":"f(x)","can_delete":false,"product_type":"c1","uid":1224568,"ip_address":"","ucode":"3680BBD50AFAE4","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/78/07d3e282.jpg","comment_is_top":false,"comment_ctime":1590135548,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590135548","product_id":100020801,"comment_content":"老师，我有点迷，这篇文章说了可重复读级别下引入间隙锁去解决幻读，但是以往的认识，可重复读是无法完全解决幻读的，串行化级别才可以呀","like_count":0},{"had_liked":false,"id":217908,"user_name":"Geek_e5d39f","can_delete":false,"product_type":"c1","uid":1546081,"ip_address":"","ucode":"A4712DE9721E06","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoV7kTQGEFG101jDKycJ4AroKgTn7oicvbaia4ibk7uElZLjKe6SFoQicuvsJodHibZiazsdraiae0qhuzZg/132","comment_is_top":false,"comment_ctime":1589644057,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589644057","product_id":100020801,"comment_content":"所以是不是可以理解为innodb在可重复读的情况下不会发生幻读？","like_count":0},{"had_liked":false,"id":217504,"user_name":"我又换头像了","can_delete":false,"product_type":"c1","uid":1303223,"ip_address":"","ucode":"81579314EF5E1E","user_header":"https://static001.geekbang.org/account/avatar/00/13/e2/b7/f1cc453c.jpg","comment_is_top":false,"comment_ctime":1589519947,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589519947","product_id":100020801,"comment_content":"老师有讲过mvcc多版本并发控制吗，看了一下目录好像没发现啊","like_count":0},{"had_liked":false,"id":216581,"user_name":"醉、随风🙄 🙄","can_delete":false,"product_type":"c1","uid":1219433,"ip_address":"","ucode":"FDDFE9827FD64B","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/69/943dfd5c.jpg","comment_is_top":false,"comment_ctime":1589289359,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1589289359","product_id":100020801,"comment_content":"老师，我有个问题，这条语句select * from t where d=5 for update; ，字段d没有索引，那这一条语句还会加行锁吗","like_count":0,"discussions":[{"author":{"id":1346546,"avatar":"https://static001.geekbang.org/account/avatar/00/14/8b/f2/a6abbe45.jpg","nickname":"笼鱼","note":"","ucode":"CED5914D2C2964","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301601,"discussion_content":"扫描主键会把所有行锁和间隙锁都加上","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598585143,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210453,"user_name":"傲慢与偏见","can_delete":false,"product_type":"c1","uid":1028778,"ip_address":"","ucode":"1E1E93BE6142E0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b2/aa/8a74401f.jpg","comment_is_top":false,"comment_ctime":1587746756,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587746756","product_id":100020801,"comment_content":"我想问一下，在RR模式，不管是 快照读（select * from t），还是当前读取(select * from t where xx for update),在并发的时候都会产生异常（一个是dup key,一个是dead lock），那用于不用有什么区别呢","like_count":0},{"had_liked":false,"id":208346,"user_name":"鲁班大师","can_delete":false,"product_type":"c1","uid":1179156,"ip_address":"","ucode":"4F9615DF87B031","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/14/f1532dec.jpg","comment_is_top":false,"comment_ctime":1587343334,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1587343334","product_id":100020801,"comment_content":"老师，什么业务场景需要使用select...forupdate和lock in share model。感觉平时都用不到这两种语句","like_count":0,"discussions":[{"author":{"id":1657055,"avatar":"https://static001.geekbang.org/account/avatar/00/19/48/df/5359b4fc.jpg","nickname":"雨落本无晴","note":"","ucode":"E64A60649544B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304879,"discussion_content":"update xxx where 和 select ... for update 效果是一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599705696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207627,"user_name":"鱼丸粗面","can_delete":false,"product_type":"c1","uid":1805050,"ip_address":"","ucode":"F91B7535C2A8BE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/8a/fa/6c0a3826.jpg","comment_is_top":false,"comment_ctime":1587122417,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587122417","product_id":100020801,"comment_content":"老师，我想请教下delete操作的执行顺序。<br>delete c1 from tb where xx=1;<br>1. 当xx是主键索引时，如何加锁？<br>2. 当xx是非主键索引时，如何加锁？<br>3.当xx不是索引字段时，如何加锁？<br>4. delete有没有幻读的情况？如果有，是不是也会本文中讲的update一样，通过加next-key-lock锁避免了幻读？<br>5. 如果根据非索引字段匹配到了多条记录，是如何执行删除的？我的理解是：由于没有索引，需要全表加next-key-lock锁，然后开始检索，查到符合条件的一行后，删除，然后再继续查询，直到找不到满足条件的行（这里应该是全表扫描完吧，因为没有索引）？<br>希望老师指导一下，谢谢。","like_count":0},{"had_liked":false,"id":207228,"user_name":"妥协","can_delete":false,"product_type":"c1","uid":1249656,"ip_address":"","ucode":"7201DFE9C12669","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/78/4f0cd172.jpg","comment_is_top":false,"comment_ctime":1587029047,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587029047","product_id":100020801,"comment_content":"串行化隔离级别下，读加读锁，写加写锁。那也会存在幻读的问题吧？","like_count":0},{"had_liked":false,"id":206288,"user_name":"TIAN","can_delete":false,"product_type":"c1","uid":1276795,"ip_address":"","ucode":"CCCF80602C1753","user_header":"https://static001.geekbang.org/account/avatar/00/13/7b/7b/5b39b47b.jpg","comment_is_top":false,"comment_ctime":1586835013,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586835013","product_id":100020801,"comment_content":"请问老师或者别的同学一个问题，for update是写锁，这个我名表了，但是lock in share mode除了是当前读还有什么用处？我试验session1如果用了lock in share mode，session2的读写都没受什么影响，也许我没测试到位。另外就是如果for update是用在非索引字段怎么感觉像表锁一样了？是这样么？","like_count":0,"discussions":[{"author":{"id":1346546,"avatar":"https://static001.geekbang.org/account/avatar/00/14/8b/f2/a6abbe45.jpg","nickname":"笼鱼","note":"","ucode":"CED5914D2C2964","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301602,"discussion_content":"1.lock in share mode会加s锁，会和x锁冲突\n2.for update用在非索引字段会扫描主键把所有行锁和间隙锁都加上","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598585282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201357,"user_name":"快乐冲浪","can_delete":false,"product_type":"c1","uid":1034956,"ip_address":"","ucode":"B9ADE3D8AA7B59","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ca/cc/d082da9b.jpg","comment_is_top":false,"comment_ctime":1585755248,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1585755248","product_id":100020801,"comment_content":"看完两遍之后。没动手实践。疑问是 在讲innodb如何解决幻读之前的都是假设吗？也就是说innodb通过间隙锁➕行锁解决了幻读。前面的假设 是不会发生的吗？","like_count":0,"discussions":[{"author":{"id":1657055,"avatar":"https://static001.geekbang.org/account/avatar/00/19/48/df/5359b4fc.jpg","nickname":"雨落本无晴","note":"","ucode":"E64A60649544B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304880,"discussion_content":"是的，默认级别 RR 下不会发生","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599705730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201297,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1585747149,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585747149","product_id":100020801,"comment_content":"看的时候是抽丝剥茧 渐入佳境 刚看完是回味无穷 隔一会就感觉忘记讲啥了 哎 这可怕的记性","like_count":0},{"had_liked":false,"id":193604,"user_name":"张sir","can_delete":false,"product_type":"c1","uid":1209431,"ip_address":"","ucode":"52958DF6705208","user_header":"https://static001.geekbang.org/account/avatar/00/12/74/57/7b828263.jpg","comment_is_top":false,"comment_ctime":1584932665,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1584932665","product_id":100020801,"comment_content":"老师，有个问题，为什么间隙锁是5个一组呢，比如(5,10] 这是范围是可配置的吗","like_count":0,"discussions":[{"author":{"id":1022091,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/8b/7a691d53.jpg","nickname":"HungerW","note":"","ucode":"75689EDF0F8E7F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275873,"discussion_content":"因为例子的数据是这样间隔的。不是说mysql固定按5的间隔，是根据具体数据来的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590766589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192745,"user_name":"ward-wolf","can_delete":false,"product_type":"c1","uid":1031845,"ip_address":"","ucode":"BC41D01301263A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/a5/df917d18.jpg","comment_is_top":false,"comment_ctime":1584870670,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584870670","product_id":100020801,"comment_content":"老师请问mysql是在哪个版本以后引入了间隙锁？","like_count":0},{"had_liked":false,"id":192538,"user_name":"努力努力再努力","can_delete":false,"product_type":"c1","uid":1493907,"ip_address":"","ucode":"0C6EEA28FCE8C7","user_header":"https://static001.geekbang.org/account/avatar/00/16/cb/93/4adea49a.jpg","comment_is_top":false,"comment_ctime":1584858601,"is_pvip":true,"discussion_count":4,"race_medal":0,"score":"1584858601","product_id":100020801,"comment_content":"老师，想问问，当事务A执行 select * from t where c = 5 for update; 时，锁住的只会是 (0,5) 和 (5,10) ，此时为啥要堵塞住事务B insert (7,7,7) 呢？ 这样好像并不会影响事务A的查询结果","like_count":0,"discussions":[{"author":{"id":1022091,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/8b/7a691d53.jpg","nickname":"HungerW","note":"","ucode":"75689EDF0F8E7F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275881,"discussion_content":"间隙锁应该可以理解成悲观锁。因为MySQL不知道你接下来会插入5，还是6，或者7，干脆就把整个区间锁了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590766859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1667987,"avatar":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","nickname":"Ryan","note":"","ucode":"95BBBEE5B23878","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":218667,"discussion_content":"因为你要插入的 7在那个区间里啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585669320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1493907,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cb/93/4adea49a.jpg","nickname":"努力努力再努力","note":"","ucode":"0C6EEA28FCE8C7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1667987,"avatar":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","nickname":"Ryan","note":"","ucode":"95BBBEE5B23878","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":219386,"discussion_content":"emm，我知道在区间里，但是间隙锁的目的是为了防止幻读，此时插入7这条数据，并不会影响事务 A 对应 SQL的查询结果吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585753131,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":218667,"ip_address":""},"score":219386,"extra":""},{"author":{"id":1238436,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e5/a4/e16dca6a.jpg","nickname":"阿凯文","note":"","ucode":"F17CF201E74849","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1493907,"avatar":"https://static001.geekbang.org/account/avatar/00/16/cb/93/4adea49a.jpg","nickname":"努力努力再努力","note":"","ucode":"0C6EEA28FCE8C7","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":561716,"discussion_content":"因为你有可能将777update成757","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649701622,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":219386,"ip_address":""},"score":561716,"extra":""}]}]},{"had_liked":false,"id":185145,"user_name":"乔丹","can_delete":false,"product_type":"c1","uid":1217413,"ip_address":"","ucode":"D832A9F97A0C7E","user_header":"https://static001.geekbang.org/account/avatar/00/12/93/85/f5d9474c.jpg","comment_is_top":false,"comment_ctime":1583495184,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583495184","product_id":100020801,"comment_content":"间隙锁和 next-key lock 来解决幻读的问题，我的理解就是for update就会使用next-key lock。将间隙和符合条件的行都锁住。","like_count":0},{"had_liked":false,"id":183526,"user_name":"Chan","can_delete":false,"product_type":"c1","uid":1158920,"ip_address":"","ucode":"8A7151A7E3F5D1","user_header":"https://static001.geekbang.org/account/avatar/00/11/af/08/49416831.jpg","comment_is_top":false,"comment_ctime":1583058927,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583058927","product_id":100020801,"comment_content":"思考题想了半天才想明白<br>order asc 或者不order，从=15开始扫描到了25，25的next-key lock是 （20, 25]。<br>order desc, 从=20开始，扫描到了10，10的next-key lock是(5, 10]。<br><br>所以按规则来是对的。<br>“多出来”的(5，10]是10的next-key lock造成的。<br>为什么会多出来？由于 x 的next-key lock定义为 (x上一个元素，x], 这个方向与desc违背，造成（5，10]是多余的，MySQL没做优化把它去掉。","like_count":0},{"had_liked":false,"id":180918,"user_name":"泊","can_delete":false,"product_type":"c1","uid":1557092,"ip_address":"","ucode":"3E9275288F1B0D","user_header":"https://static001.geekbang.org/account/avatar/00/17/c2/64/5cd6efa0.jpg","comment_is_top":false,"comment_ctime":1582442666,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1582442666","product_id":100020801,"comment_content":"有个问题，rr情况下是会产生幻读的吗？rr情况下间隙锁存在的话不就是不会产生幻读得了吗？还是在rr下间隙锁可以设置是否打开啊？有点懵逼。希望有人能回答下","like_count":0,"discussions":[{"author":{"id":1557092,"avatar":"https://static001.geekbang.org/account/avatar/00/17/c2/64/5cd6efa0.jpg","nickname":"泊","note":"","ucode":"3E9275288F1B0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":182626,"discussion_content":"还是说select...for  update   有for update才会生成间隙锁，避免幻读现象。如果没有for update 就会产生幻读吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582442903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180567,"user_name":"Geek_f2f3c7","can_delete":false,"product_type":"c1","uid":1436184,"ip_address":"","ucode":"96C65202E9D12C","user_header":"https://static001.geekbang.org/account/avatar/00/15/ea/18/80c24d33.jpg","comment_is_top":false,"comment_ctime":1582338006,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582338006","product_id":100020801,"comment_content":"1 老师我想知道for update是什么锁啊，是不是排它锁<br>2 shar lock是共享锁，共享锁是不允许加排它锁的<br>而老师在图7是sessionB却在共享锁后加上了排它锁，可以吗？","like_count":0},{"had_liked":false,"id":180318,"user_name":"ipofss","can_delete":false,"product_type":"c1","uid":1018620,"ip_address":"","ucode":"DE3061C9259F9E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","comment_is_top":false,"comment_ctime":1582256007,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582256007","product_id":100020801,"comment_content":"幻读，是发生在可重复读级别下。在同一个事务内，后一次读到的数据比前一次多，就是幻读。<br>若只加指定的行锁，会有其他事务提交修改与插入，造成同一事务内，读取结果前后不一致。<br>若把全部的行加锁，会有其他事务插入，造成同一事务内，后一次比前一次读记录多。<br>同时锁住全部行，并且加间隙锁（GapLock），在该事务内，其他事务的修改与插入只能等待，可以保证数据的前后一致性。<br>间隙锁的缺点，降低并发读，由于间隙锁之间不互斥，可能会造成2个事务相互等待，而出现死锁。","like_count":0},{"had_liked":false,"id":176042,"user_name":"西北偏北","can_delete":false,"product_type":"c1","uid":1442334,"ip_address":"","ucode":"756FB230C53F9A","user_header":"https://static001.geekbang.org/account/avatar/00/16/02/1e/2816c98e.jpg","comment_is_top":false,"comment_ctime":1580917346,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580917346","product_id":100020801,"comment_content":"一直用oracle，前段时间看完一本书（收获，不止Oracle）感觉对数据库有点原理有点新的认识；希望对数据库有更深入的认识；之前一直觉得MySQL和Oracle是差不多的，不需要花费时间额外了解，抱着试试看的心态看的这门课，学习下来感觉真的是收获颇丰。","like_count":0},{"had_liked":false,"id":176002,"user_name":"forever","can_delete":false,"product_type":"c1","uid":1574051,"ip_address":"","ucode":"3EBCD4AB045880","user_header":"https://static001.geekbang.org/account/avatar/00/18/04/a3/95de9a19.jpg","comment_is_top":false,"comment_ctime":1580908526,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1580908526","product_id":100020801,"comment_content":"好多读几遍好好品","like_count":0},{"had_liked":false,"id":169513,"user_name":"小码渣","can_delete":false,"product_type":"c1","uid":1723655,"ip_address":"","ucode":"8432409D9616D1","user_header":"https://static001.geekbang.org/account/avatar/00/1a/4d/07/7d331b04.jpg","comment_is_top":false,"comment_ctime":1578367715,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578367715","product_id":100020801,"comment_content":"图3 和 图 4之间 ,是怎么给每一行扫描过的记录都加上锁的 ? ","like_count":0},{"had_liked":false,"id":169073,"user_name":"Socket","can_delete":false,"product_type":"c1","uid":1313213,"ip_address":"","ucode":"932CF3D692FFB5","user_header":"https://static001.geekbang.org/account/avatar/00/14/09/bd/cc31c95d.jpg","comment_is_top":false,"comment_ctime":1578271045,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1578271045","product_id":100020801,"comment_content":"老师我有个问题。如果这么说gap lock是为了姐姐幻读问题。那么在可重复读级别+gap lock是否就解决了幻读？不再需要串行化级别","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":138574,"discussion_content":"1：解决了幻读怎么会推出不需要串行化呢，串行化只是隔离级别而已，换句话说，串行化存在的原因和幻读也没什么关系啊（应该是对业务需求的）。\n2：我觉得可以这么说，如果业界绝对不会使用到串行化的场景，那可能就真的不需要串行化的隔离级别了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579254047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":168870,"user_name":"Zhaoyang","can_delete":false,"product_type":"c1","uid":1037190,"ip_address":"","ucode":"131D83AC2566D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d3/86/b5d72c87.jpg","comment_is_top":false,"comment_ctime":1578207666,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1578207666","product_id":100020801,"comment_content":"哦哦，间隙锁是读锁啊！别人都能抢占","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":138576,"discussion_content":"不分读写，就是很单纯的&#34;锁&#34;我理解。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579254080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":168583,"user_name":"Zhaoyang","can_delete":false,"product_type":"c1","uid":1037190,"ip_address":"","ucode":"131D83AC2566D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d3/86/b5d72c87.jpg","comment_is_top":false,"comment_ctime":1578115550,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578115550","product_id":100020801,"comment_content":"面试遇到过，什么是幻读，什么是脏读，没有回答好","like_count":0},{"had_liked":false,"id":161048,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1576109917,"is_pvip":true,"discussion_count":1,"race_medal":1,"score":"1576109917","product_id":100020801,"comment_content":"索引列和非索引列产生间隙锁 的规则是不是不一样的？<br><br>把文中例子中 字段  c 替换为 字段 d ，会出现不一样的结果","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162359,"discussion_content":"我认为规则是一样的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580987350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":160490,"user_name":"李旭光","can_delete":false,"product_type":"c1","uid":1557061,"ip_address":"","ucode":"826EE6F1A2B063","user_header":"https://static001.geekbang.org/account/avatar/00/17/c2/45/251663e6.jpg","comment_is_top":false,"comment_ctime":1575963205,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575963205","product_id":100020801,"comment_content":"关于文章的几点疑问：<br>1. SELECT * from t WHERE d=5 for update;的语义问题<br>   实验结果：READ COMMITTED隔离级别下有行锁无间隙锁，因此session A不会阻塞update t set d=5 where id=0;或INSERT into t VALUES (1,1,5)<br>   问题：文中所说的“我要把所有 d=5 的行锁住，不准别的事务进行读写操作”的语义在READ COMMITTED级别下不成立吗？<br>   <br>2. “数据和日志在逻辑上的一致性”的问题<br>文章归纳：isolation level=REPEATABLE READ，binlog_format=STATEMENT时，若无行锁无间隙锁，并行的事务会因提交时序不同导致数据和日志在逻辑上不一致。因此引入行锁+间隙锁<br>个人理解：<br>  假设A：isolation level=READ COMMITTED时，mysql也需要保证binlog_format=STATEMENT时的数据和binlog一致性<br>  结论A：在READ COMMITTED级别下也需要行锁、间隙锁<br>  <br>  假设B：不论何种隔离级别，只要设置binlog_format=ROW，数据和binlog在逻辑上就会保持一致<br>  结论B：isolation level=Repeatable Read时，只要设置binlog_format=ROW，那么就可以将innodb_locks_unsafe_for_binlog设置为1以禁用gap lock<br>以上的两组假设、结论是否成立呢？错误的点在哪里呢？","like_count":0},{"had_liked":false,"id":158804,"user_name":"靠人品去赢","can_delete":false,"product_type":"c1","uid":1301286,"ip_address":"","ucode":"7A20F9EBE847E1","user_header":"https://static001.geekbang.org/account/avatar/00/13/db/26/54f2c164.jpg","comment_is_top":false,"comment_ctime":1575455270,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575455270","product_id":100020801,"comment_content":"老师，我看别的地方说是新增或者删除（数据条数变化）导致的结果不同的叫做幻读。<br>你也强调“新插入的”这个，但是看例子，我觉得应该是当前应该锁住行数，和实际操作（实际上新增，更改，删除都会影响到应该锁住的行数）引起的应该锁住的行数变化，引起的查询结果不同导致的是幻读。<br>总是突出“新插入”感觉注意点都是在插入上了。","like_count":0},{"had_liked":false,"id":158197,"user_name":"冬日里的阳光","can_delete":false,"product_type":"c1","uid":1367915,"ip_address":"","ucode":"EA1630A16AD2B6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/WUj9OyyKJ7tSNXW9e6hn2ZibzDCuSOV0uDpyVJf8iaPB5JhbGpPdNpOkKRic8ErOd9OuFicw4OxjdSxywAcia6bibHMQ/132","comment_is_top":false,"comment_ctime":1575345614,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1575345614","product_id":100020801,"comment_content":"林老师你好，我想问一下，今天我在使用Spring + mybatis测试mysql的不可重复读时，用REPEATABLE_READ来解决不可重复读的时候发现，事务1两次读数据前后结果一致，但是明显事务2在中间进行了修改，既然第二次读到的数据都是个错的数据，那这样的一致有什么样的意义呢，或者说什么样的场景才需要这样的一致，我在网上有看到说REPEATABLE_READ会让事务之间阻塞，但是实测的时候是并发执行的，就没发理解这个隔离级别的作用了","like_count":0,"discussions":[{"author":{"id":1437292,"avatar":"https://static001.geekbang.org/account/avatar/00/15/ee/6c/246fa0d1.jpg","nickname":"Mr.差不多","note":"","ucode":"946555FCAE710B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297928,"discussion_content":"我觉得你说的会在事务之间阻塞，是当前读的情况下会发生吧，你的多次读是不是都是简单的 select 操作？没有加for update 或者 lock in share mode","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597112778,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":150537,"user_name":"🍒古刹飞鹰🍒","can_delete":false,"product_type":"c1","uid":1666659,"ip_address":"","ucode":"375F9FCF925CA6","user_header":"https://static001.geekbang.org/account/avatar/00/19/6e/63/b15d1d87.jpg","comment_is_top":false,"comment_ctime":1573551365,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573551365","product_id":100020801,"comment_content":"老师，我遇到了一个问题：<br>在mybatis里调用mysql的存储过程，在A表中插入一条数据<br>然后在同一事务中，另一段代码，却查不到这条记录，这什么情况，就好像存储过程与mybatis是在两个事务中一样","like_count":0},{"had_liked":false,"id":149672,"user_name":"李","can_delete":false,"product_type":"c1","uid":1188596,"ip_address":"","ucode":"4E69496C6AF335","user_header":"","comment_is_top":false,"comment_ctime":1573312866,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"1573312866","product_id":100020801,"comment_content":"session A 执行 select … for update 语句，由于 id=9 这一行并不存在，因此会加上间隙锁 (5,10);<br><br><br><br><br>一直没想明白，id已经是主健了，为什么还要加gap锁 <br>gap锁不是为了防止幻读嘛，插入了也读取不到啊","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162362,"discussion_content":"目的就是加gap lock，防止有insert行为，防止产生幻读。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580987403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1211317,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/b5/d33bedf7.jpg","nickname":"pws22","note":"","ucode":"0395BC8EB21B5D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":198037,"discussion_content":"能详细说一说么 没明白 如果只对9加上行锁的话,什么情况会出现幻读","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583464565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":162362,"ip_address":""},"score":198037,"extra":""},{"author":{"id":1022091,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/8b/7a691d53.jpg","nickname":"HungerW","note":"","ucode":"75689EDF0F8E7F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1211317,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/b5/d33bedf7.jpg","nickname":"pws22","note":"","ucode":"0395BC8EB21B5D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275899,"discussion_content":"1、目前没有9这一行，所以没法给9这一行加锁\n2、为防止幻读（一个事务里，前一次读没有，后一次再读又有了），在这个例子里，为了防止可能存在的后一次读到9的记录情况，必须防止9的记录插入，怎么防止？在（5,10）间加间隙锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590767495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":198037,"ip_address":""},"score":275899,"extra":""}]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":138577,"discussion_content":"rr如果没gap lock就幻读了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579254216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1211317,"avatar":"https://static001.geekbang.org/account/avatar/00/12/7b/b5/d33bedf7.jpg","nickname":"pws22","note":"","ucode":"0395BC8EB21B5D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":198038,"discussion_content":"能详细说一说么 没明白 如果只对9加上行锁的话,什么情况会出现幻读","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583464573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":138577,"ip_address":""},"score":198038,"extra":""}]}]},{"had_liked":false,"id":144665,"user_name":"大湿兄","can_delete":false,"product_type":"c1","uid":1660151,"ip_address":"","ucode":"587EBBBED90182","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL17rDiannrcyaUB5X6haqLic1183mfwyunJicRO8IYV9U8MaYiaZp8jRnW5kLQIqRmwTaPGIEVQZL5Uw/132","comment_is_top":false,"comment_ctime":1571992187,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1571992187","product_id":100020801,"comment_content":"老师：页上的空洞会加GAP锁吗？比方说，一个页满的，插入前删除了页上的几条数据后产生了空洞。如果不加锁，那下次insert往空洞里面，不就还有可能出现幻读吗","like_count":0,"discussions":[{"author":{"id":1346546,"avatar":"https://static001.geekbang.org/account/avatar/00/14/8b/f2/a6abbe45.jpg","nickname":"笼鱼","note":"","ucode":"CED5914D2C2964","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301603,"discussion_content":"两个概念吧，一个是物理上的一个是逻辑上的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598585636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1022091,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/98/8b/7a691d53.jpg","nickname":"HungerW","note":"","ucode":"75689EDF0F8E7F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275908,"discussion_content":"空洞是内存的，属于物理结构。间隙锁是针对并发业务场景的，利用的是索引之间的间隔信息作为锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590767703,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162363,"discussion_content":"这个并没有什么关系吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580987427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144455,"user_name":"liyl","can_delete":false,"product_type":"c1","uid":1117674,"ip_address":"","ucode":"60F77BED1EE69E","user_header":"https://static001.geekbang.org/account/avatar/00/11/0d/ea/f1dc11d3.jpg","comment_is_top":false,"comment_ctime":1571927089,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571927089","product_id":100020801,"comment_content":"老师 您好 我现在遇到一个问题 : <br>事务隔离级别:RC<br>mysql:5.7<br>数据库操作业务逻辑(并发环境下):根据非主键索引查询表中是否存在记录， 不存在则插入，存在则根据非主键索引更新数据库记录<br><br>然后偶尔会出现死锁的情况，不知道啥原因，老师看到麻烦帮分析下，谢谢了！","like_count":0},{"had_liked":false,"id":141594,"user_name":"王大伟","can_delete":false,"product_type":"c1","uid":1180955,"ip_address":"","ucode":"A3BDC4D7B94B0F","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/1b/fc1aa0ac.jpg","comment_is_top":false,"comment_ctime":1571197646,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1571197646","product_id":100020801,"comment_content":"好奇怪，我是mac上的maria db，5.7.24。隔离级别是RR，我的session b与session c都hang住了","like_count":0,"discussions":[{"author":{"id":1622109,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erPMtAfnQdpx1yOZQ2ic7icqUs3tvibEjUXQMUXKiaakyuIho6k6vmdl46nrdWjXIjPIRg9Pmco00tR5w/132","nickname":"小氘","note":"","ucode":"DA55B9A02D9EE0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39804,"discussion_content":"因为文中是假设没有间隙锁的情况下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571990849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":141258,"user_name":"mahaitao617","can_delete":false,"product_type":"c1","uid":1338716,"ip_address":"","ucode":"D199FD825488EA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/sw9JHZsxtw5viaYoBlmC0UvM9NPHf1YG48fR6iaG8BbvgN1KpjlJ5dzYmDmbxSBDbzP2r9tGo020PXWWwlcCUssA/132","comment_is_top":false,"comment_ctime":1571132788,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1571132788","product_id":100020801,"comment_content":"是我买的课程中讲的最好的课程了。","like_count":0,"discussions":[{"author":{"id":1721168,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/43/50/abb4ca1e.jpg","nickname":"凡","note":"","ucode":"80C2A6452AB9EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":172630,"discussion_content":"还有没其他稍微比这个差的课程","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581781042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130875,"user_name":"美美","can_delete":false,"product_type":"c1","uid":1148422,"ip_address":"","ucode":"44CC95C45AF345","user_header":"https://static001.geekbang.org/account/avatar/00/11/86/06/72b01bb7.jpg","comment_is_top":false,"comment_ctime":1567563198,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1567563198","product_id":100020801,"comment_content":"Next-key lock是锁住记录和记录之前的gap，文章中的例子为什么会把记录左右的gap都锁住呢？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162365,"discussion_content":"承上启下，如同黄河之水，连绵不绝。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580987503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128816,"user_name":"MrVito","can_delete":false,"product_type":"c1","uid":1252169,"ip_address":"","ucode":"716FF6F8871706","user_header":"https://static001.geekbang.org/account/avatar/00/13/1b/49/ddefc656.jpg","comment_is_top":false,"comment_ctime":1566967175,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566967175","product_id":100020801,"comment_content":"一开始本来打算复现一下刚开始的情况，但是读到后面发现间隙锁出现了，也是江湖人称gap锁，不互斥的锁，但是却与写锁互斥，读还是可以读，不可读就逻辑有问题了。先来回答一下问题，sessionB会等待是因为c&gt;=15这里next-key lock (10,15]，session C要等待是因为desc？","like_count":0},{"had_liked":false,"id":126985,"user_name":"马以","can_delete":false,"product_type":"c1","uid":1344431,"ip_address":"","ucode":"3FEA06CA14DE28","user_header":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","comment_is_top":false,"comment_ctime":1566530566,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566530566","product_id":100020801,"comment_content":"sessionB是因为sessionA加了间隙锁，sessionC为什么会阻塞呢？","like_count":0},{"had_liked":false,"id":122130,"user_name":"小予","can_delete":false,"product_type":"c1","uid":1442580,"ip_address":"","ucode":"3F5EAEE1746074","user_header":"https://static001.geekbang.org/account/avatar/00/16/03/14/e9ca2d09.jpg","comment_is_top":false,"comment_ctime":1565308685,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565308685","product_id":100020801,"comment_content":"查询条件字段加了索引的时候，执行select * form t where c=5 for update的时候，也是会加间隙锁的，为什么老是要用非索引字段来讲解间隙锁相关的内容呢？索引字段和非索引字段是有什么不同的表现吗？希望老师可以帮我解一下惑！！","like_count":0},{"had_liked":false,"id":121774,"user_name":"0273522","can_delete":false,"product_type":"c1","uid":1163383,"ip_address":"","ucode":"B04365B8FC27AD","user_header":"https://static001.geekbang.org/account/avatar/00/11/c0/77/d05c6abd.jpg","comment_is_top":false,"comment_ctime":1565222667,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565222667","product_id":100020801,"comment_content":"使用select…for update会把数据给锁住，不过我们需要注意一些锁的级别，MySQL InnoDB默认Row-Level Lock，所以只有「明确」地指定主键，MySQL 才会执行Row lock (只锁住被选取的数据) ，否则MySQL 将会执行Table Lock (将整个数据表单给锁住)。","like_count":0},{"had_liked":false,"id":121766,"user_name":"0273522","can_delete":false,"product_type":"c1","uid":1163383,"ip_address":"","ucode":"B04365B8FC27AD","user_header":"https://static001.geekbang.org/account/avatar/00/11/c0/77/d05c6abd.jpg","comment_is_top":false,"comment_ctime":1565221688,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565221688","product_id":100020801,"comment_content":"老师你好，我按照上面的例子，开启了三个终端，链接了MySQL的客户端，我发现我begin之后，update t set d=5 where id=5;  就卡住了，过了一会<br>mysql&gt; update t set d = 5 where id =0;<br>ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction<br>插入操作，也是。<br><br>➜  ~ mysql -V              <br>mysql  Ver 14.14 Distrib 5.7.22, for osx10.13 (x86_64) using  EditLine wrapper","like_count":0},{"had_liked":false,"id":121302,"user_name":"明亮","can_delete":false,"product_type":"c1","uid":1303015,"ip_address":"","ucode":"DAFB3424C4C2D7","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/e7/d1b2e914.jpg","comment_is_top":false,"comment_ctime":1565096198,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565096198","product_id":100020801,"comment_content":"我试用了你的图一中session B 的语句，SQL是无法执行的：<br>mysql&gt; update t set d =5 where id =0;<br>ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction","like_count":0},{"had_liked":false,"id":118225,"user_name":"锋芒","can_delete":false,"product_type":"c1","uid":1320419,"ip_address":"","ucode":"BB5284E3C8D78D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ach5TNuIu8T4Of8ibvfWM4JPic5uQn9Y7TgGjBHLp2iar4icxJzs14bpUXV9OdYiciblvJl14zSqXjwtDffHnSTqbD6g/132","comment_is_top":false,"comment_ctime":1564296406,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564296406","product_id":100020801,"comment_content":"l老师， 请问：读提交 隔离级别 为什么没有幻的问题呢 ？ 如果用select * from t where id=N for update ，也会有最新读，也有可能读到 新插入的数据的。 ","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":138579,"discussion_content":"有啊，而且是正常的，不是错误","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579254315,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117302,"user_name":"远方夕阳","can_delete":false,"product_type":"c1","uid":1122317,"ip_address":"","ucode":"EEBCD53B2B5D3E","user_header":"https://static001.geekbang.org/account/avatar/00/11/20/0d/93967314.jpg","comment_is_top":false,"comment_ctime":1564020584,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564020584","product_id":100020801,"comment_content":"这里 session B 并不会被堵住。因为表 t 里并没有 c=7 这个记录，因此 session A 加的是间隙锁 (5,10)。","like_count":0},{"had_liked":false,"id":117300,"user_name":"远方夕阳","can_delete":false,"product_type":"c1","uid":1122317,"ip_address":"","ucode":"EEBCD53B2B5D3E","user_header":"https://static001.geekbang.org/account/avatar/00/11/20/0d/93967314.jpg","comment_is_top":false,"comment_ctime":1564020203,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564020203","product_id":100020801,"comment_content":"这样，当你执行 select * from t where d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。<br>老师你好，这一句话没有理解。d=5的 符合的几率只有 5，5，5 这一行，为什么会对所有的记录都加行锁，为什么同时加了7个间隙锁，假如有10000条记录就要加10001个间隙锁吗？这个规律是什么 ","like_count":0},{"had_liked":false,"id":114633,"user_name":"竹荀","can_delete":false,"product_type":"c1","uid":1604511,"ip_address":"","ucode":"3380C18DCAD203","user_header":"https://static001.geekbang.org/account/avatar/00/18/7b/9f/7825b97c.jpg","comment_is_top":false,"comment_ctime":1563354011,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563354011","product_id":100020801,"comment_content":"由于字段 d 上没有索引，因此这条查询语句会做全表扫描。那么，其他被扫描到的，但是不满足条件的 5 行记录上，会不会被加锁呢？<br>这个问题好像没有人回答，还是说大家都知道，我的回答是会。因为我在操作图1的时候，sessionB根本没法更新，直接就卡住了，我的版本是mysql5.6，其他用的都是默认配置。等到sessionA commit之后才能更新。我用explain看到的结果是type ALL,rows 6,就从我测试的结果来看，是会加锁的。我操作姿势不对？","like_count":0},{"had_liked":false,"id":114594,"user_name":"泠小墨","can_delete":false,"product_type":"c1","uid":1178634,"ip_address":"","ucode":"73D296D9F42911","user_header":"https://static001.geekbang.org/account/avatar/00/11/fc/0a/0c4b9170.jpg","comment_is_top":false,"comment_ctime":1563346866,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563346866","product_id":100020801,"comment_content":"先mark 一个问题，看后续学习完能否解决<br>场景1：<br>session A<br>select * from t where c&gt;=15 and c &lt;=25 for update;<br>session B<br>insert into t values(6,6,6);#非阻塞<br>场景2：<br>session A<br>select * from t where c&gt;=15 and c &lt;=20 for update;<br>select * from t where c&gt;=15 and c &lt;=25 for update;<br>session B<br>insert into t values(6,6,6);#阻塞<br><br>mysql 5.7.25-log  <br>","like_count":0},{"had_liked":false,"id":112609,"user_name":"yhui","can_delete":false,"product_type":"c1","uid":1512714,"ip_address":"","ucode":"1AAAF47E41FFB8","user_header":"https://static001.geekbang.org/account/avatar/00/17/15/0a/c450e565.jpg","comment_is_top":false,"comment_ctime":1562770964,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562770964","product_id":100020801,"comment_content":"那么间隙锁产生情况：<br>1.有索引的等值 id=不存在的值<br>2.无索引的d=xxx 或者范围 就会遍历一遍加上间隙锁<br><br>是这样不？","like_count":0},{"had_liked":false,"id":112149,"user_name":"残天噬魂","can_delete":false,"product_type":"c1","uid":1506609,"ip_address":"","ucode":"A2AD8303A4518D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/q2HwchogzNiavKhIB4GfAxH6B88NhSoC7B7keVEUqiaP6JPokDUNJLYehocOyqYqrhA3iaxywyRXLYkYJjDUQESZw/132","comment_is_top":false,"comment_ctime":1562675343,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562675343","product_id":100020801,"comment_content":"老师好，刚刚看了下，图四和图三是一样的啊？图四是哪里给每一行加上锁的呢？","like_count":0},{"had_liked":false,"id":109560,"user_name":"大宝","can_delete":false,"product_type":"c1","uid":1102771,"ip_address":"","ucode":"224458E5D1A35A","user_header":"https://static001.geekbang.org/account/avatar/00/10/d3/b3/4f5550c0.jpg","comment_is_top":false,"comment_ctime":1562057336,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562057336","product_id":100020801,"comment_content":"老师，有个问题：<br>图3 和 图4是一样的，为什么到了图4这里，session B 的update t set d=5 where id=0;就被锁住了呢？并没有看到在 d=5的所有行都加过写锁。","like_count":0},{"had_liked":false,"id":108799,"user_name":"秋天","can_delete":false,"product_type":"c1","uid":1057056,"ip_address":"","ucode":"A7E1D953EF7E17","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg","comment_is_top":false,"comment_ctime":1561885170,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1561885170","product_id":100020801,"comment_content":"知道啦只有插入操作才会叫做幻读的引入，更新操作不能叫幻读。还有引入间隙锁是为了在可重复读级别下，行锁不能保证插入操作的数据而导致的不可重复读","like_count":0},{"had_liked":false,"id":106318,"user_name":"今夜秋风和","can_delete":false,"product_type":"c1","uid":1434066,"ip_address":"","ucode":"453C8197FFC81D","user_header":"https://static001.geekbang.org/account/avatar/00/15/e1/d2/42ad2c87.jpg","comment_is_top":false,"comment_ctime":1561263750,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561263750","product_id":100020801,"comment_content":"老师，您好，请问下数据和日志的不一致问题，binlog 执行为什么在最后一次才执行，假如事务二没有阻塞的情况下？","like_count":0},{"had_liked":false,"id":97557,"user_name":"Geek_e7a036","can_delete":false,"product_type":"c1","uid":1497030,"ip_address":"","ucode":"65EA05C403441F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIUvKMecKzfLSgFuYicksMxz1BJHp2Qz1uJBZsrfMTwBmF39tibW7HvbRmompwr71x86qwW22hLTULw/132","comment_is_top":false,"comment_ctime":1558694947,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558694947","product_id":100020801,"comment_content":"总结下我的理解，不知道理解是否正确：<br>1.加行锁<br>主键索引——锁主键所在的行<br>其他索引——锁索引相关行，我有一个问题，一个where条件有多个索引字段的条件，比如索引a，b，where a = 1 and b = 2, 您说只会选一个索引a，那是锁这个索引a=1相关的所有行，不会考虑b=2索引其他相关的行<br>没有索引——锁住所有行<br><br>2.gap锁<br>索引字段——锁行锁锁定的行取值范围中间所有间隙<br>没有索引——所有值都加上gap锁<br>没索引——锁所有的行","like_count":0},{"had_liked":false,"id":97513,"user_name":"Geek_e7a036","can_delete":false,"product_type":"c1","uid":1497030,"ip_address":"","ucode":"65EA05C403441F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIUvKMecKzfLSgFuYicksMxz1BJHp2Qz1uJBZsrfMTwBmF39tibW7HvbRmompwr71x86qwW22hLTULw/132","comment_is_top":false,"comment_ctime":1558686924,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558686924","product_id":100020801,"comment_content":"老师，今天的文章对我影响很大，发现之前掌握的知识有些错误的地方，课后我用你的表结构根据以前不清楚的地方实践了一遍，现在有两个问题，麻烦您解答下<br>1.我在事务1中执行 begin;select * from t where c=5 for update;事务未提交，然后事务2中begin;update t set c=5 where id=0;执行阻塞，替换成update t set c=11 where id=0;执行不阻塞，我觉得原因是事务1执行时产生next-key lock范围是(0,5].(5,10]。我想问下update set操作c=xxx是会加锁吗？以及加锁的原理。<br>2.一直以为gap只会在二级索引上，看了你的死锁案例，发现主键索引上也会有gap锁？<br><br>10<br>2018-12-28<br>作者回复: 1. 好问题。你可以理解为要在索引c上插入一个(c=5,id=0)这一行，是落在(0,5],(5,10]里面的，11可以对吧<br><br>2. 嗯，主键索引的间隙上也要有Gap lock保护的<br>-----<br>@令狐少侠 第一个问题我尝试了下，c是加了索引，只锁住了c=5的相关行，所以c=5的更新不可以，其余可以更新。update我的理解是没有gap锁，gap锁是为了防止insert的。如果c没加索引，是全表都锁住，全表都不可以更新插入。","like_count":0},{"had_liked":false,"id":95866,"user_name":"　","can_delete":false,"product_type":"c1","uid":1172538,"ip_address":"","ucode":"DBE2DB5CC52C91","user_header":"https://static001.geekbang.org/account/avatar/00/11/e4/3a/16545faf.jpg","comment_is_top":false,"comment_ctime":1558237694,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558237694","product_id":100020801,"comment_content":"这章读下来我只知道了，幻读是事务开启后还能读到新插入的行（发生在可重复隔离级别的当前读操作下），所以为了解决这个问题引入了间隙锁，间隙锁是行记录之间的间隙的锁，next-key lock是行锁+间隙锁。<br>间隙锁与插入动作互斥。<br><br>但是什么前开后闭我不理解。当你执行 select * from t where d=5 for update,还同时加了 7 个间隙锁，后面讲的和下面的回答好像又不是这么回事了（我看后面的内容好像只是加了部分间隙锁）<br>","like_count":0},{"had_liked":false,"id":93715,"user_name":"今夜秋风和","can_delete":false,"product_type":"c1","uid":1434066,"ip_address":"","ucode":"453C8197FFC81D","user_header":"https://static001.geekbang.org/account/avatar/00/15/e1/d2/42ad2c87.jpg","comment_is_top":false,"comment_ctime":1557567147,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557567147","product_id":100020801,"comment_content":"老师，您好，请问下<br>1.行锁默认加的类型是next-key lock 嘛？在本地测试了一个begin;<br>SELECT * from t5 where id=10 for update; id=10 存在，另一个事务中插入(9,9,9),可以插入成功,说明(5,10]范围没有被加间隙锁<br>2.判断innnodb 有没有加间隙锁是根据索引对应的记录是否存在不？","like_count":0},{"had_liked":false,"id":90442,"user_name":"Break","can_delete":false,"product_type":"c1","uid":1508922,"ip_address":"","ucode":"6D1CCFC60E11EF","user_header":"https://static001.geekbang.org/account/avatar/00/17/06/3a/68bed1d9.jpg","comment_is_top":false,"comment_ctime":1556521079,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1556521079","product_id":100020801,"comment_content":"这个文章有一个地方没有提到. 就是执行select * from t where id=9 for update; 只是加了一行的锁和间隙锁, 而没有对其他行也加了锁, 那是因为id是主键, 所以只需要加一个间隙锁就够了,其他行再怎么修改都会因为主键唯一的原因, 不能改成id=9. 而select * from t where d=9 for update;是会对全部行都加锁.","like_count":0},{"had_liked":false,"id":90365,"user_name":"mickey","can_delete":false,"product_type":"c1","uid":1051663,"ip_address":"","ucode":"8B490C2DDE4010","user_header":"https://static001.geekbang.org/account/avatar/00/10/0c/0f/93d1c8eb.jpg","comment_is_top":false,"comment_ctime":1556500630,"is_pvip":false,"replies":[{"id":"32456","content":"这里是（5,10）, 你可以看一下第21篇的加锁规则的”优化2“","user_name":"作者回复","user_name_real":"Jing～","uid":"1059377","ctime":1556593978,"ip_address":"","comment_id":90365,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1556500630","product_id":100020801,"comment_content":"图8下面的<br>“session B 执行 select … for update 语句，同样会加上间隙锁 (5,10)”<br>应改为 (5,10] 吧<br>","like_count":0,"discussions":[{"author":{"id":1059377,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2a/31/9edbf8a6.jpg","nickname":"贾静","note":"","ucode":"081E70CC01F6B8","race_medal":0,"user_type":8,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448493,"discussion_content":"这里是（5,10）, 你可以看一下第21篇的加锁规则的”优化2“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1556593978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85409,"user_name":"梦想","can_delete":false,"product_type":"c1","uid":1286059,"ip_address":"","ucode":"71DE16FC85D868","user_header":"https://static001.geekbang.org/account/avatar/00/13/9f/ab/1b0dfa68.jpg","comment_is_top":false,"comment_ctime":1555054772,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555054772","product_id":100020801,"comment_content":"老师好，有两个问题请教。<br>问题一：按0，5，10的数据，select where c=5 for update 这种，通过间隙锁想解决的就是不能再有一个5插进来或改出来。那是不是可以这样理解，其实锁住0到5和5到10，实际上是误伤到了1234 6789了呢？<br>问题二：如果是误伤，那为什么非要通过间隙这种方式来锁呢，是锁的记录只能记到0、5、10这三个叶子上吗？为什么不能找个地方存着不能插入5修改成5，然后有线程进来，到这个地方判断一下呢？","like_count":0},{"had_liked":false,"id":83684,"user_name":"亮的太阳","can_delete":false,"product_type":"c1","uid":1475752,"ip_address":"","ucode":"8BD77740812984","user_header":"https://static001.geekbang.org/account/avatar/00/16/84/a8/b0746eea.jpg","comment_is_top":false,"comment_ctime":1554699413,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1554699413","product_id":100020801,"comment_content":"如果d是普通索引，那么由于没有扫描到id为 0 的行，所以就没有被加行锁，却被间隙锁挡住了，但是这种情况不属于幻读。所以间隙锁不仅针对幻读？","like_count":0},{"had_liked":false,"id":83052,"user_name":"Seven.Lin澤耿","can_delete":false,"product_type":"c1","uid":1181192,"ip_address":"","ucode":"4CAB732CD6F149","user_header":"https://static001.geekbang.org/account/avatar/00/12/06/08/855abb02.jpg","comment_is_top":false,"comment_ctime":1554384763,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1554384763","product_id":100020801,"comment_content":"老师，最近面试遇到一个问题，一直不能确定，问题大致是：使用MySQL通过cas实现乐观锁需要将事务隔离级别设置为什么？我当时的回答是读已提交，但是后来想想好像不怎么对，cas是指乐观锁，作用就是达到锁的作用；而事务隔离级别是指事务之间的读隔离进而提高数据的准确性，所以本质上是两回事，只要在一定的事务内都是可以实现cas操作的，只是在不同的隔离级别而达到的乐观锁而已，这么理解对吗？","like_count":0,"discussions":[{"author":{"id":1721168,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/43/50/abb4ca1e.jpg","nickname":"凡","note":"","ucode":"80C2A6452AB9EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":172727,"discussion_content":"这个其实就是并发修改同一行数据的问题吧，修改同一行数据都会获取行锁，所以在哪个隔离级别都是可以的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581782161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78227,"user_name":"唯她命","can_delete":false,"product_type":"c1","uid":1240398,"ip_address":"","ucode":"8F687E8D306840","user_header":"https://static001.geekbang.org/account/avatar/00/12/ed/4e/ef406442.jpg","comment_is_top":false,"comment_ctime":1553096886,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1553096886","product_id":100020801,"comment_content":"老师  如果图三在 读提交 下 还会出现文中的幻读 问题吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162369,"discussion_content":"不会","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580987741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":75123,"user_name":"楼下小黑哥","can_delete":false,"product_type":"c1","uid":1014680,"ip_address":"","ucode":"453B099B0EE52E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7b/98/8f1aecf4.jpg","comment_is_top":false,"comment_ctime":1552356770,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1552356770","product_id":100020801,"comment_content":"最近生产配碰到余额更新丢失事件，看了老师这几篇文章，对这个事件原理更加清晰了。分享下我们碰到问题。<br><br>假设 id=1 账户余额需要扣减100，事务隔离级别为 RR。我们之前时序如下。<br><br>t1: <br>set autocommit=0;<br>select * from account where id=1; (1,1000)<br>select * from account where id=1 for update;(1,1000)<br><br>t2:<br>set autocommit=0;<br>select * from account where id=1; (1,1000)<br>select * from account where id=1 for update; (1,900)<br><br>t3：<br>select * from account where id=1;(1,1000)<br>update account set balance=900 where id=1;<br>commit;<br><br>t4:<br>select * from account where id=1; (1,1000)<br>update account set balance=900 where id=1;<br>commit;<br><br>由于事务隔离级别为 RR，就发生了如上更新结果。后来我们将事务级别改成 RC，暂时解决问题了。<br><br><br>","like_count":0,"discussions":[{"author":{"id":1512714,"avatar":"https://static001.geekbang.org/account/avatar/00/17/15/0a/c450e565.jpg","nickname":"yhui","note":"","ucode":"1AAAF47E41FFB8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1659,"discussion_content":"这tmd写的神仙也看不懂啊 问题呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562772026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74694,"user_name":"Demter","can_delete":false,"product_type":"c1","uid":1158439,"ip_address":"","ucode":"BE3B6F726916CE","user_header":"https://static001.geekbang.org/account/avatar/00/11/ad/27/5556ae50.jpg","comment_is_top":false,"comment_ctime":1552282637,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1552282637","product_id":100020801,"comment_content":"引入间隙锁之后可重复读级别可以预防幻读吗","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162370,"discussion_content":"当然","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580987754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":72559,"user_name":"Magic","can_delete":false,"product_type":"c1","uid":1272047,"ip_address":"","ucode":"FD9CEDAA419EB0","user_header":"https://static001.geekbang.org/account/avatar/00/13/68/ef/6264ca3d.jpg","comment_is_top":false,"comment_ctime":1551667854,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1551667854","product_id":100020801,"comment_content":"老师，您好。我在mysql 8.0.3版本下验证gap锁只在二级索引上加了，并没有在主键索引上加。具体验证过程如下：<br>create table t<br>(<br>id int not null primary key auto_increment,<br>a int,<br>key `a`(`a`)<br>) engine=InnoDB;<br>在mysql 8.0.3版本下测试如下：<br>事务A：<br>时刻T1<br>begin;<br>select * from t where a=5 for update;<br>事务B：<br>时刻T2<br>begin；<br>insert into t values(90,4); &#47;&#47;block<br>insert into t values(90,6);&#47;&#47;block<br>insert into t values(4,90)&#47;&#47; succ<br>insert into t values(6,90);&#47;&#47;succ<br>单看上述实验结果是只在二级索引a上加了gap锁，并且加锁范围是(0,5) 和(5,10)。请老师帮忙解答一下？谢谢","like_count":0},{"had_liked":false,"id":68543,"user_name":"念你如昔","can_delete":false,"product_type":"c1","uid":1323531,"ip_address":"","ucode":"FCAD88AB57D084","user_header":"https://static001.geekbang.org/account/avatar/00/14/32/0b/981b4e93.jpg","comment_is_top":false,"comment_ctime":1550540740,"is_pvip":false,"replies":[{"id":"24644","content":"不会啊<br><br>id1上有索引的吧？<br>你show create table t0; <br>explain select * from t0 where id1=3 for update ;<br>还有用于判断“锁范围 ”的语句写一下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550728638,"ip_address":"","comment_id":68543,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550540740","product_id":100020801,"comment_content":"对于（走索引）的 范围锁的范围：<br>for update这个数的上一个数 到下一个数，包含上一个数但是不包含下一个数。<br>mysql&gt; select * from t0;  id1 有索引。<br>| id   | id1  |<br>|    1 |    1 |<br>|    3 |    3 |<br>|    5 |    5 |<br>select  * from  t0 where id1=1 for update ; 范围是   【 负无穷，3）<br>select * from t0 where id1=3 for update ; 范围是 【1,5）<br>select * from t0 where id1=5 for update ； 范围是 【3，正无穷）<br>经测试发现，上一个值也是会被锁住的？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439727,"discussion_content":"不会啊\n\nid1上有索引的吧？\n你show create table t0; \nexplain select * from t0 where id1=3 for update ;\n还有用于判断“锁范围 ”的语句写一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550728638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67047,"user_name":"奋斗心","can_delete":false,"product_type":"c1","uid":1247286,"ip_address":"","ucode":"06A195AB0B6570","user_header":"https://static001.geekbang.org/account/avatar/00/13/08/36/98be3d69.jpg","comment_is_top":false,"comment_ctime":1550061223,"is_pvip":false,"replies":[{"id":"23992","content":"图3是为了说明“如果不加锁会出问题”，是一个假设，其实是得都加锁的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550297541,"ip_address":"","comment_id":67047,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1550061223","product_id":100020801,"comment_content":"图3和图4的T1时刻执行的语句都一样，为什么说图4 sessionA所有行都要加写锁","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439028,"discussion_content":"图3是为了说明“如果不加锁会出问题”，是一个假设，其实是得都加锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550297541,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":64135,"user_name":"xuery","can_delete":false,"product_type":"c1","uid":1027584,"ip_address":"","ucode":"F461B61BE06131","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ae/00/025f37e7.jpg","comment_is_top":false,"comment_ctime":1548674933,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1548674933","product_id":100020801,"comment_content":"老师，请教一个问题：<br>图8：间隙锁导致的死锁；我把innodb_locks_unsafe_for_binlog设置为1之后，session B并不会blocked, 而是执行成功，session A也不会提示死锁；然后分别提交，先提交的执行成功，后提交的提示主键重复<br>这个也是因为将innodb_locks_unsafe_for_binlog设置为1之后，如果select...for update的数据不存在则加上的gap锁也会在事务未提交之前释放掉吗？","like_count":0},{"had_liked":false,"id":63066,"user_name":"immortalCockroach","can_delete":false,"product_type":"c1","uid":1157912,"ip_address":"","ucode":"9A4F497BEA7DFB","user_header":"https://static001.geekbang.org/account/avatar/00/11/ab/18/b01e71d1.jpg","comment_is_top":false,"comment_ctime":1548242167,"is_pvip":false,"replies":[{"id":"22276","content":"不是哦，<br>你看图3下面的文字说明，语句执行完成后，id=1这一行的值是(1,5,5)<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548245452,"ip_address":"","comment_id":63066,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548242167","product_id":100020801,"comment_content":"这个语句序列，不论是拿到备库去执行，还是以后用 binlog 来克隆一个库，这三行的结果，都变成了 (0,5,100)、(1,5,100) 和 (5,5,100)。<br><br>老师您好，这段话我不太明白，binlog按顺序重放和sql的执行结果是一样的，都是上面的3条记录。<br>为什么说有不一致呢？谢谢老师","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437455,"discussion_content":"不是哦，\n你看图3下面的文字说明，语句执行完成后，id=1这一行的值是(1,5,5)\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548245452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62928,"user_name":"杰哥长得帅","can_delete":false,"product_type":"c1","uid":1241993,"ip_address":"","ucode":"5A7FD1794F62D7","user_header":"https://static001.geekbang.org/account/avatar/00/12/f3/89/fcfecb46.jpg","comment_is_top":false,"comment_ctime":1548208532,"is_pvip":false,"replies":[{"id":"22260","content":"搜一下文中这句话「我需要对“幻读”做一个说明」 <br>看一下这一段的描述哈<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548225298,"ip_address":"","comment_id":62928,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1548208532","product_id":100020801,"comment_content":"老师其实我是想问：mvcc为什么无法解决幻读，比如B事务新insert的数据肯定有一个版本号，根据mvcc的原理，如果A事务启动的时候，B事务还没提交，那么A事务应该是看不到B事务insert的数据的（除非在A事务中加锁用“当前读”）。这不是意味着mvcc解决了幻读吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437406,"discussion_content":"搜一下文中这句话「我需要对“幻读”做一个说明」 \n看一下这一段的描述哈\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548225298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":61147,"user_name":"J!","can_delete":false,"product_type":"c1","uid":1305003,"ip_address":"","ucode":"71C946119B59D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/ab/37903736.jpg","comment_is_top":false,"comment_ctime":1547627266,"is_pvip":false,"replies":[{"id":"21775","content":"”`语句执行完成后` , 是指事务没提交之前就释放不满足条件的行锁吗？“<br><br>---在读提交隔离级别是这样的。<br><br>但是这个可不是“应该”这样的。<br>在可重复读的时候，就是要等事务提交才释放。","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547632239,"ip_address":"","comment_id":61147,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547627266","product_id":100020801,"comment_content":"`我们在本文的开头回答了上期问题。有同学的回答中还说明了读提交隔离级别下，在语句执行完成后，是只有行锁的。而且语句执行完成后，InnoDB 就会把不满足条件的行行锁去掉.`<br>在这段文字中<br> `语句执行完成后` , 是指事务没提交之前就释放不满足条件的行锁吗？应该是这样的吧，语句都执行，什么锁都释放了吧","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436761,"discussion_content":"”`语句执行完成后` , 是指事务没提交之前就释放不满足条件的行锁吗？“\n\n---在读提交隔离级别是这样的。\n\n但是这个可不是“应该”这样的。\n在可重复读的时候，就是要等事务提交才释放。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547632239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":61044,"user_name":"Pixar","can_delete":false,"product_type":"c1","uid":1197659,"ip_address":"","ucode":"E653387BA8EA16","user_header":"https://static001.geekbang.org/account/avatar/00/12/46/5b/07858c33.jpg","comment_is_top":false,"comment_ctime":1547608270,"is_pvip":false,"replies":[{"id":"21757","content":"图1 是“假设不堵会怎么样”<br><br>实际上最终的结论和你验证的是一样的哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547621159,"ip_address":"","comment_id":61044,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547608270","product_id":100020801,"comment_content":"在本地实例下图1的操作时序图, T2 时刻sessionB的操作会被阻塞掉, sessionA的T3操作得到的结果和T1时刻是一样的, 都是(5,5,5), 不知道老师图中T3时刻得到的(0,0,5)(5,5,5) 结果是在什么设置下得到的呢?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436722,"discussion_content":"图1 是“假设不堵会怎么样”\n\n实际上最终的结论和你验证的是一样的哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547621159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58898,"user_name":"spraith","can_delete":false,"product_type":"c1","uid":1141702,"ip_address":"","ucode":"7FBC54DF0BBF50","user_header":"https://static001.geekbang.org/account/avatar/00/11/6b/c6/2534e14a.jpg","comment_is_top":false,"comment_ctime":1547233619,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547233619","product_id":100020801,"comment_content":"图1的Q1语句，每次 select 是否都是自动加写锁的？如果是，那为了实现可重复读搞出来的mvcc好像就没必要了啊，因为别的事务都只能等待前面的写锁释放才能再写，所以Q1所在的事务自然就能实现“可重复读”，似乎不需要mvcc。<br>求老师解答","like_count":0},{"had_liked":false,"id":58436,"user_name":"alias cd=rm -rf","can_delete":false,"product_type":"c1","uid":1318325,"ip_address":"","ucode":"E7B27D76305B75","user_header":"https://static001.geekbang.org/account/avatar/00/14/1d/b5/971261fd.jpg","comment_is_top":false,"comment_ctime":1547083432,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1547083432","product_id":100020801,"comment_content":"思考题猜测：<br>因为sessionA虽然有索引，但是因为排序需要扫描全表。所以为全表增加了gap lock。导致insert都需要等待锁释放。<br>是否sessionA不加order by，sessionC就不用block了？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162373,"discussion_content":"这跟order by没关系吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580988058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57666,"user_name":"三木禾","can_delete":false,"product_type":"c1","uid":1109458,"ip_address":"","ucode":"39C37228236860","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/d2/e3ae7ddd.jpg","comment_is_top":false,"comment_ctime":1546865216,"is_pvip":false,"replies":[{"id":"20788","content":"图1是为了推导“如果不阻塞会发生什么现象”<br><br>最后我们推论出来需要阻塞<br><br>实际上跟你验证的这个结果一致的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546869866,"ip_address":"","comment_id":57666,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546865216","product_id":100020801,"comment_content":"老师，我的数据库版本是5.6.39-log，存储引擎为innodb,事务的隔离级别为  REPEATABLE-READ<br>CREATE TABLE `t` (<br>  `id` int(11) NOT NULL,<br>  `c` int(11) DEFAULT NULL,<br>  `d` int(11) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `c` (`c`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8；<br>但是我在一个sessionA执行begin;  select * from t where d=5 for update;<br>得到 5 | 5 | 5 |  这一行数据<br>sessionB 执行update t set id=5 set id=0;  然后这条语句阻塞<br>sessionC执行insert into t(id,c,d) values(1,1,5);  也阻塞，跟您的图1 的执行结果不一样，为什么啊？<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435692,"discussion_content":"图1是为了推导“如果不阻塞会发生什么现象”\n\n最后我们推论出来需要阻塞\n\n实际上跟你验证的这个结果一致的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546869866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56062,"user_name":"Komine","can_delete":false,"product_type":"c1","uid":1040449,"ip_address":"","ucode":"1668595D691F3A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e0/41/8ae7a30a.jpg","comment_is_top":false,"comment_ctime":1546390691,"is_pvip":false,"replies":[{"id":"20160","content":"看下一篇文章😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546393046,"ip_address":"","comment_id":56062,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546390691","product_id":100020801,"comment_content":"老师，mysql是给索引加锁，最终锁会加到主键索引上吗？即使where条件里用的是普通索引？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434925,"discussion_content":"看下一篇文章😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546393046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55861,"user_name":"Scott","can_delete":false,"product_type":"c1","uid":1014800,"ip_address":"","ucode":"7E57FDCB5E5D49","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/10/165cb374.jpg","comment_is_top":false,"comment_ctime":1546332067,"is_pvip":false,"replies":[{"id":"20118","content":"你说的是row格式😄 后面我们有提的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546340799,"ip_address":"","comment_id":55861,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546332067","product_id":100020801,"comment_content":"我有一个问题，备库同步binlog时，为啥要直接执行sql语句呢，如果只根据执行的结果同步id=5的这一行，不就没有数据不一致的问题了吗","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434864,"discussion_content":"你说的是row格式😄 后面我们有提的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546340799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55354,"user_name":"才才","can_delete":false,"product_type":"c1","uid":1242373,"ip_address":"","ucode":"94D76106261987","user_header":"https://static001.geekbang.org/account/avatar/00/12/f5/05/d6547381.jpg","comment_is_top":false,"comment_ctime":1546143263,"is_pvip":false,"replies":[{"id":"20052","content":"不确定你面试官要问的是啥，不过你可以下周看看23篇","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546169445,"ip_address":"","comment_id":55354,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546143263","product_id":100020801,"comment_content":"老师我有个面试题，说对一个表对大量的更新操作，有什么办法可以提高mysql效率","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434749,"discussion_content":"不确定你面试官要问的是啥，不过你可以下周看看23篇","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546169445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55269,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1546084168,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546084168","product_id":100020801,"comment_content":"把该讲内容总结为几个问题, 大家复习的时候可以先尝试回答这些问题检查自己的掌握程度:<br><br>\t1. <br>幻读的概念是什么?<br>\t2. <br>幻读是怎么导致语义上的问题的?<br>\t3. <br>幻读是怎么导致数据一致性上的问题的?<br>\t4. <br>间隙锁的概念是什么? 什么情况下会出现间隙锁的冲突关系?<br>\t5. <br>next-key lock 的概念是什么? <br>\t6. <br>间隙锁和next-key lock是怎么解决幻读问题的?  <br>\t7. <br>为什么间隙锁的引入会导致并发性能的问题?<br><br>","like_count":0},{"had_liked":false,"id":55266,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1546083097,"is_pvip":false,"replies":[{"id":"20031","content":"没差别呀 ，整数还是varchar一样的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546088210,"ip_address":"","comment_id":55266,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546083097","product_id":100020801,"comment_content":"想请教一下老师如果是varchar类型的字段, 加间隙锁的话范围是怎么划定的呢?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434721,"discussion_content":"没差别呀 ，整数还是varchar一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546088210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55172,"user_name":"似水流年","can_delete":false,"product_type":"c1","uid":1304443,"ip_address":"","ucode":"D114A8E273133C","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/7b/71da8283.jpg","comment_is_top":false,"comment_ctime":1546058363,"is_pvip":false,"replies":[{"id":"20013","content":"第一个是反证假设哦，实际上是会锁的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546068773,"ip_address":"","comment_id":55172,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546058363","product_id":100020801,"comment_content":"老师，为什么我做幻读的第一个实验时，A会话执行select * from t where d=5 for update;&#47;*Q1*&#47;<br>后，B会话再执行update t set d=5 where id=0;时被阻塞，最后报错ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction，从以上情况看，select * from t where d=5 for update;&#47;*Q1*&#47;阻塞了update t set d=5 where id=0;语句，怎么使用情况跟老师的 不一样呀？麻烦老师解答下。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434688,"discussion_content":"第一个是反证假设哦，实际上是会锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546068773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55156,"user_name":"一大只😴","can_delete":false,"product_type":"c1","uid":1310960,"ip_address":"","ucode":"92F3D2B7F63568","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg","comment_is_top":false,"comment_ctime":1546053274,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546053274","product_id":100020801,"comment_content":"思考题：<br>t1锁住的范围应该是[10,15),[15,20)，因为是倒序排列desc，所以开闭区间发生变化，这点需要老师指正。<br>t2锁住的范围应该是(10,11],(11,15]<br>t3锁住的范围应该是(5,6],(6,10]<br>t2等t1锁的15这个record，所以t2等待<br>t3等t1锁的10这个record，所以t3等待<br>如果t1排序是asc，t2同样会等待，但t3不会等待，可以执行成功<br>","like_count":0},{"had_liked":false,"id":55148,"user_name":"滔滔","can_delete":false,"product_type":"c1","uid":1303342,"ip_address":"","ucode":"6968B5771AF79D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg","comment_is_top":false,"comment_ctime":1546052622,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546052622","product_id":100020801,"comment_content":"老师,文中提到select * from t where d=5 for update语句会对所有记录加写锁,关于这点我有两个问题: 1.为什么要对所有记录都加写锁,而不是只对d=5的记录加写锁,其余记录加读锁,这样不是能够让其他事务可以并发读取其他的记录从而提高并发性能么? 2.如果语句中d这个字段有唯一索引,是否还需要对d不等于5的所有其他记录都加行锁?此外还有一个问题,如果改成select * from t where d=5 lock in share mode,这种情况下是只对d=5的记录加读锁还是需要对所有记录加读锁?","like_count":0},{"had_liked":false,"id":55116,"user_name":"Long","can_delete":false,"product_type":"c1","uid":1318970,"ip_address":"","ucode":"2417242560360A","user_header":"https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg","comment_is_top":false,"comment_ctime":1546046959,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1546046959","product_id":100020801,"comment_content":"老师你好，我这边有个疑问就是，我能找到和留言中 用户名为 沉浮 ，同学一样的日志，但是怎么就能判断这个是hex 8000000a asc就是(5,10]的gap锁，而不是(10,15]的？是因为左(]固定格式的原因吗？简单来说3个问题，<br> RECORD LOCKS space id 120833 page no 4 n bits 80 index `c` of table `test`.`t` trx id 9562291160 lock_mode X locks gap before rec insert intention waiting<br> Record lock, heap no 4 PHYSICAL RECORD: n_fields 2; compact format; info bits 0<br>  0: len 4; hex 8000000a; asc     ;;<br>  1: len 4; hex 8000000a; asc     ;;<br><br>1. hex以8开头是什么原因啊？<br>2. 日志写的00000a是不是就是确定是(x,10]固定这种方式，还是需要参考其他字段一起判断？x是上一个实际存在的索引值<br>3. asc这个字段在这里有什么特殊含义吗？<br><br>希望老师帮忙解答，多谢","like_count":0},{"had_liked":false,"id":55026,"user_name":"Ryy","can_delete":false,"product_type":"c1","uid":1311939,"ip_address":"","ucode":"7CB78714F4BA9C","user_header":"https://static001.geekbang.org/account/avatar/00/14/04/c3/f3e4aed6.jpg","comment_is_top":false,"comment_ctime":1546003587,"is_pvip":false,"replies":[{"id":"19961","content":"事务隔离级别是不是read-committed?","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546008294,"ip_address":"","comment_id":55026,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546003587","product_id":100020801,"comment_content":"老师　我有一个问题，　针对与今天的这个表<br>我在读提交事物隔离级别下，　发现当使用非索引字段加锁查询的时候，MySQL并不会锁住整个表，　而是锁住实际上被命中的那几行数据，　请问这是为什么呢<br>sessionA                         　　　　　　　　　　   sessionB<br>begin；<br>select * from t4 where d = 5 for update;<br>(５，　５，　５)<br>　　　　　　　　　　　　　　　　　　　　　update t4 set d = 5 where id = 10;(没有被阻塞)<br>　　　　　　　　　　　　　　　　　　　　　update t4 set d = 100 where id = ５;（被阻塞）<br>commit;<br>　　　　　　　　　　　　　　　　　　　　　finish<br>我想问sessionB　第一次更新语句的时候，　为什么没有被阻塞，　是因为这时候MySQL精确定位到了id为５的数据，　并且加了行锁的原因么？<br>在可重复读隔离级别下，sessionB的第一条更新语句是被阻塞的","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434653,"discussion_content":"事务隔离级别是不是read-committed?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546008294,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54973,"user_name":"Chu~♡·の~","can_delete":false,"product_type":"c1","uid":1057960,"ip_address":"","ucode":"69B0FBEC66FD48","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/a8/c0148cb8.jpg","comment_is_top":false,"comment_ctime":1545990387,"is_pvip":false,"replies":[{"id":"19889","content":"这么说也对…😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545994474,"ip_address":"","comment_id":54973,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545990387","product_id":100020801,"comment_content":"主要原因是索引上倒序扫描加锁，所以5-10之间加了间隙锁导致的吗？因为insert into t values(4, 4, 4)是可以的","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434636,"discussion_content":"这么说也对…😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545994474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54941,"user_name":"小新","can_delete":false,"product_type":"c1","uid":1246916,"ip_address":"","ucode":"A5A6F142D7BC44","user_header":"https://static001.geekbang.org/account/avatar/00/13/06/c4/11c9aa38.jpg","comment_is_top":false,"comment_ctime":1545985803,"is_pvip":false,"replies":[{"id":"19878","content":"会的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545988410,"ip_address":"","comment_id":54941,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545985803","product_id":100020801,"comment_content":"老师，后面的课程会讲mysql的读写分离吗？？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434622,"discussion_content":"会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545988410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54928,"user_name":"一大只😴","can_delete":false,"product_type":"c1","uid":1310960,"ip_address":"","ucode":"92F3D2B7F63568","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg","comment_is_top":false,"comment_ctime":1545982870,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545982870","product_id":100020801,"comment_content":"老师，5.7.21版本RR情况下，例1的session2 update t set d=5 where id=0;没有被锁住，可以执行，是不是版本有啥bug呀？我另一台虚拟机上的mariadb 10.3.11在执行例1的操作时，就被锁住了。<br><br>#######################session 1###############################<br>&quot;root@localhost:mysql.sock  [test]&gt;show variables like &#39;%iso%&#39;;<br>+-----------------------+-----------------+<br>| Variable_name         | Value           |<br>+-----------------------+-----------------+<br>| transaction_isolation | REPEATABLE-READ |<br>| tx_isolation          | REPEATABLE-READ |<br>+-----------------------+-----------------+<br>2 rows in set (0.01 sec)<br><br>&quot;root@localhost:mysql.sock  [test]&gt;select * from t;<br>+----+------+------+<br>| id | c    | d    |<br>+----+------+------+<br>|  0 |    0 |    0 |<br>|  5 |    5 |    5 |<br>| 10 |   10 |   10 |<br>| 15 |   15 |   15 |<br>| 20 |   20 |   20 |<br>| 25 |   25 |   25 |<br>+----+------+------+<br>6 rows in set (0.00 sec)<br><br>&quot;root@localhost:mysql.sock  [test]&gt;\\! date<br>Fri Dec 28 15:39:03 CST 2018<br>&quot;root@localhost:mysql.sock  [test]&gt;begin;<br>Query OK, 0 rows affected (0.00 sec)<br><br>&quot;root@localhost:mysql.sock  [test]&gt;select * from t where d=5 for update;<br>+----+------+------+<br>| id | c    | d    |<br>+----+------+------+<br>|  5 |    5 |    5 |<br>+----+------+------+<br>1 row in set (0.00 sec)<br><br><br>#####################session 2##########################<br>&quot;root@localhost:mysql.sock  [test]&gt;\\! date<br>Fri Dec 28 15:39:24 CST 2018<br>&quot;root@localhost:mysql.sock  [test]&gt;update t set d=5 where id=0;<br>ERROR 2006 (HY000): MySQL server has gone away<br>No connection. Trying to reconnect...<br>Connection id:    11902<br>Current database: test<br><br>Query OK, 1 row affected (0.03 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0","like_count":0},{"had_liked":false,"id":54898,"user_name":"Chu~♡·の~","can_delete":false,"product_type":"c1","uid":1057960,"ip_address":"","ucode":"69B0FBEC66FD48","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/a8/c0148cb8.jpg","comment_is_top":false,"comment_ctime":1545979329,"is_pvip":false,"replies":[{"id":"19883","content":"额，4确实是可以的，不过咱们问题说的是6😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545988765,"ip_address":"","comment_id":54898,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545979329","product_id":100020801,"comment_content":"文中的问题应该和索引的扫描顺序有关吧，测试了insert into t values(4, 4, 4);是可以插入的。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434604,"discussion_content":"额，4确实是可以的，不过咱们问题说的是6😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545988765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54869,"user_name":"南山","can_delete":false,"product_type":"c1","uid":1119593,"ip_address":"","ucode":"94656FE4A6C378","user_header":"https://static001.geekbang.org/account/avatar/00/11/15/69/187b9968.jpg","comment_is_top":false,"comment_ctime":1545973336,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1545973336","product_id":100020801,"comment_content":"老师，<br>1:可重复读是通过快照的方式来实现的吗？<br>2:实际场景中比如银行统计A的总资产，在事务开启的时候，A有三条存款记录:100，200，300，那我们统计出来的是有600，但是统计的事务没提交，A又存了一笔，400并提交这个存钱事务成功。那么实际上a的总资产已经1000了，但是统计的事务读取到的还是600。那可不可以认为可重复读并没有通过锁的方式来保证真实数据的一致性？<br>3:可重复读的真实应用场景是什么样的呢，比如实际开发中有什么业务特征是需要考虑是否采用可重复读级别呢？","like_count":0},{"had_liked":false,"id":54857,"user_name":"pguser","can_delete":false,"product_type":"c1","uid":1010366,"ip_address":"","ucode":"A64F83693BB6AE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6a/be/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1545971189,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545971189","product_id":100020801,"comment_content":"这个让我想起一个业务，一张表，三个字段:id编号，开始时间，结束时间，需要保证在id相同的情况下，不允许出现时间范围重叠的两条记录，在mysql中就可以在rr隔离级别下用间隙锁实现，但在postgresql里就可以在不提高隔离级别的情况下用范围约束实现。","like_count":0},{"had_liked":false,"id":54840,"user_name":"风轨","can_delete":false,"product_type":"c1","uid":1185844,"ip_address":"","ucode":"7B8A5233B61EB0","user_header":"https://static001.geekbang.org/account/avatar/00/12/18/34/c082419c.jpg","comment_is_top":false,"comment_ctime":1545968581,"is_pvip":false,"replies":[{"id":"19868","content":"后来成功了吗😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545974947,"ip_address":"","comment_id":54840,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545968581","product_id":100020801,"comment_content":"今天这个思考题差点儿没有复现出来。<br>session B会被锁住应该是MySQL的实现问题，按理说只需要锁住[15,20]即可，但next-key lock会锁住两个区间（10,15],(15,20]，11刚好落在了这个范围内。<br><br>session C会锁住和排序有关，最开始时我没给session A的排序加DESC，导致（6,6,6）能正常插入，换了数据库、隔离级别都能插入，后来尝试插入（21,21,21）发现是阻塞的。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434581,"discussion_content":"后来成功了吗😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545974947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54838,"user_name":"月饮沙","can_delete":false,"product_type":"c1","uid":1309117,"ip_address":"","ucode":"2470CF89245CBE","user_header":"https://static001.geekbang.org/account/avatar/00/13/f9/bd/40ea003f.jpg","comment_is_top":false,"comment_ctime":1545968355,"is_pvip":false,"replies":[{"id":"19898","content":"这里我不打算引入意向锁的概念，容易让大家晕（要把这个事情讲清楚我各种砍概念😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545995145,"ip_address":"","comment_id":54838,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545968355","product_id":100020801,"comment_content":"如果是因为意向排他锁导致的sessionC等待，那么有一个问题，意向锁是什么时候释放的呢？获取行锁之前获取，然后获取到表的行锁之后就释放了吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434580,"discussion_content":"这里我不打算引入意向锁的概念，容易让大家晕（要把这个事情讲清楚我各种砍概念😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545995145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54834,"user_name":"月饮沙","can_delete":false,"product_type":"c1","uid":1309117,"ip_address":"","ucode":"2470CF89245CBE","user_header":"https://static001.geekbang.org/account/avatar/00/13/f9/bd/40ea003f.jpg","comment_is_top":false,"comment_ctime":1545967960,"is_pvip":false,"replies":[{"id":"19899","content":"不对，即使没有sessionB, sessionC也是要等锁的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545995189,"ip_address":"","comment_id":54834,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545967960","product_id":100020801,"comment_content":"sessionA给表中的（10-15],(15-20]加了X锁<br>sessionB要插入数据，要获取记录11的行级X锁，在获取记录11的行级X锁钱，要先获取表t的意向排他锁。由于在间隙(15-20]上存在X锁，所以进入了等待，但是表t上的意向排他锁也不会释放<br>sessionC要插入数据，也要先获取表t的表的意向排他锁，由于session B已经占用了表t的意向排他锁，所以sessionC也要等待<br><br>这样对吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434577,"discussion_content":"不对，即使没有sessionB, sessionC也是要等锁的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545995189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54824,"user_name":"布衣骇客","can_delete":false,"product_type":"c1","uid":1256280,"ip_address":"","ucode":"5226B0F67090D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/2b/58/11c05ccb.jpg","comment_is_top":false,"comment_ctime":1545966266,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545966266","product_id":100020801,"comment_content":"这篇很硬核，多多实践几次，外加老师的理论，很是受用","like_count":0},{"had_liked":false,"id":54823,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545966074,"is_pvip":false,"replies":[{"id":"19871","content":"数据重新初始化试试","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545983096,"ip_address":"","comment_id":54823,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545966074","product_id":100020801,"comment_content":"验证了预习题，mysql5.7默认隔离级别是可重复读<br><br>mysql&gt; begin;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; select * from t where c&gt;=15 and c&lt;=20 order by c desc for update;<br><br>session b<br>mysql&gt; insert into t values(11,11,11); 这一句是阻塞的<br><br>session c <br>mysql&gt; insert into t values(6,6,6);  可以成功执行，不是你说的都会阻塞情况，按照理论上来说加了行锁和间隙锁，都回阻塞。这是为啥出现这样情况？<br>Query OK, 1 row affected (0.06 sec)  ","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434575,"discussion_content":"数据重新初始化试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545983096,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54822,"user_name":"曾剑","can_delete":false,"product_type":"c1","uid":1304922,"ip_address":"","ucode":"55466F93BE9978","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/5a/a6f2ec4b.jpg","comment_is_top":false,"comment_ctime":1545966063,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545966063","product_id":100020801,"comment_content":"会不会是这样的：<br>session B被锁是因为Session A持有了key c上(10,15]和(15,20]的Gap Lock,所以Session B获取不到Key c上11的行锁。<br>Session C被锁是因为Session A除了持有那两个Gap Lock也持有Key c上10的行锁。<br>而Session C除了申请Key c上6的行锁，还会扫描(5,10]的Gap，(5,10]的Gap与Session A持有的行锁10冲突，所以等待了。","like_count":0},{"had_liked":false,"id":54817,"user_name":"一大只😴","can_delete":false,"product_type":"c1","uid":1310960,"ip_address":"","ucode":"92F3D2B7F63568","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg","comment_is_top":false,"comment_ctime":1545965247,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545965247","product_id":100020801,"comment_content":"老师，我按照您的那个死锁事例操作，隔离级别RR，binlog_format=row，但是并没有出现死锁，session b的insert语句没有被session a的select语句锁住，session a 再执行insert时被堵住，最后报的是锁等待超时的错误","like_count":0},{"had_liked":false,"id":54816,"user_name":"董航","can_delete":false,"product_type":"c1","uid":1231787,"ip_address":"","ucode":"9CA208FD26F849","user_header":"https://static001.geekbang.org/account/avatar/00/12/cb/ab/1aac53bf.jpg","comment_is_top":false,"comment_ctime":1545965082,"is_pvip":false,"replies":[{"id":"19867","content":"主要是…这个答案很长，下一篇就说了哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545974892,"ip_address":"","comment_id":54816,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545965082","product_id":100020801,"comment_content":"老师说下答案呗，好难受啊，session3为啥被锁","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434572,"discussion_content":"主要是…这个答案很长，下一篇就说了哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545974892,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54810,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545964401,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545964401","product_id":100020801,"comment_content":"闭区间的值，5，10，15这些上面是行锁，然后5-10这上面是间隙锁，合并起来是next-key lock?是这样理解？","like_count":0},{"had_liked":false,"id":54808,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545964312,"is_pvip":false,"replies":[{"id":"19866","content":"一个间隙锁加上它右边的行锁，是一个next-key lock","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545974862,"ip_address":"","comment_id":54808,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545964312","product_id":100020801,"comment_content":"间隙锁和行锁合称 next-key lock，你后面又说 间隙锁和next-key lock,那这个next-key lock除了间隙锁之外的行锁？部分和包含的关系","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434570,"discussion_content":"一个间隙锁加上它右边的行锁，是一个next-key lock","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545974862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54806,"user_name":"曾剑","can_delete":false,"product_type":"c1","uid":1304922,"ip_address":"","ucode":"55466F93BE9978","user_header":"https://static001.geekbang.org/account/avatar/00/13/e9/5a/a6f2ec4b.jpg","comment_is_top":false,"comment_ctime":1545964144,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545964144","product_id":100020801,"comment_content":"session B被锁是因为Session A持有了key c上(10,15]和(15,20]的Gap Lock,所以Session B获取不到Key c上11的行锁。<br>但Session B为啥会被锁不知道。肯定也是Gap Lock，但这个Gap Lock怎么来的搞不清楚......","like_count":0},{"had_liked":false,"id":54801,"user_name":"Enterprize","can_delete":false,"product_type":"c1","uid":1215130,"ip_address":"","ucode":"3C120E9023B6C5","user_header":"https://static001.geekbang.org/account/avatar/00/12/8a/9a/7270d764.jpg","comment_is_top":false,"comment_ctime":1545963723,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1545963723","product_id":100020801,"comment_content":"for update 和 in share mode 的使用场景是啥样的","like_count":1,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162379,"discussion_content":"in share mode读锁\nfor update写锁（排他锁）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580988626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54799,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545963677,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545963677","product_id":100020801,"comment_content":"mysql是5.7的也没有出现幻读的情况","like_count":0},{"had_liked":false,"id":54798,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545963622,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1545963622","product_id":100020801,"comment_content":"复现不了你这个场景，后面的更新和插入都市阻塞的","like_count":0},{"had_liked":false,"id":54796,"user_name":"往事随风，顺其自然","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1545963556,"is_pvip":false,"replies":[{"id":"19865","content":"假设的😓","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545974765,"ip_address":"","comment_id":54796,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545963556","product_id":100020801,"comment_content":"经过验证for update再可重复读级别下，执行select * from t where  d =5 for update;<br> insert into t values(1,1,5); 和 update t set t=5 where id=0；两个语句都市阻塞等到的，文中的结果是怎么查出来的，还是你假设出来？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434567,"discussion_content":"假设的😓","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545974765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54793,"user_name":"姬野用菜刀","can_delete":false,"product_type":"c1","uid":1062188,"ip_address":"","ucode":"613CC95A16B8E4","user_header":"https://static001.geekbang.org/account/avatar/00/10/35/2c/429323f3.jpg","comment_is_top":false,"comment_ctime":1545963283,"is_pvip":false,"replies":[{"id":"19862","content":"不同呀，释放就直接释放，不要走一遍索引","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545972856,"ip_address":"","comment_id":54793,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545963283","product_id":100020801,"comment_content":"想请教下丁老师~行锁在释放的时候是怎么处理的呢？还需要再走一遍索引，或者全表扫描一遍吗？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434566,"discussion_content":"不同呀，释放就直接释放，不要走一遍索引","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545972856,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54789,"user_name":"dzkk","can_delete":false,"product_type":"c1","uid":1301932,"ip_address":"","ucode":"A81EFDB1D43C0D","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/ac/f40bbd15.jpg","comment_is_top":false,"comment_ctime":1545962862,"is_pvip":false,"replies":[{"id":"19864","content":"我是说假设可以这么做… 是要推导出后面的错误结果的<br><br><br>实际上确实会被锁住😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1545974733,"ip_address":"","comment_id":54789,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1545962862","product_id":100020801,"comment_content":"老师，第一个案例：<br>session1：<br>begin：<br>select * from t where d=5 for update;<br><br>session2：<br>update t set d=5 where id=0;<br><br>这个场景下session2因该被锁啊，看您那边怎么能正常执行啊？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":434565,"discussion_content":"我是说假设可以这么做… 是要推导出后面的错误结果的\n\n\n实际上确实会被锁住😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1545974733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54777,"user_name":"可凡不凡","can_delete":false,"product_type":"c1","uid":1296289,"ip_address":"","ucode":"9D42D6C5274D48","user_header":"https://static001.geekbang.org/account/avatar/00/13/c7/a1/273bff58.jpg","comment_is_top":false,"comment_ctime":1545961716,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1545961716","product_id":100020801,"comment_content":"老师,如果在 update tab1 set name=( select name from tab2 where id=1)...;<br>(tab2.id 是主键)<br>上面这个语句,子查询的 tab2.id 上的索引会被锁住吗?","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162380,"discussion_content":"这不是读吗？会锁吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580988701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":54766,"user_name":"小文","can_delete":false,"product_type":"c1","uid":1198258,"ip_address":"","ucode":"4D6257B8D63FA4","user_header":"https://static001.geekbang.org/account/avatar/00/12/48/b2/cca85581.jpg","comment_is_top":false,"comment_ctime":1545960830,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1545960830","product_id":100020801,"comment_content":"结构（id,pid）=》 数据 (1,3)(5,6)(10,9)<br>如果select pid = 7 for update,此时记录没有pid=7，所以会加（5，10）的间隙锁。<br>但是如果select pid = 6 for update,此时记录有pid=6,(5,6),  会加（1，5]这样的锁 还是 （1，10）这样的锁呢.....","like_count":1,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":162388,"discussion_content":"会不会是（6，10）呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580988889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}