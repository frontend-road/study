{"id":543649,"title":"01ï½œiOSå¹³å°éŸ³é¢‘æ¸²æŸ“ï¼ˆä¸€ï¼‰ï¼šä½¿ç”¨AudioQueueæ¸²æŸ“éŸ³é¢‘","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å±•æ™“å‡¯ã€‚</p><p>è®°å¾—åœ¨å¼€ç¯‡çš„æ—¶å€™æˆ‘è¯´è¿‡ï¼Œæˆ‘ä»¬æœ€åçš„ç›®æ ‡ä¹‹ä¸€å°±æ˜¯è¦å®ç°ä¸€ä¸ªè§†é¢‘æ’­æ”¾å™¨é¡¹ç›®ã€‚è€Œæƒ³è¦å®ç°è¿™ä¸ªé¡¹ç›®ï¼Œéœ€è¦æˆ‘ä»¬å…ˆæŒæ¡éŸ³é¢‘æ¸²æŸ“ã€è§†é¢‘æ¸²æŸ“ä»¥åŠéŸ³è§†é¢‘åŒæ­¥ç­‰çŸ¥è¯†ã€‚æ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±æ¥è¿ˆå‡ºç¬¬ä¸€æ­¥â€”â€”éŸ³é¢‘çš„æ¸²æŸ“ã€‚</p><p>éŸ³é¢‘æ¸²æŸ“ç›¸å…³çš„æŠ€æœ¯æ¡†æ¶æ¯”è¾ƒå¤šï¼Œå¹³å°ä¸åŒï¼Œéœ€è¦ç”¨åˆ°çš„æŠ€æœ¯æ¡†æ¶ä¹Ÿä¸åŒã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸€ä¸‹iOSå¹³å°éƒ½æœ‰å“ªäº›éŸ³é¢‘æ¡†æ¶å¯ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œä»¥åŠæ€ä¹ˆåœ¨iOSå¹³å°åšéŸ³é¢‘æ¸²æŸ“ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å›¾1ï¼ŒiOSå¹³å°çš„éŸ³é¢‘æ¡†æ¶ï¼Œé‡Œé¢æ¯”è¾ƒé«˜å±‚æ¬¡çš„éŸ³é¢‘æ¡†æ¶æœ‰Media Playerã€AV Foundationã€OpenALå’ŒAudio Toolboxï¼ˆAudioQueueï¼‰ï¼Œè¿™äº›æ¡†æ¶éƒ½å°è£…äº†AudioUnitï¼Œç„¶åæä¾›äº†æ›´é«˜å±‚æ¬¡çš„ã€åŠŸèƒ½æ›´ç²¾ç®€ã€èŒè´£æ›´åŠ å•ä¸€çš„APIæ¥å£ã€‚è¿™é‡Œä½ å…ˆç®€å•åœ°äº†è§£ä¸€ä¸‹è¿™äº›éŸ³é¢‘æ¡†æ¶ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠAudioUnitåœ¨æ•´ä¸ªéŸ³é¢‘ä½“ç³»ä¸­çš„ä½œç”¨ï¼Œä¸‹èŠ‚è¯¾æˆ‘ä¼šç»™ä½ è¯¦ç»†åœ°è®²è§£AudioUnitæ¡†æ¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/42/7f/429c932f1b5fed302fa262bff76yy87f.png?wh=1744x704\" alt=\"\" title=\"å›¾1 iOSå¹³å°çš„éŸ³é¢‘æ¡†æ¶ï¼ˆå›¾ç‰‡æ¥è‡ªè‹¹æœå®˜ç½‘ï¼‰\"></p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦ä½å¼€é”€åœ°å®ç°å½•åˆ¶æˆ–æ’­æ”¾éŸ³é¢‘çš„åŠŸèƒ½ï¼Œå°±éœ€è¦ç”¨åˆ°iOSéŸ³é¢‘æ¡†æ¶ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ¥å£â€”â€”<strong>AudioQueue</strong>ï¼Œ<strong>å®ƒæ˜¯å®ç°å½•åˆ¶ä¸æ’­æ”¾åŠŸèƒ½æœ€ç®€å•çš„APIæ¥å£</strong>ï¼Œä½œä¸ºå¼€å‘è€…çš„æˆ‘ä»¬æ— éœ€çŸ¥é“å¤ªå¤šå†…éƒ¨ç»†èŠ‚ï¼Œå°±å¯ä»¥ç®€å•åœ°å®Œæˆæ’­æ”¾PCMæ•°æ®çš„åŠŸèƒ½ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸æ–¹ä¾¿äº†ã€‚</p><!-- [[[read_end]]] --><p>åœ¨å®é™…å­¦ä¹ AudioQueueæ¡†æ¶ä¹‹å‰ï¼Œæˆ‘ä¼šå…ˆæŠŠAudioSessionç»™ä½ è®²æ¸…æ¥šï¼Œå› ä¸ºAudioSessionæ˜¯æˆ‘ä»¬ä¸ç³»ç»Ÿå¯¹è¯çš„é‡è¦çª—å£ï¼Œå®ƒèƒ½å¤Ÿå‘ç³»ç»Ÿæè¿°åº”ç”¨éœ€è¦çš„éŸ³é¢‘èƒ½åŠ›ï¼Œæ‰€ä»¥éœ€è¦åœ¨å­¦ä¼šä½¿ç”¨AudioSessionåŸºç¡€ä¸Šï¼Œå†å»å­¦ä¹ å…·ä½“çš„æ¡†æ¶ã€‚</p><h2>AVAudioSession</h2><p>åœ¨iOSçš„éŸ³è§†é¢‘å¼€å‘ä¸­ï¼Œä½¿ç”¨å…·ä½“APIä¹‹å‰éƒ½ä¼šå…ˆåˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œè€ŒéŸ³é¢‘è¿™é‡Œçš„ä¼šè¯å°±æ˜¯AVAudioSessionï¼Œ<strong>å®ƒä»¥å•ä¾‹çš„å½¢å¼å­˜åœ¨ï¼Œç”¨äºç®¡ç†ä¸è·å–iOSè®¾å¤‡éŸ³é¢‘çš„ç¡¬ä»¶ä¿¡æ¯</strong>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¥è·å–AudioSessionçš„å®ä¾‹ï¼š</p><pre><code class=\"language-plain\">AVAudioSession *audioSession = [AVAudioSession&nbsp;sharedInstance];\n</code></pre><h3>åŸºæœ¬è®¾ç½®</h3><p>è·å¾—AudioSessionå®ä¾‹ä¹‹åï¼Œå°±å¯ä»¥è®¾ç½®ä»¥ä½•ç§æ–¹å¼ä½¿ç”¨éŸ³é¢‘ç¡¬ä»¶åšå“ªäº›å¤„ç†äº†ï¼ŒåŸºæœ¬çš„è®¾ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ol>\n<li>æ ¹æ®æˆ‘ä»¬éœ€è¦ç¡¬ä»¶è®¾å¤‡æä¾›çš„èƒ½åŠ›æ¥è®¾ç½®ç±»åˆ«ï¼š</li>\n</ol><pre><code class=\"language-plain\">[audioSession&nbsp;setCategory:AVAudioSessionCategoryPlayback&nbsp;error:&amp;error];&nbsp;\n</code></pre><ol start=\"2\">\n<li>è®¾ç½®I/Oçš„Bufferï¼ŒBufferè¶Šå°è¯´æ˜å»¶è¿Ÿè¶Šä½ï¼š</li>\n</ol><pre><code class=\"language-plain\">NSTimeInterval&nbsp;bufferDuration = 0.002;\n[audioSession&nbsp;setPreferredIOBufferDuration:bufferDuration&nbsp;error:&amp;error];&nbsp;\n</code></pre><ol start=\"3\">\n<li>è®¾ç½®é‡‡æ ·é¢‘ç‡ï¼Œè®©ç¡¬ä»¶è®¾å¤‡æŒ‰ç…§è®¾ç½®çš„é‡‡æ ·ç‡æ¥é‡‡é›†æˆ–è€…æ’­æ”¾éŸ³é¢‘ï¼š</li>\n</ol><pre><code class=\"language-plain\">double hwSampleRate = 44100.0;\n[audioSession&nbsp;setPreferredSampleRate:hwSampleRate error:&amp;error];\n</code></pre><ol start=\"4\">\n<li>å½“è®¾ç½®å®Œæ¯•æ‰€æœ‰å‚æ•°ä¹‹åå°±å¯ä»¥æ¿€æ´»AudioSessionäº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>\n</ol><pre><code class=\"language-plain\">[audioSession&nbsp;setActive:YES error:&amp;error];\n</code></pre><p>ç»è¿‡ä¸Šè¿°å‡ ä¸ªç®€å•çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å¯¹AVAudioSessionçš„è®¾ç½®ã€‚å½“æˆ‘ä»¬ä½¿ç”¨å…·ä½“APIçš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šæŒ‰ç…§ä¸Šè¿°è®¾ç½®çš„å‚æ•°è¿›è¡Œæ’­æ”¾æˆ–è€…å›è°ƒç»™å¼€å‘è€…è¿›è¡Œå¤„ç†ã€‚</p><h3>æ·±å…¥ç†è§£AudioSession</h3><p>é™¤äº†ä¸Šè¿°åŸºæœ¬çš„è®¾ç½®ä¹‹å¤–ï¼Œæˆ‘ä»¬å†ä»ä»¥ä¸‹å‡ ä¸ªå±‚é¢æ·±å…¥ç†è§£ä¸€ä¸‹AudioSessionï¼Œåœ¨AVAudioSessionè®¾ç½®Categoryçš„æ—¶å€™æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚çš„ï¼Œåˆ†åˆ«æ˜¯Categoryå’ŒCategoryOptionsï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå®ƒå¯èƒ½ä¼šäº§ç”Ÿå¥‡æ•ˆã€‚</p><ol>\n<li>Categoryæ˜¯å‘ç³»ç»Ÿæè¿°åº”ç”¨éœ€è¦çš„èƒ½åŠ›ï¼Œå¸¸ç”¨çš„åˆ†ç±»å¦‚ä¸‹ï¼š</li>\n</ol><ul>\n<li>AVAudioSessionCategoryPlaybackï¼šç”¨äºæ’­æ”¾å½•åˆ¶éŸ³ä¹æˆ–è€…å…¶å®ƒå£°éŸ³çš„ç±»åˆ«ï¼Œå¦‚è¦åœ¨åº”ç”¨ç¨‹åºè½¬æ¢åˆ°åå°æ—¶ç»§ç»­æ’­æ”¾ï¼ˆé”å±æƒ…å†µä¸‹ï¼‰ï¼Œåœ¨xcodeä¸­è®¾ç½® UIBackgroundModes å³å¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ­¤ç±»åˆ«æ„å‘³ç€ï¼Œåº”ç”¨çš„éŸ³é¢‘ä¸å¯æ··åˆï¼Œæ¿€æ´»éŸ³é¢‘ä¼šè¯å°†ä¸­æ–­å…¶å®ƒä¸å¯æ··åˆçš„éŸ³é¢‘ä¼šè¯ã€‚å¦‚è¦ä½¿ç”¨æ··éŸ³ï¼Œåˆ™ä½¿ç”¨AVAudioSessionCategoryOptionMixWithOthersã€‚</li>\n<li>AVAudioSessionCategoryPlayAndRecord&nbsp;: åŒæ—¶éœ€è¦å½•éŸ³ï¼ˆè¾“å…¥ï¼‰å’Œæ’­æ”¾ï¼ˆè¾“å‡ºï¼‰éŸ³é¢‘çš„ç±»åˆ«ï¼Œä¾‹å¦‚Kæ­Œã€RTCåœºæ™¯ã€‚æ³¨æ„ï¼šç”¨æˆ·å¿…é¡»æ‰“å¼€éŸ³é¢‘å½•åˆ¶æƒé™ï¼ˆiPhone éº¦å…‹é£æƒé™ï¼‰ã€‚</li>\n</ul><ol start=\"2\">\n<li>CategoryOptionsæ˜¯å‘ç³»ç»Ÿè®¾ç½®ç±»åˆ«çš„å¯é€‰é¡¹ï¼Œå…·ä½“åˆ†ç±»å¦‚ä¸‹ï¼š</li>\n</ol><ul>\n<li>AVAudioSessionCategoryOptionDefaultToSpeakerï¼šæ­¤é€‰é¡¹åªèƒ½åœ¨ä½¿ç”¨PlayAndRecordç±»åˆ«æ—¶è®¾ç½®ã€‚å®ƒç”¨äºä¿è¯åœ¨æ²¡æœ‰ä½¿ç”¨å…¶ä»–é…ä»¶ï¼ˆå¦‚è€³æœºï¼‰çš„æƒ…å†µä¸‹ï¼ŒéŸ³é¢‘å§‹ç»ˆä¼šè·¯ç”±è‡³æ‰¬å£°å™¨è€Œä¸æ˜¯å¬ç­’ã€‚è€Œå¦‚æœç±»åˆ«è®¾ç½®çš„æ˜¯Playbackï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨Speakerè¿›è¡Œè¾“å‡ºï¼Œæ— éœ€è¿›è¡Œæ­¤é¡¹è®¾ç½®ã€‚</li>\n<li>AVAudioSessionCategoryOptionAllowBluetoothï¼šæ­¤é€‰é¡¹ä»£è¡¨éŸ³é¢‘å½•å…¥å’Œè¾“å‡ºå…¨éƒ¨èµ°è“ç‰™è®¾å¤‡ï¼Œä»…å¯ä»¥ä¸ºPlayAndRecordè¿˜æœ‰Recordè¿™ä¸¤ä¸ªç±»åˆ«è®¾ç½®è¿™ä¸ªé€‰é¡¹ï¼Œæ³¨æ„æ­¤æ—¶æ’­æ”¾å’Œå½•åˆ¶çš„å£°éŸ³éŸ³è´¨å‡ä¸ºé€šè¯éŸ³è´¨ï¼ˆ16kHzï¼‰ï¼Œé€‚ç”¨äºRTCçš„é€šè¯åœºæ™¯ï¼Œä½†ä¸é€‚ç”¨äºKæ­Œç­‰éœ€è¦é«˜éŸ³è´¨é‡‡é›†ä¸æ’­æ”¾çš„åœºæ™¯ã€‚</li>\n<li>AVAudioSessionCategoryOptionAllowBluetoothA2DPï¼šæ­¤é€‰é¡¹ä»£è¡¨éŸ³é¢‘å¯ä»¥è¾“å‡ºåˆ°é«˜éŸ³è´¨ï¼ˆç«‹ä½“å£°ã€ä»…æ”¯æŒéŸ³é¢‘è¾“å‡ºä¸æ”¯æŒéŸ³é¢‘å½•å…¥ï¼‰çš„è“ç‰™è®¾å¤‡ä¸­ã€‚å¦‚æœä½¿ç”¨Playbackç±»åˆ«ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä½¿ç”¨è¿™ä¸ªA2DPé€‰é¡¹ï¼Œå¦‚æœä½¿ç”¨PlayAndRecordç±»åˆ«ï¼Œéœ€è¦å¼€å‘è€…è‡ªå·±æ‰‹åŠ¨è®¾ç½®è¿™ä¸ªé€‰é¡¹ï¼ŒéŸ³é¢‘é‡‡é›†å°†ä½¿ç”¨æœºèº«å†…ç½®éº¦å…‹é£ï¼ˆåœ¨éœ€è¦é«˜éŸ³è´¨è¾“å‡ºå’Œè¾“å…¥çš„åœºæ™¯ä¸‹å¯ä»¥è®¾ç½®æˆè¿™ç§ï¼‰ã€‚</li>\n</ul><ol start=\"3\">\n<li>ç›‘å¬éŸ³é¢‘ç„¦ç‚¹æŠ¢å ï¼Œä¸€èˆ¬åœ¨æ£€æµ‹åˆ°éŸ³é¢‘è¢«æ‰“æ–­çš„æ—¶å€™å¤„ç†ä¸€äº›è‡ªå·±ä¸šåŠ¡ä¸Šçš„æ“ä½œï¼Œæ¯”å¦‚æš‚åœæ’­æ”¾éŸ³é¢‘ç­‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>\n</ol><pre><code class=\"language-plain\">[[NSNotificationCenter&nbsp;defaultCenter] addObserver:self&nbsp;selector:@selector(audioSessionInterruptionNoti:)&nbsp;name:AVAudioSessionInterruptionNotification object:[AVAudioSession&nbsp;sharedInstance]];\n&nbsp;\n- (void)audioSessionInterruptionNoti:(NSNotification *)noti&nbsp;{&nbsp;&nbsp;&nbsp;\nAVAudioSessionInterruptionType type = [noti.userInfo[AVAudioSessionInterruptionTypeKey] intValue];\nif (type == AVAudioSessionInterruptionTypeBegan) {\n//Do Something\n}\n}\n</code></pre><ol start=\"4\">\n<li>ç›‘å¬å£°éŸ³ç¡¬ä»¶è·¯ç”±å˜åŒ–ï¼Œå½“æ£€æµ‹åˆ°æ’æ‹”è€³æœºæˆ–è€…æ¥å…¥è“ç‰™è®¾å¤‡çš„æ—¶å€™ï¼Œä¸šåŠ¡éœ€è¦åšä¸€äº›è‡ªå·±çš„æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š</li>\n</ol><pre><code class=\"language-plain\">[[NSNotificationCenter&nbsp;defaultCenter] addObserver:self selector:@selector(audioRouteChangeListenerCallback:) name:AVAudioSessionRouteChangeNotification&nbsp;object:nil];\n&nbsp;\n- (void)audioRouteChangeListenerCallback:(NSNotification*)notification {\nNSDictionary *interuptionDict = notification.userInfo;\nNSInteger&nbsp;routeChangeReason = [[interuptionDict&nbsp;valueForKey:AVAudioSessionRouteChangeReasonKey] integerValue];\nif (routeChangeReason==AVAudioSessionRouteChangeReasonNewDeviceAvailable ||&nbsp;routeChangeReason == AVAudioSessionRouteChangeReasonOldDeviceUnavailable ||&nbsp;routeChangeReason == AVAudioSessionRouteChangeReasonWakeFromSleep ) {\n//Do&nbsp;Something\n} else if (\nrouteChangeReason == AVAudioSessionRouteChangeReasonCategoryChange ||\nrouteChangeReason == AVAudioSessionRouteChangeReasonOverride) {\n//Do&nbsp;Something\n}\n}\n</code></pre><ol start=\"5\">\n<li>ç”³è¯·å½•éŸ³æƒé™ï¼Œé¦–å…ˆåˆ¤æ–­æˆæƒçŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰è¯¢é—®è¿‡ï¼Œå°±è¯¢é—®ç”¨æˆ·æˆæƒï¼Œå¦‚æœæ‹’ç»äº†å°±å¼•å¯¼ç”¨æˆ·è¿›å…¥è®¾ç½®é¡µé¢æ‰‹åŠ¨æ‰“å¼€ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>\n</ol><pre><code class=\"language-plain\">AVAuthorizationStatus status = [AVCaptureDevice&nbsp;authorizationStatusForMediaType:AVMediaTypeAudio];\n&nbsp;&nbsp;&nbsp; if (status == AVAuthorizationStatusNotDetermined) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [[AVAudioSession&nbsp;sharedInstance] requestRecordPermission:^(BOOL granted) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //grantedä»£è¡¨æ˜¯å¦æˆæƒ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }];\n&nbsp;&nbsp;&nbsp; } else if (status == AVAuthorizationStatusRestricted || status == AVAuthorizationStatusDenied) {// æœªæˆæƒ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //å¼•å¯¼ç”¨æˆ·è·³å…¥è®¾ç½®é¡µé¢\n&nbsp;&nbsp;&nbsp; } else {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // å·²æˆæƒ\n&nbsp;&nbsp;&nbsp; }\n</code></pre><p><strong>æ³¨æ„ï¼šä»iOS 10å¼€å§‹ï¼Œæ‰€æœ‰è®¿é—®ä»»ä½•è®¾å¤‡éº¦å…‹é£çš„åº”ç”¨éƒ½å¿…é¡»é™æ€å£°æ˜å…¶æ„å›¾ã€‚</strong>ä¸ºæ­¤ï¼Œåº”ç”¨ç¨‹åºç°åœ¨å¿…é¡»åœ¨å…¶Info.plistæ–‡ä»¶ä¸­åŒ…å«NSMicrophoneUsageDescriptioné”®ï¼Œå¹¶ä¸ºæ­¤å¯†é’¥æä¾›ç›®çš„å­—ç¬¦ä¸²ã€‚å½“ç³»ç»Ÿæç¤ºç”¨æˆ·å…è®¸è®¿é—®æ—¶ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°†æ˜¾ç¤ºä¸ºè­¦æŠ¥çš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœåº”ç”¨ç¨‹åºå°è¯•è®¿é—®ä»»ä½•è®¾å¤‡çš„éº¦å…‹é£è€Œæ²¡æœ‰æ­¤é”®å’Œå€¼ï¼Œåˆ™åº”ç”¨ç¨‹åºå°†ç»ˆæ­¢ã€‚</p><p>ç°åœ¨ï¼ŒéŸ³é¢‘æ¸²æŸ“ç¬¬ä¸€æ­¥â€”â€”ä¼šè¯åˆ›å»ºå°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›å…¥éŸ³é¢‘æ¸²æŸ“æ¡†æ¶çš„å­¦ä¹ äº†ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹AudioQueueæ¸²æŸ“éŸ³é¢‘çš„éƒ¨åˆ†ã€‚</p><h2>AudioQueueè¯¦è§£</h2><p>iOSä¸ºå¼€å‘è€…åœ¨AudioToolboxè¿™ä¸ªframeworkä¸­æä¾›äº†ä¸€ä¸ªåä¸ºAudioQueueRefçš„ç±»ï¼ŒAudioQueueå†…éƒ¨ä¼šå®Œæˆä»¥ä¸‹èŒè´£ï¼š</p><ul>\n<li>è¿æ¥éŸ³é¢‘çš„ç¡¬ä»¶è¿›è¡Œå½•éŸ³æˆ–è€…æ’­æ”¾ï¼›</li>\n<li>ç®¡ç†å†…å­˜ï¼›</li>\n<li>æ ¹æ®å¼€å‘è€…é…ç½®çš„æ ¼å¼ï¼Œè°ƒç”¨ç¼–è§£ç å™¨è¿›è¡ŒéŸ³é¢‘æ ¼å¼è½¬æ¢ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹AudioQueueæ’­æ”¾éŸ³é¢‘çš„ç»“æ„å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/5a/cd/5a73413d808694e8db31c6109681d2cd.jpg?wh=1920x645\" alt=\"å›¾ç‰‡\" title=\"å›¾2 AudioQueueæ’­æ”¾éŸ³é¢‘ç»“æ„å›¾\"></p><p>AudioQueueæš´éœ²ç»™å¼€å‘è€…çš„æ¥å£å¦‚ä¸‹ï¼š</p><ul>\n<li>ä½¿ç”¨æ­£ç¡®çš„éŸ³é¢‘æ ¼å¼ã€å›è°ƒæ–¹æ³•ç­‰å‚æ•°ï¼Œåˆ›å»ºå‡ºAudioQueueRefå¯¹è±¡ï¼›</li>\n<li>ä¸ºAudioQueueRefåˆ†é…Bufferï¼Œå¹¶å°†Bufferå…¥é˜Ÿï¼Œå¯åŠ¨AudioQueueï¼›</li>\n<li>åœ¨AudioQueueRefçš„å›è°ƒä¸­å¡«å……æŒ‡å®šæ ¼å¼çš„éŸ³é¢‘æ•°æ®ï¼Œå¹¶ä¸”é‡æ–°å…¥é˜Ÿï¼›</li>\n<li>æš‚åœã€æ¢å¤ç­‰å¸¸è§„æ¥å£ã€‚</li>\n</ul><p>äº†è§£äº†AudioQueueçš„å†…éƒ¨èŒè´£å’Œæš´éœ²ç»™å¼€å‘è€…çš„æ¥å£ä¹‹åï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹AudioQueueçš„è¿è¡Œæµç¨‹å§ï¼</p><h3>AudioQueueè¿è¡Œæµç¨‹</h3><p>AudioQueueçš„æ•´ä½“è¿è¡Œæµç¨‹åˆ†ä¸ºå¯åŠ¨å’Œè¿è¡Œé˜¶æ®µï¼Œå¯åŠ¨é˜¶æ®µä¸»è¦æ˜¯åº”ç”¨ç¨‹åºé…ç½®å’Œå¯åŠ¨AudioQueueï¼›è¿è¡Œé˜¶æ®µä¸»è¦æ˜¯AudioQueueå¼€å§‹æ’­æ”¾ä¹‹åå›è°ƒç»™åº”ç”¨ç¨‹åºå¡«å……bufferï¼Œå¹¶é‡æ–°å…¥é˜Ÿï¼Œ3ä¸ªbufferå‘¨è€Œå¤å§‹åœ°è¿è¡Œèµ·æ¥ï¼›ç›´åˆ°åº”ç”¨ç¨‹åºè°ƒç”¨AudioQueueçš„Pauseæˆ–è€…Stopç­‰æ¥å£ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªè¯¦ç»†çš„è¿è¡Œæµç¨‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8d/c1/8d23534dddf478fc7b89ce8e2d2023c1.jpg?wh=1920x2543\" alt=\"å›¾ç‰‡\" title=\"å›¾3 AudioQueueè¿è¡Œæµç¨‹\"></p><h4>å¯åŠ¨é˜¶æ®µ</h4><ol>\n<li>é…ç½®AudioQueueï¼š</li>\n</ol><pre><code class=\"language-plain\">AudioQueueNewInput(&amp;dataformat, playCallback, (__bridge void *)self, NULL, NULL, 0, &amp;queueRef);\n</code></pre><p>dataformatå°±æ˜¯éŸ³é¢‘æ ¼å¼ï¼Œåé¢æˆ‘ä»¬ä¼šé‡ç‚¹è®²è§£ï¼ŒplayCallbackæ˜¯å½“AudioQueueéœ€è¦æˆ‘ä»¬å¡«å……æ•°æ®æ—¶çš„å›è°ƒæ–¹æ³•ï¼Œå‡½æ•°è¿”å›å€¼ä¸ºOSStatusç±»å‹ï¼Œå¦‚æœä¸ºnoErråˆ™è¯´æ˜é…ç½®æˆåŠŸã€‚</p><ol start=\"2\">\n<li>åˆ†é…3ä¸ªBufferï¼Œå¹¶ä¸”ä¾æ¬¡çŒåˆ°AudioQueueä¸­ï¼š</li>\n</ol><pre><code class=\"language-plain\">for (int i = 0; i &lt; kNumberBuffers; i++) {\n  AudioQueueAllocateBuffer(queueRef, bufferBytesSize, &amp;buffers[i]);\n  AudioQueueEnqueueBuffer(queueRef, buffers[i], 0, NULL);\n}\n</code></pre><p>Bufferç±»å‹ä¸ºAudioQueueBufferRefï¼Œæ˜¯AudioQueueå¯¹å¤–æä¾›çš„æ•°æ®å°è£…ï¼Œå…·ä½“æ¯ä¸ªBufferçš„å¤§å°æ˜¯å¦‚ä½•å†³å®šçš„ï¼Œæˆ‘ä¼šåœ¨åé¢ä¸dataformatä¸€èµ·è®²è§£ã€‚</p><ol start=\"3\">\n<li>è°ƒç”¨Playæ–¹æ³•è¿›è¡Œæ’­æ”¾ï¼š</li>\n</ol><pre><code class=\"language-plain\">AudioQueueStart(queueRef, NULL)\n</code></pre><h4>è¿è¡Œé˜¶æ®µ</h4><p>å¯åŠ¨å®Œæ¯•åï¼Œæ¥ä¸‹æ¥å°±åˆ°è¿è¡Œé˜¶æ®µäº†ï¼Œè¿è¡Œé˜¶æ®µä¸»è¦åˆ†ä¸º4æ­¥ï¼š</p><ol>\n<li>AudioQueueå¯åŠ¨ä¹‹åä¼šæ’­æ”¾ç¬¬ä¸€ä¸ªbufferï¼›</li>\n<li>å½“æ’­æ”¾å®Œç¬¬ä¸€ä¸ªbufferä¹‹åï¼Œä¼šç»§ç»­æ’­æ”¾ç¬¬äºŒä¸ªbufferï¼Œä½†æ˜¯ä¸æ­¤åŒæ—¶å°†ç¬¬ä¸€ä¸ªbufferå›è°ƒç»™ä¸šåŠ¡å±‚ç”±å¼€å‘è€…è¿›è¡Œå¡«å……ï¼Œå¡«å……å®Œæ¯•é‡æ–°å…¥é˜Ÿï¼›</li>\n<li>ç¬¬äºŒä¸ªbufferæ’­æ”¾å®Œæ¯•åï¼Œä¼šç»§ç»­æ’­æ”¾ç¬¬ä¸‰ä¸ªbufferï¼Œä¸æ­¤åŒæ—¶ä¼šå°†ç¬¬äºŒä¸ªbufferå›è°ƒç»™ä¸šåŠ¡å±‚ç”±å¼€å‘è€…è¿›è¡Œå¡«å……ï¼Œå¡«å……å®Œæ¯•é‡æ–°å…¥é˜Ÿï¼›</li>\n<li>ç¬¬ä¸‰ä¸ªbufferæ’­æ”¾å®Œæ¯•åï¼Œä¼šç»§ç»­å¾ªç¯æ’­æ”¾é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªbufferï¼Œä¹Ÿä¼šå°†ç¬¬ä¸‰ä¸ªbufferå›è°ƒç»™ä¸šåŠ¡å±‚ç”±å¼€å‘è€…è¿›è¡Œå¡«å……ï¼Œå¡«å……å®Œæ¯•é‡æ–°å…¥é˜Ÿã€‚</li>\n</ol><pre><code class=\"language-plain\">static void playCallback(void *aqData, AudioQueueRef&nbsp;inAQ, AudioQueueBufferRef&nbsp;inBuffer) {\n  KSAudioPlayer *player = (__bridge KSAudioPlayer *)aqData;\n  //TODO: Fill Data\n  AudioQueueEnqueueBuffer(player-&gt;queueRef, inBuffer, numPackets,&nbsp;player.mPacketDescs);\n}\n</code></pre><p>è¿™æ ·ä¸€æ¥ï¼Œæ•´ä¸ªAudioQueueçš„è¿è¡Œæµç¨‹å°±è®²è§£å®Œäº†ï¼Œè¿˜è®°å¾—æˆ‘ä»¬åœ¨å‰é¢è¯´è¿‡AudioQueueå†…éƒ¨ä¼šè¿›è¡Œè°ƒç”¨ç¼–è§£ç å™¨è¿›è¡ŒéŸ³é¢‘æ ¼å¼è½¬æ¢å—ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¯¦ç»†ä»‹ç»ä¸€ä¸‹AudioQueueä¸­çš„Codecè¿è¡Œæµç¨‹ã€‚</p><h3>AudioQueueä¸­Codecè¿è¡Œæµç¨‹</h3><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒAudioQueueçš„å¼ºå¤§ä¹‹å¤„åœ¨äº<strong>å¼€å‘è€…å¯ä»¥ä¸ç”¨å…³å¿ƒæ’­æ”¾çš„æ•°æ®çš„ç¼–è§£ç æ ¼å¼ï¼Œå®ƒå†…éƒ¨ä¼šå¸®åŠ©å¼€å‘è€…å°†Codecçš„äº‹æƒ…åšå¥½</strong>ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†çš„æµç¨‹æˆ‘ä»¬æ˜¯æœ‰å¿…è¦å•æ‹å‡ºæ¥çœ‹ä¸€ä¸‹çš„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/58/23/58bb49c9c742bd6955fb5a21aafe6e23.jpg?wh=1920x967\" alt=\"å›¾ç‰‡\" title=\"å›¾4 Codecè¿è¡Œæµç¨‹\"></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œä¸»è¦åˆ†ä¸º3ä¸ªæ­¥éª¤ï¼š</p><ol>\n<li>å¼€å‘è€…é…ç½®AudioQueueçš„æ—¶å€™å‘Šè¯‰AudioQueueå…·ä½“ç¼–ç æ ¼å¼ï¼›</li>\n<li>å¼€å‘è€…åœ¨å›è°ƒå‡½æ•°ä¸­æŒ‰ç…§åŸå§‹æ ¼å¼å¡«å……bufferï¼›</li>\n<li>AudioQueueä¼šè‡ªå·±é‡‡ç”¨åˆé€‚çš„Codecå°†å‹ç¼©æ•°æ®è§£ç æˆPCMè¿›è¡Œæ’­æ”¾ã€‚</li>\n</ol><p>ä»‹ç»å®ŒCodecç›¸å…³çš„æµç¨‹ï¼Œä½ å¯èƒ½è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯æ•°æ®æ ¼å¼ä»¥åŠéŸ³é¢‘æ•°æ®åˆ°åº•åº”è¯¥å¦‚ä½•è®¾ç½®ä»¥åŠå¡«å……å‘¢ï¼Ÿè¿™ä¸ªå…¶å®å°±æ˜¯ä¹‹å‰æˆ‘ä»¬è¯´è¦é‡ç‚¹è®²è§£çš„éŸ³é¢‘æ ¼å¼ï¼ˆdataformatï¼‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·æ¥å­¦ä¹ ä¸€ä¸‹å§ï¼</p><h3>iOSå¹³å°çš„éŸ³é¢‘æ ¼å¼</h3><p>iOSå¹³å°çš„éŸ³é¢‘æ ¼å¼æ˜¯ASBDï¼ˆAudioStreamBasicDescriptionï¼‰ï¼Œç”¨æ¥æè¿°éŸ³é¢‘æ•°æ®çš„è¡¨ç¤ºæ–¹å¼ï¼Œç»“æ„ä½“å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">struct AudioStreamBasicDescription\n{\n&nbsp;&nbsp;&nbsp; AudioFormatID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mFormatID;\n    Float64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mSampleRate;    \n    UInt32              mChannelsPerFrame;    \n    UInt32              mFramesPerPacket;\n&nbsp;&nbsp;&nbsp; AudioFormatFlags&nbsp;&nbsp;&nbsp; mFormatFlags;\n&nbsp;&nbsp;&nbsp; UInt32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mBytesPerPacket;\n&nbsp;&nbsp;&nbsp; UInt32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mBytesPerFrame;\n&nbsp;&nbsp;&nbsp; UInt32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mBitsPerChannel;\n&nbsp;&nbsp;&nbsp; UInt32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mReserved;\n};\ntypedef struct AudioStreamBasicDescription&nbsp; AudioStreamBasicDescription;\n</code></pre><p>é’ˆå¯¹ç»“æ„ä½“ä¸­æ¯ä¸ªå­—æ®µï¼Œæˆ‘ä»¬éœ€è¦é…ä¸Šä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹æ¥é€ä¸ªè®²è§£ä¸€ä¸‹ï¼Œå…ˆçœ‹ä¸‹é¢è¿™ä¸ªæ ¼å¼çš„é…ç½®ï¼š</p><pre><code class=\"language-plain\">UInt32 bytesPerSample = sizeof(Float32);\nAudioStreamBasicDescription&nbsp;asbd;\nbzero(&amp;asbd, sizeof(asbd));&nbsp;\nasbd.mFormatID = kAudioFormatLinearPCM;\nasbd.mSampleRate = _sampleRate;&nbsp;\nasbd.mChannelsPerFrame = channels;&nbsp;\nasbd.mFramesPerPacket = 1;&nbsp;\nasbd.mFormatFlags = kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved;\nasbd.mBitsPerChannel = 8 * bytesPerSample;\nasbd.mBytesPerFrame = bytesPerSample;\nasbd.mBytesPerPacket = bytesPerSample;&nbsp;\n</code></pre><ul>\n<li>mFormatIDè¿™ä¸ªå‚æ•°æ˜¯ç”¨æ¥æŒ‡å®šéŸ³é¢‘çš„ç¼–ç æ ¼å¼ï¼Œæ­¤å¤„éŸ³é¢‘ç¼–ç æ ¼å¼æŒ‡å®šä¸ºPCMæ ¼å¼ï¼›</li>\n<li>æ¥ä¸‹æ¥è®¾ç½®å£°éŸ³çš„é‡‡æ ·ç‡ã€å£°é“æ•°ä»¥åŠæ¯ä¸ªPacketæœ‰å‡ ä¸ªFrameè¿™ä¸‰ä¸ªå‚æ•°ï¼›</li>\n<li>mFormatFlagsæ˜¯ç”¨æ¥æè¿°å£°éŸ³è¡¨ç¤ºæ ¼å¼çš„å‚æ•°ï¼Œä»£ç ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šæ¯ä¸ªsampleçš„è¡¨ç¤ºæ ¼å¼æ˜¯Floatæ ¼å¼ã€‚è¿™ä¸ªç±»ä¼¼äºæˆ‘ä»¬ä¹‹å‰è®²è§£çš„æ¯ä¸ªsampleä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼ˆSInt16ï¼‰æ¥è¡¨ç¤ºï¼›ç„¶åæ˜¯åé¢çš„å‚æ•°NonInterleavedï¼Œè¡¨é¢ç†è§£è¿™ä¸ªå•è¯çš„æ„æ€æ˜¯éäº¤é”™çš„ï¼Œå…¶å®å¯¹éŸ³é¢‘æ¥è¯´ï¼Œå°±æ˜¯å·¦å³å£°é“æ˜¯éäº¤é”™å­˜æ”¾çš„ï¼Œå®é™…çš„éŸ³é¢‘æ•°æ®ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªAudioBufferListç»“æ„ä¸­çš„å˜é‡mBuffersä¸­ã€‚<strong>å¦‚æœmFormatFlagsæŒ‡å®šçš„æ˜¯NonInterleavedï¼Œé‚£ä¹ˆå·¦å£°é“å°±ä¼šåœ¨mBuffers[0]é‡Œé¢ï¼Œå³å£°é“å°±ä¼šåœ¨mBuffers[1]é‡Œé¢ï¼Œè€Œå¦‚æœmFormatFlagsæŒ‡å®šçš„æ˜¯Interleavedçš„è¯ï¼Œé‚£ä¹ˆå·¦å³å£°é“å°±ä¼šäº¤é”™æ’åˆ—åœ¨mBuffers[0]é‡Œé¢ï¼Œ</strong>ç†è§£è¿™ä¸€ç‚¹å¯¹åç»­çš„å¼€å‘æ˜¯ååˆ†é‡è¦çš„ï¼›</li>\n<li>æ¥ä¸‹æ¥çš„mBitsPerChannelè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå£°é“çš„éŸ³é¢‘æ•°æ®ç”¨å¤šå°‘ä½æ¥è¡¨ç¤ºï¼Œå‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“æ¯ä¸ªé‡‡æ ·ä½¿ç”¨Floatæ¥è¡¨ç¤ºï¼Œæ‰€ä»¥è¿™é‡Œå°±ä½¿ç”¨8ä¹˜ä»¥æ¯ä¸ªé‡‡æ ·çš„å­—èŠ‚æ•°æ¥èµ‹å€¼ï¼›</li>\n<li>æœ€åæ˜¯å‚æ•°mBytesPerFrameå’ŒmBytesPerPacketçš„èµ‹å€¼ï¼Œè¿™é‡Œéœ€è¦æ ¹æ®mFormatFlagsçš„å€¼æ¥åˆ†é…ã€‚å¦‚æœåœ¨NonInterleavedçš„æƒ…å†µä¸‹ï¼Œå°±èµ‹å€¼ä¸ºbytesPerSampleï¼ˆå› ä¸ºå·¦å³å£°é“æ˜¯åˆ†å¼€å­˜æ”¾çš„ï¼‰ï¼›ä½†å¦‚æœæ˜¯Interleavedçš„è¯ï¼Œé‚£ä¹ˆå°±åº”è¯¥æ˜¯bytesPerSample * channelsï¼ˆå› ä¸ºå·¦å³å£°é“æ˜¯äº¤é”™å­˜æ”¾çš„ï¼‰ï¼Œè¿™æ ·æ‰èƒ½è¡¨ç¤ºä¸€ä¸ªFrameé‡Œé¢åˆ°åº•æœ‰å¤šå°‘ä¸ªbyteã€‚</li>\n</ul><p>å¦‚æœè¦æ’­æ”¾çš„æ˜¯ä¸€ä¸ªMP3æˆ–è€…M4Açš„æ–‡ä»¶ï¼Œè¿™ä¸ªASBDåº”è¯¥å¦‚ä½•ç¡®å®šå‘¢ï¼Ÿè¯·çœ‹ä¸‹é¢è¿™ä¸ªä»£ç ï¼š</p><pre><code class=\"language-plain\">// æ‰“å¼€æ–‡ä»¶\nNSURL *fileURL = [NSURL URLWithString:filePath];\nOSStatus status = AudioFileOpenURL((__bridge CFURLRef)fileURL, kAudioFileReadPermission, kAudioFileCAFType, &amp;_mAudioFile);\nif (status != noErr) {\n  NSLog(@\"open file error\");\n}&nbsp;&nbsp; &nbsp;\n// è·å–æ–‡ä»¶æ ¼å¼\nUInt32 dataFromatSize = sizeof(dataFormat);\nAudioFileGetProperty(_mAudioFile, kAudioFilePropertyDataFormat, &amp;dataFromatSize, &amp;dataFormat);\n</code></pre><p>ç¬¬ä¸€æ­¥æ˜¯ç”¨AudioFileæ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ‰“å¼€æˆåŠŸçš„è¯ï¼Œç›´æ¥è·å–å‡ºè¿™ä¸ªAudioFileçš„DataFormatå°±å¥½äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Ÿå¯¹äºå¡«å……æ•°æ®ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä»AudioFileä¸­è¯»å–åŸå§‹æ•°æ®å°±å¯ä»¥äº†ã€‚</p><p>å­¦åˆ°è¿™é‡Œå¯èƒ½ä½ ä¼šæœ‰ç–‘é—®ï¼Œç»•äº†ä¸€å¤§åœˆï¼Œç”¨AudioQueueå°±ç›´æ¥æ’­æ”¾äº†ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼Œé‚£æˆ‘ç›´æ¥ä½¿ç”¨AVAudioPlayeræˆ–è€…AVPlayeræ¥æ’­æ”¾è¿™ä¸ªéŸ³é¢‘æ–‡ä»¶ä¸æ›´ç®€å•å—ï¼Ÿçš„ç¡®æ˜¯çš„ï¼Œä½†æˆ‘æ›´æƒ³é€šè¿‡è¿™ä¸ªä¾‹å­æ¥å‘Šè¯‰ä½ ï¼š<strong>è¿™å°±æ˜¯iOSç»™å¼€å‘è€…æä¾›çš„å¼ºå¤§çš„å¤šåª’ä½“å¤„ç†èƒ½åŠ›ï¼Œè€ŒAudioQueueæ›´é€‚åˆå¼€å‘è€…åœ¨ä¸€äº›æ›´åº•å±‚çš„æ•°æ®å¤„ç†çš„åœºæ™¯ä¸‹ä½¿ç”¨ã€‚</strong></p><h2>å°ç»“</h2><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/bd/40/bd314e0090edf7c1636a5cd6d8a9cd40.png?wh=1725x751\" alt=\"\"><br>\nè¿™èŠ‚è¯¾æˆ‘ä»¬å¯¹iOSçš„éŸ³é¢‘æ¡†æ¶æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„äº†è§£ã€‚å…¶ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªå°±æ˜¯AudioQueueå’ŒAudioUnitã€‚AudioQueueä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œå®ƒæ˜¯å®ç°å½•åˆ¶ä¸æ’­æ”¾åŠŸèƒ½æœ€ç®€å•çš„APIæ¥å£ï¼Œå°±ç®—ä½ ä¸çŸ¥é“å†…éƒ¨çš„ç»†èŠ‚ï¼Œä¹Ÿå¯ä»¥ç®€å•åœ°å®Œæˆæ’­æ”¾PCMæ•°æ®çš„åŠŸèƒ½ã€‚æ‰€ä»¥å¦‚æœä½ çš„è¾“å…¥æ˜¯PCMï¼Œæ¯”å¦‚è§†é¢‘æ’­æ”¾å™¨åœºæ™¯ã€RTCç­‰éœ€è¦ä¸šåŠ¡è‡ªå·±Mixæˆ–è€…å¤„ç†PCMçš„åœºæ™¯ï¼Œé‚£ä¹ˆä½¿ç”¨AudioQueueæ˜¯éå¸¸é€‚åˆçš„ä¸€ç§æ–¹å¼ã€‚</p><p>AudioUnitæ˜¯iOSä¸­æœ€åº•å±‚çš„éŸ³é¢‘æ¡†æ¶ï¼Œå¯¹éŸ³é¢‘èƒ½å¤Ÿå®ç°æ›´é«˜ç¨‹åº¦çš„æ§åˆ¶ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æˆ‘ä»¬çš„å¿…å­¦å†…å®¹ä¹‹ä¸€ï¼Œä¸‹èŠ‚è¯¾æˆ‘ä¼šè¯¦ç»†åœ°è®²ä¸€è®²æ€ä¹ˆä½¿ç”¨AudioUnitå®ç°éŸ³é¢‘çš„æ¸²æŸ“ï¼ŒæœŸå¾…ä¸€ä¸‹å§ï¼</p><p>ä»Šå¤©æˆ‘é€šè¿‡ä»£ç å¸¦ä½ åˆ›å»ºå¹¶è®¾ç½®äº†AVAudioSessionï¼Œè¿˜å¸¦ä½ è¯¦ç»†äº†è§£äº†AudioQueueçš„è¿è¡Œæµç¨‹ä»¥åŠiOSå¹³å°çš„éŸ³é¢‘æ ¼å¼ASBDï¼Œå¸Œæœ›ä½ å­¦å®Œä¹‹åå¯ä»¥è‡ªå·±åŠ¨æ‰‹ç»ƒä¸€ç»ƒï¼ŒæŠŠä»Šå¤©å­¦ä¹ çš„å†…å®¹å†…åŒ–åˆ°è‡ªå·±çš„çŸ¥è¯†ç½‘ç»œä¸­ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å­¦è€Œä¸æ€åˆ™ç½”ï¼Œæœ€åæˆ‘ç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜ï¼šä½ æ€è€ƒä¸€ä¸‹AudioQueueç›¸æ¯”äºAVPlayeræˆ–è€…AVAudioPlayerï¼Œå®ƒçš„çµæ´»æ€§æˆ–è€…è¯´å¥½å¤„åœ¨å“ªå„¿å‘¢ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„æ€è€ƒï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹éŸ³è§†é¢‘æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµã€å…±åŒè¿›æ­¥ã€‚ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"å¼€ç¯‡è¯ï½œç³»ç»Ÿå­¦ä¹ ç§»åŠ¨ç«¯éŸ³è§†é¢‘å¼€å‘æŠ€æœ¯ï¼Œä¸ºä¸šåŠ¡èµ‹èƒ½","id":543579},"right":{"article_title":"02ï½œiOSå¹³å°éŸ³é¢‘æ¸²æŸ“ï¼ˆäºŒï¼‰ï¼šä½¿ç”¨ AudioUnit æ¸²æŸ“éŸ³é¢‘","id":543993}},"comments":[{"had_liked":false,"id":352524,"user_name":"å¤§åœŸè±†","can_delete":false,"product_type":"c1","uid":1121636,"ip_address":"åŒ—äº¬","ucode":"67445DC3EC9DB0","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/64/52a5863b.jpg","comment_is_top":false,"comment_ctime":1658746582,"is_pvip":true,"replies":[{"id":"128500","content":"å¯¹çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"3069513","ctime":1659439530,"ip_address":"åŒ—äº¬","comment_id":352524,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10248681174","product_id":100117601,"comment_content":"æ’­æ”¾åŸå§‹çš„PCMï¼Œä¼˜åŠ¿æ˜¯ä¸è¨€è€Œå–»çš„ï¼ŒéŸ³é¢‘è½¨é“è§£ç ä¹‹åçš„PCMæ•°æ®ï¼Œå¯ä»¥ç»™FFmpegçš„éŸ³é¢‘æ»¤é•œåšè¿›ä¸€æ­¥å„ç§æ•ˆæœçš„å¤„ç†ï¼Œè¿˜å¯ä»¥æ¥å…¥soundtouchåšå˜é€Ÿå’Œå˜è°ƒçš„å¤„ç†ï¼Œç„¶åå¤„ç†è¿‡çš„PCMå†ç»™audioqueueæ’­æ”¾ï¼Œå„ä¸ªæµç¨‹éƒ½å¯ä»¥å®šåˆ¶ã€‚","like_count":3,"discussions":[{"author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582462,"discussion_content":"å¯¹çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659439530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1255794,"avatar":"https://static001.geekbang.org/account/avatar/00/13/29/72/515e8867.jpg","nickname":"ç‹å‚é•¿","note":"","ucode":"FF41279DA5A860","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581406,"discussion_content":"å°±æ˜¯èƒ½å¯¹éŸ³é¢‘åšäº›èŠ±æ´»å˜›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658758119,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353483,"user_name":"data","can_delete":false,"product_type":"c1","uid":1010493,"ip_address":"åŒ—äº¬","ucode":"4EEC3CE11E65F8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/3d/ae41c2b3.jpg","comment_is_top":false,"comment_ctime":1659496144,"is_pvip":true,"replies":[{"id":"128615","content":"è¿™ä¸ªå¾—çœ‹ä½ æœ¬èº«rtpåŒ…é‡Œé¢çš„æ—¶é—´æˆ³è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥æŒ‰ç…§ä»é‡‡é›†å¼€å§‹è®¡æ—¶çš„æ—¶é—´ã€ä¹Ÿå¯ä»¥è‡ªå·±è®¡ç®—PCMæ•°æ®çš„æ—¶é—´ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"3069513","ctime":1659771275,"ip_address":"åŒ—äº¬","comment_id":353483,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1659496144","product_id":100117601,"comment_content":"è€å¸ˆ,æˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹ æˆ‘ä½¿ç”¨ AudioQueue æ¥å½•éŸ³,ç„¶åå°è£…æˆrtpåŒ…è¿›è¡Œå‘é€,é‡Œé¢ æœ‰ä¸ªæ—¶é—´æˆ³ timestamp,æˆ‘æ²¡æ‰¾åˆ° é‡Œé¢æœ‰æ–¹æ³•å¯ä»¥è·å–åˆ°è¿™ä¸ªæ—¶é—´æˆ³çš„?<br><br> int32_t t = ((float)timestamp.value &#47; timestamp.timescale) * 1000;<br> if(start_t == 0) start_t = t;<br> header.ts = t - start_t;<br><br>","like_count":0,"discussions":[{"author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582908,"discussion_content":"è¿™ä¸ªå¾—çœ‹ä½ æœ¬èº«rtpåŒ…é‡Œé¢çš„æ—¶é—´æˆ³è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥æŒ‰ç…§ä»é‡‡é›†å¼€å§‹è®¡æ—¶çš„æ—¶é—´ã€ä¹Ÿå¯ä»¥è‡ªå·±è®¡ç®—PCMæ•°æ®çš„æ—¶é—´ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659771275,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353322,"user_name":"data","can_delete":false,"product_type":"c1","uid":1010493,"ip_address":"åŒ—äº¬","ucode":"4EEC3CE11E65F8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/3d/ae41c2b3.jpg","comment_is_top":false,"comment_ctime":1659351101,"is_pvip":true,"replies":[{"id":"128501","content":"æœ€è¿‘åœ¨é©¬ä¸åœè¹„çš„æ›´æ–°è¯¾ç¨‹ï¼Œè¯¾ç¨‹æ›´æ–°åˆ°å·®ä¸å¤šé˜¶æ®µï¼Œæºç çš„githubåœ°å€ä¼šå…¬å¸ƒå‡ºæ¥å“ˆã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"3069513","ctime":1659439580,"ip_address":"åŒ—äº¬","comment_id":353322,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1659351101","product_id":100117601,"comment_content":"æ˜¯å¦æ¡ˆä¾‹éƒ½æœ‰demoå¯ä»¥è·‘ä¸€è·‘ğŸ˜Œ","like_count":1,"discussions":[{"author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582463,"discussion_content":"æœ€è¿‘åœ¨é©¬ä¸åœè¹„çš„æ›´æ–°è¯¾ç¨‹ï¼Œè¯¾ç¨‹æ›´æ–°åˆ°å·®ä¸å¤šé˜¶æ®µï¼Œæºç çš„githubåœ°å€ä¼šå…¬å¸ƒå‡ºæ¥å“ˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659439580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1028139,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b0/2b/87aff702.jpg","nickname":"ä¸€ä¸ªæ­£ç›´çš„å°é¾™çŒ«","note":"","ucode":"7C9CFFAA299D1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":586826,"discussion_content":"è€å¸ˆï¼Œæ¶‰åŠåˆ°iOSçš„ä»£ç ï¼Œè€å¸ˆä¹‹åå‘å‡ºæ¥æ˜¯ocï¼Œè¿˜æ˜¯swiftçš„ï¼Ÿå¦‚æœé¡¹ç›®æ˜¯swiftå·¥ç¨‹ï¼Œä¸€äº›å…³äºcè¯­è¨€çš„ä»£ç å¦‚ä½•åº”ç”¨åˆ°å·¥ç¨‹é‡Œå‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662532021,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":582463,"ip_address":"è¾½å®"},"score":586826,"extra":""}]}]}]}