{"id":556024,"title":"14ï½œå¦‚ä½•åœ¨FFmpegä¸­å®šåˆ¶ä¸€ä¸ªè‡ªå·±ä¸“å±çš„æ¨¡å—ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯åˆ˜æ­§ã€‚</p><p>é€šè¿‡å‰é¢13èŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹FFmpegæ•´ä½“çš„ä½¿ç”¨å’Œæ¶æ„å·²ç»æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ¢ç´¢ä¸€ä¸‹FFmpegç¤¾åŒºçš„â€œç©æ³•â€ï¼Œäº†è§£ä¸€ä¸‹FFmpegå¸¸ç”¨çš„äº¤æµå·¥å…·ã€åé¦ˆbugå’Œè´¡çŒ®ä»£ç çš„æ¸ é“ï¼Œä»¥åŠå®šåˆ¶ä¸“å±æ¿å—çš„æ–¹æ³•ã€‚è¿™ä¸ªéƒ¨åˆ†ï¼Œæˆ‘ä¼šåˆ†æˆä¸¤è®²ç»™ä½ ä»‹ç»ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•åœ¨FFmpegä¸­å®šåˆ¶ä¸€ä¸ªä¸“å±äºè‡ªå·±çš„æ¨¡å—ã€‚å®šåˆ¶æ¨¡å—çš„ä½œç”¨æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡å®šåˆ¶è‡ªå·±çš„ç§æœ‰æ ¼å¼ï¼Œé˜²æ­¢åˆ«äººæ’­æ”¾è‡ªå·±çš„è§†é¢‘ã€‚</p><p>åœ¨FFmpegä¸­æ·»åŠ æ¨¡å—ï¼Œéœ€è¦æ·±å…¥äº†è§£æºä»£ç æ¶æ„ã€‚ä½†FFmpegæºä»£ç å¤ªå¤šï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªçªç ´å£æ·±å…¥è¿›å»ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸‹è½½å®˜æ–¹çš„æºä»£ç åº“ï¼ŒåŸºäº5.0åˆ†æ”¯åšä¸€ä¸ªæ–°åˆ†æ”¯kwaiï¼Œä½œä¸ºæˆ‘ä»¬æºç çš„åŸºç¡€ã€‚</p><pre><code class=\"language-plain\">$ git clone git://source.ffmpeg.org/ffmpeg.git     # ä¸‹è½½æºä»£ç \n$ cd ffmpeg                                        # è¿›å…¥æºä»£ç ä¸»ç›®å½•\n$ git checkout remotes/origin/release/5.0          # åˆ‡æ¢åˆ°5.0åˆ†æ”¯\nNote: switching to 'remotes/origin/release/5.0'.\n\n$ git checkout -b kwai                             # å¼€ä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œèµ·åå«kwai\nSwitched to a new branch 'kwai'\n</code></pre><!-- [[[read_end]]] --><p>åœ¨æºä»£ç æ ¹ç›®å½•ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤ls |grep libï¼Œå¯ä»¥åˆ—å‡ºç›¸åº”æ¨¡å—çš„æºä»£ç ç›®å½•ã€‚</p><pre><code class=\"language-plain\">$ ls | grep lib\nlibavcodec/\nlibavdevice/\nlibavfilter/\nlibavformat/\nlibavutil/\nlibpostproc/\nlibswresample/\nlibswscale/\n</code></pre><p>ç„¶åï¼Œå¯ä»¥ç”¨ä½ å–œæ¬¢çš„ç¼–è¾‘å™¨ï¼Œæ‰“å¼€æ•´ä¸ªæºä»£ç ç›®å½•ï¼Œæµè§ˆä¸€ä¸‹æºä»£ç çš„ç›®å½•ç»“æ„ï¼Œæ‰¾è‡ªå·±ç†Ÿæ‚‰çš„å†…å®¹çœ‹ï¼Œæ¯”å¦‚ä½ å¹³æ—¶ç”¨H.264ç¼–ç ç”¨å¾—æ¯”è¾ƒå¤šï¼Œå°±å¯ä»¥åœ¨libavcodecç›®å½•ä¸‹ï¼Œæ‰¾åˆ°å¾ˆå¤šh264å¼€å¤´çš„æ–‡ä»¶ã€‚</p><p>å¦‚æœä½ å†™ä¸€ä¸ªæ–°çš„ç¼–è§£ç æ¨¡å—çš„è¯ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯å…ˆæ‰¾ä¸€ä¸ªç±»ä¼¼çš„æ¨¡å—ï¼Œå¤åˆ¶ä¸€ä¸ªã€‚ä¸è¿‡ï¼Œç”±äºFFmpegæ˜¯ä¸€ä¸ªåºå¤§çš„é¡¹ç›®ï¼Œå†å²æ¸Šæºä¹Ÿå¾ˆæ·±ï¼Œé‡Œé¢ä¼šæœ‰å„ç§ä»£ç åˆ¤æ–­ï¼Œå¦‚if-elseä¹‹ç±»çš„ï¼Œæ¥åº”å¯¹å®é™…ä½¿ç”¨ç¯å¢ƒä¸­çš„é—®é¢˜ï¼Œä½†è¿™ä¼šå¹²æ‰°ä½ çš„é˜…è¯»ã€‚å› æ­¤ï¼Œè¿™èŠ‚è¯¾æˆ‘ä»¬ä¼šé€šè¿‡æœ€ç®€å•çš„ä¾‹å­ï¼ŒæŠŠé—®é¢˜è®²æ¸…æ¥šã€‚</p><h2>ç¼–è¯‘å¯ç”¨ç‰ˆæœ¬</h2><p>æˆ‘ä»¬å…ˆç¼–è¯‘ä¸€ä¸ªå¯ç”¨çš„ç‰ˆæœ¬ã€‚å› ä¸ºæ˜¯è‡ªå·±å®ç°æ¨¡å—ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦æœ€åŸºæœ¬çš„ç¼–è¯‘å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦ç¼–è¯‘å¤§é‡çš„ç¬¬ä¸‰æ–¹æ¨¡å—ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬åªä½¿ç”¨äº†æœ€ç®€å•çš„./configureï¼Œæ²¡æœ‰ä½¿ç”¨ä»»ä½•å…¶å®ƒå‚æ•°ã€‚</p><pre><code class=\"language-plain\">./configure\nmake -j4\n</code></pre><p>ç¼–è¯‘å®Œæˆåï¼Œæ‰§è¡Œ./ffmpeg -hï¼Œå¦‚æœè¿è¡Œæ­£å¸¸ï¼Œè¯´æ˜æˆ‘ä»¬ç¼–è¯‘æˆåŠŸäº†ã€‚æˆ‘æ˜¯åœ¨MacBookä¸Šç¼–è¯‘çš„ï¼Œå¦‚æœæ²¡æœ‰MacBookçš„è¯ï¼Œä½ ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨Linuxã€‚ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ç»Ÿè®¡è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">./ffmpeg -formats | wc -l          # è¾“å‡º 388\n./ffmpeg -codecs | wc -l           # è¾“å‡º 500\n./ffmpeg -filters | wc -l          # è¾“å‡º 428\n./ffmpeg -protocols | wc -l        # è¾“å‡º 58\n./ffmpeg -devices | wc -l          # è¾“å‡º 9\n</code></pre><p>ä½ ä¹Ÿå¯ä»¥å»æ‰å…¶ä¸­çš„| wc -lï¼ŒæŸ¥çœ‹å®Œæ•´çš„è¾“å‡ºï¼Œä»è¿™äº›è¾“å‡ºçš„ç»“æœå¤§æ¦‚å¯ä»¥çœ‹å‡ºç›¸åº”æ¨¡å—çš„æ•°é‡<span class=\"reference\">ï¼ˆè¡Œæ•°ï¼‰</span>ã€‚</p><p>æœ‰äº†è¿™ä¸ªåŸºç¡€ç¯å¢ƒï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥æ·»åŠ è‡ªå·±çš„æ¨¡å—äº†ã€‚å¦‚æœä½ å‚è€ƒæˆ‘åœ¨è¿™èŠ‚è¯¾é‡Œé¢è´´çš„ä»£ç ï¼ŒåŒæ­¥åšå®éªŒï¼Œå¯ä»¥åœ¨åšå®Œç¤ºä¾‹åï¼Œå†æ¬¡è¿è¡Œä¸Šé¢çš„å‘½ä»¤ï¼Œè§‚å¯Ÿå‰åçš„å·®å¼‚ã€‚</p><h2>ä¸ºFFmpegæ·»åŠ è‡ªå·±çš„ AVFormatæ¨¡å—</h2><p>æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡å¾ˆå¤šæ¬¡ï¼ŒAVForamtæ˜¯å„ç§éŸ³è§†é¢‘æ–‡ä»¶æ ¼å¼<span class=\"reference\">ï¼ˆåŒ…æ‹¬ç½‘ç»œæ–‡ä»¶æ ¼å¼ï¼‰</span>çš„å°è£…æ¨¡å—ï¼Œè¦æ·»åŠ ä¸€ä¸ªè‡ªå·±ä¸“å±çš„AVForamtæ¨¡å—ï¼Œéœ€è¦å…ˆâ€œå‘æ˜â€ä¸€ç§è‡ªå·±çš„æ–‡ä»¶æ ¼å¼ï¼Œç„¶åç”¨ä»£ç å®ç°ï¼Œè¿™é‡Œä¸ºäº†ç®€æ´ä¸€ç‚¹å„¿ï¼Œæˆ‘ä»¬ä½¿ç”¨å›ºå®šçš„ç¼–è§£ç æ ¼å¼ã€‚</p><h3>kwaiæ–‡ä»¶æ ¼å¼</h3><p>æˆ‘ä»¬æŠŠæ–°â€œå‘æ˜â€çš„æ–‡ä»¶æ ¼å¼å‘½åä¸ºkwaiï¼Œæ ¼å¼å®šä¹‰å¦‚ä¸‹ï¼š</p><p>â€¢ æ”¯æŒéŸ³è§†é¢‘ï¼Œæ–‡ä»¶å›ºå®šåŒ…å«ä¸€ä¸ªéŸ³é¢‘è½¨å’Œä¸€ä¸ªè§†é¢‘è½¨ã€‚</p><p>â€¢ éŸ³é¢‘å›ºå®šä¸ºAACï¼Œè§†é¢‘å›ºå®šä¸ºH264ã€‚</p><p>â€¢ éŸ³è§†é¢‘äº¤é”™å­˜å‚¨ã€‚</p><p>â€¢ éŸ³è§†é¢‘æ•°æ®å—çš„é•¿åº¦ï¼Œ32ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¤§ç«¯åºï¼Œåé¢è·ŸéŸ³è§†é¢‘æ•°æ®ã€‚</p><p>â€¢ é•¿åº¦å­—æ®µæœ€é«˜ä½ï¼ŒéŸ³é¢‘ä¸º0ï¼Œè§†é¢‘ä¸º1ã€‚</p><p>æ–‡ä»¶å¤´å®šä¹‰å¦‚ä¸‹ï¼š</p><p>â€¢ 4å­—èŠ‚æ–‡ä»¶é­”æ•°ï¼Œå›ºå®šä¸ºkwaiã€‚</p><p>â€¢ 4å­—èŠ‚ç‰ˆå·ï¼Œ32ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¤§ç«¯åºã€‚</p><p>â€¢ 4å­—èŠ‚é‡‡æ ·ç‡ï¼Œ32ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¤§ç«¯åºã€‚</p><p>â€¢ 1å­—èŠ‚å¡«å……å­—ç¬¦ï¼Œæ— ä»»ä½•æ„ä¹‰ï¼Œå›ºå®šä¸º0ã€‚</p><p>â€¢ 1å­—èŠ‚éŸ³é¢‘å£°é“æ•°ã€‚</p><p>â€¢ 2å­—èŠ‚è§†é¢‘å®½åº¦ï¼Œ32ä½æ•´æ•°ï¼Œå¤§ç«¯åºã€‚</p><p>â€¢ 2å­—èŠ‚è§†é¢‘é«˜åº¦ï¼Œ32ä½æ•´æ•°ï¼Œå¤§ç«¯åºã€‚</p><p>â€¢ 2å­—èŠ‚å¸§ç‡åˆ†å­ï¼Œ16ä½æ•´æ•°ï¼Œå¤§ç«¯åºã€‚</p><p>â€¢ 2å­—èŠ‚å¸§ç‡åˆ†æ¯ï¼Œ16ä½æ•´æ•°ï¼Œå¤§ç«¯åºã€‚</p><p>â€¢ 26å­—èŠ‚å…¶å®ƒæ–‡æœ¬ä¿¡æ¯ï¼Œæœ€åä¸€å­—èŠ‚ä¸º0ï¼Œå³NULLå­—ç¬¦ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿å­—ç¬¦ä¸²å¤„ç†ã€‚</p><p>è¿™æ ·å®šåˆ¶å†…å®¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºä¸åŒé•¿åº¦æ•´æ•°çš„å¤„ç†ï¼Œå¤–åŠ ä¸€ä¸ªé¢å¤–çš„å¡«å……å­—ç¬¦ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†æ•°æ®å¯¹é½ï¼Œäººçœ¼çœ‹èµ·æ¥æ¯”è¾ƒç›´è§‚ï¼Œåé¢æˆ‘ä»¬ä¼šåœ¨æ–‡ä»¶å¤´çš„16è¿›åˆ¶æ•°æ®è¡¨ç¤ºæ—¶æ„Ÿå—åˆ°è¿™ç§æ•ˆæœã€‚</p><h3>æ·»åŠ æ–‡ä»¶</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨libavformatç›®å½•ä¸‹åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼škwaienc.cå’Œkwaidec.cï¼Œå…¶ä¸­kwaienc.cå¯¹åº”æ–‡ä»¶ç¼–ç ï¼Œencæ˜¯encodingçš„ç¼©å†™ï¼Œä¹Ÿå«å°è£…/muxã€‚kwaidec.cå¯¹åº”æ–‡ä»¶è§£ç ï¼Œdecæ˜¯decodingç¼©å†™ï¼Œä¹Ÿå«è§£å°è£…/demuxã€‚æ–‡ä»¶çš„å…·ä½“å†…å®¹æˆ‘ä»¬åé¢å†è®²ã€‚</p><p>æ¥ä¸‹æ¥åœ¨libavformat/Makefileä¸­å¢åŠ ä¸‹é¢è¿™æ®µå†…å®¹ã€‚</p><pre><code class=\"language-plain\">OBJS-$(CONFIG_kwai_DEMUXER)              += kwaidec.o\nOBJS-$(CONFIG_kwai_MUXER)                += kwaienc.o\n</code></pre><p>åœ¨libavformat/allformats.cä¸­å¢åŠ ä¸‹é¢è¿™æ®µå†…å®¹ã€‚</p><pre><code class=\"language-plain\">extern const AVOutputFormat ff_kwai_muxer;\nextern const AVInputFormat  ff_kwai_demuxer;\n</code></pre><p>æ‰§è¡Œå‘½ä»¤./configure --list-muxerså’Œ./configure --list-demuxerså¯ä»¥åˆ—å‡ºæ‰€æœ‰çš„æ ¼å¼ï¼Œå¦‚æœèƒ½ä»è¾“å‡ºç»“æœä¸­æ‰¾åˆ°kwaiï¼Œå°±è¯´æ˜æ·»åŠ æˆåŠŸäº†ã€‚</p><pre><code class=\"language-plain\">./configure --list-muxers\n./configure --list-demuxers\n</code></pre><p>ç„¶åé‡æ–°æ‰§è¡Œconfigureã€‚</p><pre><code class=\"language-plain\">./configure --enable-muxer=kwai --enable-demuxer=kwai\n</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„æºæ–‡ä»¶å’Œç¼–è¯‘ç¯å¢ƒéƒ½å‡†å¤‡å¥½äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ æ–‡ä»¶çš„å°è£…æ ¼å¼ã€‚</p><h3>æ·»åŠ æ–‡ä»¶å°è£…æ ¼å¼</h3><p>æ–‡ä»¶å°è£…<span class=\"reference\">ï¼ˆå°±æ˜¯AVOutputFormatï¼‰</span>æ˜¯ä¸€ä¸ªè¾“å‡ºæ ¼å¼ï¼Œå®ƒçš„è¾“å…¥ç«¯ä¹Ÿæ˜¯ä¸€ä¸ªAVFormat<span class=\"reference\">ï¼ˆä¹Ÿå°±æ˜¯AVInputFormatï¼‰</span>ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ³¨å†Œæˆ‘ä»¬çš„kwaiå°è£…æ–‡ä»¶æ ¼å¼ï¼Œå†…å®¹åœ¨kwaienc.cä¸­ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåˆ†ä¸ºè¿™å‡ æ­¥ï¼š</p><ol>\n<li>å®šä¹‰æ–‡ä»¶æ ¼å¼ç»“æ„ä½“</li>\n<li>å‡†å¤‡å‚æ•°</li>\n<li>å®šä¹‰ä¸€ä¸ªç±»</li>\n<li>å‘FFmpegæ³¨å†Œæ–‡ä»¶æ ¼å¼</li>\n<li>å®ç°å›è°ƒå‡½æ•°</li>\n</ol><p>ä¸‹é¢æˆ‘ä»¬é€æ­¥è®²è§£ä¸€ä¸‹ã€‚</p><h4>å®šä¹‰æ–‡ä»¶æ ¼å¼ç»“æ„ä½“</h4><p>æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨æ¥æè¿°å’Œå­˜å‚¨æ–‡ä»¶çš„å„ç§å‚æ•°ã€‚å…¶ä¸­ï¼Œè¿™ä¸ªç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å¿…é¡»æ˜¯ä¸€ä¸ªAVClassç±»å‹çš„æŒ‡é’ˆï¼Œä¸éœ€è¦ç‰¹åˆ«å¤„ç†ï¼ŒFFmpegå†…éƒ¨ä¼šç”¨åˆ°ã€‚å…¶å®ƒå‚æ•°ï¼Œä½ å¯ä»¥å‚è€ƒä»£ç å†…çš„æ³¨é‡Šã€‚</p><pre><code class=\"language-plain\">typedef struct kwaiMuxContext {\n    AVClass *class;         // AVClassæŒ‡é’ˆ\n    uint32_t magic;         // æ–‡ä»¶é­”æ•°ï¼Œç”¨äºæ ‡å¿—æ–‡ä»¶çš„ç±»å‹ï¼Œå¾ˆå¤šæ–‡ä»¶ç±»å‹å¦‚PNGå’ŒMP3éƒ½è¿™ä¹ˆåš\n    uint32_t version;       // ç‰ˆæœ¬å·ï¼Œç›®å‰å›ºå®šä¸º1\n    uint32_t sample_rate;   // éŸ³é¢‘é‡‡æ ·ç‡ï¼Œå¸¸ç”¨çš„AACæ ¼å¼é‡‡æ ·ç‡ä¸º44100\n    uint8_t channels;       // å£°é“æ•°ï¼Œä¸€èˆ¬ä¸º1æˆ–2\n    uint32_t width;         // è§†é¢‘å®½åº¦\n    uint32_t height;        // è§†é¢‘é«˜åº¦\n    AVRational fps;         // å¸§ç‡ï¼Œè¿™é‡Œç”¨åˆ†æ•°è¡¨ç¤º\n    char *info;             // æ–‡ä»¶çš„å…¶å®ƒæè¿°ä¿¡æ¯ï¼Œå­—ç¬¦ä¸²\n} kwaiMuxContext;\n</code></pre><h4>å‡†å¤‡å‚æ•°</h4><p>å‡†å¤‡ä¸€ä¸ªAVOptionç»“æ„ä½“æ•°ç»„ï¼Œç”¨æ¥å­˜æ”¾kwaiæ–‡ä»¶æ ¼å¼çš„ç›¸å…³å‚æ•°ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦ä¸²æ ¼å¼çš„infoå‚æ•°å’Œä¸€ä¸ªæ•´æ•°æ ¼å¼çš„versionå‚æ•°ï¼Œæœ€åç”¨äº†ä¸€ä¸ªç©º<span class=\"reference\">ï¼ˆNULLï¼‰</span>ç»“æ„ä½“å…ƒç´ ç»“å°¾ã€‚è¿™ä¸¤ä¸ªå‚æ•°éƒ½å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šä½¿ç”¨ï¼Œåé¢æˆ‘ä»¬ä¼šçœ‹åˆ°å…·ä½“çš„ç”¨æ³•ã€‚</p><p>FFmpegä¼šè‡ªåŠ¨ä¸ºè¿™äº›å‚æ•°ç”³è¯·å­˜å‚¨ç©ºé—´ã€‚ä»ä¸‹é¢çš„ä»£ç é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›å‚æ•°å…¶å®æŒ‡å‘äº†æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ç»“æ„ä½“ï¼Œå½“åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šå‚æ•°çš„æ—¶å€™ï¼Œä¼šä¿®æ”¹ç›¸åº”çš„ç»“æ„ä½“æŒ‡é’ˆã€‚</p><pre><code class=\"language-plain\">static const AVOption options[] = {\n    { \"info\", \"kwai info\", offsetof(kwaiMuxContext, info), AV_OPT_TYPE_STRING,\n        {.str = NULL}, INT_MIN, INT_MAX, AV_OPT_FLAG_ENCODING_PARAM, \"kwaiflags\" },\n    { \"version\", \"kwai version\", offsetof(kwaiMuxContext, version), AV_OPT_TYPE_INT,\n        {.i64 = 1}, 0, 9, AV_OPT_FLAG_ENCODING_PARAM, \"kwaiflags\" },\n    { NULL },\n};\n</code></pre><h4>å®šä¹‰ä¸€ä¸ªç±»</h4><p>å®šä¹‰ä¸€ä¸ªAVClassç»“æ„ä½“ï¼ŒæŒ‡å®škwaiæ–‡ä»¶æ ¼å¼çš„åç§°ï¼Œå…³è”ä¸Šé¢å®šä¹‰çš„å‚æ•°ç­‰ã€‚</p><pre><code class=\"language-plain\">static const AVClass kwai_muxer_class = {\n    .class_name = \"kwai muxer\",\n    .item_name  = av_default_item_name,\n    .option     = options,\n    .version    = LIBAVUTIL_VERSION_INT,\n};\n</code></pre><h4>å‘FFmpegæ³¨å†Œæ–‡ä»¶æ ¼å¼</h4><p>æœ‰äº†ä¸Šè¿°å†…å®¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å‘FFmpegæ³¨å†Œæˆ‘ä»¬çš„kwaiæ–‡ä»¶æ ¼å¼äº†ã€‚å…¶ä¸­ff_kwai_muxerè¿™ä¸ªåå­—å¯¹åº”æˆ‘ä»¬ä¸Šé¢åœ¨allformats.cæ–‡ä»¶ä¸­æ·»åŠ çš„åå­—ï¼Œè¿™æ ·FFmpegåœ¨ç¼–è¯‘å™¨ä¸­å°±å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬å®šä¹‰çš„æ–‡ä»¶æ ¼å¼äº†ã€‚</p><pre><code class=\"language-plain\">const AVOutputFormat ff_kwai_muxer = {\n    .name              = \"kwai\",                 // æ ¼å¼åç§°\n    .long_name         = NULL_IF_CONFIG_SMALL(\"kwai / kwai\"), // é•¿åç§°\n    .extensions        = \"kwai\",                 // æ–‡ä»¶æ‰©å±•å\n    .priv_data_size    = sizeof(kwaiMuxContext), // ç§æœ‰æ•°æ®å†…å­˜å¤§å°\n    .audio_codec       = AV_CODEC_ID_AAC,        // éŸ³é¢‘ç¼–ç \n    .video_codec       = AV_CODEC_ID_H264,       // è§†é¢‘ç¼–ç \n    .init              = kwai_init,              // åˆå§‹åŒ–å›è°ƒå‡½æ•°\n    .write_header      = kwai_write_header,      // å†™æ–‡ä»¶å¤´å›è°ƒ\n    .write_packet      = kwai_write_packet,      // å†™æ–‡ä»¶å†…å®¹å›è°ƒ\n    .write_trailer     = kwai_write_trailer,     // å†™æ–‡ä»¶å°¾å›è°ƒ\n    .deinit            = kwai_free,              // å†™æ–‡ä»¶ç»“æŸåï¼Œé‡Šæ”¾å†…å­˜å›è°ƒ\n    .flags             = 0,                      // å…¶å®ƒæ ‡å¿—ï¼ˆç•¥ï¼‰\n    .priv_class        = &amp;kwai_muxer_class,      // ç§æœ‰çš„æ–‡ä»¶ç»“æ„ä½“ï¼ŒæŒ‡å‘æˆ‘ä»¬ä¸Šä¸€æ­¥å®šä¹‰çš„å†…å®¹\n};\n</code></pre><h4>å®ç°å›è°ƒå‡½æ•°</h4><p><img src=\"https://static001.geekbang.org/resource/image/8f/14/8f3a58623d5dbb8a819912c5ab667e14.png?wh=1920x529\" alt=\"å›¾ç‰‡\"></p><p>ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œä¸‹é¢å°±æ˜¯å®ç°å…·ä½“çš„å›è°ƒå‡½æ•°äº†ã€‚</p><ol>\n<li>åˆå§‹åŒ–å‡½æ•°</li>\n</ol><p>åˆå§‹åŒ–å‡½æ•°åœ¨æœ€åˆæ‰“å¼€æ–‡ä»¶æ—¶è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°çš„è¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªAVFormatContextç»“æ„ä½“æŒ‡é’ˆï¼Œç”±FFmpegåœ¨æ‰“å¼€æ–‡ä»¶æ—¶ä¼ å…¥ã€‚è¿™ä¸ªç»“æ„ä½“æŒ‡é’ˆåŒ…å«äº†æ–‡ä»¶çš„ç±»å‹ã€æµçš„æ•°é‡<span class=\"reference\">ï¼ˆnb_streamsï¼‰</span>å’Œå„ç§å‚æ•°ã€‚æ ¹æ®è¿™äº›å‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®Œæˆkwaiå°è£…å™¨çš„åˆå§‹åŒ–å·¥ä½œäº†ã€‚</p><pre><code class=\"language-plain\">static int kwai_init(AVFormatContext *s)\n{\n    AVStream *st; // éŸ³è§†é¢‘æµï¼Œæ¯ä¸€ä¸ªstreamä»£è¡¨ä¸€ç§ç±»å‹ï¼Œå¦‚éŸ³é¢‘æµï¼Œè§†é¢‘æµç­‰\n    kwaiMuxContext *kwai = s-&gt;priv_data; // æŒ‡å‘ç§æœ‰çš„ç»“æ„ä½“ï¼Œå·²åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼\n    printf(\"init nb_streams: %d\\n\", s-&gt;nb_streams);\n    if (s-&gt;nb_streams &lt; 2) { // éŸ³è§†é¢‘æµæ•°é‡ï¼Œæˆ‘ä»¬åªæ¥å—ä¸€ä¸ªéŸ³é¢‘æµå’Œä¸€ä¸ªè§†é¢‘æµçš„è¾“å…¥\n        return AVERROR_INVALIDDATA; // ç®€å•å‡ºé”™å¤„ç†\n    }\n    st = find_stream(s, AVMEDIA_TYPE_AUDIO); // æŸ¥æ‰¾éŸ³é¢‘æµï¼Œè¯¥å‡½æ•°åé¢è§£é‡Š\n    if (!st) return AVERROR_INVALIDDATA;     // ç®€å•å‡ºé”™å¤„ç†ï¼Œå¦‚æœæ‰¾ä¸åˆ°éŸ³é¢‘æµåˆ™è¿”å›é”™è¯¯\n    kwai-&gt;sample_rate = st-&gt;codecpar-&gt;sample_rate; // è®°ä½è¾“å…¥éŸ³é¢‘æµçš„é‡‡æ ·ç‡\n    kwai-&gt;channels = st-&gt;codecpar-&gt;channels;       // è®°ä½å£°é“æ•°\n    st = find_stream(s, AVMEDIA_TYPE_VIDEO); // æŸ¥æ‰¾è§†é¢‘æµ\n    if (!st) return AVERROR_INVALIDDATA;     // ç®€å•å‡ºé”™å¤„ç†\n    kwai-&gt;width = st-&gt;codecpar-&gt;width;       // è®°ä½è§†é¢‘å®½åº¦\n    kwai-&gt;height = st-&gt;codecpar-&gt;height;     // è®°ä½è§†é¢‘é«˜åº¦\n    // kwai-&gt;fps = st-&gt;codecpar-&gt;fps;\n    kwai-&gt;fps = (AVRational){15, 1};         // è®°ä½å¸§ç‡\n    return 0;                                // åˆå§‹åŒ–æ­£å¸¸è¿”å›0\n}\n</code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°äº†ä¸€ä¸ªfind_streamå‡½æ•°ï¼Œå®ƒå¯ä»¥ä»kwaiæ ¼å¼çš„è¾“å…¥å‚æ•°ä¸­æŸ¥æ‰¾éŸ³è§†é¢‘æµã€‚</p><pre><code class=\"language-plain\">static AVStream *find_stream(AVFormatContext *s, enum AVMediaType type)\n{\n    int i = 0;\n    for (i = 0; i &lt; s-&gt;nb_streams; i++) { // éå†æ‰€æœ‰è¾“å…¥æµ\n        AVStream *stream = s-&gt;streams[i];\n        if (stream-&gt;codecpar-&gt;codec_type == type) { // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯¹åº”çš„ç±»å‹ï¼ˆéŸ³é¢‘æˆ–è§†é¢‘ï¼‰ï¼Œå³è¿”å›å¯¹åº”çš„æµ\n            return stream;\n        }\n    }\n    return NULL;\n}\n</code></pre><ol start=\"2\">\n<li>å†™æ–‡ä»¶å¤´</li>\n</ol><p>åˆå§‹åŒ–å®Œæˆåï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å†™æ–‡ä»¶å¤´ï¼Œå…¶å®å†™æ–‡ä»¶å¤´å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œéƒ½æ˜¯ç”±FFmpegçš„æ ¸å¿ƒé€»è¾‘å›è°ƒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç…§ç€è¾“å…¥è¾“å‡ºæ ¼å¼å®šä¹‰å¥½å¤´æ–‡ä»¶å°±å¯ä»¥äº†ã€‚</p><pre><code class=\"language-plain\">static int kwai_write_header(AVFormatContext *s)\n{\n    kwaiMuxContext *kwai = s-&gt;priv_data;        // è·å–æˆ‘ä»¬çš„ç§æœ‰ç»“æ„ä½“\n    kwai-&gt;magic = MKTAG('K', 'W', 'A', 'I');    // åˆå§‹åŒ–é­”æ•°\n    // avio_wb32(s-&gt;pb, kwai-&gt;magic);\n    avio_write(s-&gt;pb, (uint8_t *)&amp;kwai-&gt;magic, 4); // å°†è¯¥é­”æ•°å†™å…¥æ–‡ä»¶ï¼Œæ­¤æ—¶æ–‡ä»¶æœ‰4å­—èŠ‚ï¼Œå†…å®¹ä¸ºkwai\n    avio_wb32(s-&gt;pb, kwai-&gt;version);            // ä»¥å¤§ç«¯åºå†™å…¥ç‰ˆæœ¬å·ï¼Œå 4å­—èŠ‚\n    avio_wb32(s-&gt;pb, kwai-&gt;sample_rate);        // ä»¥å¤§ç«¯åºå†™å…¥é‡‡æ ·ç‡\n    avio_w8(s-&gt;pb, 0);                          // å†™å…¥ä¸€ä¸ªå­—èŠ‚å ä½ç¬¦ï¼Œæ— ä»»ä½•æ„ä¹‰\n    avio_w8(s-&gt;pb, kwai-&gt;channels);             // å†™å…¥ä¸€ä¸ªå­—èŠ‚å£°é“æ•°\n    avio_wb16(s-&gt;pb, kwai-&gt;width);              // å†™å…¥å®½åº¦ï¼Œ2å­—èŠ‚\n    avio_wb16(s-&gt;pb, kwai-&gt;height);             // å†™å…¥é«˜åº¦ï¼Œ2å­—èŠ‚\n    avio_wb16(s-&gt;pb, kwai-&gt;fps.num);            // å†™å…¥å¸§ç‡åˆ†å­éƒ¨åˆ†ï¼Œ2å­—èŠ‚\n    avio_wb16(s-&gt;pb, kwai-&gt;fps.den);            // å­—å…¥å¸§ç‡åˆ†æ¯éƒ¨åˆ†ï¼Œ2å­—èŠ‚\n    char info[26] = {0};\n    if (kwai-&gt;info) {                           // å¦‚æœå‘½ä»¤è¡Œä¸Šæœ‰infoå‚æ•°ï¼Œåˆ™å°†å…¶å†…å®¹è¯»åˆ°ä¸´æ—¶å†…åœ¨\n        strncpy(info, kwai-&gt;info, sizeof(info) - 1);\n    }\n    avio_write(s-&gt;pb, info, sizeof(info));       // å†™å…¥infoå­—ç¬¦ä¸²å†…å®¹\n    return 0;\n}\n</code></pre><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œinfoå­—ç¬¦ä¸²å 26ä¸ªå­—èŠ‚<span class=\"reference\">ï¼ˆåŒ…å«ç»“å°¾çš„NULLå­—ç¬¦ï¼‰</span>ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†ä½¿æ–‡ä»¶å¤´éƒ¨åˆ†æ­£å¥½æ˜¯48ä¸ªå­—èŠ‚ï¼Œå¯¹äººçœ¼æ¯”è¾ƒå‹å¥½ã€‚</p><ol start=\"3\">\n<li>å†™éŸ³è§†é¢‘æ•°æ®</li>\n</ol><p>å¦‚æœåˆå§‹åŒ–å’Œå†™æ–‡ä»¶å¤´æ­£å¸¸ï¼ŒFFmpegå°±å¼€å§‹å†™éŸ³è§†é¢‘æ•°æ®äº†ã€‚å…¶ä¸­ï¼Œè¾“å…¥å‚æ•°é™¤äº†AVFormatContextç»“æ„ä½“æŒ‡é’ˆå¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªAVPacketç»“æ„ä½“æŒ‡é’ˆï¼Œé‡Œé¢å­˜æ”¾äº†å…·ä½“è¦æ±‚çš„éŸ³è§†é¢‘æ•°æ®ã€‚éŸ³è§†é¢‘ä¼šäº¤é”™å­˜å‚¨ï¼Œé¦–å…ˆå†™å…¥å½“å‰æ•°æ®çš„æ—¶é—´æˆ³<span class=\"reference\">ï¼ˆ64ä½çš„ptså€¼ï¼‰</span>ï¼Œç„¶åæ˜¯ä»¥32ä½æ— ç¬¦å·æ•´æ•°è¡¨ç¤ºçš„é•¿åº¦<span class=\"reference\">ï¼ˆå…¶ä¸­è§†é¢‘çš„é•¿åº¦æœ€é«˜ä½ç½®1ï¼‰</span>ï¼Œæ¥ç€å†™å…¥å®é™…çš„éŸ³è§†é¢‘æ•°æ®ã€‚</p><pre><code class=\"language-plain\">static int kwai_write_packet(AVFormatContext *s, AVPacket *pkt)\n{\n    // kwaiMuxContext *mov = s-&gt;priv_data;\n    if (!pkt) {\n        return 1;\n    }\n uint32_t size = pkt-&gt;size;               // è·å–æ•°æ®å¤§å°\n\n    AVStream *st = s-&gt;streams[pkt-&gt;stream_index];  // é€šè¿‡stream_indexå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„æµï¼Œæ˜¯éŸ³é¢‘è¿˜æ˜¯è§†é¢‘\n\n    if (st-&gt;codecpar-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {\n        printf(\"Audio: %04d pts: %lld\\n\", size, pkt-&gt;pts); // æ‰“å°éŸ³é¢‘å­—èŠ‚æ•°å’Œpts\n    } else if (st-&gt;codecpar-&gt;codec_type == AVMEDIA_TYPE_VIDEO) {\n        printf(\"Video: %04d pts: %lld\\n\", size, pkt-&gt;pts); // æ‰“å°è§†é¢‘å­—èŠ‚æ•°å’Œpts\n        size |= (1 &lt;&lt; 31); // å¦‚æœæ˜¯è§†é¢‘ï¼Œå°†é•¿åº¦çš„æœ€é«˜ä½ç½®1\n    } else {\n        return 0; // ignore any other types\n    }\n\n    avio_wb64(s-&gt;pb, pkt-&gt;pts);              // å†™å…¥8å­—èŠ‚ptsï¼Œå¤§ç«¯åº\n    avio_wb32(s-&gt;pb, size);                  // å†™å…¥4å­—èŠ‚è§†é¢‘é•¿åº¦ï¼Œå¤§ç«¯åº\n    avio_write(s-&gt;pb, pkt-&gt;data, pkt-&gt;size); // å†™å…¥å®é™…çš„éŸ³è§†é¢‘æ•°æ®\n\n    return 0;\n}\n</code></pre><ol start=\"4\">\n<li>æ–‡ä»¶ç»“æŸå¤„ç†</li>\n</ol><p>æ–‡ä»¶ç»“æŸæ—¶ï¼Œè°ƒç”¨write_trailerå›è°ƒå†™å°¾éƒ¨æ•°æ®ï¼Œå¹¶è°ƒç”¨deinitå›è°ƒé‡Šæ”¾ç›¸åº”çš„å†…å­˜ã€‚è¿™é‡Œæˆ‘ä»¬çš„å°è£…å™¨å®ç°å¾—æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ç®€å•æ”¾ä¸¤ä¸ªç©ºå‡½æ•°å³å¯ã€‚</p><pre><code class=\"language-plain\">static int kwai_write_trailer(AVFormatContext *s)\n{\n    return 0;\n}\n\nstatic void kwai_free(AVFormatContext *s)\n{\n}\n</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„æ–‡ä»¶æ ¼å¼å°è£…å™¨å°±åšå¥½äº†ã€‚</p><ol start=\"5\">\n<li>ç¼–è¯‘è¿è¡Œ</li>\n</ol><p>æœ€åï¼Œç›´æ¥æ‰§è¡Œmakeå°±å¯ä»¥ç¼–è¯‘äº†ã€‚ä¸è¿‡ï¼Œè¿™æ—¶å€™ç”±äºæˆ‘ä»¬æ²¡æœ‰å®ç°è§£å°è£…å™¨ï¼Œä¼šæç¤ºff_kwai_demuxerä¸å­˜åœ¨ã€‚ä¸ºäº†èƒ½â€œéª—è¿‡â€ç¼–è¯‘å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨kwaidec.cé‡Œå®šä¹‰ä¸€ä¸‹ï¼Œä¸´æ—¶ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">#include \"avformat.h\"\nconst AVInputFormat  ff_kwai_demuxer;\n</code></pre><p>ç¼–è¯‘é€šè¿‡åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ç†Ÿæ‚‰çš„å‘½ä»¤è¡Œæ¥ç”Ÿæˆä¸€ä¸ªkwaiç±»å‹çš„æ–‡ä»¶äº†ã€‚å…ˆæ‰¾ä¸€ä¸ªæ ‡å‡†çš„MP4æ–‡ä»¶<span class=\"reference\">ï¼ˆå¦‚input.mp4ï¼‰</span>ä½œä¸ºè¾“å…¥ï¼Œå‘½ä»¤è¡Œå¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">./ffmpeg -i input.mp4 -bsf:v h264_mp4toannexb -info 'a simple test' out.kwai\n</code></pre><p>åœ¨ä¸Šè¿°å‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†h264_mp4toannexbè¿™ä¸ªfilterï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å°†MP4ä¸­çš„H264è§†é¢‘å®¹å™¨æ•°æ®å°è£…è½¬æ¢ä¸ºä¼ ç»Ÿçš„ä½¿ç”¨startcodeåˆ†å‰²çš„annexbæ¯”ç‰¹æµæ ¼å¼ã€‚å› ä¸ºå¤§å¤šæ•°è§£ç å™¨åªæ”¯æŒè¿™ç§æ ¼å¼ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨-infoå‚æ•°å¢åŠ äº†ä¸€äº›æ–‡æœ¬ä¿¡æ¯ï¼Œè¾“å‡ºæ–‡ä»¶åä¸ºout.kwaiã€‚</p><p>ç°åœ¨ï¼Œåœ°çƒä¸Šè¿˜æ²¡æœ‰ä»»ä½•ä¸€ä¸ªæ’­æ”¾å™¨èƒ½æ’­æ”¾æˆ‘ä»¬ç”Ÿæˆçš„æ–‡ä»¶ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹æ–‡ä»¶æ ¼å¼æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚Windowså¹³å°å¯ä»¥ä½¿ç”¨ä¸€äº›16è¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€æ–‡ä»¶æŸ¥çœ‹ï¼ŒLinuxæˆ–macOSå¯ä»¥ä½¿ç”¨xxdå‘½ä»¤æ¥æŸ¥çœ‹<span class=\"reference\">ï¼ˆè¿™ä¸ªå‘½ä»¤ä¸€èˆ¬ä¼šéšvimç¼–è¾‘å™¨ä¸€èµ·å®‰è£…ï¼‰</span>ã€‚å…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">$ xxd out.kwai | head -n 4\n</code></pre><p><span class=\"reference\">æ³¨ï¼šhead -n 4è¡¨ç¤ºåªæŸ¥çœ‹è¾“å‡ºçš„å‰4è¡Œã€‚</span></p><p>è¾“å‡ºç»“æœæ˜¯ä¸‹é¢è¿™æ®µå†…å®¹ã€‚</p><pre><code class=\"language-plain\">00000000: 6b77 6169 0000 0001 0000 ac44 0002 0280  kwai.......D....\n00000010: 01e0 000f 0001 6120 7369 6d70 6c65 2074  ......a simple t\n00000020: 6573 7400 0000 0000 0000 0000 0000 0000  est.............\n00000030: 0000 0000 0000 0000 0000 0017 de02 004c  ...............L\n</code></pre><p>å…¶ä¸­ï¼Œè¾“å‡ºç»“æœåœ¨æ¨ªå‘ä¸Šåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå·¦ä¾§æ˜¯æ–‡ä»¶å­—èŠ‚åç§»é‡ï¼Œä»¥16è¿›åˆ¶è¡¨ç¤ºï¼›ä¸­é—´æ˜¯å®é™…çš„æ•°æ®ï¼Œæ¯è¡Œæœ‰16ä¸ªå­—èŠ‚ï¼Œä¸¤ä¸ª16è¿›åˆ¶æ•°å­—è¡¨ç¤ºä¸€ä¸ªå­—èŠ‚<span class=\"reference\">ï¼ˆå–å€¼èŒƒå›´ä¸º00~ffï¼‰</span>ï¼Œä¸¤ä¸ªå­—èŠ‚ä¸ºä¸€ç»„<span class=\"reference\">ï¼ˆå³ä¸€ä¸ªå­—ï¼‰</span>ï¼›æœ€åæ˜¯æ–‡ä»¶å†…å®¹å¯è¯»çš„å½¢å¼ï¼Œå¦‚æœæ˜¯å¯è¯»çš„å­—ç¬¦ï¼Œå°±ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œå¦åˆ™ä»¥â€œ.â€è¡¨ç¤ºã€‚</p><p>å¯¹ç…§ç€æˆ‘ä»¬å‰é¢å¯¹kwaiç±»å‹æ–‡ä»¶çš„å®šä¹‰ä»¥åŠä»£ç å®ç°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„è¾“å‡ºæ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚ä»ç¬¬ä¸€è¡Œçœ‹ï¼Œæœ€å¼€å§‹4ä¸ªå­—èŠ‚6b77 6169ï¼Œå¯¹åº”çš„ASCIIç æ˜¯kwaiï¼Œè¿™æ˜¯æˆ‘ä»¬è§„å®šçš„æ–‡ä»¶å¤´ï¼Œä¹Ÿå°±æ˜¯é­”æ•°ã€‚æ¥ä¸‹æ¥4ä¸ªå­—èŠ‚0000 0001æ˜¯ç‰ˆæœ¬å·<span class=\"reference\">ï¼ˆæ­¤å¤„ä¸º1ï¼‰</span>ï¼›åé¢4ä¸ªå­—èŠ‚0000 ac44æ¢æˆ10è¿›åˆ¶æ˜¯44100ï¼Œå³é‡‡æ ·ç‡ï¼›å†åé¢ä¸€ä¸ªå­—èŠ‚çš„00æ˜¯å ä½ç¬¦ï¼Œæ²¡æœ‰ä»»ä½•ä½œç”¨ï¼›å ä½ç¬¦åçš„ä¸€ä¸ªå­—èŠ‚02è¡¨ç¤ºå£°é“æ•°ï¼›ä¸¤ä¸ªå­—èŠ‚0280è¡¨ç¤ºè§†é¢‘å®½åº¦ï¼Œè½¬æ¢æˆ10è¿›åˆ¶æ˜¯640ã€‚</p><p>ç¬¬äºŒè¡Œï¼Œå‰ä¸¤ä¸ªå­—èŠ‚01e0æ˜¯è§†é¢‘é«˜åº¦ï¼Œå³480ï¼›åé¢æ˜¯å¸§ç‡ï¼š000få’Œ0001ï¼Œå³15/1ã€‚æ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬å‘½ä»¤è¡Œä¸Šç”¨-infoå‚æ•°è®¾ç½®çš„å­—ç¬¦ä¸²ï¼Œæ­¤å¤„æ˜¯â€œa simple testâ€ï¼›åé¢å…¨éƒ¨ä»¥0å¡«å……ï¼Œç›´åˆ°ç¬¬ä¸‰è¡Œè¡Œå°¾ã€‚æˆ‘ä»¬ç²¾å¿ƒè®¾è®¡äº†48ä¸ªå­—èŠ‚çš„æ–‡ä»¶å¤´ï¼Œå°±æ˜¯ä¸ºäº†è®©å®ƒåœ¨è¾“å‡ºæ—¶æ­£å¥½å æ»¡3è¡Œã€‚</p><p>ä»ç¬¬å››è¡Œå¼€å§‹ï¼Œå‰8ä¸ªå­—èŠ‚çš„0æ˜¯æ—¶é—´æˆ³ï¼Œå®ƒæ˜¯ä¸€ä¸ª64ä½æ•´æ•°ï¼Œæ­¤å¤„æ—¶é—´æˆ³æ˜¯ä»0å¼€å§‹çš„ã€‚æ¥ä¸‹æ¥0000 0017è¡¨ç¤ºåé¢éŸ³è§†é¢‘çš„é•¿åº¦ï¼Œå› ä¸ºè¿™ä¸ªæ•°çš„æœ€é«˜ä½æ˜¯0<span class=\"reference\">ï¼ˆäºŒè¿›åˆ¶æœ€é«˜ä½ä¹Ÿæ˜¯0ï¼‰</span>ï¼Œæ‰€ä»¥å®ƒåé¢åº”è¯¥æ˜¯éŸ³é¢‘æ•°æ®ï¼Œå 23<span class=\"reference\">ï¼ˆ0x17æ¢æˆ10è¿›åˆ¶æ˜¯23ï¼‰</span>ä¸ªå­—èŠ‚ã€‚å¾€åè·³è¿‡23ä¸ªå­—èŠ‚å°±åº”è¯¥æ˜¯ä¸‹ä¸€ç»„æ•°æ®äº†ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p>ä½ å¯ä»¥åœ¨å‰é¢çš„å‘½ä»¤è¡Œä¸ŠåŠ ä¸Š-version 2ï¼Œå¹¶ä¿®æ”¹ç›¸åº”çš„infoçœ‹ä¸€ä¸‹æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œå®Œæ•´çš„å‘½ä»¤è¡Œå‚è€ƒå¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">./ffmpeg -i input.mp4 -bsf:v h264_mp4toannexb -info 'another simple test' -version 2 out.kwai\n</code></pre><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬åœ¨FFmpegä¸­æ·»åŠ äº†ä¸€ä¸ªè‡ªå·±ä¸“å±çš„å°è£…æ¨¡å—ï¼Œå¦‚æœä½ æƒ³åªæœ‰ä½ çš„æ’­æ”¾å™¨èƒ½å¤Ÿæ’­æ”¾ä½ è‡ªå·±çš„ç§æœ‰åŒ–éŸ³è§†é¢‘æ•°æ®çš„è¯ï¼Œè¿™ç§æ“ä½œæ˜¯æ¯”è¾ƒå¸¸è§çš„ã€‚å…¶å®æ“ä½œæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯æ·»åŠ AVOutputFormatã€AVIntputFormatã€AVCodecè¿™æ ·çš„ç»“æ„ä½“ï¼Œç»™ç»“æ„ä½“å¡«å……è‡ªå·±æŒ‡å®šçš„å†…å®¹å³å¯ã€‚å­¦ä¹ å®Œè¿™èŠ‚è¯¾ä»¥åï¼Œä½ å¯ä»¥è‡ªå·±åˆ†æFFmpegçš„å„æ¨¡å—ä»£ç ï¼Œè·Ÿç€æˆ‘çš„æ“ä½œæ­¥éª¤æ·»åŠ ä¸€ä¸ªè‡ªå·±çš„ä¸“å±æ¨¡å—ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬å­¦ä¹ çš„æ˜¯æ·»åŠ ä¸€ä¸ªmuxerï¼Œé‚£ä¹ˆä½ èƒ½å¦ä¸ºmuxeræ·»åŠ ä¸€ä¸ªdemuxerå‘¢ï¼Ÿ æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç•™è¨€å’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"13 | FFmpeg æœ‰å“ªäº›å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼Ÿ","id":554456},"right":{"article_title":"15ï½œå¦‚ä½•å‚ä¸åˆ°FFmpegç¤¾åŒºäº¤æµä¸­ï¼Ÿ","id":557488}},"comments":[{"had_liked":false,"id":355592,"user_name":"å¤§åœŸè±†","can_delete":false,"product_type":"c1","uid":1121636,"ip_address":"åŒ—äº¬","ucode":"67445DC3EC9DB0","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/64/52a5863b.jpg","comment_is_top":false,"comment_ctime":1661517116,"is_pvip":false,"replies":[{"id":129429,"content":"è¿™ç§åœºæ™¯å†…å®¹ä¿æŠ¤çš„å¯èƒ½æ€§å¤§ä¸€äº›ã€‚è¿˜æœ‰ä¸€ç§åœºæ™¯æ˜¯ä¸ºäº†é˜²æ­¢ç›—é“¾ï¼Œå½“æ‹¿åˆ°å†…å®¹æ’­ä¸äº†çš„æ—¶å€™ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡é‚£ä¹ˆå¤§çš„æ¯•ä¸šå»ç›—é“¾äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1287929,"ctime":1661669305,"ip_address":"åŒ—äº¬","comment_id":355592,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117501,"comment_content":"è¿™ç§ç§æœ‰æ–‡ä»¶æ ¼å¼çš„ç©æ³•ï¼Œç¡®å®å¾ˆå¤šğŸ˜„ï¼Œå¾®ä¿¡çš„è¯­éŸ³æ–‡ä»¶æ˜¯silkv3æ ¼å¼ï¼Œå’Œæ ‡å‡†æ ¼å¼æœ‰ç‚¹å·®åˆ«æ˜¯æ–‡ä»¶æœ€å‰é¢åŠ äº†ä¸€ä¸ªå­—èŠ‚çš„ç‚¹å·â€œ.â€ ï¼Œå¯¼è‡´å…¶ä»–æ’­æ”¾å™¨éƒ½æ‰“ä¸å¼€ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯å›¾ä¸ªå•¥ã€‚","like_count":3,"discussions":[{"author":{"id":1287929,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a6/f9/79cad962.jpg","nickname":"æ‚Ÿç©º@OnVideo","note":"","ucode":"C320167A9A17B8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585535,"discussion_content":"è¿™ç§åœºæ™¯å†…å®¹ä¿æŠ¤çš„å¯èƒ½æ€§å¤§ä¸€äº›ã€‚è¿˜æœ‰ä¸€ç§åœºæ™¯æ˜¯ä¸ºäº†é˜²æ­¢ç›—é“¾ï¼Œå½“æ‹¿åˆ°å†…å®¹æ’­ä¸äº†çš„æ—¶å€™ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡é‚£ä¹ˆå¤§çš„æ¯•ä¸šå»ç›—é“¾äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1661669305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355423,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1661353190,"is_pvip":false,"replies":[{"id":129349,"content":"1. æˆ‘ä»¥å‰æ˜¯vimï¼Œç°åœ¨æ˜¯VSCodeå’Œcode-serveråœ¨æœåŠ¡å™¨ä¸Šå¼„äº†\n\n2. åº”è¯¥æ˜¯ä½ éœ€è¦è‡ªå·±åŠ ä¸€ä¸ªkwaidec.c æŒ‰ç…§kwaiencé‚£ä¹ˆæ·»åŠ ä¸€ä¸‹ç©ºå®ç°å°±å¯ä»¥äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1287929,"ctime":1661397006,"ip_address":"åŒ—äº¬","comment_id":355423,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117501,"comment_content":"è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š\nQ1ï¼šæŸ¥çœ‹FFmpegæºç ï¼Œlinuxä¸‹ä¸€èˆ¬ç”¨ä»€ä¹ˆè½¯ä»¶ï¼Ÿ Win10ä¸‹ä¸€èˆ¬ç”¨ä»€ä¹ˆè½¯ä»¶ï¼Ÿï¼ˆwin10ä¸‹ç”¨sourceInsightå—ï¼Ÿï¼‰\n\nQ2ï¼šæ·»åŠ æ–‡ä»¶å°è£…æ ¼å¼ä¹‹åï¼Œç¼–è¯‘å¤±è´¥\nâ€œæ·»åŠ æ–‡ä»¶å°è£…æ ¼å¼â€ä¹‹å‰çš„æ“ä½œéƒ½æ˜¯æˆåŠŸçš„ã€‚\nä»â€œæ·»åŠ æ–‡ä»¶å°è£…æ ¼å¼â€å¼€å§‹ï¼Œæˆ‘çš„æ“ä½œæ˜¯ï¼š\n1  æ‰“å¼€kwaienc.c:  vi kwaienc.c\n2 å°†â€œæ·»åŠ æ–‡ä»¶å°è£…æ ¼å¼â€ä¸‹é¢äº”ä¸ªå°æ­¥éª¤ä¸­æ¯ä¸€ä¸ªå°æ­¥éª¤çš„ä»£ç éƒ½\n  æ‹·è´åˆ°kwaienc.cä¸­ï¼ˆåŸæ ·æ‹·è´ï¼Œæ²¡æœ‰ä¿®æ”¹ï¼‰ï¼Œ\n3 æ‰“å¼€kwaidec.cï¼ŒåŠ å…¥ä¸‹é¢ä¸¤å¥ï¼š\n#include &quot;avformat.h&quot;\nconst AVInputFormat  ff_kwai_demuxer;\n\nç„¶åç¼–è¯‘ï¼š make -j4\næŠ¥é”™ï¼š&#47;usr&#47;bin&#47;ld: libavformat&#47;libavformat.a(allformats.o):(.data.rel.ro+0xa40): undefined reference to `ff_kwai_demuxer&#39;\n\nè¯·é—®é”™è¯¯åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ æ€ä¹ˆä¿®æ”¹ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1287929,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a6/f9/79cad962.jpg","nickname":"æ‚Ÿç©º@OnVideo","note":"","ucode":"C320167A9A17B8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585207,"discussion_content":"1. æˆ‘ä»¥å‰æ˜¯vimï¼Œç°åœ¨æ˜¯VSCodeå’Œcode-serveråœ¨æœåŠ¡å™¨ä¸Šå¼„äº†\n\n2. åº”è¯¥æ˜¯ä½ éœ€è¦è‡ªå·±åŠ ä¸€ä¸ªkwaidec.c æŒ‰ç…§kwaiencé‚£ä¹ˆæ·»åŠ ä¸€ä¸‹ç©ºå®ç°å°±å¯ä»¥äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661397006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361509,"user_name":"é’æ™¨æ˜Šå¤©","can_delete":false,"product_type":"c1","uid":1241366,"ip_address":"å››å·","ucode":"2343ECA8D9E9BC","user_header":"https://static001.geekbang.org/account/avatar/00/12/f1/16/bca904d6.jpg","comment_is_top":false,"comment_ctime":1667556209,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100117501,"comment_content":"è¯·é—®è€å¸ˆï¼Œå…³äºè‡ªå®šä¹‰filterçš„ç¼–å†™ï¼Œæœ‰å“ªäº›æ•™ç¨‹","like_count":1},{"had_liked":false,"id":386103,"user_name":"ifelse","can_delete":false,"product_type":"c1","uid":2550743,"ip_address":"æµ™æ±Ÿ","ucode":"D0565908C99695","user_header":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","comment_is_top":false,"comment_ctime":1704107802,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":3,"score":2,"product_id":100117501,"comment_content":"å­¦ä¹ æ‰“å¡","like_count":0},{"had_liked":false,"id":357840,"user_name":"jcy","can_delete":false,"product_type":"c1","uid":1264411,"ip_address":"åŒ—äº¬","ucode":"7C3E10C4E0FA87","user_header":"https://static001.geekbang.org/account/avatar/00/13/4b/1b/e3b3bcff.jpg","comment_is_top":false,"comment_ctime":1663673439,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100117501,"comment_content":"å†™éŸ³è§†é¢‘æ•°æ® éƒ¨åˆ†é‡Œçš„å‡½æ•°å¼€å¤´éƒ¨åˆ†ï¼š\nstatic int kwai_write_packet(AVFormatContext *s, AVPacket *pkt) { \n&#47;&#47; kwaiMuxContext *mov = s-&gt;priv_data; \nuint32_t size = pkt-&gt;size; &#47;&#47; è·å–æ•°æ®å¤§å° \nif (!pkt) { \n    return 1; \n}\n...\n\nè¿™é‡Œåº”è¯¥åœ¨å‡½æ•°å¼€å¤´å…ˆåˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºç©º if (!pkt) ç„¶åå†å– pkt-&gt;size","like_count":0,"discussions":[{"author":{"id":1287929,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a6/f9/79cad962.jpg","nickname":"æ‚Ÿç©º@OnVideo","note":"","ucode":"C320167A9A17B8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588523,"discussion_content":"å·²æ”¹ï¼Œå¤šè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663812599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}