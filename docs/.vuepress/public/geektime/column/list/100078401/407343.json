{"id":407343,"title":"42 | ç§ä¸€ç§Linuxï¼šå¦‚ä½•å®ç°ç³»ç»ŸAPIï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚</p><p>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬é€šè¿‡å®ç°ä¸€ä¸ªè·å–æ—¶é—´çš„ç³»ç»ŸæœåŠ¡ï¼Œå­¦ä¹ äº†Cosmosé‡Œå¦‚ä½•å»ºç«‹ä¸€ä¸ªç³»ç»ŸæœåŠ¡æ¥å£ã€‚Cosmosä¸ºåº”ç”¨ç¨‹åºæä¾›æœåŠ¡çš„è¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼šåº”ç”¨ç¨‹åºå…ˆè®¾ç½®æœåŠ¡å‚æ•°ï¼Œç„¶åé€šè¿‡intæŒ‡ä»¤è¿›å…¥å†…æ ¸ï¼Œç”±Cosmoså†…æ ¸è¿è¡Œç›¸åº”çš„æœåŠ¡å‡½æ•°ï¼Œæœ€åä¸ºåº”ç”¨ç¨‹åºæä¾›æ‰€éœ€æœåŠ¡ã€‚</p><p>ä¸çŸ¥é“ä½ æ˜¯å¦å¥½å¥‡è¿‡ä¸šå†…æˆç†Ÿçš„Linuxå†…æ ¸ï¼Œåˆæ˜¯æ€æ ·ä¸ºåº”ç”¨ç¨‹åºæä¾›æœåŠ¡çš„å‘¢ï¼Ÿ</p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬å°±æ¥çœ‹çœ‹Linuxå†…æ ¸æ˜¯å¦‚ä½•å®ç°è¿™ä¸€è¿‡ç¨‹çš„ï¼Œæˆ‘ä»¬é¦–å…ˆäº†è§£ä¸€ä¸‹Linuxå†…æ ¸æœ‰å¤šå°‘APIæ¥å£ï¼Œç„¶åäº†è§£ä¸€ä¸‹Linuxå†…æ ¸APIæ¥å£çš„æ¶æ„ï¼Œæœ€åï¼Œæˆ‘ä»¬åŠ¨æ‰‹ä¸ºLinuxå†…æ ¸å¢åŠ ä¸€ä¸ªå…¨æ–°çš„APIï¼Œå¹¶å®ç°ç›¸åº”çš„åŠŸèƒ½ã€‚</p><p>ä¸‹é¢è®©æˆ‘ä»¬å¼€å§‹å§ï¼è¿™èŠ‚è¯¾çš„é…å¥—ä»£ç ä½ å¯ä»¥ä»<a href=\"https://gitee.com/lmos/cosmos/tree/master/lesson42\">è¿™é‡Œ</a>ä¸‹è½½ã€‚</p><h2>Linuxå†…æ ¸APIæ¥å£çš„æ¶æ„</h2><p>åœ¨ä¸ŠèŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç†Ÿæ‚‰äº†æˆ‘ä»¬è‡ªå·±çš„Cosmoså†…æ ¸æœåŠ¡æ¥å£çš„æ¶æ„ï¼Œç”±åº”ç”¨ç¨‹åºè°ƒç”¨åº“å‡½æ•°ï¼Œå†ç”±åº“å‡½æ•°è°ƒç”¨APIå…¥å£å‡½æ•°ï¼Œè¿›å…¥å†…æ ¸å‡½æ•°æ‰§è¡Œç³»ç»ŸæœåŠ¡ã€‚</p><p>å…¶å®å¯¹äºLinuxå†…æ ¸ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåº”ç”¨ç¨‹åºä¼šè°ƒç”¨åº“å‡½æ•°ï¼Œåœ¨åº“å‡½æ•°ä¸­è°ƒç”¨APIå…¥å£å‡½æ•°ï¼Œè§¦å‘ä¸­æ–­è¿›å…¥Linuxå†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå®Œæˆç›¸åº”çš„åŠŸèƒ½æœåŠ¡ã€‚</p><p>åœ¨Linuxå†…æ ¸ä¹‹ä¸Šï¼Œä½¿ç”¨æœ€å¹¿æ³›çš„Cåº“æ˜¯glibcï¼Œå…¶ä¸­åŒ…æ‹¬Cæ ‡å‡†åº“çš„å®ç°ï¼Œä¹ŸåŒ…æ‹¬æ‰€æœ‰å’Œç³»ç»ŸAPIå¯¹åº”çš„åº“æ¥å£å‡½æ•°ã€‚å‡ ä¹æ‰€æœ‰Cç¨‹åºéƒ½è¦è°ƒç”¨glibcçš„åº“å‡½æ•°ï¼Œæ‰€ä»¥<strong>glibcæ˜¯Linuxå†…æ ¸ä¸ŠCç¨‹åºè¿è¡Œçš„åŸºç¡€ã€‚</strong></p><!-- [[[read_end]]] --><p>ä¸‹é¢æˆ‘ä»¬ä»¥openåº“å‡½æ•°ä¸ºä¾‹åˆ†æä¸€ä¸‹ï¼Œçœ‹çœ‹openæ˜¯å¦‚ä½•è¿›å…¥Linuxå†…æ ¸è°ƒç”¨ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨çš„ã€‚glibcè™½ç„¶å¼€æºäº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨Linuxå†…æ ¸ä»£ç ä¹‹ä¸­ï¼Œä½ éœ€è¦ä»<a href=\"https://www.gnu.org/software/libc/sources.html\">è¿™é‡Œ</a>ä¸‹è½½å¹¶è§£å‹ï¼Œopenå‡½æ•°ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//glibc/intl/loadmsgcat.c\n#ifdef _LIBC\n# define open(name, flags)  __open_nocancel (name, flags)\n# define close(fd)      __close_nocancel_nostatus (fd)\n#endif\n//glibc/sysdeps/unix/sysv/linux/open_nocancel.c\nint __open_nocancel (const char *file, int oflag, ...)\n{\n  int mode = 0;\n  if (__OPEN_NEEDS_MODE (oflag))\n    {\n      va_list arg;\n      va_start (arg, oflag);//è§£å†³å¯å˜å‚æ•°\n      mode = va_arg (arg, int);\n      va_end (arg);\n    }\n  return INLINE_SYSCALL_CALL (openat, AT_FDCWD, file, oflag, mode);\n}\n//glibc/sysdeps/unix/sysdep.h\n//è¿™æ˜¯ä¸ºäº†è§£å†³ä¸åŒå‚æ•°æ•°é‡çš„é—®é¢˜\n#define __INLINE_SYSCALL0(name) \\\n  INLINE_SYSCALL (name, 0)\n#define __INLINE_SYSCALL1(name, a1) \\\n  INLINE_SYSCALL (name, 1, a1)\n#define __INLINE_SYSCALL2(name, a1, a2) \\\n  INLINE_SYSCALL (name, 2, a1, a2)\n#define __INLINE_SYSCALL3(name, a1, a2, a3) \\\n  INLINE_SYSCALL (name, 3, a1, a2, a3)\n#define __INLINE_SYSCALL_NARGS_X(a,b,c,d,e,f,g,h,n,...) n\n#define __INLINE_SYSCALL_NARGS(...) \\\n  __INLINE_SYSCALL_NARGS_X (__VA_ARGS__,7,6,5,4,3,2,1,0,)\n#define __INLINE_SYSCALL_DISP(b,...) \\\n  __SYSCALL_CONCAT (b,__INLINE_SYSCALL_NARGS(__VA_ARGS__))(__VA_ARGS__)\n#define INLINE_SYSCALL_CALL(...) \\\n  __INLINE_SYSCALL_DISP (__INLINE_SYSCALL, __VA_ARGS__)\n//glibc/sysdeps/unix/sysv/linux/sysdep.h\n//å…³é”®æ˜¯è¿™ä¸ªå®\n#define INLINE_SYSCALL(name, nr, args...)       \\\n  ({                  \\\n    long int sc_ret = INTERNAL_SYSCALL (name, nr, args);    \\\n    __glibc_unlikely (INTERNAL_SYSCALL_ERROR_P (sc_ret))    \\\n    ? SYSCALL_ERROR_LABEL (INTERNAL_SYSCALL_ERRNO (sc_ret))   \\\n    : sc_ret;               \\\n  })\n#define INTERNAL_SYSCALL(name, nr, args...)       \\\n  internal_syscall##nr (SYS_ify (name), args)\n#define INTERNAL_SYSCALL_NCS(number, nr, args...)     \\\n  internal_syscall##nr (number, args)\n//è¿™æ˜¯éœ€è¦6ä¸ªå‚æ•°çš„å®\n#define internal_syscall6(number, arg1, arg2, arg3, arg4, arg5, arg6) \\\n({                  \\\n    unsigned long int resultvar;          \\\n    TYPEFY (arg6, __arg6) = ARGIFY (arg6);        \\\n    TYPEFY (arg5, __arg5) = ARGIFY (arg5);        \\\n    TYPEFY (arg4, __arg4) = ARGIFY (arg4);        \\\n    TYPEFY (arg3, __arg3) = ARGIFY (arg3);        \\\n    TYPEFY (arg2, __arg2) = ARGIFY (arg2);        \\\n    TYPEFY (arg1, __arg1) = ARGIFY (arg1);        \\\n    register TYPEFY (arg6, _a6) asm (&quot;r9&quot;) = __arg6;      \\\n    register TYPEFY (arg5, _a5) asm (&quot;r8&quot;) = __arg5;      \\\n    register TYPEFY (arg4, _a4) asm (&quot;r10&quot;) = __arg4;     \\\n    register TYPEFY (arg3, _a3) asm (&quot;rdx&quot;) = __arg3;     \\\n    register TYPEFY (arg2, _a2) asm (&quot;rsi&quot;) = __arg2;     \\\n    register TYPEFY (arg1, _a1) asm (&quot;rdi&quot;) = __arg1;     \\\n    asm volatile (              \\\n    &quot;syscall\\n\\t&quot;             \\\n    : &quot;=a&quot; (resultvar)              \\\n    : &quot;0&quot; (number), &quot;r&quot; (_a1), &quot;r&quot; (_a2), &quot;r&quot; (_a3), &quot;r&quot; (_a4),   \\\n      &quot;r&quot; (_a5), &quot;r&quot; (_a6)            \\\n    : &quot;memory&quot;, REGISTERS_CLOBBERED_BY_SYSCALL);      \\\n    (long int) resultvar;           \\\n})\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œopenåªæ˜¯å®ï¼Œå®é™…å·¥ä½œçš„æ˜¯__open_nocancelå‡½æ•°ï¼Œå…¶ä¸­ä¼šç”¨INLINE_SYSCALL_CALLå®ç»è¿‡ä¸€ç³»åˆ—æ›¿æ¢ï¼Œæœ€ç»ˆæ ¹æ®å‚æ•°çš„ä¸ªæ•°æ›¿æ¢æˆç›¸åº”çš„internal_syscall##nrå®ã€‚</p><p>æ¯”å¦‚æœ‰6ä¸ªå‚æ•°ï¼Œå°±ä¼šæ›¿æ¢æˆinternal_syscall6ã€‚å…¶ä¸­numberæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Œå‚æ•°é€šè¿‡å¯„å­˜å™¨ä¼ é€’çš„ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰å‘ç°intæŒ‡ä»¤ï¼Œè¿™æ˜¯å› ä¸ºè¿™é‡Œç”¨åˆ°çš„æŒ‡ä»¤æ˜¯æœ€æ–°å¤„ç†å™¨ä¸ºå…¶è®¾è®¡çš„ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤syscallã€‚è¿™ä¸ªæŒ‡ä»¤å’ŒintæŒ‡ä»¤ä¸€æ ·ï¼Œéƒ½å¯ä»¥è®©CPUè·³è½¬åˆ°ç‰¹å®šçš„åœ°å€ä¸Šï¼Œåªä¸è¿‡ä¸ç»è¿‡ä¸­æ–­é—¨ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶è¦ç”¨sysexitæŒ‡ä»¤ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†è¿™ä¸ªopenå‡½æ•°çš„è°ƒç”¨æµç¨‹ï¼Œå¦‚æœç”¨ä¸€å¹…å›¾æ¥å±•ç¤ºLinuxå†…æ ¸APIçš„æ¶æ„ï¼Œå°±ä¼šå‘ˆç°åé¢è¿™ä¸ªæ ·å­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/03/8f/03yy161484ed15837f58a4283b960c8f.jpg?wh=3363x2822\" alt=\"\" title=\"LinuxAPIæ¡†æ¶\"></p><p>æœ‰äº†å‰é¢ä»£ç æµç¨‹åˆ†æå’Œç»“æ„ç¤ºæ„å›¾ï¼Œæˆ‘æƒ³ä½ ä¼šå¯¹Linuxå†…æ ¸APIçš„æ¡†æ¶ç»“æ„åŠ æ·±äº†è§£ã€‚ä¸Šå›¾ä¸­çš„ç³»ç»Ÿè°ƒç”¨è¡¨å’Œè®¸å¤šsys_xxxxå‡½æ•°ä½ å¯èƒ½ä¸å¤ªæ˜ç™½ï¼Œåˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬åé¢å°±ä¼šè®²åˆ°ã€‚</p><p>é‚£ä¹ˆLinuxç³»ç»Ÿæœ‰å¤šå°‘ä¸ªAPIå‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·å»çœ‹çœ‹å§ã€‚</p><h2>Linuxå†…æ ¸æœ‰å¤šå°‘APIæ¥å£</h2><p>Linuxä½œä¸ºæ¯”è¾ƒæˆç†Ÿçš„æ“ä½œç³»ç»Ÿï¼ŒåŠŸèƒ½å®Œå–„ï¼Œå®ƒä»¥ä¼—å¤šAPIæ¥å£çš„æ–¹å¼å‘åº”ç”¨ç¨‹åºæä¾›æ–‡ä»¶ã€ç½‘ç»œã€è¿›ç¨‹ã€æ—¶é—´ç­‰å¾…æœåŠ¡ï¼Œå¹¶ä¸”å®Œç¾æ‰§è¡Œäº†å›½é™…posixæ ‡å‡†ã€‚</p><p>Linuxä»æœ€åˆå‡ åä¸ªAPIæ¥å£ï¼Œç°åœ¨å·²ç»å‘å±•åˆ°äº†å‡ ç™¾ä¸ªAPIæ¥å£ï¼Œä»è¿™é‡Œä½ å¯ä»¥é¢„è§åˆ°Linuxå†…æ ¸åŠŸèƒ½å¢åŠ çš„é€Ÿåº¦ä¸æ•°é‡ã€‚é‚£ä¹ˆç°åœ¨çš„Linuxå†…æ ¸ç©¶ç«Ÿæœ‰å¤šå°‘ä¸ªAPIæ¥å£å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯è¦æ¥çœ‹çœ‹æœ€æ–°å‘å¸ƒçš„Linuxå†…æ ¸ç‰ˆæœ¬ï¼Œæ‰èƒ½å‡†ç¡®çŸ¥é“ã€‚</p><p>å…·ä½“æˆ‘ä»¬éœ€è¦å¯¹Linuxä»£ç è¿›è¡Œç¼–è¯‘ï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®syscall_32.tblå’Œsyscall_64.tblç”Ÿæˆè‡ªå·±çš„syscalls_32.hå’Œsyscalls_64.hæ–‡ä»¶ã€‚</p><p>ç”Ÿæˆæ–¹å¼åœ¨ arch/x86/entry/syscalls/Makefile æ–‡ä»¶ä¸­ã€‚è¿™é‡Œé¢ä¼šä½¿ç”¨ä¸¤ä¸ªè„šæœ¬ï¼Œå³syscallhdr.shã€syscalltbl.shï¼Œå®ƒä»¬æœ€ç»ˆç”Ÿæˆçš„ syscalls_32.h å’Œ syscalls_64.hä¸¤ä¸ªæ–‡ä»¶ä¸­å°±ä¿å­˜äº†<strong>ç³»ç»Ÿè°ƒç”¨å·å’Œç³»ç»Ÿè°ƒç”¨å®ç°å‡½æ•°ä¹‹é—´çš„å¯¹åº”å…³ç³»</strong>ï¼Œåœ¨é‡Œé¢å¯ä»¥çœ‹åˆ°Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå³APIå·ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//linux/arch/x86/include/generated/asm/syscalls_64.h\n__SYSCALL_COMMON(0, sys_read)\n__SYSCALL_COMMON(1, sys_write)\n__SYSCALL_COMMON(2, sys_open)\n__SYSCALL_COMMON(3, sys_close)\n__SYSCALL_COMMON(4, sys_newstat)\n__SYSCALL_COMMON(5, sys_newfstat)\n__SYSCALL_COMMON(6, sys_newlstat)\n__SYSCALL_COMMON(7, sys_poll)\n__SYSCALL_COMMON(8, sys_lseek)\n//â€¦â€¦\n__SYSCALL_COMMON(435, sys_clone3)\n__SYSCALL_COMMON(436, sys_close_range)\n__SYSCALL_COMMON(437, sys_openat2)\n__SYSCALL_COMMON(438, sys_pidfd_getfd)\n__SYSCALL_COMMON(439, sys_faccessat2)\n__SYSCALL_COMMON(440, sys_process_madvise)\n//linux/arch/x86/include/generated/uapi/asm/unistd_64.h\n#define __NR_read 0\n#define __NR_write 1\n#define __NR_open 2\n#define __NR_close 3\n#define __NR_stat 4\n#define __NR_fstat 5\n#define __NR_lstat 6\n#define __NR_poll 7\n#define __NR_lseek 8\n//â€¦â€¦\n#define __NR_clone3 435\n#define __NR_close_range 436\n#define __NR_openat2 437\n#define __NR_pidfd_getfd 438\n#define __NR_faccessat2 439\n#define __NR_process_madvise 440\n#ifdef __KERNEL__\n#define __NR_syscall_max 440\n#endif\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå·²ç»å®šä¹‰äº†__NR_syscall_maxä¸º440ï¼Œè¿™è¯´æ˜Linuxå†…æ ¸ä¸€å…±æœ‰441ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè€Œç³»ç»Ÿè°ƒç”¨å·ä»0å¼€å§‹åˆ°440ç»“æŸï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯sys_process_madviseã€‚</p><p>å…¶å®ï¼Œ__SYSCALL_COMMONé™¤äº†è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨å·å’Œç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¹‹é—´çš„å…³ç³»ï¼Œè¿˜ä¼šåœ¨Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨è¡¨ä¸­è¿›è¡Œç›¸åº”çš„å±•å¼€ï¼Œç©¶ç«Ÿå±•å¼€æˆä»€ä¹ˆæ ·å­å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥ç€çœ‹ä¸€çœ‹Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨è¡¨ã€‚</p><h3>Linuxç³»ç»Ÿè°ƒç”¨è¡¨</h3><p>Linuxå†…æ ¸æœ‰400å¤šä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œå­˜æ”¾æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„åœ°å€ï¼Œé€šè¿‡æ•°ç»„ä¸‹æ ‡å°±èƒ½ç´¢å¼•åˆ°ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ã€‚è¿™ä¸ªæ•°ç»„å«sys_call_tableï¼Œå³Linuxç³»ç»Ÿè°ƒç”¨è¡¨ã€‚</p><p>sys_call_tableåˆ°åº•é•¿ä»€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ä»£ç æ‰çŸ¥é“ï¼ŒåŒæ—¶ä¹Ÿè§£ç­”ä¸€ä¸‹å‰é¢ç•™ä¸‹çš„ç–‘é—®ï¼Œè¿™é‡Œè¿˜æ˜¯è¦è¯´æ˜ä¸€ä¸‹ï¼Œ__SYSCALL_COMMONé¦–å…ˆä¼šæ›¿æ¢æˆ__SYSCALL_64ï¼Œå› ä¸ºæˆ‘ä»¬ç¼–è¯‘çš„Linuxå†…æ ¸æ˜¯x86_64æ¶æ„çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#define __SYSCALL_COMMON(nr, sym) __SYSCALL_64(nr, sym)\n//ç¬¬ä¸€æ¬¡å®šä¹‰__SYSCALL_64\n#define __SYSCALL_64(nr, sym) extern asmlinkage long sym(unsigned long, unsigned long, unsigned long, unsigned long, unsigned long, unsigned long) ;\n#include &lt;asm/syscalls_64.h&gt;//ç¬¬ä¸€æ¬¡åŒ…å«syscalls_64.hæ–‡ä»¶ï¼Œå…¶ä¸­çš„å®ä¼šè¢«å±•å¼€ä¸€æ¬¡ï¼Œä¾‹å¦‚__SYSCALL_COMMON(2, sys_open)ä¼šè¢«å±•å¼€æˆï¼š\nextern asmlinkage long sys_open(unsigned long, unsigned long, unsigned long, unsigned long, unsigned long, unsigned long) ;\nè¿™è¡¨ç¤ºç”³æ˜\n//å–æ¶ˆ__SYSCALL_64å®šä¹‰\n#undef __SYSCALL_64\n//ç¬¬äºŒæ¬¡é‡æ–°å®šä¹‰__SYSCALL_64\n#define __SYSCALL_64(nr, sym) [ nr ] = sym,\n\nextern asmlinkage long sys_ni_syscall(unsigned long, unsigned long, unsigned long, unsigned long, unsigned long, unsigned long);\nconst sys_call_ptr_t sys_call_table[] ____cacheline_aligned = {\n    [0 ... __NR_syscall_max] = &amp;sys_ni_syscall,//é»˜è®¤ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œä»€ä¹ˆéƒ½ä¸å¹²\n#include &lt;asm/syscalls_64.h&gt;//åŒ…å«å‰é¢ç”Ÿæˆæ–‡ä»¶\n//ç¬¬äºŒæ¬¡åŒ…å«syscalls_64.hæ–‡ä»¶ï¼Œå…¶ä¸­çš„å®ä¼šè¢«å†å±•å¼€ä¸€æ¬¡ï¼Œä¾‹å¦‚__SYSCALL_COMMON(2, sys_open)ä¼šè¢«å±•å¼€æˆï¼š\n[2] = sys_open, ç”¨äºåˆå§‹åŒ–è¿™ä¸ªæ•°ç»„ï¼Œå³è¡¨ç¤ºæ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ å¡«å…¥sys_open\n};\nint syscall_table_size = sizeof(sys_call_table);//ç³»ç»Ÿè°ƒç”¨è¡¨çš„å¤§å°\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œé€šè¿‡ä¸¤æ¬¡åŒ…å«syscalls_64.hæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­åˆ†åˆ«å®šä¹‰ä¸åŒçš„__SYSCALL_64å®ï¼Œå®Œæˆäº†ç³»ç»Ÿè°ƒç”¨å‡½æ•°çš„ç”³æ˜å’Œç³»ç»Ÿè°ƒç”¨è¡¨çš„åˆå§‹åŒ–ï¼Œä¸å¾—ä¸è¯´è¿™æ˜¯ä¸€ä¸ªéå¸¸å·§å¦™çš„æ–¹å¼ã€‚</p><p>sys_call_tableæ•°ç»„ï¼Œç¬¬ä¸€æ¬¡å…¨éƒ¨åˆå§‹åŒ–ä¸ºé»˜è®¤ç³»ç»Ÿè°ƒç”¨å‡½æ•°sys_ni_syscallï¼Œè¿™ä¸ªå‡½æ•°ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œè¿™æ˜¯ä¸ºäº†<strong>é˜²æ­¢æ•°ç»„æœ‰äº›å…ƒç´ ä¸­æ²¡æœ‰å‡½æ•°åœ°å€ï¼Œä»è€Œå¯¼è‡´è°ƒç”¨å¤±è´¥ã€‚</strong>è¿™åœ¨å†…æ ¸ä¸­æ˜¯éå¸¸å±é™©çš„ã€‚æˆ‘å•ç‹¬æç¤ºä½ è¿™ç‚¹ï¼Œå…¶å®ä¹Ÿæ˜¯å¸Œæœ›ä½ ç•™æ„è¿™ç§ç¼–ç¨‹æŠ€å·§ï¼Œè¿™åœ¨å†…æ ¸ç¼–ç ä¸­å¹¶ä¸ç½•è§ï¼Œè€ƒè™‘åˆ°å†…æ ¸ç¼–ç¨‹ä»£ç çš„å®‰å…¨æ€§ï¼ŒåŠ ä¸€é“é˜²çº¿å¯ä»¥æœ‰å¤‡æ— æ‚£ã€‚</p><h2>Linuxç³»ç»Ÿè°ƒç”¨å®ç°</h2><p>å‰é¢æˆ‘ä»¬å·²ç»äº†è§£äº†Linuxç³»ç»Ÿè°ƒç”¨çš„æ¶æ„å’ŒLinuxç³»ç»Ÿè°ƒç”¨è¡¨ï¼Œä¹Ÿæ¸…æ¥šäº†Linuxç³»ç»Ÿè°ƒç”¨çš„ä¸ªæ•°å’Œå®šä¹‰ä¸€ä¸ªLinuxç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼ã€‚</p><p>ä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£Linuxç³»ç»Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬ä¸ºç°æœ‰çš„Linuxå†™ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½å¹¶ä¸å¤æ‚ï¼Œå°±æ˜¯è¿”å›ä½ æœºå™¨çš„CPUæ•°é‡ï¼Œå³ä½ çš„æœºå™¨æ˜¯å¤šå°‘æ ¸å¿ƒçš„å¤„ç†å™¨ã€‚</p><p>ä¸ºLinuxå¢åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå…¶å®æœ‰å¾ˆå¤šæ­¥éª¤ï¼Œä¸è¿‡ä¹Ÿåˆ«æ…Œï¼Œä¸‹é¢æˆ‘å°†ä¸€æ­¥ä¸€æ­¥ä¸ºä½ è®²è§£ã€‚</p><h3>ä¸‹è½½Linuxæºç </h3><p>æƒ³ä¸ºLinuxç³»ç»Ÿå¢åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œé¦–å…ˆä½ å¾—æœ‰Linuxå†…æ ¸æºä»£ç ï¼Œå¦‚æœä½ æœºå™¨ä¸Šæ²¡æœ‰Linuxå†…æ ¸æºä»£ç ï¼Œä½ å°±è¦å»<a href=\"https://www.kernel.org/\">å†…æ ¸å®˜ç½‘</a>ä¸‹è½½ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥åˆ°GitHubä¸Šgit cloneä¸€ä»½å†…æ ¸ä»£ç ã€‚</p><p>å¦‚æœä½ ä½¿ç”¨äº†git cloneçš„æ–¹å¼ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼æ“ä½œã€‚</p><pre><code>git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git/\n</code></pre><p>å¦‚æœä½ æƒ³å°½é‡ä¿æŒä¸æˆ‘çš„Linuxå†…æ ¸ç‰ˆæœ¬ç›¸åŒï¼Œé™ä½å‡ºç°å„ç§æœªçŸ¥é—®é¢˜çš„æ¦‚ç‡ï¼Œé‚£ä¹ˆè¯·ä½ ä½¿ç”¨<strong>5.10.13ç‰ˆæœ¬</strong>çš„å†…æ ¸ã€‚å¦å¤–åˆ«å¿˜äº†ï¼Œå¦‚æœä½ ä¸‹è½½çš„Linuxå†…æ ¸æ˜¯å‹ç¼©åŒ…ï¼Œè¯·è®°å¾—å…ˆè§£å‹åˆ°ä¸€ä¸ªå¯ä»¥è®¿é—®çš„ç›®å½•ä¸‹ã€‚</p><h3>ç”³æ˜ç³»ç»Ÿè°ƒç”¨</h3><p>æ ¹æ®å‰é¢çš„çŸ¥è¯†ç‚¹ï¼Œå¯ä»¥å¾—çŸ¥Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨çš„ç”³æ˜æ–‡ä»¶å’Œä¿¡æ¯ï¼Œå…·ä½“å®ç°æ˜¯è¿™æ ·çš„ï¼šç”±ä¸€ä¸ªmakefileåœ¨ç¼–è¯‘Linuxç³»ç»Ÿå†…æ ¸æ—¶è°ƒç”¨äº†ä¸€ä¸ªè„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬æ–‡ä»¶ä¼šè¯»å–å¦ä¸€ä¸ªå«syscall_64.tblæ–‡ä»¶ï¼Œæ ¹æ®å…¶ä¸­ä¿¡æ¯ç”Ÿæˆç›¸åº”çš„æ–‡ä»¶syscall_64.hã€‚</p><p>è¯·æ³¨æ„ï¼Œæˆ‘è¿™é‡Œæ˜¯ä»¥x86_64æ¶æ„ä¸ºä¾‹è¿›è¡Œè¯´æ˜çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶ä¸å…³æ³¨syscall_64.hçš„ç”ŸæˆåŸç†ï¼Œåªå…³æ³¨syscall_64.tblæ–‡ä»¶ä¸­çš„å†…å®¹ã€‚ä¸‹é¢æˆ‘ä»¬è¿˜æ˜¯ç»“åˆä»£ç çœ‹ä¸€ä¸‹å§ã€‚</p><pre><code>//linux-5.10.13/arch/x86/entry/syscalls/syscall_64.tbl\n0\tcommon\tread\t\t\tsys_read\n1\tcommon\twrite\t\t\tsys_write\n2\tcommon\topen\t\t\tsys_open\n3\tcommon\tclose\t\t\tsys_close\n4\tcommon\tstat\t\t\tsys_newstat\n5\tcommon\tfstat\t\t\tsys_newfstat\n6\tcommon\tlstat\t\t\tsys_newlstat\n7\tcommon\tpoll\t\t\tsys_poll\n8\tcommon\tlseek\t\t\tsys_lseek\n9\tcommon\tmmap\t\t\tsys_mmap\n10\tcommon\tmprotect\t\tsys_mprotect\n11\tcommon\tmunmap\t\t\tsys_munmap\n12\tcommon\tbrk\t\t\t    sys_brk\n//â€¦â€¦\n435\tcommon\tclone3\t\t\tsys_clone3\n436\tcommon\tclose_range\t\tsys_close_range\n437\tcommon\topenat2\t\t\tsys_openat2\n438\tcommon\tpidfd_getfd\t\tsys_pidfd_getfd\n439\tcommon\tfaccessat2\t\tsys_faccessat2\n440\tcommon\tprocess_madvise\t\tsys_process_madvise\n</code></pre><p>ä¸Šé¢è¿™äº›ä»£ç å¯ä»¥åˆ†æˆå››åˆ—ï¼Œåˆ†åˆ«æ˜¯ç³»ç»Ÿè°ƒç”¨å·ã€æ¶æ„ã€æœåŠ¡åï¼Œä»¥åŠå…¶ç›¸å¯¹åº”çš„æœåŠ¡å…¥å£å‡½æ•°ã€‚ä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨opençš„ç»“æ„ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/77/f4/777e8e56b151b5812c48e06d861408f4.jpg?wh=1483x541\" alt=\"\"></p><p>é‚£æˆ‘ä»¬è¦å¦‚ä½•ç”³æ˜è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨å‘¢ï¼Ÿç¬¬ä¸€æ­¥å°±éœ€è¦åœ¨syscall_64.tblæ–‡ä»¶ä¸­å¢åŠ ä¸€é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>441\tcommon\tget_cpus\t\tsys_get_cpus\n</code></pre><p>æˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨å·æ˜¯441ï¼Œæ¶æ„æ˜¯common ï¼ŒæœåŠ¡åç§°æ˜¯get_cpusï¼ŒæœåŠ¡å…¥å£å‡½æ•°åˆ™æ˜¯sys_get_cpusã€‚è¯·æ³¨æ„ç³»ç»Ÿè°ƒç”¨å·è¦å”¯ä¸€ï¼Œä¸èƒ½å’Œå…¶å®ƒç³»ç»Ÿè°ƒç”¨å·å†²çªã€‚</p><p>å†™å¥½è¿™ä¸ªï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠsys_get_cpuså‡½æ•°åœ¨syscalls.hæ–‡ä»¶ä¸­ç”³æ˜ä¸€ä¸‹ï¼Œä¾›å…¶å®ƒå†…æ ¸æ¨¡å—å¼•ç”¨ã€‚å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//linux-5.10.13/include/linux/syscalls.h\nasmlinkage long sys_get_cpus(void);\n</code></pre><p>è¿™ä¸€æ­¥åšå¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªLinuxç³»ç»Ÿè°ƒç”¨çš„æ‰€æœ‰ç”³æ˜å·¥ä½œã€‚ä¸‹é¢æˆ‘ä»¬å°±å»å®šä¹‰è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„æœåŠ¡å…¥å£å‡½æ•°ã€‚</p><h3>å®šä¹‰ç³»ç»Ÿè°ƒç”¨</h3><p>æˆ‘ä»¬ç°åœ¨æ¥å®šä¹‰è‡ªå·±çš„ç¬¬ä¸€ä¸ªLinuxç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºäº†é™ä½å·¥ç¨‹å¤æ‚åº¦ï¼Œæˆ‘ä»¬ä¸æ‰“ç®—æ–°å»ºä¸€ä¸ªCæ¨¡å—æ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥åœ¨Linuxå†…æ ¸ä»£ç ç›®å½•ä¸‹æŒ‘ä¸€ä¸ªå·²ç»å­˜åœ¨çš„Cæ¨¡å—æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚</p><p>å®šä¹‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œéœ€è¦ä½¿ç”¨ä¸“é—¨çš„å®ã€‚æ ¹æ®å‚æ•°ä¸åŒé€‰ç”¨ä¸åŒçš„å®ï¼Œè¿™ä¸ªå®çš„ç»†èŠ‚æˆ‘ä»¬æ— é¡»å…³æ³¨ã€‚å¯¹äºæˆ‘ä»¬è¿™ä¸ªæ— å‚æ•°çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œåº”è¯¥ä½¿ç”¨SYSCALL_DEFINE0å®æ¥å®šä¹‰ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//linux-5.10.13/include/linux/syscalls.h\n#ifndef SYSCALL_DEFINE0\n#define SYSCALL_DEFINE0(sname)                  \\\n    SYSCALL_METADATA(_##sname, 0);              \\\n    asmlinkage long sys_##sname(void);          \\\n    ALLOW_ERROR_INJECTION(sys_##sname, ERRNO);      \\\n    asmlinkage long sys_##sname(void)\n#endif /* SYSCALL_DEFINE0 */\n//linux-5.10.13/kernel/sys.c\nSYSCALL_DEFINE0(get_cpus)\n{\n    return num_present_cpus();//è·å–ç³»ç»Ÿä¸­æœ‰å¤šå°‘CPU\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­SYSCALL_DEFINE0ä¼šå°†get_cpusè½¬æ¢æˆsys_get_cpuså‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†ä¸€ä¸ªLinuxå†…æ ¸ä¸­å¦ä¸€ä¸ªå‡½æ•°num_present_cpusï¼Œä»åå­—å°±èƒ½æ¨æ–­å‡ºä½œç”¨äº†ï¼Œå®ƒè´Ÿè´£è¿”å›ç³»ç»ŸCPUçš„æ•°é‡ã€‚ è¿™æ­£æ˜¯æˆ‘ä»¬è¦è¾¾åˆ°çš„ç»“æœã€‚è¿™ä¸ªç»“æœæœ€ç»ˆä¼šè¿”å›ç»™è°ƒç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„åº”ç”¨ç¨‹åºã€‚</p><h3>ç¼–è¯‘Linuxå†…æ ¸</h3><p>ç°åœ¨æˆ‘ä»¬çš„Linuxç³»ç»Ÿè°ƒç”¨çš„ä»£ç ï¼Œå·²ç»å†™å¥½äº†ï¼Œä¸è¿‡è¿™è·Ÿç¼–å†™å†…æ ¸æ¨¡å—è¿˜æ˜¯ä¸ä¸€æ ·çš„ã€‚ç¼–å†™å†…æ ¸æ¨¡å—ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå†…æ ¸æ¨¡å—åŠ¨æ€åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚ç³»ç»Ÿè°ƒç”¨å‘ç”Ÿåœ¨å†…æ ¸ä¸­ï¼Œä¸å†…æ ¸æ˜¯ä¸€ä½“çš„ï¼Œå®ƒæ— æ³•ç‹¬ç«‹æˆä¸ºå¯ä»¥åŠ è½½çš„å†…æ ¸æ¨¡å—ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œç„¶åä½¿ç”¨æˆ‘ä»¬æ–°ç¼–è¯‘çš„å†…æ ¸ã€‚</p><p>è¦ç¼–è¯‘å†…æ ¸é¦–å…ˆæ˜¯è¦é…ç½®å†…æ ¸ï¼Œå†…æ ¸çš„é…ç½®æ“ä½œéå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æºä»£ç ç›®å½•ä¸‹æ‰§è¡Œâ€œmake menuconfigâ€æŒ‡ä»¤ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹æ‰€ç¤ºçš„ç•Œé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/66/96/66597887b59b30d73ff300249e47e296.jpg?wh=836x679\" alt=\"\" title=\" é…ç½®Linux\"></p><p>å›¾ä¸­è¿™äº›èœå•éƒ½å¯ä»¥è¿›å…¥å­èœå•æˆ–è€…æ‰‹åŠ¨é€‰æ‹©ã€‚</p><p>ä½†æ˜¯æ‰‹åŠ¨é€‰æ‹©é…ç½®é¡¹éå¸¸éº»çƒ¦ä¸”å±é™©ï¼Œ<strong>å¦‚æœä¸æ˜¯èµ„æ·±çš„å†…æ ¸ç©å®¶ï¼Œä¸å»ºè®®æ‰‹åŠ¨é…ç½®ï¼</strong>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€‰æ‹©åŠ è½½ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥åŠ è½½ä½ æœºå™¨ä¸Šbootç›®å½•ä¸‹çš„configå¼€å¤´çš„æ–‡ä»¶ï¼ŒåŠ è½½ä¹‹åé€‰æ‹©Saveï¼Œå°±èƒ½ä¿å­˜é…ç½®å¹¶é€€å‡ºä»¥ä¸Šç•Œé¢ã€‚</p><p>ç„¶åè¾“å…¥å¦‚ä¸‹æŒ‡ä»¤ï¼Œå°±å¯ä»¥å–ç‚¹èŒ¶ã€å¬å¬éŸ³ä¹ï¼Œç­‰å¾…æœºå™¨è‡ªè¡Œå®Œæˆç¼–è¯‘ï¼Œç¼–è¯‘çš„æ—¶é—´å–å†³äºæœºå™¨çš„æ€§èƒ½ï¼Œå¿«åˆ™åå‡ åˆ†é’Ÿï¼Œæ…¢åˆ™å‡ ä¸ªå°æ—¶ã€‚</p><pre><code>make -j8 bzImage &amp;&amp; make -j8 modules\n</code></pre><p>ä¸Šè¿°ä»£ç æŒ‡ä»¤å¹²äº†å“ªäº›äº‹å„¿å‘¢ï¼Ÿæˆ‘æ¥è¯´ä¸€è¯´ï¼Œé¦–å…ˆè¦ç¼–è¯‘å†…æ ¸ï¼Œç„¶åå†ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼Œj8è¡¨ç¤ºå¼€å¯8çº¿ç¨‹å¹¶è¡Œç¼–è¯‘ï¼Œè¿™ä¸ªä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æœºå™¨CPUæ ¸å¿ƒæ•°é‡è¿›è¡Œè°ƒæ•´ã€‚</p><p>ç¼–è¯‘è¿‡ç¨‹ç»“æŸä¹‹åå°±å¯ä»¥å¼€å§‹å®‰è£…æ–°å†…æ ¸äº†ï¼Œä½ åªéœ€è¦åœ¨æºä»£ç ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ã€‚</p><pre><code>sudo make modules_install &amp;&amp; sudo make install\n</code></pre><p>ä¸Šè¿°ä»£ç æŒ‡ä»¤å…ˆå®‰è£…å¥½å†…æ ¸æ¨¡å—ï¼Œç„¶åå†å®‰è£…å†…æ ¸ï¼Œæœ€åä¼šè°ƒç”¨update-grubï¼Œè‡ªåŠ¨ç”Ÿæˆå¯åŠ¨é€‰é¡¹ï¼Œé‡å¯è®¡ç®—æœºå°±å¯ä»¥é€‰æ‹©å¯åŠ¨æˆ‘ä»¬è‡ªå·±ä¿®æ”¹çš„Linuxå†…æ ¸äº†ã€‚</p><h3>ç¼–å†™åº”ç”¨æµ‹è¯•</h3><p>ç›¸ä¿¡ç»è¿‡ä¸Šè¿°è¿‡ç¨‹ï¼Œä½ åº”è¯¥å·²ç»æˆåŠŸå¯åŠ¨äº†ä¿®æ”¹è¿‡çš„æ–°å†…æ ¸ã€‚ä¸è¿‡æˆ‘ä»¬è¿˜ä¸ç¡®å®šæˆ‘ä»¬å¢åŠ çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ä¸æ˜¯æ­£å¸¸çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦å†™ä¸ªåº”ç”¨ç¨‹åºæµ‹è¯•ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯å»è°ƒç”¨ä¸€ä¸‹æˆ‘ä»¬å¢åŠ çš„ç³»ç»Ÿè°ƒç”¨ï¼Œçœ‹çœ‹ç»“æœæ˜¯ä¸æ˜¯é¢„æœŸçš„ã€‚</p><p>æˆ‘ä»¬åº”ç”¨ç¨‹åºä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#include &lt;stdio.h&gt;\n#include &lt;unistd.h&gt;\n#include &lt;sys/syscall.h&gt;\nint main(int argc, char const *argv[])\n{\n    //syscallå°±æ˜¯æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·è°ƒç”¨ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨\n    long cpus = syscall(441);\n    printf(&quot;cpu num is:%d\\n&quot;, cpus);//è¾“å‡ºç»“æœ\n    return 0;\n}\n</code></pre><p>å¯¹ä¸Šè¿°ä»£ç æˆ‘ä»¬ä½¿ç”¨gcc main.c -o cpusæŒ‡ä»¤è¿›è¡Œç¼–è¯‘ï¼Œè¿è¡Œä¹‹åå°±å¯ä»¥çœ‹åˆ°ç»“æœäº†ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰å†™åº“ä»£ç ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨syscallå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·è§¦å‘ç³»ç»Ÿè°ƒç”¨ï¼Œæ ¹æ®ä¸Šé¢å®šä¹‰ï¼Œ441æ­£æ˜¯å¯¹åº”å’±ä»¬çš„sys_get_cpusç³»ç»Ÿè°ƒç”¨ã€‚</p><p>è‡³æ­¤ï¼Œåœ¨Linuxç³»ç»Ÿä¸Šå¢åŠ è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªå®éªŒï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©æˆ‘ä»¬ä»äº†è§£Linuxç³»ç»Ÿçš„APIæ¶æ„å¼€å§‹ï¼Œæœ€ååœ¨Linuxç³»ç»Ÿä¸Šå®ç°äº†ä¸€ä¸ªè‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè™½ç„¶å¢åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ­¥éª¤ä¸å°‘ï¼Œä½†ä½ åªè¦ç´§è·Ÿç€æˆ‘çš„æ€è·¯ä¸€å®šå¯ä»¥æ‹¿ä¸‹ã€‚</p><p>ä¸‹é¢æˆ‘æ¥ä¸ºä½ æ¢³ç†ä¸€ä¸‹è¯¾ç¨‹çš„é‡ç‚¹ã€‚</p><p>1.ä»Linuxç³»ç»Ÿçš„APIæ¶æ„å¼€å§‹ï¼Œæˆ‘ä»¬äº†è§£äº†glibcåº“ï¼Œè¿™ä¸ªåº“æ˜¯å¤§éƒ¨åˆ†åº”ç”¨ç¨‹åºçš„åŸºç¡€ï¼Œæˆ‘ä»¬ä»¥å…¶ä¸­çš„openå‡½æ•°ä¸ºä¾‹ï¼Œåˆ†æäº†åº“å‡½æ•°å¦‚ä½•é€šè¿‡å¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼Œæœ€åæ‰§è¡ŒsyscallæŒ‡ä»¤è¿›å…¥Linuxå†…æ ¸ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæœ€åè¿˜å½’çº³å‡ºä¸€å¹…Linuxç³»ç»ŸAPIæ¡†æ¶å›¾ã€‚</p><p>2.ç„¶å,æˆ‘ä»¬äº†è§£Linuxç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ªAPIï¼Œå®ƒä»¬éƒ½æ”¾åœ¨ç³»ç»Ÿè°ƒç”¨è¡¨ä¸­ï¼ŒåŒæ—¶ä¹ŸçŸ¥é“äº†Linuxç³»ç»Ÿè°ƒç”¨è¡¨çš„ç”Ÿæˆæ–¹å¼ã€‚</p><p>3.æœ€åï¼Œä¸ºäº†éªŒè¯æˆ‘ä»¬äº†è§£çš„çŸ¥è¯†æ˜¯å¦æ­£ç¡®ï¼Œæˆ‘ä»¬ä»ç”³æ˜ç³»ç»Ÿè°ƒç”¨ã€å®šä¹‰ç³»ç»Ÿè°ƒç”¨åˆ°ç¼–è¯‘å†…æ ¸ã€ç¼–å†™åº”ç”¨æµ‹è¯•ï¼Œåœ¨ç°æœ‰çš„Linuxä»£ç ä¸­å¢åŠ äº†ä¸€ä¸ªå±äºæˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>å¥½äº†ï¼Œæˆ‘ä»¬é€šè¿‡è¿™èŠ‚è¯¾ææ¸…æ¥šäº†Linuxå†…æ ¸ç³»ç»Ÿè°ƒç”¨çš„å®ç°åŸç†ã€‚ä½ æ˜¯å¦æ„Ÿè§‰è¿™å’Œæˆ‘ä»¬çš„Cosmosçš„ç³»ç»ŸæœåŠ¡æœ‰äº›ç›¸ä¼¼ï¼Œåˆæœ‰äº›ä¸åŒï¼Ÿ</p><p>ç›¸ä¼¼çš„æ˜¯æˆ‘ä»¬éƒ½ä½¿ç”¨å¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°ï¼Œä¸åŒçš„æ˜¯Cosmosä½¿ç”¨äº†ä¸­æ–­é—¨è¿›å…¥å†…æ ¸ï¼Œè€ŒLinuxå†…æ ¸ä½¿ç”¨äº†æ›´æ–°çš„syscallæŒ‡ä»¤ã€‚æœ‰äº†è¿™äº›çŸ¥è¯†å‚¨å¤‡ï¼Œæˆ‘ä¹Ÿéå¸¸æœŸå¾…ä½ èƒ½åŠ¨æ‰‹æ‹“å±•ï¼ŒæŒ‘æˆ˜ä¸€ä¸‹åœ¨Cosmosä¸Šå®ç°ä½¿ç”¨syscallè§¦å‘ç³»ç»Ÿè°ƒç”¨ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·è¯´è¯´syscallæŒ‡ä»¤å’ŒintæŒ‡ä»¤çš„åŒºåˆ«ï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµäº’åŠ¨ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ï¼Œä¸€èµ·å®ç°æ“ä½œç³»ç»Ÿé‡Œçš„å„ç§åŠŸèƒ½ã€‚</p><p>æˆ‘æ˜¯LMOSï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"41 | æœåŠ¡æ¥å£ï¼šå¦‚ä½•æ­å»ºæ²Ÿé€šæ¡¥æ¢ï¼Ÿ","id":406633},"right":{"article_title":"43 | è™šæ‹Ÿæœºå†…æ ¸ï¼šKVMæ˜¯ä»€ä¹ˆï¼Ÿ","id":408124}},"comments":[{"had_liked":false,"id":307541,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":true,"comment_ctime":1629136286,"is_pvip":false,"replies":[{"id":"111353","content":"66666å¤§ä½¬ å¤§ä½¬","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1629190708,"ip_address":"","comment_id":307541,"utype":1}],"discussion_count":1,"race_medal":0,"score":"9.2233720728437002e+18","product_id":100078401,"comment_content":"ä¸‰ã€Demoéƒ¨åˆ†<br>1ã€æ–°å»ºä¸€ä¸ªæºç ç¼–è¯‘ç›®å½•<br>mkdir kernelbuild<br><br>2ã€ä¸‹è½½æºç ï¼Œè§£å‹<br>wget https:&#47;&#47;mirrors.edge.kernel.org&#47;pub&#47;linux&#47;kernel&#47;v5.x&#47;linux-5.10.59.tar.gz   <br><br>tar -xzf linux-5.10.59.tar.gz   <br><br>cd linux-5.10.59<br><br>3ã€æ¸…ç†<br>make mrproper<br><br>4ã€ä¿®æ”¹æ–‡ä»¶<br>4.1ã€arch&#47;x86&#47;entry&#47;syscalls&#47;syscall_64.tbl<br>#åœ¨440åé¢å¢åŠ ä¸€è¡Œ<br>441  common  get_cpus    sys_get_cpus<br><br>4.2ã€include&#47;linux&#47;syscalls.h<br>#åœ¨æœ€åä¸€ä¸ªasmlinkageå¢åŠ ä¸€è¡Œ<br>asmlinkage long sys_get_cpus(void);<br><br>4.3ã€kernel&#47;sys.c  <br>#åœ¨æœ€åä¸€ä¸ªSYSCALL_DEFINE0åé¢å¢åŠ ä¸‹é¢å‡ è¡Œ<br>&#47;&#47;è·å–ç³»ç»Ÿä¸­æœ‰å¤šå°‘CPU<br>SYSCALL_DEFINE0(get_cpus)<br>{<br>    return num_present_cpus();<br>}<br><br>5ã€å†…æ ¸é…ç½®<br>make menuconfig<br>make oldconfig<br><br>6ã€ä¿®æ”¹.configï¼Œå»æ‰ä¸€ä¸ªè¯ä¹¦<br>CONFIG_SYSTEM_TRUSTED_KEYS=â€œâ€<br><br>7ã€ç¼–è¯‘<br>make -j4<br><br>8ã€å®‰è£…<br>sudo make modules_install<br>sudo make install<br><br>9ã€æµ‹è¯•<br>#include &lt;stdio.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;sys&#47;syscall.h&gt;<br>int main(int argc, char const *argv[])<br>{<br>    &#47;&#47;syscallå°±æ˜¯æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·è°ƒç”¨ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨<br>    long cpus = syscall(441);<br>    printf(&quot;cpu num is:%d\\n&quot;, cpus);&#47;&#47;è¾“å‡ºç»“æœ<br>    return 0;<br>}<br><br>gcc  cpus.c -o cpus<br><br>.&#47;cpus<br>åœ¨æ²¡æœ‰ä¿®æ”¹çš„å†…æ ¸ä¸Šè¿”å›æ˜¯-1<br>åœ¨ä¿®æ”¹è¿‡çš„ä¸ºnum_present_cpusæ•°é‡ï¼Œæˆ‘çš„è™šæ‹Ÿæœºè¿”å›çš„æ˜¯1","like_count":9,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525192,"discussion_content":"66666å¤§ä½¬ å¤§ä½¬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629190708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307540,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":false,"comment_ctime":1629136170,"is_pvip":false,"replies":[{"id":"111354","content":"æ˜¯çš„ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1629190751,"ip_address":"","comment_id":307540,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14514038058","product_id":100078401,"comment_content":"äºŒã€linuxå†…æ ¸éƒ¨åˆ†ã€ä¸‹ã€‘<br>2ã€å½“äº§ç”Ÿç³»ç»Ÿè°ƒç”¨æ—¶<br>2.1ã€åº”ç”¨ç›´æ¥syscallæˆ–é€šè¿‡glibcäº§ç”Ÿäº†syscall<br><br>2.2ã€cpuä¼šäº§ç”Ÿç±»ä¼¼äºä¸­æ–­çš„æ•ˆæœï¼Œå¼€å§‹åˆ°entry_SYSCALL_64æ‰§è¡Œ<br>&#47;&#47;æ–‡ä»¶è·¯å¾„arch&#47;x86&#47;entry&#47;entry_64.S<br>SYM_CODE_START(entry_SYSCALL_64)<br>&#47;&#47;çœç•¥ä»£ç <br>call   do_syscall_64<br>SYM_CODE_END(entry_SYSCALL_64)<br><br>&#47;&#47;æ–‡ä»¶è·¯å¾„arch&#47;x86&#47;entry&#47;entry_64.S<br>SYM_CODE_START(entry_SYSCALL_compat)<br>call   do_fast_syscall_32<br>SYM_CODE_END(entry_SYSCALL_compat)<br><br>2.3ã€è°ƒç”¨do_syscall_64<br>#ifdef CONFIG_X86_64<br>__visible noinstr void do_syscall_64(unsigned long nr, struct pt_regs *regs)<br>{<br>    nr = syscall_enter_from_user_mode(regs, nr);<br>    instrumentation_begin();<br>    if (likely(nr &lt; NR_syscalls)) {<br>        nr = array_index_nospec(nr, NR_syscalls);<br>        regs-&gt;ax = sys_call_table[nr](regs);<br>    }<br>    instrumentation_end();<br>    syscall_exit_to_user_mode(regs);<br>}<br>#endif<br><br>2.4ã€æ ¹æ®sys_call_tableè°ƒç”¨å¯¹åº”çš„åŠŸèƒ½å‡½æ•°<br>sys_call_table[nr](regs)<br>å¦‚æœæˆ‘ä»¬ä¼ å…¥257ï¼Œå°±ä¼šè°ƒç”¨__x64_sys_openat<br>å¦‚æœæˆ‘ä»¬ä¼ å…¥441ï¼Œå°±ä¼šè°ƒç”¨__x64_sys_get_cpus<br><br>2.5ã€ä½†å’±ä»¬å®é™…å†™çš„å‡½æ•°sys_get_cpusï¼Œå¥½åƒå’Œå®é™…è°ƒç”¨å‡½æ•°__x64_sys_get_cpusï¼Œå·®äº†ä¸€ä¸ª__x64ï¼Œè¿™éœ€è¦ä¸€ä¸ªwrapper<br>arch\\x86\\include\\asm\\syscall_wrapper.h<br>#define SYSCALL_DEFINE0(sname)                      \\<br>    SYSCALL_METADATA(_##sname, 0);                  \\<br>    static long __do_sys_##sname(const struct pt_regs *__unused);   \\<br>    __X64_SYS_STUB0(sname)                      \\<br>    __IA32_SYS_STUB0(sname)                     \\<br>    static long __do_sys_##sname(const struct pt_regs *__unused)<br><br>#define __X64_SYS_STUB0(name)                       \\<br>    __SYS_STUB0(x64, sys_##name)<br><br>#define __SYS_STUB0(abi, name)                      \\<br>    long __##abi##_##name(const struct pt_regs *regs);      \\<br>    ALLOW_ERROR_INJECTION(__##abi##_##name, ERRNO);         \\<br>    long __##abi##_##name(const struct pt_regs *regs)       \\<br>        __alias(__do_##name);<br><br>SYSCALL_DEFINE0(get_cpus)ï¼Œä¼šå±•å¼€æˆä¸º<br>__X64_SYS_STUB0(get_cpus) <br>ç„¶å<br> __SYS_STUB0(x64, sys_get_cpus)<br>ç„¶å<br>long __x64_sys_get_cpus(const struct pt_regs *regs);<br><br>è¿™æ ·å‰åå°±å¯¹ä¸Šäº†ï¼Œglibcå’Œlinuxå†…æ ¸å°±é€šäº†ã€‚","like_count":4,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525191,"discussion_content":"æ˜¯çš„ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629190751,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307539,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":false,"comment_ctime":1629136152,"is_pvip":false,"replies":[{"id":"111355","content":"æ˜¯çš„ å®Œå…¨æ­£ç¡®","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1629190801,"ip_address":"","comment_id":307539,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10219070744","product_id":100078401,"comment_content":"äºŒã€linuxå†…æ ¸éƒ¨åˆ†ã€ä¸Šã€‘<br>1ã€åœ¨makeæ—¶ï¼Œä¼šé€šè¿‡syscall_64.tblç”Ÿæˆsyscalls_64.hï¼Œç„¶ååŒ…å«åˆ°syscall_64.cï¼Œè¿›è¡Œè°ƒç”¨å·ä¸å‡½æ•°ä¹‹é—´çš„ç»‘å®šã€‚<br>arch&#47;x86&#47;entry&#47;syscalls&#47;syscall_64.tbl<br>arch&#47;x86&#47;include&#47;generated&#47;asm&#47;syscalls_64.h<br>arch&#47;x86&#47;entry&#47;syscall_64.c<br><br>1.1ã€ä»¥sys_openatä¸ºä¾‹ï¼Œåœ¨syscall_64.tblä¸­ä¸º<br>257    common    openat            sys_openat<br>441    common    get_cpus          sys_get_cpus<br><br>1.2ã€makeåï¼Œåœ¨ç”Ÿæˆçš„syscalls_64.hä¸­ä¸º<br>__SYSCALL_COMMON(257, sys_openat)<br><br>1.3 åœ¨syscall_64.cä¸­ï¼Œå±•å¼€__SYSCALL_COMMON<br>#define __SYSCALL_COMMON(nr, sym) __SYSCALL_64(nr, sym)<br>å±•å¼€å°±æ˜¯<br>__SYSCALL_64(257, sys_openat)<br><br>1.4ã€åœ¨syscall_64.cä¸­ï¼Œç¬¬ä¸€æ¬¡å±•å¼€__SYSCALL_64<br>#define __SYSCALL_64(nr, sym) extern long __x64_##sym(const struct pt_regs *);<br>#include &lt;asm&#47;syscalls_64.h&gt;<br>#undef __SYSCALL_64<br>å±•å¼€å°±æ˜¯<br>extern long __x64_sys_openat(const struct pt_regs *);<br>ä¹Ÿå°±æ˜¯æ¯ä¸ª__SYSCALL_64éƒ½å±•å¼€æˆäº†ä¸€ä¸ªå¤–éƒ¨å‡½æ•°<br><br>1.5ã€åœ¨syscall_64.cä¸­ï¼Œç¬¬äºŒæ¬¡å±•å¼€__SYSCALL_64<br>#define __SYSCALL_64(nr, sym) [nr] = __x64_##sym,<br><br>asmlinkage const sys_call_ptr_t sys_call_table[__NR_syscall_max+1] = {<br>    [0 ... __NR_syscall_max] = &amp;__x64_sys_ni_syscall,<br>#include &lt;asm&#47;syscalls_64.h&gt;<br>};<br><br>å±•å¼€å…¶å®å°±æ˜¯æŒ‡å‘äº†å¤–éƒ¨å‡½æ•°<br>[257]=__x64_sys_openat,<br><br>å…¨éƒ¨å±•å¼€ç»“æœï¼Œéƒ½ä¼šè¢«åŒ…å«åˆ°sys_call_tableä¸­ï¼Œä»è€Œå®Œæˆäº†è°ƒç”¨å·ä¸å‡½æ•°ä¹‹é—´çš„ç»‘å®šã€‚","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525190,"discussion_content":"æ˜¯çš„ å®Œå…¨æ­£ç¡®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629190801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307538,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":false,"comment_ctime":1629136103,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10219070695","product_id":100078401,"comment_content":"ä¸€ã€glibcéƒ¨åˆ†ã€ä¸‹ã€‘<br>4.7ã€å±•å¼€INLINE_SYSCALL<br>&#47;&#47;glibc&#47;sysdeps&#47;unix&#47;sysv&#47;linux&#47;sysdep.h<br>#define INLINE_SYSCALL(name, nr, args...)       \\<br>  ({                  \\<br>    long int sc_ret = INTERNAL_SYSCALL (name, nr, args);    \\<br>    __glibc_unlikely (INTERNAL_SYSCALL_ERROR_P (sc_ret))    \\<br>    ? SYSCALL_ERROR_LABEL (INTERNAL_SYSCALL_ERRNO (sc_ret))   \\<br>    : sc_ret;               \\<br>  })<br><br>å±•å¼€å¾—åˆ°<br>INTERNAL_SYSCALL (openat, 4, argsã€AT_FDCWD, file, oflag, modeã€‘);  <br><br>4.8ã€å±•å¼€INTERNAL_SYSCALL<br>#define INTERNAL_SYSCALL(name, nr, args...)       \\<br>  internal_syscall##nr (SYS_ify (name), args)<br><br>å±•å¼€å¾—åˆ°<br>internal_syscall4(SYS_ify(openat), argsã€AT_FDCWD, file, oflag, modeã€‘)<br><br>å±•å¼€ SYS_ify(openat)<br>#define SYS_ify(syscall_name) __NR_##syscall_name<br>å¾—åˆ°<br>__NR_openat<br><br>ä»è€Œå¾—åˆ°<br>internal_syscall4(__NR_openat, argsã€AT_FDCWD, file, oflag, modeã€‘)<br><br>4.9ã€æœ€åinternal_syscall4ä¸­ï¼Œæ±‡ç¼–è°ƒç”¨äº†syscall<br><br>glibc\\sysdeps\\unix\\sysv\\linux\\x86_64\\64\\arch-syscall.h<br>#define __NR_openat 257<br><br>syscallæ—¶ï¼Œå…ˆä¼ å…¥è°ƒç”¨å·257ï¼Œç„¶åæ˜¯å››ä¸ªä½çœŸæ­£çš„å‚æ•°ã€‚","like_count":2},{"had_liked":false,"id":307537,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":false,"comment_ctime":1629136089,"is_pvip":false,"replies":[{"id":"111357","content":"å¯¹çš„ å°±æ˜¯è¿™æ ·","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1629191244,"ip_address":"","comment_id":307537,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10219070681","product_id":100078401,"comment_content":"ä¸€ã€glibcéƒ¨åˆ†ã€ä¸Šã€‘<br>1ã€åº”ç”¨ç¨‹åºè°ƒç”¨openå‡½æ•°<br>&#47;&#47;glibc&#47;intl&#47;loadmsgcat.c<br># define open(name, flags)  __open_nocancel (name, flags)<br><br>2ã€å±•å¼€åå®é™…ä¸Šè°ƒç”¨äº†<br>__open_nocancel(name, flags)<br><br>3ã€è€Œ__open_nocancel æœ€ç»ˆè°ƒç”¨äº†INLINE_SYSCALL_CALL<br>&#47;&#47;glibc&#47;sysdeps&#47;unix&#47;sysv&#47;linux&#47;open_nocancel.c<br>__open_nocancel(name, flags)<br>-&gt;return INLINE_SYSCALL_CALL (openat, AT_FDCWD, file, oflag, mode);<br><br>4ã€å®å±•å¼€ã€ç†è§£å°±å¥½ï¼Œä¸ä¿è¯é¡ºåºã€‘<br>4.1ã€åˆå§‹ä¸º<br>INLINE_SYSCALL_CALL (openat, AT_FDCWD, file, oflag, mode);<br><br>4.2ã€ç¬¬1æ¬¡å±•å¼€INLINE_SYSCALL_CALL<br>#define INLINE_SYSCALL_CALL(...) \\<br>  __INLINE_SYSCALL_DISP (__INLINE_SYSCALL, __VA_ARGS__)<br><br>å±•å¼€å¾—åˆ°ï¼š<br>__INLINE_SYSCALL_DISP(__INLINE_SYSCALL, __VA_ARGS__ã€openat, AT_FDCWD, file, oflag, modeã€‘)<br><br>4.3ã€ç¬¬2æ¬¡å±•å¼€__INLINE_SYSCALL_DISP<br>#define __INLINE_SYSCALL_DISP(b,...) \\<br>  __SYSCALL_CONCAT (b,__INLINE_SYSCALL_NARGS(__VA_ARGS__))(__VA_ARGS__)<br><br>å±•å¼€å¾—åˆ°ï¼š<br>__SYSCALL_CONCAT(bã€__INLINE_SYSCALLã€‘,__INLINE_SYSCALL_NARGS(__VA_ARGS__ã€openat, AT_FDCWD, file, oflag, modeã€‘))(__VA_ARGS__ã€openat, AT_FDCWD, file, oflag, modeã€‘)<br><br>4.4ã€ç¬¬3æ¬¡å±•å¼€__INLINE_SYSCALL_NARGS<br>__INLINE_SYSCALL_NARGS(__VA_ARGS__ã€openat, AT_FDCWD, file, oflag, modeã€‘)<br><br>#define __INLINE_SYSCALL_NARGS(...) \\<br>  __INLINE_SYSCALL_NARGS_X (__VA_ARGS__,7,6,5,4,3,2,1,0,)<br><br>å±•å¼€å¾—åˆ°ï¼š<br>__INLINE_SYSCALL_NARGS_X(openat, AT_FDCWD, file, oflag, mode,7,6,5,4,3,2,1,0,)<br><br>ç„¶åå±•å¼€__INLINE_SYSCALL_NARGS_X<br>#define __INLINE_SYSCALL_NARGS_X(a,b,c,d,e,f,g,h,n,...) n<br><br>å±•å¼€å¾—åˆ°å‚æ•°ä¸ªæ•°ï¼š4<br><br>ä»è€Œ4.4çš„ç»“æœä¸º<br>__SYSCALL_CONCAT(__INLINE_SYSCALL,4)(__VA_ARGS__ã€openat, AT_FDCWD, file, oflag, modeã€‘)<br><br>4.5ã€ç„¶åå±•å¼€__SYSCALL_CONCATï¼Œå…¶å®å°±æ˜¯å­—ç¬¦æ‹¼æ¥<br>__SYSCALL_CONCAT(__INLINE_SYSCALL,4)<br><br>#define __SYSCALL_CONCAT_X(a,b)     a##b<br>#define __SYSCALL_CONCAT(a,b)       __SYSCALL_CONCAT_X (a, b)<br><br>å±•å¼€å¾—åˆ°ï¼š<br>__INLINE_SYSCALL4<br><br>ä»è€Œ4.5çš„ç»“æœä¸º<br>__INLINE_SYSCALL4(openat, AT_FDCWD, file, oflag, mode)<br><br>4.6ã€ç„¶åå±•å¼€INTERNAL_SYSCALL4<br>#define __INLINE_SYSCALL4(name, a1, a2, a3, a4) \\<br>  INLINE_SYSCALL (name, 4, a1, a2, a3, a4)<br><br>å±•å¼€å¾—åˆ°ï¼š<br>INLINE_SYSCALL(openat, 4, AT_FDCWD, file, oflag, mode)","like_count":3,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525189,"discussion_content":"å¯¹çš„ å°±æ˜¯è¿™æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629191244,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307224,"user_name":"cugphoenix","can_delete":false,"product_type":"c1","uid":1474356,"ip_address":"","ucode":"80101AF04C00D3","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI3F4IdQuDZrhN8ThibP85eCiaSWTYpTrcC6QB9EoAkw3IIj6otMibb1CgrS1uzITAnJmGLXQ2tgIkAQ/132","comment_is_top":false,"comment_ctime":1628948452,"is_pvip":false,"replies":[{"id":"111257","content":"æ˜¯çš„ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628996303,"ip_address":"","comment_id":307224,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10218883044","product_id":100078401,"comment_content":"çœ‹äº†Linux ç³»ç»Ÿè°ƒç”¨è¡¨çš„ç”Ÿæˆæ–¹å¼ï¼Œåˆåˆ·æ–°äº†å¯¹å®å®šä¹‰çš„è®¤çŸ¥ï¼Œçµæ´»æ€§æå¼ºï¼Œç”¨èµ·æ¥å¯å¤ªèŠ±å“¨äº†","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525084,"discussion_content":"æ˜¯çš„ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628996303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307001,"user_name":"Zhendicai","can_delete":false,"product_type":"c1","uid":2536364,"ip_address":"","ucode":"6E1A8AE4C33CBE","user_header":"https://static001.geekbang.org/account/avatar/00/26/b3/ac/2c8baa5e.jpg","comment_is_top":false,"comment_ctime":1628822039,"is_pvip":false,"replies":[{"id":"111193","content":"æ˜¯çš„æ­£ç¡®","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628847618,"ip_address":"","comment_id":307001,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5923789335","product_id":100078401,"comment_content":"intæŒ‡ä»¤å’ŒsyscallæŒ‡ä»¤éƒ½ä¼šå‘ç”Ÿç‰¹æƒçº§åˆ‡æ¢å§ï¼Œä½†æ˜¯syscallèƒ½ç›´æ¥è°ƒå®šä½åˆ°å…·ä½“ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œintåˆ™éœ€è¦ç»è¿‡ä¸­æ–­é—¨æè¿°ç¬¦è¡¨å’Œåˆ†å‘å™¨æ‰è¡Œã€‚intçš„æ­¥éª¤è¦å¤šä¸€äº›ï¼Œé‚£å°±æ˜¯å–æŒ‡ä»¤æ¬¡æ•°è¦å¤šä¸€äº›ï¼Ÿè¿˜æœ‰ä¸ªé—®é¢˜ä½¿ç”¨intæ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ˜¯ä¸æ˜¯ä¹Ÿä¼šé‡åˆ°ä¸­æ–­ä¼˜å…ˆçº§çš„é—®é¢˜ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525012,"discussion_content":"æ˜¯çš„æ­£ç¡®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628847618,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306974,"user_name":"å‡‰äººã€‚","can_delete":false,"product_type":"c1","uid":1659177,"ip_address":"","ucode":"4DB16004A62015","user_header":"https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg","comment_is_top":false,"comment_ctime":1628816914,"is_pvip":false,"replies":[{"id":"111152","content":"æ˜¯çš„ æ­£ç¡®","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628823930,"ip_address":"","comment_id":306974,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5923784210","product_id":100078401,"comment_content":"æ¬äº†ä¸‹ç­”æ¡ˆ<br>1.syscall<br>syscallæ˜¯x64çš„ç³»ç»Ÿè°ƒç”¨ã€‚å…¶è°ƒç”¨å·é€šè¿‡raxè¿›è¡Œä¼ é€’ã€‚æŸ¥çœ‹å…·ä½“çš„è°ƒç”¨å·ï¼Œlinuxç¯å¢ƒä¸‹åœ¨unistd.hä¸­å®šä¹‰ã€‚å¦‚æœæ˜¯64ä½ï¼Œåˆ™å¯ä»¥æŸ¥çœ‹&#47;usr&#47;include&#47;asm&#47;unistd_64.hï¼Œå¦‚æœæ˜¯32ä½ï¼Œåˆ™æŸ¥çœ‹&#47;usr&#47;include&#47;unistd_32.hã€‚<br><br>å‚æ•°ä¼ é€’ï¼šå¤„äºç”¨æˆ·æ€æ—¶ï¼Œå‚æ•°ä¼ é€’é¡ºåºä¸ºï¼šrdiï¼Œrsiï¼Œrdxï¼Œrcxï¼Œr8ï¼Œr9ï¼Œå¤„äºå†…æ ¸æ€æ—¶ï¼Œå‚æ•°ä¼ é€’é¡ºåºï¼šrdiï¼Œrsiï¼Œrdxï¼Œr10ï¼Œr8ï¼Œr9ï¼ˆè¡¥å……ï¼šè¿™æ˜¯çœ‹åˆ«äººæ–‡ç« æ˜¯è¿™ä¹ˆå†™çš„ï¼Œä½†æ˜¯æˆ‘åœ¨å®é™…æ“ä½œä¸­å‘ç°ï¼Œæˆ‘è¿è¡Œç”¨æˆ·æ€æ±‡ç¼–ä»£ç ï¼Œé€šè¿‡rcxä¼ é€’å‚æ•°æ—¶å‡½æ•°è¿”å›é”™è¯¯ï¼Œç”¨idaæŸ¥çœ‹ï¼Œå‘ç°ç”¨æˆ·æ€çš„å€¼ä¼ é€’å…¶å®æ˜¯ï¼šrdiï¼Œrsiï¼Œrdxï¼Œr10ï¼Œr8ï¼Œr9ï¼ˆå’Œå‰é¢æåˆ°çš„å†…æ ¸æ€çš„ä¸€è‡´ï¼‰ï¼Œå†…æ ¸çš„å€¼ä¼ é€’æˆ‘æ²¡æœ‰è¿›è¡Œæµ‹è¯•ï¼Œæ¬¢è¿å„ä½å¤§ä½¬è¯„è®ºåŒºè¡¥å……ï¼‰<br><br>2.int 80h<br>int 80h æ˜¯32ä½x86çš„ç³»ç»Ÿè°ƒç”¨æ–¹å¼ã€‚åŒæ ·é€šè¿‡axä¼ é€’è°ƒç”¨å·ï¼Œå‚æ•°ä¼ é€’é¡ºåºæ˜¯ï¼šebxï¼Œecxï¼Œedxï¼Œesiï¼Œedi<br><br>*** note ***<br>intelä½“ç³»çš„ç³»ç»Ÿè°ƒç”¨é™åˆ¶æœ€å¤šå…­ä¸ªå‚æ•°ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªå‚æ•°æ˜¯é€šè¿‡æ ˆä¼ é€’çš„ã€‚ç³»ç»Ÿè°ƒç”¨çš„è¿”å›ç»“æœå­˜æ”¾åœ¨axå¯„å­˜å™¨ä¸­ï¼Œä¸”åªæœ‰æ•´å‹å’Œå†…å­˜å‹å¯ä»¥ä¼ é€’ç»™å†…æ ¸<br>","like_count":1,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524999,"discussion_content":"æ˜¯çš„ æ­£ç¡®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628823930,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339955,"user_name":"å´å»ºå¹³","can_delete":false,"product_type":"c1","uid":2618440,"ip_address":"","ucode":"C6E578FB8627A3","user_header":"https://static001.geekbang.org/account/avatar/00/27/f4/48/2242bed9.jpg","comment_is_top":false,"comment_ctime":1648485986,"is_pvip":false,"replies":[{"id":"124366","content":"è¦ç¼–è¯‘å†…æ ¸çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1345199","ctime":1648605978,"ip_address":"","comment_id":339955,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1648485986","product_id":100078401,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼Œæœ€åéªŒè¯çš„åº”ç”¨ä¾‹å­ï¼Œæ€ä¹ˆé“¾æ¥åˆ°ç³»ç»Ÿè°ƒç”¨çš„å‘¢ï¼Œæ²¡çœ‹åˆ°é“¾æ¥è¿‡ç¨‹ï¼Œé»˜è®¤é“¾æ¥glibcä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559084,"discussion_content":"è¦ç¼–è¯‘å†…æ ¸çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648605978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306971,"user_name":"ç½— ä¹¾ æ—","can_delete":false,"product_type":"c1","uid":1188222,"ip_address":"","ucode":"D0406F95176ABA","user_header":"https://static001.geekbang.org/account/avatar/00/12/21/7e/fb725950.jpg","comment_is_top":false,"comment_ctime":1628816207,"is_pvip":false,"replies":[{"id":"111153","content":"å¯¹çš„ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628823944,"ip_address":"","comment_id":306971,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1628816207","product_id":100078401,"comment_content":"å› ä¸ºè¿™é‡Œç”¨åˆ°çš„æŒ‡ä»¤æ˜¯æœ€æ–°å¤„ç†å™¨ä¸ºå…¶è®¾è®¡çš„ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ syscallã€‚è¿™ä¸ªæŒ‡ä»¤å’Œ int æŒ‡ä»¤ä¸€æ ·ï¼Œéƒ½å¯ä»¥è®© CPU è·³è½¬åˆ°ç‰¹å®šçš„åœ°å€ä¸Šï¼Œåªä¸è¿‡ä¸ç»è¿‡ä¸­æ–­é—¨ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶è¦ç”¨ sysexit æŒ‡ä»¤","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524998,"discussion_content":"å¯¹çš„ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628823944,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306959,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1628812830,"is_pvip":false,"replies":[{"id":"111155","content":"å“ˆå“ˆ è¿™æœ‰ç‚¹è´¹æ—¶  æ²¡ä»€ä¹ˆ éš¾åº¦ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628824094,"ip_address":"","comment_id":306959,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1628812830","product_id":100078401,"comment_content":"å®éªŒå¤ªé¡¶äº†ï¼Œæœ‰æ—¶é—´ä¸€å®šæä¸€ä¸‹ï¼Œä»Šå¤©é—®é¢˜å±äºçŸ¥è¯†ç›²åŒºï¼Œè´´ä¸Šé“¾æ¥ï¼šhttps:&#47;&#47;blog.csdn.net&#47;sdulibh&#47;article&#47;details&#47;50890250<br><br>ä¸å­¦ä¹ å°±å˜åºŸç‰©ğŸ˜‚","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524992,"discussion_content":"å“ˆå“ˆ è¿™æœ‰ç‚¹è´¹æ—¶  æ²¡ä»€ä¹ˆ éš¾åº¦ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628824094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306952,"user_name":"è‹æµéƒå®“","can_delete":false,"product_type":"c1","uid":2729645,"ip_address":"","ucode":"AD07BD9CE03047","user_header":"https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg","comment_is_top":false,"comment_ctime":1628786278,"is_pvip":false,"replies":[{"id":"111156","content":"ä¸æ˜¯","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1628824108,"ip_address":"","comment_id":306952,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1628786278","product_id":100078401,"comment_content":"syscallåº”è¯¥æ˜¯ç³»ç»Ÿä¸åº”ç”¨è½¯ä»¶çš„æ¥å£ï¼Ÿç±»ä¼¼winç³»ç»Ÿçš„æ¶ˆæ¯æ¨¡å—ï¼Ÿintæ˜¯æ“ä½œç³»ç»Ÿä¸ç¡¬ä»¶çš„æ¥å£ï¼Ÿå¦‚æ–°æ’å…¥usbé¼ æ ‡ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524989,"discussion_content":"ä¸æ˜¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628824108,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}