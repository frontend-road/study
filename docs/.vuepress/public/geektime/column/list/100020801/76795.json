{"id":76795,"title":"25 | MySQL是怎么保证高可用的？","content":"<p>在上一篇文章中，我和你介绍了binlog的基本内容，在一个主备关系中，每个备库接收主库的binlog并执行。</p><p>正常情况下，只要主库执行更新生成的所有binlog，都可以传到备库并被正确地执行，备库就能达到跟主库一致的状态，这就是最终一致性。</p><p>但是，MySQL要提供高可用能力，只有最终一致性是不够的。为什么这么说呢？今天我就着重和你分析一下。</p><p>这里，我再放一次上一篇文章中讲到的双M结构的主备切换流程图。</p><p><img src=\"https://static001.geekbang.org/resource/image/89/cc/89290bbcf454ff9a3dc5de42a85a69cc.png?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图 1 MySQL主备切换流程--双M结构</span></center><h1>主备延迟</h1><p>主备切换可能是一个主动运维动作，比如软件升级、主库所在机器按计划下线等，也可能是被动操作，比如主库所在机器掉电。</p><p>接下来，我们先一起看看主动切换的场景。</p><p>在介绍主动切换流程的详细步骤之前，我要先跟你说明一个概念，即“同步延迟”。与数据同步有关的时间点主要包括以下三个：</p><ol>\n<li>\n<p>主库A执行完成一个事务，写入binlog，我们把这个时刻记为T1;</p>\n</li>\n<li>\n<p>之后传给备库B，我们把备库B接收完这个binlog的时刻记为T2;</p>\n</li>\n<li>\n<p>备库B执行完成这个事务，我们把这个时刻记为T3。</p>\n</li>\n</ol><p>所谓主备延迟，就是同一个事务，在备库执行完成的时间和主库执行完成的时间之间的差值，也就是T3-T1。</p><p>你可以在备库上执行show slave status命令，它的返回结果里面会显示seconds_behind_master，用于表示当前备库延迟了多少秒。</p><!-- [[[read_end]]] --><p>seconds_behind_master的计算方法是这样的：</p><ol>\n<li>\n<p>每个事务的binlog 里面都有一个时间字段，用于记录主库上写入的时间；</p>\n</li>\n<li>\n<p>备库取出当前正在执行的事务的时间字段的值，计算它与当前系统时间的差值，得到seconds_behind_master。</p>\n</li>\n</ol><p>可以看到，其实seconds_behind_master这个参数计算的就是T3-T1。所以，我们可以用seconds_behind_master来作为主备延迟的值，这个值的时间精度是秒。</p><p>你可能会问，如果主备库机器的系统时间设置不一致，会不会导致主备延迟的值不准？</p><p>其实不会的。因为，备库连接到主库的时候，会通过执行SELECT UNIX_TIMESTAMP()函数来获得当前主库的系统时间。如果这时候发现主库的系统时间与自己不一致，备库在执行seconds_behind_master计算的时候会自动扣掉这个差值。</p><p>需要说明的是，在网络正常的时候，日志从主库传给备库所需的时间是很短的，即T2-T1的值是非常小的。也就是说，网络正常情况下，主备延迟的主要来源是备库接收完binlog和执行完这个事务之间的时间差。</p><p>所以说，主备延迟最直接的表现是，备库消费中转日志（relay log）的速度，比主库生产binlog的速度要慢。接下来，我就和你一起分析下，这可能是由哪些原因导致的。</p><h1>主备延迟的来源</h1><p><strong>首先，有些部署条件下，备库所在机器的性能要比主库所在的机器性能差。</strong></p><p>一般情况下，有人这么部署时的想法是，反正备库没有请求，所以可以用差一点儿的机器。或者，他们会把20个主库放在4台机器上，而把备库集中在一台机器上。</p><p>其实我们都知道，更新请求对IOPS的压力，在主库和备库上是无差别的。所以，做这种部署时，一般都会将备库设置为“非双1”的模式。</p><p>但实际上，更新过程中也会触发大量的读操作。所以，当备库主机上的多个备库都在争抢资源的时候，就可能会导致主备延迟了。</p><p>当然，这种部署现在比较少了。因为主备可能发生切换，备库随时可能变成主库，所以主备库选用相同规格的机器，并且做对称部署，是现在比较常见的情况。</p><p>追问1：但是，做了对称部署以后，还可能会有延迟。这是为什么呢？</p><p>这就是<strong>第二种常见的可能了，即备库的压力大</strong>。一般的想法是，主库既然提供了写能力，那么备库可以提供一些读能力。或者一些运营后台需要的分析语句，不能影响正常业务，所以只能在备库上跑。</p><p>我真就见过不少这样的情况。由于主库直接影响业务，大家使用起来会比较克制，反而忽视了备库的压力控制。结果就是，备库上的查询耗费了大量的CPU资源，影响了同步速度，造成主备延迟。</p><p>这种情况，我们一般可以这么处理：</p><ol>\n<li>\n<p>一主多从。除了备库外，可以多接几个从库，让这些从库来分担读的压力。</p>\n</li>\n<li>\n<p>通过binlog输出到外部系统，比如Hadoop这类系统，让外部系统提供统计类查询的能力。</p>\n</li>\n</ol><p>其中，一主多从的方式大都会被采用。因为作为数据库系统，还必须保证有定期全量备份的能力。而从库，就很适合用来做备份。</p><blockquote>\n<p>备注：这里需要说明一下，从库和备库在概念上其实差不多。在我们这个专栏里，为了方便描述，我把会在HA过程中被选成新主库的，称为备库，其他的称为从库。</p>\n</blockquote><p>追问2：采用了一主多从，保证备库的压力不会超过主库，还有什么情况可能导致主备延迟吗？</p><p><strong>这就是第三种可能了，即大事务。</strong></p><p>大事务这种情况很好理解。因为主库上必须等事务执行完成才会写入binlog，再传给备库。所以，如果一个主库上的语句执行10分钟，那这个事务很可能就会导致从库延迟10分钟。</p><p>不知道你所在公司的DBA有没有跟你这么说过：不要<strong>一次性地用delete语句删除太多数据</strong>。其实，这就是一个典型的大事务场景。</p><p>比如，一些归档类的数据，平时没有注意删除历史数据，等到空间快满了，业务开发人员要一次性地删掉大量历史数据。同时，又因为要避免在高峰期操作会影响业务（至少有这个意识还是很不错的），所以会在晚上执行这些大量数据的删除操作。</p><p>结果，负责的DBA同学半夜就会收到延迟报警。然后，DBA团队就要求你后续再删除数据的时候，要控制每个事务删除的数据量，分成多次删除。</p><p><strong>另一种典型的大事务场景，就是大表DDL。</strong>这个场景，我在前面的文章中介绍过。处理方案就是，计划内的DDL，建议使用gh-ost方案（这里，你可以再回顾下第13篇文章<a href=\"https://time.geekbang.org/column/article/72388\">《为什么表数据删掉一半，表文件大小不变？》</a>中的相关内容）。</p><p>追问3：如果主库上也不做大事务了，还有什么原因会导致主备延迟吗？</p><p>造成主备延迟还有一个大方向的原因，就是<strong>备库的并行复制能力</strong>。这个话题，我会留在下一篇文章再和你详细介绍。</p><p>其实还是有不少其他情况会导致主备延迟，如果你还碰到过其他场景，欢迎你在评论区给我留言，我来和你一起分析、讨论。</p><p>由于主备延迟的存在，所以在主备切换的时候，就相应的有不同的策略。</p><h1>可靠性优先策略</h1><p>在图1的双M结构下，从状态1到状态2切换的详细过程是这样的：</p><ol>\n<li>\n<p>判断备库B现在的seconds_behind_master，如果小于某个值（比如5秒）继续下一步，否则持续重试这一步；</p>\n</li>\n<li>\n<p>把主库A改成只读状态，即把readonly设置为true；</p>\n</li>\n<li>\n<p>判断备库B的seconds_behind_master的值，直到这个值变成0为止；</p>\n</li>\n<li>\n<p>把备库B改成可读写状态，也就是把readonly 设置为false；</p>\n</li>\n<li>\n<p>把业务请求切到备库B。</p>\n</li>\n</ol><p>这个切换流程，一般是由专门的HA系统来完成的，我们暂时称之为可靠性优先流程。</p><p><img src=\"https://static001.geekbang.org/resource/image/54/4a/54f4c7c31e6f0f807c2ab77f78c8844a.png?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图2 MySQL可靠性优先主备切换流程</span></center><p>备注：图中的SBM，是seconds_behind_master参数的简写。</p><p>可以看到，这个切换流程中是有不可用时间的。因为在步骤2之后，主库A和备库B都处于readonly状态，也就是说这时系统处于不可写状态，直到步骤5完成后才能恢复。</p><p>在这个不可用状态中，比较耗费时间的是步骤3，可能需要耗费好几秒的时间。这也是为什么需要在步骤1先做判断，确保seconds_behind_master的值足够小。</p><p>试想如果一开始主备延迟就长达30分钟，而不先做判断直接切换的话，系统的不可用时间就会长达30分钟，这种情况一般业务都是不可接受的。</p><p>当然，系统的不可用时间，是由这个数据可靠性优先的策略决定的。你也可以选择可用性优先的策略，来把这个不可用时间几乎降为0。</p><h1>可用性优先策略</h1><p>如果我强行把步骤4、5调整到最开始执行，也就是说不等主备数据同步，直接把连接切到备库B，并且让备库B可以读写，那么系统几乎就没有不可用时间了。</p><p>我们把这个切换流程，暂时称作可用性优先流程。这个切换流程的代价，就是可能出现数据不一致的情况。</p><p>接下来，我就和你分享一个可用性优先流程产生数据不一致的例子。假设有一个表 t：</p><pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,\n  `c` int(11) unsigned DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB;\n\ninsert into t(c) values(1),(2),(3);\n</code></pre><p>这个表定义了一个自增主键id，初始化数据后，主库和备库上都是3行数据。接下来，业务人员要继续在表t上执行两条插入语句的命令，依次是：</p><pre><code>insert into t(c) values(4);\ninsert into t(c) values(5);\n</code></pre><p>假设，现在主库上其他的数据表有大量的更新，导致主备延迟达到5秒。在插入一条c=4的语句后，发起了主备切换。</p><p>图3是<strong>可用性优先策略，且binlog_format=mixed</strong>时的切换流程和数据结果。</p><p><img src=\"https://static001.geekbang.org/resource/image/37/3a/3786bd6ad37faa34aca25bf1a1d8af3a.png?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图3 可用性优先策略，且binlog_format=mixed</span></center><p>现在，我们一起分析下这个切换流程：</p><ol>\n<li>\n<p>步骤2中，主库A执行完insert语句，插入了一行数据（4,4），之后开始进行主备切换。</p>\n</li>\n<li>\n<p>步骤3中，由于主备之间有5秒的延迟，所以备库B还没来得及应用“插入c=4”这个中转日志，就开始接收客户端“插入 c=5”的命令。</p>\n</li>\n<li>\n<p>步骤4中，备库B插入了一行数据（4,5），并且把这个binlog发给主库A。</p>\n</li>\n<li>\n<p>步骤5中，备库B执行“插入c=4”这个中转日志，插入了一行数据（5,4）。而直接在备库B执行的“插入c=5”这个语句，传到主库A，就插入了一行新数据（5,5）。</p>\n</li>\n</ol><p>最后的结果就是，主库A和备库B上出现了两行不一致的数据。可以看到，这个数据不一致，是由可用性优先流程导致的。</p><p>那么，如果我还是用<strong>可用性优先策略，但设置binlog_format=row</strong>，情况又会怎样呢？</p><p>因为row格式在记录binlog的时候，会记录新插入的行的所有字段值，所以最后只会有一行不一致。而且，两边的主备同步的应用线程会报错duplicate key error并停止。也就是说，这种情况下，备库B的(5,4)和主库A的(5,5)这两行数据，都不会被对方执行。</p><p>图4中我画出了详细过程，你可以自己再分析一下。</p><p><img src=\"https://static001.geekbang.org/resource/image/b8/43/b8d2229b2b40dd087fd3b111d1bdda43.png?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图4 可用性优先策略，且binlog_format=row</span></center><p>从上面的分析中，你可以看到一些结论：</p><ol>\n<li>\n<p>使用row格式的binlog时，数据不一致的问题更容易被发现。而使用mixed或者statement格式的binlog时，数据很可能悄悄地就不一致了。如果你过了很久才发现数据不一致的问题，很可能这时的数据不一致已经不可查，或者连带造成了更多的数据逻辑不一致。</p>\n</li>\n<li>\n<p>主备切换的可用性优先策略会导致数据不一致。因此，大多数情况下，我都建议你使用可靠性优先策略。毕竟对数据服务来说的话，数据的可靠性一般还是要优于可用性的。</p>\n</li>\n</ol><p>但事无绝对，<strong>有没有哪种情况数据的可用性优先级更高呢？</strong></p><p>答案是，有的。</p><p>我曾经碰到过这样的一个场景：</p><ul>\n<li>有一个库的作用是记录操作日志。这时候，如果数据不一致可以通过binlog来修补，而这个短暂的不一致也不会引发业务问题。</li>\n<li>同时，业务系统依赖于这个日志写入逻辑，如果这个库不可写，会导致线上的业务操作无法执行。</li>\n</ul><p>这时候，你可能就需要选择先强行切换，事后再补数据的策略。</p><p>当然，事后复盘的时候，我们想到了一个改进措施就是，让业务逻辑不要依赖于这类日志的写入。也就是说，日志写入这个逻辑模块应该可以降级，比如写到本地文件，或者写到另外一个临时库里面。</p><p>这样的话，这种场景就又可以使用可靠性优先策略了。</p><p>接下来我们再看看，<strong>按照可靠性优先的思路，异常切换会是什么效果？</strong></p><p>假设，主库A和备库B间的主备延迟是30分钟，这时候主库A掉电了，HA系统要切换B作为主库。我们在主动切换的时候，可以等到主备延迟小于5秒的时候再启动切换，但这时候已经别无选择了。</p><p><img src=\"https://static001.geekbang.org/resource/image/55/8b/553b7fc2d0dce3ec78bb595e1806eb8b.png?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图5 可靠性优先策略，主库不可用</span></center><p>采用可靠性优先策略的话，你就必须得等到备库B的seconds_behind_master=0之后，才能切换。但现在的情况比刚刚更严重，并不是系统只读、不可写的问题了，而是系统处于完全不可用的状态。因为，主库A掉电后，我们的连接还没有切到备库B。</p><p>你可能会问，那能不能直接切换到备库B，但是保持B只读呢？</p><p>这样也不行。</p><p>因为，这段时间内，中转日志还没有应用完成，如果直接发起主备切换，客户端查询看不到之前执行完成的事务，会认为有“数据丢失”。</p><p>虽然随着中转日志的继续应用，这些数据会恢复回来，但是对于一些业务来说，查询到“暂时丢失数据的状态”也是不能被接受的。</p><p>聊到这里你就知道了，在满足数据可靠性的前提下，MySQL高可用系统的可用性，是依赖于主备延迟的。延迟的时间越小，在主库故障的时候，服务恢复需要的时间就越短，可用性就越高。</p><h1>小结</h1><p>今天这篇文章，我先和你介绍了MySQL高可用系统的基础，就是主备切换逻辑。紧接着，我又和你讨论了几种会导致主备延迟的情况，以及相应的改进方向。</p><p>然后，由于主备延迟的存在，切换策略就有不同的选择。所以，我又和你一起分析了可靠性优先和可用性优先策略的区别。</p><p>在实际的应用中，我更建议使用可靠性优先的策略。毕竟保证数据准确，应该是数据库服务的底线。在这个基础上，通过减少主备延迟，提升系统的可用性。</p><p>最后，我给你留下一个思考题吧。</p><p>一般现在的数据库运维系统都有备库延迟监控，其实就是在备库上执行 show slave status，采集seconds_behind_master的值。</p><p>假设，现在你看到你维护的一个备库，它的延迟监控的图像类似图6，是一个45°斜向上的线段，你觉得可能是什么原因导致呢？你又会怎么去确认这个原因呢？</p><p><img src=\"https://static001.geekbang.org/resource/image/cf/71/cf5ea52aa3b26ef56c567125197fa171.png?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图6 备库延迟</span></center><p>你可以把你的分析写在评论区，我会在下一篇文章的末尾跟你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>上期我留给你的问题是，什么情况下双M结构会出现循环复制。</p><p>一种场景是，在一个主库更新事务后，用命令set global server_id=x修改了server_id。等日志再传回来的时候，发现server_id跟自己的server_id不同，就只能执行了。</p><p>另一种场景是，有三个节点的时候，如图7所示，trx1是在节点 B执行的，因此binlog上的server_id就是B，binlog传给节点 A，然后A和A’搭建了双M结构，就会出现循环复制。</p><p><img src=\"https://static001.geekbang.org/resource/image/f9/71/f968192ce2f436c939dd702b8f409771.png?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图7 三节点循环复制</span></center><p>这种三节点复制的场景，做数据库迁移的时候会出现。</p><p>如果出现了循环复制，可以在A或者A’上，执行如下命令：</p><pre><code>stop slave；\nCHANGE MASTER TO IGNORE_SERVER_IDS=(server_id_of_B);\nstart slave;\n</code></pre><p>这样这个节点收到日志后就不会再执行。过一段时间后，再执行下面的命令把这个值改回来。</p><pre><code>stop slave；\nCHANGE MASTER TO IGNORE_SERVER_IDS=();\nstart slave;\n</code></pre><p>评论区留言点赞板：</p><blockquote>\n<p>@一大只、@HuaMax 同学提到了第一个复现方法；</p>\n</blockquote><blockquote>\n<p>@Jonh同学提到了IGNORE_SERVER_IDS这个解决方法；</p>\n</blockquote><blockquote>\n<p>@React 提到，如果主备设置不同的步长，备库是不是可以设置为可读写。我的建议是，只要这个节点设计内就不会有业务直接在上面执行更新，就建议设置为readonly。</p>\n</blockquote><p></p>","comments":[{"had_liked":false,"id":58593,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1547127995,"is_pvip":false,"replies":[{"id":"21186","content":"分析的点很准确👍","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547140727,"ip_address":"","comment_id":58593,"utype":1}],"discussion_count":12,"race_medal":0,"score":"753166404795","product_id":100020801,"comment_content":"遇到过下面几种造成主从延迟的情况:<br>1.主库DML语句并发大,从库qps高<br>2.从库服务器配置差或者一台服务器上几台从库(资源竞争激烈,特别是io)<br>3.主库和从库的参数配置不一样<br>4.大事务(DDL,我觉得DDL也相当于一个大事务)<br>5.从库上在进行备份操作<br>6.表上无主键的情况(主库利用索引更改数据,备库回放只能用全表扫描,这种情况可以调整slave_rows_search_algorithms参数适当优化下)<br>7.设置的是延迟备库<br>8.备库空间不足的情况下<br><br>这期的问题：<br>看这曲线,应该是从库正在应用一个大事务,或者一个大表上无主键的情况(有该表的更新)<br>应该是T3随着时间的增长在增长,而T1这个时间点是没变的,造成的现象就是<br>随着时间的增长,second_behind_master也是有规律的增长","like_count":176,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436128,"discussion_content":"分析的点很准确👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547140727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1541014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","nickname":"天亮前说晚安","note":"","ucode":"1D82EE562A7C71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":185495,"discussion_content":"其实就是从库日志消费不过来，有点像MQ日志堆积一样吧","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1582631228,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2283781,"avatar":"https://static001.geekbang.org/account/avatar/00/22/d9/05/0d772dbf.jpg","nickname":"咦","note":"","ucode":"2E0D5A488489A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1541014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/96/73ff13a0.jpg","nickname":"天亮前说晚安","note":"","ucode":"1D82EE562A7C71","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397397,"discussion_content":"是的，感觉只要积压，也会出现这种效果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632617981,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":185495,"ip_address":""},"score":397397,"extra":""}]},{"author":{"id":1510011,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJgtVYia3HhaS65DjiaWBfTJj0yded6xBZbw0jT3IOxcqQibLz3yibw5KXK515tYXr3iaMibcywadst6C1w/132","nickname":"风云变","note":"","ucode":"E586B6E3FD5157","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":173861,"discussion_content":"兄弟很厉害！每次分析都很到位，总结精辟👍🏻","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1581865307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1333389,"avatar":"https://static001.geekbang.org/account/avatar/00/14/58/8d/bc69cde1.jpg","nickname":"浩克","note":"","ucode":"99F5D4F24AF574","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334943,"discussion_content":"请教个问题6.表上无主键的情况(主库利用索引更改数据,备库回放只能用全表扫描,这种情况可以调整slave_rows_search_algorithms参数适当优化下)，这个描述的场景是，在binlog_format=row，如果主库使用update更新很多条语句的话，同步到从库就是一行行的更新记录，每一个更新记录从库都需要全表扫面一遍，而主库的更新只需要一次全表扫描就更新完成了，即使主库使用索引更新，那么也是需要一次全表扫描，是这么理解的吧？也就是说表在无主键的情况下的更新都是走全表扫描来更新的，即使通过二级索引来更新也是需要全表扫描更新行数据页的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1608032806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1308784,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","nickname":"某、人","note":"","ucode":"ADB42AA12A11C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1333389,"avatar":"https://static001.geekbang.org/account/avatar/00/14/58/8d/bc69cde1.jpg","nickname":"浩克","note":"","ucode":"99F5D4F24AF574","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334953,"discussion_content":"有索引就走索引，我这里指的是又没有主键又没有索引的情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608035244,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334943,"ip_address":""},"score":334953,"extra":""},{"author":{"id":1333389,"avatar":"https://static001.geekbang.org/account/avatar/00/14/58/8d/bc69cde1.jpg","nickname":"浩克","note":"","ucode":"99F5D4F24AF574","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1308784,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","nickname":"某、人","note":"","ucode":"ADB42AA12A11C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335053,"discussion_content":"谢谢回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608082692,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334953,"ip_address":""},"score":335053,"extra":""}]},{"author":{"id":1115041,"avatar":"https://static001.geekbang.org/account/avatar/00/11/03/a1/e6a0f60b.jpg","nickname":"Sid","note":"","ucode":"0461B574B2736B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":205841,"discussion_content":"ddl为什么算是大事务啊？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584349613,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1235441,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d9/f1/a00711f8.jpg","nickname":"X  W  z","note":"","ucode":"915BA1CF6090F7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1115041,"avatar":"https://static001.geekbang.org/account/avatar/00/11/03/a1/e6a0f60b.jpg","nickname":"Sid","note":"","ucode":"0461B574B2736B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347562,"discussion_content":"1、ddl先拿metadata锁，如果有备库的表被查询，需要等待\n2、ddl需要扫描全表","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1612257799,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":205841,"ip_address":""},"score":347562,"extra":""}]},{"author":{"id":1543040,"avatar":"https://static001.geekbang.org/account/avatar/00/17/8b/80/8702bd5f.jpg","nickname":"evan","note":"","ucode":"491B073D5AFEDE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320008,"discussion_content":"想知道大佬是 运维还是开发?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604224633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292396,"discussion_content":"厉害了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595214815,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1551612,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ac/fc/fec89308.jpg","nickname":"大风车小转转","note":"","ucode":"27FE819F6EE6D7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":239169,"discussion_content":"分析的很👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587280872,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":80259,"user_name":"可可","can_delete":false,"product_type":"c1","uid":1439947,"ip_address":"","ucode":"DAEF22B24A6317","user_header":"https://static001.geekbang.org/account/avatar/00/15/f8/cb/506edc3c.jpg","comment_is_top":false,"comment_ctime":1553645773,"is_pvip":false,"replies":[{"id":"29652","content":"额。。这个不好说，得看面试官是什么类型的😅<br><br>最好的情况是那种，面试官问你的专栏讲到的知识点你都回答了，<br>然后面试官又把问题延伸了，然后你还顺利回答出来了。<br><br>这样就大大方方说学过了， 面试官一定觉得你又好学又勤于思考哟😆<br><br>（先预祝一波顺利拿到offer哈）","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1554052267,"ip_address":"","comment_id":80259,"utype":1}],"discussion_count":15,"race_medal":0,"score":"358035931341","product_id":100020801,"comment_content":"老师，我先来讲个笑话<br>昨天去面试另一家公司，问mysql的问题，问罢之后。<br>面试官:我看你对mysql了解的还蛮深得，是不是也看了极客时间的。。。～<br>我: 没有没有(连忙否认，有一种提前看了考试答案的罪恶感😂😂😂)<br><br><br>所以最后我有个问题，如果后面还有这样的问题，老师您觉得我应该怎么回答？","like_count":84,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444803,"discussion_content":"额。。这个不好说，得看面试官是什么类型的😅\n\n最好的情况是那种，面试官问你的专栏讲到的知识点你都回答了，\n然后面试官又把问题延伸了，然后你还顺利回答出来了。\n\n这样就大大方方说学过了， 面试官一定觉得你又好学又勤于思考哟😆\n\n（先预祝一波顺利拿到offer哈）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554052267,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2086960,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/d8/30/840b64fa.jpg","nickname":"Frank木风","note":"","ucode":"8DAA325F19E00E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325596,"discussion_content":"应该回答： 什么时间？极客什么？","likes_number":35,"is_delete":false,"is_hidden":false,"ctime":1605359740,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2008722,"avatar":"","nickname":"为梦终醒","note":"","ucode":"9784EB870F413B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2086960,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/d8/30/840b64fa.jpg","nickname":"Frank木风","note":"","ucode":"8DAA325F19E00E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351741,"discussion_content":"马什么梅？","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1614421099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":325596,"ip_address":""},"score":351741,"extra":""}]},{"author":{"id":2052476,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Qq6oLfOTgKzjiculoUDicdv7WoY1iabPfOTumibWeInVP2Mnod9XVPrNSClvIiaLbvtDlIjRnWUNaXcYwREGzlcaDog/132","nickname":"Geek_在下蟑螂王","note":"","ucode":"E1F5BBB5BC5962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323117,"discussion_content":"从极客时间学到了那也是自己的。\n不然面试有啥意义啊。面试本来不就是对知识的考察么。","likes_number":13,"is_delete":false,"is_hidden":false,"ctime":1604887925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2283781,"avatar":"https://static001.geekbang.org/account/avatar/00/22/d9/05/0d772dbf.jpg","nickname":"咦","note":"","ucode":"2E0D5A488489A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397400,"discussion_content":"面试官:来说说mysql45讲第25章讲了什么🧐","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1632618057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306112,"discussion_content":"说学了极客时间，然后面试官问题深度加大，当场凉凉、、、哈哈","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1600172187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046711,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erRDnCKfAWyOSUfU9hI8gYu2qsMOUwnFlCSngM0a9hbdnMmqHmBlziajorVdm9NGjx23SlAJXvicHGQ/132","nickname":"君君","note":"","ucode":"0E8F1058F01C28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364055,"discussion_content":"要是我就大大方方承认了。知识不都是来源于网络上的各种教程么。就算没看极客时间，也肯定看了其他教程，博客，总不能无中生有吧。真正能研究源码的又有几人","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1617356953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2014285,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKNv880TlsNuKaWcKbxiaAZTQIBWfJAddC8wfOROnwRPRwJXaEGSTBH2sic4jK7IGpxZn79tTDcREjw/132","nickname":"Geek_7482f6","note":"","ucode":"F3565F78525D30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1046711,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erRDnCKfAWyOSUfU9hI8gYu2qsMOUwnFlCSngM0a9hbdnMmqHmBlziajorVdm9NGjx23SlAJXvicHGQ/132","nickname":"君君","note":"","ucode":"0E8F1058F01C28","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":410081,"discussion_content":"很难，尤其是后端涉及的知识如此繁复，能静下心来专研一个方向就挺不错了~","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1635593281,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":364055,"ip_address":""},"score":410081,"extra":""}]},{"author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305149,"discussion_content":"弱弱问一句，面试官没看到这条评论吗","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1599795571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1303963,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e5/9b/db9a6a8c.jpg","nickname":"test","note":"","ucode":"2AEB293A81E969","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1809802,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/8a/a2d34896.jpg","nickname":"一元(wx:abley1874)","note":"","ucode":"5E7A33642FC767","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311811,"discussion_content":"我来晚了，刚看见","likes_number":32,"is_delete":false,"is_hidden":false,"ctime":1602492943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":305149,"ip_address":""},"score":311811,"extra":""},{"author":{"id":2756739,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/10/83/0facd0eb.jpg","nickname":"利威尔兵长","note":"","ucode":"FDE0BD5BFB1B4A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1303963,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e5/9b/db9a6a8c.jpg","nickname":"test","note":"","ucode":"2AEB293A81E969","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392280,"discussion_content":"哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630933015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":311811,"ip_address":""},"score":392280,"extra":""}]},{"author":{"id":1543040,"avatar":"https://static001.geekbang.org/account/avatar/00/17/8b/80/8702bd5f.jpg","nickname":"evan","note":"","ucode":"491B073D5AFEDE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320009,"discussion_content":"然后各种深挖 凉凉","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1604224691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1046711,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erRDnCKfAWyOSUfU9hI8gYu2qsMOUwnFlCSngM0a9hbdnMmqHmBlziajorVdm9NGjx23SlAJXvicHGQ/132","nickname":"君君","note":"","ucode":"0E8F1058F01C28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364053,"discussion_content":"所以面试官是用极客时间专栏来考你的。哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617356820,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2172817,"avatar":"","nickname":"Geek_chenyz","note":"","ucode":"BBB37F14FF666E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":343687,"discussion_content":"过了么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611135643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1028331,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b0/eb/112e7d16.jpg","nickname":"我是一根葱","note":"","ucode":"6208D18E65DB2F","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327641,"discussion_content":"过了么","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605880020,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67288,"user_name":"aubrey","can_delete":false,"product_type":"c1","uid":1304703,"ip_address":"","ucode":"57889C1B77FC3B","user_header":"","comment_is_top":false,"comment_ctime":1550124229,"is_pvip":false,"replies":[{"id":"23994","content":"👍内行😆<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550297675,"ip_address":"","comment_id":67288,"utype":1}],"discussion_count":3,"race_medal":0,"score":"181938750661","product_id":100020801,"comment_content":"semi-sync在网络故障超时的情况下会退化成async，这个时候如果刚好主库掉电了，有些binlog还没有传给从库，从库无法判断数据跟主库是否一致，如果强行切换可能会导致丢数据，在金融业务场景下只能＂人工智能＂来做切换，服务中断时间长。AliSQL采用双通道复制更容易判断主备数据是否一致，如果一致可以自动切换，如果不一致才需要人工恢复数据。","like_count":43,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439133,"discussion_content":"👍内行😆\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1550297675,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1305728,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ec/80/25d419a5.jpg","nickname":"家华","note":"","ucode":"35EE365E01DBBF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380223,"discussion_content":"双通道？  一个异步 一个半同步么","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1624377955,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1226968,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg","nickname":"hcyycb","note":"","ucode":"77FF6CA41F9E66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1305728,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ec/80/25d419a5.jpg","nickname":"家华","note":"","ucode":"35EE365E01DBBF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537602,"discussion_content":"一个网络，一个串口？哈哈哈，我猜。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1639113276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":380223,"ip_address":""},"score":537602,"extra":""}]}]},{"had_liked":false,"id":68100,"user_name":"linqw","can_delete":false,"product_type":"c1","uid":1134138,"ip_address":"","ucode":"09DCFE98C54DD8","user_header":"https://static001.geekbang.org/account/avatar/00/11/4e/3a/86196508.jpg","comment_is_top":false,"comment_ctime":1550412975,"is_pvip":false,"replies":[{"id":"25257","content":"1~4 很好的总结<br>5. 也是好问题，直接看《28 | 读写分离有哪些坑？》😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551182883,"ip_address":"","comment_id":68100,"utype":1}],"discussion_count":7,"race_medal":0,"score":"147579301039","product_id":100020801,"comment_content":"总结下学习完高可用，老师有空帮忙看下<br>1、主备延迟，就是在同一个事务在备库执行完成的时间和主库执行完成的时间之间的差值，包括主库事务执行完成时间和将binlog发送给备库，备库事务的执行完成时间的差值。每个事务的seconds_behind_master延迟时间，每个事务的 binlog 里面都有一个时间字段，用于记录主库上的写入时间，备库取出当前正在执行的事务的时间字段的值，计算它与当前系统时的差值。<br>2、主备延迟的来源①首先，有些部署条件下，备库所在机器的性能要比主库所在的机器性能差，原因多个备库部署在同一台机器上，大量的查询会导致io资源的竞争，解决办法是配置”双1“，redo log和binlog都只write fs page cache②备库的压力大，产生的原因大量的查询操作在备库操作，耗费了大量的cpu，导致同步延迟，解决办法，使用一主多从，多个从减少备的查询压力③大事务，因为如果一个大的事务的dml操作导致执行时间过长，将其事务binlog发送给备库，备库也需执行那么长时间，导致主备延迟，解决办法尽量减少大事务，比如delete操作，使用limit分批删除，可以防止大事务也可以减少锁的范围。<br>④大表的ddl，会导致主库将其ddl binlog发送给备库，备库解析中转日志，同步，后续的dml binlog发送过来，需等待ddl的mdl写锁释放，导致主备延迟。<br>3、可靠性优先策略，①判断备库 B 现在的 seconds_behind_master如果小于某个值（比如 5 秒）继续下一步，否则持续重试这一步，②把主库 A 改成只读状态，即把 readonly 设置为 true，③判断备库 B 的 seconds_behind_master的值，直到这个值变成 0 为止； 把备库 B 改成可读写也就是把 readonly 设置为 false； 把业务请求切换到备库，个人理解如果发送过来的binlog在中转日志中有多个事务，业务不可用的时间，就是多个事务被运用的总时间。如果非正常情况下，主库掉电，会导致出现的问题，如果备库和主库的延迟时间短，在中转日志运用完成，业务才能正常使用，如果在中转日志还未运用完成，切换为备库会导致之前完成的事务，”数据丢失“，但是在一些业务场景下不可接受。<br>4、可用性策略，出现的问题：在双m，且binlog_format=mixed，会导致主备数据不一致，使用使用 row 格式的 binlog 时，数据不一致的问题更容易发现，因为binlog row会记录字段的所有值。<br>5、老师有个问题不太理解，就是主备延迟时，会导致备库在没有运用中转日志时，业务查询时导致”数据丢失“，那如何解决了？","like_count":35,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439513,"discussion_content":"1~4 很好的总结\n5. 也是好问题，直接看《28 | 读写分离有哪些坑？》😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551182883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1261860,"avatar":"https://static001.geekbang.org/account/avatar/00/13/41/24/895f242a.jpg","nickname":"不忘初心","note":"","ucode":"9D57B894D900B5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294521,"discussion_content":"2 ① 描述的有问题吧 解决办法是配置”双1“，redo log和binlog都只write fs page cache\n\n为什么双1就是只写page cache了? fsync的操作哪去了？\n\n我的理解是 想要加快日志的写 那就应该配置非双1啊\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1595915704,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1261860,"avatar":"https://static001.geekbang.org/account/avatar/00/13/41/24/895f242a.jpg","nickname":"不忘初心","note":"","ucode":"9D57B894D900B5","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":332722,"discussion_content":"对的，他意思是对的，但写错了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607324252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":294521,"ip_address":""},"score":332722,"extra":""}]},{"author":{"id":2721761,"avatar":"https://static001.geekbang.org/account/avatar/00/29/87/e1/b85dce85.jpg","nickname":"无尽蔚蓝","note":"","ucode":"A665DF46833A81","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589177,"discussion_content":"ddl不是online的吗？大部分时间都是mdl读锁？为什么还会有主从延迟呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1664501064,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2721761,"avatar":"https://static001.geekbang.org/account/avatar/00/29/87/e1/b85dce85.jpg","nickname":"无尽蔚蓝","note":"","ucode":"A665DF46833A81","race_medal":5,"user_type":1,"is_pvip":true},"discussion":{"id":590153,"discussion_content":"online的DDL，刚开始也是需要获取MDL写锁的，避免其他事务并发DDL；后续才会降级为MDL读锁。   从库有长时间的慢查询或者查询事务未提交，主库同步过来的DDL涉及查询表的操作，会被阻塞。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665559233,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":589177,"ip_address":"陕西"},"score":590153,"extra":""},{"author":{"id":2721761,"avatar":"https://static001.geekbang.org/account/avatar/00/29/87/e1/b85dce85.jpg","nickname":"无尽蔚蓝","note":"","ucode":"A665DF46833A81","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590347,"discussion_content":"你是说长事务阻塞DDL？ 但我问的是为什么DDL会造成主从延迟呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665672837,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":590153,"ip_address":"上海"},"score":590347,"extra":""}]},{"author":{"id":2287841,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e8/e1/6045b299.jpg","nickname":"LPF","note":"","ucode":"036C552D7251E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332724,"discussion_content":"第3点：中转日志数据丢失问题这个问题应该属主库掉电，正在自行中转日志的备库被转为主库后的问题吧！那分为两种情况，在可靠性策略性下会让binlog执行完毕后才会将备库切换为主库此时不会发生数据丢失（由于你说的主备延迟低可以这么用），但在可用性策略下数据丢失（主备延迟期间事务不可见）本身就存在这个问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607324736,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192547,"user_name":"运维老胡","can_delete":false,"product_type":"c1","uid":1227007,"ip_address":"","ucode":"DF398BEE296E11","user_header":"https://static001.geekbang.org/account/avatar/00/12/b8/ff/249da6da.jpg","comment_is_top":false,"comment_ctime":1584859219,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"108959041619","product_id":100020801,"comment_content":"复制延迟排查思路：<br>1、查数据库在干什么<br>pager cat - | grep -v Sleep | sort -rn -k 12 | head -n 20<br>show full processlist;<br>select * from information_schema.processlist where 1=1 order by TIME desc limit 10;<br><br>2、查看sql_thread在干什么<br>slave上查看状态：show slave status\\G;<br>查看relay_master_log_file以及exec_master_log_pos<br>master上解析binglog日志：mysqlbinlog -v --base64-output=decode-rows --start-position=exec_master_log_pos relay_master_log_file<br><br>如果发现卡在操作某表上：<br>检查表结构<br>     \t  没有索引：stop slave 可能会卡主，建议关闭mysql，启动后先加索引，然后start slave<br>     \t  有索引：只能等，大事务需要做拆分，不要操作太多数据<br>大事务：M上session回话使用statement格式，使用语句级别的复制 <br><br>3、查看MySQL状态<br>机器性能（CPU、IO等）：从库配置适当高一点，使用新硬件PCI-E或SSD设备<br>表结构:  设计要合理，必须有主键，主键要短小，为查询字段建索引<br>业务程序：适当使用缓存，减少数据库压力<br>分析MySQL进程并结合源码：perf top `pidof mysqld` <br><br>4、参数临时优化<br>主库开启group commit<br>从库开启writeset<br>从库设置sync_binlog=0 &amp;&amp;  innodb_flush_log_at_trx_commit=2<br><br>5、检查锁情况<br>show engine innodb status\\G;","like_count":26},{"had_liked":false,"id":58171,"user_name":"万勇","can_delete":false,"product_type":"c1","uid":1309092,"ip_address":"","ucode":"BC9E0918DF4516","user_header":"https://static001.geekbang.org/account/avatar/00/13/f9/a4/f0b92135.jpg","comment_is_top":false,"comment_ctime":1547006280,"is_pvip":false,"replies":[{"id":"20971","content":"👍🏿<br>你是有故事的😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547016530,"ip_address":"","comment_id":58171,"utype":1}],"discussion_count":3,"race_medal":0,"score":"91741319496","product_id":100020801,"comment_content":"主备同步延迟，工作中常遇到几种情况：<br>1.主库做大量的dml操作，引起延迟<br>2.主库有个大事务在处理，引起延迟<br>3.对myisam存储引擎的表做dml操作，从库会有延迟。<br>4.利用pt工具对主库的大表做字段新增、修改和添加索引等操作，从库会有延迟。<br>","like_count":22,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435941,"discussion_content":"👍🏿\n你是有故事的😄","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1547016530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577933,"discussion_content":"我愿称你为延迟之王","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656420502,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115041,"avatar":"https://static001.geekbang.org/account/avatar/00/11/03/a1/e6a0f60b.jpg","nickname":"Sid","note":"","ucode":"0461B574B2736B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":205820,"discussion_content":"第3点，是因为myisam 从库重放dml时使用了表锁的缘故，导致主从延迟？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584346245,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58509,"user_name":"cyberty","can_delete":false,"product_type":"c1","uid":1018536,"ip_address":"","ucode":"8526DAA65CAEBA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8a/a8/cf86fe53.jpg","comment_is_top":false,"comment_ctime":1547097586,"is_pvip":false,"replies":[{"id":"21175","content":"好问题，不会","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547134430,"ip_address":"","comment_id":58509,"utype":1}],"discussion_count":9,"race_medal":0,"score":"87446443506","product_id":100020801,"comment_content":"请问老师，如果备库连接主库之后，主库的系统时间修改了，备库同步的时候是否会自动修正？","like_count":20,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436100,"discussion_content":"好问题，不会","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547134430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328816,"discussion_content":"还以为老师说此题不会","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1606231640,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1887586,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhicDSmL4vicPADhxxzOzukMar8nV5Tc3ic2dz4FQIxMX3WmX5a2V3sdD121eWpvfQI8NXIkkDZoDFw/132","nickname":"Geek_536b54","note":"","ucode":"F62BC7781D9212","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333983,"discussion_content":"不是人人都是逗比圈子的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607683831,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328816,"ip_address":""},"score":333983,"extra":""},{"author":{"id":1887586,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhicDSmL4vicPADhxxzOzukMar8nV5Tc3ic2dz4FQIxMX3WmX5a2V3sdD121eWpvfQI8NXIkkDZoDFw/132","nickname":"Geek_536b54","note":"","ucode":"F62BC7781D9212","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333984,"discussion_content":"😂😂😂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607683998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328816,"ip_address":""},"score":333984,"extra":""},{"author":{"id":2942580,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/e6/74/b59c2ac8.jpg","nickname":"知小","note":"","ucode":"57DCC7F875A72F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2278559,"avatar":"https://static001.geekbang.org/account/avatar/00/22/c4/9f/a01e4bd1.jpg","nickname":"海浪","note":"","ucode":"091941B3556B4B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":566840,"discussion_content":"哈哈哈笑死了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650773496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328816,"ip_address":""},"score":566840,"extra":""}]},{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295970,"discussion_content":"话说，mysql不会定期读取服务器的时钟吗？比如服务器本身时钟与ntp的同步，修复之后。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596417520,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1069548,"avatar":"https://static001.geekbang.org/account/avatar/00/10/51/ec/3d51d5e6.jpg","nickname":"上校","note":"","ucode":"DEE1CEE9E4C680","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289919,"discussion_content":"应该是用到timestamp计算差值，所以不修正也没关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594268377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58429,"user_name":"John","can_delete":false,"product_type":"c1","uid":1302506,"ip_address":"","ucode":"B4490A065DD779","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/ea/5aad0029.jpg","comment_is_top":false,"comment_ctime":1547082345,"is_pvip":false,"replies":[{"id":"21077","content":"你这个方法好👍🏿<br><br>数据问题的话，如果是设置的row 格式的binlog还好，因为insert和delete都会报错，会出现循环的就是update, 然后update都是可重入的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547089370,"ip_address":"","comment_id":58429,"utype":1}],"discussion_count":1,"race_medal":0,"score":"78856493673","product_id":100020801,"comment_content":"循环复制根本原因是binlog中引入了非当前主机的server id，可以通过ignore server ids过滤，但是一般情况如果出现循环复制，数据的可靠性就值得怀疑了，不管是过滤还是重新找点都很难保证循环的部分完整执行过，最后都要验证数据的状态，属于特别严重故障😂","like_count":19,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436061,"discussion_content":"你这个方法好👍🏿\n\n数据问题的话，如果是设置的row 格式的binlog还好，因为insert和delete都会报错，会出现循环的就是update, 然后update都是可重入的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547089370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58141,"user_name":"梁中华","can_delete":false,"product_type":"c1","uid":1006789,"ip_address":"","ucode":"52FE40242CBAD0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg","comment_is_top":false,"comment_ctime":1547001817,"is_pvip":true,"replies":[{"id":"20963","content":"1.可能会丢<br>2. 要看重启之后的拓扑结构了，如果还有节点是这个库的从库，还是会拿走的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547009398,"ip_address":"","comment_id":58141,"utype":1}],"discussion_count":5,"race_medal":1,"score":"70266478553","product_id":100020801,"comment_content":"我有一个比较极端一点的HA问题，假设主库的binlog刚写成功还未来得及把binlog同步到从库，主库就掉电了，这时候从库的数据会不完整吗？<br>第二个问题，原主库重启加入集群后，那条没有传出去的binlog会如何处理？","like_count":17,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435926,"discussion_content":"1.可能会丢\n2. 要看重启之后的拓扑结构了，如果还有节点是这个库的从库，还是会拿走的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1547009398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1089345,"avatar":"https://static001.geekbang.org/account/avatar/00/10/9f/41/82306dfe.jpg","nickname":"包子","note":"","ucode":"6CC4EBB8CD3924","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2301,"discussion_content":"谢谢，找到答案了，在28章","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563444964,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1089345,"avatar":"https://static001.geekbang.org/account/avatar/00/10/9f/41/82306dfe.jpg","nickname":"包子","note":"","ucode":"6CC4EBB8CD3924","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2294,"discussion_content":"你好，老师，虽然课程结束好久了，还是希望你能看到这条评论做解答：\n就像该朋友所说的第一个问题，在这种情况下数据丢掉了。\n该怎么办？数据库有没有提供一种，客户端请求-->主和备都写好binlog后才响应的这种机制？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563440323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":1089345,"avatar":"https://static001.geekbang.org/account/avatar/00/10/9f/41/82306dfe.jpg","nickname":"包子","note":"","ucode":"6CC4EBB8CD3924","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":93251,"discussion_content":"这种情况，当主库掉电了，从库会升级为主库，想把丢失的数据找回，就要利用主库的binlog进行恢复了\n你说的这种机制Mysql应该没有，不过消息队列有这种机制","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1576917105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2294,"ip_address":""},"score":93251,"extra":""},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1089345,"avatar":"https://static001.geekbang.org/account/avatar/00/10/9f/41/82306dfe.jpg","nickname":"包子","note":"","ucode":"6CC4EBB8CD3924","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375097,"discussion_content":"有，lossless semi-sync replication","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621482061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2294,"ip_address":""},"score":375097,"extra":""}]}]},{"had_liked":false,"id":58220,"user_name":"Max","can_delete":false,"product_type":"c1","uid":1302420,"ip_address":"","ucode":"E3F1CD8FCB66B3","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/94/84296110.jpg","comment_is_top":false,"comment_ctime":1547012228,"is_pvip":false,"replies":[{"id":"20968","content":"不用抱歉，这是好问题呀<br><br>连接的时候，从库告诉主库信息，<br>之后是主库主动发的。<br><br>网络如果断开，重连的时候是从库重新告诉主库<br><br>主库只是“根据要求发日志”","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547016384,"ip_address":"","comment_id":58220,"utype":1}],"discussion_count":2,"race_medal":0,"score":"61676554372","product_id":100020801,"comment_content":"老师，图中产生的这个现象的原因应该是，执行一个大事务，导致second_behind_master一直在增加。<br>其实second_behind_master的计算机方法应该当前系统的时间戳减去sql_thread线程正在执行的binglog event上的时间戳，得到的差值就是seconds_behind_master.<br>但根据seconds_behind_master来判断主从同步有一个严重的问题，如果主库和从库网络如果不通，从库不会马上知道和主库连接不能，从库有一个<br>salve_net_timeout=多少秒，从库会通过这个参数定时的检测是否与主库保持通讯，所以这个参数应该设为小一点。slave_net_timeout=10(单位是秒).<br>或者用pt-hearbeat来检测主从延迟。<br><br>老师，请教一个题外问题，mysql的主从复制，到底是主库把binlog事件推送给从库，还是从库请求主库把binlog事件推送给从库。<br>除了start slave;这个动作表示从库请求把某一个binlog事件推送给它。因为一般情况下主库的binlog推送给从库是异步模式，不需要从库告诉主库我接收这个事件.<br>如果主从之间网络不通，主库会多次发送已经执行过的binlog事件吗？网络不好可能多次提交 实在抱歉","like_count":15,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435955,"discussion_content":"不用抱歉，这是好问题呀\n\n连接的时候，从库告诉主库信息，\n之后是主库主动发的。\n\n网络如果断开，重连的时候是从库重新告诉主库\n\n主库只是“根据要求发日志”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547016384,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1584208,"avatar":"https://static001.geekbang.org/account/avatar/00/18/2c/50/64365ef7.jpg","nickname":"zhoubo_eric","note":"","ucode":"34725AA3A9D59C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582117,"discussion_content":"这个是对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659242289,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58486,"user_name":"xm","can_delete":false,"product_type":"c1","uid":1254296,"ip_address":"","ucode":"9A08EB6F201D74","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/98/bd96932f.jpg","comment_is_top":false,"comment_ctime":1547089775,"is_pvip":false,"replies":[{"id":"21171","content":"一般大于1就不好 ^_^","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547134252,"ip_address":"","comment_id":58486,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44496762735","product_id":100020801,"comment_content":"一般主从延时多少算是合理的？是秒级别吗？","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436087,"discussion_content":"一般大于1就不好 ^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547134252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58312,"user_name":"7号","can_delete":false,"product_type":"c1","uid":1318471,"ip_address":"","ucode":"F7F52807253F21","user_header":"https://static001.geekbang.org/account/avatar/00/14/1e/47/f01225df.jpg","comment_is_top":false,"comment_ctime":1547034161,"is_pvip":false,"replies":[{"id":"21008","content":"估计下一个月占多少比例，如果比较小就建新表，把数据导过去吧<br>如果一个月占比高的话，只能一点点删了。<br><br>时间字段有索引的话，每个分区按时间过滤出来删除","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547042840,"ip_address":"","comment_id":58312,"utype":1}],"discussion_count":3,"race_medal":0,"score":"44496707121","product_id":100020801,"comment_content":"老师，生产环境有一张表需要清理，该表大小140G。要保留最近一个月的数据，又不能按时间直接用detele删（全表扫描），本来想通过清空分区表删，但是分区表又是哈希的。。有没好的办法呢？","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436005,"discussion_content":"估计下一个月占多少比例，如果比较小就建新表，把数据导过去吧\n如果一个月占比高的话，只能一点点删了。\n\n时间字段有索引的话，每个分区按时间过滤出来删除","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547042840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1348251,"avatar":"https://static001.geekbang.org/account/avatar/00/14/92/9b/7afb979a.jpg","nickname":"糖六六爸爸","note":"","ucode":"83A4399DA0C6D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1642,"discussion_content":"我们使用中是通过时间分别查询出开始和结束的主键ID,然后根据主键ID范围进行轮询删除","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1562753589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295969,"discussion_content":"我们那dba每次都建议我这边用分区表。。我对此表示无感，我自己写了业务上的时间序的分表，业务控制并发从db中取数据，妈耶，删除表记录也是我自己写的统一清库策略-时间序，自己控制删除的步伐，依旧删除的时间与长度限制  哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596417453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58744,"user_name":"崔伟协","can_delete":false,"product_type":"c1","uid":1022452,"ip_address":"","ucode":"ACDEEDF2A10999","user_header":"https://static001.geekbang.org/account/avatar/00/0f/99/f4/e0484cac.jpg","comment_is_top":false,"comment_ctime":1547187912,"is_pvip":true,"replies":[{"id":"21230","content":"异常切换有可能的<br><br>要根据你的处理策略了，如果不能丢，有几个可选的<br>1.不切换（等这个库自己恢复起来）<br>2. 使用semi-sync策略<br>3. 启动后业务做数据对账（这个一般用得少，成本高）<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547190376,"ip_address":"","comment_id":58744,"utype":1}],"discussion_count":2,"race_medal":0,"score":"40201893576","product_id":100020801,"comment_content":"发生主从切换的时候，主有的最新数据没同步到从，会出现这种情况吗，出现了会怎么样","like_count":10,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436197,"discussion_content":"异常切换有可能的\n\n要根据你的处理策略了，如果不能丢，有几个可选的\n1.不切换（等这个库自己恢复起来）\n2. 使用semi-sync策略\n3. 启动后业务做数据对账（这个一般用得少，成本高）\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547190376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292400,"discussion_content":"第三种方案使用过，很麻烦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595215486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":69895,"user_name":"aliang","can_delete":false,"product_type":"c1","uid":1149502,"ip_address":"","ucode":"B36B94B362477F","user_header":"https://static001.geekbang.org/account/avatar/00/11/8a/3e/30c05bce.jpg","comment_is_top":false,"comment_ctime":1550898776,"is_pvip":true,"replies":[{"id":"24922","content":"嗯，取时间这个动作只发生在“主从建立连接”的过程中，<br>如果已经连着的时候，时间戳改掉，是会不准的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550943716,"ip_address":"","comment_id":69895,"utype":1}],"discussion_count":3,"race_medal":0,"score":"35910637144","product_id":100020801,"comment_content":"老师，我有一个问题：（1）seconds_behind_master的计算方法是通过从库的系统时间戳减去sql_thead线程正在执行的binlog_event上的时间戳的差值。当从库系统时间不准时也不会影响seconds的值，因为从库连接到主库时会通过select unix_timestamp（）查询主库的系统时间，若发现和从库不一致会在计算seconds这个值时作调整（2）我的疑惑是在主从网络正常时，select unix_timestamp执行的频率和触发条件是怎样的（换句话说（1）中描述的从库连接到主库这个行为是一直存在的还是有其他触发条件？）。如果这个频率不高，那在两次select unix_timestamp期间从库系统时间发生变化，seconds的值岂不是不准了？","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440338,"discussion_content":"嗯，取时间这个动作只发生在“主从建立连接”的过程中，\n如果已经连着的时候，时间戳改掉，是会不准的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550943716,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375128,"discussion_content":"只在主备建立连接的时候查询一次时间差，那么要查询准确的主备延迟，可以使用pt-heartbeat工具。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621491883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":93272,"discussion_content":"这个问题也是我疑问的，在建立的时候获取主库的时间，如果后面主库的时间改了或者时区改了 应该就会影响这个SBM了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576917886,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58369,"user_name":"易翔","can_delete":false,"product_type":"c1","uid":1304541,"ip_address":"","ucode":"8C63DB7379186C","user_header":"https://static001.geekbang.org/account/avatar/00/13/e7/dd/e68f9cf5.jpg","comment_is_top":false,"comment_ctime":1547045957,"is_pvip":false,"replies":[{"id":"21134","content":"👍","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547120909,"ip_address":"","comment_id":58369,"utype":1}],"discussion_count":2,"race_medal":0,"score":"35906784325","product_id":100020801,"comment_content":"常见的都讲了，补充几点我遇到过的。<br><br>1,备库做逻辑备份时，有产生MDL锁。然后复制线程刚好被堵塞。。kill掉备份线程，一切都畅快了。。我遇到过，但是感觉那备份期间产生的非共享锁不是短时间就释放的吗？为什么堵的时间那么长，感觉像是遇到死锁。大神讲讲其中原因。<br><br>2，数据库用了共享存储，其它业务的不期待(我们当时是归档程序)占用会导致同样连接该存储上的数据库遇到写入瓶颈，写入不仅仅是应用中继日志产生的数据。还有写中继日志。写中继日志慢，应用日志线程工作却有条不紊。这时候也会产生备库延迟。由于体现没有中继日志滞留，没有想到io问题，当时第一反应是网络带宽被打满了，确认了，没有问题过后。然后找到存储，看存储IOPS。最后定位到归档程序正在批量写入数据。","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436030,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547120909,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2009461,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/a9/75/dbccd12d.jpg","nickname":"稻草人","note":"","ucode":"6694EE2CD36B8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":356111,"discussion_content":"1、备库逻辑备份，首先要拿MDL写锁，如果这时备库有个慢查询就会导致备份堵在了拿锁阶段，后续队列的所有SQL都会hang住，表象就是主从延迟不断升高。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615533450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58330,"user_name":"Long","can_delete":false,"product_type":"c1","uid":1318970,"ip_address":"","ucode":"2417242560360A","user_header":"https://static001.geekbang.org/account/avatar/00/14/20/3a/90db6a24.jpg","comment_is_top":false,"comment_ctime":1547038074,"is_pvip":false,"replies":[{"id":"21006","content":"嗯，这这个建议很好，我会考虑加的哈🤝","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547042671,"ip_address":"","comment_id":58330,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35906776442","product_id":100020801,"comment_content":"老师，您好：<br><br>一直追这个课程，解决了我自己的很多知识盲点，或者更加深入的了解一些知识点，已经在试读留言下推荐了这个课程。<br><br>但是有的时候在分析问题的时候，看很多日志，比如error log中的死锁日志，报错日志中每个字段是什么意思，以及show innodb engine status中每个日志段的意思，比如在将redo log的时候innodb status就会记录，这样就可以结合课程中的log write，page cahce和fsync逻辑到数据库中实际感受到学到的原因，在应用中怎么一一对应。<br>比如，show innodb engine status中：<br> --------<br> FILE I&#47;O<br> --------<br>***<br>***<br> Pending normal aio reads: 0 [0, 0, 0, 0, 0, 0, 0, 0] , aio writes: 0 [0, 0, 0, 0, 0, 0, 0, 0] ,<br>  ibuf aio reads: 0, log i&#47;o&#39;s: 0, sync i&#47;o&#39;s: 0<br> Pending flushes (fsync) log: 1; buffer pool: 0<br> 14321192292 OS file reads, 120057595 OS file writes, 60413577 OS fsyncs<br> 10 pending preads, 1 pending pwrites<br> 4648.01 reads&#47;s, 16383 avg bytes&#47;read, 48.09 writes&#47;s, 34.98 fsyncs&#47;s<br><br><br> ---<br> LOG<br> ---<br> Log sequence number 3893849611607<br> Log flushed up to   3893849603096<br> Pages flushed up to 3893705803837<br> Last checkpoint at  3893705803837<br> 1 pending log writes, 0 pending chkp writes<br> 28053287 log i&#47;o&#39;s done, 10.15 log i&#47;o&#39;s&#47;second<br><br>之前看过网上的一些分析，由于和原理脱离，所以理解的都不深。<br>非常期待老师能结合error log一些常见问题分析比如dead lock，常见crash啊之类的，<br>以及show innodb engine status中的重点内容！<br><br>多谢<br><br>","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436014,"discussion_content":"嗯，这这个建议很好，我会考虑加的哈🤝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547042671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58295,"user_name":"EAGLE","can_delete":false,"product_type":"c1","uid":1303484,"ip_address":"","ucode":"5B0FE019A8C9BD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e3/bc/064401c7.jpg","comment_is_top":false,"comment_ctime":1547028664,"is_pvip":false,"replies":[{"id":"21013","content":"要看有没有开并行复制，默认是串行，一个堵全部堵","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547043066,"ip_address":"","comment_id":58295,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35906767032","product_id":100020801,"comment_content":"文中提到“如果一个主库上的语句执行 10 分钟，那这个事务很可能就会导致从库延迟 10 分钟”。这个延迟是针对当前delete事务，还是所有的事务都延迟。<br><br>","like_count":8,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435993,"discussion_content":"要看有没有开并行复制，默认是串行，一个堵全部堵","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547043066,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58333,"user_name":"undifined","can_delete":false,"product_type":"c1","uid":1068920,"ip_address":"","ucode":"449CB4CD2DC089","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg","comment_is_top":false,"comment_ctime":1547038363,"is_pvip":false,"replies":[{"id":"21007","content":"1不太准确，明天我会提到哈<br><br>23对的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547042713,"ip_address":"","comment_id":58333,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23021874843","product_id":100020801,"comment_content":"问题答案：<br>1. 备库在执行复杂查询，导致资源被占用<br>2. 备库正在执行一个大事务<br>3. DML 语句执行<br><br>老师我的理解对吗","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436016,"discussion_content":"1不太准确，明天我会提到哈\n\n23对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547042713,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58258,"user_name":"Sr7vy","can_delete":false,"product_type":"c1","uid":1276653,"ip_address":"","ucode":"4C2D930E984BC9","user_header":"https://static001.geekbang.org/account/avatar/00/13/7a/ed/f52b84b9.jpg","comment_is_top":false,"comment_ctime":1547021755,"is_pvip":false,"replies":[{"id":"21019","content":"问题1:<br>1.备库没收到，还是收到没执行，前者0，后者30<br>2. 第二问没看懂<br><br>问题2:<br>类似的，主库把日志都发给备库了吗","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547044379,"ip_address":"","comment_id":58258,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23021858235","product_id":100020801,"comment_content":"问题1：T3的解释是：备库执行完这个事物。则：Seconds_Behind_Master=T3-T1。如T1=30min，主执行完成，备没有执行。猜测1：那么Seconds_Behind_Master=30min吗？猜测2：备执需要先把这个30min的事务执行完后，Seconds_Behind_Master=30min？<br>问题2：很多时候是否能把Seconds_Behind_Master当作真正的延迟时间（面试常被问）？如果能，pt-heartbeat存在还有啥意义啊？","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435976,"discussion_content":"问题1:\n1.备库没收到，还是收到没执行，前者0，后者30\n2. 第二问没看懂\n\n问题2:\n类似的，主库把日志都发给备库了吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547044379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590161,"discussion_content":"不能。主库由于网络原因binlog未发送给从库，这时候延迟已经存在，但SBM仍然为0。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665560665,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58094,"user_name":" JJ","can_delete":false,"product_type":"c1","uid":1250967,"ip_address":"","ucode":"45EC52EFFC49FB","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/97/9e342700.jpg","comment_is_top":false,"comment_ctime":1546996241,"is_pvip":false,"replies":[{"id":"20944","content":"等应用完就认为是SBM=0<br><br>如果不能接受主库有来不及传的，就使用semi-sync","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547001592,"ip_address":"","comment_id":58094,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23021832721","product_id":100020801,"comment_content":"请问老师，主库断电了，怎么把binlog传给从库同步数据，怎么使的SBM为0主从切换呢？","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435902,"discussion_content":"等应用完就认为是SBM=0\n\n如果不能接受主库有来不及传的，就使用semi-sync","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547001592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1371360,"avatar":"https://static001.geekbang.org/account/avatar/00/14/ec/e0/d072d6f0.jpg","nickname":"bigdudo","note":"","ucode":"5938710D7C1149","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":533408,"discussion_content":"我的理解，主库断电了，但是在从库io上仍然还有binlog日志、或者说从库本地仍然还有binlog日志没处理完。所以即使主库不存在了，从库仍然要通过现存的binlog做好同步处理。直到从库同步的binlog日志时间和自己本地时间差小于5即SBM&lt;=5，表示从库具备了可以变为主库的条件，等到SBM=0了，那么此时从库就可以变为主库进行读写了。所以也就是后面说的那句话：“高可用是依赖主备延时的（更详细的说是依赖备库在同步binlog的延时的）“。同步的binlog延时越小，从库在遇到极端情况下切为主库的动作就越及时～","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637853104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":435902,"ip_address":""},"score":533408,"extra":"{\"user_type\":1}"}]}]},{"had_liked":false,"id":58088,"user_name":"via","can_delete":false,"product_type":"c1","uid":1017696,"ip_address":"","ucode":"5A7E873D8D8FBE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/60/fe8a31ea.jpg","comment_is_top":false,"comment_ctime":1546995214,"is_pvip":false,"replies":[{"id":"21123","content":"canal 可以了解下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119143,"ip_address":"","comment_id":58088,"utype":1}],"discussion_count":3,"race_medal":0,"score":"23021831694","product_id":100020801,"comment_content":"通过 binlog 输出到外部系统，比如 Hadoop 这类...<br><br>文中这个具体是可采用什么工具呢？<br> ","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435900,"discussion_content":"canal 可以了解下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119143,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295973,"discussion_content":"不光是hadoop 也可以导入到redis，canel强大 ，手动点赞","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1596417633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2336545,"avatar":"https://static001.geekbang.org/account/avatar/00/23/a7/21/9366cdd8.jpg","nickname":"三井寿","note":"","ucode":"325E9D64C22C0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373142,"discussion_content":"之前公司用过canal监听部分表然后在代码里处理更新其他一些表，没想到还可以输出到外部系统","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620630445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62839,"user_name":"700","can_delete":false,"product_type":"c1","uid":1072896,"ip_address":"","ucode":"E4BD0CBADAF951","user_header":"","comment_is_top":false,"comment_ctime":1548169361,"is_pvip":false,"replies":[{"id":"22257","content":"跨IDC还好吧，跨城市或者跨洲才比较麻烦<br>其实主要还是延迟的问题，这个确实不好解决。<br>业务开发的时候尽量是本城市访问，否则容易出现抖动<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548224578,"ip_address":"","comment_id":62839,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18728038545","product_id":100020801,"comment_content":"老师请教下，MySQL 主从跨 IDC 的痛点是什么？同城 IDC 和异地 IDC 的痛点一样吗？怎么来解决这些痛点？","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437368,"discussion_content":"跨IDC还好吧，跨城市或者跨洲才比较麻烦\n其实主要还是延迟的问题，这个确实不好解决。\n业务开发的时候尽量是本城市访问，否则容易出现抖动\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548224578,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58658,"user_name":"康磊","can_delete":false,"product_type":"c1","uid":1256403,"ip_address":"","ucode":"92A367153B33BC","user_header":"https://static001.geekbang.org/account/avatar/00/13/2b/d3/7c42e06c.jpg","comment_is_top":false,"comment_ctime":1547168430,"is_pvip":false,"replies":[{"id":"21205","content":"第28篇专门讲这个问题，敬请期待🤝","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547176281,"ip_address":"","comment_id":58658,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18727037614","product_id":100020801,"comment_content":"老师你好，现在一般采用读写分离，读的是从库，那么主从如果出现延迟的话，读库就读的不是最新数据，对这种问题有什么好建议吗？","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436153,"discussion_content":"第28篇专门讲这个问题，敬请期待🤝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547176281,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590162,"discussion_content":"读可以先切回主库，主从一致后，再切回来。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665560788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58136,"user_name":"WilliamX","can_delete":false,"product_type":"c1","uid":1295476,"ip_address":"","ucode":"E915091A891873","user_header":"https://static001.geekbang.org/account/avatar/00/13/c4/74/27cf551a.jpg","comment_is_top":false,"comment_ctime":1547001526,"is_pvip":false,"replies":[{"id":"21128","content":"嗯，你这里说的大事务，是那种“查很多，更新少”，这种没关系的；<br><br>一般我们在说主备延迟的大事务，是指“更新很多行”的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119353,"ip_address":"","comment_id":58136,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18726870710","product_id":100020801,"comment_content":"大事务导致主从延时的问题，我修改下。<br>主库上即使有大事务，但只要影响行数不多，传送到从库时间为t1，完成时间为T3，那这个时间gap和是否大事务没关系吧？","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435925,"discussion_content":"嗯，你这里说的大事务，是那种“查很多，更新少”，这种没关系的；\n\n一般我们在说主备延迟的大事务，是指“更新很多行”的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58061,"user_name":"尘封","can_delete":false,"product_type":"c1","uid":1247006,"ip_address":"","ucode":"CEE0C006387A03","user_header":"https://static001.geekbang.org/account/avatar/00/13/07/1e/bdbe93f4.jpg","comment_is_top":false,"comment_ctime":1546987503,"is_pvip":false,"replies":[{"id":"21118","content":"对，没有主键同步很慢，算是个bug，不过也确实不应该再出现没有主键的表啦^_^","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119009,"ip_address":"","comment_id":58061,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18726856687","product_id":100020801,"comment_content":"表没有主键，sysbench压力测试也会导致主从延时","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435884,"discussion_content":"对，没有主键同步很慢，算是个bug，不过也确实不应该再出现没有主键的表啦^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154069,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574376505,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14459278393","product_id":100020801,"comment_content":"老师，我看了一下MySQL5.7官方文档，里面提到说&quot;本质上，SBM是SQL线程与IO线程时间差&quot;，并明确说，&quot;若网络延迟大，但SQL线程追上了IO线程，SBM=0。即只有网络很快时，SBM才有用&quot;。我理解SBM是T3-T2","like_count":3},{"had_liked":false,"id":58202,"user_name":"梁中华","can_delete":false,"product_type":"c1","uid":1006789,"ip_address":"","ucode":"52FE40242CBAD0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg","comment_is_top":false,"comment_ctime":1547009869,"is_pvip":true,"replies":[{"id":"20970","content":"后面会说，<br>其实确实是权衡的结果","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547016503,"ip_address":"","comment_id":58202,"utype":1}],"discussion_count":1,"race_medal":1,"score":"14431911757","product_id":100020801,"comment_content":"关于semi–sync，大神什么时候开一讲，感觉比较鸡肋，和网络绑死了，可用性肯能会降低。不过阿里的Oceanbase也是用类似强一致同步的方式，大神怎么看？","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435949,"discussion_content":"后面会说，\n其实确实是权衡的结果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547016503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58109,"user_name":"老杨同志","can_delete":false,"product_type":"c1","uid":1246199,"ip_address":"","ucode":"3F334F0CFD3DE6","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg","comment_is_top":false,"comment_ctime":1546998475,"is_pvip":false,"replies":[{"id":"21125","content":"2的话，虽然会延迟，不过不会是这么标准的线<br><br>1 对的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119205,"ip_address":"","comment_id":58109,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14431900363","product_id":100020801,"comment_content":"思考题情况我感觉有两种情况<br>1）大事务。如老师文章里说的时间段t1、t2、t3, t1 10分钟，t2很快完成，t3也要在从库上执行10分钟。那么在t3时间段内，应该就是延时不断增加吧。<br><br>2）我的猜测，主库多线程执行事务。从库单线程执行relayLog，相当于串行化事务，在主库比较繁忙的情况下，是不是从库也会出现延时逐步增加的情况","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435910,"discussion_content":"2的话，虽然会延迟，不过不会是这么标准的线\n\n1 对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119205,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204522,"user_name":"亲斤弓虽😈","can_delete":false,"product_type":"c1","uid":1412163,"ip_address":"","ucode":"575893ECF0B7AA","user_header":"https://static001.geekbang.org/account/avatar/00/15/8c/43/af33659f.jpg","comment_is_top":false,"comment_ctime":1586416658,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10176351250","product_id":100020801,"comment_content":"之前和dba聊.在解决大事务删除的时候.dba坚决给出建议,新建表.把剩下的数据插进去.然后改成原来的名字.再删除之前的表. 我觉得dba说的很对~哈哈","like_count":2},{"had_liked":false,"id":67880,"user_name":"aliang","can_delete":false,"product_type":"c1","uid":1149502,"ip_address":"","ucode":"B36B94B362477F","user_header":"https://static001.geekbang.org/account/avatar/00/11/8a/3e/30c05bce.jpg","comment_is_top":false,"comment_ctime":1550308248,"is_pvip":true,"replies":[{"id":"24024","content":"1. 可能是版本问题？现在官网还在发行的版本(5.5~8.0)都是有查主库的时间戳，然后算差值的；<br>2. 如果网络断了，这时候show slave status是能够判断出来的，这时候当然是要有对应的异常处理了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1550321503,"ip_address":"","comment_id":67880,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10140242840","product_id":100020801,"comment_content":"老师，我之前在看贺春旸写的《MySQL管理之道：性能调优、高可用与监控》 第2版时，书上提到：当（1）从库的系统时间不准（没有提到老师讲的从库访问主库时会执行select unix_timestamp（）获取主库系统时间） （2）主从之间网络中断（此时主库binlog无法推送到从库，导致从库没有正在执行的binlog；slave_net_timeout设置太大导致slave很久才尝试重连主库）这两种情况时，靠seconds_behind_master的值来判断主从延迟是不准的。这与老师讲的有点出入，是不是书上描述错了呢？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439409,"discussion_content":"1. 可能是版本问题？现在官网还在发行的版本(5.5~8.0)都是有查主库的时间戳，然后算差值的；\n2. 如果网络断了，这时候show slave status是能够判断出来的，这时候当然是要有对应的异常处理了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550321503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62338,"user_name":"强哥","can_delete":false,"product_type":"c1","uid":1206726,"ip_address":"","ucode":"3B8DC780FE4EF9","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/c6/513df085.jpg","comment_is_top":false,"comment_ctime":1548034476,"is_pvip":false,"replies":[{"id":"22029","content":"额 那这个是要跟业务好好讨论一下架构设计的，可以这么跟业务说，如果是由于问题导致整个连不通，会不会雪崩？<br>也就是说，可用性不可能100%，如果不可用就雪崩，表示架构需要优化。<br><br>之后才谈策略选择（否则这样根本没得谈哈）","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1548037380,"ip_address":"","comment_id":62338,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10137969068","product_id":100020801,"comment_content":"今天跟公司的dba咨询了下，目前公司用的主备切换策略都是可用性优先，说是可靠性优先的话，可能会引起雪崩，主要还是业务的并发高，这种场景您是怎么看呢？麻烦给下思路谢谢。","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437174,"discussion_content":"额 那这个是要跟业务好好讨论一下架构设计的，可以这么跟业务说，如果是由于问题导致整个连不通，会不会雪崩？\n也就是说，可用性不可能100%，如果不可用就雪崩，表示架构需要优化。\n\n之后才谈策略选择（否则这样根本没得谈哈）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548037380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292401,"discussion_content":"并发高的问题需要先从架构设计方面优化， 不能压力全到数据库这边","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595215772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":166446,"discussion_content":"关键还是要看架构设计，不能将压力透到数据库层面。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581397297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58150,"user_name":"郭刚","can_delete":false,"product_type":"c1","uid":1292032,"ip_address":"","ucode":"22CB8ECE8E3DCA","user_header":"https://static001.geekbang.org/account/avatar/00/13/b7/00/12149f4e.jpg","comment_is_top":false,"comment_ctime":1547002941,"is_pvip":false,"replies":[{"id":"20974","content":"这个例子我们只是为了描述方便，本质上是statement 导致的，<br>考虑下update的例子","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547016661,"ip_address":"","comment_id":58150,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10136937533","product_id":100020801,"comment_content":"如果不使用自增序列作为主键，用UUID，是不是就不会出现不一致的问题？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435930,"discussion_content":"这个例子我们只是为了描述方便，本质上是statement 导致的，\n考虑下update的例子","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547016661,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58038,"user_name":"Sinyo","can_delete":false,"product_type":"c1","uid":1307297,"ip_address":"","ucode":"57B243E7AB86A5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAibnPX9jW8kqLcIfibjic8GbkQkEUYyFKJkc39hZhibVlNrqwTjdLozkqibI2IwACd5YzofYickNxFnZg/132","comment_is_top":false,"comment_ctime":1546965469,"is_pvip":false,"replies":[{"id":"21117","content":"不会啊<br>insert记录的时候肯定都记录的<br>你的默认值是什么？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547118971,"ip_address":"","comment_id":58038,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10136900061","product_id":100020801,"comment_content":"老师，在 binlog row模式下，insert 到表中一条记录，这条记录中某个字段不填，该字段在表中有设置默认值，利用canal解析binlog出来，这个不填的字段会不存在；难道 binlog 只记录有插入的字段数据，表字段的默认数据就不会记录么？mysql版本5.7.22 canal版本1.0.3","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435879,"discussion_content":"不会啊\ninsert记录的时候肯定都记录的\n你的默认值是什么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547118971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590168,"discussion_content":"这里应该是的binlog_row_image=minimal  未记录插入的默认值","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665562516,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":342285,"user_name":"再见理想","can_delete":false,"product_type":"c1","uid":1245999,"ip_address":"","ucode":"FAC88B3F6F6DFD","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg","comment_is_top":false,"comment_ctime":1650171629,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5945138925","product_id":100020801,"comment_content":"通过在从库上执行  show slave status  查看seconds_bebind_master 的值可以查看主从延迟的时间。<br>导致主从延迟的几种原因：<br>1.从库相较于主库主机性能过差。<br>2.从库读压力过大，很多运维&#47;运营的耗cpu的数据统计语句在从库执行。<br>3.主库执行大事务耗时语句。<br>4.主库执行大表的DDL语句。<br>5.备库的并行复制能力较差。<br>双M架构主备切换的流程：<br>1.查看 seconds_behind_master的值，当它小于一个数值（小于5s）时，执行下一步。<br>2.将主库设置为readonly= true<br>3.等seconds_behind_master = 0后，将备库设置为readonly = false。<br>4.将业务请求发送到备库。","like_count":1},{"had_liked":false,"id":182137,"user_name":"君","can_delete":false,"product_type":"c1","uid":1106635,"ip_address":"","ucode":"9C2574F6A2D82B","user_header":"https://static001.geekbang.org/account/avatar/00/10/e2/cb/74c0dd45.jpg","comment_is_top":false,"comment_ctime":1582716907,"is_pvip":false,"replies":[{"id":"70517","content":"这种不算，就是应该等事务提交后才可见，这个是合理的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1582721450,"ip_address":"","comment_id":182137,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5877684203","product_id":100020801,"comment_content":"大事务这种情况很好理解。因为主库上必须等事务执行完成才会写入 binlog，再传给备库。所以，如果一个主库上的语句执行 10 分钟，那这个事务很可能就会导致从库延迟 10 分钟。<br>==<br>问下老师这个场景，一般隔离级别是读提交，大事务提交后，查询也是事务提交后才可见，这种是不是就不算延迟，还是我理解错了","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485233,"discussion_content":"这种不算，就是应该等事务提交后才可见，这个是合理的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582721450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109434,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1562032068,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5856999364","product_id":100020801,"comment_content":"解决数据迁移时三节点循环复制问题，是设置忽略服务器 B IGNORE_SERVER_IDS=(server_id_of_B)，请问，如果在 A 或 A&#39; 上忽略 B 的binlog 日志，应该会导致这期间的数据，没有同步到 A 或 A&#39;？<br>而后面再改回来 IGNORE_SERVER_IDS=() 时，忽略期间的这部分数据怎么从 B 继续同步到 A 或 A&#39;？<br><br>谢谢老师！！","like_count":1},{"had_liked":false,"id":102931,"user_name":"库尔斯","can_delete":false,"product_type":"c1","uid":1085569,"ip_address":"","ucode":"BC2F220993C3ED","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIG210UcWicnKgOjBJC3CUxiaRImsiaqscVLyABrA4Kshm7hReicSuyRvfe1x07ydoT8WknNh2QLxU3rA/132","comment_is_top":false,"comment_ctime":1560330656,"is_pvip":false,"replies":[{"id":"37463","content":"对于业务来说，主库提交了，从库查不到，就算是延迟<br>这个大事务本身就属于这种情况","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1560473044,"ip_address":"","comment_id":102931,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5855297952","product_id":100020801,"comment_content":"那也只会大事务本身延迟。但这并不会造成问题，因为大事务的拥有者是有长时执行的预期的。那为什么文中要拿出来作为典型延迟的一种呢？<br><br>其实我感觉大事务堵塞了所有事务，造成全局性的delay，才成为问题，但我不明白原因是什么。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453654,"discussion_content":"对于业务来说，主库提交了，从库查不到，就算是延迟\n这个大事务本身就属于这种情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560473044,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67538,"user_name":"瘦皮猴","can_delete":false,"product_type":"c1","uid":1069066,"ip_address":"","ucode":"31350273CE7600","user_header":"https://static001.geekbang.org/account/avatar/00/10/50/0a/0ab85b6c.jpg","comment_is_top":false,"comment_ctime":1550194506,"is_pvip":false,"replies":[{"id":"25111","content":"不是“因为主从同步时延偏高，就需要主从切换”，而是说如果存在同步延迟偏高，那么主从切换的时候就会影响可用性","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1551094623,"ip_address":"","comment_id":67538,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5845161802","product_id":100020801,"comment_content":"如果只是因为主从同步时延偏高，就需要主从切换，这意义好像不大啊？我的理解是，这样切还是要等事务在从节点执行完才行，本质是挪了一个窝而已，该慢的还是慢。不知道这样的切换会在那些业务场景下发生<br><br>另外mysql的高可用，我一直以为的是节点宕了之后，其他节点可以有办法不丢数据的切了，看样子弊端还是挺多的。<br><br>谢谢指教","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439236,"discussion_content":"不是“因为主从同步时延偏高，就需要主从切换”，而是说如果存在同步延迟偏高，那么主从切换的时候就会影响可用性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551094623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58483,"user_name":"xm","can_delete":false,"product_type":"c1","uid":1254296,"ip_address":"","ucode":"9A08EB6F201D74","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/98/bd96932f.jpg","comment_is_top":false,"comment_ctime":1547089612,"is_pvip":false,"replies":[{"id":"21184","content":"就是要看还有没有救，如果各种方法都没救了，就只能主库分库了<br><br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547140505,"ip_address":"","comment_id":58483,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5842056908","product_id":100020801,"comment_content":"老师好，如果是主库的qps上来了，主库写请求太多这种造成的延迟的话是不是从主库上下手好点？这种是做热数据隔离主库拆分？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436085,"discussion_content":"就是要看还有没有救，如果各种方法都没救了，就只能主库分库了\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547140505,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58468,"user_name":"光","can_delete":false,"product_type":"c1","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1547087309,"is_pvip":true,"replies":[{"id":"21138","content":"1. 主库上删除，对延迟没有任何影响的，还是得等从库同步完成之后，再执行“删表”这个动作；<br>   备库的话，如果这个语句已经在执行了，你执行的drop table是会被堵住的，所以对延迟也无益；<br>2. 说的是主库删除还是备库删除？<br>3. 表示从库上的工作线程的等待队列太多了<br>4. 不是锁表，就是锁了太多行了；<br>5. 如果你真的可以重建表的话，操作上可以这样。 <br>    a) 备库上stop slave<br>    b) 备库上 set sql_log_bin=off; truncate table t;<br>    c）备库上跳过这个事务（方法后面文章会说）<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547121525,"ip_address":"","comment_id":58468,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5842054605","product_id":100020801,"comment_content":"老师请教个问题我们公司现在用得阿里云mysql  ，昨天下午开始了延迟，排查发现有大事务更新操作。<br>现在怎么解决这个大事务呢。<br>1、如果我主库上删除这个表或者从库上删除这个表会有什么结果。<br>2、比如我主库上三个表1、2、3，只同步了1，没同步完时候删除了2、3表，这时候会有什么错误。<br>3、Waiting for Slave Workers to free pending events 这个是代表什么意思<br>4、mysql tables in use 1, locked 1<br>     6045 lock struct(s), heap size 549072, 159972 row lock(s), undo log entries 159972<br>      MySQL thread id 3, OS thread handle 47532738873088, query id 165269 Executing event<br>这个是锁表了把。能简单解释下呢。我查资料不是很明白。<br>5、这个事务是不是只能等。或者是重建主从。<br>","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436075,"discussion_content":"1. 主库上删除，对延迟没有任何影响的，还是得等从库同步完成之后，再执行“删表”这个动作；\n   备库的话，如果这个语句已经在执行了，你执行的drop table是会被堵住的，所以对延迟也无益；\n2. 说的是主库删除还是备库删除？\n3. 表示从库上的工作线程的等待队列太多了\n4. 不是锁表，就是锁了太多行了；\n5. 如果你真的可以重建表的话，操作上可以这样。 \n    a) 备库上stop slave\n    b) 备库上 set sql_log_bin=off; truncate table t;\n    c）备库上跳过这个事务（方法后面文章会说）\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547121525,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58438,"user_name":"春困秋乏夏打盹","can_delete":false,"product_type":"c1","uid":1210807,"ip_address":"","ucode":"CCC558EF504F4B","user_header":"https://static001.geekbang.org/account/avatar/00/12/79/b7/989824f7.jpg","comment_is_top":false,"comment_ctime":1547083654,"is_pvip":false,"replies":[{"id":"21054","content":"好问题，一种方法是开semi-sync,一种是直接到主库show master status ，拿到从库去判断位点，主动切换可以这么做。<br>不过一般情况下，只要io_thread正常running,，日志都是会马上发给备库的，延迟只要还是发生在sql_theead哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547085410,"ip_address":"","comment_id":58438,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5842050950","product_id":100020801,"comment_content":"老师，有一个问题<br>在复制中，备库怎么确认io_thread已经完成了sql_thread同步过来的relay log呢<br>比如，延时往往是发生在io_thread的应用上<br>这时，主库宕机掉binlog(mysql-binlog.000023,位置点500），假如备库的relay log已经接到到(mysql-binlog.000023,位置点400)，这时io_thread已经应用到（mysql-binlog.000023,位置点100)阻塞了（比如某种延时之类）,想知道怎么在备库上确认io_thread已经执行完了接受到的所有relay log（mysql-binlog.000023,位置点400）？<br>按理说，如果这个时候要切换(手动)，是要等到io_thread线程应用完成了才应该完成切换的，<br>mha可以自动确认是否应用完，如果要手动切换，是否只有去读relay 和binlog比较？<br>","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436064,"discussion_content":"好问题，一种方法是开semi-sync,一种是直接到主库show master status ，拿到从库去判断位点，主动切换可以这么做。\n不过一般情况下，只要io_thread正常running,，日志都是会马上发给备库的，延迟只要还是发生在sql_theead哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547085410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58314,"user_name":"张永志","can_delete":false,"product_type":"c1","uid":1208727,"ip_address":"","ucode":"E54B75EF3F63B3","user_header":"https://static001.geekbang.org/account/avatar/00/12/71/97/f1a3d398.jpg","comment_is_top":false,"comment_ctime":1547035009,"is_pvip":false,"replies":[{"id":"21011","content":"对的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547042982,"ip_address":"","comment_id":58314,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5842002305","product_id":100020801,"comment_content":"表上没有主键或唯一键，或者索引效率不高，这类表上有数据修改删除时，由于效率很差，主从同步会延迟。当这类表上修改的数据多时，延迟就会持续增长。<br>有主键的表，一个事务操作的数据多时，也会出现延迟持续增长的情况。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436007,"discussion_content":"对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547042982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58261,"user_name":"user","can_delete":false,"product_type":"c1","uid":1307295,"ip_address":"","ucode":"3AA2D3DA955B4A","user_header":"https://static001.geekbang.org/account/avatar/00/13/f2/9f/b4af181c.jpg","comment_is_top":false,"comment_ctime":1547022408,"is_pvip":false,"replies":[{"id":"21132","content":"一般这种情况是从库1的压力大？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119746,"ip_address":"","comment_id":58261,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841989704","product_id":100020801,"comment_content":"一主两从配置一样，某一时刻，从库1有瞬间的3s延迟，从库2 没有延迟，这个是怎么回事啊？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435978,"discussion_content":"一般这种情况是从库1的压力大？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58170,"user_name":"Dovelol","can_delete":false,"product_type":"c1","uid":1253384,"ip_address":"","ucode":"9B5DDF7720F307","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","comment_is_top":false,"comment_ctime":1547006271,"is_pvip":false,"replies":[{"id":"20972","content":"监控延迟有很多系统化的工具吧，<br>比较老的zabbix 都有了哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547016592,"ip_address":"","comment_id":58170,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841973567","product_id":100020801,"comment_content":"老师好，我们是主从架构，用的pt-heartbeat监控的主从延迟，偶尔会有1秒，极少数会有10s的延迟，想问下该怎么查找原因呢，另外这个监控不能输出系统时间，很难知道延迟出现的时间点，想知道mysql监控这块都用哪些工具来配合的。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435940,"discussion_content":"监控延迟有很多系统化的工具吧，\n比较老的zabbix 都有了哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547016592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58132,"user_name":"WilliamX","can_delete":false,"product_type":"c1","uid":1295476,"ip_address":"","ucode":"E915091A891873","user_header":"https://static001.geekbang.org/account/avatar/00/13/c4/74/27cf551a.jpg","comment_is_top":false,"comment_ctime":1547001090,"is_pvip":false,"replies":[{"id":"20964","content":"第一种，<br>第二种的话，从库不知道的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547009428,"ip_address":"","comment_id":58132,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841968386","product_id":100020801,"comment_content":"老师，对于大事务的主从延时有个问题。从库是怎么感知到有延时的呢？是删除行数太多，从库需要一行一行执行，还是说主库一直没有把binlog传过来，从库认为延时高呢？","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435922,"discussion_content":"第一种，\n第二种的话，从库不知道的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547009428,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58127,"user_name":"清风浊酒","can_delete":false,"product_type":"c1","uid":1302407,"ip_address":"","ucode":"4BB111C61A40C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/df/87/0e05dadd.jpg","comment_is_top":false,"comment_ctime":1547000334,"is_pvip":false,"replies":[{"id":"21127","content":"是的<br><br>不过后面文章更新了，换了另外一个方法，你再看下","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119289,"ip_address":"","comment_id":58127,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841967630","product_id":100020801,"comment_content":"老师您好，关于上期思考题中三节点复制的场景。其中第二种解决方法中，stop slave 与start slave之前，我觉得A&#39;的binlog会包含A库传送过来的以及A&#39;库自己生产的，是不是在复制过程中，先把A&#39;设置为只读模式，待数据迁移结束后，取消A&#39;的只读模式，再指向 A’最后一个 binlog 文件的文件末尾。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435919,"discussion_content":"是的\n\n不过后面文章更新了，换了另外一个方法，你再看下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119289,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58103,"user_name":"冯琦","can_delete":false,"product_type":"c1","uid":1237163,"ip_address":"","ucode":"17AEE214897924","user_header":"https://static001.geekbang.org/account/avatar/00/12/e0/ab/fb5a0b66.jpg","comment_is_top":false,"comment_ctime":1546997919,"is_pvip":false,"replies":[{"id":"21124","content":"26篇会专门说备库并行复制的问题","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119180,"ip_address":"","comment_id":58103,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841965215","product_id":100020801,"comment_content":"前段时间，公司版本是5.5.18，实时计算平台写了一个大事务，大概40G左右，导致主备延迟1个小时以上，超尴尬，手动切换主备read.后来才只知道5.5版本，备库解析binlog,是单线程执行这个事务。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435906,"discussion_content":"26篇会专门说备库并行复制的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119180,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58079,"user_name":"Second Sight","can_delete":false,"product_type":"c1","uid":1309199,"ip_address":"","ucode":"E979B311AA3491","user_header":"https://static001.geekbang.org/account/avatar/00/13/fa/0f/14bdda08.jpg","comment_is_top":false,"comment_ctime":1546994389,"is_pvip":false,"replies":[{"id":"21122","content":"这是一种情况哈^_^","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547119092,"ip_address":"","comment_id":58079,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841961685","product_id":100020801,"comment_content":"我猜是大事务吧，比如delete删全表","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435896,"discussion_content":"这是一种情况哈^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58073,"user_name":"梦康","can_delete":false,"product_type":"c1","uid":1069512,"ip_address":"","ucode":"8935F3C329C58E","user_header":"https://static001.geekbang.org/account/avatar/00/10/51/c8/83852d5a.jpg","comment_is_top":false,"comment_ctime":1546992767,"is_pvip":false,"replies":[{"id":"20933","content":"更新毕竟还是比读的成本高的<br><br>不过主键单行更新10毫秒还是有点多，<br>开了semisync了吗？可以关掉看看，<br>或者同样树拓扑搭个个测试用的主备，测试一下关掉binlog是什么效果","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547000681,"ip_address":"","comment_id":58073,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841960063","product_id":100020801,"comment_content":"主库从库同样的配置，一个文章表按主键更新阅读数，大多数时候10ms＋，偶尔2ms以内。从库按主键读一直1ms。两个操作都没有在代码里显性开始事务操作。是因为主库更新操作是事务，且binlog要同步到备库才算写入完成，所以时间特别长吗？但是觉得这个差距也好大。求分析。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435892,"discussion_content":"更新毕竟还是比读的成本高的\n\n不过主键单行更新10毫秒还是有点多，\n开了semisync了吗？可以关掉看看，\n或者同样树拓扑搭个个测试用的主备，测试一下关掉binlog是什么效果","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547000681,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347407,"user_name":"powerful","can_delete":false,"product_type":"c1","uid":3003648,"ip_address":"","ucode":"621D21D2FC5D21","user_header":"https://static001.geekbang.org/account/avatar/00/2d/d5/00/5f328909.jpg","comment_is_top":false,"comment_ctime":1653995293,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1653995293","product_id":100020801,"comment_content":"老师没太理解这个参数“IGNORE_SERVER_IDS”设置的含义，设置前和设置后的执行流程是怎么样的，麻烦您抽时间给科普一下","like_count":0},{"had_liked":false,"id":345049,"user_name":"shuaiqikk","can_delete":false,"product_type":"c1","uid":2073675,"ip_address":"","ucode":"10C574C5C51FBE","user_header":"https://static001.geekbang.org/account/avatar/00/1f/a4/4b/d26f5e5d.jpg","comment_is_top":false,"comment_ctime":1651982945,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651982945","product_id":100020801,"comment_content":"老师，我有个问题咨询一下：<br>从库接收主库binlog的io_thread 与  执行 relay log的 sql_thread是常驻内存的吗？每一次主从同步都是复用的这两个相同的线程吗","like_count":0},{"had_liked":false,"id":323374,"user_name":"bigdudo","can_delete":false,"product_type":"c1","uid":1371360,"ip_address":"","ucode":"5938710D7C1149","user_header":"https://static001.geekbang.org/account/avatar/00/14/ec/e0/d072d6f0.jpg","comment_is_top":false,"comment_ctime":1637863642,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637863642","product_id":100020801,"comment_content":"我的理解这一章在讲高可用更多的侧重点在保证高可用，主从切换是实现高可用的一环，保证主从切换在主从有延时的情况下能有效地进行则是binlog和sbm来保证的，其中涉及到可靠性优先还是可用性优先则是在主从切换的时候保证高可用的时候需要权衡的","like_count":0},{"had_liked":false,"id":320859,"user_name":"Tim","can_delete":false,"product_type":"c1","uid":1480717,"ip_address":"","ucode":"3AAA9FD3D8DDDB","user_header":"https://static001.geekbang.org/account/avatar/00/16/98/0d/fb77a32c.jpg","comment_is_top":false,"comment_ctime":1636533344,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636533344","product_id":100020801,"comment_content":"如果在A‘执行该命令，那么A可以binlog同步serverB的内容，同步后发出来的binlog上标识的还是serverB，那如果A&#39;一直不执行来自ServerB的binlog，这不是数据不一致了么，这不比循环复制严重么。","like_count":0},{"had_liked":false,"id":319948,"user_name":"水月","can_delete":false,"product_type":"c1","uid":2344034,"ip_address":"","ucode":"78FC68615016DB","user_header":"https://static001.geekbang.org/account/avatar/00/23/c4/62/269aae3f.jpg","comment_is_top":false,"comment_ctime":1636015379,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636015379","product_id":100020801,"comment_content":"是不是delete row的大事务如果binlog格式是statement的话可能就不会是个大延迟了","like_count":0},{"had_liked":false,"id":319794,"user_name":"懒赫赫","can_delete":false,"product_type":"c1","uid":2303492,"ip_address":"","ucode":"EDFB9B69ABB705","user_header":"https://static001.geekbang.org/account/avatar/00/23/26/04/844be9df.jpg","comment_is_top":false,"comment_ctime":1635943572,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1635943572","product_id":100020801,"comment_content":"可用性优先策略，且 binlog_format=row时，为什么最多只有一行数据不一致？在插入4,4及4,5的时候为什么不会报错duplicate key error呢？而是在A插入(5,5)和B插入（5,4）时才报错？","like_count":0},{"had_liked":false,"id":312001,"user_name":"宙斯","can_delete":false,"product_type":"c1","uid":2041396,"ip_address":"","ucode":"80DF36BAD298AD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","comment_is_top":false,"comment_ctime":1631588276,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1631588276","product_id":100020801,"comment_content":"问题：某段时间监控采集到seconds_behind_master数值向上变陡了，你觉得可能是什么原因导致呢？你又会怎么去确认这个原因呢？<br>回答：曲线倾斜说明主备延时变得严重，按照今天讲解导致这情况如下。<br>1 发送binlog时间耗时，导致从库执行延时（网络异常变慢，传输丢包等）。<br>2 大事务处理导致延时。<br>3 从库qps压力飙升，来不及处理主从同步数据。<br>4 大表DDL处理。<br>确认：可以从业务上查看是否有大事务，DDL处理，检查网络情况。<br>","like_count":0},{"had_liked":false,"id":308659,"user_name":"巴林特","can_delete":false,"product_type":"c1","uid":1330521,"ip_address":"","ucode":"85109C43C4FEB6","user_header":"https://static001.geekbang.org/account/avatar/00/14/4d/59/dfd0bfd9.jpg","comment_is_top":false,"comment_ctime":1629723478,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629723478","product_id":100020801,"comment_content":"林老师好，请教个问题，如果主库执行了delete某一行记录，且主库没有主键索引，那么从库上会发生什么？数据量很大时，会导致流水延迟么？","like_count":0},{"had_liked":false,"id":303531,"user_name":"张诚","can_delete":false,"product_type":"c1","uid":1115702,"ip_address":"","ucode":"F623703194769B","user_header":"https://static001.geekbang.org/account/avatar/00/11/06/36/d288bcc7.jpg","comment_is_top":false,"comment_ctime":1626847292,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1626847292","product_id":100020801,"comment_content":"突然想到一个问题，公司现在采用的是读写分离架构，我可以看到从库的配置，其中buffer_pool_size设置的是24G，但是innodb_log_file_size是48M.因为看不到写库的配置信息，但是会有一个疑问，因为读库负责读取数据，所以不redo_log在读库上是没用的吗？读库只是执行写库同步过来的binlog就行了？<br>那么我能不能在写库上这么配，将innodb_log_file_size配置的大一点，将buffer_pool_size配置适中，然后将change_buffer_size的比例调增到最大？这个问题上有点疑惑，想问问老师。","like_count":0},{"had_liked":false,"id":276933,"user_name":"励研冰","can_delete":false,"product_type":"c1","uid":1106394,"ip_address":"","ucode":"FCBC8266018FA0","user_header":"https://static001.geekbang.org/account/avatar/00/10/e1/da/d7f591a7.jpg","comment_is_top":false,"comment_ctime":1612183141,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1612183141","product_id":100020801,"comment_content":"判断备库 B 的 seconds_behind_master 的值，直到这个值变成 0 为止；<br><br>老师按照前文的讲解，SBM是备库执行主库的binlog取出事务在主库执行时间然后计算出来的，如果将主库设置成readonly，这时候主库没有binlog ，备库是如何让SBM变成0的？","like_count":0,"discussions":[{"author":{"id":2336545,"avatar":"https://static001.geekbang.org/account/avatar/00/23/a7/21/9366cdd8.jpg","nickname":"三井寿","note":"","ucode":"325E9D64C22C0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373325,"discussion_content":"非并行复制下:last_master_timestamp 有binlog会更新为一个事务在主库的执行时间，没有binlog的话在等待的时候就会更新成0，根据源码那个算法当这个值为0时，SBM为0。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620698727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1106394,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e1/da/d7f591a7.jpg","nickname":"励研冰","note":"","ucode":"FCBC8266018FA0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2336545,"avatar":"https://static001.geekbang.org/account/avatar/00/23/a7/21/9366cdd8.jpg","nickname":"三井寿","note":"","ucode":"325E9D64C22C0D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373818,"discussion_content":"感谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620886328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373325,"ip_address":""},"score":373818,"extra":""}]}]},{"had_liked":false,"id":267127,"user_name":"浩克","can_delete":false,"product_type":"c1","uid":1333389,"ip_address":"","ucode":"99F5D4F24AF574","user_header":"https://static001.geekbang.org/account/avatar/00/14/58/8d/bc69cde1.jpg","comment_is_top":false,"comment_ctime":1607603905,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607603905","product_id":100020801,"comment_content":"表上无主键的情况(主库利用索引更改数据,备库回放只能用全表扫描,这种情况可以调整slave_rows_search_algorithms参数适当优化下)，这种情况主库更新不也是全表扫描吗？还是说主库利用索引更新是更新到change buffer里了，然后写redo log，binlog，发给从库，从库全表扫描定位需要更新的行，但是主库更新具体行的时候还是需要全表扫描通过rowid来定位到要更新的行？没有主键的表，无论查询还是更新，回表的话都是走全表扫描用rowid匹配到对应的行？烦请老师百忙之中给答疑解惑下，多谢。","like_count":0},{"had_liked":false,"id":263473,"user_name":"小帅","can_delete":false,"product_type":"c1","uid":1008570,"ip_address":"","ucode":"6044840DDFC335","user_header":"https://static001.geekbang.org/account/avatar/00/0f/63/ba/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1606140620,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606140620","product_id":100020801,"comment_content":"老师不推荐使用PXC吗","like_count":0},{"had_liked":false,"id":254281,"user_name":"紫日","can_delete":false,"product_type":"c1","uid":1207410,"ip_address":"","ucode":"73A8DEE323AC19","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqXSb2jAzlMM0JdTjWrNiaq2uR9eeloBYp906POddb9evmuj5f4CUoO6ge8TibibwtZicnl1sRHic9rW7g/132","comment_is_top":false,"comment_ctime":1603095319,"is_pvip":true,"discussion_count":0,"race_medal":4,"score":"1603095319","product_id":100020801,"comment_content":"感觉自己基础好差，就能理解一部分，这个怎么解决呢？","like_count":0},{"had_liked":false,"id":253348,"user_name":"java_lunsong","can_delete":false,"product_type":"c1","uid":1502074,"ip_address":"","ucode":"180EEE6C8BCAA8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKb5BzdGZbSYHxq88kicdDtBh0yBtJpDAD81wruIsTsLdBysDZztrm8tYb4mBYvAI1ZE4lorKuvmgw/132","comment_is_top":false,"comment_ctime":1602692791,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602692791","product_id":100020801,"comment_content":"怎么保证mysql 的高可用性？<br>前提要知道<br>1. 首先要知道一个概念就是同步延时。<br>2. 作为一个数据服务，建议是要先保证数据的可靠性，我们不能为了可用性来牺牲可靠性，数据准确，应该是数据库服务的底线。而且这在某些业务场景下可能会得不偿失。<br>所以， 保证高可用性，我们就只能尽量可能的减少这个同步延时，同步延时的原因可能有很多：<br>1. 备库的机器不行，IOPS压力很大，会有延时比较高的问题<br>2.第二种，备库的压力会比较大，可能会有很多复杂查询<br>3. 大事务（大表的ddl也算是）<br>所以，我们解决了导致同步延时高的原因，把同步延时的时间降低下来，我们的数据库服务就可以在主库失败时从容的进行主备的切换，这样也就保证了高可用性。","like_count":0},{"had_liked":false,"id":251865,"user_name":"moonfox","can_delete":false,"product_type":"c1","uid":1526355,"ip_address":"","ucode":"902BFF40EFA9FA","user_header":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","comment_is_top":false,"comment_ctime":1601918137,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1601918137","product_id":100020801,"comment_content":"请问一下，T1这个时刻是指写完这个事务的binlog 的时间点，还是指刚开始写的时间点？同样T3时刻是指写完binlog 的时间点？","like_count":0,"discussions":[{"author":{"id":1010344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6a/a8/ee414a25.jpg","nickname":"公告-SRE运维实践","note":"","ucode":"86F4E48AE1D9D8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547510,"discussion_content":"写完。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642730483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249340,"user_name":"神毓逍遥","can_delete":false,"product_type":"c1","uid":2147220,"ip_address":"","ucode":"83351CB18B190E","user_header":"https://static001.geekbang.org/account/avatar/00/20/c3/94/e89ebc50.jpg","comment_is_top":false,"comment_ctime":1600600634,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1600600634","product_id":100020801,"comment_content":"如果是主库向从库主动发，当从很多时，会不会遇到性能问题，为什么不涉及为从主动从主获取数据呢？","like_count":0,"discussions":[{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328962,"discussion_content":"会有同步数据延迟","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606287730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247254,"user_name":"Magic","can_delete":false,"product_type":"c1","uid":1272047,"ip_address":"","ucode":"FD9CEDAA419EB0","user_header":"https://static001.geekbang.org/account/avatar/00/13/68/ef/6264ca3d.jpg","comment_is_top":false,"comment_ctime":1599641527,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599641527","product_id":100020801,"comment_content":"大事务或大表ddl，可以到information_schema.innodb_trx查询是否有长事务。","like_count":0},{"had_liked":false,"id":240987,"user_name":"范广宇","can_delete":false,"product_type":"c1","uid":1248960,"ip_address":"","ucode":"FC4F73F683937E","user_header":"https://static001.geekbang.org/account/avatar/00/13/0e/c0/ec9dcece.jpg","comment_is_top":false,"comment_ctime":1597142608,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597142608","product_id":100020801,"comment_content":"老师，不知道你现在还会回复吗？我想问问你这个课程是不是需要有一定的工作经验啊，感觉越来越看不懂了😂","like_count":0},{"had_liked":false,"id":235803,"user_name":"Adong0678","can_delete":false,"product_type":"c1","uid":1985184,"ip_address":"","ucode":"845EECDFDE6233","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/GjFJHox9V8qh53zIrExw4NK0KG9WBvRH8RJVjm9jp78RSpWfa2xzyq11dTNItpK2icQniaK4bibTv6ksRGiasjTvMg/132","comment_is_top":false,"comment_ctime":1595207298,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1595207298","product_id":100020801,"comment_content":"“备库 B 的 (5,4) 和主库 A 的 (5,5) 这两行数据，都不会被对方执行。” row 模式 ，是备库 B 的 （4、5）和主库 A 的 (4、4）这两行数据，都不会被对方执行。？","like_count":0},{"had_liked":false,"id":234068,"user_name":"静静聆听","can_delete":false,"product_type":"c1","uid":1263932,"ip_address":"","ucode":"0A8600CB928EFE","user_header":"https://static001.geekbang.org/account/avatar/00/13/49/3c/5d54c510.jpg","comment_is_top":false,"comment_ctime":1594569922,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594569922","product_id":100020801,"comment_content":"老师，用从库做全量备份的话，误删数据也会同步的吧，所以还是要有全量备份的文件吧","like_count":0},{"had_liked":false,"id":214877,"user_name":"Geek_mango","can_delete":false,"product_type":"c1","uid":1526460,"ip_address":"","ucode":"C9B4FD825065B5","user_header":"https://static001.geekbang.org/account/avatar/00/17/4a/bc/21b36468.jpg","comment_is_top":false,"comment_ctime":1588840792,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588840792","product_id":100020801,"comment_content":"1.老师，原文中的这句话“试想如果一开始主备延迟就长达 30 分钟，而不先做判断直接切换的话，系统的不可用时间就会长达 30 分钟，这种情况一般业务都是不可接受的。”，和我的理解有些不一样<br>2.按照文章的意思“备库取出当前正在执行的事务的时间字段的值，计算它与当前系统时间的差值，得到 seconds_behind_master。”<br>3.主备延迟30分钟意思就是备库正在执行的事务与当前系统时间差30分钟对吧？<br>4.此时发生切换，主备都为read-only，那么不可用时间就是从库追上主库的时间（追上立马切换），这个时间与很多因素有关（老师可以帮忙分析下主要因素）但是不是确切的30分钟吧？<br>5.以前有测试过手动主备延迟，在延迟1000秒左右时（手动关闭从库同步线程造成）从库恢复只需要十秒以内，当然从库关闭期间没有进行大量读写情况下。<br>6.所以说主备延迟时间和切换时系统不可用时间不是完全一致的，或者说主备延迟时间不能直接决定切换时系统不可同时间。<br>老师看看我说的有没有啥问题。","like_count":0},{"had_liked":false,"id":213664,"user_name":"dawn","can_delete":false,"product_type":"c1","uid":1296063,"ip_address":"","ucode":"1757B28F1EF5C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/c6/bf/52b3f71d.jpg","comment_is_top":false,"comment_ctime":1588504443,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1588504443","product_id":100020801,"comment_content":"主备切换的时候为什么不等到备库的seconds_behind_master为0的时候再切换，这样既保证了可靠性，不可用时间也会非常短。","like_count":0,"discussions":[{"author":{"id":1303322,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e3/1a/061e77b6.jpg","nickname":"亢星东","note":"","ucode":"5E4063E83B2BB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328963,"discussion_content":"先保证数据可靠性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606287843,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":203225,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1586158324,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586158324","product_id":100020801,"comment_content":"持续有大事物在执行会造成图6的现象吧","like_count":0},{"had_liked":false,"id":200674,"user_name":"隐","can_delete":false,"product_type":"c1","uid":1083651,"ip_address":"","ucode":"528AF8BA6278D6","user_header":"https://static001.geekbang.org/account/avatar/00/10/89/03/30f878ca.jpg","comment_is_top":false,"comment_ctime":1585635219,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585635219","product_id":100020801,"comment_content":"请问老师的图是用什么软件画的，自己想要在工作中画类似于数据库的这种图好费时间又不美观。","like_count":0},{"had_liked":false,"id":170659,"user_name":"极客-绝影","can_delete":false,"product_type":"c1","uid":1243369,"ip_address":"","ucode":"D302CE68123E74","user_header":"https://static001.geekbang.org/account/avatar/00/12/f8/e9/f16a536b.jpg","comment_is_top":false,"comment_ctime":1578654804,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578654804","product_id":100020801,"comment_content":"老师讲的主从延迟分析的是从主库和从库，关于网络引起的延迟，可以调整二个参数<br> master_connect_retry   主从连接失败间隔多久重试的时间  默认是60秒<br> slave_net_timeout   当slave从主数据库读取log数据失败后，等待多久重新建立连接","like_count":0},{"had_liked":false,"id":167364,"user_name":"握不住手中沙","can_delete":false,"product_type":"c1","uid":1097132,"ip_address":"","ucode":"F194E47C4D42C9","user_header":"https://static001.geekbang.org/account/avatar/00/10/bd/ac/49494ed8.jpg","comment_is_top":false,"comment_ctime":1577775989,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577775989","product_id":100020801,"comment_content":"思考题：<br>seconds_behind_master呈线性增长，从库在恢复能力不受影响的情况下，说明此时有大量数据需要执行同步，主库可能存在大事务执行或者大量数据更新和删除操作存在","like_count":0},{"had_liked":false,"id":165823,"user_name":"我不吃甜食","can_delete":false,"product_type":"c1","uid":1086808,"ip_address":"","ucode":"1718E6D78F2852","user_header":"https://static001.geekbang.org/account/avatar/00/10/95/58/95e9507d.jpg","comment_is_top":false,"comment_ctime":1577327458,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577327458","product_id":100020801,"comment_content":"老师，可靠性策略和可用性策略具体是怎么实现的呢？1. 是通过业务程序实现？2. Mysql有参数可以配置？3. DBA根据seconds_behind_master，人工介入？","like_count":0},{"had_liked":false,"id":164258,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1576917546,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1576917546","product_id":100020801,"comment_content":"每个 binlog日志都会有一个事务的时间，这时候如果主库的时间时区改了，那么从库的 seconds_behind_master 时间不就计算有问题了呢？<br><br>是不是说关于数据库的时区不要轻易改动的，这个会影响 binlog ？","like_count":0},{"had_liked":false,"id":160780,"user_name":"遇见","can_delete":false,"product_type":"c1","uid":1624590,"ip_address":"","ucode":"FAF53CD4C28494","user_header":"https://static001.geekbang.org/account/avatar/00/18/ca/0e/5009c5ff.jpg","comment_is_top":false,"comment_ctime":1576031965,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576031965","product_id":100020801,"comment_content":"从结果来看, 从库拿到主库的binlog之后,如果此时从库有插入操作, 先执行插入操作, 再应用relay log.<br><br>因为插入操作插入的(4,5), relay log中记录的是(4,4), 所以从库duplicate key error<br><br>因为从库的插入操作, 写入bin log是(4,5), 主库从从库同步过来的binlog 写入relay log中, 要执行的是插入(4,5), 但是主库已经有一个数据是(4,4)了, 所以主库duplicate key error<br><br>不知道是不是有不对的地方.","like_count":0},{"had_liked":false,"id":159014,"user_name":"又双叒叕是一年啊","can_delete":false,"product_type":"c1","uid":1000015,"ip_address":"","ucode":"E067320E537DEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","comment_is_top":false,"comment_ctime":1575515359,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575515359","product_id":100020801,"comment_content":"MySQL 有没有既能保证数据一致性 又 能保证 主从高可用 切换的 稳定开源方案呢？ 老师推荐哪个","like_count":0},{"had_liked":false,"id":153686,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574297295,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574297295","product_id":100020801,"comment_content":"回答问题：binlog是以事务为原子写入的，事务在备库上执行时间长，SBM就长。耗时长的事务有对大量数据的DML，对大表的DDL，以及备库机器性能比主库差或负载高，导致同一个事务，在主上耗时1S，在备上可能耗时2S","like_count":1},{"had_liked":false,"id":153677,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574296472,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574296472","product_id":100020801,"comment_content":"C与A不可兼得<br>C是数据一致，而数据复制是有时间成本的（但貌似可以用磁盘冗余陈列可以提高这个速度？但两者很可能还是有时间差的），这个时间成本就是不可用时间，主备切换时，SBM slave behind master不可能为0，SBM即文中的T3-T1，发起切换，要等待T3-T1时间，使新主完成relay log的回放，此时间内系统只读，不可写，即写不可用。<br>A是可用性，若要保证A，就是在切换后让B立即可写，而这时，relay log还没重放完，会出现重放relay log和业务写入并行执行，有可能导致A与B数据不一致","like_count":0},{"had_liked":false,"id":153676,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574296351,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574296351","product_id":100020801,"comment_content":"老师，我有个问题，用磁盘RAID1是不是就可以实现MySQL实时复制啊，两块磁盘写入内容一样，主库用一块，备库用另一块。那这样，是否可以代替MySQL用relay log那套复制机制呢？","like_count":0},{"had_liked":false,"id":153645,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574293380,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1574293380","product_id":100020801,"comment_content":"可靠性优先和可用性优先，就是CAP中的C和A吧","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":166451,"discussion_content":"可以这么理解。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581397672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129357,"user_name":"MrVito","can_delete":false,"product_type":"c1","uid":1252169,"ip_address":"","ucode":"716FF6F8871706","user_header":"https://static001.geekbang.org/account/avatar/00/13/1b/49/ddefc656.jpg","comment_is_top":false,"comment_ctime":1567094881,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567094881","product_id":100020801,"comment_content":"这个直线就是sbm线性增长了，也就是说，这里面可能是事务执行很久，每次想备份都要执行一次长事务，就时间很长","like_count":0},{"had_liked":false,"id":120315,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1564826660,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564826660","product_id":100020801,"comment_content":"所有的高可用系统都是分布式的，数据通过网络从一个地方到另一个地方，总免不了会有一个时间差的，对人无感知的不算有延迟。让人有感知了，就需要解决了，否则就奇怪了。<br>如果现在发现主备数据不一致了，怎么快速定位到问题的原因呢？","like_count":0},{"had_liked":false,"id":112005,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1562652827,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562652827","product_id":100020801,"comment_content":"请问一下老师有好用的开源ha系统吗？我在网上找了半天没找到。","like_count":0},{"had_liked":false,"id":109386,"user_name":"灵犀andy","can_delete":false,"product_type":"c1","uid":1334527,"ip_address":"","ucode":"3C3C36B070676C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/WuVCibYmuGqFLnfIrr0BmkdzHwkialB0DibJ0YnymNNO2Wicy76ZxSvjD66sPVsd9SjkicSS4Z2iadTeOn7zGfwh9sxg/132","comment_is_top":false,"comment_ctime":1562029104,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562029104","product_id":100020801,"comment_content":"（主库配置）sync_binlog=1，每次commit都会刷新到磁盘日志，如果sync_binlog=100，等待100次commit，再刷新到磁盘日志，这样的话，主从同步会不会延长啊（因为在等待100次commit，再刷盘）？","like_count":0},{"had_liked":false,"id":108139,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1561686443,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1561686443","product_id":100020801,"comment_content":"问题一：备库只是在连接到主库的时候通过 SELECT UNIX_TIMESTAMP() 函数计算出时间差值，还是每次执行 binlog 前都会计算一次时间差值？如果是前者，那在系统后续运行中，服务器的时间产生了不一致，还是会计算不准确吖。<br><br>问题二：可靠性优先策略的切换步骤中第 1 步和第 3 步的时间判断，会不会因为存在中转日志而产生误操作？<br>针对第 1 步有这场景：比如，现在备库执行的事务 A 的 SBM 为 3 秒，但是中转日志里还有一个大事务 B，假如 30 分钟，这时把主库改成只读了，写业务就得停止服务 30 分钟。<br>针对第 3 步有这场景：如果恰好连续几次看到备库的 SBM 都为 0，但实际上中转日志里还有事务没处理完，这时设置备库的 readonly 为 false，提供写服务。假设中转有个事务是将 id 为 1 的记录的字段 f 从 2 改为 5，这时来了一个新的写操作，对 id 为 1 的字段进行 f=f+1 操作。正常 f 应该是 6，但是中转日志后于新的写操作，现在变成了 5。<br>如果存在上面 2 种场景，还有没有其他方案，可以保证切换主备时，不会存在中转日志所带来的误操作。<br><br>谢谢老师！！​","like_count":0},{"had_liked":false,"id":104879,"user_name":"冥王星","can_delete":false,"product_type":"c1","uid":1311603,"ip_address":"","ucode":"CA43C381A69736","user_header":"https://static001.geekbang.org/account/avatar/00/14/03/73/38397da1.jpg","comment_is_top":false,"comment_ctime":1560862438,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560862438","product_id":100020801,"comment_content":"一、网络异常导致binlog传输延迟增加。二、备（从）库处理主库传来的binlog速度过慢，处理过慢的原因可能是备（从）库可能正在执行占用资源过多的读操作。","like_count":0},{"had_liked":false,"id":104272,"user_name":"Xianggg","can_delete":false,"product_type":"c1","uid":1201154,"ip_address":"","ucode":"6377F84FBB183D","user_header":"https://static001.geekbang.org/account/avatar/00/12/54/02/a9762d7e.jpg","comment_is_top":false,"comment_ctime":1560703073,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560703073","product_id":100020801,"comment_content":"老师，如果在主备切换时候设置不同步长，并且确保设置步长之前所有的thread的事务都提交，没有大长事务，binlog用row格式，这样是否可以做到高可用和高可靠呢","like_count":0},{"had_liked":false,"id":101794,"user_name":"库尔斯","can_delete":false,"product_type":"c1","uid":1085569,"ip_address":"","ucode":"BC2F220993C3ED","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIG210UcWicnKgOjBJC3CUxiaRImsiaqscVLyABrA4Kshm7hReicSuyRvfe1x07ydoT8WknNh2QLxU3rA/132","comment_is_top":false,"comment_ctime":1559974202,"is_pvip":false,"replies":[{"id":"36726","content":"但是这个大事务本身就要执行那么久的~","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1560040398,"ip_address":"","comment_id":101794,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1559974202","product_id":100020801,"comment_content":"&quot;&quot;大事务这种情况很好理解。因为主库上必须等事务执行完成才会写入 binlog，再传给备库。所以，如果一个主库上的语句执行 10 分钟，那这个事务很可能就会导致从库延迟 10 分钟。&quot;&quot;<br><br>老师 为什么大事务会导致从库延迟？ 如果从库是多线程的呢？<br>大事务执行的同时，其它的小事务还是可以提交并写binlog 并同步到从库，为什么就会延迟了呢？不太理解，希望老师指点","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453118,"discussion_content":"但是这个大事务本身就要执行那么久的~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560040398,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":99348,"user_name":"风中阿阳","can_delete":false,"product_type":"c1","uid":1301912,"ip_address":"","ucode":"98DD6475A51554","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/98/3fd7c5a1.jpg","comment_is_top":false,"comment_ctime":1559198012,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559198012","product_id":100020801,"comment_content":"请问一下老师   我们主从环境是5.6版本     也是因为主库大事务（存储过程或者大表查询）  导致主从出现延迟 ，果断时间会自动恢复，而且这个大失误还会导致主库锁表，事务执行时间很长，也会自动恢复。<br>我想问问怎么去处理这个问题呢？<br>1 主从采用读写分离，这样会不会好一点，大事务查询就不会锁表了，也不会影响业务了<br>2 研发优化查询，大事务sql<br>3 运维配置5.7，MHA  读写分离  从从 高可用keepalive+lvs","like_count":0},{"had_liked":false,"id":97465,"user_name":"还一棵树","can_delete":false,"product_type":"c1","uid":1317709,"ip_address":"","ucode":"C187F2A141D60E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eop9WylZJicLQxlvXukXUgPp39zJHyyReK5s1C9VhA6rric7GiarbfQMuWhdCCDdxdfL610Hc4cNkn9Q/132","comment_is_top":false,"comment_ctime":1558676377,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558676377","product_id":100020801,"comment_content":"疑问： 如果备库已经连接到主库，再对备库服务器时间调整，那这个调整是否影响Seconds_Behind_Master的值","like_count":0},{"had_liked":false,"id":94409,"user_name":"柳树","can_delete":false,"product_type":"c1","uid":1025223,"ip_address":"","ucode":"F03249D4534BCB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a4/c7/d1ee69c6.jpg","comment_is_top":false,"comment_ctime":1557802926,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557802926","product_id":100020801,"comment_content":"每个支持集群部署的软件，都需要在一致性和可用性之间寻找平衡，这篇文章描述了Mysql在这方面做的努力，CAP，P必须满足，剩下的，就是在C和A之间，寻找那个合适的度。","like_count":0},{"had_liked":false,"id":74302,"user_name":"轻歌赋","can_delete":false,"product_type":"c1","uid":1251574,"ip_address":"","ucode":"22F62446208805","user_header":"https://static001.geekbang.org/account/avatar/00/13/18/f6/2ff7bc7a.jpg","comment_is_top":false,"comment_ctime":1552184846,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552184846","product_id":100020801,"comment_content":"首先，能查到值说明备库还活着<br>其次，时间是线性函数说明函数起点开始必然有一个事务导致后续事务无法得到执行<br>猜测要么是大事务锁了很多，要么是ddl锁了整个表<br>网络应该不会断，因为这个时间是通过备库中对binlog的时间戳判断出来的","like_count":0},{"had_liked":false,"id":73801,"user_name":"gongxt","can_delete":false,"product_type":"c1","uid":1170750,"ip_address":"","ucode":"222C46E0615152","user_header":"https://static001.geekbang.org/account/avatar/00/11/dd/3e/c3028cd5.jpg","comment_is_top":false,"comment_ctime":1552005182,"is_pvip":false,"replies":[{"id":"27148","content":"这个比较奇怪诶，不过为了精确判断，还是用gtid或者位点吧","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1552147114,"ip_address":"","comment_id":73801,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1552005182","product_id":100020801,"comment_content":"老师好，我遇到一种情况：<br>利用sysbench大批量写入master，接着master故障，然后进行主从切换，从此时回放binlog事物日志，但是还没有回放完成我就看到了second_behind_master 为0的情况，这个是啥原因呀？<br>然后我只能使用另外的判断方式。判断是否已经回放完成，老师看到后还请解惑。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":442284,"discussion_content":"这个比较奇怪诶，不过为了精确判断，还是用gtid或者位点吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552147114,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":61695,"user_name":"cheriston","can_delete":false,"product_type":"c1","uid":1309984,"ip_address":"","ucode":"617CBFCE0925C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","comment_is_top":false,"comment_ctime":1547776477,"is_pvip":false,"replies":[{"id":"21899","content":"嗯嗯，看下28篇😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547782857,"ip_address":"","comment_id":61695,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547776477","product_id":100020801,"comment_content":"老师  seconds_behind_master=0 也不能100%代表主库与从库之间没有延迟 吧 ?","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436956,"discussion_content":"嗯嗯，看下28篇😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547782857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":59039,"user_name":"七七","can_delete":false,"product_type":"c1","uid":1301937,"ip_address":"","ucode":"277BACE2330C54","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/b1/7323beb9.jpg","comment_is_top":false,"comment_ctime":1547281936,"is_pvip":true,"replies":[{"id":"21368","content":"这个说的是迁移过程，<br>也就是说，一开始A是B的从库，后来迁移过程中，停止了A和B的主备关系，让A和A&#39;互为主备","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547293036,"ip_address":"","comment_id":59039,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547281936","product_id":100020801,"comment_content":"老师文章末尾思考题部分，有点困惑求解答。<br>循环复制我之前理解是B-&gt;A-&gt;A&#39;-&gt;B这样的拓扑结构。<br>而双M结构理解是A-&gt;A&#39;-&gt;A，此时A是A&#39;的主库和从库，B只能是A的从库。那么trx1在从库B上的更新就不会传给A。<br>文中是一种假设吗？还是我理解偏差了 ~<br><br>--------正文--------<br>trx1 是在节点 B 执行的，因此 binlog 上的 server_id 就是 B，binlog 传给节点 A，然后A 和 A’搭建了双 M 结构，就会出现循环复制。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436280,"discussion_content":"这个说的是迁移过程，\n也就是说，一开始A是B的从库，后来迁移过程中，停止了A和B的主备关系，让A和A&amp;#39;互为主备","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547293036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58666,"user_name":"任鹏斌","can_delete":false,"product_type":"c1","uid":1104086,"ip_address":"","ucode":"34319B05EA6E74","user_header":"https://static001.geekbang.org/account/avatar/00/10/d8/d6/47da34bf.jpg","comment_is_top":false,"comment_ctime":1547169897,"is_pvip":false,"replies":[{"id":"21214","content":"Impossible WHERE noticed after reading const tables<br><br>这个语句是不是执行结果是空？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547178474,"ip_address":"","comment_id":58666,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547169897","product_id":100020801,"comment_content":"老师好发现我们系统中一条sql写法比较独特<br>SELECT<br>    IF(ha.curricula_type = &#39;02&#39;<br>            AND ((cla.model_code IN (&#39;CM05004&#39; , &#39;CM05001&#39;)<br>            AND cla.is_vip_video = 1)<br>            OR cla.model_code = &#39;CM05008&#39;),<br>        &#39;1&#39;,<br>        &#39;0&#39;) AS &#39;isUK&#39;<br>FROM<br>    h_curricula ha,<br>    h_class cla<br>WHERE<br>    ha.`code` = &#39;2&#39; <br>\tAND cla.`code` =&#39;2&#39; <br>使用查询分析器后所有列都无信息显示，只在Extra列显示，<br>Impossible WHERE noticed after reading const tables，不知道如何分析其执行计划。<br>如果code列均为两个表的主键类型是varchar，想知道这种情况下是否会产生笛卡尔积？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436159,"discussion_content":"Impossible WHERE noticed after reading const tables\n\n这个语句是不是执行结果是空？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547178474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58487,"user_name":"风萧雨瑟","can_delete":false,"product_type":"c1","uid":1317323,"ip_address":"","ucode":"5E832ABE126393","user_header":"https://static001.geekbang.org/account/avatar/00/14/19/cb/70a2b47e.jpg","comment_is_top":false,"comment_ctime":1547089789,"is_pvip":false,"replies":[{"id":"21172","content":"先看看26篇，然后再下面留下你的理解和新的疑问哈😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547134379,"ip_address":"","comment_id":58487,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547089789","product_id":100020801,"comment_content":"老师问一下集群在开启并行复制的情况下：<br>主库参数：binlog_group_commit_sync_delay=1000；binlog_group_commit_sync_no_delay_count=10<br>从库：slave_parallel_type=LOGICAL_CLOCK；slave_parallel_workers=8<br>MySQL：社区版5.7.20<br>在从库上查看slave status的时Seconds_Behind_Master总是显示落后10-15，在有大量更新的情况下数据会一直增大，通过binlog来看的话Read_Master_Log_Pos 和Exec_Master_Log_Pos相差总是在1000+，甚至变大的更大。但将slave_parallel_type更改回默认值DATABASE时，Read_Master_Log_Pos 和Exec_Master_Log_Pos相差很小，甚至可以相同。<br>在不同的集群上开启并行复制都会出现相同的情况，但将slave_parallel_type更改回默认值DATABASE时都要比LOGICAL_CLOCK延迟情况要好。<br>更换5.7.24版本的情况下有同样的问题。<br>如果有两台从库，机器配置相同其它参数一样。一台设置成slave_parallel_type=DATABASE。而另一台设置成LOGICAL_CLOCK，不管是线上的表现还是通过sysbench压测来看，设置成LOGICAL_CLOCK的从库延迟确实要比DATABASE大一些。<br>这个情况从哪里排查一下？谢谢。<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436088,"discussion_content":"先看看26篇，然后再下面留下你的理解和新的疑问哈😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547134379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58485,"user_name":"Chris","can_delete":false,"product_type":"c1","uid":1307745,"ip_address":"","ucode":"59588114490F57","user_header":"https://static001.geekbang.org/account/avatar/00/13/f4/61/cfdd9e55.jpg","comment_is_top":false,"comment_ctime":1547089734,"is_pvip":false,"replies":[{"id":"21185","content":"看着好像是磁盘问题了，你这个是5.7的哪个小版本？<br>还有，尽量不要用windows系统哦😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547140702,"ip_address":"","comment_id":58485,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547089734","product_id":100020801,"comment_content":"老师，咨询个问题，现在遇到一个问题，mysql数据库总是crash，重新启动服务又正常，然后运行一段时间又会crash，报错如下InnoDB: Assertion failure in thread 6792 in file fil0fil.cc line 5805<br>InnoDB: Failing assertion: err == DB_SUCCESS<br>InnoDB: We intentionally generate a memory trap.<br>InnoDB: Submit a detailed bug report to http:&#47;&#47;bugs.mysql.com.<br>InnoDB: If you get repeated assertion failures or crashes, even<br>InnoDB: immediately after the mysqld startup, there may be<br>InnoDB: corruption in the InnoDB tablespace. Please refer to<br>InnoDB: http:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;5.7&#47;en&#47;forcing-innodb-recovery.html<br>InnoDB: about forcing recovery.<br>08:52:33 UTC - mysqld got exception 0x80000003 ;<br>This could be because you hit a bug. It is also possible that this binary<br>or one of the libraries it was linked against is corrupt, improperly built,<br>or misconfigured. This error can also be caused by malfunctioning hardware.<br>Attempting to collect some information that could help diagnose the problem.<br>As this is a crash and something is definitely wrong, the information<br>collection process might fail.<br><br>key_buffer_size=8388608<br>read_buffer_size=131072<br>max_used_connections=60<br>max_threads=151<br>thread_count=45<br>connection_count=45<br>It is possible that mysqld could use up to <br>key_buffer_size + (read_buffer_size + sort_buffer_size)*max_threads = 68010 K  bytes of memory<br>Hope that&#39;s ok; if not, decrease some variables in the equation.<br><br>Thread pointer: 0x0<br>Attempting backtrace. You can use the following information to find out<br>where mysqld died. If you see no messages after this, something went<br>terribly wrong...<br>13f9b9812    mysqld.exe!my_sigabrt_handler()[my_thr_init.c:449]<br>13fd5e349    mysqld.exe!raise()[winsig.c:587]<br>13fd5d240    mysqld.exe!abort()[abort.c:82]<br>13fab9b08    mysqld.exe!ut_dbg_assertion_failed()[ut0dbg.cc:67]<br>13fae06da    mysqld.exe!fil_aio_wait()[fil0fil.cc:5807]<br>13fa7eb84    mysqld.exe!io_handler_thread()<br>The manual page at http:&#47;&#47;dev.mysql.com&#47;doc&#47;mysql&#47;en&#47;crashing.","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436086,"discussion_content":"看着好像是磁盘问题了，你这个是5.7的哪个小版本？\n还有，尽量不要用windows系统哦😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547140702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58476,"user_name":"考拉出山","can_delete":false,"product_type":"c1","uid":1303954,"ip_address":"","ucode":"917E35FD7B2D06","user_header":"https://wx.qlogo.cn/mmopen/vi_32/1mOvT5fApeicXppMP3zADG6XIPicNt5D9dL6y46SF5UUcH0hicG21LM6xSgHJj5oAdzCyeGtLZYHYmlvaFwecrGOA/132","comment_is_top":false,"comment_ctime":1547088295,"is_pvip":false,"replies":[{"id":"21170","content":"1. 因为groupType没有索引，所以全表扫描，并在primary key上加上所有next-key lock，所以会在锁id=2这一行，被锁住；<br>2. 是不是打错了？delete from t_my_user where type = 6; 能通过，是因为这个语句锁的是 type这个索引上(2, suprenum)，这个没有锁冲突<br>3. 这样的情况下两个锁都还在，都在事务提交的时候释放。是在“duplicate-key error occurs”才会尝试添加S锁。","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547134236,"ip_address":"","comment_id":58476,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547088295","product_id":100020801,"comment_content":"你好，想问几个不明了的与平时遇到的问题：<br>CREATE TABLE `t_my_user` (<br>  `id` bigint(20) NOT NULL,<br>  `type` int(11) NOT NULL,<br>  `groupType` int(11) NOT NULL,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `unique-type` (`type`) USING BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br>INSERT INTO t_my_user(`id`, `type`, `groupType`) VALUES (1, 1, 1),(2, 2, 2),(3, 3, 3);<br><br>RC事务隔离级别<br>(session-A)begin;<br>(session-B)begin;<br>(session-A)update t_my_user set type = 4 where type =2;<br>(session-B) delete from t_my_user where groupType = 6;<br>结果是session-B 处于fetching rows  LOCK WAIT 等待session-A;<br>问题1：mysql delete是会扫描记录加锁然后过滤适配记录再释放X锁吗？是一次性全表先加X锁，还是一边逐行扫描加锁，然后过滤，释放？为什么扫描过滤不先加S锁，发现满足条件再变为X锁呢。<br>问题2：session-B换成(delete from t_my_user where groupType = 6;) 则不会阻塞，除非命中记录，update不需要加锁过滤？<br><br>(session-A)begin;<br>select * from t_my_user where type = 2 lock in SHARE mode;<br>update t_my_user set type = 4 where type =2;<br>结果是顺利执行；<br>问题3：第一步获取了S锁，第二部获取了X锁，这个过程是怎么样的呢？ S锁升级为X锁？还是先释放S锁，再获取X锁，难道不用提交事务也可以释放锁吗？<br><br>(session-A)begin;<br>(session-B)begin;<br>(session-C)begin;<br>(session-A)INSERT INTO t_my_user(`id`, `type`, `groupType`) VALUES (4, 4, 4);<br>(session-B)INSERT INTO t_my_user(`id`, `type`, `groupType`) VALUES (5, 4, 4);<br>(session-C)INSERT INTO t_my_user(`id`, `type`, `groupType`) VALUES (6, 4, 4);<br>结果是：session-A 执行  session-B&#47;session-C Lock Mode S  Lock Wait X ,等待session-A；<br>官方文档有如下解释“If a duplicate-key error occurs, a shared lock on the duplicate index record is set.”；<br>为什么要添加S锁呢？没有找到相关解释。网上有解释说是插入语句会先在唯一索引上添加S锁进行唯一性检查，再变为X锁？ 还是只有在“duplicate-key error occurs”才会尝试添加S锁<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436079,"discussion_content":"1. 因为groupType没有索引，所以全表扫描，并在primary key上加上所有next-key lock，所以会在锁id=2这一行，被锁住；\n2. 是不是打错了？delete from t_my_user where type = 6; 能通过，是因为这个语句锁的是 type这个索引上(2, suprenum)，这个没有锁冲突\n3. 这样的情况下两个锁都还在，都在事务提交的时候释放。是在“duplicate-key error occurs”才会尝试添加S锁。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547134236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58467,"user_name":"nero","can_delete":false,"product_type":"c1","uid":1110627,"ip_address":"","ucode":"BACD4A95B5FA09","user_header":"https://static001.geekbang.org/account/avatar/00/10/f2/63/1f495e51.jpg","comment_is_top":false,"comment_ctime":1547086975,"is_pvip":false,"replies":[{"id":"21137","content":"单位是秒，应该还好啦^_^","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547121091,"ip_address":"","comment_id":58467,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547086975","product_id":100020801,"comment_content":"老师请教下：备库连接到主库的时候，会通过执行 SELECT UNIX_TIMESTAMP() 函数来获得当前主库的系统时间。这个时间也不是很准确吧，没有网络延时吗<br>","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436074,"discussion_content":"单位是秒，应该还好啦^_^","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547121091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58449,"user_name":"春困秋乏夏打盹","can_delete":false,"product_type":"c1","uid":1210807,"ip_address":"","ucode":"CCC558EF504F4B","user_header":"https://static001.geekbang.org/account/avatar/00/12/79/b7/989824f7.jpg","comment_is_top":false,"comment_ctime":1547084940,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1547084940","product_id":100020801,"comment_content":"(Master_Log_file, Read_Master_Log_Pos): Coordinates in the master binary log indicating how far the slave I&#47;O thread has read events from that log.\t<br>(Relay_Master_Log_File, Exec_Master_Log_Pos): Coordinates in the master binary log indicating how far the slave SQL thread has executed events received from that log.<br>(Relay_Log_File, Relay_Log_Pos): Coordinates in the slave relay log indicating how far the slave SQL thread has executed the relay log. These correspond to the preceding coordinates, but are<br>expressed in slave relay log coordinates rather than master binary log coordinates.\t<br>清楚了","like_count":0},{"had_liked":false,"id":58371,"user_name":"ProgramGeek","can_delete":false,"product_type":"c1","uid":1008217,"ip_address":"","ucode":"3F0E3963C4FB57","user_header":"https://static001.geekbang.org/account/avatar/00/0f/62/59/a01a5ddd.jpg","comment_is_top":false,"comment_ctime":1547046065,"is_pvip":false,"replies":[{"id":"21037","content":"你把复现步骤写下哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547064218,"ip_address":"","comment_id":58371,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547046065","product_id":100020801,"comment_content":"在分区表里KEY分区中使用关键字LINEAR具有同样的作用，也就是LINEAR KEY分区时，分区的编号是通过2的幂算法得到的，而不是通过取模得到的。为什么奇数分区不能插入数据呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436031,"discussion_content":"你把复现步骤写下哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547064218,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58344,"user_name":"ProgramGeek","can_delete":false,"product_type":"c1","uid":1008217,"ip_address":"","ucode":"3F0E3963C4FB57","user_header":"https://static001.geekbang.org/account/avatar/00/0f/62/59/a01a5ddd.jpg","comment_is_top":false,"comment_ctime":1547041202,"is_pvip":false,"replies":[{"id":"21021","content":"额，这个要看报什么错哦","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547044594,"ip_address":"","comment_id":58344,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547041202","product_id":100020801,"comment_content":"咨询个问题，就是MySQL奇数分区无法插入数据，偶数分区能够插入数据，可能是由于什么原因导致的？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436022,"discussion_content":"额，这个要看报什么错哦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547044594,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58315,"user_name":"张永志","can_delete":false,"product_type":"c1","uid":1208727,"ip_address":"","ucode":"E54B75EF3F63B3","user_header":"https://static001.geekbang.org/account/avatar/00/12/71/97/f1a3d398.jpg","comment_is_top":false,"comment_ctime":1547035351,"is_pvip":false,"replies":[{"id":"21012","content":"后面有一篇会讲到😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547043015,"ip_address":"","comment_id":58315,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547035351","product_id":100020801,"comment_content":"主库的请求是多用户并发多线程执行，当主库比较繁忙，由于从库是当线程执行，效率没有主库多线程高，就会出现延迟。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436008,"discussion_content":"后面有一篇会讲到😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547043015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58239,"user_name":"inh556","can_delete":false,"product_type":"c1","uid":1247111,"ip_address":"","ucode":"D676205E0790D5","user_header":"https://static001.geekbang.org/account/avatar/00/13/07/87/ca681a71.jpg","comment_is_top":false,"comment_ctime":1547016078,"is_pvip":false,"replies":[{"id":"20976","content":"是说同一个表的同一个字段？同一个字段只会有一种定义呀","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547018010,"ip_address":"","comment_id":58239,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547016078","product_id":100020801,"comment_content":"老师，如果一个table都有一个叫做id的值，会出现值得类型不一致吗？比如有的id是整数 1， 而有的是字符串‘ 1’。 为什么会这样？这个问题对数据存储和查询结果有哪些影响？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435967,"discussion_content":"是说同一个表的同一个字段？同一个字段只会有一种定义呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547018010,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}