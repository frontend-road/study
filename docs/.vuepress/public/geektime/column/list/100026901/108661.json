{"id":108661,"title":"32 | 答疑（三）：如何选择合适的异常处理方式？","content":"<p>你好，我是景霄。</p><p>不知不觉中，我们又一起完成了第三大章规范篇的学习。我非常高兴看到很多同学一直在坚持积极地学习，并且留下了很多高质量的留言，值得我们互相思考交流。也有一些同学反复推敲，指出了文章中一些表达不严谨或是不当的地方，我也表示十分感谢。</p><p>大部分留言，我都在相对应的文章中回复过了。而一些手机上不方便回复，或是很有价值很典型的问题，我专门摘录了出来，作为今天的答疑内容，集中回复。</p><h2>问题一：应该使用哪种异常处理方式？</h2><p><img src=\"https://static001.geekbang.org/resource/image/c7/42/c766890764672c7c924092d9dfd0c942.png?wh=1418*368\" alt=\"\"></p><p>第一个问题是code2同学的疑惑。下面这两种处理的风格，哪一种风格更有效、更优雅？</p><ul>\n<li>第一种，在代码中对数据进行检测，并直接处理与抛出异常。</li>\n<li>第二种，在异常处理代码中进行处理。</li>\n</ul><p>其实，第一种方法，可以翻译成下面的“if…elif…”语句：</p><pre><code>if [condition1]:\n    raise Exception1('exception 1')\nelif [condition2]:\n    raise Exception2('exception 2')\n...\n</code></pre><p>而第二种方法，则对应着下面异常处理的代码：</p><pre><code>try:\n    ...\nexcept Exception as e:\n    ...\n</code></pre><p>这两种方法很大的一个区别是，第一种方法一旦抛出异常，那么程序就会终止；而在第二种方法中，如果抛出异常，会被程序捕获（catch），程序还会继续运行。这也是我们选择这两种方法的重要依据。当然，在实际工作中，到底使用哪一种方法，还是取决于具体的场景。</p><p>比方说，一个模块的功能是对输入进行检测，如果输入不合法，则弹出对话框进行提示，并终止程序。那么，这种情况下，使用第一种方法更加合理。</p><!-- [[[read_end]]] --><p>但是，如果换成一个产品的服务器端，它需要应对各种可能发生的情况，以保证服务器不崩溃。比如在连接数据库时，如果网络异常，无法连接，那就需要捕获（catch）这个异常（exception），进行记录，并同时保证其他功能不受影响。这种情况下，我们通常会选择第二种方式。</p><h2>问题二：先写出能跑起来的代码，后期再优化可以吗？</h2><p><img src=\"https://static001.geekbang.org/resource/image/d5/b0/d5efddbe80757e61e33596ce41440bb0.png?wh=1436*586\" alt=\"\"></p><p>第二个问题，夜路破晓同学提到了很多程序员传授的“经验之谈”，即先写出能跑起来的代码，后期再优化。很明显，这种认知是错误的。我们从一开始写代码时，就必须对功能和规范这两者双管齐下。</p><p>代码功能完整和规范完整的优先级是不分先后的，应该是同时进行的。如果你一开始只注重代码的功能完整，而不关注其质量、规范，那么规范问题很容易越积越多。这样就会导致产品的bug越来越多，相应的代码库越发难以维护，到最后不得已只能推倒重来。</p><p>我在Facebook工作时就遇到过这样的情况，参与过类似的项目。当时，某些功能模块因为赶时间，code review很宽松，代码写得很不规范，留下了隐患。时间一长，bug越来越多，legacy越来越多。到最后，万分无奈的情况下，我们几个工程师专门立项，花了三个多月时间，重写了这一模块的代码，才解决了这个问题。</p><h2>问题三：代码中写多少注释才合适？</h2><p><img src=\"https://static001.geekbang.org/resource/image/f2/71/f22b2ec07051b244ed4a852189745671.png?wh=1464*364\" alt=\"\"></p><p>第三个问题，小侠龙旋风同学留言说，自己的同事要求代码中有70%的注释，这显然有点过了。但是反过来说，如果你的代码中没有注释或者注释很少，仅凭规范的变量名肯定是远远不够的。</p><p>通常来说，我们会在类的开头、函数的开头或者是某一个功能块的开头加上一段描述性的注释，来说明这段代码的功能，并指明所有的输入和输出。除此之外，我们也要求在一些比较tricky的代码上方加上注释，帮助阅读者理解代码的含义。</p><p>总的来说，代码中到底需要有多少注释，其实并没有一个统一的要求，还是要根据代码量和代码的复杂度来决定。不过，我们平常书写时，只要满足这样的规范就可以了。</p><p>另外，必须提醒一点，如果在写好之后修改了代码，那么代码对应的注释一定也要做出相应的修改，不然很容易造成“文不对题”的现象，给别人也给你自己带来困扰。</p><h2>问题四：项目的API文档重要吗？</h2><p><img src=\"https://static001.geekbang.org/resource/image/fc/c5/fc59ac08ab33764afa439056e75acac5.png?wh=1450*374\" alt=\"\"></p><p>第四个问题，是未来已来同学的留言。他提到了项目的API文档的问题，这一点说得非常好，在这里我也简单介绍一下。</p><p>我在专栏中主要讲的是代码的规范问题，但很多情况下，光有规范的代码还是远远不够的。因为一个系统，一个产品，甚至一个功能模块的代码，都有可能非常复杂。少则几千行，动辄几十万行，尤其是对于刚加入的新人来说，在ramp up阶段光看代码可能就是一个噩梦了。</p><p>因此，在这方面做得比较规范的公司，通常也会要求书写文档。项目的文档，主要是对相应的系统、产品或是功能模块做一个概述，有助于后人理解。以一个service为例，其对应的文档通常会包括下面几部分：</p><ul>\n<li>第一点，系统的概述，包括各个组成部分以及工作流程的介绍；</li>\n<li>第二点，每个组成部分的具体介绍，包括必要性、设计原理等等；</li>\n<li>第三点，系统的performance，包括latency等等参数；</li>\n<li>第四点主要说明如何对系统的各个部分进行修改，主要给出相应的code pointer及对应的测试方案。</li>\n</ul><p>这些内容，也希望屏幕前的你能够牢记。</p><p>今天我主要回答这些问题，同时也欢迎你继续在留言区写下疑问和感想，我会持续不断地解答。希望每一次的留言和答疑，都能给你带来新的收获和价值。</p><p></p>","neighbors":{"left":{"article_title":"31 | pdb & cProfile：调试和性能分析的法宝","id":108350},"right":{"article_title":"33 | 带你初探量化世界","id":109128}},"comments":[{"had_liked":false,"id":116055,"user_name":"Geek_d848f7","can_delete":false,"product_type":"c1","uid":1524021,"ip_address":"","ucode":"F24BC59B6E9E6B","user_header":"","comment_is_top":false,"comment_ctime":1563779212,"is_pvip":false,"replies":[{"id":"42604","content":"这个你去github上找些popular的项目就可以啦","user_name":"作者回复","user_name_real":"Jingxiao","uid":"1259521","ctime":1563858501,"ip_address":"","comment_id":116055,"utype":1}],"discussion_count":1,"race_medal":0,"score":"57398354060","product_id":100026901,"comment_content":"老师，结合我们这段时间的学习，有没有短小精悍的项目推荐，想学习别人怎么组织代码","like_count":14,"discussions":[{"author":{"id":1259521,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJOlibibPFEWOib8ib7RtfAtxND5FUqCxxoeTuLAbBI9ic23xuwdXT4IyiaWq3Fic9RgEAYI0lBTbEp2rcg/132","nickname":"Jingxiao","note":"","ucode":"EB966BB87132F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459369,"discussion_content":"这个你去github上找些popular的项目就可以啦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563858501,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115841,"user_name":"enjoylearning","can_delete":false,"product_type":"c1","uid":1000237,"ip_address":"","ucode":"DCAF8538DEA277","user_header":"https://static001.geekbang.org/account/avatar/00/0f/43/2d/af86d73f.jpg","comment_is_top":false,"comment_ctime":1563756944,"is_pvip":false,"replies":[{"id":"42603","content":"测试的话postman就可以了。具体工程中python一般用dijando或者flask的框架","user_name":"作者回复","user_name_real":"Jingxiao","uid":"1259521","ctime":1563858460,"ip_address":"","comment_id":115841,"utype":1}],"discussion_count":5,"race_medal":0,"score":"48808397200","product_id":100026901,"comment_content":"有没有web api的好工具推荐呢，虽然在用swagger，但感觉集成到项目侵入性太强，不优雅","like_count":12,"discussions":[{"author":{"id":1259521,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJOlibibPFEWOib8ib7RtfAtxND5FUqCxxoeTuLAbBI9ic23xuwdXT4IyiaWq3Fic9RgEAYI0lBTbEp2rcg/132","nickname":"Jingxiao","note":"","ucode":"EB966BB87132F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459310,"discussion_content":"测试的话postman就可以了。具体工程中python一般用dijando或者flask的框架","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563858460,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1401377,"avatar":"https://static001.geekbang.org/account/avatar/00/15/62/21/7a382e8f.jpg","nickname":"若未","note":"","ucode":"DFC63F476793A9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547501,"discussion_content":"yapi","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642721207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104850,"avatar":"https://static001.geekbang.org/account/avatar/00/10/db/d2/e29f8834.jpg","nickname":"lidashuang","note":"","ucode":"560ABE8032760E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332124,"discussion_content":"挺好的文档就用swagger","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607069755,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1000237,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/43/2d/af86d73f.jpg","nickname":"enjoylearning","note":"","ucode":"DCAF8538DEA277","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3165,"discussion_content":"那api的设计呢？用word描述吗？这样前后端合作还是不太顺畅，而且后端改了api接口还要手动同步word，不知道postman是否支持搭建mock 服务器让前端测试用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564241333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1524797,"avatar":"https://static001.geekbang.org/account/avatar/00/17/44/3d/35d6670d.jpg","nickname":"Claywoow","note":"","ucode":"1F1C70BCE33536","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2596,"discussion_content":"postman 可以了解一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563782042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119897,"user_name":"姜饼人","can_delete":false,"product_type":"c1","uid":1026263,"ip_address":"","ucode":"642BE844DB77E3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a8/d7/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1564723196,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"31629494268","product_id":100026901,"comment_content":"老师，能不能介绍一下你在FB的时候，关于jupyter notebook的一些规范和风格，和最佳实践","like_count":8,"discussions":[{"author":{"id":1313840,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0c/30/bb4bfe9d.jpg","nickname":"lyonger","note":"","ucode":"E89A75DADEA2A1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307192,"discussion_content":"同想了解呀。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600526282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117021,"user_name":"Michael","can_delete":false,"product_type":"c1","uid":1118976,"ip_address":"","ucode":"35F4FFAC4A4B15","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/00/a4a2065f.jpg","comment_is_top":false,"comment_ctime":1563956313,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31628727385","product_id":100026901,"comment_content":"项目中结合：isort, flake8(pylint), black(yapf), pytest, mypy 这些工具，写出来的代码在质量上肯定有不少的提升","like_count":8},{"had_liked":false,"id":115799,"user_name":"","can_delete":false,"product_type":"c1","uid":1322330,"ip_address":"","ucode":"FA2983C5AD320C","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/5a/cc637589.jpg","comment_is_top":false,"comment_ctime":1563750903,"is_pvip":false,"replies":[{"id":"42605","content":"这个看具体需求，一般来说都会打印的，但是会downsample，比如每1000次打印一次，减小服务器压力","user_name":"作者回复","user_name_real":"Jingxiao","uid":"1259521","ctime":1563858602,"ip_address":"","comment_id":115799,"utype":1}],"discussion_count":2,"race_medal":0,"score":"27333554679","product_id":100026901,"comment_content":"老师，对于异常捕获选择异常条件有什么技巧吗？不太会去选择。对于服务端，我的异常打印到日志文件中，是全部异常都打印，还是筛选出具体异常的位置进行打印？","like_count":7,"discussions":[{"author":{"id":1259521,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJJOlibibPFEWOib8ib7RtfAtxND5FUqCxxoeTuLAbBI9ic23xuwdXT4IyiaWq3Fic9RgEAYI0lBTbEp2rcg/132","nickname":"Jingxiao","note":"","ucode":"EB966BB87132F6","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459292,"discussion_content":"这个看具体需求，一般来说都会打印的，但是会downsample，比如每1000次打印一次，减小服务器压力","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563858602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1128146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/36/d2/32d3545a.jpg","nickname":"A.Windy","note":"","ucode":"254868B270F26D","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2528,"discussion_content":"如果是明确知道的异常，打信息摘要就行，还要把上下文参数也打一下，方便排查，","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1563760935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115969,"user_name":"小侠龙旋风","can_delete":false,"product_type":"c1","uid":1126441,"ip_address":"","ucode":"073F3924A99835","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/29/d6816ebf.jpg","comment_is_top":false,"comment_ctime":1563769801,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10153704393","product_id":100026901,"comment_content":"谢谢老师的问答，请问，有没有写得比较好的API案例推荐。","like_count":2},{"had_liked":false,"id":250712,"user_name":"Geek_6e549c","can_delete":false,"product_type":"c1","uid":2107422,"ip_address":"","ucode":"12A3B4EAA6FB9B","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7mia5D2IR8K1ZGeEVEicoNW2ibnroAyiamJOhL61rW6vkRjjtGLTFxiaibrPotktqov7Kgeoe2U5gT9mQgRXImpQ7O6A/132","comment_is_top":false,"comment_ctime":1601200624,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5896167920","product_id":100026901,"comment_content":"游戏开发更迭快 从来没有文档","like_count":1},{"had_liked":false,"id":239579,"user_name":"Geek_aa780e","can_delete":false,"product_type":"c1","uid":1671394,"ip_address":"","ucode":"20C49732158424","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/8KpWhCMxgVgqKMxNT9zuJuVnz1gNBzYlWrZCO4hlF4OQibhawvn0hpHhHgHr4kSXfVNjeuE4StuvTR54NGcE4Zg/132","comment_is_top":false,"comment_ctime":1596591291,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5891558587","product_id":100026901,"comment_content":"在web项目中，异常在哪层进行捕获比较好呢？ 比如说handler-&gt;service -&gt;model， 日志在哪里打印比较好 ？","like_count":1},{"had_liked":false,"id":117963,"user_name":"旗木卡卡","can_delete":false,"product_type":"c1","uid":1104407,"ip_address":"","ucode":"2C05BFE91D6892","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/17/69cca649.jpg","comment_is_top":false,"comment_ctime":1564199338,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5859166634","product_id":100026901,"comment_content":"问题二、产品设计的时候就应该同时考虑到功能规划和代码结构，设计的合理，代码结构自然也会好很多。","like_count":1},{"had_liked":false,"id":116656,"user_name":"code2","can_delete":false,"product_type":"c1","uid":1281792,"ip_address":"","ucode":"BBA5748FB6A01C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/8OPzdpDraQMvCNWAicicDt54sDaIYJZicBLfMyibXVs4V0ZibEdkZlbzxxL7aGpRoeyvibag5LaAaaGKSdwYQMY2hUrQ/132","comment_is_top":false,"comment_ctime":1563885833,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5858853129","product_id":100026901,"comment_content":"在C++中，构造函数中出现异常由编译器来处理，不需要程序员参与，在python重视如何处理的？由解释器处理吗？","like_count":1},{"had_liked":false,"id":116494,"user_name":"图·美克尔","can_delete":false,"product_type":"c1","uid":1076720,"ip_address":"","ucode":"021FB5AE110066","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eppQqDE6TNibvr3DNdxG323AruicIgWo5DpVr6U7yZVNkbF2rKluyDfhdpgAEcYEOZTAnbrMdTzFkUw/0","comment_is_top":false,"comment_ctime":1563857450,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"5858824746","product_id":100026901,"comment_content":"单元测试代码对于自己或者别人维护你之前的代码也是很重要的。","like_count":1},{"had_liked":false,"id":292552,"user_name":"Geek_52daa2","can_delete":false,"product_type":"c1","uid":1780027,"ip_address":"","ucode":"6D6C1AE4DAAE68","user_header":"","comment_is_top":false,"comment_ctime":1620876069,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1620876069","product_id":100026901,"comment_content":"请问老师，不过assert判定失败，抛出异常，那程序会终止吗？如果在web服务中使用assert是不是不太合适？","like_count":0,"discussions":[{"author":{"id":2977554,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLCmEAVBUFDcT4pChy93J4RKHA2OasbwWaIYXB70t1CJsmrD71sxnpWlDfY1diaLLKz1zUwDjzAKibGQ/132","nickname":"Geek_dcd08f","note":"","ucode":"1ECA7B63CA95A5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570112,"discussion_content":"assert会终止","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651667262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}