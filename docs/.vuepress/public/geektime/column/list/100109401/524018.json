{"id":524018,"title":"39ï½œRESTful Web Servicesï¼ˆ3ï¼‰ï¼šæ˜ç¡®æ¶æ„æ„¿æ™¯ä¸è°ƒç”¨æ ˆé¡ºåº","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¾æ˜Šã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­ä½¿ç”¨TDDçš„æ–¹å¼å®ç°RESTful Web Servicesã€‚</p><p>åœ¨ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬é€šè¿‡Spikeå°†DIå®¹å™¨å¼•å…¥äº†å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>static class ResourceServlet extends HttpServlet {\n    private final Context context;\n    private TestApplication application;\n    private Providers providers;\n    public ResourceServlet(TestApplication application, Providers providers) {\n        this.application = application;\n        this.providers = providers;\n        context = application.getContext();\n    }\n    \n    @Override\n    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {\n        Stream&lt;Class&lt;?&gt;&gt; rootResources = application.getClasses().stream().filter(c -&gt; c.isAnnotationPresent(Path.class));\n\n        ResourceContext rc = application.createResourceContext(req, resp);\n        Object result = dispatch(req, rootResources, rc);\n        MessageBodyWriter&lt;Object&gt; writer = (MessageBodyWriter&lt;Object&gt;) providers.getMessageBodyWriter(result.getClass(), null, null, null);\n        writer.writeTo(result, null, null, null, null, null, resp.getOutputStream());\n    }\n    \n    Object dispatch(HttpServletRequest req, Stream&lt;Class&lt;?&gt;&gt; rootResources, ResourceContext rc) {\n        try {\n            Class&lt;?&gt; rootClass = rootResources.findFirst().get();\n            Object rootResource = rc.initResource(context.get(ComponentRef.of(rootClass)).get());\n            Method method = Arrays.stream(rootClass.getMethods()).filter(m -&gt; m.isAnnotationPresent(GET.class)).findFirst().get();\n            return method.invoke(rootResource);\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n}\n</code></pre><p>åœ¨è¿™ä¸ªSpikeçš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–æ¶æ„çš„æ„¿æ™¯ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/c4/4b/c4yyfbbe0e0361571e7352f4eefc474b.jpg?wh=2284x1285\" alt=\"\"></p><h2>æ˜ç¡®è°ƒç”¨æ ˆé¡ºåº</h2><p>æ¥ä¸‹æ¥éœ€è¦ç¨å¾®Spikeä¸€ä¸‹çš„ï¼Œå°±æ˜¯Resource Dispatcherçš„éƒ¨åˆ†ï¼š</p><p><video poster=\"https://media001.geekbang.org/b4febcbdd7d5417aa5c94b9cb82a7473/snapshots/bcc327d31d7a4ee6be07467b61d58073-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/10b6470c-181373b959e-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/f9047f0954e44aa88cd1d1c5acfeaeff/dbd3da0096ce419d97efd9e1f1501632-86af099113678cda5dc38ed4a773bfed-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><p>æ ¹æ®Spikeçš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™éƒ¨åˆ†çš„æ¶æ„æ„¿æ™¯å’Œè°ƒç”¨æ ˆé¡ºåºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/69/f9/69187acce0858b870364248b0f5f99f9.jpg?wh=2284x1285\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/10/a1/102dee363b2a45734c24ee4ef20c39a1.jpg?wh=2284x1285\" alt=\"\"><br>\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸ºå¤§è‡´çš„ç»„ä»¶åˆ’åˆ†ã€‚</p><ul>\n<li>ResourceServletï¼šä»¥Servletçš„å½¢å¼ä½œä¸ºå…¥å£ï¼Œå¤„ç†Httpè¯·æ±‚ã€‚</li>\n<li>Applicationï¼šæŒ‡æ˜RESTfulåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶ï¼Œæ¯”å¦‚Root Resourceã€Providersç­‰ï¼Œä¹Ÿæ˜¯å¯¹äºæ¡†æ¶æä¾›çš„æœåŠ¡çš„è®¿é—®å…¥å£ã€‚</li>\n<li>ResourceRouterï¼šHttpè¯·æ±‚æ´¾å‘ç®—æ³•çš„å®ç°è½½ä½“ã€‚</li>\n<li>Providersï¼šä¸‰ä¸ªæ‰©å±•ç‚¹ï¼Œä¹Ÿå°±æ˜¯MessageBodyWriterï¼ŒMessageBodyReaderä»¥åŠExceptionMapperã€‚</li>\n</ul><p>æ˜ç¡®äº†è¿™äº›ä¹‹åï¼Œå°±å¯ä»¥è¿›å…¥åˆ†è§£ä»»åŠ¡çš„ç¯èŠ‚äº†ã€‚ä½†æ˜¯ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å¦‚ä½•å¤„ç†Spikeä»£ç å‘¢ï¼Ÿ</p><p><video poster=\"https://media001.geekbang.org/2ea69c257de1468d8f983ed13722aa16/snapshots/93ee2b433027475b84420e0714860a29-00005.jpg\" preload=\"none\" controls=\"\"><source src=\"https://media001.geekbang.org/customerTrans/7e27d07d27d407ebcc195a0e78395f55/46935a0e-181373bcefc-0000-0000-01d-dbacd.mp4\" type=\"video/mp4\"><source src=\" https://media001.geekbang.org/cda9a8ababb24a43ac0a22ee9e0e43c4/1c5845278dca4bf49b52936dc247b48f-7b681756f1a85fa02d4b212d6a7fa960-sd.m3u8\" type=\"application/x-mpegURL\"></video></p><h2>æ€è€ƒé¢˜</h2><p>åœ¨è¿›å…¥ä¸‹èŠ‚è¯¾ä¹‹å‰ï¼Œå¸Œæœ›ä½ èƒ½è®¤çœŸæ€è€ƒå¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚</p><ol>\n<li>åœ¨å½“å‰æ¶æ„æ„¿æ™¯ä¸‹ï¼Œæˆ‘ä»¬è¦å¦‚ä½•åˆ†è§£ä»»åŠ¡ï¼Ÿ</li>\n<li>å…³äºæ¶æ„æ„¿æ™¯çš„å­¦ä¹ ï¼Œä½ æœ‰ä»€ä¹ˆæ”¶è·å—ï¼Ÿ</li>\n</ol><!-- [[[read_end]]] --><p>æ¬¢è¿æŠŠä½ çš„æƒ³æ³•åˆ†äº«åœ¨ç•™è¨€åŒºï¼Œä¹Ÿæ¬¢è¿æŠŠä½ çš„é¡¹ç›®ä»£ç åˆ†äº«å‡ºæ¥ã€‚ç›¸ä¿¡ç»è¿‡ä½ çš„æ€è€ƒä¸å®æ“ï¼Œå­¦ä¹ æ•ˆæœä¼šæ›´å¥½ï¼</p>","neighbors":{"left":{"article_title":"38ï½œRESTful Web Servicesï¼ˆ2ï¼‰ï¼šæ ¹æ®Spikeçš„ç»“æœï¼Œè¦å¦‚ä½•è°ƒæ•´æ¶æ„æ„¿æ™¯ï¼Ÿ","id":524016},"right":{"article_title":"40ï½œRESTful Web Servicesï¼ˆ4ï¼‰ï¼šåœ¨å½“å‰æ¶æ„æ„¿æ™¯ä¸‹ï¼Œè¦å¦‚ä½•åˆ†è§£ä»»åŠ¡ï¼Ÿ","id":524019}},"comments":[{"had_liked":false,"id":348700,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1655309365,"is_pvip":false,"replies":[{"id":127876,"content":"å˜»å˜»æ¯èŠ‚è¯¾éƒ½åœ¨ç­‰ä½ çš„ä»£ç ï½","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":2189689,"ctime":1658043104,"ip_address":"","comment_id":348700,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100109401,"comment_content":"ç•™ä¸‹ä»£ç  https:&#47;&#47;github.com&#47;wyyl1&#47;geektime-tdd-framework&#47;tree&#47;3","like_count":1,"discussions":[{"author":{"id":2189689,"avatar":"https://static001.geekbang.org/account/avatar/00/21/69/79/b4132042.jpg","nickname":"ğŸ‘","note":"","ucode":"DE34B3B14287D1","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580253,"discussion_content":"å˜»å˜»æ¯èŠ‚è¯¾éƒ½åœ¨ç­‰ä½ çš„ä»£ç ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658043104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":348906,"user_name":"å¼ é“æ—","can_delete":false,"product_type":"c1","uid":1108258,"ip_address":"","ucode":"4AB8BC6CDAC0A3","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/22/7606c6ba.jpg","comment_is_top":false,"comment_ctime":1655535453,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100109401,"comment_content":"https:&#47;&#47;github.com&#47;vfbiby&#47;tdd-restful\n","like_count":1},{"had_liked":false,"id":390099,"user_name":"èŒƒé£æ‰¬","can_delete":false,"product_type":"c1","uid":2721761,"ip_address":"å¹¿ä¸œ","ucode":"A665DF46833A81","user_header":"https://static001.geekbang.org/account/avatar/00/29/87/e1/b3edcc09.jpg","comment_is_top":false,"comment_ctime":1714351678,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100109401,"comment_content":"å¥½å§ï¼ŒåŸæ¥dispatcher å˜æˆäº†ResourceRouterï¼Œæˆ‘è¯´æ€ä¹ˆç»„ä»¶å…ƒç´ å˜å°‘äº†","like_count":0}]}