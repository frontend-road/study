{"id":427470,"title":"17 | æ•°æ®å…³è”ï¼šä¸åŒçš„å…³è”å½¢å¼ä¸å®ç°æœºåˆ¶è¯¥æ€ä¹ˆé€‰ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>åœ¨ä¸Šä¸€è®²ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Spark SQLæ”¯æŒçš„è¯¸å¤šç®—å­ã€‚å…¶ä¸­æ•°æ®å…³è”ï¼ˆJoinï¼‰æ˜¯æ•°æ®åˆ†æåœºæ™¯ä¸­æœ€å¸¸è§ã€æœ€é‡è¦çš„æ“ä½œã€‚æ¯«ä¸å¤¸å¼ åœ°è¯´ï¼Œå‡ ä¹åœ¨æ‰€æœ‰çš„æ•°æ®åº”ç”¨ä¸­ï¼Œä½ éƒ½èƒ½çœ‹åˆ°æ•°æ®å…³è”çš„â€œèº«å½±â€ã€‚å› æ­¤ï¼Œä»Šå¤©è¿™ä¸€è®²ï¼Œå’±ä»¬ç»§ç»­è¯¦ç»†è¯´ä¸€è¯´Spark SQLå¯¹äºJoinçš„æ”¯æŒã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒJoinçš„ç§ç±»éå¸¸ä¸°å¯Œã€‚å¦‚æœæŒ‰ç…§<strong>å…³è”å½¢å¼ï¼ˆJoin Typesï¼‰</strong>æ¥åˆ’åˆ†ï¼Œæ•°æ®å…³è”åˆ†ä¸ºå†…å…³è”ã€å¤–å…³è”ã€å·¦å…³è”ã€å³å…³è”ï¼Œç­‰ç­‰ã€‚å¯¹äºå‚ä¸å…³è”è®¡ç®—çš„ä¸¤å¼ è¡¨ï¼Œå…³è”å½¢å¼å†³å®šäº†ç»“æœé›†çš„æ•°æ®æ¥æºã€‚å› æ­¤ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­é€‰æ‹©å“ªç§å…³è”å½¢å¼ï¼Œæ˜¯ç”±æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘å†³å®šçš„ã€‚</p><p>è€Œä»<strong>å®ç°æœºåˆ¶</strong>çš„è§’åº¦ï¼ŒJoinåˆå¯ä»¥åˆ†ä¸ºNLJï¼ˆNested Loop Joinï¼‰ã€SMJï¼ˆSort Merge Joinï¼‰å’ŒHJï¼ˆHash Joinï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒæ ·æ˜¯å†…å…³è”ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥é‡‡ç”¨NLJæ¥å®ç°ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨SMJæˆ–æ˜¯HJæ¥å®ç°ã€‚åŒºåˆ«åœ¨äºï¼Œåœ¨ä¸åŒçš„è®¡ç®—åœºæ™¯ä¸‹ï¼Œè¿™äº›ä¸åŒçš„å®ç°æœºåˆ¶åœ¨æ‰§è¡Œæ•ˆç‡ä¸Šæœ‰ç€å¤©å£¤ä¹‹åˆ«ã€‚å› æ­¤ï¼Œäº†è§£å¹¶ç†Ÿæ‚‰è¿™äº›æœºåˆ¶ï¼Œå¯¹å’±ä»¬å¼€å‘è€…æ¥è¯´è‡³å…³é‡è¦ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å°±åˆ†åˆ«ä»è¿™ä¸¤ä¸ªè§’åº¦ï¼Œæ¥è¯´ä¸€è¯´Spark SQLå½“ä¸­æ•°æ®å…³è”çš„æ¥é¾™å»è„‰ã€‚</p><h2><strong>æ•°æ®å‡†å¤‡</strong></h2><p>ä¸ºäº†è®©ä½ æ›´å¥½åœ°æŒæ¡æ–°çŸ¥è¯†ï¼Œæˆ‘ä¼šé€šè¿‡ä¸€ä¸ªä¸ªä¾‹å­ï¼Œä¸ºä½ è¯´æ˜Spark SQLæ•°æ®å…³è”çš„å…·ä½“ç”¨æ³•ã€‚åœ¨å»ä»‹ç»æ•°æ®å…³è”ä¹‹å‰ï¼Œå’±ä»¬å…ˆæŠŠç¤ºä¾‹ä¸­ä¼šç”¨åˆ°çš„æ•°æ®å‡†å¤‡å¥½ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-scala\">import spark.implicits._\nimport org.apache.spark.sql.DataFrame\n&nbsp;\n// åˆ›å»ºå‘˜å·¥ä¿¡æ¯è¡¨\nval seq = Seq((1, \"Mike\", 28, \"Male\"), (2, \"Lily\", 30, \"Female\"), (3, \"Raymond\", 26, \"Male\"), (5, \"Dave\", 36, \"Male\"))\nval employees: DataFrame = seq.toDF(\"id\", \"name\", \"age\", \"gender\")\n&nbsp;\n// åˆ›å»ºè–ªèµ„è¡¨\nval seq2 = Seq((1, 26000), (2, 30000), (4, 25000), (3, 20000))\nval salaries:DataFrame = seq2.toDF(\"id\", \"salary\")\n</code></pre><p>å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªDataFrameï¼Œä¸€ä¸ªç”¨äºå­˜å‚¨å‘˜å·¥åŸºæœ¬ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå‘˜å·¥è¡¨ï¼›å¦ä¸€ä¸ªå­˜å‚¨å‘˜å·¥è–ªæ°´ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè–ªèµ„è¡¨ã€‚</p><p>æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆå¼„æ¸…æ¥šä¸€äº›æ•°æ®å…³è”çš„åŸºæœ¬æ¦‚å¿µã€‚æ‰€è°“æ•°æ®å…³è”ï¼Œå®ƒæŒ‡çš„æ˜¯è¿™æ ·ä¸€ä¸ªè®¡ç®—è¿‡ç¨‹ï¼šç»™å®šå…³è”æ¡ä»¶ï¼ˆJoin Conditionsï¼‰å°†ä¸¤å¼ æ•°æ®è¡¨ä»¥ä¸åŒå…³è”å½¢å¼æ‹¼æ¥åœ¨ä¸€èµ·çš„è¿‡ç¨‹ã€‚å…³è”æ¡ä»¶åŒ…å«ä¸¤å±‚å«ä¹‰ï¼Œä¸€å±‚æ˜¯ä¸¤å¼ è¡¨ä¸­å„è‡ªå…³è”å­—æ®µï¼ˆJoin Keyï¼‰çš„é€‰æ‹©ï¼Œå¦ä¸€å±‚æ˜¯å…³è”å­—æ®µä¹‹é—´çš„é€»è¾‘å…³ç³»ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/426789\">ä¸Šä¸€è®²</a>æˆ‘ä»¬è¯´åˆ°ï¼ŒSpark SQLåŒæ—¶æ”¯æŒDataFrameç®—å­ä¸SQLæŸ¥è¯¢ï¼Œå› æ­¤å’±ä»¬ä¸å¦¨ç»“åˆåˆšåˆšå‡†å¤‡å¥½çš„æ•°æ®ï¼Œåˆ†åˆ«ä»¥è¿™ä¸¤è€…ä¸ºä¾‹ï¼Œæ¥è¯´æ˜æ•°æ®å…³è”ä¸­çš„åŸºæœ¬æ¦‚å¿µã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0c/9b/0c849767ac2bc45e97210bdcc3ecb89b.jpg?wh=1920x437\" alt=\"å›¾ç‰‡\" title=\"æ•°æ®å…³è”çš„åŸºæœ¬æ¦‚å¿µ\"></p><p>é¦–å…ˆï¼Œçº¦å®šä¿—æˆåœ°ï¼Œæˆ‘ä»¬æŠŠä¸»åŠ¨å‚ä¸Joinçš„æ•°æ®è¡¨ï¼Œå¦‚ä¸Šå›¾ä¸­çš„salariesè¡¨ï¼Œç§°ä½œâ€œå·¦è¡¨â€ï¼›è€ŒæŠŠè¢«åŠ¨å‚ä¸å…³è”çš„æ•°æ®è¡¨ï¼Œå¦‚employeesè¡¨ï¼Œç§°ä½œæ˜¯â€œå³è¡¨â€ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬æ¥å…³æ³¨å›¾ä¸­è“è‰²çš„éƒ¨åˆ†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä¸¤å¼ è¡¨éƒ½é€‰æ‹©idåˆ—ä½œä¸ºå…³è”å­—æ®µï¼Œè€Œä¸¤è€…çš„é€»è¾‘å…³ç³»æ˜¯â€œç›¸ç­‰â€ã€‚è¿™æ ·çš„ä¸€ä¸ªç­‰å¼ï¼Œå°±æ„æˆäº†æˆ‘ä»¬åˆšåˆšè¯´çš„å…³è”æ¡ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹å›¾ä¸­ç»¿è‰²çš„éƒ¨åˆ†ï¼ŒinneræŒ‡ä»£çš„å°±æ˜¯å†…å…³è”çš„å…³è”å½¢å¼ã€‚</p><p>å…³è”å½¢å¼ï¼Œæ˜¯æˆ‘ä»¬ä»Šå¤©è¦å­¦ä¹ çš„é‡ç‚¹å†…å®¹ä¹‹ä¸€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€åœ°ç»•è¿‡SQLæŸ¥è¯¢è¿™ç§å¼€å‘æ–¹å¼ï¼Œä»¥DataFrameç®—å­è¿™ç§å¼€å‘æ¨¡å¼ä¸ºä¾‹ï¼Œè¯´ä¸€è¯´Spark SQLéƒ½æ”¯æŒå“ªäº›å…³è”å½¢å¼ï¼Œä»¥åŠä¸åŒå…³è”å½¢å¼çš„æ•ˆæœæ˜¯æ€æ ·çš„ã€‚</p><h2>å…³è”å½¢å¼ï¼ˆJoin Typesï¼‰</h2><p>åœ¨å…³è”å½¢å¼è¿™æ–¹é¢ï¼ŒSpark SQLçš„æ”¯æŒæ¯”è¾ƒå…¨é¢ï¼Œä¸ºäº†è®©ä½ ä¸€ä¸Šæ¥å°±å»ºç«‹ä¸€ä¸ªæ•´ä½“çš„è®¤çŸ¥ï¼Œæˆ‘æŠŠSpark SQLæ”¯æŒçš„Joint Typeséƒ½æ•´ç†åˆ°äº†å¦‚ä¸‹çš„è¡¨æ ¼ä¸­ï¼Œä½ ä¸å¦¨å…ˆç²—ç•¥åœ°è¿‡ä¸€éã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/df/c0/df6217d9ac440b442934f1dfcc4192c0.jpg?wh=1555x1009\" alt=\"å›¾ç‰‡\" title=\"Spark SQLæ”¯æŒçš„å…³è”å½¢å¼\"></p><p>ç»“åˆå·²ç»å‡†å¤‡å¥½çš„æ•°æ®ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥è¯´ä¸€è¯´æ¯ä¸€ç§å…³è”å½¢å¼çš„ç”¨æ³•ï¼Œä»¥åŠå®ƒä»¬å„è‡ªçš„ä½œç”¨ä¸æ•ˆæœã€‚æˆ‘ä»¬å…ˆä»æœ€ç®€å•ã€æœ€åŸºç¡€ã€ä¹Ÿæ˜¯æœ€å¸¸è§çš„å†…å…³è”è¯´èµ·ã€‚</p><h3>å†…å…³è”ï¼ˆInner Joinï¼‰</h3><p>å¯¹äºç™»è®°åœ¨å†Œçš„å‘˜å·¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è·å¾—ä»–ä»¬æ¯ä¸ªäººçš„è–ªèµ„æƒ…å†µï¼Œå°±å¯ä»¥ä½¿ç”¨å†…å…³è”æ¥å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">// å†…å…³è”\nval jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"inner\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+---+-------+---+------+\n| id|salary| id| name|age|gender|\n+---+------+---+-------+---+------+\n| 1| 26000| 1| Mike| 28| Male|\n| 2| 30000| 2| Lily| 30|Female|\n| 3| 20000| 3|Raymond| 26| Male|\n+---+------+---+-------+---+------+\n*/\n&nbsp;\n// å·¦è¡¨\nsalaries.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+\n| id|salary|\n+---+------+\n| 1| 26000|\n| 2| 30000|\n| 4| 25000|\n| 3| 20000|\n+---+------+\n*/\n&nbsp;\n// å³è¡¨\nemployees.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+-------+---+------+\n| id| name|age|gender|\n+---+-------+---+------+\n| 1| Mike| 28| Male|\n| 2| Lily| 30|Female|\n| 3|Raymond| 26| Male|\n| 5| Dave| 36| Male|\n+---+-------+---+------+\n*/\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸºäºjoinç®—å­çš„ä¸€èˆ¬ç”¨æ³•ï¼Œæˆ‘ä»¬åªè¦åœ¨ç¬¬3ä¸ªå‚æ•°ä¸­æŒ‡å®šâ€œinnerâ€è¿™ç§å…³è”å½¢å¼ï¼Œå°±å¯ä»¥ä½¿ç”¨å†…å…³è”çš„æ–¹å¼ï¼Œæ¥è¾¾æˆä¸¤è¡¨ä¹‹é—´çš„æ•°æ®æ‹¼æ¥ã€‚ä¸è¿‡ï¼Œå¦‚æœä»”ç»†è§‚å¯Ÿä¸Šé¢æ‰“å°çš„å…³è”ç»“æœé›†ï¼Œä»¥åŠåŸå§‹çš„è–ªèµ„è¡¨ä¸å‘˜å·¥è¡¨ï¼Œä½ ä¼šå‘ç°ï¼Œå·¦è¡¨å’Œå³è¡¨çš„åŸå§‹æ•°æ®ï¼Œå¹¶æ²¡æœ‰éƒ½å‡ºç°åœ¨ç»“æœé›†å½“ä¸­ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨åŸå§‹çš„è–ªèµ„è¡¨ä¸­ï¼Œæœ‰ä¸€æ¡idä¸º4çš„è–ªèµ„è®°å½•ï¼›è€Œåœ¨å‘˜å·¥è¡¨ä¸­ï¼Œæœ‰ä¸€æ¡idä¸º5ã€nameä¸ºâ€œDaveâ€çš„æ•°æ®è®°å½•ã€‚è¿™ä¸¤æ¡æ•°æ®è®°å½•ï¼Œéƒ½æ²¡æœ‰å‡ºç°åœ¨å†…å…³è”çš„ç»“æœé›†ä¸­ï¼Œè€Œè¿™æ­£æ˜¯â€œå†…å…³è”â€è¿™ç§å…³è”å½¢å¼çš„ä½œç”¨æ‰€åœ¨ã€‚</p><p><strong>å†…å…³è”çš„æ•ˆæœï¼Œæ˜¯ä»…ä»…ä¿ç•™å·¦å³è¡¨ä¸­æ»¡è¶³å…³è”æ¡ä»¶çš„é‚£äº›æ•°æ®è®°å½•</strong>ã€‚ä»¥ä¸Šè¡¨ä¸ºä¾‹ï¼Œå…³è”æ¡ä»¶æ˜¯salaries(â€œidâ€) === employees(â€œidâ€)ï¼Œè€Œåœ¨å‘˜å·¥è¡¨ä¸è–ªèµ„è¡¨ä¸­ï¼Œåªæœ‰1ã€2ã€3è¿™ä¸‰ä¸ªå€¼åŒæ—¶å­˜åœ¨äºä»–ä»¬å„è‡ªçš„idå­—æ®µä¸­ã€‚ç›¸åº”åœ°ï¼Œç»“æœé›†ä¸­å°±åªæœ‰idåˆ†åˆ«ç­‰äº1ã€2ã€3çš„è¿™ä¸‰æ¡æ•°æ®è®°å½•ã€‚</p><p>ç†è§£äº†å†…å…³è”çš„å«ä¹‰ä¸æ•ˆæœä¹‹åï¼Œä½ å†å»å­¦ä¹ å…¶ä»–çš„å…³è”å½¢å¼ï¼Œæ¯”å¦‚è¯´å¤–å…³è”ï¼Œå°±ä¼šå˜å¾—è½»æ¾è®¸å¤šã€‚</p><h3>å¤–å…³è”ï¼ˆOuter Joinï¼‰</h3><p>å¤–å…³è”è¿˜å¯ä»¥ç»†åˆ†ä¸º3ç§å½¢å¼ï¼Œåˆ†åˆ«æ˜¯å·¦å¤–å…³è”ã€å³å¤–å…³è”ã€ä»¥åŠå…¨å¤–å…³è”ã€‚è¿™é‡Œçš„å·¦ã€å³ï¼Œå¯¹åº”çš„å®é™…ä¸Šå°±æ˜¯å·¦è¡¨ã€å³è¡¨ã€‚</p><p>ç”±ç®€å…¥éš¾ï¼Œæˆ‘ä»¬å…ˆæ¥è¯´å·¦å¤–å…³è”ã€‚è¦æŠŠsalariesä¸employeesåšå·¦å¤–å…³è”ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠâ€œinnerâ€å…³é”®å­—ï¼Œæ›¿æ¢ä¸ºâ€œleftâ€ã€â€œleftouterâ€æˆ–æ˜¯â€œleft_outerâ€å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">val jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"left\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+----+-------+----+------+\n| id|salary| id| name| age|gender|\n+---+------+----+-------+----+------+\n| 1| 26000| 1| Mike| 28| Male|\n| 2| 30000| 2| Lily| 30|Female|\n| 4| 25000|null| null|null| null|\n| 3| 20000| 3|Raymond| 26| Male|\n+---+------+----+-------+----+------+\n*/\n</code></pre><p>ä¸éš¾å‘ç°ï¼Œå·¦å¤–å…³è”çš„ç»“æœé›†ï¼Œå®é™…ä¸Šå°±æ˜¯å†…å…³è”ç»“æœé›†ï¼Œå†åŠ ä¸Šå·¦è¡¨salariesä¸­é‚£äº›ä¸æ»¡è¶³å…³è”æ¡ä»¶çš„å‰©ä½™æ•°æ®ï¼Œä¹Ÿå³idä¸º4çš„æ•°æ®è®°å½•ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºå³è¡¨employeesä¸­å¹¶ä¸å­˜åœ¨idä¸º4çš„è®°å½•ï¼Œå› æ­¤ç»“æœé›†ä¸­employeeså¯¹åº”çš„æ‰€æœ‰å­—æ®µå€¼å‡ä¸ºç©ºå€¼nullã€‚</p><p>æ²¡æœ‰å¯¹æ¯”å°±æ²¡æœ‰é‰´åˆ«ï¼Œä¸ºäº†æ›´å¥½åœ°ç†è§£å‰é¢å­¦çš„å†…å…³è”ã€å·¦å¤–å…³è”ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å³å¤–å…³è”çš„æ‰§è¡Œç»“æœã€‚ä¸ºäº†è®¡ç®—å³å¤–å…³è”ï¼Œåœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æŠŠâ€œleftâ€å…³é”®å­—ï¼Œæ›¿æ¢ä¸ºâ€œrightâ€ã€â€œrightouterâ€æˆ–æ˜¯â€œright_outerâ€ã€‚</p><pre><code class=\"language-scala\">val jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"right\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+----+------+---+-------+---+------+\n| id|salary| id| name|age|gender|\n+----+------+---+-------+---+------+\n| 1| 26000| 1| Mike| 28| Male|\n| 2| 30000| 2| Lily| 30|Female|\n| 3| 20000| 3|Raymond| 26| Male|\n|null| null| 5| Dave| 36| Male|\n+----+------+---+-------+---+------+\n*/\n</code></pre><p>ä»”ç»†è§‚å¯Ÿï¼Œä½ ä¼šå‘ç°ï¼Œä¸å·¦å¤–å…³è”ç›¸åï¼Œå³å¤–å…³è”çš„ç»“æœé›†ï¼Œæ°æ°æ˜¯å†…å…³è”çš„ç»“æœé›†ï¼Œå†åŠ ä¸Šå³è¡¨employeesä¸­çš„å‰©ä½™æ•°æ®ï¼Œä¹Ÿå³idä¸º5ã€nameä¸ºâ€œDaveâ€çš„æ•°æ®è®°å½•ã€‚åŒæ ·çš„ï¼Œç”±äºå·¦è¡¨salarieså¹¶ä¸å­˜åœ¨idç­‰äº5çš„æ•°æ®è®°å½•ï¼Œå› æ­¤ï¼Œç»“æœé›†ä¸­salariesç›¸åº”çš„å­—æ®µç½®ç©ºï¼Œä»¥nullå€¼è¿›è¡Œå¡«å……ã€‚</p><p>ç†è§£äº†å·¦å¤–å…³è”ä¸å³å¤–å…³è”ï¼Œå…¨å¤–å…³è”çš„åŠŸç”¨å°±æ˜¾è€Œæ˜“è§äº†ã€‚å…¨å¤–å…³è”çš„ç»“æœé›†ï¼Œå°±æ˜¯å†…å…³è”çš„ç»“æœï¼Œå†åŠ ä¸Šé‚£äº›ä¸æ»¡è¶³å…³è”æ¡ä»¶çš„å·¦å³è¡¨å‰©ä½™æ•°æ®ã€‚è¦è¿›è¡Œå…¨å¤–å…³è”çš„è®¡ç®—ï¼Œå…³é”®å­—å¯ä»¥å–â€œfullâ€ã€â€œouterâ€ã€â€œfullouterâ€ã€æˆ–æ˜¯â€œfull_outerâ€ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">val jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"full\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+----+------+----+-------+----+------+\n| id|salary| id| name| age|gender|\n+----+------+----+-------+----+------+\n| 1| 26000| 1| Mike| 28| Male|\n| 3| 20000| 3|Raymond| 26| Male|\n|null| null| 5| Dave| 36| Male|\n| 4| 25000|null| null|null| null|\n| 2| 30000| 2| Lily| 30|Female|\n+----+------+----+-------+----+------+\n*/\n</code></pre><p>åˆ°è¿™é‡Œï¼Œå†…ã€å¤–å…³è”çš„ä½œç”¨æˆ‘ä»¬å°±è®²å®Œäº†ã€‚èªæ˜çš„ä½ å¯èƒ½æ—©å·²å‘ç°ï¼Œè¿™é‡Œçš„â€œå†…â€ï¼Œå®ƒæŒ‡çš„æ˜¯ï¼Œåœ¨å…³è”ç»“æœä¸­ï¼Œä»…åŒ…å«æ»¡è¶³å…³è”æ¡ä»¶çš„é‚£äº›æ•°æ®è®°å½•ï¼›è€Œâ€œå¤–â€ï¼Œå®ƒçš„å«ä¹‰æ˜¯ï¼Œåœ¨å…³è”è®¡ç®—çš„ç»“æœé›†ä¸­ï¼Œè¿˜åŒ…å«ä¸æ»¡è¶³å…³è”æ¡ä»¶çš„æ•°æ®è®°å½•ã€‚è€Œå¤–å…³è”ä¸­çš„â€œå·¦â€ã€â€œå³â€ã€â€œå…¨â€ï¼Œæ°æ°æ˜¯åœ¨è¡¨æ˜ï¼Œé‚£äº›ä¸æ»¡è¶³å…³è”æ¡ä»¶çš„è®°å½•ï¼Œæ¥è‡ªäºå“ªé‡Œã€‚</p><p>å¼„æ¸…æ¥šâ€œå†…â€ã€â€œå¤–â€ã€â€œå·¦â€ã€â€œå³â€è¿™äº›è¯´æ³•çš„å«ä¹‰ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°å¸®æˆ‘ä»¬é¿å…è¿·å¤±åœ¨ç§ç±»ç¹å¤šã€å´åˆå½¼æ­¤ç›¸å…³çš„å…³è”å½¢å¼ä¸­ã€‚å…¶å®é™¤äº†å†…å…³è”å’Œå¤–å…³è”ï¼ŒSpark SQLè¿˜æ”¯æŒå·¦åŠå…³è”å’Œå·¦é€†å…³è”ï¼Œè¿™ä¸¤ä¸ªå…³è”åˆæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼Ÿ</p><h3>å·¦åŠ/é€†å…³è”ï¼ˆLeft Semi Join / Left Anti Joinï¼‰</h3><p>å°½ç®¡åå­—å¬ä¸Šå»æ‹—å£ï¼Œä½†å®ƒä»¬çš„å«ä¹‰å´å¾ˆç®€å•ã€‚æˆ‘ä»¬å…ˆæ¥è¯´å·¦åŠå…³è”ï¼Œå®ƒçš„å…³é”®å­—æœ‰â€œleftsemiâ€å’Œâ€œleft_semiâ€ã€‚å·¦åŠå…³è”çš„ç»“æœé›†ï¼Œå®é™…ä¸Šæ˜¯å†…å…³è”ç»“æœé›†çš„å­é›†ï¼Œå®ƒä»…ä¿ç•™å·¦è¡¨ä¸­æ»¡è¶³å…³è”æ¡ä»¶çš„é‚£äº›æ•°æ®è®°å½•ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">// å†…å…³è”\nval jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"inner\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+---+-------+---+------+\n| id|salary| id| name|age|gender|\n+---+------+---+-------+---+------+\n| 1| 26000| 1| Mike| 28| Male|\n| 2| 30000| 2| Lily| 30|Female|\n| 3| 20000| 3|Raymond| 26| Male|\n+---+------+---+-------+---+------+\n*/\n&nbsp;\n// å·¦åŠå…³è”\nval jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"leftsemi\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+\n| id|salary|\n+---+------+\n| 1| 26000|\n| 2| 30000|\n| 3| 20000|\n+---+------+\n*/\n</code></pre><p>ä¸ºäº†æ–¹ä¾¿ä½ è¿›è¡Œå¯¹æ¯”ï¼Œæˆ‘åˆ†åˆ«æ‰“å°å‡ºäº†å†…å…³è”ä¸å·¦åŠå…³è”çš„è®¡ç®—ç»“æœã€‚è¿™é‡Œä½ éœ€è¦æŠŠæ¡å·¦åŠå…³è”çš„ä¸¤å¤§ç‰¹ç‚¹ï¼šé¦–å…ˆï¼Œå·¦åŠå…³è”æ˜¯å†…å…³è”çš„ä¸€ä¸ªå­é›†ï¼›å…¶æ¬¡ï¼Œå®ƒåªä¿ç•™å·¦è¡¨salariesä¸­çš„æ•°æ®ã€‚è¿™ä¸¤ä¸ªç‰¹ç‚¹å åŠ åœ¨ä¸€èµ·ï¼Œå¾ˆå¥½åœ°è¯ é‡Šäº†â€œå·¦ã€åŠâ€è¿™ä¸¤ä¸ªå­—ã€‚</p><p>æœ‰äº†å·¦åŠå…³è”çš„åŸºç¡€ï¼Œå·¦é€†å…³è”ä¼šæ›´å¥½ç†è§£ä¸€äº›ã€‚å·¦é€†å…³è”åŒæ ·åªä¿ç•™å·¦è¡¨çš„æ•°æ®ï¼Œå®ƒçš„å…³é”®å­—æœ‰â€œleftantiâ€å’Œâ€œleft_antiâ€ã€‚ä½†ä¸å·¦åŠå…³è”ä¸åŒçš„æ˜¯ï¼Œå®ƒä¿ç•™çš„ï¼Œæ˜¯é‚£äº›ä¸æ»¡è¶³å…³è”æ¡ä»¶çš„æ•°æ®è®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code class=\"language-scala\">// å·¦é€†å…³è”\nval jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"leftanti\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+\n| id|salary|\n+---+------+\n| 4| 25000|\n+---+------+\n*/\n</code></pre><p>é€šè¿‡ä¸ä¸Šé¢å·¦åŠå…³è”çš„ç»“æœé›†åšå¯¹æ¯”ï¼Œæˆ‘ä»¬ä¸€çœ¼å°±èƒ½çœ‹å‡ºå·¦é€†å…³è”å’Œå®ƒçš„åŒºåˆ«æ‰€åœ¨ã€‚æ˜¾ç„¶ï¼Œidä¸º4çš„è–ªèµ„è®°å½•æ˜¯ä¸æ»¡è¶³å…³è”æ¡ä»¶salaries(â€œidâ€) === employees(â€œidâ€)çš„ï¼Œè€Œå·¦é€†å…³è”ç•™ä¸‹çš„ï¼Œæ°æ°æ˜¯è¿™äº›â€œä¸è¾¾æ ‡â€çš„æ•°æ®è®°å½•ã€‚</p><p>å¥½å•¦ï¼Œå…³äºSpark SQLæ”¯æŒçš„å…³è”å½¢å¼ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°±å…¨éƒ¨è¯´å®Œäº†ã€‚æ ¹æ®è¿™äº›ä¸åŒå…³è”å½¢å¼çš„ç‰¹ç‚¹ä¸ä½œç”¨ï¼Œå†ç»“åˆå®é™…åœºæ™¯ä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œç›¸ä¿¡ä½ å¯ä»¥åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­åšåˆ°çµæ´»å–èˆã€‚</p><h2>å…³è”æœºåˆ¶ï¼ˆJoin Mechanismsï¼‰</h2><p>ä¸è¿‡ï¼Œä»åŠŸèƒ½çš„è§’åº¦å‡ºå‘ï¼Œä½¿ç”¨ä¸åŒçš„å…³è”å½¢å¼æ¥å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œå¯ä»¥è¯´æ˜¯ç¨‹åºå‘˜çš„ä¸€é¡¹å¿…å¤‡æŠ€èƒ½ã€‚è¦åœ¨ä¼—å¤šçš„å¼€å‘è€…ä¸­è„±é¢–è€Œå‡ºï¼Œå’±ä»¬è¿˜è¦ç†Ÿæ‚‰ã€äº†è§£ä¸åŒçš„å…³è”æœºåˆ¶ã€‚å“ªæ€•åŒæ ·æ˜¯å†…å…³è”ï¼Œä¸åŒçš„Joinå®ç°æœºåˆ¶åœ¨æ‰§è¡Œæ•ˆç‡æ–¹é¢å·®å¼‚å·¨å¤§ã€‚å› æ­¤ï¼ŒæŒæ¡ä¸åŒå…³è”æœºåˆ¶çš„åŸç†ä¸ç‰¹æ€§ï¼Œæœ‰åˆ©äºæˆ‘ä»¬é€æ¸åŸ¹å…»å‡ºä»¥æ€§èƒ½ä¸ºå¯¼å‘çš„å¼€å‘ä¹ æƒ¯ã€‚</p><p>åœ¨è¿™ä¸€è®²çš„å¼€å¤´ï¼Œæˆ‘ä»¬æåˆ°Joinæœ‰3ç§å®ç°æœºåˆ¶ï¼Œåˆ†åˆ«æ˜¯NLJï¼ˆNested Loop Joinï¼‰ã€SMJï¼ˆSort Merge Joinï¼‰å’ŒHJï¼ˆHash Joinï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»¥å†…å…³è”ä¸ºä¾‹ï¼Œç»“åˆsalarieså’Œemployeesè¿™ä¸¤å¼ è¡¨ï¼Œæ¥è¯´è¯´å®ƒä»¬å„è‡ªçš„å®ç°åŸç†ä¸ç‰¹æ€§ã€‚</p><pre><code class=\"language-scala\">// å†…å…³è”\nval jointDF: DataFrame = salaries.join(employees, salaries(\"id\") === employees(\"id\"), \"inner\")\n&nbsp;\njointDF.show\n&nbsp;\n/** ç»“æœæ‰“å°\n+---+------+---+-------+---+------+\n| id|salary| id| name|age|gender|\n+---+------+---+-------+---+------+\n| 1| 26000| 1| Mike| 28| Male|\n| 2| 30000| 2| Lily| 30|Female|\n| 3| 20000| 3|Raymond| 26| Male|\n+---+------+---+-------+---+------+\n*/\n</code></pre><h3>NLJï¼šNested Loop Join</h3><p>å¯¹äºå‚ä¸å…³è”çš„ä¸¤å¼ è¡¨ï¼Œå¦‚salarieså’Œemployeesï¼ŒæŒ‰ç…§å®ƒä»¬åœ¨ä»£ç ä¸­å‡ºç°çš„é¡ºåºï¼Œæˆ‘ä»¬çº¦å®šä¿—æˆåœ°æŠŠsalariesç§°ä½œâ€œå·¦è¡¨â€ï¼Œè€ŒæŠŠemployeesç§°ä½œâ€œå³è¡¨â€ã€‚åœ¨æ¢è®¨å…³è”æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆå¸¸å¸¸æŠŠå·¦è¡¨ç§°ä½œæ˜¯â€œé©±åŠ¨è¡¨â€ï¼Œè€ŒæŠŠå³è¡¨ç§°ä¸ºâ€œåŸºè¡¨â€ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<strong>é©±åŠ¨è¡¨çš„ä½“é‡å¾€å¾€è¾ƒå¤§ï¼Œåœ¨å®ç°å…³è”çš„è¿‡ç¨‹ä¸­ï¼Œé©±åŠ¨è¡¨æ˜¯ä¸»åŠ¨æ‰«ææ•°æ®çš„é‚£ä¸€æ–¹ã€‚è€ŒåŸºè¡¨ç›¸å¯¹æ¥è¯´ä½“é‡è¾ƒå°ï¼Œå®ƒæ˜¯è¢«åŠ¨å‚ä¸æ•°æ®æ‰«æçš„é‚£ä¸€æ–¹</strong>ã€‚</p><p>åœ¨NLJçš„å®ç°æœºåˆ¶ä¸‹ï¼Œç®—æ³•ä¼šä½¿ç”¨å¤–ã€å†…ä¸¤ä¸ªåµŒå¥—çš„forå¾ªç¯ï¼Œæ¥ä¾æ¬¡æ‰«æé©±åŠ¨è¡¨ä¸åŸºè¡¨ä¸­çš„æ•°æ®è®°å½•ã€‚åœ¨æ‰«æçš„åŒæ—¶ï¼Œè¿˜ä¼šåˆ¤å®šå…³è”æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œå¦‚å†…å…³è”ä¾‹å­ä¸­çš„salaries(â€œidâ€) === employees(â€œidâ€)ã€‚å¦‚æœå…³è”æ¡ä»¶æˆç«‹ï¼Œå°±æŠŠä¸¤å¼ è¡¨çš„è®°å½•æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œç„¶åå¯¹å¤–è¿›è¡Œè¾“å‡ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f4/f7/f469513e8d90d4df1b4e6f9b482517f7.jpg?wh=1920x784\" alt=\"å›¾ç‰‡\" title=\"Nested Loop Joinå®ç°åŸç†\"></p><p>åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œå¤–å±‚çš„ for å¾ªç¯è´Ÿè´£éå†é©±åŠ¨è¡¨çš„æ¯ä¸€æ¡æ•°æ®ï¼Œå¦‚å›¾ä¸­çš„æ­¥éª¤ 1 æ‰€ç¤ºã€‚å¯¹äºé©±åŠ¨è¡¨ä¸­çš„æ¯ä¸€æ¡æ•°æ®è®°å½•ï¼Œå†…å±‚çš„ for å¾ªç¯ä¼šé€æ¡æ‰«æåŸºè¡¨çš„æ‰€æœ‰è®°å½•ï¼Œä¾æ¬¡åˆ¤æ–­è®°å½•çš„idå­—æ®µå€¼æ˜¯å¦æ»¡è¶³å…³è”æ¡ä»¶ï¼Œå¦‚æ­¥éª¤ 2 æ‰€ç¤ºã€‚</p><p>ä¸éš¾å‘ç°ï¼Œå‡è®¾é©±åŠ¨è¡¨æœ‰ M è¡Œæ•°æ®ï¼Œè€ŒåŸºè¡¨æœ‰ N è¡Œæ•°æ®ï¼Œé‚£ä¹ˆ NLJ ç®—æ³•çš„è®¡ç®—å¤æ‚åº¦æ˜¯ O(M * N)ã€‚å°½ç®¡NLJçš„å®ç°æ–¹å¼ç®€å•ã€ç›´è§‚ã€æ˜“æ‡‚ï¼Œä½†å®ƒçš„æ‰§è¡Œæ•ˆç‡æ˜¾ç„¶å¾ˆå·®ã€‚</p><h3>SMJï¼šSort Merge Join</h3><p>é‰´äºNLJä½æ•ˆçš„è®¡ç®—æ•ˆç‡ï¼ŒSMJåº”è¿è€Œç”Ÿã€‚Sort Merge Joinï¼Œé¡¾åæ€ä¹‰ï¼ŒSMJçš„å®ç°æ€è·¯æ˜¯å…ˆæ’åºã€å†å½’å¹¶ã€‚ç»™å®šå‚ä¸å…³è”çš„ä¸¤å¼ è¡¨ï¼ŒSMJå…ˆæŠŠä»–ä»¬å„è‡ªæ’åºï¼Œç„¶åå†ä½¿ç”¨ç‹¬ç«‹çš„æ¸¸æ ‡ï¼Œå¯¹æ’å¥½åºçš„ä¸¤å¼ è¡¨åšå½’å¹¶å…³è”ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/66/c5/66f7c7395e30747861296c8f69a387c5.jpg?wh=1920x1179\" alt=\"å›¾ç‰‡\" title=\"Sort Merge Joinå®ç°åŸç†\"></p><p>å…·ä½“è®¡ç®—è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šèµ·åˆï¼Œé©±åŠ¨è¡¨ä¸åŸºè¡¨çš„æ¸¸æ ‡éƒ½ä¼šå…ˆé”šå®šåœ¨å„è‡ªçš„ç¬¬ä¸€æ¡è®°å½•ä¸Šï¼Œç„¶åé€šè¿‡å¯¹æ¯”æ¸¸æ ‡æ‰€åœ¨è®°å½•çš„idå­—æ®µå€¼ï¼Œæ¥å†³å®šä¸‹ä¸€æ­¥çš„èµ°å‘ã€‚å¯¹æ¯”ç»“æœä»¥åŠåç»­æ“ä½œä¸»è¦åˆ†ä¸º 3 ç§æƒ…å†µï¼š</p><ul>\n<li>æ»¡è¶³å…³è”æ¡ä»¶ï¼Œä¸¤è¾¹çš„idå€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆæ­¤æ—¶æŠŠä¸¤è¾¹çš„æ•°æ®è®°å½•æ‹¼æ¥å¹¶è¾“å‡ºï¼Œç„¶åæŠŠé©±åŠ¨è¡¨çš„æ¸¸æ ‡æ»‘åŠ¨åˆ°ä¸‹ä¸€æ¡è®°å½•ï¼›</li>\n<li>ä¸æ»¡è¶³å…³è”æ¡ä»¶ï¼Œé©±åŠ¨è¡¨idå€¼å°äºåŸºè¡¨çš„idå€¼ï¼Œæ­¤æ—¶æŠŠé©±åŠ¨è¡¨çš„æ¸¸æ ‡æ»‘åŠ¨åˆ°ä¸‹ä¸€æ¡è®°å½•ï¼›</li>\n<li>ä¸æ»¡è¶³å…³è”æ¡ä»¶ï¼Œé©±åŠ¨è¡¨idå€¼å¤§äºåŸºè¡¨çš„idå€¼ï¼Œæ­¤æ—¶æŠŠåŸºè¡¨çš„æ¸¸æ ‡æ»‘åŠ¨åˆ°ä¸‹ä¸€æ¡è®°å½•ã€‚</li>\n</ul><p>åŸºäºè¿™ 3 ç§æƒ…å†µï¼ŒSMJä¸åœåœ°å‘ä¸‹æ»‘åŠ¨æ¸¸æ ‡ï¼Œç›´åˆ°æŸå¼ è¡¨çš„æ¸¸æ ‡æ»‘åˆ°å°½å¤´ï¼Œå³å®£å‘Šå…³è”ç»“æŸã€‚å¯¹äºé©±åŠ¨è¡¨çš„æ¯ä¸€æ¡è®°å½•ï¼Œç”±äºåŸºè¡¨å·²æŒ‰idå­—æ®µæ’åºï¼Œä¸”æ‰«æçš„èµ·å§‹ä½ç½®ä¸ºæ¸¸æ ‡æ‰€åœ¨ä½ç½®ï¼Œå› æ­¤ï¼ŒSMJç®—æ³•çš„è®¡ç®—å¤æ‚åº¦ä¸º O(M + N)ã€‚</p><p>ç„¶è€Œï¼Œè®¡ç®—å¤æ‚åº¦çš„é™ä½ï¼Œä»°ä»—çš„å…¶å®æ˜¯ä¸¤å¼ è¡¨å·²ç»äº‹å…ˆæ’å¥½äº†åºã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œæ’åºæœ¬èº«å°±æ˜¯ä¸€é¡¹å¾ˆè€—æ—¶çš„æ“ä½œï¼Œæ›´ä½•å†µï¼Œä¸ºäº†å®Œæˆå½’å¹¶å…³è”ï¼Œå‚ä¸ Join çš„ä¸¤å¼ è¡¨éƒ½éœ€è¦æ’åºã€‚</p><p>å› æ­¤ï¼ŒSMJçš„è®¡ç®—è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥ç”¨â€œå…ˆè‹¦åç”œâ€æ¥å½¢å®¹ã€‚è‹¦ï¼ŒæŒ‡çš„æ˜¯è¦å…ˆèŠ±è´¹æ—¶é—´ç»™ä¸¤å¼ è¡¨åšæ’åºï¼Œè€Œç”œï¼ŒæŒ‡çš„åˆ™æ˜¯æœ‰åºè¡¨çš„å½’å¹¶å…³è”èƒ½å¤Ÿäº«å—åˆ°çº¿æ€§çš„è®¡ç®—å¤æ‚åº¦ã€‚</p><h3>HJï¼šHash Join</h3><p>è€ƒè™‘åˆ°SMJå¯¹äºæ’åºçš„è‹›åˆ»è¦æ±‚ï¼Œåæ¥åˆæœ‰äººæ¨å‡ºäº†HJç®—æ³•ã€‚HJçš„è®¾è®¡åˆè¡·æ˜¯ä»¥ç©ºé—´æ¢æ—¶é—´ï¼ŒåŠ›å›¾å°†åŸºè¡¨æ‰«æçš„è®¡ç®—å¤æ‚åº¦é™ä½è‡³O(1)ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6a/d1/6a835cd4ab02063f283802a2b98647d1.jpg?wh=1920x648\" alt=\"å›¾ç‰‡\" title=\"Hash Joinå®ç°åŸç†\"></p><p>å…·ä½“æ¥è¯´ï¼ŒHJçš„è®¡ç®—åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯Buildé˜¶æ®µå’ŒProbeé˜¶æ®µã€‚åœ¨Buildé˜¶æ®µï¼Œåœ¨åŸºè¡¨ä¹‹ä¸Šï¼Œç®—æ³•ä½¿ç”¨æ—¢å®šçš„å“ˆå¸Œå‡½æ•°æ„å»ºå“ˆå¸Œè¡¨ï¼Œå¦‚ä¸Šå›¾çš„æ­¥éª¤ 1 æ‰€ç¤ºã€‚å“ˆå¸Œè¡¨ä¸­çš„Keyæ˜¯idå­—æ®µåº”ç”¨ï¼ˆApplyï¼‰å“ˆå¸Œå‡½æ•°ä¹‹åçš„å“ˆå¸Œå€¼ï¼Œè€Œå“ˆå¸Œè¡¨çš„ Value åŒæ—¶åŒ…å«äº†åŸå§‹çš„Join Keyï¼ˆidå­—æ®µï¼‰å’ŒPayloadã€‚</p><p>åœ¨Probeé˜¶æ®µï¼Œç®—æ³•ä¾æ¬¡éå†é©±åŠ¨è¡¨çš„æ¯ä¸€æ¡æ•°æ®è®°å½•ã€‚é¦–å…ˆä½¿ç”¨åŒæ ·çš„å“ˆå¸Œå‡½æ•°ï¼Œä»¥åŠ¨æ€çš„æ–¹å¼è®¡ç®—Join Keyçš„å“ˆå¸Œå€¼ã€‚ç„¶åï¼Œç®—æ³•å†ç”¨å“ˆå¸Œå€¼å»æŸ¥è¯¢åˆšåˆšåœ¨Buildé˜¶æ®µåˆ›å»ºå¥½çš„å“ˆå¸Œè¡¨ã€‚å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œåˆ™è¯´æ˜è¯¥æ¡è®°å½•ä¸åŸºè¡¨ä¸­çš„æ•°æ®ä¸å­˜åœ¨å…³è”å…³ç³»ï¼›ç›¸åï¼Œå¦‚æœæŸ¥è¯¢æˆåŠŸï¼Œåˆ™ç»§ç»­å¯¹æ¯”ä¸¤è¾¹çš„Join Keyã€‚å¦‚æœJoin Keyä¸€è‡´ï¼Œå°±æŠŠä¸¤è¾¹çš„è®°å½•è¿›è¡Œæ‹¼æ¥å¹¶è¾“å‡ºï¼Œä»è€Œå®Œæˆæ•°æ®å…³è”ã€‚</p><p>å¥½å•¦ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œå¯¹äºJoinçš„3ç§å®ç°æœºåˆ¶ï¼Œæˆ‘ä»¬æš‚æ—¶è¯´åˆ°è¿™é‡Œã€‚å¯¹äºå®ƒä»¬å„è‡ªçš„å®ç°åŸç†ï¼Œæƒ³å¿…ä½ å·²ç»æœ‰äº†å……åˆ†çš„æŠŠæ¡ã€‚è‡³äºè¿™3ç§æœºåˆ¶éƒ½é€‚åˆå“ªäº›è®¡ç®—åœºæ™¯ï¼Œä»¥åŠSpark SQLå¦‚ä½•åˆ©ç”¨è¿™äº›æœºåˆ¶åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹åšæ•°æ®å…³è”ï¼Œæˆ‘ä»¬ç•™åˆ°<a href=\"https://time.geekbang.org/column/article/428259\">ä¸‹ä¸€è®²</a>å†å»å±•å¼€ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»äº†æ•°æ®å…³è”ä¸­çš„å…³è”å½¢å¼ï¼ˆJoin Typesï¼‰ä¸å®ç°æœºåˆ¶ï¼ˆJoin Mechanismsï¼‰ã€‚æŒæ¡äº†ä¸åŒçš„å…³è”å½¢å¼ï¼Œæˆ‘ä»¬æ‰èƒ½æ¸¸åˆƒæœ‰ä½™åœ°æ»¡è¶³ä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ã€‚è€Œç†Ÿæ‚‰å¹¶ç†è§£ä¸åŒå®ç°æœºåˆ¶çš„å·¥ä½œåŸç†ï¼Œåˆ™æœ‰åˆ©äºåŸ¹å…»æˆ‘ä»¬ä»¥æ€§èƒ½ä¸ºå¯¼å‘çš„å¼€å‘ä¹ æƒ¯ã€‚</p><p>Spark SQLæ”¯æŒçš„å…³è”å½¢å¼å¤šç§å¤šæ ·ï¼Œä¸ºäº†æ–¹ä¾¿ä½ æŸ¥æ‰¾ï¼Œæˆ‘æŠŠå®ƒä»¬çš„å«ä¹‰ä¸æ•ˆæœç»Ÿä¸€æ•´ç†åˆ°äº†å¦‚ä¸‹çš„è¡¨æ ¼ä¸­ã€‚åœ¨æ—¥åçš„å¼€å‘å·¥ä½œä¸­ï¼Œå½“ä½ éœ€è¦åŒºåˆ†å¹¶ç¡®è®¤ä¸åŒçš„å…³è”å½¢å¼æ—¶ï¼Œåªè¦å›é¡¾è¿™å¼ è¡¨æ ¼ï¼Œå°±èƒ½è¿…é€Ÿå¾—åˆ°ç»“è®ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/77/97/77bbf470479a54a11c45a77697560797.jpg?wh=1920x888\" alt=\"å›¾ç‰‡\" title=\"Spark SQLæ”¯æŒçš„å…³è”å½¢å¼\"></p><p>åœ¨æ­¤ä¹‹åï¼Œæˆ‘ä»¬åˆä»‹ç»äº†Joinçš„3ç§å®ç°æœºåˆ¶ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯Nested Loop Joinã€Sort Merge Joinå’ŒHash Joinã€‚è¿™3ç§å®ç°æœºåˆ¶çš„å·¥ä½œåŸç†ï¼Œæˆ‘ä¹Ÿæ•´ç†æˆäº†è¡¨æ ¼ï¼Œæ–¹ä¾¿ä½ éšæ—¶æŸ¥çœ‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/10/3c036d0bbf371542e2fe07bd0882fd10.jpg?wh=1920x618\" alt=\"å›¾ç‰‡\" title=\"ä¸åŒJoinå®ç°æœºåˆ¶çš„å·¥ä½œåŸç†\"></p><h2>æ¯è¯¾ä¸€ç»ƒ</h2><p>å¯¹äºJoinçš„3ç§å®ç°æœºåˆ¶ï¼Œä¹Ÿå³Nested Loop Joinã€Sort Merge Joinå’ŒHash Joinï¼Œç»“åˆå…¶å®ç°åŸç†ï¼Œä½ èƒ½çŒœä¸€çŒœï¼Œå®ƒä»¬å¯èƒ½çš„é€‚ç”¨åœºæ™¯éƒ½æœ‰å“ªäº›å—ï¼Ÿæˆ–è€…æ¢å¥è¯è¯´ï¼Œåœ¨ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ï¼Œæ›´é€‚åˆä½¿ç”¨å“ªç§å®ç°æœºåˆ¶æ¥è¿›è¡Œæ•°æ®å…³è”ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµäº’åŠ¨ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™ä¸€è®²åˆ†äº«ç»™èº«è¾¹çš„åŒäº‹ã€æœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":325904,"user_name":"å®æ•°","can_delete":false,"product_type":"c1","uid":2637725,"ip_address":"","ucode":"697BEAFCE929D2","user_header":"https://static001.geekbang.org/account/avatar/00/28/3f/9d/c59c12ad.jpg","comment_is_top":false,"comment_ctime":1639223036,"is_pvip":false,"replies":[{"id":"118714","content":"æ»¡åˆ†ğŸ’¯~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1639668265,"ip_address":"","comment_id":325904,"utype":1}],"discussion_count":1,"race_medal":0,"score":"57473797884","product_id":100090001,"comment_content":"å¯¹äºè¢«è¿æ¥çš„æ•°æ®å­é›†è¾ƒå°çš„æƒ…å†µï¼ŒNestedåµŒå¥—å¾ªç¯è¿æ¥æ˜¯ä¸ªè¾ƒå¥½çš„é€‰æ‹©<br><br>Hash Joinæ•£åˆ—è¿æ¥æ˜¯CBOÂ åšå¤§æ•°æ®é›†è¿æ¥æ—¶çš„å¸¸ç”¨æ–¹å¼<br><br>SortMergeJoinÂ  Â  é€šå¸¸æƒ…å†µä¸‹æ•£åˆ—è¿æ¥çš„æ•ˆæœéƒ½æ¯”æ’åºåˆå¹¶è¿æ¥è¦å¥½ï¼Œç„¶è€Œå¦‚æœè¡Œæºå·²ç»è¢«æ’è¿‡åºï¼Œåœ¨æ‰§è¡Œæ’åºåˆå¹¶è¿æ¥æ—¶ä¸éœ€è¦å†æ’åºäº†ï¼Œè¿™æ—¶æ’åºåˆå¹¶è¿æ¥çš„æ€§èƒ½ä¼šä¼˜äºæ•£åˆ—è¿æ¥ã€‚å¯ä»¥ä½¿ç”¨æ¥å¼ºåˆ¶ä½¿ç”¨æ’åºåˆå¹¶è¿æ¥","like_count":13,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539333,"discussion_content":"æ»¡åˆ†ğŸ’¯~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639668266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324184,"user_name":"Eazow","can_delete":false,"product_type":"c1","uid":1346402,"ip_address":"","ucode":"D81D8FF2B2FF0D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/bmgpp5wc8GLmOdHNQccSgrunK0VdIicB6rpTHXCTF5xEkm2YvPHOX2DwNt2EqTzJ70JD41h0u5qW4R0yXRY1ZCg/132","comment_is_top":false,"comment_ctime":1638328737,"is_pvip":true,"replies":[{"id":"117755","content":"å–å†³äºæ˜¯å•æœºjoinï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼joinã€‚å•æœºçš„è¯ï¼ŒæŒæ¡NLJã€SMJã€HJä¸‰ç§å®ç°æœºåˆ¶å³å¯ï¼›åˆ†å¸ƒå¼joinçš„è¯ï¼Œè¿˜éœ€è¦è€ƒè™‘æ˜¯shuffle joinï¼Œè¿˜æ˜¯Broadcast join~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1638457139,"ip_address":"","comment_id":324184,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14523230625","product_id":100090001,"comment_content":"è€å¸ˆï¼Œè¯·é—®joinæ˜¯æ˜¯åˆ†å¸ƒå¼å¤„ç†å—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535518,"discussion_content":"å–å†³äºæ˜¯å•æœºjoinï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼joinã€‚å•æœºçš„è¯ï¼ŒæŒæ¡NLJã€SMJã€HJä¸‰ç§å®ç°æœºåˆ¶å³å¯ï¼›åˆ†å¸ƒå¼joinçš„è¯ï¼Œè¿˜éœ€è¦è€ƒè™‘æ˜¯shuffle joinï¼Œè¿˜æ˜¯Broadcast join~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638457139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1690884,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cd/04/e27b7803.jpg","nickname":"å°æ–°","note":"","ucode":"DCAD04665E2CF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535253,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638374187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319935,"user_name":"LJK","can_delete":false,"product_type":"c1","uid":1199213,"ip_address":"","ucode":"12B2441099FF1D","user_header":"https://static001.geekbang.org/account/avatar/00/12/4c/6d/c20f2d5a.jpg","comment_is_top":false,"comment_ctime":1636012910,"is_pvip":false,"replies":[{"id":"116041","content":"SMJåŒæ ·é€‚ç”¨äºæ•°æ®æœ‰é‡å¤çš„æƒ…å†µå“ˆï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯é æ¸¸æ ‡çš„æ»‘åŠ¨ï¼ŒåŸºæœ¬ä¸Šè¿˜æ˜¯é‚£3ä¸ªè§„åˆ™ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡å¾€ä¸‹æ»‘~ ä¸è¿‡ï¼Œä½ è¯´çš„æ²¡é”™ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¸¸æ ‡çš„æ»‘åŠ¨ï¼Œéœ€è¦ä¿è¯æ•°æ®çš„ä¸é‡ä¸æ¼~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1636094943,"ip_address":"","comment_id":319935,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10225947502","product_id":100090001,"comment_content":"æ–‡ä¸­çš„Sort Merge Joinçš„ç®—æ³•æ˜¯å¦åªé€‚ç”¨äºjoin keyåœ¨åŸºè¡¨ä¸­ä¸é‡å¤çš„æƒ…å†µï¼Ÿå¦‚æœjoin keyåœ¨åŸºè¡¨ä¸­å¯ä»¥é‡å¤çš„è¯åº”è¯¥éœ€è¦è®¾å®šå¥½Markæ§åˆ¶åŸºè¡¨çš„æ¸¸æ ‡ä½ç½®ï¼Œä¸ç„¶æ–‡ä¸­çš„æ–¹æ³•è²Œä¼¼ä¼šé—æ¼æ•°æ®","like_count":2,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529816,"discussion_content":"SMJåŒæ ·é€‚ç”¨äºæ•°æ®æœ‰é‡å¤çš„æƒ…å†µå“ˆï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯é æ¸¸æ ‡çš„æ»‘åŠ¨ï¼ŒåŸºæœ¬ä¸Šè¿˜æ˜¯é‚£3ä¸ªè§„åˆ™ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡å¾€ä¸‹æ»‘~ ä¸è¿‡ï¼Œä½ è¯´çš„æ²¡é”™ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¸¸æ ‡çš„æ»‘åŠ¨ï¼Œéœ€è¦ä¿è¯æ•°æ®çš„ä¸é‡ä¸æ¼~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636094943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1690884,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cd/04/e27b7803.jpg","nickname":"å°æ–°","note":"","ucode":"DCAD04665E2CF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535258,"discussion_content":"é‚£è¿™åº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638374400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1396945,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epaH1gHotWQukHnF2QtT2oK9hGvyLfSaKSzuC9XKH5aSWZj2KNrxYGJeNeVzIeAibzypibsmeicppGvA/132","nickname":"é­‚æ–—ç½—ä¸¶","note":"","ucode":"6BEA5CD3CCC2B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1690884,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cd/04/e27b7803.jpg","nickname":"å°æ–°","note":"","ucode":"DCAD04665E2CF8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540437,"discussion_content":"é©±åŠ¨è¡¨æœ‰é‡å¤å€¼ï¼Œæ‰«æå®Œé©±åŠ¨è¡¨ä¸Šä¸€ä¸ªé‡å¤å€¼ç»“æŸæ—¶ï¼Œä¸‹ä¸€ä¸ªé‡å¤å€¼å¼€å§‹å‰ï¼ŒåŸºè¡¨æ¸¸æ ‡å›æ‹¨åˆ°ä¸Šä¸€ä¸ªé‡å¤å€¼èµ·å§‹ä½ç½®","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1640057447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":535258,"ip_address":""},"score":540437,"extra":""}]}]},{"had_liked":false,"id":327055,"user_name":"ç¦","can_delete":false,"product_type":"c1","uid":2455712,"ip_address":"","ucode":"F2FC7AF5D433C6","user_header":"https://static001.geekbang.org/account/avatar/00/25/78/a0/7a248ddc.jpg","comment_is_top":false,"comment_ctime":1639891063,"is_pvip":true,"replies":[{"id":"119219","content":"æ˜¯çš„ï¼ŒJoinçš„å®ç°æœºåˆ¶ï¼Œæ˜¯é€šç”¨çš„å“ˆï¼Œéƒ½æ˜¯NLJã€HJå’ŒSMJï¼Œè¿™ä¸‰ç§","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1640185305,"ip_address":"","comment_id":327055,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5934858359","product_id":100090001,"comment_content":"é—®ä¸‹è€å¸ˆï¼Œhiveé‡Œé¢çš„joinæ–¹å¼ï¼Œä¹Ÿæ˜¯è€å¸ˆè¯´çš„è¿™3ç§å˜›ï¼Ÿä¸è€ƒè™‘ shuffle joinï¼ŒBroadcast joinçš„æƒ…å†µä¸‹ï¼Œï¼Œï¼Œæˆ‘çš„æ„æ€æ˜¯ï¼Œè¿™3ä¸­joinæ–¹å¼ï¼Œæ˜¯é€šç”¨çš„å˜›ï¼Œæ¯”å¦‚mysql,oracle,hive ï¼Œspark å®ç°joinéƒ½æ˜¯è¿™3ç§æ–¹å¼","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540861,"discussion_content":"æ˜¯çš„ï¼ŒJoinçš„å®ç°æœºåˆ¶ï¼Œæ˜¯é€šç”¨çš„å“ˆï¼Œéƒ½æ˜¯NLJã€HJå’ŒSMJï¼Œè¿™ä¸‰ç§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640185305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323433,"user_name":"HHB","can_delete":false,"product_type":"c1","uid":2595553,"ip_address":"","ucode":"96D1D8B633E437","user_header":"https://static001.geekbang.org/account/avatar/00/27/9a/e1/0867c16b.jpg","comment_is_top":false,"comment_ctime":1637902102,"is_pvip":false,"replies":[{"id":"117407","content":"å“ˆå“ˆï¼Œæ˜¯çš„ï¼ŒSpark SQLçš„å¾ˆå¤šä¼˜åŒ–æœºåˆ¶ï¼Œå®é™…ä¸Šéƒ½æ¥æºäºRDBMSã€‚å®é™…ä¸Šï¼Œä¸æ­¢Spark SQLï¼ŒImpalaã€Prestoï¼Œä»»ä½•æ•°ä»“éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€è°“ä¸‡å˜ä¸ç¦»å…¶å®—~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1637986025,"ip_address":"","comment_id":323433,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5932869398","product_id":100090001,"comment_content":"æ— ç¼å¯¹æ¥DBA","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":533818,"discussion_content":"å“ˆå“ˆï¼Œæ˜¯çš„ï¼ŒSpark SQLçš„å¾ˆå¤šä¼˜åŒ–æœºåˆ¶ï¼Œå®é™…ä¸Šéƒ½æ¥æºäºRDBMSã€‚å®é™…ä¸Šï¼Œä¸æ­¢Spark SQLï¼ŒImpalaã€Prestoï¼Œä»»ä½•æ•°ä»“éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€è°“ä¸‡å˜ä¸ç¦»å…¶å®—~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637986025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357776,"user_name":"Daniel","can_delete":false,"product_type":"c1","uid":1355670,"ip_address":"ä¸Šæµ·","ucode":"DA44FE9AE073D4","user_header":"https://static001.geekbang.org/account/avatar/00/14/af/96/4b216878.jpg","comment_is_top":false,"comment_ctime":1663636387,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663636387","product_id":100090001,"comment_content":"è¯·é—®joinçš„å®ç°æ–¹å¼å¦‚ä½•æŒ‡å®šå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":355499,"user_name":"åŠ æ²¹åŠ æ²¹","can_delete":false,"product_type":"c1","uid":2032995,"ip_address":"ä¸Šæµ·","ucode":"4326347ED6E532","user_header":"https://static001.geekbang.org/account/avatar/00/1f/05/63/dd59ad18.jpg","comment_is_top":false,"comment_ctime":1661429543,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661429543","product_id":100090001,"comment_content":"HJ ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨idå€¼ä½œä¸ºkeyå‘¢ï¼Ÿè¿˜éœ€è¦ä¸¤è¾¹åŒæ—¶è®¡ç®—ä¸€æ¬¡å“ˆå¸Œå€¼","like_count":0},{"had_liked":false,"id":347071,"user_name":"Geek_2de9af","can_delete":false,"product_type":"c1","uid":2982764,"ip_address":"","ucode":"C951A8EB714FFD","user_header":"","comment_is_top":false,"comment_ctime":1653667497,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1653667497","product_id":100090001,"comment_content":"è€å¸ˆé—®ä¸‹ï¼ŒåƒHash Joinè¿™ç§å®ç°æœºåˆ¶å¦‚ä½•é¿å…hashå†²çª","like_count":0},{"had_liked":false,"id":324933,"user_name":"LJK","can_delete":false,"product_type":"c1","uid":1199213,"ip_address":"","ucode":"12B2441099FF1D","user_header":"https://static001.geekbang.org/account/avatar/00/12/4c/6d/c20f2d5a.jpg","comment_is_top":false,"comment_ctime":1638724218,"is_pvip":false,"replies":[{"id":"118127","content":"ä¸æ˜¯å“ˆ~ è¿™é‡Œæ²¡æœ‰O(M)ã€O(N)è¿™æ ·çš„â€œå°¾å·´â€ï¼Œä¸¤ç§æƒ…å†µçš„å¤æ‚åº¦éƒ½æ˜¯O(M*N)","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1639046171,"ip_address":"","comment_id":324933,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1638724218","product_id":100090001,"comment_content":"è€å¸ˆå¥½ï¼ŒNLJé‡Œå·¦è¡¨é©±åŠ¨è¡¨åº”è¯¥æ˜¯ä½“é‡å¤§çš„è¡¨å—ï¼Ÿå¦‚æœæœ‰å¤§å°ä¸¤å¼ è¡¨ï¼Œå¤§è¡¨æ˜¯Næ¡æ•°æ®ï¼Œå°è¡¨æ˜¯Mæ¡æ•°æ®ï¼Œä¸è€ƒè™‘block nested loop joinä¼˜åŒ–çš„è¯ã€‚å¤æ‚åº¦æ˜¯ï¼šå¤§è¡¨é©±åŠ¨ä¸‹ï¼šO(M*N) + O(M)ï¼Œå°è¡¨é©±åŠ¨ä¸‹O(M*N) + O(N)ï¼Œå¥½åƒåº”è¯¥é€‰æ‹©å°è¡¨é©±åŠ¨ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537381,"discussion_content":"ä¸æ˜¯å“ˆ~ è¿™é‡Œæ²¡æœ‰O(M)ã€O(N)è¿™æ ·çš„â€œå°¾å·´â€ï¼Œä¸¤ç§æƒ…å†µçš„å¤æ‚åº¦éƒ½æ˜¯O(M*N)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639046171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2825469,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/1c/fd/510c9120.jpg","nickname":"åˆæœ‰ä¸€æ¡é±¼","note":"","ucode":"5ECE1EEB8B8768","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549754,"discussion_content":"æ‰€ä»¥è¿™é‡Œä¸éœ€è¦è€ƒè™‘è¯»å–è¡¨æ ¼çš„æ—¶é—´å—ï¼Ÿå› ä¸ºå¦‚æœç«™åœ¨å¤§è¡¨çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦O(M)æ¬¡I/Oï¼Œä½†æ˜¯ç«™åœ¨å°è¡¨ä¸Šï¼Œå®ƒä¸€å…±å¾ªç¯è¢«è¯»å–äº†Mæ¬¡ï¼Œæ¯æ¬¡æ¶ˆè€—O(N)æ¬¡I/Oã€‚è¿™æ ·å¤§è¡¨é©±åŠ¨ä¸‹çš„å¤æ‚åº¦å°±æ˜¯O(M*N)+O(M)ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644227112,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321682,"user_name":"welldo","can_delete":false,"product_type":"c1","uid":1598796,"ip_address":"","ucode":"D38E75364CD2E3","user_header":"https://static001.geekbang.org/account/avatar/00/18/65/4c/f7f86496.jpg","comment_is_top":false,"comment_ctime":1636990836,"is_pvip":false,"replies":[{"id":"116833","content":"è€å¼ŸåŠ æ²¹~<br>","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1637039972,"ip_address":"","comment_id":321682,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636990836","product_id":100090001,"comment_content":"å…ˆmarkï¼Œæœ€è¿‘è¦å¿™é¡¹ç›®ï¼Œå¿™å®Œå†æ¥è¿½ã€‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530333,"discussion_content":"è€å¼ŸåŠ æ²¹~\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637039972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":317828,"user_name":"ç«ç‚ç„±ç‡š","can_delete":false,"product_type":"c1","uid":2767491,"ip_address":"","ucode":"DB11784DD94059","user_header":"https://static001.geekbang.org/account/avatar/00/2a/3a/83/74e3fabd.jpg","comment_is_top":false,"comment_ctime":1634982962,"is_pvip":false,"replies":[{"id":"115459","content":"èµğŸ‘ï¼Œ666~ è¾›è‹¦è€å¼Ÿæ•´ç†Pythonä»£ç ï¼Œåç»­æˆ‘ä»¬ä¸€èµ·æ”¶å½•èµ·æ¥~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1635258673,"ip_address":"","comment_id":317828,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1634982962","product_id":100090001,"comment_content":"Python ç‰ˆä»£ç ï¼š<br><br># åœ¨notebookä¸Šè¿è¡Œï¼Œå…ˆæ„å»ºç¯å¢ƒ<br>from pyspark import SparkContext, SparkConf<br>from pyspark.sql.session import SparkSession<br>sc = SparkContext()<br>spark = SparkSession(sc)<br><br>seq=[(1, &quot;Mike&quot;, 28, &quot;Male&quot;), (2, &quot;Lily&quot;, 30, &quot;Female&quot;), (3, &quot;Raymond&quot;, 26, &quot;Male&quot;), (5, &quot;Dave&quot;, 36, &quot;Male&quot;)]<br>employees=spark.createDataFrame(seq,[&#39;id&#39;,&#39;name&#39;,&#39;age&#39;,&#39;gender&#39;])<br><br>seq2=[(1, 26000), (2, 30000), (4, 25000), (3, 20000)]<br>salaries=spark.createDataFrame(seq2,[&#39;id&#39;,&#39;salary&#39;])<br><br># inner join<br>jointDF=salaries.join(employees,&#39;id&#39;,&#39;inner&#39;)<br>jointDF.show()<br> <br># left join<br>jointDF2=salaries.join(employees,&#39;id&#39;,&#39;left&#39;)<br>jointDF2.show()<br><br># right join<br>jointDF3=salaries.join(employees,&#39;id&#39;,&#39;right&#39;)<br>jointDF3.show()<br><br># outer join<br>jointDF4=salaries.join(employees,&#39;id&#39;,&#39;outer&#39;)<br>jointDF4.show()<br><br># leftsemi<br>jointDF5=salaries.join(employees,&#39;id&#39;,&#39;leftsemi&#39;)<br>jointDF5.show()<br><br># leftanti<br>jointDF6=salaries.join(employees,&#39;id&#39;,&#39;leftanti&#39;)<br>jointDF6.show()","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":528994,"discussion_content":"èµğŸ‘ï¼Œ666~ è¾›è‹¦è€å¼Ÿæ•´ç†Pythonä»£ç ï¼Œåç»­æˆ‘ä»¬ä¸€èµ·æ”¶å½•èµ·æ¥~","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635258673,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}