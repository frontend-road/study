{"id":39792,"title":"12 | 如何将注册中心落地？","content":"<p>专栏第5期我给你讲了服务注册和发现的原理，这里面的核心是服务提供者、服务消费者和注册中心这三个概念，以及它们之间的交互关系。你可以先回顾一下这几个关键的知识点，如果有不清楚的地方，建议你先返回<a href=\"http://time.geekbang.org/column/article/14603\">第5期</a>复习一下，再开始今天的学习。</p><p>掌握了服务注册和发现的原理之后，我们就需要考虑如何把注册中心落地实现。结合前面所讲的服务注册与发现的流程，<span class=\"orange\">在落地注册中心的过程中，我们需要解决一系列的问题，包括如何存储服务信息、如何注册节点、如何反注册、如何查询节点信息以及如何订阅服务变更等</span>。这些问题你都知道如何解决吗？如果还没答案，没关系，下面我来给你一一讲解。</p><h2>注册中心如何存储服务信息</h2><p>注册中心既然是用来存储服务信息的，那么服务信息都包含哪些内容呢？</p><p>根据我的实践经验，服务信息除了包含节点信息（IP和端口号）以外，还包含其他一些信息，比如请求失败时重试的次数、请求结果是否压缩等信息。因此服务信息通常用JSON字符串来存储，包含多个字段，每个字段代表不同的含义。</p><p>除此之外，服务一般会分成多个不同的分组，每个分组的目的不同。一般来说有下面几种分组方式。</p><ul>\n<li>\n<p>核心与非核心，从业务的核心程度来分。</p>\n</li>\n<li>\n<p>机房，从机房的维度来分。</p>\n</li>\n<li>\n<p>线上环境与测试环境，从业务场景维度来区分。</p>\n</li>\n</ul><!-- [[[read_end]]] --><p>所以注册中心存储的服务信息一般包含三部分内容：分组、服务名以及节点信息，节点信息又包括节点地址和节点其他信息。从注册中心中获取的信息结构大致如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/fa/d8/faef4be8f5d42f5e67f300d4b20158d8.png?wh=951*326\" alt=\"\"></p><p>具体存储的时候，一般是按照“服务-分组-节点信息”三层结构来存储，可以用下图来描述。Service代表服务的具体分组，Cluster代表服务的接口名，节点信息用KV存储。</p><p><img src=\"https://static001.geekbang.org/resource/image/1f/46/1f8da1497fdf18d75bdcc13315ddcc46.jpg?wh=727*485\" alt=\"\"></p><p>搞清楚了注册中心存储服务信息的原理后，再来看下注册中心具体是如何工作的，包括四个流程。</p><ul>\n<li>\n<p>服务提供者注册流程。</p>\n</li>\n<li>\n<p>服务提供者反注册流程。</p>\n</li>\n<li>\n<p>服务消费者查询流程。</p>\n</li>\n<li>\n<p>服务消费者订阅变更流程。</p>\n</li>\n</ul><p>接下来，我来给你具体讲解上面四个流程的实现方式。</p><h2>注册中心是如何工作的</h2><p><strong>1. 如何注册节点</strong></p><p>知道了服务的节点信息如何存储之后，服务注册流程是怎么样的呢？可以用下面这张流程图来描述。</p><p><img src=\"https://static001.geekbang.org/resource/image/26/e6/26719c9b542a6dc0a8e9e4656489c2e6.png?wh=1026*946\" alt=\"\"></p><p>根据我的经验，服务注册流程主要有下面几个步骤：</p><ul>\n<li>\n<p>首先查看要注册的节点是否在白名单内？如果不在就抛出异常，在的话继续下一步。</p>\n</li>\n<li>\n<p>其次要查看注册的Cluster（服务的接口名）是否存在？如果不存在就抛出异常，存在的话继续下一步。</p>\n</li>\n<li>\n<p>然后要检查Service（服务的分组）是否存在？如果不存在则抛出异常，存在的话继续下一步。</p>\n</li>\n<li>\n<p>最后将节点信息添加到对应的Service和Cluster下面的存储中。</p>\n</li>\n</ul><p><strong>2. 如何反注册</strong></p><p>再来看下服务提供者节点反注册的流程，可以用下面这张流程图来描述。</p><p><img src=\"https://static001.geekbang.org/resource/image/6d/ff/6d49ee407b74881ebaded01ef6181fff.png?wh=996*882\" alt=\"\"></p><p>根据我的经验，节点反注册流程主要包含下面几个步骤：</p><ul>\n<li>\n<p>查看Service（服务的分组）是否存在，不存在就抛出异常，存在就继续下一步。</p>\n</li>\n<li>\n<p>查看Cluster（服务的接口名）是否存在，不存在就抛出异常，存在就继续下一步。</p>\n</li>\n<li>\n<p>删除存储中Service和Cluster下对应的节点信息。</p>\n</li>\n<li>\n<p>更新Cluster的sign值。</p>\n</li>\n</ul><p><strong>3. 如何查询节点信息</strong></p><p>关于服务消费者是如何从注册中心查询服务提供者的节点信息，可以用下面这张流程图来描述。</p><p><img src=\"https://static001.geekbang.org/resource/image/2a/85/2af5590e0a6f57c51905522b81263085.png?wh=1094*774\" alt=\"\"></p><p>服务消费者查询节点信息主要分为下面几个步骤：</p><ul>\n<li>\n<p>首先从localcache（本机内存）中查找，如果没有就继续下一步。这里为什么服务消费者要把服务信息存在本机内存呢？主要是因为服务节点信息并不总是时刻变化的，并不需要每一次服务调用都要调用注册中心获取最新的节点信息，只需要在本机内存中保留最新的服务提供者的节点列表就可以。</p>\n</li>\n<li>\n<p>接着从snapshot（本地快照）中查找，如果没有就继续下一步。这里为什么服务消费者要在本地磁盘存储一份服务提供者的节点信息的快照呢？这是因为服务消费者同注册中心之间的网络不一定总是可靠的，服务消费者重启时，本机内存中还不存在服务提供者的节点信息，如果此时调用注册中心失败，那么服务消费者就拿不到服务节点信息了，也就没法调用了。本地快照就是为了防止这种情况的发生，即使服务消费者重启后请求注册中心失败，依然可以读取本地快照，获取到服务节点信息。</p>\n</li>\n</ul><p><strong>4. 如何订阅服务变更</strong></p><p>最后看下，服务消费者如何订阅服务提供者的变更信息呢？可以用下面这张流程图来描述。</p><p><img src=\"https://static001.geekbang.org/resource/image/d6/f1/d6db90f412fbc9b89a0cf94cda474af1.png?wh=760*1050\" alt=\"\"></p><p>主要分为下面几个步骤：</p><ul>\n<li>\n<p>服务消费者从注册中心获取了服务的信息后，就订阅了服务的变化，会在本地保留Cluster的sign值。</p>\n</li>\n<li>\n<p>服务消费者每隔一段时间，调用getSign()函数，从注册中心获取服务端该Cluster的sign值，并与本地保留的sign值做对比，如果不一致，就从服务端拉取新的节点信息，并更新localcache和snapshot。</p>\n</li>\n</ul><p>这里小结一下，以上就是服务注册和反注册、服务查询和服务订阅变更的基本流程。除此之外，我再给你讲下我在实际项目实践中，实现服务注册与发现时遇到的几个问题，希望能给你帮助。</p><h2>注册与发现的几个问题</h2><p><strong>1. 多注册中心</strong></p><p>理论上对于一个服务消费者来说，同一个注册中心交互是最简单的。但是不可避免的是，服务消费者可能订阅了多个服务，多个服务可能是由多个业务部门提供的，而且每个业务部门都有自己的注册中心，提供的服务只在自己的注册中心里有记录。这样的话，就要求服务消费者要具备在启动时，能够从多个注册中心订阅服务的能力。</p><p>根据我的经验，还有一种情况是，一个服务提供者提供了某个服务，可能作为静态服务对外提供，有可能又作为动态服务对外提供，这两个服务部署在不同的注册中心，所以要求服务提供者在启动的时候，要能够同时向多个注册中心注册服务。</p><p>也就是说，对于服务消费者来说，要能够同时从多个注册中心订阅服务；对于服务提供者来说，要能够同时向多个注册中心注册服务。</p><p><strong>2. 并行订阅服务</strong></p><p>通常一个服务消费者订阅了不止一个服务，在我经历的一个项目中，一个服务消费者订阅了几十个不同的服务，每个服务都有自己的方法列表以及节点列表。服务消费者在服务启动时，会加载订阅的服务配置，调用注册中心的订阅接口，获取每个服务的节点列表并初始化连接。</p><p>最开始我们采用了串行订阅的方式，每订阅一个服务，服务消费者调用一次注册中心的订阅接口，获取这个服务的节点列表并初始化连接，总共需要执行几十次这样的过程。在某些服务节点的初始化连接过程中，出现连接超时的情况，后续所有的服务节点的初始化连接都需要等待它完成，导致服务消费者启动变慢，最后耗费了将近五分钟时间来完成所有服务节点的初始化连接过程。</p><p>后来我们改成了并行订阅的方式，每订阅一个服务就单独用一个线程来处理，这样的话即使遇到个别服务节点连接超时，其他服务节点的初始化连接也不受影响，最慢也就是这个服务节点的初始化连接耗费的时间，最终所有服务节点的初始化连接耗时控制在了30秒以内。</p><p><strong>3. 批量反注册服务</strong></p><p>通常一个服务提供者节点提供不止一个服务，所以注册和反注册都需要多次调用注册中心。在与注册中心的多次交互中，可能由于网络抖动、注册中心集群异常等原因，导致个别调用失败。对于注册中心来说，偶发的注册调用失败对服务调用基本没有影响，其结果顶多就是某一个服务少了一个可用的节点。但偶发的反注册调用失败会导致不可用的节点残留在注册中心中，变成“僵尸节点”，但服务消费者端还会把它当成“活节点”，继续发起调用，最终导致调用失败。</p><p>以前我们的业务中经常遇到这个问题，需要定时去清理注册中心中的“僵尸节点”。后来我们通过优化反注册逻辑，对于下线机器、节点销毁的场景，通过调用注册中心提供的批量反注册接口，一次调用就可以把该节点上提供的所有服务同时反注册掉，从而避免了“僵尸节点”的出现。</p><p><strong>4. 服务变更信息增量更新</strong></p><p>服务消费者端启动时，除了会查询订阅服务的可用节点列表做初始化连接，还会订阅服务的变更，每隔一段时间从注册中心获取最新的服务节点信息标记sign，并与本地保存的sign值作比对，如果不一样，就会调用注册中心获取最新的服务节点信息。</p><p>一般情况下，按照这个过程是没问题的，但是在网络频繁抖动时，服务提供者上报给注册中心的心跳可能会一会儿失败一会儿成功，这时候注册中心就会频繁更新服务的可用节点信息，导致服务消费者频繁从注册中心拉取最新的服务可用节点信息，严重时可能产生网络风暴，导致注册中心带宽被打满。</p><p>为了减少服务消费者从注册中心中拉取的服务可用节点信息的数据量，这个时候可以通过增量更新的方式，注册中心只返回变化的那部分节点信息，尤其在只有少数节点信息变更时，此举可以大大减少服务消费者从注册中心拉取的数据量，从而最大程度避免产生网络风暴。</p><h2>总结</h2><p>今天我给你讲解了在注册中心实际使用过程中，服务注册、服务反注册、服务订阅和服务变更的实现方式，并列举了几个我在服务注册与发现的过程中遇到的典型问题。</p><p>而针对这些异常情况，我都给出了对应的解决方案，这些方案都是经过实际业务验证的，对于大部分中小团队在应用场景面临的问题，应该足以应对。</p><h2>思考题</h2><p>你的团队在使用注册中心时，是否有遇到过上面这些问题呢？我给出的解决方案是否可以解决你们的问题呢？</p><p>欢迎你在留言区写下自己的思考，与我一起讨论。</p><p></p>","neighbors":{"left":{"article_title":"11 | 服务发布和引用的实践","id":39783},"right":{"article_title":"13 | 开源服务注册中心如何选型？","id":39797}},"comments":[{"had_liked":false,"id":24883,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1537226941,"is_pvip":false,"discussion_count":6,"race_medal":1,"score":"117501343933","product_id":100014401,"comment_content":"老师，文中有”以前我们的业务中经常遇到这个问题，需要定时去清理注册中心中的“僵尸节点”。后来我们通过优化反注册逻辑，对于下线机器、节点销毁的场景，通过调用注册中心提供的批量反注册接口，一次调用就可以把该节点上提供的所有服务同时反注册掉，从而避免了“僵尸节点”的出现。”<br>我这里有两个疑惑点:<br>1.之前的方案是定时清理”僵尸节点”是通过什么方法呢？ 简单的ping一下，看能否通？然后发现一个僵尸节点就删掉<br>2.优化反注册接口，批量删除。老师能具体说下方案吗？ 如果批量删除，会不会存在一个时间窗口，僵尸节点还在注册中心的情况？","like_count":28,"discussions":[{"author":{"id":1010144,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/e0/ff8ee2e2.jpg","nickname":"胡忠想","note":"","ucode":"0792605FC265B4","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":277080,"discussion_content":"1. 僵尸节点就是运维系统中已经下线的机器；\n2. 因为反注册一般是针对一个节点上提供的一个服务，批量反注册就是针对节点上提供的所有服务都给下线。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590995694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010144,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/e0/ff8ee2e2.jpg","nickname":"胡忠想","note":"","ucode":"0792605FC265B4","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":322892,"discussion_content":"宁可错杀，不漏一人？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604838458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":277080,"ip_address":""},"score":322892,"extra":""}]},{"author":{"id":1136329,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/c9/7b3cd3e0.jpg","nickname":"马振","note":"","ucode":"94234F533219C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":274887,"discussion_content":"老师答疑不够啊\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590628742,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2293202,"avatar":"https://static001.geekbang.org/account/avatar/00/22/fd/d2/7c4bf120.jpg","nickname":"～啫梨～","note":"","ucode":"CC95D70A48C974","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335454,"discussion_content":"我看到这个的时候也是一头雾水，只说现象，没说本质","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608197419,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005157,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/56/65/22a37a8e.jpg","nickname":"Yezhiwei","note":"","ucode":"31E8E33688CBEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244929,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587642439,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1630967,"avatar":"https://static001.geekbang.org/account/avatar/00/18/e2/f7/ec06457e.jpg","nickname":"JimmyFu","note":"","ucode":"1793F18AE87911","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":42571,"discussion_content":"这个我也想知道","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572701299,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":31008,"user_name":"吴浩","can_delete":false,"product_type":"c1","uid":1142224,"ip_address":"","ucode":"EA91647FF05EA7","user_header":"https://static001.geekbang.org/account/avatar/00/11/6d/d0/6c2b8877.jpg","comment_is_top":false,"comment_ctime":1539064699,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"65963574139","product_id":100014401,"comment_content":"服务注册流程中注册节点有个问题想问下<br><br>为什么查看注册的Cluster（服务的接口名）和Service（服务的的分组）是否存在，不存在就抛出异常<br><br>这里为什么不是不存在就添加这个服务的接口名了，为什么是报错，第一次初始化是在哪进行的了","like_count":15,"discussions":[{"author":{"id":1622655,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c2/7f/7b22f12b.jpg","nickname":"乔","note":"","ucode":"1286F8742B4A01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296737,"discussion_content":"有同样的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596636813,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110437,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f1/a5/6cc9f728.jpg","nickname":"秋天的透明雨🌧️","note":"","ucode":"9363B49BFA6C14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283805,"discussion_content":"有同样的疑惑，期待老师回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592371455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79254,"user_name":"拉风一哥","can_delete":false,"product_type":"c1","uid":1132663,"ip_address":"","ucode":"21F48512F58D5B","user_header":"https://static001.geekbang.org/account/avatar/00/11/48/77/400cac74.jpg","comment_is_top":false,"comment_ctime":1553417105,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"35913155473","product_id":100014401,"comment_content":"感觉讲的太抽象了，能不能结合具体的实例。你说的这些解决方案，也是抽象的方案，比如多注册中心要如何实现，实现的时候该注意什么问题？","like_count":9,"discussions":[{"author":{"id":1612910,"avatar":"https://static001.geekbang.org/account/avatar/00/18/9c/6e/01b4d5d2.jpg","nickname":"liupan","note":"","ucode":"C6C7C48BCCAE12","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289565,"discussion_content":"答疑不够","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594135087,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":35402,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1198347,"ip_address":"","ucode":"C91BB475625B20","user_header":"https://static001.geekbang.org/account/avatar/00/12/49/0b/db412e36.jpg","comment_is_top":false,"comment_ctime":1540542186,"is_pvip":false,"replies":[{"id":"12863","content":"这里是为了讲述理论，实际实现时有两种方式，一种是zookeeper的推模式，一种是消费者定时拉去得模式","user_name":"作者回复","user_name_real":"古月中心相心","uid":"1010144","ctime":1540956247,"ip_address":"","comment_id":35402,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35900280554","product_id":100014401,"comment_content":"消费者订阅了服务的变更，当服务变更的时候，注册中心就可以把变更通知单消费者，那消费者为什么还需要定期去拉注册中心的数据呢？","like_count":9,"discussions":[{"author":{"id":1010144,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/e0/ff8ee2e2.jpg","nickname":"胡忠想","note":"","ucode":"0792605FC265B4","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427527,"discussion_content":"这里是为了讲述理论，实际实现时有两种方式，一种是zookeeper的推模式，一种是消费者定时拉去得模式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1540956247,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":30141,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1538698844,"is_pvip":false,"replies":[{"id":"10905","content":"对","user_name":"作者回复","user_name_real":"古月中心相心","uid":"1010144","ctime":1538796701,"ip_address":"","comment_id":30141,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35898437212","product_id":100014401,"comment_content":"注册中心的信息怎么实现增量更新，是通过版本号的方式吗","like_count":9,"discussions":[{"author":{"id":1010144,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/e0/ff8ee2e2.jpg","nickname":"胡忠想","note":"","ucode":"0792605FC265B4","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425868,"discussion_content":"对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538796701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":24981,"user_name":"少帅","can_delete":false,"product_type":"c1","uid":1045791,"ip_address":"","ucode":"EF88F62C236594","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/1f/577265ea.jpg","comment_is_top":false,"comment_ctime":1537234489,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18717103673","product_id":100014401,"comment_content":"Eurka可以调整心跳时间来处理僵尸接点","like_count":4},{"had_liked":false,"id":25245,"user_name":"yga","can_delete":false,"product_type":"c1","uid":1039608,"ip_address":"","ucode":"903207DC3C9150","user_header":"https://static001.geekbang.org/account/avatar/00/0f/dc/f8/9bc56db2.jpg","comment_is_top":false,"comment_ctime":1537277251,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14422179139","product_id":100014401,"comment_content":"对于现有的注册中心，比如euraka,对于文中提到的流程优化方案，需要如何操作？","like_count":3},{"had_liked":false,"id":24923,"user_name":"张龙大骗子","can_delete":false,"product_type":"c1","uid":1153705,"ip_address":"","ucode":"13F8E34E08A38A","user_header":"https://static001.geekbang.org/account/avatar/00/11/9a/a9/dfea2c50.jpg","comment_is_top":false,"comment_ctime":1537230897,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14422132785","product_id":100014401,"comment_content":"Eureka就有僵尸节点的问题，一个服务下线后，消费者可能需要100多秒才能感知到","like_count":4},{"had_liked":false,"id":39701,"user_name":"pscj","can_delete":false,"product_type":"c1","uid":1052844,"ip_address":"","ucode":"E9547C6D23626C","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM4XjZjjDNic658J56twmLnFMmDy4iaD5qHvVKibT94tuoic6iaia9pRQia2zCCmakSJibRFHGiaiasEdiaGukWdw/132","comment_is_top":false,"comment_ctime":1542337486,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132272078","product_id":100014401,"comment_content":"吴浩同学的疑问也是我想问的，最开始中心里一个服务都没有。注册的时候为什么service不存在，就抛异常了，难道不应该是保存？","like_count":3},{"had_liked":false,"id":32407,"user_name":"风之翼","can_delete":false,"product_type":"c1","uid":1042447,"ip_address":"","ucode":"6748C750791F2B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e8/0f/6882889a.jpg","comment_is_top":false,"comment_ctime":1539566101,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10129500693","product_id":100014401,"comment_content":"请问老师，一个企业内有多个服务注册中心有什么利弊，是否可以通过规范强制要求各个部门使用公共的注册中心，可能存在什么需要注意的问题？","like_count":2,"discussions":[{"author":{"id":1622655,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c2/7f/7b22f12b.jpg","nickname":"乔","note":"","ucode":"1286F8742B4A01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296739,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596636966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103505,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1560469339,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5855436635","product_id":100014401,"comment_content":"如果注册中心挂了，重启服务调用者用它存储的服务提供者信息，如果服务提供者也存在不可用的怎么弄？","like_count":2},{"had_liked":false,"id":77502,"user_name":"gongxt","can_delete":false,"product_type":"c1","uid":1170750,"ip_address":"","ucode":"222C46E0615152","user_header":"https://static001.geekbang.org/account/avatar/00/11/dd/3e/c3028cd5.jpg","comment_is_top":false,"comment_ctime":1552957445,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5847924741","product_id":100014401,"comment_content":"反注册，服务提供者什么时候去调用这个接口呢？  如果服务提供者这个时候自己崩溃了","like_count":1},{"had_liked":false,"id":39354,"user_name":"英宁","can_delete":false,"product_type":"c1","uid":1241380,"ip_address":"","ucode":"C6CB1C4FFCADC7","user_header":"https://static001.geekbang.org/account/avatar/00/12/f1/24/d15cf6af.jpg","comment_is_top":false,"comment_ctime":1542252669,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5837219965","product_id":100014401,"comment_content":"注册了节点不要update_sign嚒？","like_count":1},{"had_liked":false,"id":336923,"user_name":"Geek_d6f50f","can_delete":false,"product_type":"c1","uid":1793213,"ip_address":"","ucode":"4AA490453CF4FB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/wwM75BhyU43UYOJ6fZCZgY6pfNPGHHRlooPLQEtDGUNic4aLRHWmBRTpIiblBAFheUVm9Sw8HWAChcFsnVM2sd5Q/132","comment_is_top":false,"comment_ctime":1646469126,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646469126","product_id":100014401,"comment_content":"这一节没太看懂，感觉有点矛盾，对service、cluster，前后的说法不一致，请老师详细再为我们举例解析一下，谢谢","like_count":0},{"had_liked":false,"id":331554,"user_name":"树心","can_delete":false,"product_type":"c1","uid":1589523,"ip_address":"","ucode":"6C329F0FF798B9","user_header":"https://static001.geekbang.org/account/avatar/00/18/41/13/ab14ad25.jpg","comment_is_top":false,"comment_ctime":1642650028,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1642650028","product_id":100014401,"comment_content":"具体存储的时候，一般是按照“服务 - 分组 - 节点信息”三层结构来存储，可以用下图来描述。Service 代表服务的具体分组，Cluster 代表服务的接口名，节点信息用 KV 存储 。 这里是不是写错了?分组- 服务-节点信息","like_count":0},{"had_liked":false,"id":331553,"user_name":"树心","can_delete":false,"product_type":"c1","uid":1589523,"ip_address":"","ucode":"6C329F0FF798B9","user_header":"https://static001.geekbang.org/account/avatar/00/18/41/13/ab14ad25.jpg","comment_is_top":false,"comment_ctime":1642650001,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1642650001","product_id":100014401,"comment_content":"具体存储的时候，一般是按照“服务 - 分组 - 节点信息”三层结构来存储，可以用下图来描述。Service 代表服务的具体分组，Cluster 代表服务的接口名，节点信息用 KV 存储。","like_count":0},{"had_liked":false,"id":314934,"user_name":"俯瞰风景.","can_delete":false,"product_type":"c1","uid":1044166,"ip_address":"","ucode":"A6DB68B7B84AEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg","comment_is_top":false,"comment_ctime":1633595137,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633595137","product_id":100014401,"comment_content":"注册中心提供的服务：<br>  1、服务提供者注册服务<br>  2、服务提供者反注册服务<br>  3、服务消费者查询服务列表<br>  4、服务消费者订阅服务变更<br><br>多注册中心：在实际应用中存在多注册中心的情况，对于服务消费者来说，要能够同时从多个注册中心订阅服务；对于服务提供者来说，要能够同时向多个注册中心注册服务。<br><br>并行订阅服务：并行订阅服务可以有效地减少服务订阅的时间。<br><br>批量反注册服务：对于下线机器、节点销毁的场景，通过调用注册中心提供的批量反注册接口，一次调用就可以把该节点上提供的所有服务同时反注册掉，从而避免“僵尸节点”的出现。<br><br>服务变更信息增量更新：通过增量更新的方式，注册中心只返回变化的那部分节点信息，尤其在只有少数节点信息变更时，此举可以大大减少服务消费者从注册中心拉取的数据量，从而最大程度避免产生网络风暴。","like_count":0},{"had_liked":false,"id":221894,"user_name":"马振","can_delete":false,"product_type":"c1","uid":1136329,"ip_address":"","ucode":"94234F533219C1","user_header":"https://static001.geekbang.org/account/avatar/00/11/56/c9/7b3cd3e0.jpg","comment_is_top":false,"comment_ctime":1590629568,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1590629568","product_id":100014401,"comment_content":"反注册的含义是注册中心通过心跳主动删除不可用服务吗","like_count":0,"discussions":[{"author":{"id":1010144,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/e0/ff8ee2e2.jpg","nickname":"胡忠想","note":"","ucode":"0792605FC265B4","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":277079,"discussion_content":"反注册是调用注册中心的接口，删掉某个节点。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1590995455,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010144,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/e0/ff8ee2e2.jpg","nickname":"胡忠想","note":"","ucode":"0792605FC265B4","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":322894,"discussion_content":"反注册接口调用的触发时机在什么时候？由谁来触发？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604838638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":277079,"ip_address":""},"score":322894,"extra":""}]}]},{"had_liked":false,"id":186053,"user_name":"掸尘","can_delete":false,"product_type":"c1","uid":1110775,"ip_address":"","ucode":"38075365A1512F","user_header":"https://static001.geekbang.org/account/avatar/00/10/f2/f7/83a8a0d8.jpg","comment_is_top":false,"comment_ctime":1583746773,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1583746773","product_id":100014401,"comment_content":"“其次要查看注册的 Cluster（服务的接口名）是否存在？如果不存在就抛出异常，存在的话继续下一步。” 注册的时候，服务接口名称就存在了？","like_count":0},{"had_liked":false,"id":119175,"user_name":"Usher✨","can_delete":false,"product_type":"c1","uid":1191688,"ip_address":"","ucode":"EA33B4666D6AEE","user_header":"https://static001.geekbang.org/account/avatar/00/12/2f/08/6b38c0b4.jpg","comment_is_top":false,"comment_ctime":1564534016,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564534016","product_id":100014401,"comment_content":"大佬好，dubbo要怎么设置并行订阅","like_count":0},{"had_liked":false,"id":98006,"user_name":"LYy","can_delete":false,"product_type":"c1","uid":1102062,"ip_address":"","ucode":"8D5C39B9531E71","user_header":"https://static001.geekbang.org/account/avatar/00/10/d0/ee/f5c5e191.jpg","comment_is_top":false,"comment_ctime":1558870612,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1558870612","product_id":100014401,"comment_content":"问题三和问题四产生的根源都是因为消费者直接感知提供者的节点信息引起的 只要消除这层复杂度 问题三和问题四就迎刃而解 解决办法就是引入负载均衡中间件：<br>1 提供者只对消费者暴露唯一的访问地址（如浮动ip，内部域名）<br>2 提供者的扩缩容只需要通过配置中心与负载均衡中间件交互，消费者不感知","like_count":1},{"had_liked":false,"id":88601,"user_name":"帽子丨影","can_delete":false,"product_type":"c1","uid":1225395,"ip_address":"","ucode":"2B34892A2DE83E","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/b3/798a4bb2.jpg","comment_is_top":false,"comment_ctime":1555950823,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555950823","product_id":100014401,"comment_content":"定时check sign一般间隔多久比较合理呢？","like_count":0},{"had_liked":false,"id":75191,"user_name":"饭粒","can_delete":false,"product_type":"c1","uid":1153455,"ip_address":"","ucode":"4C3220B0D43997","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg","comment_is_top":false,"comment_ctime":1552361625,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552361625","product_id":100014401,"comment_content":"老师，请教下多注册中心这两点“对于服务消费者来说，要能够同时从多个注册中心订阅服务；对于服务提供者来说，要能够同时向多个注册中心注册服务。”这个在dubbo和motan有很好的支持吗？据我有限的spring cloud使用时间看，它好像不支持这个。","like_count":0},{"had_liked":false,"id":43655,"user_name":"sliver_z","can_delete":false,"product_type":"c1","uid":1125198,"ip_address":"","ucode":"6FD0416A9E4FB6","user_header":"https://static001.geekbang.org/account/avatar/00/11/2b/4e/6dc3a5bf.jpg","comment_is_top":false,"comment_ctime":1543278108,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1543278108","product_id":100014401,"comment_content":"能不能讲讲，如果一个实例挂啦，怎么去调用另外一个服务，而不是报错","like_count":0,"discussions":[{"author":{"id":1438037,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg","nickname":"陈国林","note":"","ucode":"83D12F3E79F197","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":196575,"discussion_content":"先重试，重试耗尽后，换下一个实例","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583341026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":34772,"user_name":"北风之神","can_delete":false,"product_type":"c1","uid":1249385,"ip_address":"","ucode":"8B67CAE7343420","user_header":"https://static001.geekbang.org/account/avatar/00/13/10/69/ee6177bc.jpg","comment_is_top":false,"comment_ctime":1540292952,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1540292952","product_id":100014401,"comment_content":"这里说的注册中心落地是自己实现注册中心的意思吗？像eureka、consul、etcd这些注册中心实现，直接用不就可以了，使用这些也需要考虑你这些问题吗？","like_count":0},{"had_liked":false,"id":32548,"user_name":"我的球","can_delete":false,"product_type":"c1","uid":1265721,"ip_address":"","ucode":"1ACD1212239AA6","user_header":"","comment_is_top":false,"comment_ctime":1539605881,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1539605881","product_id":100014401,"comment_content":"服务提供者要保持长连接，发送心跳，是需要单独一个进程来维护的吗？谷歌了好多文章都没有提到，我是php，看了看dubbo的文档，有个容器的概念，但不是太懂jvm，tomcat的原理，所以不知道dubbo的启动流程？","like_count":0},{"had_liked":false,"id":28064,"user_name":"秋天","can_delete":false,"product_type":"c1","uid":1057056,"ip_address":"","ucode":"A7E1D953EF7E17","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/20/1299e137.jpg","comment_is_top":false,"comment_ctime":1538003853,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1538003853","product_id":100014401,"comment_content":"反注册这个想法借鉴于哪里的？","like_count":0},{"had_liked":false,"id":26614,"user_name":"沙漠之鹰","can_delete":false,"product_type":"c1","uid":1222887,"ip_address":"","ucode":"9FB290B874317F","user_header":"https://static001.geekbang.org/account/avatar/00/12/a8/e7/b86938a1.jpg","comment_is_top":false,"comment_ctime":1537697547,"is_pvip":false,"replies":[{"id":"9794","content":"针对eureka这种ap方案","user_name":"作者回复","user_name_real":"古月中心相心","uid":"1010144","ctime":1537845767,"ip_address":"","comment_id":26614,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1537697547","product_id":100014401,"comment_content":"zk似乎能保证节点变更对订阅者的及时变更，这块批量反注册僵尸节点是针对哪个注册中心组件而言呢","like_count":0,"discussions":[{"author":{"id":1010144,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/e0/ff8ee2e2.jpg","nickname":"胡忠想","note":"","ucode":"0792605FC265B4","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":424685,"discussion_content":"针对eureka这种ap方案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1537845767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":25622,"user_name":"feimeng0532","can_delete":false,"product_type":"c1","uid":1182786,"ip_address":"","ucode":"427B5C9D65C62A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/42/fbd028c2.jpg","comment_is_top":false,"comment_ctime":1537402050,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1537402050","product_id":100014401,"comment_content":"服务提供者反注册，服务成为僵尸，服务自己怎么知道","like_count":0},{"had_liked":false,"id":25577,"user_name":"莲花","can_delete":false,"product_type":"c1","uid":1220494,"ip_address":"","ucode":"3260F7DA59332D","user_header":"https://static001.geekbang.org/account/avatar/00/12/9f/8e/45ffff8f.jpg","comment_is_top":false,"comment_ctime":1537367460,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1537367460","product_id":100014401,"comment_content":"增量更新怎么增量更新的？","like_count":0},{"had_liked":false,"id":25576,"user_name":"莲花","can_delete":false,"product_type":"c1","uid":1220494,"ip_address":"","ucode":"3260F7DA59332D","user_header":"https://static001.geekbang.org/account/avatar/00/12/9f/8e/45ffff8f.jpg","comment_is_top":false,"comment_ctime":1537367418,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1537367418","product_id":100014401,"comment_content":"dubbo中，消费者从注册中心中拉取服务可用节点这个操作一般是什么时候发生的？","like_count":0},{"had_liked":false,"id":25345,"user_name":"Liam","can_delete":false,"product_type":"c1","uid":1094597,"ip_address":"","ucode":"1D15D3B64F2606","user_header":"https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg","comment_is_top":false,"comment_ctime":1537317583,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1537317583","product_id":100014401,"comment_content":"注册的逻辑有些迷糊，服务注册之前注册中心就已经拿到白名单，服务了吗？不然怎么校验呢","like_count":0},{"had_liked":false,"id":25053,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1198347,"ip_address":"","ucode":"C91BB475625B20","user_header":"https://static001.geekbang.org/account/avatar/00/12/49/0b/db412e36.jpg","comment_is_top":false,"comment_ctime":1537239323,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1537239323","product_id":100014401,"comment_content":"本文中订阅的含义是定期去轮训读取服务节点信息？zookeeper的订阅应该是节点有变更，订阅者可以收到节点变更通知","like_count":0},{"had_liked":false,"id":24937,"user_name":"拉欧","can_delete":false,"product_type":"c1","uid":1206605,"ip_address":"","ucode":"40996A8093A95F","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg","comment_is_top":false,"comment_ctime":1537232184,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1537232184","product_id":100014401,"comment_content":"我们开始用thrift做rpc,注册中心是单独的服务，本地服务从注册中心拉去xml信息并保存，缺点是无法及时变更。<br>后来改成了zookeeper做注册中心，但是会有单点问题，需要集群保证zookeeper的可用性","like_count":0},{"had_liked":false,"id":24916,"user_name":"Stalary","can_delete":false,"product_type":"c1","uid":1101749,"ip_address":"","ucode":"F69AFF7C958D31","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/b5/d1ec6a7d.jpg","comment_is_top":false,"comment_ctime":1537230501,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1537230501","product_id":100014401,"comment_content":"查询节点信息的快照那里感觉图文有点不一致呢？有点不太明白，希望老师解答","like_count":0}]}