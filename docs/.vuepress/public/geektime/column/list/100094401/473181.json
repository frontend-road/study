{"id":473181,"title":"33 | ç¼–è¯‘åŸç†ï¼ˆä¸­ï¼‰ï¼šVue Compileræ¨¡å—å…¨è§£æ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å¤§åœ£ã€‚</p><p>ä¸Šä¸€è®²æˆ‘å¸¦ä½ æ‰‹å†™äº†ä¸€ä¸ªè¿·ä½ çš„Vue compilerï¼Œè¿˜å­¦ä¹ äº†ç¼–è¯‘åŸç†çš„åŸºç¡€çŸ¥è¯†ã€‚é€šè¿‡å®ç°è¿™ä¸ªè¿·ä½ Vue compilerï¼Œæˆ‘ä»¬çŸ¥é“äº†tokenizerå¯ä»¥ç”¨æ¥åšè¯­å¥åˆ†æï¼Œè€Œparseè´Ÿè´£ç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ASTã€‚ç„¶åæˆ‘ä»¬ä¸€èµ·åˆ†æASTä¸­çš„Vueè¯­æ³•ï¼Œæœ€åé€šè¿‡generateå‡½æ•°ç”Ÿæˆæœ€ç»ˆçš„ä»£ç ã€‚</p><p>ä»Šå¤©æˆ‘å°±å¸¦ä½ æ·±å…¥Vueçš„compileræºç ä¹‹ä¸­ï¼Œçœ‹çœ‹Vueå†…éƒ¨åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ã€‚æœ‰äº†ä¸Šä¸€è®²ç¼–è¯‘åŸç†çš„å…¥é—¨åŸºç¡€ï¼Œä½ ä¼šå¯¹Compileræ‰§è¡Œå…¨æµç¨‹æœ‰æ›´æ·±çš„ç†è§£ã€‚</p><h2>Vue compilerå…¥å£åˆ†æ</h2><p>Vue 3å†…éƒ¨æœ‰4ä¸ªå’Œcompilerç›¸å…³çš„åŒ…ã€‚compiler-domå’Œcompiler-coreè´Ÿè´£å®ç°æµè§ˆå™¨ç«¯çš„ç¼–è¯‘ï¼Œè¿™ä¸¤ä¸ªåŒ…æ˜¯æˆ‘ä»¬éœ€è¦æ·±å…¥ç ”ç©¶çš„ï¼Œcompiler-ssrè´Ÿè´£æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œæˆ‘ä»¬åé¢è®²ssrçš„æ—¶å€™å†ç ”ç©¶ï¼Œcompiler-sfcæ˜¯ç¼–è¯‘.vueå•æ–‡ä»¶ç»„ä»¶çš„ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œæ¢ç´¢ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¿›å…¥åˆ°vue-next/packages/compiler-dom/index.tsæ–‡ä»¶ä¸‹ï¼Œåœ¨<a href=\"https://github.com/vuejs/vue-next/blob/master/packages/compiler-dom/src/index.ts#L40\">GitHub</a>ä¸Šä½ å¯ä»¥æ‰¾åˆ°ä¸‹é¢è¿™æ®µä»£ç ã€‚</p><p>compilerå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°templateï¼Œå®ƒæ˜¯æˆ‘ä»¬é¡¹ç›®ä¸­çš„æ¨¡æ¿å­—ç¬¦ä¸²ï¼›ç¬¬äºŒä¸ªå‚æ•°optionsæ˜¯ç¼–è¯‘çš„é…ç½®ï¼Œå†…éƒ¨è°ƒç”¨äº†baseCompileå‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„è°ƒç”¨å…³ç³»å’Œruntime-domã€runtime-coreçš„å…³ç³»ç±»ä¼¼ï¼Œcompiler-domè´Ÿè´£ä¼ å…¥æµè§ˆå™¨Domç›¸å…³çš„APIï¼Œå®é™…ç¼–è¯‘çš„baseCompileæ˜¯ç”±compiler-coreæä¾›çš„ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-javascript\">export function compile(\n  template: string,\n  options: CompilerOptions = {}\n): CodegenResult {\n  return baseCompile(\n    template,\n    extend({}, parserOptions, options, {\n      nodeTransforms: [\n        // ignore &lt;script&gt; and &lt;tag&gt;\n        // this is not put inside DOMNodeTransforms because that list is used\n        // by compiler-ssr to generate vnode fallback branches\n        ignoreSideEffectTags,\n        ...DOMNodeTransforms,\n        ...(options.nodeTransforms || [])\n      ],\n      directiveTransforms: extend(\n        {},\n        DOMDirectiveTransforms,\n        options.directiveTransforms || {}\n      ),\n      transformHoist: __BROWSER__ ? null : stringifyStatic\n    })\n  )\n}\n</code></pre><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹compiler-domåšäº†å“ªäº›é¢å¤–çš„é…ç½®ã€‚</p><p>é¦–å…ˆï¼ŒparserOptionä¼ å…¥äº†parseçš„é…ç½®ï¼Œé€šè¿‡parserOptionä¼ é€’çš„isNativeTagæ¥åŒºåˆ†elementå’Œcomponentã€‚è¿™é‡Œçš„å®ç°ä¹Ÿéå¸¸ç®€å•ï¼ŒæŠŠæ‰€æœ‰htmlçš„æ ‡ç­¾åå­˜å‚¨åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œç„¶åå°±å¯ä»¥å¾ˆè½»æ¾åœ°åˆ¤æ–­å‡ºdivæ˜¯æµè§ˆå™¨è‡ªå¸¦çš„elementã€‚</p><p>baseCompileä¼ é€’çš„å…¶ä»–å‚æ•°nodeTransformså’ŒdirectiveTransformsï¼Œå®ƒä»¬åšçš„ä¹Ÿæ˜¯å’Œä¸Šé¢ä»£ç ç±»ä¼¼çš„äº‹ã€‚</p><pre><code class=\"language-javascript\">\nexport const parserOptions: ParserOptions = {\n  isVoidTag,\n  isNativeTag: tag =&gt; isHTMLTag(tag) || isSVGTag(tag),\n  isPreTag: tag =&gt; tag === 'pre',\n  decodeEntities: __BROWSER__ ? decodeHtmlBrowser : decodeHtml,\n\n  isBuiltInComponent: (tag: string): symbol | undefined =&gt; {\n    if (isBuiltInType(tag, `Transition`)) {\n      return TRANSITION\n    } else if (isBuiltInType(tag, `TransitionGroup`)) {\n      return TRANSITION_GROUP\n    }\n  },\n  ...\n}\nconst HTML_TAGS =\n  'html,body,base,head,link,meta,style,title,address,article,aside,footer,' +\n  'header,h1,h2,h3,h4,h5,h6,nav,section,div,dd,dl,dt,figcaption,' +\n  'figure,picture,hr,img,li,main,ol,p,pre,ul,a,b,abbr,bdi,bdo,br,cite,code,' +\n  'data,dfn,em,i,kbd,mark,q,rp,rt,ruby,s,samp,small,span,strong,sub,sup,' +\n  'time,u,var,wbr,area,audio,map,track,video,embed,object,param,source,' +\n  'canvas,script,noscript,del,ins,caption,col,colgroup,table,thead,tbody,td,' +\n  'th,tr,button,datalist,fieldset,form,input,label,legend,meter,optgroup,' +\n  'option,output,progress,select,textarea,details,dialog,menu,' +\n  'summary,template,blockquote,iframe,tfoot'\nexport const isHTMLTag = /*#__PURE__*/ makeMap(HTML_TAGS)\n</code></pre><h2>Vueæµè§ˆå™¨ç«¯ç¼–è¯‘çš„æ ¸å¿ƒæµç¨‹</h2><p>ç„¶åï¼Œæˆ‘ä»¬è¿›å…¥åˆ°baseCompileå‡½æ•°ä¸­ï¼Œè¿™å°±æ˜¯Vueæµè§ˆå™¨ç«¯ç¼–è¯‘çš„æ ¸å¿ƒæµç¨‹ã€‚</p><p>ä¸‹é¢çš„ä»£ç ä¸­å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡baseParseæŠŠä¼ é€’çš„templateè§£ææˆASTï¼Œç„¶åé€šè¿‡transformå‡½æ•°å¯¹ASTè¿›è¡Œè¯­ä¹‰åŒ–åˆ†æï¼Œæœ€åé€šè¿‡generateå‡½æ•°ç”Ÿæˆä»£ç ã€‚</p><p>è¿™ä¸ªä¸»è¦é€»è¾‘å’Œæˆ‘ä»¬å†™çš„è¿·ä½ compileråŸºæœ¬ä¸€è‡´ï¼Œè¿™äº›å‡½æ•°å¤§æ¦‚è¦åšçš„äº‹ä½ ä¹Ÿå¿ƒä¸­æœ‰æ•°äº†ã€‚è¿™é‡Œä½ ä¹Ÿèƒ½ä½“éªŒåˆ°ï¼Œäº²æ‰‹å®ç°ä¸€ä¸ªè¿·ä½ ç‰ˆæœ¬å¯¹æˆ‘ä»¬é˜…è¯»æºç å¾ˆæœ‰å¸®åŠ©ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ°è¿™å‡ ä¸ªå‡½æ•°ä¹‹ä¸­å»ï¼Œçœ‹ä¸€ä¸‹è·Ÿè¿·ä½ compileré‡Œçš„å®ç°ç›¸æ¯”ï¼Œæˆ‘ä»¬åˆ°åº•åšäº†å“ªäº›ä¼˜åŒ–ã€‚</p><pre><code class=\"language-javascript\">export function baseCompile(\n  template: string | RootNode,\n  options: CompilerOptions = {}\n): CodegenResult {\n  const ast = isString(template) ? baseParse(template, options) : template\n  const [nodeTransforms, directiveTransforms] =\n    getBaseTransformPreset(prefixIdentifiers)\n\n  transform(\n    ast,\n    extend({}, options, {\n      prefixIdentifiers,\n      nodeTransforms: [\n        ...nodeTransforms,\n        ...(options.nodeTransforms || []) // user transforms\n      ],\n      directiveTransforms: extend(\n        {},\n        directiveTransforms,\n        options.directiveTransforms || {} // user transforms\n      )\n    })\n  )\n  return generate(\n    ast,\n    extend({}, options, {\n      prefixIdentifiers\n    })\n  )\n}\n\n</code></pre><p>ä¸Šä¸€è®²ä¸­æˆ‘ä»¬ä½“éªŒäº†Vueçš„åœ¨çº¿æ¨¡æ¿ç¼–è¯‘ç¯å¢ƒï¼Œå¯ä»¥åœ¨consoleä¸­çœ‹åˆ°Vueè§£æå¾—åˆ°çš„ASTã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªASTæ¯”è¿·ä½ ç‰ˆå¤šäº†å¾ˆå¤šé¢å¤–çš„å±æ€§ã€‚<strong>locç”¨æ¥æè¿°èŠ‚ç‚¹å¯¹åº”ä»£ç çš„ä¿¡æ¯ï¼Œcomponentå’Œdirectiveç”¨æ¥è®°å½•ä»£ç ä¸­å‡ºç°çš„ç»„ä»¶å’ŒæŒ‡ä»¤ç­‰ç­‰</strong>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0e/3f/0e264bc3ffcfa67babec3b1cf8047d3f.png?wh=1920x982\" alt=\"å›¾ç‰‡\"></p><p>ç„¶åæˆ‘ä»¬è¿›å…¥åˆ°baseParseå‡½æ•°ä¸­, è¿™é‡Œçš„createParserContextå’ŒcreateRootç”¨æ¥ç”Ÿæˆä¸Šä¸‹æ–‡ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œä¿å­˜å½“å‰parseå‡½æ•°ä¸­éœ€è¦å…±äº«çš„æ•°æ®å’Œå˜é‡ï¼Œæœ€åè°ƒç”¨parseChildrenã€‚</p><p>childrenå†…éƒ¨å¼€å§‹åˆ¤æ–­&lt;å¼€å¤´çš„æ ‡è¯†ç¬¦ï¼Œåˆ¤æ–­å¼€å§‹è¿˜æ˜¯é—­åˆæ ‡ç­¾åï¼Œæ¥ç€ä¼šç”Ÿæˆä¸€ä¸ªnodesæ•°ç»„ã€‚å…¶ä¸­ï¼ŒadvanceByå‡½æ•°è´Ÿè´£æ›´æ–°contextä¸­çš„sourceç”¨æ¥å‘å‰éå†ä»£ç ï¼Œæœ€ç»ˆå¯¹ä¸åŒçš„åœºæ™¯æ‰§è¡Œä¸åŒçš„å‡½æ•°ã€‚</p><pre><code class=\"language-javascript\">export function baseParse(\n  content: string,\n  options: ParserOptions = {}\n): RootNode {\n  const context = createParserContext(content, options)\n  const start = getCursor(context)\n  return createRoot(\n    parseChildren(context, TextModes.DATA, []),\n    getSelection(context, start)\n  )\n}\nfunction parseChildren(\n  context: ParserContext,\n  mode: TextModes,\n  ancestors: ElementNode[]\n): TemplateChildNode[] {\n  const parent = last(ancestors)\n  // ä¾æ¬¡ç”Ÿæˆnode\n  const nodes: TemplateChildNode[] = []\n  // å¦‚æœéå†æ²¡ç»“æŸ\n  while (!isEnd(context, mode, ancestors)) {\n\n    const s = context.source\n    let node: TemplateChildNode | TemplateChildNode[] | undefined = undefined\n    \n    if (mode === TextModes.DATA || mode === TextModes.RCDATA) {\n      if (!context.inVPre &amp;&amp; startsWith(s, context.options.delimiters[0])) {\n        // å¤„ç†vueçš„å˜é‡æ ‡è¯†ç¬¦ï¼Œä¸¤ä¸ªå¤§æ‹¬å· '{{'\n        node = parseInterpolation(context, mode)\n      } else if (mode === TextModes.DATA &amp;&amp; s[0] === '&lt;') {\n        // å¤„ç†&lt;å¼€å¤´çš„ä»£ç ï¼Œå¯èƒ½æ˜¯&lt;div&gt;ä¹Ÿæœ‰å¯èƒ½æ˜¯&lt;/div&gt; æˆ–è€…&lt;!çš„æ³¨é‡Š\n        if (s.length === 1) {\n          // é•¿åº¦æ˜¯1ï¼Œåªæœ‰ä¸€ä¸ª&lt; æœ‰é—®é¢˜ æŠ¥é”™\n          emitError(context, ErrorCodes.EOF_BEFORE_TAG_NAME, 1)\n        } else if (s[1] === '!') {\n          // htmlæ³¨é‡Š\n          if (startsWith(s, '&lt;!--')) {\n            node = parseComment(context)\n          } else if (startsWith(s, '&lt;!DOCTYPE')) {\n              \n            // DOCTYPE\n            node = parseBogusComment(context)\n          }\n        } else if (s[1] === '/') {\n           //&lt;/ å¼€å¤´çš„æ ‡ç­¾ï¼Œç»“æŸæ ‡ç­¾\n          // https://html.spec.whatwg.org/multipage/parsing.html#end-tag-open-state\n          if (/[a-z]/i.test(s[2])) {\n            emitError(context, ErrorCodes.X_INVALID_END_TAG)\n            parseTag(context, TagType.End, parent)\n            continue\n          } \n        } else if (/[a-z]/i.test(s[1])) {\n          // è§£æèŠ‚ç‚¹\n          node = parseElement(context, ancestors)\n          // 2.x &lt;template&gt; with no directive compat\n          node = node.children\n          }\n        }\n      }\n    }\n    if (!node) {\n      // æ–‡æœ¬\n      node = parseText(context, mode)\n    }\n    // nodeæ ‘æ•°ç»„ï¼Œéå†puish\n    if (isArray(node)) {\n      for (let i = 0; i &lt; node.length; i++) {\n        pushNode(nodes, node[i])\n      }\n    } else {\n      pushNode(nodes, node)\n    }\n  }\n\n  return removedWhitespace ? nodes.filter(Boolean) : nodes\n}\n</code></pre><p>parseInterpolationå’ŒparseTextå‡½æ•°çš„é€»è¾‘æ¯”è¾ƒç®€å•ã€‚parseInterpolationè´Ÿè´£è¯†åˆ«å˜é‡çš„åˆ†éš”ç¬¦ {{ å’Œ}} ï¼Œç„¶åé€šè¿‡parseTextDataè·å–å˜é‡çš„å€¼ï¼Œå¹¶ä¸”é€šè¿‡innerStartå’ŒinnerEndå»è®°å½•æ’å€¼çš„ä½ç½®ï¼›parseTextè´Ÿè´£å¤„ç†æ¨¡æ¿ä¸­çš„æ™®é€šæ–‡æœ¬ï¼Œä¸»è¦æ˜¯æŠŠæ–‡æœ¬åŒ…è£¹æˆASTå¯¹è±¡ã€‚</p><p>æ¥ç€æˆ‘ä»¬çœ‹çœ‹å¤„ç†èŠ‚ç‚¹çš„parseElementå‡½æ•°éƒ½åšäº†ä»€ä¹ˆã€‚é¦–å…ˆè¦åˆ¤æ–­preå’Œv-preæ ‡ç­¾ï¼Œç„¶åé€šè¿‡isVoidTagåˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä»compiler-domä¸­ä¼ æ¥çš„ï¼Œä¹‹åä¼šé€’å½’è°ƒç”¨parseChildrenï¼Œæ¥ç€å†è§£æå¼€å§‹æ ‡ç­¾ã€è§£æå­èŠ‚ç‚¹ï¼Œæœ€åè§£æç»“æŸæ ‡ç­¾ã€‚</p><pre><code class=\"language-javascript\">const VOID_TAGS =\n  'area,base,br,col,embed,hr,img,input,link,meta,param,source,track,wbr'\n\nexport const isVoidTag = /*#__PURE__*/ makeMap(VOID_TAGS)\nfunction parseElement(\n  context: ParserContext,\n  ancestors: ElementNode[]\n): ElementNode | undefined {\n  // Start tag.\n  // æ˜¯ä¸æ˜¯preæ ‡ç­¾å’Œv-preæ ‡ç­¾\n  const wasInPre = context.inPre\n  const wasInVPre = context.inVPre\n  const parent = last(ancestors)\n  // è§£ææ ‡ç­¾èŠ‚ç‚¹\n  const element = parseTag(context, TagType.Start, parent)\n  const isPreBoundary = context.inPre &amp;&amp; !wasInPre\n  const isVPreBoundary = context.inVPre &amp;&amp; !wasInVPre\n\n  if (element.isSelfClosing || context.options.isVoidTag(element.tag)) {\n    // #4030 self-closing &lt;pre&gt; tag\n    if (isPreBoundary) {\n      context.inPre = false\n    }\n    if (isVPreBoundary) {\n      context.inVPre = false\n    }\n    return element\n  }\n\n  // Children.\n  ancestors.push(element)\n  const mode = context.options.getTextMode(element, parent)\n  const children = parseChildren(context, mode, ancestors)\n  ancestors.pop()\n  element.children = children\n\n  // End tag.\n  if (startsWithEndTagOpen(context.source, element.tag)) {\n    parseTag(context, TagType.End, parent)\n  } else {\n    emitError(context, ErrorCodes.X_MISSING_END_TAG, 0, element.loc.start)\n    if (context.source.length === 0 &amp;&amp; element.tag.toLowerCase() === 'script') {\n      const first = children[0]\n      if (first &amp;&amp; startsWith(first.loc.source, '&lt;!--')) {\n        emitError(context, ErrorCodes.EOF_IN_SCRIPT_HTML_COMMENT_LIKE_TEXT)\n      }\n    }\n  }\n\n  element.loc = getSelection(context, element.loc.start)\n\n  if (isPreBoundary) {\n    context.inPre = false\n  }\n  if (isVPreBoundary) {\n    context.inVPre = false\n  }\n  return element\n}\n</code></pre><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è§£æèŠ‚ç‚¹çš„parseTagå‡½æ•°çš„é€»è¾‘ï¼ŒåŒ¹é…æ–‡æœ¬æ ‡ç­¾ç»“æŸçš„ä½ç½®åï¼Œå…ˆé€šè¿‡parseAttributeså‡½æ•°å¤„ç†å±æ€§ï¼Œç„¶åå¯¹preå’Œv-preæ ‡ç­¾è¿›è¡Œæ£€æŸ¥ï¼Œæœ€åé€šè¿‡isComponentå‡½æ•°åˆ¤æ–­æ˜¯å¦ä¸ºç»„ä»¶ã€‚</p><p>isComponentå†…éƒ¨ä¼šé€šè¿‡compiler-domä¼ é€’çš„isNativeTagæ¥è¾…åŠ©åˆ¤æ–­ç»“æœï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªæè¿°èŠ‚ç‚¹çš„å¯¹è±¡ï¼ŒåŒ…å«å½“å‰èŠ‚ç‚¹æ‰€æœ‰è§£æä¹‹åçš„ä¿¡æ¯ï¼Œtagè¡¨ç¤ºæ ‡ç­¾åï¼Œchildrenè¡¨ç¤ºå­èŠ‚ç‚¹çš„æ•°ç»„ï¼Œå…·ä½“ä»£ç æˆ‘æ”¾åœ¨äº†åé¢ã€‚</p><pre><code class=\"language-javascript\">function parseTag(\n  context: ParserContext,\n  type: TagType,\n  parent: ElementNode | undefined\n): ElementNode | undefined {\n\n  // Tag open. \n  const start = getCursor(context)\n  //åŒ¹é…æ ‡ç­¾ç»“æŸçš„ä½ç½®\n  const match = /^&lt;\\/?([a-z][^\\t\\r\\n\\f /&gt;]*)/i.exec(context.source)!\n  const tag = match[1]\n  const ns = context.options.getNamespace(tag, parent)\n  // å‘å‰éå†ä»£ç \n  advanceBy(context, match[0].length)\n  advanceSpaces(context)\n\n  // save current state in case we need to re-parse attributes with v-pre\n  const cursor = getCursor(context)\n  const currentSource = context.source\n\n  // check &lt;pre&gt; tag \n  if (context.options.isPreTag(tag)) {\n    context.inPre = true\n  }\n  // Attributes.\n  // è§£æå±æ€§\n  let props = parseAttributes(context, type)\n  // check v-pre\n  if (){...}\n  // Tag close.\n  let isSelfClosing = false\n  if (type === TagType.End) {\n    return\n  }\n\n  let tagType = ElementTypes.ELEMENT\n  if (!context.inVPre) {\n    if (tag === 'slot') {\n      tagType = ElementTypes.SLOT\n    } else if (tag === 'template') {\n      if (\n        props.some(\n          p =&gt;\n            p.type === NodeTypes.DIRECTIVE &amp;&amp; isSpecialTemplateDirective(p.name)\n        )\n      ) {\n        tagType = ElementTypes.TEMPLATE\n      }\n    } else if (isComponent(tag, props, context)) {\n      tagType = ElementTypes.COMPONENT\n    }\n  }\n\n  return {\n    type: NodeTypes.ELEMENT,\n    ns,\n    tag,\n    tagType,\n    props,\n    isSelfClosing,\n    children: [],\n    loc: getSelection(context, start),\n    codegenNode: undefined // to be created during transform phase\n  }\n}\n\n</code></pre><p>parseå‡½æ•°ç”ŸæˆASTä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªå®Œæ•´æè¿°templateçš„å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†templateä¸­æ‰€æœ‰çš„ä¿¡æ¯ã€‚</p><h2>ASTçš„è¯­ä¹‰åŒ–åˆ†æ</h2><p>ä¸‹ä¸€æ­¥æˆ‘ä»¬è¦å¯¹ASTè¿›è¡Œè¯­ä¹‰åŒ–çš„åˆ†æã€‚transformå‡½æ•°çš„æ‰§è¡Œæµç¨‹åˆ†æ”¯å¾ˆå¤šï¼Œ<strong>æ ¸å¿ƒçš„é€»è¾‘å°±æ˜¯è¯†åˆ«ä¸€ä¸ªä¸ªçš„Vueçš„è¯­æ³•ï¼Œå¹¶ä¸”è¿›è¡Œç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬ç»å¸¸æåˆ°çš„é™æ€æ ‡è®°å°±æ˜¯è¿™ä¸€æ­¥å®Œæˆçš„</strong>ã€‚</p><p>æˆ‘ä»¬è¿›å…¥åˆ°transformå‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå†…éƒ¨é€šè¿‡createTransformContextåˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«å½“å‰åˆ†æçš„å±æ€§é…ç½®ï¼ŒåŒ…æ‹¬æ˜¯å¦ssrï¼Œæ˜¯å¦é™æ€æå‡è¿˜æœ‰å·¥å…·å‡½æ•°ç­‰ç­‰ï¼Œè¿™ä¸ªå¯¹è±¡çš„å±æ€§ä½ å¯ä»¥åœ¨ <a href=\"https://github.com/vuejs/vue-next/blob/0dc521b9e15ce4aa3d5229e90d2173644529e92b/packages/compiler-core/src/transforms/transformElement.ts\">GitHub</a>ä¸Šçœ‹åˆ°ã€‚</p><pre><code class=\"language-javascript\">\n\nexport function transform(root: RootNode, options: TransformOptions) {\n  const context = createTransformContext(root, options)\n  traverseNode(root, context)\n  if (options.hoistStatic) {\n    hoistStatic(root, context)\n  }\n  if (!options.ssr) {\n    createRootCodegen(root, context)\n  }\n  // finalize meta information\n  root.helpers = [...context.helpers.keys()]\n  root.components = [...context.components]\n  root.directives = [...context.directives]\n  root.imports = context.imports\n  root.hoists = context.hoists\n  root.temps = context.temps\n  root.cached = context.cached\n\n  if (__COMPAT__) {\n    root.filters = [...context.filters!]\n  }\n}\n\n</code></pre><p>ç„¶åé€šè¿‡traverseNodeå³å¯ç¼–è¯‘ASTæ‰€æœ‰çš„èŠ‚ç‚¹ã€‚æ ¸å¿ƒçš„è½¬æ¢æµç¨‹æ˜¯åœ¨éå†ä¸­å®ç°ï¼Œå†…éƒ¨ä½¿ç”¨switchåˆ¤æ–­node.typeæ‰§è¡Œä¸åŒçš„å¤„ç†é€»è¾‘ã€‚æ¯”å¦‚å¦‚æœæ˜¯Interpolationï¼Œå°±éœ€è¦åœ¨helperä¸­å¯¼å…¥toDisplayStringå·¥å…·å‡½æ•°ï¼Œè¿™ä¸ªè¿·ä½ ç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¹Ÿå®ç°è¿‡ã€‚</p><pre><code class=\"language-javascript\">\nexport function traverseNode(\n  node: RootNode | TemplateChildNode,\n  context: TransformContext\n) {\n  context.currentNode = node\n  // apply transform plugins\n  const { nodeTransforms } = context\n  const exitFns = []\n  for (let i = 0; i &lt; nodeTransforms.length; i++) {\n    // å¤„ç†exitFns\n  }\n  swtch (node.type) {\n    case NodeTypes.COMMENT:\n      if (!context.ssr) {\n        context.helper(CREATE_COMMENT)\n      }\n      break\n    case NodeTypes.INTERPOLATION:\n      if (!context.ssr) {\n        context.helper(TO_DISPLAY_STRING)\n      }\n      break\n    case NodeTypes.IF:\n      for (let i = 0; i &lt; node.branches.length; i++) {\n        traverseNode(node.branches[i], context)\n      }\n      break\n    case NodeTypes.IF_BRANCH:\n    case NodeTypes.FOR:\n    case NodeTypes.ELEMENT:\n    case NodeTypes.ROOT:\n      traverseChildren(node, context)\n      break\n  }\n\n  // exit transforms\n  context.currentNode = node\n  let i = exitFns.length\n  while (i--) {\n    exitFns[i]()\n  }\n}\n\n</code></pre><p>transformä¸­è¿˜ä¼šè°ƒç”¨transformElementæ¥è½¬æ¢èŠ‚ç‚¹ï¼Œç”¨æ¥å¤„ç†propså’Œchildrençš„é™æ€æ ‡è®°ï¼ŒtransformTextç”¨æ¥è½¬æ¢æ–‡æœ¬ï¼Œè¿™é‡Œçš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œ ä½ å¯ä»¥è‡ªè¡Œåœ¨<a href=\"https://github.com/vuejs/vue-next/blob/0dc521b9e15ce4aa3d5229e90d2173644529e92b/packages/compiler-core/src/transforms/transformElement.ts\">Github</a>ä¸ŠæŸ¥é˜…ã€‚<br>\ntransformå‡½æ•°å‚æ•°ä¸­çš„nodeTransformså’ŒdirectiveTransformsä¼ é€’äº†Vueä¸­templateè¯­æ³•çš„é…ç½®ï¼Œè¿™ä¸ªä¸¤ä¸ªå‡½æ•°ç”±getBaseTransformPresetè¿”å›ã€‚</p><p>ä¸‹é¢çš„ä»£ç ä¸­ï¼ŒtransformIfå’ŒtransformForå‡½æ•°å¼è§£æVueä¸­v-ifå’Œv-forçš„è¯­æ³•è½¬æ¢ï¼ŒtransformOnå’ŒtransformModelæ˜¯è§£æv-onå’Œv-modelçš„è¯­æ³•è§£æï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨v-å¼€å¤´çš„è¯­æ³•ã€‚</p><pre><code class=\"language-javascript\">\n\nexport function getBaseTransformPreset(\n  prefixIdentifiers?: boolean\n): TransformPreset {\n  return [\n    [\n      transformOnce,\n      transformIf,\n      transformMemo,\n      transformFor,\n      ...(__COMPAT__ ? [transformFilter] : []),\n      ...(!__BROWSER__ &amp;&amp; prefixIdentifiers\n        ? [\n            // order is important\n            trackVForSlotScopes,\n            transformExpression\n          ]\n        : __BROWSER__ &amp;&amp; __DEV__\n        ? [transformExpression]\n        : []),\n      transformSlotOutlet,\n      transformElement,\n      trackSlotScopes,\n      transformText\n    ],\n    {\n      on: transformOn,\n      bind: transformBind,\n      model: transformModel\n    }\n  ]\n}\n\n</code></pre><p>ç„¶åæˆ‘ä»¬å†æ¥çœ‹çœ‹transformIfçš„å‡½æ•°å®ç°ã€‚é¦–å…ˆåˆ¤æ–­v-ifã€v-elseå’Œv-else-ifå±æ€§ï¼Œå†…éƒ¨é€šè¿‡createCodegenNodeForBranchæ¥åˆ›å»ºæ¡ä»¶åˆ†æ”¯ï¼Œåœ¨ASTä¸­æ ‡è®°å½“å‰v-ifçš„å¤„ç†é€»è¾‘ã€‚è¿™æ®µé€»è¾‘æ ‡è®°ç»“æŸåï¼Œåœ¨generateä¸­å°±ä¼šæŠŠv-ifæ ‡ç­¾å’Œåé¢çš„v-elseæ ‡ç­¾è§£ææˆä¸‰å…ƒè¡¨è¾¾å¼ã€‚</p><pre><code class=\"language-javascript\">export const transformIf = createStructuralDirectiveTransform(\n  /^(if|else|else-if)$/,\n  (node, dir, context) =&gt; {\n    return processIf(node, dir, context, (ifNode, branch, isRoot) =&gt; {\n      const siblings = context.parent!.children\n      let i = siblings.indexOf(ifNode)\n      let key = 0\n      while (i-- &gt;= 0) {\n        const sibling = siblings[i]\n        if (sibling &amp;&amp; sibling.type === NodeTypes.IF) {\n          key += sibling.branches.length\n        }\n      }\n      return () =&gt; {\n        if (isRoot) {\n          ifNode.codegenNode = createCodegenNodeForBranch(\n            branch,\n            key,\n            context\n          ) as IfConditionalExpression\n        } else {\n          // attach this branch's codegen node to the v-if root.\n          const parentCondition = getParentCondition(ifNode.codegenNode!)\n          parentCondition.alternate = createCodegenNodeForBranch(\n            branch,\n            key + ifNode.branches.length - 1,\n            context\n          )\n        }\n      }\n    })\n  }\n)\n</code></pre><p>transformå¯¹ASTåˆ†æç»“æŸä¹‹åï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªä¼˜åŒ–åçš„ASTå¯¹è±¡ï¼Œæœ€åæˆ‘ä»¬éœ€è¦è°ƒç”¨generateå‡½æ•°æœ€ç»ˆç”Ÿæˆrenderå‡½æ•°ã€‚</p><h2>templateåˆ°renderå‡½æ•°çš„è½¬åŒ–</h2><p>ç»“åˆä¸‹é¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œgenerateé¦–å…ˆé€šè¿‡createCodegenContextåˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç„¶åé€šè¿‡genModulePreambleç”Ÿæˆé¢„å…ˆå®šä¹‰å¥½çš„ä»£ç æ¨¡æ¿ï¼Œç„¶åç”Ÿæˆrenderå‡½æ•°ï¼Œæœ€åç”Ÿæˆåˆ›å»ºè™šæ‹ŸDOMçš„è¡¨è¾¾å¼ã€‚</p><pre><code class=\"language-javascript\">export function generate(\n  ast,\n  options\n): CodegenResult {\n  const context = createCodegenContext(ast, options)\n  const {\n    mode,\n    push,\n    prefixIdentifiers,\n    indent,\n    deindent,\n    newline,\n    scopeId,\n    ssr\n  } = context\n\n  if (!__BROWSER__ &amp;&amp; mode === 'module') {\n    // é¢„è®¾ä»£ç ï¼Œmoduleé£æ ¼ å°±æ˜¯importè¯­å¥\n    genModulePreamble(ast, preambleContext, genScopeId, isSetupInlined)\n  } else {\n    // é¢„è®¾ä»£ç ï¼Œå‡½æ•°é£æ ¼ å°±æ˜¯importè¯­å¥\n    genFunctionPreamble(ast, preambleContext)\n  }\n  // renderè¿˜æ˜¯ssrRender\n  const functionName = ssr ? `ssrRender` : `render`\n  const args = ssr ? ['_ctx', '_push', '_parent', '_attrs'] : ['_ctx', '_cache']\n  if (!__BROWSER__ &amp;&amp; options.bindingMetadata &amp;&amp; !options.inline) {\n    // binding optimization args\n    args.push('$props', '$setup', '$data', '$options')\n  }\n  const signature =\n    !__BROWSER__ &amp;&amp; options.isTS\n      ? args.map(arg =&gt; `${arg}: any`).join(',')\n      : args.join(', ')\n\n  if (isSetupInlined) {\n    push(`(${signature}) =&gt; {`)\n  } else {\n    push(`function ${functionName}(${signature}) {`)\n  }\n  indent()\n\n  // ç»„ä»¶ï¼ŒæŒ‡ä»¤å£°æ˜ä»£ç \n  if (ast.components.length) {\n    genAssets(ast.components, 'component', context)\n    if (ast.directives.length || ast.temps &gt; 0) {\n      newline()\n    }\n  }\n  if (ast.components.length || ast.directives.length || ast.temps) {\n    push(`\\n`)\n    newline()\n  }\n\n  if (ast.codegenNode) {\n    genNode(ast.codegenNode, context)\n  } else {\n    push(`null`)\n  }\n\n  if (useWithBlock) {\n    deindent()\n    push(`}`)\n  }\n\n  deindent()\n  push(`}`)\n\n  return {\n    ast,\n    code: context.code,\n    preamble: isSetupInlined ? preambleContext.code : ``,\n    // SourceMapGenerator does have toJSON() method but it's not in the types\n    map: context.map ? (context.map as any).toJSON() : undefined\n  }\n}\n\n</code></pre><p>æˆ‘ä»¬æ¥çœ‹ä¸‹å…³é”®çš„æ­¥éª¤ï¼ŒgenModulePreambleå‡½æ•°ç”Ÿæˆimporté£æ ¼çš„ä»£ç ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¿·ä½ ç‰ˆæœ¬ä¸­çš„åŠŸèƒ½ï¼šé€šè¿‡éå†helpersï¼Œç”Ÿæˆimportå­—ç¬¦ä¸²ï¼Œè¿™å¯¹åº”äº†ä»£ç çš„ç¬¬äºŒè¡Œã€‚</p><pre><code class=\"language-javascript\">// ç”Ÿæˆè¿™ä¸ª \n// import { toDisplayString as _toDisplayString, createElementVNode as _createElementVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\"\n\nfunction genModulePreamble(\n  ast: RootNode,\n  context: CodegenContext,\n  genScopeId: boolean,\n  inline?: boolean\n) {\n\n  if (genScopeId &amp;&amp; ast.hoists.length) {\n    ast.helpers.push(PUSH_SCOPE_ID, POP_SCOPE_ID)\n  }\n  // generate import statements for helpers\n  if (ast.helpers.length) {\n      push(\n        `import { ${ast.helpers\n          .map(s =&gt; `${helperNameMap[s]} as _${helperNameMap[s]}`)\n          .join(', ')} } from ${JSON.stringify(runtimeModuleName)}\\n`\n      )\n    }\n  }\n  ...\n}\n\n</code></pre><p>æ¥ä¸‹æ¥çš„æ­¥éª¤å°±æ˜¯ç”Ÿæˆæ¸²æŸ“å‡½æ•°renderå’Œcomponentçš„ä»£ç ï¼Œæœ€åé€šè¿‡genNodeç”Ÿæˆåˆ›å»ºè™šæ‹Ÿçš„ä»£ç ï¼Œæ‰§è¡Œswitchè¯­å¥ç”Ÿæˆä¸åŒçš„ä»£ç ï¼Œä¸€å…±æœ‰åå‡ ç§æƒ…å†µï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€èµ˜è¿°äº†ã€‚æˆ‘ä»¬å¯ä»¥å›é¡¾ä¸Šä¸€è®²ä¸­è¿·ä½ ä»£ç çš„é€»è¾‘ï¼Œæ€»ä¹‹é’ˆå¯¹å˜é‡ï¼Œæ ‡ç­¾ï¼Œv-ifå’Œv-foréƒ½æœ‰ä¸åŒçš„ä»£ç ç”Ÿæˆé€»è¾‘ï¼Œæœ€ç»ˆæ‰å®ç°äº†templateåˆ°renderå‡½æ•°çš„è½¬åŒ–ã€‚</p><pre><code class=\"language-javascript\">function genNode(node: CodegenNode | symbol | string, context: CodegenContext) {\n  if (isString(node)) {\n    context.push(node)\n    return\n  }\n  if (isSymbol(node)) {\n    context.push(context.helper(node))\n    return\n  }\n  switch (node.type) {\n    case NodeTypes.ELEMENT:\n    case NodeTypes.IF:\n    case NodeTypes.FOR:\n      genNode(node.codegenNode!, context)\n      break\n    case NodeTypes.TEXT:\n      genText(node, context)\n      break\n    case NodeTypes.SIMPLE_EXPRESSION:\n      genExpression(node, context)\n      break\n    case NodeTypes.INTERPOLATION:\n      genInterpolation(node, context)\n      break\n    case NodeTypes.TEXT_CALL:\n      genNode(node.codegenNode, context)\n      break\n    case NodeTypes.COMPOUND_EXPRESSION:\n      genCompoundExpression(node, context)\n      break\n    case NodeTypes.COMMENT:\n      genComment(node, context)\n      break\n    case NodeTypes.VNODE_CALL:\n      genVNodeCall(node, context)\n      break\n\n    case NodeTypes.JS_CALL_EXPRESSION:\n      genCallExpression(node, context)\n      break\n    case NodeTypes.JS_OBJECT_EXPRESSION:\n      genObjectExpression(node, context)\n      break\n    case NodeTypes.JS_ARRAY_EXPRESSION:\n      genArrayExpression(node, context)\n      break\n    case NodeTypes.JS_FUNCTION_EXPRESSION:\n      genFunctionExpression(node, context)\n      break\n    case NodeTypes.JS_CONDITIONAL_EXPRESSION:\n      genConditionalExpression(node, context)\n      break\n    case NodeTypes.JS_CACHE_EXPRESSION:\n      genCacheExpression(node, context)\n      break\n    case NodeTypes.JS_BLOCK_STATEMENT:\n      genNodeList(node.body, context, true, false)\n      break\n\n    /* istanbul ignore next */\n    case NodeTypes.IF_BRANCH:\n      // noop\n      break\n\n  }\n}\n</code></pre><h2></h2><h2>æ€»ç»“</h2><p>ä»Šå¤©çš„å†…å®¹åˆ°è¿™å°±è®²å®Œäº†ï¼Œæˆ‘ç»™ä½ æ€»ç»“ä¸€ä¸‹ä»Šå¤©è®²åˆ°çš„å†…å®¹å§ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬ä¸€èµ·åˆ†æäº†Vueä¸­çš„compileræ‰§è¡Œå…¨æµç¨‹ï¼Œæœ‰äº†ä¸Šä¸€è®²ç¼–è¯‘å…¥é—¨çŸ¥è¯†çš„åŸºç¡€ä¹‹åï¼Œä»Šå¤©çš„parseï¼Œtransformå’Œgenerateæ¨¡å—å°±æ˜¯åœ¨ä¸Šä¸€è®²çš„åŸºç¡€ä¹‹ä¸Šï¼Œæ›´åŠ å…¨é¢åœ°å®ç°ä»£ç çš„ç¼–è¯‘å’Œè½¬åŒ–ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/1e/a995298a4422d287a57e342dc105471e.jpg?wh=3510x1214\" alt=\"\"></p><p>ä¸Šé¢çš„æµç¨‹å›¾ä¸­ï¼Œæˆ‘ä»¬ä»£ç ä¸­çš„templateæ˜¯é€šè¿‡compilerå‡½æ•°è¿›è¡Œç¼–è¯‘è½¬æ¢ï¼Œcompilerå†…éƒ¨è°ƒç”¨äº†compiler-coreä¸­çš„baseCompileå‡½æ•°ï¼Œå¹¶ä¸”ä¼ é€’äº†æµè§ˆå™¨å¹³å°çš„è½¬æ¢é€»è¾‘ã€‚</p><p>æ¯”å¦‚isNativeTagç­‰å‡½æ•°ï¼ŒbaseCompieå‡½æ•°ä¸­é¦–å…ˆé€šè¿‡baseParseå‡½æ•°æŠŠtemplateå¤„ç†æˆä¸ºASTï¼Œå¹¶ä¸”ç”±transformå‡½æ•°è¿›è¡Œæ ‡è®°ä¼˜åŒ–ï¼Œtransfomå†…éƒ¨çš„transformIfï¼ŒtransformOnç­‰å‡½æ•°ä¼šå¯¹Vueä¸­çš„è¯­æ³•è¿›è¡Œæ ‡è®°ï¼Œè¿™æ ·åœ¨generateå‡½æ•°ä¸­å°±å¯ä»¥ä½¿ç”¨ä¼˜åŒ–åçš„ASTå»ç”Ÿæˆæœ€ç»ˆçš„renderå‡½æ•°ã€‚</p><p>æœ€ç»ˆï¼Œrenderå‡½æ•°ä¼šå’Œæˆ‘ä»¬å†™çš„setupå‡½æ•°ä¸€èµ·ç»„æˆç»„ä»¶å¯¹è±¡ï¼Œäº¤ç»™é¡µé¢è¿›è¡Œæ¸²æŸ“ã€‚åé¢æˆ‘ç‰¹æ„ä¸ºä½ ç»˜åˆ¶äº†ä¸€å¹…Vueå…¨æµç¨‹çš„æ¶æ„å›¾ï¼Œä½ å¯ä»¥ä¿å­˜ä¸‹æ¥éšæ—¶æŸ¥é˜…ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/97/3b266af3c5f43d235a8ec0e687bc4c97.jpg?wh=8312x4611\" alt=\"\"></p><p>Vueæºç ä¸­çš„ç¼–è¯‘ä¼˜åŒ–ä¹Ÿæ˜¯Vueæ¡†æ¶çš„äº®ç‚¹ä¹‹ä¸€ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿè¦æ€è€ƒç¼–è¯‘å™¨ä¼˜åŒ–çš„æœºåˆ¶ï¼Œå¯ä»¥æé«˜æµè§ˆå™¨è¿è¡Œæ—¶çš„æ€§èƒ½ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸­è¯¥å¦‚ä½•å€Ÿé‰´è¿™ç§æ€è·¯å‘¢ï¼Ÿä¸‹ä¸€è®²æˆ‘ä¼šè¯¦ç»†å‰–æç¼–è¯‘åŸç†åœ¨å®æˆ˜é‡Œçš„åº”ç”¨ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼Œtransformå‡½æ•°ä¸­é’ˆå¯¹Vueä¸­çš„è¯­æ³•æœ‰å¾ˆå¤šçš„å‡½æ•°å¤„ç†ï¼Œæ¯”å¦‚transformIfä¼šæŠŠv-ifæŒ‡ä»¤ç¼–è¯‘æˆä¸ºä¸€ä¸ªä¸‰å…ƒè¡¨è¾¾å¼ï¼Œè¯·ä½ ä»å…¶ä½™çš„å‡½æ•°é€‰ä¸€ä¸ªåœ¨è¯„è®ºåŒºåˆ†äº«transformå¤„ç†çš„ç»“æœå§ã€‚æ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†è§ï¼</p>","neighbors":{"left":{"article_title":"32ï½œç¼–è¯‘åŸç†ï¼ˆä¸Šï¼‰ï¼šæ‰‹å†™ä¸€ä¸ªè¿·ä½ Vue 3 Compilerçš„å…¥é—¨åŸç†","id":472927},"right":{"article_title":"34 | ç¼–è¯‘åŸç†ï¼ˆä¸‹ï¼‰ï¼šç¼–è¯‘åŸç†ç»™æˆ‘ä»¬å¸¦æ¥äº†ä»€ä¹ˆï¼Ÿ","id":473193}},"comments":[{"had_liked":false,"id":334466,"user_name":"Littleä½•","can_delete":false,"product_type":"c1","uid":1144834,"ip_address":"","ucode":"0CC4D21D61EAD6","user_header":"https://static001.geekbang.org/account/avatar/00/11/78/02/eeb3ce7f.jpg","comment_is_top":false,"comment_ctime":1644971200,"is_pvip":false,"replies":[{"id":"122175","content":"çœ‹ä¸æ‡‚çš„åœ°æ–¹å¯ä»¥å‘è€å¸ˆæé—®ï½","user_name":"ç¼–è¾‘å›å¤","comment_id":334466,"uid":"1501385","ip_address":"","utype":2,"ctime":1644976489,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"10234905792","product_id":100094401,"comment_content":"è¯„è®ºè¶Šæ¥è¶Šå°‘ï¼Œè¡¨ç¤ºçœ‹ä¸æ‡‚","like_count":2,"discussions":[{"author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"å¬æ°´çš„æ¹–","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551285,"discussion_content":"çœ‹ä¸æ‡‚çš„åœ°æ–¹å¯ä»¥å‘è€å¸ˆæé—®ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644976489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1016155,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/81/5b/768e64c8.jpg","nickname":"kobepeng","note":"","ucode":"59F986491764DD","race_medal":4,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581293,"discussion_content":"æˆ‘è§‰å¾—æºç ç³»åˆ—åº”è¯¥ä¸èƒ½è¯´çœ‹ä¸æ‡‚ï¼Œæ›´å¤šçš„æ˜¯ï¼Œçœ‹äº†å¤§åœ£çš„æ–‡ç« ï¼ŒçŸ¥é“ Vue æ˜¯æ€ä¹ˆåšçš„äº†ï¼Œä½†æ˜¯å´ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œå¯¹è‡ªèº«å·¥ä½œæœ‰ä»€ä¹ˆæŒ‡å¯¼æ„ä¹‰æœ‰å“ªäº› ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658714416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1326108,"avatar":"https://static001.geekbang.org/account/avatar/00/14/3c/1c/47e5b7aa.jpg","nickname":"Johnson","note":"","ucode":"C6B6FF9EA4CC60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580059,"discussion_content":"æ€ä¹ˆåŠ è¯¾ç¨‹å¾®ä¿¡ç¾¤å‘¢ï¼Œæœ‰é—®é¢˜æ–¹ä¾¿äº¤æµå‘€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657854285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352277,"user_name":"è‚¥æŸ´","can_delete":false,"product_type":"c1","uid":2818299,"ip_address":"","ucode":"5A454CA474C971","user_header":"https://static001.geekbang.org/account/avatar/00/2b/00/fb/85b07045.jpg","comment_is_top":false,"comment_ctime":1658494508,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1658494508","product_id":100094401,"comment_content":"å¤§åœ£è€å¸ˆç»˜åˆ¶çš„ Vue å…¨æµç¨‹çš„æ¶æ„å›¾ è¶…çº§èµ!!!!","like_count":0},{"had_liked":false,"id":348364,"user_name":"Uen","can_delete":false,"product_type":"c1","uid":1994869,"ip_address":"","ucode":"9F436AD665C8F3","user_header":"https://static001.geekbang.org/account/avatar/00/1e/70/75/421516b6.jpg","comment_is_top":false,"comment_ctime":1655021230,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655021230","product_id":100094401,"comment_content":"å…¨æ™¯å›¾çš„ä¸€æ­¥ä¸€æ­¥æ›´æ–°å¾ˆèµï¼","like_count":0},{"had_liked":false,"id":340698,"user_name":"Hermanyin","can_delete":false,"product_type":"c1","uid":1021149,"ip_address":"","ucode":"AA1A78F398C528","user_header":"","comment_is_top":false,"comment_ctime":1649056975,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649056975","product_id":100094401,"comment_content":"æ–‡ç« è¯´  isVoidTag åˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ˜¯è‡ªé—­åˆæ ‡ç­¾ï¼ŒisVoidTagæ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯åˆæ³•æ ‡ç­¾æŠŠ","like_count":0},{"had_liked":false,"id":333547,"user_name":"å…³å…³å›","can_delete":false,"product_type":"c1","uid":1562774,"ip_address":"","ucode":"98EAD61438860A","user_header":"https://static001.geekbang.org/account/avatar/00/17/d8/96/dcf52430.jpg","comment_is_top":false,"comment_ctime":1644401558,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644401558","product_id":100094401,"comment_content":"advance() advancePositionWithMutation() è¿™ä¸¤ä¸ªå‡½æ•°æ²¡æ€ä¹ˆç†è§£æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿå¤§åœ£è€å¸ˆæœ‰demoè®²è§£å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":329558,"user_name":"æ–œæœˆæµ®äº‘","can_delete":false,"product_type":"c1","uid":1008933,"ip_address":"","ucode":"25CECBB175DA02","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/25/c6de04bc.jpg","comment_is_top":false,"comment_ctime":1641424860,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1641424860","product_id":100094401,"comment_content":"å…¨æµç¨‹æ±‡æ€»å›¾å¥½è¯„å“¦ğŸ‘","like_count":1}]}