{"id":93745,"title":"30 | çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼šæ²¡æœ‰å…±äº«ï¼Œå°±æ²¡æœ‰ä¼¤å®³","content":"<p>æ°‘å›½å¹´é—´æŸå±±ä¸œçœä¸»å¸­å‚åŠ æŸå¤§å­¦æ ¡åº†æ¼”è®²ï¼Œåœ¨ç¯®çƒåœºçœ‹åˆ°åæ¥ä¸ªäººç©¿ç€è£¤è¡©æŠ¢ä¸€ä¸ªçƒï¼Œè§‚ä¹‹å®åœ¨ä¸é›…ï¼Œäºæ˜¯æ€’æ–¥å­¦æ ¡çš„æ€»åŠ¡å¤„é•¿è´ªæ±¡ï¼Œå¹¶ä¸”å‘è¯ï¼šâ€œå¤šä¹°å‡ ä¸ªçƒï¼Œä¸€äººå‘ä¸€ä¸ªï¼Œçœå¾—ä½ äº‰æˆ‘æŠ¢ï¼â€å°æ—¶å€™å¬åˆ°è¿™ä¸ªæ®µå­åªæ˜¯è§‰å¾—å¥½ç©ï¼Œä»Šå¤©å†æ¥çœ‹ï¼Œå´åˆ«æœ‰ä¸€ç•ªæ»‹å‘³ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå…¶é—´è•´è—ç€è§£å†³å¹¶å‘é—®é¢˜çš„ä¸€ä¸ªé‡è¦æ–¹æ³•ï¼š<strong>é¿å…å…±äº«</strong>ã€‚</p><p>æˆ‘ä»¬æ›¾ç»ä¸€éä¸€éåˆä¸€éåœ°é‡å¤ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™åŒä¸€å…±äº«å˜é‡å­˜åœ¨å¹¶å‘é—®é¢˜ã€‚å‰é¢ä¸¤ç¯‡æ–‡ç« æˆ‘ä»¬çªç ´çš„æ˜¯å†™ï¼Œæ²¡æœ‰å†™æ“ä½œè‡ªç„¶æ²¡æœ‰å¹¶å‘é—®é¢˜äº†ã€‚å…¶å®è¿˜å¯ä»¥çªç ´å…±äº«å˜é‡ï¼Œæ²¡æœ‰å…±äº«å˜é‡ä¹Ÿä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ï¼Œæ­£æ‰€è°“æ˜¯<strong>æ²¡æœ‰å…±äº«ï¼Œå°±æ²¡æœ‰ä¼¤å®³</strong>ã€‚</p><p>é‚£å¦‚ä½•é¿å…å…±äº«å‘¢ï¼Ÿæ€è·¯å…¶å®å¾ˆç®€å•ï¼Œå¤šä¸ªäººäº‰ä¸€ä¸ªçƒæ€»å®¹æ˜“å‡ºçŸ›ç›¾ï¼Œé‚£å°±æ¯ä¸ªäººå‘ä¸€ä¸ªçƒã€‚å¯¹åº”åˆ°å¹¶å‘ç¼–ç¨‹é¢†åŸŸï¼Œå°±æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„å˜é‡ï¼Œå½¼æ­¤ä¹‹é—´ä¸å…±äº«ï¼Œä¹Ÿå°±æ²¡æœ‰å¹¶å‘é—®é¢˜äº†ã€‚</p><p>æˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/86695\">ã€Š11 | Javaçº¿ç¨‹ï¼ˆä¸‹ï¼‰ï¼šä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿã€‹</a>ä¸­æåˆ°è¿‡<strong>çº¿ç¨‹å°é—­</strong>ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯é¿å…å…±äº«ã€‚ä½ å·²ç»çŸ¥é“é€šè¿‡å±€éƒ¨å˜é‡å¯ä»¥åšåˆ°é¿å…å…±äº«ï¼Œé‚£è¿˜æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥åšåˆ°å‘¢ï¼Ÿæœ‰çš„ï¼Œ<strong>Javaè¯­è¨€æä¾›çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThreadLocalï¼‰å°±èƒ½å¤Ÿåšåˆ°</strong>ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆçœ‹çœ‹ThreadLocalåˆ°åº•è¯¥å¦‚ä½•ä½¿ç”¨ã€‚</p><h2>ThreadLocalçš„ä½¿ç”¨æ–¹æ³•</h2><!-- [[[read_end]]] --><p>ä¸‹é¢è¿™ä¸ªé™æ€ç±»ThreadIdä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„çº¿ç¨‹Idï¼Œå¦‚æœ<strong>ä¸€ä¸ªçº¿ç¨‹</strong>å‰åä¸¤æ¬¡è°ƒç”¨ThreadIdçš„get()æ–¹æ³•ï¼Œä¸¤æ¬¡get()æ–¹æ³•çš„è¿”å›å€¼æ˜¯ç›¸åŒçš„ã€‚ä½†å¦‚æœæ˜¯<strong>ä¸¤ä¸ªçº¿ç¨‹</strong>åˆ†åˆ«è°ƒç”¨ThreadIdçš„get()æ–¹æ³•ï¼Œé‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹çœ‹åˆ°çš„get()æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸åŒçš„ã€‚è‹¥ä½ æ˜¯åˆæ¬¡æ¥è§¦ThreadLocalï¼Œå¯èƒ½ä¼šè§‰å¾—å¥‡æ€ªï¼Œä¸ºä»€ä¹ˆç›¸åŒçº¿ç¨‹è°ƒç”¨get()æ–¹æ³•ç»“æœå°±ç›¸åŒï¼Œè€Œä¸åŒçº¿ç¨‹è°ƒç”¨get()æ–¹æ³•ç»“æœå°±ä¸åŒå‘¢ï¼Ÿ</p><pre><code>static class ThreadId {\n  static final AtomicLong \n  nextId=new AtomicLong(0);\n  //å®šä¹‰ThreadLocalå˜é‡\n  static final ThreadLocal&lt;Long&gt; \n  tl=ThreadLocal.withInitial(\n    ()-&gt;nextId.getAndIncrement());\n  //æ­¤æ–¹æ³•ä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„Id\n  static long get(){\n    return tl.get();\n  }\n}\n</code></pre><p>èƒ½æœ‰è¿™ä¸ªå¥‡æ€ªçš„ç»“æœï¼Œéƒ½æ˜¯ThreadLocalçš„æ°ä½œï¼Œä¸è¿‡åœ¨è¯¦ç»†è§£é‡ŠThreadLocalçš„å·¥ä½œåŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸ªå®é™…å·¥ä½œä¸­å¯èƒ½é‡åˆ°çš„ä¾‹å­æ¥åŠ æ·±ä¸€ä¸‹å¯¹ThreadLocalçš„ç†è§£ã€‚ä½ å¯èƒ½çŸ¥é“SimpleDateFormatä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‚£å¦‚æœéœ€è¦åœ¨å¹¶å‘åœºæ™¯ä¸‹ä½¿ç”¨å®ƒï¼Œä½ è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>å…¶å®æœ‰ä¸€ä¸ªåŠæ³•å°±æ˜¯ç”¨ThreadLocalæ¥è§£å†³ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç å°±æ˜¯ThreadLocalè§£å†³æ–¹æ¡ˆçš„å…·ä½“å®ç°ï¼Œè¿™æ®µä»£ç ä¸å‰é¢ThreadIdçš„ä»£ç é«˜åº¦ç›¸ä¼¼ï¼ŒåŒæ ·åœ°ï¼Œä¸åŒçº¿ç¨‹è°ƒç”¨SafeDateFormatçš„get()æ–¹æ³•å°†è¿”å›ä¸åŒçš„SimpleDateFormatå¯¹è±¡å®ä¾‹ï¼Œç”±äºä¸åŒçº¿ç¨‹å¹¶ä¸å…±äº«SimpleDateFormatï¼Œæ‰€ä»¥å°±åƒå±€éƒ¨å˜é‡ä¸€æ ·ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><pre><code>static class SafeDateFormat {\n  //å®šä¹‰ThreadLocalå˜é‡\n  static final ThreadLocal&lt;DateFormat&gt;\n  tl=ThreadLocal.withInitial(\n    ()-&gt; new SimpleDateFormat(\n      &quot;yyyy-MM-dd HH:mm:ss&quot;));\n      \n  static DateFormat get(){\n    return tl.get();\n  }\n}\n//ä¸åŒçº¿ç¨‹æ‰§è¡Œä¸‹é¢ä»£ç \n//è¿”å›çš„dfæ˜¯ä¸åŒçš„\nDateFormat df =\n  SafeDateFormat.get()ï¼›\n</code></pre><p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªä¾‹å­ï¼Œç›¸ä¿¡ä½ å¯¹ThreadLocalçš„ç”¨æ³•ä»¥åŠåº”ç”¨åœºæ™¯éƒ½äº†è§£äº†ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥è¯¦ç»†è§£é‡ŠThreadLocalçš„å·¥ä½œåŸç†ã€‚</p><h2>ThreadLocalçš„å·¥ä½œåŸç†</h2><p>åœ¨è§£é‡ŠThreadLocalçš„å·¥ä½œåŸç†ä¹‹å‰ï¼Œ ä½ å…ˆè‡ªå·±æƒ³æƒ³ï¼šå¦‚æœè®©ä½ æ¥å®ç°ThreadLocalçš„åŠŸèƒ½ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡å‘¢ï¼ŸThreadLocalçš„ç›®æ ‡æ˜¯è®©ä¸åŒçš„çº¿ç¨‹æœ‰ä¸åŒçš„å˜é‡Vï¼Œé‚£æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯åˆ›å»ºä¸€ä¸ªMapï¼Œå®ƒçš„Keyæ˜¯çº¿ç¨‹ï¼ŒValueæ˜¯æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰çš„å˜é‡Vï¼ŒThreadLocalå†…éƒ¨æŒæœ‰è¿™æ ·çš„ä¸€ä¸ªMapå°±å¯ä»¥äº†ã€‚ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºæ„å›¾å’Œç¤ºä¾‹ä»£ç æ¥ç†è§£ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6a/34/6a93910f748ebc5b984ae7ac67283034.png?wh=1142*484\" alt=\"\"></p><center><span class=\"reference\">ThreadLocalæŒæœ‰Mapçš„ç¤ºæ„å›¾</span></center><pre><code>class MyThreadLocal&lt;T&gt; {\n  Map&lt;Thread, T&gt; locals = \n    new ConcurrentHashMap&lt;&gt;();\n  //è·å–çº¿ç¨‹å˜é‡  \n  T get() {\n    return locals.get(\n      Thread.currentThread());\n  }\n  //è®¾ç½®çº¿ç¨‹å˜é‡\n  void set(T t) {\n    locals.put(\n      Thread.currentThread(), t);\n  }\n}\n</code></pre><p>é‚£Javaçš„ThreadLocalæ˜¯è¿™ä¹ˆå®ç°çš„å—ï¼Ÿè¿™ä¸€æ¬¡æˆ‘ä»¬çš„è®¾è®¡æ€è·¯å’ŒJavaçš„å®ç°å·®å¼‚å¾ˆå¤§ã€‚Javaçš„å®ç°é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ªMapï¼Œå«åšThreadLocalMapï¼Œä¸è¿‡æŒæœ‰ThreadLocalMapçš„ä¸æ˜¯ThreadLocalï¼Œè€Œæ˜¯Threadã€‚Threadè¿™ä¸ªç±»å†…éƒ¨æœ‰ä¸€ä¸ªç§æœ‰å±æ€§threadLocalsï¼Œå…¶ç±»å‹å°±æ˜¯ThreadLocalMapï¼ŒThreadLocalMapçš„Keyæ˜¯ThreadLocalã€‚ä½ å¯ä»¥ç»“åˆä¸‹é¢çš„ç¤ºæ„å›¾å’Œç²¾ç®€ä¹‹åçš„Javaå®ç°ä»£ç æ¥ç†è§£ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/02/3cb0a8f15104848dec63eab269bac302.png?wh=1142*480\" alt=\"\"></p><center><span class=\"reference\">ThreadæŒæœ‰ThreadLocalMapçš„ç¤ºæ„å›¾</span></center><pre><code>class Thread {\n  //å†…éƒ¨æŒæœ‰ThreadLocalMap\n  ThreadLocal.ThreadLocalMap \n    threadLocals;\n}\nclass ThreadLocal&lt;T&gt;{\n  public T get() {\n    //é¦–å…ˆè·å–çº¿ç¨‹æŒæœ‰çš„\n    //ThreadLocalMap\n    ThreadLocalMap map =\n      Thread.currentThread()\n        .threadLocals;\n    //åœ¨ThreadLocalMapä¸­\n    //æŸ¥æ‰¾å˜é‡\n    Entry e = \n      map.getEntry(this);\n    return e.value;  \n  }\n  static class ThreadLocalMap{\n    //å†…éƒ¨æ˜¯æ•°ç»„è€Œä¸æ˜¯Map\n    Entry[] table;\n    //æ ¹æ®ThreadLocalæŸ¥æ‰¾Entry\n    Entry getEntry(ThreadLocal key){\n      //çœç•¥æŸ¥æ‰¾é€»è¾‘\n    }\n    //Entryå®šä¹‰\n    static class Entry extends\n    WeakReference&lt;ThreadLocal&gt;{\n      Object value;\n    }\n  }\n}\n</code></pre><p>åˆçœ‹ä¸Šå»ï¼Œæˆ‘ä»¬çš„è®¾è®¡æ–¹æ¡ˆå’ŒJavaçš„å®ç°ä»…ä»…æ˜¯Mapçš„æŒæœ‰æ–¹ä¸åŒè€Œå·²ï¼Œæˆ‘ä»¬çš„è®¾è®¡é‡Œé¢Mapå±äºThreadLocalï¼Œè€ŒJavaçš„å®ç°é‡Œé¢ThreadLocalMapåˆ™æ˜¯å±äºThreadã€‚è¿™ä¸¤ç§æ–¹å¼å“ªç§æ›´åˆç†å‘¢ï¼Ÿå¾ˆæ˜¾ç„¶Javaçš„å®ç°æ›´åˆç†ä¸€äº›ã€‚åœ¨Javaçš„å®ç°æ–¹æ¡ˆé‡Œé¢ï¼ŒThreadLocalä»…ä»…æ˜¯ä¸€ä¸ªä»£ç†å·¥å…·ç±»ï¼Œå†…éƒ¨å¹¶ä¸æŒæœ‰ä»»ä½•ä¸çº¿ç¨‹ç›¸å…³çš„æ•°æ®ï¼Œæ‰€æœ‰å’Œçº¿ç¨‹ç›¸å…³çš„æ•°æ®éƒ½å­˜å‚¨åœ¨Threadé‡Œé¢ï¼Œè¿™æ ·çš„è®¾è®¡å®¹æ˜“ç†è§£ã€‚è€Œä»æ•°æ®çš„äº²ç¼˜æ€§ä¸Šæ¥è®²ï¼ŒThreadLocalMapå±äºThreadä¹Ÿæ›´åŠ åˆç†ã€‚</p><p>å½“ç„¶è¿˜æœ‰ä¸€ä¸ªæ›´åŠ æ·±å±‚æ¬¡çš„åŸå› ï¼Œé‚£å°±æ˜¯<strong>ä¸å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„éœ²</strong>ã€‚åœ¨æˆ‘ä»¬çš„è®¾è®¡æ–¹æ¡ˆä¸­ï¼ŒThreadLocalæŒæœ‰çš„Mapä¼šæŒæœ‰Threadå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™å°±æ„å‘³ç€ï¼Œåªè¦ThreadLocalå¯¹è±¡å­˜åœ¨ï¼Œé‚£ä¹ˆMapä¸­çš„Threadå¯¹è±¡å°±æ°¸è¿œä¸ä¼šè¢«å›æ”¶ã€‚ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸå¾€å¾€éƒ½æ¯”çº¿ç¨‹è¦é•¿ï¼Œæ‰€ä»¥è¿™ç§è®¾è®¡æ–¹æ¡ˆå¾ˆå®¹æ˜“å¯¼è‡´å†…å­˜æ³„éœ²ã€‚è€ŒJavaçš„å®ç°ä¸­ThreadæŒæœ‰ThreadLocalMapï¼Œè€Œä¸”ThreadLocalMapé‡Œå¯¹ThreadLocalçš„å¼•ç”¨è¿˜æ˜¯å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼Œæ‰€ä»¥åªè¦Threadå¯¹è±¡å¯ä»¥è¢«å›æ”¶ï¼Œé‚£ä¹ˆThreadLocalMapå°±èƒ½è¢«å›æ”¶ã€‚Javaçš„è¿™ç§å®ç°æ–¹æ¡ˆè™½ç„¶çœ‹ä¸Šå»å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯æ›´åŠ å®‰å…¨ã€‚</p><p>Javaçš„ThreadLocalå®ç°åº”è¯¥ç§°å¾—ä¸Šæ·±æ€ç†Ÿè™‘äº†ï¼Œä¸è¿‡å³ä¾¿å¦‚æ­¤æ·±æ€ç†Ÿè™‘ï¼Œè¿˜æ˜¯ä¸èƒ½ç™¾åˆ†ç™¾åœ°è®©ç¨‹åºå‘˜é¿å…å†…å­˜æ³„éœ²ï¼Œä¾‹å¦‚åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨ThreadLocalï¼Œå¦‚æœä¸è°¨æ…å°±å¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ã€‚</p><h2>ThreadLocalä¸å†…å­˜æ³„éœ²</h2><p>åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨ThreadLocalä¸ºä»€ä¹ˆå¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²å‘¢ï¼ŸåŸå› å°±å‡ºåœ¨çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„å­˜æ´»æ—¶é—´å¤ªé•¿ï¼Œå¾€å¾€éƒ½æ˜¯å’Œç¨‹åºåŒç”Ÿå…±æ­»çš„ï¼Œè¿™å°±æ„å‘³ç€ThreadæŒæœ‰çš„ThreadLocalMapä¸€ç›´éƒ½ä¸ä¼šè¢«å›æ”¶ï¼Œå†åŠ ä¸ŠThreadLocalMapä¸­çš„Entryå¯¹ThreadLocalæ˜¯å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰ï¼Œæ‰€ä»¥åªè¦ThreadLocalç»“æŸäº†è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¯ä»¥è¢«å›æ”¶æ‰çš„ã€‚ä½†æ˜¯Entryä¸­çš„Valueå´æ˜¯è¢«Entryå¼ºå¼•ç”¨çš„ï¼Œæ‰€ä»¥å³ä¾¿Valueçš„ç”Ÿå‘½å‘¨æœŸç»“æŸäº†ï¼ŒValueä¹Ÿæ˜¯æ— æ³•è¢«å›æ”¶çš„ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚</p><p>é‚£åœ¨çº¿ç¨‹æ± ä¸­ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ­£ç¡®ä½¿ç”¨ThreadLocalå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œæ—¢ç„¶JVMä¸èƒ½åšåˆ°è‡ªåŠ¨é‡Šæ”¾å¯¹Valueçš„å¼ºå¼•ç”¨ï¼Œé‚£æˆ‘ä»¬æ‰‹åŠ¨é‡Šæ”¾å°±å¯ä»¥äº†ã€‚å¦‚ä½•èƒ½åšåˆ°æ‰‹åŠ¨é‡Šæ”¾å‘¢ï¼Ÿä¼°è®¡ä½ é©¬ä¸Šæƒ³åˆ°<strong>try{}finally{}æ–¹æ¡ˆ</strong>äº†ï¼Œè¿™ä¸ªç®€ç›´å°±æ˜¯<strong>æ‰‹åŠ¨é‡Šæ”¾èµ„æºçš„åˆ©å™¨</strong>ã€‚ç¤ºä¾‹çš„ä»£ç å¦‚ä¸‹ï¼Œä½ å¯ä»¥å‚è€ƒå­¦ä¹ ã€‚</p><pre><code>ExecutorService es;\nThreadLocal tl;\nes.execute(()-&gt;{\n  //ThreadLocalå¢åŠ å˜é‡\n  tl.set(obj);\n  try {\n    // çœç•¥ä¸šåŠ¡é€»è¾‘ä»£ç \n  }finally {\n    //æ‰‹åŠ¨æ¸…ç†ThreadLocal \n    tl.remove();\n  }\n});\n</code></pre><h2>InheritableThreadLocalä¸ç»§æ‰¿æ€§</h2><p>é€šè¿‡ThreadLocalåˆ›å»ºçš„çº¿ç¨‹å˜é‡ï¼Œå…¶å­çº¿ç¨‹æ˜¯æ— æ³•ç»§æ‰¿çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨çº¿ç¨‹ä¸­é€šè¿‡ThreadLocalåˆ›å»ºäº†çº¿ç¨‹å˜é‡Vï¼Œè€Œåè¯¥çº¿ç¨‹åˆ›å»ºäº†å­çº¿ç¨‹ï¼Œä½ åœ¨å­çº¿ç¨‹ä¸­æ˜¯æ— æ³•é€šè¿‡ThreadLocalæ¥è®¿é—®çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡Vçš„ã€‚</p><p>å¦‚æœä½ éœ€è¦å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒJavaæä¾›äº†InheritableThreadLocalæ¥æ”¯æŒè¿™ç§ç‰¹æ€§ï¼ŒInheritableThreadLocalæ˜¯ThreadLocalå­ç±»ï¼Œæ‰€ä»¥ç”¨æ³•å’ŒThreadLocalç›¸åŒï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚</p><p>ä¸è¿‡ï¼Œæˆ‘å®Œå…¨ä¸å»ºè®®ä½ åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨InheritableThreadLocalï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºå®ƒå…·æœ‰ThreadLocalç›¸åŒçš„ç¼ºç‚¹â€”â€”å¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ï¼Œæ›´é‡è¦çš„åŸå› æ˜¯ï¼šçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„åˆ›å»ºæ˜¯åŠ¨æ€çš„ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ç»§æ‰¿å…³ç³»é”™ä¹±ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡é€»è¾‘ä¾èµ–InheritableThreadLocalï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘è®¡ç®—é”™è¯¯ï¼Œè€Œè¿™ä¸ªé”™è¯¯å¾€å¾€æ¯”å†…å­˜æ³„éœ²æ›´è¦å‘½ã€‚</p><h2>æ€»ç»“</h2><p>çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¨¡å¼æœ¬è´¨ä¸Šæ˜¯ä¸€ç§é¿å…å…±äº«çš„æ–¹æ¡ˆï¼Œç”±äºæ²¡æœ‰å…±äº«ï¼Œæ‰€ä»¥è‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å¹¶å‘é—®é¢˜ã€‚å¦‚æœä½ éœ€è¦åœ¨å¹¶å‘åœºæ™¯ä¸­ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„å·¥å…·ç±»ï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯é¿å…å…±äº«ã€‚é¿å…å…±äº«æœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§æ–¹æ¡ˆæ˜¯å°†è¿™ä¸ªå·¥å…·ç±»ä½œä¸ºå±€éƒ¨å˜é‡ä½¿ç”¨ï¼Œå¦å¤–ä¸€ç§æ–¹æ¡ˆå°±æ˜¯çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¨¡å¼ã€‚è¿™ä¸¤ç§æ–¹æ¡ˆï¼Œå±€éƒ¨å˜é‡æ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œè€Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨æ–¹æ¡ˆï¼Œæ¯ä¸ªçº¿ç¨‹åªéœ€è¦åˆ›å»ºä¸€ä¸ªå·¥å…·ç±»çš„å®ä¾‹ï¼Œæ‰€ä»¥ä¸å­˜åœ¨é¢‘ç¹åˆ›å»ºå¯¹è±¡çš„é—®é¢˜ã€‚</p><p>çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¨¡å¼æ˜¯è§£å†³å¹¶å‘é—®é¢˜çš„å¸¸ç”¨æ–¹æ¡ˆï¼Œæ‰€ä»¥Java SDKä¹Ÿæä¾›äº†ç›¸åº”çš„å®ç°ï¼šThreadLocalã€‚é€šè¿‡ä¸Šé¢æˆ‘ä»¬çš„åˆ†æï¼Œä½ åº”è¯¥èƒ½ä½“ä¼šåˆ°Java SDKçš„å®ç°å·²ç»æ˜¯æ·±æ€ç†Ÿè™‘äº†ï¼Œä¸è¿‡å³ä¾¿å¦‚æ­¤ï¼Œä»ä¸èƒ½å°½å–„å°½ç¾ï¼Œä¾‹å¦‚åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨ThreadLocalä»å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥ä½¿ç”¨ThreadLocalè¿˜æ˜¯éœ€è¦ä½ æ‰“èµ·ç²¾ç¥ï¼Œè¶³å¤Ÿè°¨æ…ã€‚</p><h2>è¯¾åæ€è€ƒ</h2><p>å®é™…å·¥ä½œä¸­ï¼Œæœ‰å¾ˆå¤šå¹³å°å‹çš„æŠ€æœ¯æ–¹æ¡ˆéƒ½æ˜¯é‡‡ç”¨ThreadLocalæ¥ä¼ é€’ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚Springä½¿ç”¨ThreadLocalæ¥ä¼ é€’äº‹åŠ¡ä¿¡æ¯ã€‚æˆ‘ä»¬æ›¾ç»è¯´è¿‡ï¼Œå¼‚æ­¥ç¼–ç¨‹å·²ç»å¾ˆæˆç†Ÿäº†ï¼Œé‚£ä½ è§‰å¾—åœ¨å¼‚æ­¥åœºæ™¯ä¸­ï¼Œæ˜¯å¦å¯ä»¥ä½¿ç”¨Springçš„äº‹åŠ¡ç®¡ç†å™¨å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p></p>","comments":[{"had_liked":false,"id":92211,"user_name":"å³è€³å¬æµ·","can_delete":false,"product_type":"c1","uid":1022011,"ip_address":"","ucode":"E0B9F1083F4F98","user_header":"https://static001.geekbang.org/account/avatar/00/0f/98/3b/5af90c80.jpg","comment_is_top":false,"comment_ctime":1557201651,"is_pvip":false,"replies":[{"id":"34454","content":"threadlocal=çº¿ç¨‹æ•°ï¼Œå±€éƒ¨å˜é‡=è°ƒç”¨é‡ï¼Œå·®è·å¤ªå¤§äº†","user_name":"ä½œè€…å›å¤","comment_id":92211,"uid":"1269969","ip_address":"","utype":1,"ctime":1558362215,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":11,"race_medal":0,"score":"525543211763","product_id":100023901,"comment_content":"æœ‰ä¸ªç–‘é—®è¯·æ•™è€å¸ˆï¼Œé¿å…å…±äº«å˜é‡çš„ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œä½¿ç”¨å±€éƒ¨å˜é‡ä¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œä½¿ç”¨threadlocalä¹Ÿæ˜¯é’ˆå¯¹çº¿ç¨‹åˆ›å»ºæ–°å˜é‡ï¼Œéƒ½æ˜¯é’ˆå¯¹çº¿ç¨‹ç»´åº¦ï¼Œthreadlocalå¹¶æœªä½“ç°å‡ºä»€ä¹ˆä¼˜åŠ¿ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨threadlocal","like_count":123,"discussions":[{"author":{"id":1062797,"avatar":"","nickname":"Cv","note":"","ucode":"C77CE172B5AA28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":115829,"discussion_content":"ä½†æ˜¯æ·»åŠ äº†removeåä¸æ˜¯ä¸€æ ·çš„å—?","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1578038540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1181650,"avatar":"https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg","nickname":"æƒ˜ é—»","note":"","ucode":"C5909F034BF072","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298346,"discussion_content":"å±€éƒ¨å˜é‡æ˜¯é’ˆå¯¹çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•ï¼Œthreadæ˜¯é’ˆå¯¹çº¿ç¨‹ã€‚æˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„ï¼Œå¦‚æœæ˜¯çº¿ç¨‹æ± å†…çº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šè°ƒç”¨å¤šæ¬¡è¿™ä¸ªæ–¹æ³•ã€‚","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1597276084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1768152,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/fa/d8/7c2b6c0b.jpg","nickname":"é—²äºº","note":"","ucode":"9A8F33260A44E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":97890,"discussion_content":"çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œæ‰€ä»¥çº¿ç¨‹å˜é‡ä¹Ÿè¢«å¤ç”¨äº†ï¼Ÿå‰ææ˜¯çº¿ç¨‹å˜é‡æ²¡æœ‰è¢«removeå§","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1577115938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449178,"discussion_content":"threadlocal=çº¿ç¨‹æ•°ï¼Œå±€éƒ¨å˜é‡=è°ƒç”¨é‡ï¼Œå·®è·å¤ªå¤§äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1558362215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391374,"discussion_content":"è¿™ä¸ªbå°±æ˜¯è‡ªå·±çœ‹äº†å‡ æœ¬ä¸­æ–‡ç¿»è¯‘çš„ä¹¦ç„¶åå‡ºæ¥éª—äººäº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1630421575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1621553,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/proaRF0lED9TdZcS5saibFrOSfL9nfMQkbKfoAqtbONWyBplZjPMaSL3icGOxc60SPHFAhtC0yibDQ1CBYpJZXgRg/132","nickname":"Geek_be63c6","note":"","ucode":"93447D86C450D6","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589128,"discussion_content":"æˆ‘çœŸçš„yueäº†ï¼Œä½ è¿™ç§ä¸œè¥¿ï¼Œäººå®¶æœ‰ä¹‰åŠ¡å›ç­”é—®é¢˜ä¹ˆï¼Œè€Œä¸”è€å¸ˆæ˜æ˜è¯´çš„æ˜¯æ­£ç¡®çš„ï¼Œä½ å»çœ‹çœ‹åˆ«çš„è¯¾ç¨‹ï¼Œä¸ç†é—®é¢˜çš„äººå¤šäº†å»äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664437273,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":391374,"ip_address":"å¹¿ä¸œ"},"score":589128,"extra":""}]},{"author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391373,"discussion_content":"å›ç­”çš„é—®é¢˜é©´å”‡ä¸å¯¹é©¬å˜´","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1630421539,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1661365,"avatar":"https://static001.geekbang.org/account/avatar/00/19/59/b5/26d3c637.jpg","nickname":"Yc","note":"","ucode":"407776D104D6F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544027,"discussion_content":"å“ªé‡Œä¸å¯¹äº†ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641381972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":391373,"ip_address":""},"score":544027,"extra":""}]},{"author":{"id":2076251,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/ae/5b/4bd42286.jpg","nickname":"å®‹è®¡æ´‹","note":"","ucode":"9A34E8F71C6CBD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588221,"discussion_content":"ThreadLocalåœ¨çº¿ç¨‹ä¸­ç›¸å½“äºå…¨å±€å˜é‡ï¼Œæ¯”å¦‚ä¸€ä¸ªè¯·æ±‚æ‰“è¿›æ¥åˆ°ç»“æŸéƒ½æ˜¯tomcatçš„ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œçš„ï¼Œåªéœ€è¦newä¸€æ¬¡, removeä¸€æ¬¡ï¼Œä½†æ˜¯æ–¹æ³•æ˜¯è°ƒç”¨ä¸€æ¬¡newä¸€æ¬¡ã€‚ThreadLocalæ¯”è¾ƒé€‚åˆå­˜contextç±»çš„å¯¹è±¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663596661,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1138722,"avatar":"https://static001.geekbang.org/account/avatar/00/11/60/22/92284df2.jpg","nickname":"å…¶å®æˆ‘å¾ˆå±Œ","note":"","ucode":"2B75EAAD748A60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393931,"discussion_content":"å¦‚æœä½ çš„å¯¹è±¡æ˜¯å•ä¾‹çš„ï¼Œä¸ç”¨threadlocalå°±æœ‰é—®é¢˜ï¼Œå¥½åƒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631666589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018620,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","nickname":"ipofss","note":"","ucode":"DE3061C9259F9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":40980,"discussion_content":"å¥½é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572318001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92239,"user_name":"æ™“æ°","can_delete":false,"product_type":"c1","uid":1441546,"ip_address":"","ucode":"1174C88EEBF8A6","user_header":"https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg","comment_is_top":false,"comment_ctime":1557209999,"is_pvip":false,"replies":[{"id":"34436","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":92239,"uid":"1269969","ip_address":"","utype":1,"ctime":1558358425,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"400989168527","product_id":100023901,"comment_content":"ä¸å¯ä»¥ï¼Œå› ä¸ºThreadLocalå†…çš„å˜é‡æ˜¯çº¿ç¨‹çº§åˆ«çš„ï¼Œè€Œå¼‚æ­¥ç¼–ç¨‹æ„å‘³ç€çº¿ç¨‹ä¸åŒï¼Œä¸åŒçº¿ç¨‹çš„å˜é‡ä¸å¯ä»¥å…±äº«","like_count":94,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449188,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558358425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":96779,"user_name":"æ‰¿é¦™å¢¨å½±","can_delete":false,"product_type":"c1","uid":1023750,"ip_address":"","ucode":"4D6A4D6E1ED29F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9f/06/287d77dd.jpg","comment_is_top":false,"comment_ctime":1558505474,"is_pvip":false,"replies":[{"id":"34653","content":"è¿™ç§ç”¨æ³•ä¸€èˆ¬æ˜¯ä¸ºäº†åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œä¼ é€’å…¨å±€å‚æ•°ï¼Œä¹Ÿå«ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå±€éƒ¨å˜é‡ä¸èƒ½è·¨æ–¹æ³•ï¼Œè¿™ä¸ªç”¨æ³•ä¸æ˜¯ç”¨æ¥è§£å†³å±€éƒ¨å˜é‡é‡å¤åˆ›å»ºçš„","user_name":"ä½œè€…å›å¤","comment_id":96779,"uid":"1269969","ip_address":"","utype":1,"ctime":1558535597,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"254961575938","product_id":100023901,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªé—®é¢˜æƒ³è¯·æ•™ã€‚<br>åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨ ThreadLocalï¼Œæ‚¨ç»™çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œä½¿ç”¨åæ‰‹åŠ¨é‡Šæ”¾ã€‚<br>é‚£è¿™æ ·å’Œä½¿ç”¨çº¿ç¨‹çš„å±€éƒ¨å˜é‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ¯æ¬¡çº¿ç¨‹æ‰§è¡Œçš„æ—¶å€™éƒ½å»åˆ›å»ºå¯¹è±¡å¹¶å­˜å‚¨åœ¨ ThreadLocal ä¸­ï¼Œç”¨å®Œå°±é‡Šæ”¾æ‰äº†ï¼Œä¸‹æ¬¡æ‰§è¡Œä¾ç„¶éœ€è¦é‡æ–°åˆ›å»ºï¼Œå¹¶å­˜å…¥ ThreadLocalMap ä¸­ï¼Œè¿™æ ·å¹¶æ²¡æœ‰è§£å†³å±€éƒ¨å˜é‡é¢‘ç¹åˆ›å»ºå¯¹è±¡çš„é—®é¢˜ã€‚","like_count":60,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451013,"discussion_content":"è¿™ç§ç”¨æ³•ä¸€èˆ¬æ˜¯ä¸ºäº†åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œä¼ é€’å…¨å±€å‚æ•°ï¼Œä¹Ÿå«ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå±€éƒ¨å˜é‡ä¸èƒ½è·¨æ–¹æ³•ï¼Œè¿™ä¸ªç”¨æ³•ä¸æ˜¯ç”¨æ¥è§£å†³å±€éƒ¨å˜é‡é‡å¤åˆ›å»ºçš„","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1558535597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92371,"user_name":"QQæ€ª","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1557240665,"is_pvip":false,"replies":[{"id":"33512","content":"æ„Ÿè°¢å›å¤ï¼ï¼ï¼ï¼","user_name":"ä½œè€…å›å¤","comment_id":92371,"uid":"1269969","ip_address":"","utype":1,"ctime":1557645868,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":2,"race_medal":0,"score":"203420703577","product_id":100023901,"comment_content":"ä¸Šé¢æœ‰äº›åŒå­¦è¯´å¤šçº¿ç¨‹æ˜¯simpledateformatä¼šæ‰“å°å‡ºä¸€æ ·åç§°çš„å¯¹è±¡ï¼Œæˆ‘åˆšåˆšä¹Ÿè¯•äº†ä¸‹ï¼Œçš„ç¡®å¯ä»¥å¤ç°ï¼Œä½†å…¶å®æ˜¯simpledateformatå¯¹è±¡çš„toString()æ–¹æ³•æå¾—é¬¼ï¼Œè¯¥ç±»æ˜¯ç»§æ‰¿objectç±»çš„tostringæ–¹æ³•ï¼Œå¦‚ä¸‹æœ‰ä¸ªhashcode()æ–¹æ³•ï¼Œä½†è¯¥ç±»é‡å†™äº†hashcodeæ–¹æ³•ï¼Œåœ¨è¿½æº¯åˆ°hashcodeæ–¹æ³•ï¼Œpattern.hashcode(),patternå°±æ˜¯æˆ‘ä»¬çš„yyyy-MM-dd,è¿™ä¸ªæ˜¯ä¸€ç›´ä¿æŒä¸å˜çš„ï¼Œç°åœ¨ç»ˆäºçœŸç›¸å¤§ç™½äº†","like_count":47,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449231,"discussion_content":"æ„Ÿè°¢å›å¤ï¼ï¼ï¼ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557645868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1256301,"avatar":"https://static001.geekbang.org/account/avatar/00/13/2b/6d/7a6b5df4.jpg","nickname":"åè›‹","note":"","ucode":"9C99151F30DF0F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":408843,"discussion_content":"    /**\n     * The pattern string of this formatter.  This is always a non-localized\n     * pattern.  May not be null.  See class documentation for details.\n     * @serial\n     */\n    private String pattern;\n\n    public SimpleDateFormat(String pattern)\n    {\n        this(pattern, Locale.getDefault(Locale.Category.FORMAT));\n    }\n    \n     public SimpleDateFormat(String pattern, Locale locale)\n    {\n        if (pattern == null || locale == null) {\n            throw new NullPointerException();\n        }\n\n        initializeCalendar(locale);\n        this.pattern = pattern;\n        this.formatData = DateFormatSymbols.getInstanceRef(locale);\n        this.locale = locale;\n        initialize(locale);\n    }\n    \n    @Override\n    public int hashCode()\n    {\n        return pattern.hashCode();\n        // just enough fields for a reasonable distribution\n    }\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635332071,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92089,"user_name":"å³°","can_delete":false,"product_type":"c1","uid":1056019,"ip_address":"","ucode":"C53CB64E8E7D19","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg","comment_is_top":false,"comment_ctime":1557188014,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"74571632046","product_id":100023901,"comment_content":"javaå®ç°å¼‚æ­¥çš„æ–¹å¼åŸºæœ¬ä¸Šå°±æ˜¯å¤šçº¿ç¨‹äº†ï¼Œè€Œthreadlocalæ˜¯çº¿ç¨‹å°é—­çš„ï¼Œä¸èƒ½åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œå°±è°ˆä¸ä¸Šå…¨å±€çš„äº‹åŠ¡ç®¡ç†äº†ã€‚","like_count":17},{"had_liked":false,"id":97755,"user_name":"linqw","can_delete":false,"product_type":"c1","uid":1134138,"ip_address":"","ucode":"09DCFE98C54DD8","user_header":"https://static001.geekbang.org/account/avatar/00/11/4e/3a/86196508.jpg","comment_is_top":false,"comment_ctime":1558765695,"is_pvip":false,"replies":[{"id":"34940","content":"æœ‰å¿ƒğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":97755,"uid":"1269969","ip_address":"","utype":1,"ctime":1558779306,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":2,"race_medal":0,"score":"61688307839","product_id":100023901,"comment_content":"è‡ªå·±å†™äº†ä¸‹å¯¹ThreadLocalçš„æºç åˆ†æhttps:&#47;&#47;juejin.im&#47;post&#47;5ce7e0596fb9a07ee742ba79ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸‹å“¦ï¼Œè€å¸ˆä¹Ÿå¸®å¿™çœ‹ä¸‹å“¦ ","like_count":14,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451401,"discussion_content":"æœ‰å¿ƒğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558779306,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2282481,"avatar":"","nickname":"Geek_157395","note":"","ucode":"D00CBA7A104FE6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369190,"discussion_content":"å†™è¿™ä¸ªæºç åˆ†ææ„Ÿè§‰æœ‰æ”¶è·å—ï¼Ÿæ„Ÿè§‰è¿™å—å„¿åªéœ€è¦çŸ¥é“è®²çš„è¿™äº›çŸ¥è¯†å°±å¯ä»¥äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618970668,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":132642,"user_name":"So","can_delete":false,"product_type":"c1","uid":1485274,"ip_address":"","ucode":"60095793800451","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/fLsz4MWRfXUNutWJQLtCMYsEibczUJbGBWIcean2vJZYll5nGRkmHgV3BbXVicGt6qUmDEcZM0VlOdj8O06UhjvQ/132","comment_is_top":false,"comment_ctime":1568183881,"is_pvip":false,"replies":[{"id":"50903","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":132642,"uid":"1269969","ip_address":"","utype":1,"ctime":1568268342,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":3,"race_medal":0,"score":"44517856841","product_id":100023901,"comment_content":"ä¸€ä¸ªThreadLocalåªèƒ½ä¿å­˜ä¸€ä¸ªå˜é‡ï¼Œé‚£å¦‚æœæœ‰å¤šä¸ªå˜é‡è¦ä¿å­˜ï¼Œæ˜¯ä¸æ˜¯è¦å»ºå¤šä¸ªThreadLocalï¼Ÿ","like_count":11,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467050,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568268342,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1392431,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3f/2f/8513c4d3.jpg","nickname":"a(à¹‘â‰–à¸´Ù¼â‰–à¸´)âœŒ","note":"","ucode":"AEF9B5CA1605DF","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290191,"discussion_content":"å­˜ä¸ªmapï¼Œmapå­˜å¤šä¸ªå€¼ä¹Ÿå¯ä»¥å§","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1594371653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1810576,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/eLNeJNaEkwGSK7xvtamMibVLMy2MpbIqX3iaEhT7JtSnTRMRTwZ2j4HX7WAapiashbiaBDVriaXKSP0Oeic6ZAEVEXag/132","nickname":"M","note":"","ucode":"06F26E1D62E9C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372552,"discussion_content":"å­˜å¤šä¸ªk","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620375359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102821,"user_name":"GEEKBANG_6638780","can_delete":false,"product_type":"c1","uid":1268264,"ip_address":"","ucode":"952194E56FD8C8","user_header":"https://static001.geekbang.org/account/avatar/00/13/5a/28/732d3f2f.jpg","comment_is_top":false,"comment_ctime":1560308975,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31625080047","product_id":100023901,"comment_content":"@vic<br>æƒ³é—®ä¸€ä¸‹å¦‚æœgcå‘ç”Ÿåœ¨å¯¹threadLocalçš„ setå’Œgetæ“ä½œä¹‹é—´ï¼Œgetçš„æ—¶å€™valueå¯¹åº”çš„keyå·²ç»è¢«gcäº†ï¼Œä¸æ˜¯æ‹¿ä¸åˆ°æˆ‘ä¹‹å‰æ”¾è¿›threadLocalçš„å¯¹è±¡äº†å—ï¼Ÿè¿™æ ·å¯¹ä¸šåŠ¡ä¸ä¼šæœ‰é—®é¢˜å—ï¼Ÿ<br>---------------------------------<br>æ˜¯çš„ï¼Œä¸€èˆ¬å»ºè®®threadlocalé‡‡ç”¨staticä¿®é¥°ï¼Œè€Œä¸”éµå¾ªtry finallyç¼–ç¨‹","like_count":7},{"had_liked":false,"id":92183,"user_name":"æ™“æ°","can_delete":false,"product_type":"c1","uid":1441546,"ip_address":"","ucode":"1174C88EEBF8A6","user_header":"https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg","comment_is_top":false,"comment_ctime":1557197110,"is_pvip":false,"replies":[{"id":"34571","content":"æœ‰åŒå­¦å·²ç»æ‰¾åˆ°åŸå› äº†ï¼Œæ˜¯tostringçš„é”…","user_name":"ä½œè€…å›å¤","comment_id":92183,"uid":"1269969","ip_address":"","utype":1,"ctime":1558449085,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"31621968182","product_id":100023901,"comment_content":"è¯·é—®ä¸€ä¸‹è€å¸ˆï¼Œæˆ‘åˆšåˆšå¯¹simpledateformatåŠ threadlocalï¼Œä½†æ˜¯ä¸åŒçº¿ç¨‹å¾—åˆ°çš„simpledateformatå¯¹è±¡æ˜¯ä¸€æ ·çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š<br>public class Tool {<br>    public static void main(String[] args) throws Exception{<br>        System.out.println(SafeDateFormat.get());<br>        System.out.println(Thread.currentThread().getName());<br>        new Thread(new Runnable() {<br>            @Override<br>            public void run() {<br>                System.out.println(Thread.currentThread().getName());<br>                System.out.println(SafeDateFormat.get());<br>            }<br>        }).start();<br><br>    }<br><br>    static class SafeDateFormat{<br>        static final ThreadLocal&lt;SimpleDateFormat&gt; sdf =<br>                ThreadLocal.withInitial(()-&gt;new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;));<br>        static SimpleDateFormat get(){<br>            return sdf.get();<br>        }<br>    }<br>}<br>è¯·é—®å­˜åœ¨ä»€ä¹ˆé—®é¢˜","like_count":7,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449172,"discussion_content":"æœ‰åŒå­¦å·²ç»æ‰¾åˆ°åŸå› äº†ï¼Œæ˜¯tostringçš„é”…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558449085,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92417,"user_name":"å¤©å¤©å‘å–„","can_delete":false,"product_type":"c1","uid":1108250,"ip_address":"","ucode":"6AE57FB2B15043","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/1a/6ba207a3.jpg","comment_is_top":false,"comment_ctime":1557270844,"is_pvip":true,"replies":[{"id":"33678","content":"å¾ˆæœ‰è¿™ç§å¯èƒ½ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨å®ƒå­˜çŠ¶æ€æ•°æ®","user_name":"ä½œè€…å›å¤","comment_id":92417,"uid":"1269969","ip_address":"","utype":1,"ctime":1557758715,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":2,"race_medal":0,"score":"23032107324","product_id":100023901,"comment_content":"æœ‰ä¸ªç–‘é—®è¯·æ•™ï¼Œçº¿ç¨‹å¤šè·¯å¤ç”¨ï¼Œä½¿ç”¨thread localæœ‰ä»€ä¹ˆæ³¨æ„çš„ï¼Œä¼šä¸ä¼šä¸åŒè¯·æ±‚è·å–å†…å®¹ç›¸åŒï¼Œé€ æˆåç»­ä¸šåŠ¡é”™è¯¯","like_count":5,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449251,"discussion_content":"å¾ˆæœ‰è¿™ç§å¯èƒ½ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨å®ƒå­˜çŠ¶æ€æ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557758715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121557,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/15/8ad4e24a.jpg","nickname":"yaomon","note":"","ucode":"4742547EB92BCE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":159502,"discussion_content":"è¶Ÿè¿‡è¿™ä¸ªå‘ï¼Œç”¨å®Œæ‰‹åŠ¨æ¸…ç†ğŸ˜«","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580700437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93642,"user_name":"J.M.Liu","can_delete":false,"product_type":"c1","uid":1200037,"ip_address":"","ucode":"B2CB84B8E923A6","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/a5/71358d7b.jpg","comment_is_top":false,"comment_ctime":1557543076,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18737412260","product_id":100023901,"comment_content":"getEntry(): 0x61c88647ï¼Œè§£å†³hashç¢°æ’çš„ä¸€ä¸ªç¥å¥‡çš„æ•°","like_count":4},{"had_liked":false,"id":128032,"user_name":"xinglichea","can_delete":false,"product_type":"c1","uid":1176447,"ip_address":"","ucode":"986DA07BF3CA89","user_header":"https://static001.geekbang.org/account/avatar/00/11/f3/7f/2dd9409b.jpg","comment_is_top":false,"comment_ctime":1566823155,"is_pvip":false,"replies":[{"id":"52711","content":"å·¥ç¨‹ä¸Šå»ºè®®ä¸è¦åšå‡è®¾ï¼Œä¸‡ä¸€å‡ºäº†é—®é¢˜ä¸å¥½æŸ¥","user_name":"ä½œè€…å›å¤","comment_id":128032,"uid":"1269969","ip_address":"","utype":1,"ctime":1569668221,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"14451725043","product_id":100023901,"comment_content":"è€å¸ˆï¼Œ<br>æ–‡ä¸­æåˆ°è§£å†³å†…å­˜æ³„éœ²çš„æ–¹æ³•æ˜¯æ˜¾ç¤ºè°ƒç”¨remove()æ–¹æ³•ï¼Œä½†è²Œä¼¼ThreadLocalMapçš„è®¾è®¡ä¸­å·²ç»è€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼Œä¹ŸåŠ ä¸Šäº†ä¸€äº›é˜²æŠ¤æªæ–½ï¼šåœ¨ThreadLocalçš„get(),set(),remove()çš„æ—¶å€™éƒ½ä¼šæ¸…é™¤çº¿ç¨‹ThreadLocalMapé‡Œæ‰€æœ‰keyä¸ºnullçš„valueï¼Œå³ï¼šåœ¨ThreadLocalMapä¸­çš„setEntry()ã€getEntry()ï¼Œå¦‚æœé‡åˆ°key == nullçš„æƒ…å†µï¼Œä¼šå¯¹valueè®¾ç½®ä¸ºnullã€‚<br><br>é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥è¯´æ˜ï¼Œå¦‚æœçº¿ç¨‹åœ¨åç»­æ“ä½œä¸­ä¼šç»§ç»­è°ƒç”¨set()ã€get()çš„è¯ï¼Œå°±ä¸éœ€è¦æ˜¾ç¤ºè°ƒç”¨remove()äº†ã€‚","like_count":3,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464762,"discussion_content":"å·¥ç¨‹ä¸Šå»ºè®®ä¸è¦åšå‡è®¾ï¼Œä¸‡ä¸€å‡ºäº†é—®é¢˜ä¸å¥½æŸ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569668221,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118316,"user_name":"æ‹¯æ•‘åœ°çƒå¥½ç´¯","can_delete":false,"product_type":"c1","uid":1339022,"ip_address":"","ucode":"7643439601EF4C","user_header":"https://static001.geekbang.org/account/avatar/00/14/6e/8e/5d309a85.jpg","comment_is_top":false,"comment_ctime":1564319703,"is_pvip":false,"replies":[{"id":"43340","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":118316,"uid":"1269969","ip_address":"","utype":1,"ctime":1564358574,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"14449221591","product_id":100023901,"comment_content":"---å¯å‘---<br>è€å¸ˆå¯¹ThreadLocalçš„æ€è€ƒä¸Šï¼Œè®©æˆ‘å¯¹ç†è§£ä¸€ä¸ªç±»çš„è®¾è®¡é—®é¢˜ä¸Šæœ‰æ‰€å¯å‘ã€‚å¯¹ä¸€ä¸ªç±»çš„å®ä¾‹ã€æ–¹æ³•ç­‰çš„è®¾è®¡ï¼Œé™¤äº†åŠŸèƒ½ä¸Šçš„è€ƒè™‘å¤–ï¼Œä¹Ÿè¦è€ƒè™‘å®‰å…¨æ€§ã€æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ç«™åœ¨æŠ½è±¡çš„è§’åº¦æ€è€ƒå…¶é€»è¾‘ã€‚<br>","like_count":3,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460355,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564358574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101961,"user_name":"ç›å¤šå¿…å¤±","can_delete":false,"product_type":"c1","uid":1218415,"ip_address":"","ucode":"B9DBB12E0D1D74","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/6f/4cd459f2.jpg","comment_is_top":false,"comment_ctime":1560075367,"is_pvip":false,"replies":[{"id":"36776","content":"å¤§æ™ºè‹¥æ„šï¼Œè°è¯´çš„æ¸…å‘¢ï¼Œä¸€èµ·é„™è§†é‚£äº›ä¸åŠ å¯†çš„å§ğŸ˜„","user_name":"ä½œè€…å›å¤","comment_id":101961,"uid":"1269969","ip_address":"","utype":1,"ctime":1560127261,"user_name_real":"ç‹å®ä»¤"}],"discussion_count":1,"race_medal":0,"score":"14444977255","product_id":100023901,"comment_content":"æŸå±±ä¸œçœä¸»å¸­â€¦â€¦ å®ä»¤å°å“¥å“¥è¿™åŠ å¯†ç®—æ³•åšå¾—å¤ªå¥½äº†ï¼Œ^_^","like_count":4,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453189,"discussion_content":"å¤§æ™ºè‹¥æ„šï¼Œè°è¯´çš„æ¸…å‘¢ï¼Œä¸€èµ·é„™è§†é‚£äº›ä¸åŠ å¯†çš„å§ğŸ˜„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560127261,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95142,"user_name":"ddup","can_delete":false,"product_type":"c1","uid":1101760,"ip_address":"","ucode":"D8EC573DA46A10","user_header":"https://static001.geekbang.org/account/avatar/00/10/cf/c0/8e4c1135.jpg","comment_is_top":false,"comment_ctime":1557973768,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14442875656","product_id":100023901,"comment_content":"System.identityHashCode(dateFormat)); è¿™ä¸ªæ¥æ‰“å°å†…å­˜åœ°å€ã€‚","like_count":3},{"had_liked":false,"id":92107,"user_name":"lik","can_delete":false,"product_type":"c1","uid":1103027,"ip_address":"","ucode":"9565C94A9B773A","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/b3/96847546.jpg","comment_is_top":false,"comment_ctime":1557189249,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10147123841","product_id":100023901,"comment_content":"æƒ³é—®ä¸€ä¸‹å¦‚æœgcå‘ç”Ÿåœ¨å¯¹threadLocalçš„ setå’Œgetæ“ä½œä¹‹é—´ï¼Œgetçš„æ—¶å€™valueå¯¹åº”çš„keyå·²ç»è¢«gcäº†ï¼Œä¸æ˜¯æ‹¿ä¸åˆ°æˆ‘ä¹‹å‰æ”¾è¿›threadLocalçš„å¯¹è±¡äº†å—ï¼Ÿè¿™æ ·å¯¹ä¸šåŠ¡ä¸ä¼šæœ‰é—®é¢˜å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1277081,"avatar":"https://static001.geekbang.org/account/avatar/00/13/7c/99/4dac6ce6.jpg","nickname":"lakeslove","note":"","ucode":"65E14D29D3C981","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319250,"discussion_content":"ä½ åˆ›å»ºçš„threadLocalå¯¹è±¡å¦‚æœæ˜¯å±€éƒ¨å˜é‡ï¼Œsetåï¼Œæ–¹æ³•æ²¡æ‰§è¡Œå®Œï¼Œè¿™ä¸ªthreadLocalè¢«æ ˆå¼•ç”¨ï¼Œä¸ä¼šè¢«å›æ”¶ã€‚å¦‚æœä½ åˆ›å»ºçš„æ˜¯å¯¹è±¡çš„å±æ€§ï¼Œé‚£ä¹ˆå¯¹è±¡å›æ”¶å‰ï¼Œä¹Ÿä¸ä¼šå›æ”¶è¯¥threadLocalå¯¹è±¡ã€‚æ‰€ä»¥åªè¦ä½ è¿™ä¸ªå¯¹è±¡è¿˜åœ¨ç”¨ï¼ŒGCå°±ä¸ä¼šå›æ”¶å®ƒã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603973167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92074,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1557186206,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10147120798","product_id":100023901,"comment_content":"æ‰“å¡ï¼æˆ‘è®¤ä¸ºä¸è¡Œå§ï¼Œæ–‡æœ«æåˆ°ThreadLocalåˆ›å»ºçš„çº¿ç¨‹å˜é‡å­çº¿ç¨‹æ— æ³•ç»§æ‰¿äº†ã€‚","like_count":2},{"had_liked":false,"id":326810,"user_name":"å°”å†¬æ©™","can_delete":false,"product_type":"c1","uid":1225224,"ip_address":"","ucode":"0B013A49BC18DA","user_header":"https://static001.geekbang.org/account/avatar/00/12/b2/08/92f42622.jpg","comment_is_top":false,"comment_ctime":1639707031,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5934674327","product_id":100023901,"comment_content":"å¦‚æœéœ€è¦åœ¨çº¿ç¨‹æ± ä¸­å®ç°å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡ï¼Œè¯¥å¦‚ä½•å»åš","like_count":1},{"had_liked":false,"id":264591,"user_name":"æˆ‘çœŸä¸æ˜¯åœ°çƒ","can_delete":false,"product_type":"c1","uid":1451048,"ip_address":"","ucode":"873F7222DE35BE","user_header":"https://static001.geekbang.org/account/avatar/00/16/24/28/9b5b1396.jpg","comment_is_top":false,"comment_ctime":1606535337,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5901502633","product_id":100023901,"comment_content":"void set(T t) {<br>    locals.put(<br>      Thread.currentThread(), t);<br>  }<br><br>è€å¸ˆï¼Œkeyä¸ä¼šè¢«é¡¶æ‰ä¹ˆï¼Ÿ","like_count":1},{"had_liked":false,"id":245368,"user_name":"è“å±±","can_delete":false,"product_type":"c1","uid":1066264,"ip_address":"","ucode":"FBF673D51FF644","user_header":"https://static001.geekbang.org/account/avatar/00/10/45/18/3d05adb4.jpg","comment_is_top":false,"comment_ctime":1598926030,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5893893326","product_id":100023901,"comment_content":"ä¸èƒ½ã€‚å½“å‰çº¿ç¨‹å’Œè¢«è°ƒç”¨å¼‚æ­¥çº¿ç¨‹åˆ†å±ä¸åŒçº¿ç¨‹ã€‚ä½†ç¡®å¯åšåˆ°ã€‚","like_count":1},{"had_liked":false,"id":235805,"user_name":"ç»ˆç»“è€…999å·","can_delete":false,"product_type":"c1","uid":1055854,"ip_address":"","ucode":"33ADE61580B6DD","user_header":"https://static001.geekbang.org/account/avatar/00/10/1c/6e/6c5f5734.jpg","comment_is_top":false,"comment_ctime":1595207752,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5890175048","product_id":100023901,"comment_content":"å¯¹äºä¸­é—´æœ‰çº¿ç¨‹æ± çš„æ“ä½œï¼Œå¦‚æœéœ€è¦ä¸Šä¸‹æ–‡ä¼ é€’çš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨é˜¿é‡Œå¼€æºçš„TransmitableThreadLocal","like_count":1},{"had_liked":false,"id":95882,"user_name":"çœ‹ä¸åˆ°deé¢œè‰²","can_delete":false,"product_type":"c1","uid":1460415,"ip_address":"","ucode":"04B803AED7C22F","user_header":"https://static001.geekbang.org/account/avatar/00/16/48/bf/3d76ea74.jpg","comment_is_top":false,"comment_ctime":1558240745,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5853208041","product_id":100023901,"comment_content":"å¼‚æ­¥ç¼–ç¨‹åº”è¯¥æ…ç”¨ThreadLocalã€‚å› ä¸ºä¸å†æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥è·å–ä¸åˆ°åŸæœ¬æƒ³è·å–çš„æ•°æ®","like_count":1},{"had_liked":false,"id":92399,"user_name":"ç‹‚é£éª¤é›¨","can_delete":false,"product_type":"c1","uid":1305749,"ip_address":"","ucode":"5CE9B9438FAB3F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKZSibeTatZ2ImL5Xu3QqdTWQs5nyQAxDlsm3m0KicP3TN6icJqYricvhjOFfTB2B3oLInU45CC9LtqMA/132","comment_is_top":false,"comment_ctime":1557247180,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5852214476","product_id":100023901,"comment_content":"çº¿ç¨‹çš„æœ¬åœ°å­˜å‚¨æ˜¯åŠ äº†nativeå…³é”®å­—æ¥ä¿®é¥°çš„ä¹ˆ","like_count":1},{"had_liked":false,"id":92378,"user_name":"QQæ€ª","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1557241349,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5852208645","product_id":100023901,"comment_content":"æ‰©å±•:å¯ä»¥æ‰“æ–­ç‚¹è¿›ThreadLocalçš„getmapæ–¹æ³•é‡Œé¢å¯ä»¥ç›´æ¥çœ‹åˆ°slfå¯¹è±¡æ˜¯ä¸åŒçš„","like_count":1},{"had_liked":false,"id":92076,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1557186444,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5852153740","product_id":100023901,"comment_content":"è¿™èŠ‚çš„ThreadLocalï¼Œæˆ‘è®°å¾—15å¹´åˆšå¼€å§‹å·¥ä½œçš„æ—¶å€™ï¼Œå·¥ä½œä¸­æœ‰ä¸€ä¸ªéœ€è¦åŠ¨æ€åˆ‡æ¢æ•°æ®æºçš„éœ€æ±‚ï¼ŒSpring+Hibernateæ¡†æ¶ï¼Œå½“æ—¶é€šè¿‡ç™¾åº¦æŸ¥åˆ°ç”¨ThreadLocalï¼Œä½¿ç”¨AOPåœ¨è¿›å…¥serviceå±‚ä¹‹å‰æ¥åˆ‡æ¢æ•°æ®æºã€‚æ­£å¥½è·Ÿè¿™é‡Œæ–‡ç« è¯´çš„Springä½¿ç”¨ThreadLocalæ¥ä¼ é€’äº‹ç‰©ä¿¡æ¯æ„æ€ä¸€æ ·å§ã€‚","like_count":1},{"had_liked":false,"id":329938,"user_name":"æˆ‘ æˆ‘ æˆ‘","can_delete":false,"product_type":"c1","uid":1180597,"ip_address":"","ucode":"DB9BC7110A7B3F","user_header":"https://static001.geekbang.org/account/avatar/00/12/03/b5/cf6a5f97.jpg","comment_is_top":false,"comment_ctime":1641658181,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641658181","product_id":100023901,"comment_content":"springçš„äº‹åŠ¡ç®¡ç†å™¨åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ä½¿ç”¨ï¼Œ å¯ä»¥åœ¨å­çº¿ç¨‹é‡Œæ˜¯å¯ä»¥åšä¸€ä¸ªå®Œæ•´äº‹åŠ¡ï¼ˆä»å¼€å¯äº‹åŠ¡åˆ°æäº¤äº‹åŠ¡ï¼‰æäº¤å§ã€‚","like_count":0},{"had_liked":false,"id":308000,"user_name":"è‹å½§","can_delete":false,"product_type":"c1","uid":1622448,"ip_address":"","ucode":"C016B28DF7449C","user_header":"https://static001.geekbang.org/account/avatar/00/18/c1/b0/b52d9ade.jpg","comment_is_top":false,"comment_ctime":1629353419,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1629353419","product_id":100023901,"comment_content":"ThreadLocalå¯ç”¨æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯","like_count":0},{"had_liked":false,"id":285129,"user_name":"é©¬ä»¥","can_delete":false,"product_type":"c1","uid":1344431,"ip_address":"","ucode":"3FEA06CA14DE28","user_header":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","comment_is_top":false,"comment_ctime":1616636111,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616636111","product_id":100023901,"comment_content":"å†™ä¸€ä¸ªç»Ÿä¸€ç®¡ç†çº¿ç¨‹æ± å¯¹è±¡ï¼Œåˆ©ç”¨try- with- resourceç»Ÿä¸€ç®¡ç†Threadlocalçš„å›æ”¶","like_count":0},{"had_liked":false,"id":283625,"user_name":"ä¿ºèƒ½å­¦ä¸ªå•¥","can_delete":false,"product_type":"c1","uid":1026742,"ip_address":"","ucode":"30740C5B58774C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/aa/b6/46a5bbf3.jpg","comment_is_top":false,"comment_ctime":1615860089,"is_pvip":false,"replies":[{"id":"103033","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1616043889,"ip_address":"","comment_id":283625,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1615860089","product_id":100023901,"comment_content":"å¼‚æ­¥æ„å‘³ç€å¤šçº¿ç¨‹ï¼Œä¸èƒ½ç”¨ThreadLocalç»§è€Œæ— æ³•ä½¿ç”¨äº‹åŠ¡","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517096,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616043889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":278534,"user_name":"æ—…é€”","can_delete":false,"product_type":"c1","uid":1212902,"ip_address":"","ucode":"5022477E8E9441","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/e6/6cafed37.jpg","comment_is_top":false,"comment_ctime":1613026607,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1613026607","product_id":100023901,"comment_content":"äºŒåˆ·  æœ‰ä¸ªé—®é¢˜é—®ä¸‹ å¦‚æœåªæ˜¯æƒ³åœ¨çº¿ç¨‹ä¸­ä¼ é€’å˜é‡,ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ä¸€ä¸ªThreadçš„æˆå‘˜å˜é‡å‘¢?","like_count":0},{"had_liked":false,"id":268309,"user_name":"Monday","can_delete":false,"product_type":"c1","uid":1250907,"ip_address":"","ucode":"77B9BACC783598","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","comment_is_top":false,"comment_ctime":1608130954,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608130954","product_id":100023901,"comment_content":"å®‰å…¨çš„SimpleDateFormatä»£ç ï¼Œä¹ä¸€çœ‹æ‰“å°ç»“æœç«Ÿç„¶ä¸€æ ·ã€‚åé¢ç”¨==åˆ¤æ–­ï¼Œæ‰å‘ç°å¹¶ä¸æ—¶åŒä¸€ä¸ªå¯¹è±¡ã€‚ç›¸åŒçš„æ‰“å°ç»“æœå…¶å®æ˜¯SimpleDateFormat.patternï¼ˆå³â€œyyyy-MM-ddâ€ï¼‰ä¸€æ ·å¯¼è‡´çš„<br><br>&#47;**<br> * çº¿ç¨‹å®‰å…¨çš„SimpleDateFormat<br> *&#47;<br>public class SafeSimpleDateFormat {<br><br>    private static ThreadLocal&lt;SimpleDateFormat&gt; tl =<br>            ThreadLocal.withInitial(()-&gt;new SimpleDateFormat(&quot;yyyy-MM-dd&quot;));<br><br>    public static SimpleDateFormat get(){<br>        return tl.get();<br>    }<br><br>    public static void main(String[] args){<br>        print(get());<br>        print(get());<br>        int size = 2;<br>        for(int i = 0; i &lt; size; i++){<br>            new Thread(()-&gt;{<br>                print(get());<br>                print(get());<br>            }, &quot;çº¿ç¨‹&quot; + i).start();<br>        }<br>    }<br><br>    static void print(Object obj){<br>        System.out.println(Thread.currentThread().getName()  + &quot;__&quot; + obj);<br>    }<br>}<br><br>æ‰“å°ç»“æœï¼š<br>main__java.text.SimpleDateFormat@f67a0200<br>main__java.text.SimpleDateFormat@f67a0200<br>çº¿ç¨‹1__java.text.SimpleDateFormat@f67a0200<br>çº¿ç¨‹0__java.text.SimpleDateFormat@f67a0200<br>çº¿ç¨‹1__java.text.SimpleDateFormat@f67a0200<br>çº¿ç¨‹0__java.text.SimpleDateFormat@f67a0200<br>","like_count":0},{"had_liked":false,"id":239062,"user_name":"é˜¿æ‹‰ä¸ç¯","can_delete":false,"product_type":"c1","uid":1277094,"ip_address":"","ucode":"59664187E74917","user_header":"https://static001.geekbang.org/account/avatar/00/13/7c/a6/93a0f6f8.jpg","comment_is_top":false,"comment_ctime":1596424800,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596424800","product_id":100023901,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼ŒæŠŠkeyï¼Œvalueéƒ½è®¾ç½®ä¸ºå¼ºå¼•ç”¨ï¼Œæœ€åä¸€èµ·removeè¿™æ ·ä¼šä¸ä¼šæ›´ç®€å•ä¸€ç‚¹ï¼Ÿ","like_count":0},{"had_liked":false,"id":224675,"user_name":"Just","can_delete":false,"product_type":"c1","uid":2022626,"ip_address":"","ucode":"35FA6917DE1D04","user_header":"https://static001.geekbang.org/account/avatar/00/1e/dc/e2/a3abd320.jpg","comment_is_top":false,"comment_ctime":1591503376,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591503376","product_id":100023901,"comment_content":"ThreadLocalæœ¬æ¥å°±æ˜¯ä¸ºäº†çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œå®ç°çº¿ç¨‹å®‰å…¨çš„ç›®çš„ï¼Œå¦‚æœå¼‚æ­¥åœºæ™¯ä½¿ç”¨ç›¸å½“äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ã€‚æ²¡æœ‰å…±äº«å°±æ²¡æœ‰ä¼¤å®³ã€‚","like_count":0},{"had_liked":false,"id":222259,"user_name":"redis","can_delete":false,"product_type":"c1","uid":1066278,"ip_address":"","ucode":"91C54605384F51","user_header":"https://static001.geekbang.org/account/avatar/00/10/45/26/f54c9888.jpg","comment_is_top":false,"comment_ctime":1590728881,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590728881","product_id":100023901,"comment_content":"InheritableThreadLocal ä¸é€‚åˆåœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨è¿˜æœ‰ä¸ªåŸå› ï¼Œçº¿ç¨‹å¤ç”¨ï¼Œè€Œä¸æ˜¯åˆ›å»ºï¼Œè¿™ä¸ªæ—¶å€™å°±æŒ‚äº†ï¼Œä¸šåŠ¡è¿˜æ˜¯å‚æ•°é€ä¼ é è°±ç‚¹","like_count":0},{"had_liked":false,"id":200988,"user_name":"So","can_delete":false,"product_type":"c1","uid":1485274,"ip_address":"","ucode":"60095793800451","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/fLsz4MWRfXUNutWJQLtCMYsEibczUJbGBWIcean2vJZYll5nGRkmHgV3BbXVicGt6qUmDEcZM0VlOdj8O06UhjvQ/132","comment_is_top":false,"comment_ctime":1585703237,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585703237","product_id":100023901,"comment_content":"æƒ³é—®ä¸‹ä½¿ç”¨InheritableThreadLocalä¼ é€’çˆ¶çº¿ç¨‹çš„å˜é‡ç»™å­çº¿ç¨‹å’Œä½¿ç”¨æ„é€ æ–¹æ³•æ˜¾å¼ä¼ å€¼ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹ç”¨æˆå‘˜å˜é‡æ¥æ”¶ä¾›å­çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ","like_count":0},{"had_liked":false,"id":176747,"user_name":"Chuan","can_delete":false,"product_type":"c1","uid":1438352,"ip_address":"","ucode":"FACEC5DAC36A7A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4akcIyIOXB2OqibTe7FF90hwsBicxkjdicUNTMorGeIictdr3OoMxhc20yznmZWwAvQVThKPFWgOyMw/132","comment_is_top":false,"comment_ctime":1581153970,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1581153970","product_id":100023901,"comment_content":"å¤§å®¶è€ƒè™‘çš„ç”±äºEntryçš„keyå¯¹ThreadLocalå¯¹è±¡æ˜¯å¼±å¼•ç”¨ï¼Œåœ¨GCçš„æ—¶å€™ä¼šè¢«å›æ”¶ï¼Œå¯èƒ½å­˜åœ¨æŸä¸€æ¬¡getæ—¶ï¼Œgetä¸åˆ°å€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬çš„å®è·µæ–¹æ³•æ˜¯ï¼Œç»™è¿™ä¸ªThreadLocalå˜é‡è®¾ç½®ä¸ºstaticã€‚è®¾ç½®ä¸ºstaticæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š<br>1. ä¸ºThreadLocalå¯¹è±¡æ·»åŠ äº†ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œè¿™æ ·ThreadLocalå¯¹è±¡ä¸ä¼šè¢«å›æ”¶ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦æˆ‘ä»¬åœ¨ä½¿ç”¨å®Œ åæ‰‹åŠ¨å›æ”¶ã€‚<br>2. è§£å†³äº†â€œThreadLocalå¯¹è±¡æ— æ³•è§£å†³å…±äº«å¯¹è±¡çš„æ›´æ–°é—®é¢˜â€è¿™ä¸€é—®é¢˜ï¼Œè¯¥å®è·µåœ¨é˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œä¸Šæœ‰æ¨èã€‚å½“ThreadLocalå¯¹è±¡ä¸ºé™æ€å˜é‡ï¼Œåœ¨ç±»åŠ è½½æ—¶è¢«åˆå§‹åŒ–åï¼Œæ‰€æœ‰æ­¤ç±»çš„å®ä¾‹å¯¹è±¡éƒ½å¯ä»¥æ“ä½œæ”¹å˜é‡ã€‚<br><br>ä¸çŸ¥é“ä¸Šè¿°è¯´æ³•æ˜¯å¦æœ‰é—®é¢˜ï¼Œè¯·è€å¸ˆæŒ‡æ­£ï¼","like_count":0},{"had_liked":false,"id":168167,"user_name":"Cv","can_delete":false,"product_type":"c1","uid":1062797,"ip_address":"","ucode":"C77CE172B5AA28","user_header":"","comment_is_top":false,"comment_ctime":1578024265,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1578024265","product_id":100023901,"comment_content":"æ–‡ä¸­çš„ä¾‹å­å·¥å…·ç±»SafeDateFormatåœ¨è¢«çº¿ç¨‹æ± ä½¿ç”¨æ—¶å¯èƒ½å¯¼è‡´OOM, åŠ ä¸Šremoveååˆä¸€æ ·æ¯æ¬¡éœ€è¦é”€æ¯é‡æ–°åˆ›å»º, é‚£ä¹ˆæˆ‘ä»¬åœ¨å†™è¿™ä¸ªå·¥å…·ç±»æ—¶æ˜¯å¦å°±ç›´æ¥newä¸€ä¸ªä¸´æ—¶çš„DateFormatå‡ºæ¥ç”¨,è€Œä¸ä½¿ç”¨threadlocalæ¯”è¾ƒå¥½å‘¢","like_count":0},{"had_liked":false,"id":166898,"user_name":"æŸä¸çŸ¥åæŒ¨è¸¢ç”·","can_delete":false,"product_type":"c1","uid":1332106,"ip_address":"","ucode":"BD2223CD9D7C2A","user_header":"https://static001.geekbang.org/account/avatar/00/14/53/8a/f9ef54c1.jpg","comment_is_top":false,"comment_ctime":1577627229,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1577627229","product_id":100023901,"comment_content":"åœ¨å­¦ä¹ android handleråŸç†çš„æ—¶å€™ï¼ŒLooperå°±æ˜¯ä½¿ç”¨ThreadLocalå­˜æ”¾looperå¯¹è±¡çš„ã€‚å½“æ—¶åªçŸ¥é“ThreadLocalæ˜¯æ¯ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œä¸€ç›´å­˜åœ¨ç€å›°æƒ‘ThreadLocalæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿç°åœ¨æœ‰äº†ç­”æ¡ˆäº†ï¼Œè°¢è°¢è€å¸ˆã€‚","like_count":0},{"had_liked":false,"id":160681,"user_name":"æ¢¦å€šæ æ†","can_delete":false,"product_type":"c1","uid":1095857,"ip_address":"","ucode":"BDEB97F2822445","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/bvj76PmeUvW8kokyu91IZWuRATKmabibDWbzAj2TajeEic7WvKCJOLaOh6jibEmdQ36EO3sBUZ0HibAiapsrZo64U8w/132","comment_is_top":false,"comment_ctime":1576020472,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1576020472","product_id":100023901,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼šThread å¯¹è±¡å’Œè¿è¡Œçš„çº¿ç¨‹æ˜¯åŒä¸€ä¸ªä¸œè¥¿å—ï¼Œå¦‚æœä¸æ˜¯ï¼Œèƒ½è§£é‡Šä¸€ä¸‹åŒºåˆ«å—ï¼Ÿå¦‚æœæ˜¯æœ‰å¦‚ä¸‹ç–‘é—®ï¼š<br>ThreadLocal åˆ›å»ºmapæ—¶æœ‰å¦‚ä¸‹ä»£ç ã€‚<br>void createMap(Thread t, T firstValue) {<br>        t.threadLocals = new ThreadLocalMap(this, firstValue);<br>    }<br><br>å¦‚æœåœ¨ä¸€ä¸ªæ‰§è¡Œæµç¨‹é‡Œå®šä¹‰äº†å¤šä¸ªtheadLocal, æ ¹æ®è¿™æ®µä»£ç ï¼Œt.threadLocalsçš„å¼•ç”¨å°±æŒ‡å‘äº†æœ€åä¸€ä¸ªthreadLocalçš„å®šä¹‰ã€‚æ„Ÿè§‰java sdk è‚¯å®šä¸ä¼šè¿™æ ·å•Šã€‚è€å¸ˆèƒ½è§£é‡Šä¸€ä¸‹å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1270617,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ2EOx1qgJEYDIfQYEZvaORasynqBFW3SSaG9msGaMI7XUxESDLzXu1ibzicCA6p6CvhsBegleCrHeA/132","nickname":"Geek_7dd5bf","note":"","ucode":"FAB0E6CD0992DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387811,"discussion_content":"å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå®šä¹‰äº†å¤šä¸ªThreadLocal,åªæœ‰ç¬¬ä¸€ä¸ªThreadLocalä¼šæ‰§è¡Œåˆ°createMapæ–°å»ºmapçš„é€»è¾‘ï¼Œåç»­çš„ThreadLocalä¼šæ‰§è¡Œsetæ–¹æ³•æ—¶ï¼Œå†…éƒ¨æœ‰åˆ¤æ–­å¦‚æœå½“å‰çº¿ç¨‹å·²ç»åˆ›å»ºäº†ThreadLocalMapï¼Œåˆ™ç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸é‡æ–°åˆ›å»ºï¼Œæ‰€ä»¥è¿™ä¸ªçº¿ç¨‹å†…æ‰€æœ‰çš„ThreadLocalå…¬ç”¨ä¸€ä¸ªThreadLocalMap","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628430119,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156194,"user_name":"æ—è‚¯","can_delete":false,"product_type":"c1","uid":1008582,"ip_address":"","ucode":"D2C97220230DE5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/63/c6/d6ea3df3.jpg","comment_is_top":false,"comment_ctime":1574831191,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574831191","product_id":100023901,"comment_content":"è€å¸ˆå¥½ï¼Œè¯·æ•™ä¸ªé—®é¢˜ã€‚å¼±å¼•ç”¨å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡gcå‰ï¼Œå¦‚æœä¸‹ä¸€æ¬¡gcæ—¶çº¿ç¨‹è¿˜åœ¨è€Œä¸”æˆ‘è¿˜éœ€è¦ç”¨åˆ°threadlocalï¼Œè¿™æ—¶å€™å²‚ä¸æ˜¯å–ä¸åˆ°æ•°æ®ï¼Ÿ","like_count":0},{"had_liked":false,"id":142903,"user_name":"Demon.Lee","can_delete":false,"product_type":"c1","uid":1052859,"ip_address":"","ucode":"7F0E5493A8E345","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","comment_is_top":false,"comment_ctime":1571578490,"is_pvip":false,"discussion_count":1,"race_medal":1,"score":"1571578490","product_id":100023901,"comment_content":"è€å¸ˆï¼Œå¯¹äºThreadLocalå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œæ•´ä½“é€»è¾‘ä¸Šæˆ‘æ˜¯æ˜ç™½çš„ï¼Œä½†æœ‰ä¸€ç‚¹è¿˜æ˜¯ç³Šæ¶‚ï¼Œæˆ‘ä¹Ÿå»googleå¾ˆå¤šæ–‡ç« ï¼Œè¿˜æ˜¯ä¸å®Œå…¨æ˜ç™½ã€‚å°±æ˜¯è¿™ä¸ªEntryæ•°ç»„é‡Œé¢çš„å¼±å¼•ç”¨ï¼Œå®ƒä¼šåœ¨ä¸‹ä¸€æ¬¡GCä¹‹åå°±è¢«å›æ”¶äº†ï¼Œä½†è¿™ä¸ªå›æ”¶ä»…ä»…åªæ˜¯ThreadLocalå®ä¾‹çš„ä¸€ä¸ªå¼•ç”¨å§ï¼ŒThreadLocalå®ä¾‹å¯¹è±¡è‡ªèº«æ˜¯final staticä¿®é¥°çš„ï¼Œå®ƒåº”è¯¥ä¸€ç›´éƒ½åœ¨å§ã€‚è¿™ä¸ªThreadLocalå®ä¾‹å¯¹è±¡æ˜¯æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šå¼•ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå†…å­˜æ³„æ¼çš„ä¸»è¦è¿˜æ˜¯valueï¼Œè·Ÿè¿™ä¸ªkeyæ²¡ä»€ä¹ˆå¤ªå¤§å…³ç³»ã€‚å¦‚æœè¿™ä¸ªkeyåˆæ”¹å›å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆå†…å­˜æ³„æ¼ä¹Ÿåªæ˜¯å¤šäº†ä¸€ä¸ªThreadLocalå®ä¾‹çš„å¼•ç”¨ï¼Œæˆ‘çš„ç†è§£å¯¹ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1277094,"avatar":"https://static001.geekbang.org/account/avatar/00/13/7c/a6/93a0f6f8.jpg","nickname":"é˜¿æ‹‰ä¸ç¯","note":"","ucode":"59664187E74917","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296001,"discussion_content":"æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆç†è§£çš„ï¼Œæˆ‘è¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯ä¸ºå•¥keyï¼Œvaluä¸éƒ½è®¾ç½®ä¸ºå¼ºå¼•ç”¨ï¼Œæœ€åä¸€èµ·removeï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596424682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128035,"user_name":"xinglichea","can_delete":false,"product_type":"c1","uid":1176447,"ip_address":"","ucode":"986DA07BF3CA89","user_header":"https://static001.geekbang.org/account/avatar/00/11/f3/7f/2dd9409b.jpg","comment_is_top":false,"comment_ctime":1566823402,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566823402","product_id":100023901,"comment_content":"è€å¸ˆï¼Œè¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šä¸ä¼šå‡ºç°ThreadLocal.get()çš„Valueä¸ºnullï¼Œç”±äºå¼±å¼•ç”¨çš„åŸå› ï¼ŒGCæŠŠkeyå›æ”¶æ‰äº†ï¼Œæ‰€ä»¥æ— æ³•æ‰¾åˆ°å¯¹åº”çš„valueå€¼ï¼Œæ„Ÿè§‰Entryå¯¹ç±»åœ¨åšè®¾è®¡çš„æ—¶å€™æ˜¯ä¸æ˜¯ç”¨è½¯å¼•ç”¨è¾ƒä¸ºåˆé€‚äº›ï¼Œè‡³å°‘æ˜¯åœ¨å†…å­˜ç©ºé—´ä¸å¤Ÿçš„æƒ…å†µä¸‹ï¼Œå†è¿›è¡Œå›æ”¶ï¼Œå‡ºç°nullçš„å‡ ç‡è¦æ¯”å¼±ä½¿ç”¨ä½çš„å¤šã€‚","like_count":0},{"had_liked":false,"id":118113,"user_name":"Vincent","can_delete":false,"product_type":"c1","uid":1135159,"ip_address":"","ucode":"CD8B84A57A6A0C","user_header":"https://static001.geekbang.org/account/avatar/00/11/52/37/13b4c8aa.jpg","comment_is_top":false,"comment_ctime":1564244678,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564244678","product_id":100023901,"comment_content":"è€å¸ˆæˆ‘æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œthreadlock åœ¨key å› ä¸ºå¼±å¼•ç”¨è¢«å›æ”¶åï¼Œåœ¨setå’Œget æ–¹æ³•ä¸­ä¸æ˜¯ä¼š è°ƒç”¨replaceStaleEntry é‡Šæ”¾æ‰Entry ã€‚æ€ä¹ˆæœ‰å†…å­˜æ³„æ¼å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":118088,"user_name":"SGT","can_delete":false,"product_type":"c1","uid":1546883,"ip_address":"","ucode":"D88847279B5ADE","user_header":"https://static001.geekbang.org/account/avatar/00/17/9a/83/5df195a2.jpg","comment_is_top":false,"comment_ctime":1564235065,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564235065","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä¸å¤ªæ˜ç™½ä¸ºå•¥æ˜¯threadlocalä½¿ç”¨äº†å¼±å¼•ç”¨é€ æˆoomï¼Œè¿™ä¸ªåº”è¯¥éƒ¨ä¼šé€ æˆoomå§ï¼Œæ ¹æœ¬åŸå› åœ¨äºthreadlocalmapçš„ç”Ÿå‘½å‘¨æœŸå’Œthreadä¸€æ ·é•¿ï¼Œæ‰é€ æˆäº†oomå§ï¼Œæˆ‘ä¸å¤ªæ˜ç™½ä¸ºå•¥å¼±å¼•ç”¨ä¹Ÿä¼šé€ æˆoomï¼Œæˆ–è€…æ¢å¥è¯è¯´å¦‚æœå¼±å¼•ç”¨ä¼šé€ æˆoomï¼Œé‚£å¹²å˜›ä¸æ¢æˆå¼ºå¼•ç”¨äº†","like_count":0,"discussions":[{"author":{"id":1008582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/63/c6/d6ea3df3.jpg","nickname":"æ—è‚¯","note":"","ucode":"D2C97220230DE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":62303,"discussion_content":"è€å¸ˆè¯´çš„æ˜¯å†…å­˜æ³„éœ²ï¼Œä¸æ˜¯å†…å­˜æº¢å‡º","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574831266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110210,"user_name":"capo","can_delete":false,"product_type":"c1","uid":1178016,"ip_address":"","ucode":"6FD72DA5DBC220","user_header":"https://static001.geekbang.org/account/avatar/00/11/f9/a0/2240fb2c.jpg","comment_is_top":false,"comment_ctime":1562208435,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562208435","product_id":100023901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘ä»¬çœ‹ä¸¤ä¸ªçº¿ç¨‹é‡Œé¢getè·å–çš„å€¼æ˜¯æ‰“å°å†…å­˜åœ°å€å—ï¼ŸSystem.identityHashCode","like_count":0},{"had_liked":false,"id":107452,"user_name":"è¾¾æ‹‰å´©å§æ–‘çš„æ¯”åœ","can_delete":false,"product_type":"c1","uid":1447604,"ip_address":"","ucode":"04D54EFD2056D5","user_header":"https://static001.geekbang.org/account/avatar/00/16/16/b4/88dfd8af.jpg","comment_is_top":false,"comment_ctime":1561538275,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1561538275","product_id":100023901,"comment_content":"è€å¸ˆï¼Œæ€ä¹ˆç¡®å®šä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸€ä¸ªthreadlocalå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1344007,"avatar":"https://static001.geekbang.org/account/avatar/00/14/82/07/5940b400.jpg","nickname":"SaimSaim","note":"","ucode":"E4755472EF6C1E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6567,"discussion_content":"çœ‹get()çš„æºç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566978459,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":97588,"user_name":"æ˜“å„¿æ˜“","can_delete":false,"product_type":"c1","uid":1242864,"ip_address":"","ucode":"B15D1031CA841E","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqLcWH3mSPmhjrs1aGL4b3TqI7xDqWWibM4nYFrRlp0z7FNSWaJz0mqovrgIA7ibmrPt8zRScSfRaqQ/132","comment_is_top":false,"comment_ctime":1558702899,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558702899","product_id":100023901,"comment_content":"è€å¸ˆï¼Œå†™demoçš„æ—¶å€™å‘ç°ï¼Œthreadlocalmapä¸­å§‹ç»ˆä¼šæœ‰ä¸¤ä¸ªé™Œç”Ÿçš„entryï¼Œvalueæ˜¯ä¸¤ä¸ªè½¯å¼•ï¼Œåˆ†åˆ«æ˜¯StringDecoderå’ŒStringEncoderï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸¤ä¸ªä¸œè¥¿å‘¢ï¼Ÿè¿™é‡ŒæŒ‡å®šçš„GBKæ˜¯ç”¨æ¥æŒ‡æ˜çº¿ç¨‹æ‰€æœ‰ä¸Šä¸‹æ–‡æ–‡æœ¬ç¼–ç æ ¼å¼çš„å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":95419,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1558054940,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1558054940","product_id":100023901,"comment_content":"æœŸå¾…è€å¸ˆè§£ç­”è¿™é‡Œçš„æ€è€ƒé¢˜ã€‚","like_count":0},{"had_liked":false,"id":94353,"user_name":"å¤šè¥„ä¸¸","can_delete":false,"product_type":"c1","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1557794778,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557794778","product_id":100023901,"comment_content":"å¼‚æ­¥åœºæ™¯ä¸­ï¼Œè¢«è°ƒç”¨æ–¹å¯ä»¥è‡ªå·±ç”¨springçš„äº‹äº‹åŠ¡æ¥ç®¡ç†å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":93139,"user_name":"_light","can_delete":false,"product_type":"c1","uid":1324723,"ip_address":"","ucode":"ACE2ABC357C5FF","user_header":"https://static001.geekbang.org/account/avatar/00/14/36/b3/c4a2f3fd.jpg","comment_is_top":false,"comment_ctime":1557406639,"is_pvip":false,"replies":[{"id":"33205","content":"æˆ‘ä¹Ÿæ²¡çœ‹è¿‡ï¼Œæœ€è¿‘å¤ªå¿™äº†ğŸ˜‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1557411413,"ip_address":"","comment_id":93139,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1557406639","product_id":100023901,"comment_content":"è€å¸ˆï¼Œä½ å¥½<br> é˜¿é‡Œæœ‰ä¸€ä¸ªTransmittableThreadLocalæ®è¯´æ˜¯æ”¯æŒçº¿ç¨‹æ± çº¿ç¨‹å¤ç”¨çš„ç»§æ‰¿äº†InheritableThreadLocalç±»çš„ä¸œè¥¿ï¼Œæˆ‘è¯•äº†ä¸‹ç¡®å®å¯ä»¥ï¼Œä»–å¯ä»¥åœ¨çº¿ç¨‹æ± çº¿ç¨‹æ‰§è¡Œæ—¶æ‹¿åˆ°æ­£ç¡®çš„çˆ¶ç±»æœ¬åœ°å˜é‡ï¼Œå…¶å®ä¹Ÿä¸æ˜¯çˆ¶ç±»ï¼Œå°±æ˜¯åˆå§‹åŒ–èµ‹å€¼TransmittableThreadLocalçš„é‚£ä¸ªçº¿ç¨‹çš„æ•°æ®ï¼Œå› ä¸ºæˆ‘ä»¬çš„çº¿ç¨‹æ± ä¸€èˆ¬éƒ½æ˜¯é™æ€å…¨å±€çš„ï¼Œè°æ˜¯çˆ¶ç±»éƒ½è¯´ä¸æ¸…æ¥šã€‚æ„Ÿè§‰è¿™ä¸ªå¥½å¼ºå¤§å•Šï¼Œä»–åŒ…è£…äº†çº¿ç¨‹æ± ï¼Œçœ‹äº†å¥½å‡ æ¬¡æºç éƒ½æ²¡å•ƒä¸‹æ¥ï¼Œå®åœ¨æ˜¯å¥½å¥‡æ€ä¹ˆå®ç°çš„ï¼Œè€å¸ˆæœ‰ç©ºå¯ä»¥å¸®æˆ‘ä»¬åˆ†æä¸‹ä¸å•¦ğŸ˜€","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449502,"discussion_content":"æˆ‘ä¹Ÿæ²¡çœ‹è¿‡ï¼Œæœ€è¿‘å¤ªå¿™äº†ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557411413,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92357,"user_name":"å¼ å¤©å±¹","can_delete":false,"product_type":"c1","uid":1477612,"ip_address":"","ucode":"8BD6BD6DCF0F4F","user_header":"https://static001.geekbang.org/account/avatar/00/16/8b/ec/dc03f5ad.jpg","comment_is_top":false,"comment_ctime":1557239595,"is_pvip":false,"replies":[{"id":"67561","content":"å»ºè®®ä¸è¦å¼‚æ­¥ï¼Œé™¤éä½ èƒ½ä¿è¯å­çº¿ç¨‹ç”¨çš„æ•°æ®åº“è¿æ¥å’Œä¸»çº¿ç¨‹æ˜¯ä¸€æ ·çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1579776211,"ip_address":"","comment_id":92357,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1557239595","product_id":100023901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œspringæœ‰äº‹åŠ¡ç®¡ç†å¹¶å‘å®‰å…¨ï¼Œä½†æ˜¯äº‹åŠ¡é‡Œä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹çš„å®‰å…¨ä¸€èˆ¬æ€ä¹ˆä¿è¯å‘¢ï¼Ÿæ¯”å¦‚åœ¨äº‹åŠ¡é‡Œæ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œserviceæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè„±ç¦»åŸæœ‰çš„äº‹åŠ¡ï¼Œå¦‚æœè¿™ä¸ªå¼‚æ­¥æ–¹æ³•é‡Œæ¶‰åŠåˆ°å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œåº”è¯¥æ€ä¹ˆä¿è¯æ•°æ®å®‰å…¨æ€§å‘¢ï¼Ÿåœ¨ä¿è¯å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œspringçš„äº‹åŠ¡æ–¹æ³•ä¸­å“ªäº›æ“ä½œé€‚åˆå¼‚æ­¥æ‰§è¡Œå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":449225,"discussion_content":"å»ºè®®ä¸è¦å¼‚æ­¥ï¼Œé™¤éä½ èƒ½ä¿è¯å­çº¿ç¨‹ç”¨çš„æ•°æ®åº“è¿æ¥å’Œä¸»çº¿ç¨‹æ˜¯ä¸€æ ·çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579776211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92259,"user_name":"æœ¨åˆ»","can_delete":false,"product_type":"c1","uid":1157430,"ip_address":"","ucode":"0A3226FEE3983B","user_header":"https://static001.geekbang.org/account/avatar/00/11/a9/36/972f7abf.jpg","comment_is_top":false,"comment_ctime":1557216031,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557216031","product_id":100023901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘å¦‚ä¸‹æ–¹å¼ä¸åŒçº¿ç¨‹è¿”å›çš„SimpleDateFormatå¯¹è±¡ä¹Ÿæ˜¯åŒä¸€ä»½ï¼Œæ˜¯ä»€ä¹ˆåŸå› ï¼š<br><br>public class SafeDateFormat {<br><br>    static final ThreadLocal&lt;DateFormat&gt; tl = ThreadLocal.withInitial(<br>            () -&gt; new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;)<br>    );<br><br>    static DateFormat get(){<br>        return tl.get();<br>    }<br><br>    public static void main(String[] args) {<br>        for (int i=0;i&lt;5;i++){<br>            new Thread(() -&gt; {<br>                System.out.println(SafeDateFormat.get());<br>            }).start();<br>        }<br>    }<br>}","like_count":0},{"had_liked":false,"id":92124,"user_name":"cricket1981","can_delete":false,"product_type":"c1","uid":1001715,"ip_address":"","ucode":"758262F5958DA4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/f3/f1034ffd.jpg","comment_is_top":false,"comment_ctime":1557190768,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557190768","product_id":100023901,"comment_content":"ä¸èƒ½ä½¿ç”¨ï¼Œå¼‚æ­¥ç¼–ç¨‹æ˜¯ä¸åŒçº¿ç¨‹æ‰§è¡Œï¼Œæ— æ³•è·å–åŒä¸€ä»½ThreadLocalå˜é‡","like_count":0},{"had_liked":false,"id":92112,"user_name":"è¢é˜³","can_delete":false,"product_type":"c1","uid":1329594,"ip_address":"","ucode":"B397F760CDC53A","user_header":"https://static001.geekbang.org/account/avatar/00/14/49/ba/02742d56.jpg","comment_is_top":false,"comment_ctime":1557189655,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557189655","product_id":100023901,"comment_content":"è€å¸ˆï¼Œæˆ‘æœ‰ä¸ªé—®é¢˜ï¼ŒThreadLocal.ThreadLocalMapçš„setæ–¹æ³•å¹¶æ²¡æœ‰åŠ é”ï¼Œå®ƒåœ¨Threadä¸­çš„å¯è§æ€§æ˜¯åŒ…å¯è§çš„ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘åœ¨Threadè¿™ä¸ªç±»æ‰€åœ¨åŒ…é‡Œé¢å¹¶å‘è°ƒç”¨ä¸€ä¸ªThread.threadLocals.set()æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿè¯·è€å¸ˆè§£ç­”","like_count":0},{"had_liked":false,"id":92091,"user_name":"é’è²","can_delete":false,"product_type":"c1","uid":1181787,"ip_address":"","ucode":"6BA5D5D47DE38E","user_header":"https://static001.geekbang.org/account/avatar/00/12/08/5b/2a342424.jpg","comment_is_top":false,"comment_ctime":1557188046,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1557188046","product_id":100023901,"comment_content":"å¼‚æ­¥ä¸€èˆ¬é‡‡ç”¨çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ï¼Œè¿™é‡Œå°±ä¼šæœ‰ä¸€ä¸ªäº‹åŠ¡çš„å¯ç»§æ‰¿æ€§é—®é¢˜ï¼Œäº‹ç‰©èµ„æºçš„é‡Šæ”¾ï¼Œä»¥åŠçº¿ç¨‹æ± æ‰§è¡Œäº†ä»»åŠ¡æ˜¯å¦ä¼šäº§ç”Ÿä¸šåŠ¡é”™ä¹±","like_count":0},{"had_liked":false,"id":92086,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1557187558,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1557187558","product_id":100023901,"comment_content":"ä¸è¡Œï¼Œä¸åŒçš„çº¿ç¨‹ï¼Œä¸åŒçš„ThreadLocalï¼Œä¸”ä¸å…·æœ‰é›†æˆæ€§","like_count":0}]}