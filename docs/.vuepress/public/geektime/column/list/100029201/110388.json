{"id":110388,"title":"23 | Kafka副本机制详解","content":"<p>你好，我是胡夕。今天我要和你分享的主题是：Apache Kafka的副本机制。</p><p>所谓的副本机制（Replication），也可以称之为备份机制，通常是指分布式系统在多台网络互联的机器上保存有相同的数据拷贝。副本机制有什么好处呢？</p><ol>\n<li><strong>提供数据冗余</strong>。即使系统部分组件失效，系统依然能够继续运转，因而增加了整体可用性以及数据持久性。</li>\n<li><strong>提供高伸缩性</strong>。支持横向扩展，能够通过增加机器的方式来提升读性能，进而提高读操作吞吐量。</li>\n<li><strong>改善数据局部性</strong>。允许将数据放入与用户地理位置相近的地方，从而降低系统延时。</li>\n</ol><p>这些优点都是在分布式系统教科书中最常被提及的，但是有些遗憾的是，对于Apache Kafka而言，目前只能享受到副本机制带来的第1个好处，也就是提供数据冗余实现高可用性和高持久性。我会在这一讲后面的内容中，详细解释Kafka没能提供第2点和第3点好处的原因。</p><p>不过即便如此，副本机制依然是Kafka设计架构的核心所在，它也是Kafka确保系统高可用和消息高持久性的重要基石。</p><h2>副本定义</h2><p>在讨论具体的副本机制之前，我们先花一点时间明确一下副本的含义。</p><p>我们之前谈到过，Kafka是有主题概念的，而每个主题又进一步划分成若干个分区。副本的概念实际上是在分区层级下定义的，每个分区配置有若干个副本。</p><!-- [[[read_end]]] --><p><strong>所谓副本（Replica），本质就是一个只能追加写消息的提交日志</strong>。根据Kafka副本机制的定义，同一个分区下的所有副本保存有相同的消息序列，这些副本分散保存在不同的Broker上，从而能够对抗部分Broker宕机带来的数据不可用。</p><p>在实际生产环境中，每台Broker都可能保存有各个主题下不同分区的不同副本，因此，单个Broker上存有成百上千个副本的现象是非常正常的。</p><p>接下来我们来看一张图，它展示的是一个有3台Broker的Kafka集群上的副本分布情况。从这张图中，我们可以看到，主题1分区0的3个副本分散在3台Broker上，其他主题分区的副本也都散落在不同的Broker上，从而实现数据冗余。</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/77/3b5f28c6d19b2c6fe592b2b78d3ebc77.jpg?wh=3109*1485\" alt=\"\"></p><h2>副本角色</h2><p>既然分区下能够配置多个副本，而且这些副本的内容还要一致，那么很自然的一个问题就是：我们该如何确保副本中所有的数据都是一致的呢？特别是对Kafka而言，当生产者发送消息到某个主题后，消息是如何同步到对应的所有副本中的呢？针对这个问题，最常见的解决方案就是采用<strong>基于领导者（Leader-based）的副本机制</strong>。Apache Kafka就是这样的设计。</p><p>基于领导者的副本机制的工作原理如下图所示，我来简单解释一下这张图里面的内容。</p><p><img src=\"https://static001.geekbang.org/resource/image/38/c2/381eda4b56991d52727934be7c7e6ec2.jpg?wh=3591*1508\" alt=\"\"></p><p>第一，在Kafka中，副本分成两类：领导者副本（Leader Replica）和追随者副本（Follower Replica）。每个分区在创建时都要选举一个副本，称为领导者副本，其余的副本自动称为追随者副本。</p><p>第二，Kafka的副本机制比其他分布式系统要更严格一些。在Kafka中，追随者副本是不对外提供服务的。这就是说，任何一个追随者副本都不能响应消费者和生产者的读写请求。所有的请求都必须由领导者副本来处理，或者说，所有的读写请求都必须发往领导者副本所在的Broker，由该Broker负责处理。追随者副本不处理客户端请求，它唯一的任务就是从领导者副本<strong>异步拉取</strong>消息，并写入到自己的提交日志中，从而实现与领导者副本的同步。</p><p>第三，当领导者副本挂掉了，或者说领导者副本所在的Broker宕机时，Kafka依托于ZooKeeper提供的监控功能能够实时感知到，并立即开启新一轮的领导者选举，从追随者副本中选一个作为新的领导者。老Leader副本重启回来后，只能作为追随者副本加入到集群中。</p><p>你一定要特别注意上面的第二点，即<strong>追随者副本是不对外提供服务的</strong>。还记得刚刚我们谈到副本机制的好处时，说过Kafka没能提供读操作横向扩展以及改善局部性吗？具体的原因就在于此。</p><p>对于客户端用户而言，Kafka的追随者副本没有任何作用，它既不能像MySQL那样帮助领导者副本“抗读”，也不能实现将某些副本放到离客户端近的地方来改善数据局部性。</p><p>既然如此，Kafka为什么要这样设计呢？其实这种副本机制有两个方面的好处。</p><p>1.<strong>方便实现“Read-your-writes”</strong>。</p><p>所谓Read-your-writes，顾名思义就是，当你使用生产者API向Kafka成功写入消息后，马上使用消费者API去读取刚才生产的消息。</p><p>举个例子，比如你平时发微博时，你发完一条微博，肯定是希望能立即看到的，这就是典型的Read-your-writes场景。如果允许追随者副本对外提供服务，由于副本同步是异步的，因此有可能出现追随者副本还没有从领导者副本那里拉取到最新的消息，从而使得客户端看不到最新写入的消息。</p><p>2.<strong>方便实现单调读（Monotonic Reads）</strong>。</p><p>什么是单调读呢？就是对于一个消费者用户而言，在多次消费消息时，它不会看到某条消息一会儿存在一会儿不存在。</p><p>如果允许追随者副本提供读服务，那么假设当前有2个追随者副本F1和F2，它们异步地拉取领导者副本数据。倘若F1拉取了Leader的最新消息而F2还未及时拉取，那么，此时如果有一个消费者先从F1读取消息之后又从F2拉取消息，它可能会看到这样的现象：第一次消费时看到的最新消息在第二次消费时不见了，这就不是单调读一致性。但是，如果所有的读请求都是由Leader来处理，那么Kafka就很容易实现单调读一致性。</p><h2>In-sync Replicas（ISR）</h2><p>我们刚刚反复说过，追随者副本不提供服务，只是定期地异步拉取领导者副本中的数据而已。既然是异步的，就存在着不可能与Leader实时同步的风险。在探讨如何正确应对这种风险之前，我们必须要精确地知道同步的含义是什么。或者说，Kafka要明确地告诉我们，追随者副本到底在什么条件下才算与Leader同步。</p><p>基于这个想法，Kafka引入了In-sync Replicas，也就是所谓的ISR副本集合。ISR中的副本都是与Leader同步的副本，相反，不在ISR中的追随者副本就被认为是与Leader不同步的。那么，到底什么副本能够进入到ISR中呢？</p><p>我们首先要明确的是，Leader副本天然就在ISR中。也就是说，<strong>ISR不只是追随者副本集合，它必然包括Leader副本。甚至在某些情况下，ISR只有Leader这一个副本</strong>。</p><p>另外，能够进入到ISR的追随者副本要满足一定的条件。至于是什么条件，我先卖个关子，我们先来一起看看下面这张图。</p><p><img src=\"https://static001.geekbang.org/resource/image/52/5f/521ff90472a5fd2e6cfac0e6176aa75f.jpg?wh=3506*1040\" alt=\"\"></p><p>图中有3个副本：1个领导者副本和2个追随者副本。Leader副本当前写入了10条消息，Follower1副本同步了其中的6条消息，而Follower2副本只同步了其中的3条消息。现在，请你思考一下，对于这2个追随者副本，你觉得哪个追随者副本与Leader不同步？</p><p>答案是，要根据具体情况来定。换成英文，就是那句著名的“It depends”。看上去好像Follower2的消息数比Leader少了很多，它是最有可能与Leader不同步的。的确是这样的，但仅仅是可能。</p><p>事实上，这张图中的2个Follower副本都有可能与Leader不同步，但也都有可能与Leader同步。也就是说，Kafka判断Follower是否与Leader同步的标准，不是看相差的消息数，而是另有“玄机”。</p><p><strong>这个标准就是Broker端参数replica.lag.time.max.ms参数值</strong>。这个参数的含义是Follower副本能够落后Leader副本的最长时间间隔，当前默认值是10秒。这就是说，只要一个Follower副本落后Leader副本的时间不连续超过10秒，那么Kafka就认为该Follower副本与Leader是同步的，即使此时Follower副本中保存的消息明显少于Leader副本中的消息。</p><p>我们在前面说过，Follower副本唯一的工作就是不断地从Leader副本拉取消息，然后写入到自己的提交日志中。如果这个同步过程的速度持续慢于Leader副本的消息写入速度，那么在replica.lag.time.max.ms时间后，此Follower副本就会被认为是与Leader副本不同步的，因此不能再放入ISR中。此时，Kafka会自动收缩ISR集合，将该副本“踢出”ISR。</p><p>值得注意的是，倘若该副本后面慢慢地追上了Leader的进度，那么它是能够重新被加回ISR的。这也表明，ISR是一个动态调整的集合，而非静态不变的。</p><h2>Unclean领导者选举（Unclean Leader Election）</h2><p>既然ISR是可以动态调整的，那么自然就可以出现这样的情形：ISR为空。因为Leader副本天然就在ISR中，如果ISR为空了，就说明Leader副本也“挂掉”了，Kafka需要重新选举一个新的Leader。可是ISR是空，此时该怎么选举新Leader呢？</p><p><strong>Kafka把所有不在ISR中的存活副本都称为非同步副本</strong>。通常来说，非同步副本落后Leader太多，因此，如果选择这些副本作为新Leader，就可能出现数据的丢失。毕竟，这些副本中保存的消息远远落后于老Leader中的消息。在Kafka中，选举这种副本的过程称为Unclean领导者选举。<strong>Broker端参数unclean.leader.election.enable控制是否允许Unclean领导者选举</strong>。</p><p>开启Unclean领导者选举可能会造成数据丢失，但好处是，它使得分区Leader副本一直存在，不至于停止对外提供服务，因此提升了高可用性。反之，禁止Unclean领导者选举的好处在于维护了数据的一致性，避免了消息丢失，但牺牲了高可用性。</p><p>如果你听说过CAP理论的话，你一定知道，一个分布式系统通常只能同时满足一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）中的两个。显然，在这个问题上，Kafka赋予你选择C或A的权利。</p><p>你可以根据你的实际业务场景决定是否开启Unclean领导者选举。不过，我强烈建议你<strong>不要</strong>开启它，毕竟我们还可以通过其他的方式来提升高可用性。如果为了这点儿高可用性的改善，牺牲了数据一致性，那就非常不值当了。</p><h2>小结</h2><p>今天，我主要跟你分享了Apache Kafka的副本机制以及它们实现的原理。坦率地说，我觉得有些地方可能讲浅了，如果要百分之百地了解Replication，你还是要熟读一下Kafka相应的源代码。不过你也不用担心，在专栏后面的内容中，我会专门从源码角度分析副本机制，特别是Follower副本从Leader副本拉取消息的全过程。从技术深度上来说，那一讲应该算是本专栏中最贴近技术内幕的分析了，你一定不要错过。</p><p><img src=\"https://static001.geekbang.org/resource/image/d7/72/d75c01661ca5367cfd23ad92cc10e372.jpg?wh=2069*2535\" alt=\"\"></p><h2>开放讨论</h2><p>到目前为止，我反复强调了Follower副本不对外提供服务这件事情。有意思的是，社区最近正在考虑是否要打破这个限制，即允许Follower副本处理客户端消费者发来的请求。社区主要的考量是，这能够用于改善云上数据的局部性，更好地服务地理位置相近的客户。如果允许Follower副本对外提供读服务，你觉得应该如何避免或缓解因Follower副本与Leader副本不同步而导致的数据不一致的情形？</p><p>欢迎写下你的思考和答案，我们一起讨论。如果你觉得有所收获，也欢迎把文章分享给你的朋友。</p>","neighbors":{"left":{"article_title":"22 | 消费者组消费进度监控都怎么实现？","id":109238},"right":{"article_title":"24 | 请求是怎么被处理的？","id":110482}},"comments":[{"had_liked":false,"id":118010,"user_name":"你好旅行者","can_delete":false,"product_type":"c1","uid":1154101,"ip_address":"","ucode":"5C72A428DC28F3","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg","comment_is_top":false,"comment_ctime":1564212189,"is_pvip":false,"discussion_count":19,"race_medal":0,"score":"800428129245","product_id":100029201,"comment_content":"老师讲的很好，我做一些补充吧。<br><br>Kafka在启动的时候会开启两个任务，一个任务用来定期地检查是否需要缩减或者扩大ISR集合，这个周期是replica.lag.time.max.ms的一半，默认5000ms。当检测到ISR集合中有失效副本时，就会收缩ISR集合，当检查到有Follower的HighWatermark追赶上Leader时，就会扩充ISR。<br><br>除此之外，当ISR集合发生变更的时候还会将变更后的记录缓存到isrChangeSet中，另外一个任务会周期性地检查这个Set,如果发现这个Set中有ISR集合的变更记录，那么它会在zk中持久化一个节点。然后因为Controllr在这个节点的路径上注册了一个Watcher，所以它就能够感知到ISR的变化，并向它所管理的broker发送更新元数据的请求。最后删除该路径下已经处理过的节点。<br><br>此外，在0.9X版本之前，Kafka中还有另外一个参数replica.lag.max.messages，它也是用来判定失效副本的，当一个副本滞后leader副本的消息数超过这个参数的大小时，则判定它处于同步失效的状态。它与replica.lag.time.max.ms参数判定出的失效副本取并集组成一个失效副本集合。<br><br>不过这个参数本身很难给出一个合适的值。以默认的值4000为例，对于消息流入速度很低的主题（比如TPS为10），这个参数就没什么用；对于消息流入速度很高的主题（比如TPS为2000），这个参数的取值又会引入ISR的频繁变动。所以从0.9x版本开始，Kafka就彻底移除了这一个参数。<br>","like_count":187,"discussions":[{"author":{"id":2148214,"avatar":"https://static001.geekbang.org/account/avatar/00/20/c7/76/9c6dc09c.jpg","nickname":"say goodbye","note":"","ucode":"51A88796DD77CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376054,"discussion_content":"nice","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621944001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2577451,"avatar":"","nickname":"Geek_9c6c3e","note":"","ucode":"F3B71465B25BC6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372316,"discussion_content":"m","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1620285660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2237298,"avatar":"https://static001.geekbang.org/account/avatar/00/22/23/72/8397b85e.jpg","nickname":"hanna","note":"","ucode":"E60EEA9D4BFAC8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351342,"discussion_content":"mark","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1614251531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300568,"discussion_content":"牛逼+插眼","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598174538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544221,"discussion_content":"厉害，学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641442928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264707,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4c/43/150c70c2.jpg","nickname":"陈松Plus","note":"","ucode":"0074BDECFA3D1D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534351,"discussion_content":"mk","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638169986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2550743,"avatar":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","nickname":"if...else...","note":"","ucode":"D0565908C99695","race_medal":4,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387058,"discussion_content":"厉害","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627965789,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1473410,"avatar":"https://static001.geekbang.org/account/avatar/00/16/7b/82/8c94d342.jpg","nickname":"瞌睡","note":"","ucode":"48E50A6F194602","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350960,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614082621,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330840,"discussion_content":"顶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606719977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1695382,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLJiaPZmuibaYlicRJzS0iaeHcVJ9N8F00fsXicdlcJNZia7C0NtQ66ICUXr4Wb7RELcKMiaJUGpibhHF1axA/132","nickname":"北城以北","note":"","ucode":"A8B6CB18EBA58C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329918,"discussion_content":"插眼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606481750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2034980,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/9dTx3AVia8Lbx2iaP3dibFvoic99ODDENbp5TAfQOuD4co82C1BzNjU3Uobcqc1CZ3e58qzd3bia0vibt6M0llxRWqicQ/132","nickname":"Geek_f24e8e","note":"","ucode":"D7891CA6847189","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327520,"discussion_content":"不错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605855561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1412121,"avatar":"https://static001.geekbang.org/account/avatar/00/15/8c/19/870c8992.jpg","nickname":"BitbIt","note":"","ucode":"418AB6E264E396","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":308006,"discussion_content":"插眼？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600825023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1107907,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e7/c3/41c0c47d.jpg","nickname":"lcy","note":"","ucode":"B709AF38B68E53","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298943,"discussion_content":"插个眼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597485254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1059944,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2c/68/c299bc71.jpg","nickname":"天敌","note":"","ucode":"CD29A622197197","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298007,"discussion_content":"插个眼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597143221,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1148234,"avatar":"https://static001.geekbang.org/account/avatar/00/11/85/4a/7f179df5.jpg","nickname":".","note":"","ucode":"7A3BB96F66CD17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296909,"discussion_content":"插个眼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596703245,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1682027,"avatar":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","nickname":"对与错","note":"","ucode":"EF55733E3BD78B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293299,"discussion_content":"牛逼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595500742,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1984457,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/47/c9/1bf79dfa.jpg","nickname":"噜噜噜","note":"","ucode":"B37C2CD3B836DB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291842,"discussion_content":"查验","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594971357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282911,"discussion_content":"插眼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592117109,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1699383,"avatar":"https://static001.geekbang.org/account/avatar/00/19/ee/37/f17451cc.jpg","nickname":"Kong","note":"","ucode":"713F121F1CF103","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":36379,"discussion_content":"插个眼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571370973,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":273996,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1610783530,"is_pvip":false,"replies":[{"id":"99936","content":"嗯，是的。你的解释更精准:)","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1611540212,"ip_address":"","comment_id":273996,"utype":1}],"discussion_count":4,"race_medal":0,"score":"164819540778","product_id":100029201,"comment_content":"replica.lag.time.max.ms，感觉老师对这个参数的解释有歧义。<br><br>应该是如果leader发现flower超过这个参数所设置的时间没有向它发起fech请求（也就是复制请求），那么leader考虑将这个flower从ISR移除。<br>而不是连续落后这么长时间","like_count":39,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513887,"discussion_content":"嗯，是的。你的解释更精准:)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611540212,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1227840,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/40/2279cfb5.jpg","nickname":"大力水手Jerry","note":"","ucode":"E4A6C71E275DB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376221,"discussion_content":"kafka最新的文档是这样解释的“Configuration parameter replica.lag.time.max.ms now refers not just to the time passed since last fetch request from replica, but also to time since the replica last caught up. Replicas that are still fetching messages from leaders but did not catch up to the latest messages in replica.lag.time.max.ms will be considered out of sync.”包含了两种情况","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1622023719,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2109853,"avatar":"","nickname":"beifengzhishen001","note":"","ucode":"77D42B7DD9E754","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362597,"discussion_content":"棒，我翻了这么多评论，终于看到有说明这个参数含义的了，我也一直有疑惑到底该怎么理解这个参数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616989581,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348198,"discussion_content":"这个解释感觉更清楚呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612454780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119763,"user_name":"Mick","can_delete":false,"product_type":"c1","uid":1391216,"ip_address":"","ucode":"5CCE3E2BDB110A","user_header":"https://static001.geekbang.org/account/avatar/00/15/3a/70/a874d69c.jpg","comment_is_top":false,"comment_ctime":1564675697,"is_pvip":false,"replies":[{"id":"43961","content":"一个分区有3个副本，一个leader，2个follower。producer向leader写了10条消息，follower1从leader处拷贝了5条消息，follower2从leader处拷贝了3条消息，那么leader副本的LEO就是10，HW=3；follower1副本的LEO是5。这样说清楚些吗","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564707864,"ip_address":"","comment_id":119763,"utype":1}],"discussion_count":8,"race_medal":0,"score":"117528792689","product_id":100029201,"comment_content":"老师，LEO和HW这两个概念不理解，能不能详细说下，谢谢","like_count":28,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461062,"discussion_content":"一个分区有3个副本，一个leader，2个follower。producer向leader写了10条消息，follower1从leader处拷贝了5条消息，follower2从leader处拷贝了3条消息，那么leader副本的LEO就是10，HW=3；follower1副本的LEO是5。这样说清楚些吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564707864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1759325,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","nickname":"杯莫停","note":"","ucode":"4FA1D5CBBEF702","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301424,"discussion_content":"LEO其实就是破桶的最长那块板子，HW就那块短板。水装了多少 都是短板决定的。","likes_number":17,"is_delete":false,"is_hidden":false,"ctime":1598522380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347629,"discussion_content":"https://juejin.cn/post/6844903960768151566这篇文章说的很清楚，小伙伴们可以看看","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1612267660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1326004,"avatar":"","nickname":"Grocker","note":"","ucode":"CFF2E493AE83DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":573526,"discussion_content":"404了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653472986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":347629,"ip_address":""},"score":573526,"extra":""}]},{"author":{"id":1247574,"avatar":"https://static001.geekbang.org/account/avatar/00/13/09/56/2628852c.jpg","nickname":"星之所在","note":"","ucode":"03ADB0ADD5FC27","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":265189,"discussion_content":"这样很清晰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589379061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099929,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c8/99/22d2a6a7.jpg","nickname":"张伯毅","note":"","ucode":"E9EAF5ECFE32C7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":104549,"discussion_content":"LEO和HW 的英文全拼是啥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577440531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1325678,"avatar":"https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg","nickname":"大坏狐狸","note":"","ucode":"5044F89A505C5B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1099929,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c8/99/22d2a6a7.jpg","nickname":"张伯毅","note":"","ucode":"E9EAF5ECFE32C7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":206744,"discussion_content":"Log end offset  High watermark","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1584436721,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":104549,"ip_address":""},"score":206744,"extra":""}]},{"author":{"id":1391216,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3a/70/a874d69c.jpg","nickname":"Mick","note":"","ucode":"5CCE3E2BDB110A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3870,"discussion_content":"谢谢，老师，明白了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564902440,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119636,"user_name":"凯","can_delete":false,"product_type":"c1","uid":1109449,"ip_address":"","ucode":"E3F5993C2FDCB7","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/c9/57d571a3.jpg","comment_is_top":false,"comment_ctime":1564642823,"is_pvip":false,"replies":[{"id":"43968","content":"通过HW机制。leader处的HW要等所有follower LEO都越过了才会前移","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564707985,"ip_address":"","comment_id":119636,"utype":1}],"discussion_count":4,"race_medal":0,"score":"117528759815","product_id":100029201,"comment_content":"请问一下，producer生产消息ack=all的时候，消息是怎么保证到follower的，因为看到follower是异步拉取数据的，难道是看leader和follower上面的offset吗？","like_count":28,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460989,"discussion_content":"通过HW机制。leader处的HW要等所有follower LEO都越过了才会前移","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564707985,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348196,"discussion_content":"应该是比如producer向broker提交了三条消息，此时领导者副本的leo是10(新增的三条消息的offset是7、8、9)，假设有两个isr的追随者副本。\n时刻一:follwer1的leo是8，follwer2的leo是9，那么此时HW是8，HW<10,等待\n时刻二:follwer2的leo是10，follwer的leo是10，那么此时HW是10，HW>=10，满足条件，返回客户端","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1612454048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1035562,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/cd/2a/bdbed6ed.jpg","nickname":"无菇朋友","note":"","ucode":"80482C5F0464A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4148,"discussion_content":"老师，是不是就是说leader的HW必须要在多一轮的fetch请求里才能被更新，而只有HW更新了才能表示在acks=all的情况下，消息写入成功？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565167781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1035562,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/cd/2a/bdbed6ed.jpg","nickname":"无菇朋友","note":"","ucode":"80482C5F0464A3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390370,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629804907,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":4148,"ip_address":""},"score":390370,"extra":""}]}]},{"had_liked":false,"id":162133,"user_name":"ideal sail","can_delete":false,"product_type":"c1","uid":1098870,"ip_address":"","ucode":"38E1C7DE8964DF","user_header":"https://static001.geekbang.org/account/avatar/00/10/c4/76/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1576465401,"is_pvip":false,"replies":[{"id":"61791","content":"Producer端认为消息已经成功提交的条件是：ISR中所有副本都已经保存了该消息，但producer并没有指定ISR中需要几个副本。这就是min.insync.replicas参数的作用。<br><br>正常情况下，如果5个副本都在ISR中，那么它们必须都同步才行，但如果4个副本不在ISR中了，不满足min.insync.replicas了，此时broker会抛出异常给producer，告诉producer这条消息无法正确保存","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1576544409,"ip_address":"","comment_id":162133,"utype":1}],"discussion_count":3,"race_medal":0,"score":"108950647801","product_id":100029201,"comment_content":"老师，假设一个分区有5个副本，Broker的min.insync.replicas设置为2，生产者设置acks=all，这时是有2个副本同步了就可以，还是必须是5个副本都同步，他们是什么关系。","like_count":24,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477962,"discussion_content":"Producer端认为消息已经成功提交的条件是：ISR中所有副本都已经保存了该消息，但producer并没有指定ISR中需要几个副本。这就是min.insync.replicas参数的作用。\n\n正常情况下，如果5个副本都在ISR中，那么它们必须都同步才行，但如果4个副本不在ISR中了，不满足min.insync.replicas了，此时broker会抛出异常给producer，告诉producer这条消息无法正确保存","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1576544409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300589,"discussion_content":"min.insync.replicas=2，acks=0/1，producer会发送成功还是失败呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598185039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390371,"discussion_content":"acks是0和1的时候，前面那个设置已经没有作用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629805067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300589,"ip_address":""},"score":390371,"extra":""}]}]},{"had_liked":false,"id":203657,"user_name":"咸淡一首诗","can_delete":false,"product_type":"c1","uid":1435869,"ip_address":"","ucode":"FEE5A9B5139BF1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLl9nj9b6RydKADq82ZwOad0fQcvXWyQKk5U5RFC2kzHGI4GjIQsIZvHsEm7mFELgMiaGx3lGq9vag/132","comment_is_top":false,"comment_ctime":1586248803,"is_pvip":false,"replies":[{"id":"76201","content":"follower从leader拿到消息后会更新一个名为_lastCaughtUpTimeMs的字段。每当要检查follower是否out of ISR时就会用当前时间减去这个字段值去和replica.lag.time.max.ms 比较","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1586306113,"ip_address":"","comment_id":203657,"utype":1}],"discussion_count":3,"race_medal":0,"score":"83190627427","product_id":100029201,"comment_content":"老师，“这个标准就是 Broker 端参数 replica.lag.time.max.ms 参数值。这个参数的含义是 Follower 副本能够落后 Leader 副本的最长时间间隔，当前默认值是 10 秒” 这句话中的最长时间间隔是怎么计算的，以什么时间为基准？","like_count":20,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490922,"discussion_content":"follower从leader拿到消息后会更新一个名为_lastCaughtUpTimeMs的字段。每当要检查follower是否out of ISR时就会用当前时间减去这个字段值去和replica.lag.time.max.ms 比较","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586306113,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1904626,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0f/f2/3f3c0946.jpg","nickname":"美好时光海苔","note":"","ucode":"CD4637BFC8A7C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375584,"discussion_content":"我觉得英文原文讲的很清晰： If a follower hasn&#39;t sent any fetch requests or hasn&#39;t consumed up to the leaders log end offset for at least this time, the leader will remove the follower from isr。reference：https://docs.confluent.io/platform/current/installation/configuration/broker-configs.html","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1621754888,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300590,"discussion_content":"是不是只有follower从leader拿到LEO才会更新_lastCaughtUpTimeMs？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598185700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":162177,"user_name":"曹伟雄","can_delete":false,"product_type":"c1","uid":1400754,"ip_address":"","ucode":"9740E426C0742C","user_header":"https://static001.geekbang.org/account/avatar/00/15/5f/b2/c4780c10.jpg","comment_is_top":false,"comment_ctime":1576471657,"is_pvip":false,"replies":[{"id":"61790","content":"试试到ZooKeeper中手动删除&#47;controller节点。这通常都是因为Controller与ZooKeeper状态不同步导致的。<br><br>试试这个命令吧： rmr &#47;controller<br><br>确保在业务低峰时刻执行这个命令","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1576544275,"ip_address":"","comment_id":162177,"utype":1}],"discussion_count":2,"race_medal":0,"score":"61706013801","product_id":100029201,"comment_content":"老师你好，有个问题请教一下，麻烦抽空看看，谢谢。<br>生产环境，因磁盘满了，所有broker宕机了，重启集群后，主题中的部分分区中，有1个副本被踢出ISR集合，只剩下leader副本了。<br><br>试了以下几种方法都没有自动加入进来：<br>1、等了3天后还是没有加入到ISR；<br>2、然后重启kafka集群；<br>3、用kafka-reassign-partitions.sh命令重新分配分区；<br><br>针对此情况，请问一下有什么办法让它自动加入进来？  或者手工处理加入进来也可以。<br>有什么命令可以查看follower落后多少吗？  麻烦老师给点建议或解决思路，谢谢。","like_count":15,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477976,"discussion_content":"试试到ZooKeeper中手动删除/controller节点。这通常都是因为Controller与ZooKeeper状态不同步导致的。\n\n试试这个命令吧： rmr /controller\n\n确保在业务低峰时刻执行这个命令","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576544275,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1500785,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e6/71/491dcad1.jpg","nickname":"南瓜","note":"","ucode":"A3828CEC6257CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575087,"discussion_content":"controller和zookeeper是什么状态不同步导致的呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654588349,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149020,"user_name":"注定非凡","can_delete":false,"product_type":"c1","uid":1113597,"ip_address":"","ucode":"80673056E131B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg","comment_is_top":false,"comment_ctime":1573128109,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"57407702957","product_id":100029201,"comment_content":"1 副本机制的定义：所谓副本机制（Replication），也可以称之为备份机制，通常是指分布式在多台网络互连的机器上保存有相同的数据拷贝。\t<br>2 副本机制的价值：A ：提供数据冗余 B ：提供高伸缩性 C ：改善数据局部性<br>但 Kafka的副本机制，只实现了提供数据冗余的价值。<br>\t<br>3 副本定义：<br>A ：Kafka有主题的概念，每个主题又分为若干个分区。副本的概念是在分区层级下定义的，每个分区配置有若干个副本。<br>B ：所谓副本（Replica），本质是一个只能追加写消息的提交日志。<br>   根据Kafka副本机制的定义，同一个分区下的所有副本保存有相同的消息序列，这些副本分散保存在不同的Broker上，从而能够对抗部分Broker宕机带来的数据不可用。<br>\t<br>4 副本角色：<br>A ：为解决分区下多个副本的内容一致性问题，常用方案就是采用基于领导者的副本机制。<br>B ：在kafka中，副本分两类：领导者副本和追随者副本。每个分区在创建时都选举一个副本，称为领导者副本，其余的副本自动成为追随者副本。<br>C ：Kafka的副本机制比其他分布式系统严格。Kafka的追随者副本不对外提供服务。所有的请求都要由领导者副本处理。追随者副本唯一的任务就是从领导者副本异步拉取消息，并写入到自己的提交日志中，从而实现与领导者副本的同步。<br>D ：当领导者副本所在Broker宕机了，Kafka依托于Zookeeper提供的监控功能能够实时感知到，并立即开启新一轮的领导者选举，从追随者副本中选一个新的领导者。当老的Leader副本重启回来后，只能作为追随者副本加入到集群中。<br><br>4 Kafka副本机制的优点：<br>A ：方便实现“Read-your-writes”<br>（1）含义：当使用生产者API向Kafka成功写入消息后，马上使用消息者API去读取刚才生产的消息。<br>（2）如果允许追随者副本对外提供服务，由于副本同步是异步的，就可能因为数据同步时间差，从而使客户端看不到最新写入的消息。\t<br>B ：方便实现单调读（Monotonic Reads）<br>（1）单调读：对于一个消费者用户而言，在多处消息消息时，他不会看到某条消息一会存在，一会不存在。<br>（2）如果允许追随者副本提供读服务，由于消息是异步的，则多个追随者副本的状态可能不一致。若客户端每次命中的副本不同，就可能出现一条消息一会看到，一会看不到。<br>\t<br>5 In-sync Replicas（ISR）同步副本<br>A ：追随者副本定期的异步拉取领导者副本中的数据，这存在不能和Leader实时同步的风险。<br>B ：Kafka引入了In-sync Replicas。ISR中的副本都是于Leader同步的副本，相反，不在ISR中的追随者副本就是被认为是与Leader不同步的。<br>C ：Leader 副本天然就在ISR中，即ISR不只是追随者副本集合，他必然包括Leader副本。甚至某些情况下，ISR只有Leade这一个副本。<br>D ：follower副本是否与leader同步的判断标准取决于Broker端参数 replica.lag.time.max.ms参数值。默认为10秒，只要一个Follower副本落后Leader副本的时间不连续超过10秒，那么Kafka就认为该Follower副本与leader是同步的，即使此时Follower副本中保存的消息明显小于Leader副本中的消息。<br>E ：如果同步过程持续慢于Leader副本消息的写入速度，那么replica.lag.time.max.ms时间后，此Follower副本就会被认为是与Leader副本不同步的，因此不能再放入ISR中。此时，kafka会自动收缩ISR的进度，将该副本“踢出”ISR。ISR是一个动态调整的集合，而非静态不变的。<br><br>6 Unclean 领导者选举（Unclean Leader Election）<br>\tA ：ISR是可以动态调整的，所以会出现ISR为空的情况，由于Leader副本天然就在ISR中，如果ISR为空了，这说明Leader副本也挂掉了，Kafka需要重新选举一个新的Leader。<br>\tB ：Kafka把所有不在ISR中的存活副本都会称为非同步副本。通常，非同步副本落后Leader太多，如果让这些副本做为新的Leader，就可能出现数据的丢失。在kafka中，选举这种副本的过程称为Unclean领导者选举。<br>\tC ：Broker端参数unclean.leader.election.enable 控制是否允许Unclean领导者选举。开启Unclean领导者选举可能会造成数据丢失，但它使得分区Leader副本一直存在，不至于停止对外提供服务，因此提升了高可用性。禁止Unclean领导者选举的好处是在于维护了数据的一致性，避免了消息丢失，但牺牲了高可用性。","like_count":14,"discussions":[{"author":{"id":1169147,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d6/fb/837af7bf.jpg","nickname":"董永刚","note":"","ucode":"ADA792B226A6CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544151,"discussion_content":"每次我都会把你的总结单独保存，总结的非常精炼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641430377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1811696,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a4/f0/ef99cc29.jpg","nickname":"陈珍旭","note":"","ucode":"A2419FB7ACE71A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312524,"discussion_content":"兄弟，总结做到很到位。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602728437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139852,"user_name":"云师兄","can_delete":false,"product_type":"c1","uid":1010459,"ip_address":"","ucode":"4475AF1598FBFD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg","comment_is_top":false,"comment_ctime":1570756632,"is_pvip":false,"replies":[{"id":"54019","content":"不会阻塞，你可以认为是不断轮询状态","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1570764309,"ip_address":"","comment_id":139852,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44520429592","product_id":100029201,"comment_content":"ack=all时候，生产者向leader发送完数据，而副本是异步拉取的，那生产者写入线程要一直阻塞等待吗","like_count":11,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470142,"discussion_content":"不会阻塞，你可以认为是不断轮询状态","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570764309,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187334,"user_name":"Cv","can_delete":false,"product_type":"c1","uid":1062797,"ip_address":"","ucode":"C77CE172B5AA28","user_header":"","comment_is_top":false,"comment_ctime":1584086055,"is_pvip":false,"replies":[{"id":"72307","content":"会的，回调中会包含对应的错误码","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1584091812,"ip_address":"","comment_id":187334,"utype":1}],"discussion_count":2,"race_medal":0,"score":"35943824423","product_id":100029201,"comment_content":"生产者acks=all使用异步提交, 如果ISR副本迟迟不能完成从leader的同步, 那么10s过后, 生产者会收到提交失败的回调吗? 还是一直不会有回调","like_count":9,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487079,"discussion_content":"会的，回调中会包含对应的错误码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584091812,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1194684,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3a/bc/d4bd1b00.jpg","nickname":"coderzc","note":"","ucode":"595748485D4475","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335004,"discussion_content":"这种情况下leader会删除掉已经写入的数据吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1608047125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205850,"user_name":"李先生","can_delete":false,"product_type":"c1","uid":1237614,"ip_address":"","ucode":"D9039715F7D290","user_header":"https://static001.geekbang.org/account/avatar/00/12/e2/6e/0a300829.jpg","comment_is_top":false,"comment_ctime":1586746989,"is_pvip":false,"replies":[{"id":"76934","content":"目前选举leader的算法很简单，一般是选择AR中第一个处在ISR集合的副本为leader。比如AR的副本顺序是[1,2,3]，ISR是[2,3]，那么副本2就是leader","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1586763996,"ip_address":"","comment_id":205850,"utype":1}],"discussion_count":3,"race_medal":0,"score":"31651518061","product_id":100029201,"comment_content":"胡哥：分区选举leader，是通过抢占模式来选举的。如果不开启unclean.leader.election.enable，是只能isr集合中的broker才能竞争吗？这个竞争的过程能具体说下是如何实现的吗？","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491600,"discussion_content":"目前选举leader的算法很简单，一般是选择AR中第一个处在ISR集合的副本为leader。比如AR的副本顺序是[1,2,3]，ISR是[2,3]，那么副本2就是leader","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586763996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1304325,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e7/05/89de9611.jpg","nickname":"李正洋","note":"","ucode":"675C372A8FC26B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348909,"discussion_content":"老师好，AR是什么？副本顺序是根据什么定义的？先进就在前，还是跟leader信息最接近的在前？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612773225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1304325,"avatar":"https://static001.geekbang.org/account/avatar/00/13/e7/05/89de9611.jpg","nickname":"李正洋","note":"","ucode":"675C372A8FC26B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379980,"discussion_content":"all replica","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624268517,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":348909,"ip_address":""},"score":379980,"extra":""}]}]},{"had_liked":false,"id":136145,"user_name":"LJK","can_delete":false,"product_type":"c1","uid":1199213,"ip_address":"","ucode":"12B2441099FF1D","user_header":"https://static001.geekbang.org/account/avatar/00/12/4c/6d/c20f2d5a.jpg","comment_is_top":false,"comment_ctime":1569373315,"is_pvip":false,"replies":[{"id":"52219","content":"ISR中的follower副本非常有可能与leader不一致的。如果leader挂了，其他follower又都没有保存该消息，那么该消息是可能丢失的。如果你要避免这种情况，设置producer端的acks=all吧","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1569409817,"ip_address":"","comment_id":136145,"utype":1}],"discussion_count":5,"race_medal":0,"score":"31634144387","product_id":100029201,"comment_content":"老师好，请问ISR中的副本一定可以保证和leader副本的一致性吗？如果有一种情况是某个ISR中副本与leader副本的lag在ISR判断的边界值，这时如果leader副本挂了的话，还是会有数据丢失是吗？谢谢老师","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468480,"discussion_content":"ISR中的follower副本非常有可能与leader不一致的。如果leader挂了，其他follower又都没有保存该消息，那么该消息是可能丢失的。如果你要避免这种情况，设置producer端的acks=all吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569409817,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1861000,"avatar":"","nickname":"肖恒","note":"","ucode":"50B1118691B222","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361314,"discussion_content":"设置成 acks=all 也不一定能解决这个问题吧？比如 ISR 集合中有两个副本，一个 leader，一个 follower，此时follower 落后 leader 2s，如果 leader 刚写入了一条数据，此时 leader 宕机，会丢失数据吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616640698,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1001825,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/49/61/abb7bfe3.jpg","nickname":"招耳","note":"","ucode":"D163E1A6377CF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1861000,"avatar":"","nickname":"肖恒","note":"","ucode":"50B1118691B222","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362355,"discussion_content":"落后2s应该是允许改副本在isr里面，但是还得必须最后得追赶上写入那条信息才算真正写入成功吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616927853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":361314,"ip_address":""},"score":362355,"extra":""},{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1861000,"avatar":"","nickname":"肖恒","note":"","ucode":"50B1118691B222","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390373,"discussion_content":"\n先去看看acks = 1 的定义好吗，设置了这个，isr里面的follower 就和 leader 副本一模一样","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1629806027,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":361314,"ip_address":""},"score":390373,"extra":""}]},{"author":{"id":1176917,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f5/55/5ba20e79.jpg","nickname":"不忘初心丶方得始终","note":"","ucode":"2D16DBA695D347","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":219024,"discussion_content":"老师你好问一下……我们在没有重启应用的前提下更改了不存在的topic然后看到消息被消费了……但是后台没有日志……而且消费端正常……不只是什么原因","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585724990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172837,"user_name":"陈国林","can_delete":false,"product_type":"c1","uid":1438037,"ip_address":"","ucode":"83D12F3E79F197","user_header":"https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg","comment_is_top":false,"comment_ctime":1579330940,"is_pvip":false,"replies":[{"id":"67065","content":"初衷是好的。难点在于我们如何区分什么数据是新的什么是老的：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1579393906,"ip_address":"","comment_id":172837,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23054167420","product_id":100029201,"comment_content":"老师好，我觉得是否可以这样分场景。对于读新的数据可以从 leader replica 读取，对于老一些的数据从follower replica 读取，这样不懂是否可行","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481873,"discussion_content":"初衷是好的。难点在于我们如何区分什么数据是新的什么是老的：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579393906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":132466,"user_name":"不能扮演天使","can_delete":false,"product_type":"c1","uid":1046172,"ip_address":"","ucode":"9922330BFF7FFB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/9c/b457a937.jpg","comment_is_top":false,"comment_ctime":1568127912,"is_pvip":false,"replies":[{"id":"50676","content":"acks=all保证ISR中的所有副本都要同步","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1568162079,"ip_address":"","comment_id":132466,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23042964392","product_id":100029201,"comment_content":"老师，ack=all,是保证ISR中的follower同步还是所有的follower同步，还有消费者是只能消费到ISR中的HW处的offset么？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466953,"discussion_content":"acks=all保证ISR中的所有副本都要同步","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568162079,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117289,"user_name":"球球","can_delete":false,"product_type":"c1","uid":1008759,"ip_address":"","ucode":"E5BD53B7E648D2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/64/77/ce921ed4.jpg","comment_is_top":false,"comment_ctime":1564019147,"is_pvip":false,"replies":[{"id":"43015","content":"不会丢失。还是那句话：Kafka只对已提交消息做持久化保证。如果你设置了最高等级的持久化需求（比如acks=all），那么follower副本没有同步完成前这条消息就不算已提交，也就不算丢失了。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564062307,"ip_address":"","comment_id":117289,"utype":1}],"discussion_count":4,"race_medal":0,"score":"23038855627","product_id":100029201,"comment_content":"胡夕老师好，replica.lag.time.max.ms配置follower是否处于isr中，那么是否存在，在这个时间段内数据写完leader，follower还没有完全同步leader数据，leader宕机，isr中follower提升为新leader，那这一部分数据是否就丢失呢？该如何避免呢？谢谢","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459900,"discussion_content":"不会丢失。还是那句话：Kafka只对已提交消息做持久化保证。如果你设置了最高等级的持久化需求（比如acks=all），那么follower副本没有同步完成前这条消息就不算已提交，也就不算丢失了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564062307,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1306315,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ee/cb/4bd24e0f.jpg","nickname":"官人","note":"","ucode":"ECEF55B08E252B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377190,"discussion_content":"ISR 中除了leader其他都挂掉了 这时候leader写入是不是直接就提交了？ 如果是的话是不是还会丢失.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622541846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1257852,"avatar":"https://static001.geekbang.org/account/avatar/00/13/31/7c/14df0dbf.jpg","nickname":"mellow","note":"","ucode":"C44F0A588263C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2895,"discussion_content":"producer 客户端有一个ack的参数，我没记错的话","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564024288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1008759,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/64/77/ce921ed4.jpg","nickname":"球球","note":"","ucode":"E5BD53B7E648D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1257852,"avatar":"https://static001.geekbang.org/account/avatar/00/13/31/7c/14df0dbf.jpg","nickname":"mellow","note":"","ucode":"C44F0A588263C6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2902,"discussion_content":"嗯嗯明白了谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564027101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":2895,"ip_address":""},"score":2902,"extra":""}]}]},{"had_liked":false,"id":117223,"user_name":"刘彬","can_delete":false,"product_type":"c1","uid":1053307,"ip_address":"","ucode":"D18611F7FFF2A8","user_header":"https://static001.geekbang.org/account/avatar/00/10/12/7b/456e46f2.jpg","comment_is_top":false,"comment_ctime":1564012451,"is_pvip":true,"replies":[{"id":"42902","content":"1. 通过比较follower和leader的最新消息位移或末端消息位移（Log End Offset, LEO）<br>2. 嗯，就一直少一个副本了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564016073,"ip_address":"","comment_id":117223,"utype":1}],"discussion_count":4,"race_medal":0,"score":"23038848931","product_id":100029201,"comment_content":"老师好，想请教您两个问题，如下：<br>如果某个follower副本同步持续慢于leader副本写入速度，repkica.lag.time.max.ms 是对于二者的同步时间做的判断，我理解就是如果一直检查10s follower都赶不上leader副本的进度！<br>但是，这个同步进度是用哪一块进行判别的呢？是通过index值吗？<br>另外，如果某个follower不在ISR中了，kafka如果维持副本数均衡呢？比如设置了副本数为3，其中一个副本不在ISR集合中了，那么就一直少了一个副本吗？前提是这个副本一直没有跟上leader的同步进度！<br>谢谢！<br>","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459868,"discussion_content":"1. 通过比较follower和leader的最新消息位移或末端消息位移（Log End Offset, LEO）\n2. 嗯，就一直少一个副本了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564016073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1480717,"avatar":"https://static001.geekbang.org/account/avatar/00/16/98/0d/fb77a32c.jpg","nickname":"Tim","note":"","ucode":"3AAA9FD3D8DDDB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":22481,"discussion_content":"老师请问：\n1、它要比较的是Follower 副本落后 Leader 副本的时间是否超过10秒，那这个10s这个时间单位和LEO/HW这种度量单位是如何比较的呢？\n2、老师，follow副本是何时fetch一次leader的呢，多久fetch一次呢？有配置么？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1569644511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1480717,"avatar":"https://static001.geekbang.org/account/avatar/00/16/98/0d/fb77a32c.jpg","nickname":"Tim","note":"","ucode":"3AAA9FD3D8DDDB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553537,"discussion_content":"1. leo是用来判断日志是否同步成功的，比如现在leader副本leo是10，但是replica 1的leo是6，则认为replica还没同步最新消息成功，此时认为acks数量不会加1，会继续定时轮训isr中各个副本的leo值，直到acks数量满足了才会返回成功给客户端。\n2. replica.lag.time.max.ms 是为了表示follower replica 是否与leader副本同步差距太大，如果同步时延超过这个数，会把这个replica从isr中移除。 这个是通过定时任务做的，做法是，维持一个变量(假设为t1)，replica每次fetch消息时都会更新这个变量。定时任务会将 system.current time mill is - t1 与 replica.lag.time.max.ms 作比较，大于则认为延时过大，会从isr 集合中移除。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645956054,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":22481,"ip_address":""},"score":553537,"extra":""}]},{"author":{"id":1348830,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/SM4fwn9uFicXU8cQ1rNF2LQdKNbZI1FX1jmdwaE2MTrBawbugj4TQKjMKWG0sGbmqQickyARXZFS8NZtobvoWTHA/132","nickname":"td901105","note":"","ucode":"32D42A4F36FA02","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":133814,"discussion_content":"求回复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1578992359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118190,"user_name":"外星人","can_delete":false,"product_type":"c1","uid":1132861,"ip_address":"","ucode":"D8469B13F2AB37","user_header":"https://static001.geekbang.org/account/avatar/00/11/49/3d/4ac37cc2.jpg","comment_is_top":false,"comment_ctime":1564285423,"is_pvip":false,"replies":[{"id":"43350","content":"增加副本数：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564361674,"ip_address":"","comment_id":118190,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18744154607","product_id":100029201,"comment_content":"请问，关闭unclean后，有哪些方法可以保证available啊？谢谢","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460293,"discussion_content":"增加副本数：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564361674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1132861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/49/3d/4ac37cc2.jpg","nickname":"外星人","note":"","ucode":"D8469B13F2AB37","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3372,"discussion_content":"还有别的方法吗？期望有一期可以讲下常见问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564446524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263685,"user_name":"风","can_delete":false,"product_type":"c1","uid":1147929,"ip_address":"","ucode":"AFDBEFA49F269E","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","comment_is_top":false,"comment_ctime":1606217745,"is_pvip":true,"replies":[{"id":"95856","content":"是可能出现消息乱序的情形","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606440774,"ip_address":"","comment_id":263685,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14491119633","product_id":100029201,"comment_content":"ack=all时候，生产者向leader发送完数据，而副本是异步拉取的，那生产者写入线程要一直阻塞等待吗<br>老师这个问题您是说不会阻塞,可以认为是生产会不断地轮询状态<br>那是否可能存在发送了两条消息,可能导致后发送的先写入分区(设置max.in.flight.requests.per.connection),如果不可能的话,此时生产者是否处于阻塞模式,无法再次发送消息","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510270,"discussion_content":"是可能出现消息乱序的情形","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606440774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212796,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1588212125,"is_pvip":true,"replies":[{"id":"79134","content":"follower b leo追到1000时会更新一个时间戳。然后通过当前时间与这个时间戳的差值和10s进行判断<br>","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1588400607,"ip_address":"","comment_id":212796,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14473114013","product_id":100029201,"comment_content":"老师，请问以replica.lag.time.max.ms=10s为副本机制的判断依据，遇到以下场景的话，是如何解决？<br><br>比如 Leader-A LEO=1000  Follower-B LEO=800,  他们的差值是200， 那如何判断这200条消息是否会在10s内同步完？","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493612,"discussion_content":"follower b leo追到1000时会更新一个时间戳。然后通过当前时间与这个时间戳的差值和10s进行判断\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588400607,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187323,"user_name":"Cv","can_delete":false,"product_type":"c1","uid":1062797,"ip_address":"","ucode":"C77CE172B5AA28","user_header":"","comment_is_top":false,"comment_ctime":1584083305,"is_pvip":false,"replies":[{"id":"72308","content":"通常不需要。如果你在意这种情况，使用acks=all的producer吧","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1584091894,"ip_address":"","comment_id":187323,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14468985193","product_id":100029201,"comment_content":"ISR中的数据也会落后leader, 那么leader挂了之后的重新选举, 一样会造成数据丢失, 为了避免这种请问, 我们是否需要把replica.lag.time.max.ms设置为0呢?","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487072,"discussion_content":"通常不需要。如果你在意这种情况，使用acks=all的producer吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584091894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117306,"user_name":"lmtoo","can_delete":false,"product_type":"c1","uid":1133918,"ip_address":"","ucode":"FCD5B9C941D448","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","comment_is_top":false,"comment_ctime":1564020862,"is_pvip":false,"replies":[{"id":"43013","content":"指的是ISR中的所有副本","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564062183,"ip_address":"","comment_id":117306,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14448922750","product_id":100029201,"comment_content":"在“无消息丢失配置怎么实现？”中有两个配置项，acks=all这里的all是指所有的isr的副本还是所有的副本,如果是所有的副本，那副本同步都是通过拉取实现的，那这个等待时间就是最慢的那个副本了，也就是消费者端等待时间&gt;replica.lag.time.max.ms；min.insync.replicas这个参数是表示isr的最小副本数？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459905,"discussion_content":"指的是ISR中的所有副本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564062183,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142457,"user_name":"13761642169","can_delete":false,"product_type":"c1","uid":1232334,"ip_address":"","ucode":"68137695FC2120","user_header":"","comment_is_top":false,"comment_ctime":1571370960,"is_pvip":false,"replies":[{"id":"55215","content":"只能把r2启动起来了，而且有可能出现数据丢失。因为Kafka承诺不丢消息也是有条件的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1571616262,"ip_address":"","comment_id":142457,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10161305552","product_id":100029201,"comment_content":"配置是 unclean.leader.election.enable=false<br>1个分区有2个副本，r1 和 r2，isr 中只有 r1，r1 所在机器崩溃后，并且日志数据也丢失了，这种情况怎样操作让分区恢复服务？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471134,"discussion_content":"只能把r2启动起来了，而且有可能出现数据丢失。因为Kafka承诺不丢消息也是有条件的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571616262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131051,"user_name":"giantbroom","can_delete":false,"product_type":"c1","uid":1059516,"ip_address":"","ucode":"7258784193C302","user_header":"","comment_is_top":false,"comment_ctime":1567610390,"is_pvip":true,"replies":[{"id":"49319","content":"1. 不是互斥的<br>2. 目前一旦出现partitioning，Kafka无法正常工作<br>3. 默认情况下是CP，即先保证一致性。不过还是那句话，CAP理论研究学习可以，用于指导分布式系统实践非常不合适。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567645289,"ip_address":"","comment_id":131051,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10157544982","product_id":100029201,"comment_content":"请教2个问题：<br>1. 之前介绍过副本的ack设置，0，1和all，以及设置最大写入副本的数量（具体参数名忘了）。这些设置(ack为1或all)跟unclean.leader.election.enable在语义上是不是互斥的？<br>2. 在设置ack为1或all的情况下，如果发生网络分区，使得ack的条件不满足，kafka会怎么处理？<br>3. 在默认设置下，kafka是AP还是CP？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466265,"discussion_content":"1. 不是互斥的\n2. 目前一旦出现partitioning，Kafka无法正常工作\n3. 默认情况下是CP，即先保证一致性。不过还是那句话，CAP理论研究学习可以，用于指导分布式系统实践非常不合适。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567645289,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118623,"user_name":"木卫六","can_delete":false,"product_type":"c1","uid":1199495,"ip_address":"","ucode":"D113DF578C5BF5","user_header":"https://static001.geekbang.org/account/avatar/00/12/4d/87/57236a2d.jpg","comment_is_top":false,"comment_ctime":1564399568,"is_pvip":true,"replies":[{"id":"43518","content":"是有这种可能，如果你在意这种情况producer端设置acks=all就可以避免了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564447682,"ip_address":"","comment_id":118623,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10154334160","product_id":100029201,"comment_content":"谢谢老师的讲解！<br>这里有两个问题想请教一下老师：<br>1.kafka使用replica.lag.max.time.ms来判断是否保留replica在ISR里，那么问题来了，在吞吐量较高的场景下，replica满足这个时间限制，但是LEO相差比较大，leader这时候挂掉，这个replica被选举为新leader，这个时候是不是有一部分数据丢失了？<br>2.如果问题1确实存在，目前是怎样处理的呢？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460491,"discussion_content":"是有这种可能，如果你在意这种情况producer端设置acks=all就可以避免了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564447682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117953,"user_name":"张学磊","can_delete":false,"product_type":"c1","uid":1250029,"ip_address":"","ucode":"F545F384A6F1E1","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eotSSnZic41tGkbflx0ogIg3ia6g2muFY1hCgosL2t3icZm7I8Ax1hcv1jNgr6vrZ53dpBuGhaoc6DKg/132","comment_is_top":false,"comment_ctime":1564197946,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10154132538","product_id":100029201,"comment_content":"个人觉得只所以使用消息队列进行异步处理就不会太关心消息处理的及时性，那当允许Follower副本对外提供读请求时，第一消费者可以降低读取消息的频率，给予Follower副本一定同步的时间，第二消费者在读取消息是优先读取Follower副本中的信息，如果读取不到再转到Leader副本中进行读取。","like_count":2,"discussions":[{"author":{"id":1488243,"avatar":"https://static001.geekbang.org/account/avatar/00/16/b5/73/15a8006a.jpg","nickname":"goxdev","note":"","ucode":"7374587CD08BEE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394030,"discussion_content":"有时候会关心消息的顺序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631693028,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269390,"user_name":"爱学习的小学生","can_delete":false,"product_type":"c1","uid":1413556,"ip_address":"","ucode":"040AB71F0394F2","user_header":"https://static001.geekbang.org/account/avatar/00/15/91/b4/d5d9e4fb.jpg","comment_is_top":false,"comment_ctime":1608630294,"is_pvip":false,"replies":[{"id":"97805","content":"取决于具体的配置，很难一概而论。我只能这么说，自1.0之后，只要是性能还okay的机器，单broker支持几千的分区是没问题的。当然这是社区的论断，一切依然以实际场景决定","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1608773036,"ip_address":"","comment_id":269390,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5903597590","product_id":100029201,"comment_content":"老师麻烦问一下，三台kafka分区配置多大比较合适！","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512257,"discussion_content":"取决于具体的配置，很难一概而论。我只能这么说，自1.0之后，只要是性能还okay的机器，单broker支持几千的分区是没问题的。当然这是社区的论断，一切依然以实际场景决定","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608773036,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264388,"user_name":"风","can_delete":false,"product_type":"c1","uid":1147929,"ip_address":"","ucode":"AFDBEFA49F269E","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","comment_is_top":false,"comment_ctime":1606453004,"is_pvip":true,"replies":[{"id":"96049","content":"1. 是可能出现重复的问题。Kafka不会把消息删除<br>2. 消息可能被封装进不同的请求从而被不同的broker线程处理，因此出现乱序","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606699257,"ip_address":"","comment_id":264388,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5901420300","product_id":100029201,"comment_content":"1、ack=all时,生产者向leader发送完数据,副本拉取失败,这样生产者持续轮询得到的结果是发送失败吗？如果是的话,生产者重发消息,是不是就可能存在两条一样的消息(就发送的内容而言，不考虑时间戳),还是说kafka内部有机制会把第一条消息删除？<br>2、原来问过老师一个问题：ack=all时候，生产者向leader发送完数据，而副本是异步拉取的，生产会不断地轮询状态<br>那是否可能存在发送了两条消息,可能导致后发送的先写入分区(设置max.in.flight.requests.per.connection),您的回答是可能出现乱序<br>这个我不太理解,第一条消息发送到leader后就已经占用了消息位移,再来一条消息不是会记录在后面吗？麻烦老师解释下,最好可以举例说明下什么场景下会发生乱序  谢谢<br>","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510548,"discussion_content":"1. 是可能出现重复的问题。Kafka不会把消息删除\n2. 消息可能被封装进不同的请求从而被不同的broker线程处理，因此出现乱序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606699257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140666,"user_name":"修愿三秋","can_delete":false,"product_type":"c1","uid":1014649,"ip_address":"","ucode":"0AEE445D8DBFF4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7b/79/df384bdc.jpg","comment_is_top":false,"comment_ctime":1571024272,"is_pvip":true,"replies":[{"id":"54554","content":"也不算丢数据，默认配置下如果ISR为空了，这个分区就不可用了，producer也无法向这个分区发送任何消息了。对于这种情况，Kafka不认为是丢数据","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1571104972,"ip_address":"","comment_id":140666,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5865991568","product_id":100029201,"comment_content":"老师你好，acks=all是保证isr列表中的副本同步，如果长时间的大吞吐量，致使isr中只剩下leader，那acks=all实际起到的效果就是只同步leader一个副本，如果此时leader挂掉，那是不是会丢数据？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470503,"discussion_content":"也不算丢数据，默认配置下如果ISR为空了，这个分区就不可用了，producer也无法向这个分区发送任何消息了。对于这种情况，Kafka不认为是丢数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571104972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099929,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c8/99/22d2a6a7.jpg","nickname":"张伯毅","note":"","ucode":"E9EAF5ECFE32C7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":104532,"discussion_content":"分区不可用,不就代表已经存放的数据无法访问到,那么是不是也等于丢数据.如果想要恢复的话,只能将不在 isr 中的副本恢复,这样貌似肯定会丢数据吧.","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577439846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":137360,"user_name":"Tim","can_delete":false,"product_type":"c1","uid":1480717,"ip_address":"","ucode":"3AAA9FD3D8DDDB","user_header":"https://static001.geekbang.org/account/avatar/00/16/98/0d/fb77a32c.jpg","comment_is_top":false,"comment_ctime":1569723835,"is_pvip":false,"replies":[{"id":"53473","content":"1. 比较follower LEO赶上leader LEO时的时间差是否超过了10s<br>2. 不停地fetch，然后处理，之后再fetch。具体间隔没法配置","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1570495759,"ip_address":"","comment_id":137360,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5864691131","product_id":100029201,"comment_content":"老师好，请教2个问题，感谢老师：<br>1、它要比较的是Follower 副本落后 Leader 副本的时间是否超过10秒，那这个10s这个时间单位和LEO&#47;HW这种度量单位是如何比较的呢？<br>2、老师，follow副本是何时fetch一次leader的呢，多久fetch一次呢？有配置么？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":469050,"discussion_content":"1. 比较follower LEO赶上leader LEO时的时间差是否超过了10s\n2. 不停地fetch，然后处理，之后再fetch。具体间隔没法配置","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570495759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1016232,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/81/a8/559afe8b.jpg","nickname":"Sruby","note":"","ucode":"A7D1B93F41DA0F","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":219392,"discussion_content":"比较follower LEO赶上leader LEO时的时间差是否超过了10s。\n请问leader如何判断follower赶上它的时间是否超过10s？\n以下是官方文档，意思是10s内follower没有发送任何请求给leader？\nreplica.lag.time.max.ms: If a follower hasn&#39;t sent any fetch requests or hasn&#39;t consumed up to the leaders log end offset for at least this time, the leader will remove the follower from isr","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585753216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135683,"user_name":"jc9090kkk","can_delete":false,"product_type":"c1","uid":1338831,"ip_address":"","ucode":"6C992D07A2E78F","user_header":"https://static001.geekbang.org/account/avatar/00/14/6d/cf/ec335526.jpg","comment_is_top":false,"comment_ctime":1569240121,"is_pvip":false,"replies":[{"id":"52070","content":"1. 计算follower的LEO落后leader LEO的时间<br>2. follower被踢出ISR不代表它有问题了，至少不表示它挂了，可能只是阶段性的落后leader。当追上后还是可以将其重新加入到ISR中的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1569294123,"ip_address":"","comment_id":135683,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5864207417","product_id":100029201,"comment_content":"感谢老师的分享，对于这一章节的内容有两个疑问，希望老师能抽时间回复下：<br>1.follower落后leader超过特定的时间，也就是超过replica.lag.time.max.ms的值，就会被踢出isr集合，那么这个时间差是如何算出来的，是通过LEO和HW计算出来的么？具体的计算细节能否简单介绍下？如果是落后特定的某个数据量阈值很容易理解，但是换成落后多少秒让我有点难以理解？<br>2.ISR集合是动态的，如果后面发现被踢出的follower又追上leader，还会重新回归到ISR集合，这个里面有个矛盾的点，把落后的follower踢出去后，我个人的理解，这个follower不就变成僵尸副本了吗？因为它不是任何一个leader的follower了呀，哪里还有机会继续从leader那同步数据，然后再重新回归到ISR集合中去呢？麻烦老师解答下，谢谢","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468300,"discussion_content":"1. 计算follower的LEO落后leader LEO的时间\n2. follower被踢出ISR不代表它有问题了，至少不表示它挂了，可能只是阶段性的落后leader。当追上后还是可以将其重新加入到ISR中的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569294123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133626,"user_name":"miwucc","can_delete":false,"product_type":"c1","uid":1326429,"ip_address":"","ucode":"7935BD907119AE","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/5d/ac666969.jpg","comment_is_top":false,"comment_ctime":1568624014,"is_pvip":false,"replies":[{"id":"51335","content":"不会啊。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1568678840,"ip_address":"","comment_id":133626,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5863591310","product_id":100029201,"comment_content":"ISR中进行选组也可能有10s的消息丢失?","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467453,"discussion_content":"不会啊。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568678840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":130950,"user_name":"Algoric","can_delete":false,"product_type":"c1","uid":1298722,"ip_address":"","ucode":"78D9850A88C254","user_header":"https://static001.geekbang.org/account/avatar/00/13/d1/22/706c492e.jpg","comment_is_top":false,"comment_ctime":1567582585,"is_pvip":false,"replies":[{"id":"49117","content":"只能说有可能，因为你可以手动触发Preferred Leader选举，Kafka默认也会定期触发","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567595754,"ip_address":"","comment_id":130950,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5862549881","product_id":100029201,"comment_content":"老师，请问下leader副本所在broker挂掉，重新恢复后上线，成为follower，后面会因为与AR中的优先副本的指定不一致，重新被选为leader副本？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466209,"discussion_content":"只能说有可能，因为你可以手动触发Preferred Leader选举，Kafka默认也会定期触发","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567595754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300570,"discussion_content":"auto.leader. rebalance.enable = true 并且不平衡率>leader.imbalance.per.broker.percentage，自动平衡流程就会触发。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598176174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126763,"user_name":"Geek_edc612","can_delete":false,"product_type":"c1","uid":1564943,"ip_address":"","ucode":"3E01DE3CE4BF3E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUJKviaecwxpAZCAnHWap86kXUichv5JwUoAtrUNy4ugC0kMMmssFDdyayKFgAoA9Z62sqMZaibbvUg/132","comment_is_top":false,"comment_ctime":1566466162,"is_pvip":false,"replies":[{"id":"46927","content":"目前不会。。。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1566522262,"ip_address":"","comment_id":126763,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5861433458","product_id":100029201,"comment_content":"kafak不会像hdfs那样自己再找个分区备份损坏磁盘副本吗？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464154,"discussion_content":"目前不会。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566522262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1564943,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUJKviaecwxpAZCAnHWap86kXUichv5JwUoAtrUNy4ugC0kMMmssFDdyayKFgAoA9Z62sqMZaibbvUg/132","nickname":"Geek_edc612","note":"","ucode":"3E01DE3CE4BF3E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5893,"discussion_content":"这么说的话，这个副本就一直没有了呗，怎么修复他呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566529276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1564943,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUJKviaecwxpAZCAnHWap86kXUichv5JwUoAtrUNy4ugC0kMMmssFDdyayKFgAoA9Z62sqMZaibbvUg/132","nickname":"Geek_edc612","note":"","ucode":"3E01DE3CE4BF3E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5891,"discussion_content":"好的，谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566529189,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119863,"user_name":"Geek_d7a8cc","can_delete":false,"product_type":"c1","uid":1229823,"ip_address":"","ucode":"2970446CCF76D2","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKickJXbocFlu3n3tBDR0kEU2UVjtHIA1qnzEicTVvwlQ2E4Vt9T1oV3Uw3KtbGeYpaU1oAEf1iazXPA/132","comment_is_top":false,"comment_ctime":1564714478,"is_pvip":false,"replies":[{"id":"44039","content":"可以的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564734674,"ip_address":"","comment_id":119863,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5859681774","product_id":100029201,"comment_content":"kafka集群同一分区各副本可以分布在不同机柜或者不同机房？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461100,"discussion_content":"可以的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564734674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118074,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1564231401,"is_pvip":false,"replies":[{"id":"43364","content":"1. 不会<br>2. 不工作了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564362008,"ip_address":"","comment_id":118074,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5859198697","product_id":100029201,"comment_content":"如果我创建的时候指定有三个副本<br>1. 如果某一个副本所在的broker挂了，kafka会在另一个broker上面新创建一个partition来补充吗？<br>2. 如果这三个副本所在的broker都挂了，那kafka会不会在一个新的broker上面重新创建一个新的partition来支持读写，还是说，这个partition就不在工作了？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460253,"discussion_content":"1. 不会\n2. 不工作了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564362008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117454,"user_name":"振超","can_delete":false,"product_type":"c1","uid":1103529,"ip_address":"","ucode":"D55B896810DBBF","user_header":"https://static001.geekbang.org/account/avatar/00/10/d6/a9/ffd70fdc.jpg","comment_is_top":false,"comment_ctime":1564050919,"is_pvip":false,"replies":[{"id":"43008","content":"不会。ISR比较的是follower和leader的LEO，不是和leader的HW比较。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564061881,"ip_address":"","comment_id":117454,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5859018215","product_id":100029201,"comment_content":"老师，如果仅仅以 replica.lag.time.max.ms 决定 follower 是否应该加入 ISR 集合，是否存在这样一种情况，一个 follower 离线了一段时间之后重新上线，然后开始与 leader 同步，此时同步时间间隔在 replica.lag.time.max.ms 内，该 follower 成功加入到 ISR 集合，但是因为长时间失效，导致该 follower 的 LEO 值小于 leader 的 HW，如果此时 leader 宕机，并正好选择该 follower 作为新的 leader，这样是不是就丢消息了？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459979,"discussion_content":"不会。ISR比较的是follower和leader的LEO，不是和leader的HW比较。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564061881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117340,"user_name":"cgddw","can_delete":false,"product_type":"c1","uid":1316424,"ip_address":"","ucode":"621E250BC49C28","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLHKka9hn8hYyd7SD12PEYiazRKg2a5iaFibP7z13t9ARicUvbwItESpIYONxV6gHMFYTmdp4eGZ4YDsA/132","comment_is_top":false,"comment_ctime":1564026393,"is_pvip":false,"replies":[{"id":"43012","content":"使用kafka-reassign-partitions脚本可以，具体用法看一下--reassignment-json-file参数","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564062162,"ip_address":"","comment_id":117340,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5858993689","product_id":100029201,"comment_content":"问下老师，kafka新增一块磁盘，如何做到数据迁移到新盘上。是这样的，之前磁盘只有一块，用久了磁盘忙了，修改保留数据时间已经不能支撑业务了。于是在不重启机器的情况下，新增了一块盘，然后重启kafka，发现新盘没有数据进来。请问要如何做，可以把数据迁移到新盘上","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459921,"discussion_content":"使用kafka-reassign-partitions脚本可以，具体用法看一下--reassignment-json-file参数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564062162,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1316424,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLHKka9hn8hYyd7SD12PEYiazRKg2a5iaFibP7z13t9ARicUvbwItESpIYONxV6gHMFYTmdp4eGZ4YDsA/132","nickname":"cgddw","note":"","ucode":"621E250BC49C28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3497,"discussion_content":"老师，你好。我的认知里面这个kafka-reassign-partitions脚本是用来扩容时候把数据移到新的broker上的。不知道我的理解对不对。我现在这个问题是没有扩容新的broker，只是在原来的broker上加了一块新的盘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564538690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117261,"user_name":"公号-技术夜未眠","can_delete":false,"product_type":"c1","uid":1013683,"ip_address":"","ucode":"83825B57CBD952","user_header":"https://static001.geekbang.org/account/avatar/00/0f/77/b3/991f3f9b.jpg","comment_is_top":false,"comment_ctime":1564016623,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5858983919","product_id":100029201,"comment_content":"本章原理和过程讲得很清楚。👍","like_count":1},{"had_liked":false,"id":333858,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1644564481,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1644564481","product_id":100029201,"comment_content":"动态ISR 跟 数据库的那种复制集还是有区别， 这个也是kafka 丢数据的主要原因吧？ 所以Kafka 更关注的是高可用吧？","like_count":0},{"had_liked":false,"id":333856,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1644564373,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1644564373","product_id":100029201,"comment_content":"kafka 如果是日志类信息， 一致性要求没那么高吧， 这个时候应该是开启Unclean Leader Election 更好吧？ 更多的业务场景是 可用性大于一致性吧？","like_count":0},{"had_liked":false,"id":330716,"user_name":"小仙","can_delete":false,"product_type":"c1","uid":1866677,"ip_address":"","ucode":"9F94043DFCEC3A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq6pWvKsV4rzQ62z5MDEjaEU5MbDfmzbA62kUgoqia2tgKIIxw4ibkDhF7W48iat5dT8UB9Adky2NuzQ/132","comment_is_top":false,"comment_ctime":1642130551,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642130551","product_id":100029201,"comment_content":"如果设置某个 Follower 副本对外提供查询服务，只需要保证该 Follower 副本与 Leader 强一致性同步，而非异步即可。<br>集群情况分为三类<br>1. Leader 副本<br>2. Follower - sync 同步副本<br>3. Follower - normal 普通副本 ","like_count":0},{"had_liked":false,"id":323103,"user_name":"Geek_f9d469","can_delete":false,"product_type":"c1","uid":2842794,"ip_address":"","ucode":"0A14D20CB927F6","user_header":"","comment_is_top":false,"comment_ctime":1637730255,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637730255","product_id":100029201,"comment_content":"如何避免或缓解因 Follower 副本与 Leader 副本不同步而导致的数据不一致的情形？<br><br>我觉得可以从以下入手：<br>1、从ISR集合中选取离客户端最近的副本对外提供，由于ISR","like_count":0},{"had_liked":false,"id":320433,"user_name":"云师兄","can_delete":false,"product_type":"c1","uid":1010459,"ip_address":"","ucode":"4475AF1598FBFD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg","comment_is_top":false,"comment_ctime":1636331912,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636331912","product_id":100029201,"comment_content":"老师，分布式系统中各个节点数据复制有著名的paxos协议，这里跟随者副本异步拉取好像跟这套协议格格不入？","like_count":0},{"had_liked":false,"id":308894,"user_name":"银子","can_delete":false,"product_type":"c1","uid":1125765,"ip_address":"","ucode":"5233F5FB5D2755","user_header":"https://static001.geekbang.org/account/avatar/00/11/2d/85/55f19976.jpg","comment_is_top":false,"comment_ctime":1629854172,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1629854172","product_id":100029201,"comment_content":"kafka为什么不采用 follower副本可读来提高读的并发？<br>答：Kafka的集群中broker之间是互为主备，假如topic A有三个partition，副本数也是三，集群数是三，那么每台broker有一个partition的leader，有另两个partition的follower，如果生产者发送消息采用的是默认机制round robin 轮训机制，那么三台broker的负载是均衡的，所以kafka没必要使follower可读，使用partition做读写负载均衡了。<br><br>Kafka采用leader作为唯一的读写入口有什么优势？<br>1、read my write，没有像mysql那样有读写延迟。<br>2、单调读，不会出现不一致读情况，比如consumer开始在follower A读消息，重启consumer后从follower B读，A B两个副本同步进度不一样，会出现前后不一致读的情况。<br><br>什么是 In Sync Replica？（ISP）<br>意为与leader同步的副本，Kafka判定标准不是根据进度，而是根据落后时间，由配置参数 replica.lag.max.ms，如果落后的时间在此范围内则属于ISP，否则不属于ISP。（leader也属于副本，ISP里至少会有leader。）<br><br>ISP有什么作用？<br>当leader宕机，会从ISP里找其他副本，选做leader；假如ISP里没有其他副本，说明所有的副本都落后leader （replica.lag.max.ms）的时间间隔，无可选读leader会出现此分区不可用，不再提高服务；如果允许unclean副本参与leader选举，可以通过配置 unclean.leader.election.enable =true；选举的过程符合分布式系统的CAP，unclean 设置enable属于 AP，否则属于CP","like_count":0},{"had_liked":false,"id":299597,"user_name":"非洲黑猴子","can_delete":false,"product_type":"c1","uid":2639724,"ip_address":"","ucode":"F5FEAC07D562E0","user_header":"https://static001.geekbang.org/account/avatar/00/28/47/6c/78184d19.jpg","comment_is_top":false,"comment_ctime":1624756753,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1624756753","product_id":100029201,"comment_content":"acks参数默认设置为-1，飞行消息数设置多一些，保证所有副本都同步了才向Producer发送ack。Consumer端，如果连接的是分区的master，则没有全部副本都同步的话，就不许Consumer读取该消息及其之后的消息","like_count":0},{"had_liked":false,"id":297589,"user_name":"离境”","can_delete":false,"product_type":"c1","uid":1895314,"ip_address":"","ucode":"7186EF2BEF8956","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/STqKg1kLgvRuduQfo0R2E2osYBian7XrQAjSWmOwL9nyZVhq7vyLPnlGcgvguFV4aV7ToWLFiauEMKy96KWHKBVg/132","comment_is_top":false,"comment_ctime":1623657852,"is_pvip":false,"replies":[{"id":"108490","content":"因为Kafka集群的每个broker上都有topic分区的数据缓存","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1624497643,"ip_address":"","comment_id":297589,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1623657852","product_id":100029201,"comment_content":"想问下老师消费者为什么能在没有相应分区的broker里取到该分区的信息？我自己定义了2副本3分区的topic，其中broker1里只有分区1和分区0，为什么我的消费者连接它可以收到 写在broker2里的数据，broker2里只有分区2和0","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521868,"discussion_content":"因为Kafka集群的每个broker上都有topic分区的数据缓存","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624497643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295877,"user_name":"Geek_fcd2cf","can_delete":false,"product_type":"c1","uid":1778060,"ip_address":"","ucode":"171F238259D7FF","user_header":"https://static001.geekbang.org/account/avatar/00/1b/21/8c/1387a96f.jpg","comment_is_top":false,"comment_ctime":1622627531,"is_pvip":false,"replies":[{"id":"107775","content":"首先，不是leader分区。而是分区的leader副本。其次，一旦选出了新的leader副本，旧leader副本恢复之后自动变成follower，从leader处同步高水位信息并从那里开始恢复","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1623120312,"ip_address":"","comment_id":295877,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1622627531","product_id":100029201,"comment_content":"kafka中某个topic的leader分区挂掉了，重新选举新的leader之后，这个挂掉的leader分区又活过来了，它这个数据是怎么同步的。 从哪里开始同步，如何同步的","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521249,"discussion_content":"首先，不是leader分区。而是分区的leader副本。其次，一旦选出了新的leader副本，旧leader副本恢复之后自动变成follower，从leader处同步高水位信息并从那里开始恢复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623120312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290105,"user_name":"aiwen","can_delete":false,"product_type":"c1","uid":1104346,"ip_address":"","ucode":"504F06CCC7B4FB","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/da/23a4a0c4.jpg","comment_is_top":false,"comment_ctime":1619362843,"is_pvip":false,"replies":[{"id":"105282","content":"选出ISR中剩下的第一个","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1619599803,"ip_address":"","comment_id":290105,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1619362843","product_id":100029201,"comment_content":"Leader副本所在Broker宕机后，Controller Broker具体如何选举出新的Leader副本？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519116,"discussion_content":"选出ISR中剩下的第一个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619599803,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285141,"user_name":"肖恒","can_delete":false,"product_type":"c1","uid":1861000,"ip_address":"","ucode":"50B1118691B222","user_header":"","comment_is_top":false,"comment_ctime":1616640465,"is_pvip":false,"replies":[{"id":"103526","content":"通常不会造成数据丢失。如果你这边能稳定地复现丢失的场景，可以给社区提一个jira：）","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1616720328,"ip_address":"","comment_id":285141,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1616640465","product_id":100029201,"comment_content":"Kafka ISR 集合选举 leader 的时候会造成数据丢失吗？比如在一个 ISR 集合中，某个 follower 落后 leader 2s 的数据，此时 leader 宕机，那么选举该 follower 为 new leader，此时会丢失数据吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517597,"discussion_content":"通常不会造成数据丢失。如果你这边能稳定地复现丢失的场景，可以给社区提一个jira：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616720328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268082,"user_name":"coderzc","can_delete":false,"product_type":"c1","uid":1194684,"ip_address":"","ucode":"595748485D4475","user_header":"https://static001.geekbang.org/account/avatar/00/12/3a/bc/d4bd1b00.jpg","comment_is_top":false,"comment_ctime":1608046721,"is_pvip":false,"replies":[{"id":"97339","content":"不会回滚数据","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1608080472,"ip_address":"","comment_id":268082,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1608046721","product_id":100029201,"comment_content":"老师，在ack=all的时候，如果一个follower同步失败或者由于网络原因一直未同步到数据，会像raft那样回滚数据吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511836,"discussion_content":"不会回滚数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608080472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348199,"discussion_content":"那这个offset还会如何计算呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612454846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":266538,"user_name":"innocent","can_delete":false,"product_type":"c1","uid":1197455,"ip_address":"","ucode":"368659A0DDE7E4","user_header":"https://static001.geekbang.org/account/avatar/00/12/45/8f/a56b2214.jpg","comment_is_top":false,"comment_ctime":1607388797,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607388797","product_id":100029201,"comment_content":"Kafka这样设计可以方便的实现强一致性，并且性能不会受到影响","like_count":0},{"had_liked":false,"id":266390,"user_name":"火狼","can_delete":false,"product_type":"c1","uid":2046978,"ip_address":"","ucode":"37BDE583E64D8C","user_header":"https://static001.geekbang.org/account/avatar/00/1f/3c/02/b7c27217.jpg","comment_is_top":false,"comment_ctime":1607322374,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607322374","product_id":100029201,"comment_content":"ISR中的副本和leader 并不是完全同步的，  假设 replica.lag.time.max.ms 使用默认值，则新的leader 和原来的leader 存在 10s内的延迟，那么是否意味着新leader选举成功后，这部分延迟的数据会丢失，那是不是也就意味着在实际生产环境中，为了不丢失数据，我们应该把  replica.lag.time.max.ms  的值调到接近于0","like_count":0},{"had_liked":false,"id":265072,"user_name":"点点","can_delete":false,"product_type":"c1","uid":1222823,"ip_address":"","ucode":"2E29A4DC027A16","user_header":"https://static001.geekbang.org/account/avatar/00/12/a8/a7/4d8cb9cf.jpg","comment_is_top":false,"comment_ctime":1606750740,"is_pvip":false,"replies":[{"id":"96629","content":"unclean.leader.election.enable禁用是指设成false了还是true啊？？ 如果是指false，那么多副本就是一种高可用的机制","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1607077992,"ip_address":"","comment_id":265072,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1606750740","product_id":100029201,"comment_content":"unclean.leader.election.enable 禁用了后，可以通过哪种方式保持高可用性","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510791,"discussion_content":"unclean.leader.election.enable禁用是指设成false了还是true啊？？ 如果是指false，那么多副本就是一种高可用的机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607077992,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263006,"user_name":"LBruce","can_delete":false,"product_type":"c1","uid":1188175,"ip_address":"","ucode":"55884BE8C58C8B","user_header":"https://static001.geekbang.org/account/avatar/00/12/21/4f/581c85e2.jpg","comment_is_top":false,"comment_ctime":1605943561,"is_pvip":false,"replies":[{"id":"96052","content":"需要排查到底是消息读取慢还是副本同步慢。每种情况有相应的参数调整","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606699441,"ip_address":"","comment_id":263006,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605943561","product_id":100029201,"comment_content":"想问一下老师，最近在压测kafka,发现kafka的消息出站速率很慢。只有1Mbps左右。（服务器环境为8核16G， 1个topic，30个partition，30个consumer线程去消费消息），这种问题该从哪方面进行调整排查呢？已经按照老师专栏中提到的，对Linux，JVM调整过了。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510066,"discussion_content":"需要排查到底是消息读取慢还是副本同步慢。每种情况有相应的参数调整","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606699441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257172,"user_name":"fightingD","can_delete":false,"product_type":"c1","uid":1443637,"ip_address":"","ucode":"AD2876CED5D5AC","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwViav94kcF50CxA0Jw7icicxociaVzut97iacy3b2ciacFqXuFWdiakVq304YcI8pt4HT5A1Yvp8EkYCpw/132","comment_is_top":false,"comment_ctime":1603872070,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603872070","product_id":100029201,"comment_content":"有一个想ISR这样的队列，里面的副本都是跟领导副本保持一致的副本，只有这个队列中的副本才可以对外提供服务。","like_count":0},{"had_liked":false,"id":255242,"user_name":"浮石沉木","can_delete":false,"product_type":"c1","uid":2223167,"ip_address":"","ucode":"D585768321B84A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/mQddXC7nRiaKHTwdficicTB3bH0q5ic5UoSab51Omic7eyLBz0SNcvbLpQnNib7zP1yJFm7xxx4ia81iahfibRVnbTwHmhw/132","comment_is_top":false,"comment_ctime":1603288751,"is_pvip":true,"replies":[{"id":"93048","content":"副本数包括了leader副本，因此消息数是3","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1603354127,"ip_address":"","comment_id":255242,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603288751","product_id":100029201,"comment_content":"问一个小白问题，kafka有没有主本的概念。比如说我副本数设置为3，实际消息是有3+1还是3呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507658,"discussion_content":"副本数包括了leader副本，因此消息数是3","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603354127,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245122,"user_name":"杯莫停","can_delete":false,"product_type":"c1","uid":1759325,"ip_address":"","ucode":"4FA1D5CBBEF702","user_header":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","comment_is_top":false,"comment_ctime":1598840712,"is_pvip":true,"replies":[{"id":"90464","content":"follower提供服务的初衷：1. 基于地理位置的考虑：优先让距离近的follower提供数据，而不是更远的leader副本；2. 增加吞吐量。没有并发压力的说法并不认同。事实上，一个分区可能同时被很多个消费者消费","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1599204728,"ip_address":"","comment_id":245122,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1598840712","product_id":100029201,"comment_content":"对于follower不对消费者提供服务，我想如果等到所有follower都拉取成功后才算一条消息发送成功，然后再统一对外提供服务是不是就可以，只是要花费一定的时间，这不是我们想要的。<br>通常Broker我们一个partition只有一个消费者消费，因为Kafka消息可以看做是流式的，其实是没有并发压力的，消费者多了也浪费。所以我觉得follower提供服务是没必要的。不知道我的想法正确与否，请多多指教。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504795,"discussion_content":"follower提供服务的初衷：1. 基于地理位置的考虑：优先让距离近的follower提供数据，而不是更远的leader副本；2. 增加吞吐量。没有并发压力的说法并不认同。事实上，一个分区可能同时被很多个消费者消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599204728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1759325,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d8/5d/07dfb3b5.jpg","nickname":"杯莫停","note":"","ucode":"4FA1D5CBBEF702","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303264,"discussion_content":"嗯嗯，明白了！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599204956,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244345,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1598489615,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598489615","product_id":100029201,"comment_content":"这个地方想不通，什么情况下消费者可以既消费F1然后又消费F2？   F1与F2是互斥的啊。。   他们是同一条消息，这样不就消费重复了么<br><br><br>如果允许追随者副本提供读服务，那么假设当前有 2 个追随者副本 F1 和 F2，它们异步地拉取领导者副本数据。倘若 F1 拉取了 Leader 的最新消息而 F2 还未及时拉取，那么，此时如果有一个消费者先从 F1 读取消息之后又从 F2 拉取消息，它可能会看到这样的现象：第一次消费时看到的最新消息在第二次消费时不见了，这就不是单调读一致性。但是，如果所有的读请求都是由 Leader 来处理，那么 Kafka 就很容易实现单调读一致性。","like_count":0},{"had_liked":false,"id":243557,"user_name":"nestle","can_delete":false,"product_type":"c1","uid":1762252,"ip_address":"","ucode":"469800BED81B54","user_header":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","comment_is_top":false,"comment_ctime":1598184039,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598184039","product_id":100029201,"comment_content":"2.5.0版本把replica.lag.time.max.ms的默认值从10s调整到30s了。","like_count":0},{"had_liked":false,"id":239020,"user_name":"A_Tarnished","can_delete":false,"product_type":"c1","uid":1226034,"ip_address":"","ucode":"0125AB3B63F236","user_header":"https://static001.geekbang.org/account/avatar/00/12/b5/32/b9b4aefb.jpg","comment_is_top":false,"comment_ctime":1596417379,"is_pvip":false,"replies":[{"id":"88291","content":"partition受限于broker数量主要是基于性能的考虑，而不是说有其他的限制","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1596425859,"ip_address":"","comment_id":239020,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1596417379","product_id":100029201,"comment_content":"分区是跨broker的设计，那么为什么在创建主题时，partitions数量受限于broker数量呢","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502941,"discussion_content":"partition受限于broker数量主要是基于性能的考虑，而不是说有其他的限制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596425859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":235825,"user_name":"鱼","can_delete":false,"product_type":"c1","uid":1487584,"ip_address":"","ucode":"89EC9CE3AD0281","user_header":"https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg","comment_is_top":false,"comment_ctime":1595214148,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595214148","product_id":100029201,"comment_content":"主从不一致问题出现的主要场景也是出现在Read After Your Write和单调读上。我从这两个角度结合Kafka的特点说一下解决方案：<br>一.结合ISR（默认10s），<br>1. Producer写入数据记录写入时间戳。<br>2. Consumer查看ISR中是否有本地Fellower副本，有的话想尝试从本地Fellower副本从消费数据<br>3. Consumer需要读取时间小于10s的数据，则从Leader中读取数据<br>二.结合分区内的顺序消费机制。（为每一个新消息记录递增Id：当前Consumer消费的记录为ConsumerId，Leader的最新Id为LeaderId，本地FellowerId记录为LocalId）<br>1. Consumer消费时，如果发现LocalId比ConsumerId大一个阈值（比如说100）就从先从本地读取消息，<br>2. 读取到另外一个阈值（比如说10）时候切换到Leader去读取。<br>3. 如果达不到阈值，就直接读取Leader消息。<br>当然这两种场景虽然可以覆盖消息队列的数据一致性场景，但仍然是降低标准的同步机制。要做到完全同步，可以考虑使用类似于Leaf的半同步机制或者完全同步。使用该方案有住数据的一致性和持久性，但会显著降低性能。在MQ场景下没有必要，我想Kafka官方应该不会考虑。<br>BTW，解决一致性问题的方案同时会增加另外一个问题的复杂度：记录Consumer消费的进度。这也是官方在考虑的一点吧。","like_count":0},{"had_liked":false,"id":229319,"user_name":"Edon du","can_delete":false,"product_type":"c1","uid":1074742,"ip_address":"","ucode":"1648624751AAE9","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/36/b4a4e6fb.jpg","comment_is_top":false,"comment_ctime":1592964928,"is_pvip":false,"replies":[{"id":"84609","content":"1. 副本数不能超过broker数量<br>2. 可以创建名为“leader”的主题啊<br>3. 不允许创建已存在的主题","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592966545,"ip_address":"","comment_id":229319,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592964928","product_id":100029201,"comment_content":"关于副本一直有点疑问，所以就手动试了下，试验结果：<br>1. 创建topic时不能指定大于broker数量的副本因子<br>2. 不能创建名称为leader的topic,但名称为follower的topic却能创建成功<br>3. topic一旦被创建，再次创建相同名称的topic不会生效。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499439,"discussion_content":"1. 副本数不能超过broker数量\n2. 可以创建名为“leader”的主题啊\n3. 不允许创建已存在的主题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592966545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227481,"user_name":"密码123456","can_delete":false,"product_type":"c1","uid":1126593,"ip_address":"","ucode":"9889463CC0EA71","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","comment_is_top":false,"comment_ctime":1592389405,"is_pvip":false,"replies":[{"id":"83832","content":"也算是一种数据同步机制。毕竟Leader&#47;Follower模式不是唯一的","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592403125,"ip_address":"","comment_id":227481,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592389405","product_id":100029201,"comment_content":"可以写入几个副本算写入成功，读取几个副本算读成功。只要写入的副本数+读取的副本数&gt;集群总副本数。就可以维持一致性。我觉得这样，也不是很好，每次写入或读取数据，都会发送大量请求","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498658,"discussion_content":"也算是一种数据同步机制。毕竟Leader/Follower模式不是唯一的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592403125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225773,"user_name":"耿嘉艺","can_delete":false,"product_type":"c1","uid":2023401,"ip_address":"","ucode":"727A22BD41E8AF","user_header":"","comment_is_top":false,"comment_ctime":1591852718,"is_pvip":false,"replies":[{"id":"83189","content":"嗯，zero copy","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1591871250,"ip_address":"","comment_id":225773,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591852718","product_id":100029201,"comment_content":"读取消息的话，可以先从缓冲区中根据topic进行读取，没有的话再读磁盘。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497985,"discussion_content":"嗯，zero copy","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591871250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":224240,"user_name":"GaelYang","can_delete":false,"product_type":"c1","uid":1463730,"ip_address":"","ucode":"B8E0B2402A7DCC","user_header":"https://static001.geekbang.org/account/avatar/00/16/55/b2/d70deacf.jpg","comment_is_top":false,"comment_ctime":1591322080,"is_pvip":false,"replies":[{"id":"82575","content":"你指的副本操作是什么含义呢？如果只有1个副本，肯定没有副本间同步的必要了，这是肯定的~","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1591336094,"ip_address":"","comment_id":224240,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591322080","product_id":100029201,"comment_content":"kafka默认的是1个副本。在单机的场景下，kafka是否类似es不对副本进行操作？因为这根本没有意义，还会导致IO和其他资源的消耗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497412,"discussion_content":"你指的副本操作是什么含义呢？如果只有1个副本，肯定没有副本间同步的必要了，这是肯定的~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591336094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187770,"user_name":"kiddkidd","can_delete":false,"product_type":"c1","uid":1353645,"ip_address":"","ucode":"5CFD9C737F0AEE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqj0HqmCbKPaW84jZaru1xa0icAEcDHgCszTO4tPwZBalXkib5CsISnAUAlO2hwDadoYPGUjIw0xBwg/132","comment_is_top":false,"comment_ctime":1584237789,"is_pvip":false,"replies":[{"id":"72591","content":"这是个双保险。如果ISR中没有任何副本了，自然也就不需要比较了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1584320718,"ip_address":"","comment_id":187770,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584237789","product_id":100029201,"comment_content":"老师你好，文中前面说判断follower与leader是否同步的标准，是follower落后leader的最大时间是否超过replica.lag.time.max.ms。而后面又说ISR可能为空，表示leader副本也不在ISR，请问leader副本与哪个标的比较落后超过replica.lag.time.max.ms呢，谢谢。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487233,"discussion_content":"这是个双保险。如果ISR中没有任何副本了，自然也就不需要比较了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584320718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156123,"user_name":"洪东楗","can_delete":false,"product_type":"c1","uid":1621119,"ip_address":"","ucode":"D161432152E967","user_header":"https://static001.geekbang.org/account/avatar/00/18/bc/7f/3b75677e.jpg","comment_is_top":false,"comment_ctime":1574821924,"is_pvip":false,"replies":[{"id":"60084","content":"你是如何确定消息发送成功了呢？可以使用KafkaConsumer.endOffsets验证下消息确实写入成功了，","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1574902527,"ip_address":"","comment_id":156123,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1574821924","product_id":100029201,"comment_content":"您好，老师，自己实验中有个问题想请教下，broker有三台，topic有1分区3副本，min.insync.replicas设置为2的时候，消息都发送成功了，但是消费者没消费到数据，把min.insync.replicas设置为1，消费者就消费到数据了，希望您能帮忙解答下","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475995,"discussion_content":"你是如何确定消息发送成功了呢？可以使用KafkaConsumer.endOffsets验证下消息确实写入成功了，","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574902527,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":155746,"user_name":"man1s","can_delete":false,"product_type":"c1","uid":1466953,"ip_address":"","ucode":"FFDB6B52F65A1B","user_header":"https://static001.geekbang.org/account/avatar/00/16/62/49/6332c99b.jpg","comment_is_top":false,"comment_ctime":1574747588,"is_pvip":false,"replies":[{"id":"59945","content":"有兴趣看看KIP-392的设计吧（https:&#47;&#47;cwiki.apache.org&#47;confluence&#47;display&#47;KAFKA&#47;KIP-392%3A+Allow+consumers+to+fetch+from+closest+replica）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1574816487,"ip_address":"","comment_id":155746,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1574747588","product_id":100029201,"comment_content":"打破follower 不可读是指让leader 写，某一个follower读吗？同一个分区应该不能同时读多个副本吧，同时读多个副本offset的维护想想就可怕","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475855,"discussion_content":"有兴趣看看KIP-392的设计吧（https://cwiki.apache.org/confluence/display/KAFKA/KIP-392%3A+Allow+consumers+to+fetch+from+closest+replica）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574816487,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126761,"user_name":"Geek_edc612","can_delete":false,"product_type":"c1","uid":1564943,"ip_address":"","ucode":"3E01DE3CE4BF3E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUJKviaecwxpAZCAnHWap86kXUichv5JwUoAtrUNy4ugC0kMMmssFDdyayKFgAoA9Z62sqMZaibbvUg/132","comment_is_top":false,"comment_ctime":1566465798,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566465798","product_id":100029201,"comment_content":"老师好，磁盘损坏，会造成broker宕机吗？","like_count":0},{"had_liked":false,"id":125068,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1566054163,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1566054163","product_id":100029201,"comment_content":"老师这节讲的真棒!<br>再请教几个小问题<br>1：允许将数据放入与用户地理位置相近的地方，从而降低系统延时。<br>本身主从之间进行数据同步就存在延迟的，这一点是否很难避免？老师这里讲的是用户访问那些已经同步完成的数据嘛？<br><br>2：副本是在分区层级的定义，是否表示放入分区中的消息实际存储的地方就是在副本中，也就是那个只能追加写消息的提交日志？分区仅仅是个消息存储的逻辑概念？那有两个问题，这个提交日志的具体格式是怎么设计的？删除消息是怎么实现的？<br><br>3：在实际生产环境中，每台 Broker 都可能保存有各个主题下不同分区的不同副本，因此，单个 Broker 上存有成百上千个副本的现象是非常正常的。<br>一台broker上的分区副本是否有上限，这么多副本需要追加写消息，系统资源特别是网络带宽和磁盘IO想必占用的比较大？怎么保证单broker的性能？<br><br>4：当领导者副本挂掉了，或者说领导者副本所在的 Broker 宕机时，Kafka 依托于 ZooKeeper 提供的监控功能能够实时感知到，并立即开启新一轮的领导者选举，从追随者副本中选一个作为新的领导者。老 Leader 副本重启回来后，只能作为追随者副本加入到集群中。<br>两个问题，<br>具体的选举策略是什么？怎么保证同步数据最全的那个副本被选为领导者副本？<br>如果领导者副本宕机时，恰巧有数据没同步，那这部分数据是否就丢了？<br><br>5：replica.lag.time.max.ms 参数值。这个参数的含义是 Follower 副本能够落后 Leader 副本的最长时间间隔，当前默认值是 10 秒。这就是说，只要一个 Follower 副本落后 Leader 副本的时间不连续超过 10 秒，那么 Kafka 就认为该 Follower 副本与 Leader 是同步的，即使此时 Follower 副本中保存的消息明显少于 Leader 副本中的消息。<br>用着参数明显感觉，会加大消息的丢失量，当然性能会更好一些，请问这个参数可以任意设置嘛？比如：-1或0或一年<br><br>如果允许 Follower 副本对外提供读服务，你觉得应该如何避免或缓解因 Follower 副本与 Leader 副本不同步而导致的数据不一致的情形？<br>完全避免估计很难，如果5G铺开了，网络延迟无限接近于0且比较稳定到可以。","like_count":0},{"had_liked":false,"id":122159,"user_name":"落霞与孤鹜","can_delete":false,"product_type":"c1","uid":1111004,"ip_address":"","ucode":"1F06EB86DD2E6B","user_header":"https://static001.geekbang.org/account/avatar/00/10/f3/dc/e7e5c159.jpg","comment_is_top":false,"comment_ctime":1565312313,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565312313","product_id":100029201,"comment_content":"通过zk监听，一有变化，就拉主副本数据，也可以读取最终的offset，如果不一致就告知消费者重试吧。","like_count":0},{"had_liked":false,"id":118702,"user_name":"曹伟雄","can_delete":false,"product_type":"c1","uid":1400754,"ip_address":"","ucode":"9740E426C0742C","user_header":"https://static001.geekbang.org/account/avatar/00/15/5f/b2/c4780c10.jpg","comment_is_top":false,"comment_ctime":1564417002,"is_pvip":false,"replies":[{"id":"43515","content":"其实也没什么规则。如果你觉得你的消息很值钱，不能丢，副本数就多第一点，比如3或4；否则一般的消息设置成2~3就可以了。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564447217,"ip_address":"","comment_id":118702,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564417002","product_id":100029201,"comment_content":"老师你好，请教个问题，在不同场景下，应该如何设计副本数?  有什么要注意的地方?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460537,"discussion_content":"其实也没什么规则。如果你觉得你的消息很值钱，不能丢，副本数就多第一点，比如3或4；否则一般的消息设置成2~3就可以了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564447217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117695,"user_name":"Geek_986289","can_delete":false,"product_type":"c1","uid":1182717,"ip_address":"","ucode":"503FE134FCC109","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKtYGLkKnh186Ynyx3bPvOMI7ViaWia2l8DD8eomDkE6AKNwW7l1a00CiaaiaiapibZY5JlQlxqQEQuSYFg/132","comment_is_top":false,"comment_ctime":1564112849,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1564112849","product_id":100029201,"comment_content":"老师请问下，即使再怎么同步，也一定是有延迟的，在leader 挂掉切到一个ISR后怎么保证这部分延迟同步的数据不会丢呢？","like_count":0,"discussions":[{"author":{"id":1317581,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq5rPOOXGnzcSUD7O14DEHE55gxtS09Uic5nqYEliask4nhozufHia0Ktc7xZH3B6YeTVza6ZNejAupQ/132","nickname":"wt","note":"","ucode":"925B16C8262914","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4205,"discussion_content":"ack=all就可以的吧。可以保证isr中都同步到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565226884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1281479,"avatar":"https://static001.geekbang.org/account/avatar/00/13/8d/c7/d66952bc.jpg","nickname":"Happy","note":"","ucode":"A19C5ECF0AE5FD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3681,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564706436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117551,"user_name":"rm -rf 😊ི","can_delete":false,"product_type":"c1","uid":1070908,"ip_address":"","ucode":"BC448EC4206D95","user_header":"https://static001.geekbang.org/account/avatar/00/10/57/3c/081b89ec.jpg","comment_is_top":false,"comment_ctime":1564072152,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564072152","product_id":100029201,"comment_content":"这就跟mysql的主从读写差不多，主写入速度过快导致从产生不一致情况。如果真要保证更好的一致性来让follower也能读，只能牺牲可用性了，比如生产的时候设置acks=all或者min.insync.replicas == 副本数，或者有其他更好办法？老师指导一下","like_count":0},{"had_liked":false,"id":117536,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564069429,"is_pvip":false,"replies":[{"id":"43053","content":"可用性就不讲了估计大家理解的差不多。分区容错性指的是由于网络故障部分网络被切断，与其他网络断开了连接","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564102140,"ip_address":"","comment_id":117536,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564069429","product_id":100029201,"comment_content":"老师，可以讲下可用性、分区容错性的区别吗。搞不懂两个的区别，有点模糊","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460014,"discussion_content":"可用性就不讲了估计大家理解的差不多。分区容错性指的是由于网络故障部分网络被切断，与其他网络断开了连接","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564102140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117533,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564068406,"is_pvip":false,"replies":[{"id":"43052","content":"会的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564102016,"ip_address":"","comment_id":117533,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1564068406","product_id":100029201,"comment_content":"老师，Kafka 会自动收缩 ISR 集合，将该副本“踢出”ISR。踢出去后副本还会做同步操作吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460013,"discussion_content":"会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564102016,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330847,"discussion_content":"感觉 isr 和 生产者的ack 一起使用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606721673,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117528,"user_name":"ban","can_delete":false,"product_type":"c1","uid":1034204,"ip_address":"","ucode":"E523CE97E48266","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","comment_is_top":false,"comment_ctime":1564067650,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564067650","product_id":100029201,"comment_content":"老师，你说“对于客户端用户而言，Kafka 的追随者副本没有任何作用，它既不能像 MySQL 那样帮助领导者副本“抗读”，也不能实现将某些副本放到离客户端近的地方来改善数据局部性。”<br><br>副本按地区分布只有领导者能读。那如果从分区的角度来说，分区按地区来分布，是不是就可以说改善数据的局部性，也可以做到横向扩展。","like_count":0},{"had_liked":false,"id":117519,"user_name":"z.l","can_delete":false,"product_type":"c1","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","comment_is_top":false,"comment_ctime":1564065514,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564065514","product_id":100029201,"comment_content":"我觉得应该是，一个 consumer实例固定从某一个副本上拉消息。","like_count":0},{"had_liked":false,"id":117489,"user_name":"QQ怪","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1564059091,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564059091","product_id":100029201,"comment_content":"老师讲的真好，期待源码讲解","like_count":0},{"had_liked":false,"id":117420,"user_name":"丘壑","can_delete":false,"product_type":"c1","uid":1118203,"ip_address":"","ucode":"ECFEDA5A93828D","user_header":"https://static001.geekbang.org/account/avatar/00/11/0f/fb/68196d4c.jpg","comment_is_top":false,"comment_ctime":1564043474,"is_pvip":false,"replies":[{"id":"43009","content":"不能。acks的设置与否与ISR中有几个副本没有关系","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564061961,"ip_address":"","comment_id":117420,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564043474","product_id":100029201,"comment_content":"老师，producer的config参数中的acks参数，应该就是用来保证消息是否被写入了多个副本的机制之一把，如果开启acks，除非这几个副本的broker都挂掉了，这样是否就会保证ISR不会为空呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459958,"discussion_content":"不能。acks的设置与否与ISR中有几个副本没有关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564061961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117355,"user_name":"☆appleう","can_delete":false,"product_type":"c1","uid":1101071,"ip_address":"","ucode":"54F4A73057E02A","user_header":"https://static001.geekbang.org/account/avatar/00/10/cd/0f/fa810f69.jpg","comment_is_top":false,"comment_ctime":1564029432,"is_pvip":false,"replies":[{"id":"43011","content":"不会判断。后面的问题好像没太明白。。。<br>","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564062028,"ip_address":"","comment_id":117355,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564029432","product_id":100029201,"comment_content":"老师，这里说的unclean选举新的领导者方式，会判断哪个追求者副本与挂掉的老leader差异最小吗？<br><br>如果我们不选择最小差异的副本作为新领导者，那么这一段时间broker就不能用了，有什么方式可以支持一致性数据的方案吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459926,"discussion_content":"不会判断。后面的问题好像没太明白。。。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564062028,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117244,"user_name":"我已经设置了昵称","can_delete":false,"product_type":"c1","uid":1364034,"ip_address":"","ucode":"ED672C5EBDBDC4","user_header":"https://static001.geekbang.org/account/avatar/00/14/d0/42/6fd01fb9.jpg","comment_is_top":false,"comment_ctime":1564015225,"is_pvip":false,"replies":[{"id":"43018","content":"首先不是consumer offset，这里和consumer没有任何关系。<br><br>你说的其他内容我基本同意：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564062427,"ip_address":"","comment_id":117244,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564015225","product_id":100029201,"comment_content":"lag.time.max.ms那个值的意思是先标记下当前leader副本的当前consumer offset，在这段时间内，其他副本必须得到到达这个offset，才算同步副本，是这么个意思吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459878,"discussion_content":"首先不是consumer offset，这里和consumer没有任何关系。\n\n你说的其他内容我基本同意：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564062427,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117242,"user_name":"Riordon","can_delete":false,"product_type":"c1","uid":1127497,"ip_address":"","ucode":"E2F6855B5FE5F9","user_header":"https://static001.geekbang.org/account/avatar/00/11/34/49/6b27feb1.jpg","comment_is_top":false,"comment_ctime":1564014709,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564014709","product_id":100029201,"comment_content":"牺牲高可用性和部分性能，把异步拉取改为同步管线，参照HDFS","like_count":0},{"had_liked":false,"id":117231,"user_name":"曾轼麟","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1564013657,"is_pvip":false,"replies":[{"id":"42901","content":"主要是要解决follower与leader不一致的情形","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564015829,"ip_address":"","comment_id":117231,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564013657","product_id":100029201,"comment_content":"可以通过允许ISR集合中的follower对外提供服务。但是ISR集合有不确定性，这样消费者可能会发生类似rebalance的情况。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459870,"discussion_content":"主要是要解决follower与leader不一致的情形","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564015829,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117194,"user_name":"CCC","can_delete":false,"product_type":"c1","uid":1259814,"ip_address":"","ucode":"1608E84D2F0655","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/26/61e46afe.jpg","comment_is_top":false,"comment_ctime":1563986173,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563986173","product_id":100029201,"comment_content":"讲的真好！","like_count":0}]}