{"id":256055,"title":"28 | æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®ï¼ˆä¸‹ï¼‰ï¼šKafkaå¦‚ä½•ç®¡ç†è¿™äº›å…ƒæ•°æ®ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­å­¦ä¹ æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®ã€‚</p><p>å­¦å®Œä¸ŠèŠ‚è¯¾ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒKafkaå®šä¹‰äº†éå¸¸å¤šçš„å…ƒæ•°æ®ï¼Œé‚£ä¹ˆï¼Œè¿™å°±å¿…ç„¶æ¶‰åŠåˆ°å¯¹å…ƒæ•°æ®çš„ç®¡ç†é—®é¢˜äº†ã€‚</p><p>è¿™äº›å…ƒæ•°æ®çš„ç±»å‹ä¸åŒï¼Œç®¡ç†ç­–ç•¥ä¹Ÿå°±ä¸ä¸€æ ·ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘å°†ä»æ¶ˆè´¹è€…ç»„çŠ¶æ€ã€æˆå‘˜ã€ä½ç§»å’Œåˆ†åŒºåˆ†é…ç­–ç•¥å››ä¸ªç»´åº¦ï¼Œå¯¹è¿™äº›å…ƒæ•°æ®è¿›è¡Œæ‹†è§£ï¼Œå¸¦ä½ ä¸€èµ·äº†è§£ä¸‹Kafkaç®¡ç†è¿™äº›å…ƒæ•°æ®çš„æ–¹æ³•ã€‚</p><p>è¿™äº›æ–¹æ³•å®šä¹‰åœ¨MemberMetadataå’ŒGroupMetadataè¿™ä¸¤ä¸ªç±»ä¸­ï¼Œå…¶ä¸­ï¼ŒGroupMetadataç±»ä¸­çš„æ–¹æ³•æœ€ä¸ºé‡è¦ï¼Œæ˜¯æˆ‘ä»¬è¦é‡ç‚¹å­¦ä¹ çš„å¯¹è±¡ã€‚åœ¨åé¢çš„è¯¾ç¨‹ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ï¼Œè¿™äº›æ–¹æ³•ä¼šè¢«ä¸Šå±‚ç»„ä»¶GroupCoordinatoré¢‘ç¹è°ƒç”¨ï¼Œå› æ­¤ï¼Œå®ƒä»¬æ˜¯æˆ‘ä»¬å­¦ä¹ Coordinatorç»„ä»¶ä»£ç çš„å‰ææ¡ä»¶ï¼Œä½ ä¸€å®šè¦å¤šèŠ±äº›ç²¾åŠ›ææ‡‚å®ƒä»¬ã€‚</p><h2>æ¶ˆè´¹è€…ç»„çŠ¶æ€ç®¡ç†æ–¹æ³•</h2><p>æ¶ˆè´¹è€…ç»„çŠ¶æ€æ˜¯å¾ˆé‡è¦çš„ä¸€ç±»å…ƒæ•°æ®ã€‚ç®¡ç†çŠ¶æ€çš„æ–¹æ³•ï¼Œè¦åšçš„äº‹æƒ…ä¹Ÿå°±æ˜¯è®¾ç½®å’ŒæŸ¥è¯¢ã€‚è¿™äº›æ–¹æ³•å¤§å¤šæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒä»¬æ±‡æ€»åœ¨ä¸€èµ·ï¼Œç›´æ¥ä»‹ç»ç»™ä½ ã€‚</p><pre><code>// GroupMetadata.scala\n// è®¾ç½®/æ›´æ–°çŠ¶æ€\ndef transitionTo(groupState: GroupState): Unit = {\n  assertValidTransition(groupState) // ç¡®ä¿æ˜¯åˆæ³•çš„çŠ¶æ€è½¬æ¢\n  state = groupState  // è®¾ç½®çŠ¶æ€åˆ°ç»™å®šçŠ¶æ€\n  currentStateTimestamp = Some(time.milliseconds() // æ›´æ–°çŠ¶æ€å˜æ›´æ—¶é—´æˆ³\n// æŸ¥è¯¢çŠ¶æ€\ndef currentState = state\n// åˆ¤æ–­æ¶ˆè´¹è€…ç»„çŠ¶æ€æ˜¯æŒ‡å®šçŠ¶æ€\ndef is(groupState: GroupState) = state == groupState\n// åˆ¤æ–­æ¶ˆè´¹è€…ç»„çŠ¶æ€ä¸æ˜¯æŒ‡å®šçŠ¶æ€\ndef not(groupState: GroupState) = state != groupState\n// æ¶ˆè´¹è€…ç»„èƒ½å¦Rebalanceçš„æ¡ä»¶æ˜¯å½“å‰çŠ¶æ€æ˜¯PreparingRebalanceçŠ¶æ€çš„åˆæ³•å‰ç½®çŠ¶æ€\ndef canRebalance = PreparingRebalance.validPreviousStates.contains(state)\n</code></pre><p><strong>1.transitionToæ–¹æ³•</strong></p><p>transitionToæ–¹æ³•çš„ä½œç”¨æ˜¯<strong>å°†æ¶ˆè´¹è€…ç»„çŠ¶æ€å˜æ›´æˆç»™å®šçŠ¶æ€</strong>ã€‚åœ¨å˜æ›´å‰ï¼Œä»£ç éœ€è¦ç¡®ä¿è¿™æ¬¡å˜æ›´å¿…é¡»æ˜¯åˆæ³•çš„çŠ¶æ€è½¬æ¢ã€‚è¿™æ˜¯ä¾é æ¯ä¸ªGroupStateå®ç°ç±»å®šä¹‰çš„<strong>validPreviousStatesé›†åˆ</strong>æ¥å®Œæˆçš„ã€‚åªæœ‰åœ¨è¿™ä¸ªé›†åˆä¸­çš„çŠ¶æ€ï¼Œæ‰æ˜¯åˆæ³•çš„å‰ç½®çŠ¶æ€ã€‚ç®€å•æ¥è¯´ï¼Œåªæœ‰é›†åˆä¸­çš„è¿™äº›çŠ¶æ€ï¼Œæ‰èƒ½è½¬æ¢åˆ°å½“å‰çŠ¶æ€ã€‚</p><!-- [[[read_end]]] --><p>åŒæ—¶ï¼Œè¯¥æ–¹æ³•è¿˜ä¼š<strong>æ›´æ–°çŠ¶æ€å˜æ›´çš„æ—¶é—´æˆ³å­—æ®µ</strong>ã€‚Kafkaæœ‰ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä¼šå®šæœŸæ¸…é™¤è¿‡æœŸçš„æ¶ˆè´¹è€…ç»„ä½ç§»æ•°æ®ï¼Œå®ƒå°±æ˜¯ä¾é è¿™ä¸ªæ—¶é—´æˆ³å­—æ®µï¼Œæ¥åˆ¤æ–­è¿‡æœŸä¸å¦çš„ã€‚</p><p><strong>2.canRebalanceæ–¹æ³•</strong></p><p>å®ƒç”¨äºåˆ¤æ–­æ¶ˆè´¹è€…ç»„æ˜¯å¦èƒ½å¤Ÿå¼€å¯Rebalanceæ“ä½œã€‚åˆ¤æ–­ä¾æ®æ˜¯ï¼Œ<strong>å½“å‰çŠ¶æ€æ˜¯å¦æ˜¯PreparingRebalanceçŠ¶æ€çš„åˆæ³•å‰ç½®çŠ¶æ€</strong>ã€‚åªæœ‰<strong>Stable</strong>ã€<strong>CompletingRebalance</strong>å’Œ<strong>Empty</strong>è¿™3ç±»çŠ¶æ€çš„æ¶ˆè´¹è€…ç»„ï¼Œæ‰æœ‰èµ„æ ¼å¼€å¯Rebalanceã€‚</p><p><strong>3.iså’Œnotæ–¹æ³•</strong></p><p>è‡³äºiså’Œnotæ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«åˆ¤æ–­æ¶ˆè´¹è€…ç»„çš„çŠ¶æ€ä¸ç»™å®šçŠ¶æ€å»åˆè¿˜æ˜¯ä¸å»åˆï¼Œä¸»è¦è¢«ç”¨äº<strong>æ‰§è¡ŒçŠ¶æ€æ ¡éªŒ</strong>ã€‚ç‰¹åˆ«æ˜¯isæ–¹æ³•ï¼Œè¢«å¤§é‡ç”¨äºä¸Šå±‚è°ƒç”¨ä»£ç ä¸­ï¼Œæ‰§è¡Œå„ç±»æ¶ˆè´¹è€…ç»„ç®¡ç†ä»»åŠ¡çš„å‰ç½®çŠ¶æ€æ ¡éªŒå·¥ä½œã€‚</p><p>æ€»ä½“æ¥è¯´ï¼Œç®¡ç†æ¶ˆè´¹è€…ç»„çŠ¶æ€æ•°æ®ï¼Œä¾é çš„å°±æ˜¯è¿™äº›æ–¹æ³•ï¼Œè¿˜æ˜¯å¾ˆç®€å•çš„å§ï¼Ÿ</p><h2>æˆå‘˜ç®¡ç†æ–¹æ³•</h2><p>åœ¨ä»‹ç»ç®¡ç†æ¶ˆè´¹è€…ç»„æˆå‘˜çš„æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘å…ˆå¸®ä½ å›å¿†ä¸‹GroupMetadataä¸­ä¿å­˜æˆå‘˜çš„å­—æ®µã€‚GroupMetadataä¸­ä½¿ç”¨memberså­—æ®µä¿å­˜æ‰€æœ‰çš„æˆå‘˜ä¿¡æ¯ã€‚è¯¥å­—æ®µæ˜¯ä¸€ä¸ªHashMapï¼ŒKeyæ˜¯æˆå‘˜çš„member IDå­—æ®µï¼ŒValueæ˜¯MemberMetadataç±»å‹ï¼Œè¯¥ç±»å‹ä¿å­˜äº†æˆå‘˜çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚</p><p>æ‰€è°“çš„ç®¡ç†æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ æˆå‘˜ï¼ˆaddæ–¹æ³•ï¼‰ã€ç§»é™¤æˆå‘˜ï¼ˆremoveæ–¹æ³•ï¼‰å’ŒæŸ¥è¯¢æˆå‘˜ï¼ˆhasã€getã€sizeæ–¹æ³•ç­‰ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é€ä¸€æ¥å­¦ä¹ ã€‚</p><h3>æ·»åŠ æˆå‘˜</h3><p>å…ˆè¯´æ·»åŠ æˆå‘˜çš„æ–¹æ³•ï¼šaddã€‚addæ–¹æ³•çš„ä¸»è¦é€»è¾‘ï¼Œæ˜¯å°†æˆå‘˜å¯¹è±¡æ·»åŠ åˆ°memberså­—æ®µï¼ŒåŒæ—¶æ›´æ–°å…¶ä»–ä¸€äº›å¿…è¦çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚Leaderæˆå‘˜å­—æ®µã€åˆ†åŒºåˆ†é…ç­–ç•¥æ”¯æŒç¥¨æ•°ç­‰ã€‚ä¸‹é¢æ˜¯addæ–¹æ³•çš„æºç ï¼š</p><pre><code>def add(member: MemberMetadata, callback: JoinCallback = null): Unit = {\n  // å¦‚æœæ˜¯è¦æ·»åŠ çš„ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…ç»„æˆå‘˜\n  if (members.isEmpty)\n    // å°±æŠŠè¯¥æˆå‘˜çš„procotolTypeè®¾ç½®ä¸ºæ¶ˆè´¹è€…ç»„çš„protocolType\n    this.protocolType = Some(member.protocolType)\n  // ç¡®ä¿æˆå‘˜å…ƒæ•°æ®ä¸­çš„groupIdå’Œç»„Idç›¸åŒ\n  assert(groupId == member.groupId)\n  // ç¡®ä¿æˆå‘˜å…ƒæ•°æ®ä¸­çš„protoclTypeå’Œç»„protocolTypeç›¸åŒ\n  assert(this.protocolType.orNull == member.protocolType)\n  // ç¡®ä¿è¯¥æˆå‘˜é€‰å®šçš„åˆ†åŒºåˆ†é…ç­–ç•¥ä¸ç»„é€‰å®šçš„åˆ†åŒºåˆ†é…ç­–ç•¥ç›¸åŒ¹é…\n  assert(supportsProtocols(member.protocolType, MemberMetadata.plainProtocolSet(member.supportedProtocols)))\n  // å¦‚æœå°šæœªé€‰å‡ºLeaderæˆå‘˜\n  if (leaderId.isEmpty)\n    // æŠŠè¯¥æˆå‘˜è®¾å®šä¸ºLeaderæˆå‘˜\n    leaderId = Some(member.memberId)\n  // å°†è¯¥æˆå‘˜æ·»åŠ è¿›members\n  members.put(member.memberId, member)\n  // æ›´æ–°åˆ†åŒºåˆ†é…ç­–ç•¥æ”¯æŒç¥¨æ•°\n  member.supportedProtocols.foreach{ case (protocol, _) =&gt; supportedProtocols(protocol) += 1 }\n  // è®¾ç½®æˆå‘˜åŠ å…¥ç»„åçš„å›è°ƒé€»è¾‘\n  member.awaitingJoinCallback = callback\n  // æ›´æ–°å·²åŠ å…¥ç»„çš„æˆå‘˜æ•°\n  if (member.isAwaitingJoin)\n    numMembersAwaitingJoin += 1\n}\n</code></pre><p>æˆ‘å†ç”»ä¸€å¼ æµç¨‹å›¾ï¼Œå¸®åŠ©ä½ æ›´ç›´è§‚åœ°ç†è§£è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/67/d5/679b34908b9d3cf7e10905fcf96e69d5.jpg?wh=1312*4544\" alt=\"\"></p><p>æˆ‘å†å…·ä½“è§£é‡Šä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œaddæ–¹æ³•è¦åˆ¤æ–­memberså­—æ®µæ˜¯å¦åŒ…å«å·²æœ‰æˆå‘˜ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±è¯´æ˜è¦æ·»åŠ çš„æˆå‘˜æ˜¯è¯¥æ¶ˆè´¹è€…ç»„çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œé‚£ä¹ˆï¼Œå°±ä»¤è¯¥æˆå‘˜åè®®ç±»å‹ï¼ˆprotocolTypeï¼‰æˆä¸ºç»„çš„protocolTypeã€‚æˆ‘åœ¨ä¸ŠèŠ‚è¯¾ä¸­è®²è¿‡ï¼Œå¯¹äºæ™®é€šçš„æ¶ˆè´¹è€…è€Œè¨€ï¼ŒprotocolTypeå°±æ˜¯å­—ç¬¦ä¸²\"consumer\"ã€‚å¦‚æœä¸æ˜¯é¦–ä¸ªæˆå‘˜ï¼Œå°±è¿›å…¥åˆ°ä¸‹ä¸€æ­¥ã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œaddæ–¹æ³•ä¼šè¿ç»­è¿›è¡Œä¸‰æ¬¡æ ¡éªŒï¼Œåˆ†åˆ«ç¡®ä¿<strong>å¾…æ·»åŠ æˆå‘˜çš„ç»„IDã€protocolType</strong>å’Œç»„é…ç½®ä¸€è‡´ï¼Œä»¥åŠè¯¥æˆå‘˜é€‰å®šçš„åˆ†åŒºåˆ†é…ç­–ç•¥ä¸ç»„é€‰å®šçš„åˆ†åŒºåˆ†é…ç­–ç•¥ç›¸åŒ¹é…ã€‚å¦‚æœè¿™äº›æ ¡éªŒæœ‰ä»»ä½•ä¸€ä¸ªæœªé€šè¿‡ï¼Œå°±ä¼šç«‹å³æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œåˆ¤æ–­æ¶ˆè´¹è€…ç»„çš„Leaderæˆå‘˜æ˜¯å¦å·²ç»é€‰å‡ºäº†ã€‚å¦‚æœè¿˜æ²¡æœ‰é€‰å‡ºï¼Œå°±å°†è¯¥æˆå‘˜è®¾ç½®æˆLeaderæˆå‘˜ã€‚å½“ç„¶äº†ï¼Œå¦‚æœLeaderå·²ç»é€‰å‡ºäº†ï¼Œè‡ªç„¶å°±ä¸éœ€è¦åšè¿™ä¸€æ­¥äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„Leaderå’Œæˆ‘ä»¬åœ¨å­¦ä¹ å‰¯æœ¬ç®¡ç†å™¨æ—¶å­¦åˆ°çš„Leaderå‰¯æœ¬æ˜¯ä¸åŒçš„æ¦‚å¿µã€‚è¿™é‡Œçš„Leaderæˆå‘˜ï¼Œæ˜¯æŒ‡<strong>æ¶ˆè´¹è€…ç»„ä¸‹çš„ä¸€ä¸ªæˆå‘˜</strong>ã€‚è¯¥æˆå‘˜è´Ÿè´£ä¸ºæ‰€æœ‰æˆå‘˜åˆ¶å®šåˆ†åŒºåˆ†é…æ–¹æ¡ˆï¼Œåˆ¶å®šæ–¹æ³•çš„ä¾æ®ï¼Œå°±æ˜¯æ¶ˆè´¹è€…ç»„é€‰å®šçš„åˆ†åŒºåˆ†é…ç­–ç•¥ã€‚</p><p>ç¬¬å››æ­¥ï¼Œæ›´æ–°æ¶ˆè´¹è€…ç»„åˆ†åŒºåˆ†é…ç­–ç•¥æ”¯æŒç¥¨æ•°ã€‚å…³äºsupportedProtocolså­—æ®µçš„å«ä¹‰ï¼Œæˆ‘åœ¨ä¸ŠèŠ‚è¯¾çš„æœ«å°¾ç”¨ä¸€ä¸ªä¾‹å­å½¢è±¡åœ°è¿›è¡Œäº†è¯´æ˜ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤è¯´äº†ã€‚å¦‚æœä½ æ²¡æœ‰å°è±¡äº†ï¼Œå¯ä»¥å†å¤ä¹ ä¸€ä¸‹ã€‚</p><p>æœ€åä¸€æ­¥ï¼Œè®¾ç½®æˆå‘˜åŠ å…¥ç»„åçš„å›è°ƒé€»è¾‘ï¼ŒåŒæ—¶æ›´æ–°å·²åŠ å…¥ç»„çš„æˆå‘˜æ•°ã€‚è‡³æ­¤ï¼Œæ–¹æ³•ç»“æŸã€‚</p><p>ä½œä¸ºå…³é”®çš„æˆå‘˜ç®¡ç†æ–¹æ³•ä¹‹ä¸€ï¼Œaddæ–¹æ³•æ˜¯å®ç°æ¶ˆè´¹è€…ç»„Rebalanceæµç¨‹è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚æ¯å½“Rebalanceå¼€å¯ç¬¬ä¸€å¤§æ­¥â€”â€”åŠ å…¥ç»„çš„æ“ä½œæ—¶ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨åˆ©ç”¨è¿™ä¸ªaddæ–¹æ³•å®ç°æ–°æˆå‘˜å…¥ç»„çš„é€»è¾‘ã€‚</p><h3>ç§»é™¤æˆå‘˜</h3><p>æœ‰addæ–¹æ³•ï¼Œè‡ªç„¶ä¹Ÿå°±æœ‰removeæ–¹æ³•ï¼Œä¸‹é¢æ˜¯removeæ–¹æ³•çš„å®Œæ•´æºç ï¼š</p><pre><code>def remove(memberId: String): Unit = {\n  // ä»membersä¸­ç§»é™¤ç»™å®šæˆå‘˜\n  members.remove(memberId).foreach { member =&gt;\n    // æ›´æ–°åˆ†åŒºåˆ†é…ç­–ç•¥æ”¯æŒç¥¨æ•°\n    member.supportedProtocols.foreach{ case (protocol, _) =&gt; supportedProtocols(protocol) -= 1 }\n    // æ›´æ–°å·²åŠ å…¥ç»„çš„æˆå‘˜æ•°\n    if (member.isAwaitingJoin)\n      numMembersAwaitingJoin -= 1\n  }\n  // å¦‚æœè¯¥æˆå‘˜æ˜¯Leaderï¼Œé€‰æ‹©å‰©ä¸‹æˆå‘˜åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªä½œä¸ºæ–°çš„Leaderæˆå‘˜\n  if (isLeader(memberId))\n    leaderId = members.keys.headOption\n}\n</code></pre><p>removeæ–¹æ³•æ¯”addè¦ç®€å•ä¸€äº›ã€‚<strong>é¦–å…ˆ</strong>ï¼Œä»£ç ä»membersä¸­ç§»é™¤ç»™å®šæˆå‘˜ã€‚<strong>ä¹‹å</strong>ï¼Œæ›´æ–°åˆ†åŒºåˆ†é…ç­–ç•¥æ”¯æŒç¥¨æ•°ï¼Œä»¥åŠæ›´æ–°å·²åŠ å…¥ç»„çš„æˆå‘˜æ•°ã€‚<strong>æœ€å</strong>ï¼Œä»£ç åˆ¤æ–­è¯¥æˆå‘˜æ˜¯å¦æ˜¯Leaderæˆå‘˜ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±é€‰æ‹©æˆå‘˜åˆ—è¡¨ä¸­å°šå­˜çš„ç¬¬ä¸€ä¸ªæˆå‘˜ä½œä¸ºæ–°çš„Leaderæˆå‘˜ã€‚</p><h3>æŸ¥è¯¢æˆå‘˜</h3><p>æŸ¥è¯¢membersçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¤§å¤šéƒ½æ˜¯å¾ˆç®€å•çš„åœºæ™¯ã€‚æˆ‘ç»™ä½ ä»‹ç»3ä¸ªæ¯”è¾ƒå¸¸è§çš„ã€‚</p><pre><code>def has(memberId: String) = members.contains(memberId)\ndef get(memberId: String) = members(memberId)\ndef size = members.size\n</code></pre><ul>\n<li>hasæ–¹æ³•ï¼Œåˆ¤æ–­æ¶ˆè´¹è€…ç»„æ˜¯å¦åŒ…å«æŒ‡å®šæˆå‘˜ï¼›</li>\n<li>getæ–¹æ³•ï¼Œè·å–æŒ‡å®šæˆå‘˜å¯¹è±¡ï¼›</li>\n<li>sizeæ–¹æ³•ï¼Œç»Ÿè®¡æ€»æˆå‘˜æ•°ã€‚</li>\n</ul><p>å…¶å®ƒçš„æŸ¥è¯¢æ–¹æ³•é€»è¾‘ä¹Ÿéƒ½å¾ˆç®€å•ï¼Œæ¯”å¦‚allMemberMetadataã€rebalanceTimeoutMsï¼Œç­‰ç­‰ï¼Œæˆ‘å°±ä¸å¤šè®²äº†ã€‚è¯¾åä½ å¯ä»¥è‡ªè¡Œé˜…è¯»ä¸‹ï¼Œé‡ç‚¹æ˜¯ä½“ä¼šè¿™äº›æ–¹æ³•åˆ©ç”¨memberséƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚</p><h2>ä½ç§»ç®¡ç†æ–¹æ³•</h2><p>é™¤äº†ç»„çŠ¶æ€å’Œæˆå‘˜ç®¡ç†ä¹‹å¤–ï¼ŒGroupMetadataè¿˜æœ‰ä¸€å¤§ç±»ç®¡ç†åŠŸèƒ½ï¼Œå°±æ˜¯<strong>ç®¡ç†æ¶ˆè´¹è€…ç»„çš„æäº¤ä½ç§»</strong>ï¼ˆCommitted Offsetsï¼‰ï¼Œä¸»è¦åŒ…æ‹¬æ·»åŠ å’Œç§»é™¤ä½ç§»å€¼ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨å­¦ä¹ ç®¡ç†ä½ç§»çš„åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘å†å¸¦ä½ å›é¡¾ä¸€ä¸‹ä¿å­˜ä½ç§»çš„offsetså­—æ®µçš„å®šä¹‰ã€‚æ¯•ç«Ÿï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å­¦ä¹ çš„æ–¹æ³•ï¼Œä¸»è¦æ“ä½œçš„å°±æ˜¯è¿™ä¸ªå­—æ®µã€‚</p><pre><code>private val offsets = new mutable.HashMap[TopicPartition, CommitRecordMetadataAndOffset]\n</code></pre><p>å®ƒæ˜¯HashMapç±»å‹ï¼ŒKeyæ˜¯TopicPartitionç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªä¸»é¢˜åˆ†åŒºï¼Œè€ŒValueæ˜¯CommitRecordMetadataAndOffsetç±»å‹ã€‚è¯¥ç±»å°è£…äº†ä½ç§»æäº¤æ¶ˆæ¯çš„ä½ç§»å€¼ã€‚</p><p>åœ¨è¯¦ç»†é˜…è¯»ä½ç§»ç®¡ç†æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘å…ˆè§£é‡Šä¸‹è¿™é‡Œçš„â€œä½ç§»â€å’Œâ€œä½ç§»æäº¤æ¶ˆæ¯â€ã€‚</p><p>æ¶ˆè´¹è€…ç»„éœ€è¦å‘Coordinatoræäº¤å·²æ¶ˆè´¹æ¶ˆæ¯çš„è¿›åº¦ï¼Œåœ¨Kafkaä¸­ï¼Œè¿™ä¸ªè¿›åº¦æœ‰ä¸ªä¸“é—¨çš„æœ¯è¯­ï¼Œå«ä½œæäº¤ä½ç§»ã€‚Kafkaä½¿ç”¨å®ƒæ¥å®šä½æ¶ˆè´¹è€…ç»„è¦æ¶ˆè´¹çš„ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚é‚£ä¹ˆï¼Œæäº¤ä½ç§»åœ¨Coordinatorç«¯æ˜¯å¦‚ä½•ä¿å­˜çš„å‘¢ï¼Ÿå®ƒå®é™…ä¸Šæ˜¯ä¿å­˜åœ¨å†…éƒ¨ä½ç§»ä¸»é¢˜ä¸­ã€‚æäº¤çš„æ–¹å¼æ˜¯ï¼Œæ¶ˆè´¹è€…ç»„æˆå‘˜å‘å†…éƒ¨ä¸»é¢˜å†™å…¥ç¬¦åˆç‰¹å®šæ ¼å¼çš„äº‹ä»¶æ¶ˆæ¯ï¼Œè¿™ç±»æ¶ˆæ¯å°±æ˜¯æ‰€è°“çš„ä½ç§»æäº¤æ¶ˆæ¯ï¼ˆCommit Recordï¼‰ã€‚å…³äºä½ç§»æäº¤æ¶ˆæ¯çš„äº‹ä»¶æ ¼å¼ï¼Œæˆ‘ä¼šåœ¨ç¬¬30è®²å…·ä½“ä»‹ç»ï¼Œè¿™é‡Œä½ å¯ä»¥æš‚æ—¶ä¸ç”¨ç†ä¼šã€‚è€Œè¿™é‡Œæ‰€è¯´çš„CommitRecordMetadataAndOffsetç±»ï¼Œå°±æ˜¯æ ‡è¯†ä½ç§»æäº¤æ¶ˆæ¯çš„åœ°æ–¹ã€‚æˆ‘ä»¬çœ‹ä¸‹å®ƒçš„ä»£ç ï¼š</p><pre><code>case class CommitRecordMetadataAndOffset(appendedBatchOffset: Option[Long], offsetAndMetadata: OffsetAndMetadata) {\n  def olderThan(that: CommitRecordMetadataAndOffset): Boolean = appendedBatchOffset.get &lt; that.appendedBatchOffset.get\n}\n</code></pre><p>è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ã€‚</p><ul>\n<li>appendedBatchOffsetï¼šä¿å­˜çš„æ˜¯ä½ç§»ä¸»é¢˜æ¶ˆæ¯è‡ªå·±çš„ä½ç§»å€¼ï¼›</li>\n<li>offsetAndMetadataï¼šä¿å­˜çš„æ˜¯ä½ç§»æäº¤æ¶ˆæ¯ä¸­ä¿å­˜çš„æ¶ˆè´¹è€…ç»„çš„ä½ç§»å€¼ã€‚</li>\n</ul><h3>æ·»åŠ ä½ç§»å€¼</h3><p>åœ¨GroupMetadataä¸­ï¼Œæœ‰3ä¸ªå‘offsetsä¸­æ·»åŠ è®¢é˜…åˆ†åŒºçš„å·²æ¶ˆè´¹ä½ç§»å€¼çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯initializeOffsetsã€onOffsetCommitAppendå’ŒcompletePendingTxnOffsetCommitã€‚</p><p>initializeOffsetsæ–¹æ³•çš„ä»£ç éå¸¸ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>def initializeOffsets(\n  offsets: collection.Map[TopicPartition, CommitRecordMetadataAndOffset],\n  pendingTxnOffsets: Map[Long, mutable.Map[TopicPartition, CommitRecordMetadataAndOffset]]): Unit = {\n  this.offsets ++= offsets\n  this.pendingTransactionalOffsetCommits ++= pendingTxnOffsets\n}\n</code></pre><p>å®ƒä»…ä»…æ˜¯å°†ç»™å®šçš„ä¸€ç»„è®¢é˜…åˆ†åŒºæäº¤ä½ç§»å€¼åŠ åˆ°offsetsä¸­ã€‚å½“ç„¶ï¼ŒåŒæ—¶å®ƒè¿˜ä¼šæ›´æ–°pendingTransactionalOffsetCommitså­—æ®µã€‚</p><p>ä¸è¿‡ï¼Œç”±äºè¿™ä¸ªå­—æ®µæ˜¯ç»™Kafkaäº‹åŠ¡æœºåˆ¶ä½¿ç”¨çš„ï¼Œå› æ­¤ï¼Œä½ åªéœ€è¦å…³æ³¨è¿™ä¸ªæ–¹æ³•çš„ç¬¬ä¸€è¡Œè¯­å¥å°±è¡Œäº†ã€‚å½“æ¶ˆè´¹è€…ç»„çš„åè°ƒè€…ç»„ä»¶å¯åŠ¨æ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå®šæœŸåœ°è¯»å–ä½ç§»ä¸»é¢˜ä¸­ç›¸åº”æ¶ˆè´¹è€…ç»„çš„æäº¤ä½ç§»æ•°æ®ï¼Œå¹¶æŠŠå®ƒä»¬åŠ è½½åˆ°offsetså­—æ®µä¸­ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒä¸ªæ–¹æ³•ï¼ŒonOffsetCommitAppendçš„ä»£ç ã€‚</p><pre><code>def onOffsetCommitAppend(topicPartition: TopicPartition, offsetWithCommitRecordMetadata: CommitRecordMetadataAndOffset): Unit = {\n  if (pendingOffsetCommits.contains(topicPartition)) {\n    if (offsetWithCommitRecordMetadata.appendedBatchOffset.isEmpty)\n      throw new IllegalStateException(&quot;Cannot complete offset commit write without providing the metadata of the record &quot; +\n        &quot;in the log.&quot;)\n    // offsetså­—æ®µä¸­æ²¡æœ‰è¯¥åˆ†åŒºä½ç§»æäº¤æ•°æ®ï¼Œæˆ–è€…\n    // offsetså­—æ®µä¸­è¯¥åˆ†åŒºå¯¹åº”çš„æäº¤ä½ç§»æ¶ˆæ¯åœ¨ä½ç§»ä¸»é¢˜ä¸­çš„ä½ç§»å€¼å°äºå¾…å†™å…¥çš„ä½ç§»å€¼\n    if (!offsets.contains(topicPartition) || offsets(topicPartition).olderThan(offsetWithCommitRecordMetadata))\n      // å°†è¯¥åˆ†åŒºå¯¹åº”çš„æäº¤ä½ç§»æ¶ˆæ¯æ·»åŠ åˆ°offsetsä¸­\n      offsets.put(topicPartition, offsetWithCommitRecordMetadata)\n  }\n  pendingOffsetCommits.get(topicPartition) match {\n    case Some(stagedOffset) if offsetWithCommitRecordMetadata.offsetAndMetadata == stagedOffset =&gt;\n      pendingOffsetCommits.remove(topicPartition)\n    case _ =&gt;\n  }\n}\n</code></pre><p>è¯¥æ–¹æ³•åœ¨æäº¤ä½ç§»æ¶ˆæ¯è¢«æˆåŠŸå†™å…¥åè°ƒç”¨ã€‚ä¸»è¦åˆ¤æ–­çš„ä¾æ®ï¼Œæ˜¯offsetsä¸­æ˜¯å¦å·²åŒ…å«è¯¥ä¸»é¢˜åˆ†åŒºå¯¹åº”çš„æ¶ˆæ¯å€¼ï¼Œæˆ–è€…è¯´ï¼Œoffsetså­—æ®µä¸­è¯¥åˆ†åŒºå¯¹åº”çš„æäº¤ä½ç§»æ¶ˆæ¯åœ¨ä½ç§»ä¸»é¢˜ä¸­çš„ä½ç§»å€¼æ˜¯å¦å°äºå¾…å†™å…¥çš„ä½ç§»å€¼ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå°±æŠŠè¯¥ä¸»é¢˜å·²æäº¤çš„ä½ç§»å€¼æ·»åŠ åˆ°offsetsä¸­ã€‚</p><p>ç¬¬ä¸‰ä¸ªæ–¹æ³•completePendingTxnOffsetCommitçš„ä½œç”¨æ˜¯å®Œæˆä¸€ä¸ªå¾…å†³äº‹åŠ¡ï¼ˆPending Transactionï¼‰çš„ä½ç§»æäº¤ã€‚æ‰€è°“çš„å¾…å†³äº‹åŠ¡ï¼Œå°±æ˜¯æŒ‡æ­£åœ¨è¿›è¡Œä¸­ã€è¿˜æ²¡æœ‰å®Œæˆçš„äº‹åŠ¡ã€‚åœ¨å¤„ç†å¾…å†³äº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å°†å¾…å†³äº‹åŠ¡ä¸­æ¶‰åŠåˆ°çš„åˆ†åŒºçš„ä½ç§»å€¼æ·»åŠ åˆ°offsetsä¸­çš„æƒ…å†µã€‚ä¸è¿‡ï¼Œç”±äºè¯¥æ–¹æ³•æ˜¯ä¸Kafkaäº‹åŠ¡æ¯æ¯ç›¸å…³çš„ï¼Œä½ ä¸éœ€è¦é‡ç‚¹æŒæ¡ï¼Œè¿™é‡Œæˆ‘å°±ä¸å±•å¼€è¯´äº†ã€‚</p><h3>ç§»é™¤ä½ç§»å€¼</h3><p>offsetsä¸­è®¢é˜…åˆ†åŒºçš„å·²æ¶ˆè´¹ä½ç§»å€¼ä¹Ÿæ˜¯èƒ½å¤Ÿè¢«ç§»é™¤çš„ã€‚ä½ è¿˜è®°å¾—ï¼ŒKafkaä¸»é¢˜ä¸­çš„æ¶ˆæ¯æœ‰é»˜è®¤çš„ç•™å­˜æ—¶é—´è®¾ç½®å—ï¼Ÿä½ç§»ä¸»é¢˜æ˜¯æ™®é€šçš„Kafkaä¸»é¢˜ï¼Œæ‰€ä»¥ä¹Ÿè¦éµå®ˆç›¸åº”çš„è§„å®šã€‚å¦‚æœå½“å‰æ—¶é—´ä¸å·²æäº¤ä½ç§»æ¶ˆæ¯æ—¶é—´æˆ³çš„å·®å€¼ï¼Œè¶…è¿‡äº†Brokerç«¯å‚æ•°offsets.retention.minuteså€¼ï¼ŒKafkaå°±ä¼šå°†è¿™æ¡è®°å½•ä»offsetså­—æ®µä¸­ç§»é™¤ã€‚è¿™å°±æ˜¯æ–¹æ³•removeExpiredOffsetsè¦åšçš„äº‹æƒ…ã€‚</p><p>è¿™ä¸ªæ–¹æ³•çš„ä»£ç æœ‰ç‚¹é•¿ï¼Œä¸ºäº†æ–¹ä¾¿ä½ æŒæ¡ï¼Œæˆ‘åˆ†å—ç»™ä½ ä»‹ç»ä¸‹ã€‚æˆ‘å…ˆå¸¦ä½ äº†è§£ä¸‹å®ƒçš„å†…éƒ¨åµŒå¥—ç±»æ–¹æ³•getExpireOffsetsï¼Œç„¶åå†æ·±å…¥äº†è§£å®ƒçš„å®ç°é€»è¾‘ï¼Œè¿™æ ·ä½ å°±èƒ½å¾ˆè½»æ¾åœ°æŒæ¡Kafkaç§»é™¤ä½ç§»å€¼çš„ä»£ç åŸç†äº†ã€‚</p><p>é¦–å…ˆï¼Œè¯¥æ–¹æ³•å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨åµŒå¥—æ–¹æ³•<strong>getExpiredOffsets</strong>ï¼Œä¸“é—¨ç”¨äºè·å–è®¢é˜…åˆ†åŒºè¿‡æœŸçš„ä½ç§»å€¼ã€‚æˆ‘ä»¬æ¥é˜…è¯»ä¸‹æºç ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åšåˆ°çš„ã€‚</p><pre><code>def getExpiredOffsets(\n  baseTimestamp: CommitRecordMetadataAndOffset =&gt; Long,\n  subscribedTopics: Set[String] = Set.empty): Map[TopicPartition, OffsetAndMetadata] = {\n  // éå†offsetsä¸­çš„æ‰€æœ‰åˆ†åŒºï¼Œè¿‡æ»¤å‡ºåŒæ—¶æ»¡è¶³ä»¥ä¸‹3ä¸ªæ¡ä»¶çš„æ‰€æœ‰åˆ†åŒº\n  // æ¡ä»¶1ï¼šåˆ†åŒºæ‰€å±ä¸»é¢˜ä¸åœ¨è®¢é˜…ä¸»é¢˜åˆ—è¡¨ä¹‹å†…\n  // æ¡ä»¶2ï¼šè¯¥ä¸»é¢˜åˆ†åŒºå·²ç»å®Œæˆä½ç§»æäº¤\n  // æ¡ä»¶3ï¼šè¯¥ä¸»é¢˜åˆ†åŒºåœ¨ä½ç§»ä¸»é¢˜ä¸­å¯¹åº”æ¶ˆæ¯çš„å­˜åœ¨æ—¶é—´è¶…è¿‡äº†é˜ˆå€¼\n  offsets.filter {\n    case (topicPartition, commitRecordMetadataAndOffset) =&gt;\n      !subscribedTopics.contains(topicPartition.topic()) &amp;&amp;\n      !pendingOffsetCommits.contains(topicPartition) &amp;&amp; {\n        commitRecordMetadataAndOffset\n          .offsetAndMetadata.expireTimestamp match {\n          case None =&gt;\n            currentTimestamp - baseTimestamp(commitRecordMetadataAndOffset) &gt;= offsetRetentionMs\n          case Some(expireTimestamp) =&gt;\n            currentTimestamp &gt;= expireTimestamp\n        }\n      }\n  }.map {\n    // ä¸ºæ»¡è¶³ä»¥ä¸Š3ä¸ªæ¡ä»¶çš„åˆ†åŒºæå–å‡ºcommitRecordMetadataAndOffsetä¸­çš„ä½ç§»å€¼\n    case (topicPartition, commitRecordOffsetAndMetadata) =&gt;\n      (topicPartition, commitRecordOffsetAndMetadata.offsetAndMetadata)\n  }.toMap\n}\n</code></pre><p>è¯¥æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ã€‚</p><ul>\n<li>baseTimestampï¼šå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œæ¥æ”¶CommitRecordMetadataAndOffsetç±»å‹çš„å­—æ®µï¼Œç„¶åè®¡ç®—æ—¶é—´æˆ³ï¼Œå¹¶è¿”å›ï¼›</li>\n<li>subscribedTopicsï¼šå³è®¢é˜…ä¸»é¢˜é›†åˆï¼Œé»˜è®¤æ˜¯ç©ºã€‚</li>\n</ul><p>æ–¹æ³•å¼€å§‹æ—¶ï¼Œä»£ç ä»offsetså­—æ®µä¸­è¿‡æ»¤å‡ºåŒæ—¶æ»¡è¶³3ä¸ªæ¡ä»¶çš„æ‰€æœ‰åˆ†åŒºã€‚</p><p><strong>æ¡ä»¶1</strong>ï¼šåˆ†åŒºæ‰€å±ä¸»é¢˜ä¸åœ¨è®¢é˜…ä¸»é¢˜åˆ—è¡¨ä¹‹å†…ã€‚å½“æ–¹æ³•ä¼ å…¥äº†ä¸ä¸ºç©ºçš„ä¸»é¢˜é›†åˆæ—¶ï¼Œå°±è¯´æ˜è¯¥æ¶ˆè´¹è€…ç»„æ­¤æ—¶æ­£åœ¨æ¶ˆè´¹ä¸­ï¼Œæ­£åœ¨æ¶ˆè´¹çš„ä¸»é¢˜æ˜¯ä¸èƒ½æ‰§è¡Œè¿‡æœŸä½ç§»ç§»é™¤çš„ã€‚</p><p><strong>æ¡ä»¶2</strong>ï¼šä¸»é¢˜åˆ†åŒºå·²ç»å®Œæˆä½ç§»æäº¤ï¼Œé‚£ç§å¤„äºæäº¤ä¸­çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜åœ¨pendingOffsetCommitså­—æ®µä¸­çš„åˆ†åŒºï¼Œä¸äºˆè€ƒè™‘ã€‚</p><p><strong>æ¡ä»¶3</strong>ï¼šè¯¥ä¸»é¢˜åˆ†åŒºåœ¨ä½ç§»ä¸»é¢˜ä¸­å¯¹åº”æ¶ˆæ¯çš„å­˜åœ¨æ—¶é—´è¶…è¿‡äº†é˜ˆå€¼ã€‚è€ç‰ˆæœ¬çš„Kafkaæ¶ˆæ¯ç›´æ¥æŒ‡å®šäº†è¿‡æœŸæ—¶é—´æˆ³ï¼Œå› æ­¤ï¼Œåªéœ€è¦åˆ¤æ–­å½“å‰æ—¶é—´æ˜¯å¦è¶Šè¿‡äº†è¿™ä¸ªè¿‡æœŸæ—¶é—´ã€‚ä½†æ˜¯ï¼Œç›®å‰ï¼Œæ–°ç‰ˆKafkaåˆ¤æ–­è¿‡æœŸä¸å¦ï¼Œä¸»è¦æ˜¯<strong>åŸºäºæ¶ˆè´¹è€…ç»„çŠ¶æ€</strong>ã€‚å¦‚æœæ˜¯EmptyçŠ¶æ€ï¼Œè¿‡æœŸçš„åˆ¤æ–­ä¾æ®å°±æ˜¯å½“å‰æ—¶é—´ä¸ç»„å˜ä¸ºEmptyçŠ¶æ€æ—¶é—´çš„å·®å€¼ï¼Œæ˜¯å¦è¶…è¿‡Brokerç«¯å‚æ•°offsets.retention.minuteså€¼ï¼›å¦‚æœä¸æ˜¯EmptyçŠ¶æ€ï¼Œå°±çœ‹å½“å‰æ—¶é—´ä¸æäº¤ä½ç§»æ¶ˆæ¯ä¸­çš„æ—¶é—´æˆ³å·®å€¼æ˜¯å¦è¶…è¿‡äº†offsets.retention.minuteså€¼ã€‚å¦‚æœè¶…è¿‡äº†ï¼Œå°±è§†ä¸ºå·²è¿‡æœŸï¼Œå¯¹åº”çš„ä½ç§»å€¼éœ€è¦è¢«ç§»é™¤ï¼›å¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œå°±ä¸éœ€è¦ç§»é™¤äº†ã€‚</p><p>å½“è¿‡æ»¤å‡ºåŒæ—¶æ»¡è¶³è¿™3ä¸ªæ¡ä»¶çš„åˆ†åŒºåï¼Œæå–å‡ºå®ƒä»¬å¯¹åº”çš„ä½ç§»å€¼å¯¹è±¡å¹¶è¿”å›ã€‚</p><p>å­¦è¿‡äº†getExpiredOffsetsæ–¹æ³•ä»£ç çš„å®ç°ä¹‹åï¼ŒremoveExpiredOffsetsæ–¹æ³•å‰©ä¸‹çš„ä»£ç å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p><pre><code>def removeExpiredOffsets(\n  currentTimestamp: Long, offsetRetentionMs: Long): Map[TopicPartition, OffsetAndMetadata] = {\n  // getExpiredOffsetsæ–¹æ³•ä»£ç ......\n  // è°ƒç”¨getExpiredOffsetsæ–¹æ³•è·å–ä¸»é¢˜åˆ†åŒºçš„è¿‡æœŸä½ç§»\n  val expiredOffsets: Map[TopicPartition, OffsetAndMetadata] = protocolType match {\n    case Some(_) if is(Empty) =&gt;\n      getExpiredOffsets(\n        commitRecordMetadataAndOffset =&gt; currentStateTimestamp    .getOrElse(commitRecordMetadataAndOffset.offsetAndMetadata.commitTimestamp)\n      )\n    case Some(ConsumerProtocol.PROTOCOL_TYPE) if subscribedTopics.isDefined =&gt;\n      getExpiredOffsets(\n        _.offsetAndMetadata.commitTimestamp,\n        subscribedTopics.get\n      )\n    case None =&gt;\n      getExpiredOffsets(_.offsetAndMetadata.commitTimestamp)\n    case _ =&gt;\n      Map()\n  }\n  if (expiredOffsets.nonEmpty)\n    debug(s&quot;Expired offsets from group '$groupId': ${expiredOffsets.keySet}&quot;)\n  // å°†è¿‡æœŸä½ç§»å¯¹åº”çš„ä¸»é¢˜åˆ†åŒºä»offsetsä¸­ç§»é™¤\n  offsets --= expiredOffsets.keySet\n  // è¿”å›ä¸»é¢˜åˆ†åŒºå¯¹åº”çš„è¿‡æœŸä½ç§»\n  expiredOffsets\n}\n</code></pre><p>ä»£ç æ ¹æ®æ¶ˆè´¹è€…ç»„çš„protocolTypeç±»å‹å’Œç»„çŠ¶æ€è°ƒç”¨getExpiredOffsetsæ–¹æ³•ï¼ŒåŒæ—¶å†³å®šä¼ å…¥ä»€ä¹ˆæ ·çš„å‚æ•°ï¼š</p><ul>\n<li>å¦‚æœæ¶ˆè´¹è€…ç»„çŠ¶æ€æ˜¯Emptyï¼Œå°±ä¼ å…¥ç»„å˜æ›´ä¸ºEmptyçŠ¶æ€çš„æ—¶é—´ï¼Œè‹¥è¯¥æ—¶é—´æ²¡æœ‰è¢«è®°å½•ï¼Œåˆ™ä½¿ç”¨æäº¤ä½ç§»æ¶ˆæ¯æœ¬èº«çš„å†™å…¥æ—¶é—´æˆ³ï¼Œæ¥è·å–è¿‡æœŸä½ç§»ï¼›</li>\n<li>å¦‚æœæ˜¯æ™®é€šçš„æ¶ˆè´¹è€…ç»„ç±»å‹ï¼Œä¸”è®¢é˜…ä¸»é¢˜ä¿¡æ¯å·²çŸ¥ï¼Œå°±ä¼ å…¥æäº¤ä½ç§»æ¶ˆæ¯æœ¬èº«çš„å†™å…¥æ—¶é—´æˆ³å’Œè®¢é˜…ä¸»é¢˜é›†åˆå…±åŒç¡®å®šè¿‡æœŸä½ç§»å€¼ï¼›</li>\n<li>å¦‚æœprotocolTypeä¸ºNoneï¼Œå°±è¡¨ç¤ºï¼Œè¿™ä¸ªæ¶ˆè´¹è€…ç»„å…¶å®æ˜¯ä¸€ä¸ªStandaloneæ¶ˆè´¹è€…ï¼Œä¾ç„¶æ˜¯ä¼ å…¥æäº¤ä½ç§»æ¶ˆæ¯æœ¬èº«çš„å†™å…¥æ—¶é—´æˆ³ï¼Œæ¥å†³å®šè¿‡æœŸä½ç§»å€¼ï¼›</li>\n<li>å¦‚æœæ¶ˆè´¹è€…ç»„çš„çŠ¶æ€ä¸ç¬¦åˆåˆšåˆšè¯´çš„è¿™äº›æƒ…å†µï¼Œé‚£å°±è¯´æ˜ï¼Œæ²¡æœ‰è¿‡æœŸä½ç§»å€¼éœ€è¦è¢«ç§»é™¤ã€‚</li>\n</ul><p>å½“ç¡®å®šäº†è¦è¢«ç§»é™¤çš„ä½ç§»å€¼é›†åˆåï¼Œä»£ç ä¼šå°†å®ƒä»¬ä»offsetsä¸­ç§»é™¤ï¼Œç„¶åè¿”å›è¿™äº›è¢«ç§»é™¤çš„ä½ç§»å€¼ä¿¡æ¯ã€‚è‡³æ­¤ï¼Œæ–¹æ³•ç»“æŸã€‚</p><h2>åˆ†åŒºåˆ†é…ç­–ç•¥ç®¡ç†æ–¹æ³•</h2><p>æœ€åï¼Œæˆ‘ä»¬è®¨è®ºä¸‹æ¶ˆè´¹è€…ç»„åˆ†åŒºåˆ†é…ç­–ç•¥çš„ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯å­—æ®µsupportedProtocolsçš„ç®¡ç†ã€‚supportedProtocolsæ˜¯åˆ†åŒºåˆ†é…ç­–ç•¥çš„æ”¯æŒç¥¨æ•°ï¼Œè¿™ä¸ªç¥¨æ•°åœ¨æ·»åŠ æˆå‘˜ã€ç§»é™¤æˆå‘˜æ—¶ï¼Œä¼šè¿›è¡Œç›¸åº”çš„æ›´æ–°ã€‚</p><p>æ¶ˆè´¹è€…ç»„æ¯æ¬¡Rebalanceçš„æ—¶å€™ï¼Œéƒ½è¦é‡æ–°ç¡®è®¤æœ¬æ¬¡Rebalanceç»“æŸä¹‹åï¼Œè¦ä½¿ç”¨å“ªä¸ªåˆ†åŒºåˆ†é…ç­–ç•¥ï¼Œå› æ­¤ï¼Œå°±éœ€è¦ç‰¹å®šçš„æ–¹æ³•æ¥å¯¹è¿™äº›ç¥¨æ•°è¿›è¡Œç»Ÿè®¡ï¼ŒæŠŠç¥¨æ•°æœ€å¤šçš„é‚£ä¸ªç­–ç•¥ä½œä¸ºæ–°çš„ç­–ç•¥ã€‚</p><p>GroupMetadataç±»ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•æ¥åšè¿™ä»¶äº‹æƒ…ï¼Œåˆ†åˆ«æ˜¯candidateProtocolså’ŒselectProtocolæ–¹æ³•ã€‚</p><h3>ç¡®è®¤æ¶ˆè´¹è€…ç»„æ”¯æŒçš„åˆ†åŒºåˆ†é…ç­–ç•¥é›†</h3><p>é¦–å…ˆæ¥çœ‹candidateProtocolsæ–¹æ³•ã€‚å®ƒçš„ä½œç”¨æ˜¯<strong>æ‰¾å‡ºç»„å†…æ‰€æœ‰æˆå‘˜éƒ½æ”¯æŒçš„åˆ†åŒºåˆ†é…ç­–ç•¥é›†</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>private def candidateProtocols: Set[String] = {\n  val numMembers = members.size // è·å–ç»„å†…æˆå‘˜æ•°\n  // æ‰¾å‡ºæ”¯æŒç¥¨æ•°=æ€»æˆå‘˜æ•°çš„ç­–ç•¥ï¼Œè¿”å›å®ƒä»¬çš„åç§°\n  supportedProtocols.filter(_._2 == numMembers).map(_._1).toSet\n}\n</code></pre><p>è¯¥æ–¹æ³•é¦–å…ˆä¼šè·å–ç»„å†…çš„æ€»æˆå‘˜æ•°ï¼Œç„¶åï¼Œæ‰¾å‡ºsupportedProtocolsä¸­é‚£äº›æ”¯æŒç¥¨æ•°ç­‰äºæ€»æˆå‘˜æ•°çš„åˆ†é…ç­–ç•¥ï¼Œå¹¶è¿”å›å®ƒä»¬çš„åç§°ã€‚<strong>æ”¯æŒç¥¨æ•°ç­‰äºæ€»æˆå‘˜æ•°çš„æ„æ€ï¼Œç­‰åŒäºæ‰€æœ‰æˆå‘˜éƒ½æ”¯æŒè¯¥ç­–ç•¥</strong>ã€‚</p><h3>é€‰å‡ºæ¶ˆè´¹è€…ç»„çš„åˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹selectProtocolæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯<strong>é€‰å‡ºæ¶ˆè´¹è€…ç»„çš„åˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥</strong>ã€‚</p><pre><code>def selectProtocol: String = {\n  // å¦‚æœæ²¡æœ‰ä»»ä½•æˆå‘˜ï¼Œè‡ªç„¶æ— æ³•ç¡®å®šé€‰ç”¨å“ªä¸ªç­–ç•¥\n  if (members.isEmpty)\n    throw new IllegalStateException(&quot;Cannot select protocol for empty group&quot;)\n  // è·å–æ‰€æœ‰æˆå‘˜éƒ½æ”¯æŒçš„ç­–ç•¥é›†åˆ\n  val candidates = candidateProtocols\n  // è®©æ¯ä¸ªæˆå‘˜æŠ•ç¥¨ï¼Œç¥¨æ•°æœ€å¤šçš„é‚£ä¸ªç­–ç•¥å½“é€‰\n  val (protocol, _) = allMemberMetadata\n    .map(_.vote(candidates))\n    .groupBy(identity)\n    .maxBy { case (_, votes) =&gt; votes.size }\n  protocol\n}\n</code></pre><p>è¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­ç»„å†…æ˜¯å¦æœ‰æˆå‘˜ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•æˆå‘˜ï¼Œè‡ªç„¶å°±æ— æ³•ç¡®å®šé€‰ç”¨å“ªä¸ªç­–ç•¥äº†ï¼Œæ–¹æ³•å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶é€€å‡ºã€‚å¦åˆ™çš„è¯ï¼Œä»£ç ä¼šè°ƒç”¨åˆšæ‰çš„candidateProtocolsæ–¹æ³•ï¼Œè·å–æ‰€æœ‰æˆå‘˜éƒ½æ”¯æŒçš„ç­–ç•¥é›†åˆï¼Œç„¶åè®©æ¯ä¸ªæˆå‘˜æŠ•ç¥¨ï¼Œç¥¨æ•°æœ€å¤šçš„é‚£ä¸ªç­–ç•¥å½“é€‰ã€‚</p><p>ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œè¿™é‡Œçš„voteæ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå…¶å®ï¼Œå®ƒå°±æ˜¯ç®€å•åœ°æŸ¥æ‰¾è€Œå·²ã€‚æˆ‘ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¥å¸®åŠ©ä½ ç†è§£ã€‚</p><p>æ¯”å¦‚ï¼Œcandidateså­—æ®µçš„å€¼æ˜¯[â€œç­–ç•¥Aâ€ï¼Œâ€œç­–ç•¥Bâ€]ï¼Œæˆå‘˜1æ”¯æŒ[â€œç­–ç•¥Bâ€ï¼Œâ€œç­–ç•¥Aâ€]ï¼Œæˆå‘˜2æ”¯æŒ[â€œç­–ç•¥Aâ€ï¼Œâ€œç­–ç•¥Bâ€ï¼Œâ€œç­–ç•¥Câ€]ï¼Œæˆå‘˜3æ”¯æŒ[â€œç­–ç•¥Dâ€ï¼Œâ€œç­–ç•¥Bâ€ï¼Œâ€œç­–ç•¥Aâ€]ï¼Œé‚£ä¹ˆï¼Œvoteæ–¹æ³•ä¼šå°†candidatesä¸æ¯ä¸ªæˆå‘˜çš„æ”¯æŒåˆ—è¡¨è¿›è¡Œæ¯”å¯¹ï¼Œæ‰¾å‡ºæˆå‘˜æ”¯æŒåˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªåŒ…å«åœ¨candidatesä¸­çš„ç­–ç•¥ã€‚å› æ­¤ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œæˆå‘˜1æŠ•ç¥¨ç­–ç•¥Bï¼Œæˆå‘˜2æŠ•ç¥¨ç­–ç•¥Aï¼Œæˆå‘˜3æŠ•ç¥¨ç­–ç•¥Bã€‚å¯ä»¥çœ‹åˆ°ï¼ŒæŠ•ç¥¨çš„ç»“æœæ˜¯ï¼Œç­–ç•¥Bæ˜¯ä¸¤ç¥¨ï¼Œç­–ç•¥Aæ˜¯1ç¥¨ã€‚æ‰€ä»¥ï¼ŒselectProtocolæ–¹æ³•è¿”å›ç­–ç•¥Bä½œä¸ºæ–°çš„ç­–ç•¥ã€‚</p><p>æœ‰ä¸€ç‚¹ä½ éœ€è¦æ³¨æ„ï¼Œ<strong>æˆå‘˜æ”¯æŒåˆ—è¡¨ä¸­çš„ç­–ç•¥æ˜¯æœ‰é¡ºåºçš„</strong>ã€‚è¿™å°±æ˜¯è¯´ï¼Œ[â€œç­–ç•¥Bâ€ï¼Œâ€œç­–ç•¥Aâ€]å’Œ[â€œç­–ç•¥Aâ€ï¼Œâ€œç­–ç•¥Bâ€]æ˜¯ä¸åŒçš„ï¼Œæˆå‘˜ä¼šå€¾å‘äºé€‰æ‹©é å‰çš„ç­–ç•¥ã€‚</p><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¬ç»“åˆGroupMetadataæºç ï¼Œå­¦ä¹ äº†Kafkaå¯¹æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®çš„ç®¡ç†ï¼Œä¸»è¦åŒ…æ‹¬ç»„çŠ¶æ€ã€æˆå‘˜ã€ä½ç§»å’Œåˆ†åŒºåˆ†é…ç­–ç•¥å››ä¸ªç»´åº¦ã€‚æˆ‘å»ºè®®ä½ åœ¨è¯¾ä¸‹å†ä»”ç»†åœ°é˜…è¯»ä¸€ä¸‹è¿™äº›ç®¡ç†æ•°æ®çš„æ–¹æ³•ï¼Œå¯¹ç…§ç€æºç å’Œæ³¨é‡Šèµ°ä¸€éå®Œæ•´çš„æ“ä½œæµç¨‹ã€‚</p><p>å¦å¤–ï¼Œåœ¨è¿™ä¸¤èŠ‚è¯¾ä¸­ï¼Œæˆ‘æ²¡æœ‰è°ˆåŠå¾…å†³æˆå‘˜åˆ—è¡¨ï¼ˆPending Membersï¼‰å’Œå¾…å†³ä½ç§»ï¼ˆPending Offsetsï¼‰çš„ç®¡ç†ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå…ƒæ•°æ®é¡¹å±äºä¸­é—´ä¸´æ—¶çŠ¶æ€ï¼Œå› æ­¤æˆ‘æ²¡æœ‰å±•å¼€è®²ï¼Œä¸ç†è§£è¿™éƒ¨åˆ†ä»£ç çš„è¯ï¼Œä¹Ÿä¸ä¼šå½±å“æˆ‘ä»¬ç†è§£æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®ä»¥åŠCoordinatoræ˜¯å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„ã€‚ä¸è¿‡ï¼Œæˆ‘å»ºè®®ä½ å¯ä»¥é˜…è¯»ä¸‹ä¸å®ƒä»¬ç›¸å…³çš„ä»£ç éƒ¨åˆ†ã€‚è¦çŸ¥é“ï¼ŒKafkaæ˜¯éå¸¸å–œæ¬¢å¼•ç”¨ä¸­é—´çŠ¶æ€å˜é‡æ¥ç®¡ç†å„ç±»å…ƒæ•°æ®æˆ–çŠ¶æ€çš„ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥ç®€å•å›é¡¾ä¸‹è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚</p><ul>\n<li>æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®ç®¡ç†ï¼šä¸»è¦åŒ…æ‹¬å¯¹ç»„çŠ¶æ€ã€æˆå‘˜ã€ä½ç§»å’Œåˆ†åŒºåˆ†é…ç­–ç•¥çš„ç®¡ç†ã€‚</li>\n<li>ç»„çŠ¶æ€ç®¡ç†ï¼štransitionToæ–¹æ³•è´Ÿè´£è®¾ç½®çŠ¶æ€ï¼Œisã€notå’Œgetæ–¹æ³•ç”¨äºæŸ¥è¯¢çŠ¶æ€ã€‚</li>\n<li>æˆå‘˜ç®¡ç†ï¼šaddã€removeæ–¹æ³•ç”¨äºå¢å‡æˆå‘˜ï¼Œhaså’Œgetæ–¹æ³•ç”¨äºæŸ¥è¯¢ç‰¹å®šæˆå‘˜ã€‚</li>\n<li>åˆ†åŒºåˆ†é…ç­–ç•¥ç®¡ç†ï¼šå®šä¹‰äº†ä¸“å±æ–¹æ³•selectProtocolsï¼Œç”¨äºåœ¨æ¯è½®Rebalanceæ—¶é€‰ä¸¾åˆ†åŒºåˆ†é…ç­–ç•¥ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/a3/e7/a3eafee6b5d17b97f7661c24ccdcd4e7.jpg?wh=2250*1823\" alt=\"\"></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬èŠ±äº†ä¸¤èŠ‚è¯¾çš„æ—¶é—´ï¼Œè¯¦ç»†åœ°å­¦ä¹ äº†æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®åŠå…¶ç®¡ç†æ–¹æ³•çš„æºç ã€‚è¿™äº›æ“ä½œå…ƒæ•°æ®çš„æ–¹æ³•è¢«ä¸Šå±‚è°ƒç”¨æ–¹GroupCoordinatorå¤§é‡ä½¿ç”¨ï¼Œå°±åƒæˆ‘åœ¨å¼€å¤´æåˆ°çš„ï¼Œå¦‚æœç°åœ¨æˆ‘ä»¬ä¸å½»åº•æŒæ¡è¿™äº›å…ƒæ•°æ®è¢«æ“ä½œçš„æ‰‹æ³•ï¼Œç­‰æˆ‘ä»¬å­¦åˆ°GroupCoordinatorä»£ç æ—¶ï¼Œå°±ä¼šæ„Ÿåˆ°æœ‰äº›åƒåŠ›ï¼Œæ‰€ä»¥ï¼Œä½ ä¸€å®šè¦å¥½å¥½åœ°å­¦ä¹ è¿™ä¸¤èŠ‚è¯¾ã€‚æœ‰äº†è¿™äº›åŸºç¡€ï¼Œç­‰åˆ°å­¦ä¹ GroupCoordinatoræºç æ—¶ï¼Œä½ å°±èƒ½æ›´åŠ æ·±åˆ»åœ°ç†è§£å®ƒçš„åº•å±‚å®ç°åŸç†äº†ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>åœ¨è®²åˆ°MemberMetadataæ—¶ï¼Œæˆ‘è¯´è¿‡ï¼Œæ¯ä¸ªæˆå‘˜éƒ½æœ‰è‡ªå·±çš„Rebalanceè¶…æ—¶æ—¶é—´è®¾ç½®ï¼Œé‚£ä¹ˆï¼ŒKafkaæ˜¯æ€ä¹ˆç¡®è®¤æ¶ˆè´¹è€…ç»„ä½¿ç”¨å“ªä¸ªæˆå‘˜çš„è¶…æ—¶æ—¶é—´ä½œä¸ºæ•´ä¸ªç»„çš„è¶…æ—¶æ—¶é—´å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"27 | æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®ï¼ˆä¸Šï¼‰ï¼šæ¶ˆè´¹è€…ç»„éƒ½æœ‰å“ªäº›å…ƒæ•°æ®ï¼Ÿ","id":255382},"right":{"article_title":"29 | GroupMetadataManagerï¼šç»„å…ƒæ•°æ®ç®¡ç†å™¨æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ","id":257053}},"comments":[{"had_liked":false,"id":232863,"user_name":"èƒ¡å¤•","can_delete":false,"product_type":"c1","uid":1288090,"ip_address":"","ucode":"5709A689B6683B","user_header":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","comment_is_top":true,"comment_ctime":1594132442,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"9.2233720384489001e+18","product_id":100050101,"comment_content":"ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚æˆ‘æ¥å…¬å¸ƒä¸ŠèŠ‚è¯¾çš„â€œè¯¾åè®¨è®ºâ€é¢˜ç­”æ¡ˆå•¦ï½<br><br>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬é‡ç‚¹å­¦ä¹ äº†æ¶ˆè´¹è€…ç»„å…ƒæ•°æ®éƒ½æœ‰å“ªäº›ã€‚è¯¾åæˆ‘è¯·ä½ æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼škafka-consumer-groupsè„šæœ¬è¾“å‡ºä¸­çš„ASSIGNMENT-STRATEGYé¡¹å¯¹åº”äºå“ªä¸€é¡¹å…ƒæ•°æ®ã€‚å®é™…ä¸Šï¼Œå®ƒå¯¹åº”äºGroupMetadataç±»çš„protocolNameå­—æ®µï¼Œå³æ¶ˆè´¹è€…ç»„åˆ†åŒºæ¶ˆè´¹åˆ†é…ç­–ç•¥åç§°ã€‚<br><br>okayï¼Œä½ åŒæ„è¿™ä¸ªè¯´æ³•å—ï¼Ÿæˆ–è€…è¯´ä½ æœ‰å…¶ä»–çš„çœ‹æ³•å—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸€èµ·è®¨è®ºä¸‹ã€‚","like_count":0,"discussions":[{"author":{"id":1251016,"avatar":"https://static001.geekbang.org/account/avatar/00/13/16/c8/980776fc.jpg","nickname":"èµ°é©¬","note":"","ucode":"EEFE8F7590FFA4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301281,"discussion_content":"è€å¸ˆæ‚¨å¥½ï¼ŒåŒä¸€ä¸ªtopicä¸‹ï¼ŒæŸä¸ªgroupidçªç„¶æ¶ˆè´¹ä¸åˆ°æ•°æ®å¯èƒ½æ˜¯å•¥åŸå› ï¼Œæ¢ä¸ªgroupid æ˜¯èƒ½æ¶ˆè´¹åˆ°æ•°æ®çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598457339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":231289,"user_name":"ä¼¯å®‰çŸ¥å¿ƒ","can_delete":false,"product_type":"c1","uid":1961835,"ip_address":"","ucode":"6C17706658672C","user_header":"https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg","comment_is_top":false,"comment_ctime":1593640371,"is_pvip":false,"replies":[{"id":"85435","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593657941,"ip_address":"","comment_id":231289,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10183574963","product_id":100050101,"comment_content":"æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„rebalanceæ—¶é—´ï¼Œè¿™æ˜¯ä¸ºäº†æ¯ä¸ªæ¶ˆè´¹è€…æŒ‰ç…§è‡ªå·±çš„éœ€è¦è®¾ç½®ï¼Œä½†æ˜¯åœ¨æœåŠ¡ç«¯æ¶ˆè´¹è€…ç»„éœ€è¦ç®¡ç†è¿™äº›ç»„å†…æ‰€æœ‰æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ç»„ä¹Ÿéœ€è¦ä¸€ä¸ªrebalanceæ—¶é—´æ¥å¹³è¡¡æ¶ˆè´¹è€…ï¼Œåœ¨æœåŠ¡ç«¯prepareRebalanceæ–¹æ³•æœ‰ä¸ªå‚æ•°delayedRebalance è¦ä¹ˆåˆå§‹åŒ–InitialDelayedJoinå¾—åˆ°rebalanceæ—¶é—´ï¼Œè¦ä¹ˆéåˆå§‹åŒ–æ–¹æ³•DelayedJoinï¼Œè€ŒDelayedJoinä¸­å‚æ•°rebalanceTimeoutMs ä»æ–¹æ³•timeout.max(member.rebalanceTimeoutMs)è®¡ç®—å¾—åˆ°ï¼Œç®€å•æ¥è¯´å°±æ˜¯groupä¸­æ‰€æœ‰consumerçš„æœ€å¤§çš„member.rebalanceTimeoutMsã€‚","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500240,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593657941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246465,"user_name":"æ¢èªæ˜","can_delete":false,"product_type":"c1","uid":2053611,"ip_address":"","ucode":"712FAD6E071585","user_header":"https://static001.geekbang.org/account/avatar/00/1f/55/eb/a441eda8.jpg","comment_is_top":false,"comment_ctime":1599362218,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599362218","product_id":100050101,"comment_content":"<br>  def rebalanceTimeoutMs = members.values.foldLeft(0) { (timeout, member) =&gt;<br>    timeout.max(member.rebalanceTimeoutMs)<br>  }","like_count":0}]}