{"id":222374,"title":"09 | 核心功能之流量控制：Istio是如何实现流量控制功能的？","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":214108,"user_name":"lambda","can_delete":false,"product_type":"c3","uid":1485279,"ip_address":"","ucode":"AEF58B6E4F9E59","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIzVGyhMctYa2jumzLicZVLia0UCTqrWfiaY8pY4c3AbGH2tH5TxONcbicoXGdE3ia43TpXxbZWPZoS6Jg/132","comment_is_top":false,"comment_ctime":1588660065,"is_pvip":false,"replies":[{"id":79329,"content":"抱歉带给您不好的学习体验，前面都是比较基础的篇理论讲述，从11课开始会对这一课综述的具体的功能逐一进行实践，同时也会围绕相关概念举例说明。\n感谢你的意见，后续的课程我会更加努力。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588693914,"ip_address":"","comment_id":214108,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"感觉反复讲了很多次istio都有什么功能，但是这章却没举个例子，三分钟时的那张图也只是讲了讲概念就跳过了。说实话，满分十分，张磊讲的k8s能有9分，这个课程顶多就5分。\n从头到尾总结下前九章讲了啥：\nservice mesh很牛逼，可以无入侵","like_count":10,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493960,"discussion_content":"抱歉带给您不好的学习体验，前面都是比较基础的篇理论讲述，从11课开始会对这一课综述的具体的功能逐一进行实践，同时也会围绕相关概念举例说明。\n感谢你的意见，后续的课程我会更加努力。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588693914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245894,"user_name":"果然爸爸","can_delete":false,"product_type":"c3","uid":1467300,"ip_address":"","ucode":"0E5F031A0E6A69","user_header":"https://static001.geekbang.org/account/avatar/00/16/63/a4/e663c4d4.jpg","comment_is_top":false,"comment_ctime":1599102964,"is_pvip":false,"replies":[{"id":90463,"content":"不一样的东西。k8s的svc是真实服务的抽象，是外界访问真实服务的入口；\n虚拟服务本质上是路由规则，就是外界访问服务时虚拟服务会做进一步的路由。\n比如原来的访问类似 client -&gt; service -&gt; pods；加了虚拟服务类似于 client -&gt; service -&gt; virtualservice -&gt; subset pods（满足路由规则的pod子集)","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1599203554,"ip_address":"","comment_id":245894,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"这个虚拟服务和k8s里的service 功能上是不是有些重合","like_count":3,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505006,"discussion_content":"不一样的东西。k8s的svc是真实服务的抽象，是外界访问真实服务的入口；\n虚拟服务本质上是路由规则，就是外界访问服务时虚拟服务会做进一步的路由。\n比如原来的访问类似 client -&amp;gt; service -&amp;gt; pods；加了虚拟服务类似于 client -&amp;gt; service -&amp;gt; virtualservice -&amp;gt; subset pods（满足路由规则的pod子集)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599203554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207448,"user_name":"Jepsenwan","can_delete":false,"product_type":"c3","uid":1220569,"ip_address":"","ucode":"FEED052E0C10F5","user_header":"","comment_is_top":false,"comment_ctime":1587087639,"is_pvip":false,"replies":[{"id":77514,"content":"落地实践不多，除了大厂自研以外，基本上都是基于以前的版本，集中在1.1 -1.4 之间。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587109784,"ip_address":"","comment_id":207448,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"直接从1.0过渡到1.5，其它教程很少讲这些，谢谢！  请问现在市面上还是哪些版本是主流？ ","like_count":2,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492131,"discussion_content":"落地实践不多，除了大厂自研以外，基本上都是基于以前的版本，集中在1.1 -1.4 之间。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587109784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1220569,"avatar":"","nickname":"Jepsenwan","note":"","ucode":"FEED052E0C10F5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":236624,"discussion_content":"谢谢！ 从后面的实验开始，您是要讲集成到istiod的那款，还是散装版的模块版本也会讲到啊？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587109990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207289,"user_name":"blentle","can_delete":false,"product_type":"c3","uid":1064679,"ip_address":"","ucode":"AC092609A4942A","user_header":"https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg","comment_is_top":false,"comment_ctime":1587042917,"is_pvip":false,"replies":[{"id":77515,"content":"可以通过镜像，也可以用采用率记，把部分请求路由到负责记录的实例。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587109926,"ip_address":"","comment_id":207289,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"正好需要流量镜像这样的功能，我们现在是dsp竞价引擎，因为请求每天280多个亿，又不能全部记日志，只能概率记，总有些问题捕捉不到.需要个流量镜像经过消息队列存储离线分析","like_count":2,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492074,"discussion_content":"可以通过镜像，也可以用采用率记，把部分请求路由到负责记录的实例。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587109926,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289003,"user_name":"eric-xin","can_delete":false,"product_type":"c3","uid":1005634,"ip_address":"","ucode":"B10BB7796CDF6B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/58/42/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1618817227,"is_pvip":false,"replies":[{"id":105053,"content":"绝大部分流控能力都是靠envoy实现的，Istio只是整合了envoy，添加了控制面而已","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1619096024,"ip_address":"","comment_id":289003,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师您讲的 istio 功能跟 envoy 很接近，感觉效果差不多，不过 istio 在pod前面，讲的很清楚","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518790,"discussion_content":"绝大部分流控能力都是靠envoy实现的，Istio只是整合了envoy，添加了控制面而已","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619096024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207958,"user_name":"Xiang","can_delete":false,"product_type":"c3","uid":1000070,"ip_address":"","ucode":"374744FF627C00","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/86/d05de870.jpg","comment_is_top":false,"comment_ctime":1587222505,"is_pvip":false,"replies":[{"id":77860,"content":"由k8s负责调用到node上。安装选项中有一个参数global.defaultNodeSelector，可以选择特定节点：&quot;Default node selector to be applied to all deployments so that all pods can be constrained to run a particular nodes. Each component can overwrite these default values by adding its node selector block in the relevant section below and setting the desired values.&quot;\ningress就在istio-system 命名空间中。至于流量大小我觉得不是决定使用外部还是默认网关的考虑点，如果你指的是性能，ingress本身也需要附着一个Envoy进行路由，Envoy的性能是没有问题的。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587354627,"ip_address":"","comment_id":207958,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"Istio 默认的 ingress 会部署在哪里，随机选择一个node，还是master 上呢，就是会出现在物理那个地方. 流量大的集群需使用外部的网关吧","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492297,"discussion_content":"由k8s负责调用到node上。安装选项中有一个参数global.defaultNodeSelector，可以选择特定节点：&amp;quot;Default node selector to be applied to all deployments so that all pods can be constrained to run a particular nodes. Each component can overwrite these default values by adding its node selector block in the relevant section below and setting the desired values.&amp;quot;\ningress就在istio-system 命名空间中。至于流量大小我觉得不是决定使用外部还是默认网关的考虑点，如果你指的是性能，ingress本身也需要附着一个Envoy进行路由，Envoy的性能是没有问题的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587354627,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":289018,"user_name":"石栖","can_delete":false,"product_type":"c3","uid":1496443,"ip_address":"","ucode":"35600F645A479F","user_header":"https://static001.geekbang.org/account/avatar/00/16/d5/7b/c512da6a.jpg","comment_is_top":false,"comment_ctime":1618821363,"is_pvip":false,"replies":[{"id":105054,"content":"你说的是这个例子吗？https:&#47;&#47;istio.io&#47;latest&#47;docs&#47;tasks&#47;policy-enforcement&#47;rate-limit&#47;#global-rate-limit\n“怎么配置自定义的返回body，和剩余请求量怎么放在response header.里面”——这句话我没看懂，回答你第二个问题，global ratelimit是服务级别的，local的是pod级别的，也就是说，所有访问productpage这个服务的流量，受到global的控制；而流量到了productpage的某个pod（其实就是endpoint）后，受local的控制。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1619098293,"ip_address":"","comment_id":289018,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"请问istio 的global ratelimit里面，怎么配置自定义的返回body，和剩余请求量怎么放在response header.里面？我找个很久，都没找到例子……然后global和local的区别，看了半天也没看懂……感觉就是一个要redis一个不要","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518795,"discussion_content":"你说的是这个例子吗？https://istio.io/latest/docs/tasks/policy-enforcement/rate-limit/#global-rate-limit\n“怎么配置自定义的返回body，和剩余请求量怎么放在response header.里面”——这句话我没看懂，回答你第二个问题，global ratelimit是服务级别的，local的是pod级别的，也就是说，所有访问productpage这个服务的流量，受到global的控制；而流量到了productpage的某个pod（其实就是endpoint）后，受local的控制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619098293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1496443,"avatar":"https://static001.geekbang.org/account/avatar/00/16/d5/7b/c512da6a.jpg","nickname":"石栖","note":"","ucode":"35600F645A479F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369628,"discussion_content":"好的，谢谢您。第一个问题，我已经搞清楚了。是envoy版本的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619099620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358866,"user_name":"田小麦","can_delete":false,"product_type":"c3","uid":1648999,"ip_address":"北京","ucode":"4C10997F6173ED","user_header":"https://static001.geekbang.org/account/avatar/00/19/29/67/fc61a741.jpg","comment_is_top":false,"comment_ctime":1664942383,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"麻烦以后吧 头像最小化，一直打开课件","like_count":2},{"had_liked":false,"id":330256,"user_name":"阿尔伯特波","can_delete":false,"product_type":"c3","uid":2876787,"ip_address":"","ucode":"60B86EE085190D","user_header":"https://static001.geekbang.org/account/avatar/00/2b/e5/73/622e9438.jpg","comment_is_top":false,"comment_ctime":1641884717,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"来晚了，现在istio 1.10版本都停更了","like_count":2},{"had_liked":false,"id":220658,"user_name":"muggle","can_delete":false,"product_type":"c3","uid":1109754,"ip_address":"","ucode":"B5A85C4C280FCA","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/fa/37da6393.jpg","comment_is_top":false,"comment_ctime":1590305337,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师讲的很好，谢谢了","like_count":0},{"had_liked":false,"id":207290,"user_name":"blentle","can_delete":false,"product_type":"c3","uid":1064679,"ip_address":"","ucode":"AC092609A4942A","user_header":"https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg","comment_is_top":false,"comment_ctime":1587042958,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"学到了，谢谢","like_count":0}]}