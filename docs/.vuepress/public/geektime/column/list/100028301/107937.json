{"id":107937,"title":"24 | å®æˆ˜ï¼šå¤„ç†å››å±‚æµé‡ï¼Œå®ç°Memcached Server","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>åœ¨å‰é¢å‡ èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸å°‘å¤„ç†è¯·æ±‚çš„ Lua API ï¼Œä¸è¿‡å®ƒä»¬éƒ½æ˜¯å’Œä¸ƒå±‚ç›¸å…³çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒOpenResty å…¶å®è¿˜æä¾›äº† <code>stream-lua-nginx-module</code> æ¨¡å—æ¥å¤„ç†å››å±‚çš„æµé‡ã€‚å®ƒæä¾›çš„æŒ‡ä»¤å’Œ API ï¼Œä¸ <code>lua-nginx-module</code> åŸºæœ¬ä¸€è‡´ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·ç”¨ OpenResty æ¥å®ç°ä¸€ä¸ª memcached serverï¼Œè€Œä¸”å¤§æ¦‚åªéœ€è¦ 100 å¤šè¡Œä»£ç å°±å¯ä»¥å®Œæˆã€‚åœ¨è¿™ä¸ªå°çš„å®æˆ˜ä¸­ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°ä¸å°‘å‰é¢å­¦è¿‡çš„å†…å®¹ï¼Œä¹Ÿä¼šå¸¦å…¥ä¸€äº›åé¢æµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–ç« èŠ‚çš„å†…å®¹ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½å¤Ÿæ˜ç¡®ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾çš„é‡ç‚¹ï¼Œä¸åœ¨äºä½ å¿…é¡»è¯»æ‡‚æ¯ä¸€è¡Œä»£ç çš„å…·ä½“ä½œç”¨ï¼Œè€Œæ˜¯ä½ è¦ä»éœ€æ±‚ã€æµ‹è¯•ã€å¼€å‘ç­‰è§’åº¦ï¼ŒæŠŠ OpenResty å¦‚ä½•ä»é›¶å¼€å‘ä¸€ä¸ªé¡¹ç›®çš„å…¨è²Œäº†ç„¶äºå¿ƒã€‚</p><h2>åŸå§‹éœ€æ±‚å’ŒæŠ€æœ¯æ–¹æ¡ˆ</h2><p>åœ¨å¼€å‘ä¹‹å‰ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ˜ç™½éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Œåˆ°åº•æ˜¯ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜çš„ï¼Œå¦åˆ™å°±ä¼šåœ¨è¿·å¤±åœ¨æŠ€æœ¯é€‰æ‹©ä¸­ã€‚æ¯”å¦‚çœ‹åˆ°æˆ‘ä»¬ä»Šå¤©çš„ä¸»é¢˜ï¼Œä½ å°±åº”è¯¥å…ˆåé—®ä¸€ä¸‹è‡ªå·±ï¼Œä¸ºä»€ä¹ˆè¦å®ç°ä¸€ä¸ª memcached server å‘¢ï¼Ÿç›´æ¥å®‰è£…ä¸€ä¸ªåŸç‰ˆçš„ memcached æˆ–è€… redis ä¸å°±è¡Œäº†å—ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“ï¼ŒHTTPS æµé‡é€æ¸æˆä¸ºä¸»æµï¼Œä½†ä¸€äº›æ¯”è¾ƒè€çš„æµè§ˆå™¨å¹¶ä¸æ”¯æŒ session ticketï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨æœåŠ¡ç«¯æŠŠ session ID å­˜ä¸‹æ¥ã€‚å¦‚æœæœ¬åœ°å­˜å‚¨ç©ºé—´ä¸å¤Ÿï¼Œå°±éœ€è¦ä¸€ä¸ªé›†ç¾¤è¿›è¡Œå­˜æ”¾ï¼Œè€Œè¿™ä¸ªæ•°æ®åˆæ˜¯å¯ä»¥ä¸¢å¼ƒçš„ï¼Œæ‰€ä»¥é€‰ç”¨ memcached å°±æ¯”è¾ƒåˆé€‚ã€‚</p><!-- [[[read_end]]] --><p>è¿™æ—¶å€™ï¼Œç›´æ¥å¼•å…¥ memcached ï¼Œåº”è¯¥æ˜¯æœ€ç®€å•ç›´æ¥çš„æ–¹æ¡ˆã€‚ä½†å‡ºäºä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„è€ƒè™‘ï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©ä½¿ç”¨ OpenResty æ¥é€ ä¸€ä¸ªè½®å­ï¼š</p><ul>\n<li>ç¬¬ä¸€ï¼Œç›´æ¥å¼•å…¥ä¼šå¤šå¼•å…¥ä¸€ä¸ªè¿›ç¨‹ï¼Œå¢åŠ éƒ¨ç½²å’Œç»´æŠ¤æˆæœ¬ï¼›</li>\n<li>ç¬¬äºŒï¼Œè¿™ä¸ªéœ€æ±‚è¶³å¤Ÿç®€å•ï¼Œåªéœ€è¦ get å’Œ set æ“ä½œï¼Œå¹¶ä¸”æ”¯æŒè¿‡æœŸå³å¯ï¼›</li>\n<li>ç¬¬ä¸‰ï¼ŒOpenResty æœ‰ stream æ¨¡å—ï¼Œå¯ä»¥å¾ˆå¿«åœ°å®ç°è¿™ä¸ªéœ€æ±‚ã€‚</li>\n</ul><p>æ—¢ç„¶è¦å®ç° memcached serverï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆå¼„æ˜ç™½å®ƒçš„åè®®ã€‚memcached çš„åè®®å¯ä»¥æ”¯æŒ TCP å’Œ UDPï¼Œè¿™é‡Œæˆ‘é€‰æ‹© TCPï¼Œä¸‹é¢æ˜¯ get å’Œ set å‘½ä»¤çš„å…·ä½“åè®®ï¼š</p><pre><code>Get\næ ¹æ® key è·å– value\nTelnet command: get &lt;key&gt;*\\r\\n\n\nç¤ºä¾‹ï¼š\nget key\nVALUE key 0 4 data END\n\n</code></pre><pre><code>Set\nå­˜å‚¨é”®å€¼å¯¹åˆ° memcached ä¸­\nTelnet commandï¼šset &lt;key&gt; &lt;flags&gt; &lt;exptime&gt; &lt;bytes&gt; [noreply]\\r\\n&lt;value&gt;\\r\\n\n\nç¤ºä¾‹ï¼š\nset key 0 900 4 data\nSTORED\n</code></pre><p>é™¤äº† get å’Œ set å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ memcached çš„åè®®çš„â€œé”™è¯¯å¤„ç†â€æ˜¯æ€ä¹ˆæ ·åšçš„ã€‚â€œé”™è¯¯å¤„ç†â€å¯¹äºæœåŠ¡ç«¯çš„ç¨‹åºæ˜¯éå¸¸é‡è¦çš„ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ç¨‹åºæ—¶ï¼Œé™¤äº†è¦å¤„ç†æ­£å¸¸çš„è¯·æ±‚ï¼Œä¹Ÿè¦è€ƒè™‘åˆ°å„ç§å¼‚å¸¸ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ ·çš„åœºæ™¯ï¼š</p><ul>\n<li>memcached å‘é€äº†ä¸€ä¸ªgetã€set ä¹‹å¤–çš„è¯·æ±‚ï¼Œæˆ‘è¦æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</li>\n<li>æœåŠ¡ç«¯å‡ºé”™ï¼Œæˆ‘è¦ç»™ memcached çš„å®¢æˆ·ç«¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„åé¦ˆå‘¢ï¼Ÿ</li>\n</ul><p>åŒæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å†™å‡ºèƒ½å¤Ÿå…¼å®¹ memcached çš„å®¢æˆ·ç«¯ç¨‹åºã€‚è¿™æ ·ï¼Œä½¿ç”¨è€…å°±ä¸ç”¨åŒºåˆ†è¿™æ˜¯ memcached å®˜æ–¹çš„ç‰ˆæœ¬ï¼Œè¿˜æ˜¯ OpenResty å®ç°çš„ç‰ˆæœ¬äº†ã€‚</p><p>ä¸‹é¢è¿™å¼ å›¾å‡ºè‡ªmemcached çš„æ–‡æ¡£ï¼Œæè¿°äº†å‡ºé”™çš„æ—¶å€™ï¼Œåº”è¯¥è¿”å›ä»€ä¹ˆå†…å®¹å’Œå…·ä½“çš„æ ¼å¼ï¼Œä½ å¯ä»¥ç”¨åšå‚è€ƒï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/37/b0/3767ed0047e34aabaa7bf7d568438ab0.png?wh=1974*1446\" alt=\"\"></p><p>ç°åœ¨ï¼Œå†æ¥ç¡®å®šä¸‹æŠ€æœ¯æ–¹æ¡ˆã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒOpenResty çš„ shared dict å¯ä»¥è·¨å„ä¸ª worker æ¥ä½¿ç”¨ï¼ŒæŠŠæ•°æ®æ”¾åœ¨ shared dict é‡Œé¢ï¼Œå’Œæ”¾åœ¨ memcached é‡Œé¢éå¸¸ç±»ä¼¼â€”â€”å®ƒä»¬éƒ½æ”¯æŒ get å’Œ set æ“ä½œï¼Œå¹¶ä¸”åœ¨è¿›ç¨‹é‡å¯åæ•°æ®å°±ä¸¢å¤±äº†ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨ shared dict æ¥æ¨¡æ‹Ÿ memcached æ˜¯éå¸¸åˆé€‚çš„ï¼Œå®ƒä»¬çš„åŸç†å’Œè¡Œä¸ºéƒ½æ˜¯ä¸€è‡´çš„ã€‚</p><h2>æµ‹è¯•é©±åŠ¨å¼€å‘</h2><p>æ¥ä¸‹æ¥å°±è¦å¼€å§‹åŠ¨å·¥äº†ã€‚ä¸è¿‡ï¼ŒåŸºäºæµ‹è¯•é©±åŠ¨å¼€å‘çš„æ€æƒ³ï¼Œåœ¨å†™å…·ä½“çš„ä»£ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥æ„é€ ä¸€ä¸ªæœ€ç®€å•çš„æµ‹è¯•æ¡ˆä¾‹ã€‚è¿™é‡Œæˆ‘ä»¬ä¸ç”¨ <code>test::nginx</code> æ¡†æ¶ï¼Œæ¯•ç«Ÿå®ƒçš„ä¸Šæ‰‹éš¾åº¦ä¹Ÿä¸ä½ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆç”¨ç†Ÿæ‚‰çš„ <code>resty</code> æ¥æ‰‹åŠ¨æµ‹è¯•ä¸‹ï¼š</p><pre><code>$ resty -e 'local memcached = require &quot;resty.memcached&quot;\n    local memc, err = memcached:new()\n\n    memc:set_timeout(1000) -- 1 sec\n    local ok, err = memc:connect(&quot;127.0.0.1&quot;, 11212)\n    local ok, err = memc:set(&quot;dog&quot;, 32)\n    if not ok then\n        ngx.say(&quot;failed to set dog: &quot;, err)\n        return\n    end\n\n    local res, flags, err = memc:get(&quot;dog&quot;)\n    ngx.say(&quot;dog: &quot;, res)'\n</code></pre><p>è¿™æ®µæµ‹è¯•ä»£ç ï¼Œä½¿ç”¨ <code>lua-rety-memcached</code> å®¢æˆ·ç«¯åº“å‘èµ· connect å’Œ set æ“ä½œï¼Œå¹¶å‡è®¾ memcached çš„æœåŠ¡ç«¯ç›‘å¬æœ¬æœºçš„ 11212 ç«¯å£ã€‚</p><p>çœ‹èµ·æ¥åº”è¯¥æ²¡æœ‰é—®é¢˜äº†å§ã€‚ä½ å¯ä»¥åœ¨è‡ªå·±çš„æœºå™¨ä¸Šæ‰§è¡Œä¸€ä¸‹è¿™æ®µä»£ç ï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œä¼šè¿”å› <code>failed to set dog: closed</code> è¿™æ ·çš„é”™è¯¯æç¤ºï¼Œå› ä¸ºæ­¤æ—¶æœåŠ¡å¹¶æ²¡æœ‰å¯åŠ¨ã€‚</p><p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œä½ çš„æŠ€æœ¯æ–¹æ¡ˆå°±å·²ç»æ˜ç¡®äº†ï¼Œé‚£å°±æ˜¯ä½¿ç”¨ stream æ¨¡å—æ¥æ¥æ”¶å’Œå‘é€æ•°æ®ï¼ŒåŒæ—¶ä½¿ç”¨ shared dict æ¥å­˜å‚¨æ•°æ®ã€‚</p><p>è¡¡é‡éœ€æ±‚æ˜¯å¦å®Œæˆçš„æŒ‡æ ‡ä¹Ÿå¾ˆæ˜ç¡®ï¼Œé‚£å°±æ˜¯è·‘é€šä¸Šé¢è¿™æ®µä»£ç ï¼Œå¹¶æŠŠ dog çš„å®é™…å€¼ç»™æ‰“å°å‡ºæ¥ã€‚</p><h2>æ­å»ºæ¡†æ¶</h2><p>é‚£è¿˜ç­‰ä»€ä¹ˆï¼Œå¼€å§‹åŠ¨æ‰‹å†™ä»£ç å§ï¼</p><p>æˆ‘ä¸ªäººçš„ä¹ æƒ¯ï¼Œæ˜¯å…ˆæ­å»ºä¸€ä¸ªæœ€å°çš„å¯ä»¥è¿è¡Œçš„ä»£ç æ¡†æ¶ï¼Œç„¶åå†é€æ­¥åœ°å»å¡«å……ä»£ç ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œåœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥ç»™è‡ªå·±è®¾ç½®å¾ˆå¤šå°ç›®æ ‡ï¼›è€Œä¸”åœ¨å®Œæˆä¸€ä¸ªå°ç›®æ ‡åï¼Œæµ‹è¯•æ¡ˆä¾‹ä¹Ÿä¼šç»™ä½ æ­£åé¦ˆã€‚</p><p>è®©æˆ‘ä»¬å…ˆæ¥è®¾ç½®å¥½ Nginx çš„é…ç½®æ–‡ä»¶ï¼Œå› ä¸ºstream å’Œ shared dict è¦åœ¨å…¶ä¸­é¢„è®¾ã€‚ä¸‹é¢æ˜¯æˆ‘è®¾ç½®çš„é…ç½®æ–‡ä»¶ï¼š</p><pre><code>stream {\n    lua_shared_dict memcached 100m;\n    lua_package_path 'lib/?.lua;;';\n    server {\n        listen 11212;\n        content_by_lua_block {\n            local m = require(&quot;resty.memcached.server&quot;)\n            m.run()\n        }\n    }\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µé…ç½®æ–‡ä»¶ä¸­æœ‰å‡ ä¸ªå…³é”®çš„ä¿¡æ¯ï¼š</p><ul>\n<li>é¦–å…ˆï¼Œä»£ç è¿è¡Œåœ¨ Nginx çš„ stream ä¸Šä¸‹æ–‡ä¸­ï¼Œè€Œé HTTP ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä¸”ç›‘å¬äº† 11212 ç«¯å£ï¼›</li>\n<li>å…¶æ¬¡ï¼Œshared dict çš„åå­—ä¸º memcachedï¼Œå¤§å°æ˜¯ 100Mï¼Œè¿™äº›åœ¨è¿è¡ŒæœŸæ˜¯ä¸å¯ä»¥ä¿®æ”¹çš„ï¼›</li>\n<li>å¦å¤–ï¼Œä»£ç æ‰€åœ¨ç›®å½•ä¸º <code>lib/resty/memcached</code>, æ–‡ä»¶åä¸º <code>server.lua</code>, å…¥å£å‡½æ•°ä¸º <code>run()</code>ï¼Œè¿™äº›ä¿¡æ¯ä½ éƒ½å¯ä»¥ä»<code>lua_package_path</code> å’Œ <code>content_by_lua_block</code> ä¸­æ‰¾åˆ°ã€‚</li>\n</ul><p>æ¥ç€ï¼Œå°±è¯¥æ­å»ºä»£ç æ¡†æ¶äº†ã€‚ä½ å¯ä»¥è‡ªå·±å…ˆåŠ¨æ‰‹è¯•è¯•ï¼Œç„¶åæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹æˆ‘çš„æ¡†æ¶ä»£ç ï¼š</p><pre><code>local new_tab = require &quot;table.new&quot;\nlocal str_sub = string.sub\nlocal re_find = ngx.re.find\nlocal mc_shdict = ngx.shared.memcached\n\nlocal _M = { _VERSION = '0.01' }\n\nlocal function parse_args(s, start)\nend\n\nfunction _M.get(tcpsock, keys)\nend\n\nfunction _M.set(tcpsock, res)\nend\n\nfunction _M.run()\n    local tcpsock = assert(ngx.req.socket(true))\n\n    while true do\n        tcpsock:settimeout(60000) -- 60 seconds\n        local data, err = tcpsock:receive(&quot;*l&quot;)\n\n        local command, args\n        if data then\n            local from, to, err = re_find(data, [[(\\S+)]], &quot;jo&quot;)\n            if from then\n                command = str_sub(data, from, to)\n                args = parse_args(data, to + 1)\n            end\n        end\n\n        if args then\n            local args_len = #args\n            if command == 'get' and args_len &gt; 0 then\n                _M.get(tcpsock, args)\n            elseif command == &quot;set&quot; and args_len == 4 then\n                _M.set(tcpsock, args)\n            end\n        end\n    end\nend\n\nreturn _M\n</code></pre><p>è¿™æ®µä»£ç ï¼Œä¾¿å®ç°äº†å…¥å£å‡½æ•° <code>run()</code> çš„ä¸»è¦é€»è¾‘ã€‚è™½ç„¶æˆ‘è¿˜æ²¡æœ‰åšå¼‚å¸¸å¤„ç†ï¼Œä¾èµ–çš„ <code>parse_args</code>ã€<code>get</code> å’Œ <code>set</code> ä¹Ÿéƒ½æ˜¯ç©ºå‡½æ•°ï¼Œä½†è¿™ä¸ªæ¡†æ¶å·²ç»å®Œæ•´è¡¨è¾¾äº†memcached server çš„é€»è¾‘ã€‚</p><h2>å¡«å……ä»£ç </h2><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æŒ‰ç…§ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œé€ä¸ªå®ç°è¿™å‡ ä¸ªç©ºå‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® memcached <a href=\"https://github.com/memcached/memcached/blob/master/doc/protocol.txt\">çš„åè®®</a><a href=\"https://github.com/memcached/memcached/blob/master/doc/protocol.txt\">æ–‡æ¡£</a>ï¼Œè§£æ memcached å‘½ä»¤çš„å‚æ•°ï¼š</p><pre><code>local function parse_args(s, start)\n    local arr = {}\n\n    while true do\n        local from, to = re_find(s, [[\\S+]], &quot;jo&quot;, {pos = start})\n        if not from then\n            break\n        end\n\n        table.insert(arr, str_sub(s, from, to))\n\n        start = to + 1\n    end\n\n    return arr\nend\n</code></pre><p>è¿™é‡Œï¼Œæˆ‘çš„å»ºè®®æ˜¯ï¼Œå…ˆç”¨æœ€ç›´è§‚çš„æ–¹å¼æ¥å®ç°ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸ç”¨è€ƒè™‘ä»»ä½•æ€§èƒ½çš„ä¼˜åŒ–ã€‚æ¯•ç«Ÿï¼Œå®Œæˆæ€»æ˜¯æ¯”å®Œç¾æ›´é‡è¦ï¼Œè€Œä¸”ï¼ŒåŸºäºå®Œæˆçš„é€æ­¥ä¼˜åŒ–æ‰å¯ä»¥è¶‹è¿‘å®Œç¾ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å®ç°ä¸‹ <code>get</code> å‡½æ•°ã€‚å®ƒå¯ä»¥ä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªé”®ï¼Œæ‰€ä»¥ä¸‹é¢ä»£ç ä¸­æˆ‘ç”¨äº†ä¸€ä¸ª for å¾ªç¯ï¼š</p><pre><code>function _M.get(tcpsock, keys)\n    local reply = &quot;&quot;\n\n    for i = 1, #keys do\n        local key = keys[i]\n        local value, flags = mc_shdict:get(key)\n        if value then\n            local flags  = flags or 0\n            reply = reply .. &quot;VALUE&quot; .. key .. &quot; &quot; .. flags .. &quot; &quot; .. #value .. &quot;\\r\\n&quot; .. value .. &quot;\\r\\n&quot;\n        end\n    end\n    reply = reply ..  &quot;END\\r\\n&quot;\n\n    tcpsock:settimeout(1000)  -- one second timeout\n    local bytes, err = tcpsock:send(reply)\nend\n</code></pre><p>å…¶å®ï¼Œè¿™é‡Œæœ€æ ¸å¿ƒçš„ä»£ç åªæœ‰ä¸€è¡Œï¼š<code>local value, flags = mc_shdict:get(key)</code>ï¼Œä¹Ÿå°±æ˜¯ä» shared dict ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼›è‡³äºå…¶ä½™çš„ä»£ç ï¼Œéƒ½åœ¨æŒ‰ç…§ memcached çš„åè®®æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œå¹¶æœ€ç»ˆ send åˆ°å®¢æˆ·ç«¯ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ <code>set</code> å‡½æ•°ã€‚å®ƒå°†æ¥æ”¶åˆ°çš„å‚æ•°è½¬æ¢ä¸º shared dict API çš„æ ¼å¼ï¼ŒæŠŠæ•°æ®å‚¨å­˜äº†èµ·æ¥ï¼›å¹¶åœ¨å‡ºé”™çš„æ—¶å€™ï¼ŒæŒ‰ç…§ memcached çš„åè®®åšå‡ºå¤„ç†ï¼š</p><pre><code>function _M.set(tcpsock, res)\n    local reply =  &quot;&quot;\n\n    local key = res[1]\n    local flags = res[2]\n    local exptime = res[3]\n    local bytes = res[4]\n\n    local value, err = tcpsock:receive(tonumber(bytes) + 2)\n\n    if str_sub(value, -2, -1) == &quot;\\r\\n&quot; then\n        local succ, err, forcible = mc_shdict:set(key, str_sub(value, 1, bytes), exptime, flags)\n        if succ then\n            reply = reply .. â€œSTORED\\r\\n&quot;\n        else\n            reply = reply .. &quot;SERVER_ERROR &quot; .. err .. â€œ\\r\\nâ€\n        end\n    else\n        reply = reply .. &quot;ERROR\\r\\n&quot;\n    end\n\n    tcpsock:settimeout(1000)  -- one second timeout\n    local bytes, err = tcpsock:send(reply)\nend\n</code></pre><p>å¦å¤–ï¼Œåœ¨å¡«å……ä¸Šé¢è¿™å‡ ä¸ªå‡½æ•°çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥ç”¨æµ‹è¯•æ¡ˆä¾‹æ¥åšæ£€éªŒï¼Œå¹¶ç”¨ <code>ngx.log</code> æ¥åš debugã€‚æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼ŒOpenResty ä¸­å¹¶æ²¡æœ‰æ–­ç‚¹è°ƒè¯•çš„å·¥å…·ï¼Œæ‰€ä»¥æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨ <code>ngx.say</code> å’Œ <code>ngx.log</code> æ¥è°ƒè¯•çš„ï¼Œåœ¨è¿™æ–¹é¢å¯ä»¥è¯´æ˜¯è¿˜å¤„äºåˆ€è€•ç«ç§çš„æ—¶ä»£ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>è¿™ä¸ªå®æˆ˜é¡¹ç›®åˆ°ç°åœ¨å°±æ¥è¿‘å°¾å£°äº†ï¼Œæœ€åï¼Œæˆ‘æƒ³ç•™ä¸€ä¸ªåŠ¨æ‰‹ä½œä¸šã€‚ä½ å¯ä»¥æŠŠä¸Šé¢ memcached server çš„å®ç°ä»£ç ï¼Œå®Œæ•´åœ°è¿è¡Œèµ·æ¥ï¼Œå¹¶é€šè¿‡æµ‹è¯•æ¡ˆä¾‹å—ï¼Ÿ</p><p>ä»Šå¤©çš„ä½œä¸šé¢˜ä¼°è®¡è¦èŠ±è´¹ä½ ä¸å°‘çš„ç²¾åŠ›äº†ï¼Œä¸è¿‡ï¼Œè¿™è¿˜æ˜¯ä¸€ä¸ªåŸå§‹çš„ç‰ˆæœ¬ï¼Œè¿˜æ²¡æœ‰é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–å’Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œè¿™äº›å°±è¦æ”¾åœ¨åé¢ç»§ç»­å®Œå–„äº†ã€‚æˆ‘ä¹Ÿå¸Œæœ›é€šè¿‡åé¢å†…å®¹çš„å­¦ä¹ ï¼Œä½ æœ€ç»ˆèƒ½å¤Ÿå®Œæˆä¸€ä¸ªå®Œå–„çš„ç‰ˆæœ¬ã€‚</p><p>å¦‚æœå¯¹äºä»Šå¤©çš„è®²è§£æˆ–è€…è‡ªå·±çš„å®è·µæœ‰ä»€ä¹ˆç–‘æƒ‘ï¼Œæ¬¢è¿ä½ ç•™è¨€å’Œæˆ‘è®¨è®ºã€‚ä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« è½¬å‘ç»™ä½ çš„åŒäº‹æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·å®æˆ˜ï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"23 | [è§†é¢‘]å¯¼è¯»lua-resty-requestsï¼šä¼˜ç§€çš„lua-resty-*æ˜¯å¦‚ä½•ç¼–å†™çš„ï¼Ÿ","id":105621},"right":{"article_title":"25 | ç­”ç–‘ï¼ˆäºŒï¼‰ï¼šç‰¹æƒè¿›ç¨‹çš„æƒé™åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ","id":108662}},"comments":[{"had_liked":false,"id":115889,"user_name":"2xshu","can_delete":false,"product_type":"c1","uid":1188473,"ip_address":"","ucode":"71584CB9676EDF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKsz8j0bAayjSne9iakvjzUmvUdxWEbsM9iasQ74spGFayIgbSE232sH2LOWmaKtx1WqAFDiaYgVPwIQ/132","comment_is_top":false,"comment_ctime":1563762269,"is_pvip":false,"replies":[{"id":"42829","content":"æœ€å¤§çš„ä¸åŒä¹‹å¤„åœ¨äºå¯ä»¥æ”¯æŒé›†ç¾¤ï¼Œè€Œå…±äº«å­—å…¸åªèƒ½æ˜¯å•æœºä½¿ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563973484,"ip_address":"","comment_id":115889,"utype":1}],"discussion_count":5,"race_medal":0,"score":"23038598749","product_id":100028301,"comment_content":"è€å¸ˆï¼Œè¿™ç¯‡æ–‡ç« æˆ‘åå¤çœ‹äº†å‡ éã€‚å…¶å®æˆ‘è¿˜æ˜¯æ²¡æœ‰é¢†ä¼šåšè¿™ä¸ªé¡¹ç›®çš„çœŸæ­£ç›®çš„å’Œä½¿ç”¨åœºæ™¯å‘¢ã€‚å› ä¸ºæˆ‘ç†è§£çš„æ˜¯å³æ˜¯åšäº†è¿™æ ·å°è£…ï¼Œå’Œç›´æ¥ä½¿ç”¨ngx.shared.DICTæ„Ÿè§‰æ²¡ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿngx.shared.DICTæ“ä½œä¹Ÿæ˜¯åŸå­æ“ä½œçš„ï¼Œå¹¶ä¸”ngx.shared.DICTä¹Ÿæ˜¯ä¸€ä¸ªå…¨å±€å…±äº«çš„å˜é‡ã€‚","like_count":5,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459333,"discussion_content":"æœ€å¤§çš„ä¸åŒä¹‹å¤„åœ¨äºå¯ä»¥æ”¯æŒé›†ç¾¤ï¼Œè€Œå…±äº«å­—å…¸åªèƒ½æ˜¯å•æœºä½¿ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563973484,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1113575,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fd/e7/64301a9e.jpg","nickname":"å¤§ä½¬A","note":"","ucode":"606937F189CF13","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":549873,"discussion_content":"å¦‚æœæ˜¯ä¸ºäº†é›†ç¾¤çš„è¯ï¼Œæ˜¯ä¸æ˜¯å°±ç›´æ¥ç”¨memcachedå°±å¥½äº†å•Šï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644285618,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":459333,"ip_address":""},"score":549873,"extra":""},{"author":{"id":1532404,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIvUlicgrWtibbDzwhLw5cQrDSy2JuE1mVvmXq11KQIwpLicgDuWfpp9asE0VCN6HhibPDWn7wBc2lfmA/132","nickname":"aã€","note":"","ucode":"590FE8DB111492","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1113575,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fd/e7/64301a9e.jpg","nickname":"å¤§ä½¬A","note":"","ucode":"606937F189CF13","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576949,"discussion_content":"æ–‡ç« è¯´äº†ä¸ºäº†è¿™ä¹ˆä¸ªç®€å•çš„éœ€æ±‚ï¼Œå¼•å…¥memcachedä¼šå¢åŠ è¿›ç¨‹å’Œè¿ç»´å¤æ‚åº¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655862752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":549873,"ip_address":""},"score":576949,"extra":""}]},{"author":{"id":1544926,"avatar":"","nickname":"illman","note":"","ucode":"16D96A74AF6D28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337671,"discussion_content":"è¿™ä¹Ÿæ˜¯æˆ‘æƒ³é—®çš„é—®é¢˜ï¼Œç­”æ¡ˆç›´æˆªäº†å½“ï¼Œä¸ºäº†ä¸Šé›†ç¾¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609036098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1391748,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","nickname":"è¿è¾¹","note":"","ucode":"54B5DA38449728","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3508,"discussion_content":"ä½ è°ƒé€šäº†ï¼Œæ–¹ä¾¿åœ¨å“ªé‡Œåˆ†äº«ä¸€ä¸‹ä½ çš„ä»£ç å—ï¼Ÿè¯­æ³•ä¸Šçš„é—®é¢˜ï¼Œæˆ‘è¿™è¾¹éƒ½è§£å†³äº†ã€‚æˆ‘æ€»æ„Ÿè§‰é‚£ä¸ªæµ‹è¯•ç”¨ä¾‹è·‘ä¸é€šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564542674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115362,"user_name":"ç½å¤´ç“¶å­","can_delete":false,"product_type":"c1","uid":1283945,"ip_address":"","ucode":"B14CAA526AB01A","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/69/80945634.jpg","comment_is_top":false,"comment_ctime":1563543381,"is_pvip":false,"replies":[{"id":"42830","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563973513,"ip_address":"","comment_id":115362,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18743412565","product_id":100028301,"comment_content":"openresty luaçš„æ–­ç‚¹è°ƒè¯•ç°åœ¨å¯ä»¥ä½¿ç”¨vscodeæ’ä»¶çš„æ–¹å¼æ¥å®ç°ã€‚æ’ä»¶çš„åå­—å«luaideï¼Œæˆ‘ç°åœ¨æ­£åœ¨ä½¿ç”¨ï¼ŒæŒºå¥½ç”¨çš„ã€‚","like_count":4,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459075,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563973513,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115170,"user_name":"katichar","can_delete":false,"product_type":"c1","uid":1490007,"ip_address":"","ucode":"22736911F30E2C","user_header":"https://static001.geekbang.org/account/avatar/00/16/bc/57/e66d8571.jpg","comment_is_top":false,"comment_ctime":1563502823,"is_pvip":false,"replies":[{"id":"42838","content":"èµ°äº†ä¸€å±‚å¤–éƒ¨çš„ç½‘ç»œé€šä¿¡ï¼Œæ€§èƒ½ä¼šæœ‰ä¸€äº›å½±å“ï¼Œä½†è²Œä¼¼ä¹Ÿæ˜¯å½“å‰çš„ä¸€ä¸ªæ–¹æ¡ˆã€‚æœ€å¥½æ˜¯å†…éƒ¨æ‰“é€šï¼ŒæœŸæœ› OpenResty å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563973883,"ip_address":"","comment_id":115170,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10153437415","product_id":100028301,"comment_content":"åœ¨httpå’Œstreamä¹‹å‰å®ç°æ•°æ®å…±äº«ï¼Œå¦‚æœå¯¹æ€§èƒ½æœ‰è¦æ±‚ï¼Œæ˜¯ä¸æ˜¯resty.memcachedæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ–¹æ¡ˆï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458998,"discussion_content":"èµ°äº†ä¸€å±‚å¤–éƒ¨çš„ç½‘ç»œé€šä¿¡ï¼Œæ€§èƒ½ä¼šæœ‰ä¸€äº›å½±å“ï¼Œä½†è²Œä¼¼ä¹Ÿæ˜¯å½“å‰çš„ä¸€ä¸ªæ–¹æ¡ˆã€‚æœ€å¥½æ˜¯å†…éƒ¨æ‰“é€šï¼ŒæœŸæœ› OpenResty å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563973883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2844,"discussion_content":"resty.memcachedåªæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563965402,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117989,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1564207389,"is_pvip":true,"replies":[{"id":"43610","content":"æ˜¯çš„ï¼Œè¿™ç§é”™è¯¯æ˜¯å¯ä»¥å¿½ç•¥çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1564469625,"ip_address":"","comment_id":117989,"utype":1}],"discussion_count":4,"race_medal":0,"score":"5859174685","product_id":100028301,"comment_content":"æˆ‘åœ¨æ‰§è¡Œè¿™é‡Œçš„ä¾‹å­çš„æ—¶å€™ï¼Œè§£å†³äº†ä¸€äº›è¯­æ³•é”™è¯¯ä¹‹åï¼Œå·²ç»èƒ½å¤Ÿæ­£å¸¸çš„åœ¨resty -eæ‰§è¡Œæ—¶è®¾ç½®å’Œè·å¾—key valueäº†ï¼Œä½†æ˜¯åœ¨æœåŠ¡å™¨ä¾§å¾ªç¯æŠ¥ä¸€ä¸ªé”™è¯¯ï¼Œ2019&#47;07&#47;27 13:35:43 [error] 25017#25017: *1 attempt to receive data on a closed socket: u:00007FDA656A5530, c:00007FDA655FE3F0, ft:0 eof:1, client: 127.0.0.1, server: 0.0.0.0:11212ã€‚è¿™ä¸ªé”™è¯¯ï¼Œé€šè¿‡è®¾ç½®æŒ‡ä»¤lua_socket_log_errors off;çš„ç¡®å…³é—­äº†é”™è¯¯çš„å¾ªç¯æ‰“å°ï¼Œè¿™é‡Œçš„æ ¹æœ¬åŸå› æ˜¯ï¼Œå› ä¸ºserver.luaé‡Œæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œç„¶åå®¢æˆ·ç«¯æ–­å¼€socketäº†ï¼ŒæœåŠ¡ä¾§è¿˜åœ¨å¾ªç¯è¯»å–æ•°æ®ï¼Œå¯¼è‡´ä¸€ç›´æç¤ºè¿™ä¸ªé”™è¯¯å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460213,"discussion_content":"æ˜¯çš„ï¼Œè¿™ç§é”™è¯¯æ˜¯å¯ä»¥å¿½ç•¥çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564469625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1010499,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6b/43/b6bcab56.jpg","nickname":"ä¸‰å¶è™«tlb","note":"","ucode":"A8236974932E6E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365794,"discussion_content":"æˆ‘ä¹Ÿé‡åˆ°è¿™é—®é¢˜ï¼Œç ”ç©¶ä¸‹åœ¨receiveæ—¶æŠŠerrorå¤„ç†ï¼Œè·³å‡ºå¾ªç¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617884341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1019835,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8f/bb/7068f251.jpg","nickname":"è€å§œ","note":"","ucode":"FB7962F08A9F3B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3251,"discussion_content":"æˆ‘ä¹Ÿé‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œæ—¥å¿—æŠŠç¡¬ç›˜éƒ½æ‰“æ»¡äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564353717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1544719,"avatar":"","nickname":"Geek_Wx.71","note":"","ucode":"59D6B01906CACD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1019835,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8f/bb/7068f251.jpg","nickname":"è€å§œ","note":"","ucode":"FB7962F08A9F3B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":17795,"discussion_content":"æˆ‘ä¹‹å‰ä¹Ÿé‡åˆ°ï¼Œåæ¥è°ƒé€šäº†ï¼Œæ²¡è®°é”™çš„è¯ä»£ç é‡Œé¢å°‘äº†ä¸ªç©ºæ ¼ï¼Œç»“æœä¸€æ™šä¸Šæ‰“äº†800Gæ—¥å¿—ã€‚ã€‚&#34;VALUE &#34;è¿™é‡Œéœ€è¦ä¸€ä¸ªç©ºæ ¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568981266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":3251,"ip_address":""},"score":17795,"extra":""}]}]},{"had_liked":false,"id":117381,"user_name":"Geek_Wx.71","can_delete":false,"product_type":"c1","uid":1544719,"ip_address":"","ucode":"59D6B01906CACD","user_header":"","comment_is_top":false,"comment_ctime":1564036287,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5859003583","product_id":100028301,"comment_content":"- -ç»ˆäºè°ƒé€šäº†...æ ‡ç‚¹ç¬¦å·&quot;&quot; &#39;&#39; â€œâ€ ï¼Œ tonumber()<br>æœ€è¦å‘½çš„æ˜¯å°‘ä¸ªç©ºæ ¼","like_count":1},{"had_liked":false,"id":325706,"user_name":"Leo","can_delete":false,"product_type":"c1","uid":2858431,"ip_address":"","ucode":"24D1E66E284411","user_header":"","comment_is_top":false,"comment_ctime":1639102639,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639102639","product_id":100028301,"comment_content":"æœ‰ä¸ªæŒºä¸¥é‡çš„é—®é¢˜ï¼Œgetå‡½æ•°ï¼Œåœ¨ä¸€æ¬¡è¯·æ±‚æˆåŠŸä¹‹åï¼Œå®¢æˆ·ç«¯å·²ç»å…³é—­çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨è¿˜åœ¨ä¸åœçš„ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œä¸åœçš„å¯¹ä¸€ä¸ªå¯¹ç«¯å·²ç»å…³é—­çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œå†™åŠ¨ä½œï¼Œè¿™ä¸ªåœ°æ–¹åº”è¯¥åšä¸ªåˆ¤æ–­ï¼Œå¦‚æœsendé”™è¯¯ï¼Œå°±ç»“æŸå¾ªç¯ï¼Œä¸çŸ¥é“nginxå†…éƒ¨å¤„ç†sigpipeä¿¡å·æ²¡æœ‰ï¼Œæˆ‘è§‰å¾—åº”è¯¥æ˜¯å¤„ç†äº†ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„å¸¸è¯†ï¼Œå†™ä¸€ä¸ªå¯¹ç«¯å…³é—­çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé»˜è®¤åŠ¨ä½œæ˜¯ç»“æŸè¿›ç¨‹çš„ï¼Œä¼šå¯¼è‡´ç¨‹åºcoredumpï¼Œå¿½ç•¥æ‰è¿™ä¸ªä¿¡å·ï¼Œé€šè¿‡å¦‚æœå†™é”™è¯¯ï¼Œåˆ™å…³é—­æ–‡ä»¶æè¿°ç¬¦é‡Šæ”¾èµ„æºå’Œè¿›è¡Œåˆ¤æ–­ã€‚<br>å¯¼è‡´åªè¦å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œå¯¼è‡´æœåŠ¡å™¨ä¸åœçš„æ­»å¾ªç¯ï¼Œå‘ä¸€ä¸ªå¯¹ç«¯å…³äº†çš„æè¿°ç¬¦å‘é€æ•°æ®ï¼Œä¸åœçš„æ‰“æ—¥å¿—ï¼Œå¥½ç«¯ç«¯çš„ï¼ŒæŠŠæˆ‘çš„ç”µè„‘å¼„çš„å¾ˆå¡ï¼Œä¸è¿‡è¿™éƒ½æ˜¯æµ‹è¯•ä»£ç ï¼Œå¦‚æœå¤§å®¶æœ‰ä¸€å®šå¸¸è¯†æˆ–è€…é’»ç ”ç²¾ç¥ï¼Œéƒ½èƒ½è§£å†³","like_count":0},{"had_liked":false,"id":325611,"user_name":"Leo","can_delete":false,"product_type":"c1","uid":2858431,"ip_address":"","ucode":"24D1E66E284411","user_header":"","comment_is_top":false,"comment_ctime":1639042259,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639042259","product_id":100028301,"comment_content":"æ­æ˜¯æ­ä¸Šäº†ï¼Œè·‘ä¹Ÿå‡ºç‚¹æ•ˆæœäº†ï¼Œå¯æƒœæ²¡å­˜è¿›å»æ•°æ®ï¼Œä¸å¤ªç†Ÿæ‚‰å‡½æ•°ï¼Œä¸€ä¼šnginxçš„å‡½æ•°ï¼Œä¸€ä¼šluaçš„å‡½æ•°ï¼Œä¸€ä¼šåˆæ˜¯openrestyçš„å‡½æ•°ï¼Œæˆ‘äº†ä¸ªå»äº†ï¼Œäººçš„å¤§è„‘åªèƒ½è·Ÿè¸ªä¸‰ä»¶äº‹ï¼Œè¦ä¸æ˜¯å¯¹è¿™ä¸‰éƒ¨åˆ†éƒ½å·®ä¸å¤šç†Ÿæ‚‰çš„èŠ±ï¼Œæè¿™ä¸ªè¿˜çœŸçš„ä¼šè´¹æŒºå¤§çš„åŠ²ï¼Œè¿™å¾ˆå¤šåˆå­¦è€…æ‰¾ä¸åˆ°å“ªæ˜¯å“ªï¼ŒçœŸçš„åœ¨æ‰€éš¾å…ã€‚luaå’ŒnginxåŠ ä¸€èµ·ï¼Œå†å°è£…å‡ºæ¥openrestyå‡½æ•°ï¼Œè¡Œå§ï¼Œæˆ‘æ­æˆäº†ï¼Œè‡³äºå‡½æ•°æ¥å£ä¸å¯¹ï¼Œç¨‹åºè·‘é£äº†çš„é—®é¢˜ï¼Œç®—æ˜¯ä»1åˆ°ä¼˜çš„è¿‡ç¨‹äº†ï¼Œä¸çº ç»“äº†ï¼Œæˆ‘å·²ç»æ˜¯åˆæ ¼çš„åˆçº§æ¶æ„å¸ˆäº†ï¼Œæ­å®Œäº†","like_count":0},{"had_liked":false,"id":242804,"user_name":"å°å®‡å­2B","can_delete":false,"product_type":"c1","uid":1254615,"ip_address":"","ucode":"E360188C65EAEA","user_header":"https://static001.geekbang.org/account/avatar/00/13/24/d7/146f484b.jpg","comment_is_top":false,"comment_ctime":1597845934,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1597845934","product_id":100028301,"comment_content":"\\r\\næ˜¯ä¸¤ä¸ªå­—èŠ‚å—ï¼Ÿæ„Ÿè§‰åº”è¯¥æ˜¯å››ä¸ªå­—èŠ‚<br>è‡ªå·±è°ƒè¯•çš„æ—¶å€™ä½¿ç”¨telnetå‘é€\\r\\nï¼Œåœ¨str_sub(value, -2, -1)åªèƒ½è·å–åˆ°\\nè€Œè·å–ä¸åˆ°\\r","like_count":0,"discussions":[{"author":{"id":1903361,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0b/01/33605fc7.jpg","nickname":"Geek_rdd","note":"","ucode":"9BACC4E6963353","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581485,"discussion_content":"ä½ ç”¨telnet å‘é€\\r\\n æ˜¯å‘äº†4ä¸ªå­—ç¬¦ï¼Œè€Œä¸æ˜¯CRLFï¼Œä½ å¦‚æœåœ¨telneté‡Œåªæ•²å›è½¦å°±æ˜¯ä¸¤ä¸ªå­—èŠ‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658806891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":187918,"user_name":"è´ºé’§å¨","can_delete":false,"product_type":"c1","uid":1218353,"ip_address":"","ucode":"3E1FC908C28E29","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/31/76485177.jpg","comment_is_top":false,"comment_ctime":1584277815,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1584277815","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæˆ‘åœ¨æ‰§è¡Œ resty è„šæœ¬çš„æ—¶å€™ï¼Œè¿è¡Œåˆ° mc_shdict:set() æ–¹æ³•å¯¼è‡´äº†ä¸€ä¸ªæŠ¥é”™ &#47;openresty&#47;1.15.8.2&#47;lualib&#47;resty&#47;core&#47;shdict.lua:186: attempt to compare string with numberï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘çœ‹æ–‡ä¸­ç”¨çš„å‚æ•°ä¹Ÿæ˜¯å­—ç¬¦ä¸²ç±»å‹çš„","like_count":0,"discussions":[{"author":{"id":1010499,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6b/43/b6bcab56.jpg","nickname":"ä¸‰å¶è™«tlb","note":"","ucode":"A8236974932E6E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365742,"discussion_content":"æˆ‘ä¹Ÿæ˜¯æœ‰è¿™ä¸ªé”™è¯¯ï¼Œtonumber()è½¬æˆæ•°å­—å°±å¥½ã€‚local succ, err, forcible = mc_shdict:set(key, str_sub(value, 1, bytes), tonumber(exptime), tonumber(flags)) ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617873654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":179738,"user_name":"fangminyu","can_delete":false,"product_type":"c1","uid":1597290,"ip_address":"","ucode":"8D136E4BBAC1C5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL4jnwQhhibicA13DTmyW6vPHaP9FnhYVAEMUiaBRjTy7Gzx9qeuUmCSia06ibC7gMr0RiblXUQZZfBEjpQ/132","comment_is_top":false,"comment_ctime":1582086259,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1582086259","product_id":100028301,"comment_content":"æ¸©å¤§å¸ˆï¼Œä½ çš„æ•™ç¨‹éå¸¸å¥½ï¼Œæˆ‘è¿˜åœ¨å…¥é—¨ä¸­ï¼ŒåŸºæœ¬åŠŸèƒ½å·²ç»è°ƒé€šäº†ï¼Œä½†æ˜¯å‘ç°æœ‰ä¸ªä¸¥é‡é—®é¢˜ï¼Œæ¯æ¬¡æµ‹è¯•æŒ‡å¥—testä¸€æ–­å¼€é“¾æ¥å°±æœ‰è¿™æ ·çš„é—®é¢˜ï¼š<br>2020&#47;02&#47;19 12:21:03 [error] 10681#123902: *2 attempt to receive data on a closed socket: u:00000000031192E0, c:00007FD6670081F0, ft:0 eof:1, client: 127.0.0.1, server: 0.0.0.0:11212<br><br>æˆ‘ç½‘ä¸Šæœäº†ä¸€åœˆä¹Ÿæ²¡æ‰¾åˆ°åŠæ³•ï¼Œè¿™ä¸ªæ‰“å°åˆ°åº•æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1142524,"avatar":"https://static001.geekbang.org/account/avatar/00/11/6e/fc/b25150d7.jpg","nickname":"jawe","note":"","ucode":"6DB8BF50767629","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530814,"discussion_content":"è¿™æ˜¯è¿™æ®µä»£ç é‡Œé¢å‡ºæ¥çš„ï¼Œ\nwhile true do\n    tcpsock:settimeout(600000)\n    local data, err = tcpsock:receive(&#34;*l&#34;)ã€‚\nå› ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¿æŒè¿™é•¿è¿æ¥çŠ¶æ€ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å…³é—­äº†ï¼Œå¯¼è‡´æœåŠ¡å™¨æ¥æ”¶ä¸åˆ°æ•°æ®ã€‚æ‰€ä»¥ä¼šä¸€ç›´å¾ªç¯æ‰“å°ã€‚å› æ­¤æˆ‘åœ¨è¿™é‡ŒåŠ äº†ä¸€ä¸ªåˆ¤æ–­\nwhile true do\n    tcpsock:settimeout(600000)\n    local data, err = tcpsock:receive(&#34;*l&#34;)\n\n    if err then\n      local m = ngx.re.match(err, &#34;^closed&#34;)\n      if m then\n        ngx.exit(1)\n      end\n    end\n    local command, res\nä¸çŸ¥æ˜¯å¦æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼ŒæœŸå¾…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637153401,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":135054,"user_name":"å§šå¤","can_delete":false,"product_type":"c1","uid":1206244,"ip_address":"","ucode":"73C2B70E875DA9","user_header":"https://static001.geekbang.org/account/avatar/00/12/67/e4/42ea7a9a.jpg","comment_is_top":false,"comment_ctime":1568991188,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568991188","product_id":100028301,"comment_content":"æˆ‘æµ‹è¯•è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦å°† function _M.get(tcpsock, keys) ä¸­çš„è¿™ä¸€è¡Œï¼šreply = reply .. &quot;VALUE &quot; .. key .. &quot; &quot; .. flags .. &quot; &quot; .. #value .. &quot;\\r\\n&quot; .. value .. &quot;\\r\\n&quot; çš„ â€œVALUE&quot;ååŠ ä¸€ä¸ªç©ºæ ¼ã€‚<br>å¦åˆ™è¿”å›çš„æ˜¯nilã€‚<br>è·Ÿè¸ªåˆ°memcached.luaä¸­çš„get å‡½æ•°æœ‰å¦‚ä¸‹åˆ¤æ–­<br>local flags, len = match(line, &#39;^VALUE %S+ (%d+) (%d+)$&#39;)<br>    if not flags then<br>        return nil, nil, line<br>    end<br>","like_count":0},{"had_liked":false,"id":131340,"user_name":"å†™ç‚¹å•¥å‘¢","can_delete":false,"product_type":"c1","uid":1065272,"ip_address":"","ucode":"C19032CF1C41BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","comment_is_top":false,"comment_ctime":1567728157,"is_pvip":false,"replies":[{"id":"50713","content":"ä½ ä½¿ç”¨ memcached çš„å®¢æˆ·ç«¯ï¼Œéƒ½æ˜¯æ”¯æŒä¸€è‡´æ€§ hash è¿™æ ·çš„ç®—æ³•ï¼Œè¿™æ ·å°±ç­‰äºæ˜¯å®ç°äº†é›†ç¾¤å‚¨å­˜äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1568171931,"ip_address":"","comment_id":131340,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1567728157","product_id":100028301,"comment_content":"è¯·é—®è€å¸ˆï¼Œä½ åœ¨@2xshuåŒå­¦çš„ç•™è¨€é‡Œæåˆ°äº†è¿™ä¸ªå®ç°æ”¯æŒé›†ç¾¤ï¼Œè€Œå…±äº«å­—å…¸åªèƒ½å•æœºä½¿ç”¨ï¼Œæˆ‘æ²¡æœ‰ç†è§£ï¼Œè¯·é—®æ”¯æŒé›†ç¾¤æ˜¯æŒ‡å¯ä»¥è·¨ç‰©ç†æœºå…±äº«å­˜å‚¨ä¹ˆï¼Ÿé‚£å…·ä½“æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466397,"discussion_content":"ä½ ä½¿ç”¨ memcached çš„å®¢æˆ·ç«¯ï¼Œéƒ½æ˜¯æ”¯æŒä¸€è‡´æ€§ hash è¿™æ ·çš„ç®—æ³•ï¼Œè¿™æ ·å°±ç­‰äºæ˜¯å®ç°äº†é›†ç¾¤å‚¨å­˜äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568171931,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065272,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","nickname":"å†™ç‚¹å•¥å‘¢","note":"","ucode":"C19032CF1C41BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":9511,"discussion_content":"æ˜ç™½äº†ï¼Œè°¢è°¢ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568178759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":126056,"user_name":"è¿è¾¹","can_delete":false,"product_type":"c1","uid":1391748,"ip_address":"","ucode":"54B5DA38449728","user_header":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","comment_is_top":false,"comment_ctime":1566302385,"is_pvip":false,"replies":[{"id":"49369","content":"è¦çœ‹ä¸‹å¾ªç¯é‡Œé¢å…·ä½“åšäº†ä»€ä¹ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567651512,"ip_address":"","comment_id":126056,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1566302385","product_id":100028301,"comment_content":"æˆ‘å†™äº†ä¸€ä¸ªç©ºçš„ä»£ç ï¼Œç›´æ¥å†™ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¼šç›´æ¥å¯¼è‡´cpu 100%ã€‚è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463805,"discussion_content":"è¦çœ‹ä¸‹å¾ªç¯é‡Œé¢å…·ä½“åšäº†ä»€ä¹ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567651512,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119094,"user_name":"è¿è¾¹","can_delete":false,"product_type":"c1","uid":1391748,"ip_address":"","ucode":"54B5DA38449728","user_header":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","comment_is_top":false,"comment_ctime":1564502630,"is_pvip":false,"replies":[{"id":"43748","content":"ä½ ç»™çš„é“¾æ¥ä¸­æ²¡æœ‰å…·ä½“çš„æŠ¥é”™ä¿¡æ¯ã€‚å¦å¤–ï¼Œ&#47;usr&#47;local&#47;openresty3&#47;lib&#47;resty&#47;memached è¿™ä¸ªç›®å½•æ˜¯æ‹¼å†™é”™äº†å—ï¼Ÿæœ€åçš„ç›®å½•ååº”è¯¥ memcached è€Œä¸æ˜¯ memachedï¼Œå°‘äº†ä¸€ä¸ªå­—æ¯ c","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1564543226,"ip_address":"","comment_id":119094,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1564502630","product_id":100028301,"comment_content":"è€å¸ˆè§å­—å¥½ã€‚æˆ‘æ¥å®ç°æ–‡ä¸­é€»è¾‘ï¼Œä½†æ˜¯æœ€åæ€»è¯´æˆ‘è¿æ¥closeï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼šhttps:&#47;&#47;www.iffor.cn&#47;job&#47;openresty-memcached-server.htmlï¼Œæœ‰æ—¶é—´çš„æ—¶å€™å¸®æˆ‘çœ‹çœ‹ã€‚æˆ‘è¿™è¾¹å‡†å¤‡æŒ‰ç…§memcacheå»æ‰¾ä¸€æ‰¾åŸå› ã€‚","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460742,"discussion_content":"ä½ ç»™çš„é“¾æ¥ä¸­æ²¡æœ‰å…·ä½“çš„æŠ¥é”™ä¿¡æ¯ã€‚å¦å¤–ï¼Œ/usr/local/openresty3/lib/resty/memached è¿™ä¸ªç›®å½•æ˜¯æ‹¼å†™é”™äº†å—ï¼Ÿæœ€åçš„ç›®å½•ååº”è¯¥ memcached è€Œä¸æ˜¯ memachedï¼Œå°‘äº†ä¸€ä¸ªå­—æ¯ c","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564543226,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1391748,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","nickname":"è¿è¾¹","note":"","ucode":"54B5DA38449728","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3514,"discussion_content":"2019/07/31 11:40:19 [error] 61528#0: *2 kevent() reported about an closed connection (54: Connection reset by peer), context: ngx.timer\nfailed to set dog: connection reset by peer\n\né‚£ä¸ªæ–‡ä»¶å¤¹æ˜¯æˆ‘æ‹¼å†™é”™äº†ã€‚\næˆ‘èƒ½ç¡®å®šçš„æ˜¯ï¼Œnginxå±‚é¢ï¼Œæ²¡æœ‰é…ç½®é”™ï¼Œå› ä¸ºå·²ç»ç›‘å¬ç«¯å£äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564544696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118970,"user_name":"æ´","can_delete":false,"product_type":"c1","uid":1510376,"ip_address":"","ucode":"154C10D830FB70","user_header":"https://static001.geekbang.org/account/avatar/00/17/0b/e8/1deb2efc.jpg","comment_is_top":false,"comment_ctime":1564476583,"is_pvip":false,"replies":[{"id":"43747","content":"æ˜¯å“ªä¸€éƒ¨åˆ†çš„é—®é¢˜å‘¢ï¼Ÿæœ‰å…·ä½“çš„æŠ¥é”™å—ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1564542983,"ip_address":"","comment_id":118970,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564476583","product_id":100028301,"comment_content":"è€å¸ˆï¼Œè¿™æ¬¡ç¤ºä¾‹memcached serverè¿˜æ˜¯æ²¡æœ‰è°ƒé€šï¼Œæ‚¨åœ¨åé¢ç­”ç–‘çš„æ—¶å€™èƒ½å¤§çº¦è®²ä¸€ä¸‹å—","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460693,"discussion_content":"æ˜¯å“ªä¸€éƒ¨åˆ†çš„é—®é¢˜å‘¢ï¼Ÿæœ‰å…·ä½“çš„æŠ¥é”™å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564542983,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117136,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1563975090,"is_pvip":false,"replies":[{"id":"43609","content":"æ˜¯çš„ï¼Œè¿™ä¸ªéœ€è¦ä¿®æ”¹ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1564468551,"ip_address":"","comment_id":117136,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563975090","product_id":100028301,"comment_content":"å¦‚æœæ˜¯ä¸ºäº†å®ç°memcachedé›†ç¾¤ï¼Œé‚£æœåŠ¡ç«¯å£å°±ä¸èƒ½ç›‘å¬127.0.0.1äº†ï¼Œå¯¹å§","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459835,"discussion_content":"æ˜¯çš„ï¼Œè¿™ä¸ªéœ€è¦ä¿®æ”¹ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564468551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117090,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1563965927,"is_pvip":false,"replies":[{"id":"42822","content":"ç›´æ¥ä½¿ç”¨å…±äº«å­—å…¸å°±æ²¡æœ‰åŠæ³•åšåˆ°é›†ç¾¤äº†ï¼Œåªèƒ½ç”¨æœ¬æœºçš„å†…å­˜èµ„æº","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563973043,"ip_address":"","comment_id":117090,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1563965927","product_id":100028301,"comment_content":"å’Œ2xshuåŒå­¦çš„æ„Ÿå—ä¸€æ ·ï¼Œä½¿ç”¨å…±äº«å­—å…¸å°è£…æ¨¡æ‹ŸæˆmemcachedæœåŠ¡ï¼Œå’Œç›´æ¥ä½¿ç”¨å…±äº«å­—å…¸ï¼Œå¯¹äºé¡¹ç›®éœ€æ±‚åˆ°ä½æœ‰å•¥æœ¬è´¨åŒºåˆ«ï¼Œå¯¹äºè¿™ä¸ªé¡¹ç›®éœ€æ±‚ç›´æ¥ä½¿ç”¨å…±äº«å­—å…¸ä¸å°±è¡Œäº†å˜›ï¼Œä¸ºå•¥è¿˜è¦è´¹äº‹çš„å»å°è£…ä¸€éå‘¢ï¼Œæ±‚è§£æƒ‘ã€‚","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459816,"discussion_content":"ç›´æ¥ä½¿ç”¨å…±äº«å­—å…¸å°±æ²¡æœ‰åŠæ³•åšåˆ°é›†ç¾¤äº†ï¼Œåªèƒ½ç”¨æœ¬æœºçš„å†…å­˜èµ„æº","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563973043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1391748,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3c/84/608f679b.jpg","nickname":"è¿è¾¹","note":"","ucode":"54B5DA38449728","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3467,"discussion_content":"ä¸å°è£…æˆä¸ºç½‘ç»œçš„å½¢åŠ¿ï¼Œå°±æ˜¯å•æœºçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564501662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}