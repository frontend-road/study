{"id":484271,"title":"å¤§å’–åŠ©é˜µï½œæ›¹æ˜¥æ™–ï¼šèŠèŠ Go è¯­è¨€çš„ GC å®ç°","content":"<blockquote>\n<p>ä½œè€…æ³¨ï¼šæœ¬æ–‡åªä½œäº†è§£ï¼Œä¸å»ºè®®ä½œä¸ºé¢è¯•é¢˜è€ƒå¯Ÿã€‚</p>\n</blockquote><p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ›¹æ˜¥æ™–ï¼Œæ˜¯ã€ŠGo è¯­è¨€é«˜çº§ç¼–ç¨‹ã€‹çš„ä½œè€…ä¹‹ä¸€ã€‚</p><p>ä»Šå¤©æˆ‘æƒ³è·Ÿä½ åˆ†äº«ä¸€ä¸‹ Go è¯­è¨€å†…å­˜æ–¹é¢çš„è¯é¢˜ï¼ŒèŠä¸€èŠGoè¯­è¨€ä¸­çš„åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœºåˆ¶çš„å®ç°ï¼Œå¸Œæœ›ä½ èƒ½ä»ä¸­æœ‰æ‰€æ”¶è·ã€‚</p><h2>æ­¦æ—ç§˜ç±æ•‘ä¸äº†æ®µé”™è¯¯</h2><p><img src=\"https://static001.geekbang.org/resource/image/5f/c8/5f4574358998f372abcab606df8803c8.png?wh=500x300\" alt=\"å›¾ç‰‡\" title=\"åŒ…æ•™åŒ…ä¼šåŒ…åˆ†é…\"></p><p>åœ¨å„ç§æµä¼ ç”šå¹¿çš„ C è¯­è¨€è‘µèŠ±å®å…¸é‡Œï¼Œä¸€èˆ¬éƒ½æœ‰è¿™ä¹ˆä¸€æ¡ç¥ç§˜çš„è§„åˆ™ï¼Œä¸èƒ½è¿”å›å±€éƒ¨å˜é‡ï¼š</p><pre><code class=\"language-plain\">int * func(void) {\n    int num = 1234;\n    /* ... */\n    return &amp;num;\n}\n</code></pre><p>duang!</p><p>å½“å‡½æ•°è¿”å›åï¼Œå‡½æ•°çš„æ ˆå¸§ï¼ˆstack frameï¼‰å°±ä¼šè¢«é”€æ¯ï¼Œå¼•ç”¨äº†è¢«é”€æ¯ä½ç½®çš„å†…å­˜ï¼Œè½»åˆ™æ•°æ®é”™ä¹±ï¼Œé‡åˆ™ segmentation faultã€‚</p><p>å¯ä»¥è¯´ï¼Œå³ä½¿ç»è¿‡äº†å…«åä¸€éš¾ï¼Œç»ˆäºæˆä¸ºäº† C è¯­è¨€ç»ä¸–é«˜æ‰‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€ƒä¸è¿‡å¤æ‚çš„å †ä¸Šå¯¹è±¡å¼•ç”¨å…³ç³»å¯¼è‡´çš„ dangling pointerï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/73/8c834c68ab195cc01200a84fc942bc73.gif?wh=984x616\" alt=\"å›¾ç‰‡\" title=\"å½“ B è¢« free æ‰ä¹‹å\"></p><p>ä½ çœ‹ï¼Œåœ¨è¿™å¼ å›¾ä¸­ï¼Œå½“ B è¢« free æ‰ä¹‹åï¼Œåº”ç”¨ç¨‹åºä¾ç„¶å¯èƒ½ä¼šä½¿ç”¨æŒ‡å‘ B çš„æŒ‡é’ˆï¼Œè¿™å°±æ˜¯æ¯”è¾ƒå…¸å‹çš„ dangling pointer é—®é¢˜ï¼Œå †ä¸Šçš„å¯¹è±¡ä¾èµ–å…³ç³»å¯èƒ½ä¼šéå¸¸å¤æ‚ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æ­£ç¡®åœ°å†™å‡º free é€»è¾‘ï¼Œè¿˜å¾—å…ˆæŠŠå¯¹è±¡å›¾ç»™ç”»å‡ºæ¥ã€‚</p><p>ä¸è¿‡ï¼Œä¾èµ–äººå»å¤„ç†å¤æ‚çš„å¯¹è±¡å†…å­˜ç®¡ç†çš„é—®é¢˜æ˜¯ä¸ç§‘å­¦ã€ä¸åˆç†çš„ã€‚C å’Œ C++ ç¨‹åºå‘˜å·²ç»è¢«æŠ˜ç£¨äº†æ•°åå¹´ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å†é‡è¹ˆè¦†è¾™äº†ï¼Œäºæ˜¯ï¼Œåæ¥çš„å¾ˆå¤šç¼–ç¨‹è¯­è¨€å°±ç”¨ä¸Šåƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœºåˆ¶ã€‚</p><!-- [[[read_end]]] --><h2>GC æ‹¯æ•‘ç¨‹åºå‘˜</h2><p>åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼‰ä¹Ÿè¢«ç§°ä¸ºè‡ªåŠ¨å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œåœ¨ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­ä½¿ç”¨å¾—ç›¸å½“å¹¿æ³›ï¼Œå¸¸è§çš„ Javaã€Goã€C# å‡åœ¨è¯­è¨€çš„ runtime ä¸­é›†æˆäº†ç›¸åº”çš„å®ç°ã€‚</p><p>åœ¨ä¼ ç»Ÿçš„ä¸å¸¦GCçš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨å¯¹è±¡çš„åˆ†é…ä½ç½®ï¼Œè¦è‡ªå·±å»é€‰æ‹©å¯¹è±¡æ˜¯åˆ†é…åœ¨å †è¿˜æ˜¯æ ˆä¸Šï¼Œä½†åœ¨ Go è¿™é—¨æœ‰ GC çš„è¯­è¨€ä¸­ï¼Œé›†æˆäº†é€ƒé€¸åˆ†æåŠŸèƒ½æ¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨åˆ¤æ–­å¯¹è±¡åº”è¯¥åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>go build -gcflags=\"-m\"</code> æ¥è§‚å¯Ÿé€ƒé€¸åˆ†æçš„ç»“æœï¼š</p><pre><code class=\"language-plain\">package main\n\nfunc main() {\n    var m = make([]int, 10240)\n    println(m[0])\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¾ƒå¤§çš„å¯¹è±¡ä¹Ÿä¼šè¢«æ”¾åœ¨å †ä¸Šã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b9/f1/b9d2859c1c108213620a17e805a69bf1.png?wh=1654x234\" alt=\"å›¾ç‰‡\"></p><p>è¿™é‡Œï¼Œæ‰§è¡Œ gcflags=â€œ-mâ€ çš„è¾“å‡ºï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å‘ç”Ÿäº†é€ƒé€¸ã€‚</p><p>è‹¥å¯¹è±¡è¢«åˆ†é…åœ¨æ ˆä¸Šï¼Œå®ƒçš„ç®¡ç†æˆæœ¬å°±æ¯”è¾ƒä½ï¼Œæˆ‘ä»¬é€šè¿‡æŒªåŠ¨æ ˆé¡¶å¯„å­˜å™¨å°±å¯ä»¥å®ç°å¯¹è±¡çš„åˆ†é…å’Œé‡Šæ”¾ã€‚è‹¥å¯¹è±¡è¢«åˆ†é…åœ¨å †ä¸Šï¼Œæˆ‘ä»¬å°±è¦ç»å†å±‚å±‚çš„å†…å­˜ç”³è¯·è¿‡ç¨‹ã€‚ä½†è¿™äº›æµç¨‹å¯¹ç”¨æˆ·éƒ½æ˜¯é€æ˜çš„ï¼Œåœ¨ç¼–å†™ä»£ç æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦åœ¨æ„å®ƒã€‚åªæœ‰éœ€è¦ä¼˜åŒ–æ—¶ï¼Œæˆ‘ä»¬æ‰éœ€è¦ç ”ç©¶å…·ä½“çš„é€ƒé€¸åˆ†æè§„åˆ™ã€‚</p><p>é€ƒé€¸åˆ†æä¸åƒåœ¾å›æ”¶ç»“åˆåœ¨ä¸€èµ·ï¼Œæå¤§åœ°è§£æ”¾äº†ç¨‹åºå‘˜ä»¬çš„å¿ƒæ™ºï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œä¼¼ä¹å†ä¹Ÿæ²¡å¿…è¦å»æ‹…å¿ƒå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾é—®é¢˜äº†ã€‚</p><p><strong>ç„¶è€Œï¼Œä¸€åˆ‡æŠ½è±¡çš†æœ‰æˆæœ¬ï¼Œè¿™ä¸ªæˆæœ¬è¦ä¹ˆèŠ±åœ¨ç¼–è¯‘æœŸï¼Œè¦ä¹ˆèŠ±åœ¨è¿è¡ŒæœŸã€‚</strong></p><p>GC è¿™ç§æ–¹æ¡ˆæ˜¯é€‰æ‹©åœ¨è¿è¡ŒæœŸæ¥è§£å†³é—®é¢˜ï¼Œä¸è¿‡åœ¨æç«¯åœºæ™¯ä¸‹ GC æœ¬èº«å¼•èµ·çš„é—®é¢˜ä¾ç„¶æ˜¯ä»¤äººéš¾ä»¥å¿½è§†çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/45/31/4561e0c863e3af8b4d785b31714fdd31.png?wh=1894x624\" alt=\"å›¾ç‰‡\" title=\"å›¾æ¥è‡ªç½‘å‹ï¼ŒGC ä½¿ç”¨äº† 90% ä»¥ä¸Šçš„ CPU èµ„æº\"></p><p>è¿™å¼ å›¾çš„åœºæ™¯æ˜¯åœ¨å†…å­˜ä¸­ç¼“å­˜äº†ä¸Šäº¿çš„ kvï¼Œè¿™æ—¶ GC ä½¿ç”¨çš„ CPU ç”šè‡³å åˆ°äº†æ€» CPU å ç”¨çš„ 90% ä»¥ä¸Šã€‚ç®€å•ç²—æš´åœ°åœ¨å†…å­˜ä¸­ç¼“å­˜å¯¹è±¡ï¼Œåˆ°å¤´æ¥å‘ç° GC æˆä¸ºäº† CPU æ€æ‰‹ï¼Œåƒæ‰äº†å¤§é‡çš„æœåŠ¡å™¨èµ„æºï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç»“æœã€‚</p><p>æƒ³è¦æ­£ç¡®åœ°åˆ†æåŸå› ï¼Œå°±éœ€è¦æˆ‘ä»¬å¯¹ GC æœ¬èº«çš„å®ç°æœºåˆ¶æœ‰ç¨å¾®æ·±å…¥ä¸€äº›çš„ç†è§£ã€‚</p><h2>å†…å­˜ç®¡ç†çš„ä¸‰ä¸ªå‚ä¸è€…</h2><p>å½“è®¨è®ºå†…å­˜ç®¡ç†é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¸»è¦ä¼šè®²ä¸‰ä¸ªå‚ä¸è€…ï¼Œmutatorï¼Œallocator å’Œ garbage collectorã€‚</p><ul>\n<li>mutator æŒ‡çš„æ˜¯æˆ‘ä»¬çš„åº”ç”¨ï¼Œä¹Ÿå°±æ˜¯ applicationï¼Œæˆ‘ä»¬å°†å †ä¸Šçš„å¯¹è±¡çœ‹ä½œä¸€ä¸ªå›¾ï¼Œè·³å‡ºåº”ç”¨æ¥çœ‹çš„è¯ï¼Œåº”ç”¨çš„ä»£ç å°±æ˜¯åœ¨ä¸åœåœ°ä¿®æ”¹è¿™å¼ å †å¯¹è±¡å›¾é‡Œçš„æŒ‡å‘å…³ç³»ã€‚ä¸‹é¢çš„å›¾å¯ä»¥å¸®æˆ‘ä»¬ç†è§£ mutator å¯¹å †ä¸Šçš„å¯¹è±¡çš„å½±å“ï¼š</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/13/56/131e1a3e08e0c2fcac022c197c433556.gif?wh=1228x676\" alt=\"å›¾ç‰‡\" title=\"åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šä¸æ–­ä¿®æ”¹å¯¹è±¡çš„å¼•ç”¨å…³ç³»\"></p><ul>\n<li>\n<p>allocator å°±å¾ˆå¥½ç†è§£äº†ï¼ŒæŒ‡çš„æ˜¯å†…å­˜åˆ†é…å™¨ï¼Œåº”ç”¨éœ€è¦å†…å­˜çš„æ—¶å€™éƒ½è¦å‘ allocator ç”³è¯·ã€‚allocator è¦ç»´æŠ¤å¥½å†…å­˜åˆ†é…çš„æ•°æ®ç»“æ„ï¼Œåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹å·¥ä½œçš„å†…å­˜åˆ†é…å™¨è¿˜éœ€è¦è€ƒè™‘é«˜å¹¶å‘åœºæ™¯ä¸‹é”çš„å½±å“ï¼Œå¹¶é’ˆå¯¹æ€§åœ°è¿›è¡Œè®¾è®¡ä»¥é™ä½é”å†²çªã€‚</p>\n</li>\n<li>\n<p>collector æ˜¯åƒåœ¾å›æ”¶å™¨ã€‚æ­»æ‰çš„å †å¯¹è±¡ã€ä¸ç”¨çš„å †å†…å­˜éƒ½è¦ç”± collector å›æ”¶ï¼Œæœ€ç»ˆå½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚å½“ GC æ‰«ææµç¨‹å¼€å§‹æ‰§è¡Œæ—¶ï¼Œcollector éœ€è¦æ‰«æå†…å­˜ä¸­å­˜æ´»çš„å †å¯¹è±¡ï¼Œæ‰«æå®Œæˆåï¼Œæœªè¢«æ‰«æåˆ°çš„å¯¹è±¡å°±æ˜¯æ— æ³•è®¿é—®çš„å †ä¸Šåƒåœ¾ï¼Œéœ€è¦å°†å…¶å ç”¨å†…å­˜å›æ”¶æ‰ã€‚</p>\n</li>\n</ul><p>ä¸‰è€…çš„äº¤äº’è¿‡ç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/09/yy/093e3db4643e289d0803943124115dyy.png?wh=1920x1268\" alt=\"å›¾ç‰‡\" title=\"mutatorã€allocator å’Œ collector çš„äº¤äº’è¿‡ç¨‹\"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåº”ç”¨éœ€è¦åœ¨å †ä¸Šç”³è¯·å†…å­˜æ—¶ï¼Œä¼šç”±ç¼–è¯‘å™¨å¸®ç¨‹åºå‘˜è‡ªåŠ¨è°ƒç”¨runtime.newobjectï¼Œè¿™æ—¶ allocator ä¼šä½¿ç”¨ mmap è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·å†…å­˜ï¼Œè‹¥ allocator å‘ç°ä¹‹å‰ç”³è¯·çš„å†…å­˜è¿˜æœ‰å¯Œä½™ï¼Œä¼šä»æœ¬åœ°é¢„å…ˆåˆ†é…çš„æ•°æ®ç»“æ„ä¸­åˆ’åˆ†å‡ºä¸€å—å†…å­˜ï¼Œå¹¶æŠŠå®ƒä»¥æŒ‡é’ˆçš„å½¢å¼è¿”å›ç»™åº”ç”¨ã€‚åœ¨å†…å­˜åˆ†é…çš„è¿‡ç¨‹ä¸­ï¼Œallocator è¦è´Ÿè´£ç»´æŠ¤å†…å­˜ç®¡ç†å¯¹åº”çš„æ•°æ®ç»“æ„ã€‚</p><p>è€Œcollector è¦æ‰«æçš„å°±æ˜¯ allocator ç®¡ç†çš„è¿™äº›æ•°æ®ç»“æ„ï¼Œåº”ç”¨ä¸å†ä½¿ç”¨çš„éƒ¨åˆ†ä¾¿åº”è¯¥è¢«å›æ”¶ï¼Œé€šè¿‡ madvise è¿™ä¸ªç³»ç»Ÿè°ƒç”¨è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›äº¤äº’çš„ç»†èŠ‚å§ã€‚</p><h2>åˆ†é…å†…å­˜</h2><p>åº”ç”¨ç¨‹åºä½¿ç”¨ mmap å‘ OS ç”³è¯·å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿæä¾›çš„æ¥å£æ¯”è¾ƒç®€å•ï¼Œmmap è¿”å›çš„ç»“æœæ˜¯è¿ç»­çš„å†…å­˜åŒºåŸŸã€‚</p><p>mutator ç”³è¯·å†…å­˜æ˜¯ä»¥åº”ç”¨è§†è§’æ¥çœ‹é—®é¢˜ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘éœ€è¦çš„æ˜¯æŸä¸€ä¸ª structå’ŒæŸä¸€ä¸ª slice å¯¹åº”çš„å†…å­˜ï¼Œè¿™ä¸ä»æ“ä½œç³»ç»Ÿä¸­è·å–å†…å­˜çš„æ¥å£ä¹‹é—´è¿˜æœ‰ä¸€ä¸ªé¸¿æ²Ÿã€‚è¿™å°±éœ€è¦ç”± allocator è¿›è¡Œæ˜ å°„ä¸è½¬æ¢ï¼Œå°†ä»¥â€œå—â€æ¥çœ‹å¾…çš„å†…å­˜ä¸ä»¥â€œå¯¹è±¡â€æ¥çœ‹å¾…çš„å†…å­˜è¿›è¡Œæ˜ å°„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/92/76/926bc8690be714ed9140f25c0e03c276.png?wh=1556x782\" alt=\"å›¾ç‰‡\" title=\"åº”ç”¨ä»£ç ä¸­çš„å¯¹è±¡ä¸å†…å­˜é—´æ€ä¹ˆåšæ˜ å°„ï¼Ÿ\"></p><p>ä½ å¯ä»¥ä»ä¸Šé¢è¿™å¼ å›¾çœ‹åˆ°ï¼Œåœ¨åº”ç”¨çš„è§†è§’çœ‹ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–çš„ a æ˜¯ä¸€ä¸ª 1024000 é•¿åº¦çš„ int åˆ‡ç‰‡ï¼›åœ¨å†…å­˜ç®¡ç†çš„è§†è§’æ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦ç®¡ç†çš„åªæ˜¯ startã€offset å¯¹åº”çš„ä¸€æ®µå†…å­˜ã€‚</p><p>åœ¨ç°ä»£ CPU ä¸Šï¼Œé™¤äº†å†…å­˜åˆ†é…çš„æ­£ç¡®æ€§ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘åˆ†é…è¿‡ç¨‹çš„æ•ˆç‡é—®é¢˜ï¼Œåº”ç”¨æ‰§è¡ŒæœŸé—´å°å¯¹è±¡ä¼šä¸æ–­åœ°ç”Ÿæˆä¸é”€æ¯ï¼Œå¦‚æœæ¯ä¸€æ¬¡å¯¹è±¡çš„åˆ†é…ä¸é‡Šæ”¾éƒ½éœ€è¦ä¸æ“ä½œç³»ç»Ÿäº¤äº’ï¼Œé‚£ä¹ˆæˆæœ¬æ˜¯å¾ˆé«˜çš„ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åœ¨åº”ç”¨å±‚è®¾è®¡å¥½å†…å­˜åˆ†é…çš„å¤šçº§ç¼“å­˜ï¼Œå°½é‡å‡å°‘å°å¯¹è±¡é«˜é¢‘åˆ›å»ºä¸é”€æ¯æ—¶çš„é”ç«äº‰ï¼Œè¿™ä¸ªé—®é¢˜åœ¨ä¼ ç»Ÿçš„ C/C++ è¯­è¨€ä¸­å·²ç»æœ‰äº†è§£æ³•ï¼Œé‚£å°±æ˜¯ tcmallocï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/fd/60/fd5c558298850305b5dae88b856d1c60.png?wh=833x353\" alt=\"å›¾ç‰‡\" title=\"tcmalloc çš„å…¨å±€å›¾\"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œtcmalloc é€šè¿‡ç»´æŠ¤ä¸€å¥—å¤šçº§ç¼“å­˜ç»“æ„ï¼Œé™ä½äº†åº”ç”¨å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­å¯¹å…¨å±€é”çš„ä½¿ç”¨é¢‘ç‡ï¼Œä½¿å°å¯¹è±¡çš„å†…å­˜åˆ†é…åšåˆ°äº†<strong>å°½é‡æ— é”</strong>ã€‚</p><p>Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨åŸºæœ¬æ˜¯ tcmalloc çš„ 1:1 æ¬è¿â€¦â€¦æ¯•ç«Ÿéƒ½æ˜¯ Google çš„é¡¹ç›®ã€‚</p><p>åœ¨ Go è¯­è¨€ä¸­ï¼Œæ ¹æ®å¯¹è±¡ä¸­æ˜¯å¦æœ‰æŒ‡é’ˆä»¥åŠå¯¹è±¡çš„å¤§å°ï¼Œå°†å†…å­˜åˆ†é…è¿‡ç¨‹åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul>\n<li>tiny ï¼šsize &lt; 16 bytes &amp;&amp; has no pointer(noscan)ï¼›</li>\n<li>small ï¼šhas pointer(scan) || (size &gt;= 16 bytes &amp;&amp; size &lt;= 32 KB)ï¼›</li>\n<li>large ï¼šsize &gt; 32 KBã€‚</li>\n</ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€ä¸ªä¸ªåˆ†æã€‚åœ¨å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­ï¼Œæœ€å¤æ‚çš„å°±æ˜¯ tiny ç±»å‹çš„åˆ†é…ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°†å†…å­˜åˆ†é…çš„è·¯å¾„ä¸ CPU çš„å¤šçº§ç¼“å­˜ä½œç±»æ¯”ï¼Œè¿™é‡Œ mcache å†…éƒ¨çš„ tiny å¯ä»¥ç±»æ¯”ä¸º L1 cacheï¼Œè€Œ alloc æ•°ç»„ä¸­çš„å…ƒç´ å¯ä»¥ç±»æ¯”ä¸º L2 cacheï¼Œå…¨å±€çš„ mheap.mcentral ç»“æ„ä¸º L3 cacheï¼Œmheap.arenas æ˜¯ L4ï¼ŒL4 æ˜¯ä»¥é¡µä¸ºå•ä½å°†å†…å­˜å‘ä¸‹æ´¾å‘çš„ï¼Œç”± pageAlloc æ¥ç®¡ç† arena ä¸­çš„ç©ºé—²å†…å­˜ã€‚å…·ä½“ä½ å¯ä»¥çœ‹ä¸‹è¿™å¼ è¡¨ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/13/8c/13be38850045c513f9393da115fdc18c.jpg?wh=856x268\" alt=\"å›¾ç‰‡\"></p><p>å¦‚æœ L4 ä¹Ÿæ²¡æ³•æ»¡è¶³æˆ‘ä»¬çš„å†…å­˜åˆ†é…éœ€æ±‚ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å‘æ“ä½œç³»ç»Ÿå»è¦å†…å­˜äº†ã€‚</p><p>å’Œ tiny çš„å››çº§åˆ†é…è·¯å¾„ç›¸æ¯”ï¼Œsmall ç±»å‹çš„å†…å­˜æ²¡æœ‰æœ¬åœ°çš„ mcache.tiny ç¼“å­˜ï¼Œå…¶ä½™çš„ä¸ tiny åˆ†é…è·¯å¾„å®Œå…¨ä¸€è‡´ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/b0/5f/b0f9dbb98c61175265e79c1a222d475f.jpg?wh=834x256\" alt=\"å›¾ç‰‡\"></p><p>large å†…å­˜åˆ†é…ç¨å¾®ç‰¹æ®Šä¸€äº›ï¼Œæ²¡æœ‰å‰é¢è¿™ä¸¤ç±»è¿™æ ·å¤æ‚çš„ç¼“å­˜æµç¨‹ï¼Œè€Œæ˜¯ç›´æ¥ä» mheap.arenas ä¸­è¦å†…å­˜ï¼Œç›´æ¥èµ° pageAlloc é¡µåˆ†é…å™¨ã€‚</p><p>é¡µåˆ†é…å™¨åœ¨ Go è¯­è¨€ä¸­è¿­ä»£äº†å¤šä¸ªç‰ˆæœ¬ï¼Œä»ç®€å•çš„ freelist ç»“æ„ï¼Œåˆ° treap ç»“æ„ï¼Œå†åˆ°ç°åœ¨æœ€æ–°ç‰ˆæœ¬çš„ radix ç»“æ„ï¼Œå®ƒçš„æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ä¹Ÿä» O(N) -&gt; O(log(n)) -&gt; O(1)ã€‚</p><p>åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¸¸æ•°æ—¶é—´å¤æ‚åº¦å°±å¯ä»¥ç¡®å®šç©ºé—²é¡µç»„æˆçš„ radix tree æ˜¯å¦èƒ½å¤Ÿæ»¡è¶³å†…å­˜åˆ†é…éœ€æ±‚ã€‚è‹¥ä¸æ»¡è¶³ï¼Œåˆ™è¦å¯¹ arena ç»§ç»­è¿›è¡Œåˆ‡åˆ†ï¼Œæˆ–å‘æ“ä½œç³»ç»Ÿç”³è¯·æ›´å¤šçš„ arenaã€‚</p><p>åªçœ‹è¿™äº›åˆ†ç±»æ–‡å­—ä¸å¤ªå¥½ç†è§£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ arenasã€pageã€mspanã€alloc è¿™äº›æ¦‚å¿µæ˜¯æ€ä¹ˆå…³è”åœ¨ä¸€èµ·ç»„æˆ Go çš„å†…å­˜åˆ†é…æµç¨‹çš„ã€‚</p><h3>å†…å­˜åˆ†é…çš„æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»</h3><p>arenas æ˜¯ Go å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜æ—¶çš„æœ€å°å•ä½ï¼Œæ¯ä¸ª arena ä¸º 64MB å¤§å°ï¼Œåœ¨å†…å­˜ä¸­å¯ä»¥éƒ¨åˆ†è¿ç»­ï¼Œä½†æ•´ä½“æ˜¯ä¸ªç¨€ç–ç»“æ„ã€‚</p><p>å•ä¸ª arena ä¼šè¢«åˆ‡åˆ†æˆä»¥ 8KB ä¸ºå•ä½çš„ pageï¼Œç”± page allocator ç®¡ç†ï¼Œä¸€ä¸ªæˆ–å¤šä¸ª page å¯ä»¥ç»„æˆä¸€ä¸ª mspanï¼Œæ¯ä¸ª mspan å¯ä»¥æŒ‰ç…§ sizeclass å†åˆ’åˆ†æˆå¤šä¸ª elementã€‚åŒæ ·å¤§å°çš„ mspan åˆåˆ†ä¸º scan å’Œ noscan ä¸¤ç§ï¼Œåˆ†åˆ«å¯¹åº”å†…éƒ¨æœ‰æŒ‡é’ˆçš„ object å’Œå†…éƒ¨æ²¡æœ‰æŒ‡é’ˆçš„ objectã€‚</p><p>ä¹‹å‰è®²åˆ°çš„å››çº§åˆ†é…ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0b/9a/0be6329b8a9a40d3eaa693c2e6b3ed9a.png?wh=1920x1500\" alt=\"å›¾ç‰‡\" title=\"å„ç§å†…å­˜åˆ†é…ç»“æ„ä¹‹é—´çš„å…³ç³»ï¼Œå›¾ä¸Šçœç•¥äº†é¡µåˆ†é…å™¨çš„ç»“æ„\"></p><p>ä½ å¯ä»¥ä»ä¸Šå›¾æ¸…æ™°åœ°çœ‹åˆ°å†…å­˜åˆ†é…çš„å¤šçº§è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥å†ç ”ç©¶ä¸€ä¸‹è¿™é‡Œé¢çš„ mspanã€‚æ¯ä¸€ä¸ª mspan éƒ½æœ‰ä¸€ä¸ª allocBits ç»“æ„ï¼Œä» mspan é‡Œåˆ†é… element æ—¶ï¼Œæˆ‘ä»¬åªè¦å°† mspan ä¸­å¯¹åº”è¯¥ element ä½ç½®çš„ bit ä½ç½®ä¸€å°±å¯ä»¥äº†ï¼Œå…¶å®å°±æ˜¯å°† mspan å¯¹åº” allocBits ä¸­çš„å¯¹åº” bit ä½ç½®ä¸€ã€‚æ¯ä¸€ä¸ª mspan éƒ½ä¼šå¯¹åº”ä¸€ä¸ª allocBits ç»“æ„ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/5f/e9c7b25f9fc787c7317a07aac648d65f.png?wh=1664x726\" alt=\"å›¾ç‰‡\"></p><p>å½“ç„¶ï¼Œåœ¨ä»£ç ä¸­è¿˜æœ‰ä¸€äº›ä½æ“ä½œä¼˜åŒ–ï¼ˆå¦‚freeIndexã€allocCacheï¼‰ï¼Œä½ è¯¾åå¯ä»¥å†å»æ¢ç´¢ä¸€ä¸‹ã€‚</p><p>äº†è§£äº†Goè¯­è¨€ä¸­å†…å­˜ç®¡ç†å’Œå†…å­˜åˆ†é…çš„åŸºç¡€çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å…·ä½“çœ‹çœ‹Goè¯­è¨€ä¸­åƒåœ¾å›æ”¶çš„å®ç°ã€‚</p><h2>åƒåœ¾å›æ”¶</h2><p>Go è¯­è¨€ä½¿ç”¨äº†<strong>å¹¶å‘æ ‡è®°ä¸æ¸…æ‰«ç®—æ³•</strong>ä½œä¸ºå®ƒçš„ GC å®ç°ã€‚</p><p>æ ‡è®°ã€æ¸…æ‰«ç®—æ³•æ˜¯ä¸€ç§å¤è€çš„ GC ç®—æ³•ï¼Œæ˜¯æŒ‡å°†å†…å­˜ä¸­æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œä¹‹åæ¸…æ‰«æ‰é‚£äº›æœªè¢«æ ‡è®°çš„å¯¹è±¡çš„ä¸€ç§åƒåœ¾å›æ”¶ç®—æ³•ã€‚å¹¶å‘æ ‡è®°ä¸æ¸…æ‰«é‡ç‚¹åœ¨<strong>å¹¶å‘</strong>ï¼Œæ˜¯æŒ‡åƒåœ¾å›æ”¶çš„<strong>æ ‡è®°å’Œæ¸…æ‰«è¿‡ç¨‹èƒ½å¤Ÿä¸åº”ç”¨ä»£ç å¹¶å‘æ‰§è¡Œ</strong>ã€‚ä½†å¹¶å‘æ ‡è®°æ¸…æ‰«ç®—æ³•çš„ä¸€å¤§ç¼ºé™·æ˜¯æ— æ³•è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œè€Œ tcmalloc æ°å¥½ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£äº†å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œä¸¤è€…é…åˆä½¿ç”¨ç›¸å¾—ç›Šå½°ã€‚</p><p><strong>ä½†è¿™å¹¶ä¸æ˜¯è¯´ tcmalloc å®Œå…¨æ²¡æœ‰å†…å­˜ç¢ç‰‡ï¼Œä¸ä¿¡ä½ å¯ä»¥åœ¨ä»£ç é‡Œæœæœ max waste</strong>ã€‚</p><h3>åƒåœ¾åˆ†ç±»</h3><p>è¿›è¡Œåƒåœ¾å›æ”¶ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆå¯¹å†…å­˜åƒåœ¾è¿›è¡Œåˆ†ç±»ï¼Œä¸»è¦å¯ä»¥åˆ†ä¸ºè¯­ä¹‰åƒåœ¾å’Œè¯­æ³•åƒåœ¾ä¸¤ç±»ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰åƒåœ¾éƒ½å¯ä»¥è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/69/85/690e321578d8a90c5808a63656af9485.png?wh=512x218\" alt=\"å›¾ç‰‡\" title=\"è¯­æ³•åƒåœ¾å’Œè¯­ä¹‰åƒåœ¾\"></p><p><strong>è¯­ä¹‰åƒåœ¾ï¼ˆsemantic garbageï¼‰</strong>ï¼Œæœ‰äº›åœºæ™¯ä¹Ÿè¢«ç§°ä¸ºå†…å­˜æ³„éœ²ï¼ŒæŒ‡çš„æ˜¯ä»è¯­æ³•ä¸Šå¯è¾¾ï¼ˆå¯ä»¥é€šè¿‡å±€éƒ¨ã€å…¨å±€å˜é‡è¢«å¼•ç”¨ï¼‰çš„å¯¹è±¡ï¼Œä½†ä»è¯­ä¹‰ä¸Šæ¥è®²ä»–ä»¬æ˜¯åƒåœ¾ï¼Œåƒåœ¾å›æ”¶å™¨å¯¹æ­¤æ— èƒ½ä¸ºåŠ›ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªè¯­ä¹‰åƒåœ¾åœ¨ Go è¯­è¨€ä¸­çš„å®ä¾‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8e/d5/8eb4fc5be983a6821b0581eab2a3aed5.png?wh=1900x1072\" alt=\"å›¾ç‰‡\"></p><p>è¿™é‡Œï¼Œæˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ª sliceï¼Œå…ƒç´ å‡ä¸ºæŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘äº†å †ä¸Š 10MB å¤§å°çš„ä¸€ä¸ªå¯¹è±¡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a4/87/a45499dab31de5e0888d3002e3529387.png?wh=1870x1174\" alt=\"å›¾ç‰‡\"></p><p>å½“è¿™ä¸ª slice ç¼©å®¹æ—¶ï¼Œåº•å±‚æ•°ç»„çš„åä¸¤ä¸ªå…ƒç´ å·²ç»æ— æ³•å†è®¿é—®äº†ï¼Œä½†å®ƒå…³è”çš„å †ä¸Šå†…å­˜ä¾ç„¶æ˜¯æ— æ³•é‡Šæ”¾çš„ã€‚</p><p>ç¢°åˆ°ç±»ä¼¼çš„åœºæ™¯ï¼Œä½ å¯èƒ½éœ€è¦åœ¨ç¼©å®¹å‰ï¼Œ<strong>å…ˆå°†æ•°ç»„å…ƒç´ ç½®ä¸º nil</strong>ã€‚</p><p>å¦å¤–ä¸€ç§å†…å­˜åƒåœ¾å°±æ˜¯<strong>è¯­æ³•åƒåœ¾ï¼ˆsyntactic garbageï¼‰</strong>ï¼Œè®²çš„æ˜¯é‚£äº›ä»è¯­æ³•ä¸Šæ— æ³•åˆ°è¾¾çš„å¯¹è±¡ï¼Œè¿™äº›æ‰æ˜¯åƒåœ¾æ”¶é›†å™¨ä¸»è¦çš„æ”¶é›†ç›®æ ‡ã€‚</p><p>æˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£ä¸€ä¸‹è¯­æ³•åƒåœ¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/f6/f3/f687c68dbf35ee45b208e561352493f3.png?wh=1152x978\" alt=\"å›¾ç‰‡\"></p><p>è¿™æ®µä»£ç ä¸­ï¼Œåœ¨ allocOnHeap è¿”å›åï¼Œå †ä¸Šçš„ a æ— æ³•è®¿é—®ï¼Œä¾¿æˆä¸ºäº†è¯­æ³•åƒåœ¾ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»æ˜ç™½äº†åƒåœ¾å›æ”¶çš„å¯¹è±¡æ˜¯è¯­æ³•åƒåœ¾ï¼Œé‚£Go GCçš„æ‰§è¡Œæµç¨‹å…·ä½“æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><h3>GC æµç¨‹</h3><p>Go çš„æ¯ä¸€è½®ç‰ˆæœ¬è¿­ä»£å‡ ä¹éƒ½ä¼šå¯¹ GC åšä¼˜åŒ–ã€‚ç»è¿‡å¤šæ¬¡ä¼˜åŒ–åï¼Œè¾ƒæ–°çš„ GC æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/64/7b/64d7433118dc109f6616c07681bc127b.png?wh=1920x738\" alt=\"å›¾ç‰‡\" title=\"GC æ‰§è¡Œæµç¨‹\"></p><p>åœ¨è¿™å¼ å›¾ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¹¶å‘æ ‡è®°å¼€å§‹å‰å’Œå¹¶å‘æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œæœ‰ä¸¤ä¸ªçŸ­æš‚çš„ stwï¼Œè¯¥ stw å¯ä»¥ä½¿ç”¨ pprof çš„ pauseNs æ¥è§‚æµ‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é‡‡é›†åˆ°ç›‘æ§ç³»ç»Ÿä¸­ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a0/2c/a0b73ddd6dbeca15dc491d4738af332c.png?wh=1514x414\" alt=\"å›¾ç‰‡\"></p><p>ç›‘æ§ç³»ç»Ÿä¸­çš„ PauseNs å°±æ˜¯æ¯æ¬¡ stw çš„æ—¶é•¿ã€‚å°½ç®¡å®˜æ–¹å£°ç§° Go çš„ stw å·²ç»æ˜¯äºšæ¯«ç§’çº§äº†ï¼Œä½†æˆ‘ä»¬åœ¨é«˜å‹åŠ›çš„ç³»ç»Ÿä¸­ä»ç„¶èƒ½å¤Ÿçœ‹åˆ°æ¯«ç§’çº§çš„ stwã€‚</p><p>å¯¹Go GCæµç¨‹æœ‰äº†ä¸€äº›åŸºæœ¬äº†è§£åï¼Œæˆ‘ä»¬ç°åœ¨â€œåˆ’é‡ç‚¹â€ï¼Œå…·ä½“çœ‹çœ‹ Go GCä¸­çš„é‚£äº›å…³é”®æµç¨‹å’Œå…³é”®é—®é¢˜ã€‚</p><h3>æ ‡è®°æµç¨‹</h3><p>Go è¯­è¨€ä½¿ç”¨ä¸‰è‰²æŠ½è±¡ä½œä¸ºå…¶å¹¶å‘æ ‡è®°çš„å®ç°ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é¦–å…ˆè¦ç†è§£ä¸‰ç§é¢œè‰²çš„æŠ½è±¡ï¼š</p><ul>\n<li>é»‘è¡¨ç¤ºå·²ç»æ‰«æå®Œæ¯•ï¼Œå­èŠ‚ç‚¹æ‰«æå®Œæ¯•ï¼ˆgcmarkbits = 1ï¼Œä¸”åœ¨é˜Ÿåˆ—å¤–ï¼‰ï¼›</li>\n<li>ç°è¡¨ç¤ºå·²ç»æ‰«æå®Œæ¯•ï¼Œå­èŠ‚ç‚¹æœªæ‰«æå®Œæ¯•ï¼ˆgcmarkbits = 1, åœ¨é˜Ÿåˆ—å†…ï¼‰ï¼›</li>\n<li>ç™½è¡¨ç¤ºæœªæ‰«æï¼Œcollector ä¸çŸ¥é“ä»»ä½•ç›¸å…³ä¿¡æ¯ã€‚</li>\n</ul><p>ä½¿ç”¨ä¸‰è‰²æŠ½è±¡ï¼Œä¸»è¦æ˜¯ä¸ºäº†èƒ½è®©åƒåœ¾å›æ”¶æµç¨‹ä¸åº”ç”¨æµç¨‹å¹¶å‘æ‰§è¡Œï¼Œè¿™æ ·å°†å¯¹è±¡æ‰«æè¿‡ç¨‹æ‹†åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œä¸éœ€è¦ä¸€æ¬¡æ€§å®Œæˆæ•´ä¸ªæ‰«ææµç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e8/11/e87f2cc71ea90d0e2a084211d33cf311.jpeg?wh=1920x1080\" alt=\"å›¾ç‰‡\" title=\"GC çº¿ç¨‹ä¸åº”ç”¨çº¿ç¨‹å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯å¹¶å‘æ‰§è¡Œçš„\"></p><p>GC æ‰«æçš„èµ·ç‚¹æ˜¯æ ¹å¯¹è±¡ï¼Œå¿½ç•¥æ‰é‚£äº›ä¸é‡è¦çš„ï¼ˆfinalizer ç›¸å…³çš„å…ˆçœç•¥ï¼‰ï¼Œå¸¸è§çš„æ ¹å¯¹è±¡å¯ä»¥å‚è§ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/db/f5/dbc5ab091c2ac0f026ebddc97926fef5.png?wh=1920x1301\" alt=\"å›¾ç‰‡\"></p><p>æ‰€ä»¥åœ¨ Go è¯­è¨€ä¸­ï¼Œä»æ ¹å¼€å§‹æ‰«æçš„å«ä¹‰æ˜¯ä» .bss æ®µï¼Œ.data æ®µä»¥åŠ goroutine çš„æ ˆå¼€å§‹æ‰«æï¼Œæœ€ç»ˆéå†æ•´ä¸ªå †ä¸Šçš„å¯¹è±¡æ ‘ã€‚</p><p>æ ‡è®°è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¹¿åº¦ä¼˜å…ˆçš„éå†è¿‡ç¨‹ã€‚å®ƒæ˜¯æ‰«æèŠ‚ç‚¹ï¼Œå°†èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ¨åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åé€’å½’æ‰«æå­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œç›´åˆ°æ‰€æœ‰å·¥ä½œé˜Ÿåˆ—éƒ½è¢«æ’ç©ºä¸ºæ­¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/39/df/3942dd9c208f7841d0f5d0310fa2f0df.gif?wh=1222x678\" alt=\"å›¾ç‰‡\" title=\"åå°æ ‡è®° worker çš„å·¥ä½œè¿‡ç¨‹\"></p><p>æ ‡è®°è¿‡ç¨‹ä¼šå°†ç™½è‰²å¯¹è±¡æ ‡è®°ï¼Œå¹¶æ¨è¿›é˜Ÿåˆ—ä¸­å˜æˆç°è‰²å¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ scanobject çš„å…·ä½“è¿‡ç¨‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/94/4c/94ddaa38fc4923d3be06de7b47f3964c.gif?wh=1226x678\" alt=\"å›¾ç‰‡\" title=\"åœ¨åå°çš„ mark worker æ‰§è¡Œå¯¹è±¡æ‰«æï¼Œå¹¶å°† ptr push åˆ°å·¥ä½œé˜Ÿåˆ—\"></p><p>åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œgc mark worker ä¼šä¸€è¾¹ä»å·¥ä½œé˜Ÿåˆ—ï¼ˆgcwï¼‰ä¸­å¼¹å‡ºå¯¹è±¡ï¼Œä¸€è¾¹æŠŠå®ƒçš„å­å¯¹è±¡ push åˆ°å·¥ä½œé˜Ÿåˆ—ï¼ˆgcwï¼‰ä¸­ï¼Œå¦‚æœå·¥ä½œé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™è¦å°†ä¸€éƒ¨åˆ†å…ƒç´ å‘å…¨å±€é˜Ÿåˆ—è½¬ç§»ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå †ä¸Šå¯¹è±¡æœ¬è´¨ä¸Šæ˜¯å›¾ï¼Œä¼šå­˜å‚¨å¼•ç”¨å…³ç³»äº’ç›¸äº¤å‰çš„æ—¶å€™ï¼Œåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ä¹Ÿæœ‰ç®€å•çš„å‰ªæé€»è¾‘ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/8d/5c/8d9066cdfd55f0cc3a6e23216dd42f5c.png?wh=1920x1287\" alt=\"å›¾ç‰‡\" title=\"å¦‚æœä¸¤ä¸ªåå° mark worker åˆ†åˆ«ä» Aã€B è¿™ä¸¤ä¸ªæ ¹å¼€å§‹æ ‡è®°ï¼Œä»–ä»¬ä¼šé‡å¤æ ‡è®° D å—ï¼Ÿ\"></p><p>è¿™é‡Œï¼ŒD æ˜¯ A å’Œ B çš„å…±åŒå­èŠ‚ç‚¹ï¼Œåœ¨æ ‡è®°è¿‡ç¨‹ä¸­è‡ªç„¶ä¼šå‡æï¼Œé˜²æ­¢é‡å¤æ ‡è®°æµªè´¹è®¡ç®—èµ„æºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0a/b5/0a139bd980ff1e88ec529e4eb29849b5.png?wh=808x306\" alt=\"å›¾ç‰‡\" title=\"æ ‡è®°è¿‡ç¨‹ä¸­é€šè¿‡ isMarked åˆ¤æ–­æ¥è¿›è¡Œå‰ªæ\"></p><p>å¦‚æœå¤šä¸ªåå° mark worker ç¡®å®äº§ç”Ÿäº†å¹¶å‘ï¼Œæ ‡è®°æ—¶ä½¿ç”¨çš„æ˜¯ atomic.Or8ï¼Œä¹Ÿæ˜¯å¹¶å‘å®‰å…¨çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/16/f2/168d6ba157a7ac43c699873d3ccbf7f2.png?wh=1428x402\" alt=\"å›¾ç‰‡\" title=\"æ ‡è®°ä½¿ç”¨ atomic.Or8ï¼Œæ˜¯å¹¶å‘å®‰å…¨çš„\"></p><h3>ååŠ©æ ‡è®°</h3><p>å½“åº”ç”¨åˆ†é…å†…å­˜è¿‡å¿«æ—¶ï¼Œåå°çš„ mark worker æ— æ³•åŠæ—¶å®Œæˆæ ‡è®°å·¥ä½œï¼Œè¿™æ—¶åº”ç”¨æœ¬èº«éœ€è¦è¿›è¡Œå †å†…å­˜åˆ†é…æ—¶ï¼Œä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦é€‚å½“ååŠ© GC çš„æ ‡è®°è¿‡ç¨‹ï¼Œé˜²æ­¢åº”ç”¨å› ä¸ºåˆ†é…è¿‡å¿«å‘ç”Ÿ OOMã€‚</p><p>ç¢°åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨ç«ç„°å›¾ä¸­çœ‹åˆ°å¯¹åº”çš„ååŠ©æ ‡è®°çš„è°ƒç”¨æ ˆï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/82/93/8248e8a329a139e5d7ea34424991da93.png?wh=1030x962\" alt=\"å›¾ç‰‡\"></p><p>ä¸è¿‡ï¼ŒååŠ©æ ‡è®°ä¼šå¯¹åº”ç”¨çš„å“åº”å»¶è¿Ÿäº§ç”Ÿå½±å“ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é™ä½åº”ç”¨çš„å¯¹è±¡åˆ†é…æ•°é‡è¿›è¡Œä¼˜åŒ–ã€‚Go å†…éƒ¨å…·ä½“æ˜¯é€šè¿‡ä¸€å¥—è®°è´¦è¿˜è´¦ç³»ç»Ÿæ¥å®ç°ååŠ©æ ‡è®°çš„æµç¨‹çš„ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸æ˜¯æˆ‘ä»¬è¿™ä¸€è®²çš„é‡ç‚¹ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥å»çœ‹çœ‹<a href=\"https://github.com/golang/go/blob/11b28e7e98bce0d92d8b49c6d222fb66858994ff/src/runtime/mgcmark.go#L407\">è¿™é‡Œ</a> ã€‚</p><h3>å¯¹è±¡ä¸¢å¤±é—®é¢˜</h3><p>å‰é¢æˆ‘ä»¬æåˆ°äº† GC çº¿ç¨‹/åç¨‹ä¸åº”ç”¨çº¿ç¨‹/åç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œåœ¨ GC æ ‡è®° worker å·¥ä½œæœŸé—´ï¼Œåº”ç”¨è¿˜ä¼šä¸æ–­åœ°ä¿®æ”¹å †ä¸Šå¯¹è±¡çš„å¼•ç”¨å…³ç³»ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´å¯¹è±¡ä¸¢å¤±é—®é¢˜ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ä¸ GC åŒæ—¶æ‰§è¡Œæ—¶ï¼Œç”±äºåº”ç”¨å¯¹æŒ‡é’ˆçš„å˜æ›´å¯¼è‡´å¯¹è±¡æ¼æ ‡è®°ï¼Œä»è€Œè¢« GC è¯¯å›æ”¶çš„æƒ…å†µã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/19/a5/193926b4yydde270f88c62d2a8dc21a5.gif?wh=1224x674\" alt=\"å›¾ç‰‡\"></p><p>åœ¨è¿™å¼ å›¾è¡¨ç°çš„ GC æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨åŠ¨æ€åœ°ä¿®æ”¹äº† A å’Œ C çš„æŒ‡é’ˆï¼Œè®© A å¯¹è±¡çš„å†…éƒ¨æŒ‡é’ˆæŒ‡å‘äº† Bï¼ŒC çš„å†…éƒ¨æŒ‡é’ˆæŒ‡å‘äº† Dã€‚å¦‚æœæ ‡è®°è¿‡ç¨‹åƒåœ¾æ”¶é›†å™¨æ— æ³•æ„ŸçŸ¥åˆ°è¿™ç§å˜åŒ–ï¼Œæœ€ç»ˆ B å¯¹è±¡åœ¨æ ‡è®°å®Œæˆåæ˜¯ç™½è‰²ï¼Œä¼šè¢«é”™è¯¯åœ°è®¤ä½œå†…å­˜åƒåœ¾è¢«å›æ”¶ã€‚</p><p>ä¸ºäº†è§£å†³æ¼æ ‡ï¼Œé”™æ ‡çš„é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆéœ€è¦å®šä¹‰â€œ<strong>ä¸‰è‰²ä¸å˜æ€§</strong>â€ï¼Œå¦‚æœæˆ‘ä»¬çš„å †ä¸Šå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ç®¡æ€ä¹ˆä¿®æ”¹ï¼Œéƒ½èƒ½æ»¡è¶³ä¸‰è‰²ä¸å˜æ€§ï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿå¯¹è±¡ä¸¢å¤±é—®é¢˜ã€‚ä¸‰è‰²ä¸å˜æ€§å¯ä»¥åˆ†ä¸ºå¼ºä¸‰è‰²ä¸å˜æ€§å’Œå¼±ä¸‰è‰²ä¸å˜æ€§ä¸¤ç§ï¼Œ</p><p>é¦–å…ˆæ˜¯å¼ºä¸‰è‰²ä¸å˜æ€§ï¼ˆstrong tricolor invariantï¼‰ï¼Œç¦æ­¢é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e5/7e/e5bc46c9a0d590dc7e4baa8b6391527e.png?wh=866x1188\" alt=\"å›¾ç‰‡\" title=\"å¼ºä¸‰è‰²ä¸å˜æ€§\"></p><p>ç„¶åæ˜¯å¼±ä¸‰è‰²ä¸å˜æ€§ï¼ˆweak tricolor invariantï¼‰ï¼Œé»‘è‰²å¯¹è±¡å¯ä»¥æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œä½†æŒ‡å‘çš„ç™½è‰²å¯¹è±¡ï¼Œå¿…é¡»æœ‰èƒ½ä»ç°è‰²å¯¹è±¡å¯è¾¾çš„è·¯å¾„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/00/1a/00af8b225d3f5ca747bc6356d389671a.png?wh=964x1188\" alt=\"å›¾ç‰‡\" title=\"å¼±ä¸‰è‰²ä¸å˜æ€§\"></p><p>æ— è®ºåº”ç”¨åœ¨ä¸ GC å¹¶å‘æ‰§è¡ŒæœŸé—´å¦‚ä½•ä¿®æ”¹å †ä¸Šå¯¹è±¡çš„å…³ç³»ï¼Œåªè¦ä¿®æ”¹ä¹‹åï¼Œå †ä¸Šå¯¹è±¡èƒ½<strong>æ»¡è¶³ä»»æ„ä¸€ç§ä¸å˜æ€§</strong>ï¼Œå°±ä¸ä¼šå‘ç”Ÿå¯¹è±¡çš„ä¸¢å¤±é—®é¢˜ã€‚</p><p>è€Œå®ç°å¼º/å¼±ä¸‰è‰²ä¸å˜æ€§å‡éœ€è¦å¼•å…¥å±éšœæŠ€æœ¯ã€‚åœ¨ Go è¯­è¨€ä¸­ï¼Œä½¿ç”¨å†™å±éšœï¼Œä¹Ÿå°±æ˜¯ write barrier æ¥è§£å†³ä¸Šè¿°é—®é¢˜ã€‚</p><h3>write barrier</h3><p>è¿™é‡Œbarrier çš„æœ¬è´¨æ˜¯ : snippet of code insert before pointer modifyã€‚ä¸è¿‡ï¼Œ<strong>åœ¨å¹¶å‘ç¼–ç¨‹é¢†åŸŸä¹Ÿæœ‰ memory barrierï¼Œä½†è¿™ä¸ªå«ä¹‰ä¸ GC é¢†åŸŸçš„barrieræ˜¯å®Œå…¨ä¸åŒçš„</strong>ï¼Œåœ¨é˜…è¯»ç›¸å…³ææ–™æ—¶ï¼Œä½ ä¸€å®šè¦æ³¨æ„ä¸è¦æ··æ·†è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚</p><p>Go è¯­è¨€çš„ GC åªæœ‰ write barrierï¼Œæ²¡æœ‰ read barrierã€‚</p><p>åœ¨åº”ç”¨è¿›å…¥ GC æ ‡è®°é˜¶æ®µå‰çš„ stw é˜¶æ®µï¼Œä¼šå°†å…¨å±€å˜é‡ runtime.writeBarrier.enabled ä¿®æ”¹ä¸º trueï¼Œè¿™æ—¶æ‰€æœ‰çš„å †ä¸ŠæŒ‡é’ˆä¿®æ”¹æ“ä½œåœ¨ä¿®æ”¹ä¹‹å‰ä¾¿ä¼šé¢å¤–è°ƒç”¨ runtime.gcWriteBarrierï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a5/17/a5f34e9yy590a5504504bbcede940817.png?wh=1602x560\" alt=\"å›¾ç‰‡\" title=\"åœ¨æŒ‡é’ˆä¿®æ”¹æ—¶è¢«æ’å…¥çš„ write barrier å‡½æ•°è°ƒç”¨\"></p><p>åœ¨åæ±‡ç¼–ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¡Œæ•°æ‰¾åˆ°åŸå§‹çš„ä»£ç ä½ç½®ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/f9/cd/f92b0yy86fd889ba8099955aef47a5cd.png?wh=1160x458\" alt=\"å›¾ç‰‡\" title=\"ç”¨è¡Œæ•°æ‰¾åˆ°çœŸæ­£çš„ä»£ç å®ç°\"></p><p>åœ¨GCé¢†åŸŸä¸­ï¼Œå¸¸è§çš„ write barrier æœ‰ä¸¤ç§ï¼š</p><ul>\n<li>\n<p>Dijistra Insertion Barrierï¼ŒæŒ‡é’ˆä¿®æ”¹æ—¶ï¼ŒæŒ‡å‘çš„æ–°å¯¹è±¡è¦æ ‡ç°ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/ed/36/ed18f2d72c1411761d85645d726c2c36.png?wh=982x352\" alt=\"å›¾ç‰‡\" title=\"Dijistra æ’å…¥å±éšœ\"></p>\n</li>\n<li>\n<p>Yuasa Deletion Barrierï¼ŒæŒ‡é’ˆä¿®æ”¹æ—¶ï¼Œä¿®æ”¹å‰æŒ‡å‘çš„å¯¹è±¡è¦æ ‡ç°ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/0a/ba/0a399de8c0764c53e9d765a3dd2b53ba.png?wh=942x346\" alt=\"å›¾ç‰‡\" title=\"Yuasa åˆ é™¤å±éšœ\"></p>\n</li>\n</ul><p>ä»ç†è®ºä¸Šæ¥è®²ï¼Œå¦‚æœ Go è¯­è¨€çš„æ‰€æœ‰å¯¹è±¡éƒ½åœ¨å †ä¸Šï¼Œä½¿ç”¨ä¸Šè¿°ä¸¤ç§å±éšœçš„ä»»æ„ä¸€ç§ï¼Œéƒ½ä¸ä¼šå‘ç”Ÿå¯¹è±¡ä¸¢å¤±çš„é—®é¢˜ã€‚</p><p>ä½†æˆ‘ä»¬ä¸è¦å¿½ç•¥ï¼Œåœ¨ Go è¯­è¨€ä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šå¯¹è±¡è¢«åˆ†é…åœ¨æ ˆä¸Šã€‚æ ˆä¸Šçš„å¯¹è±¡æ“ä½œæå…¶é¢‘ç¹ï¼Œç»™æ ˆä¸Šå¯¹è±¡å¢åŠ å†™å±éšœæˆæœ¬å¾ˆé«˜ï¼Œæ‰€ä»¥ Go æ˜¯ä¸ç»™æ ˆä¸Šå¯¹è±¡å¼€å¯å±éšœçš„ã€‚</p><p>åªå¯¹å †ä¸Šå¯¹è±¡å¼€å¯å†™å±éšœçš„è¯ï¼Œä½¿ç”¨ä¸Šè¿°ä¸¤ç§å±éšœå…¶ä¸­çš„ä»»æ„ä¸€ç§ï¼Œéƒ½éœ€è¦åœ¨ stw é˜¶æ®µå¯¹æ ˆè¿›è¡Œé‡æ‰«ã€‚æ‰€ä»¥ç»è¿‡å¤šä¸ªç‰ˆæœ¬çš„è¿­ä»£ï¼Œç°åœ¨ Go çš„å†™å±éšœæ··åˆäº†ä¸Šè¿°ä¸¤ç§å±éšœï¼Œå®ç°æ˜¯è¿™æ ·çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/c9/8a/c9e2810ee27e6b19e8a62372e2afe98a.png?wh=976x398\" alt=\"å›¾ç‰‡\" title=\"Go çš„çœŸå®å±éšœå®ç°\"></p><p>è¿™å’Œ Go è¯­è¨€åœ¨æ··åˆå±éšœçš„ proposal ä¸Šçš„å®ç°ä¸å¤ªç›¸ç¬¦ï¼Œæœ¬æ¥ proposal æ˜¯è¿™ä¹ˆå†™çš„ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/f7/4b/f702ab3e26452fb20643e3ac095b054b.png?wh=964x426\" alt=\"å›¾ç‰‡\" title=\"proposal ä¸Šå£°ç§°çš„æ··åˆå±éšœå®ç°\"></p><p>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å·®å¼‚å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸ºæ ˆçš„é¢œè‰²åˆ¤æ–­æˆæœ¬æ˜¯å¾ˆé«˜çš„ï¼Œå®˜æ–¹æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©äº†æ›´ä¸ºç®€å•çš„å®ç°ï¼Œå³æŒ‡é’ˆæ–­å¼€çš„è€å¯¹è±¡å’Œæ–°å¯¹è±¡éƒ½æ ‡ç°çš„å®ç°ã€‚</p><p>æˆ‘ä»¬å†æ¥è¯¦ç»†åœ°çœ‹çœ‹å‰é¢ä¸¤ç§å±éšœçš„å¯¹è±¡ä¸¢å¤±é—®é¢˜ã€‚</p><ul>\n<li>\n<p>Dijistra Insertion Barrier çš„å¯¹è±¡ä¸¢å¤±é—®é¢˜ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/5d/ae/5d1fbbf17b04dea2f69b2b3e78651eae.gif?wh=1228x678\" alt=\"å›¾ç‰‡\" title=\"æ ˆä¸Šçš„é»‘è‰²å¯¹è±¡ä¼šæŒ‡å‘å †ä¸Šçš„ç™½è‰²å¯¹è±¡\"></p>\n</li>\n<li>\n<p>Yuasa Deletion Barrier çš„å¯¹è±¡ä¸¢å¤±é—®é¢˜ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/bd/4f/bd9782b5dc063ec6abe99fa23888134f.gif?wh=1224x684\" alt=\"å›¾ç‰‡\" title=\"å †ä¸Šçš„é»‘è‰²å¯¹è±¡ä¼šæŒ‡å‘å †ä¸Šçš„ç™½è‰²å¯¹è±¡\"></p>\n</li>\n</ul><p>æ—©æœŸ Go åªä½¿ç”¨äº† Dijistra å±éšœï¼Œä½†å› ä¸ºä¼šæœ‰ä¸Šè¿°å¯¹è±¡ä¸¢å¤±é—®é¢˜ï¼Œéœ€è¦åœ¨ç¬¬äºŒä¸ª stw å‘¨æœŸè¿›è¡Œæ ˆé‡æ‰«ï¼ˆstack rescanï¼‰ã€‚å½“ goroutine æ•°é‡è¾ƒå¤šæ—¶ï¼Œstw æ—¶é—´ä¼šå˜å¾—å¾ˆé•¿ã€‚</p><p>ä½†å•ç‹¬ä½¿ç”¨ä»»æ„ä¸€ç§ barrier ï¼Œåˆæ²¡æ³•æ»¡è¶³ Go æ¶ˆé™¤æ ˆé‡æ‰«çš„è¦æ±‚ï¼Œæ‰€ä»¥æœ€æ–°ç‰ˆæœ¬ä¸­ Go çš„æ··åˆå±éšœå…¶å®æ˜¯ Dijistra Insertion Barrier &nbsp;+ Yuasa Deletion Barrierã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/db/47/db60442b35719f182f24b06b407a3e47.png?wh=1068x684\" alt=\"å›¾ç‰‡\" title=\"æ··åˆ barrier çš„å®ç°\"></p><p>æ··åˆ write barrier ä¼šå°†ä¸¤ä¸ªæŒ‡é’ˆæ¨åˆ° p çš„ wbBuf ç»“æ„å»ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/1b/4e/1b1baacb690f73730869c7203f102b4e.gif?wh=1220x680\" alt=\"å›¾ç‰‡\" title=\"æ··åˆ barrier ä¼šå°†æŒ‡é’ˆæ¨è¿› P çš„ wbBuf ç»“æ„ä¸­ï¼Œæ»¡äº†å°±å¾€ gcw æ¨\"></p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹çœ‹ mutator å’Œåå°çš„ mark worker åœ¨å¹¶å‘æ‰§è¡Œæ—¶çš„å®Œæ•´è¿‡ç¨‹äº†ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/40/b9/40521717150c4813e97a8586984b06b9.gif?wh=1220x680\" alt=\"å›¾ç‰‡\" title=\"mutator å’Œ mark worker åŒæ—¶åœ¨æ‰§è¡Œæ—¶\"></p><h3>å›æ”¶æµç¨‹</h3><p>ç›¸æ¯”å¤æ‚çš„æ ‡è®°æµç¨‹ï¼Œå¯¹è±¡çš„å›æ”¶å’Œå†…å­˜é‡Šæ”¾å°±ç®€å•å¤šäº†ã€‚</p><p>è¿›ç¨‹å¯åŠ¨æ—¶ä¼šæœ‰ä¸¤ä¸ªç‰¹æ®Š goroutineï¼š</p><ul>\n<li>ä¸€ä¸ªå« sweep.gï¼Œä¸»è¦è´Ÿè´£æ¸…æ‰«æ­»å¯¹è±¡ï¼Œåˆå¹¶ç›¸å…³çš„ç©ºé—²é¡µï¼›</li>\n<li>ä¸€ä¸ªå« scvg.gï¼Œä¸»è¦è´Ÿè´£å‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜ã€‚</li>\n</ul><pre><code class=\"language-plain\">(dlv) goroutines\n* Goroutine 1 - User: ./int.go:22 main.main (0x10572a6) (thread 5247606)\n  Goroutine 2 - User: /usr/local/go/src/runtime/proc.go:367 runtime.gopark (0x102e596) [force gc (idle) 455634h24m29.787802783s]\n  Goroutine 3 - User: /usr/local/go/src/runtime/proc.go:367 runtime.gopark (0x102e596) [GC sweep wait]\n  Goroutine 4 - User: /usr/local/go/src/runtime/proc.go:367 runtime.gopark (0x102e596) [GC scavenge wait]\n</code></pre><p>æ³¨æ„çœ‹è¿™é‡Œçš„ GC sweep wait å’Œ GC scavenge waitï¼Œ å°±æ˜¯è¿™ä¸¤ä¸ª goroutineã€‚</p><p>å½“ GC çš„æ ‡è®°æµç¨‹ç»“æŸä¹‹åï¼Œsweep goroutine å°±ä¼šè¢«å”¤é†’ï¼Œè¿›è¡Œæ¸…æ‰«å·¥ä½œï¼Œå…¶å®å°±æ˜¯å¾ªç¯æ‰§è¡Œ sweepone -&gt; sweepã€‚é’ˆå¯¹æ¯ä¸ª mspanï¼Œsweep.g çš„å·¥ä½œæ˜¯å°†æ ‡è®°æœŸé—´ç”Ÿæˆçš„ bitmap æ›¿æ¢æ‰åˆ†é…æ—¶ä½¿ç”¨çš„ bitmapï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/b9/29/b9ec19a138f667df5730d7895d9e3d29.png?wh=1042x666\" alt=\"å›¾ç‰‡\" title=\"mspanï¼šç”¨æ ‡è®°æœŸé—´ç”Ÿæˆçš„ bitmap æ›¿æ¢æ‰åˆ†é…å†…å­˜æ—¶ä½¿ç”¨çš„ bitmap\"></p><p>ç„¶åæ ¹æ® mspan ä¸­çš„æ§½ä½æƒ…å†µå†³å®šè¯¥ mspan çš„å»å‘ï¼š</p><ul>\n<li>å¦‚æœ mspan ä¸­å­˜æ´»å¯¹è±¡æ•° = 0ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰ element éƒ½å˜æˆäº†å†…å­˜åƒåœ¾ï¼Œé‚£æ‰§è¡Œ freeSpan -&gt; å½’è¿˜ç»„æˆè¯¥ mspan æ‰€ä½¿ç”¨çš„é¡µï¼Œå¹¶æ›´æ–°å…¨å±€çš„é¡µåˆ†é…å™¨æ‘˜è¦ä¿¡æ¯ï¼›</li>\n<li>å¦‚æœ mspan ä¸­æ²¡æœ‰ç©ºæ§½ï¼Œè¯´æ˜æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯å­˜æ´»çš„ï¼Œå°†å…¶æ”¾å…¥ fullSwept é˜Ÿåˆ—ä¸­ï¼›</li>\n<li>å¦‚æœ mspan ä¸­æœ‰ç©ºæ§½ï¼Œè¯´æ˜è¿™ä¸ª mspan è¿˜å¯ä»¥æ‹¿æ¥åšå†…å­˜åˆ†é…ï¼Œå°†å…¶æ”¾å…¥ partialSweep é˜Ÿåˆ—ä¸­ã€‚</li>\n</ul><p>ä¹‹åâ€œæ¸…é“å¤«â€ scvg goroutine è¢«å”¤é†’ï¼Œæ‰§è¡Œçº¿æ€§æµç¨‹ï¼Œä¸€è·¯è¿è¡Œåˆ°å°†é¡µå†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ bgscavenge -&gt; pageAlloc.scavenge -&gt; pageAlloc.scavengeOne -&gt; pageAlloc.scavengeRangeLocked -&gt; sysUnused -&gt; madviseï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/f4/a9575cf87774fed288cf20f976a42af4.png?wh=1636x652\" alt=\"å›¾ç‰‡\" title=\"æœ€ç»ˆè¿˜æ˜¯è¦ç”¨ madvise æ¥å°†å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ\"></p><h2>é—®é¢˜åˆ†æ</h2><p>ä»å‰é¢çš„åŸºç¡€çŸ¥è¯†ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º Go è¯­è¨€åƒåœ¾å›æ”¶çš„å…³é”®ç‚¹ï¼š</p><ul>\n<li>æ— åˆ†ä»£ï¼›</li>\n<li>ä¸åº”ç”¨æ‰§è¡Œå¹¶å‘ï¼›</li>\n<li>ååŠ©æ ‡è®°æµç¨‹ï¼›</li>\n<li>å¹¶å‘æ‰§è¡Œæ—¶å¼€å¯ write barrierã€‚</li>\n</ul><p>æˆ‘ä»¬æ—¥å¸¸ç¼–ç ä¸­å°±éœ€è¦è€ƒè™‘è¿™äº›å…³é”®ç‚¹ï¼Œè¿›è¡Œä¸€äº›é’ˆå¯¹æ€§çš„è®¾è®¡ä¸ä¼˜åŒ–ã€‚æ¯”å¦‚ï¼Œå› ä¸ºæ— åˆ†ä»£ï¼Œå½“æˆ‘ä»¬é‡åˆ°ä¸€äº›éœ€è¦åœ¨å†…å­˜ä¸­ä¿ç•™å‡ åƒä¸‡ kv map çš„åœºæ™¯ï¼ˆæ¯”å¦‚æœºå™¨å­¦ä¹ çš„ç‰¹å¾ç³»ç»Ÿï¼‰æ—¶ï¼Œå°±éœ€è¦æƒ³åŠæ³•é™ä½ GC æ‰«ææˆæœ¬ã€‚</p><p>åˆæ¯”å¦‚ï¼Œå› ä¸ºæœ‰ååŠ©æ ‡è®°ï¼Œå½“åº”ç”¨çš„ GC å ç”¨çš„ CPU è¶…è¿‡ 25% æ—¶ï¼Œä¼šè§¦å‘å¤§é‡çš„ååŠ©æ ‡è®°ï¼Œå½±å“åº”ç”¨çš„å»¶è¿Ÿï¼Œè¿™æ—¶ä¹Ÿè¦å¯¹ GC è¿›è¡Œä¼˜åŒ–ã€‚</p><p>ç®€å•çš„ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ sync.Pool å°±å¯ä»¥å¸¦æ¥è¾ƒå¥½çš„ä¼˜åŒ–æ•ˆæœï¼Œè‹¥ç¢°åˆ°ä¸€äº›å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œè¿˜è¦è€ƒè™‘ offheap ä¹‹ç±»çš„æ¬ºéª— GC çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚ <a href=\"https://dgraph.io/blog/post/manual-memory-management-golang-jemalloc/\">dgraph çš„æ–¹æ¡ˆ</a>ã€‚å› ä¸ºæˆ‘ä»¬è¿™è®²èšç„¦äºå†…å­˜åˆ†é…å’Œ GC çš„å®ç°ï¼Œå°±ä¸å±•å¼€ä»‹ç»è¿™äº›å…·ä½“æ–¹æ¡ˆäº†ã€‚</p><p>å¦å¤–ï¼Œè¿™è®²ä¸­æ¶‰åŠçš„æ‰€æœ‰å†…å­˜ç®¡ç†çš„åè¯ï¼Œä½ éƒ½å¯ä»¥åœ¨ï¼š<a href=\"https://memorymanagement.org\">https://memorymanagement.org</a> ä¸Šæ‰¾åˆ°ã€‚å¦‚æœä½ è¿˜å¯¹åƒåœ¾å›æ”¶çš„ç†è®ºè¿˜æœ‰ä»€ä¹ˆä¸è§£ï¼Œæˆ‘æ¨èä½ é˜…è¯»ï¼šã€Š<a href=\"https://gchandbook.org\">GC Handbook</a>ã€‹ï¼Œå®ƒå¯ä»¥è§£ç­”ä½ æ‰€æœ‰çš„ç–‘é—®ã€‚</p>","comments":[{"had_liked":false,"id":334014,"user_name":"Tony Bai","can_delete":false,"product_type":"c1","uid":1026224,"ip_address":"","ucode":"B6B08985F6FA89","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","comment_is_top":false,"comment_ctime":1644672385,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æ›¹è€å¸ˆæŠŠGCåŸç†è®²å¾—å¥½é€šé€ï¼ğŸ‘ ","like_count":9},{"had_liked":false,"id":334604,"user_name":"å¶å‰‘å³°","can_delete":false,"product_type":"c1","uid":1069186,"ip_address":"","ucode":"3974D917C69C29","user_header":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","comment_is_top":false,"comment_ctime":1645016134,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è†œæ‹œæ›¹å¤§","like_count":2},{"had_liked":false,"id":333250,"user_name":"éª¨æ±¤é¸¡è›‹é¢","can_delete":false,"product_type":"c1","uid":1050002,"ip_address":"","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1644230549,"is_pvip":false,"replies":null,"discussion_count":4,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"å¤§ä½¬ï¼Œgo åœ¨å˜é‡èµ‹å€¼æ—¶è°ƒç”¨ write barrierï¼Œå¯ä»¥å¤šè¡¥å……äº›ç»†èŠ‚å˜›ï¼Ÿ","like_count":1},{"had_liked":false,"id":394826,"user_name":"lufofire","can_delete":false,"product_type":"c1","uid":3218954,"ip_address":"å¹¿ä¸œ","ucode":"CA12C6E772C7BD","user_header":"https://static001.geekbang.org/account/avatar/00/31/1e/0a/159b2129.jpg","comment_is_top":false,"comment_ctime":1728517775,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"ç‰›é€¼","like_count":0},{"had_liked":false,"id":369493,"user_name":"Niku","can_delete":false,"product_type":"c1","uid":1664816,"ip_address":"ä¸­å›½é¦™æ¸¯","ucode":"B143D25C908D7B","user_header":"https://static001.geekbang.org/account/avatar/00/19/67/30/57856788.jpg","comment_is_top":false,"comment_ctime":1677591496,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æ›¹ç¥TQL","like_count":0},{"had_liked":false,"id":368220,"user_name":"æ€ä¹ˆç¡æ‰èƒ½åšè¿™ç§æ¢¦","can_delete":false,"product_type":"c1","uid":3050745,"ip_address":"æ¹–åŒ—","ucode":"81A7B6EF124E90","user_header":"https://static001.geekbang.org/account/avatar/00/2e/8c/f9/e1dab0ca.jpg","comment_is_top":false,"comment_ctime":1676016596,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"çœ‹ä¸æ‡‚å™¢","like_count":0},{"had_liked":false,"id":338746,"user_name":"simple_å­™","can_delete":false,"product_type":"c1","uid":1873629,"ip_address":"","ucode":"A77203E242D652","user_header":"https://static001.geekbang.org/account/avatar/00/1c/96/dd/1620a744.jpg","comment_is_top":false,"comment_ctime":1647699417,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"PauseNsæ•°ç»„ä¸­çš„æ•°å­—æ˜¯å•¥æ„æ€å‘¢","like_count":0,"discussions":[{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559257,"discussion_content":"stw æ—¶é—´ï¼Œä»¥ ns ä¸ºå•ä½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648658679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335982,"user_name":"é£","can_delete":false,"product_type":"c1","uid":2430526,"ip_address":"","ucode":"25AE76871EF894","user_header":"https://static001.geekbang.org/account/avatar/00/25/16/3e/5965e58b.jpg","comment_is_top":false,"comment_ctime":1645805125,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æ›¹å¤§yyds","like_count":0},{"had_liked":false,"id":334014,"user_name":"Tony Bai","can_delete":false,"product_type":"c1","uid":1026224,"ip_address":"","ucode":"B6B08985F6FA89","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg","comment_is_top":false,"comment_ctime":1644672385,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æ›¹è€å¸ˆæŠŠGCåŸç†è®²å¾—å¥½é€šé€ï¼ğŸ‘ ","like_count":9},{"had_liked":false,"id":334604,"user_name":"å¶å‰‘å³°","can_delete":false,"product_type":"c1","uid":1069186,"ip_address":"","ucode":"3974D917C69C29","user_header":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","comment_is_top":false,"comment_ctime":1645016134,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"è†œæ‹œæ›¹å¤§","like_count":2},{"had_liked":false,"id":333250,"user_name":"éª¨æ±¤é¸¡è›‹é¢","can_delete":false,"product_type":"c1","uid":1050002,"ip_address":"","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1644230549,"is_pvip":false,"replies":null,"discussion_count":4,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"å¤§ä½¬ï¼Œgo åœ¨å˜é‡èµ‹å€¼æ—¶è°ƒç”¨ write barrierï¼Œå¯ä»¥å¤šè¡¥å……äº›ç»†èŠ‚å˜›ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550710,"discussion_content":"è¿™ä¸ªå…¶å®å°±æ˜¯å †ä¸ŠæŒ‡é’ˆçš„ä¿®æ”¹è¿‡ç¨‹ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨ç¿»è¯‘æˆäº†wbå¼€å¯å’Œwbæœªå¼€å¯çš„if elseé€»è¾‘ï¼Œåœ¨æ±‡ç¼–ä»£ç é‡Œèƒ½çœ‹å‡ºæ¥ï¼Œæ–‡å†…æœ‰æˆªå›¾","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644678376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1050002,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","nickname":"éª¨æ±¤é¸¡è›‹é¢","note":"","ucode":"2AC141A523E710","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551281,"discussion_content":"gp.waiting =nil æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œä¼šè¢«ç¼–è¯‘ä¸ºå¸¦æœ‰wbçš„ä»£ç ã€‚é‚£æ‰€æœ‰å †ä¸Šçš„æŒ‡é’ˆèµ‹å€¼ï¼ˆor ä¿®æ”¹ï¼‰éƒ½ä¼šè¢«è¿™æ ·ç¼–è¯‘å˜›ï¼Œ æ˜¯ä¸æ˜¯æ•ˆç‡å°±ä½äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644975930,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550710,"ip_address":"","group_id":0},"score":551281,"extra":""},{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1050002,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","nickname":"éª¨æ±¤é¸¡è›‹é¢","note":"","ucode":"2AC141A523E710","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551330,"discussion_content":"å †ä¸Šæ‰€æœ‰æŒ‡é’ˆä¿®æ”¹ç¡®å®éƒ½ä¼šç¼–è¯‘å‡ºè¿™æ ·çš„ç»“æœï¼Œgcæœªæ‰§è¡ŒæœŸé—´ï¼Œæ•ˆç‡è‚¯å®šæ¯”æ²¡gcçš„è¯­è¨€ä½ä¸€ç‚¹ï¼Œæ˜¯å¤šäº†ä¸€ä¸ªåˆ¤æ–­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644988500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":551281,"ip_address":"","group_id":0},"score":551330,"extra":""},{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1050002,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","nickname":"éª¨æ±¤é¸¡è›‹é¢","note":"","ucode":"2AC141A523E710","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551331,"discussion_content":"gc åœ¨æ ‡è®°é˜¶æ®µï¼Œå †æŒ‡é’ˆçš„ä¿®æ”¹å°±é«˜å¾ˆå¤šäº†ï¼Œç›¸å½“äºè¦è°ƒç”¨å‡½æ•°ï¼Œåšä¸€å †åŒæ­¥æ“ä½œï¼Œç„¶åå†å»ä¿®æ”¹æŒ‡é’ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644988561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":551281,"ip_address":"","group_id":0},"score":551331,"extra":""}]}]},{"had_liked":false,"id":394826,"user_name":"lufofire","can_delete":false,"product_type":"c1","uid":3218954,"ip_address":"å¹¿ä¸œ","ucode":"CA12C6E772C7BD","user_header":"https://static001.geekbang.org/account/avatar/00/31/1e/0a/159b2129.jpg","comment_is_top":false,"comment_ctime":1728517775,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"ç‰›é€¼","like_count":0},{"had_liked":false,"id":369493,"user_name":"Niku","can_delete":false,"product_type":"c1","uid":1664816,"ip_address":"ä¸­å›½é¦™æ¸¯","ucode":"B143D25C908D7B","user_header":"https://static001.geekbang.org/account/avatar/00/19/67/30/57856788.jpg","comment_is_top":false,"comment_ctime":1677591496,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æ›¹ç¥TQL","like_count":0},{"had_liked":false,"id":368220,"user_name":"æ€ä¹ˆç¡æ‰èƒ½åšè¿™ç§æ¢¦","can_delete":false,"product_type":"c1","uid":3050745,"ip_address":"æ¹–åŒ—","ucode":"81A7B6EF124E90","user_header":"https://static001.geekbang.org/account/avatar/00/2e/8c/f9/e1dab0ca.jpg","comment_is_top":false,"comment_ctime":1676016596,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"çœ‹ä¸æ‡‚å™¢","like_count":0},{"had_liked":false,"id":338746,"user_name":"simple_å­™","can_delete":false,"product_type":"c1","uid":1873629,"ip_address":"","ucode":"A77203E242D652","user_header":"https://static001.geekbang.org/account/avatar/00/1c/96/dd/1620a744.jpg","comment_is_top":false,"comment_ctime":1647699417,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"PauseNsæ•°ç»„ä¸­çš„æ•°å­—æ˜¯å•¥æ„æ€å‘¢","like_count":0,"discussions":[{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550710,"discussion_content":"è¿™ä¸ªå…¶å®å°±æ˜¯å †ä¸ŠæŒ‡é’ˆçš„ä¿®æ”¹è¿‡ç¨‹ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨ç¿»è¯‘æˆäº†wbå¼€å¯å’Œwbæœªå¼€å¯çš„if elseé€»è¾‘ï¼Œåœ¨æ±‡ç¼–ä»£ç é‡Œèƒ½çœ‹å‡ºæ¥ï¼Œæ–‡å†…æœ‰æˆªå›¾","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644678376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1050002,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","nickname":"éª¨æ±¤é¸¡è›‹é¢","note":"","ucode":"2AC141A523E710","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551281,"discussion_content":"gp.waiting =nil æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œä¼šè¢«ç¼–è¯‘ä¸ºå¸¦æœ‰wbçš„ä»£ç ã€‚é‚£æ‰€æœ‰å †ä¸Šçš„æŒ‡é’ˆèµ‹å€¼ï¼ˆor ä¿®æ”¹ï¼‰éƒ½ä¼šè¢«è¿™æ ·ç¼–è¯‘å˜›ï¼Œ æ˜¯ä¸æ˜¯æ•ˆç‡å°±ä½äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644975930,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550710,"ip_address":"","group_id":0},"score":551281,"extra":""},{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1050002,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","nickname":"éª¨æ±¤é¸¡è›‹é¢","note":"","ucode":"2AC141A523E710","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551330,"discussion_content":"å †ä¸Šæ‰€æœ‰æŒ‡é’ˆä¿®æ”¹ç¡®å®éƒ½ä¼šç¼–è¯‘å‡ºè¿™æ ·çš„ç»“æœï¼Œgcæœªæ‰§è¡ŒæœŸé—´ï¼Œæ•ˆç‡è‚¯å®šæ¯”æ²¡gcçš„è¯­è¨€ä½ä¸€ç‚¹ï¼Œæ˜¯å¤šäº†ä¸€ä¸ªåˆ¤æ–­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644988500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":551281,"ip_address":"","group_id":0},"score":551330,"extra":""},{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1050002,"avatar":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","nickname":"éª¨æ±¤é¸¡è›‹é¢","note":"","ucode":"2AC141A523E710","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551331,"discussion_content":"gc åœ¨æ ‡è®°é˜¶æ®µï¼Œå †æŒ‡é’ˆçš„ä¿®æ”¹å°±é«˜å¾ˆå¤šäº†ï¼Œç›¸å½“äºè¦è°ƒç”¨å‡½æ•°ï¼Œåšä¸€å †åŒæ­¥æ“ä½œï¼Œç„¶åå†å»ä¿®æ”¹æŒ‡é’ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644988561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":551281,"ip_address":"","group_id":0},"score":551331,"extra":""}]}]},{"had_liked":false,"id":335982,"user_name":"é£","can_delete":false,"product_type":"c1","uid":2430526,"ip_address":"","ucode":"25AE76871EF894","user_header":"https://static001.geekbang.org/account/avatar/00/25/16/3e/5965e58b.jpg","comment_is_top":false,"comment_ctime":1645805125,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100093501,"comment_content":"æ›¹å¤§yyds","like_count":0,"discussions":[{"author":{"id":1204762,"avatar":"https://static001.geekbang.org/account/avatar/00/12/62/1a/eef8b99d.jpg","nickname":"Xargin","note":"","ucode":"594EC9C380657C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559257,"discussion_content":"stw æ—¶é—´ï¼Œä»¥ ns ä¸ºå•ä½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648658679,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}