{"id":215668,"title":"16 | 业务分组：如何隔离流量？","content":"<p>你好，我是何小锋。上一讲我们介绍了RPC中常用的保护手段“熔断限流”，熔断是调用方为了避免在调用过程中，服务提供方出现问题的时候，自身资源被耗尽的一种保护行为；而限流则是服务提供方为防止自己被突发流量打垮的一种保护行为。虽然这两种手段作用的对象不同，但出发点都是为了实现自我保护，所以一旦发生这种行为，业务都是有损的。</p><p>那说起突发流量，限流固然是一种手段，但其实面对复杂的业务以及高并发场景时，我们还有别的手段，可以最大限度地保障业务无损，那就是隔离流量。这也是我今天重点要和你分享的内容，接下来我们就一起看看分组在RPC中的应用。</p><h2>为什么需要分组？</h2><p>在我们的日常开发中，我们不都提倡让用户使用起来越简单越好吗？如果在接口上再加一个分组维度去管理，不就让事情变复杂了吗？</p><p>实则不然，举个例子。在没有汽车的年代，我们的道路很简单，就一条，行人、洋车都在上边走。那随着汽车的普及以及猛增，我们的道路越来越宽，慢慢地有了高速、辅路、人行道等等。很显然，交通网的建设与完善不仅提高了我们的出行效率，而且还更好地保障了我们行人的安全。</p><p>同样的道理，我们用在RPC治理上也是一样的。假设你是一个服务提供方应用的负责人，在早期业务量不大的情况下，应用之间的调用关系并不会复杂，请求量也不会很大，我们的应用有足够的能力扛住日常的所有流量。我们并不需要花太多的时间去治理调用请求过来的流量，我们通常会选择最简单的方法，就是把服务实例统一管理，把所有的请求都用一个共享的“大池子”来处理。这就类似于“简单道路时期”，服务调用方跟服务提供方之间的调用拓扑如下图所示：</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/e8/85/e814da49a9c35b5e71df58b870234285.jpg?wh=2464*2004\" alt=\"\" title=\"无隔离调用拓扑\"></p><p>后期因为业务发展丰富了，调用你接口的调用方就会越来越多，流量也会渐渐多起来。可能某一天，一个“爆炸式惊喜”就来了。其中一个调用方的流量突然激增，让你整个集群瞬间处于高负载运行，进而影响到其它调用方，导致它们的整体可用率下降。而这时候作为应用负责人的你，那就得变身“救火队长”了，要想尽各种办法来保证应用的稳定。</p><p>在经过一系列的救火操作后，我们肯定要去想更好的应对办法。那回到问题的根本去看，关键就在于，早期为了管理方便，我们把接口都放到了同一个分组下面，所有的服务实例是以一个整体对外提供能力的。</p><p>但后期因为业务发展，这种粗暴的管理模式已经不适用了，这就好比“汽车来了，我们的交通网也得抓紧建设”一样，让人车分流。此时，道路上的人和车就好比我们应用的调用方，我们可以尝试把应用提供方这个大池子划分出不同规格的小池子，再分配给不同的调用方，而不同小池子之间的隔离带，就是我们在RPC里面所说的分组，它可以实现流量隔离。</p><h2>怎么实现分组？</h2><p>现在分组是怎么回事我们搞清楚了，那放到RPC里我们该怎么实现呢？</p><p>既然是要求不同的调用方应用能拿到的池子内容不同，那我们就要回想下服务发现了，因为在RPC流程里，能影响到调用方获取服务节点的逻辑就是它了。</p><p>在<a href=\"https://time.geekbang.org/column/article/208171\">[第 08 讲]</a> 我们说过，服务调用方是通过接口名去注册中心找到所有的服务节点来完成服务发现的，那换到这里的话，这样做其实并不合适，因为这样调用方会拿到所有的服务节点。因此为了实现分组隔离逻辑，我们需要重新改造下服务发现的逻辑，调用方去获取服务节点的时候除了要带着接口名，还需要另外加一个分组参数，相应的服务提供方在注册的时候也要带上分组参数。</p><p>通过改造后的分组逻辑，我们可以把服务提供方所有的实例分成若干组，每一个分组可以提供给单个或者多个不同的调用方来调用。那怎么分组好呢，有没有统一的标准？</p><p>坦白讲，这个分组并没有一个可衡量的标准，但我自己总结了一个规则可以供你参考，就是按照应用重要级别划分。</p><p>非核心应用不要跟核心应用分在同一个组，核心应用之间应该做好隔离，一个重要的原则就是保障核心应用不受影响。比如提供给电商下单过程中用的商品信息接口，我们肯定是需要独立出一个单独分组，避免受其它调用方污染的。有了分组之后，我们的服务调用方跟服务提供方之间的调用拓扑就如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/12/69/128923fefc27a36d056393f9e9f25f69.jpg?wh=2352*1994\" alt=\"\" title=\"分组调用拓扑\"></p><p>通过分组的方式隔离调用方的流量，从而避免因为一个调用方出现流量激增而影响其它调用方的可用率。对服务提供方来说，这种方式是我们日常治理服务过程中一个高频使用的手段，那通过这种分组进行流量隔离，对调用方应用会不会有影响呢？</p><h2>如何实现高可用？</h2><p>分组隔离后，单个调用方在发RPC请求的时候可选择的服务节点数相比没有分组前减少了，那对于单个调用方来说，出错的概率就升高了。比如一个集中交换机设备突然坏了，而这个调用方的所有服务节点都在这个交换机下面，在这种情况下对于服务调用方来说，它的请求无论如何也到达不了服务提供方，从而导致这个调用方业务受损。</p><p>那有没有更高可用一点的方案呢？回到我们前面说的那个马路例子上，正常情况下我们是必须让车在车道行驶，人在人行道上行走。但当人行道或者车道出现抢修的时候，在条件允许的情况下，我们一般都是允许对方借道行驶一段时间，直到道路完全恢复。</p><p><strong>我们同样可以把这个特性用到我们的RPC中，要怎么实现呢？</strong></p><p>在前面我们也说了，调用方应用服务发现的时候，除了带上对应的接口名，还需要带上一个特定分组名，所以对于调用方来说，它是拿不到其它分组的服务节点的，那这样的话调用方就没法建立起连接发请求了。</p><p>因此问题的核心就变成了调用方要拿到其它分组的服务节点，但是又不能拿到所有的服务节点，否则分组就没有意义了。一个最简单的办法就是，允许调用方可以配置多个分组。但这样的话，这些节点对于调用方来说就都是一样的了，调用方可以随意选择获取到的所有节点发送请求，这样就又失去了分组隔离的意义，并且还没有实现我们想要的“借道”的效果。</p><p>所以我们还需要把配置的分组区分下主次分组，只有在主分组上的节点都不可用的情况下才去选择次分组节点；只要主分组里面的节点恢复正常，我们就必须把流量都切换到主节点上，整个切换过程对于应用层完全透明，从而在一定程度上保障调用方应用的高可用。</p><h2>总结</h2><p>今天我们通过一个道路划分的案例，引出了在RPC里面我们可以通过分组的方式人为地给不同的调用方划分出不同的小集群，从而实现调用方流量隔离的效果，保障我们的核心业务不受非核心业务的干扰。但我们在考虑问题的时候，不能顾此失彼，不能因为新加一个的功能而影响到原有系统的稳定性。</p><p>其实我们不仅可以通过分组把服务提供方划分成不同规模的小集群，我们还可以利用分组完成一个接口多种实现的功能。正常情况下，为了方便我们自己管理服务，我一般都会建议每个接口完成的功能尽量保证唯一。但在有些特殊场景下，两个接口也会完全一样，只是具体实现上有那么一点不同，那么我们就可以在服务提供方应用里面同时暴露两个相同接口，但只是接口分组不一样罢了。</p><h2>课后思考</h2><p>在我们的实际工作中，测试人员和开发人员的工作一般都是并行的，这就导致一个问题经常出现：开发人员在开发过程中可能需要启动自身的应用，而测试人员为了能验证功能，会在测试环境中部署同样的应用。如果开发人员和测试人员用的接口分组名刚好一样，在这种情况下，就可能会干扰其它正在联调的调用方进行功能验证，进而影响整体的工作效率。不知道面对这种情况，你有什么好办法吗？</p><p>欢迎留言和我分享你的思考，也欢迎你把文章分享给你的朋友，邀请他加入学习。我们下节课再见！</p>","comments":[{"had_liked":false,"id":194555,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1585066885,"is_pvip":true,"replies":[{"id":"74974","content":"是的，环境硬隔离最省心","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585572052,"ip_address":"","comment_id":194555,"utype":1}],"discussion_count":1,"race_medal":0,"score":"87484412805","product_id":100046201,"comment_content":"我们目前使用的不同的注册中心，就是注册中心是部署了3份，prod、qa、test等，其实test和dev用的是同一个注册中心，因为我们的注册中心内部也有环境的区分，服务在往注册中心注册时，需要说明自己的环境。<br>所以我们目前服务间的调用是：<br>prod走生产网关prod.gateway.com（网关同步注册中心信息） 环境参数默认prod<br>qa走生产网关qa.gateway.com（网关同步注册中心信息） 环境参数默认qa<br>test和dev走 test.gateway.com（网关同步注册中心信息）,test需要环境的参数，test就是tets，dev就是dev<br>","like_count":21,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488842,"discussion_content":"是的，环境硬隔离最省心","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585572052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194629,"user_name":"刘楠","can_delete":false,"product_type":"c1","uid":1120773,"ip_address":"","ucode":"9F19D44CBEE039","user_header":"https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg","comment_is_top":false,"comment_ctime":1585092891,"is_pvip":false,"replies":[{"id":"74073","content":"是个好办法。","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585097840,"ip_address":"","comment_id":194629,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18764962075","product_id":100046201,"comment_content":"环境不同，注册中心不同","like_count":4,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488862,"discussion_content":"是个好办法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585097840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245816,"user_name":"cwfighter","can_delete":false,"product_type":"c1","uid":1099467,"ip_address":"","ucode":"1328C8A43EAD1B","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/cb/c7541d52.jpg","comment_is_top":false,"comment_ctime":1599060759,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10188995351","product_id":100046201,"comment_content":"K8S的namespace是个环境隔离好解决方案，放在rpc觉得有点重；实际的流量隔离可能更多是做业务做SET，同时也是容灾考虑，因为只是服务提供方做了流量隔离，但服务提供方依赖的服务没有做流量隔离其实意义不大，同样会因为流量突增引发异常。这样如果都做了流量隔离，其实也就是SET化架构了。所以不太明白rpc的分组功能究竟使用场景是什么，调用链一长，分组就很难维护了，还是说分组就是为了SET化功能考虑的？","like_count":2,"discussions":[{"author":{"id":1571460,"avatar":"https://static001.geekbang.org/account/avatar/00/17/fa/84/f01d203a.jpg","nickname":"Simple life","note":"","ucode":"1902D7F72FB43F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":310548,"discussion_content":"分组用的场景太少了，实际分组在容器中更合适","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1601901672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":218460,"user_name":"李志博","can_delete":false,"product_type":"c1","uid":1009109,"ip_address":"","ucode":"F3C72573B3C112","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/d5/88beb15a.jpg","comment_is_top":false,"comment_ctime":1589804999,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10179739591","product_id":100046201,"comment_content":"其实我想问1个问题，服务分组的方式，代码仓库还是1个，我们想用服务分组做核心和非核心链路的隔离，但是谁能保证，非核心结构的改动，不会间接影响核心的分组呢，毕竟代码还是同一套，这样的话，隔离还是不彻底的，不知道老师有没有好的解决方案","like_count":2,"discussions":[{"author":{"id":1228500,"avatar":"https://static001.geekbang.org/account/avatar/00/12/be/d4/ff1c1319.jpg","nickname":"金龟","note":"","ucode":"1C7D35C8AE8D9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366270,"discussion_content":"这个做不到代码级别的隔离吧。只能做到一个链路因为流量原因挂了，不会影响另外一个。代码纬度应该是自动化测试用例+灰度保证。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618018708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":196754,"user_name":"百威","can_delete":false,"product_type":"c1","uid":1074843,"ip_address":"","ucode":"758199FDD0B44F","user_header":"https://static001.geekbang.org/account/avatar/00/10/66/9b/59776420.jpg","comment_is_top":false,"comment_ctime":1585309987,"is_pvip":false,"replies":[{"id":"74944","content":"直连的话，服务发现就失去意义了","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585570499,"ip_address":"","comment_id":196754,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10175244579","product_id":100046201,"comment_content":"直连","like_count":2,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489375,"discussion_content":"直连的话，服务发现就失去意义了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585570499,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1437948,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f0/fc/2c96eec4.jpg","nickname":"王月半","note":"","ucode":"9FE94A2D706670","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289749,"discussion_content":"开发用直连\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594201291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1261360,"avatar":"https://static001.geekbang.org/account/avatar/00/13/3f/30/23f6b413.jpg","nickname":"五十九秒","note":"","ucode":"1F34F62193CFF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1437948,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f0/fc/2c96eec4.jpg","nickname":"王月半","note":"","ucode":"9FE94A2D706670","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350265,"discussion_content":"我也这么干过，测试环境试过修改接口别名的方式，自测还是直连更靠谱，不会调用到其他同事那里","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613790294,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":289749,"ip_address":""},"score":350265,"extra":""}]}]},{"had_liked":false,"id":195158,"user_name":"盘胧","can_delete":false,"product_type":"c1","uid":1650748,"ip_address":"","ucode":"5386CC4C92ECC2","user_header":"https://static001.geekbang.org/account/avatar/00/19/30/3c/0668d6ae.jpg","comment_is_top":false,"comment_ctime":1585142064,"is_pvip":false,"replies":[{"id":"74972","content":"关键在于配置是否存在开发测试冲突","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571937,"ip_address":"","comment_id":195158,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10175076656","product_id":100046201,"comment_content":"不是很明白了。开发这边开发环境容器化，我们云主机克隆过来或者直接拉镜像都行，最后修改好配置。就相当于和开发隔离开来了。开发这边每天的更新打包好，我们也拿过来打包升级就行了。","like_count":2,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488990,"discussion_content":"关键在于配置是否存在开发测试冲突","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291041,"user_name":"Geek_9815f1","can_delete":false,"product_type":"c1","uid":2068424,"ip_address":"","ucode":"34EE8566A53F10","user_header":"","comment_is_top":false,"comment_ctime":1619961137,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5914928433","product_id":100046201,"comment_content":"采用染色流量的方式区分就好了。","like_count":1},{"had_liked":false,"id":195540,"user_name":"陈国林","can_delete":false,"product_type":"c1","uid":1438037,"ip_address":"","ucode":"83D12F3E79F197","user_header":"https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg","comment_is_top":false,"comment_ctime":1585194878,"is_pvip":false,"replies":[{"id":"74964","content":"如果能隔离环境肯定更好，很多企业是不隔离测试和开发环境的","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571549,"ip_address":"","comment_id":195540,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5880162174","product_id":100046201,"comment_content":"开发推荐使用开发机测试，测试则使用Pre环境，互不干扰","like_count":1,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489102,"discussion_content":"如果能隔离环境肯定更好，很多企业是不隔离测试和开发环境的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571549,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194951,"user_name":"hello","can_delete":false,"product_type":"c1","uid":1464199,"ip_address":"","ucode":"854500026E2187","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132","comment_is_top":false,"comment_ctime":1585123526,"is_pvip":false,"replies":[{"id":"74966","content":"加油","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571615,"ip_address":"","comment_id":194951,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5880090822","product_id":100046201,"comment_content":"故障隔离还能这么玩，今天又见识到了一种新思路（”借道“），感谢老师！","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488936,"discussion_content":"加油","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571615,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359510,"user_name":"hillwater","can_delete":false,"product_type":"c1","uid":2826205,"ip_address":"上海","ucode":"FB16D5FCE8C7E6","user_header":"","comment_is_top":false,"comment_ctime":1665587620,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665587620","product_id":100046201,"comment_content":"给服务提供方分组，分组怎么实现呢，特别是有扩缩容的情况，怎么管理维护分组呢","like_count":0},{"had_liked":false,"id":296507,"user_name":"gsz","can_delete":false,"product_type":"c1","uid":1147531,"ip_address":"","ucode":"8FD1B41E884B18","user_header":"https://static001.geekbang.org/account/avatar/00/11/82/8b/5340fb27.jpg","comment_is_top":false,"comment_ctime":1623025125,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1623025125","product_id":100046201,"comment_content":"分组是指将服务提供方进行分组，不同的服务调用放访问不同组的服务提供方吗？","like_count":0},{"had_liked":false,"id":293372,"user_name":"Geek_cloud","can_delete":false,"product_type":"c1","uid":1820452,"ip_address":"","ucode":"83E6E4ACC024CB","user_header":"https://static001.geekbang.org/account/avatar/00/1b/c7/24/4a5c4015.jpg","comment_is_top":false,"comment_ctime":1621355733,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621355733","product_id":100046201,"comment_content":"这里提到对服务提供方进行分组，一个应用部署到集群上，部分机器提供核心业务A类接口，部分机器提供非核心业务B类接口，这样会不会额外因素分布式事务的问题又提升了复杂度呢？","like_count":0},{"had_liked":false,"id":286538,"user_name":"êｗěｎ","can_delete":false,"product_type":"c1","uid":1066707,"ip_address":"","ucode":"5000233111BEFA","user_header":"https://static001.geekbang.org/account/avatar/00/10/46/d3/e25d104a.jpg","comment_is_top":false,"comment_ctime":1617360941,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1617360941","product_id":100046201,"comment_content":"给请求染色经过网关做路由。","like_count":0},{"had_liked":false,"id":284918,"user_name":"程志东","can_delete":false,"product_type":"c1","uid":1978490,"ip_address":"","ucode":"EC55D66D657B49","user_header":"","comment_is_top":false,"comment_ctime":1616546488,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616546488","product_id":100046201,"comment_content":"不明白:服务在注册时，是不同的ip，提供不同的分组参数吗？怎么做到的？","like_count":0},{"had_liked":false,"id":277259,"user_name":"张申傲","can_delete":false,"product_type":"c1","uid":1182372,"ip_address":"","ucode":"22D46BC529BA8A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg","comment_is_top":false,"comment_ctime":1612337097,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1612337097","product_id":100046201,"comment_content":"解决高可用的思路，还可以增加通用的紧急车道，对应 RPC 里面就是默认分组，当一个分组下所有节点都不可用时，允许将流量切到默认分组。","like_count":0},{"had_liked":false,"id":253788,"user_name":"Hex","can_delete":false,"product_type":"c1","uid":1140780,"ip_address":"","ucode":"55F29EEF937D09","user_header":"https://static001.geekbang.org/account/avatar/00/11/68/2c/ec17f23b.jpg","comment_is_top":false,"comment_ctime":1602896955,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1602896955","product_id":100046201,"comment_content":"在上图分组调用拓扑图中，提供方服务提供两个分组A、B，为什么不直接拆成两个微服务呢？核心业务接口与非核心接口从服务级别分开会不会更好？","like_count":0,"discussions":[{"author":{"id":2826205,"avatar":"","nickname":"hillwater","note":"","ucode":"FB16D5FCE8C7E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590201,"discussion_content":"接口是同一个，因此接口没法再拆分。只是调用方有核心，非核心区别","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665587710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217815,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1589619090,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589619090","product_id":100046201,"comment_content":"分组确实好用，而且还可以控制是否同机房调用，如果一个机房有问题也可以切到别的机房，专门的分组也可以用来灵活做别的事情，比如：直接线上联调<br>老师问题，针对有条件进行环境隔离的是不存在的，针对没这个条件的，可以通过类似分组的方式进行服务分组隔离，这个也做不到，哪知道约定使用方式或时间区间了，当然，最好能环境隔离，同时有你进行数据的同步控制，这样既不互相影响又能测试类似的场景。","like_count":0},{"had_liked":false,"id":216187,"user_name":"shangrila","can_delete":false,"product_type":"c1","uid":1987570,"ip_address":"","ucode":"D79B5EA12CF9D0","user_header":"","comment_is_top":false,"comment_ctime":1589202943,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589202943","product_id":100046201,"comment_content":"都是业务实践经验的总结。","like_count":0},{"had_liked":false,"id":215796,"user_name":"dancer","can_delete":false,"product_type":"c1","uid":1019036,"ip_address":"","ucode":"B8D5641A3AC490","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg","comment_is_top":false,"comment_ctime":1589104613,"is_pvip":false,"replies":[{"id":"80444","content":"可以把限流融入到分组","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1589500659,"ip_address":"","comment_id":215796,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1589104613","product_id":100046201,"comment_content":"请问老师如果在限流阈值配置中加入应用分组的设置，和本文方案是不是也有相同的效果？","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494559,"discussion_content":"可以把限流融入到分组","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589500659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208508,"user_name":"redis","can_delete":false,"product_type":"c1","uid":1066278,"ip_address":"","ucode":"91C54605384F51","user_header":"https://static001.geekbang.org/account/avatar/00/10/45/26/f54c9888.jpg","comment_is_top":false,"comment_ctime":1587373553,"is_pvip":false,"replies":[{"id":"77930","content":"这是类似于命名空间的机制。","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1587387404,"ip_address":"","comment_id":208508,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1587373553","product_id":100046201,"comment_content":"多环境的服务，我们原来采用的是修改route模块，根据调用端IP提前建立私有圈子，如果本地服务启动了就调用自己本地的.","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492482,"discussion_content":"这是类似于命名空间的机制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587387404,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1228500,"avatar":"https://static001.geekbang.org/account/avatar/00/12/be/d4/ff1c1319.jpg","nickname":"金龟","note":"","ucode":"1C7D35C8AE8D9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366272,"discussion_content":"group就行吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618018751,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":197216,"user_name":"问心","can_delete":false,"product_type":"c1","uid":1250775,"ip_address":"","ucode":"6808568D61CE36","user_header":"https://static001.geekbang.org/account/avatar/00/13/15/d7/96e77edd.jpg","comment_is_top":false,"comment_ctime":1585363592,"is_pvip":true,"replies":[{"id":"74942","content":"分组跟限流不冲突，两个纬度","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585570451,"ip_address":"","comment_id":197216,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585363592","product_id":100046201,"comment_content":"老师，可以这样理解么？<br>按业务类型分组，各业务服务包含对应业务所有接口。<br>将对应业务中所有的接口进行分级，按级别进行分组。所有分组信息保存在限流服务中，并对各级别配置可用的临时级别，用于流量突增时临时借用，或直接对分组进行扩容。<br>调用方携带自身级别从限流服务中获取对应接口信息，限流服务在对应级别服务达到饱和时，考虑临时使用其他级别，并在流量降低时，停止使用临时级别。","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489476,"discussion_content":"分组跟限流不冲突，两个纬度","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585570451,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":195576,"user_name":"Jxin","can_delete":false,"product_type":"c1","uid":1251111,"ip_address":"","ucode":"4C03928388C413","user_header":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","comment_is_top":false,"comment_ctime":1585198795,"is_pvip":false,"replies":[{"id":"74954","content":"开发之间隔离可以通过直连的方式","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571098,"ip_address":"","comment_id":195576,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585198795","product_id":100046201,"comment_content":"1.测试环境和开发环境一般是隔离的，不会出现上述情况。问题可以改成：同个开发环境的小伙伴，如何保证自己测试时请求到的是自己的机器？<br><br>2.在分组后面追加变量，通过识别环境参数，做到每个人的分组都不一样，这就能做到隔离。但遗憾的是，这将复用不到一些部署在开发环境的已有应用。自己本地得跑全套。","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489115,"discussion_content":"开发之间隔离可以通过直连的方式","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":195378,"user_name":"雨霖铃声声慢","can_delete":false,"product_type":"c1","uid":1052607,"ip_address":"","ucode":"656D98310C6DA3","user_header":"https://static001.geekbang.org/account/avatar/00/10/0f/bf/ee93c4cf.jpg","comment_is_top":false,"comment_ctime":1585184229,"is_pvip":false,"replies":[{"id":"74965","content":"约定的东西很难口口相传","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571599,"ip_address":"","comment_id":195378,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585184229","product_id":100046201,"comment_content":"这种问题会有发生，但都是做法不规范造成的，一般的做法都是通过环境来区分，如开发的有专门的dev环境，测试的有专属的QA环境，生产的有专属的prod环境。而且如果有交叉使用的情况的话就要互相知会到，没必要通过技术手段来解决这种问题。","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489047,"discussion_content":"约定的东西很难口口相传","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194789,"user_name":"小哇","can_delete":false,"product_type":"c1","uid":1877904,"ip_address":"","ucode":"1C2C1FE3FCB9CE","user_header":"https://static001.geekbang.org/account/avatar/00/1c/a7/90/9a0da433.jpg","comment_is_top":false,"comment_ctime":1585106564,"is_pvip":false,"replies":[{"id":"74968","content":"同一个接口分不同组，分组的目的就是为了隔离不同调用方","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571744,"ip_address":"","comment_id":194789,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585106564","product_id":100046201,"comment_content":"请问老师，您讲的是同个服务集群的分组还是说不同服务的分组，如果是同个服务分组，既然同个服务里有核心和非核心接口，那是不是继续拆分服务才对呢？如果是不同服务，分组只是为了标识不同的应用而已吧？","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488900,"discussion_content":"同一个接口分不同组，分组的目的就是为了隔离不同调用方","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571744,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194746,"user_name":"Reason","can_delete":false,"product_type":"c1","uid":1878898,"ip_address":"","ucode":"C2A8D67BC6F94D","user_header":"https://static001.geekbang.org/account/avatar/00/1c/ab/72/c3a5eff3.jpg","comment_is_top":false,"comment_ctime":1585101814,"is_pvip":false,"replies":[{"id":"74970","content":"是的，可以利用自动部署来自动加","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571809,"ip_address":"","comment_id":194746,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585101814","product_id":100046201,"comment_content":"服务本身增加环境属性，注册信息中增加环境信息，服务发现时默认发现同环境的服务，类似于再增加个分组级别？","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488888,"discussion_content":"是的，可以利用自动部署来自动加","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194696,"user_name":"Dovelol","can_delete":false,"product_type":"c1","uid":1253384,"ip_address":"","ucode":"9B5DDF7720F307","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","comment_is_top":false,"comment_ctime":1585098052,"is_pvip":false,"replies":[{"id":"74971","content":"可以通过不同vip来隔离","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571843,"ip_address":"","comment_id":194696,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1585098052","product_id":100046201,"comment_content":"老师好，如果没有用rpc而是走http调用的微服务怎么做分组呢，现在有在网关可以做分组的吗？","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488873,"discussion_content":"可以通过不同vip来隔离","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571843,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1438037,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg","nickname":"陈国林","note":"","ucode":"83D12F3E79F197","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214461,"discussion_content":"Nginx 反向代理可以吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585194972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}