{"id":474775,"title":"10 | é›†æˆ Nacosï¼šå¦‚ä½•é€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶å‘æœåŠ¡æä¾›è€…å‘èµ·è°ƒç”¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å§šç§‹è¾°ã€‚</p><p>åœ¨ä¸Šä¸€è¯¾é‡Œï¼Œæˆ‘ä»¬å¯¹coupon-template-servå’Œcoupon-calculation-servè¿™ä¸¤ä¸ªæœåŠ¡åšäº†å¾®æœåŠ¡åŒ–æ”¹é€ ï¼Œé€šè¿‡æœåŠ¡æ³¨å†Œæµç¨‹å°†å®ƒä»¬æ³¨å†Œåˆ°äº†Nacos Serverã€‚è¿™ä¸¤ä¸ªæœåŠ¡æ˜¯ä»¥æœåŠ¡æä¾›è€…çš„èº«ä»½æ³¨å†Œçš„ï¼Œå®ƒä»¬ä¹‹é—´ä¸ä¼šå‘ç”Ÿç›¸äº’è°ƒç”¨ã€‚ä¸ºäº†å‘èµ·ä¸€æ¬¡å®Œæ•´çš„æœåŠ¡è°ƒç”¨è¯·æ±‚ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ„å»ºä¸€ä¸ªæœåŠ¡æ¶ˆè´¹è€…å»è®¿é—®Nacosä¸Šçš„å·²æ³¨å†ŒæœåŠ¡ã€‚</p><p>coupon-customer-servå°±æ‰®æ¼”äº†æœåŠ¡æ¶ˆè´¹è€…çš„è§’è‰²ï¼Œå®ƒéœ€è¦è°ƒç”¨coupon-template-servå’Œcoupon-calculation-servå®Œæˆè‡ªå·±çš„ä¸šåŠ¡æµç¨‹ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥åŠ¨æ‰‹æ”¹é€ coupon-customer-servæœåŠ¡ï¼Œå€ŸåŠ©Nacosçš„æœåŠ¡å‘ç°åŠŸèƒ½ä»æ³¨å†Œä¸­å¿ƒè·å–å¯ä¾›è°ƒç”¨çš„æœåŠ¡åˆ—è¡¨ï¼Œå¹¶å‘èµ·ä¸€ä¸ªè¿œç¨‹æœåŠ¡è°ƒç”¨ã€‚</p><p>é€šè¿‡ä»Šå¤©çš„å†…å®¹ï¼Œä½ å¯ä»¥äº†è§£å¦‚ä½•ä½¿ç”¨Webfluxå‘èµ·è¿œç¨‹è°ƒç”¨ï¼Œå¹¶ç†Ÿç»ƒæŒæ¡å¦‚ä½•æ­å»ºä¸€å¥—åŸºäºNacosçš„æœåŠ¡æ²»ç†æ–¹æ¡ˆã€‚</p><h2>æ·»åŠ Nacosä¾èµ–é¡¹å’Œé…ç½®ä¿¡æ¯</h2><p>åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰ï¼Œä½ éœ€è¦å°†ä»¥ä¸‹ä¾èµ–é¡¹æ·»åŠ åˆ°customer-customer-implå­æ¨¡å—çš„pom.xmlæ–‡ä»¶ä¸­ã€‚</p><pre><code>&lt;!-- NacosæœåŠ¡å‘ç°ç»„ä»¶ --&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;\n&lt;/dependency&gt;\n\n&lt;!-- è´Ÿè½½å‡è¡¡ç»„ä»¶ --&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;\n&lt;/dependency&gt;\n\n&lt;!-- webfluxæœåŠ¡è°ƒç”¨ --&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;\n&lt;/dependency&gt;    \n</code></pre><p>ç¬¬ä¸€ä¸ªä¾èµ–é¡¹ä½ ä¸€å®šå¾ˆç†Ÿæ‚‰äº†ï¼Œå®ƒæ˜¯NacosæœåŠ¡æ²»ç†çš„ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚è¯¾ç¨‹ä¸­ä¹Ÿæ·»åŠ äº†åŒæ¬¾ä¾èµ–é¡¹åˆ°coupon-template-implå’Œcoupon-calculation-implä¸¤ä¸ªæ¨¡å—ã€‚</p><!-- [[[read_end]]] --><p>åé¢ä¸¤ä¸ªä¾èµ–é¡¹ä½ åº”è¯¥æ˜¯ç¬¬ä¸€å›è§åˆ°ï¼Œæˆ‘æ¥å‘ä½ ç®€å•ä»‹ç»ä¸€ä¸‹ã€‚</p><ul>\n<li><strong>spring-cloud-starter-loadbalancer</strong>ï¼šSpring Cloudå¾¡ç”¨è´Ÿè½½å‡è¡¡ç»„ä»¶Loadbalancerï¼Œç”¨æ¥ä»£æ›¿å·²ç»è¿›å…¥ç»´æŠ¤çŠ¶æ€çš„Netflix Ribbonç»„ä»¶ã€‚æˆ‘ä¼šåœ¨ä¸‹ä¸€è¯¾å¸¦ä½ æ·±å…¥äº†è§£Loadbalancerçš„åŠŸèƒ½ï¼Œä»Šå¤©æˆ‘ä»¬åªéœ€è¦ç®€å•äº†è§£ä¸‹å®ƒçš„ç”¨æ³•å°±å¯ä»¥äº†ï¼›</li>\n<li><strong>spring-boot-starter-webflux</strong>ï¼šWebfluxæ˜¯Spring Bootæä¾›çš„å“åº”å¼ç¼–ç¨‹æ¡†æ¶ï¼Œå“åº”å¼ç¼–ç¨‹æ˜¯åŸºäºå¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨çš„éé˜»å¡ç¨‹åºã€‚Webfluxå®ç°äº†Reactive Streamsè§„èŒƒï¼Œå†…ç½®äº†ä¸°å¯Œçš„å“åº”å¼ç¼–ç¨‹ç‰¹æ€§ã€‚ä»Šå¤©æˆ‘å°†ç”¨Webfluxç»„ä»¶ä¸­ä¸€ä¸ªå«åšWebClientçš„å°å·¥å…·å‘èµ·è¿œç¨‹æœåŠ¡è°ƒç”¨ã€‚</li>\n</ul><p>æ·»åŠ å¥½è¿™ä¸¤ä¸ªä¾èµ–ä¹‹åï¼Œä½ è¿˜éœ€è¦åšä¸€ç•ªæ¸…ç†é—¨æˆ·çš„å·¥ä½œï¼Œè®©coupon-customer-servå’Œå¦å¤–ä¸¤ä¸ªå¾®æœåŠ¡ä¹‹é—´åˆ’æ¸…ç•Œé™ã€‚</p><ol>\n<li><strong>åˆ é™¤å®ç°å±‚ä¾èµ–</strong>ï¼šä»coupon-customer-implçš„ä¾èµ–é¡¹ä¸­åˆ é™¤coupon-template-implå’Œcoupon-calculation-implï¼›</li>\n<li><strong>æ·»åŠ æ¥å£å±‚ä¾èµ–</strong>ï¼šåœ¨coupon-customer-implçš„ä¾èµ–é¡¹ä¸­æ·»åŠ coupon-template-apiå’Œcoupon-calculation-apiã€‚</li>\n</ol><p>è¿™æ ·åšçš„ç›®çš„æ˜¯<strong>åˆ’æ¸…æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»</strong>ï¼Œ<font color=\"#ff9900\">ç”±äºcoupon-customer-servæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œå®ƒä¸éœ€è¦å°†å…¶ä»–æœåŠ¡çš„â€œä»£ç é€»è¾‘å®ç°å±‚â€æ‰“åŒ…åˆ°è‡ªå·±çš„å¯åŠ¨ç¨‹åºä¸­ä¸€åŒå¯åŠ¨ã€‚å¦‚æœæŸä¸ªåº”ç”¨åœºæ™¯éœ€è¦è°ƒç”¨å…¶å®ƒå¾®æœåŠ¡ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨è¿œç¨‹æ¥å£è°ƒç”¨çš„æ–¹å¼å¯¹ç›®æ ‡æœåŠ¡å‘èµ·è¯·æ±‚ã€‚</font>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†å¯¹åº”æ¥å£çš„Implå®ç°å±‚ä»coupon-customer-implçš„ä¾èµ–ä¸­åˆ é™¤ï¼ŒåŒæ—¶å¼•å…¥APIå±‚çš„ä¾èµ–ï¼Œä»¥ä¾¿æ„é€ è¯·æ±‚å‚æ•°å’Œæ¥æ”¶æœåŠ¡å“åº”ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œä½ è¿˜éœ€è¦åœ¨coupon-customer-implé¡¹ç›®çš„application.ymlæ–‡ä»¶ä¸­æ·»åŠ Nacosçš„é…ç½®é¡¹ï¼Œæˆ‘ä»¬ç›´æ¥ä»coupon-template-implçš„é…ç½®é¡¹é‡ŒæŠ„ä½œä¸šå°±å¥½äº†ã€‚å°†spring.cloud.nacosè·¯å¾„ä¸‹çš„é…ç½®é¡¹copyåˆ°coupon-customer-implé¡¹ç›®ä¸­ï¼Œå¦‚æœä½ é€šè¿‡spring.cloud.nacos.discovery.serviceå‚æ•°æŒ‡å®šäº†æœåŠ¡åç§°ï¼Œé‚£ä½ è¦<strong>è®°å¾—åœ¨æŠ„ä½œä¸šçš„æ—¶å€™æŠŠåå­—æ”¹æ‰</strong>ï¼Œæ”¹æˆcoupon-customer-implã€‚</p><p>ä¿®æ”¹å®Œä¾èµ–é¡¹å’Œé…ç½®ä¿¡æ¯ä¹‹åï¼Œä½ çš„ä»£ç ä¸€å®šå†’å‡ºäº†ä¸å°‘ç¼–è¯‘é”™è¯¯ã€‚å› ä¸ºå°½ç®¡æˆ‘ä»¬å·²ç»å°†coupon-template-implå’Œcoupon-calculation-implä¾èµ–é¡¹åˆ é™¤ï¼Œä½†coupon-customer-implä¸­çš„CouponCustomerServiceImplä»ç„¶ä½¿ç”¨Autowireæ³¨å…¥çš„æ–¹å¼è°ƒç”¨æœ¬åœ°æœåŠ¡ã€‚</p><p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹è°ƒç”¨å±‚åšä¸€ç•ªæ”¹é€ ï¼Œå°†Autowireæ³¨å…¥æœ¬åœ°æœåŠ¡çš„æ–¹å¼ï¼Œæ›¿æ¢ä¸ºä½¿ç”¨WebClientå‘èµ·è¿œç¨‹è°ƒç”¨ã€‚</p><h2>æ·»åŠ WebClientå¯¹è±¡</h2><p>ä¸ºäº†å¯ä»¥ç”¨WebClientå‘èµ·è¿œç¨‹è°ƒç”¨ï¼Œä½ è¿˜éœ€è¦åœ¨Springä¸Šä¸‹æ–‡ä¸­æ„é€ ä¸€ä¸ªWebClientå¯¹è±¡ã€‚æ ‡å‡†çš„åšæ³•æ˜¯åˆ›å»ºä¸€ä¸ªConfigurationç±»ï¼Œå¹¶åœ¨è¿™ä¸ªç±»ä¸­é€šè¿‡@Beanæ³¨è§£åˆ›å»ºéœ€è¦çš„å¯¹è±¡ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨coupon-customer-implå­æ¨¡å—ä¸‹åˆ›å»ºäº†com.geekbang.coupon.customer.Configurationç±»ï¼Œå¹¶å£°æ˜WebClientçš„Builderå¯¹è±¡ã€‚</p><pre><code>// Configurationæ³¨è§£å£°æ˜é…ç½®ç±»\n@org.springframework.context.annotation.Configuration\npublic class Configuration {\n\n    // æ³¨å†ŒBeanå¹¶æ·»åŠ è´Ÿè½½å‡è¡¡åŠŸèƒ½\n    @Bean\n    @LoadBalanced\n    public WebClient.Builder register() {\n        return WebClient.builder();\n    }\n\n}\n</code></pre><p>è™½ç„¶ä¸Šé¢çš„ä»£ç æ²¡å‡ è¡Œï¼Œä½†æˆ‘è¶³è¶³ç”¨äº†ä¸‰ä¸ªæ³¨è§£ï¼Œè¿™äº›æ³¨è§£å„æœ‰ç”¨é€”ã€‚</p><ul>\n<li>@<strong>Configurationæ³¨è§£</strong>ï¼šå®šä¹‰ä¸€ä¸ªé…ç½®ç±»ã€‚åœ¨Configurationç±»ä¸­å®šä¹‰çš„@Beanæ³¨è§£æ–¹æ³•ä¼šè¢«AnnotationConfigApplicationContextæˆ–è€…AnnotationConfigWebApplicationContextæ‰«æå¹¶åœ¨ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œæ„å»ºï¼›</li>\n<li>@<strong>Beanæ³¨è§£</strong>ï¼šå£°æ˜ä¸€ä¸ªå—Springå®¹å™¨æ‰˜ç®¡çš„Beanï¼›</li>\n<li>@<strong>LoadBalancedæ³¨è§£</strong>ï¼šä¸ºWebClient.Buildæ„é€ å™¨æ³¨å…¥ç‰¹æ®Šçš„Filterï¼Œå®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œæˆ‘åœ¨ä¸‹ä¸€è¯¾ä¼šè¯¦ç»†è§£é‡Šè´Ÿè½½å‡è¡¡çš„çŸ¥è¯†ç‚¹ã€‚ä»Šå¤©å’±å°±å¥½è¯»ä¹¦ä¸æ±‚ç”šè§£å°±å¯ä»¥äº†ï¼Œåªéœ€è¦çŸ¥é“è¿™ä¸ªæ³¨è§£çš„ä½œç”¨æ˜¯åœ¨è¿œç¨‹è°ƒç”¨å‘èµ·ä¹‹å‰é€‰å®šç›®æ ‡æœåŠ¡å™¨åœ°å€ã€‚</li>\n</ul><p>WebClientåˆ›å»ºå¥½äº†ä¹‹åï¼Œä½ å°±å¯ä»¥åœ¨ä¸šåŠ¡ç±»ä¸­æ³¨å…¥WebClientå¯¹è±¡ï¼Œå¹¶å‘èµ·æœåŠ¡è°ƒç”¨äº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ‰‹æŠŠæ‰‹å¸¦ä½ å°†CouponCustomerServiceImplé‡Œçš„æœ¬åœ°æ–¹æ³•è°ƒç”¨æ›¿æ¢æˆWebClientè¿œç¨‹è°ƒç”¨ã€‚</p><h2>ä½¿ç”¨WebClientå‘èµ·è¿œç¨‹æ–¹æ³•è°ƒç”¨</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†Configurationç±»ä¸­å£°æ˜çš„WebClientçš„Builderå¯¹è±¡æ³¨å…¥åˆ°CouponCustomerServiceImplç±»ä¸­ï¼Œä¸¤è¡Œä»£ç ç®€å•æå®šï¼š</p><pre><code>@Autowired\nprivate WebClient.Builder webClientBuilder;\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹æ”¹é€ ç¬¬ä¸€ä¸ªæ¥å£requestCouponã€‚ä½ éœ€è¦å°†requestCouponæ¥å£å®ç°çš„ç¬¬ä¸€è¡Œä»£ç ä¸­çš„CouponTemplateServiceæœ¬åœ°è°ƒç”¨æ›¿æ¢ä¸ºWebClientè¿œç¨‹è°ƒç”¨ã€‚ä¸‹é¢æ˜¯æ”¹é€ ä¹‹å‰çš„ä»£ç ã€‚</p><pre><code>CouponTemplateInfo templateInfo = templateService.loadTemplateInfo(request.getCouponTemplateId());\n</code></pre><p>è¿œç¨‹æ¥å£è°ƒç”¨çš„ä»£ç æ”¹é€ å¯ä»¥é€šè¿‡WebClientæä¾›çš„â€œé“¾å¼ç¼–ç¨‹â€è½»æ¾å®ç°ï¼Œä¸‹é¢æ˜¯ä»£ç çš„å®Œæ•´å®ç°ã€‚</p><pre><code>CouponTemplateInfo templateInfo = webClientBuilder.build()\n        .get()\n        .uri(&quot;http://coupon-template-serv/template/getTemplate?id=&quot; + request.getCouponTemplateId())\n        .retrieve()\n        .bodyToMono(CouponTemplateInfo.class)\n        .block();\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åº”ç”¨äº†å‡ ä¸ªå…³é”®æ–¹æ³•å‘èµ·è¿œç¨‹è°ƒç”¨ã€‚</p><ul>\n<li>getï¼šæŒ‡æ˜äº†Http Methodæ˜¯GETï¼Œå¦‚æœæ˜¯å…¶ä»–è¯·æ±‚ç±»å‹åˆ™ä½¿ç”¨å¯¹åº”çš„postã€putã€patchã€deleteç­‰æ–¹æ³•ï¼›</li>\n<li>uriï¼šæŒ‡å®šäº†è®¿é—®çš„è¯·æ±‚åœ°å€ï¼›</li>\n<li>retrieve + bodyToMonoï¼šæŒ‡å®šäº†Responseçš„è¿”å›æ ¼å¼ï¼›</li>\n<li>blockï¼šå‘èµ·ä¸€ä¸ªé˜»å¡è°ƒç”¨ï¼Œåœ¨è¿œç¨‹æœåŠ¡æ²¡æœ‰å“åº”ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ã€‚</li>\n</ul><p><font color=\"#ff9900\">åœ¨ä½¿ç”¨uriæŒ‡å®šè°ƒç”¨æœåŠ¡çš„åœ°å€æ—¶ï¼Œä½ å¹¶ä¸éœ€è¦æä¾›ç›®æ ‡æœåŠ¡çš„IPåœ°å€å’Œç«¯å£å·ï¼Œåªéœ€è¦å°†ç›®æ ‡æœåŠ¡çš„æœåŠ¡åç§°coupon-template-servå‘Šè¯‰WebClientå°±å¥½äº†ã€‚</font>Nacosåœ¨èƒŒåä¼šé€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå¸®ä½ è·å–åˆ°ç›®æ ‡æœåŠ¡çš„æ‰€æœ‰å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ã€‚ç„¶åï¼ŒWebClientä¼šé€šè¿‡è´Ÿè½½å‡è¡¡è¿‡æ»¤å™¨ï¼Œä»åˆ—è¡¨ä¸­é€‰å–ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè°ƒç”¨ï¼Œæ•´ä¸ªæµç¨‹å¯¹å¼€å‘äººå‘˜éƒ½æ˜¯<strong>é€æ˜çš„</strong>ã€<strong>æ— æ„ŸçŸ¥çš„</strong>ã€‚</p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä»£ç ä¸­æˆ‘ä½¿ç”¨äº†retrieve + bodyToMonoçš„æ–¹å¼æ¥æ”¶Responseå“åº”ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºCouponTemplateInfoå¯¹è±¡ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘åªæ¥æ”¶äº†Responseè¿”å›çš„Bodyå†…å®¹ï¼Œå¹¶æ²¡æœ‰å¯¹Responseä¸­åŒ…å«çš„å…¶å®ƒå­—æ®µè¿›è¡Œå¤„ç†ã€‚</p><p>å¦‚æœä½ éœ€è¦è·å–å®Œæ•´çš„Responseï¼ŒåŒ…æ‹¬Http statusã€headersç­‰é¢å¤–æ•°æ®ï¼Œå°±å¯ä»¥ä½¿ç”¨retrieve + toEntityçš„æ–¹å¼ï¼Œè·å–åŒ…å«å®Œæ•´Responseä¿¡æ¯çš„ResponseEntityå¯¹è±¡ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼Œä½ å¯ä»¥è‡ªå·±åœ¨é¡¹ç›®ä¸­å°è¯•è¿™ç§è°ƒç”¨æ–¹å¼ï¼Œä½“éªŒä¸‹toEntityå’ŒbodyToMonoçš„ä¸åŒä¹‹å¤„ã€‚</p><pre><code>Mono&lt;ResponseEntity&lt;CouponTemplateInfo&gt;&gt; entityMono = client.get()\n\t.uri(&quot;http://coupon-template-serv/template/xxxx&quot;)\n\t.accept(MediaType.APPLICATION_JSON)\n\t.retrieve()\n\t.toEntity(CouponTemplateInfo.class);\n</code></pre><p>WebClientä½¿ç”¨äº†ä¸€ç§<strong>é“¾å¼ç¼–ç¨‹</strong>çš„é£æ ¼æ¥æ„é€ è¯·æ±‚å¯¹è±¡ï¼Œé“¾å¼ç¼–ç¨‹å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„Builderå»ºé€ è€…æ¨¡å¼ã€‚ä»”ç»†è§‚å¯Ÿä½ ä¼šå‘ç°ï¼Œå¤§éƒ¨åˆ†å¼€æºåº”ç”¨éƒ½åœ¨ä½¿ç”¨è¿™ç§è®¾è®¡æ¨¡å¼ç®€åŒ–å¯¹è±¡çš„æ„å»ºã€‚å¦‚æœä½ éœ€è¦åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­ä½¿ç”¨Builderæ¨¡å¼ï¼Œä½ å¯ä»¥å€ŸåŠ©Lombokç»„ä»¶çš„@Builderæ³¨è§£æ¥å®ç°ã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªè¡Œäº†è§£Lombokç»„ä»¶çš„ç›¸å…³ç”¨æ³•ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†requestCouponæ–¹æ³•çš„æ”¹é€ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¶çƒ­æ‰“é“ï¼ŒåŠ¨æ‰‹å»æ›¿æ¢findCouponå’ŒplaceOrderæ–¹æ³•ä¸­çš„æœ¬åœ°è°ƒç”¨ã€‚æœ‰äº†ä¹‹å‰çš„åŸºç¡€ï¼Œè¿™æ¬¡æ›¿æ¢å¯¹ä½ æ¥è¯´å·²ç»æ˜¯å°èœä¸€ç¢Ÿäº†ã€‚</p><p>åœ¨findCouponæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨coupon-template-servçš„æœåŠ¡æ‰¹é‡æŸ¥è¯¢CouponTemplateã€‚è¿™é‡Œçš„æ–¹å¼å’Œå‰é¢ä¸€æ ·ï¼Œæˆ‘ä½¿ç”¨WebClientå¯¹æœ¬åœ°è°ƒç”¨è¿›è¡Œäº†æ›¿æ¢ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„æºç ã€‚</p><pre><code>Map&lt;Long, CouponTemplateInfo&gt; templateMap = webClientBuilder.build().get()\n        .uri(&quot;http://coupon-template-serv/template/getBatch?ids=&quot; + templateIds)\n        .retrieve()\n        .bodyToMono(new ParameterizedTypeReference&lt;Map&lt;Long, CouponTemplateInfo&gt;&gt;() {})\n        .block();\n</code></pre><p>ç”±äºæ–¹æ³•çš„è¿”å›å€¼ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„Jsonå¯¹è±¡ï¼Œè€Œæ˜¯Map&lt;Long, CouponTemplateInfo&gt;ç±»å‹ï¼Œå› æ­¤ä½ éœ€è¦æ„é€ ä¸€ä¸ªParameterizedTypeReferenceå®ä¾‹ä¸¢ç»™WebClientï¼Œå‘Šè¯‰å®ƒåº”è¯¥å°†Responseè½¬åŒ–æˆä»€ä¹ˆç±»å‹ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬è¿˜å‰©ä¸‹ä¸€ä¸ªå…³é”®æ–¹æ³•æ²¡æœ‰æ”¹é€ ï¼Œé‚£å°±æ˜¯placeOrderï¼Œå®ƒè°ƒç”¨äº†coupon-calculation-servè®¡ç®—æœ€ç»ˆçš„è®¢å•ä»·æ ¼ï¼Œä½ å¯ä»¥å‚è€ƒä»¥ä¸‹æºç ã€‚</p><pre><code>ShoppingCart checkoutInfo = webClientBuilder.build()\n        .post()\n        .uri(&quot;http://coupon-calculation-serv/calculator/checkout&quot;)\n        .bodyValue(order)\n        .retrieve()\n        .bodyToMono(ShoppingCart.class)\n        .block();\n</code></pre><p>å’Œå‰é¢å‡ å¤„æ”¹é€ ä¸åŒçš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªPOSTè¯·æ±‚ï¼Œå› æ­¤åœ¨ä½¿ç”¨webClientæ„é€ å™¨çš„æ—¶å€™æˆ‘è°ƒç”¨äº†postæ–¹æ³•ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜éœ€è¦æ¥æ”¶è®¢å•çš„å®Œæ•´ä¿¡æ¯ä½œä¸ºè¯·æ±‚å‚æ•°ï¼Œå› æ­¤æˆ‘è¿™é‡Œè°ƒç”¨äº†bodyValueæ–¹æ³•ï¼Œå°†å°è£…å¥½çš„Orderå¯¹è±¡å¡äº†è¿›å»ã€‚åœ¨coupon-customer-implä¸­å‰©ä¸‹çš„ä¸€äº›è¿œç¨‹è°ƒç”¨æ–¹æ³•ï¼Œå°±ç•™ç»™ä½ æ¥æ–½å±•æ‹³è„šåšæ”¹é€ äº†ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ•´ä¸ªNacosæœåŠ¡æ”¹é€ å°±å·²ç»å®Œæˆäº†ã€‚ä½ å¯ä»¥åœ¨æœ¬åœ°ä¾æ¬¡å¯åŠ¨coupon-template-servã€coupon-calculation-servå’Œcoupon-customer-servã€‚å¯åŠ¨æˆåŠŸåï¼Œå†åˆ°Nacosæ§åˆ¶å°æŸ¥çœ‹è¿™ä¸‰ä¸ªæœåŠ¡æ˜¯å¦å·²ç»å…¨éƒ¨æ³¨å†Œåˆ°äº†Nacosã€‚</p><p>å¦‚æœä½ æ˜¯ä»¥é›†ç¾¤æ¨¡å¼å¯åŠ¨äº†å¤šå°NacosæœåŠ¡å™¨ï¼Œé‚£ä¹ˆå³ä¾¿ä½ åœ¨å®æˆ˜é¡¹ç›®ä¸­åªé…ç½®äº†ä¸€ä¸ªNacos URLï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨è™šæ‹ŸIPæ­å»ºå•ç‹¬çš„é›†ç¾¤åœ°å€ï¼Œæ³¨å†Œä¿¡æ¯ä¹Ÿä¼šä¼ æ’­åˆ°Nacosé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f7/2b/f7ab64d2526106b7734c2608ae01c02b.jpg?wh=2000x903\" alt=\"\"></p><p>ç°åœ¨ï¼ŒåŠ¨æ‰‹æ­å»ºä¸€å¥—åŸºäºNacosçš„æœåŠ¡æ²»ç†æ–¹æ¡ˆå¯¹ä½ è€Œè¨€ä¸€å®šä¸æ˜¯éš¾äº‹å„¿äº†ã€‚åŠ¨æ‰‹èƒ½åŠ›æ˜¯æœ‰äº†ï¼Œä½†æˆ‘ä»¬ä¹Ÿä¸èƒ½ä»…ä»…æ»¡è¶³äºå­¦ä¼šä½¿ç”¨ä¸€å¥—æŠ€æœ¯ï¼Œ<strong>ä½ å¿…é¡»è¦æ·±å…¥åˆ°æŠ€æœ¯çš„å…·ä½“å®ç°æ–¹æ¡ˆï¼Œæ‰èƒ½ä»ä¸­æ±²å–åˆ°å…»åˆ†ï¼Œä¸ºä½ å°†æ¥çš„æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡æä¾›å‚è€ƒ</strong>ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘å¸¦ä½ å»äº†è§£ä¸€ä¸‹NacosæœåŠ¡å‘ç°çš„åº•å±‚å®ç°ï¼Œå­¦ä¹ ä¸€ä¸‹Clientç«¯æ˜¯é€šè¿‡ä»€ä¹ˆé€”å¾„ä»Nacos Serverè·å–æœåŠ¡æ³¨å†Œè¡¨çš„ã€‚</p><h2>NacosæœåŠ¡å‘ç°åº•å±‚å®ç°</h2><p>Nacos Clienté€šè¿‡ä¸€ç§<strong>ä¸»åŠ¨è½®è¯¢</strong>çš„æœºåˆ¶ä»Nacos Serverè·å–æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ°å€åˆ—è¡¨ã€groupåˆ†ç»„ã€clusteråç§°ç­‰ä¸€ç³»åˆ—æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼ŒNacos Clientä¼šå¼€å¯ä¸€ä¸ªæœ¬åœ°çš„å®šæ—¶ä»»åŠ¡ï¼Œæ¯é—´éš”ä¸€æ®µæ—¶é—´ï¼Œå°±å°è¯•ä»Nacos ServeræŸ¥è¯¢æœåŠ¡æ³¨å†Œè¡¨ï¼Œå¹¶å°†æœ€æ–°çš„æ³¨å†Œä¿¡æ¯æ›´æ–°åˆ°æœ¬åœ°ã€‚è¿™ç§æ–¹å¼ä¹Ÿè¢«ç§°ä¹‹ä¸ºâ€œPullâ€æ¨¡å¼ï¼Œå³å®¢æˆ·ç«¯ä¸»åŠ¨ä»æœåŠ¡ç«¯æ‹‰å–çš„æ¨¡å¼ã€‚</p><p>è´Ÿè´£æ‹‰å–æœåŠ¡çš„ä»»åŠ¡æ˜¯UpdateTaskç±»ï¼Œå®ƒå®ç°äº†Runnableæ¥å£ã€‚Nacosä»¥å¼€å¯çº¿ç¨‹çš„æ–¹å¼è°ƒç”¨UpdateTaskç±»ä¸­çš„runæ–¹æ³•ï¼Œè§¦å‘æœ¬åœ°çš„æœåŠ¡å‘ç°æŸ¥è¯¢è¯·æ±‚ã€‚</p><p>UpdateTaskè¿™ä¸ªç±»éšè—å¾—éå¸¸æ·±ï¼Œå®ƒæ˜¯HostReactor<br>\nçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œæˆ‘å¸¦ä½ çœ‹ä¸€ä¸‹ç»è¿‡è¯¦ç»†æ³¨é‡Šçš„ä»£ç èµ°è¯»ï¼š</p><pre><code>public class UpdateTask implements Runnable {\n\n    // ....çœç•¥éƒ¨åˆ†ä»£ç \n    \n    // è·å–æœåŠ¡åˆ—è¡¨\n    @Override\n    public void run() {\n        long delayTime = DEFAULT_DELAY;\n        \n        try {\n            // æ ¹æ®service nameè·å–åˆ°å½“å‰æœåŠ¡çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨åœ°å€åˆ—è¡¨\n            ServiceInfo serviceObj = serviceInfoMap\n                .get(ServiceInfo.getKey(serviceName, clusters));\n            \n            // å¦‚æœä¸ºç©ºï¼Œåˆ™é‡æ–°æ‹‰å–æœ€æ–°çš„æœåŠ¡åˆ—è¡¨\n            if (serviceObj == null) {\n                updateService(serviceName, clusters);\n                return;\n            }\n            \n            // å¦‚æœæ—¶é—´æˆ³&lt;=ä¸Šæ¬¡æ›´æ–°çš„æ—¶é—´ï¼Œåˆ™è¿›è¡Œæ›´æ–°æ“ä½œ\n            if (serviceObj.getLastRefTime() &lt;= lastRefTime) {\n                updateService(serviceName, clusters);\n                serviceObj = serviceInfoMap.get(ServiceInfo.getKey(serviceName, clusters));\n            } else {\n                // å¦‚æœserviceObjçš„refTimeæ›´æ™šï¼Œ\n                // åˆ™è¡¨ç¤ºæœåŠ¡é€šè¿‡ä¸»åŠ¨pushæœºåˆ¶å·²è¢«æ›´æ–°ï¼Œè¿™æ—¶æˆ‘ä»¬åªè¿›è¡Œåˆ·æ–°æ“ä½œ\n                refreshOnly(serviceName, clusters);\n            }\n            // åˆ·æ–°æœåŠ¡çš„æ›´æ–°æ—¶é—´\n            lastRefTime = serviceObj.getLastRefTime();\n            \n            // å¦‚æœè®¢é˜…è¢«å–æ¶ˆï¼Œåˆ™åœæ­¢æ›´æ–°ä»»åŠ¡\n            if (!notifier.isSubscribed(serviceName, clusters) &amp;&amp; !futureMap\n                    .containsKey(ServiceInfo.getKey(serviceName, clusters))) {\n                // abort the update task\n                NAMING_LOGGER.info(&quot;update task is stopped, service:&quot; + serviceName + &quot;, clusters:&quot; + clusters);\n                return;\n            }\n            // å¦‚æœæ²¡æœ‰å¯ä¾›è°ƒç”¨çš„æœåŠ¡åˆ—è¡¨ï¼Œåˆ™ç»Ÿè®¡å¤±è´¥æ¬¡æ•°+1\n            if (CollectionUtils.isEmpty(serviceObj.getHosts())) {\n                incFailCount();\n                return;\n            }\n            // è®¾ç½®å»¶è¿Ÿä¸€æ®µæ—¶é—´åè¿›è¡ŒæŸ¥è¯¢\n            delayTime = serviceObj.getCacheMillis();\n            // å°†å¤±è´¥æŸ¥è¯¢æ¬¡æ•°é‡ç½®ä¸º0\n            resetFailCount();\n        } catch (Throwable e) {\n            incFailCount();\n            NAMING_LOGGER.warn(&quot;[NA] failed to update serviceName: &quot; + serviceName, e);\n        } finally {\n            // è®¾ç½®ä¸‹ä¸€æ¬¡æŸ¥è¯¢ä»»åŠ¡çš„è§¦å‘æ—¶é—´\n            executor.schedule(this, Math.min(delayTime &lt;&lt; failCount, DEFAULT_DELAY * 60), TimeUnit.MILLISECONDS);\n        }\n    }\n}\n</code></pre><p>åœ¨UpdateTaskçš„æºç ä¸­ï¼Œå®ƒé€šè¿‡è°ƒç”¨updateServiceæ–¹æ³•å®ç°äº†æœåŠ¡æŸ¥è¯¢å’Œæœ¬åœ°æ³¨å†Œè¡¨æ›´æ–°ï¼Œåœ¨æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œåœ¨ç»“å°¾å¤„å®ƒé€šè¿‡finallyä»£ç å—è®¾ç½®äº†ä¸‹ä¸€æ¬¡executoræŸ¥è¯¢çš„æ—¶é—´ï¼Œå‘¨è€Œå¤å§‹å¾ªç¯å¾€å¤ã€‚</p><p>ä»¥ä¸Šï¼Œå°±æ˜¯Nacosé€šè¿‡UpdateTaskæ¥æŸ¥è¯¢æœåŠ¡ç«¯æ³¨å†Œè¡¨çš„åº•å±‚åŸç†äº†ã€‚</p><p>é‚£ä¹ˆç°åœ¨æˆ‘å°±è¦è€ƒè€ƒä½ äº†ï¼Œä½ çŸ¥é“UpdateTaskæ˜¯åœ¨ä»€ä¹ˆé˜¶æ®µç”±å“ªä¸€ä¸ªç±»é¦–æ¬¡è§¦å‘çš„å—ï¼Ÿæˆ‘å·²ç»æŠŠè¿™ä¸ªè—¤äº¤åˆ°ä½ æ‰‹ä¸Šäº†ï¼Œå¸Œæœ›ä½ èƒ½é¡ºè—¤æ‘¸ç“œï¼Œé¡ºç€UpdateTaskç±»ï¼Œä»æºç å±‚é¢æ‰¾åˆ°å®ƒçš„ä¸Šæ¸¸è°ƒç”¨æ–¹ï¼Œç†æ¸…æ•´ä¸ªæœåŠ¡å‘ç°é“¾è·¯çš„æµç¨‹ã€‚</p><h2>æ€»ç»“</h2><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†geekbang-coupon-centerçš„NacosæœåŠ¡æ²»ç†æ”¹é€ ã€‚é€šè¿‡è¿™ä¸¤èŠ‚è¯¾ï¼Œä½ å®Œæ•´æ­å»ºäº†æ•´ä¸ªNacosæœåŠ¡æ²»ç†é“¾è·¯ã€‚åœ¨è¿™æ¡é“¾è·¯ä¸­ï¼Œä½ é€šè¿‡<strong>æœåŠ¡æ³¨å†Œ</strong>æµç¨‹å®ç°äº†æœåŠ¡æä¾›è€…çš„æ³¨å†Œï¼Œåˆé€šè¿‡<strong>æœåŠ¡å‘ç°</strong>æœºåˆ¶è®©æœåŠ¡æ¶ˆè´¹è€…è·å–æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼Œè¿˜èƒ½é€šè¿‡WebClientå‘èµ·<strong>è¿œç¨‹è°ƒç”¨</strong>ã€‚</p><p>åœ¨è¿™æ®µå­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œå­¦ä¼šå¦‚ä½•ä½¿ç”¨æŠ€æœ¯æ˜¯ä¸€ä»¶å¾ˆå®¹æ˜“çš„äº‹å„¿ï¼Œè€Œå­¦ä¼šå®ƒèƒŒåçš„åŸç†å´éœ€è¦èŠ±ä¸Šæ•°å€çš„åŠŸå¤«ã€‚åœ¨æ¯èŠ‚å®æˆ˜è¯¾é‡Œæˆ‘éƒ½ä¼šåŠ ä¸Šä¸€äº›æºç åˆ†æï¼Œä¸ä»…æˆä¹‹ä»¥é±¼ï¼Œæ›´è¦æˆä¹‹ä»¥æ¸”ï¼Œè®©ä½ å­¦ä¼šå¦‚ä½•é€šè¿‡æ·±å…¥æºç å»å­¦ä¹ ä¸€ä¸ªæ¡†æ¶ã€‚</p><p>ä¸ºä»€ä¹ˆå­¦ä¹ æºç è¿™ä¹ˆé‡è¦å‘¢ï¼Ÿæˆ‘è¿™ä¹ˆè¯´å§ï¼Œè¿™å°±åƒä½ å­¦ä¹ å†™ä½œä¸€æ ·ï¼Œå°å­¦åˆšå¼€å§‹ç»ƒä¹ å†™ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯ä»â€œæ¨¡ä»¿â€å¼€å§‹çš„ã€‚éšç€é˜…å†ã€çŸ¥è¯†å’Œé˜…è¯»é‡çš„å¢å¤šï¼Œä½ é€æ¸æœ‰äº†è‡ªå·±çš„æ€è€ƒå’Œæƒ³æ³•ï¼Œå»ºç«‹äº†å±äºä½ çš„å†™ä½œé£æ ¼ã€‚å­¦ä¹ æŠ€æœ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå¥½çš„å¼€æºæ¡†æ¶å°±åƒä¸€æœ¬ä½³ä½œï¼ŒSpringç¤¾åŒºå­µåŒ–çš„æ¡†æ¶æ›´æ˜¯å¦‚æ­¤ï¼Œä½ ä»ä¸­å¯ä»¥æ±²å–å¾ˆå¤šè¥å…»ï¼Œè¿›è€Œå®Œå–„è‡ªå·±çš„æ¶æ„ç†å¿µå’ŒæŠ€æœ¯ç»†èŠ‚ã€‚è‹¥å¹²å¹´åå½“ä½ æˆä¸ºç‹¬å½“ä¸€é¢çš„æ¶æ„å¸ˆï¼Œè¿™äº›å¹³æ—¥é‡Œçš„ç§¯ç´¯ç»ˆä¼šä¸ºä½ æ‰€ç”¨ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å¦‚æœæŸä¸ªæœåŠ¡èŠ‚ç‚¹ç¢°åˆ°äº†æŸäº›å¼‚å¸¸çŠ¶å†µï¼Œæ¯”å¦‚ç½‘ç»œæ•…éšœæˆ–è€…ç£ç›˜ç©ºé—´å·²æ»¡ï¼Œå¯¼è‡´æ— æ³•å“åº”æœåŠ¡è¯·æ±‚ã€‚ä½ çŸ¥é“Nacosé€šè¿‡ä»€ä¹ˆé€”å¾„æ¥è¯†åˆ«æ•…éšœæœåŠ¡ï¼Œå¹¶ä»Nacos Serverçš„æœåŠ¡æ³¨å†Œè¡¨ä¸­å°†æ•…éšœæœåŠ¡å‰”é™¤çš„å—ï¼Ÿ</p><p>å¥½å•¦ï¼Œè¿™èŠ‚è¯¾å°±ç»“æŸå•¦ã€‚æ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹Spring Cloudæ„Ÿå…´è¶£çš„æœ‹å‹ã€‚æˆ‘æ˜¯å§šç§‹è¾°ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"09 | é›†æˆ Nacosï¼šå¦‚ä½•å°†æœåŠ¡æä¾›è€…æ³¨å†Œåˆ° Nacos æœåŠ¡å™¨ï¼Ÿ","id":473988},"right":{"article_title":"11 | Loadbalancer å®æˆ˜ï¼šé€šè¿‡è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥å®ç°é‡‘ä¸é›€æµ‹è¯•","id":475111}},"comments":[{"had_liked":false,"id":330102,"user_name":"~","can_delete":false,"product_type":"c1","uid":2495621,"ip_address":"","ucode":"BE5E3BD6EE3665","user_header":"https://static001.geekbang.org/account/avatar/00/26/14/85/73e55be5.jpg","comment_is_top":false,"comment_ctime":1641797759,"is_pvip":false,"replies":[{"id":"120285","content":"éå¸¸æ£’ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1641821873,"ip_address":"","comment_id":330102,"utype":1}],"discussion_count":1,"race_medal":0,"score":"74656241791","product_id":100101301,"comment_content":"å›ç­”ä¸€ä¸‹è°ƒç”¨é“¾è·¯çš„é—®é¢˜ï¼š<br>é¦–å…ˆåœ¨ spring.factory æ–‡ä»¶ä¸­é…ç½®äº† NacosDiscoveryClientConfiguration ç±»ï¼Œç”¨äº springboot çš„åˆå§‹åŒ–æ—¶çš„è‡ªåŠ¨è£…é…ã€‚åœ¨ NacosDiscoveryClientConfiguration ç±»ä¸­ä¼šå‘ spring å®¹å™¨ä¸­æ·»åŠ   NacosWatch è¿™ä¸ª beanã€‚é¡ºç€ NacosWatch çš„ start æ–¹æ³•ä¸€è·¯å¾€ä¸‹ï¼Œå°±èƒ½çœ‹åˆ°ï¼šNacosWatch#start -&gt;NacosNamingService#subscribe -&gt; HostReactor#subscribe -&gt; HostReactor#addTaskï¼›UpdateTask å°±æ˜¯ä½œä¸º task æ·»åŠ åˆ°å®šæ—¶æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ã€‚<br>","like_count":18,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545084,"discussion_content":"éå¸¸æ£’ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641821873,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329527,"user_name":"soâ€†long","can_delete":false,"product_type":"c1","uid":1449679,"ip_address":"","ucode":"2A6B47BB32FC18","user_header":"https://static001.geekbang.org/account/avatar/00/16/1e/cf/97cd8be1.jpg","comment_is_top":false,"comment_ctime":1641388620,"is_pvip":false,"replies":[{"id":"120024","content":"åŒå­¦æ‘¸ç“œæ°´å¹³è¶Šæ¥è¶Šé«˜äº†ã€‚Nacosåœ¨watchæœºåˆ¶ä¸Šæœ‰äº†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ”¹å˜ï¼Œå¦‚æœæŸ¥çœ‹nacosè€ç‰ˆæœ¬çš„æºç ä½ ä¼šå‘ç°nacosServicesWatchè¿™ä¸ªæ–¹æ³•é‡Œç®€ç›´ä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œä½†æ˜¯æ–°ç‰ˆæœ¬é‡Œï¼ŒnacosServicesWatchåªåšä¸€ä»¶äº‹å°±æ˜¯å‘å¸ƒå¿ƒè·³äº‹ä»¶äº†ï¼Œæ‰€ä»¥è¿™ä¸ªwatchæœºåˆ¶åšäº†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å‡æ³•ï¼Œæ²¡è€ç‰ˆæœ¬é‚£ä¹ˆç‰›é€¼çš„æœåŠ¡å‘ç°äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1641402129,"ip_address":"","comment_id":329527,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10231323212","product_id":100101301,"comment_content":"nacosæœåŠ¡å‘ç°æ­£å‘é¡ºè—¤æ‘¸ç“œï¼šä¸»è¦é NacosWatchå®ç°SmartLifecycleï¼Œåœ¨springå®¹å™¨åˆå§‹åŒ–åå¼€å§‹è¿›è¡ŒæœåŠ¡å‘ç°<br>NacosDiscoveryClientConfiguration-&gt;NacosWatch.start()-&gt;NamingService. subscribe(String serviceName, String groupName, List&lt;String&gt; clusters, EventListener listener)-&gt;HostReactor. subscribe(String serviceName, String clusters, EventListener eventListener)","like_count":1,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544138,"discussion_content":"åŒå­¦æ‘¸ç“œæ°´å¹³è¶Šæ¥è¶Šé«˜äº†ã€‚Nacosåœ¨watchæœºåˆ¶ä¸Šæœ‰äº†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ”¹å˜ï¼Œå¦‚æœæŸ¥çœ‹nacosè€ç‰ˆæœ¬çš„æºç ä½ ä¼šå‘ç°nacosServicesWatchè¿™ä¸ªæ–¹æ³•é‡Œç®€ç›´ä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œä½†æ˜¯æ–°ç‰ˆæœ¬é‡Œï¼ŒnacosServicesWatchåªåšä¸€ä»¶äº‹å°±æ˜¯å‘å¸ƒå¿ƒè·³äº‹ä»¶äº†ï¼Œæ‰€ä»¥è¿™ä¸ªwatchæœºåˆ¶åšäº†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å‡æ³•ï¼Œæ²¡è€ç‰ˆæœ¬é‚£ä¹ˆç‰›é€¼çš„æœåŠ¡å‘ç°äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641402129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329278,"user_name":"Avalon","can_delete":false,"product_type":"c1","uid":1908872,"ip_address":"","ucode":"820523E3C519F0","user_header":"https://static001.geekbang.org/account/avatar/00/1d/20/88/41212eb9.jpg","comment_is_top":false,"comment_ctime":1641265839,"is_pvip":false,"replies":[{"id":"119936","content":"æ³¨å…¥builderçš„ä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„åŸå› æ˜¯ï¼Œä½ åœ¨ä½¿ç”¨webclientçš„æ—¶å€™å°±èƒ½åˆ©ç”¨builderçš„é“¾å¼æ„å»ºé£æ ¼æ¥æ³¨å…¥å‚æ•°ã€‚Monoå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå…ƒç´ çš„å‘å¸ƒè€…ï¼ˆpublisherï¼‰ï¼ŒåƒMonoå’ŒFluxéƒ½æ˜¯å“åº”å¼ç¼–ç¨‹çš„ä¸€ä¸ªæ¦‚å¿µï¼Œmonoè¡¨ç¤ºå‘å¸ƒäº†emptyæˆ–1ä¸ªå¯¹è±¡ï¼ŒåŒå­¦ä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›å“åº”å¼ç¼–ç¨‹çš„æ•™ç¨‹äº†è§£æ›´å¤šçš„åº”ç”¨æ–¹å¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1641295210,"ip_address":"","comment_id":329278,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10231200431","product_id":100101301,"comment_content":"è€å¸ˆï¼Œæˆ‘æœ‰ä¸¤ä¸ªç–‘é—®ï¼š<br>1ã€ä¸ºä»€ä¹ˆä¾èµ–æ³¨å…¥çš„æ˜¯ WebClient.Builderï¼Œè€Œä¸ç›´æ¥æ³¨å…¥ WebClientï¼Ÿ<br>2ã€bodyToMono çš„è¿”å›å€¼ç±»å‹ Monoï¼Œâ€œMonoâ€æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543762,"discussion_content":"æ³¨å…¥builderçš„ä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„åŸå› æ˜¯ï¼Œä½ åœ¨ä½¿ç”¨webclientçš„æ—¶å€™å°±èƒ½åˆ©ç”¨builderçš„é“¾å¼æ„å»ºé£æ ¼æ¥æ³¨å…¥å‚æ•°ã€‚Monoå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå…ƒç´ çš„å‘å¸ƒè€…ï¼ˆpublisherï¼‰ï¼ŒåƒMonoå’ŒFluxéƒ½æ˜¯å“åº”å¼ç¼–ç¨‹çš„ä¸€ä¸ªæ¦‚å¿µï¼Œmonoè¡¨ç¤ºå‘å¸ƒäº†emptyæˆ–1ä¸ªå¯¹è±¡ï¼ŒåŒå­¦ä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›å“åº”å¼ç¼–ç¨‹çš„æ•™ç¨‹äº†è§£æ›´å¤šçš„åº”ç”¨æ–¹å¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641295210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331739,"user_name":"alex_lai","can_delete":false,"product_type":"c1","uid":1903459,"ip_address":"","ucode":"3057F2A593A6DB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/m7fLWyJrnwEPoIefiaxusQRh6D1Nq7PCXA8RiaxkmzdNEmFARr5q8L4qouKNaziceXia92an8hzYa5MLic6N6cNMEoQ/132","comment_is_top":false,"comment_ctime":1642746348,"is_pvip":true,"replies":[{"id":"121287","content":"customer serviceå¯ä»¥è¢«ä»»ä½•å­é¡¹ç›®è°ƒç”¨ï¼Œå¯ä»¥ç”¨k8sä¸­çš„service topoæ¥ç®¡ç†ï¼Œä¸è¿‡å¦‚æœåštopoçš„ç›®çš„å•çº¯ä¸ºäº†å®ç°é›†ç¾¤ä¼˜å…ˆçš„ç­–ç•¥ï¼Œç›´æ¥å®šåˆ¶æœ¬åœ°è´Ÿè½½å‡è¡¡ç­–ç•¥å°±å¥½äº†ï¼Œ nacosçš„clusterå±æ€§ä¼šåœ¨æœåŠ¡å‘ç°çš„è¿‡ç¨‹ä¸­å°è£…åˆ°metadataèŠ‚ç‚¹ï¼Œclientç«¯å¯ä»¥æ ¹æ®è¿™ä¸ªå±æ€§åšroutingå®šåˆ¶<br><br>PPç¡®å®æœ‰å†—é•¿çš„review processï¼ŒæœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ä¹Ÿè¦é€šè¿‡arch reviewï¼Œä½†è¿™æ˜¯ä¸€å®¶æŠ€æœ¯åŸºå»ºå¾ˆå·®åŠ²çš„å…¬å¸ï¼Œè¢«å›½å†…äº’è”ç½‘å¤§å‚å®Œçˆ†çš„æ¸£éƒ½ä¸å‰©ï¼Œæ²¡å•¥å¯å€Ÿé‰´çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1642921713,"ip_address":"","comment_id":331739,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5937713644","product_id":100101301,"comment_content":"æ ¹æ®ç›®å‰é¡¹ç›®é‡Œçš„service discovery setup æ‰€æœ‰åœ¨ä¸€ä¸ªgroupé‡Œçš„serviceéƒ½å¯ä»¥äº’ç›¸è°ƒç”¨? customer service ä¹Ÿå¯ä»¥è¢«å¦å¤–ä¸¤ä¸ªå­é¡¹ç›®è°ƒç”¨ï¼Ÿæ‰€ä»¥nacosæœ‰å¯ä»¥è®¾ç½®service topoçš„ç›¸å…³è®¾ç½®ä¹ˆï¼Ÿ<br>å¤§å‚é‡ŒPPä¹Ÿæ˜¯æœ‰è¿™ä¸ªä¸“é—¨çš„architectå’Œteam å»reviewå’Œç»´æŠ¤å§","like_count":1,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547888,"discussion_content":"customer serviceå¯ä»¥è¢«ä»»ä½•å­é¡¹ç›®è°ƒç”¨ï¼Œå¯ä»¥ç”¨k8sä¸­çš„service topoæ¥ç®¡ç†ï¼Œä¸è¿‡å¦‚æœåštopoçš„ç›®çš„å•çº¯ä¸ºäº†å®ç°é›†ç¾¤ä¼˜å…ˆçš„ç­–ç•¥ï¼Œç›´æ¥å®šåˆ¶æœ¬åœ°è´Ÿè½½å‡è¡¡ç­–ç•¥å°±å¥½äº†ï¼Œ nacosçš„clusterå±æ€§ä¼šåœ¨æœåŠ¡å‘ç°çš„è¿‡ç¨‹ä¸­å°è£…åˆ°metadataèŠ‚ç‚¹ï¼Œclientç«¯å¯ä»¥æ ¹æ®è¿™ä¸ªå±æ€§åšroutingå®šåˆ¶\n\nPPç¡®å®æœ‰å†—é•¿çš„review processï¼ŒæœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ä¹Ÿè¦é€šè¿‡arch reviewï¼Œä½†è¿™æ˜¯ä¸€å®¶æŠ€æœ¯åŸºå»ºå¾ˆå·®åŠ²çš„å…¬å¸ï¼Œè¢«å›½å†…äº’è”ç½‘å¤§å‚å®Œçˆ†çš„æ¸£éƒ½ä¸å‰©ï¼Œæ²¡å•¥å¯å€Ÿé‰´çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642921713,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1903459,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/m7fLWyJrnwEPoIefiaxusQRh6D1Nq7PCXA8RiaxkmzdNEmFARr5q8L4qouKNaziceXia92an8hzYa5MLic6N6cNMEoQ/132","nickname":"alex_lai","note":"","ucode":"3057F2A593A6DB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":547892,"discussion_content":"å¤šè°¢ï¼é›†ç¾¤ä¼˜å…ˆğŸ‘ å­¦ä¹ äº†ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642923638,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547888,"ip_address":""},"score":547892,"extra":""},{"author":{"id":1903459,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/m7fLWyJrnwEPoIefiaxusQRh6D1Nq7PCXA8RiaxkmzdNEmFARr5q8L4qouKNaziceXia92an8hzYa5MLic6N6cNMEoQ/132","nickname":"alex_lai","note":"","ucode":"3057F2A593A6DB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":547893,"discussion_content":"å¦‚æœå¾ˆå¤šdomainç»„å„è‡ªå¼€å‘è‡ªå·±çš„api éœ€è¦è¢«å‘ç° ä»–ä»¬éƒ½å¾—shareåŒä¸€ä¸ªgroupå˜›ï¼Ÿnacoså¯¹è¿™ä¸ªæœ‰æ²¡æœ‰ä¸ªlimitï¼Ÿ\nè¿˜æ˜¯æœ‰å¾ˆå¥½çš„éš”ç¦»ç­–ç•¥ã€‚ èƒ½å¦è·¨groupè°ƒç”¨ä¹‹ç±»çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642924113,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":547888,"ip_address":""},"score":547893,"extra":""}]}]},{"had_liked":false,"id":329174,"user_name":"è¯·å«æˆ‘å’Œå°š","can_delete":false,"product_type":"c1","uid":1703256,"ip_address":"","ucode":"33A8A1CDA103F9","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg","comment_is_top":false,"comment_ctime":1641196622,"is_pvip":false,"replies":[{"id":"119894","content":"Loadbalanceræ³¨è§£æ˜¯spring cloud loadbalancerçš„å†…å®¹ï¼Œåœ¨Nacosè®²å®Œä¹‹åç´§æ¥ç€ä¸€è¯¾é‡Œä¼šè®²åˆ°ã€‚å¦‚æœé¡¹ç›®ç‰ˆæœ¬å’ŒMySQLç‰ˆæœ¬éƒ½ä¿æŒå’Œæºç ä¸€è‡´çš„è¯ï¼ˆåœ¨ç¯å¢ƒå‡†å¤‡ç¯‡é‡Œæœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼‰ï¼Œé‚£ä¹ˆæ–°ç‰ˆé‡Œdatabase-platformä¸ç”¨æ˜¾å¼é…ç½®ï¼Œé»˜è®¤auto-detectåä¼šè‡ªåŠ¨åœ¨æ—¥å¿—é‡Œæ‰“å°è¿™ä¸€è¡Œ<br><br>org.hibernate.dialect.Dialect: HHH000400: Using dialect: org.hibernate.dialect.MySQL8Dialect","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1641203546,"ip_address":"","comment_id":329174,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5936163918","product_id":100101301,"comment_content":"2 ä¸ªé—®é¢˜ï¼š<br>1. é¡¹ç›® customer ä¸Šçš„æ³¨è§£ï¼š@LoadBalancerClient(value = &quot;coupon-template-serv&quot;, configuration = CanaryRuleConfiguration.class)ï¼Œæ²¡æœ‰è¯´æ˜æ˜¯å•¥ä½œç”¨<br>2. è¿è¡Œ customer è¿™ä¸ªé¡¹ç›®çš„æ—¶å€™ä¼šæŠ¥é”™ï¼ŒAccess to DialectResolutionInfo cannot be null when &#39;hibernate.dialect&#39; not setï¼Œ<br>Google è§£å†³æ–¹å¼ï¼šåŠ å…¥spring:jpa:database-platform: org.hibernate.dialect.MySQLDialect","like_count":2,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543558,"discussion_content":"Loadbalanceræ³¨è§£æ˜¯spring cloud loadbalancerçš„å†…å®¹ï¼Œåœ¨Nacosè®²å®Œä¹‹åç´§æ¥ç€ä¸€è¯¾é‡Œä¼šè®²åˆ°ã€‚å¦‚æœé¡¹ç›®ç‰ˆæœ¬å’ŒMySQLç‰ˆæœ¬éƒ½ä¿æŒå’Œæºç ä¸€è‡´çš„è¯ï¼ˆåœ¨ç¯å¢ƒå‡†å¤‡ç¯‡é‡Œæœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼‰ï¼Œé‚£ä¹ˆæ–°ç‰ˆé‡Œdatabase-platformä¸ç”¨æ˜¾å¼é…ç½®ï¼Œé»˜è®¤auto-detectåä¼šè‡ªåŠ¨åœ¨æ—¥å¿—é‡Œæ‰“å°è¿™ä¸€è¡Œ\n\norg.hibernate.dialect.Dialect: HHH000400: Using dialect: org.hibernate.dialect.MySQL8Dialect","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641203546,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334374,"user_name":"å°ç‹@Note","can_delete":false,"product_type":"c1","uid":2089044,"ip_address":"","ucode":"737FE2D0185643","user_header":"https://static001.geekbang.org/account/avatar/00/1f/e0/54/5a7075fc.jpg","comment_is_top":false,"comment_ctime":1644906690,"is_pvip":false,"replies":[{"id":"122266","content":"templateIdsè¿™ä¸ªå‚æ•°æ˜¯æ‹¼è£…å¥½çš„1,2,3æ ¼å¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1645079171,"ip_address":"","comment_id":334374,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1644906690","product_id":100101301,"comment_content":"è€å¸ˆï¼Œä»¥ä¸‹è¿™æ®µä»£ç ä¼¼ä¹æœ‰é—®é¢˜ï¼ˆCouponCustomerServiceImpl -&gt; findCouponï¼‰ï¼š<br>Map&lt;Long, CouponTemplateInfo&gt; templateMap = webClientBuilder.build().get()<br>                .uri(&quot;http:&#47;&#47;coupon-template-serv&#47;template&#47;getBatch?ids=&quot; + templateIds)<br>                .retrieve()<br>                .bodyToMono(new ParameterizedTypeReference&lt;Map&lt;Long, CouponTemplateInfo&gt;&gt;() {})<br>                .block();<br>å¥½åƒä¸èƒ½åœ¨æŸ¥è¯¢å‚æ•°ä¸Šç›´æ¥æ‹¼æ¥ä¸€ä¸ªæ•°ç»„ï¼Œè¦è½¬åŒ–æˆxx=1,2,3...è¿™æ ·çš„å½¢å¼","like_count":1,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551664,"discussion_content":"templateIdsè¿™ä¸ªå‚æ•°æ˜¯æ‹¼è£…å¥½çš„1,2,3æ ¼å¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645079171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332973,"user_name":"Lee KouKuKing","can_delete":false,"product_type":"c1","uid":1339404,"ip_address":"","ucode":"73FC2E525DD2BE","user_header":"https://static001.geekbang.org/account/avatar/00/14/70/0c/53f1d461.jpg","comment_is_top":false,"comment_ctime":1643903162,"is_pvip":false,"replies":[{"id":"121684","content":"ä½¿ç”¨è™šæ‹Ÿæœºæˆ–è€…å¤šç½‘å¡çš„åŒå­¦å¯ä»¥å‚è€ƒä¸Šé¢çš„çš„è§£å†³æ–¹æ¡ˆå“¦","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1643953449,"ip_address":"","comment_id":332973,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1643903162","product_id":100101301,"comment_content":"ã€åˆ†äº«ã€‘nacosçš„â€œè®¢é˜…è€…åˆ—è¡¨â€ä¸­çš„å¤šå—ç½‘å¡åœ°å€é—®é¢˜ï¼Œä»¥åŠåº”ç”¨åä¸ºunknownçš„é—®é¢˜ï¼š<br>customeræœåŠ¡å‘nacosæ³¨å†Œåï¼Œåœ¨nacos webçš„â€œè®¢é˜…è€…åˆ—è¡¨â€èœå•ä¸­ï¼Œå‘ç°è®¢é˜…è€…çš„åœ°å€æ˜¯æˆ‘çš„ç¬¬äºŒå—ç½‘å¡çš„åœ°å€ï¼ˆæˆ‘åœ¨ç¬”è®°æœ¬ä¸Šè£…è¿‡virtualboxï¼Œæœ‰ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ã€‚è¯´æ˜ï¼šæˆ‘æ˜¯åœ¨win10ä¸Šè¿è¡Œäº†3ä¸ªnacosè¿›ç¨‹ç»„æˆçš„é›†ç¾¤ã€‚ï¼‰ï¼Œå¹¶ä¸”åº”ç”¨åæ˜¯ï¼šunknownã€‚è¿™æ ·çœ‹ç€å¾ˆåˆ«æ‰­ï¼Œæˆ‘å°±æƒ³ä¿®æ”¹ä¸€ä¸‹ï¼Œäºæ˜¯åœ¨application.ymlæ·»åŠ äº†spring.cloud.nacos.discovery.ipï¼Œä½†æ˜¯å‘ç°ä¸ç”Ÿæ•ˆã€‚æœ€åé€šè¿‡æºç å‘ç°åœ¨UpdateTaskä¸­è¯·æ±‚æ‰€æœ‰æœåŠ¡å™¨åˆ—è¡¨æ—¶ï¼š&#47;instance&#47;listï¼Œè¯·æ±‚çš„clientIPæ˜¯è¿™æ ·è·å–çš„ï¼š<br>String ip = System.getProperty(&quot;com.alibaba.nacos.client.naming.local.ip&quot;,InetAddress.getLocalHost().getHostAddress()); <br>ä½¿ç”¨System.getPropertyè·å–ç³»ç»Ÿå˜é‡ï¼Œè€Œä¸æ˜¯ä»application.ymlä¸­è·å–ï¼Œå¦‚è¿‡è·å–ä¸åˆ°å°±æŸ¥æ‰¾æœ¬æœºçš„ç½‘å¡ï¼Œç”±äºæœ¬æœºæœ‰ä¸¤å—ç½‘å¡ï¼Œæ‰€æœ‰å°±é€‰ä¸­äº†é‚£å—è™šæ‹Ÿç½‘å¡çš„ipäº†ã€‚<br>åŒæ—¶&#47;instance&#47;listè¯·æ±‚çš„appå‚æ•°ä¹Ÿæ˜¯System.getProperty(&quot;project.name&quot;);è¿™æ ·è·å–çš„ï¼Œç”±äºæ²¡æœ‰è·å–åˆ°&quot;project.name&quot;ï¼Œæ‰€ä»¥å°±é»˜è®¤åº”ç”¨åæ˜¯ï¼šunknownï¼Œç„¶åæˆ‘å°±åœ¨javaå¯åŠ¨æœåŠ¡åŠ äº†è¿™ä¿©å‚æ•°è¿›è¡Œè§£å†³çš„ã€‚<br>ä¸åªä¸ºä»€ä¹ˆè¿™ä¿©å‚æ•°ä¸åœ¨application.ymlä¸­é…ç½®å‘¢ï¼Ÿè¿™ä¿©å‚æ•°åœ¨application.ymlä¸­é…ç½®è¿™æ ·å¤šæ–¹ä¾¿å‘€ã€‚<br>\t\t\t\t<br><br>java -D&quot;com.alibaba.nacos.client.naming.local.ip&quot;=&quot;192.168.18.8&quot; -D&quot;project.name&quot;=&quot;customer&quot; -jar coupon-customer-impl-1.0-SNAPSHOT.jar","like_count":1,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549409,"discussion_content":"ä½¿ç”¨è™šæ‹Ÿæœºæˆ–è€…å¤šç½‘å¡çš„åŒå­¦å¯ä»¥å‚è€ƒä¸Šé¢çš„çš„è§£å†³æ–¹æ¡ˆå“¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643953449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329299,"user_name":"è¢«åœ£å…‰ç…§é»‘äº†","can_delete":false,"product_type":"c1","uid":1400926,"ip_address":"","ucode":"60B4F4F67700E1","user_header":"https://static001.geekbang.org/account/avatar/00/15/60/5e/b9624166.jpg","comment_is_top":false,"comment_ctime":1641277524,"is_pvip":false,"replies":[{"id":"119933","content":"warningæç¤ºä¸ä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥ï¼Œå¦‚æœæœ‰Errorä¿¡æ¯åŒå­¦å¯ä»¥æŠŠlogæ‰“å°å‡ºæ¥ã€‚æ²¡æœ‰æ³¨å†Œåˆ°naocsçš„è¯ï¼Œä¹Ÿè¦çœ‹ä¸€ä¸‹æ—¥å¿—é‡Œæ˜¯å¦æ‰“å°äº†æ³¨å†Œå¤±è´¥çš„ä¿¡æ¯ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹æœåŠ¡æ˜¯æ³¨å†Œåœ¨äº†devè¿™ä¸ªnamespaceä¸‹ï¼Œä¸æ˜¯é»˜è®¤çš„public namespace","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1641294737,"ip_address":"","comment_id":329299,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1641277524","product_id":100101301,"comment_content":"å¯åŠ¨æŠ¥é”™äº†ï¼šSpring Cloud LoadBalancer is currently working with the default cache. You can switch to using Caffeine cache, by adding it and org.springframework.cache.caffeine.CaffeineCacheManager to the classpath.çš„è­¦å‘Šã€‚coupon-customer-servæ²¡æœ‰æ³¨å†Œåˆ°nacosé‡Œã€‚ç™¾åº¦äº†è¯´å¼•å…¥Caffeineä¾èµ–å°±å¥½ï¼Œä½†è¿˜æ˜¯ä¸è¡Œ","like_count":0,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543757,"discussion_content":"warningæç¤ºä¸ä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥ï¼Œå¦‚æœæœ‰Errorä¿¡æ¯åŒå­¦å¯ä»¥æŠŠlogæ‰“å°å‡ºæ¥ã€‚æ²¡æœ‰æ³¨å†Œåˆ°naocsçš„è¯ï¼Œä¹Ÿè¦çœ‹ä¸€ä¸‹æ—¥å¿—é‡Œæ˜¯å¦æ‰“å°äº†æ³¨å†Œå¤±è´¥çš„ä¿¡æ¯ã€‚è¿™é‡Œè¦æ³¨æ„ä¸‹æœåŠ¡æ˜¯æ³¨å†Œåœ¨äº†devè¿™ä¸ªnamespaceä¸‹ï¼Œä¸æ˜¯é»˜è®¤çš„public namespace","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641294737,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1400926,"avatar":"https://static001.geekbang.org/account/avatar/00/15/60/5e/b9624166.jpg","nickname":"è¢«åœ£å…‰ç…§é»‘äº†","note":"","ucode":"60B4F4F67700E1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543887,"discussion_content":"åŸæ¥æ˜¯register-enabled: trueæˆ‘æ”¹æˆfalseäº†ï¼ŒæŠŠcustomerå½“æˆæ¶ˆè´¹æœåŠ¡äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641347866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329266,"user_name":"kimoti","can_delete":false,"product_type":"c1","uid":1897671,"ip_address":"","ucode":"0A78077408C2B1","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f4/c7/037235c9.jpg","comment_is_top":false,"comment_ctime":1641262585,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641262585","product_id":100101301,"comment_content":"å¿ƒè·³æ£€æµ‹æœºåˆ¶","like_count":0},{"had_liked":false,"id":329264,"user_name":"Geek_e93c48","can_delete":false,"product_type":"c1","uid":2878664,"ip_address":"","ucode":"4418236B0BF4DE","user_header":"","comment_is_top":false,"comment_ctime":1641262352,"is_pvip":false,"replies":[{"id":"119938","content":"åŒå­¦æ‘¸åˆ°äº†ä¸€ä¸ªå¤§ç“œï¼éå¸¸ä¸é”™ï¼Œè¯»æºç å°±è¿™ä¹ˆé¡ºè—¤æ‘¸ç“œï¼Œä»å¯åŠ¨å…¥å£æ­£ç€æ‘¸ï¼Œä»ç»“æœå¤„åç€æ‘¸ï¼Œåæ­£ä¸€é€šåå…«Moä¹‹åå°±éƒ½æ•´æ˜ç™½äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1641295966,"ip_address":"","comment_id":329264,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641262352","product_id":100101301,"comment_content":"è€å¸ˆï¼Œæˆ‘å‘ç°UpdateTaské€šè¿‡å½“å‰ç±»addTask()æ–¹æ³•è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼Œé¡ºç€è—¤è”“ä¸€ç›´æ‘¸ä¸Šå»ï¼šaddTask()-&gt;scheduleUpdateIfAbsent()-&gt;NamingClientProxyDelegate.subscribe()-&gt;NacosNamingService.getAllInstances()-&gt;NamingFactory-&gt;Appå¯åŠ¨ç±»åŠ è½½æ—¶è°ƒç”¨ã€‚","like_count":1,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543769,"discussion_content":"åŒå­¦æ‘¸åˆ°äº†ä¸€ä¸ªå¤§ç“œï¼éå¸¸ä¸é”™ï¼Œè¯»æºç å°±è¿™ä¹ˆé¡ºè—¤æ‘¸ç“œï¼Œä»å¯åŠ¨å…¥å£æ­£ç€æ‘¸ï¼Œä»ç»“æœå¤„åç€æ‘¸ï¼Œåæ­£ä¸€é€šåå…«Moä¹‹åå°±éƒ½æ•´æ˜ç™½äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641295967,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329263,"user_name":"Geek_e93c48","can_delete":false,"product_type":"c1","uid":2878664,"ip_address":"","ucode":"4418236B0BF4DE","user_header":"","comment_is_top":false,"comment_ctime":1641262200,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641262200","product_id":100101301,"comment_content":"UpdateTaské€šè¿‡å½“å‰ç±»addTask()æ–¹æ³•è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼Œé¡ºç€è—¤è”“ä¸€ç›´æ‘¸ä¸Šå»ï¼šaddTask()-&gt;scheduleUpdateIfAbsent()-&gt;NamingClientProxyDelegate.subscribe()-&gt;NacosNamingService.getAllInstances()-&gt;NamingFactory-&gt;Appå¯åŠ¨ç±»åŠ è½½æ—¶è°ƒç”¨ã€‚","like_count":0},{"had_liked":false,"id":329185,"user_name":"è¯·å«æˆ‘å’Œå°š","can_delete":false,"product_type":"c1","uid":1703256,"ip_address":"","ucode":"33A8A1CDA103F9","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg","comment_is_top":false,"comment_ctime":1641198853,"is_pvip":false,"replies":[{"id":"119895","content":"åŒå­¦çœ‹çš„å¾ˆä»”ç»†ï¼Œç¡®å®æ˜¯ä¸ªç¬”è¯¯","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"2819998","ctime":1641203566,"ip_address":"","comment_id":329185,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641198853","product_id":100101301,"comment_content":"å†åŠ ä¸€ä¸ªé—®é¢˜ï¼Œç±»UpdateTaskæ˜¯åœ¨HostReactorä¸­ï¼Œæ–‡ä¸­åº”è¯¥å†™é”™äº†ä¸æ˜¯åœ¨HostReactiveä¸­","like_count":0,"discussions":[{"author":{"id":2819998,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/07/9e/d2de2832.jpg","nickname":"å§šåŠä»™","note":"","ucode":"4C86AA5D6D8C39","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543559,"discussion_content":"åŒå­¦çœ‹çš„å¾ˆä»”ç»†ï¼Œç¡®å®æ˜¯ä¸ªç¬”è¯¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641203566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}