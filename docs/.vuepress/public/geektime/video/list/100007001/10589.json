{"id":10589,"title":"61 | 基于网关的两层路由体系","content":"无","comments":[{"had_liked":false,"id":165158,"user_name":"西瓜","can_delete":false,"product_type":"c3","uid":1170357,"ip_address":"","ucode":"0BF52C6A12319F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/qZOG7AGDuHnVARVh7l8VzdFlslz34Qa3X9V2yH9E6MFpsYoFQx7cicoMhVo6SUpL8nE2DHFMia8EoKicalYhXC1gQ/132","comment_is_top":false,"comment_ctime":1577173380,"is_pvip":false,"replies":[{"id":63273,"content":"第一层网关就是外部流量进入企业内部微服务的一个入口。该层网关的主要作用是反向路由，安全，限流&#47;熔断，和日志监控等。常见可以用zuul做第一层网关，前置nginx对zuul做负载均衡。\n\n企业内部的第二层网络是可选的，很多企业没有内部第二层网关，直接用基于注册中心配合客户端软负载，比如用dubbo + zk，或者spring + eureka方式。\n\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1577357486,"ip_address":"","comment_id":165158,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"不太理解第一层网关的用处?能麻烦老师详细解答下吗?","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479054,"discussion_content":"第一层网关就是外部流量进入企业内部微服务的一个入口。该层网关的主要作用是反向路由，安全，限流/熔断，和日志监控等。常见可以用zuul做第一层网关，前置nginx对zuul做负载均衡。\n\n企业内部的第二层网络是可选的，很多企业没有内部第二层网关，直接用基于注册中心配合客户端软负载，比如用dubbo + zk，或者spring + eureka方式。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577357486,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":192783,"user_name":"Jason","can_delete":false,"product_type":"c3","uid":1085947,"ip_address":"","ucode":"6EECC0C25A9FCC","user_header":"https://static001.geekbang.org/account/avatar/00/10/91/fb/9b9d22a0.jpg","comment_is_top":false,"comment_ctime":1584872784,"is_pvip":false,"replies":[{"id":74027,"content":"对于对外暴露的服务，可通过https加密，有些涉及用户敏感数据的，需提供访问令牌(token)才可以访问。\n\n另外，企业内部的基础服务一般不直接对外暴露，而是通过聚合层(或称BFF层)对外暴露，在聚合层也可以做一些安全控制。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585057313,"ip_address":"","comment_id":192783,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"内部微服务会通过公网对外暴露么？安全性怎么保证的呢？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488460,"discussion_content":"对于对外暴露的服务，可通过https加密，有些涉及用户敏感数据的，需提供访问令牌(token)才可以访问。\n\n另外，企业内部的基础服务一般不直接对外暴露，而是通过聚合层(或称BFF层)对外暴露，在聚合层也可以做一些安全控制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585057313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":91002,"user_name":"superFan","can_delete":false,"product_type":"c3","uid":1103116,"ip_address":"","ucode":"AA0FFEF391488D","user_header":"https://static001.geekbang.org/account/avatar/00/10/d5/0c/8dd1791d.jpg","comment_is_top":false,"comment_ctime":1556781288,"is_pvip":false,"replies":[{"id":32730,"content":"你好，nginx成熟稳定性能高，但是因为历史比较悠久，所以历史包袱也重，比较偏向传统运维，对DevOps和开发人员不友好（或者说门槛比较高）；kong可以认为是针对nginx的不足，专门针对现代微服务场景，在nginx&#47;openresty内核的基础上升级改造而来，在DevOps开发友好性方面有很大改进。\n\n如果企业现有nginx运行稳定，没有特别的DevOps开发定制需求(微服务网关，动态路由，灰度发布，灵活安全，细粒度监控等)，那么并不需要升级kong；如果有DevOps需求，则可以考虑尝试升级Kong，当然直接扩展nginx也可以，不过门槛较高。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1557062665,"ip_address":"","comment_id":91002,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"内网演进, nginx--&gt;zuul--&gt;kong,老师也说了kong本质上就是nginx,所以内网使用kong替换nginx的原因是什么?麻烦老师指导下;","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":448760,"discussion_content":"你好，nginx成熟稳定性能高，但是因为历史比较悠久，所以历史包袱也重，比较偏向传统运维，对DevOps和开发人员不友好（或者说门槛比较高）；kong可以认为是针对nginx的不足，专门针对现代微服务场景，在nginx/openresty内核的基础上升级改造而来，在DevOps开发友好性方面有很大改进。\n\n如果企业现有nginx运行稳定，没有特别的DevOps开发定制需求(微服务网关，动态路由，灰度发布，灵活安全，细粒度监控等)，那么并不需要升级kong；如果有DevOps需求，则可以考虑尝试升级Kong，当然直接扩展nginx也可以，不过门槛较高。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1557062665,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":76350,"user_name":"大象","can_delete":false,"product_type":"c3","uid":1001866,"ip_address":"","ucode":"856D1E9F24EA4F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/8a/3f5af969.jpg","comment_is_top":false,"comment_ctime":1552574861,"is_pvip":false,"replies":[{"id":28178,"content":"不管内部还是外部网关，主要作用是：反向路由，安全，限流熔断，监控日志等。作为对外入口，外部网关对安全有更高的要求，一般令牌校验&#47;验签和防刷等职能都在外部网关上实现。内部+外部两层网关是一种架构风格，内部使用网关强调治理，规范内部调用必须通过内部网关，这样可以集中治理(安全，限流，监控，依赖关系等)，不利一面是性能损耗和可用性风险。有些企业内部不使用网关，而是采用客户端直连调用服务，例如阿里dubbo，这种方式性能会好，但是集中治理较难实现。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1552913901,"ip_address":"","comment_id":76350,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"外网关的主要作用是什么？内网关的主要作用是什么？鉴权，限流，熔断，日志监控等功能哪些要放在内网关？哪些要放在外网关？ 谢谢","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443270,"discussion_content":"不管内部还是外部网关，主要作用是：反向路由，安全，限流熔断，监控日志等。作为对外入口，外部网关对安全有更高的要求，一般令牌校验/验签和防刷等职能都在外部网关上实现。内部+外部两层网关是一种架构风格，内部使用网关强调治理，规范内部调用必须通过内部网关，这样可以集中治理(安全，限流，监控，依赖关系等)，不利一面是性能损耗和可用性风险。有些企业内部不使用网关，而是采用客户端直连调用服务，例如阿里dubbo，这种方式性能会好，但是集中治理较难实现。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552913901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":27976,"user_name":"bxov","can_delete":false,"product_type":"c3","uid":1132779,"ip_address":"","ucode":"CE9F1DBE3BA4F4","user_header":"https://static001.geekbang.org/account/avatar/00/11/48/eb/91b0b5f4.jpg","comment_is_top":false,"comment_ctime":1537972545,"is_pvip":false,"replies":[{"id":10672,"content":"外层网关高可用，可以用nginx做负载，也可以硬件如F5，也可F5+nginx两级负载。内网也可以有网关，相当于内外两层网关，也是一种架构风格。内网也可以不用网关，直接走客户端软负载，feign+ribbon+eureka是一种常见做法。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1538480026,"ip_address":"","comment_id":27976,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"外层网关怎么实现高可用，是nginx做负载吗？内层网关只有异构系统调用才会用到吧！如果是java服务之间调用fegin就不通过网关了吧","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425103,"discussion_content":"外层网关高可用，可以用nginx做负载，也可以硬件如F5，也可F5+nginx两级负载。内网也可以有网关，相当于内外两层网关，也是一种架构风格。内网也可以不用网关，直接走客户端软负载，feign+ribbon+eureka是一种常见做法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1538480026,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":15377,"user_name":"青青子衿","can_delete":false,"product_type":"c3","uid":1044644,"ip_address":"","ucode":"68619E7F238BFE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f0/a4/699f807f.jpg","comment_is_top":false,"comment_ctime":1531148242,"is_pvip":false,"replies":[{"id":5321,"content":"视情况，可以只用一层网关，也有很多企业使用内外两层网关架构，内部可用性能更好的nginx或kong等做网关，这种两层网关架构更强调内部现有基础设施兼容性和安全治理灵活性","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1531324833,"ip_address":"","comment_id":15377,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"为什么要用两层网关呢？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420359,"discussion_content":"视情况，可以只用一层网关，也有很多企业使用内外两层网关架构，内部可用性能更好的nginx或kong等做网关，这种两层网关架构更强调内部现有基础设施兼容性和安全治理灵活性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1531324833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109032,"user_name":"又双叒叕是一年啊","can_delete":false,"product_type":"c3","uid":1000015,"ip_address":"","ucode":"E067320E537DEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","comment_is_top":false,"comment_ctime":1561951020,"is_pvip":false,"replies":[{"id":39538,"content":"外层可以直接用nginx&#47;kong，性能应该会更好，但是由于历史原因，外层已经用zuul了，而且也很稳定，如果迁移的话有成本，而且可能会需要踩坑，所以暂时没必要做迁移。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1561982824,"ip_address":"","comment_id":109032,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师，zuul既然没有kong性能好，为什么外层不直接 采用 nginx和kong？内网网关还是用kong结合Eureka的方式进行处理呢？ ","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456220,"discussion_content":"外层可以直接用nginx/kong，性能应该会更好，但是由于历史原因，外层已经用zuul了，而且也很稳定，如果迁移的话有成本，而且可能会需要踩坑，所以暂时没必要做迁移。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561982824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":18493,"user_name":"Alex","can_delete":false,"product_type":"c3","uid":1024763,"ip_address":"","ucode":"F6B5C64BC99FB7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a2/fb/94af9cf1.jpg","comment_is_top":false,"comment_ctime":1533370993,"is_pvip":false,"replies":[{"id":6618,"content":"限流主要使用hystrix组件实现，第5模块会专门剖析讲。灰度发布请参考我的微信文章现代发布技术https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;kQQQQqxAHVglfBVf2NGD4w，灰度一般企业要定制，要和服务注册中心、发布系统等配合，实现较复杂。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1533694708,"ip_address":"","comment_id":18493,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"能不能讲讲生产中网关的限流和灰度具体实现，这块比较有用。","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":421553,"discussion_content":"限流主要使用hystrix组件实现，第5模块会专门剖析讲。灰度发布请参考我的微信文章现代发布技术https://mp.weixin.qq.com/s/kQQQQqxAHVglfBVf2NGD4w，灰度一般企业要定制，要和服务注册中心、发布系统等配合，实现较复杂。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1533694708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":18492,"user_name":"Alex","can_delete":false,"product_type":"c3","uid":1024763,"ip_address":"","ucode":"F6B5C64BC99FB7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a2/fb/94af9cf1.jpg","comment_is_top":false,"comment_ctime":1533370819,"is_pvip":false,"replies":[{"id":6619,"content":"外网nginx+内网kong是可以的，这样路由逻辑要做在nginx上，要掌握nginx+lua做成动态更新门槛较高，使用+zuul（java）门槛低一些，灵活性好，当然会有些性能损失，但要看规模和量，一般问题不大，而且zuul无状态水平可扩。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1533695073,"ip_address":"","comment_id":18492,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"这种模式下请求还是会经过外网zuul性能不是一样影响。为啥不用外nignx+内kong","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":421552,"discussion_content":"外网nginx+内网kong是可以的，这样路由逻辑要做在nginx上，要掌握nginx+lua做成动态更新门槛较高，使用+zuul（java）门槛低一些，灵活性好，当然会有些性能损失，但要看规模和量，一般问题不大，而且zuul无状态水平可扩。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1533695073,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}