{"id":67775,"title":"35 | 解读Kubernetes三层网络方案","content":"<p>你好，我是张磊。今天我和你分享的主题是：解读Kubernetes三层网络方案。</p><p>在上一篇文章中，我以网桥类型的Flannel插件为例，为你讲解了Kubernetes里容器网络和CNI插件的主要工作原理。不过，除了这种模式之外，还有一种纯三层（Pure Layer 3）网络方案非常值得你注意。其中的典型例子，莫过于Flannel的host-gw模式和Calico项目了。</p><p><span class=\"orange\">我们先来看一下Flannel的host-gw模式。</span></p><p>它的工作原理非常简单，我用一张图就可以和你说清楚。为了方便叙述，接下来我会称这张图为“host-gw示意图”。</p><p><img src=\"https://static001.geekbang.org/resource/image/3d/25/3d8b08411eeb49be2658eb4352206d25.png?wh=2880*1528\" alt=\"\" title=\"图1 Flannel host-gw示意图\"></p><p>假设现在，Node 1上的Infra-container-1，要访问Node 2上的Infra-container-2。</p><p>当你设置Flannel使用host-gw模式之后，flanneld会在宿主机上创建这样一条规则，以Node 1为例：</p><pre><code>$ ip route\n...\n10.244.1.0/24 via 10.168.0.3 dev eth0\n</code></pre><p>这条路由规则的含义是：目的IP地址属于10.244.1.0/24网段的IP包，应该经过本机的eth0设备发出去（即：dev eth0）；并且，它下一跳地址（next-hop）是10.168.0.3（即：via 10.168.0.3）。</p><!-- [[[read_end]]] --><p>所谓下一跳地址就是：如果IP包从主机A发到主机B，需要经过路由设备X的中转。那么X的IP地址就应该配置为主机A的下一跳地址。</p><p>而从host-gw示意图中我们可以看到，这个下一跳地址对应的，正是我们的目的宿主机Node 2。</p><p>一旦配置了下一跳地址，那么接下来，当IP包从网络层进入链路层封装成帧的时候，eth0设备就会使用下一跳地址对应的MAC地址，作为该数据帧的目的MAC地址。显然，这个MAC地址，正是Node 2的MAC地址。</p><p>这样，这个数据帧就会从Node 1通过宿主机的二层网络顺利到达Node 2上。</p><p>而Node 2的内核网络栈从二层数据帧里拿到IP包后，会“看到”这个IP包的目的IP地址是10.244.1.3，即Infra-container-2的IP地址。这时候，根据Node 2上的路由表，该目的地址会匹配到第二条路由规则（也就是10.244.1.0对应的路由规则），从而进入cni0网桥，进而进入到Infra-container-2当中。</p><p>可以看到，<strong>host-gw模式的工作原理，其实就是将每个Flannel子网（Flannel Subnet，比如：10.244.1.0/24）的“下一跳”，设置成了该子网对应的宿主机的IP地址。</strong></p><p>也就是说，这台“主机”（Host）会充当这条容器通信路径里的“网关”（Gateway）。这也正是“host-gw”的含义。</p><p>当然，Flannel子网和主机的信息，都是保存在Etcd当中的。flanneld只需要WACTH这些数据的变化，然后实时更新路由表即可。</p><blockquote>\n<p>注意：在Kubernetes v1.7之后，类似Flannel、Calico的CNI网络插件都是可以直接连接Kubernetes的APIServer来访问Etcd的，无需额外部署Etcd给它们使用。</p>\n</blockquote><p>而在这种模式下，容器通信的过程就免除了额外的封包和解包带来的性能损耗。根据实际的测试，host-gw的性能损失大约在10%左右，而其他所有基于VXLAN“隧道”机制的网络方案，性能损失都在20%~30%左右。</p><p>当然，通过上面的叙述，你也应该看到，host-gw模式能够正常工作的核心，就在于IP包在封装成帧发送出去的时候，会使用路由表里的“下一跳”来设置目的MAC地址。这样，它就会经过二层网络到达目的宿主机。</p><p><strong>所以说，Flannel host-gw模式必须要求集群宿主机之间是二层连通的。</strong></p><p>需要注意的是，宿主机之间二层不连通的情况也是广泛存在的。比如，宿主机分布在了不同的子网（VLAN）里。但是，在一个Kubernetes集群里，宿主机之间必须可以通过IP地址进行通信，也就是说至少是三层可达的。否则的话，你的集群将不满足上一篇文章中提到的宿主机之间IP互通的假设（Kubernetes网络模型）。当然，“三层可达”也可以通过为几个子网设置三层转发来实现。</p><p><span class=\"orange\">而在容器生态中，要说到像Flannel host-gw这样的三层网络方案，我们就不得不提到这个领域里的“龙头老大”Calico项目了。</span></p><p>实际上，Calico项目提供的网络解决方案，与Flannel的host-gw模式，几乎是完全一样的。也就是说，Calico也会在每台宿主机上，添加一个格式如下所示的路由规则：</p><pre><code>&lt;目的容器IP地址段&gt; via &lt;网关的IP地址&gt; dev eth0\n</code></pre><p>其中，网关的IP地址，正是目的容器所在宿主机的IP地址。</p><p>而正如前所述，这个三层网络方案得以正常工作的核心，是为每个容器的IP地址，找到它所对应的、“下一跳”的<strong>网关</strong>。</p><p>不过，<strong>不同于Flannel通过Etcd和宿主机上的flanneld来维护路由信息的做法，Calico项目使用了一个“重型武器”来自动地在整个集群中分发路由信息。</strong></p><p>这个“重型武器”，就是BGP。</p><p><strong>BGP的全称是Border Gateway Protocol，即：边界网关协议</strong>。它是一个Linux内核原生就支持的、专门用在大规模数据中心里维护不同的“自治系统”之间路由信息的、无中心的路由协议。</p><p>这个概念可能听起来有点儿“吓人”，但实际上，我可以用一个非常简单的例子来为你讲清楚。</p><p><img src=\"https://static001.geekbang.org/resource/image/2e/9b/2e4b3bee1d924f4ae25e2c1fd115379b.jpg?wh=1738*893\" alt=\"\" title=\"图2 自治系统\"></p><p></p><p>在这个图中，我们有两个自治系统（Autonomous System，简称为AS）：AS 1和AS 2。而所谓的一个自治系统，指的是一个组织管辖下的所有IP网络和路由器的全体。你可以把它想象成一个小公司里的所有主机和路由器。在正常情况下，自治系统之间不会有任何“来往”。</p><p>但是，如果这样两个自治系统里的主机，要通过IP地址直接进行通信，我们就必须使用路由器把这两个自治系统连接起来。</p><p>比如，AS 1里面的主机10.10.0.2，要访问AS 2里面的主机172.17.0.3的话。它发出的IP包，就会先到达自治系统AS 1上的路由器 Router 1。</p><p>而在此时，Router 1的路由表里，有这样一条规则，即：目的地址是172.17.0.2包，应该经过Router 1的C接口，发往网关Router 2（即：自治系统AS 2上的路由器）。</p><p>所以IP包就会到达Router 2上，然后经过Router 2的路由表，从B接口出来到达目的主机172.17.0.3。</p><p>但是反过来，如果主机172.17.0.3要访问10.10.0.2，那么这个IP包，在到达Router 2之后，就不知道该去哪儿了。因为在Router 2的路由表里，并没有关于AS 1自治系统的任何路由规则。</p><p>所以这时候，网络管理员就应该给Router 2也添加一条路由规则，比如：目标地址是10.10.0.2的IP包，应该经过Router 2的C接口，发往网关Router 1。</p><p>像上面这样负责把自治系统连接在一起的路由器，我们就把它形象地称为：<strong>边界网关</strong>。它跟普通路由器的不同之处在于，它的路由表里拥有其他自治系统里的主机路由信息。</p><p>上面的这部分原理，相信你理解起来应该很容易。毕竟，路由器这个设备本身的主要作用，就是连通不同的网络。</p><p>但是，你可以想象一下，假设我们现在的网络拓扑结构非常复杂，每个自治系统都有成千上万个主机、无数个路由器，甚至是由多个公司、多个网络提供商、多个自治系统组成的复合自治系统呢？</p><p>这时候，如果还要依靠人工来对边界网关的路由表进行配置和维护，那是绝对不现实的。</p><p>而这种情况下，BGP大显身手的时刻就到了。</p><p>在使用了BGP之后，你可以认为，在每个边界网关上都会运行着一个小程序，它们会将各自的路由表信息，通过TCP传输给其他的边界网关。而其他边界网关上的这个小程序，则会对收到的这些数据进行分析，然后将需要的信息添加到自己的路由表里。</p><p>这样，图2中Router 2的路由表里，就会自动出现10.10.0.2和10.10.0.3对应的路由规则了。</p><p>所以说，<strong>所谓BGP，就是在大规模网络中实现节点路由信息共享的一种协议。</strong></p><p>而BGP的这个能力，正好可以取代Flannel维护主机上路由表的功能。而且，BGP这种原生就是为大规模网络环境而实现的协议，其可靠性和可扩展性，远非Flannel自己的方案可比。</p><blockquote>\n<p>需要注意的是，BGP协议实际上是最复杂的一种路由协议。我在这里的讲述和所举的例子，仅是为了能够帮助你建立对BGP的感性认识，并不代表BGP真正的实现方式。</p>\n</blockquote><p>接下来，我们还是回到Calico项目上来。</p><p>在了解了BGP之后，Calico项目的架构就非常容易理解了。它由三个部分组成：</p><ol>\n<li>\n<p>Calico的CNI插件。这是Calico与Kubernetes对接的部分。我已经在上一篇文章中，和你详细分享了CNI插件的工作原理，这里就不再赘述了。</p>\n</li>\n<li>\n<p>Felix。它是一个DaemonSet，负责在宿主机上插入路由规则（即：写入Linux内核的FIB转发信息库），以及维护Calico所需的网络设备等工作。</p>\n</li>\n<li>\n<p>BIRD。它就是BGP的客户端，专门负责在集群里分发路由规则信息。</p>\n</li>\n</ol><p><strong>除了对路由信息的维护方式之外，Calico项目与Flannel的host-gw模式的另一个不同之处，就是它不会在宿主机上创建任何网桥设备</strong>。这时候，Calico的工作方式，可以用一幅示意图来描述，如下所示（在接下来的讲述中，我会统一用“BGP示意图”来指代它）：</p><p><img src=\"https://static001.geekbang.org/resource/image/8d/1b/8db6dee96c4242738ae2878e58cecd1b.jpg?wh=1560*836\" alt=\"\" title=\"图3 Calico工作原理\"></p><p>其中的绿色实线标出的路径，就是一个IP包从Node 1上的Container 1，到达Node 2上的Container 4的完整路径。</p><p>可以看到，Calico的CNI插件会为每个容器设置一个Veth Pair设备，然后把其中的一端放置在宿主机上（它的名字以cali前缀开头）。</p><p>此外，由于Calico没有使用CNI的网桥模式，Calico的CNI插件还需要在宿主机上为每个容器的Veth Pair设备配置一条路由规则，用于接收传入的IP包。比如，宿主机Node 2上的Container 4对应的路由规则，如下所示：</p><pre><code>10.233.2.3 dev cali5863f3 scope link\n</code></pre><p>即：发往10.233.2.3的IP包，应该进入cali5863f3设备。</p><blockquote>\n<p>基于上述原因，Calico项目在宿主机上设置的路由规则，肯定要比Flannel项目多得多。不过，Flannel host-gw模式使用CNI网桥的主要原因，其实是为了跟VXLAN模式保持一致。否则的话，Flannel就需要维护两套CNI插件了。</p>\n</blockquote><p>有了这样的Veth Pair设备之后，容器发出的IP包就会经过Veth Pair设备出现在宿主机上。然后，宿主机网络栈就会根据路由规则的下一跳IP地址，把它们转发给正确的网关。接下来的流程就跟Flannel host-gw模式完全一致了。</p><p>其中，这里最核心的“下一跳”路由规则，就是由Calico的Felix进程负责维护的。这些路由规则信息，则是通过BGP Client也就是BIRD组件，使用BGP协议传输而来的。</p><p>而这些通过BGP协议传输的消息，你可以简单地理解为如下格式：</p><pre><code>[BGP消息]\n我是宿主机192.168.1.3\n10.233.2.0/24网段的容器都在我这里\n这些容器的下一跳地址是我\n</code></pre><p>不难发现，Calico项目实际上将集群里的所有节点，都当作是边界路由器来处理，它们一起组成了一个全连通的网络，互相之间通过BGP协议交换路由规则。这些节点，我们称为BGP Peer。</p><p>需要注意的是，<strong>Calico维护的网络在默认配置下，是一个被称为“Node-to-Node Mesh”的模式</strong>。这时候，每台宿主机上的BGP Client都需要跟其他所有节点的BGP Client进行通信以便交换路由信息。但是，随着节点数量N的增加，这些连接的数量就会以N²的规模快速增长，从而给集群本身的网络带来巨大的压力。</p><p>所以，Node-to-Node Mesh模式一般推荐用在少于100个节点的集群里。而在更大规模的集群中，你需要用到的是一个叫作Route Reflector的模式。</p><p>在这种模式下，Calico会指定一个或者几个专门的节点，来负责跟所有节点建立BGP连接从而学习到全局的路由规则。而其他节点，只需要跟这几个专门的节点交换路由信息，就可以获得整个集群的路由规则信息了。</p><p>这些专门的节点，就是所谓的Route Reflector节点，它们实际上扮演了“中间代理”的角色，从而把BGP连接的规模控制在N的数量级上。</p><p>此外，我在前面提到过，Flannel host-gw模式最主要的限制，就是要求集群宿主机之间是二层连通的。而这个限制对于Calico来说，也同样存在。</p><p>举个例子，假如我们有两台处于不同子网的宿主机Node 1和Node 2，对应的IP地址分别是192.168.1.2和192.168.2.2。需要注意的是，这两台机器通过路由器实现了三层转发，所以这两个IP地址之间是可以相互通信的。</p><p>而我们现在的需求，还是Container 1要访问Container 4。</p><p>按照我们前面的讲述，Calico会尝试在Node 1上添加如下所示的一条路由规则：</p><pre><code>10.233.2.0/16 via 192.168.2.2 eth0\n</code></pre><p>但是，这时候问题就来了。</p><p>上面这条规则里的下一跳地址是192.168.2.2，可是它对应的Node 2跟Node 1却根本不在一个子网里，没办法通过二层网络把IP包发送到下一跳地址。</p><p><strong>在这种情况下，你就需要为Calico打开IPIP模式。</strong></p><p>我把这个模式下容器通信的原理，总结成了一张图片，如下所示（接下来我会称之为：IPIP示意图）：</p><p><img src=\"https://static001.geekbang.org/resource/image/4d/c9/4dd9ad6415caf68da81562d9542049c9.jpg?wh=1696*1056\" alt=\"\" title=\"图4 Calico IPIP模式工作原理\"></p><p>在Calico的IPIP模式下，Felix进程在Node 1上添加的路由规则，会稍微不同，如下所示：</p><pre><code>10.233.2.0/24 via 192.168.2.2 tunl0\n</code></pre><p>可以看到，尽管这条规则的下一跳地址仍然是Node 2的IP地址，但这一次，要负责将IP包发出去的设备，变成了tunl0。注意，是T-U-N-L-0，而不是Flannel UDP模式使用的T-U-N-0（tun0），这两种设备的功能是完全不一样的。</p><p>Calico使用的这个tunl0设备，是一个IP隧道（IP tunnel）设备。</p><p>在上面的例子中，IP包进入IP隧道设备之后，就会被Linux内核的IPIP驱动接管。IPIP驱动会将这个IP包直接封装在一个宿主机网络的IP包中，如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/fc/90/fc2b4173782b7a993f4a43a2cb966f90.jpg?wh=2248*1034\" alt=\"\"></p><center><span class=\"reference\">图5 IPIP封包方式</span></center><p>其中，经过封装后的新的IP包的目的地址（图5中的Outer IP Header部分），正是原IP包的下一跳地址，即Node 2的IP地址：192.168.2.2。</p><p>而原IP包本身，则会被直接封装成新IP包的Payload。</p><p>这样，原先从容器到Node 2的IP包，就被伪装成了一个从Node 1到Node 2的IP包。</p><p>由于宿主机之间已经使用路由器配置了三层转发，也就是设置了宿主机之间的“下一跳”。所以这个IP包在离开Node 1之后，就可以经过路由器，最终“跳”到Node 2上。</p><p>这时，Node 2的网络内核栈会使用IPIP驱动进行解包，从而拿到原始的IP包。然后，原始IP包就会经过路由规则和Veth Pair设备到达目的容器内部。</p><p>以上，就是Calico项目主要的工作原理了。</p><p>不难看到，当Calico使用IPIP模式的时候，集群的网络性能会因为额外的封包和解包工作而下降。在实际测试中，Calico IPIP模式与Flannel VXLAN模式的性能大致相当。所以，在实际使用时，如非硬性需求，我建议你将所有宿主机节点放在一个子网里，避免使用IPIP。</p><p>不过，通过上面对Calico工作原理的讲述，你应该能发现这样一个事实：</p><p>如果Calico项目能够让宿主机之间的路由设备（也就是网关），也通过BGP协议“学习”到Calico网络里的路由规则，那么从容器发出的IP包，不就可以通过这些设备路由到目的宿主机了么？</p><p>比如，只要在上面“IPIP示意图”中的Node 1上，添加如下所示的一条路由规则：</p><pre><code>10.233.2.0/24 via 192.168.1.1 eth0\n</code></pre><p>然后，在Router 1上（192.168.1.1），添加如下所示的一条路由规则：</p><pre><code>10.233.2.0/24 via 192.168.2.1 eth0\n</code></pre><p>那么Container 1发出的IP包，就可以通过两次“下一跳”，到达Router 2（192.168.2.1）了。以此类推，我们可以继续在Router 2上添加“下一条”路由，最终把IP包转发到Node 2上。</p><p>遗憾的是，上述流程虽然简单明了，但是在Kubernetes被广泛使用的公有云场景里，却完全不可行。</p><p>这里的原因在于：公有云环境下，宿主机之间的网关，肯定不会允许用户进行干预和设置。</p><blockquote>\n<p>当然，在大多数公有云环境下，宿主机（公有云提供的虚拟机）本身往往就是二层连通的，所以这个需求也不强烈。</p>\n</blockquote><p>不过，在私有部署的环境下，宿主机属于不同子网（VLAN）反而是更加常见的部署状态。这时候，想办法将宿主机网关也加入到BGP Mesh里从而避免使用IPIP，就成了一个非常迫切的需求。</p><p><span class=\"orange\">而在Calico项目中，它已经为你提供了两种将宿主机网关设置成BGP Peer的解决方案。</span></p><p><strong>第一种方案</strong>，就是所有宿主机都跟宿主机网关建立BGP Peer关系。</p><p>这种方案下，Node 1和Node 2就需要主动跟宿主机网关Router 1和Router 2建立BGP连接。从而将类似于10.233.2.0/24这样的路由信息同步到网关上去。</p><p>需要注意的是，这种方式下，Calico要求宿主机网关必须支持一种叫作Dynamic Neighbors的BGP配置方式。这是因为，在常规的路由器BGP配置里，运维人员必须明确给出所有BGP Peer的IP地址。考虑到Kubernetes集群可能会有成百上千个宿主机，而且还会动态地添加和删除节点，这时候再手动管理路由器的BGP配置就非常麻烦了。而Dynamic Neighbors则允许你给路由器配置一个网段，然后路由器就会自动跟该网段里的主机建立起BGP Peer关系。</p><p>不过，相比之下，我更愿意推荐<strong>第二种方案</strong>。</p><p>这种方案，是使用一个或多个独立组件负责搜集整个集群里的所有路由信息，然后通过BGP协议同步给网关。而我们前面提到，在大规模集群中，Calico本身就推荐使用Route Reflector节点的方式进行组网。所以，这里负责跟宿主机网关进行沟通的独立组件，直接由Route Reflector兼任即可。</p><p>更重要的是，这种情况下网关的BGP Peer个数是有限并且固定的。所以我们就可以直接把这些独立组件配置成路由器的BGP Peer，而无需Dynamic Neighbors的支持。</p><p>当然，这些独立组件的工作原理也很简单：它们只需要WATCH Etcd里的宿主机和对应网段的变化信息，然后把这些信息通过BGP协议分发给网关即可。</p><h2>总结</h2><p>在本篇文章中，我为你详细讲述了Fannel host-gw模式和Calico这两种纯三层网络方案的工作原理。</p><p>需要注意的是，在大规模集群里，三层网络方案在宿主机上的路由规则可能会非常多，这会导致错误排查变得困难。此外，在系统故障的时候，路由规则出现重叠冲突的概率也会变大。</p><p>基于上述原因，如果是在公有云上，由于宿主机网络本身比较“直白”，我一般会推荐更加简单的Flannel host-gw模式。</p><p>但不难看到，在私有部署环境里，Calico项目才能够覆盖更多的场景，并为你提供更加可靠的组网方案和架构思路。</p><h2>思考题</h2><p>你能否能总结一下三层网络方案和“隧道模式”的异同，以及各自的优缺点？</p><p>感谢你的收听，欢迎你给我留言，也欢迎分享给更多的朋友一起阅读。</p>","neighbors":{"left":{"article_title":"34 | Kubernetes网络模型与CNI网络插件","id":67351},"right":{"article_title":"36 | 为什么说Kubernetes只有soft multi-tenancy？","id":68316}},"comments":[{"had_liked":false,"id":38187,"user_name":"swordholder","can_delete":false,"product_type":"c1","uid":1002569,"ip_address":"","ucode":"3D1361126AD3CB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/49/d21c134f.jpg","comment_is_top":false,"comment_ctime":1541984759,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"620017275383","product_id":100015201,"comment_content":"写了两篇文档：<br>Docker单机网络模型动手实验 https:&#47;&#47;github.com&#47;mz1999&#47;blog&#47;blob&#47;master&#47;docs&#47;docker-network-bridge.md<br>Docker跨主机Overlay网络动手实验 https:&#47;&#47;github.com&#47;mz1999&#47;blog&#47;blob&#47;master&#47;docs&#47;docker-overlay-networks.md<br>通过动手实验加深理解容器网络。分享出来希望对小伙伴有所帮助。<br><br>看来学完了这篇，可以再写一个Docker跨主机路由方案动手实验","like_count":144,"discussions":[{"author":{"id":1690929,"avatar":"https://static001.geekbang.org/account/avatar/00/19/cd/31/64994051.jpg","nickname":"刘宏鑫","note":"","ucode":"88A0B966DBF9BF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":531368,"discussion_content":"大佬牛逼啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637293911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970516,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLK4NPyaFDl4rzrd4A9z42tQDibFLdCicbrAdyUa5P2B5u8UCUBenpHX7VgUCibvHvhpza4icMBKVnhmA/132","nickname":"学无止境","note":"","ucode":"2C28E8E54DAB4E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390320,"discussion_content":"膜拜大佬\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629775736,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1308196,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f6/24/5a9277f1.jpg","nickname":"ghostwritten","note":"","ucode":"AE512F2E24A1A0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388047,"discussion_content":"大佬，无疑了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628568220,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38308,"user_name":"blackpiglet","can_delete":false,"product_type":"c1","uid":1032928,"ip_address":"","ucode":"58AA8329C91767","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg","comment_is_top":false,"comment_ctime":1542019280,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"478283389136","product_id":100015201,"comment_content":"三层和隧道的异同：<br>相同之处是都实现了跨主机容器的三层互通，而且都是通过对目的 MAC 地址的操作来实现的；不同之处是三层通过配置下一条主机的路由规则来实现互通，隧道则是通过通过在 IP 包外再封装一层 MAC 包头来实现。<br>三层的优点：少了封包和解包的过程，性能肯定是更高的。<br>三层的缺点：需要自己想办法维护路由规则。<br>隧道的优点：简单，原因是大部分工作都是由 Linux 内核的模块实现了，应用层面工作量较少。<br>隧道的缺点：主要的问题就是性能低。","like_count":112,"discussions":[{"author":{"id":2378009,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKicUgL8bc6EDj2w7GG8UjxRFYicmXlAdUHaSRdAT798ibpfOgF9OWFku5jad5ezWFGkCWXnoqFgSWlw/132","nickname":"iamcaptain","note":"","ucode":"868D95D47E033E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":377403,"discussion_content":"说的不错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622629025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263828,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1606274870,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"173404966710","product_id":100015201,"comment_content":"Kubernetes通过一个叫做CNI的接口，维护了一个单独的网桥来代替docker0。这个网桥的名字就叫作：CNI网桥，它在宿主机上的设备名称默认是：cni0。<br><br>容器“跨主通信”的三种主流实现方法：UDP、host-gw、VXLAN。 之前介绍了UDP和VXLAN，它们都属于隧道模式，需要封装和解封装。接下来介绍一种纯三层网络方案，host-gw模式和Calico项目<br><br>Host-gw模式通过在宿主机上添加一个路由规则： <br><br>    &lt;目的容器IP地址段&gt; via &lt;网关的IP地址&gt; dev eth0<br><br>IP包在封装成帧发出去的时候，会使用路由表里的“下一跳”来设置目的MAC地址。这样，它就会通过二层网络到达目的宿主机。<br>这个三层网络方案得以正常工作的核心，是为每个容器的IP地址，找到它所对应的，“下一跳”的网关。所以说，Flannel host-gw模式必须要求集群宿主机之间是二层连通的，如果宿主机分布在了不同的VLAN里（三层连通），由于需要经过的中间的路由器不一定有相关的路由配置（出于安全考虑，公有云环境下，宿主机之间的网关，肯定不会允许用户进行干预和设置），部分节点就无法找到容器IP的“下一条”网关了，host-gw就无法工作了。<br><br>Calico项目提供的网络解决方案，与Flannel的host-gw模式几乎一样，也会在宿主机上添加一个路由规则：<br><br>    &lt;目的容器IP地址段&gt; via &lt;网关的IP地址&gt; dev eth0<br><br>其中，网关的IP地址，正是目的容器所在宿主机的IP地址，而正如前面所述，这个三层网络方案得以正常工作的核心，是为每个容器的IP地址，找到它所对应的，“下一跳”的网关。区别是如何维护路由信息：<br>Host-gw :  Flannel通过Etcd和宿主机上的flanneld来维护路由信息<br>Calico: 通过BGP（边界网关协议）来实现路由自治，所谓BGP，就是在大规模网络中实现节点路由信息共享的一种协议。<br><br>隧道技术（需要封装包和解包，因为需要伪装成宿主机的IP包，需要三层链通）：Flannel UDP &#47; VXLAN  &#47; Calico IPIP<br>三层网络（不需要封包和解封包，需要二层链通）：Flannel host-gw &#47; Calico 普通模式<br>","like_count":41},{"had_liked":false,"id":45299,"user_name":"米开朗基杨","can_delete":false,"product_type":"c1","uid":1080551,"ip_address":"","ucode":"C10F42129AD2DF","user_header":"https://static001.geekbang.org/account/avatar/00/10/7c/e7/47429b6c.jpg","comment_is_top":false,"comment_ctime":1543579919,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"113212729615","product_id":100015201,"comment_content":"写了篇关于calico开启反射路由模式的文章，希望对大家有所帮助：https:&#47;&#47;www.yangcs.net&#47;posts&#47;calico-rr&#47;","like_count":26,"discussions":[{"author":{"id":1218367,"avatar":"https://static001.geekbang.org/account/avatar/00/12/97/3f/70f08a80.jpg","nickname":"SakuraTears","note":"","ucode":"998B20C428EA7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556654,"discussion_content":"yyds 优秀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647438262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2153296,"avatar":"https://static001.geekbang.org/account/avatar/00/20/db/50/c2d07bb1.jpg","nickname":"L。","note":"","ucode":"FCE0BC976776E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":395685,"discussion_content":"杨老师在哪里都能撞见 无处不在","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632323033,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1308196,"avatar":"https://static001.geekbang.org/account/avatar/00/13/f6/24/5a9277f1.jpg","nickname":"ghostwritten","note":"","ucode":"AE512F2E24A1A0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388048,"discussion_content":"大佬， 之前就拜读过你的文章，货非常干，yyds...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628568310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":55291,"user_name":"勤劳的小胖子-libo","can_delete":false,"product_type":"c1","uid":1158344,"ip_address":"","ucode":"5BB20CD5A56568","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/c8/4b1c0d40.jpg","comment_is_top":false,"comment_ctime":1546091395,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"40200797059","product_id":100015201,"comment_content":"所以三层可达，二层不可达的k8s集群不能使用Flannel host-gw模式，只能使用其他模式？","like_count":9,"discussions":[{"author":{"id":1018724,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8b/64/d8bf2f6f.jpg","nickname":"旻言","note":"","ucode":"563E6A83A50EC9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580587,"discussion_content":"我理解是这样，毕竟dst ip就是container 2的ip，只是Mac地址是下一跳node2的，除非对宿主机网关加路由吧，感觉又回到了calico","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658280303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2100644,"avatar":"","nickname":"Geek_8e2759","note":"","ucode":"EBDBA4D92B5C50","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323571,"discussion_content":"宿主机和路由器上各配置路由规则就可以了啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604970127,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38214,"user_name":"虎虎❤️","can_delete":false,"product_type":"c1","uid":1086535,"ip_address":"","ucode":"157F261E80291A","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/47/75875257.jpg","comment_is_top":false,"comment_ctime":1541990240,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40196695904","product_id":100015201,"comment_content":"三层网络优点： 不需要封包、拆包，传输效率会更高；可以设置复杂的网络策略。<br>隧道模式优点： 不需要在主机间的网关中维护容器路由信息，只需要主机有三层网络的连通性即可。","like_count":9},{"had_liked":false,"id":41468,"user_name":"帅","can_delete":false,"product_type":"c1","uid":1207367,"ip_address":"","ucode":"DB792F56C26429","user_header":"https://static001.geekbang.org/account/avatar/00/12/6c/47/57b6c4e8.jpg","comment_is_top":false,"comment_ctime":1542788533,"is_pvip":false,"discussion_count":7,"race_medal":0,"score":"31607559605","product_id":100015201,"comment_content":"老师你好，问个小白问题，怎么判断集群里的宿主机是否二层互通，或者说怎么实现二层互通？","like_count":7,"discussions":[{"author":{"id":1156643,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a6/23/91e74c43.jpg","nickname":"leo","note":"","ucode":"73E8917E5156FC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3696,"discussion_content":"只要所有宿主机属于同一个网段，比如192.168.1.*/24。那么它们就是两层互通的。","likes_number":12,"is_delete":false,"is_hidden":false,"ctime":1564716821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2285809,"avatar":"https://static001.geekbang.org/account/avatar/00/22/e0/f1/2ec847ae.jpg","nickname":"MissOne","note":"","ucode":"BA94D8634FBB12","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368133,"discussion_content":"二层互通是查mac表，三层互通是查路由表","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1618578030,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1224228,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ae/24/5723e6fe.jpg","nickname":"绝望的生鱼片","note":"","ucode":"5F4337E4623FEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347795,"discussion_content":"没有冒犯之意，但是你应该先去学点网络基础课程再来看这个文章","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612321851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1997273,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/d9/1c33c974.jpg","nickname":"sun......","note":"","ucode":"18C004B830A865","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294873,"discussion_content":"同同一个子网呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596021762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1474907,"avatar":"","nickname":"Geek_78d353","note":"","ucode":"D8B244B6D1A852","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":203020,"discussion_content":"难道不是ping一下吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583985724,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1470635,"avatar":"https://static001.geekbang.org/account/avatar/00/16/70/ab/7a7399a7.jpg","nickname":"tj.•","note":"","ucode":"078D80A68491E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1474907,"avatar":"","nickname":"Geek_78d353","note":"","ucode":"D8B244B6D1A852","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":265631,"discussion_content":"3层能连通都能ping吧，不一定是2层","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589422213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":203020,"ip_address":""},"score":265631,"extra":""}]},{"author":{"id":1218347,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLvdWoCic6ItzibF8ia8vrUTRuyj6AT3tg5f4QicIK0jTIFheJ6274ZkibuRLFP1NXG3jibv5TiaSKNoJpLw/132","nickname":"Geek_37984c","note":"","ucode":"7A319AE28599B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":175489,"discussion_content":"二层连通的还要跨网段","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581955912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38295,"user_name":"每日都想上班","can_delete":false,"product_type":"c1","uid":1060466,"ip_address":"","ucode":"1DE64120C8B14A","user_header":"https://static001.geekbang.org/account/avatar/00/10/2e/72/145c10db.jpg","comment_is_top":false,"comment_ctime":1542017184,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31606788256","product_id":100015201,"comment_content":"架设k8s集群后，对操作系统及网络知识有了一个很好的复习，感谢大神","like_count":7},{"had_liked":false,"id":154538,"user_name":"拉欧","can_delete":false,"product_type":"c1","uid":1206605,"ip_address":"","ucode":"40996A8093A95F","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg","comment_is_top":false,"comment_ctime":1574476151,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27344279927","product_id":100015201,"comment_content":"三层网络方案简单易懂，开销小，缺点是需要物理互联，连接节点有限；<br>隧道协议更通用，可以打通不同网段，但是开销大，协议复杂，难排错；","like_count":6},{"had_liked":false,"id":303843,"user_name":"小江哥哥","can_delete":false,"product_type":"c1","uid":1044266,"ip_address":"","ucode":"E5B3725FC9E366","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ef/2a/e9c5c163.jpg","comment_is_top":false,"comment_ctime":1627022440,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"23101858920","product_id":100015201,"comment_content":"对于二层联通的网络：<br>可以选择flannel的host-gw或者calico（非ipip模式），将宿主机当作网关，进行直接跳转，区别为calico自己封装了一个组件（BIRD）存储并维护路由关系，flannel维护并借助K8S的etcd存储路由关系。<br><br>对于多个vlan的网络：<br>flannel的vxlan和calico的ipip模式都可以选择，它们都通过内核模块进行了一次封包和解包过程，有内核态到用户态的切换，效率损耗较大（20%-30%）。不同点在于，calico拥有‘重型武器’BGP，可以通过它与宿主机的网关交换，共同维护路由关系，实现伪二层直连，方便自定义网络架构，定制程度比flannel高。<br><br>其他区别：<br>1. flannel的所有模式都使用了cni的网桥模式，不用在宿主机上维护这么多设备对的映射关系，calico则相反。<br>2. 所有网络IP规划分配，路由规则存储维护calico都大包大揽，通过BGP，等组件维护，flannel的路由存储和维护需要依赖K8s的etcd，且会与apiserver交互。<br>3. 在大规模集群中。对于路由规则的跟踪维护，calico有自己的中心化方案（Route Reflector模式），避免了路由信息指数级增长。<br>4. 在非二层直连网络中，calico支持通过与宿主机网关的互动（BGP协议），组成三层网络，避免了使用ipip封包解包，提高网络性能，这点上比flannel定制化程度更高。","like_count":5,"discussions":[{"author":{"id":2853149,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/89/1d/d1d8edcc.jpg","nickname":"梅斌","note":"","ucode":"DDE15A3FD12738","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545775,"discussion_content":"calico通过flex维护路由信息，bird是用来广播路由信息的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642049605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48712,"user_name":"峰哥","can_delete":false,"product_type":"c1","uid":1301870,"ip_address":"","ucode":"CB0652D3EF49A1","user_header":"https://static001.geekbang.org/account/avatar/00/13/dd/6e/f3cfebc5.jpg","comment_is_top":false,"comment_ctime":1544520627,"is_pvip":false,"replies":[{"id":"17499","content":"版本差太远了，升级不了。。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1544533185,"ip_address":"","comment_id":48712,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18724389811","product_id":100015201,"comment_content":"老师好，有个1.4的K8S集群，sprincloud的微服务，怎么升级到1.10，是生产环境，有什么好的办法，谢谢<br>","like_count":4,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":432322,"discussion_content":"版本差太远了，升级不了。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1544533185,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263827,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1606274866,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"14491176754","product_id":100015201,"comment_content":"有个疑问，为什么叫 “三层”网络方案呢？<br><br><br>","like_count":3,"discussions":[{"author":{"id":2334257,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/4fZ9thib248ZkR1N3Eekeyb8N1V1Ud0uePctlI4VQUibPSmEZvgoP0VYl6IsVHJc7ZMiczQMtU76y6E6ag1zNAK4Q/132","nickname":"Geek_336577","note":"","ucode":"4826355EBA4950","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557403,"discussion_content":"三层，工作在IP层，通过路由来实现。二层，不需要路由，因为要二层互通，那么一定在一个子网，都不需要过路由器，走交换机就到了","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1647787222,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1019302,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8d/a6/22c37c91.jpg","nickname":"楊_宵夜","note":"","ucode":"7BA0CADC5F23BB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382828,"discussion_content":"你可以了解下OSI七层模型中, 第三层是什么. 这几篇文章的前提是你至少了解OSI层模型的基础知识;","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1625734296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236595,"user_name":"头发乱了","can_delete":false,"product_type":"c1","uid":1585858,"ip_address":"","ucode":"DA940109725AE5","user_header":"https://static001.geekbang.org/account/avatar/00/18/32/c2/8c1a2b00.jpg","comment_is_top":false,"comment_ctime":1595473844,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14480375732","product_id":100015201,"comment_content":"听老师的讲解真是太过瘾了！！","like_count":3},{"had_liked":false,"id":228304,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1592638408,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"14477540296","product_id":100015201,"comment_content":"有一个疑问 ，Calico IPIP模式下。IPIP封包前后，IP Header里面的目的IP都是“192.168.2.2”。那为什么封包前不能从Node1发送到Node2 ？","like_count":3,"discussions":[{"author":{"id":2334257,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/4fZ9thib248ZkR1N3Eekeyb8N1V1Ud0uePctlI4VQUibPSmEZvgoP0VYl6IsVHJc7ZMiczQMtU76y6E6ag1zNAK4Q/132","nickname":"Geek_336577","note":"","ucode":"4826355EBA4950","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557406,"discussion_content":"不一样的。因为容器里面要访问的目的IP是对端的容器IP，所以容器内封包以后IP Header是对端容器的IP。来到宿tunl0设备后，查看路由后，给他加了对端容器所在宿主机的IP Header，然后就是走普通的宿主机网络了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647787569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2642791,"avatar":"https://static001.geekbang.org/account/avatar/00/28/53/67/3e8b765a.jpg","nickname":"胡红青","note":"","ucode":"365F439146CDBF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547432,"discussion_content":"因为不知道宿主机之间的路由信息，即没法确定下一跳的IP（这部分信息在宿主机之间的网关上，没有BGP给宿主机）。封包后个人理解是直接指定目的地址，而不是指明下一跳地址，让宿主机自己想办法发到指定的目的地址（即宿主机间的网关）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642671919,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2100644,"avatar":"","nickname":"Geek_8e2759","note":"","ucode":"EBDBA4D92B5C50","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323589,"discussion_content":"里面的 IP 应该是容器 Conatiner 4 的 IP 地址（10.233.2.2）吧，不应该是宿主机的 IP ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604971277,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1094470,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b3/46/ec914238.jpg","nickname":"espzest","note":"","ucode":"64B1A7DEA19348","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305088,"discussion_content":"我对这点也很有疑惑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599782962,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":124665,"user_name":"羁绊12221","can_delete":false,"product_type":"c1","uid":1463686,"ip_address":"","ucode":"15B47C5053388A","user_header":"https://static001.geekbang.org/account/avatar/00/16/55/86/ca7c94ce.jpg","comment_is_top":false,"comment_ctime":1565939808,"is_pvip":false,"replies":[{"id":"46510","content":"有些网络方案或者硬件，要求必须在二层做一些功能","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1566351078,"ip_address":"","comment_id":124665,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14450841696","product_id":100015201,"comment_content":"老师好，flannel UDP 隧道封装的是IP包，vxlan封装的是 二层帧，Calico IPIP模式封装的也是IP包。。感觉上使用隧道通信封装IP报文就够了吧？封装二层帧有什么考虑吗？","like_count":4,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463267,"discussion_content":"有些网络方案或者硬件，要求必须在二层做一些功能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566351078,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38199,"user_name":"朱升平","can_delete":false,"product_type":"c1","uid":1221582,"ip_address":"","ucode":"66F6612FD453D5","user_header":"https://static001.geekbang.org/account/avatar/00/12/a3/ce/12f9d2ae.jpg","comment_is_top":false,"comment_ctime":1541986081,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"14426887969","product_id":100015201,"comment_content":"网络是短板，得多学习学习！","like_count":3},{"had_liked":false,"id":228369,"user_name":"ch_ort","can_delete":false,"product_type":"c1","uid":1580926,"ip_address":"","ucode":"B79746E687F29E","user_header":"","comment_is_top":false,"comment_ctime":1592649701,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10182584293","product_id":100015201,"comment_content":"隧道技术（需要封装包和解包，因为需要伪装成宿主机的IP包，需要三层链通）：Flannel UDP &#47; VXLAN  &#47; Calico IPIP<br>三层网络（不需要封包和解封包，需要二层链通）：Flannel host-gw &#47; Calico ","like_count":2,"discussions":[{"author":{"id":2139471,"avatar":"https://static001.geekbang.org/account/avatar/00/20/a5/4f/772dd0f3.jpg","nickname":"zlel","note":"","ucode":"D98D44B933D6D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":351508,"discussion_content":"这个总结简单明了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614309313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153915,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1574329714,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10164264306","product_id":100015201,"comment_content":"三层网络方案和“隧道模式”的异同，以及各自的优缺点：三层网络方案要求宿主机二层连通，隧道模式不要求宿主机二层连通；三层网路方案没有封包和解包，性能上比隧道模式要好。","like_count":2,"discussions":[{"author":{"id":1010056,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg","nickname":"Dale","note":"","ucode":"DD4717C06E417D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158843,"discussion_content":"应该是三层网络方案不要求二层连通，通过BGP协议来实现三层连通。\n隧道模式需要要求二层连通，节点处于一个大的二层网络，这样才可以进行对二层进行封包和解包","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580633219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1199670,"avatar":"https://static001.geekbang.org/account/avatar/00/12/4e/36/de029ebf.jpg","nickname":"🐬Innocence","note":"","ucode":"7CBAB4976FACE0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010056,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg","nickname":"Dale","note":"","ucode":"DD4717C06E417D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":277364,"discussion_content":"说反了吧。文中介绍的两种方案都是三层网络方案。必须要求集群宿主机之间是二层连通的。只不过calico的隧道模式可以在两个子网二层不通的情况下，通过添加额外的隧道头部完成，但前提是三层也就是IP地址要完成互通","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1591027767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":158843,"ip_address":""},"score":277364,"extra":""}]}]},{"had_liked":false,"id":38678,"user_name":"每日都想上班","can_delete":false,"product_type":"c1","uid":1060466,"ip_address":"","ucode":"1DE64120C8B14A","user_header":"https://static001.geekbang.org/account/avatar/00/10/2e/72/145c10db.jpg","comment_is_top":false,"comment_ctime":1542103910,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10132038502","product_id":100015201,"comment_content":"碰到一个奇怪的问题，集群中一台master节点重启后，发现docker images 镜像都被清空了一样，然后我重新pull过来，过一会又没有了，这个是哪里问题呢？","like_count":2,"discussions":[{"author":{"id":1370341,"avatar":"https://static001.geekbang.org/account/avatar/00/14/e8/e5/fd4c7ea6.jpg","nickname":"雾雾glu","note":"","ucode":"00C6AA3DB823E7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":254503,"discussion_content":"之前好像也遇到过类似的问题，不过当时是有一个镜像太大了，被 gc 掉了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588330953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":38677,"user_name":"freeman","can_delete":false,"product_type":"c1","uid":1296242,"ip_address":"","ucode":"B766B91AFC3398","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ZwGweFhVUTfOrrYRk6Dic1IBxFyj2ZgsI1UXQeic2B5uJFdjicsIicnKrJts9v7nGUTCQlSKNUpmvYULq5KjqWjU4g/132","comment_is_top":false,"comment_ctime":1542103755,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10132038347","product_id":100015201,"comment_content":"老师，能介绍一下Cilium吗","like_count":2},{"had_liked":false,"id":38148,"user_name":"再见孙悟空","can_delete":false,"product_type":"c1","uid":1025518,"ip_address":"","ucode":"57E12A2F9CD915","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a5/ee/6bbac848.jpg","comment_is_top":false,"comment_ctime":1541956615,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10131891207","product_id":100015201,"comment_content":"凌晨在追，感觉像追剧！嘻嘻","like_count":2},{"had_liked":false,"id":273482,"user_name":"单朋荣","can_delete":false,"product_type":"c1","uid":1272662,"ip_address":"","ucode":"8AD121BEDD9675","user_header":"https://static001.geekbang.org/account/avatar/00/13/6b/56/37a4cea7.jpg","comment_is_top":false,"comment_ctime":1610611129,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5905578425","product_id":100015201,"comment_content":"calico：<br>通过veth pair路由规则，实现直接在二层网络通信；对不同子网的三层网络通信，使用ipip来再次封装一次ip包，实现外部的寻址。<br>flannel vxlan:<br>它在三层网络外层，又做了一次二层链路寻址（避免tun0的用户态到内核态的切换开销）;<br>mac地址是各个flannel.1的地址，flannel.1所在主机地址，都可以由flannel进程从etcd中获取到。<br><br>张老师，这两种方式性能差别在什么地方啊？谢谢！！","like_count":1,"discussions":[{"author":{"id":2853149,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/89/1d/d1d8edcc.jpg","nickname":"梅斌","note":"","ucode":"DDE15A3FD12738","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545778,"discussion_content":"文中有说 vxlan和ipip模式性能相当","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642049919,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255458,"user_name":"M","can_delete":false,"product_type":"c1","uid":2258463,"ip_address":"","ucode":"8D56D96F8FD140","user_header":"https://static001.geekbang.org/account/avatar/00/22/76/1f/e7cd0190.jpg","comment_is_top":false,"comment_ctime":1603349209,"is_pvip":false,"discussion_count":5,"race_medal":0,"score":"5898316505","product_id":100015201,"comment_content":"二层可达和三层可达的区别是什么，不都需要ip地址和mac地址才能通信吗","like_count":1,"discussions":[{"author":{"id":2034725,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/UGqtO7nj9EXt7tbicojstIcLnMgzY2cWaUyXWzQU7G0c1YttVcxlslKXTev1ohonFfJBWQZ1oNT3C9GQ6jjlhyw/132","nickname":"Geek_f9d390","note":"","ucode":"521B60A2DCABD4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374061,"discussion_content":"个人理解：二层指的是数据链路层，也即mac层，不需要经过路由；三层指的是IP层，需要路由转发","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1620983157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1269156,"avatar":"https://static001.geekbang.org/account/avatar/00/13/5d/a4/2e4b6d33.jpg","nickname":"素还真","note":"","ucode":"9ABA456355F7E3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346254,"discussion_content":"二层要求在同一个网段","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1611893941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1337552,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZCX6TPTqnEaoia8s6IT0PKUHTeDoXiaLPSibQMQ9Sia6P1bqCYSdanX8g9GRZ3kHp5a6x4enx3tyPuQ/132","nickname":"daidai","note":"","ucode":"67405B4E1005E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559832,"discussion_content":"二层可达的意思是 Source host 发出二层的帧（frame）可以直接发送到 Dest host网卡。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1648993072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2853149,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/89/1d/d1d8edcc.jpg","nickname":"梅斌","note":"","ucode":"DDE15A3FD12738","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545780,"discussion_content":"二层可达指数据包不经过网关，三层通信数据包会经过网关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642050016,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218402,"avatar":"https://static001.geekbang.org/account/avatar/00/12/97/62/568fc34e.jpg","nickname":"理想永远都年轻","note":"","ucode":"0DA68671B76C38","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333208,"discussion_content":"我也没搞懂 \n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607481000,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":215199,"user_name":"0.7","can_delete":false,"product_type":"c1","uid":1274292,"ip_address":"","ucode":"AF279910468210","user_header":"","comment_is_top":false,"comment_ctime":1588926932,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5883894228","product_id":100015201,"comment_content":"公有云的vpc算纯二层吗？可以使用host-gw吗？我试了下，没搞通。","like_count":1,"discussions":[{"author":{"id":2100644,"avatar":"","nickname":"Geek_8e2759","note":"","ucode":"EBDBA4D92B5C50","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323583,"discussion_content":"公有云 VPC 主机之间的转发是由 vswitch  指定的，在主机上指定的路由是无效的，可以参考 https://zhangguanzhang.github.io/2020/06/23/host-gw-in-aliyun/ 修改","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604970793,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1000004,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/42/44/d3d67640.jpg","nickname":"Hills录","note":"","ucode":"779020947ACABA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290102,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594344914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50327,"user_name":"稻草篮儿","can_delete":false,"product_type":"c1","uid":1171336,"ip_address":"","ucode":"A574E12604C63E","user_header":"https://static001.geekbang.org/account/avatar/00/11/df/88/30c80cad.jpg","comment_is_top":false,"comment_ctime":1544953105,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5839920401","product_id":100015201,"comment_content":"老师你好，根据您的文章对k8s已经有了大致了解，并且已经开始使用，但对于其中网络的相关知识还是模模糊糊（特别是您课程中网络这几章的内容），为此有了想恶补网络知识的想法，老师您对k8s相关网络知识有推荐的书籍或课程吗?","like_count":1,"discussions":[{"author":{"id":1223167,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a9/ff/6b0260e1.jpg","nickname":"徐骋","note":"","ucode":"92B63EEE5BB0C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1625,"discussion_content":"推荐看这本书：TCP/IP Illustrated","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562747752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":39217,"user_name":".","can_delete":false,"product_type":"c1","uid":1071088,"ip_address":"","ucode":"34CA27A83D8273","user_header":"https://static001.geekbang.org/account/avatar/00/10/57/f0/8b1c5ae9.jpg","comment_is_top":false,"comment_ctime":1542211362,"is_pvip":false,"replies":[{"id":"14023","content":"都可以，都要改","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1542241414,"ip_address":"","comment_id":39217,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5837178658","product_id":100015201,"comment_content":"请问，如果是想要静态ip，是不是只能选择calico方案，flannel不行","like_count":1,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428968,"discussion_content":"都可以，都要改","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542241414,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359189,"user_name":"book尾汁","can_delete":false,"product_type":"c1","uid":1446375,"ip_address":"北京","ucode":"AE2B8DFC643ACC","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","comment_is_top":false,"comment_ctime":1665310300,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1665310300","product_id":100015201,"comment_content":"目的都是将数据包送至宿主机，不同点是隧道模式是通过将数据包封装在宿主机的udp报文内，交由对端对应的服务解封包，三层网络模式是通过配置路由的下一跳来实现，即使是通过ipip隧道也只是多封装了一层ip头，解包后也是直接进入内核网络协议栈，通过路由规则路由到目标容器。","like_count":0},{"had_liked":false,"id":349920,"user_name":"超级芒果冰","can_delete":false,"product_type":"c1","uid":1188976,"ip_address":"","ucode":"97480FBFA4F699","user_header":"https://static001.geekbang.org/account/avatar/00/12/24/70/4e7751f3.jpg","comment_is_top":false,"comment_ctime":1656427242,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1656427242","product_id":100015201,"comment_content":"有一个疑问，在BGP这块内容中，有一段这样的描述<br>“AS 1 里面的主机 10.10.0.2，要访问 AS 2 里面的主机 172.17.0.3 的话。它发出的 IP 包，就会先到达自治系统 AS 1 上的路由器 Router 1。Router 1 的路由表里，有这样一条规则，即：目的地址是 172.17.0.2 包，应该经过 Router 1 的 C 接口，发往网关 Router 2。所以 IP 包就会到达 Router 2 上，然后经过 Router 2 的路由表，从 B 接口出来到达目的主机 172.17.0.3”<br>描述中ip包的目的地址是172.17.0.3，而Router 1 的路由表规则是目的地址是 172.17.0.2 包，应该经过 Router 1 的 C 接口，这里该怎么理解？","like_count":0},{"had_liked":false,"id":346565,"user_name":"maple-0406","can_delete":false,"product_type":"c1","uid":1197608,"ip_address":"","ucode":"7191D06449B6B6","user_header":"https://static001.geekbang.org/account/avatar/00/12/46/28/14ef7207.jpg","comment_is_top":false,"comment_ctime":1653231561,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1653231561","product_id":100015201,"comment_content":"三层网络: 简单，在一些公有云场景不适用<br><br><br>IPIP：多一层封包和解包性能更差，但适配更加丰富的场景","like_count":0},{"had_liked":false,"id":339507,"user_name":"ryan","can_delete":false,"product_type":"c1","uid":1596005,"ip_address":"","ucode":"845DAC632BF51B","user_header":"https://static001.geekbang.org/account/avatar/00/18/5a/65/b80035a6.jpg","comment_is_top":false,"comment_ctime":1648139541,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1648139541","product_id":100015201,"comment_content":"又复习了一遍基础网络知识😁","like_count":0},{"had_liked":false,"id":333394,"user_name":"Tendrun","can_delete":false,"product_type":"c1","uid":1225728,"ip_address":"","ucode":"86AB3C3A7D8381","user_header":"https://static001.geekbang.org/account/avatar/00/12/b4/00/bfc101ee.jpg","comment_is_top":false,"comment_ctime":1644323407,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1644323407","product_id":100015201,"comment_content":"文章最后提到的把宿主机网关设置成bgp peer的方案需要使用的时候自己开发程序来实现对吧，社区方案中没有吧","like_count":0},{"had_liked":false,"id":322372,"user_name":"火锅小王子","can_delete":false,"product_type":"c1","uid":1053262,"ip_address":"","ucode":"7D1BF39C437A99","user_header":"https://static001.geekbang.org/account/avatar/00/10/12/4e/ff0702fc.jpg","comment_is_top":false,"comment_ctime":1637323648,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637323648","product_id":100015201,"comment_content":"您好  我有个疑问  这里说的 “上面这条规则里的下一跳地址是 192.168.2.2，可是它对应的 Node 2 跟 Node 1 却根本不在一个子网里，没办法通过二层网络把 IP 包发送到下一跳地址。”    根据路由表，如果二层不通，不是自动会转交上层处理吗？","like_count":0},{"had_liked":false,"id":311866,"user_name":"荣埃","can_delete":false,"product_type":"c1","uid":1700262,"ip_address":"","ucode":"6C9A73474322EA","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epibr0LAy3JF3hjibhnGLyBNj1b985RXiby9FInxYRDl5jf5p0klcZGZuQL7VnLfmIJDtnqBUGPycMSA/132","comment_is_top":false,"comment_ctime":1631515720,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631515720","product_id":100015201,"comment_content":"请教下kube-calico-controller这个组件起什么作用","like_count":0},{"had_liked":false,"id":309182,"user_name":"leon","can_delete":false,"product_type":"c1","uid":1019441,"ip_address":"","ucode":"6F2970AF46C510","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8e/31/d1804c2c.jpg","comment_is_top":false,"comment_ctime":1629970930,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629970930","product_id":100015201,"comment_content":"然后，在 Router 1 上（192.168.1.1），添加如下所示的一条路由规则：<br>10.233.2.0&#47;24 via 192.168.2.1 eth0<br>--------怎么修改宿主机网关 Router 1 和 Router 2 的路由规则？是直接在宿主机上添加路由规则吗","like_count":0},{"had_liked":false,"id":305773,"user_name":"阿凯啊","can_delete":false,"product_type":"c1","uid":1048218,"ip_address":"","ucode":"781D46376B67DE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/9a/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1628154964,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628154964","product_id":100015201,"comment_content":"借这个课请教个问题，1master，3node集群，3个node部署了calico网络。为啥master上的kube-apiserver不能访问node上的pod。调用路径为：apiserver-》service-》webhook（pod）<br>异常信息<br><br>Error from server (InternalError): error when creating &quot;proxy-defaults.yaml&quot;: Internal error occurred: failed calling webhook &quot;mutate-proxydefaults.consul.hashicorp.com&quot;: <br>Post &quot;https:&#47;&#47;consul-controller-webhook.default.svc:443&#47;mutate-v1alpha1-proxydefaults?timeout=10s&quot;: dial tcp 169.169.113.71:443: connect: connection refused","like_count":0},{"had_liked":false,"id":300337,"user_name":"独孤九剑","can_delete":false,"product_type":"c1","uid":2230909,"ip_address":"","ucode":"6C1253E2B8C1D4","user_header":"https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg","comment_is_top":false,"comment_ctime":1625122907,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625122907","product_id":100015201,"comment_content":"软件定义的数据中心实现起来非常复杂啊，尤其是网络层面。","like_count":0},{"had_liked":false,"id":299190,"user_name":"Geek_5baa01","can_delete":false,"product_type":"c1","uid":2470693,"ip_address":"","ucode":"EE194170C4B30E","user_header":"","comment_is_top":false,"comment_ctime":1624504868,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624504868","product_id":100015201,"comment_content":"三层网络方案的性能更好，这对于网络敏感的有状态中间件非常重要，比如 Redis，但是在大规模集群里会导致宿主机的路由规则变多，这样故障排查会非常困难<br><br>隧道模式性能较差，链路更长且需要在二层封包拆包，在大规模集群里部署方式没有太大改变，可扩展和可运维能力好","like_count":0},{"had_liked":false,"id":292142,"user_name":"Shen","can_delete":false,"product_type":"c1","uid":1182167,"ip_address":"","ucode":"CFF7609A754392","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/d7/ffe7b0bf.jpg","comment_is_top":false,"comment_ctime":1620702101,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620702101","product_id":100015201,"comment_content":"醍醐灌顶","like_count":0},{"had_liked":false,"id":275569,"user_name":"留晴","can_delete":false,"product_type":"c1","uid":1512288,"ip_address":"","ucode":"F2D39E8D4EE3FD","user_header":"https://static001.geekbang.org/account/avatar/00/17/13/60/7ddff8e9.jpg","comment_is_top":false,"comment_ctime":1611586061,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611586061","product_id":100015201,"comment_content":"老师您好，有什么方式，在k8s集群内访问到集群外的ip+端口呢？","like_count":0},{"had_liked":false,"id":257897,"user_name":"干布球","can_delete":false,"product_type":"c1","uid":1218173,"ip_address":"","ucode":"048ABC199D89B9","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/7d/c7e8cd34.jpg","comment_is_top":false,"comment_ctime":1604198863,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604198863","product_id":100015201,"comment_content":"是否可以理解成，除了calico的IPIP模式，或是在calico下将宿主机网关设置成BGP Peer的方案，其他网络模式，包括flannel的三种方式(vxlan,udp,host-gw)都需要二层互通呢？","like_count":0},{"had_liked":false,"id":250823,"user_name":"Action","can_delete":false,"product_type":"c1","uid":1239234,"ip_address":"","ucode":"FFFD1537C6BB3C","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/c2/77a413a7.jpg","comment_is_top":false,"comment_ctime":1601254807,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601254807","product_id":100015201,"comment_content":"注意：在 Kubernetes v1.7 之后，类似 Flannel、Calico 的 CNI 网络插件都是可以直接连接 Kubernetes 的 APIServer 来访问 Etcd 的，无需额外部署 Etcd 给它们使用。<br><br>--------------------------------<br>老师这句话意思是不用部署etcd了？没看懂是需要还是不需要","like_count":0},{"had_liked":false,"id":246333,"user_name":"宝宝太喜欢极客时间了","can_delete":false,"product_type":"c1","uid":1215152,"ip_address":"","ucode":"9CDB679C257612","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoOGZ6lbHiboIZMN9USbeutnmCWBahVLtSlKlIENKvrZQCUQzpzeZQOxTntIkBUeDk6qZUPdqmfKrQ/132","comment_is_top":false,"comment_ctime":1599283963,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599283963","product_id":100015201,"comment_content":"老师您好，k8s集群1.17.3版本，访问外网域名的时候出现偶尔能访问通，偶尔访问不通的情况，这种情况怎么分析，有没有什么解决办法","like_count":0},{"had_liked":false,"id":242868,"user_name":"冬冬","can_delete":false,"product_type":"c1","uid":1180054,"ip_address":"","ucode":"B673E6482B5C93","user_header":"https://static001.geekbang.org/account/avatar/00/12/01/96/afcb6174.jpg","comment_is_top":false,"comment_ctime":1597880238,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1597880238","product_id":100015201,"comment_content":"三层网络特点：通过ip route得到数据传输路由，跨节点传输ip包时 会将route中geteway的mac地址作为ip包的请求头用于数据包传输，到达目标node时 进行拆包，然后根据ip包去除dest地址 并根据当前node的route列表，将数据包转发到相应container中。<br>优缺点：避免了额外的封包、拆包操作 性能较好，但要求集群宿主机间是二层连通的；<br>隧道模式：隧道模式通过BGP维护路由关系，其会将集群节点的ip 对应gateway 保存在当前节点的路由中，在请求发包时 数据包mac头地址指定为路由gateway地址。<br>优缺点：需维护集群中所有container的连接信息，当集群中容器数量较大时 BGP会爆炸增长，此时可切换至 集群中某几个节点维护网络关系，剩余的节点从主要节点同步路由信息。 <br>","like_count":0},{"had_liked":false,"id":242307,"user_name":"赵高龙","can_delete":false,"product_type":"c1","uid":1259115,"ip_address":"","ucode":"0DF7550246BFA5","user_header":"https://static001.geekbang.org/account/avatar/00/13/36/6b/d20ee86b.jpg","comment_is_top":false,"comment_ctime":1597665970,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1597665970","product_id":100015201,"comment_content":"问个小白问题，vxlan 是基于 udp 实现的，那正常应用的 tcp 链接如何实现呢？","like_count":0,"discussions":[{"author":{"id":2100644,"avatar":"","nickname":"Geek_8e2759","note":"","ucode":"EBDBA4D92B5C50","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":323585,"discussion_content":"最外层是 UDP 报文，VxLan 内侧的还是业务报文（TCP，UDP，ICMP）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604970935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":235089,"user_name":"Geek_47f456","can_delete":false,"product_type":"c1","uid":1606663,"ip_address":"","ucode":"02D4AE44BCFA01","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep5aMAlpqAe5glRfUuayjRwI2V5bOvzqdmKl7GicicElG2dJ1wm2awK6c32WfEMeaYlv6pv2tGSc2Yg/132","comment_is_top":false,"comment_ctime":1594889364,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594889364","product_id":100015201,"comment_content":"有个问题请教：calico IPIP能解决2层互通的限制的前提，是宿主机外有路由器解决了3层互通，<br>那Calico bgp能否也沿用这种思路，既然Calico BGP模式下都把容器路由发布给对端宿主机，那为什么不能直接跟宿主机外的路由器建bgp互通路由，这样就解决了2层互通的限制。<br>","like_count":0},{"had_liked":false,"id":234663,"user_name":"狗狗","can_delete":false,"product_type":"c1","uid":1276801,"ip_address":"","ucode":"CBA016CFDB3D33","user_header":"https://static001.geekbang.org/account/avatar/00/13/7b/81/d15030e3.jpg","comment_is_top":false,"comment_ctime":1594748858,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594748858","product_id":100015201,"comment_content":"为啥 我这边看不见 cni0 网桥是什么情况，不好意思，我在这方面还是很小白","like_count":0},{"had_liked":false,"id":175258,"user_name":"Dale","can_delete":false,"product_type":"c1","uid":1010056,"ip_address":"","ucode":"DD4717C06E417D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/69/88/528442b0.jpg","comment_is_top":false,"comment_ctime":1580632943,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1580632943","product_id":100015201,"comment_content":"三层网络方案和&quot;隧道模式&quot;对比：<br>1、三层网络方案不再需要通过cni网桥和容器通信，&quot;隧道模式&quot;需要通过cni网桥和容器进行二层网络通信<br>2、&quot;隧道模式&quot;要求节点二层网络是连通的，三层网络不需要，只需要网络层ip连通<br>3、三层网络方案需要在节点上配置路由规则，节点越多规则越多，维护规则困难。<br>4、&quot;隧道方案&quot;中基于flannel的udp、vxlan的隧道方案性能损坏比较大，host-gw方案相比要好","like_count":0,"discussions":[{"author":{"id":1887574,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/cd/56/dca89081.jpg","nickname":"lucasun","note":"","ucode":"5B900BC7C36F43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":196960,"discussion_content":"Calico的ipip其实也是隧道，是否应用隧道的本质其实是在网络传输的中间过程中，只靠原本的数据包的路由信息(mac,ip)等，中间网络设备是否能够顺利识别并转发","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583388395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":170351,"user_name":"Felix","can_delete":false,"product_type":"c1","uid":1317899,"ip_address":"","ucode":"9318688F3C5419","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAWUhO0xSjD6wbGScY5WOujAE94vNYWlWmsVdibb0IWbXzSSNXJHp0lqfWVq8ZicKBsEY1EuAWArew/132","comment_is_top":false,"comment_ctime":1578576467,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1578576467","product_id":100015201,"comment_content":"Kubeadm中部署的daemon形式的flannel，是vxlan形式的吗，怎么修改成hostgw方式呢","like_count":0,"discussions":[{"author":{"id":1018071,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/d7/07f8bc6c.jpg","nickname":"sljoai","note":"","ucode":"FF88C4BA265DE0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":189315,"discussion_content":"默认是vxlan，可以修改ConfigMap中net-conf.json的Backend.Type（kube-fannel.ayml）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582868284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":158401,"user_name":"hhhh","can_delete":false,"product_type":"c1","uid":1256101,"ip_address":"","ucode":"9E87017424B382","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/a5/625c0a2e.jpg","comment_is_top":false,"comment_ctime":1575364572,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575364572","product_id":100015201,"comment_content":"niubi","like_count":0},{"had_liked":false,"id":158203,"user_name":"davad_dee","can_delete":false,"product_type":"c1","uid":1057604,"ip_address":"","ucode":"BF285239FE8A69","user_header":"https://static001.geekbang.org/account/avatar/00/10/23/44/ebfe7b27.jpg","comment_is_top":false,"comment_ctime":1575347619,"is_pvip":true,"replies":[{"id":"74915","content":"已修正，感谢反馈~","user_name":"编辑回复","user_name_real":"贾静","uid":"1059377","ctime":1585547816,"ip_address":"","comment_id":158203,"utype":2}],"discussion_count":2,"race_medal":0,"score":"1575347619","product_id":100015201,"comment_content":"图 1 Flannel host-gw 示意图  第一个路由表中第三条路由 src 192.168.0.2 是否应该是 10.168.0.2","like_count":0,"discussions":[{"author":{"id":1059377,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2a/31/9edbf8a6.jpg","nickname":"贾静","note":"","ucode":"081E70CC01F6B8","race_medal":0,"user_type":8,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476669,"discussion_content":"已修正，感谢反馈~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585547816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1059377,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2a/31/9edbf8a6.jpg","nickname":"贾静","note":"","ucode":"081E70CC01F6B8","race_medal":0,"user_type":8,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217354,"discussion_content":"已修正，感谢反馈~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585547754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157254,"user_name":"游刃","can_delete":false,"product_type":"c1","uid":1167620,"ip_address":"","ucode":"7AADCFA5725F92","user_header":"","comment_is_top":false,"comment_ctime":1575098475,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575098475","product_id":100015201,"comment_content":"老师，问一个文中的问题，IP 隧道（IP tunnel）设备和 tun设备有什么区别的，比如Calico ipip模式中的 tunl0设备和 Flannel UDP模式中的 tun0设备？","like_count":0},{"had_liked":false,"id":152363,"user_name":"拉欧","can_delete":false,"product_type":"c1","uid":1206605,"ip_address":"","ucode":"40996A8093A95F","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/4d/81c44f45.jpg","comment_is_top":false,"comment_ctime":1573982933,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573982933","product_id":100015201,"comment_content":"三层模式更好理解，但需要两台宿主机可以ping通；<br>隧道模式应用更广，但是会有更大的开销，因为需要封装一层协议","like_count":0},{"had_liked":false,"id":144651,"user_name":"0.7","can_delete":false,"product_type":"c1","uid":1274292,"ip_address":"","ucode":"AF279910468210","user_header":"","comment_is_top":false,"comment_ctime":1571990242,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571990242","product_id":100015201,"comment_content":"文中加黑 所以说，Flannel host-gw 模式必须要求集群宿主机之间是二层连通的。<br><br>这里有点没太看懂。 宿主机之间是三层路由不行吗？","like_count":0},{"had_liked":false,"id":130987,"user_name":"左氧佛沙星人","can_delete":false,"product_type":"c1","uid":1195278,"ip_address":"","ucode":"0D8295E1DABA8C","user_header":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","comment_is_top":false,"comment_ctime":1567590465,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1567590465","product_id":100015201,"comment_content":"张老师，为什么我在启用calico网络的主机上，直接docker run 一个容器，然后进入容器，无法到达集群其他主机和外网，traceroute只到达本机？","like_count":0},{"had_liked":false,"id":94489,"user_name":"cuikt","can_delete":false,"product_type":"c1","uid":1242702,"ip_address":"","ucode":"9A1DB426CEFEEA","user_header":"https://static001.geekbang.org/account/avatar/00/12/f6/4e/0066303c.jpg","comment_is_top":false,"comment_ctime":1557823770,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557823770","product_id":100015201,"comment_content":"涨知识了","like_count":0},{"had_liked":false,"id":89494,"user_name":"Tendrun","can_delete":false,"product_type":"c1","uid":1225728,"ip_address":"","ucode":"86AB3C3A7D8381","user_header":"https://static001.geekbang.org/account/avatar/00/12/b4/00/bfc101ee.jpg","comment_is_top":false,"comment_ctime":1556185208,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"1556185208","product_id":100015201,"comment_content":"Flannel host-gw模式是不是可以通过把下一跳改为网关设备的地址，来解除二层不连通不可用的情况呢","like_count":0,"discussions":[{"author":{"id":1645662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/5e/46c4c6d8.jpg","nickname":"郑文","note":"","ucode":"A44F77600AD067","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387789,"discussion_content":"网关设备只有到node的路由，node的cni0才有到容器的路由。所以应该不行吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628414783,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2550335,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eor3yhoBAvuFPgibmLwRTtbFDvSyt9icTdco5fctGa31jVWWgYA8uKrAT2fEO0q3bep7HjtkiaTWHAiaA/132","nickname":"yxyjw999","note":"","ucode":"A4A3C810C8384E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374927,"discussion_content":"+1","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621413479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1094470,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b3/46/ec914238.jpg","nickname":"espzest","note":"","ucode":"64B1A7DEA19348","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3678,"discussion_content":"我也有这个疑惑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564704545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79999,"user_name":"whatever","can_delete":false,"product_type":"c1","uid":1446891,"ip_address":"","ucode":"675C63131E2BAF","user_header":"https://static001.geekbang.org/account/avatar/00/16/13/eb/150bf071.jpg","comment_is_top":false,"comment_ctime":1553590546,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1553590546","product_id":100015201,"comment_content":"请教下老师，Calico这种模式感觉就是现实中互联网的模式啊，请问我的理解对吗","like_count":0},{"had_liked":false,"id":78792,"user_name":"ray","can_delete":false,"product_type":"c1","uid":1353087,"ip_address":"","ucode":"C4695C9111DA8E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eogliaDlIwwQK6Tv0s2yEWmoAcITS8GkN9bqXrCd22Ou3ia2h0gZ0Pdva2tnibtJRLVF0ZObUdc6JWDw/132","comment_is_top":false,"comment_ctime":1553241092,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553241092","product_id":100015201,"comment_content":"老师，你好，calico可以修改bird的配置选项很少，看了calico的官方文档，貌似只能支持bird很有限的选项，这个怎么扩展呢？","like_count":0},{"had_liked":false,"id":75792,"user_name":"snow","can_delete":false,"product_type":"c1","uid":1220199,"ip_address":"","ucode":"2EAA59BC8996AC","user_header":"https://static001.geekbang.org/account/avatar/00/12/9e/67/bd72ae2d.jpg","comment_is_top":false,"comment_ctime":1552469561,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552469561","product_id":100015201,"comment_content":"您好，正常路由器和交换机不在同一网段的地址也可以建立BGP邻居吧，只要保证地址互相可达就行了。这里为什么一定要用IPIP隧道？","like_count":0},{"had_liked":false,"id":62282,"user_name":"凌","can_delete":false,"product_type":"c1","uid":1257995,"ip_address":"","ucode":"41369B360C794F","user_header":"https://static001.geekbang.org/account/avatar/00/13/32/0b/81ae214b.jpg","comment_is_top":false,"comment_ctime":1548000791,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1548000791","product_id":100015201,"comment_content":"host gw模式和ipvs的direct模式很像，都是通过二层mac直连效率最高。calico和ipvs的ip tun模式类似，都是通过ip隧道达到跨子网通信的目的","like_count":0},{"had_liked":false,"id":61896,"user_name":"柯察金","can_delete":false,"product_type":"c1","uid":1115149,"ip_address":"","ucode":"F722BF8FCD2C47","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg","comment_is_top":false,"comment_ctime":1547831537,"is_pvip":false,"replies":[{"id":"22073","content":"有可能的","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1548054158,"ip_address":"","comment_id":61896,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547831537","product_id":100015201,"comment_content":"BGP 这种，会不会导致路由表很大","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437030,"discussion_content":"有可能的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548054158,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":48658,"user_name":"Adam","can_delete":false,"product_type":"c1","uid":1305633,"ip_address":"","ucode":"338BA720880E4F","user_header":"https://static001.geekbang.org/account/avatar/00/13/ec/21/b0fe1bfd.jpg","comment_is_top":false,"comment_ctime":1544509289,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1544509289","product_id":100015201,"comment_content":"老师，vxlan后端好像还有另外一种Directrouting的方式，这个跟host-gw是不是类似的。","like_count":0},{"had_liked":false,"id":38249,"user_name":"blackpiglet","can_delete":false,"product_type":"c1","uid":1032928,"ip_address":"","ucode":"58AA8329C91767","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c2/e0/7188aa0a.jpg","comment_is_top":false,"comment_ctime":1542001507,"is_pvip":false,"replies":[{"id":"13795","content":"压测最好还是自己做，这个跟环境关系太大。你这里弄明白原理心里有底最重要。","user_name":"作者回复","user_name_real":"Geek_6ef93d","uid":"1218095","ctime":1542070783,"ip_address":"","comment_id":38249,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1542001507","product_id":100015201,"comment_content":"请问张老师，calico、flannel、Weave、romana 等网络插件，有没有比较权威的性能对比数据？和 bare metal 比起来，性能损耗差距有多大呢？网上搜了一圈，说什么的都有，是不是三层的方案大概都是 10% 左右的 overhead 的呢？","like_count":0,"discussions":[{"author":{"id":1218095,"avatar":"https://static001.geekbang.org/account/avatar/00/12/96/2f/876085fa.jpg","nickname":"张磊 Kubernetes","note":"","ucode":"16E29BDAB1F5BC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":428653,"discussion_content":"压测最好还是自己做，这个跟环境关系太大。你这里弄明白原理心里有底最重要。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1542070783,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}