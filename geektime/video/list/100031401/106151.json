{"id":106151,"title":"07 | 架构设计和技术栈选型","content":"<ul>\n<li>\n<p>代码：<a href=\"https://gitee.com/geektime-geekbang/staffjoy\">https://gitee.com/geektime-geekbang/staffjoy</a></p>\n</li>\n<li>\n<p>课件：<a href=\"https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ\">https://pan.baidu.com/s/1Q7eP3yZ1Vm8J2nhle5RzTQ</a> 提取码: 1aeh</p>\n</li>\n</ul>","comments":[{"had_liked":false,"id":111699,"user_name":"而立斋","can_delete":false,"product_type":"c3","uid":1087258,"ip_address":"","ucode":"5FED6E9E148195","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg","comment_is_top":false,"comment_ctime":1562586248,"is_pvip":false,"replies":[{"id":40745,"content":"谢谢支持！后面继续输出更优质内容，帮助大家提升技术和视野。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1562671350,"ip_address":"","comment_id":111699,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"好好学习，跟着老师的脚步实现个人价值的提升","like_count":9,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457419,"discussion_content":"谢谢支持！后面继续输出更优质内容，帮助大家提升技术和视野。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562671350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111965,"user_name":"风吹屁屁凉","can_delete":false,"product_type":"c3","uid":1306275,"ip_address":"","ucode":"A3C6349EE62569","user_header":"https://static001.geekbang.org/account/avatar/00/13/ee/a3/dca00545.jpg","comment_is_top":false,"comment_ctime":1562643745,"is_pvip":false,"replies":[{"id":40757,"content":"多租户有多种实现方式，你的实现方法也是一种，通过表隔离，这种隔离性比一般的逻辑隔离要好，实现上也不复杂。我们之前做过一个多租户消息队列系统，也是通过表隔离。实际还要看业务对隔离性的具体要求。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1562673446,"ip_address":"","comment_id":111965,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"多租户的问题我们公司目前也遇到了，我们目前的做法是在数据层完全隔离，我们每个租户都有编号（从1开始），前端每次发起请求都会带上这个租户编号，后端查询数据库的时候就在表的后缀加上租户编号，如t_user_detail_1，t_user_detail_2这种，请问波波老师这种做法是否合理？请指教","like_count":6,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457522,"discussion_content":"多租户有多种实现方式，你的实现方法也是一种，通过表隔离，这种隔离性比一般的逻辑隔离要好，实现上也不复杂。我们之前做过一个多租户消息队列系统，也是通过表隔离。实际还要看业务对隔离性的具体要求。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562673446,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1117983,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0f/1f/e894ae27.jpg","nickname":"Colt","note":"","ucode":"7BDB5F469E325D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1919,"discussion_content":"对于这种物理隔离的方法，在迭代更新时有没有好的做法，例如需要在detail表增加字段，那每个租户的detail 表怎样可以快速无差错的更新？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563094199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114688,"user_name":"Kian.Lee","can_delete":false,"product_type":"c3","uid":1086568,"ip_address":"","ucode":"3FB08A00F2DFD7","user_header":"https://static001.geekbang.org/account/avatar/00/10/94/68/56794ea3.jpg","comment_is_top":false,"comment_ctime":1563364440,"is_pvip":false,"replies":[{"id":41853,"content":"不错！","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1563367243,"ip_address":"","comment_id":114688,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"目前我们的SaaS产品采用共享表模式，每个表一个租户Id，然后在数据访问层采用拦截机制，多租户机制在业务层是透明无感知，业务代码开发上和单租户无差异，以后租户多了直接按租户ID段并结合租户用量直接分库，简单方便。","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458778,"discussion_content":"不错！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563367243,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133057,"user_name":"海罗沃德","can_delete":false,"product_type":"c3","uid":1165364,"ip_address":"","ucode":"8704F1D6980FA0","user_header":"https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg","comment_is_top":false,"comment_ctime":1568341395,"is_pvip":false,"replies":[{"id":51318,"content":"实际上，bot服务里头不少操作，还有mail&#47;sms服务里头的操作，都是Async方式执行，也就是放在异步线程池里头执行的，相当于消息队列。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1568639438,"ip_address":"","comment_id":133057,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"bot服务那里为什么没有设计使用消息队列，发送通知？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467242,"discussion_content":"实际上，bot服务里头不少操作，还有mail/sms服务里头的操作，都是Async方式执行，也就是放在异步线程池里头执行的，相当于消息队列。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568639438,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116718,"user_name":"Hugo","can_delete":false,"product_type":"c3","uid":1169900,"ip_address":"","ucode":"7C5D7708B1457B","user_header":"https://static001.geekbang.org/account/avatar/00/11/d9/ec/80b6fc48.jpg","comment_is_top":false,"comment_ctime":1563894812,"is_pvip":false,"replies":[{"id":42817,"content":"这也是一种做法，没有特别的问题。数据源多的话需要管理会麻烦一点，但是很多ORM框架(比如JPA&#47;MyBatis等)都支持多数据源的。如果租户数量超过一定量的，你可能需要自己定制研发多租户数据访问层。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1563972457,"ip_address":"","comment_id":116718,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"我们公司经理让从共享表做成每个租户都是一个库，目前我已初步完成，就是租户多的话，到时候数据源会存在很多，这种方式你怎么看，老师","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459657,"discussion_content":"这也是一种做法，没有特别的问题。数据源多的话需要管理会麻烦一点，但是很多ORM框架(比如JPA/MyBatis等)都支持多数据源的。如果租户数量超过一定量的，你可能需要自己定制研发多租户数据访问层。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563972457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113637,"user_name":"秋天的透明雨🌧️","can_delete":false,"product_type":"c3","uid":1110437,"ip_address":"","ucode":"9363B49BFA6C14","user_header":"https://static001.geekbang.org/account/avatar/00/10/f1/a5/6cc9f728.jpg","comment_is_top":false,"comment_ctime":1563100393,"is_pvip":false,"replies":[{"id":41389,"content":"你的问题在课程第4章《可编程网关设计和实践》会专门讲解，BFF和网关是如何演进出来的，请耐心等待后续课程的讲解。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1563113146,"ip_address":"","comment_id":113637,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"有如下问题，请杨波老师帮忙解惑，谢谢。\n1.BFF层的主要作用是什么？下边的理解正确吗？\n1）.对外暴露API，其它微服务API不对外直接暴露；\n2）.调用1个或多个其它微服务API并聚合各微服务API返回的数据，返回给客户端需要的数据结构；\n\n2.BFF通常会提供API Gateway的功能或是其它功能吗？\n","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458321,"discussion_content":"你的问题在课程第4章《可编程网关设计和实践》会专门讲解，BFF和网关是如何演进出来的，请耐心等待后续课程的讲解。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563113146,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111771,"user_name":"双","can_delete":false,"product_type":"c3","uid":1226462,"ip_address":"","ucode":"9A6A370DAD648E","user_header":"https://static001.geekbang.org/account/avatar/00/12/b6/de/95dc7537.jpg","comment_is_top":false,"comment_ctime":1562596794,"is_pvip":false,"replies":[{"id":40749,"content":"对，目前staffjoy设计没有BFF聚合层，因为教学版规模小直接暴露领域服务API，在faraday网关🈶️鉴权，服务控制器层还有进一步鉴权，基本也OK。实践大规模应用是要考虑单独BFF聚合层的，课程第三章[可编程网关设计和实践]，会单独讲网关和BFF是如何演进出来，以及相应的分层架构方法。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1562671770,"ip_address":"","comment_id":111771,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"App和MyAccount这两个静态单页应用最终渲染到用户浏览器端，浏览器端发http ajax请求经过网关，然后直接访问Account API和Company API吗？领域服务直接暴露给APP或者H5好吗？（有nginx&#47;网关鉴权和路由转发），中间没有弄个BFF或者很薄的应用服务层之类的？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457441,"discussion_content":"对，目前staffjoy设计没有BFF聚合层，因为教学版规模小直接暴露领域服务API，在faraday网关🈶️鉴权，服务控制器层还有进一步鉴权，基本也OK。实践大规模应用是要考虑单独BFF聚合层的，课程第三章[可编程网关设计和实践]，会单独讲网关和BFF是如何演进出来，以及相应的分层架构方法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562671770,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1391199,"avatar":"","nickname":"卡趴开发部","note":"","ucode":"416C2824A68708","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1410,"discussion_content":"波波老师的讲解中提及了是通过法拉第网关访问领域服务的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562602839,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1391199,"avatar":"","nickname":"卡趴开发部","note":"","ucode":"416C2824A68708","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1409,"discussion_content":"很薄的话好像就没什么必要吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562602682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":196857,"user_name":"林明忠","can_delete":false,"product_type":"c3","uid":1911192,"ip_address":"","ucode":"F5444908C1A2B3","user_header":"","comment_is_top":false,"comment_ctime":1585318692,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"老师介绍的很详细，对微服务架构的入门很有帮助","like_count":3},{"had_liked":false,"id":187952,"user_name":"钱","can_delete":false,"product_type":"c3","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1584282538,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"微服务的三大核心思想：\n1：分而治之\n2：单一职责\n3：关注分离\n多租户核心就是每个租户的数据怎么隔离，同一个应用按照距离基本有三种，表中隔离、表间隔离、库间隔离。","like_count":3},{"had_liked":false,"id":314676,"user_name":"Geek_7d2f11","can_delete":false,"product_type":"c3","uid":2794769,"ip_address":"","ucode":"4C0AF34D95AAC8","user_header":"","comment_is_top":false,"comment_ctime":1633322421,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100031401,"comment_content":"为什么不考虑gateway和zuul 使用faraday呢","like_count":0},{"had_liked":false,"id":196866,"user_name":"林明忠","can_delete":false,"product_type":"c3","uid":1911192,"ip_address":"","ucode":"F5444908C1A2B3","user_header":"","comment_is_top":false,"comment_ctime":1585319809,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100031401,"comment_content":"该节课对项目的架构搭建，技术栈选型提供很多的参考作用","like_count":0}]}