{"id":461695,"title":"40ï½œå¼‚æ­¥å¤„ç†ï¼šå¦‚ä½•å¤„ç†å¼‚æ­¥IOï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>å‰é¢ä¸¤è®²æˆ‘ä»¬å­¦ä¹ äº†å¼‚æ­¥å¤„ç†åŸºæœ¬çš„åŠŸèƒ½å’ŒåŸç†ï¼ˆFuture/async/awaitï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ­£å¼ä»‹ç»åœ¨å…·ä½“åœºåˆä¸‹è¯¥ç”¨å“ªäº›å·¥å…·æ¥å¤„ç†å¼‚æ­¥ IOã€‚ä¸è¿‡ä¹‹å‰è®² trait çš„æ—¶å€™ï¼Œå·²ç»äº†è§£å’Œä½¿ç”¨è¿‡ä¸€äº›å¤„ç†åŒæ­¥ IO çš„ç»“æ„å’Œ traitã€‚</p><p>ä»Šå¤©æˆ‘ä»¬å°±å¯¹æ¯”åŒæ­¥ IO æ¥å­¦ä¹ å¼‚æ­¥ IOã€‚æ¯•ç«Ÿåœ¨å­¦ä¹ æŸä¸ªæ–°çŸ¥è¯†çš„æ—¶å€™ï¼Œå¦‚æœèƒ½å¤Ÿå’Œå¤´è„‘ä¸­å·²æœ‰çš„çŸ¥è¯†è”ç³»èµ·æ¥ï¼Œå¤§è„‘ç¥ç»å…ƒä¹‹é—´çš„è¿æ¥å°±ä¼šè¢«æ¿€æ´»ï¼Œå­¦ä¹ çš„æ•ˆæœä¼šäº‹åŠåŠŸå€ã€‚</p><p>å›å¿†ä¸€ä¸‹åŒæ­¥ç¯å¢ƒéƒ½æœ‰å“ªäº›ç»“æ„å’Œ traitå‘¢ï¼Ÿé¦–å…ˆï¼Œå•ä¸ªçš„å€¼å¯ä»¥ç”¨ç±»å‹ T è¡¨è¿°ï¼Œä¸€ç»„å€¼å¯ä»¥ç”¨ Iterator trait è¡¨è¿°ï¼›åŒæ­¥ IOï¼Œæˆ‘ä»¬æœ‰æ ‡å‡†çš„ Read/Write/Seek traitã€‚é¡¾åæ€ä¹‰ï¼ŒRead/Write æ˜¯è¿›è¡Œ IO çš„è¯»å†™ï¼Œè€Œ Seek æ˜¯åœ¨ IO ä¸­å‰åç§»åŠ¨å½“å‰çš„ä½ç½®ã€‚</p><p>é‚£ä¹ˆå¼‚æ­¥å‘¢ï¼Ÿæˆ‘ä»¬å·²ç»å­¦ä¹ åˆ°ï¼Œå¯¹äºå•ä¸ªçš„ã€åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»ä¼šå¾—åˆ°çš„å€¼ï¼Œå¯ä»¥ç”¨ Future æ¥è¡¨ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/23/43/2371c456d1d7429caea5512f53ec5c43.jpg?wh=1920x1145\" alt=\"å›¾ç‰‡\"></p><p>ä½†è¿˜ä¸çŸ¥é“ä¸€ç»„æœªæ¥æ‰èƒ½å¾—åˆ°çš„å€¼è¯¥ç”¨ä»€ä¹ˆ trait æ¥è¡¨è¿°ï¼Œä¹Ÿä¸çŸ¥é“å¼‚æ­¥çš„ Read/Write è¯¥æ˜¯ä»€ä¹ˆæ ·å­ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥èŠèŠè¿™äº›é‡è¦çš„å¼‚æ­¥æ•°æ®ç±»å‹ã€‚</p><h2>Stream trait</h2><p>é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ Iterator åœ¨å¼‚æ­¥ç¯å¢ƒä¸‹çš„è¡¨å…„å¼Ÿï¼šStreamã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äº Iteratorï¼Œå¯ä»¥ä¸æ–­è°ƒç”¨å…¶ next() æ–¹æ³•ï¼Œè·å¾—æ–°çš„å€¼ï¼Œç›´åˆ° Iterator è¿”å› Noneã€‚Iterator æ˜¯é˜»å¡å¼è¿”å›æ•°æ®çš„ï¼Œæ¯æ¬¡è°ƒç”¨ next()ï¼Œå¿…ç„¶ç‹¬å  CPU ç›´åˆ°å¾—åˆ°ä¸€ä¸ªç»“æœï¼Œ<strong>è€Œå¼‚æ­¥çš„ Stream æ˜¯éé˜»å¡çš„ï¼Œåœ¨ç­‰å¾…çš„è¿‡ç¨‹ä¸­ä¼šç©ºå‡º CPU åšå…¶ä»–äº‹æƒ…</strong>ã€‚</p><!-- [[[read_end]]] --><p>ä¸è¿‡å’Œ Future å·²ç»åœ¨æ ‡å‡†åº“ç¨³å®šä¸‹æ¥ä¸åŒï¼ŒStream trait ç›®å‰è¿˜åªèƒ½åœ¨ nightly ç‰ˆæœ¬ä½¿ç”¨ã€‚ä¸€èˆ¬è·Ÿ Stream æ‰“äº¤é“ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ futures åº“ã€‚æ¥å¯¹æ¯” Iterator å’Œ Streamçš„æºç å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait Iterator {\n    type Item;\n    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;;\n\n    fn size_hint(&amp;self) -&gt; (usize, Option&lt;usize&gt;) { ... }\n    fn map&lt;B, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt; where F: FnMut(Self::Item) -&gt; B { ... }\n    ... // è¿˜æœ‰ 67 ä¸ªæ–¹æ³•\n}\n\npub trait Stream {\n    type Item;\n    fn poll_next(self: Pin&lt;&amp;mut Self&gt;,  cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt;;\n\n    fn size_hint(&amp;self) -&gt; (usize, Option&lt;usize&gt;) { ... }\n}\n\npub trait StreamExt: Stream {\n    fn next(&amp;mut self) -&gt; Next&lt;'_, Self&gt; where Self: Unpin { ... }\n    fn map&lt;T, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt; where F: FnMut(Self::Item) -&gt; T { ... }\n    ... // è¿˜æœ‰ 41 ä¸ªæ–¹æ³•\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒIterator æŠŠæ‰€æœ‰æ–¹æ³•éƒ½æ”¾åœ¨ Iterator trait é‡Œï¼Œè€ŒStream æŠŠéœ€è¦å¼€å‘è€…å®ç°çš„åŸºæœ¬æ–¹æ³•å’Œæœ‰ç¼ºçœå®ç°çš„è¡ç”Ÿæ–¹æ³•åŒºåˆ«å¼€ï¼Œæ”¾åœ¨ä¸åŒçš„ trait é‡Œã€‚æ¯”å¦‚ mapã€‚</p><p>å®ç° Stream çš„æ—¶å€™ï¼Œå’Œ Iterator ç±»ä¼¼ï¼Œä½ éœ€è¦æä¾› Item ç±»å‹ï¼Œè¿™æ˜¯æ¯æ¬¡æ‹¿å‡ºä¸€ä¸ªå€¼æ—¶ï¼Œå€¼çš„ç±»å‹ï¼›æ­¤å¤–ï¼Œè¿˜æœ‰ poll_next() æ–¹æ³•ï¼Œå®ƒé•¿å¾—å’Œ Future çš„ poll() æ–¹æ³•å¾ˆåƒï¼Œå’Œ Iterator ç‰ˆæœ¬çš„ next() çš„ä½œç”¨ç±»ä¼¼ã€‚</p><p>ç„¶è€Œï¼Œpoll_next() è°ƒç”¨èµ·æ¥ä¸æ–¹ä¾¿ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å¤„ç† Poll çŠ¶æ€ï¼Œæ‰€ä»¥ï¼ŒStreamExt æä¾›äº† next() æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå®ç°äº† Future trait çš„ Next ç»“æ„ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡ stream.next().await æ¥è·å–ä¸‹ä¸€ä¸ªå€¼äº†ã€‚æ¥çœ‹ next() æ–¹æ³•ä»¥åŠ Next ç»“æ„çš„å®ç°ï¼ˆ<a href=\"https://docs.rs/futures-util/0.3.17/src/futures_util/stream/stream/next.rs.html#10-34\">æºç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">pub trait StreamExt: Stream {\n    fn next(&amp;mut self) -&gt; Next&lt;'_, Self&gt; where Self: Unpin {\n        assert_future::&lt;Option&lt;Self::Item&gt;, _&gt;(Next::new(self))\n    }\n}\n\n// next è¿”å›äº† Next ç»“æ„\npub struct Next&lt;'a, St: ?Sized&gt; {\n    stream: &amp;'a mut St,\n}\n\n// å¦‚æœ Stream Unpin é‚£ä¹ˆ Next ä¹Ÿæ˜¯ Unpin\nimpl&lt;St: ?Sized + Unpin&gt; Unpin for Next&lt;'_, St&gt; {}\n\nimpl&lt;'a, St: ?Sized + Stream + Unpin&gt; Next&lt;'a, St&gt; {\n    pub(super) fn new(stream: &amp;'a mut St) -&gt; Self {\n        Self { stream }\n    }\n}\n\n// Next å®ç°äº† Futureï¼Œæ¯æ¬¡ poll() å®é™…ä¸Šå°±æ˜¯ä» stream ä¸­ poll_next()\nimpl&lt;St: ?Sized + Stream + Unpin&gt; Future for Next&lt;'_, St&gt; {\n    type Output = Option&lt;St::Item&gt;;\n\n    fn poll(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {\n        self.stream.poll_next_unpin(cx)\n    }\n}\n</code></pre><p>çœ‹ä¸ªå°ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=4374c885eaf1a386fe6a67d8a54dc37b\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use futures::prelude::*;\n\n#[tokio::main]\nasync fn main() {\n    let mut st = stream::iter(1..10)\n        .filter(|x| future::ready(x % 2 == 0))\n        .map(|x| x * x);\n\n    while let Some(x) = st.next().await {\n        println!(\"Got item: {}\", x);\n    }\n}\n</code></pre><p>æˆ‘ä»¬ä½¿ç”¨ stream::iter ç”Ÿæˆäº†ä¸€ä¸ª Streamï¼Œå¹¶å¯¹å…¶è¿›è¡Œ filter / map çš„æ“ä½œã€‚æœ€åï¼Œéå†æ•´ä¸ª streamï¼ŒæŠŠè·å¾—çš„æ•°æ®æ‰“å°å‡ºæ¥ã€‚ä»ä½¿ç”¨çš„æ„Ÿå—æ¥çœ‹ï¼ŒStream å’Œ Iterator ä¹Ÿå¾ˆç›¸ä¼¼ï¼Œå¯ä»¥å¯¹æ¯”ç€æ¥ç”¨ã€‚</p><h3>ç”Ÿæˆ Stream</h3><p>futures åº“æä¾›äº†ä¸€äº›åŸºæœ¬çš„ç”Ÿæˆ Stream çš„æ–¹æ³•ï¼Œé™¤äº†ä¸Šé¢ç”¨åˆ°çš„ iter æ–¹æ³•ï¼Œè¿˜æœ‰ï¼š</p><ul>\n<li>empty()ï¼šç”Ÿæˆä¸€ä¸ªç©ºçš„ Stream</li>\n<li>once()ï¼šç”Ÿæˆä¸€ä¸ªåªåŒ…å«å•ä¸ªå€¼çš„ Stream</li>\n<li>pending()ï¼šç”Ÿæˆä¸€ä¸ªä¸åŒ…å«ä»»ä½•å€¼ï¼Œåªè¿”å› Poll::Pending çš„ Stream</li>\n<li>repeat()ï¼šç”Ÿæˆä¸€ä¸ªä¸€ç›´è¿”å›ç›¸åŒå€¼çš„ Stream</li>\n<li>repeat_with()ï¼šé€šè¿‡é—­åŒ…å‡½æ•°æ— ç©·å°½åœ°è¿”å›æ•°æ®çš„ Stream</li>\n<li>poll_fn()ï¼šé€šè¿‡ä¸€ä¸ªè¿”å› Poll&lt;Option&lt;T&gt;&gt; çš„é—­åŒ…æ¥äº§ç”Ÿ Stream</li>\n<li>unfold()ï¼šé€šè¿‡åˆå§‹å€¼å’Œè¿”å› Future çš„é—­åŒ…æ¥äº§ç”Ÿ Stream</li>\n</ul><p>å‰å‡ ç§äº§ç”Ÿ Stream çš„æ–¹æ³•éƒ½å¾ˆå¥½ç†è§£ï¼Œæœ€åä¸‰ç§å¼•å…¥äº†é—­åŒ…å¤æ‚ä¸€ç‚¹ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨å®ƒä»¬æ¥å®ç°æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œå¯¹æ¯”ä¸€ä¸‹å·®å¼‚ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=d83d2877d953b381c4f412b5768288ff\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use futures::{prelude::*, stream::poll_fn};\nuse std::task::Poll;\n\n#[tokio::main]\nasync fn main() {\n    consume(fib().take(10)).await;\n    consume(fib1(10)).await;\n    // unfold äº§ç”Ÿçš„ Unfold stream æ²¡æœ‰å®ç° Unpinï¼Œ\n    // æ‰€ä»¥æˆ‘ä»¬å°†å…¶ Pin&lt;Box&lt;T&gt;&gt; ä¸€ä¸‹ï¼Œä½¿å…¶æ»¡è¶³ consume çš„æ¥å£\n    consume(fib2(10).boxed()).await;\n}\n\nasync fn consume(mut st: impl Stream&lt;Item = i32&gt; + Unpin) {\n    while let Some(v) = st.next().await {\n        print!(\"{} \", v);\n    }\n    print!(\"\\\\n\");\n}\n\n// ä½¿ç”¨ repeat_with åˆ›å»º streamï¼Œæ— æ³•æ§åˆ¶ä½•æ—¶ç»“æŸ\nfn fib() -&gt; impl Stream&lt;Item = i32&gt; {\n    let mut a = 1;\n    let mut b = 1;\n    stream::repeat_with(move || {\n        let c = a + b;\n        a = b;\n        b = c;\n        b\n    })\n}\n\n// ä½¿ç”¨ poll_fn åˆ›å»º streamï¼Œå¯ä»¥é€šè¿‡è¿”å› Poll::Ready(None) æ¥ç»“æŸ\nfn fib1(mut n: usize) -&gt; impl Stream&lt;Item = i32&gt; {\n    let mut a = 1;\n    let mut b = 1;\n    poll_fn(move |_cx| -&gt; Poll&lt;Option&lt;i32&gt;&gt; {\n        if n == 0 {\n            return Poll::Ready(None);\n        }\n        n -= 1;\n        let c = a + b;\n        a = b;\n        b = c;\n        Poll::Ready(Some(b))\n    })\n}\n\nfn fib2(n: usize) -&gt; impl Stream&lt;Item = i32&gt; {\n    stream::unfold((n, (1, 1)), |(mut n, (a, b))| async move {\n        if n == 0 {\n            None\n        } else {\n            n -= 1;\n            let c = a + b;\n            // c ä½œä¸º poll_next() çš„è¿”å›å€¼ï¼Œ(n, (a, b)) ä½œä¸º state\n            Some((c, (n, (b, c))))\n        }\n    })\n}\n</code></pre><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<strong>ä½¿ç”¨ unfold çš„æ—¶å€™ï¼ŒåŒæ—¶ä½¿ç”¨äº†å±€éƒ¨å˜é‡å’Œ Futureï¼Œæ‰€ä»¥ç”Ÿæˆçš„ Stream æ²¡æœ‰å®ç° Unpin</strong>ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦å°†å…¶ pin ä½ã€‚æ€ä¹ˆåšå‘¢ï¼Ÿ</p><p>Pin&lt;Box&lt;T&gt;&gt; æ˜¯ä¸€ç§å¾ˆç®€å•çš„æ–¹æ³•ï¼Œèƒ½å°†æ•°æ® Pin åœ¨å †ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ StreamExt çš„ boxed() æ–¹æ³•æ¥ç”Ÿæˆä¸€ä¸ª Pin&lt;Box&lt;T&gt;&gt;ã€‚</p><p>é™¤äº†ä¸Šé¢è®²çš„æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸ºä¸€ä¸ªæ•°æ®ç»“æ„å®ç° Stream traitï¼Œä»è€Œä½¿å…¶æ”¯æŒ Streamã€‚çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=94797b51e031dbde9d81ff04c5ff9f83\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use futures::prelude::*;\nuse pin_project::pin_project;\nuse std::{\n    pin::Pin,\n    task::{Context, Poll},\n};\nuse tokio::{\n    fs,\n    io::{AsyncBufReadExt, AsyncRead, BufReader, Lines},\n};\n\n/// LineStream å†…éƒ¨ä½¿ç”¨ tokio::io::Lines\n#[pin_project]\nstruct LineStream&lt;R&gt; {\n    #[pin]\n    lines: Lines&lt;BufReader&lt;R&gt;&gt;,\n}\n\nimpl&lt;R: AsyncRead&gt; LineStream&lt;R&gt; {\n    /// ä» BufReader åˆ›å»ºä¸€ä¸ª LineStream\n    pub fn new(reader: BufReader&lt;R&gt;) -&gt; Self {\n        Self {\n            lines: reader.lines(),\n        }\n    }\n}\n\n/// ä¸º LineStream å®ç° Stream trait\nimpl&lt;R: AsyncRead&gt; Stream for LineStream&lt;R&gt; {\n    type Item = std::io::Result&lt;String&gt;;\n\n    fn poll_next(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt; {\n        self.project()\n            .lines\n            .poll_next_line(cx)\n            .map(Result::transpose)\n    }\n}\n\n#[tokio::main]\nasync fn main() -&gt; std::io::Result&lt;()&gt; {\n    let file = fs::File::open(\"Cargo.toml\").await?;\n    let reader = BufReader::new(file);\n    let mut st = LineStream::new(reader);\n    while let Some(Ok(line)) = st.next().await {\n        println!(\"Got: {}\", line);\n    }\n\n    Ok(())\n}\n</code></pre><p>è¿™æ®µä»£ç å°è£…äº† <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/struct.Lines.html\">Lines</a> ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/trait.AsyncBufReadExt.html#\">AsyncBufReadExt</a> çš„ <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/trait.AsyncBufReadExt.html#method.lines\">lines()</a> æ–¹æ³•ï¼ŒæŠŠä¸€ä¸ªå®ç°äº† <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/trait.AsyncBufRead.html\">AsyncBufRead</a> trait çš„ reader è½¬æ¢æˆ Linesã€‚</p><p>ä½ ä¹Ÿè®¸æ³¨æ„åˆ°ä»£ç ä¸­å¼•å…¥çš„ <a href=\"https://docs.rs/pin-project\">pin_project</a> åº“ï¼Œå®ƒæä¾›äº†ä¸€äº›ä¾¿åˆ©çš„å®ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ“ä½œæ•°æ®ç»“æ„é‡Œéœ€è¦è¢« pin ä½çš„å­—æ®µã€‚åœ¨æ•°æ®ç»“æ„ä¸­ï¼Œ<strong>å¯ä»¥ä½¿ç”¨ #[pin] æ¥å£°æ˜æŸä¸ªå­—æ®µåœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦è¢«å°è£…ä¸º Pin&lt;T&gt;</strong>ã€‚è¿™æ ·ï¼Œè°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ self.project().lines å¾—åˆ°ä¸€ä¸ª Pin&lt;&amp;mut Lines&gt;ï¼Œä»¥ä¾¿è°ƒç”¨å…¶ <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/struct.Lines.html#method.poll_next_line\">poll_next_line()</a> æ–¹æ³•ï¼ˆè¿™ä¸ªæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Pin&lt;&amp;mut Self&gt;ï¼‰ã€‚</p><p>åœ¨Linesè¿™ä¸ªç»“æ„å†…éƒ¨ï¼Œå¼‚æ­¥çš„ <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/struct.Lines.html#method.next_line\">next_line()</a> æ–¹æ³•å¯ä»¥è¯»å–ä¸‹ä¸€è¡Œï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯æ¯”è¾ƒä½é˜¶çš„ <a href=\"https://docs.rs/tokio/1.14.0/src/tokio/io/util/lines.rs.html#112-134\">poll_next_line()</a> æ¥å£çš„ä¸€ä¸ªå°è£…ã€‚</p><p><strong>è™½ç„¶ Lines ç»“æ„æä¾›äº† next_line()ï¼Œä½†å¹¶æ²¡æœ‰å®ç° Stream</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•åƒå…¶ä»– Stream é‚£æ ·ç»Ÿä¸€ç”¨ next() æ–¹æ³•è·å–ä¸‹ä¸€è¡Œã€‚äºæ˜¯ï¼Œæˆ‘ä»¬å°†å…¶åŒ…è£¹åœ¨è‡ªå·±çš„ LineStream ä¸‹ï¼Œå¹¶ä¸”ä¸º LineStream å®ç°äº† Stream æ–¹æ³•ã€‚</p><p>æ³¨æ„ï¼Œç”±äº poll_next_line() çš„ç»“æœæ˜¯ Result&lt;Option&lt;T&gt;&gt;ï¼Œè€Œ Stream çš„ poll_next() çš„ç»“æœæ˜¯ Option&lt;Result&lt;T&gt;&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ Result æ–¹æ³•çš„ <a href=\"https://doc.rust-lang.org/std/result/enum.Result.html#method.transpose\">transpose</a> æ¥å°†äºŒè€…å¯¹è°ƒã€‚è¿™ä¸ªtranspose æ–¹æ³•æ˜¯ä¸€ä¸ªå¾ˆåŸºç¡€çš„æ–¹æ³•ï¼Œéå¸¸å®ç”¨ã€‚</p><h2>å¼‚æ­¥ IO æ¥å£</h2><p>åœ¨å®ç° LineStream æ—¶ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸¤ä¸ªå¼‚æ­¥ I/O æ¥å£ï¼šAsyncRead ä»¥åŠ AsyncBufReadã€‚å›åˆ°å¼€å¤´çš„é‚£å¼ è¡¨ï¼Œç›¸ä¿¡ä½ ç°åœ¨å·²ç»æœ‰å¤§è‡´ç­”æ¡ˆäº†å§ï¼š<strong>æ‰€æœ‰åŒæ­¥çš„ Read / Write / Seek traitï¼Œå‰é¢åŠ ä¸€ä¸ª Asyncï¼Œå°±æ„æˆäº†å¯¹åº”çš„å¼‚æ­¥ IO æ¥å£</strong>ã€‚</p><p>ä¸è¿‡ï¼Œå’Œ Stream ä¸åŒçš„æ˜¯ï¼Œå¦‚æœä½ å¯¹æ¯” futures ä¸‹å®šä¹‰çš„ IO trait ä»¥åŠ tokio ä¸‹å®šä¹‰çš„ IO traitï¼Œä¼šå‘ç°å®ƒä»¬éƒ½æœ‰å„è‡ªçš„å®šä¹‰ï¼ŒåŒæ–¹å¹¶æœªç»Ÿä¸€ï¼Œæœ‰äº›è®¸çš„å·®åˆ«ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/da/28/da47e6ae335b4c46719afc64b5a60e28.jpg?wh=1920x1145\" alt=\"å›¾ç‰‡\"></p><p>æ¯”å¦‚ futures ä¸‹ <a href=\"https://docs.rs/futures/0.3.17/futures/io/trait.AsyncRead.html\">AsyncRead</a> çš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait AsyncRead {\n    fn poll_read(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;, \n        buf: &amp;mut [u8]\n    ) -&gt; Poll&lt;Result&lt;usize, Error&gt;&gt;;\n\n    unsafe fn initializer(&amp;self) -&gt; Initializer { ... }\n    fn poll_read_vectored(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;, \n        bufs: &amp;mut [IoSliceMut&lt;'_&gt;]\n    ) -&gt; Poll&lt;Result&lt;usize, Error&gt;&gt; { ... }\n}\n</code></pre><p>è€Œ tokio ä¸‹ <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/trait.AsyncRead.html\">AsyncRead</a> çš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait AsyncRead {\n    fn poll_read(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;, \n        buf: &amp;mut ReadBuf&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;()&gt;&gt;;\n}\n</code></pre><p>æˆ‘ä»¬çœ‹ä¸åŒä¹‹å¤„ï¼štokio çš„ poll_read() æ–¹æ³•éœ€è¦ <a href=\"https://docs.rs/tokio/1.14.0/src/tokio/io/read_buf.rs.html#27-31\">ReadBuf</a>ï¼Œè€Œ futures çš„ poll_read() æ–¹æ³•éœ€è¦ &amp;mut [u8]ã€‚æ­¤å¤–ï¼Œfutures çš„ AsyncRead è¿˜å¤šäº†ä¸¤ä¸ªç¼ºçœæ–¹æ³•ã€‚</p><p>å†çœ‹ AsyncWriteã€‚futures ä¸‹çš„ <a href=\"https://docs.rs/futures/0.3.17/futures/io/trait.AsyncWrite.html\">AsyncWrite</a> æ¥å£å¦‚ä¸‹ï¼š</p><pre><code class=\"language-rust\">pub trait AsyncWrite {\n    fn poll_write(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;, \n        buf: &amp;[u8]\n    ) -&gt; Poll&lt;Result&lt;usize, Error&gt;&gt;;\n    fn poll_flush(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Error&gt;&gt;;\n    fn poll_close(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Error&gt;&gt;;\n\n    fn poll_write_vectored(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;, \n        bufs: &amp;[IoSlice&lt;'_&gt;]\n    ) -&gt; Poll&lt;Result&lt;usize, Error&gt;&gt; { ... }\n}\n</code></pre><p>è€Œ tokio ä¸‹çš„ <a href=\"https://docs.rs/tokio/1.14.0/tokio/io/trait.AsyncWrite.html\">AsyncWrite</a> çš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait AsyncWrite {\n    fn poll_write(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;, \n        buf: &amp;[u8]\n    ) -&gt; Poll&lt;Result&lt;usize, Error&gt;&gt;;\n    fn poll_flush(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Error&gt;&gt;;\n    fn poll_shutdown(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Error&gt;&gt;;\n\n    fn poll_write_vectored(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;, \n        bufs: &amp;[IoSlice&lt;'_&gt;]\n    ) -&gt; Poll&lt;Result&lt;usize, Error&gt;&gt; { ... }\n    fn is_write_vectored(&amp;self) -&gt; bool { ... }\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒAsyncWrite äºŒè€…çš„å·®è·å°±åªæœ‰ poll_close() å’Œ poll_shutdown() å‘½åä¸Šçš„åˆ†åˆ«ã€‚å…¶å®ƒçš„å¼‚æ­¥ IO æ¥å£æˆ‘å°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ï¼Œä½ å¯ä»¥è‡ªå·±å»çœ‹ä»£ç å¯¹æ¯”ã€‚</p><h3>å¼‚æ­¥ IO æ¥å£çš„å…¼å®¹æ€§å¤„ç†</h3><p>ä¸ºä»€ä¹ˆ Rust çš„å¼‚æ­¥ IO trait ä¼šæœ‰è¿™æ ·çš„åˆ†è£‚ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨ tokio / futures åº“å®ç°çš„æ—©æœŸï¼Œç¤¾åŒºè¿˜æ²¡æœ‰å½¢æˆæ¯”è¾ƒç»Ÿä¸€çš„å¼‚æ­¥ IO traitï¼Œä¸åŒçš„æ¥å£èƒŒåä¹Ÿæœ‰å„è‡ªä¸åŒçš„è€ƒè™‘ï¼Œè¿™ç§åˆ†è£‚å°±æ²¿è¢­ä¸‹æ¥ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ tokio è¿›è¡Œå¼‚æ­¥å¼€å‘ï¼Œé‚£ä¹ˆï¼Œä»£ç éœ€è¦ä½¿ç”¨ tokio::io ä¸‹çš„å¼‚æ­¥ IO traitã€‚ä¹Ÿè®¸ï¼Œæœªæ¥ç­‰ Async IO trait ç¨³å®šå¹¶è¿›å…¥æ ‡å‡†åº“åï¼Œtokio ä¼šæ›´æ–°è‡ªå·±çš„ traitã€‚</p><p>è™½ç„¶ Rust çš„å¼‚æ­¥ IO trait æœ‰è¿™æ ·çš„åˆ†è£‚ï¼Œä½ ä¹Ÿä¸å¿…è¿‡åˆ†æ‹…å¿ƒã€‚<strong>tokio-util æä¾›äº†ç›¸åº”çš„</strong><a href=\"https://docs.rs/tokio-util/0.6.9/tokio_util/compat/index.html\">Compat</a><strong>åŠŸèƒ½ï¼Œå¯ä»¥è®©ä½ çš„æ•°æ®ç»“æ„åœ¨äºŒè€…ä¹‹é—´è‡ªå¦‚åˆ‡æ¢</strong>ã€‚çœ‹ä¸€ä¸ªä½¿ç”¨ <a href=\"https://docs.rs/yamux\">yamux</a> åšå¤šè·¯å¤ç”¨çš„ä¾‹å­ï¼Œé‡ç‚¹ä½ç½®è¯¦ç»†æ³¨é‡Šäº†ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse futures::prelude::*;\nuse tokio::net::TcpListener;\nuse tokio_util::{\n    codec::{Framed, LinesCodec},\n    compat::{FuturesAsyncReadCompatExt, TokioAsyncReadCompatExt},\n};\nuse tracing::info;\nuse yamux::{Config, Connection, Mode, WindowUpdateMode};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    tracing_subscriber::fmt::init();\n    let addr = \"0.0.0.0:8080\";\n    let listener = TcpListener::bind(addr).await?;\n    info!(\"Listening on: {:?}\", addr);\n    loop {\n        let (stream, addr) = listener.accept().await?;\n        info!(\"Accepted: {:?}\", addr);\n        let mut config = Config::default();\n        config.set_window_update_mode(WindowUpdateMode::OnRead);\n        // ä½¿ç”¨ compat() æ–¹æ³•æŠŠ tokio AsyncRead/AsyncWrite è½¬æ¢æˆ futures å¯¹åº”çš„ trait\n        let conn = Connection::new(stream.compat(), config, Mode::Server);\n        // Yamux ctrl stream å¯ä»¥ç”¨æ¥æ‰“å¼€æ–°çš„ stream\n        let _ctrl = conn.control();\n        tokio::spawn(\n            yamux::into_stream(conn).try_for_each_concurrent(None, move |s| async move {\n                // ä½¿ç”¨ compat() æ–¹æ³•æŠŠ futures AsyncRead/AsyncWrite è½¬æ¢æˆ tokio å¯¹åº”çš„ trait\n                let mut framed = Framed::new(s.compat(), LinesCodec::new());\n                while let Some(Ok(line)) = framed.next().await {\n                    println!(\"Got: {}\", line);\n                    framed\n                        .send(format!(\"Hello! I got '{}'\", line))\n                        .await\n                        .unwrap();\n                }\n\n                Ok(())\n            }),\n        );\n    }\n}\n</code></pre><p>yamux æ˜¯ä¸€ä¸ªç±»ä¼¼ HTTP/2 å†…éƒ¨å¤šè·¯å¤ç”¨æœºåˆ¶çš„åè®®ï¼Œå¯ä»¥è®©ä½ åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸Šæ‰“å¼€å¤šä¸ªé€»è¾‘ yamux streamï¼Œè€Œyamux stream ä¹‹é—´å¹¶è¡Œå·¥ä½œï¼Œäº’ä¸å¹²æ‰°ã€‚</p><p>yamux crate åœ¨å®ç°çš„æ—¶å€™ï¼Œä½¿ç”¨äº† futures ä¸‹çš„å¼‚æ­¥ IO æ¥å£ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨ tokio Listener æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¾—åˆ°å¯¹åº”çš„ TcpStream æ—¶ï¼Œè¿™ä¸ª TcpStream ä½¿ç”¨çš„æ˜¯ tokio ä¸‹çš„å¼‚æ­¥ IO æ¥å£ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ tokio_util::compat æ¥ååŠ©æ¥å£çš„å…¼å®¹ã€‚</p><p>åœ¨ä»£ç ä¸­ï¼Œé¦–å…ˆæˆ‘ç”¨ stream.compat() ç”Ÿæˆä¸€ä¸ª Compat<tcpstream> ç»“æ„ï¼Œä¾› yamux Connection ä½¿ç”¨ï¼š</tcpstream></p><pre><code class=\"language-rust\">let conn = Connection::new(stream.compat(), config, Mode::Server);\n</code></pre><p>ä¹‹åï¼Œæ‹¿åˆ° yamux connection ä¸‹æ‰€æœ‰ stream è¿›è¡Œå¤„ç†æ—¶ï¼Œæˆ‘ä»¬æƒ³ç”¨ tokio çš„ Frame å’Œ Codec ä¸€è¡Œè¡Œè¯»å–å’Œå†™å…¥ï¼Œä¹Ÿå°±éœ€è¦æŠŠä½¿ç”¨ futures å¼‚æ­¥æ¥å£çš„ yamux streamï¼Œè½¬æ¢æˆä½¿ç”¨ tokio æ¥å£çš„æ•°æ®ç»“æ„ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨åœ¨ Framed::new() ä¸­ï¼š</p><pre><code class=\"language-rust\">let mut framed = Framed::new(s.compat(), LinesCodec::new());\n</code></pre><p>å¦‚æœä½ æƒ³è¿è¡Œè¿™æ®µä»£ç ï¼Œå¯ä»¥çœ‹è¿™é—¨è¯¾çš„ <a href=\"https://github.com/tyrchen/geektime-rust\">GitHub repo</a> ä¸‹çš„å®Œæ•´ç‰ˆï¼ŒåŒ…æ‹¬ä¾èµ–ä»¥åŠå®¢æˆ·ç«¯çš„ä»£ç ã€‚</p><h3>å®ç°å¼‚æ­¥ IO æ¥å£</h3><p>å¼‚æ­¥ IO ä¸»è¦åº”ç”¨åœ¨æ–‡ä»¶å¤„ç†ã€ç½‘ç»œå¤„ç†ç­‰åœºåˆï¼Œè€Œè¿™äº›åœºåˆçš„æ•°æ®ç»“æ„éƒ½å·²ç»å®ç°äº†å¯¹åº”çš„æ¥å£ï¼Œæ¯”å¦‚ File æˆ–è€… TcpStreamï¼Œå®ƒä»¬ä¹Ÿå·²ç»å®ç°äº† AsyncRead / AsyncWriteã€‚æ‰€ä»¥åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬ä¸ç”¨è‡ªå·±å®ç°å¼‚æ­¥ IO æ¥å£ï¼Œåªéœ€è¦ä¼šç”¨å°±å¯ä»¥äº†ã€‚</p><p>ä¸è¿‡æœ‰äº›æƒ…å†µï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæŠŠå·²æœ‰çš„æ•°æ®ç»“æ„å°è£…åœ¨è‡ªå·±çš„æ•°æ®ç»“æ„ä¸­ï¼Œæ­¤æ—¶ï¼Œä¹Ÿåº”è¯¥å®ç°ç›¸åº”çš„å¼‚æ­¥ IO æ¥å£ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b53409b4ad26aaf078d4799bfe95f65c\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse pin_project::pin_project;\nuse std::{\n    pin::Pin,\n    task::{Context, Poll},\n};\nuse tokio::{\n    fs::File,\n    io::{AsyncRead, AsyncReadExt, ReadBuf},\n};\n\n#[pin_project]\nstruct FileWrapper {\n    #[pin]\n    file: File,\n}\n\nimpl FileWrapper {\n    pub async fn try_new(name: &amp;str) -&gt; Result&lt;Self&gt; {\n        let file = File::open(name).await?;\n        Ok(Self { file })\n    }\n}\n\nimpl AsyncRead for FileWrapper {\n    fn poll_read(\n        self: Pin&lt;&amp;mut Self&gt;,\n        cx: &amp;mut Context&lt;'_&gt;,\n        buf: &amp;mut ReadBuf&lt;'_&gt;,\n    ) -&gt; Poll&lt;std::io::Result&lt;()&gt;&gt; {\n        self.project().file.poll_read(cx, buf)\n    }\n}\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let mut file = FileWrapper::try_new(\"./Cargo.toml\").await?;\n    let mut buffer = String::new();\n    file.read_to_string(&amp;mut buffer).await?;\n    println!(\"{}\", buffer);\n    Ok(())\n}\n</code></pre><p>è¿™æ®µä»£ç å°è£…äº† tokio::fs::File ç»“æ„ï¼Œæˆ‘ä»¬æƒ³è¯»å–å†…éƒ¨çš„ file å­—æ®µï¼Œä½†åˆä¸æƒ³æŠŠ File æš´éœ²å‡ºæ¥ï¼Œå› æ­¤å®ç°äº† AsyncRead traitã€‚</p><h2>Sink trait</h2><p>åœ¨åŒæ­¥ç¯å¢ƒä¸‹å¾€ IO ä¸­å‘é€è¿ç»­çš„æ•°æ®ï¼Œå¯ä»¥ä¸€æ¬¡æ€§å‘é€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Write trait å¤šæ¬¡å‘é€ï¼Œä½¿ç”¨èµ·æ¥å¹¶æ²¡æœ‰ä»€ä¹ˆéº»çƒ¦ï¼›ä½†åœ¨å¼‚æ­¥ IO ä¸‹ï¼ŒåšåŒæ ·çš„äº‹æƒ…ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–¹ä¾¿çš„æ¥å£ã€‚å› æ­¤å¼‚æ­¥IOè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒç‹¬ç‰¹çš„ Sink traitï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨äºå‘é€ä¸€ç³»åˆ—å¼‚æ­¥å€¼çš„æ¥å£ã€‚</p><p>çœ‹ Sink trait çš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait Sink&lt;Item&gt; {\n    type Error;\n    fn poll_ready(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;\n    fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Item) -&gt; Result&lt;(), Self::Error&gt;;\n    fn poll_flush(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;\n    fn poll_close(\n        self: Pin&lt;&amp;mut Self&gt;, \n        cx: &amp;mut Context&lt;'_&gt;\n    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;\n}\n\npub trait SinkExt&lt;Item&gt;: Sink&lt;Item&gt; {\n    ...\n    fn send(&amp;mut self, item: Item) -&gt; Send&lt;'_, Self, Item&gt; where Self: Unpin { ... }\n    ...\n}\n</code></pre><p>å’Œ Stream trait ä¸åŒçš„æ˜¯ï¼ŒSink trait çš„ Item æ˜¯ trait çš„æ³›å‹å‚æ•°ï¼Œè€Œä¸æ˜¯å…³è”ç±»å‹ã€‚<strong>ä¸€èˆ¬è€Œè¨€ï¼Œå½“ trait æ¥å—æŸä¸ª inputï¼Œåº”è¯¥ä½¿ç”¨æ³›å‹å‚æ•°ï¼Œæ¯”å¦‚ Add&lt;Rhs&gt;ï¼›å½“å®ƒè¾“å‡ºæŸä¸ª outputï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨å…³è”ç±»å‹ï¼Œæ¯”å¦‚ Futureã€Streamã€Iterator ç­‰</strong>ã€‚</p><p>Item å¯¹äº Sink æ¥è¯´æ˜¯è¾“å…¥ï¼Œæ‰€ä»¥ä½¿ç”¨æ³›å‹å‚æ•°æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚å› ä¸ºè¿™ä¹Ÿæ„å‘³ç€ï¼Œåœ¨å‘é€ç«¯ï¼Œå¯ä»¥å‘é€ä¸åŒç±»å‹çš„æ•°æ®ç»“æ„ã€‚</p><p>çœ‹ä¸Šé¢çš„å®šä¹‰æºç ï¼ŒSink trait æœ‰å››ä¸ªæ–¹æ³•ï¼š</p><ul>\n<li>poll_ready()ï¼šç”¨æ¥å‡†å¤‡ Sink ä½¿å…¶å¯ä»¥å‘é€æ•°æ®ã€‚åªæœ‰ poll_ready() è¿”å› Poll::Ready(Ok(())) åï¼ŒSink æ‰ä¼šå¼€å±•åç»­çš„åŠ¨ä½œã€‚poll_ready() å¯ä»¥ç”¨æ¥æ§åˆ¶èƒŒå‹ã€‚</li>\n<li>start_send()ï¼šå¼€å§‹å‘é€æ•°æ®åˆ° Sinkã€‚ä½†æ˜¯start_send() å¹¶ä¸ä¿è¯æ•°æ®è¢«å‘é€å®Œæ¯•ï¼Œæ‰€ä»¥è°ƒç”¨è€…è¦è°ƒç”¨ poll_flush() æˆ–è€… poll_close() æ¥ä¿è¯å®Œæ•´å‘é€ã€‚</li>\n<li>poll_flush()ï¼šå°†ä»»ä½•å°šæœªå‘é€çš„æ•°æ® flush åˆ°è¿™ä¸ª Sinkã€‚</li>\n<li>poll_close()ï¼šå°†ä»»ä½•å°šæœªå‘é€çš„æ•°æ® flush åˆ°è¿™ä¸ª Sinkï¼Œå¹¶å…³é—­è¿™ä¸ª Sinkã€‚</li>\n</ul><p>å…¶ä¸­ä¸‰ä¸ªæ–¹æ³•å’Œ Item æ˜¯æ— å…³çš„ï¼Œè¿™ä¼šå¯¼è‡´ï¼Œå¦‚æœä¸åŒçš„è¾“å…¥ç±»å‹æœ‰å¤šä¸ªå®ç°ï¼ŒSinkçš„poll_readyã€poll_flush å’Œ poll_close å¯èƒ½ä¼šæœ‰é‡å¤çš„ä»£ç ã€‚æ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨ Sink æ—¶ï¼Œå¦‚æœç¡®å®éœ€è¦å¤„ç†ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ç”¨ enum å°†å®ƒä»¬ç»Ÿä¸€ï¼ˆæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è¿›ä¸€æ­¥é˜…è¯»è¿™ä¸ª<a href=\"https://github.com/rust-lang/futures-rs/issues/623\">è®¨è®º</a>ï¼‰ã€‚</p><p>æˆ‘ä»¬å°±ç”¨ä¸€ä¸ªç®€å•çš„ FileSink çš„ä¾‹å­ï¼Œçœ‹çœ‹å¦‚ä½•å®ç°è¿™äº›æ–¹æ³•ã€‚tokio::fs ä¸‹çš„ File ç»“æ„å·²ç»å®ç°äº† AsyncRead / AsyncWriteï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ Sink çš„å‡ ä¸ªæ–¹æ³•ä¸­è°ƒç”¨ AsyncWrite çš„æ–¹æ³•å³å¯ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b3aab166023b7478ccd947703f8f53cd\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse bytes::{BufMut, BytesMut};\nuse futures::{Sink, SinkExt};\nuse pin_project::pin_project;\nuse std::{\n    pin::Pin,\n    task::{Context, Poll},\n};\nuse tokio::{fs::File, io::AsyncWrite};\n\n#[pin_project]\nstruct FileSink {\n    #[pin]\n    file: File,\n    buf: BytesMut,\n}\n\nimpl FileSink {\n    pub fn new(file: File) -&gt; Self {\n        Self {\n            file,\n            buf: BytesMut::new(),\n        }\n    }\n}\n\nimpl Sink&lt;&amp;str&gt; for FileSink {\n    type Error = std::io::Error;\n\n    fn poll_ready(self: Pin&lt;&amp;mut Self&gt;, _cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n        Poll::Ready(Ok(()))\n    }\n\n    fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: &amp;str) -&gt; Result&lt;(), Self::Error&gt; {\n        let this = self.project();\n        eprint!(\"{}\", item);\n        this.buf.put(item.as_bytes());\n        Ok(())\n    }\n\n    fn poll_flush(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n        // å¦‚æœæƒ³ project() å¤šæ¬¡ï¼Œéœ€è¦å…ˆæŠŠ self reborrow ä¸€ä¸‹\n        let this = self.as_mut().project();\n        let buf = this.buf.split_to(this.buf.len());\n        if buf.is_empty() {\n            return Poll::Ready(Ok(()));\n        }\n\n        // å†™å…¥æ–‡ä»¶\n        if let Err(e) = futures::ready!(this.file.poll_write(cx, &amp;buf[..])) {\n            return Poll::Ready(Err(e));\n        }\n        // åˆ·æ–°æ–‡ä»¶\n        self.project().file.poll_flush(cx)\n    }\n\n    fn poll_close(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {\n        let this = self.project();\n        // ç»“æŸå†™å…¥\n        this.file.poll_shutdown(cx)\n    }\n}\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let file_sink = FileSink::new(File::create(\"/tmp/hello\").await?);\n    // pin_mut å¯ä»¥æŠŠå˜é‡ pin ä½\n    futures::pin_mut!(file_sink);\n    file_sink.send(\"hello\\\\n\").await?;\n    file_sink.send(\"world!\\\\n\").await?;\n    file_sink.send(\"Tyr!\\\\n\").await?;\n\n    Ok(())\n}\n</code></pre><p>å¯¹äº poll_ready() æ–¹æ³•ï¼Œç›´æ¥è¿”å› Poll::Ready(Ok(()))ã€‚</p><p>åœ¨ start_send() æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æŠŠä¼ å…¥çš„ itemï¼Œå†™å…¥ FileSink çš„ BytesMut ä¸­ã€‚ç„¶ååœ¨ poll_flush() æ—¶ï¼Œæˆ‘ä»¬æ‹¿åˆ° bufï¼ŒæŠŠå·²æœ‰çš„å†…å®¹è°ƒç”¨ <a href=\"https://docs.rs/bytes/1.1.0/bytes/struct.BytesMut.html#method.split_to\">split_to()</a>ï¼Œå¾—åˆ°ä¸€ä¸ªåŒ…å«æ‰€æœ‰æœªå†™å…¥æ–‡ä»¶çš„æ–° bufferã€‚è¿™ä¸ª buffer å’Œ self æ— å…³ï¼Œæ‰€ä»¥ä¼ å…¥ poll_write() æ—¶ï¼Œä¸ä¼šæœ‰å¯¹ self çš„å¼•ç”¨é—®é¢˜ã€‚</p><p>åœ¨å†™å…¥æ–‡ä»¶åï¼Œæˆ‘ä»¬å†æ¬¡è°ƒç”¨ poll_flush() ï¼Œç¡®ä¿å†™å…¥çš„å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ä¸Šã€‚æœ€åï¼Œåœ¨ poll_close() æ—¶è°ƒç”¨ poll_shutdown() å…³é—­æ–‡ä»¶ã€‚</p><p>è¿™æ®µä»£ç è™½ç„¶å®ç°äº† Sink traitï¼Œä¹Ÿå±•ç¤ºäº†å¦‚ä½•å®ç° Sink çš„å‡ ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¹ˆç®€å•çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¤„ç†èµ·æ¥è¿˜æ˜¯é¢‡ä¸ºè´¹åŠ²ã€‚æœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹æ³•å‘¢ï¼Ÿ</p><p>æœ‰çš„ã€‚futures é‡Œæä¾›äº† sink::unfold æ–¹æ³•ï¼Œç±»ä¼¼ stream::unfoldï¼Œæˆ‘ä»¬æ¥é‡å†™ä¸Šé¢çš„ File Sink çš„ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=2582cfe2473f615b4e2f021893d738a3\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse futures::prelude::*;\nuse tokio::{fs::File, io::AsyncWriteExt};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let file_sink = writer(File::create(\"/tmp/hello\").await?);\n    // pin_mut å¯ä»¥æŠŠå˜é‡ pin ä½\n    futures::pin_mut!(file_sink);\n    if let Err(_) = file_sink.send(\"hello\\\\n\").await {\n        println!(\"Error on send\");\n    }\n    if let Err(_) = file_sink.send(\"world!\\\\n\").await {\n        println!(\"Error on send\");\n    }\n    Ok(())\n}\n\n/// ä½¿ç”¨ unfold ç”Ÿæˆä¸€ä¸ª Sink æ•°æ®ç»“æ„\nfn writer&lt;'a&gt;(file: File) -&gt; impl Sink&lt;&amp;'a str&gt; {\n    sink::unfold(file, |mut file, line: &amp;'a str| async move {\n        file.write_all(line.as_bytes()).await?;\n        eprint!(\"Received: {}\", line);\n        Ok::&lt;_, std::io::Error&gt;(file)\n    })\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ unfold æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ’°å†™ Sink çš„å‡ ä¸ªæ–¹æ³•äº†ï¼Œè€Œä¸”å¯ä»¥åœ¨ä¸€ä¸ªè¿”å› Future çš„é—­åŒ…ä¸­æ¥æä¾›å¤„ç†é€»è¾‘ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨ poll_xxx è¿™æ ·çš„æ–¹æ³•ï¼Œç›´æ¥åœ¨é—­åŒ…ä¸­ä½¿ç”¨è¿™æ ·çš„å¼‚æ­¥å‡½æ•°ï¼š</p><pre><code class=\"language-rust\">file.write_all(line.as_bytes()).await?\n</code></pre><p>ä½ çœ‹ï¼ŒçŸ­çŸ­ 5 è¡Œä»£ç ï¼Œå°±å®ç°äº†åˆšæ‰äº”åå¤šè¡Œä»£ç è¦è¡¨è¾¾çš„é€»è¾‘ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘ä»¬å­¦ä¹ äº†å’Œå¼‚æ­¥ IO ç›¸å…³çš„ Stream / Sink traitï¼Œä»¥åŠå’Œå¼‚æ­¥è¯»å†™ç›¸å…³çš„ AsyncRead / AsyncWrite ç­‰ traitã€‚åœ¨å­¦ä¹ å¼‚æ­¥ IO æ—¶ï¼Œå¾ˆå¤šå†…å®¹éƒ½å¯ä»¥å’ŒåŒæ­¥ IO çš„å¤„ç†å¯¹æ¯”ç€å­¦ï¼Œè¿™æ ·äº‹åŠåŠŸå€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/da/28/da47e6ae335b4c46719afc64b5a60e28.jpg?wh=1920x1145\" alt=\"å›¾ç‰‡\"></p><p>åœ¨å¤„ç†å¼‚æ­¥ IO æ—¶ï¼Œåº•å±‚çš„ poll_xxx() å‡½æ•°å¾ˆéš¾å†™ï¼Œå› ä¸ºå®ƒçš„çº¦æŸå¾ˆå¤šã€‚å¥½åœ¨æœ‰ pin_project è¿™ä¸ªé¡¹ç›®ï¼Œç”¨å®å¸®æˆ‘ä»¬è§£å†³äº†å¾ˆå¤šå…³äº Pin/Unpin çš„é—®é¢˜ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸å¤ªéœ€è¦ç›´æ¥å®ç° Stream / Sink / AsyncRead / AsyncWrite traitï¼Œå¦‚æœçš„ç¡®éœ€è¦ï¼Œå…ˆçœ‹çœ‹æœ‰æ²¡æœ‰å¯ä»¥ä½¿ç”¨çš„è¾…åŠ©å‡½æ•°ï¼Œæ¯”å¦‚é€šè¿‡ poll_fn / unfold åˆ›å»º Streamã€é€šè¿‡ unfold åˆ›å»º Sinkã€‚</p><h3>æ€è€ƒé¢˜</h3><p>æˆ‘ä»¬çŸ¥é“ tokio:sync::mpsc ä¸‹æœ‰æ”¯æŒå¼‚æ­¥çš„ MPSC channelï¼Œç”Ÿäº§è€…å¯ä»¥é€šè¿‡ send() å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…å¯ä»¥é€šè¿‡ recv() æ¥æ¥æ”¶æ¶ˆæ¯ã€‚ä½ èƒ½ä¸èƒ½ä¸ºå…¶å°è£… Sink å’Œ Stream çš„å®ç°ï¼Œè®© MPSC channel å¯ä»¥åƒ Stream / Sink ä¸€æ ·ä½¿ç”¨ï¼Ÿï¼ˆæç¤ºï¼štokio-stream æœ‰ ReceiverStream çš„å®ç°ï¼‰ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒå’Œå­¦ä¹ æ”¶è·ï¼Œæ„Ÿè°¢æ”¶å¬ï¼Œæ­å–œä½ å·²ç»å®Œæˆäº†rustå­¦ä¹ çš„40æ¬¡æ‰“å¡ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"39ï½œå¼‚æ­¥å¤„ç†ï¼šasync/awaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ","id":455412},"right":{"article_title":"41ï½œé˜¶æ®µå®æ“ï¼ˆ6ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-å¼‚æ­¥å¤„ç†","id":461997}},"comments":[{"had_liked":false,"id":324280,"user_name":"ç½—åŒå­¦","can_delete":false,"product_type":"c1","uid":1649119,"ip_address":"","ucode":"909B9EC768B9AD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vHujib2CCrUYNBaia32eIwTyJoAcl27vASZ9KGjSdnH1dJhD7CrSUicBib19Tf8nDibWaHjzIsvIfdqcXX6vGrH8bicw/132","comment_is_top":false,"comment_ctime":1638355222,"is_pvip":false,"replies":[{"id":"118868","content":"&gt; åœ¨ç»¿è‰²çº¿ç¨‹é‡Œç”¨åŒæ­¥çš„å½¢å¼å¤„ç†io<br><br>é‚£å°±ä¼šåœ¨ç­‰å¾… IO çš„æ—¶å€™å¯¼è‡´é˜»å¡ï¼Œè¿›è€Œè®©ã€Œç»¿è‰²çº¿ç¨‹ã€æ‰€åœ¨çš„çº¿ç¨‹æ— æ³•åœ¨ç­‰å¾… IO æ—¶åšå…¶å®ƒäº‹æƒ…ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639848968,"ip_address":"","comment_id":324280,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10228289814","product_id":100085301,"comment_content":"è¿˜æ˜¯æ²¡ææ‡‚è¿™å‡ ä¸ªæ¥å£çš„æ„ä¹‰ï¼Œæˆ‘åœ¨ç»¿è‰²çº¿ç¨‹é‡Œç”¨åŒæ­¥çš„å½¢å¼å¤„ç†ioï¼Œç„¶åå†é€šè¿‡channel ç­‰æ–¹å¼åˆ†äº«å‡ºå»æ•°æ®ï¼Œä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿè¿™å‡ ä¸ªå¼‚æ­¥ioçš„æ¥å£æ˜¯ä¸æ˜¯æœ‰ç‚¹å¤šä½™ï¼Ÿæˆ–è€…æ˜¯ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ<br>","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539828,"discussion_content":"&gt; åœ¨ç»¿è‰²çº¿ç¨‹é‡Œç”¨åŒæ­¥çš„å½¢å¼å¤„ç†io\n\né‚£å°±ä¼šåœ¨ç­‰å¾… IO çš„æ—¶å€™å¯¼è‡´é˜»å¡ï¼Œè¿›è€Œè®©ã€Œç»¿è‰²çº¿ç¨‹ã€æ‰€åœ¨çš„çº¿ç¨‹æ— æ³•åœ¨ç­‰å¾… IO æ—¶åšå…¶å®ƒäº‹æƒ…ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1313480,"avatar":"https://static001.geekbang.org/account/avatar/00/14/0a/c8/dae4a360.jpg","nickname":"Do","note":"","ucode":"EA11EBD6439D1B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535570,"discussion_content":"ä¸è¡Œï¼Œè¿™æ ·è¿è¡Œå½“å‰åç¨‹çš„çº¿ç¨‹ä¼šè¢«é˜»å¡æ‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638464965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324209,"user_name":"ä¹Œé¾™çŒ¹","can_delete":false,"product_type":"c1","uid":2739949,"ip_address":"","ucode":"43F94A0DEC54BE","user_header":"https://static001.geekbang.org/account/avatar/00/29/ce/ed/3dbe915b.jpg","comment_is_top":false,"comment_ctime":1638335824,"is_pvip":false,"replies":[{"id":"118867","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639848803,"ip_address":"","comment_id":324209,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10228270416","product_id":100085301,"comment_content":"2021å¹´å°±å‰©ä¸‹æœ€åä¸€ä¸ªæœˆ  é™ˆè€å¸ˆçš„è¯¾ä¹Ÿå³å°†å®Œç»“  æ‰€å¹¸2021å¹´è·Ÿéšé™ˆè€å¸ˆçš„è¯¾ç¨‹å¯¹ rust æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£  å¸Œæœ›æ¥å¹´èƒ½ç”¨rust åšç‚¹å•¥  æå‰é¢„å®šè€å¸ˆçš„ elixir è¯¾ç¨‹ ","like_count":2,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539827,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639848804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356407,"user_name":"overheat","can_delete":false,"product_type":"c1","uid":2675695,"ip_address":"ç¾å›½","ucode":"DD82D9194C26D0","user_header":"https://static001.geekbang.org/account/avatar/00/28/d3/ef/b3b88181.jpg","comment_is_top":false,"comment_ctime":1662277992,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1662277992","product_id":100085301,"comment_content":"Streamå¥½åƒå·²ç»ç¨³å®šä¸‹æ¥äº†ï¼Œæ²¡æœ‰çœ‹åˆ°nightlyçš„æç¤ºäº†","like_count":0},{"had_liked":false,"id":340812,"user_name":"Geek_676746","can_delete":false,"product_type":"c1","uid":2963176,"ip_address":"","ucode":"C0A4BDCA90E508","user_header":"","comment_is_top":false,"comment_ctime":1649154547,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649154547","product_id":100085301,"comment_content":"AsyncRead æ˜¯ç¬¬ä¸‰æ–¹çš„traitï¼Œæ²¡å¿…è¦è®¨è®ºå§","like_count":0},{"had_liked":false,"id":332571,"user_name":"worm","can_delete":false,"product_type":"c1","uid":1504178,"ip_address":"","ucode":"9B4F745BC44740","user_header":"https://static001.geekbang.org/account/avatar/00/16/f3/b2/1ce2ae4d.jpg","comment_is_top":false,"comment_ctime":1643349692,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643349692","product_id":100085301,"comment_content":"ä¸ºä»€ä¹ˆè¦ç”¨sink trait,ç›´æ¥ä½¿ç”¨asyncWriteæœ‰ä»€ä¹ˆä¸å¥½å—ï¼Œæ²¡ææ‡‚","like_count":0},{"had_liked":false,"id":325195,"user_name":"è‰¯å¸ˆç›Šå‹","can_delete":false,"product_type":"c1","uid":1614999,"ip_address":"","ucode":"02B0B2FDDDAE6A","user_header":"https://static001.geekbang.org/account/avatar/00/18/a4/97/bc269801.jpg","comment_is_top":false,"comment_ctime":1638858804,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638858804","product_id":100085301,"comment_content":"ä»è¿™ç¯‡å¼€å§‹ï¼Œå˜å¾—è¶…éš¾","like_count":0}]}