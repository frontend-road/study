{"id":719710,"title":"25ï½œé”å®¶æ—çš„è£‚å˜ï¼šå¦‚ä½•æ‰“é€ ä¸€ä¸ªé”ç¨‹åºï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯åº·æ¨ã€‚</p><p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µã€‚äº†è§£ä¸åŒç±»å‹çš„é”ä»¥åŠå®ƒä»¬çš„ç‰¹æ€§å’Œä½¿ç”¨åœºåˆï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ç¼–å†™å‡ºé«˜å¹¶å‘ã€é«˜æ•ˆç‡çš„ç¨‹åºã€‚ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠJavaä¸­çš„å„ç§é”ï¼Œæ·±å…¥å‰–æè¿™äº›é”çš„å·¥ä½œåŸç†å’Œåº”ç”¨åœºæ™¯ï¼Œå¹¶äº†è§£å¦‚ä½•ä½¿ç”¨AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ„é€ è‡ªå®šä¹‰é”ã€‚</p><h2>é”çš„åˆ†ç±»</h2><p>Java é”å¯ä»¥æ ¹æ®ä¸åŒçš„ç»´åº¦è¿›è¡Œåˆ†ç±»ï¼Œè¿™é‡Œæˆ‘åˆ—ä¸¾äº†å‡ ç§å¸¸è§çš„åˆ†ç±»æ–¹å¼ã€‚</p><h3>ä¹è§‚é”å’Œæ‚²è§‚é”</h3><p>ä¹è§‚é”å’Œæ‚²è§‚é”æ˜¯å¹¶å‘æ§åˆ¶é¢†åŸŸçš„ä¸¤ç§ä¸»è¦ç­–ç•¥ï¼Œå®ƒä»¬åœ¨å¤„ç†å¤šçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®æ—¶é‡‡ç”¨ä¸åŒçš„æ–¹æ³•ã€‚</p><p>ä¹è§‚é”ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ç§æ¯”è¾ƒä¹è§‚çš„ç­–ç•¥ã€‚å®ƒå‡è®¾æ•°æ®åœ¨åŒä¸€æ—¶é—´è¢«å¤šä¸ªçº¿ç¨‹ä¿®æ”¹çš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œå› æ­¤ä¸ä¼šåœ¨è¯»å–æ“ä½œæ—¶å¯¹æ•°æ®åŠ é”ã€‚è¿™ç§é”ç­–ç•¥é€‚ç”¨äºè¯»å–æ“ä½œè¿œå¤šäºå†™å…¥æ“ä½œçš„åœºæ™¯ã€‚åœ¨ Java ä¸­ï¼ŒåŸå­æ“ä½œç±»ï¼ˆå¦‚ AtomicIntegerã€AtomicLong ç­‰ï¼‰å°±æ˜¯ä¹è§‚é”çš„å…¸å‹åº”ç”¨ã€‚ä¹è§‚é”çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œåœ¨è¯»å–æ•°æ®æ—¶ï¼Œä¸è€ƒè™‘æ•°æ®å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„æƒ…å†µï¼Œåªåœ¨æ•°æ®å†™å…¥æ—¶é€šè¿‡ç‰ˆæœ¬å·æœºåˆ¶è¿›è¡Œæ ¡éªŒã€‚å¦‚æœå‘ç°æ•°æ®å·²ç»è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒæ­¤æ¬¡å†™å…¥ï¼Œé‡æ–°è¯»å–æ•°æ®å¹¶å°è¯•å†æ¬¡å†™å…¥ã€‚</p><p>æ‚²è§‚é”ï¼Œåˆ™æ˜¯ä¸€ç§æ¯”è¾ƒæ‚²è§‚çš„ç­–ç•¥ã€‚å®ƒå‡è®¾æ•°æ®åœ¨åŒä¸€æ—¶é—´è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„æ¦‚ç‡è¾ƒå¤§ï¼Œå› æ­¤ä¼šå§‹ç»ˆå¯¹æ•°æ®è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚è¿™ç§é”ç­–ç•¥é€‚ç”¨äºæ•°æ®ç«äº‰æ¯”è¾ƒæ¿€çƒˆçš„åœºæ™¯ã€‚åœ¨ Java ä¸­ï¼ŒåŒæ­¥å…³é”®å­— Synchronized æˆ– ReentrantLock å°±æ˜¯å…¸å‹çš„æ‚²è§‚é”ã€‚æ‚²è§‚é”çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹å¯¹æ•°æ®è¿›è¡Œæ“ä½œï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°è·å¾—é”ã€‚è¿™æ ·å°±èƒ½ç¡®ä¿æ•°æ®åœ¨è¯»å–å’Œå†™å…¥è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§ã€‚</p><!-- [[[read_end]]] --><p>ä¹è§‚é”é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå®ƒé€šè¿‡ç‰ˆæœ¬å·æœºåˆ¶æ¥é¿å…æ•°æ®å†²çªï¼›è€Œæ‚²è§‚é”é€‚ç”¨äºå†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œå®ƒé€šè¿‡å§‹ç»ˆåŠ é”æ¥ä¿æŠ¤æ•°æ®çš„å®‰å…¨ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„é”ç­–ç•¥ï¼Œä»¥å®ç°é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶ã€‚</p><pre><code class=\"language-java\">// å‡è®¾ä½ æœ‰ä¸€ä¸ªcounterç±»ï¼Œä½ æƒ³ç»™ä»–æ·»åŠ ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„incrementæ–¹æ³•\npublic class Counter {\nprivate volatile int count = 0;\npublic void increment() {\nint current = count;\nint next = current + 1;\nif (count != current) // è¿™å°±æ˜¯ä¹è§‚é”çš„æ“ä½œ\nthrow new ConcurrentModificationException();\ncount = next;\n}\n}\n</code></pre><h3><strong>ç‹¬å é”å’Œå…±äº«é”</strong></h3><p>ç‹¬å é”å’Œå…±äº«é”æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­å¹¶å‘æ§åˆ¶çš„ä¸¤ç§é”ç­–ç•¥ã€‚ç†è§£è¿™ä¸¤ç§é”ç­–ç•¥å¯¹äºæŒæ¡å¹¶å‘ç¼–ç¨‹éå¸¸é‡è¦ã€‚</p><p>ç‹¬å é”ï¼Œæ­£å¦‚å…¶åï¼Œæ˜¯ä¸€ç§åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰çš„é”ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†ç‹¬å é”ï¼Œå…¶ä»–çº¿ç¨‹æƒ³è¦è®¿é—®è¢«ç‹¬å é”ä¿æŠ¤çš„èµ„æºæ—¶ï¼Œå¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚åœ¨ Java ä¸­ï¼ŒSynchronized å…³é”®å­—å’Œ ReentrantLock ç±»éƒ½å®ç°äº†ç‹¬å é”ã€‚</p><p>å…±äº«é”ä¸ç‹¬å é”ç›¸åï¼Œå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å–å…±äº«é”ï¼Œä½†å¦‚æœå½“å‰å·²ç»æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰å…±äº«é”ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å¿…é¡»ç­‰å¾…ã€‚å…±äº«é”é€šå¸¸ç”¨äºè¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œçš„åœºæ™¯ï¼Œè¿™æ ·å¯ä»¥æé«˜ç¨‹åºçš„å¹¶å‘æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œè¡¨çš„è¯»é”å°±æ˜¯ä¸€ç§å…±äº«é”ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Java ç¨‹åºï¼Œå±•ç¤ºäº†ç‹¬å é”å’Œå…±äº«é”çš„ä½¿ç”¨ã€‚</p><pre><code class=\"language-java\">import java.util.concurrent.locks.Lock;\nimport java.util.concurrent.locks.ReentrantLock;\npublic class LockExample { \n    // ä½¿ç”¨ç‹¬å é”ä¿æŠ¤ä¸´ç•ŒåŒº\n    private final Lock exclusiveLock = new ReentrantLock();\n    // ä½¿ç”¨å…±äº«é”ä¿æŠ¤ä¸´ç•ŒåŒº\n    private final Lock sharedLock = new ReentrantLock();\n    public void exclusiveMethod() {\n        // è·å–ç‹¬å é”\n        exclusiveLock.lock();\n        try {\n            // ä¸´ç•ŒåŒº\n            System.out.println(\"Exclusive lock acquired\");\n        } finally {\n            // é‡Šæ”¾ç‹¬å é”\n            exclusiveLock.unlock();\n        }\n    }\n    public void sharedMethod() {\n        // è·å–å…±äº«é”\n        sharedLock.lock();\n        try {\n            // ä¸´ç•ŒåŒº\n            System.out.println(\"Shared lock acquired\");\n        } finally {\n            // é‡Šæ”¾å…±äº«é”\n            sharedLock.unlock();\n        }\n    }\n    public static void main(String[] args) {\n        LockExample lockExample = new LockExample();\n        // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹\n        Thread thread1 = new Thread(() -&gt; lockExample.exclusiveMethod());\n        Thread thread2 = new Thread(() -&gt; lockExample.sharedMethod());\n        // å¯åŠ¨çº¿ç¨‹\n        thread1.start();\n        thread2.start();\n        // ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•\n        try {\n            thread1.join();\n            thread2.join();\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º LockExample çš„ç±»ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šexclusiveMethod() å’Œ sharedMethod()ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ä½¿ç”¨ç‹¬å é”å’Œå…±äº«é”ä¿æŠ¤å®ƒä»¬çš„ä¸´ç•ŒåŒºã€‚åœ¨ main() æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ‰§è¡Œè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚ç”±äº exclusiveMethod() ä½¿ç”¨ç‹¬å é”ï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®ä¸´ç•ŒåŒºï¼›è€Œ sharedMethod() ä½¿ç”¨å…±äº«é”ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®ä¸´ç•ŒåŒºã€‚</p><h3>å…¬å¹³é”å’Œéå…¬å¹³é”</h3><p>è¿™ä¸¤ç§é”åœ¨å¤„ç†å¹¶å‘è®¿é—®æ—¶æœ‰ç€ä¸åŒçš„ç­–ç•¥ã€‚</p><p>å…¬å¹³é”ï¼Œæ˜¯ä¸€ç§ä¿è¯æ‰€æœ‰çº¿ç¨‹å…¬å¹³åœ°è·å–é”çš„æœºåˆ¶ã€‚è¿™ç§é”æŒ‰ç…§çº¿ç¨‹åˆ°è¾¾çš„é¡ºåºæ¥åˆ†é…é”ï¼Œç¡®ä¿äº†ä¸ä¼šå‡ºç°æŸä¸ªçº¿ç¨‹å› ä¸ºç­‰å¾…æ—¶é—´è¿‡é•¿è€Œé¥¿æ­»çš„æƒ…å†µã€‚Java ä¸­çš„ ReentrantLock å’Œ ReentrantReadWriteLock å°±æ˜¯å…¬å¹³é”çš„ä¾‹å­ã€‚</p><p>éå…¬å¹³é”åˆ™ä¸ä¿è¯çº¿ç¨‹è·å–é”çš„é¡ºåºï¼Œå®ƒåªä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰é”ã€‚è¿™ç§é”å¯èƒ½ä¼šå¯¼è‡´åæ¥çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”ï¼Œä»è€Œä½¿å…ˆåˆ°çš„çº¿ç¨‹é¥¿æ­»ã€‚</p><p>è¿™ä¸¤ç§é”çš„åº”ç”¨åœºæ™¯å„æœ‰ä¸åŒã€‚å…¬å¹³é”é€šå¸¸åœ¨éœ€è¦ä¿è¯æ‰€æœ‰çº¿ç¨‹å…¬å¹³è®¿é—®å…±äº«èµ„æºçš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œæ¯”å¦‚æ‰“å°æœºã€æ•°æ®åº“è¿æ¥ç­‰ã€‚ä»¥æ‰“å°æœºä¸ºä¾‹ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡éœ€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´æ‰èƒ½æ‰“å°ï¼Œé‚£ä¹ˆä½¿ç”¨å…¬å¹³é”å°±èƒ½ä¿è¯è¿™ä¸ªä»»åŠ¡ä¸ä¼šè¢«åæ¥çš„ä»»åŠ¡æŒ¤æ‰ï¼Œè€Œæ˜¯æŒ‰ç…§å…ˆæ¥å…ˆæœåŠ¡çš„åŸåˆ™æ‰“å°ã€‚ç„¶è€Œï¼Œå…¬å¹³é”éœ€è¦ç»´æŠ¤ä¸€ä¸ªæœ‰åºçš„é˜Ÿåˆ—ï¼Œè¿™ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ï¼Œå¯èƒ½ä¼šé™ä½æ€§èƒ½ã€‚</p><p>éå…¬å¹³é”é€šå¸¸åœ¨éœ€è¦ä¼˜å…ˆå¤„ç†è¾ƒç´§æ€¥çš„ä»»åŠ¡çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œæ¯”å¦‚ CPU å¯†é›†å‹ä»»åŠ¡ã€‚éå…¬å¹³é”çš„ä¼˜ç‚¹æ˜¯å¯ä»¥å‡å°‘ CPU æ‰§è¡Œè°ƒåº¦çš„é¢‘ç‡ï¼Œä»è€Œæé«˜ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Java ç¨‹åºï¼Œå±•ç¤ºäº†å…¬å¹³é”å’Œéå…¬å¹³é”çš„ä½¿ç”¨ã€‚</p><pre><code class=\"language-java\">import java.util.concurrent.locks.Lock;\nimport java.util.concurrent.locks.ReentrantLock;\npublic class LockExample {\n    // ä½¿ç”¨å…¬å¹³é”ä¿æŠ¤ä¸´ç•ŒåŒº\n    private final Lock fairLock = new ReentrantLock(true);\n    // ä½¿ç”¨éå…¬å¹³é”ä¿æŠ¤ä¸´ç•ŒåŒº\n    private final Lock nonFairLock = new ReentrantLock(false);\n    public void fairMethod() {\n        // è·å–å…¬å¹³é”\n        fairLock.lock();\n        try {\n            // ä¸´ç•ŒåŒº\n            System.out.println(\"Fair lock acquired\");\n        } finally {\n            // é‡Šæ”¾å…¬å¹³é”\n            fairLock.unlock();\n        }\n    }\n    public void nonFairMethod() {\n        // è·å–éå…¬å¹³é”\n        nonFairLock.lock();\n        try {\n            // ä¸´ç•ŒåŒº\n            System.out.println(\"Non-fair lock acquired\");\n        } finally {\n            // é‡Šæ”¾éå…¬å¹³é”\n            nonFairLock.unlock();\n        }\n    }\n    public static void main(String[] args) {\n        LockExample lockExample = new LockExample();\n        // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹\n        Thread thread1 = new Thread(() -&gt; lockExample.fairMethod());\n        Thread thread2 = new Thread(() -&gt; lockExample.nonFairMethod());\n        // å¯åŠ¨çº¿ç¨‹\n        thread1.start();\n        thread2.start();\n        // ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•\n        try {\n            thread1.join();\n            thread2.join();\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º LockExample çš„ç±»ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šfairMethod() å’Œ nonFairMethod()ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ä½¿ç”¨å…¬å¹³é”å’Œéå…¬å¹³é”ä¿æŠ¤å®ƒä»¬çš„ä¸´ç•ŒåŒºã€‚åœ¨ main() æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ‰§è¡Œè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚ç”±äº fairMethod() ä½¿ç”¨å…¬å¹³é”ï¼Œå› æ­¤æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šæŒ‰ç…§å…ˆæ¥å…ˆæœåŠ¡çš„é¡ºåºè·å–é”ï¼›è€Œ nonFairMethod() ä½¿ç”¨éå…¬å¹³é”ï¼Œå› æ­¤çº¿ç¨‹è·å–é”çš„é¡ºåºå¹¶ä¸ç¡®å®šã€‚</p><h2>é”çš„åŸºæœ¬æ¦‚å¿µå’Œå®ç°</h2><p>Java ä¸­çš„é”ä¸»è¦é€šè¿‡ Synchronized å…³é”®å­—ä»¥åŠ java.util.concurrent.locks åŒ…ä¸­çš„æ¥å£å’Œç±»å®ç°ã€‚æˆ‘ä»¬æ¥çœ‹é‡Œé¢çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚</p><ol>\n<li>é”çš„çŠ¶æ€ï¼šæ— é”ï¼ˆUnlockedï¼‰ã€åå‘é”ï¼ˆBiased Lockingï¼‰ã€è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰ã€é‡é‡çº§é”ï¼ˆHeavyweight Lockingï¼‰ã€‚</li>\n<li>é”çš„è·å–å’Œé‡Šæ”¾ï¼šé€šè¿‡ acquire() å’Œ release() æ–¹æ³•å®ç°ã€‚</li>\n<li>é”çš„å‡çº§ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼Œå¦‚æœé”çš„çŠ¶æ€ä¸ºåå‘é”æˆ–è½»é‡çº§é”ï¼Œé‚£ä¹ˆä¼šå°è¯•å°†é”å‡çº§ä¸ºé‡é‡çº§é”ã€‚</li>\n</ol><h2>é”çš„åº”ç”¨å®ä¾‹</h2><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ Synchronized å…³é”®å­—å®ç°æ‚²è§‚é”çš„ä¾‹å­ã€‚</p><pre><code class=\"language-plain\"> public class Bank {\n    private int money;\n    public synchronized void withdraw(int amount) {\n        if (money &gt;= amount) {\n            money -= amount;\n        } else {\n            System.out.println(\"ä½™é¢ä¸è¶³\");\n        }\n    }\n}\n</code></pre><h2>ä½¿ç”¨ AQS æ„å»ºè‡ªå®šä¹‰é”</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨AQS ï¼ˆAbstractQueuedSynchronizerï¼‰å®ç°ä¸€ä¸ªè‡ªå®šä¹‰é”ã€‚AQSæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé”å’Œå…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ª int ç±»å‹çš„ state å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ã€‚</p><ol>\n<li>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª AQS çš„å­ç±»ã€‚è¿™ä¸ªå­ç±»å°†ç”¨äºå®ç°æˆ‘ä»¬çš„è‡ªå®šä¹‰é”ã€‚</li>\n</ol><pre><code class=\"language-java\">import java.util.concurrent.locks.AbstractQueuedSynchronizer;\npublic class CustomLock extends AbstractQueuedSynchronizer { \n}\n</code></pre><ol start=\"2\">\n<li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™ AQS ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œä»¥ä¾¿äºå®ç°è‡ªå®šä¹‰é”çš„åŠŸèƒ½ã€‚</li>\n</ol><pre><code class=\"language-java\">// å°è¯•è·å–é”ï¼Œå¦‚æœ state ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ç”¨ï¼Œå¦åˆ™è¿”å› false\n@Override\nprotected boolean tryAcquire(int arg) {\n   return compareAndSetState(0, 1);\n}\n// é‡Šæ”¾é”ï¼Œå°† state è®¾ç½®ä¸º 0\n@Override\nprotected boolean tryRelease(int arg) {\n    setState(0);\n    return true;\n}\n// è·å–é”çš„çº¿ç¨‹æ•°é‡\n@Override\nprotected int getState() {\n    return super.getState();\n}\n</code></pre><ol start=\"3\">\n<li>ç°åœ¨æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª CustomLock ç±»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ tryLock æ–¹æ³•å°è¯•è·å–é”ã€‚</li>\n</ol><pre><code class=\"language-java\">public class Main { \n    public static void main(String[] args) {\n        CustomLock lock = new CustomLock();\n        // å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸè¿”å› trueï¼Œå¦åˆ™è¿”å› false\n        boolean acquired = lock.tryLock();\n        if (acquired) {\n            try {\n                // ä¸´ç•ŒåŒº\n                System.out.println(\"Lock acquired\");\n            } finally {\n                // é‡Šæ”¾é”\n                lock.unlock();\n            }\n        } else {\n            System.out.println(\"Failed to acquire lock\");\n        }\n    }\n \n}\n</code></pre><p>åœ¨ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª CustomLock å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ tryLock æ–¹æ³•å°è¯•è·å–é”ã€‚å¦‚æœæˆåŠŸè·å–åˆ°é”ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸´ç•ŒåŒºæ‰§è¡Œä¸€äº›æ“ä½œï¼Œç„¶ååœ¨ finally å—ä¸­é‡Šæ”¾é”ã€‚å¦‚æœ tryLock æ–¹æ³•è¿”å› falseï¼Œè¯´æ˜é”å·²è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œæˆ‘ä»¬æ— æ³•è·å–åˆ°é”ã€‚</p><p>è¿™å°±æ˜¯å¦‚ä½•ä½¿ç”¨ AQS å®ç°ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰é”ã€‚ä½ å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚å¯¹ CustomLock ç±»è¿›è¡Œæ‰©å±•ï¼Œä»¥å®ç°æ›´å¤æ‚çš„åŠŸèƒ½ï¼Œä¾‹å¦‚å…¬å¹³é”ç­‰ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé”æ˜¯æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè®¿é—®çš„å…³é”®æ¦‚å¿µã€‚äº†è§£ä¸åŒç±»å‹çš„é”ä»¥åŠå®ƒä»¬çš„ç‰¹æ€§å’Œä½¿ç”¨åœºåˆæœ‰åŠ©äºæˆ‘ä»¬ç¼–å†™å‡ºé«˜å¹¶å‘ã€é«˜æ•ˆç‡çš„ç¨‹åºã€‚Java ä¸­çš„é”ç§ç±»ç¹å¤šï¼ŒåŒ…æ‹¬ä¹è§‚é”ã€æ‚²è§‚é”ã€ç‹¬å é”ã€å…±äº«é”ã€å…¬å¹³é”ã€éå…¬å¹³é”ç­‰ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„é”ç­–ç•¥ï¼Œä»¥å®ç°é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶ã€‚ä¾‹å¦‚ï¼Œä¹è§‚é”é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œé€šè¿‡ç‰ˆæœ¬å·æœºåˆ¶æ¥é¿å…æ•°æ®å†²çªï¼›æ‚²è§‚é”é€‚ç”¨äºå†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œå§‹ç»ˆå¯¹æ•°æ®è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜äº†è§£åˆ°å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ«ï¼Œå…¬å¹³é”æŒ‰çº¿ç¨‹é¡ºåºåˆ†é…é”ï¼Œé¿å…é¥¥é¥¿ç°è±¡ï¼Œé€‚ç”¨äºè¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œçš„åœºæ™¯ï¼›éå…¬å¹³é”åˆ™ä¸ä¿è¯çº¿ç¨‹è·å–é”çš„é¡ºåºï¼Œé€‚ç”¨äºå†™æ“ä½œå¯†é›†çš„åœºæ™¯ã€‚</p><p>åœ¨ Java ä¸­ï¼Œé”å¯ä»¥é€šè¿‡ Synchronized å…³é”®å­—ä»¥åŠ java.util.concurrent.locks åŒ…ä¸­çš„æ¥å£å’Œç±»å®ç°ã€‚æ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨ AQSï¼ˆAbstractQueuedSynchronizerï¼‰æ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ„å»ºè‡ªå®šä¹‰é”ï¼Œä»¥æ»¡è¶³ç‰¹å®šåœºæ™¯çš„éœ€æ±‚ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å­¦è€Œä¸æ€åˆ™ç½”ï¼Œå­¦å®Œè¿™èŠ‚è¯¾ä¹‹åï¼Œæˆ‘ç»™ä½ ç•™ä¸¤ä¸ªé—®é¢˜ã€‚</p><ol>\n<li>ä¹è§‚é”å’Œæ‚²è§‚é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¸»è¦åº”ç”¨åœ¨é‚£äº›åœºæ™¯ï¼Ÿ</li>\n<li>å¦‚ä½•æ‰“é€ ä¸€ä¸ªè‡ªå®šä¹‰çš„é”ç¨‹åºï¼Ÿ</li>\n</ol><p>å¸Œæœ›ä½ è®¤çœŸæ€è€ƒï¼Œç„¶åæŠŠæ€è€ƒåçš„ç»“æœåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œæˆ‘ä»¬ä¸€èµ·è®¨è®ºï¼Œå¦‚æœæœ‰æ”¶è·çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p><h2>ğŸ’¡ ç‚¹äº®ä½ çš„çŸ¥è¯†æ¡†æ¶å›¾</h2><p><img src=\"https://static001.geekbang.org/resource/image/38/38/3888a47626ab58e9db027f88f29b0338.jpg?wh=5753x4063\" alt=\"å›¾ç‰‡\"></p>","comments":[{"had_liked":false,"id":382906,"user_name":"è¿›å¾·ä¿®ä¸š","can_delete":false,"product_type":"c1","uid":2629033,"ip_address":"ä¸Šæµ·","ucode":"97E2AF0E1ECD23","user_header":"https://static001.geekbang.org/account/avatar/00/28/1d/a9/89f3108a.jpg","comment_is_top":false,"comment_ctime":1698195540,"is_pvip":false,"replies":null,"discussion_count":5,"race_medal":5,"score":2,"product_id":100613601,"comment_content":"ç‹¬å é”å’Œå…±äº«é”ä»£ç ï¼Œæ€ä¹ˆçœ‹ä¸¤ä¸ªé™¤äº†æ–¹æ³•åä¸ä¸€æ ·å…¶ä»–éƒ½ä¸€æ ·ï¼Œæ˜¯ä¸æ˜¯åˆå§‹åŒ–çš„æ—¶å€™å†™é”™äº†å‘€","like_count":4,"discussions":[{"author":{"id":1131268,"avatar":"https://static001.geekbang.org/account/avatar/00/11/43/04/9680dade.jpg","nickname":"AcelXiao","note":"","ucode":"52AAC5D3151D82","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":638000,"discussion_content":"åº”è¯¥é€€æ¬¾  è¿™ä¸ªä¸“æ å¤ªåƒåœ¾äº†","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1709188868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2358957,"avatar":"https://static001.geekbang.org/account/avatar/00/23/fe/ad/c4026ff2.jpg","nickname":"NoMoneyException","note":"","ucode":"284D17BBBD51D6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":630531,"discussion_content":"ç‹¬å å’Œå…±äº«çš„ä»£ç ï¼Œå…¬å¹³å’Œéå…¬å¹³çš„ä»£ç æ„Ÿè§‰éƒ½æœ‰é—®é¢˜","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1698630588,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2629033,"avatar":"https://static001.geekbang.org/account/avatar/00/28/1d/a9/89f3108a.jpg","nickname":"è¿›å¾·ä¿®ä¸š","note":"","ucode":"97E2AF0E1ECD23","race_medal":5,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":630242,"discussion_content":"å…±äº«é”æ˜¯æŒ‡è¯¥é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚\n\nç‹¬äº«é”æ˜¯æŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚\n\nReentrantLockã€synchronizedç‹¬äº«é”\n\nReentrantReadWriteLockï¼Œè¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬å é”ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1698207814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1006424,"avatar":"","nickname":"Geek_xbye50","note":"","ucode":"0BF3780C247F22","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632078,"discussion_content":"å“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700458610,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ç¦å»º","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1182516,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","nickname":"ç‹ç››æ­¦","note":"","ucode":"DE7EF246D3DCE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":630351,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1698332364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382904,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1698194045,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100613601,"comment_content":"è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š\nQ1ï¼šå…±äº«é”éœ€è¦ç­‰å¾…çš„è¯è¿˜æ€ä¹ˆå…±äº«ï¼Ÿ\næ–‡ä¸­è¿™å¥è¯â€œå½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è·å–å…±äº«é”ï¼Œä½†å¦‚æœå½“å‰å·²ç»æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰å…±äº«é”ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å¿…é¡»ç­‰å¾…â€ï¼Œæ ¹æ®è¿™å¥è¯ï¼Œä¹Ÿåªèƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–é”ï¼Œè¿™æ€ä¹ˆå…±äº«ï¼Ÿ\nQ2ï¼šå…±äº«é”ã€ç‹¬å é”çš„ä¾‹å­ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\nLock exclusiveLock = new ReentrantLock();\nLock sharedLock = new ReentrantLock();\nä¸¤ä¸ªå®šä¹‰ç›¸åŒï¼Œä½¿ç”¨çš„ä»£ç ä¹Ÿç›¸åŒï¼Œæ€ä¹ˆåŒºåˆ†å…±äº«ä¸ç‹¬å ï¼Ÿ","like_count":0}]}