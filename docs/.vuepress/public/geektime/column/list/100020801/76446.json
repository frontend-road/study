{"id":76446,"title":"24 | MySQL是怎么保证主备一致的？","content":"<p>在前面的文章中，我不止一次地和你提到了binlog，大家知道binlog可以用来归档，也可以用来做主备同步，但它的内容是什么样的呢？为什么备库执行了binlog就可以跟主库保持一致了呢？今天我就正式地和你介绍一下它。</p><p>毫不夸张地说，MySQL能够成为现下最流行的开源数据库，binlog功不可没。</p><p>在最开始，MySQL是以容易学习和方便的高可用架构，被开发人员青睐的。而它的几乎所有的高可用架构，都直接依赖于binlog。虽然这些高可用架构已经呈现出越来越复杂的趋势，但都是从最基本的一主一备演化过来的。</p><p>今天这篇文章我主要为你介绍主备的基本原理。理解了背后的设计原理，你也可以从业务开发的角度，来借鉴这些设计思想。</p><h1>MySQL主备的基本原理</h1><p>如图1所示就是基本的主备切换流程。</p><p><img src=\"https://static001.geekbang.org/resource/image/fd/10/fd75a2b37ae6ca709b7f16fe060c2c10.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图 1 MySQL主备切换流程</span></center><p>在状态1中，客户端的读写都直接访问节点A，而节点B是A的备库，只是将A的更新都同步过来，到本地执行。这样可以保持节点B和A的数据是相同的。</p><p>当需要切换的时候，就切成状态2。这时候客户端读写访问的都是节点B，而节点A是B的备库。</p><p>在状态1中，虽然节点B没有被直接访问，但是我依然建议你把节点B（也就是备库）设置成只读（readonly）模式。这样做，有以下几个考虑：</p><!-- [[[read_end]]] --><ol>\n<li>\n<p>有时候一些运营类的查询语句会被放到备库上去查，设置为只读可以防止误操作；</p>\n</li>\n<li>\n<p>防止切换逻辑有bug，比如切换过程中出现双写，造成主备不一致；</p>\n</li>\n<li>\n<p>可以用readonly状态，来判断节点的角色。</p>\n</li>\n</ol><p>你可能会问，我把备库设置成只读了，还怎么跟主库保持同步更新呢？</p><p>这个问题，你不用担心。因为readonly设置对超级(super)权限用户是无效的，而用于同步更新的线程，就拥有超级权限。</p><p>接下来，我们再看看<strong>节点A到B这条线的内部流程是什么样的</strong>。图2中画出的就是一个update语句在节点A执行，然后同步到节点B的完整流程图。</p><p><img src=\"https://static001.geekbang.org/resource/image/a6/a3/a66c154c1bc51e071dd2cc8c1d6ca6a3.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图2 主备流程图</span></center><p>图2中，包含了我在上一篇文章中讲到的binlog和redo log的写入机制相关的内容，可以看到：主库接收到客户端的更新请求后，执行内部事务的更新逻辑，同时写binlog。</p><p>备库B跟主库A之间维持了一个长连接。主库A内部有一个线程，专门用于服务备库B的这个长连接。一个事务日志同步的完整过程是这样的：</p><ol>\n<li>\n<p>在备库B上通过change master命令，设置主库A的IP、端口、用户名、密码，以及要从哪个位置开始请求binlog，这个位置包含文件名和日志偏移量。</p>\n</li>\n<li>\n<p>在备库B上执行start slave命令，这时候备库会启动两个线程，就是图中的io_thread和sql_thread。其中io_thread负责与主库建立连接。</p>\n</li>\n<li>\n<p>主库A校验完用户名、密码后，开始按照备库B传过来的位置，从本地读取binlog，发给B。</p>\n</li>\n<li>\n<p>备库B拿到binlog后，写到本地文件，称为中转日志（relay log）。</p>\n</li>\n<li>\n<p>sql_thread读取中转日志，解析出日志里的命令，并执行。</p>\n</li>\n</ol><p>这里需要说明，后来由于多线程复制方案的引入，sql_thread演化成为了多个线程，跟我们今天要介绍的原理没有直接关系，暂且不展开。</p><p>分析完了这个长连接的逻辑，我们再来看一个问题：binlog里面到底是什么内容，为什么备库拿过去可以直接执行。</p><h1>binlog的三种格式对比</h1><p>我在<a href=\"https://time.geekbang.org/column/article/73161\">第15篇答疑文章</a>中，和你提到过binlog有两种格式，一种是statement，一种是row。可能你在其他资料上还会看到有第三种格式，叫作mixed，其实它就是前两种格式的混合。</p><p>为了便于描述binlog的这三种格式间的区别，我创建了一个表，并初始化几行数据。</p><pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `a` int(11) DEFAULT NULL,\n  `t_modified` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  KEY `a` (`a`),\n  KEY `t_modified`(`t_modified`)\n) ENGINE=InnoDB;\n\ninsert into t values(1,1,'2018-11-13');\ninsert into t values(2,2,'2018-11-12');\ninsert into t values(3,3,'2018-11-11');\ninsert into t values(4,4,'2018-11-10');\ninsert into t values(5,5,'2018-11-09');\n</code></pre><p>如果要在表中删除一行数据的话，我们来看看这个delete语句的binlog是怎么记录的。</p><p>注意，下面这个语句包含注释，如果你用MySQL客户端来做这个实验的话，要记得加-c参数，否则客户端会自动去掉注释。</p><pre><code>mysql&gt; delete from t /*comment*/  where a&gt;=4 and t_modified&lt;='2018-11-10' limit 1;\n</code></pre><p>当binlog_format=statement时，binlog里面记录的就是SQL语句的原文。你可以用</p><pre><code>mysql&gt; show binlog events in 'master.000001';\n</code></pre><p>命令看binlog中的内容。</p><p><img src=\"https://static001.geekbang.org/resource/image/b9/31/b9818f73cd7d38a96ddcb75350b52931.png?wh=1882*213\" alt=\"\"></p><center><span class=\"reference\">图3 statement格式binlog 示例</span></center><p>现在，我们来看一下图3的输出结果。</p><ul>\n<li>第一行SET @@SESSION.GTID_NEXT='ANONYMOUS’你可以先忽略，后面文章我们会在介绍主备切换的时候再提到；</li>\n<li>第二行是一个BEGIN，跟第四行的commit对应，表示中间是一个事务；</li>\n<li>第三行就是真实执行的语句了。可以看到，在真实执行的delete命令之前，还有一个“use ‘test’”命令。这条命令不是我们主动执行的，而是MySQL根据当前要操作的表所在的数据库，自行添加的。这样做可以保证日志传到备库去执行的时候，不论当前的工作线程在哪个库里，都能够正确地更新到test库的表t。<br>\nuse 'test’命令之后的delete 语句，就是我们输入的SQL原文了。可以看到，binlog“忠实”地记录了SQL命令，甚至连注释也一并记录了。</li>\n<li>最后一行是一个COMMIT。你可以看到里面写着xid=61。你还记得这个XID是做什么用的吗？如果记忆模糊了，可以再回顾一下<a href=\"https://time.geekbang.org/column/article/73161\">第15篇文章</a>中的相关内容。</li>\n</ul><p>为了说明statement 和 row格式的区别，我们来看一下这条delete命令的执行效果图：</p><p><img src=\"https://static001.geekbang.org/resource/image/96/2b/96c2be9c0fcbff66883118526b26652b.png?wh=1893*315\" alt=\"\"></p><center><span class=\"reference\">图4 delete执行warnings</span></center><p>可以看到，运行这条delete命令产生了一个warning，原因是当前binlog设置的是statement格式，并且语句中有limit，所以这个命令可能是unsafe的。</p><p>为什么这么说呢？这是因为delete 带limit，很可能会出现主备数据不一致的情况。比如上面这个例子：</p><ol>\n<li>\n<p>如果delete语句使用的是索引a，那么会根据索引a找到第一个满足条件的行，也就是说删除的是a=4这一行；</p>\n</li>\n<li>\n<p>但如果使用的是索引t_modified，那么删除的就是 t_modified='2018-11-09’也就是a=5这一行。</p>\n</li>\n</ol><p>由于statement格式下，记录到binlog里的是语句原文，因此可能会出现这样一种情况：在主库执行这条SQL语句的时候，用的是索引a；而在备库执行这条SQL语句的时候，却使用了索引t_modified。因此，MySQL认为这样写是有风险的。</p><p>那么，如果我把binlog的格式改为binlog_format=‘row’， 是不是就没有这个问题了呢？我们先来看看这时候binog中的内容吧。</p><p><img src=\"https://static001.geekbang.org/resource/image/d6/26/d67a38db154afff610ae3bb64e266826.png?wh=1920*533\" alt=\"\"></p><center><span class=\"reference\">图5 row格式binlog 示例</span></center><p>可以看到，与statement格式的binlog相比，前后的BEGIN和COMMIT是一样的。但是，row格式的binlog里没有了SQL语句的原文，而是替换成了两个event：Table_map和Delete_rows。</p><ol>\n<li>\n<p>Table_map event，用于说明接下来要操作的表是test库的表t;</p>\n</li>\n<li>\n<p>Delete_rows event，用于定义删除的行为。</p>\n</li>\n</ol><p>其实，我们通过图5是看不到详细信息的，还需要借助mysqlbinlog工具，用下面这个命令解析和查看binlog中的内容。因为图5中的信息显示，这个事务的binlog是从8900这个位置开始的，所以可以用start-position参数来指定从这个位置的日志开始解析。</p><pre><code>mysqlbinlog  -vv data/master.000001 --start-position=8900;\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/c3/c2/c342cf480d23b05d30a294b114cebfc2.png?wh=1920*664\" alt=\"\"></p><center><span class=\"reference\">图6 row格式binlog 示例的详细信息</span></center><p>从这个图中，我们可以看到以下几个信息：</p><ul>\n<li>server id 1，表示这个事务是在server_id=1的这个库上执行的。</li>\n<li>每个event都有CRC32的值，这是因为我把参数binlog_checksum设置成了CRC32。</li>\n<li>Table_map event跟在图5中看到的相同，显示了接下来要打开的表，map到数字226。现在我们这条SQL语句只操作了一张表，如果要操作多张表呢？每个表都有一个对应的Table_map event、都会map到一个单独的数字，用于区分对不同表的操作。</li>\n<li>我们在mysqlbinlog的命令中，使用了-vv参数是为了把内容都解析出来，所以从结果里面可以看到各个字段的值（比如，@1=4、 @2=4这些值）。</li>\n<li>binlog_row_image的默认配置是FULL，因此Delete_event里面，包含了删掉的行的所有字段的值。如果把binlog_row_image设置为MINIMAL，则只会记录必要的信息，在这个例子里，就是只会记录id=4这个信息。</li>\n<li>最后的Xid event，用于表示事务被正确地提交了。</li>\n</ul><p>你可以看到，当binlog_format使用row格式的时候，binlog里面记录了真实删除行的主键id，这样binlog传到备库去的时候，就肯定会删除id=4的行，不会有主备删除不同行的问题。</p><h1>为什么会有mixed格式的binlog？</h1><p>基于上面的信息，我们来讨论一个问题：<strong>为什么会有mixed这种binlog格式的存在场景？</strong>推论过程是这样的：</p><ul>\n<li>因为有些statement格式的binlog可能会导致主备不一致，所以要使用row格式。</li>\n<li>但row格式的缺点是，很占空间。比如你用一个delete语句删掉10万行数据，用statement的话就是一个SQL语句被记录到binlog中，占用几十个字节的空间。但如果用row格式的binlog，就要把这10万条记录都写到binlog中。这样做，不仅会占用更大的空间，同时写binlog也要耗费IO资源，影响执行速度。</li>\n<li>所以，MySQL就取了个折中方案，也就是有了mixed格式的binlog。mixed格式的意思是，MySQL自己会判断这条SQL语句是否可能引起主备不一致，如果有可能，就用row格式，否则就用statement格式。</li>\n</ul><p>也就是说，mixed格式可以利用statment格式的优点，同时又避免了数据不一致的风险。</p><p>因此，如果你的线上MySQL设置的binlog格式是statement的话，那基本上就可以认为这是一个不合理的设置。你至少应该把binlog的格式设置为mixed。</p><p>比如我们这个例子，设置为mixed后，就会记录为row格式；而如果执行的语句去掉limit 1，就会记录为statement格式。</p><p>当然我要说的是，现在越来越多的场景要求把MySQL的binlog格式设置成row。这么做的理由有很多，我来给你举一个可以直接看出来的好处：<strong>恢复数据</strong>。</p><p>接下来，我们就分别从delete、insert和update这三种SQL语句的角度，来看看数据恢复的问题。</p><p>通过图6你可以看出来，即使我执行的是delete语句，row格式的binlog也会把被删掉的行的整行信息保存起来。所以，如果你在执行完一条delete语句以后，发现删错数据了，可以直接把binlog中记录的delete语句转成insert，把被错删的数据插入回去就可以恢复了。</p><p>如果你是执行错了insert语句呢？那就更直接了。row格式下，insert语句的binlog里会记录所有的字段信息，这些信息可以用来精确定位刚刚被插入的那一行。这时，你直接把insert语句转成delete语句，删除掉这被误插入的一行数据就可以了。</p><p>如果执行的是update语句的话，binlog里面会记录修改前整行的数据和修改后的整行数据。所以，如果你误执行了update语句的话，只需要把这个event前后的两行信息对调一下，再去数据库里面执行，就能恢复这个更新操作了。</p><p>其实，由delete、insert或者update语句导致的数据操作错误，需要恢复到操作之前状态的情况，也时有发生。MariaDB的<a href=\"https://mariadb.com/kb/en/library/flashback/\">Flashback</a>工具就是基于上面介绍的原理来回滚数据的。</p><p>虽然mixed格式的binlog现在已经用得不多了，但这里我还是要再借用一下mixed格式来说明一个问题，来看一下这条SQL语句：</p><pre><code>mysql&gt; insert into t values(10,10, now());\n</code></pre><p>如果我们把binlog格式设置为mixed，你觉得MySQL会把它记录为row格式还是statement格式呢？</p><p>先不要着急说结果，我们一起来看一下这条语句执行的效果。</p><p><img src=\"https://static001.geekbang.org/resource/image/01/ef/0150301698979255a6f27711c35e9eef.png?wh=1490*154\" alt=\"\"></p><center><span class=\"reference\">图7 mixed格式和now()</span></center><p>可以看到，MySQL用的居然是statement格式。你一定会奇怪，如果这个binlog过了1分钟才传给备库的话，那主备的数据不就不一致了吗？</p><p>接下来，我们再用mysqlbinlog工具来看看：</p><p><img src=\"https://static001.geekbang.org/resource/image/1a/41/1ad3a4c4b9a71955edba5195757dd041.png?wh=1628*242\" alt=\"\"></p><center><span class=\"reference\">图8 TIMESTAMP 命令</span></center><p>从图中的结果可以看到，原来binlog在记录event的时候，多记了一条命令：SET TIMESTAMP=1546103491。它用 SET TIMESTAMP命令约定了接下来的now()函数的返回时间。</p><p>因此，不论这个binlog是1分钟之后被备库执行，还是3天后用来恢复这个库的备份，这个insert语句插入的行，值都是固定的。也就是说，通过这条SET TIMESTAMP命令，MySQL就确保了主备数据的一致性。</p><p>我之前看过有人在重放binlog数据的时候，是这么做的：用mysqlbinlog解析出日志，然后把里面的statement语句直接拷贝出来执行。</p><p>你现在知道了，这个方法是有风险的。因为有些语句的执行结果是依赖于上下文命令的，直接执行的结果很可能是错误的。</p><p>所以，用binlog来恢复数据的标准做法是，用 mysqlbinlog工具解析出来，然后把解析结果整个发给MySQL执行。类似下面的命令：</p><pre><code>mysqlbinlog master.000001  --start-position=2738 --stop-position=2973 | mysql -h127.0.0.1 -P13000 -u$user -p$pwd;\n</code></pre><p>这个命令的意思是，将 master.000001 文件里面从第2738字节到第2973字节中间这段内容解析出来，放到MySQL去执行。</p><h1>循环复制问题</h1><p>通过上面对MySQL中binlog基本内容的理解，你现在可以知道，binlog的特性确保了在备库执行相同的binlog，可以得到与主库相同的状态。</p><p>因此，我们可以认为正常情况下主备的数据是一致的。也就是说，图1中A、B两个节点的内容是一致的。其实，图1中我画的是M-S结构，但实际生产上使用比较多的是双M结构，也就是图9所示的主备切换流程。</p><p><img src=\"https://static001.geekbang.org/resource/image/20/56/20ad4e163115198dc6cf372d5116c956.png?wh=1142*856\" alt=\"\"></p><center><span class=\"reference\">图 9 MySQL主备切换流程--双M结构</span></center><p>对比图9和图1，你可以发现，双M结构和M-S结构，其实区别只是多了一条线，即：节点A和B之间总是互为主备关系。这样在切换的时候就不用再修改主备关系。</p><p>但是，双M结构还有一个问题需要解决。</p><p>业务逻辑在节点A上更新了一条语句，然后再把生成的binlog 发给节点B，节点B执行完这条更新语句后也会生成binlog。（我建议你把参数log_slave_updates设置为on，表示备库执行relay log后生成binlog）。</p><p>那么，如果节点A同时是节点B的备库，相当于又把节点B新生成的binlog拿过来执行了一次，然后节点A和B间，会不断地循环执行这个更新语句，也就是循环复制了。这个要怎么解决呢？</p><p>从上面的图6中可以看到，MySQL在binlog中记录了这个命令第一次执行时所在实例的server id。因此，我们可以用下面的逻辑，来解决两个节点间的循环复制的问题：</p><ol>\n<li>\n<p>规定两个库的server id必须不同，如果相同，则它们之间不能设定为主备关系；</p>\n</li>\n<li>\n<p>一个备库接到binlog并在重放的过程中，生成与原binlog的server id相同的新的binlog；</p>\n</li>\n<li>\n<p>每个库在收到从自己的主库发过来的日志后，先判断server id，如果跟自己的相同，表示这个日志是自己生成的，就直接丢弃这个日志。</p>\n</li>\n</ol><p>按照这个逻辑，如果我们设置了双M结构，日志的执行流就会变成这样：</p><ol>\n<li>\n<p>从节点A更新的事务，binlog里面记的都是A的server id；</p>\n</li>\n<li>\n<p>传到节点B执行一次以后，节点B生成的binlog 的server id也是A的server id；</p>\n</li>\n<li>\n<p>再传回给节点A，A判断到这个server id与自己的相同，就不会再处理这个日志。所以，死循环在这里就断掉了。</p>\n</li>\n</ol><h1>小结</h1><p>今天这篇文章，我给你介绍了MySQL binlog的格式和一些基本机制，是后面我要介绍的读写分离等系列文章的背景知识，希望你可以认真消化理解。</p><p>binlog在MySQL的各种高可用方案上扮演了重要角色。今天介绍的可以说是所有MySQL高可用方案的基础。在这之上演化出了诸如多节点、半同步、MySQL group replication等相对复杂的方案。</p><p>我也跟你介绍了MySQL不同格式binlog的优缺点，和设计者的思考。希望你在做系统开发时候，也能借鉴这些设计思想。</p><p>最后，我给你留下一个思考题吧。</p><p>说到循环复制问题的时候，我们说MySQL通过判断server id的方式，断掉死循环。但是，这个机制其实并不完备，在某些场景下，还是有可能出现死循环。</p><p>你能构造出一个这样的场景吗？又应该怎么解决呢？</p><p>你可以把你的设计和分析写在评论区，我会在下一篇文章跟你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>上期我留给你的问题是，你在什么时候会把线上生产库设置成“非双1”。我目前知道的场景，有以下这些：</p><ol>\n<li>\n<p>业务高峰期。一般如果有预知的高峰期，DBA会有预案，把主库设置成“非双1”。</p>\n</li>\n<li>\n<p>备库延迟，为了让备库尽快赶上主库。@永恒记忆和@Second Sight提到了这个场景。</p>\n</li>\n<li>\n<p>用备份恢复主库的副本，应用binlog的过程，这个跟上一种场景类似。</p>\n</li>\n<li>\n<p>批量导入数据的时候。</p>\n</li>\n</ol><p>一般情况下，把生产库改成“非双1”配置，是设置innodb_flush_logs_at_trx_commit=2、sync_binlog=1000。</p><p>评论区留言点赞板：</p><blockquote>\n<p>@way 同学提到了一个有趣的现象，由于从库设置了 binlog_group_commit_sync_delay和binlog_group_commit_sync_no_delay_count导致一直延迟的情况。我们在主库设置这两个参数，是为了减少binlog的写盘压力。备库这么设置，尤其在“快要追上”的时候，就反而会受这两个参数的拖累。一般追主备就用“非双1”（追上记得改回来）。</p>\n</blockquote><blockquote>\n<p>@一大只 同学验证了在sync_binlog=0的情况下，设置sync_delay和sync_no_delay_count的现象，点赞这种发现边界的意识和手动验证的好习惯。是这样的：sync_delay和sync_no_delay_count的逻辑先走，因此该等还是会等。等到满足了这两个条件之一，就进入sync_binlog阶段。这时候如果判断sync_binlog=0，就直接跳过，还是不调fsync。</p>\n</blockquote><blockquote>\n<p>@锅子 同学提到，设置sync_binlog=0的时候，还是可以看到binlog文件马上做了修改。这个是对的，我们说“写到了page cache”，就是文件系统的page cache。而你用ls命令看到的就是文件系统返回的结果。</p>\n</blockquote><p></p>","neighbors":{"left":{"article_title":"23 | MySQL是怎么保证数据不丢的？","id":76161},"right":{"article_title":"25 | MySQL是怎么保证高可用的？","id":76795}},"comments":[{"had_liked":false,"id":62468,"user_name":"Sinyo","can_delete":false,"product_type":"c1","uid":1307297,"ip_address":"","ucode":"57B243E7AB86A5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAibnPX9jW8kqLcIfibjic8GbkQkEUYyFKJkc39hZhibVlNrqwTjdLozkqibI2IwACd5YzofYickNxFnZg/132","comment_is_top":true,"comment_ctime":1548063827,"is_pvip":false,"replies":[{"id":"22091","content":"好问题，<br>是这样的，对于A的线程来说，就是“读文件”，<br>1. 如果这个文件现在还在 page cache中，那就最好了，直接读走；<br>2. 如果不在page cache里，就只好去磁盘读<br><br>这个行为是文件系统控制的，MySQL只是执行“读文件”这个操作","user_name":"作者回复","comment_id":62468,"uid":"1264162","ip_address":"","utype":1,"ctime":1548077632,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"9.2233727513673994e+18","product_id":100020801,"comment_content":"主库 A 从本地读取 binlog，发给从库 B；<br>老师，请问这里的本地是指文件系统的 page cache还是disk呢？","like_count":167,"discussions":[{"author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"雪の雫·雨の音","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":269323,"discussion_content":"明白了，这纯粹是操作系统干的事情了","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1589894518,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1650233,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2e/39/880d1122.jpg","nickname":"金盛昌","note":"","ucode":"8219A1C10F2E7C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"雪の雫·雨の音","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383102,"discussion_content":"原来如此","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625904420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":269323,"ip_address":""},"score":383102,"extra":""}]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437227,"discussion_content":"好问题，\n是这样的，对于A的线程来说，就是“读文件”，\n1. 如果这个文件现在还在 page cache中，那就最好了，直接读走；\n2. 如果不在page cache里，就只好去磁盘读\n\n这个行为是文件系统控制的，MySQL只是执行“读文件”这个操作","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1548077632,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1344431,"avatar":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","nickname":"马以","note":"","ucode":"3FEA06CA14DE28","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6382,"discussion_content":"原来如此，上节课我问了同样一个问题，原来是这样，没搞懂这个page cache！","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1566875147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":63592,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":true,"comment_ctime":1548410454,"is_pvip":false,"replies":[{"id":"22493","content":"好问题。<br><br>一开始创建主备关系的时候， 是由备库指定的。<br>比如基于位点的主备关系，备库说“我要从binlog文件A的位置P”开始同步， 主库就从这个指定的位置开始往后发。<br><br><br>而主备复制关系搭建完成以后，是主库来决定“要发数据给备库”的。<br><br>所以主库有生成新的日志，就会发给备库。<br>","user_name":"作者回复","comment_id":63592,"uid":"1264162","ip_address":"","utype":1,"ctime":1548413409,"user_name_real":"林晓斌"}],"discussion_count":11,"race_medal":0,"score":"9.2233725237344993e+18","product_id":100020801,"comment_content":"老师，我想问下双M架构下，主从复制，是不是一方判断自己的数据比对方少就从对方复制，判断依据是什么","like_count":114,"discussions":[{"author":{"id":1107305,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e5/69/719ec5d0.jpg","nickname":"Jian","note":"","ucode":"17ED4919F22DEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337396,"discussion_content":"如果同步的过程失败的会怎么办？会重试吗？\n","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1608891493,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1502074,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKb5BzdGZbSYHxq88kicdDtBh0yBtJpDAD81wruIsTsLdBysDZztrm8tYb4mBYvAI1ZE4lorKuvmgw/132","nickname":"java_lunsong","note":"","ucode":"180EEE6C8BCAA8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311912,"discussion_content":"互为主备那就是刚开始的时候双方都要指定一下，然后后面就主推过去","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1602519506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1117597,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0d/9d/58d09086.jpg","nickname":"达达队长","note":"","ucode":"1C3F2E4F6B7637","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":261649,"discussion_content":"插眼","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1588989151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437648,"discussion_content":"好问题。\n\n一开始创建主备关系的时候， 是由备库指定的。\n比如基于位点的主备关系，备库说“我要从binlog文件A的位置P”开始同步， 主库就从这个指定的位置开始往后发。\n\n\n而主备复制关系搭建完成以后，是主库来决定“要发数据给备库”的。\n\n所以主库有生成新的日志，就会发给备库。\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1548413409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1543040,"avatar":"https://static001.geekbang.org/account/avatar/00/17/8b/80/8702bd5f.jpg","nickname":"evan","note":"","ucode":"491B073D5AFEDE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320001,"discussion_content":"如果发生了主从切换, 切的当时从库binlog小于主库, 新的主库数据就会不完整? \n新的主库开始接受写请求, 又会传回原来的主库, 数据会被覆盖吗?\n也就是数据会永远的不一致","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1604224057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"汉江","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1543040,"avatar":"https://static001.geekbang.org/account/avatar/00/17/8b/80/8702bd5f.jpg","nickname":"evan","note":"","ucode":"491B073D5AFEDE","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347387,"discussion_content":"主备切换的时候 不是要指定开始同步位置嘛","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612227145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":320001,"ip_address":""},"score":347387,"extra":""}]},{"author":{"id":1676246,"avatar":"https://static001.geekbang.org/account/avatar/00/19/93/d6/040e4965.jpg","nickname":"Omer","note":"","ucode":"8EE3E531313265","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576752,"discussion_content":"如果主库因为网络原因，后发送的日志比先发送的日志先推给了从库，那会不会导致日志顺序不同，导致主从不一致呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655777382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1049510,"avatar":"https://static001.geekbang.org/account/avatar/00/10/03/a6/956b8734.jpg","nickname":"莫失铭忘","note":"","ucode":"BF0951AF9610E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555530,"discussion_content":"主备同步有点像redis的master和salve的操作了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646965034,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063923,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er4rbCWDxib3FHibYBouTwZqZBH6h5IgvjibEiaBv4Ceekib9SYg0peBBlFGu8hDuGvwjKp6LNznvEAibYw/132","nickname":"DonaldTrumpppppppppp","note":"","ucode":"211B1A25C53172","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554341,"discussion_content":"M","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646335761,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"吴小智","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":37878,"discussion_content":"备库最开始是怎么确定位置的呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571673781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1297858,"avatar":"https://static001.geekbang.org/account/avatar/00/13/cd/c2/4ffdf37b.jpg","nickname":"DJZhu","note":"","ucode":"82866CD74F1A6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"吴小智","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":46768,"discussion_content":"备库启动同步的时候指定开始同步的binlog和binlog内部位移的参数，分别是MASTER_LOG_FILE和MASTER_LOG_POS参数","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1573204236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":37878,"ip_address":""},"score":46768,"extra":""}]}]},{"had_liked":false,"id":73235,"user_name":"Joker","can_delete":false,"product_type":"c1","uid":1382003,"ip_address":"","ucode":"BD5B1AF491D60C","user_header":"https://static001.geekbang.org/account/avatar/00/15/16/73/c3aa4992.jpg","comment_is_top":false,"comment_ctime":1551843536,"is_pvip":false,"replies":[{"id":"28006","content":"好问题<br><br>一个事务的binlog日志不会被拆到两个binlog文件，所以会等到这个事务的日志写完再rotate，所以你会看见超过配置大小上限的binlog 文件","user_name":"作者回复","comment_id":73235,"uid":"1264162","ip_address":"","utype":1,"ctime":1552723906,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"486883147984","product_id":100020801,"comment_content":"老师您好，读到您关于binlog的文章之后，我有个疑问。<br>我之前理解是，mysql 每执行一条事务所产生的binlog准备写到 binlog file时，都会先判断当前文件写入这条binlog之后是否会超过设置的max_binlog_size值。 如果超过，则rotate 自动生成下个binlog flie 来记录这条binlog信息。<br>那如果 事务所有产生的binlog 大于  max_binlog_size 值呢？ 那不是永久地rotate吗？ mysql是如何处理的？<br>谢谢。","like_count":114,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441985,"discussion_content":"好问题\n\n一个事务的binlog日志不会被拆到两个binlog文件，所以会等到这个事务的日志写完再rotate，所以你会看见超过配置大小上限的binlog 文件","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1552723906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1082785,"avatar":"https://static001.geekbang.org/account/avatar/00/10/85/a1/2442332c.jpg","nickname":"郭俊杰","note":"","ucode":"D328E5738A4413","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2121,"discussion_content":"见到过","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1563269951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2166073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/k3YD3y3BzGDSdrwRJyJY4BXsNJibfM4uzOdDVKIAlFApR2FZCLg2ibrZtJ4vuahA3LHLW9GKzH5CMGqCDhWjhZqg/132","nickname":"戒酒的李白","note":"","ucode":"744E1A22761647","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":407775,"discussion_content":"学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635121496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57466,"user_name":"观弈道人","can_delete":false,"product_type":"c1","uid":1016905,"ip_address":"","ucode":"F3BB619A33C605","user_header":"https://static001.geekbang.org/account/avatar/00/0f/84/49/47d48fd0.jpg","comment_is_top":false,"comment_ctime":1546818258,"is_pvip":false,"replies":[{"id":"20717","content":"Mysqlbinlog有个参数—stop-datetime ","user_name":"作者回复","comment_id":57466,"uid":"1264162","ip_address":"","utype":1,"ctime":1546826131,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"323669365458","product_id":100020801,"comment_content":"老师你好，问个备份问题，假如周日23点做了备份，周二20点需要恢复数据，那么在用binlog恢复时，如何恰好定位到周日23点的binlog,谢谢。","like_count":76,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435590,"discussion_content":"Mysqlbinlog有个参数—stop-datetime ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546826131,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561166,"discussion_content":"时间也不靠谱,精确到微秒也是有可能有间隙的,通过位点才最准确","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1649566137,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":71369,"user_name":"妥妥","can_delete":false,"product_type":"c1","uid":1206716,"ip_address":"","ucode":"5BC1C85CF60CAD","user_header":"https://static001.geekbang.org/account/avatar/00/12/69/bc/c22bf219.jpg","comment_is_top":false,"comment_ctime":1551329523,"is_pvip":true,"replies":[{"id":"25540","content":"好问题，<br>会删除一条，但确实可能删除到之前的那条。<br><br>主要就是因为，没有主键的时候，binlog里面就不会记录主键字段。","user_name":"作者回复","comment_id":71369,"uid":"1264162","ip_address":"","utype":1,"ctime":1551331702,"user_name_real":"林晓斌"}],"discussion_count":10,"race_medal":0,"score":"250659432691","product_id":100020801,"comment_content":"老师，我想问下，如果一张表并没有主键，插入的一条数据和这张表原有的一条数据所有字段都是一样的，然后对插入的这条数据做恢复，会不会把原有的那条数据删除？不知道在没有主键的情况下binlog会不会也记录数据库为其生成的主键id","like_count":59,"discussions":[{"author":{"id":1526355,"avatar":"https://static001.geekbang.org/account/avatar/00/17/4a/53/063f9d17.jpg","nickname":"moonfox","note":"","ucode":"902BFF40EFA9FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307520,"discussion_content":"没有设置主键，在row模式下不会记录 innodb隐藏的主键id字段\n\nid 没有设置主键\ninsert into t_241 values(5,5,&#39;2018-11-09&#39;); \ninsert into t_241 values(5,5,&#39;2018-11-09&#39;);\n\n### INSERT INTO `mysql45`.`t_241`\n### SET\n###   @1=5 /* INT meta=0 nullable=0 is_null=0 */\n###   @2=5 /* INT meta=0 nullable=1 is_null=0 */\n###   @3=1541692800 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */\n# at 1395\n#200921 15:53:10 server id 1  end_log_pos 1426 CRC32 0x1e564d8b \tXid = 34\nCOMMIT/*!*/;\nSET @@SESSION.GTID_NEXT= &#39;AUTOMATIC&#39; /* added by mysqlbinlog */ /*!*/;\nDELIMITER ;\n# End of log file\n/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;\n/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;","likes_number":10,"is_delete":false,"is_hidden":false,"ctime":1600675290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2215928,"avatar":"https://static001.geekbang.org/account/avatar/00/21/cf/f8/86076de4.jpg","nickname":"宏彬","note":"","ucode":"8EFDD45EA62342","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394590,"discussion_content":"没有显示指定主键，两条一模一样的数据，删除哪一条都行，不影响最终结果","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1631950777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":441129,"discussion_content":"好问题，\n会删除一条，但确实可能删除到之前的那条。\n\n主要就是因为，没有主键的时候，binlog里面就不会记录主键字段。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1551331702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1250907,"avatar":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","nickname":"Monday","note":"","ucode":"77B9BACC783598","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296762,"discussion_content":"这也是我读到row格式时，想到问题","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1596640359,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"雪の雫·雨の音","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":269328,"discussion_content":"不是说没有设置主键的话innodb会自动分配一个rowid吗？我觉得可以用rowid来区分呀","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1589894806,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":2708697,"avatar":"","nickname":"李海龙","note":"","ucode":"766E49D0AE1434","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"雪の雫·雨の音","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":567306,"discussion_content":"会有rowid，看这样主从的一条记录的rowid并不一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650882142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":269328,"ip_address":""},"score":567306,"extra":""},{"author":{"id":1811277,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a3/4d/59390ba9.jpg","nickname":"排骨","note":"","ucode":"A413CF46211E1F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"雪の雫·雨の音","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572999,"discussion_content":"innodb是存储引擎层,binlog是server层,不一样的","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1653122519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":269328,"ip_address":""},"score":572999,"extra":""}]},{"author":{"id":1310826,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/6a/da96c764.jpg","nickname":"尹希闯","note":"","ucode":"A35F70179808D8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215631,"discussion_content":"我也记得前面说过没有设置主键字段的情况下，innodb会自动设主键。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585363485,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1335293,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKR3ibELhjgVicCNShZCBwvaDxibnzibggG4wUzVkS2mkDxUBZyIs87nDEdJ7PiahJBVoZcuhQ84RxAziag/132","nickname":"周治慧","note":"","ucode":"7D56C4E66BEE17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":195379,"discussion_content":"row\\模式下binlog会记录自动生成的主键","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583275252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099875,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c8/63/f94f9fda.jpg","nickname":"smily","note":"","ucode":"E2FDA059724A02","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":136438,"discussion_content":"没有主键的情况下，INNODB会强制加一个主键吗，如果BINLOG日志row格式，应该不会出现删除前一条的情况。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579141676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57582,"user_name":"HuaMax","can_delete":false,"product_type":"c1","uid":1118488,"ip_address":"","ucode":"2E78DE1AF098AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/11/18/8cee35f9.jpg","comment_is_top":false,"comment_ctime":1546841214,"is_pvip":false,"replies":[{"id":"20784","content":"是的，会","user_name":"作者回复","comment_id":57582,"uid":"1264162","ip_address":"","utype":1,"ctime":1546869601,"user_name_real":"林晓斌"}],"discussion_count":8,"race_medal":0,"score":"233475075198","product_id":100020801,"comment_content":"课后题。如果在同步的过程中修改了server id，那用原server id 生成的log被两个M认为都不是自己的而被循环执行，不知这种情况会不会发生","like_count":55,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435651,"discussion_content":"是的，会","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546869601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015877,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/80/45/d719f7df.jpg","nickname":"李和桃","note":"","ucode":"97E66953070EE0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":263713,"discussion_content":"这种只会循环执行一次吧。第二次server id又一致了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1589243723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":3006374,"avatar":"","nickname":"Geek_b870f9","note":"","ucode":"D270298B3C2292","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1015877,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/80/45/d719f7df.jpg","nickname":"李和桃","note":"","ucode":"97E66953070EE0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577203,"discussion_content":"备库执行主库的binlog后生成新的binlog，此时serverid也是主库的id，文章最后写了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655969881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":263713,"ip_address":""},"score":577203,"extra":""}]},{"author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":87313,"discussion_content":"同步的过程怎么修改server id?","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1576660776,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":160599,"discussion_content":"停掉服务，修改my.ini/my.cnf,[mysqld]下server-id，然后重启","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1580818762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":87313,"ip_address":""},"score":160599,"extra":""},{"author":{"id":1454272,"avatar":"https://static001.geekbang.org/account/avatar/00/16/30/c0/761ec683.jpg","nickname":"faker","note":"","ucode":"15212F3641253F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":280203,"discussion_content":"哪个dba敢这么改。。。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1591513681,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":160599,"ip_address":""},"score":280203,"extra":""},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1454272,"avatar":"https://static001.geekbang.org/account/avatar/00/16/30/c0/761ec683.jpg","nickname":"faker","note":"","ucode":"15212F3641253F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":286322,"discussion_content":"测试而已","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593134346,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":280203,"ip_address":""},"score":286322,"extra":""}]}]},{"had_liked":false,"id":57600,"user_name":"一大只😴","can_delete":false,"product_type":"c1","uid":1310960,"ip_address":"","ucode":"92F3D2B7F63568","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg","comment_is_top":false,"comment_ctime":1546845532,"is_pvip":false,"replies":[{"id":"21104","content":"赞","user_name":"作者回复","comment_id":57600,"uid":"1264162","ip_address":"","utype":1,"ctime":1547117575,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"186230439260","product_id":100020801,"comment_content":"死循环第二种情况：<br>双主，log_slave_updates=on，binlog_format=statement<br>配置文件里写成statement格式，然后两个master都重启<br>(从row格式改成statement试了几次没有成功,因为binlog中记录格式还是row)<br>测试：<br>表t (id ,c,d) 主键id，有一条数据(1,2,1);<br>M1执行 <br>     stop slave;<br>     update t set c=c+1 ;或 update t set c=c+1 where id=1;<br>     set global server_id=new_server_id；<br>     start slave；<br>然后就能看到c的值在不断变大，想停止就把server_id改回原来的就可以了。<br><br><br>","like_count":43,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435660,"discussion_content":"赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547117575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"汉江","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347398,"discussion_content":"改 server-id ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1612227711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2497728,"avatar":"https://static001.geekbang.org/account/avatar/00/26/1c/c0/b8ff566a.jpg","nickname":"我是大橙子132","note":"","ucode":"61660568CF07C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570386,"discussion_content":"会话级修改server_id来制造循环复制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651752733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57752,"user_name":"hua168","can_delete":false,"product_type":"c1","uid":1065255,"ip_address":"","ucode":"CFF9A7E86EBA48","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg","comment_is_top":false,"comment_ctime":1546897785,"is_pvip":false,"replies":[{"id":"20832","content":"运维现在要求也挺高的<br><br>第一个问题其实我也没看懂，“高峰期丢数据”是指主备延迟查不到数据，还是真的丢了，得先问清楚下<br><br>不过你回答的第二点不太好，低峰期重做这个大家都知道要这么做，而且只是修复动作，没办法用来定位原因，面试官是要问你分析问题的方法（方向错误）<br>重搭从库错误日志里面什么都没有的（这个比较可惜，暴露了对字节不够了解，一般不了解的方法在面试的时候是不如不说的）<br><br>第二个问题三点都是你回答的吗？那还算回答得可以的，但是不能只讲名词，要找个你熟悉细节的方案展开一下<br><br>三方向也是对的<br><br>我估计就是第一个问题减分比较厉害","user_name":"作者回复","comment_id":57752,"uid":"1264162","ip_address":"","utype":1,"ctime":1546917849,"user_name_real":"林晓斌"}],"discussion_count":6,"race_medal":0,"score":"164755655033","product_id":100020801,"comment_content":"大神，我前些天去面试，面试官问了一题:<br>mysql做主从，一段时间后发现从库在高峰期会发生一两条条数据丢失（不记得是查询行空白还是查询不到了），主从正常，怎么判断？<br>1.我问他是不是所以从库都是一样，他说不一样<br>2.我说低峰期重做新的从库观察，查看日志有没有报错？他好像不满意这个答案。<br><br> 二、他还问主库挂了怎么办？<br>1.  mysql主从+keepalived&#47;heartbeat<br>     有脑裂，还是有前面丢数据问题<br>2. 用MMM或HMA之类<br>3.用ZK之类<br><br>三、写的压力大怎么办？<br>我回答，分库，分表<br><br>感觉整天他都不怎么满意，果然没让我复试了，我郁闷呀，我就面试运维的，问数据这么详细。😂<br>大神，能说下我哪里有问题吗？现在我都想不明白😂","like_count":39,"discussions":[{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":250773,"discussion_content":"DBA面试会问运维的东西吧，java面试这些 基本等于凉了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1588039285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295331,"discussion_content":"java面试问这些的，也可以不用去啦，业务相关的不问？。。这种团队你去干啥？面试是双选，面试官选你，你也要通过看面试官的问题以及追问方式通过看面试官这个人猜猜这个团队的氛围","likes_number":22,"is_delete":false,"is_hidden":false,"ctime":1596166441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":250773,"ip_address":""},"score":295331,"extra":""}]},{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435741,"discussion_content":"运维现在要求也挺高的\n\n第一个问题其实我也没看懂，“高峰期丢数据”是指主备延迟查不到数据，还是真的丢了，得先问清楚下\n\n不过你回答的第二点不太好，低峰期重做这个大家都知道要这么做，而且只是修复动作，没办法用来定位原因，面试官是要问你分析问题的方法（方向错误）\n重搭从库错误日志里面什么都没有的（这个比较可惜，暴露了对字节不够了解，一般不了解的方法在面试的时候是不如不说的）\n\n第二个问题三点都是你回答的吗？那还算回答得可以的，但是不能只讲名词，要找个你熟悉细节的方案展开一下\n\n三方向也是对的\n\n我估计就是第一个问题减分比较厉害","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1546917849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2446024,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/GA9AqKGEdib009iaPw3FSluiaeibCXmen7yFIKicZB8qqEtczZJF2WmwBJ738eExnxDmPREIGjqc4BFVXiamyhuCZASw/132","nickname":"一缕阳光","note":"","ucode":"CA89C1B7CB16C0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587528,"discussion_content":"写压力大，面试官怕不是让你考虑分库分表来处理，应该是写并发比较大，服务器扛不住了，问你咋整。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663134872,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2053679,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/56/2f/4518f8e1.jpg","nickname":"放不下荣华富贵","note":"","ucode":"9FE29C22B9ABE3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576453,"discussion_content":"第一个问题，感觉面试官意思是是真的丢了，而非延迟查不到吧，否则就是面JAVA了。\n我觉得，问题应该可以转化为。。主从同步丢数据的场景。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655558283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1623575,"avatar":"https://static001.geekbang.org/account/avatar/00/18/c6/17/651e8d72.jpg","nickname":"Persist","note":"","ucode":"203596C835EAF2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290846,"discussion_content":"面试题打个卡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594622375,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":81731,"user_name":"三木禾","can_delete":false,"product_type":"c1","uid":1109458,"ip_address":"","ucode":"39C37228236860","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/d2/e3ae7ddd.jpg","comment_is_top":false,"comment_ctime":1554021475,"is_pvip":false,"replies":[{"id":"30224","content":"一般说双M是只AB之间设置为互为主备，不过任何时刻只有一个节点在接受更新的","user_name":"作者回复","comment_id":81731,"uid":"1264162","ip_address":"","utype":1,"ctime":1554653450,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"160467811427","product_id":100020801,"comment_content":"老师，双M可能会造成数据不一致的情况么? 比如，A  B同时更新同一条数据？","like_count":37,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445318,"discussion_content":"一般说双M是只AB之间设置为互为主备，不过任何时刻只有一个节点在接受更新的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554653450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2897549,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/36/8d/4527e1b2.jpg","nickname":"窗外的勇气","note":"","ucode":"9DAE4AD477266C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":551397,"discussion_content":"一般表按id自增长的话，应该设置分开的吧，比如一边只插入id为偶数的数据，另外一边插入id为奇数的数据。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645007874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":445318,"ip_address":""},"score":551397,"extra":""}]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":66674,"discussion_content":"双M,一定时是 相互独立数据的主,对方独立数据的备.所以就不存在同时更新的情况,若两个库都操作同一个数据,那以哪个为主呢?","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1575097314,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165676,"discussion_content":"如果是这样，其实双主的场景感觉有点多余，主备就够了。除非双主的存在的目的是为了方便很快的进行主备切换。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1581313400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62932,"user_name":"汪炜","can_delete":false,"product_type":"c1","uid":1307404,"ip_address":"","ucode":"64B548B9D06404","user_header":"https://static001.geekbang.org/account/avatar/00/13/f3/0c/b46fb155.jpg","comment_is_top":false,"comment_ctime":1548209249,"is_pvip":false,"replies":[{"id":"22261","content":"如果”redo没有及时刷盘，binlog刷盘了”之后瞬间数据库所在主机掉电，<br>主机重启，MySQL重启以后，这个事务会丢失；这里确实会引起日志和数据不一致，<br>这个就是我们说要默认设置为双1的原因之一哈","user_name":"作者回复","comment_id":62932,"uid":"1264162","ip_address":"","utype":1,"ctime":1548225420,"user_name_real":"林晓斌"}],"discussion_count":5,"race_medal":0,"score":"147577097313","product_id":100020801,"comment_content":"老师，问个问题，希望能被回答：<br>mmysql不是双一设置的时候，破坏了二阶段提交，事务已提交，redo没有及时刷盘，binlog刷盘了，这种情况，mysql是怎么恢复的，这个事务到底算不算提交？","like_count":35,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437409,"discussion_content":"如果”redo没有及时刷盘，binlog刷盘了”之后瞬间数据库所在主机掉电，\n主机重启，MySQL重启以后，这个事务会丢失；这里确实会引起日志和数据不一致，\n这个就是我们说要默认设置为双1的原因之一哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1548225420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1502074,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKb5BzdGZbSYHxq88kicdDtBh0yBtJpDAD81wruIsTsLdBysDZztrm8tYb4mBYvAI1ZE4lorKuvmgw/132","nickname":"java_lunsong","note":"","ucode":"180EEE6C8BCAA8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":311913,"discussion_content":"不设置双1的话就会有刷盘不同步的问题,mark","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1602519995,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2046179,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLAsbPRKgaVw8kKp5pKGUE4JdDZaW16RoRTItTI3wJ3pPGNoFIjYQm8FKa3xLlNwRicziclmWKsmp7kA/132","nickname":"清河","note":"","ucode":"AB44CB37FCB026","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303443,"discussion_content":"两阶段提交就是用来解决这个问题的，如果redo发现事务没有提交，并且也没有回滚，会去查询binlog，如果binlog里这个事务提交了，那redo也认为这个事务提交了。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1599266719,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3167302,"avatar":"","nickname":"Geek_eabafe","note":"","ucode":"4D94487320B33B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588125,"discussion_content":"如果binlog redolog 都写到page cache，此时mysql宕机了，但主机没有宕机，其实mysql重启时，还是不会丢数据的 对吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663564718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2739046,"avatar":"https://static001.geekbang.org/account/avatar/00/29/cb/66/c34226a9.jpg","nickname":"非墨","note":"","ucode":"6C2F75B04DA1EB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414257,"discussion_content":"由于binlog是完整的，重启后会提交事务，但主库redo log 和  内存数据的更改会丢失 ，但是备库已经拿到binlog去更新数据 ，此时主库的事务是不是就真的丢失了 ？从而主备数据不一致？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636703738,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67981,"user_name":"linqw","can_delete":false,"product_type":"c1","uid":1134138,"ip_address":"","ucode":"09DCFE98C54DD8","user_header":"https://static001.geekbang.org/account/avatar/00/11/4e/3a/86196508.jpg","comment_is_top":false,"comment_ctime":1550374175,"is_pvip":false,"replies":[{"id":"25259","content":"2. 流式发送，一个事务提交就会发<br>3. “回滚段也是先记录到内存，再记录在磁盘么？” 是的。  undolog(disk)不需要到data(disk)，undo log的作用看一下08篇<br>5. “update时，需要记录更新前后的数据，那这样的话，chage buffer不是用不上了么” ---  不是的，binlog里面的内容用的是主键索引上的，主键索引确实用不上change buffer，但是普通索引可以<br><br>","user_name":"作者回复","comment_id":67981,"uid":"1264162","ip_address":"","utype":1,"ctime":1551183659,"user_name_real":"林晓斌"}],"discussion_count":5,"race_medal":0,"score":"100334621983","product_id":100020801,"comment_content":"写下学习完这篇的总结和理解，老师有空帮忙看下哦<br>1、简单主备，一主多备，主进行更新操作，将生成binlog文件发送给备，但是比较好奇一点的是所有备向主拿binlog文件的时候，主都是一个线程进行将binlog文件依次发送给备么？两个库互为主备可以将一个负责数据的写入，生成binlog文件，另一个作为数据的同步，将其改变的binlog同步到自身，然后其他备再从其同步binlog，多master可以做到一台宕机，快速切换到另一台作为主，防止主库宕机对业务造成的影响，但是这样可能导致一定程度的同步延迟。<br>2、主备复制关系搭建完成，主有数据写入的时候，发送给备的应该不是整个binlog log文件吧，是每次写入的binlog event么？<br>3、在图 2 主备流程图对bg-thread-&gt;undolog(disk)-&gt;data(disk)不太理解，回滚段也是先记录到内存，再记录在磁盘么？undolog(disk)再到data(disk),看了下undo log的控制参数没有看到控制类似行为的，没想通？老师帮忙解答下哦<br>4、binlog的三种格式，statement,记录数据库原句，有可能导致，主备所选择的索引不一致，导致主备数据不一致。row，binlog log记录的是操作的字段值，根据binlog_row_image 的默认配置是 FULL包括操作行为的所有字段值，binlog_row_image 设置为 MINIMAL，则会记录必须的字段,一般设置为row，可以根据binlog文件做其他操作，比如在误删除一行数据时，可以做insert，恢复数据。<br>5、如果执行的是 update 语句的话，binlog 里面会记录修改前整行的数据和修改后的整行数据，在二级索引的普通索引，有个change buffer优化，防止频繁的将数据页读入进来，可以减少buffer pool的消耗，可以在读取数据时，再将其marge，或者后台线程marge，但是在binlog log设置row格式的，update时，需要记录更新前后的数据，那这样的话，chage buffer不是用不上了么？还是说设置成row格式的时候，change buffer会没生效？老师麻烦帮忙解答下哦，没想明白","like_count":24,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":439454,"discussion_content":"2. 流式发送，一个事务提交就会发\n3. “回滚段也是先记录到内存，再记录在磁盘么？” 是的。  undolog(disk)不需要到data(disk)，undo log的作用看一下08篇\n5. “update时，需要记录更新前后的数据，那这样的话，chage buffer不是用不上了么” ---  不是的，binlog里面的内容用的是主键索引上的，主键索引确实用不上change buffer，但是普通索引可以\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551183659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590037,"discussion_content":"update更新数据，要更新二级索引和主键索引上的值；主键索引本身使用不上change buffer，row格式的binlog，记录更新前的值，是通过主键索引获取的。二级索引仍然可以使用change buffer。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665482646,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2414796,"avatar":"","nickname":"Geek_36a6ce","note":"","ucode":"81FEEFB2EADCB3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574751,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654315417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2172764,"avatar":"https://static001.geekbang.org/account/avatar/00/21/27/5c/1c557c7e.jpg","nickname":"SaberA","note":"","ucode":"0795D520BB6CB9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390201,"discussion_content":"mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629711316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1785448,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/3e/68/c2b2a285.jpg","nickname":"will","note":"","ucode":"6843B14B09192F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":344841,"discussion_content":"Mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611583728,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":70043,"user_name":"陈扬鸿","can_delete":false,"product_type":"c1","uid":1284708,"ip_address":"","ucode":"DDDA8493CDC83C","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/64/eea9aa33.jpg","comment_is_top":false,"comment_ctime":1550974837,"is_pvip":false,"replies":[{"id":"24976","content":"最好是换硬件,把备库的磁盘能力提上来,<br><br>可以考虑一下备库设置 innodb_flush_log_at_trx_commit 和 sync_binlog 为非双1 试试","user_name":"作者回复","comment_id":70043,"uid":"1264162","ip_address":"","utype":1,"ctime":1550980970,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"83155353461","product_id":100020801,"comment_content":"老师，我现在生产上用的是MySQL5.6的主从同步，主库用的是ssd硬盘，备库用的是机械硬盘，现在从库落后主库好几个小时，主库上数据的写入更新比较大，这个问题是由于两端硬件问题造成的吗？线上只有一个数据库，有什么好的同步加速方案吗？麻烦老师给我解答一下，谢谢！","like_count":20,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440413,"discussion_content":"最好是换硬件,把备库的磁盘能力提上来,\n\n可以考虑一下备库设置 innodb_flush_log_at_trx_commit 和 sync_binlog 为非双1 试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550980970,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1082785,"avatar":"https://static001.geekbang.org/account/avatar/00/10/85/a1/2442332c.jpg","nickname":"郭俊杰","note":"","ucode":"D328E5738A4413","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2123,"discussion_content":"我想这位同学会采用第二种方式的，哈哈","likes_number":13,"is_delete":false,"is_hidden":false,"ctime":1563270017,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306028,"discussion_content":"什么公司呀这么抠门，为难技术人员","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1600150828,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57723,"user_name":"hetiu","can_delete":false,"product_type":"c1","uid":1056127,"ip_address":"","ucode":"35D9338C3ABD20","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/7f/aabc1b66.jpg","comment_is_top":false,"comment_ctime":1546875433,"is_pvip":false,"replies":[{"id":"20819","content":"双写？别双写。<br>","user_name":"作者回复","comment_id":57723,"uid":"1264162","ip_address":"","utype":1,"ctime":1546914614,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"83151254057","product_id":100020801,"comment_content":"老师，请教下双M模式是如何解决数据冲突的？","like_count":19,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435722,"discussion_content":"双写？别双写。\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1546914614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1284068,"avatar":"https://static001.geekbang.org/account/avatar/00/13/97/e4/c6b4d918.jpg","nickname":"Phoeson","note":"","ucode":"57328F475B2A61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":409906,"discussion_content":"为什么不建议双写，我看网上有这种方案，有两个参数可以设置auto_increment_increment 和 auto_increment_offset 来避免主键冲突，不知道双主互备哪里不好了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635528687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57667,"user_name":"古娜拉黑暗之神·巴啦啦能量·堕落达","can_delete":false,"product_type":"c1","uid":1185642,"ip_address":"","ucode":"080BBCEF7DE985","user_header":"https://static001.geekbang.org/account/avatar/00/12/17/6a/c979163e.jpg","comment_is_top":false,"comment_ctime":1546865609,"is_pvip":false,"replies":[{"id":"20789","content":"修改的行要读入内存呀<br><br>写binlog只需要主键索引上的值<br><br>你这个语句的话，如果字段c d上都有索引，那么c用不上chsnge buffer,<br>D可能可以同上","user_name":"作者回复","comment_id":57667,"uid":"1264162","ip_address":"","utype":1,"ctime":1546870002,"user_name_real":"林晓斌"}],"discussion_count":9,"race_medal":0,"score":"53086473161","product_id":100020801,"comment_content":"老师，您好，问一个关于change buffer的问题。<br>对于insert语句来说，change buffer的优化主要在非唯一的二级索引上，因为主键是唯一索引，插入必须要判断是否存在。<br>那么对于update语句呢？如下（假设c有非唯一索引，id是主键，d没有索引）：<br>update t set d=2 where c=10;<br>原先以为：从索引c取出id之后，不会回表，也不会把修改行的数据读入内存，而是直接在change buffer中记录一下。但看了今天得内容之后又迷糊了，因为如果不把修改行的数据读入内存，它又怎么把旧数据写入binlog中呢？<br>所以我想问的就是，上面的sql语句会不会把修改行的内容也读进内存？如果读进内存，那读进内存的这一步难道就为了写binlog吗？如果不读进内存，那binlog中的旧数据又是怎么来的呢？还有delete语句也同理。","like_count":12,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435693,"discussion_content":"修改的行要读入内存呀\n\n写binlog只需要主键索引上的值\n\n你这个语句的话，如果字段c d上都有索引，那么c用不上chsnge buffer,\nD可能可以同上","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1546870002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2158801,"avatar":"","nickname":"谭伟","note":"","ucode":"3ABC29245A7C22","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575959,"discussion_content":"这里还是没听懂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655211380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2158801,"avatar":"","nickname":"谭伟","note":"","ucode":"3ABC29245A7C22","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587788,"discussion_content":"更新操作既要更新聚簇索引也要更新所影响的二级索引的，所以聚簇索引肯定是要读取；所以row模式要获取老值跟change buffer优化完全不冲突，本来change buffer目的就只是优化二级普通索引的随机读而已","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1663294573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":575959,"ip_address":"广东"},"score":587788,"extra":""}]},{"author":{"id":1261530,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKDKsicmpne7xQNocwRQ80DDZ3CzjsDoVIcH0SBiaYzS056oVOx4pEeEVeCaXE3QtsjUIEI0x1xQVTw/132","nickname":"muggle","note":"","ucode":"D78087BCAD0860","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":533598,"discussion_content":"其实楼主就是对change buffer的生效范围迷糊了，并非使用了二级索引就会出发change buffer，而是只对二级索引有更新时，才触发change buffer的缓存。像楼主给出的例子，由于要对一个无索引字段进行修改，所以需要读入内存，此时change buffer的作用是在新的数据页读入内存时，进行数据页是否需要引用change buffer已存在的变动记录的判定。这一步是将大部分的随机磁盘读，改为了顺序磁盘读。change buffer在这里是有提升性能作用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637914448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2009461,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/a9/75/dbccd12d.jpg","nickname":"稻草人","note":"","ucode":"6694EE2CD36B8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":356054,"discussion_content":"根据SQL语句，字段c的值是不修改的，自然用不上change buffer。而字段d如果是建了非唯一二级索引的，那么这个字段d索引就用的上change buffer；如果没有建立索引，那么需要回表根据主键ID查出d值所在的page，然后更新，同时写binlog。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615523786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1937062,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8e/a6/c3286b61.jpg","nickname":"Java垒墙工程师","note":"","ucode":"E76AE44A9C76AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306032,"discussion_content":"change buffer 是随机磁盘写优化为顺序写，如果查询到change buffer中的数据，矫正page页数据用的，page页写回磁盘的时候写入磁盘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600152160,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1512642,"avatar":"https://static001.geekbang.org/account/avatar/00/17/14/c2/46ebe3a0.jpg","nickname":"侧耳倾听","note":"","ucode":"5BF2A2440B54F0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":249922,"discussion_content":"让老师整迷糊了，change buffer不是解决随机读吗？这怎么又读进内存了？那既然读进来了，还要buffer干嘛？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587975400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165683,"discussion_content":"chage buffer不是用在非唯一的普通索引上吗？为什么作者又说用在d字段上。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581314057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1043325,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/c9xpiakQ3OC1AlfCeW03lLnnb7mj5v35Hib8YDs66zpnVib2n2qFichFmFp2Ec4QDPR0dKh38MkBBLyD3bE4NiaanZQ/132","nickname":"龙晓","note":"","ucode":"FAF34F1C65D103","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352326,"discussion_content":"老师是说D有索引才用changebuffer，c没做变更不需要changebuffer，不知道理解对不对？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1614685177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":165683,"ip_address":""},"score":352326,"extra":""}]}]},{"had_liked":false,"id":57593,"user_name":"柚子","can_delete":false,"product_type":"c1","uid":1002136,"ip_address":"","ucode":"7641A699DA0CFD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/NhbRicjvf8v3K6D3v1FtOicxOciaPZQsCjCmuGCqea4vJeRVaLicKLpAcFQlcTgLvczBWY7SYDkeOtibxXj1PGl7Nug/132","comment_is_top":false,"comment_ctime":1546843803,"is_pvip":true,"replies":[{"id":"20753","content":"是的，当然还有minimal可选，会好些😄","user_name":"作者回复","comment_id":57593,"uid":"1264162","ip_address":"","utype":1,"ctime":1546850055,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"48791484059","product_id":100020801,"comment_content":"大佬您好，文中说现在越来越多的使用row方式的binlog，那么只能选择接受写入慢和占用空间大的弊端么？","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435658,"discussion_content":"是的，当然还有minimal可选，会好些😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546850055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1019302,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8d/a6/22c37c91.jpg","nickname":"楊_宵夜","note":"","ucode":"7BA0CADC5F23BB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405631,"discussion_content":"我认为是价值问题，毕竟，相比于“数据恢复”来说，“写入慢，空间大”这些事太小了，加硬盘升级设备就能搞定了。\n但数据丢了，恢复不了，那可不是小事。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634609111,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1794060,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/60/0c/e1f012cb.jpg","nickname":"frankie","note":"","ucode":"813D1352B68A21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360971,"discussion_content":"我们生产只可以使用row\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616569777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57962,"user_name":"不迷失","can_delete":false,"product_type":"c1","uid":1192774,"ip_address":"","ucode":"7FE6419F0CFEAD","user_header":"https://static001.geekbang.org/account/avatar/00/12/33/46/315a862e.jpg","comment_is_top":false,"comment_ctime":1546951573,"is_pvip":false,"replies":[{"id":"20892","content":"索引使用正确，不要出现全表扫描，其实OK的","user_name":"作者回复","comment_id":57962,"uid":"1264162","ip_address":"","utype":1,"ctime":1546953450,"user_name_real":"林晓斌"}],"discussion_count":8,"race_medal":0,"score":"44496624533","product_id":100020801,"comment_content":"请教一下，生产环境能不能使用正常使用表连接？要注意哪些地方？DBA总是说不建议用，还催促我将使用了表连接的地方改造，但也说不出个所以然。目前在两个百万级数据的表中有用到内连接，并没有觉得有什么问题","like_count":10,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435850,"discussion_content":"索引使用正确，不要出现全表扫描，其实OK的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546953450,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1657429,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwTZdUafC5YM7bCASt8icUnoyYfV4hUHulexibDI7B4eaokTxYXHFtoic97DBlCAU9j5Jw4QUuGhyZQ/132","nickname":"Carisy","note":"","ucode":"67E887967347BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":224420,"discussion_content":"可能是考虑到之后分库吧，之后分库关联的数据可能不在一个库","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1586306409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2046179,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ajNVdqHZLLAsbPRKgaVw8kKp5pKGUE4JdDZaW16RoRTItTI3wJ3pPGNoFIjYQm8FKa3xLlNwRicziclmWKsmp7kA/132","nickname":"清河","note":"","ucode":"AB44CB37FCB026","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303445,"discussion_content":"很多dba都是主机运维转过来的，对SQL或数据库理论了解没有那么深，很多要求是不合理的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599266939,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165681,"discussion_content":"对于互联网场景，建议不要使用数据库层面的join。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1581313943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561174,"discussion_content":"一般都是单表查,代码层关联。个人理解join不利于代码复用,后续重构,且影响数据库buffer..","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649568869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2249670,"avatar":"","nickname":"mofee888","note":"","ucode":"F1FB6F68DCF802","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346501,"discussion_content":"如果这样，那“关系型数据库”这个“关系”还有什么用呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611975474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1742868,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/JVOiclOoyFvgJHNXRgqB9RDyDueBHEP5lwATC47nFXRJibtK8ibU8phJPiav3BsPCUAssM1X82mnGtEe7bF91p39eA/132","nickname":"Geek_9d8be5","note":"","ucode":"20181C54A2C589","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283762,"discussion_content":"我想问，不用join那表之间的关联都单独去执行嘛～？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592357840,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1722041,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/46/b9/834d003b.jpg","nickname":"啦啦啦","note":"","ucode":"6A31CDDA7FD3F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1742868,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/JVOiclOoyFvgJHNXRgqB9RDyDueBHEP5lwATC47nFXRJibtK8ibU8phJPiav3BsPCUAssM1X82mnGtEe7bF91p39eA/132","nickname":"Geek_9d8be5","note":"","ucode":"20181C54A2C589","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330900,"discussion_content":"一般都是放在业务层面进行关联","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606727980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":283762,"ip_address":""},"score":330900,"extra":""}]}]},{"had_liked":false,"id":57462,"user_name":"守护.","can_delete":false,"product_type":"c1","uid":1327849,"ip_address":"","ucode":"14FE863C2FF948","user_header":"https://static001.geekbang.org/account/avatar/00/14/42/e9/e27c659d.jpg","comment_is_top":false,"comment_ctime":1546817472,"is_pvip":false,"replies":[{"id":"20716","content":"我的建议是不处理，自增主键id不连续应该作为常态，也就是说系统不要依赖于这个它必须要连续","user_name":"作者回复","comment_id":57462,"uid":"1264162","ip_address":"","utype":1,"ctime":1546826074,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"44496490432","product_id":100020801,"comment_content":"老师早，问一个和本次课题之外的问题.mysql 数据库，我如果开启多线程对多张表同时进行insert 操作. 每张表自增的主键id会不连续.这个问题怎么处理呢？","like_count":11,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435588,"discussion_content":"我的建议是不处理，自增主键id不连续应该作为常态，也就是说系统不要依赖于这个它必须要连续","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546826074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2303492,"avatar":"https://static001.geekbang.org/account/avatar/00/23/26/04/844be9df.jpg","nickname":"懒赫赫","note":"","ucode":"EDFB9B69ABB705","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411429,"discussion_content":"好奇问一下，不处理得化，多线程同时进行insert操作，假设操作到同一张表，会不会发生死锁","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635926575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":60310,"user_name":"Mackie .Weng","can_delete":false,"product_type":"c1","uid":1308336,"ip_address":"","ucode":"A86DDC5F3E2DD5","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/b0/837f5d36.jpg","comment_is_top":false,"comment_ctime":1547457030,"is_pvip":false,"replies":[{"id":"21549","content":"1. 有用，最好保留这些信息一起执行；<br>2. 提升不了多少速度的，花时间主要还是在更新数据的那些日志上，那些日志又不能去掉的：）<br>3. 这个方案是串行恢复。你可以把全量恢复出来的库，接成线上一个从库的备库，开并行复制，","user_name":"作者回复","comment_id":60310,"uid":"1264162","ip_address":"","utype":1,"ctime":1547461772,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"40202162694","product_id":100020801,"comment_content":"老师，你的课真好， 你讲的都是生产实际用到的，点赞~<br>不过近期有点苦恼，要请教一下近期遇到的事<br><br>场景：<br>SSD硬盘，我们数据一天一备份，想通过昨天凌晨备份+binlog恢复到最新数据，导出的binlog为2G，然后发现导入binlog花费了4，5小时，看了下binlog日志里面有很多这种信息<br># at 2492<br>#190108 17:08:38 server id 2  end_log_pos 2601 CRC32 0x8b0598ec         Query   thread_id=12277795      exec_time=0     error_code=0<br>SET TIMESTAMP=1546938518&#47;*!*&#47;;<br>BEGIN<br>&#47;*!*&#47;;<br># at 2601<br># at 2633<br># at 2919<br>#190108 17:08:38 server id 2  end_log_pos 2950 CRC32 0x13806369         Xid = 1924155105<br>COMMIT&#47;*!*&#47;;<br><br>问题：<br>1、在导出binlog为2G而且看了下里面很多这种事务，这是什么东西，有什么用吗<br>2、这种事务在导出binlog的时候可以不记录吗，然后来提高恢复数据的速度？<br>3、如果这是正常的情况，有无推荐更好的数据恢复方案或者工具<br><br>感谢老师","like_count":10,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436473,"discussion_content":"1. 有用，最好保留这些信息一起执行；\n2. 提升不了多少速度的，花时间主要还是在更新数据的那些日志上，那些日志又不能去掉的：）\n3. 这个方案是串行恢复。你可以把全量恢复出来的库，接成线上一个从库的备库，开并行复制，","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547461772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590055,"discussion_content":"从库并行复制，大赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665492457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":59016,"user_name":"风二中","can_delete":false,"product_type":"c1","uid":1131876,"ip_address":"","ucode":"73AC0AFB04931D","user_header":"https://static001.geekbang.org/account/avatar/00/11/45/64/2b09a36b.jpg","comment_is_top":false,"comment_ctime":1547272769,"is_pvip":true,"replies":[{"id":"21361","content":"对，只是一个举例的","user_name":"作者回复","comment_id":59016,"uid":"1264162","ip_address":"","utype":1,"ctime":1547277543,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"40201978433","product_id":100020801,"comment_content":"在主库执行这条 SQL 语句的时候，用的是索引 a；而在备库执行这条 SQL 语句的时候，却使用了索引 t_modified<br>老师，您好，这里索引选择不一样，是因为前面提到的mysql 会选错索引吗？这种情况应该发生比较少吧，这里应该都会选择索引a吧，还是说这里只是一个事例，还有更复杂的情况","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436270,"discussion_content":"对，只是一个举例的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547277543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1986739,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/50/b3/9269cd59.jpg","nickname":"LWD","note":"","ucode":"DDA444DB113C01","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587790,"discussion_content":"举个例子；如果主从延时很大，数据量就会影响索引的选择","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1663295067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58311,"user_name":"光","can_delete":false,"product_type":"c1","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1547034129,"is_pvip":true,"replies":[{"id":"21133","content":"这个的意思是， 现在工作线程里面等待的队列太多，都已经超过上限了，要等工作线程消化掉一些事务再分<br><br>简单说，就是备库的应用日志的队列太慢了。。","user_name":"作者回复","comment_id":58311,"uid":"1264162","ip_address":"","utype":1,"ctime":1547119849,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"35906772497","product_id":100020801,"comment_content":"林老师今天遇到个问题就是主从同步延迟，查到主从状态中出现：Slave_SQL_Running_State: Waiting for Slave Workers to free pending events。不知道这个是否会引起延迟。查了些资料说得都不是很明白。老师是否可以简短解答下。以及这种延迟如何避免。","like_count":9,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436004,"discussion_content":"这个的意思是， 现在工作线程里面等待的队列太多，都已经超过上限了，要等工作线程消化掉一些事务再分\n\n简单说，就是备库的应用日志的队列太慢了。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547119849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1599454,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLOKzDVXse2WibsBGOR27GVYOlv8WRtFBfQe4ekNia2S5986QibD6Wv17gyDpZqmQt3kJcAcbhl3rroQ/132","nickname":"itsxun","note":"","ucode":"69E6CEA3FCB4F3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287109,"discussion_content":"一针见血，哈哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593361642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57909,"user_name":"hua168","can_delete":false,"product_type":"c1","uid":1065255,"ip_address":"","ucode":"CFF9A7E86EBA48","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg","comment_is_top":false,"comment_ctime":1546938747,"is_pvip":false,"replies":[{"id":"20882","content":"其实要是我回答，我也只能说以主库为准按顺序重做，都过了这么久了还能咋样😓<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546949766,"ip_address":"","comment_id":57909,"utype":1}],"discussion_count":7,"race_medal":0,"score":"31611709819","product_id":100020801,"comment_content":"面试官说的是mysql做一主多从，读写分离，运行一段时间后，发现从库在业务高峰期不规律性出现从库丢失数据，而所有从库丢失的数据情况都不一样，在一个从库查询某条记录是空的（不记得是空白还是直接查不到，真的没数据了，并不是延迟了，主从没停，就是没写进从库），在另一个从库却能查到，有的在这个从库查到了，另一个从库查不到，因为运行了几个月客户反馈才发现此问题，不确定所有从库中哪个从库数据是没有丢失的，和主库一致，怎么办？<br>我回答:<br>1.在业务低峰期，锁库，重新做主从，但是如果一天不能同步完的话，白天主库还要解锁。不会搞了……<br>又不像mongoDB那样不用记录pos值😂<br>2.减少主库io压力试下，比如分库分表<br>3.查看日志之类……<br><br>二、mysql主库高可用<br>mysql主从+keepalived&#47;heatbeat<br>HMA&#47;MMM<br>ZK<br>是我看配置视频，老师简单讲了一下，我在网上搜的<br><br>三、主库写压力过大<br>只能通过分库，分表<br>也是我看linux运维培训视频老师说的","like_count":7,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435825,"discussion_content":"其实要是我回答，我也只能说以主库为准按顺序重做，都过了这么久了还能咋样😓\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546949766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1458200,"avatar":"https://static001.geekbang.org/account/avatar/00/16/40/18/cc3804e2.jpg","nickname":"沈洪彬","note":"","ucode":"F9911236D0BA1C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100211,"discussion_content":"分析问题的话: 1 第一做监控，查看是不是有sql延迟。或者binlog的io延迟导致的主从不一致\n                    2 可以记录不一致的数据(需要业务配合)么判断是不是最终一致性。还是判断时延迟还是真的不一致\n解决问题:\n                   1 如果是最终可以一致，那么就是延迟。\n                      1.1 根据原因解决一致性，还有就是想办法降低压力\n                      1.2 关联高的业务直接读主\n                  2 如果是真的已经不一致了，那么就重做呗。热备很快的。需要中间件切换或者业务配合\n        也可以考虑pt进行crc32 检测数据一致性或者 pt-sync修复 但是云上的话，可能不好用，没有super权限           ","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1577242503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":66685,"discussion_content":"是否考虑是因为基于statement同步数据导致 从库数据不一致?","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1575098199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1333649,"avatar":"https://static001.geekbang.org/account/avatar/00/14/59/91/fa2d8bb2.jpg","nickname":"不吃辣👾","note":"","ucode":"B25E0725B5E85F","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381611,"discussion_content":"我也觉得是基于statment做主从导致的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625143102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1794060,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/60/0c/e1f012cb.jpg","nickname":"frankie","note":"","ucode":"813D1352B68A21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360973,"discussion_content":"我也遇到过，主从正常，都是双yes,但是从库数据和主库不一致。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616570028,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1902913,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/09/41/32ff65b9.jpg","nickname":"Lets up","note":"","ucode":"784EC9E9ACC892","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291040,"discussion_content":"rc+statement,并行复制的话可能会有数据丢失吧，比如说delete条件不是主键","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594688625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2389270,"avatar":"https://static001.geekbang.org/account/avatar/00/24/75/16/6e28bf17.jpg","nickname":"初晨","note":"","ucode":"C5D95D13E49127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1902913,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/09/41/32ff65b9.jpg","nickname":"Lets up","note":"","ucode":"784EC9E9ACC892","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590058,"discussion_content":"RC目前已经不支持设置成statement格式了，容易造成主从不一致。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665493000,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":291040,"ip_address":"陕西"},"score":590058,"extra":""}]}]},{"had_liked":false,"id":90352,"user_name":"northpoplar","can_delete":false,"product_type":"c1","uid":1087178,"ip_address":"","ucode":"B83EF9C7915412","user_header":"https://static001.geekbang.org/account/avatar/00/10/96/ca/4af8614f.jpg","comment_is_top":false,"comment_ctime":1556498818,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27326302594","product_id":100020801,"comment_content":"做实验，需要的几个准备工作<br>查看binlog_format:<br>show session variables like &#39;binlog_format&#39;;<br>修改日志格式：<br>set session binlog_format=statement;<br>set session binlog_format=row;<br>查看日志文件列表：<br>show binary logs;<br>根据查看到的日志文件使用显示日志事件的命令:<br>show binlog events in &#39;XXX&#39;;","like_count":7},{"had_liked":false,"id":57951,"user_name":"鸠翱","can_delete":false,"product_type":"c1","uid":1116568,"ip_address":"","ucode":"7D498AF2BC4289","user_header":"https://static001.geekbang.org/account/avatar/00/11/09/98/b11c372b.jpg","comment_is_top":false,"comment_ctime":1546949658,"is_pvip":false,"replies":[{"id":"20897","content":"不能用在使用flashback机制恢复","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546957605,"ip_address":"","comment_id":57951,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27316753434","product_id":100020801,"comment_content":"也就是说 statement格式是不能用来恢复数据的是嘛……","like_count":6,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435844,"discussion_content":"不能用在使用flashback机制恢复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546957605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57614,"user_name":"牧鱼","can_delete":false,"product_type":"c1","uid":1360250,"ip_address":"","ucode":"0EB8FDD7A4BB2E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erFY9H3mxyTpZ9gxAmdeKic565hicicDZmv7cjswd8hdernmxib0chdQrlDNKUZQ8AticQCgDdgVEmJNuA/132","comment_is_top":false,"comment_ctime":1546851381,"is_pvip":false,"replies":[{"id":"20774","content":"1. 就是我们文中后面说的那些原因，要用这些binlog的内容去做别的事情😄<br>2. 对，固定模式下的。好问题，我去拉不下最新版本代码看下规则","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546854830,"ip_address":"","comment_id":57614,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27316655157","product_id":100020801,"comment_content":"老师好，mixed是row和statement的优点整合折中方案，这应该是好多系统设计理念吧？那么问题一：mixed既然能判断是什么时候使用row，什么时候使用statement，那么为什么好多推荐都是使用row而且不是使用mixed呢？是因为mixed这种模式下的自动选择转换不准确可能会出现主从问题吗？问题二：当使用mixed模式情况下，mysql内部是怎么判断的呢？比如有limit语句就会选择记录row格式，有now()函数还是同样会记录statement格式，mysql只是简单的某些特定场景下会使用记录row格式吗？谢谢。","like_count":6,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435666,"discussion_content":"1. 就是我们文中后面说的那些原因，要用这些binlog的内容去做别的事情😄\n2. 对，固定模式下的。好问题，我去拉不下最新版本代码看下规则","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546854830,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57893,"user_name":"夜空中最亮的星","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1546936907,"is_pvip":false,"replies":[{"id":"21115","content":"👍","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547118863,"ip_address":"","comment_id":57893,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23021773387","product_id":100020801,"comment_content":"这节课完全学懂了，开心😃","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435814,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547118863,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57892,"user_name":"夜空中最亮的星","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1546936826,"is_pvip":false,"replies":[{"id":"20880","content":"不会哦，1给2，2给3，3给1，1就放弃了<br><br>不过引入第三个节点的思路是对的哈😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546949313,"ip_address":"","comment_id":57892,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23021773306","product_id":100020801,"comment_content":"级联复制，3个数据库，首尾相连，应会出现死循环","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435813,"discussion_content":"不会哦，1给2，2给3，3给1，1就放弃了\n\n不过引入第三个节点的思路是对的哈😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546949313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1681374,"avatar":"https://static001.geekbang.org/account/avatar/00/19/a7/de/10d89f28.jpg","nickname":"谈港","note":"","ucode":"C4E49E1A9288AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":333137,"discussion_content":"三个及三个以上节点，其中一个在发出binlog之后还没有收到就挂掉了，这时候就没有节点来终止循环","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1607439443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":97177,"user_name":"还一棵树","can_delete":false,"product_type":"c1","uid":1317709,"ip_address":"","ucode":"C187F2A141D60E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eop9WylZJicLQxlvXukXUgPp39zJHyyReK5s1C9VhA6rric7GiarbfQMuWhdCCDdxdfL610Hc4cNkn9Q/132","comment_is_top":false,"comment_ctime":1558602185,"is_pvip":false,"replies":[{"id":"34893","content":"因为这个binlog event里面只删除了一条<br>所以在备库应用的时候，删了一条以后，就退出了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1558708659,"ip_address":"","comment_id":97177,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18738471369","product_id":100020801,"comment_content":"第二遍到这里啦，看留言有个疑问：<br>关于没有主键的表 有同样的两行数据，在主库上 limit 1 删除其中的一条，备库也是随机删除其中的一条。<br>这里有个疑问：解析主库的binlog 看到的row记录完整的binlog如下：<br># at 1245<br>#190523 16:58:32 server id 1  end_log_pos 1293 CRC32 0x598e440d         GTID    last_committed=0        sequence_number=0       rbr_only=no<br>SET @@SESSION.GTID_NEXT= &#39;f15197b2-f235-11e8-88f1-00163e02236b:6&#39;&#47;*!*&#47;;<br># at 1293<br>#190523 16:58:32 server id 1  end_log_pos 1365 CRC32 0x61325084         Query   thread_id=2     exec_time=0     error_code=0<br>SET TIMESTAMP=1558601912&#47;*!*&#47;;<br>BEGIN<br>&#47;*!*&#47;;<br># at 1365<br>#190523 16:58:32 server id 1  end_log_pos 1411 CRC32 0x2b9b4aea         Table_map: `test`.`bbb` mapped to number 78<br># at 1411<br>#190523 16:58:32 server id 1  end_log_pos 1451 CRC32 0x31dec98e         Delete_rows: table id 78 flags: STMT_END_F<br><br>BINLOG &#39;<br>uGDmXBMBAAAALgAAAIMFAAAAAE4AAAAAAAEABHRlc3QAA2JiYgABAwAB6kqbKw==<br>uGDmXCABAAAAKAAAAKsFAAAAAE4AAAAAAAEAAgAB&#47;&#47;4BAAAAjsneMQ==<br>&#39;&#47;*!*&#47;;<br>### DELETE FROM `test`.`bbb`<br>### WHERE<br>###   @1=1 &#47;* INT meta=0 nullable=1 is_null=0 *&#47;<br># at 1451<br>#190523 16:58:32 server id 1  end_log_pos 1482 CRC32 0xd6be57a8         Xid = 216<br>COMMIT&#47;*!*&#47;;<br><br>--从binlog看应该会删除2条的，但不知为什么只删除了一条，这个mysql是怎么控制的？","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451165,"discussion_content":"因为这个binlog event里面只删除了一条\n所以在备库应用的时候，删了一条以后，就退出了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558708659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":79912,"user_name":"D.L","can_delete":false,"product_type":"c1","uid":1339142,"ip_address":"","ucode":"E6DA186C4BB972","user_header":"https://static001.geekbang.org/account/avatar/00/14/6f/06/82d8bdfb.jpg","comment_is_top":false,"comment_ctime":1553573023,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"18733442207","product_id":100020801,"comment_content":"老师您好，我这里有个问题想问一下。在主库宕机后，还没同步到从库的binlog在从库上是看不到的，这种问题是如何解决的？","like_count":4,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583174,"discussion_content":"或者通过semi-repl的after_sync半同步复制最大限度的防止主从复制丢失，但还是有可能主从数据不一致的情况。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659940740,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583173,"discussion_content":"可以通过MHA高可用组件来实现，差异binlog的补齐","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659940696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1179156,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fe/14/f1532dec.jpg","nickname":"鲁班大师","note":"","ucode":"4F9615DF87B031","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301666,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598602839,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1297858,"avatar":"https://static001.geekbang.org/account/avatar/00/13/cd/c2/4ffdf37b.jpg","nickname":"DJZhu","note":"","ucode":"82866CD74F1A6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":46776,"discussion_content":"通过同步策略插件https://dev.mysql.com/doc/refman/8.0/en/replication-semisync.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573205727,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57821,"user_name":"小超","can_delete":false,"product_type":"c1","uid":1068004,"ip_address":"","ucode":"FCC8B303A16E70","user_header":"https://static001.geekbang.org/account/avatar/00/10/4b/e4/0219e7c8.jpg","comment_is_top":false,"comment_ctime":1546917609,"is_pvip":false,"replies":[{"id":"20833","content":" 逆向使用，可以用来解决死循环问题😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546917957,"ip_address":"","comment_id":57821,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18726786793","product_id":100020801,"comment_content":"老师，我看好多人留言都说改set global server_id来造成死循环的，这个server_id为什么不设置成只读，这种修改一般用来做什么用？","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435775,"discussion_content":" 逆向使用，可以用来解决死循环问题😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546917957,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2009461,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/a9/75/dbccd12d.jpg","nickname":"稻草人","note":"","ucode":"6694EE2CD36B8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":356058,"discussion_content":"除了改server_id还有其他会导致死循环的场景吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615524376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57585,"user_name":"一大只😴","can_delete":false,"product_type":"c1","uid":1310960,"ip_address":"","ucode":"92F3D2B7F63568","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/f0/08409e78.jpg","comment_is_top":false,"comment_ctime":1546842047,"is_pvip":false,"replies":[{"id":"20783","content":"👍🏿","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546869586,"ip_address":"","comment_id":57585,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18726711231","product_id":100020801,"comment_content":"思考题：<br>双主<br>M1 server_id 1363306 log_slave_updates=on<br>M2 server_id 1163306 log_slave_updates=on<br>双主复制正常<br>触发死循环场景：<br>test库中有一个t表(id int,c int,d int)，t表没有主键<br>M1执行：<br>stop slave;<br>insert into t values (3,3,3);<br>set global server_id=1373306 ;  ##变更M1的server_id<br>start slave;<br>然后就能看到M1和M2，一直在不停的插入(3,3,3)<br><br>我目前测试出来这一种情况，可能还有其它的触发方式，望补充<br>感觉这个机制不完善就是只依赖server_id作为判断是否是自身执行的语句，而且server_id还是动态变量，如果是只读也许会好的多<br><br><br><br><br>","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435653,"discussion_content":"👍🏿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546869586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":117407,"user_name":"远方夕阳","can_delete":false,"product_type":"c1","uid":1122317,"ip_address":"","ucode":"EEBCD53B2B5D3E","user_header":"https://static001.geekbang.org/account/avatar/00/11/20/0d/93967314.jpg","comment_is_top":false,"comment_ctime":1564041931,"is_pvip":false,"replies":[{"id":"43026","content":"就是说至少设置成mixed，实际上应该设置成row😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1564066558,"ip_address":"","comment_id":117407,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14448943819","product_id":100020801,"comment_content":"1你至少应该把 binlog 的格式设置为 mixed  <br>2虽然 mixed 格式的 binlog 现在已经用得不多了 <br>老师你好，这2句话出现在一起如何理解？","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459953,"discussion_content":"就是说至少设置成mixed，实际上应该设置成row😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564066558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57954,"user_name":"React","can_delete":false,"product_type":"c1","uid":1100554,"ip_address":"","ucode":"A176EF0AA242B5","user_header":"https://static001.geekbang.org/account/avatar/00/10/cb/0a/6a9e6602.jpg","comment_is_top":false,"comment_ctime":1546950331,"is_pvip":false,"replies":[{"id":"20898","content":"如果自增值严格控制了，也没必要设置跳过主键冲突了对吧（反正不冲突）<br><br>除非你的业务就是设计好支持多点写入，否则还是把不写入的都设置上readonly吧","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546957708,"ip_address":"","comment_id":57954,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14431852219","product_id":100020801,"comment_content":"老师好，文章前面说主从最好从机设置readonly.那么在双主的情况(互为主备)下，设置不同的自增值是否就可以不用设置只读了？且此时复制是否可以跳过主键冲突，因为自增值不同？","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435845,"discussion_content":"如果自增值严格控制了，也没必要设置跳过主键冲突了对吧（反正不冲突）\n\n除非你的业务就是设计好支持多点写入，否则还是把不写入的都设置上readonly吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546957708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":203145,"user_name":"icyricky","can_delete":false,"product_type":"c1","uid":1302556,"ip_address":"","ucode":"D63C285165309D","user_header":"https://static001.geekbang.org/account/avatar/00/13/e0/1c/aa50dc27.jpg","comment_is_top":false,"comment_ctime":1586143889,"is_pvip":false,"replies":[{"id":"75953","content":"对，契税super_read_only 也不影响同步","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1586171497,"ip_address":"","comment_id":203145,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10176078481","product_id":100020801,"comment_content":"这个问题，你不用担心。因为 readonly 设置对超级 (super) 权限用户是无效的，而用于同步更新的线程，就拥有超级权限。<br>觉得sql_thread属于内部线程，应该不受read_only和super_read_only影响吧。我们环境都是开的super_read_only（因为有次 误用root账号在从库更改了表结构），但是复制线程也没有出错。。不知道我的理解是否正确。。","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490782,"discussion_content":"对，契税super_read_only 也不影响同步","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586171497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":201643,"user_name":"hmm...","can_delete":false,"product_type":"c1","uid":1906140,"ip_address":"","ucode":"6AD2D7940C9BBF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/iaxgvyIjNFomECZvLAeRlfBITm6uaCv9l7nGg4nepMXxAsmNibtKNI16jgzT38DDJT5GXp1U1dU7JjU5a4rdoy8A/132","comment_is_top":false,"comment_ctime":1585815340,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10175749932","product_id":100020801,"comment_content":"双主结构相对于主从有什么优势呢？","like_count":2,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583175,"discussion_content":"老师这里说的双M，其实还是主备角色，其中备作为备主使用的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659940828,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062547,"avatar":"https://static001.geekbang.org/account/avatar/00/10/36/93/4ee65d90.jpg","nickname":"维尼熊","note":"","ucode":"01AB1525790DEB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550172,"discussion_content":"我也想知道","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644404490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77134,"user_name":"运斤成风","can_delete":false,"product_type":"c1","uid":1350812,"ip_address":"","ucode":"BAFF69C29FDFA5","user_header":"https://static001.geekbang.org/account/avatar/00/14/9c/9c/e02a0daf.jpg","comment_is_top":false,"comment_ctime":1552863111,"is_pvip":false,"replies":[{"id":"34326","content":"relaylog 是应用后就丢弃了的，binlog才会保存着","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1558261906,"ip_address":"","comment_id":77134,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10142797703","product_id":100020801,"comment_content":"老师好，双M的主从结构，binlog设置为row，主库上是不是保存了两份相同的日志数据？binlog和relay log？还是主库判断是自己生成的日志后就丢掉？谢谢","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443596,"discussion_content":"relaylog 是应用后就丢弃了的，binlog才会保存着","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1558261906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58515,"user_name":"秋一匹","can_delete":false,"product_type":"c1","uid":1351117,"ip_address":"","ucode":"BEBDBF8C15C6BC","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2au3iaQvydOVeVY1vlSVeGia7SvrpWFVibdxdjKiafof3RhzFO9e8sxKIBxKXJQibRNpO9pCH2hmibkibsGv7YKF3yjEw/132","comment_is_top":false,"comment_ctime":1547099515,"is_pvip":false,"replies":[{"id":"21176","content":"还是要给一下更具体的信息<br>比如主库的tps<br>备库的跟复制相关的配置等信息","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547134489,"ip_address":"","comment_id":58515,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10137034107","product_id":100020801,"comment_content":"老师，您好。我这慢了一步。。。学习晚了点。我这之前碰到了个问题，有一段时间主从复制延迟比较厉害，达到5s左右吧，一般都是1～2秒吧。首先排除不是网络原因。想问下还有哪些因素会影响主从复制呢？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436103,"discussion_content":"还是要给一下更具体的信息\n比如主库的tps\n备库的跟复制相关的配置等信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547134489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57654,"user_name":"汪炜","can_delete":false,"product_type":"c1","uid":1307404,"ip_address":"","ucode":"64B548B9D06404","user_header":"https://static001.geekbang.org/account/avatar/00/13/f3/0c/b46fb155.jpg","comment_is_top":false,"comment_ctime":1546861812,"is_pvip":false,"replies":[{"id":"20786","content":"可以的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546869691,"ip_address":"","comment_id":57654,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10136796404","product_id":100020801,"comment_content":"老师，设置 sync_binlog=0 的时候，binlog没刷盘的情况下，写到了 page cache，对吧，这个时候，从库能收到这个event吗？或者说一些binlog日志增量订阅能收到吗？","like_count":2,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435685,"discussion_content":"可以的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546869691,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343173,"user_name":"woJA1wCgAAegtr2ipn-nrwJ_dBQouJVw","can_delete":false,"product_type":"c1","uid":2983794,"ip_address":"","ucode":"D491F06E48532D","user_header":"","comment_is_top":false,"comment_ctime":1650689214,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5945656510","product_id":100020801,"comment_content":"老师您好，双M模式下，如果因为主机A 网络问题 失联，此时写入的数据到了B,如果A网络恢复后，B修改的数据为什么不会重新同步到A 呢？","like_count":1,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583177,"discussion_content":"不会，因为B并没有同步指向到A，所以通常来说建议B设置为readonly！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659940893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":318988,"user_name":"Geek_3800f3","can_delete":false,"product_type":"c1","uid":2555596,"ip_address":"","ucode":"4830639B5E787F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/m2Sanic5FCSDLNPvZNmeNVyiaIHOSl3GW8dpupHw047nFRp6xvEjwror7BuUdZOq8WT0VZ2hLQRkpxfSFA90ibzhw/132","comment_is_top":false,"comment_ctime":1635498492,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5930465788","product_id":100020801,"comment_content":"老师，我想问下，A是主库，B是从库情况，B突然宕机了，过一会B又恢复了，B再次恢复的时候,是如何同步数据的？","like_count":1,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583178,"discussion_content":"主从复制为长连接，每隔60秒钟会重试请求主从（B-&gt;A）连接的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659940997,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":281892,"user_name":"憨皮苏","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1614937283,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5909904579","product_id":100020801,"comment_content":"开启 GTID 场景下，行格式无论是 row 还是 statement，循环复制实验都没成功；<br>关闭 GTID 场景下，行格式为 statement，循环复制实验成功，<br>循环复制实验需注意两点<br>1. 关闭 GTID<br>2. 将 binlog_format 调整位 statement;","like_count":1},{"had_liked":false,"id":153400,"user_name":"随心而至","can_delete":false,"product_type":"c1","uid":1097836,"ip_address":"","ucode":"31866865255101","user_header":"https://static001.geekbang.org/account/avatar/00/10/c0/6c/29be1864.jpg","comment_is_top":false,"comment_ctime":1574230076,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5869197372","product_id":100020801,"comment_content":"自己在本地验证了下，的确是这样，参考了腾讯工程师带你深入解析 MySQL binlog<br>https:&#47;&#47;zhuanlan.zhihu.com&#47;p&#47;33504555 以及官方文档。<br>其实要想学的系统，后面还是再去看官方文档并且进一步实践的。","like_count":1},{"had_liked":false,"id":120286,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1564820459,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5859787755","product_id":100020801,"comment_content":"日志有许多的作用，问题定位和排查、责任认定和追踪、数据恢复&#47;同步&#47;备份&#47;分析等等，信息化社会数据就是主体呀!拥有了数据，就能做更多的事情。<br>WAL是许多高可用系统设计的基石，对MySQL而言 binlog更是功不可没。<br>binlog有三种格式<br>1：statement，记录数据操作的命令，<br>优点：对人友好，数据量小<br>缺点：不能用在使用flashback机制恢复<br>2：row 记录数据的操作，推荐的格式<br>优点：数据恢复小能手<br>缺点：数据量大，传输带宽和性能有损<br>3：mixed 自行判断使用statement格式还是row格式<br>优点：折中row格式的缺点<br>缺点：具体使用什么格式规则不明(目前我不清楚)，有些情况和常识相冲，其日志不能简单的拿来用于数据恢复<br>这些原理感觉比锁容易理解多了，也清晰多了，很受用，感谢老师。<br>","like_count":1},{"had_liked":false,"id":112052,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1562660682,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5857627978","product_id":100020801,"comment_content":"老师请问双M结构，节点判断server id的并决定是否丢弃的机制需要配置哪个参数吗？","like_count":1,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165690,"discussion_content":"程序判断吧。这种还想有别的处理想法嘛？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581314454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98978,"user_name":"ping","can_delete":false,"product_type":"c1","uid":1303688,"ip_address":"","ucode":"B60EF3B90D827E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJR5k5ThxFPZyew0UKNaq89utnIEQia2CiaxMOvacibGnbuZNpSiaaGTlRLWhmegxagELnIXfNveRxLfw/132","comment_is_top":false,"comment_ctime":1559123177,"is_pvip":false,"replies":[{"id":"37469","content":"额？ 你这个问题的前后逻辑我没看明白哈<br><br>mts是指多线程复制，设置级联复制是可以用的","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1560473269,"ip_address":"","comment_id":98978,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5854090473","product_id":100020801,"comment_content":"老师在问答环节提到 从库设置  binlog_group_commit_sync_delay      binlog_group_commit_sync_no_delay_count 会拖累主从同步，那么我们在设置 级联复制的时候，是不是就不能用 mts了呢？<br>","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":451916,"discussion_content":"额？ 你这个问题的前后逻辑我没看明白哈\n\nmts是指多线程复制，设置级联复制是可以用的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560473269,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58138,"user_name":"梁中华","can_delete":false,"product_type":"c1","uid":1006789,"ip_address":"","ucode":"52FE40242CBAD0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/c5/1231d633.jpg","comment_is_top":false,"comment_ctime":1547001725,"is_pvip":true,"discussion_count":2,"race_medal":1,"score":"5841969021","product_id":100020801,"comment_content":"我有一个比较极端一点的HA问题，假设主库的binlog刚写成功还未来得及把binlog同步到从库，主库就掉电了，这时候从库的数据会不完整吗？<br>第二个问题，原主库重启加入集群后，那条没有传出去的binlog会如何处理？","like_count":1,"discussions":[{"author":{"id":1115724,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwSoTjHPX5tm4whBSfoZLX6toZxrZGUaLABQywKNf4MDc9toK3QSV7Z99ATcGicFCysoleQ5ISzmw/132","nickname":"乘风","note":"","ucode":"0420C5535DACB7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":66689,"discussion_content":"1.会存在数据不一致性.分布式下最常见的.\n2.因为从库仍然记录着最后同步的顺序,所以数据会最终一致.\n  在redis中,会有这种策略,从节点启动时会检测自身状态,若与主库数据相差太大时会先同步数据并且暂停提供服务(也支持继续提供服务).\n\n\n\n\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1575098448,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1458200,"avatar":"https://static001.geekbang.org/account/avatar/00/16/40/18/cc3804e2.jpg","nickname":"沈洪彬","note":"","ucode":"F9911236D0BA1C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100227,"discussion_content":"看集群的做法：\n    如果是MAH，主库断电，如果机器可连，那么MHA会应用没应用的binlog\n                                      如果机器不可连，那么就真的丢了没应用的日志\n     如果需求特别高 就考虑半同步，就能保证数据不丢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577243556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57878,"user_name":"ccstorm","can_delete":false,"product_type":"c1","uid":1186888,"ip_address":"","ucode":"C08BC38BDCA73F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqyfwpUx3JgSX2IediaP7AUtYPVBjhy17OibD6e7owwBK0uF2rABzQYKSgiaCgFYibWrZ9b5ib55InmDpw/132","comment_is_top":false,"comment_ctime":1546933922,"is_pvip":false,"replies":[{"id":"20881","content":"够用就不动😄","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546949434,"ip_address":"","comment_id":57878,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5841901218","product_id":100020801,"comment_content":"老师，您好！请教一个课题之外的问题，请问mysql小版本需要更新么。我现在项目用的5.6，请问需要升级到5.7么，如果升级的话需要注意什么，谢谢老师！","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435805,"discussion_content":"够用就不动😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546949434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353708,"user_name":"田晶英","can_delete":false,"product_type":"c1","uid":2946356,"ip_address":"北京","ucode":"D058FBB71C5F00","user_header":"","comment_is_top":false,"comment_ctime":1659690556,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659690556","product_id":100020801,"comment_content":"1.从节点 A 更新的事务，binlog 里面记的都是 A 的 server id；<br>2.传到节点 B 执行一次以后，节点 B 生成的 binlog 的 server id 也是 A 的 server id；<br>3.再传回给节点 A，A 判断到这个 server id 与自己的相同，就不会再处理这个日志。所以，死循环在这里就断掉了。<br><br>您好，请问下，这个具体该怎么设置呢，是改配置吗？","like_count":0},{"had_liked":false,"id":352676,"user_name":"程序员班吉","can_delete":false,"product_type":"c1","uid":1478098,"ip_address":"","ucode":"BD48CF7649609A","user_header":"https://static001.geekbang.org/account/avatar/00/16/8d/d2/8a6be8d8.jpg","comment_is_top":false,"comment_ctime":1658858179,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658858179","product_id":100020801,"comment_content":"怎么手动模拟一个slave去master同步数据？MySQL有文档可以参考吗？","like_count":0},{"had_liked":false,"id":345943,"user_name":"打人不打脸","can_delete":false,"product_type":"c1","uid":1309484,"ip_address":"","ucode":"95D94EB72DF5A8","user_header":"https://static001.geekbang.org/account/avatar/00/13/fb/2c/8c37a254.jpg","comment_is_top":false,"comment_ctime":1652707839,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1652707839","product_id":100020801,"comment_content":"老师您好，双M模式下，同一时间触发了对同一数据的更新操作（并且请求分别打到了不同机子上），在做同步更新的时候怎么保证数据的正确性呢","like_count":0},{"had_liked":false,"id":343028,"user_name":"颜海航","can_delete":false,"product_type":"c1","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1650600819,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650600819","product_id":100020801,"comment_content":"3 主库 A 校验完用户名、密码后，开始按照备库 B 传过来的位置，从本地读取 binlog，发给 B。<br>老师 主库是发送binlog日志到从库吗？ 还是从库拉取binlog日志本地呀","like_count":0},{"had_liked":false,"id":342284,"user_name":"再见理想","can_delete":false,"product_type":"c1","uid":1245999,"ip_address":"","ucode":"FAC88B3F6F6DFD","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/2f/0a5e0751.jpg","comment_is_top":false,"comment_ctime":1650170074,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650170074","product_id":100020801,"comment_content":"备库通过消费主库的binlog实现主备数据一致性。<br>binlog有三种格式：<br>1.statement格式 记录sql语句。 存在导致主备不一致的情况。<br>2.row格式 记录行数据更改内容。 主备数据一致，但是记录内容较大，当执行删除1000行数据的sql语句时，statement格式只需要记录一条sql语句，而row格式需要记录1000条行更改的事件。<br>3.mixed 混合格式  正常情况下使用statement格式记录，在可能导致主备不一致的情况下，使用row格式记录。兼容两种格式的优点。<br>双主循环复制的解决方案：<br>通过判断 binlog中的serverId和数据库的serverId， 如果相同就不再重复执行该日志。","like_count":0},{"had_liked":false,"id":338434,"user_name":"张。","can_delete":false,"product_type":"c1","uid":1127147,"ip_address":"","ucode":"B8B6BCB0D9038E","user_header":"https://static001.geekbang.org/account/avatar/00/11/32/eb/37dad1cc.jpg","comment_is_top":false,"comment_ctime":1647503581,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647503581","product_id":100020801,"comment_content":"事务没提交可以读到binlog吗","like_count":0},{"had_liked":false,"id":322462,"user_name":"Geek_be775f","can_delete":false,"product_type":"c1","uid":2848324,"ip_address":"","ucode":"B40A323802EA96","user_header":"","comment_is_top":false,"comment_ctime":1637400159,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1637400159","product_id":100020801,"comment_content":"有没有什么工具， 只需要读取binlog文件 ，就可以生成表数据 ？ ","like_count":0},{"had_liked":false,"id":313500,"user_name":"听雨","can_delete":false,"product_type":"c1","uid":1254493,"ip_address":"","ucode":"252754F9FCFF0C","user_header":"https://static001.geekbang.org/account/avatar/00/13/24/5d/65e61dcb.jpg","comment_is_top":false,"comment_ctime":1632468610,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632468610","product_id":100020801,"comment_content":"老师您好：<br>1.如何知道删库跑路之前的精确时间点呢<br>2.如果有正常逻辑在误操作数据的基础上做了修改，这时候再恢复binlog，可能会导致数据错误，该如何避免呢","like_count":0},{"had_liked":false,"id":312827,"user_name":"不凡","can_delete":false,"product_type":"c1","uid":2031689,"ip_address":"","ucode":"28A3EC4C309C56","user_header":"","comment_is_top":false,"comment_ctime":1632042055,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1632042055","product_id":100020801,"comment_content":"老师我有个问题，M-M的架构下，节点A当前是master，节点B是slave，假设在A节点执行一个大事物T，update了100万行数据，在A节点传输binlog给B节点一半的时候，节点A宕机了，那对于节点B的relay_log是不是就不完整了<br>1.那么这个时候B节点relay_log是怎么处理这个事物的？<br>2.这时由keepalived将节点B切换为新的master了，那么这个大事物T的更新的数据是不是丢了？","like_count":0},{"had_liked":false,"id":309512,"user_name":"king🐳","can_delete":false,"product_type":"c1","uid":2557346,"ip_address":"","ucode":"88DA7981062AB5","user_header":"https://static001.geekbang.org/account/avatar/00/27/05/a2/24d5e88e.jpg","comment_is_top":false,"comment_ctime":1630206277,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630206277","product_id":100020801,"comment_content":"[root@www &#47;]# &#47;www&#47;server&#47;mysql&#47;bin&#47;mysqlbinlog -d test &#47;www&#47;server&#47;data&#47;mysql-bin.000015 --start-position=6970 | mysql  -uroot -p;<br>Enter password: <br>ERROR 1032 (HY000) at line 35: Can&#39;t find record in &#39;t&#39;<br>请教下这个错咋解决。。","like_count":0},{"had_liked":false,"id":301218,"user_name":"豆瓣酱","can_delete":false,"product_type":"c1","uid":2625639,"ip_address":"","ucode":"AF7525F7FE83E8","user_header":"https://static001.geekbang.org/account/avatar/00/28/10/67/49dfb810.jpg","comment_is_top":false,"comment_ctime":1625578752,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1625578752","product_id":100020801,"comment_content":"如果你用 MySQL 客户端来做这个实验的话，要记得加 -c 参数，否则客户端会自动去掉注释。 什么意思 怎么操作","like_count":0,"discussions":[{"author":{"id":1015184,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7d/90/abb7bfe3.jpg","nickname":"fourge","note":"","ucode":"F3E3FFC4990358","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583180,"discussion_content":" -c, --comments      Preserve comments. Send comments to the server. The default is --skip-comments (discard comments), enable  with --comments.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659941121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":296685,"user_name":"张诚","can_delete":false,"product_type":"c1","uid":1115702,"ip_address":"","ucode":"F623703194769B","user_header":"https://static001.geekbang.org/account/avatar/00/11/06/36/d288bcc7.jpg","comment_is_top":false,"comment_ctime":1623116328,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1623116328","product_id":100020801,"comment_content":"When row-based binary logging is used, the binlog_row_event_max_size system variable and its corresponding startup option --binlog-row-event-max-size set a soft limit on the maximum size of row events. The default value is 8192 bytes, and the value can only be changed at server startup. Where possible, rows stored in the binary log are grouped into events with a size not exceeding the value of this setting. If an event cannot be split, the maximum size can be exceeded.<br><br>当设置binlog_format = row时，有一个参数 binlog-row-event-max-size 默认值是8192字节。文中说这是一个软限制，当事件可分时，会将它分为多组，不可分时会超过大小。<br>我想问一下，可分与不可分的场景；mysql如何判断是否可分；判断是否可分的花销，与分之后带来的好处的对比。","like_count":0},{"had_liked":false,"id":293455,"user_name":"lleft","can_delete":false,"product_type":"c1","uid":1970443,"ip_address":"","ucode":"D573EB509455AE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","comment_is_top":false,"comment_ctime":1621393133,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1621393133","product_id":100020801,"comment_content":"老师，binlog是在什么时候同步到备库的？是在binlog落盘之后还是在什么时间？","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374911,"discussion_content":"看了下面的提问，自己回答，事务提交之后就会主动发送binlog给备库，binlog这时在page cache还是已经落盘到binlog file都没有关系了，在哪就从哪读","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621409974,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288116,"user_name":"ddomi","can_delete":false,"product_type":"c1","uid":2109640,"ip_address":"","ucode":"671D1957240FE7","user_header":"","comment_is_top":false,"comment_ctime":1618307109,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618307109","product_id":100020801,"comment_content":"对于文中内容<br>由于 statement 格式下，记录到 binlog 里的是语句原文，因此可能会出现这样一种情况：在主库执行这条 SQL 语句的时候，用的是索引 a；而在备库执行这条 SQL 语句的时候，却使用了索引 t_modified。因此，MySQL 认为这样写是有风险的。<br>主从之间表结构相同，数据和数据量也基本相同，可能会出现选择同一个语句选择不同索引的情况嘛","like_count":0},{"had_liked":false,"id":287941,"user_name":"TM","can_delete":false,"product_type":"c1","uid":1569910,"ip_address":"","ucode":"DCF88E51C5D2E8","user_header":"https://static001.geekbang.org/account/avatar/00/17/f4/76/5cc8d16e.jpg","comment_is_top":false,"comment_ctime":1618228458,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618228458","product_id":100020801,"comment_content":"老师，如果MySQL从库数据不一致了，怎么恢复？多个存库，存库间数据不一致？一主和多存数据不一致？都是一样的原理吗","like_count":0},{"had_liked":false,"id":286524,"user_name":"君君","can_delete":false,"product_type":"c1","uid":1046711,"ip_address":"","ucode":"0E8F1058F01C28","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erRDnCKfAWyOSUfU9hI8gYu2qsMOUwnFlCSngM0a9hbdnMmqHmBlziajorVdm9NGjx23SlAJXvicHGQ/132","comment_is_top":false,"comment_ctime":1617356135,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617356135","product_id":100020801,"comment_content":"文章中“我们可以用下面的逻辑，来解决两个节点间的循环复制的问题：”，意思是这个要我们自己实现吗？改源码？","like_count":0},{"had_liked":false,"id":284898,"user_name":"条","can_delete":false,"product_type":"c1","uid":1203836,"ip_address":"","ucode":"6F8679175256E3","user_header":"https://static001.geekbang.org/account/avatar/00/12/5e/7c/94af3f5e.jpg","comment_is_top":false,"comment_ctime":1616515162,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616515162","product_id":100020801,"comment_content":"老师好，对于主库A的binlog在page cache时中同步到了从库B，但是还没有fsync时A库crash的情况，A应该会回滚，这时A和B就不一致了，B怎么处理这个事务呢，是会将这个失败的信息通知到B库吗？","like_count":0},{"had_liked":false,"id":283732,"user_name":"Geek_2dd7e1","can_delete":false,"product_type":"c1","uid":1394305,"ip_address":"","ucode":"880A84387C9405","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/WNIeg1BYZHgfHHYY2fdzRvkVdbZGdMhVlxfiaQhEGRZIsT184hxfpd43T7omvKznn4iaBs8Cx0J1hqlpH72jPCQw/132","comment_is_top":false,"comment_ctime":1615898846,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615898846","product_id":100020801,"comment_content":"再传回给节点 A，A 判断到这个 server id 与自己的相同，就不会再处理这个日志。所以，死循环在这里就断掉了。感觉这里可以优化成发送binlog的时候在服务端判断更科学点","like_count":0},{"had_liked":false,"id":282336,"user_name":"syuan","can_delete":false,"product_type":"c1","uid":1215879,"ip_address":"","ucode":"D9BBC2ADAB5F2E","user_header":"https://static001.geekbang.org/account/avatar/00/12/8d/87/47d95f4a.jpg","comment_is_top":false,"comment_ctime":1615198809,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615198809","product_id":100020801,"comment_content":"老师，您好<br>一个备库接到 binlog 并在重放的过程中，生成与原 binlog 的 server id 相同的新的 binlog；<br>每个库在收到从自己的主库发过来的日志后，先判断 server id，如果跟自己的相同，表示这个日志是自己生成的，就直接丢弃这个日志。<br>这两条防止循环复制，通过什么参数控制？","like_count":0},{"had_liked":false,"id":276368,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1611901893,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611901893","product_id":100020801,"comment_content":"老师，同学们好，请问关于mysql集群，有没有讲到 mariadb galera集群的相关原理呢？","like_count":0},{"had_liked":false,"id":269523,"user_name":"刚毅木讷","can_delete":false,"product_type":"c1","uid":2304624,"ip_address":"","ucode":"67A36FBB162B69","user_header":"https://static001.geekbang.org/account/avatar/00/23/2a/70/6de74794.jpg","comment_is_top":false,"comment_ctime":1608691803,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608691803","product_id":100020801,"comment_content":"从节点 A 更新的事务，binlog 里面记的都是 A 的 server id；<br>传到节点 B 执行一次以后，节点 B 生成的 binlog 的 server id 也是 A 的 server id；<br>再传回给节点 A，A 判断到这个 server id 与自己的相同，就不会再处理这个日志。<br>所以，死循环在这里就断掉了。<br>是mysql自己判断，不用通过配置参数解决这个数据循环问题吧","like_count":0},{"had_liked":false,"id":267737,"user_name":"何磊","can_delete":false,"product_type":"c1","uid":1047604,"ip_address":"","ucode":"78934C3ED4A342","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fc/34/c733b116.jpg","comment_is_top":false,"comment_ctime":1607910008,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1607910008","product_id":100020801,"comment_content":"我在使用row格式的binlog时遇到一个现象。多次update同一行数据，如果update中set的值与db中的值相同，会返回影响0行。改成statement格式后没有这个问题。<br>麻烦老师帮忙解答下mysql如此设计的目的。<br>mysql版本：5.7+","like_count":0},{"had_liked":false,"id":260110,"user_name":"青玄","can_delete":false,"product_type":"c1","uid":1308848,"ip_address":"","ucode":"C21660BB9BE976","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/b0/d67cca7a.jpg","comment_is_top":false,"comment_ctime":1604925657,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604925657","product_id":100020801,"comment_content":"autoReconnect在文档中并不推荐使用, 我想知道为什么? 有大佬解答一下嘛? 说是要以合适的方式处理sqlException, 否则可能会出问题. 什么是合适的方式.","like_count":0},{"had_liked":false,"id":258542,"user_name":"dbtiger","can_delete":false,"product_type":"c1","uid":1324202,"ip_address":"","ucode":"05E8447593318C","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/aa/431de942.jpg","comment_is_top":false,"comment_ctime":1604478694,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604478694","product_id":100020801,"comment_content":"双活的话server_id要不同<br>并且设置如下2个参数：<br>log_bin=on<br>log_slave_updates=off<br>","like_count":0},{"had_liked":false,"id":252105,"user_name":"Wing","can_delete":false,"product_type":"c1","uid":1304201,"ip_address":"","ucode":"154CABA3CA394E","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/nNLq6GHrFNm6HrxWeMLf9t31G8fO1s1j3qk995thicplR8Oo2JOJ546aQPCsRND58Q0HyjrdtK1udgdemzR2eaA/132","comment_is_top":false,"comment_ctime":1602126971,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602126971","product_id":100020801,"comment_content":"delete 语句的例子 ， 本身 没有 order by ， 本来在 主库运行的时候就不是确定的。 <br><br>","like_count":0},{"had_liked":false,"id":249792,"user_name":"某浩","can_delete":false,"product_type":"c1","uid":2036290,"ip_address":"","ucode":"5CA12F6B5A38B1","user_header":"https://static001.geekbang.org/account/avatar/00/1f/12/42/9322abe6.jpg","comment_is_top":false,"comment_ctime":1600792443,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600792443","product_id":100020801,"comment_content":"老师讲得很好","like_count":0},{"had_liked":false,"id":247236,"user_name":"Magic","can_delete":false,"product_type":"c1","uid":1272047,"ip_address":"","ucode":"FD9CEDAA419EB0","user_header":"https://static001.geekbang.org/account/avatar/00/13/68/ef/6264ca3d.jpg","comment_is_top":false,"comment_ctime":1599638933,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599638933","product_id":100020801,"comment_content":"主库binlog传给备库执行后，发生重启，得到不同的serverid，这时备库再将原来的binlog给到“主库”执行，此时serverid判断准则失效，“主库”会继续执行，从而造成死循环。","like_count":0},{"had_liked":false,"id":246722,"user_name":"颜海航","can_delete":false,"product_type":"c1","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1599462794,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599462794","product_id":100020801,"comment_content":"        Seconds_Behind_Master: 148<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 330601<br>                  Master_UUID: 234a00c7-b7ed-11e8-9211-00163e0a68ff<br>             Master_Info_File: mysql.slave_master_info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Waiting for dependent transaction to commit<br>           Master_Retry_Count: 86400<br>老师 我们这个有个从库 一直有延迟 ，目前看每20分钟写满一个1G的binlog文件，记录的是一些java日志，每天都有上百G的增量，从库的SQL线程一直 Waiting for dependent transaction to commit这个状态，我该从哪些方面优化呢","like_count":0},{"had_liked":false,"id":246721,"user_name":"颜海航","can_delete":false,"product_type":"c1","uid":1308159,"ip_address":"","ucode":"5644F6328BF901","user_header":"https://static001.geekbang.org/account/avatar/00/13/f5/ff/523fb378.jpg","comment_is_top":false,"comment_ctime":1599462685,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599462685","product_id":100020801,"comment_content":"        Seconds_Behind_Master: 148<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 330601<br>                  Master_UUID: 234a00c7-b7ed-11e8-9211-00163e0a68ff<br>             Master_Info_File: mysql.slave_master_info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Waiting for dependent transaction to commit<br>           Master_Retry_Count: 86400","like_count":0},{"had_liked":false,"id":236109,"user_name":"Geek_4660f3","can_delete":false,"product_type":"c1","uid":1757482,"ip_address":"","ucode":"8B59B0C29EF88A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIMFaaIb1ZyU6zuYrT2WlD4RrsV2orxLonpIFwsx3ic01OLJ0N4dnSXQ3mFQxnbemiabKDw9810rX4Q/132","comment_is_top":false,"comment_ctime":1595319441,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1595319441","product_id":100020801,"comment_content":"请问一下老是，文中说的delete语句走t_modified索引和a索引会产生不一样的结果是为啥","like_count":0},{"had_liked":false,"id":232555,"user_name":"EveryDayIsNew","can_delete":false,"product_type":"c1","uid":1316926,"ip_address":"","ucode":"776B81EF6830FA","user_header":"https://static001.geekbang.org/account/avatar/00/14/18/3e/f8632713.jpg","comment_is_top":false,"comment_ctime":1594036687,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594036687","product_id":100020801,"comment_content":"这个双主互相同步更新，要是在用户注册场景怎么办，比如我和另外一个人同时注册一个账号，账号为唯一键，那不是复制冲突了","like_count":0},{"had_liked":false,"id":232117,"user_name":"Damo","can_delete":false,"product_type":"c1","uid":1599197,"ip_address":"","ucode":"F332EA67F5A40C","user_header":"https://static001.geekbang.org/account/avatar/00/18/66/dd/c9f17139.jpg","comment_is_top":false,"comment_ctime":1593858889,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593858889","product_id":100020801,"comment_content":"1. 老师，图 1 中，主切从，从切主是什么时机触发的？希望老师讲一下<br>2. 读写分离的好处是啥呀？具体场景有木有？","like_count":0},{"had_liked":false,"id":229667,"user_name":"张sir","can_delete":false,"product_type":"c1","uid":1209431,"ip_address":"","ucode":"52958DF6705208","user_header":"https://static001.geekbang.org/account/avatar/00/12/74/57/7b828263.jpg","comment_is_top":false,"comment_ctime":1593093662,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593093662","product_id":100020801,"comment_content":"老师，我有个问题，我怎么去查看当前主备是否在执行同步操作呢，又怎么看与主库的连接是否正常呢","like_count":0},{"had_liked":false,"id":227321,"user_name":"Geek_9d8be5","can_delete":false,"product_type":"c1","uid":1742868,"ip_address":"","ucode":"20181C54A2C589","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/JVOiclOoyFvgJHNXRgqB9RDyDueBHEP5lwATC47nFXRJibtK8ibU8phJPiav3BsPCUAssM1X82mnGtEe7bF91p39eA/132","comment_is_top":false,"comment_ctime":1592357733,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592357733","product_id":100020801,"comment_content":"老师，请问下，为什么要做主从呢？做了以后性能能提升多少呢？这个性能带来的提升与投入的开发运维成本相比是否值得呢？望解答","like_count":0},{"had_liked":false,"id":225451,"user_name":"Remember九离","can_delete":false,"product_type":"c1","uid":1237327,"ip_address":"","ucode":"97EE6E6344689F","user_header":"https://static001.geekbang.org/account/avatar/00/12/e1/4f/00476b4c.jpg","comment_is_top":false,"comment_ctime":1591758263,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1591758263","product_id":100020801,"comment_content":"本来这几篇关于主从的文章是一点都没看懂，这段时间项目需求，实践了，再回头看这些文章，瞬间清晰了。实践是检验真理的唯一标准。","like_count":0},{"had_liked":false,"id":216616,"user_name":"扬","can_delete":false,"product_type":"c1","uid":1315397,"ip_address":"","ucode":"E76C4791763EF3","user_header":"https://static001.geekbang.org/account/avatar/00/14/12/45/ecc7a922.jpg","comment_is_top":false,"comment_ctime":1589296577,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589296577","product_id":100020801,"comment_content":"老师，如果把sync_binlog 设置为100，那么异常重启之后，这段日志就丢失了，那么怎么保证主备同步的","like_count":0},{"had_liked":false,"id":208499,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1587371701,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1587371701","product_id":100020801,"comment_content":"老师，您好！<br>好像 io_thread 也能够实现 sql_thread 的功能，即 io_thread 读取 binlog 后直接落库，不写 deley_log，而且 io_thread 也可以像 sql_thread 一样，演变成多线程。<br>这里为啥要设计成 io_thread 和 sql_thread 吖？<br>谢谢老师！","like_count":0},{"had_liked":false,"id":206341,"user_name":"理帆","can_delete":false,"product_type":"c1","uid":1098526,"ip_address":"","ucode":"1B32202C229735","user_header":"https://static001.geekbang.org/account/avatar/00/10/c3/1e/633a1e87.jpg","comment_is_top":false,"comment_ctime":1586843848,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1586843848","product_id":100020801,"comment_content":"现在很多业务系统都基于 binlog 实现事件驱动设计，利用如阿里 Canal 的技术接收 binlog，并转换成业务事件。问题是因为写 binlog 发生在事务提交前，那接收此事件的系统在收到事件后，查询对应记录，是否有可能看到事务提交前的数据。","like_count":0,"discussions":[{"author":{"id":1107305,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e5/69/719ec5d0.jpg","nickname":"Jian","note":"","ucode":"17ED4919F22DEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335794,"discussion_content":"可以看到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608310601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":202952,"user_name":"Ryan","can_delete":false,"product_type":"c1","uid":1667987,"ip_address":"","ucode":"95BBBEE5B23878","user_header":"https://static001.geekbang.org/account/avatar/00/19/73/93/0a3a1e5b.jpg","comment_is_top":false,"comment_ctime":1586092567,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586092567","product_id":100020801,"comment_content":"了解了主从备份的思路，干货满满","like_count":0},{"had_liked":false,"id":198433,"user_name":"鲁班大师","can_delete":false,"product_type":"c1","uid":1179156,"ip_address":"","ucode":"4F9615DF87B031","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/14/f1532dec.jpg","comment_is_top":false,"comment_ctime":1585451149,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585451149","product_id":100020801,"comment_content":"如果 delete 语句使用的是索引 a，那么会根据索引 a 找到第一个满足条件的行，也就是说删除的是 a=4 这一行；<br>但如果使用的是索引 t_modified，那么删除的就是 t_modifed=&#39;2018-11-09’也就是 a=5 这一行。<br>---------------<br>为什么会出现这种情况呢","like_count":0},{"had_liked":false,"id":192005,"user_name":"运维老胡","can_delete":false,"product_type":"c1","uid":1227007,"ip_address":"","ucode":"DF398BEE296E11","user_header":"https://static001.geekbang.org/account/avatar/00/12/b8/ff/249da6da.jpg","comment_is_top":false,"comment_ctime":1584810135,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584810135","product_id":100020801,"comment_content":"用binlogserver应用binlog是个不错的方法","like_count":0},{"had_liked":false,"id":187256,"user_name":"Geek_bf14f3","can_delete":false,"product_type":"c1","uid":1305789,"ip_address":"","ucode":"DE43BE8DDE6CFD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIfT8quy2V8eMGrFZNQp1riaB8zz767gDMQhgybXB8ZvmXJNiaHWYxpLfy75mjKo5R5C8cOkj8JLYtA/132","comment_is_top":false,"comment_ctime":1584069945,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1584069945","product_id":100020801,"comment_content":"您好，周一用mysqldump做了一个全备，使用了--single-transaction，这期间有一个一直没有提交的事务，备份完后事务提交了。周二使用全备+binlog恢复，不知道是否会恢复这个之前没有提交的事务？","like_count":0,"discussions":[{"author":{"id":1373454,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/1hp9kzzuLUVHzmmddIPIO2OgUWr1ibJRr8cMoB7K0fwx8Vmn34L8yN2NoYUtgNicfPGaXKF02pQ2huXd59r2I0kw/132","nickname":"三胖","note":"","ucode":"CD69FCD606FC5C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282149,"discussion_content":"会啊，事务提交了就会写到binlog。重复看多几遍课程吧，感觉你还没理解事务和日志这两块的内容","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591891067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":186944,"user_name":"weineel","can_delete":false,"product_type":"c1","uid":1049741,"ip_address":"","ucode":"6DC6EF4F256A53","user_header":"https://static001.geekbang.org/account/avatar/00/10/04/8d/005c2ff3.jpg","comment_is_top":false,"comment_ctime":1583977533,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1583977533","product_id":100020801,"comment_content":"双 M 中，A 把 binglog 发给 B, B执行完成后，判断 server id 不是自己，生成的 binlog 就不发给 A 了,不是可以提前断开死循环吗？这样会有什么问题吗？","like_count":0},{"had_liked":false,"id":183720,"user_name":"spuryin","can_delete":false,"product_type":"c1","uid":1221753,"ip_address":"","ucode":"17474DCB7D293D","user_header":"https://static001.geekbang.org/account/avatar/00/12/a4/79/35ab3a19.jpg","comment_is_top":false,"comment_ctime":1583119999,"is_pvip":false,"replies":[{"id":"71135","content":"备库同步有延迟吗<br>","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1583128110,"ip_address":"","comment_id":183720,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1583119999","product_id":100020801,"comment_content":"问个工作中遇到的问题，不知道还能不能有人回答，MySQL版本都是5.6，主库有个计算排名的逻辑，计算完排名后，备库备份的数据偶尔会有问题，有时候会发现备库没计算排名，有时候排名计算的和主库不一致，这两种情况，只要在主库重新运行一下计算排名的逻辑，备库数据就对了，不知道什么原因","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485761,"discussion_content":"备库同步有延迟吗\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583128110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292461,"discussion_content":"binlog_format这是的是什么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595234868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1221753,"avatar":"https://static001.geekbang.org/account/avatar/00/12/a4/79/35ab3a19.jpg","nickname":"spuryin","note":"","ucode":"17474DCB7D293D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":204096,"discussion_content":"抱歉这么久回复，基本没有延迟","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584113403,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":179254,"user_name":"陈大头","can_delete":false,"product_type":"c1","uid":1335400,"ip_address":"","ucode":"F1CA8837BF1E5C","user_header":"https://static001.geekbang.org/account/avatar/00/14/60/68/626cb455.jpg","comment_is_top":false,"comment_ctime":1581945598,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1581945598","product_id":100020801,"comment_content":"这让我想起我之前做的一个需求，程序部署国内外，数据需要同步，我们最开始是通过数据生成国字段与程序部署服务器所属国字段去判断是否需要同步的，后面就改成用一个flag，在生成同步文件的时候先判断flag，如果等于false，就把flag设置为true，然后写入文件进行同步，不然就不写入","like_count":0},{"had_liked":false,"id":174839,"user_name":"华融科技","can_delete":false,"product_type":"c1","uid":1808280,"ip_address":"","ucode":"B6BA3C47C05073","user_header":"","comment_is_top":false,"comment_ctime":1580429560,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1580429560","product_id":100020801,"comment_content":"老师，根据主备流程图，masterA 在binlog完成，同时开始了2个动作：<br>1. redo log commit (这时会更新redo log commit 状态到 redo log 磁盘文件<br>2. dump_thread 线程会同步binlog 到slaveB,<br>问题，会不会出现 redo log commit 比 dump_thread 慢，这时突然断电了， salveB有了最新的binlog， 但 redo log commit没完成，从而两边数据不一致？ 如果是不会出现这种情况，是如何保障 redo log commit一定先于 binlog同步 ？谢谢！","like_count":0,"discussions":[{"author":{"id":1107305,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e5/69/719ec5d0.jpg","nickname":"Jian","note":"","ucode":"17ED4919F22DEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335795,"discussion_content":"这种情况会出现两边数据不一致","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608310823,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171997,"user_name":"最初的印象","can_delete":false,"product_type":"c1","uid":1228852,"ip_address":"","ucode":"4DD68307FA274E","user_header":"https://static001.geekbang.org/account/avatar/00/12/c0/34/0574bb44.jpg","comment_is_top":false,"comment_ctime":1579067063,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1579067063","product_id":100020801,"comment_content":"每篇都干货满满！！","like_count":0},{"had_liked":false,"id":169076,"user_name":"Sic Pavis","can_delete":false,"product_type":"c1","uid":1106088,"ip_address":"","ucode":"48B5F0118347C8","user_header":"https://static001.geekbang.org/account/avatar/00/10/e0/a8/4e739cf6.jpg","comment_is_top":false,"comment_ctime":1578271306,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1578271306","product_id":100020801,"comment_content":"再传回给节点 A，A 判断到这个 server id 与自己的相同，就不会再处理这个日志。所以，死循环在这里就断掉了。<br><br>这里是不是由binlog产生方判断更好？库接受到binlog，自己执行后生成一个相同server id的binlog，本地应该是有存一份server id的集群配置的吧，只把binlog传输给server id不同的库，不是节约了很多网络开销了吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165693,"discussion_content":"带一个id没啥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581314592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163129,"user_name":"ub8","can_delete":false,"product_type":"c1","uid":1481811,"ip_address":"","ucode":"0D937C3EAEB781","user_header":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","comment_is_top":false,"comment_ctime":1576661024,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1576661024","product_id":100020801,"comment_content":"老师您好，看到图 2 主备流程图 中 画的提到了 undolog , 我一直搞不清楚，undolog,binlog,redolog,三个日志文件的写入入口，比如执行一句update , mysql中如何，对这几个日志进行操作的？这几个日志间的数据又是如何保证一致的呢？","like_count":0,"discussions":[{"author":{"id":1226968,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg","nickname":"hcyycb","note":"","ucode":"77FF6CA41F9E66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":410785,"discussion_content":"图二其实就已经将这三个日志串起来了。更新数据库的时候，就在内存中更新——对应数据记录就有新的版本、即undolog。在更新数据记录时，当然也会生成redolog，redolog在事务提交后，需要两阶段步骤才能保证和binlog一致。binlog在redolog的prepare阶段就开始写，当binlog也写完，redolog就变成commit阶段啦。\n图二里还有一个后台线程，负责将undolog落盘，因为数据都是在内存中心更改的，所以，mysql会在某个时刻将内存中的数据真正fsync到磁盘。注意不要和redolog、binlog的持久化混淆。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635776509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":160630,"discussion_content":"redolog和undo log是更新操作执行完就有了，binlog是事务提交才有，只有binlog会在有效期内一直存在。详细的前面教程都有讲到的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580821136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157037,"user_name":"九喇嘛","can_delete":false,"product_type":"c1","uid":1732339,"ip_address":"","ucode":"8845322554C33D","user_header":"https://static001.geekbang.org/account/avatar/00/1a/6e/f3/0789b0ac.jpg","comment_is_top":false,"comment_ctime":1575016495,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1575016495","product_id":100020801,"comment_content":"老师，请问MySQL数据库执行主备同步的时候，效率是怎么样的？<br>之前向数据库插入千万量级的数据，binlog磁盘只有20G，执行时间长了，磁盘不够了，需要删除，根据DBA的建议，删除更早时间生成的日志（每次删除都预留好几个binlog文件），有几次出现数据库主从不同步，DBA给的定位是binlog问题。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165694,"discussion_content":"看是什么格式的binlog","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581314650,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":153321,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1015754,"ip_address":"","ucode":"00DF2FEC58D2E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","comment_is_top":false,"comment_ctime":1574216264,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574216264","product_id":100020801,"comment_content":"我binlog博大精深啊...","like_count":0},{"had_liked":false,"id":151852,"user_name":"张大人","can_delete":false,"product_type":"c1","uid":1200544,"ip_address":"","ucode":"4FCA71788DEB29","user_header":"https://static001.geekbang.org/account/avatar/00/12/51/a0/f3bb1dd7.jpg","comment_is_top":false,"comment_ctime":1573799944,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1573799944","product_id":100020801,"comment_content":"老师，请问一下，主库binlog还在buffer中的情况下，dump线程会不会将binlog发送到从库？还是说必须binlog落盘了，然后dump线程再去读binlog并发送给从库？","like_count":0,"discussions":[{"author":{"id":1970443,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","nickname":"lleft","note":"","ucode":"D573EB509455AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374912,"discussion_content":"事务提交了就可以发送，这时binlog要么在page cache要么落盘了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621410229,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1107305,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e5/69/719ec5d0.jpg","nickname":"Jian","note":"","ucode":"17ED4919F22DEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":335797,"discussion_content":"必须落盘才发binlog给从库","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608310948,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149068,"user_name":"笑着活下去","can_delete":false,"product_type":"c1","uid":1621001,"ip_address":"","ucode":"23B8B4F9390A2B","user_header":"https://static001.geekbang.org/account/avatar/00/18/bc/09/d6b138fb.jpg","comment_is_top":false,"comment_ctime":1573135284,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1573135284","product_id":100020801,"comment_content":"老师，能不能讲一节课的undo log日志？","like_count":0,"discussions":[{"author":{"id":1453053,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","nickname":"温故而知新可以为师矣","note":"","ucode":"FADCDFA9F9E5E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":160632,"discussion_content":"隔离级别哪里有讲到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580821204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140669,"user_name":"一一","can_delete":false,"product_type":"c1","uid":1344255,"ip_address":"","ucode":"29D73AC1DCFFB6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/JkMtA7dN7V9Z9iaX2w5zTuPOU6mxhARmEZxicXG7vOs5snjAQrlU0Km8pk9eOibJlhdV3aQk2zkFXOQwZEu1mDgLg/132","comment_is_top":false,"comment_ctime":1571025610,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571025610","product_id":100020801,"comment_content":"老师，有个问题想请教下，binlog_rows_query_log_events参数开启的话是除了记录sql语句更改前后的信息之外还记录原始的sql语句。<br>想问下如果这个参数关闭后在哪些情境下会受到影响呢。（比如使用Flashback恢复的时候会受这个参数的影响吗？）","like_count":0},{"had_liked":false,"id":131214,"user_name":"幸猴儿(๑òᆺó๑)","can_delete":false,"product_type":"c1","uid":1312709,"ip_address":"","ucode":"16294369690484","user_header":"https://static001.geekbang.org/account/avatar/00/14/07/c5/b91d88d2.jpg","comment_is_top":false,"comment_ctime":1567672425,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1567672425","product_id":100020801,"comment_content":"老师我想问一下，如果是双m架构，key键自增，会不会有这种情况键值是正常的，但是内容不一样了。如果有有解决办法吗。","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165697,"discussion_content":"是不是插入后有更新，导致主从暂时不同步，被你看到就误认为内容不一样。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1581314774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129244,"user_name":"MrVito","can_delete":false,"product_type":"c1","uid":1252169,"ip_address":"","ucode":"716FF6F8871706","user_header":"https://static001.geekbang.org/account/avatar/00/13/1b/49/ddefc656.jpg","comment_is_top":false,"comment_ctime":1567070304,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567070304","product_id":100020801,"comment_content":"主从备份开了三个线程，一个是bg_thread,dump_thread,io_thread，三个线程，从库从dump_thread读取binlog，如果是主从备份，出现数据丢失，主库的数据应该是数据量比较大而丢失的问题，一般来说，都是查看binlog来看看备份是否出现问题，还有就是show slave status。<br>老师提的问题，简单来说，我不会...","like_count":0},{"had_liked":false,"id":129235,"user_name":"MrVito","can_delete":false,"product_type":"c1","uid":1252169,"ip_address":"","ucode":"716FF6F8871706","user_header":"https://static001.geekbang.org/account/avatar/00/13/1b/49/ddefc656.jpg","comment_is_top":false,"comment_ctime":1567068697,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567068697","product_id":100020801,"comment_content":"看完所有的评论，对于一个一年的新人来说，本来读这篇文章是挺简单的，但是结合应用场景来说，就显得复杂了！","like_count":0},{"had_liked":false,"id":122015,"user_name":"Eagles","can_delete":false,"product_type":"c1","uid":1115950,"ip_address":"","ucode":"BADAC7969475F2","user_header":"https://static001.geekbang.org/account/avatar/00/11/07/2e/f6a2dc27.jpg","comment_is_top":false,"comment_ctime":1565269357,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565269357","product_id":100020801,"comment_content":"老师你好，row模式下，是不是加了-c参数，在binlog里面也是看不到注释的？","like_count":0},{"had_liked":false,"id":121318,"user_name":"timidsmile","can_delete":false,"product_type":"c1","uid":1524158,"ip_address":"","ucode":"E062F321730201","user_header":"https://static001.geekbang.org/account/avatar/00/17/41/be/7c756efa.jpg","comment_is_top":false,"comment_ctime":1565098859,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565098859","product_id":100020801,"comment_content":"请问下MySQL版本是？为啥我用同样命令看到的格式不一样","like_count":0},{"had_liked":false,"id":121035,"user_name":"gerry pang","can_delete":false,"product_type":"c1","uid":1068169,"ip_address":"","ucode":"54BD1D8DE1DBBF","user_header":"https://static001.geekbang.org/account/avatar/00/10/4c/89/e698c0a9.jpg","comment_is_top":false,"comment_ctime":1565052310,"is_pvip":false,"replies":[{"id":"44569","content":"08篇有呀😆","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1565095048,"ip_address":"","comment_id":121035,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1565052310","product_id":100020801,"comment_content":"老师，之前的文章好像没有介绍过undolog，可不可以考虑补充一下相关内容呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461586,"discussion_content":"08篇有呀😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565095048,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110121,"user_name":"尼克","can_delete":false,"product_type":"c1","uid":1063589,"ip_address":"","ucode":"8F5E51C621D57A","user_header":"https://static001.geekbang.org/account/avatar/00/10/3a/a5/217df1c5.jpg","comment_is_top":false,"comment_ctime":1562198947,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1562198947","product_id":100020801,"comment_content":"老师，你好，想问问双活这种架构在实践中用的多吗？相比主从这种方式在数据完整性上有什么担忧吗？","like_count":0,"discussions":[{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165698,"discussion_content":"你可以把双M看成是主从，双M只不过体现在更容易切换场景上。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581314860,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95544,"user_name":"会学学不会","can_delete":false,"product_type":"c1","uid":1315319,"ip_address":"","ucode":"375B9AF8B0F201","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/f7/b1ab4b15.jpg","comment_is_top":false,"comment_ctime":1558078978,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1558078978","product_id":100020801,"comment_content":"老师您好，请问文中提出的解决两个节点间的循环复制的优化逻辑，就是判断binlog的server id是不是自己的，这个是MySQL本身就已经集成优化了，还是需要运维人员去优化？<br><br>","like_count":0,"discussions":[{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290868,"discussion_content":"本身就有的吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594629859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":95412,"user_name":"A_Jinxs","can_delete":false,"product_type":"c1","uid":1317385,"ip_address":"","ucode":"70CDB86D3DA0DA","user_header":"https://static001.geekbang.org/account/avatar/00/14/1a/09/5b8cc220.jpg","comment_is_top":false,"comment_ctime":1558054352,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1558054352","product_id":100020801,"comment_content":"老师，请教个问题，简单主从架构中，主库delete清空一张表，百万级别，为什么从库会有很大的延迟？","like_count":0,"discussions":[{"author":{"id":1458200,"avatar":"https://static001.geekbang.org/account/avatar/00/16/40/18/cc3804e2.jpg","nickname":"沈洪彬","note":"","ucode":"F9911236D0BA1C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100223,"discussion_content":"row格式下：\n    sql 会进行拆分 ： 主库一条语句，相当于从库执行100w次，相当于每次加了个where ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1577243220,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":74390,"user_name":"蚂蚁内推+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1552211455,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1552211455","product_id":100020801,"comment_content":"不错","like_count":0},{"had_liked":false,"id":58458,"user_name":"Mr.Strive.Z.H.L","can_delete":false,"product_type":"c1","uid":1030198,"ip_address":"","ucode":"6D97E159E2EECD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg","comment_is_top":false,"comment_ctime":1547085793,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1547085793","product_id":100020801,"comment_content":"老师你好：<br>有一个疑惑，多条语句同时在commit阶段过程中，如果发生写入binlog和写入redolog的顺序不一致的情况。主从备份的时候，从库是不是会导致数据不一致呀？","like_count":0,"discussions":[{"author":{"id":1226968,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg","nickname":"hcyycb","note":"","ucode":"77FF6CA41F9E66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":410788,"discussion_content":"redolog的顺序和binlog的顺序没有关系。redolog是循环写，迟早都会被覆盖掉，而且主从又不依据redolog来恢复。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635776842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":165700,"discussion_content":"有可能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581315102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1458200,"avatar":"https://static001.geekbang.org/account/avatar/00/16/40/18/cc3804e2.jpg","nickname":"沈洪彬","note":"","ucode":"F9911236D0BA1C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":100225,"discussion_content":"rr 应该使用 gap控制的         ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577243345,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":58425,"user_name":"未知","can_delete":false,"product_type":"c1","uid":1312918,"ip_address":"","ucode":"DB389CEBEEE9E1","user_header":"https://static001.geekbang.org/account/avatar/00/14/08/96/231fdd9e.jpg","comment_is_top":false,"comment_ctime":1547082042,"is_pvip":false,"replies":[{"id":"21069","content":"Undo前面大致有说过了，你要了解undo的什么内容呢","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1547087050,"ip_address":"","comment_id":58425,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1547082042","product_id":100020801,"comment_content":"老师在讲row模式的数据恢复时，感觉insert，update，delete的数据格式和undo  log的差不多。之前文章一直说redo和binlog，老师抽空也讲下undo和回滚段的知识。","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":436059,"discussion_content":"Undo前面大致有说过了，你要了解undo的什么内容呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547087050,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57959,"user_name":"hua168","can_delete":false,"product_type":"c1","uid":1065255,"ip_address":"","ucode":"CFF9A7E86EBA48","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/27/3ff1a1d6.jpg","comment_is_top":false,"comment_ctime":1546951282,"is_pvip":false,"replies":[{"id":"20893","content":"中间件作为练手这些都可以的<br><br>你搜“开源分布式存储系统”","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546953578,"ip_address":"","comment_id":57959,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546951282","product_id":100020801,"comment_content":"这样，我是想增加一些经验，怕后面试又遇到，想问一下大神分析思路，这种问题没经验回答。<br>我就差点回答用阿里云的DRDS了😂<br><br>现在开源的mysql中间件生存环境中用什么比较多呀？mycat还是网易的cetus？<br><br>海量存储阿里云有OSS，有没有对应的开源软件呀？用于生存环境的，没有接触过，想问下，搞下实验后再去找工作。😂","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435848,"discussion_content":"中间件作为练手这些都可以的\n\n你搜“开源分布式存储系统”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546953578,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57897,"user_name":"null","can_delete":false,"product_type":"c1","uid":1159612,"ip_address":"","ucode":"6BBD8835CD4013","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/eePa5cW5DNLD2iaIgcSe54wt9KnC4D8bEZgFVtUJwYgRXykLpXxT3MrqZYnxygkiaAfdrPngB7PSZIvV2WDibRjow/132","comment_is_top":false,"comment_ctime":1546937103,"is_pvip":false,"replies":[{"id":"20883","content":"我觉得你要先查一下为啥第一个查询要用1-2秒，这个请求看起来应该挺快呀","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546949947,"ip_address":"","comment_id":57897,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546937103","product_id":100020801,"comment_content":"老师，我请教一个问题。现在我有一张表里面存储的有用户id和用户头像，用户头像存的二进制。我批量查询用户头像，比如我查500个用户id的头像，我将500个用户id分成十等份，每份50个id，然后开启线程池用10个线程并行查询。现在的问题是先提交查询的那个线程查询时间可能只用了一两秒，后面提交的那几个线程查询时间依次增加，最久的大概需要五六秒。我们数据库用的Oracle，虽然不是mysql，但是我感觉Oracle不至于10个线程的并发都扛不住还需要排队处理啊，想请教一下老师出现这种情况是什么原因导致的呢","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435816,"discussion_content":"我觉得你要先查一下为啥第一个查询要用1-2秒，这个请求看起来应该挺快呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546949947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57628,"user_name":"万勇","can_delete":false,"product_type":"c1","uid":1309092,"ip_address":"","ucode":"BC9E0918DF4516","user_header":"https://static001.geekbang.org/account/avatar/00/13/f9/a4/f0b92135.jpg","comment_is_top":false,"comment_ctime":1546854745,"is_pvip":false,"replies":[{"id":"20785","content":"后面的文章会说到哈","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546869678,"ip_address":"","comment_id":57628,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546854745","product_id":100020801,"comment_content":"结合上节的组提交内容，mysql5.7有个基于组提交的并行复制功能。设置slave-parallel-workers=N，在并发量大的情况下，并行复制能提高slave性能，减少延迟。在很多时候主机负载不大，每组提交的事务数量仅为1，slave-parallel-workers=0，单线程复制性能更好。请问老师，有没有比较好的办法进行优化？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435672,"discussion_content":"后面的文章会说到哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546869678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":57540,"user_name":"ThinkingQuest","can_delete":false,"product_type":"c1","uid":1118560,"ip_address":"","ucode":"597D0C00DAEFE4","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/0SDRac7XoordnKYgDLhz5wxAOtE6xqcsSywsywEtKQAR7xicBZQ6ceYftfZjl4Ivq3a5dzvRhYkn2GcUWiaQK7ZQ/132","comment_is_top":false,"comment_ctime":1546830806,"is_pvip":false,"replies":[{"id":"20734","content":"没理解你的意思… 内存的数据页原样拷贝到磁盘的，你指的技术细节是？","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1546832652,"ip_address":"","comment_id":57540,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1546830806","product_id":100020801,"comment_content":"问一个与本节内容无关的话题。 <br>B+树的索引是如何存储在磁盘文件中的呢。 国内的技术文章多讨论B+树的结构，索引的真确使用等。 <br>关于myslq是如何把表数据和索引数据存储在磁盘上的，讨论的非常少。 <br>大家通过自行查找一些资料，也可以看到堆文件等形式。 但是这里边技术细节和优化相信是很多的。这快可以说是目前可以找到的资料中，相对比较空白的一块。<br>老师后边的文章会涉及这一块内容么？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435633,"discussion_content":"没理解你的意思… 内存的数据页原样拷贝到磁盘的，你指的技术细节是？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1546832652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}