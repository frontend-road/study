{"id":420006,"title":"04ï½œä¸­é—´ä»¶ï¼šå¦‚ä½•æé«˜æ¡†æ¶çš„å¯æ‹“å±•æ€§ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è½©è„‰åˆƒã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»å®Œæˆäº†Webæ¡†æ¶çš„åŸºç¡€éƒ¨åˆ†ï¼Œä½¿ç”¨net/httpå¯åŠ¨äº†ä¸€ä¸ªWebæœåŠ¡ï¼Œå¹¶ä¸”å®šä¹‰äº†è‡ªå·±çš„Contextï¼Œå¯ä»¥æ§åˆ¶è¯·æ±‚è¶…æ—¶ã€‚</p><p>ä¹‹å‰åœ¨è®²å…·ä½“å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬åå¤å¼ºè°ƒè¦æ³¨æ„ä»£ç çš„ä¼˜åŒ–ã€‚é‚£ä¹ˆå¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿå…·ä½“æ¥è¯´ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯å°è£…ã€‚æ‰€ä»¥ä»Šå¤©æˆ‘ä»¬å°±å›é¡¾ä¸€ä¸‹ä¹‹å‰å†™çš„ä»£ç ï¼Œçœ‹çœ‹å¦‚ä½•é€šè¿‡å°è£…æ¥è¿›ä¸€æ­¥æé«˜ä»£ç æ‰©å±•æ€§ã€‚</p><p>åœ¨ç¬¬äºŒè¯¾ï¼Œæˆ‘ä»¬åœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­çš„controller.goçš„é€»è¾‘ä¸­è®¾ç½®äº†ä¸€ä¸ªæœ‰è¶…æ—¶æ—¶é•¿çš„æ§åˆ¶å™¨ï¼š</p><pre><code class=\"language-go\">func FooControllerHandler(c *framework.Context) error {\n\t...\n    // åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†å‰ï¼Œåˆ›å»ºæœ‰å®šæ—¶å™¨åŠŸèƒ½çš„ context\n\tdurationCtx, cancel := context.WithTimeout(c.BaseContext(), time.Duration(1*time.Second))\n\tdefer cancel()\n\n\tgo func() {\n\t\t...\n\t\t// æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘\n        \n\t\ttime.Sleep(10 * time.Second)\n        // ...\n              \n\t\tfinish &lt;- struct{}{}\n\t}()\n\t// åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†åï¼Œæ“ä½œè¾“å‡ºé€»è¾‘...\n    select {\n\t...\n\tcase &lt;-finish:\n\t\tfmt.Println(\"finish\")\n\t...\n\t}\n\treturn nil\n}\n</code></pre><!-- [[[read_end]]] --><p>åœ¨æ­£å¼æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå…·æœ‰å®šæ—¶å™¨åŠŸèƒ½çš„ Contextï¼Œç„¶åå¼€å¯ä¸€ä¸ª Goroutine æ‰§è¡Œæ­£å¼çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä¸”ç›‘å¬å®šæ—¶å™¨å’Œä¸šåŠ¡é€»è¾‘ï¼Œå“ªä¸ªå…ˆå®Œæˆï¼Œå°±å…ˆè¾“å‡ºå†…å®¹ã€‚</p><p>é¦–å…ˆä»ä»£ç åŠŸèƒ½åˆ†æï¼Œè¿™ä¸ªæ§åˆ¶å™¨åƒç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚</p><p>ä¸€éƒ¨åˆ†æ˜¯<strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼Œä¹Ÿå°±æ˜¯time.Sleepå‡½æ•°æ‰€ä»£è¡¨çš„é€»è¾‘ï¼Œåœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œä¼šæœ‰å¾ˆé‡çš„ä¸šåŠ¡é€»è¾‘ä»£ç ï¼›è€Œå¦ä¸€éƒ¨åˆ†æ˜¯<strong>éä¸šåŠ¡é€»è¾‘</strong>ï¼Œæ¯”å¦‚åˆ›å»ºContextã€é€šé“ç­‰å¾…finishä¿¡å·ç­‰ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªéä¸šåŠ¡é€»è¾‘æ˜¯éå¸¸é€šç”¨çš„éœ€æ±‚ï¼Œå¯èƒ½åœ¨å¤šä¸ªæ§åˆ¶å™¨ä¸­éƒ½ä¼šä½¿ç”¨åˆ°ã€‚</p><p>è€Œä¸”è€ƒè™‘å¤ç”¨æ€§ï¼Œè¿™é‡Œåªæ˜¯å†™äº†ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œé‚£å¦‚æœæœ‰å¤šä¸ªæ§åˆ¶å™¨å‘¢ï¼Œæˆ‘ä»¬éš¾é“è¦ä¸ºæ¯ä¸ªæ§åˆ¶å™¨éƒ½å†™ä¸Šè¿™ä¹ˆä¸€æ®µè¶…æ—¶ä»£ç å—ï¼Ÿé‚£å°±éå¸¸å†—ä½™äº†ã€‚</p><p>æ‰€ä»¥ï¼Œèƒ½ä¸èƒ½è®¾è®¡ä¸€ä¸ªæœºåˆ¶ï¼Œ<strong>å°†è¿™äº›éä¸šåŠ¡é€»è¾‘ä»£ç æŠ½è±¡å‡ºæ¥ï¼Œå°è£…å¥½ï¼Œæä¾›æ¥å£ç»™æ§åˆ¶å™¨ä½¿ç”¨</strong>ã€‚è¿™ä¸ªæœºåˆ¶çš„å®ç°ï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²çš„ä¸­é—´ä»¶ã€‚</p><p>æ€ä¹ˆå®ç°è¿™ä¸ªä¸­é—´ä»¶å‘¢ï¼Ÿæˆ‘ä»¬å†è§‚å¯Ÿä¸€ä¸‹åˆšæ‰çš„ä»£ç æ‰¾æ‰¾æ€è·¯ã€‚</p><p>ä»£ç çš„ç»„ç»‡é¡ºåºå¾ˆæ¸…æ™°ï¼Œå…ˆé¢„å¤„ç†è¯·æ±‚ï¼Œå†å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œæœ€åå¤„ç†è¿”å›å€¼ï¼Œä½ å‘ç°æ²¡æœ‰è¿™ç§é¡ºåºï¼Œå…¶å®å¾ˆç¬¦åˆè®¾è®¡æ¨¡å¼ä¸­çš„è£…é¥°å™¨æ¨¡å¼ã€‚è£…é¥°å™¨æ¨¡å¼ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨æ ¸å¿ƒå¤„ç†æ¨¡å—çš„å¤–å±‚å¢åŠ ä¸€ä¸ªåˆä¸€ä¸ªçš„è£…é¥°ï¼Œç±»ä¼¼æ´‹è‘±ã€‚<img src=\"https://static001.geekbang.org/resource/image/f9/2c/f94ccc78af2ca491afe1591e674e3f2c.jpg?wh=1920x912\" alt=\"\"></p><p>ç°åœ¨ï¼ŒæŠ½è±¡å‡ºä¸­é—´ä»¶çš„æ€è·¯æ˜¯ä¸æ˜¯å°±å¾ˆæ¸…æ™°äº†ï¼ŒæŠŠæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å…ˆå°è£…èµ·æ¥ï¼Œç„¶åä¸€å±‚ä¸€å±‚æ·»åŠ è£…é¥°ï¼Œæœ€ç»ˆè®©æ‰€æœ‰è¯·æ±‚æ­£åºä¸€å±‚å±‚é€šè¿‡è£…é¥°å™¨ï¼Œè¿›å…¥æ ¸å¿ƒå¤„ç†æ¨¡å—ï¼Œå†ååºé€€å‡ºè£…é¥°å™¨ã€‚åŸç†å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œä¸éš¾ç†è§£ï¼Œæˆ‘ä»¬æ¥ç€çœ‹è¯¥å¦‚ä½•å®ç°ã€‚</p><h2>ä½¿ç”¨å‡½æ•°åµŒå¥—æ–¹å¼å®ç°ä¸­é—´ä»¶</h2><p>è£…é¥°å™¨æ¨¡å¼æ˜¯ä¸€å±‚ä¸€å±‚çš„ï¼Œæ‰€ä»¥å…·ä½“å®ç°å…¶å®ä¹Ÿä¸éš¾æƒ³åˆ°ï¼Œå°±æ˜¯ä½¿ç”¨å‡½æ•°åµŒå¥—ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°è£…æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ã€‚å°±æ˜¯è¯´ï¼Œè¿™ä¸ªä¸­é—´ä»¶çš„è¾“å…¥æ˜¯ä¸€ä¸ªæ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘ ControllerHandlerï¼Œè¾“å‡ºä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ª ControllerHandlerã€‚æ‰€ä»¥<strong>å¯¹äºä¸€ä¸ªè¶…æ—¶æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªä¸­é—´ä»¶ä¸º TimeoutHandler</strong>ã€‚</p><p>åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªtimeout.goæ–‡ä»¶æ¥å­˜æ”¾è¿™ä¸ªä¸­é—´ä»¶ã€‚</p><pre><code class=\"language-go\">func TimeoutHandler(fun ControllerHandler, d time.Duration) ControllerHandler {\n\t// ä½¿ç”¨å‡½æ•°å›è°ƒ\n\treturn func(c *Context) error {\n\n\t\tfinish := make(chan struct{}, 1)\n\t\tpanicChan := make(chan interface{}, 1)\n\n\t\t// æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰é¢„æ“ä½œï¼šåˆå§‹åŒ–è¶…æ—¶ context\n\t\tdurationCtx, cancel := context.WithTimeout(c.BaseContext(), d)\n\t\tdefer cancel()\n\n\t\tc.request.WithContext(durationCtx)\n\n\t\tgo func() {\n\t\t\tdefer func() {\n\t\t\t\tif p := recover(); p != nil {\n\t\t\t\t\tpanicChan &lt;- p\n\t\t\t\t}\n\t\t\t}()\n\t\t\t// æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘\n\t\t\tfun(c)\n\n\t\t\tfinish &lt;- struct{}{}\n\t\t}()\n\t\t// æ‰§è¡Œä¸šåŠ¡é€»è¾‘åæ“ä½œ\n\t\tselect {\n\t\tcase p := &lt;-panicChan:\n\t\t\tlog.Println(p)\n\t\t\tc.responseWriter.WriteHeader(500)\n\t\tcase &lt;-finish:\n\t\t\tfmt.Println(\"finish\")\n\t\tcase &lt;-durationCtx.Done():\n\t\t\tc.SetHasTimeout()\n\t\t\tc.responseWriter.Write([]byte(\"time out\"))\n\t\t}\n\t\treturn nil\n\t}\n}\n</code></pre><p>ä»”ç»†çœ‹ä¸‹è¿™æ®µä»£ç ï¼Œä¸­é—´ä»¶å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°å®ç°äº†ControllerHandler å‡½æ•°ç»“æ„ï¼Œå‚æ•°ä¸ºContextï¼Œè¿”å›å€¼ä¸ºerrorã€‚</p><p>åœ¨è¿™ä¸ªåŒ¿åå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºäº†ä¸€ä¸ªå®šæ—¶å™¨Contextï¼Œç„¶åå¼€å¯ä¸€ä¸ªGoroutineï¼Œåœ¨Goroutineä¸­æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™ä¸ªGoroutineä¼šåœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œç»“æŸåï¼Œé€šè¿‡ä¸€ä¸ªfinishçš„channelæ¥ä¼ é€’ç»“æŸä¿¡å·ï¼›ä¹Ÿä¼šåœ¨ä¸šåŠ¡å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œé€šè¿‡panicChanæ¥ä¼ é€’å¼‚å¸¸ä¿¡å·ã€‚</p><p>è€Œåœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å¤–çš„ä¸»Goroutineä¸­ï¼Œä¼šåŒæ—¶è¿›è¡Œå¤šä¸ªä¿¡å·çš„ç›‘å¬æ“ä½œï¼ŒåŒ…æ‹¬ç»“æŸä¿¡å·ã€å¼‚å¸¸ä¿¡å·ã€è¶…æ—¶ä¿¡å·ï¼Œè€—æ—¶æœ€çŸ­çš„ä¿¡å·åˆ°è¾¾åï¼Œè¯·æ±‚ç»“æŸã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†è®¾ç½®ä¸šåŠ¡è¶…æ—¶çš„ä»»åŠ¡ã€‚</p><p>äºæ˜¯åœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹route.goä¸­ï¼Œè·¯ç”±æ³¨å†Œå°±å¯ä»¥ä¿®æ”¹ä¸ºï¼š</p><pre><code class=\"language-go\">// åœ¨æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ UserLoginController ä¹‹å¤–ï¼Œå°è£…ä¸€å±‚ TimeoutHandler\ncore.Get(\"/user/login\", framework.TimeoutHandler(UserLoginController, time.Second))\n</code></pre><p>è¿™ç§å‡½æ•°åµŒå¥—æ–¹å¼ï¼Œè®©ä¸‹å±‚ä¸­é—´ä»¶æ˜¯ä¸Šå±‚ä¸­é—´ä»¶çš„å‚æ•°ï¼Œé€šè¿‡ä¸€å±‚å±‚åµŒå¥—å®ç°äº†ä¸­é—´ä»¶çš„è£…é¥°å™¨æ¨¡å¼ã€‚</p><p>ä½†æ˜¯ä½ å†æƒ³ä¸€æ­¥ï¼Œå°±ä¼šå‘ç°ï¼Œè¿™æ ·å®ç°çš„ä¸­é—´ä»¶æœºåˆ¶æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol>\n<li><strong>ä¸­é—´ä»¶æ˜¯å¾ªç¯åµŒå¥—çš„</strong>ï¼Œå½“æœ‰å¤šä¸ªä¸­é—´ä»¶çš„æ—¶å€™ï¼Œæ•´ä¸ªåµŒå¥—é•¿åº¦å°±ä¼šéå¸¸é•¿ï¼Œéå¸¸ä¸ä¼˜é›…çš„ï¼Œæ¯”å¦‚ï¼š</li>\n</ol><pre><code class=\"language-go\">TimeoutHandler(LogHandler(recoveryHandler(UserLoginController)))\n</code></pre><ol start=\"2\">\n<li>åˆšæ‰çš„å®ç°ï¼Œ<strong>åªèƒ½ä¸ºå•ä¸ªä¸šåŠ¡æ§åˆ¶å™¨è®¾ç½®ä¸­é—´ä»¶ï¼Œä¸èƒ½æ‰¹é‡è®¾ç½®</strong>ã€‚ä¸Šä¸€è¯¾æˆ‘ä»¬å¼€å‘çš„è·¯ç”±æ˜¯å…·æœ‰åŒå‰ç¼€åˆ†ç»„åŠŸèƒ½çš„ï¼ˆIGroupï¼‰ï¼Œéœ€è¦æ‰¹é‡ä¸ºæŸä¸ªåˆ†ç»„è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é•¿ã€‚</li>\n</ol><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å¯¹åˆšæ‰å®ç°çš„ç®€å•ä¸­é—´ä»¶ä»£ç åšä¸€äº›æ”¹è¿›ã€‚æ€ä¹ˆåšå‘¢ï¼Ÿ</p><h2>ä½¿ç”¨ pipeline æ€æƒ³æ”¹é€ ä¸­é—´ä»¶</h2><p>ä¸€å±‚å±‚åµŒå¥—ä¸å¥½ç”¨ï¼Œå¦‚æœæˆ‘ä»¬å°†æ¯ä¸ªæ ¸å¿ƒæ§åˆ¶å™¨æ‰€éœ€è¦çš„ä¸­é—´ä»¶ï¼Œä½¿ç”¨ä¸€ä¸ªæ•°ç»„é“¾æ¥ï¼ˆChainï¼‰èµ·æ¥ï¼Œå½¢æˆä¸€æ¡æµæ°´çº¿ï¼ˆPipelineï¼‰ï¼Œå°±èƒ½å®Œç¾è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜äº†ã€‚</p><p>è¯·æ±‚æµçš„æµå‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src=\"https://static001.geekbang.org/resource/image/e1/2a/e1aa5937627e46c8b2b21e45426f342a.jpg?wh=1920x915\" alt=\"\"></p><p>è¿™ä¸ªPipelineæ¨¡å‹å’Œå‰é¢çš„æ´‹è‘±æ¨¡å‹ä¸ä¸€æ ·çš„ç‚¹åœ¨äºï¼Œ<strong>Middlewareä¸å†ä»¥ä¸‹ä¸€å±‚çš„ControllerHandlerä¸ºå‚æ•°äº†ï¼Œå®ƒåªéœ€è¦è¿”å›æœ‰è‡ªèº«ä¸­é—´ä»¶é€»è¾‘çš„ControllerHandler</strong>ã€‚</p><p>ä¹Ÿå°±æ˜¯åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„timeout.goä¸­ï¼Œæˆ‘ä»¬å°†Middlewareçš„å½¢å¼ä»åˆšæ‰çš„ï¼š</p><pre><code class=\"language-go\">func TimeoutHandler(fun ControllerHandler, d time.Duration) ControllerHandler {\n\t// ä½¿ç”¨å‡½æ•°å›è°ƒ\n\treturn func(c *Context) error {\n   //...\n    }\n}\n</code></pre><p>å˜æˆè¿™æ ·ï¼š</p><pre><code class=\"language-go\">// è¶…æ—¶æ§åˆ¶å™¨å‚æ•°ä¸­ControllerHandlerç»“æ„å·²ç»å»æ‰\nfunc Timeout(d time.Duration) framework.ControllerHandler {\n\t// ä½¿ç”¨å‡½æ•°å›è°ƒ\n\treturn func(c *framework.Context) error {\n      //...\n    }\n}\n</code></pre><p>ä½†æ˜¯åœ¨ä¸­é—´ä»¶æ³¨å†Œçš„å›è°ƒå‡½æ•°ä¸­ï¼Œå¦‚ä½•è°ƒç”¨ä¸‹ä¸€ä¸ªControllerHandlerå‘¢ï¼Ÿåœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œåªæœ‰framework.Context è¿™ä¸ªæ•°æ®ç»“æ„ä½œä¸ºå‚æ•°ã€‚</p><p>æ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬åœ¨Contextè¿™ä¸ªæ•°æ®ç»“æ„ä¸­æƒ³ä¸€äº›åŠæ³•äº†ã€‚å›é¡¾ä¸‹ç›®å‰æœ‰çš„æ•°æ®ç»“æ„ï¼šCoreã€Contextã€Treeã€Nodeã€Groupã€‚<img src=\"https://static001.geekbang.org/resource/image/8e/7b/8ef582e74e9c5ca1c0f54e7c1d75a67b.jpg?wh=1920x1277\" alt=\"\"></p><p>å®ƒä»¬åŸºæœ¬ä¸Šéƒ½æ˜¯ä»¥ Core ä¸ºä¸­å¿ƒï¼Œåœ¨ Core ä¸­è®¾ç½®è·¯ç”± routerï¼Œå®ç°äº† Tree ç»“æ„ï¼Œåœ¨ Tree ç»“æ„ä¸­åŒ…å«è·¯ç”±èŠ‚ç‚¹ nodeï¼›åœ¨æ³¨å†Œè·¯ç”±çš„æ—¶å€™ï¼Œå°†å¯¹åº”çš„ä¸šåŠ¡æ ¸å¿ƒå¤„ç†é€»è¾‘ handler ï¼Œæ”¾åœ¨ node ç»“æ„çš„ handler å±æ€§ä¸­ã€‚</p><p>è€Œ Core ä¸­çš„ ServeHttp æ–¹æ³•ä¼šåˆ›å»º Context æ•°æ®ç»“æ„ï¼Œç„¶åServeHttpæ–¹æ³•å†æ ¹æ® Request-URI æŸ¥æ‰¾æŒ‡å®š nodeï¼Œå¹¶ä¸”å°† Context ç»“æ„å’Œ node ä¸­çš„æ§åˆ¶å™¨ ControllerHandler ç»“åˆèµ·æ¥æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>ç»“æ„éƒ½æ¢³ç†æ¸…æ¥šäº†ï¼Œæ€ä¹ˆæ”¹é€ æˆæµæ°´çº¿å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥<strong>å°†æ¯ä¸ªä¸­é—´ä»¶æ„é€ å‡ºæ¥çš„ ControllerHandler å’Œæœ€ç»ˆçš„ä¸šåŠ¡é€»è¾‘çš„ ControllerHandler ç»“åˆåœ¨ä¸€èµ·</strong>ï¼Œæˆä¸ºä¸€ä¸ª ControllerHandler æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶å™¨é“¾ã€‚åœ¨æœ€ç»ˆæ‰§è¡Œä¸šåŠ¡ä»£ç çš„æ—¶å€™ï¼Œèƒ½ä¸€ä¸ªä¸ªè°ƒç”¨æ§åˆ¶å™¨é“¾è·¯ä¸Šçš„æ§åˆ¶å™¨ã€‚</p><p>è¿™ä¸ªæƒ³æ³•å…¶å®æ˜¯éå¸¸è‡ªç„¶çš„ï¼Œå› ä¸ºä¸­é—´ä»¶ä¸­åˆ›é€ å‡ºæ¥çš„ControllerHandleråŒ¿åå‡½æ•°ï¼Œå’Œæœ€ç»ˆçš„æ§åˆ¶å™¨ä¸šåŠ¡é€»è¾‘ControllerHandlerï¼Œéƒ½æ˜¯<strong>åŒæ ·çš„ç»“æ„</strong>ï¼Œ<strong>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€‰ç”¨Controllerhanderçš„æ•°ç»„ï¼Œæ¥è¡¨ç¤ºæŸä¸ªè·¯ç”±çš„ä¸šåŠ¡é€»è¾‘</strong>ã€‚</p><p>å¯¹åº”åˆ°ä»£ç ä¸Šï¼Œæˆ‘ä»¬å…ˆææ¸…æ¥šä½¿ç”¨é“¾è·¯çš„æ–¹å¼ï¼Œå†çœ‹å¦‚ä½•æ³¨å†Œå’Œæ„é€ é“¾è·¯ã€‚</p><h3>å¦‚ä½•ä½¿ç”¨æ§åˆ¶å™¨é“¾è·¯</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬ç ”ç©¶ä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ§åˆ¶å™¨é“¾è·¯ï¼Œå³å›¾ä¸­å³è¾¹éƒ¨åˆ†çš„æ”¹é€ ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/49/c8/49c2d50b26d48e338c3acd2e1374f4c8.jpg?wh=1920x1277\" alt=\"\"></p><p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹è·¯ç”±èŠ‚ç‚¹nodeã€‚</p><p>åœ¨nodeèŠ‚ç‚¹ä¸­å°†åŸå…ˆçš„Handlerï¼Œæ›¿æ¢ä¸ºæ§åˆ¶å™¨é“¾è·¯Handlersã€‚è¿™æ ·åœ¨å¯»æ‰¾è·¯ç”±èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå°±èƒ½æ‰¾åˆ°å¯¹åº”çš„æ§åˆ¶å™¨é“¾è·¯äº†ã€‚ä¿®æ”¹æ¡†æ¶æ–‡ä»¶å¤¹ä¸­å­˜æ”¾trieæ ‘çš„trie.goæ–‡ä»¶ï¼š</p><pre><code class=\"language-go\">// ä»£è¡¨èŠ‚ç‚¹\ntype node struct {\n\t...\n\thandlers []ControllerHandler // ä¸­é—´ä»¶+æ§åˆ¶å™¨ \n    ...\n}\n\n</code></pre><p>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬ä¿®æ”¹Contextç»“æ„ã€‚</p><p>ç”±äºæˆ‘ä»¬ä¸Šæ–‡æåˆ°ï¼Œåœ¨ä¸­é—´ä»¶æ³¨å†Œçš„å›è°ƒå‡½æ•°ä¸­ï¼Œåªæœ‰framework.Context è¿™ä¸ªæ•°æ®ç»“æ„ä½œä¸ºå‚æ•°ï¼Œæ‰€ä»¥åœ¨Contextä¸­ä¹Ÿéœ€è¦ä¿å­˜è¿™ä¸ªæ§åˆ¶å™¨é“¾è·¯(handlers)ï¼Œå¹¶ä¸”è¦è®°å½•ä¸‹å½“å‰æ‰§è¡Œåˆ°äº†å“ªä¸ªæ§åˆ¶å™¨ï¼ˆindexï¼‰ã€‚ä¿®æ”¹æ¡†æ¶æ–‡ä»¶å¤¹çš„context.goæ–‡ä»¶ï¼š</p><pre><code class=\"language-go\">// Contextä»£è¡¨å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡\ntype Context struct {\n\t...\n\n\t// å½“å‰è¯·æ±‚çš„handleré“¾æ¡\n\thandlers []ControllerHandler\n\tindex&nbsp; &nbsp; int // å½“å‰è¯·æ±‚è°ƒç”¨åˆ°è°ƒç”¨é“¾çš„å“ªä¸ªèŠ‚ç‚¹\n}\n</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œæ¥å®ç°é“¾æ¡è°ƒç”¨æ–¹å¼ã€‚</p><p>ä¸ºäº†æ§åˆ¶å®ç°é“¾æ¡çš„é€æ­¥è°ƒç”¨ï¼Œæˆ‘ä»¬ä¸ºContextå®ç°ä¸€ä¸ªNextæ–¹æ³•ã€‚è¿™ä¸ªNextæ–¹æ³•æ¯è°ƒç”¨ä¸€æ¬¡ï¼Œå°±å°†è¿™ä¸ªæ§åˆ¶å™¨é“¾è·¯çš„è°ƒç”¨æ§åˆ¶å™¨ï¼Œå¾€åç§»åŠ¨ä¸€æ­¥ã€‚ç»§ç»­åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„context.goæ–‡ä»¶é‡Œå†™ï¼š</p><pre><code class=\"language-go\">// æ ¸å¿ƒå‡½æ•°ï¼Œè°ƒç”¨contextçš„ä¸‹ä¸€ä¸ªå‡½æ•°\nfunc (ctx *Context) Next() error {\n\tctx.index++\n\tif ctx.index &lt; len(ctx.handlers) {\n\t\tif err := ctx.handlers[ctx.index](ctx); err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\treturn nil\n}\n</code></pre><p>è¿™é‡Œæˆ‘å†å•°å—¦ä¸€ä¸‹ï¼ŒNext() å‡½æ•°æ˜¯æ•´ä¸ªé“¾è·¯æ‰§è¡Œçš„é‡ç‚¹ï¼Œè¦å¥½å¥½ç†è§£ï¼Œå®ƒé€šè¿‡ç»´æŠ¤Contextä¸­çš„ä¸€ä¸ªä¸‹æ ‡ï¼Œæ¥æ§åˆ¶é“¾è·¯ç§»åŠ¨ï¼Œè¿™ä¸ªä¸‹æ ‡è¡¨ç¤ºå½“å‰è°ƒç”¨Nextè¦æ‰§è¡Œçš„æ§åˆ¶å™¨åºåˆ—ã€‚</p><p>Next() å‡½æ•°ä¼šåœ¨æ¡†æ¶çš„ä¸¤ä¸ªåœ°æ–¹è¢«è°ƒç”¨ï¼š</p><ul>\n<li>ç¬¬ä¸€ä¸ªæ˜¯åœ¨æ­¤æ¬¡è¯·æ±‚å¤„ç†çš„å…¥å£å¤„ï¼Œå³Coreçš„ServeHttpï¼›</li>\n<li>ç¬¬äºŒä¸ªæ˜¯åœ¨æ¯ä¸ªä¸­é—´ä»¶çš„é€»è¾‘ä»£ç ä¸­ï¼Œç”¨äºè°ƒç”¨ä¸‹ä¸ªä¸­é—´ä»¶ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/73/3c/73a80752cf6d94b90febd2e23e80bc3c.jpg?wh=1920x915\" alt=\"\"></li>\n</ul><p>è¿™é‡Œè¦æ³¨æ„ï¼Œindexä¸‹æ ‡è¡¨ç¤ºå½“å‰è°ƒç”¨Nextè¦æ‰§è¡Œçš„æ§åˆ¶å™¨åºåˆ—ï¼Œå®ƒçš„<strong>åˆå§‹å€¼åº”è¯¥ä¸º-1ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šè‡ªå¢1</strong>ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™indexä¸º0ï¼Œå®šä½åˆ°æ§åˆ¶å™¨é“¾æ¡çš„ä¸‹æ ‡ä¸º0çš„æ§åˆ¶å™¨ï¼Œå³ç¬¬ä¸€ä¸ªæ§åˆ¶å™¨ã€‚</p><p>åœ¨æ¡†æ¶æ–‡ä»¶å¤¹context.goçš„åˆå§‹åŒ–Contextå‡½æ•°ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">// NewContext åˆå§‹åŒ–ä¸€ä¸ªContext\nfunc NewContext(r *http.Request, w http.ResponseWriter) *Context {\n\treturn &amp;Context{\n\t\t...\n\t\tindex:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -1,\n\t}\n}\n</code></pre><p>è¢«è°ƒç”¨çš„ç¬¬ä¸€ä¸ªåœ°æ–¹ï¼Œåœ¨å…¥å£å¤„è°ƒç”¨çš„ä»£ç ï¼Œå†™åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.goæ–‡ä»¶ä¸­ï¼š</p><pre><code class=\"language-go\">// æ‰€æœ‰è¯·æ±‚éƒ½è¿›å…¥è¿™ä¸ªå‡½æ•°, è¿™ä¸ªå‡½æ•°è´Ÿè´£è·¯ç”±åˆ†å‘\nfunc (c *Core) ServeHTTP(response http.ResponseWriter, request *http.Request) {\n\n\t// å°è£…è‡ªå®šä¹‰context\n\tctx := NewContext(request, response)\n\n\t// å¯»æ‰¾è·¯ç”±\n\thandlers := c.FindRouteByRequest(request)\n\tif handlers == nil {\n\t\t// å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¿™é‡Œæ‰“å°æ—¥å¿—\n\t\tctx.Json(404, \"not found\")\n\t\treturn\n\t}\n\n    // è®¾ç½®contextä¸­çš„handlerså­—æ®µ\n\tctx.SetHandlers(handlers)\n\n\t// è°ƒç”¨è·¯ç”±å‡½æ•°ï¼Œå¦‚æœè¿”å›err ä»£è¡¨å­˜åœ¨å†…éƒ¨é”™è¯¯ï¼Œè¿”å›500çŠ¶æ€ç \n\tif err := ctx.Next(); err != nil {\n\t\tctx.Json(500, \"inner error\")\n\t\treturn\n\t}\n}\n</code></pre><p>è¢«è°ƒç”¨çš„ç¬¬äºŒä¸ªä½ç½®åœ¨ä¸­é—´ä»¶ä¸­ï¼Œæ¯ä¸ªä¸­é—´ä»¶éƒ½é€šè¿‡è°ƒç”¨ context.Next æ¥è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­åˆ›å»ºmiddlewareç›®å½•ï¼Œå…¶ä¸­åˆ›å»ºä¸€ä¸ªtest.goå­˜æ”¾æˆ‘ä»¬çš„æµ‹è¯•ä¸­é—´ä»¶ï¼š</p><pre><code class=\"language-go\">func Test1() framework.ControllerHandler {\n\t// ä½¿ç”¨å‡½æ•°å›è°ƒ\n\treturn func(c *framework.Context) error {\n\t\tfmt.Println(\"middleware pre test1\")\n\t\tc.Next()  // è°ƒç”¨Nextå¾€ä¸‹è°ƒç”¨ï¼Œä¼šè‡ªå¢contxt.index\n\t\tfmt.Println(\"middleware post test1\")\n\t\treturn nil\n\t}\n}\n\nfunc Test2() framework.ControllerHandler {\n\t// ä½¿ç”¨å‡½æ•°å›è°ƒ\n\treturn func(c *framework.Context) error {\n\t\tfmt.Println(\"middleware pre test2\")\n\t\tc.Next() // è°ƒç”¨Nextå¾€ä¸‹è°ƒç”¨ï¼Œä¼šè‡ªå¢contxt.index\n\t\tfmt.Println(\"middleware post test2\")\n\t\treturn nil\n\t}\n}\n\n</code></pre><h3>å¦‚ä½•æ³¨å†Œæ§åˆ¶å™¨é“¾è·¯</h3><p>å¦‚ä½•ä½¿ç”¨æ§åˆ¶å™¨é“¾è·¯ï¼Œæˆ‘ä»¬å°±è®²å®Œäº†ï¼Œå†çœ‹æ§åˆ¶å™¨é“¾è·¯å¦‚ä½•æ³¨å†Œï¼Œå°±æ˜¯ä¹‹å‰UMLå›¾çš„å·¦è¾¹éƒ¨åˆ†ã€‚<img src=\"https://static001.geekbang.org/resource/image/3c/b5/3c2012fcfcabcfc0159e4ecec2fdb8b5.jpg?wh=1920x1277\" alt=\"\"></p><p>å¾ˆæ˜æ˜¾ï¼Œç°æœ‰çš„å‡½æ•°æ²¡æœ‰åŒ…å«æ³¨å†Œä¸­é—´ä»¶é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºGroupå’ŒCoreä¸¤ä¸ªç»“æ„å¢åŠ æ³¨å†Œä¸­é—´ä»¶å…¥å£ï¼Œè¦è®¾è®¡ä¸¤ä¸ªåœ°æ–¹ï¼š</p><ul>\n<li>Coreå’ŒGroupå•ç‹¬è®¾è®¡ä¸€ä¸ªUseå‡½æ•°ï¼Œä¸ºå…¶æ•°æ®ç»“æ„è´Ÿè´£çš„è·¯ç”±æ‰¹é‡è®¾ç½®ä¸­é—´ä»¶</li>\n<li>ä¸ºCoreå’ŒGroupæ³¨å†Œå•ä¸ªè·¯ç”±çš„ Get / Post / Put / Delete å‡½æ•°ï¼Œè®¾ç½®ä¸­é—´ä»¶</li>\n</ul><p>å…ˆçœ‹ä¸‹æ‰¹é‡è®¾ç½®ä¸­é—´ä»¶çš„Useå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.goä¿®æ”¹ï¼š</p><pre><code class=\"language-go\">// æ³¨å†Œä¸­é—´ä»¶\nfunc (c *Core) Use(middlewares ...ControllerHandler) {\n   c.middlewares = append(c.middlewares, middlewares...)\n}\n</code></pre><p>å’Œæ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„group.goä¸­ä¿®æ”¹ï¼š</p><pre><code class=\"language-go\">// æ³¨å†Œä¸­é—´ä»¶\nfunc (g *Group) Use(middlewares ...ControllerHandler) {\n   g.middlewares = append(g.middlewares, middlewares...)\n}\n</code></pre><p>æ³¨æ„ä¸‹è¿™é‡Œçš„å‚æ•°ï¼Œä½¿ç”¨çš„æ˜¯Golangçš„å¯å˜å‚æ•°ï¼Œ<strong>è¿™ä¸ªå¯å˜å‚æ•°ä»£è¡¨ï¼Œæˆ‘å¯ä»¥ä¼ é€’0ï½nä¸ªControllerHandlerç±»å‹çš„å‚æ•°</strong>ï¼Œè¿™ä¸ªè®¾è®¡ä¼šå¢åŠ å‡½æ•°çš„æ˜“ç”¨æ€§ã€‚å®ƒåœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­ä½¿ç”¨èµ·æ¥çš„å½¢å¼æ˜¯è¿™æ ·çš„ï¼Œåœ¨main.goä¸­ï¼š</p><pre><code class=\"language-go\">// coreä¸­ä½¿ç”¨useæ³¨å†Œä¸­é—´ä»¶\ncore.Use(\n\t\tmiddleware.Test1(),\n\t\tmiddleware.Test2())\n\n// groupä¸­ä½¿ç”¨useæ³¨å†Œä¸­é—´ä»¶\nsubjectApi := core.Group(\"/subject\")\nsubjectApi.Use(middleware.Test3())\n</code></pre><p>å†çœ‹å•ä¸ªè·¯ç”±è®¾ç½®ä¸­é—´ä»¶çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨å¯å˜å‚æ•°ï¼Œæ”¹é€ æ³¨å†Œè·¯ç”±çš„å‡½æ•°ï¼ˆGet /Post /Delete /Putï¼‰ï¼Œç»§ç»­åœ¨æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„core.goé‡Œä¿®æ”¹ï¼š</p><pre><code class=\"language-go\">// Coreçš„Getæ–¹æ³•è¿›è¡Œæ”¹é€ \nfunc (c *Core) Get(url string, handlers ...ControllerHandler) {\n\t// å°†coreçš„middleware å’Œ handlersç»“åˆèµ·æ¥\n\tallHandlers := append(c.middlewares, handlers...)\n\tif err := c.router[\"GET\"].AddRouter(url, allHandlers); err != nil {\n\t\tlog.Fatal(\"add router error: \", err)\n\t}\n}\n... \n</code></pre><p>åŒæ—¶ä¿®æ”¹æ¡†æ¶æ–‡ä»¶å¤¹ä¸­çš„group.goï¼š</p><pre><code class=\"language-go\">// æ”¹é€ IGroup çš„æ‰€æœ‰æ–¹æ³•\ntype IGroup interface {\n\t// å®ç°HttpMethodæ–¹æ³•\n\tGet(string, ...ControllerHandler)\n\tPost(string, ...ControllerHandler)\n\tPut(string, ...ControllerHandler)\n\tDelete(string, ...ControllerHandler)\n    //..\n}\n\n// æ”¹é€ Groupçš„Getæ–¹æ³•\nfunc (g *Group) Get(uri string, handlers ...ControllerHandler) {\n\turi = g.getAbsolutePrefix() + uri\n\tallHandlers := append(g.getMiddlewares(), handlers...)\n\tg.core.Get(uri, allHandlers...)\n}\n\n...\n</code></pre><p>è¿™æ ·ï¼Œå›åˆ°ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­çš„router.goï¼Œæˆ‘ä»¬æ³¨å†Œè·¯ç”±çš„ä½¿ç”¨æ–¹æ³•å°±å¯ä»¥å˜æˆå¦‚ä¸‹å½¢å¼ï¼š</p><pre><code class=\"language-go\">// æ³¨å†Œè·¯ç”±è§„åˆ™\nfunc registerRouter(core *framework.Core) {\n\t// åœ¨coreä¸­ä½¿ç”¨middleware.Test3() ä¸ºå•ä¸ªè·¯ç”±å¢åŠ ä¸­é—´ä»¶\n\tcore.Get(\"/user/login\", middleware.Test3(), UserLoginController)\n\n\t// æ‰¹é‡é€šç”¨å‰ç¼€\n\tsubjectApi := core.Group(\"/subject\")\n\t{\n        ...\n        // åœ¨groupä¸­ä½¿ç”¨middleware.Test3() ä¸ºå•ä¸ªè·¯ç”±å¢åŠ ä¸­é—´ä»¶\n\t\tsubjectApi.Get(\"/:id\", middleware.Test3(), SubjectGetController)\n\t}\n}\n</code></pre><p>ä¸ç®¡æ˜¯é€šè¿‡æ‰¹é‡æ³¨å†Œä¸­é—´ä»¶ï¼Œè¿˜æ˜¯å•ä¸ªæ³¨å†Œä¸­é—´ä»¶ï¼Œæœ€ç»ˆéƒ½è¦æ±‡æ€»åˆ°è·¯ç”±èŠ‚ç‚¹nodeä¸­ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è°ƒç”¨äº†ä¸Šä¸€èŠ‚è¯¾æœ€ç»ˆå¢åŠ è·¯ç”±çš„å‡½æ•°Tree.AddRouterï¼ŒæŠŠå°†è¿™ä¸ªè¯·æ±‚å¯¹åº”çš„Coreç»“æ„é‡Œçš„ä¸­é—´ä»¶å’ŒGroupç»“æ„é‡Œçš„ä¸­é—´ä»¶ï¼Œéƒ½èšåˆèµ·æ¥ï¼Œæˆä¸ºæœ€ç»ˆè·¯ç”±èŠ‚ç‚¹çš„ä¸­é—´ä»¶ã€‚</p><p>èšåˆçš„é€»è¾‘åœ¨group.goå’Œcore.goä¸­éƒ½æœ‰ï¼Œå®é™…ä¸Šå°±æ˜¯<strong>å°†Handlerå’ŒMiddlewareä¸€èµ·æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­</strong>ã€‚</p><pre><code class=\"language-go\">// è·å–æŸä¸ªgroupçš„middleware\n// è¿™é‡Œå°±æ˜¯è·å–é™¤äº†Get/Post/Put/Deleteä¹‹å¤–è®¾ç½®çš„middleware\nfunc (g *Group) getMiddlewares() []ControllerHandler {\n\tif g.parent == nil {\n\t\treturn g.middlewares\n\t}\n\n\treturn append(g.parent.getMiddlewares(), g.middlewares...)\n}\n\n// å®ç°Getæ–¹æ³•\nfunc (g *Group) Get(uri string, handlers ...ControllerHandler) {\n\turi = g.getAbsolutePrefix() + uri\n\tallHandlers := append(g.getMiddlewares(), handlers...)\n\tg.core.Get(uri, allHandlers...)\n}\n</code></pre><p>åœ¨core.goæ–‡ä»¶å¤¹é‡Œå†™ï¼š</p><pre><code class=\"language-go\">// åŒ¹é…GET æ–¹æ³•, å¢åŠ è·¯ç”±è§„åˆ™\nfunc (c *Core) Get(url string, handlers ...ControllerHandler) {\n\t// å°†coreçš„middleware å’Œ handlersç»“åˆèµ·æ¥\n\tallHandlers := append(c.middlewares, handlers...)\n\tif err := c.router[\"GET\"].AddRouter(url, allHandlers); err != nil {\n\t\tlog.Fatal(\"add router error: \", err)\n\t}\n}\n\n</code></pre><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ pipeline æ€æƒ³å¯¹ä¸­é—´ä»¶çš„æ”¹é€ å°±å®Œæˆäº†, æœ€ç»ˆçš„UMLç±»å›¾å¦‚ä¸‹ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/7f/ab/7f26e60d79ec987dba10a1b5045aa2ab.jpg?wh=1920x1277\" alt=\"\"></p><p>è®©æˆ‘ä»¬ç®€è¦å›é¡¾ä¸‹æ”¹é€ è¿‡ç¨‹ã€‚</p><p>ç¬¬ä¸€æ­¥ä½¿ç”¨æ§åˆ¶å™¨é“¾è·¯ï¼Œæˆ‘ä»¬<strong>æ”¹é€ äº†nodeå’ŒContextä¸¤ä¸ªæ•°æ®ç»“æ„</strong>ã€‚ä¸ºnodeå¢åŠ äº†handlersï¼Œå­˜æ”¾è¿™ä¸ªè·¯ç”±æ³¨å†Œçš„æ‰€æœ‰ä¸­é—´ä»¶ï¼›Contextä¹Ÿå¢åŠ äº†handlersï¼Œåœ¨Core.ServeHttpçš„å‡½æ•°ä¸­ï¼Œåˆ›å»ºContextç»“æ„ï¼Œå¯»æ‰¾åˆ°è¯·æ±‚å¯¹åº”çš„è·¯ç”±èŠ‚ç‚¹ï¼Œç„¶åæŠŠè·¯ç”±èŠ‚ç‚¹çš„handlersæ•°ç»„ï¼Œå¤åˆ¶åˆ°Contextä¸­çš„handlersã€‚</p><p>ä¸ºäº†å®ç°çœŸæ­£çš„é“¾è·¯è°ƒç”¨ï¼Œéœ€è¦åœ¨æ¡†æ¶çš„<strong>ä¸¤ä¸ªåœ°æ–¹è°ƒç”¨Context.Next() æ–¹æ³•</strong>ï¼Œä¸€ä¸ªæ˜¯å¯åŠ¨ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯æ¯ä¸ªä¸­é—´ä»¶çš„è°ƒç”¨ã€‚</p><p>ç¬¬äºŒæ­¥å¦‚ä½•æ³¨å†Œæ§åˆ¶å™¨é“¾è·¯ï¼Œæˆ‘ä»¬<strong>æ”¹é€ äº†Groupå’ŒCoreä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œä¸ºå®ƒä»¬å¢åŠ äº†æ³¨å†Œä¸­é—´ä»¶çš„å…¥å£</strong>ï¼Œä¸€å¤„æ˜¯æ‰¹é‡å¢åŠ ä¸­é—´ä»¶å‡½æ•°Useï¼Œä¸€å¤„æ˜¯åœ¨æ³¨å†Œå•ä¸ªè·¯ç”±çš„Get / Post / Delete / Putæ–¹æ³•ä¸­ï¼Œä¸ºå•ä¸ªè·¯ç”±è®¾ç½®ä¸­é—´ä»¶ã€‚åœ¨è®¾è®¡å…¥å£çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å¯å˜å‚æ•°çš„è®¾è®¡ï¼Œæé«˜æ³¨å†Œå…¥å£çš„å¯ç”¨æ€§ã€‚</p><h2>åŸºæœ¬çš„ä¸­é—´ä»¶: Recovery</h2><p>æˆ‘ä»¬ç°åœ¨å·²ç»å°†ä¸­é—´ä»¶æœºåˆ¶æ­å»ºå¹¶è¿è¡Œèµ·æ¥äº†ï¼Œ ä½†æ˜¯å…·ä½“éœ€è¦å®ç°å“ªäº›ä¸­é—´ä»¶å‘¢ï¼Ÿè¿™è¦æ ¹æ®ä¸åŒéœ€æ±‚è¿›è¡Œä¸åŒçš„ç ”å‘ï¼Œæ˜¯ä¸ªé•¿æœŸè¯é¢˜ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºä¸€ä¸ªæœ€åŸºæœ¬çš„ä¸­é—´ä»¶ï¼šRecoveryã€‚</p><p>ä¸­é—´ä»¶é‚£ä¹ˆå¤šï¼Œæ¯”å¦‚è¶…æ—¶ä¸­é—´ä»¶ã€ç»Ÿè®¡ä¸­é—´ä»¶ã€æ—¥å¿—ä¸­é—´ä»¶ï¼Œä¸ºä»€ä¹ˆæˆ‘è¯´Recoveryæ˜¯æœ€åŸºæœ¬çš„å‘¢ï¼Ÿç»™å‡ºæˆ‘çš„æƒ³æ³•ä¹‹å‰ï¼Œä½ å¯ä»¥å…ˆæ€è€ƒè¿™ä¸ªé—®é¢˜ï¼šåœ¨ç¼–å†™ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘çš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°äº†ä¸€ä¸ªpanicï¼Œè€Œä¸”åœ¨ä¸šåŠ¡æ ¸å¿ƒé€»è¾‘å‡½æ•°ä¸­æœªæ•è·å¤„ç†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p>æˆ‘ä»¬è¿˜æ˜¯åŸºäºç¬¬ä¸€èŠ‚è¯¾è®²çš„net/httpçš„ä¸»æµç¨‹é€»è¾‘æ¥æ€è€ƒï¼Œå…³é”®ç»“è®ºæœ‰ä¸€ç‚¹æ˜¯ï¼Œ<strong>æ¯ä¸ªHTTPè¿æ¥éƒ½ä¼šå¼€å¯ä¸€ä¸ªGoroutineä¸ºå…¶æœåŠ¡</strong>ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ï¼Œ net/http çš„è¿›ç¨‹æ¨¡å‹æ˜¯å•è¿›ç¨‹ã€å¤šåç¨‹ã€‚<img src=\"https://static001.geekbang.org/resource/image/0f/ee/0fa86b64b6d1b1e96560420243ec6aee.jpg?wh=1920x1133\" alt=\"\"></p><p>åœ¨Golangçš„è¿™ç§æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªåç¨‹æ˜¯ç‹¬ç«‹ä¸”å¹³ç­‰çš„ï¼Œå³ä½¿æ˜¯åˆ›å»ºå­åç¨‹çš„çˆ¶åç¨‹ï¼Œåœ¨Goroutine ä¸­ä¹Ÿæ— æ³•ç®¡ç†å­åç¨‹ã€‚æ‰€ä»¥ï¼Œ<strong>æ¯ä¸ªåç¨‹éœ€è¦è‡ªå·±ä¿è¯ä¸ä¼šå¤–æŠ›panic</strong>ï¼Œä¸€æ—¦å¤–æŠ›panicäº†ï¼Œæ•´ä¸ªè¿›ç¨‹å°±è®¤ä¸ºå‡ºç°å¼‚å¸¸ï¼Œä¼šç»ˆæ­¢è¿›ç¨‹ã€‚</p><p>è¿™ä¸€ç‚¹ææ¸…æ¥šäº†ï¼Œå†çœ‹Recoveryä¸ºä»€ä¹ˆå¿…å¤‡å°±å¾ˆç®€å•ã€‚åœ¨net/httpå¤„ç†ä¸šåŠ¡é€»è¾‘çš„åç¨‹ä¸­ï¼Œè¦æ•è·åœ¨è‡ªå·±è¿™ä¸ªåç¨‹ä¸­æŠ›å‡ºçš„panicï¼Œå°±å¿…é¡»è‡ªå·±å®ç° Recovery æœºåˆ¶ã€‚</p><p>è€ŒRecoveryä¸­é—´ä»¶å°±æ˜¯ç”¨æ¥ä¸ºæ¯ä¸ªåç¨‹å¢åŠ Recoveryæœºåˆ¶çš„ã€‚æˆ‘ä»¬åœ¨æ¡†æ¶çš„middlewareæ–‡ä»¶å¤¹ä¸­å¢åŠ recovery.goå­˜æ”¾è¿™ä¸ªä¸­é—´ä»¶ï¼š</p><pre><code class=\"language-go\">// recoveryæœºåˆ¶ï¼Œå°†åç¨‹ä¸­çš„å‡½æ•°å¼‚å¸¸è¿›è¡Œæ•è·\nfunc Recovery() framework.ControllerHandler {\n\t// ä½¿ç”¨å‡½æ•°å›è°ƒ\n\treturn func(c *framework.Context) error {\n\t\t// æ ¸å¿ƒåœ¨å¢åŠ è¿™ä¸ªrecoveræœºåˆ¶ï¼Œæ•è·c.Next()å‡ºç°çš„panic\n\t\tdefer func() {\n\t\t\tif err := recover(); err != nil {\n\t\t\t\tc.Json(500, err)\n\t\t\t}\n\t\t}()\n\t\t// ä½¿ç”¨nextæ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘\n\t\tc.Next()\n\n\t\treturn nil\n\t}\n}\n</code></pre><p>è¿™ä¸ªä¸­é—´ä»¶å°±æ˜¯åœ¨context.Next() ä¹‹å‰è®¾ç½®äº†defer å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯æ•è·c.Next()ä¸­æŠ›å‡ºçš„å¼‚å¸¸panicã€‚ä¹‹ååœ¨ä¸šåŠ¡æ–‡ä»¶å¤¹ä¸­çš„main.goï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Coreç»“æ„çš„Useæ–¹æ³•ï¼Œå¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½è®¾ç½®è¿™ä¸ªä¸­é—´ä»¶ã€‚</p><pre><code class=\"language-go\">core.Use(middleware.Recovery())\n</code></pre><p>ä»Šå¤©æ‰€æœ‰ä»£ç çš„ç›®å½•ç»“æ„æˆªå›¾ï¼Œæˆ‘ä¹Ÿè´´åœ¨è¿™é‡Œä¾›ä½ å¯¹æ¯”æ£€æŸ¥ï¼Œä»£ç æ”¾åœ¨GitHubä¸Šçš„ <a href=\"https://github.com/gohade/coredemo/tree/geekbang/04/framework\">04åˆ†æ”¯</a>é‡Œã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/b8/yy/b8a053e4650ec9560754383d0f3974yy.png?wh=784x1274\" alt=\"\"></p><h2>å°ç»“</h2><p>ä»Šå¤©æˆ‘ä»¬æœ€ç»ˆä¸ºè‡ªå·±çš„æ¡†æ¶å¢åŠ äº†ä¸­é—´ä»¶æœºåˆ¶ã€‚ä¸­é—´ä»¶æœºåˆ¶çš„æœ¬è´¨å°±æ˜¯è£…é¥°å™¨æ¨¡å‹ï¼Œå¯¹æ ¸å¿ƒçš„é€»è¾‘å‡½æ•°è¿›è¡Œè£…é¥°ã€å°è£…ï¼Œæ‰€ä»¥ä¸€å¼€å§‹æˆ‘ä»¬å°±ä½¿ç”¨å‡½æ•°åµŒå¥—çš„æ–¹å¼å®ç°äº†ä¸­é—´ä»¶æœºåˆ¶ã€‚</p><p>ä½†æ˜¯å®ç°ä¹‹åï¼Œæˆ‘ä»¬å‘ç°å‡½æ•°åµŒå¥—çš„å¼Šç«¯ï¼šä¸€æ˜¯ä¸ä¼˜é›…ï¼ŒäºŒæ˜¯æ— æ³•æ‰¹é‡è®¾ç½®ä¸­é—´ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬<strong>å¼•å…¥äº†pipelineçš„æ€æƒ³ï¼Œå°†æ‰€æœ‰ä¸­é—´ä»¶åšæˆä¸€ä¸ªé“¾æ¡ï¼Œé€šè¿‡è¿™ä¸ªé“¾æ¡çš„è°ƒç”¨ï¼Œæ¥å®ç°ä¸­é—´ä»¶æœºåˆ¶</strong>ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬é€‰äº†æœ€åŸºç¡€çš„Recoveryä¸­é—´ä»¶æ¼”ç¤ºå¦‚ä½•å…·ä½“å®ç°ï¼Œä¸€æ–¹é¢ä½œä¸ºä¸­é—´ä»¶æœºåˆ¶çš„ç¤ºä¾‹ï¼Œå¦ä¸€æ–¹é¢ï¼Œä¹Ÿåœ¨åŠŸèƒ½ä¸Šä¸ºæˆ‘ä»¬çš„æ¡†æ¶å¢å¼ºäº†å¥å£®æ€§ã€‚</p><p>ä¸­é—´ä»¶æœºåˆ¶æ˜¯æˆ‘ä»¬å¿…é¡»è¦æŒæ¡çš„æœºåˆ¶ï¼Œå¾ˆå¤šWebæ¡†æ¶ä¸­éƒ½æœ‰è¿™ä¸ªé€»è¾‘ã€‚<strong>åœ¨æ¶æ„å±‚é¢ï¼Œä¸­é—´ä»¶æœºåˆ¶å°±ç›¸å½“äºï¼Œåœ¨æ¯ä¸ªè¯·æ±‚çš„æ¨ªåˆ‡é¢ç»Ÿä¸€æ³¨å…¥äº†ä¸€ä¸ªé€»è¾‘</strong>ã€‚è¿™ç§ç»Ÿä¸€å¤„ç†çš„é€»è¾‘æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œæ¯”å¦‚ç»Ÿä¸€æ‰“å°æ—¥å¿—ã€ç»Ÿä¸€æ‰“ç‚¹åˆ°ç»Ÿè®¡ç³»ç»Ÿã€ç»Ÿä¸€åšæƒé™ç™»å½•éªŒè¯ç­‰ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ç°åœ¨å¸Œæœ›èƒ½å¯¹æ¯ä¸ªè¯·æ±‚éƒ½è¿›è¡Œè¯·æ±‚æ—¶é•¿ç»Ÿè®¡ï¼Œæ‰€ä»¥æƒ³å†™ä¸€ä¸ªè¯·æ±‚æ—¶é•¿ç»Ÿè®¡çš„ä¸­é—´ä»¶ï¼Œåœ¨æ—¥å¿—ä¸­è¾“å‡ºè¯·æ±‚ URIã€è¯·æ±‚è€—æ—¶ã€‚ä¸çŸ¥é“ä½ å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„æ€è€ƒã€‚å¦‚æœä½ è§‰å¾—ä»Šå¤©çš„å†…å®¹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ï¼Œé‚€è¯·ä»–ä¸€èµ·å­¦ä¹ ï½</p>","comments":[{"had_liked":false,"id":313503,"user_name":"skyhackvip","can_delete":false,"product_type":"c1","uid":1083561,"ip_address":"","ucode":"05C7784736C97A","user_header":"https://static001.geekbang.org/account/avatar/00/10/88/a9/789fc9b0.jpg","comment_is_top":false,"comment_ctime":1632469357,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"31697240429","product_id":100090601,"comment_content":"core.goä»£ç ä¸­æ·»åŠ ä¸­é—´ä»¶æœ‰äº›é—®é¢˜å§ï¼Ÿ<br>func (c *Core) Use(middlewares ...ControllerHandler) { c.middlewares = middlewares}<br>æ˜¯å¦åº”è¯¥æ”¹ä¸º<br>func (c *Core) Use(middlewares ...ControllerHandler) { c.middlewares = append(c.middlewares, middlewares...)}<br>å¦åˆ™æ·»åŠ å¤šä¸ªä¸‹é¢çš„ä¼šè¦†ç›–ä¸Šé¢çš„ã€‚","like_count":7,"discussions":[{"author":{"id":1001257,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/29/425a2030.jpg","nickname":"Groot","note":"","ucode":"D3919AFA300C79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397358,"discussion_content":"ä½¿ç”¨ append ä¹‹åéœ€è¦æ³¨æ„ä¸€ä¸‹ slice æ‰©å®¹çš„é—®é¢˜\n\nå‡å¦‚æ¯æ¬¡è°ƒç”¨ core.Use åªæ·»åŠ ä¸€ä¸ª middlewareï¼Œä¸”å…±è°ƒç”¨äº† 3 æ¬¡\næ­¤æ—¶ c.middlewares çš„ len æ˜¯ 3ï¼Œcap æ˜¯ 4\n\nå¦‚æœåç»­åª append ä¸€ä¸ªä¸šåŠ¡ controller ä¹‹åå°±å†™å…¥ node çš„è¯ï¼Œslice æ˜¯ä¸ä¼šæ‰©å®¹çš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æ‰€æœ‰çš„ node.handlers åº•å±‚éƒ½å…±ç”¨åŒä¸€ä¸ªæ•°ç»„ï¼Œæ‰€æœ‰ node.handlers ä¸­çš„æœ€åä¸€ç¯éƒ½æ˜¯åŒä¸€ä¸ªä¸šåŠ¡ controllerï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªæ³¨å†Œçš„è·¯ç”±çš„ controller\n\né¿å…è¿™ä¸ªé—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåœ¨è°ƒç”¨ Tree.AddRouter() ä¹‹å‰ copy ä¸€ä¸‹ handlers è¿™ä¸ª sliceï¼Œè¿™æ ·å°±ä¸å†å…±äº«åº•å±‚æ•°ç»„\n\nä½†ä¸çŸ¥é“è¿™ä¸ªæ€§èƒ½æ€ä¹ˆæ ·ï¼Œè¿˜æœ‰å…¶ä»–ä»€ä¹ˆå¥½çš„æ–¹æ³•å—ï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632591204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2446470,"avatar":"","nickname":"Geek_8585e5","note":"","ucode":"CEB57327AA2E0A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001257,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/29/425a2030.jpg","nickname":"Groot","note":"","ucode":"D3919AFA300C79","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581844,"discussion_content":"æˆ‘ç†è§£å³ä½¿å¤šå€‹nodeå…±ç”¨ä¸­é—´ä»¶ä¹Ÿæ²¡å•¥é—®é¢˜å§ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659020529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":397358,"ip_address":"é™•è¥¿"},"score":581844,"extra":""}]}]},{"had_liked":false,"id":312914,"user_name":"qinsi","can_delete":false,"product_type":"c1","uid":1667175,"ip_address":"","ucode":"090D9C4068FF12","user_header":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","comment_is_top":false,"comment_ctime":1632120184,"is_pvip":true,"replies":[{"id":"113609","content":"1 æ˜¯çš„ï¼Œä¸­é—´ä»¶æ³¨å†Œæœ‰é¡ºåºï¼Œæ‰€ä»¥recoveryæ˜¯éœ€è¦æ”¾åœ¨ç¬¬ä¸€ä¸ªã€‚<br>2 è¿™ä¸ªæ˜¯å¯ä»¥è€ƒè™‘ï¼Œä½†æ˜¯åˆ†æˆä¸¤ä¸ªå‡½æ•°å’Œç°åœ¨ç”¨ä¸€ä¸ªå‡½æ•°åŒºåˆ«å°±æ˜¯æœ‰çš„å˜é‡æ˜¯æ²¡æœ‰åŠæ³•å†™åˆ°ä¸¤ä¸ªå‡½æ•°ä¸­çš„ï¼Œå‚æ•°ä¼ é€’æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯”å¦‚æˆ‘è¦æ‰“å°è¯·æ±‚æ—¶é•¿ï¼Œæœ‰ä¸€ä¸ªå˜é‡ï¼Œstart_time, éœ€è¦åœ¨preRequestä¸­å†™ï¼ŒpostRequestä¸­è¯»ï¼Œç°åœ¨çš„æ–¹å¼å°±æ¯”è¾ƒç®€å•ã€‚åˆ†æˆä¸¤ä¸ªå‡½æ•°å°±éœ€è¦åœ¨postRequestä¸­ç”¨å‚æ•°ä¼ é€’ä¹‹ç±»çš„ã€‚<br>preRequest() ctxParam<br>postRequest(ctxParam)<br><br>3 æ³¨é‡Šæ¥è¡¨ç¤ºè£…é¥°å™¨ï¼Œç„¶åè¿è¡Œçš„æ—¶å€™è¯»å–æ³¨é‡Šæ¥æŒ‰éœ€åŠ è½½ã€‚è¿™ç§æ–¹å¼ä¹Ÿæ˜¯è¡Œçš„ï¼Œå°±æ˜¯å…·ä½“å®ç°çš„æ—¶å€™éœ€è¦è¯»å–â€œæ³¨é‡Šâ€æ¥æ˜ å°„ä¸­é—´ä»¶ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªåå°„çš„é€»è¾‘ï¼Œå¯èƒ½ä¼šé™ä½æ•ˆç‡ã€‚æ‰€ä»¥åœ¨golangä¸­è¿™ç§å®ç°ä¸å¤šè§ã€‚","user_name":"ä½œè€…å›å¤","comment_id":312914,"uid":"1069186","ip_address":"","utype":1,"ctime":1632622908,"user_name_real":"å¶å‰‘å³°"}],"discussion_count":4,"race_medal":0,"score":"23106956664","product_id":100090601,"comment_content":"æƒ³åˆ°å‡ ä¸ªç‚¹ï¼š<br><br>* ä¸­é—´ä»¶çš„æ³¨å†Œæ˜¯æœ‰é¡ºåºçš„ã€‚æ¯”å¦‚æœ€åæ‰æ³¨å†ŒRecoveryçš„è¯ï¼Œpipelineä¸­åœ¨Recoveryå‰é¢çš„ä¸­é—´ä»¶å¦‚æœpanicäº†è¿˜æ˜¯æ²¡æ³•recoverçš„<br>* ä¸­é—´ä»¶éœ€è¦æ˜¾å¼è°ƒç”¨ctx.Next()ï¼Œå¦‚æœå†™ä¸­é—´ä»¶æ—¶å¿˜è®°äº†çš„è¯pipelineå°±æ–­äº†ã€‚æˆ–è®¸å¯ä»¥æŠŠä¸­é—´ä»¶è¿›ä¸€æ­¥æ‹†æˆpreRequest()å’ŒpostRequest()ä¸¤éƒ¨åˆ†<br>* ä¸­é—´ä»¶æœ¬è´¨æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œå¦‚æœèƒ½åƒJava&#47;Pythoné‡Œé‚£æ ·å†™è£…é¥°å™¨æ ‡æ³¨çš„è¯å¯èƒ½æ„å›¾æ›´æ˜æ˜¾","like_count":5,"discussions":[{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"å‹","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535093,"discussion_content":"ä¸ªäººæ„Ÿè§‰ å†™ä¸­é—´ä»¶çš„æ—¶å€™å¿˜è®° Nextè¿™ä¸ªç®—æ˜¯ç¨‹åºå‘˜è‡ªå·±çš„é”…","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638350420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527158,"discussion_content":"1 æ˜¯çš„ï¼Œä¸­é—´ä»¶æ³¨å†Œæœ‰é¡ºåºï¼Œæ‰€ä»¥recoveryæ˜¯éœ€è¦æ”¾åœ¨ç¬¬ä¸€ä¸ªã€‚\n2 è¿™ä¸ªæ˜¯å¯ä»¥è€ƒè™‘ï¼Œä½†æ˜¯åˆ†æˆä¸¤ä¸ªå‡½æ•°å’Œç°åœ¨ç”¨ä¸€ä¸ªå‡½æ•°åŒºåˆ«å°±æ˜¯æœ‰çš„å˜é‡æ˜¯æ²¡æœ‰åŠæ³•å†™åˆ°ä¸¤ä¸ªå‡½æ•°ä¸­çš„ï¼Œå‚æ•°ä¼ é€’æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯”å¦‚æˆ‘è¦æ‰“å°è¯·æ±‚æ—¶é•¿ï¼Œæœ‰ä¸€ä¸ªå˜é‡ï¼Œstart_time, éœ€è¦åœ¨preRequestä¸­å†™ï¼ŒpostRequestä¸­è¯»ï¼Œç°åœ¨çš„æ–¹å¼å°±æ¯”è¾ƒç®€å•ã€‚åˆ†æˆä¸¤ä¸ªå‡½æ•°å°±éœ€è¦åœ¨postRequestä¸­ç”¨å‚æ•°ä¼ é€’ä¹‹ç±»çš„ã€‚\npreRequest() ctxParam\npostRequest(ctxParam)\n\n3 æ³¨é‡Šæ¥è¡¨ç¤ºè£…é¥°å™¨ï¼Œç„¶åè¿è¡Œçš„æ—¶å€™è¯»å–æ³¨é‡Šæ¥æŒ‰éœ€åŠ è½½ã€‚è¿™ç§æ–¹å¼ä¹Ÿæ˜¯è¡Œçš„ï¼Œå°±æ˜¯å…·ä½“å®ç°çš„æ—¶å€™éœ€è¦è¯»å–â€œæ³¨é‡Šâ€æ¥æ˜ å°„ä¸­é—´ä»¶ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªåå°„çš„é€»è¾‘ï¼Œå¯èƒ½ä¼šé™ä½æ•ˆç‡ã€‚æ‰€ä»¥åœ¨golangä¸­è¿™ç§å®ç°ä¸å¤šè§ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1632622908,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1107540,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e6/54/86056001.jpg","nickname":"å°é©¬ğŸ","note":"","ucode":"8CA466A4004BDB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589138,"discussion_content":"å¯¹çš„ ä¸€èˆ¬æ¡†æ¶éƒ½ä¼šæœ‰ preå’Œafterçš„ï¼Œæ²¡æ¯›ç—… ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664441651,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1667175,"avatar":"https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg","nickname":"qinsi","note":"","ucode":"090D9C4068FF12","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":398776,"discussion_content":"2çš„è¯ï¼Œä¸€ä¸ªä¸­é—´ä»¶å°±æ˜¯ä¸€ä¸ªstructï¼ŒçŠ¶æ€å¯ä»¥è¢«structä¸­çš„æ–¹æ³•å…±äº«","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632841437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":312891,"user_name":"liyanfeng","can_delete":false,"product_type":"c1","uid":1195376,"ip_address":"","ucode":"C8CC37F4CC02AE","user_header":"https://static001.geekbang.org/account/avatar/00/12/3d/70/a2202898.jpg","comment_is_top":false,"comment_ctime":1632107450,"is_pvip":false,"replies":[{"id":"113508","content":"å¯ç”¨å·¥å…·å¾ˆå¤šï¼Œdraw.io é‡‘å±±æ–‡æ¡£éƒ½èƒ½ç”¨","user_name":"ä½œè€…å›å¤","comment_id":312891,"uid":"2547771","ip_address":"","utype":1,"ctime":1632414857,"user_name_real":"å¤šå°‘"}],"discussion_count":1,"race_medal":0,"score":"14517009338","product_id":100090601,"comment_content":"è¯·æ•™ä¸€ä¸‹è€å¸ˆçš„UMLå›¾æ˜¯ç”¨å“ªä¸ªè½¯ä»¶ç”»çš„å“ˆï¼Ÿ","like_count":3,"discussions":[{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527149,"discussion_content":"å¯ç”¨å·¥å…·å¾ˆå¤šï¼Œdraw.io é‡‘å±±æ–‡æ¡£éƒ½èƒ½ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632414857,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334346,"user_name":"Juniper","can_delete":false,"product_type":"c1","uid":1174794,"ip_address":"","ucode":"1BC24554034BD3","user_header":"https://static001.geekbang.org/account/avatar/00/11/ed/0a/18201290.jpg","comment_is_top":false,"comment_ctime":1644895479,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10234830071","product_id":100090601,"comment_content":"æ—¥å¸¸ä½¿ç”¨çš„webæ¡†æ¶ï¼Œä¸­é—´ä»¶æ˜¯åŸºæœ¬åŠŸèƒ½ä¹‹ä¸€ï¼Œé€šè¿‡è‡ªå·±å®ç°ä¸€éï¼Œæ˜ç™½å…¶ä¸­çš„åŸç†ï¼ŒåŠ æ·±å°è±¡ï¼Œä¸é”™","like_count":2},{"had_liked":false,"id":328702,"user_name":"answerå®«","can_delete":false,"product_type":"c1","uid":1114020,"ip_address":"","ucode":"54CA51DE2BE829","user_header":"https://static001.geekbang.org/account/avatar/00/10/ff/a4/55520286.jpg","comment_is_top":false,"comment_ctime":1640848392,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10230782984","product_id":100090601,"comment_content":"çœ‹ä¸€éæœ‰ç‚¹æ™•,è¦å¤šè¯»å‡ éäº†,è¯¾ç¨‹ä¸é”™,æ˜¯æˆ‘çš„ç›²ç‚¹","like_count":2},{"had_liked":false,"id":324267,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1638351621,"is_pvip":false,"replies":[{"id":"118679","content":"ä¹‹å‰ç¡®å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå·²ç»ä¿®æ”¹è¿‡æ¥äº†","user_name":"ä½œè€…å›å¤","comment_id":324267,"uid":"1069186","ip_address":"","utype":1,"ctime":1639619492,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"10228286213","product_id":100090601,"comment_content":"æˆ‘çœ‹å¤§å®¶éƒ½è¯´ allHandlers := append(c.middlewares, handlers...) çš„å†™æ³•æœ‰é—®é¢˜ã€‚å…¶å®æ²¡é—®é¢˜ <br>å› ä¸ºæ¯æ¬¡æ‰©å®¹çš„æ—¶å€™ å¹¶æ²¡æœ‰èµ‹å€¼å›å» å³ :c.middwares  := append(c.middlewares, handlers...)<br>æ‰€ä»¥æ¯æ¬¡éƒ½æ˜¯æ‹¿æœªæ‰©å®¹çš„æ•°ç»„æ¥ å¹¶ä¸ä¼šå‡ºç°è¦†ç›–çš„æƒ…å†µ <br>","like_count":2,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539134,"discussion_content":"ä¹‹å‰ç¡®å®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå·²ç»ä¿®æ”¹è¿‡æ¥äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1639619492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":319802,"user_name":"Geek_8de965","can_delete":false,"product_type":"c1","uid":2831170,"ip_address":"","ucode":"75880FD1790C37","user_header":"","comment_is_top":false,"comment_ctime":1635949080,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10225883672","product_id":100090601,"comment_content":"è‡ªå·±å†™åç¢°åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š<br>1.è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º2sï¼Œä¸šåŠ¡é‡Œä¹ŸSleepä¸¤ç§’ï¼Œå‡ºç°ä¸¤ä¸ªåç¨‹éƒ½è®¿é—®äº†c.JSONï¼Œç¨‹åºå´©æºƒï¼Œåœ¨timeouté‚£è¾¹åŠ äº†c.WriterMux().Lock()å¥½åƒæ²¡æœ‰ä½œç”¨<br>2.ä¸»åç¨‹é€šè¿‡setHasTimeoutè®¾ç½®è¶…æ—¶æ ‡è®°åï¼Œä¸šåŠ¡çš„é‚£ä¸ªåç¨‹è¿˜æ˜¯è¯»åˆ°çš„false,å¯¼è‡´time out å’Œ ok éƒ½è¾“å‡ºäº†ã€‚<br><br>æ‰å­¦ä¿©å‘¨Go,æœ‰è¯´å¾—ä¸å¯¹çš„åœ°æ–¹è§è°…","like_count":2,"discussions":[{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"å‹","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535096,"discussion_content":"å´©æºƒçš„é”™è¯¯ä¿¡æ¯æ˜¯ä»€ä¹ˆ å¯ä»¥çœ‹çœ‹å˜› å¦‚æœåŠ äº†é”ä¹Ÿä¸è¡Œè¯æ˜ä¸æ˜¯ç”¨çš„ä¸€ä¸ªé”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638350681,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":312890,"user_name":"liyanfeng","can_delete":false,"product_type":"c1","uid":1195376,"ip_address":"","ucode":"C8CC37F4CC02AE","user_header":"https://static001.geekbang.org/account/avatar/00/12/3d/70/a2202898.jpg","comment_is_top":false,"comment_ctime":1632107360,"is_pvip":false,"replies":[{"id":"113507","content":"æ„Ÿè°¢æ”¯æŒï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°ä½ ","user_name":"ä½œè€…å›å¤","comment_id":312890,"uid":"2547771","ip_address":"","utype":1,"ctime":1632414798,"user_name_real":"å¤šå°‘"}],"discussion_count":1,"race_medal":0,"score":"10222041952","product_id":100090601,"comment_content":"è¿™ä¹ˆå¥½çš„è¯¾ï¼Œå¤§å®¶å¿«æ¥ä¹°ğŸ˜„ï¼Œç†Ÿæ‚‰åŠ æ„å¤–çš„æ„Ÿè§‰ï¼ŒçœŸå¥½","like_count":2,"discussions":[{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527148,"discussion_content":"æ„Ÿè°¢æ”¯æŒï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°ä½ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632414798,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326160,"user_name":"é‚£äº›å¹´","can_delete":false,"product_type":"c1","uid":2786613,"ip_address":"","ucode":"849A9929601B2A","user_header":"https://static001.geekbang.org/account/avatar/00/2a/85/35/0cfa2b84.jpg","comment_is_top":false,"comment_ctime":1639400758,"is_pvip":false,"replies":[{"id":"118643","content":"æ„Ÿè°¢ï¼","user_name":"ä½œè€…å›å¤","comment_id":326160,"uid":"1069186","ip_address":"","utype":1,"ctime":1639584271,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"5934368054","product_id":100090601,"comment_content":"æ”¯æŒï¼","like_count":1,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539067,"discussion_content":"æ„Ÿè°¢ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639584271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359913,"user_name":"Tal.Huang","can_delete":false,"product_type":"c1","uid":1070729,"ip_address":"å¹¿ä¸œ","ucode":"9486C855060FAA","user_header":"https://static001.geekbang.org/account/avatar/00/10/56/89/30c2f416.jpg","comment_is_top":false,"comment_ctime":1666058190,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1666058190","product_id":100090601,"comment_content":"è€å¸ˆå¥½ï¼Œå…³äºåœ¨coreä¸­å­˜å‚¨middlewares<br>&#47;&#47; æ³¨å†Œä¸­é—´ä»¶<br>func (c *Core) Use(middlewares ...ControllerHandler) {<br>\tfmt.Println(&quot;Core Use&quot;)<br>\tc.middlewares = append(c.middlewares, middlewares...)<br>\tfmt.Println(c.middlewares)<br>}<br><br>æ‰“å°å‘ç°å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Ÿ<br>Group Use<br>core Get<br>core Get<br>middleware pre test3<br>middleware pre test3<br>middleware post test3<br>middleware post test3<br><br>ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ","like_count":0},{"had_liked":false,"id":358285,"user_name":"jayqiyoung","can_delete":false,"product_type":"c1","uid":3010811,"ip_address":"","ucode":"344AC280A3DBED","user_header":"","comment_is_top":false,"comment_ctime":1664171556,"is_pvip":false,"replies":[{"id":"130382","content":"åé¢æœ‰ç¯‡åŠ é¤ï¼Œç»Ÿä¸€æ•´ç†äº†ä¸€äº›ä½œä¸šé¢˜çš„æ€è·¯ï¼Œä½ å¯ä»¥çœ‹çœ‹ï½","user_name":"ç¼–è¾‘å›å¤","comment_id":358285,"uid":"2547771","ip_address":"","utype":2,"ctime":1664184467,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1664171556","product_id":100090601,"comment_content":"å¦‚æœæ¯ä¸€èŠ‚è¯¾åé¢çš„æé—®ï¼Œä¸‹ä¸€èŠ‚èƒ½å¤Ÿç»™äº›è§£ç­”å°±å¥½äº†<br>","like_count":0,"discussions":[{"author":{"id":2547771,"avatar":"https://static001.geekbang.org/account/avatar/00/26/e0/3b/8ec916b2.jpg","nickname":"å¤šå°‘","note":"","ucode":"0A6EF7AA6E4BB7","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588862,"discussion_content":"åé¢æœ‰ç¯‡åŠ é¤ï¼Œç»Ÿä¸€æ•´ç†äº†ä¸€äº›ä½œä¸šé¢˜çš„æ€è·¯ï¼Œä½ å¯ä»¥çœ‹çœ‹ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664184467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357496,"user_name":"airmyä¸¶","can_delete":false,"product_type":"c1","uid":1299673,"ip_address":"å¹¿ä¸œ","ucode":"41959C9F5B4B65","user_header":"https://static001.geekbang.org/account/avatar/00/13/d4/d9/c3296187.jpg","comment_is_top":false,"comment_ctime":1663313601,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1663313601","product_id":100090601,"comment_content":"ä¸€éè·Ÿç€æ€è·¯å†™ä»£ç ï¼Œä¸€éçœ‹ginçš„æºç ï¼Œæ„Ÿè§‰è¿™ä¸ªè¯¾ç¨‹ä¸æ­¢åœ¨æ•™ä½ å†™æ¡†æ¶ï¼Œæ›´æ˜¯åœ¨å¸¦ä½ é˜…è¯»ginçš„æºç ","like_count":0},{"had_liked":false,"id":337007,"user_name":"Geek_065895","can_delete":false,"product_type":"c1","uid":2136069,"ip_address":"","ucode":"2E6FCCC78E5767","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/rxz5aKicRkvqWmt6c6c7eayHvh577uibBTVQzcJKwSTqI9FaxZSRlx7NRVw4atWpqER8ncA5jErQb3wb4cPzZxlA/132","comment_is_top":false,"comment_ctime":1646547498,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646547498","product_id":100090601,"comment_content":"è¯·æ±‚æ—¶é•¿ç»Ÿè®¡çš„ä¸­é—´ä»¶å®ç°ï¼š<br>func RecordRequsstTime() framework.ControllerHandler {<br>\t&#47;&#47; ä½¿ç”¨å‡½æ•°å›è°ƒ<br>\treturn func(c *framework.Context) error {<br>\t\t&#47;&#47; è·å–å¼€å§‹æ—¶é—´<br>\t\tstartT := time.Now()<br>\t\t&#47;&#47; è¾“å‡ºè¯·æ±‚URI<br>\t\t<br>\t\t&#47;&#47; æ‰§è¡Œå…¶ä»–ä¸­é—´ä»¶å’Œå‡½æ•°å¤„ç†<br>\t\tc.Next()<br>\t\t&#47;&#47; è·å–å¤„ç†æ—¶é•¿<br>\t\ttc := time.Since(startT)<br>\t\tlog.Println(tc)<br>\t\treturn nil<br>\t}<br>}","like_count":0},{"had_liked":false,"id":327380,"user_name":"æˆ‘åœ¨ç¡è§‰","can_delete":false,"product_type":"c1","uid":2179383,"ip_address":"","ucode":"6503B611151D3C","user_header":"https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg","comment_is_top":false,"comment_ctime":1640090787,"is_pvip":false,"replies":[{"id":"119249","content":"è¿™ä¸ªä¸»è¦æ˜¯ä½¿ç”¨ä¸Šçš„æ–¹ä¾¿ï¼Œé“¾å¼æ–¹å¼ã€‚<br><br>æˆ‘å¯ä»¥å¤šå±‚åµŒå¥—group","user_name":"ä½œè€…å›å¤","comment_id":327380,"uid":"1069186","ip_address":"","utype":1,"ctime":1640221658,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1640090787","product_id":100090601,"comment_content":"æä¸€ä¸ªé—®é¢˜ï¼Œè¿™é‡Œé¢ gourpæœºæ„é¢˜é‡Œé¢å°è£…ä¸€ä¸ªGroupç±»å‹çš„parenté“¾è¡¨æœ‰ä»€ä¹ˆç”¨æ„ï¼Œæˆ‘ä¸éœ€è¦è¿™ä¸ªparentå­—æ®µä¹Ÿå®Œå…¨å®ç°äº†åŒæ ·çš„åŠŸèƒ½ã€‚","like_count":0,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540948,"discussion_content":"è¿™ä¸ªä¸»è¦æ˜¯ä½¿ç”¨ä¸Šçš„æ–¹ä¾¿ï¼Œé“¾å¼æ–¹å¼ã€‚\n\næˆ‘å¯ä»¥å¤šå±‚åµŒå¥—group","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640221658,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2179383,"avatar":"https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg","nickname":"æˆ‘åœ¨ç¡è§‰","note":"","ucode":"6503B611151D3C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540604,"discussion_content":"gourpæœºæ„é¢˜ -&gt; groupç»“æ„ä½“ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640092644,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326330,"user_name":"æˆ‘åœ¨ç¡è§‰","can_delete":false,"product_type":"c1","uid":2179383,"ip_address":"","ucode":"6503B611151D3C","user_header":"https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg","comment_is_top":false,"comment_ctime":1639472386,"is_pvip":false,"replies":[{"id":"118639","content":"æ˜¯è¿™æ ·çš„ï¼Œè¿™æ ·è®¾ç½®çš„è¯ï¼Œä½ å¯ä»¥åœ¨Test1çš„å‚æ•°ä¸­å¸¦ä»»ä½•å‚æ•°ï¼Œç„¶ååœ¨å…·ä½“çš„ControllerHandlerä¸­ä½¿ç”¨è¿™äº›å‚æ•°ï¼Œè€Œå¦‚æœä½ çš„Test1æ˜¯ControllerHandlerçš„è¯ï¼Œå‚æ•°å°±å·²ç»è¢«å›ºå®šäº†ï¼Œåç»­æ‰©å±•æ€§å°±ä¸æ˜¯å¾ˆå¥½<br>","user_name":"ä½œè€…å›å¤","comment_id":326330,"uid":"1069186","ip_address":"","utype":1,"ctime":1639584077,"user_name_real":"ç¼–è¾‘"}],"discussion_count":3,"race_medal":0,"score":"1639472386","product_id":100090601,"comment_content":"core.Use( middleware.Test1()ï¼‰<br>è€å¸ˆä½ å¥½ã€‚é—®ä¸€ä¸ªé—®é¢˜ï¼Œ ä¸ºä»€ä¹ˆæ­¤å¤„çš„Test1ä¸€å®šè¦å®šä¹‰æˆè¿”å›ControllerHandleråŒ¿åå‡½æ•°çš„å‡½æ•°ï¼Œæˆ‘å®é™…ç›´æ¥æŠŠTest1å®šä¹‰æˆControllerHandlerç±»å‹çš„çš„å‡½æ•°æ‰§è¡Œèµ·æ¥ä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚","like_count":0,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539061,"discussion_content":"æ˜¯è¿™æ ·çš„ï¼Œè¿™æ ·è®¾ç½®çš„è¯ï¼Œä½ å¯ä»¥åœ¨Test1çš„å‚æ•°ä¸­å¸¦ä»»ä½•å‚æ•°ï¼Œç„¶ååœ¨å…·ä½“çš„ControllerHandlerä¸­ä½¿ç”¨è¿™äº›å‚æ•°ï¼Œè€Œå¦‚æœä½ çš„Test1æ˜¯ControllerHandlerçš„è¯ï¼Œå‚æ•°å°±å·²ç»è¢«å›ºå®šäº†ï¼Œåç»­æ‰©å±•æ€§å°±ä¸æ˜¯å¾ˆå¥½\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639584077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":2179383,"avatar":"https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg","nickname":"æˆ‘åœ¨ç¡è§‰","note":"","ucode":"6503B611151D3C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"discussion":{"id":539257,"discussion_content":"æ˜ç™½ï¼Œä¹Ÿå°±æ˜¯ä¸ºä»¥ååˆ©ç”¨å‡½æ•°çš„é—­åŒ…ç‰¹æ€§é¢„å…ˆå‡†å¤‡ç€å‘—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639649061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":539061,"ip_address":""},"score":539257,"extra":""},{"author":{"id":1471109,"avatar":"https://static001.geekbang.org/account/avatar/00/16/72/85/c337e9a1.jpg","nickname":"è€å…µ","note":"","ucode":"F004F8EC90E5B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"discussion":{"id":551955,"discussion_content":"è¯·æ•™å¶è€å¸ˆï¼Œæ¯”å¦‚Timeoutå‡½æ•°ä¸­çš„ d time.Durationå¦‚ä½•å¯ä»¥åœ¨å…·ä½“çš„ControllerHandlerä¸­è·å¾—å‘¢ï¼Ÿ ä¼ åˆ°ctxä¸­ï¼Ÿ è¿˜æ˜¯å†ctx.Next()è°ƒç”¨æ—¶ä¼ å…¥å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645187948,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":539061,"ip_address":""},"score":551955,"extra":""}]}]},{"had_liked":false,"id":324271,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1638352430,"is_pvip":false,"replies":[{"id":"118680","content":"1 ç¡®å®è¿™é‡Œæ›´ä¸¥è°¨çš„å†™æ³•æ˜¯åœ¨æ‰€æœ‰ä¸­é—´ä»¶çš„c.Next() éƒ½å¤„ç†error<br>2 ä½¿ç”¨é”ä¿è¯ responseWriter åªå†™ä¸€æ¬¡è‚¯å®šæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™ç§åªé™åˆ¶å†™ä¸€æ¬¡åè€Œä¹Ÿä¼šæœ‰é—®é¢˜ï¼Œä¼šä¸ä¼šæœ‰åœºæ™¯æœ‰çš„æ§åˆ¶å™¨å†™å†…å®¹ï¼Œæœ‰çš„ä¸­é—´ä»¶å†™headerå¤´è¿™ç§ã€‚è¿™ç§é™åˆ¶å¯ä»¥åŠ ï¼Œä½†æ˜¯åŠ çš„æ—¶å€™ä¼°è®¡è¦æ€è€ƒå¾ˆæ¸…æ¥š","user_name":"ä½œè€…å›å¤","comment_id":324271,"uid":"1069186","ip_address":"","utype":1,"ctime":1639619818,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1638352430","product_id":100090601,"comment_content":"è€å¸ˆè¯·é—®  c.Nextæ˜¯å¯ä»¥æ•è·errorçš„ åœ¨æ•´ä¸ªé“¾è·¯ä¸­å¦‚æœä¸€å¤„åœ°æ–¹æŠ›å‡ºäº†error  ä½†æ˜¯åœ¨æœ€é¡¶å±‚ ServeHTTPä¸­çš„é‚£ä¸ªnextå¦‚æœè¿”å›nil é‚£ä¹ˆæ•´æ¡é“¾è·¯ä¸­çš„errorä¼šè¢«å¿½ç•¥æ‰<br>æˆ‘ä»¬åªåœ¨ timeoutä¸­åŠ å…¥äº† é”è¿™ä¸ªæ¦‚å¿µ å…¶å®è¿™ä¸ªå…¶å®è¿™ä¸ªåº”è¯¥å¯ä»¥æŠ½å‡ºæ¥ ç»Ÿä¸€åŠ ä¸Šä¸å…è®¸é‡å¤å†™responseWriter<br>","like_count":0,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539135,"discussion_content":"1 ç¡®å®è¿™é‡Œæ›´ä¸¥è°¨çš„å†™æ³•æ˜¯åœ¨æ‰€æœ‰ä¸­é—´ä»¶çš„c.Next() éƒ½å¤„ç†error\n2 ä½¿ç”¨é”ä¿è¯ responseWriter åªå†™ä¸€æ¬¡è‚¯å®šæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™ç§åªé™åˆ¶å†™ä¸€æ¬¡åè€Œä¹Ÿä¼šæœ‰é—®é¢˜ï¼Œä¼šä¸ä¼šæœ‰åœºæ™¯æœ‰çš„æ§åˆ¶å™¨å†™å†…å®¹ï¼Œæœ‰çš„ä¸­é—´ä»¶å†™headerå¤´è¿™ç§ã€‚è¿™ç§é™åˆ¶å¯ä»¥åŠ ï¼Œä½†æ˜¯åŠ çš„æ—¶å€™ä¼°è®¡è¦æ€è€ƒå¾ˆæ¸…æ¥š","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1639619818,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324045,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1638270580,"is_pvip":false,"replies":[{"id":"119255","content":"ï½ï½","user_name":"ä½œè€…å›å¤","comment_id":324045,"uid":"1069186","ip_address":"","utype":1,"ctime":1640222902,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1638270580","product_id":100090601,"comment_content":"è¿˜æ²¡å¼€å§‹çœ‹ ï¼Œä½†æ˜¯è®°å¾—contextç« èŠ‚ æŠŠè¶…æ—¶æ§åˆ¶åˆ°å†™åœ¨äº†controllerä¸­ éƒ½å¾—ç›‘å¬ è²Œä¼¼è¿™ç« ä¼šä¼˜åŒ– æ˜å¤©å†æˆ˜ ä¼‘æ¯ä¸€ä¸‹","like_count":0,"discussions":[{"author":{"id":1069186,"avatar":"https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg","nickname":"å¶å‰‘å³°","note":"","ucode":"3974D917C69C29","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540960,"discussion_content":"ï½ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640222902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320835,"user_name":"void","can_delete":false,"product_type":"c1","uid":1145429,"ip_address":"","ucode":"502ED161F271B3","user_header":"https://static001.geekbang.org/account/avatar/00/11/7a/55/2f4055f6.jpg","comment_is_top":false,"comment_ctime":1636526910,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1636526910","product_id":100090601,"comment_content":"core.Getæ–¹æ³•é‡Œçš„<br>allHandlers := append(c.middlewares, handlers...)<br>æ˜¯ä¸å¯¹çš„ï¼Œåº”å½“å¤åˆ¶ä¸€ä»½c.middlewaresã€‚åˆ‡ç‰‡åº•å±‚å…±äº«æ•°ç»„ç©ºé—´ï¼Œå¤šæ¬¡è°ƒç”¨Getæ–¹æ³•ä¼šæœ‰åè¾¹çš„handlerè¦†ç›–å‰é¢handlerçš„æƒ…å†µã€‚æ¯”å¦‚:<br>core.Use(middleware.Test1(), middleware.Test2()) &#47;&#47; æ­¤æ—¶c.middlewares len 2  cap 2<br>core.Get(&quot;&#47;user&#47;aa&quot;, SubjectDelController) &#47;&#47; c.middlewares len 3  cap 4<br>core.Get(&quot;&#47;user&#47;bb&quot;, UserLoginController) &#47;&#47; c.middlewares len 3  cap 4 è¿™é‡Œä¼šæŠŠc.middlewares[2]è¦†ç›–ï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªè·¯ç”±éƒ½æŒ‡å‘äº†UserLoginController","like_count":0,"discussions":[{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"å‹","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535099,"discussion_content":"ç¬¬ä¸€æ¬¡æ‰©å®¹å¹¶æ²¡æœ‰æŠŠmiddleware èµ‹å€¼å›å»  æ‰€ä»¥æ¯æ¬¡éƒ½æ˜¯æœªæ‰©å®¹çš„middleware","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638351552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314838,"user_name":"www","can_delete":false,"product_type":"c1","uid":1898338,"ip_address":"","ucode":"ADC9BC655EA16C","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f7/62/947004d0.jpg","comment_is_top":false,"comment_ctime":1633492389,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1633492389","product_id":100090601,"comment_content":"ä¸­é—´ä»¶åŸæ¥æ˜¯è¿™ä¹ˆå®ç°çš„ï¼Œäº†ç„¶äº†ç„¶ï¼Œé€ ä¸€éè½®å­è¿˜æ˜¯æœ€å¿«çš„å­¦ä¹ æ–¹æ³•","like_count":0},{"had_liked":false,"id":313362,"user_name":"Groot","can_delete":false,"product_type":"c1","uid":1001257,"ip_address":"","ucode":"D3919AFA300C79","user_header":"https://static001.geekbang.org/account/avatar/00/0f/47/29/425a2030.jpg","comment_is_top":false,"comment_ctime":1632390056,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1632390056","product_id":100090601,"comment_content":"Use æ³¨å†Œä¸­é—´ä»¶æ˜¯ä¸æ˜¯åº”è¯¥ç”¨ append() è¿½åŠ  middlewaresï¼Œå¦åˆ™åªæœ‰æœ€åä¸€æ¬¡è°ƒç”¨æ‰èƒ½æ³¨å†Œä¸Š","like_count":0,"discussions":[{"author":{"id":1001257,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/29/425a2030.jpg","nickname":"Groot","note":"","ucode":"D3919AFA300C79","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397357,"discussion_content":"ä½¿ç”¨ append ä¹‹åéœ€è¦æ³¨æ„ä¸€ä¸‹ slice æ‰©å®¹çš„é—®é¢˜\n\nå‡å¦‚æ¯æ¬¡è°ƒç”¨ core.Use åªæ·»åŠ ä¸€ä¸ª middlewareï¼Œä¸”å…±è°ƒç”¨äº† 3 æ¬¡\næ­¤æ—¶ c.middlewares çš„ len æ˜¯ 3ï¼Œcap æ˜¯ 4\n\nå¦‚æœåç»­åª append ä¸€ä¸ªä¸šåŠ¡ controller ä¹‹åå°±å†™å…¥ node çš„è¯ï¼Œslice æ˜¯ä¸ä¼šæ‰©å®¹çš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æ‰€æœ‰çš„ node.handlers åº•å±‚éƒ½å…±ç”¨åŒä¸€ä¸ªæ•°ç»„ï¼Œæ‰€æœ‰ node.handlers ä¸­çš„æœ€åä¸€ç¯éƒ½æ˜¯åŒä¸€ä¸ªä¸šåŠ¡ controllerï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªæ³¨å†Œçš„è·¯ç”±çš„ controller\n\né¿å…è¿™ä¸ªé—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåœ¨è°ƒç”¨ Tree.AddRouter() ä¹‹å‰ copy ä¸€ä¸‹ handlers è¿™ä¸ª sliceï¼Œè¿™æ ·å°±ä¸å†å…±äº«åº•å±‚æ•°ç»„\n\nä½†ä¸çŸ¥é“è¿™ä¸ªæ€§èƒ½æ€ä¹ˆæ ·ï¼Œè¿˜æœ‰å…¶ä»–ä»€ä¹ˆå¥½çš„æ–¹æ³•å—ï¼Ÿ","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1632591187,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1718011,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/36/fb/b480f2ac.jpg","nickname":"äººé—´ç†æƒ³","note":"","ucode":"0D6A4C402D7CBD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1001257,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/29/425a2030.jpg","nickname":"Groot","note":"","ucode":"D3919AFA300C79","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575606,"discussion_content":"ç¡®å®ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654948781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":397357,"ip_address":""},"score":575606,"extra":""}]}]}]}