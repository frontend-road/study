{"id":224525,"title":"17 | Ingress：控制进入网格的请求","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":213247,"user_name":"hhhh","can_delete":false,"product_type":"c3","uid":1256101,"ip_address":"","ucode":"9E87017424B382","user_header":"https://static001.geekbang.org/account/avatar/00/13/2a/a5/625c0a2e.jpg","comment_is_top":false,"comment_ctime":1588340123,"is_pvip":false,"replies":[{"id":79151,"content":"理解的很好👍","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588424209,"ip_address":"","comment_id":213247,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"ingress是不是只是一个抽象概念，可以通过gateway这个实际api实现，不知道我这样理解对不对？\nk8s里面没有virtualService的概念，其后端的realserver就是K8s的service.\nistio不仅抽象出了virtualService， 还提供了subSet, 控制平面修改这俩抽象，从而能够实现前面几讲中的功能\n我是这样理解的这个设计差异的：istio是专注于服务网格的，必然为了提供servicemesh相关的灵活功能要多进行抽象。\n而k8s专注于容器编排，只提供了服务方面基本的功能，高级功能依托于master代码之外的插件实现。现在是servcie mesh活，过几年不知道又是什么了，所以k8s的设计我觉得还是符合设计原则，职责单一，对扩展开放。","like_count":5,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493720,"discussion_content":"理解的很好👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588424209,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226456,"user_name":"piboye","can_delete":false,"product_type":"c3","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1592108907,"is_pvip":true,"replies":[{"id":83411,"content":"控制面不会影响你的应用，数据面的envoy本身的性能是很好的，官方的benchmark大约是2ms延迟，从我们自己做的测试来看也是比较可信的","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1592143192,"ip_address":"","comment_id":226456,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"istio 对性能影响很大吧？","like_count":2,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498246,"discussion_content":"控制面不会影响你的应用，数据面的envoy本身的性能是很好的，官方的benchmark大约是2ms延迟，从我们自己做的测试来看也是比较可信的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592143192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1066752,"avatar":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","nickname":"piboye","note":"","ucode":"7CFD8712857A85","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283504,"discussion_content":"qps可以达到多少，可以到10w不？\nistio可以使用非透明代理的方式不，侵入式的库或者框架是不是会更快？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592284734,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298332,"user_name":"又双叒叕是一年啊","can_delete":false,"product_type":"c3","uid":1000015,"ip_address":"","ucode":"E067320E537DEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","comment_is_top":false,"comment_ctime":1624019197,"is_pvip":false,"replies":[{"id":108519,"content":"Ingress一般是入口，后面挂一个vs，负责请求分发","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1624534699,"ip_address":"","comment_id":298332,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"请教下: 需要为 每个 Ingress gateway 后面路由的微服务 都 创建一个 VirtualService 和 DestinationRule 进行路由转发? 这块一般怎么玩？ ","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522102,"discussion_content":"Ingress一般是入口，后面挂一个vs，负责请求分发","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624534699,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286284,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1617239935,"is_pvip":false,"replies":[{"id":104296,"content":"一个是应用内部的入口网关，一个是外部的api网关","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1617870266,"ip_address":"","comment_id":286284,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"17 讲的ingress 和14讲的gateway 有啥区别呀","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517934,"discussion_content":"一个是应用内部的入口网关，一个是外部的api网关","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617870266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1112676,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg","nickname":"Sam Fu","note":"","ucode":"EA285A4943271F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":560535,"discussion_content":"这两个具体区别是什么呀","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649384038,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":517934,"ip_address":"","group_id":0},"score":560535,"extra":""}]},{"author":{"id":1000015,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","nickname":"又双叒叕是一年啊","note":"","ucode":"E067320E537DEE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379622,"discussion_content":"应用内部网关是做 mesh 内部服务 的流控和路由转发的是吧? 是必须的？这个关系是什么样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624019643,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277624,"user_name":"杨","can_delete":false,"product_type":"c3","uid":1971269,"ip_address":"","ucode":"7EFEFE285975C6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oltLEqTrmHm2aJP99BK6tHu5h7hp4aj08wR5Wt6H31iadFduDAVvjYKmhQ2nvGbLV3lkVdiat2GRasgWXoJeTibUg/132","comment_is_top":false,"comment_ctime":1612495112,"is_pvip":false,"replies":[{"id":101054,"content":"我假定你指的是通过Istio实现，可以通过授权相关功能实现，这个在第34讲有例子。\n不通过istio的也很多，比较常见的做法就是在api网关这一层做（大部分公有云都提供这样的能力）；也可以专门做一个鉴权的sidecar，里面就是你实现的鉴权服务，让请求先经过这个sidecar，验证通过后再redirect去应用的容器。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1612861975,"ip_address":"","comment_id":277624,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师我想问一下  我如果想在前端和后端中间加一个鉴权服务咋做  我可以在鉴权服务中设置一些请求头  做一些也许逻辑 然后再去其它服务","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515120,"discussion_content":"我假定你指的是通过Istio实现，可以通过授权相关功能实现，这个在第34讲有例子。\n不通过istio的也很多，比较常见的做法就是在api网关这一层做（大部分公有云都提供这样的能力）；也可以专门做一个鉴权的sidecar，里面就是你实现的鉴权服务，让请求先经过这个sidecar，验证通过后再redirect去应用的容器。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612861975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233125,"user_name":"҉","can_delete":false,"product_type":"c3","uid":1130004,"ip_address":"","ucode":"97EFF35344F754","user_header":"https://static001.geekbang.org/account/avatar/00/11/3e/14/f844ecca.jpg","comment_is_top":false,"comment_ctime":1594222689,"is_pvip":false,"replies":[{"id":86045,"content":"可以定义多个，挂接各自的virtualservice即可","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1594271386,"ip_address":"","comment_id":233125,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"如何配置多个 istio-gatewayingress 网关服务？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500903,"discussion_content":"可以定义多个，挂接各自的virtualservice即可","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594271386,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1130004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/3e/14/f844ecca.jpg","nickname":"҉","note":"","ucode":"97EFF35344F754","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289939,"discussion_content":"不是定义多个gateway 资源，是定义多个istio-ingressgateway 服务。\n\n我想区分下网关服务。 老师有研究过怎么配吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594276055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"ileruza","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1130004,"avatar":"https://static001.geekbang.org/account/avatar/00/11/3e/14/f844ecca.jpg","nickname":"҉","note":"","ucode":"97EFF35344F754","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576504,"discussion_content":"这就是一个普通的service啊，弄个yaml，apply -f就行了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655611911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":289939,"ip_address":"","group_id":0},"score":576504,"extra":""}]}]},{"had_liked":false,"id":216645,"user_name":"蒋小波","can_delete":false,"product_type":"c3","uid":1582588,"ip_address":"","ucode":"DF3AB36741D1DA","user_header":"https://static001.geekbang.org/account/avatar/00/18/25/fc/a128f2e2.jpg","comment_is_top":false,"comment_ctime":1589300606,"is_pvip":false,"replies":[{"id":80354,"content":"什么版本？有没有具体分析下内存高的原因？你们是什么复杂的应用需要拆分这么多服务？即便如此，对外暴露给ingress的也不多吧？","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1589470470,"ip_address":"","comment_id":216645,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师好，istio-ingressgateway在具有8000个svc的环境中，使用内存高，这种一般在部署线上环境有什么建议吗？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494893,"discussion_content":"什么版本？有没有具体分析下内存高的原因？你们是什么复杂的应用需要拆分这么多服务？即便如此，对外暴露给ingress的也不多吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589470470,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":212935,"user_name":"Charles","can_delete":false,"product_type":"c3","uid":1201560,"ip_address":"","ucode":"C8C8A4F2B6C20F","user_header":"https://static001.geekbang.org/account/avatar/00/12/55/98/a49061ab.jpg","comment_is_top":false,"comment_ctime":1588240315,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"apiVersion: networking.istio.io&#47;v1beta1\nkind: Gateway\nmetadata:\n  name: httpbin-gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      name: http\n      number: 80\n      protocol: HTTP\n    hosts:\n    - &#39;*&#39;\n\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin \nspec:\n  gateways:\n  - httpbin-gateway\n  hosts:\n  - &#39;*&#39;\n  http:\n  - match:\n    - uri:\n        prefix: &#47;status\n    - uri:\n        prefix: &#47;delay\n    route:\n    - destination:\n        host: httpbin \n        port:\n          number: 8000 ","like_count":3},{"had_liked":false,"id":348970,"user_name":"ileruza","can_delete":false,"product_type":"c3","uid":1336951,"ip_address":"","ucode":"C3D83DF4230109","user_header":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","comment_is_top":false,"comment_ctime":1655611849,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"curl -x 127.0.0.1:32162 -I -HHost.httpbin.example.com http:&#47;&#47;httpbin.example.com&#47;status&#47;200\n\n32162换成你自己的istio-ingressgateway这个service中指向80的port","like_count":1},{"had_liked":false,"id":369996,"user_name":"Geek_1c5814","can_delete":false,"product_type":"c3","uid":3541501,"ip_address":"广东","ucode":"A1FD683A3217AE","user_header":"","comment_is_top":false,"comment_ctime":1678238465,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"请问为什么访问的不是gateway的svc ip, 而是localhost?","like_count":0},{"had_liked":false,"id":359754,"user_name":"～","can_delete":false,"product_type":"c3","uid":1494270,"ip_address":"广东","ucode":"BF9A5925C978C4","user_header":"https://static001.geekbang.org/account/avatar/00/16/cc/fe/702cf7bf.jpg","comment_is_top":false,"comment_ctime":1665839045,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师请教个问题，我反复看了几遍课程都没有理解。gw、vs、dr。这个3个配置具体是分发到istio-ingressgateway（边缘网关）、还是客户端A服务还是被请求的B服务。说说我的理解。gw分发给ingressgateway边车，vs和dr分发给客户端A服务的边车，B服务是边车不需要这些配置？不知道理解的怎么样，请老师或者各位大神解答下，谢谢了。","like_count":0},{"had_liked":false,"id":348042,"user_name":"左氧佛沙星人","can_delete":false,"product_type":"c3","uid":1195278,"ip_address":"","ucode":"0D8295E1DABA8C","user_header":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","comment_is_top":false,"comment_ctime":1654685128,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师能不能把课件搞完整啊，配置少了vs呢","like_count":0},{"had_liked":false,"id":348041,"user_name":"左氧佛沙星人","can_delete":false,"product_type":"c3","uid":1195278,"ip_address":"","ucode":"0D8295E1DABA8C","user_header":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","comment_is_top":false,"comment_ctime":1654684966,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"curl -HHost:httpbin.example.com --resolve httpbin.example.com:443:127.0.0.1 --cacert example.com.crt &quot;http:&#47;&#47;httpbin.example.com&#47;status&#47;418&quot;\ncurl: (6) Could not resolve host: httpbin.example.com\n按照课件，做tls配置，访问失败，我的是部署在集群里的，怎么测试呢？","like_count":0},{"had_liked":false,"id":341061,"user_name":"徐少文","can_delete":false,"product_type":"c3","uid":1670331,"ip_address":"","ucode":"8E35B10DA44EE3","user_header":"https://static001.geekbang.org/account/avatar/00/19/7c/bb/635a2710.jpg","comment_is_top":false,"comment_ctime":1649319510,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"老师，我按照您课上的步骤进行之后在进行curl的时候发现返回502 Bad Gateway，不知道是什么原因","like_count":0,"discussions":[{"author":{"id":1195278,"avatar":"https://static001.geekbang.org/account/avatar/00/12/3d/0e/92176eaa.jpg","nickname":"左氧佛沙星人","note":"","ucode":"0D8295E1DABA8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575841,"discussion_content":"后端不可达","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655134151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295584,"user_name":"Geek_397bc1","can_delete":false,"product_type":"c3","uid":2574736,"ip_address":"","ucode":"B400595AB958DA","user_header":"","comment_is_top":false,"comment_ctime":1622496301,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100049401,"comment_content":"14和17 本质都是一模一样的吧？只是在用SNI在ingressgateway地方选择区分了一下什么服务","like_count":0}]}