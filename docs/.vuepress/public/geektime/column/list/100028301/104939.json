{"id":104939,"title":"20 | è¶…è¶Š Web æœåŠ¡å™¨ï¼šç‰¹æƒè¿›ç¨‹å’Œå®šæ—¶ä»»åŠ¡","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº† OpenResty APIã€å…±äº«å­—å…¸ç¼“å­˜å’Œ cosocketã€‚å®ƒä»¬å®ç°çš„åŠŸèƒ½ï¼Œéƒ½è¿˜åœ¨ Nginx å’Œ Web æœåŠ¡å™¨çš„èŒƒç•´ä¹‹å†…ï¼Œç®—æ˜¯æä¾›äº†å¼€å‘æˆæœ¬æ›´ä½ã€æ›´å®¹æ˜“ç»´æŠ¤çš„ä¸€ç§å®ç°ï¼Œæä¾›äº†å¯ç¼–ç¨‹çš„ Web æœåŠ¡å™¨ã€‚</p><p>ä¸è¿‡ï¼ŒOpenRestyå¹¶ä¸æ»¡è¶³äºæ­¤ã€‚æˆ‘ä»¬ä»Šå¤©å°±æŒ‘é€‰å‡ ä¸ªï¼ŒOpenResty ä¸­è¶…è¶Š Web æœåŠ¡å™¨çš„åŠŸèƒ½æ¥ä»‹ç»ä¸€ä¸‹ã€‚å®ƒä»¬åˆ†åˆ«æ˜¯å®šæ—¶ä»»åŠ¡ã€ç‰¹æƒè¿›ç¨‹å’Œéé˜»å¡çš„ ngx.pipeã€‚</p><h2>å®šæ—¶ä»»åŠ¡</h2><p>åœ¨ OpenResty ä¸­ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™éœ€è¦åœ¨åå°å®šæœŸåœ°æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œæ¯”å¦‚åŒæ­¥æ•°æ®ã€æ¸…ç†æ—¥å¿—ç­‰ã€‚å¦‚æœè®©ä½ æ¥è®¾è®¡ï¼Œä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿæœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•ï¼Œä¾¿æ˜¯å¯¹å¤–æä¾›ä¸€ä¸ª API æ¥å£ï¼Œåœ¨æ¥å£ä¸­å®Œæˆè¿™äº›ä»»åŠ¡ï¼›ç„¶åç”¨ç³»ç»Ÿçš„ crontab å®šæ—¶è°ƒç”¨ curlï¼Œæ¥è®¿é—®è¿™ä¸ªæ¥å£ï¼Œè¿›è€Œæ›²çº¿åœ°å®ç°è¿™ä¸ªéœ€æ±‚ã€‚</p><p>ä¸è¿‡ï¼Œè¿™æ ·ä¸€æ¥ä¸ä»…ä¼šæœ‰å‰²è£‚æ„Ÿï¼Œä¹Ÿä¼šç»™è¿ç»´å¸¦æ¥æ›´é«˜çš„å¤æ‚åº¦ã€‚æ‰€ä»¥ï¼Œ OpenResty æä¾›äº† <code>ngx.timer</code> æ¥è§£å†³è¿™ç±»éœ€æ±‚ã€‚ä½ å¯ä»¥æŠŠ<code>ngx.timer</code> ï¼Œçœ‹ä½œæ˜¯ OpenResty æ¨¡æ‹Ÿçš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç”¨ä»¥è§¦å‘å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚</p><p>å…¶å®ï¼ŒOpenResty çš„å®šæ—¶ä»»åŠ¡å¯ä»¥åˆ†ä¸ºä¸‹é¢ä¸¤ç§ï¼š</p><ul>\n<li><code>ngx.timer.at</code>ï¼Œç”¨æ¥æ‰§è¡Œä¸€æ¬¡æ€§çš„å®šæ—¶ä»»åŠ¡ï¼›</li>\n<li><code>ngx.time.every</code>ï¼Œç”¨æ¥æ‰§è¡Œå›ºå®šå‘¨æœŸçš„å®šæ—¶ä»»åŠ¡ã€‚</li>\n</ul><!-- [[[read_end]]] --><p>è¿˜è®°å¾—ä¸ŠèŠ‚è¯¾æœ€åæˆ‘ç•™ä¸‹çš„æ€è€ƒé¢˜å—ï¼Ÿé—®é¢˜æ˜¯å¦‚ä½•çªç ´ <code>init_worker_by_lua</code> ä¸­ä¸èƒ½ä½¿ç”¨ cosocket çš„é™åˆ¶ï¼Œè¿™ä¸ªç­”æ¡ˆå…¶å®å°±æ˜¯ <code>ngx.timer</code>ã€‚</p><p>ä¸‹é¢è¿™æ®µä»£ç ï¼Œå°±æ˜¯å¯åŠ¨äº†ä¸€ä¸ªå»¶æ—¶ä¸º 0 çš„å®šæ—¶ä»»åŠ¡ã€‚å®ƒå¯åŠ¨äº†å›è°ƒå‡½æ•° <code>handler</code>ï¼Œå¹¶åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œç”¨ cosocket å»è®¿é—®ä¸€ä¸ªç½‘ç«™ï¼š</p><pre><code>init_worker_by_lua_block {\n        local function handler()\n            local sock = ngx.socket.tcp()\n            local ok, err = sock:connect(â€œwww.baidu.com&quot;, 80)\n        end\n\n        local ok, err = ngx.timer.at(0, handler)\n    }\n</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±ç»•è¿‡äº† cosocket åœ¨è¿™ä¸ªé˜¶æ®µä¸èƒ½ä½¿ç”¨çš„é™åˆ¶ã€‚</p><p>å†å›åˆ°è¿™éƒ¨åˆ†å¼€å¤´æ—¶æˆ‘ä»¬æåˆ°çš„çš„ç”¨æˆ·éœ€æ±‚ï¼Œ<code>ngx.timer.at</code> å¹¶æ²¡æœ‰è§£å†³å‘¨æœŸæ€§è¿è¡Œè¿™ä¸ªéœ€æ±‚ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„ä»»åŠ¡ã€‚</p><p>é‚£ä¹ˆï¼Œåˆè¯¥å¦‚ä½•åšåˆ°å‘¨æœŸæ€§è¿è¡Œå‘¢ï¼Ÿè¡¨é¢ä¸Šæ¥çœ‹ï¼ŒåŸºäº <code>ngx.timer.at</code> è¿™ä¸ªAPI çš„è¯ï¼Œä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p><ul>\n<li>ä½ å¯ä»¥åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ª while true çš„æ­»å¾ªç¯ï¼Œæ‰§è¡Œå®Œä»»åŠ¡å sleep ä¸€æ®µæ—¶é—´ï¼Œè‡ªå·±æ¥å®ç°å‘¨æœŸä»»åŠ¡ï¼›</li>\n<li>ä½ è¿˜å¯ä»¥åœ¨å›è°ƒå‡½æ•°çš„æœ€åï¼Œå†åˆ›å»ºå¦å¤–ä¸€ä¸ªæ–°çš„ timerã€‚</li>\n</ul><p>ä¸è¿‡ï¼Œåœ¨åšå‡ºé€‰æ‹©ä¹‹å‰ï¼Œæœ‰ä¸€ç‚¹æˆ‘ä»¬éœ€è¦å…ˆæ˜ç¡®ä¸‹ï¼štimer çš„æœ¬è´¨æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œè™½ç„¶è¿™ä¸ªè¯·æ±‚ä¸æ˜¯ç»ˆç«¯å‘èµ·çš„ï¼›è€Œå¯¹äºè¯·æ±‚æ¥è®²ï¼Œåœ¨å®Œæˆè‡ªå·±çš„ä»»åŠ¡åå®ƒå°±è¦é€€å‡ºï¼Œä¸èƒ½ä¸€ç›´å¸¸é©»ï¼Œå¦åˆ™å¾ˆå®¹æ˜“é€ æˆå„ç§èµ„æºçš„æ³„æ¼ã€‚</p><p>æ‰€ä»¥ï¼Œç¬¬ä¸€ç§ä½¿ç”¨ while true æ¥è‡ªè¡Œå®ç°å‘¨æœŸä»»åŠ¡çš„æ–¹æ¡ˆå¹¶ä¸é è°±ã€‚ç¬¬äºŒç§æ–¹æ¡ˆè™½ç„¶æ˜¯å¯è¡Œçš„ï¼Œä½†é€’å½’åœ°åˆ›å»º timer ï¼Œå¹¶ä¸å®¹æ˜“è®©äººç†è§£ã€‚</p><p>é‚£ä¹ˆï¼Œæ˜¯å¦æœ‰æ›´å¥½çš„æ–¹æ¡ˆå‘¢ï¼Ÿå…¶å®ï¼ŒOpenResty åé¢æ–°å¢çš„ <code>ngx.time.every</code> APIï¼Œå°±æ˜¯ä¸“é—¨ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œå‡ºç°çš„ï¼Œå®ƒæ˜¯æ›´åŠ æ¥è¿‘ crontab çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>ä½†ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼Œåœ¨å¯åŠ¨äº†ä¸€ä¸ª timer ä¹‹åï¼Œä½ å°±å†ä¹Ÿæ²¡æœ‰æœºä¼šæ¥å–æ¶ˆè¿™ä¸ªå®šæ—¶ä»»åŠ¡äº†ï¼Œæ¯•ç«Ÿ<code>ngx.timer.cancel</code> è¿˜æ˜¯ä¸€ä¸ª todo çš„åŠŸèƒ½ã€‚</p><p>è¿™æ—¶å€™ï¼Œä½ å°±ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼šå®šæ—¶ä»»åŠ¡æ˜¯åœ¨åå°è¿è¡Œçš„ï¼Œå¹¶ä¸”æ— æ³•å–æ¶ˆï¼›å¦‚æœå®šæ—¶ä»»åŠ¡çš„æ•°é‡å¾ˆå¤šï¼Œå°±å¾ˆå®¹æ˜“è€—å°½ç³»ç»Ÿèµ„æºã€‚</p><p>æ‰€ä»¥ï¼ŒOpenResty æä¾›äº† <code>lua_max_pending_timers</code> å’Œ <code>lua_max_running_timers</code> è¿™ä¸¤ä¸ªæŒ‡ä»¤ï¼Œæ¥å¯¹å…¶è¿›è¡Œé™åˆ¶ã€‚å‰è€…ä»£è¡¨ç­‰å¾…æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡çš„æœ€å¤§å€¼ï¼Œåè€…ä»£è¡¨å½“å‰æ­£åœ¨è¿è¡Œçš„å®šæ—¶ä»»åŠ¡çš„æœ€å¤§å€¼ã€‚</p><p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ Lua APIï¼Œæ¥è·å–å½“å‰ç­‰å¾…æ‰§è¡Œå’Œæ­£åœ¨æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡çš„å€¼ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªç¤ºä¾‹ï¼š</p><pre><code>content_by_lua_block {\n            ngx.timer.at(3, function() end)\n            ngx.say(ngx.timer.pending_count())\n        }\n</code></pre><p>è¿™æ®µä»£ç ä¼šæ‰“å°å‡º 1ï¼Œè¡¨ç¤ºæœ‰ 1 ä¸ªè®¡åˆ’ä»»åŠ¡æ­£åœ¨ç­‰å¾…è¢«æ‰§è¡Œã€‚</p><pre><code>content_by_lua_block {\n            ngx.timer.at(0.1, function() ngx.sleep(0.3) end)\n            ngx.sleep(0.2)\n            ngx.say(ngx.timer.running_count())\n        }\n</code></pre><p>è¿™æ®µä»£ç ä¼šæ‰“å°å‡º 1ï¼Œè¡¨ç¤ºæœ‰ 1 ä¸ªè®¡åˆ’ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ã€‚</p><h2>ç‰¹æƒè¿›ç¨‹</h2><p>æ¥ç€æ¥çœ‹ç‰¹æƒè¿›ç¨‹ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ Nginx ä¸»è¦åˆ†ä¸º master è¿›ç¨‹å’Œ worker è¿›ç¨‹ï¼Œå…¶ä¸­ï¼ŒçœŸæ­£å¤„ç†ç”¨æˆ·è¯·æ±‚çš„æ˜¯ worker è¿›ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>lua-resty-core</code> ä¸­æä¾›çš„ <code>process.type</code> API ï¼Œè·å–åˆ°è¿›ç¨‹çš„ç±»å‹ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨ <code>resty</code> è¿è¡Œä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼š</p><pre><code>$ resty -e 'local process = require &quot;ngx.process&quot;\nngx.say(&quot;process type:&quot;, process.type())'\n</code></pre><p>ä½ ä¼šçœ‹åˆ°ï¼Œå®ƒè¿”å›çš„ç»“æœä¸æ˜¯ <code>worker</code>ï¼Œ è€Œæ˜¯ <code>single</code>ã€‚è¿™æ„å‘³ <code>resty</code> å¯åŠ¨çš„ Nginx åªæœ‰ worker è¿›ç¨‹ï¼Œæ²¡æœ‰ master è¿›ç¨‹ã€‚å…¶å®ï¼Œäº‹å®ä¹Ÿæ˜¯å¦‚æ­¤ã€‚åœ¨ <code>resty</code> çš„å®ç°ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸‹é¢è¿™æ ·çš„ä¸€è¡Œé…ç½®ï¼Œ å…³é—­äº† master è¿›ç¨‹ï¼š</p><pre><code>master_process off;\n</code></pre><p>è€ŒOpenResty åœ¨ Nginx çš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå¢åŠ äº†ç‰¹æƒè¿›ç¨‹ï¼šprivileged agentã€‚ç‰¹æƒè¿›ç¨‹å¾ˆç‰¹åˆ«ï¼š</p><ul>\n<li>å®ƒä¸ç›‘å¬ä»»ä½•ç«¯å£ï¼Œè¿™å°±æ„å‘³ç€ä¸ä¼šå¯¹å¤–æä¾›ä»»ä½•æœåŠ¡ï¼›</li>\n<li>å®ƒæ‹¥æœ‰å’Œ master è¿›ç¨‹ä¸€æ ·çš„æƒé™ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ <code>root</code> ç”¨æˆ·çš„æƒé™ï¼Œè¿™å°±è®©å®ƒå¯ä»¥åšå¾ˆå¤š worker è¿›ç¨‹ä¸å¯èƒ½å®Œæˆçš„ä»»åŠ¡ï¼›</li>\n<li>ç‰¹æƒè¿›ç¨‹åªèƒ½åœ¨ <code>init_by_lua</code> ä¸Šä¸‹æ–‡ä¸­å¼€å¯ï¼›</li>\n<li>å¦å¤–ï¼Œç‰¹æƒè¿›ç¨‹åªæœ‰è¿è¡Œåœ¨ <code>init_worker_by_lua</code> ä¸Šä¸‹æ–‡ä¸­æ‰æœ‰æ„ä¹‰ï¼Œå› ä¸ºæ²¡æœ‰è¯·æ±‚è§¦å‘ï¼Œä¹Ÿå°±ä¸ä¼šèµ°åˆ°<code>content</code>ã€<code>access</code> ç­‰ä¸Šä¸‹æ–‡å»ã€‚</li>\n</ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå¼€å¯ç‰¹æƒè¿›ç¨‹çš„ç¤ºä¾‹ï¼š</p><pre><code>init_by_lua_block {\n    local process = require &quot;ngx.process&quot;\n\n    local ok, err = process.enable_privileged_agent()\n    if not ok then\n        ngx.log(ngx.ERR, &quot;enables privileged agent failed error:&quot;, err)\n    end\n}\n</code></pre><p>é€šè¿‡è¿™æ®µä»£ç å¼€å¯ç‰¹æƒè¿›ç¨‹åï¼Œå†å»å¯åŠ¨ OpenResty æœåŠ¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼ŒNginx çš„è¿›ç¨‹ä¸­å¤šäº†ç‰¹æƒè¿›ç¨‹çš„èº«å½±ï¼š</p><pre><code>nginx: master process\nnginx: worker process\nnginx: privileged agent process\n</code></pre><p>ä¸è¿‡ï¼Œå¦‚æœç‰¹æƒåªåœ¨ <code>init_worker_by_lua</code> é˜¶æ®µè¿è¡Œä¸€æ¬¡ï¼Œæ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆæ¥è§¦å‘ç‰¹æƒè¿›ç¨‹å‘¢ï¼Ÿ</p><p>æ²¡é”™ï¼Œç­”æ¡ˆå°±è—åœ¨åˆšåˆšè®²è¿‡çš„çŸ¥è¯†é‡Œã€‚æ—¢ç„¶å®ƒä¸ç›‘å¬ç«¯å£ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è¢«ç»ˆç«¯è¯·æ±‚è§¦å‘ï¼Œé‚£å°±åªæœ‰ä½¿ç”¨æˆ‘ä»¬åˆšæ‰ä»‹ç»çš„ <code>ngx.timer</code> ï¼Œæ¥å‘¨æœŸæ€§åœ°è§¦å‘äº†ï¼š</p><pre><code>init_worker_by_lua_block {\n    local process = require &quot;ngx.process&quot;\n\n    local function reload(premature)\n        local f, err = io.open(ngx.config.prefix() .. &quot;/logs/nginx.pid&quot;, &quot;r&quot;)\n        if not f then\n            return\n        end\n        local pid = f:read()\n        f:close()\n        os.execute(&quot;kill -HUP &quot; .. pid)\n    end\n\n    if process.type() == &quot;privileged agent&quot; then\n         local ok, err = ngx.timer.every(5, reload)\n        if not ok then\n            ngx.log(ngx.ERR, err)\n        end\n    end\n}\n</code></pre><p>ä¸Šé¢è¿™æ®µä»£ç ï¼Œå®ç°äº†æ¯ 5 ç§’ç»™ master è¿›ç¨‹å‘é€ HUP ä¿¡å·é‡çš„åŠŸèƒ½ã€‚è‡ªç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šå®ç°æ›´å¤šæœ‰è¶£çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è½®è¯¢æ•°æ®åº“ï¼Œçœ‹æ˜¯å¦æœ‰ç‰¹æƒè¿›ç¨‹çš„ä»»åŠ¡å¹¶æ‰§è¡Œã€‚å› ä¸ºç‰¹æƒè¿›ç¨‹æ˜¯ root æƒé™ï¼Œè¿™æ˜¾ç„¶å°±æœ‰ç‚¹å„¿â€œåé—¨â€ç¨‹åºçš„æ„å‘³äº†ã€‚</p><h2>éé˜»å¡çš„ ngx.pipe</h2><p>æœ€åæˆ‘ä»¬æ¥çœ‹éé˜»å¡çš„ ngx.pipeã€‚åˆšåˆšè®²è¿‡çš„è¿™ä¸ªä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Lua çš„æ ‡å‡†åº“ï¼Œæ¥æ‰§è¡Œå¤–éƒ¨å‘½ä»¤è¡Œï¼ŒæŠŠä¿¡å·å‘é€ç»™äº† master è¿›ç¨‹ï¼š</p><pre><code>os.execute(&quot;kill -HUP &quot; .. pid) \n</code></pre><p>è¿™ç§æ“ä½œè‡ªç„¶æ˜¯ä¼šé˜»å¡çš„ã€‚é‚£ä¹ˆï¼Œåœ¨ OpenResty ä¸­ï¼Œæ˜¯å¦æœ‰éé˜»å¡çš„æ–¹æ³•æ¥è°ƒç”¨å¤–éƒ¨ç¨‹åºå‘¢ï¼Ÿæ¯•ç«Ÿï¼Œè¦çŸ¥é“ï¼Œå¦‚æœä½ æ˜¯æŠŠ OpenResty å½“åšä¸€ä¸ªå®Œæ•´çš„å¼€å‘å¹³å°ï¼Œè€Œé Web æœåŠ¡å™¨æ¥ä½¿ç”¨çš„è¯ï¼Œè¿™å°±æ˜¯ä½ çš„åˆšéœ€äº†ã€‚</p><p>ä¸ºæ­¤ï¼Œ<code>lua-resty-shell</code> åº“åº”è¿è€Œç”Ÿï¼Œä½¿ç”¨å®ƒæ¥è°ƒç”¨å‘½ä»¤è¡Œå°±æ˜¯éé˜»å¡çš„ï¼š</p><pre><code>$ resty -e 'local shell = require &quot;resty.shell&quot;\nlocal ok, stdout, stderr, reason, status =\n    shell.run([[echo &quot;hello, world&quot;]])\n    ngx.say(stdout)\n</code></pre><p>è¿™æ®µä»£ç å¯ä»¥ç®—æ˜¯ hello world çš„å¦å¤–ä¸€ç§å†™æ³•äº†ï¼Œå®ƒè°ƒç”¨ç³»ç»Ÿçš„ <code>echo</code> å‘½ä»¤æ¥å®Œæˆè¾“å‡ºã€‚ç±»ä¼¼çš„ï¼Œä½ å¯ä»¥ç”¨ <code>resty.shell</code> ï¼Œæ¥æ›¿ä»£ Lua ä¸­çš„ <code>os.execute</code> è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<code>lua-resty-shell</code> çš„åº•å±‚å®ç°ï¼Œä¾èµ–äº† <code>lua-resty-core</code> ä¸­çš„ [<a href=\"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/pipe.md\">ngx.pipe</a>] APIï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªä½¿ç”¨ <code>lua-resty-shell</code> æ‰“å°å‡º <code>hello wrold</code> çš„ç¤ºä¾‹ï¼Œæ”¹ç”¨ <code>ngx.pipe</code> ï¼Œå¯ä»¥å†™æˆä¸‹é¢è¿™æ ·ï¼š</p><pre><code>$ resty -e 'local ngx_pipe = require &quot;ngx.pipe&quot;\nlocal proc = ngx_pipe.spawn({&quot;echo&quot;, &quot;hello world&quot;})\nlocal data, err = proc:stdout_read_line()\nngx.say(data)'\n</code></pre><p>è¿™å…¶å®ä¹Ÿå°±æ˜¯ <code>lua-resty-shell</code> åº•å±‚çš„å®ç°ä»£ç äº†ã€‚ä½ å¯ä»¥å»æŸ¥çœ‹ <code>ngx.pipe</code> çš„æ–‡æ¡£å’Œæµ‹è¯•æ¡ˆä¾‹ï¼Œæ¥è·å–æ›´å¤šçš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>åˆ°æ­¤ï¼Œä»Šå¤©çš„ä¸»è¦å†…å®¹æˆ‘å°±è®²å®Œäº†ã€‚ä»ä¸Šé¢çš„å‡ ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒOpenResty åœ¨åšä¸€ä¸ªæ›´å¥½ç”¨çš„ Nginx çš„å‰æä¸‹ï¼Œä¹Ÿåœ¨å°è¯•å¾€é€šç”¨å¹³å°çš„æ–¹å‘ä¸Šé æ‹¢ï¼Œå¸Œæœ›å¼€å‘è€…èƒ½å¤Ÿå°½é‡ç»Ÿä¸€æŠ€æœ¯æ ˆï¼Œéƒ½ç”¨ OpenResty æ¥è§£å†³å¼€å‘éœ€æ±‚ã€‚è¿™å¯¹äºè¿ç»´æ¥è¯´æ˜¯ç›¸å½“å‹å¥½çš„ï¼Œå› ä¸ºåªè¦éƒ¨ç½²ä¸€ä¸ª OpenResty å°±å¯ä»¥äº†ï¼Œç»´æŠ¤æˆæœ¬æ›´ä½ã€‚</p><p>æœ€åï¼Œç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ã€‚ç”±äºå¯èƒ½ä¼šå­˜åœ¨å¤šä¸ª Nginx workerï¼Œé‚£ä¹ˆ timer å°±ä¼šåœ¨æ¯ä¸ª worker ä¸­éƒ½è¿è¡Œä¸€æ¬¡ï¼Œè¿™åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹éƒ½æ˜¯ä¸èƒ½æ¥å—çš„ã€‚æˆ‘ä»¬åº”è¯¥å¦‚ä½•ä¿è¯ timer åªèƒ½è¿è¡Œä¸€æ¬¡å‘¢ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€è¯´è¯´ä½ çš„è§£å†³æ–¹æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":113487,"user_name":"wusiration","can_delete":false,"product_type":"c1","uid":1104438,"ip_address":"","ucode":"A9403377054F1E","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg","comment_is_top":false,"comment_ctime":1563029276,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10152963868","product_id":100028301,"comment_content":"é€šè¿‡shared dictåˆ¤æ–­äº’æ–¥ï¼Œå­˜åœ¨æ­£åœ¨æ‰§è¡Œä¸­çš„timerè¿˜æ²¡æ›´æ–°æ‰§è¡ŒçŠ¶æ€ï¼Œå¦ä¸€ä¸ªworkerç»§ç»­å»æ‰§è¡Œï¼›<br>é€šè¿‡åˆ¤æ–­workerçš„idæŒ‡å®šæŸä¸ªworkeræ‰§è¡Œçš„æ–¹å¼åº”è¯¥å¯ä»¥å®ç°è¿™ä¸€éœ€æ±‚","like_count":3},{"had_liked":false,"id":113507,"user_name":"Seven","can_delete":false,"product_type":"c1","uid":1002276,"ip_address":"","ucode":"7527C875C8A938","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4b/24/8c9eaf7f.jpg","comment_is_top":false,"comment_ctime":1563038377,"is_pvip":false,"replies":[{"id":"41592","content":"while True çš„å¾ªç¯å—ï¼Ÿæˆ‘çš„å»ºè®®æ˜¯è·‘ä¸€æ®µæ—¶é—´ï¼Œæ¯”å¦‚ 5 åˆ†é’Ÿï¼Œå°±é€€æ‰ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563239217,"ip_address":"","comment_id":113507,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5858005673","product_id":100028301,"comment_content":"æˆ‘æƒ³åœ¨init_worker_by_luaé˜¶æ®µé€šè¿‡timerå¯åŠ¨ä¸€ä¸ªwebsocketå®¢æˆ·ç«¯ä¸€ç›´å¾ªç¯æ”¶å‘æ•°æ®ä¼šä¸ä¼šæœ‰é—®é¢˜å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458253,"discussion_content":"while True çš„å¾ªç¯å—ï¼Ÿæˆ‘çš„å»ºè®®æ˜¯è·‘ä¸€æ®µæ—¶é—´ï¼Œæ¯”å¦‚ 5 åˆ†é’Ÿï¼Œå°±é€€æ‰ï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563239217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112367,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1562724198,"is_pvip":false,"replies":[{"id":"40929","content":"ç‰¹æƒè¿›ç¨‹å’Œmaster è¿›ç¨‹çš„æƒé™ä¸€æ ·ï¼Œå¦‚æœ master æ˜¯æ™®é€šç”¨æˆ·ï¼Œé‚£ç‰¹æƒè¿›ç¨‹ä¹Ÿä¸å¯èƒ½æ‹¿åˆ° root æƒé™ã€‚<br>ä¸€èˆ¬ç”¨ç‰¹æƒè¿›ç¨‹æ¥æ¸…ç†æ—¥å¿—ã€é‡å¯ OpenResty è‡ªèº«ç­‰éœ€è¦é«˜æƒé™çš„ä»»åŠ¡ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562746579,"ip_address":"","comment_id":112367,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5857691494","product_id":100028301,"comment_content":"æƒ³è¯·é—®ä¸‹ç‰¹æƒè¿›ç¨‹æ˜¯æ€ä¹ˆå›äº‹ï¼Œå¯åŠ¨oræœ¬èº«å°±æ˜¯æ™®é€šç”¨æˆ·ã€‚å¦‚ä½•è·å–rootæƒé™å‘¢ï¼Œå¦å¤–ç‰¹æƒè¿›ç¨‹çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›å¯ä»¥ä»‹ç»ä¸‹å—","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457702,"discussion_content":"ç‰¹æƒè¿›ç¨‹å’Œmaster è¿›ç¨‹çš„æƒé™ä¸€æ ·ï¼Œå¦‚æœ master æ˜¯æ™®é€šç”¨æˆ·ï¼Œé‚£ç‰¹æƒè¿›ç¨‹ä¹Ÿä¸å¯èƒ½æ‹¿åˆ° root æƒé™ã€‚\nä¸€èˆ¬ç”¨ç‰¹æƒè¿›ç¨‹æ¥æ¸…ç†æ—¥å¿—ã€é‡å¯ OpenResty è‡ªèº«ç­‰éœ€è¦é«˜æƒé™çš„ä»»åŠ¡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562746579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112296,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1562717603,"is_pvip":false,"replies":[{"id":"40852","content":"æ˜¯çš„ï¼Œæ²¡é”™","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562722791,"ip_address":"","comment_id":112296,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5857684899","product_id":100028301,"comment_content":"å¯ä»¥é€šè¿‡æŸ¥çœ‹worker idï¼Œåœ¨æŒ‡å®šworkerä¸‹æ‰§è¡Œ","like_count":2,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457665,"discussion_content":"æ˜¯çš„ï¼Œæ²¡é”™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562722791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1653,"discussion_content":"å…·ä½“æ€ä¹ˆå®ç°ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562768016,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":238217,"user_name":"è¿‡åƒå¸†","can_delete":false,"product_type":"c1","uid":1183100,"ip_address":"","ucode":"D12DB39C7E8B66","user_header":"https://static001.geekbang.org/account/avatar/00/12/0d/7c/6f96fca0.jpg","comment_is_top":false,"comment_ctime":1596096786,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596096786","product_id":100028301,"comment_content":"timerï¼Œè¿è¡Œç¯å¢ƒï¼Œæ€ä¹ˆå¯åŠ¨çš„ï¼Œä¸ºä»€ä¹ˆä¼šæ¯ä¸ªworkerä¸­è¿è¡Œï¼Ÿ","like_count":0},{"had_liked":false,"id":135705,"user_name":"æ—ºæ—º","can_delete":false,"product_type":"c1","uid":1159196,"ip_address":"","ucode":"FE2CF90F446BFB","user_header":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","comment_is_top":false,"comment_ctime":1569243573,"is_pvip":false,"replies":[{"id":"52538","content":"æ˜¯å¯ä»¥æ··ç”¨çš„ï¼Œå®ƒä»¬ä¹‹é—´ä¸ä¼šäº’ç›¸å½±å“çš„ã€‚å¦‚æœä½ ç¡®å®šè¿™é‡Œæœ‰bugï¼Œå¯ä»¥æ•´ç†ä¸€ä¸ªæœ€å°çš„å¤ç°ä»£ç ï¼Œç»™ OpenResty æäº¤ issue","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@APISIX","uid":"1017955","ctime":1569576084,"ip_address":"","comment_id":135705,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1569243573","product_id":100028301,"comment_content":"è€å¸ˆï¼Œåœ¨init_worker_by_lua_blocké‡Œ<br>local ok, err = ngx.timer.every(30, reset_server_list)<br>ok, err = ngx.timer.at(0, reget_ssl_certificate)<br>ok, err = ngx.timer.every(3600, reget_ssl_certificate)<br>å†™äº†ä¸‰ä¸ªå®šæ—¶å™¨ï¼Œæ€ä¹ˆæ‰§è¡Œçš„æ•ˆæœä¸æ˜¯æƒ³è±¡ä¸­é‚£æ ·å‘¢ï¼Ÿ<br>æœ¬æ¥æ˜¯æƒ³ç€ä¸€å¼€å§‹çš„æ—¶å€™å°±æ‰§è¡Œä¸€æ¬¡reget_ssl_certificateï¼Œç„¶åæ¯éš”1ä¸ªå°æ—¶å†æ‰§è¡Œä¸€æ¬¡reget_ssl_certificateçš„ã€‚<br>ç°åœ¨å°±ç®—è¿‡äº†30ç§’reset_server_listä¹Ÿä¸æ‰§è¡Œã€‚<br>å¦‚æœåªå†™ä¸€ä¸ªâ€œlocal ok, err = ngx.timer.every(30, reset_server_list)â€æ˜¯å¯ä»¥çš„ã€‚<br>æ„æ€æ˜¯ngx.timer.everyå’Œngx.timer.atä¸èƒ½åŒæ—¶æ··ç”¨å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468309,"discussion_content":"æ˜¯å¯ä»¥æ··ç”¨çš„ï¼Œå®ƒä»¬ä¹‹é—´ä¸ä¼šäº’ç›¸å½±å“çš„ã€‚å¦‚æœä½ ç¡®å®šè¿™é‡Œæœ‰bugï¼Œå¯ä»¥æ•´ç†ä¸€ä¸ªæœ€å°çš„å¤ç°ä»£ç ï¼Œç»™ OpenResty æäº¤ issue","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569576084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1159196,"avatar":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","nickname":"æ—ºæ—º","note":"","ucode":"FE2CF90F446BFB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":192876,"discussion_content":"å¦‚è€å¸ˆæ‰€è¯´ï¼Œç¡®å®æ˜¯å¯ä»¥æ··ç”¨çš„ã€‚æ˜¯æˆ‘å†™çš„ç¨‹åºæœ‰bugã€‚å› ä¸ºæˆ‘çš„reget_ssl_certificateå’Œreset_server_listé‡Œé¢ï¼Œéƒ½ä»æ–°reloadäº†nginxï¼Œå¯¼è‡´ngx.timer.atä¸åœè¢«è§¦å‘ï¼Œngx.timer.everyå¯èƒ½è¿˜æ²¡åˆ°è§¦å‘æ—¶é—´ç‚¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583108585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":134289,"user_name":"æ—ºæ—º","can_delete":false,"product_type":"c1","uid":1159196,"ip_address":"","ucode":"FE2CF90F446BFB","user_header":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","comment_is_top":false,"comment_ctime":1568796058,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568796058","product_id":100028301,"comment_content":"å‘ç°åœ¨init_by_lua_blocké‡Œé¢å¼€äº†ç‰¹æƒè¿›ç¨‹åï¼Œå¦‚æœinit_worker_by_lua_blockåˆæœ‰io.openåˆ›å»ºæ–‡ä»¶æ“ä½œï¼Œé‚£ä¹ˆåé¢åœ¨workerè¿›ç¨‹é‡Œé¢ç¬¬ä¸€æ¬¡åˆ›å»ºæ–‡ä»¶æ—¶çš„ç”¨æˆ·ä¹Ÿæ˜¯rootäº†ï¼Œç„¶ååé¢workeré‡Œé¢å†™æ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šæŠ¥:<br>failed to open file in append mode. error message: &#47;tmp&#47;wscmd_response.log: Permission denied,<br>å› ä¸º&#47;tmp&#47;wscmd_response.logä¸€å¼€å§‹æ˜¯ç”¨rootèº«ä»½åˆ›å»ºçš„ï¼Œåé¢å†ç”¨nobodyå»å†™çš„æ—¶å€™ï¼Œå°±ä¼šæŠ¥é”™ã€‚","like_count":0},{"had_liked":false,"id":133867,"user_name":"ææ€ªè€…ğŸ˜˜ ğŸ˜’ ğŸ˜ ğŸ‘¿","can_delete":false,"product_type":"c1","uid":1300678,"ip_address":"","ucode":"40DFF5D3E3B24C","user_header":"https://static001.geekbang.org/account/avatar/00/13/d8/c6/2b2a58cf.jpg","comment_is_top":false,"comment_ctime":1568686538,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1568686538","product_id":100028301,"comment_content":"è¿™ä¸ªå®šæ—¶å™¨è·Ÿç”¨curlæ˜¯ä¸€æ ·çš„å˜›ï¼Œæ€ä¹ˆå®ç°æ¯«ç§’çº§å®šæ—¶ï¼Œå¦‚æœåœ¨å‹åŠ›å¾ˆå¤§çš„ç¯å¢ƒä¸‹ï¼Œè¿™æ ·çš„å®šæ—¶å™¨ä¸å°±ä¼šæ¶ˆè€—ç«¯å£èµ„æºå—","like_count":0,"discussions":[{"author":{"id":1370959,"avatar":"https://static001.geekbang.org/account/avatar/00/14/eb/4f/6a97b1cd.jpg","nickname":"çŒªå°æ“","note":"","ucode":"D9552746AE3327","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":560210,"discussion_content":"crontabè¿ç§’ç§’çº§éƒ½æ²¡æœ‰ï¼Œæœ€å°ç²’åº¦æ˜¯åˆ†é’Ÿã€‚æœ‰ä»€ä¹ˆæ ·çš„ä¸šåŠ¡éœ€è¦æ¯«ç±³çº§å®šæ—¶å™¨ï¼Ÿä½ ç¡®å®šä½ åšçš„äº‹ä¸€æ¯«ç§’å†…èƒ½åšå®Œå—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649229200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129211,"user_name":"æ—ºæ—º","can_delete":false,"product_type":"c1","uid":1159196,"ip_address":"","ucode":"FE2CF90F446BFB","user_header":"https://static001.geekbang.org/account/avatar/00/11/b0/1c/2e30eeb8.jpg","comment_is_top":false,"comment_ctime":1567063239,"is_pvip":false,"replies":[{"id":"49067","content":"ç£ç›˜ IO æ²¡æœ‰ä»€ä¹ˆä¼˜åŒ–çš„æ–¹æ³•ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä½¿ç”¨ nginx threads pool æ¥æ¨¡æ‹Ÿå®ç° &quot;éé˜»å¡&quot;çš„æ–¹æ¡ˆï¼šhttps:&#47;&#47;github.com&#47;tokers&#47;lua-io-nginx-moduleï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567586786,"ip_address":"","comment_id":129211,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1567063239","product_id":100028301,"comment_content":"        local f, err = io.open(ngx.config.prefix() .. &quot;&#47;logs&#47;nginx.pid&quot;, &quot;r&quot;)<br>è€å¸ˆï¼Œè¿™ä¸ªä»£ç ä¹Ÿæ˜¯Lua çš„æ ‡å‡†åº“ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ˜¯é˜»å¡çš„ï¼Œåˆæ”¹é‡‡ç”¨ä»€ä¹ˆæ–¹å¼ä¼˜åŒ–å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465335,"discussion_content":"ç£ç›˜ IO æ²¡æœ‰ä»€ä¹ˆä¼˜åŒ–çš„æ–¹æ³•ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä½¿ç”¨ nginx threads pool æ¥æ¨¡æ‹Ÿå®ç° &amp;quot;éé˜»å¡&amp;quot;çš„æ–¹æ¡ˆï¼šhttps://github.com/tokers/lua-io-nginx-moduleï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567586786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":116465,"user_name":"è‹±é›„","can_delete":false,"product_type":"c1","uid":1546612,"ip_address":"","ucode":"D1033C83C6CDE9","user_header":"https://static001.geekbang.org/account/avatar/00/17/99/74/0203bf17.jpg","comment_is_top":false,"comment_ctime":1563853271,"is_pvip":false,"replies":[{"id":"42837","content":"å¯ä»¥ while trueï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé˜ˆå€¼ï¼Œæ¯”å¦‚å¾ªç¯ 1000 æ¬¡ä¹‹åé€€å‡ºå¾ªç¯ï¼Œé‡æ–°æ¥ä¸€æ¬¡ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563973798,"ip_address":"","comment_id":116465,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563853271","product_id":100028301,"comment_content":"å¦‚æœä¸èƒ½while true ï¼Œé‚£websocketå¦‚ä½•ç­‰å¾…è¯·æ±‚å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":459555,"discussion_content":"å¯ä»¥ while trueï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé˜ˆå€¼ï¼Œæ¯”å¦‚å¾ªç¯ 1000 æ¬¡ä¹‹åé€€å‡ºå¾ªç¯ï¼Œé‡æ–°æ¥ä¸€æ¬¡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563973798,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113630,"user_name":"HelloBug","can_delete":false,"product_type":"c1","uid":1249598,"ip_address":"","ucode":"E61A4AD5C2F724","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg","comment_is_top":false,"comment_ctime":1563098490,"is_pvip":true,"replies":[{"id":"41589","content":"æ³„æ¼è¿™ä¸ªè¯å¯èƒ½ä¸å¤ªæ°å½“ï¼Œå°±æ˜¯ä¼šå¯¼è‡´å¾ˆå¤š Lua æˆ–è€… C å¯¹è±¡æ— æ³•å¾—åˆ°é‡Šæ”¾ï¼Œé•¿æœŸè¿è¡Œä¼šæœ‰å¾ˆå¤šç¢ç‰‡ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563238794,"ip_address":"","comment_id":113630,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563098490","product_id":100028301,"comment_content":"è€å¸ˆå¥½ï¼Œåœ¨è®²ngx.timerçš„æ—¶å€™ï¼Œè¯´å¦‚æœåœ¨å›è°ƒå‡½æ•°é‡Œä½¿ç”¨while true+sleepçš„æ–¹å¼å¾ªç¯æ‰§è¡Œä»»åŠ¡ï¼Œå› ä¸ºtimeræœ¬è´¨æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œä¸Šé¢æ‰€è¯´çš„å®ç°ä¼šå¯¼è‡´è¿™ä¸ªè¯·æ±‚å¸¸é©»ï¼Œè¿™äº›éƒ½æ˜¯å¯ä»¥ç†è§£çš„ï¼Œåé¢è¯´ä¼šå¯¼è‡´èµ„æºçš„æ³„éœ²ï¼Œè¿™ä¸ªæ€ä¹ˆç†è§£å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458317,"discussion_content":"æ³„æ¼è¿™ä¸ªè¯å¯èƒ½ä¸å¤ªæ°å½“ï¼Œå°±æ˜¯ä¼šå¯¼è‡´å¾ˆå¤š Lua æˆ–è€… C å¯¹è±¡æ— æ³•å¾—åˆ°é‡Šæ”¾ï¼Œé•¿æœŸè¿è¡Œä¼šæœ‰å¾ˆå¤šç¢ç‰‡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563238794,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113566,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1563080448,"is_pvip":false,"replies":[{"id":"41591","content":"ngx.timer çš„æ–‡æ¡£æ˜¯æœ‰æåˆ°å®ƒçš„ä½œç”¨çš„ï¼š<br>the premature argument takes a boolean value indicating whether it is a premature timer expiration or not.<br>Premature timer expiration happens when the Nginx worker process is trying to shut down, as in an Nginx configuration reload triggered by the HUP signal or in an Nginx server shutdown. When the Nginx worker is trying to shut down, one can no longer call ngx.timer.at to create new timers with nonzero delays and in that case ngx.timer.at will return a &quot;conditional false&quot; value and a string describing the error, that is, &quot;process exiting&quot;.<br>ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨ Nginx é‡å¯åè€…å…³é—­çš„æ—¶å€™ï¼Œå°±ä¸è¦å†å»åˆ›å»º timer äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1563239142,"ip_address":"","comment_id":113566,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563080448","product_id":100028301,"comment_content":"local function reload(premature)ï¼Œè€å¸ˆï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°prematureæ˜¯ä»€ä¹ˆæ„æ€ï¼Œåœ¨è¿™æ®µä»£ç ä¸­æœ‰ä»€ä¹ˆç”¨å‘¢","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458282,"discussion_content":"ngx.timer çš„æ–‡æ¡£æ˜¯æœ‰æåˆ°å®ƒçš„ä½œç”¨çš„ï¼š\nthe premature argument takes a boolean value indicating whether it is a premature timer expiration or not.\nPremature timer expiration happens when the Nginx worker process is trying to shut down, as in an Nginx configuration reload triggered by the HUP signal or in an Nginx server shutdown. When the Nginx worker is trying to shut down, one can no longer call ngx.timer.at to create new timers with nonzero delays and in that case ngx.timer.at will return a &amp;quot;conditional false&amp;quot; value and a string describing the error, that is, &amp;quot;process exiting&amp;quot;.\nç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨ Nginx é‡å¯åè€…å…³é—­çš„æ—¶å€™ï¼Œå°±ä¸è¦å†å»åˆ›å»º timer äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563239142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112681,"user_name":"Rye","can_delete":false,"product_type":"c1","uid":1175100,"ip_address":"","ucode":"5BDC40ED641A6C","user_header":"https://static001.geekbang.org/account/avatar/00/11/ee/3c/a2b67971.jpg","comment_is_top":false,"comment_ctime":1562806325,"is_pvip":false,"replies":[{"id":"41177","content":"æ˜¯çš„ï¼Œæ²¡é”™","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1562904624,"ip_address":"","comment_id":112681,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562806325","product_id":100028301,"comment_content":"ngx.worker.id() == 0 åº”è¯¥æ˜¯ç¬¬ä¸€ä¸ªworker","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457854,"discussion_content":"æ˜¯çš„ï¼Œæ²¡é”™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562904624,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112389,"user_name":"chundonglinlin","can_delete":false,"product_type":"c1","uid":1545472,"ip_address":"","ucode":"AE4B66E4DE2AC9","user_header":"https://static001.geekbang.org/account/avatar/00/17/95/00/087d9e46.jpg","comment_is_top":false,"comment_ctime":1562727713,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562727713","product_id":100028301,"comment_content":"worker slot","like_count":0},{"had_liked":false,"id":112339,"user_name":"æ˜Ÿäº¦è¾°","can_delete":false,"product_type":"c1","uid":1284592,"ip_address":"","ucode":"B0388FBFFDEE7E","user_header":"https://static001.geekbang.org/account/avatar/00/13/99/f0/d9343049.jpg","comment_is_top":false,"comment_ctime":1562722017,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1562722017","product_id":100028301,"comment_content":"share dictå­˜å–æ‰§è¡ŒçŠ¶æ€ï¼Œå°±å¯ä»¥å®Œæˆäº’æ–¥äº† ","like_count":0}]}