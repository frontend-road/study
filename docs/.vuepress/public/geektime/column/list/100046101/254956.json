{"id":254956,"title":"加餐 | TCC如何实现指令执行的原子性？","content":"<p>你好，我是韩健。</p><p>在上一讲我提到，虽然MySQL XA能实现数据层的分布式事务，解决多个MySQL操作的事务问题，但我现在负责的这套业务系统还面临别的问题：在接收到外部的指令后，我需要访问多个内部系统，执行指令约定的操作，而且，还必须保证指令执行的原子性（也就是事务要么全部成功，要么全部失败）。</p><p>那么我是如何实现指令执行的原子性呢？答案是TCC。</p><p>在我看来，上一讲中，基于二阶段提交协议的XA规范，实现的是数据层面操作的事务，而TCC能实现业务层面操作的事务。</p><p>对你来说，理解了二阶段提交协议和TCC后，你可以从数据层面到业务层面，更加全面理解如何实现分布式事务了，这样一来，当你在日常工作中，需要实现操作的原子性或者系统状态的一致性时，就知道该如何处理了。</p><p>那么为了帮助你更好地理解TCC，咱们还是先来看一道思考题。</p><p>我以如何实现订票系统为例，假设现在要实现一个企鹅订票系统，给内部员工提供机票订购服务，但在实现订票系统时，我们需要考虑这样的情况：</p><p>我想从深圳飞北京，但这时没有直达的机票，要先定深圳航空的航班，从深圳去上海，然后再定上海航空的航班，从上海去北京。</p><p>因为我的目的地是北京，所以如果只有一张机票订购成功，肯定是不行的，这个系统必须保障2个订票操作的事务要么全部成功，要么全部不成功。那么该如何实现2个订票操作的事务呢？</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/7c/3b/7ca6e1def38b2ba6873711d8f283dc3b.jpg?wh=1142*418\" alt=\"\"></p><p>带着这个问题，我们进入今天的学习，先来了解一下什么是TCC。</p><h2>什么是TCC？</h2><p>在<a href=\"https://time.geekbang.org/column/article/200717\">04讲</a>，我们介绍了TCC，你如果对TCC不熟悉，或者忘记了，那么可以回过头复习一下。在这里，我只想补充一点，那就是：你可以对比二阶段提交协议来理解，TCC包含的预留、确认或撤销这 2 个阶段，比如：</p><ul>\n<li>\n<p>Try是指预留，它和二阶段提交协议中，提交请求阶段的操作类似，具体来说就是，系统会将需要确认的资源预留、锁定，确保确认操作一定能执行成功。</p>\n</li>\n<li>\n<p>Confirm是指确认，它呢和二阶段提交协议中，提交执行阶段的操作类似，具体是指，系统将最终执行的操作。</p>\n</li>\n<li>\n<p>Cancel是指撤销，比较像二阶段提交协议中的回滚操作，具体指系统将撤销之前预留的资源，也就是撤销已执行的预留操作对系统产生的影响。</p>\n</li>\n</ul><p>在我看来，二阶段提交协议和TCC的目标，都是为了实现分布式事务，这也就决定了它们“英雄所见略同”，在思想上是类似的，但我再次强调一下，这两个算法解决的问题场景是不同的，一个是数据层面，一个是业务层面，这就决定了它们在细节实现是不同的。所以接下来，我们就一起看看TCC的细节。</p><p>为了更好地演示TCC的原理，我们假设深圳航空、上海航空分别为订票系统提供了以下3个接口：机票预留接口、确认接口和撤销接口。</p><p>那么这时，订票系统可以这样来实现操作的事务：</p><p>首先，订票系统调用2个航空公司的机票预留接口，向2个航空公司申请机票预留。</p><p><img src=\"https://static001.geekbang.org/resource/image/e1/74/e149ed696a360b1761c6571a2a96d374.jpg?wh=1142*763\" alt=\"\"></p><p>如果两个机票都预留成功，那么订票系统将执行确认操作，也就是订购机票。</p><p><img src=\"https://static001.geekbang.org/resource/image/8e/3e/8ea845eeb2032e7af2876ace81605a3e.jpg?wh=1142*760\" alt=\"\"></p><p>但如果此时有机票没有预留成功（比如深圳航空的从深圳到上海的机票），那这时该怎么办呢？这时订票系统就需要通过撤销接口来撤销订票请求。</p><p><img src=\"https://static001.geekbang.org/resource/image/52/c0/52f65a9202f3619dfeac1ba0e2acf8c0.jpg?wh=1142*750\" alt=\"\"></p><p>你看这样，我们就实现了订票操作的事务了。TCC是不是也很容易理解呢？答案是肯定的，那它难在哪儿呢？</p><p>在我看来，TCC的难点不在于理解TCC的原理，而在于如何根据实际场景特点来实现预留、确认、撤销三个操作。所以，为帮助你更深刻的理解TCC三操作的实现要点，我将以一个实际项目具体说一说。</p><h2>如何通过TCC指令执行的原子性？</h2><p>我在一开始提到，当我接收到外部指令时，需要实现操作1、2、3，其中任何一个操作失败，我都需要暂停指令执行，将系统恢复到操作未执行状态，然后再重试。</p><p><img src=\"https://static001.geekbang.org/resource/image/ea/07/eab5cfdf9a5d622f29ced94a4790c207.jpg?wh=1142*671\" alt=\"\"></p><p>其中，操作1、2、3的含义具体如下。</p><ul>\n<li>操作1：生成指定URL页面对应的图片，并持久化存储。</li>\n<li>操作2：调用内部系统1的接口，禁用指定域名的访问权限。</li>\n<li>操作3：通过MySQL XA更新多个数据库的数据记录。</li>\n</ul><p>那么我是如何使用TCC来解决这个问题的呢？答案是我在实现每个操作时，都会分别实现相应的预留、确认、撤销三操作。</p><p>首先，因为操作1是生成指定URL页面对应的图片，我是这么实现TCC三操作的。</p><ul>\n<li>预留操作：生成指定页面的图片，并存储到本地。</li>\n<li>确认操作：更新操作1状态为完成。</li>\n<li>撤销操作：删除本地存储的图片。</li>\n</ul><p>其次，因为操作2是调用内部系统1的接口，禁用该域名的访问权限，那么，我是这么实现TCC三操作的。</p><ul>\n<li>预留操作：调用的内部系统1的禁用指定域名的预留接口。这时我们先通知系统1预留相关的资源。</li>\n<li>确认操作：调用的内部系统1的禁用指定域名的确认接口。我们执行禁用域名的操作，这时，禁用域名的操作的生效了。</li>\n<li>撤销操作：调用的内部系统1的禁用指定域名的撤销接口。我们撤销对该域名的禁用，并通知内部系统1释放相关的预留资源。</li>\n</ul><p>最后，操作3是通过MySQL XA更改多个MySQL数据库中的数据记录，并实现数据更新的事务。我是这么实现TCC三操作的：</p><ul>\n<li>预留操作：执行XA START和XA END准备好事务分支操作，并调用XA PREPARE，执行二阶段提交协议的提交请求阶段，预留相关资源。</li>\n<li>确认操作：调用XA COMMIT执行确认操作。</li>\n<li>撤销操作：调用XA ROLLBACK执行回滚操作，释放在Try阶段预留的资源。</li>\n</ul><p>在这里，你可以看到，确认操作是预留操作的下一个操作，而撤销操作则是用来撤销已执行的预留操作对系统产生的影响，类似在复制粘贴时，我们通过“Ctrl Z”撤销“Ctrl V”操作的执行，就像下图的样子。而这是理解TCC的关键，我希望你能注意到。</p><p><img src=\"https://static001.geekbang.org/resource/image/8b/1b/8b5fbc120651924ffccc862e5bafyy1b.jpg?wh=1142*442\" alt=\"\"></p><p>这样一来，在操作1、2、3的预留操作执行结束，如果预留操作都执行成功了，那么我将执行确认操作，继续向下执行。但如果预留操作只是部分执行成功，那么我将执行撤销操作，取消预留操作执行对系统产生的影响。通过这种方式（指令对应的操作要么全部执行，要么全部不执行），我就能实现指令执行的原子性了。</p><p>另外，在实现确认、撤销操作时，有一点需要我们尤为注意，因为这两个操作在执行时可能会重试，所以，它们需要支持幂等性。</p><h2>内容小结</h2><p>本节课我主要带你了解了TCC，以及如何使用TCC实现分布式事务。我希望你明确这样几个重点。</p><p>1.TCC是个业务层面的分布式事务协议，而XA规范是数据层面的分布式事务协议，这也是TCC和XA规范最大的区别。</p><p>2.TCC与业务耦合紧密，在实际场景使用时，需要我们根据场景特点和业务逻辑来设计相应的预留、确认、撤销操作，相比MySQL XA，有一定的编程开发工作量。</p><p>3.本质上而言，TCC是一种设计模式，也就是一种理念，它没有与任何技术（或实现）耦合，也不受限于任何技术，对所有的技术方案都是适用的。</p><p>最后，我想补充的是，因为TCC是在业务代码中编码实现的，所以，TCC可以跨数据库、跨业务系统实现资源管理，满足复杂业务场景下的事务需求，比如，TCC可以将对不同的数据库、不同业务系统的多个操作通过编码方式，转换为一个原子操作，实现事务。</p><p>另外，因为TCC 的每一个操作对于数据库来讲，都是一个本地数据库事务，那么当操作结束时，本地数据库事务的执行也就完成了，所以相关的数据库资源也就被释放了，这就能避免数据库层面的二阶段提交协议长时间锁定资源，导致系统性能低下的问题。</p><h2>课堂思考</h2><p>我提到了自己通过TCC解决了指令执行的原子性问题。那么你不妨想想，为什么TCC能解决指令执行的原子性问题呢？欢迎在留言区分享你的看法，与我一同讨论。</p><p>最后，感谢你的阅读，如果这节课让你有所收获，也欢迎你将它分享给更多的朋友。</p>","comments":[{"had_liked":false,"id":230537,"user_name":"hello","can_delete":false,"product_type":"c1","uid":1464199,"ip_address":"","ucode":"854500026E2187","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132","comment_is_top":false,"comment_ctime":1593412681,"is_pvip":false,"replies":[{"id":"88064","content":"加一颗星:)，tcc-transaction、seata等，可以了解下。","user_name":"作者回复","user_name_real":"hanj4096","uid":"1642497","ctime":1596157558,"ip_address":"","comment_id":230537,"utype":1}],"discussion_count":4,"race_medal":0,"score":"53133020233","product_id":100046101,"comment_content":"老师，再请教您一个问题，TCC有什么好的开源实现可供借鉴没？","like_count":12,"discussions":[{"author":{"id":1642497,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/01/750740a8.jpg","nickname":"hanj4096","note":"","ucode":"481047E40315AA","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499926,"discussion_content":"加一颗星:)，tcc-transaction、seata等，可以了解下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596157558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099881,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c8/69/ce605c29.jpg","nickname":"轶","note":"","ucode":"FA0483DF79E37D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294921,"discussion_content":"http://seata.io/","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1596029719,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1024341,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a1/55/cff2322c.jpg","nickname":"雪中亮","note":"","ucode":"B294FDFF9F13E8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373238,"discussion_content":"hmily ！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620657745,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2055809,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg","nickname":"码小呆","note":"","ucode":"44532D6ABF9340","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1024341,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a1/55/cff2322c.jpg","nickname":"雪中亮","note":"","ucode":"B294FDFF9F13E8","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":572401,"discussion_content":"终于看到了一个熟悉的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652771165,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373238,"ip_address":""},"score":572401,"extra":""}]}]},{"had_liked":false,"id":230642,"user_name":"Dovelol","can_delete":false,"product_type":"c1","uid":1253384,"ip_address":"","ucode":"9B5DDF7720F307","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","comment_is_top":false,"comment_ctime":1593439206,"is_pvip":false,"replies":[{"id":"88118","content":"加一颗星:）,可以引入一个额外字段，在预留阶段，更新额外字段的值，在确认阶段，将额外字段的值更新到原计划更新的那个字段。","user_name":"作者回复","user_name_real":"hanj4096","uid":"1642497","ctime":1596202911,"ip_address":"","comment_id":230642,"utype":1}],"discussion_count":5,"race_medal":0,"score":"48838079462","product_id":100046101,"comment_content":"老师好，想问下，如果有3个服务调用，都会涉及到update数据库等操作，那预留资源具体是怎么预留的呢？开启事务，修改，不commit？然后等着commit请求过来后在commit数据库事务吗？","like_count":11,"discussions":[{"author":{"id":1642497,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/01/750740a8.jpg","nickname":"hanj4096","note":"","ucode":"481047E40315AA","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499971,"discussion_content":"加一颗星:）,可以引入一个额外字段，在预留阶段，更新额外字段的值，在确认阶段，将额外字段的值更新到原计划更新的那个字段。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596202911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099881,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c8/69/ce605c29.jpg","nickname":"轶","note":"","ucode":"FA0483DF79E37D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":294919,"discussion_content":"所以说 TCC 需要按照业务场景来设计相应的 try、confirm 和 cancel 操作。以转账为例，对于转出账户的 Try 操作就是在冻结表上记一笔冻结金额，在 confirm 操作时将这笔冻结金额从账户余额表里扣除。","likes_number":8,"is_delete":false,"is_hidden":false,"ctime":1596029696,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1101615,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cf/2f/4f89f22a.jpg","nickname":"李鑫磊","note":"","ucode":"D06517CFCEEE00","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301851,"discussion_content":"哎呀，我读完也一直在想这个问题，然后老师说的跟我想的一样，真是完美。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598684690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1089856,"avatar":"https://static001.geekbang.org/account/avatar/00/10/a1/40/3f328ef5.jpg","nickname":"joy","note":"","ucode":"FE925809143BDD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":542183,"discussion_content":"支付中金额的锁定和更新一般都是这样进行处理的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640676757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2733281,"avatar":"","nickname":"Geek_f4512f","note":"","ucode":"3CB387D2943590","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388753,"discussion_content":"预留就是先把事情的内容 办了,但是,没实打实的办,下一个阶段才实打实的去办,加入发生错误了,那也得不断重试进行100%办成功了;","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628935283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230310,"user_name":"dra","can_delete":false,"product_type":"c1","uid":1800186,"ip_address":"","ucode":"5A6B3508851C5F","user_header":"https://static001.geekbang.org/account/avatar/00/1b/77/fa/5fe29602.jpg","comment_is_top":false,"comment_ctime":1593344519,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"40248050183","product_id":100046101,"comment_content":"良心课程，老师用心了。专栏虽完结，还在不停加餐，为学员提供知识服务","like_count":9,"discussions":[{"author":{"id":1464199,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132","nickname":"hello","note":"","ucode":"854500026E2187","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":287302,"discussion_content":"我表示赞同","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593412800,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230707,"user_name":"Corner","can_delete":false,"product_type":"c1","uid":1446316,"ip_address":"","ucode":"7862D593172536","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/ac/9cc5e692.jpg","comment_is_top":false,"comment_ctime":1593475436,"is_pvip":false,"replies":[{"id":"88065","content":"加一颗星:)，比如，可以通过状态位、标志位来标记。","user_name":"作者回复","user_name_real":"hanj4096","uid":"1642497","ctime":1596157780,"ip_address":"","comment_id":230707,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27363279212","product_id":100046101,"comment_content":"首先感谢老师长久以来坚持持续加餐和优化。然后有一个问题需要请教一下，在预留阶段有哪些常用的数据处理手段呢？是否数据上都要为预留操作增加相应的字段标记。","like_count":6,"discussions":[{"author":{"id":1642497,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/01/750740a8.jpg","nickname":"hanj4096","note":"","ucode":"481047E40315AA","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500003,"discussion_content":"加一颗星:)，比如，可以通过状态位、标志位来标记。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596157780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230536,"user_name":"hello","can_delete":false,"product_type":"c1","uid":1464199,"ip_address":"","ucode":"854500026E2187","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132","comment_is_top":false,"comment_ctime":1593412654,"is_pvip":false,"replies":[{"id":"88052","content":"加一颗星:)，如果三个操作的预留操作都成功了，就执行对应的确认操作，如果有任何一个不成功，就执行“已执行成功的预留操作”对应的撤销操作，这样，都回到了最初的状态。","user_name":"作者回复","user_name_real":"hanj4096","uid":"1642497","ctime":1596136893,"ip_address":"","comment_id":230536,"utype":1}],"discussion_count":3,"race_medal":0,"score":"23068249134","product_id":100046101,"comment_content":"老师，请教您一个问题，您文中举例操作1，操作2，操作3这三个操作都各自实现TCC（预留操作、确认操作、撤销操作），那TCC都是针对单个操作（如针对操作1、操作2、操作3）实现，那要实现操作1+操作2+操作3这三个操作要么全成功，要么全失败如如何达到的？","like_count":5,"discussions":[{"author":{"id":1642497,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/01/750740a8.jpg","nickname":"hanj4096","note":"","ucode":"481047E40315AA","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499925,"discussion_content":"加一颗星:)，如果三个操作的预留操作都成功了，就执行对应的确认操作，如果有任何一个不成功，就执行“已执行成功的预留操作”对应的撤销操作，这样，都回到了最初的状态。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596136893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1196886,"avatar":"https://static001.geekbang.org/account/avatar/00/12/43/56/62c38c36.jpg","nickname":"欧阳","note":"","ucode":"2612576E262813","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288082,"discussion_content":"try阶段失败，是可以感知的。直接执行cancel，如果cancel和commit失败，就需要TM发挥作用了。应该它会不断重试，直至成功。只需要业务cc一方保证操作是幂等的就行了。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1593648900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1014649,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/7b/79/df384bdc.jpg","nickname":"修愿三秋","note":"","ucode":"0AEE445D8DBFF4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288064,"discussion_content":"同问","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593642337,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314977,"user_name":"Geek_7a6fde","can_delete":false,"product_type":"c1","uid":2714393,"ip_address":"","ucode":"6A00175AD4BF23","user_header":"","comment_is_top":false,"comment_ctime":1633619966,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5928587262","product_id":100046101,"comment_content":"原文问题：我提到了自己通过 TCC 解决了指令执行的原子性问题。那么你不妨想想，为什么 TCC 能解决指令执行的原子性问题呢？<br><br>个人理解回答：TCC的try阶段可以预留或者锁定资源，就当于对该资源加锁，加锁了肯定就可以保证原子性了，confirm或cancel就是相当于释放锁","like_count":1},{"had_liked":false,"id":243160,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1597978864,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5892946160","product_id":100046101,"comment_content":"在执行的过程中,TCC利用了二阶段提交的思想,既能够锁定成功,就相当于收到了锁定的确认操作,只有在所有的锁定确认收到了,才可以继续执行Confrim操作,在执行Confrim操作的时候,就不允许失败的存在,即使挂了,也会有后来人再上线的时候重新顶替上去","like_count":1},{"had_liked":false,"id":231078,"user_name":"Psyduck","can_delete":false,"product_type":"c1","uid":1668732,"ip_address":"","ucode":"0B06ADBB3A5F30","user_header":"https://static001.geekbang.org/account/avatar/00/19/76/7c/e1d9a256.jpg","comment_is_top":false,"comment_ctime":1593576514,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5888543810","product_id":100046101,"comment_content":"非常感谢老师，之前在看 TCC 时还是很模糊的感觉，通过这篇文章的讲解感觉清晰多了。","like_count":1},{"had_liked":false,"id":359000,"user_name":"NieXY","can_delete":false,"product_type":"c1","uid":1364141,"ip_address":"浙江","ucode":"C131B9A44CB55C","user_header":"https://static001.geekbang.org/account/avatar/00/14/d0/ad/584a4aa1.jpg","comment_is_top":false,"comment_ctime":1665136976,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1665136976","product_id":100046101,"comment_content":"为什么说tcc是最终一致性？感觉它也是应用了二阶段提交的思想，应该是强一致性啊","like_count":0},{"had_liked":false,"id":357177,"user_name":"once","can_delete":false,"product_type":"c1","uid":1170533,"ip_address":"安徽","ucode":"7026094E0B99BF","user_header":"https://static001.geekbang.org/account/avatar/00/11/dc/65/3da02c30.jpg","comment_is_top":false,"comment_ctime":1663039379,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1663039379","product_id":100046101,"comment_content":"这篇说的很好, 让我了解了TCC的实现理论思想, 其实有点像库存中的<br>预占 后扣减or释放<br>","like_count":0},{"had_liked":false,"id":314612,"user_name":"上帝打草稿","can_delete":false,"product_type":"c1","uid":2603712,"ip_address":"","ucode":"8E391A48B1031A","user_header":"https://static001.geekbang.org/account/avatar/00/27/ba/c0/58e3e557.jpg","comment_is_top":false,"comment_ctime":1633256828,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1633256828","product_id":100046101,"comment_content":"如果操作2在确认操作时，突然宕机了怎么办","like_count":0,"discussions":[{"author":{"id":1342023,"avatar":"https://static001.geekbang.org/account/avatar/00/14/7a/47/d9090056.jpg","nickname":"在路边鼓掌的人","note":"","ucode":"BC1388BA330CD5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587279,"discussion_content":"利用重试机制来保证二阶段必须能够执行成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662957342,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":278431,"user_name":"竹马彦四郎的好朋友影法師","can_delete":false,"product_type":"c1","uid":1475385,"ip_address":"","ucode":"A9555AEFF90CDF","user_header":"https://static001.geekbang.org/account/avatar/00/16/83/39/f9623363.jpg","comment_is_top":false,"comment_ctime":1612940399,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612940399","product_id":100046101,"comment_content":"再一次完结撒花~","like_count":0},{"had_liked":false,"id":253998,"user_name":"kylexy_0817","can_delete":false,"product_type":"c1","uid":1068372,"ip_address":"","ucode":"392DD9DD5E4B6E","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/54/9c214885.jpg","comment_is_top":false,"comment_ctime":1603011355,"is_pvip":false,"replies":[{"id":"96019","content":"加一颗星:)，可以的","user_name":"作者回复","user_name_real":"hanj4096","uid":"1642497","ctime":1606646015,"ip_address":"","comment_id":253998,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603011355","product_id":100046101,"comment_content":"韩老师辛苦了。想问题下，在项目中使用TCC，是否需要额外的点存放着数据变更前的快照呢？因为好让在cancel的时候恢复？","like_count":0,"discussions":[{"author":{"id":1642497,"avatar":"https://static001.geekbang.org/account/avatar/00/19/10/01/750740a8.jpg","nickname":"hanj4096","note":"","ucode":"481047E40315AA","race_medal":0,"user_type":2,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507243,"discussion_content":"加一颗星:)，可以的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606646015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243895,"user_name":"Simple","can_delete":false,"product_type":"c1","uid":1564889,"ip_address":"","ucode":"F5219DDD6B92DD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e0/d9/ad644055.jpg","comment_is_top":false,"comment_ctime":1598321312,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1598321312","product_id":100046101,"comment_content":"老师你好，对下面这句话没理解：<br>另外，因为 TCC 的每一个操作对于数据库来讲，都是一个本地数据库事务，那么当操作结束时，本地数据库事务的执行也就完成了，所以相关的数据库资源也就被释放了，这就能避免数据库层面的二阶段提交协议长时间锁定资源，导致系统性能低下的问题。<br><br>问题：<br>tcc不也需要try吗？只有所有服务都try成功了，才能提交，在等待所有业务都try成功的过程中还是会锁定资源，感觉和二阶段一样存在资源锁定问题<br>","like_count":0,"discussions":[{"author":{"id":1318874,"avatar":"https://static001.geekbang.org/account/avatar/00/14/1f/da/a2cbeb83.jpg","nickname":"小白","note":"","ucode":"B5DE76675A0553","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307070,"discussion_content":"TCC的每一个操作都是一个单独的事务，事务结束资源随即释放，具体实现可以参照老师上面的回复。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1600487438,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2733281,"avatar":"","nickname":"Geek_f4512f","note":"","ucode":"3CB387D2943590","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388754,"discussion_content":"需要进行 事务执行结束 的补偿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628935353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233080,"user_name":"林绍灏","can_delete":false,"product_type":"c1","uid":1242340,"ip_address":"","ucode":"AA2CB00DB0C97C","user_header":"https://static001.geekbang.org/account/avatar/00/12/f4/e4/e7f7ca92.jpg","comment_is_top":false,"comment_ctime":1594212653,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1594212653","product_id":100046101,"comment_content":"老师讲得真的很好，终于弄通了TCC","like_count":0},{"had_liked":false,"id":231252,"user_name":"欧阳","can_delete":false,"product_type":"c1","uid":1196886,"ip_address":"","ucode":"2612576E262813","user_header":"https://static001.geekbang.org/account/avatar/00/12/43/56/62c38c36.jpg","comment_is_top":false,"comment_ctime":1593614974,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1593614974","product_id":100046101,"comment_content":"受益匪浅！感谢老师！","like_count":0}]}