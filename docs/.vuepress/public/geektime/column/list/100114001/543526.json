{"id":543526,"title":"16ï½œæ¡ˆä¾‹ï¼šå¦‚ä½•æå‡RocketMQé¡ºåºæ¶ˆè´¹æ€§èƒ½ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¸å¨ã€‚</p><p>åœ¨è¯¾ç¨‹æ­£å¼å¼€å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆåˆ†äº«ä¸€æ®µæˆ‘çš„ç»å†ã€‚æˆ‘è®°å¾—2020å¹´åŒåä¸€çš„æ—¶å€™ï¼Œå…¬å¸è®¢å•ä¸­å¿ƒæœ‰ä¸€ä¸ªä¸šåŠ¡å‡ºç°äº†å¾ˆå¤§ç¨‹åº¦çš„å»¶è¿Ÿã€‚æˆ‘ä»¬çš„ç³»ç»Ÿä¸ºäº†æ ¹æ®è®¢å•çŠ¶æ€çš„å˜æ›´è¿›è¡Œå¯¹åº”çš„ä¸šåŠ¡å¤„ç†ï¼Œä½¿ç”¨äº†RocketMQçš„é¡ºåºæ¶ˆè´¹ã€‚ä½†æ˜¯ç»è¿‡æ’æŸ¥ï¼Œæˆ‘ä»¬å‘ç°æ¯ä¸€ä¸ªé˜Ÿåˆ—éƒ½ç§¯å‹äº†ä¸Šåƒä¸‡æ¡æ¶ˆæ¯ã€‚</p><p>å½“æ—¶ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå†³å®šå¿«é€Ÿæ‰©å®¹æ¶ˆè´¹è€…ã€‚å› ä¸ºå½“æ—¶ä¸»é¢˜çš„æ€»é˜Ÿåˆ—ä¸º64ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€å£æ°”å°†æ¶ˆè´¹è€…æ‰©å®¹åˆ°äº†64å°ã€‚ä½†ä¸Šåƒä¸‡æ¡æ¶ˆæ¯æ¯•ç«Ÿè¿˜æ˜¯å¤ªå¤šäº†ã€‚è¿˜æœ‰å…¶ä»–åŠæ³•èƒ½å¤ŸåŠ å¿«æ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦å—ï¼Ÿæ¯”è¾ƒå°´å°¬çš„æ˜¯ï¼Œæ²¡æœ‰ï¼Œæˆ‘ä»¬å½“æ—¶èƒ½åšçš„åªæœ‰ç­‰å¾…ã€‚</p><p>ä½œä¸ºå…¬å¸æ¶ˆæ¯ä¸­é—´ä»¶çš„è´Ÿè´£äººï¼Œåœ¨æ•…éšœå‘ç”Ÿæ—¶æ²¡æœ‰å…¶ä»–å…¶ä»–è¡¥æ•‘æ‰‹æ®µç¡®å®æ¯”è¾ƒæ— å¥ˆã€‚äº‹åï¼Œæˆ‘å¯¹é¡ºåºæ¶ˆè´¹æ¨¡å‹è¿›è¡Œäº†åæ€ä¸æ”¹å–„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³å’Œä½ ä»‹ç»æˆ‘æ˜¯å¦‚ä½•ä¼˜åŒ–RocketMQçš„é¡ºåºæ¶ˆè´¹æ€§èƒ½çš„ã€‚</p><h2>RocketMQé¡ºåºæ¶ˆè´¹å®ç°åŸç†</h2><p>æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ RocketMQ é¡ºåºæ¶ˆè´¹çš„å®ç°åŸç†ã€‚RocketMQæ”¯æŒå±€éƒ¨é¡ºåºæ¶ˆæ¯æ¶ˆè´¹ï¼Œå¯ä»¥ä¿è¯åŒä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯é¡ºåºæ¶ˆè´¹ã€‚ä¾‹å¦‚ï¼Œæ¶ˆæ¯å‘é€è€…å‘ä¸»é¢˜ä¸ºORDER_TOPICçš„4ä¸ªé˜Ÿåˆ—å…±å‘é€12æ¡æ¶ˆæ¯ï¼Œ RocketMQ å¯ä»¥ä¿è¯1ã€4ã€8è¿™ä¸‰æ¡æŒ‰é¡ºåºæ¶ˆè´¹ï¼Œä½†æ— æ³•ä¿è¯æ¶ˆæ¯4å’Œæ¶ˆæ¯2çš„å…ˆåé¡ºåºã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/c4/04/c483d9fcfd0948938395e89c83cf4704.jpg?wh=1690x641\" alt=\"å›¾ç‰‡\"></p><p>é‚£RocketMQæ˜¯æ€ä¹ˆåšåˆ°åˆ†åŒºé¡ºåºæ¶ˆè´¹çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„å·¥ä½œæœºåˆ¶ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/51/61/51ef84yy8790bd41aef99787fd2b1961.jpg?wh=1920x1328\" alt=\"å›¾ç‰‡\"></p><p>é¡ºåºæ¶ˆè´¹å®ç°çš„æ ¸å¿ƒè¦ç‚¹å¯ä»¥ç»†åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µã€‚</p><p><strong>ç¬¬ä¸€é˜¶æ®µï¼šæ¶ˆè´¹é˜Ÿåˆ—è´Ÿè½½ã€‚</strong></p><p>RebalanceServiceçº¿ç¨‹å¯åŠ¨åï¼Œä¼šä»¥20sçš„é¢‘ç‡è®¡ç®—æ¯ä¸€ä¸ªæ¶ˆè´¹ç»„çš„é˜Ÿåˆ—è´Ÿè½½ã€å½“å‰æ¶ˆè´¹è€…çš„æ¶ˆè´¹é˜Ÿåˆ—é›†åˆï¼ˆç”¨newAssignQueueSetè¡¨ï¼‰ï¼Œç„¶åä¸ä¸Šä¸€æ¬¡åˆ†é…ç»“æœï¼ˆç”¨oldAssignQueueSetè¡¨ç¤ºï¼‰è¿›è¡Œå¯¹æ¯”ã€‚è¿™æ—¶å€™ä¼šå‡ºç°ä¸¤ç§æƒ…å†µã€‚</p><ul>\n<li>å¦‚æœä¸€ä¸ªé˜Ÿåˆ—åœ¨newAssignQueueSetä¸­ï¼Œä½†å¹¶ä¸åœ¨oldAssignQueueSetä¸­ï¼Œè¡¨ç¤ºè¿™æ˜¯æ–°åˆ†é…çš„é˜Ÿåˆ—ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥å°è¯•å‘<strong>Brokerç”³è¯·é”</strong>ï¼š\n<ul>\n<li>å¦‚æœæˆåŠŸè·å–é”ï¼Œåˆ™ä¸ºè¯¥é˜Ÿåˆ—åˆ›å»ºæ‹‰å–ä»»åŠ¡å¹¶æ”¾å…¥åˆ°PullMessageServiceçš„pullRequestQueueä¸­ï¼Œä»¥æ­¤å”¤é†’Pullçº¿ç¨‹ï¼Œè§¦å‘æ¶ˆæ¯æ‹‰å–æµç¨‹ï¼›</li>\n<li>å¦‚æœæœªè·å–é”ï¼Œè¯´æ˜è¯¥é˜Ÿåˆ—å½“å‰è¢«å…¶ä»–æ¶ˆè´¹è€…é”å®šï¼Œæ”¾å¼ƒæœ¬æ¬¡æ‹‰å–ï¼Œç­‰ä¸‹æ¬¡é‡å¹³è¡¡æ—¶å†å°è¯•ç”³è¯·é”ã€‚</li>\n</ul>\n</li>\n</ul><p><strong>è¿™ç§æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…èƒ½å¤Ÿæ‹‰å–æ¶ˆæ¯çš„å‰ææ¡ä»¶æ˜¯ï¼Œåœ¨Brokerä¸ŠåŠ é”æˆåŠŸã€‚</strong></p><ul>\n<li>å¦‚æœä¸€ä¸ªé˜Ÿåˆ—åœ¨newAssignQueueSetä¸­ä¸å­˜åœ¨ï¼Œä½†å­˜åœ¨äºoldAssignQueueSetä¸­ï¼Œè¡¨ç¤ºè¯¥é˜Ÿåˆ—åº”è¯¥åˆ†é…ç»™å…¶ä»–æ¶ˆè´¹è€…ï¼Œéœ€è¦å°†è¯¥é˜Ÿåˆ—ä¸¢å¼ƒã€‚ä½†åœ¨ä¸¢å¼ƒä¹‹å‰ï¼Œè¦<strong>å°è¯•ç”³è¯·ProceeQueueçš„é”</strong>ï¼š\n<ul>\n<li>å¦‚æœæˆåŠŸé”å®šProceeQueueï¼Œè¯´æ˜ProceeQueueä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹ï¼Œå¯ä»¥å°†è¯¥ProceeQueueä¸¢å¼ƒï¼Œå¹¶é‡Šæ”¾é”ï¼›</li>\n<li>å¦‚æœæœªèƒ½æˆåŠŸé”å®šProceeQueueï¼Œè¯´æ˜è¯¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿˜åœ¨æ¶ˆè´¹ï¼Œæš‚æ—¶ä¸ä¸¢å¼ƒProceeQueueï¼Œè¿™æ—¶æ¶ˆè´¹è€…å¹¶ä¸ä¼šé‡Šæ”¾Brokerä¸­ç”³è¯·çš„é”ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¹Ÿå°±æš‚æ—¶æ— æ³•æ¶ˆè´¹è¯¥é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚</li>\n</ul>\n</li>\n</ul><p><strong>è¿™æ ·ï¼Œæ¶ˆè´¹è€…åœ¨ç»å†é˜Ÿåˆ—é‡å¹³è¡¡ä¹‹åï¼Œå°±ä¼šåˆ›å»ºæ‹‰å–ä»»åŠ¡ï¼Œå¹¶é©±åŠ¨Pullçº¿ç¨‹è¿›å…¥åˆ°æ¶ˆæ¯æ‹‰å–æµç¨‹ã€‚</strong></p><p><strong>ç¬¬äºŒé˜¶æ®µï¼šæ¶ˆæ¯æ‹‰å–ã€‚</strong></p><p>PullMessageServiceçº¿ç¨‹å¯åŠ¨ï¼Œä»pullRequestQueueä¸­è·å–æ‹‰å–ä»»åŠ¡ã€‚å¦‚æœè¯¥é˜Ÿåˆ—ä¸­æ²¡æœ‰å¾…æ‹‰å–ä»»åŠ¡ï¼Œåˆ™Pullçº¿ç¨‹ä¼šé˜»å¡ï¼Œç­‰å¾…RebalanceImplçº¿ç¨‹åˆ›å»ºæ‹‰å–ä»»åŠ¡ï¼Œå¹¶å‘Brokerå‘èµ·æ¶ˆæ¯æ‹‰å–è¯·æ±‚ï¼š</p><ul>\n<li>å¦‚æœæœªæ‹‰å–åˆ°æ¶ˆæ¯ã€‚å¯èƒ½æ˜¯Tagè¿‡æ»¤çš„åŸå› ï¼Œè¢«è¿‡æ»¤çš„æ¶ˆæ¯å…¶å®ä¹Ÿå¯ä»¥ç®—æˆè¢«æˆåŠŸæ¶ˆè´¹äº†ã€‚æ‰€ä»¥å¦‚æœæ­¤æ—¶å¤„ç†é˜Ÿåˆ—ä¸­æ²¡æœ‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå°±æäº¤ä½ç‚¹ï¼ˆå½“å‰å·²æ‹‰å–åˆ°æœ€å¤§ä½ç‚¹+1ï¼‰ï¼ŒåŒæ—¶å†å°†æ‹‰å–è¯·æ±‚æ”¾åˆ°å¾…æ‹‰å–ä»»åŠ¡çš„æœ«å°¾ï¼Œåå¤æ‹‰å–ï¼Œå®ç°Pushæ¨¡å¼ã€‚</li>\n<li>å¦‚æœæ‹‰å–åˆ°ä¸€æ‰¹æ¶ˆæ¯ã€‚é¦–å…ˆè¦å°†æ‹‰å–åˆ°çš„æ¶ˆæ¯æ”¾å…¥ProceeQueue(TreeMap)ï¼ŒåŒæ—¶å°†æ¶ˆæ¯æäº¤åˆ°æ¶ˆè´¹çº¿ç¨‹æ± ï¼Œè¿›å…¥æ¶ˆæ¯æ¶ˆè´¹æµç¨‹ã€‚å†å°†æ‹‰å–è¯·æ±‚æ”¾åˆ°å¾…æ‹‰å–ä»»åŠ¡çš„æœ«å°¾ï¼Œåå¤æ‹‰å–ï¼Œå®ç°Pushæ¨¡å¼ã€‚</li>\n</ul><p><strong>ç¬¬ä¸‰é˜¶æ®µï¼šé¡ºåºæ¶ˆè´¹ã€‚</strong></p><p>RocketMQä¸€æ¬¡åªä¼šæ‹‰å–ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œç„¶åå°†å…¶æäº¤åˆ°çº¿ç¨‹æ± ã€‚ä¸ºäº†ä¿è¯é¡ºåºæ¶ˆè´¹ï¼ŒRocketMQåœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­æœ‰ä¸‹é¢å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ul>\n<li>ç”³è¯·MessageQueueé”ï¼Œç¡®ä¿åœ¨åŒä¸€æ—¶é—´ï¼Œä¸€ä¸ªé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœªè·å–é”çš„çº¿ç¨‹é˜»å¡ç­‰å¾…ã€‚</li>\n<li>è·å–MessageQueueé”åï¼Œä»å¤„ç†é˜Ÿåˆ—ä¸­ä¾æ¬¡æ‹‰å–ä¸€æ‰¹æ¶ˆæ¯ï¼ˆæ¶ˆæ¯åç§»é‡ä»å°åˆ°å¤§ï¼‰ï¼Œä¿è¯æ¶ˆè´¹æ—¶ä¸¥æ ¼éµå¾ªæ¶ˆæ¯å­˜å‚¨é¡ºåºã€‚</li>\n<li>ç”³è¯·MessageQueueå¯¹åº”çš„ProcessQueueï¼Œç”³è¯·æˆåŠŸåè°ƒç”¨ä¸šåŠ¡ç›‘å¬å™¨ï¼Œæ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>\n</ul><p>ç»è¿‡ä¸Šé¢ä¸‰ä¸ªå…³é”®æ­¥éª¤ï¼ŒRocketMQå°±å¯ä»¥å®ç°é˜Ÿåˆ—ï¼ˆKafkaä¸­ç§°ä¸ºåˆ†åŒºï¼‰çº§åˆ«çš„é¡ºåºæ¶ˆè´¹äº†ã€‚</p><h2>RocketMQé¡ºåºæ¶ˆè´¹è®¾è®¡ç¼ºé™·</h2><p>å›é¡¾ä¸Šé¢RocketMQå®ç°é¡ºåºæ¶ˆè´¹çš„æ ¸å¿ƒå…³é”®è¯ï¼Œæˆ‘ä»¬å‘ç°å…¶å®å°±æ˜¯åŠ é”ã€åŠ é”ã€åŠ é”ã€‚æ²¡é”™ï¼Œä¸ºäº†å®ç°é¡ºåºæ¶ˆè´¹ï¼ŒRocketMQéœ€è¦è¿›è¡Œä¸‰æ¬¡åŠ é”ï¼š</p><ul>\n<li>è¿›è¡Œé˜Ÿåˆ—è´Ÿè½½å¹³è¡¡åï¼Œå¯¹æ–°åˆ†é…çš„é˜Ÿåˆ—ï¼Œå¹¶ä¸èƒ½ç«‹å³è¿›è¡Œæ¶ˆæ¯æ‹‰å–ï¼Œå¿…é¡»å…ˆåœ¨Brokerç«¯è·å–é˜Ÿåˆ—çš„é”ï¼›</li>\n<li>æ¶ˆè´¹ç«¯åœ¨æ­£å¼æ¶ˆè´¹æ•°æ®ä¹‹å‰ï¼Œéœ€è¦é”å®šMessageQueueå’ŒProceeQueueã€‚</li>\n</ul><p>ä¸Šè¿°ä¸‰æŠŠé”çš„æ§åˆ¶ï¼Œè®©å¹¶å‘åº¦å—åˆ°äº†é˜Ÿåˆ—æ•°é‡çš„é™åˆ¶ã€‚åœ¨äº’è”ç½‘ã€é«˜å¹¶å‘ç¼–ç¨‹é¢†åŸŸï¼Œé€šå¸¸æ˜¯â€œ<strong>è°ˆé”è‰²å˜</strong>â€ï¼Œé”å‡ ä¹æˆä¸ºäº†æ€§èƒ½ä½ä¸‹çš„ä»£åè¯ã€‚è¯•å›¾å‡å°‘é”çš„ä½¿ç”¨ã€ç¼©å°é”çš„èŒƒå›´å‡ ä¹æ˜¯æ€§èƒ½ä¼˜åŒ–çš„ä¸»è¦æ‰‹æ®µã€‚</p><h2>RocketMQé¡ºåºæ¶ˆè´¹ä¼˜åŒ–æ–¹æ¡ˆ</h2><p>è€ŒRocketMQä¸ºäº†å®ç°é¡ºåºæ¶ˆè´¹å¼•å…¥äº†ä¸‰æŠŠé”ï¼Œæå¤§åœ°é™ä½äº†å¹¶å‘æ€§èƒ½ã€‚é‚£å¦‚ä½•å¯¹å…¶è¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿ</p><h3>ç ´å±€æ€è·¯ï¼šå…³è”é¡ºåºæ€§</h3><p>æˆ‘ä»¬ä¸å¦¨æ¥çœ‹ä¸€ä¸ªé‡‘èè¡Œä¸šçš„çœŸå®ä¸šåŠ¡åœºæ™¯ï¼š<strong>é“¶è¡Œè´¦æˆ·ä½™é¢å˜æ›´çŸ­ä¿¡é€šçŸ¥</strong>ã€‚</p><p>å½“ç”¨æˆ·çš„è´¦æˆ·ä½™é¢å‘ç”Ÿå˜æ›´æ—¶ï¼Œé‡‘èæœºæ„éœ€è¦å‘é€ä¸€æ¡çŸ­ä¿¡ï¼Œå‘ŠçŸ¥ç”¨æˆ·ä½™é¢å˜æ›´æƒ…å†µã€‚ä¸ºäº†å®ç°ä½™é¢å˜æ›´å’Œå‘é€çŸ­ä¿¡çš„è§£è€¦ï¼Œæ¶æ„è®¾è®¡æ—¶é€šå¸¸ä¼šå¼•å…¥æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒçš„åŸºæœ¬å®ç°æ€è·¯ä½ å¯ä»¥å‚è€ƒè¿™å¼ å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/ce/dc/cea0d3f79617c677e8dec11d03c322dc.jpg?wh=1920x494\" alt=\"å›¾ç‰‡\"></p><p>åŸºäºRocketMQçš„é¡ºåºæ¶ˆè´¹æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åŸºäºé˜Ÿåˆ—çš„é¡ºåºæ¶ˆè´¹ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶åªéœ€è¦ç¡®ä¿åŒä¸€ä¸ªè´¦å·çš„å¤šæ¡æ¶ˆæ¯ï¼ˆå¤šæ¬¡ä½™é¢å˜æ›´é€šçŸ¥ï¼‰å‘é€åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¶ˆè´¹ç«¯ä½¿ç”¨é¡ºåºæ¶ˆè´¹ï¼Œå°±å¯ä»¥ä¿è¯åŒä¸€ä¸ªè´¦å·çš„å¤šæ¬¡ä½™é¢å˜æ›´çŸ­ä¿¡ä¸ä¼šé¡ºåºé”™ä¹±ã€‚</p><p>q0é˜Ÿåˆ—ä¸­ä¾æ¬¡å‘é€äº†è´¦å·IDä¸º1ã€3ã€5ã€3ã€9çš„5æ¡æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯å°†ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ‰§è¡Œã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸ºè´¦å·1å’Œè´¦å·3å‘é€ä½™é¢å˜æ›´çŸ­ä¿¡ï¼Œæ—¶é—´é¡ºåºå¿…é¡»å’Œå®é™…çš„æ—¶é—´é¡ºåºä¿æŒä¸€è‡´å—ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ²¡æœ‰è¿™ä¸ªå¿…è¦ã€‚</p><p>ä¾‹å¦‚ï¼Œç”¨æˆ·1åœ¨10:00:01å‘ç”Ÿäº†ä¸€ç¬”ç”µå•†è®¢å•æ‰£æ¬¾ï¼Œè€Œç”¨æˆ·2åœ¨10:00:02åŒæ ·å‘ç”Ÿäº†ä¸€ç¬”ç”µå•†è®¢å•æ‰£æ¬¾ï¼Œé‚£é“¶è¡Œå…ˆå‘çŸ­ä¿¡å‘ŠçŸ¥ç”¨æˆ·2ä½™é¢å‘ç”Ÿå˜æ›´ï¼Œç„¶åå†é€šçŸ¥ç”¨æˆ·1ï¼Œå¹¶æ²¡æœ‰ç ´åä¸šåŠ¡è§„åˆ™ã€‚</p><p>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼ŒåŒä¸€ä¸ªç”¨æˆ·çš„ä¸¤æ¬¡ä½™é¢å˜æ›´ï¼Œå¿…é¡»æŒ‰ç…§å‘ç”Ÿé¡ºåºæ¥é€šçŸ¥ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„<strong>å…³è”é¡ºåºæ€§</strong>ã€‚</p><p>æ˜¾ç„¶ï¼ŒRocketMQé¡ºåºæ¶ˆè´¹æ¨¡å‹å¹¶æ²¡æœ‰åšåˆ°å…³è”é¡ºåºæ€§ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€æ¡æ¸…æ™°çš„ä¼˜åŒ–è·¯çº¿ï¼š<strong>å¹¶å‘æ‰§è¡ŒåŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ä¸åŒè´¦å·çš„æ¶ˆæ¯ï¼Œä¸²è¡Œæ‰§è¡ŒåŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ç›¸åŒè´¦å·çš„æ¶ˆæ¯</strong>ã€‚</p><h3>RocketMQé¡ºåºæ¨¡å‹ä¼˜åŒ–</h3><p>åŸºäºå…³è”é¡ºåºæ€§çš„æ•´ä½“æŒ‡å¯¼æ€è·¯ï¼Œæˆ‘è®¾è®¡å‡ºäº†ä¸€ç§<strong>é¡ºåºæ¶ˆè´¹æ”¹è¿›æ¨¡å‹</strong>ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/9a/82/9ae8ed21d5c0023c013ce98cd1fe8682.jpg?wh=1920x932\" alt=\"å›¾ç‰‡\"></p><p>è¯¦ç»†è¯´æ˜ä¸€ä¸‹ã€‚</p><ol>\n<li>æ¶ˆæ¯æ‹‰å–çº¿ç¨‹ï¼ˆPullMeessageServiceï¼‰ä»Brokerç«¯æ‹‰å–ä¸€æ‰¹æ¶ˆæ¯ã€‚</li>\n<li>éå†æ¶ˆæ¯ï¼Œè·å–æ¶ˆæ¯çš„Keyï¼ˆæ¶ˆæ¯å‘é€è€…åœ¨å‘é€æ¶ˆæ¯æ—¶æ ¹æ®Keyé€‰æ‹©é˜Ÿåˆ—ï¼ŒåŒä¸€ä¸ªKeyçš„æ¶ˆæ¯è¿›å…¥åŒä¸€ä¸ªé˜Ÿåˆ—ï¼‰çš„HashCodeå’Œçº¿ç¨‹æ•°é‡ï¼Œå°†æ¶ˆæ¯æŠ•é€’åˆ°å¯¹åº”çš„çº¿ç¨‹ã€‚</li>\n<li>æ¶ˆæ¯è¿›å…¥åˆ°æŸä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹ä¸­ï¼Œæ’é˜Ÿå•çº¿ç¨‹æ‰§è¡Œæ¶ˆè´¹ï¼Œéµå¾ªä¸¥æ ¼çš„æ¶ˆè´¹é¡ºåºã€‚</li>\n</ol><p>ä¸ºäº†è®©ä½ æ›´åŠ ç›´è§‚åœ°ä½“ä¼šä¸¤ç§è®¾è®¡çš„ä¼˜åŠ£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸¤ç§æ¨¡å¼é’ˆå¯¹ä¸€æ‰¹æ¶ˆæ¯çš„æ¶ˆè´¹è¡Œä¸ºå¯¹æ¯”ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/38/63/384003e610539cf1f7cc0e7334d0c463.jpg?wh=1920x1135\" alt=\"å›¾ç‰‡\"></p><p>åœ¨è¿™é‡Œï¼Œæ–¹æ¡ˆä¸€æ˜¯RocketMQå†…ç½®çš„é¡ºåºæ¶ˆè´¹æ¨¡å‹ã€‚å®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¸‰ã€çº¿ç¨‹å››ä¹Ÿä¼šå¤„ç†æ¶ˆæ¯ï¼Œä½†å†…éƒ¨çº¿ç¨‹åœ¨å¤„ç†æ¶ˆæ¯ä¹‹å‰å¿…é¡»è·å–é˜Ÿåˆ—é”ï¼Œæ‰€ä»¥è¯´åŒä¸€æ—¶åˆ»ä¸€ä¸ªé˜Ÿåˆ—åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹çœŸæ­£å­˜åœ¨æ¶ˆè´¹åŠ¨ä½œã€‚</p><p>æ–¹æ¡ˆäºŒæ˜¯ä¼˜åŒ–åçš„é¡ºåºæ¶ˆè´¹æ¨¡å‹ï¼Œå®ƒå’Œæ–¹æ¡ˆä¸€ç›¸æ¯”æœ€å¤§çš„ä¼˜åŠ¿æ˜¯å¹¶å‘åº¦æ›´é«˜ã€‚</p><p>æ–¹æ¡ˆä¸€çš„å¹¶å‘åº¦å–å†³äºæ¶ˆè´¹è€…åˆ†é…çš„é˜Ÿåˆ—æ•°ï¼Œå•ä¸ªæ¶ˆè´¹è€…çš„æ¶ˆè´¹å¹¶å‘åº¦å¹¶ä¸ä¼šéšç€çº¿ç¨‹æ•°çš„å¢åŠ è€Œå‡é«˜ï¼Œè€Œæ–¹æ¡ˆäºŒçš„å¹¶å‘åº¦ä¸æ¶ˆæ¯é˜Ÿåˆ—æ•°æ— å…³ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡è¶Šé«˜ï¼Œå¹¶å‘åº¦ä¹Ÿå°±è¶Šé«˜ã€‚</p><h2>ä»£ç å®ç°</h2><p>åœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œå†å¥½çœ‹çš„æ¶æ„æ–¹æ¡ˆå¦‚æœä¸èƒ½ä»¥è¾ƒä¸ºç®€å•çš„æ–¹å¼è½åœ°ï¼Œé‚£å°±ç­‰äºé›¶ï¼Œç›¸å½“äºä»€ä¹ˆéƒ½æ²¡å¹²ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å°±å°è¯•è½åœ°è¿™ä¸ªæ–¹æ¡ˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åŸºäºRocketMQ4.6ç‰ˆæœ¬çš„DefaultLitePullConsumerç±»ï¼Œå¼•å…¥æ–°çš„çº¿ç¨‹æ¨¡å‹ï¼Œå®ç°æ–°çš„Pushæ¨¡å¼ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ä½ é˜…è¯»ä»£ç ï¼Œæˆ‘ä»¬å…ˆè¯¦ç»†çœ‹çœ‹å„ä¸ªç±»çš„èŒè´£ï¼ˆç±»å›¾ï¼‰ä¸è¿è½¬ä¸»æµç¨‹ï¼ˆæ—¶åºå›¾ï¼‰ã€‚</p><h3>ç±»å›¾è®¾è®¡</h3><p><img src=\"https://static001.geekbang.org/resource/image/c4/94/c469fabd860ff2eff3c3a117e764e394.jpg?wh=1920x783\" alt=\"å›¾ç‰‡\"></p><ol>\n<li>\n<p>DefaultMQLitePushConsumer<br>\nåŸºäºDefaultMQLitePullCOnsumerå®ç°çš„Pushæ¨¡å¼ï¼Œå®ƒçš„å†…éƒ¨å¯¹çº¿ç¨‹æ¨¡å‹è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯¹æ ‡DefaultMQPushConsumerã€‚</p>\n</li>\n<li>\n<p>ConsumeMessageQueueService<br>\næ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æ¶ˆè´¹æœåŠ¡ç±»æ¥å£ï¼Œåªå®šä¹‰äº†void execute(List&lt; MessageExt &gt; msg) æ–¹æ³•ï¼Œæ˜¯åŸºäºMessageQueueæ¶ˆè´¹çš„æŠ½è±¡ã€‚</p>\n</li>\n<li>\n<p>AbstractConsumeMessageService<br>\næ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—æœåŠ¡æŠ½è±¡ç±»ï¼Œå®šä¹‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•selectTaskQueueæ¥è¿›è¡Œ<strong>æ¶ˆæ¯çš„è·¯ç”±ç­–ç•¥</strong>ï¼ŒåŒæ—¶å®ç°æœ€å°ä½ç‚¹æœºåˆ¶ï¼Œæ‹¥æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š</p>\n</li>\n</ol><ul>\n<li>é¡ºåºæ¶ˆè´¹æ¨¡å‹ï¼ˆConsumeMessageQueueOrderlyService)ï¼Œæ¶ˆæ¯è·¯ç”±æ—¶æŒ‰ç…§Keyçš„å“ˆå¸Œä¸çº¿ç¨‹æ•°å–æ¨¡ï¼›</li>\n<li>å¹¶å‘æ¶ˆè´¹æ¨¡å‹ï¼ˆConsumerMessageQueueConcurrentlyServiceï¼‰ï¼Œæ¶ˆæ¯è·¯ç”±æ—¶ä½¿ç”¨é»˜è®¤çš„è½®å¾ªæœºåˆ¶é€‰æ‹©çº¿ç¨‹ã€‚</li>\n</ul><ol start=\"4\">\n<li>AbstractConsumerTask<br>\nå®šä¹‰æ¶ˆæ¯æ¶ˆè´¹çš„æµç¨‹ï¼ŒåŒæ ·æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯å¹¶å‘æ¶ˆè´¹æ¨¡å‹ï¼ˆConcurrentlyConsumerTask)å’Œé¡ºåºæ¶ˆè´¹æ¨¡å‹ï¼ˆOrderlyConsumerTaskï¼‰ã€‚</li>\n</ol><h3>æ—¶åºå›¾</h3><p>ç±»å›¾åªèƒ½ç®€å•ä»‹ç»å„ä¸ªç±»çš„èŒè´£ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨æ—¶åºå›¾å‹¾ç”»å‡ºæ ¸å¿ƒçš„è®¾è®¡è¦ç‚¹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/47/01/4754a410033f5452aaa7947353122c01.jpg?wh=1920x1099\" alt=\"å›¾ç‰‡\"></p><p>è¿™é‡Œï¼Œæˆ‘ä¸»è¦è§£è¯»ä¸€ä¸‹ä¸é¡ºåºæ¶ˆè´¹ä¼˜åŒ–æ¨¡å‹ç›¸å…³çš„æ ¸å¿ƒæµç¨‹ï¼š</p><ol>\n<li>è°ƒç”¨DefaultMQLitePushConsumerçš„startæ–¹æ³•åï¼Œä¼šä¾æ¬¡å¯åŠ¨Pullçº¿ç¨‹ï¼ˆæ¶ˆæ¯æ‹‰å–çº¿ç¨‹ï¼‰ã€æ¶ˆè´¹ç»„çº¿ç¨‹æ± ã€æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸æ¶ˆè´¹å¤„ç†ä»»åŠ¡ã€‚è¿™é‡Œçš„é‡ç‚¹æ˜¯ï¼Œä¸€ä¸ªAbstractConsumerTaskä»£è¡¨ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹ï¼Œä¸€ä¸ªAbstractConsumerTaskå…³è”ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¶ˆæ¯åœ¨æŒ‰ç…§Keyè·¯ç”±åä¼šæ”¾å…¥æŒ‡å®šçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œä»è€Œè¢«æŒ‡å®šçº¿ç¨‹å¤„ç†ã€‚</li>\n<li>Pullçº¿ç¨‹æ¯æ‹‰å–ä¸€æ‰¹æ¶ˆæ¯ï¼Œå°±æŒ‰ç…§MessageQueueæäº¤åˆ°å¯¹åº”çš„AbstractConsumeMessageServiceã€‚</li>\n<li>AbstractConsumeMessageServiceä¼šæ ¹æ®é¡ºåºæ¶ˆè´¹ã€å¹¶å‘æ¶ˆè´¹æ¨¡å¼é€‰æ‹©ä¸åŒçš„è·¯ç”±ç®—æ³•ã€‚å…¶ä¸­ï¼Œé¡ºåºæ¶ˆè´¹æ¨¡å‹ä¼šå°†æ¶ˆæ¯Keyçš„å“ˆå¸Œå€¼ä¸ä»»åŠ¡é˜Ÿåˆ—çš„æ€»ä¸ªæ•°å–æ¨¡ï¼Œå°†æ¶ˆæ¯æ”¾å…¥åˆ°å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚</li>\n<li>æ¯ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹ï¼Œæ‰§è¡ŒAbstractConsumerTaskçš„runæ–¹æ³•ï¼Œå°†ä»å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­æŒ‰æ¶ˆæ¯çš„åˆ°è¾¾é¡ºåºæ‰§è¡Œä¸šåŠ¡æ¶ˆè´¹é€»è¾‘ã€‚</li>\n<li>AbstractConsumerTaskæ¯æ¶ˆè´¹ä¸€æ¡æˆ–ä¸€æ‰¹æ¶ˆæ¯ï¼Œéƒ½ä¼šæäº¤æ¶ˆè´¹ä½ç‚¹ï¼Œæäº¤å¤„ç†é˜Ÿåˆ—ä¸­æœ€å°çš„ä½ç‚¹ã€‚</li>\n</ol><h3>å…³é”®ä»£ç è§£è¯»</h3><p>ç±»å›¾ä¸æ—¶åºå›¾å·²ç»å¼ºè°ƒäº†é¡ºåºæ¶ˆè´¹æ¨¡å‹çš„å‡ ä¸ªå…³é”®ç‚¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆä»£ç çœ‹çœ‹å…·ä½“çš„å®ç°æŠ€å·§ã€‚</p><h4>åˆ›å»ºæ¶ˆè´¹çº¿ç¨‹æ± </h4><p>åˆ›å»ºæ¶ˆè´¹çº¿ç¨‹æ± éƒ¨åˆ†æ˜¯æˆ‘ä»¬è¿™ä¸ªæ–¹æ¡ˆçš„ç‚¹ç›ä¹‹ç¬”ï¼Œå®ƒå¯¹åº”çš„æ˜¯ç¬¬ä¸‰å°èŠ‚é¡ºåºæ¶ˆè´¹æ”¹è¿›æ¨¡å‹å›¾ä¸­ç”¨è™šçº¿å‹¾ç”»å‡ºçš„çº¿ç¨‹æ± ã€‚ä¸ºäº†æ–¹ä¾¿ä½ å›é¡¾ï¼Œæˆ‘æŠŠè¿™ä¸ªå›¾ç²˜è´´åœ¨ä¸‹é¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9a/82/9ae8ed21d5c0023c013ce98cd1fe8682.jpg?wh=1920x932\" alt=\"å›¾ç‰‡\"></p><p>ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-java\">// å¯åŠ¨æ¶ˆè´¹ç»„çº¿ç¨‹æ± \nprivate void startConsumerThreads() {\n    //è®¾ç½®çº¿ç¨‹çš„åç§°\n    String threadPrefix = isOrderConsumerModel ? \"OrderlyConsumerThreadMessage_\" : \"ConcurrentlyConsumerThreadMessage_\";\n    AtomicInteger threadNumIndex = new AtomicInteger(0);\n    //åˆ›å»ºæ¶ˆè´¹çº¿ç¨‹æ± \n    consumerThreadGroup = new ThreadPoolExecutor(consumerThreadCount, consumerThreadCount, 0, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;&gt;(), r -&gt; {\n        Thread t = new Thread(r);\n        t.setName(threadPrefix + threadNumIndex.incrementAndGet() );\n        return t;\n    });\n    //åˆ›å»ºä»»åŠ¡é˜»å¡çº¿ç¨‹æ•°ç»„\n    msgByKeyBlockQueue = new ArrayList(consumerThreadCount);\n    consumerRunningTasks = new ArrayList&lt;&gt;(consumerThreadCount);\n    for(int i =0; i &lt; consumerThreadCount; i ++ ) {\n        msgByKeyBlockQueue.add(new LinkedBlockingQueue());\n        AbstractConsumerTask task = null;\n        //æ ¹æ®æ˜¯å¦æ˜¯é¡ºåºæ¶ˆè´¹ï¼Œåˆ›å»ºå¯¹åº”çš„æ¶ˆè´¹å®ç°ç±»\n        if(isOrderConsumerModel) {\n            task = new OrderlyConsumerTask(this, msgByKeyBlockQueue.get(i), this.messageListener);\n        } else {\n            task = new ConcurrentlyConsumerTask(this, msgByKeyBlockQueue.get(i), this.messageListener);\n        }\n        consumerRunningTasks.add(task);\n        //å¯åŠ¨æ¶ˆè´¹çº¿ç¨‹\n        consumerThreadGroup.submit(task);\n    }\n}\n</code></pre><p>è¿™æ®µä»£ç æœ‰ä¸‰ä¸ªå®ç°è¦ç‚¹ã€‚</p><ul>\n<li>ç¬¬7è¡Œï¼šåˆ›å»ºä¸€ä¸ªæŒ‡å®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ï¼Œæ¶ˆè´¹çº¿ç¨‹æ•°å¯ä»¥ç”±consumerThreadContæŒ‡å®šã€‚</li>\n<li>ç¬¬12è¡Œï¼šåˆ›å»ºä¸€ä¸ªArrayList &lt; LinkedBlockingQueue &gt; taskQueuesçš„ä»»åŠ¡é˜Ÿåˆ—é›†åˆï¼Œå…¶ä¸­taskQueuesä¸­åŒ…å«consumerThreadContä¸ªé˜Ÿåˆ—ã€‚</li>\n<li>ç¬¬13è¡Œï¼šåˆ›å»ºconsumerThreadContä¸ªAbstractConsumerTaskä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªtaskå…³è”ä¸€ä¸ªLinkedBlockingQueueä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åå°†AbstractConsumerTaskæäº¤åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚</li>\n</ul><p>ä»¥5ä¸ªæ¶ˆè´¹çº¿ç¨‹æ± ä¸ºä¾‹ï¼Œä»è¿è¡Œè§†è§’æ¥çœ‹ï¼Œå®ƒå¯¹åº”çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/b6/96/b6ce902df7139dba23cfec955125f096.jpg?wh=1920x1049\" alt=\"å›¾ç‰‡\"></p><h4>æ¶ˆè´¹çº¿ç¨‹å†…éƒ¨æ‰§è¡Œæµç¨‹</h4><p>å°†ä»»åŠ¡æäº¤åˆ°æäº¤åˆ°çº¿ç¨‹æ± åï¼Œå¼‚æ­¥è¿è¡Œä»»åŠ¡ï¼Œå…·ä½“ä»£ç ç”±AbstractConsumerTaskçš„runæ–¹æ³•æ¥å®ç°ï¼Œå…¶runæ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">public void run() {\n    try {\n        while (isRunning) {\n            try {\n                //åˆ¤æ–­æ˜¯å¦æ˜¯æ‰¹é‡æ¶ˆè´¹\n                List&lt;MessageExt&gt; msgs = new ArrayList&lt;&gt;(this.consumer.getConsumeBatchSize());\n                //è¿™é‡Œæ˜¯æ‰¹æ¶ˆè´¹çš„æ ¸å¿ƒï¼Œä¸€æ¬¡ä»é˜Ÿåˆ—ä¸­æå‰å¤šæ¡æ•°æ®ï¼Œä¸€æ¬¡æäº¤åˆ°ç”¨æˆ·æ¶ˆè´¹è€…çº¿ç¨‹\n                while(msgQueue.drainTo(msgs, this.consumer.getConsumeBatchSize()) &lt;= 0 ) {\n                    Thread.sleep(20);\n                }\n                //æ‰§è¡Œå…·ä½“åˆ°æ¶ˆè´¹ä»£ç ï¼Œå°±æ˜¯è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„æ¶ˆè´¹é€»è¾‘ï¼Œä½ç‚¹æäº¤\n                doTask(msgs);\n            } catch (InterruptedException e) {\n                LOGGER.info(Thread.currentThread().getName() + \"is Interrupt\");\n                break;\n            } catch (Throwable e) {\n                LOGGER.error(\"consume message error\", e);\n            }\n        }\n    } catch (Throwable e) {\n        LOGGER.error(\"consume message error\", e);\n    }\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæ¶ˆè´¹çº¿ç¨‹ä»é˜»å¡é˜Ÿåˆ—ä¸­æŠ½å–æ•°æ®è¿›è¡Œæ¶ˆè´¹ã€‚é¡ºåºæ¶ˆè´¹ã€å¹¶å‘æ¶ˆè´¹æ¨¡å‹å…·ä½“çš„é‡è¯•ç­–ç•¥ä¸ä¸€æ ·ï¼Œæ ¹æ®å¯¹åº”çš„å­ç±»å®ç°å³å¯ã€‚</p><h4>Pullçº¿ç¨‹</h4><p>è¿™æ®µä»£ç å¯¹æ ‡çš„æ˜¯æ”¹è¿›æ–¹æ¡ˆä¸­çš„Pullçº¿ç¨‹ï¼Œå®ƒè´Ÿè´£æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶æäº¤åˆ°æ¶ˆè´¹çº¿ç¨‹ã€‚Pullçº¿ç¨‹çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">private void startPullThread() {\n    {\n        //è®¾ç½®çº¿ç¨‹çš„åç§°ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨åˆ†æçº¿ç¨‹æ ˆä¸­å‡†ç¡®æ‰¾åˆ°PULLçº¿ç¨‹\n        String threadName = \"Lite-Push-Pull-Service-\" + this.consumer + \"-\" + LocalDateTime.now();\n        Thread litePushPullService = new Thread(() -&gt; {\n            try {\n                while (isRunning) {\n                    //å¾…è¶…æ—¶æ—¶é—´çš„æ¶ˆæ¯æ‹‰å–\n                    List&lt;MessageExt&gt; records = consumer.poll(consumerPollTimeoutMs);\n                    //å°†æ‹‰å–åˆ°çš„æ¶ˆæ¯æäº¤åˆ°çº¿ç¨‹æ± ï¼Œä»è€Œè§¦å‘æ¶ˆè´¹\n                    submitRecords(records);\n                    //ä¸ºéœ€è¦é™æµçš„é˜Ÿåˆ—å¼€å¯é™æµ\n                    consumerLimitController.pause();\n                    //ä¸ºéœ€è¦è§£é™¤é™æµçš„é˜Ÿåˆ—è§£é™¤é™æµ\n                    consumerLimitController.resume();\n                }\n            } catch (Throwable ex) {\n                LOGGER.error(\"consume poll error\", ex);\n            } finally {\n                stopPullThread();\n            }\n        }, threadName);\n        litePushPullService.start();\n        LOGGER.info(\"Lite Push Consumer started at {}, consumer group name:{}\", System.currentTimeMillis(), this.consumerGroup);\n    }\n}\n\nprivate void submitRecords(List&lt;MessageExt&gt; records) {\n    if (records == null || records.isEmpty()) {\n        return;\n    }\n    MessageExt firstMsg = records.get(0);\n    MessageQueue messageQueue = new MessageQueue(firstMsg.getTopic(), firstMsg.getBrokerName(), firstMsg.getQueueId());\n    // æ ¹æ®é˜Ÿåˆ—è·å–é˜Ÿåˆ—çº§åˆ«æ¶ˆè´¹æœåŠ¡ç±»\n    ConsumeMessageQueueService tempConsumeMessageService = ConsumeMessageQueueServiceFactory.getOrCreateConsumeMessageService(this, messageQueue, isOrderConsumerModel, lastAssignSet);\n    // æäº¤å…·ä½“çš„çº¿ç¨‹æ± \n    tempConsumeMessageService.execute(records);\n}\n</code></pre><p>Pullçº¿ç¨‹åšçš„äº‹æƒ…æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åå¤æ‹‰å–æ¶ˆæ¯ï¼Œç„¶åæŒ‰ç…§MessageQueueæäº¤åˆ°å¯¹åº”çš„ConsumeMessageQueueServiceå»å¤„ç†ï¼Œè¿›å…¥åˆ°æ¶ˆæ¯è½¬å‘æµç¨‹ä¸­ã€‚</p><h4>æ¶ˆæ¯è·¯ç”±æœºåˆ¶</h4><p>æ­¤å¤–ï¼Œä¼˜åŒ–åçš„çº¿ç¨‹æ¨¡å‹è¿˜æœ‰ä¸€ä¸ªé‡ç‚¹ï¼Œé‚£å°±æ˜¯æ¶ˆæ¯çš„æ´¾å‘ï¼Œå®ƒçš„å®ç°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">public void execute(List&lt;MessageExt&gt; consumerRecords) {\n    if (consumerRecords == null || consumerRecords.isEmpty()) {\n        return;\n    }\n\n    // å°†æ¶ˆæ¯æ”¾å…¥åˆ°å¾…æ¶ˆè´¹é˜Ÿåˆ—ä¸­ï¼Œè¿™é‡Œå®é™…æ˜¯ä¸€ä¸ªTreeMapç»“æ„ï¼Œç”¨äºè¿›è¡Œæœ€å°ä½ç‚¹è®¡ç®—\n    putMessage(consumerRecords);\n\n    if (isNeedPause()) {\n        consumer.getConsumerLimitController().addPausePartition(messageQueue);\n    }\n\n    for (MessageExt msg : consumerRecords) {\n        int taskIndex = selectTaskQueue(msg, consumer.getTaskQueueSize());\n        try {\n            consumer.submitMessage(taskIndex, msg);\n        } catch (Throwable e) {\n            // ignore e\n            e.printStackTrace();\n        }\n    }\n\n}\n\npublic class ConsumeMessageQueueOrderlyService extends AbstractConsumeMessageService{\n    private final String NO_KEY_HASH = \"__nokey\";\n    public ConsumeMessageQueueOrderlyService(DefaultMQLitePushConsumer consumer, MessageQueue messageQueue) {\n        super(consumer, messageQueue);\n    }\n\n    @Override\n    protected int selectTaskQueue(MessageExt msg, int taskQueueTotal) {\n        String keys = msg.getKeys();\n        if(StringUtils.isEmpty(keys)) {\n            keys = NO_KEY_HASH;\n        }\n        return  Math.abs(  keys.hashCode()   ) %  taskQueueTotal;\n    }\n}\n</code></pre><p>è¿™é‡Œï¼Œé¡ºåºæ¶ˆè´¹æ¨¡å‹æŒ‰ç…§æ¶ˆæ¯çš„Keyé€‰æ‹©ä¸åŒçš„é˜Ÿåˆ—ï¼Œè€Œæ¯ä¸€ä¸ªé˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå³å®ç°äº†æŒ‰ç…§Keyæ¥é€‰æ‹©çº¿ç¨‹ï¼Œæ¶ˆè´¹å¹¶å‘åº¦ä¸é˜Ÿåˆ—ä¸ªæ•°æ— å…³ã€‚</p><h3>å®Œæ•´ä»£ç </h3><p>è¿™èŠ‚è¯¾æˆ‘ä»¬é‡ç‚¹å±•ç¤ºäº†é¡ºåºæ¶ˆè´¹çº¿ç¨‹æ¨¡å‹çš„æ”¹è¿›æ–¹æ¡ˆã€‚ä½†å®ç°ä¸€ä¸ªæ¶ˆè´¹è€…è‡³å°‘éœ€è¦æ¶‰åŠé˜Ÿåˆ—è‡ªåŠ¨è´Ÿè½½ã€æ¶ˆæ¯æ‹‰å–ã€æ¶ˆæ¯æ¶ˆè´¹ã€ä½ç‚¹æäº¤ã€æ¶ˆè´¹é‡è¯•ç­‰å‡ ä¸ªéƒ¨åˆ†ã€‚å› ä¸ºè¿™ä¸€è®²æˆ‘ä»¬èšç„¦åœ¨é¡ºåºæ¶ˆè´¹æ¨¡å‹çš„å¤„ç†ä¸Šï¼Œå…¶ä»–å†…éƒ¨æœºåˆ¶éƒ½è•´å«åœ¨DefaultMQLitePushConsumerç±»åº“çš„åº•å±‚ä»£ç ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œåªæ˜¯ä½¿ç”¨ï¼Œå°±ä¸å†å‘æ•£äº†ã€‚ä¸è¿‡æˆ‘æŠŠå…¨éƒ¨ä»£ç éƒ½æ”¾åˆ°äº†<a href=\"https://github.com/dingwpmz/infoq_question/tree/main/code\">GitHub</a>ï¼Œä½ å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><h2>æ€»ç»“</h2><p>å¥½äº†ï¼Œæ€»ç»“ä¸€ä¸‹ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ä¸€ä¸ªæˆ‘ç»å†è¿‡çš„çœŸå®æ¡ˆä¾‹ï¼Œçœ‹åˆ°äº†RocketMQé¡ºåºæ¶ˆè´¹æ¨¡å‹çš„ç¼ºé™·ã€‚RocketMQåªæ˜¯å®ç°äº†åˆ†åŒºçº§åˆ«çš„é¡ºåºæ¶ˆè´¹ï¼Œå®ƒçš„å¹¶å‘åº¦å—é™äºä¸»é¢˜ä¸­é˜Ÿåˆ—çš„ä¸ªæ•°ï¼Œä¸ä»…æ€§èƒ½ä½ä¸‹ï¼Œåœ¨é‡åˆ°ç§¯å‹é—®é¢˜æ—¶ï¼Œé™¤äº†æ¨ªå‘æ‰©å®¹ä¹Ÿå‡ ä¹æ²¡æœ‰å…¶ä»–æœ‰æ•ˆçš„åº”å¯¹æ‰‹æ®µã€‚</p><p>åœ¨é«˜å¹¶å‘ç¼–ç¨‹é¢†åŸŸï¼Œé™ä½é”çš„ç²’åº¦æ˜¯æå‡å¹¶å‘æ€§èƒ½å±¡è¯•ä¸çˆ½çš„ç»æ‹›ã€‚æœ¬æ¡ˆä¾‹ä¸­é€šè¿‡å¯¹ä¸šåŠ¡è§„åˆ™çš„ç†è§£ï¼Œæ‰¾åˆ°äº†é™ä½é”ç²’åº¦çš„åŠæ³•ï¼Œé‚£å°±æ˜¯å¤„äºåŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œåªæœ‰å…·æœ‰å…³ç³»çš„ä¸åŒæ¶ˆæ¯æ‰å¿…é¡»ç¡®ä¿é¡ºåºæ€§ã€‚</p><p>åŸºäºè¿™ä¸€æ€è·¯ï¼Œå¹¶å‘åº¦ä»é˜Ÿåˆ—çº§åˆ«é™ä½åˆ°äº†æ¶ˆæ¯çº§åˆ«ï¼Œæ€§èƒ½å¾—åˆ°æ˜¾è‘—æå‡ã€‚</p><h2>è¯¾åé¢˜</h2><p>å­¦å®Œä»Šå¤©çš„å†…å®¹ï¼Œè¯·ä½ æ€è€ƒä¸€ä¸ªé—®é¢˜ã€‚</p><p>RocketMQåœ¨æ¶ˆæ¯æ‹‰å–ä¸­ä½¿ç”¨äº†é•¿è½®è¯¢æœºåˆ¶ï¼Œä½ çŸ¥é“è¿™æ ·è®¾è®¡ç›®çš„æ˜¯ä»€ä¹ˆå—ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>","comments":[{"had_liked":false,"id":352758,"user_name":"james","can_delete":false,"product_type":"c1","uid":1049208,"ip_address":"ä¸Šæµ·","ucode":"5701899403917C","user_header":"https://static001.geekbang.org/account/avatar/00/10/02/78/23c56bce.jpg","comment_is_top":false,"comment_ctime":1658915678,"is_pvip":false,"replies":[{"id":129405,"content":"ä½ å¥½ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘æ˜¯è¿™ä¹ˆçœ‹çš„ã€‚ä¸šåŠ¡ä»£ç æ˜¯è¦ä¼˜åŒ–ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯è¦å°½é‡åœ¨æ¡†æ¶å±‚é¢ä½œå‡ºæ›´å¥½çš„ä¼˜åŒ–ï¼Œæä¾›ä¸€äº›å¯å¹²é¢„çš„æœºåˆ¶ï¼Œä¾‹å¦‚é€šè¿‡è°ƒæ•´æ¶ˆè´¹çº¿ç¨‹æ•°èƒ½çœŸæ­£å‘æŒ¥å‡ºä½œç”¨ã€‚\n\næˆ‘åœ¨å¼€å¤´é‡åˆ°çš„çª˜å¢ƒå°±æ˜¯å•ä¸ªé˜Ÿåˆ—ç§¯å‹äº†1000å¤šä¸‡æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ— æ³•åŠ å¿«è¿›åº¦ï¼Œé‚£ä¸ªæ— åŠ©æ„Ÿã€‚\n\nç»è¿‡æˆ‘ç°åœ¨çš„ä¼˜åŒ–æ¨¡å‹åï¼Œé¡¹ç›®ç»„ä½¿ç”¨ç›¸åŒçš„ä»£ç ï¼Œå·²ç»å¯ä»¥æ¯«æ— å‹åŠ›æ‰›è¿‡åŒåä¸€äº†ã€‚æ¨å¹¿æˆæœ¬éå¸¸ä½ï¼Œæ— éœ€æ‰©å®¹ï¼Œèƒ½å……åˆ†å‘æŒ¥å•å°æœºå™¨çš„èµ„æºï¼Œèµ„æºåˆ©ç”¨ç‡ä¹Ÿæé«˜äº†ï¼Œå¥½å¤„è¿˜æ˜¯å¾ˆå¤šçš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1661575121,"ip_address":"ä¸Šæµ·","comment_id":352758,"utype":1}],"discussion_count":5,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"å…¶å®é¡ºåºæ¶ˆè´¹é€Ÿç‡çš„ç“¶é¢ˆåœ¨ä¸šåŠ¡ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹è€…çš„å¤„ç†é€»è¾‘ï¼Œå¹¶ä¸åœ¨MQ, æ„Ÿè§‰è¿™ä¸ªæ–¹æ¡ˆèµ°åäº†ï¼Œæ ¹æ®é˜¿å§†è¾¾å°”å®šå¾‹ï¼Œä½ åº”è¯¥åšçš„æ˜¯æ”¹å˜æœ€èƒ½æå‡æ€§èƒ½çš„åœ°æ–¹ï¼Œè€Œä¸æ˜¯åœ¨ä¸€ä¸ªæœ¬æ¥å°±å¾ˆå¿«çš„åœ°æ–¹","like_count":2,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585451,"discussion_content":"ä½ å¥½ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘æ˜¯è¿™ä¹ˆçœ‹çš„ã€‚ä¸šåŠ¡ä»£ç æ˜¯è¦ä¼˜åŒ–ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯è¦å°½é‡åœ¨æ¡†æ¶å±‚é¢ä½œå‡ºæ›´å¥½çš„ä¼˜åŒ–ï¼Œæä¾›ä¸€äº›å¯å¹²é¢„çš„æœºåˆ¶ï¼Œä¾‹å¦‚é€šè¿‡è°ƒæ•´æ¶ˆè´¹çº¿ç¨‹æ•°èƒ½çœŸæ­£å‘æŒ¥å‡ºä½œç”¨ã€‚\n\næˆ‘åœ¨å¼€å¤´é‡åˆ°çš„çª˜å¢ƒå°±æ˜¯å•ä¸ªé˜Ÿåˆ—ç§¯å‹äº†1000å¤šä¸‡æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ— æ³•åŠ å¿«è¿›åº¦ï¼Œé‚£ä¸ªæ— åŠ©æ„Ÿã€‚\n\nç»è¿‡æˆ‘ç°åœ¨çš„ä¼˜åŒ–æ¨¡å‹åï¼Œé¡¹ç›®ç»„ä½¿ç”¨ç›¸åŒçš„ä»£ç ï¼Œå·²ç»å¯ä»¥æ¯«æ— å‹åŠ›æ‰›è¿‡åŒåä¸€äº†ã€‚æ¨å¹¿æˆæœ¬éå¸¸ä½ï¼Œæ— éœ€æ‰©å®¹ï¼Œèƒ½å……åˆ†å‘æŒ¥å•å°æœºå™¨çš„èµ„æºï¼Œèµ„æºåˆ©ç”¨ç‡ä¹Ÿæé«˜äº†ï¼Œå¥½å¤„è¿˜æ˜¯å¾ˆå¤šçš„ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1661575121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1683951,"avatar":"https://static001.geekbang.org/account/avatar/00/19/b1/ef/2356b51e.jpg","nickname":"dudu-benny","note":"","ucode":"026ECAC9AFDE0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582091,"discussion_content":"ä½ çš„è¯´æ³•æˆ‘ä¹Ÿè¡¨ç¤ºèµåŒï¼Œè€Œè¿™ç§åšæ³•æ˜¯ç«™åœ¨å…¬å¸è§’åº¦è€ƒè™‘çš„ï¼Œæˆ‘è®°å¾—æ–‡ä¸­æåˆ°å¢åŠ æœåŠ¡å™¨æ•°é‡æ¥æ¶ˆè´¹MQæ¶ˆæ¯ï¼Œè¿˜æœªèƒ½å¾—åˆ°å¾ˆå¥½çš„è§£å†³ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªæˆæœ¬é—®é¢˜ï¼Œè€Œè¿™ä¸ªé—®é¢˜çš„å…³é”®æ˜¯ï¼Œè€å¸ˆ(ä½œè€…)ç¡®å¾ˆå¥½çš„å‘Šè¯‰æˆ‘ä»¬ï¼Œä»å…¬å¸è§’åº¦è€ƒè™‘å¢åŠ æˆæœ¬è€Œæœªèƒ½å¾—åˆ°å¾ˆå¥½çš„è§£å†³çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯è¦å›è¿‡å¤´æ¥è€ƒè™‘ä¸€ä¸‹æˆ‘ä»¬ä½¿ç”¨çš„å·¥å…· è¿˜æœ‰æ²¡æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œå³ä½¿æ˜¯ä¸€å¤„å¯èƒ½ä¼šé™ä½æˆ‘ä»¬çš„æˆæœ¬ï¼Œè¿™å¯èƒ½å°±æ˜¯ä½œè€…çš„æœ¬æ„  å…¶å®å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä½œä¸ºæŠ€æœ¯äººå‘˜ è€ƒè™‘çš„é—®é¢˜åº”è¯¥å¤šæ–¹é¢å…¥æ‰‹    ä¸åèµæ•™","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1659204219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1806700,"avatar":"","nickname":"Geek_460f3a","note":"","ucode":"1B938DA91E86F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608283,"discussion_content":"é¦–å…ˆè€ƒè™‘è‚¯å®šæ˜¯ä¼˜åŒ–ä¸šåŠ¡ä»£ç ï¼Œæ²¡æœ‰ä¼˜åŒ–ç©ºé—´äº†å°±ä¼šè€ƒè™‘æ˜¯ä¸æ˜¯ä¸­é—´ä»¶æœ¬èº«å°±æœ‰è®¾è®¡é—®é¢˜ï¼Œä¼šä¸ä¼šæ¶ˆæ¯è¾¾åˆ°æŸä¸ªé‡çº§åï¼Œåˆæ˜¯ä½¿ç”¨çš„é¡ºåºæ¶ˆæ¯ï¼ŒåŠ é”å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼ŒåŒä¸€ä¸ªé˜Ÿåˆ—å¿…é¡»ä¸²è¡Œæ¶ˆè´¹ï¼Œè¿™äº›ç§ç§å› ç´ å¯¼è‡´æ¶ˆè´¹è€…å°±æ˜¯æ¯”ç”Ÿäº§è€…æ…¢ï¼Œç„¶åè¾¾åˆ°é˜ˆå€¼åè§¦å‘æ¶ˆè´¹è€…é™æµï¼Œå¯¼è‡´æ¶ˆè´¹è€…ä¸å»æ‹‰æ•°æ®äº†ï¼Œé—®é¢˜æ¥ç€è¢«æ”¾å¤§ï¼Œ1000ä¸‡æ¶ˆæ¯åªæœ‰64ä¸ªå¹¶å‘åº¦ï¼Œç¡®å®éœ€è¦å¾ˆä¹…æ‰èƒ½æ¶ˆè´¹å®Œï¼Œç»è¿‡è€å¸ˆæ”¹é€ åå¹¶è¡Œåº¦å¯ä»¥è‡ªç”±è°ƒé…ï¼Œæˆ‘è§‰å¾—æ˜¯ä¸ªä¸é”™çš„æ–¹æ¡ˆï¼Œåªæ˜¯æ„Ÿè§‰å®˜æ–¹åº”è¯¥å€Ÿé‰´è¿™ç§æ€è·¯ï¼Œå®ç°æ›´ä¸ºå®Œå–„çš„é¡ºåºæ¶ˆæ¯æ–¹æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678359328,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1806700,"avatar":"","nickname":"Geek_460f3a","note":"","ucode":"1B938DA91E86F8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607925,"discussion_content":"å¯èƒ½å°±æ˜¯é¡ºåºæ¶ˆæ¯è¦åŠ é”ï¼Œå¯¼è‡´ç§¯å‹æ¶ˆæ¯1000ä¸‡å§ï¼Œè¿™ç§è§£æ³•å¾ˆæœ‰æ•ˆï¼Œmqå®˜æ–¹ä¸æ‰“ç®—å€Ÿé‰´ä¸€æ³¢å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678189213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1007294,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/be/9ea55f46.jpg","nickname":"feihui","note":"","ucode":"13F1D4A82BC650","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585658,"discussion_content":"èµåŒä½ çš„çœ‹æ³•ï¼Œæœ¬èº«è·Ÿ MQ æ²¡å•¥å…³ç³»ï¼Œä¸€èˆ¬åœºæ™¯ä¸‹ï¼Œæé«˜æ¶ˆè´¹ååé‡éƒ½æ˜¯ä¸€æ¬¡æ€§æ‹‰å»ä¸€æ‰¹æ•°æ®ç„¶åå¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹ï¼Œå®é™…ä¸Šä½œè€…çš„è§£æ³•ä¹Ÿæ˜¯å¢åŠ äº†é˜Ÿåˆ—æ•°é‡æ¥æå‡æ¶ˆè´¹ååï¼Œåªä¸è¿‡å¢åŠ çš„æ˜¯ä¸šåŠ¡è‡ªå·±çš„é˜Ÿåˆ—ï¼Œè¿™ä¸ªå¼€å¤´çš„æ¡ˆä¾‹æˆ‘è§‰å¾—æ›´åˆé€‚çš„åº”è¯¥æ˜¯å…ˆæ€è€ƒä¸ºå•¥ä¸ºå †ç§¯å¤§é‡æ¶ˆæ¯ï¼æ˜¯ç›‘æ§å‘Šè­¦ç¼ºå¤±ï¼Ÿè¿˜æ˜¯å®¹é‡è¯„ä¼°æœ‰è¯¯ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661752509,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359390,"user_name":"Louise","can_delete":false,"product_type":"c1","uid":1254961,"ip_address":"æµ™æ±Ÿ","ucode":"2C8AE5FB129363","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/31/4318a7fa.jpg","comment_is_top":false,"comment_ctime":1665491863,"is_pvip":false,"replies":[{"id":134239,"content":"å—¯ï¼Œå¥½çš„ï¼Œä»Šå¹´æˆ‘é€æ­¥æ›´æ–°ä¸€ä¸‹ç­”æ¡ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1676469434,"ip_address":"ä¸Šæµ·","comment_id":359390,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"ä½ å¥½ï¼Œä¸å¨è€å¸ˆèƒ½ä¸èƒ½è¯¾åé¢˜ç›®éƒ½æœ‰ä¸ªç­”æ¡ˆï¼Œåƒmysql45è®²ä¸“æ ä¸€æ ·å‘¢ï¼Ÿå› ä¸ºè‡ªå·±è¿™æ–¹é¢æ¥è§¦å°‘ï¼Œæœ‰äº›é—®é¢˜è¿˜çœŸæƒ³ä¸å‡ºæ¥ï¼Œçœ‹è¯„è®ºä¹Ÿçœ‹çš„ä¸æ˜¯å¾ˆæ‡‚","like_count":1,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":604888,"discussion_content":"å—¯ï¼Œå¥½çš„ï¼Œä»Šå¹´æˆ‘é€æ­¥æ›´æ–°ä¸€ä¸‹ç­”æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676469434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":357045,"user_name":"è¶Šè¿‡å±±ä¸˜","can_delete":false,"product_type":"c1","uid":2124269,"ip_address":"ä¸Šæµ·","ucode":"A0CBF5C8E09CEE","user_header":"https://static001.geekbang.org/account/avatar/00/20/69/ed/2ea74ecd.jpg","comment_is_top":false,"comment_ctime":1662883664,"is_pvip":false,"replies":[{"id":130038,"content":"ç†è§£éå¸¸æ­£ç¡®ï¼Œè¿™ä¹Ÿæ˜¯RocketMQå‡ºç°æ¶ˆè´¹ç§¯å‹çš„å…³é”®æ‰€åœ¨ï¼Œå› ä¸ºä¸€æ—¦å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå°±ä¼šåœ¨rocketmqå®¢æˆ·ç«¯è§¦å‘é™æµï¼Œå…·ä½“å°±æ˜¯ä¸å†å¾€æœåŠ¡å™¨æ‹‰å–æ–°çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨brokerçš„åç§»é‡ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œæ¶ˆè´¹ä½ç‚¹ä¸€ç›´æ— æ³•å‘å‰æ¨è¿›ï¼Œä»è€Œäº§ç”Ÿæ¶ˆè´¹ç§¯å‹é—®é¢˜","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1663167458,"ip_address":"ä¸Šæµ·","comment_id":357045,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"ä¸å¨è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹ï¼Œå¦‚æœä¸€æ‰¹æ¶ˆæ¯ä¸­æœ‰ä¸€æ¡æ¶ˆæ¯å‡ºäº†é—®é¢˜ï¼Œå¯¼è‡´é˜»å¡äº†ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹å¾ˆé•¿æ—¶é—´ï¼ŒæŒ‰ç…§æœ€å°ä½ç‚¹æäº¤çš„ç­–ç•¥ï¼Œè¿™ä¸ªæ˜¯ä¸æ˜¯ä¼šå¯¼è‡´ä½ç‚¹ä¸€ç›´ä¸æ¨è¿›äº†","like_count":1,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587606,"discussion_content":"ç†è§£éå¸¸æ­£ç¡®ï¼Œè¿™ä¹Ÿæ˜¯RocketMQå‡ºç°æ¶ˆè´¹ç§¯å‹çš„å…³é”®æ‰€åœ¨ï¼Œå› ä¸ºä¸€æ—¦å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå°±ä¼šåœ¨rocketmqå®¢æˆ·ç«¯è§¦å‘é™æµï¼Œå…·ä½“å°±æ˜¯ä¸å†å¾€æœåŠ¡å™¨æ‹‰å–æ–°çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨brokerçš„åç§»é‡ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œæ¶ˆè´¹ä½ç‚¹ä¸€ç›´æ— æ³•å‘å‰æ¨è¿›ï¼Œä»è€Œäº§ç”Ÿæ¶ˆè´¹ç§¯å‹é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663167459,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367895,"user_name":"Geek_9a02e8","can_delete":false,"product_type":"c1","uid":3221289,"ip_address":"ç¦å»º","ucode":"9E3D77B9F592B0","user_header":"","comment_is_top":false,"comment_ctime":1675731174,"is_pvip":false,"replies":[{"id":134245,"content":"è°¢è°¢ä½ çš„æé—®ï¼Œä¸ºä½ çš„æ€è€ƒç‚¹èµã€‚\n1ã€æˆ‘ç¨å¾®å†è¡¥å……ä¸€ä¸‹æœ€å°ä½ç‚¹æäº¤æœºåˆ¶ã€‚ä¾‹å¦‚åç§»é‡ä»å°åˆ°åˆ°å¤§æ’åºä¸º m1,m2,m3,m4,m5,å¦‚æœm5æ¶ˆè´¹æˆåŠŸäº†ï¼Œæ­¤æ—¶ä¼šä¸ŠæŠ¥m1,å¦‚æœm2,m3,m3,m5éƒ½æ¶ˆè´¹äº†ï¼Œè¿˜æ˜¯æäº¤m1,ä½†å¦‚æœm1æ¶ˆè´¹å®Œæˆï¼Œå¦‚æœå¤„ç†é˜Ÿåˆ—ç°åœ¨ä¸ºç©ºï¼Œé‚£æäº¤å“ªä¸ªä½ç‚¹å‘¢ï¼Œå…¶å®è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šæäº¤ä½ç‚¹m5ï¼Œå› ä¸ºåœ¨æ‹‰å–çš„æ—¶å€™ï¼Œè®°å½•äº†å®¢æˆ·ç«¯æ‹‰å–çš„æœ€å¤§ä½ç‚¹ã€‚ä½†è¿™ç§æœºåˆ¶ç¡®å®ä¼šå¸¦æ¥éƒ¨åˆ†æ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹ï¼Œæˆ‘åœ¨è¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†RocketMQä¸­å“ªäº›è®¾è®¡ä¼šå¸¦æ¥é‡å¤æ¶ˆè´¹ï¼šhttps:&#47;&#47;mp.weixin.qq.com&#47;s&#47;wWgAbFLuesdb3BhY3GjxPg\n\n2ã€è¿™ä¸ªå»ºè®®ä½ é‡ç‚¹çœ‹ä¸€ä¸‹ConsumeMessageOrderlyServiceçš„submitConsumeRequestï¼Œå¹¶ä¸”å¤šçº¿ç¨‹æ˜¯åªæ˜¯ç«äº‰æ‰§è¡Œï¼Œè·å¾—é”åè¿˜æ˜¯ä»é˜Ÿåˆ—ä¸­æŒ‰é¡ºåºè·å–æ¶ˆæ¯çš„ï¼Œä¹Ÿå°±æ˜¯é¡ºåºæ¶ˆè´¹ConsumeRequestè¿™ä¸ªä»»åŠ¡ï¼Œå¹¶æ²¡æœ‰å…³è”å…·ä½“çš„æ¶ˆæ¯ï¼Œè€Œåªä¼ å…¥äº†processQueueã€MessageQueueï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯é¡ºåºå¤„ç†æ¶ˆæ¯\n\n3ã€è¿™ä¸ªå¯èƒ½éœ€è¦ä½ çœ‹çœ‹æ˜¯å“ªä¸ªåœ°æ–¹ä¸æ‡‚ã€‚æˆ‘è¿™é‡Œä¹Ÿå°è¯•è¡¥å……ä¸€ä¸‹ï¼Œæ‰€è°“çš„é˜Ÿåˆ—ï¼Œé€šå¸¸æ˜¯æŒ‡æ¶ˆè´¹é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯MessageQueueï¼Œè¿˜æœ‰ä¸€ä¸ªæœ¬åœ°å¤„ç†é˜Ÿåˆ—(ProcessQueue)ï¼Œåœ¨å®¢æˆ·ç«¯æ¶ˆè´¹æ—¶ç”¨äºæœ€å°ä½ç‚¹æäº¤ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1676474816,"ip_address":"ä¸Šæµ·","comment_id":367895,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"1ã€ä¸ŠæŠ¥æœ€å°ä½ç‚¹ï¼Ÿé‚£ä¸æ˜¯ä¸‹æ¬¡æ‹‰å–çš„æ—¶å€™è¿˜ä»è¿™ä¸ªåç§»é‡å¼€å§‹æ‹‰å–ï¼Œä¸æ˜¯ä¸€ç›´é‡å¤æ‹‰åŒä¸€æ‰¹æ•°æ®äº†å—ï¼Ÿ\n2ã€å¼€å§‹çš„é¡ºåºæ¶ˆè´¹æ¨¡å‹æ€ä¹ˆä¿è¯é˜Ÿåˆ—é¡ºåºçš„ï¼Ÿè™½ç„¶å–æ•°æ®åˆ°æäº¤çš„è¿‡ç¨‹éƒ½åŠ é”äº†ï¼Œå¯æ˜¯å®é™…æ¶ˆè´¹æ˜¯æ”¾åˆ°æ¶ˆè´¹çº¿ç¨‹æ± äº†å‘€ï¼Œè¿™ç§å¼‚æ­¥æ²¡æ³•ä¿è¯é¡ºåºçš„å§ï¼Ÿ\n3 å¥½å¤šåœ°æ–¹æåˆ°é˜Ÿåˆ—ï¼Œæˆ‘éƒ½åˆ†ä¸æ¸…æ˜¯å®¢æˆ·ç«¯çš„ä»€ä¹ˆé˜Ÿåˆ—è¿˜æ˜¯æœåŠ¡ç«¯çš„ä»€ä¹ˆé˜Ÿåˆ—äº†â€¦","like_count":0,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":604905,"discussion_content":"è°¢è°¢ä½ çš„æé—®ï¼Œä¸ºä½ çš„æ€è€ƒç‚¹èµã€‚\n1ã€æˆ‘ç¨å¾®å†è¡¥å……ä¸€ä¸‹æœ€å°ä½ç‚¹æäº¤æœºåˆ¶ã€‚ä¾‹å¦‚åç§»é‡ä»å°åˆ°åˆ°å¤§æ’åºä¸º m1,m2,m3,m4,m5,å¦‚æœm5æ¶ˆè´¹æˆåŠŸäº†ï¼Œæ­¤æ—¶ä¼šä¸ŠæŠ¥m1,å¦‚æœm2,m3,m3,m5éƒ½æ¶ˆè´¹äº†ï¼Œè¿˜æ˜¯æäº¤m1,ä½†å¦‚æœm1æ¶ˆè´¹å®Œæˆï¼Œå¦‚æœå¤„ç†é˜Ÿåˆ—ç°åœ¨ä¸ºç©ºï¼Œé‚£æäº¤å“ªä¸ªä½ç‚¹å‘¢ï¼Œå…¶å®è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šæäº¤ä½ç‚¹m5ï¼Œå› ä¸ºåœ¨æ‹‰å–çš„æ—¶å€™ï¼Œè®°å½•äº†å®¢æˆ·ç«¯æ‹‰å–çš„æœ€å¤§ä½ç‚¹ã€‚ä½†è¿™ç§æœºåˆ¶ç¡®å®ä¼šå¸¦æ¥éƒ¨åˆ†æ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹ï¼Œæˆ‘åœ¨è¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†RocketMQä¸­å“ªäº›è®¾è®¡ä¼šå¸¦æ¥é‡å¤æ¶ˆè´¹ï¼šhttps://mp.weixin.qq.com/s/wWgAbFLuesdb3BhY3GjxPg\n\n2ã€è¿™ä¸ªå»ºè®®ä½ é‡ç‚¹çœ‹ä¸€ä¸‹ConsumeMessageOrderlyServiceçš„submitConsumeRequestï¼Œå¹¶ä¸”å¤šçº¿ç¨‹æ˜¯åªæ˜¯ç«äº‰æ‰§è¡Œï¼Œè·å¾—é”åè¿˜æ˜¯ä»é˜Ÿåˆ—ä¸­æŒ‰é¡ºåºè·å–æ¶ˆæ¯çš„ï¼Œä¹Ÿå°±æ˜¯é¡ºåºæ¶ˆè´¹ConsumeRequestè¿™ä¸ªä»»åŠ¡ï¼Œå¹¶æ²¡æœ‰å…³è”å…·ä½“çš„æ¶ˆæ¯ï¼Œè€Œåªä¼ å…¥äº†processQueueã€MessageQueueï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯é¡ºåºå¤„ç†æ¶ˆæ¯\n\n3ã€è¿™ä¸ªå¯èƒ½éœ€è¦ä½ çœ‹çœ‹æ˜¯å“ªä¸ªåœ°æ–¹ä¸æ‡‚ã€‚æˆ‘è¿™é‡Œä¹Ÿå°è¯•è¡¥å……ä¸€ä¸‹ï¼Œæ‰€è°“çš„é˜Ÿåˆ—ï¼Œé€šå¸¸æ˜¯æŒ‡æ¶ˆè´¹é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯MessageQueueï¼Œè¿˜æœ‰ä¸€ä¸ªæœ¬åœ°å¤„ç†é˜Ÿåˆ—(ProcessQueue)ï¼Œåœ¨å®¢æˆ·ç«¯æ¶ˆè´¹æ—¶ç”¨äºæœ€å°ä½ç‚¹æäº¤ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676474816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3221289,"avatar":"","nickname":"Geek_9a02e8","note":"","ucode":"9E3D77B9F592B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":605628,"discussion_content":"æ„Ÿè°¢è€å¸ˆçš„è€å¿ƒè§£ç­”ã€‚\n1ã€è¿™ä¸ªå·²ç»æ˜ç™½äº†\n2ã€æ„æ€æ˜¯è¯´å…ˆæŠ¢åˆ°é”çš„æ‰å»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªæ•°æ®æ˜¯å§ï¼Ÿé‚£å¹¶è¡Œçš„æ—¶å€™ å› ä¸ºä¸šåŠ¡å¤„ç†æ—¶é•¿ æˆ–è€…ç½‘ç»œæ³¢åŠ¨ä¹‹ç±»çš„ è¿˜æ˜¯å¯èƒ½å‡ºç° åæäº¤çš„æ¶ˆæ¯å…ˆæ¶ˆè´¹æˆåŠŸå§ï¼Ÿ\n3ã€æ˜¯è¯´æ–‡ä¸­é˜Ÿåˆ—å†™çš„æœ‰å‡ ä¸ªå«ä¹‰ï¼ŒæœåŠ¡ç«¯ç«¯çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®¢æˆ·ç«¯çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚ç„¶åæœ‰ç‚¹çœ‹è¿·ç³Šäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676802271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":604905,"ip_address":"æ±Ÿè¥¿","group_id":0},"score":605628,"extra":""}]}]},{"had_liked":false,"id":366093,"user_name":"å˜‰å˜‰â˜•","can_delete":false,"product_type":"c1","uid":1059771,"ip_address":"æµ™æ±Ÿ","ucode":"632A5CC4B53BB1","user_header":"https://static001.geekbang.org/account/avatar/00/10/2b/bb/5cf70df8.jpg","comment_is_top":false,"comment_ctime":1673398999,"is_pvip":false,"replies":[{"id":134272,"content":"ä½ å¥½ï¼Œæˆ‘è§‰å¾—ä¸ç®—ï¼Œè™½ç„¶åœ¨å‘é€é˜¶æ®µï¼Œä¼šæŒ‰ç…§keyé€‰æ‹©é˜Ÿåˆ—ï¼Œä½†ä¸€æ—¦è¿›å…¥äº†é˜Ÿåˆ—ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯å°±å¿…é¡»ä¸€æ¡ä¸€æ¡é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚ å­˜åœ¨ k1,k2,k3,k1çš„æ¶ˆæ¯ï¼Œé‚£é¡ºåºå°±å›ºå®šäº†ï¼Œè€Œæ–‡ç« ä¸­æå‡ºçš„æ–¹æ¡ˆï¼Œå°½ç®¡k1,k2,k3,k1çš„æ¶ˆæ¯è¿›å…¥çš„æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†æˆ‘è¿˜å¯ä»¥è®©k1,k2,k3å¹¶å‘æ¶ˆè´¹ï¼Œå› ä¸ºä»–ä»¬ä»£è¡¨ä¸åŒçš„ä¸šåŠ¡å®ä½“ï¼Œä¾‹å¦‚ä¸åŒçš„é“¶è¡Œå¡è´¦å·ï¼Œç›¸äº’ä¹‹é—´æ— å…³è”ï¼Œå¯ä»¥å¹¶å‘ï¼Œä½†ä¸¤æ¡k1,å°±å¿…é¡»é¡ºåºæ‰§è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1676561333,"ip_address":"ä¸Šæµ·","comment_id":366093,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"è€å¸ˆå¥½ï¼Œè¯·é—®ä¸‹ï¼Œrocketmqå®ç°çš„é¡ºåºæ¶ˆè´¹ ä¸ç®—æ˜¯å…³è”é¡ºåºæ€§å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":605043,"discussion_content":"ä½ å¥½ï¼Œæˆ‘è§‰å¾—ä¸ç®—ï¼Œè™½ç„¶åœ¨å‘é€é˜¶æ®µï¼Œä¼šæŒ‰ç…§keyé€‰æ‹©é˜Ÿåˆ—ï¼Œä½†ä¸€æ—¦è¿›å…¥äº†é˜Ÿåˆ—ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯å°±å¿…é¡»ä¸€æ¡ä¸€æ¡é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚ å­˜åœ¨ k1,k2,k3,k1çš„æ¶ˆæ¯ï¼Œé‚£é¡ºåºå°±å›ºå®šäº†ï¼Œè€Œæ–‡ç« ä¸­æå‡ºçš„æ–¹æ¡ˆï¼Œå°½ç®¡k1,k2,k3,k1çš„æ¶ˆæ¯è¿›å…¥çš„æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†æˆ‘è¿˜å¯ä»¥è®©k1,k2,k3å¹¶å‘æ¶ˆè´¹ï¼Œå› ä¸ºä»–ä»¬ä»£è¡¨ä¸åŒçš„ä¸šåŠ¡å®ä½“ï¼Œä¾‹å¦‚ä¸åŒçš„é“¶è¡Œå¡è´¦å·ï¼Œç›¸äº’ä¹‹é—´æ— å…³è”ï¼Œå¯ä»¥å¹¶å‘ï¼Œä½†ä¸¤æ¡k1,å°±å¿…é¡»é¡ºåºæ‰§è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676561333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":364558,"user_name":"æ–‡æ•¦å¤","can_delete":false,"product_type":"c1","uid":1195258,"ip_address":"å››å·","ucode":"B8F4A6BD5D7805","user_header":"https://static001.geekbang.org/account/avatar/00/12/3c/fa/e2990931.jpg","comment_is_top":false,"comment_ctime":1671115030,"is_pvip":false,"replies":[{"id":134275,"content":"å—¯ï¼Œè¿™ä¸ªå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ‰©å®¹çš„æ–¹å¼æ¥å‡å°‘å¯¹æ–°æ¶ˆæ¯çš„å½±å“ï¼ˆå®¹å¿ä¸€å®šçš„é¡ºåºæ€§è¯­ä¹‰ç ´åï¼‰ï¼Œä½†åŸå…ˆç§¯å‹çš„æ¶ˆæ¯ï¼Œæ²¡é‚£ä¹ˆå¿«æ¶ˆè€—æ‰ï¼Œè€Œä¸”æˆ‘è®°å¾—å½“æ—¶ä¸šåŠ¡ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œé‡Œé¢å„ç§è°ƒç”¨dubboæ¥å£ï¼Œé€Ÿåº¦æå‡å…¶ä»–æ¯”è¾ƒå›°éš¾ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1676561786,"ip_address":"ä¸Šæµ·","comment_id":364558,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"æä¸ªæ€è·¯ï¼Œè¯·æ•™ä¸‹ï¼š1ä¼˜åŒ–æ¶ˆè´¹è€…ä»£ç ï¼Œå¦‚æœä¸è¡Œï¼Œé‚£ä¹ˆ2æå‡æ¶ˆè´¹è€…æ•°é‡ï¼Œå¦‚æœå·²ç»è¾¾åˆ°é˜Ÿåˆ—é•¿åº¦ï¼Œé‚£ä¹ˆ3é‡å»ºä¸€ä¸ªé•¿åº¦é˜Ÿåˆ—æ›´å¤§çš„ä¸»é¢˜ï¼Œæ”¹åŸæ¶ˆè´¹è€…ä»£ç ä¸ºæŒ‰ç…§ä¸šåŠ¡é€»è¾‘é‡æ–°åˆ†å‘æ¶ˆæ¯åˆ°æ–°çš„ä¸»é¢˜ï¼Œè€çš„æ¶ˆè´¹è€…ä»£ç æ”¾åˆ°æ–°çš„æ¶ˆè´¹è€…è¿™é‡Œã€‚ä¸çŸ¥é“å¦‚ä½•è¯„ä»·ï¼ŸğŸ˜…","like_count":0,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":605046,"discussion_content":"å—¯ï¼Œè¿™ä¸ªå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ‰©å®¹çš„æ–¹å¼æ¥å‡å°‘å¯¹æ–°æ¶ˆæ¯çš„å½±å“ï¼ˆå®¹å¿ä¸€å®šçš„é¡ºåºæ€§è¯­ä¹‰ç ´åï¼‰ï¼Œä½†åŸå…ˆç§¯å‹çš„æ¶ˆæ¯ï¼Œæ²¡é‚£ä¹ˆå¿«æ¶ˆè€—æ‰ï¼Œè€Œä¸”æˆ‘è®°å¾—å½“æ—¶ä¸šåŠ¡ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œé‡Œé¢å„ç§è°ƒç”¨dubboæ¥å£ï¼Œé€Ÿåº¦æå‡å…¶ä»–æ¯”è¾ƒå›°éš¾ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1676561786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363678,"user_name":"Geek_9d39c4","can_delete":false,"product_type":"c1","uid":3017885,"ip_address":"ä¸Šæµ·","ucode":"EAB127762F220B","user_header":"","comment_is_top":false,"comment_ctime":1669971421,"is_pvip":false,"replies":[{"id":134276,"content":"RocketMQå®˜æ–¹å®ç°æ˜¯çš„ï¼Œå› ä¸ºä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œéœ€è¦ä¸€æ¡ä¸€æ¡å¤„ç†ï¼Œåªæœ‰å‰é¢ä¸€æ¡å¤„ç†æˆåŠŸï¼Œæ‰ä¼šç»§ç»­å¤„ç†ä¸‹ä¸€æ¡ã€‚è€Œä¸”rocketmqé¡ºåºæ¶ˆè´¹çš„é‡è¯•æ¬¡æ•°ä¸º Interger.MAX_VALUE","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1676562301,"ip_address":"ä¸Šæµ·","comment_id":363678,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"è€å¸ˆè¯·æ•™ä¸€ä¸‹é¡ºåºæ¶ˆè´¹ å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªé˜Ÿåˆ— order1çš„çŠ¶æ€å˜è¿å‘é€åˆ°q1 order2çš„å‘é€åˆ°q2 order3çš„å‘é€åˆ°q1 æ­¤æ—¶order3æ˜¯ä¸æ˜¯è¦ç­‰order1å…¨éƒ¨éƒ½æ¶ˆè´¹å®Œæ‰èƒ½æ¶ˆè´¹order3","like_count":0,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":605050,"discussion_content":"RocketMQå®˜æ–¹å®ç°æ˜¯çš„ï¼Œå› ä¸ºä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œéœ€è¦ä¸€æ¡ä¸€æ¡å¤„ç†ï¼Œåªæœ‰å‰é¢ä¸€æ¡å¤„ç†æˆåŠŸï¼Œæ‰ä¼šç»§ç»­å¤„ç†ä¸‹ä¸€æ¡ã€‚è€Œä¸”rocketmqé¡ºåºæ¶ˆè´¹çš„é‡è¯•æ¬¡æ•°ä¸º Interger.MAX_VALUE","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676562301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3017885,"avatar":"","nickname":"Geek_9d39c4","note":"","ucode":"EAB127762F220B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":610164,"discussion_content":"æ„Ÿè°¢è€å¸ˆ \n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679416483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":605050,"ip_address":"ä¸Šæµ·","group_id":0},"score":610164,"extra":""}]}]},{"had_liked":false,"id":354851,"user_name":"æ”¾ä¸ä¸‹è£åå¯Œè´µ","can_delete":false,"product_type":"c1","uid":2053679,"ip_address":"ä¸Šæµ·","ucode":"9FE29C22B9ABE3","user_header":"https://static001.geekbang.org/account/avatar/00/1f/56/2f/4518f8e1.jpg","comment_is_top":false,"comment_ctime":1660821444,"is_pvip":false,"replies":[{"id":129390,"content":"ä½ å¥½ï¼Œæ‰€ä»¥ä½œè€…çš„æ–¹æ¡ˆæ˜¯ï¼šåœ¨é¡ºåºæ¶ˆè´¹é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å†…å¼•å…¥çº¿ç¨‹æ± ï¼Œå†æ¬¡æ‹†åˆ†å¯å¹¶è¡Œçš„ä»»åŠ¡è¿›è¡Œæ‰§è¡Œï¼Ÿè¿™ä¸ªæ˜¯å¯¹çš„ã€‚\n\nä½†ååŠéƒ¨åˆ†ä¸æ˜¯è¿™æ ·çš„ï¼Œä½ç‚¹æäº¤ï¼Œè¿˜æ˜¯ä½¿ç”¨æœ€å°ä½ç‚¹æäº¤ï¼Œä»£ç ä¸­è¿˜æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå¤„ç†é˜Ÿåˆ—&lt;MessageQueue, TreeMap&lt;Long,Msg&gt;&gt;è¿™æ ·çš„ç»“æ„ï¼Œä½ç‚¹æäº¤è¿˜æ˜¯æäº¤å¤„ç†é˜Ÿåˆ—ä¸­æœ€å°ä½ç‚¹ã€‚\n\næ•°æ®ä¸¢å¤±è¿™ä¸ªæ˜¯ä¸å¯é™çº§çš„åº•çº¿ï¼Œä¸€åˆ‡ä¼˜åŒ–å¿…é¡»åšæŒè¿™ä¸ªåº•çº¿ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2348391,"ctime":1661526066,"ip_address":"ä¸Šæµ·","comment_id":354851,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"æ‰€ä»¥ä½œè€…çš„æ–¹æ¡ˆæ˜¯ï¼šåœ¨é¡ºåºæ¶ˆè´¹é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å†…å¼•å…¥çº¿ç¨‹æ± ï¼Œå†æ¬¡æ‹†åˆ†å¯å¹¶è¡Œçš„ä»»åŠ¡è¿›è¡Œæ‰§è¡Œï¼Ÿ\n\nç„¶åæ¿€è¿›çš„å…ˆæ›´æ–°ä½ç‚¹ååˆ†å‘ä»»åŠ¡ï¼Œå®å¯ä¸¢æ¶ˆæ¯ï¼Œä¹Ÿä¸ä¼šå¤§æ‰¹é‡é‡å¤æ¶ˆè´¹é€ æˆä½ç‚¹å›æº¯ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2348391,"avatar":"https://static001.geekbang.org/account/avatar/00/23/d5/67/54efabd8.jpg","nickname":"ä¸­é—´ä»¶å…´è¶£åœˆ","note":"","ucode":"EFC2384D08600E","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585420,"discussion_content":"ä½ å¥½ï¼Œæ‰€ä»¥ä½œè€…çš„æ–¹æ¡ˆæ˜¯ï¼šåœ¨é¡ºåºæ¶ˆè´¹é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å†…å¼•å…¥çº¿ç¨‹æ± ï¼Œå†æ¬¡æ‹†åˆ†å¯å¹¶è¡Œçš„ä»»åŠ¡è¿›è¡Œæ‰§è¡Œï¼Ÿè¿™ä¸ªæ˜¯å¯¹çš„ã€‚\n\nä½†ååŠéƒ¨åˆ†ä¸æ˜¯è¿™æ ·çš„ï¼Œä½ç‚¹æäº¤ï¼Œè¿˜æ˜¯ä½¿ç”¨æœ€å°ä½ç‚¹æäº¤ï¼Œä»£ç ä¸­è¿˜æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå¤„ç†é˜Ÿåˆ—&lt;MessageQueue, TreeMap&lt;Long,Msg&gt;&gt;è¿™æ ·çš„ç»“æ„ï¼Œä½ç‚¹æäº¤è¿˜æ˜¯æäº¤å¤„ç†é˜Ÿåˆ—ä¸­æœ€å°ä½ç‚¹ã€‚\n\næ•°æ®ä¸¢å¤±è¿™ä¸ªæ˜¯ä¸å¯é™çº§çš„åº•çº¿ï¼Œä¸€åˆ‡ä¼˜åŒ–å¿…é¡»åšæŒè¿™ä¸ªåº•çº¿ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661526066,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382054,"user_name":"shen","can_delete":false,"product_type":"c1","uid":1215066,"ip_address":"å¹¿ä¸œ","ucode":"AE5737B0C7DC4F","user_header":"https://static001.geekbang.org/account/avatar/00/12/8a/5a/b67a82e3.jpg","comment_is_top":false,"comment_ctime":1696609538,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"æœ‰ä¸¤ä¸ªé—®é¢˜å’¨è¯¢ä¸‹è€å¸ˆ\n1ï¼Œå¼€å¤´å¢åŠ æœºå™¨åˆ°64å°ï¼Œæ˜¯å•æœºå¤„ç†ä¸è¿‡æ¥äº†å—ï¼Ÿå¦‚æœå¤„ç†ä¸è¿‡æ¥åé¢æ”¹é€ å¢åŠ çº¿ç¨‹å¤„ç†ä¹Ÿåº”è¯¥å¤„ç†ä¸è¿‡æ¥å§\n2ï¼Œä¸ºä»€ä¹ˆä¸å¢åŠ é˜Ÿåˆ—æ•°é‡ï¼Ÿé›†ç¾¤é˜Ÿåˆ—æ˜¯64ï¼Œé‚£ä¹ˆå¢åŠ åˆ°128ï¼Œ256ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„","like_count":0},{"had_liked":false,"id":370132,"user_name":"Geek_460f3a","can_delete":false,"product_type":"c1","uid":1806700,"ip_address":"å¹¿ä¸œ","ucode":"1B938DA91E86F8","user_header":"","comment_is_top":false,"comment_ctime":1678420096,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100114001,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œä¸ºå•¥æ¯æ¬¡æ‹‰å»å®Œæ¶ˆæ¯éƒ½è¦å…ˆæš‚åœï¼Œå†æ¢å¤ï¼Œæ˜¯ä¸ºäº†å•¥\nwhile (isRunning) {\n                    List&lt;MessageExt&gt; records = consumer.poll(consumerPollTimeoutMs);\n                    submitRecords(records);\n                    consumerLimitController.pause();\n                    consumerLimitController.resume();\n                }","like_count":0},{"had_liked":false,"id":369966,"user_name":"Geek_460f3a","can_delete":false,"product_type":"c1","uid":1806700,"ip_address":"å¹¿ä¸œ","ucode":"1B938DA91E86F8","user_header":"","comment_is_top":false,"comment_ctime":1678189653,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100114001,"comment_content":"ä»£ç æœ‰bugï¼ŒDefaultMQLitePushConsumerçš„isRunningæ°¸è¿œæ˜¯falseï¼Œæ°¸è¿œä¸ä¼šæ‹‰æ•°æ®","like_count":0}]}