{"id":211555,"title":"09 | 怎么能避免写出慢SQL？","content":"<p>你好，我是李玥。</p><p>通过上节课的案例，我们知道，一个慢SQL就可以直接让MySQL瘫痪。今天这节课，我们一起看一下，怎么才能避免写出危害数据库的慢SQL。</p><p>所谓慢SQL，就是执行特别慢的SQL语句。什么样的SQL语句是慢SQL？多慢才算是慢SQL？并没有一个非常明确的标准或者说是界限。但并不是说，我们就很难区分正常的SQL和慢SQL，在大多数实际的系统中，慢SQL消耗掉的数据库资源，往往是正常SQL的几倍、几十倍甚至几百倍，所以还是非常容易区分的。</p><p>但问题是，我们不能等着系统上线，慢SQL吃光数据库资源之后，再找出慢SQL来改进，那样就晚了。那么，怎样才能在开发阶段尽量避免写出慢SQL呢？</p><h2>定量认识MySQL</h2><p>我们回顾一下上节课的案例，那个系统第一次全站宕机发生在圣诞节平安夜，故障之前的一段时间，系统并没有更新过版本，这个时候，其实慢SQL已经存在了，直到平安夜那天，访问量的峰值比平时增加一些，正是增加的这部分访问量，引发了数据库的雪崩。</p><p>这说明，<strong>慢SQL对数据库的影响，是一个量变到质变的过程，对“量”的把握，就很重要</strong>。作为一个合格的程序员，你需要对数据库的能力，有一个定量的认识。</p><p>影响MySQL处理能力的因素很多，比如：服务器的配置、数据库中的数据量大小、MySQL的一些参数配置、数据库的繁忙程度等等。但是，通常情况下，这些因素对于MySQL性能和处理能力影响范围，大概在几倍的性能差距。所以，我们不需要精确的性能数据，只要掌握一个大致的量级，就足够指导我们的开发工作了。</p><!-- [[[read_end]]] --><p>一台MySQL数据库，大致处理能力的极限是，每秒一万条左右的简单SQL，这里的“简单SQL”，指的是类似于主键查询这种不需要遍历很多条记录的SQL。根据服务器的配置高低，可能低端的服务器只能达到每秒几千条，高端的服务器可以达到每秒钟几万条，所以这里给出的一万TPS是中位数的经验值。考虑到正常的系统不可能只有简单SQL，所以实际的TPS还要打很多折扣。</p><p>我的经验数据，一般一台MySQL服务器，平均每秒钟执行的SQL数量在几百左右，就已经是非常繁忙了，即使看起来CPU利用率和磁盘繁忙程度没那么高，你也需要考虑给数据库“减负”了。</p><p>另外一个重要的定量指标是，到底多慢的SQL才算慢SQL。这里面这个“慢”，衡量的单位本来是执行时长，但是时长这个东西，我们在编写SQL的时候并不好去衡量。那我们可以用执行SQL查询时，需要遍历的数据行数替代时间作为衡量标准，因为查询的执行时长基本上是和遍历的数据行数正相关的。</p><p>你在编写一条查询语句的时候，可以依据你要查询数据表的数据总量，估算一下这条查询大致需要遍历多少行数据。如果遍历行数在百万以内的，只要不是每秒钟都要执行几十上百次的频繁查询，可以认为是安全的。遍历数据行数在几百万的，查询时间最少也要几秒钟，你就要仔细考虑有没有优化的办法。遍历行数达到千万量级和以上的，我只能告诉你，这种查询就不应该出现在你的系统中。当然我们这里说的都是在线交易系统，离线分析类系统另说。</p><p>遍历行数在千万左右，是MySQL查询的一个坎儿。MySQL中单个表数据量，也要尽量控制在一千万条以下，最多不要超过二三千万这个量级。原因也很好理解，对一个千万级别的表执行查询，加上几个WHERE条件过滤一下，符合条件的数据最多可能在几十万或者百万量级，这还可以接受。但如果再和其他的表做一个联合查询，遍历的数据量很可能就超过千万级别了。所以，每个表的数据量最好小于千万级别。</p><p>如果数据库中的数据量就是很多，而且查询业务逻辑就需要遍历大量数据怎么办？</p><h2>使用索引避免全表扫描</h2><p>使用索引可以有效地减少执行查询时遍历数据的行数，提高查询性能。</p><p>数据库索引的原理也很简单，我举个例子你就明白了。比如说，有一个无序的数组，数组的每个元素都是一个用户对象。如果说我们要把所有姓李的用户找出来。比较笨的办法是，用一个循环把数组遍历一遍。</p><p>有没有更好的办法？很多办法是吧？比如说，我们用一个Map(在有些编程语言中是Dictionary)来给数组做一个索引，Key保存姓氏，值是所有这个姓氏的用户对象在数组中序号的集合。这样再查找的时候，就不用去遍历数组，先在Map中查找，然后再直接用序号去数组中拿用户数据，这样查找速度就快多了。</p><p>这个例子对应到数据库中，存放用户数据的数组就是表，我们构建的Map就是索引。实际上数据库的索引，和编程语言中的Map或者Dictionary，它们的数据结构都是差不多的，基本上就是各种B树和HASH表。</p><p>绝大多数情况下，我们编写的查询语句，都应该使用索引，避免去遍历整张表，也就是通常说的，避免全表扫描。你在每次开发新功能，需要给数据库增加一个新的查询时，都要评估一下，是不是有索引可以支撑新的查询语句，如果有必要的话，需要新建索引来支持新增的查询。</p><p>但是，增加索引付出的代价是，会降低数据插入、删除和更新的性能。这个也很好理解，增加了索引，在数据变化的时候，不仅要变更数据表里的数据，还要去变更每个索引。所以，对于更新频繁并且对更新性能要求较高的表，可以尽量少建索引。而对于查询较多更新较少的表，可以根据查询的业务逻辑，适当多建一些索引。</p><p>怎么写SQL能更好地使用索引，查询效率更高，这是一门手艺，需要丰富的经验，不是通过一节课的学习能练成的。但是，我们是有方法，可以评估写出来的SQL的查询性能怎么样，是不是一个潜在的“慢SQL”。</p><p>逻辑不是很复杂的单表查询，我们可能还可以分析出来，查询会使用哪个索引。但如果是比较复杂的多表联合查询，我们单看SQL语句本身，就很难分析出查询到底会命中哪些索引，会遍历多少行数据。MySQL和大部分数据库，都提供一个帮助我们分析查询功能：执行计划。</p><h2>分析SQL执行计划</h2><p>在MySQL中使用执行计划也非常简单，只要在你的SQL语句前面加上<strong>EXPLAIN</strong>关键字，然后执行这个查询语句就可以了。</p><p>举个例子说明，比如有一个用户表，包含用户ID、姓名、部门编号和状态这几个字段：</p><p><img src=\"https://static001.geekbang.org/resource/image/43/48/437d6d3fb610431cfb9044781a8faa48.png?wh=1142*319\" alt=\"\"></p><p>我们希望查询某个二级部门下的所有人，查询条件就是，部门代号以00028开头的所有人。下面这两个SQL，他们的查询结果是一样的，都满足要求，但是，哪个查询性能更好呢？</p><pre><code>SELECT * FROM user WHERE left(department_code, 5) = '00028';\nSELECT * FROM user WHERE department_code LIKE '00028%';\n</code></pre><p>我们分别查看一下这两个SQL的执行计划：</p><p><img src=\"https://static001.geekbang.org/resource/image/4b/74/4b50e4e1192714379ff3a4697d02a774.png?wh=1142*348\" alt=\"\"></p><p>我带你一起来分析一下这两个SQL的执行计划。首先来看rows这一列，rows的含义就是，MySQL预估执行这个SQL可能会遍历的数据行数。第一个SQL遍历了四千多行，这就是整个User表的数据条数；第二个SQL只有8行，这8行其实就是符合条件的8条记录。显然第二个SQL查询性能要远远好于第一个SQL。</p><p>为什么第一个SQL需要全表扫描，第二个SQL只遍历了很少的行数呢？注意看type这一列，这一列表示这个查询的访问类型。ALL代表全表扫描，这是最差的情况。range代表使用了索引，在索引中进行范围查找，因为第二个SQL语句的WHERE中有一个LIKE的查询条件。如果直接命中索引，type这一列显示的是index。如果使用了索引，可以在key这一列中看到，实际上使用了哪个索引。</p><p>通过对比这两个SQL的执行计划，就可以看出来，第二个SQL虽然使用了普遍认为低效的LIKE查询条件，但是仍然可以用到索引的范围查找，遍历数据的行数远远少于第一个SQL，查询性能更好。</p><h2>小结</h2><p>在开发阶段，衡量一个SQL查询语句查询性能的手段是，估计执行SQL时需要遍历的数据行数。遍历行数在百万以内，可以认为是安全的SQL，百万到千万这个量级则需要仔细评估和优化，千万级别以上则是非常危险的。为了减少慢SQL的可能性，每个数据表的行数最好控制在千万以内。</p><p>索引可以显著减少查询遍历数据的数量，所以提升SQL查询性能最有效的方式就是，让查询尽可能多的命中索引，但索引也是一把双刃剑，它在提升查询性能的同时，也会降低数据更新的性能。</p><p>对于复杂的查询，最好使用SQL执行计划，事先对查询做一个分析。在SQL执行计划的结果中，可以看到查询预估的遍历行数，命中了哪些索引。执行计划也可以很好地帮助你优化你的查询语句。</p><h2>思考题</h2><p>课后请你想一下，在讲解SQL执行计划那个例子中的第一个SQL，为什么没有使用索引呢？</p><pre><code>SELECT * FROM user WHERE left(department_code, 5) = '00028';\n</code></pre><p>欢迎你在留言区与我讨论，如果你觉得今天学到的知识对你有帮助，也欢迎把它分享给你的朋友。</p>","neighbors":{"left":{"article_title":"08 | 一个几乎每个系统必踩的坑儿：访问数据库超时","id":211008},"right":{"article_title":"10 | 走进黑盒：SQL是如何在数据库中执行的？","id":213176}},"comments":[{"had_liked":false,"id":188635,"user_name":"冯玉鹏","can_delete":false,"product_type":"c1","uid":1442088,"ip_address":"","ucode":"BA4B53F072B82F","user_header":"https://static001.geekbang.org/account/avatar/00/16/01/28/134da154.jpg","comment_is_top":false,"comment_ctime":1584379586,"is_pvip":false,"replies":[{"id":"72793","content":"👍👍👍","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584410902,"ip_address":"","comment_id":188635,"utype":1}],"discussion_count":7,"race_medal":0,"score":"306527057602","product_id":100046801,"comment_content":"innodb 的索引是用索引关联列以b+树的形式 管理，其中主键索性和数据的物理顺序一致，也叫聚集索引。非主键索引实际上是指向主键索引。<br>文末的问题对 department_code 列 left 运算后，MySQL 认为运算后的结果不可与原数据列内容匹配，故采用全表扫描， 而第二个语句like  &#39;00028%&#39; 可以使用到索引 是因为索引的最左匹配选择，如果%在前面也将无法使用索引。PS:在这里MySQL的查询优化器在使用了left函数无法匹配索引可以认为有偷懒的嫌疑，哈哈~  类似的场景还有 where 列 +1 = val   查询优化器也完全可以改写成 where 列=val - 1。","like_count":72,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487471,"discussion_content":"👍👍👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584410902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099053,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c5/2d/1eebfc3c.jpg","nickname":"GaGi","note":"","ucode":"CC8D22E1DD8CA2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":206817,"discussion_content":"看到+1=val的操作就想起了隔壁的MySQL实战45讲","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1584447586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1649057,"avatar":"https://static001.geekbang.org/account/avatar/00/19/29/a1/41607383.jpg","nickname":"hello","note":"","ucode":"4F42DAA5DB5C38","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376886,"discussion_content":"看来你已经看了隔壁的MySQL45 讲了。","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1622390476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1203293,"avatar":"https://static001.geekbang.org/account/avatar/00/12/5c/5d/974b033f.jpg","nickname":"陆老师","note":"","ucode":"0EA27C4755FF4A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":236591,"discussion_content":"是对索引列用了函数，MySQL没法直接知道索引列的前5个值，那么就需要对每一行做函数处理，那这样就需要全表扫描。MySQL能用上索引就是利用了索引本身的值以及值按从小到大排序的特性。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1587106458,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1388160,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/cLibWco0BcPIc7OrTLTPtuibMmAJCIIvm6gUeaLrgnIoKUSxClUSPwP1xAl40HIdczqz9mDbqLMebofxzR349mMw/132","nickname":"秦岭","note":"","ucode":"B6035F5F9D2867","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":211385,"discussion_content":"没有搞明白，like &#39;00028%&#39; 和 like &#39;%00028%&#39; 前者可以匹配到索引，而后者为什么不行？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584846152,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1442088,"avatar":"https://static001.geekbang.org/account/avatar/00/16/01/28/134da154.jpg","nickname":"冯玉鹏","note":"","ucode":"BA4B53F072B82F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1388160,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/cLibWco0BcPIc7OrTLTPtuibMmAJCIIvm6gUeaLrgnIoKUSxClUSPwP1xAl40HIdczqz9mDbqLMebofxzR349mMw/132","nickname":"秦岭","note":"","ucode":"B6035F5F9D2867","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217970,"discussion_content":"索引的最左匹配原则","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1585605250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":211385,"ip_address":""},"score":217970,"extra":""},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1388160,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/cLibWco0BcPIc7OrTLTPtuibMmAJCIIvm6gUeaLrgnIoKUSxClUSPwP1xAl40HIdczqz9mDbqLMebofxzR349mMw/132","nickname":"秦岭","note":"","ucode":"B6035F5F9D2867","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366141,"discussion_content":"很简单，因为以%开头的模糊匹配，不知道前头有可能是什么，因此必须要全表扫描","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1617969644,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":211385,"ip_address":""},"score":366141,"extra":""}]}]},{"had_liked":false,"id":189036,"user_name":"小袁","can_delete":false,"product_type":"c1","uid":1811495,"ip_address":"","ucode":"3F5D8721F577D9","user_header":"https://static001.geekbang.org/account/avatar/00/1b/a4/27/15e75982.jpg","comment_is_top":false,"comment_ctime":1584449089,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"121843533377","product_id":100046801,"comment_content":"简单来说，要写成 &quot;索引 列 = 计算表达式&quot;这种形式，养成这个习惯<br>","like_count":29,"discussions":[{"author":{"id":1386818,"avatar":"https://static001.geekbang.org/account/avatar/00/15/29/42/43d4b1a8.jpg","nickname":"烫烫烫","note":"","ucode":"C06018670DE76A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330538,"discussion_content":"除此之外，还要小心隐式类型转换","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606642984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":189352,"user_name":"Regis","can_delete":false,"product_type":"c1","uid":1435632,"ip_address":"","ucode":"3911E4EDE27F4E","user_header":"https://static001.geekbang.org/account/avatar/00/15/e7/f0/d0bf3a5f.jpg","comment_is_top":false,"comment_ctime":1584504474,"is_pvip":false,"replies":[{"id":"73117","content":"我的建议是，在线交易类系统（OLTP，大部分服务业务的CRUD类系统）使用ORM框架。<br><br>分析类系统（OLAP，各种分析和报表类系统）直接写SQL。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584593188,"ip_address":"","comment_id":189352,"utype":1}],"discussion_count":3,"race_medal":0,"score":"83188883098","product_id":100046801,"comment_content":"后台实际开发中，使用ORM的框架的情况是不是很多？如果使用ORM框架，SQL的写法就不可控了。实际开发中是使用ORM框架好还是直接书写SQL好？还是两种都会存在？一些复杂的查询使用框架查询感觉很痛苦","like_count":18,"discussions":[{"author":{"id":1062848,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ersGSic8ib7OguJv6CJiaXY0s4n9C7Z51sWxTTljklFpq3ZAIWXoFTPV5oLo0GMTkqW5sYJRRnibNqOJQ/132","nickname":"walle斌","note":"","ucode":"0DB3243004951F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":545665,"discussion_content":"除非你的系统就是一个纯demo 基本不会有大的量 否则 多强调几遍 不要用完全orm框架。。当你的db量级随便来到几百万的级别，完全扛不住。。踏踏实实mybatis  手撸sql  优化sql到极致。。前期省下那点开发时间，后边就慢慢填坑吧。。说一句，外包及其喜欢用jpa这种。。为啥来？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642035916,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487677,"discussion_content":"我的建议是，在线交易类系统（OLTP，大部分服务业务的CRUD类系统）使用ORM框架。\n\n分析类系统（OLAP，各种分析和报表类系统）直接写SQL。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584593188,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1361746,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c7/52/c5adf218.jpg","nickname":"喜欢地球的阿培同学","note":"","ucode":"5F97037585F857","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":260016,"discussion_content":"用Mybatis","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588839064,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204464,"user_name":"贾敏","can_delete":false,"product_type":"c1","uid":1946456,"ip_address":"","ucode":"6C5B5EABA4C811","user_header":"https://static001.geekbang.org/account/avatar/00/1d/b3/58/14e407e8.jpg","comment_is_top":false,"comment_ctime":1586403356,"is_pvip":false,"replies":[{"id":"76479","content":"你想一下B+树的结构是什么样的，就会明白了。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1586426786,"ip_address":"","comment_id":204464,"utype":1}],"discussion_count":2,"race_medal":0,"score":"57420978204","product_id":100046801,"comment_content":"只知道  LIKE &#39;00028%&#39; 会使用索引， 但是为什么说是最左匹配呢？谢谢老师","like_count":14,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491189,"discussion_content":"你想一下B+树的结构是什么样的，就会明白了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586426786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366145,"discussion_content":"B+树按字典序排序","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617969951,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194675,"user_name":"leslie","can_delete":false,"product_type":"c1","uid":1324255,"ip_address":"","ucode":"798E7C1CC98CC2","user_header":"https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg","comment_is_top":false,"comment_ctime":1585097037,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48829737293","product_id":100046801,"comment_content":"原因很简单：函数破坏了索引，其实这种写法基本上都会在程序端禁止的；code review这关过不去的，直接发回开发-重写。like 语句其实用到了mysql 5.7所引用的特性 分列，问题就这么简单。","like_count":12},{"had_liked":false,"id":201858,"user_name":"夏目","can_delete":false,"product_type":"c1","uid":1212750,"ip_address":"","ucode":"67C075A01CF4D2","user_header":"https://static001.geekbang.org/account/avatar/00/12/81/4e/d71092f4.jpg","comment_is_top":false,"comment_ctime":1585846398,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23060682878","product_id":100046801,"comment_content":"直接在列上做运算会导致索引失效，因为原有索引值运算之后会不满足当前索引值排序，所以不会走索引，最好是把索引值运算改为相应的条件运算","like_count":5},{"had_liked":false,"id":228274,"user_name":"MClink","can_delete":false,"product_type":"c1","uid":1435733,"ip_address":"","ucode":"F479190923355C","user_header":"https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg","comment_is_top":false,"comment_ctime":1592630581,"is_pvip":true,"replies":[{"id":"84533","content":"请 继续往下学习，我们的课程后面有大量的篇幅来讲，如何解决你提出的问题。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1592917763,"ip_address":"","comment_id":228274,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14477532469","product_id":100046801,"comment_content":"单表数据量尽量不要超过千万级别，可以采取的措施有水平分表和垂直分表，在报表数据统计相关的业务中，主要采取的是水平分表，按天，按月，甚至是按日，也有分区，但是这些存储的优化方案，给编码造成了一定的难度，目前我接触的数据表基本都是千万级别，有的甚至过亿，大多是业务日志表，说实话，除了统计所需要的中间表，日志表和页面展示相关的表我们都没有进行分表，我挺想知道我这种架构应该怎么去调整比较好","like_count":3,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498978,"discussion_content":"请 继续往下学习，我们的课程后面有大量的篇幅来讲，如何解决你提出的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592917763,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239232,"user_name":"千锤百炼领悟之极限","can_delete":false,"product_type":"c1","uid":1744257,"ip_address":"","ucode":"224B5CF2101716","user_header":"https://static001.geekbang.org/account/avatar/00/1a/9d/81/d748b7eb.jpg","comment_is_top":false,"comment_ctime":1596463192,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10186397784","product_id":100046801,"comment_content":"在属性上进行计算不能命中索引。<br>例如: select * from order where YEAR(date) &lt; = &#39;2020&#39;<br>即使date上建立了索引，也会全表扫描，可优化为值计算：<br>select * from order where date &lt; = CURDATE()<br>或者：<br>select * from order where date &lt; = &#39;2020-01-01&#39;","like_count":2},{"had_liked":false,"id":196129,"user_name":"LiG❄️","can_delete":false,"product_type":"c1","uid":1357566,"ip_address":"","ucode":"0FE01F25ADD1F9","user_header":"https://static001.geekbang.org/account/avatar/00/14/b6/fe/c5d7f0dc.jpg","comment_is_top":false,"comment_ctime":1585237911,"is_pvip":false,"replies":[{"id":"74403","content":"我会在《15 | MySQL存储海量数据的最后一招：分库分表》这节课来讲分库分表的问题。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1585271778,"ip_address":"","comment_id":196129,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10175172503","product_id":100046801,"comment_content":"老师，想请教您一个问题：mysql单库表数量有限制吗？每个库多少表会比较合适啊？ps：项目中设计一个消息推送系统，消息存储现在是以人分表，一人一个消息表（会造成表数据膨胀）；还有想法是想重构，把消息都存在一起，以时间分表～没有做过大存储，还望老师指教😄","like_count":2,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489230,"discussion_content":"我会在《15 | MySQL存储海量数据的最后一招：分库分表》这节课来讲分库分表的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585271778,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":195184,"user_name":"饼子","can_delete":false,"product_type":"c1","uid":1085953,"ip_address":"","ucode":"981A44836A5216","user_header":"https://static001.geekbang.org/account/avatar/00/10/92/01/c723d180.jpg","comment_is_top":false,"comment_ctime":1585144891,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10175079483","product_id":100046801,"comment_content":"因为where条件使用了函数运算，那么只有扫描每一行才能确定函数执行后的值与判断是否一致","like_count":3},{"had_liked":false,"id":227103,"user_name":"西门吹牛","can_delete":false,"product_type":"c1","uid":1508990,"ip_address":"","ucode":"E5D3624DDE1E83","user_header":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","comment_is_top":false,"comment_ctime":1592288379,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5887255675","product_id":100046801,"comment_content":"思考题，对where条件字段，做了函数操作，由于B+树索引，一般涉及索引都是有序的，对字段进行函数操作，就破坏了有序性，所以在有序树上进行搜索，就不能按照搜索树来查找，只能全表扫描","like_count":2},{"had_liked":false,"id":206431,"user_name":"呦呦鹿鸣","can_delete":false,"product_type":"c1","uid":1238190,"ip_address":"","ucode":"BC80F2093CD6C3","user_header":"https://static001.geekbang.org/account/avatar/00/12/e4/ae/7b310c2d.jpg","comment_is_top":false,"comment_ctime":1586859707,"is_pvip":false,"replies":[{"id":"77858","content":"列的数量是会影响查询性能的，但相比行数的影响要小得多，所以，如果不是列特别多的情况，可以忽略这个影响。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1587353693,"ip_address":"","comment_id":206431,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5881827003","product_id":100046801,"comment_content":"李老师好，一直有个疑问，评估数据量时一般只考虑数据行数就可以么？相同行数下的两张表，2个字段跟20个字段的性能差异需要如何评估呢？","like_count":1,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491785,"discussion_content":"列的数量是会影响查询性能的，但相比行数的影响要小得多，所以，如果不是列特别多的情况，可以忽略这个影响。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587353693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194803,"user_name":"特种流氓","can_delete":false,"product_type":"c1","uid":1248825,"ip_address":"","ucode":"D9985CBA8B4AAD","user_header":"https://static001.geekbang.org/account/avatar/00/13/0e/39/174741d1.jpg","comment_is_top":false,"comment_ctime":1585107251,"is_pvip":false,"replies":[{"id":"74411","content":"据我所知，MySQL还没有这个功能。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1585273976,"ip_address":"","comment_id":194803,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5880074547","product_id":100046801,"comment_content":"老师 能否在mysql中做设置 超时的sql查询自动停止执行","like_count":1,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488905,"discussion_content":"据我所知，MySQL还没有这个功能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585273976,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2037282,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erpYAcOqrNNxmMuKsd6Dh69BzxiaXjJRh6IMnQlxOqBFiae1EMic32Wv6aFESWytliaL7uniaZ4DgNUwxg/132","nickname":"黄序","note":"","ucode":"C8C2749E2DE72B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":412159,"discussion_content":"这种能力一般是客户端的能力，服务端不具备类似的能力","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636090246,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1368901,"avatar":"","nickname":"miu","note":"","ucode":"3D73FF3C09231A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379969,"discussion_content":"查询超时取消是应用程序来做的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624265739,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":191467,"user_name":"image","can_delete":false,"product_type":"c1","uid":1039069,"ip_address":"","ucode":"A45BFF284F8933","user_header":"https://static001.geekbang.org/account/avatar/00/0f/da/dd/1e5e7b0c.jpg","comment_is_top":false,"comment_ctime":1584776069,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879743365","product_id":100046801,"comment_content":"Btree索引树只能根据索引值进行范围查找，而无法进行函数运算后查找","like_count":1},{"had_liked":false,"id":191138,"user_name":"fgdgtz","can_delete":false,"product_type":"c1","uid":1240401,"ip_address":"","ucode":"486CC4ACCC015C","user_header":"","comment_is_top":false,"comment_ctime":1584748517,"is_pvip":false,"replies":[{"id":"73509","content":"你可以把SQL和执行计划贴出来我们一起讨论。","user_name":"作者回复","user_name_real":"李玥","uid":"1501046","ctime":1584845248,"ip_address":"","comment_id":191138,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5879715813","product_id":100046801,"comment_content":"你好老师，我想问问如果是 order by 多个字段排序的执行流程是什么样的呢？<br>比如 有40000行 order by a desc,b desc limit 1000 ,a字段有索引，b字段无索引，a字段保存的是时间戳，有少部分时间戳是同样的，此时explain 会有 Using filesort，这样放入sort_buffer 是40000行 还是 大于1000行而小于40000行呢？或是扫描了多少行？","like_count":1,"discussions":[{"author":{"id":1501046,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e7/76/79c1f23a.jpg","nickname":"李玥","note":"","ucode":"B19E91EE248591","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488120,"discussion_content":"你可以把SQL和执行计划贴出来我们一起讨论。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584845248,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366149,"discussion_content":"因为a字段保存的时间戳，有可能相同，因此扫描行数>=1000\n取决于实际数据情况：即第1000个值有多少a字段相同，最坏的情况是全表扫描","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617970388,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1158873,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ae/d9/7a732188.jpg","nickname":"ROCKETsFORWARD","note":"","ucode":"D171E33E546FD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":210713,"discussion_content":"如果你这个查询没有where条件，只是order排序，那么应该就是扫描1000行吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584763898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":190953,"user_name":"活到天年","can_delete":false,"product_type":"c1","uid":1116236,"ip_address":"","ucode":"03178BA96BE04E","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/4c/e5db89c6.jpg","comment_is_top":false,"comment_ctime":1584712782,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879680078","product_id":100046801,"comment_content":"是因为等号的左边使用了函数，如果等号左边使用了函数，则会导致全表扫描，但是如果可以建立函数索引的话，也可以提高查询效率。","like_count":1},{"had_liked":false,"id":188834,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1584423916,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"5879391212","product_id":100046801,"comment_content":"作为一个合格的程序员，要对数据库的处理能力，有个定量的认知。 说的很对，认同<br>有个问题就是，有没有一个指标可以知道MySQL每秒钟执行的SQL数量？","like_count":1,"discussions":[{"author":{"id":1320730,"avatar":"https://static001.geekbang.org/account/avatar/00/14/27/1a/77fb1e4e.jpg","nickname":"Lingjun","note":"","ucode":"5CE38C19231D3B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":209612,"discussion_content":"这个运行在不同性能的机器上、或者机器在负载不同的时候肯定是不同的，所以根据遍历行数还是相对比较客观的吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1584660965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188724,"user_name":"攻城拔寨","can_delete":false,"product_type":"c1","uid":1053934,"ip_address":"","ucode":"CBC37183DAB6B2","user_header":"https://static001.geekbang.org/account/avatar/00/10/14/ee/d72a8222.jpg","comment_is_top":false,"comment_ctime":1584408765,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879376061","product_id":100046801,"comment_content":"索引使用函数会让索引失效，因为必须拿所有索引去计算才能得到结果","like_count":1},{"had_liked":false,"id":188705,"user_name":"刘楠","can_delete":false,"product_type":"c1","uid":1120773,"ip_address":"","ucode":"9F19D44CBEE039","user_header":"https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg","comment_is_top":false,"comment_ctime":1584406546,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879373842","product_id":100046801,"comment_content":"LEFT()函数是一个字符串函数，它返回具有指定长度的字符串的左边部分。<br><br>　　LEFT(Str,length);<br><br>　　接收两个参数：<br><br>　　　　str：一个字符串；<br><br>　　　　length：想要截取的长度，是一个正整数；<br>left函数，会扫描所有的行，并试图找到所有能与匹配的记录，是值班表扫描","like_count":1},{"had_liked":false,"id":188698,"user_name":"R20114","can_delete":false,"product_type":"c1","uid":1046260,"ip_address":"","ucode":"883B7FD07443BC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/f4/95191165.jpg","comment_is_top":false,"comment_ctime":1584406027,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879373323","product_id":100046801,"comment_content":"MySQL 执行器去执行查询语句时会先去查询所有的 user 信息，然后对 department_code列执行函数，再和  00028 比较。","like_count":1},{"had_liked":false,"id":188678,"user_name":"webmin","can_delete":false,"product_type":"c1","uid":1047014,"ip_address":"","ucode":"98B0CA882454E8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg","comment_is_top":false,"comment_ctime":1584404204,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5879371500","product_id":100046801,"comment_content":"left(department_code, 5)经过了函数计算，与索引建立时条件不一至，如果要让left(department_code, 5)使用索引，可以使用函数索引机制来处理。","like_count":1},{"had_liked":false,"id":188627,"user_name":"火车日记","can_delete":false,"product_type":"c1","uid":1480419,"ip_address":"","ucode":"62C57DFA6CDF74","user_header":"https://static001.geekbang.org/account/avatar/00/16/96/e3/dd40ec58.jpg","comment_is_top":false,"comment_ctime":1584375667,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879342963","product_id":100046801,"comment_content":"where中列使用了函数，优化器无法用到索引","like_count":1},{"had_liked":false,"id":340497,"user_name":"Geek_fe19fb","can_delete":false,"product_type":"c1","uid":2941998,"ip_address":"","ucode":"23C751D4696C7D","user_header":"","comment_is_top":false,"comment_ctime":1648864374,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648864374","product_id":100046801,"comment_content":"对一个千万级别的表执行查询，加上几个 WHERE 条件过滤一下，符合条件的数据最多可能在几十万或者百万量级，这还可以接受。但如果再和其他的表做一个联合查询，遍历的数据量很可能就超过千万级别了<br><br>这个观点是有问题的，关联的过程中如果被驱动表存在索引 驱动表多少数据就扫描多少行  若没有索引也不是你说的几千万这么简单的","like_count":0},{"had_liked":false,"id":331245,"user_name":"stark","can_delete":false,"product_type":"c1","uid":1143399,"ip_address":"","ucode":"ADC5C2AE5B97C8","user_header":"https://static001.geekbang.org/account/avatar/00/11/72/67/aa52812a.jpg","comment_is_top":false,"comment_ctime":1642498993,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642498993","product_id":100046801,"comment_content":"上面的sql语句的执行里有left函数了，所以没有使用到索引","like_count":0},{"had_liked":false,"id":320281,"user_name":"建强","can_delete":false,"product_type":"c1","uid":1397126,"ip_address":"","ucode":"62B03D0E0C64EC","user_header":"https://static001.geekbang.org/account/avatar/00/15/51/86/b5fd8dd8.jpg","comment_is_top":false,"comment_ctime":1636197409,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636197409","product_id":100046801,"comment_content":"思考题，个人理解：<br>大部分的mysql索引都是B+树索引，建立索引时，是以被索引字段的值来创建索引树的节点，检索数据时，需要根据被检索字段的值在索引树中进行比较查找，从而定位被检索的记录ID，然后再根据记录ID，从主键索引中获取所需要的记录；如果在WHERE语句中，对字段使用了函数，那就无法在B+树中对节点的值进行比较，经过函数运算后的值可能就破坏了B+树中节点的规律，比如left(department_code, 5), 如果索引树中按department_code的值从小到大建立索引节结点，而该函数运算的结果是取department_code的前5位，而这前5位的值并不能代表department_code的值，因此，用函数运算的结果去做匹配索引结点，很可能得到错误的结果。所以mysql中对于使用了函数的字段，即使在该字段上创建了索引，也不会去使用索引。","like_count":1},{"had_liked":false,"id":311927,"user_name":"你的笑忘书","can_delete":false,"product_type":"c1","uid":1521181,"ip_address":"","ucode":"9665D5E9EDBEA6","user_header":"https://static001.geekbang.org/account/avatar/00/17/36/1d/874dc1e3.jpg","comment_is_top":false,"comment_ctime":1631532726,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1631532726","product_id":100046801,"comment_content":"简而言之就是：left(department_code, 5) 操作导致索引失效。","like_count":0},{"had_liked":false,"id":264777,"user_name":"烫烫烫","can_delete":false,"product_type":"c1","uid":1386818,"ip_address":"","ucode":"C06018670DE76A","user_header":"https://static001.geekbang.org/account/avatar/00/15/29/42/43d4b1a8.jpg","comment_is_top":false,"comment_ctime":1606643160,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1606643160","product_id":100046801,"comment_content":"大佬，单次查询遍历百万行、千万行，是不是太高了，我一直认为一万以下还可以接受，一千行以内才是理想状态，难道是我见的世面太少了？","like_count":0,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366147,"discussion_content":"其实也取决一行数据的大小，因为MySQL是按行存储","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617970043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":252384,"user_name":"否极泰来","can_delete":false,"product_type":"c1","uid":1439355,"ip_address":"","ucode":"C249173266251A","user_header":"https://static001.geekbang.org/account/avatar/00/15/f6/7b/b6abcbbe.jpg","comment_is_top":false,"comment_ctime":1602262544,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602262544","product_id":100046801,"comment_content":"因为对department_code字段做了函数处理，导致全表扫描没有走索引","like_count":0},{"had_liked":false,"id":241648,"user_name":"Geek001","can_delete":false,"product_type":"c1","uid":1568448,"ip_address":"","ucode":"1C4D9FF4294AFB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJWZyym9hkz3ic6xGo84ZibObUofUSfve9CdhbXq21DFoVyMWaUaq4vQwlpgZCOE4QUCzjKKO6bB88g/132","comment_is_top":false,"comment_ctime":1597378080,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597378080","product_id":100046801,"comment_content":"老师好，“MySQL 中单个表数据量，也要尽量控制在一千万条以下，最多不要超过二三千万这个量级。原因也很好理解，对一个千万级别的表执行查询，加上几个 WHERE 条件过滤一下，符合条件的数据最多可能在几十万或者百万量级，这还可以接受。但如果再和其他的表做一个联合查询，遍历的数据量很可能就超过千万级别了。所以，每个表的数据量最好小于千万级别”<br><br>关于这个有具体量化指标说明吗？ 比如B+ 层数相关等；","like_count":0},{"had_liked":false,"id":221670,"user_name":"学要有所用","can_delete":false,"product_type":"c1","uid":1446644,"ip_address":"","ucode":"7CB34E7DE21558","user_header":"https://static001.geekbang.org/account/avatar/00/16/12/f4/1bf8568e.jpg","comment_is_top":false,"comment_ctime":1590562390,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1590562390","product_id":100046801,"comment_content":"查找慢sql，不是可以通过开启慢查询日志进行查找吗？","like_count":0},{"had_liked":false,"id":213405,"user_name":"Geek_92f9f1","can_delete":false,"product_type":"c1","uid":1985210,"ip_address":"","ucode":"AC898F4E689A3C","user_header":"","comment_is_top":false,"comment_ctime":1588405548,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588405548","product_id":100046801,"comment_content":"对于大段大段的SQL，做OLAP数据库分析的话有什么办法代替存储过程呢？","like_count":0},{"had_liked":false,"id":188919,"user_name":"隗功庆","can_delete":false,"product_type":"c1","uid":1872791,"ip_address":"","ucode":"57C3E28FCB5648","user_header":"","comment_is_top":false,"comment_ctime":1584434143,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584434143","product_id":100046801,"comment_content":"运算不能使用索引","like_count":0},{"had_liked":false,"id":188729,"user_name":"肥low","can_delete":false,"product_type":"c1","uid":1043480,"ip_address":"","ucode":"A158AFAAB8C742","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/18/bf7254d3.jpg","comment_is_top":false,"comment_ctime":1584408954,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584408954","product_id":100046801,"comment_content":"因为第一个用到了函数 如果在建立索引的时候就left 在SQL中不显式的left就能用到了 ","like_count":0},{"had_liked":false,"id":188702,"user_name":"夜空中最亮的星","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1584406328,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584406328","product_id":100046801,"comment_content":"运算不能使用索引","like_count":0},{"had_liked":false,"id":188688,"user_name":"滴流乱转小胖儿","can_delete":false,"product_type":"c1","uid":1231250,"ip_address":"","ucode":"4689236E65FE4E","user_header":"https://static001.geekbang.org/account/avatar/00/12/c9/92/6361802a.jpg","comment_is_top":false,"comment_ctime":1584404992,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584404992","product_id":100046801,"comment_content":"使用left(department_code, 5)函数对department_code列所有值，进行了操作，只能进行全表扫描。 对不对老师？","like_count":0},{"had_liked":false,"id":188686,"user_name":"撒旦的堕落","can_delete":false,"product_type":"c1","uid":1116864,"ip_address":"","ucode":"15F6AA41EE556F","user_header":"https://static001.geekbang.org/account/avatar/00/11/0a/c0/401c240e.jpg","comment_is_top":false,"comment_ctime":1584404783,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584404783","product_id":100046801,"comment_content":"应该是where条件后使用了函数导致无法使用索引","like_count":0},{"had_liked":false,"id":188684,"user_name":"饭团","can_delete":false,"product_type":"c1","uid":1332557,"ip_address":"","ucode":"E24F240CC91BE8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132","comment_is_top":false,"comment_ctime":1584404755,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584404755","product_id":100046801,"comment_content":"因为where条件左值使用了函数！","like_count":0},{"had_liked":false,"id":188667,"user_name":"myrfy","can_delete":false,"product_type":"c1","uid":1169401,"ip_address":"","ucode":"2814BAE5D70098","user_header":"","comment_is_top":false,"comment_ctime":1584403026,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584403026","product_id":100046801,"comment_content":"left是一个函数，而索引存的是原始数据，必须要通过把原始数据依次交给函数去执行才能拿到函数的值，所以需要查所有数据","like_count":0},{"had_liked":false,"id":188655,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1584400482,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584400482","product_id":100046801,"comment_content":"索引进行运算会失效","like_count":0}]}