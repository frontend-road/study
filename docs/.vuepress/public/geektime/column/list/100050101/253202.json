{"id":253202,"title":"ç‰¹åˆ«æ”¾é€ï¼ˆäº”ï¼‰ | Kafka ç¤¾åŒºçš„é‡ç£…åŠŸèƒ½ï¼šç§»é™¤ ZooKeeper ä¾èµ–","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯èƒ¡å¤•ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥èŠèŠKafkaç¤¾åŒºçš„ä¸€ä¸ªé‡ç£…åŠŸèƒ½ï¼š<strong>ç§»é™¤ZooKeeperä¾èµ–</strong>ã€‚</p><p>Kafkaä»è¯ç”Ÿå¼€å§‹ï¼Œå°±è·ŸZooKeeperç´§ç´§åœ°ç»‘åœ¨äº†ä¸€èµ·ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼Œæ²¡æœ‰ZooKeeperï¼Œå°±æ²¡æœ‰Kafkaä»Šå¤©çš„æˆåŠŸã€‚</p><p>ä½†æ˜¯ï¼Œéšç€Kafkaçš„ä¸æ–­å®Œå–„å’Œæ¼”è¿›ï¼Œç¤¾åŒºé€æ¸å‘ç°ï¼Œåœ¨ZooKeeperå’ŒKafkaç»“åˆä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸€äº›é—®é¢˜æ…¢æ…¢åœ°æ˜¾ç°äº†å‡ºæ¥ã€‚æ¯”å¦‚è¯´ï¼ŒZooKeeperå¹¶ä¸é€‚åˆäºé¢‘ç¹çš„å†™æ“ä½œï¼Œä½†Kafka 0.8æ—¶ä»£çš„æ¶ˆè´¹è€…å°±æ˜¯åˆ©ç”¨ZooKeeperæ¥ä¿å­˜å…¶ä½ç§»ä¿¡æ¯çš„ã€‚å› æ­¤ï¼Œç§»é™¤ZooKeeperå¹¶ä½¿ç”¨Kafkaå†…éƒ¨ä¸»é¢˜çš„æ–¹å¼ä¿å­˜ä½ç§»ï¼Œå°±ä»æ ¹æœ¬ä¸Šè§„é¿äº†ZooKeeperçš„è¿™ä¸ªå¼Šç—…ã€‚</p><p>æ‘†è„±ZooKeeperä¾èµ–çš„å¦ä¸€ä¸ªå¥½å¤„åœ¨äºï¼Œè¿™<strong>èƒ½è®©Kafkaå˜æˆä¸€ä¸ªç‹¬ç«‹çš„æ¡†æ¶</strong>ã€‚è¿™æ ·ï¼Œä»¥ååœ¨ä½¿ç”¨Kafkaæ—¶ï¼Œå°±ä¸éœ€è¦å†é¢å¤–ç»´æŠ¤ä¸€å¥—ZooKeeperé›†ç¾¤äº†ã€‚æ˜¾ç„¶ï¼Œå®‰è£…ã€è¿ç»´å’Œè°ƒä¼˜ä¸€å¥—åˆ†å¸ƒå¼é›†ç¾¤çš„ä»£ä»·æ˜¯å¾ˆé«˜çš„ï¼Œèƒ½å¤Ÿå»é™¤è¿™æ ·çš„ä¾èµ–å½“ç„¶æ˜¯ä¸€ä»¶å¥½äº‹ã€‚</p><p>è®²åˆ°è¿™é‡Œï¼Œæˆ‘çŒœä½ ä¸€å®šå¾ˆæƒ³çŸ¥é“ï¼Œç¤¾åŒºç©¶ç«Ÿæ‰“ç®—æ€ä¹ˆç§»é™¤ZooKeeperå‘¢ï¼Ÿåˆ«æ€¥ï¼Œæˆ‘å¸¦ä½ ä¸€æ­¥æ­¥æ¥çœ‹ä¸‹ç¤¾åŒºçš„è®¡åˆ’ã€‚</p><h2>Clientsæ¼”è¿›</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸¤å¼ å›¾ã€‚è¿™ä¸¤å¼ å›¾æ€»ç»“äº†0.8.xç‰ˆæœ¬å’Œ0.11.xç‰ˆæœ¬ï¼ˆæ˜¯å¦çœŸçš„æ˜¯ä»0.11ç‰ˆæœ¬å¼€å§‹çš„å˜åŒ–å¹¶ä¸é‡è¦ï¼‰åŠåç»­ç‰ˆæœ¬çš„åŠŸèƒ½å˜è¿ã€‚</p><!-- [[[read_end]]] --><p><img src=\"https://static001.geekbang.org/resource/image/f3/3a/f362b8977ab64c1b086862a42c049f3a.jpg?wh=3000*2250\" alt=\"\"></p><p>åœ¨Kafka 0.8æ—¶ä»£ï¼ŒKafkaæœ‰3ä¸ªClientsç«¯ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul>\n<li>Producerï¼Œè´Ÿè´£å‘Kafkaå†™æ¶ˆæ¯ï¼›</li>\n<li>Consumerï¼Œè´Ÿè´£ä»Kafkaè¯»æ¶ˆæ¯ï¼›</li>\n<li>Admin Toolï¼Œæ‰§è¡Œå„ç§è¿ç»´ä»»åŠ¡ï¼Œæ¯”å¦‚åˆ›å»ºæˆ–åˆ é™¤ä¸»é¢˜ç­‰ã€‚</li>\n</ul><p>å…¶ä¸­ï¼ŒConsumerçš„ä½ç§»æ•°æ®ä¿å­˜åœ¨ZooKeeperä¸Šï¼Œå› æ­¤ï¼ŒConsumerç«¯çš„ä½ç§»æäº¤å’Œä½ç§»è·å–æ“ä½œéƒ½éœ€è¦è®¿é—®ZooKeeperã€‚å¦å¤–ï¼ŒAdmin Toolæ‰§è¡Œè¿ç»´æ“ä½œä¹Ÿè¦è®¿é—®ZooKeeperï¼Œæ¯”å¦‚åœ¨å¯¹åº”çš„ZooKeeper znodeä¸Šåˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œç„¶åç”±é¢„å®šä¹‰çš„Watchè§¦å‘ç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚</p><p>åæ¥ï¼Œéšç€Kafkaçš„æ¼”è¿›ï¼Œç¤¾åŒºå¼•å…¥äº†ä½ç§»ä¸»é¢˜ï¼ˆ__consumer_offsetsï¼‰ï¼ŒåŒæ—¶å®šä¹‰äº†OffsetFetchå’ŒOffsetCommitç­‰æ–°çš„RPCåè®®ã€‚è¿™æ ·ä¸€æ¥ï¼ŒConsumerçš„ä½ç§»æäº¤å’Œä½ç§»è·å–æ“ä½œä¸ä½ç§»ä¸»é¢˜ç›´æ¥äº¤äº’ï¼Œä»è€Œé¿å…äº†å¯¹ZooKeeperçš„è®¿é—®ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œç¤¾åŒºè¿˜å¼•å…¥äº†æ–°çš„è¿ç»´å·¥å…·AdminClientä»¥åŠç›¸åº”çš„CreateTopicsã€DeleteTopicsã€AlterConfigsç­‰RPCåè®®ï¼Œæ›¿æ¢äº†åŸå…ˆçš„Admin Toolã€‚äºæ˜¯ï¼Œåˆ›å»ºå’Œåˆ é™¤ä¸»é¢˜è¿™æ ·çš„è¿ç»´æ“ä½œä¹Ÿå®Œå…¨ç§»åŠ¨åˆ°Kafkaè¿™ä¸€ç«¯æ¥åšï¼Œå°±åƒä¸Šé¢çš„ç¬¬äºŒå¼ å›¾å±•ç¤ºçš„é‚£æ ·ã€‚</p><p>åˆ°è¿™é‡Œï¼ŒKafkaçš„3ä¸ªClientsç«¯åŸºæœ¬ä¸Šéƒ½ä¸éœ€è¦å’ŒZooKeeperäº¤äº’äº†ã€‚åº”è¯¥è¯´ï¼Œç§»é™¤ZooKeeperçš„å·¥ä½œå®Œæˆäº†ä¸€å¤§åŠï¼Œä¸è¿‡ï¼Œä¾ç„¶è¿˜æœ‰ä¸€éƒ¨åˆ†å·¥ä½œè¦åœ¨ZooKeeperçš„å¸®åŠ©ä¸‹å®Œæˆï¼Œé‚£å°±æ˜¯Consumerçš„Rebalanceæ“ä½œã€‚</p><p>åœ¨0.8æ—¶ä»£ï¼ŒConsumer Groupçš„ç®¡ç†æ˜¯äº¤ç”±ZooKeeperå®Œæˆçš„ï¼ŒåŒ…æ‹¬<strong>ç»„æˆå‘˜çš„ç®¡ç†</strong>å’Œ<strong>è®¢é˜…åˆ†åŒºçš„åˆ†é…</strong>ã€‚è¿™ä¸ªè®¾è®¡åœ¨æ–°ç‰ˆçš„Consumerä¸­ä¹Ÿå¾—åˆ°äº†ä¿®æ­£â€”â€”<strong>å…¨éƒ¨çš„Groupç®¡ç†æ“ä½œäº¤ç”±Kafka Brokerç«¯æ–°å¼•å…¥çš„Coordinatorç»„ä»¶æ¥å®Œæˆ</strong>ã€‚è¦å®Œæˆè¿™äº›å·¥ä½œï¼ŒBrokerç«¯æ–°å¢äº†å¾ˆå¤šRPCåè®®ï¼Œæ¯”å¦‚JoinGroupã€SyncGroupã€Heartbeatã€LeaveGroupç­‰ã€‚</p><p>æ­¤æ—¶ï¼ŒKafkaçš„Java Clientsç«¯é™¤äº†AdminClientè¿˜è¦ä¾èµ–ZooKeeperä¹‹å¤–ï¼Œæ‰€æœ‰å…¶ä»–çš„ç»„ä»¶å…¨éƒ¨æ‘†è„±äº†å¯¹ZooKeeperçš„ä¾èµ–ã€‚</p><p>ä¹‹åï¼Œç¤¾åŒºå¼•å…¥äº†Kafkaå®‰å…¨å±‚ï¼Œå®ç°äº†å¯¹ç”¨æˆ·çš„è®¤è¯å’Œæˆæƒã€‚è¿™ä¸ªé¢å¤–çš„å®‰å…¨å±‚ä¹Ÿæ˜¯ä¸éœ€è¦è®¿é—®ZooKeeperçš„ï¼Œå› æ­¤ï¼Œä¹‹å‰ä¾èµ–ZooKeeperçš„Clientsç«¯æ˜¯æ— æ³•â€œäº«ç”¨â€è¿™ä¸ªå®‰å…¨å±‚çš„ã€‚ä¸€æ—¦å¯ç”¨ï¼Œæ–°ç‰ˆClientséƒ½éœ€è¦é¦–å…ˆæ¥å…¥è¿™ä¸€å±‚ï¼Œè€Œä¸”è¦åœ¨é€šè¿‡å®¡æ ¸ä¹‹åæ‰èƒ½è®¿é—®åˆ°Brokerï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/3a/1a/3a11e19b0072b880ef5e13d296bb751a.jpg?wh=3817*1020\" alt=\"\"></p><p>è¿™ä¹ˆåšçš„å¥½å¤„å°±æ˜¯<strong>ç»Ÿä¸€äº†Clientsç«¯è®¿é—®Brokerç«¯çš„æ¨¡å¼</strong>ï¼Œå³é€šè¿‡å®šä¹‰ä¸€å¥—è·¨è¯­è¨€RPCåè®®æ ˆï¼Œå®ç°Clientsç«¯ä¸Brokerç«¯çš„æœåŠ¡è¿æ¥ã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸åŒçš„è¯­è¨€å¼€å‘è€…åªéœ€è¦æŒ‰ç…§è¿™å¥—è§„èŒƒå¼€å‘è‡ªå·±è¯­è¨€çš„RPCåè®®ï¼Œå°±èƒ½å®ç°ä¸Kafka Brokerç«¯çš„äº¤äº’äº†ã€‚å¦‚æœåé¢éœ€è¦å®ç°æ›´å¤šçš„åŠŸèƒ½ï¼Œç¤¾åŒºåªéœ€è¦å®šä¹‰æ–°çš„RPCåè®®å°±è¡Œäº†ã€‚åŒæ—¶ï¼Œæ–°å¼•å…¥çš„å®‰å…¨å±‚è´Ÿè´£å¯¹è¿™å¥—RPCåè®®è¿›è¡Œå®‰å…¨æ ¡éªŒï¼Œç»Ÿä¸€äº†è®¿é—®æ¨¡å¼ã€‚å¦å¤–ï¼Œè¿™äº›åè®®éƒ½æ˜¯ç‰ˆæœ¬åŒ–çš„ï¼ˆversionedï¼‰ï¼Œèƒ½å¤Ÿç‹¬ç«‹åœ°è¿›è¡Œæ¼”è¿›ï¼ŒåŒæ—¶ä¹Ÿå…¼é¡¾äº†å…¼å®¹æ€§æ–¹é¢çš„è€ƒé‡ã€‚</p><h2>Brokeré—´äº¤äº’</h2><p>è¯´å®Œäº†Clientsç«¯ï¼Œæˆ‘ä»¬è¯´ä¸‹Brokerç«¯çš„ç°çŠ¶ã€‚ç›®å‰ï¼Œåº”è¯¥è¯´Kafka Brokerç«¯å¯¹ZooKeeperæ˜¯é‡åº¦ä¾èµ–çš„ï¼Œä¸»è¦è¡¨ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ul>\n<li>Brokeræ³¨å†Œç®¡ç†ï¼›</li>\n<li>ACLå®‰å…¨å±‚é…ç½®ç®¡ç†ï¼›</li>\n<li>åŠ¨æ€å‚æ•°ç®¡ç†ï¼›</li>\n<li>å‰¯æœ¬ISRç®¡ç†ï¼›</li>\n<li>Controlleré€‰ä¸¾ã€‚</li>\n</ul><p>æˆ‘ä»¬æ‹¿ä¸€å¼ å›¾æ¥è¯´æ˜ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/36/e7/36d1738674d272c01af86f2c5e06f6e7.png?wh=1276*713\" alt=\"\"></p><p>å›¾ä¸­æœ‰4ä¸ªBrokerèŠ‚ç‚¹å’Œ1ä¸ªZooKeeperï¼Œå·¦ä¸Šè§’çš„Brokerå……å½“Controllerçš„è§’è‰²ã€‚å½“å‰ï¼Œæ‰€æœ‰çš„Brokerå¯åŠ¨åéƒ½å¿…é¡»ç»´æŒä¸ZooKeeperçš„ä¼šè¯ã€‚Kafkaä¾èµ–äºè¿™ä¸ªä¼šè¯å®ç°Brokerç«¯çš„æ³¨å†Œã€‚è€Œä¸”ï¼ŒKafkaé›†ç¾¤ä¸­çš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€å‰¯æœ¬ä¿¡æ¯ã€ä¸»é¢˜ä¿¡æ¯ä¹Ÿéƒ½ä¿å­˜åœ¨ZooKeeperä¸Šã€‚æœ€åï¼ŒControllerä¸é›†ç¾¤ä¸­çš„æ¯ä¸ªBrokeréƒ½ç»´æŒäº†ä¸€ä¸ªTCPé•¿è¿æ¥ï¼Œç”¨äºå‘è¿™äº›Brokerå‘é€RPCè¯·æ±‚ã€‚å½“å‰çš„Controller RPCç±»å‹ä¸»è¦æœ‰3å¤§ç±»ï¼š</p><ol>\n<li>LeaderAndIsrï¼šä¸»è¦ç”¨äºå‘é›†ç¾¤å¹¿æ’­ä¸»é¢˜åˆ†åŒºLeaderå’ŒISRçš„å˜æ›´æƒ…å†µï¼Œæ¯”å¦‚å¯¹åº”çš„Brokeråº”è¯¥æ˜¯ç‰¹å®šåˆ†åŒºçš„Leaderè¿˜æ˜¯Followerï¼›</li>\n<li>StopReplicaï¼šå‘é›†ç¾¤å¹¿æ’­æ‰§è¡Œåœæ­¢å‰¯æœ¬çš„å‘½ä»¤ï¼›</li>\n<li>UpdateMetadataï¼šå‘é›†ç¾¤å¹¿æ’­æ‰§è¡Œå˜æ›´å…ƒæ•°æ®ä¿¡æ¯çš„å‘½ä»¤ã€‚</li>\n</ol><p>å›¾ä¸­è¿˜æ–°å¢äº†ä¸€ä¸ªAlterISR RPCï¼Œè¿™æ˜¯KIP-497è¦å®ç°çš„æ–°RPCåè®®ã€‚ç°é˜¶æ®µï¼ŒKafkaå„ä¸ªä¸»é¢˜çš„ISRä¿¡æ¯å…¨éƒ¨ä¿å­˜åœ¨ZooKeeperä¸­ã€‚å¦‚æœåç»­è¦èˆå¼ƒZooKeeperï¼Œå°±å¿…é¡»å°†è¿™äº›ä¿¡æ¯ä»ZooKeeperä¸­ç§»å‡ºæ¥ï¼Œæ”¾åœ¨Controllerç«¯æ¥åšã€‚åŒæ—¶ï¼Œè¿˜è¦åœ¨ç¨‹åºå±‚é¢æ”¯æŒå¯¹ISRçš„ç®¡ç†ã€‚å› æ­¤ï¼Œç¤¾åŒºè®¡åˆ’åœ¨KIP-497ä¸Šå¢åŠ AlterISRåè®®ã€‚å¯¹äº†ï¼Œè¿˜è¦æä¸€å¥ï¼Œå½“å‰Controllerçš„é€‰ä¸¾ä¹Ÿæ˜¯ä¾é ZooKeeperå®Œæˆçš„ã€‚</p><p>æ‰€ä»¥ï¼Œåé¢Brokerç«¯çš„æ¼”è¿›å¯èƒ½å’ŒClientsç«¯çš„è·¯çº¿å·®ä¸å¤šï¼šé¦–å…ˆæ˜¯æŠŠBrokerä¸ZooKeeperçš„äº¤äº’å…¨éƒ¨å¹²æ‰ï¼Œåªè®©Controllerä¸ZooKeeperè¿›è¡Œäº¤äº’ï¼Œè€Œå…¶ä»–æ‰€æœ‰Brokeréƒ½åªä¸Controlleräº¤äº’ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/2f/e9/2fb41e8ab62cdf402c7cb56d681627e9.png?wh=1078*804\" alt=\"\"></p><p>çœ‹ä¸Šå»ï¼Œè¿™ç§æ¼”è¿›è·¯çº¿ç¤¾åŒºå·²ç»èµ°å¾—è½»è½¦ç†Ÿè·¯äº†ï¼Œä½†å®é™…ä¸Šè¿˜æœ‰ä¸€äº›é—ç•™é—®é¢˜ï¼Œéœ€è¦è§£å†³ã€‚</p><h3>Broker Liveness</h3><p>é¦–å…ˆå°±æ˜¯Brokerçš„livenessé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ï¼ŒKafkaå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªBrokeråˆ°åº•æ˜¯å¦å­˜æ´»ï¼Ÿåœ¨ç›®å‰çš„è®¾è®¡ä¸­ï¼ŒBrokerçš„ç”Ÿå­˜æ€§ç›‘æµ‹å®Œå…¨ä¾èµ–äºä¸ZooKeeperä¹‹é—´çš„ä¼šè¯ã€‚ä¸€æ—¦ä¼šè¯è¶…æ—¶æˆ–æ–­å¼€ï¼ŒControllerè‡ªåŠ¨è§¦å‘ZooKeeperç«¯çš„Watchæ¥ç§»é™¤è¯¥Brokerï¼Œå¹¶å¯¹å®ƒä¸Šé¢çš„åˆ†åŒºåšå–„åå¤„ç†ã€‚å¦‚æœç§»é™¤äº†ZooKeeperï¼ŒKafkaåº”è¯¥é‡‡ç”¨ä»€ä¹ˆæœºåˆ¶æ¥åˆ¤æ–­Brokerçš„ç”Ÿå­˜æ€§æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚</p><h3>Network Partition</h3><p><strong>å¦‚ä½•é˜²èŒƒç½‘ç»œåˆ†åŒºï¼ˆNetwork Partitionï¼‰</strong>ä¹Ÿæ˜¯ä¸€ä¸ªéœ€è¦è®¨è®ºçš„è¯é¢˜ã€‚å½“å‰å¯èƒ½å‡ºç°çš„Network Partitionæœ‰4ç§ï¼š</p><ol>\n<li>å•ä¸ªBrokerå®Œå…¨ä¸é›†ç¾¤éš”ç¦»ï¼›</li>\n<li>Brokeré—´æ— æ³•é€šè®¯ï¼›</li>\n<li>Brokerä¸ZooKeeperæ— æ³•é€šè®¯ï¼›</li>\n<li>Brokerä¸Controlleræ— æ³•é€šè®¯ã€‚</li>\n</ol><p>ä¸‹é¢4å¼ å›¾åˆ†åˆ«å±•ç¤ºäº†è¿™4ç§æƒ…å†µï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/24/c7/24df41ac85ca244b674dbe84f4d6bcc7.png?wh=1604*616\" alt=\"\"><br>\n<img src=\"https://static001.geekbang.org/resource/image/c2/88/c27c86320d961816516b75634fd67d88.png?wh=1546*720\" alt=\"\"></p><p>æˆ‘ä»¬åˆ†åˆ«æ¥è®¨è®ºä¸‹ã€‚</p><p>æƒ…å†µä¸€ï¼šå•Brokerä¸é›†ç¾¤çš„å…¶ä»–Brokeréš”ç¦»ï¼Œè¿™å…¶å®å¹¶ä¸ç®—å¤ªä¸¥é‡çš„é—®é¢˜ã€‚å½“å‰çš„è®¾è®¡å·²ç»èƒ½å¤Ÿä¿è¯å¾ˆå¥½åœ°åº”å¯¹è¿™ç§æƒ…å†µäº†ã€‚ä¸€æ—¦Brokerè¢«éš”ç¦»ï¼ŒControllerä¼šæŠŠå®ƒä»é›†ç¾¤ä¸­æ‘˜é™¤ï¼Œè™½ç„¶å¯ç”¨æ€§é™ä½äº†ï¼Œä½†æ˜¯æ•´ä¸ªé›†ç¾¤çš„ä¸€è‡´æ€§ä¾ç„¶èƒ½å¤Ÿå¾—åˆ°ä¿è¯ã€‚</p><p>æƒ…å†µäºŒï¼šBrokeré—´æ— æ³•é€šè®¯ï¼Œå¯èƒ½çš„åæœæ˜¯æ¶ˆæ¯çš„å¤‡ä»½æœºåˆ¶æ— æ³•æ‰§è¡Œï¼ŒKafkaè¦æ”¶ç¼©ISRï¼Œ<strong>ä¾ç„¶æ˜¯å¯ç”¨æ€§ä¸Šçš„é™ä½ï¼Œä½†æ˜¯ä¸€è‡´æ€§çŠ¶æ€å¹¶æ²¡æœ‰è¢«ç ´å</strong>ã€‚</p><p>æƒ…å†µä¸‰ï¼šBrokeræ— æ³•ä¸ZooKeeperé€šè®¯ã€‚Brokerèƒ½æ­£å¸¸è¿è½¬ï¼Œå®ƒåªæ˜¯æ— æ³•ä¸ZooKeeperè¿›è¡Œé€šè®¯ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¯´è¯¥Brokerå¤„äºåƒµå°¸çŠ¶æ€ï¼Œå³æ‰€è°“çš„ZoobieçŠ¶æ€ã€‚åœ¨ç¤¾åŒºçš„Jiraä¸­ï¼Œå› ZoobieçŠ¶æ€å¼•å…¥çš„ä¸€è‡´æ€§Bugä¸€ç›´æ²¡æœ‰æ–­è¿‡ï¼Œç¤¾åŒºè¿™å‡ å¹´ä¹Ÿä¸€ç›´åœ¨ä¿®æ­£è¿™æ–¹é¢çš„é—®é¢˜ï¼Œä¸»è¦å¯¹æŠ—çš„æœºåˆ¶å°±æ˜¯<strong>fencing</strong>ï¼Œæ¯”å¦‚Leader Epochã€‚</p><p>æƒ…å†µå››ï¼šBrokeræ— æ³•ä¸Controlleré€šè®¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„å…ƒæ•°æ®æ›´æ–°é€šé“è¢«å µæ­»ï¼Œå³ä½¿è¿™ä¸ªBrokerä¾ç„¶æ˜¯healthyçš„ï¼Œå®ƒä¿å­˜çš„å…ƒæ•°æ®ä¿¡æ¯ä¹Ÿå¯èƒ½æ˜¯éå¸¸è¿‡æœŸçš„ã€‚è¿™æ ·çš„è¯ï¼Œè¿æ¥è¿™ä¸ªBrokerçš„Clientsç«¯å¯èƒ½ä¼šçœ‹åˆ°å„ç§éå¸¸å¤æ€ªçš„é—®é¢˜ã€‚æˆ‘ä¹‹å‰å›ç­”è¿‡ç±»ä¼¼çš„é—®é¢˜ï¼Œä½ å¯ä»¥ç‚¹å‡»<a href=\"https://www.zhihu.com/question/313683699/answer/609887054\">é“¾æ¥</a>çœ‹ä¸€ä¸‹ã€‚</p><p>è¿™ç§æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘å°±å†å¤šå” å¨å‡ å¥ã€‚å®é™…ä¸Šï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œç›®å‰ç¤¾åŒºä¹Ÿæ²¡æœ‰å¤ªå¥½çš„è§£å†³åŠæ³•ï¼Œä¸»è¦çš„åŸå› æ˜¯ï¼ŒBrokerçš„livenesså®Œå…¨æ˜¯äº¤ç”±ZooKeeperæ¥åšçš„ã€‚ä¸€æ—¦Brokerä¸ZooKeeperä¹‹é—´çš„äº¤äº’æ²¡æœ‰é—®é¢˜ï¼Œå…¶ä»–åŸå› å¯¼è‡´çš„livenessé—®é¢˜å°±æ— æ³•å½»åº•è§„é¿ã€‚</p><p>ç¬¬å››ç±»Network Partitionå¼•å…¥äº†ä¸€ä¸ªç»å…¸çš„åœºæ™¯ï¼š<strong>å…ƒæ•°æ®ä¸ä¸€è‡´</strong>ã€‚ç›®å‰ï¼Œæ¯ä¸ªBrokeréƒ½ç¼“å­˜äº†ä¸€ä»½é›†ç¾¤çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè¿™ä»½æ•°æ®æ˜¯å¼‚æ­¥æ›´æ–°çš„ã€‚å½“ç¬¬å››ç±»Partitionå‘ç”Ÿçš„æ—¶å€™ï¼ŒBrokerç«¯ç¼“å­˜çš„å…ƒæ•°æ®ä¿¡æ¯å¿…ç„¶ä¸Controllerçš„ä¸åŒæ­¥ï¼Œè¿™å°±ä¼šé€ æˆå„ç§å„æ ·çš„é—®é¢˜ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹å…ƒæ•°æ®æ›´æ–°çš„è¿‡ç¨‹ã€‚ä¸»è¦æµç¨‹å°±æ˜¯ï¼ŒControllerå¯åŠ¨æ—¶ä¼šåŒæ­¥ä»ZooKeeperä¸Šæ‹‰å–é›†ç¾¤å…¨é‡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¹‹åå†ä»¥å¼‚æ­¥çš„æ–¹å¼åŒæ­¥ç»™å…¶ä»–Brokerã€‚å…¶ä»–Brokerä¸Controllerä¹‹é—´çš„åŒæ­¥å¾€å¾€æœ‰ä¸€ä¸ªæ—¶é—´å·®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒClientsè®¿é—®çš„å…ƒæ•°æ®å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ã€‚æˆ‘ä¸ªäººè®¤ä¸ºï¼Œç°åœ¨ç¤¾åŒºå¾ˆå¤šflaky test failureéƒ½æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´çš„ã€‚</p><p>äº‹å®ä¸Šï¼Œåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæœ‰å¾ˆå¤šåœºæ™¯æ˜¯Brokerç«¯çš„å…ƒæ•°æ®ä¸Controllerç«¯æ°¸è¿œä¸åŒæ­¥ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬ä¸é‡å¯Brokerçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªBrokerä¸Šçš„å…ƒæ•°æ®å°†æ°¸è¿œâ€œé”™è¯¯â€ä¸‹å»ã€‚</p><p>å¥½åœ¨ç¤¾åŒºè¿˜ç»™å‡ºäº†ä¸€ä¸ªæœ€åçš„â€œå¤§æ‹›â€ï¼š <strong>ç™»å½•åˆ°ZooKeeper SHELLï¼Œæ‰‹åŠ¨æ‰§è¡Œrmr /controllerï¼Œå¼ºè¿«Controlleré‡é€‰ä¸¾ï¼Œç„¶åé‡æ–°åŠ è½½å…ƒæ•°æ®ï¼Œå¹¶ç»™æ‰€æœ‰Brokeré‡åˆ·ä¸€ä»½</strong>ã€‚ä¸è¿‡ï¼Œæˆ‘æ€€ç–‘ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯å¦æœ‰äººçœŸçš„è¦è¿™ä¹ˆå¹²ï¼Œæ¯•ç«Ÿè¿™æ ·åšçš„ä»£ä»·ä¸å°ï¼Œè€Œä¸”æœ€å…³é”®çš„æ˜¯ï¼Œè¿™ä¹ˆåšä¾ç„¶å¯èƒ½å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol>\n<li>æˆ‘ä»¬å¦‚ä½•ç¡®ä¿Controllerå’ŒBrokerçš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Ÿ</li>\n<li>åŠ è½½å…ƒæ•°æ®çš„è¿‡ç¨‹é€šå¸¸å¾ˆæ…¢ã€‚</li>\n</ol><p>è¿™é‡Œæˆ‘è¯¦ç»†è¯´è¯´ç¬¬äºŒç‚¹ï¼Œå³åŠ è½½å…ƒæ•°æ®çš„æ€§èƒ½é—®é¢˜ã€‚</p><p>æ€»ä½“æ¥è¯´ï¼ŒåŠ è½½å…ƒæ•°æ®æ˜¯ä¸€ä¸ªO(N)æ—¶é—´å¤æ‚åº¦çš„è¿‡ç¨‹ï¼Œè¿™é‡Œçš„Nå°±æ˜¯ä½ é›†ç¾¤ä¸­æ€»çš„åˆ†åŒºæ•°ã€‚è€ƒè™‘åˆ°Controllerä»ZooKeeperåŠ è½½ä¹‹åè¿˜è¦æ¨ç»™å…¶ä»–çš„Brokerï¼Œé‚£ä¹ˆåšè¿™ä»¶äº‹çš„æ€»çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯O(N * M)ï¼Œå…¶ä¸­Mæ˜¯é›†ç¾¤ä¸­Brokerçš„æ•°é‡ã€‚å¯ä»¥æƒ³è§ï¼Œå½“Må’ŒNéƒ½å¾ˆå¤§æ—¶ï¼Œåœ¨é›†ç¾¤ä¸­å¹¿æ’­å…ƒæ•°æ®ä¸æ˜¯ä¸€ä¸ªå¾ˆå¿«çš„è¿‡ç¨‹ã€‚</p><p>è€ƒè™‘åˆ°åˆšåˆšæˆ‘ä»¬æåˆ°çš„æ‰€æœ‰é—®é¢˜ï¼Œå½“KafkaæŠ›å¼ƒäº†ZooKeeperä¹‹åï¼Œç¤¾åŒºå¦‚ä½•è§£å†³å®ƒä»¬å‘¢ï¼Ÿæ€»ä½“çš„æ€è·¯å°±æ˜¯<strong>Metadata as an Event Log + Controller quorum</strong>ã€‚æˆ‘ä»¬å…ˆè¯´metadata as an event logã€‚</p><h2>Metadata as an Event Log</h2><p>å¦‚æœä½ è¯»è¿‡Jay Krepsçš„ã€ŠI â¤ï¸ Logsã€‹ï¼Œä½ åº”è¯¥æœ‰æ„Ÿè§¦ï¼Œæ•´ä¸ªKafkaçš„æ¶æ„å…¶å®éƒ½æ˜¯æ„å»ºåœ¨Logä¸Šçš„ã€‚æ¯ä¸ªTopicçš„åˆ†åŒºæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªCommit Logï¼Œä½†å…ƒæ•°æ®ä¿¡æ¯çš„ä¿å­˜å´ä¸æ˜¯Logå½¢å¼ã€‚åœ¨ç°æœ‰çš„æ¶æ„è®¾è®¡ä¸­ï¼Œä½ åŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºå…ƒæ•°æ®çš„æ•°æ®ç»“æ„æ˜¯KVå½¢å¼çš„ã€‚è¿™ä¸€æ¬¡ï¼Œç¤¾åŒºé‡‡ç”¨äº†ä¸æ¶ˆæ¯ç›¸åŒçš„æ•°æ®ä¿å­˜æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å°†å…ƒæ•°æ®ä½œä¸ºLogçš„æ–¹å¼ä¿å­˜èµ·æ¥ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/7y/d2/7yyce6c9266a6814c82b95623de5ced2.jpg?wh=4000*2250\" alt=\"\"></p><p>åˆ©ç”¨Kafkaè‡ªèº«çš„Logæœºåˆ¶ä¿å­˜å…ƒæ•°æ®çš„åšæ³•ï¼Œæœ‰ä»¥ä¸‹4ä¸ªä¼˜ç‚¹ï¼š</p><ul>\n<li><strong>é«˜å¯ç”¨æ€§</strong>ï¼šæ¯æ¬¡å…ƒæ•°æ®çš„å˜æ›´éƒ½è¢«å½“ä½œæ˜¯ä¸€æ¡æ¶ˆæ¯ä¿å­˜åœ¨Logä¸­ï¼Œè€Œè¿™ä¸ªLogå¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªæ™®é€šçš„Kafkaä¸»é¢˜è¢«å¤‡ä»½åˆ°å¤šå°Brokerä¸Šã€‚</li>\n<li><strong>é¡ºåºæ€§</strong>ï¼šLogçš„ä¸€ä¸ªå¥½å¤„åœ¨äºå®ƒæœ‰æ¸…æ™°çš„å‰åé¡ºåºå…³ç³»ï¼Œå³<strong>æ¯ä¸ªäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æ˜¯å¯ä»¥æ’åºçš„</strong>ï¼Œé…åˆä»¥æ°å½“çš„å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬å°±èƒ½ä¿è¯ï¼Œå¯¹å…ƒæ•°æ®å˜æ›´çš„å¤„ç†æ˜¯æŒ‰ç…§å˜æ›´å‘ç”Ÿçš„æ—¶é—´è¿›è¡Œé¡ºåºå¤„ç†çš„ï¼Œä¸å‡ºç°ä¹±åºçš„æƒ…å½¢ã€‚</li>\n<li><strong>å¢é‡åŒæ­¥æ€§</strong>ï¼šåˆ©ç”¨Logæœºåˆ¶ä¹‹åï¼ŒBrokeré—´åŒæ­¥å…ƒæ•°æ®èƒ½å¤Ÿé‡‡ç”¨åŒæ­¥å¢é‡æ•°æ®ï¼ˆdeltaï¼‰çš„æ–¹å¼ï¼Œæ— éœ€æ¯æ¬¡éƒ½åŒæ­¥å…¨é‡æ•°æ®ã€‚ç›®å‰ï¼ŒKafka Brokeré—´åŒæ­¥å…ƒæ•°æ®éƒ½æ˜¯å…¨é‡çŠ¶æ€åŒæ­¥çš„ã€‚å‰é¢è¯´è¿‡äº†ï¼Œå½“é›†ç¾¤åˆ†åŒºæ•°å¾ˆå¤§æ—¶ï¼Œè¿™ä¸ªå¼€é”€æ˜¯å¾ˆå¯è§‚çš„ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤ŸåªåŒæ­¥å¢é‡çŠ¶æ€ï¼ŒåŠ¿å¿…èƒ½æå¤§åœ°é™ä½åŒæ­¥æˆæœ¬ã€‚</li>\n<li><strong>å¯ç›‘æ§æ€§</strong>ï¼šLogæä¾›äº†ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡ã€‚æˆ‘ä»¬æ ¹æ®è¿™äº›æŒ‡æ ‡èƒ½å¤Ÿè½»æ˜“åœ°è·å–åˆ°å…ƒæ•°æ®åŒæ­¥çš„è¿›åº¦ã€‚</li>\n</ul><p>é‡‡ç”¨Logæœºåˆ¶åï¼Œå…¶ä»–Brokeråƒæ˜¯ä¸€ä¸ªæ™®é€šçš„Consumerï¼Œä»Controlleræ‹‰å–å…ƒæ•°æ®å˜æ›´æ¶ˆæ¯æˆ–äº‹ä»¶ã€‚ç”±äºæ¯ä¸ªBrokeréƒ½æ˜¯ä¸€ä¸ªConsumerï¼Œæ‰€ä»¥å®ƒä»¬ä¼šç»´æŠ¤è‡ªå·±çš„æ¶ˆè´¹ä½ç§»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/6f/a7/6fed3629c35f413f8fa1bda543610fa7.png?wh=681*330\" alt=\"\"></p><p>åœ¨è¿™ç§è®¾è®¡ä¸‹ï¼ŒControlleræ‰€åœ¨çš„Brokerå¿…é¡»è¦æ‰¿æ‹…èµ·æ‰€æœ‰å…ƒæ•°æ®Topicçš„ç®¡ç†å·¥ä½œï¼ŒåŒ…æ‹¬åˆ›å»ºTopicã€ç®¡ç†Topicåˆ†åŒºçš„Leaderä»¥åŠä¸ºæ¯ä¸ªå…ƒæ•°æ®å˜æ›´åˆ›å»ºç›¸åº”çš„äº‹ä»¶ç­‰ã€‚æ—¢ç„¶ç¤¾åŒºé€‰æ‹©å’Œ__consumer_offsetsç±»ä¼¼çš„å¤„ç†æ–¹å¼ï¼Œä¸€ä¸ªå¾ˆè‡ªç„¶çš„é—®é¢˜å°±æ˜¯ï¼Œè¿™ä¸ªå…ƒæ•°æ®Topicçš„ç®¡ç†æ˜¯å¦èƒ½å¤Ÿå¤ç”¨Kafkaç°æœ‰çš„å‰¯æœ¬æœºåˆ¶ï¼Ÿç­”æ¡ˆæ˜¯ï¼šä¸å¯è¡Œã€‚ç†ç”±æ˜¯ç°æœ‰çš„å‰¯æœ¬æœºåˆ¶ä¾èµ–äºControllerï¼Œå› æ­¤ï¼ŒKafkaæ²¡æ³•ä¾é ç°æœ‰çš„å‰¯æœ¬æœºåˆ¶æ¥å®ç°Controllerã€‚æŒ‰ç…§æˆ‘ä»¬çš„ä¿—è¯­æ¥è¯´ï¼Œè¿™æœ‰ç‚¹â€œé¸¡ç”Ÿè›‹ã€è›‹ç”Ÿé¸¡â€œçš„é—®é¢˜ï¼Œå±äºå…¸å‹çš„å¾ªç¯ä¾èµ–ã€‚</p><p>ä¸ºäº†å®ç°è¿™ä¸ªï¼ŒKafkaéœ€è¦ä¸€å¥—Leaderé€‰ä¸¾åè®®ï¼Œè€Œè¿™å¥—åè®®æˆ–ç®—æ³•æ˜¯ä¸ä¾èµ–äºControllerçš„ï¼Œå³å®ƒæ˜¯ä¸€ä¸ªè‡ªç®¡ç†çš„é›†ç¾¤quorumï¼ˆæŠ±æ­‰ï¼Œåœ¨åˆ†å¸ƒå¼é¢†åŸŸå†…ï¼Œç‰¹åˆ«æ˜¯åˆ†å¸ƒå¼å…±è¯†ç®—æ³•é¢†åŸŸä¸­ï¼Œé’ˆå¯¹quorumçš„æ°å½“ç¿»è¯‘æˆ‘ç›®å‰è¿˜æœªæ‰¾åˆ°ï¼Œå› æ­¤ç›´æ¥ä½¿ç”¨quorumåŸè¯äº†ï¼‰ã€‚æœ€ç»ˆï¼Œç¤¾åŒºå†³å®šé‡‡ç”¨Raftæ¥å®ç°è¿™ç»„quorumã€‚è¿™å°±æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ç¬¬äºŒä¸ªè§£å†³æ€è·¯ï¼šController quorumã€‚</p><h2>Controller Quorum</h2><p>ä¸å€ŸåŠ©Controllerå¸®å¿™é€‰æ‹©Leaderä¸åŒï¼ŒRaftæ˜¯è®©è‡ªå·±çš„èŠ‚ç‚¹è‡ªè¡Œé€‰æ‹©Leaderï¼Œå¹¶æœ€ç»ˆä»¤æ‰€æœ‰èŠ‚ç‚¹è¾¾æˆå…±è¯†ã€‚å¯¹é€‰æ‹©Controllerè€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ã€‚å…¶å®ï¼ŒKafkaç°æœ‰çš„å¤‡ä»½æœºåˆ¶å·²ç»è·ŸRaftå¾ˆæ¥è¿‘äº†ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ä¸‹é¢è¿™å¼ è¡¨æ ¼ï¼Œç®€å•å¯¹å®ƒä»¬è¿›è¡Œä¸‹å¯¹æ¯”ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2b/73/2bb605df5969f7160ec3b0e7b1cce273.jpeg?wh=1379*773\" alt=\"\"></p><p>ä¸€çœ¼æ‰«è¿‡å»ï¼Œä½ ä¼šå‘ç°ï¼Œå…¶å®Kafkaçš„å¤‡ä»½æœºåˆ¶å’ŒRaftå¾ˆç±»ä¼¼ï¼Œæ¯”å¦‚ï¼ŒKafkaä¸­çš„offsetå…¶å®å°±æ˜¯Raftä¸­çš„indexï¼Œepochå¯¹åº”äºtermã€‚å½“ç„¶ï¼ŒRaftä¸­é‡‡ç”¨åŠæ•°æœºåˆ¶æ¥ç¡®ä¿æ¶ˆæ¯è¢«æäº¤ä»¥åŠLeaderé€‰ä¸¾ï¼Œè€ŒKafkaè®¾è®¡äº†ISRæœºåˆ¶æ¥å®ç°è¿™ä¸¤ç‚¹ã€‚æ€»ä½“æ¥è¯´ï¼Œç¤¾åŒºè®¤ä¸ºåªéœ€è¦å¯¹å¤‡ä»½æœºåˆ¶åšä¸€äº›å°æ”¹åŠ¨ï¼Œåº”è¯¥å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ‡æ¢åˆ°Raft-basedç®—æ³•äº†ã€‚</p><p>ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºçš„Controller quorumå¯èƒ½æ›´åŠ ç›´è§‚ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/e7/fd/e7b060b49yy1ba7776879e90bc672dfd.jpg?wh=4000*2250\" alt=\"\"></p><p>æ•´ä¸ªController quorumç±»ä¼¼äºä¸€ä¸ªå°çš„é›†ç¾¤ã€‚å’ŒZooKeeperç±»ä¼¼ï¼Œè¿™ä¸ªquorumé€šå¸¸æ˜¯3å°æˆ–5å°æœºå™¨ï¼Œä¸éœ€è¦è®©Kafkaä¸­çš„æ¯ä¸ªBrokeréƒ½è‡ªåŠ¨æˆä¸ºè¿™ä¸ªquorumä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>è¯¥quorumé‡Œé¢æœ‰ä¸€ä¸ªLeaderè´Ÿè´£å¤„ç†Clientsç«¯å‘æ¥çš„è¯»å†™è¯·æ±‚ï¼Œè¿™ä¸ªLeaderå°±æ˜¯Kafkaä¸­çš„active Controllerã€‚æ ¹æ®ZooKeeperçš„Zabåè®®ï¼ŒLeaderå¤„ç†æ‰€æœ‰çš„å†™è¯·æ±‚ï¼Œè€ŒFolloweræ˜¯å¯ä»¥å¤„ç†è¯»è¯·æ±‚çš„ã€‚å½“å†™è¯·æ±‚å‘é€ç»™Followeråï¼ŒFollowerä¼šå°†è¯¥è¯·æ±‚è½¬å‘ç»™Leaderå¤„ç†ã€‚</p><p>ä¸è¿‡ï¼Œæˆ‘çŒœKafkaåº”è¯¥ä¸ä¼šè¿™æ ·å®ç°ï¼Œå®ƒåº”è¯¥åªä¼šè®©Leaderï¼ˆå³active Controllerï¼‰å¤„ç†æ‰€æœ‰çš„è¯»å†™è¯·æ±‚ï¼Œè€ŒClientsç«¯ï¼ˆä¹Ÿå°±æ˜¯å…¶ä»–Brokerï¼‰å‹æ ¹å°±ä¸ä¼šå‘é€è¯»å†™è¯·æ±‚ç»™Followerã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œè¿™ç§è®¾è®¡å’Œç°æœ‰çš„Kafkaè¯·æ±‚å¤„ç†æœºåˆ¶æ˜¯ä¸€è‡´çš„ã€‚</p><p>ç°åœ¨è¿˜éœ€è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå³Leaderæ˜¯æ€ä¹ˆè¢«é€‰å‡ºæ¥çš„ï¼Ÿæ—¢ç„¶æ˜¯Raft-basedï¼Œé‚£ä¹ˆé‡‡ç”¨çš„ä¹Ÿæ˜¯Raftç®—æ³•ä¸­çš„Leaderé€‰ä¸¾ç­–ç•¥ã€‚è®©Rafté€‰å‡ºçš„Leaderç§°ä¸ºactive Controllerã€‚ç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºRafté€‰ä¸»çš„æ–‡ç« ï¼Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è¯»ä¸€è¯»Raftçš„è®ºæ–‡ï¼š<a href=\"https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf\"><em>In Search of an Understandable Consensus Algorithm(Extended Version)</em></a>ã€‚</p><p>è¿™å¥—Raft quorumæœ‰2ä¸ªå¥½å¤„ã€‚</p><p>ç¬¬ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œå®ƒå¤©ç„¶æä¾›äº†ä½å»¶æ—¶çš„Failoverï¼Œå› æ­¤ï¼ŒLeaderçš„åˆ‡æ¢ä¼šéå¸¸å¾—è¿…é€Ÿå’ŒåŠæ—¶ï¼Œå› ä¸ºç†è®ºä¸Šä¸å†æœ‰å…ƒæ•°æ®åŠ è½½çš„è¿‡ç¨‹äº†ï¼Œæ‰€æœ‰çš„å…ƒæ•°æ®ç°åœ¨éƒ½åŒæ­¥ä¿å­˜FollowerèŠ‚ç‚¹çš„å†…å­˜ä¸­ï¼Œå®ƒå·²ç»æœ‰å…¶ä»–Brokeréœ€è¦æ‹‰å–çš„æ‰€æœ‰å…ƒæ•°æ®ä¿¡æ¯äº†ï¼</p><p>æ›´é…·çš„æ˜¯ï¼Œå®ƒé¿å…äº†ç°åœ¨æœºåˆ¶ä¸­ä¸€æ—¦Controlleråˆ‡æ¢ï¼Œå°±è¦å…¨é‡æ‹‰å–å…ƒæ•°æ®çš„ä½æ•ˆè¡Œä¸ºï¼ŒBrokerä¸éœ€è¦é‡æ–°æ‹‰å–ä¹‹å‰å·²ç»â€œæ¶ˆè´¹â€çš„å…ƒæ•°æ®å˜æ›´æ¶ˆæ¯ï¼Œåªéœ€è¦ä»æ–°Leaderç»§ç»­â€œæ¶ˆè´¹â€å³å¯ã€‚</p><p>å¦ä¸€ä¸ªå¥½å¤„åœ¨äºï¼Œé‡‡ç”¨äº†è¿™å¥—æœºåˆ¶åï¼ŒKafkaå¯ä»¥<strong>åšå…ƒæ•°æ®çš„ç¼“å­˜</strong>äº†ï¼ˆmetadata cachingï¼‰ï¼Œå³Brokerèƒ½å¤ŸæŠŠå…ƒæ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚åŒæ—¶ï¼Œå°±åƒåˆšæ‰è¯´çš„ï¼ŒBrokeråªéœ€è¯»å–å®ƒå…³å¿ƒçš„é‚£éƒ¨åˆ†æ•°æ®å³å¯ã€‚å¦å¤–ï¼Œå’Œç°åœ¨çš„snapshotæœºåˆ¶ç±»ä¼¼ï¼Œå¦‚æœä¸€ä¸ªBrokerä¿å­˜çš„å…ƒæ•°æ®è½åControllerå¤ªå¤šï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå…¨æ–°çš„Brokerï¼ŒKafkaç”šè‡³å¯ä»¥åƒRafté‚£æ ·ç›´æ¥å‘é€ä¸€ä¸ªsnapshotæ–‡ä»¶ï¼Œå¿«é€Ÿä»¤å…¶è¿½ä¸Šè¿›åº¦ã€‚å½“ç„¶ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒBrokeråªéœ€è¦æ‹‰å–deltaå¢é‡æ•°æ®å°±è¡Œäº†ã€‚</p><h2>æ€»ç»“</h2><p>åŸºäºä»¥ä¸Šçš„è¿™äº›è§£å†³æ–¹æ¡ˆï¼Œç¤¾åŒºæ‰“ç®—åˆ†ä¸‰æ­¥æ¥å®Œæˆå¯¹ZooKeeperçš„ä¾èµ–ï¼š</p><ol>\n<li>ç¬¬ä¸€æ­¥ï¼šç§»é™¤Clientsç«¯å¯¹ZooKeeperçš„ä¾èµ–ã€‚è¿™ä¸€æ­¥åŸºæœ¬ä¸Šå·²ç»å®Œæˆäº†ï¼Œé™¤äº†ç›®å‰AdminClientè¿˜æœ‰å°‘é‡çš„APIä¾èµ–ZooKeeperä¹‹å¤–ï¼Œå…¶ä»–Clientsç«¯åº”è¯¥è¯´éƒ½ä¸éœ€è¦è®¿é—®ZooKeeperäº†ã€‚</li>\n<li>ç¬¬äºŒæ­¥ï¼šç§»é™¤Brokerç«¯çš„ZooKeeperä¾èµ–ã€‚è¿™ä¸»è¦åŒ…æ‹¬ç§»é™¤Brokerç«¯éœ€è¦è®¿é—®ZooKeeperçš„ä»£ç ï¼Œä»¥åŠå¢åŠ æ–°çš„Brokerç«¯APIï¼Œæ¯”å¦‚å‰é¢è¯´çš„AlterISRç­‰ï¼Œæœ€åæ˜¯å°†å¯¹ZooKeeperçš„è®¿é—®å…¨éƒ¨é›†ä¸­åœ¨controllerç«¯ã€‚</li>\n<li>æœ€åä¸€æ­¥ï¼šå®ç°controller quorumï¼Œä¹Ÿå°±æ˜¯å®ç°Raft-basedçš„quorumè´Ÿè´£controllerçš„é€‰ä¸¾ã€‚</li>\n</ol><p>åº”è¯¥è¯´ï¼Œç§»é™¤ZooKeeperçš„åŠŸèƒ½ç®—æ˜¯è¿‘å‡ å¹´ç¤¾åŒºæœ€ä¸ºé‡ç£…çš„ææ¡ˆäº†ã€‚è¿™ä¸ªææ¡ˆæ¶‰åŠç»„ä»¶ä¹‹å¹¿ã€å†æ—¶ä¹‹é•¿ã€å¤æ‚ç¨‹åº¦ä¹‹é«˜åœ¨ç¤¾åŒºä¸­éå¸¸ç½•è§ã€‚ä¸€æ—¦åç»­å®Œæ•´åœ°å®ç°äº†è¿™ä¸ªåŠŸèƒ½ï¼ŒApache Kafkaå°†æå¤§åœ°æå‡è‡ªå·±çš„å¯ç»´æŠ¤æ€§ï¼Œä»¥ä¸€ä¸ªæ›´åŠ â€œæ¸…çˆ½â€çš„å½¢è±¡å‡ºç°åœ¨æˆ‘ä»¬é¢å‰ã€‚è‡³äºæœ€åçš„æ•ˆæœå¦‚ä½•ï¼Œå°±è®©æˆ‘ä»¬æ‹­ç›®ä»¥å¾…å§ã€‚</p><h2>è¯¾åè®¨è®º</h2><p>æˆ‘åœ¨å‰é¢æåˆ°ï¼Œç¤¾åŒºæ‰“ç®—è‡ªå·±å†™ä¸€å¥—Raft-basedçš„ç®—æ³•æ¥å®ç°Controllerçš„é€‰ä¸¾ï¼Œä½ è§‰å¾—ï¼Œä¸ºä»€ä¹ˆç¤¾åŒºä¸ç›´æ¥é‡‡ç”¨ç¬¬ä¸‰æ–¹æˆç†Ÿçš„Raftåº“æ¥å®ç°å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºç•…æ‰€æ¬²è¨€ï¼Œè·Ÿæˆ‘äº¤æµè®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"ç‰¹åˆ«æ”¾é€ï¼ˆå››ï¼‰| 20é“ç»å…¸çš„Kafkaé¢è¯•é¢˜è¯¦è§£","id":246934},"right":{"article_title":"æœŸä¸­æµ‹è¯• | è¿™äº›æºç çŸ¥è¯†ï¼Œä½ éƒ½æŒæ¡äº†å—ï¼Ÿ","id":240289}},"comments":[{"had_liked":false,"id":229985,"user_name":"JustDoDT","can_delete":false,"product_type":"c1","uid":1309264,"ip_address":"","ucode":"421E3C3891BA25","user_header":"https://static001.geekbang.org/account/avatar/00/13/fa/50/85d65987.jpg","comment_is_top":false,"comment_ctime":1593234720,"is_pvip":false,"replies":[{"id":"84953","content":"è°¢è°¢é¼“åŠ±ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593304824,"ip_address":"","comment_id":229985,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14478136608","product_id":100050101,"comment_content":"è®²å¾—çœŸä¸é”™","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499727,"discussion_content":"è°¢è°¢é¼“åŠ±ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593304824,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":275591,"user_name":"å¤§ä¸¥","can_delete":false,"product_type":"c1","uid":1000814,"ip_address":"","ucode":"8CC8B7586AA3EF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/45/6e/ffdb91fe.jpg","comment_is_top":false,"comment_ctime":1611591381,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5906558677","product_id":100050101,"comment_content":"æµ©æµ©è¡è¡çš„ä¸€ç¯‡å¥½æ–‡","like_count":1},{"had_liked":false,"id":248912,"user_name":"æŸ æª¬C","can_delete":false,"product_type":"c1","uid":1181505,"ip_address":"","ucode":"BC0EE704D952A4","user_header":"https://static001.geekbang.org/account/avatar/00/12/07/41/2d477385.jpg","comment_is_top":false,"comment_ctime":1600353996,"is_pvip":false,"replies":[{"id":"91365","content":"è¿™ä¸ªè¯é¢˜æœ‰ç‚¹å¤§äº†ã€‚åˆ†å¸ƒå¼é¢†åŸŸçš„ç¡®æœ‰ä¸€äº›é€šç”¨çš„é—®é¢˜æ˜¯æ‰€æœ‰æ¡†æ¶éƒ½è¦é¢ä¸´å’Œè§£å†³çš„ï¼Œæ¯”å¦‚Leaderé€‰ä¸¾ã€replicationã€partitioningã€failoverã€ä¸€è‡´æ€§ç­‰ã€‚æ¯ä¸€ä¸ªè‡ªç„¶éƒ½æœ‰ç›¸åº”çš„ç ”ç©¶è®ºæ–‡æˆæœå‡ºæ¥ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1600390652,"ip_address":"","comment_id":248912,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5895321292","product_id":100050101,"comment_content":"åœ¨åˆæ­¥å­¦ä¹ kafkaå’Œesçš„æ—¶å€™ï¼Œå°±æ„Ÿåˆ°kafkaå’Œesåœ¨æ¶æ„ä¸Šå…¶å®éå¸¸ç±»ä¼¼ï¼Œæ¯”å¦‚æ•°æ®éƒ½æ˜¯åŸºäºLSMTreeç»„ç»‡ã€æ•°æ®åˆ†ç‰‡&#47;åˆ†åŒºã€åˆ†åŒºä¹Ÿæœ‰ä¸»ä»çš„æ¦‚å¿µç­‰ï¼Œç”šè‡³esæ•°æ®åŒæ­¥ï¼Œä¹Ÿé‡‡å–äº†åƒkafkaä¸€æ ·çš„2æ­¥æ‹‰å–æ›´æ–°HWã€epoché¿å…ä¸ä¸€è‡´çš„æ–¹å¼ã€‚è¯·é—®è€å¸ˆï¼Œæ˜¯åˆ†å¸ƒå¼é¢†åŸŸæœ‰ä»€ä¹ˆè®ºæ–‡æ”¯æ’‘è¿™ä¹ˆå¤šçš„å¼€æºç»„ä»¶é‡‡ç”¨è¿™ç§å®ç°å—ï¼Ÿå¦åˆ™ä¹Ÿå¤ªå·§äº†<br>esä¸åŒäºkafkaçš„åœ°æ–¹åœ¨äºesåŸºäºbullyç®—æ³•å’Œraftç®—æ³•å®ç°é€‰ä¸»ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œä½†å¯¹äºraftå®ç°ä¹Ÿæœ‰æ‰€æ”¹åŠ¨ã€‚æœŸå¾…æœªæ¥kafkaä¸esåœ¨æ¶æ„ä¸Šåˆä¸€æ¬¡è¿›è¡Œæ¶æ„ä¸Šçš„æ¯”è¾ƒ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505774,"discussion_content":"è¿™ä¸ªè¯é¢˜æœ‰ç‚¹å¤§äº†ã€‚åˆ†å¸ƒå¼é¢†åŸŸçš„ç¡®æœ‰ä¸€äº›é€šç”¨çš„é—®é¢˜æ˜¯æ‰€æœ‰æ¡†æ¶éƒ½è¦é¢ä¸´å’Œè§£å†³çš„ï¼Œæ¯”å¦‚Leaderé€‰ä¸¾ã€replicationã€partitioningã€failoverã€ä¸€è‡´æ€§ç­‰ã€‚æ¯ä¸€ä¸ªè‡ªç„¶éƒ½æœ‰ç›¸åº”çš„ç ”ç©¶è®ºæ–‡æˆæœå‡ºæ¥ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600390652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341646,"user_name":"æå®¶å¤§å°‘çˆ·ææ˜‚åˆ","can_delete":false,"product_type":"c1","uid":2367658,"ip_address":"","ucode":"7A0A10037E102A","user_header":"https://static001.geekbang.org/account/avatar/00/24/20/aa/653031aa.jpg","comment_is_top":false,"comment_ctime":1649749932,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649749932","product_id":100050101,"comment_content":"å¦ä¸€ä¸ªå¥½å¤„åœ¨äºï¼Œé‡‡ç”¨äº†è¿™å¥—æœºåˆ¶åï¼ŒKafka å¯ä»¥åšå…ƒæ•°æ®çš„ç¼“å­˜äº†ï¼ˆmetadata cachingï¼‰ï¼Œå³ Broker èƒ½å¤ŸæŠŠå…ƒæ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚<br>è¿™é‡Œåº”è¯¥æ˜¯å…ƒæ•°æ®çš„æŒä¹…åŒ–å§ï¼Ÿæœ¬æ¥å…ƒæ•°æ®å°±æ˜¯å­˜åœ¨å†…å­˜å½“ä¸­çš„ã€‚","like_count":0},{"had_liked":false,"id":295507,"user_name":"å…”2ğŸ°ğŸƒ","can_delete":false,"product_type":"c1","uid":1096984,"ip_address":"","ucode":"1FEDA044BB6CBD","user_header":"https://static001.geekbang.org/account/avatar/00/10/bd/18/2af6bf4b.jpg","comment_is_top":false,"comment_ctime":1622455413,"is_pvip":false,"replies":[{"id":"108495","content":"ç›®å‰æ²¡æœ‰å¾—çŸ¥æœ‰å¤§çš„å…¼å®¹æ€§é—®é¢˜ã€‚ä½ æ˜¯ä½¿ç”¨ä»€ä¹ˆç‰ˆæœ¬æ—¶ç¢°åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1624497912,"ip_address":"","comment_id":295507,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1622455413","product_id":100050101,"comment_content":"èƒ¡è€å¸ˆï¼Œè¯·æ•™ä¸‹2.2.2ä¹‹åçš„ç‰ˆæœ¬éƒ½å‘ä¸‹å…¼å®¹ä¹ˆï¼Œç›®å‰é‡åˆ°Security vulenerabilities ï¼Œzk3.4.13ã€‚è¯•è¿‡2.3.1åŠä¹‹åçš„ï¼Œåˆæœ‰Netty ç›¸å…³åŒ…çš„security riskã€‚è¯·é—®è¿™ä¸ªæœ‰ä»€ä¹ˆå¥½çš„æ–¹æ³•ä¸ã€‚æˆ–è€…ç”¨2.6ä¹‹åçš„ç‰ˆæœ¬ä¼šæœ‰å…¼å®¹é—®é¢˜ä¹ˆã€‚","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521109,"discussion_content":"ç›®å‰æ²¡æœ‰å¾—çŸ¥æœ‰å¤§çš„å…¼å®¹æ€§é—®é¢˜ã€‚ä½ æ˜¯ä½¿ç”¨ä»€ä¹ˆç‰ˆæœ¬æ—¶ç¢°åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624497912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239803,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1596646530,"is_pvip":false,"replies":[{"id":"88657","content":"éå¸¸æœ‰å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µã€‚å½“ç„¶ï¼Œç¤¾åŒºè‡ªå·±å®ç°Raft-based protocolçš„ä¸€ä¸ªåŸå› æ˜¯è‡ªå·±å®ç°çš„å¯ä»¥è‡ªè¡ŒæŠŠæ§ï¼Œä¸å—ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¦åˆ™å’Œç§»é™¤Zkçš„åˆè¡·ä¸ç¬¦","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1596771882,"ip_address":"","comment_id":239803,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1596646530","product_id":100050101,"comment_content":"æˆ‘æ›¾ç»è¯•è¿‡å°è¯•ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„å…±è¯†ç®—æ³•åº“ï¼Œä½†æ˜¯åœ¨å¯¼å…¥é¡¹ç›®çš„æ—¶å€™å‘ç°å…¶ä¾èµ–äº†å„ç§ç‰ˆæœ¬çš„jarï¼Œç”šè‡³æœ‰äº›jarçš„ç‰ˆæœ¬æ¯”æˆ‘å½“å‰é¡¹ç›®ä¸­å·²ç»ä¾èµ–çš„ç‰ˆæœ¬è¿˜ä½ï¼Œè€Œä¸”ä¸¤ä¸ªç‰ˆæœ¬æ˜¯å†²çªçš„ï¼Œé«˜ç‰ˆæœ¬çš„jarä¸­åˆ é™¤äº†ä¸€äº›ç±»ï¼Œå¯¼è‡´å¯åŠ¨çš„æ—¶å€™å‡ºç°å„ç§æƒ…å†µï¼Œæ¯”å¦‚classNotFound æˆ–è€… classNotDefiendï¼Œæˆ‘æƒ³ç¤¾åŒºå¯èƒ½ä¹Ÿæƒ³é¿å…è¿™ç§æƒ…å†µ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503226,"discussion_content":"éå¸¸æœ‰å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µã€‚å½“ç„¶ï¼Œç¤¾åŒºè‡ªå·±å®ç°Raft-based protocolçš„ä¸€ä¸ªåŸå› æ˜¯è‡ªå·±å®ç°çš„å¯ä»¥è‡ªè¡ŒæŠŠæ§ï¼Œä¸å—ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¦åˆ™å’Œç§»é™¤Zkçš„åˆè¡·ä¸ç¬¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596771882,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1799983,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/77/2f/6796cde2.jpg","nickname":"å¤§ç»´","note":"","ucode":"3EEEBEB92764AB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348476,"discussion_content":"ç¨å¾®æ‰¯è¿œä¸€ç‚¹ï¼Œkafkaå¼€å‘ä¹‹å¤„å°±æ˜¯è‡ªå·±å®ç°å„ç§åè®®ï¼Œå°½é‡é¿å…ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„åº“ã€‚åŸå› ï¼š\n1. Existing answers say that performance drove the decision - which is absolutely correct, but is only part of the reason. \n2. The rest of the reason is dependencies.  \n\nSo we stayed the hell away from any library that can possibly cause conflicts and implemented way too much ourselves. Kafkaâ€™s very own metricâ€™s library, avoiding the popular Curator library for ZK, etc.\n\nä¸ºæ­¤è€Œä»˜å‡ºçš„ä»£ä»·ä¹Ÿæ˜¯è›®å¤§çš„ï¼šWas it the right choice? Itâ€™s hard to know for sure. Performance and no dependency-hell is great! But we are paying the price over and over - our own security layers (which Netty would have provided), very odd bugs caused by changes in low level networking code in different operating systems that take forever to debug (and we assume Netty already solvedâ€¦).\n\nsource: https://www.quora.com/Why-did-Kafka-developers-prefer-to-implement-their-own-socket-server-instead-of-using-Netty-Does-that-help-with-performance-Does-Kafka-implement-such-features-already","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612595504,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":235429,"user_name":"æå…ˆç”Ÿ","can_delete":false,"product_type":"c1","uid":1237614,"ip_address":"","ucode":"D9039715F7D290","user_header":"https://static001.geekbang.org/account/avatar/00/12/e2/6e/0a300829.jpg","comment_is_top":false,"comment_ctime":1595032575,"is_pvip":false,"replies":[{"id":"87080","content":"æ˜¯å¦è°ƒç”¨äº†producer.closeæ–¹æ³•ï¼Ÿ<br>","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1595212993,"ip_address":"","comment_id":235429,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1595032575","product_id":100050101,"comment_content":"èƒ¡å“¥ï¼Œæœ‰ä¸ªé—®é¢˜ã€‚kafkaç”Ÿäº§è€…åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæœ‰æ—¶å€™ä¼šæŠ¥å¼ºåˆ¶å…³é—­çš„å¼‚å¸¸ï¼šIllegalStateError: Producer is closed forcefully.è¿™ç§æœ‰ä»€ä¹ˆå¥½çš„è§£å†³æ–¹æ¡ˆå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501716,"discussion_content":"æ˜¯å¦è°ƒç”¨äº†producer.closeæ–¹æ³•ï¼Ÿ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595212993,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1237614,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e2/6e/0a300829.jpg","nickname":"æå…ˆç”Ÿ","note":"","ucode":"D9039715F7D290","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292391,"discussion_content":"å¹¶æ²¡æœ‰æ˜¾å¼è°ƒç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595213599,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230158,"user_name":"Cryhard","can_delete":false,"product_type":"c1","uid":1589593,"ip_address":"","ucode":"E0BF4548B502CB","user_header":"https://static001.geekbang.org/account/avatar/00/18/41/59/78042964.jpg","comment_is_top":false,"comment_ctime":1593296887,"is_pvip":false,"replies":[{"id":"84993","content":"è¿™ä¸ªè¦çœ‹KIP-500çš„è¿›åº¦äº†ï¼šï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"èƒ¡å¤•","uid":"1288090","ctime":1593323887,"ip_address":"","comment_id":230158,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593296887","product_id":100050101,"comment_content":"ç­‰è¿™ä¸€åˆ‡éƒ½å®ç°ï¼Œåº”è¯¥æ˜¯2021å¹´çš„3.0ç‰ˆæœ¬äº†å§ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"èƒ¡å¤•","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499789,"discussion_content":"è¿™ä¸ªè¦çœ‹KIP-500çš„è¿›åº¦äº†ï¼šï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593323887,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}