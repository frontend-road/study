{"id":550598,"title":"30｜系统监控：如何使用Metrics Server和Prometheus？","content":"<p>你好，我是Chrono。</p><p>在前面的两节课里，我们学习了对Pod和对集群的一些管理方法，其中的要点就是设置资源配额，让Kubernetes用户能公平合理地利用系统资源。</p><p>虽然有了这些方法，但距离我们把Pod和集群管好用好还缺少一个很重要的方面——集群的可观测性。也就是说，我们希望给集群也安装上“检查探针”，观察到集群的资源利用率和其他指标，让集群的整体运行状况对我们“透明可见”，这样才能更准确更方便地做好集群的运维工作。</p><p>但是观测集群是不能用“探针”这种简单的方式的，所以今天我就带你一起来看看Kubernetes为集群提供的两种系统级别的监控项目：Metrics Server和Prometheus，以及基于它们的水平自动伸缩对象HorizontalPodAutoscaler。</p><h2>Metrics Server</h2><p>如果你对Linux系统有所了解的话，也许知道有一个命令 <code>top</code> 能够实时显示当前系统的CPU和内存利用率，它是性能分析和调优的基本工具，非常有用。<strong>Kubernetes也提供了类似的命令，就是 <code>kubectl top</code>，不过默认情况下这个命令不会生效，必须要安装一个插件Metrics Server才可以。</strong></p><p>Metrics Server是一个专门用来收集Kubernetes核心资源指标（metrics）的工具，它定时从所有节点的kubelet里采集信息，但是对集群的整体性能影响极小，每个节点只大约会占用1m的CPU和2MB的内存，所以性价比非常高。</p><!-- [[[read_end]]] --><p>下面的<a href=\"https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-server\">这张图</a>来自Kubernetes官网，你可以对Metrics Server的工作方式有个大概了解：它调用kubelet的API拿到节点和Pod的指标，再把这些信息交给apiserver，这样kubectl、HPA就可以利用apiserver来读取指标了：</p><p><img src=\"https://static001.geekbang.org/resource/image/8f/9e/8f4a22788c03b06377cabe791c67989e.png?wh=1562x572\" alt=\"图片\"></p><p>在Metrics Server的项目网址（<a href=\"https://github.com/kubernetes-sigs/metrics-server\">https://github.com/kubernetes-sigs/metrics-server</a>）可以看到它的说明文档和安装步骤，不过如果你已经按照<a href=\"https://time.geekbang.org/column/article/534762\">第17讲</a>用kubeadm搭建了Kubernetes集群，就已经具备了全部前提条件，接下来只需要几个简单的操作就可以完成安装。</p><p>Metrics Server的所有依赖都放在了一个YAML描述文件里，你可以使用wget或者curl下载：</p><pre><code class=\"language-plain\">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml\n</code></pre><p>但是在 <code>kubectl apply</code> 创建对象之前，我们还有两个准备工作要做。</p><p><strong>第一个工作，是修改YAML文件</strong>。你需要在Metrics Server的Deployment对象里，加上一个额外的运行参数 <code>--kubelet-insecure-tls</code>，也就是这样：</p><pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n&nbsp; name: metrics-server\n&nbsp; namespace: kube-system\nspec:\n  ... ... \n&nbsp; template:\n&nbsp; &nbsp; spec:\n&nbsp; &nbsp; &nbsp; containers:\n&nbsp; &nbsp; &nbsp; - args:\n&nbsp; &nbsp; &nbsp; &nbsp; - --kubelet-insecure-tls\n        ... ... \n</code></pre><p>这是因为Metrics Server默认使用TLS协议，要验证证书才能与kubelet实现安全通信，而我们的实验环境里没有这个必要，加上这个参数可以让我们的部署工作简单很多（生产环境里就要慎用）。</p><p><strong>第二个工作，是预先下载Metrics Server的镜像。</strong>看这个YAML文件，你会发现Metrics Server的镜像仓库用的是gcr.io，下载很困难。好在它也有国内的镜像网站，你可以用<a href=\"https://time.geekbang.org/column/article/534762\">第17讲</a>里的办法，下载后再改名，然后把镜像加载到集群里的节点上。</p><p>这里我给出一段Shell脚本代码，供你参考：</p><pre><code class=\"language-plain\">repo=registry.aliyuncs.com/google_containers\n\nname=k8s.gcr.io/metrics-server/metrics-server:v0.6.1\nsrc_name=metrics-server:v0.6.1\n\ndocker pull $repo/$src_name\n\ndocker tag $repo/$src_name $name\ndocker rmi $repo/$src_name\n</code></pre><p>两个准备工作都完成之后，我们就可以使用YAML部署Metrics Server了：</p><pre><code class=\"language-plain\">kubectl apply -f components.yaml\n</code></pre><p>Metrics Server属于名字空间“kube-system”，可以用 <code>kubectl get pod</code> 加上 <code>-n</code> 参数查看它是否正常运行：</p><pre><code class=\"language-plain\">kubectl get pod -n kube-system\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/b9/93/b93124cbc1b7d98b7c4f055f0723bf93.png?wh=1506x822\" alt=\"图片\"></p><p>现在有了Metrics Server插件，我们就可以使用命令 <code>kubectl top</code> 来查看Kubernetes集群当前的资源状态了。它有<strong>两个子命令，<code>node</code> 查看节点的资源使用率，<code>pod</code> 查看Pod的资源使用率</strong>。</p><p>由于Metrics Server收集信息需要时间，我们必须等一小会儿才能执行命令，查看集群里节点和Pod状态：</p><pre><code class=\"language-plain\">kubectl top node\nkubectl top pod -n kube-system\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/d4/61/d450b7e01f5f47ac56335f6c69707e61.png?wh=1800x1052\" alt=\"图片\"></p><p>从这个截图里你可以看到：</p><ul>\n<li>集群里两个节点CPU使用率都不高，分别是8%和4%，但内存用的很多，master节点用了差不多一半（48%），而worker节点几乎用满了（89%）。</li>\n<li>名字空间“kube-system”里有很多Pod，其中apiserver最消耗资源，使用了75m的CPU和363MB的内存。</li>\n</ul><h2>HorizontalPodAutoscaler</h2><p>有了Metrics Server，我们就可以轻松地查看集群的资源使用状况了，不过它另外一个更重要的功能是辅助实现应用的“<strong>水平自动伸缩</strong>”。</p><p>在<a href=\"https://time.geekbang.org/column/article/535209\">第18讲</a>里我们提到有一个命令 <code>kubectl scale</code>，可以任意增减Deployment部署的Pod数量，也就是水平方向的“扩容”和“缩容”。但是手动调整应用实例数量还是比较麻烦的，需要人工参与，也很难准确把握时机，难以及时应对生产环境中突发的大流量，所以最好能把这个“扩容”“缩容”也变成自动化的操作。</p><p>Kubernetes为此就定义了一个新的API对象，叫做“<strong>HorizontalPodAutoscaler</strong>”，简称是“<strong>hpa</strong>”。顾名思义，它是专门用来自动伸缩Pod数量的对象，适用于Deployment和StatefulSet，但不能用于DaemonSet（原因很明显吧）。</p><p>HorizontalPodAutoscaler的能力完全基于Metrics Server，它从Metrics Server获取当前应用的运行指标，主要是CPU使用率，再依据预定的策略增加或者减少Pod的数量。</p><p>下面我们就来看看该怎么使用HorizontalPodAutoscaler，首先要定义Deployment和Service，创建一个Nginx应用，作为自动伸缩的目标对象：</p><pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n&nbsp; name: ngx-hpa-dep\n\nspec:\n&nbsp; replicas: 1\n&nbsp; selector:\n&nbsp; &nbsp; matchLabels:\n&nbsp; &nbsp; &nbsp; app: ngx-hpa-dep\n\n&nbsp; template:\n&nbsp; &nbsp; metadata:\n&nbsp; &nbsp; &nbsp; labels:\n&nbsp; &nbsp; &nbsp; &nbsp; app: ngx-hpa-dep\n&nbsp; &nbsp; spec:\n&nbsp; &nbsp; &nbsp; containers:\n&nbsp; &nbsp; &nbsp; - image: nginx:alpine\n&nbsp; &nbsp; &nbsp; &nbsp; name: nginx\n&nbsp; &nbsp; &nbsp; &nbsp; ports:\n&nbsp; &nbsp; &nbsp; &nbsp; - containerPort: 80\n\n&nbsp; &nbsp; &nbsp; &nbsp; resources:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; requests:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cpu: 50m\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memory: 10Mi\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; limits:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cpu: 100m\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memory: 20Mi\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n&nbsp; name: ngx-hpa-svc\nspec:\n&nbsp; ports:\n&nbsp; - port: 80\n&nbsp; &nbsp; protocol: TCP\n&nbsp; &nbsp; targetPort: 80\n&nbsp; selector:\n&nbsp; &nbsp; app: ngx-hpa-dep\n</code></pre><p>在这个YAML里我只部署了一个Nginx实例，名字是 <code>ngx-hpa-dep</code>。<strong>注意在它的</strong> <code>spec</code> <strong>里一定要用 <code>resources</code> 字段写清楚资源配额</strong>，否则HorizontalPodAutoscaler会无法获取Pod的指标，也就无法实现自动化扩缩容。</p><p>接下来我们要用命令 <code>kubectl autoscale</code> 创建一个HorizontalPodAutoscaler的样板YAML文件，它有三个参数：</p><ul>\n<li>min，Pod数量的最小值，也就是缩容的下限。</li>\n<li>max，Pod数量的最大值，也就是扩容的上限。</li>\n<li>cpu-percent，CPU使用率指标，当大于这个值时扩容，小于这个值时缩容。</li>\n</ul><p>好，现在我们就来为刚才的Nginx应用创建HorizontalPodAutoscaler，指定Pod数量最少2个，最多10个，CPU使用率指标设置的小一点，5%，方便我们观察扩容现象：</p><pre><code class=\"language-plain\">export out=\"--dry-run=client -o yaml\"              # 定义Shell变量\nkubectl autoscale deploy ngx-hpa-dep --min=2 --max=10 --cpu-percent=5 $out\n</code></pre><p>得到的YAML描述文件就是这样：</p><pre><code class=\"language-yaml\">apiVersion: autoscaling/v1\nkind: HorizontalPodAutoscaler\nmetadata:\n&nbsp; name: ngx-hpa\n\nspec:\n&nbsp; maxReplicas: 10\n&nbsp; minReplicas: 2\n&nbsp; scaleTargetRef:\n&nbsp; &nbsp; apiVersion: apps/v1\n&nbsp; &nbsp; kind: Deployment\n&nbsp; &nbsp; name: ngx-hpa-dep\n&nbsp; targetCPUUtilizationPercentage: 5\n</code></pre><p>我们再使用命令 <code>kubectl apply</code> 创建这个HorizontalPodAutoscaler后，它会发现Deployment里的实例只有1个，不符合min定义的下限的要求，就先扩容到2个：</p><p><img src=\"https://static001.geekbang.org/resource/image/3e/6c/3ec01a9746274ac28b10d612f1512a6c.png?wh=1630x704\" alt=\"图片\"></p><p>从这张截图里你可以看到，HorizontalPodAutoscaler会根据YAML里的描述，找到要管理的Deployment，把Pod数量调整成2个，再通过Metrics Server不断地监测Pod的CPU使用率。</p><p>下面我们来给Nginx加上压力流量，运行一个测试Pod，使用的镜像是“<strong>httpd:alpine</strong>”，它里面有HTTP性能测试工具ab（Apache Bench）：</p><pre><code class=\"language-plain\">kubectl run test -it --image=httpd:alpine -- sh\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/d0/bd/d058182500cb83ac3e3c9cc01a42c9bd.png?wh=1896x354\" alt=\"图片\"></p><p>然后我们向Nginx发送一百万个请求，持续1分钟，再用 <code>kubectl get hpa</code> 来观察HorizontalPodAutoscaler的运行状况：</p><pre><code class=\"language-plain\">ab -c 10 -t 60 -n 1000000 'http://ngx-hpa-svc/'\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/65/b4/6538ecd78118fabeb8d7c8f4fbabdbb4.png?wh=1920x794\" alt=\"图片\"></p><p>因为Metrics Server大约每15秒采集一次数据，所以HorizontalPodAutoscaler的自动化扩容和缩容也是按照这个时间点来逐步处理的。</p><p>当它发现目标的CPU使用率超过了预定的5%后，就会以2的倍数开始扩容，一直到数量上限，然后持续监控一段时间，如果CPU使用率回落，就会再缩容到最小值。</p><h2>Prometheus</h2><p>显然，有了Metrics Server和HorizontalPodAutoscaler的帮助，我们的应用管理工作又轻松了一些。不过，Metrics Server能够获取的指标还是太少了，只有CPU和内存，想要监控到更多更全面的应用运行状况，还得请出这方面的权威项目“<strong>Prometheus</strong>”。</p><p>其实，Prometheus的历史比Kubernetes还要早一些，它最初是由Google的离职员工在2012年创建的开源项目，灵感来源于Borg配套的BorgMon监控系统。后来在2016年，Prometheus作为第二个项目加入了CNCF，并在2018年继Kubernetes之后顺利毕业，成为了CNCF的不折不扣的“二当家”，也是云原生监控领域的“事实标准”。</p><p><img src=\"https://static001.geekbang.org/resource/image/69/58/69f4b76ca7323433cyy28574f1ee9358.png?wh=1200x600\" alt=\"图片\"></p><p>和Kubernetes一样，Prometheus也是一个庞大的系统，我们这里就只做一个简略的介绍。</p><p>下面的<a href=\"https://prometheus.io/docs/introduction/overview/\">这张图</a>是Prometheus官方的架构图，几乎所有文章在讲Prometheus的时候必然要拿出来，所以我也没办法“免俗”：</p><p><img src=\"https://static001.geekbang.org/resource/image/e6/64/e62cebb3acc995246f203d698dfdc964.png?wh=1351x811\" alt=\"图片\"></p><p>Prometheus系统的核心是它的Server，里面有一个时序数据库TSDB，用来存储监控数据，另一个组件Retrieval使用拉取（Pull）的方式从各个目标收集数据，再通过HTTP Server把这些数据交给外界使用。</p><p>在Prometheus Server之外还有三个重要的组件：</p><ul>\n<li>Push Gateway，用来适配一些特殊的监控目标，把默认的Pull模式转变为Push模式。</li>\n<li>Alert Manager，告警中心，预先设定规则，发现问题时就通过邮件等方式告警。</li>\n<li>Grafana是图形化界面，可以定制大量直观的监控仪表盘。</li>\n</ul><p>由于同属于CNCF，所以Prometheus自然就是“云原生”，在Kubernetes里运行是顺理成章的事情。不过它包含的组件实在是太多，部署起来有点麻烦，这里我选用了“<strong>kube-prometheus</strong>”项目（<a href=\"https://github.com/prometheus-operator/kube-prometheus/\">https://github.com/prometheus-operator/kube-prometheus/</a>），感觉操作起来比较容易些。</p><p>下面就跟着我来在Kubernetes实验环境里体验一下Prometheus吧。</p><p>我们先要下载kube-prometheus的源码包，当前的最新版本是0.11：</p><pre><code class=\"language-plain\">wget https://github.com/prometheus-operator/kube-prometheus/archive/refs/tags/v0.11.0.tar.gz\n</code></pre><p>解压缩后，Prometheus部署相关的YAML文件都在 <code>manifests</code> 目录里，有近100个，你可以先大概看一下。</p><p>和Metrics Server一样，我们也必须要做一些准备工作，才能够安装Prometheus。</p><p>第一步，是修改 <code>prometheus-service.yaml</code>、<code>grafana-service.yaml</code>。</p><p>这两个文件定义了Prometheus和Grafana服务对象，我们可以给它们添加 <code>type: NodePort</code>（参考<a href=\"https://time.geekbang.org/column/article/536829\">第20讲</a>），这样就可以直接通过节点的IP地址访问（当然你也可以配置成Ingress）。</p><p><strong>第二步，是修改 <code>kubeStateMetrics-deployment.yaml</code>、<code>prometheusAdapter-deployment.yaml</code>，因为它们里面有两个存放在gcr.io的镜像，必须解决下载镜像的问题。</strong></p><p>但很遗憾，我没有在国内网站上找到它们的下载方式，为了能够顺利安装，只能把它们下载后再上传到Docker Hub上。所以你需要修改镜像名字，把前缀都改成 <code>chronolaw</code>：</p><pre><code class=\"language-plain\">image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.5.0\nimage: k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1\n\nimage: chronolaw/kube-state-metrics:v2.5.0\nimage: chronolaw/prometheus-adapter:v0.9.1\n</code></pre><p>这两个准备工作完成之后，我们要执行两个 <code>kubectl create</code> 命令来部署Prometheus，先是 <code>manifests/setup</code> 目录，创建名字空间等基本对象，然后才是 <code>manifests</code> 目录：</p><pre><code class=\"language-plain\">kubectl create -f manifests/setup\nkubectl create -f manifests\n</code></pre><p>Prometheus的对象都在名字空间“<strong>monitoring</strong>”里，创建之后可以用 <code>kubectl get</code> 来查看状态：</p><p><img src=\"https://static001.geekbang.org/resource/image/1b/09/1b4a1a1313ede9058b348c13a1020c09.png?wh=1894x878\" alt=\"图片\"></p><p>确定这些Pod都运行正常，我们再来看看它对外的服务端口：</p><pre><code class=\"language-plain\">kubectl get svc -n monitoring\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/4c/59/4c423a203a688271d9d08b15a6782d59.png?wh=1920x531\" alt=\"图片\"></p><p>前面修改了Grafana和Prometheus的Service对象，所以这两个服务就在节点上开了端口，Grafana是“30358”，Prometheus有两个端口，其中“9090”对应的“30827”是Web端口。</p><p>在浏览器里输入节点的IP地址（我这里是“<a href=\"http://192.168.10.210\">http://192.168.10.210</a>”），再加上端口号“30827”，我们就能看到Prometheus自带的Web界面，：</p><p><img src=\"https://static001.geekbang.org/resource/image/1b/dc/1b73040e258dfa8776c2a0a657a885dc.png?wh=1906x1934\" alt=\"图片\"></p><p>Web界面上有一个查询框，可以使用PromQL来查询指标，生成可视化图表，比如在这个截图里我就选择了“node_memory_Active_bytes”这个指标，意思是当前正在使用的内存容量。</p><p>Prometheus的Web界面比较简单，通常只用来调试、测试，不适合实际监控。我们再来看Grafana，访问节点的端口“30358”（我这里是“<a href=\"http://192.168.10.210:30358\">http://192.168.10.210:30358</a>”），它会要求你先登录，默认的用户名和密码都是“<strong>admin</strong>”：</p><p><img src=\"https://static001.geekbang.org/resource/image/a2/31/a2614b09347b3436c317644374c36e31.png?wh=1906x1934\" alt=\"图片\"></p><p>Grafana内部已经预置了很多强大易用的仪表盘，你可以在左侧菜单栏的“Dashboards - Browse”里任意挑选一个：</p><p><img src=\"https://static001.geekbang.org/resource/image/23/5a/23ddb3db05e36c2da4a8f8067366f55a.png?wh=1906x1934\" alt=\"图片\"></p><p>比如我选择了“Kubernetes / Compute Resources / Namespace (Pods)”这个仪表盘，就会出来一个非常漂亮图表，比Metrics Server的 <code>kubectl top</code> 命令要好看得多，各种数据一目了然：</p><p><img src=\"https://static001.geekbang.org/resource/image/1f/bd/1f6ccc0b6d358c29419276fbf74e38bd.png?wh=1920x1696\" alt=\"图片\"></p><p>关于Prometheus就暂时介绍到这里，再往下讲可能就要偏离我们的Kubernetes主题了，如果你对它感兴趣的话，可以课后再去它的<a href=\"https://prometheus.io/\">官网</a>上看文档，或者参考其他的学习资料。</p><h2>小结</h2><p>在云原生时代，系统的透明性和可观测性是非常重要的。今天我们一起学习了Kubernetes里的两个系统监控项目：命令行方式的Metrics Server、图形化界面的Prometheus，利用好它们就可以让我们随时掌握Kubernetes集群的运行状态，做到“明察秋毫”。</p><p>再简单小结一下今天的内容：</p><ol>\n<li>Metrics Server是一个Kubernetes插件，能够收集系统的核心资源指标，相关的命令是 <code>kubectl top</code>。</li>\n<li>Prometheus是云原生监控领域的“事实标准”，用PromQL语言来查询数据，配合Grafana可以展示直观的图形界面，方便监控。</li>\n<li>HorizontalPodAutoscaler实现了应用的自动水平伸缩功能，它从Metrics Server获取应用的运行指标，再实时调整Pod数量，可以很好地应对突发流量。</li>\n</ol><h2>课下作业</h2><p>最后是课下作业时间，给你留两个思考题：</p><ol>\n<li>部署了HorizontalPodAutoscaler之后，如果再执行 <code>kubectl scale</code> 手动扩容会发生什么呢？</li>\n<li>你有过应用监控的经验吗？应该关注哪些重要的指标呢？</li>\n</ol><p>非常期待在留言区看到你的发言，同我同其他同学一起讨论。我们下节课再见。</p><p><img src=\"https://static001.geekbang.org/resource/image/ff/01/ff8b9d4fdcd5d227a58391f215761601.jpg?wh=1920x2985\" alt=\"图片\"></p>","comments":[{"had_liked":false,"id":356557,"user_name":"马以","can_delete":false,"product_type":"c1","uid":1344431,"ip_address":"北京","ucode":"3FEA06CA14DE28","user_header":"https://static001.geekbang.org/account/avatar/00/14/83/af/1cb42cd3.jpg","comment_is_top":false,"comment_ctime":1662398064,"is_pvip":false,"replies":[{"id":129805,"content":"感谢分享。\n\n不知道为什么prometheus-adapter:v0.9.1有问题，可能我上传的是arm64版本的，有空再检查一下。\n\n下载看了看，sha256是一样的，不知道哪里有问题。","user_name":"作者回复","user_name_real":"作者","uid":1181974,"ctime":1662436183,"ip_address":"北京","comment_id":356557,"utype":1}],"discussion_count":9,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"操作中遇到的问题以及解决办法\n1: metris-server如果出现执行命令 kubectl top 不生效可以加如下配置\n\tapiVersion: apps&#47;v1\n\tkind: Deployment\n\tmetadata:\n\t ...\n\t  \n\t  template:\n\t    ....\n\t    spec:\n\t      nodeName: k8s-master #你自己的节点名称\n\n2: prometheus 镜像问题\n   这里我偷懒，不用骑驴找驴了，直接用老师的\n\n   这里我建议您push到docker hub (因为集群有多个节点，push到docker hub上，这样pod调度到任意一个节点都可以方便下载)\n\n   docker pull chronolaw&#47;kube-state-metrics:v2.5.0\n   docker tag chronolaw&#47;kube-state-metrics:v2.5.0 k8s.gcr.io&#47;kube-state-metrics&#47;kube-state-metrics:v2.5.0\n   docker rmi chronolaw&#47;kube-state-metrics:v2.5.0\n   docker push k8s.gcr.io&#47;kube-state-metrics&#47;kube-state-metrics:v2.5.0\n\n\n   prometheus-adapter 老师的版本运行不起来，我在docker hub上 找了一个可以用的\n\n   docker pull pengyc2019&#47;prometheus-adapter:v0.9.1\n   docker tag pengyc2019&#47;prometheus-adapter:v0.9.1 k8s.gcr.io&#47;prometheus-adapter&#47;prometheus-adapter:v0.9.1\n   docker rmi pengyc2019&#47;prometheus-adapter:v0.9.1\n   docker push k8s.gcr.io&#47;prometheus-adapter&#47;prometheus-adapter:v0.9.1\n\n然后执行：\n\tkubectl create -f manifests&#47;setup\n\tkubectl create -f manifests\n\n 到此，运行成功\n","like_count":14,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586689,"discussion_content":"感谢分享。\n\n不知道为什么prometheus-adapter:v0.9.1有问题，可能我上传的是arm64版本的，有空再检查一下。\n\n下载看了看，sha256是一样的，不知道哪里有问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662436183,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1305810,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/prLO6VIcvsXMibOichyNgeMmgDlh8nS7q4F9a0PCkrL0OypFj0dQicDMRH0El7sdOF6srhJyKsfRNQJe10IJwHhoQ/132","nickname":"一行","note":"","ucode":"849B58C31455DC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":598281,"discussion_content":"我也运行不起来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1672731963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":586689,"ip_address":"河南","group_id":0},"score":598281,"extra":""},{"author":{"id":1899599,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/fc/4f/0a452c94.jpg","nickname":"大毛","note":"","ucode":"93B18287F06706","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":622020,"discussion_content":"chronolaw/prometheus-adapter                       v0.9.1          6cac3f74e9ca   20 months ago   64.4MB\npengyc2019/prometheus-adapter                      v0.9.1          179df2737843   20 months ago   68.2MB\n\n以上是两个镜像的信息，可以看到哈希值不一样，所以应该是版本的问题🤔\n建议使用pengyc2019/prometheus-adapter的镜像","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1687854994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":586689,"ip_address":"北京","group_id":0},"score":622020,"extra":""}]},{"author":{"id":1066409,"avatar":"https://static001.geekbang.org/account/avatar/00/10/45/a9/3d48d6a2.jpg","nickname":"Lorry","note":"","ucode":"BD4754D0F1D786","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602989,"discussion_content":"感谢分享，我也是卡在了prometheus-adapter这个地方好久，换了一个镜像好用了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1675896603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"辽宁","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2161558,"avatar":"https://static001.geekbang.org/account/avatar/00/20/fb/96/791d0f5e.jpg","nickname":"小伙儿","note":"","ucode":"470DEA71CDD4F0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":594765,"discussion_content":"感谢分享，加上nodeName就可以用了！","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1669358718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1244730,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/InZgCgEZVcBWf3mWicd9LyyicZ31VzVYrCnP07DzV7eRIxfHZ4VeeGWaC8a0B1f5ibXxXt5SFgXzfMtgKPyE3FFWw/132","nickname":"她和她的猫","note":"","ucode":"8DF99F117B945E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629765,"discussion_content":"老师的 prometheus-adapter 镜像是 arm 的，如果在 intel 上运行就会报 exec format error 错误。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697614163,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1598417,"avatar":"https://static001.geekbang.org/account/avatar/00/18/63/d1/20e8389a.jpg","nickname":"陈小强","note":"","ucode":"EA68B1E44455D0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607151,"discussion_content":"老哥牛逼，感谢分享，我也是加上nodeName就可用了；可以细说下原因不","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677641972,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1394115,"avatar":"https://static001.geekbang.org/account/avatar/00/15/45/c3/775fe460.jpg","nickname":"rubys_","note":"","ucode":"931AD02864126A","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591660,"discussion_content":"我也是加上 nodeName 就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666752308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1155646,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKotsBr2icbYNYlRSlicGUD1H7lulSTQUAiclsEz9gnG5kCW9qeDwdYtlRMXic3V6sj9UrfKLPJnQojag/132","nickname":"ppd0705","note":"","ucode":"EB63D4E3FD1E9A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588493,"discussion_content":"感谢分享 ， 加上 nodeName 就好了 ！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663806260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"湖南","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361163,"user_name":"邵涵","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"上海","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1667290542,"is_pvip":false,"replies":[{"id":131367,"content":"great！","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1667308366,"ip_address":"上海","comment_id":361163,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"在使用hpa做自动扩容&#47;缩容时，遇到了只扩容不缩容的问题，具体情况如下：\n1. 按文中的步骤，使用ab加压，可以看到pod增加到了10个\n[shaohan@k8s4 ~]$ kubectl get hpa ngx-hpa -w\nNAME      REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nngx-hpa   Deployment&#47;ngx-hpa-dep   150%&#47;5%   2         10        2          90s\nngx-hpa   Deployment&#47;ngx-hpa-dep   129%&#47;5%   2         10        4          105s\nngx-hpa   Deployment&#47;ngx-hpa-dep   93%&#47;5%    2         10        8          2m\nngx-hpa   Deployment&#47;ngx-hpa-dep   57%&#47;5%    2         10        10         2m15s\n2. 在ab停止运行之后过了几分钟，kubectl get hpa ngx-hpa -w的输出中才出现了一行新数据，如下\nngx-hpa   Deployment&#47;ngx-hpa-dep   0%&#47;5%     2         10        10         7m31s\n仍然是10个pod，并没有自动缩容\n3. 查看pod\n[shaohan@k8s4 ~]$ kubectl get pod\nNAME                           READY   STATUS    RESTARTS     AGE\nngx-hpa-dep-86f66c75f5-d82rh   0&#47;1     Pending   0            63s\nngx-hpa-dep-86f66c75f5-dtc88   0&#47;1     Pending   0            63s\n（其他ngx-hpa-dep-xxx省略，因为评论字数限制……）\ntest                           1&#47;1     Running   1 (6s ago)   2m5s\n可以看到，有两个pod是pending状态的，kubectl describe这两个pending pod中的一个，可以看到\nWarning  FailedScheduling  18s (x2 over 85s)  default-scheduler  0&#47;2 nodes are available: 1 Insufficient cpu, 1 node(s) had taint {node-role.kubernetes.io&#47;master: }, that the pod didn&#39;t tolerate.\n是因为worker节点资源不足，master节点没有开放给pod调度，造成扩容时有两个pod虽然创建了，但一直在等待资源而没有进入running状态\n4. 手动删除了用于执行ab的apache pod，释放资源，然后立刻查看pod，就只有两个了\nkubectl get hpa ngx-hpa -w的输出中也出现了一行新数据\nngx-hpa   Deployment&#47;ngx-hpa-dep   0%&#47;5%     2         10        2          7m46s\n自动缩容成功执行了\n\n所以，看起来，hpa是“严格按顺序执行的”，它按照规则设定的条件，要扩容到10个pod，在10个pod全都running之前，即使已经符合缩容的条件了，它也不执行缩容，而是要等到之前扩容的操作彻底完成，也就是10个pod全都running了，才会执行缩容","like_count":8,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592326,"discussion_content":"great！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667308366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356054,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"北京","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1661937470,"is_pvip":false,"replies":[{"id":129583,"content":"\n1. 是的。Grafana是独立的项目，图省事就和Prometheus在一起说了，可能造成了误解，抱歉。\n\n2.镜像拉取失败和tls没关系，可以自己用docker pull命令再尝试一下。\n\n3.create 换成delete，先是manifests，然后是setup，你的理解正确。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1661941259,"ip_address":"北京","comment_id":356054,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"请教老师几个问题：\nQ1：Grafana 不是Prometheus的组件吧\n架构图中标红色的是属于Prometheus，在UI方面，架构图中的”prometheus web ui”应该是Prometheus的组件吧。Grafana好像是一个公共组件，不是Prometheus独有的。\n\nQ2: Prometheus部署后有四个POD的状态不是RUNNING\nblackbox-exporter-746c64fd88-ts299：状态是ImagePullBackOff\nprometheus-adapter-8547d6666f-6npn6：状态是CrashLoopBackOff，\n错误信息：\nsc = Get &quot;https:&#47;&#47;registry-1.docker.io&#47;v2&#47;jimmidyson&#47;configmap-reload&#47;manifests&#47;sha256:91467ba755a0c41199a63fe80a2c321c06edc4d3affb4f0ab6b3d20a49ed88d1&quot;: net&#47;http: TLS handshake timeout\n好像和TLS有关，需要和Metrics Server一样加“kubelet-insecure-tls”吗？在哪个YAML文件中修改？\n\nQ3：Prometheus部署的逆向操作是什么？\n用这两个命令来部署：\nkubectl create -f manifests&#47;setup\nkubectl create -f manifests\n\n部署后，如果想重新部署，需要清理环境，那么，怎么清理掉以前部署的东西？\n和kubectl create -f manifests&#47;setup相反的操作是“kubectl delete -f manifests&#47;setup”吗？","like_count":8,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586031,"discussion_content":"\n1. 是的。Grafana是独立的项目，图省事就和Prometheus在一起说了，可能造成了误解，抱歉。\n\n2.镜像拉取失败和tls没关系，可以自己用docker pull命令再尝试一下。\n\n3.create 换成delete，先是manifests，然后是setup，你的理解正确。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661941259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356226,"user_name":"ningfei","can_delete":false,"product_type":"c1","uid":2034586,"ip_address":"上海","ucode":"2C070E174A34CA","user_header":"https://static001.geekbang.org/account/avatar/00/1f/0b/9a/8ff51c91.jpg","comment_is_top":false,"comment_ctime":1662054015,"is_pvip":false,"replies":[{"id":129670,"content":"good","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1662086746,"ip_address":"上海","comment_id":356226,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"prometheus-adapter里使用这个willdockerhub&#47;prometheus-adapter:v0.9.1镜像,可以启动成功","like_count":3,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586275,"discussion_content":"good","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662086746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363572,"user_name":"XXG","can_delete":false,"product_type":"c1","uid":1219238,"ip_address":"上海","ucode":"55258F95874BF4","user_header":"https://static001.geekbang.org/account/avatar/00/12/9a/a6/29ac6f6a.jpg","comment_is_top":false,"comment_ctime":1669819726,"is_pvip":false,"replies":[{"id":132135,"content":"good，多实践，集群管理和本机管理的差距较大，很多时候会弄混。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1669863239,"ip_address":"上海","comment_id":363572,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"metrics-server-85bc76798b-hr56n           0&#47;1     ImagePullBackOff 原因：\n\n&lt;1&gt; 注意metrics-server版本，我拉下来的yml文件版本变成了v0.6.2，所以要根据最新的components.yaml文件中的metrics-server版本对应改一下老师的脚本；\n&lt;2&gt; 注意要在Worker节点执行脚本，我就在master节点上执行了好几遍。。。","like_count":2,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595228,"discussion_content":"good，多实践，集群管理和本机管理的差距较大，很多时候会弄混。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669863239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358750,"user_name":"dao","can_delete":false,"product_type":"c1","uid":1087879,"ip_address":"北京","ucode":"4181FB270462CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/87/5066026c.jpg","comment_is_top":false,"comment_ctime":1664683401,"is_pvip":false,"replies":[{"id":130520,"content":"awesome!","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1664754971,"ip_address":"北京","comment_id":358750,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"简单的回答一下思考题，\n\n1，会根据设置进行扩容（scale out），但是如果不满足 HPA 的指标条件，接着会立即进行缩容（scale in），下面是我的操作观察到的日志\n---\nNormal  SuccessfulCreate  3s    replicaset-controller  Created pod: ngx-hpa-dep-86f66c75f5-z2gjk\nNormal  SuccessfulCreate  3s    replicaset-controller  Created pod: ngx-hpa-dep-86f66c75f5-p46lr\nNormal  SuccessfulDelete  3s    replicaset-controller  Deleted pod: ngx-hpa-dep-86f66c75f5-z2gjk\nNormal  SuccessfulDelete  3s    replicaset-controller  Deleted pod: ngx-hpa-dep-86f66c75f5-p46lr\n---\n\n2，我现有的经验很有限，主要集中在单机&#47;集群机器指标的监控，以及对于应用及产品的监控（通过监控日志实现的），同时结合一些告警系统（alert），以便快速发现故障及解决。\n关注的指标有 CPU、内存、网卡、磁盘读写，应用的性能监控和错误率（可用性）监控。性能监控指标主要是响应时间（RT）、各种吞吐量（比如QPS）等。错误率指标主要是指应用错误及异常、HTTP错误响应代码等。","like_count":2,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589357,"discussion_content":"awesome!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664754971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356210,"user_name":"放不下荣华富贵","can_delete":false,"product_type":"c1","uid":2053679,"ip_address":"上海","ucode":"9FE29C22B9ABE3","user_header":"https://static001.geekbang.org/account/avatar/00/1f/56/2f/4518f8e1.jpg","comment_is_top":false,"comment_ctime":1662043308,"is_pvip":false,"replies":[{"id":129668,"content":"还可以基于其他的一些自定义指标，Kubernetes在这里提供了一个很好的可扩展的框架。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1662086685,"ip_address":"上海","comment_id":356210,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"自动扩容的话，通常生产环境常用的指标是什么呢？\n\n文中采用cpu占用率，比如md5sum是非常偏向于cpu运算的工作，但扩容可能并不能达到预期的效果（工作占满了一个核但是再多一个核却不能分摊这个工作）。\n所以看起来系统负载而非占用率应该是更好的扩容指标，不知道我这么理解是否正确？","like_count":2,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586273,"discussion_content":"还可以基于其他的一些自定义指标，Kubernetes在这里提供了一个很好的可扩展的框架。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662086685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368658,"user_name":"运维赵宏业","can_delete":false,"product_type":"c1","uid":1292802,"ip_address":"北京","ucode":"A7002175B4403A","user_header":"https://static001.geekbang.org/account/avatar/00/13/ba/02/78e0d4ac.jpg","comment_is_top":false,"comment_ctime":1676534427,"is_pvip":false,"replies":[{"id":134271,"content":"这个不是太确定，可能要对运维比较熟悉的同学来解答了，我理解应该是这样。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1676554008,"ip_address":"上海","comment_id":368658,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"老师您好，请教下，多k8s集群的场景下，每个集群内都要部署一套kube-prometheus吗？感谢","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":605027,"discussion_content":"这个不是太确定，可能要对运维比较熟悉的同学来解答了，我理解应该是这样。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676554008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367748,"user_name":"Lorry","can_delete":false,"product_type":"c1","uid":1066409,"ip_address":"四川","ucode":"BD4754D0F1D786","user_header":"https://static001.geekbang.org/account/avatar/00/10/45/a9/3d48d6a2.jpg","comment_is_top":false,"comment_ctime":1675557369,"is_pvip":false,"replies":[{"id":133943,"content":"可以的，有个hostNetwork属性，查一下资料，我们的课程里也用过一次。","user_name":"作者回复","user_name_real":"作者","uid":1181974,"ctime":1675639399,"ip_address":"北京","comment_id":367748,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"老师，有没有办法能够让k8s访问宿主机网络？物理机安装prometus+grafana比较麻烦，如果能够直接通过docker&#47;k8s装好就方便很多；但是现在生产&#47;测试环境都是物理机环境，所以想要反向通过k8s的应用监控宿主机所在网络的服务。\n\n应该怎么配置呢？","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602037,"discussion_content":"可以的，有个hostNetwork属性，查一下资料，我们的课程里也用过一次。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675639399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361178,"user_name":"邵涵","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"上海","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1667293241,"is_pvip":false,"replies":[{"id":131369,"content":"感觉这个不是太好的办法，尽量不要用hostNetwork: true。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1667308495,"ip_address":"上海","comment_id":361178,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100114501,"comment_content":"安装metrics server之后，kubectl top执行失败，如下\n[shaohan@k8s4 ~]$ kubectl top node\nError from server (ServiceUnavailable): the server is currently unable to handle the request (get nodes.metrics.k8s.io)\n\n执行kubectl get apiservice v1beta1.metrics.k8s.io -o yaml看到\nstatus:\n  conditions:\n  - lastTransitionTime: &quot;2022-10-29T09:57:08Z&quot;\n    message: &#39;failing or missing response from https:&#47;&#47;10.98.115.140:443&#47;apis&#47;metrics.k8s.io&#47;v1beta1:\n      Get &quot;https:&#47;&#47;10.98.115.140:443&#47;apis&#47;metrics.k8s.io&#47;v1beta1&quot;: dial tcp 10.98.115.140:443:\n      i&#47;o timeout&#39;\n    reason: FailedDiscoveryCheck\n    status: &quot;False&quot;\n    type: Available\n在components.yaml中给deployment对象添加hostNetwork: true（在spec-&gt;template-&gt;spec下）就可以解决这个问题","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592328,"discussion_content":"感觉这个不是太好的办法，尽量不要用hostNetwork: true。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667308495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1244730,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/InZgCgEZVcBWf3mWicd9LyyicZ31VzVYrCnP07DzV7eRIxfHZ4VeeGWaC8a0B1f5ibXxXt5SFgXzfMtgKPyE3FFWw/132","nickname":"她和她的猫","note":"","ucode":"8DF99F117B945E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629719,"discussion_content":"这个帮助我解决了问题，我猜测是 master 与 worker 不在同一个内网网段，所以不能 ping 通。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697550040,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1069135,"avatar":"","nickname":"邵涵","note":"","ucode":"43A16551A82F2F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592371,"discussion_content":"确实不是什么好办法，只是在没找到根本解决方式之前为了能用kubectl top的临时解决方式……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667359457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358752,"user_name":"dao","can_delete":false,"product_type":"c1","uid":1087879,"ip_address":"北京","ucode":"4181FB270462CF","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/87/5066026c.jpg","comment_is_top":false,"comment_ctime":1664683765,"is_pvip":false,"replies":[{"id":130519,"content":"great!","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1664754948,"ip_address":"北京","comment_id":358752,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"分享一下我的本课实践经验。当所有部署结束后，检查发现有 Pod 无法正常运行（也就是几个 Web UI 无法正常打开的）\n\n```bash\n# 查看 Pod 状态，发现 prometheus-operator 无法正常启动\nkubectl get pod -n monitoring\nNAME                                  READY   STATUS    RESTARTS   AGE\nblackbox-exporter-746c64fd88-wmnd5    3&#47;3     Running   0          68s\ngrafana-5fc7f9f55d-qqt77              1&#47;1     Running   0          68s\nkube-state-metrics-6c8846558c-w66x9   3&#47;3     Running   0          67s\nnode-exporter-68l4p                   2&#47;2     Running   0          67s\nnode-exporter-vs55z                   2&#47;2     Running   0          67s\nprometheus-adapter-6455646bdc-4lz5l   1&#47;1     Running   0          66s\nprometheus-adapter-6455646bdc-gxbrl   1&#47;1     Running   0          66s\nprometheus-operator-f59c8b954-btxtw   0&#47;2     Pending   0          66s\n\n# 调查 Pod prometheus-operator\nkubectl describe pod prometheus-operator-f59c8b954-btxtw -n monitoring\nEvents:\nType     Reason            Age   From               Message\n----     ------            ----  ----               -------\nWarning  FailedScheduling  82s   default-scheduler  0&#47;2 nodes are available: 1 Insufficient memory, 1 node(s) had taint {node-role.kubernetes.io&#47;master: }, that the pod didn&#39;t tolerate.\nWarning  FailedScheduling  20s   default-scheduler  0&#47;2 nodes are available: 1 Insufficient memory, 1 node(s) had taint {node-role.kubernetes.io&#47;master: }, that the pod didn&#39;t tolerate.\n\n# 去除 node 的污点 node-role.kubernetes.io&#47;master\nkubectl taint nodes --all node-role.kubernetes.io&#47;master-\n```","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589356,"discussion_content":"great!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1664754949,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356042,"user_name":"romance","can_delete":false,"product_type":"c1","uid":1029768,"ip_address":"北京","ucode":"393DC641CCE86E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b6/88/e8deccbc.jpg","comment_is_top":false,"comment_ctime":1661931674,"is_pvip":false,"replies":[{"id":129576,"content":"可以再用logs、describe看具体的状态，有问题就重启pod。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1661935193,"ip_address":"北京","comment_id":356042,"utype":1}],"discussion_count":8,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"metrics-server成功部署了，kubectl get pod -n kube-system 查看正常运行了，但用kubectl top node 时显示  Error from server (ServiceUnavailable): the server is currently unable to handle the request (get nodes.metrics.k8s.io)","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586009,"discussion_content":"可以再用logs、describe看具体的状态，有问题就重启pod。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661935193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3238292,"avatar":"https://static001.geekbang.org/account/avatar/00/31/69/94/4025b79e.jpg","nickname":"贰","note":"","ucode":"F5AC8A33168051","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":616510,"discussion_content":"楼主解决了吗？我排查到我的是没有开启聚合然后修改完聚合就直接崩了只能回滚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1682875055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"天津","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/64/a6/e5f674a9.jpg","nickname":"mh","note":"","ucode":"9179BBA1792CD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586171,"discussion_content":"找到问题了，看api-server的日志发现是metrics-server的端口4443没有开放的原因","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662017681,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/64/a6/e5f674a9.jpg","nickname":"mh","note":"","ucode":"9179BBA1792CD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586145,"discussion_content":"看日志启动是正常的，但还是调用失败","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662002197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/64/a6/e5f674a9.jpg","nickname":"mh","note":"","ucode":"9179BBA1792CD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586144,"discussion_content":" kubectl logs metrics-server-85b475cf99-bp96b -n kube-system\nI0901 02:56:55.468479       1 serving.go:342] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key)\nI0901 02:56:55.821949       1 requestheader_controller.go:169] Starting RequestHeaderAuthRequestController\nI0901 02:56:55.821952       1 configmap_cafile_content.go:201] &#34;Starting controller&#34; name=&#34;client-ca::kube-system::extension-apiserver-authentication::client-ca-file&#34;\nI0901 02:56:55.821959       1 configmap_cafile_content.go:201] &#34;Starting controller&#34; name=&#34;client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file&#34;\nI0901 02:56:55.821962       1 shared_informer.go:240] Waiting for caches to sync for RequestHeaderAuthRequestController\nI0901 02:56:55.821966       1 shared_informer.go:240] Waiting for caches to sync for client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file\nI0901 02:56:55.821963       1 shared_informer.go:240] Waiting for caches to sync for client-ca::kube-system::extension-apiserver-authentication::client-ca-file\nI0901 02:56:55.822112       1 dynamic_serving_content.go:131] &#34;Starting controller&#34; name=&#34;serving-cert::/tmp/apiserver.crt::/tmp/apiserver.key&#34;\nI0901 02:56:55.822192       1 secure_serving.go:266] Serving securely on [::]:4443\nI0901 02:56:55.822214       1 tlsconfig.go:240] &#34;Starting DynamicServingCertificateController&#34;\nW0901 02:56:55.822275       1 shared_informer.go:372] The sharedIndexInformer has started, run more than once is not allowed\nI0901 02:56:55.922872       1 shared_informer.go:247] Caches are synced for client-ca::kube-system::extension-apiserver-authentication::client-ca-file \nI0901 02:56:55.922874       1 shared_informer.go:247] Caches are synced for client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file \nI0901 02:56:55.922884       1 shared_informer.go:247] Caches are synced for RequestHeaderAuthRequestController","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662002145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/64/a6/e5f674a9.jpg","nickname":"mh","note":"","ucode":"9179BBA1792CD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586142,"discussion_content":"[lxf@cluster09 ~]$ kubectl top node -v=6\nI0901 11:12:02.709901  364898 loader.go:372] Config loaded from file:  /home/lxf/.kube/config\nI0901 11:12:02.719477  364898 round_trippers.go:553] GET https://192.168.10.5:6443/api 200 OK in 9 milliseconds\nI0901 11:12:02.719910  364898 round_trippers.go:553] GET https://192.168.10.5:6443/apis 200 OK in 0 milliseconds\nI0901 11:12:02.720562  364898 round_trippers.go:553] GET https://192.168.10.5:6443/apis/metrics.k8s.io/v1beta1/nodes 503 Service Unavailable in 0 milliseconds\nI0901 11:12:02.720659  364898 helpers.go:219] server response object: [{\n  &#34;metadata&#34;: {},\n  &#34;status&#34;: &#34;Failure&#34;,\n  &#34;message&#34;: &#34;the server is currently unable to handle the request (get nodes.metrics.k8s.io)&#34;,\n  &#34;reason&#34;: &#34;ServiceUnavailable&#34;,\n  &#34;details&#34;: {\n    &#34;group&#34;: &#34;metrics.k8s.io&#34;,\n    &#34;kind&#34;: &#34;nodes&#34;,\n    &#34;causes&#34;: [\n      {\n        &#34;reason&#34;: &#34;UnexpectedServerResponse&#34;,\n        &#34;message&#34;: &#34;service unavailable&#34;\n      }\n    ]\n  },\n  &#34;code&#34;: 503\n}]\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662002017,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1139878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/64/a6/e5f674a9.jpg","nickname":"mh","note":"","ucode":"9179BBA1792CD2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586141,"discussion_content":"这个污点是啥意思？ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662001979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1029768,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b6/88/e8deccbc.jpg","nickname":"romance","note":"","ucode":"393DC641CCE86E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586117,"discussion_content":"把master污点去掉后就能查看了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661995055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355994,"user_name":"Sports","can_delete":false,"product_type":"c1","uid":1757265,"ip_address":"北京","ucode":"1AC6035DFA4ECB","user_header":"https://static001.geekbang.org/account/avatar/00/1a/d0/51/f1c9ae2d.jpg","comment_is_top":false,"comment_ctime":1661910868,"is_pvip":false,"replies":[{"id":129560,"content":"用describe命令看一下它的状态，看样子像是镜像不对，是不是amd64&#47;arm64的问题，可以用docker inspect看看。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1661912722,"ip_address":"北京","comment_id":355994,"utype":1}],"discussion_count":5,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"prometheus-adapter的pod一直是CrashLoopBackOff，日志显示exec &#47;adapter: exec format error是啥情况？grafana和Prometheus的web端倒是可以正常打开正常显示的","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585937,"discussion_content":"用describe命令看一下它的状态，看样子像是镜像不对，是不是amd64/arm64的问题，可以用docker inspect看看。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661912722,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1757265,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d0/51/f1c9ae2d.jpg","nickname":"Sports","note":"","ucode":"1AC6035DFA4ECB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":585982,"discussion_content":"还是镜像的问题的，用的selina5288/prometheus-adapter:v0.9.1跑起来了","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1661927171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":585937,"ip_address":"江苏","group_id":0},"score":585982,"extra":""},{"author":{"id":2780736,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/6e/40/88b24990.jpg","nickname":"松饼","note":"","ucode":"86286F3D329483","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1757265,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d0/51/f1c9ae2d.jpg","nickname":"Sports","note":"","ucode":"1AC6035DFA4ECB","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629491,"discussion_content":"和你一样的问题，用的selina5288/prometheus-adapter:v0.9.1跑起来了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697113990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":585982,"ip_address":"北京","group_id":0},"score":629491,"extra":""}]},{"author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"密码123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585976,"discussion_content":"我用的，这个跑起来的。 directxman12/k8s-prometheus-adapter-amd64:v0.7.0","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661923181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"江苏","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1757265,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d0/51/f1c9ae2d.jpg","nickname":"Sports","note":"","ucode":"1AC6035DFA4ECB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"密码123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585983,"discussion_content":"用的selina5288/prometheus-adapter:v0.9.1跑起来了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661927184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":585976,"ip_address":"江苏","group_id":0},"score":585983,"extra":""}]}]},{"had_liked":false,"id":355976,"user_name":"戒贪嗔痴","can_delete":false,"product_type":"c1","uid":3017168,"ip_address":"北京","ucode":"D53EA3525DBD71","user_header":"https://static001.geekbang.org/account/avatar/00/2e/09/d0/8609bddc.jpg","comment_is_top":false,"comment_ctime":1661904474,"is_pvip":false,"replies":[{"id":129557,"content":"还是看master节点的污点，是否有NoSchedule，因为默认master是不运行业务的。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1661912495,"ip_address":"北京","comment_id":355976,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"老师 好，我这边装了metrics- server后不知道为什么只能看到worker节点的指标，看不到master的指标，全部显示为none。网上找了好久，没找到答案，还望老师指点下。","like_count":1,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585934,"discussion_content":"还是看master节点的污点，是否有NoSchedule，因为默认master是不运行业务的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661912495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":3017168,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/09/d0/8609bddc.jpg","nickname":"戒贪嗔痴","note":"","ucode":"D53EA3525DBD71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":586594,"discussion_content":"好的，我瞅瞅","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662366598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":585934,"ip_address":"浙江","group_id":0},"score":586594,"extra":""}]}]},{"had_liked":false,"id":393937,"user_name":"sgcls","can_delete":false,"product_type":"c1","uid":1255198,"ip_address":"广东","ucode":"F359E943BF6D14","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erRCf8vWbWibajdSaMtCM1OzPQ6uPhblgL4zXJvKoaQYVmialqFqr0NIdD6Dlm1F5icOBxiaXvUcQs4BA/132","comment_is_top":false,"comment_ctime":1725384740,"is_pvip":false,"replies":[{"id":143071,"content":"nice","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1725863353,"ip_address":"上海","comment_id":393937,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"metrics-server 折腾了两天，终于好了，过程记录一下：\n\n$ kubectl top node 提示出错\nError from server (ServiceUnavailable): the server is currently unable to handle the request (get nodes.metrics.k8s.io)\n\n期间尝试：\n- spec -&gt; template -&gt; spec 下添加 hostNetwork: true\n\n错误依旧，查看 apiserver 日志：\n$ kubectl logs -n kube-system kube-apiserver-master\nE0902 17:28:30.885994       1 available_controller.go:524] v1beta1.metrics.k8s.io failed with: failing or missing response from https:&#47;&#47;10.101.216.86:443&#47;apis&#47;metrics.k8s.io&#47;v1beta1: Get &quot;https:&#47;&#47;10.101.216.86:443&#47;apis&#47;metrics.k8s.io&#47;v1beta1&quot;: net&#47;http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)\n\n看了下 kubectl describe -n kube-system pod metrics-server-6dc55579bb-qv98v 发现 metrics-server 部署在 worker 节点\nNode: worker&#47;192.168.10.130\n\n看高赞评论，尝试下指定部署到 master 看能不能行，操作：\n去掉 hostNetwork: true，同时 spec -&gt; template -&gt; spec 下添加 nodeName: master，这回正常显示 master 节点的用量了，但是 worker 节点所有字段都显示 &lt;Unknown&gt;\n\n查看 metrics-server 日志\n$ kubectl logs -n kube-system metrics-server-6dc55579bb-qv98v\nE0903 15:50:56.622351       1 scraper.go:140] &quot;Failed to scrape node&quot; err=&quot;Get \\&quot;https:&#47;&#47;192.168.10.130:10250&#47;metrics&#47;resource\\&quot;: context deadline exceeded&quot; node=&quot;worker&quot;\n\n查看了 worker 的防火墙、VPN 也都没问题，访问 worker 节点的 10250 端口(kubelet)也正常：curl -k &#39;https:&#47;&#47;192.168.10.130:10250&#47;metrics&#47;resource&#39;\n\n没辙了，对比了下老师的 components.yaml(k8s_study&#47;metrics&#47;components.yaml)和我的，最后作了如下修改，kubectl top node 输出才终于正常..\n\n1. spec -&gt; template -&gt; spec 下添加 hostNetwork: true\n2. spec -&gt; template -&gt; spec 下添加 nodeName: master\n3. containers -&gt; secure-port=10250 改为 secure-port=4443\n4. containerPort: 10250 改为 secure-port=4443\n5. metrics-server deployment 的镜像(image)改为 k8s.gcr.io&#47;metrics-server&#47;metrics-server:v0.6.1","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":650912,"discussion_content":"nice","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1725863353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386015,"user_name":"okkkkk","can_delete":false,"product_type":"c1","uid":1958092,"ip_address":"江苏","ucode":"FEA6F454376F6D","user_header":"https://static001.geekbang.org/account/avatar/00/1d/e0/cc/a8c26fb2.jpg","comment_is_top":false,"comment_ctime":1703839148,"is_pvip":false,"replies":[{"id":140723,"content":"good.","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1704162347,"ip_address":"上海","comment_id":386015,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"prometheus遇到了两个问题，整理下\n1. 发现adapter运行不起来的话，如\nprometheus-adapter-8547d6666f-9wj9j   0&#47;1     CrashLoopBackOff\n是老师的prometheus-adapter:v0.9.1镜像有问题，我也打了一个镜像oiouou&#47;prometheus-adapter:v0.9.1，实测正常能用\n2. prometheus-k8s-0 一直处于Pending状态，我这里是内存不足了，master和worker我都分配了2G内存，之后把worker升到4G，pod都正常了","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634871,"discussion_content":"good.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704162347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382660,"user_name":"GeekNeo","can_delete":false,"product_type":"c1","uid":1146405,"ip_address":"浙江","ucode":"1D355A9BEB8BEA","user_header":"https://static001.geekbang.org/account/avatar/00/11/7e/25/3932dafd.jpg","comment_is_top":false,"comment_ctime":1697767935,"is_pvip":false,"replies":[{"id":139376,"content":"great","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1697780683,"ip_address":"上海","comment_id":382660,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"最新版本：\nrepo=registry.aliyuncs.com&#47;google_containers\n\nname=registry.k8s.io&#47;metrics-server&#47;metrics-server:v0.6.4\nsrc_name=metrics-server:v0.6.4\n\nsudo docker pull $repo&#47;$src_name\n\nsudo docker tag $repo&#47;$src_name $name\nsudo docker rmi $repo&#47;$src_name","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629901,"discussion_content":"great","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697780683,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":378960,"user_name":"huanrong","can_delete":false,"product_type":"c1","uid":2256935,"ip_address":"广东","ucode":"0F522FF7371E12","user_header":"https://static001.geekbang.org/account/avatar/00/22/70/27/4498ce51.jpg","comment_is_top":false,"comment_ctime":1691050296,"is_pvip":false,"replies":[{"id":138117,"content":"good","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1691135086,"ip_address":"上海","comment_id":378960,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"当部署了 HorizontalPodAutoscaler 后，如果再执行 kubectl scale 命令手动扩容，HorizontalPodAutoscaler 会根据定义的自动伸缩策略来调整 Pod 的数量。具体而言，如果手动扩容的数量超过了 HorizontalPodAutoscaler 的上限，则 HorizontalPodAutoscaler 会将 Pod 的数量缩回上限；如果手动扩容的数量低于 HorizontalPodAutoscaler 的下限，则 HorizontalPodAutoscaler 会将 Pod 的数量扩展到下限以上。\n\n这是因为 HorizontalPodAutoscaler 是根据 Metrics Server 提供的指标来自动伸缩 Pod 的数量的。当手动执行 kubectl scale 命令时，虽然可以直接改变 Pod 的数量，但是 HorizontalPodAutoscaler 会继续监控 Metrics Server 提供的指标，并根据自动伸缩策略对 Pod 的数量进行调整，以确保 Pod 的数量符合预定的范围。\n\n总结起来，当部署了 HorizontalPodAutoscaler 后，建议使用 HorizontalPodAutoscaler 来自动伸缩 Pod 的数量，而不是直接使用 kubectl scale 命令进行手动扩容。这样可以确保自动伸缩策略的生效，以及避免手动扩容和自动伸缩策略之间的冲突。","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624985,"discussion_content":"good","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1691135086,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":378103,"user_name":"Geek_0e379d","can_delete":false,"product_type":"c1","uid":1092078,"ip_address":"广东","ucode":"68DA7CE34D997B","user_header":"https://static001.geekbang.org/account/avatar/00/10/a9/ee/2b57ba4e.jpg","comment_is_top":false,"comment_ctime":1689757842,"is_pvip":false,"replies":[{"id":137785,"content":"可以先用命令行工具测试，比如curl。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1689763647,"ip_address":"北京","comment_id":378103,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"一切部署正常，就不知道为什么浏览器打不开","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":623709,"discussion_content":"可以先用命令行工具测试，比如curl。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1689763647,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":373818,"user_name":"极客雷","can_delete":false,"product_type":"c1","uid":1041465,"ip_address":"广东","ucode":"0DBAC4CB9C7BCD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e4/39/a06ade33.jpg","comment_is_top":false,"comment_ctime":1683200373,"is_pvip":false,"replies":[{"id":136578,"content":"great","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1683205512,"ip_address":"上海","comment_id":373818,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100114501,"comment_content":"Kubernetes 项目运行一个名为 registry.k8s.io、由社区管理的镜像仓库来托管其容器镜像。 2023 年 4 月 3 日，旧仓库 k8s.gcr.io 将被冻结，Kubernetes 及其相关子项目的镜像将不再推送到这个旧仓库。","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":616940,"discussion_content":"great","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683205512,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372736,"user_name":"Jacob.C","can_delete":false,"product_type":"c1","uid":1070253,"ip_address":"广东","ucode":"034998E7A7CCD1","user_header":"https://static001.geekbang.org/account/avatar/00/10/54/ad/6ee2b7cb.jpg","comment_is_top":false,"comment_ctime":1681530620,"is_pvip":false,"replies":[{"id":136083,"content":"这两个没有直接关系，完全可以独立安装。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1681565104,"ip_address":"北京","comment_id":372736,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"请问装普罗米修斯之前必须装 mertrics 吗？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":613881,"discussion_content":"这两个没有直接关系，完全可以独立安装。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681565104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367800,"user_name":"Lorry","can_delete":false,"product_type":"c1","uid":1066409,"ip_address":"四川","ucode":"BD4754D0F1D786","user_header":"https://static001.geekbang.org/account/avatar/00/10/45/a9/3d48d6a2.jpg","comment_is_top":false,"comment_ctime":1675640893,"is_pvip":false,"replies":[{"id":133959,"content":"nice","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1675649273,"ip_address":"上海","comment_id":367800,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"分享一点：拉去metric-server镜像的时候，一定要确保k8s集群所有的节点都通过docker进行拉取（执行文中提供的拉取脚本）。\n我碰到的问题是只是在master拉去来的，但是任务打到work节点后，总是出现拉去失败的异常。\n\nkubectl decribe在定位问题的时候，真香","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":602061,"discussion_content":"nice","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675649274,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366733,"user_name":"aLong","can_delete":false,"product_type":"c1","uid":2409553,"ip_address":"北京","ucode":"11DB1B9C579811","user_header":"https://static001.geekbang.org/account/avatar/00/24/c4/51/5bca1604.jpg","comment_is_top":false,"comment_ctime":1674121456,"is_pvip":false,"replies":[{"id":133618,"content":"正常，应该是实验集群太小，没有足够的worker node来运行它们。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1674172969,"ip_address":"北京","comment_id":366733,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"alertmanager-main-2,prometheus-k8s-0&amp;1, 这三个都会提示污点问题导致pending。去除掉污点会正常启动。 这是否是常规操作？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600274,"discussion_content":"正常，应该是实验集群太小，没有足够的worker node来运行它们。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674172969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":363635,"user_name":"LiL","can_delete":false,"product_type":"c1","uid":2923131,"ip_address":"北京","ucode":"23BE4E0181E80D","user_header":"https://static001.geekbang.org/account/avatar/00/2c/9a/7b/aa937172.jpg","comment_is_top":false,"comment_ctime":1669901365,"is_pvip":false,"replies":[{"id":132156,"content":"没遇到这样的问题，先看看Prometheus的版本是否与课程里的一致，再参考一下后面的视频，是否有哪步错了。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1669937377,"ip_address":"北京","comment_id":363635,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"按照老师的操作，正常安装promethus和grafana,但是grafana界面打不开，提示如下，还请老师解答下呢，网上搜了一圈也没发现可行的解决方案：\nIf you&#39;re seeing this Grafana has failed to load its application files\n\n1. This could be caused by your reverse proxy settings.\n\n2. If you host grafana under subpath make sure your grafana.ini root_url setting includes subpath. If not using a reverse proxy make sure to set serve_from_sub_path to true.\n\n3. If you have a local dev build make sure you build frontend using: yarn start, yarn start:hot, or yarn build\n\n4. Sometimes restarting grafana-server can help\n\n5. Check if you are using a non-supported browser. For more information, refer to the list of supported browsers.","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595311,"discussion_content":"没遇到这样的问题，先看看Prometheus的版本是否与课程里的一致，再参考一下后面的视频，是否有哪步错了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1669937377,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361867,"user_name":"ybc","can_delete":false,"product_type":"c1","uid":2685834,"ip_address":"北京","ucode":"F3CD0B857B1524","user_header":"https://static001.geekbang.org/account/avatar/00/28/fb/8a/3e8f42f1.jpg","comment_is_top":false,"comment_ctime":1667935296,"is_pvip":false,"replies":[{"id":131635,"content":"看Ingress应该是没问题，可以再看看Nginx的日志，有没有什么信息。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1667959939,"ip_address":"北京","comment_id":361867,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"遇到个问题想请教下老师和同学们： 在prometheus、grafana部署成功后，我采用了ingress的方式来进行访问，但发现prometheus的web可以正常访问，但grafana的界面访问不到，查看日志，访问成功到了ingress controller的pod，但没能转发到grafana的pod，查证ingress的转发规则没问题，试着在ingress controller的pod中ping grafana节点的ip，发现ping不通，发现同一node的某些pod可以ping通，有些则不行。 不知道大家有没有知道原因或排查思路的？\n\n贴下我的ingress规则：\n  rules:\n  - host: prome.test\n    http:\n      paths:\n      - path: &#47;\n        pathType: Prefix\n        backend:\n          service:\n            name: prometheus-k8s\n            port:\n              number: 9090\n  - host: grafana.test\n    http:\n      paths:\n      - path: &#47;\n        pathType: Prefix\n        backend:\n          service:\n            name: grafana\n            port:\n              number: 3000\n","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":593112,"discussion_content":"看Ingress应该是没问题，可以再看看Nginx的日志，有没有什么信息。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667959939,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361170,"user_name":"邵涵","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"上海","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1667291840,"is_pvip":false,"replies":[{"id":131370,"content":"看样子像是coredns的问题，看看它的状态。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1667308535,"ip_address":"上海","comment_id":361170,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"遇到了一个grafana的问题：仪表盘，比如文中展示的“Kubernetes &#47; Compute Resources &#47; Namespace (Pods)”，页面中图形报表没有数据展示，数字部分，比如资源使用率百分比，展示的是NO DATA\n\n这个看起来是grafana调用prometheus获取数据失败了\n安装的grafana中的默认数据源中配置的prometheus url是http:&#47;&#47;prometheus-k8s.monitoring.svc:9090，service对象prometheus-k8s的域名“prometheus-k8s.monitoring.svc”此时在集群中访问失败（通过kubectl exec进入某测试用的pod去访问该域名，得到的是Could not resolve host: prometheus-k8s.monitoring.svc），此时，在default namespace下创建新的deployment+service，新的service对象的域名也是一样访问失败的\n重启coredns也不起作用，是在重启了k8s集群的虚拟机几次之后，这个问题才自己好了，service的域名都可以访问了，grafana中的仪表盘页面也有数据了\n\n另，在发生上述问题时，prometheus的alertmanager pod也是启动失败的\n[shaohan@k8s4 ~]$ kubectl get pod -n monitoring\nNAME                                  READY   STATUS    RESTARTS     AGE\nalertmanager-main-0                   1&#47;2     Running   2 (9s ago)   3m29s\nalertmanager-main-1                   1&#47;2     Running   2 (9s ago)   3m29s\nalertmanager-main-2                   1&#47;2     Running   2 (9s ago)   3m29s\n通过kubectl describe可以看到\n  Warning  Unhealthy  4m34s (x6 over 5m24s)  kubelet            Liveness probe failed: Get &quot;http:&#47;&#47;10.10.1.12:9093&#47;-&#47;healthy&quot;: dial tcp 10.10.1.12:9093: connect: connection refused\n  Warning  Unhealthy  30s (x68 over 5m27s)   kubelet            Readiness probe failed: Get &quot;http:&#47;&#47;10.10.1.12:9093&#47;-&#47;ready&quot;: dial tcp 10.10.1.12:9093: connect: connection refused\n也是网络问题，当上边提到的service域名问题经过虚拟机重启解决了之后，这个alertmanager pod探针失败的问题，也同时消失了，pod成功运行","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592329,"discussion_content":"看样子像是coredns的问题，看看它的状态。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667308535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":361168,"user_name":"alexgreenbar","can_delete":false,"product_type":"c1","uid":1003655,"ip_address":"上海","ucode":"87ED7233E2767C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/50/87/dde718fa.jpg","comment_is_top":false,"comment_ctime":1667291585,"is_pvip":false,"replies":[{"id":131368,"content":"是的，这里必须用create，不能用apply。\n\n一般来说create和apply可以互换，但Prometheus有点特殊，具体的原因还没有深究。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1667308443,"ip_address":"上海","comment_id":361168,"utype":1}],"discussion_count":1,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"kubectl create -f manifests&#47;setup\n\n用create没有问题，但用apply会报错，之前一直用apply，这里是有什么区别吗？\n\n**********\nkubectl apply -f manifests&#47;setup\ncustomresourcedefinition.apiextensions.k8s.io&#47;alertmanagerconfigs.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io&#47;alertmanagers.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io&#47;podmonitors.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io&#47;probes.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io&#47;prometheusrules.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io&#47;servicemonitors.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io&#47;thanosrulers.monitoring.coreos.com created\nnamespace&#47;monitoring created\nThe CustomResourceDefinition &quot;prometheuses.monitoring.coreos.com&quot; is invalid: metadata.annotations: Too long: must have at most 262144 bytes\n**********","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":592327,"discussion_content":"是的，这里必须用create，不能用apply。\n\n一般来说create和apply可以互换，但Prometheus有点特殊，具体的原因还没有深究。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1667308443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":360695,"user_name":"rubys_","can_delete":false,"product_type":"c1","uid":1394115,"ip_address":"上海","ucode":"931AD02864126A","user_header":"https://static001.geekbang.org/account/avatar/00/15/45/c3/775fe460.jpg","comment_is_top":false,"comment_ctime":1666765663,"is_pvip":false,"replies":[{"id":131228,"content":"Service是虚ip，只用来负载均衡，不能ping，可以再回看那一讲。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1666774786,"ip_address":"上海","comment_id":360695,"utype":1}],"discussion_count":2,"race_medal":2,"score":4,"product_id":100114501,"comment_content":"老师，我执行了 \nkubectl run test -it --image=httpd:alpine -- sh 之后，在里面 ping 不了 ngx-hpa-svc 是为何？在 httpd pod 里面的 ifconfig 显示 ip 是 10.10.1.6，然后 kubectl get svc 显示的 ngx-hpa-svc 的 IP 为 10.96.32.144","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591714,"discussion_content":"Service是虚ip，只用来负载均衡，不能ping，可以再回看那一讲。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666774787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1394115,"avatar":"https://static001.geekbang.org/account/avatar/00/15/45/c3/775fe460.jpg","nickname":"rubys_","note":"","ucode":"931AD02864126A","race_medal":2,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":591716,"discussion_content":"主要是 ab 不了。最后放弃了虚拟机，用阿里云按量付费的两台机，没有那么多问题，直接就行了，感觉很多问题是我的虚拟机本身的问题，有时候在虚拟机里面镜像都拉取不了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666775574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":591714,"ip_address":"广东","group_id":0},"score":591716,"extra":""}]}]},{"had_liked":false,"id":359511,"user_name":"朱雯","can_delete":false,"product_type":"c1","uid":1035744,"ip_address":"北京","ucode":"064C45FBF6B51F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/cd/e0/c85bb948.jpg","comment_is_top":false,"comment_ctime":1665588009,"is_pvip":false,"replies":[{"id":130738,"content":"应该是Prometheus里的crd资源起作用了吧，和dump无关，可以重新安装试试。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1665629766,"ip_address":"北京","comment_id":359511,"utype":1}],"discussion_count":2,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"kubectl get pods -n monitoring \nalertmanager-main-0                   1&#47;2     CrashLoopBackOff   9 (8s ago)   24m\nalertmanager-main-1                   2&#47;2     Running            0            24m\nalertmanager-main-2                   1&#47;2     CrashLoopBackOff   9 (7s ago)   24m\nblackbox-exporter-746c64fd88-tlxm4    3&#47;3     Running            0            25m\ngrafana-5fc7f9f55d-tvmzb              1&#47;1     Running            0            24m\n\n\n\n\nkubectl describe pod alertmanager-main-0 -n monitoring\n Normal   Scheduled  25m                    default-scheduler  Successfully assigned monitoring&#47;alertmanager-main-0 to worker\n  Normal   Pulled     24m                    kubelet            Container image &quot;quay.io&#47;prometheus&#47;alertmanager:v0.24.0&quot; already present on machine\n  Normal   Created    24m                    kubelet            Created container alertmanager\n  Normal   Pulled     24m                    kubelet            Container image &quot;quay.io&#47;prometheus-operator&#47;prometheus-config-reloader:v0.57.0&quot; already present on machine\n  Normal   Created    24m                    kubelet            Created container config-reloader\n  Normal   Started    24m                    kubelet            Started container config-reloader\n  Warning  Unhealthy  23m (x6 over 24m)      kubelet            Liveness probe failed: Get &quot;http:&#47;&#47;10.10.171.67:9093&#47;-&#47;healthy&quot;: dial tcp 10.10.171.67:9093: connect: connection refused\n  Normal   Started    14m (x7 over 24m)      kubelet            Started container alertmanager\n  Warning  Unhealthy  9m54s (x169 over 24m)  kubelet            Readiness probe failed: Get &quot;http:&#47;&#47;10.10.171.67:9093&#47;-&#47;ready&quot;: dial tcp 10.10.171.67:9093: connect: connection refused\n\n\n根据这篇文章https:&#47;&#47;blog.csdn.net&#47;Entity_G&#47;article&#47;details&#47;117461725进行操作，结果发现两件事，第一sts无法删除，删除sts直接0&#47;3又开始启动，请问sts是还有更上一级别得服务吗，第二个就是dump执行还是无法解决问题，请问有老师知道啥情况吗，\n","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590226,"discussion_content":"应该是Prometheus里的crd资源起作用了吧，和dump无关，可以重新安装试试。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665629766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1035744,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/cd/e0/c85bb948.jpg","nickname":"朱雯","note":"","ucode":"064C45FBF6B51F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":590465,"discussion_content":"多次重新安装后 发现只要使用的是flannel插件就没事 但我之前装过calico插件 所以不行","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665773364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":590226,"ip_address":"北京","group_id":0},"score":590465,"extra":""}]}]},{"had_liked":false,"id":356313,"user_name":"大布丁","can_delete":false,"product_type":"c1","uid":1389744,"ip_address":"北京","ucode":"3C655AA79A538C","user_header":"https://static001.geekbang.org/account/avatar/00/15/34/b0/8d14a2a1.jpg","comment_is_top":false,"comment_ctime":1662131119,"is_pvip":false,"replies":[{"id":129689,"content":"good","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1662169917,"ip_address":"北京","comment_id":356313,"utype":1}],"discussion_count":3,"race_medal":0,"score":4,"product_id":100114501,"comment_content":"监控系统一般都是GPE三个组件一起用的","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586370,"discussion_content":"good","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662169917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2103320,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/YQBwClu5f6pibYCNxoEgKkM2uvgytevWp1FBVnec3ialmFDsftEvjvRShYKn2cTicmK8M9az6ribcz65zPpGq3X3QA/132","nickname":"Geek_a68e6d","note":"","ucode":"F7AD54784E79A6","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588053,"discussion_content":"Grafana, Prometheus, Exporter","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663507347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1202047,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/oib0a89lqtOhJL1UvfUp4uTsRLrDbhoGk9jLiciazxMu0COibJsFCZDypK1ZFcHEJc9d9qgbjvgR41ImL6FNPoVlWA/132","nickname":"stefen","note":"","ucode":"7C9AAE829E7802","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587327,"discussion_content":"GPE分别代表啥呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662978091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"四川","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356131,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"上海","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1662001514,"is_pvip":false,"replies":[{"id":129633,"content":"“exec format error”这样的感觉都是镜像的格式不对，比如amd64&#47;arm64，换个镜像试试，好像有同学在回复里用其他的镜像源。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1662002914,"ip_address":"上海","comment_id":356131,"utype":1}],"discussion_count":1,"race_medal":0,"score":5,"product_id":100114501,"comment_content":"感谢老师及时、准确的回答，有一个新问题：\nQ4: prometheus-adapter的状态是CrashLoopBackOff\n昨天(周三，8月31号)，四个POD不正常。今天(9月1号)，重新启动虚拟机后，原来处于“ImagePullBackOff”的两个“blackbox-exporter”，都是RUNNING了。但是，两个prometheus-adapter的状态是CrashLoopBackOff。\n执行kubectl create -f manifests&#47;setup、kubectl create -f manifests后，\n查看 pod， 其中有两个prometheus-adapter的状态是CrashLoopBackOff\nprometheus-adapter-8547d6666f-rhrc8： CrashLoopBackOff\n用describe查看，其中有这样的信息：kube-api-access-5d9js:\n    Type:        Projected (a volume that contains injected data from multiple sources)\n好像这个是导致错误了，是资源限制吗？\n\n另外，查看logs，显示信息如下：exec &#47;adapter: exec format error\n\n我提供的信息不全面，老师不容易判断具体原因，老师只要给个大致方向即可。\n另外，老师可以给出排查的思路，比如先查XXX，后查YYY等。","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586149,"discussion_content":"“exec format error”这样的感觉都是镜像的格式不对，比如amd64/arm64，换个镜像试试，好像有同学在回复里用其他的镜像源。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662002914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356063,"user_name":"Dexter","can_delete":false,"product_type":"c1","uid":2608728,"ip_address":"北京","ucode":"909CABC4AC4AC9","user_header":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","comment_is_top":false,"comment_ctime":1661942220,"is_pvip":true,"replies":[{"id":129628,"content":"看一下相关的service是否工作正常，是否正确配置了NodePort。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1661997388,"ip_address":"北京","comment_id":356063,"utype":1}],"discussion_count":3,"race_medal":0,"score":5,"product_id":100114501,"comment_content":"prometheus 都部署成功了，就是用nodeport 的方式打不开UI的界面，grafana prometheus 都这样。浏览器需要什么特殊配置吗？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586128,"discussion_content":"看一下相关的service是否工作正常，是否正确配置了NodePort。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661997388,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3031731,"avatar":"","nickname":"Geek_9d0de4","note":"","ucode":"6692B89D125E9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587168,"discussion_content":"我也是这样，请问解决了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662863479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1055478,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1a/f6/5de02496.jpg","nickname":"Shadow","note":"","ucode":"1DA38D105F88F9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586353,"discussion_content":"@ Dexter，你好，你的问题解决了吗，我也遇到同样的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662128330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"安徽","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356015,"user_name":"Dexter","can_delete":false,"product_type":"c1","uid":2608728,"ip_address":"北京","ucode":"909CABC4AC4AC9","user_header":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","comment_is_top":false,"comment_ctime":1661919658,"is_pvip":true,"replies":[{"id":129579,"content":"用describe看看service的状况。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1661935267,"ip_address":"北京","comment_id":356015,"utype":1}],"discussion_count":2,"race_medal":0,"score":5,"product_id":100114501,"comment_content":"成功安装了普罗米修斯，但是node port一直打不开，不知道是不是实验室的网络问题，比如防火墙…","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586012,"discussion_content":"用describe看看service的状况。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661935268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1055478,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1a/f6/5de02496.jpg","nickname":"Shadow","note":"","ucode":"1DA38D105F88F9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586358,"discussion_content":"@ Dexter，你好，你的问题解决了吗，我也遇到同样的问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662129779,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"安徽","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355974,"user_name":"Hale","can_delete":false,"product_type":"c1","uid":1129731,"ip_address":"北京","ucode":"1925955343FE94","user_header":"https://static001.geekbang.org/account/avatar/00/11/3d/03/b2d9a084.jpg","comment_is_top":false,"comment_ctime":1661903489,"is_pvip":false,"replies":[{"id":129556,"content":"不是，它要求pod必须要有资源申请，否则就不会工作。","user_name":"作者回复","user_name_real":"编辑","uid":1181974,"ctime":1661912454,"ip_address":"北京","comment_id":355974,"utype":1}],"discussion_count":1,"race_medal":0,"score":5,"product_id":100114501,"comment_content":"Hpa 查出来的cpu使用率是把pod内的request cpu作为用的cpu吗？","like_count":0,"discussions":[{"author":{"id":1181974,"avatar":"https://static001.geekbang.org/account/avatar/00/12/09/16/1161017c.jpg","nickname":"罗剑锋","note":"","ucode":"95678C988F24AB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585933,"discussion_content":"不是，它要求pod必须要有资源申请，否则就不会工作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661912454,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}