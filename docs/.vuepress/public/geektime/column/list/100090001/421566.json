{"id":421566,"title":"07 | RDDå¸¸ç”¨ç®—å­ï¼ˆäºŒï¼‰ï¼šSparkå¦‚ä½•å®ç°æ•°æ®èšåˆï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>ç§¯ç´¯äº†ä¸€å®šçš„ç†è®ºåŸºç¡€ä¹‹åï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­æ¥å­¦ä¹ RDDå¸¸ç”¨ç®—å­ã€‚åœ¨<a href=\"https://time.geekbang.org/column/article/418079\">RDDå¸¸ç”¨ç®—å­ï¼ˆä¸€ï¼‰</a>é‚£ä¸€è®²ï¼Œæˆ‘ä»¬è®²äº†å››ä¸ªç®—å­mapã€mapPartitionsã€flatMapå’Œfilterï¼ŒåŒæ—¶ç•™äº†è¿™æ ·ä¸€é“æ€è€ƒé¢˜ï¼šâ€œè¿™äº›ç®—å­ä¹‹é—´ï¼Œæœ‰å“ªäº›å…±åŒç‚¹ï¼Ÿâ€</p><p>ä»Šå¤©æˆ‘ä»¬å°±æ¥æ­æ™“ç­”æ¡ˆã€‚é¦–å…ˆï¼Œåœ¨åŠŸèƒ½æ–¹é¢ï¼Œè¿™4ä¸ªç®—å­éƒ½ç”¨äºRDDå†…éƒ¨çš„æ•°æ®è½¬æ¢ï¼Œè€Œå­¦ä¹ è¿‡Shuffleçš„å·¥ä½œåŸç†ä¹‹åï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œè¿™4ä¸ªç®—å­å½“ä¸­ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªç®—å­ï¼Œä¼šå¼•å…¥Shuffleè®¡ç®—ã€‚</p><p>è€Œä»Šå¤©æˆ‘ä»¬è¦å­¦ä¹ çš„å‡ ä¸ªç®—å­åˆ™æ°æ°ç›¸åï¼Œå®ƒä»¬éƒ½ä¼šå¼•å…¥ç¹é‡çš„Shuffleè®¡ç®—ã€‚è¿™äº›ç®—å­åˆ†åˆ«æ˜¯groupByKeyã€reduceByKeyã€aggregateByKeyå’ŒsortByKeyï¼Œä¹Ÿå°±æ˜¯è¡¨æ ¼ä¸­åŠ ç²—çš„éƒ¨åˆ†ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ•°æ®åˆ†æåœºæ™¯ä¸­ï¼Œå…¸å‹çš„è®¡ç®—ç±»å‹åˆ†åˆ«æ˜¯åˆ†ç»„ã€èšåˆå’Œæ’åºã€‚è€ŒgroupByKeyã€reduceByKeyã€aggregateByKeyå’ŒsortByKeyè¿™äº›ç®—å­çš„åŠŸèƒ½ï¼Œæ°æ°å°±æ˜¯ç”¨æ¥å®ç°åˆ†ç»„ã€èšåˆå’Œæ’åºçš„è®¡ç®—é€»è¾‘ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c9/fc/c97a717512897749d5db659fb583c8fc.jpg?wh=1597x1977\" alt=\"å›¾ç‰‡\" title=\"RDDç®—å­åˆ†ç±»è¡¨\"></p><p>å°½ç®¡è¿™äº›ç®—å­çœ‹ä¸Šå»ç›¸æ¯”å…¶ä»–ç®—å­çš„é€‚ç”¨èŒƒå›´æ›´çª„ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬åªèƒ½ä½œç”¨ï¼ˆApplyï¼‰åœ¨Paired RDDä¹‹ä¸Šï¼Œæ‰€è°“Paired RDDï¼Œå®ƒæŒ‡çš„æ˜¯å…ƒç´ ç±»å‹ä¸ºï¼ˆKeyï¼ŒValueï¼‰é”®å€¼å¯¹çš„RDDã€‚</p><!-- [[[read_end]]] --><p>ä½†æ˜¯åœ¨åŠŸèƒ½æ–¹é¢ï¼Œå¯ä»¥è¯´ï¼Œå®ƒä»¬æ‰¿æ‹…äº†æ•°æ®åˆ†æåœºæ™¯ä¸­çš„å¤§éƒ¨åˆ†èŒè´£ã€‚å› æ­¤ï¼ŒæŒæ¡è¿™äº›ç®—å­çš„ç”¨æ³•ï¼Œæ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ¸¸åˆƒæœ‰ä½™åœ°å¼€å‘æ•°æ®åˆ†æåº”ç”¨çš„é‡è¦åŸºç¡€ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é€šè¿‡ä¸€äº›å®ä¾‹ï¼Œæ¥ç†Ÿæ‚‰å¹¶å­¦ä¹ è¿™äº›ç®—å­çš„ç”¨æ³•ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥è¯´è¯´groupByKeyï¼Œå¦ç™½åœ°è¯´ï¼Œç›¸æ¯”åé¢çš„3ä¸ªç®—å­ï¼ŒgroupByKeyåœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­çš„â€œå‡ºé•œç‡â€å¹¶ä¸é«˜ã€‚ä¹‹æ‰€ä»¥è¦å…ˆä»‹ç»å®ƒï¼Œä¸»è¦æ˜¯ä¸ºåç»­çš„reduceByKeyå’ŒaggregateByKeyè¿™ä¸¤ä¸ªé‡è¦ç®—å­åšé“ºå«ã€‚</p><h2>groupByKeyï¼šåˆ†ç»„æ”¶é›†</h2><p>groupByKeyçš„å­—é¢æ„æ€æ˜¯â€œæŒ‰ç…§Keyåšåˆ†ç»„â€ï¼Œä½†å®é™…ä¸Šï¼ŒgroupByKeyç®—å­åŒ…å«ä¸¤æ­¥ï¼Œå³<strong>åˆ†ç»„</strong>å’Œ<strong>æ”¶é›†</strong>ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå¯¹äºå…ƒç´ ç±»å‹ä¸ºï¼ˆKeyï¼ŒValueï¼‰é”®å€¼å¯¹çš„Paired RDDï¼ŒgroupByKeyçš„åŠŸèƒ½å°±æ˜¯å¯¹Keyå€¼ç›¸åŒçš„å…ƒç´ åšåˆ†ç»„ï¼Œç„¶åæŠŠç›¸åº”çš„Valueå€¼ï¼Œä»¥é›†åˆçš„å½¢å¼æ”¶é›†åˆ°ä¸€èµ·ã€‚æ¢å¥è¯è¯´ï¼ŒgroupByKeyä¼šæŠŠRDDçš„ç±»å‹ï¼Œç”±RDD[(Key, Value)]è½¬æ¢ä¸ºRDD[(Key, Valueé›†åˆ)]ã€‚</p><p>è¿™ä¹ˆè¯´æ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸€ä¸ªå°ä¾‹å­æ¥è¯´æ˜groupByKeyçš„ç”¨æ³•ã€‚è¿˜æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„Word Countï¼Œå¯¹äºåˆ†è¯åçš„ä¸€ä¸ªä¸ªå•è¯ï¼Œå‡è®¾æˆ‘ä»¬ä¸å†ç»Ÿè®¡å…¶è®¡æ•°ï¼Œè€Œä»…ä»…æ˜¯æŠŠç›¸åŒçš„å•è¯æ”¶é›†åˆ°ä¸€èµ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼ŸæŒ‰ç…§è€è§„çŸ©ï¼Œå’±ä»¬è¿˜æ˜¯å…ˆæ¥ç»™å‡ºä»£ç å®ç°ï¼š</p><pre><code class=\"language-scala\">import org.apache.spark.rdd.RDD\n&nbsp;\n// ä»¥è¡Œä¸ºå•ä½åšåˆ†è¯\nval cleanWordRDD: RDD[String] = _ // å®Œæ•´ä»£ç è¯·å‚è€ƒç¬¬ä¸€è®²çš„Word Count\n// æŠŠæ™®é€šRDDæ˜ å°„ä¸ºPaired RDD\nval kvRDD: RDD[(String, String)] = cleanWordRDD.map(word =&gt; (word, word))\n&nbsp;\n// æŒ‰ç…§å•è¯åšåˆ†ç»„æ”¶é›†\nval words: RDD[(String, Iterable[String])] = kvRDD.groupByKey()\n</code></pre><p>ç»“åˆå‰é¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œç›¸æ¯”ä¹‹å‰çš„Word Countï¼Œæˆ‘ä»¬ä»…éœ€åšä¸¤ä¸ªå¾®å°çš„æ”¹åŠ¨ï¼Œå³å¯å®ç°æ–°çš„è®¡ç®—é€»è¾‘ã€‚ç¬¬ä¸€ä¸ªæ”¹åŠ¨ï¼Œæ˜¯æŠŠmapç®—å­çš„æ˜ å°„å‡½æ•°fï¼Œç”±åŸæ¥çš„word =&gt; ï¼ˆwordï¼Œ1ï¼‰å˜æ›´ä¸ºword =&gt; ï¼ˆwordï¼Œwordï¼‰ï¼Œè¿™ä¹ˆåšçš„æ•ˆæœï¼Œæ˜¯æŠŠkvRDDå…ƒç´ çš„Keyå’ŒValueéƒ½å˜æˆäº†å•è¯ã€‚</p><p>ç´§æ¥ç€ï¼Œç¬¬äºŒä¸ªæ”¹åŠ¨ï¼Œæˆ‘ä»¬ç”¨groupByKeyæ›¿æ¢äº†åŸå…ˆçš„reduceByKeyã€‚ç›¸æ¯”reduceByKeyï¼ŒgroupByKeyçš„ç”¨æ³•è¦ç®€æ˜å¾—å¤šã€‚groupByKeyæ˜¯æ— å‚å‡½æ•°ï¼Œè¦å®ç°å¯¹Paired RDDçš„åˆ†ç»„ã€æ”¶é›†ï¼Œæˆ‘ä»¬ä»…éœ€åœ¨RDDä¹‹ä¸Šè°ƒç”¨groupByKey()å³å¯ã€‚</p><p>å°½ç®¡groupByKeyçš„ç”¨æ³•éå¸¸ç®€å•ï¼Œä½†å®ƒçš„è®¡ç®—è¿‡ç¨‹å€¼å¾—æˆ‘ä»¬ç‰¹åˆ«å…³æ³¨ï¼Œä¸‹é¢æˆ‘ç”¨ä¸€å¼ ç¤ºæ„å›¾æ¥è®²è§£ä¸Šè¿°ä»£ç çš„è®¡ç®—è¿‡ç¨‹ï¼Œä»è€Œè®©ä½ æ›´åŠ ç›´è§‚åœ°æ„Ÿå—groupByKeyå¯èƒ½å­˜åœ¨çš„æ€§èƒ½éšæ‚£ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/6f/77/6f1c7fb6bebd3yy43b1404835fe86d77.jpg?wh=1920x1071\" alt=\"å›¾ç‰‡\" title=\"groupByKeyè®¡ç®—è¿‡ç¨‹\"></p><p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†å®Œæˆåˆ†ç»„æ”¶é›†ï¼Œå¯¹äºKeyå€¼ç›¸åŒã€ä½†åˆ†æ•£åœ¨ä¸åŒæ•°æ®åˆ†åŒºçš„åŸå§‹æ•°æ®è®°å½•ï¼ŒSparkéœ€è¦é€šè¿‡Shuffleæ“ä½œï¼Œè·¨èŠ‚ç‚¹ã€è·¨è¿›ç¨‹åœ°æŠŠå®ƒä»¬åˆ†å‘åˆ°ç›¸åŒçš„æ•°æ®åˆ†åŒºã€‚æˆ‘ä»¬ä¹‹å‰åœ¨<a href=\"https://time.geekbang.org/column/article/420399\">ç¬¬6è®²</a>ä¸­è¯´äº†ï¼Œ<strong>Shuffleæ˜¯èµ„æºå¯†é›†å‹è®¡ç®—</strong>ï¼Œå¯¹äºåŠ¨è¾„ä¸Šç™¾ä¸‡ã€ç”šè‡³ä¸Šäº¿æ¡æ•°æ®è®°å½•çš„RDDæ¥è¯´ï¼Œè¿™æ ·çš„Shuffleè®¡ç®—ä¼šäº§ç”Ÿå¤§é‡çš„ç£ç›˜I/Oä¸ç½‘ç»œI/Oå¼€é”€ï¼Œä»è€Œä¸¥é‡å½±å“ä½œä¸šçš„æ‰§è¡Œæ€§èƒ½ã€‚</p><p>è™½ç„¶groupByKeyçš„æ‰§è¡Œæ•ˆç‡è¾ƒå·®ï¼Œä¸è¿‡å¥½åœ¨å®ƒåœ¨åº”ç”¨å¼€å‘ä¸­çš„â€œå‡ºé•œç‡â€å¹¶ä¸é«˜ã€‚åŸå› å¾ˆç®€å•ï¼Œåœ¨æ•°æ®åˆ†æé¢†åŸŸä¸­ï¼Œåˆ†ç»„æ”¶é›†çš„ä½¿ç”¨åœºæ™¯å¾ˆå°‘ï¼Œè€Œåˆ†ç»„èšåˆæ‰æ˜¯ç»Ÿè®¡åˆ†æçš„åˆšéœ€ã€‚</p><p>ä¸ºäº†æ»¡è¶³åˆ†ç»„èšåˆå¤šæ ·åŒ–çš„è®¡ç®—éœ€è¦ï¼ŒSparkæä¾›äº†3ç§RDDç®—å­ï¼Œå…è®¸å¼€å‘è€…çµæ´»åœ°å®ç°è®¡ç®—é€»è¾‘ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯reduceByKeyã€aggregateByKeyå’ŒcombineByKeyã€‚</p><p>reduceByKeyæˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œç¬¬1è®²çš„Word Countå®ç°å°±ç”¨åˆ°äº†è¿™ä¸ªç®—å­ï¼ŒaggregateByKeyæ˜¯reduceByKeyçš„â€œå‡çº§ç‰ˆâ€ï¼Œç›¸æ¯”reduceByKeyï¼ŒaggregateByKeyç”¨æ³•æ›´åŠ çµæ´»ï¼Œæ”¯æŒçš„åŠŸèƒ½ä¹Ÿæ›´åŠ å®Œå¤‡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾reduceByKeyï¼Œç„¶åå†å¯¹aggregateByKeyè¿›è¡Œå±•å¼€ã€‚ç›¸æ¯”aggregateByKeyï¼ŒcombineByKeyä»…åœ¨åˆå§‹åŒ–æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒï¼Œå› æ­¤ï¼Œæˆ‘æŠŠå®ƒç•™ç»™ä½ ä½œä¸ºè¯¾åä½œä¸šå»æ¢ç´¢ã€‚</p><h2>reduceByKeyï¼šåˆ†ç»„èšåˆ</h2><p>reduceByKeyçš„å­—é¢å«ä¹‰æ˜¯â€œæŒ‰ç…§Keyå€¼åšèšåˆâ€ï¼Œå®ƒçš„è®¡ç®—é€»è¾‘ï¼Œå°±æ˜¯æ ¹æ®èšåˆå‡½æ•°fç»™å‡ºçš„ç®—æ³•ï¼ŒæŠŠKeyå€¼ç›¸åŒçš„å¤šä¸ªå…ƒç´ ï¼Œèšåˆæˆä¸€ä¸ªå…ƒç´ ã€‚</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/415209\">ç¬¬1è®²</a>Word Countçš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†reduceByKeyæ¥å®ç°åˆ†ç»„è®¡æ•°ï¼š</p><pre><code class=\"language-scala\">// æŠŠRDDå…ƒç´ è½¬æ¢ä¸ºï¼ˆKeyï¼ŒValueï¼‰çš„å½¢å¼\nval kvRDD: RDD[(String, Int)] = cleanWordRDD.map(word =&gt; (word, 1))\n&nbsp;\n// æŒ‰ç…§å•è¯åšåˆ†ç»„è®¡æ•°\nval wordCounts: RDD[(String, Int)] = kvRDD.reduceByKey((x: Int, y: Int) =&gt; x + y)\n</code></pre><p>é‡æ¸©ä¸Šé¢çš„è¿™æ®µä»£ç ï¼Œä½ æœ‰æ²¡æœ‰è§‰å¾—reduceByKeyä¸ä¹‹å‰è®²è¿‡çš„mapã€filterè¿™äº›ç®—å­æœ‰ä¸€äº›ç›¸ä¼¼çš„åœ°æ–¹ï¼Ÿæ²¡é”™ï¼Œç»™å®šå¤„ç†å‡½æ•°fï¼Œå®ƒä»¬çš„ç”¨æ³•éƒ½æ˜¯â€œç®—å­(f)â€ã€‚åªä¸è¿‡<strong>å¯¹äºmapæ¥è¯´ï¼Œæˆ‘ä»¬æŠŠfç§°ä½œæ˜¯æ˜ å°„å‡½æ•°ï¼Œå¯¹filteræ¥è¯´ï¼Œæˆ‘ä»¬æŠŠfç§°ä½œåˆ¤å®šå‡½æ•°ï¼Œè€Œå¯¹äºreduceByKeyï¼Œæˆ‘ä»¬æŠŠfå«ä½œèšåˆå‡½æ•°ã€‚</strong></p><p>åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼ŒreduceByKeyçš„èšåˆå‡½æ•°æ˜¯åŒ¿åå‡½æ•°ï¼š(x, y) =&gt; x + yã€‚ä¸mapã€filterç­‰ç®—å­çš„ç”¨æ³•ä¸€æ ·ï¼Œä½ ä¹Ÿå¯ä»¥æ˜ç¡®åœ°å®šä¹‰å¸¦åå‡½æ•°fï¼Œç„¶åå†ç”¨reduceByKey(f)çš„æ–¹å¼å®ç°åŒæ ·çš„è®¡ç®—é€»è¾‘ã€‚</p><p>éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œç»™å®šRDD[(Keyç±»å‹ï¼ŒValueç±»å‹)]ï¼Œèšåˆå‡½æ•°fçš„ç±»å‹ï¼Œå¿…é¡»æ˜¯ï¼ˆValueç±»å‹ï¼ŒValueç±»å‹ï¼‰ =&gt; ï¼ˆValueç±»å‹ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œå‡½æ•°fçš„å½¢å‚ï¼Œå¿…é¡»æ˜¯ä¸¤ä¸ªæ•°å€¼ï¼Œä¸”æ•°å€¼çš„ç±»å‹å¿…é¡»ä¸Valueçš„ç±»å‹ç›¸åŒï¼Œè€Œfçš„è¿”å›å€¼ï¼Œä¹Ÿå¿…é¡»æ˜¯Valueç±»å‹çš„æ•°å€¼ã€‚</p><p>å’±ä»¬ä¸å¦¨å†ä¸¾ä¸€ä¸ªå°ä¾‹å­ï¼Œè®©ä½ åŠ æ·±å¯¹äºreduceByKeyç®—å­çš„ç†è§£ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠWord Countçš„è®¡ç®—é€»è¾‘ï¼Œæ”¹ä¸ºéšæœºèµ‹å€¼ã€æå–åŒä¸€ä¸ªKeyçš„æœ€å¤§å€¼ã€‚ä¹Ÿå°±æ˜¯åœ¨kvRDDçš„ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸å†ä½¿ç”¨æ˜ å°„å‡½æ•°word =&gt; (word, 1)ï¼Œè€Œæ˜¯æ”¹ä¸ºword =&gt; (word, éšæœºæ•°)ï¼Œç„¶åå†ä½¿ç”¨reduceByKeyç®—å­æ¥è®¡ç®—åŒä¸€ä¸ªwordå½“ä¸­æœ€å¤§çš„é‚£ä¸ªéšæœºæ•°ã€‚</p><p>ä½ å¯ä»¥å…ˆåœä¸‹æ¥ï¼ŒèŠ±ç‚¹æ—¶é—´æƒ³ä¸€æƒ³è¿™ä¸ªé€»è¾‘è¯¥æ€ä¹ˆå®ç°ï¼Œç„¶åå†æ¥å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p><pre><code class=\"language-scala\">import scala.util.Random._\n&nbsp;\n// æŠŠRDDå…ƒç´ è½¬æ¢ä¸ºï¼ˆKeyï¼ŒValueï¼‰çš„å½¢å¼\nval kvRDD: RDD[(String, Int)] = cleanWordRDD.map(word =&gt; (word, nextInt(100)))\n&nbsp;\n// æ˜¾ç¤ºå®šä¹‰æå–æœ€å¤§å€¼çš„èšåˆå‡½æ•°f\ndef f(x: Int, y: Int): Int = {\nreturn math.max(x, y)\n}\n&nbsp;\n// æŒ‰ç…§å•è¯æå–æœ€å¤§å€¼\nval wordCounts: RDD[(String, Int)] = kvRDD.reduceByKey(f)\n</code></pre><p>è§‚å¯Ÿä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼Œä¸éš¾å‘ç°ï¼ŒreduceByKeyç®—å­çš„ç”¨æ³•è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåªéœ€è¦å…ˆå®šä¹‰å¥½èšåˆå‡½æ•°fï¼Œç„¶åæŠŠå®ƒä¼ ç»™reduceByKeyç®—å­å°±è¡Œäº†ã€‚é‚£ä¹ˆåœ¨è¿è¡Œæ—¶ï¼Œä¸Šè¿°ä»£ç çš„è®¡ç®—åˆæ˜¯æ€æ ·çš„ä¸€ä¸ªè¿‡ç¨‹å‘¢ï¼Ÿ</p><p>æˆ‘æŠŠreduceByKeyçš„è®¡ç®—è¿‡ç¨‹æŠ½è±¡æˆäº†ä¸‹å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/ac/85/aca17fe4d0fa5a52f4b9e73056aa1185.jpg?wh=1920x951\" alt=\"å›¾ç‰‡\" title=\"reduceByKeyè®¡ç®—è¿‡ç¨‹\"></p><p>ä»å›¾ä¸­ä½ å¯ä»¥çœ‹å‡ºæ¥ï¼Œå°½ç®¡reduceByKeyä¹Ÿä¼šå¼•å…¥Shuffleï¼Œä½†ç›¸æ¯”groupByKeyä»¥å…¨é‡åŸå§‹æ•°æ®è®°å½•çš„æ–¹å¼æ¶ˆè€—ç£ç›˜ä¸ç½‘ç»œï¼ŒreduceByKeyåœ¨è½ç›˜ä¸åˆ†å‘ä¹‹å‰ï¼Œä¼šå…ˆåœ¨Shuffleçš„Mapé˜¶æ®µåšåˆæ­¥çš„èšåˆè®¡ç®—ã€‚</p><p>æ¯”å¦‚ï¼Œåœ¨æ•°æ®åˆ†åŒº0çš„å¤„ç†ä¸­ï¼Œåœ¨Mapé˜¶æ®µï¼ŒreduceByKeyæŠŠKeyåŒä¸ºStreamingçš„ä¸¤æ¡æ•°æ®è®°å½•èšåˆä¸ºä¸€æ¡ï¼Œèšåˆé€»è¾‘å°±æ˜¯ç”±å‡½æ•°få®šä¹‰çš„ã€å–ä¸¤è€…ä¹‹é—´Valueè¾ƒå¤§çš„æ•°æ®è®°å½•ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œ<strong>Mapç«¯èšåˆ</strong>â€ã€‚ç›¸åº”åœ°ï¼Œæ•°æ®ç»ç”±ç½‘ç»œåˆ†å‘ä¹‹åï¼Œåœ¨Reduceé˜¶æ®µå®Œæˆçš„è®¡ç®—ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œ<strong>Reduceç«¯èšåˆ</strong>â€ã€‚</p><p>ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œåšäº†Mapèšåˆåˆèƒ½æ€æ ·å‘¢ï¼Ÿç›¸æ¯”groupByKeyï¼ŒreduceByKeyå¸¦æ¥çš„æ€§èƒ½æ”¶ç›Šå¹¶ä¸ç®—æ˜æ˜¾å‘€ï¼â€ç¡®å®ï¼Œå°±ä¸Šé¢çš„ç¤ºæ„å›¾æ¥è¯´ï¼Œæˆ‘ä»¬å¾ˆéš¾æ„Ÿå—åˆ°reduceByKeyå¸¦æ¥çš„æ€§èƒ½æ”¶ç›Šã€‚ä¸è¿‡ï¼Œé‡å˜å¼•èµ·è´¨å˜ï¼Œåœ¨å·¥ä¸šçº§çš„æµ·é‡æ•°æ®ä¸‹ï¼Œç›¸æ¯”groupByKeyï¼ŒreduceByKeyé€šè¿‡åœ¨Mapç«¯å¤§å¹…å‰Šå‡éœ€è¦è½ç›˜ä¸åˆ†å‘çš„æ•°æ®é‡ï¼Œå¾€å¾€èƒ½å°†æ‰§è¡Œæ•ˆç‡æå‡è‡³å°‘ä¸€å€ã€‚</p><p>åº”è¯¥è¯´ï¼Œå¯¹äºå¤§å¤šæ•°åˆ†ç»„&amp;èšåˆçš„è®¡ç®—éœ€æ±‚æ¥è¯´ï¼Œåªè¦è®¾è®¡åˆé€‚çš„èšåˆå‡½æ•°fï¼Œä½ éƒ½å¯ä»¥ä½¿ç”¨reduceByKeyæ¥å®ç°è®¡ç®—é€»è¾‘ã€‚ä¸è¿‡ï¼Œæœ¯ä¸šæœ‰ä¸“æ”»ï¼ŒreduceByKeyç®—å­çš„å±€é™æ€§ï¼Œ<strong>åœ¨äºå…¶Mapé˜¶æ®µä¸Reduceé˜¶æ®µçš„è®¡ç®—é€»è¾‘å¿…é¡»ä¿æŒä¸€è‡´ï¼Œè¿™ä¸ªè®¡ç®—é€»è¾‘ç»Ÿä¸€ç”±èšåˆå‡½æ•°få®šä¹‰</strong>ã€‚å½“ä¸€ç§è®¡ç®—åœºæ™¯éœ€è¦åœ¨ä¸¤ä¸ªé˜¶æ®µæ‰§è¡Œä¸åŒè®¡ç®—é€»è¾‘çš„æ—¶å€™ï¼ŒreduceByKeyå°±çˆ±è«èƒ½åŠ©äº†ã€‚</p><p>æ¯”æ–¹è¯´ï¼Œè¿˜æ˜¯ç¬¬1è®²çš„Word Countï¼Œæˆ‘ä»¬æƒ³å¯¹å•è¯è®¡æ•°çš„è®¡ç®—é€»è¾‘åšå¦‚ä¸‹è°ƒæ•´ï¼š</p><ul>\n<li>åœ¨Mapé˜¶æ®µï¼Œä»¥æ•°æ®åˆ†åŒºä¸ºå•ä½ï¼Œè®¡ç®—å•è¯çš„åŠ å’Œï¼›</li>\n<li>è€Œåœ¨Reduceé˜¶æ®µï¼Œå¯¹äºåŒæ ·çš„å•è¯ï¼Œå–åŠ å’Œæœ€å¤§çš„é‚£ä¸ªæ•°å€¼ã€‚</li>\n</ul><p>æ˜¾ç„¶ï¼ŒMapé˜¶æ®µçš„è®¡ç®—é€»è¾‘æ˜¯sumï¼Œè€ŒReduceé˜¶æ®µçš„è®¡ç®—é€»è¾‘æ˜¯maxã€‚å¯¹äºè¿™æ ·çš„ä¸šåŠ¡éœ€æ±‚ï¼ŒreduceByKeyå·²æ— ç”¨æ­¦ä¹‹åœ°ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±è½®åˆ°aggregateByKeyè¿™ä¸ªç®—å­é—ªäº®ç™»åœºäº†ã€‚</p><h2>aggregateByKeyï¼šæ›´åŠ çµæ´»çš„èšåˆç®—å­</h2><p>è€è§„çŸ©ï¼Œç®—å­çš„ä»‹ç»è¿˜æ˜¯ä»ç”¨æ³•å¼€å§‹ã€‚ç›¸æ¯”å…¶ä»–ç®—å­ï¼ŒaggregateByKeyç®—å­çš„å‚æ•°æ¯”è¾ƒå¤šã€‚è¦åœ¨Paired RDDä¹‹ä¸Šè°ƒç”¨aggregateByKeyï¼Œä½ éœ€è¦æä¾›ä¸€ä¸ªåˆå§‹å€¼ï¼Œä¸€ä¸ªMapç«¯èšåˆå‡½æ•°f1ï¼Œä»¥åŠä¸€ä¸ªReduceç«¯èšåˆå‡½æ•°f2ï¼ŒaggregateByKeyçš„è°ƒç”¨å½¢å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-scala\">val rdd: RDD[(Keyç±»å‹ï¼ŒValueç±»å‹)] = _\nrdd.aggregateByKey(åˆå§‹å€¼)(f1, f2)\n</code></pre><p>åˆå§‹å€¼å¯ä»¥æ˜¯ä»»æ„æ•°å€¼æˆ–æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œèšåˆå‡½æ•°æˆ‘ä»¬ä¹Ÿä¸é™Œç”Ÿï¼Œå®ƒä»¬éƒ½æ˜¯å¸¦æœ‰ä¸¤ä¸ªå½¢å‚å’Œä¸€ä¸ªè¾“å‡ºç»“æœçš„æ™®é€šå‡½æ•°ã€‚å°±è¿™3ä¸ªå‚æ•°æ¥è¯´ï¼Œæ¯”è¾ƒä¼¤è„‘ç­‹çš„ï¼Œæ˜¯å®ƒä»¬ä¹‹é—´çš„ç±»å‹éœ€è¦ä¿æŒä¸€è‡´ï¼Œå…·ä½“æ¥è¯´ï¼š</p><ul>\n<li>åˆå§‹å€¼ç±»å‹ï¼Œå¿…é¡»ä¸f2çš„ç»“æœç±»å‹ä¿æŒä¸€è‡´ï¼›</li>\n<li>f1çš„å½¢å‚ç±»å‹ï¼Œå¿…é¡»ä¸Paired RDDçš„Valueç±»å‹ä¿æŒä¸€è‡´ï¼›</li>\n<li>f2çš„å½¢å‚ç±»å‹ï¼Œå¿…é¡»ä¸f1çš„ç»“æœç±»å‹ä¿æŒä¸€è‡´ã€‚</li>\n</ul><p>ä¸åŒç±»å‹ä¹‹é—´çš„ä¸€è‡´æ€§æè¿°èµ·æ¥æ¯”è¾ƒæ‹—å£ï¼Œå’±ä»¬ä¸å¦¨ç»“åˆç¤ºæ„å›¾æ¥åŠ æ·±ç†è§£ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/b0/f7/b0a1c86590f4213fa0fc62f5dd4ca3f7.jpg?wh=1920x568\" alt=\"å›¾ç‰‡\" title=\"aggregateByKeyå‚æ•°ä¹‹é—´çš„ç±»å‹ä¸€è‡´æ€§\"></p><p>ç†Ÿæ‚‰äº†aggregateByKeyçš„ç”¨æ³•ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨aggregateByKeyè¿™ä¸ªç®—å­æ¥å®ç°åˆšåˆšæåˆ°çš„â€œå…ˆåŠ å’Œï¼Œå†å–æœ€å¤§å€¼â€çš„è®¡ç®—é€»è¾‘ï¼Œä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-scala\">// æŠŠRDDå…ƒç´ è½¬æ¢ä¸ºï¼ˆKeyï¼ŒValueï¼‰çš„å½¢å¼\nval kvRDD: RDD[(String, Int)] = cleanWordRDD.map(word =&gt; (word, 1))\n&nbsp;\n// æ˜¾ç¤ºå®šä¹‰Mapé˜¶æ®µèšåˆå‡½æ•°f1\ndef f1(x: Int, y: Int): Int = {\nreturn x + y\n}\n&nbsp;\n// æ˜¾ç¤ºå®šä¹‰Reduceé˜¶æ®µèšåˆå‡½æ•°f2\ndef f2(x: Int, y: Int): Int = {\nreturn math.max(x, y)\n}\n&nbsp;\n// è°ƒç”¨aggregateByKeyï¼Œå®ç°å…ˆåŠ å’Œã€å†æ±‚æœ€å¤§å€¼\nval wordCounts: RDD[(String, Int)] = kvRDD.aggregateByKey(0) (f1, f2)\n</code></pre><p>æ€ä¹ˆæ ·ï¼Ÿæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿç»“åˆè®¡ç®—é€»è¾‘çš„éœ€è¦ï¼Œæˆ‘ä»¬åªéœ€è¦æå‰å®šä¹‰å¥½ä¸¤ä¸ªèšåˆå‡½æ•°ï¼ŒåŒæ—¶ä¿è¯å‚æ•°ä¹‹é—´çš„ç±»å‹ä¸€è‡´æ€§ï¼Œç„¶åæŠŠåˆå§‹å€¼ã€èšåˆå‡½æ•°ä¼ å…¥aggregateByKeyç®—å­å³å¯ã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡aggregateByKeyåœ¨è¿è¡Œæ—¶çš„è®¡ç®—è¿‡ç¨‹ï¼Œæ¥å¸®ä½ æ·±å…¥ç†è§£ç®—å­çš„å·¥ä½œåŸç†ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/62/f3/62d25ab5df4fa53da4283263bb2128f3.jpg?wh=1920x1040\" alt=\"å›¾ç‰‡\" title=\"reduceByKeyè®¡ç®—è¿‡ç¨‹\"></p><p>ä¸éš¾å‘ç°ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œä¸reduceByKeyç›¸æ¯”ï¼ŒaggregateByKeyçš„æ‰§è¡Œè¿‡ç¨‹å¹¶æ²¡æœ‰ä»€ä¹ˆä¸¤æ ·ï¼Œæœ€ä¸»è¦çš„åŒºåˆ«ï¼Œè¿˜æ˜¯Mapç«¯èšåˆä¸Reduceç«¯èšåˆçš„è®¡ç®—é€»è¾‘æ˜¯å¦ä¸€è‡´ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸reduceByKeyä¸€æ ·ï¼ŒaggregateByKeyä¹Ÿå¯ä»¥é€šè¿‡Mapç«¯çš„åˆæ­¥èšåˆæ¥å¤§å¹…å‰Šå‡æ•°æ®é‡ï¼Œåœ¨é™ä½ç£ç›˜ä¸ç½‘ç»œå¼€é”€çš„åŒæ—¶ï¼Œæå‡Shuffleç¯èŠ‚çš„æ‰§è¡Œæ€§èƒ½ã€‚</p><h2>sortByKeyï¼šæ’åº</h2><p>åœ¨è¿™ä¸€è®²çš„æœ€åï¼Œæˆ‘ä»¬å†æ¥è¯´è¯´sortByKeyè¿™ä¸ªç®—å­ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯â€œæŒ‰ç…§Keyè¿›è¡Œæ’åºâ€ã€‚ç»™å®šåŒ…å«ï¼ˆKeyï¼ŒValueï¼‰é”®å€¼å¯¹çš„Paired RDDï¼ŒsortByKeyä¼šä»¥Keyä¸ºå‡†å¯¹RDDåšæ’åºã€‚ç®—å­çš„ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œåªéœ€åœ¨RDDä¹‹ä¸Šè°ƒç”¨sortByKey()å³å¯ï¼š</p><pre><code class=\"language-scala\">val rdd: RDD[(Keyç±»å‹ï¼ŒValueç±»å‹)] = _\nrdd.sortByKey()\n</code></pre><p>åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼ŒsortByKeyæŒ‰ç…§Keyå€¼çš„å‡åºï¼ˆAscendingï¼‰å¯¹RDDè¿›è¡Œæ’åºï¼Œå¦‚æœæƒ³æŒ‰ç…§é™åºï¼ˆDescendingï¼‰æ¥æ’åºçš„è¯ï¼Œä½ éœ€è¦ç»™sortByKeyä¼ å…¥falseã€‚æ€»ç»“ä¸‹æ¥ï¼Œå…³äºæ’åºçš„è§„åˆ™ï¼Œä½ åªéœ€è¦è®°ä½å¦‚ä¸‹ä¸¤æ¡å³å¯ï¼š</p><ul>\n<li>å‡åºæ’åºï¼šè°ƒç”¨sortByKey()ã€æˆ–è€…sortByKey(true)ï¼›</li>\n<li>é™åºæ’åºï¼šè°ƒç”¨sortByKey(false)ã€‚</li>\n</ul><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä»‹ç»äº†æ•°æ®åˆ†æåœºæ™¯ä¸­å¸¸ç”¨çš„4ä¸ªç®—å­ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯groupByKeyã€reduceByKeyã€aggregateByKeyå’ŒsortByKeyï¼ŒæŒæ¡è¿™äº›ç®—å­çš„ç”¨æ³•ä¸åŸç†ï¼Œå°†ä¸ºä½ æ¸¸åˆƒæœ‰ä½™åœ°å¼€å‘æ•°æ®åˆ†æåº”ç”¨æ‰“ä¸‹åšå®åŸºç¡€ã€‚</p><p>å…³äºè¿™äº›ç®—å­ï¼Œä½ é¦–å…ˆéœ€è¦äº†è§£å®ƒä»¬ä¹‹é—´çš„å…±æ€§ã€‚<strong>ä¸€æ¥ï¼Œè¿™4ä¸ªç®—å­çš„ä½œç”¨èŒƒå›´ï¼Œéƒ½æ˜¯Paired RDDï¼›äºŒæ¥ï¼Œåœ¨è®¡ç®—çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä»¬éƒ½ä¼šå¼•å…¥Shuffle</strong>ã€‚è€ŒShuffleå¾€å¾€æ˜¯Sparkä½œä¸šæ‰§è¡Œæ•ˆç‡çš„ç“¶é¢ˆï¼Œå› æ­¤ï¼Œåœ¨ä½¿ç”¨è¿™4ä¸ªç®—å­çš„æ—¶å€™ï¼Œå¯¹äºå®ƒä»¬å¯èƒ½ä¼šå¸¦æ¥çš„æ€§èƒ½éšæ‚£ï¼Œæˆ‘ä»¬è¦åšåˆ°å¿ƒä¸­æœ‰æ•°ã€‚</p><p>å†è€…ï¼Œä½ éœ€è¦æŒæ¡æ¯ä¸€ä¸ªç®—å­çš„å…·ä½“ç”¨æ³•ä¸å·¥ä½œåŸç†ã€‚groupByKeyæ˜¯æ— å‚ç®—å­ï¼Œä½ åªéœ€åœ¨RDDä¹‹ä¸Šè°ƒç”¨groupByKey()å³å¯å®Œæˆå¯¹æ•°æ®é›†çš„åˆ†ç»„å’Œæ”¶é›†ã€‚ä½†éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œ<strong>ä»¥å…¨é‡åŸå§‹æ•°æ®è®°å½•åœ¨é›†ç¾¤èŒƒå›´å†…è¿›è¡Œè½ç›˜ä¸ç½‘ç»œåˆ†å‘ï¼Œä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½å¼€é”€ã€‚</strong>å› æ­¤ï¼Œé™¤éå¿…éœ€ï¼Œä½ åº”å½“å°½é‡é¿å…ä½¿ç”¨groupByKeyç®—å­ã€‚</p><p>åˆ©ç”¨èšåˆå‡½æ•°fï¼ŒreduceByKeyå¯ä»¥åœ¨Mapç«¯è¿›è¡Œåˆæ­¥èšåˆï¼Œå¤§å¹…å‰Šå‡éœ€è¦è½ç›˜ä¸åˆ†å‘çš„æ•°æ®é‡ï¼Œä»è€Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿæ˜¾è‘—æå‡Shuffleè®¡ç®—çš„æ‰§è¡Œæ•ˆç‡ã€‚å¯¹äºç»å¤§å¤šæ•°åˆ†ç»„&amp;èšåˆçš„è®¡ç®—éœ€æ±‚ï¼Œåªè¦èšåˆå‡½æ•°fè®¾è®¡å¾—å½“ï¼ŒreduceByKeyéƒ½èƒ½å®ç°ä¸šåŠ¡é€»è¾‘ã€‚reduceByKeyä¹Ÿæœ‰å…¶è‡ªèº«çš„å±€é™æ€§ï¼Œé‚£å°±æ˜¯å…¶Mapé˜¶æ®µä¸Reduceé˜¶æ®µçš„è®¡ç®—é€»è¾‘å¿…é¡»ä¿æŒä¸€è‡´ã€‚</p><p>å¯¹äºMapç«¯èšåˆä¸Reduceç«¯èšåˆè®¡ç®—é€»è¾‘ä¸ä¸€è‡´çš„æƒ…å†µï¼ŒaggregateByKeyå¯ä»¥å¾ˆå¥½åœ°æ»¡è¶³è¿™æ ·çš„è®¡ç®—åœºæ™¯ã€‚aggregateByKeyçš„ç”¨æ³•æ˜¯aggregateByKey(åˆå§‹å€¼)(Mapç«¯èšåˆå‡½æ•°ï¼ŒReduceç«¯èšåˆå‡½æ•°)ï¼Œå¯¹äºaggregateByKeyçš„3ä¸ªå‚æ•°ï¼Œä½ éœ€è¦ä¿è¯å®ƒä»¬ä¹‹é—´ç±»å‹çš„ä¸€è‡´æ€§ã€‚ä¸€æ—¦ç±»å‹ä¸€è‡´æ€§å¾—åˆ°æ»¡è¶³ï¼Œä½ å¯ä»¥é€šè¿‡çµæ´»åœ°å®šä¹‰ä¸¤ä¸ªèšåˆå‡½æ•°ï¼Œæ¥ç¿»ç€èŠ±æ ·åœ°è¿›è¡Œå„å¼å„æ ·çš„æ•°æ®åˆ†æã€‚</p><p>æœ€åï¼Œå¯¹äºæ’åºç±»çš„è®¡ç®—éœ€æ±‚ï¼Œä½ å¯ä»¥é€šè¿‡è°ƒç”¨sortByKeyæ¥è¿›è¡Œå®ç°ã€‚sortByKeyæ”¯æŒä¸¤ç§æ’åºæ–¹å¼ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒsortByKey()æŒ‰Keyå€¼çš„å‡åºè¿›è¡Œæ’åºï¼ŒsortByKey()ä¸sortByKey(true)çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚å¦‚æœæƒ³æŒ‰ç…§é™åºåšæ’åºï¼Œä½ åªéœ€è¦è°ƒç”¨sortByKey(false)å³å¯ã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†RDDå¸¸ç”¨ç®—å­çš„å‰ä¸¤å¤§ç±»ï¼Œä¹Ÿå°±æ˜¯æ•°æ®è½¬æ¢å’Œæ•°æ®èšåˆã€‚åœ¨æ—¥å¸¸çš„å¼€å‘å·¥ä½œä¸­ï¼Œåº”è¯¥è¯´ç»å¤§å¤šæ•°çš„ä¸šåŠ¡éœ€æ±‚ï¼Œéƒ½å¯ä»¥é€šè¿‡è¿™äº›ç®—å­æ¥å®ç°ã€‚</p><p>å› æ­¤æ­å–œä½ ï¼Œæ¯«ä¸å¤¸å¼ åœ°è¯´ï¼Œå­¦ä¹ åˆ°è¿™é‡Œï¼Œä½ çš„ä¸€åªè„šå·²ç»è·¨å…¥äº†Sparkåˆ†å¸ƒå¼åº”ç”¨å¼€å‘çš„å¤§é—¨ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬è¿˜ä¸èƒ½éª„å‚²ï¼Œâ€œå­¦ä¼šâ€å’Œâ€œå­¦å¥½â€ä¹‹é—´è¿˜æœ‰ä¸€å®šçš„è·ç¦»ï¼Œåœ¨æ¥ä¸‹æ¥çš„æ—¶é—´é‡Œï¼ŒæœŸå¾…ä½ å’Œæˆ‘ä¸€èµ·ç»§ç»­åŠ æ²¹ï¼ŒçœŸæ­£åšåˆ°åƒé€Sparkã€ç©è½¬Sparkï¼</p><h2>æ¯è¯¾ä¸€ç»ƒ</h2><p>è¿™ä¸€è®²åˆ°è¿™é‡Œå°±è¦ç»“æŸäº†ï¼Œä»Šå¤©çš„ç»ƒä¹ é¢˜æ˜¯è¿™æ ·çš„ï¼š</p><p>å­¦ä¹ è¿‡reduceByKeyå’ŒaggregateByKeyä¹‹åï¼Œä½ èƒ½è¯´è¯´å®ƒä»¬äºŒè€…ä¹‹é—´çš„è”ç³»å—ï¼Ÿä½ èƒ½ç”¨aggregateByKeyæ¥å®ç°reduceByKeyçš„åŠŸèƒ½å—ï¼Ÿ</p><p>æ¬¢è¿ä½ åˆ†äº«ä½ çš„ç­”æ¡ˆã€‚å¦‚æœè¿™ä¸€è®²å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ä¸€è®²åˆ†äº«ç»™è‡ªå·±çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·æ¥è®¨è®ºä¸€ä¸‹æœ¬è®²çš„ç»ƒä¹ é¢˜ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†è§ã€‚</p>","comments":[{"had_liked":false,"id":313781,"user_name":"Geek_2dfa9a","can_delete":false,"product_type":"c1","uid":1435535,"ip_address":"","ucode":"B5FE7971F5E773","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epGTSTvn7r4ibk1PuaUrSvvLdviaLcne50jbvvfiaxKkM5SLibeP6jibA2bCCQBqETibvIvcsOhAZlwS8kQ/132","comment_is_top":true,"comment_ctime":1632663677,"is_pvip":false,"replies":[{"id":"113647","content":"å®Œç¾ï¼Œæ»¡åˆ†ğŸ’¯ï¼ç½®é¡¶ğŸ”<br><br>æ•°ç»„çš„hashcodeï¼Œå…¶å®å°±æ˜¯å®ƒçš„å†…å­˜åœ°å€ï¼Œå°±åƒä½ è¯´çš„ï¼Œè·Ÿå†…å®¹æ— å…³ã€‚å› æ­¤ï¼Œå®ƒæ²¡æœ‰åŠæ³•åˆ©ç”¨hashPartitionerå®Œæˆåˆ†å‘ï¼Œæ‰€ä»¥è¯´ï¼Œkeyæ˜¯æ•°ç»„çš„rddï¼Œåº”ç”¨èŒƒå›´éå¸¸æœ‰é™ã€‚<br><br>é™¤äº†hashPartitionerï¼ŒSparkè¿˜æ”¯æŒrangePartitionerï¼Œè¿™ç§åˆ†åŒºå™¨ï¼Œä¸éœ€è¦hashcodeï¼Œåªè¦å®ç°äº†comparatorï¼ˆèƒ½æ¯”è¾ƒï¼‰å°±è¡Œã€‚æ‰€ä»¥å³ä¾¿éè¦ç”¨hashcodeæ¥æ’åºï¼Œä¹Ÿokã€‚è¿™ä¸ªæ—¶å€™ï¼Œå†…å®¹æ˜¯å¦ä¸€æ ·ï¼Œå·²ç»ä¸é‡è¦äº†ã€‚<br><br>reduceé˜¶æ®µéœ€è¦èšåˆçš„åœºæ™¯ï¼Œä¸€å®šæ˜¯éœ€è¦hashPartitionerçš„ï¼Œç”±äºæ•°ç»„ä¸æ”¯æŒhashPartitionerï¼Œå®ƒä¹Ÿå°±èµ°ä¸åˆ°reduceé‚£ä¸€æ­¥ï¼Œæ²¡æœ‰è¿™æ ·çš„code pathï½<br>","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1632745166,"ip_address":"","comment_id":313781,"utype":1}],"discussion_count":2,"race_medal":0,"score":"9.2233721072068997e+18","product_id":100090001,"comment_content":"æœ€è¿‘å…¬å¸åœ¨æé»‘å®¢é©¬æ‹‰æ¾ï¼Œæˆ‘å¿™äºåšä¸€ä¸ªæ•°ä»“è¡€ç¼˜å›¾è®¡ç®—çš„é¡¹ç›®æ¥æ™šå•¦ã€‚<br>reduceByKeyå’ŒaggregateByKeyåº•å±‚ä½¿ç”¨äº†åŒä¸€ä¸ªæ–¹æ³•å®ç°ï¼šcombineByKeyWithClassTagï¼Œè¯¥æ–¹æ³•æ˜¯å°†KVå‹çš„RDD[(K, V)]è½¬æ¢ä¸ºRDD[(K, C)]ï¼Œ<br>ç±»ä¼¼äºåˆ†ç»„èšåˆï¼Œæ—¢ç„¶è¦æ‰¾åˆ°reduceByKeyå’ŒaggregateByKeyçš„è”ç³»é‚£è‚¯å®šè¦ä»ä¸‹è‡³ä¸Šç”±å…±æ€§å¼€å§‹åˆ†æï¼ŒcombineByKeyWithClassTagæ–¹æ³•å£°æ˜å¦‚ä¸‹ï¼š<br>  def combineByKeyWithClassTag[C](<br>      createCombiner: V =&gt; C,<br>      mergeValue: (C, V) =&gt; C,<br>      mergeCombiners: (C, C) =&gt; C,<br>      partitioner: Partitioner,<br>      mapSideCombine: Boolean = true,<br>      serializer: Serializer = null)(implicit ct: ClassTag[C]): RDD[(K, C)] = self.withScope {<br>  }<br>å­—æ•°é™åˆ¶äº†ï¼Œæˆ‘æŠŠæ–¹æ³•å®ç°æ”¾åœ¨ä¸‹é¢è¯„è®ºã€‚<br>é¦–å…ˆè®²ä¸‰ä¸ªé«˜é˜¶å‡½æ•°å…¥å‚ï¼šcreateCombinerï¼ŒmergeValueï¼ŒmergeCombinersæ•°ï¼Œåœ¨æ–¹æ³•é‡Œç»„æˆäº†Aggregatorå¯¹è±¡ï¼ŒAggregator<br>å…¶å®å°±æ˜¯sparkå¯¹åˆ†ç»„èšåˆï¼ˆShuffleï¼‰æ“ä½œçš„æŠ½è±¡ï¼Œå¦‚æœä¸æ¸…æ¥šsparkåˆ†ç»„èšåˆçš„è¿‡ç¨‹è¿™ä¸‰ä¸ªé«˜é˜¶å‡½æ•°ä¸å¥½ç†è§£ï¼Œç®€å•ç‚¹è®²ï¼ŒRDDæŒ‰ç…§Keyåˆ†ç»„åå› ä¸º<br>ä¸åŒPartitioné‡Œä¼šæœ‰ç›¸åŒKeyï¼Œå› æ­¤å¯¹äºKey=k1è¿™ä¸ªå¤§ç»„ä¼šæœ‰å¤šä¸ªå°ç»„ï¼ˆk11,k12...k1nï¼‰,é¦–å…ˆcreateCombinerä¼šç»™k11,k12...k1nï¼‰<br>æ¯ä¸ªå°ç»„èµ‹ä¸€ä¸ªåˆå§‹å€¼C0ï¼Œç„¶åmergeValueæŠŠå°ç»„å†…çš„æ¯ä¸ªè®°å½•å åŠ ç»™åˆå§‹å€¼å¾—åˆ°ä¸€ä¸ªå°ç»„å€¼C00ï¼ˆå…¶å®å°±æ˜¯mapç«¯èšåˆï¼‰ï¼Œæœ€åå†æŠŠæ‰€æœ‰å°ç»„çš„<br>å°ç»„å€¼åˆå¹¶æˆä¸€ä¸ªKVå‹RDDï¼ˆæ³¨æ„è¿™é‡ŒVå·²ç»å˜æˆäº†Cç±»å‹ï¼‰ã€‚<br>å†è®²å‚æ•°partitionerï¼Œäº†è§£RDDçš„è¯åº”è¯¥æ¸…æ¥šï¼Œå°±æ˜¯è¿™ä¸ªRDDçš„åˆ†åŒºè§„åˆ™ï¼Œè¿™é‡Œçš„å…¥å‚å°±æ˜¯èšåˆåRDDçš„åˆ†åŒºè§„åˆ™ï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œé‚£Shuffleå°±å®Œå…¨ä¸éœ€è¦äº†ï¼Œ<br>ç›´æ¥taskæœ¬åœ°èšåˆä¸€ä¸‹å°±å¥½äº†ï¼Œæºç é‡Œä¹Ÿå°±ç›´æ¥mapPartitionså°±ç»“æŸäº†ï¼Œå¦‚æœèšåˆå‰ååˆ†åŒºè§„åˆ™ä¸ç›¸åŒçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›ä¸€ä¸ªShuffledRDDã€‚<br>æœ€åè®²ä¸‹å‚æ•°mapSideCombineå’Œserializerï¼ŒmapSideCombineå°±æ˜¯æ˜¯å¦åœ¨mapç«¯èšåˆï¼Œæ–¹æ³•å¼€å¤´çš„æ ¡éªŒå¯ä»¥çœ‹åˆ°keyClassæ˜¯æ•°ç»„æ—¶ä¸æ”¯æŒ<br>mapç«¯èšåˆå’Œå“ˆå¸Œåˆ†åŒºï¼Œè¿™é‡Œæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸å¤ªç†Ÿæ‚‰scalaçš„æˆ‘æŸ¥äº†ä¸‹stackoverflowï¼ŒåŸæ¥scalaé‡Œçš„æ•°ç»„å’ŒJavaçš„ä¸€æ ·ï¼Œhashcodeåªæ˜¯æ•°ç»„å¯¹è±¡æœ¬èº«çš„<br>hashcodeï¼Œå’Œå†…å®¹æ²¡å…³ç³»ï¼Œé‚£è‡ªç„¶æ²¡åŠæ³•mapç«¯èšåˆäº†ï¼Œ<br>è¿™é‡Œè¯·é—®è€å¸ˆï¼Œé‚£æ•°ç»„ä½œä¸ºKVRDDçš„æ—¶å€™ï¼Œreduceç«¯çš„èšåˆæ˜¯æ€ä¹ˆå®Œæˆåˆ¤ç­‰çš„å‘¢ï¼Ÿ<br>serializeræ˜¯æŒ‡å‡ºæ•°æ®å¦‚ä½•åºåˆ—åŒ–çš„ï¼Œåºåˆ—åŒ–å°±å…ˆä¸è¯´äº†ï¼Œä¸ç„¶åˆè¦è®²å¥½å¤šã€‚<br><br>æœ€åæ€»ç»“ä¸‹ï¼ŒreduceByKeyå’ŒaggregateByKeyåº•å±‚å®ç°å®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯combineByKeyWithClassTagï¼Œåªä¸è¿‡reduceByKeyè°ƒç”¨<br>combineByKeyWithClassTagçš„å…¥å‚mergeValueå’ŒmergeCombinersæ˜¯ç›¸ç­‰çš„ï¼ŒaggregateByKeyæ˜¯ç”¨æˆ·æŒ‡å®šå¯ä»¥ä¸ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´<br>reduceByKeyæ˜¯ä¸€ç§ç‰¹æ®Šçš„aggregateByKeyã€‚","like_count":17,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527467,"discussion_content":"å®Œç¾ï¼Œæ»¡åˆ†ğŸ’¯ï¼ç½®é¡¶ğŸ”\n\næ•°ç»„çš„hashcodeï¼Œå…¶å®å°±æ˜¯å®ƒçš„å†…å­˜åœ°å€ï¼Œå°±åƒä½ è¯´çš„ï¼Œè·Ÿå†…å®¹æ— å…³ã€‚å› æ­¤ï¼Œå®ƒæ²¡æœ‰åŠæ³•åˆ©ç”¨hashPartitionerå®Œæˆåˆ†å‘ï¼Œæ‰€ä»¥è¯´ï¼Œkeyæ˜¯æ•°ç»„çš„rddï¼Œåº”ç”¨èŒƒå›´éå¸¸æœ‰é™ã€‚\n\né™¤äº†hashPartitionerï¼ŒSparkè¿˜æ”¯æŒrangePartitionerï¼Œè¿™ç§åˆ†åŒºå™¨ï¼Œä¸éœ€è¦hashcodeï¼Œåªè¦å®ç°äº†comparatorï¼ˆèƒ½æ¯”è¾ƒï¼‰å°±è¡Œã€‚æ‰€ä»¥å³ä¾¿éè¦ç”¨hashcodeæ¥æ’åºï¼Œä¹Ÿokã€‚è¿™ä¸ªæ—¶å€™ï¼Œå†…å®¹æ˜¯å¦ä¸€æ ·ï¼Œå·²ç»ä¸é‡è¦äº†ã€‚\n\nreduceé˜¶æ®µéœ€è¦èšåˆçš„åœºæ™¯ï¼Œä¸€å®šæ˜¯éœ€è¦hashPartitionerçš„ï¼Œç”±äºæ•°ç»„ä¸æ”¯æŒhashPartitionerï¼Œå®ƒä¹Ÿå°±èµ°ä¸åˆ°reduceé‚£ä¸€æ­¥ï¼Œæ²¡æœ‰è¿™æ ·çš„code pathï½\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632745166,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1435535,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epGTSTvn7r4ibk1PuaUrSvvLdviaLcne50jbvvfiaxKkM5SLibeP6jibA2bCCQBqETibvIvcsOhAZlwS8kQ/132","nickname":"Geek_2dfa9a","note":"","ucode":"B5FE7971F5E773","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397748,"discussion_content":"combineByKeyWithClassTagæ–¹æ³•å®Œæ•´å®ç°\ndef combineByKeyWithClassTag[C](\n      createCombiner: V => C,\n      mergeValue: (C, V) => C,\n      mergeCombiners: (C, C) => C,\n      partitioner: Partitioner,\n      mapSideCombine: Boolean = true,\n      serializer: Serializer = null)(implicit ct: ClassTag[C]): RDD[(K, C)] = self.withScope {\n    require(mergeCombiners != null, &#34;mergeCombiners must be defined&#34;) // required as of Spark 0.9.0\n    if (keyClass.isArray) {\n      if (mapSideCombine) {\n        throw new SparkException(&#34;Cannot use map-side combining with array keys.&#34;)\n      }\n      if (partitioner.isInstanceOf[HashPartitioner]) {\n        throw new SparkException(&#34;HashPartitioner cannot partition array keys.&#34;)\n      }\n    }\n    val aggregator = new Aggregator[K, V, C](\n      self.context.clean(createCombiner),\n      self.context.clean(mergeValue),\n      self.context.clean(mergeCombiners))\n    if (self.partitioner == Some(partitioner)) {\n      self.mapPartitions(iter => {\n        val context = TaskContext.get()\n        new InterruptibleIterator(context, aggregator.combineValuesByKey(iter, context))\n      }, preservesPartitioning = true)\n    } else {\n      new ShuffledRDD[K, V, C](self, partitioner)\n        .setSerializer(serializer)\n        .setAggregator(aggregator)\n        .setMapSideCombine(mapSideCombine)\n    }\n  }","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632666382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339766,"user_name":"Spoon","can_delete":false,"product_type":"c1","uid":1959822,"ip_address":"","ucode":"2FF9193AD482C2","user_header":"https://static001.geekbang.org/account/avatar/00/1d/e7/8e/318cfde0.jpg","comment_is_top":false,"comment_ctime":1648370201,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5943337497","product_id":100090001,"comment_content":"Javaå®ç°ä»£ç <br>https:&#47;&#47;github.com&#47;Spoon94&#47;spark-practice&#47;blob&#47;master&#47;src&#47;main&#47;java&#47;com&#47;spoon&#47;spark&#47;core&#47;AggOpJob.java","like_count":0},{"had_liked":false,"id":353857,"user_name":"J","can_delete":false,"product_type":"c1","uid":1002675,"ip_address":"æ¹–åŒ—","ucode":"EC6B45BD3E128D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/b3/931dcd9e.jpg","comment_is_top":false,"comment_ctime":1659868015,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1659868015","product_id":100090001,"comment_content":"è®²è§£aggregateByKeyè®¡ç®—è¿‡ç¨‹æ—¶ï¼Œå›¾ä¾‹é”™å†™æˆäº†â€œreduceByKeyè®¡ç®—è¿‡ç¨‹â€","like_count":0},{"had_liked":false,"id":343724,"user_name":"ç¿æ™","can_delete":false,"product_type":"c1","uid":2970268,"ip_address":"","ucode":"25AA3449AFB630","user_header":"https://static001.geekbang.org/account/avatar/00/2d/52/9c/8a60675c.jpg","comment_is_top":false,"comment_ctime":1651023484,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651023484","product_id":100090001,"comment_content":"aggregateByKeyç®—å­ä¸­ç¬¬ä¸€ä¸ªé»˜è®¤å‚æ•°çš„ä½¿ç”¨æ–¹æ³•æ˜¯ä»€ä¹ˆå•Šï¼Ÿæ˜¯ç›´æ¥å‚ä¸åˆ°ç¬¬äºŒä¸ªèšåˆå‡½æ•°ï¼ˆreduceç«¯ï¼‰é‡Œé¢è¿ç®—å—ï¼Ÿæ¯”å¦‚ï¼Œé»˜è®¤å‚æ•°æ˜¯0ï¼Œç„¶åå¦‚æœç¬¬äºŒä¸ªèšåˆå‡½æ•°æ˜¯maxæ±‚æœ€å¤§å€¼ï¼Œåˆå§‹é»˜è®¤å‚æ•°æ˜¯å‚ä¸æ¯”è¾ƒçš„ï¼Œç”¨0å’Œæ¯ä¸ªå­—æ®µä¸­çš„å€¼æ¯”è¾ƒï¼Œæ˜¯è¿™ä¸ªæ„æ€å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":330226,"user_name":"Geek_2a0deb","can_delete":false,"product_type":"c1","uid":1315176,"ip_address":"","ucode":"DBF960FDFB77C0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKIkpsQkTyLtfxgib35o0ho9nWmCHwJL8BYibJPPT22fkT1aTwHhwQc0krINWjTVRjibF1bMTgia5mflg/132","comment_is_top":false,"comment_ctime":1641872072,"is_pvip":false,"replies":[{"id":"120669","content":"æ²¡é”™ï¼Œæ»¡åˆ†~ ğŸ’¯","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1642244228,"ip_address":"","comment_id":330226,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641872072","product_id":100090001,"comment_content":"reduceByKey å’Œ aggregateByKeyçš„åŒºåˆ«åœ¨äºreduceByKeyåœ¨mapç«¯å’Œreduceæ—¶çš„èšåˆå‡½æ•°ä¸€è‡´ï¼Œè€ŒaggregateByKeyåœ¨mapç«¯å’Œreduceç«¯èšåˆå‡½æ•°å¯ä»¥ä¸ä¸€è‡´ï¼Œè”ç³»å°±æ˜¯reduceByKeyå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§ç‰¹æ®Šçš„aggregateByKeyï¼ˆmapå’Œreduceæ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼‰å¦‚æœç”¨ç®—å­æ¥æè¿°:reduceByKey(f)=aggregateByKey(åˆå§‹å€¼) (f,f)","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546233,"discussion_content":"æ²¡é”™ï¼Œæ»¡åˆ†~ ğŸ’¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642244228,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":327507,"user_name":"Botanic","can_delete":false,"product_type":"c1","uid":1543891,"ip_address":"","ucode":"AA8C028A6C08DC","user_header":"https://static001.geekbang.org/account/avatar/00/17/8e/d3/1a3bb2cc.jpg","comment_is_top":false,"comment_ctime":1640156383,"is_pvip":false,"replies":[{"id":"119389","content":"æ»¡åˆ†ï¼ŒğŸ’¯ï¼ŒèµğŸ‘~","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1043100","ctime":1640355589,"ip_address":"","comment_id":327507,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1640156383","product_id":100090001,"comment_content":"```<br># ä½¿ç”¨ aggregateByKey æ¥å®ç° reduceByKey<br>def f1(x, y):<br>    # æ˜¾ç¤ºå®šä¹‰Mapé˜¶æ®µèšåˆå‡½æ•°f1ï¼Œæ±‚åŠ å’Œ<br>    return x+y<br><br>import random<br># å®éªŒ3ï¼šaggregateByKey ä½¿ç”¨è¯´æ˜<br>textFile = SparkContext().textFile(&quot;..&#47;wikiOfSpark.txt&quot;)<br>wordCount = (<br>            textFile.flatMap(lambda line: line.split(&quot; &quot;))<br>                .filter(lambda word: word != &quot;&quot;)<br>                    .map(lambda word: (word, 1))<br>                        .aggregateByKey(0, f1, f1)<br>                            .sortBy(lambda x: x[1], False)<br>                                .take(5))<br>print(wordCount)<br>```","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":541398,"discussion_content":"æ»¡åˆ†ï¼ŒğŸ’¯ï¼ŒèµğŸ‘~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640355589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321428,"user_name":"pythonbug","can_delete":false,"product_type":"c1","uid":1487274,"ip_address":"","ucode":"1A70CA92FFF8EB","user_header":"https://wx.qlogo.cn/mmopen/vi_32/wgMMrp1hvSB3E30KqZvMsj3KQdAI3T1uQM77LT7hZ65nVSjPGRg3AbUOyiahnssA6AIT5PAkyHFmlTBzUH9gdyQ/132","comment_is_top":false,"comment_ctime":1636873094,"is_pvip":true,"replies":[{"id":"116848","content":"æ²¡ä»€ä¹ˆå…³ç³»å“ˆï¼ŒaggregateByKeyå¯ä»¥ç†è§£æˆæ˜¯reduceByKeyçš„â€œå‡çº§ç‰ˆâ€ï¼ŒåŠŸèƒ½æ›´çµæ´»ï¼Œèƒ½å¤Ÿåº”å¯¹çš„è®¡ç®—åœºæ™¯æ›´å¤š~<br><br>å®é™…ä¸Šï¼ŒreduceByKeyå®Œå…¨å¯ä»¥ç”¨aggregateByKeyæ¥å®ç°~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1637059251,"ip_address":"","comment_id":321428,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636873094","product_id":100090001,"comment_content":"æˆ‘æ„Ÿè§‰aggregateByKeyç›´æ¥ä½œç”¨åœ¨åˆšåˆšè¯»å–æ•°æ®çš„RDDä¸Šçš„æƒ…å†µå¾ˆå°‘ï¼Œå› ä¸ºåˆšåˆšä»æ•°æ®æºè¯»å–å‡ºæ¥çš„æ•°æ®åˆ†åŒºå¤§å¤šæ•°æ—¶å€™æ˜¯æ²¡å•¥ä¸šåŠ¡å«ä¹‰çš„ï¼Œæ‰€ä»¥Mapé˜¶æ®µçš„èšåˆä¹Ÿæ²¡æœ‰å¤ªå¤§æ„ä¹‰ã€‚æ‰€ä»¥çŒœæµ‹ï¼ŒaggregateByKeyå¯èƒ½å¤§å¤šæ•°æƒ…å†µæ˜¯è·Ÿåœ¨reduceByKeyä¹‹åï¼Œé‚£ä¸ªæ—¶å€™å·²ç»å¯¹æ•°æ®æŒ‰ç…§ä¸šåŠ¡åˆ†åŒºå¥½äº†ã€‚é‚£ä¸ªæ—¶å€™Mapé˜¶æ®µçš„èšåˆæ‰æœ‰ä¸€äº›æ„ä¹‰ï¼Œä¸çŸ¥é“çŒœçš„å¯¹ä¸å¯¹","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530362,"discussion_content":"æ²¡ä»€ä¹ˆå…³ç³»å“ˆï¼ŒaggregateByKeyå¯ä»¥ç†è§£æˆæ˜¯reduceByKeyçš„â€œå‡çº§ç‰ˆâ€ï¼ŒåŠŸèƒ½æ›´çµæ´»ï¼Œèƒ½å¤Ÿåº”å¯¹çš„è®¡ç®—åœºæ™¯æ›´å¤š~\n\nå®é™…ä¸Šï¼ŒreduceByKeyå®Œå…¨å¯ä»¥ç”¨aggregateByKeyæ¥å®ç°~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637059251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314941,"user_name":"åå¹´","can_delete":false,"product_type":"c1","uid":1115805,"ip_address":"","ucode":"A246C22CD6E5F2","user_header":"https://static001.geekbang.org/account/avatar/00/11/06/9d/3c121a1c.jpg","comment_is_top":false,"comment_ctime":1633600200,"is_pvip":false,"replies":[{"id":"114045","content":"æ•°å€¼çš„è¯ï¼Œå¯ä»¥æŒ‡å®šéé›¶åˆå§‹å€¼ï¼Œå­—ç¬¦ä¸²çš„è¯ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å‰ç¼€å­—ç¬¦ä¸²~ ä¸»è¦çœ‹ä¸šåŠ¡éœ€è¦äº†","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1633601547,"ip_address":"","comment_id":314941,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1633600200","product_id":100090001,"comment_content":"è¯·é—®è€å¸ˆï¼ŒaggregateByKeyçš„åˆå§‹å€¼æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527836,"discussion_content":"æ•°å€¼çš„è¯ï¼Œå¯ä»¥æŒ‡å®šéé›¶åˆå§‹å€¼ï¼Œå­—ç¬¦ä¸²çš„è¯ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å‰ç¼€å­—ç¬¦ä¸²~ ä¸»è¦çœ‹ä¸šåŠ¡éœ€è¦äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1633601547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2086573,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/d6/ad/850992a5.jpg","nickname":"William","note":"","ucode":"EC29D9CD616183","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":414496,"discussion_content":"ä¼¼ä¹æ˜¯ä¸ºäº†ç”³æ˜è¾“å‡ºç±»å‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636790797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313997,"user_name":"é’±é¹ Allen","can_delete":false,"product_type":"c1","uid":2518863,"ip_address":"","ucode":"7E95E82C0717DA","user_header":"https://static001.geekbang.org/account/avatar/00/26/6f/4f/3cf1e9c4.jpg","comment_is_top":false,"comment_ctime":1632794962,"is_pvip":true,"replies":[{"id":"113782","content":"å¯¹çš„ï½","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1632878479,"ip_address":"","comment_id":313997,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1632794962","product_id":100090001,"comment_content":"reduceByKey å’Œ aggregateByKeyçš„è”ç³»ï¼šå°†ç›¸åŒçš„keyå€¼è¿›è¡Œèšåˆã€‚ä¸åŒç‚¹ï¼šreduceByKey()é‡‡ç”¨çš„æ˜¯ç›¸åŒçš„funcï¼Œåœ¨mapé˜¶æ®µä½¿ç”¨sumæ“ä½œï¼Œreduceé˜¶æ®µé‡‡ç”¨maxæ“ä½œå°±ä¸æ»¡è¶³ã€‚<br>aggregateByKeyå¯ä»¥çœ‹åšæ˜¯æ›´ä¸€èˆ¬çš„reduceByKeyï¼Œ<br>","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527541,"discussion_content":"å¯¹çš„ï½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632878479,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}