{"id":159454,"title":"27 | 源码剖析：断开连接","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":204874,"user_name":"delete is create","can_delete":false,"product_type":"c3","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1586485490,"is_pvip":false,"replies":[{"id":79677,"content":"所以你要引入idle检测，发现这些因为断网断电而无效的连接，从而主动断开（channelHandlerContext.close()）,这个时候就会触发相应的方法了。如果没有引入，就不仅是统一不准的问题了，还等于说存在资源泄漏了（“僵尸”连接）。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1588977400,"ip_address":"","comment_id":204874,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"如何获取当前所有连接，或者如何统计当前连接数呢？直接在注册和断开时加一减一不准，  因为客户端断网断电后  这些方法不会被触发","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491314,"discussion_content":"所以你要引入idle检测，发现这些因为断网断电而无效的连接，从而主动断开（channelHandlerContext.close()）,这个时候就会触发相应的方法了。如果没有引入，就不仅是统一不准的问题了，还等于说存在资源泄漏了（“僵尸”连接）。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588977400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136188,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/3c/e345522b.jpg","nickname":"xxwy","note":"","ucode":"BA2476EAF31F0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":241820,"discussion_content":"DefaultChannelGroup","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587442531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209025,"user_name":"武文文武","can_delete":false,"product_type":"c3","uid":1108924,"ip_address":"","ucode":"5288366646A15B","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/bc/6ccac4bb.jpg","comment_is_top":false,"comment_ctime":1587481269,"is_pvip":false,"replies":[{"id":78817,"content":"回复在您第二个提的问题上了。这里不再赘述了。请查看，有问题再沟通，谢谢。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1588055296,"ip_address":"","comment_id":209025,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师您好，有个问题请教一下，我们用netty做服务端，前端访问服务端是从一个连接池中拿连接，然后访问netty服务端，但是现在生产运维提出让我实现优雅关闭，也就是在服务端升级的时候要让客户端无感知，但是由于连接是基于tcp的长连接，就算用gracefulShutdown也保证不了客户端无感知，您有什么好的建议来实现这种长连接的优雅关闭吗？感谢老师的指教","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492704,"discussion_content":"回复在您第二个提的问题上了。这里不再赘述了。请查看，有问题再沟通，谢谢。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588055296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258566,"user_name":"冬渐暖","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1604484413,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"关闭之前流程为：\n1.多路复用器(Selector) 接收到OP_ READ事件:\n2.处理OP_ READ事件: NioSocketChannel.NioSocketChannelUnsafe.read()\n调用NioSocketChannelUnsafe，这个类里面有个重载方法prepareToClose(),官方介绍为“We need to cancel this key of the channel so we may not end up in a eventloop spin， because we try to read or write until the actual close happens which may be later due， SO_LINGER handling.” 意思大概就是我先去试下读或者写，看看你是不是骗我的，失败了才是真正的关闭\n优雅的关闭动作：\nunbind netty创建的所有channel。channel.unbind()\nclose netty创建的所有channel。channel.close()\nshutdown netty的线程执行器。factory.releaseExternalResources()\n本质是\n1.先关channel (包含cancel多路复用器的key)\n2.清理消息：新消息全部不给进，队列里的消息也全部清掉\n3.触发fireChannellnactive和fireChannelUnregistered\n\n\nclose方法中，客户端发出正常的挥手请求，执行pipeline里面的inactive和unregister方法，即停止运行和取消注册。当然也有做优化--》即关闭连接到一定数量(阀值)的时候，后面的链接可能也相应的关掉了，所以就重新检查下所有的连接有没有关闭，可以减少关闭那些已经被关闭的连接所用的时间\n\n而异常关闭，客户端来不及发出挥手请求，发出的是RST复位请求，服务端在刚才说的unsafe.read方法中doReadBytes(byteBuf)这句直接抛出I&#47;O异常，被捕捉后进入handleReadException方法，在方法中有fireExceptionCaught调用pipeline的exceptionCaught方法，而fireExceptionCaught下面还有之前说的closeOnRead，执行pipeline里面的inactive和unregister方法。\n\n和read write一样，关闭的本质还是调用了jdk的java.nio.channels.spi.AbstractInterruptibleChannel\n的close方法，看清了，不是sun.nio.ch.SocketChannelImpl\n","like_count":3},{"had_liked":false,"id":242608,"user_name":"叶峥瑶","can_delete":false,"product_type":"c3","uid":1797584,"ip_address":"","ucode":"170E0F29BC6D4D","user_header":"","comment_is_top":false,"comment_ctime":1597796966,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"如果第三章讲解这些流程的时候，能顺便带上第二章中讲解的一些特性就更好了，第三章跟第二章太割裂了；请问下老师，netty的bytebuf支持堆外内存和堆内内存，那什么场景需要用堆内&#47;堆外？","like_count":1},{"had_liked":false,"id":233204,"user_name":"delete is create","can_delete":false,"product_type":"c3","uid":1147979,"ip_address":"","ucode":"A8C751219A7746","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg","comment_is_top":false,"comment_ctime":1594260279,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师 netty集群搭建 怎么做？  用什么做负载均衡？ 用什么管理channel？","like_count":1,"discussions":[{"author":{"id":1370304,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLNgTWpN9vEUMZ77xTkiaPibX8E22c2L5GTmkgyP4cajbNiap5zEp28HicvA8eOCQqYo7YDsAhuafict2Q/132","nickname":"Geek_lbv7gj","note":"","ucode":"0CD6F332407936","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532753,"discussion_content":"同问？有方案了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637677957,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241011,"user_name":"星期八","can_delete":false,"product_type":"c3","uid":1185504,"ip_address":"","ucode":"34A37F73A48E7F","user_header":"https://static001.geekbang.org/account/avatar/00/12/16/e0/7abad3cc.jpg","comment_is_top":false,"comment_ctime":1597149479,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"如果是kill -9关闭程序还会触发异常关闭得过程吗？\n如果不触发，会不会出现客户端过一点时间才会自动断掉呢？","like_count":0},{"had_liked":false,"id":174749,"user_name":"💢 星星💢","can_delete":false,"product_type":"c3","uid":1254392,"ip_address":"","ucode":"A402B765222C35","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/f8/24fcccea.jpg","comment_is_top":false,"comment_ctime":1580370360,"is_pvip":false,"replies":null,"discussion_count":2,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，你最后的代码走到 pipeline.fireChannelInactive()，pipeline.fireChannelUnregistered()  这二个事件是干啥的？","like_count":0,"discussions":[{"author":{"id":1560646,"avatar":"https://static001.geekbang.org/account/avatar/00/17/d0/46/2a4fec72.jpg","nickname":"走走～ 停停","note":"","ucode":"083B0027B2DEE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292477,"discussion_content":"老师, 公司项目是物联网相关,客户端在海外使用无线网卡连接服务器, 服务端返回连接成功, 客户端之后会每隔12秒发送一次心跳; 当客户端因为网络原因断开, 等网络恢复正常, 客户端在重连服务器, 服务端返回连接成功, 但是服务端马上进入channel  inactive 断开连接,  业务处理就是移除连接. 然后就陷入客户端重连成功,马上断开的死循环.  我做了以下验证:\n1.已经排除网络原因(ip地址也没有发生切换,网络稳定), \n2.抓包发现客户端先发送FIN(分析了几个). \n3.重启服务器该设备依然重复去连接, \n4.重启客户端后连接就正常了.  \n\n处理方式: 统计一定时间登录次数, 发送重启客户端指令, 重启后连接正常.\n\n我怀疑是客户端代码有问题(硬件工程师那边并不认可), 但是这个问题只在线上出现, 是个概率问题, 又没有好的办法去复现. 因为netty并不熟悉, 请问老师这种情况该如何系统排查,并且定性","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595239551,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"密码123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":167409,"discussion_content":"我觉得可能是对流程节点的扩展，在实现的例子里面继承了类ChannelInboundHandlerAdapter 。里面有对这2个方法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581490500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}