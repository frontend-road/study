{"id":67681,"title":"131 |【实验】Java 应用埋点和监控实验","content":"无","comments":[{"had_liked":false,"id":103318,"user_name":"又双叒叕是一年啊","can_delete":false,"product_type":"c3","uid":1000015,"ip_address":"","ucode":"E067320E537DEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/4f/ff1ac464.jpg","comment_is_top":false,"comment_ctime":1560413694,"is_pvip":false,"replies":[{"id":37704,"content":"CAT主要是调用链监控，主要看服务之间依赖关系，它也统计服务接口性能，也就是说它也带一部分metrcs功能。Prometheus主要是Metrics监控，可以对各种指标(计数，延迟，大小，错误等）埋点监控，它同时可以工作在系统&#47;应用&#47;业务甚至端用户体验层，可以说Prometheus的应用范围更广泛。两者的功能有部分重叠，实际应用中两个侧重点不同，CAT侧重trace链，Prometheus侧重metrcs点，可以互为补充。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1560679214,"ip_address":"","comment_id":103318,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，看完这节课我有个疑问，应用级监控埋点 是应该用CAT还是应用用prometheus client自定义埋点监控，使用 prometheus client做埋点监控是了在 grafana中可视化展示？ 这两种埋点有啥区别?","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453829,"discussion_content":"CAT主要是调用链监控，主要看服务之间依赖关系，它也统计服务接口性能，也就是说它也带一部分metrcs功能。Prometheus主要是Metrics监控，可以对各种指标(计数，延迟，大小，错误等）埋点监控，它同时可以工作在系统/应用/业务甚至端用户体验层，可以说Prometheus的应用范围更广泛。两者的功能有部分重叠，实际应用中两个侧重点不同，CAT侧重trace链，Prometheus侧重metrcs点，可以互为补充。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560679214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205001,"user_name":"J.Smile","can_delete":false,"product_type":"c3","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg","comment_is_top":false,"comment_ctime":1586505701,"is_pvip":false,"replies":[{"id":76639,"content":"生产实践中可以用Micrometer+Promethues来实现接口请求记数，一般用Counter，在dashboard展示时一般转为请求率，单位按分钟或小时或天聚合展示，可以看接口调用趋势。\n\n除了metrics埋点，我之前经历的企业大都采用CAT埋点，CAT也统计接口调用性能情况(qps，平均延迟，95&#47;99线等)，对实际排查问题和性能调优很有帮助。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1586524214,"ip_address":"","comment_id":205001,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，生产实践中是否会用Micrometer+自定义metrics，来统计每个接口自身的请求总数呢？网上资料大多数是系统中定义一个Counter或者其他metrics去对系统总请求计数。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491349,"discussion_content":"生产实践中可以用Micrometer+Promethues来实现接口请求记数，一般用Counter，在dashboard展示时一般转为请求率，单位按分钟或小时或天聚合展示，可以看接口调用趋势。\n\n除了metrics埋点，我之前经历的企业大都采用CAT埋点，CAT也统计接口调用性能情况(qps，平均延迟，95/99线等)，对实际排查问题和性能调优很有帮助。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586524214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204644,"user_name":"J.Smile","can_delete":false,"product_type":"c3","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg","comment_is_top":false,"comment_ctime":1586434760,"is_pvip":false,"replies":[{"id":76645,"content":"你先用spring boot的actuator的metrics端点校验下，看看metrics的名称&#47;tags是否正确，再到promethues里头去查询。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1586524386,"ip_address":"","comment_id":204644,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":" static final Counter requests = Counter.build()\n            .name(&quot;requests_total&quot;).help(&quot;Boot Total requests.&quot;).register();\n-------------------------------------------------------------------------------\n添加了以上配置，代码中也requests.inc();了，但是prometheus的查询框中输入：requests_total{job=&quot;mongoboot&quot;}竟然没有No datapoints found.真的好奇怪mongoboot就是我的job名称啊！","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491239,"discussion_content":"你先用spring boot的actuator的metrics端点校验下，看看metrics的名称/tags是否正确，再到promethues里头去查询。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586524386,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204597,"user_name":"J.Smile","can_delete":false,"product_type":"c3","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg","comment_is_top":false,"comment_ctime":1586426504,"is_pvip":false,"replies":[{"id":76636,"content":"这个可能和spring boot配置有关，你尝试用stackoverflow帖子中的方式调整配置看看：\nhttps:&#47;&#47;stackoverflow.com&#47;questions&#47;35517713&#47;unable-to-access-spring-boot-actuator-actuator-endpoint","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1586523304,"ip_address":"","comment_id":204597,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"很奇怪的问题，本地访问http:&#47;&#47;localhost:8080&#47;actuator就可以，代码部署到阿里云上就不行了，总是报{&quot;timestamp&quot;:&quot;2020-04-09T09:52:45.986+0000&quot;,&quot;status&quot;:404,&quot;error&quot;:&quot;Not Found&quot;,&quot;message&quot;:&quot;No message available&quot;,&quot;path&quot;:&quot;&#47;actuator&quot;}","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":491227,"discussion_content":"这个可能和spring boot配置有关，你尝试用stackoverflow帖子中的方式调整配置看看：\nhttps://stackoverflow.com/questions/35517713/unable-to-access-spring-boot-actuator-actuator-endpoint","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586523304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":226574,"discussion_content":"后来，重新生成了镜像，启动了下容器，竟然莫名奇妙的好了😂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586436317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103729,"user_name":"正是那朵玫瑰","can_delete":false,"product_type":"c3","uid":1048261,"ip_address":"","ucode":"73D630B654573F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg","comment_is_top":false,"comment_ctime":1560498893,"is_pvip":false,"replies":[{"id":37711,"content":"Prometheus埋点，可以做到侵入或者不侵入，如果你直接用Prometheus客户端对应用代码进行埋点，一般是侵入；但是也可以做成独立的exporter，由它间接去采集监控数据(前提是应用有暴露监控数据的端点)，就可以做到不侵入，具体你可以参考Prometheus的很多现成的exporter，有不少是非侵入的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1560682741,"ip_address":"","comment_id":103729,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师我说的是Prometheus的埋点  不是cat的","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453981,"discussion_content":"Prometheus埋点，可以做到侵入或者不侵入，如果你直接用Prometheus客户端对应用代码进行埋点，一般是侵入；但是也可以做成独立的exporter，由它间接去采集监控数据(前提是应用有暴露监控数据的端点)，就可以做到不侵入，具体你可以参考Prometheus的很多现成的exporter，有不少是非侵入的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560682741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101213,"user_name":"正是那朵玫瑰","can_delete":false,"product_type":"c3","uid":1048261,"ip_address":"","ucode":"73D630B654573F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/c5/3467cf94.jpg","comment_is_top":false,"comment_ctime":1559742547,"is_pvip":false,"replies":[{"id":36636,"content":"CAT设计就是侵入性的，这个有利有弊，好处是比较灵活，性能好，不足是开发成本门槛高。如果你倾向非侵入，可以考虑SkyWalking，也是国人主导开发。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1559914030,"ip_address":"","comment_id":101213,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老师，这种埋点是不是太过于侵入业务代码？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452854,"discussion_content":"CAT设计就是侵入性的，这个有利有弊，好处是比较灵活，性能好，不足是开发成本门槛高。如果你倾向非侵入，可以考虑SkyWalking，也是国人主导开发。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559914030,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":87472,"user_name":"朢不了你","can_delete":false,"product_type":"c3","uid":1232145,"ip_address":"","ucode":"2C2F6E8F9C6139","user_header":"https://static001.geekbang.org/account/avatar/00/12/cd/11/cdcc761e.jpg","comment_is_top":false,"comment_ctime":1555601975,"is_pvip":false,"replies":[{"id":31556,"content":"你好，Prometheus可以覆盖多层次监控，既可以覆盖系统运维层(CPU&#47;内存&#47;网络&#47;磁盘&#47;OS等)，也可以覆盖应用甚至业务层，这个时候就需要研发Dev参与帮助埋点了，光运维没有应用和业务上下文很难搞定；另外行业趋势是DevOps研发运维一体化，纯开发和纯运维会逐渐被同时具备Dev和Ops复合能力的工程师取代，所以即便是业务研发人员也需要掌握像Promethues这样的DevOps监控工具。Promotheus现有提供的接口和工具可以覆盖大部分应用场景，基本配置就好，有些特殊场景需要定制研发，但是工作量也不大，前提是理解和会运用。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1555678778,"ip_address":"","comment_id":87472,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"老所 这后面 像普罗米修斯 和埋点 有点偏运维的意思？ 开发的话有必要了解这些吗  如果定制的话 开发的工作量大吗  我看好多都是已经集成好了  直接配置完就能用","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":447470,"discussion_content":"你好，Prometheus可以覆盖多层次监控，既可以覆盖系统运维层(CPU/内存/网络/磁盘/OS等)，也可以覆盖应用甚至业务层，这个时候就需要研发Dev参与帮助埋点了，光运维没有应用和业务上下文很难搞定；另外行业趋势是DevOps研发运维一体化，纯开发和纯运维会逐渐被同时具备Dev和Ops复合能力的工程师取代，所以即便是业务研发人员也需要掌握像Promethues这样的DevOps监控工具。Promotheus现有提供的接口和工具可以覆盖大部分应用场景，基本配置就好，有些特殊场景需要定制研发，但是工作量也不大，前提是理解和会运用。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555678778,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}