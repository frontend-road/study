{"id":98491,"title":"41 | æ¡ˆä¾‹åˆ†æï¼ˆå››ï¼‰ï¼šé«˜æ€§èƒ½æ•°æ®åº“è¿æ¥æ± HiKariCP","content":"<p>å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æ€»ä¼šéš¾å…å’Œæ•°æ®åº“æ‰“äº¤é“ï¼›åªè¦å’Œæ•°æ®åº“æ‰“äº¤é“ï¼Œå°±å…ä¸äº†ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ã€‚ä¸šç•ŒçŸ¥åçš„æ•°æ®åº“è¿æ¥æ± æœ‰ä¸å°‘ï¼Œä¾‹å¦‚c3p0ã€DBCPã€Tomcat JDBC Connection Poolã€Druidç­‰ï¼Œä¸è¿‡æœ€è¿‘æœ€ç«çš„æ˜¯HiKariCPã€‚</p><p><strong>HiKariCPå·ç§°æ˜¯ä¸šç•Œè·‘å¾—æœ€å¿«çš„æ•°æ®åº“è¿æ¥æ± </strong>ï¼Œè¿™ä¸¤å¹´å‘å±•å¾—é¡ºé£é¡ºæ°´ï¼Œå°¤å…¶æ˜¯Springboot 2.0å°†å…¶ä½œä¸º<strong>é»˜è®¤æ•°æ®åº“è¿æ¥æ± </strong>åï¼Œæ±Ÿæ¹–ä¸€å“¥çš„åœ°ä½å·²æ˜¯æ¯‹åº¸ç½®ç–‘äº†ã€‚é‚£å®ƒä¸ºä»€ä¹ˆé‚£ä¹ˆå¿«å‘¢ï¼Ÿä»Šå¤©å’±ä»¬å°±é‡ç‚¹èŠèŠè¿™ä¸ªè¯é¢˜ã€‚</p><h2>ä»€ä¹ˆæ˜¯æ•°æ®åº“è¿æ¥æ± </h2><p>åœ¨è¯¦ç»†åˆ†æHiKariCPé«˜æ€§èƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯æ•°æ®åº“è¿æ¥æ± ã€‚æœ¬è´¨ä¸Šï¼Œæ•°æ®åº“è¿æ¥æ± å’Œçº¿ç¨‹æ± ä¸€æ ·ï¼Œéƒ½å±äºæ± åŒ–èµ„æºï¼Œä½œç”¨éƒ½æ˜¯é¿å…é‡é‡çº§èµ„æºçš„é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ï¼Œå¯¹äºæ•°æ®åº“è¿æ¥æ± æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯é¿å…æ•°æ®åº“è¿æ¥é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæœåŠ¡ç«¯ä¼šåœ¨è¿è¡ŒæœŸæŒæœ‰ä¸€å®šæ•°é‡çš„æ•°æ®åº“è¿æ¥ï¼Œå½“éœ€è¦æ‰§è¡ŒSQLæ—¶ï¼Œå¹¶ä¸æ˜¯ç›´æ¥åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œè€Œæ˜¯ä»è¿æ¥æ± ä¸­è·å–ä¸€ä¸ªï¼›å½“SQLæ‰§è¡Œå®Œï¼Œä¹Ÿå¹¶ä¸æ˜¯å°†æ•°æ®åº“è¿æ¥çœŸçš„å…³æ‰ï¼Œè€Œæ˜¯å°†å…¶å½’è¿˜åˆ°è¿æ¥æ± ä¸­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0b/19/0b106876824e43d11750334e86556519.png?wh=1142*511\" alt=\"\"></p><center><span class=\"reference\">æ•°æ®åº“è¿æ¥æ± ç¤ºæ„å›¾</span></center><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨å„ç§æŒä¹…åŒ–æ¡†æ¶æ¥å®Œæˆæ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šç›´æ¥å’Œæ•°æ®åº“è¿æ¥æ± æ‰“äº¤é“ï¼Œä¸ºäº†èƒ½è®©ä½ æ›´å¥½åœ°ç†è§£æ•°æ®åº“è¿æ¥æ± çš„å·¥ä½œåŸç†ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä»£ç å¹¶æ²¡æœ‰ä½¿ç”¨ä»»ä½•æ¡†æ¶ï¼Œè€Œæ˜¯åŸç”Ÿåœ°ä½¿ç”¨HiKariCPã€‚æ‰§è¡Œæ•°æ®åº“æ“ä½œåŸºæœ¬ä¸Šæ˜¯ä¸€ç³»åˆ—è§„èŒƒåŒ–çš„æ­¥éª¤ï¼š</p><!-- [[[read_end]]] --><ol>\n<li>é€šè¿‡æ•°æ®æºè·å–ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼›</li>\n<li>åˆ›å»ºStatementï¼›</li>\n<li>æ‰§è¡ŒSQLï¼›</li>\n<li>é€šè¿‡ResultSetè·å–SQLæ‰§è¡Œç»“æœï¼›</li>\n<li>é‡Šæ”¾ResultSetï¼›</li>\n<li>é‡Šæ”¾Statementï¼›</li>\n<li>é‡Šæ”¾æ•°æ®åº“è¿æ¥ã€‚</li>\n</ol><p>ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼Œé€šè¿‡ <code>ds.getConnection()</code> è·å–ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ—¶ï¼Œå…¶å®æ˜¯å‘æ•°æ®åº“è¿æ¥æ± ç”³è¯·ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥ã€‚åŒæ ·ï¼Œé€šè¿‡ <code>conn.close()</code> é‡Šæ”¾ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ—¶ï¼Œä¹Ÿä¸æ˜¯ç›´æ¥å°†è¿æ¥å…³é—­ï¼Œè€Œæ˜¯å°†è¿æ¥å½’è¿˜ç»™æ•°æ®åº“è¿æ¥æ± ã€‚</p><pre><code>//æ•°æ®åº“è¿æ¥æ± é…ç½®\nHikariConfig config = new HikariConfig();\nconfig.setMinimumIdle(1);\nconfig.setMaximumPoolSize(2);\nconfig.setConnectionTestQuery(&quot;SELECT 1&quot;);\nconfig.setDataSourceClassName(&quot;org.h2.jdbcx.JdbcDataSource&quot;);\nconfig.addDataSourceProperty(&quot;url&quot;, &quot;jdbc:h2:mem:test&quot;);\n// åˆ›å»ºæ•°æ®æº\nDataSource ds = new HikariDataSource(config);\nConnection conn = null;\nStatement stmt = null;\nResultSet rs = null;\ntry {\n  // è·å–æ•°æ®åº“è¿æ¥\n  conn = ds.getConnection();\n  // åˆ›å»ºStatement \n  stmt = conn.createStatement();\n  // æ‰§è¡ŒSQL\n  rs = stmt.executeQuery(&quot;select * from abc&quot;);\n  // è·å–ç»“æœ\n  while (rs.next()) {\n    int id = rs.getInt(1);\n    ......\n  }\n} catch(Exception e) {\n   e.printStackTrace();\n} finally {\n  //å…³é—­ResultSet\n  close(rs);\n  //å…³é—­Statement \n  close(stmt);\n  //å…³é—­Connection\n  close(conn);\n}\n//å…³é—­èµ„æº\nvoid close(AutoCloseable rs) {\n  if (rs != null) {\n    try {\n      rs.close();\n    } catch (SQLException e) {\n      e.printStackTrace();\n    }\n  }\n}\n</code></pre><p><a href=\"https://github.com/brettwooldridge/HikariCP/wiki/Down-the-Rabbit-Hole\">HiKariCPå®˜æ–¹ç½‘ç«™</a>è§£é‡Šäº†å…¶æ€§èƒ½ä¹‹æ‰€ä»¥å¦‚æ­¤ä¹‹é«˜çš„ç§˜å¯†ã€‚å¾®è§‚ä¸ŠHiKariCPç¨‹åºç¼–è¯‘å‡ºçš„å­—èŠ‚ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼Œç«™åœ¨å­—èŠ‚ç çš„è§’åº¦å»ä¼˜åŒ–Javaä»£ç ï¼ŒHiKariCPçš„ä½œè€…å¯¹æ€§èƒ½çš„æ‰§ç€å¯è§ä¸€æ–‘ï¼Œä¸è¿‡é—æ†¾çš„æ˜¯ä»–å¹¶æ²¡æœ‰è¯¦ç»†è§£é‡Šéƒ½åšäº†å“ªäº›ä¼˜åŒ–ã€‚è€Œå®è§‚ä¸Šä¸»è¦æ˜¯å’Œä¸¤ä¸ªæ•°æ®ç»“æ„æœ‰å…³ï¼Œä¸€ä¸ªæ˜¯FastListï¼Œå¦ä¸€ä¸ªæ˜¯ConcurrentBagã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•æå‡HiKariCPçš„æ€§èƒ½çš„ã€‚</p><h2>FastListè§£å†³äº†å“ªäº›æ€§èƒ½é—®é¢˜</h2><p>æŒ‰ç…§è§„èŒƒæ­¥éª¤ï¼Œæ‰§è¡Œå®Œæ•°æ®åº“æ“ä½œä¹‹åï¼Œéœ€è¦ä¾æ¬¡å…³é—­ResultSetã€Statementã€Connectionï¼Œä½†æ˜¯æ€»æœ‰ç²—å¿ƒçš„åŒå­¦åªæ˜¯å…³é—­äº†Connectionï¼Œè€Œå¿˜äº†å…³é—­ResultSetå’ŒStatementã€‚ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å½“å…³é—­Connectionæ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å…³é—­Statementã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼ŒConnectionå°±éœ€è¦è·Ÿè¸ªåˆ›å»ºçš„Statementï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å°†åˆ›å»ºçš„Statementä¿å­˜åœ¨æ•°ç»„ArrayListé‡Œï¼Œè¿™æ ·å½“å…³é—­Connectionçš„æ—¶å€™ï¼Œå°±å¯ä»¥ä¾æ¬¡å°†æ•°ç»„ä¸­çš„æ‰€æœ‰Statementå…³é—­ã€‚</p><p>HiKariCPè§‰å¾—ç”¨ArrayListè¿˜æ˜¯å¤ªæ…¢ï¼Œå½“é€šè¿‡ <code>conn.createStatement()</code> åˆ›å»ºä¸€ä¸ªStatementæ—¶ï¼Œéœ€è¦è°ƒç”¨ArrayListçš„add()æ–¹æ³•åŠ å…¥åˆ°ArrayListä¸­ï¼Œè¿™ä¸ªæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼›ä½†æ˜¯å½“é€šè¿‡ <code>stmt.close()</code> å…³é—­Statementçš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨ ArrayListçš„remove()æ–¹æ³•æ¥å°†å…¶ä»ArrayListä¸­åˆ é™¤ï¼Œè¿™é‡Œæ˜¯æœ‰ä¼˜åŒ–ä½™åœ°çš„ã€‚</p><p>å‡è®¾ä¸€ä¸ªConnectionä¾æ¬¡åˆ›å»º6ä¸ªStatementï¼Œåˆ†åˆ«æ˜¯S1ã€S2ã€S3ã€S4ã€S5ã€S6ï¼ŒæŒ‰ç…§æ­£å¸¸çš„ç¼–ç ä¹ æƒ¯ï¼Œå…³é—­Statementçš„é¡ºåºä¸€èˆ¬æ˜¯é€†åºçš„ï¼Œå…³é—­çš„é¡ºåºæ˜¯ï¼šS6ã€S5ã€S4ã€S3ã€S2ã€S1ï¼Œè€ŒArrayListçš„remove(Object o)æ–¹æ³•æ˜¯é¡ºåºéå†æŸ¥æ‰¾ï¼Œé€†åºåˆ é™¤è€Œé¡ºåºæŸ¥æ‰¾ï¼Œè¿™æ ·çš„æŸ¥æ‰¾æ•ˆç‡å°±å¤ªæ…¢äº†ã€‚å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œä¼˜åŒ–æˆé€†åºæŸ¥æ‰¾å°±å¯ä»¥äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4b/a6/4b5e2ef70e46b087b139b331578a82a6.png?wh=1142*389\" alt=\"\"></p><center><span class=\"reference\">é€†åºåˆ é™¤ç¤ºæ„å›¾</span></center><p>HiKariCPä¸­çš„FastListç›¸å¯¹äºArrayListçš„ä¸€ä¸ªä¼˜åŒ–ç‚¹å°±æ˜¯å°† <code>remove(Object element)</code> æ–¹æ³•çš„<strong>æŸ¥æ‰¾é¡ºåºå˜æˆäº†é€†åºæŸ¥æ‰¾</strong>ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒFastListè¿˜æœ‰å¦ä¸€ä¸ªä¼˜åŒ–ç‚¹ï¼Œæ˜¯ <code>get(int index)</code> æ–¹æ³•æ²¡æœ‰å¯¹indexå‚æ•°è¿›è¡Œè¶Šç•Œæ£€æŸ¥ï¼ŒHiKariCPèƒ½ä¿è¯ä¸ä¼šè¶Šç•Œï¼Œæ‰€ä»¥ä¸ç”¨æ¯æ¬¡éƒ½è¿›è¡Œè¶Šç•Œæ£€æŸ¥ã€‚</p><p>æ•´ä½“æ¥çœ‹ï¼ŒFastListçš„ä¼˜åŒ–ç‚¹è¿˜æ˜¯å¾ˆç®€å•çš„ã€‚ä¸‹é¢æˆ‘ä»¬å†æ¥èŠèŠHiKariCPä¸­çš„å¦å¤–ä¸€ä¸ªæ•°æ®ç»“æ„ConcurrentBagï¼Œçœ‹çœ‹å®ƒåˆæ˜¯å¦‚ä½•æå‡æ€§èƒ½çš„ã€‚</p><h2>ConcurrentBagè§£å†³äº†å“ªäº›æ€§èƒ½é—®é¢˜</h2><p>å¦‚æœè®©æˆ‘ä»¬è‡ªå·±æ¥å®ç°ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯ç”¨ä¸¤ä¸ªé˜»å¡é˜Ÿåˆ—æ¥å®ç°ï¼Œä¸€ä¸ªç”¨äºä¿å­˜ç©ºé—²æ•°æ®åº“è¿æ¥çš„é˜Ÿåˆ—idleï¼Œå¦ä¸€ä¸ªç”¨äºä¿å­˜å¿™ç¢Œæ•°æ®åº“è¿æ¥çš„é˜Ÿåˆ—busyï¼›è·å–è¿æ¥æ—¶å°†ç©ºé—²çš„æ•°æ®åº“è¿æ¥ä»idleé˜Ÿåˆ—ç§»åŠ¨åˆ°busyé˜Ÿåˆ—ï¼Œè€Œå…³é—­è¿æ¥æ—¶å°†æ•°æ®åº“è¿æ¥ä»busyç§»åŠ¨åˆ°idleã€‚è¿™ç§æ–¹æ¡ˆå°†å¹¶å‘é—®é¢˜å§”æ‰˜ç»™äº†é˜»å¡é˜Ÿåˆ—ï¼Œå®ç°ç®€å•ï¼Œä½†æ˜¯æ€§èƒ½å¹¶ä¸æ˜¯å¾ˆç†æƒ³ã€‚å› ä¸ºJava SDKä¸­çš„é˜»å¡é˜Ÿåˆ—æ˜¯ç”¨é”å®ç°çš„ï¼Œè€Œé«˜å¹¶å‘åœºæ™¯ä¸‹é”çš„äº‰ç”¨å¯¹æ€§èƒ½å½±å“å¾ˆå¤§ã€‚</p><pre><code>//å¿™ç¢Œé˜Ÿåˆ—\nBlockingQueue&lt;Connection&gt; busy;\n//ç©ºé—²é˜Ÿåˆ—\nBlockingQueue&lt;Connection&gt; idle;\n</code></pre><p>HiKariCPå¹¶æ²¡æœ‰ä½¿ç”¨Java SDKä¸­çš„é˜»å¡é˜Ÿåˆ—ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†ä¸€ä¸ªå«åšConcurrentBagçš„å¹¶å‘å®¹å™¨ã€‚ConcurrentBagçš„è®¾è®¡æœ€åˆæºè‡ªC#ï¼Œå®ƒçš„ä¸€ä¸ªæ ¸å¿ƒè®¾è®¡æ˜¯ä½¿ç”¨ThreadLocalé¿å…éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼Œä¸è¿‡HiKariCPä¸­çš„ConcurrentBagå¹¶æ²¡æœ‰å®Œå…¨å‚è€ƒC#çš„å®ç°ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p>ConcurrentBagä¸­æœ€å…³é”®çš„å±æ€§æœ‰4ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼šç”¨äºå­˜å‚¨æ‰€æœ‰çš„æ•°æ®åº“è¿æ¥çš„å…±äº«é˜Ÿåˆ—sharedListã€çº¿ç¨‹æœ¬åœ°å­˜å‚¨threadListã€ç­‰å¾…æ•°æ®åº“è¿æ¥çš„çº¿ç¨‹æ•°waitersä»¥åŠåˆ†é…æ•°æ®åº“è¿æ¥çš„å·¥å…·handoffQueueã€‚å…¶ä¸­ï¼ŒhandoffQueueç”¨çš„æ˜¯Java SDKæä¾›çš„SynchronousQueueï¼ŒSynchronousQueueä¸»è¦ç”¨äºçº¿ç¨‹ä¹‹é—´ä¼ é€’æ•°æ®ã€‚</p><pre><code>//ç”¨äºå­˜å‚¨æ‰€æœ‰çš„æ•°æ®åº“è¿æ¥\nCopyOnWriteArrayList&lt;T&gt; sharedList;\n//çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­çš„æ•°æ®åº“è¿æ¥\nThreadLocal&lt;List&lt;Object&gt;&gt; threadList;\n//ç­‰å¾…æ•°æ®åº“è¿æ¥çš„çº¿ç¨‹æ•°\nAtomicInteger waiters;\n//åˆ†é…æ•°æ®åº“è¿æ¥çš„å·¥å…·\nSynchronousQueue&lt;T&gt; handoffQueue;\n</code></pre><p>å½“çº¿ç¨‹æ± åˆ›å»ºäº†ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ—¶ï¼Œé€šè¿‡è°ƒç”¨ConcurrentBagçš„add()æ–¹æ³•åŠ å…¥åˆ°ConcurrentBagä¸­ï¼Œä¸‹é¢æ˜¯add()æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å°†è¿™ä¸ªè¿æ¥åŠ å…¥åˆ°å…±äº«é˜Ÿåˆ—sharedListä¸­ï¼Œå¦‚æœæ­¤æ—¶æœ‰çº¿ç¨‹åœ¨ç­‰å¾…æ•°æ®åº“è¿æ¥ï¼Œé‚£ä¹ˆå°±é€šè¿‡handoffQueueå°†è¿™ä¸ªè¿æ¥åˆ†é…ç»™ç­‰å¾…çš„çº¿ç¨‹ã€‚</p><pre><code>//å°†ç©ºé—²è¿æ¥æ·»åŠ åˆ°é˜Ÿåˆ—\nvoid add(final T bagEntry){\n  //åŠ å…¥å…±äº«é˜Ÿåˆ—\n  sharedList.add(bagEntry);\n  //å¦‚æœæœ‰ç­‰å¾…è¿æ¥çš„çº¿ç¨‹ï¼Œ\n  //åˆ™é€šè¿‡handoffQueueç›´æ¥åˆ†é…ç»™ç­‰å¾…çš„çº¿ç¨‹\n  while (waiters.get() &gt; 0 \n    &amp;&amp; bagEntry.getState() == STATE_NOT_IN_USE \n    &amp;&amp; !handoffQueue.offer(bagEntry)) {\n      yield();\n  }\n}\n</code></pre><p>é€šè¿‡ConcurrentBagæä¾›çš„borrow()æ–¹æ³•ï¼Œå¯ä»¥è·å–ä¸€ä¸ªç©ºé—²çš„æ•°æ®åº“è¿æ¥ï¼Œborrow()çš„ä¸»è¦é€»è¾‘æ˜¯ï¼š</p><ol>\n<li>é¦–å…ˆæŸ¥çœ‹çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ˜¯å¦æœ‰ç©ºé—²è¿æ¥ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºé—²çš„è¿æ¥ï¼›</li>\n<li>å¦‚æœçº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­æ— ç©ºé—²è¿æ¥ï¼Œåˆ™ä»å…±äº«é˜Ÿåˆ—ä¸­è·å–ã€‚</li>\n<li>å¦‚æœå…±äº«é˜Ÿåˆ—ä¸­ä¹Ÿæ²¡æœ‰ç©ºé—²çš„è¿æ¥ï¼Œåˆ™è¯·æ±‚çº¿ç¨‹éœ€è¦ç­‰å¾…ã€‚</li>\n</ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­çš„è¿æ¥æ˜¯å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹çªƒå–çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨CASæ–¹æ³•é˜²æ­¢é‡å¤åˆ†é…ã€‚åœ¨å…±äº«é˜Ÿåˆ—ä¸­è·å–ç©ºé—²è¿æ¥ï¼Œä¹Ÿé‡‡ç”¨äº†CASæ–¹æ³•é˜²æ­¢é‡å¤åˆ†é…ã€‚</p><pre><code>T borrow(long timeout, final TimeUnit timeUnit){\n  // å…ˆæŸ¥çœ‹çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ˜¯å¦æœ‰ç©ºé—²è¿æ¥\n  final List&lt;Object&gt; list = threadList.get();\n  for (int i = list.size() - 1; i &gt;= 0; i--) {\n    final Object entry = list.remove(i);\n    final T bagEntry = weakThreadLocals \n      ? ((WeakReference&lt;T&gt;) entry).get() \n      : (T) entry;\n    //çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­çš„è¿æ¥ä¹Ÿå¯ä»¥è¢«çªƒå–ï¼Œ\n    //æ‰€ä»¥éœ€è¦ç”¨CASæ–¹æ³•é˜²æ­¢é‡å¤åˆ†é…\n    if (bagEntry != null \n      &amp;&amp; bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) {\n      return bagEntry;\n    }\n  }\n\n  // çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­æ— ç©ºé—²è¿æ¥ï¼Œåˆ™ä»å…±äº«é˜Ÿåˆ—ä¸­è·å–\n  final int waiting = waiters.incrementAndGet();\n  try {\n    for (T bagEntry : sharedList) {\n      //å¦‚æœå…±äº«é˜Ÿåˆ—ä¸­æœ‰ç©ºé—²è¿æ¥ï¼Œåˆ™è¿”å›\n      if (bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) {\n        return bagEntry;\n      }\n    }\n    //å…±äº«é˜Ÿåˆ—ä¸­æ²¡æœ‰è¿æ¥ï¼Œåˆ™éœ€è¦ç­‰å¾…\n    timeout = timeUnit.toNanos(timeout);\n    do {\n      final long start = currentTime();\n      final T bagEntry = handoffQueue.poll(timeout, NANOSECONDS);\n      if (bagEntry == null \n        || bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) {\n          return bagEntry;\n      }\n      //é‡æ–°è®¡ç®—ç­‰å¾…æ—¶é—´\n      timeout -= elapsedNanos(start);\n    } while (timeout &gt; 10_000);\n    //è¶…æ—¶æ²¡æœ‰è·å–åˆ°è¿æ¥ï¼Œè¿”å›null\n    return null;\n  } finally {\n    waiters.decrementAndGet();\n  }\n}\n</code></pre><p>é‡Šæ”¾è¿æ¥éœ€è¦è°ƒç”¨ConcurrentBagæä¾›çš„requite()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•ï¼Œé¦–å…ˆå°†æ•°æ®åº“è¿æ¥çŠ¶æ€æ›´æ”¹ä¸ºSTATE_NOT_IN_USEï¼Œä¹‹åæŸ¥çœ‹æ˜¯å¦å­˜åœ¨ç­‰å¾…çº¿ç¨‹ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åˆ†é…ç»™ç­‰å¾…çº¿ç¨‹ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†è¯¥æ•°æ®åº“è¿æ¥ä¿å­˜åˆ°çº¿ç¨‹æœ¬åœ°å­˜å‚¨é‡Œã€‚</p><pre><code>//é‡Šæ”¾è¿æ¥\nvoid requite(final T bagEntry){\n  //æ›´æ–°è¿æ¥çŠ¶æ€\n  bagEntry.setState(STATE_NOT_IN_USE);\n  //å¦‚æœæœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œåˆ™ç›´æ¥åˆ†é…ç»™çº¿ç¨‹ï¼Œæ— éœ€è¿›å…¥ä»»ä½•é˜Ÿåˆ—\n  for (int i = 0; waiters.get() &gt; 0; i++) {\n    if (bagEntry.getState() != STATE_NOT_IN_USE \n      || handoffQueue.offer(bagEntry)) {\n        return;\n    } else if ((i &amp; 0xff) == 0xff) {\n      parkNanos(MICROSECONDS.toNanos(10));\n    } else {\n      yield();\n    }\n  }\n  //å¦‚æœæ²¡æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œåˆ™è¿›å…¥çº¿ç¨‹æœ¬åœ°å­˜å‚¨\n  final List&lt;Object&gt; threadLocalList = threadList.get();\n  if (threadLocalList.size() &lt; 50) {\n    threadLocalList.add(weakThreadLocals \n      ? new WeakReference&lt;&gt;(bagEntry) \n      : bagEntry);\n  }\n}\n</code></pre><h2>æ€»ç»“</h2><p>HiKariCPä¸­çš„FastListå’ŒConcurrentBagè¿™ä¸¤ä¸ªæ•°æ®ç»“æ„ä½¿ç”¨å¾—éå¸¸å·§å¦™ï¼Œè™½ç„¶å®ç°èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯å¯¹äºæ€§èƒ½çš„æå‡éå¸¸æ˜æ˜¾ï¼Œæ ¹æœ¬åŸå› åœ¨äºè¿™ä¸¤ä¸ªæ•°æ®ç»“æ„é€‚ç”¨äºæ•°æ®åº“è¿æ¥æ± è¿™ä¸ªç‰¹å®šçš„åœºæ™¯ã€‚FastListé€‚ç”¨äºé€†åºåˆ é™¤åœºæ™¯ï¼›è€ŒConcurrentBagé€šè¿‡ThreadLocalåšä¸€æ¬¡é¢„åˆ†é…ï¼Œé¿å…ç›´æ¥ç«äº‰å…±äº«èµ„æºï¼Œéå¸¸é€‚åˆæ± åŒ–èµ„æºçš„åˆ†é…ã€‚</p><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬é‡åˆ°çš„å¹¶å‘é—®é¢˜åƒå·®ä¸‡åˆ«ï¼Œè¿™æ—¶é€‰æ‹©åˆé€‚çš„å¹¶å‘æ•°æ®ç»“æ„å°±éå¸¸é‡è¦äº†ã€‚å½“ç„¶èƒ½é€‰å¯¹çš„å‰ææ˜¯å¯¹ç‰¹å®šåœºæ™¯çš„å¹¶å‘ç‰¹æ€§æœ‰æ·±å…¥çš„äº†è§£ï¼Œåªæœ‰äº†è§£åˆ°æ— è°“çš„æ€§èƒ½æ¶ˆè€—åœ¨å“ªé‡Œï¼Œæ‰èƒ½å¯¹ç—‡ä¸‹è¯ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p></p>","neighbors":{"left":{"article_title":"40 | æ¡ˆä¾‹åˆ†æï¼ˆä¸‰ï¼‰ï¼šé«˜æ€§èƒ½é˜Ÿåˆ—Disruptor","id":98134},"right":{"article_title":"42 | Actoræ¨¡å‹ï¼šé¢å‘å¯¹è±¡åŸç”Ÿçš„å¹¶å‘æ¨¡å‹","id":98903}},"comments":[{"had_liked":false,"id":100200,"user_name":"ç©ºçŸ¥","can_delete":false,"product_type":"c1","uid":1013283,"ip_address":"","ucode":"C448E98238DD36","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg","comment_is_top":false,"comment_ctime":1559479037,"is_pvip":false,"replies":[{"id":"36135","content":"å‰å®³","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1559541730,"ip_address":"","comment_id":100200,"utype":1}],"discussion_count":3,"race_medal":0,"score":"263552484093","product_id":100023901,"comment_content":"çº¿ç¨‹æœ¬åœ°çš„è¿æ¥ä¼šè¢«çªƒå–   <br>è¿™ä¸ªæˆ‘è§‰å¾—æ˜¯å› ä¸º å¦‚æœ Tlé‡Œé¢æ²¡æœ‰ç©ºé—²çš„ ä¼šå» sharedListæŸ¥æ‰¾å¤„äº Not_In_Useçš„è¿æ¥ è¿™ä¸ªè¿æ¥å¯èƒ½å·²ç»åœ¨å…¶ä»–TLé‡Œé¢å­˜åœ¨äº† æ‰€ä»¥å°±ä¼šå‡ºç°çº¿ç¨‹T2ä»sharedListè·å–åˆ°äº† T1å­˜åœ¨TLé‡Œé¢å­˜æ”¾çš„æ²¡æœ‰ä½¿ç”¨çš„è¿æ¥è¿™ç§æƒ…å†µ","like_count":61,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452447,"discussion_content":"å‰å®³","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559541730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1185424,"avatar":"https://static001.geekbang.org/account/avatar/00/12/16/90/21f4035c.jpg","nickname":"èª","note":"","ucode":"EBF8A23383D59F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538735,"discussion_content":"sharedListä¸­è¿æ¥ä½“ç°äº†æ˜¯å¦åœ¨ä½¿ç”¨ä¸­ï¼Œä½†æ˜¯æœªä½“ç°æ˜¯å¦åœ¨å…¶ä»–TLä¸­ï¼Œæ‰€ä»¥å³ä½¿ä»æœ¬çº¿ç¨‹TLä¸­è·å–è¿æ¥ä¹Ÿè¦æ£€æŸ¥æ˜¯å¦å¯ç”¨ï¼›è¿™æ ·çš„å¥½å¤„æ˜¯æ›´å……åˆ†åˆ©ç”¨æœªè¢«ä½¿ç”¨çš„è¿æ¥ï¼Œæé«˜è¿æ¥çš„ä½¿ç”¨ç‡","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1639495043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1897671,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/f4/c7/037235c9.jpg","nickname":"kimoti","note":"","ucode":"0A78077408C2B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":275957,"discussion_content":"è¿™ä¸ªè§£é‡Šå¥½éš¾ç†è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590790313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":122535,"user_name":"æ‹¯æ•‘åœ°çƒå¥½ç´¯","can_delete":false,"product_type":"c1","uid":1339022,"ip_address":"","ucode":"7643439601EF4C","user_header":"https://static001.geekbang.org/account/avatar/00/14/6e/8e/5d309a85.jpg","comment_is_top":false,"comment_ctime":1565419743,"is_pvip":false,"replies":[{"id":"50600","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1568085584,"ip_address":"","comment_id":122535,"utype":1}],"discussion_count":1,"race_medal":0,"score":"233493653727","product_id":100023901,"comment_content":"æ”¯æŒé«˜æ€§èƒ½å¹¶å‘çš„è½¯ä»¶é€šå¸¸é¦–å…ˆä¼šå…³æ³¨æ•´ä½“çš„å¹¶å‘è®¾è®¡æ¨¡å¼ï¼Œå¹¶å‘è®¾è®¡æ¨¡å¼å°†å½±å“æ•´ä¸ªè½¯ä»¶çš„è®¾è®¡æ¶æ„ï¼Œæ¯”å¦‚RateLimiterå¹¶éé‡‡ç”¨è¾ƒä¸ºå¤æ‚çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œè€Œæ˜¯ç”¨ç»†ç²’åº¦çš„äº’æ–¥é”æ¥å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•ï¼›Nettyé‡‡ç”¨äº†Reactoræ¨¡å¼è€Œéé˜»å¡çš„ç­‰å¾…-é€šçŸ¥æœºåˆ¶çš„ä¸€äº›å®ç°ã€‚å¯¹è®¾è®¡æ¨¡å¼çš„è€ƒé‡åº”å½“æ ¹æ®å®é™…éœ€æ±‚å…ˆè€ƒè™‘çº¿ç¨‹åˆ†å·¥ï¼Œå†ä»é¿å…å…±äº«çš„æ¨¡å¼è€ƒè™‘åˆ°ä¸€äº›æ— é”çš„æ¨¡å¼ï¼Œå†åˆ°ç»†ç²’åº¦çš„é”æ§åˆ¶ï¼Œå†åˆ°å¤æ‚çš„åŒæ­¥å’Œäº’æ–¥æ¨¡å¼ã€‚<br>ä»é«˜æ€§èƒ½é˜Ÿåˆ—å’Œé«˜æ€§èƒ½æ•°æ®è¿æ¥æ± ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ€§èƒ½çš„æé«˜é€šå¸¸ä¼šä»å‡ æ–¹é¢ç€æ‰‹ï¼ˆå®é™…åœºæ™¯ä¸­åº”å½“æµ‹è¯•ä¼˜äºçŒœæµ‹ï¼Œå†æ ¹æ®é˜¿å§†è¾¾å°”å®šå¾‹ä»æ€§èƒ½ç“¶é¢ˆå¤„å…ˆç€æ‰‹ï¼‰ï¼šå¹¶å‘è®¾è®¡æ¨¡å¼ï¼›å†…å­˜åˆ†é…ç®—æ³•ï¼›ç¼“å­˜åˆ©ç”¨ç‡ï¼›GCæƒ…å†µï¼ˆæœ‰GCçš„è¯­è¨€ï¼‰ï¼›æ•°æ®ç»“æ„ä¸ç®—æ³•çš„æ•ˆç‡ç­‰ã€‚<br>","like_count":55,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462297,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568085584,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100203,"user_name":"æ™“æ°","can_delete":false,"product_type":"c1","uid":1441546,"ip_address":"","ucode":"1174C88EEBF8A6","user_header":"https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg","comment_is_top":false,"comment_ctime":1559480360,"is_pvip":false,"replies":[{"id":"36134","content":"sharedlistå’Œå…¶ä»–çº¿ç¨‹çš„threadlocalé‡Œæœ‰å¯èƒ½éƒ½æœ‰åŒä¸€ä¸ªè¿æ¥ï¼Œä»å‰è€…å–åˆ°è¿æ¥ï¼Œå°±ç›¸å½“äºçªƒå–äº†åè€…","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1559541708,"ip_address":"","comment_id":100203,"utype":1}],"discussion_count":1,"race_medal":0,"score":"74573924392","product_id":100023901,"comment_content":"åŒé—®ä¸ºä»€ä¹ˆçº¿ç¨‹æœ¬åœ°çš„ä¼šè¢«å…¶ä»–çº¿ç¨‹çªƒå–ï¼Œéº»çƒ¦è€å¸ˆè§£é‡Šä¸€ä¸‹","like_count":17,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452449,"discussion_content":"sharedlistå’Œå…¶ä»–çº¿ç¨‹çš„threadlocalé‡Œæœ‰å¯èƒ½éƒ½æœ‰åŒä¸€ä¸ªè¿æ¥ï¼Œä»å‰è€…å–åˆ°è¿æ¥ï¼Œå°±ç›¸å½“äºçªƒå–äº†åè€…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559541708,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100047,"user_name":"é˜¿å¥","can_delete":false,"product_type":"c1","uid":1024066,"ip_address":"","ucode":"7475C02BABF3B2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/42/88e70d61.jpg","comment_is_top":false,"comment_ctime":1559400943,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"44509073903","product_id":100023901,"comment_content":"åŒé—®ï¼Œä¸ºä»€ä¹ˆè¯´çº¿ç¨‹æœ¬åœ°çš„è¿æ¥ä¼šè¢«çªƒå–å‘¢ï¼Ÿ","like_count":10,"discussions":[{"author":{"id":1019351,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8d/d7/886e9563.jpg","nickname":"å¼ é«˜","note":"","ucode":"9E5EB8675E4956","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":95342,"discussion_content":"çº¿ç¨‹çš„threadListä¸­çš„ç©ºé—²çº¿ç¨‹çš„å¼•ç”¨åŒæ—¶ä¹Ÿè¢«sharedListä¿å­˜äº†ï¼›åˆ«çš„çº¿ç¨‹ä¼šä¼˜å…ˆä»è‡ªå·±çš„threadListä¸­æ‰¾ç©ºé—²çº¿ç¨‹ï¼Œæ‰¾ä¸åˆ°å°±ä»æ‰€æœ‰çº¿ç¨‹å…±äº«çš„sharedListä¸­æ‰¾ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1577020540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100067,"user_name":"æ²™æ¼ é‡Œçš„éª†é©¼","can_delete":false,"product_type":"c1","uid":1012559,"ip_address":"","ucode":"5EC18A71B3A594","user_header":"https://static001.geekbang.org/account/avatar/00/0f/73/4f/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1559433904,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"23034270384","product_id":100023901,"comment_content":"çªƒå–æ˜¯åœ¨è·å–æœ¬åœ°é“¾æ¥å¤±è´¥æ—¶ï¼Œéå†sharelistå®ç°çš„","like_count":5},{"had_liked":false,"id":99994,"user_name":"å³°","can_delete":false,"product_type":"c1","uid":1056019,"ip_address":"","ucode":"C53CB64E8E7D19","user_header":"https://static001.geekbang.org/account/avatar/00/10/1d/13/31ea1b0b.jpg","comment_is_top":false,"comment_ctime":1559381623,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"23034218103","product_id":100023901,"comment_content":"æƒ³äº†åŠå¤©æ„Ÿè§‰ConcurrentBagåº”è¯¥æ˜¯æ± åŒ–çš„ä¸€ç§é€šç”¨æ€§ä¼˜åŒ–ï¼Œä½†å¥½åƒä¼šæœ‰é¥¥é¥¿é—®é¢˜ï¼Œå¦‚æœæŸäº›çº¿ç¨‹æ€»æ˜¯å ç”¨è¿æ¥ï¼Œé‚£ä¹ˆæŸäº›ä¸ç»å¸¸å ç”¨è¿æ¥çš„å°±å¯èƒ½ä¸€ç›´æ‹¿ä¸åˆ°è¿æ¥ï¼Œç¡¬æƒ³çš„ä¸€ä¸ªç¼ºç‚¹ï¼Œå“ˆå“ˆå“ˆã€‚","like_count":5},{"had_liked":false,"id":224961,"user_name":"Just","can_delete":false,"product_type":"c1","uid":2022626,"ip_address":"","ucode":"35FA6917DE1D04","user_header":"https://static001.geekbang.org/account/avatar/00/1e/dc/e2/a3abd320.jpg","comment_is_top":false,"comment_ctime":1591602311,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14476504199","product_id":100023901,"comment_content":"è¿™ä¸ªThreadLocalå’ŒJVMå†…å­˜åˆ†é…çš„TLABï¼ˆThread local allocation bufferï¼‰è¿˜æ˜¯æœ‰ç‚¹åƒï¼Œå…ˆä»æœ¬åœ°è·å–ï¼Œæ²¡æœ‰çš„è¯å†å»ç”³è¯·","like_count":3},{"had_liked":false,"id":242495,"user_name":"Simple life","can_delete":false,"product_type":"c1","uid":1571460,"ip_address":"","ucode":"1902D7F72FB43F","user_header":"https://static001.geekbang.org/account/avatar/00/17/fa/84/f01d203a.jpg","comment_is_top":false,"comment_ctime":1597742171,"is_pvip":false,"replies":[{"id":"90227","content":"å¤šæ¬¡è¯·æ±‚ä¹‹é—´æ˜¯ä¸å…±äº«ä»»ä½•æ•°æ®éƒ½æ²¡æœ‰ï¼Œæ€§èƒ½æé«˜åªæ˜¯ä¸€æ¬¡è¯·æ±‚èŒƒå›´ä¹‹å†…<br>","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1598926687,"ip_address":"","comment_id":242495,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10187676763","product_id":100023901,"comment_content":"çœ‹äº†ç¬¬äºŒéï¼Œæœ‰ä¸ªç–‘é—®ï¼Œåœ¨ä¸€åŠWEBé¡¹ç›®ä¸­ï¼Œæ¯æ¬¡è¯·æ±‚SPRINGéƒ½æ–°å»ºä¸€ä¸ªçº¿ç¨‹æœåŠ¡ï¼Œæ‰€ä»¥ThreadLocalä¸­çš„çº¿ç¨‹å¹¶ä¸èƒ½é‡ç”¨ï¼Œè¿™å—æ€§èƒ½æå‡å°±æ— æ•ˆäº†ï¼Œéƒ½å»COWä¸­CASè·å–å¯ç”¨çº¿ç¨‹äº†ï¼ŒCASåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸­è¡¨ç°å¹¶ä¸å¥½","like_count":2,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504021,"discussion_content":"å¤šæ¬¡è¯·æ±‚ä¹‹é—´æ˜¯ä¸å…±äº«ä»»ä½•æ•°æ®éƒ½æ²¡æœ‰ï¼Œæ€§èƒ½æé«˜åªæ˜¯ä¸€æ¬¡è¯·æ±‚èŒƒå›´ä¹‹å†…\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598926687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100088,"user_name":"cricket1981","can_delete":false,"product_type":"c1","uid":1001715,"ip_address":"","ucode":"758262F5958DA4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/48/f3/f1034ffd.jpg","comment_is_top":false,"comment_ctime":1559441115,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10149375707","product_id":100023901,"comment_content":"å¯ä»¥ç”¨æ ˆstackæ¥ä»£æ›¿listå®ç°é€†åºå…³é—­S6~S1å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1156592,"avatar":"https://static001.geekbang.org/account/avatar/00/11/a5/f0/8648c464.jpg","nickname":"Joker","note":"","ucode":"126AF848001A1E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":52588,"discussion_content":"é‚£ä¸ªé€†åºæŸ¥æ‰¾åº”è¯¥ä¸æ˜¯å¿…é¡»çš„å§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574070559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1018620,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","nickname":"ipofss","note":"","ucode":"DE3061C9259F9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":48808,"discussion_content":"æ ˆé‡Œçš„æ–¹æ³•éƒ½æ˜¯åŒæ­¥çš„ï¼Œè€Œä¸”å¼¹å‡ºæ“ä½œä¼šæœ‰æ ¡éªŒå‚æ•°ï¼Œæ„Ÿè§‰ç»“æœä¸Šå¯ä»¥ï¼Œæ€§èƒ½ä¸Šæ²¡æœ‰FastListå¥½å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573529423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293945,"user_name":"Monday","can_delete":false,"product_type":"c1","uid":1250907,"ip_address":"","ucode":"77B9BACC783598","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","comment_is_top":false,"comment_ctime":1621643421,"is_pvip":false,"replies":[{"id":"106596","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1621669310,"ip_address":"","comment_id":293945,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5916610717","product_id":100023901,"comment_content":"åˆæ¥æ‰“ä¸€æ¬¡å¡ï¼Œé…åˆä»£ç å’Œdebug","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520439,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621669310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272781,"user_name":"poordickey","can_delete":false,"product_type":"c1","uid":1810156,"ip_address":"","ucode":"2A436EC813AF97","user_header":"","comment_is_top":false,"comment_ctime":1610279295,"is_pvip":false,"replies":[{"id":"98928","content":"å¹¶æ²¡æœ‰çœŸçš„closeï¼Œä½ è°ƒç”¨äº†ä¸€ä¸ªè¢«hackçš„æ–¹æ³•","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1610366181,"ip_address":"","comment_id":272781,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5905246591","product_id":100023901,"comment_content":"è¿™é‡Œè®²çš„æ˜¯è¿æ¥æ±   ä½†æ˜¯å¾ˆæƒ³çŸ¥é“ä¸€ä¸ªæ•°æ®åº“è¿æ¥ä»æ‹¿åˆ°åˆ°å½’è¿˜çš„æ•´ä¸ªè¿‡ç¨‹ç»†èŠ‚ï¼Œä»ä¸€ä¸ªè¿æ¥æ± æ‹¿åˆ°ä¸€ä¸ªè¿æ¥ï¼Œconnectä¹‹åï¼Œæ‰§è¡Œäº†SQLï¼Œå¹¶closeäº†ï¼Œå½’è¿˜åˆ°çº¿ç¨‹æ± ä¹‹ååˆæ˜¯æ€ä¹ˆä¸€ç›´å’Œæ•°æ®åº“ä¿æŒè¿æ¥çš„å‘¢","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513383,"discussion_content":"å¹¶æ²¡æœ‰çœŸçš„closeï¼Œä½ è°ƒç”¨äº†ä¸€ä¸ªè¢«hackçš„æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610366181,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":220393,"user_name":"sky","can_delete":false,"product_type":"c1","uid":1008071,"ip_address":"","ucode":"9FE5F43055D3AB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/61/c7/b64ac05e.jpg","comment_is_top":false,"comment_ctime":1590233383,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5885200679","product_id":100023901,"comment_content":"for (int i = list.size() - 1; i &gt;= 0; i--) { final Object entry = list.remove(i);<br><br>éå†çš„åŒæ—¶åˆ é™¤ ä¼šæŠ¥ currentModityExceptionå§<br><br>å¦å¤–æ²¡çœ‹æ‡‚ä¸ºå•¥éœ€è¦handoffQueue, ç›´æ¥ä»share é‡Œæ‹¿ å’Œ threadLocal é‡Œæ‹¿ä¸è¡Œä¹ˆ","like_count":1,"discussions":[{"author":{"id":1554995,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ba/33/2d83d174.jpg","nickname":"æ—¶å…‰å®ˆæŠ¤è€…-åŸºå…°","note":"","ucode":"F0B0887B1979D2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373296,"discussion_content":"åŒä¸æ˜ç™½handOffQueueçš„ä½œç”¨æ˜¯å•¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620693216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1197455,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/8f/a56b2214.jpg","nickname":"innocent","note":"","ucode":"368659A0DDE7E4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1554995,"avatar":"https://static001.geekbang.org/account/avatar/00/17/ba/33/2d83d174.jpg","nickname":"æ—¶å…‰å®ˆæŠ¤è€…-åŸºå…°","note":"","ucode":"F0B0887B1979D2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388111,"discussion_content":"å¦‚æœä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å®Œè¿æ¥è¦å½’è¿˜ï¼Œæ­¤æ—¶æ­£å¥½æœ‰å¦ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–è¿æ¥ï¼Œåˆšå¥½å°±å¯ä»¥é€šè¿‡æ‰‹é€’æ‰‹çš„æ–¹å¼æŠŠè¿æ¥ç»™åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå‡å°‘å½’è¿˜çº¿ç¨‹çš„æ“ä½œ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1628598167,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373296,"ip_address":""},"score":388111,"extra":""}]}]},{"had_liked":false,"id":103299,"user_name":"Geek_89bbab","can_delete":false,"product_type":"c1","uid":1156607,"ip_address":"","ucode":"B3110D5B3C9500","user_header":"https://static001.geekbang.org/account/avatar/00/11/a5/ff/6201122c.jpg","comment_is_top":false,"comment_ctime":1560410686,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5855377982","product_id":100023901,"comment_content":"threadListé‡Œé¢çš„è¿æ¥å¯èƒ½ä¹Ÿä¼šå­˜åœ¨äºå¤šä¸ªthreadList,ä½†æ˜¯æ¦‚ç‡ç›¸å¯¹è¾ƒå°ï¼›threadListçš„è¿æ¥çš„removeæ“ä½œéƒ½ç”±æœ¬çº¿ç¨‹æ¥æ‰§è¡Œï¼Œçªƒå–çš„çº¿ç¨‹åªä¼šæŠŠæ ‡è¯†è®¾ç½®ä¸ºå·²ä½¿ç”¨ï¼Œè€Œä¸ä¼šå°†å…¶ä»å¯¹åº”çš„é‚£ä¸ªthreadListç§»é™¤ã€‚å¯èƒ½æ˜¯ä¸ºäº†é¿å…å¤šçº¿ç¨‹æ“ä½œåŒä¸€ä¸ªé˜Ÿåˆ—,è€Œå½±å“æ€§èƒ½ã€‚æ‰€ä»¥æŠŠç§»é™¤threadListé‡Œçš„è¿æ¥çš„ä»»åŠ¡äº¤ç»™å¯¹åº”çš„é‚£ä¸ªçº¿ç¨‹ã€‚","like_count":1},{"had_liked":false,"id":100227,"user_name":"å¤šè¥„ä¸¸","can_delete":false,"product_type":"c1","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1559487467,"is_pvip":false,"replies":[{"id":"36133","content":"åªæœ‰requiteçš„æ—¶å€™ä¼šæ”¾åˆ°threatlocalé‡Œ","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1559541480,"ip_address":"","comment_id":100227,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5854454763","product_id":100023901,"comment_content":"è€å¸ˆï¼Œ æˆ‘çœ‹æ–‡ä¸­æåˆ°çš„æ˜¯è°ƒç”¨requite()é‡Šæ”¾é“¾æ¥çš„æ—¶å€™å°†è¿™ä¸ªé“¾æ¥æ·»åŠ åˆ°æœ¬åœ°å­˜å‚¨ä¸­ã€‚<br>é‚£æˆ‘æƒ³é—®ï¼Œå¦‚æœä¸æ˜¯è°ƒç”¨requite()æ–¹æ³•é‡Šæ”¾è¿æ¥çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¿æ¥ç¬¬ä¸€æ¬¡è¢«æ”¾å…¥threadlocalæ˜¯ä»€ä¹ˆæ—¶å€™å•Šï¼Ÿ æ˜¯ç¬¬ä¸€æ¬¡è·å–è¿æ¥çš„æ—¶å€™å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452464,"discussion_content":"åªæœ‰requiteçš„æ—¶å€™ä¼šæ”¾åˆ°threatlocalé‡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559541480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100164,"user_name":"é“¶æ—¶ç©ºdeæ¢¦","can_delete":false,"product_type":"c1","uid":1179017,"ip_address":"","ucode":"EC707B6CF7F287","user_header":"https://static001.geekbang.org/account/avatar/00/11/fd/89/cbca1b8e.jpg","comment_is_top":false,"comment_ctime":1559465318,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5854432614","product_id":100023901,"comment_content":"æœ€åæ•°æ®åº“è¿æ¥éƒ½åˆ°çº¿ç¨‹æœ¬åœ°æ± ä¸­äº†","like_count":1,"discussions":[{"author":{"id":1018620,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg","nickname":"ipofss","note":"","ucode":"DE3061C9259F9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":48807,"discussion_content":"æˆ‘æ„Ÿè§‰ä¹Ÿæ˜¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573529126,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100112,"user_name":"å¼ å¾·","can_delete":false,"product_type":"c1","uid":1101929,"ip_address":"","ucode":"31FE63E8725EFC","user_header":"https://static001.geekbang.org/account/avatar/00/10/d0/69/5dbdc245.jpg","comment_is_top":false,"comment_ctime":1559446754,"is_pvip":false,"replies":[{"id":"36141","content":"å‘µå‘µğŸ˜„","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1559542449,"ip_address":"","comment_id":100112,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5854414050","product_id":100023901,"comment_content":"å¼ºçƒˆå»ºè®®è€å¸ˆå†è®²ä¸€æœŸ  ","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452415,"discussion_content":"å‘µå‘µğŸ˜„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559542449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":350461,"user_name":"ç å°å‘†","can_delete":false,"product_type":"c1","uid":2055809,"ip_address":"","ucode":"44532D6ABF9340","user_header":"https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg","comment_is_top":false,"comment_ctime":1656924677,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1656924677","product_id":100023901,"comment_content":"è¯·é—®æ˜¯å¦‚ä½• ä¿è¯æ•°ç»„ä¸ä¼šè¶Šç•Œçš„å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":348993,"user_name":"ç‹åº”å‘","can_delete":false,"product_type":"c1","uid":2768731,"ip_address":"","ucode":"EF597BADCC526B","user_header":"","comment_is_top":false,"comment_ctime":1655628649,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1655628649","product_id":100023901,"comment_content":"åˆ é™¤statementæ—¶ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥è°ƒç”¨clearæ–¹æ³•æ¸…ç©ºï¼Ÿ","like_count":0},{"had_liked":false,"id":346249,"user_name":"yellow","can_delete":false,"product_type":"c1","uid":2249111,"ip_address":"","ucode":"C359D1E7BACE3A","user_header":"https://static001.geekbang.org/account/avatar/00/22/51/97/936944e6.jpg","comment_is_top":false,"comment_ctime":1652944246,"is_pvip":false,"replies":[{"id":"126349","content":"æ‰€æœ‰çš„è¿æ¥ï¼Œä¸è®ºæ˜¯å¦è¢«ä½¿ç”¨ï¼Œéƒ½åœ¨sharedListä¸­","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1269969","ctime":1652968400,"ip_address":"","comment_id":346249,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1652944246","product_id":100023901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œè¯·é—®é‡Šæ”¾çš„è¿æ¥ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»…ä»…è¢«ä¿å­˜åˆ°çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦åŒæ—¶è¢«é‡æ–°ä¿å­˜åˆ°sharedListä¸­å‘¢ï¼Ÿ<br>ä¸é‡æ–°ä¿å­˜åˆ°sharedListä¸­ï¼Œåˆ«çš„çº¿ç¨‹è¿˜æ€ä¹ˆæœ‰æœºä¼šæ‹¿å¾—åˆ°è¿™ä¸ªè¿æ¥å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572807,"discussion_content":"æ‰€æœ‰çš„è¿æ¥ï¼Œä¸è®ºæ˜¯å¦è¢«ä½¿ç”¨ï¼Œéƒ½åœ¨sharedListä¸­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652968400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308478,"user_name":"studyçš„ç¨‹åºå‘˜","can_delete":false,"product_type":"c1","uid":1023101,"ip_address":"","ucode":"E5AE9037D24429","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg","comment_is_top":false,"comment_ctime":1629639301,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629639301","product_id":100023901,"comment_content":"å¦‚æœä¼šè¢«çªƒå–ï¼Œrequiteæ–¹æ³•ä¸­å¦‚æœæ²¡æœ‰ç­‰å¾…çº¿ç¨‹ä¸ºä»€ä¹ˆä¸æŠŠè¿æ¥æ”¾å…¥sharedListï¼Ÿ","like_count":0},{"had_liked":false,"id":294142,"user_name":"Monday","can_delete":false,"product_type":"c1","uid":1250907,"ip_address":"","ucode":"77B9BACC783598","user_header":"https://static001.geekbang.org/account/avatar/00/13/16/5b/83a35681.jpg","comment_is_top":false,"comment_ctime":1621784022,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1621784022","product_id":100023901,"comment_content":"1ã€è€å¸ˆè´´å‡ºæ¥çš„æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„hikariCPï¼Œæˆ‘çš„ç‰ˆæœ¬ï¼ˆcom.zaxxer:HikariCP:2.5.1ï¼‰ConcurrentBagæ²¡æœ‰handoffQueueå±æ€§ã€‚<br>2ã€å¦å¤–æˆ‘æƒ³ç›‘æ§hikariCPæŠŠæ‰§è¡Œè¶…æ—¶ï¼ˆæ¯”å¦‚6sï¼‰çš„è¿æ¥é‡Šæ”¾æ‰ã€‚å·²ç»åšå‡ºçš„å°è¯•ï¼š<br>1ï¼‰é€šè¿‡Mybatisçš„è®¾ç½®æ‰§è¡Œè¶…æ—¶(defaultStatementTimeout)æ— æ•ˆï¼Œç”Ÿäº§ä¸Š30ä¸ªè¿æ¥å…¨éƒ¨è¢«è€—å°½ï¼Œå†æœ‰æ–°è¯·æ±‚ä¼šä¸€ç›´æŠ¥é”™â€œ Connection is not available, request timed out after 30000msâ€ã€‚<br><br>ç°åœ¨æ­£åœ¨å°è¯•çš„åšæ³•ï¼š<br>å®šæ—¶ä»»åŠ¡å¾ªç¯æ‰€æœ‰æ•°æ®åº“è¿æ¥ï¼Œåˆ¤æ–­æ‰§è¡Œè¶…è¿‡6Sçš„è¿æ¥ï¼Œå°†å…¶åº•å±‚çš„Connection å…³é—­ã€‚æœ¬åœ°æµ‹è¯•èƒ½å…³é—­ï¼Œå³èƒ½é‡Šæ”¾è¿æ¥æ± ä¸­å·²ç»Hangä½çš„è¿æ¥ï¼Œä½†æ˜¯â€œæ‰§è¡Œè¶…è¿‡6sâ€è¿™ä¸ªä¸å¥½åˆ¤æ–­ã€‚<br><br>å¦å¤–é™„ä¸Šæˆ‘çš„åº”ç”¨è¾¹åº“ä¿¡æ¯ï¼š<br>1)åº”ç”¨-&gt;Postgresql_120--&gt;MySQL_FDW--&gt;MySQL_5.7<br>2)ä¸Šé¢è®²çš„ç¬¬1ç‚¹çš„å¤±æ•ˆåŸå› :Postgresqlé€šè¿‡MySQL_FDWå–MySQLè¿™ç§åœºæ™¯æ‰è®¾ç½®æ‰§è¡Œè¶…æ—¶å¤±æ•ˆ(ç›´æ¥åº”ç”¨è¿Postgresqlæ˜¯å¯ä»¥ç”Ÿæ•ˆçš„)","like_count":0},{"had_liked":false,"id":159750,"user_name":"å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶","can_delete":false,"product_type":"c1","uid":1235692,"ip_address":"","ucode":"F266EC6B143E38","user_header":"https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg","comment_is_top":false,"comment_ctime":1575778688,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575778688","product_id":100023901,"comment_content":"  bagEntry.setState(STATE_NOT_IN_USE);requilteæ–¹æ³•é‡Œé¢å†™çš„æœ‰ç‚¹é—®é¢˜å§ï¼Œè¿™ä¸ªä¹‹å‰å·²ç»è®¾ç½®çŠ¶æ€ï¼Œåé¢forå¾ªç¯é‡Œé¢åˆ¤æ–­ä¸ç­‰äºæœªä½¿ç”¨çŠ¶æ€ï¼Œè¿™ä¸ªå¤šæ­¤ä¸€ä¸¾","like_count":0},{"had_liked":false,"id":141577,"user_name":"DFighting","can_delete":false,"product_type":"c1","uid":1233193,"ip_address":"","ucode":"F3BA2426FF8582","user_header":"https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg","comment_is_top":false,"comment_ctime":1571194198,"is_pvip":true,"replies":[{"id":"54747","content":"å…ˆäº†è§£å®ç°åŸç†ï¼Œç„¶åå†™ä¸€ä¸ªæœ€ç®€å•çš„ç¨‹åºï¼Œè°ƒè¯•è·Ÿä»£ç ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1571227543,"ip_address":"","comment_id":141577,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571194198","product_id":100023901,"comment_content":"æ³¨æ„åˆ°äº†requite()çš„ä¸€ä¸ªç»†èŠ‚ä¼˜åŒ–ï¼Œè‡ªå·±ä½¿ç”¨å®Œäº†çº¿ç¨‹åå¹¶ä¸æ˜¯ç›´æ¥äº¤è¿˜ç»™çº¿ç¨‹æ± ï¼Œè€Œæ˜¯å…ˆé—®ä¸‹æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆç›´æ¥åˆ†é…å°±å¥½ï¼Œè¿™é‡Œå°±å‡å°‘äº†ä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„æŸå¤±ã€‚ä¸è¿‡è¿™é‡Œçš„threadListåº”è¯¥åªæ˜¯ä¼šä½¿ç”¨çº¿ç¨‹æ± çš„è¿æ¥ï¼Œä¸å¯ä»¥åœ¨è¿™ä¸ªè¿æ¥ä¸Šåšä¸€äº›è‡ªå·±æ•°æ®çš„å­˜å‚¨ï¼Œå› ä¸ºå¦‚æœè¿™æ ·å°±ä¼šç»™æ¯æ¬¡è¿æ¥çš„å½’è¿˜æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…æ´—å·¥ä½œï¼Œæƒ³æ¥ä¹Ÿä¼šæ˜¯ä¸€æ¬¡æ€§èƒ½çš„æµªè´¹å§ã€‚è€å¸ˆï¼Œå…³äºè¿æ¥æ± æºç æ€ä¹ˆçœ‹å•Šï¼Œåƒå®è·µä¸‹ä»Šå¤©è¯¾å ‚ä¸Šå­¦åˆ°çš„å†…å®¹ï¼Œä½†æ˜¯ä¸åªå¦‚ä½•ä¸‹æ‰‹","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470804,"discussion_content":"å…ˆäº†è§£å®ç°åŸç†ï¼Œç„¶åå†™ä¸€ä¸ªæœ€ç®€å•çš„ç¨‹åºï¼Œè°ƒè¯•è·Ÿä»£ç ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571227543,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125263,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":false,"comment_ctime":1566133974,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1566133974","product_id":100023901,"comment_content":"è€å¸ˆï¼Œæ‚¨å¥½ï¼Œä¸‹é¢è¿™ä¸€æ®µæ²¡æœ‰çœ‹æ‡‚ï¼š<br>else if ((i &amp; 0xff) == 0xff) {<br>      parkNanos(MICROSECONDS.toNanos(10));<br> }<br>ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·ä¸€æ®µå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1561805,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/qOYxfAJhznzg3ibHQmOOh2IRTficpPDtNmZwb0MR77cg35vt60VtcX89w4lvnRg4aIDE1ZIpib2rcQpbNicQg1Vicgg/132","nickname":"é»„æ›™å…‰","note":"","ucode":"FEBF44C4230B57","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577046,"discussion_content":"0xffæ˜¯16è¿›åˆ¶ï¼Œè¡¨ç¤º255ã€‚æ„æ€æ˜¯è‡ªé€‰åˆ°255æ¬¡å°±ä¼‘çœ 10æ¯«ç§’","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655900090,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":118230,"user_name":"ä¸šä½™è‰","can_delete":false,"product_type":"c1","uid":1126538,"ip_address":"","ucode":"99BDC1E629049D","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg","comment_is_top":false,"comment_ctime":1564298500,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564298500","product_id":100023901,"comment_content":"çœ‹ä¸ä¸Šçœ¼çš„ä¼˜åŒ–ï¼Œå±…ç„¶å¸¦æ¥äº†å·¨å¤§çš„æ€§èƒ½æå‡ã€‚","like_count":0},{"had_liked":false,"id":103499,"user_name":"è€Œç«‹æ–‹","can_delete":false,"product_type":"c1","uid":1087258,"ip_address":"","ucode":"5FED6E9E148195","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg","comment_is_top":false,"comment_ctime":1560468909,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560468909","product_id":100023901,"comment_content":"faststatementlist","like_count":0},{"had_liked":false,"id":100294,"user_name":"QQæ€ª","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1559523733,"is_pvip":false,"replies":[{"id":"36131","content":"æˆ‘è§‰å¾—å¯ä»¥å¼€å¿ƒåœ°ç¬‘ä¸€ä¸‹ï¼Œç„¶åï¼Œå°±æ²¡ç„¶åäº†ğŸ˜‚ğŸ˜‚ğŸ˜‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1559541225,"ip_address":"","comment_id":100294,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1559523733","product_id":100023901,"comment_content":"æ ¹æœ¬çœ‹ä¸å¤Ÿï¼Œå¼ºçƒˆå»ºè®®è€å¸ˆå†æ¥ä¸€ç¯‡","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452489,"discussion_content":"æˆ‘è§‰å¾—å¯ä»¥å¼€å¿ƒåœ°ç¬‘ä¸€ä¸‹ï¼Œç„¶åï¼Œå°±æ²¡ç„¶åäº†ğŸ˜‚ğŸ˜‚ğŸ˜‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1559541225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":100187,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1559473364,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559473364","product_id":100023901,"comment_content":"æ‰“å¡ï¼","like_count":0},{"had_liked":false,"id":100058,"user_name":"é¾™çŒ«","can_delete":false,"product_type":"c1","uid":1112490,"ip_address":"","ucode":"FD726CC969EF9C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f9/aa/3e80212e.jpg","comment_is_top":false,"comment_ctime":1559406882,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559406882","product_id":100023901,"comment_content":"éœ€è¦å¤šçœ‹å‡ é","like_count":0},{"had_liked":false,"id":99983,"user_name":"è‹å¿—è¾‰","can_delete":false,"product_type":"c1","uid":1068927,"ip_address":"","ucode":"39B25CE21C04EE","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/7f/5dc11380.jpg","comment_is_top":false,"comment_ctime":1559378212,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559378212","product_id":100023901,"comment_content":"è¿™æ ·ä¼šä¸ä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹æŒæœ‰50ä¸ªä»¥ä¸‹é“¾æ¥ï¼Œè€Œä¸”æ¯ä¸ªé“¾æ¥å¯èƒ½åœ¨å¤šä¸ªçº¿ç¨‹å…±å­˜","like_count":0},{"had_liked":false,"id":99971,"user_name":"æ§‘Â·å…ˆç”Ÿ","can_delete":false,"product_type":"c1","uid":1445744,"ip_address":"","ucode":"897F0475592E3A","user_header":"https://static001.geekbang.org/account/avatar/00/16/0f/70/f59db672.jpg","comment_is_top":false,"comment_ctime":1559374065,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1559374065","product_id":100023901,"comment_content":"é¢å‘ä¸šåŠ¡è®¾è®¡æ•°æ®ç»“æ„ï¼ŒèµğŸ‘","like_count":0},{"had_liked":false,"id":99891,"user_name":"ä¸œæ–¹å¥‡éª¥","can_delete":false,"product_type":"c1","uid":1354850,"ip_address":"","ucode":"DEE7085F7E55A4","user_header":"https://static001.geekbang.org/account/avatar/00/14/ac/62/37912d51.jpg","comment_is_top":false,"comment_ctime":1559353948,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1559353948","product_id":100023901,"comment_content":"ä»¥å‰åªçŸ¥é“ArrayListåˆ é™¤æ•ˆç‡ä½ï¼Œè¿™ä¼˜åŒ–æ€æƒ³ç»“åˆäº†ä¸šåŠ¡åœºæ™¯ï¼Œçœ‹èµ·æ¥ç®€å•ä¸è¯´å´ä¸çŸ¥é“ã€‚é¡¹ç›®è¿˜åœ¨springboot1.xç”¨çš„é˜¿é‡Œå·´å·´Druidï¼Œåé¢æ–°é¡¹ç›®2.xç”¨HaKriCPæ€§èƒ½åº”è¯¥ä¼šæ›´å¥½ã€‚","like_count":0},{"had_liked":false,"id":99873,"user_name":"å†¯ä¼ åš","can_delete":false,"product_type":"c1","uid":1177787,"ip_address":"","ucode":"91B9A1EF0FF042","user_header":"https://static001.geekbang.org/account/avatar/00/11/f8/bb/8b2ba45d.jpg","comment_is_top":false,"comment_ctime":1559350147,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559350147","product_id":100023901,"comment_content":"çº¿ç¨‹æœ¬åœ°çš„é“¾æ¥æ˜¯å¦‚ä½•è¢«çªƒå–çš„å‘¢ï¼Ÿ","like_count":0}]}