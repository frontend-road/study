{"id":412483,"title":"41 | è½¯ä»¶éƒ¨ç½²å®æˆ˜ï¼ˆä¸­ï¼‰ï¼šIAM ç³»ç»Ÿç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®æˆ˜","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘ä»‹ç»äº†IAMéƒ¨ç½²ç”¨åˆ°çš„ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ŒNginxå’ŒKeepalivedã€‚é‚£ä¹ˆè¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨Nginxå’ŒKeepalivedæ¥éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ã€‚ä¸‹ä¸€è®²ï¼Œæˆ‘å†ä»‹ç»ä¸‹IAMåº”ç”¨å®‰å…¨å’Œå¼¹æ€§ä¼¸ç¼©èƒ½åŠ›çš„æ„å»ºæ–¹å¼ã€‚</p><p>è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ä¸‹é¢å››ä¸ªæ­¥éª¤æ¥éƒ¨ç½²IAMåº”ç”¨ï¼š</p><ol>\n<li>åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ä¸­çš„æœåŠ¡ã€‚</li>\n<li>é…ç½®Nginxï¼Œå®ç°åå‘ä»£ç†åŠŸèƒ½ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Nginxæ¥è®¿é—®éƒ¨ç½²åœ¨å†…ç½‘çš„IAMæœåŠ¡ã€‚</li>\n<li>é…ç½®Nginxï¼Œå®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚é€šè¿‡è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æœåŠ¡çš„æ°´å¹³æ‰©ç¼©å®¹ï¼Œä½¿IAMåº”ç”¨å…·å¤‡é«˜å¯ç”¨èƒ½åŠ›ã€‚</li>\n<li>é…ç½®Keepalivedï¼Œå®ç°Nginxçš„é«˜å¯ç”¨ã€‚é€šè¿‡Nginx + Keepalivedçš„ç»„åˆï¼Œå¯ä»¥å®ç°æ•´ä¸ªåº”ç”¨æ¶æ„çš„é«˜å¯ç”¨ã€‚</li>\n</ol><h2>éƒ¨ç½²IAMåº”ç”¨</h2><p>éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ï¼Œéœ€è¦è‡³å°‘ä¸¤ä¸ªèŠ‚ç‚¹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æŒ‰ç…§å…ˆåé¡ºåºï¼Œåˆ†åˆ«åœ¨<code>10.0.4.20</code>å’Œ<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ã€‚</p><h3>åœ¨<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨</h3><p>é¦–å…ˆï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•åœ¨<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ã€‚</p><p>æˆ‘ä»¬è¦åœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸Šéƒ¨ç½²å¦‚ä¸‹ç»„ä»¶ï¼š</p><ul>\n<li>iam-apiserver</li>\n<li>iam-authz-server</li>\n<li>iam-pump</li>\n<li>MariaDB</li>\n<li>Redis</li>\n<li>MongoDB</li>\n</ul><!-- [[[read_end]]] --><p>è¿™äº›ç»„ä»¶çš„éƒ¨ç½²æ–¹å¼ï¼Œ<a href=\"https://time.geekbang.org/column/article/378082\">03è®²</a> æœ‰ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†è¯´æ˜ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®MariaDBï¼Œç»™æ¥è‡ªäº<code>10.0.4.21</code>æœåŠ¡å™¨çš„æ•°æ®åº“è¿æ¥æˆæƒï¼Œæˆæƒå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre><code class=\"language-bash\">$ mysql -hlocalhost -P3306 -uroot -proot # å…ˆä»¥rootç”¨æˆ·ç™»é™†æ•°æ®åº“\nMariaDB [(none)]&gt; grant all on iam.* TO iam@10.0.4.21 identified by 'iam1234';\nQuery OK, 0 rows affected (0.000 sec)\n\nMariaDB [(none)]&gt; flush privileges;\nQuery OK, 0 rows affected (0.000 sec)\n</code></pre><h3>åœ¨<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨</h3><p>ç„¶åï¼Œåœ¨<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šå®‰è£…å¥½iam-apiserverã€iam-authz-server å’Œ iam-pumpã€‚è¿™äº›ç»„ä»¶é€šè¿‡<code>10.0.4.20</code> IPåœ°å€ï¼Œè¿æ¥<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šçš„MariaDBã€Rediså’ŒMongoDBã€‚</p><h2>é…ç½®Nginxä½œä¸ºåå‘ä»£ç†</h2><p>å‡å®šè¦è®¿é—®çš„API Serverå’ŒIAM Authorization Serverçš„åŸŸååˆ†åˆ«ä¸º<code>iam.api.marmotedu.com</code>å’Œ<code>iam.authz.marmotedu.com</code>ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«ä¸ºiam-apiserverå’Œiam-authz-serveré…ç½®Nginxåå‘ä»£ç†ã€‚æ•´ä¸ªé…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸º5æ­¥ï¼ˆåœ¨<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šæ“ä½œï¼‰ã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼Œé…ç½®iam-apiserverã€‚</strong></p><p>æ–°å»ºNginxé…ç½®æ–‡ä»¶<code>/etc/nginx/conf.d/iam-apiserver.conf</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">server {\n&nbsp; &nbsp; listen&nbsp; &nbsp; &nbsp; &nbsp;80;\n&nbsp; &nbsp; server_name&nbsp; iam.api.marmotedu.com;\n&nbsp; &nbsp; root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/share/nginx/html;\n&nbsp; &nbsp; location / {\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-Host $http_host;\n&nbsp; &nbsp; \tproxy_set_header X-Real-IP $remote_addr;\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n&nbsp; &nbsp; \tproxy_pass&nbsp; http://127.0.0.1:8080/;\n&nbsp; &nbsp; \tclient_max_body_size 5m;\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 404 /404.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /40x.html {\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 500 502 503 504 /50x.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /50x.html {\n&nbsp; &nbsp; }\n}\n</code></pre><p>æœ‰å‡ ç‚¹ä½ åœ¨é…ç½®æ—¶éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œè¯´æ˜ä¸‹ã€‚</p><ul>\n<li><code>server_name</code>éœ€è¦ä¸º<code>iam.api.marmotedu.com</code>ï¼Œæˆ‘ä»¬é€šè¿‡<code>iam.api.marmotedu.com</code>è®¿é—®iam-apiserverã€‚</li>\n<li>iam-apiserveré»˜è®¤å¯åŠ¨çš„ç«¯å£ä¸º<code>8080</code>ã€‚</li>\n<li>ç”±äºNginxé»˜è®¤å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°ä¸º<code>1MB</code>ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½å¤ªå°ï¼Œæ‰€ä»¥è¿™é‡Œå°†æ­¤é™åˆ¶æ”¹ä¸º5MBï¼ˆ<code>client_max_body_size 5m</code>ï¼‰ã€‚å¦‚æœéœ€è¦ä¸Šä¼ å›¾ç‰‡ä¹‹ç±»çš„ï¼Œå¯èƒ½éœ€è¦è®¾ç½®æˆæ›´å¤§çš„å€¼ï¼Œæ¯”å¦‚<code>50m</code>ã€‚</li>\n<li>server_nameç”¨æ¥è¯´æ˜è®¿é—®NginxæœåŠ¡å™¨çš„åŸŸåï¼Œä¾‹å¦‚<code>curl -H 'Host: iam.api.marmotedu.com' http://x.x.x.x:80/healthz</code>ï¼Œ<code>x.x.x.x</code>ä¸ºNginxæœåŠ¡å™¨çš„IPåœ°å€ã€‚</li>\n<li>proxy_passè¡¨ç¤ºåå‘ä»£ç†çš„è·¯å¾„ã€‚å› ä¸ºè¿™é‡Œæ˜¯æœ¬æœºçš„iam-apiserveræœåŠ¡ï¼Œæ‰€ä»¥IPä¸º<code>127.0.0.1</code>ã€‚ç«¯å£è¦å’ŒAPIæœåŠ¡ç«¯å£ä¸€è‡´ï¼Œä¸º<code>8080</code>ã€‚</li>\n</ul><p>æœ€åè¿˜è¦æé†’ä¸‹ï¼Œå› ä¸º Nginx é…ç½®é€‰é¡¹æ¯”è¾ƒå¤šï¼Œè·Ÿå®é™…éœ€æ±‚å’Œç¯å¢ƒæœ‰å…³ï¼Œæ‰€ä»¥è¿™é‡Œçš„é…ç½®æ˜¯åŸºç¡€çš„ã€æœªç»ä¼˜åŒ–çš„é…ç½®ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ä½ å†åšè°ƒèŠ‚ã€‚</p><p><strong>ç¬¬äºŒæ­¥ï¼Œé…ç½®iam-authz-serverã€‚</strong></p><p>æ–°å»ºNginxé…ç½®æ–‡ä»¶<code>/etc/nginx/conf.d/iam-authz-server.conf</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">server {\n&nbsp; &nbsp; listen&nbsp; &nbsp; &nbsp; &nbsp;80;\n&nbsp; &nbsp; server_name&nbsp; iam.authz.marmotedu.com;\n&nbsp; &nbsp; root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/share/nginx/html;\n&nbsp; &nbsp; location / {\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-Host $http_host;\n&nbsp; &nbsp; \tproxy_set_header X-Real-IP $remote_addr;\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n&nbsp; &nbsp; \tproxy_pass&nbsp; http://127.0.0.1:9090/;\n&nbsp; &nbsp; \tclient_max_body_size 5m;\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 404 /404.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /40x.html {\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 500 502 503 504 /50x.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /50x.html {\n&nbsp; &nbsp; }\n}\n</code></pre><p>ä¸‹é¢æ˜¯ä¸€äº›é…ç½®è¯´æ˜ã€‚</p><ul>\n<li>server_nameéœ€è¦ä¸º<code>iam.authz.marmotedu.com</code>ï¼Œæˆ‘ä»¬é€šè¿‡<code>iam.authz.marmotedu.com</code>è®¿é—®iam-authz-serverã€‚</li>\n<li>iam-authz-serveré»˜è®¤å¯åŠ¨çš„ç«¯å£ä¸º<code>9090</code>ã€‚</li>\n<li>å…¶ä»–é…ç½®è·Ÿ<code>/etc/nginx/conf.d/iam-apiserver.conf</code>ä¸€è‡´ã€‚</li>\n</ul><p><strong>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š</strong></p><pre><code class=\"language-bash\">$ sudo systemctl restart nginx\n</code></pre><p><strong>ç¬¬å››æ­¥ï¼Œåœ¨/etc/hostsä¸­è¿½åŠ ä¸‹é¢ä¸¤è¡Œï¼š</strong></p><pre><code class=\"language-bash\">127.0.0.1 iam.api.marmotedu.com\n127.0.0.1 iam.authz.marmotedu.com\n</code></pre><p><strong>ç¬¬äº”æ­¥ï¼Œå‘é€HTTPè¯·æ±‚ï¼š</strong></p><pre><code class=\"language-bash\">$ curl http://iam.api.marmotedu.com/healthz\n{\"status\":\"ok\"}\n$ curl http://iam.authz.marmotedu.com/healthz\n{\"status\":\"ok\"}\n</code></pre><p>æˆ‘ä»¬åˆ†åˆ«è¯·æ±‚iam-apiserverå’Œiam-authz-serverçš„å¥åº·æ£€æŸ¥æ¥å£ï¼Œè¾“å‡ºäº†<code>{\"status\":\"ok\"}</code>ï¼Œè¯´æ˜æˆ‘ä»¬å¯ä»¥æˆåŠŸé€šè¿‡ä»£ç†è®¿é—®åç«¯çš„APIæœåŠ¡ã€‚</p><p>åœ¨ç”¨curlè¯·æ±‚<code>http://iam.api.marmotedu.com/healthz</code>åï¼Œåç«¯çš„è¯·æ±‚æµç¨‹å®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼š</p><ol>\n<li>å› ä¸ºåœ¨<code>/etc/hosts</code>ä¸­é…ç½®äº†<code>127.0.0.1 iam.api.marmotedu.com</code>ï¼Œæ‰€ä»¥è¯·æ±‚<code>http://iam.api.marmotedu.com/healthz</code>å®é™…ä¸Šæ˜¯è¯·æ±‚æœ¬æœºçš„Nginxç«¯å£ï¼ˆ<code>127.0.0.1:80</code>ï¼‰ã€‚</li>\n<li>Nginxåœ¨æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè§£æè¯·æ±‚ï¼Œå¾—åˆ°è¯·æ±‚åŸŸåä¸º<code>iam.api.marmotedu.com</code>ã€‚æ ¹æ®è¯·æ±‚åŸŸåå»åŒ¹é… Nginxçš„serveré…ç½®ï¼ŒåŒ¹é…åˆ°<code>server_name  iam.api.marmotedu.com;</code>é…ç½®ã€‚</li>\n<li>åŒ¹é…åˆ°serveråï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°è¯¥serverçš„<code>proxy_pass</code>è·¯å¾„ã€‚</li>\n<li>ç­‰å¾…APIæœåŠ¡å™¨è¿”å›ç»“æœï¼Œå¹¶è¿”å›å®¢æˆ·ç«¯ã€‚</li>\n</ol><h2>é…ç½®Nginxä½œä¸ºè´Ÿè½½å‡è¡¡</h2><p>è¿™é—¨è¯¾é‡‡ç”¨Nginxè½®è¯¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥è½¬å‘è¯·æ±‚ã€‚è´Ÿè½½å‡è¡¡éœ€è¦è‡³å°‘ä¸¤å°æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä¼šåˆ†åˆ«åœ¨<code>10.0.4.20</code>å’Œ<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚ä¸‹é¢æˆ‘åˆ†åˆ«æ¥ä»‹ç»ä¸‹å¦‚ä½•é…ç½®è¿™ä¸¤å°æœåŠ¡å™¨ï¼Œå¹¶éªŒè¯é…ç½®æ˜¯å¦æˆåŠŸã€‚</p><h3><code>10.0.4.20</code>æœåŠ¡å™¨é…ç½®</h3><p>ç™»é™†<code>10.0.4.20</code>æœåŠ¡å™¨ï¼Œåœ¨<code>/etc/nginx/nginx.conf</code>ä¸­æ·»åŠ upstreamé…ç½®ï¼Œé…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸º3æ­¥ã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼Œåœ¨</strong><code>/etc/nginx/nginx.conf</code><strong>ä¸­æ·»åŠ upstreamï¼š</strong></p><pre><code class=\"language-plain\">http {\n&nbsp; &nbsp; log_format&nbsp; main&nbsp; '$remote_addr - $remote_user [$time_local] \"$request\" '\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '$status $body_bytes_sent \"$http_referer\" '\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n&nbsp; &nbsp; access_log&nbsp; /var/log/nginx/access.log&nbsp; main;\n\n&nbsp; &nbsp; sendfile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on;\n&nbsp; &nbsp; tcp_nopush&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on;\n&nbsp; &nbsp; tcp_nodelay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on;\n&nbsp; &nbsp; keepalive_timeout&nbsp; &nbsp;65;\n&nbsp; &nbsp; types_hash_max_size 2048;\n\n&nbsp; &nbsp; include&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/etc/nginx/mime.types;\n&nbsp; &nbsp; default_type&nbsp; &nbsp; &nbsp; &nbsp; application/octet-stream;\n\n&nbsp; &nbsp; # Load modular configuration files from the /etc/nginx/conf.d directory.\n&nbsp; &nbsp; # See http://nginx.org/en/docs/ngx_core_module.html#include\n&nbsp; &nbsp; # for more information.\n&nbsp; &nbsp; include /etc/nginx/conf.d/*.conf;\n&nbsp; &nbsp; upstream iam.api.marmotedu.com {\n&nbsp; &nbsp; &nbsp; &nbsp; server 127.0.0.1:8080\n&nbsp; &nbsp; &nbsp; &nbsp; server 10.0.4.21:8080\n&nbsp; &nbsp; }\n&nbsp; &nbsp; upstream iam.authz.marmotedu.com {\n&nbsp; &nbsp; &nbsp; &nbsp; server 127.0.0.1:9090\n&nbsp; &nbsp; &nbsp; &nbsp; server 10.0.4.21:9090\n&nbsp; &nbsp; }\n}\n</code></pre><p>é…ç½®è¯´æ˜ï¼š</p><ul>\n<li>upstreamæ˜¯é…ç½®åœ¨<code>/etc/nginx/nginx.conf</code>æ–‡ä»¶ä¸­çš„<code>http{ â€¦ }</code>éƒ¨åˆ†çš„ã€‚</li>\n<li>å› ä¸ºæˆ‘ä»¬è¦åˆ†åˆ«ä¸ºiam-apiserverå’Œiam-authz-serveré…ç½®è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªupstreamï¼Œåˆ†åˆ«æ˜¯<code>iam.api.marmotedu.com</code>å’Œ<code>iam.authz.marmotedu.com</code>ã€‚ä¸ºäº†ä¾¿äºè¯†åˆ«ï¼Œupstreamåç§°å’ŒåŸŸåæœ€å¥½ä¿æŒä¸€è‡´ã€‚</li>\n<li>åœ¨upstreamä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«æ·»åŠ æ‰€æœ‰çš„iam-apiserverå’Œiam-authz-serverçš„åç«¯ï¼ˆ<code>ip:port</code>ï¼‰ï¼Œæœ¬æœºçš„åç«¯ä¸ºäº†è®¿é—®æ›´å¿«ï¼Œå¯ä»¥ä½¿ç”¨<code>127.0.0.1:&lt;port&gt;</code>ï¼Œå…¶ä»–æœºå™¨çš„åç«¯ï¼Œéœ€è¦ä½¿ç”¨<code>&lt;å†…ç½‘&gt;:port</code>ï¼Œä¾‹å¦‚<code>10.0.4.21:8080</code>ã€<code>10.0.4.21:9090</code>ã€‚</li>\n</ul><p><strong>ç¬¬äºŒæ­¥ï¼Œä¿®æ”¹proxy_passã€‚</strong></p><p>ä¿®æ”¹<code>/etc/nginx/conf.d/iam-apiserver.conf</code>æ–‡ä»¶ï¼Œå°†<code>proxy_pass</code>ä¿®æ”¹ä¸ºï¼š</p><pre><code class=\"language-plain\">proxy_pass http://iam.api.marmotedu.com/;\n</code></pre><p>ä¿®æ”¹<code>/etc/nginx/conf.d/iam-authz-server.conf</code>æ–‡ä»¶ï¼Œå°†<code>proxy_pass</code>ä¿®æ”¹ä¸ºï¼š</p><pre><code class=\"language-plain\">proxy_pass http://iam.authz.marmotedu.com/;\n</code></pre><p>å½“Nginxè½¬å‘åˆ°<code>http://iam.api.marmotedu.com/</code>åŸŸåæ—¶ï¼Œä¼šä»<code>iam.api.marmotedu.com</code> upstreamé…ç½®çš„åç«¯åˆ—è¡¨ä¸­ï¼Œæ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰å–ä¸€ä¸ªåç«¯ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘è¿‡å»ã€‚è½¬å‘<code>http://iam.authz.marmotedu.com/</code>åŸŸåçš„é€»è¾‘ä¹Ÿä¸€æ ·ã€‚</p><p><strong>ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š</strong></p><pre><code class=\"language-bash\">$ sudo systemctl restart nginx\n</code></pre><p>æœ€ç»ˆé…ç½®å¥½çš„é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›ï¼ˆä¿å­˜åœ¨<a href=\"https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.20\">configs/ha/10.0.4.20</a>ç›®å½•ä¸‹ï¼‰ï¼š</p><ul>\n<li>nginx.confï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/nginx.conf\">configs/ha/10.0.4.20/nginx.conf</a>ã€‚</li>\n<li>iam-apiserver.confï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-apiserver.conf\">configs/ha/10.0.4.20/iam-apiserver.conf</a>ã€‚</li>\n<li>iam-authz-server.confï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-authz-server.conf\">configs/ha/10.0.4.20/iam-authz-server.conf</a>ã€‚</li>\n</ul><h3><code>10.0.4.21</code>æœåŠ¡å™¨é…ç½®</h3><p>ç™»é™†<code>10.0.4.21</code>æœåŠ¡å™¨ï¼Œåœ¨<code>/etc/nginx/nginx.conf</code>ä¸­æ·»åŠ upstreamé…ç½®ã€‚é…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢4æ­¥ã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼Œåœ¨</strong><code>/etc/nginx/nginx.conf</code><strong>ä¸­æ·»åŠ upstreamï¼š</strong></p><pre><code class=\"language-plain\">http {\n&nbsp; &nbsp; log_format&nbsp; main&nbsp; '$remote_addr - $remote_user [$time_local] \"$request\" '\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '$status $body_bytes_sent \"$http_referer\" '\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n&nbsp; &nbsp; access_log&nbsp; /var/log/nginx/access.log&nbsp; main;\n\n&nbsp; &nbsp; sendfile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on;\n&nbsp; &nbsp; tcp_nopush&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on;\n&nbsp; &nbsp; tcp_nodelay&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on;\n&nbsp; &nbsp; keepalive_timeout&nbsp; &nbsp;65;\n&nbsp; &nbsp; types_hash_max_size 2048;\n\n&nbsp; &nbsp; include&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/etc/nginx/mime.types;\n&nbsp; &nbsp; default_type&nbsp; &nbsp; &nbsp; &nbsp; application/octet-stream;\n\n&nbsp; &nbsp; # Load modular configuration files from the /etc/nginx/conf.d directory.\n&nbsp; &nbsp; # See http://nginx.org/en/docs/ngx_core_module.html#include\n&nbsp; &nbsp; # for more information.\n&nbsp; &nbsp; include /etc/nginx/conf.d/*.conf;\n&nbsp; &nbsp; upstream iam.api.marmotedu.com {\n&nbsp; &nbsp; &nbsp; &nbsp; server 127.0.0.1:8080\n&nbsp; &nbsp; &nbsp; &nbsp; server 10.0.4.20:8080\n&nbsp; &nbsp; }\n&nbsp; &nbsp; upstream iam.authz.marmotedu.com {\n&nbsp; &nbsp; &nbsp; &nbsp; server 127.0.0.1:9090\n&nbsp; &nbsp; &nbsp; &nbsp; server 10.0.4.20:9090\n&nbsp; &nbsp; }\n}\n</code></pre><p>upstreamä¸­ï¼Œéœ€è¦é…ç½®<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šçš„iam-apiserverå’Œiam-authz-serverçš„åç«¯ï¼Œä¾‹å¦‚<code>10.0.4.20:8080</code>ã€<code>10.0.4.20:9090</code>ã€‚</p><p><strong>ç¬¬äºŒæ­¥ï¼Œåˆ›å»º</strong><code>/etc/nginx/conf.d/iam-apiserver.conf</code><strong>æ–‡ä»¶</strong>ï¼ˆiam-apiserverçš„åå‘ä»£ç†+è´Ÿè½½å‡è¡¡é…ç½®ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">server {\n&nbsp; &nbsp; listen&nbsp; &nbsp; &nbsp; &nbsp;80;\n&nbsp; &nbsp; server_name&nbsp; iam.api.marmotedu.com;\n&nbsp; &nbsp; root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/share/nginx/html;\n&nbsp; &nbsp; location / {\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-Host $http_host;\n&nbsp; &nbsp; \tproxy_set_header X-Real-IP $remote_addr;\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n&nbsp; &nbsp; \tproxy_pass&nbsp; http://iam.api.marmotedu.com/;\n&nbsp; &nbsp; \tclient_max_body_size 5m;\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 404 /404.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /40x.html {\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 500 502 503 504 /50x.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /50x.html {\n&nbsp; &nbsp; }\n}\n</code></pre><p><strong>ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»º</strong><code>/etc/nginx/conf.d/iam-authz-server</code><strong>æ–‡ä»¶</strong>ï¼ˆiam-authz-serverçš„åå‘ä»£ç†+è´Ÿè½½å‡è¡¡é…ç½®ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">server {\n&nbsp; &nbsp; listen&nbsp; &nbsp; &nbsp; &nbsp;80;\n&nbsp; &nbsp; server_name&nbsp; iam.authz.marmotedu.com;\n&nbsp; &nbsp; root&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/share/nginx/html;\n&nbsp; &nbsp; location / {\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-Host $http_host;\n&nbsp; &nbsp; \tproxy_set_header X-Real-IP $remote_addr;\n&nbsp; &nbsp; \tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n&nbsp; &nbsp; \tproxy_pass&nbsp; http://iam.authz.marmotedu.com/;\n&nbsp; &nbsp; \tclient_max_body_size 5m;\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 404 /404.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /40x.html {\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; error_page 500 502 503 504 /50x.html;\n&nbsp; &nbsp; &nbsp; &nbsp; location = /50x.html {\n&nbsp; &nbsp; }\n}\n\n</code></pre><p><strong>ç¬¬å››æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š</strong></p><pre><code class=\"language-bash\">$ sudo systemctl restart nginx\n</code></pre><p>æœ€ç»ˆé…ç½®å¥½çš„é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›ï¼ˆä¿å­˜åœ¨<a href=\"https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.21\">configs/ha/10.0.4.21</a>ç›®å½•ä¸‹ï¼‰ï¼š</p><ul>\n<li>nginx.confï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/nginx.conf\">configs/ha/10.0.4.21/nginx.conf</a>ã€‚</li>\n<li>iam-apiserver.confï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-apiserver.conf\">configs/ha/10.0.4.21/iam-apiserver.conf</a>ã€‚</li>\n<li>iam-authz-server.confï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-authz-server.conf\">configs/ha/10.0.4.21/iam-authz-server.conf</a>ã€‚</li>\n</ul><h3>æµ‹è¯•è´Ÿè½½å‡è¡¡</h3><p>ä¸Šé¢ï¼Œæˆ‘ä»¬é…ç½®äº†Nginxè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦æµ‹è¯•ä¸‹æ˜¯å¦é…ç½®æˆåŠŸã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡Œæµ‹è¯•è„šæœ¬ï¼ˆ</strong><a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/test/nginx/loadbalance.sh\">test/nginx/loadbalance.sh</a><strong>ï¼‰ï¼š</strong></p><pre><code class=\"language-bash\">#!/usr/bin/env bash\n\nfor domain in iam.api.marmotedu.com iam.authz.marmotedu.com\ndo\n  for n in $(seq 1 1 10)\n  do\n    echo $domain\n    nohup curl http://${domain}/healthz &amp;&gt;/dev/null &amp;\n  done\ndone\n</code></pre><p><strong>ç¬¬äºŒæ­¥ï¼Œåˆ†åˆ«æŸ¥çœ‹iam-apiserverå’Œiam-authz-serverçš„æ—¥å¿—ã€‚</strong></p><p>è¿™é‡Œæˆ‘å±•ç¤ºä¸‹iam-apiserverçš„æ—¥å¿—ï¼ˆiam-authz-serverçš„æ—¥å¿—ä½ å¯è‡ªè¡ŒæŸ¥çœ‹ï¼‰ã€‚</p><p><code>10.0.4.20</code>æœåŠ¡å™¨çš„iam-apiserveræ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/58/26/58d072c92552fa3068e3ef3acd0ed726.png?wh=1920x498\" alt=\"å›¾ç‰‡\"></p><p><code>10.0.4.21</code>æœåŠ¡å™¨çš„iam-apiserveræ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/19/85/199066c65ff60007f80f3c2dyy11c785.png?wh=1920x482\" alt=\"å›¾ç‰‡\"></p><p>é€šè¿‡ä¸Šé¢ä¸¤å¼ å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ°<code>10.0.4.20</code>å’Œ<code>10.0.4.21</code>å„æ”¶åˆ°<code>5</code>ä¸ª<code>/healthz</code>è¯·æ±‚ï¼Œè¯´æ˜è´Ÿè½½å‡è¡¡é…ç½®æˆåŠŸã€‚</p><h2>é…ç½®Keepalived</h2><p>åœ¨ <a href=\"https://time.geekbang.org/column/article/411663\">40è®²</a>ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨<code>10.0.4.20</code>å’Œ<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šå®‰è£…äº†Keepalivedã€‚è¿™é‡Œï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•é…ç½®Keepalivedï¼Œå®ç°Nginxçš„é«˜å¯ç”¨ã€‚ä¸ºäº†é¿å…æ•…éšœæ¢å¤æ—¶ï¼ŒVIPåˆ‡æ¢é€ æˆçš„æœåŠ¡å»¶æ—¶ï¼Œè¿™ä¸€è®²é‡‡ç”¨Keepalivedçš„éæŠ¢å æ¨¡å¼ã€‚</p><p>é…ç½®Keepalivedçš„æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œåˆ†ä¸ºåˆ›å»ºè…¾è®¯äº‘HAVIPã€ä¸»æœåŠ¡å™¨é…ç½®ã€å¤‡æœåŠ¡å™¨é…ç½®ã€æµ‹è¯•Keepalivedã€VIPç»‘å®šå…¬ç½‘IPå’Œæµ‹è¯•å…¬ç½‘è®¿é—®å…­å¤§æ­¥ï¼Œæ¯ä¸€æ­¥ä¸­éƒ½æœ‰å¾ˆå¤šå°æ­¥éª¤ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥åœ°çœ‹ä¸‹ã€‚</p><h3><strong>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè…¾è®¯äº‘HAVIP</strong></h3><p>å…¬æœ‰äº‘å‚å•†çš„æ™®é€šå†…ç½‘IPï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼ˆå¦‚é¿å…ARPæ¬ºéª—ç­‰ï¼‰ï¼Œä¸æ”¯æŒä¸»æœºé€šè¿‡ARPå®£å‘ŠIP ã€‚å¦‚æœç”¨æˆ·ç›´æ¥åœ¨<code>keepalived.conf</code>æ–‡ä»¶ä¸­æŒ‡å®šä¸€ä¸ªæ™®é€šå†…ç½‘IPä¸ºvirtual IPï¼Œå½“Keepalivedå°†virtual IPä»MASTERæœºå™¨åˆ‡æ¢åˆ°BACKUPæœºå™¨æ—¶ï¼Œå°†æ— æ³•æ›´æ–°IPå’ŒMACåœ°å€çš„æ˜ å°„ï¼Œè€Œéœ€è¦è°ƒAPIæ¥è¿›è¡ŒIPåˆ‡æ¢ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œçš„VIPéœ€è¦ç”³è¯·è…¾è®¯äº‘çš„HAVIPã€‚</p><p>ç”³è¯·çš„æµç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢4æ­¥ï¼š</p><ol>\n<li>ç™»å½•ç§æœ‰ç½‘ç»œæ§åˆ¶å°<strong>ã€‚</strong></li>\n<li>åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘&gt;ã€é«˜å¯ç”¨è™šæ‹ŸIPã€‘ã€‚</li>\n<li>åœ¨HAVIPç®¡ç†é¡µé¢ï¼Œé€‰æ‹©æ‰€åœ¨åœ°åŸŸï¼Œå•å‡»ã€ç”³è¯·ã€‘ã€‚</li>\n<li>åœ¨å¼¹å‡ºçš„ã€ç”³è¯·é«˜å¯ç”¨è™šæ‹ŸIPã€‘å¯¹è¯æ¡†ä¸­è¾“å…¥åç§°ï¼Œé€‰æ‹©HAVIPæ‰€åœ¨çš„ç§æœ‰ç½‘ç»œå’Œå­ç½‘ç­‰ä¿¡æ¯ï¼Œå•å‡»ã€ç¡®å®šã€‘å³å¯ã€‚</li>\n</ol><p>è¿™é‡Œé€‰æ‹©çš„ç§æœ‰ç½‘ç»œå’Œå­ç½‘ï¼Œéœ€è¦å’Œ<code>10.0.4.20</code>ã€<code>10.0.4.21</code>ç›¸åŒã€‚HAVIP çš„ IP åœ°å€å¯ä»¥è‡ªåŠ¨åˆ†é…ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å¡«å†™ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨å¡«å†™ä¸º10.0.4.99ã€‚ç”³è¯·é¡µé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a4/11/a49d6e7e080d658392dbb144a1560811.png?wh=827x1016\" alt=\"å›¾ç‰‡\"></p><h3>ç¬¬äºŒæ­¥ï¼šä¸»æœåŠ¡å™¨é…ç½®</h3><p>è¿›è¡Œä¸»æœåŠ¡å™¨é…ç½®ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤æ­¥ã€‚</p><p><strong>é¦–å…ˆï¼Œä¿®æ”¹Keepalivedé…ç½®æ–‡ä»¶ã€‚</strong></p><p>ç™»é™†æœåŠ¡å™¨<code>10.0.4.20</code>ï¼Œç¼–è¾‘<code>/etc/keepalived/keepalived.conf</code>ï¼Œä¿®æ”¹é…ç½®ï¼Œä¿®æ”¹åé…ç½®å†…å®¹å¦‚ä¸‹ï¼ˆå‚è€ƒï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/keepalived.conf\">configs/ha/10.0.4.20/keepalived.conf</a>ï¼‰ï¼š</p><pre><code class=\"language-bash\"># å…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹\nglobal_defs {\n# æŒ‡å®škeepalivedåœ¨å‘ç”Ÿåˆ‡æ¢æ“ä½œæ—¶å‘é€emailï¼Œå‘é€ç»™å“ªäº›email\n# å»ºè®®åœ¨keepalived_notify.shä¸­å‘é€é‚®ä»¶\n  notification_email {\n    acassen@firewall.loc\n  }\n  notification_email_from Alexandre.Cassen@firewall.loc # å‘é€emailæ—¶é‚®ä»¶æºåœ°å€\n    smtp_server 192.168.200.1 # å‘é€emailæ—¶smtpæœåŠ¡å™¨åœ°å€\n    smtp_connect_timeout 30 # è¿æ¥smtpçš„è¶…æ—¶æ—¶é—´\n    router_id VM-4-20-centos # æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºhostname\n    vrrp_skip_check_adv_addr # å¦‚æœæ¥æ”¶åˆ°çš„æŠ¥æ–‡å’Œä¸Šä¸€ä¸ªæŠ¥æ–‡æ¥è‡ªåŒä¸€ä¸ªè·¯ç”±å™¨ï¼Œåˆ™ä¸æ‰§è¡Œæ£€æŸ¥ã€‚é»˜è®¤æ˜¯è·³è¿‡æ£€æŸ¥\n    vrrp_garp_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„gratuitous arpæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0\n    vrrp_gna_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„naæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0\n}\n# æ£€æµ‹è„šæœ¬é…ç½®\nvrrp_script checkhaproxy\n{\n  script \"/etc/keepalived/check_nginx.sh\" # æ£€æµ‹è„šæœ¬è·¯å¾„\n    interval 5 # æ£€æµ‹æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰\n    weight 0 # æ ¹æ®è¯¥æƒé‡æ”¹å˜priorityï¼Œå½“å€¼ä¸º0æ—¶ï¼Œä¸æ”¹å˜å®ä¾‹çš„ä¼˜å…ˆçº§\n}\n# VRRPå®ä¾‹é…ç½®\nvrrp_instance VI_1 {\n  state BACKUP  # è®¾ç½®åˆå§‹çŠ¶æ€ä¸º'å¤‡ä»½'\n    interface eth0 # è®¾ç½®ç»‘å®šVIPçš„ç½‘å¡ï¼Œä¾‹å¦‚eth0\n    virtual_router_id 51  # é…ç½®é›†ç¾¤VRIDï¼Œäº’ä¸ºä¸»å¤‡çš„VRIDéœ€è¦æ˜¯ç›¸åŒçš„å€¼\n    nopreempt               # è®¾ç½®éæŠ¢å æ¨¡å¼ï¼Œåªèƒ½è®¾ç½®åœ¨stateä¸ºbackupçš„èŠ‚ç‚¹ä¸Š\n    priority 100 # è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€é«˜çš„ä¸ºmaster\n    advert_int 1 # ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’\n# éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´\n    authentication {\n      auth_type PASS # è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ˜¯PASSæˆ–AHä¸¤ç§è®¤è¯æ–¹å¼\n        auth_pass 1111 # è®¤è¯å¯†ç \n    }\n  unicast_src_ip 10.0.4.20  # è®¾ç½®æœ¬æœºå†…ç½‘IPåœ°å€\n    unicast_peer {\n      10.0.4.21             # å¯¹ç«¯è®¾å¤‡çš„IPåœ°å€\n    }\n# VIPï¼Œå½“stateä¸ºmasteræ—¶æ·»åŠ ï¼Œå½“stateä¸ºbackupæ—¶åˆ é™¤\n  virtual_ipaddress {\n    10.0.4.99 # è®¾ç½®é«˜å¯ç”¨è™šæ‹ŸVIPï¼Œå¦‚æœæ˜¯è…¾è®¯äº‘çš„CVMï¼Œéœ€è¦å¡«å†™æ§åˆ¶å°ç”³è¯·åˆ°çš„HAVIPåœ°å€ã€‚\n  }\n  notify_master \"/etc/keepalived/keepalived_notify.sh MASTER\" # å½“åˆ‡æ¢åˆ°masterçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n    notify_backup \"/etc/keepalived/keepalived_notify.sh BACKUP\" # å½“åˆ‡æ¢åˆ°backupçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n    notify_fault \"/etc/keepalived/keepalived_notify.sh FAULT\" # å½“åˆ‡æ¢åˆ°faultçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n    notify_stop \"/etc/keepalived/keepalived_notify.sh STOP\" # å½“åˆ‡æ¢åˆ°stopçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n    garp_master_delay 1    # è®¾ç½®å½“åˆ‡ä¸ºä¸»çŠ¶æ€åå¤šä¹…æ›´æ–°ARPç¼“å­˜\n    garp_master_refresh 5   # è®¾ç½®ä¸»èŠ‚ç‚¹å‘é€ARPæŠ¥æ–‡çš„æ—¶é—´é—´éš”\n    # è·Ÿè¸ªæ¥å£ï¼Œé‡Œé¢ä»»æ„ä¸€å—ç½‘å¡å‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šè¿›å…¥æ•…éšœ(FAULT)çŠ¶æ€\n    track_interface {\n      eth0\n    }\n  # è¦æ‰§è¡Œçš„æ£€æŸ¥è„šæœ¬\n  track_script {\n    checkhaproxy\n  }\n}\n</code></pre><p>è¿™é‡Œæœ‰å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š</p><ul>\n<li>ç¡®ä¿å·²ç»é…ç½®äº†garpç›¸å…³å‚æ•°ã€‚å› ä¸ºKeepalivedä¾èµ–ARPæŠ¥æ–‡æ›´æ–°IPä¿¡æ¯ï¼Œå¦‚æœç¼ºå°‘è¿™äº›å‚æ•°ï¼Œä¼šå¯¼è‡´æŸäº›åœºæ™¯ä¸‹ä¸»è®¾å¤‡ä¸å‘é€ARPï¼Œè¿›è€Œå¯¼è‡´é€šä¿¡å¼‚å¸¸ã€‚garpç›¸å…³å‚æ•°é…ç½®å¦‚ä¸‹ï¼š</li>\n</ul><pre><code class=\"language-plain\">garp_master_delay 1\ngarp_master_refresh 5\n</code></pre><ul>\n<li>ç¡®å®šæ²¡æœ‰é‡‡ç”¨ strict æ¨¡å¼ï¼Œå³éœ€è¦åˆ é™¤vrrp_stricté…ç½®ã€‚</li>\n<li>é…ç½®ä¸­çš„<code>/etc/keepalived/check_nginx.sh</code>å’Œ<code>/etc/keepalived/keepalived_notify.sh</code>è„šæœ¬æ–‡ä»¶ï¼Œå¯åˆ†åˆ«æ‹·è´è‡ª<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/scripts/check_nginx.sh\">scripts/check_nginx.sh</a>å’Œ<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/scripts/keepalived_notify.sh\">scripts/keepalived_notify.sh</a>ã€‚</li>\n</ul><p><strong>ç„¶åï¼Œé‡å¯Keepalivedï¼š</strong></p><pre><code class=\"language-bash\">$ sudo systemctl restart keepalived\n</code></pre><h3>ç¬¬ä¸‰æ­¥ï¼šå¤‡æœåŠ¡å™¨é…ç½®</h3><p>è¿›è¡Œå¤‡æœåŠ¡å™¨é…ç½®ä¹Ÿåˆ†ä¸ºä¸¤æ­¥ã€‚</p><p><strong>é¦–å…ˆï¼Œä¿®æ”¹Keepalivedé…ç½®æ–‡ä»¶ã€‚</strong></p><p>ç™»é™†æœåŠ¡å™¨<code>10.0.4.21</code>ï¼Œç¼–è¾‘<code>/etc/keepalived/keepalived.conf</code>ï¼Œä¿®æ”¹é…ç½®ï¼Œä¿®æ”¹åé…ç½®å†…å®¹å¦‚ä¸‹ï¼ˆå‚è€ƒï¼š<a href=\"https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/keepalived.conf\">configs/ha/10.0.4.21/keepalived.conf</a>ï¼‰ï¼š</p><pre><code class=\"language-plain\"># å…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹\nglobal_defs {\n# æŒ‡å®škeepalivedåœ¨å‘ç”Ÿåˆ‡æ¢æ“ä½œæ—¶å‘é€emailï¼Œå‘é€ç»™å“ªäº›email\n# å»ºè®®åœ¨keepalived_notify.shä¸­å‘é€é‚®ä»¶\n&nbsp; notification_email {\n&nbsp; &nbsp; acassen@firewall.loc\n&nbsp; }\n&nbsp; notification_email_from Alexandre.Cassen@firewall.loc # å‘é€emailæ—¶é‚®ä»¶æºåœ°å€\n&nbsp; &nbsp; smtp_server 192.168.200.1 # å‘é€emailæ—¶smtpæœåŠ¡å™¨åœ°å€\n&nbsp; &nbsp; smtp_connect_timeout 30 # è¿æ¥smtpçš„è¶…æ—¶æ—¶é—´\n&nbsp; &nbsp; router_id VM-4-21-centos # æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºhostname\n&nbsp; &nbsp; vrrp_skip_check_adv_addr # å¦‚æœæ¥æ”¶åˆ°çš„æŠ¥æ–‡å’Œä¸Šä¸€ä¸ªæŠ¥æ–‡æ¥è‡ªåŒä¸€ä¸ªè·¯ç”±å™¨ï¼Œåˆ™ä¸æ‰§è¡Œæ£€æŸ¥ã€‚é»˜è®¤æ˜¯è·³è¿‡æ£€æŸ¥\n&nbsp; &nbsp; vrrp_garp_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„gratuitous arpæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0\n&nbsp; &nbsp; vrrp_gna_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„naæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0\n}\n# æ£€æµ‹è„šæœ¬é…ç½®\nvrrp_script checkhaproxy\n{\n&nbsp; script \"/etc/keepalived/check_nginx.sh\" # æ£€æµ‹è„šæœ¬è·¯å¾„\n&nbsp; &nbsp; interval 5 # æ£€æµ‹æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰\n&nbsp; &nbsp; weight 0 # æ ¹æ®è¯¥æƒé‡æ”¹å˜priorityï¼Œå½“å€¼ä¸º0æ—¶ï¼Œä¸æ”¹å˜å®ä¾‹çš„ä¼˜å…ˆçº§\n}\n# VRRPå®ä¾‹é…ç½®\nvrrp_instance VI_1 {\n&nbsp; state BACKUP&nbsp; # è®¾ç½®åˆå§‹çŠ¶æ€ä¸º'å¤‡ä»½'\n&nbsp; &nbsp; interface eth0 # è®¾ç½®ç»‘å®šVIPçš„ç½‘å¡ï¼Œä¾‹å¦‚eth0\n&nbsp; &nbsp; virtual_router_id 51&nbsp; # é…ç½®é›†ç¾¤VRIDï¼Œäº’ä¸ºä¸»å¤‡çš„VRIDéœ€è¦æ˜¯ç›¸åŒçš„å€¼\n&nbsp; &nbsp; nopreempt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# è®¾ç½®éæŠ¢å æ¨¡å¼ï¼Œåªèƒ½è®¾ç½®åœ¨stateä¸ºbackupçš„èŠ‚ç‚¹ä¸Š\n&nbsp; &nbsp; priority 50 # è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€é«˜çš„ä¸ºmaster\n&nbsp; &nbsp; advert_int 1 # ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’\n# éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´\n&nbsp; &nbsp; authentication {\n&nbsp; &nbsp; &nbsp; auth_type PASS # è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ˜¯PASSæˆ–AHä¸¤ç§è®¤è¯æ–¹å¼\n&nbsp; &nbsp; &nbsp; &nbsp; auth_pass 1111 # è®¤è¯å¯†ç \n&nbsp; &nbsp; }\n&nbsp; unicast_src_ip 10.0.4.21&nbsp; # è®¾ç½®æœ¬æœºå†…ç½‘IPåœ°å€\n&nbsp; &nbsp; unicast_peer {\n&nbsp; &nbsp; &nbsp; 10.0.4.20&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# å¯¹ç«¯è®¾å¤‡çš„IPåœ°å€\n&nbsp; &nbsp; }\n# VIPï¼Œå½“stateä¸ºmasteræ—¶æ·»åŠ ï¼Œå½“stateä¸ºbackupæ—¶åˆ é™¤\n&nbsp; virtual_ipaddress {\n&nbsp; &nbsp; 10.0.4.99 # è®¾ç½®é«˜å¯ç”¨è™šæ‹ŸVIPï¼Œå¦‚æœæ˜¯è…¾è®¯äº‘çš„CVMï¼Œéœ€è¦å¡«å†™æ§åˆ¶å°ç”³è¯·åˆ°çš„HAVIPåœ°å€ã€‚\n&nbsp; }\n&nbsp; notify_master \"/etc/keepalived/keepalived_notify.sh MASTER\" # å½“åˆ‡æ¢åˆ°masterçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; notify_backup \"/etc/keepalived/keepalived_notify.sh BACKUP\" # å½“åˆ‡æ¢åˆ°backupçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; notify_fault \"/etc/keepalived/keepalived_notify.sh FAULT\" # å½“åˆ‡æ¢åˆ°faultçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; notify_stop \"/etc/keepalived/keepalived_notify.sh STOP\" # å½“åˆ‡æ¢åˆ°stopçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬\n&nbsp; &nbsp; garp_master_delay 1&nbsp; &nbsp; # è®¾ç½®å½“åˆ‡ä¸ºä¸»çŠ¶æ€åå¤šä¹…æ›´æ–°ARPç¼“å­˜\n&nbsp; &nbsp; garp_master_refresh 5&nbsp; &nbsp;# è®¾ç½®ä¸»èŠ‚ç‚¹å‘é€ARPæŠ¥æ–‡çš„æ—¶é—´é—´éš”\n&nbsp; &nbsp; # è·Ÿè¸ªæ¥å£ï¼Œé‡Œé¢ä»»æ„ä¸€å—ç½‘å¡å‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šè¿›å…¥æ•…éšœ(FAULT)çŠ¶æ€\n&nbsp; &nbsp; track_interface {\n&nbsp; &nbsp; &nbsp; eth0\n&nbsp; &nbsp; }\n&nbsp; # è¦æ‰§è¡Œçš„æ£€æŸ¥è„šæœ¬\n&nbsp; track_script {\n&nbsp; &nbsp; checkhaproxy\n&nbsp; }\n}\n</code></pre><p><strong>ç„¶åï¼Œé‡å¯Keepalivedï¼š</strong></p><pre><code class=\"language-bash\">$ sudo systemctl restart keepalived\n</code></pre><h3>ç¬¬å››æ­¥ï¼šæµ‹è¯•Keepalived</h3><p>ä¸Šé¢çš„é…ç½®ä¸­ï¼Œ<code>10.0.4.20</code>çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹<code>10.0.4.20</code>å°†è¢«é€‰æ‹©ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/54/79/54968f40707b779e2ab70d3ab5a53479.png?wh=1920x500\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¨¡æ‹Ÿä¸€äº›æ•…éšœåœºæ™¯ï¼Œæ¥çœ‹ä¸‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚</p><p><strong>åœºæ™¯1ï¼šKeepalivedæ•…éšœ</strong></p><p>åœ¨<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œ<code>sudo systemctl stop keepalived</code>æ¨¡æ‹ŸKeepalivedæ•…éšœï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šï¼Œæ¼‚ç§»åˆ°äº†<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šã€‚æŸ¥çœ‹<code>/var/log/keepalived.log</code>ï¼Œå¯ä»¥çœ‹åˆ°<code>10.0.4.20</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š</p><pre><code class=\"language-plain\">[2020-10-14 14:01:51] notify_stop\n</code></pre><p><code>10.0.4.21</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹æ—¥å¿—ï¼š</p><pre><code class=\"language-plain\">[2020-10-14 14:01:52] notify_master\n</code></pre><p><strong>åœºæ™¯2ï¼šNginxæ•…éšœ</strong></p><p>åœ¨<code>10.0.4.20</code>å’Œ<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šåˆ†åˆ«æ‰§è¡Œ<code>sudo systemctl restart keepalived</code>ï¼Œè®©VIPæ¼‚ç§»åˆ°<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šã€‚</p><p>åœ¨<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šï¼Œæ‰§è¡Œ <code>sudo systemctl stop nginx</code> æ¨¡æ‹ŸNginxæ•…éšœï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šï¼Œæ¼‚ç§»åˆ°äº†<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šã€‚æŸ¥çœ‹<code>/var/log/keepalived.log</code>ï¼Œå¯ä»¥çœ‹åˆ°<code>10.0.4.20</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š</p><pre><code class=\"language-plain\">[2020-10-14 14:02:34] notify_fault\n</code></pre><p><code>10.0.4.21</code> æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹æ—¥å¿—ï¼š</p><pre><code class=\"language-plain\">[2020-10-14 14:02:35] notify_master\n</code></pre><p><strong>åœºæ™¯3ï¼šNginxæ¢å¤</strong></p><p>åŸºäº<strong>åœºæ™¯2</strong>ï¼Œåœ¨<code>10.0.4.20</code>æœåŠ¡å™¨ä¸Šæ‰§è¡Œ<code>sudo systemctl start nginx</code>æ¢å¤Nginxï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»ç„¶åœ¨<code>10.0.4.21</code>æœåŠ¡å™¨ä¸Šï¼Œæ²¡æœ‰è¢«<code>10.0.4.20</code>æŠ¢å ã€‚æŸ¥çœ‹<code>/var/log/keepalived.log</code>ï¼Œå¯ä»¥çœ‹åˆ°<code>10.0.4.20</code>æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š</p><pre><code class=\"language-plain\">[2020-10-14 14:03:44] notify_backup\n</code></pre><p><code>10.0.4.21</code>æœåŠ¡å™¨æ²¡æœ‰æ–°å¢æ—¥å¿—ã€‚</p><h3>ç¬¬äº”æ­¥ï¼šVIPç»‘å®šå…¬ç½‘IP</h3><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸé…ç½®äº†Keepalived + Nginxçš„é«˜å¯ç”¨æ–¹æ¡ˆã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„VIPæ˜¯å†…ç½‘ï¼Œè¿˜ä¸èƒ½é€šè¿‡å¤–ç½‘è®¿é—®ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†VIPç»‘å®šä¸€ä¸ªå¤–ç½‘IPï¼Œä¾›å¤–ç½‘è®¿é—®ã€‚åœ¨è…¾è®¯äº‘ä¸Šï¼Œå¯é€šè¿‡ç»‘å®šå¼¹æ€§å…¬ç½‘IPæ¥å®ç°å¤–ç½‘è®¿é—®ï¼Œéœ€è¦å…ˆç”³è¯·å…¬ç½‘IPï¼Œç„¶åå°†VIPç»‘å®šå¼¹æ€§å…¬ç½‘IPã€‚ä¸‹é¢æˆ‘æ¥è®²è®²å…·ä½“æ­¥éª¤ã€‚</p><p>ç”³è¯·å…¬ç½‘IPï¼š</p><ol>\n<li>ç™»å½•<strong>ç§æœ‰ç½‘ç»œæ§åˆ¶å°ã€‚</strong></li>\n<li>åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘&gt;ã€å¼¹æ€§å…¬ç½‘IPã€‘ã€‚</li>\n<li>åœ¨å¼¹æ€§å…¬ç½‘IPç®¡ç†é¡µé¢ï¼Œé€‰æ‹©æ‰€åœ¨åœ°åŸŸï¼Œå•å‡»ã€ç”³è¯·ã€‘ã€‚</li>\n</ol><p>å°†VIPç»‘å®šå¼¹æ€§å…¬ç½‘IPï¼š</p><ol>\n<li>ç™»å½•<strong>ç§æœ‰ç½‘ç»œæ§åˆ¶å°</strong>ã€‚</li>\n<li>åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘&gt;ã€é«˜å¯ç”¨è™šæ‹Ÿã€‘ã€‚</li>\n<li>å•å‡»éœ€è¦ç»‘å®šçš„HAVIPæ‰€åœ¨è¡Œçš„ã€ç»‘å®šã€‘ã€‚</li>\n<li>åœ¨å¼¹å‡ºç•Œé¢ä¸­ï¼Œé€‰æ‹©éœ€è¦ç»‘å®šçš„å…¬ç½‘IPå³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/83/62/83bc9f4595325e9d339e7c3269aa3462.png?wh=1388x666\" alt=\"å›¾ç‰‡\"></p><p>ç»‘å®šçš„å¼¹æ€§å…¬ç½‘IPæ˜¯<code>106.52.252.139</code>ã€‚</p><p>è¿™é‡Œæç¤ºä¸‹ï¼Œè…¾è®¯äº‘å¹³å°ä¸­ï¼Œå¦‚æœHAVIPæ²¡æœ‰ç»‘å®šå®ä¾‹ï¼Œç»‘å®šHAVIPçš„EIPä¼šå¤„äºé—²ç½®çŠ¶æ€ï¼ŒæŒ‰<code>Â¥0.2/å°æ—¶</code> æ”¶å–é—²ç½®è´¹ç”¨ã€‚æ‰€ä»¥ï¼Œä½ éœ€è¦æ­£ç¡®é…ç½®é«˜å¯ç”¨åº”ç”¨ï¼Œç¡®ä¿ç»‘å®šæˆåŠŸã€‚</p><h3>ç¬¬å…­æ­¥ï¼šæµ‹è¯•å…¬ç½‘è®¿é—®</h3><p>æœ€åï¼Œä½ å¯ä»¥é€šè¿‡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥æµ‹è¯•ï¼š</p><pre><code class=\"language-bash\">$ curl -H\"Host: iam.api.marmotedu.com\" http://106.52.252.139/healthz -H\"iam.api.marmotedu.com\"\n{\"status\":\"ok\"}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥æˆåŠŸé€šè¿‡å…¬ç½‘è®¿é—®åç«¯çš„é«˜å¯ç”¨æœåŠ¡ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ªå¯ç”¨æ€§å¾ˆé«˜çš„IAMåº”ç”¨ã€‚</p><h2>æ€»ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä¸»è¦è®²äº†å¦‚ä½•ä½¿ç”¨Nginxå’ŒKeepalivedï¼Œæ¥éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ã€‚</p><p>ä¸ºäº†éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦ä¸¤å°æœåŠ¡å™¨ï¼Œå¹¶ä¸”éƒ¨ç½²ç›¸åŒçš„æœåŠ¡iam-apiserverã€iam-authz-serverã€iam-pumpã€‚è€Œä¸”ï¼Œé€‰æ‹©å…¶ä¸­ä¸€å°æœåŠ¡å™¨éƒ¨ç½²æ•°æ®åº“æœåŠ¡ï¼šMariaDBã€Redisã€MongoDBã€‚</p><p>ä¸ºäº†å®‰å…¨å’Œæ€§èƒ½ï¼Œiam-apiserverã€iam-authz-serverã€iam-pumpæœåŠ¡éƒ½æ˜¯é€šè¿‡å†…ç½‘æ¥è®¿é—®æ•°æ®åº“æœåŠ¡çš„ã€‚è¿™ä¸€è®²ï¼Œæˆ‘è¿˜ä»‹ç»äº†å¦‚ä½•é…ç½®Nginxæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¦‚ä½•é…ç½®Keepalivedæ¥å®ç°Nginxçš„é«˜å¯ç”¨ã€‚</p><h2>è¯¾åç»ƒä¹ </h2><ol>\n<li>æ€è€ƒä¸‹ï¼Œå½“å‰éƒ¨ç½²æ¶æ„ä¸‹å¦‚æœiam-apiserveréœ€è¦æ‰©å®¹ï¼Œå¯ä»¥æ€ä¹ˆæ‰©å®¹ï¼Ÿ</li>\n<li>æ€è€ƒä¸‹ï¼Œå½“VIPåˆ‡æ¢æ—¶ï¼Œå¦‚ä½•å®ç°å‘Šè­¦åŠŸèƒ½ï¼Œç»™ç³»ç»Ÿè¿ç»´äººå‘˜å‘Šè­¦ï¼Ÿ</li>\n</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚</p>","comments":[{"had_liked":false,"id":309576,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1630237737,"is_pvip":false,"replies":[{"id":"112570","content":"ä¼˜ç§€ï¼Œå“ˆå“ˆå“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1630864420,"ip_address":"","comment_id":309576,"utype":1}],"discussion_count":3,"race_medal":0,"score":"23105074217","product_id":100079601,"comment_content":"iamctl å¥½ç”¨çš„ä¸è¡Œï¼Œå·²ç»æ²‰æ·€ä¸ºäº†è‡ªå·±çš„ pctl äº†ï¼Œè¿™ä¸æ˜¯æŠ„è¢­ï¼Œè¿™æ˜¯æ¨¡ä»¿ï½","like_count":5,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525923,"discussion_content":"ä¼˜ç§€ï¼Œå“ˆå“ˆå“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630864420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1037721,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/d5/99/8c0d8f66.jpg","nickname":"ãŠ£ï£¿Coldstar","note":"","ucode":"0E3D5E9B1FD7FE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":536473,"discussion_content":"æ¶æ„è®¾è®¡çš„ç¡®å®ä¸é”™ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638790707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2654999,"avatar":"https://static001.geekbang.org/account/avatar/00/28/83/17/df99b53d.jpg","nickname":"éšé£è€Œè¿‡","note":"","ucode":"FFD17BAA3B2312","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392921,"discussion_content":"å€Ÿé‰´å§ï¼Œå®Œå…¨æ¨¡ä»¿ä¹Ÿä¸èƒ½ç”¨å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631179901,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325020,"user_name":"ãŠ£ï£¿Coldstar","can_delete":false,"product_type":"c1","uid":1037721,"ip_address":"","ucode":"0E3D5E9B1FD7FE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d5/99/8c0d8f66.jpg","comment_is_top":false,"comment_ctime":1638780957,"is_pvip":false,"replies":[{"id":"118344","content":"è…¾è®¯äº‘æ”¯æŒå†…ç½‘è´Ÿè½½å‡è¡¡ï¼Œè…¾è®¯äº‘çš„å†…ç½‘è´Ÿè½½å‡è¡¡æ”¶è´¹æƒ…å†µå¦‚ä¸‹ï¼šå†…ç½‘è´Ÿè½½å‡è¡¡å…æ”¶å…¬ç½‘ç½‘ç»œè´¹ï¼Œæ”¶å–å®ä¾‹è´¹ã€‚<br><br>åˆ›å»ºè´Ÿè½½å‡è¡¡çš„æ—¶å€™ï¼Œé€‰æ‹©  ã€å†…ç½‘ã€‘å³å¯åˆ›å»ºå†…ç½‘è´Ÿè½½å‡è¡¡","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1167883","ctime":1639399707,"ip_address":"","comment_id":325020,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638780957","product_id":100079601,"comment_content":"é˜¿é‡Œäº‘æœ‰å…è´¹çš„å†…ç½‘è´Ÿè½½å‡è¡¡å¯ä»¥ä½¿ç”¨ è…¾è®¯äº‘ æ²¡çœ‹åˆ°å¯ä»¥åˆ›å»º å†…ç½‘ä¸“ç”¨çš„è´Ÿè½½å‡è¡¡ï¼Œè¿™æ ·çš„è¯ï¼Œåˆ©ç”¨äº‘åŸºç¡€è®¾æ–½å¯ä»¥ç®€åŒ–éƒ¨ç½²","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538339,"discussion_content":"è…¾è®¯äº‘æ”¯æŒå†…ç½‘è´Ÿè½½å‡è¡¡ï¼Œè…¾è®¯äº‘çš„å†…ç½‘è´Ÿè½½å‡è¡¡æ”¶è´¹æƒ…å†µå¦‚ä¸‹ï¼šå†…ç½‘è´Ÿè½½å‡è¡¡å…æ”¶å…¬ç½‘ç½‘ç»œè´¹ï¼Œæ”¶å–å®ä¾‹è´¹ã€‚\n\nåˆ›å»ºè´Ÿè½½å‡è¡¡çš„æ—¶å€™ï¼Œé€‰æ‹©  ã€å†…ç½‘ã€‘å³å¯åˆ›å»ºå†…ç½‘è´Ÿè½½å‡è¡¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639399707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324801,"user_name":"yandongxiao","can_delete":false,"product_type":"c1","uid":1017700,"ip_address":"","ucode":"D397F4DB0109C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg","comment_is_top":false,"comment_ctime":1638631296,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1638631296","product_id":100079601,"comment_content":"æ€»ç»“ï¼š<br>1. åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½² IAMåº”ç”¨ä¸­çš„æœåŠ¡ã€‚20 æœºå™¨ä¸Šè¿˜ä¼šéƒ¨ç½² Mysql, Redis, MongoDB<br>2. é…ç½® Nginxã€‚ä¸»è¦æ˜¯æ·»åŠ ä¸¤ä¸ª serverï¼Œåœ¨ http{} ä¸­æ·»åŠ  upstreamã€‚<br>4. é…ç½® Keepalived","like_count":0}]}