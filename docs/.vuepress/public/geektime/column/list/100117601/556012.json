{"id":556012,"title":"14 ï½œ iOSå¹³å°å¦‚ä½•é‡‡é›†è§†é¢‘ç”»é¢ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å±•æ™“å‡¯ã€‚ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ iOSå¹³å°çš„è§†é¢‘ç”»é¢é‡‡é›†ã€‚</p><p>å‰é¢æˆ‘ä»¬å­¦ä¹ çš„éŸ³é¢‘é‡‡é›†ä¸ç¼–ç çš„æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥å®ç°éŸ³é¢‘å½•åˆ¶å™¨çš„åŠŸèƒ½ã€‚ä½†å¦‚æœè¦å®Œæˆè§†é¢‘å½•åˆ¶å™¨çš„åŠŸèƒ½æˆ‘ä»¬è¿˜éœ€è¦æŒæ¡è§†é¢‘é‡‡é›†ä¸ç¼–ç æ–¹é¢çš„å†…å®¹ï¼Œæ‰€ä»¥ä»ä»Šå¤©å¼€å§‹æˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•é‡‡é›†è§†é¢‘çš„ç”»é¢ã€‚</p><p>é‡‡é›†åˆ°è§†é¢‘ç”»é¢ä¹‹åä¸€èˆ¬ä¼šç»™ç”¨æˆ·é¢„è§ˆå‡ºæ¥ï¼Œè¿™å°±è¦ç»“åˆä¹‹å‰æˆ‘ä»¬å­¦è¿‡çš„<a href=\"https://time.geekbang.org/column/article/545953\">è§†é¢‘ç”»é¢æ¸²æŸ“</a>æ–¹é¢çš„çŸ¥è¯†ï¼Œå†åŠ ä¸Šè§†é¢‘çš„ç¼–ç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ç”¨æˆ·ç‚¹å‡»å½•åˆ¶çš„æ—¶å€™ç»™è§†é¢‘ç”»é¢ç¼–ç å¹¶ä¸”å­˜å‚¨åˆ°æœ¬åœ°äº†ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å°±å…ˆæ¥ä¸€èµ·å­¦ä¹ åœ¨iOSå¹³å°å¦‚ä½•é‡‡é›†è§†é¢‘ç”»é¢ã€‚</p><h2>è§†é¢‘æ¡†æ¶ELImageæ¶æ„è®¾è®¡</h2><p>åœ¨iOSå¹³å°ä½¿ç”¨Cameraæ¥é‡‡é›†è§†é¢‘ç”»é¢çš„APIæ¥å£æ¯”è¾ƒç®€å•ï¼Œä½†è¦è®¾è®¡å‡ºä¸€ä¸ªä¼˜ç§€çš„ã€å¯æ‰©å±•çš„æ¶æ„ï¼Œä¹Ÿä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ‰€ä»¥è¿™èŠ‚è¯¾æˆ‘ä¼šå¸¦ä½ è®¾è®¡å¹¶å®ç°å‡ºä¸€ä¸ªæ¶æ„ï¼Œè¿™ä¸ªæ¶æ„åŸºäºæ‘„åƒå¤´é‡‡é›†é©±åŠ¨ï¼Œä¸­é—´å¯ä»¥æ”¯æŒè§†é¢‘ç‰¹æ•ˆå¤„ç†ï¼Œæœ€ç»ˆç”¨OpenGL ESæ¸²æŸ“åˆ°UIViewä¸Šï¼Œä¸”æ”¯æŒæ‰©å±•æ’å…¥ç¼–ç èŠ‚ç‚¹ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ•´ä½“çš„æ¶æ„å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/43/2f/43da58864042499a170ba75d96d9352f.png?wh=1694x636\" alt=\"å›¾ç‰‡\" title=\"æ¶æ„å›¾\"></p><p>å·¦è¾¹ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ç”¨ç³»ç»Ÿæä¾›çš„Cameraæ¥å£ï¼Œé‡‡é›†å‡ºä¸€å¸§å†…å­˜ä¸­çš„å›¾åƒï¼Œç„¶åå°†è¿™ä¸ªå›¾åƒä¸Šä¼ åˆ°æ˜¾å­˜ä¸­æˆä¸ºYUVçš„çº¹ç†å¯¹è±¡ï¼Œæœ€åå°†è¿™ä¸ªYUVæ ¼å¼çš„çº¹ç†é‡æ–°æ¸²æŸ“åˆ°ä¸€ä¸ªRGBAçš„çº¹ç†ä¸Šã€‚æ¥ç€å°†è¿™ä¸ªRGBAç±»å‹çš„çº¹ç†å¯¹è±¡ä¼ åˆ°ä¸­é—´çš„FiltersèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹å†…éƒ¨ä¼šä½¿ç”¨OpenGL ESæ¥å¤„ç†è¿™ä¸ªçº¹ç†å¯¹è±¡ï¼Œæœ€åè¾“å‡ºä¸€ä¸ªçº¹ç†å¯¹è±¡åˆ°ä¸‹é¢çš„èŠ‚ç‚¹ã€‚</p><!-- [[[read_end]]] --><p>ä¸‹ä¸€çº§èŠ‚ç‚¹æ˜¯GLImageViewæˆ–å°†æ¥æ‰©å±•å‡ºæ¥çš„ç»„ä»¶VideoEncoderï¼Œæ‹¿åˆ°ä¸­é—´FiltersèŠ‚ç‚¹è¾“å‡ºä¹‹åï¼Œè¿›è¡Œå±å¹•æ¸²æŸ“æˆ–è€…ç¼–ç æ“ä½œã€‚è¿™æ ·ä¸€å¸§å›¾åƒå°±ä»é‡‡é›†ã€å¤„ç†åˆ°æœ€åé¢„è§ˆè®©ç”¨æˆ·çœ‹åˆ°å°±å®Œæˆäº†ï¼Œå¹¶ä¸”å¯ä»¥æ»¡è¶³æˆ‘ä»¬ä¹‹ååšç¼–ç ä»¥åŠå›¾åƒå¤„ç†çš„éœ€æ±‚ã€‚</p><p>ç»§ç»­çœ‹å›¾ï¼Œä½ ä¼šå‘ç°Cameraå’ŒFilterè¿™äº›èŠ‚ç‚¹æ˜¯å¯ä»¥è¾“å‡ºçº¹ç†å¯¹è±¡çš„ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬çš„ç›®æ ‡çº¹ç†å¯¹è±¡è¦ä½œä¸ºåä¸€çº§èŠ‚ç‚¹çš„è¾“å…¥çº¹ç†å¯¹è±¡ï¼›å¦å¤–ï¼ŒFilterã€GLImageViewä»¥åŠVideoEncoderéœ€è¦ä¸Šä¸€çº§èŠ‚ç‚¹æä¾›è¾“å…¥çº¹ç†å¯¹è±¡ã€‚é€šè¿‡ä»¥ä¸Šä¸¤ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠ½è±¡å‡ºä¸¤ä¸ªè§„åˆ™ã€‚</p><ol>\n<li><strong>å‡¡æ˜¯éœ€è¦è¾“å…¥çº¹ç†å¯¹è±¡çš„ï¼Œéƒ½æ˜¯Inputç±»å‹ã€‚</strong></li>\n<li><strong>å‡¡æ˜¯éœ€è¦å‘åçº§èŠ‚ç‚¹è¾“å‡ºçº¹ç†å¯¹è±¡çš„ï¼Œéƒ½æ˜¯Outputç±»å‹</strong>ã€‚</li>\n</ol><h3>ELImageInput</h3><p>åŸºäºè§„åˆ™ä¸€ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å‡ºELImageInputè¿™æ ·ä¸€ä¸ªProtocolï¼Œå› ä¸ºéœ€è¦åˆ«çš„ç»„ä»¶ç»™å®ƒè¾“å…¥çº¹ç†å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªProtocolé‡Œé¢å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯è®¾ç½®è¾“å…¥çš„çº¹ç†å¯¹è±¡ã€‚</p><pre><code class=\"language-plain\">- (void)setInputTexture:(ELImageTextureFrame *)textureFrame;\n</code></pre><p>èŠ‚ç‚¹ä¸­çš„Filterã€GLImageViewä»¥åŠVideoEncoderéƒ½å±äºELImageInputçš„ç±»å‹ï¼Œæ‰€ä»¥éƒ½åº”è¯¥å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¸­åº”è¯¥å°†è¾“å…¥çº¹ç†å¯¹è±¡ä¿å­˜ä¸ºä¸€ä¸ªå±æ€§ï¼Œç­‰ç»˜åˆ¶çš„æ—¶å€™ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œè¿™äº›èŠ‚ç‚¹è¿˜æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼Œå°±æ˜¯éƒ½éœ€è¦åšæ¸²æŸ“æ“ä½œï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ç¬¬äºŒä¸ªæ–¹æ³•æ˜¯æ‰§è¡Œæ¸²æŸ“æ“ä½œã€‚</p><pre><code class=\"language-plain\">- (void)newFrameReadyAtTime:(CMTime)frameTime timimgInfo:(CMSampleTimingInfo)timimgInfo;\n</code></pre><p>è¿™æ˜¯ä¸Šä¸€çº§èŠ‚ç‚¹<span class=\"reference\">ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªOutputèŠ‚ç‚¹ï¼‰</span>å¤„ç†å®Œæ¯•ä¹‹åè¦è°ƒç”¨çš„æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•çš„å®ç°ä¸­å¯ä»¥å®Œæˆæ¸²æŸ“æ“ä½œã€‚</p><h3>ELImageOutput</h3><p>åŸºäºè§„åˆ™äºŒï¼Œæˆ‘ä»¬å†å»ºç«‹ä¸€ä¸ªç±»â€”â€”ELImageOutputï¼Œè¿™ä¸ªç±»å¯ä»¥å‘è‡ªå·±çš„åçº§èŠ‚ç‚¹è¾“å‡ºç›®æ ‡çº¹ç†å¯¹è±¡ï¼Œå…¶ä¸­Cameraã€FilterèŠ‚ç‚¹æ˜¯éœ€è¦ç»§æ‰¿è‡ªè¿™ä¸ªç±»ã€‚æ ¹æ®è¿™ä¸ªç‰¹ç‚¹æˆ‘ä»¬å»ºç«‹ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯æ¸²æŸ“ç›®æ ‡çš„çº¹ç†å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯åçº§èŠ‚ç‚¹åˆ—è¡¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">ELImageTextureFrame *outputTexture;\nNSMutableArray *targets;\n</code></pre><p>ä¸ºä»€ä¹ˆåçº§èŠ‚ç‚¹æ˜¯åˆ—è¡¨ç±»å‹çš„å‘¢ï¼Ÿ<br>\nå› ä¸ºåçº§èŠ‚ç‚¹å¯èƒ½æœ‰å¤šä¸ªç›®æ ‡å¯¹è±¡ï¼Œæ¯”å¦‚FilterèŠ‚ç‚¹ï¼Œæ—¢è¦è¾“å‡ºç»™GLImageViewï¼Œåˆè¦è¾“å‡ºç»™VideoEncoderï¼Œè€Œè¿™ä¸ªtargetsé‡Œé¢çš„å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ä¹‹å‰å®šä¹‰çš„åè®®ELImageInputç±»å‹çš„å¯¹è±¡ï¼Œå› ä¸ºOutputèŠ‚ç‚¹çš„åçº§è‚¯å®šæ˜¯ä¸€ä¸ªInputç±»å‹çš„å¯¹è±¡ã€‚æ—¢ç„¶æœ‰ä¸€ä¸ªtargetsï¼Œå°±éœ€è¦æä¾›å¢åŠ å’Œåˆ é™¤ç›®æ ‡èŠ‚ç‚¹çš„æ–¹æ³•ã€‚</p><pre><code class=\"language-plain\">- (void)addTarget:(id&lt;ELImageInput&gt;)target;\n- (void)removeTarget:(id&lt;ELImageInput&gt;)target;\n</code></pre><p>æˆ‘ä»¬ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ¥æ“ä½œtargetså±æ€§ã€‚<br>\næ¯ä¸€ä¸ªçœŸæ­£ç»§æ‰¿è¿™ä¸ªç±»çš„èŠ‚ç‚¹ï¼Œæ‰§è¡Œæ¸²æŸ“è¿‡ç¨‹ç»“æŸä¹‹åï¼Œå°±ä¼šéå†targetsé‡Œé¢æ‰€æœ‰çš„ç›®æ ‡èŠ‚ç‚¹<span class=\"reference\">ï¼ˆå³ELImageInputï¼‰</span>æ‰§è¡Œè®¾ç½®è¾“å‡ºçº¹ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ¸²æŸ“è¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">//Do Render Work\nfor (id&lt;ELImageInput&gt; currentTarget in targets){\n&nbsp;&nbsp;&nbsp; [currentTarget setInputTexture:outputTextureFrame];\n&nbsp;&nbsp;&nbsp; [currentTarget newFrameReadyAtTime:frameTime timimgInfo:timimgInfo];\n}\n</code></pre><h3>ELImageProgram</h3><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å¤„ç†éƒ½æ˜¯ä¸€ä¸ªOpenGLçš„æ¸²æŸ“è¿‡ç¨‹ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦å»ºç«‹ä¸€ä¸ªGLProgramã€‚æˆ‘ä»¬ä¸å¯èƒ½åœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹é‡Œé¢éƒ½å»åˆ†åˆ«ä¹¦å†™ç¼–è¯‘Shaderã€é“¾æ¥Programç­‰ä»£ç ï¼Œæ‰€ä»¥è¦å…ˆæŠ½å–å‡ºä¸€ä¸ªç±»ï¼Œå–åä¸ºELImageProgram<span class=\"reference\">ï¼ˆELæ˜¯æ•´ä¸ªé¡¹ç›®çš„å‰ç¼€ï¼‰</span>ï¼ŒæŠŠGLProgramçš„æ„å»ºã€æŸ¥æ‰¾å±æ€§ã€ä½¿ç”¨ç­‰è¿™äº›æ“ä½œä»¥é¢å‘å¯¹è±¡çš„å½¢å¼å°è£…èµ·æ¥ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šç»„åˆè¿™ä¸ªç±»ã€‚</p><h3>ELImageTextureFrame</h3><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„è¾“å…¥éƒ½æ˜¯ä¸€ä¸ªçº¹ç†å¯¹è±¡<span class=\"reference\">ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªçº¹ç†IDï¼‰</span>ï¼Œä½¿ç”¨GLProgramå°†è¿™ä¸ªçº¹ç†å¯¹è±¡æ¸²æŸ“åˆ°ä¸€ä¸ªç›®æ ‡çº¹ç†å¯¹è±¡çš„æ—¶å€™ï¼Œè¿˜éœ€è¦å»ºç«‹ä¸€ä¸ªå¸§ç¼“å­˜å¯¹è±¡<span class=\"reference\">ï¼ˆFBOï¼‰</span>ï¼Œå¹¶ä¸”è¦å°†è¿™ä¸ªç›®æ ‡çº¹ç†å¯¹è±¡Attachåˆ°è¿™ä¸ªå¸§ç¼“å­˜å¯¹è±¡ä¸Šã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æŠ½å–ä¸€ä¸ªç±»ï¼Œå–åä¸ºELImageTextureFrameï¼Œå°†çº¹ç†å¯¹è±¡å’Œå¸§ç¼“å­˜å¯¹è±¡çš„åˆ›å»ºã€ç»‘å®šã€é”€æ¯ç­‰æ“ä½œï¼Œä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼å°è£…èµ·æ¥ï¼Œè®©æ¯ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨èµ·æ¥éƒ½æ›´åŠ æ–¹ä¾¿ã€‚</p><h3>ELImageContext</h3><p>è¦æƒ³ä½¿ç”¨OpenGL ESï¼Œå¿…é¡»æœ‰ä¸Šä¸‹æ–‡ä»¥åŠå…³è”çš„çº¿ç¨‹ï¼Œä¹‹å‰æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡iOSå¹³å°ä¸ºOpenGL ESæä¾›äº†EAGLä½œä¸ºOpenGL ESçš„ä¸Šä¸‹æ–‡ã€‚åé¢æˆ‘ä»¬ä¹¦å†™ç¼–ç å™¨ç»„ä»¶çš„æ—¶å€™ï¼Œå› ä¸ºä¸å¸Œæœ›å®ƒé˜»å¡é¢„è§ˆçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬å¼€è¾Ÿä¸€ä¸ªç¼–ç çº¿ç¨‹ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªé¢å¤–çš„OpenGLä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”éœ€è¦å’Œæ¸²æŸ“çº¿ç¨‹å…±äº«OpenGLä¸Šä¸‹æ–‡ã€‚åªæœ‰è¿™æ ·ï¼Œåœ¨ç¼–ç çº¿ç¨‹ä¸­æ‰å¯ä»¥æ­£ç¡®è®¿é—®åˆ°é¢„è§ˆçº¿ç¨‹ä¸­çš„çº¹ç†å¯¹è±¡ã€å¸§ç¼“å­˜å¯¹è±¡ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æŠ½å–ä¸€ä¸ªç±»ï¼Œå–åå«åšELImageContextï¼Œæ¥å°è£…EAGLContextå’Œæ¸²æŸ“çº¿ç¨‹ã€‚å› ä¸ºå¯èƒ½å¤šä¸ªå¯¹è±¡éƒ½è¦åœ¨è°ƒç”¨çº¿ç¨‹å’ŒOpenGL ESçš„çº¿ç¨‹ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œæ‰€ä»¥éœ€è¦ç»™è¿™ä¸ªç±»ä¹¦å†™ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œè·å¾—æ¸²æŸ“çº¿ç¨‹çš„OpenGLä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æä¾›é™æ€æ–¹æ³•å¯ä»¥å¾—åˆ°è¿™ä¸ªdispatch_queueï¼Œè®©ä¸€äº›OpenGL ESçš„æ“ä½œå¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">+ (void)useImageProcessingContext;\n{\n&nbsp;&nbsp;&nbsp; [[ELImageContext sharedImageProcessingContext] useAsCurrentContext];\n}\n- (void)useAsCurrentContext;\n{\n&nbsp;&nbsp;&nbsp; EAGLContext *imageProcessingContext = [self context];\n&nbsp;&nbsp;&nbsp; if ([EAGLContext currentContext] != imageProcessingContext)\n&nbsp;&nbsp;&nbsp; {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [EAGLContext setCurrentContext:imageProcessingContext];\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬ç”»å‡ºäº†å¯¹åº”çš„ç±»å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/69/82/695b81a17036848ff70224cf4b365782.png?wh=1792x922\" alt=\"å›¾ç‰‡\"></p><p>GLImageViewéƒ¨åˆ†ï¼Œä½ å¯ä»¥å›é¡¾ä¹‹å‰<a href=\"https://time.geekbang.org/column/article/545953\">è§†é¢‘æ¸²æŸ“æ–¹é¢</a>çš„å†…å®¹ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å†èµ˜è¿°äº†ã€‚ç¬¬18èŠ‚è¯¾æˆ‘ä»¬å°†å®ç°VideoEncoderï¼Œåé¢ä½ å¯ä»¥è‡ªå·±å»å®ç°Filterï¼Œæ‰€ä»¥è¿™èŠ‚è¯¾æˆ‘ä»¬åªå®ç°Cameraã€‚Cameraçš„å®ç°æˆ‘ä¼šåˆ†ä¸¤éƒ¨åˆ†è®²è§£ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯æ‘„åƒå¤´çš„é…ç½®ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯å°†æ‘„åƒå¤´é‡‡é›†åˆ°çš„YUVæ•°æ®è½¬æ¢ä¸ºçº¹ç†å¯¹è±¡ã€‚</p><h2>æ‘„åƒå¤´é…ç½®</h2><p>æˆ‘ä»¬ä¸€ç›´åå¤å¼ºè°ƒï¼Œåœ¨iOSå¹³å°åªè¦æ˜¯ä¸ç¡¬ä»¶ç›¸å…³çš„ä½¿ç”¨éƒ½è¦ä»ä¼šè¯å¼€å§‹é…ç½®ï¼Œæ‰€ä»¥æ‘„åƒå¤´è¿™é‡Œéœ€è¦é…ç½®AVCaptureSessionã€‚</p><pre><code class=\"language-plain\">AVCaptureSession* captureSession;\ncaptureSession = [[AVCaptureSession alloc] init];\n</code></pre><p>ç„¶åéœ€è¦é…ç½®å‡ºAVCaptureDeviceInputï¼Œè¿™ä¸ªå¯¹è±¡ä»£è¡¨äº†æˆ‘ä»¬è¦ä½¿ç”¨å“ªä¸ªæ‘„åƒå¤´ï¼Œæ¯”å¦‚ä½¿ç”¨å‰ç½®æ‘„åƒå¤´ã€‚</p><pre><code class=\"language-plain\">AVCaptureDevice * captureDevice = nil;\nNSArray *devices = [AVCaptureDevice devicesWithMediaType:AVMediaTypeVideo];\nfor (AVCaptureDevice *device in devices) {\n&nbsp;&nbsp;&nbsp; if ([device position] == AVCaptureDevicePositionFront) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; captureDevice = device;\n&nbsp;&nbsp;&nbsp; }\n}\ncaptureInput = [[AVCaptureDeviceInput alloc] initWithDevice:captureDevice error:nil];\n</code></pre><p>æ¥ç€è¦é…ç½®å‡ºAVCaptureVideoDataOutputï¼Œè¿™ä¸ªå¯¹è±¡ç”¨æ¥å¤„ç†æ‘„åƒå¤´é‡‡é›†åˆ°çš„æ•°æ®ã€‚</p><pre><code class=\"language-plain\">dispatch_queue_t dataCallbackQueue;\ndataCallbackQueue = dispatch_queue_create(\"dataCallbackQueue\",\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DISPATCH_QUEUE_SERIAL);\ncaptureOutput = [[AVCaptureVideoDataOutput alloc] init];\n[_captureOutput setSampleBufferDelegate:self queue:dataCallbackQueue];\n</code></pre><p>æ„å»ºå‡ºcaptureOutputè¿™ä¸ªå®ä¾‹ä¹‹åï¼Œè¦æƒ³è·å–æ‘„åƒå¤´é‡‡é›†çš„æ•°æ®ï¼Œå°±éœ€è¦ä¼ å…¥ç±»å‹ä¸ºAVCaptureVideoDataOutputSampleBufferDelegateçš„å®ä¾‹å’Œä¸€ä¸ªdispatch_queueã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸‹åƒç´ æ ¼å¼ï¼Œé»˜è®¤ä½¿ç”¨<strong>YUVFullRange</strong>çš„è¡¨ç¤ºæ ¼å¼ï¼Œæ‰€è°“çš„FullRangeï¼Œè¡¨ç¤ºYUVçš„å–å€¼èŒƒå›´æ˜¯0åˆ°255ï¼›è¿˜æœ‰ä¸€ç§æ˜¯<strong>YUVVideoRange</strong>çš„è¡¨ç¤ºæ ¼å¼ï¼Œä¸ºäº†é˜²æ­¢æº¢å‡ºï¼Œæˆ‘ä»¬æŠŠYUVçš„å–å€¼èŒƒå›´è®¾ç½®æˆ16åˆ°235ã€‚Rangeçš„ç±»å‹ä¼šå†³å®šYUVæ ¼å¼è½¬æ¢ä¸ºRGBAæ ¼å¼æ—¶ä½¿ç”¨çš„çŸ©é˜µï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦æ ¹æ®æ”¯æŒçš„æ ¼å¼æ¥è®¾ç½®ï¼Œå¹¶ä¸”è®°å½•è®¾ç½®çš„æ ¼å¼ï¼Œä¹‹åç”¨æ¥ç¡®å®šYUVåˆ°RGBAçš„è½¬æ¢çŸ©é˜µã€‚</p><p>æ¥ç€å°†captureInputå®ä¾‹å’ŒcaptureOutputå®ä¾‹é…ç½®åˆ°CaptureSessionä¸­ã€‚</p><pre><code class=\"language-plain\">if ([self.captureSession canAddInput:self.captureInput]) {\n&nbsp;&nbsp;&nbsp; &nbsp;[self.captureSession addInput:self.captureInput];\n&nbsp; }\nif ([self.captureSession canAddOutput:self.captureOutput]) {\n&nbsp;&nbsp;&nbsp; &nbsp;[self.captureSession addOutput:self.captureOutput];\n}\n</code></pre><p>ç„¶åè°ƒç”¨captureSessionè®¾ç½®åˆ†è¾¨ç‡çš„æ–¹æ³•ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹å¸¸è§çš„åˆ†è¾¨ç‡ä»¥åŠè®¾ç½®ä»£ç ã€‚</p><pre><code class=\"language-plain\">NSString* highResolution = AVCaptureSessionPreset1280x720;\nNSString* lowResolution = AVCaptureSessionPreset640x480;\n[_captureSession setSessionPreset:[NSString stringWithString: highResolution]];\n</code></pre><p>æ¥ç€è°ƒç”¨CaptureSessionçš„beginConfigurationæ–¹æ³•ï¼Œé…ç½®æ•´ä¸ªæ‘„åƒå¤´ä¼šè¯ï¼Œæœ€åå–å‡ºcaptureOutputé‡Œé¢çš„AVCaptureConnectionï¼Œæ¥é…ç½®æ‘„åƒå¤´è¾“å‡ºçš„æ–¹å‘ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœä¸é…ç½®è¿™ä¸ªå‚æ•°ï¼Œæ‘„åƒå¤´é»˜è®¤è¾“å‡ºæ¨ªå‘çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»£ç æŠŠå®ƒè®¾ç½®æˆçºµå‘å›¾ç‰‡è¾“å‡ºã€‚</p><pre><code class=\"language-plain\">conn.videoOrientation = AVCaptureVideoOrientationPortrait;\n</code></pre><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç»™CaptureInputè®¾ç½®å¸§ç‡ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p><h2>æ‘„åƒå¤´é‡‡é›†æ•°æ®å¤„ç†</h2><p>å‰é¢æˆ‘ä»¬å·²ç»å®ç°äº†AVCaptureVideoDataOutputSampleBufferDelegateè¿™ä¸ªåè®®ï¼Œé‡å†™äº†æ¥æ”¶æ‘„åƒå¤´é‡‡é›†æ•°æ®çš„æ–¹æ³•ï¼Œç­¾åå¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">-(void) captureOutput:(AVCaptureOutput*)captureOutput\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fromConnection:(AVCaptureConnection*)connection\n</code></pre><p>è¿™ä¸ªæ–¹æ³•ä¼šæŠŠå…·ä½“æ˜¯å“ªä¸€ä¸ªcaptureOutputä»¥åŠconnectionè¿”å›è¿‡æ¥ï¼Œä½†æ˜¯æœ€é‡è¦çš„å…¶å®æ˜¯CMSampleBufferç±»å‹çš„sampleBufferï¼Œè¿™é‡Œé¢å­˜å‚¨ç€æ‘„åƒå¤´é‡‡é›†åˆ°çš„å›¾åƒã€‚ä¸€ä¸ªCMSampleBufferç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul>\n<li>CMTimeï¼Œä»£è¡¨è¿™ä¸€å¸§å›¾åƒçš„æ—¶é—´ã€‚</li>\n<li>CMVideoFormatDescriptionï¼Œä»£è¡¨å¯¹è¿™ä¸€å¸§å›¾åƒæ ¼å¼çš„æè¿°ã€‚</li>\n<li>CVPixelBufferï¼Œä»£è¡¨è¿™ä¸€å¸§å›¾åƒçš„å…·ä½“æ•°æ®ã€‚</li>\n</ul><p>åœ¨è¿™ä¸ªå›è°ƒå‡½æ•°é‡Œï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä»æ‘„åƒå¤´é‡‡é›†åˆ°å›¾åƒæ¸²æŸ“çš„å…¨è¿‡ç¨‹ï¼Œè€Œæ¸²æŸ“éƒ¨åˆ†ä¼šä½¿ç”¨OpenGL ESæ¥æ“ä½œã€‚</p><p>ä¹‹å‰æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ä¸€ä¸ªé—®é¢˜ï¼ŒiOSå¹³å°ä¸å…è®¸Appè¿›å…¥åå°çš„æ—¶å€™è¿˜æ‰§è¡ŒOpenGLæ¸²æŸ“ï¼Œé€šç”¨çš„å¤„ç†æ–¹å¼å°±æ˜¯ä¹‹å‰åœ¨æ’­æ”¾å™¨ä¸­ç”¨åˆ°çš„æ–¹å¼ï¼Œåˆ†åˆ«æ³¨å†ŒapplicationWillResignActiveå’ŒapplicationDidBecomeActiveçš„é€šçŸ¥ï¼Œåœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­å°†è¿™ä¸ªç±»ä¸­çš„shouldEnableOpenGLå±æ€§è®¾ç½®ä¸ºNOå’ŒYESã€‚ç„¶ååœ¨å›è°ƒå‡½æ•°ä¸­åˆ¤æ–­è¿™ä¸ªå˜é‡ï¼Œå†³å®šæ˜¯å¦å¯ä»¥æ‰§è¡ŒOpenGLçš„æ“ä½œã€‚</p><pre><code class=\"language-plain\">-(void) captureOutput:(AVCaptureOutput*)captureOutput didOutputSampleBuffer:\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (CMSampleBufferRef)sampleBuffer fromConnection:\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (AVCaptureConnection*)connection {\n&nbsp;&nbsp;&nbsp; if (self.shouldEnableOpenGL) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dispatch_semaphore_wait(_frameRenderingSemaphore,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DISPATCH_TIME_NOW) != 0) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;\n&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CFRetain(sampleBuffer);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runAsyncOnVideoProcessingQueue(^{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [self processVideoSampleBuffer:sampleBuffer];\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CFRelease(sampleBuffer);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dispatch_semaphore_signal(_frameRenderingSemaphore);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });\n&nbsp;&nbsp;&nbsp; }\n}\n</code></pre><p>ä»£ç æ˜¾ç¤ºï¼Œé¦–å…ˆè¦åˆ¤æ–­è¿™ä¸ªå¸ƒå°”å‹çš„å˜é‡ï¼Œå¦‚æœæ˜¯NOçš„è¯ï¼Œå°±ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼›å¦‚æœæ˜¯YESçš„è¯ï¼Œè¦ä¿è¯ä¸Šä¸€æ¬¡æ¸²æŸ“æ‰§è¡Œç»“æŸäº†<span class=\"reference\">ï¼ˆé€šè¿‡dispatch_semaphoreçš„waitæ¥ç¡®å®šï¼‰</span>æ‰å¯ä»¥æ‰§è¡Œæœ¬æ¬¡æ¸²æŸ“æ“ä½œã€‚</p><p>æ‰§è¡Œæ¸²æŸ“æ“ä½œçš„æ—¶å€™é¦–å…ˆè¦ä½¿ç”¨CFRetainé”å®šè¿™ä¸ªsampleBufferï¼Œå› ä¸ºçœŸæ­£ä½¿ç”¨sampleBufferçš„åœ°æ–¹æ˜¯åœ¨OpenGL ESçº¿ç¨‹ä¸­ï¼Œåªæœ‰è¿™é‡ŒRetainä½æ‰èƒ½ä¿è¯sampleBufferä¸è¢«æ±¡æŸ“ï¼Œç­‰è¿™ä¸€æ¬¡OpenGL ESçš„æ¸²æŸ“æ“ä½œç»“æŸä»¥åï¼Œå†ä½¿ç”¨CFReleaseé‡Šæ”¾è¿™ä¸ªsampleBufferã€‚æœ€åç»™semaphoreå‘ä¸€ä¸ªsignalæŒ‡ä»¤ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹çœŸæ­£çš„æ¸²æŸ“æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•processVideoSampleBufferçš„å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦å°†sampleBufferå¯¹è±¡æ¸²æŸ“æˆä¸ºä¸€ä¸ªçº¹ç†å¯¹è±¡ï¼Œç„¶åè°ƒç”¨åç»­çš„targetsèŠ‚ç‚¹è¿›è¡Œæ¸²æŸ“ã€‚</p><p>æˆ‘ä»¬å…ˆå–å‡ºè¿™ä¸ªsampleBufferä¸­çš„å›¾åƒæ•°æ®ï¼Œå³å®ƒçš„å±æ€§CVPixelBufferï¼Œç„¶åæˆ‘ä»¬éœ€è¦ç¡®å®šè¿™ä¸ªCVPixelBufferé‡Œé¢YUVè½¬æ¢æˆRGBçš„çŸ©é˜µã€‚æˆ‘ä»¬æ ¹æ®ä¸¤æ–¹é¢çš„å†…å®¹æ¥ç¡®å®šè¿™ä¸ªçŸ©é˜µã€‚</p><ul>\n<li>ç»™æ‘„åƒå¤´é…ç½®çš„åƒç´ æ ¼å¼ï¼Œæ˜¯YUVFullRangeè¿˜æ˜¯YUVVideoRangeï¼›</li>\n<li>å–å‡ºPixelBufferé‡Œé¢çš„YUVè½¬æ¢ç±»å‹ï¼Œæˆ‘ä»¬åˆ¤æ–­è¿™ä¸ªç±»å‹æ˜¯ITU601è¿˜æ˜¯ITU709æ ¼å¼ï¼ŒITU601æ˜¯SDTVçš„æ ‡å‡†ï¼Œè€ŒITU709æ˜¯HDTVçš„æ ‡å‡†ï¼Œå› ä¸ºæ ‡æ¸…ä¸é«˜æ¸…å¯¹åº”çš„YUVè½¬æ¢ä¸ºRGBçš„çŸ©é˜µæ˜¯ä¸åŒçš„ã€‚</li>\n</ul><p>è¿™ä¸¤æ–¹é¢å…±åŒå†³å®šäº†YUVè½¬æ¢æˆRGBçš„çŸ©é˜µï¼Œå…¶ä¸­åªæœ‰ITU601åˆ†ä¸ºYUVFullRangeå’ŒYUVVideoRangeä¸¤ç§ï¼Œè€ŒITU709å°±åªæœ‰ä¸€ç§ï¼Œæ ¹æ®ç»„åˆä»ä»¥ä¸‹ä¸‰ä¸ªçŸ©é˜µä¸­é€‰å‡ºåˆé€‚çš„çŸ©é˜µã€‚</p><pre><code class=\"language-plain\">GLfloat colorConversion601Default[] = {\n&nbsp;&nbsp;&nbsp; 1.164,&nbsp; 1.164, &nbsp;&nbsp;1.164,\n&nbsp;&nbsp;&nbsp; 0.0, &nbsp;&nbsp;&nbsp;-0.392, &nbsp;2.017,\n&nbsp;&nbsp;&nbsp; 1.596, -0.813,&nbsp;&nbsp; 0.0,\n};\nGLfloat colorConversion601FullRangeDefault[] = {\n&nbsp;&nbsp;&nbsp; 1.0,&nbsp;&nbsp;&nbsp; 1.0,&nbsp;&nbsp;&nbsp; &nbsp;1.0,\n&nbsp;&nbsp;&nbsp; 0.0,&nbsp;&nbsp;&nbsp; -0.343, 1.765,\n&nbsp;&nbsp;&nbsp; 1.4,&nbsp;&nbsp;&nbsp; -0.711, 0.0,\n};\nGLfloat colorConversion709Default[] = {\n&nbsp;&nbsp;&nbsp; 1.164,&nbsp; 1.164, &nbsp;&nbsp;1.164,\n&nbsp;&nbsp;&nbsp; 0.0, &nbsp;&nbsp;&nbsp;-0.213, &nbsp;2.112,\n&nbsp;&nbsp;&nbsp; 1.793, -0.533,&nbsp;&nbsp; 0.0,\n};\n</code></pre><p>å‡†å¤‡å·¥ä½œå®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥å°±è¿›å…¥çœŸæ­£æ¸²æŸ“è¿‡ç¨‹ã€‚</p><p>å…ˆç»‘å®šOpenGL ESçš„ä¸Šä¸‹æ–‡ï¼Œéœ€è¦è°ƒç”¨å‰é¢æˆ‘ä»¬å°è£…çš„ELImageContextç»‘å®šä¸Šä¸‹æ–‡çš„æ–¹æ³•ã€‚ç„¶ååˆ›å»ºè¿™ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºçº¹ç†å¯¹è±¡ï¼Œå°±æ˜¯æ„å»ºä¸€ä¸ªELImageTextureFrameå¯¹è±¡ï¼Œå¹¶ä¸”æ¿€æ´»è¿™ä¸ªçº¹ç†å¯¹è±¡<span class=\"reference\">ï¼ˆä»£è¡¨è¿™ä¸ªæ¸²æŸ“è¿‡ç¨‹çš„ç›®æ ‡å°±æ˜¯è¿™ä¸ªçº¹ç†å¯¹è±¡ï¼‰</span>ã€‚</p><p>å‡†å¤‡è¾“å…¥çº¹ç†ï¼Œè¦å°†CVPixelBufferä¸­çš„YUVæ•°æ®å…³è”åˆ°ä¸¤ä¸ªçº¹ç†IDä¸Šã€‚å¦‚æœæ˜¯åœ¨å…¶ä»–å¹³å°ä¸Šï¼Œåªèƒ½é€šè¿‡OpenGL ESæä¾›çš„glTexImage2Dæ–¹æ³•ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®ä¸Šä¼ åˆ°æ˜¾å¡çš„ä¸€ä¸ªçº¹ç†IDä¸Šã€‚ä½†æ˜¯è¿™ç§å†…å­˜å’Œæ˜¾å­˜ä¹‹é—´çš„æ•°æ®äº¤æ¢æ•ˆç‡æ˜¯æ¯”è¾ƒä½çš„ï¼Œåœ¨iOSå¹³å°çš„CoreVideo frameworkä¸­æä¾›äº†CVOpenGLESTextureCacheCreateTextureFromImageæ–¹æ³•ï¼Œå¯ä»¥ä½¿æ•´ä¸ªäº¤æ¢è¿‡ç¨‹æ›´åŠ é«˜æ•ˆã€‚</p><p>ç”±äºCVPixelBufferå†…éƒ¨æ•°æ®æ˜¯YUVæ•°æ®æ ¼å¼çš„ï¼Œæ‰€ä»¥å¯åˆ†é…ä»¥ä¸‹ä¸¤ä¸ªçº¹ç†å¯¹è±¡åˆ†åˆ«å­˜å‚¨Yå’ŒUVçš„æ•°æ®ã€‚</p><pre><code class=\"language-plain\">CVOpenGLESTextureRef luminanceTextureRef = NULL;\nCVOpenGLESTextureRef chrominanceTextureRef = NULL;\n</code></pre><p>éœ€è¦åœ¨ä½¿ç”¨CVPixelBufferè¿™å—å†…å­˜åŒºåŸŸä¹‹å‰ï¼Œå…ˆé”å®šè¿™ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨å®Œæ¯•ä¹‹åè§£é”ã€‚ä»¥ä¸‹ä»£ç å¯é”å®šè¿™ä¸ªPixelBufferã€‚</p><pre><code class=\"language-plain\">CVPixelBufferLockBaseAddress(pixelBuffer, 0);\n</code></pre><p>ç„¶åæ‹¿å‡ºè¿™é‡Œé¢çš„Yé€šé“éƒ¨åˆ†çš„å†…å®¹ï¼Œä¸Šä¼ åˆ°luminanceTextureé‡Œã€‚</p><pre><code class=\"language-plain\">CVOpenGLESTextureCacheCreateTextureFromImage(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kCFAllocatorDefault, coreVideoTextureCache, pixelBuffer,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL, GL_TEXTURE_2D, GL_LUMINANCE, bufferWidth,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bufferHeight, GL_LUMINANCE, GL_UNSIGNED_BYTE, 0,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;luminanceTextureRef);\n</code></pre><p>ä»£ç ä¸­ä¼ å…¥äº†pixelBufferä»¥åŠæ ¼å¼GL_LUMINANCEï¼Œè¿˜éœ€è¦ä¼ å…¥å®½å’Œé«˜ã€‚è¿™æ ·è¿™ä¸ªAPIå†…éƒ¨å°±çŸ¥é“è®¿é—®pixelBufferçš„å“ªéƒ¨åˆ†æ•°æ®äº†ï¼Œé‡Œé¢è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ï¼Œå°±æ˜¯çº¹ç†ç¼“å­˜ï¼Œè€Œåˆ›å»ºçš„çº¹ç†ä¼šä»è¿™ä¸ªçº¹ç†ç¼“å­˜ä¸­æ‹¿å‡ºæ¥ï¼Œçº¹ç†ç¼“å­˜çš„åˆ›å»ºä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">CVOpenGLESTextureCacheCreate(kCFAllocatorDefault, NULL, context, NULL, &amp;coreVideoTextureCache)\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆ›å»ºçº¹ç†ç¼“å­˜å¿…é¡»è¦ä¼ å…¥OpenGLä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬åœ¨ELImageContextä¸­ç»´æŠ¤ä¸€ä¸ªçº¹ç†ç¼“å­˜ã€‚ä½¿ç”¨Yé€šé“çš„æ•°æ®å†…å®¹åˆ›å»ºå‡ºæ¥çš„çº¹ç†å¯¹è±¡å¯ä»¥é€šè¿‡CVOpenGLESTextureGetNameæ¥è·å–å‡ºçº¹ç†IDã€‚ä»¥ä¸‹ä»£ç å¯ä»¥æŠŠUVé€šé“éƒ¨åˆ†ä¸Šä¼ åˆ°chrominanceTextureRefé‡Œã€‚</p><pre><code class=\"language-plain\">CVOpenGLESTextureCacheCreateTextureFromImage(kCFAllocatorDefault, coreVideoTextureCache, pixelBuffer,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL, GL_TEXTURE_2D, GL_LUMINANCE_ALPHA, bufferWidth/2,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bufferHeight/2, GL_LUMINANCE_ALPHA, GL_UNSIGNED_BYTE, 1,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;chrominanceTextureRef)\n</code></pre><p>YUV420Pæ ¼å¼è§„å®šï¼Œ<strong>æ¯å››ä¸ªåƒç´ ä¼šæœ‰ä¸€ä¸ªUå’Œä¸€ä¸ªVï¼Œç”¨GL_LUMINANCE_ALPHAæ¥è¡¨ç¤ºUVéƒ¨åˆ†ï¼Œå³Uæ”¾åˆ°Luminanceéƒ¨åˆ†ï¼ŒVæ”¾åˆ°Alphaéƒ¨åˆ†</strong>ã€‚ç†è§£è¿™ä¸€ç‚¹æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºè¿™å…³ä¹åé¢åœ¨FragmentShaderä¸­å¦‚ä½•æ‹¿åˆ°æ­£ç¡®çš„YUVæ•°æ®ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯å®é™…çš„æ¸²æŸ“äº†ï¼Œåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼Œä¸€æ˜¯ç¡®å®šç‰©ä½“åæ ‡å’Œçº¹ç†åæ ‡ï¼›äºŒæ˜¯åœ¨FragmentShaderä¸­ï¼Œæ€ä¹ˆæŠŠYUVè½¬æ¢æˆRGBAçš„è¡¨ç¤ºæ ¼å¼ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹å¦‚ä½•ç¡®å®šç‰©ä½“åæ ‡å’Œçº¹ç†åæ ‡ï¼Œç‰©ä½“åæ ‡å…¶å®æ˜¯å›ºå®šçš„ï¼Œç‰©ä½“åæ ‡å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">GLfloat squareVertices[8] = {\n&nbsp;&nbsp;&nbsp; &nbsp; -1.0,&nbsp; -1.0, //ç‰©ä½“å·¦ä¸‹è§’\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;1.0ï¼Œ&nbsp; -1.0ï¼Œ//ç‰©ä½“å³ä¸‹è§’\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1.0ï¼Œ 1.0ï¼Œ //ç‰©ä½“å·¦ä¸Šè§’\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ&nbsp; 1.0&nbsp; &nbsp;//ç‰©ä½“å³ä¸Šè§’\n};\n</code></pre><p>è€Œç¡®å®šçº¹ç†åæ ‡ä¼šéº»çƒ¦ä¸€ç‚¹ï¼Œè®°å¾—æˆ‘ä»¬ä¹‹å‰è®²è¿‡ï¼ŒOpenGLçº¹ç†åæ ‡ç³»å’Œè®¡ç®—æœºåæ ‡ç³»æ˜¯ä¸åŒçš„å—ï¼Ÿæ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¹ç†åæ ‡å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">GLfloat textureCoords[8] = {\n&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;0.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0ï¼Œ0.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ0.0&nbsp;\n};\n</code></pre><p>è¿›è¡Œæ—‹è½¬ä»¥åŠé•œåƒçš„æ—¶å€™ï¼Œéƒ½æ˜¯æ ¹æ®è¿™ä¸ªçº¹ç†åæ ‡æ¥å®æ–½çš„ã€‚å·¦è¾¹ç¬¬ä¸€å¼ å›¾æ˜¯å‰ç½®æ‘„åƒå¤´é‡‡é›†åˆ°çš„å›¾åƒã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/55/67/55ba32b41ebb9c71e5f6bc4484563a67.png?wh=1656x520\" alt=\"å›¾ç‰‡\"></p><p>è¦æƒ³æ­£ç¡®åœ°æ˜¾ç¤ºï¼Œéœ€è¦å…ˆæŒ‰ç…§é¡ºæ—¶é’ˆæ—‹è½¬90åº¦ï¼Œç”±äºæ˜¯å‰ç½®æ‘„åƒå¤´ï¼Œè¿˜å¾—åšä¸€ä¸ªé•œåƒå¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„çº¹ç†åæ ‡å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">GLfloat textureCoords[8] = {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ0.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0ï¼Œ0.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0ï¼Œ1.0&nbsp;\n};\n</code></pre><p>å¦‚æœæ˜¯åç½®æ‘„åƒå¤´ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”é¡ºæ—¶é’ˆæ—‹è½¬90åº¦ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8b/1d/8b3b195d4337c405e20ca96f2b931a1d.png?wh=1388x544\" alt=\"å›¾ç‰‡\"></p><p>é¡ºæ—¶é’ˆæ—‹è½¬90åº¦çš„çº¹ç†åæ ‡å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">GLfloat textureCoords[8] = {\n&nbsp;&nbsp; &nbsp;&nbsp; 1.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ0.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0ï¼Œ0.0&nbsp;\n};\n</code></pre><p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œ<strong>ç”±äºæŠŠçº¹ç†åšäº†90åº¦çš„æ—‹è½¬ï¼Œæ‰€ä»¥ç›®æ ‡çº¹ç†å¯¹è±¡å®½é«˜å’Œè¾“å…¥çº¹ç†ï¼ˆCVPixelBufferï¼‰çš„å®½é«˜éœ€è¦å¯¹è°ƒä¸€ä¸‹ã€‚</strong></p><p>ä¸Šè¿°çº¹ç†åæ ‡æ˜¯é»˜è®¤æ‘„åƒå¤´ç»™å‡ºçš„å›¾åƒçº¹ç†åæ ‡ï¼Œä½†å‰é¢æˆ‘ä»¬ç»™æ‘„åƒå¤´åšè¿‡ä¸€ä¸ªç‰¹æ®Šçš„è®¾ç½®ï¼Œå°±æ˜¯ç»™ AVCaptureConnectionè®¾ç½®videoOrientationè¿™ä¸ªå‚æ•°ï¼Œæ‘„åƒå¤´é»˜è®¤æ˜¯æ¨ªå‘è§†é¢‘è¾“å‡ºï¼Œå½“æŠŠè¿™ä¸ªå‚æ•°è®¾ç½®ä¸ºPortraitæ—¶ï¼Œå°±è¦æ±‚æ‘„åƒå¤´æŒ‰ç…§ç«–ç›´æ–¹å‘è¾“å‡ºè§†é¢‘ã€‚è¿™æ—¶å€™ç›®æ ‡çº¹ç†å¯¹è±¡çš„å®½é«˜å’ŒCVPixelBufferçš„å®½é«˜ä¸€è‡´äº†ï¼Œé‚£ä¹ˆåç½®æ‘„åƒå¤´é‡‡é›†å‡ºæ¥çš„å›¾åƒç›´æ¥ç»˜åˆ¶å³å¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/63/66/63d39de16a151d2751658c0e1cdace66.png?wh=1340x556\" alt=\"å›¾ç‰‡\"></p><p>æ‰€å¯¹åº”çš„çº¹ç†åæ ‡ä¸ºï¼š</p><pre><code class=\"language-plain\">GLfloat textureCoords[8] = {\n&nbsp; &nbsp;&nbsp;&nbsp; 0.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp; &nbsp; 1.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.0ï¼Œ0.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.0ï¼Œ0.0&nbsp;\n};\n</code></pre><p>è€Œå‰ç½®æ‘„åƒå¤´ç”±äºé•œåƒçš„åŸå› ï¼Œæ‰€ä»¥ç»˜åˆ¶è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/4f/29/4f4a14caa305cb4f9b3e7cb6f36a5529.png?wh=1374x538\" alt=\"å›¾ç‰‡\"></p><p>æ­¤æ—¶çš„çº¹ç†åæ ‡æ­£å¥½å’Œåç½®æ‘„åƒå¤´çš„æ¯ä¸€ä¸ªåæ ‡çš„Xç‚¹ç›¸åã€‚</p><pre><code class=\"language-plain\">GLfloat textureCoords[8] = {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0ï¼Œ1.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.0ï¼Œ0.0ï¼Œ\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0ï¼Œ0.0&nbsp;\n};\n</code></pre><p>ç¡®å®šç‰©ä½“åæ ‡ä¸çº¹ç†åæ ‡ä¹‹åï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹å¦‚ä½•åœ¨FragmentShaderä¸­ï¼Œå°†YUVè½¬æ¢æˆRGBAã€‚æ³¨æ„ï¼šè¿™é‡Œæ˜¯ä¸€å®šè¦è½¬æ¢ä¸ºRGBAçš„ï¼Œå› ä¸ºåœ¨OpenGLä¸­é€šç”¨çš„æ¸²æŸ“çº¹ç†æ ¼å¼éƒ½æ˜¯RGBAçš„ï¼ŒåŒ…æ‹¬çº¹ç†å¤„ç†ã€æ¸²æŸ“åˆ°å±å¹•ä¸Šä»¥åŠæœ€ç»ˆç¼–ç å™¨ï¼Œéƒ½æ˜¯ä»¥RGBAæ ¼å¼ä¸ºåŸºç¡€è¿›è¡Œè½¬æ¢å’Œå¤„ç†çš„ã€‚åœ¨æ’­æ”¾å™¨çš„éƒ¨åˆ†æˆ‘ä»¬å·²ç»åšè¿‡ä¸€æ¬¡YUVè½¬RGBçš„æ“ä½œï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº†CoreVideoè¿™ä¸ªframeworkä¸‹çš„å¿«é€Ÿä¸Šä¼ ï¼Œè¾“å…¥çš„çº¹ç†å˜å¾—ä¸ä¸€æ ·äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“çš„FragmentShaderã€‚</p><pre><code class=\"language-plain\">varying highp vec2 textureCoordinate;\nuniform sampler2D luminanceTexture;\nuniform sampler2D chrominanceTexture;\nuniform mediump mat3 colorConversionMatrix;\nvoid main(){\n&nbsp;&nbsp;&nbsp; mediump vec3 yuv;\n&nbsp;&nbsp;&nbsp; lowp vec3 rgb;\n&nbsp;&nbsp;&nbsp; yuv.x = texture2D(luminanceTexture, textureCoordinate).r;\n&nbsp;&nbsp;&nbsp; yuv.yz = texture2D(chrominanceTexture, textureCoordinate).ra - vec2(0.5, 0.5);\n&nbsp;&nbsp;&nbsp; rgb = colorConversionMatrix * yuv;\n&nbsp;&nbsp;&nbsp; gl_FragColor = vec4(rgb, 1);\n}\n</code></pre><p>å…¶ä¸­textureCoordinateæ˜¯çº¹ç†åæ ‡ï¼Œè€Œè¿™ä¸¤ä¸ªsampler2Dç±»å‹å°±æ˜¯ä»CVPixelBufferé‡Œé¢ä¸Šä¼ åˆ°æ˜¾å­˜ä¸­çš„çº¹ç†å¯¹è±¡ï¼Œ3*3çš„çŸ©é˜µå°±æ˜¯å‰é¢æ ¹æ®åƒç´ æ ¼å¼ï¼Œä»¥åŠæ˜¯å¦ä¸ºFullRangeé€‰æ‹©çš„å˜æ¢çŸ©é˜µã€‚æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹å¦‚ä½•å–å‡ºYå’ŒUVã€‚</p><ul>\n<li>ç”±äºluminanceTextureä½¿ç”¨çš„æ˜¯GL_LUMINANCEæ ¼å¼ä¸Šä¼ ä¸Šæ¥çš„çº¹ç†ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨texture2Då‡½æ•°æ‹¿å‡ºåƒç´ ç‚¹ä¹‹åï¼Œè®¿é—®å…ƒç´ rå°±å¯ä»¥æ‹¿åˆ°Yé€šé“çš„å€¼äº†ã€‚</li>\n<li>è€ŒUVé€šé“ä½¿ç”¨çš„æ˜¯GL_LUMINANCE_ALPHAæ ¼å¼ï¼Œé€šè¿‡texture2Då–å‡ºåƒç´ ç‚¹ä¹‹åï¼Œè®¿é—®å…ƒç´ rå¾—åˆ°Uçš„å€¼ï¼Œè®¿é—®å…ƒç´ aå¾—åˆ°Vçš„å€¼ã€‚ä½†ä¸ºä»€ä¹ˆUVå€¼è¦å‡å»0.5ï¼ˆæ¢ç®—ä¸º0-255å°±æ˜¯å‡å»127ï¼‰ï¼Ÿè¿™æ˜¯å› ä¸ºUVæ˜¯è‰²å½©åˆ†é‡ï¼Œå½“æ•´å¼ å›¾ç‰‡æ˜¯é»‘ç™½çš„æ—¶å€™ï¼ŒUVåˆ†é‡æ˜¯é»˜è®¤å€¼127ï¼Œæ‰€ä»¥è¿™é‡Œè¦å…ˆå‡å»127ï¼Œç„¶åå†è½¬æ¢æˆRGBï¼Œå¦åˆ™ä¼šå‡ºç°è‰²å½©ä¸åŒ¹é…çš„é”™è¯¯ã€‚</li>\n</ul><p>æœ€åä½¿ç”¨ä¼ é€’è¿›æ¥çš„è½¬æ¢çŸ©é˜µä¹˜ä»¥YUVï¼Œå¾—åˆ°è¿™ä¸ªåƒç´ ç‚¹çš„RGBAè¡¨ç¤ºæ ¼å¼ï¼Œå¹¶èµ‹å€¼ç»™gl_FragColorã€‚</p><p>åˆ°è¿™é‡Œï¼ŒELImageVideoCameraè¿™ä¸ªç±»çš„æ ¸å¿ƒé€»è¾‘æˆ‘ä»¬å°±å­¦å®Œäº†ï¼Œæœ€ç»ˆè¿™ä¸ªèŠ‚ç‚¹ä¼šè¾“å‡ºä¸€ä¸ªçº¹ç†IDï¼Œè¿™ä¸ªçº¹ç†IDå¯ä»¥ç›´æ¥æ¸²æŸ“åˆ°ELImageViewä¸­è®©ç”¨æˆ·çœ‹åˆ°æ‘„åƒå¤´é¢„è§ˆçš„æ•ˆæœã€‚</p><h2>å°ç»“</h2><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹ã€‚</p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è®¾è®¡å¹¶å®ç°å‡ºä¸€ä¸ªELImageè§†é¢‘æ¡†æ¶çš„æ¶æ„ï¼ŒåŒ…å«ELImageInputã€ELImageOutputã€ELImageProgramã€ELImageTextureFrameå’ŒELImageContextäº”ä¸ªåŸºç¡€ç±»ã€‚ç„¶ååŸºäºè¿™äº”ä¸ªç±»å¯ä»¥æ‰©å±•å‡ºä¼—å¤šç»„ä»¶ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/69/82/695b81a17036848ff70224cf4b365782.png?wh=1792x922\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬åˆ©ç”¨æ¡†æ¶æ ¸å¿ƒå®Œæˆäº†è§†é¢‘ç”»é¢çš„é‡‡é›†ï¼Œç”¨çš„å°±æ˜¯ELImageVideoCameraè¿™ä¸ªç±»ã€‚è¿™ä¸ªèŠ‚ç‚¹æœ€ç»ˆä¼šè¾“å‡ºä¸€ä¸ªRGBAç±»å‹çš„çº¹ç†ï¼Œè¿™ä¸ªçº¹ç†å¯ä»¥ç»™åˆ°åç»­çš„ELImageFilterèŠ‚ç‚¹åšç¾é¢œå¤„ç†ï¼Œæœ€ç»ˆè¾“å‡ºåˆ°ELImageViewä¸­ï¼Œæ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ‰“å¼€æ‘„åƒå¤´é¢„è§ˆçš„è¿‡ç¨‹ã€‚</p><p>ELImageè¿™ä¸ªæ ¸å¿ƒæ¡†æ¶å¾ˆé‡è¦ï¼Œæˆ‘ä»¬éœ€è¦å¥½å¥½â€œæ¶ˆåŒ–â€è¿™éƒ¨åˆ†å†…å®¹ï¼Œå› ä¸ºè¿™ä¸ªè§†é¢‘æ¡†æ¶åç»­ä¼šç”¨åˆ°ï¼Œå¹¶ä¸”åŸºäºè¿™ä¸ªè§†é¢‘æ¡†æ¶ï¼Œæˆ‘ä»¬è¿˜ä¼šå¢åŠ ä¸€äº›å…¶ä»–èŠ‚ç‚¹ï¼Œæ¯”å¦‚ELImageVideoEncoderç­‰ï¼Œä¹Ÿå°±æ˜¯å½“ç”¨æˆ·ç‚¹å‡»å½•åˆ¶çš„æ—¶å€™ï¼Œå°†çº¹ç†IDä¼ å…¥åˆ°EncoderèŠ‚ç‚¹å°±å¯ä»¥å½•åˆ¶å‡ºè§†é¢‘æ–‡ä»¶æ¥ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ELImageæ¡†æ¶è¿˜å¯ä»¥æ‰©å±•å‡ºè®¸å¤šå…¶ä»–çš„èŠ‚ç‚¹ï¼Œç»„æˆå¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚è§†é¢‘ç¼–è¾‘å™¨åœºæ™¯ï¼Œå¦‚æœè®©ä½ ä¹¦å†™ä¸€ä¸ªELImageMovieèŠ‚ç‚¹ï¼Œç„¶åä¸ELImageFilterä»¥åŠELImageViewç»„åˆæˆè§†é¢‘ç¼–è¾‘å™¨ï¼Œä½ å°†å¦‚ä½•å®ŒæˆELImageMovieçš„è®¾è®¡å‘¢ï¼Ÿåœ¨è¯„è®ºåŒºä¸­ç»™å‡ºä½ çš„æ€è€ƒï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šå¯¹éŸ³è§†é¢‘æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµã€å…±åŒè¿›æ­¥ã€‚ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"13ï½œå¦‚ä½•ä½¿ç”¨ç¡¬ä»¶ç¼–ç å™¨æ¥ç¼–ç  AACï¼Ÿ","id":554444},"right":{"article_title":"15 ï½œ Androidå¹³å°æ˜¯å¦‚ä½•é‡‡é›†è§†é¢‘ç”»é¢çš„ï¼Ÿ","id":557500}},"comments":[{"had_liked":false,"id":364770,"user_name":"keepgoing","can_delete":false,"product_type":"c1","uid":1471387,"ip_address":"åŒ—äº¬","ucode":"A2FE0687FB17E0","user_header":"https://static001.geekbang.org/account/avatar/00/16/73/9b/67a38926.jpg","comment_is_top":false,"comment_ctime":1671462453,"is_pvip":false,"replies":[{"id":132948,"content":"1 ç†è§£å‡†ç¡®ï¼›\n2 å¯¹çš„ï¼Œç¼–ç èŠ‚ç‚¹å°†æ¯ä¸€å¸§ä»æ˜¾å­˜ä¸­è·å–åˆ°YUVæ•°æ®ï¼Œåœ¨è¿›è¡Œç¼–ç æ“ä½œï¼›ä½†æ˜¯iOSä½¿ç”¨CoreVideoFrameworkæœ‰å¿«é€Ÿçš„æ“ä½œï¼Œå…·ä½“çœ‹æºç \n3 åº•å±‚åŸç†ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œæˆ‘ç†è§£çš„æ˜¯iOSæœ¬èº«åšäº†æ˜ å°„ï¼Œæ¯•ç«Ÿæ‰‹æœºä¸­çš„æ˜¾å­˜éƒ½æ˜¯å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼›","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3069513,"ctime":1672141060,"ip_address":"åŒ—äº¬","comment_id":364770,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100117601,"comment_content":"è€å¸ˆæœ‰ä¸‰ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸€ä¸‹ï¼š\n1. é€šè¿‡è¿™ä¸ªé‡‡é›†æ¸²æŸ“æ¡†æ¶ï¼Œèƒ½å¦ç†è§£ä¸ºæ‘„åƒå¤´é‡‡é›†-&gt;ç¼–è¾‘-&gt;æ¸²æŸ“çš„è¿‡ç¨‹å°±æ˜¯ä»æ‘„åƒå¤´ä¸­æ‹¿åˆ°åŸå§‹å›¾åƒï¼Œç„¶åç»è¿‡æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸æ–­æ¸²æŸ“åˆ°æ˜¾å­˜ä¸­çš„ä¸€ä¸ªçº¹ç†IDä¸Šï¼Œæœ€ç»ˆåœ¨æ˜¾ç¤ºèŠ‚ç‚¹ä¸ŠæŠŠæ¯ä¸€å±‚æ¸²æŸ“å¥½çš„çº¹ç†æ˜¾ç¤ºåˆ°ç›®æ ‡viewä¸Šï¼Ÿ\n2. å¦‚æœéœ€è¦ç¼–ç è¿™ä¸ªæœ€ç»ˆçš„å›¾åƒï¼Œæ˜¯éœ€è¦ç¼–ç èŠ‚ç‚¹æ¯ä¸€å¸§éƒ½ä»æ˜¾å­˜ä¸­è·å–å—ï¼Ÿ\n3. è€å¸ˆåœ¨æ–‡ä¸­æåˆ°äº†æ¯æ¬¡å°†å†…å­˜å›¾ç‰‡ä¸Šä¼ æ˜¾å­˜æ˜¯ä¸€ä¸ªå¾ˆä½æ•ˆçš„åšæ³•ï¼Œå¯ä»¥ä½¿ç”¨CVOpenGLESTextureCacheCreateTextureFromImage APIï¼Œè¯·é—®è¿™ä¸ªAPIçš„åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Œæ˜¯æ€ä¹ˆåšåˆ°é«˜æ•ˆå†…å­˜-&gt;æ˜¾å­˜çš„æ“ä½œå‘¢\n\næ„Ÿè°¢è€å¸ˆçš„è§£ç­”ï¼Œè¾›è‹¦äº†","like_count":0,"discussions":[{"author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":597679,"discussion_content":"1 ç†è§£å‡†ç¡®ï¼›\n2 å¯¹çš„ï¼Œç¼–ç èŠ‚ç‚¹å°†æ¯ä¸€å¸§ä»æ˜¾å­˜ä¸­è·å–åˆ°YUVæ•°æ®ï¼Œåœ¨è¿›è¡Œç¼–ç æ“ä½œï¼›ä½†æ˜¯iOSä½¿ç”¨CoreVideoFrameworkæœ‰å¿«é€Ÿçš„æ“ä½œï¼Œå…·ä½“çœ‹æºç \n3 åº•å±‚åŸç†ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œæˆ‘ç†è§£çš„æ˜¯iOSæœ¬èº«åšäº†æ˜ å°„ï¼Œæ¯•ç«Ÿæ‰‹æœºä¸­çš„æ˜¾å­˜éƒ½æ˜¯å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1672141061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1471387,"avatar":"https://static001.geekbang.org/account/avatar/00/16/73/9b/67a38926.jpg","nickname":"keepgoing","note":"","ucode":"A2FE0687FB17E0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":598378,"discussion_content":"æ„Ÿè°¢è€å¸ˆçš„è§£ç­”ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1672800801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":597679,"ip_address":"åŒ—äº¬","group_id":0},"score":598378,"extra":""}]}]},{"had_liked":false,"id":355366,"user_name":"ä¸€ä¸ªæ­£ç›´çš„å°é¾™çŒ«","can_delete":false,"product_type":"c1","uid":1028139,"ip_address":"åŒ—äº¬","ucode":"7C9CFFAA299D1A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b0/2b/87aff702.jpg","comment_is_top":false,"comment_ctime":1661319544,"is_pvip":false,"replies":[{"id":129416,"content":"æ— è®ºæ˜¯ä»€ä¹ˆåè®®å½¢å¼çš„è§†é¢‘ç›´æ’­ï¼Œé‡‡é›†ç”»é¢éƒ½æ˜¯ç¬¬ä¸€æ­¥ï¼Œéƒ½ç¦»ä¸å¼€å„è‡ªå¹³å°æ‘„åƒå¤´é‡‡é›†APIçš„è°ƒç”¨ã€‚\nreplayKitåªæ˜¯å½•å±çš„ä¸€ç§æ‰‹æ®µï¼Œä»–æœ€ç»ˆä¹Ÿæ˜¯äº§ç”ŸCMSampleBufferï¼Œffmpegæ›´å¤šçš„ç”¨åœ¨ç¼–è§£ç (muxer&#47;demuxer protocol)å±‚ï¼Œè¿™ä¿©æ˜¯å±äºä¸€ä¸ªç³»ç»Ÿä¸­ä¸åŒå±‚çš„æŠ€æœ¯å®ç°æ‰‹æ®µã€‚åœ¨è¯¦ç»†ä¸€ç‚¹è¯´ï¼Œreplaykitä½ å¯ä»¥ç†è§£ä¸ºæ˜¯ä»£æ›¿äº†æ‘„åƒå¤´å’Œå½•éŸ³å™¨ï¼Œä½†æ˜¯é‡‡é›†åˆ°è£¸æ•°æ®ï¼ˆYUVã€PCMï¼‰ä¹‹åè¿˜æ˜¯éœ€è¦ffmpegçš„è½¯ä»¶ç¼–ç æˆ–è€…å¹³å°çš„ç¡¬ä»¶ç¼–ç å™¨æ¥ç¼–ç æˆä¸ºæœ€ç»ˆçš„è§†é¢‘æ–‡ä»¶æˆ–è€…æ¨æµå‡ºå»çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3069513,"ctime":1661589320,"ip_address":"åŒ—äº¬","comment_id":355366,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100117601,"comment_content":"è¯·æ•™è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼š\nè¿™ä¸ªæ˜¯æ‘„åƒå¤´é‡‡é›†è§†é¢‘ç”»é¢ï¼Œå¦‚æœæ˜¯webrtcç›´æ’­è§†é¢‘æµå‘¢ï¼Ÿ\næƒ³å½•åˆ¶è§†é¢‘ï¼Œé‡‡é›†ç›´æ’­æµçš„è§†é¢‘å’ŒéŸ³é¢‘ï¼Œç”¨ä»€ä¹ˆæŠ€æœ¯æ–¹æ¡ˆå®ç°æ˜¯æœ€ä½³çš„ï¼Ÿreplaykit2è¿˜æ˜¯ffmepgï¼Œä»–ä¿©å¯¹æ¯”ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ \n","like_count":0,"discussions":[{"author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585481,"discussion_content":"æ— è®ºæ˜¯ä»€ä¹ˆåè®®å½¢å¼çš„è§†é¢‘ç›´æ’­ï¼Œé‡‡é›†ç”»é¢éƒ½æ˜¯ç¬¬ä¸€æ­¥ï¼Œéƒ½ç¦»ä¸å¼€å„è‡ªå¹³å°æ‘„åƒå¤´é‡‡é›†APIçš„è°ƒç”¨ã€‚\nreplayKitåªæ˜¯å½•å±çš„ä¸€ç§æ‰‹æ®µï¼Œä»–æœ€ç»ˆä¹Ÿæ˜¯äº§ç”ŸCMSampleBufferï¼Œffmpegæ›´å¤šçš„ç”¨åœ¨ç¼–è§£ç (muxer/demuxer protocol)å±‚ï¼Œè¿™ä¿©æ˜¯å±äºä¸€ä¸ªç³»ç»Ÿä¸­ä¸åŒå±‚çš„æŠ€æœ¯å®ç°æ‰‹æ®µã€‚åœ¨è¯¦ç»†ä¸€ç‚¹è¯´ï¼Œreplaykitä½ å¯ä»¥ç†è§£ä¸ºæ˜¯ä»£æ›¿äº†æ‘„åƒå¤´å’Œå½•éŸ³å™¨ï¼Œä½†æ˜¯é‡‡é›†åˆ°è£¸æ•°æ®ï¼ˆYUVã€PCMï¼‰ä¹‹åè¿˜æ˜¯éœ€è¦ffmpegçš„è½¯ä»¶ç¼–ç æˆ–è€…å¹³å°çš„ç¡¬ä»¶ç¼–ç å™¨æ¥ç¼–ç æˆä¸ºæœ€ç»ˆçš„è§†é¢‘æ–‡ä»¶æˆ–è€…æ¨æµå‡ºå»çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661589320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1028139,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b0/2b/87aff702.jpg","nickname":"ä¸€ä¸ªæ­£ç›´çš„å°é¾™çŒ«","note":"","ucode":"7C9CFFAA299D1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585206,"discussion_content":"è¡¥å……ä¸€ä¸‹ ijkplayerå‘¢ï¼Ÿ  è¿˜æ˜¯VideoToolbox ï¼Ÿ è¯·è€å¸ˆå…·ä½“è®²è®² ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661396706,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"è¾½å®","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355352,"user_name":"Neil43","can_delete":false,"product_type":"c1","uid":1067171,"ip_address":"åŒ—äº¬","ucode":"10F3039818E3BE","user_header":"https://wx.qlogo.cn/mmopen/vi_32/2nM9PaEsM4XTZuqQiavicyRuibcp8n1tBpL9mFTRbeqn47dzU9eGNoicJYUOO8tUiaU6pT2D8rjmG0DlBv1eFVWZrkQ/132","comment_is_top":false,"comment_ctime":1661312537,"is_pvip":false,"replies":[{"id":129417,"content":"ä¸èƒ½æ­£å¸¸ç”Ÿæˆçš„ã€‚\nä½ å¯ä»¥æ£€æŸ¥ä¸€ä¸‹çŠ¶æ€ï¼ŒAVAssetWriterçš„çŠ¶æ€ï¼Œå¦‚æœä»–çš„çŠ¶æ€ä¸æ˜¯â€œå¯å†™å…¥â€çŠ¶æ€å°±ä¸èƒ½å»appendBufferï¼Œè€Œæ˜¯çœ‹çœ‹çŠ¶æ€ä¸ºä»€ä¹ˆé”™è¯¯ï¼Œæ¯”å¦‚æ–‡ä»¶è·¯å¾„ä¹‹ç±»çš„é—®é¢˜ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3069513,"ctime":1661589409,"ip_address":"åŒ—äº¬","comment_id":355352,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117601,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘åœ¨ä½¿ç”¨AVFoundationæ¡†æ¶çš„AVAssetWriterinput ï¼Œè¿½åŠ SampleBufferæŠ¥é”™ï¼Œå…³é”®ä»£ç ï¼š\nAVAsset WriterInput *videoInput = [AVAsset WriterInput\nasset WriterInput WithMediaType:AVMediaTypeVideo\noutputSettings:videoSettings];\nassetWriter = [[AVAssetWriter alloc] initWithURL: _URL\nfileType:AVFileTypeQuickTimeMovie error: &amp;error];\n[assetWriter addInput:_videolnput];\nBOOL success = [videoInput appendSampleBuffer:sampleBuffer];\n\nå…·ä½“æŠ¥é”™ä¿¡æ¯ï¼š\nuserInfo={\nNSLocalizedFailureReason = An unknown error occurred (-12780),\nNSLocalizedDescription = The operation could not be completed,\nNSUnderlyingError = Error Domain=NSOSStatusErrorDomain Code=-12780\n&quot;(null)â€}\n\nè¯·é—®è€å¸ˆçŸ¥é“å¤§æ¦‚æ˜¯ä»€ä¹ˆåŸå› å—ï¼Ÿå¦‚æœappendSampleBufferæ–¹æ³•æŠ¥é”™ï¼Œå†è°ƒç”¨finishWritingWithCompletionHandleræ–¹æ³•ï¼Œèƒ½æ­£å¸¸ç”Ÿæˆè§†é¢‘å—ï¼Ÿè°¢è°¢ã€‚\n\n\n","like_count":0,"discussions":[{"author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585483,"discussion_content":"ä¸èƒ½æ­£å¸¸ç”Ÿæˆçš„ã€‚\nä½ å¯ä»¥æ£€æŸ¥ä¸€ä¸‹çŠ¶æ€ï¼ŒAVAssetWriterçš„çŠ¶æ€ï¼Œå¦‚æœä»–çš„çŠ¶æ€ä¸æ˜¯â€œå¯å†™å…¥â€çŠ¶æ€å°±ä¸èƒ½å»appendBufferï¼Œè€Œæ˜¯çœ‹çœ‹çŠ¶æ€ä¸ºä»€ä¹ˆé”™è¯¯ï¼Œæ¯”å¦‚æ–‡ä»¶è·¯å¾„ä¹‹ç±»çš„é—®é¢˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661589410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355340,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1661306894,"is_pvip":false,"replies":[{"id":129415,"content":"ä½ è¯´çš„åº”è¯¥æ˜¯æ­Œå£°åˆæˆï¼Œç°åœ¨ä¸šç•Œå†…æœ‰å‡ ç§å®ç°æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒhttps:&#47;&#47;github.com&#47;oxygen-dioxide&#47;vogenï¼Œä½†æ˜¯æ•ˆæœéƒ½ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œè¦ä¹ˆæœºæ¢°å£°è¿‡äºä¸¥é‡ï¼Œè¦ä¹ˆä¸åƒï¼Œä¹‹å‰é˜¿é‡Œæœ‰ä¸€ä¸ªäº§å“å«é²¸é¸£åšè¿‡è¿™ç§ç±»å‹çš„ä¿®éŸ³ï¼Œèµ·ç åœ¨ç›´æ¥toCçš„äº§å“ä¸Šæ²¡æœ‰é‚£ä¹ˆå¤§çš„çˆ†å‘åŠ›ï¼Œå’Œå½“æ—¶çš„ZAOè¿™ç§åˆ©ç”¨DeepFakeçš„è§†è§‰ç”Ÿæˆç»™ç”¨æˆ·çš„æ„ŸæŸ“åŠ›ä¸ä¸€æ ·ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3069513,"ctime":1661589125,"ip_address":"åŒ—äº¬","comment_id":355340,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100117601,"comment_content":"è¯·æ•™è€å¸ˆä¸€ä¸ªé—®é¢˜ï¼š\nQ1ï¼šAIå”±æ­Œï¼Œæœ‰èƒ½å¤Ÿä½¿ç”¨çš„è½¯ä»¶å—ï¼Ÿï¼ˆå¼€æºã€ä»˜è´¹çš„éƒ½å¯ä»¥ï¼‰ã€‚ AIå”±æ­Œï¼Œæ˜¯æŒ‡ç”¨ä¸€ä¸ªäººçš„å£°éŸ³æŠŠä¸€é¦–æ­Œå®Œæ•´çš„å”±å‡ºæ¥ã€‚æ¯”å¦‚æœ‰ç‰¹æœ—æ™®çš„ä¸€æ®µéŸ³é¢‘ï¼ˆæ¯”å¦‚30så£°éŸ³ç‰‡æ®µï¼‰ï¼Œç„¶åè½¯ä»¶æ ¹æ®è¿™ä¸ªå£°éŸ³ç‰‡æ®µï¼Œå°±å¯ä»¥æŠŠã€Šå¥½æ±‰æ­Œã€‹å”±å‡ºæ¥ã€‚æ•ˆæœå°±æ˜¯å¬ä¼—è®¤ä¸ºæ˜¯ç‰¹æœ—æ™®å”±çš„ã€Šå¥½æ±‰æ­Œã€‹ã€‚","like_count":0,"discussions":[{"author":{"id":3069513,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/d6/49/27f68f7d.jpg","nickname":"Kevin","note":"","ucode":"5FCE361CB8C187","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":585479,"discussion_content":"ä½ è¯´çš„åº”è¯¥æ˜¯æ­Œå£°åˆæˆï¼Œç°åœ¨ä¸šç•Œå†…æœ‰å‡ ç§å®ç°æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒhttps://github.com/oxygen-dioxide/vogenï¼Œä½†æ˜¯æ•ˆæœéƒ½ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œè¦ä¹ˆæœºæ¢°å£°è¿‡äºä¸¥é‡ï¼Œè¦ä¹ˆä¸åƒï¼Œä¹‹å‰é˜¿é‡Œæœ‰ä¸€ä¸ªäº§å“å«é²¸é¸£åšè¿‡è¿™ç§ç±»å‹çš„ä¿®éŸ³ï¼Œèµ·ç åœ¨ç›´æ¥toCçš„äº§å“ä¸Šæ²¡æœ‰é‚£ä¹ˆå¤§çš„çˆ†å‘åŠ›ï¼Œå’Œå½“æ—¶çš„ZAOè¿™ç§åˆ©ç”¨DeepFakeçš„è§†è§‰ç”Ÿæˆç»™ç”¨æˆ·çš„æ„ŸæŸ“åŠ›ä¸ä¸€æ ·ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1661589125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":376291,"user_name":"æœˆåŠæœ¨å­ğŸŠ","can_delete":false,"product_type":"c1","uid":1167330,"ip_address":"ç¦å»º","ucode":"2406ABA8F11AFA","user_header":"https://static001.geekbang.org/account/avatar/00/11/cf/e2/975f9a2a.jpg","comment_is_top":false,"comment_ctime":1686650361,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100117601,"comment_content":"è¯·é—®è€å¸ˆï¼Œè¿™ä¸ªå®ç°å¦‚ä½•è‡ªæµ‹æ˜¯å¦æ»¡è¶³éœ€æ±‚å‘¢ï¼Œè‡ªæµ‹éœ€è¦å…³æ³¨å“ªäº›æµ‹è¯•ç‚¹å‘¢","like_count":0}]}