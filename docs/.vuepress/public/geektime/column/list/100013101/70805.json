{"id":70805,"title":"49 | ç¨‹åºæ€§èƒ½åˆ†æåŸºç¡€ï¼ˆä¸‹ï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒæ—ï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­åˆ†äº«ç¨‹åºæ€§èƒ½åˆ†æåŸºç¡€çš„å†…å®¹ã€‚</p><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å›´ç»•ç€â€œæ€æ ·è®©ç¨‹åºå¯¹CPUæ¦‚è¦ä¿¡æ¯è¿›è¡Œé‡‡æ ·â€è¿™ä¸€é—®é¢˜è¿›è¡Œäº†æ¢è®¨ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å†æ¥ä¸€èµ·çœ‹çœ‹å®ƒçš„æ‹“å±•é—®é¢˜ã€‚</p><h2>çŸ¥è¯†æ‰©å±•</h2><h3>é—®é¢˜1ï¼šæ€æ ·è®¾å®šå†…å­˜æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·é¢‘ç‡ï¼Ÿ</h3><p>é’ˆå¯¹å†…å­˜æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·ä¼šæŒ‰ç…§ä¸€å®šæ¯”ä¾‹æ”¶é›†Goç¨‹åºåœ¨è¿è¡ŒæœŸé—´çš„å †å†…å­˜ä½¿ç”¨æƒ…å†µã€‚è®¾å®šå†…å­˜æ¦‚è¦ä¿¡æ¯é‡‡æ ·é¢‘ç‡çš„æ–¹æ³•å¾ˆç®€å•ï¼Œåªè¦ä¸º<code>runtime.MemProfileRate</code>å˜é‡èµ‹å€¼å³å¯ã€‚</p><p>è¿™ä¸ªå˜é‡çš„å«ä¹‰æ˜¯ï¼Œå¹³å‡æ¯åˆ†é…å¤šå°‘ä¸ªå­—èŠ‚ï¼Œå°±å¯¹å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œä¸€æ¬¡é‡‡æ ·ã€‚å¦‚æœæŠŠè¯¥å˜é‡çš„å€¼è®¾ä¸º<code>0</code>ï¼Œé‚£ä¹ˆï¼ŒGoè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿå°±ä¼šå®Œå…¨åœæ­¢å¯¹å†…å­˜æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·ã€‚è¯¥å˜é‡çš„ç¼ºçœå€¼æ˜¯<code>512 KB</code>ï¼Œä¹Ÿå°±æ˜¯<code>512</code>åƒå­—èŠ‚ã€‚</p><p>æ³¨æ„ï¼Œå¦‚æœä½ è¦è®¾å®šè¿™ä¸ªé‡‡æ ·é¢‘ç‡ï¼Œé‚£ä¹ˆè¶Šæ—©è®¾å®šè¶Šå¥½ï¼Œå¹¶ä¸”åªåº”è¯¥è®¾å®šä¸€æ¬¡ï¼Œå¦åˆ™å°±å¯èƒ½ä¼šå¯¹Goè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿçš„é‡‡æ ·å·¥ä½œï¼Œé€ æˆä¸è‰¯å½±å“ã€‚æ¯”å¦‚ï¼Œåªåœ¨<code>main</code>å‡½æ•°çš„å¼€å§‹å¤„è®¾å®šä¸€æ¬¡ã€‚</p><p>åœ¨è¿™ä¹‹åï¼Œå½“æˆ‘ä»¬æƒ³è·å–å†…å­˜æ¦‚è¦ä¿¡æ¯çš„æ—¶å€™ï¼Œè¿˜éœ€è¦è°ƒç”¨<code>runtime/pprof</code>åŒ…ä¸­çš„<code>WriteHeapProfile</code>å‡½æ•°ã€‚è¯¥å‡½æ•°ä¼šæŠŠæ”¶é›†å¥½çš„å†…å­˜æ¦‚è¦ä¿¡æ¯ï¼Œå†™åˆ°æˆ‘ä»¬æŒ‡å®šçš„å†™å…¥å™¨ä¸­ã€‚</p><p>æ³¨æ„ï¼Œæˆ‘ä»¬é€šè¿‡<code>WriteHeapProfile</code>å‡½æ•°å¾—åˆ°çš„å†…å­˜æ¦‚è¦ä¿¡æ¯å¹¶ä¸æ˜¯å®æ—¶çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¿«ç…§ï¼Œæ˜¯åœ¨æœ€è¿‘ä¸€æ¬¡çš„å†…å­˜åƒåœ¾æ”¶é›†å·¥ä½œå®Œæˆæ—¶äº§ç”Ÿçš„ã€‚å¦‚æœä½ æƒ³è¦å®æ—¶çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥è°ƒç”¨<code>runtime.ReadMemStats</code>å‡½æ•°ã€‚ä¸è¿‡è¦ç‰¹åˆ«æ³¨æ„ï¼Œè¯¥å‡½æ•°ä¼šå¼•èµ·Goè¯­è¨€è°ƒåº¦å™¨çš„çŸ­æš‚åœé¡¿ã€‚</p><!-- [[[read_end]]] --><p>ä»¥ä¸Šï¼Œå°±æ˜¯å…³äºå†…å­˜æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·é¢‘ç‡è®¾å®šé—®é¢˜çš„ç®€è¦å›ç­”ã€‚</p><h3>é—®é¢˜2ï¼šæ€æ ·è·å–åˆ°é˜»å¡æ¦‚è¦ä¿¡æ¯ï¼Ÿ</h3><p>æˆ‘ä»¬è°ƒç”¨<code>runtime</code>åŒ…ä¸­çš„<code>SetBlockProfileRate</code>å‡½æ•°ï¼Œå³å¯å¯¹é˜»å¡æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·é¢‘ç‡è¿›è¡Œè®¾å®šã€‚è¯¥å‡½æ•°æœ‰ä¸€ä¸ªåå«<code>rate</code>çš„å‚æ•°ï¼Œå®ƒæ˜¯<code>int</code>ç±»å‹çš„ã€‚</p><p>è¿™ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ï¼Œåªè¦å‘ç°ä¸€ä¸ªé˜»å¡äº‹ä»¶çš„æŒç»­æ—¶é—´è¾¾åˆ°äº†å¤šå°‘ä¸ªçº³ç§’ï¼Œå°±å¯ä»¥å¯¹å…¶è¿›è¡Œé‡‡æ ·ã€‚å¦‚æœè¿™ä¸ªå‚æ•°çš„å€¼å°äºæˆ–ç­‰äº<code>0</code>ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€Goè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿå°†ä¼šå®Œå…¨åœæ­¢å¯¹é˜»å¡æ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·ã€‚</p><p>åœ¨<code>runtime</code>åŒ…ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªåå«<code>blockprofilerate</code>çš„åŒ…çº§ç§æœ‰å˜é‡ï¼Œå®ƒæ˜¯<code>uint64</code>ç±»å‹çš„ã€‚è¿™ä¸ªå˜é‡çš„å«ä¹‰æ˜¯ï¼Œåªè¦å‘ç°ä¸€ä¸ªé˜»å¡äº‹ä»¶çš„æŒç»­æ—¶é—´è·¨è¶Šäº†å¤šå°‘ä¸ªCPUæ—¶é’Ÿå‘¨æœŸï¼Œå°±å¯ä»¥å¯¹å…¶è¿›è¡Œé‡‡æ ·ã€‚å®ƒçš„å«ä¹‰ä¸æˆ‘ä»¬åˆšåˆšæåˆ°çš„<code>rate</code>å‚æ•°çš„å«ä¹‰éå¸¸ç›¸ä¼¼ï¼Œä¸æ˜¯å—ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œè¿™ä¸¤è€…çš„åŒºåˆ«ä»…ä»…åœ¨äºå•ä½ä¸åŒã€‚<code>runtime.SetBlockProfileRate</code>å‡½æ•°ä¼šå…ˆå¯¹å‚æ•°<code>rate</code>çš„å€¼è¿›è¡Œå•ä½æ¢ç®—å’Œå¿…è¦çš„ç±»å‹è½¬æ¢ï¼Œç„¶åï¼Œå®ƒä¼šæŠŠæ¢ç®—ç»“æœç”¨åŸå­æ“ä½œèµ‹ç»™<code>blockprofilerate</code>å˜é‡ã€‚ç”±äºæ­¤å˜é‡çš„ç¼ºçœå€¼æ˜¯<code>0</code>ï¼Œæ‰€ä»¥Goè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿåœ¨é»˜è®¤æƒ…å†µä¸‹å¹¶ä¸ä¼šè®°å½•ä»»ä½•åœ¨ç¨‹åºä¸­å‘ç”Ÿçš„é˜»å¡äº‹ä»¶ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œå½“æˆ‘ä»¬éœ€è¦è·å–é˜»å¡æ¦‚è¦ä¿¡æ¯çš„æ—¶å€™ï¼Œéœ€è¦å…ˆè°ƒç”¨<code>runtime/pprof</code>åŒ…ä¸­çš„<code>Lookup</code>å‡½æ•°å¹¶ä¼ å…¥å‚æ•°å€¼<code>\"block\"</code>ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ª<code>*runtime/pprof.Profile</code>ç±»å‹çš„å€¼ï¼ˆä»¥ä¸‹ç®€ç§°<code>Profile</code>å€¼ï¼‰ã€‚åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒç”¨è¿™ä¸ª<code>Profile</code>å€¼çš„<code>WriteTo</code>æ–¹æ³•ï¼Œä»¥é©±ä½¿å®ƒæŠŠæ¦‚è¦ä¿¡æ¯å†™è¿›æˆ‘ä»¬æŒ‡å®šçš„å†™å…¥å™¨ä¸­ã€‚</p><p>è¿™ä¸ª<code>WriteTo</code>æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬åˆšåˆšæåˆ°çš„å†™å…¥å™¨ï¼Œå®ƒæ˜¯<code>io.Writer</code>ç±»å‹çš„ã€‚è€Œå¦ä¸€ä¸ªå‚æ•°åˆ™æ˜¯ä»£è¡¨äº†æ¦‚è¦ä¿¡æ¯è¯¦ç»†ç¨‹åº¦çš„<code>int</code>ç±»å‹å‚æ•°<code>debug</code>ã€‚</p><p><code>debug</code>å‚æ•°ä¸»è¦çš„å¯é€‰å€¼æœ‰ä¸¤ä¸ªï¼Œå³ï¼š<code>0</code>å’Œ<code>1</code>ã€‚å½“<code>debug</code>çš„å€¼ä¸º<code>0</code>æ—¶ï¼Œé€šè¿‡<code>WriteTo</code>æ–¹æ³•å†™è¿›å†™å…¥å™¨çš„æ¦‚è¦ä¿¡æ¯ä»…ä¼šåŒ…å«<code>go tool pprof</code>å·¥å…·æ‰€éœ€çš„å†…å­˜åœ°å€ï¼Œè¿™äº›å†…å­˜åœ°å€ä¼šä»¥åå…­è¿›åˆ¶çš„å½¢å¼å±•ç°å‡ºæ¥ã€‚</p><p>å½“è¯¥å€¼ä¸º<code>1</code>æ—¶ï¼Œç›¸åº”çš„åŒ…åã€å‡½æ•°åã€æºç æ–‡ä»¶è·¯å¾„ã€ä»£ç è¡Œå·ç­‰ä¿¡æ¯å°±éƒ½ä¼šä½œä¸ºæ³¨é‡Šè¢«åŠ å…¥è¿›å»ã€‚å¦å¤–ï¼Œ<code>debug</code>ä¸º<code>0</code>æ—¶çš„æ¦‚è¦ä¿¡æ¯ï¼Œä¼šç»ç”±protocol buffersè½¬æ¢ä¸ºå­—èŠ‚æµã€‚è€Œåœ¨<code>debug</code>ä¸º<code>1</code>çš„æ—¶å€™ï¼Œ<code>WriteTo</code>æ–¹æ³•è¾“å‡ºçš„è¿™äº›æ¦‚è¦ä¿¡æ¯å°±æ˜¯æˆ‘ä»¬å¯ä»¥è¯»æ‡‚çš„æ™®é€šæ–‡æœ¬äº†ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>debug</code>çš„å€¼ä¹Ÿå¯ä»¥æ˜¯<code>2</code>ã€‚è¿™æ—¶ï¼Œè¢«è¾“å‡ºçš„æ¦‚è¦ä¿¡æ¯ä¹Ÿä¼šæ˜¯æ™®é€šçš„æ–‡æœ¬ï¼Œå¹¶ä¸”é€šå¸¸ä¼šåŒ…å«æ›´å¤šçš„ç»†èŠ‚ã€‚è‡³äºè¿™äº›ç»†èŠ‚éƒ½åŒ…å«äº†å“ªäº›å†…å®¹ï¼Œé‚£å°±è¦çœ‹æˆ‘ä»¬è°ƒç”¨<code>runtime/pprof.Lookup</code>å‡½æ•°çš„æ—¶å€™ä¼ å…¥çš„æ˜¯ä»€ä¹ˆæ ·çš„å‚æ•°å€¼äº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥ä¸€èµ·çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p><h3>é—®é¢˜ 3ï¼š<code>runtime/pprof.Lookup</code>å‡½æ•°çš„æ­£ç¡®è°ƒç”¨æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p><code>runtime/pprof.Lookup</code>å‡½æ•°ï¼ˆä»¥ä¸‹ç®€ç§°<code>Lookup</code>å‡½æ•°ï¼‰çš„åŠŸèƒ½æ˜¯ï¼Œæä¾›ä¸ç»™å®šçš„åç§°ç›¸å¯¹åº”çš„æ¦‚è¦ä¿¡æ¯ã€‚è¿™ä¸ªæ¦‚è¦ä¿¡æ¯ä¼šç”±ä¸€ä¸ª<code>Profile</code>å€¼ä»£è¡¨ã€‚å¦‚æœè¯¥å‡½æ•°è¿”å›äº†ä¸€ä¸ª<code>nil</code>ï¼Œé‚£ä¹ˆå°±è¯´æ˜ä¸å­˜åœ¨ä¸ç»™å®šåç§°å¯¹åº”çš„æ¦‚è¦ä¿¡æ¯ã€‚</p><p><code>runtime/pprof</code>åŒ…å·²ç»ä¸ºæˆ‘ä»¬é¢„å…ˆå®šä¹‰äº†6ä¸ªæ¦‚è¦åç§°ã€‚å®ƒä»¬å¯¹åº”çš„æ¦‚è¦ä¿¡æ¯æ”¶é›†æ–¹æ³•å’Œè¾“å‡ºæ–¹æ³•ä¹Ÿéƒ½å·²ç»å‡†å¤‡å¥½äº†ã€‚æˆ‘ä»¬ç›´æ¥æ‹¿æ¥ä½¿ç”¨å°±å¯ä»¥äº†ã€‚å®ƒä»¬æ˜¯ï¼š<code>goroutine</code>ã€<code>heap</code>ã€<code>allocs</code>ã€<code>threadcreate</code>ã€<code>block</code>å’Œ<code>mutex</code>ã€‚</p><p>å½“æˆ‘ä»¬æŠŠ<code>\"goroutine\"</code>ä¼ å…¥<code>Lookup</code>å‡½æ•°çš„æ—¶å€™ï¼Œè¯¥å‡½æ•°ä¼šåˆ©ç”¨ç›¸åº”çš„æ–¹æ³•ï¼Œæ”¶é›†åˆ°å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ‰€æœ‰goroutineçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚æ³¨æ„ï¼Œè¿™æ ·çš„æ”¶é›†ä¼šå¼•èµ·Goè¯­è¨€è°ƒåº¦å™¨çš„çŸ­æš‚åœé¡¿ã€‚</p><p>å½“è°ƒç”¨è¯¥å‡½æ•°è¿”å›çš„<code>Profile</code>å€¼çš„<code>WriteTo</code>æ–¹æ³•æ—¶ï¼Œå¦‚æœå‚æ•°<code>debug</code>çš„å€¼å¤§äºæˆ–ç­‰äº<code>2</code>ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±ä¼šè¾“å‡ºæ‰€æœ‰goroutineçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯èƒ½ä¼šéå¸¸å¤šã€‚å¦‚æœå®ƒä»¬å ç”¨çš„ç©ºé—´è¶…è¿‡äº†<code>64 MB</code>ï¼ˆä¹Ÿå°±æ˜¯<code>64</code>å…†å­—èŠ‚ï¼‰ï¼Œé‚£ä¹ˆç›¸åº”çš„æ–¹æ³•å°±ä¼šå°†è¶…å‡ºçš„éƒ¨åˆ†æˆªæ‰ã€‚</p><p>å¦‚æœ<code>Lookup</code>å‡½æ•°æ¥åˆ°çš„å‚æ•°å€¼æ˜¯<code>\"heap\"</code>ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæ”¶é›†ä¸å †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æœ‰å…³çš„é‡‡æ ·ä¿¡æ¯ã€‚è¿™å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢è®¨è®ºè¿‡çš„å†…å­˜æ¦‚è¦ä¿¡æ¯ã€‚åœ¨æˆ‘ä»¬ä¼ å…¥<code>\"allocs\"</code>çš„æ—¶å€™ï¼Œåç»­çš„æ“ä½œä¼šä¸ä¹‹éå¸¸çš„ç›¸ä¼¼ã€‚</p><p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œ<code>Lookup</code>å‡½æ•°è¿”å›çš„<code>Profile</code>å€¼ä¹Ÿä¼šæå…¶ç›¸åƒã€‚åªä¸è¿‡ï¼Œåœ¨è¿™ä¸¤ç§<code>Profile</code>å€¼çš„<code>WriteTo</code>æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä»¬è¾“å‡ºçš„æ¦‚è¦ä¿¡æ¯ä¼šæœ‰ç»†å¾®çš„å·®åˆ«ï¼Œè€Œä¸”è¿™ä»…ä»…ä½“ç°åœ¨å‚æ•°<code>debug</code>ç­‰äº<code>0</code>çš„æ—¶å€™ã€‚</p><p><code>\"heap\"</code>ä¼šä½¿å¾—è¢«è¾“å‡ºçš„å†…å­˜æ¦‚è¦ä¿¡æ¯é»˜è®¤ä»¥â€œåœ¨ç”¨ç©ºé—´â€ï¼ˆinuse_spaceï¼‰çš„è§†è§’å‘ˆç°ï¼Œè€Œ<code>\"allocs\"</code>å¯¹åº”çš„é»˜è®¤è§†è§’åˆ™æ˜¯â€œå·²åˆ†é…ç©ºé—´â€ï¼ˆalloc_spaceï¼‰ã€‚</p><p>â€œåœ¨ç”¨ç©ºé—´â€æ˜¯æŒ‡ï¼Œå·²ç»è¢«åˆ†é…ä½†è¿˜æœªè¢«é‡Šæ”¾çš„å†…å­˜ç©ºé—´ã€‚åœ¨è¿™ä¸ªè§†è§’ä¸‹ï¼Œ<code>go tool pprof</code>å·¥å…·å¹¶ä¸ä¼šå»ç†ä¼šä¸å·²é‡Šæ”¾ç©ºé—´æœ‰å…³çš„é‚£éƒ¨åˆ†ä¿¡æ¯ã€‚è€Œåœ¨â€œå·²åˆ†é…ç©ºé—´â€çš„è§†è§’ä¸‹ï¼Œæ‰€æœ‰çš„å†…å­˜åˆ†é…ä¿¡æ¯éƒ½ä¼šè¢«å±•ç°å‡ºæ¥ï¼Œæ— è®ºè¿™äº›å†…å­˜ç©ºé—´åœ¨é‡‡æ ·æ—¶æ˜¯å¦å·²è¢«é‡Šæ”¾ã€‚</p><p>æ­¤å¤–ï¼Œæ— è®ºæ˜¯<code>\"heap\"</code>è¿˜æ˜¯<code>\"allocs\"</code>ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨<code>Profile</code>å€¼çš„<code>WriteTo</code>æ–¹æ³•çš„æ—¶å€™ï¼Œåªè¦èµ‹äºˆ<code>debug</code>å‚æ•°çš„å€¼å¤§äº<code>0</code>ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•è¾“å‡ºå†…å®¹çš„è§„æ ¼å°±ä¼šæ˜¯ç›¸åŒçš„ã€‚</p><p>å‚æ•°å€¼<code>\"threadcreate\"</code>ä¼šä½¿<code>Lookup</code>å‡½æ•°å»æ”¶é›†ä¸€äº›å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚è¿™äº›å †æ ˆè·Ÿè¸ªä¿¡æ¯ä¸­çš„æ¯ä¸€ä¸ªéƒ½ä¼šæç»˜å‡ºä¸€ä¸ªä»£ç è°ƒç”¨é“¾ï¼Œè¿™äº›è°ƒç”¨é“¾ä¸Šçš„ä»£ç éƒ½å¯¼è‡´æ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹äº§ç”Ÿã€‚è¿™æ ·çš„<code>Profile</code>å€¼çš„è¾“å‡ºè§„æ ¼ä¹Ÿåªæœ‰ä¸¤ç§ï¼Œå–å†³äºæˆ‘ä»¬ä¼ ç»™å…¶<code>WriteTo</code>æ–¹æ³•çš„å‚æ•°å€¼æ˜¯å¦å¤§äº<code>0</code>ã€‚</p><p>å†è¯´<code>\"block\"</code>å’Œ<code>\"mutex\"</code>ã€‚<code>\"block\"</code>ä»£è¡¨çš„æ˜¯ï¼Œå› äº‰ç”¨åŒæ­¥åŸè¯­è€Œè¢«é˜»å¡çš„é‚£äº›ä»£ç çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚è¿˜è®°å¾—å—ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢è®²è¿‡çš„é˜»å¡æ¦‚è¦ä¿¡æ¯ã€‚</p><p>ä¸ä¹‹ç›¸å¯¹åº”ï¼Œ<code>\"mutex\"</code>ä»£è¡¨çš„æ˜¯ï¼Œæ›¾ç»ä½œä¸ºåŒæ­¥åŸè¯­æŒæœ‰è€…çš„é‚£äº›ä»£ç ï¼Œå®ƒä»¬çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚å®ƒä»¬çš„è¾“å‡ºè§„æ ¼ä¹Ÿéƒ½åªæœ‰ä¸¤ç§ï¼Œå–å†³äº<code>debug</code>æ˜¯å¦å¤§äº<code>0</code>ã€‚</p><p>è¿™é‡Œæ‰€è¯´çš„åŒæ­¥åŸè¯­ï¼ŒæŒ‡çš„æ˜¯å­˜åœ¨äºGoè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿå†…éƒ¨çš„ä¸€ç§åº•å±‚çš„åŒæ­¥å·¥å…·ï¼Œæˆ–è€…è¯´ä¸€ç§åŒæ­¥æœºåˆ¶ã€‚</p><p>å®ƒæ˜¯ç›´æ¥é¢å‘å†…å­˜åœ°å€çš„ï¼Œå¹¶ä»¥å¼‚æ­¥ä¿¡å·é‡å’ŒåŸå­æ“ä½œä½œä¸ºå®ç°æ‰‹æ®µã€‚æˆ‘ä»¬å·²ç»ç†ŸçŸ¥çš„é€šé“ã€äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€â€WaitGroupâ€œï¼Œä»¥åŠGoè¯­è¨€è¿è¡Œæ—¶ç³»ç»Ÿæœ¬èº«ï¼Œéƒ½ä¼šåˆ©ç”¨å®ƒæ¥å®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/17/a7/17f957efc8fd583e2011c8ace0b7c7a7.png?wh=1849*981\" alt=\"\" title=\"runtime/pprof.Lookupå‡½æ•°ä¸€ç¥\"></p><p>å¥½äº†ï¼Œå…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å·²ç»è°ˆäº†ä¸å°‘äº†ã€‚æˆ‘ç›¸ä¿¡ï¼Œä½ å·²ç»å¯¹<code>Lookup</code>å‡½æ•°çš„è°ƒç”¨æ–¹å¼åŠå…¶èƒŒåçš„å«ä¹‰æœ‰äº†æ¯”è¾ƒæ·±åˆ»çš„ç†è§£äº†ã€‚demo99.goæ–‡ä»¶ä¸­åŒ…å«äº†ä¸€äº›ç¤ºä¾‹ä»£ç ï¼Œå¯ä¾›ä½ å‚è€ƒã€‚</p><h3>é—®é¢˜4ï¼šå¦‚ä½•ä¸ºåŸºäºHTTPåè®®çš„ç½‘ç»œæœåŠ¡æ·»åŠ æ€§èƒ½åˆ†ææ¥å£ï¼Ÿ</h3><p>è¿™ä¸ªé—®é¢˜è¯´èµ·æ¥è¿˜æ˜¯å¾ˆç®€å•çš„ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ä¸€èˆ¬æƒ…å†µä¸‹åªè¦åœ¨ç¨‹åºä¸­å¯¼å…¥<code>net/http/pprof</code>ä»£ç åŒ…å°±å¯ä»¥äº†ï¼Œå°±åƒè¿™æ ·ï¼š</p><pre><code>import _ &quot;net/http/pprof&quot;\n</code></pre><p>ç„¶åï¼Œå¯åŠ¨ç½‘ç»œæœåŠ¡å¹¶å¼€å§‹ç›‘å¬ï¼Œæ¯”å¦‚ï¼š</p><pre><code>log.Println(http.ListenAndServe(&quot;localhost:8082&quot;, nil))\n</code></pre><p>åœ¨è¿è¡Œè¿™ä¸ªç¨‹åºä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åœ¨ç½‘ç»œæµè§ˆå™¨ä¸­è®¿é—®<code>http://localhost:8082/debug/pprof</code>è¿™ä¸ªåœ°å€çœ‹åˆ°ä¸€ä¸ªç®€çº¦çš„ç½‘é¡µã€‚å¦‚æœä½ è®¤çœŸåœ°çœ‹äº†ä¸Šä¸€ä¸ªé—®é¢˜çš„è¯ï¼Œé‚£ä¹ˆè‚¯å®šå¯ä»¥å¿«é€Ÿææ˜ç™½è¿™ä¸ªç½‘é¡µä¸­å„ä¸ªéƒ¨åˆ†çš„å«ä¹‰ã€‚</p><p>åœ¨<code>/debug/pprof/</code>è¿™ä¸ªURLè·¯å¾„ä¸‹è¿˜æœ‰å¾ˆå¤šå¯ç”¨çš„å­è·¯å¾„ï¼Œè¿™ä¸€ç‚¹ä½ é€šè¿‡ç‚¹é€‰ç½‘é¡µä¸­çš„é“¾æ¥å°±å¯ä»¥äº†è§£åˆ°ã€‚åƒ<code>allocs</code>ã€<code>block</code>ã€<code>goroutine</code>ã€<code>heap</code>ã€<code>mutex</code>ã€<code>threadcreate</code>è¿™6ä¸ªå­è·¯å¾„ï¼Œåœ¨åº•å±‚å…¶å®éƒ½æ˜¯é€šè¿‡<code>Lookup</code>å‡½æ•°æ¥å¤„ç†çš„ã€‚å…³äºè¿™ä¸ªå‡½æ•°ï¼Œä½ åº”è¯¥å·²ç»å¾ˆç†Ÿæ‚‰äº†ã€‚</p><p>è¿™äº›å­è·¯å¾„éƒ½å¯ä»¥æ¥å—æŸ¥è¯¢å‚æ•°<code>debug</code>ã€‚å®ƒç”¨äºæ§åˆ¶æ¦‚è¦ä¿¡æ¯çš„æ ¼å¼å’Œè¯¦ç»†ç¨‹åº¦ã€‚è‡³äºå®ƒçš„å¯é€‰å€¼ï¼Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ã€‚å®ƒçš„ç¼ºçœå€¼æ˜¯<code>0</code>ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåå«<code>gc</code>çš„æŸ¥è¯¢å‚æ•°ã€‚å®ƒç”¨äºæ§åˆ¶æ˜¯å¦åœ¨è·å–æ¦‚è¦ä¿¡æ¯ä¹‹å‰å¼ºåˆ¶åœ°æ‰§è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚åªè¦å®ƒçš„å€¼å¤§äº<code>0</code>ï¼Œç¨‹åºå°±ä¼šè¿™æ ·åšã€‚ä¸è¿‡ï¼Œè¿™ä¸ªå‚æ•°ä»…åœ¨<code>/debug/pprof/heap</code>è·¯å¾„ä¸‹æœ‰æ•ˆã€‚</p><p>ä¸€æ—¦<code>/debug/pprof/profile</code>è·¯å¾„è¢«è®¿é—®ï¼Œç¨‹åºå°±ä¼šå»æ‰§è¡Œå¯¹CPUæ¦‚è¦ä¿¡æ¯çš„é‡‡æ ·ã€‚å®ƒæ¥å—ä¸€ä¸ªåä¸º<code>seconds</code>çš„æŸ¥è¯¢å‚æ•°ã€‚è¯¥å‚æ•°çš„å«ä¹‰æ˜¯ï¼Œé‡‡æ ·å·¥ä½œéœ€è¦æŒç»­å¤šå°‘ç§’ã€‚å¦‚æœè¿™ä¸ªå‚æ•°æœªè¢«æ˜¾å¼åœ°æŒ‡å®šï¼Œé‚£ä¹ˆé‡‡æ ·å·¥ä½œä¼šæŒç»­<code>30</code>ç§’ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œç¨‹åºåªä¼šå“åº”ç»protocol buffersè½¬æ¢çš„å­—èŠ‚æµã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>go tool pprof</code>å·¥å…·ç›´æ¥è¯»å–è¿™æ ·çš„HTTPå“åº”ï¼Œä¾‹å¦‚ï¼š</p><pre><code>go tool pprof http://localhost:6060/debug/pprof/profile?seconds=60\n</code></pre><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æˆ‘ä»¬å…³æ³¨çš„è·¯å¾„ï¼Œå³ï¼š<code>/debug/pprof/trace</code>ã€‚åœ¨è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œç¨‹åºä¸»è¦ä¼šåˆ©ç”¨<code>runtime/trace</code>ä»£ç åŒ…ä¸­çš„APIæ¥å¤„ç†æˆ‘ä»¬çš„è¯·æ±‚ã€‚</p><p>æ›´å…·ä½“åœ°è¯´ï¼Œç¨‹åºä¼šå…ˆè°ƒç”¨<code>trace.Start</code>å‡½æ•°ï¼Œç„¶ååœ¨æŸ¥è¯¢å‚æ•°<code>seconds</code>æŒ‡å®šçš„æŒç»­æ—¶é—´ä¹‹åå†è°ƒç”¨<code>trace.Stop</code>å‡½æ•°ã€‚è¿™é‡Œçš„<code>seconds</code>çš„ç¼ºçœå€¼æ˜¯<code>1</code>ç§’ã€‚è‡³äº<code>runtime/trace</code>ä»£ç åŒ…çš„åŠŸç”¨ï¼Œæˆ‘å°±ç•™ç»™ä½ è‡ªå·±å»æŸ¥é˜…å’Œæ¢ç´¢å§ã€‚</p><p>å‰é¢è¯´çš„è¿™äº›URLè·¯å¾„éƒ½æ˜¯å›ºå®šä¸å˜çš„ã€‚è¿™æ˜¯é»˜è®¤æƒ…å†µä¸‹çš„è®¿é—®è§„åˆ™ã€‚æˆ‘ä»¬è¿˜å¯ä»¥å¯¹å®ƒä»¬è¿›è¡Œå®šåˆ¶ï¼Œå°±åƒè¿™æ ·ï¼š</p><pre><code>mux := http.NewServeMux()\npathPrefix := &quot;/d/pprof/&quot;\nmux.HandleFunc(pathPrefix,\n\tfunc(w http.ResponseWriter, r *http.Request) {\n\t\tname := strings.TrimPrefix(r.URL.Path, pathPrefix)\n\t\tif name != &quot;&quot; {\n\t\t\tpprof.Handler(name).ServeHTTP(w, r)\n\t\t\treturn\n\t\t}\n\t\tpprof.Index(w, r)\n\t})\nmux.HandleFunc(pathPrefix+&quot;cmdline&quot;, pprof.Cmdline)\nmux.HandleFunc(pathPrefix+&quot;profile&quot;, pprof.Profile)\nmux.HandleFunc(pathPrefix+&quot;symbol&quot;, pprof.Symbol)\nmux.HandleFunc(pathPrefix+&quot;trace&quot;, pprof.Trace)\n\nserver := http.Server{\n\tAddr:    &quot;localhost:8083&quot;,\n\tHandler: mux,\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å‡ ä¹åªä½¿ç”¨äº†<code>net/http/pprof</code>ä»£ç åŒ…ä¸­çš„å‡ ä¸ªç¨‹åºå®ä½“ï¼Œå°±å®Œæˆäº†è¿™æ ·çš„å®šåˆ¶ã€‚è¿™åœ¨æˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ç½‘ç»œæœåŠ¡å¼€å‘æ¡†æ¶æ—¶å°¤å…¶æœ‰ç”¨ã€‚</p><p>æˆ‘ä»¬è‡ªå®šä¹‰çš„HTTPè¯·æ±‚å¤šè·¯å¤ç”¨å™¨<code>mux</code>æ‰€åŒ…å«çš„è®¿é—®è§„åˆ™ä¸é»˜è®¤çš„è§„åˆ™å¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡URLè·¯å¾„çš„å‰ç¼€æ›´çŸ­äº†ä¸€äº›è€Œå·²ã€‚</p><p>æˆ‘ä»¬å®šåˆ¶<code>mux</code>çš„è¿‡ç¨‹ä¸<code>net/http/pprof</code>åŒ…ä¸­çš„<code>init</code>å‡½æ•°æ‰€åšçš„äº‹æƒ…ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚è¿™ä¸ª<code>init</code>å‡½æ•°çš„å­˜åœ¨ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢ä»…ä»…å¯¼å…¥\"net/http/pprof\"ä»£ç åŒ…å°±èƒ½å¤Ÿè®¿é—®ç›¸å…³è·¯å¾„çš„åŸå› ã€‚</p><p>åœ¨æˆ‘ä»¬ç¼–å†™ç½‘ç»œæœåŠ¡ç¨‹åºçš„æ—¶å€™ï¼Œä½¿ç”¨<code>net/http/pprof</code>åŒ…è¦æ¯”ç›´æ¥ä½¿ç”¨<code>runtime/pprof</code>åŒ…æ–¹ä¾¿å’Œå®ç”¨å¾ˆå¤šã€‚é€šè¿‡åˆç†è¿ç”¨ï¼Œè¿™ä¸ªä»£ç åŒ…å¯ä»¥ä¸ºç½‘ç»œæœåŠ¡çš„ç›‘æµ‹æä¾›æœ‰åŠ›çš„æ”¯æ’‘ã€‚å…³äºè¿™ä¸ªåŒ…çš„çŸ¥è¯†ï¼Œæˆ‘å°±å…ˆä»‹ç»åˆ°è¿™é‡Œã€‚</p><h2>æ€»ç»“</h2><p>è¿™ä¸¤ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦è®²äº†Goç¨‹åºçš„æ€§èƒ½åˆ†æï¼Œæåˆ°çš„å¾ˆå¤šå†…å®¹éƒ½æ˜¯ä½ å¿…å¤‡çš„çŸ¥è¯†å’ŒæŠ€å·§ã€‚è¿™äº›æœ‰åŠ©äºä½ çœŸæ­£åœ°ç†è§£ä»¥é‡‡æ ·ã€æ”¶é›†ã€è¾“å‡ºä¸ºä»£è¡¨çš„ä¸€ç³»åˆ—æ“ä½œæ­¥éª¤ã€‚</p><p>æˆ‘æåˆ°çš„å‡ ç§æ¦‚è¦ä¿¡æ¯æœ‰å…³çš„é—®é¢˜ã€‚ä½ éœ€è¦è®°ä½çš„æ˜¯ï¼Œæ¯ä¸€ç§æ¦‚è¦ä¿¡æ¯éƒ½ä»£è¡¨äº†ä»€ä¹ˆï¼Œå®ƒä»¬åˆ†åˆ«éƒ½åŒ…å«äº†ä»€ä¹ˆæ ·çš„å†…å®¹ã€‚</p><p>ä½ è¿˜éœ€è¦çŸ¥é“è·å–å®ƒä»¬çš„æ­£ç¡®æ–¹å¼ï¼ŒåŒ…æ‹¬æ€æ ·å¯åŠ¨å’Œåœæ­¢é‡‡æ ·ã€æ€æ ·è®¾å®šé‡‡æ ·é¢‘ç‡ï¼Œä»¥åŠæ€æ ·æ§åˆ¶è¾“å‡ºå†…å®¹çš„æ ¼å¼å’Œè¯¦ç»†ç¨‹åº¦ã€‚</p><p>æ­¤å¤–ï¼Œ<code>runtime/pprof</code>åŒ…ä¸­çš„<code>Lookup</code>å‡½æ•°çš„æ­£ç¡®è°ƒç”¨æ–¹å¼ä¹Ÿå¾ˆé‡è¦ã€‚å¯¹äºé™¤äº†CPUæ¦‚è¦ä¿¡æ¯ä¹‹å¤–çš„å…¶ä»–æ¦‚è¦ä¿¡æ¯ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸ªå‡½æ•°è·å–åˆ°ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è¿˜æåŠäº†ä¸€ä¸ªä¸Šå±‚çš„åº”ç”¨ï¼Œå³ï¼šä¸ºåŸºäºHTTPåè®®çš„ç½‘ç»œæœåŠ¡ï¼Œæ·»åŠ æ€§èƒ½åˆ†ææ¥å£ã€‚è¿™ä¹Ÿæ˜¯å¾ˆå®ç”¨çš„ä¸€ä¸ªéƒ¨åˆ†ã€‚</p><p>è™½ç„¶<code>net/http/pprof</code>åŒ…æä¾›çš„ç¨‹åºå®ä½“å¹¶ä¸å¤šï¼Œä½†æ˜¯å®ƒå´èƒ½å¤Ÿè®©æˆ‘ä»¬ç”¨ä¸åŒçš„æ–¹å¼ï¼Œå®ç°æ€§èƒ½åˆ†ææ¥å£çš„åµŒå…¥ã€‚è¿™äº›æ–¹å¼æœ‰çš„æ˜¯æç®€çš„ã€å¼€ç®±å³ç”¨çš„ï¼Œè€Œæœ‰çš„åˆ™ç”¨äºæ»¡è¶³å„ç§å®šåˆ¶éœ€æ±‚ã€‚</p><p>ä»¥ä¸Šè¿™äº›ï¼Œå°±æ˜¯æˆ‘ä»Šå¤©ä¸ºä½ è®²è¿°çš„Goè¯­è¨€çŸ¥è¯†ï¼Œå®ƒä»¬æ˜¯ç¨‹åºæ€§èƒ½åˆ†æçš„åŸºç¡€ã€‚å¦‚æœä½ æŠŠGoè¯­è¨€ç¨‹åºè¿ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œé‚£ä¹ˆè‚¯å®šä¼šæ¶‰åŠå®ƒä»¬ã€‚å¯¹äºè¿™é‡Œæåˆ°çš„æ‰€æœ‰å†…å®¹å’Œé—®é¢˜ï¼Œæˆ‘éƒ½å¸Œæœ›ä½ èƒ½å¤Ÿè®¤çœŸåœ°å»æ€è€ƒå’Œé¢†ä¼šã€‚è¿™æ ·æ‰èƒ½å¤Ÿè®©ä½ åœ¨çœŸæ­£ä½¿ç”¨å®ƒä»¬çš„æ—¶å€™ä¿¡æ‰‹æ‹ˆæ¥ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æˆ‘ä»Šå¤©ç•™ç»™ä½ çš„æ€è€ƒé¢˜å…¶å®åœ¨å‰é¢å·²ç»é€éœ²äº†ï¼Œé‚£å°±æ˜¯ï¼š<code>runtime/trace</code>ä»£ç åŒ…çš„åŠŸç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæˆ‘ä»¬ä¸‹æœŸå†è§ã€‚</p><p><a href=\"https://github.com/hyper0x/Golang_Puzzlers\">æˆ³æ­¤æŸ¥çœ‹Goè¯­è¨€ä¸“æ æ–‡ç« é…å¥—è¯¦ç»†ä»£ç ã€‚</a></p>","comments":[{"had_liked":false,"id":157481,"user_name":"å¼ sir","can_delete":false,"product_type":"c1","uid":1209431,"ip_address":"","ucode":"52958DF6705208","user_header":"https://static001.geekbang.org/account/avatar/00/12/74/57/7b828263.jpg","comment_is_top":false,"comment_ctime":1575173027,"is_pvip":false,"replies":[{"id":"60472","content":"è¿™é‡Œæœ‰ä¸€äº›å‚è€ƒï¼šhttps:&#47;&#47;github.com&#47;hyper0x&#47;go_command_tutorial&#47;blob&#47;master&#47;0.12.md","user_name":"ä½œè€…å›å¤","user_name_real":"éƒæ—","uid":"1026643","ctime":1575258614,"ip_address":"","comment_id":157481,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35934911395","product_id":100013101,"comment_content":"è¯·é—®è€å¸ˆï¼Œæˆ‘å¦‚ä½•é€šè¿‡è¿™äº›åˆ†ææŒ‡æ ‡æ¥å®šä½å…·ä½“å“ªä¸ªä»£ç åŒ…æˆ–è€…å“ªä¸ªæ–¹æ³•æ‰§è¡Œä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚pprof&#47;goroutineé‡‡æ ·ç»“æœï¼Œæˆ‘è¾“å…¥topNæˆ–è€…web,è¾“å‡º0     0%   100%         36 64.29%  github.com&#47;go-redis&#47;redis&#47;internal&#47;pool.(*ConnPool).reaperè¿™äº›å†…å®¹ï¼Œåº”è¯¥æ€ä¹ˆå»åˆ†æå‘¢","like_count":9,"discussions":[{"author":{"id":1026643,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/53/768aec0a.jpg","nickname":"éƒæ—","note":"","ucode":"F66BA62BA56FFA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476441,"discussion_content":"è¿™é‡Œæœ‰ä¸€äº›å‚è€ƒï¼šhttps://github.com/hyper0x/go_command_tutorial/blob/master/0.12.md","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575258614,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119126,"user_name":"å…š","can_delete":false,"product_type":"c1","uid":1071974,"ip_address":"","ucode":"EE531DB3EA124D","user_header":"https://static001.geekbang.org/account/avatar/00/10/5b/66/ad35bc68.jpg","comment_is_top":false,"comment_ctime":1564529404,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27334333180","product_id":100013101,"comment_content":"è‡³å°‘çœ‹å®Œäº†ï¼Œå¯èƒ½å› ä¸ºä¸€ç›´éƒ½ç”¨çš„goä¸­ç®€å•çš„&quot;æŠ€èƒ½&quot;å§ï¼Œå¯¹äºåè¾¹çš„ä¸€äº›æŠ€èƒ½æ„Ÿè§¦ä¸æ˜¯å¤ªæ·±ï¼Œä½†è‡³å°‘å¿ƒé‡Œæœ‰ä¸ªå¤§æ¦‚å°è±¡äº†ï¼Œç­‰åˆ°å·¥ä½œä¸­ç”¨ä¸Šäº†åœ¨æ¥ç¿»çœ‹è¿™äº›å†…å®¹ã€‚è¿™äº›çŸ¥è¯†çš„ç¡®ä¸åŒäºä¸€èˆ¬çš„goæ•™ç¨‹ï¼Œæ‰€æ¶‰åŠåˆ°çš„æ¯ä¸ªæŠ€æœ¯ç‚¹éƒ½å¾ˆæœ‰æ·±åº¦ï¼Œå¯¹æå‡goæŠ€èƒ½å¾ˆæœ‰å¸®åŠ©ï¼Œä½†åˆå­¦è€…ä¸å»ºè®®çœ‹ã€‚","like_count":6},{"had_liked":false,"id":83911,"user_name":"å˜å˜","can_delete":false,"product_type":"c1","uid":1356047,"ip_address":"","ucode":"039447D8E1353A","user_header":"https://static001.geekbang.org/account/avatar/00/14/b1/0f/e81a93ed.jpg","comment_is_top":false,"comment_ctime":1554732241,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14439634129","product_id":100013101,"comment_content":"runtime&#47;traceå¯ä»¥è·Ÿè¸ªä»£ç æ‰§è¡ŒæœŸé—´çš„æ¯ä¸€ä¸ªäº‹ä»¶ï¼Œâ€œThe trace contains events related to goroutine scheduling: a goroutine starts executing on a processor, a goroutine blocks on a synchronization primitive, a goroutine creates or unblocks another goroutine; network-related events: a goroutine blocks on network IO, a goroutine is unblocked on network IO; syscalls-related events: a goroutine enters into syscall, a goroutine returns from syscall; garbage-collector-related events: GC start&#47;stop, concurrent sweep start&#47;stop; and user events. Here and below by &quot;processor&quot; I mean a logical processor, unit of GOMAXPROCS. Each event contains event id, a precise timestamp, OS thread id, processor id, goroutine id, stack trace and other relevant informationâ€ -- https:&#47;&#47;docs.google.com&#47;document&#47;u&#47;1&#47;d&#47;1FP5apqzBgr7ahCCgFO-yoVhk4YZrNIDNf9RybngBc14&#47;pub","like_count":3},{"had_liked":false,"id":238470,"user_name":"nullptr","can_delete":false,"product_type":"c1","uid":1283847,"ip_address":"","ucode":"D309EABB70F0BF","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/07/7406fe30.jpg","comment_is_top":false,"comment_ctime":1596176976,"is_pvip":false,"replies":[{"id":"88104","content":"è¿™å¾—çœ‹å…·ä½“æƒ…å†µï¼Œè¾“å‡ºäº†ä»€ä¹ˆä¹‹ç±»ã€‚çœ‹ä¸åˆ°å †æ ˆæ— ä»åˆ¤æ–­ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"éƒæ—","uid":"1026643","ctime":1596193084,"ip_address":"","comment_id":238470,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10186111568","product_id":100013101,"comment_content":"è€å¸ˆå¥½ï¼Œæˆ‘åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°gcæ—¶panicçš„é—®é¢˜ï¼Œä¸çŸ¥é“è€å¸ˆæœ‰æ²¡æœ‰å¥½çš„å»ºè®®æ¥å®šä½ä¸€ä¸‹","like_count":2,"discussions":[{"author":{"id":1026643,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/53/768aec0a.jpg","nickname":"éƒæ—","note":"","ucode":"F66BA62BA56FFA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502761,"discussion_content":"è¿™å¾—çœ‹å…·ä½“æƒ…å†µï¼Œè¾“å‡ºäº†ä»€ä¹ˆä¹‹ç±»ã€‚çœ‹ä¸åˆ°å †æ ˆæ— ä»åˆ¤æ–­ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596193084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":132225,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1568046420,"is_pvip":false,"replies":[{"id":"50622","content":"Go å±äºç°ä»£é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥éšè—äº†å¾ˆå¤šç¼–è¯‘çš„ä¸œè¥¿ã€‚è¿™æ–¹é¢çš„ä¸œè¥¿ä½ å¯ä»¥å‚çœ‹ Go è¯­è¨€çš„æºç ï¼Œå…·ä½“åœ¨ cmd&#47;compile ç­‰åŒ…ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"éƒæ—","uid":"1026643","ctime":1568095006,"ip_address":"","comment_id":132225,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10157981012","product_id":100013101,"comment_content":"goè¯­è¨€å¯æ‰§è¡Œç¨‹åºåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå†…å­˜å¸ƒå±€å’Œ Cè¯­è¨€çš„ä¸€æ ·å—ï¼Ÿgoç¼–å‡ºæ¥çš„å¯æ‰§è¡Œç¨‹åºä¹Ÿæ˜¯elfæ ¼å¼å—ï¼Ÿç¼–è¯‘goç¨‹åºçš„æ­¥éª¤æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿé¢„å¤„ç†ï¼Œç¼–è¯‘æ±‡ç¼–è¿™äº›éƒ½æœ‰å—ï¼Ÿå¯ä¸å¯ä»¥åªæ‰§è¡Œé¢„å¤„ç†æˆ–è€…åªç¼–è¯‘ä¸é“¾æ¥ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1026643,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/53/768aec0a.jpg","nickname":"éƒæ—","note":"","ucode":"F66BA62BA56FFA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466830,"discussion_content":"Go å±äºç°ä»£é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥éšè—äº†å¾ˆå¤šç¼–è¯‘çš„ä¸œè¥¿ã€‚è¿™æ–¹é¢çš„ä¸œè¥¿ä½ å¯ä»¥å‚çœ‹ Go è¯­è¨€çš„æºç ï¼Œå…·ä½“åœ¨ cmd/compile ç­‰åŒ…ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568095006,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127276,"user_name":"è™¢åœ‹æŠ€é†¬","can_delete":false,"product_type":"c1","uid":1056807,"ip_address":"","ucode":"5A192262AA037E","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/27/a6932fbe.jpg","comment_is_top":false,"comment_ctime":1566630505,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10156565097","product_id":100013101,"comment_content":"äºŒåˆ·ç†è§£æ›´åŠ æ·±åˆ»ğŸ˜Š","like_count":2,"discussions":[{"author":{"id":1602690,"avatar":"https://static001.geekbang.org/account/avatar/00/18/74/82/6f06baf8.jpg","nickname":"David","note":"","ucode":"FEC6A7EB7D4858","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":278944,"discussion_content":"ä½ æ˜¯ä¸æ˜¯åªå¬è¯­éŸ³å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591261894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":62526,"user_name":"kuzan","can_delete":false,"product_type":"c1","uid":1006773,"ip_address":"","ucode":"4A6CCE0629D4AE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/b5/0737c1f2.jpg","comment_is_top":false,"comment_ctime":1548081406,"is_pvip":false,"replies":[{"id":"25241","content":"å¯ä»¥æŸ¥é˜… runtime&#47;debug.SetGCPercent å‡½æ•°çš„æ–‡æ¡£ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"éƒæ—","uid":"1026643","ctime":1551180963,"ip_address":"","comment_id":62526,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5843048702","product_id":100013101,"comment_content":"è€å¸ˆå¥½ï¼Œgolangçš„gcä¼šæ ¹æ®ä»€ä¹ˆå°ºå¯¸åšå›æ”¶å‘¢ï¼Œæ¯”å¦‚javaé‡Œæœ‰xmxï¼Œé‚£goå‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1026643,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/53/768aec0a.jpg","nickname":"éƒæ—","note":"","ucode":"F66BA62BA56FFA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":437247,"discussion_content":"å¯ä»¥æŸ¥é˜… runtime/debug.SetGCPercent å‡½æ•°çš„æ–‡æ¡£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551180963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":342263,"user_name":"Geek_4b9101","can_delete":false,"product_type":"c1","uid":2396096,"ip_address":"","ucode":"71E430505E7D53","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/KZN2M9CPvWZtjfUblowkxaYdHCfhq6mUOFcKkOAzzR9PVJm4IYUsVP47rHbwZNQT6qxavazjJzn14wpiawKPTaA/132","comment_is_top":false,"comment_ctime":1650163267,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650163267","product_id":100013101,"comment_content":"è€å¸ˆï¼Œè¿™ç§ç½‘ä¸Šéƒ½æœ‰ï¼Œæˆ‘ä»¬è¿™é‡Œèƒ½ä¸èƒ½æ¥ç‚¹æ–°çš„ï¼Œæ¯”å¦‚ æ€§èƒ½åˆ†ææ¡ˆä¾‹","like_count":0},{"had_liked":false,"id":238563,"user_name":"nullptr","can_delete":false,"product_type":"c1","uid":1283847,"ip_address":"","ucode":"D309EABB70F0BF","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/07/7406fe30.jpg","comment_is_top":false,"comment_ctime":1596198968,"is_pvip":false,"replies":[{"id":"88150","content":"ä¼°è®¡æ˜¯ä¾èµ–åŒ…ç”¨åˆ°cgoäº†ï¼Œè¿™ç§æƒ…å†µç”¨pprofå’Œtraceéƒ½ä¸ä¸€å®šåˆ¤æ–­çš„å‡ºæ¥ï¼Œä½ åªèƒ½ç»†çœ‹stackï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰çº¿ç´¢ã€‚æœ€å¥½å¥½å¥½å›æƒ³ä¸€ä¸‹å“ªäº›ä¾èµ–åŒ…æœ‰å¯èƒ½ç”¨åˆ°cgoã€‚æˆ–è€…çœ‹çœ‹ä½ çš„ç¯å¢ƒå˜é‡é‡Œæœ‰æ²¡æœ‰è·Ÿcgoæœ‰å…³çš„è®¾å®šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"éƒæ—","uid":"1026643","ctime":1596260947,"ip_address":"","comment_id":238563,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1596198968","product_id":100013101,"comment_content":"æ²¡æ³•å›å¤è€å¸ˆçš„è¯„è®ºï¼Œæˆ‘å†è¯„è®ºä¸€ä¸ªæ–°çš„ã€‚<br>ä»£ç å·¥ç¨‹æ¯”è¾ƒå¤§ï¼Œè€Œä¸”ä¸»è¦ä»£ç æ²¡ç›´æ¥ç”¨åˆ°cgoï¼Œä½†æ˜¯åœ¨gcæ—¶å€™panicäº†ï¼Œä¿¡æ¯ä¹Ÿæç¤ºäº†cgoç›¸å…³ï¼Œä¸çŸ¥é“è€å¸ˆæœ‰æ²¡æœ‰å•¥å·¥å…·å¯ä»¥å®šä½ã€‚","like_count":0,"discussions":[{"author":{"id":1026643,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/53/768aec0a.jpg","nickname":"éƒæ—","note":"","ucode":"F66BA62BA56FFA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502788,"discussion_content":"ä¼°è®¡æ˜¯ä¾èµ–åŒ…ç”¨åˆ°cgoäº†ï¼Œè¿™ç§æƒ…å†µç”¨pprofå’Œtraceéƒ½ä¸ä¸€å®šåˆ¤æ–­çš„å‡ºæ¥ï¼Œä½ åªèƒ½ç»†çœ‹stackï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰çº¿ç´¢ã€‚æœ€å¥½å¥½å¥½å›æƒ³ä¸€ä¸‹å“ªäº›ä¾èµ–åŒ…æœ‰å¯èƒ½ç”¨åˆ°cgoã€‚æˆ–è€…çœ‹çœ‹ä½ çš„ç¯å¢ƒå˜é‡é‡Œæœ‰æ²¡æœ‰è·Ÿcgoæœ‰å…³çš„è®¾å®šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596260947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":238461,"user_name":"nullptr","can_delete":false,"product_type":"c1","uid":1283847,"ip_address":"","ucode":"D309EABB70F0BF","user_header":"https://static001.geekbang.org/account/avatar/00/13/97/07/7406fe30.jpg","comment_is_top":false,"comment_ctime":1596175626,"is_pvip":false,"replies":[{"id":"88105","content":"å…³é”®åœ¨è¿™ä¸€å¥ï¼šfatal error: found bad pointer in Go heap (incorrect use of unsafe or cgo?)","user_name":"ä½œè€…å›å¤","user_name_real":"éƒæ—","uid":"1026643","ctime":1596193123,"ip_address":"","comment_id":238461,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1596175626","product_id":100013101,"comment_content":"è€å¸ˆå¥½ï¼Œæˆ‘åœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°äº†ä¸€ä¸ªgcæ—¶panicï¼Œä¸çŸ¥é“å¦‚ä½•å®šä½ï¼Œè€å¸ˆæœ‰æ²¡æœ‰å•¥å¥½çš„æ€è·¯ã€‚è¿™ä¸ªæ˜¯éƒ¨åˆ†æŠ¥é”™ä¿¡æ¯ï¼š<br><br>runtime: pointer 0xc011207d40 to unused region of span span.base()=0xc0009a2000 span.limit=0xc0009aa000 span.state=1<br>runtime: found in object at *(0xc005cd6420+0x28)<br>object=0xc005cd6420 s.base()=0xc005cd6000 s.limit=0xc005cd7fa0 s.spanclass=24 s.elemsize=176 s.state=mSpanInUse<br> *(object+0) = 0x1010000000068<br> *(object+8) = 0xc011206de0<br> *(object+16) = 0x1a71b0e<br> *(object+24) = 0x0<br> *(object+32) = 0x0<br> *(object+40) = 0xc011207d40 &lt;==<br> *(object+48) = 0x20d8220<br> *(object+56) = 0xc011206ef0<br> *(object+64) = 0x1a71ae2<br> *(object+72) = 0x0<br> *(object+80) = 0x0<br> *(object+88) = 0x0<br> *(object+96) = 0x0<br> *(object+104) = 0x0<br> *(object+112) = 0x0<br> *(object+120) = 0x0<br> *(object+128) = 0x0<br> *(object+136) = 0x0<br> *(object+144) = 0x0<br> *(object+152) = 0x0<br> *(object+160) = 0x0<br> *(object+168) = 0x0<br>fatal error: found bad pointer in Go heap (incorrect use of unsafe or cgo?)<br><br>runtime stack:<br>runtime.throw(0x2037360, 0x3e)<br>        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;panic.go:1112 +0x72 fp=0x7f427953ba28 sp=0x7f427953b9f8 pc=0x4460f2<br>runtime.badPointer(0x7f426b52ade0, 0xc011207d40, 0xc005cd6420, 0x28)<br>        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mbitmap.go:380 +0x230 fp=0x7f427953ba70 sp=0x7f427953ba28 pc=0x426530<br>runtime.findObject(0xc011207d40, 0xc005cd6420, 0x28, 0x7f42a9710a78, 0xc000050e98, 0x2)<br>        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mbitmap.go:416 +0x9b fp=0x7f427953baa8 sp=0x7f427953ba70 pc=0x4265db<br>runtime.scanobject(0xc005cd6420, 0xc000050e98)<br>        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:1274 +0x235 fp=0x7f427953bb38 sp=0x7f427953baa8 pc=0x431675<br>runtime.gcDrainN(0xc000050e98, 0x10000, 0xc002ee1800)<br>        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:1126 +0x12d fp=0x7f427953bb68 sp=0x7f427953bb38 pc=0x4311bd<br>runtime.gcAssistAlloc1(0xc002ee1800, 0x10000)<br>        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:531 +0xf3 fp=0x7f427953bbb8 sp=0x7f427953bb68 pc=0x42fc43<br>runtime.gcAssistAlloc.func1()<br>        &#47;usr&#47;local&#47;go&#47;src&#47;runtime&#47;mgcmark.go:442 +0x33 fp=0x7f427953bbd8 sp=0x7f","like_count":0,"discussions":[{"author":{"id":1026643,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/aa/53/768aec0a.jpg","nickname":"éƒæ—","note":"","ucode":"F66BA62BA56FFA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502755,"discussion_content":"å…³é”®åœ¨è¿™ä¸€å¥ï¼šfatal error: found bad pointer in Go heap (incorrect use of unsafe or cgo?)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596193123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140373,"user_name":"ä¸Šå±±çš„oç‰›","can_delete":false,"product_type":"c1","uid":1080549,"ip_address":"","ucode":"5C5D1AC8563301","user_header":"https://static001.geekbang.org/account/avatar/00/10/7c/e5/3dca2495.jpg","comment_is_top":false,"comment_ctime":1570895015,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1570895015","product_id":100013101,"comment_content":"å·¥ä½œä¸­ä¼šç”¨åˆ°çš„ï¼Œå†é‡å§","like_count":0}]}