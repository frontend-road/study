{"id":455413,"title":"38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasync/awaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>é€šè¿‡å‰å‡ è®²çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹å¹¶å‘å¤„ç†ï¼Œå°¤å…¶æ˜¯å¸¸ç”¨çš„å¹¶å‘åŸè¯­ï¼Œæœ‰äº†ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†ã€‚å¹¶å‘åŸè¯­æ˜¯å¹¶å‘ä»»åŠ¡ä¹‹é—´åŒæ­¥çš„æ‰‹æ®µï¼Œä»Šå¤©æˆ‘ä»¬è¦å­¦ä¹ çš„ Future ä»¥åŠåœ¨æ›´é«˜å±‚æ¬¡ä¸Šå¤„ç† Future çš„ async/awaitï¼Œæ˜¯<strong>äº§ç”Ÿå’Œè¿è¡Œå¹¶å‘ä»»åŠ¡</strong>çš„æ‰‹æ®µã€‚</p><p>ä¸è¿‡äº§ç”Ÿå’Œè¿è¡Œå¹¶å‘ä»»åŠ¡çš„æ‰‹æ®µæœ‰å¾ˆå¤šï¼Œasync/await åªæ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¹¶å‘ä»»åŠ¡å¯ä»¥è¿è¡Œåœ¨ç³»ç»Ÿçš„æŸä¸ªèŠ‚ç‚¹ä¸Šï¼›åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶å‘ä»»åŠ¡åˆå¯ä»¥è¿è¡Œåœ¨å¤šä¸ªè¿›ç¨‹ä¸­ï¼›è€Œåœ¨æŸä¸ªè¿›ç¨‹ä¸­ï¼Œå¹¶å‘ä»»åŠ¡å¯ä»¥è¿è¡Œåœ¨å¤šä¸ªçº¿ç¨‹ä¸­ï¼›åœ¨æŸä¸ªï¼ˆäº›ï¼‰çº¿ç¨‹ä¸Šï¼Œå¹¶å‘ä»»åŠ¡å¯ä»¥è¿è¡Œåœ¨å¤šä¸ª Promise / Future / Goroutine / Erlang process è¿™æ ·çš„åç¨‹ä¸Šã€‚</p><p>å®ƒä»¬çš„ç²’åº¦ä»å¤§åˆ°å°å¦‚å›¾æ‰€ç¤ºï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/75/66/7575380e2255ae078569bb7e185da666.jpg?wh=2139x979\" alt=\"\"></p><p>åœ¨ä¹‹å‰çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬å¤§é‡åº”ç”¨äº†çº¿ç¨‹è¿™ç§å¹¶å‘å·¥å…·ï¼Œåœ¨ kv server çš„æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¹Ÿé€šè¿‡ async/await ç”¨åˆ°äº† Future è¿™æ ·çš„æ— æ ˆåç¨‹ã€‚</p><p>å…¶å® Rust çš„ Future è·Ÿ JavaScript çš„ Promise éå¸¸ç±»ä¼¼ã€‚</p><p>å¦‚æœä½ ç†Ÿæ‚‰ JavaScriptï¼Œåº”è¯¥ç†Ÿæ‚‰ Promise çš„æ¦‚å¿µï¼Œ<a href=\"https://time.geekbang.org/column/article/410038\">02</a>ä¹Ÿç®€å•è®²è¿‡ï¼Œå®ƒä»£è¡¨äº†<strong>åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»æ‰èƒ½å¾—åˆ°çš„ç»“æœçš„å€¼</strong>ï¼ŒPromise ä¸€èˆ¬å­˜åœ¨ä¸‰ä¸ªçŠ¶æ€ï¼›</p><ol>\n<li>åˆå§‹çŠ¶æ€ï¼ŒPromise è¿˜æœªè¿è¡Œï¼›</li>\n<li>ç­‰å¾…ï¼ˆpendingï¼‰çŠ¶æ€ï¼ŒPromise å·²è¿è¡Œï¼Œä½†è¿˜æœªç»“æŸï¼›</li>\n<li>ç»“æŸçŠ¶æ€ï¼ŒPromise æˆåŠŸè§£æå‡ºä¸€ä¸ªå€¼ï¼Œæˆ–è€…æ‰§è¡Œå¤±è´¥ã€‚</li>\n</ol><!-- [[[read_end]]] --><p>åªä¸è¿‡ JavaScript çš„ Promise å’Œçº¿ç¨‹ç±»ä¼¼ï¼Œä¸€æ—¦åˆ›å»ºå°±å¼€å§‹æ‰§è¡Œï¼Œå¯¹ Promise await åªæ˜¯ä¸ºäº†â€œç­‰å¾…â€å¹¶è·å–è§£æå‡ºæ¥çš„å€¼ï¼›è€Œ Rust çš„ Futureï¼Œåªæœ‰åœ¨ä¸»åŠ¨ await åæ‰å¼€å§‹æ‰§è¡Œã€‚</p><p>è®²åˆ°è¿™é‡Œä¼°è®¡ä½ ä¹Ÿçœ‹å‡ºæ¥äº†ï¼Œè°ˆ Future çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ€»ä¼šè°ˆåˆ° async/awaitã€‚ä¸€èˆ¬è€Œè¨€ï¼Œ<strong>async å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œ await åˆ™è§¦å‘è¿™ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œ</strong>ã€‚å¤§å¤šæ•°è¯­è¨€ï¼ŒåŒ…æ‹¬ Rustï¼Œasync/await éƒ½æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼ˆsyntactic sugarï¼‰ï¼Œå®ƒä»¬ä½¿ç”¨çŠ¶æ€æœºå°† Promise/Future è¿™æ ·çš„ç»“æ„åŒ…è£…èµ·æ¥è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬å…ˆæŠŠå†…éƒ¨çš„å®ç°æ”¾åœ¨ä¸€è¾¹ï¼Œä¸»è¦èŠ Future/async/await çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ï¼Œä¸‹ä¸€è®²å†æ¥è¯¦ç»†ä»‹ç»å®ƒä»¬çš„åŸç†ã€‚</p><h2>ä¸ºä»€ä¹ˆéœ€è¦ Futureï¼Ÿ</h2><p>é¦–å…ˆï¼Œè°ˆä¸€è°ˆä¸ºä»€ä¹ˆéœ€è¦ Future è¿™æ ·çš„å¹¶å‘ç»“æ„ã€‚</p><p>åœ¨ Future å‡ºç°ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ Rust ä»£ç éƒ½æ˜¯åŒæ­¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼ŒCPU å¤„ç†å®Œå‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªæŒ‡ä»¤æ‰ä¼šè¿”å›ã€‚å¦‚æœè¿™ä¸ªå‡½æ•°é‡Œæœ‰ IO çš„æ“ä½œï¼Œå®é™…ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠå‡½æ•°å¯¹åº”çš„çº¿ç¨‹æŒ‚èµ·ï¼Œæ”¾åœ¨ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ° IO æ“ä½œå®Œæˆï¼Œæ‰æ¢å¤è¿™ä¸ªçº¿ç¨‹ï¼Œå¹¶ä»æŒ‚èµ·çš„ä½ç½®ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p><p>è¿™ä¸ªæ¨¡å‹éå¸¸ç®€å•ç›´è§‚ï¼Œä»£ç æ˜¯ä¸€è¡Œä¸€è¡Œæ‰§è¡Œçš„ï¼Œå¼€å‘è€…å¹¶ä¸éœ€è¦è€ƒè™‘å“ªäº›æ“ä½œä¼šé˜»å¡ï¼Œå“ªäº›ä¸ä¼šï¼Œåªå…³å¿ƒä»–çš„ä¸šåŠ¡é€»è¾‘å°±å¥½ã€‚</p><p>ç„¶è€Œï¼Œéšç€ CPU æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œæ–°ä¸–çºªåº”ç”¨è½¯ä»¶çš„ä¸»è¦çŸ›ç›¾ä¸å†æ˜¯ CPU ç®—åŠ›ä¸è¶³ï¼Œè€Œæ˜¯<strong>è¿‡äºå……æ²›çš„ CPU ç®—åŠ›å’Œæå‡ç¼“æ…¢çš„ IO é€Ÿåº¦ä¹‹é—´çš„çŸ›ç›¾</strong>ã€‚å¦‚æœæœ‰å¤§é‡çš„ IO æ“ä½œï¼Œä½ çš„ç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´å¹¶æ²¡æœ‰åœ¨è¿ç®—ï¼Œè€Œæ˜¯åœ¨ä¸æ–­åœ°ç­‰å¾… IOã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=7448400dca4444c1309dc1af2df91b7c\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse serde_yaml::Value;\nuse std::fs;\n\nfn main() -&gt; Result&lt;()&gt; {\n    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1\n    let content1 = fs::read_to_string(\"./Cargo.toml\")?;\n    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2\n    let content2 = fs::read_to_string(\"./Cargo.lock\")?;\n\n    // è®¡ç®—\n    let yaml1 = toml2yaml(&amp;content1)?;\n    let yaml2 = toml2yaml(&amp;content2)?;\n\n    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3\n    fs::write(\"/tmp/Cargo.yml\", &amp;yaml1)?;\n    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4\n    fs::write(\"/tmp/Cargo.lock\", &amp;yaml2)?;\n\n    // æ‰“å°\n    println!(\"{}\", yaml1);\n    println!(\"{}\", yaml2);\n\n    Ok(())\n}\n\nfn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {\n    let value: Value = toml::from_str(&amp;content)?;\n    Ok(serde_yaml::to_string(&amp;value)?)\n}\n</code></pre><p>è¿™æ®µä»£ç è¯»å– Cargo.toml å’Œ Cargo.lock å°†å…¶è½¬æ¢æˆ yamlï¼Œå†åˆ†åˆ«å†™å…¥åˆ° /tmp ä¸‹ã€‚</p><p>è™½ç„¶è¯´è¿™æ®µä»£ç çš„é€»è¾‘å¹¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ€§èƒ½æœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚åœ¨è¯» Cargo.toml æ—¶ï¼Œæ•´ä¸ªä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ° Cargo.toml è¯»å®Œï¼Œæ‰èƒ½ç»§ç»­è¯»ä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„æ–‡ä»¶ã€‚æ•´ä¸ªä¸»çº¿ç¨‹ï¼Œåªæœ‰åœ¨è¿è¡Œ toml2yaml çš„æ—¶é—´ç‰‡å†…ï¼Œæ‰çœŸæ­£åœ¨æ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼Œä¹‹å‰çš„è¯»å–æ–‡ä»¶ä»¥åŠä¹‹åçš„å†™å…¥æ–‡ä»¶ï¼ŒCPU éƒ½åœ¨é—²ç½®ã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/c1/3e/c11148d0647e5f3217a77e06d233923e.jpg?wh=2217x1560\" alt=\"\"></p><p>å½“ç„¶ï¼Œä½ ä¼šè¾©è§£ï¼Œåœ¨è¯»æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ç­‰å¾…ï¼Œå› ä¸º toml2yaml å‡½æ•°çš„æ‰§è¡Œæœ‰èµ–äºè¯»å–æ–‡ä»¶çš„ç»“æœã€‚å—¯æ²¡é”™ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œè¿˜æœ‰å¾ˆå¤§çš„ CPU æµªè´¹ï¼šæˆ‘ä»¬è¯»å®Œç¬¬ä¸€ä¸ªæ–‡ä»¶æ‰å¼€å§‹è¯»ç¬¬äºŒä¸ªæ–‡ä»¶ï¼Œæœ‰æ²¡æœ‰å¯èƒ½ä¸¤ä¸ªæ–‡ä»¶åŒæ—¶è¯»å–å‘¢ï¼Ÿè¿™æ ·æ€»å…±ç­‰å¾…çš„æ—¶é—´æ˜¯ max(time_for_file1, time_for_file2)ï¼Œè€Œé time_for_file1 + time_for_file2 ã€‚</p><p>è¿™å¹¶ä¸éš¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ–‡ä»¶è¯»å–å’Œå†™å…¥çš„æ“ä½œæ”¾å…¥å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ¯”å¦‚ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=89c5a55179f966a364268c584db8a477\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::{anyhow, Result};\nuse serde_yaml::Value;\nuse std::{\n    fs,\n    thread::{self, JoinHandle},\n};\n\n/// åŒ…è£…ä¸€ä¸‹ JoinHandleï¼Œè¿™æ ·å¯ä»¥æä¾›é¢å¤–çš„æ–¹æ³•\nstruct MyJoinHandle&lt;T&gt;(JoinHandle&lt;Result&lt;T&gt;&gt;);\n\nimpl&lt;T&gt; MyJoinHandle&lt;T&gt; {\n    /// ç­‰å¾… thread æ‰§è¡Œå®Œï¼ˆç±»ä¼¼ awaitï¼‰\n    pub fn thread_await(self) -&gt; Result&lt;T&gt; {\n        self.0.join().map_err(|_| anyhow!(\"failed\"))?\n    }\n}\n\nfn main() -&gt; Result&lt;()&gt; {\n    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1\n    let t1 = thread_read(\"./Cargo.toml\");\n    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2\n    let t2 = thread_read(\"./Cargo.lock\");\n\n    let content1 = t1.thread_await()?;\n    let content2 = t2.thread_await()?;\n\n    // è®¡ç®—\n    let yaml1 = toml2yaml(&amp;content1)?;\n    let yaml2 = toml2yaml(&amp;content2)?;\n\n    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3\n    let t3 = thread_write(\"/tmp/Cargo.yml\", yaml1);\n    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4\n    let t4 = thread_write(\"/tmp/Cargo.lock\", yaml2);\n\n    let yaml1 = t3.thread_await()?;\n    let yaml2 = t4.thread_await()?;\n\n    fs::write(\"/tmp/Cargo.yml\", &amp;yaml1)?;\n    fs::write(\"/tmp/Cargo.lock\", &amp;yaml2)?;\n\n    // æ‰“å°\n    println!(\"{}\", yaml1);\n    println!(\"{}\", yaml2);\n\n    Ok(())\n}\n\nfn thread_read(filename: &amp;'static str) -&gt; MyJoinHandle&lt;String&gt; {\n    let handle = thread::spawn(move || {\n        let s = fs::read_to_string(filename)?;\n        Ok::&lt;_, anyhow::Error&gt;(s)\n    });\n    MyJoinHandle(handle)\n}\n\nfn thread_write(filename: &amp;'static str, content: String) -&gt; MyJoinHandle&lt;String&gt; {\n    let handle = thread::spawn(move || {\n        fs::write(filename, &amp;content)?;\n        Ok::&lt;_, anyhow::Error&gt;(content)\n    });\n    MyJoinHandle(handle)\n}\n\nfn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {\n    let value: Value = toml::from_str(&amp;content)?;\n    Ok(serde_yaml::to_string(&amp;value)?)\n}\n</code></pre><p>è¿™æ ·ï¼Œè¯»å–æˆ–è€…å†™å…¥å¤šä¸ªæ–‡ä»¶çš„è¿‡ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä½¿ç­‰å¾…çš„æ—¶é—´å¤§å¤§ç¼©çŸ­ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœè¦åŒæ—¶è¯»å– 100 ä¸ªæ–‡ä»¶å‘¢ï¼Ÿæ˜¾ç„¶ï¼Œåˆ›å»º 100 ä¸ªçº¿ç¨‹æ¥åšè¿™æ ·çš„äº‹æƒ…ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œåˆ›å»º/é˜»å¡/å”¤é†’/é”€æ¯çº¿ç¨‹ï¼Œéƒ½æ¶‰åŠä¸å°‘çš„åŠ¨ä½œï¼Œæ¯ä¸ªçº¿ç¨‹ä¹Ÿéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªä¸å°çš„è°ƒç”¨æ ˆï¼Œæ‰€ä»¥ä» CPU å’Œå†…å­˜çš„è§’åº¦æ¥çœ‹ï¼Œ<strong>åˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ä¼šå¤§å¤§å¢åŠ ç³»ç»Ÿçš„å¼€é”€</strong>ã€‚</p><p>å…¶å®ï¼Œç»å¤§å¤šæ•°æ“ä½œç³»ç»Ÿå¯¹ I/O æ“ä½œæä¾›äº†éé˜»å¡æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥å‘èµ·ä¸€ä¸ªè¯»å–çš„æŒ‡ä»¤ï¼Œè‡ªå·±å¤„ç†ç±»ä¼¼ <code>EWOULDBLOCK</code>è¿™æ ·çš„é”™è¯¯ç ï¼Œæ¥æ›´å¥½åœ°åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†å¤šä¸ªæ–‡ä»¶çš„ IOï¼Œè€Œä¸æ˜¯ä¾èµ–æ“ä½œç³»ç»Ÿé€šè¿‡è°ƒåº¦å¸®ä½ å®Œæˆè¿™ä»¶äº‹ã€‚</p><p>ä¸è¿‡è¿™æ ·å°±æ„å‘³ç€ï¼Œä½ éœ€è¦å®šä¹‰åˆé€‚çš„æ•°æ®ç»“æ„æ¥è¿½è¸ªæ¯ä¸ªæ–‡ä»¶çš„è¯»å–ï¼Œåœ¨ç”¨æˆ·æ€è¿›è¡Œç›¸åº”çš„è°ƒåº¦ï¼Œé˜»å¡ç­‰å¾… IO çš„æ•°æ®ç»“æ„çš„è¿è¡Œï¼Œè®©æ²¡æœ‰ç­‰å¾… IO çš„æ•°æ®ç»“æ„å¾—åˆ°æœºä¼šä½¿ç”¨ CPUï¼Œä»¥åŠå½“ IO æ“ä½œç»“æŸåï¼Œæ¢å¤ç­‰å¾… IO çš„æ•°æ®ç»“æ„çš„è¿è¡Œç­‰ç­‰ã€‚è¿™æ ·çš„æ“ä½œç²’åº¦æ›´å°ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦åˆ©ç”¨ CPU èµ„æºã€‚è¿™å°±æ˜¯ç±»ä¼¼ Future è¿™æ ·çš„å¹¶å‘ç»“æ„çš„ä¸»è¦ç”¨é€”ã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœè¿™ä¹ˆå¤„ç†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·æ€åšå¾ˆå¤šäº‹æƒ…ï¼ŒåŒ…æ‹¬å¤„ç† IO ä»»åŠ¡çš„äº‹ä»¶é€šçŸ¥ã€åˆ›å»º Futureã€åˆç†åœ°è°ƒåº¦ Futureã€‚è¿™äº›äº‹æƒ…ï¼Œç»Ÿç»Ÿäº¤ç»™å¼€å‘è€…åšæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚æ‰€ä»¥ï¼ŒRust æä¾›äº†ç›¸åº”å¤„ç†æ‰‹æ®µ async/await ï¼š<strong>async æ¥æ–¹ä¾¿åœ°ç”Ÿæˆ Futureï¼Œawait æ¥è§¦å‘ Future çš„è°ƒåº¦å’Œæ‰§è¡Œ</strong>ã€‚</p><p>æˆ‘ä»¬çœ‹çœ‹ï¼ŒåŒæ ·çš„ä»»åŠ¡ï¼Œå¦‚ä½•ç”¨ async/await æ›´é«˜æ•ˆåœ°å¤„ç†ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=a13d1fdbf7b4d3e0afa18082b6d077b3\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse serde_yaml::Value;\nuse tokio::{fs, try_join};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1\n    let f1 = fs::read_to_string(\"./Cargo.toml\");\n    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2\n    let f2 = fs::read_to_string(\"./Cargo.lock\");\n    let (content1, content2) = try_join!(f1, f2)?;\n\n    // è®¡ç®—\n    let yaml1 = toml2yaml(&amp;content1)?;\n    let yaml2 = toml2yaml(&amp;content2)?;\n\n    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3\n    let f3 = fs::write(\"/tmp/Cargo.yml\", &amp;yaml1);\n    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4\n    let f4 = fs::write(\"/tmp/Cargo.lock\", &amp;yaml2);\n    try_join!(f3, f4)?;\n\n    // æ‰“å°\n    println!(\"{}\", yaml1);\n    println!(\"{}\", yaml2);\n\n    Ok(())\n}\n\nfn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {\n    let value: Value = toml::from_str(&amp;content)?;\n    Ok(serde_yaml::to_string(&amp;value)?)\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº† tokio::fsï¼Œè€Œä¸æ˜¯ std::fsï¼Œtokio::fs çš„æ–‡ä»¶æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ª Futureï¼Œç„¶åå¯ä»¥ join è¿™äº› Futureï¼Œå¾—åˆ°å®ƒä»¬è¿è¡Œåçš„ç»“æœã€‚join / try_join æ˜¯ç”¨æ¥è½®è¯¢å¤šä¸ª Future çš„å®ï¼Œå®ƒä¼šä¾æ¬¡å¤„ç†æ¯ä¸ª Futureï¼Œé‡åˆ°é˜»å¡å°±å¤„ç†ä¸‹ä¸€ä¸ªï¼Œç›´åˆ°æ‰€æœ‰ Future äº§ç”Ÿç»“æœã€‚</p><p>æ•´ä¸ªç­‰å¾…æ–‡ä»¶è¯»å–çš„æ—¶é—´æ˜¯ max(time_for_file1, time_for_file2)ï¼Œæ€§èƒ½å’Œä½¿ç”¨çº¿ç¨‹çš„ç‰ˆæœ¬å‡ ä¹ä¸€è‡´ï¼Œä½†æ˜¯æ¶ˆè€—çš„èµ„æºï¼ˆä¸»è¦æ˜¯çº¿ç¨‹ï¼‰è¦å°‘å¾ˆå¤šã€‚</p><p>å»ºè®®ä½ å¥½å¥½å¯¹æ¯”è¿™ä¸‰ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œå†™ä¸€å†™ï¼Œè¿è¡Œä¸€ä¸‹ï¼Œæ„Ÿå—å®ƒä»¬çš„å¤„ç†é€»è¾‘ã€‚æ³¨æ„åœ¨æœ€åçš„ async/await çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠä»£ç å†™æˆè¿™æ ·ï¼š</p><pre><code class=\"language-rust\">// è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1\nlet content1 = fs::read_to_string(\"./Cargo.toml\").await?;\n// è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2\nlet content1 = fs::read_to_string(\"./Cargo.lock\").await?;\n</code></pre><p>è¿™æ ·å†™çš„è¯ï¼Œå’Œç¬¬ä¸€ç‰ˆåŒæ­¥çš„ç‰ˆæœ¬æ²¡æœ‰åŒºåˆ«ï¼Œå› ä¸º await ä¼šè¿è¡Œ Future ç›´åˆ° Future æ‰§è¡Œç»“æŸï¼Œæ‰€ä»¥ä¾æ—§æ˜¯å…ˆè¯»å– Cargo.tomlï¼Œå†è¯»å– Cargo.lockï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°å¹¶å‘çš„æ•ˆæœã€‚</p><h2>æ·±å…¥äº†è§£</h2><p>å¥½ï¼Œäº†è§£äº† Future åœ¨è½¯ä»¶å¼€å‘ä¸­çš„å¿…è¦æ€§ï¼Œæ¥æ·±å…¥ç ”ç©¶ä¸€ä¸‹ Future/async/awaitã€‚</p><p>åœ¨å‰é¢ä»£ç æ’°å†™è¿‡ç¨‹ä¸­ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œå¼‚æ­¥å‡½æ•°ï¼ˆasync fnï¼‰çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„ impl Future&lt;Output&gt; çš„ç»“æ„ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/15/6e/159d35852d585f9b00b4d78ac9b7a26e.png?wh=1920x354\" alt=\"\"></p><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€èˆ¬ä¼šç”¨ impl  å…³é”®å­—ä¸ºæ•°æ®ç»“æ„å®ç° traitï¼Œä¹Ÿå°±æ˜¯è¯´æ¥åœ¨ impl å…³é”®å­—åé¢çš„ä¸œè¥¿æ˜¯ä¸€ä¸ª traitï¼Œæ‰€ä»¥ï¼Œæ˜¾ç„¶ Future æ˜¯ä¸€ä¸ª traitï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputã€‚</p><p>æ¥çœ‹ <a href=\"https://doc.rust-lang.org/std/future/trait.Future.html\">Future</a> çš„å®šä¹‰ï¼š</p><pre><code class=\"language-rust\">pub trait Future {\n    type Output;\n    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;\n}\n\npub enum Poll&lt;T&gt; {\n    Ready(T),\n    Pending,\n}\n</code></pre><p>é™¤äº† Output å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª poll() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› Poll<a href=\"Self::Output\">Self::Output</a>ã€‚è€Œ Poll&lt;T&gt; æ˜¯ä¸ª enumï¼ŒåŒ…å« Ready å’Œ Pending ä¸¤ä¸ªçŠ¶æ€ã€‚æ˜¾ç„¶ï¼Œå½“ Future è¿”å› Pending çŠ¶æ€æ—¶ï¼Œæ´»è¿˜æ²¡å¹²å®Œï¼Œä½†å¹²ä¸ä¸‹å»äº†ï¼Œéœ€è¦é˜»å¡ä¸€é˜µå­ï¼Œç­‰æŸä¸ªäº‹ä»¶å°†å…¶å”¤é†’ï¼›å½“ Future è¿”å› Ready çŠ¶æ€æ—¶ï¼ŒFuture å¯¹åº”çš„å€¼å·²ç»å¾—åˆ°ï¼Œæ­¤æ—¶å¯ä»¥è¿”å›äº†ã€‚</p><p>ä½ çœ‹ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„æ•°æ®ç»“æ„ï¼Œå°±æ‰˜èµ·äº†åºå¤§çš„ Rust å¼‚æ­¥ async/await å¤„ç†çš„ç”Ÿæ€ã€‚</p><p>å›åˆ° async fn çš„è¿”å›å€¼æˆ‘ä»¬æ¥ç€è¯´ï¼Œæ˜¾ç„¶å®ƒæ˜¯ä¸€ä¸ª impl Futureï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç»™ä¸€ä¸ªæ™®é€šçš„å‡½æ•°è¿”å› impl Future&lt;Output&gt;ï¼Œå®ƒçš„è¡Œä¸ºå’Œ async fn æ˜¯ä¸æ˜¯ä¸€è‡´å‘¢ï¼Ÿæ¥å†™ä¸ªç®€å•çš„å®éªŒï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=29cab825b46862f4e3b285cd4cb642f0\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use futures::executor::block_on;\nuse std::future::Future;\n\n#[tokio::main]\nasync fn main() {\n    let name1 = \"Tyr\".to_string();\n    let name2 = \"Lindsey\".to_string();\n\n    say_hello1(&amp;name1).await;\n    say_hello2(&amp;name2).await;\n\n    // Future é™¤äº†å¯ä»¥ç”¨ await æ¥æ‰§è¡Œå¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥ç”¨ executor æ‰§è¡Œ\n    block_on(say_hello1(&amp;name1));\n    block_on(say_hello2(&amp;name2));\n}\n\nasync fn say_hello1(name: &amp;str) -&gt; usize {\n    println!(\"Hello {}\", name);\n    42\n}\n\n// async fn å…³é”®å­—ç›¸å½“äºä¸€ä¸ªè¿”å› impl Future&lt;Output&gt; çš„è¯­æ³•ç³–\nfn say_hello2&lt;'fut&gt;(name: &amp;'fut str) -&gt; impl Future&lt;Output = usize&gt; + 'fut {\n    async move {\n        println!(\"Hello {}\", name);\n        42\n    }\n}\n</code></pre><p>è¿è¡Œè¿™æ®µä»£ç ä½ ä¼šå‘ç°ï¼Œsay_hello1 å’Œ say_hello2 æ˜¯ç­‰ä»·çš„ï¼ŒäºŒè€…éƒ½å¯ä»¥ä½¿ç”¨ await æ¥æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å°†å…¶æä¾›ç»™ä¸€ä¸ª executor æ¥æ‰§è¡Œã€‚</p><p>è¿™é‡Œæˆ‘ä»¬è§åˆ°äº†ä¸€ä¸ªæ–°çš„åè¯ï¼šexecutorã€‚</p><h3>ä»€ä¹ˆæ˜¯ executorï¼Ÿ</h3><p>ä½ å¯ä»¥æŠŠ executor å¤§è‡´æƒ³è±¡æˆä¸€ä¸ª Future çš„è°ƒåº¦å™¨ã€‚å¯¹äºçº¿ç¨‹æ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£è°ƒåº¦ï¼›ä½†æ“ä½œç³»ç»Ÿä¸ä¼šå»è°ƒåº¦ç”¨æˆ·æ€çš„åç¨‹ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œæ‰€ä»¥ä»»ä½•ä½¿ç”¨äº†åç¨‹æ¥å¤„ç†å¹¶å‘çš„ç¨‹åºï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ª executor æ¥è´Ÿè´£åç¨‹çš„è°ƒåº¦ã€‚</p><p>å¾ˆå¤šåœ¨è¯­è¨€å±‚é¢æ”¯æŒåç¨‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ¯”å¦‚ Golang / Erlangï¼Œéƒ½è‡ªå¸¦ä¸€ä¸ªç”¨æˆ·æ€çš„è°ƒåº¦å™¨ã€‚Rust è™½ç„¶ä¹Ÿæä¾› Future è¿™æ ·çš„åç¨‹ï¼Œä½†å®ƒ<strong>åœ¨è¯­è¨€å±‚é¢å¹¶ä¸æä¾› executor</strong>ï¼ŒæŠŠè¦ä¸è¦ä½¿ç”¨ executor å’Œä½¿ç”¨ä»€ä¹ˆæ ·çš„ executor çš„è‡ªä¸»æƒäº¤ç»™äº†å¼€å‘è€…ã€‚å¥½å¤„æ˜¯ï¼Œå½“æˆ‘çš„ä»£ç ä¸­ä¸éœ€è¦ä½¿ç”¨åç¨‹æ—¶ï¼Œä¸éœ€è¦å¼•å…¥ä»»ä½•è¿è¡Œæ—¶ï¼›è€Œéœ€è¦ä½¿ç”¨åç¨‹æ—¶ï¼Œå¯ä»¥åœ¨ç”Ÿæ€ç³»ç»Ÿä¸­é€‰æ‹©æœ€åˆé€‚æˆ‘åº”ç”¨çš„ executorã€‚</p><p>å¸¸è§çš„ executor æœ‰ï¼š</p><ul>\n<li>futures åº“è‡ªå¸¦çš„å¾ˆç®€å•çš„ executorï¼Œä¸Šé¢çš„ä»£ç å°±ä½¿ç”¨äº†å®ƒçš„ block_on å‡½æ•°ï¼›</li>\n<li>tokio æä¾›çš„ executorï¼Œå½“ä½¿ç”¨ #[tokio::main] æ—¶ï¼Œå°±éšå«å¼•å…¥äº† tokio çš„ executorï¼›</li>\n<li><a href=\"https://github.com/async-rs/async-std\">async-std</a> æä¾›çš„ executorï¼Œå’Œ tokio ç±»ä¼¼ï¼›</li>\n<li><a href=\"https://github.com/smol-rs/smol\">smol</a> æä¾›çš„ async-executorï¼Œä¸»è¦æä¾›äº† block_onã€‚</li>\n</ul><p>æ³¨æ„ï¼Œä¸Šé¢çš„ä»£ç æˆ‘ä»¬æ··ç”¨äº† #[tokio::main] å’Œ futures:executor::block_onï¼Œè¿™åªæ˜¯ä¸ºäº†å±•ç¤º Future ä½¿ç”¨çš„ä¸åŒæ–¹å¼ï¼Œ<strong>åœ¨æ­£å¼ä»£ç é‡Œï¼Œä¸å»ºè®®æ··ç”¨ä¸åŒçš„ executor</strong>ï¼Œä¼šé™ä½ç¨‹åºçš„æ€§èƒ½ï¼Œè¿˜å¯èƒ½å¼•å‘å¥‡æ€ªçš„é—®é¢˜ã€‚</p><p>å½“æˆ‘ä»¬è°ˆåˆ° executor æ—¶ï¼Œå°±ä¸å¾—ä¸æ reactorï¼Œå®ƒä¿©éƒ½æ˜¯ <a href=\"https://en.wikipedia.org/wiki/Reactor_pattern\">Reactor Pattern</a> çš„ç»„æˆéƒ¨åˆ†ï¼Œä½œä¸ºæ„å»ºé«˜æ€§èƒ½äº‹ä»¶é©±åŠ¨ç³»ç»Ÿçš„ä¸€ä¸ªå¾ˆå…¸å‹æ¨¡å¼ï¼ŒReactor pattern å®ƒåŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p><ul>\n<li>taskï¼Œå¾…å¤„ç†çš„ä»»åŠ¡ã€‚ä»»åŠ¡å¯ä»¥è¢«æ‰“æ–­ï¼Œå¹¶ä¸”æŠŠæ§åˆ¶æƒäº¤ç»™ executorï¼Œç­‰å¾…ä¹‹åçš„è°ƒåº¦ï¼›</li>\n<li>executorï¼Œä¸€ä¸ªè°ƒåº¦å™¨ã€‚ç»´æŠ¤ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡ï¼ˆready queueï¼‰ï¼Œä»¥åŠè¢«é˜»å¡çš„ä»»åŠ¡ï¼ˆwait queueï¼‰ï¼›</li>\n<li>reactorï¼Œç»´æŠ¤äº‹ä»¶é˜Ÿåˆ—ã€‚å½“äº‹ä»¶æ¥ä¸´æ—¶ï¼Œé€šçŸ¥ executor å”¤é†’æŸä¸ªä»»åŠ¡ç­‰å¾…è¿è¡Œã€‚</li>\n</ul><p>executor ä¼šè°ƒåº¦æ‰§è¡Œå¾…å¤„ç†çš„ä»»åŠ¡ï¼Œå½“ä»»åŠ¡æ— æ³•ç»§ç»­è¿›è¡Œå´åˆæ²¡æœ‰å®Œæˆæ—¶ï¼Œå®ƒä¼šæŒ‚èµ·ä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¥½åˆé€‚çš„å”¤é†’æ¡ä»¶ã€‚ä¹‹åï¼Œå¦‚æœ reactor å¾—åˆ°äº†æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶ï¼Œå®ƒä¼šå”¤é†’ä¹‹å‰æŒ‚èµ·çš„ä»»åŠ¡ï¼Œç„¶å executor å°±æœ‰æœºä¼šç»§ç»­æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚è¿™æ ·ä¸€ç›´å¾ªç¯ä¸‹å»ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p><h3>æ€ä¹ˆç”¨ Future åšå¼‚æ­¥å¤„ç†ï¼Ÿ</h3><p>ç†è§£äº† Reactor pattern åï¼ŒRust ä½¿ç”¨ Future åšå¼‚æ­¥å¤„ç†çš„æ•´ä¸ªç»“æ„å°±æ¸…æ™°äº†ï¼Œæˆ‘ä»¬ä»¥ tokio ä¸ºä¾‹ï¼šasync/await æä¾›è¯­æ³•å±‚é¢çš„æ”¯æŒï¼ŒFuture æ˜¯å¼‚æ­¥ä»»åŠ¡çš„æ•°æ®ç»“æ„ï¼Œå½“ fut.await æ—¶ï¼Œexecutor å°±ä¼šè°ƒåº¦å¹¶æ‰§è¡Œå®ƒã€‚</p><p>tokio çš„è°ƒåº¦å™¨ï¼ˆexecutorï¼‰ä¼šè¿è¡Œåœ¨å¤šä¸ªçº¿ç¨‹ä¸Šï¼Œè¿è¡Œçº¿ç¨‹è‡ªå·±çš„ ready queue ä¸Šçš„ä»»åŠ¡ï¼ˆFutureï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å»åˆ«çš„çº¿ç¨‹çš„è°ƒåº¦å™¨ä¸Šâ€œå·â€ä¸€äº›è¿‡æ¥è¿è¡Œã€‚å½“æŸä¸ªä»»åŠ¡æ— æ³•å†ç»§ç»­å–å¾—è¿›å±•ï¼Œæ­¤æ—¶ Future è¿è¡Œçš„ç»“æœæ˜¯ Poll::Pendingï¼Œé‚£ä¹ˆè°ƒåº¦å™¨ä¼šæŒ‚èµ·ä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¥½åˆé€‚çš„å”¤é†’æ¡ä»¶ï¼ˆWakerï¼‰ï¼Œç­‰å¾…è¢« reactor å”¤é†’ã€‚</p><p>è€Œ reactor ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„å¼‚æ­¥ I/Oï¼Œæ¯”å¦‚ epoll / kqueue / IOCPï¼Œæ¥ç›‘å¬æ“ä½œç³»ç»Ÿæä¾›çš„ IO äº‹ä»¶ï¼Œå½“é‡åˆ°æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶æ—¶ï¼Œå°±ä¼šè°ƒç”¨ Waker.wake() å”¤é†’è¢«æŒ‚èµ·çš„ Futureã€‚è¿™ä¸ª Future ä¼šå›åˆ° ready queue ç­‰å¾…æ‰§è¡Œã€‚</p><p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/69/30/69faf0cc944c1a19e8eba7f5ee878330.jpg?wh=2564x1341\" alt=\"\"></p><p>æˆ‘ä»¬ä»¥ä¸€ä¸ªå…·ä½“çš„ä»£ç ç¤ºä¾‹æ¥è¿›ä¸€æ­¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=c75ff383ac2696eb420ad4f10b9269b2\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse futures::{SinkExt, StreamExt};\nuse tokio::net::TcpListener;\nuse tokio_util::codec::{Framed, LinesCodec};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let addr = \"0.0.0.0:8080\";\n    let listener = TcpListener::bind(addr).await?;\n    println!(\"listen to: {}\", addr);\n    loop {\n        let (stream, addr) = listener.accept().await?;\n        println!(\"Accepted: {:?}\", addr);\n        tokio::spawn(async move {\n            // ä½¿ç”¨ LinesCodec æŠŠ TCP æ•°æ®åˆ‡æˆä¸€è¡Œè¡Œå­—ç¬¦ä¸²å¤„ç†\n            let framed = Framed::new(stream, LinesCodec::new());\n            // split æˆ writer å’Œ reader\n            let (mut w, mut r) = framed.split();\n            for line in r.next().await {\n                // æ¯è¯»åˆ°ä¸€è¡Œå°±åŠ ä¸ªå‰ç¼€å‘å›\n                w.send(format!(\"I got: {}\", line?)).await?;\n            }\n            Ok::&lt;_, anyhow::Error&gt;(())\n        });\n    }\n}\n</code></pre><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ TCP æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°±ä¼šç”¨ <a href=\"https://docs.rs/tokio/1.13.0/tokio/fn.spawn.html\">tokio::spawn</a> åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæ”¾å…¥ executor ä¸­æ‰§è¡Œã€‚è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥å—å®¢æˆ·ç«¯å‘æ¥çš„æŒ‰è¡Œåˆ†éš”ï¼ˆåˆ†éš”ç¬¦æ˜¯ â€œ\\r\\nâ€ï¼‰çš„æ•°æ®å¸§ï¼ŒæœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€è¡Œï¼Œå°±åŠ ä¸ªå‰ç¼€æŠŠå†…å®¹ä¹ŸæŒ‰è¡Œå‘å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>ä½ å¯ä»¥ç”¨ telnet å’Œè¿™ä¸ªæœåŠ¡å™¨äº¤äº’ï¼š</p><pre><code class=\"language-rust\">â¯ telnet localhost 8080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nhello\nI got: hello\nConnection closed by foreign host.\n</code></pre><p>å‡è®¾æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯è¾“å…¥äº†å¾ˆå¤§çš„ä¸€è¡Œæ•°æ®ï¼ŒæœåŠ¡å™¨åœ¨åš <code>r.next().await</code> åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæ”¶ä¸å®Œä¸€è¡Œçš„æ•°æ®ï¼Œå› è€Œè¿™ä¸ª Future è¿”å› Poll::Pendingï¼Œæ­¤æ—¶å®ƒè¢«æŒ‚èµ·ã€‚å½“åç»­å®¢æˆ·ç«¯çš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œreactor ä¼šçŸ¥é“è¿™ä¸ª socket ä¸Šåˆæœ‰æ•°æ®äº†ï¼Œäºæ˜¯æ‰¾åˆ° socket å¯¹åº”çš„ Futureï¼Œå°†å…¶å”¤é†’ï¼Œç»§ç»­æ¥æ”¶æ•°æ®ã€‚</p><p>è¿™æ ·åå¤ä¸‹å»ï¼Œæœ€ç»ˆ r.next().await å¾—åˆ° Poll::Ready(Ok(line))ï¼Œäºæ˜¯å®ƒè¿”å› Ok(line)ï¼Œç¨‹åºç»§ç»­å¾€ä¸‹èµ°ï¼Œè¿›å…¥åˆ° w.send() çš„é˜¶æ®µã€‚</p><p>ä»è¿™æ®µä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Rust ä¸‹ä½¿ç”¨å¼‚æ­¥å¤„ç†æ˜¯ä¸€ä»¶éå¸¸ç®€å•çš„äº‹æƒ…ï¼Œé™¤äº†å‡ ä¸ªä½ å¯èƒ½ä¸å¤ªç†Ÿæ‚‰çš„æ¦‚å¿µï¼Œæ¯”å¦‚ä»Šå¤©è®²åˆ°çš„ç”¨äºåˆ›å»º Future çš„ async å…³é”®å­—ï¼Œç”¨äºæ‰§è¡Œå’Œç­‰å¾… Future æ‰§è¡Œå®Œæ¯•çš„ await å…³é”®å­—ï¼Œä»¥åŠç”¨äºè°ƒåº¦ Future æ‰§è¡Œçš„è¿è¡Œæ—¶ #[tokio:main] å¤–ï¼Œ<strong>æ•´ä½“çš„ä»£ç å’Œä½¿ç”¨çº¿ç¨‹å¤„ç†çš„ä»£ç å®Œå…¨ä¸€è‡´</strong>ã€‚æ‰€ä»¥ï¼Œå®ƒçš„ä¸Šæ‰‹éš¾åº¦éå¸¸ä½ï¼Œå¾ˆå®¹æ˜“ä½¿ç”¨ã€‚</p><h2>ä½¿ç”¨ Future çš„æ³¨æ„äº‹é¡¹</h2><p>ç›®å‰æˆ‘ä»¬å·²ç»åŸºæœ¬æ˜ç™½ Future è¿è¡Œçš„åŸºæœ¬åŸç†äº†ï¼Œä¹Ÿå¯ä»¥åœ¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†è‡ªå¦‚åœ°ä½¿ç”¨ Future/async/await æ¥è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚</p><p>ä½†æ˜¯è¦æ³¨æ„ï¼Œ<strong>ä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨åœºæ™¯éƒ½é€‚åˆç”¨ async/await</strong>ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæœ‰ä¸€äº›ä¸å®¹æ˜“æ³¨æ„åˆ°çš„å‘éœ€è¦æˆ‘ä»¬å¦¥å–„è€ƒè™‘ã€‚</p><h3>1. å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ—¶</h3><p>å½“ä½ è¦å¤„ç†çš„ä»»åŠ¡æ˜¯ CPU å¯†é›†å‹ï¼Œè€Œé IO å¯†é›†å‹ï¼Œæ›´é€‚åˆä½¿ç”¨çº¿ç¨‹ï¼Œè€Œé Futureã€‚</p><p>è¿™æ˜¯å› ä¸º Future çš„è°ƒåº¦æ˜¯åä½œå¼å¤šä»»åŠ¡ï¼ˆCooperative Multitaskingï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤é Future ä¸»åŠ¨æ”¾å¼ƒ CPUï¼Œä¸ç„¶å®ƒå°±ä¼šä¸€ç›´è¢«æ‰§è¡Œï¼Œç›´åˆ°è¿è¡Œç»“æŸã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=caccd8cca9612f6db17c540c0d915cd9\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse std::time::Duration;\n\n// å¼ºåˆ¶ tokio åªä½¿ç”¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè¿™æ · task 2 ä¸ä¼šè·‘åˆ°å…¶å®ƒçº¿ç¨‹æ‰§è¡Œ\n#[tokio::main(worker_threads = 1)]\nasync fn main() -&gt; Result&lt;()&gt; {\n    // å…ˆå¼€å§‹æ‰§è¡Œ task 1 çš„è¯ä¼šé˜»å¡ï¼Œè®© task 2 æ²¡æœ‰æœºä¼šè¿è¡Œ\n    tokio::spawn(async move {\n        eprintln!(\"task 1\");\n        // è¯•è¯•æŠŠè¿™å¥æ³¨é‡Šæ‰çœ‹çœ‹ä¼šäº§ç”Ÿä»€ä¹ˆç»“æœ\n        // tokio::time::sleep(Duration::from_millis(1)).await;\n        loop {}\n    });\n\n    tokio::spawn(async move {\n        eprintln!(\"task 2\");\n    });\n\n    tokio::time::sleep(Duration::from_millis(1)).await;\n    Ok(())\n}\n</code></pre><p>task 1 é‡Œæœ‰ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ˜¯æ‰§è¡Œæ—¶é—´å¾ˆé•¿åˆä¸åŒ…æ‹¬ IO å¤„ç†çš„ä»£ç ã€‚è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå‘ç°ï¼Œtask 2 æ²¡æœ‰æœºä¼šå¾—åˆ°æ‰§è¡Œã€‚è¿™æ˜¯å› ä¸º task 1 ä¸æ‰§è¡Œç»“æŸï¼Œæˆ–è€…ä¸è®©å‡º CPUï¼Œtask 2 æ²¡æœ‰æœºä¼šè¢«è°ƒåº¦ã€‚</p><p>å¦‚æœä½ çš„ç¡®éœ€è¦åœ¨ tokioï¼ˆæˆ–è€…å…¶å®ƒå¼‚æ­¥è¿è¡Œæ—¶ï¼‰ä¸‹è¿è¡Œè¿ç®—é‡å¾ˆå¤§çš„ä»£ç ï¼Œé‚£ä¹ˆæœ€å¥½ä½¿ç”¨ yield æ¥ä¸»åŠ¨è®©å‡º CPUï¼Œæ¯”å¦‚ <a href=\"https://docs.rs/tokio/1.13.0/tokio/task/fn.yield_now.html\">tokio::task::yield_now()</a>ã€‚è¿™æ ·å¯ä»¥é¿å…æŸä¸ªè®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡é¥¿æ­»å…¶å®ƒä»»åŠ¡ã€‚</p><h3>2. å¼‚æ­¥ä»£ç ä¸­ä½¿ç”¨Mutexæ—¶</h3><p>å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæ ‡å‡†åº“çš„ Mutex å¯ä»¥ç”¨åœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œè€Œä¸”ï¼Œè¿™æ˜¯æ¨èçš„ç”¨æ³•ã€‚</p><p>ç„¶è€Œï¼Œæ ‡å‡†åº“çš„ MutexGuard ä¸èƒ½å®‰å…¨åœ°è·¨è¶Š awaitï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦è·å¾—é”ä¹‹åæ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå¿…é¡»ä½¿ç”¨ tokio è‡ªå¸¦çš„ Mutexï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼ˆ<a href=\"https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=19aa6ac57f79c3766c1775c03ece072d\">ä»£ç </a>ï¼‰ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse std::{sync::Arc, time::Duration};\nuse tokio::sync::Mutex;\n\nstruct DB;\n\nimpl DB {\n    // å‡è£…åœ¨ commit æ•°æ®\n    async fn commit(&amp;mut self) -&gt; Result&lt;usize&gt; {\n        Ok(42)\n    }\n}\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let db1 = Arc::new(Mutex::new(DB));\n    let db2 = Arc::clone(&amp;db1);\n\n    tokio::spawn(async move {\n        let mut db = db1.lock().await;\n        // å› ä¸ºæ‹¿åˆ°çš„ MutexGuard è¦è·¨è¶Š awaitï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ std::sync::Mutex\n        // åªèƒ½ç”¨ tokio::sync::Mutex\n        let affected = db.commit().await?;\n        println!(\"db1: Total affected rows: {}\", affected);\n        Ok::&lt;_, anyhow::Error&gt;(())\n    });\n\n    tokio::spawn(async move {\n        let mut db = db2.lock().await;\n        let affected = db.commit().await?;\n        println!(\"db2: Total affected rows: {}\", affected);\n\n        Ok::&lt;_, anyhow::Error&gt;(())\n    });\n\n    // è®©ä¸¤ä¸ª task æœ‰æœºä¼šæ‰§è¡Œå®Œ\n    tokio::time::sleep(Duration::from_millis(1)).await;\n\n    Ok(())\n}\n</code></pre><p>è¿™ä¸ªä¾‹å­æ¨¡æ‹Ÿäº†ä¸€ä¸ªæ•°æ®åº“çš„å¼‚æ­¥ commit() æ“ä½œã€‚å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ª tokio task ä¸­ä½¿ç”¨è¿™ä¸ª DBï¼Œéœ€è¦ä½¿ç”¨ Arc&lt;Mutext&lt;DB&gt;&gt;ã€‚ç„¶è€Œï¼Œdb1.lock() æ‹¿åˆ°é”åï¼Œæˆ‘ä»¬éœ€è¦è¿è¡Œ db.commit().awaitï¼Œè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚</p><p>å‰é¢è®²è¿‡ï¼Œå› ä¸º tokio å®ç°äº† work-stealing è°ƒåº¦ï¼Œ<strong>Future æœ‰å¯èƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ™®é€šçš„ MutexGuard ç¼–è¯‘ç›´æ¥å°±ä¼šå‡ºé”™</strong>ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ tokio çš„ Mutexã€‚æ›´å¤šä¿¡æ¯å¯ä»¥çœ‹<a href=\"https://docs.rs/tokio/1.13.0/tokio/sync/struct.Mutex.html\">æ–‡æ¡£</a>ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬åˆè§è¯†åˆ°äº† Rust ç¼–è¯‘å™¨çš„ä¼Ÿå¤§ä¹‹å¤„ï¼šå¦‚æœä¸€ä»¶äº‹ï¼Œå®ƒè§‰å¾—ä½ ä¸èƒ½åšï¼Œä¼šé€šè¿‡ç¼–è¯‘å™¨é”™è¯¯é˜»æ­¢ä½ ï¼Œè€Œä¸æ˜¯ä»»ç”±ç¼–è¯‘é€šè¿‡ï¼Œç„¶åè®©ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¬å¤©ç”±å‘½ï¼Œè®©ä½ æ— ä¼‘æ­¢åœ°å’Œæ‰æ‘¸ä¸å®šçš„å¹¶å‘ bug æ–—äº‰ã€‚</p><h3>3. åœ¨çº¿ç¨‹å’Œå¼‚æ­¥ä»»åŠ¡é—´åšåŒæ­¥æ—¶</h3><p>åœ¨ä¸€ä¸ªå¤æ‚çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¼šå…¼æœ‰è®¡ç®—å¯†é›†å’Œ IO å¯†é›†çš„ä»»åŠ¡ã€‚</p><p>å‰é¢è¯´äº†ï¼Œè¦é¿å…åœ¨ tokio è¿™æ ·çš„å¼‚æ­¥è¿è¡Œæ—¶ä¸­è¿è¡Œå¤§é‡è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä¸€æ¥æ•ˆç‡ä¸é«˜ï¼ŒäºŒæ¥è¿˜å®¹æ˜“é¥¿æ­»å…¶å®ƒä»»åŠ¡ã€‚</p><p>æ‰€ä»¥ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯æˆ‘ä»¬ä½¿ç”¨ channel æ¥åœ¨çº¿ç¨‹å’Œfutureä¸¤è€…ä¹‹é—´åšåŒæ­¥ã€‚çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-rust\">use std::thread;\n\nuse anyhow::Result;\nuse blake3::Hasher;\nuse futures::{SinkExt, StreamExt};\nuse rayon::prelude::*;\nuse tokio::{\n    net::TcpListener,\n    sync::{mpsc, oneshot},\n};\nuse tokio_util::codec::{Framed, LinesCodec};\n\npub const PREFIX_ZERO: &amp;[u8] = &amp;[0, 0, 0];\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    let addr = \"0.0.0.0:8080\";\n    let listener = TcpListener::bind(addr).await?;\n    println!(\"listen to: {}\", addr);\n\n    // åˆ›å»º tokio task å’Œ thread ä¹‹é—´çš„ channel\n    let (sender, mut receiver) = mpsc::unbounded_channel::&lt;(String, oneshot::Sender&lt;String&gt;)&gt;();\n\n    // ä½¿ç”¨ thread å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡\n    thread::spawn(move || {\n        // è¯»å–ä» tokio task è¿‡æ¥çš„ msgï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ blocking_recvï¼Œè€Œé await\n        while let Some((line, reply)) = receiver.blocking_recv() {\n            // è®¡ç®— pow\n            let result = match pow(&amp;line) {\n                Some((hash, nonce)) =&gt; format!(\"hash: {}, once: {}\", hash, nonce),\n                None =&gt; \"Not found\".to_string(),\n            };\n            // æŠŠè®¡ç®—ç»“æœä» oneshot channel é‡Œå‘å›\n            if let Err(e) = reply.send(result) {\n                println!(\"Failed to send: {}\", e);\n            }\n        }\n    });\n\n    // ä½¿ç”¨ tokio task å¤„ç† IO å¯†é›†å‹ä»»åŠ¡\n    loop {\n        let (stream, addr) = listener.accept().await?;\n        println!(\"Accepted: {:?}\", addr);\n        let sender1 = sender.clone();\n        tokio::spawn(async move {\n            // ä½¿ç”¨ LinesCodec æŠŠ TCP æ•°æ®åˆ‡æˆä¸€è¡Œè¡Œå­—ç¬¦ä¸²å¤„ç†\n            let framed = Framed::new(stream, LinesCodec::new());\n            // split æˆ writer å’Œ reader\n            let (mut w, mut r) = framed.split();\n            for line in r.next().await {\n                // ä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ›å»ºä¸€ä¸ª oneshot channelï¼Œç”¨äºå‘é€å›å¤\n                let (reply, reply_receiver) = oneshot::channel();\n                sender1.send((line?, reply))?;\n\n                // æ¥æ”¶ pow è®¡ç®—å®Œæˆåçš„ hash å’Œ nonce\n                if let Ok(v) = reply_receiver.await {\n                    w.send(format!(\"Pow calculated: {}\", v)).await?;\n                }\n            }\n            Ok::&lt;_, anyhow::Error&gt;(())\n        });\n    }\n}\n\n// ä½¿ç”¨ rayon å¹¶å‘è®¡ç®— u32 ç©ºé—´ä¸‹æ‰€æœ‰ nonceï¼Œç›´åˆ°æ‰¾åˆ°æœ‰å¤´ N ä¸ª 0 çš„å“ˆå¸Œ\npub fn pow(s: &amp;str) -&gt; Option&lt;(String, u32)&gt; {\n    let hasher = blake3_base_hash(s.as_bytes());\n    let nonce = (0..u32::MAX).into_par_iter().find_any(|n| {\n        let hash = blake3_hash(hasher.clone(), n).as_bytes().to_vec();\n        &amp;hash[..PREFIX_ZERO.len()] == PREFIX_ZERO\n    });\n    nonce.map(|n| {\n        let hash = blake3_hash(hasher, &amp;n).to_hex().to_string();\n        (hash, n)\n    })\n}\n\n// è®¡ç®—æºå¸¦ nonce åçš„å“ˆå¸Œ\nfn blake3_hash(mut hasher: blake3::Hasher, nonce: &amp;u32) -&gt; blake3::Hash {\n    hasher.update(&amp;nonce.to_be_bytes()[..]);\n    hasher.finalize()\n}\n\n// è®¡ç®—æ•°æ®çš„å“ˆå¸Œ\nfn blake3_base_hash(data: &amp;[u8]) -&gt; Hasher {\n    let mut hasher = Hasher::new();\n    hasher.update(data);\n    hasher\n}\n</code></pre><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¹‹å‰æ’°å†™çš„ TCP serverï¼Œåªä¸è¿‡è¿™æ¬¡ï¼Œå®¢æˆ·ç«¯è¾“å…¥è¿‡æ¥çš„ä¸€è¡Œæ–‡å­—ï¼Œä¼šè¢«è®¡ç®—å‡ºä¸€ä¸ª POWï¼ˆProof of Workï¼‰çš„å“ˆå¸Œï¼šè°ƒæ•´ nonceï¼Œä¸æ–­è®¡ç®—å“ˆå¸Œï¼Œç›´åˆ°å“ˆå¸Œçš„å¤´ä¸‰ä¸ªå­—èŠ‚å…¨æ˜¯é›¶ä¸ºæ­¢ã€‚æœåŠ¡å™¨è¦è¿”å›è®¡ç®—å¥½çš„å“ˆå¸Œå’Œè·å¾—è¯¥å“ˆå¸Œçš„ nonceã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨çº¿ç¨‹æ¥å¤„ç†å®ƒã€‚</p><p>è€Œåœ¨ tokio task å’Œ thread é—´ä½¿ç”¨ channel è¿›è¡ŒåŒæ­¥ã€‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª ubounded MPSC channel ä» tokio task ä¾§å¾€ thread ä¾§å‘é€æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½é™„å¸¦ä¸€ä¸ª oneshot channel ç”¨äº thread ä¾§å¾€ tokio task ä¾§å‘é€æ•°æ®ã€‚</p><p>å»ºè®®ä½ ä»”ç»†è¯»è¯»è¿™æ®µä»£ç ï¼Œæœ€å¥½è‡ªå·±å†™ä¸€éï¼Œæ„Ÿå—ä¸€ä¸‹ä½¿ç”¨ channel åœ¨è®¡ç®—å¯†é›†å‹å’Œ IO å¯†é›†å‹ä»»åŠ¡åŒæ­¥çš„æ–¹å¼ã€‚å¦‚æœä½ ç”¨ telnet è¿æ¥ï¼Œå‘é€ â€œhello world!â€ï¼Œä¼šå¾—åˆ°ä¸åŒçš„å“ˆå¸Œå’Œ nonceï¼Œå®ƒä»¬éƒ½æ˜¯æ­£ç¡®çš„ç»“æœï¼š</p><pre><code class=\"language-rust\">â¯ telnet localhost 8080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nhello world!\nPow calculated: hash: 0000006e6e9370d0f60f06bdc288efafa203fd99b9af0480d040b2cc89c44df0, once: 403407307\nConnection closed by foreign host.\n\nâ¯ telnet localhost 8080\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nhello world!\nPow calculated: hash: 000000e23f0e9b7aeba9060a17ac676f3341284800a2db843e2f0e85f77f52dd, once: 36169623\nConnection closed by foreign host.\n</code></pre><h2>å°ç»“</h2><p>é€šè¿‡æ‹†è§£async fn æœ‰ç‚¹å¥‡æ€ªçš„è¿”å›å€¼ç»“æ„ï¼Œæˆ‘ä»¬å­¦ä¹ äº† Reactor patternï¼Œå¤§è‡´äº†è§£äº† tokio å¦‚ä½•é€šè¿‡ executor å’Œ reactor å…±åŒä½œç”¨ï¼Œå®Œæˆ Future çš„è°ƒåº¦ã€æ‰§è¡Œã€é˜»å¡ï¼Œä»¥åŠå”¤é†’ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯ï¼Œç›´åˆ° Future è¿”å› Poll::Ready(T)ã€‚</p><p>åœ¨å­¦ä¹  Future çš„ä½¿ç”¨æ—¶ï¼Œä¼°è®¡ä½ ä¹Ÿå‘ç°äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸‹åˆ—ä»£ç çš„ç»“æ„å¤šä¹ˆç›¸ä¼¼ï¼š</p><pre><code class=\"language-rust\">fn thread_async() -&gt; JoinHandle&lt;usize&gt; {\n    thread::spawn(move || {\n        println!(\"hello thread!\");\n        42\n    })\n}\n\nfn task_async() -&gt; impl Future&lt;Output = usize&gt; {\n    async move {\n        println!(\"hello async!\");\n        42\n    }\n}\n</code></pre><p>åœ¨ä½¿ç”¨ Future æ—¶ï¼Œä¸»è¦æœ‰3ç‚¹æ³¨æ„äº‹é¡¹ï¼š</p><ol>\n<li>æˆ‘ä»¬è¦é¿å…åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­å¤„ç†å¤§é‡è®¡ç®—å¯†é›†å‹çš„å·¥ä½œï¼›</li>\n<li>åœ¨ä½¿ç”¨ Mutex ç­‰åŒæ­¥åŸè¯­æ—¶ï¼Œè¦æ³¨æ„æ ‡å‡†åº“çš„ MutexGuard æ— æ³•è·¨è¶Š .awaitï¼Œæ‰€ä»¥ï¼Œæ­¤æ—¶è¦ä½¿ç”¨å¯¹å¼‚æ­¥å‹å¥½çš„ Mutexï¼Œå¦‚ tokio::sync::Mutexï¼›</li>\n<li>å¦‚æœè¦åœ¨çº¿ç¨‹å’Œå¼‚æ­¥ä»»åŠ¡é—´åŒæ­¥ï¼Œå¯ä»¥ä½¿ç”¨ channelã€‚</li>\n</ol><p>ä»Šå¤©ä¸ºäº†å¸®åŠ©ä½ æ·±å…¥ç†è§£ï¼Œæˆ‘ä»¬å†™äº†å¾ˆå¤šä»£ç ï¼Œæ¯ä¸€æ®µä½ éƒ½å¯ä»¥å†ä»”ç»†é˜…è¯»å‡ éï¼ŒæŠŠå®ƒä»¬ææ‡‚ï¼Œæœ€å¥½è‡ªå·±ä¹Ÿèƒ½ç›´æ¥å†™å‡ºæ¥ï¼Œè¿™æ ·ä½ å¯¹ Future æ‰ä¼šæœ‰æ›´æ·±çš„ç†è§£ã€‚</p><h3>æ€è€ƒé¢˜</h3><p>æƒ³æƒ³çœ‹ï¼Œä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š awaitï¼Ÿä½ å¯ä»¥æŠŠæ–‡ä¸­ä½¿ç”¨ tokio::sync::Mutex çš„ä»£ç æ”¹æˆä½¿ç”¨ std::sync::Mutexï¼Œå¹¶å¯¹ä½¿ç”¨çš„æ¥å£åšç›¸åº”çš„æ”¹åŠ¨ï¼ˆæŠŠ lock().await æ”¹æˆ lock().unwrap()ï¼‰ï¼Œçœ‹çœ‹ç¼–è¯‘å™¨ä¼šæŠ¥ä»€ä¹ˆé”™ã€‚å¯¹ç€é”™è¯¯æç¤ºï¼Œä½ æ˜ç™½ä¸ºä»€ä¹ˆäº†ä¹ˆï¼Ÿ</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„å­¦ä¹ æ„Ÿæ‚Ÿå’Œæ€è€ƒã€‚ä»Šå¤©ä½ å®ŒæˆRustå­¦ä¹ çš„ç¬¬38æ¬¡æ‰“å¡å•¦ï¼Œæ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œå¦‚æœä½ è§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™èº«è¾¹çš„æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·è®¨è®ºã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":325395,"user_name":"Marvichov","can_delete":false,"product_type":"c1","uid":1111835,"ip_address":"","ucode":"7482099415C41C","user_header":"https://static001.geekbang.org/account/avatar/00/10/f7/1b/db7a0edc.jpg","comment_is_top":false,"comment_ctime":1638943348,"is_pvip":false,"replies":[{"id":"118831","content":"tokio ä¼šåœ¨æ¯ä¸ª CPU core ä¸Šè¿è¡Œä¸€ä¸ª OS thread æ¥å¤„ç†è°ƒåº¦ã€‚åé¢çš„å†…å®¹è®²åˆ°ï¼Œasync å’Œ await å…¶å®å°±æ˜¯è¯­æ³•ç³–ï¼Œawait çš„ç‚¹åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šç¼–è¯‘æˆçŠ¶æ€æœºçš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸€ä¸ªå†…éƒ¨æ‹¥æœ‰å¤šä¸ª await çš„ async å‡½æ•°ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªå¤æ‚çš„çŠ¶æ€æœºï¼ŒæŒ‰ await çš„é¡ºåºä¾æ¬¡ poll futureã€‚åœ¨ poll çš„æ—¶å€™ï¼Œå¦‚æœ pendingï¼Œexecutor ä¼šå°†å…¶æŒ‚èµ·ã€‚executor  å†å»å–ä¸‹ä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„ Futureã€‚å¦‚æœæ²¡æœ‰å¯æ‰§è¡Œçš„ Futureï¼Œæ‰ä¼šå»&quot;å·&quot; åˆ«çš„çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„ Future æ‰§è¡Œã€‚","user_name":"ä½œè€…å›å¤","comment_id":325395,"uid":"1079375","ip_address":"","utype":1,"ctime":1639807958,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"10228877940","product_id":100085301,"comment_content":"ç°åœ¨ä¸€èŠ‚è¯¾éœ€è¦å¾ˆä¹…æ‰å‹‰å¼ºæ¶ˆåŒ–...è¿™è¯¾çœŸå¿ƒå€¼!<br><br>```<br>    error: future cannot be sent between threads safely<br>    29 | tokio::spawn(async move {<br>    | ^^^^^^^^^^^^ future created by async block is not Send<br>```<br><br>tokio::spawnè¦æ±‚Tæ˜¯Send, ä¹Ÿå°±æ˜¯å¯ä»¥cross thread boundary<br><br>```<br>pub fn spawn&lt;T&gt;(task: T) -&gt; JoinHandle&lt;T::Output&gt; <br>where<br>    T: Future + Send + &#39;static,<br>    T::Output: Send + &#39;static, <br><br>```<br>å‚è§: https:&#47;&#47;docs.rs&#47;tokio&#47;0.2.18&#47;tokio&#47;fn.spawn.html<br><br>å¯¹executoräº†è§£å¾ˆå°‘...ä½†ä»æ–‡ä¸­çš„æç¤º (task stealing, ä»å…¶ä»–threadå·task), executoråº”è¯¥æœ‰ä¸ªthread poolå¯ä»¥åœ¨ä¸åŒçš„threadé‡Œé¢poll future...<br><br>è‡³äºawaité‡Œé¢æ€ä¹ˆå°±æœ‰å¤šçº¿ç¨‹çš„executor, è¿˜å¸Œæœ›è€å¸ˆç­”ç–‘è§£æƒ‘!","like_count":3,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539707,"discussion_content":"tokio ä¼šåœ¨æ¯ä¸ª CPU core ä¸Šè¿è¡Œä¸€ä¸ª OS thread æ¥å¤„ç†è°ƒåº¦ã€‚åé¢çš„å†…å®¹è®²åˆ°ï¼Œasync å’Œ await å…¶å®å°±æ˜¯è¯­æ³•ç³–ï¼Œawait çš„ç‚¹åœ¨ç¼–è¯‘æ—¶éƒ½ä¼šç¼–è¯‘æˆçŠ¶æ€æœºçš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸€ä¸ªå†…éƒ¨æ‹¥æœ‰å¤šä¸ª await çš„ async å‡½æ•°ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªå¤æ‚çš„çŠ¶æ€æœºï¼ŒæŒ‰ await çš„é¡ºåºä¾æ¬¡ poll futureã€‚åœ¨ poll çš„æ—¶å€™ï¼Œå¦‚æœ pendingï¼Œexecutor ä¼šå°†å…¶æŒ‚èµ·ã€‚executor  å†å»å–ä¸‹ä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„ Futureã€‚å¦‚æœæ²¡æœ‰å¯æ‰§è¡Œçš„ Futureï¼Œæ‰ä¼šå»&#34;å·&#34; åˆ«çš„çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„ Future æ‰§è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639807958,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351297,"user_name":"ELSE","can_delete":false,"product_type":"c1","uid":1172907,"ip_address":"","ucode":"72448D7271C8B0","user_header":"https://static001.geekbang.org/account/avatar/00/11/e5/ab/56f348e5.jpg","comment_is_top":false,"comment_ctime":1657682252,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5952649548","product_id":100085301,"comment_content":"æœ‰ä¸ªç–‘é—®ï¼Œåƒè¿™æ ·çš„è¯­å¥ï¼ŒåŒæ­¥å’Œå¼‚æ­¥æœ‰ä»€ä¹ˆåŒºåˆ«å—<br>let listener = TcpListener::bind(addr).await?;","like_count":1,"discussions":[{"author":{"id":1785016,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/3c/b8/9489387c.jpg","nickname":"é±¼ä¸¸ç²—é¢","note":"","ucode":"B2F3F75B0D1422","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589528,"discussion_content":"æˆ‘çŒœå®ƒåœ¨å½“å‰ä»»åŠ¡awaitçš„æ—¶å€™ï¼Œå»æ‰§è¡Œå…¶ä»–çš„ä»»åŠ¡æˆ–å»å·ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665061117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358951,"user_name":"é±¼ä¸¸ç²—é¢","can_delete":false,"product_type":"c1","uid":1785016,"ip_address":"å¹¿ä¸œ","ucode":"B2F3F75B0D1422","user_header":"https://static001.geekbang.org/account/avatar/00/1b/3c/b8/9489387c.jpg","comment_is_top":false,"comment_ctime":1665061658,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665061658","product_id":100085301,"comment_content":"mutexGuardçš„dropæ–¹æ³•é‡Œæœ‰é‡Šæ”¾é”çš„åŠŸèƒ½ï¼Œå®ƒé”€æ¯æ—¶ä¼šé‡Šæ”¾é”ï¼ŒæŠŠå®ƒå‘å‡ºå»ä¼šé€ æˆåŒæ­¥è¯­ä¹‰çš„ç ´åã€‚æ¯”å¦‚guardå·²ç»è¢«é”€æ¯è€Œå½“å‰çº¿ç¨‹ä»ç„¶åœ¨å®‰å…¨åŒºåŸŸä¿®æ”¹è¢«ä¿æŠ¤çš„æ•°æ®","like_count":0},{"had_liked":false,"id":350981,"user_name":"zxk","can_delete":false,"product_type":"c1","uid":1221195,"ip_address":"","ucode":"4BB2BD9D2BCD04","user_header":"https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg","comment_is_top":false,"comment_ctime":1657437576,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1657437576","product_id":100085301,"comment_content":"è¿™æ˜¯ç”±äº MutexGuard æ²¡æœ‰å®ç° Send traitã€‚<br>å¯¹äº MutexGuard ä¸ºä»€ä¹ˆä¸å®ç° Send çš„ä¸€ç‚¹æ€è€ƒï¼Œä¸çŸ¥é“æ˜¯å¦ç†è§£æ­£ç¡®ï¼Œæœ›è€å¸ˆæŒ‡ç‚¹ä¸‹ã€‚<br>æ ‡å‡†åº“çš„ MutexGuard ä¸»è¦æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œä¸€ä¸ªçº¿ç¨‹é€šè¿‡ lock è·å–åˆ°é”åç‹¬å è¯¥ä¸´ç•ŒåŒºçš„èµ„æºã€‚å‡è®¾å…è®¸ MutexGuard è·¨è¶Š awaitï¼Œé‚£ä¹ˆ MutexGuard å°±æœ‰å¯èƒ½éšç€ Future è·‘åˆ°å…¶ä»–çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œé‚£å°±ç ´åäº†ä¹‹å‰çš„çº¿ç¨‹ç‹¬å è¯¥ä¸´ç•ŒåŒºçš„è¯­ä¹‰äº†ã€‚","like_count":0},{"had_liked":false,"id":338843,"user_name":"RAY_CCWğŸ˜ğŸ˜ğŸ˜","can_delete":false,"product_type":"c1","uid":1145067,"ip_address":"","ucode":"D9F5ACD762628A","user_header":"https://static001.geekbang.org/account/avatar/00/11/78/eb/c2fd27f6.jpg","comment_is_top":false,"comment_ctime":1647761255,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1647761255","product_id":100085301,"comment_content":"tyrè€å¸ˆï¼Œæƒ³é—®ä¸€ä¸‹ï¼Œå…¶å®Rust executorçš„Reactor æ¨¡å¼ï¼Œæœ¬è´¨æ˜¯ä¹Ÿæ˜¯ç”¨äº†ç±»ä¼¼äºäº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥æ–¹å¼æ¥å®ç°ï¼Ÿå› ä¸ºè¿‘å¹´éƒ½åœ¨å†™goï¼Œçœ‹åˆ°è¿™ä¸ªæƒ³èµ·æ¥ä»¥å‰å†™Pythonæ—¶å€™çš„geventçš„æ„Ÿè§‰äº†ã€‚","like_count":0},{"had_liked":false,"id":335459,"user_name":"...zzZ","can_delete":false,"product_type":"c1","uid":2660581,"ip_address":"","ucode":"953A50D833CA58","user_header":"https://static001.geekbang.org/account/avatar/00/28/98/e5/a716040e.jpg","comment_is_top":false,"comment_ctime":1645525842,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645525842","product_id":100085301,"comment_content":"rust futureä¸­çš„taskå’Œexecutorèƒ½ä¸èƒ½ç±»æ¯”äºgo MPGæ¨¡å‹ä¸­çš„Gå’ŒPï¼Ÿ","like_count":0},{"had_liked":false,"id":324186,"user_name":"CyNevis","can_delete":false,"product_type":"c1","uid":2271650,"ip_address":"","ucode":"0BF0B6F8D540EB","user_header":"","comment_is_top":false,"comment_ctime":1638329607,"is_pvip":true,"replies":[{"id":"118870","content":"å¾ˆç®€å•ï¼Œå› ä¸ºæ ‡å‡†åº“çš„ MutexGuard ä¸æ˜¯ Send: https:&#47;&#47;doc.rust-lang.org&#47;src&#47;std&#47;sync&#47;mutex.rs.html#204ï¼Œè€Œ tokio çš„å®ç°äº† Sendï¼šhttps:&#47;&#47;docs.rs&#47;tokio&#47;latest&#47;tokio&#47;sync&#47;struct.MutexGuard.htmlã€‚","user_name":"ä½œè€…å›å¤","comment_id":324186,"uid":"1079375","ip_address":"","utype":1,"ctime":1639849291,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1638329607","product_id":100085301,"comment_content":"æ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š await, ç›²çŒœä¸€æ‰‹æ˜¯ä¸æ˜¯æ ‡å‡†åº“çš„Mutexå®ç°æ˜¯ä¾èµ–çº¿ç¨‹ç»‘å®š, å¾—å»çœ‹ä»£ç æ˜¯æ€ä¹ˆå®ç°çš„","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539831,"discussion_content":"å¾ˆç®€å•ï¼Œå› ä¸ºæ ‡å‡†åº“çš„ MutexGuard ä¸æ˜¯ Send: https://doc.rust-lang.org/src/std/sync/mutex.rs.html#204ï¼Œè€Œ tokio çš„å®ç°äº† Sendï¼šhttps://docs.rs/tokio/latest/tokio/sync/struct.MutexGuard.htmlã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639849291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2739182,"avatar":"https://static001.geekbang.org/account/avatar/00/29/cb/ee/bec29202.jpg","nickname":"çˆ±åƒçŒ•çŒ´æ¡ƒ","note":"","ucode":"9E43716DBFEFCE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":550362,"discussion_content":"ä¸ºä½•æ ‡å‡†åº“çš„ mutex ä¸ Send å‘¢ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644497348,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":539831,"ip_address":""},"score":550362,"extra":""}]}]},{"had_liked":false,"id":323503,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1637937110,"is_pvip":false,"replies":[{"id":"117612","content":"playground æŠŠå¸¸è§çš„ crate éƒ½æ·»åŠ äº†","user_name":"ä½œè€…å›å¤","comment_id":323503,"uid":"1079375","ip_address":"","utype":1,"ctime":1638292355,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":2,"score":"1637937110","product_id":100085301,"comment_content":"ä»£ç ä¸­çš„ toml::from_str ç¼–è¯‘ä¸è¿‡ï¼Œä½†åœ¨ play.rust-lang.org ä¸­ç«Ÿç„¶å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œå¾ˆç¥å¥‡ï¼Œæˆ‘åœ¨æœ¬åœ°æ·»åŠ äº† toml åº“ï¼Œå¹¶ä¸” use toml ä¹‹åï¼Œä»£ç å°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534895,"discussion_content":"playground æŠŠå¸¸è§çš„ crate éƒ½æ·»åŠ äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638292355,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":323407,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1637891741,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"1637891741","product_id":100085301,"comment_content":"ä»Šå¤©çš„å†…å®¹è¦å¥½å¥½æ¶ˆåŒ–ä¸€ä¸‹â€¦","like_count":0}]}