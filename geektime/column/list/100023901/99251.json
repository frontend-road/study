{"id":99251,"title":"43 | è½¯ä»¶äº‹åŠ¡å†…å­˜ï¼šå€Ÿé‰´æ•°æ®åº“çš„å¹¶å‘ç»éªŒ","content":"<p>å¾ˆå¤šåŒå­¦åé¦ˆè¯´ï¼Œå·¥ä½œäº†æŒºé•¿æ—¶é—´ä½†æ˜¯æ²¡æœ‰æœºä¼šæ¥è§¦å¹¶å‘ç¼–ç¨‹ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¤©å¤©éƒ½åœ¨å†™å¹¶å‘ç¨‹åºï¼Œåªä¸è¿‡å¹¶å‘ç›¸å…³çš„é—®é¢˜éƒ½è¢«ç±»ä¼¼Tomcatè¿™æ ·çš„WebæœåŠ¡å™¨ä»¥åŠMySQLè¿™æ ·çš„æ•°æ®åº“è§£å†³äº†ã€‚å°¤å…¶æ˜¯æ•°æ®åº“ï¼Œåœ¨è§£å†³å¹¶å‘é—®é¢˜æ–¹é¢ï¼Œå¯è°“æˆç»©æ–ç„¶ï¼Œå®ƒçš„<strong>äº‹åŠ¡æœºåˆ¶éå¸¸ç®€å•æ˜“ç”¨</strong>ï¼Œèƒ½ç”©Javaé‡Œé¢çš„é”ã€åŸå­ç±»åæ¡è¡—ã€‚æŠ€æœ¯æ— è¾¹ç•Œï¼Œå¾ˆæ˜¾ç„¶è¦å€Ÿé‰´ä¸€ä¸‹ã€‚</p><p>å…¶å®å¾ˆå¤šç¼–ç¨‹è¯­è¨€éƒ½æœ‰ä»æ•°æ®åº“çš„äº‹åŠ¡ç®¡ç†ä¸­è·å¾—çµæ„Ÿï¼Œå¹¶ä¸”æ€»ç»“å‡ºäº†ä¸€ä¸ªæ–°çš„å¹¶å‘è§£å†³æ–¹æ¡ˆï¼š<strong>è½¯ä»¶äº‹åŠ¡å†…å­˜ï¼ˆSoftware Transactional Memoryï¼Œç®€ç§°STMï¼‰</strong>ã€‚ä¼ ç»Ÿçš„æ•°æ®åº“äº‹åŠ¡ï¼Œæ”¯æŒ4ä¸ªç‰¹æ€§ï¼šåŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰å’ŒæŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶å¸¸è¯´çš„ACIDï¼ŒSTMç”±äºä¸æ¶‰åŠåˆ°æŒä¹…åŒ–ï¼Œæ‰€ä»¥åªæ”¯æŒACIã€‚</p><p>STMçš„ä½¿ç”¨å¾ˆç®€å•ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ç»å…¸çš„è½¬è´¦æ“ä½œä¸ºä¾‹ï¼Œçœ‹çœ‹ç”¨STMè¯¥å¦‚ä½•å®ç°ã€‚</p><h2>ç”¨STMå®ç°è½¬è´¦</h2><p>æˆ‘ä»¬æ›¾ç»åœ¨<a href=\"https://time.geekbang.org/column/article/85001\">ã€Š05 | ä¸€ä¸å°å¿ƒå°±æ­»é”äº†ï¼Œæ€ä¹ˆåŠï¼Ÿã€‹</a>è¿™ç¯‡æ–‡ç« ä¸­ï¼Œè®²åˆ°äº†å¹¶å‘è½¬è´¦çš„ä¾‹å­ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚ç®€å•åœ°ä½¿ç”¨ synchronized å°† transfer() æ–¹æ³•å˜æˆåŒæ­¥æ–¹æ³•å¹¶ä¸èƒ½è§£å†³å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºè¿˜å­˜åœ¨æ­»é”é—®é¢˜ã€‚</p><!-- [[[read_end]]] --><pre><code>class UnsafeAccount {\n  //ä½™é¢\n  private long balance;\n  //æ„é€ å‡½æ•°\n  public UnsafeAccount(long balance) {\n    this.balance = balance;\n  }\n  //è½¬è´¦\n  void transfer(UnsafeAccount target, long amt){\n    if (this.balance &gt; amt) {\n      this.balance -= amt;\n      target.balance += amt;\n    }\n  }\n}\n</code></pre><p>è¯¥è½¬è´¦æ“ä½œè‹¥ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å°±ä¼šéå¸¸ç®€å•ï¼Œå¦‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ‰€ç¤ºã€‚å¦‚æœæ‰€æœ‰SQLéƒ½æ­£å¸¸æ‰§è¡Œï¼Œåˆ™é€šè¿‡ commit() æ–¹æ³•æäº¤äº‹åŠ¡ï¼›å¦‚æœSQLåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰å¼‚å¸¸ï¼Œåˆ™é€šè¿‡ rollback() æ–¹æ³•å›æ»šäº‹åŠ¡ã€‚æ•°æ®åº“ä¿è¯åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸ä¼šæœ‰æ­»é”ï¼Œè€Œä¸”è¿˜èƒ½ä¿è¯å‰é¢æˆ‘ä»¬è¯´çš„åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ï¼Œä¹Ÿå°±æ˜¯ACIDã€‚</p><pre><code>Connection conn = null;\ntry{\n  //è·å–æ•°æ®åº“è¿æ¥\n  conn = DriverManager.getConnection();\n  //è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡\n  conn.setAutoCommit(false);\n  //æ‰§è¡Œè½¬è´¦SQL\n  ......\n  //æäº¤äº‹åŠ¡\n  conn.commit();\n} catch (Exception e) {\n  //å‡ºç°å¼‚å¸¸å›æ»šäº‹åŠ¡\n  conn.rollback();\n}\n</code></pre><p>é‚£å¦‚æœç”¨STMåˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼ŸJavaè¯­è¨€å¹¶ä¸æ”¯æŒSTMï¼Œä¸è¿‡å¯ä»¥å€ŸåŠ©ç¬¬ä¸‰æ–¹çš„ç±»åº“æ¥æ”¯æŒï¼Œ<a href=\"https://github.com/pveentjer/Multiverse\">Multiverse</a>å°±æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç å°±æ˜¯å€ŸåŠ©Multiverseå®ç°äº†çº¿ç¨‹å®‰å…¨çš„è½¬è´¦æ“ä½œï¼Œç›¸æ¯”è¾ƒä¸Šé¢çº¿ç¨‹ä¸å®‰å…¨çš„UnsafeAccountï¼Œå…¶æ”¹åŠ¨å¹¶ä¸å¤§ï¼Œä»…ä»…æ˜¯å°†ä½™é¢çš„ç±»å‹ä» long å˜æˆäº† TxnLong ï¼Œå°†è½¬è´¦çš„æ“ä½œæ”¾åˆ°äº† atomic(()-&gt;{}) ä¸­ã€‚</p><pre><code>class Account{\n  //ä½™é¢\n  private TxnLong balance;\n  //æ„é€ å‡½æ•°\n  public Account(long balance){\n    this.balance = StmUtils.newTxnLong(balance);\n  }\n  //è½¬è´¦\n  public void transfer(Account to, int amt){\n    //åŸå­åŒ–æ“ä½œ\n    atomic(()-&gt;{\n      if (this.balance.get() &gt; amt) {\n        this.balance.decrement(amt);\n        to.balance.increment(amt);\n      }\n    });\n  }\n}\n</code></pre><p>ä¸€ä¸ªå…³é”®çš„atomic()æ–¹æ³•å°±æŠŠå¹¶å‘é—®é¢˜è§£å†³äº†ï¼Œè¿™ä¸ªæ–¹æ¡ˆçœ‹ä¸Šå»æ¯”ä¼ ç»Ÿçš„æ–¹æ¡ˆçš„ç¡®ç®€å•äº†å¾ˆå¤šï¼Œé‚£å®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ•°æ®åº“äº‹åŠ¡å‘å±•äº†å‡ åå¹´äº†ï¼Œç›®å‰è¢«å¹¿æ³›ä½¿ç”¨çš„æ˜¯<strong>MVCC</strong>ï¼ˆå…¨ç§°æ˜¯Multi-Version Concurrency Controlï¼‰ï¼Œä¹Ÿå°±æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚</p><p>MVCCå¯ä»¥ç®€å•åœ°ç†è§£ä¸ºæ•°æ®åº“äº‹åŠ¡åœ¨å¼€å¯çš„æ—¶å€™ï¼Œä¼šç»™æ•°æ®åº“æ‰“ä¸€ä¸ªå¿«ç…§ï¼Œä»¥åæ‰€æœ‰çš„è¯»å†™éƒ½æ˜¯åŸºäºè¿™ä¸ªå¿«ç…§çš„ã€‚å½“æäº¤äº‹åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœæ‰€æœ‰è¯»å†™è¿‡çš„æ•°æ®åœ¨è¯¥äº‹åŠ¡æ‰§è¡ŒæœŸé—´æ²¡æœ‰å‘ç”Ÿè¿‡å˜åŒ–ï¼Œé‚£ä¹ˆå°±å¯ä»¥æäº¤ï¼›å¦‚æœå‘ç”Ÿäº†å˜åŒ–ï¼Œè¯´æ˜è¯¥äº‹åŠ¡å’Œæœ‰å…¶ä»–äº‹åŠ¡è¯»å†™çš„æ•°æ®å†²çªäº†ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯ä¸å¯ä»¥æäº¤çš„ã€‚</p><p>ä¸ºäº†è®°å½•æ•°æ®æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯ä»¥ç»™æ¯æ¡æ•°æ®å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œè¿™æ ·æ¯æ¬¡æˆåŠŸä¿®æ”¹æ•°æ®éƒ½ä¼šå¢åŠ ç‰ˆæœ¬å·çš„å€¼ã€‚MVCCçš„å·¥ä½œåŸç†å’Œæˆ‘ä»¬æ›¾ç»åœ¨<a href=\"https://time.geekbang.org/column/article/89456\">ã€Š18 | StampedLockï¼šæœ‰æ²¡æœ‰æ¯”è¯»å†™é”æ›´å¿«çš„é”ï¼Ÿã€‹</a>ä¸­æåˆ°çš„ä¹è§‚é”éå¸¸ç›¸ä¼¼ã€‚æœ‰ä¸å°‘STMçš„å®ç°æ–¹æ¡ˆéƒ½æ˜¯åŸºäºMVCCçš„ï¼Œä¾‹å¦‚çŸ¥åçš„Clojure STMã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±ç”¨æœ€ç®€å•çš„ä»£ç åŸºäºMVCCå®ç°ä¸€ä¸ªç®€ç‰ˆçš„STMï¼Œè¿™æ ·ä½ ä¼šå¯¹STMä»¥åŠMVCCçš„å·¥ä½œåŸç†æœ‰æ›´æ·±å…¥çš„è®¤è¯†ã€‚</p><h2>è‡ªå·±å®ç°STM</h2><p>æˆ‘ä»¬é¦–å…ˆè¦åšçš„ï¼Œå°±æ˜¯è®©Javaä¸­çš„å¯¹è±¡æœ‰ç‰ˆæœ¬å·ï¼Œåœ¨ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼ŒVersionedRefè¿™ä¸ªç±»çš„ä½œç”¨å°±æ˜¯å°†å¯¹è±¡valueåŒ…è£…æˆå¸¦ç‰ˆæœ¬å·çš„å¯¹è±¡ã€‚æŒ‰ç…§MVCCç†è®ºï¼Œæ•°æ®çš„æ¯ä¸€æ¬¡ä¿®æ”¹éƒ½å¯¹åº”ç€ä¸€ä¸ªå”¯ä¸€çš„ç‰ˆæœ¬å·ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ä»…ä»…æ”¹å˜valueæˆ–è€…versionçš„æƒ…å†µï¼Œç”¨ä¸å˜æ€§æ¨¡å¼å°±å¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥VersionedRefè¿™ä¸ªç±»è¢«æˆ‘ä»¬è®¾è®¡æˆäº†ä¸å¯å˜çš„ã€‚</p><p>æ‰€æœ‰å¯¹æ•°æ®çš„è¯»å†™æ“ä½œï¼Œä¸€å®šæ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œé¢ï¼ŒTxnRefè¿™ä¸ªç±»è´Ÿè´£å®Œæˆäº‹åŠ¡å†…çš„è¯»å†™æ“ä½œï¼Œè¯»å†™æ“ä½œå§”æ‰˜ç»™äº†æ¥å£Txnï¼ŒTxnä»£è¡¨çš„æ˜¯è¯»å†™æ“ä½œæ‰€åœ¨çš„å½“å‰äº‹åŠ¡ï¼Œ å†…éƒ¨æŒæœ‰çš„curRefä»£è¡¨çš„æ˜¯ç³»ç»Ÿä¸­çš„æœ€æ–°å€¼ã€‚</p><pre><code>//å¸¦ç‰ˆæœ¬å·çš„å¯¹è±¡å¼•ç”¨\npublic final class VersionedRef&lt;T&gt; {\n  final T value;\n  final long version;\n  //æ„é€ æ–¹æ³•\n  public VersionedRef(T value, long version) {\n    this.value = value;\n    this.version = version;\n  }\n}\n//æ”¯æŒäº‹åŠ¡çš„å¼•ç”¨\npublic class TxnRef&lt;T&gt; {\n  //å½“å‰æ•°æ®ï¼Œå¸¦ç‰ˆæœ¬å·\n  volatile VersionedRef curRef;\n  //æ„é€ æ–¹æ³•\n  public TxnRef(T value) {\n    this.curRef = new VersionedRef(value, 0L);\n  }\n  //è·å–å½“å‰äº‹åŠ¡ä¸­çš„æ•°æ®\n  public T getValue(Txn txn) {\n    return txn.get(this);\n  }\n  //åœ¨å½“å‰äº‹åŠ¡ä¸­è®¾ç½®æ•°æ®\n  public void setValue(T value, Txn txn) {\n    txn.set(this, value);\n  }\n}\n</code></pre><p>STMTxnæ˜¯Txnæœ€å…³é”®çš„ä¸€ä¸ªå®ç°ç±»ï¼Œäº‹åŠ¡å†…å¯¹äºæ•°æ®çš„è¯»å†™ï¼Œéƒ½æ˜¯é€šè¿‡å®ƒæ¥å®Œæˆçš„ã€‚STMTxnå†…éƒ¨æœ‰ä¸¤ä¸ªMapï¼šinTxnMapï¼Œç”¨äºä¿å­˜å½“å‰äº‹åŠ¡ä¸­æ‰€æœ‰è¯»å†™çš„æ•°æ®çš„å¿«ç…§ï¼›writeMapï¼Œç”¨äºä¿å­˜å½“å‰äº‹åŠ¡éœ€è¦å†™å…¥çš„æ•°æ®ã€‚æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡ID txnIdï¼Œè¿™ä¸ªtxnIdæ˜¯å…¨å±€é€’å¢çš„ã€‚</p><p>STMTxnæœ‰ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯è¯»æ•°æ®çš„get()æ–¹æ³•ã€å†™æ•°æ®çš„set()æ–¹æ³•å’Œæäº¤äº‹åŠ¡çš„commit()æ–¹æ³•ã€‚å…¶ä¸­ï¼Œget()æ–¹æ³•å°†è¦è¯»å–æ•°æ®ä½œä¸ºå¿«ç…§æ”¾å…¥inTxnMapï¼ŒåŒæ—¶ä¿è¯æ¯æ¬¡è¯»å–çš„æ•°æ®éƒ½æ˜¯ä¸€ä¸ªç‰ˆæœ¬ã€‚set()æ–¹æ³•ä¼šå°†è¦å†™å…¥çš„æ•°æ®æ”¾å…¥writeMapï¼Œä½†å¦‚æœå†™å…¥çš„æ•°æ®æ²¡è¢«è¯»å–è¿‡ï¼Œä¹Ÿä¼šå°†å…¶æ”¾å…¥ inTxnMapã€‚</p><p>è‡³äºcommit()æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸ºäº†ç®€åŒ–å®ç°ï¼Œä½¿ç”¨äº†äº’æ–¥é”ï¼Œæ‰€ä»¥äº‹åŠ¡çš„æäº¤æ˜¯ä¸²è¡Œçš„ã€‚commit()æ–¹æ³•çš„å®ç°å¾ˆç®€å•ï¼Œé¦–å…ˆæ£€æŸ¥inTxnMapä¸­çš„æ•°æ®æ˜¯å¦å‘ç”Ÿè¿‡å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå°±å°†writeMapä¸­çš„æ•°æ®å†™å…¥ï¼ˆè¿™é‡Œçš„å†™å…¥å…¶å®å°±æ˜¯TxnRefå†…éƒ¨æŒæœ‰çš„curRefï¼‰ï¼›å¦‚æœå‘ç”Ÿè¿‡å˜åŒ–ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å°†writeMapä¸­çš„æ•°æ®å†™å…¥äº†ã€‚</p><pre><code>//äº‹åŠ¡æ¥å£\npublic interface Txn {\n  &lt;T&gt; T get(TxnRef&lt;T&gt; ref);\n  &lt;T&gt; void set(TxnRef&lt;T&gt; ref, T value);\n}\n//STMäº‹åŠ¡å®ç°ç±»\npublic final class STMTxn implements Txn {\n  //äº‹åŠ¡IDç”Ÿæˆå™¨\n  private static AtomicLong txnSeq = new AtomicLong(0);\n  \n  //å½“å‰äº‹åŠ¡æ‰€æœ‰çš„ç›¸å…³æ•°æ®\n  private Map&lt;TxnRef, VersionedRef&gt; inTxnMap = new HashMap&lt;&gt;();\n  //å½“å‰äº‹åŠ¡æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„æ•°æ®\n  private Map&lt;TxnRef, Object&gt; writeMap = new HashMap&lt;&gt;();\n  //å½“å‰äº‹åŠ¡ID\n  private long txnId;\n  //æ„é€ å‡½æ•°ï¼Œè‡ªåŠ¨ç”Ÿæˆå½“å‰äº‹åŠ¡ID\n  STMTxn() {\n    txnId = txnSeq.incrementAndGet();\n  }\n\n  //è·å–å½“å‰äº‹åŠ¡ä¸­çš„æ•°æ®\n  @Override\n  public &lt;T&gt; T get(TxnRef&lt;T&gt; ref) {\n    //å°†éœ€è¦è¯»å–çš„æ•°æ®ï¼ŒåŠ å…¥inTxnMap\n    if (!inTxnMap.containsKey(ref)) {\n      inTxnMap.put(ref, ref.curRef);\n    }\n    return (T) inTxnMap.get(ref).value;\n  }\n  //åœ¨å½“å‰äº‹åŠ¡ä¸­ä¿®æ”¹æ•°æ®\n  @Override\n  public &lt;T&gt; void set(TxnRef&lt;T&gt; ref, T value) {\n    //å°†éœ€è¦ä¿®æ”¹çš„æ•°æ®ï¼ŒåŠ å…¥inTxnMap\n    if (!inTxnMap.containsKey(ref)) {\n      inTxnMap.put(ref, ref.curRef);\n    }\n    writeMap.put(ref, value);\n  }\n  //æäº¤äº‹åŠ¡\n  boolean commit() {\n    synchronized (STM.commitLock) {\n    //æ˜¯å¦æ ¡éªŒé€šè¿‡\n    boolean isValid = true;\n    //æ ¡éªŒæ‰€æœ‰è¯»è¿‡çš„æ•°æ®æ˜¯å¦å‘ç”Ÿè¿‡å˜åŒ–\n    for(Map.Entry&lt;TxnRef, VersionedRef&gt; entry : inTxnMap.entrySet()){\n      VersionedRef curRef = entry.getKey().curRef;\n      VersionedRef readRef = entry.getValue();\n      //é€šè¿‡ç‰ˆæœ¬å·æ¥éªŒè¯æ•°æ®æ˜¯å¦å‘ç”Ÿè¿‡å˜åŒ–\n      if (curRef.version != readRef.version) {\n        isValid = false;\n        break;\n      }\n    }\n    //å¦‚æœæ ¡éªŒé€šè¿‡ï¼Œåˆ™æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆ\n    if (isValid) {\n      writeMap.forEach((k, v) -&gt; {\n        k.curRef = new VersionedRef(v, txnId);\n      });\n    }\n    return isValid;\n  }\n}\n</code></pre><p>ä¸‹é¢æˆ‘ä»¬æ¥æ¨¡æ‹Ÿå®ç°Multiverseä¸­çš„åŸå­åŒ–æ“ä½œatomic()ã€‚atomic()æ–¹æ³•ä¸­ä½¿ç”¨äº†ç±»ä¼¼äºCASçš„æ“ä½œï¼Œå¦‚æœäº‹åŠ¡æäº¤å¤±è´¥ï¼Œé‚£ä¹ˆå°±é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œé‡æ–°æ‰§è¡Œã€‚</p><pre><code>@FunctionalInterface\npublic interface TxnRunnable {\n  void run(Txn txn);\n}\n//STM\npublic final class STM {\n  //ç§æœ‰åŒ–æ„é€ æ–¹æ³•\n  private STM() {\n  //æäº¤æ•°æ®éœ€è¦ç”¨åˆ°çš„å…¨å±€é”  \n  static final Object commitLock = new Object();\n  //åŸå­åŒ–æäº¤æ–¹æ³•\n  public static void atomic(TxnRunnable action) {\n    boolean committed = false;\n    //å¦‚æœæ²¡æœ‰æäº¤æˆåŠŸï¼Œåˆ™ä¸€ç›´é‡è¯•\n    while (!committed) {\n      //åˆ›å»ºæ–°çš„äº‹åŠ¡\n      STMTxn txn = new STMTxn();\n      //æ‰§è¡Œä¸šåŠ¡é€»è¾‘\n      action.run(txn);\n      //æäº¤äº‹åŠ¡\n      committed = txn.commit();\n    }\n  }\n}}\n</code></pre><p>å°±è¿™æ ·ï¼Œæˆ‘ä»¬è‡ªå·±å®ç°äº†STMï¼Œå¹¶å®Œæˆäº†çº¿ç¨‹å®‰å…¨çš„è½¬è´¦æ“ä½œï¼Œä½¿ç”¨æ–¹æ³•å’ŒMultiverseå·®ä¸å¤šï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹é¢æ‰€ç¤ºã€‚</p><pre><code>class Account {\n  //ä½™é¢\n  private TxnRef&lt;Integer&gt; balance;\n  //æ„é€ æ–¹æ³•\n  public Account(int balance) {\n    this.balance = new TxnRef&lt;Integer&gt;(balance);\n  }\n  //è½¬è´¦æ“ä½œ\n  public void transfer(Account target, int amt){\n    STM.atomic((txn)-&gt;{\n      Integer from = balance.getValue(txn);\n      balance.setValue(from-amt, txn);\n      Integer to = target.balance.getValue(txn);\n      target.balance.setValue(to+amt, txn);\n    });\n  }\n}\n</code></pre><h2>æ€»ç»“</h2><p>STMå€Ÿé‰´çš„æ˜¯æ•°æ®åº“çš„ç»éªŒï¼Œæ•°æ®åº“è™½ç„¶å¤æ‚ï¼Œä½†ä»…ä»…å­˜å‚¨æ•°æ®ï¼Œè€Œç¼–ç¨‹è¯­è¨€é™¤äº†æœ‰å…±äº«å˜é‡ä¹‹å¤–ï¼Œè¿˜ä¼šæ‰§è¡Œå„ç§I/Oæ“ä½œï¼Œå¾ˆæ˜¾ç„¶I/Oæ“ä½œæ˜¯å¾ˆéš¾æ”¯æŒå›æ»šçš„ã€‚æ‰€ä»¥ï¼ŒSTMä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ã€‚ç›®å‰æ”¯æŒSTMçš„ç¼–ç¨‹è¯­è¨€ä¸»è¦æ˜¯å‡½æ•°å¼è¯­è¨€ï¼Œå‡½æ•°å¼è¯­è¨€é‡Œçš„æ•°æ®å¤©ç”Ÿå…·å¤‡ä¸å¯å˜æ€§ï¼Œåˆ©ç”¨è¿™ç§ä¸å¯å˜æ€§å®ç°STMç›¸å¯¹æ¥è¯´æ›´ç®€å•ã€‚</p><p>å¦å¤–ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ–‡ä¸­çš„â€œè‡ªå·±å®ç°STMâ€éƒ¨åˆ†æˆ‘å‚è€ƒäº†<a href=\"http://www.codecommit.com/blog/scala/software-transactional-memory-in-scala\">Software Transactional Memory in Scala</a>è¿™ç¯‡åšæ–‡ä»¥åŠ<a href=\"https://github.com/epam-mooc/stm-java\">ä¸€ä¸ªGitHubé¡¹ç›®</a>ï¼Œç›®å‰è¿˜å¾ˆç²—ç³™ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå®Œå¤‡çš„MVCCã€‚å¦‚æœä½ å¯¹è¿™æ–¹é¢æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒ<a href=\"http://www.codecommit.com/blog/scala/improving-the-stm-multi-version-concurrency-control\">Improving the STM: Multi-Version Concurrency Control</a> è¿™ç¯‡åšæ–‡ï¼Œé‡Œé¢è®²åˆ°äº†å¦‚ä½•ä¼˜åŒ–ï¼Œä½ å¯ä»¥å°è¯•å­¦ä¹ ä¸‹ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p></p>","comments":[{"had_liked":false,"id":106484,"user_name":"M$ç”»åƒ","can_delete":false,"product_type":"c1","uid":1027781,"ip_address":"","ucode":"B7298F0CC7ADC8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ae/c5/09c2dd48.jpg","comment_is_top":false,"comment_ctime":1561334431,"is_pvip":true,"replies":[{"id":"38532","content":"æ„Ÿè°¢æ§åœºğŸ˜„","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1561347184,"ip_address":"","comment_id":106484,"utype":1}],"discussion_count":1,"race_medal":0,"score":"96050614943","product_id":100023901,"comment_content":"å¸Œæœ›ç‹è€å¸ˆå†å‡ºæ–°å“ï¼Œä¸€å®šæ”¯æŒã€‚","like_count":22,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455109,"discussion_content":"æ„Ÿè°¢æ§åœºğŸ˜„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561347184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131455,"user_name":"å°æ–‡åŒå­¦","can_delete":false,"product_type":"c1","uid":1001893,"ip_address":"","ucode":"48F2AEB989C12A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg","comment_is_top":false,"comment_ctime":1567757377,"is_pvip":false,"replies":[{"id":"49885","content":"ğŸ‘æœŸå¾…ä½ çš„æˆæœï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1567775232,"ip_address":"","comment_id":131455,"utype":1}],"discussion_count":9,"race_medal":0,"score":"87467103297","product_id":100023901,"comment_content":"è°¢è°¢è€å¸ˆæ¨èSTMï¼Œæˆ‘æ‰€åœ¨çš„æ¸¸æˆé¡¹ç›®ä¸€ç›´æœ‰å¯¹è±¡å¼‚æ­¥å…¥åº“çš„éœ€æ±‚ï¼Œä¸ºäº†ä½¿ç”¨å¼‚æ­¥å…¥åº“ï¼Œæ”¾å¼ƒäº†Springé’ˆå¯¹æ•°æ®åº“çš„äº‹åŠ¡ã€‚ä¸ºæ­¤ä¸å¾—ä¸ç¼–å†™å¤§é‡ä»£ç å»åˆ¤æ–­æŸä¸ªæ“ä½œæ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œå¸Œæœ›è½¯ä»¶äº‹åŠ¡å†…å­˜å¯ä»¥ä¸ºæˆ‘çš„éœ€æ±‚æä¾›ä¸€ä¸ªæ–°çš„è§£å†³æ–¹æ¡ˆã€‚æœ€è¿‘å‡ å¤©å¼€å§‹ç ”ç©¶ç›¸å…³æºç äº†ï¼Œå¸Œæœ›å¯ä»¥è¾ƒå¥½çš„ç»“åˆç°æœ‰é¡¹ç›®ï¼Œæœ‰å¯ä»¥å‘å¸ƒçš„æˆæœä¸€å®šåœ¨ç•™è¨€åŒºä¸ºå¤§å®¶å…±äº«ã€‚","like_count":20,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466463,"discussion_content":"ğŸ‘æœŸå¾…ä½ çš„æˆæœï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567775232,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1437425,"avatar":"https://static001.geekbang.org/account/avatar/00/15/ee/f1/16545faf.jpg","nickname":"å­¦ä¹ ","note":"","ucode":"CDFB71E0D1508B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392653,"discussion_content":"è¿™ä¹ˆä¹…äº†ï¼Œæœ‰æˆæœäº†å—","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1631088004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1001893,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg","nickname":"å°æ–‡åŒå­¦","note":"","ucode":"48F2AEB989C12A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591316,"discussion_content":"æ²¡æƒ³åˆ°è¿™ä¹ˆå¤šäººç•™è¨€ã€‚ä¹‹å‰è°ƒç ”ç»“æœæ˜¯ä¸å€¼å¾—åœ¨ç¨‹åºé‡Œé¢å†™ä¸€ä¸ªäº‹åŠ¡ã€‚é¦–å…ˆæ˜¯äº‹åŠ¡è¦ä¸è¦ä½¿ç”¨æ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œäº‹åŠ¡çš„æˆæœ¬å’Œå¤æ‚æ€§å¾ˆé«˜ï¼Œåœ¨æ¸¸æˆä¸šåŠ¡ä¸Šå®ç°æˆæœ¬è¿œå°‘äºæ”¶ç›Šã€‚æ¯”è¾ƒå¥½çš„åšæ³•æ˜¯å…ˆè¯†åˆ«è¦ä¸è¦ç”¨äº‹åŠ¡ï¼Œå…¶æ¬¡æ˜¯èƒ½å¦å¤ç”¨å­˜å‚¨è½¯ä»¶è‡ªå¸¦çš„äº‹åŠ¡ï¼Œæœ€åæ‰æ˜¯è€ƒè™‘è½¯ä»¶äº‹åŠ¡å†…å­˜ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666493686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1477754,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8c/7a/5ee20222.jpg","nickname":"å°æ™¨","note":"","ucode":"C95BC5211A5741","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588588,"discussion_content":"æœ‰ç»“æœäº†å—ï¼Œxd","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663887766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ±Ÿè‹"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2879313,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/ef/51/791d0f5e.jpg","nickname":"å¤§å“¥","note":"","ucode":"720020E5259EB2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581636,"discussion_content":"æœ‰ç»“æœäº†å—ï¼Œxd","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658901285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1111057,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f4/11/464c75aa.jpg","nickname":"dtsola","note":"","ucode":"A4353EE0F9EB92","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":580367,"discussion_content":"æœ‰ç»“æœäº†å—ï¼Œxd","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658128190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2226367,"avatar":"https://static001.geekbang.org/account/avatar/00/21/f8/bf/59f2e600.jpg","nickname":"æœˆæ˜é£æ¸…","note":"","ucode":"65A97CF2E320FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575788,"discussion_content":"æœ‰ç»“æœäº†å—ï¼Œxd","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655107910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1441569,"avatar":"https://static001.geekbang.org/account/avatar/00/15/ff/21/8815d2e5.jpg","nickname":"äº®å­","note":"","ucode":"DF37D5E0714D02","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549962,"discussion_content":"æœ‰ç»“æœäº†å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644312186,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1653218,"avatar":"https://static001.geekbang.org/account/avatar/00/19/39/e2/633f8b70.jpg","nickname":"æ’æ˜Ÿ","note":"","ucode":"F6902B0291FCFC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544265,"discussion_content":"æœ‰ç»“æœäº†å—ï¼Œxd","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641453201,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101299,"user_name":"æˆ‘çš„è…¿è…¿","can_delete":false,"product_type":"c1","uid":1239277,"ip_address":"","ucode":"2AAA36A7C3AD75","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/ed/f9347e5e.jpg","comment_is_top":false,"comment_ctime":1559780001,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"48804420257","product_id":100023901,"comment_content":"æˆ‘å…¬å¸ç”¨çš„å°±æ˜¯è¿™ä¸ªè§£å†³å¹¶å‘é—®é¢˜çš„ï¼Œæ‰çŸ¥é“æ˜¯è¿™ç§æŠ€æœ¯","like_count":11,"discussions":[{"author":{"id":2055809,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/5e/81/82709d6e.jpg","nickname":"ç å°å‘†","note":"","ucode":"44532D6ABF9340","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":578745,"discussion_content":"è¯·çº¤ç»†è¯´æ˜ä¸€ä¸‹ï¼Œè°¢è°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656992636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1512642,"avatar":"https://static001.geekbang.org/account/avatar/00/17/14/c2/46ebe3a0.jpg","nickname":"ä¾§è€³å€¾å¬","note":"","ucode":"5BF2A2440B54F0","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":244535,"discussion_content":"è¯·ç»§ç»­ä½ çš„è¡¨æ¼”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587609119,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1053955,"avatar":"https://static001.geekbang.org/account/avatar/00/10/15/03/c0fe1dbf.jpg","nickname":"è€ƒä¼‘","note":"","ucode":"968DFC00D6D0CF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":45915,"discussion_content":"è¯·é—®æ˜¯ä»€ä¹ˆå‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573099042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1360712,"avatar":"https://static001.geekbang.org/account/avatar/00/14/c3/48/3a739da6.jpg","nickname":"å¤©è‰äºŒåå…­","note":"","ucode":"3165EE3007527B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":37588,"discussion_content":"è¯·é—®è§£å†³äº†ä»€ä¹ˆä¸šåŠ¡é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571641899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":232987,"user_name":"å°å¤ªé˜³","can_delete":false,"product_type":"c1","uid":1477324,"ip_address":"","ucode":"3B1C90425E485D","user_header":"https://static001.geekbang.org/account/avatar/00/16/8a/cc/da9adc82.jpg","comment_is_top":false,"comment_ctime":1594182872,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"40248888536","product_id":100023901,"comment_content":"çœ‹äº†ä¸‰éï¼Œç»ˆäºçœ‹æ‡‚äº†ï¼Œå¾ˆå¦™ã€‚åŸæ¥ç²¾åå°±åœ¨è¿™ä¸€æ®µï¼šMVCC å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºæ•°æ®åº“äº‹åŠ¡åœ¨å¼€å¯çš„æ—¶å€™ï¼Œä¼šç»™æ•°æ®åº“æ‰“ä¸€ä¸ªå¿«ç…§ï¼Œä»¥åæ‰€æœ‰çš„è¯»å†™éƒ½æ˜¯åŸºäºè¿™ä¸ªå¿«ç…§çš„ã€‚å½“æäº¤äº‹åŠ¡çš„æ—¶å€™ï¼Œå¦‚æœæ‰€æœ‰è¯»å†™è¿‡çš„æ•°æ®åœ¨è¯¥äº‹åŠ¡æ‰§è¡ŒæœŸé—´æ²¡æœ‰å‘ç”Ÿè¿‡å˜åŒ–ï¼Œé‚£ä¹ˆå°±å¯ä»¥æäº¤ï¼›å¦‚æœå‘ç”Ÿäº†å˜åŒ–ï¼Œè¯´æ˜è¯¥äº‹åŠ¡å’Œæœ‰å…¶ä»–äº‹åŠ¡è¯»å†™çš„æ•°æ®å†²çªäº†ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯ä¸å¯ä»¥æäº¤çš„ã€‚Txnè´Ÿè´£ç»´æŠ¤æ£€æµ‹å¿«ç…§ï¼ŒTxnRefè´Ÿè´£åŒ…è£…æ•°æ®ä½¿ä¹‹å¯ä»¥æ¥å…¥Txnï¼Œä½œä¸ºå¿«ç…§çš„keyã€‚VersionedRefè´Ÿè´£åŒ…è£…æ•°æ®ä½¿ä¹‹æœ‰ç‰ˆæœ¬ã€‚   å¦å¤–ï¼Œæœ€åçš„ä»£ç é‡Œå¿˜äº†åˆ¤æ–­ä½™é¢æ˜¯å¦å¤Ÿç”¨äº†ã€‚ğŸ˜","like_count":9,"discussions":[{"author":{"id":1226493,"avatar":"https://static001.geekbang.org/account/avatar/00/12/b6/fd/a0f60753.jpg","nickname":"ç‰›ç‰›è‚¥","note":"","ucode":"4F455A76F22BB0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392734,"discussion_content":"æ€»ç»“å¾—å¾ˆåˆ°ä½ï¼Œè°¢è°¢ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631106431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":141650,"user_name":"DFighting","can_delete":false,"product_type":"c1","uid":1233193,"ip_address":"","ucode":"F3BA2426FF8582","user_header":"https://static001.geekbang.org/account/avatar/00/12/d1/29/1b1234ed.jpg","comment_is_top":false,"comment_ctime":1571206928,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"27341010704","product_id":100023901,"comment_content":"STMçš„ä¼˜åŒ–æœ‰ä¸€ç‚¹æ˜¯é’ˆå¯¹å¤§å¿«ç…§çš„ä¼˜åŒ–å§ï¼Œå› ä¸ºMySQLå¯¹æ•°æ®åº“çš„å¿«ç…§å¹¶ä¸æ˜¯çœŸæ­£å­˜å‚¨ä¸€ä»½å¤‡ä»½æ•°æ®ï¼Œç±»ä¼¼ä¾‹å­ä¸­çš„mapï¼Œè€Œæ˜¯åˆ©ç”¨versionå’Œundologè®¡ç®—å¾—åˆ°çš„ï¼Œä¸ç„¶ä¸€ä¸ª100Gå¤§å°çš„æ•°æ®åº“ï¼Œæ¯å¼€å¯ä¸€ä¸ªäº‹ç‰©å°±æ‹·è´ä¸€ä»½æ•°æ®ï¼Œè‚¯å®šæ˜¯ä¸ç°å®çš„ã€‚","like_count":6},{"had_liked":false,"id":135614,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1015754,"ip_address":"","ucode":"00DF2FEC58D2E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","comment_is_top":false,"comment_ctime":1569229020,"is_pvip":false,"replies":[{"id":"53722","content":"ä¸æ˜¯è¿™æ ·çš„ï¼Œä¸åŒçš„STMTxnæŒæœ‰çš„TxnRefæ˜¯å…±äº«çš„ï¼ŒTxnRefå†…éƒ¨æœ‰ç‰ˆæœ¬å·ï¼Œä¸»è¦ä¾èµ–è¿™ä¸ªç‰ˆæœ¬å·æ¥æ£€æµ‹å†²çª","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1570624316,"ip_address":"","comment_id":135614,"utype":1}],"discussion_count":4,"race_medal":0,"score":"27339032796","product_id":100023901,"comment_content":"æŒ‰ç…§è€å¸ˆè‡ªå·±å®ç°çš„STMç¨‹åºï¼Œæ ¹æœ¬ä¸å­˜åœ¨commitæäº¤å¤±è´¥çš„æ—¶å€™å§ï¼Ÿå› ä¸ºæ¯ä¸€æ¬¡çš„commitéƒ½æ˜¯æ–°åˆ›å»ºä¸€ä¸ªSTMTxnï¼Œæ–°åˆ›å»ºSTMTxnåï¼ŒinTxnMapå’ŒwriteMapéƒ½æ˜¯æ–°çš„ã€‚ä¸çŸ¥é“æˆ‘è€ƒè™‘çš„å¯¹ä¸å¯¹ï¼Ÿï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":468272,"discussion_content":"ä¸æ˜¯è¿™æ ·çš„ï¼Œä¸åŒçš„STMTxnæŒæœ‰çš„TxnRefæ˜¯å…±äº«çš„ï¼ŒTxnRefå†…éƒ¨æœ‰ç‰ˆæœ¬å·ï¼Œä¸»è¦ä¾èµ–è¿™ä¸ªç‰ˆæœ¬å·æ¥æ£€æµ‹å†²çª","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1570624316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2226367,"avatar":"https://static001.geekbang.org/account/avatar/00/21/f8/bf/59f2e600.jpg","nickname":"æœˆæ˜é£æ¸…","note":"","ucode":"65A97CF2E320FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575792,"discussion_content":"ä¸åŒçš„STMTxnæŒæœ‰çš„TxnRefæ˜¯å…±äº«çš„ æ–‡ä¸­å¹¶æ²¡æœ‰è¯´æ˜ï¼Œæ–‡ç« ä¸­ä¹Ÿæ²¡æœ‰ä¿®æ”¹ç‰ˆæœ¬å·ç›¸å…³çš„ä»£ç ç¤ºä¾‹å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655108498,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2226367,"avatar":"https://static001.geekbang.org/account/avatar/00/21/f8/bf/59f2e600.jpg","nickname":"æœˆæ˜é£æ¸…","note":"","ucode":"65A97CF2E320FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575790,"discussion_content":"æ–‡ä¸­æ²¡æœ‰æŒ‡æ˜ï¼šä¸åŒçš„STMTxnæŒæœ‰çš„TxnRefæ˜¯å…±äº«çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655108115,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218347,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLvdWoCic6ItzibF8ia8vrUTRuyj6AT3tg5f4QicIK0jTIFheJ6274ZkibuRLFP1NXG3jibv5TiaSKNoJpLw/132","nickname":"Geek_37984c","note":"","ucode":"7A319AE28599B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":272475,"discussion_content":"å½“å‰èµ„æºçš„äº‹åŠ¡ï¼Œå¯ä»¥å¤šä»¥ä¸ªç‰ˆæœ¬","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590315184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125582,"user_name":"æ·»","can_delete":false,"product_type":"c1","uid":1189851,"ip_address":"","ucode":"7D337CB305F524","user_header":"https://static001.geekbang.org/account/avatar/00/12/27/db/c8b35c07.jpg","comment_is_top":false,"comment_ctime":1566206455,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"23041042935","product_id":100023901,"comment_content":"ç…§ç€å®ç°äº†ä¸€éï¼Œç¡®å®å¯ä»¥å·§å¦™ã€‚<br>æˆ‘è§‰å¾—ç±»STMTxnçš„getå‡½æ•°å¯ä»¥æ”¹è¿›ä¸€ä¸‹ï¼šç°åœ¨getè¿”å›çš„å€¼ï¼Œåªæ˜¯æœ€åˆå§‹çš„å€¼ï¼Œå¦‚æœå½“å‰äº‹åŠ¡æ›´æ”¹äº†å€¼ï¼Œç„¶åå†è°ƒç”¨getï¼Œæœ€å¥½å¯ä»¥è¿”å›æœ€æ–°çš„å€¼ï¼›å³å½“å‰äº‹åŠ¡çš„æ›´æ”¹ï¼Œå¯¹è‡ªå·±æ˜¯å¯è§çš„ã€‚<br>```<br>    @Override<br>    public &lt;T&gt; T get(TxnRef&lt;T&gt; ref) {<br>        if (!inTxnMap.containsKey(ref)) {<br>            inTxnMap.put(ref, ref.curRef);<br>        }<br><br>        if (writeMap.containsKey(ref)) {<br>            return (T) writeMap.get(ref);<br>        }<br>        else {<br>            return (T) inTxnMap.get(ref).value;<br>        }<br>    }<br>```","like_count":5,"discussions":[{"author":{"id":1302507,"avatar":"https://static001.geekbang.org/account/avatar/00/13/df/eb/78cfab8a.jpg","nickname":"æ‹å£¶å†²","note":"","ucode":"C83EBBCFD9CECF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576675,"discussion_content":"ç¡®å®æœ‰è¿™ä¸ªé—®é¢˜ï¼Œäº‹ç‰©å†…çš„ä¿®æ”¹å¯¹è‡ªå·±ä¸å¯è§äº†ã€‚å¦‚æœäº‹åŠ¡å†…æœ‰å¤šæ¬¡ä¿®æ”¹ï¼Œå¿«ç…§é‡Œä¹Ÿåªæœ‰ç¬¬ä¸€æ¬¡è¯»å†™çš„æ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655732350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1477324,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8a/cc/da9adc82.jpg","nickname":"å°å¤ªé˜³","note":"","ucode":"3B1C90425E485D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289697,"discussion_content":"è€Œä¸”getæ–¹æ³•åº”è¯¥ä¸»è¦ç®—æ˜¯å¯¹å¿«ç…§çš„è¯»å–ï¼Œåº”è¯¥è·å–çš„æ˜¯ç¨³å®šçš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€æ¬¡äº‹åŠ¡æäº¤åçš„å€¼ã€‚ä¸ªäººç†è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594183941,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1477324,"avatar":"https://static001.geekbang.org/account/avatar/00/16/8a/cc/da9adc82.jpg","nickname":"å°å¤ªé˜³","note":"","ucode":"3B1C90425E485D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289693,"discussion_content":"äº‹ç‰©å¯¹è±¡txnæ˜¯ä¸ä¼šå¤ç”¨çš„ï¼Œå³æäº¤æˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šå†newä¸€ä¸ªtxnï¼Œé‡æ–°è·å–å¿«ç…§ã€‚æ‰€ä»¥ä¸å­˜åœ¨æ‹¿åˆ°è‡ªå·±ä¿®æ”¹åçš„å€¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594183491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":241046,"user_name":"é’èœ","can_delete":false,"product_type":"c1","uid":1391891,"ip_address":"","ucode":"C58A16B027467A","user_header":"https://static001.geekbang.org/account/avatar/00/15/3d/13/275f9698.jpg","comment_is_top":false,"comment_ctime":1597158569,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5892125865","product_id":100023901,"comment_content":"è€å¸ˆï¼Œç†è§£åœ¨æäº¤æ—¶ç‰ˆæœ¬å·éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯0ï¼Œå³ä½¿ä¿®æ”¹äº†ä¹Ÿæ²¡å»ä¿®æ”¹ç‰ˆæœ¬å·å•Šï¼Œæ‰€ä»¥ä¸ç®¡æ€æ ·éƒ½èƒ½æäº¤","like_count":1},{"had_liked":false,"id":101416,"user_name":"QQæ€ª","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1559803842,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5854771138","product_id":100023901,"comment_content":"å“”ï¼Œæ‰“å¡ï¼Œæ¶¨çŸ¥è¯†äº†","like_count":1},{"had_liked":false,"id":101352,"user_name":"é»„æµ·å³°","can_delete":false,"product_type":"c1","uid":1275357,"ip_address":"","ucode":"E9340719BC96B2","user_header":"https://static001.geekbang.org/account/avatar/00/13/75/dd/9ead6e69.jpg","comment_is_top":false,"comment_ctime":1559786603,"is_pvip":false,"replies":[{"id":"36784","content":"åªåˆ›å»ºæ–°çš„ç‰ˆæœ¬ï¼Œæ°¸è¿œä¸ä¼šå»ä¿®æ”¹","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1560128628,"ip_address":"","comment_id":101352,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5854753899","product_id":100023901,"comment_content":"ä»£ç é‡Œç¡¬æ˜¯æ²¡çœ‹åˆ°å“ªé‡Œä¿®æ”¹äº†versionã€‚ã€‚","like_count":1,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452924,"discussion_content":"åªåˆ›å»ºæ–°çš„ç‰ˆæœ¬ï¼Œæ°¸è¿œä¸ä¼šå»ä¿®æ”¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560128628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358164,"user_name":"Geek_aa23b7","can_delete":false,"product_type":"c1","uid":2461872,"ip_address":"æµ™æ±Ÿ","ucode":"DD89F30A04D5CC","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL23Wicb0gO9RIXrRzpettuEYaSHLicA2LgRz3X7Npiagf1R4aB9bmePt1TY006z63ngKzhEONZvOsfw/132","comment_is_top":false,"comment_ctime":1663989114,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663989114","product_id":100023901,"comment_content":"æ„Ÿè§‰è¿™ä¸ªåŸç†å’Œcasæœ‰ç‚¹åƒï¼Œéƒ½æ˜¯å…ˆå°è¯•æ›´æ–°ï¼Œç„¶åçœŸæ­£æ›´æ–°çš„æ—¶å€™æ ¹æ®ç‰ˆæœ¬å·åˆ¤æ–­æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹å˜æ›´è¿‡ï¼Œæ²¡æœ‰å‘ç”Ÿå˜æ›´è¿‡ï¼Œåˆ™æ›´æ–°æˆåŠŸã€‚æ ¸å¿ƒè¦ç‚¹å°±åœ¨äºæ­£çœŸæ›´æ–°çš„æ—¶å€™è¦åŠ é”æˆ–è€…åŸå­æ“ä½œ","like_count":0},{"had_liked":false,"id":341955,"user_name":"Geek_d1026b","can_delete":false,"product_type":"c1","uid":2602705,"ip_address":"","ucode":"EC5A17A4CB24C8","user_header":"","comment_is_top":false,"comment_ctime":1649930371,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649930371","product_id":100023901,"comment_content":"è€å¸ˆ å®Œæ•´çš„ä»£ç åœ¨å“ªé‡Œå¯ä»¥ä¸‹è½½","like_count":0},{"had_liked":false,"id":333111,"user_name":"Geek_039a5c","can_delete":false,"product_type":"c1","uid":1651848,"ip_address":"","ucode":"08F4FA864D4B65","user_header":"","comment_is_top":false,"comment_ctime":1644075670,"is_pvip":true,"replies":[{"id":"121724","content":"æ”¶åˆ°ï¼Œè°¢è°¢åé¦ˆï¼Œæˆ‘å’Œè€å¸ˆç¡®è®¤ä¸‹","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":"1059377","ctime":1644103693,"ip_address":"","comment_id":333111,"utype":2}],"discussion_count":1,"race_medal":0,"score":"1644075670","product_id":100023901,"comment_content":"ä»£ç è¿˜æœ‰æœ‰ç‚¹å°é—®é¢˜ã€‚ STM  è¿™ä¸ªç±»çš„ä»£ç  èŠ±æ‹¬å·å†™çš„ä¸å¯¹ã€‚ ","like_count":0,"discussions":[{"author":{"id":1059377,"avatar":"https://static001.geekbang.org/account/avatar/00/10/2a/31/9edbf8a6.jpg","nickname":"è´¾é™","note":"","ucode":"081E70CC01F6B8","race_medal":0,"user_type":8,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549575,"discussion_content":"æ”¶åˆ°ï¼Œè°¢è°¢åé¦ˆï¼Œæˆ‘å’Œè€å¸ˆç¡®è®¤ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644103693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329994,"user_name":"å°é»„é¸­","can_delete":false,"product_type":"c1","uid":2708370,"ip_address":"","ucode":"2800E3A723AEBD","user_header":"https://static001.geekbang.org/account/avatar/00/29/53/92/21c78176.jpg","comment_is_top":false,"comment_ctime":1641716946,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641716946","product_id":100023901,"comment_content":"æˆ‘ç»ˆäºç»ˆäºçœ‹æ‡‚äº†ï¼Œè€å¸ˆå¤ªå‰å®³äº†ï¼ï¼","like_count":0},{"had_liked":false,"id":317575,"user_name":"Tomy","can_delete":false,"product_type":"c1","uid":1192601,"ip_address":"","ucode":"D7E49E90B0D60F","user_header":"https://static001.geekbang.org/account/avatar/00/12/32/99/91b58bf7.jpg","comment_is_top":false,"comment_ctime":1634864563,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1634864563","product_id":100023901,"comment_content":"ç”¨@Trasactionä¸å¯ä»¥å—ï¼Œæˆ‘ä»¬çš„é¡¹ç›®éƒ½æ˜¯ç”¨è¿™ä¸ªçš„","like_count":0,"discussions":[{"author":{"id":1758825,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/d6/69/f59d4f6f.jpg","nickname":"Ryan","note":"","ucode":"387955FD53E98C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553536,"discussion_content":"Springçš„@Transactionå¤„ç†çš„æ˜¯æ•°æ®åº“çš„äº‹åŠ¡ï¼Œè€ŒSTMæ˜¯å†…å­˜äº‹åŠ¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645955877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306440,"user_name":"dominiczhu","can_delete":false,"product_type":"c1","uid":2070984,"ip_address":"","ucode":"9C87F77CCE06C8","user_header":"","comment_is_top":false,"comment_ctime":1628563059,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1628563059","product_id":100023901,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘æƒ³è¯·é—®ä¸€ä¸‹ï¼Œçœ‹äº†ä¹‹å‰çš„è½¬è´¦å®ç°ä¸è¿™ä¸ªtxnè½¬è´¦å®ç°ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿä¼šå­˜åœ¨ç€ä¹‹å‰æåˆ°çš„é—®é¢˜ï¼Œä¾‹å¦‚å…¨éƒ¨çº¿ç¨‹éƒ½å…±äº«äº†åŒä¸€æŠŠé”ï¼Œé«˜å¹¶å‘å¯èƒ½æ‰›ä¸ä½ï¼›while()å¾ªç¯ä¹Ÿå¯èƒ½å¯¼è‡´é«˜cpuæ¶ˆè€—ä¹‹ç±»çš„ã€‚","like_count":0},{"had_liked":false,"id":272213,"user_name":"æˆ‘å¾—å„¿æ„çš„ç¬‘","can_delete":false,"product_type":"c1","uid":1116344,"ip_address":"","ucode":"752E66C6AA96E2","user_header":"https://static001.geekbang.org/account/avatar/00/11/08/b8/ac8a778e.jpg","comment_is_top":false,"comment_ctime":1609991398,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609991398","product_id":100023901,"comment_content":"<br>&#47;&#47;æ„é€ å‡½æ•°ï¼Œè‡ªåŠ¨ç”Ÿæˆå½“å‰äº‹åŠ¡ID  STMTxn() {    txnId = txnSeq.incrementAndGet();  }<br>    StmTxn() {<br>        this.txnId = StmTxn.txnSeq.incrementAndGet();<br>    }","like_count":0},{"had_liked":false,"id":232516,"user_name":"Geek_41d472","can_delete":false,"product_type":"c1","uid":1247965,"ip_address":"","ucode":"DEC2B6329460CF","user_header":"https://static001.geekbang.org/account/avatar/00/13/0a/dd/88fa7b52.jpg","comment_is_top":false,"comment_ctime":1594026003,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1594026003","product_id":100023901,"comment_content":"æœ‰æ²¡æœ‰å’Œæˆ‘ä¸€æ ·æ‡µé€¼çš„,ç‰ˆæœ¬å·æ€ä¹ˆçœ‹,æ‰€æœ‰çš„çš„ç‰ˆæœ¬å·éƒ½æ˜¯0å•Š,æ˜¯æˆ‘çœ¼èŠ±äº†å—","like_count":0,"discussions":[{"author":{"id":1440912,"avatar":"https://static001.geekbang.org/account/avatar/00/15/fc/90/c9df0459.jpg","nickname":"ack","note":"","ucode":"69CA1233EEA8E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":307061,"discussion_content":"åœ¨commit()ä¸­ ï¼š if (isValid) {\n                writeMap.forEach((k, v) -> {\n                    k.curRef = new VersionedRef(v, txnId);//æ­¤å¤„æäº¤äº†curRef ä¸­ç‰ˆæœ¬å·å°±ä¼šæ”¹å˜ï¼Œé‚£å¯¹åº”mapé‡Œé¢å­˜å‚¨çš„å¼•ç”¨å°±èƒ½çœ‹åˆ°ç‰ˆæœ¬å˜äº†\n                });\n            }","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600484598,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":225866,"user_name":"çŸ³å¤´æ±¤","can_delete":false,"product_type":"c1","uid":1022282,"ip_address":"","ucode":"45E4578E54F585","user_header":"https://static001.geekbang.org/account/avatar/00/0f/99/4a/bdf26d5c.jpg","comment_is_top":false,"comment_ctime":1591877500,"is_pvip":false,"replies":[{"id":"83304","content":"å¦‚æœæœ‰å†²çªï¼Œå†™æ“ä½œä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿè„æ•°æ®","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1591971693,"ip_address":"","comment_id":225866,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1591877500","product_id":100023901,"comment_content":"æ˜¯ä¸æ˜¯ STM.atomic çš„ TxnRunnable çš„å®ç°å¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼Œå¦åˆ™ while å¾ªç¯é‚£é‡Œä¼šäº§ç”Ÿè„æ•°æ®ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498022,"discussion_content":"å¦‚æœæœ‰å†²çªï¼Œå†™æ“ä½œä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿè„æ•°æ®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591971693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171500,"user_name":"çº·ç¹çš„çƒŸç«","can_delete":false,"product_type":"c1","uid":1449747,"ip_address":"","ucode":"3B402956C44B29","user_header":"https://static001.geekbang.org/account/avatar/00/16/1f/13/4647402a.jpg","comment_is_top":false,"comment_ctime":1578933205,"is_pvip":false,"replies":[{"id":"66607","content":"atomicæ–¹æ³•å†…ä¼ å…¥çš„ï¼Œlambdaè¡¨è¾¾å¼å¯ä»¥æ‰¾ä¸“é—¨çš„èµ„æ–™çœ‹çœ‹","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1579013672,"ip_address":"","comment_id":171500,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1578933205","product_id":100023901,"comment_content":"æœ€åæ®µä»£ç çš„ æ„é€ å‚æ•°é‡Œçš„txnåœ¨å“ªå‘€ æ‰¾ä¹Ÿæ‰¾ä¸åˆ°","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481382,"discussion_content":"atomicæ–¹æ³•å†…ä¼ å…¥çš„ï¼Œlambdaè¡¨è¾¾å¼å¯ä»¥æ‰¾ä¸“é—¨çš„èµ„æ–™çœ‹çœ‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579013672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":111909,"user_name":"æ‚Ÿç©º","can_delete":false,"product_type":"c1","uid":1451125,"ip_address":"","ucode":"F9DFBA74B35B40","user_header":"https://static001.geekbang.org/account/avatar/00/16/24/75/808ac160.jpg","comment_is_top":false,"comment_ctime":1562636099,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1562636099","product_id":100023901,"comment_content":"è€å¸ˆï¼Œprivate Map&lt;TxnRef, VersionedRef&gt; inTxnMap = new HashMap&lt;&gt;(); è¿™ä¸ªæ˜¯ä¸æ˜¯åº”è¯¥æ˜¯é™æ€çš„ã€‚åœ¨å¤šä¸ªäº‹ç‰©ä¸­å…±äº«ï¼Œè¿™æ ·ä¸€ä¸ªäº‹ç‰©å˜æ›´äº†ï¼Œå…¶ä»–äº‹ç‰©æ‰èƒ½çŸ¥æ™“","like_count":0,"discussions":[{"author":{"id":1113823,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fe/df/f1ce77a8.jpg","nickname":"æ˜Ÿæ˜Ÿä¸ªæ˜¯å¤§å¤ªé˜³ä¸¶","note":"","ucode":"D12A2F94417100","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4526,"discussion_content":"å…±äº«çš„ä¸æ˜¯mapï¼Œå…±äº«çš„æ˜¯TxnRefï¼Œå°±æ˜¯ä¾‹å­ä¸­çš„ä½™é¢ï¼ŒTxné‡Œé¢åªæ˜¯æŠŠæŸä¸ªæ—¶åˆ»çš„versionå­˜åœ¨mapé‡Œé¢äº†ï¼Œå¦‚æœæ•°æ®è¢«ä¿®æ”¹äº†ï¼ŒTxnRefå¯¹åº”çš„versionæ˜¯ä¼šé‡æ–°ç”Ÿæˆçš„ï¼Œä»£ç ä¸­è¿˜åŠ äº†volatileæ¥å®ç°å¯è§æ€§ï¼Œåªè¦TxnRefè¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹é¢versionï¼Œcommitå°±ä¸ä¼šå¤±è´¥äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565520340,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":104146,"user_name":"Rancood","can_delete":false,"product_type":"c1","uid":1204333,"ip_address":"","ucode":"052BDF2221F480","user_header":"https://static001.geekbang.org/account/avatar/00/12/60/6d/e2576fda.jpg","comment_is_top":false,"comment_ctime":1560666615,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560666615","product_id":100023901,"comment_content":"æ„Ÿè§‰æ²¡æœ‰å‰é¢å®¹æ˜“ç†è§£äº†","like_count":0},{"had_liked":false,"id":101361,"user_name":"æœ‰é“­","can_delete":false,"product_type":"c1","uid":1046302,"ip_address":"","ucode":"2C7CB36CA5C04C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132","comment_is_top":false,"comment_ctime":1559788831,"is_pvip":false,"replies":[{"id":"43627","content":"å½“ç„¶æœ‰æ­»é”ï¼Œä½†æ˜¯æ•°æ®åº“çš„ç›®æ ‡æ˜¯åŠªåŠ›æ¶ˆé™¤ä»–ä»¬ï¼Œæœ‰äº›æ˜¯æ•°æ®åº“çš„bugï¼Œæœ‰äº›æ˜¯æˆ‘ä»¬æ²¡æœ‰ç”¨å¥½","user_name":"ä½œè€…å›å¤","user_name_real":"ç‹å®ä»¤","uid":"1269969","ctime":1564486897,"ip_address":"","comment_id":101361,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1559788831","product_id":100023901,"comment_content":"è€å¸ˆï¼Œå…³ç³»æ•°æ®åº“ä¹Ÿæ˜¯æœ‰æ­»é”çš„ï¼Œåªæ˜¯ä»–ä»¬å¾€å¾€å®ç°äº†æ­»é”æ£€æµ‹æœºåˆ¶ï¼Œæ­»é”åˆ°ä¸€å®šæ—¶é—´å°±ä¼šå¼ºåˆ¶è§£é”","like_count":0,"discussions":[{"author":{"id":1269969,"avatar":"https://static001.geekbang.org/account/avatar/00/13/60/d1/8efa89ab.jpg","nickname":"ç‹å®ä»¤","note":"","ucode":"4FE19F5BC32FCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452928,"discussion_content":"å½“ç„¶æœ‰æ­»é”ï¼Œä½†æ˜¯æ•°æ®åº“çš„ç›®æ ‡æ˜¯åŠªåŠ›æ¶ˆé™¤ä»–ä»¬ï¼Œæœ‰äº›æ˜¯æ•°æ®åº“çš„bugï¼Œæœ‰äº›æ˜¯æˆ‘ä»¬æ²¡æœ‰ç”¨å¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564486897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101315,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1559781252,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559781252","product_id":100023901,"comment_content":"æ‰“å¡ï¼è¿™ç¯‡é«˜è´¨é‡ï¼","like_count":0},{"had_liked":false,"id":101290,"user_name":"çˆ±åƒå›é”…è‚‰çš„ç˜¦å­","can_delete":false,"product_type":"c1","uid":1233867,"ip_address":"","ucode":"24DBDDC62B2276","user_header":"https://static001.geekbang.org/account/avatar/00/12/d3/cb/f8157ad8.jpg","comment_is_top":false,"comment_ctime":1559778986,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559778986","product_id":100023901,"comment_content":"æ¶¨è§è¯†äº†ï¼Œè°¢è°¢è€å¸ˆã€‚","like_count":0}]}