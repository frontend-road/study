{"id":488817,"title":"12｜雪崩（四）：扩容，没有用钱解决不了的问题","content":"<p>你好，我是陈现麟。</p><p>在降级的学习中，我们掌握了降级机制的应用场景，手动降级和自动降级的实现原理，以及降级机制值得注意的一些关键问题，这样我们就可以引入分级降级策略，来快速降低系统的负载，确保核心服务的可用性了。现在我们已经学习完了分布式系统稳定性的三板斧：熔断、限流和降级，以后对维护后端系统的稳定性就更有信心了。</p><p>虽然熔断、限流和降级，很大程度上保障了系统的稳定性，但是从结果来看，它们都是通过放弃一定的用户体验和可用性，来确保系统在过载情况下依然正常运行的，这是一种通过有损节流，来降级系统负载的思路，那么有没有一种无损的方式，可以保障系统在过载下依然正常运行呢？</p><p>其实，这个问题就引出了一个典型的扩容场景，在这节课中，我们将一起讨论保障分布式系统稳定性的最后一个方法——扩容，了解需要扩容的原因，讨论如何实现扩容，最后再一起分析扩容机制与云原生的关系。这里要说明一点，因为缩容是扩容的逆向操作，所涉及的思路，原理和扩容一致，所以在课程中就不分开说明了。</p><h2>为什么需要扩容</h2><p>在“雪崩”系列的前三课中，我们分别介绍了解决分布式系统稳定性的三板斧：熔断、限流和降级，它们从系统底线的保障、核心服务的保障和非核心服务的牺牲这三个角度，全方位地保障着分布式系统的正常运行。但是，正如课程开始提到的，这些方法本质上都是对系统进行降级，通过有损的方式来保障系统不会雪崩。</p><!-- [[[read_end]]] --><p>究其根本原因，熔断、限流和降级都是一种静态思维模式，当系统过载了，就通过各种方式来放弃一部分请求，降低系统负载，从而让系统恢复正常。我们在降级这节课中也提到过，从更广义上来讲，熔断和限流都是降级的一种特殊情况，都在做丢车保帅的事情。</p><p>而扩容则是一种动态的思维模式，当系统过载了，就增加资源让系统重新恢复正常，而不是对系统进行降级处理，所以扩容是一种无损的系统过载恢复手段。</p><p>但是，扩容也会带来问题，我们需要用更多的资源来应对系统过载，也就是需要花费更多的钱。<strong>这是一个投入产出比（ ROI ）的问题，是通过有损降级恢复系统，导致用户的体验和可用性，以及用户口碑、品牌等方面的损失，与扩容资源投入的价值之间的比较</strong>。不过对于我们来说，这也不是一个二选一的问题，正常的情况下两个方式都会需要，我们在有损降级和扩容之间，找到适合自己的平衡点即可。</p><p>一般对于一个公司来说，在不同的阶段，对于平衡点的选择会有不同的倾向，早期公司会更倾向于使用有损降级的方向，而成熟公司会更倾向于使用扩容的方向，这其实就是由系统稳定性保障的 ROI 来决定的。</p><p>那么，在拥有扩容机制之后，我们的雪崩处理策略也会发生变化，不论是像运营活动等计划内的流量突增场景，还是计划外的系统过载问题，我们都会先投入一定的资源对系统进行扩容，来应对系统的过载问题。如果扩容后，系统依然处于过载状态，那么就通过熔断、限流和降级等有损机制，对系统的稳定性进行兜底。而对于扩容应该投入多少资源，每个公司根据自己的情况来设置这个平衡点。</p><h2>如何实现扩容</h2><p>通过上面的讨论，我们知道除了熔断、限流和降级之类的有损策略外，还可以通过扩容这样的无损策略，将系统恢复到正常的情况，这对于用户规模大、品牌价值强的公司来说，无疑多了一个非常好的选择。</p><p>在对系统进行扩容的时候，首先我们需要评估出需要扩容的服务，以及需要扩容到什么样的容量，然后才能进行扩容。一般来说，对于运营活动之类的计划内的扩容，我们通过历史数据和经验来评估，而对于线上计划外的系统过载触发的扩容，我们就需要通过监控，来捕捉系统的过载服务和程度，然后才能进行扩容操作。一般来说，动态扩容的流程如下图。</p><p><img src=\"https://static001.geekbang.org/resource/image/26/83/2672982e9f2b1686c09f728ba74ccc83.jpg?wh=2284x1186\" alt=\"\"></p><p>那么接下来，我们先介绍如何通过自适应的方式，来判断服务是否出现过载问题，然后从自动扩容的角度讨论如何实现扩容机制。</p><h3>过载判断</h3><p>过载判断是一件复杂的事情，如果我们打算通过基准测量，来确定服务过载指标，这将是一件无法持续的事情。因为服务会持续迭代，服务运行的硬件随时都有可能发生变化，这就会导致一种情况，即付出了巨大的工作量，但测量出的过载指标可能还是无法匹配线上运行，那么最终就会让过载判断出现错误，人为引入了故障。所以，我们需要寻找可以自适应的过载判断标准。</p><p>对于这个问题，有一个可行的方案，是我们在熔断这节课中介绍的，<strong>我们可以依据请求在队列中的平均等待时间来计算服务的负载</strong>。比如，一个服务在 1 分钟之内的平均等待时间超过 3 秒，我们就认为该服务进入过载状态。这里的“ 1 分钟之内的平均等待时间超过 3 秒”是一个自适应的指标，不论服务是否进行优化和迭代，以及服务运行在什么样的硬件上，我们通过这个指标来进行判断都是成立的。</p><p>但是，这个方式需要入侵到每一个服务的实现逻辑中，所有的服务都需要在实现时，暴露出接口请求的排队时间。如果有一个服务没有暴露，我们将无法捕捉到这个服务的过载状态，从而导致故障的发生。并且有些服务的实现，不会对接口请求进行排队，在这样的情况下，我们也就无法通过排队时间，来判断服务的过载情况了。</p><p><strong>所以在熔断场景下，我们对服务的过载判断进行了简化，直接对服务接口请求的结果来进行判断</strong>，如果请求发生了过载原因导致的错误，并且超过一定的阈值时，我们就可以认为该接口是过载的。</p><p>经过上面的讨论，可能你会觉得对服务的过载判断还是比较难的，其实从本质上来说，过载判断是非常简单的，我们只需要知道服务的满载指标，接近或者超过这个指标就是过载。但是依据这个思路确定服务过载指标时，会有 2 个问题。</p><ul>\n<li>初始满载指标测量的工作量大：服务非常多，并且还会快速增长，需要持续测量每一个服务的满载指标。</li>\n<li>服务的满载指标是会变的：服务持续迭代，并且会运行在不相同的硬件上，导致满载指标是不稳定的。</li>\n</ul><p>而上述的 2 个问题，对于物理机器和 K8S 上的 Pod 这样的节点来说，都是非常容易解决的。</p><ul>\n<li>初始满载指标是硬件指标，不需要测量，可以直接从操作系统中准确获取，比如 CPU 32 核，内存 64G 等。一般为了避免出现过载情况，我们会相对保守，将满载指标按硬件指标的百分比来设置，比如 60% 之类的。</li>\n<li>满载指标是硬件的指标，是不会变的。</li>\n</ul><p>所以，另一个判断服务过载的方案是，将服务和节点一一绑定，一个节点上只运行一个服务，如果节点的系统指标过载，则说明该服务出现了过载，需要扩容。在一台物理机器上只运行一个服务，资源浪费会比较严重，而 K8S 上的 Pod 则是一个非常好的方案。</p><p>当然，在某些业务场景下，我们认为服务每秒的 QPS 之类的指标，是决定系统过载最好的指标，我们也可以使用这个指标，来判断服务是否需要扩容。只不过我们要记住这个指标不是自适应的，在服务及其部署节点的性能发生变化后，我们需要再次评估好指标的阈值。</p><h3>自动扩容</h3><p>判断出系统过载的服务以及过载的程度之后，对系统进行扩容就是一个自动化部署的事情了。自动扩容分为两个层面，一个是容器的层面，另一个是机器节点的层面。</p><p><strong>首先，对于容器层面的扩容有两个维度，一个是水平扩容，即通过增加服务的实例数量对系统进行扩容；另一个是垂直扩容，即通过升级服务部署节点的资源对系统进行扩容</strong>。在 K8S  中，Horizontal Pod Autoscaler（ HPA ）对应水平扩展，Vertical Pod Autoscaler（ VPA ）对应垂直扩展，具体的策略如下图。</p><p><img src=\"https://static001.geekbang.org/resource/image/0f/7f/0fc40105b12d530f697000393b242d7f.jpg?wh=2284x2154\" alt=\"\" title=\"HPA\"></p><p><img src=\"https://static001.geekbang.org/resource/image/d2/71/d28028f28c4dff3c529367da7d402a71.jpg?wh=2284x2074\" alt=\"\" title=\"VPA\"></p><p>一般来说，水平扩容不受单机硬件的限制，我们可以优先考虑，但是对于有状态服务，在水平扩容的时候，会涉及数据迁移。如果这个有状态服务，对数据的自动迁移原生支持不好的话，会给系统增加复杂度，这时垂直扩容是一个不错的选择。</p><p><strong>其次，当我们进行容器层面的扩容后，整个集群的资源也会发生变化，如果集群的资源不足或者比较空闲，这时就需要进行机器节点层面的扩缩容了</strong>。对于节点层面的自动缩放涉及 Cluster Autoscaler（ CA ），它会在以下情况中自动调整集群的大小。</p><ul>\n<li>由于集群中的容量不足，任何 Pod 都无法运行并进入挂起状态，在这种情况下，CA 将向上扩展集群的容量。</li>\n<li>集群中的节点在一段时间内未得到充分利用，并且节点上的 Pod 是可以迁移的，在这种情况下，CA 将缩小集群容量。</li>\n</ul><p>CA 进行例行检查来确定是否有任何 Pod ，因为等待额外资源处于待定状态；或者集群节点是否未得到充分利用，如果需要更多资源，就会相应地调整 Cluster 节点的数量。 CA 通过与云提供商交互，来请求其他节点或关闭空闲节点，并确保按比例放大或者缩小的集群，保持在用户设置的限制范围内。</p><h2>扩容机制与云原生的关系</h2><p>我认为自动扩容和缩容是云原生时代软件的标志之一，即利用云的能力来实现软件能力的弹性变化。</p><p>你会发现，在云原生时代之前，所有的系统都部署在自己运维的 IDC 机房中，由于机房的成本是一次性投入的，不能按需使用，所以当时的扩容是一件笨重和昂贵的事情。</p><p>当时我们需要有计划地做容量预计，然后购买机器，再进行扩容。如果计划中，有流量巨大的运营活动，就需要提前进行扩容处理，并且在运营活动过去之后，流量降下来了，也没有办法进行缩容，这就会导致我们要为系统的峰值付费，是巨大的成本浪费。</p><p>所以，如果那时系统出现了计划外的过载问题，熔断、限流和降级是更常用的方案。虽然一般来说， IDC 机房中会准备一定的备用机器，但是这些资源还没有弹性利用的机制，需要人工介入，效率非常低。</p><p>而现在则完全不一样了，K8S 与公有云结合，通过 Cluster Autoscaler（ CA ）请求增加节点或关闭空闲节点，可以为我们提供按需付费的弹性资源，这样一来，不论是在成本还是效率方面都有了非常大的改进，扩容和缩容将会变成一个自生而来的事情。<strong>所以，我认为系统能否利用公有云或私有云进行弹性扩容，是云原生系统的核心标志。并且在以后，扩容将是解决系统过载问题最常用的方法</strong>。</p><h2>总结</h2><p>在这节课中，我们先从故障恢复手段，对系统的用户体验性和可用性影响的角度，讨论了在有了三板斧之后，需要扩容机制的原因。通过这个讨论，你知道了扩容的作用和应用场景，在后续的工作中碰到相关的问题时，可以引入扩容机制。</p><p>另外在如何实现扩容机制的讨论中，我们知道了如何判断一个服务是否过载，以及自动扩容的两个方式：水平扩容和垂直扩容，掌握了这些知识和原理后，你就能为你现在的系统引入一个扩容机制了。</p><p>最后，我们一起探讨了扩容机制与云原生之间的关系，并且了解了云原生系统的核心标志是，能否利用公有云或私有云进行弹性扩容，在以后，扩容将是解决系统过载问题最常用的方法。</p><h2>思考题</h2><p>在云原生时代，除了按需付费（即扩容、缩容的弹性能力）之外，你觉得还有哪些趋势呢？</p><p>欢迎你在留言区发表你的看法。如果这节课对你有帮助，也推荐你分享给更多的同事、朋友。</p>","comments":[{"had_liked":false,"id":335869,"user_name":"陈迪","can_delete":false,"product_type":"c1","uid":1019744,"ip_address":"","ucode":"1A64122CC47337","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8f/60/be0a8805.jpg","comment_is_top":false,"comment_ctime":1645748594,"is_pvip":false,"replies":[{"id":"123071","content":"排队时间和响应时间是从服务的角度来判断是否过载，如果从机器系统的角度来判断，那么就是内存使用率，对于内存，我们的满载可以定义内存使用率80%，也就是说内存使用率超过80%，系统就过载了。满载就是系统阈值，超过了就说明过载。","user_name":"作者回复","comment_id":335869,"uid":"1047808","ip_address":"","utype":1,"ctime":1646391754,"user_name_real":"编辑"}],"discussion_count":2,"race_medal":0,"score":"10235683186","product_id":100104701,"comment_content":"过载判断那里没理解。<br>按排队时间或者响应时间来判断很容易理解，但怎么变成下面变成“硬件指标”了，没搞懂这个逻辑。<br>“满载”指的又是啥","like_count":2,"discussions":[{"author":{"id":1047808,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fd/00/f5d19a8b.jpg","nickname":"伴鱼技术团队","note":"","ucode":"C7FAC706B18376","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554469,"discussion_content":"排队时间和响应时间是从服务的角度来判断是否过载，如果从机器系统的角度来判断，那么就是内存使用率，对于内存，我们的满载可以定义内存使用率80%，也就是说内存使用率超过80%，系统就过载了。满载就是系统阈值，超过了就说明过载。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646391754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1341393,"avatar":"","nickname":"saking","note":"","ucode":"CEBCBB435E37D2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553765,"discussion_content":"上面这是两个方案吧，后面一个方案是在服务独占资源的情况下，可以通过硬件资源来计算满载，比如cpu利用率，内存利用率。如果有多个服务跑在同一台设备则会相互影响（k8s的pod也是资源隔离，和独享物理机器一样）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646061202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339523,"user_name":"Bug Killer","can_delete":false,"product_type":"c1","uid":1186089,"ip_address":"","ucode":"2741A206F504E1","user_header":"https://static001.geekbang.org/account/avatar/00/12/19/29/4a8214b7.jpg","comment_is_top":false,"comment_ctime":1648172207,"is_pvip":false,"replies":[{"id":"124507","content":"这个是和实现方式相关的，如果内部实现是生产者消费者模型，可以通过埋点统计来实现，如果不是这种模型是不好统计的。","user_name":"作者回复","comment_id":339523,"uid":"1047808","ip_address":"","utype":1,"ctime":1648861707,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"5943139503","product_id":100104701,"comment_content":"我们可以依据请求在队列中的平均等待时间来计算服务的负载<br>请求在队列中的等待时间怎么算","like_count":1,"discussions":[{"author":{"id":1047808,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fd/00/f5d19a8b.jpg","nickname":"伴鱼技术团队","note":"","ucode":"C7FAC706B18376","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559622,"discussion_content":"这个是和实现方式相关的，如果内部实现是生产者消费者模型，可以通过埋点统计来实现，如果不是这种模型是不好统计的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648861707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340161,"user_name":"不吃辣👾","can_delete":false,"product_type":"c1","uid":1333649,"ip_address":"","ucode":"B25E0725B5E85F","user_header":"https://static001.geekbang.org/account/avatar/00/14/59/91/fa2d8bb2.jpg","comment_is_top":false,"comment_ctime":1648637213,"is_pvip":true,"replies":[{"id":"124434","content":"可以👍","user_name":"作者回复","comment_id":340161,"uid":"1047808","ip_address":"","utype":1,"ctime":1648702175,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"1648637213","product_id":100104701,"comment_content":"一台虚拟机部署一个服务，虚拟机的硬件指标是不是可以代表服务负载问题？","like_count":0,"discussions":[{"author":{"id":1047808,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fd/00/f5d19a8b.jpg","nickname":"伴鱼技术团队","note":"","ucode":"C7FAC706B18376","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559320,"discussion_content":"可以👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648702175,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335968,"user_name":"Jxin","can_delete":false,"product_type":"c1","uid":1251111,"ip_address":"","ucode":"4C03928388C413","user_header":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","comment_is_top":false,"comment_ctime":1645795500,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645795500","product_id":100104701,"comment_content":"1.文中漏了一个点。决策扩容的依据是什么？ 没有pod可用这是一个结果。判断pod能否支撑当前请求，不能有没有其他pod可以，都没有创建新pod。这已经涉及自适应负载均衡了，而这个在高并发场景很难实现，感兴趣可以想想。<br><br>2.一年多没关注了，之前的解法是采用大集群走负载均衡而不是自适应负载均衡，最后基于定时的负载检测决策是否扩容。","like_count":0},{"had_liked":false,"id":335683,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1645626429,"is_pvip":true,"replies":[{"id":"122657","content":"Q1：是的<br>Q2：上不去云都可以用K8S来自动扩容，只不过如果不上云，没有CA来扩容节点","user_name":"作者回复","comment_id":335683,"uid":"1047808","ip_address":"","utype":1,"ctime":1645659144,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"1645626429","product_id":100104701,"comment_content":"请教老师两个问题：<br>Q1：容器垂直扩容，升级的是节点资源，怎么图形中Pod变大了？（Pod图标变大应该是意味着Pod的资源变多了吧）<br>Q2：如果不上云，扩容&#47;缩容有框架吗？还是说需要自己开发？<br>        如果上云，云会提供自动缩&#47;扩容机制，对吗？","like_count":0,"discussions":[{"author":{"id":1047808,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fd/00/f5d19a8b.jpg","nickname":"伴鱼技术团队","note":"","ucode":"C7FAC706B18376","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552928,"discussion_content":"Q1：是的\nQ2：上不去云都可以用K8S来自动扩容，只不过如果不上云，没有CA来扩容节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645659144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}