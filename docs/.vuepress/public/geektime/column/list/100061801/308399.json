{"id":308399,"title":"16 | Semaphoreï¼šä¸€ç¯‡æ–‡ç« ææ‡‚ä¿¡å·é‡","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†æ ‡å‡†åº“çš„å¹¶å‘åŸè¯­ã€åŸå­æ“ä½œå’ŒChannelï¼ŒæŒæ¡äº†è¿™äº›ï¼Œä½ å°±å¯ä»¥è§£å†³80%çš„å¹¶å‘ç¼–ç¨‹é—®é¢˜äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ è¦æƒ³è¿›ä¸€æ­¥æå‡ä½ çš„å¹¶å‘ç¼–ç¨‹èƒ½åŠ›ï¼Œå°±éœ€è¦å­¦ä¹ ä¸€äº›ç¬¬ä¸‰æ–¹åº“ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨æ¥ä¸‹æ¥çš„å‡ èŠ‚è¯¾é‡Œï¼Œæˆ‘ä¼šç»™ä½ åˆ†äº«Goå®˜æ–¹æˆ–è€…å…¶ä»–äººæä¾›çš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™èŠ‚è¯¾æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¿¡å·é‡ï¼Œä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªgoroutineåŒæ—¶è®¿é—®å¤šä¸ªèµ„æºçš„å¹¶å‘åŸè¯­ã€‚</p><h1>ä¿¡å·é‡æ˜¯ä»€ä¹ˆï¼Ÿéƒ½æœ‰ä»€ä¹ˆæ“ä½œï¼Ÿ</h1><p>ä¿¡å·é‡çš„æ¦‚å¿µæ˜¯è·å…°è®¡ç®—æœºç§‘å­¦å®¶Edsger Dijkstraåœ¨1963å¹´å·¦å³æå‡ºæ¥çš„ï¼Œå¹¿æ³›åº”ç”¨åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ã€‚åœ¨ç³»ç»Ÿä¸­ï¼Œä¼šç»™æ¯ä¸€ä¸ªè¿›ç¨‹ä¸€ä¸ªä¿¡å·é‡ï¼Œä»£è¡¨æ¯ä¸ªè¿›ç¨‹ç›®å‰çš„çŠ¶æ€ã€‚æœªå¾—åˆ°æ§åˆ¶æƒçš„è¿›ç¨‹ï¼Œä¼šåœ¨ç‰¹å®šçš„åœ°æ–¹è¢«è¿«åœä¸‹æ¥ï¼Œç­‰å¾…å¯ä»¥ç»§ç»­è¿›è¡Œçš„ä¿¡å·åˆ°æ¥ã€‚</p><p>æœ€ç®€å•çš„ä¿¡å·é‡å°±æ˜¯ä¸€ä¸ªå˜é‡åŠ ä¸€äº›å¹¶å‘æ§åˆ¶çš„èƒ½åŠ›ï¼Œè¿™ä¸ªå˜é‡æ˜¯0åˆ°nä¹‹é—´çš„ä¸€ä¸ªæ•°å€¼ã€‚å½“goroutineå®Œæˆå¯¹æ­¤ä¿¡å·é‡çš„ç­‰å¾…ï¼ˆwaitï¼‰æ—¶ï¼Œè¯¥è®¡æ•°å€¼å°±å‡1ï¼Œå½“goroutineå®Œæˆå¯¹æ­¤ä¿¡å·é‡çš„é‡Šæ”¾ï¼ˆreleaseï¼‰æ—¶ï¼Œè¯¥è®¡æ•°å€¼å°±åŠ 1ã€‚å½“è®¡æ•°å€¼ä¸º0çš„æ—¶å€™ï¼Œgoroutineè°ƒç”¨waitç­‰å¾…è¯¥ä¿¡å·é‡æ˜¯ä¸ä¼šæˆåŠŸçš„ï¼Œé™¤éè®¡æ•°å™¨åˆå¤§äº0ï¼Œç­‰å¾…çš„goroutineæ‰æœ‰å¯èƒ½æˆåŠŸè¿”å›ã€‚</p><!-- [[[read_end]]] --><p>æ›´å¤æ‚çš„ä¿¡å·é‡ç±»å‹ï¼Œå°±æ˜¯ä½¿ç”¨æŠ½è±¡æ•°æ®ç±»å‹ä»£æ›¿å˜é‡ï¼Œç”¨æ¥ä»£è¡¨å¤æ‚çš„èµ„æºç±»å‹ã€‚å®é™…ä¸Šï¼Œå¤§éƒ¨åˆ†çš„ä¿¡å·é‡éƒ½ä½¿ç”¨ä¸€ä¸ªæ•´å‹å˜é‡æ¥è¡¨ç¤ºä¸€ç»„èµ„æºï¼Œå¹¶æ²¡æœ‰å®ç°å¤ªå¤æ‚çš„æŠ½è±¡æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥ä½ åªè¦çŸ¥é“æœ‰æ›´å¤æ‚çš„ä¿¡å·é‡å°±è¡Œäº†ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾ä¸»è¦æ˜¯å­¦ä¹ æœ€ç®€å•çš„ä¿¡å·é‡ã€‚</p><p>è¯´åˆ°è¿™å„¿å‘¢ï¼Œæˆ‘æƒ³å€ŸåŠ©ä¸€ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œæ¥å¸®ä½ è¿›ä¸€æ­¥ç†è§£ä¿¡å·é‡ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå›¾ä¹¦é¦†æ–°è´­ä¹°äº†10æœ¬ã€ŠGoå¹¶å‘ç¼–ç¨‹çš„ç‹¬å®¶ç§˜ç±ã€‹ï¼Œæœ‰1ä¸‡ä¸ªå­¦ç”Ÿéƒ½æƒ³è¯»è¿™æœ¬ä¹¦ï¼Œâ€œåƒ§å¤šç²¥å°‘â€ã€‚æ‰€ä»¥ï¼Œå›¾ä¹¦é¦†ç®¡ç†å‘˜å…ˆä¼šè®©è¿™1ä¸‡ä¸ªåŒå­¦è¿›è¡Œç™»è®°ï¼ŒæŒ‰ç…§ç™»è®°çš„é¡ºåºï¼Œå€Ÿé˜…æ­¤ä¹¦ã€‚å¦‚æœä¹¦å…¨éƒ¨è¢«å€Ÿèµ°ï¼Œé‚£ä¹ˆï¼Œå…¶ä»–æƒ³çœ‹æ­¤ä¹¦çš„åŒå­¦å°±éœ€è¦ç­‰å¾…ï¼Œå¦‚æœæœ‰äººè¿˜ä¹¦äº†ï¼Œå›¾ä¹¦é¦†ç®¡ç†å‘˜å°±ä¼šé€šçŸ¥ä¸‹ä¸€ä½åŒå­¦æ¥å€Ÿé˜…è¿™æœ¬ä¹¦ã€‚è¿™é‡Œçš„èµ„æºæ˜¯ã€ŠGoå¹¶å‘ç¼–ç¨‹çš„ç‹¬å®¶ç§˜ç±ã€‹è¿™åæœ¬ä¹¦ï¼Œæƒ³è¯»æ­¤ä¹¦çš„åŒå­¦å°±æ˜¯goroutineï¼Œå›¾ä¹¦ç®¡ç†å‘˜å°±æ˜¯ä¿¡å·é‡ã€‚</p><p>æ€ä¹ˆæ ·ï¼Œç°åœ¨æ˜¯ä¸æ˜¯å¾ˆå¥½ç†è§£äº†ï¼Ÿé‚£ä¹ˆï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸‹ä¿¡å·é‡çš„P/Væ“ä½œã€‚</p><h2>P/Væ“ä½œ</h2><p>Dijkstraåœ¨ä»–çš„è®ºæ–‡ä¸­ä¸ºä¿¡å·é‡å®šä¹‰äº†ä¸¤ä¸ªæ“ä½œPå’ŒVã€‚Pæ“ä½œï¼ˆdescreaseã€waitã€acquireï¼‰æ˜¯å‡å°‘ä¿¡å·é‡çš„è®¡æ•°å€¼ï¼Œè€ŒVæ“ä½œï¼ˆincreaseã€signalã€releaseï¼‰æ˜¯å¢åŠ ä¿¡å·é‡çš„è®¡æ•°å€¼ã€‚</p><p>ä½¿ç”¨ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼ˆä¸­æ‹¬å·ä»£è¡¨åŸå­æ“ä½œï¼‰ï¼š</p><pre><code>function V(semaphore S, integer I):\n    [S â† S + I]\n\nfunction P(semaphore S, integer I):\n    repeat:\n        [if S â‰¥ I:\n        S â† S âˆ’ I\n        break]\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆå§‹åŒ–ä¿¡å·é‡Sæœ‰ä¸€ä¸ªæŒ‡å®šæ•°é‡ï¼ˆ<strong>n</strong>ï¼‰çš„èµ„æºï¼Œå®ƒå°±åƒæ˜¯ä¸€ä¸ªæœ‰nä¸ªèµ„æºçš„æ± å­ã€‚Pæ“ä½œç›¸å½“äºè¯·æ±‚èµ„æºï¼Œå¦‚æœèµ„æºå¯ç”¨ï¼Œå°±ç«‹å³è¿”å›ï¼›å¦‚æœæ²¡æœ‰èµ„æºæˆ–è€…ä¸å¤Ÿï¼Œé‚£ä¹ˆï¼Œå®ƒå¯ä»¥ä¸æ–­å°è¯•æˆ–è€…é˜»å¡ç­‰å¾…ã€‚Væ“ä½œä¼šé‡Šæ”¾è‡ªå·±æŒæœ‰çš„èµ„æºï¼ŒæŠŠèµ„æºè¿”è¿˜ç»™ä¿¡å·é‡ã€‚ä¿¡å·é‡çš„å€¼é™¤äº†åˆå§‹åŒ–çš„æ“ä½œä»¥å¤–ï¼Œåªèƒ½ç”±P/Væ“ä½œæ”¹å˜ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸‹ä¿¡å·é‡çš„å®ç°ã€‚</p><ul>\n<li>åˆå§‹åŒ–ä¿¡å·é‡ï¼šè®¾å®šåˆå§‹çš„èµ„æºçš„æ•°é‡ã€‚</li>\n<li>Pæ“ä½œï¼šå°†ä¿¡å·é‡çš„è®¡æ•°å€¼å‡å»1ï¼Œå¦‚æœæ–°å€¼å·²ç»ä¸ºè´Ÿï¼Œé‚£ä¹ˆè°ƒç”¨è€…ä¼šè¢«é˜»å¡å¹¶åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚å¦åˆ™ï¼Œè°ƒç”¨è€…ä¼šç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”è·å¾—ä¸€ä¸ªèµ„æºã€‚</li>\n<li>Væ“ä½œï¼šå°†ä¿¡å·é‡çš„è®¡æ•°å€¼åŠ 1ï¼Œå¦‚æœå…ˆå‰çš„è®¡æ•°å€¼ä¸ºè´Ÿï¼Œå°±è¯´æ˜æœ‰ç­‰å¾…çš„Pæ“ä½œçš„è°ƒç”¨è€…ã€‚å®ƒä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªç­‰å¾…çš„è°ƒç”¨è€…ï¼Œå”¤é†’å®ƒï¼Œè®©å®ƒç»§ç»­æ‰§è¡Œã€‚</li>\n</ul><p>è®²åˆ°è¿™é‡Œï¼Œæˆ‘æƒ³å†ç¨å¾®è¯´ä¸€ä¸ªé¢˜å¤–è¯ï¼Œæˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/295850\">ç¬¬2è®²</a>æåˆ°è¿‡é¥¥é¥¿ï¼Œå°±æ˜¯è¯´åœ¨é«˜å¹¶å‘çš„æç«¯åœºæ™¯ä¸‹ï¼Œä¼šæœ‰äº›goroutineå§‹ç»ˆæŠ¢ä¸åˆ°é”ã€‚ä¸ºäº†å¤„ç†é¥¥é¥¿çš„é—®é¢˜ï¼Œä½ å¯ä»¥åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­åšä¸€äº›â€œæ–‡ç« â€ã€‚æ¯”å¦‚å®ç°ä¸€ä¸ªä¼˜å…ˆçº§çš„é˜Ÿåˆ—ï¼Œæˆ–è€…å…ˆå…¥å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç­‰ç­‰ï¼Œä¿æŒå…¬å¹³æ€§ï¼Œå¹¶ä¸”ç…§é¡¾åˆ°ä¼˜å…ˆçº§ã€‚</p><p>åœ¨æ­£å¼è¿›å…¥å®ç°ä¿¡å·é‡çš„å…·ä½“å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆè®²ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯ä¿¡å·é‡å’Œäº’æ–¥é”çš„åŒºåˆ«ä¸è”ç³»ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬æŒæ¡æ¥ä¸‹æ¥çš„å†…å®¹ã€‚</p><p>å…¶å®ï¼Œä¿¡å·é‡å¯ä»¥åˆ†ä¸ºè®¡æ•°ä¿¡å·é‡ï¼ˆcounting semaphoreï¼‰å’ŒäºŒè¿›ä½ä¿¡å·é‡ï¼ˆbinary semaphoreï¼‰ã€‚åˆšåˆšæ‰€è¯´çš„å›¾ä¹¦é¦†å€Ÿä¹¦çš„ä¾‹å­å°±æ˜¯ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ï¼Œå®ƒçš„è®¡æ•°å¯ä»¥æ˜¯ä»»æ„ä¸€ä¸ªæ•´æ•°ã€‚åœ¨ç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼Œå¦‚æœè®¡æ•°å€¼åªèƒ½æ˜¯0æˆ–è€…1ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªä¿¡å·é‡å°±æ˜¯äºŒè¿›ä½ä¿¡å·é‡ï¼Œæä¾›äº†äº’æ–¥çš„åŠŸèƒ½ï¼ˆè¦ä¹ˆæ˜¯0ï¼Œè¦ä¹ˆæ˜¯1ï¼‰ï¼Œæ‰€ä»¥ï¼Œæœ‰æ—¶å€™äº’æ–¥é”ä¹Ÿä¼šä½¿ç”¨äºŒè¿›ä½ä¿¡å·é‡æ¥å®ç°ã€‚</p><p>æˆ‘ä»¬ä¸€èˆ¬ç”¨ä¿¡å·é‡ä¿æŠ¤ä¸€ç»„èµ„æºï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ã€ä¸€ç»„å®¢æˆ·ç«¯çš„è¿æ¥ã€å‡ ä¸ªæ‰“å°æœºèµ„æºï¼Œç­‰ç­‰ã€‚å¦‚æœä¿¡å·é‡èœ•å˜æˆäºŒè¿›ä½ä¿¡å·é‡ï¼Œé‚£ä¹ˆï¼Œå®ƒçš„P/Vå°±å’Œäº’æ–¥é”çš„Lock/Unlockä¸€æ ·äº†ã€‚</p><p>æœ‰äººä¼šå¾ˆç»†è‡´åœ°åŒºåˆ†äºŒè¿›ä½ä¿¡å·é‡å’Œäº’æ–¥é”ã€‚æ¯”å¦‚è¯´ï¼Œæœ‰äººæå‡ºï¼Œåœ¨Windowsç³»ç»Ÿä¸­ï¼Œäº’æ–¥é”åªèƒ½ç”±æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œè€ŒäºŒè¿›ä½ä¿¡å·é‡åˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼ˆ<a href=\"https://stackoverflow.com/questions/62814/difference-between-binary-semaphore-and-mutex\">Stack Overflow</a>ä¸Šä¹Ÿæœ‰ç›¸å…³çš„è®¨è®ºï¼‰ã€‚å®é™…ä¸Šï¼Œè™½ç„¶åœ¨Windowsç³»ç»Ÿä¸­ï¼Œå®ƒä»¬çš„ç¡®æœ‰äº›åŒºåˆ«ï¼Œä½†æ˜¯å¯¹Goè¯­è¨€æ¥è¯´ï¼Œäº’æ–¥é”ä¹Ÿå¯ä»¥ç”±éæŒæœ‰çš„goroutineæ¥é‡Šæ”¾ï¼Œæ‰€ä»¥ï¼Œä»è¡Œä¸ºä¸Šæ¥è¯´ï¼Œå®ƒä»¬å¹¶æ²¡æœ‰ä¸¥æ ¼çš„åŒºåˆ«ã€‚</p><p>æˆ‘ä¸ªäººè®¤ä¸ºï¼Œæ²¡å¿…è¦è¿›è¡Œç»†è‡´çš„åŒºåˆ†ï¼Œå› ä¸ºäº’æ–¥é”å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆä¸¥æ ¼çš„å®šä¹‰ã€‚å®é™…åœ¨é‡åˆ°äº’æ–¥å¹¶å‘çš„é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬é€‰ç”¨äº’æ–¥é”ã€‚</p><p>å¥½äº†ï¼Œè¨€å½’æ­£ä¼ ï¼Œåˆšåˆšæˆ‘ä»¬æŒæ¡äº†ä¿¡å·é‡çš„å«ä¹‰å’Œå…·ä½“æ“ä½œæ–¹å¼ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥å…·ä½“äº†è§£ä¸‹å®˜æ–¹æ‰©å±•åº“çš„å®ç°ã€‚</p><h1>Goå®˜æ–¹æ‰©å±•åº“çš„å®ç°</h1><p>åœ¨è¿è¡Œæ—¶ï¼ŒGoå†…éƒ¨ä½¿ç”¨ä¿¡å·é‡æ¥æ§åˆ¶goroutineçš„é˜»å¡å’Œå”¤é†’ã€‚æˆ‘ä»¬åœ¨å­¦ä¹ åŸºæœ¬å¹¶å‘åŸè¯­çš„å®ç°æ—¶ä¹Ÿçœ‹åˆ°äº†ï¼Œæ¯”å¦‚äº’æ–¥é”çš„ç¬¬äºŒä¸ªå­—æ®µï¼š</p><pre><code>type Mutex struct {\n\t\tstate int32\n\t\tsema  uint32\n}\n</code></pre><p>ä¿¡å·é‡çš„P/Væ“ä½œæ˜¯é€šè¿‡å‡½æ•°å®ç°çš„ï¼š</p><pre><code>func runtime_Semacquire(s *uint32)\nfunc runtime_SemacquireMutex(s *uint32, lifo bool, skipframes int)\nfunc runtime_Semrelease(s *uint32, handoff bool, skipframes int)\n</code></pre><p>é—æ†¾çš„æ˜¯ï¼Œå®ƒæ˜¯Goè¿è¡Œæ—¶å†…éƒ¨ä½¿ç”¨çš„ï¼Œå¹¶æ²¡æœ‰å°è£…æš´éœ²æˆä¸€ä¸ªå¯¹å¤–çš„ä¿¡å·é‡å¹¶å‘åŸè¯­ï¼ŒåŸåˆ™ä¸Šæˆ‘ä»¬æ²¡æœ‰åŠæ³•ä½¿ç”¨ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼ŒGoåœ¨å®ƒçš„æ‰©å±•åŒ…ä¸­æä¾›äº†ä¿¡å·é‡<a href=\"https://godoc.org/golang.org/x/sync/semaphore\">semaphore</a>ï¼Œä¸è¿‡è¿™ä¸ªä¿¡å·é‡çš„ç±»å‹åå¹¶ä¸å«Semaphoreï¼Œè€Œæ˜¯å«Weightedã€‚</p><p>ä¹‹æ‰€ä»¥å«åšWeightedï¼Œæˆ‘æƒ³ï¼Œåº”è¯¥æ˜¯å› ä¸ºå¯ä»¥åœ¨åˆå§‹åŒ–åˆ›å»ºè¿™ä¸ªä¿¡å·é‡çš„æ—¶å€™è®¾ç½®æƒé‡ï¼ˆåˆå§‹åŒ–çš„èµ„æºæ•°ï¼‰ï¼Œå…¶å®æˆ‘è§‰å¾—å«Semaphoreæˆ–è®¸ä¼šæ›´å¥½ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1a/b0/1a13a551346cd6b910f38f5ed2bfc6b0.png?wh=702*174\" alt=\"\"></p><p>æˆ‘ä»¬æ¥åˆ†æä¸‹è¿™ä¸ªä¿¡å·é‡çš„å‡ ä¸ªå®ç°æ–¹æ³•ã€‚</p><ol>\n<li><strong>Acquireæ–¹æ³•</strong>ï¼šç›¸å½“äºPæ“ä½œï¼Œä½ å¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªèµ„æºï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿå¤šçš„èµ„æºï¼Œè°ƒç”¨è€…å°±ä¼šè¢«é˜»å¡ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Contextï¼Œè¿™å°±æ„å‘³ç€ï¼Œä½ å¯ä»¥é€šè¿‡Contextå¢åŠ è¶…æ—¶æˆ–è€…cancelçš„æœºåˆ¶ã€‚å¦‚æœæ˜¯æ­£å¸¸è·å–äº†èµ„æºï¼Œå°±è¿”å›nilï¼›å¦åˆ™ï¼Œå°±è¿”å›ctx.Err()ï¼Œä¿¡å·é‡ä¸æ”¹å˜ã€‚</li>\n<li><strong>Releaseæ–¹æ³•</strong>ï¼šç›¸å½“äºVæ“ä½œï¼Œå¯ä»¥å°†nä¸ªèµ„æºé‡Šæ”¾ï¼Œè¿”è¿˜ç»™ä¿¡å·é‡ã€‚</li>\n<li><strong>TryAcquireæ–¹æ³•</strong>ï¼šå°è¯•è·å–nä¸ªèµ„æºï¼Œä½†æ˜¯å®ƒä¸ä¼šé˜»å¡ï¼Œè¦ä¹ˆæˆåŠŸè·å–nä¸ªèµ„æºï¼Œè¿”å›trueï¼Œè¦ä¹ˆä¸€ä¸ªä¹Ÿä¸è·å–ï¼Œè¿”å›falseã€‚</li>\n</ol><p>çŸ¥é“äº†ä¿¡å·é‡çš„å®ç°æ–¹æ³•ï¼Œåœ¨å®é™…çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘æ¥ä¸¾ä¸ªWorker Poolçš„ä¾‹å­ï¼Œæ¥å¸®åŠ©ä½ ç†è§£ã€‚</p><p>æˆ‘ä»¬åˆ›å»ºå’ŒCPUæ ¸æ•°ä¸€æ ·å¤šçš„Workerï¼Œè®©å®ƒä»¬å»å¤„ç†ä¸€ä¸ª4å€æ•°é‡çš„æ•´æ•°sliceã€‚æ¯ä¸ªWorkerä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªæ•´æ•°ï¼Œå¤„ç†å®Œä¹‹åï¼Œæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šç§ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬ä½¿ç”¨ä¿¡å·é‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>var (\n    maxWorkers = runtime.GOMAXPROCS(0)                    // workeræ•°é‡\n    sema       = semaphore.NewWeighted(int64(maxWorkers)) //ä¿¡å·é‡\n    task       = make([]int, maxWorkers*4)                // ä»»åŠ¡æ•°ï¼Œæ˜¯workerçš„å››å€\n)\n\nfunc main() {\n    ctx := context.Background()\n\n    for i := range task {\n        // å¦‚æœæ²¡æœ‰workerå¯ç”¨ï¼Œä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æŸä¸ªworkerè¢«é‡Šæ”¾\n        if err := sema.Acquire(ctx, 1); err != nil {\n            break\n        }\n\n        // å¯åŠ¨worker goroutine\n        go func(i int) {\n            defer sema.Release(1)\n            time.Sleep(100 * time.Millisecond) // æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶æ“ä½œ\n            task[i] = i + 1\n        }(i)\n    }\n\n    // è¯·æ±‚æ‰€æœ‰çš„worker,è¿™æ ·èƒ½ç¡®ä¿å‰é¢çš„workeréƒ½æ‰§è¡Œå®Œ\n    if err := sema.Acquire(ctx, int64(maxWorkers)); err != nil {\n        log.Printf(&quot;è·å–æ‰€æœ‰çš„workerå¤±è´¥: %v&quot;, err)\n    }\n\n    fmt.Println(task)\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œmain goroutineç›¸å½“äºä¸€ä¸ªdispatcherï¼Œè´Ÿè´£ä»»åŠ¡çš„åˆ†å‘ã€‚å®ƒå…ˆè¯·æ±‚ä¿¡å·é‡ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªgoroutineå»å¤„ç†è®¡ç®—ï¼Œç„¶åï¼Œè¿™ä¸ªgoroutineä¼šé‡Šæ”¾è¿™ä¸ªä¿¡å·é‡ï¼ˆæœ‰æ„æ€çš„æ˜¯ï¼Œä¿¡å·é‡çš„è·å–æ˜¯åœ¨main goroutineï¼Œä¿¡å·é‡çš„é‡Šæ”¾æ˜¯åœ¨worker goroutineä¸­ï¼‰ï¼Œå¦‚æœè·å–ä¸æˆåŠŸï¼Œå°±ç­‰åˆ°æœ‰ä¿¡å·é‡å¯ä»¥ä½¿ç”¨çš„æ—¶å€™ï¼Œå†å»è·å–ã€‚</p><p>éœ€è¦æé†’ä½ çš„æ˜¯ï¼Œå…¶å®ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯æœ€åçš„é‚£ä¸€æ®µå¤„ç†ï¼ˆç¬¬25è¡Œï¼‰ã€‚<strong>å¦‚æœåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ æƒ³ç­‰æ‰€æœ‰çš„Workeréƒ½æ‰§è¡Œå®Œï¼Œå°±å¯ä»¥è·å–æœ€å¤§è®¡æ•°å€¼çš„ä¿¡å·é‡</strong>ã€‚</p><p>Goæ‰©å±•åº“ä¸­çš„ä¿¡å·é‡æ˜¯ä½¿ç”¨äº’æ–¥é”+Listå®ç°çš„ã€‚äº’æ–¥é”å®ç°å…¶å®ƒå­—æ®µçš„ä¿æŠ¤ï¼Œè€ŒListå®ç°äº†ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…è€…çš„é€šçŸ¥æ˜¯é€šè¿‡Channelçš„é€šçŸ¥æœºåˆ¶å®ç°çš„ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¿¡å·é‡Weightedçš„æ•°æ®ç»“æ„ï¼š</p><pre><code>type Weighted struct {\n\t\tsize    int64         // æœ€å¤§èµ„æºæ•°\n\t\tcur     int64         // å½“å‰å·²è¢«ä½¿ç”¨çš„èµ„æº\n\t\tmu      sync.Mutex    // äº’æ–¥é”ï¼Œå¯¹å­—æ®µçš„ä¿æŠ¤\n\t\twaiters list.List     // ç­‰å¾…é˜Ÿåˆ—\n}\n</code></pre><p>åœ¨ä¿¡å·é‡çš„å‡ ä¸ªå®ç°æ–¹æ³•é‡Œï¼ŒAcquireæ˜¯ä»£ç æœ€å¤æ‚çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒä¸ä»…ä»…è¦ç›‘æ§èµ„æºæ˜¯å¦å¯ç”¨ï¼Œè€Œä¸”è¿˜è¦æ£€æµ‹Contextçš„Doneæ˜¯å¦å·²å…³é—­ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å®ç°ä»£ç ã€‚</p><pre><code>func (s *Weighted) Acquire(ctx context.Context, n int64) error {\n\t\ts.mu.Lock()\n        // fast path, å¦‚æœæœ‰è¶³å¤Ÿçš„èµ„æºï¼Œéƒ½ä¸è€ƒè™‘ctx.Doneçš„çŠ¶æ€ï¼Œå°†curåŠ ä¸Šnå°±è¿”å›\n\t\tif s.size-s.cur &gt;= n &amp;&amp; s.waiters.Len() == 0 {\n\t\t\ts.cur += n\n\t\t\ts.mu.Unlock()\n\t\t\treturn nil\n\t\t}\n\t\n        // å¦‚æœæ˜¯ä¸å¯èƒ½å®Œæˆçš„ä»»åŠ¡ï¼Œè¯·æ±‚çš„èµ„æºæ•°å¤§äºèƒ½æä¾›çš„æœ€å¤§çš„èµ„æºæ•°\n\t\tif n &gt; s.size {\n\t\t\ts.mu.Unlock()\n            // ä¾èµ–ctxçš„çŠ¶æ€è¿”å›ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…\n\t\t\t&lt;-ctx.Done()\n\t\t\treturn ctx.Err()\n\t\t}\n\t\n        // å¦åˆ™å°±éœ€è¦æŠŠè°ƒç”¨è€…åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­\n        // åˆ›å»ºäº†ä¸€ä¸ªready chan,ä»¥ä¾¿è¢«é€šçŸ¥å”¤é†’\n\t\tready := make(chan struct{})\n\t\tw := waiter{n: n, ready: ready}\n\t\telem := s.waiters.PushBack(w)\n\t\ts.mu.Unlock()\n\t\n\n        // ç­‰å¾…\n\t\tselect {\n\t\tcase &lt;-ctx.Done(): // contextçš„Doneè¢«å…³é—­\n\t\t\terr := ctx.Err()\n\t\t\ts.mu.Lock()\n\t\t\tselect {\n\t\t\tcase &lt;-ready: // å¦‚æœè¢«å”¤é†’äº†ï¼Œå¿½ç•¥ctxçš„çŠ¶æ€\n\t\t\t\terr = nil\n\t\t\tdefault: é€šçŸ¥waiter\n\t\t\t\tisFront := s.waiters.Front() == elem\n\t\t\t\ts.waiters.Remove(elem)\n\t\t\t\t// é€šçŸ¥å…¶å®ƒçš„waiters,æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æº\n\t\t\t\tif isFront &amp;&amp; s.size &gt; s.cur {\n\t\t\t\t\ts.notifyWaiters()\n\t\t\t\t}\n\t\t\t}\n\t\t\ts.mu.Unlock()\n\t\t\treturn err\n\t\tcase &lt;-ready: // è¢«å”¤é†’äº†\n\t\t\treturn nil\n\t\t}\n\t}\n</code></pre><p>å…¶å®ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­çš„fast pathä¹‹å¤–çš„ä»£ç ï¼Œå¯ä»¥æŠ½å–æˆacquireSlowæ–¹æ³•ï¼Œä»¥ä¾¿å…¶å®ƒAcquireè¢«å†…è”ã€‚</p><p>Releaseæ–¹æ³•å°†å½“å‰è®¡æ•°å€¼å‡å»é‡Šæ”¾çš„èµ„æºæ•°nï¼Œå¹¶å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è°ƒç”¨è€…ï¼Œçœ‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºè¢«è·å–ã€‚</p><pre><code>func (s *Weighted) Release(n int64) {\n\t\ts.mu.Lock()\n\t\ts.cur -= n\n\t\tif s.cur &lt; 0 {\n\t\t\ts.mu.Unlock()\n\t\t\tpanic(&quot;semaphore: released more than held&quot;)\n\t\t}\n\t\ts.notifyWaiters()\n\t\ts.mu.Unlock()\n}\n</code></pre><p>notifyWaitersæ–¹æ³•å°±æ˜¯é€ä¸ªæ£€æŸ¥ç­‰å¾…çš„è°ƒç”¨è€…ï¼Œå¦‚æœèµ„æºä¸å¤Ÿï¼Œæˆ–è€…æ˜¯æ²¡æœ‰ç­‰å¾…è€…äº†ï¼Œå°±è¿”å›ï¼š</p><pre><code>func (s *Weighted) notifyWaiters() {\n\t\tfor {\n\t\t\tnext := s.waiters.Front()\n\t\t\tif next == nil {\n\t\t\t\tbreak // No more waiters blocked.\n\t\t\t}\n\t\n\n\t\t\tw := next.Value.(waiter)\n\t\t\tif s.size-s.cur &lt; w.n {\n\t\t\t\t//é¿å…é¥¥é¥¿ï¼Œè¿™é‡Œè¿˜æ˜¯æŒ‰ç…§å…ˆå…¥å…ˆå‡ºçš„æ–¹å¼å¤„ç†\n\t\t\t\tbreak\n\t\t\t}\n\n\t\t\ts.cur += w.n\n\t\t\ts.waiters.Remove(next)\n\t\t\tclose(w.ready)\n\t\t}\n\t}\n</code></pre><p>notifyWaitersæ–¹æ³•æ˜¯æŒ‰ç…§å…ˆå…¥å…ˆå‡ºçš„æ–¹å¼å”¤é†’è°ƒç”¨è€…ã€‚å½“é‡Šæ”¾100ä¸ªèµ„æºçš„æ—¶å€™ï¼Œå¦‚æœç¬¬ä¸€ä¸ªç­‰å¾…è€…éœ€è¦101ä¸ªèµ„æºï¼Œé‚£ä¹ˆï¼Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…è€…éƒ½ä¼šç»§ç»­ç­‰å¾…ï¼Œå³ä½¿æœ‰çš„ç­‰å¾…è€…åªéœ€è¦1ä¸ªèµ„æºã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…é¥¥é¥¿ï¼Œå¦åˆ™çš„è¯ï¼Œèµ„æºå¯èƒ½æ€»æ˜¯è¢«é‚£äº›è¯·æ±‚èµ„æºæ•°å°çš„è°ƒç”¨è€…è·å–ï¼Œè¿™æ ·ä¸€æ¥ï¼Œè¯·æ±‚èµ„æºæ•°å·¨å¤§çš„è°ƒç”¨è€…ï¼Œå°±æ²¡æœ‰æœºä¼šè·å¾—èµ„æºäº†ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œä½ å°±çŸ¥é“äº†å®˜æ–¹æ‰©å±•åº“çš„ä¿¡å·é‡å®ç°æ–¹æ³•ï¼Œæ¥ä¸‹æ¥ä½ å°±å¯ä»¥ä½¿ç”¨ä¿¡å·é‡äº†ã€‚ä¸è¿‡ï¼Œåœ¨æ­¤ä¹‹å‰å‘¢ï¼Œæˆ‘æƒ³ç»™ä½ è®²å‡ ä¸ªä½¿ç”¨æ—¶çš„å¸¸è§é”™è¯¯ã€‚è¿™éƒ¨åˆ†å†…å®¹å¯æ˜¯å¸®åŠ©ä½ é¿å‘çš„ï¼Œæˆ‘å»ºè®®ä½ å¥½å¥½å­¦ä¹ ã€‚</p><h1>ä½¿ç”¨ä¿¡å·é‡çš„å¸¸è§é”™è¯¯</h1><p>ä¿è¯ä¿¡å·é‡ä¸å‡ºé”™çš„å‰ææ˜¯æ­£ç¡®åœ°ä½¿ç”¨å®ƒï¼Œå¦åˆ™ï¼Œå…¬å¹³æ€§å’Œå®‰å…¨æ€§å°±ä¼šå—åˆ°æŸå®³ï¼Œå¯¼è‡´ç¨‹åºpanicã€‚</p><p>åœ¨ä½¿ç”¨ä¿¡å·é‡æ—¶ï¼Œæœ€å¸¸è§çš„å‡ ä¸ªé”™è¯¯å¦‚ä¸‹ï¼š</p><ul>\n<li>è¯·æ±‚äº†èµ„æºï¼Œä½†æ˜¯å¿˜è®°é‡Šæ”¾å®ƒï¼›</li>\n<li>é‡Šæ”¾äº†ä»æœªè¯·æ±‚çš„èµ„æºï¼›</li>\n<li>é•¿æ—¶é—´æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå³ä½¿ä¸éœ€è¦å®ƒï¼›</li>\n<li>ä¸æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå´ç›´æ¥ä½¿ç”¨å®ƒã€‚</li>\n</ul><p>ä¸è¿‡ï¼Œå³ä½¿ä½ è§„é¿äº†è¿™äº›å‘ï¼Œåœ¨åŒæ—¶ä½¿ç”¨å¤šç§èµ„æºï¼Œä¸åŒçš„ä¿¡å·é‡æ§åˆ¶ä¸åŒçš„èµ„æºçš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½ä¼šå‡ºç°æ­»é”ç°è±¡ï¼Œæ¯”å¦‚<a href=\"https://en.wikipedia.org/wiki/Dining_philosophers_problem\">å“²å­¦å®¶å°±é¤é—®é¢˜</a>ã€‚</p><p>å°±Goæ‰©å±•åº“å®ç°çš„ä¿¡å·é‡æ¥è¯´ï¼Œåœ¨è°ƒç”¨Releaseæ–¹æ³•çš„æ—¶å€™ï¼Œä½ å¯ä»¥ä¼ é€’ä»»æ„çš„æ•´æ•°ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ä¼ é€’ä¸€ä¸ªæ¯”è¯·æ±‚åˆ°çš„æ•°é‡å¤§çš„é”™è¯¯çš„æ•°å€¼ï¼Œç¨‹åºå°±ä¼španicã€‚å¦‚æœä¼ é€’ä¸€ä¸ªè´Ÿæ•°ï¼Œä¼šå¯¼è‡´èµ„æºæ°¸ä¹…è¢«æŒæœ‰ã€‚å¦‚æœä½ è¯·æ±‚çš„èµ„æºæ•°æ¯”æœ€å¤§çš„èµ„æºæ•°è¿˜å¤§ï¼Œé‚£ä¹ˆï¼Œè°ƒç”¨è€…å¯èƒ½æ°¸è¿œè¢«é˜»å¡ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>ä½¿ç”¨ä¿¡å·é‡éµå¾ªçš„åŸåˆ™å°±æ˜¯è¯·æ±‚å¤šå°‘èµ„æºï¼Œå°±é‡Šæ”¾å¤šå°‘èµ„æº</strong>ã€‚ä½ ä¸€å®šè¦æ³¨æ„ï¼Œå¿…é¡»ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•ä¼ é€’æ•´æ•°ï¼Œä¸è¦â€œè€å°èªæ˜â€ï¼Œè€Œä¸”ï¼Œè¯·æ±‚çš„èµ„æºæ•°ä¸€å®šä¸è¦è¶…è¿‡æœ€å¤§èµ„æºæ•°ã€‚</p><h1>å…¶å®ƒä¿¡å·é‡çš„å®ç°</h1><p>é™¤äº†å®˜æ–¹æ‰©å±•åº“çš„å®ç°ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šæ–¹æ³•å®ç°ä¿¡å·é‡ï¼Œæ¯”è¾ƒå…¸å‹çš„å°±æ˜¯ä½¿ç”¨Channelæ¥å®ç°ã€‚</p><p>æ ¹æ®ä¹‹å‰çš„Channelç±»å‹çš„ä»‹ç»ä»¥åŠGoå†…å­˜æ¨¡å‹çš„å®šä¹‰ï¼Œä½ åº”è¯¥èƒ½æƒ³åˆ°ï¼Œä½¿ç”¨ä¸€ä¸ªbufferä¸ºnçš„Channelå¾ˆå®¹æ˜“å®ç°ä¿¡å·é‡ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å°±æ˜¯ä½¿ç”¨chan struct{}ç±»å‹æ¥å®ç°çš„ã€‚</p><p>åœ¨åˆå§‹åŒ–è¿™ä¸ªä¿¡å·é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®¾ç½®å®ƒçš„åˆå§‹å®¹é‡ï¼Œä»£è¡¨æœ‰å¤šå°‘ä¸ªèµ„æºå¯ä»¥ä½¿ç”¨ã€‚å®ƒä½¿ç”¨Lockå’ŒUnlockæ–¹æ³•å®ç°è¯·æ±‚èµ„æºå’Œé‡Šæ”¾èµ„æºï¼Œæ­£å¥½å®ç°äº†Lockeræ¥å£ã€‚</p><pre><code>\t// Semaphore æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”è¿˜å®ç°äº†Lockeræ¥å£\n\ttype semaphore struct {\n\t\tsync.Locker\n\t\tch chan struct{}\n\t}\n\t\n\t// åˆ›å»ºä¸€ä¸ªæ–°çš„ä¿¡å·é‡\n\tfunc NewSemaphore(capacity int) sync.Locker {\n\t\tif capacity &lt;= 0 {\n\t\t\tcapacity = 1 // å®¹é‡ä¸º1å°±å˜æˆäº†ä¸€ä¸ªäº’æ–¥é”\n\t\t}\n\t\treturn &amp;semaphore{ch: make(chan struct{}, capacity)}\n\t}\n\t\n\t// è¯·æ±‚ä¸€ä¸ªèµ„æº\n\tfunc (s *semaphore) Lock() {\n\t\ts.ch &lt;- struct{}{}\n\t}\n\t\n\t// é‡Šæ”¾èµ„æº\n\tfunc (s *semaphore) Unlock() {\n\t\t&lt;-s.ch\n\t}\n</code></pre><p>å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥è‡ªå·±æ‰©å±•ä¸€äº›æ–¹æ³•ï¼Œæ¯”å¦‚åœ¨è¯·æ±‚èµ„æºçš„æ—¶å€™ä½¿ç”¨Contextå‚æ•°ï¼ˆAcquire(ctx)ï¼‰ã€å®ç°TryLockç­‰åŠŸèƒ½ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œè¿™ä¸ªä¿¡å·é‡çš„å®ç°çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œè€Œä¸”ä¹Ÿèƒ½åº”å¯¹å¤§éƒ¨åˆ†çš„ä¿¡å·é‡çš„åœºæ™¯ï¼Œä¸ºä»€ä¹ˆå®˜æ–¹æ‰©å±•åº“çš„ä¿¡å·é‡çš„å®ç°ä¸é‡‡ç”¨è¿™ç§æ–¹æ³•å‘¢ï¼Ÿå…¶å®ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆåŸå› ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œä½†æ˜¯æˆ‘å¿…é¡»è¦å¼ºè°ƒçš„æ˜¯ï¼Œå®˜æ–¹çš„å®ç°æ–¹å¼æœ‰è¿™æ ·ä¸€ä¸ªåŠŸèƒ½ï¼š<strong>å®ƒå¯ä»¥ä¸€æ¬¡è¯·æ±‚å¤šä¸ªèµ„æºï¼Œè¿™æ˜¯é€šè¿‡Channelå®ç°çš„ä¿¡å·é‡æ‰€ä¸å…·å¤‡çš„</strong>ã€‚</p><p>é™¤äº†Channelï¼Œ<a href=\"https://github.com/marusama/semaphore\">marusama/semaphore</a>ä¹Ÿå®ç°äº†ä¸€ä¸ªå¯ä»¥åŠ¨æ€æ›´æ”¹èµ„æºå®¹é‡çš„ä¿¡å·é‡ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç‰¹è‰²çš„å®ç°ã€‚å¦‚æœä½ çš„èµ„æºæ•°é‡å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæˆ‘å»ºè®®ä½ è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªä¿¡å·é‡åº“ã€‚</p><h1>æ€»ç»“</h1><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ç°è±¡ï¼šæ ‡å‡†åº“ä¸­å®ç°åŸºæœ¬å¹¶å‘åŸè¯­ï¼ˆæ¯”å¦‚Mutexï¼‰çš„æ—¶å€™ï¼Œå¼ºçƒˆä¾èµ–ä¿¡å·é‡å®ç°ç­‰å¾…é˜Ÿåˆ—å’Œé€šçŸ¥å”¤é†’ï¼Œä½†æ˜¯ï¼Œæ ‡å‡†åº“ä¸­å´æ²¡æœ‰æŠŠè¿™ä¸ªå®ç°ç›´æ¥æš´éœ²å‡ºæ¥æ”¾åˆ°æ ‡å‡†åº“ï¼Œè€Œæ˜¯é€šè¿‡ç¬¬ä¸‰åº“æä¾›ã€‚</p><p>ä¸ç®¡æ€æ ·ï¼Œä¿¡å·é‡è¿™ä¸ªå¹¶å‘åŸè¯­åœ¨å¤šèµ„æºå…±äº«çš„å¹¶å‘æ§åˆ¶çš„åœºæ™¯ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šè¢«Channelç±»å‹æ‰€å–ä»£ï¼Œå› ä¸ºä¸€ä¸ªbuffered chanä¹Ÿå¯ä»¥ä»£è¡¨nä¸ªèµ„æºã€‚</p><p>ä½†æ˜¯ï¼Œå®˜æ–¹æ‰©å±•çš„ä¿¡å·é‡ä¹Ÿæœ‰å®ƒçš„ä¼˜åŠ¿ï¼Œå°±æ˜¯å¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªèµ„æºã€‚<strong>åœ¨æ‰¹é‡è·å–èµ„æºçš„åœºæ™¯ä¸­ï¼Œæˆ‘å»ºè®®ä½ å°è¯•ä½¿ç”¨å®˜æ–¹æ‰©å±•çš„ä¿¡å·é‡</strong>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/67/73/674bc464d4e3d11c96fa1ac71d317e73.jpg?wh=2250*1413\" alt=\"\"></p><h1>æ€è€ƒé¢˜</h1><ol>\n<li>ä½ èƒ½ç”¨Channelå®ç°ä¿¡å·é‡å¹¶å‘åŸè¯­å—ï¼Ÿä½ èƒ½æƒ³åˆ°å‡ ç§å®ç°æ–¹å¼ï¼Ÿ</li>\n<li>ä¸ºä»€ä¹ˆä¿¡å·é‡çš„èµ„æºæ•°è®¾è®¡æˆint64è€Œä¸æ˜¯uint64å‘¢ï¼Ÿ</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","neighbors":{"left":{"article_title":"15 | å†…å­˜æ¨¡å‹ï¼šGoå¦‚ä½•ä¿è¯å¹¶å‘è¯»å†™çš„é¡ºåºï¼Ÿ","id":307469},"right":{"article_title":"17 | SingleFlight å’Œ CyclicBarrierï¼šè¯·æ±‚åˆå¹¶å’Œå¾ªç¯æ …æ è¯¥æ€ä¹ˆç”¨ï¼Ÿ","id":309098}},"comments":[{"had_liked":false,"id":271253,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1609493326,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"66034002766","product_id":100061801,"comment_content":"è¡¥å……è¯´æ˜ä¸‹ ä¿¡å·é‡ p&#47;vçš„å«ä¹‰ï¼š<br>Pâ€”â€” passerenï¼Œä¸­æ–‡è¯‘ä¸º&quot;é€šè¿‡&quot;ï¼ŒVâ€”â€” vrijgevenï¼Œä¸­æ–‡è¯‘ä¸º&quot;é‡Šæ”¾&quot; ï¼ˆå› ä¸ºä½œè€…æ˜¯è·å…°äººï¼Œä¸Šé¢å•è¯ä¸ºè·å…°è¯­ï¼‰","like_count":16,"discussions":[{"author":{"id":1172050,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e2/52/56dbb738.jpg","nickname":"ç‰™å°æœ¨","note":"","ucode":"E5C12D37A62949","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362575,"discussion_content":"é€šè¿‡å’Œé‡Šæ”¾ä¸€ä¸ªæ„â½â½â—( Ë™ ê’³ Ë™ )â—œâ¾â¾so what","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616984712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261695,"user_name":"myrfy","can_delete":false,"product_type":"c1","uid":1169401,"ip_address":"","ucode":"2814BAE5D70098","user_header":"","comment_is_top":false,"comment_ctime":1605491583,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31670262655","product_id":100061801,"comment_content":"ç¬¬ä¸€ä¸ªé—®é¢˜:<br>è‡³å°‘ä¸¤ç§ï¼Œå†™å…¥chç®—è·å–ï¼Œè‡ªå·±è¯»å–chç®—è·å–<br><br>ç¬¬äºŒä¸ªé—®é¢˜åº”è¯¥æ˜¯é˜²æ­¢é”™è¯¯è·å–æˆ–è€…é‡Šæ”¾ä¿¡å·é‡æ—¶ï¼Œå‡ºç°è´Ÿæ•°æº¢å‡ºåˆ°æ— ç©·å¤§çš„é—®é¢˜ã€‚å¦‚æœæº¢å‡ºåˆ°æ— ç©·å¤§ï¼Œå°±ä¼šè®©ä¿¡å·é‡å¤±æ•ˆï¼Œä»è€Œå¯¼è‡´1è¢«ä¿æŠ¤èµ„æºæ›´å¤§è§„æ¨¡çš„ç ´å","like_count":7},{"had_liked":false,"id":267761,"user_name":"æœ¨å¤´å‘èŠ½","can_delete":false,"product_type":"c1","uid":1419723,"ip_address":"","ucode":"657B381C5DA963","user_header":"https://static001.geekbang.org/account/avatar/00/15/a9/cb/a431bde5.jpg","comment_is_top":false,"comment_ctime":1607915198,"is_pvip":false,"replies":[{"id":"97554","content":"atomicå’Œgopark,å‚è€ƒruntime&#47;sema.go","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1608468195,"ip_address":"","comment_id":267761,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10197849790","product_id":100061801,"comment_content":"semaphoreæ˜¯ç”¨Mutexå’ŒChannelé€šçŸ¥å®ç°çš„,è€ŒMutexåˆä¾èµ–äºgoå†…éƒ¨çš„ä¿¡å·é‡å®ç°,é‚£è¿™ä¸ªå†…éƒ¨çš„ä¿¡å·é‡åˆæ˜¯ç”¨ä»€ä¹ˆå®ç°çš„?","like_count":2,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511733,"discussion_content":"atomicå’Œgopark,å‚è€ƒruntime/sema.go","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608468195,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263025,"user_name":"å¤§æ¼ èƒ¡èåœ","can_delete":false,"product_type":"c1","uid":1198953,"ip_address":"","ucode":"FBE51E4A13EF4F","user_header":"https://static001.geekbang.org/account/avatar/00/12/4b/69/c02eac91.jpg","comment_is_top":false,"comment_ctime":1605951500,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10195886092","product_id":100061801,"comment_content":"åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ²¡æ€ä¹ˆä½¿ç”¨ä¿¡å·é‡semaphoreï¼Œä¸€èˆ¬ä½¿ç”¨channelæ¥è§£å†³è¿™ç§é—®é¢˜ã€‚<br>å¦å¤–ï¼Œå¹¶å‘çš„æ—¶å€™ä½¿ç”¨æ± åŒ–æŠ€æœ¯æ„Ÿè§‰æ›´åŠ é€šç”¨å§ã€‚","like_count":2},{"had_liked":false,"id":261851,"user_name":"åˆšå­","can_delete":false,"product_type":"c1","uid":1017080,"ip_address":"","ucode":"7B55EC80A7A4A9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/84/f8/c22d32b4.jpg","comment_is_top":false,"comment_ctime":1605538024,"is_pvip":false,"replies":[{"id":"95056","content":"æ„æ€æ˜¯é€šè¿‡ä¸€æ¬¡è°ƒç”¨ï¼Œåªèƒ½ä»chanä¸­è·å–ä¸€ä¸ªå€¼ï¼Œå¤šä¸ªã€‚goroutineéœ€è¦è°ƒç”¨å¤šæ¬¡æ‰èƒ½å¾—åˆ°nä¸ªå€¼","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605575224,"ip_address":"","comment_id":261851,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10195472616","product_id":100061801,"comment_content":"ä¸æ˜¯å¾ˆç†è§£è¿™å¥è¯ ï¼š&quot;ä¸€æ¬¡è¯·æ±‚å¤šä¸ªèµ„æºï¼Œè¿™æ˜¯é€šè¿‡ Channel å®ç°çš„ä¿¡å·é‡æ‰€ä¸å…·å¤‡çš„ã€‚&quot;<br>Channel ä¹Ÿå¯ä»¥å¼€å¯å¤šä¸ªgoroutine å»è¯·æ±‚å¤šä¸ªèµ„æº","like_count":2,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509637,"discussion_content":"æ„æ€æ˜¯é€šè¿‡ä¸€æ¬¡è°ƒç”¨ï¼Œåªèƒ½ä»chanä¸­è·å–ä¸€ä¸ªå€¼ï¼Œå¤šä¸ªã€‚goroutineéœ€è¦è°ƒç”¨å¤šæ¬¡æ‰èƒ½å¾—åˆ°nä¸ªå€¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605575224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353219,"user_name":"Geek_a6104e","can_delete":false,"product_type":"c1","uid":1711967,"ip_address":"åŒ—äº¬","ucode":"29A56792216DC8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/GJXKh8OG00U5ial64plAIibbIuwkzhPc8uYic9Hibl8SbqvhnS2JImHgCD4JGvTktiaVnCjHQWbA5wicaxRUN5aTEWnQ/132","comment_is_top":false,"comment_ctime":1659274484,"is_pvip":false,"replies":[{"id":"128580","content":"ç­‰äºä½ çš„èµ„æºæ•°ã€‚é¢„å…ˆç¡®å®šå¥½","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1659660512,"ip_address":"åŒ—äº¬","comment_id":353219,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1659274484","product_id":100061801,"comment_content":"return &amp;semaphore{ch: make(chan struct{}, capacity)} è¯·é—®ä¸€ä¸‹æœ€åä¸€ä¸ªä¾‹å­semaphoreç»“æ„åˆå§‹åŒ–ä¸ºå•¥ä¼šå¤šä¸ªcapacity","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582756,"discussion_content":"ç­‰äºä½ çš„èµ„æºæ•°ã€‚é¢„å…ˆç¡®å®šå¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659660513,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":329615,"user_name":"8.13.3.27.30","can_delete":false,"product_type":"c1","uid":1556358,"ip_address":"","ucode":"2DE3CE3E338BAB","user_header":"https://static001.geekbang.org/account/avatar/00/17/bf/86/c0cb35f0.jpg","comment_is_top":false,"comment_ctime":1641446746,"is_pvip":false,"replies":[{"id":"120140","content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1641554932,"ip_address":"","comment_id":329615,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1641446746","product_id":100061801,"comment_content":"æ‰“å¡å®Œæˆ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544541,"discussion_content":"ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641554932,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308275,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1629511399,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629511399","product_id":100061801,"comment_content":"https:&#47;&#47;github.com&#47;zzm996-zzm&#47;go-concurrent&#47;blob&#47;main&#47;semaphore&#47;semaphore.go<br>åŸºäºchanå®ç°çš„ä¿¡å·é‡ å…¶å®å’Œæ–‡ç« ä¸­çš„æ€è·¯æ˜¯ä¸€æ ·çš„ ä¸è¿‡å…¨éƒ½æ˜¯è‡ªå·±å®ç°çš„","like_count":0},{"had_liked":false,"id":308239,"user_name":"å‹","can_delete":false,"product_type":"c1","uid":2536820,"ip_address":"","ucode":"972A4333A8B101","user_header":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","comment_is_top":false,"comment_ctime":1629465429,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1629465429","product_id":100061801,"comment_content":"æ€»ç»“ä¸€ä¸‹ï¼Œé˜»å¡çš„æ“ä½œå°±æ˜¯ä¾é è¯»å–æ— ç¼“å†²chanæ¥çš„ï¼Œå”¤é†’çš„æ“ä½œå°±æ˜¯æŠŠchan closeæ‰ã€‚ä¸ºäº†é¿å…é¥¥é¥¿éœ€è¦ä¸¥æ ¼éµå®ˆé˜Ÿåˆ—æ¡ä»¶ï¼Œä¸ä¼šå› ä¸ºå°å°±æ”¾è¡Œï¼Œå¿…é¡»å…ˆæ»¡è¶³é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªçš„éœ€æ±‚ æ‰ä¼šå¼€å§‹ç¬¬äºŒä¸ªã€‚<br>ä¸¤ä¸ªselect å°±æ˜¯ä¸ºäº†åŒé‡æ£€æŸ¥ï¼Œå³ä½¿è¶…æ—¶äº†ä¹Ÿæ£€æŸ¥çœ‹çœ‹æ˜¯å¦è·å–åˆ°äº†ä¿¡å·é‡ã€‚<br>å¯¹æ¯”çº¯chançš„ä¼˜åŠ¿æ˜¯ ï¼Œchanä¸€æ¬¡å°±åªèƒ½è¯»å–ä¸€ä¸ª,ä½†æ˜¯è¿™ä¸ªåªéœ€è¦ç»™ä¸€ä¸ªintå°±å¯ä»¥è·å–åˆ°å¯¹åº”æ•°é‡æ˜¯ä¿¡å·é‡ <br>","like_count":0},{"had_liked":false,"id":263348,"user_name":"ä¼Ÿä¼Ÿ","can_delete":false,"product_type":"c1","uid":1060937,"ip_address":"","ucode":"F0B393FC6E1098","user_header":"https://static001.geekbang.org/account/avatar/00/10/30/49/f9e37ced.jpg","comment_is_top":false,"comment_ctime":1606111676,"is_pvip":true,"replies":[{"id":"95573","content":"å”¯ä¸€å­˜åœ¨çš„é—®é¢˜æ˜¯å¯èƒ½å‡ºç°æ­»é”ã€‚<br>æ¯”å¦‚ä¿¡å·é‡æ˜¯10ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªgoroutineè¯·æ±‚8ä¸ªèµ„æºã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1606133298,"ip_address":"","comment_id":263348,"utype":1}],"discussion_count":5,"race_medal":0,"score":"1606111676","product_id":100061801,"comment_content":"type Semaphore chan struct{}<br><br>func NewSemaphore(cap int) Semaphore {<br>\treturn make(chan struct{}, cap)<br>}<br><br>func (s Semaphore) Acquire(n int) {<br>\tfor i := 0; i &lt; n; i++ {<br>\t\ts &lt;- struct{}{}<br>\t}<br>}<br><br>func (s Semaphore) Release(n int) {<br>\tfor i := 0; i &lt; n; i++ {<br>\t\t&lt;-s<br>\t}<br>}<br><br>func NewSemaphore2(cap int) Semaphore {<br>\tsem := make(chan struct{}, cap)<br>\tfor i := 0; i &lt; cap; i++ {<br>\t\tsem &lt;- struct{}{}<br>\t}<br>\treturn sem<br>}<br><br>func (s Semaphore) Acquire2(n int) {<br>\tfor i := 0; i &lt; n; i++ {<br>\t\t&lt;-s<br>\t}<br>}<br><br>func (s Semaphore) Release2(n int) {<br>\tfor i := 0; i &lt; n; i++ {<br>\t\ts &lt;- struct{}{}<br>\t}<br>}","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510155,"discussion_content":"å”¯ä¸€å­˜åœ¨çš„é—®é¢˜æ˜¯å¯èƒ½å‡ºç°æ­»é”ã€‚\næ¯”å¦‚ä¿¡å·é‡æ˜¯10ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªgoroutineè¯·æ±‚8ä¸ªèµ„æºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606133298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2046604,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/3a/8c/fc2c3e5c.jpg","nickname":"xl666","note":"","ucode":"CF9A8086F91053","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550547,"discussion_content":"è¦åŠ é”å§å“ˆ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644583231,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"å‹","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389913,"discussion_content":"ä¹‹å‰ä¿¡å·é‡ä¸Šé¢çš„ä¾‹å­éƒ½æ˜¯åˆ¤æ–­ ï¼Œæ˜¯å¦è¶³å¤Ÿï¼Œä¸è¶³å¤Ÿåˆ™ä¼šä¼‘çœ ã€‚ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629503942,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1060937,"avatar":"https://static001.geekbang.org/account/avatar/00/10/30/49/f9e37ced.jpg","nickname":"ä¼Ÿä¼Ÿ","note":"","ucode":"F0B393FC6E1098","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328933,"discussion_content":"type Semaphore struct {\n\tch chan struct{}\n}\n\nfunc NewSemaphore(cap int) *Semaphore {\n\treturn &amp;Semaphore{\n\t\tch: make(chan struct{}, cap),\n\t}\n}\n\nfunc (s *Semaphore) Acquire(n int) error {\n\t// todo è¿™é‡Œæ˜¯å¦éœ€è¦é”æ“ä½œ\n\tfor i := 0; i < n; i++ {\n\t\tselect {\n\t\tcase s.ch <- struct{}{}:\n\n\t\tdefault:\n\t\t\treturn errors.New(&#34;acquire failed&#34;)\n\t\t}\n\t}\n\treturn nil\n}\n\nfunc (s *Semaphore) Release(n int) {\n\tfor i := 0; i < n; i++ {\n\t\t<-s.ch\n\t}\n}\n\nè€å¸ˆè¿™é‡Œtodoå¤„æ˜¯å¦éœ€è¦ï¼Œå¦‚æœæœ‰10ä¸ªä¿¡å·é‡ï¼Œä¸¤ä¸ªgoroutinueéƒ½æƒ³è¦8ä¸ªï¼ŒåŒæ—¶éƒ½ä¼šè·å–5ä¸ªäº†ï¼Œéƒ½ä¸èƒ½æˆåŠŸã€‚å¦‚æœåŠ é”æ€§èƒ½æœ‰å½±å“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606275153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1229778,"avatar":"https://static001.geekbang.org/account/avatar/00/12/c3/d2/3c3382e1.jpg","nickname":"æƒ³é£çš„é±¼","note":"","ucode":"1BDED70ACF0505","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1060937,"avatar":"https://static001.geekbang.org/account/avatar/00/10/30/49/f9e37ced.jpg","nickname":"ä¼Ÿä¼Ÿ","note":"","ucode":"F0B393FC6E1098","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":337274,"discussion_content":"ä¸ç”¨ç«äº‰ï¼Œä½ è‡ªå·±éƒ½ä¼šæ­»é”ã€‚ä½ å¾ªç¯è·å–ï¼Œåˆ°ä¸€åŠå‘ç°ä¸å¤Ÿç›´æ¥returnäº†ï¼Ÿä½ å·²ç»æ‹¿çš„ä¸åå‡ºæ¥ï¼Ÿæ°¸è¿œæ¶ˆå¤±ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608859467,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328933,"ip_address":""},"score":337274,"extra":""}]}]},{"had_liked":false,"id":262498,"user_name":"è™«å­æ¨±æ¡ƒ","can_delete":false,"product_type":"c1","uid":1226331,"ip_address":"","ucode":"F8244A9E9BC5A6","user_header":"https://static001.geekbang.org/account/avatar/00/12/b6/5b/4486e4f9.jpg","comment_is_top":false,"comment_ctime":1605751621,"is_pvip":false,"replies":[{"id":"95272","content":"è¿™ä¸ªæ›´å¤šæ˜¯ç”¨ratelimiter,ä¿¡å·é‡ä¸»è¦å¹¶å‘è®¿é—®nä¸ªèµ„æºçš„åœºæ™¯","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605765978,"ip_address":"","comment_id":262498,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1605751621","product_id":100061801,"comment_content":"è€å¸ˆçš„ä¾‹å­é‡Œé¢ï¼Œæ˜¯é€šè¿‡ è®¡ç®—æœºçš„åç¨‹ runtime.GOMAXPROCS(0) æ¥æ¨¡æ‹Ÿæœ‰é™çš„èµ„æºï¼ˆæ¯”å–»ä¾‹å­é‡Œé¢çš„ä¹¦ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªsemaphoreçš„åœºæ™¯æ˜¯ä¸æ˜¯å°±æ˜¯æ¯”è¾ƒé€‚ç”¨äºè¯·æ±‚æœ‰æµé‡æˆ–è€…è°ƒç”¨æ¬¡æ•°é™åˆ¶çš„åœºæ™¯å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509859,"discussion_content":"è¿™ä¸ªæ›´å¤šæ˜¯ç”¨ratelimiter,ä¿¡å·é‡ä¸»è¦å¹¶å‘è®¿é—®nä¸ªèµ„æºçš„åœºæ™¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605765978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262021,"user_name":"Ethan Liu","can_delete":false,"product_type":"c1","uid":1070043,"ip_address":"","ucode":"231F944F7CD56A","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg","comment_is_top":false,"comment_ctime":1605607609,"is_pvip":true,"replies":[{"id":"95089","content":"ç†è§£äº†ctx,ä¹Ÿå°±ç†è§£selectã€‚å½“å¤–éƒ¨contexté€šçŸ¥å–æ¶ˆè¯·æ±‚æ—¶ï¼Œä¼šåœ¨æ£€æŸ¥ä¸€ä¸‹å½“å‰æ˜¯å¦è¯·æ±‚æˆåŠŸäº†","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605611248,"ip_address":"","comment_id":262021,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1605607609","product_id":100061801,"comment_content":"è€å¸ˆï¼ŒAcquireå‡½æ•°ä¸ºä»€ä¹ˆè¿˜ä¼šæœ‰ç¬¬äºŒä¸ªselectè¯­å¥ï¼Ÿè¿™éƒ¨åˆ†é€»è¾‘æ˜¯ä»€ä¹ˆå•Šï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509689,"discussion_content":"ç†è§£äº†ctx,ä¹Ÿå°±ç†è§£selectã€‚å½“å¤–éƒ¨contexté€šçŸ¥å–æ¶ˆè¯·æ±‚æ—¶ï¼Œä¼šåœ¨æ£€æŸ¥ä¸€ä¸‹å½“å‰æ˜¯å¦è¯·æ±‚æˆåŠŸäº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605611248,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2730577,"avatar":"","nickname":"kdocsæœåŠ¡ç»„2","note":"","ucode":"F1B0D5EB2E4B31","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":532097,"discussion_content":"å¯ä»¥ç†è§£æˆå†ç»™ä¸€æ¬¡å¤æ´»çš„æœºä¼šå—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637512762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":509689,"ip_address":""},"score":532097,"extra":"{\"user_type\":1}"}]},{"author":{"id":1368768,"avatar":"https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg","nickname":"chongsheng","note":"","ucode":"859DF328FCA608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544298,"discussion_content":"æˆ‘çš„ç†è§£æ˜¯ï¼Œå¦‚æœctxå’Œreadyæ°å¥½åŒæ—¶æ”¶åˆ°æ¶ˆæ¯ï¼Œå¦‚æœselecté€‰äº†ctxçš„æ‰§è¡Œï¼Œå°±ä¼šé”™è¿‡è¿™æ¬¡çš„readyã€‚æ‰€ä»¥åœ¨ctxçš„åˆ†æ”¯é‡Œå†åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦ready","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641460647,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261696,"user_name":"å®¹æ˜“","can_delete":false,"product_type":"c1","uid":1430110,"ip_address":"","ucode":"E89208FA6815EA","user_header":"https://static001.geekbang.org/account/avatar/00/15/d2/5e/f7f45406.jpg","comment_is_top":false,"comment_ctime":1605492844,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605492844","product_id":100061801,"comment_content":"è€å¸ˆçš„é¢˜è¿˜æ˜¯æœ‰éš¾åº¦çš„","like_count":0},{"had_liked":false,"id":261657,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1605482855,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1605482855","product_id":100061801,"comment_content":"æ‰“å¡ã€‚","like_count":0}]}