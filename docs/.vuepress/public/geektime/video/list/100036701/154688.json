{"id":154688,"title":"18 | Netty的那些“锁”事","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":151472,"user_name":"Geek_cyy","can_delete":false,"product_type":"c3","uid":1561474,"ip_address":"","ucode":"5FAB0E666F4F08","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/HZn8Cl8PFrzRNaePhfAMCtiankNG4yf9VmRukH3gzVtsOogq5n4b9ZAFNHThniaXmsibibX17wTZ8kCvKkibges8efA/132","comment_is_top":false,"comment_ctime":1573726697,"is_pvip":false,"replies":[{"id":59060,"content":"pipeline：工厂的流水线\neventloop: 操作流水线工序的实际干活的工人\nchannel:  多套流水线，一个channel配一套流水线（pipeline）。工人（eventloop）共享。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574302662,"ip_address":"","comment_id":151472,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，那pipeline，eventloop，channel之间的关系呢？","like_count":23,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474486,"discussion_content":"pipeline：工厂的流水线\neventloop: 操作流水线工序的实际干活的工人\nchannel:  多套流水线，一个channel配一套流水线（pipeline）。工人（eventloop）共享。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574302662,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156672,"user_name":"冬渐暖","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1574934019,"is_pvip":false,"replies":[{"id":60135,"content":"哈哈，因为直播说了，争取符合996，所以计划9点说完，最后好像9点05结束了，我会把ppt周末重新整理好(直播时的ppt要求右下留个头像空白，所以不太好看)，下周挂git repo上。","user_name":"作者回复","user_name_real":"傅健","uid":1638649,"ctime":1574936300,"ip_address":"","comment_id":156672,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"拿volatile来说线程的同步核心三要素\n●可见性：对一个volatile变量的读，总是能看到(任意线程)对这个volatile变量最后的写入。\n●原子性：对任意单个volatile变量的读&#47;写具有原子性，但类似于volatile++这种复合操作不具有原子性(1读 2加 3赋值)。\n●有序性,是保证线程内串行语义，避免JVM指令重排等。\n\n锁分类\n对竞争这把锁的态度：乐观(JUC下面的原子类)和悲观(( Synchronized)\n能否保证每个线程都能拿到锁：能就是公平(处理数据小的好)，不能就不公平(数据大性能高)\n能不能递归调用的：可重入锁和不可重入锁(可能会死锁，而且线程调度切换是很耗资源)\n是否只能被一个线程持有：能就是独享，不能就是共享锁\n锁的状态：无锁状态、偏向锁状态、轻量级锁状态、重量级锁状态\n看锁的方式：自选锁(傻屌式轮询问能不能用)\n\n\n\n锁的对象和范围，可以影响到锁的粒度\n看了下您举得例子，就类似于java的try cathch吧？不用吧整个方法都给含住，在需要的地方才分开try\n\n原子long(volatile long)和对象大Long(AtomicLong)区别\n大Long因为是对象 除了值，还带了一些信息，比如hash之些的对象头，还有引用地址\n\nnetty会根据jdk的版本来选择更优的方法（跟jvm调优一样），比如新版的jdk(以jdk8为界限)有更好的，它就帮你用jdk自带的。比如你的jdk版本太低了，netty就会把新版jdk的方法复制进去(变相给你升级了jdk)\n\nchannel的局部串行，吧Channel、outbound&#47;inbound、handler这三个弄成一个“类”，然后吧这个类叫做事件处理\n\n\nNetty应用场景下:局部串行+整体并行（少个线程对少个事件）&gt;一个队列+多个线程模式: (全部线程对应全部的事件)\n●降低用户开发难度、 逻辑简单、提升处理性能\n●避免锁带来的上下文切换和并发保护等额外开销(线程之间切换的)\n\n上次看你留言说有个二十多分钟的视频，原来就是在这里，哈哈\n本来周二准备去看你直播的，到十点多一忙完。。看你却下线了。。","like_count":7,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476193,"discussion_content":"哈哈，因为直播说了，争取符合996，所以计划9点说完，最后好像9点05结束了，我会把ppt周末重新整理好(直播时的ppt要求右下留个头像空白，所以不太好看)，下周挂git repo上。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574936300,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144855,"user_name":"灰色","can_delete":false,"product_type":"c3","uid":1178135,"ip_address":"","ucode":"869B400BBD520D","user_header":"https://static001.geekbang.org/account/avatar/00/11/fa/17/d0b8135f.jpg","comment_is_top":false,"comment_ctime":1572076295,"is_pvip":false,"replies":[{"id":57866,"content":"不会增加上下文切换，等于说，本来1个房间，1把锁，现在把房间占地搞小了，锁的次数还是没有什么变化的，只是腾出了更多的非竞争的空间给我们用了。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573549383,"ip_address":"","comment_id":144855,"utype":1}],"discussion_count":5,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"降低锁的粒度，通常会增加了加锁的次数，增加上下文切换次数，那么通过降低锁的粒度，来提升性能的做法，是否需要权衡一下呢？","like_count":6,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472139,"discussion_content":"不会增加上下文切换，等于说，本来1个房间，1把锁，现在把房间占地搞小了，锁的次数还是没有什么变化的，只是腾出了更多的非竞争的空间给我们用了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1573549383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338944,"discussion_content":"老师课上举的例子是对两个不同的实例进行加锁，相对独立，因此减少了锁的粒度","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1609433478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1024294,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","nickname":"null","note":"","ucode":"F9039EFED6B55D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316784,"discussion_content":"加锁次数是增加了，理解如下：\n\npublic synchronized void m() {\n    ...\n    ...\n}\n这里只加一次锁。\n\npublic void m(){\n......\n    synchronized(x) {}\n......\n    synchronized(y) {}\n}\n这里加了两次锁。\n\n但是锁的时间短了，提高了方法m() 的并发能力。类比数据库中的长事务拆解为多个短事务。\n\n一般情况下，如果线程获取到x的monitor，往下执行时，应该也会大概率获取到 y 的 monitor。\n但极端情况下，如机器过载的情况下，应该会增加上下文切换的次数。\n\n以上分析，均无数据支撑，仅是个人理解🤪🤪","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1603455938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1107484,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e6/1c/9d3744ee.jpg","nickname":"程序员俊达","note":"","ucode":"2573037D7C82C8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546909,"discussion_content":"这块需要深入理解一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642468532,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1741153,"avatar":"","nickname":"Geek_Th","note":"","ucode":"D09996D9DAA9A7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":74848,"discussion_content":"可以不可这样理解 粒度小了 还没初见竞争 就已经释放锁了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575696563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154669,"user_name":"cookie.joo","can_delete":false,"product_type":"c3","uid":1588893,"ip_address":"","ucode":"764AEA3729FE6C","user_header":"https://static001.geekbang.org/account/avatar/00/18/3e/9d/33db96a7.jpg","comment_is_top":false,"comment_ctime":1574504618,"is_pvip":false,"replies":[{"id":59376,"content":"\n你这样直接写2句代码：\n        Object o = new Object();\n        o.wait();\n就报错了：\nException in thread &quot;main&quot; java.lang.IllegalMonitorStateException\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.Object.wait(Object.java:502)\n\tat Test.main(Test.java:6)\n要求获取监视器锁，所以这样：\n\nsynchronized（object）{\n...............\n}\n所以才说用起来不舒服。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574516900,"ip_address":"","comment_id":154669,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"请问一下为什么说Object的wati()和notify()等方法要在监视器里面呢？这个点可以说明一下吗？我也是第一次听过这说法。盼复，谢谢","like_count":5,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475542,"discussion_content":"\n你这样直接写2句代码：\n        Object o = new Object();\n        o.wait();\n就报错了：\nException in thread &amp;quot;main&amp;quot; java.lang.IllegalMonitorStateException\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.Object.wait(Object.java:502)\n\tat Test.main(Test.java:6)\n要求获取监视器锁，所以这样：\n\nsynchronized（object）{\n...............\n}\n所以才说用起来不舒服。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574516900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143954,"user_name":"小不点","can_delete":false,"product_type":"c3","uid":1351860,"ip_address":"","ucode":"C307D44A185C34","user_header":"https://static001.geekbang.org/account/avatar/00/14/a0/b4/5173f1af.jpg","comment_is_top":false,"comment_ctime":1571813564,"is_pvip":false,"replies":[{"id":55676,"content":"因为这个地方都是读，没有人去修改","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1571923503,"ip_address":"","comment_id":143954,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师为啥options0()和attrs0()没有线程安全问题","like_count":3,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471760,"discussion_content":"因为这个地方都是读，没有人去修改","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571923503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143917,"user_name":"小不点","can_delete":false,"product_type":"c3","uid":1351860,"ip_address":"","ucode":"C307D44A185C34","user_header":"https://static001.geekbang.org/account/avatar/00/14/a0/b4/5173f1af.jpg","comment_is_top":false,"comment_ctime":1571806915,"is_pvip":false,"replies":[{"id":55543,"content":"距离最后不是不远了么！😂","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1571815881,"ip_address":"","comment_id":143917,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"打卡打卡，希望能坚持到最后","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471745,"discussion_content":"距离最后不是不远了么！😂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571815881,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":177519,"user_name":"Sonny721","can_delete":false,"product_type":"c3","uid":1104291,"ip_address":"","ucode":"C95DD306BFBE54","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/a3/2856b5b5.jpg","comment_is_top":false,"comment_ctime":1581409565,"is_pvip":false,"replies":[{"id":69669,"content":"Handler是单实例还是多实例的？\n\n可以是单例，也可以是多例，根据需求来：如何抉择，在github里的课程资料：直播那个ppt里面有详细介绍。\n\n在Handler中如何处理并发问题？\n没有什么特殊技巧，就是java自带的那些锁&#47;threadlocal之类的使用了，哪些争用保护哪些！","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1582004324,"ip_address":"","comment_id":177519,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师您好，Handler是单实例还是多实例的？在Handler中如何处理并发问题？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483452,"discussion_content":"Handler是单实例还是多实例的？\n\n可以是单例，也可以是多例，根据需求来：如何抉择，在github里的课程资料：直播那个ppt里面有详细介绍。\n\n在Handler中如何处理并发问题？\n没有什么特殊技巧，就是java自带的那些锁/threadlocal之类的使用了，哪些争用保护哪些！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582004324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385559,"user_name":"wallacefw","can_delete":false,"product_type":"c3","uid":1168686,"ip_address":"美国","ucode":"9EC56A542D9927","user_header":"https://static001.geekbang.org/account/avatar/00/11/d5/2e/7ace1d94.jpg","comment_is_top":false,"comment_ctime":1702902831,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"打卡到这里","like_count":0},{"had_liked":false,"id":315925,"user_name":"受超凡","can_delete":false,"product_type":"c3","uid":2678558,"ip_address":"","ucode":"A2A160D483BBB0","user_header":"","comment_is_top":false,"comment_ctime":1634049621,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"加锁多的话jvm本身也有锁粗话的优化，会被优化吗\n","like_count":0},{"had_liked":false,"id":255919,"user_name":"null","can_delete":false,"product_type":"c3","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1603456432,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，您好！请教一下，在计算AtomicLong vs long 的占用空间时，为什么不计算 AtomicLongFieldUpdater 对象所占用的空间吖？\n\n64位的系统：\nlong：8 byte\nAtomic*Updater： 16 bytes 对象头 + 8bytes 引用\n\n8+16+8，和AtomicLong 占用空间一样吖！\n\n不过 Updater 是 static 对象，当创建多个 ChannelOutboundBuffer 对象时，Updater 也是只占一份空间，而AtomicLong 就每个对象占一份空间。","like_count":0,"discussions":[{"author":{"id":1670039,"avatar":"https://static001.geekbang.org/account/avatar/00/19/7b/97/950082a4.jpg","nickname":"fish","note":"","ucode":"EBC306460F2962","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361001,"discussion_content":"看情况更替","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616577119,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230801,"user_name":"N","can_delete":false,"product_type":"c3","uid":1133657,"ip_address":"","ucode":"3791619172D64F","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/59/c75cb36d.jpg","comment_is_top":false,"comment_ctime":1593497942,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师您好，有个地方不是很懂，就是锁本身的大小对空间占用真的有必要关注吗？仅仅不到24个bytes","like_count":0,"discussions":[{"author":{"id":1107484,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e6/1c/9d3744ee.jpg","nickname":"程序员俊达","note":"","ucode":"2573037D7C82C8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546913,"discussion_content":"Netty注重的是高性能，所以才会有这些优化，一个锁降低24bytes，一般都是数十万的连接，那这个数值就会被放大了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642469320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188619,"user_name":"几字凉了秋丶","can_delete":false,"product_type":"c3","uid":1178503,"ip_address":"","ucode":"B1B7A3726AD4E5","user_header":"https://static001.geekbang.org/account/avatar/00/11/fb/87/9c2dc94f.jpg","comment_is_top":false,"comment_ctime":1584374699,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师，请问一下，一个队列 + 多个线程为啥会有锁的上下文切换， 每个线程消费队列里的消息，也是串行的，锁的上下文切换发生在哪","like_count":0,"discussions":[{"author":{"id":1107484,"avatar":"https://static001.geekbang.org/account/avatar/00/10/e6/1c/9d3744ee.jpg","nickname":"程序员俊达","note":"","ucode":"2573037D7C82C8","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546914,"discussion_content":"发生在队列数据的争抢上，这块需要加锁，否则会一个数据被多个线程消费。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642469415,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":179219,"user_name":"杜哲夫","can_delete":false,"product_type":"c3","uid":1547065,"ip_address":"","ucode":"5409A1B64336AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/9b/39/5a15138c.jpg","comment_is_top":false,"comment_ctime":1581938890,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师问一个问题，您说linux默认使关闭keepalive的为什么在你的sample程序中client执行完没有断开连接呢？","like_count":0},{"had_liked":false,"id":154049,"user_name":"李春恒","can_delete":false,"product_type":"c3","uid":1033066,"ip_address":"","ucode":"F2DCA19EC66DC1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c3/6a/3272e095.jpg","comment_is_top":false,"comment_ctime":1574355971,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"服务员固定包厢，类似于NGINX中的亲核特性affinity，避免竞争和切换","like_count":0}]}