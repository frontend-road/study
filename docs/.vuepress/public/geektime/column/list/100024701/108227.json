{"id":108227,"title":"48 | æ¥æ”¶ç½‘ç»œåŒ…ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ææ˜ç™½åˆä½œä¼™ä¼´è®©æˆ‘ä»¬åšä»€ä¹ˆï¼Ÿ","content":"<p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬è§£æäº†ç½‘ç»œåŒ…æ¥æ”¶çš„ä¸ŠåŠéƒ¨åˆ†ï¼Œä»ç¡¬ä»¶ç½‘å¡åˆ°IPå±‚ã€‚è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥ç€æ¥è§£æTCPå±‚å’ŒSocketå±‚éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚</p><h2>ç½‘ç»œåè®®æ ˆçš„TCPå±‚</h2><p>ä»tcp_v4_rcvå‡½æ•°å¼€å§‹ï¼Œæˆ‘ä»¬çš„å¤„ç†é€»è¾‘å°±ä»IPå±‚åˆ°äº†TCPå±‚ã€‚</p><pre><code>int tcp_v4_rcv(struct sk_buff *skb)\n{\n\tstruct net *net = dev_net(skb-&gt;dev);\n\tconst struct iphdr *iph;\n\tconst struct tcphdr *th;\n\tbool refcounted;\n\tstruct sock *sk;\n\tint ret;\n......\n\tth = (const struct tcphdr *)skb-&gt;data;\n\tiph = ip_hdr(skb);\n......\n\tTCP_SKB_CB(skb)-&gt;seq = ntohl(th-&gt;seq);\n\tTCP_SKB_CB(skb)-&gt;end_seq = (TCP_SKB_CB(skb)-&gt;seq + th-&gt;syn + th-&gt;fin + skb-&gt;len - th-&gt;doff * 4);\n\tTCP_SKB_CB(skb)-&gt;ack_seq = ntohl(th-&gt;ack_seq);\n\tTCP_SKB_CB(skb)-&gt;tcp_flags = tcp_flag_byte(th);\n\tTCP_SKB_CB(skb)-&gt;tcp_tw_isn = 0;\n\tTCP_SKB_CB(skb)-&gt;ip_dsfield = ipv4_get_dsfield(iph);\n\tTCP_SKB_CB(skb)-&gt;sacked\t = 0;\n\nlookup:\n\tsk = __inet_lookup_skb(&amp;tcp_hashinfo, skb, __tcp_hdrlen(th), th-&gt;source, th-&gt;dest, &amp;refcounted);\n\nprocess:\n\tif (sk-&gt;sk_state == TCP_TIME_WAIT)\n\t\tgoto do_time_wait;\n\n\tif (sk-&gt;sk_state == TCP_NEW_SYN_RECV) {\n......\n\t}\n......\n\tth = (const struct tcphdr *)skb-&gt;data;\n\tiph = ip_hdr(skb);\n\n\tskb-&gt;dev = NULL;\n\n\tif (sk-&gt;sk_state == TCP_LISTEN) {\n\t\tret = tcp_v4_do_rcv(sk, skb);\n\t\tgoto put_and_return;\n\t}\n......\n\tif (!sock_owned_by_user(sk)) {\n\t\tif (!tcp_prequeue(sk, skb))\n\t\t\tret = tcp_v4_do_rcv(sk, skb);\n\t} else if (tcp_add_backlog(sk, skb)) {\n\t\tgoto discard_and_relse;\n\t}\n......\n}\n</code></pre><p>åœ¨tcp_v4_rcvä¸­ï¼Œå¾—åˆ°TCPçš„å¤´ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å¤„ç†TCPå±‚çš„äº‹æƒ…ã€‚å› ä¸ºTCPå±‚æ˜¯åˆ†çŠ¶æ€çš„ï¼ŒçŠ¶æ€è¢«ç»´æŠ¤åœ¨æ•°æ®ç»“æ„struct socké‡Œé¢ï¼Œå› è€Œæˆ‘ä»¬è¦æ ¹æ®IPåœ°å€ä»¥åŠTCPå¤´é‡Œé¢çš„å†…å®¹ï¼Œåœ¨tcp_hashinfoä¸­æ‰¾åˆ°è¿™ä¸ªåŒ…å¯¹åº”çš„struct sockï¼Œä»è€Œå¾—åˆ°è¿™ä¸ªåŒ…å¯¹åº”çš„è¿æ¥çš„çŠ¶æ€ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ ¹æ®ä¸åŒçš„çŠ¶æ€åšä¸åŒçš„å¤„ç†ï¼Œä¾‹å¦‚ï¼Œä¸Šé¢ä»£ç ä¸­çš„TCP_LISTENã€TCP_NEW_SYN_RECVçŠ¶æ€å±äºè¿æ¥å»ºç«‹è¿‡ç¨‹ä¸­ã€‚è¿™ä¸ªæˆ‘ä»¬åœ¨è®²ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™è®²è¿‡äº†ã€‚å†å¦‚ï¼ŒTCP_TIME_WAITçŠ¶æ€æ˜¯è¿æ¥ç»“æŸçš„æ—¶å€™çš„çŠ¶æ€ï¼Œè¿™ä¸ªæˆ‘ä»¬æš‚æ—¶å¯ä»¥ä¸ç”¨çœ‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ†ææœ€ä¸»æµçš„ç½‘ç»œåŒ…çš„æ¥æ”¶è¿‡ç¨‹ï¼Œè¿™é‡Œé¢æ¶‰åŠä¸‰ä¸ªé˜Ÿåˆ—ï¼š</p><ul>\n<li>backlogé˜Ÿåˆ—</li>\n<li>prequeueé˜Ÿåˆ—</li>\n<li>sk_receive_queueé˜Ÿåˆ—</li>\n</ul><p>ä¸ºä»€ä¹ˆæ¥æ”¶ç½‘ç»œåŒ…çš„è¿‡ç¨‹ï¼Œéœ€è¦åœ¨è¿™ä¸‰ä¸ªé˜Ÿåˆ—é‡Œé¢å€’è…¾è¿‡æ¥ã€å€’è…¾è¿‡å»å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼ŒåŒæ ·ä¸€ä¸ªç½‘ç»œåŒ…è¦åœ¨ä¸‰ä¸ªä¸»ä½“ä¹‹é—´äº¤æ¥ã€‚</p><!-- [[[read_end]]] --><p>ç¬¬ä¸€ä¸ªä¸»ä½“æ˜¯<strong>è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹</strong>ã€‚å¦‚æœä½ æ²¡å¿˜è®°çš„è¯ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œtcp_v4_rcvå‡½æ•°çš„æ—¶å€™ï¼Œä¾ç„¶å¤„äºè½¯ä¸­æ–­çš„å¤„ç†é€»è¾‘é‡Œï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå ç”¨è¿™ä¸ªè½¯ä¸­æ–­ã€‚</p><p>ç¬¬äºŒä¸ªä¸»ä½“å°±æ˜¯<strong>ç”¨æˆ·æ€è¿›ç¨‹</strong>ã€‚å¦‚æœç”¨æˆ·æ€è§¦å‘ç³»ç»Ÿè°ƒç”¨readè¯»å–ç½‘ç»œåŒ…ï¼Œä¹Ÿè¦ä»é˜Ÿåˆ—é‡Œé¢æ‰¾ã€‚</p><p>ç¬¬ä¸‰ä¸ªä¸»ä½“å°±æ˜¯<strong>å†…æ ¸åè®®æ ˆ</strong>ã€‚å“ªæ€•ç”¨æˆ·è¿›ç¨‹æ²¡æœ‰è°ƒç”¨readï¼Œè¯»å–ç½‘ç»œåŒ…ï¼Œå½“ç½‘ç»œåŒ…æ¥çš„æ—¶å€™ï¼Œä¹Ÿå¾—æœ‰ä¸€ä¸ªåœ°æ–¹æ”¶ç€å‘€ã€‚</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿäº†è§£ä¸Šé¢ä»£ç ä¸­sock_owned_by_userçš„æ„æ€äº†ï¼Œå…¶å®å°±æ˜¯è¯´ï¼Œå½“å‰è¿™ä¸ªsockæ˜¯ä¸æ˜¯æ­£æœ‰ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ç­‰ç€è¯»æ•°æ®å‘¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†…æ ¸åè®®æ ˆä¹Ÿè°ƒç”¨tcp_add_backlogï¼Œæš‚å­˜åœ¨backlogé˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠ“ç´§ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚</p><p>å¦‚æœæœ‰ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ç­‰å¾…è¯»å–æ•°æ®å‘¢ï¼Ÿæˆ‘ä»¬å…ˆè°ƒç”¨tcp_prequeueï¼Œä¹Ÿå³èµ¶ç´§æ”¾å…¥prequeueé˜Ÿåˆ—ï¼Œå¹¶ä¸”ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¯¹äºsysctl_tcp_low_latencyçš„åˆ¤æ–­ï¼Œä¹Ÿå³æ˜¯ä¸æ˜¯è¦ä½æ—¶å»¶åœ°å¤„ç†ç½‘ç»œåŒ…ã€‚</p><p>å¦‚æœæŠŠsysctl_tcp_low_latencyè®¾ç½®ä¸º0ï¼Œé‚£å°±è¦æ”¾åœ¨prequeueé˜Ÿåˆ—ä¸­æš‚å­˜ï¼Œè¿™æ ·ä¸ç”¨ç­‰å¾…ç½‘ç»œåŒ…å¤„ç†å®Œæ¯•ï¼Œå°±å¯ä»¥ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ï¼Œä½†æ˜¯ä¼šé€ æˆæ¯”è¾ƒé•¿çš„æ—¶å»¶ã€‚å¦‚æœæŠŠsysctl_tcp_low_latencyè®¾ç½®ä¸º1ï¼Œæˆ‘ä»¬è¿˜æ˜¯è°ƒç”¨tcp_v4_do_rcvã€‚</p><pre><code>int tcp_v4_do_rcv(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct sock *rsk;\n\n\tif (sk-&gt;sk_state == TCP_ESTABLISHED) { /* Fast path */\n\t\tstruct dst_entry *dst = sk-&gt;sk_rx_dst;\n......\n\t\ttcp_rcv_established(sk, skb, tcp_hdr(skb), skb-&gt;len);\n\t\treturn 0;\n\t}\n......\n\tif (tcp_rcv_state_process(sk, skb)) {\n......\n\t}\n\treturn 0;\n......\n}\n</code></pre><p>åœ¨tcp_v4_do_rcvä¸­ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æƒ…å†µæ˜¯è¿æ¥å·²ç»å»ºç«‹ï¼Œå¤„äºTCP_ESTABLISHEDçŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_establishedã€‚å¦ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯å…¶ä»–çš„çŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_state_processã€‚</p><pre><code>int tcp_rcv_state_process(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tstruct inet_connection_sock *icsk = inet_csk(sk);\n\tconst struct tcphdr *th = tcp_hdr(skb);\n\tstruct request_sock *req;\n\tint queued = 0;\n\tbool acceptable;\n\n\tswitch (sk-&gt;sk_state) {\n\tcase TCP_CLOSE:\n......\n\tcase TCP_LISTEN:\n......\n\tcase TCP_SYN_SENT:\n......\n\t}\n......\n\tswitch (sk-&gt;sk_state) {\n\tcase TCP_SYN_RECV:\n......\n\tcase TCP_FIN_WAIT1: \n......\n\tcase TCP_CLOSING:\n......\n\tcase TCP_LAST_ACK:\n......\n    }\n\n\t/* step 7: process the segment text */\n\tswitch (sk-&gt;sk_state) {\n\tcase TCP_CLOSE_WAIT:\n\tcase TCP_CLOSING:\n\tcase TCP_LAST_ACK:\n......\n\tcase TCP_FIN_WAIT1:\n\tcase TCP_FIN_WAIT2:\n......\n\tcase TCP_ESTABLISHED:\n......\n\t}\n}\n</code></pre><p>åœ¨tcp_rcv_state_processä¸­ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ç€TCPçš„çŠ¶æ€å›¾è¿›è¡Œæ¯”å¯¹ï¼Œèƒ½çœ‹åˆ°ï¼Œå¯¹äºTCPæ‰€æœ‰çŠ¶æ€çš„å¤„ç†ï¼Œå…¶ä¸­å’Œè¿æ¥å»ºç«‹ç›¸å…³çš„çŠ¶æ€ï¼Œå’±ä»¬å·²ç»åˆ†æè¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨è¿æ¥çŠ¶æ€ä¸‹çš„å·¥ä½œæ¨¡å¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/38/c6/385ff4a348dfd2f64feb0d7ba81e2bc6.png?wh=1423*1963\" alt=\"\"></p><p>åœ¨è¿æ¥çŠ¶æ€ä¸‹ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨tcp_rcv_establishedã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨tcp_data_queueï¼Œå°†å…¶æ”¾å…¥sk_receive_queueé˜Ÿåˆ—è¿›è¡Œå¤„ç†ã€‚</p><pre><code>static void tcp_data_queue(struct sock *sk, struct sk_buff *skb)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tbool fragstolen = false;\n......\n\tif (TCP_SKB_CB(skb)-&gt;seq == tp-&gt;rcv_nxt) {\n\t\tif (tcp_receive_window(tp) == 0)\n\t\t\tgoto out_of_window;\n\n\t\t/* Ok. In sequence. In window. */\n\t\tif (tp-&gt;ucopy.task == current &amp;&amp;\n\t\t    tp-&gt;copied_seq == tp-&gt;rcv_nxt &amp;&amp; tp-&gt;ucopy.len &amp;&amp;\n\t\t    sock_owned_by_user(sk) &amp;&amp; !tp-&gt;urg_data) {\n\t\t\tint chunk = min_t(unsigned int, skb-&gt;len,\n\t\t\t\t\t  tp-&gt;ucopy.len);\n\n\t\t\t__set_current_state(TASK_RUNNING);\n\n\t\t\tif (!skb_copy_datagram_msg(skb, 0, tp-&gt;ucopy.msg, chunk)) {\n\t\t\t\ttp-&gt;ucopy.len -= chunk;\n\t\t\t\ttp-&gt;copied_seq += chunk;\n\t\t\t\teaten = (chunk == skb-&gt;len);\n\t\t\t\ttcp_rcv_space_adjust(sk);\n\t\t\t}\n\t\t}\n\n\t\tif (eaten &lt;= 0) {\nqueue_and_out:\n......\n\t\t\teaten = tcp_queue_rcv(sk, skb, 0, &amp;fragstolen);\n\t\t}\n\t\ttcp_rcv_nxt_update(tp, TCP_SKB_CB(skb)-&gt;end_seq);\n......\n\t\tif (!RB_EMPTY_ROOT(&amp;tp-&gt;out_of_order_queue)) {\n\t\t\ttcp_ofo_queue(sk);\n......\n\t\t}\n......\n\t\treturn;\n\t}\n\n\tif (!after(TCP_SKB_CB(skb)-&gt;end_seq, tp-&gt;rcv_nxt)) {\n\t\t/* A retransmit, 2nd most common case.  Force an immediate ack. */\n\t\ttcp_dsack_set(sk, TCP_SKB_CB(skb)-&gt;seq, TCP_SKB_CB(skb)-&gt;end_seq);\n\nout_of_window:\n\t\ttcp_enter_quickack_mode(sk);\n\t\tinet_csk_schedule_ack(sk);\ndrop:\n\t\ttcp_drop(sk, skb);\n\t\treturn;\n\t}\n\n\t/* Out of window. F.e. zero window probe. */\n\tif (!before(TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt + tcp_receive_window(tp)))\n\t\tgoto out_of_window;\n\n\ttcp_enter_quickack_mode(sk);\n\n\tif (before(TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt)) {\n\t\t/* Partial packet, seq &lt; rcv_next &lt; end_seq */\n\t\ttcp_dsack_set(sk, TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt);\n\t\t/* If window is closed, drop tail of packet. But after\n\t\t * remembering D-SACK for its head made in previous line.\n\t\t */\n\t\tif (!tcp_receive_window(tp))\n\t\t\tgoto out_of_window;\n\t\tgoto queue_and_out;\n\t}\n\n\ttcp_data_queue_ofo(sk, skb);\n}\n</code></pre><p>åœ¨tcp_data_queueä¸­ï¼Œå¯¹äºæ”¶åˆ°çš„ç½‘ç»œåŒ…ï¼Œæˆ‘ä»¬è¦åˆ†æƒ…å†µè¿›è¡Œå¤„ç†ã€‚</p><p>ç¬¬ä¸€ç§æƒ…å†µï¼Œseq == tp-&gt;rcv_nxtï¼Œè¯´æ˜æ¥çš„ç½‘ç»œåŒ…æ­£æ˜¯æˆ‘æœåŠ¡ç«¯æœŸæœ›çš„ä¸‹ä¸€ä¸ªç½‘ç»œåŒ…ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ¤æ–­sock_owned_by_userï¼Œä¹Ÿå³ç”¨æˆ·è¿›ç¨‹ä¹Ÿæ˜¯æ­£åœ¨ç­‰å¾…è¯»å–ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±ç›´æ¥skb_copy_datagram_msgï¼Œå°†ç½‘ç»œåŒ…æ‹·è´ç»™ç”¨æˆ·è¿›ç¨‹å°±å¯ä»¥äº†ã€‚</p><p>å¦‚æœç”¨æˆ·è¿›ç¨‹æ²¡æœ‰æ­£åœ¨ç­‰å¾…è¯»å–ï¼Œæˆ–è€…å› ä¸ºå†…å­˜åŸå› æ²¡æœ‰èƒ½å¤Ÿæ‹·è´æˆåŠŸï¼Œtcp_queue_rcvé‡Œé¢è¿˜æ˜¯å°†ç½‘ç»œåŒ…æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œtcp_rcv_nxt_updateå°†tp-&gt;rcv_nxtè®¾ç½®ä¸ºend_seqï¼Œä¹Ÿå³å½“å‰çš„ç½‘ç»œåŒ…æ¥æ”¶æˆåŠŸåï¼Œæ›´æ–°ä¸‹ä¸€ä¸ªæœŸå¾…çš„ç½‘ç»œåŒ…ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜ä¼šåˆ¤æ–­ä¸€ä¸‹å¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œout_of_order_queueï¼Œä¹Ÿçœ‹çœ‹ä¹±åºé˜Ÿåˆ—çš„æƒ…å†µï¼Œçœ‹çœ‹ä¹±åºé˜Ÿåˆ—é‡Œé¢çš„åŒ…ï¼Œä¼šä¸ä¼šå› ä¸ºè¿™ä¸ªæ–°çš„ç½‘ç»œåŒ…çš„åˆ°æ¥ï¼Œä¹Ÿèƒ½æ”¾å…¥åˆ°sk_receive_queueé˜Ÿåˆ—ä¸­ã€‚</p><p>ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯å‘é€çš„ç½‘ç»œåŒ…åºå·ä¸º5ã€6ã€7ã€8ã€9ã€‚åœ¨5è¿˜æ²¡æœ‰åˆ°è¾¾çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯çš„rcv_nxtåº”è¯¥æ˜¯5ï¼Œä¹Ÿå³æœŸæœ›ä¸‹ä¸€ä¸ªç½‘ç»œåŒ…æ˜¯5ã€‚ä½†æ˜¯ç”±äºä¸­é—´ç½‘ç»œé€šè·¯çš„é—®é¢˜ï¼Œ5ã€6è¿˜æ²¡åˆ°è¾¾æœåŠ¡ç«¯ï¼Œ7ã€8å·²ç»åˆ°è¾¾äº†æœåŠ¡ç«¯äº†ï¼Œè¿™å°±å‡ºç°äº†ä¹±åºã€‚</p><p>ä¹±åºçš„åŒ…ä¸èƒ½è¿›å…¥sk_receive_queueé˜Ÿåˆ—ã€‚å› ä¸ºä¸€æ—¦è¿›å…¥åˆ°è¿™ä¸ªé˜Ÿåˆ—ï¼Œæ„å‘³ç€å¯ä»¥å‘é€ç»™ç”¨æˆ·è¿›ç¨‹ã€‚ç„¶è€Œï¼ŒæŒ‰ç…§TCPçš„å®šä¹‰ï¼Œç”¨æˆ·è¿›ç¨‹åº”è¯¥æ˜¯æŒ‰é¡ºåºæ”¶åˆ°åŒ…çš„ï¼Œæ²¡æœ‰æ’å¥½åºï¼Œå°±ä¸èƒ½ç»™ç”¨æˆ·è¿›ç¨‹ã€‚æ‰€ä»¥ï¼Œ7ã€8ä¸èƒ½è¿›å…¥sk_receive_queueé˜Ÿåˆ—ï¼Œåªèƒ½æš‚æ—¶æ”¾åœ¨out_of_order_queueä¹±åºé˜Ÿåˆ—ä¸­ã€‚</p><p>å½“5ã€6åˆ°è¾¾çš„æ—¶å€™ï¼Œ5ã€6å…ˆè¿›å…¥sk_receive_queueé˜Ÿåˆ—ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¥çœ‹out_of_order_queueä¹±åºé˜Ÿåˆ—ä¸­çš„7ã€8ï¼Œå‘ç°èƒ½å¤Ÿæ¥ä¸Šã€‚äºæ˜¯ï¼Œ7ã€8ä¹Ÿèƒ½è¿›å…¥sk_receive_queueé˜Ÿåˆ—äº†ã€‚tcp_ofo_queueå‡½æ•°å°±æ˜¯åšè¿™ä¸ªäº‹æƒ…çš„ã€‚</p><p>è‡³æ­¤ç¬¬ä¸€ç§æƒ…å†µå¤„ç†å®Œæ¯•ã€‚</p><p>ç¬¬äºŒç§æƒ…å†µï¼Œend_seqä¸å¤§äºrcv_nxtï¼Œä¹Ÿå³æœåŠ¡ç«¯æœŸæœ›ç½‘ç»œåŒ…5ã€‚ä½†æ˜¯ï¼Œæ¥äº†ä¸€ä¸ªç½‘ç»œåŒ…3ï¼Œæ€æ ·æ‰ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè‚¯å®šæ˜¯æœåŠ¡ç«¯æ—©å°±æ”¶åˆ°äº†ç½‘ç»œåŒ…3ï¼Œä½†æ˜¯ACKæ²¡æœ‰åˆ°è¾¾å®¢æˆ·ç«¯ï¼Œä¸­é€”ä¸¢äº†ï¼Œé‚£å®¢æˆ·ç«¯å°±è®¤ä¸ºç½‘ç»œåŒ…3æ²¡æœ‰å‘é€æˆåŠŸï¼Œäºæ˜¯åˆå‘é€äº†ä¸€éï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¦èµ¶ç´§ç»™å®¢æˆ·ç«¯å†å‘é€ä¸€æ¬¡ACKï¼Œè¡¨ç¤ºæ—©å°±æ”¶åˆ°äº†ã€‚</p><p>ç¬¬ä¸‰ç§æƒ…å†µï¼Œseqä¸å°äºrcv_nxt + tcp_receive_windowã€‚è¿™è¯´æ˜å®¢æˆ·ç«¯å‘é€å¾—å¤ªçŒ›äº†ã€‚æœ¬æ¥seqè‚¯å®šåº”è¯¥åœ¨æ¥æ”¶çª—å£é‡Œé¢çš„ï¼Œè¿™æ ·æœåŠ¡ç«¯æ‰æ¥å¾—åŠå¤„ç†ï¼Œç»“æœç°åœ¨è¶…å‡ºäº†æ¥æ”¶çª—å£ï¼Œè¯´æ˜å®¢æˆ·ç«¯ä¸€ä¸‹å­æŠŠæœåŠ¡ç«¯ç»™å¡æ»¡äº†ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡ç«¯ä¸èƒ½å†æ¥æ”¶æ•°æ®åŒ…äº†ï¼Œåªèƒ½å‘é€ACKäº†ï¼Œåœ¨ACKä¸­ä¼šå°†æ¥æ”¶çª—å£ä¸º0çš„æƒ…å†µå‘ŠçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°±çŸ¥é“ä¸èƒ½å†å‘é€äº†ã€‚è¿™ä¸ªæ—¶å€™åŒæ–¹åªèƒ½äº¤äº’çª—å£æ¢æµ‹æ•°æ®åŒ…ï¼Œç›´åˆ°æœåŠ¡ç«¯å› ä¸ºç”¨æˆ·è¿›ç¨‹æŠŠæ•°æ®è¯»èµ°äº†ï¼Œç©ºå‡ºæ¥æ”¶çª—å£ï¼Œæ‰èƒ½åœ¨ACKé‡Œé¢å†æ¬¡å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œåˆæœ‰çª—å£äº†ï¼Œåˆèƒ½å‘é€æ•°æ®åŒ…äº†ã€‚</p><p>ç¬¬å››ç§æƒ…å†µï¼Œseqå°äºrcv_nxtï¼Œä½†æ˜¯end_seqå¤§äºrcv_nxtï¼Œè¿™è¯´æ˜ä»seqåˆ°rcv_nxtè¿™éƒ¨åˆ†ç½‘ç»œåŒ…åŸæ¥çš„ACKå®¢æˆ·ç«¯æ²¡æœ‰æ”¶åˆ°ï¼Œæ‰€ä»¥é‡æ–°å‘é€äº†ä¸€æ¬¡ï¼Œä»rcv_nxtåˆ°end_seqæ—¶æ–°å‘é€çš„ï¼Œå¯ä»¥æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ã€‚</p><p>å½“å‰å››ç§æƒ…å†µéƒ½æ’é™¤æ‰äº†ï¼Œè¯´æ˜ç½‘ç»œåŒ…ä¸€å®šæ˜¯ä¸€ä¸ªä¹±åºåŒ…äº†ã€‚è¿™é‡Œæœ‰ç‚¹å„¿éš¾ç†è§£ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸Šé¢é‚£ä¸ªä¹±åºçš„ä¾‹å­ä»”ç»†åˆ†æä¸€ä¸‹rcv_nxt=5ã€‚</p><p>æˆ‘ä»¬å‡è®¾tcp_receive_windowä¹Ÿæ˜¯5ï¼Œä¹Ÿå³è¶…è¿‡10æœåŠ¡ç«¯å°±æ¥æ”¶ä¸äº†äº†ã€‚å½“å‰æ¥çš„è¿™ä¸ªç½‘ç»œåŒ…æ—¢ä¸åœ¨rcv_nxtä¹‹å‰ï¼ˆä¸æ˜¯3è¿™ç§ï¼‰ï¼Œä¹Ÿä¸åœ¨rcv_nxt + tcp_receive_windowä¹‹åï¼ˆä¸æ˜¯11è¿™ç§ï¼‰ï¼Œè¯´æ˜è¿™æ­£åœ¨æˆ‘ä»¬æœŸæœ›çš„æ¥æ”¶çª—å£é‡Œé¢ï¼Œä½†æ˜¯åˆä¸æ˜¯rcv_nxtï¼ˆä¸æ˜¯æˆ‘ä»¬é©¬ä¸ŠæœŸæœ›çš„ç½‘ç»œåŒ…5ï¼‰ï¼Œè¿™æ­£æ˜¯ä¸Šé¢çš„ä¾‹å­ä¸­ç½‘ç»œåŒ…7ã€8çš„æƒ…å†µã€‚</p><p>å¯¹äºç½‘ç»œåŒ…7ã€8ï¼Œæˆ‘ä»¬åªå¥½è°ƒç”¨tcp_data_queue_ofoè¿›å…¥out_of_order_queueä¹±åºé˜Ÿåˆ—ï¼Œä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼Œå½“ç½‘ç»œåŒ…5ã€6åˆ°æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šèµ°ç¬¬ä¸€ç§æƒ…å†µï¼ŒæŠŠ7ã€8æ‹¿å‡ºæ¥æ”¾åˆ°sk_receive_queueé˜Ÿåˆ—ä¸­ã€‚</p><p>è‡³æ­¤ï¼Œç½‘ç»œåè®®æ ˆçš„å¤„ç†è¿‡ç¨‹å°±ç»“æŸäº†ã€‚</p><h2>Socketå±‚</h2><p>å½“æ¥æ”¶çš„ç½‘ç»œåŒ…è¿›å…¥å„ç§é˜Ÿåˆ—ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ç­‰å¾…ç”¨æˆ·è¿›ç¨‹å»è¯»å–å®ƒä»¬äº†ã€‚</p><p>è¯»å–ä¸€ä¸ªsocketï¼Œå°±åƒè¯»å–ä¸€ä¸ªæ–‡ä»¶ä¸€æ ·ï¼Œè¯»å–socketçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡readç³»ç»Ÿè°ƒç”¨ã€‚</p><p>readç³»ç»Ÿè°ƒç”¨å¯¹äºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œï¼Œå¤§è‡´è¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€èŠ‚ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†è§£æè¿‡ã€‚æœ€ç»ˆå®ƒä¼šè°ƒç”¨åˆ°ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ‰“å¼€æ–‡ä»¶çš„ç»“æ„stuct fileæŒ‡å‘çš„file_operationsæ“ä½œã€‚</p><p>å¯¹äºsocketæ¥è®²ï¼Œå®ƒçš„file_operationså®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>static const struct file_operations socket_file_ops = {\n\t.owner =\tTHIS_MODULE,\n\t.llseek =\tno_llseek,\n\t.read_iter =\tsock_read_iter,\n\t.write_iter =\tsock_write_iter,\n\t.poll =\t\tsock_poll,\n\t.unlocked_ioctl = sock_ioctl,\n\t.mmap =\t\tsock_mmap,\n\t.release =\tsock_close,\n\t.fasync =\tsock_fasync,\n\t.sendpage =\tsock_sendpage,\n\t.splice_write = generic_splice_sendpage,\n\t.splice_read =\tsock_splice_read,\n};\n</code></pre><p>æŒ‰ç…§æ–‡ä»¶ç³»ç»Ÿçš„è¯»å–æµç¨‹ï¼Œè°ƒç”¨çš„æ˜¯sock_read_iterã€‚</p><pre><code>static ssize_t sock_read_iter(struct kiocb *iocb, struct iov_iter *to)\n{\n\tstruct file *file = iocb-&gt;ki_filp;\n\tstruct socket *sock = file-&gt;private_data;\n\tstruct msghdr msg = {.msg_iter = *to,\n\t\t\t     .msg_iocb = iocb};\n\tssize_t res;\n\n\tif (file-&gt;f_flags &amp; O_NONBLOCK)\n\t\tmsg.msg_flags = MSG_DONTWAIT;\n......\n\tres = sock_recvmsg(sock, &amp;msg, msg.msg_flags);\n\t*to = msg.msg_iter;\n\treturn res;\n}\n</code></pre><p>åœ¨sock_read_iterä¸­ï¼Œé€šè¿‡VFSä¸­çš„struct fileï¼Œå°†åˆ›å»ºå¥½çš„socketç»“æ„æ‹¿å‡ºæ¥ï¼Œç„¶åè°ƒç”¨sock_recvmsgï¼Œsock_recvmsgä¼šè°ƒç”¨sock_recvmsg_nosecã€‚</p><pre><code>static inline int sock_recvmsg_nosec(struct socket *sock, struct msghdr *msg, int flags)\n{\n\treturn sock-&gt;ops-&gt;recvmsg(sock, msg, msg_data_left(msg), flags);\n}\n</code></pre><p>è¿™é‡Œè°ƒç”¨äº†socketçš„opsçš„recvmsgï¼Œè¿™ä¸ªæˆ‘ä»¬é‡åˆ°å¥½å‡ æ¬¡äº†ã€‚æ ¹æ®inet_stream_opsçš„å®šä¹‰ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯inet_recvmsgã€‚</p><pre><code>int inet_recvmsg(struct socket *sock, struct msghdr *msg, size_t size,\n\t\t int flags)\n{\n\tstruct sock *sk = sock-&gt;sk;\n\tint addr_len = 0;\n\tint err;\n......\n\terr = sk-&gt;sk_prot-&gt;recvmsg(sk, msg, size, flags &amp; MSG_DONTWAIT,\n\t\t\t\t   flags &amp; ~MSG_DONTWAIT, &amp;addr_len);\n......\n}\n</code></pre><p>è¿™é‡Œé¢ï¼Œä»socketç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ›´åº•å±‚çš„sockç»“æ„ï¼Œç„¶åè°ƒç”¨sk_protçš„recvmsgæ–¹æ³•ã€‚è¿™ä¸ªåŒæ ·é‡åˆ°å¥½å‡ æ¬¡äº†ï¼Œæ ¹æ®tcp_protçš„å®šä¹‰ï¼Œè°ƒç”¨çš„æ˜¯tcp_recvmsgã€‚</p><pre><code>int tcp_recvmsg(struct sock *sk, struct msghdr *msg, size_t len, int nonblock,\n\t\tint flags, int *addr_len)\n{\n\tstruct tcp_sock *tp = tcp_sk(sk);\n\tint copied = 0;\n\tu32 peek_seq;\n\tu32 *seq;\n\tunsigned long used;\n\tint err;\n\tint target;\t\t/* Read at least this many bytes */\n\tlong timeo;\n\tstruct task_struct *user_recv = NULL;\n\tstruct sk_buff *skb, *last;\n.....\n\tdo {\n\t\tu32 offset;\n......\n\t\t/* Next get a buffer. */\n\t\tlast = skb_peek_tail(&amp;sk-&gt;sk_receive_queue);\n\t\tskb_queue_walk(&amp;sk-&gt;sk_receive_queue, skb) {\n\t\t\tlast = skb;\n\t\t\toffset = *seq - TCP_SKB_CB(skb)-&gt;seq;\n\t\t\tif (offset &lt; skb-&gt;len)\n\t\t\t\tgoto found_ok_skb;\n......\n\t\t}\n......\n\t\tif (!sysctl_tcp_low_latency &amp;&amp; tp-&gt;ucopy.task == user_recv) {\n\t\t\t/* Install new reader */\n\t\t\tif (!user_recv &amp;&amp; !(flags &amp; (MSG_TRUNC | MSG_PEEK))) {\n\t\t\t\tuser_recv = current;\n\t\t\t\ttp-&gt;ucopy.task = user_recv;\n\t\t\t\ttp-&gt;ucopy.msg = msg;\n\t\t\t}\n\n\t\t\ttp-&gt;ucopy.len = len;\n\t\t\t/* Look: we have the following (pseudo)queues:\n\t\t\t *\n\t\t\t * 1. packets in flight\n\t\t\t * 2. backlog\n\t\t\t * 3. prequeue\n\t\t\t * 4. receive_queue\n\t\t\t *\n\t\t\t * Each queue can be processed only if the next ones\n\t\t\t * are empty. \n\t\t\t */\n\t\t\tif (!skb_queue_empty(&amp;tp-&gt;ucopy.prequeue))\n\t\t\t\tgoto do_prequeue;\n\t\t}\n\n\t\tif (copied &gt;= target) {\n\t\t\t/* Do not sleep, just process backlog. */\n\t\t\trelease_sock(sk);\n\t\t\tlock_sock(sk);\n\t\t} else {\n\t\t\tsk_wait_data(sk, &amp;timeo, last);\n\t\t}\n\n\t\tif (user_recv) {\n\t\t\tint chunk;\n\t\t\tchunk = len - tp-&gt;ucopy.len;\n\t\t\tif (chunk != 0) {\n\t\t\t\tlen -= chunk;\n\t\t\t\tcopied += chunk;\n\t\t\t}\n\n\t\t\tif (tp-&gt;rcv_nxt == tp-&gt;copied_seq &amp;&amp;\n\t\t\t    !skb_queue_empty(&amp;tp-&gt;ucopy.prequeue)) {\ndo_prequeue:\n\t\t\t\ttcp_prequeue_process(sk);\n\n\t\t\t\tchunk = len - tp-&gt;ucopy.len;\n\t\t\t\tif (chunk != 0) {\n\t\t\t\t\tlen -= chunk;\n\t\t\t\t\tcopied += chunk;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcontinue;\n\tfound_ok_skb:\n\t\t/* Ok so how much can we use? */\n\t\tused = skb-&gt;len - offset;\n\t\tif (len &lt; used)\n\t\t\tused = len;\n\n\t\tif (!(flags &amp; MSG_TRUNC)) {\n\t\t\terr = skb_copy_datagram_msg(skb, offset, msg, used);\n......\n\t\t}\n\n\t\t*seq += used;\n\t\tcopied += used;\n\t\tlen -= used;\n\n\t\ttcp_rcv_space_adjust(sk);\n......\n\t} while (len &gt; 0);\n......\n}\n</code></pre><p>tcp_recvmsgè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿ï¼Œé‡Œé¢é€»è¾‘ä¹Ÿå¾ˆå¤æ‚ï¼Œå¥½åœ¨é‡Œé¢æœ‰ä¸€æ®µæ³¨é‡Šæ¦‚æ‹¬äº†è¿™é‡Œé¢çš„é€»è¾‘ã€‚æ³¨é‡Šé‡Œé¢æåˆ°äº†ä¸‰ä¸ªé˜Ÿåˆ—ï¼Œreceive_queueé˜Ÿåˆ—ã€prequeueé˜Ÿåˆ—å’Œbacklogé˜Ÿåˆ—ã€‚è¿™é‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå‰ä¸€ä¸ªé˜Ÿåˆ—å¤„ç†å®Œæ¯•ï¼Œæ‰å¤„ç†åä¸€ä¸ªé˜Ÿåˆ—ã€‚</p><p>tcp_recvmsgçš„æ•´ä¸ªé€»è¾‘ä¹Ÿæ˜¯è¿™æ ·æ‰§è¡Œçš„ï¼šè¿™é‡Œé¢æœ‰ä¸€ä¸ªwhileå¾ªç¯ï¼Œä¸æ–­åœ°è¯»å–ç½‘ç»œåŒ…ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šå…ˆå¤„ç†sk_receive_queueé˜Ÿåˆ—ã€‚å¦‚æœæ‰¾åˆ°äº†ç½‘ç»œåŒ…ï¼Œå°±è·³åˆ°found_ok_skbè¿™é‡Œã€‚è¿™é‡Œä¼šè°ƒç”¨skb_copy_datagram_msgï¼Œå°†ç½‘ç»œåŒ…æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ä¸­ï¼Œç„¶åç›´æ¥è¿›å…¥ä¸‹ä¸€å±‚å¾ªç¯ã€‚</p><p>ç›´åˆ°sk_receive_queueé˜Ÿåˆ—å¤„ç†å®Œæ¯•ï¼Œæˆ‘ä»¬æ‰åˆ°äº†sysctl_tcp_low_latencyåˆ¤æ–­ã€‚å¦‚æœä¸éœ€è¦ä½æ—¶å»¶ï¼Œåˆ™ä¼šæœ‰prequeueé˜Ÿåˆ—ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬èƒ½å°±è·³åˆ°do_prequeueè¿™é‡Œï¼Œè°ƒç”¨tcp_prequeue_processè¿›è¡Œå¤„ç†ã€‚</p><p>å¦‚æœsysctl_tcp_low_latencyè®¾ç½®ä¸º1ï¼Œä¹Ÿå³æ²¡æœ‰prequeueé˜Ÿåˆ—ï¼Œæˆ–è€…prequeueé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™éœ€è¦å¤„ç†backlogé˜Ÿåˆ—ï¼Œåœ¨release_sockå‡½æ•°ä¸­å¤„ç†ã€‚</p><p>release_sockä¼šè°ƒç”¨__release_sockï¼Œè¿™é‡Œé¢ä¼šä¾æ¬¡å¤„ç†é˜Ÿåˆ—ä¸­çš„ç½‘ç»œåŒ…ã€‚</p><pre><code>void release_sock(struct sock *sk)\n{\n......\n\tif (sk-&gt;sk_backlog.tail)\n\t\t__release_sock(sk);\n......\n}\n\nstatic void __release_sock(struct sock *sk)\n\t__releases(&amp;sk-&gt;sk_lock.slock)\n\t__acquires(&amp;sk-&gt;sk_lock.slock)\n{\n\tstruct sk_buff *skb, *next;\n\n\twhile ((skb = sk-&gt;sk_backlog.head) != NULL) {\n\t\tsk-&gt;sk_backlog.head = sk-&gt;sk_backlog.tail = NULL;\n\t\tdo {\n\t\t\tnext = skb-&gt;next;\n\t\t\tprefetch(next);\n\t\t\tskb-&gt;next = NULL;\n\t\t\tsk_backlog_rcv(sk, skb);\n\t\t\tcond_resched();\n\t\t\tskb = next;\n\t\t} while (skb != NULL);\n\t}\n......\n}\n</code></pre><p>æœ€åï¼Œå“ªé‡Œéƒ½æ²¡æœ‰ç½‘ç»œåŒ…ï¼Œæˆ‘ä»¬åªå¥½è°ƒç”¨sk_wait_dataï¼Œç»§ç»­ç­‰å¾…åœ¨å“ªé‡Œï¼Œç­‰å¾…ç½‘ç»œåŒ…çš„åˆ°æ¥ã€‚</p><p>è‡³æ­¤ï¼Œç½‘ç»œåŒ…çš„æ¥æ”¶è¿‡ç¨‹åˆ°æ­¤ç»“æŸã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬è®²å®Œäº†æ¥æ”¶ç½‘ç»œåŒ…ï¼Œæˆ‘ä»¬æ¥ä»å¤´ä¸²ä¸€ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†æˆä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ã€‚</p><ul>\n<li>ç¡¬ä»¶ç½‘å¡æ¥æ”¶åˆ°ç½‘ç»œåŒ…ä¹‹åï¼Œé€šè¿‡DMAæŠ€æœ¯ï¼Œå°†ç½‘ç»œåŒ…æ”¾å…¥Ring Bufferï¼›</li>\n<li>ç¡¬ä»¶ç½‘å¡é€šè¿‡ä¸­æ–­é€šçŸ¥CPUæ–°çš„ç½‘ç»œåŒ…çš„åˆ°æ¥ï¼›</li>\n<li>ç½‘å¡é©±åŠ¨ç¨‹åºä¼šæ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ixgb_intrï¼›</li>\n<li>ä¸­æ–­å¤„ç†å‡½æ•°å¤„ç†å®Œéœ€è¦æš‚æ—¶å±è”½ä¸­æ–­çš„æ ¸å¿ƒæµç¨‹ä¹‹åï¼Œé€šè¿‡è½¯ä¸­æ–­NET_RX_SOFTIRQè§¦å‘æ¥ä¸‹æ¥çš„å¤„ç†è¿‡ç¨‹ï¼›</li>\n<li>NET_RX_SOFTIRQè½¯ä¸­æ–­å¤„ç†å‡½æ•°net_rx_actionï¼Œnet_rx_actionä¼šè°ƒç”¨napi_pollï¼Œè¿›è€Œè°ƒç”¨ixgb_clean_rx_irqï¼Œä»Ring Bufferä¸­è¯»å–æ•°æ®åˆ°å†…æ ¸struct sk_buffï¼›</li>\n<li>è°ƒç”¨netif_receive_skbè¿›å…¥å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œè¿›è¡Œä¸€äº›å…³äºVLANçš„äºŒå±‚é€»è¾‘å¤„ç†åï¼Œè°ƒç”¨ip_rcvè¿›å…¥ä¸‰å±‚IPå±‚ï¼›</li>\n<li>åœ¨IPå±‚ï¼Œä¼šå¤„ç†iptablesè§„åˆ™ï¼Œç„¶åè°ƒç”¨ip_local_deliveräº¤ç»™æ›´ä¸Šå±‚TCPå±‚ï¼›</li>\n<li>åœ¨TCPå±‚è°ƒç”¨tcp_v4_rcvï¼Œè¿™é‡Œé¢æœ‰ä¸‰ä¸ªé˜Ÿåˆ—éœ€è¦å¤„ç†ï¼Œå¦‚æœå½“å‰çš„Socketä¸æ˜¯æ­£åœ¨è¢«è¯»ï¼›å–ï¼Œåˆ™æ”¾å…¥backlogé˜Ÿåˆ—ï¼Œå¦‚æœæ­£åœ¨è¢«è¯»å–ï¼Œä¸éœ€è¦å¾ˆå®æ—¶çš„è¯ï¼Œåˆ™æ”¾å…¥prequeueé˜Ÿåˆ—ï¼Œå…¶ä»–æƒ…å†µè°ƒç”¨tcp_v4_do_rcvï¼›</li>\n<li>åœ¨tcp_v4_do_rcvä¸­ï¼Œå¦‚æœæ˜¯å¤„äºTCP_ESTABLISHEDçŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_establishedï¼Œå…¶ä»–çš„çŠ¶æ€ï¼Œè°ƒç”¨tcp_rcv_state_processï¼›</li>\n<li>åœ¨tcp_rcv_establishedä¸­ï¼Œè°ƒç”¨tcp_data_queueï¼Œå¦‚æœåºåˆ—å·èƒ½å¤Ÿæ¥çš„ä¸Šï¼Œåˆ™æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ï¼›å¦‚æœåºåˆ—å·æ¥ä¸ä¸Šï¼Œåˆ™æš‚æ—¶æ”¾å…¥out_of_order_queueé˜Ÿåˆ—ï¼Œç­‰åºåˆ—å·èƒ½å¤Ÿæ¥ä¸Šçš„æ—¶å€™ï¼Œå†æ”¾å…¥sk_receive_queueé˜Ÿåˆ—ã€‚</li>\n</ul><p>è‡³æ­¤å†…æ ¸æ¥æ”¶ç½‘ç»œåŒ…çš„è¿‡ç¨‹åˆ°æ­¤ç»“æŸï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç”¨æˆ·æ€è¯»å–ç½‘ç»œåŒ…çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ†æˆå‡ ä¸ªå±‚æ¬¡ã€‚</p><ul>\n<li>VFSå±‚ï¼šreadç³»ç»Ÿè°ƒç”¨æ‰¾åˆ°struct fileï¼Œæ ¹æ®é‡Œé¢çš„file_operationsçš„å®šä¹‰ï¼Œè°ƒç”¨sock_read_iterå‡½æ•°ã€‚sock_read_iterå‡½æ•°è°ƒç”¨sock_recvmsgå‡½æ•°ã€‚</li>\n<li>Socketå±‚ï¼šä»struct fileé‡Œé¢çš„private_dataå¾—åˆ°struct socketï¼Œæ ¹æ®é‡Œé¢opsçš„å®šä¹‰ï¼Œè°ƒç”¨inet_recvmsgå‡½æ•°ã€‚</li>\n<li>Sockå±‚ï¼šä»struct socketé‡Œé¢çš„skå¾—åˆ°struct sockï¼Œæ ¹æ®é‡Œé¢sk_protçš„å®šä¹‰ï¼Œè°ƒç”¨tcp_recvmsgå‡½æ•°ã€‚</li>\n<li>TCPå±‚ï¼štcp_recvmsgå‡½æ•°ä¼šä¾æ¬¡è¯»å–receive_queueé˜Ÿåˆ—ã€prequeueé˜Ÿåˆ—å’Œbacklogé˜Ÿåˆ—ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/20/52/20df32a842495d0f629ca5da53e47152.png?wh=3865*5080\" alt=\"\"></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>å¯¹äºTCPåè®®ã€ä¸‰æ¬¡æ¡æ‰‹ã€å‘é€å’Œæ¥æ”¶çš„è¿æ¥ç»´æŠ¤ã€æ‹¥å¡æ§åˆ¶ã€æ»‘åŠ¨çª—å£ï¼Œæˆ‘ä»¬éƒ½è§£æè¿‡äº†ã€‚å”¯ç‹¬å››æ¬¡æŒ¥æ‰‹æˆ‘ä»¬æ²¡æœ‰è§£æï¼Œå¯¹åº”çš„ä»£ç ä½ åº”è¯¥çŸ¥é“åœ¨ä»€ä¹ˆåœ°æ–¹äº†ï¼Œä½ å¯ä»¥è‡ªå·±è¯•ç€è§£æä¸€ä¸‹å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659\" alt=\"\"></p>","neighbors":{"left":{"article_title":"47 | æ¥æ”¶ç½‘ç»œåŒ…ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•ææ˜ç™½åˆä½œä¼™ä¼´è®©æˆ‘ä»¬åšä»€ä¹ˆï¼Ÿ","id":107485},"right":{"article_title":"49 | è™šæ‹Ÿæœºï¼šå¦‚ä½•æˆç«‹å­å…¬å¸ï¼Œè®©å…¬å¸å˜é›†å›¢ï¼Ÿ","id":108964}},"comments":[{"had_liked":false,"id":241921,"user_name":"Geek_ty","can_delete":false,"product_type":"c1","uid":1587280,"ip_address":"","ucode":"F8178B6B09D628","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epZhOmpZpicOzalVU7kibd59dMJc25N9cfGu9icBAIUPzYNYDedtzlYHZBiazaYiadgqvlotrjM4CA6KOQ/132","comment_is_top":false,"comment_ctime":1597501206,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"44547174166","product_id":100024701,"comment_content":"è¿™é‡Œè¯´ä¸€ä¸‹ï¼Œåœ¨17å¹´åçš„Linuxç‰ˆæœ¬ä¸­å·²ç»å–æ¶ˆäº†prequeueä»¥åŠç›¸å…³çš„æ“ä½œï¼Œå¦‚æœé˜…è¯»è¾ƒæ–°çš„Linuxå†…æ ¸çš„åŒå­¦ä»¬è¯·ä¸è¦è¯¯è§£ã€‚ç°åœ¨åªå‰©2ä¸ªé˜Ÿåˆ—äº†ã€‚","like_count":10,"discussions":[{"author":{"id":1902002,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/05/b2/93b64021.jpg","nickname":"Geek_jikuo","note":"","ucode":"D4AF9E736701B8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389749,"discussion_content":"ä¸ªäººç†è§£ï¼š\nsyns queue ,accept queueæ˜¯tcpå­˜å‚¨è¿æ¥çŠ¶æ€çš„é˜Ÿåˆ—ï¼Œæ ¹æ®è¿æ¥çŠ¶æ€osä¼šåˆ†é…ä¸€äº›ç³»ç»Ÿèµ„æºï¼Œcpuï¼Œå†…å­˜ï¼›\n\nbacklog, sk_receive_queue, out_order_queueæ˜¯å­˜å‚¨ç½‘ç»œåŒ…çš„é˜Ÿåˆ—\n\nåœ¨é˜Ÿåˆ—ä¸­æ‹¿åˆ°ç½‘ç»œåŒ…ä¹‹åå†å»æ›´æ–° tcpè¿æ¥çŠ¶æ€çš„é˜Ÿåˆ—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629421853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1243680,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fa/20/0f06b080.jpg","nickname":"å‡Œç©ºé£èµ·çš„å‰ªåˆ€è…¿","note":"","ucode":"16FBBF4A3B54C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365594,"discussion_content":"ç°åœ¨åªæœ‰ä¸¤ä¸ªé˜Ÿåˆ—äº†å—ï¼Ÿsyns queue(åŠè¿æ¥é˜Ÿåˆ—ï¼‰ï¼›accept queueï¼ˆå…¨è¿æ¥é˜Ÿåˆ—ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617847321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1068620,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4e/4c/ce09ff52.jpg","nickname":"Lance","note":"","ucode":"5FE55DAFE74013","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1243680,"avatar":"https://static001.geekbang.org/account/avatar/00/12/fa/20/0f06b080.jpg","nickname":"å‡Œç©ºé£èµ·çš„å‰ªåˆ€è…¿","note":"","ucode":"16FBBF4A3B54C6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548565,"discussion_content":"syns queue(åŠè¿æ¥é˜Ÿåˆ—ï¼‰å’Œ accept queueï¼ˆå…¨è¿æ¥é˜Ÿåˆ—ï¼‰æ˜¯ä¸listening socketç›¸å…³çš„é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ç”¨äºç®¡ç†è¿æ¥ï¼Œä¸æ¶‰åŠåˆ°è¿æ¥ä¹‹åçš„ç½‘ç»œåŒ…çš„å¤„ç†ã€‚\n\nè€ŒGeek_tyæ‰€è¯´çš„è¢«å–æ¶ˆçš„prequeueæ˜¯å±äºaccpet socketé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜æ”¾çš„æ˜¯ç½‘ç»œåŒ…ã€‚ä¸accpet socketç›¸å…³çš„é˜Ÿåˆ—è¿˜æœ‰ sk_receive_queueé˜Ÿåˆ—ã€out_of_order_queueé˜Ÿåˆ—ä»¥åŠ backlogé˜Ÿåˆ—","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1643265305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":365594,"ip_address":""},"score":548565,"extra":""}]}]},{"had_liked":false,"id":114513,"user_name":"å…è´¹çš„äºº","can_delete":false,"product_type":"c1","uid":1032106,"ip_address":"","ucode":"2B12D8ED63C564","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1563328021,"is_pvip":false,"replies":[{"id":"46598","content":"è®²ä¸äº†äº†ï¼Œè¦ä¸è¿™ä¸ªä¸“æ å°±å¤ªé•¿äº†ã€‚åœ¨ç½‘ç»œåè®®é‡Œé¢å¤§è‡´è®²äº†ä¸€ä¸‹epollçš„å†…æ ¸å®ç°ï¼Œä½†æ˜¯åˆ†æçš„ä¸ç»†","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1566363906,"ip_address":"","comment_id":114513,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23038164501","product_id":100024701,"comment_content":"è€å¸ˆæœ‰è®¡åˆ’è®²epollçš„å®ç°å—ï¼Ÿ","like_count":5,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458697,"discussion_content":"è®²ä¸äº†äº†ï¼Œè¦ä¸è¿™ä¸ªä¸“æ å°±å¤ªé•¿äº†ã€‚åœ¨ç½‘ç»œåè®®é‡Œé¢å¤§è‡´è®²äº†ä¸€ä¸‹epollçš„å†…æ ¸å®ç°ï¼Œä½†æ˜¯åˆ†æçš„ä¸ç»†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566363906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114540,"user_name":"å…è´¹çš„äºº","can_delete":false,"product_type":"c1","uid":1032106,"ip_address":"","ucode":"2B12D8ED63C564","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1563331152,"is_pvip":false,"replies":[{"id":"46597","content":"4.13é‡Œé¢æ˜¯tcp_low_latency - BOOLEAN<br>        If set, the TCP stack makes decisions that prefer lower<br>        latency as opposed to higher throughput.  By default, this<br>        option is not set meaning that higher throughput is preferred.<br>        An example of an application where this default should be<br>        changed would be a Beowulf compute cluster.<br>        Default: 0<br><br>5.0é‡Œé¢å°±æ˜¯<br><br>cp_low_latency - BOOLEAN<br>\tThis is a legacy option, it has no effect anymore.","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1566363861,"ip_address":"","comment_id":114540,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18743200336","product_id":100024701,"comment_content":"ä»kernel docé‡Œå‘ç°è¿™ä¸ªè¯´æ˜ï¼š<br>tcp_low_latency - BOOLEAN<br>\tThis is a legacy option, it has no effect anymore.<br><br>è¿™ä¸ªé€‰é¡¹æ²¡ç”¨äº†ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458714,"discussion_content":"4.13é‡Œé¢æ˜¯tcp_low_latency - BOOLEAN\n        If set, the TCP stack makes decisions that prefer lower\n        latency as opposed to higher throughput.  By default, this\n        option is not set meaning that higher throughput is preferred.\n        An example of an application where this default should be\n        changed would be a Beowulf compute cluster.\n        Default: 0\n\n5.0é‡Œé¢å°±æ˜¯\n\ncp_low_latency - BOOLEAN\n\tThis is a legacy option, it has no effect anymore.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566363861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114604,"user_name":"D","can_delete":false,"product_type":"c1","uid":1027596,"ip_address":"","ucode":"5BB4D16FE39BFF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ae/0c/f39f847a.jpg","comment_is_top":false,"comment_ctime":1563348469,"is_pvip":false,"replies":[{"id":"46573","content":"çº¢é»‘æ ‘ï¼Œå¯ä»¥å…ˆåˆ¤æ–­ä¸€æŠŠå†æ‹¿","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1566359064,"ip_address":"","comment_id":114604,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14448250357","product_id":100024701,"comment_content":"è¿™ä¸ª out_of_order_queue æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œ å‡å¦‚5ï¼Œ6å·²ç»“åˆ°äº†ï¼Œä¸‹ä¸ªæœŸå¾…7ï¼Œ8ï¼Œä½†æ˜¯ä»é˜Ÿå¤´æ‹¿å‡ºçš„æ˜¯9ï¼Œ10ï¼Œæ€ä¹ˆåŠï¼Œé‡æ–°å…¥é˜Ÿå—ï¼Œè¿™æ ·æ•ˆç‡æœ‰ç‚¹ä½å§ï¼Œè€å¸ˆèƒ½è®²è®²å—","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458744,"discussion_content":"çº¢é»‘æ ‘ï¼Œå¯ä»¥å…ˆåˆ¤æ–­ä¸€æŠŠå†æ‹¿","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566359064,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308268,"user_name":"Geek_jikuo","can_delete":false,"product_type":"c1","uid":1902002,"ip_address":"","ucode":"D4AF9E736701B8","user_header":"https://static001.geekbang.org/account/avatar/00/1d/05/b2/93b64021.jpg","comment_is_top":false,"comment_ctime":1629502470,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10219437062","product_id":100024701,"comment_content":"é—®é¢˜ï¼šä¸‰å±‚ä¸Šé€å››å±‚çš„æ—¶å€™ï¼Œæ•°æ®åŒ…æ˜¯æ€æ ·çŸ¥é“è‡ªå·±å±äºå“ªä¸ªsockçš„ï¼Ÿ<br>ç­”ï¼štcp_v4_rcv()  -&gt; __inet_lookup_skb<br>æ ¹æ®æ•°æ®åŒ…çš„ip+ç«¯å£ä»tcp_hashinfoä¸­æ‰¾åˆ°ï¼Œä¼šæœ‰ä¸¤ä¸ªhashè¡¨ï¼šlistening_hashå’Œestablish_hashå“ˆå¸Œè¡¨<br>(æ³¨ï¼šå‚è€ƒæ–‡ä¸­ä¸€æ¡ç¬”è®°)","like_count":2},{"had_liked":false,"id":205438,"user_name":"æ·±æµ·æå…‰","can_delete":false,"product_type":"c1","uid":1096111,"ip_address":"","ucode":"331024F7E99C64","user_header":"https://static001.geekbang.org/account/avatar/00/10/b9/af/f59b4c7c.jpg","comment_is_top":false,"comment_ctime":1586617253,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10176551845","product_id":100024701,"comment_content":"è¯·é—®ä¸‹è€å¸ˆï¼Œæ˜¯linuxåè®®æ ˆé€šè¿‡tcpè§£æå®Œæˆï¼Œæ”¾å…¥åˆ°receive queueæˆ–è€…backlog queue å†å»å”¤é†’ç”¨æˆ·è¿›ç¨‹æ¥è¯»çš„å—ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯epollè¯»ï¼Œè€Œepollæ˜¯æ ¹æ®äº‹ä»¶å˜åŒ–çš„ï¼Œä¹Ÿæ˜¯åœ¨fdçš„ç­‰å¾…é˜Ÿåˆ—ä¸Šç¡çœ ï¼Œå°±æ˜¯è¿™ä¸€æ­¥æ˜¯æ€ä¹ˆå…³è”çš„","like_count":2},{"had_liked":false,"id":167417,"user_name":"å°é©¬","can_delete":false,"product_type":"c1","uid":1040654,"ip_address":"","ucode":"0F7E0225A7E043","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e1/0e/dde741d7.jpg","comment_is_top":false,"comment_ctime":1577788185,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10167722777","product_id":100024701,"comment_content":"å¤§ä½¬ä½ ç”¨çš„linux å†…æ ¸æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œä»¥åŠç”¨ä»€ä¹ˆå·¥å…·æŸ¥çœ‹æºç çš„ï¼Ÿæˆ‘ç”¨çš„æ˜¯ source insight","like_count":2},{"had_liked":false,"id":147126,"user_name":"caryr","can_delete":false,"product_type":"c1","uid":1480634,"ip_address":"","ucode":"9710A1F38F5133","user_header":"https://static001.geekbang.org/account/avatar/00/16/97/ba/b5b56c25.jpg","comment_is_top":false,"comment_ctime":1572812316,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10162746908","product_id":100024701,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªå›°æƒ‘ï¼š <br>if (!sock_owned_by_user(sk)) {    if (!tcp_prequeue(sk, skb))      ret = tcp_v4_do_rcv(sk, skb);  } <br>else if (tcp_add_backlog(sk, skb)) {    goto discard_and_relse;  }<br>è¿™ä»£ç ä¸æ˜¯ sockå±äºæˆ‘çš„æ—¶å€™æ‰§è¡Œadd_backlogå—ï¼Ÿ<br>å¯ä¸ºä»€ä¹ˆæ–‡ä¸­åˆè¯´ï¼šï¼ˆå¤§æ„ï¼šsockä¸å±äºä»»ä½•ç”¨æˆ·ï¼Œåˆ™è°ƒç”¨add_backlog ã€‚æ˜¯æˆ‘å“ªé‡Œç†è§£åå·®äº†å—ï¼Ÿï¼‰<br>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿäº†è§£ä¸Šé¢ä»£ç ä¸­ sock_owned_by_user çš„æ„æ€äº†ï¼Œå…¶å®å°±æ˜¯è¯´ï¼Œå½“å‰è¿™ä¸ª sock æ˜¯ä¸æ˜¯æ­£æœ‰ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ç­‰ç€è¯»æ•°æ®å‘¢ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†…æ ¸åè®®æ ˆä¹Ÿè°ƒç”¨ tcp_add_backlogï¼Œæš‚å­˜åœ¨ backlog é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠ“ç´§ç¦»å¼€è½¯ä¸­æ–­çš„å¤„ç†è¿‡ç¨‹ã€‚","like_count":2},{"had_liked":false,"id":124692,"user_name":"å–åå­—å¥½éº»çƒ¦","can_delete":false,"product_type":"c1","uid":1226508,"ip_address":"","ucode":"EB5EE98C231551","user_header":"","comment_is_top":false,"comment_ctime":1565945593,"is_pvip":false,"replies":[{"id":"46265","content":"èµï¼ŒåŠ æ²¹","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1566280471,"ip_address":"","comment_id":124692,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10155880185","product_id":100024701,"comment_content":"å¤§æ¦‚ä¹Ÿå°±çœ‹äº†äº”å…­ä¸ƒå…«é","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463281,"discussion_content":"èµï¼ŒåŠ æ²¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566280471,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":205547,"user_name":"æ·±æµ·æå…‰","can_delete":false,"product_type":"c1","uid":1096111,"ip_address":"","ucode":"331024F7E99C64","user_header":"https://static001.geekbang.org/account/avatar/00/10/b9/af/f59b4c7c.jpg","comment_is_top":false,"comment_ctime":1586669811,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5881637107","product_id":100024701,"comment_content":"çœ‹äº†å¥½å¤šéï¼Œå¹¶ç»“åˆå…¶ä»–çš„èµ„æ–™ï¼Œæœ‰ä¸ªç–‘é—®å°±æ˜¯æ”¾å…¥backlog queueçš„æ¡ä»¶ï¼Œè€å¸ˆæ˜¯è¯´æ²¡æœ‰ç”¨æˆ·è¿›ç¨‹åœ¨ç­‰å¾…è¯»æ•°æ®ï¼Œç»¼åˆå…¶å®ƒçš„èµ„æ–™æ˜¯è¯´socketçš„é”æ˜¯å¦æ­£åœ¨è¢«å…¶å®ƒä½¿ç”¨ï¼Œå¦‚æœæ˜¯å°±æ”¾å…¥backlog queue,å› ä¸ºä¸èƒ½è®©è½¯ä¸­æ–­ç­‰ï¼Œå¦‚æœèƒ½æ‹¿åˆ°å°±æ”¾å…¥rece queue æ„Ÿè§‰è¿™æ ·æ˜¯æ›´åˆç†ï¼Œè¯·è€å¸ˆè§£ç­”","like_count":1,"discussions":[{"author":{"id":1096111,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b9/af/f59b4c7c.jpg","nickname":"æ·±æµ·æå…‰","note":"","ucode":"331024F7E99C64","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":239295,"discussion_content":"è€å¸ˆè¿™ä¸ªä¸“è¾‘çš„é—®é¢˜è¿˜è§£ç­”å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587291443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":171099,"user_name":"æ—å…ˆæ£®","can_delete":false,"product_type":"c1","uid":1130951,"ip_address":"","ucode":"A25699D1A768B4","user_header":"https://static001.geekbang.org/account/avatar/00/11/41/c7/3aead12b.jpg","comment_is_top":false,"comment_ctime":1578844558,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5873811854","product_id":100024701,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ç½‘ç»œåŒ…æ¥æ”¶è¿‡ç¨‹ä¸­ï¼Œåœ¨å“ªä¸€ä¸ªç¯èŠ‚ç¡®è®¤åæ‰ä¼šå‘å¯¹ç«¯å‘é€ackåŒ…å•Šï¼Ÿæ˜¯ç­‰åº”ç”¨ç¨‹åºè¯»å–ä¹‹åå—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1508990,"avatar":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","nickname":"è¥¿é—¨å¹ç‰›","note":"","ucode":"E5D3624DDE1E83","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379655,"discussion_content":"ä¸éœ€è¦åº”ç”¨å±‚è¯»å–åï¼Œåœ¨ä»ç½‘å¡è¯»åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œå°±å¯ä»¥è¿”å›ack","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624039091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129639,"user_name":"wjh_all_in","can_delete":false,"product_type":"c1","uid":1501209,"ip_address":"","ucode":"0480A53AD46C97","user_header":"https://wx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIC2Ww3swYiaMalnpA1f87xgzV8Hs1Y27M2CbNQqgR27Il72hibXn5FvhU7mbr3XKsxYDZdjY4GMDbg/132","comment_is_top":false,"comment_ctime":1567178544,"is_pvip":false,"replies":[{"id":"48703","content":"è¦çš„ï¼Œå¦‚æœåˆ¤æ–­æ¥ä¸ä¸Šï¼Œå°±å›é€€åˆ°é»˜è®¤æµç¨‹","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1567480324,"ip_address":"","comment_id":129639,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5862145840","product_id":100024701,"comment_content":"è€å¸ˆï¼Œprequeue é˜Ÿåˆ—å’Œ backlog é˜Ÿåˆ—éœ€è¦åšä¹±åºçš„ä¿è¯å—ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œæ€ä¹ˆä¿è¯å¯é æ€§?","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465579,"discussion_content":"è¦çš„ï¼Œå¦‚æœåˆ¤æ–­æ¥ä¸ä¸Šï¼Œå°±å›é€€åˆ°é»˜è®¤æµç¨‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567480324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1609871,"avatar":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","nickname":"å¥”è·‘çš„ç ä»”","note":"","ucode":"AB3B02B07B8B8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38047,"discussion_content":"ç»è¿‡åˆ†æprequeueå’Œbacklogçš„æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„tcp_v4_do_rcvï¼Œè¯¥å‡½æ•°ï¼Œæœ€ç»ˆå¤„ç†tcpçš„ä¹±åºã€é‡ä¼ ã€æ»‘åŠ¨çª—å£ç­‰ç­‰é—®é¢˜ï¼Œç„¶åå°†æ•°æ®æœ€ç»ˆæ”¾å…¥sk_receive_queueé˜Ÿåˆ—é‡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571716805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1609871,"avatar":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","nickname":"å¥”è·‘çš„ç ä»”","note":"","ucode":"AB3B02B07B8B8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38045,"discussion_content":"è€å¸ˆï¼Œé‚£æ˜¯ä¸æ˜¯ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£ï¼Œåªæœ‰ç¡®è®¤æ²¡æœ‰é—®é¢˜ï¼ˆç»è¿‡æ•´ç†ä»¥åé¡ºåºå®Œå…¨æ²¡æœ‰é—®é¢˜çš„æ•°æ®ï¼‰çš„æ•°æ®æ‰ä¼šæ”¾å…¥sk_receive_queueé˜Ÿåˆ—ä¸­ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571716546,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114602,"user_name":"æ²¡å¿ƒæ²¡è‚º","can_delete":false,"product_type":"c1","uid":1258867,"ip_address":"","ucode":"121FD3AEBA3BEA","user_header":"https://static001.geekbang.org/account/avatar/00/13/35/73/46d6dadc.jpg","comment_is_top":false,"comment_ctime":1563348406,"is_pvip":false,"replies":[{"id":"46574","content":"ç»ˆäº....","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1566359075,"ip_address":"","comment_id":114602,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5858315702","product_id":100024701,"comment_content":"ç»ˆäºå¿«ç»“æŸäº†ğŸ™„","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458742,"discussion_content":"ç»ˆäº....","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566359075,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":354205,"user_name":"è¥¿é—¨å¹ç‰›","can_delete":false,"product_type":"c1","uid":1508990,"ip_address":"åŒ—äº¬","ucode":"E5D3624DDE1E83","user_header":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","comment_is_top":false,"comment_ctime":1660184178,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1660184178","product_id":100024701,"comment_content":"ä¸ºä»€ä¹ˆmmap ä¸å¯ç”¨åœ¨ç½‘ç»œIO ä¸­é¿å…ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ•°æ®å¤åˆ¶çš„å¼€é”€ï¼Œè€Œæ–‡ä»¶IOå¯ä»¥","like_count":0},{"had_liked":false,"id":296017,"user_name":"å…«æˆ’","can_delete":false,"product_type":"c1","uid":1576512,"ip_address":"","ucode":"3F262A99492A65","user_header":"https://static001.geekbang.org/account/avatar/00/18/0e/40/49a71ed8.jpg","comment_is_top":false,"comment_ctime":1622706402,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622706402","product_id":100024701,"comment_content":"å‘ç°å…ˆçœ‹æ€»ç»“å†çœ‹æ–‡ç« ï¼Œæ›´æ˜“ç†è§£â€¦â€¦","like_count":0},{"had_liked":false,"id":253303,"user_name":"stackWarn","can_delete":false,"product_type":"c1","uid":1002005,"ip_address":"","ucode":"89672E452DEBA5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","comment_is_top":false,"comment_ctime":1602680084,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602680084","product_id":100024701,"comment_content":"ä½œä¸ºä¸€ä¸ªè¿ç»´ï¼Œè¿™4ç¯‡è¦å¥½å¥½ç ”è¯» å¯¹ç…§å†…æ ¸çœ‹å‡ éäº†ã€‚ åŠ æ²¹1åˆ·","like_count":0},{"had_liked":false,"id":227927,"user_name":"éŸ©ä¿Šè‡£","can_delete":false,"product_type":"c1","uid":1475340,"ip_address":"","ucode":"D6A15C025570D5","user_header":"https://static001.geekbang.org/account/avatar/00/16/83/0c/b9e39db4.jpg","comment_is_top":false,"comment_ctime":1592527883,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1592527883","product_id":100024701,"comment_content":"å‘ç°ï¼Œå¾—å…ˆå¯¹ç€å›¾æ¦‚è§ˆä¸€éï¼Œç„¶åå»çœ‹è°ƒç”¨é“¾ï¼Œæ‰èƒ½å‹‰å¼ºçœ‹æ‡‚","like_count":0},{"had_liked":false,"id":191358,"user_name":"è¡¡å­","can_delete":false,"product_type":"c1","uid":1109433,"ip_address":"","ucode":"0AED79FC9D14BB","user_header":"https://static001.geekbang.org/account/avatar/00/10/ed/b9/825b2411.jpg","comment_is_top":false,"comment_ctime":1584765452,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584765452","product_id":100024701,"comment_content":"è¿˜æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ…¢æ…¢åƒé€ï¼Œä¾‹å¦‚ï¼šclientå‘é€ä¸€èˆ¬æ–­æ‰å‘¢ï¼Ÿé˜Ÿåˆ—é‡Œé¢çš„å·²æ¥æ”¶çš„åŒ…ä¼šä¸¢å¼ƒä¹ˆï¼Ÿsocketåº”è¯¥æœ‰ç±»ä¼¼å¿ƒè·³æˆ–è€…è¯´çŠ¶æ€ç»´æŠ¤çš„æœºåˆ¶ï¼Œæ˜¯åœ¨è¶…æ—¶å…³é—­è¿æ¥çš„æ—¶å€™å»æ¸…ç†æ•°æ®ä¹ˆï¼Ÿ","like_count":0},{"had_liked":false,"id":158461,"user_name":"yew","can_delete":false,"product_type":"c1","uid":1202278,"ip_address":"","ucode":"A26F808BB6C59F","user_header":"https://static001.geekbang.org/account/avatar/00/12/58/66/7afd8da5.jpg","comment_is_top":false,"comment_ctime":1575377559,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1575377559","product_id":100024701,"comment_content":"æ•´ä¸ªæ¥æ”¶è¿‡ç¨‹ é‚£å‡ æ­¥å‘ç”Ÿå†…å­˜æ‹·è´","like_count":0,"discussions":[{"author":{"id":1443017,"avatar":"https://static001.geekbang.org/account/avatar/00/16/04/c9/ef585c96.jpg","nickname":"ç¢Œèˆ°è™¾","note":"","ucode":"B947C229E767D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":564689,"discussion_content":"1ã€DMA\n2ã€è½¯ä¸­æ–­å¤„ç†\n3ã€ç³»ç»Ÿè°ƒç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650296202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":134610,"user_name":"ZYecho","can_delete":false,"product_type":"c1","uid":1356589,"ip_address":"","ucode":"9D156DD30C581E","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLh73kPzAKhz7YxUribqF6QKFiahhVAbwpgVLSRicA68c6ZFA7vUBJY1ves3LVvibrypROyI7awv47eSA/132","comment_is_top":false,"comment_ctime":1568878075,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1568878075","product_id":100024701,"comment_content":"ä¸ºä»€ä¹ˆæ”¾å…¥prequeueé˜Ÿåˆ—å°±ä¼šå¯¼è‡´ä¸€ä¸ªå¤§çš„æ—¶å»¶ï¼Ÿ æ˜¯å› ä¸ºå¦‚æœä¸æ”¾å…¥çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨è½¯ä¸­æ–­ä¸­å¤„ç†äº†ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1609871,"avatar":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","nickname":"å¥”è·‘çš„ç ä»”","note":"","ucode":"AB3B02B07B8B8C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38048,"discussion_content":"å¦‚æœä¸æ”¾å…¥prequeueä¸­çš„è¯ï¼Œä¼šç›´æ¥è°ƒç”¨tcp_v4_do_rcvå°†sk_receive_queueé˜Ÿåˆ—ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹è¯»å–æ—¶é¦–å…ˆè¯»å–çš„å°±æ˜¯è¯¥é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œæ‰€ä»¥å¤„ç†æ—¶å»¶è¾ƒä½å§ã€‚è‹¥æ”¾å…¥prequeueé˜Ÿåˆ—ä¸­ï¼Œç­‰ç”¨æˆ·è¯»å–æ•°æ®æ—¶ï¼Œprequeueä¸­çš„æ•°æ®åŒ…æœ€ç»ˆè¿˜å¾—éœ€è¦é€šè¿‡tcp_v4_do_rcvçš„å¤„ç†ï¼Œå³ï¼Œå»¶æ—¶å¤„ç†äº†ã€‚","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1571716997,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1002005,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/4a/15/106eaaa8.jpg","nickname":"stackWarn","note":"","ucode":"89672E452DEBA5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312414,"discussion_content":"åŠ äº†ä¸€ä¸ªqueue å¤„ç†å°±æœ‰å»¶æ—¶äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602679999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114588,"user_name":"è®¸ç«¥ç«¥","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1563345860,"is_pvip":false,"replies":[{"id":"46575","content":"è°¢è°¢","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1566359082,"ip_address":"","comment_id":114588,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563345860","product_id":100024701,"comment_content":"è€å¸ˆå†™å¾—å¥½ï¼","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458736,"discussion_content":"è°¢è°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566359082,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}