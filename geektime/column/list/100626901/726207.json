{"id":726207,"title":"14ï½œtokioå®æˆ˜ï¼šç¼–å†™ä¸€ä¸ªç½‘ç»œå‘½ä»¤è¡Œç¨‹åº","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeï¼Œä¸Šä¸€èŠ‚è¯¾æˆ‘ä»¬äº†è§£äº†Rustå¼‚æ­¥ç¼–ç¨‹å’Œtokioçš„åŸºç¡€çŸ¥è¯†ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥ä¸€èµ·ç”¨tokioåšä¸€ä¸ªå°åº”ç”¨ã€‚</p><h2>å‡†å¤‡é˜¶æ®µ</h2><p>æˆ‘ä»¬å¸¸å¸¸éœ€è¦çŸ¥é“è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ä¸€äº›ä¿¡æ¯ï¼Œè¿™æœ‰ä¸€äº›ç°æˆçš„å·¥å…·å¯ä»¥åšåˆ°ã€‚æˆ‘ä»¬æ¥è¯•ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨tokioå®ç°è¿™ä¸€åŠŸèƒ½ã€‚</p><p><strong>ç›®æ ‡ï¼š</strong>ç¼–å†™ä¸€ä¸ªè·å–æœåŠ¡å™¨æ—¶é—´çš„å‘½ä»¤è¡Œç¨‹åºã€‚</p><p><strong>ä»»åŠ¡åˆ†è§£ï¼š</strong></p><ol>\n<li>å‘½ä»¤è¡Œï¼šè¿™ä¸ªå·¥å…·å–åä¸º getinfo, å‚æ•°æ ¼å¼æ˜¯ <code>getinfo {ip}</code>ï¼Œå°±æ˜¯åœ¨ getinfo åæ¥IPåœ°å€ï¼Œè·å–æœåŠ¡å™¨æ—¶é—´ã€‚</li>\n<li>tcp serverï¼šç›‘å¬ 8888 ç«¯å£ï¼Œè·å–ä»å®¢æˆ·ç«¯æ¥çš„è¯·æ±‚ï¼Œç„¶åè·å–æœåŠ¡å™¨æœ¬åœ°æ—¶é—´ï¼Œè¿”å›ã€‚</li>\n<li>tcp clientï¼šè¿æ¥æœåŠ¡ç«¯åœ°å€ <code>ip:port</code>ï¼Œå‘æœåŠ¡ç«¯å‘é€è·å–æœåŠ¡å™¨æ—¶é—´æŒ‡ä»¤ã€‚</li>\n<li>æµ‹è¯•ã€‚</li>\n</ol><h2>å®ç°</h2><p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹å®ç°ã€‚</p><h3>åˆ›å»ºé¡¹ç›®</h3><p>æˆ‘ä»¬æ‰“å¼€ç»ˆç«¯æˆ–è€…IDEä¸­çš„Terminalï¼Œæ‰§è¡Œï¼š</p><pre><code class=\"language-plain\">cargo new --bin getinfo\n</code></pre><h3>å‘½ä»¤è¡Œé›å½¢</h3><p>Rustæ ‡å‡†åº“ä¸­å®é™…å·²ç»æœ‰è·å–å‘½ä»¤è¡Œå‚æ•°çš„åŠŸèƒ½ï¼Œ<code>std::env</code> æä¾›äº†ä¸€ç§è·å–å‘½ä»¤è¡Œå‚æ•°çš„æ–¹æ³• <a href=\"https://doc.rust-lang.org/std/index.html\">std</a>::<a href=\"https://doc.rust-lang.org/std/env/index.html\">env</a>::<a href=\"https://doc.rust-lang.org/std/env/fn.args.html#\">args</a>()ï¼Œå¯ä»¥å°†å‘½ä»¤è¡Œå‚æ•°è½¬æ¢æˆä¸€ä¸ªè¿­ä»£å™¨ï¼Œé€šè¿‡ for å¾ªç¯å°±å¯ä»¥éå†æ‰€æœ‰å‘½ä»¤è¡Œå‚æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨è¿­ä»£å™¨ä¸Šçš„ <code>.nth()</code> ç›´æ¥å®šä½åˆ°æŸä¸€ä¸ªå‚æ•°ã€‚æ¯”å¦‚ï¼š</p><pre><code class=\"language-plain\">let addr = env::args()\n&nbsp; &nbsp; .nth(1)\n&nbsp; &nbsp; .unwrap_or_else(|| \"127.0.0.1:8888\".to_string());\n</code></pre><!-- [[[read_end]]] --><p>æœ‰äº†è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°å‘½ä»¤è¡Œçš„åˆå§‹ç‰ˆæœ¬ã€‚</p><pre><code class=\"language-plain\">use std::env;\n\nfn main() {\n  let addr = env::args()\n    .nth(1)\n    .unwrap_or(\"127.0.0.1:8888\".to_string());\n    \n  println!(\"{}\", addr);\n}\n</code></pre><p>æ£€æŸ¥ä¸€ä¸‹Cargo.tomlä¸­çš„é…ç½®ï¼Œæˆ‘ä»¬çš„åº”ç”¨åå­—åº”è¯¥å« getinfoã€‚</p><pre><code class=\"language-plain\">[package]\nname = \"getinfo\"\nversion = \"0.1.0\"\nedition = \"2021\"\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[dependencies]\n</code></pre><p>æ‰§è¡Œ cargo build ç¼–è¯‘ï¼Œä¼šå‡ºç° target ç›®å½•ã€‚</p><pre><code class=\"language-plain\">Cargo.lock&nbsp; Cargo.toml&nbsp; src/&nbsp; target/\n</code></pre><p>æ‰§è¡Œ <code>cargo run</code> æˆ– <code>./target/debug/getinfo</code>ã€‚å¯ä»¥å¾—åˆ°è¾“å‡º <code>127.0.0.1:8888</code>ã€‚</p><p>è€Œæ‰§è¡Œ <code>cargo run -- 127.0.0.1:8000</code> æˆ– <code>./target/debug/getinfo 127.0.0.1:8000</code>ï¼Œå¯ä»¥å¾—åˆ°è¾“å‡º <code>127.0.0.1:8000</code>ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªå‘½ä»¤è¡Œçš„å½¢å¼ã€‚</p><pre><code class=\"language-plain\">./target/debug/getinfo ip_address\n</code></pre><p>å‘½ä»¤è¡Œå‚æ•°ä»å·¦åˆ°å³æŒ‰åºå·ä»0å¼€å§‹è®¡æ•°ï¼Œä¸Šé¢å‘½ä»¤ä¸­ï¼Œ<code>./target/debug/getinfo</code> åºå·ä¸º 0ï¼Œ<code>ip_address</code> éƒ¨åˆ†åºå·å°±æ˜¯ 1ï¼Œå¦‚æœåé¢è¿˜æœ‰å…¶ä»–å‚æ•°ï¼Œé‚£ä¹ˆåºå·ä¾æ¬¡é€’å¢ã€‚æ‰€ä»¥ä½ å°±å¯ä»¥ç†è§£ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½¿ç”¨ <code>.nth(1)</code> å–IPåœ°å€çš„ä¿¡æ¯ã€‚</p><p>æ ‡å‡†åº“ä¸­å‘½ä»¤è¡Œç›¸å…³çš„åŠŸèƒ½è™½ç„¶æ¯”è¾ƒåˆçº§ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬çš„ä¾‹å­æ¥è¯´ï¼Œå·²ç»å¤Ÿç”¨äº†ã€‚Rustç”Ÿæ€ä¸­æœ‰ä¸ªéå¸¸å¥½ç”¨çš„å†™å‘½ä»¤è¡Œçš„åº“ï¼š<a href=\"https://crates.io/crates/clap\">clap</a>ï¼Œå¦‚æœä½ æƒ³å†™ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„å‘½ä»¤è¡Œç¨‹åºï¼Œå¯ä»¥å»å°è¯•ä¸€ä¸‹è¿™ä¸ª clapã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±è¦å¼€å§‹ tokio tcp server çš„åˆ›å»ºã€‚</p><h3>æ·»åŠ ä¾èµ–</h3><p>å…ˆåŠ å…¥tokioçš„ä¾èµ–ï¼Œåœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤ã€‚</p><pre><code class=\"language-plain\">cargo add tokio --features full\ncargo add tokio-util --features full\ncargo add futures\ncargo add bytes\n</code></pre><p>æ‰§è¡Œå®Œè¿™å‡ ä¸ªæ·»åŠ ä¾èµ–çš„å‘½ä»¤åï¼ŒCargo.tomlæ–‡ä»¶ç°åœ¨çœ‹èµ·æ¥æ˜¯ç±»ä¼¼ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><pre><code class=\"language-plain\">mike@LAPTOP-04V0EV33:~/works/jikeshijian/getinfo$ cat Cargo.toml\n[package]\nname = \"getinfo\"\nversion = \"0.1.0\"\nedition = \"2021\"\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[dependencies]\nbytes = \"1.5.0\"\nfutures = \"0.3.29\"\ntokio = { version = \"1.33.0\", features = [\"full\"] }\ntokio-util = { version = \"0.7.10\", features = [\"full\"] }\n</code></pre><p><code>cargo add</code> å·¥å…·ä¸ºæˆ‘ä»¬å‡†ç¡®é…ç½®äº†å…·ä½“ä¾èµ–åº“çš„ç‰ˆæœ¬å·å’Œç‰¹æ€§ã€‚</p><h3>åŸºäºtokioå®ç°tcp server</h3><p>æˆ‘ä»¬çš„tcp serverå®é™…è¦å¹²ä¸‹é¢å‡ ä»¶äº‹å„¿ã€‚</p><ol>\n<li>æ¥æ”¶tcp clientçš„è¿æ¥ï¼Œæ¯ä¸€ä¸ªæ–°è¿æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„taskã€‚</li>\n<li>è¯»å–tcp clientå‘è¿‡æ¥çš„æŒ‡ä»¤æ•°æ®ã€‚</li>\n<li>æ ¹æ®æŒ‡ä»¤ï¼Œè·å–æœåŠ¡å™¨æœ¬åœ°çš„æ—¶é—´ä¿¡æ¯ã€‚</li>\n<li>å°†å¾—åˆ°çš„ä¿¡æ¯å­—ç¬¦ä¸²å†™å…¥socketï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>\n</ol><pre><code class=\"language-plain\">use std::env;\nuse tokio::io::{AsyncReadExt, AsyncWriteExt};\nuse tokio::net::TcpListener;\nuse tokio::process::Command;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {\n&nbsp; &nbsp; let addr = env::args()\n&nbsp; &nbsp; &nbsp; &nbsp; .nth(1)\n&nbsp; &nbsp; &nbsp; &nbsp; .unwrap_or_else(|| \"127.0.0.1:8888\".to_string());\n&nbsp; &nbsp; println!(\"Listening on: {}\", addr);\n&nbsp; &nbsp; let listener = TcpListener::bind(&amp;addr).await?;\n\n&nbsp; &nbsp; // æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªæ— æ¡ä»¶å¾ªç¯ï¼Œè¡¨æ˜å§‹ç»ˆå¤„äºæœåŠ¡çŠ¶æ€\n&nbsp; &nbsp; loop {\n&nbsp; &nbsp; &nbsp; &nbsp; // ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚è¿ä¸Šæ¥\n&nbsp; &nbsp; &nbsp; &nbsp; let (mut socket, _) = listener.accept().await?;\n\n&nbsp; &nbsp; &nbsp; &nbsp; // æ¥ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æ–°ä»»åŠ¡\n&nbsp; &nbsp; &nbsp; &nbsp; tokio::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // åˆ†é…ä¸€ä¸ªç¼“å†²å­˜\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let mut buf = [0; 1024];\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let mut offset = 0;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // å¾ªç¯è¯»ï¼Œå› ä¸ºä¸èƒ½ç¡®ä¿ä¸€æ¬¡èƒ½ä»ç½‘ç»œçº¿è·¯ä¸Šè¯»å®Œæ•°æ®\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loop {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // è¯»æ“ä½œï¼Œè¿”å›çš„nè¡¨ç¤ºè¯»äº†å¤šå°‘ä¸ªå­—èŠ‚\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯»åˆ°æ•°æ®æ‰ä¼šè¿”å›ï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°ï¼Œå°±ä¼šç­‰å¾…\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let n = socket\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .read(&amp;mut buf[offset..])\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .await\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .expect(\"failed to read data from socket\");\n\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // nè¿”å›0çš„æƒ…å†µï¼Œæ˜¯ç¢°åˆ°äº†EOFï¼Œè¡¨æ˜è¿œç«¯çš„å†™æ“ä½œå·²æ–­å¼€ï¼Œè¿™ä¸ªä¸€å®šè¦åˆ¤æ–­\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if n == 0 {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // ç¢°åˆ°äº†EOFå°±ç›´æ¥è¿”å›ç»“æŸæ­¤ä»»åŠ¡ï¼Œå› ä¸ºåé¢çš„æ“ä½œæ²¡äº†æ„ä¹‰\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"offset: {offset}, n: {n}\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let end = offset + n;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // è½¬æ¢æŒ‡ä»¤ä¸ºå­—ç¬¦ä¸²\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if let Ok(directive) = std::str::from_utf8(&amp;buf[..end]) {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{directive}\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // æ‰§è¡ŒæŒ‡ä»¤å¯¹åº”çš„å·¥ä½œ\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let output = process(directive).await;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{output}\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // å‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœ\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; socket\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .write_all(&amp;output.as_bytes())\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .await\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .expect(\"failed to write data to socket\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // åˆ¤æ–­æ˜¯å¦è½¬æ¢å¤±è´¥ï¼Œå¦‚æœå¤±è´¥ï¼Œå°±æœ‰å¯èƒ½æ˜¯ç½‘ç»œä¸Šçš„æ•°æ®è¿˜æ²¡è¯»å®Œ\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // è¦ç»§ç»­loopè¯»ä¸‹ä¸€æ³¢æ•°æ®\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; offset = end;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; });\n&nbsp; &nbsp; }\n}\n\nasync fn process(directive: &amp;str) -&gt; String {\n&nbsp; &nbsp; if directive == \"gettime\" {\n&nbsp; &nbsp; &nbsp; &nbsp; // è¿™é‡Œæˆ‘ä»¬ç”¨äº†unwrap()æ˜¯å› ä¸ºæˆ‘ä»¬ä¸€èˆ¬ç¡®ä¿¡æ‰§è¡Œdateå‘½ä»¤ä¸ä¼šå¤±è´¥\n&nbsp; &nbsp; &nbsp; &nbsp; // æ›´å¯é çš„åšæ³•æ˜¯å¯¹è¿”å›çš„Resultä½œå¤„ç†\n&nbsp; &nbsp; &nbsp; &nbsp; let output = Command::new(\"date\").output().await.unwrap();\n&nbsp; &nbsp; &nbsp; &nbsp; String::from_utf8(output.stdout).unwrap()\n&nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; // å¦‚æœæ˜¯å…¶ä»–æŒ‡ä»¤ï¼Œæˆ‘ä»¬ç›®å‰è¿”å› æ— æ•ˆæŒ‡ä»¤\n&nbsp; &nbsp; &nbsp; &nbsp; \"invalid command\".to_owned()\n&nbsp; &nbsp; }\n}\n</code></pre><p>ä»£ç ä¸­æœ‰è¯¦ç»†è§£é‡Šï¼Œè¿™é‡Œæˆ‘ä¹Ÿè¡¥å……è¯´æ˜ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬ç»™mainå‡½æ•°æŒ‡å®šäº†è¿”å›ç±»å‹ï¼š<code>Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt;</code>ã€‚é”™è¯¯ç±»å‹éƒ¨åˆ†æ˜¯ä¸€ä¸ªç”¨ <code>Box&lt;T&gt;</code> è£…ç›’çš„trait objectï¼Œè¿™ä¸ªtrait objectæ˜¯é’ˆå¯¹æ ‡å‡†åº“ä¸­çš„Error traitçš„ã€‚åœ¨è¿™é‡Œçš„æ„æ€æ˜¯ï¼Œå‡¡æ˜¯å®ç°äº†Error traitçš„ç±»å‹éƒ½å¯ä»¥ä½œä¸ºé”™è¯¯ç±»å‹ä»mainå‡½æ•°ä¸­è¿”å›ã€‚</p><p>ç¬¬12è¡Œ <code>let listener = TcpListener::bind(&amp;addr).await?;</code> è¡Œæœ«æœ‰ä¸€ä¸ªé—®å·ï¼Œè¿™æ˜¯Rusté‡Œçš„é—®å·æ“ä½œç¬¦ï¼Œæ„æ€æ˜¯.await å¾—åˆ°æ•°æ®åæ˜¯ä¸€ä¸ª <code>Result&lt;&gt;</code>ï¼Œå¦‚æœè¿™ä¸ª <code>Result&lt;&gt;</code> æ˜¯Okå€¼ï¼Œé‚£å°±è§£å¼€å®ƒï¼Œè¿”å›é‡Œé¢çš„å†…å®¹ï¼Œè¿™ä¸ªä¾‹å­é‡Œæ˜¯ä¸€ä¸ªTcpListenerå®ä¾‹ï¼›è€Œå¦‚æœè¿™ä¸ª <code>Result&lt;&gt;</code> æ˜¯Errå€¼ï¼Œé‚£å°±ç›´æ¥ä»å‡½æ•°ä¸­è¿”å›ï¼Œä¸å†å¾€ä¸‹æ‰§è¡Œã€‚é—®å·æ“ä½œç¬¦åœ¨è¿™é‡Œèµ·ä¸€ä¸ªé˜²å¾¡å¼ç¼–ç¨‹çš„ä½œç”¨ï¼Œèƒ½å¤Ÿè®©æµç¨‹ä»£ç æ˜¾å¾—æ›´ç®€æ´ã€‚</p><p>æ³¨æ„ç¬¬15è¡Œæ˜¯ä¸€ä¸ªloopæ— æ¡ä»¶å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ­»å¾ªç¯ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè¿™æ˜¯ä¸ªæœåŠ¡ç«¯ç¨‹åºï¼Œæ˜¯éœ€è¦ä¸€ç›´è·‘ç€çš„ï¼Œé€€å‡ºå°±æ„å‘³ç€å‡ºé—®é¢˜äº†ã€‚</p><p>ç¬¬17è¡Œï¼Œç›‘å¬å®¢æˆ·ç«¯æ¥çš„è¿æ¥ï¼Œæ¥ä¸€ä¸ªå°±äº§ç”Ÿä¸€ä¸ª socket å®ä¾‹ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨letåé¢ç”¨äº†æ¨¡å¼åŒ¹é…å†™æ³•ï¼Œç›´æ¥æŠŠå…ƒç»„ææ„äº†ã€‚å¦‚æœæ¥äº†å¤šä¸ªè¿æ¥ï¼Œå°±ä¼šäº§ç”Ÿå¤šä¸ªtaskï¼Œå®ƒä»¬ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œæ˜¯å¹¶å‘å¤„ç†çš„ã€‚</p><p>ç¬¬20è¡Œï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªè¿ä¸Šçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„tokioè½»é‡çº§çº¿ç¨‹taskï¼Œæ¥å¤„ç†å¯¹åº”çš„ä»»åŠ¡ã€‚ç»§ç»­å¾€ä¸‹ï¼Œç¬¬22è¡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæœåŠ¡ç«¯ç¨‹åºä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¤§å°æ˜¯1024å­—èŠ‚ã€‚ä»ç½‘ç»œä¸Šè¯»åˆ°çš„æ•°æ®ä¼šæ”¾åœ¨è¿™ä¸ªç¼“å†²åŒºé‡Œé¢ã€‚</p><p>ç¬¬25è¡Œï¼Œå†æ¬¡ç”¨äº†ä¸€ä¸ªå¾ªç¯ã€‚å› ä¸ºç½‘ç»œä¸Šçš„æ•°æ®æ˜¯å‘ˆæµçš„å½¢å¼è¿‡æ¥çš„ï¼Œåœ¨ä¸€æ¬¡CPUè¯»å–å®ƒä¹‹å‰ï¼Œè¿™äº›æ•°æ®æœ‰å¯èƒ½è¿˜æ²¡å®Œå…¨åˆ°è¾¾æœåŠ¡å™¨ä¸Šé¢ã€‚å› æ­¤å¯èƒ½éœ€è¦å¤šæ¬¡è¯»ã€‚è¯»æ²¡è¯»å¤Ÿï¼Œå¯ä»¥å°è¯•æŠŠå·²ç»è¯»åˆ°æ•°æ®è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œçœ‹æ˜¯å¦èƒ½æˆåŠŸæ¥åˆ¤æ–­ï¼ˆè¿™ä¸ªåˆ¤æ–­æ–¹å¼å¹¶ä¸ä¸¥è°¨ï¼Œè¿™é‡Œä¸»è¦ç”¨äºè¯´æ˜æµç¨‹ï¼‰ã€‚å¦‚æœæˆåŠŸäº†ï¼Œå°±è°ƒç”¨ <code>process()</code> ä¸šåŠ¡å‡½æ•°æ¥è®¡ç®—ã€‚</p><p>process()å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨äº† <code>tokio::process::Command</code> ç±»å‹æ¥è°ƒç”¨ç³»ç»Ÿä¸­çš„ <code>date</code> å‘½ä»¤ï¼Œè¿™æ˜¯ä¸€ä¸ªLinuxä¸‹çš„æŸ¥çœ‹ç³»ç»Ÿæ—¥æœŸæ—¶é—´çš„å‘½ä»¤ï¼Œä¼šè¾“å‡ºä¸‹é¢è¿™ç§æ ¼å¼ï¼š</p><pre><code class=\"language-plain\">Tue Oct 31 14:56:27 CST 2023\n</code></pre><p><span class=\"reference\">æ³¨ï¼šå¦‚æœä½ ä½¿ç”¨Windowsçš„è¯ï¼Œå¯ä»¥æ‰¾æ‰¾Windowsé‡Œçš„æ›¿ä»£å‘½ä»¤ã€‚</span></p><p><code>process()</code> å‡½æ•°ä¼šè¿”å›è¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p><p>ç„¶åï¼Œé€šè¿‡åŒä¸€ä¸ª socketï¼Œå°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯è¿æ¥ï¼š<code>socket.write_all</code>ã€‚</p><p>åœ¨å¤šæ¬¡è¯»çš„è¿‡ç¨‹ä¸­ï¼Œè¦æ³¨æ„åç§»é‡offsetçš„å¤„ç†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œä»£ç é‡è™½ç„¶ä¸å¤šï¼Œä½†æ˜¯å……æ»¡äº†ç»†èŠ‚ï¼Œè¯·ä½ ä»”ç»†å“å‘³ä¸€ä¸‹ã€‚</p><h3>åŸºäºtokioå®ç°tcp client</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å¯¹åº”çš„tcpå®¢æˆ·ç«¯åº”è¯¥æ€ä¹ˆå®ç°ã€‚</p><p>å› ä¸ºæˆ‘ä»¬è¦é©¬ä¸Šå†åˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œæ‰€ä»¥é»˜è®¤çš„ <code>cargo run</code> å‘½ä»¤å°±ä¸èƒ½æ»¡è¶³è¿™ä¸ªéœ€æ±‚ï¼Œå®ƒé»˜è®¤åªèƒ½å¯åŠ¨ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦æ”¹ä¸€ä¸‹Cargo.tomlçš„é…ç½®ï¼Œåœ¨æ–‡ä»¶ä¸­åŠ å…¥ä¸€äº›å†…å®¹ã€‚</p><pre><code class=\"language-plain\">[[bin]]\nname = \"server\"\npath = \"src/server.rs\"\n\n[[bin]]\nname = \"client\"\npath = \"src/client.rs\"\n</code></pre><p>ç„¶åæŠŠsrcç›®å½•ä¸‹çš„ main.rs æ”¹æˆ server.rsï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ client.rsï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">use std::env;\nuse tokio::io::{AsyncReadExt, AsyncWriteExt};\nuse tokio::net::TcpStream;\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {\n&nbsp; &nbsp; let addr = env::args()\n&nbsp; &nbsp; &nbsp; &nbsp; .nth(1)\n&nbsp; &nbsp; &nbsp; &nbsp; .unwrap_or_else(|| \"127.0.0.1:8888\".to_string());\n&nbsp; &nbsp; // è¿æ¥åˆ°æœåŠ¡ç«¯\n&nbsp; &nbsp; let mut stream = TcpStream::connect(&amp;addr).await?;\n\n&nbsp; &nbsp; // å†™å…¥æŒ‡ä»¤æ•°æ®ï¼Œè¿™æ˜¯ä¸€ç§æœ€ç®€å•çš„åè®®.\n&nbsp; &nbsp; stream.write_all(b\"gettime\").await?;\n\n&nbsp; &nbsp; // ç­‰å¾…tcp serverçš„å›å¤ï¼Œè¯»å–å†…å®¹\n&nbsp; &nbsp; // è¿™é‡Œç”¨åŠ¨æ€æ•°ç»„æ¥å­˜å‚¨ä»æœåŠ¡ç«¯è¿”å›çš„å†…å®¹\n&nbsp; &nbsp; let mut buf: Vec&lt;u8&gt; = Vec::with_capacity(8128);\n&nbsp; &nbsp; // è¯»å–çš„ç¼“å†²åŒº\n&nbsp; &nbsp; let mut resp = [0u8; 2048];\n&nbsp; &nbsp; loop {\n&nbsp; &nbsp; &nbsp; &nbsp; // å°è¯•ä¸€æ¬¡è¯»ï¼Œè¿”å›è¯»åˆ°çš„å­—èŠ‚æ•°\n&nbsp; &nbsp; &nbsp; &nbsp; let n = stream.read(&amp;mut resp).await?;\n&nbsp; &nbsp; &nbsp; &nbsp; // å°†è¯»åˆ°çš„å­—èŠ‚åˆå¹¶åˆ°bufä¸­å»\n&nbsp; &nbsp; &nbsp; &nbsp; buf.extend_from_slice(&amp;resp[0..n]);\n&nbsp; &nbsp; &nbsp; &nbsp; if n == 0 {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // æµæ–­æ‰äº†\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; panic!(\"Unexpected EOF\");\n&nbsp; &nbsp; &nbsp; &nbsp; } else if buf.len() &gt;= 28 {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // like: \"Tue Oct 31 14:56:27 CST 2023\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // buf å·²ç»å¡«å……äº†è¶³å¤Ÿçš„å†…å®¹\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;\n&nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // buf ä¸­è¿˜æ²¡æœ‰è¶³å¤Ÿå¤šçš„å†…å®¹ï¼Œç»§ç»­å¡«å……...\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; // è½¬æ¢å¹¶æ‰“å°è¿”å›çš„ä¿¡æ¯\n&nbsp; &nbsp; let timeinfo = String::from_utf8(buf)?;\n&nbsp; &nbsp; println!(\"{}\", timeinfo);\n\n&nbsp; &nbsp; Ok(())\n}\n</code></pre><p>ä»£ç ä¸­æœ‰è¯¦ç»†è§£é‡Šï¼Œè¿™é‡Œæˆ‘ä¹Ÿåšä¸€ä¸‹è¡¥å……è¯´æ˜ã€‚</p><p>ç¬¬11è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>TcpStream::connect()</code> è¿åˆ°æœåŠ¡ç«¯ä¸Šå»ï¼Œæ³¨æ„è¿™ç‚¹å’ŒæœåŠ¡ç«¯çš„ç›‘å¬æ˜¯ä¸åŒçš„ã€‚ç„¶åç¬¬14è¡Œï¼Œå‘tcpè¿æ¥ä¸­å†™å…¥åè®®æŒ‡ä»¤ï¼Œè¿™é‡Œå°±æ˜¯ç®€å•çš„å­—èŠ‚ä¸²ï¼š<code>b\"gettime\"</code>ã€‚</p><p>ç„¶åç¬¬17è¡Œåˆ°25è¡Œï¼Œæˆ‘ä»¬é‡‡ç”¨äº†å¦å¤–ä¸€ç§æ–¹å¼æ¥å­˜å‚¨è¯»å›æ¥çš„æ•°æ®ï¼Œè¿™é‡Œç”¨åˆ°äº†åŠ¨æ€æ•°ç»„Vecçš„ <code>API extend_from_slice()</code>ï¼Œè¿™ä¸ªçš„å¥½å¤„æ˜¯ä¸éœ€è¦ç”±è‡ªå·±æ¥ç»´æŠ¤æ¯æ¬¡è¯»åˆ°çš„åç§»é‡ã€‚ç¬¬21è¡Œï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨äº†loopï¼Œè¿˜æ˜¯åŒæ ·çš„åŸå› ï¼Œç½‘ç»œä¸Šçš„æ•°æ®æµï¼Œæˆ‘ä»¬æœ‰å¯èƒ½ä¸€æ¬¡è¯»å–ä¸å®Œï¼Œéœ€è¦å¤šæ¬¡è¯»æ‰è¡Œã€‚</p><p>ç¬¬29è¡Œæ˜¯è·³å‡ºæ­¤å¾ªç¯çš„åˆ¤æ–­æ¡ä»¶ï¼Œè¿™é‡Œæ˜¯å› ä¸ºæˆ‘ä»¬çŸ¥é“ä¼šè¿”å› date å‘½ä»¤çš„è¾“å‡ºç»“æœï¼Œå®ƒæ˜¯å›ºå®šçš„28ä¸ªå­—èŠ‚çš„é•¿åº¦ã€‚è¿™ä¸ªæ¡ä»¶ç›¸å½“æ­»æ¿ï¼Œè¿™é‡Œä¹Ÿåªæ˜¯èµ·æ¼”ç¤ºä½œç”¨ã€‚</p><p>æœ€åå°±æŠŠè¿™ä¸ªä»æœåŠ¡ç«¯ç¨‹åºå¾—åˆ°çš„å†…å®¹æ‰“å°å‡ºæ¥ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹æµ‹è¯•ã€‚</p><h3>æµ‹è¯•</h3><p>ç¼–è¯‘è¿è¡ŒæœåŠ¡ç«¯ï¼š</p><pre><code class=\"language-plain\">cargo run --bin server æˆ– cargo run --bin server -- 127.0.0.1:8888\n</code></pre><p>ç¼–è¯‘æ‰§è¡Œå®¢æˆ·ç«¯ï¼š</p><pre><code class=\"language-plain\">cargo run --bin client æˆ– cargo run --bin client -- 127.0.0.1:8888\n</code></pre><p>æŸ¥çœ‹æ‰§è¡Œæ•ˆæœã€‚</p><p>æœåŠ¡ç«¯æ‰“å°ï¼š</p><pre><code class=\"language-plain\">Listening on: 127.0.0.1:8888\noffset: 0, n: 7\ngettime\nTue Oct 31 15:04:08 CST 2023\n\n</code></pre><p>å®¢æˆ·ç«¯æ‰“å°ï¼š</p><pre><code class=\"language-plain\">Tue Oct 31 15:07:48 CST 2023\n\n</code></pre><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æˆåŠŸå®ç°äº†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼Œå¹¶å®Œæ•´ä½“éªŒäº†tokioç½‘ç»œç¼–ç¨‹ã€‚</p><h2>Frame å±‚</h2><p>å‰é¢æˆ‘ä»¬çš„å®ç°ï¼Œå®Œæˆäº†è¿™ä¸ªåº”ç”¨åˆæ­¥çš„åŠŸèƒ½ã€‚ä½†æ˜¯å®é™…ä¸Šå¯¹äºæˆ‘ä»¬åˆå­¦è€…æ¥è¯´ï¼Œéš¾åº¦è¿˜æ˜¯æ¯”è¾ƒå¤§ï¼Œä¸»è¦ä½“ç°åœ¨4ä¸ªæ–¹é¢ã€‚</p><ol>\n<li>ä»€ä¹ˆæ—¶å€™è¦åŠ loopï¼Œä»€ä¹ˆæ—¶å€™ä¸åŠ ï¼Ÿ</li>\n<li>ä¸¤ä¸ªç«¯çš„åˆæ³•æ€§åˆ¤å®šæ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿèƒ½å¦æ¨å¹¿åˆ°é€‚ç”¨é¢æ›´å¹¿çš„æ–¹å¼ï¼Ÿ</li>\n<li>å¤šæ¬¡è¯»å–çš„åç§»é‡æˆ–ç¼“å†²åŒºå¦‚ä½•å‡†ç¡®ç»´æŠ¤ï¼Ÿ</li>\n<li>tcpç½‘ç»œåè®®çš„èƒŒæ™¯çŸ¥è¯†ï¼ŒæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„åŸºæœ¬æ¦‚å¿µï¼ŒEOFåœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹è§¦å‘ç­‰ç­‰ã€‚</li>\n</ol><p>å…¶ä¸­å‰é¢ä¸‰æ¡éƒ½å±äºå®ç°å±‚é¢çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥æ¥äº†è§£ä¸€ä¸‹äº§ç”Ÿè¿™äº›å¤æ‚æ€§çš„åŸå› ã€‚</p><h3>å¤æ‚æ€§çš„æ¥æº</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªtcpè¿æ¥å°±åƒä¸€ä¸ªç®¡é“ä¸€æ ·ï¼Œé‡Œé¢æµè¿‡çš„æ˜¯ä¸€ä¸ªä¸ªçš„å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼ è¾“çš„æ˜¯ä¸€ä¸ªå­—èŠ‚æµã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæœ¬èº«çš„å¤æ‚æ€§ï¼Œæ¯”å¦‚å¦‚æœæœåŠ¡å™¨åœ¨å¾ˆè¿œçš„åœ°æ–¹ï¼Œæ•°æ®æœ‰å¯èƒ½è¦ç»å†è¿‡å¾ˆå¤šæ¬¡è·¯ç”±å™¨/äº¤æ¢æœºæ‰èƒ½åˆ°è¾¾ï¼Œæœ‰å¯èƒ½ä¸€ä¸ªå­—èŠ‚å’Œä¸‹ä¸€ä¸ªå­—èŠ‚ä¹‹é—´ä¼šé—´éš”ä¸€æ®µæ—¶é—´æ‰èƒ½ä¼ è¿‡æ¥ã€‚è¿™æ—¶å€™ï¼Œç›´æ¥åœ¨ socket ä¸Šåšçš„ä¸€æ¬¡ readï¼Œå¹¶ä¸èƒ½ä¿è¯å°±ä¸€å®šè¯»å®Œæ•´äº†æˆ‘ä»¬æƒ³è¦çš„å†…å®¹ï¼Œæœ‰å¯èƒ½åªè¯»åˆ°äº†ä¸€ä¸ªç‰‡æ®µè€Œå·²ã€‚</p><p>è¿™ä¸ªé—®é¢˜å…¶å®å±äºä¼ è¾“å±‚çš„é—®é¢˜ï¼Œä¸åº”è¯¥è®©ä¸Šå±‚ä¸šåŠ¡å¼€å‘äººå‘˜æ¥æ‹…å¿§ã€‚å¦‚æœåœ¨è€ƒè™‘ä¸šåŠ¡çš„åŒæ—¶ï¼Œè¿˜è¦è€ƒè™‘è¿™ç§åº•å±‚é—®é¢˜çš„è¯ï¼Œæ€»ä¼šæ„Ÿè§‰æ–½å±•ä¸å¼€ï¼Œå„ç§ç»†èŠ‚ä¼šç¼ å¾—ä½ å¯¸æ­¥éš¾è¡Œã€‚</p><p>æ¯”å¦‚æœ‰ä¸¤ä¸ªäººAå’ŒBï¼ŒAç»™Bå‘é€ä¸¤æ¡æ¶ˆæ¯msg_aå’Œmsg_bï¼ŒB æ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šå¸Œæœ›ç¼–ç¨‹æ¥å£æ¯æ¬¡æ‹¿åˆ°ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼Œç¬¬ä¸€æ¬¡å–æ˜¯msg_aï¼Œä¸å¤šä¹Ÿä¸å°‘ï¼›ç¬¬äºŒæ¬¡å–æ˜¯ msg_bï¼Œä¸å¤šä¹Ÿä¸å°‘ã€‚ä¸ä¼šæ‹…å¿ƒæ¯æ¬¡å–çš„æ—¶å€™ï¼Œæ¶ˆæ¯å¯èƒ½å–ä¸å®Œæ•´ï¼Œéœ€è¦ç”¨ä¸€ä¸ªå¾ªç¯é‡å¤å–ï¼Œå¹¶ä¸”è¿˜å¾—æŠŠæ¯æ¬¡å–åˆ°çš„ç‰‡æ®µæ‹¼æ¥æˆä¸€ä¸ªå¤§çš„å®Œæ•´çš„æ¶ˆæ¯å†…å®¹ã€‚</p><p>å½“æ¶ˆæ¯ä½“å°çš„æ—¶å€™ï¼Œå¯èƒ½é—®é¢˜ä¸æ˜æ˜¾ï¼Œå½“æ¶ˆæ¯ä½“å¤§çš„æ—¶å€™ï¼Œæ¯”å¦‚ä¸€æ¬¡æœ‰å‡ å…†å†…å®¹çš„æ—¶å€™ï¼Œè¿™ä¸ªé—®é¢˜å…¶å®å°±æ— æ³•å¿½ç•¥äº†ã€‚</p><p>å¥½åœ¨tokioæ¡†æ¶å·²ç»ä¸ºæˆ‘ä»¬è€ƒè™‘äº†è¿™ä¸ªé—®é¢˜ã€‚tokioç”Ÿæ€å¼•å…¥äº†Frameçš„æ¦‚å¿µï¼ŒFrameå°±æ˜¯ä¸€ä¸ªå¸§/æ¡†ï¼Œä¸€ä¸ªFrameé‡Œå¯ä»¥åŒ…å«ä¸€æ®µå®Œæ•´çš„å¯é¢„æœŸçš„ä¿¡æ¯ã€‚ç›¸å½“äºå®ƒåœ¨tcpè¿™ä¸€å±‚ä¹‹ä¸ŠåˆæŠ½è±¡äº†ä¸€å±‚ï¼Œå°è£…äº†å…·ä½“æ€ä¹ˆè¯»å–å’Œåˆ‡åˆ†åŸå§‹çš„å­—èŠ‚åºåˆ—è¿™ä¸ªé—®é¢˜ã€‚Frameè®©æˆ‘ä»¬è¯»åˆ°çš„æ€»æ˜¯ä¸šåŠ¡å…³å¿ƒçš„ä¸€æ‰¹æ‰¹æ•°æ®ï¼šmsgã€‚Frameæœºåˆ¶å°†ç½‘ç»œæµçš„åŸå§‹å­—èŠ‚åºåˆ—è½¬æ¢æˆFrameåºåˆ—ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç¡®å®šFrameçš„è¾¹ç•Œåœ¨å“ªé‡Œã€‚</p><h3>Frameç¼–è§£ç </h3><p>æ—¢ç„¶æ˜¯Frameï¼Œå°±æ¶‰åŠåˆ°é‡‡ç”¨ä½•ç§ç¼–ç çš„é—®é¢˜ã€‚Frameæœ¬èº«åªæ˜¯ä¸€ä¸ªæ¡†çš„æ¦‚å¿µï¼Œè¿™ä¸ªæ¡†é‡Œé¢å…·ä½“å¡«ä»€ä¹ˆæ ¼å¼çš„å†…å®¹ï¼Œæ˜¯ç”±ç¼–ç å†³å®šçš„ï¼Œå†™å…¥çš„æ—¶å€™ç¼–ç ï¼Œå–å‡ºçš„æ—¶å€™éœ€è¦è§£ç ã€‚</p><p>ä¸ tokio é…å¥—çš„ tokio_util crate é‡Œï¼Œæä¾›äº†å››ç§æœ€ç®€å•çš„ç¼–è§£ç ç±»å‹ï¼šBytesCodecã€LinesCodecã€AnyDelimiterCodecã€LengthDelimitedCodecã€‚æˆ‘ä»¬åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ã€‚</p><ul>\n<li>BytesCodec</li>\n</ul><p>Frameé•¿åº¦ä¸º1çš„ç¼–è§£ç ã€‚ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªFrameã€‚é€‚ç”¨äºæ–‡æœ¬å’ŒäºŒè¿›åˆ¶çš„ä»»ä½•ç½‘ç»œåè®®ã€‚å¦‚æœä½ çš„åº”ç”¨å°±æƒ³ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°å¤„ç†æ•°æ®æµï¼Œè¿™ä¸ªå°±æ˜¯åˆé€‚çš„é€‰æ‹©ã€‚</p><ul>\n<li>LinesCodec</li>\n</ul><p>è¡Œç¼–è§£ç åè®®ï¼Œå®ƒä½¿ç”¨ <code>\\n</code> ä½œä¸ºFrameä¹‹é—´çš„åˆ†éš”ã€‚è¿™ä¸ªåè®®ç”¨å¾—å¾ˆå¤šï¼Œç‰¹åˆ«é€‚åˆæ–‡æœ¬ç½‘ç»œåè®®ã€‚</p><ul>\n<li>AnyDelimiterCodec</li>\n</ul><p>æŒ‡å®šé—´éš”ç¬¦çš„ç¼–è§£ç åè®®ï¼Œè¿™ä¸ªç›¸å½“äºLinesCodecçš„æ‰©å±•ç‰ˆæœ¬ã€‚ç”¨è¿™ä¸ªåè®®ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰ä»»ä½•Frameåˆ†éš”ç¬¦ï¼Œæ¯”å¦‚ ; , # ç­‰ç­‰ã€‚å®ƒä¹Ÿæ¯”è¾ƒé€‚ç”¨äºæ–‡æœ¬ç½‘ç»œåè®®ã€‚</p><ul>\n<li>LengthDelimitedCodec</li>\n</ul><p>é•¿åº¦åˆ†éš”ç¼–è§£ç åè®®ã€‚è¿™ä¸ªåè®®çš„æ€è·¯æ˜¯ï¼Œæ¯ä¸€ä¸ªmsgå‘é€çš„æ—¶å€™ï¼Œåœ¨å®ƒå‰é¢ï¼Œéƒ½åŠ ä¸Šä¸€ä¸ªå›ºå®šä½æ•°çš„é•¿åº¦è¡¨ç¤ºå‰ç¼€ã€‚è¿™æ ·ï¼Œæ¯æ¬¡è¯»åˆ°è¿™ä¸ªå‰ç¼€æ•°å­—çš„æ—¶å€™ï¼Œå°±çŸ¥é“æ¥ä¸‹æ¥è¦è¯»å¤šå°‘ä¸ªå­—èŠ‚ï¼Œæ‰ä¼šå½¢æˆä¸€ä¸ªå®Œæ•´çš„Frameã€‚æ¯”å¦‚ç¼–ç åçš„ä¸€ä¸ªFrameç±»ä¼¼ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><pre><code class=\"language-plain\">+----------+--------------------------------+\n| len: u32 |          frame payload         |\n+----------+--------------------------------+\n</code></pre><p>è¿™ä¸ªæ–¹æ³•æ˜¯åè®®è®¾è®¡çš„å…¸å‹æ–¹æ³•ï¼Œå…·æœ‰éå¸¸å¼ºçš„é€šç”¨æ€§ï¼Œé€‚ç”¨äºæ–‡æœ¬æˆ–äºŒè¿›åˆ¶çš„ç½‘ç»œåè®®ã€‚</p><p>tokioä¸ä»…æä¾›äº†è¿™äº›é»˜è®¤çš„ç®€å•çš„ç¼–è§£ç æ–¹æ¡ˆï¼Œå®ƒè¿˜å…è®¸ä½ è‡ªå®šä¹‰Codecã€‚å¦‚æœä¸Šé¢4ç§éƒ½ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ å®Œå…¨å¯ä»¥æŒ‰å®ƒçš„è§„èŒƒè‡ªå®šä¹‰ä¸€ä¸ªã€‚</p><p>æ­¤å¤„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨LengthDelimitedCodecï¼Œåªéœ€è¦åœ¨åŸºæœ¬çš„ TcpStream ä¸Šå¥—ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚æ¥ç€å¾€ä¸‹çœ‹ã€‚</p><h3>ä½¿ç”¨Frameæ”¹é€ ä»£ç </h3><p>ä½¿ç”¨Framed + LengthDelimitedCodec ç±»å‹æ”¹é€ åçš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š</p><p>æœåŠ¡ç«¯ä»£ç ï¼š</p><pre><code class=\"language-plain\">use bytes::Bytes;\nuse futures::{SinkExt, StreamExt};\nuse std::env;\nuse tokio::net::TcpListener;\nuse tokio::process::Command;\nuse tokio_util::codec::{Framed, LengthDelimitedCodec};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {\n&nbsp; &nbsp; let addr = env::args()\n&nbsp; &nbsp; &nbsp; &nbsp; .nth(1)\n&nbsp; &nbsp; &nbsp; &nbsp; .unwrap_or_else(|| \"127.0.0.1:8888\".to_string());\n&nbsp; &nbsp; println!(\"Listening on: {}\", addr);\n&nbsp; &nbsp; let listener = TcpListener::bind(&amp;addr).await?;\n\n&nbsp; &nbsp; // æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªæ— æ¡ä»¶å¾ªç¯ï¼Œè¡¨æ˜å§‹ç»ˆå¤„äºæœåŠ¡çŠ¶æ€\n&nbsp; &nbsp; loop {\n&nbsp; &nbsp; &nbsp; &nbsp; // ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚è¿ä¸Šæ¥\n&nbsp; &nbsp; &nbsp; &nbsp; let (stream, _) = listener.accept().await?;\n&nbsp; &nbsp; &nbsp; &nbsp; // åŒ…è£¹æˆä¸€ä¸ªFrame stream\n&nbsp; &nbsp; &nbsp; &nbsp; let mut framed_stream = Framed::new(stream, LengthDelimitedCodec::new());\n\n&nbsp; &nbsp; &nbsp; &nbsp; // åˆ›å»ºå­taskæ‰§è¡Œä»»åŠ¡\n&nbsp; &nbsp; &nbsp; &nbsp; tokio::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // ç­‰å¾…è¯»å–ä¸€ä¸ªä¸€ä¸ªmsgï¼Œå¦‚æœè¿”å›Noneï¼Œä¼šé€€å‡ºè¿™ä¸ªå¾ªç¯\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while let Some(msg) = framed_stream.next().await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; match msg {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Ok(msg) =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // è§£ææŒ‡ä»¤ï¼Œæ‰§è¡Œä»»åŠ¡\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let directive = String::from_utf8(msg.to_vec())\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .expect(\"error when converting to string directive.\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{directive}\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let output = process(&amp;directive).await;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{output}\");\n\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // è¿”å›æ‰§è¡Œç»“æœ\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _ = framed_stream.send(Bytes::from(output)).await;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Err(e) =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{e:?}\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; });\n&nbsp; &nbsp; }\n}\n\nasync fn process(directive: &amp;str) -&gt; String {\n&nbsp; &nbsp; if directive == \"gettime\" {\n&nbsp; &nbsp; &nbsp; &nbsp; // è¿™é‡Œæˆ‘ä»¬ç”¨äº†unwrap()æ˜¯å› ä¸ºæˆ‘ä»¬ä¸€èˆ¬ç¡®ä¿¡æ‰§è¡Œdateå‘½ä»¤ä¸ä¼šå¤±è´¥\n&nbsp; &nbsp; &nbsp; &nbsp; // æ›´å¯é çš„åšæ³•æ˜¯å¯¹è¿”å›çš„Resultä½œå¤„ç†\n&nbsp; &nbsp; &nbsp; &nbsp; let output = Command::new(\"date\").output().await.unwrap();\n&nbsp; &nbsp; &nbsp; &nbsp; String::from_utf8(output.stdout).unwrap()\n&nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; // å¦‚æœæ˜¯å…¶ä»–æŒ‡ä»¤ï¼Œæˆ‘ä»¬ç›®å‰è¿”å› æ— æ•ˆæŒ‡ä»¤\n&nbsp; &nbsp; &nbsp; &nbsp; \"invalid command\".to_owned()\n&nbsp; &nbsp; }\n}\n</code></pre><p>è¿™é‡Œæˆ‘ç®€å•è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ç¤ºä¾‹ã€‚</p><p>åœ¨ç›‘å¬åˆ°è¿æ¥streamï¼ˆç¬¬19è¡Œï¼‰åï¼ŒæŠŠå®ƒåŒ…è£¹æˆFrame streamï¼ˆç¬¬21è¡Œï¼‰ï¼Œç„¶åä½¿ç”¨ <code>while let</code> é…åˆ <code>framed_stream.next()</code> å¯¹è¿™ä¸ªæµè¿›è¡Œè¿­ä»£ï¼Œå°±è¯»å‡ºäº†é‡Œé¢ä¸€å¸§ä¸€å¸§çš„æ•°æ®msgã€‚éœ€è¦è¿”å›ç»“æœçš„æ—¶å€™ï¼Œä½¿ç”¨ <code>framed_stream.send()</code> å°±å¯ä»¥äº†ã€‚</p><p>å®¢æˆ·ç«¯ä»£ç ï¼š</p><pre><code class=\"language-plain\">use bytes::Bytes;\nuse futures::{SinkExt, StreamExt};\nuse std::env;\nuse tokio::net::TcpStream;\nuse tokio_util::codec::{Framed, LengthDelimitedCodec};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {\n&nbsp; &nbsp; let addr = env::args()\n&nbsp; &nbsp; &nbsp; &nbsp; .nth(1)\n&nbsp; &nbsp; &nbsp; &nbsp; .unwrap_or_else(|| \"127.0.0.1:8888\".to_string());\n&nbsp; &nbsp; // è¿æ¥åˆ°æœåŠ¡ç«¯\n&nbsp; &nbsp; let stream = TcpStream::connect(&amp;addr).await?;\n&nbsp; &nbsp; // åŒ…è£¹æˆ Frame stream\n&nbsp; &nbsp; let mut framed_stream = Framed::new(stream, LengthDelimitedCodec::new());\n\n&nbsp; &nbsp; // å‘é€æŒ‡ä»¤\n&nbsp; &nbsp; framed_stream.send(Bytes::from(\"gettime\")).await?;\n\n&nbsp; &nbsp; // è¯»å–è¿”å›æ•°æ®ï¼Œè¿™é‡Œåªè¯»ä¸€æ¬¡\n&nbsp; &nbsp; if let Some(msg) = framed_stream.next().await {\n&nbsp; &nbsp; &nbsp; &nbsp; match msg {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Ok(msg) =&gt; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let timeinfo = String::from_utf8(msg.to_vec())?;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{}\", timeinfo);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Err(e) =&gt; return Err(e.into()),\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; Ok(())\n}\n</code></pre><p>åœ¨è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå¾—åˆ°è¿æ¥streamï¼ˆç¬¬13è¡Œï¼‰åï¼ŒæŠŠå®ƒåŒ…è£¹æˆFrame streamï¼ˆç¬¬15è¡Œï¼‰ ï¼Œç„¶åä½¿ç”¨ <code>framed_stream.send()</code> å‘é€ä¸€æ¡æŒ‡ä»¤ï¼Œåœ¨åé¢ç”¨è¿­ä»£å™¨æ–¹æ³•ç­‰å¾…æŒ‡ä»¤æ‰§è¡Œåè¿”å›çš„å†…å®¹msgã€‚å¯¹msgçš„å¤„ç†æ–¹å¼å’ŒæœåŠ¡ç«¯ä»£ç ä¸€è‡´ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡Frameå±‚æŠ½è±¡åï¼Œå¤§å¤§ç²¾ç®€äº†ä»£ç é€»è¾‘ï¼Œæ•´ä½“å˜å¾—éå¸¸æ¸…çˆ½ã€‚æœ€å…³é”®çš„æ˜¯ï¼Œæ”¹é€ åçš„ä»£ç å®é™…<strong>å®Œå…¨é‡å¡‘äº†ç¨‹åºå‘˜çš„å¿ƒæ™ºæ¨¡å‹</strong>ï¼šæˆ‘ä»¬ä¸å†éœ€è¦å…³æ³¨åº•å±‚ä¼ è¾“çš„å¤§é‡ç»†èŠ‚äº†ï¼ŒçœŸæ­£å®ç°äº†é¢å‘ä¸šåŠ¡ç¼–ç ï¼Œå¯ä»¥æŒ‰æ—¶ä¸‹ç­äº†ï¼Œéå¸¸å¼€å¿ƒã€‚</p><p><span class=\"reference\">æ³¨ï¼šè¿™èŠ‚è¯¾çš„å®Œæ•´ä»£ç ç‚¹å‡»<a href=\"https://github.com/miketang84/jikeshijian/tree/master/14-getinfo\">è¿™é‡Œ</a>å¯ä»¥è·å–ã€‚</span></p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†å¦‚ä½•å¾ªåºæ¸è¿›åœ°åŸºäºtokioå¼€å‘ä¸€ä¸ªæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯tcpç½‘ç»œåº”ç”¨å‘½ä»¤è¡Œç¨‹åºã€‚çŸ¥è¯†ç‚¹å¾ˆå¤šï¼Œæˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ä¸€ä¸‹ã€‚</p><ul>\n<li>Rustä¸­å‘½ä»¤è¡Œå‚æ•°çš„è·å–æ–¹å¼ï¼›</li>\n<li>åœ¨Cargo.toml é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–ï¼›</li>\n<li>åœ¨æœåŠ¡ç«¯å»ºç«‹ tcp lisenerï¼›</li>\n<li>æ ¹æ®æ–°çš„è¿æ¥åˆ›å»ºæ–°çš„taskï¼›</li>\n<li>è¯»å–tcpæ•°æ®è¾“å…¥ï¼Œä»¥åŠå†™å…¥è¿”å›å†…å®¹ï¼›</li>\n<li>å»ºç«‹ tcp client è¿æ¥ï¼›</li>\n<li>ç¼–è¯‘æµ‹è¯•Rustå‘½ä»¤è¡Œç¨‹åºï¼›</li>\n<li>tokioçš„Frameæ¦‚å¿µå’Œç¼–è§£ç ï¼›</li>\n<li>ä½¿ç”¨Frameç®€åŒ–ç½‘ç»œç¼–ç¨‹ã€‚</li>\n</ul><p>ç½‘ç»œç¼–ç¨‹æœ‰å…¶å¤æ‚æ€§åœ¨é‡Œé¢ï¼Œæ‰€ä»¥è¿™èŠ‚è¯¾æˆ‘ä»¬åº”è¯¥é‡ç‚¹æŒæ¡ä½¿ç”¨Frameçš„ç¼–ç¨‹æ¨¡å‹ï¼ŒåŒæ—¶äº†è§£åŸå§‹å­—èŠ‚æµçš„å¤„ç†åŸç†ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åè¯·ä½ æ¥æ€è€ƒ2ä¸ªé—®é¢˜ã€‚</p><ol>\n<li>EOFæ˜¯ä»€ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™ä¼šç¢°åˆ°EOFï¼Ÿ</li>\n<li>è¯·é—® stream.read_to_end() æ¥å£èƒ½è¯»å®Œç½‘ç»œè¿æ¥ä¸­çš„æ•°æ®å—ï¼Ÿ</li>\n</ol><p>æ¬¢è¿ä½ æŠŠæ€è€ƒåçš„ç»“æœåˆ†äº«åˆ°è¯„è®ºåŒºå’Œæˆ‘ä¸€èµ·è®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":384177,"user_name":"PEtFiSh","can_delete":false,"product_type":"c1","uid":1765926,"ip_address":"å››å·","ucode":"C4922398A92E05","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLO6XvxfFPMGcVSSX8uIZY2yib29qlyat178pU4QM3gIic5GXZ8PC0tzRiazP3FiajXbTj19SE4ZhV0gQ/132","comment_is_top":false,"comment_ctime":1700465984,"is_pvip":false,"replies":[{"id":140156,"content":"ğŸ‘ï¼ŒçœŸæ£’ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700540116,"ip_address":"é‡åº†","comment_id":384177,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"EOF: End of file. åœ¨linuxä¸‡ç‰©çš†fileçš„æƒ…å†µä¸‹connectionä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªfileã€‚æ‰€ä»¥ï¼Œå½“Connectionå…³é—­çš„æ—¶å€™ï¼Œå°±ä¼šäº§ç”ŸEOFã€‚\nstream.read_to_end()æ˜¯æŒç»­read()ç›´åˆ°EOFï¼Œå› æ­¤èƒ½å¤Ÿè¯»å®Œç½‘ç»œé‡Œçš„æ•°æ®ï¼Œå¦‚æœä½¿ç”¨stream.read_to_end(&amp;mut buf).await?;è¯»å–çš„è¯ï¼Œä¼šæŒç»­waitï¼Œç›´åˆ°è¿æ¥å…³é—­æ‰èƒ½è¿›è¡Œåç»­çš„æ“ä½œã€‚","like_count":6,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632171,"discussion_content":"ğŸ‘ï¼ŒçœŸæ£’ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700540116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384160,"user_name":"å­¦æ°´","can_delete":false,"product_type":"c1","uid":2557688,"ip_address":"åŠ æ‹¿å¤§","ucode":"F8B27FD11187EC","user_header":"https://static001.geekbang.org/account/avatar/00/27/06/f8/09ad484b.jpg","comment_is_top":false,"comment_ctime":1700441281,"is_pvip":false,"replies":[{"id":140162,"content":"å¯¹çš„ï¼Œå…¶å®ç½‘ç»œç¼–ç¨‹åˆ°äº†åº•å±‚åŸºæœ¬éƒ½æ˜¯è¿™ä¸ªæ ·å­äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700540931,"ip_address":"é‡åº†","comment_id":384160,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æ„Ÿè§‰è¿™éƒ¨åˆ†å†…å®¹å’Œjavaçš„nettyåŒ…æœ‰ç‚¹åƒ","like_count":4,"discussions":[{"author":{"id":2178332,"avatar":"","nickname":"æ¨å›½å¨","note":"","ucode":"F5FD883322772D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632068,"discussion_content":"tcpç½‘ç»œé€šä¿¡åè®®æ˜¯æ ‡å‡†ï¼Œä¸åŒè¯­è¨€å¤„ç†èµ·æ¥å½“ç„¶è¦åƒã€‚","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1700445420,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ç¦å»º","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632177,"discussion_content":"å¯¹çš„ï¼Œå…¶å®ç½‘ç»œç¼–ç¨‹åˆ°äº†åº•å±‚åŸºæœ¬éƒ½æ˜¯è¿™ä¸ªæ ·å­äº†ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1700540931,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2911084,"avatar":"https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg","nickname":"HappyHasson","note":"","ucode":"B84CC43E349CFA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649017,"discussion_content":"å’Œè¯­è¨€æ— å…³ï¼Œæ˜¯ç½‘ç»œç¼–ç¨‹çš„çŸ¥è¯†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1722559140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385978,"user_name":"æ²‰é»˜çš„è¯å” ","can_delete":false,"product_type":"c1","uid":1231254,"ip_address":"å¹¿è¥¿","ucode":"90212EF174C6E3","user_header":"https://static001.geekbang.org/account/avatar/00/12/c9/96/4577c1ef.jpg","comment_is_top":false,"comment_ctime":1703756293,"is_pvip":false,"replies":[{"id":140691,"content":"æ„Ÿè°¢è‚¯å®šğŸ™ï¼Œå›å¤´å’Œå°ç¼–å•†é‡å•†é‡ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703856042,"ip_address":"é‡åº†","comment_id":385978,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è·Ÿç€ä¸€è·¯ä¸‹æ¥ï¼Œæ„Ÿè§‰è®²å¸ˆè®²çš„çœŸçš„ä¸é”™ã€‚ ä¸çŸ¥é“åé¢è€ƒä¸è€ƒè™‘æœ‰è®­ç»ƒè¥ä¹‹ç±»çš„ï¼Œæ›´åŠ å…¨é¢ä½“ç³»çš„è¯¾ç¨‹ã€‚","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634751,"discussion_content":"æ„Ÿè°¢è‚¯å®šğŸ™ï¼Œå›å¤´å’Œå°ç¼–å•†é‡å•†é‡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703856042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384404,"user_name":"Citroen","can_delete":false,"product_type":"c1","uid":2188563,"ip_address":"è¾½å®","ucode":"03017DB11EC537","user_header":"https://static001.geekbang.org/account/avatar/00/21/65/13/8654e7c9.jpg","comment_is_top":false,"comment_ctime":1700814729,"is_pvip":false,"replies":[{"id":140251,"content":"å¾ˆç®€å•ï¼Œå‘é€ç«¯ç”¨ LengthDelimitedCodec ç¼–ç çš„ï¼Œæ¥æ”¶ç«¯ä¹ŸåŒæ ·ç”¨ LengthDelimitedCodec è§£ç å°±è¡Œäº†ã€‚tokioçš„è¿™å±‚FramedåŒ…è£…è‡ªåŠ¨å®Œæˆäº†è¿™é¡¹å·¥ä½œäº†ï¼Œå…·ä½“çš„ç¼–è§£ç æ˜¯åœ¨ä¸‹å±‚layeråšçš„ï¼Œä¸Šå±‚ä½ å°±å…³å¿ƒä¸šåŠ¡å°±å¥½å•¦ï¼Œå·²ç»ç»™ä½ å–åˆ°äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700837604,"ip_address":"é‡åº†","comment_id":384404,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¿™æ®µä»£ç \nlet mut framed_stream = Framed::new(stream, LengthDelimitedCodec::new())\nè¯·é—®ä¸€ä¸‹è€å¸ˆï¼Œæˆ‘ç°åœ¨éœ€è¦æ¥æ”¶clientç«¯çš„æ•°æ®ï¼ˆæ•°æ®æ˜¯æ‰“åŒ…å¥½çš„protobufåºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œ\nå‰é¢æœ‰å››ä½é•¿åº¦è¡¨ç¤ºè¿™ä¸ªåºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®æ ¼å¼æ˜¯ï¼Œå¤´ï¼ˆå››ä½ ç”¨äºè¯´æ˜åé¢å®Œæ•´protobufåºåˆ—åŒ–åçš„æ•°æ®é•¿åº¦ï¼‰åŠ å†…å®¹ï¼ˆprotobufåºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®ï¼‰,len(å››ä½é•¿åº¦ï¼‰åŠ main(protobufåºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ® æ¯æ¬¡é•¿åº¦ä¸å›ºå®šï¼Œä½†å¯é€šè¿‡å‰é¢çš„lenå¯ä»¥çŸ¥é“ï¼‰ï¼Œæ¯æ®µæ•°æ®éƒ½æ˜¯è¿™æ · è¿™æ ·çš„æ•°æ®æ€ä¹ˆå–ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632493,"discussion_content":"å¾ˆç®€å•ï¼Œå‘é€ç«¯ç”¨ LengthDelimitedCodec ç¼–ç çš„ï¼Œæ¥æ”¶ç«¯ä¹ŸåŒæ ·ç”¨ LengthDelimitedCodec è§£ç å°±è¡Œäº†ã€‚tokioçš„è¿™å±‚FramedåŒ…è£…è‡ªåŠ¨å®Œæˆäº†è¿™é¡¹å·¥ä½œäº†ï¼Œå…·ä½“çš„ç¼–è§£ç æ˜¯åœ¨ä¸‹å±‚layeråšçš„ï¼Œä¸Šå±‚ä½ å°±å…³å¿ƒä¸šåŠ¡å°±å¥½å•¦ï¼Œå·²ç»ç»™ä½ å–åˆ°äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700837604,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":2764102,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/2d/46/e6235836.jpg","nickname":"ä»¤ç‹èåœ","note":"","ucode":"1F8FDCF9B6B509","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":632657,"discussion_content":"é‚£æœåŠ¡å™¨æ˜¯æ€ä¹ˆçŸ¥é“å®¢æˆ·ç«¯ç”¨ä»€ä¹ˆç¼–ç æ–¹å¼å‘¢ï¼Ÿæ¢ä¸€ç§ç¼–ç æ–¹å¼æ˜¯ä¸æ˜¯å°±ä¸èƒ½å·¥ä½œäº†ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701149412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":632493,"ip_address":"æ¹–åŒ—","group_id":0},"score":632657,"extra":""},{"author":{"id":2188563,"avatar":"https://static001.geekbang.org/account/avatar/00/21/65/13/8654e7c9.jpg","nickname":"Citroen","note":"","ucode":"03017DB11EC537","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2764102,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/2d/46/e6235836.jpg","nickname":"ä»¤ç‹èåœ","note":"","ucode":"1F8FDCF9B6B509","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632672,"discussion_content":"è€å¸ˆçš„æ„æ€åº”è¯¥æ˜¯å…¶ä»–å®¢æˆ·ç«¯åº”è¯¥æ˜¯æŒ‰ç…§æœåŠ¡å™¨ç«¯ä½¿ç”¨çš„LengthDelimitedCodecé…ç½®æ–¹å¼ç»„è£…æ•°æ®ï¼Œè¿™æ ·åº”è¯¥å°±æ²¡é—®é¢˜äº†ã€‚æ¯”å¦‚æœåŠ¡å™¨ç«¯ç”¨é»˜è®¤çš„LengthDelimitedCodec é…ç½®ï¼Œé‚£ä¹ˆclientç«¯å¦‚æœä¸ç”¨ç›¸åŒçš„å‘é€æ–¹å¼ï¼Œé‚£å°±è¦è‡ªå·±æ‹¼è£…æ•°æ®ï¼ŒæŠŠæ•°æ®åšæˆå¤´æ˜¯uint32è¡¨ç¤ºçš„ä¿¡æ¯é•¿åº¦å¤§å°ï¼Œç„¶ååé¢ç´§æ¥ç€æ˜¯æ•°æ®å†…å®¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701163538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":632657,"ip_address":"è¾½å®","group_id":0},"score":632672,"extra":""}]}]},{"had_liked":false,"id":384193,"user_name":"å“„å“„","can_delete":false,"product_type":"c1","uid":3779530,"ip_address":"åŒ—äº¬","ucode":"F75FB23BEDC60A","user_header":"https://static001.geekbang.org/account/avatar/00/39/ab/ca/32d6c05d.jpg","comment_is_top":false,"comment_ctime":1700484572,"is_pvip":false,"replies":[{"id":140154,"content":"crates.io,  lib.rs, https:&#47;&#47;github.com&#47;rust-unofficial&#47;awesome-rust","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700539732,"ip_address":"é‡åº†","comment_id":384193,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"åº”è¯¥ç”¨ä»€ä¹ˆå·²æœ‰çš„crateåŒ…ï¼Œæ„Ÿè§‰ä¹Ÿæ˜¯æ–°äººçš„ä¸€ä¸ªé—®é¢˜ã€‚è¯·é—®ä¸Šå“ªèƒ½å¿«é€Ÿè®¤è¯†å¸¸ç”¨ç¬¬ä¸‰æ–¹åŒ…å‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632169,"discussion_content":"crates.io,  lib.rs, https://github.com/rust-unofficial/awesome-rust","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700539732,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385716,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1703154117,"is_pvip":false,"replies":[{"id":140635,"content":"tokio streanæ˜¯å…¨åŒå·¥çš„ï¼Œå¯ä»¥å†™ã€‚ä½†æ˜¯ä½ å¦‚æœç¨‹åºè¢«å¡åœ¨ read_to_end é‚£é‡Œï¼Œé‚£å†™é€»è¾‘ä¹Ÿæ‰§è¡Œä¸äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703578027,"ip_address":"é‡åº†","comment_id":385716,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"EOF =&gt; End Of File, åœ¨æ•°æ®æµæ–­å¼€çš„æ—¶å€™ä¼šç¢°åˆ°\n\nstream.read_to_end(buf) =&gt; æŠŠè¿™ä¸ª stream é‡Œæ¥æ”¶åˆ°çš„æ‰€æœ‰æ•°æ®éƒ½ä¸¢åˆ°ä¸€ä¸ª buf_vec é‡Œï¼Œ åº”è¯¥æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°å§ï¼Œ åªè¦é“¾æ¥ä¸æ–­å¼€ï¼Œ å°±ä¸€ç›´ç­‰å¾…ï¼Œ å•å¼€ä¸€ä¸ªè¿›ç¨‹ &#47; çº¿ç¨‹æ¥è·‘ read_to_end ç„¶ååœ¨åˆ«çš„è¿›ç¨‹ &#47; çº¿ç¨‹ä» buf é‡Œå¾€å¤–é¢è¯»æ•°æ®\n\nä¸è¿‡æ„Ÿè§‰å¦‚æœç”¨ read_to_end çš„è¯å½“å‰ stream å°±æ²¡åŠæ³•å¾€é‡Œå†™æ•°æ®äº†ï¼Œ è¿™å’‹æ•´å•Šï¼Œ éš¾é“æ˜¯ clone ä¸€ä»½ stream ç„¶ååœ¨å…¶ä»–è¿›ç¨‹ &#47; çº¿ç¨‹æ¥å†™å—ï¼Œ è¿˜æ˜¯è®¾è®¡çš„æ—¶å€™å°±ä¸è€ƒè™‘å¾€ `ç”¨äº† read_to_end çš„ stream`é‡Œç»§ç»­å†™æ•°æ®äº†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634501,"discussion_content":"tokio streanæ˜¯å…¨åŒå·¥çš„ï¼Œå¯ä»¥å†™ã€‚ä½†æ˜¯ä½ å¦‚æœç¨‹åºè¢«å¡åœ¨ read_to_end é‚£é‡Œï¼Œé‚£å†™é€»è¾‘ä¹Ÿæ‰§è¡Œä¸äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703578027,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385711,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1703152238,"is_pvip":false,"replies":[{"id":140588,"content":"https:&#47;&#47;github.com&#47;miketang84&#47;jikeshijian&#47;","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703232544,"ip_address":"é‡åº†","comment_id":385711,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å•Šï¼Ÿ æœ‰æºç çš„å•Šï¼Œ star ä¸€ä¸‹å…ˆ","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634338,"discussion_content":"https://github.com/miketang84/jikeshijian/","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1703232544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385668,"user_name":"-HedonğŸ­","can_delete":false,"product_type":"c1","uid":3176234,"ip_address":"æ¹–åŒ—","ucode":"FAE541E7A2B88F","user_header":"https://static001.geekbang.org/account/avatar/00/30/77/2a/0cd4c373.jpg","comment_is_top":false,"comment_ctime":1703070266,"is_pvip":false,"replies":[{"id":140553,"content":"ğŸ‘ï¼Œä¸é”™ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703122431,"ip_address":"é‡åº†","comment_id":385668,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æ€è€ƒé¢˜1ï¼šEOF\n\n\tEOF æ˜¯ &quot;End of File&quot; çš„ç¼©å†™ï¼Œæ„ä¸ºâ€œæ–‡ä»¶ç»“æŸâ€ã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨äºè¡¨ç¤ºæ–‡ä»¶æˆ–æ•°æ®æµæœ«å°¾çš„æ§åˆ¶ä¿¡å·æˆ–å­—ç¬¦ã€‚å½“è¯»å–æ–‡ä»¶æˆ–æ•°æ®æµæ—¶ï¼ŒEOFç”¨äºæŒ‡ç¤ºæ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»å–ã€‚\n\t\n\tEOF é€šå¸¸å‡ºç°åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š\n\n\t1. æ–‡ä»¶è¯»å–ï¼šåœ¨è¯»å–æ–‡ä»¶å†…å®¹æ—¶ï¼Œåˆ°è¾¾æ–‡ä»¶æœ«å°¾åï¼Œä¼šé‡åˆ° EOFã€‚è¿™å‘Šè¯‰ç¨‹åºæ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»å–ã€‚\n\n\t2. æ ‡å‡†è¾“å…¥ï¼šåœ¨æŸäº›ç¼–ç¨‹è¯­è¨€æˆ–ç¯å¢ƒä¸­ï¼Œå¦‚ Unix&#47;Linux çš„å‘½ä»¤è¡Œï¼Œå¯ä»¥ä½¿ç”¨ç‰¹å®šçš„é”®ç›˜ç»„åˆï¼ˆå¦‚ Ctrl+D ï¼‰æ¥ç”Ÿæˆ EOF ä¿¡å·ï¼Œè¡¨ç¤ºæ ‡å‡†è¾“å…¥ç»“æŸã€‚\n\n\t3. æ•°æ®æµç»“æŸï¼šåœ¨å¤„ç†æ•°æ®æµï¼ˆå¦‚ç½‘ç»œä¼ è¾“ä¸­çš„æ•°æ®ï¼‰æ—¶ï¼ŒEOF å¯ä»¥ç”¨æ¥æŒ‡ç¤ºæ•°æ®ä¼ è¾“å·²ç»å®Œæˆã€‚\n\n\næ€è€ƒé¢˜2ï¼šstream.read_to_end()\n\n\té¦–å…ˆæˆ‘è§‰å¾—æ ¸å¿ƒç‚¹åœ¨ â€œè¯»å®Œâ€ è¿™ä¸ªæ¦‚å¿µä¸Šï¼Œå³æ„å‘³ç€è¿æ¥ä¸­çš„æ•°æ®æ˜¯æœ‰é™çš„ï¼Œæ‰æœ‰è¯»å®Œï¼Œå¦‚æœæ˜¯æ— é™çš„æµæ•°æ®ï¼Œé‚£ä¹ˆ stream.read_to_end() ä¼šä¸€ç›´é˜»å¡ç­‰å¾…æ•°æ®çš„åˆ°æ¥ã€‚å¦‚æœæ˜ç¡®æ•°æ®çš„æœ‰é™çš„ï¼Œé‚£ä¹ˆåœ¨æ•°æ®æºå‘å‡º EOF åï¼Œstream.read_to_end() å°±ä¼šè¿”å›ï¼Œé‚£è¿™ä¸ªæ—¶å€™æ˜¯å¯ä»¥ â€œè¯»å®Œâ€ çš„ã€‚å½“å‰ï¼Œå‰ææ˜¯ä½ çš„å†…å­˜å¾—å¤Ÿã€‚\n\n\n(è¿ç»­2å‘¨æ¬ç –èµ¶éœ€æ±‚ï¼Œç»ˆäºèƒ½æŠ½ç‚¹æ—¶é—´ç»­ä¸Š rust çš„å­¦ä¹ äº† T_T)","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634228,"discussion_content":"ğŸ‘ï¼Œä¸é”™ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703122431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384174,"user_name":"A0.ä½•æ–‡ç¥¥","can_delete":false,"product_type":"c1","uid":1052569,"ip_address":"å¹¿ä¸œ","ucode":"2549126DAEA15D","user_header":"https://static001.geekbang.org/account/avatar/00/10/0f/99/0d72321f.jpg","comment_is_top":false,"comment_ctime":1700463048,"is_pvip":false,"replies":[{"id":140152,"content":"å†æ¬¡æ„Ÿè°¢ğŸ¤","user_name":"ç¼–è¾‘å›å¤","user_name_real":"ç¼–è¾‘","uid":2843479,"ctime":1700538194,"ip_address":"åŒ—äº¬","comment_id":384174,"utype":2}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"cargo new --bin getinfåº”ä¸ºcargo new --bin getinfo","like_count":0,"discussions":[{"author":{"id":2843479,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/63/57/cba4c68b.jpg","nickname":"å°è™å­ğŸ¯","note":"","ucode":"4C9530B3FB407B","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632167,"discussion_content":"å†æ¬¡æ„Ÿè°¢ğŸ¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700538194,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384167,"user_name":"Andylinge","can_delete":false,"product_type":"c1","uid":2727445,"ip_address":"æ±Ÿè‹","ucode":"D0D24185E99A67","user_header":"https://static001.geekbang.org/account/avatar/00/29/9e/15/e499fc69.jpg","comment_is_top":false,"comment_ctime":1700452412,"is_pvip":false,"replies":[{"id":140157,"content":"å¯¹çš„ï¼Œdateå‘½ä»¤æ˜¯linuxä¸‹çš„ï¼ŒæŠ±æ­‰å¿˜äº†è¿™ä¸ªç»†èŠ‚ï¼Œåé¢æƒ³åŠæ³•è¡¥å……è¯´æ˜ä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700540207,"ip_address":"é‡åº†","comment_id":384167,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"Windows 11 æŠ¥å¦‚ä¸‹é”™è¯¯ï¼Œå¤§å®¶å¯ä»¥æŠŠprocessé‡Œé¢çš„è·å–æ—¶é—´å‘½ä»¤è‡ªå·±ç”¨Rusté‡å†™ä¸€ä¸‹ã€‚\n```Listening on: 127.0.0.1:8880\nAccepted a connection from: 127.0.0.1:9354\ngettime\nthread &#39;tokio-runtime-worker&#39; panicked at src&#47;server.rs:80:58:\ncalled `Result::unwrap()` on an `Err` value: Error { kind: NotFound, message: &quot;program not found&quot; }\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\nerror: process didn&#39;t exit successfully: `D:\\00-Program\\05-Rust\\14-Rust_MikeTang\\r14_tokio\\getinfo\\target\\debug\\server.exe` (exit code: 0xc000013a, STATUS_CONTROL_C_EXIT)\n```","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632172,"discussion_content":"å¯¹çš„ï¼Œdateå‘½ä»¤æ˜¯linuxä¸‹çš„ï¼ŒæŠ±æ­‰å¿˜äº†è¿™ä¸ªç»†èŠ‚ï¼Œåé¢æƒ³åŠæ³•è¡¥å……è¯´æ˜ä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700540207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2414906,"avatar":"https://static001.geekbang.org/account/avatar/00/24/d9/3a/9a867533.jpg","nickname":"ä½•æµ©","note":"","ucode":"1DE354DF5F42C0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634616,"discussion_content":"ä¿®æ”¹æ–‡ä»¶å¦‚ä¸‹ï¼Œå¯ä»¥æˆåŠŸæ‰“å°å‡º\nserverï¼š\nListening on: 127.0.0.1:8888\noffset: 0, n: 7\ngettime\n2023-12-28\nclientï¼š\n2023-12-28\n\nserver.rs :\nlet output = Command::new(&#34;date&#34;).output().await.unwrap(); \n==&gt;        \n        let output = if cfg!(target_os = &#34;windows&#34;) {\n    Command::new(&#34;cmd&#34;)\n        .args([&#34;/C&#34;, &#34;echo %date:~0,4%-%date:~5,2%-%date:~8,2%&#34;])\n        .output()\n        .await.unwrap()\n} else {\n    Command::new(&#34;sh&#34;)\n        .arg(&#34;-c&#34;)\n        .arg(&#34;date&#34;)\n        .output()\n        .await.unwrap()\n};\n\nclient.rs\n} else if buf.len() &gt;= 28 {\n            // like: &#34;Tue Oct 31 14:56:27 CST 2023&#34;\n            // buf å·²ç»å¡«å……äº†è¶³å¤Ÿçš„å†…å®¹\n            break;\n==&gt;\n else if buf.len() &gt;= 10 {\n            // like: &#34;Tue Oct 31 14:56:27 CST 2023&#34;\n            // buf å·²ç»å¡«å……äº†è¶³å¤Ÿçš„å†…å®¹\n            break;\n\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1703736675,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"é™•è¥¿","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384156,"user_name":"å­¦æ°´","can_delete":false,"product_type":"c1","uid":2557688,"ip_address":"åŠ æ‹¿å¤§","ucode":"F8B27FD11187EC","user_header":"https://static001.geekbang.org/account/avatar/00/27/06/f8/09ad484b.jpg","comment_is_top":false,"comment_ctime":1700437777,"is_pvip":false,"replies":[{"id":140161,"content":"æ­å–œåŒå­¦ï¼Œä½ æ‰¾åˆ°äº†ä¸€æ¡è™«å­ã€‚ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700540912,"ip_address":"é‡åº†","comment_id":384156,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"ç¬¬ä¸€ç‰ˆserverä»£ç ï¼Œæ²¡è¯»åˆ°å®Œæ•´è¯·æ±‚çš„è¯ï¼Œä¸ºå•¥æ›´æ–°offsetä¸ºnè€Œä¸æ˜¯endå‘¢","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632176,"discussion_content":"æ­å–œåŒå­¦ï¼Œä½ æ‰¾åˆ°äº†ä¸€æ¡è™«å­ã€‚ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700540912,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385713,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1703152920,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"ç¬”è®°\n\nstream &#47; socket è¿™ä¸ªä¸œè¥¿ï¼Œ ä¸ç”¨å…³å¿ƒå…·ä½“å®šä¹‰ï¼Œ åªè¦çŸ¥é“æ‹¿ç€å®ƒå¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œå°±è¡Œäº†\n\n\n\nserver è·‘èµ·æ¥äº†ä¹‹åå¯ä»¥ç”¨ nc å‘½ä»¤æ¥ç®€å•è·‘ä¸€ä¸‹æµ‹è¯•ï¼ˆä¸ç”¨ client.rsï¼‰ï¼Œ æ³¨æ„ nc å‘çš„æ¶ˆæ¯è‡ªå¸¦ä¸€ä¸ª `\\n`, è®°å¾— strip_suffix æä¸€ä¸‹\n\n&gt;nc 127.0.0.1 8888\n\n\n\nps: å‰æ®µæ—¶é—´æ’¸ https:&#47;&#47;github.com&#47;jonhoo&#47;rust-tcp å¿«æ’¸å“­äº†... çœ‹åˆ° tokio è¿™ä¹ˆç®€å•çš„ä»£ç çœŸèˆ’æœ","like_count":2}]}