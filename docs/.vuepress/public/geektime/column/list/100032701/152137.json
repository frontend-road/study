{"id":152137,"title":"31ä¸¨æ€§èƒ½ç¯‡ç­”ç–‘ï¼šepollæºç æ·±åº¦å‰–æ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç››å»¶æ•ï¼Œä»Šå¤©æ˜¯ç½‘ç»œç¼–ç¨‹å®æˆ˜æ€§èƒ½ç¯‡çš„ç­”ç–‘æ¨¡å—ï¼Œæ¬¢è¿å›æ¥ã€‚</p><p>åœ¨æ€§èƒ½ç¯‡ä¸­ï¼Œæˆ‘ä¸»è¦å›´ç»•C10Ké—®é¢˜è¿›è¡Œäº†æ·±å…¥å‰–æï¼Œæœ€åå¼•å‡ºäº†äº‹ä»¶åˆ†å‘æœºåˆ¶å’Œå¤šçº¿ç¨‹ã€‚å¯ä»¥è¯´ï¼ŒåŸºäºepollçš„äº‹ä»¶åˆ†å‘èƒ½åŠ›ï¼Œæ˜¯Linuxä¸‹é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹çš„ä¸äºŒä¹‹é€‰ã€‚å¦‚æœä½ è§‰å¾—è¿˜ä¸è¿‡ç˜¾ï¼ŒæœŸæœ›æœ‰æ›´æ·±åˆ»çš„è®¤è¯†å’Œç†è§£ï¼Œé‚£ä¹ˆåœ¨æ€§èƒ½ç¯‡çš„ç­”ç–‘ä¸­ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·æ¢³ç†ä¸€ä¸‹epollçš„æºä»£ç ï¼Œä»ä¸­æˆ‘ä»¬ä¸€å®šå¯ä»¥æœ‰æ›´å¤šçš„å‘ç°å’Œé¢†æ‚Ÿã€‚</p><p>ä»Šå¤©çš„ä»£ç æœ‰äº›å¤šï¼Œå»ºè®®ä½ é…åˆæ–‡ç¨¿æ”¶å¬éŸ³é¢‘ã€‚</p><h2>åŸºæœ¬æ•°æ®ç»“æ„</h2><p>åœ¨å¼€å§‹ç ”ç©¶æºä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹epollä¸­ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«æ˜¯eventpollã€epitemå’Œeppoll_entryã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹eventpollè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨epoll_createä¹‹åå†…æ ¸ä¾§åˆ›å»ºçš„ä¸€ä¸ªå¥æŸ„ï¼Œè¡¨ç¤ºäº†ä¸€ä¸ªepollå®ä¾‹ã€‚åç»­å¦‚æœæˆ‘ä»¬å†è°ƒç”¨epoll_ctlå’Œepoll_waitç­‰ï¼Œéƒ½æ˜¯å¯¹è¿™ä¸ªeventpollæ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿™éƒ¨åˆ†æ•°æ®ä¼šè¢«ä¿å­˜åœ¨epoll_createåˆ›å»ºçš„åŒ¿åæ–‡ä»¶fileçš„private_dataå­—æ®µä¸­ã€‚</p><pre><code>/*\n * This structure is stored inside the &quot;private_data&quot; member of the file\n * structure and represents the main data structure for the eventpoll\n * interface.\n */\nstruct eventpoll {\n    /* Protect the access to this structure */\n    spinlock_t lock;\n\n    /*\n     * This mutex is used to ensure that files are not removed\n     * while epoll is using them. This is held during the event\n     * collection loop, the file cleanup path, the epoll file exit\n     * code and the ctl operations.\n     */\n    struct mutex mtx;\n\n    /* Wait queue used by sys_epoll_wait() */\n    //è¿™ä¸ªé˜Ÿåˆ—é‡Œå­˜æ”¾çš„æ˜¯æ‰§è¡Œepoll_waitä»è€Œç­‰å¾…çš„è¿›ç¨‹é˜Ÿåˆ—\n    wait_queue_head_t wq;\n\n    /* Wait queue used by file-&gt;poll() */\n    //è¿™ä¸ªé˜Ÿåˆ—é‡Œå­˜æ”¾çš„æ˜¯è¯¥eventloopä½œä¸ºpollå¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹ï¼ŒåŠ å…¥åˆ°ç­‰å¾…çš„é˜Ÿåˆ—\n    //è¿™æ˜¯å› ä¸ºeventpollæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªfile, æ‰€ä»¥ä¹Ÿä¼šæœ‰pollæ“ä½œ\n    wait_queue_head_t poll_wait;\n\n    /* List of ready file descriptors */\n    //è¿™é‡Œå­˜æ”¾çš„æ˜¯äº‹ä»¶å°±ç»ªçš„fdåˆ—è¡¨ï¼Œé“¾è¡¨çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸‹é¢çš„epitem\n    struct list_head rdllist;\n\n    /* RB tree root used to store monitored fd structs */\n    //è¿™æ˜¯ç”¨æ¥å¿«é€ŸæŸ¥æ‰¾fdçš„çº¢é»‘æ ‘\n    struct rb_root_cached rbr;\n\n    /*\n     * This is a single linked list that chains all the &quot;struct epitem&quot; that\n     * happened while transferring ready events to userspace w/out\n     * holding -&gt;lock.\n     */\n    struct epitem *ovflist;\n\n    /* wakeup_source used when ep_scan_ready_list is running */\n    struct wakeup_source *ws;\n\n    /* The user that created the eventpoll descriptor */\n    struct user_struct *user;\n\n    //è¿™æ˜¯eventloopå¯¹åº”çš„åŒ¿åæ–‡ä»¶ï¼Œå……åˆ†ä½“ç°äº†Linuxä¸‹ä¸€åˆ‡çš†æ–‡ä»¶çš„æ€æƒ³\n    struct file *file;\n\n    /* used to optimize loop detection check */\n    int visited;\n    struct list_head visited_list_link;\n\n#ifdef CONFIG_NET_RX_BUSY_POLL\n    /* used to track busy poll napi_id */\n    unsigned int napi_id;\n#endif\n};\n</code></pre><p>ä½ èƒ½çœ‹åˆ°åœ¨ä»£ç ä¸­æˆ‘æåˆ°äº†epitemï¼Œè¿™ä¸ªepitemç»“æ„æ˜¯å¹²ä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ</p><p>æ¯å½“æˆ‘ä»¬è°ƒç”¨epoll_ctlå¢åŠ ä¸€ä¸ªfdæ—¶ï¼Œå†…æ ¸å°±ä¼šä¸ºæˆ‘ä»¬åˆ›å»ºå‡ºä¸€ä¸ªepitemå®ä¾‹ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªå®ä¾‹ä½œä¸ºçº¢é»‘æ ‘çš„ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¢åŠ åˆ°eventpollç»“æ„ä½“ä¸­çš„çº¢é»‘æ ‘ä¸­ï¼Œå¯¹åº”çš„å­—æ®µæ˜¯rbrã€‚è¿™ä¹‹åï¼ŒæŸ¥æ‰¾æ¯ä¸€ä¸ªfdä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿéƒ½æ˜¯é€šè¿‡çº¢é»‘æ ‘ä¸Šçš„epitemæ¥æ“ä½œã€‚</p><!-- [[[read_end]]] --><pre><code>/*\n * Each file descriptor added to the eventpoll interface will\n * have an entry of this type linked to the &quot;rbr&quot; RB tree.\n * Avoid increasing the size of this struct, there can be many thousands\n * of these on a server and we do not want this to take another cache line.\n */\nstruct epitem {\n    union {\n        /* RB tree node links this structure to the eventpoll RB tree */\n        struct rb_node rbn;\n        /* Used to free the struct epitem */\n        struct rcu_head rcu;\n    };\n\n    /* List header used to link this structure to the eventpoll ready list */\n    //å°†è¿™ä¸ªepitemè¿æ¥åˆ°eventpoll é‡Œé¢çš„rdllistçš„listæŒ‡é’ˆ\n    struct list_head rdllink;\n\n    /*\n     * Works together &quot;struct eventpoll&quot;-&gt;ovflist in keeping the\n     * single linked chain of items.\n     */\n    struct epitem *next;\n\n    /* The file descriptor information this item refers to */\n    //epollç›‘å¬çš„fd\n    struct epoll_filefd ffd;\n\n    /* Number of active wait queue attached to poll operations */\n    //ä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¢«å¤šä¸ªepollå®ä¾‹æ‰€ç›‘å¬ï¼Œè¿™é‡Œå°±è®°å½•äº†å½“å‰æ–‡ä»¶è¢«ç›‘å¬çš„æ¬¡æ•°\n    int nwait;\n\n    /* List containing poll wait queues */\n    struct list_head pwqlist;\n\n    /* The &quot;container&quot; of this item */\n    //å½“å‰epollitemæ‰€å±çš„eventpoll\n    struct eventpoll *ep;\n\n    /* List header used to link this item to the &quot;struct file&quot; items list */\n    struct list_head fllink;\n\n    /* wakeup_source used when EPOLLWAKEUP is set */\n    struct wakeup_source __rcu *ws;\n\n    /* The structure that describe the interested events and the source fd */\n    struct epoll_event event;\n};\n</code></pre><p>æ¯æ¬¡å½“ä¸€ä¸ªfdå…³è”åˆ°ä¸€ä¸ªepollå®ä¾‹ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªeppoll_entryäº§ç”Ÿã€‚eppoll_entryçš„ç»“æ„å¦‚ä¸‹ï¼š</p><pre><code>/* Wait structure used by the poll hooks */\nstruct eppoll_entry {\n    /* List header used to link this structure to the &quot;struct epitem&quot; */\n    struct list_head llink;\n\n    /* The &quot;base&quot; pointer is set to the container &quot;struct epitem&quot; */\n    struct epitem *base;\n\n    /*\n     * Wait queue item that will be linked to the target file wait\n     * queue head.\n     */\n    wait_queue_entry_t wait;\n\n    /* The wait queue head that linked the &quot;wait&quot; wait queue item */\n    wait_queue_head_t *whead;\n};\n</code></pre><h2>epoll_create</h2><p>æˆ‘ä»¬åœ¨ä½¿ç”¨epollçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨epoll_createæ¥åˆ›å»ºä¸€ä¸ªepollå®ä¾‹ã€‚è¿™ä¸ªå‡½æ•°æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢?</p><p>é¦–å…ˆï¼Œepoll_createä¼šå¯¹ä¼ å…¥çš„flagså‚æ•°åšç®€å•çš„éªŒè¯ã€‚</p><pre><code>/* Check the EPOLL_* constant for consistency.  */\nBUILD_BUG_ON(EPOLL_CLOEXEC != O_CLOEXEC);\n\nif (flags &amp; ~EPOLL_CLOEXEC)\n    return -EINVAL;\n/*\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œå†…æ ¸ç”³è¯·åˆ†é…eventpolléœ€è¦çš„å†…å­˜ç©ºé—´ã€‚</p><pre><code>/* Create the internal data structure (&quot;struct eventpoll&quot;).\n*/\nerror = ep_alloc(&amp;ep);\nif (error &lt; 0)\n  return error;\n</code></pre><p>åœ¨æ¥ä¸‹æ¥ï¼Œepoll_createä¸ºepollå®ä¾‹åˆ†é…äº†åŒ¿åæ–‡ä»¶å’Œæ–‡ä»¶æè¿°å­—ï¼Œå…¶ä¸­fdæ˜¯æ–‡ä»¶æè¿°å­—ï¼Œfileæ˜¯ä¸€ä¸ªåŒ¿åæ–‡ä»¶ã€‚è¿™é‡Œå……åˆ†ä½“ç°äº†UNIXä¸‹ä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶çš„æ€æƒ³ã€‚æ³¨æ„ï¼Œeventpollçš„å®ä¾‹ä¼šä¿å­˜ä¸€ä»½åŒ¿åæ–‡ä»¶çš„å¼•ç”¨ï¼Œé€šè¿‡è°ƒç”¨fd_installå‡½æ•°å°†åŒ¿åæ–‡ä»¶å’Œæ–‡ä»¶æè¿°å­—å®Œæˆäº†ç»‘å®šã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‰¹åˆ«éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œåœ¨è°ƒç”¨anon_inode_get_fileçš„æ—¶å€™ï¼Œepoll_createå°†eventpollä½œä¸ºåŒ¿åæ–‡ä»¶fileçš„private_dataä¿å­˜äº†èµ·æ¥ï¼Œè¿™æ ·ï¼Œåœ¨ä¹‹åé€šè¿‡epollå®ä¾‹çš„æ–‡ä»¶æè¿°å­—æ¥æŸ¥æ‰¾æ—¶ï¼Œå°±å¯ä»¥å¿«é€Ÿåœ°å®šä½åˆ°eventpollå¯¹è±¡äº†ã€‚</p><p>æœ€åï¼Œè¿™ä¸ªæ–‡ä»¶æè¿°å­—ä½œä¸ºepollçš„æ–‡ä»¶å¥æŸ„ï¼Œè¢«è¿”å›ç»™epoll_createçš„è°ƒç”¨è€…ã€‚</p><pre><code>/*\n * Creates all the items needed to setup an eventpoll file. That is,\n * a file structure and a free file descriptor.\n */\nfd = get_unused_fd_flags(O_RDWR | (flags &amp; O_CLOEXEC));\nif (fd &lt; 0) {\n    error = fd;\n    goto out_free_ep;\n}\nfile = anon_inode_getfile(&quot;[eventpoll]&quot;, &amp;eventpoll_fops, ep,\n             O_RDWR | (flags &amp; O_CLOEXEC));\nif (IS_ERR(file)) {\n    error = PTR_ERR(file);\n    goto out_free_fd;\n}\nep-&gt;file = file;\nfd_install(fd, file);\nreturn fd;\n</code></pre><h2>epoll_ctl</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸€ä¸ªå¥—æ¥å­—æ˜¯å¦‚ä½•è¢«æ·»åŠ åˆ°epollå®ä¾‹ä¸­çš„ã€‚è¿™å°±è¦è§£æä¸€ä¸‹epoll_ctlå‡½æ•°å®ç°äº†ã€‚</p><h3>æŸ¥æ‰¾epollå®ä¾‹</h3><p>é¦–å…ˆï¼Œepoll_ctlå‡½æ•°é€šè¿‡epollå®ä¾‹å¥æŸ„æ¥è·å¾—å¯¹åº”çš„åŒ¿åæ–‡ä»¶ï¼Œè¿™ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼ŒUNIXä¸‹ä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶ï¼Œepollçš„å®ä¾‹ä¹Ÿæ˜¯ä¸€ä¸ªåŒ¿åæ–‡ä»¶ã€‚</p><pre><code>//è·å¾—epollå®ä¾‹å¯¹åº”çš„åŒ¿åæ–‡ä»¶\nf = fdget(epfd);\nif (!f.file)\n    goto error_return;\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œè·å¾—æ·»åŠ çš„å¥—æ¥å­—å¯¹åº”çš„æ–‡ä»¶ï¼Œè¿™é‡Œtfè¡¨ç¤ºçš„æ˜¯target fileï¼Œå³å¾…å¤„ç†çš„ç›®æ ‡æ–‡ä»¶ã€‚</p><pre><code>/* Get the &quot;struct file *&quot; for the target file */\n//è·å¾—çœŸæ­£çš„æ–‡ä»¶ï¼Œå¦‚ç›‘å¬å¥—æ¥å­—ã€è¯»å†™å¥—æ¥å­—\ntf = fdget(fd);\nif (!tf.file)\n    goto error_fput;\n</code></pre><p>å†æ¥ä¸‹æ¥ï¼Œè¿›è¡Œäº†ä¸€ç³»åˆ—çš„æ•°æ®éªŒè¯ï¼Œä»¥ä¿è¯ç”¨æˆ·ä¼ å…¥çš„å‚æ•°æ˜¯åˆæ³•çš„ï¼Œæ¯”å¦‚epfdçœŸçš„æ˜¯ä¸€ä¸ªepollå®ä¾‹å¥æŸ„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶æè¿°ç¬¦ã€‚</p><pre><code>/* The target file descriptor must support poll */\n//å¦‚æœä¸æ”¯æŒpollï¼Œé‚£ä¹ˆè¯¥æ–‡ä»¶æè¿°å­—æ˜¯æ— æ•ˆçš„\nerror = -EPERM;\nif (!tf.file-&gt;f_op-&gt;poll)\n    goto error_tgt_fput;\n...\n</code></pre><p>å¦‚æœè·å¾—äº†ä¸€ä¸ªçœŸæ­£çš„epollå®ä¾‹å¥æŸ„ï¼Œå°±å¯ä»¥é€šè¿‡private_dataè·å–ä¹‹å‰åˆ›å»ºçš„eventpollå®ä¾‹äº†ã€‚</p><pre><code>/*\n * At this point it is safe to assume that the &quot;private_data&quot; contains\n * our own data structure.\n */\nep = f.file-&gt;private_data;\n</code></pre><h3>çº¢é»‘æ ‘æŸ¥æ‰¾</h3><p>æ¥ä¸‹æ¥epoll_ctlé€šè¿‡ç›®æ ‡æ–‡ä»¶å’Œå¯¹åº”æè¿°å­—ï¼Œåœ¨çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥å¥—æ¥å­—ï¼Œè¿™ä¹Ÿæ˜¯epollä¸ºä»€ä¹ˆé«˜æ•ˆçš„åœ°æ–¹ã€‚çº¢é»‘æ ‘ï¼ˆRB-treeï¼‰æ˜¯ä¸€ç§å¸¸è§çš„æ•°æ®ç»“æ„ï¼Œè¿™é‡Œeventpollé€šè¿‡çº¢é»‘æ ‘è·Ÿè¸ªäº†å½“å‰ç›‘å¬çš„æ‰€æœ‰æ–‡ä»¶æè¿°å­—ï¼Œè€Œè¿™æ£µæ ‘çš„æ ¹å°±ä¿å­˜åœ¨eventpollæ•°æ®ç»“æ„ä¸­ã€‚</p><pre><code>/* RB tree root used to store monitored fd structs */\nstruct rb_root_cached rbr;\n</code></pre><p>å¯¹äºæ¯ä¸ªè¢«ç›‘å¬çš„æ–‡ä»¶æè¿°å­—ï¼Œéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„epitemä¸ä¹‹å¯¹åº”ï¼Œepitemä½œä¸ºçº¢é»‘æ ‘ä¸­çš„èŠ‚ç‚¹å°±ä¿å­˜åœ¨çº¢é»‘æ ‘ä¸­ã€‚</p><pre><code>/*\n * Try to lookup the file inside our RB tree, Since we grabbed &quot;mtx&quot;\n * above, we can be sure to be able to use the item looked up by\n * ep_find() till we release the mutex.\n */\nepi = ep_find(ep, tf.file, fd);\n</code></pre><p>çº¢é»‘æ ‘æ˜¯ä¸€æ£µäºŒå‰æ ‘ï¼Œä½œä¸ºäºŒå‰æ ‘ä¸Šçš„èŠ‚ç‚¹ï¼Œepitemå¿…é¡»æä¾›æ¯”è¾ƒèƒ½åŠ›ï¼Œä»¥ä¾¿å¯ä»¥æŒ‰å¤§å°é¡ºåºæ„å»ºå‡ºä¸€æ£µæœ‰åºçš„äºŒå‰æ ‘ã€‚å…¶æ’åºèƒ½åŠ›æ˜¯ä¾é epoll_filefdç»“æ„ä½“æ¥å®Œæˆçš„ï¼Œepoll_filefdå¯ä»¥ç®€å•ç†è§£ä¸ºéœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°å­—ï¼Œå®ƒå¯¹åº”åˆ°äºŒå‰æ ‘ä¸Šçš„èŠ‚ç‚¹ã€‚</p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼ŒæŒ‰ç…§æ–‡ä»¶çš„åœ°å€å¤§å°æ’åºã€‚å¦‚æœä¸¤ä¸ªç›¸åŒï¼Œå°±æŒ‰ç…§æ–‡ä»¶æ–‡ä»¶æè¿°å­—æ¥æ’åºã€‚</p><pre><code>struct epoll_filefd {\n\tstruct file *file; // pointer to the target file struct corresponding to the fd\n\tint fd; // target file descriptor number\n} __packed;\n\n/* Compare RB tree keys */\nstatic inline int ep_cmp_ffd(struct epoll_filefd *p1,\n                            struct epoll_filefd *p2)\n{\n\treturn (p1-&gt;file &gt; p2-&gt;file ? +1:\n\t\t   (p1-&gt;file &lt; p2-&gt;file ? -1 : p1-&gt;fd - p2-&gt;fd));\n}\n</code></pre><p>åœ¨è¿›è¡Œå®Œçº¢é»‘æ ‘æŸ¥æ‰¾ä¹‹åï¼Œå¦‚æœå‘ç°æ˜¯ä¸€ä¸ªADDæ“ä½œï¼Œå¹¶ä¸”åœ¨æ ‘ä¸­æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„äºŒå‰æ ‘èŠ‚ç‚¹ï¼Œå°±ä¼šè°ƒç”¨ep_insertè¿›è¡ŒäºŒå‰æ ‘èŠ‚ç‚¹çš„å¢åŠ ã€‚</p><pre><code>case EPOLL_CTL_ADD:\n    if (!epi) {\n        epds.events |= POLLERR | POLLHUP;\n        error = ep_insert(ep, &amp;epds, tf.file, fd, full_check);\n    } else\n        error = -EEXIST;\n    if (full_check)\n        clear_tfile_check_list();\n    break;\n</code></pre><h3>ep_insert</h3><p>ep_inserté¦–å…ˆåˆ¤æ–­å½“å‰ç›‘æ§çš„æ–‡ä»¶å€¼æ˜¯å¦è¶…è¿‡äº†/proc/sys/fs/epoll/max_user_watchesçš„é¢„è®¾æœ€å¤§å€¼ï¼Œå¦‚æœè¶…è¿‡äº†åˆ™ç›´æ¥è¿”å›é”™è¯¯ã€‚</p><pre><code>user_watches = atomic_long_read(&amp;ep-&gt;user-&gt;epoll_watches);\nif (unlikely(user_watches &gt;= max_user_watches))\n    return -ENOSPC;\n</code></pre><p>æ¥ä¸‹æ¥æ˜¯åˆ†é…èµ„æºå’Œåˆå§‹åŒ–åŠ¨ä½œã€‚</p><pre><code>if (!(epi = kmem_cache_alloc(epi_cache, GFP_KERNEL)))\n        return -ENOMEM;\n\n    /* Item initialization follow here ... */\n    INIT_LIST_HEAD(&amp;epi-&gt;rdllink);\n    INIT_LIST_HEAD(&amp;epi-&gt;fllink);\n    INIT_LIST_HEAD(&amp;epi-&gt;pwqlist);\n    epi-&gt;ep = ep;\n    ep_set_ffd(&amp;epi-&gt;ffd, tfile, fd);\n    epi-&gt;event = *event;\n    epi-&gt;nwait = 0;\n    epi-&gt;next = EP_UNACTIVE_PTR;\n</code></pre><p>å†æ¥ä¸‹æ¥çš„äº‹æƒ…éå¸¸é‡è¦ï¼Œep_insertä¼šä¸ºåŠ å…¥çš„æ¯ä¸ªæ–‡ä»¶æè¿°å­—è®¾ç½®å›è°ƒå‡½æ•°ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°æ˜¯é€šè¿‡å‡½æ•°ep_ptable_queue_procæ¥è¿›è¡Œè®¾ç½®çš„ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿå…¶å®ï¼Œå¯¹åº”çš„æ–‡ä»¶æè¿°å­—ä¸Šå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚å¥—æ¥å­—ç¼“å†²åŒºæœ‰æ•°æ®äº†ï¼Œå°±ä¼šå›è°ƒè¿™ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯ep_poll_callbackã€‚è¿™é‡Œä½ ä¼šå‘ç°ï¼ŒåŸæ¥å†…æ ¸è®¾è®¡ä¹Ÿæ˜¯å……æ»¡äº†äº‹ä»¶å›è°ƒçš„åŸç†ã€‚</p><pre><code>/*\n * This is the callback that is used to add our wait queue to the\n * target file wakeup lists.\n */\nstatic void ep_ptable_queue_proc(struct file *file, wait_queue_head_t *whead,poll_table *pt)\n{\n    struct epitem *epi = ep_item_from_epqueue(pt);\n    struct eppoll_entry *pwq;\n\n    if (epi&gt;nwait &gt;= 0 &amp;&amp; (pwq = kmem_cache_alloc(pwq_cache, GFP_KERNEL))) {\n        init_waitqueue_func_entry(&amp;pwq-&gt;wait, ep_poll_callback);\n        pwq-&gt;whead = whead;\n        pwq-&gt;base = epi;\n        if (epi-&gt;event.events &amp; EPOLLEXCLUSIVE)\n            add_wait_queue_exclusive(whead, &amp;pwq-&gt;wait);\n        else\n            add_wait_queue(whead, &amp;pwq-&gt;wait);\n        list_add_tail(&amp;pwq-&gt;llink, &amp;epi-&gt;pwqlist);\n        epi-&gt;nwait++;\n    } else {\n        /* We have to signal that an error occurred */\n        epi-&gt;nwait = -1;\n    }\n}\n</code></pre><h3>ep_poll_callback</h3><p>ep_poll_callbackå‡½æ•°çš„ä½œç”¨éå¸¸é‡è¦ï¼Œå®ƒå°†å†…æ ¸äº‹ä»¶çœŸæ­£åœ°å’Œepollå¯¹è±¡è”ç³»äº†èµ·æ¥ã€‚å®ƒåˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶çš„wait_queue_entry_tå¯¹è±¡æ‰¾åˆ°å¯¹åº”çš„epitemå¯¹è±¡ï¼Œå› ä¸ºeppoll_entryå¯¹è±¡é‡Œä¿å­˜äº†wait_queue_entry_tï¼Œæ ¹æ®wait_queue_entry_tè¿™ä¸ªå¯¹è±¡çš„åœ°å€å°±å¯ä»¥ç®€å•è®¡ç®—å‡ºeppoll_entryå¯¹è±¡çš„åœ°å€ï¼Œä»è€Œå¯ä»¥è·å¾—epitemå¯¹è±¡çš„åœ°å€ã€‚è¿™éƒ¨åˆ†å·¥ä½œåœ¨ep_item_from_waitå‡½æ•°ä¸­å®Œæˆã€‚ä¸€æ—¦è·å¾—epitemå¯¹è±¡ï¼Œå°±å¯ä»¥å¯»è¿¹æ‰¾åˆ°eventpollå®ä¾‹ã€‚</p><pre><code>/*\n * This is the callback that is passed to the wait queue wakeup\n * mechanism. It is called by the stored file descriptors when they\n * have events to report.\n */\nstatic int ep_poll_callback(wait_queue_entry_t *wait, unsigned mode, int sync, void *key)\n{\n    int pwake = 0;\n    unsigned long flags;\n    struct epitem *epi = ep_item_from_wait(wait);\n    struct eventpoll *ep = epi-&gt;ep;\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œè¿›è¡Œä¸€ä¸ªåŠ é”æ“ä½œã€‚</p><pre><code>spin_lock_irqsave(&amp;ep-&gt;lock, flags);\n</code></pre><p>ä¸‹é¢å¯¹å‘ç”Ÿçš„äº‹ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿‡æ»¤å‘¢ï¼Ÿä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œep_insertå‘å¯¹åº”ç›‘æ§æ–‡ä»¶æ³¨å†Œçš„æ˜¯æ‰€æœ‰çš„äº‹ä»¶ï¼Œè€Œå®é™…ç”¨æˆ·ä¾§è®¢é˜…çš„äº‹ä»¶æœªå¿…å’Œå†…æ ¸äº‹ä»¶å¯¹åº”ã€‚æ¯”å¦‚ï¼Œç”¨æˆ·å‘å†…æ ¸è®¢é˜…äº†ä¸€ä¸ªå¥—æ¥å­—çš„å¯è¯»äº‹ä»¶ï¼Œåœ¨æŸä¸ªæ—¶åˆ»å¥—æ¥å­—çš„å¯å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¹¶ä¸éœ€è¦å‘ç”¨æˆ·ç©ºé—´ä¼ é€’è¿™ä¸ªäº‹ä»¶ã€‚</p><pre><code>/*\n * Check the events coming with the callback. At this stage, not\n * every device reports the events in the &quot;key&quot; parameter of the\n * callback. We need to be able to handle both cases here, hence the\n * test for &quot;key&quot; != NULL before the event match test.\n */\nif (key &amp;&amp; !((unsigned long) key &amp; epi-&gt;event.events))\n    goto out_unlock;\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æŠŠè¯¥äº‹ä»¶ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ã€‚</p><pre><code>if (unlikely(ep-&gt;ovflist != EP_UNACTIVE_PTR)) {\n  if (epi-&gt;next == EP_UNACTIVE_PTR) {\n      epi-&gt;next = ep-&gt;ovflist;\n      ep-&gt;ovflist = epi;\n      if (epi-&gt;ws) {\n          /*\n           * Activate ep-&gt;ws since epi-&gt;ws may get\n           * deactivated at any time.\n           */\n          __pm_stay_awake(ep-&gt;ws);\n      }\n  }\n  goto out_unlock;\n}\n</code></pre><p>å¦‚æœéœ€è¦ï¼Œè€Œä¸”è¯¥äº‹ä»¶å¯¹åº”çš„event_itemä¸åœ¨eventpollå¯¹åº”çš„å·²å®Œæˆé˜Ÿåˆ—ä¸­ï¼Œå°±æŠŠå®ƒæ”¾å…¥è¯¥é˜Ÿåˆ—ï¼Œä»¥ä¾¿å°†è¯¥äº‹ä»¶ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ã€‚</p><pre><code>/* If this file is already in the ready list we exit soon */\nif (!ep_is_linked(&amp;epi-&gt;rdllink)) {\n    list_add_tail(&amp;epi-&gt;rdllink, &amp;ep-&gt;rdllist);\n    ep_pm_stay_awake_rcu(epi);\n}\n</code></pre><p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“æˆ‘ä»¬è°ƒç”¨epoll_waitçš„æ—¶å€™ï¼Œè°ƒç”¨è¿›ç¨‹è¢«æŒ‚èµ·ï¼Œåœ¨å†…æ ¸çœ‹æ¥è°ƒç”¨è¿›ç¨‹é™·å…¥ä¼‘çœ ã€‚å¦‚æœè¯¥epollå®ä¾‹ä¸Šå¯¹åº”æè¿°å­—æœ‰äº‹ä»¶å‘ç”Ÿï¼Œè¿™ä¸ªä¼‘çœ è¿›ç¨‹åº”è¯¥è¢«å”¤é†’ï¼Œä»¥ä¾¿åŠæ—¶å¤„ç†äº‹ä»¶ã€‚ä¸‹é¢çš„ä»£ç å°±æ˜¯èµ·è¿™ä¸ªä½œç”¨çš„ï¼Œwake_up_lockedå‡½æ•°å”¤é†’å½“å‰eventpollä¸Šçš„ç­‰å¾…è¿›ç¨‹ã€‚</p><pre><code>/*\n * Wake up ( if active ) both the eventpoll wait list and the -&gt;poll()\n * wait list.\n */\nif (waitqueue_active(&amp;ep-&gt;wq)) {\n    if ((epi-&gt;event.events &amp; EPOLLEXCLUSIVE) &amp;&amp;\n                !((unsigned long)key &amp; POLLFREE)) {\n        switch ((unsigned long)key &amp; EPOLLINOUT_BITS) {\n        case POLLIN:\n            if (epi-&gt;event.events &amp; POLLIN)\n                ewake = 1;\n            break;\n        case POLLOUT:\n            if (epi-&gt;event.events &amp; POLLOUT)\n                ewake = 1;\n            break;\n        case 0:\n            ewake = 1;\n            break;\n        }\n    }\n    wake_up_locked(&amp;ep-&gt;wq);\n}\n</code></pre><h3>æŸ¥æ‰¾epollå®ä¾‹</h3><p>epoll_waitå‡½æ•°é¦–å…ˆè¿›è¡Œä¸€ç³»åˆ—çš„æ£€æŸ¥ï¼Œä¾‹å¦‚ä¼ å…¥çš„maxeventsåº”è¯¥å¤§äº0ã€‚</p><pre><code>/* The maximum number of event must be greater than zero */\nif (maxevents &lt;= 0 || maxevents &gt; EP_MAX_EVENTS)\n    return -EINVAL;\n\n/* Verify that the area passed by the user is writeable */\nif (!access_ok(VERIFY_WRITE, events, maxevents * sizeof(struct epoll_event)))\n    return -EFAULT;\n</code></pre><p>å’Œå‰é¢ä»‹ç»çš„epoll_ctlä¸€æ ·ï¼Œé€šè¿‡epollå®ä¾‹æ‰¾åˆ°å¯¹åº”çš„åŒ¿åæ–‡ä»¶å’Œæè¿°å­—ï¼Œå¹¶ä¸”è¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯ã€‚</p><pre><code>/* Get the &quot;struct file *&quot; for the eventpoll file */\nf = fdget(epfd);\nif (!f.file)\n    return -EBADF;\n\n/*\n * We have to check that the file structure underneath the fd\n * the user passed to us _is_ an eventpoll file.\n */\nerror = -EINVAL;\nif (!is_file_epoll(f.file))\n    goto error_fput;\n</code></pre><p>è¿˜æ˜¯é€šè¿‡è¯»å–epollå®ä¾‹å¯¹åº”åŒ¿åæ–‡ä»¶çš„private_dataå¾—åˆ°eventpollå®ä¾‹ã€‚</p><pre><code>/*\n * At this point it is safe to assume that the &quot;private_data&quot; contains\n * our own data structure.\n */\nep = f.file-&gt;private_data;\n</code></pre><p>æ¥ä¸‹æ¥è°ƒç”¨ep_pollæ¥å®Œæˆå¯¹åº”çš„äº‹ä»¶æ”¶é›†å¹¶ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><pre><code>/* Time to fish for events ... */\nerror = ep_poll(ep, events, maxevents, timeout);\n</code></pre><h3>ep_poll</h3><p>è¿˜è®°å¾—<a href=\"https://time.geekbang.org/column/article/143245\">ç¬¬23è®²</a>é‡Œä»‹ç»epollå‡½æ•°çš„æ—¶å€™ï¼Œå¯¹åº”çš„timeoutå€¼å¯ä»¥æ˜¯å¤§äº0ï¼Œç­‰äº0å’Œå°äº0ä¹ˆï¼Ÿè¿™é‡Œep_pollå°±åˆ†åˆ«å¯¹timeoutä¸åŒå€¼çš„åœºæ™¯è¿›è¡Œäº†å¤„ç†ã€‚å¦‚æœå¤§äº0åˆ™äº§ç”Ÿäº†ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå¦‚æœç­‰äº0åˆ™ç«‹å³æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚</p><pre><code>*/\nstatic int ep_poll(struct eventpoll *ep, struct epoll_event __user *events,int maxevents, long timeout)\n{\nint res = 0, eavail, timed_out = 0;\nunsigned long flags;\nu64 slack = 0;\nwait_queue_entry_t wait;\nktime_t expires, *to = NULL;\n\nif (timeout &gt; 0) {\n    struct timespec64 end_time = ep_set_mstimeout(timeout);\n    slack = select_estimate_accuracy(&amp;end_time);\n    to = &amp;expires;\n    *to = timespec64_to_ktime(end_time);\n} else if (timeout == 0) {\n    /*\n     * Avoid the unnecessary trip to the wait queue loop, if the\n     * caller specified a non blocking operation.\n     */\n    timed_out = 1;\n    spin_lock_irqsave(&amp;ep-&gt;lock, flags);\n    goto check_events;\n}\n</code></pre><p>æ¥ä¸‹æ¥å°è¯•è·å¾—eventpollä¸Šçš„é”ï¼š</p><pre><code>spin_lock_irqsave(&amp;ep-&gt;lock, flags);\n</code></pre><p>è·å¾—è¿™æŠŠé”ä¹‹åï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æŠŠå½“å‰è¿›ç¨‹åŠ å…¥åˆ°eventpollçš„ç­‰å¾…é˜Ÿåˆ—wqä¸­ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œep_poll_callbackå‡½æ•°å¯ä»¥æŠŠè¯¥ç­‰å¾…è¿›ç¨‹å”¤é†’ã€‚</p><pre><code>if (!ep_events_available(ep)) {\n    /*\n     * Busy poll timed out.  Drop NAPI ID for now, we can add\n     * it back in when we have moved a socket with a valid NAPI\n     * ID onto the ready list.\n     */\n    ep_reset_busy_poll_napi_id(ep);\n\n    /*\n     * We don't have any available event to return to the caller.\n     * We need to sleep here, and we will be wake up by\n     * ep_poll_callback() when events will become available.\n     */\n    init_waitqueue_entry(&amp;wait, current);\n    __add_wait_queue_exclusive(&amp;ep-&gt;wq, &amp;wait);\n</code></pre><p>ç´§æ¥ç€æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯, è¿™ä¸ªå¾ªç¯ä¸­é€šè¿‡è°ƒç”¨schedule_hrtimeout_rangeï¼Œå°†å½“å‰è¿›ç¨‹é™·å…¥ä¼‘çœ ï¼ŒCPUæ—¶é—´è¢«è°ƒåº¦å™¨è°ƒåº¦ç»™å…¶ä»–è¿›ç¨‹ä½¿ç”¨ï¼Œå½“ç„¶ï¼Œå½“å‰è¿›ç¨‹å¯èƒ½ä¼šè¢«å”¤é†’ï¼Œå”¤é†’çš„æ¡ä»¶åŒ…æ‹¬æœ‰ä»¥ä¸‹å››ç§ï¼š</p><ol>\n<li>å½“å‰è¿›ç¨‹è¶…æ—¶ï¼›</li>\n<li>å½“å‰è¿›ç¨‹æ”¶åˆ°ä¸€ä¸ªsignalä¿¡å·ï¼›</li>\n<li>æŸä¸ªæè¿°å­—ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿï¼›</li>\n<li>å½“å‰è¿›ç¨‹è¢«CPUé‡æ–°è°ƒåº¦ï¼Œè¿›å…¥forå¾ªç¯é‡æ–°åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³å‰ä¸‰ä¸ªæ¡ä»¶ï¼Œå°±åˆé‡æ–°è¿›å…¥ä¼‘çœ ã€‚</li>\n</ol><p>å¯¹åº”çš„1ã€2ã€3éƒ½ä¼šé€šè¿‡breakè·³å‡ºå¾ªç¯ï¼Œç›´æ¥è¿”å›ã€‚</p><pre><code>//è¿™ä¸ªå¾ªç¯é‡Œï¼Œå½“å‰è¿›ç¨‹å¯èƒ½ä¼šè¢«å”¤é†’ï¼Œå”¤é†’çš„é€”å¾„åŒ…æ‹¬\n//1.å½“å‰è¿›ç¨‹è¶…æ—¶\n//2.å½“å‰è¿›è¡Œæ”¶åˆ°ä¸€ä¸ªsignalä¿¡å·\n//3.æŸä¸ªæè¿°å­—ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿ\n//å¯¹åº”çš„1.2.3éƒ½ä¼šé€šè¿‡breakè·³å‡ºå¾ªç¯\n//ç¬¬4ä¸ªå¯èƒ½æ˜¯å½“å‰è¿›ç¨‹è¢«CPUé‡æ–°è°ƒåº¦ï¼Œè¿›å…¥forå¾ªç¯çš„åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³1.2.3çš„æ¡ä»¶ï¼Œå°±åˆé‡æ–°è¿›å…¥ä¼‘çœ \nfor (;;) {\n    /*\n     * We don't want to sleep if the ep_poll_callback() sends us\n     * a wakeup in between. That's why we set the task state\n     * to TASK_INTERRUPTIBLE before doing the checks.\n     */\n    set_current_state(TASK_INTERRUPTIBLE);\n    /*\n     * Always short-circuit for fatal signals to allow\n     * threads to make a timely exit without the chance of\n     * finding more events available and fetching\n     * repeatedly.\n     */\n    if (fatal_signal_pending(current)) {\n        res = -EINTR;\n        break;\n    }\n    if (ep_events_available(ep) || timed_out)\n        break;\n    if (signal_pending(current)) {\n        res = -EINTR;\n        break;\n    }\n\n    spin_unlock_irqrestore(&amp;ep-&gt;lock, flags);\n\n    //é€šè¿‡è°ƒç”¨schedule_hrtimeout_rangeï¼Œå½“å‰è¿›ç¨‹è¿›å…¥ä¼‘çœ ï¼ŒCPUæ—¶é—´è¢«è°ƒåº¦å™¨è°ƒåº¦ç»™å…¶ä»–è¿›ç¨‹ä½¿ç”¨\n    if (!schedule_hrtimeout_range(to, slack, HRTIMER_MODE_ABS))\n        timed_out = 1;\n\n    spin_lock_irqsave(&amp;ep-&gt;lock, flags);\n}\n</code></pre><p>å¦‚æœè¿›ç¨‹ä»ä¼‘çœ ä¸­è¿”å›ï¼Œåˆ™å°†å½“å‰è¿›ç¨‹ä»eventpollçš„ç­‰å¾…é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œå¹¶ä¸”è®¾ç½®å½“å‰è¿›ç¨‹ä¸ºTASK_RUNNINGçŠ¶æ€ã€‚</p><pre><code>//ä»ä¼‘çœ ä¸­ç»“æŸï¼Œå°†å½“å‰è¿›ç¨‹ä»waité˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œè®¾ç½®çŠ¶æ€ä¸ºTASK_RUNNINGï¼Œæ¥ä¸‹æ¥è¿›å…¥check_eventsï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯æœ‰äº‹ä»¶å‘ç”Ÿ\n    __remove_wait_queue(&amp;ep-&gt;wq, &amp;wait);\n    __set_current_state(TASK_RUNNING);\n</code></pre><p>æœ€åï¼Œè°ƒç”¨ep_send_eventså°†äº‹ä»¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p><pre><code>//ep_send_eventså°†äº‹ä»¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´\n/*\n * Try to transfer events to user space. In case we get 0 events and\n * there's still timeout left over, we go trying again in search of\n * more luck.\n */\nif (!res &amp;&amp; eavail &amp;&amp;\n    !(res = ep_send_events(ep, events, maxevents)) &amp;&amp; !timed_out)\n    goto fetch_events;\n\n\nreturn res;\n</code></pre><h3>ep_send_events</h3><p>ep_send_eventsè¿™ä¸ªå‡½æ•°ä¼šå°†ep_send_events_procä½œä¸ºå›è°ƒå‡½æ•°å¹¶è°ƒç”¨ep_scan_ready_listå‡½æ•°ï¼Œep_scan_ready_listå‡½æ•°è°ƒç”¨ep_send_events_procå¯¹æ¯ä¸ªå·²ç»å°±ç»ªçš„äº‹ä»¶å¾ªç¯å¤„ç†ã€‚</p><p>ep_send_events_procå¾ªç¯å¤„ç†å°±ç»ªäº‹ä»¶æ—¶ï¼Œä¼šå†æ¬¡è°ƒç”¨æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„pollæ–¹æ³•ï¼Œä»¥ä¾¿ç¡®å®šç¡®å®æœ‰äº‹ä»¶å‘ç”Ÿã€‚ä¸ºä»€ä¹ˆè¿™æ ·åšå‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†ç¡®å®šæ³¨å†Œçš„äº‹ä»¶åœ¨è¿™ä¸ªæ—¶åˆ»è¿˜æ˜¯æœ‰æ•ˆçš„ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œå°½ç®¡ep_send_events_procå·²ç»å°½å¯èƒ½çš„è€ƒè™‘å‘¨å…¨ï¼Œä½¿å¾—ç”¨æˆ·ç©ºé—´è·å¾—çš„äº‹ä»¶é€šçŸ¥éƒ½æ˜¯çœŸå®æœ‰æ•ˆçš„ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€å®šçš„æ¦‚ç‡ï¼Œå½“ep_send_events_procå†æ¬¡è°ƒç”¨æ–‡ä»¶ä¸Šçš„pollå‡½æ•°ä¹‹åï¼Œç”¨æˆ·ç©ºé—´è·å¾—çš„äº‹ä»¶é€šçŸ¥å·²ç»ä¸å†æœ‰æ•ˆï¼Œè¿™å¯èƒ½æ˜¯ç”¨æˆ·ç©ºé—´å·²ç»å¤„ç†æ‰äº†ï¼Œæˆ–è€…å…¶ä»–ä»€ä¹ˆæƒ…å½¢ã€‚è¿˜è®°å¾—<a href=\"https://time.geekbang.org/column/article/141573\">ç¬¬22è®²</a>å—ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå¥—æ¥å­—ä¸æ˜¯éé˜»å¡çš„ï¼Œæ•´ä¸ªè¿›ç¨‹å°†ä¼šè¢«é˜»å¡ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå°†éé˜»å¡å¥—æ¥å­—é…åˆepollä½¿ç”¨ä½œä¸ºæœ€ä½³å®è·µçš„åŸå› ã€‚</p><p>åœ¨è¿›è¡Œç®€å•çš„äº‹ä»¶æ©ç æ ¡éªŒä¹‹åï¼Œep_send_events_procå°†äº‹ä»¶ç»“æ„ä½“æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´éœ€è¦çš„æ•°æ®ç»“æ„ä¸­ã€‚è¿™æ˜¯é€šè¿‡__put_useræ–¹æ³•å®Œæˆçš„ã€‚</p><pre><code>//è¿™é‡Œå¯¹ä¸€ä¸ªfdå†æ¬¡è¿›è¡Œpollæ“ä½œï¼Œä»¥ç¡®è®¤äº‹ä»¶\nrevents = ep_item_poll(epi, &amp;pt);\n\n/*\n * If the event mask intersect the caller-requested one,\n * deliver the event to userspace. Again, ep_scan_ready_list()\n * is holding &quot;mtx&quot;, so no operations coming from userspace\n * can change the item.\n */\nif (revents) {\n    if (__put_user(revents, &amp;uevent-&gt;events) ||\n        __put_user(epi-&gt;event.data, &amp;uevent-&gt;data)) {\n        list_add(&amp;epi-&gt;rdllink, head);\n        ep_pm_stay_awake(epi);\n        return eventcnt ? eventcnt : -EFAULT;\n    }\n    eventcnt++;\n    uevent++;\n</code></pre><h2>Level-triggered VS Edge-triggered</h2><p>åœ¨<a href=\"https://time.geekbang.org/column/article/143245\">å‰é¢çš„</a><a href=\"https://time.geekbang.org/column/article/143245\">æ–‡ç« </a>é‡Œï¼Œæˆ‘ä»¬ä¸€ç›´éƒ½åœ¨å¼ºè°ƒlevel-triggeredå’Œedge-triggeredä¹‹é—´çš„åŒºåˆ«ã€‚</p><p>ä»å®ç°è§’åº¦æ¥çœ‹å…¶å®éå¸¸ç®€å•ï¼Œåœ¨ep_send_events_procå‡½æ•°çš„æœ€åï¼Œé’ˆå¯¹level-triggeredæƒ…å†µï¼Œå½“å‰çš„epoll_itemå¯¹è±¡è¢«é‡æ–°åŠ åˆ°eventpollçš„å°±ç»ªåˆ—è¡¨ä¸­ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€æ¬¡epoll_waitè°ƒç”¨æ—¶ï¼Œè¿™äº›epoll_itemå¯¹è±¡å°±ä¼šè¢«é‡æ–°å¤„ç†ã€‚</p><p>åœ¨å‰é¢æˆ‘ä»¬æåˆ°ï¼Œåœ¨æœ€ç»ˆæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´æœ‰æ•ˆäº‹ä»¶åˆ—è¡¨ä¸­ä¹‹å‰ï¼Œä¼šè°ƒç”¨å¯¹åº”æ–‡ä»¶çš„pollæ–¹æ³•ï¼Œä»¥ç¡®å®šè¿™ä¸ªäº‹ä»¶æ˜¯ä¸æ˜¯ä¾ç„¶æœ‰æ•ˆã€‚æ‰€ä»¥ï¼Œå¦‚æœç”¨æˆ·ç©ºé—´ç¨‹åºå·²ç»å¤„ç†æ‰è¯¥äº‹ä»¶ï¼Œå°±ä¸ä¼šè¢«å†æ¬¡é€šçŸ¥ï¼›å¦‚æœæ²¡æœ‰å¤„ç†ï¼Œæ„å‘³ç€è¯¥äº‹ä»¶ä¾ç„¶æœ‰æ•ˆï¼Œå°±ä¼šè¢«å†æ¬¡é€šçŸ¥ã€‚</p><pre><code>//è¿™é‡Œæ˜¯Level-triggeredçš„å¤„ç†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨Level-triggeredçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªäº‹ä»¶è¢«é‡æ–°åŠ å›åˆ°ready listé‡Œé¢\n//è¿™æ ·ï¼Œä¸‹ä¸€è½®epoll_waitçš„æ—¶å€™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šè¢«é‡æ–°check\nelse if (!(epi-&gt;event.events &amp; EPOLLET)) {\n    /*\n     * If this file has been added with Level\n     * Trigger mode, we need to insert back inside\n     * the ready list, so that the next call to\n     * epoll_wait() will check again the events\n     * availability. At this point, no one can insert\n     * into ep-&gt;rdllist besides us. The epoll_ctl()\n     * callers are locked out by\n     * ep_scan_ready_list() holding &quot;mtx&quot; and the\n     * poll callback will queue them in ep-&gt;ovflist.\n     */\n    list_add_tail(&amp;epi-&gt;rdllink, &amp;ep-&gt;rdllist);\n    ep_pm_stay_awake(epi);\n}\n</code></pre><h2>epoll VS poll/select</h2><p>æœ€åï¼Œæˆ‘ä»¬ä»å®ç°è§’åº¦æ¥è¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆepollçš„æ•ˆç‡è¦è¿œè¿œé«˜äºpoll/selectã€‚</p><p>é¦–å…ˆï¼Œpoll/selectå…ˆå°†è¦ç›‘å¬çš„fdä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´, ç„¶ååœ¨å†…æ ¸ç©ºé—´é‡Œé¢è¿›è¡Œå¤„ç†ä¹‹åï¼Œå†æ‹·è´ç»™ç”¨æˆ·ç©ºé—´ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°å†…æ ¸ç©ºé—´ç”³è¯·å†…å­˜ï¼Œé‡Šæ”¾å†…å­˜ç­‰ç­‰è¿‡ç¨‹ï¼Œè¿™åœ¨å¤§é‡fdæƒ…å†µä¸‹ï¼Œæ˜¯éå¸¸è€—æ—¶çš„ã€‚è€Œepollç»´æŠ¤äº†ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œé€šè¿‡å¯¹è¿™æ£µé»‘çº¢æ ‘è¿›è¡Œæ“ä½œï¼Œå¯ä»¥é¿å…å¤§é‡çš„å†…å­˜ç”³è¯·å’Œé‡Šæ”¾çš„æ“ä½œï¼Œè€Œä¸”æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«ã€‚</p><p>ä¸‹é¢çš„ä»£ç å°±æ˜¯poll/selectåœ¨å†…æ ¸ç©ºé—´ç”³è¯·å†…å­˜çš„å±•ç¤ºã€‚å¯ä»¥çœ‹åˆ°select æ˜¯å…ˆå°è¯•ç”³è¯·æ ˆä¸Šèµ„æº, å¦‚æœéœ€è¦ç›‘å¬çš„fdæ¯”è¾ƒå¤š, å°±ä¼šå»ç”³è¯·å †ç©ºé—´çš„èµ„æºã€‚</p><pre><code>int core_sys_select(int n, fd_set __user *inp, fd_set __user *outp,\n               fd_set __user *exp, struct timespec64 *end_time)\n{\n    fd_set_bits fds;\n    void *bits;\n    int ret, max_fds;\n    size_t size, alloc_size;\n    struct fdtable *fdt;\n    /* Allocate small arguments on the stack to save memory and be faster */\n    long stack_fds[SELECT_STACK_ALLOC/sizeof(long)];\n\n    ret = -EINVAL;\n    if (n &lt; 0)\n        goto out_nofds;\n\n    /* max_fds can increase, so grab it once to avoid race */\n    rcu_read_lock();\n    fdt = files_fdtable(current-&gt;files);\n    max_fds = fdt-&gt;max_fds;\n    rcu_read_unlock();\n    if (n &gt; max_fds)\n        n = max_fds;\n\n    /*\n     * We need 6 bitmaps (in/out/ex for both incoming and outgoing),\n     * since we used fdset we need to allocate memory in units of\n     * long-words. \n     */\n    size = FDS_BYTES(n);\n    bits = stack_fds;\n    if (size &gt; sizeof(stack_fds) / 6) {\n        /* Not enough space in on-stack array; must use kmalloc */\n        ret = -ENOMEM;\n        if (size &gt; (SIZE_MAX / 6))\n            goto out_nofds;\n\n\n        alloc_size = 6 * size;\n        bits = kvmalloc(alloc_size, GFP_KERNEL);\n        if (!bits)\n            goto out_nofds;\n    }\n    fds.in      = bits;\n    fds.out     = bits +   size;\n    fds.ex      = bits + 2*size;\n    fds.res_in  = bits + 3*size;\n    fds.res_out = bits + 4*size;\n    fds.res_ex  = bits + 5*size;\n    ...\n</code></pre><p>ç¬¬äºŒï¼Œselect/pollä»ä¼‘çœ ä¸­è¢«å”¤é†’æ—¶ï¼Œå¦‚æœç›‘å¬å¤šä¸ªfdï¼Œåªè¦å…¶ä¸­æœ‰ä¸€ä¸ªfdæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå†…æ ¸å°±ä¼šéå†å†…éƒ¨çš„listå»æ£€æŸ¥åˆ°åº•æ˜¯å“ªä¸€ä¸ªäº‹ä»¶åˆ°è¾¾ï¼Œå¹¶æ²¡æœ‰åƒepollä¸€æ ·, é€šè¿‡fdç›´æ¥å…³è”eventpollå¯¹è±¡ï¼Œå¿«é€Ÿåœ°æŠŠfdç›´æ¥åŠ å…¥åˆ°eventpollçš„å°±ç»ªåˆ—è¡¨ä¸­ã€‚</p><pre><code>static int do_select(int n, fd_set_bits *fds, struct timespec64 *end_time)\n{\n    ...\n    retval = 0;\n    for (;;) {\n        unsigned long *rinp, *routp, *rexp, *inp, *outp, *exp;\n        bool can_busy_loop = false;\n\n        inp = fds-&gt;in; outp = fds-&gt;out; exp = fds-&gt;ex;\n        rinp = fds-&gt;res_in; routp = fds-&gt;res_out; rexp = fds-&gt;res_ex;\n\n        for (i = 0; i &lt; n; ++rinp, ++routp, ++rexp) {\n            unsigned long in, out, ex, all_bits, bit = 1, mask, j;\n            unsigned long res_in = 0, res_out = 0, res_ex = 0;\n\n            in = *inp++; out = *outp++; ex = *exp++;\n            all_bits = in | out | ex;\n            if (all_bits == 0) {\n                i += BITS_PER_LONG;\n                continue;\n            }\n        \n        if (!poll_schedule_timeout(&amp;table, TASK_INTERRUPTIBLE,\n                   to, slack))\n        timed_out = 1;\n...\n</code></pre><h2>æ€»ç»“</h2><p>åœ¨è¿™æ¬¡ç­”ç–‘ä¸­ï¼Œæˆ‘å¸Œæœ›é€šè¿‡æ·±åº¦åˆ†æepollçš„æºç å®ç°ï¼Œå¸®ä½ ç†è§£epollçš„å®ç°åŸç†ã€‚</p><p>epollç»´æŠ¤äº†ä¸€æ£µçº¢é»‘æ ‘æ¥è·Ÿè¸ªæ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°å­—ï¼Œé»‘çº¢æ ‘çš„ä½¿ç”¨å‡å°‘äº†å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å¤§é‡çš„æ•°æ®æ‹·è´å’Œå†…å­˜åˆ†é…ï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½ã€‚</p><p>åŒæ—¶ï¼Œepollç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œå†…æ ¸åœ¨æ¯ä¸ªæ–‡ä»¶æœ‰äº‹ä»¶å‘ç”Ÿæ—¶å°†è‡ªå·±ç™»è®°åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ï¼Œé€šè¿‡å†…æ ¸è‡ªèº«çš„æ–‡ä»¶file-eventpollä¹‹é—´çš„å›è°ƒå’Œå”¤é†’æœºåˆ¶ï¼Œå‡å°‘äº†å¯¹å†…æ ¸æè¿°å­—çš„éå†ï¼Œå¤§å¤§åŠ é€Ÿäº†äº‹ä»¶é€šçŸ¥å’Œæ£€æµ‹çš„æ•ˆç‡ï¼Œè¿™ä¹Ÿä¸ºlevel-triggeredå’Œedge-triggeredçš„å®ç°å¸¦æ¥äº†ä¾¿åˆ©ã€‚</p><p>é€šè¿‡å¯¹æ¯”poll/selectçš„å®ç°ï¼Œæˆ‘ä»¬å‘ç°epollç¡®å®å…‹æœäº†poll/selectçš„ç§ç§å¼Šç«¯ï¼Œä¸æ„§æ˜¯Linuxä¸‹é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹çš„çš‡å† ã€‚æˆ‘ä»¬åº”è¯¥æ„Ÿè°¢Linuxç¤¾åŒºçš„å¤§ç¥ä»¬è®¾è®¡äº†è¿™ä¹ˆå¼ºå¤§çš„äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Œè®©æˆ‘ä»¬åœ¨Linuxä¸‹å¯ä»¥äº«å—é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨å¸¦æ¥çš„ç§ç§æŠ€æœ¯çº¢åˆ©ã€‚</p>","comments":[{"had_liked":false,"id":144856,"user_name":"herongwei","can_delete":false,"product_type":"c1","uid":1153928,"ip_address":"","ucode":"E4158BF7AD2E70","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/88/34c171f1.jpg","comment_is_top":false,"comment_ctime":1572076669,"is_pvip":false,"replies":[{"id":"55887","content":"èµåˆ†äº«ã€‚","user_name":"ä½œè€…å›å¤","comment_id":144856,"uid":"1618647","ip_address":"","utype":1,"ctime":1572099158,"user_name_real":"froghui"}],"discussion_count":2,"race_medal":0,"score":"87471422589","product_id":100032701,"comment_content":"è¿™ç¯‡æ–‡ç« å†™å¾—éå¸¸æ£’ï¼ä¹‹å‰å­¦ epollï¼Œåªä¼šæµäºè¡¨é¢ï¼Œä¹Ÿå¾ˆå°‘å»æ·±åº¦å‰–æåº•å±‚çš„æ•°æ®ç»“æ„ï¼Œå¤šè¯»å‡ é!<br>å¦å¤–åˆ†äº«ä¸€ä¸ªå¤§ä½¬åŒå­¦ epoll å†…æ ¸æºç è¯¦è§£å‘çš„å¸–å­ï¼šhttps:&#47;&#47;www.nowcoder.com&#47;discuss&#47;26226","like_count":21,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472140,"discussion_content":"èµåˆ†äº«ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572099158,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1469351,"avatar":"https://static001.geekbang.org/account/avatar/00/16/6b/a7/0ef65704.jpg","nickname":"å³å¢¨","note":"","ucode":"89AD683E6D3C25","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394617,"discussion_content":"åŠ ä¸€ç¯‡ï¼šhttps://mp.weixin.qq.com/s/O_QVxhyS7C3gJluqaLerWQ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631956025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142401,"user_name":"é±¼å‘åŒ—æ¸¸","can_delete":false,"product_type":"c1","uid":1439908,"ip_address":"","ucode":"580EC7DCE57E9A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IPdZZXuHVMibwfZWmm7NiawzeEFGsaRoWjhuN99iaoj5amcRkiaOePo6rH1KJ3jictmNlic4OibkF4I20vOGfwDqcBxfA/132","comment_is_top":false,"comment_ctime":1571363426,"is_pvip":false,"replies":[{"id":"55125","content":"ä½ è¿™ä¸ªç†è§£å€’æ˜¯æ¯”è¾ƒæœ‰è¶£ï¼Œç¨‹åºæ˜¯ä¼Ÿå¤§çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":142401,"uid":"1618647","ip_address":"","utype":1,"ctime":1571457642,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"70290840162","product_id":100032701,"comment_content":"selectè¿™ç§æ˜¯æŠŠç­‰å¾…é˜Ÿåˆ—å’Œå°±ç»ªé˜Ÿåˆ—æ··åœ¨ä¸€èµ·ï¼Œepollæ ¹æ®è¿™ä¸¤ç§é˜Ÿåˆ—çš„ç‰¹æ€§ç”¨ä¸¤ç§æ•°æ®ç»“æ„æŠŠè¿™ä¸¤ä¸ªé˜Ÿåˆ—åˆ†å¼€ï¼Œæœç„¶åœ¨ç¨‹åºä¸–ç•Œæ²¡æœ‰è§£å†³ä¸äº†çš„äº‹æƒ…ï¼Œå¦‚æœæœ‰ï¼Œå°±åŠ ä¸€ä¸ªä¸­é—´å±‚","like_count":16,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471107,"discussion_content":"ä½ è¿™ä¸ªç†è§£å€’æ˜¯æ¯”è¾ƒæœ‰è¶£ï¼Œç¨‹åºæ˜¯ä¼Ÿå¤§çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571457642,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":177354,"user_name":"å‡‰äººã€‚","can_delete":false,"product_type":"c1","uid":1659177,"ip_address":"","ucode":"4DB16004A62015","user_header":"https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg","comment_is_top":false,"comment_ctime":1581352857,"is_pvip":false,"replies":[{"id":"71015","content":"å—¯ï¼Œå¥½å»ºè®®ï¼Œè®°ä¸‹äº†ã€‚","user_name":"ä½œè€…å›å¤","comment_id":177354,"uid":"1618647","ip_address":"","utype":1,"ctime":1583050723,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"35941091225","product_id":100032701,"comment_content":"æ„Ÿè§‰è¿™ä¸€ç« æ˜¯æœ€éš¾ä»¥ç†è§£ï¼Œå¦‚æœå¤šä¸€äº›ç»“æ„å›¾ï¼Œæµç¨‹å›¾ï¼Œä¼šå¥½å¾ˆå¤šã€‚","like_count":8,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483398,"discussion_content":"å—¯ï¼Œå¥½å»ºè®®ï¼Œè®°ä¸‹äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583050723,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172149,"user_name":"HerofH","can_delete":false,"product_type":"c1","uid":1480252,"ip_address":"","ucode":"84EB3243FAB432","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/86QEF74Mhc6ECbBBMr62hVz0ezOicI2Kbv8QBA7qR7KepeoDib9W6KLxxMPuQ24JGusvjC03NNr8uj8GyK0DxKiaw/132","comment_is_top":false,"comment_ctime":1579096118,"is_pvip":false,"replies":[{"id":"68044","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":172149,"uid":"1618647","ip_address":"","utype":1,"ctime":1580624466,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"23053932598","product_id":100032701,"comment_content":"é¦–å…ˆæ„Ÿè°¢è€å¸ˆçš„ç²¾å½©åˆ†æã€‚<br><br>ç„¶åè¯´ä¸‹æˆ‘çš„ä¸ªäººç†è§£ï¼šepollä¹‹æ‰€ä»¥æ•ˆç‡æ¯”selecté«˜ï¼ŒåŸå› åœ¨äºselectè¦åšçš„äº‹æƒ…å¤ªå¤šï¼Œæ¯æ¬¡è°ƒç”¨selectä¸ä»…éœ€è¦å°†æè¿°ç¬¦é›†æ·»åŠ åˆ°ç›‘å¬é˜Ÿåˆ—ä¸­ï¼Œè¿˜è¦è´Ÿè´£ç›‘å¬äº‹ä»¶å‘ç”Ÿåçš„å¤„ç†ï¼Œä»¥åŠselectæœ€åçš„æ¸…ç†å·¥ä½œç­‰ç­‰...<br>è€Œepollåˆ™æŠŠè¿™ä¹ˆå¤šäº‹æƒ…åˆ†åˆ°äº†epoll_ctlå’Œepoll_waitå»å¤„ç†ï¼Œè°ƒç”¨epoll_ctlå¯ä»¥å¼€å¯äº‹ä»¶çš„ç›‘å¬å·¥ä½œï¼Œepoll_waitåˆ™å¯ä»¥å®Œæˆå¯¹å·²æ¿€æ´»çš„äº‹ä»¶çš„å¤„ç†å·¥ä½œï¼Œæœ€åclose(epfd)å®Œæˆepollçš„æ¸…ç†å·¥ä½œã€‚<br>è€Œselectå’Œepoll_waitæ˜¯å¾ªç¯ä¸­åå¤è°ƒç”¨çš„ï¼Œepoll_waitåšçš„äº‹æƒ…æ¯”selectå°‘å¤šäº†ï¼Œå› æ­¤ä»è¿™ä¸ªè§’åº¦æ¥è¯´epollæ•ˆç‡ä¼šæ¯”selectæ•ˆç‡é«˜ã€‚<br>é™¤æ­¤ä¹‹å¤–ï¼Œä¸ªäººæ„Ÿè§‰epollè¿˜æœ‰ä¸€ä¸ªå¦™å¤„å°±æ˜¯å°±ç»ªé“¾è¡¨ï¼Œå½“ç›‘å¬çš„äº‹ä»¶å‘ç”Ÿåï¼Œç›¸åº”çš„epitemä¼šè‡ªåŠ¨åœ¨ç›‘å¬å›è°ƒä¸­å°†å…¶æ·»åŠ åˆ°å°±ç»ªé“¾è¡¨ä¸­ï¼Œè€Œå¯¹äºselectæ¥è¯´ï¼Œåˆ™éœ€è¦ä¸åœå¯¹æ‰€æœ‰ç›‘å¬çš„æè¿°ç¬¦è¿›è¡Œéå†ï¼Œæ¥æ£€æŸ¥å®ƒä»¬çš„çŠ¶æ€ã€‚<br><br>ä¸çŸ¥é“ç†è§£æ˜¯å¦æ­£ç¡®ï¼Œæ•¬è¯·æŒ‡æ­£ã€‚<br>","like_count":6,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481639,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580624466,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144786,"user_name":"fackgc17","can_delete":false,"product_type":"c1","uid":1017299,"ip_address":"","ucode":"490193B440BFA0","user_header":"https://static001.geekbang.org/account/avatar/00/0f/85/d3/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1572057796,"is_pvip":false,"replies":[{"id":"55845","content":"linux 4.14.4","user_name":"ä½œè€…å›å¤","comment_id":144786,"uid":"1618647","ip_address":"","utype":1,"ctime":1572065257,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"18751926980","product_id":100032701,"comment_content":"å¯ä»¥æä¾›ä¸€ä¸‹åˆ†æç”¨çš„ kernel ç‰ˆæœ¬å—","like_count":4,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472110,"discussion_content":"linux 4.14.4","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572065257,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":207810,"user_name":"heyman","can_delete":false,"product_type":"c1","uid":1173894,"ip_address":"","ucode":"92EF9EF1B1B1B3","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg","comment_is_top":false,"comment_ctime":1587185987,"is_pvip":false,"replies":[{"id":"77721","content":"å°±æ˜¯è¦ç¡®ä¿æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤çš„é«˜æ•ˆå•Šï¼Œè¦çŸ¥é“ï¼Œ10Kä»¥ä¸Šçš„è¿æ¥æ—¶ï¼Œè¿™ä¸ªå¯¹æ€§èƒ½è¦æ±‚éå¸¸è‹›åˆ»ï¼Œä¸€ä¸ªé«˜æ•ˆçš„æ•°æ®ç»“æ„å¯¹äºå®Œæˆä¸Šè¿°æ“ä½œæ˜¯éå¸¸å…³é”®çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":207810,"uid":"1618647","ip_address":"","utype":1,"ctime":1587304538,"user_name_real":"froghui"}],"discussion_count":4,"race_medal":0,"score":"10177120579","product_id":100032701,"comment_content":"è¯·é—®ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆè¦ç”¨çº¢é»‘æ ‘ï¼Ÿæ˜¯å› ä¸ºè¦æ’åºå—ï¼Ÿæ’åºçš„æ„ä¹‰åˆåœ¨å“ªé‡Œï¼Ÿç¡®ä¿æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤çš„é«˜æ•ˆè¿˜ä¸å¤Ÿå—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492248,"discussion_content":"å°±æ˜¯è¦ç¡®ä¿æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤çš„é«˜æ•ˆå•Šï¼Œè¦çŸ¥é“ï¼Œ10Kä»¥ä¸Šçš„è¿æ¥æ—¶ï¼Œè¿™ä¸ªå¯¹æ€§èƒ½è¦æ±‚éå¸¸è‹›åˆ»ï¼Œä¸€ä¸ªé«˜æ•ˆçš„æ•°æ®ç»“æ„å¯¹äºå®Œæˆä¸Šè¿°æ“ä½œæ˜¯éå¸¸å…³é”®çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587304538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1255820,"avatar":"https://static001.geekbang.org/account/avatar/00/13/29/8c/3a810521.jpg","nickname":"CaptainBerg","note":"","ucode":"4033CF49863F7E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":296778,"discussion_content":"åŒä¸ç†è§£ï¼Œéº»çƒ¦è€å¸ˆè§£ç­”ä¸€ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596643818,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1173894,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg","nickname":"heyman","note":"","ucode":"92EF9EF1B1B1B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":240042,"discussion_content":"ç”¨hash mapä¹Ÿè¡Œå§ï¼Ÿä¸ºå•¥éè¦ç”¨çº¢é»‘æ ‘ï¼Ÿæˆ‘æ€€ç–‘æ˜¯å› ä¸ºéœ€è¦æ’åºã€‚ä½†æˆ‘æ²¡ç†è§£æ’åºåœ¨è¿™é‡Œæœ‰å•¥ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587314602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2046036,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/sOuSC65kXWdWBAIIs6uXAD41Ed8Wo8tib81LLVOQJ2oK23TgPDy6x0PGmp7rXwLR3BHOicaKx1zib1DyfpCITK3dw/132","nickname":"GeekYanger","note":"","ucode":"E674B7D25261CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1173894,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg","nickname":"heyman","note":"","ucode":"92EF9EF1B1B1B3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":409737,"discussion_content":"æ˜¯ä¸ºäº†ç¨³å®šï¼Œçº¢é»‘æ ‘çš„æ’å…¥åˆ é™¤æŸ¥æ‰¾æ€§èƒ½éƒ½æ˜¯O(logN)è€Œå“ˆå¸Œè¡¨çš„æ’å…¥åˆ é™¤æŸ¥æ‰¾æ€§èƒ½ç†è®ºä¸Šéƒ½æ˜¯O(1)ï¼Œåœ¨è¿™ä¸ªå¯¹æ¯”ä¸Šæ¥çœ‹ï¼Œçº¢é»‘æ ‘æ€§èƒ½è¿œæ²¡æœ‰å“ˆå¸Œè¡¨ä¼˜ç§€ã€‚ä½†æ˜¯å€¼å¾—ä¸€æçš„æ˜¯çº¢é»‘æ ‘ï¼Œä»–æ˜¯ç›¸å¯¹äºç¨³å®šçš„ï¼Œæœ€å·®æƒ…å†µä¸‹éƒ½æ˜¯é«˜æ•ˆçš„ã€‚è€Œç›¸å¯¹äºå“ˆå¸Œè¡¨è¿™ä¸ªæ•°æ®ç»“æ„æ¥è®²ï¼Œå“ˆå¸Œè¡¨çš„æ’å…¥åˆ é™¤æ“ä½œçš„ç†è®ºä¸Šæ—¶é—´å¤æ‚åº¦æ˜¯å¸¸æ•°æ—¶é—´çš„ï¼Œè¿™æœ‰ä¸ªå‰æå°±æ˜¯å“ˆå¸Œè¡¨ä¸å‘ç”Ÿæ•°æ®ç¢°æ’ã€‚åœ¨å‘ç”Ÿç¢°æ’çš„æœ€åçš„æƒ…å†µä¸‹ï¼Œå“ˆå¸Œè¡¨çš„æ’å…¥å’Œåˆ é™¤æ—¶é—´å¤æ‚åº¦æœ€åèƒ½è¾¾åˆ°O(n)ã€‚è€Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå½“ç„¶ä¸€ä¸ªç›¸å¯¹ç¨³å®šä¸”å¿«é€Ÿçš„æ•°æ®ç»“æ„æ˜¯æ¯”è¾ƒç†æƒ³çš„é€‰æ‹©ã€‚å…¶æ¬¡O(1)ï¼ŒO(n)æ˜¯ç®—æ³•å¤æ‚åº¦ï¼Œä½†æ˜¯åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œrehashçš„å¼€é”€æ˜¯ååˆ†å·¨å¤§çš„ï¼Œåœ¨é«˜å¹¶å‘æ—¶å¯èƒ½ä¼šå¯¼è‡´æŸäº›æ¶ˆæ¯æ— æ³•åŠæ—¶åº”ç­”ã€‚\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1635499719,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":240042,"ip_address":""},"score":409737,"extra":""}]}]},{"had_liked":false,"id":157571,"user_name":"é’±","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1575198027,"is_pvip":false,"replies":[{"id":"61033","content":"å¾…æˆ‘æ‰¾é»„å§‘å¨˜æ¥:)","user_name":"ä½œè€…å›å¤","comment_id":157571,"uid":"1618647","ip_address":"","utype":1,"ctime":1575799722,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"10165132619","product_id":100032701,"comment_content":"åŠŸåŠ›ä¸å¤Ÿï¼Œè¯»èµ·æ¥æœ‰äº›è´¹åŠ²ï¼Œå¥½ä¼¼æ‹¿åˆ°äº†ä¹é˜´çœŸç»ï¼Œä¸è¿‡éœ€è¦é»„å§‘å¨˜ç¿»è¯‘ä¸€ä¸‹ï¼<br>å¦‚æœèƒ½æ¥ä¸ªå›¾ï¼Œå°±å¥½äº†ğŸ˜","like_count":2,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476470,"discussion_content":"å¾…æˆ‘æ‰¾é»„å§‘å¨˜æ¥:)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575799722,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320138,"user_name":"ç“œç‰›","can_delete":false,"product_type":"c1","uid":2273620,"ip_address":"","ucode":"5EB7D2F4400A70","user_header":"https://static001.geekbang.org/account/avatar/00/22/b1/54/6d663b95.jpg","comment_is_top":false,"comment_ctime":1636095954,"is_pvip":false,"replies":[{"id":"116137","content":"ç®€å•çš„è¯´ï¼Œpoll&#47;selectéœ€è¦æ¯æ¬¡å¾ªç¯åˆ¤æ–­å‡ºæœ‰äº‹ä»¶çš„fdï¼Œè¿™ä»½ä¿¡æ¯æ˜¯ä¸€ä¸ªå…¨é‡çš„æ‹·è´ï¼›è€Œepollåˆ™ç›´æ¥æ‹¿åˆ°äº‹ä»¶å‘ç”Ÿåçš„ä¿¡æ¯ã€‚ä¸€ä¸ªæ˜¯ALLï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨å˜åŒ–çš„éƒ¨åˆ†ï¼Œä½ è¯´å°‘æ²¡å°‘æ‹·è´ï¼Ÿ","user_name":"ä½œè€…å›å¤","comment_id":320138,"uid":"1618647","ip_address":"","utype":1,"ctime":1636273089,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"5931063250","product_id":100032701,"comment_content":"è¿˜æ˜¯æ²¡æ˜ç™½ä¸ºå•¥epollæœ‰çº¢é»‘æ ‘ä¹‹åå°±ä¸ç”¨åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´äº†ï¼Œæˆ–è€…è¯´poll&#47;selectä¸ºå•¥è¦åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529889,"discussion_content":"ç®€å•çš„è¯´ï¼Œpoll/selectéœ€è¦æ¯æ¬¡å¾ªç¯åˆ¤æ–­å‡ºæœ‰äº‹ä»¶çš„fdï¼Œè¿™ä»½ä¿¡æ¯æ˜¯ä¸€ä¸ªå…¨é‡çš„æ‹·è´ï¼›è€Œepollåˆ™ç›´æ¥æ‹¿åˆ°äº‹ä»¶å‘ç”Ÿåçš„ä¿¡æ¯ã€‚ä¸€ä¸ªæ˜¯ALLï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨å˜åŒ–çš„éƒ¨åˆ†ï¼Œä½ è¯´å°‘æ²¡å°‘æ‹·è´ï¼Ÿ","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1636273089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":182721,"user_name":"xupeng1644","can_delete":false,"product_type":"c1","uid":1596906,"ip_address":"","ucode":"B3110D74266886","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83errIIarFicghpKamvkUaJmGdIV488iaOUyUqcTwbQ6IeRS40ZFfIOfb369fgleydAT8pkucHuj2x45A/132","comment_is_top":false,"comment_ctime":1582855975,"is_pvip":false,"replies":[{"id":"71029","content":"Edge-triggeredä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå°±æ˜¯æœ‰äº‹ä»¶é€šçŸ¥ä¸€æ¬¡ç»“æŸï¼Œè¿™é‡ŒLevel-triggeredè¿˜éœ€è¦æŠŠæ²¡æœ‰å®Œç»“çš„äº‹ä»¶åœ¨æ‹·è´ä¸€æ¬¡é€šçŸ¥ç»™åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","comment_id":182721,"uid":"1618647","ip_address":"","utype":1,"ctime":1583052231,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"5877823271","product_id":100032701,"comment_content":"è€å¸ˆ åœ¨Level-triggered VS Edge-triggeredå°èŠ‚ä¸­ç»™å‡ºäº†Level-triggeredçš„å®ç°æœºåˆ¶ï¼Œå¯ä»¥å†ç»™ä¸‹Edge-triggeredçš„å—","like_count":1,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485427,"discussion_content":"Edge-triggeredä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå°±æ˜¯æœ‰äº‹ä»¶é€šçŸ¥ä¸€æ¬¡ç»“æŸï¼Œè¿™é‡ŒLevel-triggeredè¿˜éœ€è¦æŠŠæ²¡æœ‰å®Œç»“çš„äº‹ä»¶åœ¨æ‹·è´ä¸€æ¬¡é€šçŸ¥ç»™åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1583052231,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145772,"user_name":"J.M.Liu","can_delete":false,"product_type":"c1","uid":1200037,"ip_address":"","ucode":"B2CB84B8E923A6","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/a5/71358d7b.jpg","comment_is_top":false,"comment_ctime":1572363100,"is_pvip":false,"replies":[{"id":"56639","content":"çœ‹å¾—å¥½è‡ªä¿¡ï¼Œæ±—ï¼Œæˆ‘è¯•ç€å›ç­”å“ˆï¼š<br><br>1.æ ¹æ®å¥—æ¥å­—æ–‡ä»¶ä¸Šçš„pollæ¥å£ï¼Œå¥—æ¥å­—æ–‡ä»¶ä¸Šè®°å½•äº†å®ƒæœ‰æ•ˆçš„äº‹ä»¶ï¼š<br>static inline unsigned int ep_item_poll(struct epitem *epi, poll_table *pt)<br>{<br>\tpt-&gt;_key = epi-&gt;event.events;<br><br>\treturn epi-&gt;ffd.file-&gt;f_op-&gt;poll(epi-&gt;ffd.file, pt) &amp; epi-&gt;event.events;<br>}<br><br>2.æ˜¯çš„ã€‚<br><br>static int ep_scan_ready_list(struct eventpoll *ep,<br>\t\t\t      int (*sproc)(struct eventpoll *,<br>\t\t\t\t\t   struct list_head *, void *),<br>\t\t\t      void *priv, int depth, bool ep_locked)<br>{<br>\tint error, pwake = 0;<br>\tunsigned long flags;<br>\tstruct epitem *epi, *nepi;<br>\tLIST_HEAD(txlist);<br><br>\t&#47;*<br>\t * We need to lock this because we could be hit by<br>\t * eventpoll_release_file() and epoll_ctl().<br>\t *&#47;<br><br>\tif (!ep_locked)<br>\t\tmutex_lock_nested(&amp;ep-&gt;mtx, depth);<br>        ...<br>}","user_name":"ä½œè€…å›å¤","comment_id":145772,"uid":"1618647","ip_address":"","utype":1,"ctime":1572574726,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"5867330396","product_id":100032701,"comment_content":"è€å¸ˆï¼Œæˆ‘è¯·æ•™ä¸¤ä¸ªé—®é¢˜ï¼š<br>1.ep_send_events_procè¿™ä¸ªå‡½æ•°åœ¨æŠŠeventsåˆ—è¡¨æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´å‰ä¼šè°ƒç”¨ep_item_pollå‡½æ•°ï¼Œå·²ç¡®å®šå¯¹åº”çš„fdä¸Šçš„äº‹ä»¶ä¾æ—§æœ‰æ•ˆã€‚é‚£ep_item_pollæ˜¯æ ¹æ®ä»€ä¹ˆæ¥ç¡®å®šäº‹ä»¶çš„æœ‰æ•ˆæ€§å‘¢ï¼Ÿ<br>2.åœ¨ep_send_events_procå¤„ç†level-triggeredçš„æ—¶å€™ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µè¯â€œAt this point, no one can insert into ep-&gt;rdllist besides us. The epoll_ctl()  callers are locked out by ep_scan_ready_list() holding &quot;mtx&quot; and the  poll callback will queue them in ep-&gt;ovflist.â€æ„æ€æ˜¯è¯´epoll_ctlï¼ˆï¼‰çš„è°ƒç”¨è€…ä¹Ÿè¢«é”åœ¨å¤–é¢äº†ã€‚è¿™ä¸ªé”æ˜¯è¯´åœ¨ep_send_events_procè¿˜æ²¡å¤„ç†å®Œçš„æ—¶å€™ï¼Œepoll_ctl()æ— æ³•æ“çºµrdllistï¼Œä½†æ˜¯ä¹‹åæ˜¯å¯ä»¥çš„ï¼Œä»¥å®ç°å†æ¬¡æ³¨å†Œæ„Ÿå…´è¶£çš„æ—¶é—´ã€‚æ˜¯è¿™æ ·å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472572,"discussion_content":"çœ‹å¾—å¥½è‡ªä¿¡ï¼Œæ±—ï¼Œæˆ‘è¯•ç€å›ç­”å“ˆï¼š\n\n1.æ ¹æ®å¥—æ¥å­—æ–‡ä»¶ä¸Šçš„pollæ¥å£ï¼Œå¥—æ¥å­—æ–‡ä»¶ä¸Šè®°å½•äº†å®ƒæœ‰æ•ˆçš„äº‹ä»¶ï¼š\nstatic inline unsigned int ep_item_poll(struct epitem *epi, poll_table *pt)\n{\n\tpt-&amp;gt;_key = epi-&amp;gt;event.events;\n\n\treturn epi-&amp;gt;ffd.file-&amp;gt;f_op-&amp;gt;poll(epi-&amp;gt;ffd.file, pt) &amp;amp; epi-&amp;gt;event.events;\n}\n\n2.æ˜¯çš„ã€‚\n\nstatic int ep_scan_ready_list(struct eventpoll *ep,\n\t\t\t      int (*sproc)(struct eventpoll *,\n\t\t\t\t\t   struct list_head *, void *),\n\t\t\t      void *priv, int depth, bool ep_locked)\n{\n\tint error, pwake = 0;\n\tunsigned long flags;\n\tstruct epitem *epi, *nepi;\n\tLIST_HEAD(txlist);\n\n\t/*\n\t * We need to lock this because we could be hit by\n\t * eventpoll_release_file() and epoll_ctl().\n\t */\n\n\tif (!ep_locked)\n\t\tmutex_lock_nested(&amp;amp;ep-&amp;gt;mtx, depth);\n        ...\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572574726,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142714,"user_name":"æ²‰æ·€çš„æ¢¦æƒ³","can_delete":false,"product_type":"c1","uid":1177315,"ip_address":"","ucode":"BCB7C26F9D214B","user_header":"https://static001.geekbang.org/account/avatar/00/11/f6/e3/e4bcd69e.jpg","comment_is_top":false,"comment_ctime":1571472750,"is_pvip":false,"replies":[{"id":"55595","content":"ä¸»è¦æ˜¯ç†è§£æ•´ä½“çš„æ¦‚å¿µå’Œè®¾è®¡ï¼Œç»†èŠ‚ä¸ç”¨ç†è§£å¤ªæ·±ã€‚å¯ä»¥è¯»ç†è§£å‡ éï¼Œè‚¯å®šä¼šæœ‰æ”¶è·çš„ã€‚","user_name":"ä½œè€…å›å¤","comment_id":142714,"uid":"1618647","ip_address":"","utype":1,"ctime":1571845930,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"5866440046","product_id":100032701,"comment_content":"ç¼ºä¹Cè¯­è¨€å’Œlinuxå†…æ ¸åŸºç¡€çš„äººè¯»èµ·è¿™äº›æºç æ¥ç›¸å½“åƒåŠ›ï¼Œè™½ç„¶è€å¸ˆè®²å¾—å¾ˆå¥½","like_count":1,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471238,"discussion_content":"ä¸»è¦æ˜¯ç†è§£æ•´ä½“çš„æ¦‚å¿µå’Œè®¾è®¡ï¼Œç»†èŠ‚ä¸ç”¨ç†è§£å¤ªæ·±ã€‚å¯ä»¥è¯»ç†è§£å‡ éï¼Œè‚¯å®šä¼šæœ‰æ”¶è·çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571845930,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332421,"user_name":"è¥¿é—¨å¹ç‰›","can_delete":false,"product_type":"c1","uid":1508990,"ip_address":"","ucode":"E5D3624DDE1E83","user_header":"https://static001.geekbang.org/account/avatar/00/17/06/7e/735968e2.jpg","comment_is_top":false,"comment_ctime":1643244162,"is_pvip":false,"replies":[{"id":"122021","content":"è¿™æ ·å†…æ ¸ç©ºé—´çš„æ•°æ®ä¸å°±å¾ˆä¸å®‰å…¨äº†ï¼Ÿå¾ˆå®¹æ˜“é™·å…¥crashçŠ¶æ€ã€‚","user_name":"ä½œè€…å›å¤","comment_id":332421,"uid":"1618647","ip_address":"","utype":1,"ctime":1644729676,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1643244162","product_id":100032701,"comment_content":"å½“å†…æ ¸ç›‘æµ‹åˆ°æœ‰å°±ç»ªäº‹ä»¶åï¼Œå°†å¯¹åº”çš„fd åŠ å…¥å°±ç»ª é˜Ÿåˆ—ï¼Œè¿™é‡Œå…¶å®è¿˜ä¼šæ¶‰åŠåˆ°å°†æœ‰äº‹ä»¶çš„fdæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¯ä¸å¯ä»¥è®©ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´é‡‡ç”¨å…±äº«å†…å­˜çš„æ–¹å¼ï¼Œé¿å…æ‹·è´å‘¢","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550771,"discussion_content":"è¿™æ ·å†…æ ¸ç©ºé—´çš„æ•°æ®ä¸å°±å¾ˆä¸å®‰å…¨äº†ï¼Ÿå¾ˆå®¹æ˜“é™·å…¥crashçŠ¶æ€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644729676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":169780,"user_name":"Geek_68d3d2","can_delete":false,"product_type":"c1","uid":1674369,"ip_address":"","ucode":"EBD6D881AA7A74","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqf54z1ZmqQY1kmJ6t1HAnrqMM3j6WKf0oDeVLhtnA2ZUKY6AX9MK6RjvcO8SiczXy3uU0IzBQ3tpw/132","comment_is_top":false,"comment_ctime":1578445616,"is_pvip":false,"replies":[{"id":"68075","content":"å¯¹åº”çš„æ–‡ä»¶æè¿°å­—ä¸Šæœ‰pollçš„åŠ¨ä½œï¼Œæ­£åœ¨ç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚","user_name":"ä½œè€…å›å¤","comment_id":169780,"uid":"1618647","ip_address":"","utype":1,"ctime":1580631317,"user_name_real":"froghui"}],"discussion_count":3,"race_medal":0,"score":"1578445616","product_id":100032701,"comment_content":" epi&gt;nwait &gt;= 0è¯·é—®è¿™è¡Œä»£ç ä»€ä¹ˆæ„æ€","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":480718,"discussion_content":"å¯¹åº”çš„æ–‡ä»¶æè¿°å­—ä¸Šæœ‰pollçš„åŠ¨ä½œï¼Œæ­£åœ¨ç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580631317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1197007,"avatar":"https://static001.geekbang.org/account/avatar/00/12/43/cf/118c4ef5.jpg","nickname":"lunar","note":"","ucode":"4FC1E388AD98C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":209835,"discussion_content":"æ„Ÿè§‰å°‘äº†ä¸ª - ï¼Œepi->nwait å§ï¼ŸğŸŒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584679667,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1009527,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/77/c1310aad.jpg","nickname":"å‰‘è¡£æ¸…é£","note":"","ucode":"470CD81F6612F4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1197007,"avatar":"https://static001.geekbang.org/account/avatar/00/12/43/cf/118c4ef5.jpg","nickname":"lunar","note":"","ucode":"4FC1E388AD98C6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":332688,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607311535,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":209835,"ip_address":""},"score":332688,"extra":""}]}]},{"had_liked":false,"id":148482,"user_name":"haozhang","can_delete":false,"product_type":"c1","uid":1505549,"ip_address":"","ucode":"B4FC40EBFFB10E","user_header":"","comment_is_top":false,"comment_ctime":1573016964,"is_pvip":false,"replies":[{"id":"57485","content":"è¿›ç¨‹é˜»å¡å…¶å®å°±æ˜¯æŠŠCPUæ—¶é—´è°ƒåº¦ç»™äº†å…¶ä»–çš„è¿›ç¨‹ï¼Œå› ä¸ºå¾—ä¸åˆ°CPUæ—¶é—´ï¼Œæ‰€ä»¥å½“å‰è¿›ç¨‹çš„ä»£ç æ²¡æœ‰åŠæ³•å†æ‰§è¡Œä¸‹å»ï¼Œè¡¨ç°çš„è¡Œä¸ºå°±æ˜¯å½“å‰ç¨‹åºæ‰§è¡Œ&quot;ä¼‘çœ &quot;åœ¨é‚£é‡Œäº†ã€‚<br><br>è¿™é‡Œçš„ç­‰å¾…é˜Ÿåˆ—æ˜¯LInuxå†…æ ¸æŠŠç­‰å¾…è°ƒåº¦çš„è¿›è¡ŒæŒ‰ç…§è‡ªå·±å†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œå½¢æˆäº†ä¸€ä¸ªé˜Ÿåˆ—ã€‚æŒ‰ç…§LInuxå†…æ ¸ä»»åŠ¡è°ƒåº¦ç®—æ³•è¿›è¡Œè°ƒåº¦ï¼Œæ¥å”¤é†’å¯¹åº”çš„&quot;ä¼‘çœ &quot;è¿›ç¨‹ã€‚","user_name":"ä½œè€…å›å¤","comment_id":148482,"uid":"1618647","ip_address":"","utype":1,"ctime":1573282775,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"1573016964","product_id":100032701,"comment_content":"è€å¸ˆ   è¿›ç¨‹é˜»å¡çš„å½¢å¼æ˜¯ä»€ä¹ˆå‘¢   æ˜¯foræ­»å¾ªç¯å—     è¿˜æ˜¯åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—å‘¢ï¼Œæˆ‘çœ‹forå¾ªç¯å‰é¢ä¸æ˜¯åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—äº†å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473506,"discussion_content":"è¿›ç¨‹é˜»å¡å…¶å®å°±æ˜¯æŠŠCPUæ—¶é—´è°ƒåº¦ç»™äº†å…¶ä»–çš„è¿›ç¨‹ï¼Œå› ä¸ºå¾—ä¸åˆ°CPUæ—¶é—´ï¼Œæ‰€ä»¥å½“å‰è¿›ç¨‹çš„ä»£ç æ²¡æœ‰åŠæ³•å†æ‰§è¡Œä¸‹å»ï¼Œè¡¨ç°çš„è¡Œä¸ºå°±æ˜¯å½“å‰ç¨‹åºæ‰§è¡Œ&amp;quot;ä¼‘çœ &amp;quot;åœ¨é‚£é‡Œäº†ã€‚\n\nè¿™é‡Œçš„ç­‰å¾…é˜Ÿåˆ—æ˜¯LInuxå†…æ ¸æŠŠç­‰å¾…è°ƒåº¦çš„è¿›è¡ŒæŒ‰ç…§è‡ªå·±å†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œå½¢æˆäº†ä¸€ä¸ªé˜Ÿåˆ—ã€‚æŒ‰ç…§LInuxå†…æ ¸ä»»åŠ¡è°ƒåº¦ç®—æ³•è¿›è¡Œè°ƒåº¦ï¼Œæ¥å”¤é†’å¯¹åº”çš„&amp;quot;ä¼‘çœ &amp;quot;è¿›ç¨‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573282775,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144477,"user_name":"åˆè§","can_delete":false,"product_type":"c1","uid":1101405,"ip_address":"","ucode":"06D7952CED37D3","user_header":"https://static001.geekbang.org/account/avatar/00/10/ce/5d/5297717a.jpg","comment_is_top":false,"comment_ctime":1571933413,"is_pvip":false,"replies":[{"id":"55811","content":"ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„è¯´æ³•ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªè¯´æ³•ä¸æ­£ç¡®ï¼Œepollé€‚åˆæ´»è·ƒè¿æ¥å¾ˆå¤šçš„åœºæ™¯ã€‚","user_name":"ä½œè€…å›å¤","comment_id":144477,"uid":"1618647","ip_address":"","utype":1,"ctime":1572057571,"user_name_real":"froghui"}],"discussion_count":5,"race_medal":0,"score":"1571933413","product_id":100032701,"comment_content":"è€å¸ˆï¼Œæˆ‘ä¹‹å‰é¢è¯•è¢«é—®åˆ°è¿‡è¯´ï¼Œepoll æ›´é€‚åˆè¿æ¥å¾ˆå¤šï¼Œä½†æ´»è·ƒçš„è¿æ¥è¾ƒå°‘çš„æƒ…å†µ<br><br>é‚£ä¹ˆï¼Œè¿æ¥å¾ˆå¤šï¼Œæ´»è·ƒè¿æ¥ä¹Ÿå¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œç”¨ä»€ä¹ˆæ–¹æ¡ˆå‘¢ï¼Ÿ  å †æœºå™¨å˜›","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471963,"discussion_content":"ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„è¯´æ³•ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªè¯´æ³•ä¸æ­£ç¡®ï¼Œepollé€‚åˆæ´»è·ƒè¿æ¥å¾ˆå¤šçš„åœºæ™¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572057571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135631,"avatar":"https://static001.geekbang.org/account/avatar/00/11/54/0f/48ef6a7d.jpg","nickname":"è·¯äºº","note":"","ucode":"02FC717E0A4FB1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":178304,"discussion_content":"æ˜¯çš„ï¼Œå½“è¿æ¥æ•°å¾ˆå¤šï¼Œä¸”æ´»è·ƒçš„ä¹Ÿå¾ˆå¤šã€‚é‚£ä¹ˆepollå’Œpollä»€ä¹ˆçš„å·®ä¸å¤š","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1582153495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2123892,"avatar":"https://static001.geekbang.org/account/avatar/00/20/68/74/aea478ba.jpg","nickname":"æˆ‘æ˜¯ç®¡å°äº®","note":"","ucode":"A1C624CF9E1CA3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299584,"discussion_content":"ä¸»è¦æ˜¯epollæ˜¯ç»´æŠ¤åœ¨å†…æ ¸æ€çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œæ‰€ä»¥ç³»ç»Ÿè°ƒç”¨æ˜¯æ€§èƒ½ç“¶é¢ˆå§","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597741065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1135631,"avatar":"https://static001.geekbang.org/account/avatar/00/11/54/0f/48ef6a7d.jpg","nickname":"è·¯äºº","note":"","ucode":"02FC717E0A4FB1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":172060,"discussion_content":"æˆ‘ä¸ªäººç†è§£ ä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆè¯´å‘¢ï¼Ÿ æ´»è·ƒçš„é“¾æ¥epoll ç›´æ¥è¿”å›ç»™ä½ äº†ç›´æ¥ç¡®å®šäº†ï¼Œä¸åƒselect/polléœ€è¦æˆ‘ä»¬è‡ªå·±å†å»éå†æ‰€æœ‰çš„fdé›†åˆ,çœ‹çœ‹æ˜¯å¦æœ‰äº‹ä»¶ï¼ˆå³æ˜¯å¦æ´»è·ƒï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581767784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1101405,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ce/5d/5297717a.jpg","nickname":"åˆè§","note":"","ucode":"06D7952CED37D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1135631,"avatar":"https://static001.geekbang.org/account/avatar/00/11/54/0f/48ef6a7d.jpg","nickname":"è·¯äºº","note":"","ucode":"02FC717E0A4FB1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":172301,"discussion_content":"ä¸»è¦æ˜¯epollå†…éƒ¨çš„å®ç°ï¼Œepollæ€ä¹ˆçŸ¥é“ä¸€ä¸ªé“¾æ¥æœ‰æ•°æ®åˆ°æ¥å‘¢ï¼Ÿ æ˜¯å› ä¸ºæœ‰ä¸€ä¸ªå›è°ƒæœºåˆ¶ï¼Œå½“æ´»è·ƒé“¾æ¥å¾ˆå¤šæ—¶ï¼Œå†…éƒ¨å°±ä¼šæœ‰å¾ˆå¤šçš„å›è°ƒï¼Œå¯¼è‡´äº†æ€§èƒ½ä¸‹é™\n\næ‰€ä»¥å½“é“¾æ¥å°‘ï¼Œä½†æ¯ä¸ªé“¾æ¥éƒ½å¾ˆæ´»è·ƒï¼Œepollæœ‰å¯èƒ½æ¯”ä¸è¿‡select ä¸ poll\n\næ²¡æµ‹è¯•è¿‡ï¼Œç½‘ä¸Šçœ‹çš„ç»“è®º~","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1581775561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":172060,"ip_address":""},"score":172301,"extra":""}]}]},{"had_liked":false,"id":142872,"user_name":"å½±å¸","can_delete":false,"product_type":"c1","uid":1038153,"ip_address":"","ucode":"04915E658E4131","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d7/49/c2426b51.jpg","comment_is_top":false,"comment_ctime":1571571473,"is_pvip":false,"replies":[{"id":"55596","content":"è¿™å°±æ˜¯socialçš„åŠ›é‡ :)","user_name":"ä½œè€…å›å¤","comment_id":142872,"uid":"1618647","ip_address":"","utype":1,"ctime":1571845946,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"1571571473","product_id":100032701,"comment_content":"æˆ‘å‘ç°çœ‹ç•™è¨€å­¦åˆ°çš„æ›´å¤šã€‚ğŸ¤“","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471303,"discussion_content":"è¿™å°±æ˜¯socialçš„åŠ›é‡ :)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571845946,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":142379,"user_name":"TM","can_delete":false,"product_type":"c1","uid":1691214,"ip_address":"","ucode":"9E03B9D177356A","user_header":"https://static001.geekbang.org/account/avatar/00/19/ce/4e/17fd7195.jpg","comment_is_top":false,"comment_ctime":1571361293,"is_pvip":false,"replies":[{"id":"55124","content":"ä½ å¥½åƒé—®è¿‡ä¸€æ¬¡äº†å§ï¼Œè¿™ä¸ªæˆ‘è®¤ä¸ºä¸æ˜¯å†…æ ¸æŠ¥å‡ºæ¥çš„ï¼Œæˆ‘å»ºè®®ä½ debugä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","comment_id":142379,"uid":"1618647","ip_address":"","utype":1,"ctime":1571457600,"user_name_real":"froghui"}],"discussion_count":1,"race_medal":0,"score":"1571361293","product_id":100032701,"comment_content":"hi è€å¸ˆæ‚¨å¥½ï¼Œæœ‰ä¸ªé—®é¢˜æƒ³å’¨è¯¢ä¸‹ã€‚æŠŠ redis çš„ backlog è®¾ç½®ä¸º 1ï¼Œç„¶ååœ¨ redis é‡Œ debug sleep 50ï¼Œç„¶åå‘èµ·ä¸¤ä¸ªè¯·æ±‚ï¼Œä¸€ä¸ªæˆåŠŸè¿æ¥ï¼Œå¦ä¸€ä¸ªä¼šå‡º ã€opration timeoutã€ ï¼Œè€Œä¸æ˜¯ connect timeoutï¼Œç„¶åå¤§æ¦‚æ˜¯ 26 s ï¼Œåå¤è¯•äº†å‡ æ¬¡ã€éƒ½æ˜¯26så·¦å³çš„æ—¶é—´ã€‚å¾ˆå¥‡æ€ªè¿™ä¸ªæŠ¥é”™æ˜¯å†…æ ¸çˆ†å‡ºæ¥çš„å—ï¼Ÿä¸ºä»€ä¹ˆæ˜¯26sè¿™ä¸ªæ—¶é—´å‘¢ï¼Ÿæ‰©å±•æ˜¯ phpredisï¼Œphp åº•å±‚ socket è¶…æ—¶æ˜¯ 60sã€‚","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471095,"discussion_content":"ä½ å¥½åƒé—®è¿‡ä¸€æ¬¡äº†å§ï¼Œè¿™ä¸ªæˆ‘è®¤ä¸ºä¸æ˜¯å†…æ ¸æŠ¥å‡ºæ¥çš„ï¼Œæˆ‘å»ºè®®ä½ debugä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571457600,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}