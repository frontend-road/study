{"id":10076,"title":"ç¬¬24è®² | æœ‰å“ªäº›æ–¹æ³•å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä¸€ä¸ªJavaç±»ï¼Ÿ","content":"<p>åœ¨å¼€å§‹ä»Šå¤©çš„å­¦ä¹ å‰ï¼Œæˆ‘å»ºè®®ä½ å…ˆå¤ä¹ ä¸€ä¸‹<a href=\"http://time.geekbang.org/column/article/7489\">ä¸“æ ç¬¬6è®²</a>æœ‰å…³åŠ¨æ€ä»£ç†çš„å†…å®¹ã€‚ä½œä¸ºJavaåŸºç¡€æ¨¡å—ä¸­çš„å†…å®¹ï¼Œè€ƒè™‘åˆ°ä¸åŒåŸºç¡€çš„åŒå­¦ä»¥åŠä¸€ä¸ªå¾ªåºæ¸è¿›çš„å­¦ä¹ è¿‡ç¨‹ï¼Œæˆ‘å½“æ—¶å¹¶æ²¡æœ‰åœ¨æºç å±‚é¢ä»‹ç»åŠ¨æ€ä»£ç†çš„å®ç°æŠ€æœ¯ï¼Œä»…è¿›è¡Œäº†ç›¸åº”çš„æŠ€æœ¯æ¯”è¾ƒã€‚ä½†æ˜¯ï¼Œæœ‰äº†<a href=\"http://time.geekbang.org/column/article/9946\">ä¸Šä¸€è®²</a>çš„ç±»åŠ è½½çš„å­¦ä¹ åŸºç¡€åï¼Œæˆ‘æƒ³æ˜¯æ—¶å€™è¯¥è¿›è¡Œæ·±å…¥åˆ†æäº†ã€‚</p>\n<p>ä»Šå¤©æˆ‘è¦é—®ä½ çš„é—®é¢˜æ˜¯ï¼Œ<span class=\"orange\">æœ‰å“ªäº›æ–¹æ³•å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä¸€ä¸ªJavaç±»ï¼Ÿ</span></p>\n<h2>å…¸å‹å›ç­”</h2>\n<p>æˆ‘ä»¬å¯ä»¥ä»å¸¸è§çš„Javaç±»æ¥æºåˆ†æï¼Œé€šå¸¸çš„å¼€å‘è¿‡ç¨‹æ˜¯ï¼Œå¼€å‘è€…ç¼–å†™Javaä»£ç ï¼Œè°ƒç”¨javacç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œç„¶åé€šè¿‡ç±»åŠ è½½æœºåˆ¶è½½å…¥JVMï¼Œå°±æˆä¸ºåº”ç”¨è¿è¡Œæ—¶å¯ä»¥ä½¿ç”¨çš„Javaç±»äº†ã€‚</p>\n<p>ä»ä¸Šé¢è¿‡ç¨‹å¾—åˆ°å¯å‘ï¼Œå…¶ä¸­ä¸€ä¸ªç›´æ¥çš„æ–¹å¼æ˜¯ä»æºç å…¥æ‰‹ï¼Œå¯ä»¥åˆ©ç”¨Javaç¨‹åºç”Ÿæˆä¸€æ®µæºç ï¼Œç„¶åä¿å­˜åˆ°æ–‡ä»¶ç­‰ï¼Œä¸‹é¢å°±åªéœ€è¦è§£å†³ç¼–è¯‘é—®é¢˜äº†ã€‚</p>\n<p>æœ‰ä¸€ç§ç¬¨åŠæ³•ï¼Œç›´æ¥ç”¨ProcessBuilderä¹‹ç±»å¯åŠ¨javacè¿›ç¨‹ï¼Œå¹¶æŒ‡å®šä¸Šé¢ç”Ÿæˆçš„æ–‡ä»¶ä½œä¸ºè¾“å…¥ï¼Œè¿›è¡Œç¼–è¯‘ã€‚æœ€åï¼Œå†åˆ©ç”¨ç±»åŠ è½½å™¨ï¼Œåœ¨è¿è¡Œæ—¶åŠ è½½å³å¯ã€‚</p>\n<p>å‰é¢çš„æ–¹æ³•ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯åœ¨å½“å‰ç¨‹åºè¿›ç¨‹ä¹‹å¤–ç¼–è¯‘çš„ï¼Œé‚£ä¹ˆè¿˜æœ‰æ²¡æœ‰ä¸è¿™ä¹ˆlowçš„åŠæ³•å‘¢ï¼Ÿ</p>\n<p>ä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨Java Compiler APIï¼Œè¿™æ˜¯JDKæä¾›çš„æ ‡å‡†APIï¼Œé‡Œé¢æä¾›äº†ä¸javacå¯¹ç­‰çš„ç¼–è¯‘å™¨åŠŸèƒ½ï¼Œå…·ä½“è¯·å‚è€ƒ<a href=\"https://docs.oracle.com/javase/9/docs/api/javax/tools/package-summary.html\">java.compiler</a>ç›¸å…³æ–‡æ¡£ã€‚</p><!-- [[[read_end]]] -->\n<p>è¿›ä¸€æ­¥æ€è€ƒï¼Œæˆ‘ä»¬ä¸€ç›´å›´ç»•Javaæºç ç¼–è¯‘æˆä¸ºJVMå¯ä»¥ç†è§£çš„å­—èŠ‚ç ï¼Œæ¢å¥è¯è¯´ï¼Œåªè¦æ˜¯ç¬¦åˆJVMè§„èŒƒçš„å­—èŠ‚ç ï¼Œä¸ç®¡å®ƒæ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œæ˜¯ä¸æ˜¯éƒ½å¯ä»¥è¢«JVMåŠ è½½å‘¢ï¼Ÿæˆ‘ä»¬èƒ½ä¸èƒ½ç›´æ¥ç”Ÿæˆç›¸åº”çš„å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ç±»åŠ è½½å™¨å»åŠ è½½å‘¢ï¼Ÿ</p>\n<p>å½“ç„¶ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡ç›´æ¥å»å†™å­—èŠ‚ç éš¾åº¦å¤ªå¤§ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Javaå­—èŠ‚ç æ“çºµå·¥å…·å’Œç±»åº“æ¥å®ç°ï¼Œæ¯”å¦‚åœ¨<a href=\"http://time.geekbang.org/column/article/7489\">ä¸“æ ç¬¬6è®²</a>ä¸­æåˆ°çš„<a href=\"https://asm.ow2.io/\">ASM</a>ã€<a href=\"http://www.javassist.org/\">Javassist</a>ã€cglibç­‰ã€‚</p>\n<h2>è€ƒç‚¹åˆ†æ</h2>\n<p>è™½ç„¶æ›¾ç»è¢«è§†ä¸ºé»‘é­”æ³•ï¼Œä½†åœ¨å½“å‰å¤æ‚å¤šå˜çš„å¼€å‘ç¯å¢ƒä¸­ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆé€»è¾‘å¹¶ä¸æ˜¯ä»€ä¹ˆç½•è§çš„åœºæ™¯ã€‚é‡æ–°å®¡è§†æˆ‘ä»¬è°ˆåˆ°çš„åŠ¨æ€ä»£ç†ï¼Œæœ¬è´¨ä¸Šä¸å°±æ˜¯åœ¨ç‰¹å®šçš„æ—¶æœºï¼Œå»ä¿®æ”¹å·²æœ‰ç±»å‹å®ç°ï¼Œæˆ–è€…åˆ›å»ºæ–°çš„ç±»å‹ã€‚</p>\n<p>æ˜ç™½äº†åŸºæœ¬æ€è·¯åï¼Œæˆ‘è¿˜æ˜¯å›´ç»•ç±»åŠ è½½æœºåˆ¶è¿›è¡Œå±•å¼€ï¼Œé¢è¯•è¿‡ç¨‹ä¸­é¢è¯•å®˜å¾ˆå¯èƒ½ä»æŠ€æœ¯åŸç†æˆ–å®è·µçš„è§’åº¦è€ƒå¯Ÿï¼š</p>\n<ul>\n<li>\n<p>å­—èŠ‚ç å’Œç±»åŠ è½½åˆ°åº•æ˜¯æ€ä¹ˆæ— ç¼è¿›è¡Œè½¬æ¢çš„ï¼Ÿå‘ç”Ÿåœ¨æ•´ä¸ªç±»åŠ è½½è¿‡ç¨‹çš„å“ªä¸€æ­¥ï¼Ÿ</p>\n</li>\n<li>\n<p>å¦‚ä½•åˆ©ç”¨å­—èŠ‚ç æ“çºµæŠ€æœ¯ï¼Œå®ç°åŸºæœ¬çš„åŠ¨æ€ä»£ç†é€»è¾‘ï¼Ÿ</p>\n</li>\n<li>\n<p>é™¤äº†åŠ¨æ€ä»£ç†ï¼Œå­—èŠ‚ç æ“çºµæŠ€æœ¯è¿˜æœ‰é‚£äº›åº”ç”¨åœºæ™¯ï¼Ÿ</p>\n</li>\n</ul>\n<h2>çŸ¥è¯†æ‰©å±•</h2>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥ç†è§£ä¸€ä¸‹ï¼Œç±»ä»å­—èŠ‚ç åˆ°Classå¯¹è±¡çš„è½¬æ¢ï¼Œåœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸€æ­¥æ˜¯é€šè¿‡ä¸‹é¢çš„æ–¹æ³•æä¾›çš„åŠŸèƒ½ï¼Œæˆ–è€…defineClassçš„å…¶ä»–æœ¬åœ°å¯¹ç­‰å®ç°ã€‚</p>\n<pre><code>protected final Class&lt;?&gt; defineClass(String name, byte[] b, int off, int len,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tProtectionDomain protectionDomain)\nprotected final Class&lt;?&gt; defineClass(String name, java.nio.ByteBuffer b,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tProtectionDomain protectionDomain)\n</code></pre>\n<p>æˆ‘è¿™é‡Œåªé€‰å–äº†æœ€åŸºç¡€çš„ä¸¤ä¸ªå…¸å‹çš„defineClasså®ç°ï¼ŒJavaé‡è½½äº†å‡ ä¸ªä¸åŒçš„æ–¹æ³•ã€‚</p>\n<p>å¯ä»¥çœ‹å‡ºï¼Œåªè¦èƒ½å¤Ÿç”Ÿæˆå‡ºè§„èŒƒçš„å­—èŠ‚ç ï¼Œä¸ç®¡æ˜¯ä½œä¸ºbyteæ•°ç»„çš„å½¢å¼ï¼Œè¿˜æ˜¯æ”¾åˆ°ByteBufferé‡Œï¼Œéƒ½å¯ä»¥å¹³æ»‘åœ°å®Œæˆå­—èŠ‚ç åˆ°Javaå¯¹è±¡çš„è½¬æ¢è¿‡ç¨‹ã€‚</p>\n<p>JDKæä¾›çš„defineClassæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½æ˜¯æœ¬åœ°ä»£ç å®ç°çš„ã€‚</p>\n<pre><code>static native Class&lt;?&gt; defineClass1(ClassLoader loader, String name, byte[] b, int off, int len,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tProtectionDomain pd, String source);\n\nstatic native Class&lt;?&gt; defineClass2(ClassLoader loader, String name, java.nio.ByteBuffer b,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tint off, int len, ProtectionDomain pd,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tString source);\n</code></pre>\n<p>æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹JDK dynamic proxyçš„<a href=\"http://hg.openjdk.java.net/jdk/jdk/file/29169633327c/src/java.base/share/classes/java/lang/reflect/Proxy.java\">å®ç°ä»£ç </a>ã€‚ä½ ä¼šå‘ç°ï¼Œå¯¹åº”é€»è¾‘æ˜¯å®ç°åœ¨ProxyBuilderè¿™ä¸ªé™æ€å†…éƒ¨ç±»ä¸­ï¼ŒProxyGeneratorç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶ä»¥byteæ•°ç»„çš„å½¢å¼ä¿å­˜ï¼Œç„¶åé€šè¿‡è°ƒç”¨Unsafeæä¾›çš„defineClasså…¥å£ã€‚</p>\n<pre><code>byte[] proxyClassFile = ProxyGenerator.generateProxyClass(\n Â Â Â \tproxyName, interfaces.toArray(EMPTY_CLASS_ARRAY), accessFlags);\ntry {\n\tClass&lt;?&gt; pc = UNSAFE.defineClass(proxyName, proxyClassFile,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \t0, proxyClassFile.length,\n Â Â Â Â Â \t Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â loader, null);\n\treverseProxyCache.sub(pc).putIfAbsent(loader, Boolean.TRUE);\n\treturn pc;\n} catch (ClassFormatError e) {\n// å¦‚æœå‡ºç°ClassFormatErrorï¼Œå¾ˆå¯èƒ½æ˜¯è¾“å…¥å‚æ•°æœ‰é—®é¢˜ï¼Œæ¯”å¦‚ï¼ŒProxyGeneratoræœ‰bug\n}\n</code></pre>\n<p>å‰é¢ç†é¡ºäº†äºŒè¿›åˆ¶çš„å­—èŠ‚ç ä¿¡æ¯åˆ°Classå¯¹è±¡çš„è½¬æ¢è¿‡ç¨‹ï¼Œä¼¼ä¹æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ†æå¦‚ä½•ç”Ÿæˆè‡ªå·±éœ€è¦çš„å­—èŠ‚ç ï¼Œæ¥ä¸‹æ¥ä¸€èµ·æ¥çœ‹çœ‹ç›¸å…³çš„å­—èŠ‚ç æ“çºµé€»è¾‘ã€‚</p>\n<p>JDKå†…éƒ¨åŠ¨æ€ä»£ç†çš„é€»è¾‘ï¼Œå¯ä»¥å‚è€ƒ<a href=\"http://hg.openjdk.java.net/jdk/jdk/file/29169633327c/src/java.base/share/classes/java/lang/reflect/ProxyGenerator.java\">java.lang.reflect.ProxyGenerator</a>çš„å†…éƒ¨å®ç°ã€‚æˆ‘è§‰å¾—å¯ä»¥è®¤ä¸ºè¿™æ˜¯ç§å¦ç±»çš„å­—èŠ‚ç æ“çºµæŠ€æœ¯ï¼Œå…¶åˆ©ç”¨äº†<a href=\"https://docs.oracle.com/javase/9/docs/api/java/io/DataOutputStream.html\">DataOutputStrem</a>æä¾›çš„èƒ½åŠ›ï¼Œé…åˆhard-codedçš„å„ç§JVMæŒ‡ä»¤å®ç°æ–¹æ³•ï¼Œç”Ÿæˆæ‰€éœ€çš„å­—èŠ‚ç æ•°ç»„ã€‚ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ã€‚</p>\n<pre><code>private void codeLocalLoadStore(int lvar, int opcode, int opcode_0,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tDataOutputStream out)\n\tthrows IOException\n{\n\tassert lvar &gt;= 0 &amp;&amp; lvar &lt;= 0xFFFF;\n\t// æ ¹æ®å˜é‡æ•°å€¼ï¼Œä»¥ä¸åŒæ ¼å¼ï¼Œdumpæ“ä½œç \n Â Â Â if (lvar &lt;= 3) {\n Â Â Â \tout.writeByte(opcode_0 + lvar);\n\t} else if (lvar &lt;= 0xFF) {\n Â Â Â \tout.writeByte(opcode);\n Â Â Â \tout.writeByte(lvar &amp; 0xFF);\n\t} else {\n Â Â Â \t// ä½¿ç”¨å®½æŒ‡ä»¤ä¿®é¥°ç¬¦ï¼Œå¦‚æœå˜é‡ç´¢å¼•ä¸èƒ½ç”¨æ— ç¬¦å·byte\n Â Â Â \tout.writeByte(opc_wide);\n Â Â Â \tout.writeByte(opcode);\n Â Â Â \tout.writeShort(lvar &amp; 0xFFFF);\n\t}\n}\n</code></pre>\n<p>è¿™ç§å®ç°æ–¹å¼çš„å¥½å¤„æ˜¯æ²¡æœ‰å¤ªå¤šä¾èµ–å…³ç³»ï¼Œç®€å•å®ç”¨ï¼Œä½†æ˜¯å‰ææ˜¯ä½ éœ€è¦æ‡‚å„ç§<a href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5\">JVMæŒ‡ä»¤</a>ï¼ŒçŸ¥é“æ€ä¹ˆå¤„ç†é‚£äº›åç§»åœ°å€ç­‰ï¼Œå®é™…é—¨æ§›éå¸¸é«˜ï¼Œæ‰€ä»¥å¹¶ä¸é€‚åˆå¤§å¤šæ•°çš„æ™®é€šå¼€å‘åœºæ™¯ã€‚</p>\n<p>å¹¸å¥½ï¼ŒJavaç¤¾åŒºä¸“å®¶æä¾›äº†å„ç§ä»åº•å±‚åˆ°æ›´é«˜æŠ½è±¡æ°´å¹³çš„å­—èŠ‚ç æ“ä½œç±»åº“ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»€ä¹ˆéƒ½è‡ªå·±ä»å¤´åšã€‚JDKå†…éƒ¨å°±é›†æˆäº†ASMç±»åº“ï¼Œè™½ç„¶å¹¶æœªä½œä¸ºå…¬å…±APIæš´éœ²å‡ºæ¥ï¼Œä½†æ˜¯å®ƒå¹¿æ³›åº”ç”¨åœ¨ï¼Œå¦‚<a href=\"https://docs.oracle.com/javase/9/docs/api/java/lang/instrument/package-summary.html\">java.lang.instrumentation</a> APIåº•å±‚å®ç°ï¼Œæˆ–è€…<a href=\"https://docs.oracle.com/javase/9/docs/api/java/lang/invoke/CallSite.html\">Lambda Call Site</a>ç”Ÿæˆçš„å†…éƒ¨é€»è¾‘ä¸­ï¼Œè¿™äº›ä»£ç çš„å®ç°æˆ‘å°±ä¸åœ¨è¿™é‡Œå±•å¼€äº†ï¼Œå¦‚æœä½ ç¡®å®æœ‰å…´è¶£æˆ–æœ‰éœ€è¦ï¼Œå¯ä»¥å‚è€ƒç±»ä¼¼LamdaFormçš„å­—èŠ‚ç ç”Ÿæˆé€»è¾‘ï¼š<a href=\"http://hg.openjdk.java.net/jdk/jdk/file/29169633327c/src/java.base/share/classes/java/lang/invoke/InvokerBytecodeGenerator.java\">java.lang.invoke.InvokerBytecodeGenerator</a><a href=\"http://hg.openjdk.java.net/jdk/jdk/file/29169633327c/src/java.base/share/classes/java/lang/invoke/InvokerBytecodeGenerator.java\">ã€‚</a></p>\n<p>ä»ç›¸å¯¹å®ç”¨çš„è§’åº¦æ€è€ƒä¸€ä¸‹ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„åŠ¨æ€ä»£ç†ï¼Œéƒ½è¦åšä»€ä¹ˆï¼Ÿå¦‚ä½•ä½¿ç”¨å­—èŠ‚ç æ“çºµæŠ€æœ¯ï¼Œèµ°é€šè¿™ä¸ªè¿‡ç¨‹å‘¢ï¼Ÿ</p>\n<p>å¯¹äºä¸€ä¸ªæ™®é€šçš„JavaåŠ¨æ€ä»£ç†ï¼Œå…¶å®ç°è¿‡ç¨‹å¯ä»¥ç®€åŒ–æˆä¸ºï¼š</p>\n<ul>\n<li>\n<p>æä¾›ä¸€ä¸ªåŸºç¡€çš„æ¥å£ï¼Œä½œä¸ºè¢«è°ƒç”¨ç±»å‹ï¼ˆcom.mycorp.HelloImplï¼‰å’Œä»£ç†ç±»ä¹‹é—´çš„ç»Ÿä¸€å…¥å£ï¼Œå¦‚com.mycorp.Helloã€‚</p>\n</li>\n<li>\n<p>å®ç°<a href=\"https://docs.oracle.com/javase/9/docs/api/java/lang/reflect/InvocationHandler.html\">InvocationHandler</a>ï¼Œå¯¹ä»£ç†å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨ï¼Œä¼šè¢«åˆ†æ´¾åˆ°å…¶invokeæ–¹æ³•æ¥çœŸæ­£å®ç°åŠ¨ä½œã€‚</p>\n</li>\n<li>\n<p>é€šè¿‡Proxyç±»ï¼Œè°ƒç”¨å…¶newProxyInstanceæ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ªå®ç°äº†ç›¸åº”åŸºç¡€æ¥å£çš„ä»£ç†ç±»å®ä¾‹ï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„æ–¹æ³•ç­¾åã€‚</p>\n</li>\n</ul>\n<pre><code>public static Object newProxyInstance(ClassLoader loader,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tClass&lt;?&gt;[] interfaces,\n Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \tInvocationHandler h)\n</code></pre>\n<p>æˆ‘ä»¬åˆ†æä¸€ä¸‹ï¼ŒåŠ¨æ€ä»£ç ç”Ÿæˆæ˜¯å…·ä½“å‘ç”Ÿåœ¨ä»€ä¹ˆé˜¶æ®µå‘¢ï¼Ÿ</p>\n<p>ä¸é”™ï¼Œå°±æ˜¯åœ¨newProxyInstanceç”Ÿæˆä»£ç†ç±»å®ä¾‹çš„æ—¶å€™ã€‚æˆ‘é€‰å–äº†JDKè‡ªå·±é‡‡ç”¨çš„ASMä½œä¸ºç¤ºä¾‹ï¼Œä¸€èµ·æ¥çœ‹çœ‹ç”¨ASMå®ç°çš„ç®€è¦è¿‡ç¨‹ï¼Œè¯·å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ä»£ç ç‰‡æ®µã€‚</p>\n<p>ç¬¬ä¸€æ­¥ï¼Œç”Ÿæˆå¯¹åº”çš„ç±»ï¼Œå…¶å®å’Œæˆ‘ä»¬å»å†™Javaä»£ç å¾ˆç±»ä¼¼ï¼Œåªä¸è¿‡æ”¹ä¸ºç”¨ASMæ–¹æ³•å’ŒæŒ‡å®šå‚æ•°ï¼Œä»£æ›¿äº†æˆ‘ä»¬ä¹¦å†™çš„æºç ã€‚</p>\n<pre><code>ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);\n\ncw.visit(V1_8, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // æŒ‡å®šJavaç‰ˆæœ¬\n Â Â Â \tACC_PUBLIC, Â Â Â Â Â Â Â Â Â Â Â Â \t// è¯´æ˜æ˜¯publicç±»å‹\n Â Â Â Â Â Â Â &quot;com/mycorp/HelloProxy&quot;,\t// æŒ‡å®šåŒ…å’Œç±»çš„åç§°\n Â Â Â \tnull, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \t// ç­¾åï¼Œnullè¡¨ç¤ºä¸æ˜¯æ³›å‹\n Â Â Â \t&quot;java/lang/Object&quot;, Â Â Â Â Â Â Â Â Â Â Â Â \t// æŒ‡å®šçˆ¶ç±»\n Â Â Â \tnew String[]{ &quot;com/mycorp/Hello&quot; }); // æŒ‡å®šéœ€è¦å®ç°çš„æ¥å£\n</code></pre>\n<p>æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§éœ€è¦ä¸ºä»£ç†å¯¹è±¡å®ä¾‹ï¼Œç”Ÿæˆéœ€è¦çš„æ–¹æ³•å’Œé€»è¾‘ã€‚</p>\n<pre><code>MethodVisitor mv = cw.visitMethod(\n Â Â Â \tACC_PUBLIC, Â Â Â Â Â Â Â Â \t Â Â Â // å£°æ˜å…¬å…±æ–¹æ³•\n Â Â Â \t&quot;sayHello&quot;, Â Â Â Â Â Â Â Â Â Â Â Â \t// æ–¹æ³•åç§°\n Â Â Â \t&quot;()Ljava/lang/Object;&quot;, \t// æè¿°ç¬¦\n Â Â Â \tnull, Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â \t// ç­¾åï¼Œnullè¡¨ç¤ºä¸æ˜¯æ³›å‹\n Â Â Â \tnull); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æŒ‡å®šå­—ç¬¦ä¸²æ•°ç»„\n\nmv.visitCode();\n// çœç•¥ä»£ç é€»è¾‘å®ç°ç»†èŠ‚\ncw.visitEnd(); Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // ç»“æŸç±»å­—èŠ‚ç ç”Ÿæˆ\n</code></pre>\n<p>ä¸Šé¢çš„ä»£ç è™½ç„¶æœ‰äº›æ™¦æ¶©ï¼Œä½†æ€»ä½“è¿˜æ˜¯èƒ½å¤šå°‘ç†è§£å…¶ç”¨æ„ï¼Œä¸åŒçš„visitXæ–¹æ³•æä¾›äº†åˆ›å»ºç±»å‹ï¼Œåˆ›å»ºå„ç§æ–¹æ³•ç­‰é€»è¾‘ã€‚ASM APIï¼Œå¹¿æ³›çš„ä½¿ç”¨äº†<a href=\"https://en.wikipedia.org/wiki/Visitor_pattern\">Visitor</a>æ¨¡å¼ï¼Œå¦‚æœä½ ç†Ÿæ‚‰è¿™ä¸ªæ¨¡å¼ï¼Œå°±ä¼šçŸ¥é“å®ƒæ‰€é’ˆå¯¹çš„åœºæ™¯æ˜¯å°†ç®—æ³•å’Œå¯¹è±¡ç»“æ„è§£è€¦ï¼Œéå¸¸é€‚åˆå­—èŠ‚ç æ“çºµçš„åœºåˆï¼Œå› ä¸ºæˆ‘ä»¬å¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯ä¾èµ–äºç‰¹å®šç»“æ„ä¿®æ”¹æˆ–è€…æ·»åŠ æ–°çš„æ–¹æ³•ã€å˜é‡æˆ–è€…ç±»å‹ç­‰ã€‚</p>\n<p>æŒ‰ç…§å‰é¢çš„åˆ†æï¼Œå­—èŠ‚ç æ“ä½œæœ€åå¤§éƒ½åº”è¯¥æ˜¯ç”Ÿæˆbyteæ•°ç»„ï¼ŒClassWriteræä¾›äº†ä¸€ä¸ªç®€ä¾¿çš„æ–¹æ³•ã€‚</p>\n<pre><code>cw.toByteArray();\n</code></pre>\n<p>ç„¶åï¼Œå°±å¯ä»¥è¿›å…¥æˆ‘ä»¬ç†ŸçŸ¥çš„ç±»åŠ è½½è¿‡ç¨‹äº†ï¼Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ï¼Œå¦‚æœä½ å¯¹ASMçš„å…·ä½“ç”¨æ³•æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ª<a href=\"http://www.baeldung.com/java-asm\">æ•™ç¨‹</a>ã€‚</p>\n<p>æœ€åä¸€ä¸ªé—®é¢˜ï¼Œå­—èŠ‚ç æ“çºµæŠ€æœ¯ï¼Œé™¤äº†åŠ¨æ€ä»£ç†ï¼Œè¿˜å¯ä»¥åº”ç”¨åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</p>\n<p>è¿™ä¸ªæŠ€æœ¯ä¼¼ä¹ç¦»æˆ‘ä»¬æ—¥å¸¸å¼€å‘é¥è¿œï¼Œä½†å…¶å®å·²ç»æ·±å…¥åˆ°å„ä¸ªæ–¹é¢ï¼Œä¹Ÿè®¸å¾ˆå¤šä½ ç°åœ¨æ­£åœ¨ä½¿ç”¨çš„æ¡†æ¶ã€å·¥å…·å°±åº”ç”¨è¯¥æŠ€æœ¯ï¼Œä¸‹é¢æ˜¯æˆ‘èƒ½æƒ³åˆ°çš„å‡ ä¸ªå¸¸è§é¢†åŸŸã€‚</p>\n<ul>\n<li>\n<p>å„ç§Mockæ¡†æ¶</p>\n</li>\n<li>\n<p>ORMæ¡†æ¶</p>\n</li>\n<li>\n<p>IOCå®¹å™¨</p>\n</li>\n<li>\n<p>éƒ¨åˆ†Profilerå·¥å…·ï¼Œæˆ–è€…è¿è¡Œæ—¶è¯Šæ–­å·¥å…·ç­‰</p>\n</li>\n<li>\n<p>ç”Ÿæˆå½¢å¼åŒ–ä»£ç çš„å·¥å…·</p>\n</li>\n</ul>\n<p>ç”šè‡³å¯ä»¥è®¤ä¸ºï¼Œå­—èŠ‚ç æ“çºµæŠ€æœ¯æ˜¯å·¥å…·å’ŒåŸºç¡€æ¡†æ¶å¿…ä¸å¯å°‘çš„éƒ¨åˆ†ï¼Œå¤§å¤§å‡å°‘äº†å¼€å‘è€…çš„è´Ÿæ‹…ã€‚</p>\n<p>ä»Šå¤©æˆ‘ä»¬æ¢è®¨äº†æ›´åŠ æ·±å…¥çš„ç±»åŠ è½½å’Œå­—èŠ‚ç æ“ä½œæ–¹é¢æŠ€æœ¯ã€‚ä¸ºäº†ç†è§£åº•å±‚çš„åŸç†ï¼Œæˆ‘é€‰å–çš„ä¾‹å­æ˜¯æ¯”è¾ƒååº•å±‚çš„ã€èƒ½åŠ›å…¨é¢çš„ç±»åº“ï¼Œå¦‚æœå®é™…é¡¹ç›®ä¸­éœ€è¦è¿›è¡ŒåŸºç¡€çš„å­—èŠ‚ç æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´åŠ é«˜å±‚æ¬¡è§†è§’çš„ç±»åº“ï¼Œä¾‹å¦‚<a href=\"http://bytebuddy.net/#/\">Byte Buddy</a>ç­‰ã€‚</p>\n<h2>ä¸€è¯¾ä¸€ç»ƒ</h2>\n<p>å…³äºä»Šå¤©æˆ‘ä»¬è®¨è®ºçš„é¢˜ç›®ä½ åšåˆ°å¿ƒä¸­æœ‰æ•°äº†å—ï¼Ÿè¯•æƒ³ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œéœ€è¦æ·»åŠ æŸä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚å¯¹æŸç±»å‹èµ„æºå¦‚ç½‘ç»œé€šä¿¡çš„æ¶ˆè€—è¿›è¡Œç»Ÿè®¡ï¼Œé‡ç‚¹è¦æ±‚æ˜¯ï¼Œä¸å¼€å¯æ—¶å¿…é¡»æ˜¯<strong>é›¶å¼€é”€ï¼Œè€Œä¸æ˜¯ä½å¼€é”€ï¼Œ</strong>å¯ä»¥åˆ©ç”¨æˆ‘ä»¬ä»Šå¤©è°ˆåˆ°çš„æˆ–è€…ç›¸å…³çš„æŠ€æœ¯å®ç°å—ï¼Ÿ</p>\n<p>è¯·ä½ åœ¨ç•™è¨€åŒºå†™å†™ä½ å¯¹è¿™ä¸ªé—®é¢˜çš„æ€è€ƒï¼Œæˆ‘ä¼šé€‰å‡ºç»è¿‡è®¤çœŸæ€è€ƒçš„ç•™è¨€ï¼Œé€ç»™ä½ ä¸€ä»½å­¦ä¹ å¥–åŠ±ç¤¼åˆ¸ï¼Œæ¬¢è¿ä½ ä¸æˆ‘ä¸€èµ·è®¨è®ºã€‚</p>\n<p>ä½ çš„æœ‹å‹æ˜¯ä¸æ˜¯ä¹Ÿåœ¨å‡†å¤‡é¢è¯•å‘¢ï¼Ÿä½ å¯ä»¥â€œè¯·æœ‹å‹è¯»â€ï¼ŒæŠŠä»Šå¤©çš„é¢˜ç›®åˆ†äº«ç»™å¥½å‹ï¼Œæˆ–è®¸ä½ èƒ½å¸®åˆ°ä»–ã€‚</p>\n<p></p>\n","neighbors":{"left":{"article_title":"ç¬¬23è®² | è¯·ä»‹ç»ç±»åŠ è½½è¿‡ç¨‹ï¼Œä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ","id":9946},"right":{"article_title":"ç¬¬25è®² | è°ˆè°ˆJVMå†…å­˜åŒºåŸŸçš„åˆ’åˆ†ï¼Œå“ªäº›åŒºåŸŸå¯èƒ½å‘ç”ŸOutOfMemoryError?","id":10192}},"comments":[{"had_liked":false,"id":14357,"user_name":"ä¸‰å£å…ˆç”Ÿ","can_delete":false,"product_type":"c1","uid":1117257,"ip_address":"","ucode":"8E8672321FE510","user_header":"https://static001.geekbang.org/account/avatar/00/11/0c/49/d71e939d.jpg","comment_is_top":false,"comment_ctime":1530325970,"is_pvip":false,"replies":[{"id":"4838","content":"ä¸é”™","user_name":"ä½œè€…å›å¤","user_name_real":"æ¨æ™“å³°","uid":"1009360","ctime":1530373135,"ip_address":"","comment_id":14357,"utype":1}],"discussion_count":1,"race_medal":0,"score":"267818298322","product_id":100006701,"comment_content":"å°†èµ„æºæ¶ˆè€—çš„è¿™ä¸ªå®ä¾‹ï¼Œç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼åˆ›å»ºè¿™ä¸ªå®ä¾‹åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œåœ¨åŠ¨æ€ä»£ç†çš„invokeä¸­æ·»åŠ æ–°çš„éœ€æ±‚ã€‚å¼€å§‹ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œä¸å¼€å¯åˆ™ä½¿ç”¨åŸæ¥çš„æ–¹æ³•ï¼Œå› ä¸ºåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åˆ›å»ºã€‚æ‰€ä»¥æ˜¯é›¶æ¶ˆè€—ã€‚","like_count":62,"discussions":[{"author":{"id":1009360,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/66/d0/6541f1d5.jpg","nickname":"æ¨æ™“å³°","note":"","ucode":"2BF255467A978F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":419982,"discussion_content":"ä¸é”™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1530373135,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":14646,"user_name":"tyson","can_delete":false,"product_type":"c1","uid":1110943,"ip_address":"","ucode":"E88F630B53C743","user_header":"https://static001.geekbang.org/account/avatar/00/10/f3/9f/3e4e8d46.jpg","comment_is_top":false,"comment_ctime":1530582391,"is_pvip":true,"replies":[{"id":"4983","content":"æ˜¯çš„ï¼Œæˆ‘è‡ªå·±ä¹Ÿæ˜¯ç”¨Javaagentæ–¹æ¡ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¨æ™“å³°","uid":"1009360","ctime":1530665045,"ip_address":"","comment_id":14646,"utype":1}],"discussion_count":4,"race_medal":0,"score":"216278947191","product_id":100006701,"comment_content":"å¯ä»¥è€ƒè™‘ç”¨javaagent+å­—èŠ‚ç å¤„ç†æ‹¦æˆªæ–¹æ³•è¿›è¡Œç»Ÿè®¡ï¼šå¯¹httpclientä¸­çš„æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå¢åŠ headeræˆ–è€…è½¬å‘ç­‰è¿›è¡Œç»Ÿè®¡ã€‚å¼€å¯å’Œå…³é—­åªè¦å¢åŠ ä¸€ä¸ªjavaagentå¯åŠ¨å‚æ•°å°±è¡Œ","like_count":50,"discussions":[{"author":{"id":1009360,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/66/d0/6541f1d5.jpg","nickname":"æ¨æ™“å³°","note":"","ucode":"2BF255467A978F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420075,"discussion_content":"æ˜¯çš„ï¼Œæˆ‘è‡ªå·±ä¹Ÿæ˜¯ç”¨Javaagentæ–¹æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1530665045,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1179622,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ff/e6/4b0ddfcf.jpg","nickname":"æé£","note":"","ucode":"4B23FF72AA4BA0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369832,"discussion_content":"å¦‚æœè¿è¡Œä¸­éœ€è¦å…³é—­å‘¢ï¼Ÿjavaagentæ˜¯ä¸æ˜¯å°±ä¸å¤ªé€‚åˆäº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619169029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113660,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fe/3c/13175251.jpg","nickname":"Miaozhe","note":"","ucode":"62872E8C138B67","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":66462,"discussion_content":"è¦è‡ªå·±é‡å†™Javaagentçš„æ–¹æ³•ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575073348,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1144504,"avatar":"https://static001.geekbang.org/account/avatar/00/11/76/b8/e4cd7997.jpg","nickname":"KAGEMUSHA","note":"","ucode":"DFC05BE62A9C10","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1113660,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fe/3c/13175251.jpg","nickname":"Miaozhe","note":"","ucode":"62872E8C138B67","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305707,"discussion_content":"è¿™åªæ˜¯æ›´è¿›ä¸€æ­¥æ·±å…¥çš„ç­–ç•¥ï¼Œä¸Šé¢ä¸è¯´ç”¨åŠ¨æ€ä»£ç†ç®€å•å®ç°ä¹Ÿè¡Œå—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600064282,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":66462,"ip_address":""},"score":305707,"extra":""}]}]},{"had_liked":false,"id":14363,"user_name":"å››é˜¿å“¥","can_delete":false,"product_type":"c1","uid":1104580,"ip_address":"","ucode":"3296E89174D370","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/c4/270db3ad.jpg","comment_is_top":false,"comment_ctime":1530330338,"is_pvip":false,"replies":[{"id":"4841","content":"éå¸¸æ„Ÿè°¢ï¼Œè€å­¦ç©¶æ„Ÿåˆ°å¾ˆæ¬£æ…°ï¼Œå¸Œæœ›èƒ½å¯¹æœªæ¥å®è·µæœ‰å¸®åŠ©ï¼Œä¸“æ å½¢å¼æ›´å¤šçš„æ˜¯è§£å†³çŸ¥è¯†ç‚¹çš„é—®é¢˜ï¼Œåç»­ä¸“æ è¿˜æ²¡å¼€å§‹æ€è€ƒ","user_name":"ä½œè€…å›å¤","user_name_real":"æ¨æ™“å³°","uid":"1009360","ctime":1530373561,"ip_address":"","comment_id":14363,"utype":1}],"discussion_count":2,"race_medal":0,"score":"61659872482","product_id":100006701,"comment_content":"è€å¸ˆï¼Œæ‚¨è¿™ä¸ªä¸“æ å®Œç»“äº†è¿˜ä¼šä¸ä¼šå‡ºå…¶ä»–ä¸“æ ï¼Œä½ çš„æ¯ä¸€ç¯‡æˆ‘èµ·ç è¦å¬ä¸‰å››éï¼Œæˆ‘éƒ½æ˜¯å’¬æ–‡åš¼å­—çš„å¬ï¼Œéå¸¸æœ‰ç”¨ï¼Œéå¸¸å¥½çš„å†…åŠŸå¿ƒæ³•","like_count":14,"discussions":[{"author":{"id":1009360,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/66/d0/6541f1d5.jpg","nickname":"æ¨æ™“å³°","note":"","ucode":"2BF255467A978F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":419986,"discussion_content":"éå¸¸æ„Ÿè°¢ï¼Œè€å­¦ç©¶æ„Ÿåˆ°å¾ˆæ¬£æ…°ï¼Œå¸Œæœ›èƒ½å¯¹æœªæ¥å®è·µæœ‰å¸®åŠ©ï¼Œä¸“æ å½¢å¼æ›´å¤šçš„æ˜¯è§£å†³çŸ¥è¯†ç‚¹çš„é—®é¢˜ï¼Œåç»­ä¸“æ è¿˜æ²¡å¼€å§‹æ€è€ƒ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1530373561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1644768,"avatar":"https://static001.geekbang.org/account/avatar/00/19/18/e0/fa5a473b.jpg","nickname":"Geek_dbb622","note":"","ucode":"9A061D09F48208","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":185136,"discussion_content":"çœŸæ•¢å¹å•Šä½ ï¼Œè¿˜å¿ƒæ³•","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1582597329,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":14352,"user_name":"antipas","can_delete":false,"product_type":"c1","uid":1039798,"ip_address":"","ucode":"7F95F697D607C2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/dd/b6/fcf322a7.jpg","comment_is_top":false,"comment_ctime":1530323403,"is_pvip":false,"replies":[{"id":"4840","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"æ¨æ™“å³°","uid":"1009360","ctime":1530373184,"ip_address":"","comment_id":14352,"utype":1}],"discussion_count":1,"race_medal":0,"score":"57364898251","product_id":100006701,"comment_content":"æ— ç—•åŸ‹ç‚¹åŸç†å°±æ˜¯è¿™æ ·ã€‚åƒæ³¨è§£ç±»æ¡†æ¶ä¹Ÿç”¨åˆ°äº†æ¯”å¦‚retrofit","like_count":13,"discussions":[{"author":{"id":1009360,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/66/d0/6541f1d5.jpg","nickname":"æ¨æ™“å³°","note":"","ucode":"2BF255467A978F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":419977,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1530373184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":29119,"user_name":"å†¯å®‡","can_delete":false,"product_type":"c1","uid":1248481,"ip_address":"","ucode":"894A0951E776D7","user_header":"https://static001.geekbang.org/account/avatar/00/13/0c/e1/e54540b9.jpg","comment_is_top":false,"comment_ctime":1538270807,"is_pvip":false,"replies":[{"id":"11443","content":"ä¸é”™ï¼Œå„ç§jvmè¯­è¨€ä¹Ÿæ˜¯ä¸€å¤§äº®ç‚¹","user_name":"ä½œè€…å›å¤","user_name_real":"æ¨æ™“å³°","uid":"1009360","ctime":1539274442,"ip_address":"","comment_id":29119,"utype":1}],"discussion_count":1,"race_medal":0,"score":"48782911063","product_id":100006701,"comment_content":"è¿˜å¯ä»¥åŸºäºJVMå®ç°å„ç§åŠ¨æ€è¯­è¨€ã€‚æ¯”å¦‚groovyå°±æ˜¯ä½¿ç”¨javaå¼€å‘çš„åŠ¨æ€è„šæœ¬è¯­è¨€","like_count":11,"discussions":[{"author":{"id":1009360,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/66/d0/6541f1d5.jpg","nickname":"æ¨æ™“å³°","note":"","ucode":"2BF255467A978F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":425498,"discussion_content":"ä¸é”™ï¼Œå„ç§jvmè¯­è¨€ä¹Ÿæ˜¯ä¸€å¤§äº®ç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1539274442,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":14512,"user_name":"rivers","can_delete":false,"product_type":"c1","uid":1168878,"ip_address":"","ucode":"4138B721C2502E","user_header":"https://static001.geekbang.org/account/avatar/00/11/d5/ee/02ce07ee.jpg","comment_is_top":false,"comment_ctime":1530499931,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23005336411","product_id":100006701,"comment_content":"å¸Œæœ›ä½œè€…èƒ½è¯¦ç»†çš„è®²ä¸‹ï¼Œjavaassistç­‰å…¶ä»–ä»£ç†æ¨¡å¼çš„ä½¿ç”¨ï¼Œç æ‰äº†å¾ˆå¤šå†…å®¹ï¼Œå°½é‡è€ƒè™‘ä¸‹æ°´å¹³æœ‰é™çš„è¯»è€…","like_count":5},{"had_liked":false,"id":14984,"user_name":"èƒ¡é¦¥æ˜¥","can_delete":false,"product_type":"c1","uid":1117304,"ip_address":"","ucode":"0EE812A5A1D1CB","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/JooolCyKac0KOswuGiavSmiaOYYHemuGv3JgVGmnOQpcwgVe9akTMdibrtSR9vS8f64vRbYJKMrnibMmOBxCxibhfzg/132","comment_is_top":false,"comment_ctime":1530785170,"is_pvip":false,"replies":[{"id":"5092","content":"ä¸æ˜¯ï¼ŒProxyè¿™é‡Œæ˜¯ä¸ªç‰¹ä¾‹ï¼Œå› ä¸ºéœ€è¦ç”Ÿæˆæ–°çš„class","user_name":"ä½œè€…å›å¤","user_name_real":"æ¨æ™“å³°","uid":"1009360","ctime":1530896131,"ip_address":"","comment_id":14984,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14415687058","product_id":100006701,"comment_content":"æ‰€æœ‰ç”¨åˆ°javaåå°„çš„åœ°æ–¹ï¼Œåº•å±‚éƒ½æ˜¯é‡‡ç”¨äº†å­—èŠ‚ç æ“çºµæŠ€æœ¯ï¼Œè€å¸ˆï¼Œè¿™ä¹ˆç†è§£å¯¹å—ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1009360,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/66/d0/6541f1d5.jpg","nickname":"æ¨æ™“å³°","note":"","ucode":"2BF255467A978F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420201,"discussion_content":"ä¸æ˜¯ï¼ŒProxyè¿™é‡Œæ˜¯ä¸ªç‰¹ä¾‹ï¼Œå› ä¸ºéœ€è¦ç”Ÿæˆæ–°çš„class","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1530896131,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217601,"user_name":"æé£","can_delete":false,"product_type":"c1","uid":1555180,"ip_address":"","ucode":"930458850AA05B","user_header":"https://static001.geekbang.org/account/avatar/00/17/ba/ec/2b1c6afc.jpg","comment_is_top":false,"comment_ctime":1589541813,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10179476405","product_id":100006701,"comment_content":"è¶Šæ¥è¶Šåº•å±‚äº†ï¼Œä¹Ÿè¶Šæ¥è¶ŠåƒåŠ›ï¼Œçœ‹æ¥éœ€è¦åå¤é˜…è¯»æ‰èƒ½åƒé€äº†","like_count":2},{"had_liked":false,"id":183665,"user_name":"æœ±éœ‡éœ‡","can_delete":false,"product_type":"c1","uid":1013128,"ip_address":"","ucode":"6E8AE4506255AE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/88/fd024a11.jpg","comment_is_top":false,"comment_ctime":1583110966,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10173045558","product_id":100006701,"comment_content":"ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€åŠ è½½ï¼Œè¿™ä¸ªéƒ¨åˆ†å¯¹ç³»ç»Ÿæœ‰æ²¡æœ‰å½±å“ï¼Œä¼šå¸¦æ¥ä»€ä¹ˆå¥½å¤„å’Œåå¤„ï¼Œç—›ç‚¹åœ¨å“ªï¼Œè¿™äº›éœ€è¦æ€è€ƒæ¸…æ¥šã€‚<br>å¥½å¤„è§£è€¦ï¼Œå®ç°åŠ¨æ€çš„è½½å…¥å’Œå¸è½½ï¼Œç›‘æ§ç­‰ã€‚ç¼ºç‚¹å°±æ˜¯æ•´ä½“ç³»ç»Ÿç»´æŠ¤å¤æ‚åº¦å¢é«˜ã€‚è¿™ä¸ªæŠ€æœ¯é€šä¿—çš„ç†è§£å°±æ˜¯ä½¿ç”¨äº†å°è£…jvmè¯†åˆ«çš„æŒ‡ä»¤ï¼Œç„¶åç”Ÿæˆå­—èŠ‚ç ï¼Œç„¶åä½¿ç”¨åŠ è½½ç±»çš„æ–¹å¼åŠ è½½ï¼Œç”Ÿæˆã€‚å…·ä½“ç»†èŠ‚è¿˜è¦è¯¦ç»†ç ”ç©¶","like_count":2},{"had_liked":false,"id":90658,"user_name":"èš‚èšå†…æ¨+v","can_delete":false,"product_type":"c1","uid":1050508,"ip_address":"","ucode":"24B10AEE54B3FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/07/8c/0d886dcc.jpg","comment_is_top":false,"comment_ctime":1556602379,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10146536971","product_id":100006701,"comment_content":"è€å¸ˆåœ¨è®²ä¸€äº›çŸ¥è¯†çš„æ—¶å€™ï¼Œä¼šæåŠåˆ°å‰é¢ç›¸å…³çš„ç« èŠ‚ï¼Œè§‰å¾—ç‰¹åˆ«èµï¼Œå¯ä»¥æé†’æˆ‘ä»¬å»å¤ä¹ å‰é¢çš„ç« èŠ‚ï¼Œä¸è‡³äºå­¦äº†åé¢å¿˜äº†å‰é¢~~è€å¸ˆæ—¶ä¸æ—¶å¯ä»¥æ¥ä¸€äº›è¿™æ ·çš„æé†’ğŸ˜","like_count":2},{"had_liked":false,"id":192707,"user_name":"æŠ¤çˆ½ä½¿è€…","can_delete":false,"product_type":"c1","uid":1275464,"ip_address":"","ucode":"12DC35DD74671C","user_header":"https://static001.geekbang.org/account/avatar/00/13/76/48/5ab89daa.jpg","comment_is_top":false,"comment_ctime":1584869080,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5879836376","product_id":100006701,"comment_content":"åå°„ï¼ŒåŠ¨æ€ä»£ç†ç­‰","like_count":1},{"had_liked":false,"id":150010,"user_name":"ç‹ç››æ­¦","can_delete":false,"product_type":"c1","uid":1182516,"ip_address":"","ucode":"DE7EF246D3DCE8","user_header":"https://static001.geekbang.org/account/avatar/00/12/0b/34/f41d73a4.jpg","comment_is_top":false,"comment_ctime":1573444743,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5868412039","product_id":100006701,"comment_content":"è€å¸ˆå¥½, è¯·é—®&quot;newProxyInstance ç”Ÿæˆä»£ç†ç±»å®ä¾‹çš„æ—¶å€™&quot;,  è¿™é‡Œæ˜¯ç”¨ hard-codeç”Ÿæˆå­—èŠ‚ç ,<br>ä¸ºä½•æ‚¨è¿™é‡Œé€‰ç”¨çš„æ˜¯ASMçš„ä¾‹å­å‘¢?  ä¸Šæ–‡æåˆ°äº†JDKé‡ŒASMæ˜¯ç”¨åœ¨LamdaFrom, ä¸æ˜¯newProxyInstanceé‡Œå“¦","like_count":1},{"had_liked":false,"id":84327,"user_name":"å¤šæ ¼","can_delete":false,"product_type":"c1","uid":1222021,"ip_address":"","ucode":"122195F3D90EA1","user_header":"https://static001.geekbang.org/account/avatar/00/12/a5/85/eeb5b42f.jpg","comment_is_top":false,"comment_ctime":1554827385,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5849794681","product_id":100006701,"comment_content":"1. Proxy.newProxyInstance<br>2. Class&lt;?&gt; cl = getProxyClass0(loader, interfaces);<br>3.     private static final WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;<br>        proxyClassCache = new WeakCache&lt;&gt;(new KeyFactory(), new ProxyClassFactory());<br>4.value = Objects.requireNonNull(valueFactory.apply(key, parameter));<br>5.interfaceClass = Class.forName(intf.getName(), false, loader);<br>6.Verify that the Class object actually represents an interface [é™åˆ¶åªèƒ½æ˜¯æ¥å£]<br>7.             byte[] proxyClassFile = ProxyGenerator.generateProxyClass(<br>                proxyName, interfaces, accessFlags);<br>8.return defineClass0(loader, proxyName,<br>                                    proxyClassFile, 0, proxyClassFile.length);<br>","like_count":1},{"had_liked":false,"id":17570,"user_name":"é»„æ˜æ©","can_delete":false,"product_type":"c1","uid":1119409,"ip_address":"","ucode":"EF75C8BFA14D17","user_header":"https://static001.geekbang.org/account/avatar/00/11/14/b1/7d974f0a.jpg","comment_is_top":false,"comment_ctime":1532752985,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5827720281","product_id":100006701,"comment_content":"æ‰€è°“é›¶å¼€é”€æ˜¯æŒ‡å“ªéƒ¨åˆ†å¼€é”€ï¼Œåšä¸ªç»Ÿè®¡çš„å¼€å…³é€»è¾‘ä¸å°±å¥½äº†ï¼Œç¡¬å¥—åŠ¨æ€ä»£ç†æ¥å®ç°æ„Ÿè§‰æœ‰ç‚¹","like_count":1},{"had_liked":false,"id":16222,"user_name":"mojo","can_delete":false,"product_type":"c1","uid":1096150,"ip_address":"","ucode":"2A5E742C00A5C6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIicRlf8vZguE6KpS8FEjpaheGbB3UZojKWTn501r2KLe3I3F7NlpSSpMZpaCcs5PBtR1nCHMHYcrA/132","comment_is_top":false,"comment_ctime":1531836747,"is_pvip":false,"replies":[{"id":"5639","content":"åŠ è½½åˆ°system classloader...æˆ‘ç†è§£å¸è½½ä¸äº†","user_name":"ä½œè€…å›å¤","user_name_real":"æ¨æ™“å³°","uid":"1009360","ctime":1531880542,"ip_address":"","comment_id":16222,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5826804043","product_id":100006701,"comment_content":"è¯·é—®è€å¸ˆï¼Œä½¿ç”¨classloaderåŠ¨æ€åŠ è½½çš„å¤–éƒ¨jaråŒ…ï¼Œåº”è¯¥å¦‚ä½•æ­£ç¡®çš„å¸è½½ï¼Ÿå·²ç»åŠ è½½åˆ°systemclassloaderâ€¦â€¦é€šè¿‡åå°„urlclassloaderçš„addurlæ–¹æ³•åŠ è¿›å»çš„","like_count":1,"discussions":[{"author":{"id":1009360,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/66/d0/6541f1d5.jpg","nickname":"æ¨æ™“å³°","note":"","ucode":"2BF255467A978F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":420718,"discussion_content":"åŠ è½½åˆ°system classloader...æˆ‘ç†è§£å¸è½½ä¸äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1531880542,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2459923,"avatar":"https://static001.geekbang.org/account/avatar/00/25/89/13/0d3c5008.jpg","nickname":"æœ€å¥½ä¸è¿‡","note":"","ucode":"C7DBCD08402DF8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372964,"discussion_content":"å¯ä»¥å¸è½½\nç”±Javaè™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ï¼Œåœ¨è™šæ‹Ÿæœºçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå§‹ç»ˆä¸ä¼šè¢«å¸è½½ã€‚Javaè™šæ‹Ÿæœºè‡ªå¸¦çš„ç±»åŠ å™¨åŒ…æ‹¬æ ¹ç±»åŠ è½½å™¨ï¼Œæ‰©å±•ç±»åŠ è½½å™¨å’Œç³»ç»Ÿç±»åŠ è½½å™¨ã€‚Javaè™šæ‹Ÿæœºæœ¬èº«ä¼šå§‹ç»ˆå¼•ç”¨è¿™äº›ç±»åŠ è½½å™¨ï¼Œè€Œè¿™äº›ç±»åŠ è½½å™¨åˆ™ä¼šå§‹å¼•ç”¨å®ƒä»¬æ‰€åŠ è½½çš„ç±»çš„`Class`å¯¹è±¡ï¼Œå› æ­¤è¿™`Class`å¯¹è±¡ç»ˆæ˜¯å¯åŠçš„ã€‚\n\nç”±ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»æ˜¯å¯ä»¥è¢«å¸è½½çš„ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1620544483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}