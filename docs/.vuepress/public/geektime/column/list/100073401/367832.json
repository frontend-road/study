{"id":367832,"title":"21 | Catalysté€»è¾‘è®¡åˆ’ï¼šä½ çš„SQLè¯­å¥æ˜¯æ€ä¹ˆè¢«ä¼˜åŒ–çš„ï¼Ÿï¼ˆä¸Šï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å´ç£Šã€‚</p><p>ä¸Šä¸€è®²æˆ‘ä»¬è¯´ï¼ŒSpark SQLå·²ç»å–ä»£Spark Coreæˆä¸ºäº†æ–°ä¸€ä»£çš„å†…æ ¸ä¼˜åŒ–å¼•æ“ï¼Œæ‰€æœ‰Sparkå­æ¡†æ¶éƒ½èƒ½å…±äº«Spark SQLå¸¦æ¥çš„æ€§èƒ½çº¢åˆ©ï¼Œæ‰€ä»¥åœ¨Sparkå†æ¬¡å‘å¸ƒçš„æ–°ç‰ˆæœ¬ä¸­ï¼ŒSpark SQLå æ¯”æœ€å¤§ã€‚å› æ­¤ï¼ŒSpark SQLçš„ä¼˜åŒ–è¿‡ç¨‹æ˜¯æˆ‘ä»¬å¿…é¡»è¦æŒæ¡çš„ã€‚</p><p>Spark SQLç«¯åˆ°ç«¯çš„å®Œæ•´ä¼˜åŒ–æµç¨‹ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼šCatalystä¼˜åŒ–å™¨å’ŒTungstenã€‚å…¶ä¸­ï¼ŒCatalystä¼˜åŒ–å™¨åˆåŒ…å«é€»è¾‘ä¼˜åŒ–å’Œç‰©ç†ä¼˜åŒ–ä¸¤ä¸ªé˜¶æ®µã€‚ä¸ºäº†æŠŠå¼€å‘è€…çš„æŸ¥è¯¢ä¼˜åŒ–åˆ°æè‡´ï¼Œæ•´ä¸ªä¼˜åŒ–è¿‡ç¨‹çš„è¿ä½œæœºåˆ¶è®¾è®¡å¾—éƒ½å¾ˆç²¾å¯†ï¼Œå› æ­¤æˆ‘ä¼šç”¨ä¸‰è®²çš„æ—¶é—´å¸¦ä½ è¯¦ç»†æ¢è®¨ã€‚</p><p>ä¸‹å›¾å°±æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„å®Œæ•´å›¾ç¤ºï¼Œä½ å¯ä»¥å…ˆé€šè¿‡å®ƒå¯¹ä¼˜åŒ–æµç¨‹æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤çŸ¥ã€‚ç„¶åéšç€æˆ‘çš„è®²è§£ï¼Œé€æ¸å»å¤¯å®å…¶ä¸­çš„å…³é”®ç¯èŠ‚ã€é‡è¦æ­¥éª¤å’Œæ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œåœ¨æ·±å…¥å±€éƒ¨ä¼˜åŒ–ç»†èŠ‚çš„åŒæ—¶ï¼ŒæŠŠæ¡å…¨å±€ä¼˜åŒ–æµç¨‹ï¼Œåšåˆ°æ—¢è§æ ‘æœ¨ã€ä¹Ÿè§æ£®æ—ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f3/72/f3ffb5fc43ae3c9bca44c1f4f8b7e872.jpg?wh=6539*1200\" alt=\"\" title=\"Spark SQLçš„ä¼˜åŒ–è¿‡ç¨‹\"></p><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å…ˆæ¥è¯´è¯´Catalystä¼˜åŒ–å™¨é€»è¾‘ä¼˜åŒ–é˜¶æ®µçš„å·¥ä½œåŸç†ã€‚</p><h2>æ¡ˆä¾‹ï¼šå°Qå˜èº«è®°</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä¾‹å­æ¥è‡ªç”µå­å•†åŠ¡åœºæ™¯ï¼Œä¸šåŠ¡éœ€æ±‚å¾ˆç®€å•ï¼šç»™å®šäº¤æ˜“äº‹å®è¡¨transactionså’Œç”¨æˆ·ç»´åº¦è¡¨usersï¼Œç»Ÿè®¡ä¸åŒç”¨æˆ·çš„äº¤æ˜“é¢ï¼Œæ•°æ®æºä»¥Parquetçš„æ ¼å¼å­˜å‚¨åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¦å…ˆç”¨Parquet APIè¯»å–æºæ–‡ä»¶ã€‚</p><!-- [[[read_end]]] --><pre><code>val userFile: String = _\nval usersDf = spark.read.parquet(userFile)\nusersDf.printSchema\n/**\nroot\n|-- userId: integer (nullable = true)\n|-- name: string (nullable = true)\n|-- age: integer (nullable = true)\n|-- gender: string (nullable = true)\n|-- email: string (nullable = true)\n*/\nval users = usersDf\n.select(&quot;name&quot;, &quot;age&quot;, &quot;userId&quot;)\n.filter($&quot;age&quot; &lt; 30)\n.filter($&quot;gender&quot;.isin(&quot;M&quot;))\n\nval txFile: String = _\nval txDf = spark.read.parquet(txFile)\ntxDf.printSchema\n/**\nroot\n|-- itemId: integer (nullable = true)\n|-- userId: integer (nullable = true)\n|-- price: float (nullable = true)\n|-- quantity: integer (nullable = true)\n*/\n\nval result = txDF.select(&quot;price&quot;, &quot;volume&quot;, &quot;userId&quot;)\n.join(users, Seq(&quot;userId&quot;), &quot;inner&quot;)\n.groupBy(col(&quot;name&quot;), col(&quot;age&quot;)).agg(sum(col(&quot;price&quot;) * col(&quot;volume&quot;)).alias(&quot;revenue&quot;))\n\nresult.write.parquet(&quot;_&quot;)\n</code></pre><p>ä»£ç ç¤ºä¾‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸ºäº†å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬å¯¹è¿‡æ»¤ä¹‹åçš„ç”¨æˆ·è¡¨ä¸äº¤æ˜“è¡¨åšå†…å…³è”ï¼Œç„¶åå†æŒ‰ç…§ç”¨æˆ·åˆ†ç»„å»è®¡ç®—äº¤æ˜“é¢ã€‚ä¸éš¾å‘ç°ï¼Œè¿™ä¸ªè®¡ç®—é€»è¾‘å®é™…ä¸Šå°±æ˜¯æ˜Ÿå‹æ•°ä»“ä¸­å…¸å‹çš„å…³è”æŸ¥è¯¢ã€‚ä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç»™è¿™ä¸ªå…³è”æŸ¥è¯¢èµ·ä¸ªåå­—ï¼šå°Qã€‚å°Qçš„è®¡ç®—éœ€è¦ä¸¤ä¸ªè¾“å…¥æºï¼Œä¸€ä¸ªæ˜¯äº¤æ˜“è¡¨ï¼Œå¦ä¸€ä¸ªæ˜¯è¿‡æ»¤ä¹‹åçš„ç”¨æˆ·è¡¨ã€‚ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±å»è¿½éšå°Qï¼Œçœ‹çœ‹å®ƒåœ¨Catalystçš„é€»è¾‘ä¼˜åŒ–é˜¶æ®µéƒ½ä¼šå‘ç”Ÿå“ªäº›å˜åŒ–ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/20/00/205a81e95f483ce66ed019b4120ec000.jpg?wh=1281*1556\" alt=\"\" title=\"å°Qçš„è®¡ç®—é€»è¾‘\"></p><p><strong>Catalysté€»è¾‘ä¼˜åŒ–é˜¶æ®µåˆ†ä¸ºä¸¤ä¸ªç¯èŠ‚ï¼šé€»è¾‘è®¡åˆ’è§£æå’Œé€»è¾‘è®¡åˆ’ä¼˜åŒ–ã€‚åœ¨é€»è¾‘è®¡åˆ’è§£æä¸­ï¼ŒCatalystæŠŠâ€œUnresolved Logical Planâ€è½¬æ¢ä¸ºâ€œAnalyzed Logical Planâ€ï¼›åœ¨é€»è¾‘è®¡åˆ’ä¼˜åŒ–ä¸­ï¼ŒCatalyståŸºäºä¸€äº›æ—¢å®šçš„å¯å‘å¼è§„åˆ™ï¼ˆHeuristics Based Rulesï¼‰ï¼ŒæŠŠâ€œAnalyzed Logical Planâ€è½¬æ¢ä¸ºâ€œOptimized Logical Planâ€ã€‚</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/0e/a3/0efa02fd8eda5a69c794871ea77030a3.jpg?wh=3436*1130\" alt=\"\" title=\"Catalysté€»è¾‘ä¼˜åŒ–é˜¶æ®µ\"></p><p>å› ä¸ºâ€œUnresolved Logical Planâ€æ˜¯Catalystä¼˜åŒ–çš„èµ·ç‚¹ï¼Œæ‰€ä»¥åœ¨è¿›å…¥Catalystä¼˜åŒ–å™¨ä¹‹å‰ï¼Œå°Qå…ˆæ˜¯æ”¹å¤´æ¢é¢ï¼Œä»ä»£ç ä¸­çš„æŸ¥è¯¢è¯­å¥ï¼Œæ‘‡èº«å˜æˆäº†â€œUnresolved Logical Planâ€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ff/80/fff906004736005de9c83cbfc09d8380.png?wh=1306*390\" alt=\"\" title=\"å°Qå¯ç¨‹ï¼šUnresolved Logical Plan\"></p><h2>é€»è¾‘è®¡åˆ’è§£æ</h2><p>å°QæˆåŠŸè¿›å…¥Catalystä¼˜åŒ–å™¨ä¹‹åï¼Œå°±è¦å¼€å§‹æ‰§è¡Œé€»è¾‘è®¡åˆ’è§£æï¼Œä¹Ÿå°±æ˜¯è¦ä»â€œUnresolved Logical Planâ€è½¬æ¢ä¸ºâ€œAnalyzed Logical Planâ€ã€‚é‚£ä¹ˆï¼Œå…·ä½“è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p><p>ä»â€œå°Qå¯ç¨‹â€é‚£å¼ å›¾æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œâ€œUnresolved Logical Planâ€æºå¸¦çš„ä¿¡æ¯ç›¸å½“æœ‰é™ï¼Œå®ƒåªåŒ…å«æŸ¥è¯¢è¯­å¥ä»DSLè¯­æ³•å˜æ¢æˆASTè¯­æ³•æ ‘çš„ä¿¡æ¯ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸è®ºæ˜¯é€»è¾‘è®¡åˆ’è¿˜æ˜¯ç‰©ç†è®¡åˆ’ï¼Œæ‰§è¡Œçš„æ¬¡åºéƒ½æ˜¯è‡ªä¸‹å‘ä¸Šã€‚å› æ­¤ï¼Œå›¾ä¸­é€»è¾‘è®¡åˆ’çš„è®¡ç®—é¡ºåºæ˜¯ä»å…¨è¡¨æ‰«æåˆ°æŒ‰æ€§åˆ«è¿‡æ»¤ï¼Œæ¯ä¸ªæ­¥éª¤çš„å«ä¹‰éƒ½æ˜¯å‡†å¤‡â€œåšä»€ä¹ˆâ€ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨è®¡åˆ’çš„æœ€åº•å±‚ï¼ŒRelationèŠ‚ç‚¹â€œå‘Šè¯‰â€Catalystï¼šâ€œä½ éœ€è¦æ‰«æä¸€å¼ è¡¨ï¼Œè¿™å¼ è¡¨æœ‰4ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯ABCDï¼Œæ–‡ä»¶æ ¼å¼æ˜¯Parquetâ€ã€‚ä½†è¿™äº›ä¿¡æ¯å¯¹äºå°Qçš„ä¼˜åŒ–è¿˜è¿œè¿œä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“è¿™å¼ è¡¨çš„Schemaæ˜¯å•¥ï¼Ÿå­—æ®µçš„ç±»å‹éƒ½æ˜¯ä»€ä¹ˆï¼Ÿå­—æ®µåæ˜¯å¦çœŸå®å­˜åœ¨ï¼Ÿæ•°æ®è¡¨ä¸­çš„å­—æ®µåä¸è®¡åˆ’ä¸­çš„å­—æ®µåæ˜¯ä¸€è‡´çš„å—ï¼Ÿ</p><p>å› æ­¤ï¼Œ<strong>åœ¨é€»è¾‘è®¡åˆ’è§£æç¯èŠ‚ï¼ŒCatalystå°±æ˜¯è¦ç»“åˆDataFrameçš„Schemaä¿¡æ¯ï¼Œæ¥ç¡®è®¤è®¡åˆ’ä¸­çš„è¡¨åã€å­—æ®µåã€å­—æ®µç±»å‹ä¸å®é™…æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚</strong>å®Œæˆç¡®è®¤ä¹‹åï¼ŒCatalystä¼šç”Ÿæˆâ€œAnalyzed Logical Planâ€ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°Qå°±ä¼šä»â€œUnresolved Logical Planâ€è½¬æ¢æˆâ€œAnalyzed Logical Planâ€ã€‚</p><p>ä»ä¸‹å›¾ä¸­æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ï¼Œé€»è¾‘è®¡åˆ’å·²ç»å®Œæˆäº†ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå¹¶ä¸”å¯ä»¥è¯†åˆ«ä¸¤å¼ è¡¨çš„å­—æ®µç±»å‹ï¼Œæ¯”å¦‚userIdçš„ç±»å‹æ˜¯intï¼Œpriceå­—æ®µçš„ç±»å‹æ˜¯doubleç­‰ç­‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ac/7b/ac83f9d0cdab8655a5fffc9125a93f7b.png?wh=1564*438\" alt=\"\" title=\"å°Qå†å˜èº«ï¼šAnalyzed Logical Plan\"></p><h2>é€»è¾‘è®¡åˆ’ä¼˜åŒ–</h2><p>å¯¹äºç°åœ¨çš„å°Qæ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸åšä»»ä½•ä¼˜åŒ–ï¼Œç›´æ¥æŠŠå®ƒè½¬æ¢ä¸ºç‰©ç†è®¡åˆ’ä¹Ÿå¯ä»¥ã€‚ä½†æ˜¯ï¼Œè¿™ç§ç…§æ¬å¼€å‘è€…çš„è®¡ç®—æ­¥éª¤å»åˆ¶å®šç‰©ç†è®¡åˆ’çš„æ–¹å¼ï¼Œå®ƒçš„æ‰§è¡Œæ•ˆç‡å¾€å¾€ä¸æ˜¯æœ€ä¼˜çš„ã€‚</p><p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿåœ¨è¿è¡Œæ—¶ï¼ŒSparkä¼šå…ˆå…¨é‡æ‰«æParquetæ ¼å¼çš„ç”¨æˆ·è¡¨ï¼Œç„¶åé´é€‰å‡ºuserIdã€nameã€ageã€genderå››ä¸ªå­—æ®µï¼Œæ¥ç€åˆ†åˆ«æŒ‰ç…§å¹´é¾„å’Œæ€§åˆ«å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚</p><p>å¯¹äºè¿™æ ·çš„æ‰§è¡Œè®¡åˆ’æ¥è¯´ï¼Œæœ€å¼€å§‹çš„å…¨é‡æ‰«ææ˜¾ç„¶æ˜¯ä¸€ç§æµªè´¹ã€‚åŸå› ä¸»è¦æœ‰ä¸¤æ–¹é¢ï¼šä¸€æ–¹é¢ï¼ŒæŸ¥è¯¢å®é™…ä¸Šåªæ¶‰åŠ4ä¸ªå­—æ®µï¼Œå¹¶ä¸éœ€è¦emailè¿™ä¸€åˆ—æ•°æ®ï¼›å¦ä¸€æ–¹é¢ï¼Œå­—æ®µageå’Œgenderä¸Šå¸¦æœ‰è¿‡æ»¤æ¡ä»¶ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åˆ©ç”¨è¿™äº›è¿‡æ»¤æ¡ä»¶å‡å°‘éœ€è¦æ‰«æçš„æ•°æ®é‡ã€‚</p><p>ç”±æ­¤å¯è§ï¼Œ<strong>å¯¹äºåŒæ ·ä¸€ç§è®¡ç®—é€»è¾‘ï¼Œå®ç°æ–¹å¼å¯ä»¥æœ‰å¤šç§ï¼ŒæŒ‰ç…§ä¸åŒçš„é¡ºåºå¯¹ç®—å­åšæ’åˆ—ç»„åˆï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¼”åŒ–å‡ºä¸åŒçš„å®ç°æ–¹å¼ã€‚æœ€å¥½çš„æ–¹å¼æ˜¯ï¼Œæˆ‘ä»¬éµå¾ªâ€œèƒ½çœåˆ™çœã€èƒ½æ‹–åˆ™æ‹–â€çš„å¼€å‘åŸåˆ™ï¼Œå»é€‰æ‹©æ‰€æœ‰å®ç°æ–¹å¼ä¸­æœ€ä¼˜çš„é‚£ä¸ª</strong>ã€‚</p><p>åŒæ ·ï¼Œåœ¨é¢å¯¹è¿™ç§â€œé€‰æ‹©é¢˜â€çš„æ—¶å€™ï¼ŒCatalystä¹Ÿæœ‰ä¸€å¥—è‡ªå·±çš„â€œåŸåˆ™â€å’Œé€»è¾‘ã€‚å› æ­¤ï¼Œç”Ÿæˆâ€œAnalyzed Logical Planâ€ä¹‹åï¼ŒCatalystå¹¶ä¸ä¼šæ­¢æ­¥äºæ­¤ï¼Œå®ƒä¼šåŸºäºä¸€å¥—å¯å‘å¼çš„è§„åˆ™ï¼ŒæŠŠâ€œAnalyzed Logical Planâ€è½¬æ¢ä¸ºâ€œOptimized Logical Planâ€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a0/29/a0391155f57085266a7703b0cb788329.jpg?wh=3447*1149\" alt=\"\" title=\"é€»è¾‘ä¼˜åŒ–ç¯èŠ‚\"></p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒCatalystéƒ½æœ‰å“ªäº›æ—¢å®šçš„è§„åˆ™å’Œé€»è¾‘å‘¢ï¼ŸåŸºäºè¿™äº›è§„åˆ™ï¼ŒCatalyståˆæ˜¯æ€ä¹ˆåšè½¬æ¢çš„å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥è§£ç­”ï¼Œå’±ä»¬å…ˆæ¥è¯´è¯´Catalystçš„ä¼˜åŒ–è§„åˆ™ï¼Œç„¶åå†å»æ¢è®¨é€»è¾‘è®¡åˆ’çš„è½¬æ¢è¿‡ç¨‹ã€‚</p><h3>Catalystçš„ä¼˜åŒ–è§„åˆ™</h3><p>å’ŒCatalystç›¸æ¯”ï¼Œå’±ä»¬æ€»ç»“å‡ºçš„å¼€å‘åŸåˆ™ç®€ç›´å°±æ˜¯å°å·«è§å¤§å·«ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿåœ¨æ–°å‘å¸ƒçš„Spark 3.0ç‰ˆæœ¬ä¸­ï¼ŒCatalystæ€»å…±æœ‰81æ¡ä¼˜åŒ–è§„åˆ™ï¼ˆRulesï¼‰ï¼Œè¿™81æ¡è§„åˆ™ä¼šåˆ†æˆ27ç»„ï¼ˆBatchesï¼‰ï¼Œå…¶ä¸­æœ‰äº›è§„åˆ™ä¼šè¢«æ”¶çº³åˆ°å¤šä¸ªåˆ†ç»„é‡Œã€‚å› æ­¤ï¼Œå¦‚æœä¸è€ƒè™‘è§„åˆ™çš„é‡å¤æ€§ï¼Œ27ç»„ç®—ä¸‹æ¥æ€»å…±ä¼šæœ‰129ä¸ªä¼˜åŒ–è§„åˆ™ã€‚</p><p>å¯¹äºå¦‚æ­¤å¤šçš„ä¼˜åŒ–è§„åˆ™ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆå­¦å‘¢ï¼Ÿå®é™…ä¸Šï¼Œå¦‚æœä»ä¼˜åŒ–æ•ˆæœçš„è§’åº¦å‡ºå‘ï¼Œè¿™äº›è§„åˆ™å¯ä»¥å½’çº³åˆ°ä»¥ä¸‹3ä¸ªèŒƒç•´ï¼š</p><ul>\n<li><strong>è°“è¯ä¸‹æ¨ï¼ˆPredicate Pushdownï¼‰</strong></li>\n<li><strong>åˆ—å‰ªè£ï¼ˆColumn Pruningï¼‰</strong></li>\n<li><strong>å¸¸é‡æ›¿æ¢ ï¼ˆConstant Foldingï¼‰</strong></li>\n</ul><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥è¯´è¯´è°“è¯ä¸‹æ¨è°“è¯ä¸‹æ¨ä¸»è¦æ˜¯å›´ç»•ç€æŸ¥è¯¢ä¸­çš„è¿‡æ»¤æ¡ä»¶åšæ–‡ç« ã€‚å…¶ä¸­ï¼Œ<strong>â€œè°“è¯â€æŒ‡ä»£çš„æ˜¯åƒç”¨æˆ·è¡¨ä¸Šâ€œage &lt; 30â€è¿™æ ·çš„è¿‡æ»¤æ¡ä»¶ï¼Œâ€œä¸‹æ¨â€æŒ‡ä»£çš„æ˜¯æŠŠè¿™äº›è°“è¯æ²¿ç€æ‰§è¡Œè®¡åˆ’å‘ä¸‹ï¼Œæ¨åˆ°ç¦»æ•°æ®æºæœ€è¿‘çš„åœ°æ–¹ï¼Œä»è€Œåœ¨æºå¤´å°±å‡å°‘æ•°æ®æ‰«æé‡</strong>ã€‚æ¢å¥è¯è¯´ï¼Œè®©è¿™äº›è°“è¯è¶Šæ¥è¿‘æ•°æ®æºè¶Šå¥½ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨ä¸‹æ¨ä¹‹å‰ï¼ŒCatalystè¿˜ä¼šå…ˆå¯¹è°“è¯æœ¬èº«åšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚åƒOptimizeInè§„åˆ™ï¼Œå®ƒä¼šæŠŠâ€œgender in â€˜Mâ€™â€ä¼˜åŒ–æˆâ€œgender = â€˜Mâ€™â€ï¼Œä¹Ÿå°±æ˜¯æŠŠè°“è¯inæ›¿æ¢æˆç­‰å€¼è°“è¯ã€‚å†æ¯”å¦‚ï¼ŒCombineFiltersè§„åˆ™ï¼Œå®ƒä¼šæŠŠâ€œage &lt; 30â€å’Œâ€œgender = â€˜Mâ€™â€è¿™ä¸¤ä¸ªè°“è¯ï¼Œæåˆæˆä¸€ä¸ªè°“è¯ï¼šâ€œage != null AND gender != null AND age &lt;30 AND gender = â€˜Mâ€™â€ã€‚</p><p>å®Œæˆè°“è¯æœ¬èº«çš„ä¼˜åŒ–ä¹‹åï¼ŒCatalystå†ç”¨PushDownPredicteä¼˜åŒ–è§„åˆ™ï¼ŒæŠŠè°“è¯æ¨åˆ°é€»è¾‘è®¡åˆ’æ ‘æœ€ä¸‹é¢çš„æ•°æ®æºä¸Šã€‚å¯¹äºParquetã€ORCè¿™ç±»å­˜å‚¨æ ¼å¼ï¼Œç»“åˆæ–‡ä»¶æ³¨è„šï¼ˆFooterï¼‰ä¸­çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸‹æ¨çš„è°“è¯èƒ½å¤Ÿå¤§å¹…å‡å°‘æ•°æ®æ‰«æé‡ï¼Œé™ä½ç£ç›˜I/Oå¼€é”€ã€‚</p><p>å†æ¥è¯´è¯´åˆ—å‰ªè£ã€‚<strong>åˆ—å‰ªè£å°±æ˜¯æ‰«ææ•°æ®æºçš„æ—¶å€™ï¼Œåªè¯»å–é‚£äº›ä¸æŸ¥è¯¢ç›¸å…³çš„å­—æ®µã€‚</strong>ä»¥å°Qä¸ºä¾‹ï¼Œç”¨æˆ·è¡¨çš„Schemaæ˜¯ï¼ˆuserIdã€nameã€ageã€genderã€emailï¼‰ï¼Œä½†æ˜¯æŸ¥è¯¢ä¸­å‹æ ¹å°±æ²¡æœ‰å‡ºç°è¿‡emailçš„å¼•ç”¨ï¼Œå› æ­¤ï¼ŒCatalystä¼šä½¿ç”¨ ColumnPruningè§„åˆ™ï¼ŒæŠŠemailè¿™ä¸€åˆ—â€œå‰ªæ‰â€ã€‚ç»è¿‡è¿™ä¸€æ­¥ä¼˜åŒ–ï¼ŒSparkåœ¨è¯»å–Parquetæ–‡ä»¶çš„æ—¶å€™å°±ä¼šè·³è¿‡emailè¿™ä¸€åˆ—ï¼Œä»è€ŒèŠ‚çœI/Oå¼€é”€ã€‚</p><p>ä¸éš¾å‘ç°ï¼Œè°“è¯ä¸‹æ¨ä¸åˆ—å‰ªè£çš„ä¼˜åŒ–åŠ¨æœºï¼Œå…¶å®å’Œâ€œèƒ½çœåˆ™çœâ€çš„åŸåˆ™ä¸€æ ·ã€‚æ ¸å¿ƒæ€æƒ³éƒ½æ˜¯ç”¨å°½ä¸€åˆ‡åŠæ³•ï¼Œå‡å°‘éœ€è¦æ‰«æå’Œå¤„ç†çš„æ•°æ®é‡ï¼Œé™ä½åç»­è®¡ç®—çš„è´Ÿè½½ã€‚</p><p>æœ€åä¸€ç±»ä¼˜åŒ–æ˜¯å¸¸é‡æ›¿æ¢ï¼Œå®ƒçš„é€»è¾‘æ¯”è¾ƒç®€å•ã€‚å‡è®¾æˆ‘ä»¬åœ¨å¹´é¾„ä¸ŠåŠ çš„è¿‡æ»¤æ¡ä»¶æ˜¯â€œage &lt; 12 + 18â€ï¼ŒCatalystä¼šä½¿ç”¨ConstantFoldingè§„åˆ™ï¼Œè‡ªåŠ¨å¸®æˆ‘ä»¬æŠŠæ¡ä»¶å˜æˆâ€œage &lt; 30â€ã€‚å†æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨selectè¯­å¥ä¸­ï¼Œæºæ‚äº†ä¸€äº›å¸¸é‡è¡¨è¾¾å¼ï¼ŒCatalystä¹Ÿä¼šè‡ªåŠ¨åœ°ç”¨è¡¨è¾¾å¼çš„ç»“æœè¿›è¡Œæ›¿æ¢ã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå’±ä»¬ä»åŠŸç”¨å’Œæ•ˆæœçš„è§’åº¦ï¼Œæ¢è®¨äº†Catalysté€»è¾‘ä¼˜åŒ–è§„åˆ™çš„3å¤§èŒƒç•´ã€‚ä½ å¯èƒ½è¯´ï¼šâ€œæ‹¢å…±å°±åšäº†è¿™ä¹ˆ3ä»¶äº‹ï¼Œè‡³äºå…´å¸ˆåŠ¨ä¼—åœ°åˆ¶å®š81æ¡è§„åˆ™å—ï¼Ÿâ€æˆ‘ä»¬åˆ’åˆ†è¿™3å¤§èŒƒç•´ï¼Œä¸»è¦æ˜¯ä¸ºäº†å™è¿°å’Œç†è§£ä¸Šçš„æ–¹ä¾¿ã€‚å®é™…ä¸Šï¼Œå¯¹äºå¼€å‘è€…å†™å‡ºçš„äº”èŠ±å…«é—¨ã€åƒå¥‡ç™¾æ€ªçš„æŸ¥è¯¢è¯­å¥ï¼Œæ­£æ˜¯å› ä¸ºCatalystä¸æ–­ä¸°å¯Œçš„ä¼˜åŒ–è§„åˆ™ï¼Œæ‰è®©è¿™äº›æŸ¥è¯¢éƒ½èƒ½å¤Ÿäº«æœ‰ä¸é”™çš„æ‰§è¡Œæ€§èƒ½ã€‚å¦‚æœæ²¡æœ‰è¿™äº›ä¼˜åŒ–è§„åˆ™çš„å¸®å¿™ï¼Œå°Qçš„æ‰§è¡Œæ€§èƒ½ä¸€å®šä¼šæƒ¨ä¸å¿ç¹ã€‚</p><p>æœ€ç»ˆï¼Œè¢«Catalystä¼˜åŒ–è¿‡åçš„å°Qï¼Œå°±ä»â€œAnalyzed Logical Planâ€è½¬æ¢ä¸ºâ€œOptimized Logical Planâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°“è¯ä¸‹æ¨å’Œåˆ—å‰ªè£éƒ½ä½“ç°åˆ°äº†Optimized Logical Planä¸­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/72/df/7223829502eeeca0fbfb721c6a3b61df.png?wh=1338*390\" alt=\"\" title=\"å°Qå†å˜èº«ï¼šOptimized Logical Plan\"></p><h3>Catalysçš„ä¼˜åŒ–è¿‡ç¨‹</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ç»§ç»­æ¥å›ç­”åˆšåˆšæå‡ºçš„ç¬¬äºŒä¸ªé—®é¢˜ï¼šåŸºäºè¿™ä¹ˆå¤šä¼˜åŒ–è§„åˆ™ï¼ŒCatalystå…·ä½“æ˜¯æ€ä¹ˆæŠŠâ€œAnalyzed Logical Planâ€è½¬æ¢æˆâ€œOptimized Logical Planâ€çš„å‘¢ï¼Ÿå…¶å®ï¼Œä¸ç®¡æ˜¯é€»è¾‘è®¡åˆ’ï¼ˆLogical Planï¼‰è¿˜æ˜¯ç‰©ç†è®¡åˆ’ï¼ˆPhysical Planï¼‰ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿è‡ªQueryPlanã€‚</p><p>QueryPlançš„çˆ¶ç±»æ˜¯TreeNodeï¼ŒTreeNodeå°±æ˜¯è¯­æ³•æ ‘ä¸­å¯¹äºèŠ‚ç‚¹çš„æŠ½è±¡ã€‚TreeNodeæœ‰ä¸€ä¸ªåå«childrençš„å­—æ®µï¼Œç±»å‹æ˜¯Seq[TreeNode]ï¼Œåˆ©ç”¨TreeNodeç±»å‹ï¼ŒCatalystå¯ä»¥å¾ˆå®¹æ˜“åœ°æ„å»ºä¸€ä¸ªæ ‘ç»“æ„ã€‚</p><p>é™¤äº†childrenå­—æ®µï¼ŒTreeNodeè¿˜å®šä¹‰äº†å¾ˆå¤šé«˜é˜¶å‡½æ•°ï¼Œå…¶ä¸­æœ€å€¼å¾—å…³æ³¨çš„æ˜¯ä¸€ä¸ªå«åštransformDownçš„æ–¹æ³•ã€‚transformDownçš„å½¢å‚ï¼Œæ­£æ˜¯Catalystå®šä¹‰çš„å„ç§ä¼˜åŒ–è§„åˆ™ï¼Œæ–¹æ³•çš„è¿”å›ç±»å‹è¿˜æ˜¯TreeNodeã€‚å¦å¤–ï¼ŒtransformDownæ˜¯ä¸ªé€’å½’å‡½æ•°ï¼Œå‚æ•°çš„ä¼˜åŒ–è§„åˆ™ä¼šå…ˆä½œç”¨ï¼ˆApplyï¼‰äºå½“å‰èŠ‚ç‚¹ï¼Œç„¶åä¾æ¬¡ä½œç”¨åˆ°childrenä¸­çš„å­èŠ‚ç‚¹ï¼Œç›´åˆ°æ•´æ£µæ ‘çš„å¶å­èŠ‚ç‚¹ã€‚</p><p><strong>æ€»çš„æ¥è¯´ï¼Œä»â€œAnalyzed Logical Planâ€åˆ°â€œOptimized Logical Planâ€çš„è½¬æ¢ï¼Œå°±æ˜¯ä»ä¸€ä¸ªTreeNodeç”Ÿæˆå¦ä¸€ä¸ªTreeNodeçš„è¿‡ç¨‹ã€‚</strong>Analyzed Logical Plançš„æ ¹èŠ‚ç‚¹ï¼Œé€šè¿‡è°ƒç”¨transformDownæ–¹æ³•ï¼Œä¸åœåœ°æŠŠå„ç§ä¼˜åŒ–è§„åˆ™ä½œç”¨åˆ°æ•´æ£µæ ‘ï¼Œç›´åˆ°æŠŠæ‰€æœ‰27ç»„è§„åˆ™å°è¯•å®Œæ¯•ï¼Œä¸”æ ‘ç»“æ„ä¸å†å‘ç”Ÿå˜åŒ–ä¸ºæ­¢ã€‚è¿™ä¸ªæ—¶å€™ï¼Œç”Ÿæˆçš„TreeNodeå°±æ˜¯Optimized Logical Planã€‚</p><p>ä¸ºäº†æŠŠå¤æ‚é—®é¢˜ç®€å•åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨Expressionï¼Œä¹Ÿå°±æ˜¯è¡¨è¾¾å¼æ¥è§£é‡Šä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚å› ä¸ºExpressionæœ¬èº«ä¹Ÿç»§æ‰¿è‡ªTreeNodeï¼Œæ‰€ä»¥æ˜ç™½äº†è¿™ä¸ªä¾‹å­ï¼ŒTreeNodeä¹‹é—´çš„è½¬æ¢æˆ‘ä»¬ä¹Ÿå°±æ¸…æ¥šäº†ã€‚</p><pre><code>//Expressionçš„è½¬æ¢\nimport org.apache.spark.sql.catalyst.expressions._\nval myExpr: Expression = Multiply(Subtract(Literal(6), Literal(4)), Subtract(Literal(1), Literal(9)))\nval transformed: Expression = myExpr transformDown {\n  case BinaryOperator(l, r) =&gt; Add(l, r)\n  case IntegerLiteral(i) if i &gt; 5 =&gt; Literal(1)\n  case IntegerLiteral(i) if i &lt; 5 =&gt; Literal(0)\n}\n</code></pre><p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªè¡¨è¾¾å¼ï¼šï¼ˆï¼ˆ6 - 4ï¼‰*ï¼ˆ1 - 9ï¼‰ï¼‰ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨è¿™ä¸ªè¡¨è¾¾å¼çš„transformDowné«˜é˜¶å‡½æ•°ã€‚åœ¨é«˜é˜¶å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç”¨caseå®šä¹‰çš„åŒ¿åå‡½æ•°ã€‚æ˜¾ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªåå‡½æ•°ï¼ˆPartial Functionsï¼‰ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªåŒ¿åå‡½æ•°ç†è§£æˆâ€œè‡ªå®šä¹‰çš„ä¼˜åŒ–è§„åˆ™â€ã€‚åœ¨è¿™ä¸ªä¼˜åŒ–è§„åˆ™ä¸­ï¼Œæˆ‘ä»¬ä»…è€ƒè™‘3ç§æƒ…å†µï¼š</p><ul>\n<li>å¯¹äºæ‰€æœ‰çš„äºŒå…ƒæ“ä½œç¬¦ï¼Œæˆ‘ä»¬éƒ½æŠŠå®ƒè½¬åŒ–æˆåŠ æ³•æ“ä½œ</li>\n<li>å¯¹äºæ‰€æœ‰å¤§äº5çš„æ•°å­—ï¼Œæˆ‘ä»¬éƒ½æŠŠå®ƒå˜æˆ1</li>\n<li>å¯¹äºæ‰€æœ‰å°äº5çš„æ•°å­—ï¼Œæˆ‘ä»¬éƒ½æŠŠå®ƒå˜æˆ0</li>\n</ul><p>è™½ç„¶æˆ‘ä»¬çš„ä¼˜åŒ–è§„åˆ™æ²¡æœ‰ä»»ä½•å®è´¨æ€§çš„æ„ä¹‰ï¼Œä»…ä»…æ˜¯ä¸€ç§è½¬æ¢è§„åˆ™è€Œå·²ï¼Œä½†æ˜¯è¿™å¹¶ä¸å¦¨ç¢ä½ å»ç†è§£Catalystä¸­TreeNodeä¹‹é—´çš„è½¬æ¢ã€‚å½“æˆ‘ä»¬æŠŠè¿™ä¸ªè§„åˆ™åº”ç”¨åˆ°è¡¨è¾¾å¼ï¼ˆï¼ˆ6 - 4ï¼‰*ï¼ˆ1 - 9ï¼‰ï¼‰ä¹‹åï¼Œå¾—åˆ°çš„ç»“æœæ˜¯å¦å¤–ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆï¼ˆ1 + 0ï¼‰+ï¼ˆ0 + 1ï¼‰ï¼‰ï¼Œä¸‹é¢çš„ç¤ºæ„å›¾ç›´è§‚åœ°å±•ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ea/1f/ea21ec9387e55e94d763d9ee0c4a4b1f.jpg?wh=3369*827\" alt=\"\" title=\"è‡ªé¡¶å‘ä¸‹å¯¹æ‰§è¡Œè®¡åˆ’è¿›è¡Œè½¬æ¢\"></p><p>ä»â€œAnalyzed Logical Planâ€åˆ°â€œOptimized Logical Planâ€çš„è½¬æ¢ï¼Œä¸ç¤ºä¾‹ä¸­è¡¨è¾¾å¼çš„è½¬æ¢è¿‡ç¨‹å¦‚å‡ºä¸€è¾™ã€‚æœ€ä¸»è¦çš„åŒºåˆ«åœ¨äºï¼ŒCatalystçš„ä¼˜åŒ–è§„åˆ™è¦å¤æ‚ã€ç²¾å¯†å¾—å¤šã€‚</p><h3>Cache Managerä¼˜åŒ–</h3><p>ä»â€œAnalyzed Logical Planâ€åˆ°â€œOptimized Logical Planâ€çš„è½¬æ¢ï¼ŒCatalysté™¤äº†ä½¿ç”¨å¯å‘å¼çš„è§„åˆ™ä»¥å¤–ï¼Œè¿˜ä¼šåˆ©ç”¨Cache Manageråšè¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚</p><p><strong>è¿™é‡Œçš„CacheæŒ‡çš„å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„åˆ†å¸ƒå¼æ•°æ®ç¼“å­˜ã€‚æƒ³è¦å¯¹æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œä½ å¯ä»¥è°ƒç”¨DataFrameçš„.cacheæˆ–.persistï¼Œæˆ–æ˜¯åœ¨SQLè¯­å¥ä¸­ä½¿ç”¨â€œcache tableâ€å…³é”®å­—</strong>ã€‚</p><p>Cache Managerå…¶å®å¾ˆç®€å•ï¼Œå®ƒçš„ä¸»è¦èŒè´£æ˜¯ç»´æŠ¤ä¸ç¼“å­˜æœ‰å…³çš„ä¿¡æ¯ã€‚å…·ä½“æ¥è¯´ï¼ŒCache Managerç»´æŠ¤äº†ä¸€ä¸ªMappingæ˜ å°„å­—å…¸ï¼Œå­—å…¸çš„Keyæ˜¯é€»è¾‘è®¡åˆ’ï¼ŒValueæ˜¯å¯¹åº”çš„Cacheå…ƒä¿¡æ¯ã€‚</p><p>å½“Catalystå°è¯•å¯¹é€»è¾‘è®¡åˆ’åšä¼˜åŒ–æ—¶ï¼Œä¼šå…ˆå°è¯•å¯¹Cache ManageræŸ¥æ‰¾ï¼Œçœ‹çœ‹å½“å‰çš„é€»è¾‘è®¡åˆ’æˆ–æ˜¯é€»è¾‘è®¡åˆ’åˆ†æ”¯ï¼Œæ˜¯å¦å·²ç»è¢«è®°å½•åœ¨Cache Managerçš„å­—å…¸é‡Œã€‚å¦‚æœåœ¨å­—å…¸ä¸­å¯ä»¥æŸ¥åˆ°å½“å‰è®¡åˆ’æˆ–æ˜¯åˆ†æ”¯ï¼ŒCatalystå°±ç”¨InMemoryRelationèŠ‚ç‚¹æ¥æ›¿æ¢æ•´ä¸ªè®¡åˆ’æˆ–æ˜¯è®¡åˆ’çš„ä¸€éƒ¨åˆ†ï¼Œä»è€Œå……åˆ†åˆ©ç”¨å·²æœ‰çš„ç¼“å­˜æ•°æ®åšä¼˜åŒ–ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¸»è¦æ¢è®¨äº†Catalystä¼˜åŒ–å™¨çš„é€»è¾‘ä¼˜åŒ–é˜¶æ®µã€‚è¿™ä¸ªé˜¶æ®µåŒ…å«ä¸¤ä¸ªç¯èŠ‚ï¼šé€»è¾‘è®¡åˆ’è§£æå’Œé€»è¾‘è®¡åˆ’ä¼˜åŒ–ã€‚</p><p>åœ¨é€»è¾‘è®¡åˆ’è§£æç¯èŠ‚ï¼ŒCatalystç»“åˆSchemaä¿¡æ¯ï¼Œå¯¹äºä»…ä»…è®°å½•è¯­å¥å­—ç¬¦ä¸²çš„Unresolved Logical Planï¼ŒéªŒè¯è¡¨åã€å­—æ®µåä¸å®é™…æ•°æ®çš„ä¸€è‡´æ€§ã€‚è§£æåçš„æ‰§è¡Œè®¡åˆ’ç§°ä¸ºAnalyzed Logical Planã€‚</p><p>åœ¨é€»è¾‘è®¡åˆ’ä¼˜åŒ–ç¯èŠ‚ï¼ŒCatalystä¼šåŒæ—¶åˆ©ç”¨3æ–¹é¢çš„åŠ›é‡ä¼˜åŒ–Analyzed Logical Planï¼Œåˆ†åˆ«æ˜¯AQEã€Cache Managerå’Œå¯å‘å¼çš„è§„åˆ™ã€‚å®ƒä»¬å½“ä¸­ï¼ŒCatalystæœ€å€šé‡çš„æ˜¯å¯å‘å¼çš„è§„åˆ™ã€‚</p><p>å°½ç®¡å¯å‘å¼çš„è§„åˆ™å¤šè¾¾81é¡¹ï¼Œä½†æˆ‘ä»¬æŠŠå®ƒä»¬å½’çº³ä¸º3å¤§èŒƒç•´ï¼šè°“è¯ä¸‹æ¨ã€åˆ—å‰ªè£å’Œå¸¸é‡æ›¿æ¢ã€‚æˆ‘ä»¬è¦é‡ç‚¹æŒæ¡è°“è¯ä¸‹æ¨å’Œåˆ—å‰ªè£ï¼Œå®ƒä»¬çš„ä¼˜åŒ–åŠ¨æœºå’Œâ€œèƒ½çœåˆ™çœâ€çš„å¼€å‘åŸåˆ™ä¸€æ ·ï¼Œæ ¸å¿ƒæ€æƒ³éƒ½æ˜¯ç”¨å°½ä¸€åˆ‡åŠæ³•ï¼Œå‡å°‘éœ€è¦æ‰«æå’Œå¤„ç†çš„æ•°æ®é‡ï¼Œé™ä½åç»­è®¡ç®—çš„è´Ÿè½½ã€‚</p><p>é’ˆå¯¹æ‰€æœ‰çš„ä¼˜åŒ–è§„åˆ™ï¼ŒCatalystä¼˜åŒ–å™¨ä¼šé€šè¿‡è°ƒç”¨TreeNodeä¸­çš„transformDowné«˜é˜¶å‡½æ•°ï¼Œåˆ†åˆ«æŠŠå®ƒä»¬ä½œç”¨åˆ°é€»è¾‘è®¡åˆ’çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œç›´åˆ°é€»è¾‘è®¡åˆ’çš„ç»“æ„ä¸å†æ”¹å˜ä¸ºæ­¢ï¼Œè¿™ä¸ªæ—¶å€™ç”Ÿæˆçš„é€»è¾‘è®¡åˆ’å°±æ˜¯Optimized Logical Planã€‚</p><p>æœ€åï¼ŒCache Managerçš„ä½œç”¨æ˜¯æä¾›é€»è¾‘è®¡åˆ’ä¸æ•°æ®ç¼“å­˜çš„æ˜ å°„å…³ç³»ï¼Œå½“ç°æœ‰é€»è¾‘è®¡åˆ’æˆ–æ˜¯åˆ†æ”¯å‡ºç°åœ¨Cache Managerç»´æŠ¤çš„æ˜ å°„å­—å…¸çš„æ—¶å€™ï¼ŒCatalystå¯ä»¥å……åˆ†åˆ©ç”¨å·²æœ‰çš„ç¼“å­˜æ•°æ®æ¥ä¼˜åŒ–ã€‚</p><h2>æ¯æ—¥ä¸€ç»ƒ</h2><ol>\n<li>æ—¢ç„¶Catalyståœ¨é€»è¾‘ä¼˜åŒ–é˜¶æ®µæœ‰81æ¡ä¼˜åŒ–è§„åˆ™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦éµå¾ªâ€œèƒ½çœåˆ™çœã€èƒ½æ‹–åˆ™æ‹–â€çš„å¼€å‘åŸåˆ™å—ï¼Ÿ</li>\n<li>ä½ èƒ½è¯´è¯´Sparkä¸ºä»€ä¹ˆç”¨åå‡½æ•°ï¼Œè€Œä¸æ˜¯æ™®é€šå‡½æ•°æ¥å®šä¹‰Catalystçš„ä¼˜åŒ–è§„åˆ™å—ï¼Ÿ</li>\n</ol><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ï¼</p>","neighbors":{"left":{"article_title":"20 | RDDå’ŒDataFrameï¼šæ—¢ç”Ÿç‘œï¼Œä½•ç”Ÿäº®ï¼Ÿ","id":367807},"right":{"article_title":"22 | Catalystç‰©ç†è®¡åˆ’ï¼šä½ çš„SQLè¯­å¥æ˜¯æ€ä¹ˆè¢«ä¼˜åŒ–çš„ï¼ˆä¸‹ï¼‰ï¼Ÿ","id":369519}},"comments":[{"had_liked":false,"id":290868,"user_name":"kingcall","can_delete":false,"product_type":"c1","uid":1056982,"ip_address":"","ucode":"508884DC684B5B","user_header":"https://static001.geekbang.org/account/avatar/00/10/20/d6/b9513db0.jpg","comment_is_top":false,"comment_ctime":1619794474,"is_pvip":false,"replies":[{"id":"105414","content":"Perfect x 2ï¼æ ‡å‡†ç­”æ¡ˆäº†~ ğŸ’¯<br><br>å›ç­”çš„éå¸¸å¥½äº†ï¼Œæ— å¯æŒ‘å‰”~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619862029,"ip_address":"","comment_id":290868,"utype":1}],"discussion_count":3,"race_medal":0,"score":"117583911466","product_id":100073401,"comment_content":"é—®é¢˜1ï¼šå¼€å‘é˜¶æ®µè¦æœ‰æå®¢ç²¾ç¥ï¼Œå°½é‡å°†ä¼˜åŒ–å®ç°åœ¨è‡ªå·±çš„ä»£ç é‡Œï¼Œè€Œä¸æ˜¯ä¾èµ–æ¡†æ¶ï¼Œå› ä¸ºæ¡†æ¶æ˜¯ä¸€ä¸ªæ™®ä¸–çš„ä¼˜åŒ–ï¼Œè¿˜æœ‰å°±æ˜¯å¦‚æœæˆ‘ä»¬æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è¿›è¡Œäº†ä¼˜åŒ–å†åŠ ä¸Šæ¡†æ¶æœ¬èº«å¸¦æ¥çš„ä¼˜åŒ–èƒ½ç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸€ä¸ªæ›´å¥½çš„æ€§èƒ½æå‡,ä¹Ÿå°±æ˜¯è¯´ä¸Šå±‚è‡ªæˆ‘ä¼˜åŒ–å’Œåº•å±‚æ¡†æ¶ä¼˜åŒ–ã€‚<br>é—®é¢˜2ï¼šä¸åå‡½æ•°å¯¹åº”çš„ä¸€ä¸ªå®šä¹‰å°±æ˜¯æˆ‘ä»¬æ•°å­¦æ„ä¹‰ä¸Šçš„å‡½æ•°ï¼Œä¸€ä¸ªè¾“å…¥è‡ªå˜é‡xå¯¹åº”ä¸€ä¸ªè¾“å‡ºå› å˜é‡yï¼Œä¹Ÿå°±æ˜¯y å¯ä»¥è¡¨ç¤ºæˆx çš„ä¸€ä¸ªç‰¹å®šçš„è¿ç®—ï¼Œå¹¶ä¸”è¿™ä¸ªè¿ç®—å…³ç³»æ˜¯ç¡®å®šçš„ï¼Œä½†æ˜¯scala ä¸­çš„åå‡½æ•°å®ƒè¡¨ç¤ºçš„æ˜¯ä¸€ç§åŒ¹é…å…³ç³»ï¼Œæœ‰ç‚¹ç±»ä¼¼if else if ... else ï¼Œåªæœ‰åŒ¹é…ä¸Šäº†æ‰æœ‰å¯¹åº”çš„å€¼ï¼Œå¦åˆ™è¾“å‡ºçš„å°±æ˜¯é»˜è®¤å€¼<br>Spark ä¹‹æ‰€ä»¥ç”¨åå‡½æ•°ï¼Œè€Œä¸æ˜¯æ™®é€šå‡½æ•°æ¥å®šä¹‰ Catalyst çš„ä¼˜åŒ–è§„åˆ™ï¼Œæ˜¯å› ä¸ºè§„åˆ™æ˜¯é¢„å…ˆå®šä¹‰çš„ï¼Œä¸å¯èƒ½æ»¡è¶³æ‰€æœ‰çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå…œåº•ï¼Œè€Œè¿™æ­£å¥½æ»¡è¶³åå‡½æ•°çš„ç‰¹ç‚¹ã€‚<br>","like_count":28,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519302,"discussion_content":"Perfect x 2ï¼æ ‡å‡†ç­”æ¡ˆäº†~ ğŸ’¯\n\nå›ç­”çš„éå¸¸å¥½äº†ï¼Œæ— å¯æŒ‘å‰”~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619862029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2188142,"avatar":"https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg","nickname":"Zå®‡é”¤é”¤","note":"","ucode":"7DB36E986A7A51","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371780,"discussion_content":"ä¸ºå•¥å¤§ç‰›è¿™ä¹ˆå¤š","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1619966787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2068627,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/90/93/5e94be87.jpg","nickname":"é’æ„Ÿ","note":"","ucode":"50FE1DD4EAEB78","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2188142,"avatar":"https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg","nickname":"Zå®‡é”¤é”¤","note":"","ucode":"7DB36E986A7A51","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":404848,"discussion_content":"åŠ æ²¹ï¼ï¼ä»¥åä½ ä¹Ÿä¼šæ˜¯å¤§ç‰›","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1634436352,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":371780,"ip_address":""},"score":404848,"extra":""}]}]},{"had_liked":false,"id":290743,"user_name":"jerry guo","can_delete":false,"product_type":"c1","uid":1267753,"ip_address":"","ucode":"179943AFCB93F8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo2GMhevabZrjINs2TKvIeGC7TJkicNlLvqTticuM5KL8ZN80OC2CnrsUyzPcZXO4uptj4Q1S4jT2lQ/132","comment_is_top":false,"comment_ctime":1619714637,"is_pvip":true,"replies":[{"id":"105418","content":"ç¬¬äºŒé¢˜åˆ†æçš„å¾ˆåˆ°ä½ï¼Œå°±æ˜¯ä½ è¯´çš„è¿™ä¹ˆå›äº‹ã€‚åå‡½æ•°çš„ç‰¹æ€§ï¼Œåˆšå¥½ç¬¦åˆSpark SQLä¼˜åŒ–è§„åˆ™çš„ç‰¹ç‚¹ï¼Œä¹Ÿå°±æ˜¯ï¼š<br>1. ä¸å®Œå¤‡<br>2. ä¿æŒæ‰©å±•çš„çµæ´»æ€§<br><br>é—®é¢˜ä¸‰æ˜¯ä¸ªè¶…çº§å¥½çš„é—®é¢˜ï¼Œå…¶å®æˆ‘ä¸€ç›´æƒ³æ‰¾æœºä¼šè¯´è¯´ã€‚åœ¨ä¼ ç»Ÿçš„DBMSé‡Œï¼ŒCBOæ˜¯ä¸»æµï¼ŒRBOæ˜¯è¾…åŠ©æ€§çš„ã€‚åŸå› å…¶å®å¾ˆç®€å•ï¼ŒRBOæ¯•ç«Ÿæ˜¯å‡ºäºå¯å‘å¼çš„ï¼Œéƒ½æ˜¯ä¸€äº›â€œç»éªŒä¸»ä¹‰â€ï¼ŒCBOæ‰æ˜¯çœŸæ­£â€œå°Šé‡â€äº‹å®ã€å°Šé‡è¿è¡Œæ—¶çš„ä¼˜åŒ–ç­–ç•¥ã€‚åœ¨ä¼ ç»ŸDBMSé‡Œé¢ï¼ŒCBOæ˜¯éå¸¸æˆç†Ÿçš„æŠ€æœ¯äº†ï¼Œå·²ç»æ²¿ç”¨å¾ˆå¤šå¾ˆå¤šå¹´äº†ã€‚<br><br>ç„¶è€Œï¼ŒSpark SQLçš„CBOç›¸å¯¹å°±æ¯”è¾ƒé¸¡è‚‹äº†ï¼ŒåŸå› å…¶å®æˆ‘åœ¨ç¬¬24è®²ä¼šè¯¦ç»†å±•å¼€ï¼Œæå‰å‰§é€ä¸€ä¸‹ï¼Œå°±æ˜¯Spark SQLçš„CBOæœ‰ä¸‰ä¸ªéå¸¸å¤§çš„ç—›ç‚¹ï¼šçª„ã€æ…¢ã€é™<br><br>çª„ï¼šçª„æŒ‡çš„æ˜¯é€‚ç”¨é¢å¤ªçª„ï¼ŒCBOä»…æ”¯æŒæ³¨å†Œåˆ°Hive Metastoreçš„æ•°æ®è¡¨ï¼Œä½†åœ¨å¤§é‡çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæ•°æ®æºå¾€å¾€æ˜¯å­˜å‚¨åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„å„ç±»æ–‡ä»¶ï¼Œå¦‚Parquetã€ORCã€CSVç­‰ç­‰ã€‚<br><br>æ…¢ï¼šæ…¢æŒ‡çš„æ˜¯ç»Ÿè®¡ä¿¡æ¯çš„æœé›†æ•ˆç‡æ¯”è¾ƒä½ã€‚å¯¹äºæ³¨å†Œåˆ°Hive Metastoreçš„æ•°æ®è¡¨ï¼Œå¼€å‘è€…éœ€è¦è°ƒç”¨ANALYZE TABLE COMPUTE STATISTICSè¯­å¥æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼Œè€Œå„ç±»ä¿¡æ¯çš„æ”¶é›†ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´ã€‚<br><br>é™ï¼šé™æŒ‡çš„æ˜¯é™æ€ä¼˜åŒ–ï¼Œè¿™ä¸€ç‚¹ä¸RBOä¸€æ ·ã€‚CBOç»“åˆå„ç±»ç»Ÿè®¡ä¿¡æ¯åˆ¶å®šæ‰§è¡Œè®¡åˆ’ï¼Œä¸€æ—¦æ‰§è¡Œè®¡åˆ’äº¤ä»˜è¿è¡Œï¼ŒCBOçš„ä½¿å‘½å°±ç®—å®Œæˆäº†ã€‚è¿™ä¸€ç‚¹å’Œä¼ ç»ŸDBMSå¾ˆä¸åŒï¼Œä¼ ç»ŸDBMSçš„CBOæ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åšé€‚å½“è°ƒæ•´ã€‚<br><br>ä¸ä»…å¦‚æ­¤ï¼Œç›®å‰Spark SQLçš„CBOï¼Œè¿˜ä»…ä»…æ”¯æŒJoinç­–ç•¥ï¼Œæ¢å¥è¯è¯´ï¼Œä¸Joinæ— å…³çš„æŸ¥è¯¢ï¼ŒCBOä½¿ä¸ä¸ŠåŠ²ã€‚<br><br>å› æ­¤ï¼Œç»¼ä¸Šï¼ŒCBOè™½ç„¶æ˜¯ä¸ªéå¸¸å¸å¼•äººçš„ä¸œè¥¿ï¼Œä½†æ˜¯Spark SQLçš„CBOå¾ˆé¸¡è‚‹ï¼Œå½“ç„¶è¿™æœ‰å¾ˆå¤šåŸå› ï¼Œæ¯”å¦‚CBOæœ¬èº«çš„é™åˆ¶ï¼Œç¤¾åŒºå¯¹äºSpark SQLä¼˜åŒ–æ–¹å‘çš„è€ƒè™‘ï¼Œç­‰ç­‰ã€‚å…¶å®AQEçš„æ¨å‡ºï¼Œå°±è¡¨ç¤ºSparkç¤¾åŒºå·²ç»åšå‡ºäº†é€‰æ‹©ã€‚å°±æˆ‘ä¸ªäººè§‚å¯Ÿï¼ˆä»…ä»£è¡¨ä¸ªäººè§‚ç‚¹å“ˆï¼‰ï¼ŒCBOçš„åœ°ä½å’Œè§’è‰²å¯èƒ½ä¼šè¶Šæ¥è¶Šå°´å°¬ï¼Œç”¨æ­¦ä¹‹åœ°å¯èƒ½ä¼šè¶Šæ¥è¶Šå°ï¼ŒèŠèƒœäºæ— ã€‚å½“ç„¶ï¼Œå†æ¬¡é‡ç”³ï¼Œè¿™ä»…ä»…æ˜¯æˆ‘ä¸ªäººçš„è§‚ç‚¹å“ˆ~<br><br>å¦å¤–ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜kingcallåŒå­¦å›ç­”çš„æ¯”è¾ƒå¥½ï¼Œå¯ä»¥å‚è€ƒä»–çš„ç­”æ¡ˆå“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619864234,"ip_address":"","comment_id":290743,"utype":1}],"discussion_count":3,"race_medal":0,"score":"23094551117","product_id":100073401,"comment_content":"1. æ—¢ç„¶ Catalyst åœ¨é€»è¾‘ä¼˜åŒ–é˜¶æ®µæœ‰ 81 æ¡ä¼˜åŒ–è§„åˆ™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦éµå¾ªâ€œèƒ½çœåˆ™çœã€èƒ½æ‹–åˆ™æ‹–â€çš„å¼€å‘åŸåˆ™å—ï¼Ÿä½ èƒ½è¯´è¯´ Spark ä¸ºä»€ä¹ˆç”¨åå‡½æ•°ï¼Œè€Œä¸æ˜¯æ™®é€šå‡½æ•°æ¥å®šä¹‰ Catalyst çš„ä¼˜åŒ–è§„åˆ™å—ï¼Ÿ<br>ç­”ï¼šè¦ã€‚æˆ˜ç•¥ä¸Šç”¨å¼€å‘åŸåˆ™ï¼Œæˆ˜æœ¯ä¸Šä¾èµ–Catalystã€‚<br><br>2.ä½ èƒ½è¯´è¯´ Spark ä¸ºä»€ä¹ˆç”¨åå‡½æ•°ï¼Œè€Œä¸æ˜¯æ™®é€šå‡½æ•°æ¥å®šä¹‰ Catalyst çš„ä¼˜åŒ–è§„åˆ™å—ï¼Ÿ<br>ç­”ï¼šç½‘ä¸Šæœåˆ°ä¸€ç¯‡æ–‡ç« <br>&quot;The pattern matching expression that is passed to transform is a partial function, meaning that it only needs to match to a subset of all possible input trees. Catalyst will tests which parts of a tree a given rule applies to, automatically skipping over and descending into subtrees that do not match. This ability means that rules only need to reason about the trees where a given optimization applies and not those that do not match. Thus, rules do not need to be modified as new types of operators are added to the system.&quot; è¿™æ®µä¸æ˜¯å¾ˆæ‡‚ï¼Œå¤§æ¦‚æ„æ€æ˜¯å› ä¸ºåå‡½æ•°æ²¡æœ‰åŒ…æ‹¬æ‰€æœ‰çš„æƒ…å†µï¼Œæ‰€ä»¥æ­£å¥½ï¼Œç¬¦åˆå®šä¹‰çš„ruleå°±ä¼˜åŒ–ï¼Œä¸ç¬¦åˆå°±ä¸å¤„ç†ï¼Œè¿™æ ·å­æ¯”è¾ƒçœäº‹ï¼›å¦å¤–ç”±äºä¸€å¼€å§‹æ²¡æœ‰å®Œå…¨å®šä¹‰å‡ºå…¨éƒ¨çš„æƒ…å†µï¼ˆå¯èƒ½ä¹Ÿå®šä¹‰ä¸å‡ºæ¥ï¼‰ï¼Œæ‰€ä»¥è¿™ä¹Ÿæœ‰ä¸€å®šçš„çµæ´»æ€§ï¼Œå†æ–°åŠ äº†operatorä¹‹åï¼Œä¹Ÿä¸éœ€è¦æ”¹ruleäº†ã€‚æœ›è€å¸ˆæŒ‡ç‚¹ã€‚ <br><br>3. å¦å¤–æˆ‘æœ‰ä¸ªé—®é¢˜ï¼ŒRDBMSçš„SQLä¼˜åŒ–å¾ˆæ—©ä¹‹å‰æ˜¯åŸºäºRuleï¼Œåé¢å˜æˆäº†åŸºäºCostã€‚æ ¹æ®æœ¬ç¯‡çš„è®²è§£ï¼ŒCatalystå’ŒTunsgenï¼Œéƒ½æ˜¯åŸºäºRuleçš„ï¼Œç½‘ä¸Šæœç´¢äº†ä¸€ä¸‹ï¼ŒCatalystä¹Ÿå¯ä»¥åŸºäºcostã€‚è€å¸ˆå¯ä»¥è®²è®²å¯¹CBOçš„çœ‹æ³•å—ï¼Ÿæ¯”å¦‚CBOå¦‚ä½•å’ŒCatalystï¼ŒTusgenä¸€èµ·å·¥ä½œï¼Ÿæˆ–è€…ä»¥åCBOä¼šå˜æˆä¸»æµå—ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519278,"discussion_content":"ç¬¬äºŒé¢˜åˆ†æçš„å¾ˆåˆ°ä½ï¼Œå°±æ˜¯ä½ è¯´çš„è¿™ä¹ˆå›äº‹ã€‚åå‡½æ•°çš„ç‰¹æ€§ï¼Œåˆšå¥½ç¬¦åˆSpark SQLä¼˜åŒ–è§„åˆ™çš„ç‰¹ç‚¹ï¼Œä¹Ÿå°±æ˜¯ï¼š\n1. ä¸å®Œå¤‡\n2. ä¿æŒæ‰©å±•çš„çµæ´»æ€§\n\né—®é¢˜ä¸‰æ˜¯ä¸ªè¶…çº§å¥½çš„é—®é¢˜ï¼Œå…¶å®æˆ‘ä¸€ç›´æƒ³æ‰¾æœºä¼šè¯´è¯´ã€‚åœ¨ä¼ ç»Ÿçš„DBMSé‡Œï¼ŒCBOæ˜¯ä¸»æµï¼ŒRBOæ˜¯è¾…åŠ©æ€§çš„ã€‚åŸå› å…¶å®å¾ˆç®€å•ï¼ŒRBOæ¯•ç«Ÿæ˜¯å‡ºäºå¯å‘å¼çš„ï¼Œéƒ½æ˜¯ä¸€äº›â€œç»éªŒä¸»ä¹‰â€ï¼ŒCBOæ‰æ˜¯çœŸæ­£â€œå°Šé‡â€äº‹å®ã€å°Šé‡è¿è¡Œæ—¶çš„ä¼˜åŒ–ç­–ç•¥ã€‚åœ¨ä¼ ç»ŸDBMSé‡Œé¢ï¼ŒCBOæ˜¯éå¸¸æˆç†Ÿçš„æŠ€æœ¯äº†ï¼Œå·²ç»æ²¿ç”¨å¾ˆå¤šå¾ˆå¤šå¹´äº†ã€‚\n\nç„¶è€Œï¼ŒSpark SQLçš„CBOç›¸å¯¹å°±æ¯”è¾ƒé¸¡è‚‹äº†ï¼ŒåŸå› å…¶å®æˆ‘åœ¨ç¬¬24è®²ä¼šè¯¦ç»†å±•å¼€ï¼Œæå‰å‰§é€ä¸€ä¸‹ï¼Œå°±æ˜¯Spark SQLçš„CBOæœ‰ä¸‰ä¸ªéå¸¸å¤§çš„ç—›ç‚¹ï¼šçª„ã€æ…¢ã€é™\n\nçª„ï¼šçª„æŒ‡çš„æ˜¯é€‚ç”¨é¢å¤ªçª„ï¼ŒCBOä»…æ”¯æŒæ³¨å†Œåˆ°Hive Metastoreçš„æ•°æ®è¡¨ï¼Œä½†åœ¨å¤§é‡çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæ•°æ®æºå¾€å¾€æ˜¯å­˜å‚¨åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„å„ç±»æ–‡ä»¶ï¼Œå¦‚Parquetã€ORCã€CSVç­‰ç­‰ã€‚\n\næ…¢ï¼šæ…¢æŒ‡çš„æ˜¯ç»Ÿè®¡ä¿¡æ¯çš„æœé›†æ•ˆç‡æ¯”è¾ƒä½ã€‚å¯¹äºæ³¨å†Œåˆ°Hive Metastoreçš„æ•°æ®è¡¨ï¼Œå¼€å‘è€…éœ€è¦è°ƒç”¨ANALYZE TABLE COMPUTE STATISTICSè¯­å¥æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼Œè€Œå„ç±»ä¿¡æ¯çš„æ”¶é›†ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´ã€‚\n\né™ï¼šé™æŒ‡çš„æ˜¯é™æ€ä¼˜åŒ–ï¼Œè¿™ä¸€ç‚¹ä¸RBOä¸€æ ·ã€‚CBOç»“åˆå„ç±»ç»Ÿè®¡ä¿¡æ¯åˆ¶å®šæ‰§è¡Œè®¡åˆ’ï¼Œä¸€æ—¦æ‰§è¡Œè®¡åˆ’äº¤ä»˜è¿è¡Œï¼ŒCBOçš„ä½¿å‘½å°±ç®—å®Œæˆäº†ã€‚è¿™ä¸€ç‚¹å’Œä¼ ç»ŸDBMSå¾ˆä¸åŒï¼Œä¼ ç»ŸDBMSçš„CBOæ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åšé€‚å½“è°ƒæ•´ã€‚\n\nä¸ä»…å¦‚æ­¤ï¼Œç›®å‰Spark SQLçš„CBOï¼Œè¿˜ä»…ä»…æ”¯æŒJoinç­–ç•¥ï¼Œæ¢å¥è¯è¯´ï¼Œä¸Joinæ— å…³çš„æŸ¥è¯¢ï¼ŒCBOä½¿ä¸ä¸ŠåŠ²ã€‚\n\nå› æ­¤ï¼Œç»¼ä¸Šï¼ŒCBOè™½ç„¶æ˜¯ä¸ªéå¸¸å¸å¼•äººçš„ä¸œè¥¿ï¼Œä½†æ˜¯Spark SQLçš„CBOå¾ˆé¸¡è‚‹ï¼Œå½“ç„¶è¿™æœ‰å¾ˆå¤šåŸå› ï¼Œæ¯”å¦‚CBOæœ¬èº«çš„é™åˆ¶ï¼Œç¤¾åŒºå¯¹äºSpark SQLä¼˜åŒ–æ–¹å‘çš„è€ƒè™‘ï¼Œç­‰ç­‰ã€‚å…¶å®AQEçš„æ¨å‡ºï¼Œå°±è¡¨ç¤ºSparkç¤¾åŒºå·²ç»åšå‡ºäº†é€‰æ‹©ã€‚å°±æˆ‘ä¸ªäººè§‚å¯Ÿï¼ˆä»…ä»£è¡¨ä¸ªäººè§‚ç‚¹å“ˆï¼‰ï¼ŒCBOçš„åœ°ä½å’Œè§’è‰²å¯èƒ½ä¼šè¶Šæ¥è¶Šå°´å°¬ï¼Œç”¨æ­¦ä¹‹åœ°å¯èƒ½ä¼šè¶Šæ¥è¶Šå°ï¼ŒèŠèƒœäºæ— ã€‚å½“ç„¶ï¼Œå†æ¬¡é‡ç”³ï¼Œè¿™ä»…ä»…æ˜¯æˆ‘ä¸ªäººçš„è§‚ç‚¹å“ˆ~\n\nå¦å¤–ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜kingcallåŒå­¦å›ç­”çš„æ¯”è¾ƒå¥½ï¼Œå¯ä»¥å‚è€ƒä»–çš„ç­”æ¡ˆå“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619864234,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1476427,"avatar":"https://static001.geekbang.org/account/avatar/00/16/87/4b/16ea3997.jpg","nickname":"tiankonghewo","note":"","ucode":"7A55A9C17DD9DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532449,"discussion_content":"æ¶¨çŸ¥è¯†äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637597650,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1168504,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d4/78/66b3f2a2.jpg","nickname":"æ–¯ç›–ä¸¸","note":"","ucode":"B881D14B028F14","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371354,"discussion_content":"Sparké€»è¾‘æ‰§è¡Œåçš„ç‰©ç†æ‰§è¡Œè®¡åˆ’ï¼Œå®ƒçš„ä¼˜åŒ–å°±æ˜¯åŸºäºcostçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619745764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291690,"user_name":"è¾°","can_delete":false,"product_type":"c1","uid":2172635,"ip_address":"","ucode":"2E898EAC5AA141","user_header":"https://static001.geekbang.org/account/avatar/00/21/26/db/27724a6f.jpg","comment_is_top":false,"comment_ctime":1620436091,"is_pvip":false,"replies":[{"id":"105656","content":"Projectæ˜¯æŠ•å½±çš„æ„æ€ï¼Œå®é™…ä¸Šå¯¹åº”çš„å°±æ˜¯ä½ SQLæˆ–æ˜¯DataFrameä¸­çš„selectè¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¼—å¤šçš„æ•°æ®åˆ—ä¸­ï¼Œä½ è¦â€œæŠ•å½±â€å‡ºå“ªäº›åˆ—ï¼Œè¯´ç™½äº†ï¼Œå°±æ˜¯é€‰å‡ºå“ªäº›åˆ—ã€‚<br><br>Projectä¹Ÿä¼šï¼ŒSelectä¹Ÿå¥½ï¼Œæœ¬èº«éƒ½ä¸æ˜¯ç®—å­å“ˆï¼Œä¸ç®¡æ˜¯SQLæŸ¥è¯¢ï¼Œè¿˜æ˜¯DSLæŸ¥è¯¢ï¼Œéƒ½éœ€è¦showã€countã€saveç­‰actionç®—å­æ¥è§¦å‘è®¡ç®—ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1620468710,"ip_address":"","comment_id":291690,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14505337979","product_id":100073401,"comment_content":"è€å¸ˆï¼Œæ‰§è¡Œè®¡åˆ’ä¸­çš„projectæ˜¯ä»€ä¹ˆæ„æ€å•Šï¼Œå¤§æ¦‚çŸ¥é“æ˜¯å’Œæ˜ å°„çš„å…³ç³»ï¼Œå¯ä¸å¯ä»¥ç†è§£æˆç›¸å½“äºactionç®—å­ä¸€æ ·","like_count":3,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519543,"discussion_content":"Projectæ˜¯æŠ•å½±çš„æ„æ€ï¼Œå®é™…ä¸Šå¯¹åº”çš„å°±æ˜¯ä½ SQLæˆ–æ˜¯DataFrameä¸­çš„selectè¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¼—å¤šçš„æ•°æ®åˆ—ä¸­ï¼Œä½ è¦â€œæŠ•å½±â€å‡ºå“ªäº›åˆ—ï¼Œè¯´ç™½äº†ï¼Œå°±æ˜¯é€‰å‡ºå“ªäº›åˆ—ã€‚\n\nProjectä¹Ÿä¼šï¼ŒSelectä¹Ÿå¥½ï¼Œæœ¬èº«éƒ½ä¸æ˜¯ç®—å­å“ˆï¼Œä¸ç®¡æ˜¯SQLæŸ¥è¯¢ï¼Œè¿˜æ˜¯DSLæŸ¥è¯¢ï¼Œéƒ½éœ€è¦showã€countã€saveç­‰actionç®—å­æ¥è§¦å‘è®¡ç®—ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620468710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291557,"user_name":"miniå¸Œ","can_delete":false,"product_type":"c1","uid":1043539,"ip_address":"","ucode":"54DFFE0CE0C7EF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/53/dcec6fdc.jpg","comment_is_top":false,"comment_ctime":1620361328,"is_pvip":true,"replies":[{"id":"105619","content":"å¯¹ï¼Œä½ è¯´çš„æ²¡é”™ï¼Œç¡®å®åªæœ‰åˆ—å­˜æ‰èƒ½ä»åˆ—å‰ªè£å—ç›Šï¼Œè¡Œå­˜ä¸è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1620397141,"ip_address":"","comment_id":291557,"utype":1}],"discussion_count":1,"race_medal":4,"score":"14505263216","product_id":100073401,"comment_content":"è€å¸ˆå¥½ï¼Œé’ˆå¯¹åˆ—å‰ªè£æ˜¯å¦åªæœ‰åˆ—å¼çš„å­˜å‚¨æ‰èƒ½äº«å—åˆ°æ‰«æçš„ä¼˜åŒ–æ•ˆæœï¼Œè¡Œå­˜è¿˜æ˜¯ä¼šæ‰«ææ•´è¡Œæ‰€æœ‰å­—æ®µï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519506,"discussion_content":"å¯¹ï¼Œä½ è¯´çš„æ²¡é”™ï¼Œç¡®å®åªæœ‰åˆ—å­˜æ‰èƒ½ä»åˆ—å‰ªè£å—ç›Šï¼Œè¡Œå­˜ä¸è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620397141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290916,"user_name":"å¯¹æ–¹æ­£åœ¨è¾“å…¥ã€‚ã€‚ã€‚","can_delete":false,"product_type":"c1","uid":1179298,"ip_address":"","ucode":"7B0DEB4D9B43D2","user_header":"https://static001.geekbang.org/account/avatar/00/11/fe/a2/5252a278.jpg","comment_is_top":false,"comment_ctime":1619858925,"is_pvip":false,"replies":[{"id":"105408","content":"å“ˆå“ˆå“ˆï¼Œå–œæ¬¢å°±å¥½~ å…„å¼Ÿäº”ä¸€èŠ‚å¿«ä¹~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619860449,"ip_address":"","comment_id":290916,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10209793517","product_id":100073401,"comment_content":"è€å¸ˆçš„è¯¾ï¼Œæˆ‘æ˜¯è¶Šçœ‹è¶Šçˆ½ï¼Œçœ‹å®Œå°±æœ‰ä¸€ç§â€œè€å­å¤©ä¸‹æ— æ•Œäº†â€çš„æ„Ÿè§‰ï¼Œå“ˆå“ˆå“ˆå“ˆå“ˆ","like_count":2,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519322,"discussion_content":"å“ˆå“ˆå“ˆï¼Œå–œæ¬¢å°±å¥½~ å…„å¼Ÿäº”ä¸€èŠ‚å¿«ä¹~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619860449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306805,"user_name":"å†œå¤«ä¸‰æ‹³","can_delete":false,"product_type":"c1","uid":1529153,"ip_address":"","ucode":"9778194A7CD44E","user_header":"https://static001.geekbang.org/account/avatar/00/17/55/41/b68df312.jpg","comment_is_top":false,"comment_ctime":1628731010,"is_pvip":false,"replies":[{"id":"111185","content":"å¥½é—®é¢˜~ å°±Spark SQLç›®å‰çš„å®ç°æ¥çœ‹ï¼Œå®ƒæ˜¯åœ¨Analyzed Logical Planä¹‹ä¸Šåšçš„è¿™ä¸€æ­¥ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ä½ è¯´çš„â€œä¼˜åŒ–å‰â€é˜¶æ®µã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1628837298,"ip_address":"","comment_id":306805,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5923698306","product_id":100073401,"comment_content":"è€å¸ˆ æƒ³é—®ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªç¼“å­˜æ˜¯æ ¹æ® æŸ¥è¯¢æ ‘æˆ–è€…æŸ¥è¯¢æ ‘çš„ä¸€éƒ¨åˆ†ä½œä¸ºkeyï¼Œè¿›è¡Œç¼“å­˜ï¼ŒåŒ¹é…åˆ°äº† å°±æ›¿æ¢å½“å‰èŠ‚ç‚¹æˆ–è€…æ•´æ£µæ ‘ã€‚  è¯·é—®ä¸‹ è¿™ä¸ªç¼“å­˜æ˜¯é’ˆå¯¹å“ªä¸ªé˜¶æ®µçš„æŸ¥è¯¢æ ‘å‘¢ï¼Ÿæ˜¯  è§£æï¼Œä¼˜åŒ–å‰ï¼Œä¼˜åŒ–åï¼Œè¿˜æ˜¯ç‰©ç†è®¡åˆ’é˜¶æ®µï¼Ÿ  æˆ‘ä¸ªäººç†è§£æ˜¯ä¼˜åŒ–åé˜¶æ®µã€‚","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524925,"discussion_content":"å¥½é—®é¢˜~ å°±Spark SQLç›®å‰çš„å®ç°æ¥çœ‹ï¼Œå®ƒæ˜¯åœ¨Analyzed Logical Planä¹‹ä¸Šåšçš„è¿™ä¸€æ­¥ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ä½ è¯´çš„â€œä¼˜åŒ–å‰â€é˜¶æ®µã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628837298,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2028277,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","nickname":"Unknown element","note":"","ucode":"34A129800D0238","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544535,"discussion_content":"ä¸åº”è¯¥æ˜¯ä¼˜åŒ–åå—ã€‚ã€‚è€å¸ˆæ˜¯ä¸æ˜¯æ‰“é”™äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641553007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":291346,"user_name":"aof","can_delete":false,"product_type":"c1","uid":1062864,"ip_address":"","ucode":"5815D63C4926BC","user_header":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","comment_is_top":false,"comment_ctime":1620221499,"is_pvip":false,"replies":[{"id":"105522","content":"å¯¹ï¼Œæ²¡é”™ï¼Œå®Œç¾å¥‘åˆï¼è€å¼Ÿè¿™è¿›åº¦èµ¶å¾—é£èµ·å•Š~ éƒ½è¿½åˆ°21è®²äº†~ èµğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1620226546,"ip_address":"","comment_id":291346,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5915188795","product_id":100073401,"comment_content":"åå‡½æ•°åªé’ˆå¯¹éƒ¨åˆ†è¾“å…¥æ¥è¾“å‡ºç»“æœï¼Œè€Œæ¯ä¸ªå‡½æ•°å¯¹åº”çš„ä¼˜åŒ–è§„åˆ™ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå†æ­é…æ¨¡å¼åŒ¹é…ï¼Œå¾ˆå®Œç¾çš„åº”ç”¨åœºæ™¯å“ˆå“ˆ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519447,"discussion_content":"å¯¹ï¼Œæ²¡é”™ï¼Œå®Œç¾å¥‘åˆï¼è€å¼Ÿè¿™è¿›åº¦èµ¶å¾—é£èµ·å•Š~ éƒ½è¿½åˆ°21è®²äº†~ èµğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620226546,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290911,"user_name":"sky_sql","can_delete":false,"product_type":"c1","uid":1099273,"ip_address":"","ucode":"397F4263C9E590","user_header":"https://static001.geekbang.org/account/avatar/00/10/c6/09/7f2bcc6e.jpg","comment_is_top":false,"comment_ctime":1619854592,"is_pvip":false,"replies":[{"id":"105409","content":"å¯¹ï¼Œæ„å»ºè¯­æ³•æ ‘ã€SchemaéªŒè¯ã€è°“è¯ä¸‹æ¨ã€åˆ—å‰ªè£ï¼Œè¿™äº›å…¶å®æ˜¯ç»å¤§å¤šæ•°çš„æ•°ä»“éƒ½æœ‰çš„ä¼˜åŒ–ç­–ç•¥ã€‚<br><br>å®é™…ä¸Šï¼Œç›¸æ¯”ä¼ ç»ŸDBMSï¼ŒSpark SQLçš„ä¼˜åŒ–æµç¨‹ç®—æ˜¯ç®€åŒ–ç‰ˆçš„äº†ï¼Œæ¯”å¦‚ä¼ ç»ŸDBMSè¿˜ä¼šæœ‰Query Re-writerã€CBOï¼ˆåŸºäºæˆæœ¬çš„ä¼˜åŒ–ï¼‰ç­‰ç­‰ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619860603,"ip_address":"","comment_id":290911,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5914821888","product_id":100073401,"comment_content":"è€å¸ˆå¥½ï¼ŒRDD apiæœ‰ç‚¹ç±»ä¼¼MRç¼–ç¨‹ï¼ŒSpark SQLæœ‰ç‚¹ç±»ä¼¼hiveï¼Œè¿‡ç¨‹éƒ½åŒ…æ‹¬ä½¿ç”¨ Antlr å®ç° SQL çš„è¯æ³•å’Œè¯­æ³•è§£æï¼Œåé¢ä¹Ÿæœ‰Schema ä¿¡æ¯éªŒè¯ï¼Œä¼˜åŒ–ç¯èŠ‚è°“è¯ä¸‹æ¨ã€åˆ—å‰ªè£ç­‰ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519319,"discussion_content":"å¯¹ï¼Œæ„å»ºè¯­æ³•æ ‘ã€SchemaéªŒè¯ã€è°“è¯ä¸‹æ¨ã€åˆ—å‰ªè£ï¼Œè¿™äº›å…¶å®æ˜¯ç»å¤§å¤šæ•°çš„æ•°ä»“éƒ½æœ‰çš„ä¼˜åŒ–ç­–ç•¥ã€‚\n\nå®é™…ä¸Šï¼Œç›¸æ¯”ä¼ ç»ŸDBMSï¼ŒSpark SQLçš„ä¼˜åŒ–æµç¨‹ç®—æ˜¯ç®€åŒ–ç‰ˆçš„äº†ï¼Œæ¯”å¦‚ä¼ ç»ŸDBMSè¿˜ä¼šæœ‰Query Re-writerã€CBOï¼ˆåŸºäºæˆæœ¬çš„ä¼˜åŒ–ï¼‰ç­‰ç­‰ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619860603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":352962,"user_name":"Sampson","can_delete":false,"product_type":"c1","uid":1418226,"ip_address":"åŒ—äº¬","ucode":"BA78CA29A6D898","user_header":"https://static001.geekbang.org/account/avatar/00/15/a3/f2/ab8c5183.jpg","comment_is_top":false,"comment_ctime":1659056861,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1659056861","product_id":100073401,"comment_content":"ç£Šå“¥ï¼Œæƒ³è¯·é—®ä¸‹åœ¨é€»è¾‘è®¡åˆ’è§£æé˜¶æ®µæ˜¯å¦åº”è¯¥è¿˜æœ‰è¯æ³•è§£æï¼Œè¯­æ³•è§£æç­‰æ­¥éª¤ï¼Ÿå¦‚æœæœ‰çš„è¯ï¼Œæ˜¯ä½¿ç”¨çš„ä»€ä¹ˆæ–¹å¼åšçš„å‘¢ ï¼Ÿ ","like_count":0,"discussions":[{"author":{"id":1591216,"avatar":"https://static001.geekbang.org/account/avatar/00/18/47/b0/cf5529a0.jpg","nickname":"ThomasG","note":"","ucode":"C05D94E0A10662","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588368,"discussion_content":"antlr4","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663717971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347153,"user_name":"liangzai","can_delete":false,"product_type":"c1","uid":1122462,"ip_address":"","ucode":"601E3F7A0442AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/20/9e/145df9a3.jpg","comment_is_top":false,"comment_ctime":1653750462,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1653750462","product_id":100073401,"comment_content":"ä»cache managerä¸­æŸ¥è¯¢è®¡åˆ’ï¼Œè¿™ä¸ªæ²¡å¤ªæ‡‚ï¼Œè¯·é—®è¿™ä¸ªç¼“å­˜çš„è®¡åˆ’æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1591216,"avatar":"https://static001.geekbang.org/account/avatar/00/18/47/b0/cf5529a0.jpg","nickname":"ThomasG","note":"","ucode":"C05D94E0A10662","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588369,"discussion_content":"è¿™ä¸ªå¤§æ¦‚æ˜¯å·²ç»è§£æè¿‡çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ¯”å¦‚ä¸€ä¸ªsqlæ‰§è¡Œä¸¤æ¬¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663718042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308634,"user_name":"Marco","can_delete":false,"product_type":"c1","uid":1138102,"ip_address":"","ucode":"78254AE72CB03A","user_header":"https://static001.geekbang.org/account/avatar/00/11/5d/b6/bedadca5.jpg","comment_is_top":false,"comment_ctime":1629712025,"is_pvip":false,"replies":[{"id":"111768","content":"æœ‰çš„ï¼ŒCBOï¼Œä¸è¿‡CBOæœ‰å„ç§æ¯›ç—…ï¼Œè¿™å—åœ¨AQE 24è®²æœ‰ä»‹ç»ã€‚<br><br>ä½†æ˜¯ï¼ŒCBO ä¹Ÿé¢ä¸´ä¸‰ä¸ªæ–¹é¢çš„çª˜å¢ƒï¼šâ€œçª„ã€æ…¢ã€é™â€ã€‚çª„æŒ‡çš„æ˜¯é€‚ç”¨é¢å¤ªçª„ï¼ŒCBO ä»…æ”¯æŒæ³¨å†Œåˆ° Hive Metastore çš„æ•°æ®è¡¨ï¼Œä½†åœ¨å¤§é‡çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæ•°æ®æºå¾€å¾€æ˜¯å­˜å‚¨åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„å„ç±»æ–‡ä»¶ï¼Œå¦‚ Parquetã€ORCã€CSV ç­‰ç­‰ã€‚æ…¢æŒ‡çš„æ˜¯ç»Ÿè®¡ä¿¡æ¯çš„æœé›†æ•ˆç‡æ¯”è¾ƒä½ã€‚å¯¹äºæ³¨å†Œåˆ° Hive Metastore çš„æ•°æ®è¡¨ï¼Œå¼€å‘è€…éœ€è¦è°ƒç”¨ ANALYZE TABLE COMPUTE STATISTICS è¯­å¥æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼Œè€Œå„ç±»ä¿¡æ¯çš„æ”¶é›†ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´ã€‚é™æŒ‡çš„æ˜¯é™æ€ä¼˜åŒ–ï¼Œè¿™ä¸€ç‚¹ä¸ RBO ä¸€æ ·ã€‚CBO ç»“åˆå„ç±»ç»Ÿè®¡ä¿¡æ¯åˆ¶å®šæ‰§è¡Œè®¡åˆ’ï¼Œä¸€æ—¦æ‰§è¡Œè®¡åˆ’äº¤ä»˜è¿è¡Œï¼ŒCBO çš„ä½¿å‘½å°±ç®—å®Œæˆäº†ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœåœ¨è¿è¡Œæ—¶æ•°æ®åˆ†å¸ƒå‘ç”ŸåŠ¨æ€å˜åŒ–ï¼ŒCBO å…ˆå‰åˆ¶å®šçš„æ‰§è¡Œè®¡åˆ’å¹¶ä¸ä¼šè·Ÿç€è°ƒæ•´ã€é€‚é…ã€‚<br><br>","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1629781890,"ip_address":"","comment_id":308634,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1629712025","product_id":100073401,"comment_content":"sparkåªç”¨å¯å‘å¼çš„è§„åˆ™ä¼˜åŒ–å—ï¼Œæœ‰æ²¡æœ‰åŸºäºæˆæœ¬æ¨¡å‹çš„ä¼˜åŒ–ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525567,"discussion_content":"æœ‰çš„ï¼ŒCBOï¼Œä¸è¿‡CBOæœ‰å„ç§æ¯›ç—…ï¼Œè¿™å—åœ¨AQE 24è®²æœ‰ä»‹ç»ã€‚\n\nä½†æ˜¯ï¼ŒCBO ä¹Ÿé¢ä¸´ä¸‰ä¸ªæ–¹é¢çš„çª˜å¢ƒï¼šâ€œçª„ã€æ…¢ã€é™â€ã€‚çª„æŒ‡çš„æ˜¯é€‚ç”¨é¢å¤ªçª„ï¼ŒCBO ä»…æ”¯æŒæ³¨å†Œåˆ° Hive Metastore çš„æ•°æ®è¡¨ï¼Œä½†åœ¨å¤§é‡çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæ•°æ®æºå¾€å¾€æ˜¯å­˜å‚¨åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„å„ç±»æ–‡ä»¶ï¼Œå¦‚ Parquetã€ORCã€CSV ç­‰ç­‰ã€‚æ…¢æŒ‡çš„æ˜¯ç»Ÿè®¡ä¿¡æ¯çš„æœé›†æ•ˆç‡æ¯”è¾ƒä½ã€‚å¯¹äºæ³¨å†Œåˆ° Hive Metastore çš„æ•°æ®è¡¨ï¼Œå¼€å‘è€…éœ€è¦è°ƒç”¨ ANALYZE TABLE COMPUTE STATISTICS è¯­å¥æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼Œè€Œå„ç±»ä¿¡æ¯çš„æ”¶é›†ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´ã€‚é™æŒ‡çš„æ˜¯é™æ€ä¼˜åŒ–ï¼Œè¿™ä¸€ç‚¹ä¸ RBO ä¸€æ ·ã€‚CBO ç»“åˆå„ç±»ç»Ÿè®¡ä¿¡æ¯åˆ¶å®šæ‰§è¡Œè®¡åˆ’ï¼Œä¸€æ—¦æ‰§è¡Œè®¡åˆ’äº¤ä»˜è¿è¡Œï¼ŒCBO çš„ä½¿å‘½å°±ç®—å®Œæˆäº†ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœåœ¨è¿è¡Œæ—¶æ•°æ®åˆ†å¸ƒå‘ç”ŸåŠ¨æ€å˜åŒ–ï¼ŒCBO å…ˆå‰åˆ¶å®šçš„æ‰§è¡Œè®¡åˆ’å¹¶ä¸ä¼šè·Ÿç€è°ƒæ•´ã€é€‚é…ã€‚\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629781890,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305333,"user_name":"çŒ¿é¸½å›","can_delete":false,"product_type":"c1","uid":1991951,"ip_address":"","ucode":"8562D8C5AD3D1E","user_header":"https://static001.geekbang.org/account/avatar/00/1e/65/0f/7b9f27f2.jpg","comment_is_top":false,"comment_ctime":1627909937,"is_pvip":false,"replies":[{"id":"110610","content":"è€å¼Ÿå¯ä»¥æä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯å—ï¼Ÿæ¯”å¦‚å…·ä½“çš„SQLè¯­å¥ï¼ŒSparkå’ŒHiveçš„ç‰ˆæœ¬å·ï¼Œä¸åŒçš„Hiveç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚è¿˜æ˜¯æŒºå¤§çš„","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1628145735,"ip_address":"","comment_id":305333,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1627909937","product_id":100073401,"comment_content":"è¯·é—®è€å¸ˆçŸ¥é“sparksqlæœ‰æ—¶åœ¨æ‰§è¡Œinsert overwrite hive tableï¼ˆé™æ€åˆ†åŒºï¼‰ç‰¹åˆ«æ…¢çš„åŸå› å—ï¼Ÿæˆ‘ç¿»äº†å†…å¤–ç½‘éƒ½åªç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼Œå´æ²¡æœ‰åŸå› â€¦â€¦","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524352,"discussion_content":"è€å¼Ÿå¯ä»¥æä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯å—ï¼Ÿæ¯”å¦‚å…·ä½“çš„SQLè¯­å¥ï¼ŒSparkå’ŒHiveçš„ç‰ˆæœ¬å·ï¼Œä¸åŒçš„Hiveç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚è¿˜æ˜¯æŒºå¤§çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628145735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1511712,"avatar":"https://static001.geekbang.org/account/avatar/00/17/11/20/9f31c4f4.jpg","nickname":"wow_xiaodi","note":"","ucode":"B3FB301556A7EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388254,"discussion_content":"æ˜¯ä¸æ˜¯spark sqlçš„å¹¶è¡Œåº¦è¿‡é«˜ï¼Œä¸€ä¸ªåˆ†åŒºä¸‹å†™å¤ªå¤šæ–‡ä»¶ï¼Œcpuå’Œç£ç›˜ioéƒ½æŸè€—è¿‡å¤§äº†ã€‚å¦å¤–ä¸€ä¸ªæ˜¯æ˜¯å¦å‘ç”Ÿäº†æ•°æ®å€¾æ–œï¼Œæ˜¯è®¡ç®—å¯¼è‡´çš„ç“¶é¢ˆï¼Œè€Œä¸æ˜¯æœ€åsinké˜¶æ®µçš„ç“¶é¢ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628670325,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290924,"user_name":"zxk","can_delete":false,"product_type":"c1","uid":1221195,"ip_address":"","ucode":"4BB2BD9D2BCD04","user_header":"https://static001.geekbang.org/account/avatar/00/12/a2/4b/b72f724f.jpg","comment_is_top":false,"comment_ctime":1619861767,"is_pvip":false,"replies":[{"id":"105435","content":"ç¬¬ä¸€ä¸ªé—®é¢˜ç­”å¾—å¾ˆå¥½~<br>ç¬¬äºŒä¸ªé—®é¢˜å¯ä»¥å‚è€ƒkingcallåŒå­¦çš„ç­”æ¡ˆå“ˆ~","user_name":"ä½œè€…å›å¤","user_name_real":"å´ç£Š","uid":"1043100","ctime":1619946476,"ip_address":"","comment_id":290924,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1619861767","product_id":100073401,"comment_content":"é—®é¢˜1ï¼šSpark é‡Œçš„ä¼˜åŒ–åªæ˜¯ä¸€ç§æ™®ä¸–çš„ä¼˜åŒ–ï¼ŒåŠ›æ±‚åœ¨å°½å¯èƒ½è¦†ç›–ç»å¤§éƒ¨åˆ†é€šç”¨åœºæ™¯ï¼Œå‡å°‘å¯¹å¼€å‘è€…çš„è¦æ±‚ã€‚ä½†å®é™…å¼€å‘ä¸­åœºæ™¯åƒå·®ä¸‡åˆ«ï¼ŒSpark ä¸ä¸€å®šèƒ½è¦†ç›–åˆ°æ‰€æœ‰åœºæ™¯ï¼Œå› æ­¤ä»éœ€è¦æˆ‘ä»¬å°½å¯èƒ½éµå¾ªè¿™äº›å¼€å‘åŸåˆ™ã€‚<br>é—®é¢˜2ï¼šå¯¹åå‡½æ•°ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼ŒçŒœæµ‹æ˜¯å°½å¯èƒ½çš„æ‹†è§£å‡½æ•°ç²’åº¦ï¼Œç»™ Spark ç•™å‡ºæ›´å¤šçš„ä¼˜åŒ–ç©ºé—´ã€‚æ¯”å¦‚ä¹‹å‰è€å¸ˆå°±æœ‰ä¸ª label encoding çš„ä¾‹å­ï¼Œå°†å‡½æ•°æ‹†åˆ†ä¸ºåå‡½æ•°åï¼ŒSpark è‡ªåŠ¨è¿›è¡Œä¼˜åŒ–ï¼Œæ€§èƒ½æœ‰å¾ˆå¤§æå‡ã€‚","like_count":0,"discussions":[{"author":{"id":1043100,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ea/9c/230061e7.jpg","nickname":"å´ç£Š","note":"","ucode":"136DC8CF1B10DC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519327,"discussion_content":"ç¬¬ä¸€ä¸ªé—®é¢˜ç­”å¾—å¾ˆå¥½~\nç¬¬äºŒä¸ªé—®é¢˜å¯ä»¥å‚è€ƒkingcallåŒå­¦çš„ç­”æ¡ˆå“ˆ~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619946476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}