{"id":484372,"title":"08ï½œå†…æ ¸è·Ÿè¸ªï¼ˆä¸‹ï¼‰ï¼šå¼€å‘å†…æ ¸è·Ÿè¸ªç¨‹åºçš„è¿›é˜¶æ–¹æ³•","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ æ¢³ç†äº†æŸ¥è¯¢ eBPF è·Ÿè¸ªç‚¹çš„å¸¸ç”¨æ–¹æ³•ï¼Œå¹¶ä»¥çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªä¸ºä¾‹ï¼Œé€šè¿‡ bpftrace å®ç°äº†å†…æ ¸è·Ÿè¸ªç‚¹çš„è·Ÿè¸ªç¨‹åºã€‚</p><p>bpftrace ç®€å•æ˜“ç”¨ï¼Œéå¸¸é€‚åˆå…¥é—¨ï¼Œå¯ä»¥å¸¦åˆå­¦è€…è½»æ¾ä½“éªŒ eBPF çš„å„ç§è·Ÿè¸ªç‰¹æ€§ã€‚ä½†åœ¨ä¸Šä¸€è®²çš„æ¡ˆä¾‹ä¸­ï¼Œä½ ä¹Ÿå‘ç° bpftrace å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çš„ eBPF åº”ç”¨ï¼Œå®ƒæœ¬èº«çš„é™åˆ¶å¯¼è‡´æˆ‘ä»¬æ— æ³•åœ¨éœ€è¦å¤æ‚ eBPF ç¨‹åºçš„åœºæ™¯ä¸­ä½¿ç”¨å®ƒã€‚åœ¨å¤æ‚çš„åº”ç”¨ä¸­ï¼Œæˆ‘è¿˜æ˜¯æ¨èä½ ä½¿ç”¨ BCC æˆ–è€… libbpf è¿›è¡Œå¼€å‘ã€‚</p><p>é‚£ä¹ˆï¼Œä»Šå¤©æˆ‘å°±å¸¦ä½ çœ‹çœ‹ï¼Œå¦‚ä½•ä½¿ç”¨ BCC å’Œ libbpf è¿™ä¸¤ä¸ªè¿›é˜¶æ–¹æ³•æ¥å¼€å‘å†…æ ¸è·Ÿè¸ªç¨‹åºã€‚</p><h2><strong>BCC æ–¹æ³•</strong></h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ BCC æ¥å¼€å‘ä¸Šä¸€è®²ä¸­çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªç¨‹åºã€‚è¿™é‡Œå…ˆè¯´æ˜ä¸‹ï¼Œç”±äº&nbsp;execveat&nbsp;çš„å¤„ç†é€»è¾‘åŒ&nbsp;execve&nbsp;åŸºæœ¬ç›¸åŒï¼Œé™äºç¯‡å¹…çš„é•¿åº¦ï¼Œæ¥ä¸‹æ¥çš„ BCC å’Œ libbpf ç¨‹åºéƒ½ä»¥&nbsp;execve&nbsp;ä¸ºä¾‹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å…ˆå›é¡¾ä¸‹ <a href=\"https://time.geekbang.org/column/article/481090\">03è®²</a> çš„å†…å®¹ï¼Œä½¿ç”¨ BCC å¼€å‘çš„ eBPF ç¨‹åºåŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p><ul>\n<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ç”¨ C è¯­è¨€å¼€å‘çš„ eBPF ç¨‹åºã€‚åœ¨ eBPF ç¨‹åºä¸­ï¼Œä½ å¯ä»¥åˆ©ç”¨ BCC æä¾›çš„<a href=\"https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md\">åº“å‡½æ•°å’Œå®å®šä¹‰</a>ç®€åŒ–ä½ çš„å¤„ç†é€»è¾‘ã€‚</li>\n<li>ç¬¬äºŒéƒ¨åˆ†æ˜¯ç”¨ Python è¯­è¨€å¼€å‘çš„å‰ç«¯ç•Œé¢ï¼Œå…¶ä¸­åŒ…å« eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰éƒ¨åˆ†ã€‚åœ¨å‰ç«¯ç¨‹åºä¸­ï¼Œä½ åŒæ ·å¯ä»¥åˆ©ç”¨ BCC åº“æ¥è®¿é—® BPF æ˜ å°„ã€‚</li>\n</ul><!-- [[[read_end]]] --><h3><strong>æ•°æ®ç»“æ„å®šä¹‰</strong></h3><p>æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ†ã€‚ä¸ºäº†åœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£è·Ÿè¸ªç‚¹å’Œå‡ºå£è·Ÿè¸ªç‚¹é—´å…±äº«è¿›ç¨‹ä¿¡æ¯ç­‰æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå“ˆå¸Œæ˜ å°„ï¼ˆæ¯”å¦‚å‘½åä¸º&nbsp;<code>tasks</code>ï¼‰ï¼›åŒæ ·åœ°ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦åœ¨ç”¨æˆ·ç©ºé—´å®æ—¶è·å–è·Ÿè¸ªä¿¡æ¯ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªæ€§èƒ½äº‹ä»¶æ˜ å°„ã€‚å¯¹äºè¿™ä¸¤ç§æ˜ å°„çš„åˆ›å»ºæ­¥éª¤ï¼ŒBCC å·²ç»æä¾›äº†éå¸¸æ–¹ä¾¿çš„å®å®šä¹‰ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼æ¥åˆ›å»ºè¿™ä¸¤ä¸ªæ˜ å°„ï¼š</p><pre><code class=\"language-c++\">struct data_t {\n    u32 pid;\n    char comm[TASK_COMM_LEN];\n    int retval;\n    unsigned int args_size;\n    char argv[FULL_MAX_ARGS_ARR];\n};\nBPF_PERF_OUTPUT(events);\nBPF_HASH(tasks, u32, struct data_t);\n</code></pre><p>ä»£ç ä¸­æŒ‡ä»¤çš„å…·ä½“ä½œç”¨å¦‚ä¸‹ï¼š</p><ul>\n<li><code>struct data_t</code>&nbsp;å®šä¹‰äº†ä¸€ä¸ªåŒ…å«è¿›ç¨‹åŸºæœ¬ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå®ƒå°†ç”¨åœ¨å“ˆå¸Œæ˜ å°„çš„å€¼ä¸­ï¼ˆå…¶ä¸­çš„å‚æ•°å¤§å°&nbsp;<code>args_size</code>&nbsp;ä¼šåœ¨è¯»å–å‚æ•°å†…å®¹çš„æ—¶å€™ç”¨åˆ°ï¼‰ï¼›</li>\n<li><code>BPF_PERF_OUTPUT(events)</code>&nbsp;å®šä¹‰äº†ä¸€ä¸ªæ€§èƒ½äº‹ä»¶æ˜ å°„ï¼›</li>\n<li><code>BPF_HASH(tasks, u32, struct data_t)</code>&nbsp;å®šä¹‰äº†ä¸€ä¸ªå“ˆå¸Œæ˜ å°„ï¼Œå…¶é”®ä¸º 32 ä½çš„è¿›ç¨‹ PIDï¼Œè€Œå€¼åˆ™æ˜¯è¿›ç¨‹åŸºæœ¬ä¿¡æ¯&nbsp;<code>data_t</code>ã€‚</li>\n</ul><p>ä¸¤ä¸ªæ˜ å°„å®šä¹‰å¥½ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯<strong>å®šä¹‰è·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°</strong>ã€‚åœ¨ BCC ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡&nbsp;<code>TRACEPOINT_PROBE(category, event)</code>&nbsp;æ¥å®šä¹‰ä¸€ä¸ªè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ã€‚BCC ä¼šå°†æ‰€æœ‰çš„å‚æ•°æ”¾å…¥&nbsp;<code>args</code>&nbsp;è¿™ä¸ªå˜é‡ä¸­ï¼Œè¿™æ ·ä½¿ç”¨&nbsp;<code>args-&gt;&lt;å‚æ•°å&gt;</code>&nbsp;å°±å¯ä»¥è®¿é—®è·Ÿè¸ªç‚¹çš„å‚æ•°å€¼ã€‚</p><p>å¯¹æˆ‘ä»¬è¦è·Ÿè¸ªçš„çŸ­æ—¶è¿›ç¨‹é—®é¢˜æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ªè·Ÿè¸ªç‚¹ï¼š</p><pre><code class=\"language-c++\">// å®šä¹‰sys_enter_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.\nTRACEPOINT_PROBE(syscalls, sys_enter_execve)\n{\n    //å¾…æ·»åŠ å¤„ç†é€»è¾‘\n}\n\n// å®šä¹‰sys_exit_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.\nTRACEPOINT_PROBE(syscalls, sys_exit_execve)\n{\n    //å¾…æ·»åŠ å¤„ç†é€»è¾‘\n}\n</code></pre><h3><strong>å…¥å£è·Ÿè¸ªç‚¹å¤„ç†</strong></h3><p>å¯¹äºå…¥å£è·Ÿè¸ªç‚¹&nbsp;<code>sys_enter_execve</code>&nbsp;çš„å¤„ç†ï¼Œè¿˜æ˜¯æŒ‰ç…§ä¸Šä¸€è®²ä¸­ bpftrace çš„é€»è¾‘ï¼Œå…ˆè·å–è¿›ç¨‹çš„ PIDã€è¿›ç¨‹åç§°å’Œå‚æ•°åˆ—è¡¨ä¹‹åï¼Œå†å­˜å…¥åˆšåˆšå®šä¹‰çš„å“ˆå¸Œæ˜ å°„ä¸­ã€‚</p><p>å…¶ä¸­ï¼Œè¿›ç¨‹ PID å’Œè¿›ç¨‹åç§°éƒ½æ¯”è¾ƒå®¹æ˜“è·å–ã€‚å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œä½ å¯ä»¥è°ƒç”¨&nbsp;<code>bpf_get_current_pid_tgid()</code>&nbsp;æŸ¥è¯¢è¿›ç¨‹ PIDï¼Œè°ƒç”¨&nbsp;<code>bpf_get_current_comm()</code>&nbsp;è¯»å–è¿›ç¨‹åç§°ï¼š</p><pre><code class=\"language-c++\">    // è·å–è¿›ç¨‹PIDå’Œè¿›ç¨‹åç§°\n    struct data_t data = { };\n    u32 pid = bpf_get_current_pid_tgid();  // å–ä½32ä½ä¸ºè¿›ç¨‹PID\n    data.pid = pid;\n    bpf_get_current_comm(&amp;data.comm, sizeof(data.comm));\n</code></pre><p>è€Œå‘½ä»¤è¡Œå‚æ•°çš„è·å–å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ã€‚å› ä¸º BCC æŠŠæ‰€æœ‰å‚æ•°éƒ½æ”¾åˆ°äº†&nbsp;<code>args</code>&nbsp;ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨&nbsp;<code>args-&gt;argv</code>&nbsp;æ¥è®¿é—®å‚æ•°åˆ—è¡¨ï¼š</p><pre><code class=\"language-c++\">const char **argv = (const char **)(args-&gt;argv);\n</code></pre><p>æ³¨æ„ï¼Œ<code>argv</code>&nbsp;æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„å­—ç¬¦ä¸²æ•°ç»„ï¼ˆæŒ‡é’ˆæ•°ç»„ï¼‰ï¼Œè¿™å°±éœ€è¦è°ƒç”¨&nbsp;<code>bpf_probe_read</code>&nbsp;ç³»åˆ—çš„è¾…åŠ©å‡½æ•°ï¼Œå»è¿™äº›æŒ‡é’ˆä¸­è¯»å–æ•°æ®ã€‚å¹¶ä¸”ï¼Œå­—ç¬¦ä¸²çš„æ•°é‡ï¼ˆå³å‚æ•°çš„ä¸ªæ•°ï¼‰å’Œæ¯ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆå³æ¯ä¸ªå‚æ•°çš„é•¿åº¦ï¼‰éƒ½æ˜¯æœªçŸ¥çš„ï¼Œç”±äº eBPF æ ˆå¤§å°åªæœ‰ 512 å­—èŠ‚ï¼Œå¦‚æœæƒ³è¦æŠŠå®ƒä»¬è¯»å…¥ä¸€ä¸ªä¸´æ—¶çš„å­—ç¬¦æ•°ç»„ä¸­ï¼Œå¿…é¡»è¦ä¿è¯æ¯æ¬¡è¯»å–çš„å†…å®¹ä¸è¶…è¿‡æ ˆçš„å¤§å°ã€‚è¿™ç±»é—®é¢˜æœ‰å¾ˆå¤šç§ä¸åŒçš„å¤„ç†æ–¹æ³•ï¼Œå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ–¹å¼å°±æ˜¯<strong>æŠŠå¤šä½™çš„å‚æ•°æˆªæ–­ï¼Œä½¿ç”¨</strong><code>...</code><strong>ä»£æ›¿è¿‡é•¿çš„å‚æ•°</strong><strong>ã€‚</strong>ä¸€èˆ¬æ¥è¯´ï¼ŒçŸ¥é“äº†è¿›ç¨‹çš„åç§°å’Œå‰å‡ ä¸ªå‚æ•°ï¼Œå¯¹è°ƒè¯•å’Œæ’é”™æ¥è¯´å°±è¶³å¤Ÿäº†ã€‚</p><p>ä½ å¯ä»¥å®šä¹‰æœ€å¤§è¯»å–çš„å‚æ•°ä¸ªæ•°å’Œå‚æ•°é•¿åº¦ï¼Œç„¶ååœ¨å“ˆå¸Œæ˜ å°„çš„å€¼ä¸­å®šä¹‰ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">// å®šä¹‰å‚æ•°é•¿åº¦å’Œå‚æ•°ä¸ªæ•°å¸¸é‡\n#define ARGSIZE 64\n#define TOTAL_MAX_ARGS 5\n#define FULL_MAX_ARGS_ARR (TOTAL_MAX_ARGS * ARGSIZE)\n\nstruct data_t {\n    ...\n    char argv[FULL_MAX_ARGS_ARR];\n};\n</code></pre><p>æœ‰äº†å­—ç¬¦æ•°ç»„ï¼Œæ¥ä¸‹æ¥å†å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä»å‚æ•°æ•°ç»„ä¸­è¯»å–å­—ç¬¦ä¸²å‚æ•°ï¼ˆé™å®šæœ€é•¿&nbsp;<code>ARGSIZE</code>ï¼‰ï¼š</p><pre><code class=\"language-c++\">// ä»ç”¨æˆ·ç©ºé—´è¯»å–å­—ç¬¦ä¸²\nstatic int __bpf_read_arg_str(struct data_t *data, const char *ptr)\n{\n    if (data-&gt;args_size &gt; LAST_ARG) {\n        return -1;\n    }\n\n    int ret = bpf_probe_read_user_str(&amp;data-&gt;argv[data-&gt;args_size], ARGSIZE, (void *)ptr);\n    if (ret &gt; ARGSIZE || ret &lt; 0) {\n        return -1;\n    }\n\n    // increase the args size. the first tailing '\\0' is not counted and hence it\n    // would be overwritten by the next call.\n    data-&gt;args_size += (ret - 1);\n\n    return 0;\n}\n</code></pre><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæœ‰å‡ ç‚¹éœ€è¦ä½ æ³¨æ„ï¼š</p><ul>\n<li><code>bpf_probe_read_user_str()</code>&nbsp;è¿”å›çš„æ˜¯åŒ…å«å­—ç¬¦ä¸²ç»“æŸç¬¦&nbsp;<code>\\0</code>&nbsp;çš„é•¿åº¦ã€‚ä¸ºäº†æ‹¼æ¥æ‰€æœ‰çš„å­—ç¬¦ä¸²ï¼Œåœ¨è®¡ç®—å·²è¯»å–å‚æ•°é•¿åº¦çš„æ—¶å€™ï¼Œéœ€è¦æŠŠ&nbsp;<code>\\0</code>&nbsp;æ’é™¤åœ¨å¤–ã€‚</li>\n<li><code>&amp;data-&gt;argv[data-&gt;args_size]</code>&nbsp;ç”¨æ¥è·å–è¦å­˜æ”¾å‚æ•°çš„ä½ç½®æŒ‡é’ˆï¼Œè¿™æ˜¯ä¸ºäº†æŠŠå¤šä¸ªå‚æ•°æ‹¼æ¥åˆ°ä¸€èµ·ã€‚</li>\n<li>åœ¨è°ƒç”¨&nbsp;<code>bpf_probe_read_user_str()</code>&nbsp;å‰åï¼Œéœ€è¦å¯¹æŒ‡é’ˆä½ç½®å’Œè¿”å›å€¼è¿›è¡Œæ ¡éªŒï¼Œè¿™å¯ä»¥å¸®åŠ© eBPF éªŒè¯å™¨è·å–æŒ‡é’ˆè¯»å†™çš„è¾¹ç•Œï¼ˆå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒ<a href=\"https://sysdig.com/blog/the-art-of-writing-ebpf-programs-a-primer\">è¿™ç¯‡æ–‡ç« </a>ï¼Œäº†è§£æ›´å¤šçš„å†…å­˜è®¿é—®éªŒè¯ç»†èŠ‚ï¼‰ã€‚</li>\n</ul><p>æœ‰äº†è¿™ä¸ªè¾…åŠ©å‡½æ•°ä¹‹åï¼Œå› ä¸º eBPF åœ¨è€ç‰ˆæœ¬å†…æ ¸ä¸­å¹¶ä¸æ”¯æŒå¾ªç¯ï¼ˆæœ‰ç•Œå¾ªç¯åœ¨ <strong>5.3</strong> ä¹‹åæ‰æ”¯æŒï¼‰ï¼Œè¦è®¿é—®å­—ç¬¦ä¸²æ•°ç»„ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå°æŠ€å·§ï¼šä½¿ç”¨&nbsp;<code>#pragma unroll</code>&nbsp;å‘Šè¯‰ç¼–è¯‘å™¨ï¼ŒæŠŠæºç ä¸­çš„å¾ªç¯è‡ªåŠ¨å±•å¼€ã€‚è¿™å°±é¿å…äº†æœ€ç»ˆçš„å­—èŠ‚ç ä¸­åŒ…å«å¾ªç¯ã€‚</p><p>å®Œæ•´çš„å¤„ç†å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼ˆå…·ä½“çš„æ¯ä¸€æ­¥æˆ‘éƒ½åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼Œä½ å¯ä»¥å‚è€ƒæ³¨é‡Šæ¥åŠ æ·±ç†è§£ï¼‰ï¼š</p><pre><code class=\"language-c++\">// å¼•å…¥å†…æ ¸å¤´æ–‡ä»¶\n#include &lt;uapi/linux/ptrace.h&gt;\n#include &lt;linux/sched.h&gt;\n#include &lt;linux/fs.h&gt;\n\n// å®šä¹‰sys_enter_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.\nTRACEPOINT_PROBE(syscalls, sys_enter_execve)\n{\n    // å˜é‡å®šä¹‰\n    unsigned int ret = 0;\n    const char **argv = (const char **)(args-&gt;argv);\n\n    // è·å–è¿›ç¨‹PIDå’Œè¿›ç¨‹åç§°\n    struct data_t data = { };\n    u32 pid = bpf_get_current_pid_tgid();\n    data.pid = pid;\n    bpf_get_current_comm(&amp;data.comm, sizeof(data.comm));\n\n    // è·å–ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå³å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼‰\n    if (__bpf_read_arg_str(&amp;data, (const char *)argv[0]) &lt; 0) {\n        goto out;\n    }\n\n    // è·å–å…¶ä»–å‚æ•°ï¼ˆé™å®šæœ€å¤š5ä¸ªï¼‰\n    #pragma unrollfor (int i = 1; i &lt; TOTAL_MAX_ARGS; i++) {\n        if (__bpf_read_arg_str(&amp;data, (const char *)argv[i]) &lt; 0) {\n            goto out;\n        }\n    }\n\n out:\n    // å­˜å‚¨åˆ°å“ˆå¸Œæ˜ å°„ä¸­\n    tasks.update(&amp;pid, &amp;data);\n    return 0;\n}\n</code></pre><p>æ³¨æ„ï¼Œ<strong>ä¸ºäº†è·å–å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œåœ¨æ–‡ä»¶çš„å¼€å¤´éœ€è¦å¼•å…¥ç›¸å…³çš„å†…æ ¸å¤´æ–‡ä»¶</strong>ã€‚æ­¤å¤–ï¼Œè¯»å–å‚æ•°å®Œæˆä¹‹åï¼Œä¸è¦å¿˜è®°è°ƒç”¨&nbsp;<code>tasks.update()</code>&nbsp;æŠŠè¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯å­˜å‚¨åˆ°å“ˆå¸Œæ˜ å°„ä¸­ã€‚å› ä¸ºè¿”å›å€¼éœ€è¦ç­‰åˆ°å‡ºå£è·Ÿè¸ªç‚¹æ—¶æ‰å¯ä»¥è·å–ï¼Œè¿™å„¿åªéœ€è¦æ›´æ–°å“ˆå¸Œæ˜ å°„å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦æŠŠè¿›ç¨‹ä¿¡æ¯æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„ä¸­å»ã€‚</p><h3><strong>å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†</strong></h3><p>å…¥å£è·Ÿè¸ªç‚¹&nbsp;<code>sys_enter_execve</code>&nbsp;å¤„ç†å¥½ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å‡ºå£è·Ÿè¸ªç‚¹&nbsp;<code>sys_exit_execve</code>&nbsp;è¯¥å¦‚ä½•å¤„ç†ã€‚</p><p>ç”±äºè¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯å·²ç»ä¿å­˜åœ¨äº†å“ˆå¸Œæ˜ å°„ä¸­ï¼Œæ‰€ä»¥å‡ºå£äº‹ä»¶çš„å¤„ç†å¯ä»¥åˆ†ä¸ºæŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€å¡«å……è¿”å›å€¼ã€æœ€åå†æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„è¿™ä¸‰ä¸ªæ­¥éª¤ã€‚å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">// å®šä¹‰sys_exit_execveè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°.\nTRACEPOINT_PROBE(syscalls, sys_exit_execve)\n{\n    // ä»å“ˆå¸Œæ˜ å°„ä¸­æŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯\n    u32 pid = bpf_get_current_pid_tgid();\n    struct data_t *data = tasks.lookup(&amp;pid);\n\n    // å¡«å……è¿”å›å€¼å¹¶æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„ä¸­\n    if (data != NULL) {\n        data-&gt;retval = args-&gt;ret;\n        events.perf_submit(args, data, sizeof(struct data_t));\n\n        // æœ€åæ¸…ç†è¿›ç¨‹ä¿¡æ¯\n        tasks.delete(&amp;pid);\n    }\n\n    return 0;\n}\n</code></pre><p>åˆ°è¿™é‡Œï¼Œå®Œæ•´çš„ eBPF ç¨‹åºå°±å¼€å‘å¥½äº†ï¼Œä½ å¯ä»¥æŠŠä¸Šè¿°çš„ä»£ç ä¿å­˜åˆ°ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ä¸­ï¼Œå¹¶å‘½åä¸º&nbsp;<code>execsnoop.c</code>ï¼ˆä½ ä¹Ÿå¯ä»¥åœ¨&nbsp;<a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/bcc-apps/python/execsnoop.c\">GitHub</a>&nbsp;ä¸Šæ‰¾åˆ°å…¨éƒ¨æºç ï¼‰ã€‚</p><h3><strong>Pythonå‰ç«¯å¤„ç†</strong></h3><p>eBPF ç¨‹åºå¼€å‘å®Œæˆåï¼Œæœ€åä¸€æ­¥å°±æ˜¯ä¸ºå®ƒå¢åŠ ä¸€ä¸ª Python å‰ç«¯ã€‚</p><p>åŒ <a href=\"https://time.geekbang.org/column/article/481090\">03 è®²</a> çš„ Hello World ç±»ä¼¼ï¼Œ<strong>Python å‰ç«¯é€»è¾‘éœ€è¦ eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰å‡ ä¸ªæ­¥éª¤</strong>ã€‚å…¶ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ä½¿ç”¨äº†&nbsp;<code>TRACEPOINT_PROBE</code>&nbsp;å®å®šä¹‰ï¼Œæ¥å®šä¹‰ eBPF è·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ï¼ŒBCC åœ¨åŠ è½½å­—èŠ‚ç çš„æ—¶å€™ï¼Œä¼šå¸®ä½ è‡ªåŠ¨æŠŠå®ƒæŒ‚è½½åˆ°æ­£ç¡®çš„è·Ÿè¸ªç‚¹ä¸Šï¼Œæ‰€ä»¥æŒ‚è½½çš„æ­¥éª¤å°±å¯ä»¥å¿½ç•¥ã€‚å®Œæ•´çš„ Python ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-python\"># å¼•å…¥åº“å‡½æ•°\nfrom bcc import BPF\nfrom bcc.utils import printb\n\n# 1) åŠ è½½eBPFä»£ç \nb = BPF(src_file=\"execsnoop.c\")\n\n# 2) è¾“å‡ºå¤´\nprint(\"%-6s %-16s %-3s %s\" % (\"PID\", \"COMM\", \"RET\", \"ARGS\"))\n\n# 3) å®šä¹‰æ€§èƒ½äº‹ä»¶æ‰“å°å‡½æ•°\ndef print_event(cpu, data, size):\n    # BCCè‡ªåŠ¨æ ¹æ®\"struct data_t\"ç”Ÿæˆæ•°æ®ç»“æ„\n    event = b[\"events\"].event(data)\n    printb(b\"%-6d %-16s %-3d %-16s\" % (event.pid, event.comm, event.retval, event.argv))\n\n# 4) ç»‘å®šæ€§èƒ½äº‹ä»¶æ˜ å°„å’Œè¾“å‡ºå‡½æ•°ï¼Œå¹¶ä»æ˜ å°„ä¸­å¾ªç¯è¯»å–æ•°æ®\nb[\"events\"].open_perf_buffer(print_event)\nwhile 1:\n    try:\n        b.perf_buffer_poll()\n    except KeyboardInterrupt:\n        exit()\n</code></pre><p>æŠŠä¸Šè¿°çš„ä»£ç ä¿å­˜åˆ°&nbsp;<code>execsnoop.py</code>&nbsp;ä¸­ï¼Œç„¶åé€šè¿‡ Python è¿è¡Œï¼Œå¹¶åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡Œ&nbsp;<code>ls</code>&nbsp;å‘½ä»¤ï¼Œä½ å°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><pre><code class=\"language-bash\">$ sudo python3 execsnoop.py\nPID    COMM             RET ARGS\n249134 zsh              0   ls--color=tty\n</code></pre><p>æ­å–œï¼Œåˆ°è¿™é‡Œä½ å·²ç»å¼€å‘äº†ä¸€ä¸ªæ–°çš„ eBPF ç¨‹åºï¼Œå¹¶ä¸”å®ƒå¯ä»¥å¸®ä½ æ’æŸ¥çŸ­æ—¶è¿›ç¨‹ç›¸å…³çš„æ€§èƒ½é—®é¢˜ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨ä½ æƒ³è¦åˆ†å‘è¿™ä¸ªç¨‹åºåˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œåˆä¼šç¢°åˆ°ä¸€ä¸ªæ–°çš„éš¾é¢˜ï¼šBCC ä¾èµ–äº LLVM å’Œå†…æ ¸å¤´æ–‡ä»¶æ‰å¯ä»¥åŠ¨æ€ç¼–è¯‘å’ŒåŠ è½½ eBPF ç¨‹åºï¼Œè€Œå‡ºäºå®‰å…¨ç­–ç•¥çš„éœ€è¦ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸åˆä¸å…è®¸å®‰è£…è¿™äº›å¼€å‘å·¥å…·ã€‚</p><p>è¿™ä¸ªéš¾é¢˜åº”è¯¥æ€ä¹ˆå…‹æœå‘¢ï¼Ÿä¸€ç§å¾ˆå®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•æ˜¯æŠŠ BCC å’Œå¼€å‘å·¥å…·éƒ½å®‰è£…åˆ°å®¹å™¨ä¸­ï¼Œå®¹å™¨æœ¬èº«ä¸æä¾›å¯¹å¤–æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥é™ä½å®‰å…¨é£é™©ã€‚å¦å¤–ä¸€ç§æ–¹æ³•å°±æ˜¯å‚è€ƒå†…æ ¸ä¸­çš„&nbsp;<a href=\"https://elixir.bootlin.com/linux/v5.13/source/samples/bpf\">eBPF ç¤ºä¾‹</a>ï¼Œå¼€å‘ä¸€ä¸ªåŒ¹é…å½“å‰å†…æ ¸ç‰ˆæœ¬çš„ eBPF ç¨‹åºï¼Œå¹¶ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œå†åˆ†å‘åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœä½ çš„å†…æ ¸å·²ç»æ”¯æŒäº† BPF ç±»å‹æ ¼å¼ (BTF)ï¼Œæˆ‘æ¨èä½ ä½¿ç”¨ä»å†…æ ¸æºç ä¸­æŠ½ç¦»å‡ºæ¥çš„ libbpf è¿›è¡Œå¼€å‘ï¼Œè¿™æ ·å¯ä»¥å€ŸåŠ© BTF å’Œ CO-RE è·å¾—æ›´å¥½çš„ç§»æ¤æ€§ã€‚å®é™…ä¸Šï¼ŒBCC çš„å¾ˆå¤šå·¥å…·éƒ½åœ¨å‘ BTF è¿ç§»ä¸­ï¼Œç›¸ä¿¡æœªæ¥ libbpf ä¼šæˆä¸ºæœ€å—æ¬¢è¿çš„ eBPF ç¨‹åºå¼€å‘åŸºç¡€åº“ï¼Œç”šè‡³ Windows eBPF ä¹Ÿä¼šæ”¯æŒ libbpfã€‚</p><h2><strong>libbpf æ–¹æ³•</strong></h2><p>é‚£ä¹ˆï¼Œå¦‚ä½•ç”¨ libbpf æ¥å¼€å‘ä¸€ä¸ª eBPF ç¨‹åºå‘¢ï¼Ÿè·Ÿåˆšæ‰çš„ BCC ç¨‹åºç±»ä¼¼ï¼Œä½¿ç”¨ libbpf å¼€å‘ eBPF ç¨‹åºä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç¬¬ä¸€ï¼Œå†…æ ¸æ€çš„ eBPF ç¨‹åºï¼›ç¬¬äºŒï¼Œç”¨æˆ·æ€çš„åŠ è½½ã€æŒ‚è½½ã€æ˜ å°„è¯»å–ä»¥åŠè¾“å‡ºç¨‹åºç­‰ã€‚</p><p><strong>åœ¨ eBPF ç¨‹åºä¸­ï¼Œç”±äºå†…æ ¸å·²ç»æ”¯æŒäº† BTFï¼Œä½ ä¸å†éœ€è¦å¼•å…¥ä¼—å¤šçš„å†…æ ¸å¤´æ–‡ä»¶æ¥è·å–å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</strong>å–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªé€šè¿‡ bpftool ç”Ÿæˆçš„&nbsp;<strong><code>vmlinux.h</code></strong>&nbsp;å¤´æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†å†…æ ¸æ•°æ®ç»“æ„çš„å®šä¹‰ã€‚</p><p>è¿™æ ·ï¼Œä½¿ç”¨ libbpf å¼€å‘ eBPF ç¨‹åºå°±å¯ä»¥é€šè¿‡ä»¥ä¸‹å››ä¸ªæ­¥éª¤å®Œæˆï¼š</p><ol>\n<li>ä½¿ç”¨ bpftool ç”Ÿæˆå†…æ ¸æ•°æ®ç»“æ„å®šä¹‰å¤´æ–‡ä»¶ã€‚BTF å¼€å¯åï¼Œä½ å¯ä»¥åœ¨ç³»ç»Ÿä¸­æ‰¾åˆ°&nbsp;<code>/sys/kernel/btf/vmlinux</code>&nbsp;è¿™ä¸ªæ–‡ä»¶ï¼Œbpftool æ­£æ˜¯ä»å®ƒç”Ÿæˆäº†å†…æ ¸æ•°æ®ç»“æ„å¤´æ–‡ä»¶ã€‚</li>\n<li>å¼€å‘ eBPF ç¨‹åºéƒ¨åˆ†ã€‚ä¸ºäº†æ–¹ä¾¿åç»­é€šè¿‡ç»Ÿä¸€çš„ Makefile ç¼–è¯‘ï¼ŒeBPF ç¨‹åºçš„æºç æ–‡ä»¶ä¸€èˆ¬å‘½åä¸º&nbsp;<code>&lt;ç¨‹åºå&gt;.bpf.c</code>ã€‚</li>\n<li>ç¼–è¯‘ eBPF ç¨‹åºä¸ºå­—èŠ‚ç ï¼Œç„¶åå†è°ƒç”¨&nbsp;<code>bpftool gen skeleton</code>&nbsp;ä¸º eBPF å­—èŠ‚ç ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶ï¼ˆSkeleton Headerï¼‰ã€‚è¿™ä¸ªå¤´æ–‡ä»¶åŒ…å«äº† eBPF å­—èŠ‚ç ä»¥åŠç›¸å…³çš„åŠ è½½ã€æŒ‚è½½å’Œå¸è½½å‡½æ•°ï¼Œå¯åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­ç›´æ¥è°ƒç”¨ã€‚</li>\n<li>æœ€åå°±æ˜¯ç”¨æˆ·æ€ç¨‹åºå¼•å…¥ä¸Šä¸€æ­¥ç”Ÿæˆçš„å¤´æ–‡ä»¶ï¼Œå¼€å‘ç”¨æˆ·æ€ç¨‹åºï¼ŒåŒ…æ‹¬ eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°å†…æ ¸å‡½æ•°å’Œè·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰ã€‚</li>\n</ol><p>é€šå¸¸ï¼Œè¿™å‡ ä¸ªæ­¥éª¤é‡Œé¢çš„ç¼–è¯‘ã€åº“é“¾æ¥ã€æ‰§è¡Œ&nbsp;<code>bpftool</code>&nbsp;å‘½ä»¤ç­‰ï¼Œéƒ½å¯ä»¥æ”¾åˆ° Makefile ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ä¸€ä¸ª&nbsp;<code>make</code>&nbsp;å‘½ä»¤å»æ‰§è¡Œæ‰€æœ‰çš„æ­¥éª¤ã€‚æ¯”å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„ Makefileï¼š</p><pre><code class=\"language-makefile\">APPS = execsnoop\n\n.PHONY: all\nall: $(APPS)\n\n$(APPS):\n    clang -g -O2 -target bpf -D__TARGET_ARCH_x86_64 -I/usr/include/x86_64-linux-gnu -I. -c $@.bpf.c -o $@.bpf.o\n    bpftool gen skeleton $@.bpf.o &gt; $@.skel.h\n    clang -g -O2 -Wall -I . -c $@.c -o $@.o\n    clang -Wall -O2 -g $@.o -static -lbpf -lelf -lz -o $@\n\nvmlinux:\n    $(bpftool) btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h\n</code></pre><p>æœ‰äº†è¿™ä¸ª Makefile ä¹‹åï¼Œä½ æ‰§è¡Œ&nbsp;<code>make vmlinux</code>&nbsp;å‘½ä»¤å°±å¯ä»¥ç”Ÿæˆ&nbsp;<code>vmlinux.h</code>&nbsp;æ–‡ä»¶ï¼Œå†æ‰§è¡Œ&nbsp;<code>make</code>&nbsp;å°±å¯ä»¥ç¼–è¯‘&nbsp;<code>APPS</code>&nbsp;é‡Œé¢é…ç½®çš„æ‰€æœ‰ eBPF ç¨‹åºï¼ˆå¤šä¸ªç¨‹åºä¹‹é—´ä»¥ç©ºæ ¼åˆ†éš”ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦ä½ ä¸€èµ·é€šè¿‡ä¸Šè¿°å››ä¸ªæ­¥éª¤å¼€å‘è·Ÿè¸ªçŸ­æ—¶è¿›ç¨‹çš„ eBPF ç¨‹åºã€‚</p><h3><strong>å†…æ ¸å¤´æ–‡ä»¶ç”Ÿæˆ</strong></h3><p>é¦–å…ˆï¼Œå¯¹äºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå³å¯ç”Ÿæˆå†…æ ¸æ•°æ®ç»“æ„çš„å¤´æ–‡ä»¶ï¼š</p><pre><code class=\"language-bash\">sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h\n</code></pre><p>å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥äº†ï¼Œå¹¶ä¸”é”™è¯¯è¯´ BTF ä¸å­˜åœ¨ï¼Œé‚£è¯´æ˜å½“å‰ç³»ç»Ÿå†…æ ¸æ²¡æœ‰å¼€å¯ BTF ç‰¹æ€§ã€‚è¿™æ—¶å€™ï¼Œä½ éœ€è¦å¼€å¯&nbsp;<code>CONFIG_DEBUG_INFO_BTF=y</code>&nbsp;å’Œ&nbsp;<code>CONFIG_DEBUG_INFO=y</code>&nbsp;è¿™ä¸¤ä¸ªç¼–è¯‘é€‰é¡¹ï¼Œç„¶åé‡æ–°ç¼–è¯‘å’Œå®‰è£…å†…æ ¸ã€‚</p><h3><strong>eBPF ç¨‹åºå®šä¹‰</strong></h3><p>ç¬¬äºŒæ­¥å°±æ˜¯å¼€å‘ eBPF ç¨‹åºï¼ŒåŒ…æ‹¬å®šä¹‰å“ˆå¸Œæ˜ å°„ã€æ€§èƒ½äº‹ä»¶æ˜ å°„ä»¥åŠè·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°ç­‰ï¼Œè€Œå¯¹è¿™äº›æ•°æ®ç»“æ„å’Œè·Ÿè¸ªå‡½æ•°çš„å®šä¹‰éƒ½å¯ä»¥é€šè¿‡&nbsp;<code>SEC()</code>&nbsp;å®å®šä¹‰æ¥å®Œæˆã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œ<strong>é€šè¿‡ <code>SEC()</code> å®å®šä¹‰çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ä¼šæ”¾åˆ°ç‰¹å®šçš„ ELF æ®µä¸­ï¼Œè¿™æ ·åç»­åœ¨åŠ è½½ BPF å­—èŠ‚ç æ—¶ï¼Œå°±å¯ä»¥ä»è¿™äº›æ®µä¸­è·å–æ‰€éœ€çš„å…ƒæ•°æ®ã€‚</strong></p><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥å®šä¹‰æ˜ å°„å’Œè·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ï¼š</p><pre><code class=\"language-c++\">// åŒ…å«å¤´æ–‡ä»¶\n#include \"vmlinux.h\"\n#include &lt;bpf/bpf_helpers.h&gt;\n\n// å®šä¹‰è¿›ç¨‹åŸºæœ¬ä¿¡æ¯æ•°æ®ç»“æ„\nstruct event {\n    char comm[TASK_COMM_LEN];\n    pid_t pid;\n    int retval;\n    int args_count;\n    unsigned int args_size;\n    char args[FULL_MAX_ARGS_ARR];\n};\n\n// å®šä¹‰å“ˆå¸Œæ˜ å°„\nstruct {\n    __uint(type, BPF_MAP_TYPE_HASH);\n    __uint(max_entries, 10240);\n    __type(key, pid_t);\n    __type(value, struct event);\n} execs SEC(\".maps\");\n\n// å®šä¹‰æ€§èƒ½äº‹ä»¶æ˜ å°„\nstruct {\n    __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);\n    __uint(key_size, sizeof(u32));\n    __uint(value_size, sizeof(u32));\n} events SEC(\".maps\");\n\n// sys_enter_execveè·Ÿè¸ªç‚¹\nSEC(\"tracepoint/syscalls/sys_enter_execve\")\nint tracepoint__syscalls__sys_enter_execve(struct trace_event_raw_sys_enter *ctx)\n{\n  // å¾…å®ç°å¤„ç†é€»è¾‘\n}\n\n// sys_exit_execveè·Ÿè¸ªç‚¹\nSEC(\"tracepoint/syscalls/sys_exit_execve\")\nint tracepoint__syscalls__sys_exit_execve(struct trace_event_raw_sys_exit *ctx)\n{\n  // å¾…å®ç°å¤„ç†é€»è¾‘\n}\n\n// å®šä¹‰è®¸å¯è¯ï¼ˆå‰è¿°çš„BCCé»˜è®¤ä½¿ç”¨GPLï¼‰\nchar LICENSE[] SEC(\"license\") = \"Dual BSD/GPL\";\n</code></pre><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ®µä»£ç çš„å…·ä½“å«ä¹‰ï¼š</p><ul>\n<li>å¤´æ–‡ä»¶&nbsp;<code>vmlinux.h</code>&nbsp;åŒ…å«äº†å†…æ ¸æ•°æ®ç»“æ„ï¼Œè€Œ&nbsp;<code>bpf/bpf_helpers.h</code>&nbsp;åŒ…å«äº† <a href=\"https://time.geekbang.org/column/article/482459\">05 è®²</a> æåˆ°çš„ BPF è¾…åŠ©å‡½æ•°ï¼›</li>\n<li><code>struct event</code>&nbsp;å®šä¹‰äº†è¿›ç¨‹åŸºæœ¬ä¿¡æ¯æ•°æ®ç»“æ„ï¼Œå®ƒä¼šç”¨åœ¨åé¢çš„å“ˆå¸Œæ˜ å°„ä¸­ï¼›</li>\n<li><code>SEC(\".maps\")</code>&nbsp;å®šä¹‰äº†å“ˆå¸Œæ˜ å°„å’Œæ€§èƒ½äº‹ä»¶æ˜ å°„ï¼›</li>\n<li><code>SEC(\"tracepoint/&lt;è·Ÿè¸ªç‚¹åç§°&gt;\")</code>&nbsp;å®šä¹‰äº†è·Ÿè¸ªç‚¹å¤„ç†å‡½æ•°ï¼Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªç‚¹çš„æ ¼å¼æ˜¯&nbsp;<code>tracepoint/syscalls/&lt;ç³»ç»Ÿè°ƒç”¨åç§°&gt;\"</code>ã€‚ä»¥åä½ éœ€è¦å®šä¹‰å†…æ ¸æ’æ¡©å’Œç”¨æˆ·æ’æ¡©çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»¥ç±»ä¼¼çš„æ ¼å¼å®šä¹‰ï¼Œæ¯”å¦‚&nbsp;<code>kprobe/do_unlinkat</code>&nbsp;æˆ–&nbsp;<code>uprobe/func</code>ï¼›</li>\n<li>æœ€åçš„&nbsp;<code>SEC(\"license\")</code>&nbsp;å®šä¹‰äº† eBPF ç¨‹åºçš„è®¸å¯è¯ã€‚åœ¨ä¸Šè¿°çš„ BCC eBPF ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å®šä¹‰è®¸å¯è¯ï¼Œè¿™æ˜¯å› ä¸º BCC è‡ªåŠ¨å¸®ä½ ä½¿ç”¨äº† GPL è®¸å¯ã€‚</li>\n</ul><p>æœ‰äº†åŸºæœ¬çš„ç¨‹åºç»“æ„ï¼Œæ¥ä¸‹æ¥å°±æ˜¯<strong>å®ç°ç³»ç»Ÿè°ƒç”¨å…¥å£å’Œå‡ºå£è·Ÿè¸ªç‚¹çš„å¤„ç†å‡½æ•°</strong>ã€‚å®ƒä»¬çš„åŸºæœ¬è¿‡ç¨‹è·Ÿä¸Šè¿°çš„ BCC ç¨‹åºæ˜¯ç±»ä¼¼çš„ã€‚</p><h3><strong>å…¥å£è·Ÿè¸ªç‚¹å¤„ç†</strong></h3><p>å¯¹äºå…¥å£è·Ÿè¸ªç‚¹&nbsp;<code>sys_enter_execve</code>&nbsp;çš„å¤„ç†ï¼Œè¿˜æ˜¯æŒ‰ç…§ä¸Šè¿° BCC ç¨‹åºçš„é€»è¾‘ï¼Œå…ˆè·å–è¿›ç¨‹çš„ PIDã€è¿›ç¨‹åç§°å’Œå‚æ•°åˆ—è¡¨ä¹‹åï¼Œå†å­˜å…¥åˆšåˆšå®šä¹‰çš„å“ˆå¸Œæ˜ å°„ä¸­ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œå…·ä½“æ¯ä¸€æ­¥çš„å†…å®¹æˆ‘éƒ½åŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼š</p><pre><code class=\"language-c++\">SEC(\"tracepoint/syscalls/sys_enter_execve\")\nint tracepoint__syscalls__sys_enter_execve(struct trace_event_raw_sys_enter\n                       *ctx)\n{\n    struct event *event;\n    const char **args = (const char **)(ctx-&gt;args[1]);\n    const char *argp;\n\n    // æŸ¥è¯¢PID\n    u64 id = bpf_get_current_pid_tgid();\n    pid_t pid = (pid_t) id;\n\n    // ä¿å­˜ä¸€ä¸ªç©ºçš„eventåˆ°å“ˆå¸Œæ˜ å°„ä¸­\n    if (bpf_map_update_elem(&amp;execs, &amp;pid, &amp;empty_event, BPF_NOEXIST)) {\n        return 0;\n    }\n    event = bpf_map_lookup_elem(&amp;execs, &amp;pid);\n    if (!event) {\n        return 0;\n    }\n\n    // åˆå§‹åŒ–eventå˜é‡\n    event-&gt;pid = pid;\n    event-&gt;args_count = 0;\n    event-&gt;args_size = 0;\n\n    // æŸ¥è¯¢ç¬¬ä¸€ä¸ªå‚æ•°\n    unsigned int ret = bpf_probe_read_user_str(event-&gt;args, ARGSIZE,\n                           (const char *)ctx-&gt;args[0]);\n    if (ret &lt;= ARGSIZE) {\n        event-&gt;args_size += ret;\n    }\n\n    // æŸ¥è¯¢å…¶ä»–å‚æ•°\n    event-&gt;args_count++;\n    #pragma unrollfor (int i = 1; i &lt; TOTAL_MAX_ARGS; i++) {\n        bpf_probe_read_user(&amp;argp, sizeof(argp), &amp;args[i]);\n        if (!argp)\n            return 0;\n\n        if (event-&gt;args_size &gt; LAST_ARG)\n            return 0;\n\n        ret =\n            bpf_probe_read_user_str(&amp;event-&gt;args[event-&gt;args_size],\n                        ARGSIZE, argp);\n        if (ret &gt; ARGSIZE)\n            return 0;\n\n        event-&gt;args_count++;\n        event-&gt;args_size += ret;\n    }\n\n    // å†å°è¯•ä¸€æ¬¡ï¼Œç¡®è®¤æ˜¯å¦è¿˜æœ‰æœªè¯»å–çš„å‚æ•°\n    bpf_probe_read_user(&amp;argp, sizeof(argp), &amp;args[TOTAL_MAX_ARGS]);\n    if (!argp)\n        return 0;\n\n    // å¦‚æœè¿˜æœ‰æœªè¯»å–å‚æ•°ï¼Œåˆ™å¢åŠ å‚æ•°æ•°é‡ï¼ˆç”¨äºè¾“å‡º\"...\"ï¼‰\n    event-&gt;args_count++;\n\n    return 0;\n}\n</code></pre><p>å…¶ä¸­ï¼Œä½ éœ€è¦æ³¨æ„è¿™ä¸‰ç‚¹ï¼š</p><ul>\n<li>ç¬¬ä¸€ï¼Œç¨‹åºä½¿ç”¨äº†&nbsp;<code>bpf_probe_read_user()</code>&nbsp;æ¥æŸ¥è¯¢å‚æ•°ã€‚ç”±äºå®ƒæŠŠ&nbsp;<code>\\0</code>&nbsp;ä¹Ÿç®—åˆ°äº†å·²è¯»å–å‚æ•°çš„é•¿åº¦é‡Œé¢ï¼Œæ‰€ä»¥æœ€ç»ˆ&nbsp;<code>event-&gt;args</code>&nbsp;ä¸­ä¿å­˜çš„å„ä¸ªå‚æ•°æ˜¯ä»¥&nbsp;<code>\\0</code>&nbsp;åˆ†éš”çš„ã€‚åœ¨ç”¨æˆ·æ€ç¨‹åºè¾“å‡ºå‚æ•°ä¹‹å‰ï¼Œéœ€è¦ç”¨ç©ºæ ¼æ›¿æ¢&nbsp;<code>\\0</code>ã€‚</li>\n<li>ç¬¬äºŒï¼Œç¨‹åºåœ¨ä¸€å¼€å§‹çš„æ—¶å€™å‘å“ˆå¸Œæ˜ å°„å­˜å…¥äº†ä¸€ä¸ªç©ºäº‹ä»¶ï¼Œåœ¨åç»­å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†çš„æ—¶å€™éœ€è¦ç¡®ä¿ç©ºäº‹ä»¶ä¹Ÿèƒ½æ­£ç¡®æ¸…ç†ã€‚</li>\n<li>ç¬¬ä¸‰ï¼Œç¨‹åºåœ¨æœ€ååˆå°è¯•å¤šè¯»å–äº†ä¸€æ¬¡å‚æ•°åˆ—è¡¨ã€‚å¦‚æœè¿˜æœ‰æœªè¯»å–å‚æ•°ï¼Œå‚æ•°æ•°é‡å¢åŠ äº† 1ã€‚ç”¨æˆ·æ€ç¨‹åºå¯ä»¥æ ¹æ®å‚æ•°æ•°é‡æ¥å†³å®šæ˜¯ä¸æ˜¯éœ€è¦åœ¨å‚æ•°ç»“å°¾è¾“å‡ºä¸€ä¸ª&nbsp;<code>...</code>ã€‚</li>\n</ul><h3><strong>å‡ºå£è·Ÿè¸ªç‚¹å¤„ç†</strong></h3><p>å…¥å£è·Ÿè¸ªç‚¹å¤„ç†å¥½ä¹‹åï¼Œå†æ¥çœ‹çœ‹å‡ºå£è·Ÿè¸ªç‚¹çš„å¤„ç†æ–¹æ³•ã€‚å®ƒçš„æ­¥éª¤è·Ÿ BCC ç¨‹åºä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯æŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯ã€å¡«å……è¿”å›å€¼ã€æäº¤åˆ°æ€§èƒ½äº‹ä»¶æ˜ å°„è¿™ä¸‰ä¸ªæ­¥éª¤ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºåˆšæ‰å…¥å£è·Ÿè¸ªç‚¹çš„å¤„ç†ä¸­æ²¡æœ‰è¯»å–è¿›ç¨‹åç§°ï¼Œæ‰€ä»¥åœ¨æäº¤æ€§èƒ½äº‹ä»¶ä¹‹å‰è¿˜éœ€è¦å…ˆæŸ¥è¯¢ä¸€ä¸‹è¿›ç¨‹åç§°ã€‚å®Œæ•´çš„ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼Œå…·ä½“æ¯ä¸€æ­¥çš„å†…å®¹æˆ‘ä¹ŸåŠ äº†è¯¦ç»†çš„æ³¨é‡Šï¼š</p><pre><code class=\"language-c++\">SEC(\"tracepoint/syscalls/sys_exit_execve\")\nint tracepoint__syscalls__sys_exit_execve(struct trace_event_raw_sys_exit *ctx)\n{\n    u64 id;\n    pid_t pid;\n    int ret;\n    struct event *event;\n\n    // ä»å“ˆå¸Œæ˜ å°„ä¸­æŸ¥è¯¢è¿›ç¨‹åŸºæœ¬ä¿¡æ¯\n    id = bpf_get_current_pid_tgid();\n    pid = (pid_t) id;\n    event = bpf_map_lookup_elem(&amp;execs, &amp;pid);\n    if (!event)\n        return 0;\n\n    // æ›´æ–°è¿”å›å€¼å’Œè¿›ç¨‹åç§°\n    ret = ctx-&gt;ret;\n    event-&gt;retval = ret;\n    bpf_get_current_comm(&amp;event-&gt;comm, sizeof(event-&gt;comm));\n\n    // æäº¤æ€§èƒ½äº‹ä»¶\n    size_t len = EVENT_SIZE(event);\n    if (len &lt;= sizeof(*event))\n        bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU, event,\n                      len);\n\n    // æ¸…ç†å“ˆå¸Œæ˜ å°„\n    bpf_map_delete_elem(&amp;execs, &amp;pid);\n    return 0;\n}\n</code></pre><p>ä»è¿™äº›ä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å¤„ç†é€»è¾‘è·Ÿä¸Šè¿°çš„ BCC ç¨‹åºåŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„ã€‚ä¸è¿‡ï¼Œè¯¦ç»†å¯¹æ¯”ä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°å®ƒä»¬ä¹‹é—´è¿˜æ˜¯æœ‰ä¸åŒçš„ï¼Œä¸åŒç‚¹ä¸»è¦åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul>\n<li>ç¬¬ä¸€ï¼Œå‡½æ•°åçš„å®šä¹‰æ ¼å¼ä¸åŒã€‚BCC ç¨‹åºä½¿ç”¨çš„æ˜¯&nbsp;<code>TRACEPOINT_PROBE</code>&nbsp;å®ï¼Œè€Œ libbpf ç¨‹åºç”¨çš„åˆ™æ˜¯&nbsp;<code>SEC</code>&nbsp;å®ã€‚</li>\n<li>ç¬¬äºŒï¼Œæ˜ å°„çš„è®¿é—®æ–¹æ³•ä¸åŒã€‚BCC å°è£…äº†å¾ˆå¤šæ›´æ˜“ç”¨çš„æ˜ å°„è®¿é—®å‡½æ•°ï¼ˆå¦‚&nbsp;<code>tasks.lookup()</code>ï¼‰ï¼Œè€Œ libbpf ç¨‹åºåˆ™éœ€è¦è°ƒç”¨ <a href=\"https://time.geekbang.org/column/article/482459\">05 è®²</a> æåˆ°è¿‡çš„ BPF è¾…åŠ©å‡½æ•°ï¼ˆæ¯”å¦‚æŸ¥è¯¢è¦ä½¿ç”¨&nbsp;<code>bpf_map_lookup_elem()</code>ï¼‰ã€‚</li>\n</ul><p>åˆ°è¿™é‡Œï¼Œæ–°å»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶æŠŠä¸Šè¿°ä»£ç å­˜å…¥&nbsp;<code>execsnoop.bpf.c</code>&nbsp;æ–‡ä»¶ä¸­ï¼ŒeBPF éƒ¨åˆ†çš„ä»£ç ä¹Ÿå°±å¼€å‘å¥½äº†ã€‚</p><h3><strong>ç¼–è¯‘å¹¶ç”Ÿæˆè„šæ‰‹æ¶å¤´æ–‡ä»¶</strong></h3><p>æœ‰äº† eBPF ç¨‹åºï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ clang å’Œ bpftool å°†å…¶ç¼–è¯‘æˆ BPF å­—èŠ‚ç ï¼Œç„¶åå†ç”Ÿæˆå…¶è„šæ‰‹æ¶å¤´æ–‡ä»¶&nbsp;<code>execsnoop.skel.h</code>&nbsp;ï¼ˆæ³¨æ„ï¼Œè„šæ‰‹æ¶å¤´æ–‡ä»¶çš„åå­—ä¸€èˆ¬å®šä¹‰ä¸º&nbsp;<code>&lt;ç¨‹åºå&gt;.skel.h</code>ï¼‰ï¼š</p><pre><code class=\"language-bash\">clang -g -O2 -target bpf -D__TARGET_ARCH_x86_64 -I/usr/include/x86_64-linux-gnu -I. -c execsnoop.bpf.c -o execsnoop.bpf.o\nbpftool gen skeleton execsnoop.bpf.o &gt; execsnoop.skel.h\n</code></pre><p>å…¶ä¸­ï¼Œclang çš„å‚æ•°&nbsp;<code>-target bpf</code>&nbsp;è¡¨ç¤ºè¦ç”Ÿæˆ BPF å­—èŠ‚ç ï¼Œ<code>-D__TARGET_ARCH_x86_64</code>&nbsp;è¡¨ç¤ºç›®æ ‡çš„ä½“ç³»ç»“æ„æ˜¯ x86_64ï¼Œè€Œ&nbsp;<code>-I</code>&nbsp;åˆ™æ˜¯å¼•å…¥å¤´æ–‡ä»¶è·¯å¾„ã€‚</p><p>å‘½ä»¤æ‰§è¡Œåï¼Œè„šæ‰‹æ¶å¤´æ–‡ä»¶ä¼šæ”¾åˆ°&nbsp;<code>execsnoop.skel.h</code>&nbsp;ä¸­ï¼Œè¿™ä¸ªå¤´æ–‡ä»¶åŒ…å«äº† BPF å­—èŠ‚ç å’Œç›¸å…³çš„ç®¡ç†å‡½æ•°ã€‚å› è€Œï¼Œå½“ç”¨æˆ·æ€ç¨‹åºå¼•å…¥è¿™ä¸ªå¤´æ–‡ä»¶å¹¶ç¼–è¯‘ä¹‹åï¼Œåªéœ€è¦åˆ†å‘æœ€ç»ˆç”¨æˆ·æ€ç¨‹åºç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°ç”Ÿäº§ç¯å¢ƒå³å¯ï¼ˆå¦‚æœç”¨æˆ·æ€ç¨‹åºä½¿ç”¨äº†å…¶ä»–çš„åŠ¨æ€åº“ï¼Œè¿˜éœ€è¦åˆ†å‘åŠ¨æ€åº“ï¼‰ã€‚</p><h3><strong>å¼€å‘ç”¨æˆ·æ€ç¨‹åº</strong></h3><p>æœ‰äº†è„šæ‰‹æ¶å¤´æ–‡ä»¶ä¹‹åï¼Œè¿˜å‰©ä¸‹æœ€åä¸€æ­¥ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ€ç¨‹åºçš„å¼€å‘ã€‚</p><p>åŒ BCC çš„ Python å‰ç«¯ç¨‹åºç±»ä¼¼ï¼Œlibbpf ç”¨æˆ·æ€ç¨‹åºä¹Ÿéœ€è¦ eBPF ç¨‹åºåŠ è½½ã€æŒ‚è½½åˆ°è·Ÿè¸ªç‚¹ï¼Œä»¥åŠé€šè¿‡ BPF æ˜ å°„è·å–å’Œæ‰“å°æ‰§è¡Œç»“æœç­‰å‡ ä¸ªæ­¥éª¤ã€‚è™½ç„¶ C è¯­è¨€å¬èµ·æ¥å¯èƒ½æ¯” Python è¯­è¨€éº»çƒ¦ä¸€äº›ï¼Œä½†å®é™…ä¸Šï¼Œè¿™å‡ ä¸ªæ­¥éª¤éƒ½å¯ä»¥é€šè¿‡è„šæ‰‹æ¶å¤´æ–‡ä»¶ä¸­è‡ªåŠ¨ç”Ÿæˆçš„å‡½æ•°æ¥å®Œæˆã€‚</p><p>ä¸‹é¢æ˜¯å¿½ç•¥äº†é”™è¯¯å¤„ç†é€»è¾‘ä¹‹åï¼Œç”¨æˆ·æ€ç¨‹åºçš„ä¸€ä¸ªåŸºæœ¬æ¡†æ¶ï¼š</p><pre><code class=\"language-c++\">// å¼•å…¥è„šæ‰‹æ¶å¤´æ–‡ä»¶\n#include \"execsnoop.skel.h\"\n\n// Cè¯­è¨€ä¸»å‡½æ•°\nint main(int argc, char **argv)\n{\n    // å®šä¹‰BPFç¨‹åºå’Œæ€§èƒ½äº‹ä»¶ç¼“å†²åŒº\n    struct execsnoop_bpf *skel;\n    struct perf_buffer_opts pb_opts;\n    struct perf_buffer *pb = NULL;\n    int err;\n\n    // 1. è®¾ç½®è°ƒè¯•è¾“å‡ºå‡½æ•°\n    libbpf_set_print(libbpf_print_fn);\n\n    // 2. å¢å¤§ RLIMIT_MEMLOCKï¼ˆé»˜è®¤å€¼é€šå¸¸å¤ªå°ï¼Œä¸è¶³ä»¥å­˜å…¥BPFæ˜ å°„çš„å†…å®¹ï¼‰\n    bump_memlock_rlimit();\n\n    // 3. åˆå§‹åŒ–BPFç¨‹åº\n    skel = execsnoop_bpf__open();\n\n    // 4. åŠ è½½BPFå­—èŠ‚ç \n    err = execsnoop_bpf__load(skel);\n\n    // 5. æŒ‚è½½BPFå­—èŠ‚ç åˆ°è·Ÿè¸ªç‚¹\n    err = execsnoop_bpf__attach(skel);\n\n    // 6. é…ç½®æ€§èƒ½äº‹ä»¶å›è°ƒå‡½æ•°\n    pb_opts.sample_cb = handle_event;\n    pb = perf_buffer__new(bpf_map__fd(skel-&gt;maps.events), 64, &amp;pb_opts);\n\n    // 7. ä»ç¼“å†²åŒºä¸­å¾ªç¯è¯»å–æ•°æ®\n    while ((err = perf_buffer__poll(pb, 100)) &gt;= 0) ;\n}\n</code></pre><p>å…¶ä¸­ï¼Œ<code>execsnoop_</code>&nbsp;å¼€å¤´çš„æ•°æ®ç»“æ„å’Œå‡½æ•°éƒ½åŒ…å«åœ¨è„šæ‰‹æ¶å¤´æ–‡ä»¶&nbsp;<code>execsnoop.skel.h</code>&nbsp;ä¸­ã€‚è€Œå…·ä½“åˆ°æ¯ä¸€æ­¥çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><ul>\n<li>ç¬¬ 1 æ­¥çš„è°ƒè¯•è¾“å‡ºå‡½æ•°ä¸­ï¼Œå¯ä»¥è°ƒç”¨&nbsp;<code>printf()</code>&nbsp;æŠŠè°ƒè¯•ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯ä¸­ã€‚</li>\n<li>ç¬¬ 2 æ­¥å¢å¤§é”å®šå†…å­˜é™åˆ¶&nbsp;<code>RLIMIT_MEMLOCK</code>&nbsp;æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºç³»ç»Ÿé»˜è®¤çš„é”å®šå†…å­˜é€šå¸¸è¿‡å°ï¼Œæ— æ³•æ»¡è¶³ BPF æ˜ å°„çš„éœ€è¦ã€‚</li>\n<li>ç¬¬ 3~5 æ­¥ï¼Œç›´æ¥è°ƒç”¨è„šæ‰‹æ¶å¤´æ–‡ä»¶ä¸­çš„å‡½æ•°ï¼ŒåŠ è½½ BPF å­—èŠ‚ç å¹¶æŒ‚è½½åˆ°è·Ÿè¸ªç‚¹ã€‚</li>\n<li>ç¬¬ 6~7 æ­¥ä¸ºæ€§èƒ½äº‹ä»¶è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¹¶ä»ç¼“å†²åŒºä¸­å¾ªç¯è¯»å–æ•°æ®ã€‚æ³¨æ„ï¼Œæ€§èƒ½äº‹ä»¶æ˜ å°„&nbsp;<code>skel-&gt;maps.events</code>&nbsp;ä¹Ÿæ˜¯ bpftool è‡ªåŠ¨å¸®ä½ ç”Ÿæˆå¥½çš„ã€‚</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œåœ¨æ€§èƒ½äº‹ä»¶å›è°ƒå‡½æ•°ä¸­ï¼ŒæŠŠæ•°æ®æ ¼å¼è½¬æ¢ä¸º&nbsp;<code>struct event</code>&nbsp;æ ¼å¼ä¹‹åï¼Œç”±äºå‚æ•°åˆ—è¡¨æ˜¯ä½¿ç”¨&nbsp;<code>\\0</code>&nbsp;æ¥åˆ†å‰²çš„ï¼Œå¹¶ä¸èƒ½ç›´æ¥å‘ç»ˆç«¯æ‰“å°æ‰€æœ‰å‚æ•°ã€‚æ‰€ä»¥ï¼Œè¿˜éœ€è¦æŠŠ&nbsp;<code>\\0</code>&nbsp;å…ˆæ›¿æ¢ä¸ºç©ºæ ¼ï¼Œç„¶åå†æ‰“å°ã€‚å®Œæ•´çš„å›è°ƒå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-c++\">// æ€§èƒ½äº‹ä»¶å›è°ƒå‡½æ•°(å‘ç»ˆç«¯ä¸­æ‰“å°è¿›ç¨‹åã€PIDã€è¿”å›å€¼ä»¥åŠå‚æ•°)\nvoid handle_event(void *ctx, int cpu, void *data, __u32 data_sz)\n{\n    const struct event *e = data;\n    printf(\"%-16s %-6d %3d \", e-&gt;comm, e-&gt;pid, e-&gt;retval);\n    print_args(e);\n    putchar('\\n');\n}\n\n// æ‰“å°å‚æ•°ï¼ˆæ›¿æ¢'\\0'ä¸ºç©ºæ ¼ï¼‰\nstatic void print_args(const struct event *e)\n{\n    int args_counter = 0;\n\n    for (int i = 0; i &lt; e-&gt;args_size &amp;&amp; args_counter &lt; e-&gt;args_count; i++) {\n        char c = e-&gt;args[i];\n        if (c == '\\0') {\n            // æŠŠ'\\0'æ›¿æ¢ä¸ºç©ºæ ¼\n            args_counter++;\n            putchar(' ');\n        } else {\n            putchar(c);\n        }\n    }\n    if (e-&gt;args_count &gt; TOTAL_MAX_ARGS) {\n        // è¿‡é•¿çš„å‚æ•°è¾“å‡º\"...\"æ›¿ä»£\n        fputs(\" ...\", stdout);\n    }\n}\n</code></pre><p>æŠŠä¸Šé¢çš„ä»£ç ä¿å­˜åˆ°&nbsp;<code>execsnoop.c</code>&nbsp;æ–‡ä»¶ä¸­ï¼ˆä½ ä¹Ÿå¯ä»¥åœ¨&nbsp;<a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/bpf-apps/execsnoop.c\">GitHub</a>&nbsp;ä¸Šæ‰¾åˆ°å®Œæ•´çš„ä»£ç ï¼‰ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå°†å…¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p><pre><code class=\"language-bash\">clang -g -O2 -Wall -I . -c execsnoop.c -o execsnoop.o\nclang -Wall -O2 -g execsnoop.o -static -lbpf -lelf -lz -o execsnoop\n</code></pre><p>æœ€åï¼Œæ‰§è¡Œ&nbsp;<code>execsnoop</code>ï¼Œä½ å°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼š</p><pre><code class=\"language-bash\">$ sudo ./execsnoop\nCOMM             PID    RET ARGS\nsh               276871   0 /bin/sh -c which ps\nwhich            276872   0 /usr/bin/which ps\n</code></pre><p>ä½ è¿˜å¯ä»¥ç›´æ¥æŠŠè¿™ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°å¼€å¯äº† BTF çš„å…¶ä»–æœºå™¨ä¸­ï¼Œæ— éœ€å®‰è£…é¢å¤–çš„ LLVM å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡Œã€‚</p><p>å¦‚æœå‘½ä»¤å¤±è´¥ï¼Œå¹¶ä¸”ä½ çœ‹åˆ°å¦‚ä¸‹çš„é”™è¯¯ï¼Œè¿™è¯´æ˜å½“å‰æœºå™¨æ²¡æœ‰å¼€å¯ BTFï¼Œéœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸å¼€å¯ BTF æ‰å¯ä»¥è¿è¡Œï¼š</p><pre><code class=\"language-plain\">Failed to load and verify BPF skeleton\n</code></pre><p>æ­å–œï¼ŒåŠ ä¸Šä¸Šä¸€è®²çš„å†…å®¹ï¼Œåˆ°è¿™é‡Œä½ å°±é€šè¿‡ bpftraceã€BCC å’Œ libbpf è¿™ä¸‰ç§æ–¹æ³•ï¼Œå®ç°äº†çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªã€‚è™½ç„¶è¿™ä¸‰ç§æ–¹æ³•çš„æ­¥éª¤å’Œå®ç°ä»£ç å„ä¸ç›¸åŒï¼Œä½†å®é™…ä¸Šå®ƒä»¬çš„å®ç°é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ— éå°±æ˜¯<strong>æ‰¾å‡ºè·Ÿè¸ªç‚¹ï¼Œç„¶ååœ¨ eBPF éƒ¨åˆ†è·å–æƒ³è¦çš„æ•°æ®å¹¶ä¿å­˜åˆ° BPF æ˜ å°„ä¸­ï¼Œæœ€ååœ¨ç”¨æˆ·ç©ºé—´ç¨‹åºä¸­è¯»å– BPF æ˜ å°„çš„å†…å®¹å¹¶è¾“å‡ºå‡ºæ¥</strong>ã€‚</p><h2><strong>å°ç»“</strong></h2><p>ä»Šå¤©ï¼Œæˆ‘ä»¥çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªä¸ºä¾‹ï¼Œé€šè¿‡ BCC å’Œ libbpf è¿™ä¸¤ç§æ–¹æ³•å®ç°äº†çŸ­æ—¶è¿›ç¨‹çš„è·Ÿè¸ªç¨‹åºï¼ˆä½ å¯ä»¥åœ¨ GitHub çš„<a href=\"https://github.com/feiskyer/ebpf-apps\">è¿™ä¸ªé“¾æ¥</a>ä¸­ï¼Œæ‰¾åˆ°ä»Šå¤©çš„æ¡ˆä¾‹ä¸­æåˆ°çš„æ‰€æœ‰æºç ï¼‰ã€‚åŠ ä¸Šä¸Šä¸€è®²ä»‹ç»çš„ bpftrace æ–¹æ³•ï¼Œæˆ‘å·²ç»å¸¦ä½ æŒæ¡äº†ç›®å‰æœ€å¸¸ç”¨çš„ä¸‰ç§ eBPF ç¨‹åºå¼€å‘æ–¹æ³•ï¼Œåœ¨è¿™é‡Œæˆ‘ä¸€èµ·æ€»ç»“ä¸‹ã€‚</p><p>åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œè¿™ä¸‰ç§æ–¹æ³•æœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼š</p><ul>\n<li>bpftrace é€šå¸¸ç”¨åœ¨<strong>å¿«é€Ÿæ’æŸ¥å’Œå®šä½ç³»ç»Ÿ</strong>ä¸Šï¼Œå®ƒæ”¯æŒç”¨å•è¡Œè„šæœ¬çš„æ–¹å¼æ¥å¿«é€Ÿå¼€å‘å¹¶æ‰§è¡Œä¸€ä¸ª eBPF ç¨‹åºï¼›</li>\n<li>BCC é€šå¸¸ç”¨åœ¨<strong>å¼€å‘å¤æ‚çš„ eBPF ç¨‹åº</strong>ä¸­ï¼Œå®ƒå†…ç½®çš„å„ç§å°å·¥å…·ä¹Ÿæ˜¯ç›®å‰åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ eBPF å°ç¨‹åºï¼›</li>\n<li>libbpf æ˜¯<strong>ä»å†…æ ¸ä¸­æŠ½ç¦»å‡ºæ¥çš„æ ‡å‡†åº“</strong>ï¼Œç”¨å®ƒå¼€å‘çš„ eBPF ç¨‹åºå¯ä»¥ç›´æ¥åˆ†å‘æ‰§è¡Œï¼Œä¸å†éœ€è¦åœ¨æ¯å°æœºå™¨ä¸Šéƒ½å®‰è£… LLVM å’Œå†…æ ¸å¤´æ–‡ä»¶ã€‚</li>\n</ul><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç”¨ bpftrace æˆ– BCC åšä¸€äº›å¿«é€ŸåŸå‹ï¼ŒéªŒè¯ä½ çš„è®¾è®¡æ€è·¯æ˜¯ä¸æ˜¯å¯è¡Œï¼Œç„¶åå†åˆ‡æ¢åˆ° libbpf ï¼Œå¼€å‘å®Œå–„çš„ eBPF ç¨‹åºåå†å»åˆ†å‘æ‰§è¡Œã€‚è¿™æ ·ï¼Œä¸ä»… eBPF ç¨‹åºè¿è¡Œå¾—æ›´å¿«ï¼ˆæ— éœ€ç¼–è¯‘æ­¥éª¤ï¼‰ï¼Œè¿˜é¿å…äº†åœ¨è¿è¡Œç¯å¢ƒä¸­å®‰è£…å¼€å‘å·¥å…·å’Œå†…æ ¸å¤´æ–‡ä»¶ã€‚</p><p>åœ¨ä¸æ”¯æŒ BTF çš„æœºå™¨ä¸­ï¼Œå¦‚æœä¸æƒ³åœ¨è¿è¡Œ eBPF æ—¶ä¾èµ–äº LLVM ç¼–è¯‘å’Œå†…æ ¸å¤´æ–‡ä»¶ï¼Œä½ è¿˜å¯ä»¥å‚è€ƒå†…æ ¸ä¸­çš„&nbsp;<a href=\"https://elixir.bootlin.com/linux/v5.13/source/samples/bpf\">BPF ç¤ºä¾‹</a>ï¼Œç›´æ¥å¼•ç”¨å†…æ ¸æºç ä¸­çš„&nbsp;<code>tools/lib/bpf/</code>&nbsp;åº“ï¼Œä»¥åŠå†…æ ¸å¤´æ–‡ä»¶ä¸­çš„æ•°æ®ç»“æ„ï¼Œæ¥å¼€å‘ eBPF ç¨‹åºã€‚</p><h2><strong>æ€è€ƒé¢˜</strong></h2><p>ä»Šå¤©ä½¿ç”¨ BCC å’Œ libbpf å¼€å‘çš„ eBPF ç¨‹åºè™½ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡ç»†å¿ƒçš„ä½ ä¸€å®šå‘ç°äº†ï¼Œå®ƒè¿˜æœ‰ä¸å°‘å°é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p><ul>\n<li>å•ä¸ªå‚æ•°è¿‡é•¿ï¼Œæˆ–è€…æ€»çš„å‚æ•°æ•°é‡æ¯”è¾ƒå¤šæ—¶ï¼Œéƒ½ä¼šè¢«æˆªæ–­ï¼Œæ²¡æ³•å®Œæ•´æ˜¾ç¤ºæ‰€æœ‰çš„å‚æ•°åˆ—è¡¨ï¼›</li>\n<li>åœ¨è°ƒè¯•çŸ­æ—¶è¿›ç¨‹é—®é¢˜æ—¶ï¼Œå¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦çˆ¶è¿›ç¨‹çš„ä¿¡æ¯ï¼Œè¿™æ ·æ‰èƒ½æ›´å¿«å®šä½å®ƒä»¬éƒ½æ˜¯è¢«å“ªäº›è¿›ç¨‹åˆ›å»ºå‡ºæ¥çš„ã€‚</li>\n</ul><p>å­¦ä¹ å®Œæœ€è¿‘è¿™ä¸¤è®²çš„å†…å®¹ï¼Œä½ è§‰å¾—è¯¥å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜å‘¢ï¼Ÿä½ å¯ä»¥åœ¨&nbsp;<a href=\"https://github.com/feiskyer/ebpf-apps/blob/main/bcc-apps/python/execsnoop.c\">execsnoop</a>&nbsp;çš„åŸºç¡€ä¸Šæ”¹è¿›ï¼Œå¼€å‘ä¸€ä¸ªæ›´å®Œå–„çš„ eBPF ç¨‹åºå—ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºå’Œæˆ‘åˆ†äº«ä½ çš„æ€è·¯å’Œè§£å†³æ–¹æ³•ã€‚</p><p>æœŸå¾…ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p>","comments":[{"had_liked":false,"id":332884,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1643785035,"is_pvip":false,"replies":[{"id":121737,"content":"éå¸¸æ£’çš„ç­”æ¡ˆï¼Œèµä¸€ä¸ªğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644117853,"ip_address":"","comment_id":332884,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"1ã€å¯¹äºå‚æ•°é—®é¢˜ï¼Œå½“å‰ BPF ç¨‹åºå°è¯•æŠŠæ‰€æœ‰å‚æ•°ä¸€æ¬¡æ€§æ”¾å…¥ï¼Œå—é™äºæ ˆæœ€å¤§é•¿åº¦ 512ï¼Œå¾ˆå®¹æ˜“å‡ºç°è¢«æˆªæ–­ç°è±¡ã€‚ä»¥ BCC ç¨‹åºä¸ºä¾‹çš„è§£å†³æ–¹æ³•ï¼šéå†å‚æ•°åˆ—è¡¨ argv æ—¶ï¼Œæ¯ä¸ªå‚æ•°è¯»å–ä¹‹åç›´æ¥è°ƒç”¨ perf_submit æäº¤è‡³ ringbufï¼Œè€Œä¸æ˜¯è¯»å–æ‰€æœ‰å‚æ•°åä»…æäº¤ä¸€æ¬¡ï¼Œæœ€åç”¨æˆ·æ€ç¨‹åºè´Ÿè´£æŠŠè¿™äº›å­—ç¬¦ä¸²æ‹¼æ¥èµ·æ¥ã€‚è¿™æ ·å¯ä»¥åšåˆ°å‚æ•°æœ€å¤§ä¸ªæ•°ä¸å—é™åˆ¶ï¼Œä¸”æ¯ä¸ªå‚æ•°é•¿åº¦å¯æ¥è¿‘æ ˆæœ€å¤§é•¿åº¦ 512ï¼ˆå½“å‰ BPF ç¨‹åºé™åˆ¶ 64 å®¹æ˜“è¢«æˆªæ–­ï¼‰ã€‚\n\nå¦ä¸€ä¸ªè§£å†³æ–¹å¼åº”è¯¥å¯ä»¥é‡‡ç”¨ perf-cpu array æ˜ å°„ç±»å‹ï¼Œé¿å…å ç”¨æœ‰é™çš„æ ˆç©ºé—´ï¼Œå…·ä½“æ²¡å°è¯•è¿‡ã€‚\n\n2ã€ä»¥ BCC ç¨‹åºä¸ºä¾‹è·å–çˆ¶è¿›ç¨‹ï¼Œstruct data_t å¢åŠ  ppid å­—æ®µï¼Œç„¶åç”± task-&gt;real_parent-&gt;tgid èµ‹å€¼ã€‚\n\nstruct task_struct *task;\n\ntask = (struct task_struct *)bpf_get_current_task();\ndata.ppid = task-&gt;real_parent-&gt;tgid;","like_count":12,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549599,"discussion_content":"éå¸¸æ£’çš„ç­”æ¡ˆï¼Œèµä¸€ä¸ªğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644117853,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1769084,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/fe/7c/2756292d.jpg","nickname":"code","note":"","ucode":"5E79F1D5C3A1CD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550335,"discussion_content":"èƒ½ç»™ä¸€ä¸ªé€šè¿‡æ˜ å°„ç±»å‹ çªç ´æ ˆæœ€å¤§é•¿åº¦é™åˆ¶ çš„exampleå—ï¼Ÿ","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1644486098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2596830,"avatar":"https://static001.geekbang.org/account/avatar/00/27/9f/de/09e62135.jpg","nickname":"^ ^","note":"","ucode":"50D96CC81143F4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1769084,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/fe/7c/2756292d.jpg","nickname":"code","note":"","ucode":"5E79F1D5C3A1CD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603473,"discussion_content":"https://github.com/iovisor/gobpf/blob/master/examples/bcc/execsnoop/execsnoop.go è¯»æºç çš„æ—¶å€™åˆšå¥½çœ‹è§äº†,å’Œæ¥¼ä¸»è¯´çš„ä¸€æ ·","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1676218121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550335,"ip_address":"æ±Ÿè‹","group_id":0},"score":603473,"extra":""}]}]},{"had_liked":false,"id":338208,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1647354056,"is_pvip":true,"replies":[{"id":123956,"content":"ä»æœ€ç»ˆéƒ¨ç½²çš„è§’åº¦æ¥çœ‹æ˜¯çš„ï¼Œä½†å¯¹å…¥é—¨è€…æ¥è¯´BCCæ›´ç®€å•ä¸€äº›","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1647958765,"ip_address":"","comment_id":338208,"utype":1}],"discussion_count":4,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"golang + libbpf æ˜¯ä¸æ˜¯æ¯”BCC æ–¹æ¡ˆæ›´å¥½ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557768,"discussion_content":"ä»æœ€ç»ˆéƒ¨ç½²çš„è§’åº¦æ¥çœ‹æ˜¯çš„ï¼Œä½†å¯¹å…¥é—¨è€…æ¥è¯´BCCæ›´ç®€å•ä¸€äº›","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1647958765,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1047637,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYWRmibTZj9pb3d5ibfVQHFS9shvJmgMgtN3BM3r9qiaL5YTZSFdLvPZiaEHfBia4dFODVqw/132","nickname":"åŒ—å›½éª‘å£«","note":"","ucode":"AC657FCA2014ED","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559815,"discussion_content":"åˆçœ‹åˆ°çš®æ€»äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648986771,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1047637,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYWRmibTZj9pb3d5ibfVQHFS9shvJmgMgtN3BM3r9qiaL5YTZSFdLvPZiaEHfBia4dFODVqw/132","nickname":"åŒ—å›½éª‘å£«","note":"","ucode":"AC657FCA2014ED","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":559814,"discussion_content":"åˆçœ‹åˆ°çš®æ€»äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648986770,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1066752,"avatar":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","nickname":"piboye","note":"","ucode":"7CFD8712857A85","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1047637,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJcwXucibksEYWRmibTZj9pb3d5ibfVQHFS9shvJmgMgtN3BM3r9qiaL5YTZSFdLvPZiaEHfBia4dFODVqw/132","nickname":"åŒ—å›½éª‘å£«","note":"","ucode":"AC657FCA2014ED","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":564042,"discussion_content":"åˆçœ‹åˆ°æ¶›å“¥äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1650150710,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":559814,"ip_address":"","group_id":0},"score":564042,"extra":""}]}]},{"had_liked":false,"id":335251,"user_name":"ä¸äº†å³°","can_delete":false,"product_type":"c1","uid":1013424,"ip_address":"","ucode":"E23B96D6A3D4EC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/b0/14fec62f.jpg","comment_is_top":false,"comment_ctime":1645427027,"is_pvip":false,"replies":[{"id":122627,"content":"è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè·ŸCè¯­è¨€ä¸€æ ·ï¼Œå¤´æ–‡ä»¶ç”¨æ¥æ”¾ç±»å‹å®šä¹‰å’Œå¸¸é‡å®šä¹‰ã€‚\n\næ–‡ä»¶çš„æºç è§ https:&#47;&#47;github.com&#47;feiskyer&#47;ebpf-apps&#47;blob&#47;main&#47;bpf-apps&#47;execsnoop.h","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1645615565,"ip_address":"","comment_id":335251,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¯·æ•™ä¸€ä¸‹æ–‡ç« ä¸­å…³äº ã€Œlibbpf æ–¹æ³•ã€\nä¸ºä»€ä¹ˆ æ–‡ç« ä¸­æ²¡æœ‰æåŠ  execsnoop.h  è¿™ä¸ªæ–‡ä»¶ã€‚ã€‚\nè€Œ  execsnoop.bpf.c è¦ #include &quot;execsnoop.h&quot;  è¿™ä¸ªæ–‡ä»¶ ï¼Ÿ\n å…³äº  execsnoop.h  æ–‡ä»¶å†…å®¹ç”Ÿæˆï¼Œæ˜¯ä¸æ˜¯åœ¨å‰é¢çš„å‡ ç« æœ‰æ¶‰åŠï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552858,"discussion_content":"è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œè·ŸCè¯­è¨€ä¸€æ ·ï¼Œå¤´æ–‡ä»¶ç”¨æ¥æ”¾ç±»å‹å®šä¹‰å’Œå¸¸é‡å®šä¹‰ã€‚\n\næ–‡ä»¶çš„æºç è§ https://github.com/feiskyer/ebpf-apps/blob/main/bpf-apps/execsnoop.h","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645615565,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332935,"user_name":"å†™ç‚¹å•¥å‘¢","can_delete":false,"product_type":"c1","uid":1065272,"ip_address":"","ucode":"C19032CF1C41BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","comment_is_top":false,"comment_ctime":1643854693,"is_pvip":false,"replies":[{"id":121733,"content":"1. eBPFç¨‹åºæ˜¯åœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œï¼Œå¯ä»¥åœ¨å†…æ ¸ç©ºé—´è·å¾—è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚\n2. è¿™äº›å…·ä½“çš„æ­¥éª¤å¯ä»¥å‚è€ƒ https:&#47;&#47;github.com&#47;libbpf&#47;libbpfã€‚æ¯”å¦‚ï¼Œhttps:&#47;&#47;github.com&#47;libbpf&#47;libbpf&#47;blob&#47;master&#47;src&#47;libbpf.c#L8599-L8675 è¿™å„¿å®šä¹‰äº†æ‰€æœ‰ä¸åŒç¨‹åºç±»å‹æ‰€å¯¹åº”çš„ SEC åç§°åŠæŒ‚è½½æ–¹å¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644117461,"ip_address":"","comment_id":332935,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¯·æ•™ä¸‹è€å¸ˆï¼š\n1. bpfçš„è¾…åŠ©å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯åœ¨å½“å‰è¿›ç¨‹ä¸‹ä¹ˆï¼Œå› ä¸ºæˆ‘çœ‹åƒexecsnoopä¾‹å­ä¸­get_current_pid_tgidè°ƒç”¨èƒ½æ‹¿åˆ°çš„æ˜¯æ–°å¯åŠ¨è¿›ç¨‹pidã€‚\n2. libbpfçš„å¼€å‘æ¨¡å¼èƒ½çœ‹åˆ°ä»ç¼–è¯‘å™¨åˆ°bpfåœ¨èƒŒååšäº†å¾ˆå¤šå·¥ä½œï¼Œå¦‚æœæƒ³äº†è§£bpfç¨‹åºçš„å®ç°ï¼Œæ¯”å¦‚å®æ˜¯å¦‚ä½•å®šä¹‰äº†æ˜ å°„å’ŒæŒ‚è½½ç‚¹ï¼Œç¨‹åºåŠ è½½çš„æ—¶å€™å¦‚ä½•ä»ç¨‹åºæ®µä¸­çš„ä¿¡æ¯å®ç°çš„æ˜ å°„åˆ›å»ºå’ŒæŒ‚è½½ï¼Œè€å¸ˆèƒ½å¦ç»™æŒ‡ä¸€ä¸ªå­¦ä¹ è·¯å¾„ï¼Ÿè°¢è°¢å•¦","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549593,"discussion_content":"1. eBPFç¨‹åºæ˜¯åœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œï¼Œå¯ä»¥åœ¨å†…æ ¸ç©ºé—´è·å¾—è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚\n2. è¿™äº›å…·ä½“çš„æ­¥éª¤å¯ä»¥å‚è€ƒ https://github.com/libbpf/libbpfã€‚æ¯”å¦‚ï¼Œhttps://github.com/libbpf/libbpf/blob/master/src/libbpf.c#L8599-L8675 è¿™å„¿å®šä¹‰äº†æ‰€æœ‰ä¸åŒç¨‹åºç±»å‹æ‰€å¯¹åº”çš„ SEC åç§°åŠæŒ‚è½½æ–¹å¼ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1644117461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1065272,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","nickname":"å†™ç‚¹å•¥å‘¢","note":"","ucode":"C19032CF1C41BA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":549602,"discussion_content":"è°¢è°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644119436,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":549593,"ip_address":"","group_id":0},"score":549602,"extra":""}]},{"author":{"id":1010922,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6c/ea/ce9854a5.jpg","nickname":"å¤","note":"","ucode":"74E6838226A405","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607035,"discussion_content":"æ‰€ä»¥å¹¶ä¸æ˜¯æ‰€æœ‰çš„ tracepoint å’Œ kprobe éƒ½ç”¨ SECï¼ˆtracepoint/ï¼‰æ ¼å¼, æ¯”å¦‚ SEC(sockops)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677569968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368994,"user_name":"é¾è¦","can_delete":false,"product_type":"c1","uid":1000076,"ip_address":"æ±Ÿè‹","ucode":"BE1D500833F070","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/8c/373d4027.jpg","comment_is_top":false,"comment_ctime":1676983111,"is_pvip":true,"replies":[{"id":134616,"content":"è¿™æ˜¯ä¾èµ–åº“æ²¡æœ‰å®‰è£…å¯¼è‡´çš„ï¼Œè¯·å‚è€ƒREADMEçš„æ­¥éª¤å®‰è£…ä¾èµ–åº“","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1677497442,"ip_address":"ä¸Šæµ·","comment_id":368994,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æœ€æ–°çš„ä»£ç  https:&#47;&#47;github.com&#47;feiskyer&#47;ebpf-apps&#47;tree&#47;b89ae0f\næ‰§è¡Œ make å‡ºé”™ï¼Œè¿™æ˜¯ gcc-toolset å¯¼è‡´å—ï¼Ÿè€å¸ˆï¼Œå„ä½åŒ\nå­¦æ˜¯å¦é‡åˆ°è¿‡ï¼Ÿ\n\n```\n[root@Rocky-9 bpf-apps]# make\nclang -g -O2 -target bpf -D__TARGET_ARCH_x86 -Ilibbpf&#47;usr&#47;include -I..&#47;libbpf&#47;include&#47;uapi -I&#47;usr&#47;include&#47;x86_64-linux-gnu -I. -c hello.bpf.c -o hello.bpf.o\n&#47;usr&#47;sbin&#47;bpftool gen skeleton hello.bpf.o &gt; hello.skel.h\nclang -g -O2 -Wall -Ilibbpf&#47;usr&#47;include -I..&#47;libbpf&#47;include&#47;uapi -I&#47;usr&#47;include&#47;x86_64-linux-gnu -I. -c hello.c -o hello.o\nclang -Wall -O2 -g hello.o -static &#47;root&#47;ebpf-apps&#47;bpf-apps&#47;libbpf&#47;libbpf.a -lelf -lz -o hello\n&#47;usr&#47;bin&#47;ld: cannot find -lelf\n&#47;usr&#47;bin&#47;ld: cannot find -lz\n&#47;usr&#47;bin&#47;ld: cannot find -lc\nclang-14: error: linker command failed with exit code 1 (use -v to see invocation)\nmake: *** [Makefile:14: hello] Error 1\n[root@Rocky-9 bpf-apps]#\n[root@Rocky-9 bpf-apps]# clang -v\nclang version 14.0.6 (Red Hat 14.0.6-4.el9_1)\nTarget: x86_64-redhat-linux-gnu\nThread model: posix\nInstalledDir: &#47;usr&#47;bin\nFound candidate GCC installation: &#47;opt&#47;rh&#47;gcc-toolset-12&#47;root&#47;usr&#47;lib&#47;gcc&#47;x86_64-redhat-linux&#47;12\nSelected GCC installation: &#47;opt&#47;rh&#47;gcc-toolset-12&#47;root&#47;usr&#47;lib&#47;gcc&#47;x86_64-redhat-linux&#47;12\nCandidate multilib: .;@m64\nCandidate multilib: 32;@m32\nSelected multilib: .;@m64\n```","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606924,"discussion_content":"è¿™æ˜¯ä¾èµ–åº“æ²¡æœ‰å®‰è£…å¯¼è‡´çš„ï¼Œè¯·å‚è€ƒREADMEçš„æ­¥éª¤å®‰è£…ä¾èµ–åº“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677497443,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2308893,"avatar":"https://static001.geekbang.org/account/avatar/00/23/3b/1d/cbfbd93e.jpg","nickname":"å°å°_zoe","note":"","ucode":"28BA9118B60361","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":614495,"discussion_content":"å¤±è´¥åŸå› :sysakç¼ºå°‘ä¾èµ–åŒ…ï¼šelfutils-devel-static.x86_64ï¼Œzlib-static.x86_64ï¼Œglibc-static.x86_64\n\nè§£å†³æ–¹æ³•ï¼š\nyum install elfutils-devel-static.x86_64 -y\nyum install zlib-static.x86_64 -y\nyum install glibc-static.x86_64 -y","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681807702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338419,"user_name":"ä»è¿œæ–¹è¿‡æ¥","can_delete":false,"product_type":"c1","uid":1797551,"ip_address":"","ucode":"4791DBC7E05B1D","user_header":"","comment_is_top":false,"comment_ctime":1647492514,"is_pvip":false,"replies":[{"id":124033,"content":"æœ‰æ—¶å€™å‘½ä»¤åè·Ÿsyscallåå­—ä¸æ˜¯ä¸€è‡´çš„ï¼Œæ¯”å¦‚chmodå‘½ä»¤å¾ˆå¯èƒ½ä½¿ç”¨çš„æ˜¯fchmodatè€Œä¸æ˜¯chmodç³»ç»Ÿè°ƒç”¨","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1648038559,"ip_address":"","comment_id":338419,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œæˆ‘è¿è¡Œä¸‹é¢çš„ä»£ç ï¼Œåœ¨å¦å¤–ä¸€ä¸ªshellä¸Šé¢æ‰§è¡Œchmodå‘½ä»¤ï¼Œä½†æ˜¯bccå´æ²¡æœ‰è¾“å‡ºï¼Œè¯·é—®è¿™ä¸ªæ˜¯ä»€ä¹ˆåŸå› ?\n\nå†…æ ¸ç‰ˆæœ¬ï¼š 4.14.15-1.el7.elrepo.x86_64\næ“ä½œç³»ç»Ÿï¼š CentOS Linux release 7.9.2009 (Core)\nbccç‰ˆæœ¬ï¼šbcc-0.21.0-1.el7.x86_64\n               bcc-tools-0.21.0-1.el7.x86_64\n               python-bcc-0.21.0-1.el7.noarch\n\n\n#!&#47;usr&#47;bin&#47;env python3\n# Tracing execve() system call.\nfrom bcc import BPF\nfrom bcc.utils import printb\n\n\nchmod_prog = &quot;&quot;&quot;\n&#47;* Tracing execve system call. *&#47;\n#include &lt;uapi&#47;linux&#47;ptrace.h&gt;\n#include &lt;linux&#47;sched.h&gt;\n#include &lt;linux&#47;fs.h&gt;\n\n\n&#47;&#47; perf event map (sharing data to userspace) and hash map (sharing data between tracepoints)\nstruct data_t {\n\tu32 pid;\n\tumode_t mode;\n\tchar * filename;\n};\nBPF_PERF_OUTPUT(events);  &#47;&#47; ç”Ÿæˆä¸€ä¸ªeventäº‹ä»¶\n&#47;&#47; BPF_HASH(tasks, u32, struct data_t);\n\n\n&#47;&#47; sys_enter_chmod tracepoint.\nTRACEPOINT_PROBE(syscalls, sys_enter_chmod)\n{\n\n\n\tstruct data_t data = {};\n\tu32 pid = bpf_get_current_pid_tgid();\n\tumode_t mode = args-&gt;mode;\n\tchar * filename = (char *)args-&gt;filename;\n\tdata.pid = pid ;\n\tdata.mode = mode; \n\tdata.filename = filename;\n\n\tevents.perf_submit(args, &amp;data, sizeof(data)); \n\treturn 0;\n}\n\n\n&quot;&quot;&quot;\n\n# 1) load BPF program\nb = BPF(text=chmod_prog)\n# b = BPF(src_file=&quot;chmod.c&quot;)\n\n# 2) print header\nprint(&quot;%-6s %-16s %-3s %s&quot; % (&quot;PID&quot;, &quot;COMM&quot;, &quot;RET&quot;, &quot;ARGS&quot;))\n\n\n# 3) define the callback for perf event\ndef print_event(cpu, data, size):\n    # event data struct is generated from &quot;struct data_t&quot; by bcc\n    event = b[&quot;events&quot;].event(data)\n    printb(b&quot;%-6d %-16s %-3d&quot; % (event.pid, event.mode, event.filename))\n\n\n# 4) loop with callback to print_event\nb[&quot;events&quot;].open_perf_buffer(print_event)\nwhile 1:\n    try:\n        b.perf_buffer_poll()\n    except KeyboardInterrupt:\n        exit()\n\n\n\n\n\n","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557991,"discussion_content":"æœ‰æ—¶å€™å‘½ä»¤åè·Ÿsyscallåå­—ä¸æ˜¯ä¸€è‡´çš„ï¼Œæ¯”å¦‚chmodå‘½ä»¤å¾ˆå¯èƒ½ä½¿ç”¨çš„æ˜¯fchmodatè€Œä¸æ˜¯chmodç³»ç»Ÿè°ƒç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648038559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2025073,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIurXewVibKmjwSZW8JLrXuMEuxcHEZKD1fxFOctj3eR7KliceyRzsDqib0khtlVpOJTnucM9mzLsVYg/132","nickname":"é»„é¾™","note":"","ucode":"120B05F427CB4D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575238,"discussion_content":"è€å¸ˆï¼Œæ‚¨å¥½ï¼Œfilename å’Œ è¿›ç¨‹åï¼Œå¦‚ä½•åœ¨ebpfç¨‹åºä¸­ï¼Œè½¬æ¢æˆç»å¯¹è·¯å¾„å‘¢ï¼Ÿ æäº†å‡ å¤© éƒ½æ²¡æœ‰æå®š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654680653,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335058,"user_name":"heyhd9475","can_delete":false,"product_type":"c1","uid":2682873,"ip_address":"","ucode":"3CDB4DC5BF0FEB","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eq30mvo0eATZ3Yfm5POktwic3NJSRkiagtJt1vaxyvCS22PJRm8xrulXqaLJRWQWb6zNI4zL0G2QkCA/132","comment_is_top":false,"comment_ctime":1645277292,"is_pvip":false,"replies":[{"id":122629,"content":"çœ‹èµ·æ¥æ˜¯éªŒè¯å™¨è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ— ç•Œçš„å˜é‡ï¼Œä½ çš„å†…æ ¸ç‰ˆæœ¬å’ŒBCCç‰ˆæœ¬æ˜¯ä»€ä¹ˆï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1645615943,"ip_address":"","comment_id":335058,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘æƒ³è¯·é—®ä¸ºä»€ä¹ˆæ¯æ¬¡ä½¿ç”¨bpf_probe_read_user_str()è¯»å–åä¸åœ¨æ¯æ¬¡è¯»å–åˆ°çš„å‚æ•°ä¸­é—´åŠ ä¸Šä¸€ä¸ªç©ºæ ¼å‘¢ï¼Œæˆ‘è¿™è¾¹å°è¯•åŠ è¿™ä¸ªç©ºæ ¼ï¼Œä¸ºä»€ä¹ˆä¼šæç¤ºå¦‚ä¸‹çš„æ— æ•ˆæ— é™åˆ¶å¯å˜åç§»é‡æ ˆå†™å…¥å‘¢ï¼š\ninvalid unbounded variable-offset write to stack R2\n\næŠ¥é”™çš„æºç ä¸º: data.args[data.next_arg_index-1]=&#39; &#39;;\næ˜¯å› ä¸ºbccè®¤ä¸ºå‚æ•°data.next_arg_indexæ˜¯æ²¡æœ‰é™åˆ¶èŒƒå›´çš„ï¼Œä¸å®‰å…¨çš„å—ã€‚","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552860,"discussion_content":"çœ‹èµ·æ¥æ˜¯éªŒè¯å™¨è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ— ç•Œçš„å˜é‡ï¼Œä½ çš„å†…æ ¸ç‰ˆæœ¬å’ŒBCCç‰ˆæœ¬æ˜¯ä»€ä¹ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645615943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334621,"user_name":"hjydxy","can_delete":false,"product_type":"c1","uid":1258714,"ip_address":"","ucode":"A1340360926734","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ibYCL2nbctJDpBLwZXlKIX7Z4XUicBm1ibIbLd0dWMYibxtshnEzOWAl5LC7JgMcjSet5B30s2HUpiabhYyyFWiaWd1Q/132","comment_is_top":false,"comment_ctime":1645021343,"is_pvip":false,"replies":[{"id":122617,"content":"è¿™æ˜¯ä¸€ä¸ªå°è£…åçš„å‡½æ•°ï¼Œä½¿ç”¨èµ·æ¥æ›´ç®€å•ï¼ˆå½“ç„¶ç›´æ¥ç”¨bpf_object__loadä¹Ÿæ˜¯æ²¡é—®é¢˜çš„)ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1645611135,"ip_address":"","comment_id":334621,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è€å¸ˆå¥½ï¼š\n       åœ¨è¿™ä¸ªÂ execsnoop.skel.hÂ æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªâ€œexecsnoop_bpf__loadâ€å‡½æ•°ï¼Œä½ åœ¨è¯´æ˜ä¸­ä¹Ÿè¯´äº†è¿™ä¸ªå‡½æ•°æ˜¯åŠ è½½ebpfç¨‹åºç”¨çš„ï¼Œæˆ‘æƒ³è¯·æ•™ä¸‹è¿™ä¸ªå‡½æ•°å’Œ&#47;samples&#47;bpf&#47;ä¸‹ä¾‹å­ä¸­ä½¿ç”¨çš„â€œbpf_object__loadâ€æœ‰ä»€ä¹ˆåŒºåˆ«å’Œè”ç³»ï¼Œæˆ‘çš„ç†è§£æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨å·®ä¸å¤šï¼Œéƒ½æ˜¯åŠ è½½ebpfç¨‹åºç”¨çš„ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œä½¿ç”¨â€œexecsnoop_bpf__loadâ€çš„æ„ä¹‰æˆ–è€…å¥½å¤„åœ¨å“ªé‡Œï¼Ÿè°¢è°¢ã€‚","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552843,"discussion_content":"è¿™æ˜¯ä¸€ä¸ªå°è£…åçš„å‡½æ•°ï¼Œä½¿ç”¨èµ·æ¥æ›´ç®€å•ï¼ˆå½“ç„¶ç›´æ¥ç”¨bpf_object__loadä¹Ÿæ˜¯æ²¡é—®é¢˜çš„)ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645611136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333533,"user_name":"c1","can_delete":false,"product_type":"c1","uid":2658454,"ip_address":"","ucode":"27E704C694D710","user_header":"http://thirdwx.qlogo.cn/mmopen/KFgDEHIEpnT0EXnh02VHqHfsle3u6lJUYWjdOtBovSrfHyLwQcKiaicibGia2MJBX8uyicw3prPrcqWhJy9fUCCz1DVFYH0QHAYXc/132","comment_is_top":false,"comment_ctime":1644396356,"is_pvip":false,"replies":[{"id":122039,"content":"æœ‰æ²¡æœ‰å¼•å…¥å¤´æ–‡ä»¶ï¼Ÿå®Œæ•´çš„ç¨‹åºå¯ä»¥å‚è€ƒGithubï¼š https:&#47;&#47;github.com&#47;feiskyer&#47;ebpf-apps&#47;blob&#47;main&#47;bcc-apps&#47;python&#47;execsnoop.c#L2-L4ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644732296,"ip_address":"","comment_id":333533,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"è¯·æ•™ï¼š\nUbuntu 21.10\nLinux u21 5.13.0-28-generic #31-Ubuntu SMP Thu Jan 13 17:41:06 UTC 2022 x86_64 x86_64 x86_64 GNU&#47;Linux\n\næ‰§è¡Œexecsnoop.pyæŠ¥é”™ï¼š\n...\n&#47;virtual&#47;main.c:47:42: error: incomplete definition of type &#39;struct tracepoint__syscalls__sys_enter_execve&#39;\n        const char **argv = (const char **)(args-&gt;argv);\n...\n&#47;virtual&#47;main.c:82:22: error: incomplete definition of type &#39;struct tracepoint__syscalls__sys_exit_execve&#39;\n                data-&gt;retval = args-&gt;ret;\n...","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550793,"discussion_content":"æœ‰æ²¡æœ‰å¼•å…¥å¤´æ–‡ä»¶ï¼Ÿå®Œæ•´çš„ç¨‹åºå¯ä»¥å‚è€ƒGithubï¼š https://github.com/feiskyer/ebpf-apps/blob/main/bcc-apps/python/execsnoop.c#L2-L4ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644732296,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1674369,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqf54z1ZmqQY1kmJ6t1HAnrqMM3j6WKf0oDeVLhtnA2ZUKY6AX9MK6RjvcO8SiczXy3uU0IzBQ3tpw/132","nickname":"Geek_68d3d2","note":"","ucode":"EBD6D881AA7A74","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":628253,"discussion_content":"ä»–è¿™ä¸ªæ˜¯libbpfæ–¹å¼ç¼–è¯‘çš„ï¼Œæˆ‘ä½¿ç”¨libbpfä¹Ÿè¿™æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695118323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":550793,"ip_address":"åŒ—äº¬","group_id":0},"score":628253,"extra":""}]}]},{"had_liked":false,"id":332934,"user_name":"Haric","can_delete":false,"product_type":"c1","uid":1317508,"ip_address":"","ucode":"E2E7977ECC83A4","user_header":"https://static001.geekbang.org/account/avatar/00/14/1a/84/c6316817.jpg","comment_is_top":false,"comment_ctime":1643850673,"is_pvip":false,"replies":[{"id":121734,"content":"å¦‚æœå†…æ ¸ä¹Ÿæ”¯æŒBTFçš„è¯ï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯å¯ä»¥è¿è¡Œçš„ï¼›ä½†å¦‚æœå†…æ ¸ç‰ˆæœ¬æ¯”è¾ƒæ—§çš„è¯ï¼Œå¯èƒ½ä¸æ”¯æŒBTFï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨æ¡ä»¶ç¼–è¯‘çš„æ–¹å¼ï¼Œä¸ºæ—§ç‰ˆæœ¬å†…æ ¸å…³é—­BTFã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1001282,"ctime":1644117537,"ip_address":"","comment_id":332934,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"æ–‡ç« æåˆ°ï¼Œä½¿ç”¨libbfpæ–¹å¼åœ¨å¼€å¯äº† BTF çš„å…¶ä»–æœºå™¨éƒ½å¯ä»¥è¿è¡Œï¼Œè¯·é—®åœ¨åµŒå…¥å¼è®¾å¤‡ï¼ˆéœ€è¦äº¤å‰ç¼–è¯‘ï¼‰èƒ½è¿è¡Œå—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549594,"discussion_content":"å¦‚æœå†…æ ¸ä¹Ÿæ”¯æŒBTFçš„è¯ï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯å¯ä»¥è¿è¡Œçš„ï¼›ä½†å¦‚æœå†…æ ¸ç‰ˆæœ¬æ¯”è¾ƒæ—§çš„è¯ï¼Œå¯èƒ½ä¸æ”¯æŒBTFï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨æ¡ä»¶ç¼–è¯‘çš„æ–¹å¼ï¼Œä¸ºæ—§ç‰ˆæœ¬å†…æ ¸å…³é—­BTFã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644117537,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341694,"user_name":"CaptainZhao","can_delete":false,"product_type":"c1","uid":1062544,"ip_address":"","ucode":"5F3FB0F1B8D0EB","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/90/55e8cb1b.jpg","comment_is_top":false,"comment_ctime":1649772514,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"æ‚¨å¥½ï¼Œæˆ‘æœ€è¿‘å°è¯•ç”¨iovisor&#47;gobpfå†™golangçš„bccç¨‹åºï¼Œç”¨bccçš„runqlatæ”¹æˆäº†ç”¨æˆ·æ€æ˜¯golangçš„å®ç°ï¼Œè€ƒè™‘é•¿æ—¶é—´è·‘å¯èƒ½ä¼šå¯¹cfsæ€§èƒ½æœ‰å½±å“ï¼Œäºæ˜¯å°è¯•å†™æˆæ¯15ç§’å¼€å§‹é‡‡é›†ï¼Œç„¶åè·‘100æ¯«ç§’å…³é—­çš„æ–¹å¼ã€‚å¤§æ¦‚æ˜¯bcc.NewModule -&gt; load -&gt; attach -&gt; module.Close()ï¼Œä½†æ˜¯å‘ç°å†…å­˜æŒç»­åœ°ä¸Šæ¶¨ï¼Œç”¨pprofçœ‹äº†ä¸€ä¸‹ç¡®å®šä¸æ˜¯golangçš„å†…å­˜åœ¨ä¸Šæ¶¨ï¼Œç”¨memleakçœ‹äº†ä¸€ä¸‹å¥½åƒæ˜¯NewModuleç¼–è¯‘é˜¶æ®µllvm&#47;clangå¾ˆå¤šå†…å­˜æ²¡é‡Šæ”¾ï¼Œè¿™ä¸ªé—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ","like_count":2},{"had_liked":false,"id":379405,"user_name":"å¼ ä¸‰","can_delete":false,"product_type":"c1","uid":1993376,"ip_address":"ä¸Šæµ·","ucode":"BBC62AB683CCF6","user_header":"https://static001.geekbang.org/account/avatar/00/1e/6a/a0/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1691911276,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è¯·é—®trace_event_raw_sys_enterï¼Œtrace_event_raw_sys_exitè¿™ä¸¤ä¸ªå…¥å‚æ˜¯ç”±ä»€ä¹ˆå†³å®šçš„ï¼Ÿçœ‹åˆ°å…¶å®ƒåœ°æ–¹æœ‰void *çš„å…¥å‚ï¼Œä¹Ÿæœ‰å…¶å®ƒå…¥å‚","like_count":1,"discussions":[{"author":{"id":2659191,"avatar":"","nickname":"Geek_1a3949","note":"","ucode":"98113FDBBAAEBC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631131,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1699324060,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394774,"user_name":"æ·±æ¸…ç§‹","can_delete":false,"product_type":"c1","uid":2320426,"ip_address":"æ¹–åŒ—","ucode":"1316C7F7C37B04","user_header":"https://static001.geekbang.org/account/avatar/00/23/68/2a/f16befce.jpg","comment_is_top":false,"comment_ctime":1728298809,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"åœ¨é«˜ç‰ˆæœ¬ubuntu 6.8.0-40-genericä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šæŠ¥é”™ï¼šclang -Wall -O2 -g execsnoop.o -static -lbpf -lelf -lz -o execsnoop\n\næŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š\n&#47;usr&#47;bin&#47;ld: &#47;lib&#47;x86_64-linux-gnu&#47;libelf.a(elf_compress.o): in function `__libelf_compress&#39;:\n(.text+0x113): undefined reference to `ZSTD_createCCtx&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x2a9): undefined reference to `ZSTD_compressStream2&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x2b4): undefined reference to `ZSTD_isError&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x2db): undefined reference to `ZSTD_freeCCtx&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x5a0): undefined reference to `ZSTD_compressStream2&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x5ab): undefined reference to `ZSTD_isError&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x6b9): undefined reference to `ZSTD_freeCCtx&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x835): undefined reference to `ZSTD_freeCCtx&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x86f): undefined reference to `ZSTD_freeCCtx&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0x91b): undefined reference to `ZSTD_freeCCtx&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0xa12): undefined reference to `ZSTD_freeCCtx&#39;\n&#47;usr&#47;bin&#47;ld: &#47;lib&#47;x86_64-linux-gnu&#47;libelf.a(elf_compress.o): in function `__libelf_decompress&#39;:\n(.text+0xbfc): undefined reference to `ZSTD_decompress&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0xc04): undefined reference to `ZSTD_isError&#39;\n&#47;usr&#47;bin&#47;ld: &#47;lib&#47;x86_64-linux-gnu&#47;libelf.a(elf_compress.o): in function `__libelf_decompress_elf&#39;:\n(.text+0xd45): undefined reference to `ZSTD_decompress&#39;\n&#47;usr&#47;bin&#47;ld: (.text+0xd4d): undefined reference to `ZSTD_isError&#39;\n\nå»ºè®®å»æ‰ -static ç¼–è¯‘é€‰é¡¹å³å¯ï¼š clang -Wall -O2 -g execsnoop.o -lbpf -lelf -lz -o execsnoop\n","like_count":0},{"had_liked":false,"id":388916,"user_name":"å››äº”åˆå","can_delete":false,"product_type":"c1","uid":2267028,"ip_address":"å¹¿ä¸œ","ucode":"C7F8F020BE9AF8","user_header":"https://static001.geekbang.org/account/avatar/00/22/97/94/18d2ad82.jpg","comment_is_top":false,"comment_ctime":1711150382,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œæ‚¨å¥½ æˆ‘é‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼›\nroot@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# bpftool gen skeleton execsnoop_example.bpf.o &gt; execsnoop_example.skel.h\nlibbpf: elf: execsnoop_example_bpf is not a valid eBPF object file\nError: failed to open BPF object file: BPF object format invalid\n\nroot@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# uname -r\n5.15.0-91-generic\n\nroot@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# bpftool -V\n&#47;usr&#47;lib&#47;linux-tools&#47;5.15.0-91-generic&#47;bpftool v5.15.131\nfeatures:\nroot@VM-16-8-ubuntu:&#47;home&#47;ubuntu&#47;code&#47;execsnoop# clang -v\nUbuntu clang version 14.0.0-1ubuntu1.1\nTarget: x86_64-pc-linux-gnu\nThread model: posix\nInstalledDir: &#47;usr&#47;bin\nFound candidate GCC installation: &#47;usr&#47;bin&#47;..&#47;lib&#47;gcc&#47;x86_64-linux-gnu&#47;11\nSelected GCC installation: &#47;usr&#47;bin&#47;..&#47;lib&#47;gcc&#47;x86_64-linux-gnu&#47;11\nCandidate multilib: .;@m64\nSelected multilib: .;@m64\n\n","like_count":0},{"had_liked":false,"id":385463,"user_name":"Geek_46769f","can_delete":false,"product_type":"c1","uid":3039511,"ip_address":"æ±Ÿè‹","ucode":"F3B100B61B62C0","user_header":"","comment_is_top":false,"comment_ctime":1702647606,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œæƒ³é—®ä¸€ä¸‹\nSEC(&quot;tracepoint&#47;syscalls&#47;sys_enter_execve&quot;)\nint tracepoint__syscalls__sys_enter_execve(struct trace_event_raw_sys_enter *ctx)\nä¸­çš„å‚æ•°çš„ç»“æ„ä½“struct trace_event_raw_sys_enteræ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ","like_count":0},{"had_liked":false,"id":385462,"user_name":"Geek_46769f","can_delete":false,"product_type":"c1","uid":3039511,"ip_address":"æ±Ÿè‹","ucode":"F3B100B61B62C0","user_header":"","comment_is_top":false,"comment_ctime":1702647376,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸Šé¢çš„libbpfåˆ›å»ºäº†ä¸¤ä¸ªæ˜ å°„ï¼Œä¸€ä¸ªæ˜¯eventsä¸€ä¸ªæ˜¯execsï¼Œexecsè¿™ä¸ªæ˜ å°„åªæ˜¯åœ¨å…¥å£å¤„è·å–ä¸€äº›ä¿¡æ¯ï¼Œç„¶ååœ¨å‡ºå£å¤„æŸ¥è¯¢å…ƒç´ å†æ·»åŠ ä¸€äº›ä¿¡æ¯ï¼Œç„¶åå°†è¿™äº›ä¿¡æ¯æ”¾åˆ°eventsæ˜ å°„ä¸­ã€‚ä¸ºä»€ä¹ˆä¸å¯ä»¥åªä½¿ç”¨eventsä¸€ä¸ªæ˜ å°„æ¥å®Œæˆè¿™äº›è¿›ç¨‹ä¿¡æ¯çš„ä¿å­˜ä¾›ç”¨æˆ·æ€ç¨‹åºæŸ¥è¯¢ä½¿ç”¨å‘¢ï¼Ÿä¸æ˜¯è¯´æ˜ å°„å¯ä»¥è¢«ç”¨æˆ·æ€ç¨‹åºè·å–å—ï¼Ÿæ˜¯å› ä¸ºæ€§èƒ½æ˜ å°„çš„mapæ›´å…·ä¼˜åŠ¿å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":379731,"user_name":"å°å®","can_delete":false,"product_type":"c1","uid":3663183,"ip_address":"æµ™æ±Ÿ","ucode":"17252C5E4F44BB","user_header":"https://static001.geekbang.org/account/avatar/00/37/e5/4f/085cf5bd.jpg","comment_is_top":false,"comment_ctime":1692350957,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è¿™ä¸€ç« æ˜æ˜¾è®²å¤ªå¿«äº†","like_count":0},{"had_liked":false,"id":377648,"user_name":"Geek_e2ed4c","can_delete":false,"product_type":"c1","uid":3667575,"ip_address":"åŒ—äº¬","ucode":"F207AF3AA7E77B","user_header":"","comment_is_top":false,"comment_ctime":1688956584,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"ä¸ºå•¥å‰ç«¯å¼€å‘ä¸€å®šç”¨pythonå‘¢ï¼Ÿæœ‰å…¶å®ƒè¯­è¨€å¯é€‰æ‹©å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":376719,"user_name":"Gavin","can_delete":false,"product_type":"c1","uid":1616970,"ip_address":"å¹¿ä¸œ","ucode":"A5735665E303FD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/2UXuSevhia94o9Eky4OfMuSictaldxcqpjGuvRCOcvjIIoVBAENLEZbv2lgwmwC8icK1ZrUcneNtiaeFBV8MT3uzNg/132","comment_is_top":false,"comment_ctime":1687263011,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"è€å¸ˆå¸®å¿™çœ‹ä¸‹è¿™ä¸ªé—®é¢˜\n1. æŸ¥æ–°æ˜ å°„æœ‰å€¼\nâ””â”€$ sudo bpftool perf list events   \npid 147013  fd 7: prog_id 2443  tracepoint  sys_enter_execve\npid 147013  fd 9: prog_id 2444  tracepoint  sys_exit_execve\n\nâ””â”€$ sudo bpftool map dump name tasks\n[{\n        &quot;key&quot;: 147692,\n        &quot;value&quot;: {\n            &quot;pid&quot;: 147692,\n            &quot;comm&quot;: &quot;xfce4-panel-gen&quot;,\n            &quot;retval&quot;: 0,\n            &quot;args_size&quot;: 45,\n            &quot;argv&quot;: &quot;grep-o-P(?&lt;=inet )[0-9]{1,3}(\\n.[0-9]{1,3}){3}&quot;\n        }\n    },{\n        &quot;key&quot;: 147768,\n        &quot;value&quot;: {\n            &quot;pid&quot;: 147768,\n            &quot;comm&quot;: &quot;xfce4-panel-gen&quot;,\n            &quot;retval&quot;: 0,\n            &quot;args_size&quot;: 45,\n            &quot;argv&quot;: &quot;grep-o-P(?&lt;=inet )[0-9]{1,3}(\\n.[0-9]{1,3}){3}&quot;\n        }\n    },{\n\n2.pythonä¸è¾“å‡ºå†…å®¹\nâ””â”€$ sudo python execsnoop.py \nPID    COMM             RET ARGS\n","like_count":0},{"had_liked":false,"id":374763,"user_name":"Geek_d65e2a","can_delete":false,"product_type":"c1","uid":2286969,"ip_address":"æ±Ÿè‹","ucode":"D29DA4A0C50EEA","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eosHxJVt0mxwBOpxHd8z5enhfqDicuvUAe5Nlaxts0A9OZ0Kd4ZInr3icBA1aVOjmCicjS9IQNibHdPJw/132","comment_is_top":false,"comment_ctime":1684399436,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"åœ¨å†…æ ¸ç‰ˆæœ¬5.15.0-56-genericä¸­\nperf_buffer__newçš„å®šä¹‰ä¸º\nperf_buffer__new(int map_fd, size_t page_cnt,\n                 const struct perf_buffer_opts *opts);\néœ€è¦å°†optsçš„å®šä¹‰æ”¹ä¸ºï¼š\nconst struct perf_buffer_opts pb_opts = {handle_event, handle_lost_events, NULL};\n","like_count":0},{"had_liked":false,"id":371934,"user_name":"Bachue Zhou","can_delete":false,"product_type":"c1","uid":1494491,"ip_address":"ä¸Šæµ·","ucode":"3175754775CA32","user_header":"https://static001.geekbang.org/account/avatar/00/16/cd/db/7467ad23.jpg","comment_is_top":false,"comment_ctime":1680529640,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"æ²¡æœ‰ kmalloc çœŸçš„æ˜¯å¤ªéš¾å—äº†ã€‚","like_count":0},{"had_liked":false,"id":360048,"user_name":"å½­ä¸œæ—","can_delete":false,"product_type":"c1","uid":1252080,"ip_address":"å±±è¥¿","ucode":"C163053098CD91","user_header":"https://static001.geekbang.org/account/avatar/00/13/1a/f0/29721362.jpg","comment_is_top":false,"comment_ctime":1666151746,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"è€å¸ˆï¼Œæˆ‘åœ¨çœ‹pwruä»£ç æ˜¯çœ‹åˆ°ï¼š\nSEC(&quot;kprobe&#47;skb-1&quot;)\nint kprobe_skb_1(struct pt_regs *ctx) {\n\tstruct sk_buff *skb = (struct sk_buff *) PT_REGS_PARM1(ctx);\n\n\treturn handle_everything(skb, ctx);\n}\n\nSEC(&quot;kprobe&#47;skb-2&quot;)\nint kprobe_skb_2(struct pt_regs *ctx) {\n\tstruct sk_buff *skb = (struct sk_buff *) PT_REGS_PARM2(ctx);\n\n\treturn handle_everything(skb, ctx);\n}\n\næ‚¨çŸ¥é“ä¸Šé¢SEC(&quot;kprobe&#47;skb-1&quot;)æ˜¯ä»€ä¹ˆæ„æ€å—ï¼Ÿä»å†…æ ¸ä»£ç é‡Œå¹¶æ²¡æœ‰çœ‹åˆ°æœ‰&quot;skb-1&quot;è¿™ä¸ªå‡½æ•°","like_count":0},{"had_liked":false,"id":359006,"user_name":"å®‹ç¥¥","can_delete":false,"product_type":"c1","uid":2024201,"ip_address":"ç¦å»º","ucode":"2C0B8C40B52A17","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJicp0Ifiax9ibAduMW3SXibfvRkhC0lpPBZ6tEn7iaXIIK0VrG2VUibO1AFq4kDvGsbNqYia5gd7ZqgMnSw/132","comment_is_top":false,"comment_ctime":1665143956,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"å¯¹äºè¿™æ®µä»£ç ï¼š\n    &#47;&#47; submit to perf event\n    size_t len = EVENT_SIZE(event);\n    if (len &lt;= sizeof(*event))\n        bpf_perf_event_output(ctx, &amp;events, BPF_F_CURRENT_CPU, event,\n                              len);\n\n\n#define BASE_EVENT_SIZE (size_t)(&amp;((struct event*)0)-&gt;args)\n#define EVENT_SIZE(e) (BASE_EVENT_SIZE + e-&gt;args_size)\n\n\næœ‰ä»€ä¹ˆç‰¹æ®Šçš„å«ä¹‰å—ï¼Ÿä¸ºä»€ä¹ˆæäº¤åªæäº¤EVENT_SIZEå¤§å°","like_count":0},{"had_liked":false,"id":356840,"user_name":"A7kou","can_delete":false,"product_type":"c1","uid":1375996,"ip_address":"åŒ—äº¬","ucode":"86ABC9754D287B","user_header":"https://static001.geekbang.org/account/avatar/00/14/fe/fc/e56c9c4a.jpg","comment_is_top":false,"comment_ctime":1662630267,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œæƒ³è¯·é—®ä¸‹ï¼Œæˆ‘åœ¨ä»£ç å®šä¹‰ .maps æ˜ å°„æ—¶ï¼Œåªè¦æˆ‘åŠ äº† SEC(&quot;.maps&quot;) æœ€ååœ¨ç»™ tc å» attach çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼š\nstruct {\n  __uint(type, BPF_MAP_TYPE_HASH);\n  __uint(key_size, sizeof(__u32));\n  __uint(value_size, sizeof(__u32));\n} events SEC(&quot;.maps&quot;); &#47;&#47; åŠ äº†è¿™ä¸ª SEC(&quot;.maps&quot;) ä¸‹è¾¹å°±ä¸€å®šä¼šæŠ¥é”™\n\n\nroot@ding-test-2:~&#47;go&#47;src&#47;tmp&#47;test_c# tc filter add dev test_veth1 ingress bpf direct-action obj test.o\nlibbpf: BTF is required, but is missing or corrupted.\nERROR: opening BPF object file failed\nUnable to load program\n\n\nè¯·é—®ä¸‹è€å¸ˆçŸ¥é“è¿™æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ä¹ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1447129,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJibvQ9Dpib9EbBy6WCicjqTwGQ9CucFrYFHclCqAfp4ohNX4a7iagBibd8QoWygsB6IKELrjZ5nvJtktg/132","nickname":"Geek_1e4754","note":"","ucode":"996925D5E52A8B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":595953,"discussion_content":"OS è¦æŠŠ BTF æ‰“å¼€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1670507911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347432,"user_name":"å¢æ‰¿ç","can_delete":false,"product_type":"c1","uid":1672266,"ip_address":"","ucode":"80805A03308CA4","user_header":"https://static001.geekbang.org/account/avatar/00/19/84/4a/50940078.jpg","comment_is_top":false,"comment_ctime":1654010892,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"æ±‚åŠ©è€å¸ˆï¼Œæœ‰æ²¡æœ‰æœ€ä¼˜é›…çš„çªç ´512ä¸ªå­—èŠ‚çš„åŠæ³•æ¨èï¼Œæˆ–è€…ä»£ç åº“ä¾›å‚è€ƒ","like_count":0},{"had_liked":false,"id":346205,"user_name":"Geek_007","can_delete":false,"product_type":"c1","uid":1467182,"ip_address":"","ucode":"C80107538EAA7F","user_header":"https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg","comment_is_top":false,"comment_ctime":1652892439,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"libbpf ä¾‹å­ä¸­ï¼Œvmlinux.h æ˜¯ç”Ÿæˆçš„ï¼Œä½†æ˜¯ä¸‹é¢çš„ä¸‰ä¸ªå¤´æ–‡ä»¶åœ¨å“ªå‘¢ï¼Œæˆ‘è¿™é‡ŒæŠ¥é”™æ‰¾ä¸åˆ°å‘¢ã€‚ã€‚\n#include &lt;bpf&#47;bpf_core_read.h&gt;\n#include &lt;bpf&#47;bpf_helpers.h&gt;\n#include &lt;bpf&#47;bpf_tracing.h&gt;","like_count":0}]}