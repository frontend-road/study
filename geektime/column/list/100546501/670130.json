{"id":670130,"title":"28ï½œè®¤è¯æœºåˆ¶ï¼šFlaskè®¤è¯æœºåˆ¶è®¾è®¡ä¸å®ç°","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Barryã€‚</p><p>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬åˆæ­¥äº†è§£äº†Flaskè®¤è¯æœºåˆ¶ï¼Œä¹Ÿå®Œæˆäº†ä½¿ç”¨Tokenè¿›è¡Œè®¤è¯çš„å‰ç½®å·¥ä½œã€‚åœ¨æˆ‘ä»¬çš„è§†é¢‘ç›´æ’­å¹³å°ä¸­ï¼Œä¹Ÿéœ€è¦é€šè¿‡è®¤è¯æœºåˆ¶æ¥å®ç°ç”¨æˆ·çš„å¹³å°è®¤è¯å’Œå®‰å…¨ä¿éšœã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±è¿›å…¥é¡¹ç›®å®æˆ˜ç¯èŠ‚ï¼Œå·©å›ºä¸€ä¸‹ä½ å¯¹Flaskè®¤è¯æœºåˆ¶çš„åº”ç”¨èƒ½åŠ›ã€‚æ•´ä½“æµç¨‹åŒ…æ‹¬ç”ŸæˆTokenã€TokenéªŒè¯ã€ç™»å½•è®¤è¯å’Œç”¨æˆ·é‰´æƒè¿™å››ä¸ªç¯èŠ‚ã€‚</p><p>è®¤è¯çš„ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±ä»ç”ŸæˆTokenå¼€å§‹è¯´èµ·ã€‚</p><h2>ç”ŸæˆToken</h2><p><a href=\"https://time.geekbang.org/column/article/669871\">ä¸ŠèŠ‚è¯¾</a>ï¼Œæˆ‘ä»¬å­¦ä¹ è¿‡Tokenç»“æ„ï¼Œå®ƒæœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯headerï¼Œplayloadå’Œsignatureã€‚</p><p>åœ¨é¡¹ç›®ä¸­æˆ‘ä»¬å€ŸåŠ©Flaskçš„æ‰©å±•Flask-JWTæ¥ç”ŸæˆTokenï¼Œå…·ä½“å°±æ˜¯ä½¿ç”¨JWT.encodeå‡½æ•°å°†JSONå¯¹è±¡ç¼–ç ä¸ºJWT Tokenã€‚å› æ­¤ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£ä¸€ä¸‹JWT.encodeå‡½æ•°çš„å‚æ•°ï¼Œä½ å¯ä»¥å‚è€ƒåé¢æˆ‘ç”»çš„æ€ç»´å¯¼å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2b/da/2b08510cae1b9446918329388223edda.jpg?wh=1900x922\" alt=\"\"></p><p>ä½ æˆ–è®¸æ³¨æ„åˆ°äº†ï¼Œåœ¨JWT.encodeå‡½æ•°ä¸­åªä¼ å…¥äº†payloadéƒ¨åˆ†ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä½¿ç”¨JWT.encodeå‡½æ•°æ—¶ï¼Œä¼šè‡ªåŠ¨æ ¹æ®é»˜è®¤ç®—æ³•ç”ŸæˆHeaderéƒ¨åˆ†ï¼Œå¹¶å°†Headerå’ŒPayloadéƒ¨åˆ†è¿›è¡Œç­¾åç”Ÿæˆæœ€ç»ˆçš„Tokenå­—ç¬¦ä¸²ã€‚æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®šPayloadéƒ¨åˆ†ã€‚</p><p>å…·ä½“ç”ŸæˆTokençš„å®ç°ä»£ç æ˜¯åé¢è¿™æ ·ï¼Œä½ å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-python\">import time\nimport datetime\nimport jwt\nfrom flask import current_app\nfrom api import redis_store\nfrom api.models.user import UserLogin\nfrom api.utils import constants\nfrom api.utils.response_utils import error, HttpCode, success\nfrom config.config import Config\nclass Auth(object):\n    @staticmethod\n    # å£°æ˜ä¸ºé™æ€æ–¹æ³•\n    def encode_auth_token(user_id, login_time):\n        \"\"\"\n        ç”Ÿæˆè®¤è¯Token\n        :param user_id: int\n        :param login_time: int(timestamp)\n        :return: string\n        \"\"\"\n        try:\n            payload = {\n                'exp': datetime.datetime.utcnow() + datetime.timedelta(days=1),\n                'iat': datetime.datetime.utcnow(),\n                'iss': 'Barry',\n                'data': {\n                    'id': user_id,\n                    'login_time': login_time\n                }\n            }\n            return jwt.encode(\n                payload,\n                Config.SECRET_KEY,\n                algorithm='HS256'\n            )\n        except Exception as e:\n            print(e)\n            return error(code=HttpCode.auth_error, msg='æ²¡æœ‰ç”Ÿæˆå¯¹åº”çš„token')\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥è§£è¯»ä¸€ä¸‹è¿™æ®µä»£ç ã€‚å‡½æ•°å‰çš„@staticmethodè£…é¥°å™¨ï¼Œæˆ‘ä»¬å°†è¯¥æ–¹æ³•å£°æ˜ä¸ºé™æ€æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç±»çš„æ–¹æ³•å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œè€Œä¸éœ€è¦å†åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚</p><p>ç´§æ¥ç€æˆ‘ä»¬åœ¨encode_auth_tokenå‡½æ•°ä¸­ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·çš„user_idå’Œç”¨æˆ·ç™»å½•æ—¶é—´login_timeï¼Œç”¨æˆ·ç™»å½•æ—¶é—´ç”¨äºæ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸï¼Œä¿è¯æ—¶æ•ˆæ€§ã€‚ç„¶åæ˜¯Tokençš„æœ‰æ•ˆè´Ÿè½½payloadï¼Œå…¶ä¸­ä¸»è¦åŒ…æ‹¬Tokençš„è¿‡æœŸæ—¶é—´ã€ç­¾å‘æ—¶é—´ã€å‘è¡Œäººå’Œè‡ªå®šä¹‰æ•°æ®ã€‚åœ¨è‡ªå®šä¹‰æ•°æ®ä¸­ä¸¤ä¸ªå‚æ•°æ˜¯ç”¨æˆ·IDå’Œç™»å½•æ—¶é—´ã€‚</p><p>å…¶ä¸­çš„payloadä¸ºå­—å…¸ç±»å‹ï¼Œä»¥ä¾¿ä½œä¸ºå‚æ•°ä¼ å…¥encodeå‡½æ•°ä¸­ã€‚è¿™é‡Œä½¿ç”¨Config.SECRET_KEYä½œä¸ºåŠ å¯†ç”¨çš„å¯†é’¥ï¼Œé‡‡ç”¨HS256ç®—æ³•å¯¹JWTè¿›è¡ŒåŠ å¯†ã€‚HS256ç®—æ³•æ˜¯ä¸€ç§åŸºäºå“ˆå¸Œå‡½æ•°çš„å¯¹ç§°åŠ å¯†ç®—æ³•ã€‚å¦‚æœç”Ÿæˆè¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚è¿™é‡Œçš„auth_erroræ˜¯æˆ‘ä»¬ä¸ŠèŠ‚è¯¾è‡ªå®šä¹‰çš„HTTPçŠ¶æ€å‡½æ•°ã€‚</p><h2>éªŒè¯Token</h2><p>ç”ŸæˆTokençš„ä¸‹ä¸€æ­¥å°±æ˜¯Tokençš„éªŒè¯ã€‚æ–¹æ³•å°±æ˜¯å€ŸåŠ©JWTæ‰©å±•çš„decodeå‡½æ•°ï¼Œå°†å®¢æˆ·ç«¯å‘é€çš„Tokenè¿›è¡Œè§£ç ã€‚æˆ‘ä»¬è¿˜æ˜¯ç»“åˆä»£ç æ¥ç†è§£ã€‚</p><pre><code class=\"language-python\">@staticmethod\ndef decode_auth_token(auth_token):\n&nbsp; &nbsp; \"\"\"\n&nbsp; &nbsp; éªŒè¯Token\n&nbsp; &nbsp; :param auth_token:\n&nbsp; &nbsp; :return: integer|string\n&nbsp; &nbsp; \"\"\"\n&nbsp; &nbsp; try:\n&nbsp; &nbsp; &nbsp; &nbsp; # payload = jwt.decode(auth_token, Config.SECRET_KEY, leeway=datetime.timedelta(days=1))\n&nbsp; &nbsp; &nbsp; &nbsp; # å–æ¶ˆè¿‡æœŸæ—¶é—´éªŒè¯\n&nbsp; &nbsp; &nbsp; &nbsp; payload = jwt.decode(auth_token, Config.SECRET_KEY, options={'verify_exp': False})\n        # optionsï¼Œä¸è¦æ‰§è¡Œè¿‡æœŸæ—¶é—´éªŒè¯\n&nbsp; &nbsp; &nbsp; &nbsp; if 'data' in payload and 'id' in payload['data']:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return dict(code=HttpCode.ok, payload=payload)\n&nbsp; &nbsp; &nbsp; &nbsp; else:\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise dict(code=HttpCode.auth_error, msg=jwt.InvalidTokenError)\n&nbsp; &nbsp; except jwt.ExpiredSignatureError:\n&nbsp; &nbsp; &nbsp; &nbsp; return dict(code=HttpCode.auth_error, msg='Tokenè¿‡æœŸ')\n&nbsp; &nbsp; except jwt.InvalidTokenError:\n&nbsp; &nbsp; &nbsp; &nbsp; return dict(code=HttpCode.auth_error, msg='æ— æ•ˆToken')\n</code></pre><p>ä¸Šé¢ä»£ç åŒæ ·æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œä¸»è¦ç”¨äºéªŒè¯JWT tokençš„æœ‰æ•ˆæ€§ã€‚é¦–å…ˆä»ä¼ å…¥çš„auth_tokenå‚æ•°ä¸­è§£ç tokenï¼Œä½¿ç”¨ä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­çš„SECRET_KEYæ¥è§£ç ï¼Œoptionsé€‰é¡¹è¡¨ç¤ºåœ¨éªŒè¯tokençš„è¿‡æœŸæ—¶é—´æ—¶ï¼Œä¸è¦æ‰§è¡Œè¿‡æœŸæ—¶é—´éªŒè¯ã€‚</p><p>éšåè¦éªŒè¯auth_token ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„æ•°æ®ï¼Œè¿™é‡Œè¦åˆ†ä¸‰ç§æƒ…å†µè€ƒè™‘ã€‚</p><ul>\n<li>å¦‚æœåŒ…å«æœ‰æ•ˆæ•°æ®ï¼Œåˆ™è¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­ code ä¸º HttpCode.okï¼Œè¡¨ç¤ºè¯·æ±‚æˆåŠŸï¼Œpayload ä¸ºè§£ç åçš„æ•°æ®ã€‚</li>\n<li>å¦‚æœä¸åŒ…å«æœ‰æ•ˆæ•°æ®æˆ–è€…è§£ç å¤±è´¥ï¼Œåˆ™æŠ›å‡º InvalidTokenErrorï¼Œè¡¨ç¤º Token éªŒè¯å¤±è´¥ï¼Œå¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚</li>\n<li>å¦‚æœ auth_token ä¸­åŒ…å«æœ‰æ•ˆæ•°æ®ä½†æ˜¯ Token å·²ç»è¿‡æœŸï¼Œåˆ™æŠ›å‡º ExpiredSignatureErrorï¼Œè¡¨ç¤º Token å·²ç»å¤±æ•ˆï¼Œå¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚</li>\n</ul><p>è™½ç„¶ä»£ç ä¸­å–æ¶ˆäº†è¿‡æœŸæ—¶é—´éªŒè¯ï¼Œä½†æ˜¯åœ¨åé¢ä¾æ—§ä¼šæŠ›å‡º ExpiredSignatureErrorï¼Œæç¤ºTokenè¿‡æœŸï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠå¼‚å¸¸å¤„ç†æƒ…å†µæ¶µç›–å¾—æ›´å…¨ã€‚</p><h2>ç™»å½•è®¤è¯</h2><p>æå®šäº†ç”ŸæˆTokenå’Œå¯¹Tokenè®¤è¯çš„ä»£ç åï¼Œä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹ç”¨æˆ·ç™»å½•è¿›è¡Œè®¤è¯ã€‚ç™»å½•è®¤è¯æˆåŠŸå³å¯ç»™å®¢æˆ·ç«¯è¿”å›Tokenï¼Œä¸‹æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚èµ„æºçš„æ—¶å€™ï¼Œå¿…é¡»å¸¦ç€æœåŠ¡ç«¯ç­¾å‘çš„ Tokenï¼Œæ‰èƒ½å®ç°å¯¹ç”¨æˆ·ä¿¡æ¯çš„è®¤è¯ã€‚</p><p>å®ç°ç”¨æˆ·ç™»å½•çš„ä»£ç æ˜¯åé¢è¿™æ ·ã€‚</p><pre><code class=\"language-python\">def authenticate(self, mobile, password):\n    \"\"\"\n    ç”¨æˆ·ç™»å½•ï¼Œç™»å½•æˆåŠŸè¿”å›tokenï¼Œå†™å°†ç™»å½•æ—¶é—´å†™å…¥æ•°æ®åº“ï¼›ç™»å½•å¤±è´¥è¿”å›å¤±è´¥åŸå› \n    :param password:\n    :return: json\n    \"\"\"\n    user = UserLogin.query.filter_by(mobile=mobile).first()\n    if not user:\n        return error(code=HttpCode.auth_error, msg='è¯·æ±‚çš„ç”¨æˆ·ä¸å­˜åœ¨')\n    else:\n        if user.check_password(password):\n            login_time = int(time.time())\n            try:\n                user.last_login_stamp = login_time\n                user.last_login = datetime.datetime.now()\n                user.update()\n            except Exception as e:\n                current_app.logger.error(e)\n                return error(code=HttpCode.db_error, msg='ç™»å½•æ—¶é—´æŸ¥è¯¢å¤±è´¥')\n            token = self.encode_auth_token(user.user_id, login_time)  # bytes\n            token = str(token, encoding=\"utf-8\")\n            user_id = user.user_id\n            # å­˜å‚¨åˆ°redisä¸­\n            try:\n                redis_store.set(\"jwt_token:%s\" % user_id, token, constants.JWT_TOKEN_REDIS_EXPIRES)\n            # è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºå¸¸é‡JWT_TOKEN_REDIS_EXPIRESï¼ˆ86400ç§’ï¼Œå³24å°æ—¶ï¼‰\n            except Exception as e:\n                current_app.logger.error(e)\n                return error(code=HttpCode.db_error, msg=\"tokenä¿å­˜rediså¤±è´¥\")\n            from api.modules.video.views import user_action_log\n            user_action_log.warning({\n                'user_id': user_id,\n                'url': '/passport/login',\n                'method': 'post',\n                'msg': 'login',\n                'event': 'login',\n            })\n            return success(msg='ç”¨æˆ·ç™»å½•æˆåŠŸ', data={\"token\": token, \"user_id\": user_id})\n        else:\n            return error(code=HttpCode.parmas_error, msg='ç”¨æˆ·ç™»å½•å¯†ç è¾“å…¥é”™è¯¯')\n</code></pre><p>ä¸Šé¢ä»£ç æ•´ä½“å®ç°æµç¨‹æ˜¯ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„æ‰‹æœºå·ç å’Œå¯†ç ï¼Œç„¶ååˆ©ç”¨æ‰‹æœºå·ç æŸ¥è¯¢æ•°æ®åº“ä¸­æ˜¯ï¼Œå¦å­˜åœ¨è¯¥ç”¨æˆ·ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœå­˜åœ¨ï¼Œä½¿ç”¨åœ¨æ•°æ®åº“è¡¨ä¸­å®šä¹‰çš„å‡½æ•°check_passwordæ¥ï¼Œæ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®ã€‚</p><p>å¦‚æœå¯†ç é”™è¯¯ï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœå¯†ç æ­£ç¡®åˆ™è®°å½•ç”¨æˆ·çš„ç™»å½•æ—¶é—´å’Œæ—¥æœŸï¼Œä½¿ç”¨å½“å‰ç”¨æˆ·çš„user_idå’Œç™»å½•æ—¶é—´æˆ³ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨encode_auth_token()æ–¹æ³•ç”Ÿæˆä¸€ä¸ªtokenï¼Œå†ä½¿ç”¨redis_store.set()æ–¹æ³•å°†ç”Ÿæˆçš„tokenå­˜å‚¨åœ¨redisä¸­ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</p><p>å¦‚æœå­˜å‚¨å¤±è´¥ï¼Œåˆ™å°†è¯¥é”™è¯¯ä¿¡æ¯å­˜å…¥åº”ç”¨æ—¥å¿—ä¸­ï¼Œä»¥ä¾¿äºåç»­çš„è°ƒè¯•å’Œé—®é¢˜æ’æŸ¥ã€‚å¦‚æœæ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ï¼Œæœ€åè¿”å›æˆåŠŸä¿¡æ¯å’Œtokenä»¥åŠç”¨æˆ·IDã€‚</p><p>è¿™é‡Œè¿˜è°ƒç”¨äº†videoæ¨¡å—ä¸­çš„user_action_logã€‚user_action_logç”¨æ¥è®°å½•å‡ºç°çš„å¼‚å¸¸ç­‰ä¿¡æ¯ã€‚å…·ä½“ä»£ç æ˜¯åé¢è¿™æ ·ã€‚</p><pre><code class=\"language-python\">from api.utils.log_utils import json_log\njson_log('user_action', 'logs/user_action.log')\nuser_action_log = logging.getLogger('user_action')\n</code></pre><p>è¿™é‡Œè°ƒç”¨äº†log_utilsä¸­çš„json_logå‡½æ•°ï¼Œä½¿ç”¨  <code>json_log</code> å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªåä¸º <code>user_action_log</code> çš„æ—¥å¿—è®°å½•å™¨å¯¹è±¡ï¼Œå¹¶å°†å…¶æŒ‡å‘  <code>logs/user_action.log</code> è·¯å¾„çš„æ–‡ä»¶ï¼Œè¿™æ ·è®°å½•ç”¨æˆ·æ“ä½œçš„ç›¸å…³ä¿¡æ¯ä¼šæ›´æ–¹ä¾¿ã€‚</p><h2>ç”¨æˆ·é‰´æƒ</h2><p>æ¥ä¸‹æ¥çš„ç¯èŠ‚å°±æ˜¯åœ¨è¯·æ±‚æ—¶è·å–ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œé‰´æƒã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰ç›¸åº”çš„æƒé™ï¼Œåˆ™è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚å…·ä½“å®ç°ä»£ç æ˜¯åé¢è¿™æ ·ã€‚</p><pre><code class=\"language-python\">def identify(self, request):\n    \"\"\"\n    ç”¨æˆ·é‰´æƒ\n    :return: list\n    \"\"\"\n    auth_header = request.headers.get('Authorization', None)\n    if auth_header:\n        auth_token_arr = auth_header.split(\" \")\n        # åˆ†æˆåˆ—è¡¨ï¼Œå«æœ‰ä¸¤ä¸ªå…ƒç´ \n        if not auth_token_arr or auth_token_arr[0] != 'JWT' or len(auth_token_arr) != 2:\n            return dict(code=HttpCode.auth_error, msg='è¯·æ±‚æœªæºå¸¦è®¤è¯ä¿¡æ¯ï¼Œè®¤è¯å¤±è´¥')\n        else:\n            auth_token = auth_token_arr[1]\n            # å°†JWTä»¤ç‰Œçš„å­—ç¬¦ä¸²å€¼ç»™auth_token\n            payload_dict = self.decode_auth_token(auth_token)\n            if 'payload' in payload_dict and payload_dict.get('code') == 200:\n                payload = payload_dict.get('payload')\n                user_id = payload.get('data').get('id')\n                login_time = payload.get('data').get('login_time')\n                # print('ğŸ‘‰ğŸ‘‰   è§£æå‡ºçš„æ—¶é—´æˆ³', login_time)\n                user = UserLogin.query.filter_by(user_id=user_id).first()\n                if not user:  # æœªåœ¨è¯·æ±‚ä¸­æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·\n                    return dict(code=HttpCode.auth_error, msg='ç”¨æˆ·ä¸å­˜åœ¨ï¼ŒæŸ¥æ— æ­¤ç”¨æˆ·')\n                else:\n                    # é€šè¿‡userå–å‡ºredisä¸­çš„token\n                    try:\n                        # print(user_id)\n                        redis_jwt_token = redis_store.get(\"jwt_token:%s\" % user_id)\n                        # print('ğŸ‘ˆredis', redis_jwt_token)\n                    except Exception as e:\n                        current_app.logger.error(e)\n                        return dict(code=HttpCode.db_error, msg=\"redisæŸ¥è¯¢tokenå¤±è´¥\")\n                    if not redis_jwt_token or redis_jwt_token != auth_token:\n                        # print('ğŸ‘‰ğŸ‘‰   è§£æå‡ºæ¥çš„token', auth_token)\n                        return dict(code=HttpCode.auth_error, msg=\"jwt-tokenå¤±æ•ˆ\")\n                    # print(type(user.last_login_stamp), type(login_time))\n                    # print(user.last_login_stamp, login_time)\n                    if user.last_login_stamp == login_time:\n\n                        return dict(code=HttpCode.ok, msg='ç”¨æˆ·è®¤è¯æˆåŠŸ', data={\"user_id\": user.user_id})\n                    else:\n                        return dict(code=HttpCode.auth_error, msg='ç”¨æˆ·è®¤è¯å¤±è´¥ï¼Œéœ€è¦å†æ¬¡ç™»å½•')\n            else:\n                return dict(code=HttpCode.auth_error, msg=payload_dict.get('msg') or 'ç”¨æˆ·è®¤è¯å¤±è´¥ï¼Œæºå¸¦è®¤è¯å‚æ•°ä¸åˆæ³•')\n    else:\n        return dicåœ¨ä»£ç ä¸­ï¼Œt(codeä¸»è¦=HttpCode.auth_error, msg='ç”¨æˆ·è®¤è¯å¤±è´¥,è¯·æ±‚æœªæºå¸¦å¯¹åº”è®¤è¯ä¿¡æ¯')\n</code></pre><p>ç”¨æˆ·é‰´æƒå‡½æ•°ä¸»è¦ç”¨äºéªŒè¯ç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•ã€‚é¦–å…ˆé€šè¿‡request.headersè·å–è¯·æ±‚å¤´ä¸­çš„Authorizationå­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜ç”¨æˆ·æœªæºå¸¦å¯¹åº”è®¤è¯ä¿¡æ¯ï¼Œè¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„å­—å…¸ã€‚</p><p>å¦‚æœå­˜åœ¨è¯¥å­—æ®µï¼Œå°±æŒ‰ç…§ç©ºæ ¼å°†å…¶åˆ†å‰²æˆä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­åŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºJWTï¼Œç¬¬äºŒä¸ªå…ƒç´ ä¸ºJWTä»¤ç‰Œçš„å­—ç¬¦ä¸²å€¼ã€‚å¦‚æœauth_token_arrä¸ºç©ºï¼Œé‚£ä¹ˆauth_token_arrç¬¬ä¸€ä¸ªå…ƒç´ ä¸åŒ…å« â€œJWTâ€ å­—ç¬¦ä¸²ï¼Œæˆ–è€…åˆ†å‰²åçš„auth_token_arré•¿åº¦ä¸ä¸º2ï¼Œè¿™å°±è¯æ˜JWTä»¤ç‰Œæ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€è¦è¿”å›è®¤è¯å¤±è´¥çš„ä¿¡æ¯ã€‚</p><p>è¿™ä¸€æ­¥å¦‚æœé€šè¿‡çš„è¯ï¼Œæˆ‘ä»¬å†å°†auth_token_arråˆ—è¡¨ä¸­çš„ç¬¬äºŒä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯JWTä»¤ç‰Œçš„å­—ç¬¦ä¸²å€¼èµ‹ç»™auth_tokenï¼Œå¹¶å°†è§£ç ç»“æœèµ‹å€¼payload_dictã€‚</p><p>ä¸‹ä¸€æ­¥å°±æ˜¯åˆ¤æ–­payload_dictä¸­æ˜¯å¦æœ‰payloadå­—æ®µï¼Œä¸”codeå­—æ®µçš„å€¼æ˜¯å¦ä¸º200ã€‚ä¸ç¬¦åˆåˆ¤æ–­æ¡ä»¶åŒæ ·è¦è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œè¯´æ˜æºå¸¦è®¤è¯å‚æ•°ä¸åˆæ³•ã€‚å¦‚æœç¬¦åˆæ¡ä»¶ï¼Œå°±ä»payloadä¸­æŠŠç”¨æˆ·IDã€ç™»å½•æ—¶é—´å’Œpayloadä¿¡æ¯å–å‡ºæ¥ï¼Œå¹¶æ ¹æ®ç”¨æˆ·IDåœ¨ç”¨æˆ·ç™»å½•è¡¨ä¸­å®ŒæˆæŸ¥è¯¢ã€‚</p><p>å¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·åŒæ ·è¦è¿”å›é”™è¯¯ã€‚å¦‚æœç”¨æˆ·å­˜åœ¨ï¼Œåˆ™ä» Rediså†…å­˜ä¸­ï¼Œè·å–ä»¥ user_id ä¸ºé”®çš„jwt_tokenï¼Œèµ‹ç»™redis_jwt_tokenã€‚å¦‚æœå†…å­˜ä¸­å–ä¸å‡ºæ¥è¯¥å€¼ï¼Œè¿™æ—¶å€™å°±è¿”å›é”™è¯¯ã€‚</p><p>ç´§æ¥ç€ä¼šå†æ¬¡åšæ¡ä»¶åˆ¤æ–­ï¼Œå¦‚æœè¯·æ±‚ä¸­è§£æå‡ºçš„JWTä»¤ç‰Œçš„å­—ç¬¦ä¸²å€¼ï¼Œè·Ÿä¹‹å‰å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä¸ç›¸ç¬¦åˆï¼ŒåŒæ ·è¦è¿”å›é”™è¯¯ã€‚æœ€åï¼ŒéªŒè¯è¯¥tokenå¯¹åº”çš„ç™»å½•æ—¶é—´æˆ³æ˜¯å¦ä¸æ•°æ®åº“ä¸­æœ€è¿‘ä¸€æ¬¡ç™»å½•æ—¶é—´æˆ³ä¸€è‡´ã€‚å¦‚æœä¸€è‡´ï¼Œåˆ™è¡¨ç¤ºè®¤è¯é€šè¿‡ï¼Œå¦åˆ™è¡¨ç¤ºéœ€è¦é‡æ–°ç™»å½•ã€‚</p><p>åœ¨å®æ“ç¯èŠ‚æˆ‘ä»¬çŸ¥é“Tokençš„è®¤è¯æµç¨‹æ˜¯å½“ç”¨æˆ·åœ¨è¿›è¡Œé¦–æ¬¡ç™»å½•ï¼ŒæœåŠ¡å™¨ä¼šä½¿ç”¨å¯†é’¥å’ŒåŠ å¯†ç®—æ³•ï¼Œç”ŸæˆTokenï¼Œå‘é€ç»™å®¢æˆ·ç«¯ï¼Œç”±å®¢æˆ·ç«¯è‡ªå·±è¿›è¡Œå­˜å‚¨ã€‚ç­‰å†æ¬¡ç™»å½•æ—¶ï¼Œå®¢æˆ·ç«¯æºå¸¦Tokenè¯·æ±‚èµ„æºï¼ŒæœåŠ¡å™¨ä¼šè¿›è¡ŒTokençš„è®¤è¯ï¼Œå®Œæˆä¸€ç³»åˆ—éªŒè¯ï¼ˆå¦‚Tokenæ˜¯å¦è¿‡æœŸï¼ŒJWTä»¤ç‰Œçš„æ ¼å¼æ˜¯å¦æ­£ç¡®ç­‰ï¼‰ï¼Œé€šè¿‡å¼‚å¸¸å¤„ç†çš„æŠŠæ§æ¥ä¿è¯Tokenè®¤è¯çš„å®‰å…¨å’Œç¨³å®šæ€§ã€‚</p><h2>æ€»ç»“</h2><p>åˆåˆ°äº†è¯¾ç¨‹çš„å°¾å£°ï¼Œæˆ‘ä»¬æ¥å›é¡¾æ€»ç»“ä¸€ä¸‹ã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯é€šè¿‡é¡¹ç›®å®æˆ˜æ¥å¼ºåŒ–å¯¹è®¤è¯æœºåˆ¶çš„åº”ç”¨ã€‚åœ¨é¡¹ç›®ä¸­åº”ç”¨ä¹Ÿæ˜¯ä¸€æ ·çš„è®¤è¯æµç¨‹ï¼Œæˆ‘ä»¬å…ˆè¦ç”ŸæˆTokenï¼Œå€ŸåŠ©Flaskçš„æ‰©å±•Flask-JWTæ¥ç”ŸæˆTokenã€‚ä½ éœ€è¦æŒæ¡ç”ŸæˆTokençš„ä»£ç ï¼Œç†è§£å®ƒçš„ç”Ÿæˆè¿‡ç¨‹ã€‚</p><p>ä¹‹åå°±æ˜¯TokenéªŒè¯å’Œè®¤è¯é˜¶æ®µï¼ŒTokençš„éªŒè¯å°±æ˜¯å€ŸåŠ©JWTæ‰©å±•çš„decodeå‡½æ•°ï¼Œå°†å®¢æˆ·ç«¯å‘é€çš„Tokenè¿›è¡Œè§£ç ã€‚æˆ‘ä»¬é‡ç‚¹è¦å…³æ³¨ç™»å½•è®¤è¯æˆåŠŸçš„å‰æä¸‹ï¼Œå®¢æˆ·ç«¯æ¥æ”¶Tokenä»¥åï¼Œä¸‹æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚èµ„æºçš„æ—¶å€™ï¼Œ<strong>å¿…é¡»å¸¦ç€æœåŠ¡ç«¯ç­¾å‘çš„ Token</strong>ï¼Œè¿™æ ·æ‰èƒ½å®ç°å¯¹ç”¨æˆ·ä¿¡æ¯çš„è®¤è¯ã€‚</p><p>ç”¨æˆ·é‰´æƒå‡½æ•°ä¸»è¦ç”¨äºéªŒè¯ç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•ã€‚é‰´å®šæ–¹æ³•å°±æ˜¯é€šè¿‡request.headersè¯·æ±‚å¤´ä¸­çš„Authorizationå­—æ®µæ¥åˆ¤æ–­ï¼šå¦‚æœè¯¥å­—æ®µä¸å­˜åœ¨ï¼Œè¯´æ˜ç”¨æˆ·æœªæºå¸¦å¯¹åº”è®¤è¯ä¿¡æ¯ï¼›å¦‚æœå­˜åœ¨åˆ™éœ€è¦æˆ‘ä»¬éªŒè¯å†…éƒ¨å‚æ•°æ¥åˆ¤å®šã€‚</p><p>é€šè¿‡è¿™èŠ‚è¯¾çš„å®æ“ç»ƒä¹ ï¼Œç›¸ä¿¡ä½ ä¼šå¯¹è®¤è¯æœºåˆ¶çš„åº”ç”¨å¾—æ›´åŠ ç†Ÿç»ƒã€‚è¯¾ç¨‹é‡Œæœ‰å¾ˆå¤šçš„ä»£ç ï¼Œä¸€å®šåœ¨è¯¾åè‡ªå·±å¤šå®è·µã€‚ä¸‹èŠ‚è¯¾æˆ‘ä»¬å³å°†å¼€å¯åŠŸèƒ½æ¥å£çš„å®æˆ˜ï¼Œä¸è§ä¸æ•£ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å‰é¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬è®²åˆ°äº†current_appï¼Œsessionï¼Œrequestï¼Œä½ çŸ¥é“ä»–ä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ä¹ˆï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºå’Œæˆ‘äº¤æµäº’åŠ¨ï¼Œå¦‚æœè¿™èŠ‚è¯¾å¯¹ä½ æœ‰å¯å‘ï¼Œä¹Ÿæ¨èä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šæœ‹å‹ã€‚</p>","comments":[{"had_liked":false,"id":381846,"user_name":"èƒ¡æ­Œè¡¡é˜³åˆ†æ­Œ","can_delete":false,"product_type":"c1","uid":3206232,"ip_address":"æ¹–å—","ucode":"F39E856E73F938","user_header":"https://static001.geekbang.org/account/avatar/00/30/ec/58/7948ea79.jpg","comment_is_top":false,"comment_ctime":1695974894,"is_pvip":false,"replies":[{"id":139186,"content":"æ˜¯è¿™æ ·åŒå­¦ï¼Œåœ¨è¿™ä¸€èŠ‚è¯¾æˆ‘ä»¬æŠŠæ•´ä½“çš„è®¤è¯æœºåˆ¶æ¢³ç†ä¸‹æ¥ï¼Œä»¥åŠåšäº†ä¸€äº›å°çš„æ¡ˆä¾‹å®è·µï¼Œåœ¨åè¾¹è¯¾ç¨‹ä¸­çš„é¡¹ç›®å®æˆ˜ä¼šç»“åˆè¿™éƒ¨åˆ†å†…å®¹åšé¡¹ç›®å¼€å‘åº”ç”¨ï¼Œå¦‚æœå•ç‹¬çœ‹ç›®å‰ä¸å¤ªç†è§£ï¼Œä¸è¦è®©è‡ªå·±ä¸§å¤±ä¿¡å¿ƒï¼Œæ¥ç€å¬åè¾¹çš„è¯¾ç¨‹ï¼Œä¼šè§£å¼€ä½ çš„ç–‘æƒ‘ã€‚åŠ æ²¹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3050845,"ctime":1696735315,"ip_address":"åŒ—äº¬","comment_id":381846,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100546501,"comment_content":"è¿™ä¸ªæ•™ç¨‹æ˜¯ç›¸å½“çš„ä¸å®Œæ•´å•Šï¼Œçœ‹çš„å¿ƒçƒ¦","like_count":1,"discussions":[{"author":{"id":3050845,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/8d/5d/9a86007c.jpg","nickname":"Barry","note":"","ucode":"82175C78B4CAED","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629148,"discussion_content":"æ˜¯è¿™æ ·åŒå­¦ï¼Œåœ¨è¿™ä¸€èŠ‚è¯¾æˆ‘ä»¬æŠŠæ•´ä½“çš„è®¤è¯æœºåˆ¶æ¢³ç†ä¸‹æ¥ï¼Œä»¥åŠåšäº†ä¸€äº›å°çš„æ¡ˆä¾‹å®è·µï¼Œåœ¨åè¾¹è¯¾ç¨‹ä¸­çš„é¡¹ç›®å®æˆ˜ä¼šç»“åˆè¿™éƒ¨åˆ†å†…å®¹åšé¡¹ç›®å¼€å‘åº”ç”¨ï¼Œå¦‚æœå•ç‹¬çœ‹ç›®å‰ä¸å¤ªç†è§£ï¼Œä¸è¦è®©è‡ªå·±ä¸§å¤±ä¿¡å¿ƒï¼Œæ¥ç€å¬åè¾¹çš„è¯¾ç¨‹ï¼Œä¼šè§£å¼€ä½ çš„ç–‘æƒ‘ã€‚åŠ æ²¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1696735315,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1163668,"avatar":"https://static001.geekbang.org/account/avatar/00/11/c1/94/d8717630.jpg","nickname":"é›ªå„¿æ¬¢","note":"","ucode":"5AE6D46F2097C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":3050845,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/8d/5d/9a86007c.jpg","nickname":"Barry","note":"","ucode":"82175C78B4CAED","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":640489,"discussion_content":"ä¸»è¦æ˜¯gitä»£ç éƒ½æ˜¯æˆªå–å‡ºæ¥çš„ ä¹Ÿæ²¡æœ‰ç»™å®Œæ•´çš„ä»£ç ä»¥åŠç»“æ„\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1711537193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":629148,"ip_address":"å¹¿ä¸œ","group_id":0},"score":640489,"extra":""}]}]},{"had_liked":false,"id":384923,"user_name":"çŸ³ä½›æ…ˆæ‚²","can_delete":false,"product_type":"c1","uid":1002788,"ip_address":"åŒ—äº¬","ucode":"9BE727D82672E3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/24/6c621045.jpg","comment_is_top":false,"comment_ctime":1701787931,"is_pvip":false,"replies":[{"id":140504,"content":"å°†tokenå­˜å‚¨åœ¨Redisä¸­å¹¶è¿›è¡Œæ ¡éªŒå¯ä»¥å¢åŠ é¢å¤–çš„å®‰å…¨å±‚ã€‚è¿™å¯ä»¥å¸®åŠ©é˜²æ­¢tokenè¢«ç¯¡æ”¹æˆ–ä¼ªé€ ï¼Œä»è€Œä¿æŠ¤åº”ç”¨ç¨‹åºçš„å®‰å…¨ã€‚åŒæ—¶ï¼Œé€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥ç¡®ä¿tokenåœ¨ä¸€æ®µæ—¶é—´åè‡ªåŠ¨å¤±æ•ˆï¼Œè¿›ä¸€æ­¥ä¿æŠ¤ç”¨æˆ·çš„å®‰å…¨ã€‚\næ­¤å¤–ï¼Œé€šè¿‡æ ¡éªŒRedisä¸­çš„tokenï¼Œå¯ä»¥ç¡®ä¿ä¸€æ—¦tokenè¿‡æœŸæˆ–è¢«æ’¤é”€ï¼Œå®ƒå°±ä¸èƒ½å†è¢«ç”¨æ¥è®¿é—®å—ä¿æŠ¤çš„èµ„æºã€‚è¿™å¯¹äºç®¡ç†ç”¨æˆ·ä¼šè¯å’Œæƒé™éå¸¸æœ‰ç”¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3050845,"ctime":1702958352,"ip_address":"åŒ—äº¬","comment_id":384923,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100546501,"comment_content":"tokenå­˜åœ¨redisé‡Œçš„æ„ä¹‰æ˜¯å•¥å‘¢ï¼Œä¸ºå•¥è¿˜è¦æ ¡éªŒredisçš„tokenï¼Œä¸æ˜¯è§£ç æ¯”å¯¹éƒ½å·²ç»æ ¡éªŒäº†å—ï¼Ÿä¸ºäº†æ§åˆ¶tokenå¤±æ•ˆï¼Ÿ","like_count":0,"discussions":[{"author":{"id":3050845,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/8d/5d/9a86007c.jpg","nickname":"Barry","note":"","ucode":"82175C78B4CAED","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634056,"discussion_content":"å°†tokenå­˜å‚¨åœ¨Redisä¸­å¹¶è¿›è¡Œæ ¡éªŒå¯ä»¥å¢åŠ é¢å¤–çš„å®‰å…¨å±‚ã€‚è¿™å¯ä»¥å¸®åŠ©é˜²æ­¢tokenè¢«ç¯¡æ”¹æˆ–ä¼ªé€ ï¼Œä»è€Œä¿æŠ¤åº”ç”¨ç¨‹åºçš„å®‰å…¨ã€‚åŒæ—¶ï¼Œé€šè¿‡è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥ç¡®ä¿tokenåœ¨ä¸€æ®µæ—¶é—´åè‡ªåŠ¨å¤±æ•ˆï¼Œè¿›ä¸€æ­¥ä¿æŠ¤ç”¨æˆ·çš„å®‰å…¨ã€‚\næ­¤å¤–ï¼Œé€šè¿‡æ ¡éªŒRedisä¸­çš„tokenï¼Œå¯ä»¥ç¡®ä¿ä¸€æ—¦tokenè¿‡æœŸæˆ–è¢«æ’¤é”€ï¼Œå®ƒå°±ä¸èƒ½å†è¢«ç”¨æ¥è®¿é—®å—ä¿æŠ¤çš„èµ„æºã€‚è¿™å¯¹äºç®¡ç†ç”¨æˆ·ä¼šè¯å’Œæƒé™éå¸¸æœ‰ç”¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702958352,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":376993,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1687820763,"is_pvip":false,"replies":[{"id":137516,"content":"1ã€Config.SECRET_KEY æ˜¯ Flask æ¡†æ¶ä¸­æä¾›çš„ä¸€ä¸ªç³»ç»Ÿé»˜è®¤çš„å¯†é’¥ã€‚åœ¨ Flask åº”ç”¨ä¸­ï¼ŒConfig.SECRET_KEY ç”¨äºåŠ å¯†å’Œä¿æŠ¤ä¼šè¯æ•°æ®ï¼Œä»¥ç¡®ä¿ç”¨æˆ·ä¼šè¯çš„å®‰å…¨æ€§ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è®¾ç½® SECRET_KEYï¼Œä½†æ— è®ºå“ªç§æ–¹å¼ï¼Œç¡®ä¿ SECRET_KEY çš„å®‰å…¨æ€§æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºå®ƒç”¨äºä¿æŠ¤ç”¨æˆ·çš„ä¼šè¯æ•°æ®å’Œèº«ä»½éªŒè¯ä¿¡æ¯ã€‚\n2ã€åœ¨ HTTP header ä¸­ï¼Œç¡®å®å­˜åœ¨ä¸€ä¸ªåä¸º &quot;Authorization&quot; çš„å­—æ®µï¼Œç”¨äºä¼ é€’èº«ä»½éªŒè¯ä¿¡æ¯å’Œæˆæƒä»¤ç‰Œã€‚è¿™ä¸ªå­—æ®µæ˜¯ HTTP åè®®ä¸­é¢„å®šä¹‰çš„æ ‡å‡†å­—æ®µä¹‹ä¸€ï¼Œç”¨äºæ ‡è¯†å®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯æ–¹å¼ã€æˆæƒä»¤ç‰Œç±»å‹ä»¥åŠæˆæƒä»¤ç‰Œçš„å€¼ã€‚\n\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3050845,"ctime":1688399061,"ip_address":"åŒ—äº¬","comment_id":376993,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100546501,"comment_content":"è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š\nQ1ï¼šConfig.SECRET_KEYæ˜¯ç³»ç»Ÿè‡ªå¸¦çš„å—ï¼Ÿ\nQ2ï¼štokenæ”¾åœ¨httpçš„headerä¸­çš„Authorizationå­—æ®µï¼ŒAuthorizationå­—æ®µæ˜¯httpå›ºæœ‰çš„å­—æ®µå—ï¼Ÿè®°ä¸æ¸…æ¥šäº†ï¼Œå¥½åƒåº”è¯¥æ˜¯è‡ªå®šä¹‰å­—æ®µï¼Ÿ","like_count":0,"discussions":[{"author":{"id":3050845,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/8d/5d/9a86007c.jpg","nickname":"Barry","note":"","ucode":"82175C78B4CAED","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":622562,"discussion_content":"1ã€Config.SECRET_KEY æ˜¯ Flask æ¡†æ¶ä¸­æä¾›çš„ä¸€ä¸ªç³»ç»Ÿé»˜è®¤çš„å¯†é’¥ã€‚åœ¨ Flask åº”ç”¨ä¸­ï¼ŒConfig.SECRET_KEY ç”¨äºåŠ å¯†å’Œä¿æŠ¤ä¼šè¯æ•°æ®ï¼Œä»¥ç¡®ä¿ç”¨æˆ·ä¼šè¯çš„å®‰å…¨æ€§ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è®¾ç½® SECRET_KEYï¼Œä½†æ— è®ºå“ªç§æ–¹å¼ï¼Œç¡®ä¿ SECRET_KEY çš„å®‰å…¨æ€§æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºå®ƒç”¨äºä¿æŠ¤ç”¨æˆ·çš„ä¼šè¯æ•°æ®å’Œèº«ä»½éªŒè¯ä¿¡æ¯ã€‚\n2ã€åœ¨ HTTP header ä¸­ï¼Œç¡®å®å­˜åœ¨ä¸€ä¸ªåä¸º &#34;Authorization&#34; çš„å­—æ®µï¼Œç”¨äºä¼ é€’èº«ä»½éªŒè¯ä¿¡æ¯å’Œæˆæƒä»¤ç‰Œã€‚è¿™ä¸ªå­—æ®µæ˜¯ HTTP åè®®ä¸­é¢„å®šä¹‰çš„æ ‡å‡†å­—æ®µä¹‹ä¸€ï¼Œç”¨äºæ ‡è¯†å®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯æ–¹å¼ã€æˆæƒä»¤ç‰Œç±»å‹ä»¥åŠæˆæƒä»¤ç‰Œçš„å€¼ã€‚\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1688399061,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}