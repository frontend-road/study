{"id":119500,"title":"12 | 使用ZooKeeper实现选举","content":"<p><strong>课件和Demo地址</strong></p><p><a href=\"https://gitee.com/geektime-geekbang/geekbang-zk-course\">https://gitee.com/geektime-geekbang/geekbang-zk-course</a></p>","comments":[{"had_liked":false,"id":132280,"user_name":"calljson","can_delete":false,"product_type":"c3","uid":1505262,"ip_address":"","ucode":"A5F81A6A5B4497","user_header":"https://static001.geekbang.org/account/avatar/00/16/f7/ee/6eeb58a3.jpg","comment_is_top":false,"comment_ctime":1568077950,"is_pvip":false,"replies":[{"id":50630,"content":"好的，多谢您的建议","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1568105782,"ip_address":"","comment_id":132280,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"zookeeper的watcher机制和选举机制讲解的太浅了，背后原理和架构没有详细讲解，希望能讲解其背后逻辑，不能只对着源码讲解","like_count":7,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466854,"discussion_content":"好的，多谢您的建议","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568105782,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1063308,"avatar":"https://static001.geekbang.org/account/avatar/00/10/39/8c/ff48ece3.jpg","nickname":"小乙哥","note":"","ucode":"C77E79BEA0C325","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651914,"discussion_content":"同意","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727699471,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213449,"user_name":"妥协","can_delete":false,"product_type":"c3","uid":1249656,"ip_address":"","ucode":"7201DFE9C12669","user_header":"https://static001.geekbang.org/account/avatar/00/13/11/78/4f0cd172.jpg","comment_is_top":false,"comment_ctime":1588417006,"is_pvip":false,"replies":[{"id":79221,"content":"如果在节点A和ZooKeeper集群之间发生了网络分区，节点A会收到Disconnected的WatchedEvent, 节点A要在收到这个event之后停止执行主节点的功能。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1588573287,"ip_address":"","comment_id":213449,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"使用zookeeper在主备切换的场景，A是主节点，B是备节点，如果A节点和zookeeper集群间网络延迟等网络故障时，导致zookeeper因为心跳超时，删除A的临时节点，导致主备切换，B切换为主节点，这个时候系统中就存在两主节点了，这种情况怎么解决？","like_count":1,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493784,"discussion_content":"如果在节点A和ZooKeeper集群之间发生了网络分区，节点A会收到Disconnected的WatchedEvent, 节点A要在收到这个event之后停止执行主节点的功能。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588573287,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1063308,"avatar":"https://static001.geekbang.org/account/avatar/00/10/39/8c/ff48ece3.jpg","nickname":"小乙哥","note":"","ucode":"C77E79BEA0C325","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651915,"discussion_content":"“zookeeper的应答却收不到”,服务端应该也感知到客户端异常了.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727699590,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1249656,"avatar":"https://static001.geekbang.org/account/avatar/00/13/11/78/4f0cd172.jpg","nickname":"妥协","note":"","ucode":"7201DFE9C12669","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":262525,"discussion_content":"节点A会收到Disconnected的WatchedEvent    ，网络分区发生时，这个事件不是zookeeper集群发过来的，而是客户端自己做的判断，自己触发的嘛。如果是这样的话，如果网络存在单方向传输故障时，比如客户端上报心跳正常，zookeeper的应答却收不到。那岂不是zookeeper集群的状态和客户端状态不一致，","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589110064,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128938,"user_name":"hgf","can_delete":false,"product_type":"c3","uid":1085297,"ip_address":"","ucode":"A9649ECFDBD9E8","user_header":"https://static001.geekbang.org/account/avatar/00/10/8f/71/29fb7bc2.jpg","comment_is_top":false,"comment_ctime":1566988572,"is_pvip":false,"replies":[{"id":48082,"content":"ZooKeeper使用WatchedEvent(https:&#47;&#47;zookeeper.apache.org&#47;doc&#47;r3.5.5&#47;api&#47;org&#47;apache&#47;zookeeper&#47;WatchedEvent.html)来表示session的状态变化和znode的变化。WatchedEvent的Watcher.Event.KeeperState对应session的变化，WatchedEvent的Watcher.Event.EventType对应znode的变化。\n\n关于KeeperState和EventType的取值，参见https:&#47;&#47;zookeeper.apache.org&#47;doc&#47;r3.5.5&#47;api&#47;org&#47;apache&#47;zookeeper&#47;Watcher.Event.html。\n\n如果EventType是None，WatchedEvent代表的就是session的状态变化，否则代表的是znode的变化。\n\nKeeperException表示ZooKeeper的各种出错情况，其中需要特别注意的是KeeperException.ConnectionLossException 。我们可能需要在遇到KeeperException.ConnectionLossException时进行重试。\n\n","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1567070364,"ip_address":"","comment_id":128938,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师，建议分析一下watch和事件的各种可能，系统内部状态变化，包括异常情况下是否可用","like_count":1,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465184,"discussion_content":"ZooKeeper使用WatchedEvent(https://zookeeper.apache.org/doc/r3.5.5/api/org/apache/zookeeper/WatchedEvent.html)来表示session的状态变化和znode的变化。WatchedEvent的Watcher.Event.KeeperState对应session的变化，WatchedEvent的Watcher.Event.EventType对应znode的变化。\n\n关于KeeperState和EventType的取值，参见https://zookeeper.apache.org/doc/r3.5.5/api/org/apache/zookeeper/Watcher.Event.html。\n\n如果EventType是None，WatchedEvent代表的就是session的状态变化，否则代表的是znode的变化。\n\nKeeperException表示ZooKeeper的各种出错情况，其中需要特别注意的是KeeperException.ConnectionLossException 。我们可能需要在遇到KeeperException.ConnectionLossException时进行重试。\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567070364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":180426,"user_name":"钱","can_delete":false,"product_type":"c3","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1582279372,"is_pvip":false,"replies":[{"id":75909,"content":"&gt; 有点浅，还是理解的有问题zk选主使用的是ZAB协议\nZab协议不涉及leader的选举。\n\n&gt; 这里讲的是连接ZK的客户端那个可以作为主嘛？\n所有的节点都可能被选为leader。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1586141272,"ip_address":"","comment_id":180426,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"有点浅，还是理解的有问题zk选主使用的是ZAB协议，这里讲的是连接ZK的客户端那个可以作为主嘛？","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484663,"discussion_content":"&amp;gt; 有点浅，还是理解的有问题zk选主使用的是ZAB协议\nZab协议不涉及leader的选举。\n\n&amp;gt; 这里讲的是连接ZK的客户端那个可以作为主嘛？\n所有的节点都可能被选为leader。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586141272,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143704,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1571758498,"is_pvip":false,"replies":[{"id":56741,"content":"既然A的znode编号是1那就说明ZooKeeper首先为A的创建请求分配的zxid。你说的延迟应该是说ZooKeeper给A返回的响应延迟了，这个不影响zxid的大小。A还是leader。","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1572676425,"ip_address":"","comment_id":143704,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师 想问下zookeeper 帮助别的系统选主过程，\n如果我有 3个系统， A B C 一起动 就像zookeeper 发送选主请求， 我有个疑问 什么时候zookeeper返回确定哪个是主的请求  比如 假设 A 创建的是node 1， B node2， C node3， 您说 是选小的 也就是A 是主， 但是假设 A 延迟了， B 和C 发送了请求， 完后选了主 就会是B， 但是这时候A 咋办？","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471660,"discussion_content":"既然A的znode编号是1那就说明ZooKeeper首先为A的创建请求分配的zxid。你说的延迟应该是说ZooKeeper给A返回的响应延迟了，这个不影响zxid的大小。A还是leader。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572676425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}