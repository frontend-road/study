{"id":104273,"title":"42 | IPCï¼ˆä¸‹ï¼‰ï¼šä¸åŒé¡¹ç›®ç»„ä¹‹é—´æŠ¢èµ„æºï¼Œå¦‚ä½•åè°ƒï¼Ÿ","content":"<p>IPCè¿™å—çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸ºäº†è®©ä½ èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£ï¼Œæˆ‘åˆ†æˆäº†ä¸‰èŠ‚æ¥è®²ã€‚å‰é¢æˆ‘ä»¬è§£æå®Œäº†å…±äº«å†…å­˜çš„å†…æ ¸æœºåˆ¶åï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹æœ€åä¸€éƒ¨åˆ†ï¼Œä¿¡å·é‡çš„å†…æ ¸æœºåˆ¶ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œè°ƒç”¨çš„æ˜¯ç³»ç»Ÿè°ƒç”¨semgetã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>SYSCALL_DEFINE3(semget, key_t, key, int, nsems, int, semflg)\n{\n\tstruct ipc_namespace *ns;\n\tstatic const struct ipc_ops sem_ops = {\n\t\t.getnew = newary,\n\t\t.associate = sem_security,\n\t\t.more_checks = sem_more_checks,\n\t};\n\tstruct ipc_params sem_params;\n\tns = current-&gt;nsproxy-&gt;ipc_ns;\n\tsem_params.key = key;\n\tsem_params.flg = semflg;\n\tsem_params.u.nsems = nsems;\n\treturn ipcget(ns, &amp;sem_ids(ns), &amp;sem_ops, &amp;sem_params);\n}\n</code></pre><p>æˆ‘ä»¬è§£æè¿‡äº†å…±äº«å†…å­˜ï¼Œå†çœ‹ä¿¡å·é‡ï¼Œå°±é¡ºç•…å¾ˆå¤šäº†ã€‚è¿™é‡ŒåŒæ ·è°ƒç”¨äº†æŠ½è±¡çš„ipcgetï¼Œå‚æ•°åˆ†åˆ«ä¸ºä¿¡å·é‡å¯¹åº”çš„sem_idsã€å¯¹åº”çš„æ“ä½œsem_opsä»¥åŠå¯¹åº”çš„å‚æ•°sem_paramsã€‚</p><p>ipcgetçš„ä»£ç æˆ‘ä»¬å·²ç»è§£æè¿‡äº†ã€‚å¦‚æœkeyè®¾ç½®ä¸ºIPC_PRIVATEåˆ™æ°¸è¿œåˆ›å»ºæ–°çš„ï¼›å¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±ä¼šè°ƒç”¨ipcget_publicã€‚</p><p>åœ¨ipcget_publicä¸­ï¼Œæˆ‘ä»¬èƒ½ä¼šæŒ‰ç…§keyï¼Œå»æŸ¥æ‰¾struct kern_ipc_permã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£å°±çœ‹çœ‹æ˜¯å¦è®¾ç½®äº†IPC_CREATã€‚å¦‚æœè®¾ç½®äº†ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±å°†å¯¹åº”çš„idè¿”å›ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œé‡ç‚¹çœ‹ï¼Œå¦‚ä½•æŒ‰ç…§å‚æ•°sem_opsï¼Œåˆ›å»ºæ–°çš„ä¿¡å·é‡ä¼šè°ƒç”¨newaryã€‚</p><pre><code>static int newary(struct ipc_namespace *ns, struct ipc_params *params)\n{\n\tint retval;\n\tstruct sem_array *sma;\n\tkey_t key = params-&gt;key;\n\tint nsems = params-&gt;u.nsems;\n\tint semflg = params-&gt;flg;\n\tint i;\n......\n\tsma = sem_alloc(nsems);\n......\n\tsma-&gt;sem_perm.mode = (semflg &amp; S_IRWXUGO);\n\tsma-&gt;sem_perm.key = key;\n\tsma-&gt;sem_perm.security = NULL;\n......\n\tfor (i = 0; i &lt; nsems; i++) {\n\t\tINIT_LIST_HEAD(&amp;sma-&gt;sems[i].pending_alter);\n\t\tINIT_LIST_HEAD(&amp;sma-&gt;sems[i].pending_const);\n\t\tspin_lock_init(&amp;sma-&gt;sems[i].lock);\n\t}\n\tsma-&gt;complex_count = 0;\n\tsma-&gt;use_global_lock = USE_GLOBAL_LOCK_HYSTERESIS;\n\tINIT_LIST_HEAD(&amp;sma-&gt;pending_alter);\n\tINIT_LIST_HEAD(&amp;sma-&gt;pending_const);\n\tINIT_LIST_HEAD(&amp;sma-&gt;list_id);\n\tsma-&gt;sem_nsems = nsems;\n\tsma-&gt;sem_ctime = get_seconds();\n\tretval = ipc_addid(&amp;sem_ids(ns), &amp;sma-&gt;sem_perm, ns-&gt;sc_semmni);\n......\n\tns-&gt;used_sems += nsems;\n......\n\treturn sma-&gt;sem_perm.id;\n}\n</code></pre><p>newaryå‡½æ•°çš„ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡kvmallocåœ¨ç›´æ¥æ˜ å°„åŒºåˆ†é…ä¸€ä¸ªstruct sem_arrayç»“æ„ã€‚è¿™ä¸ªç»“æ„æ˜¯ç”¨æ¥æè¿°ä¿¡å·é‡çš„ï¼Œè¿™ä¸ªç»“æ„æœ€å¼€å§‹å°±æ˜¯ä¸Šé¢è¯´çš„struct kern_ipc_permç»“æ„ã€‚æ¥ä¸‹æ¥å°±æ˜¯å¡«å……è¿™ä¸ªstruct sem_arrayç»“æ„ï¼Œä¾‹å¦‚keyã€æƒé™ç­‰ã€‚</p><!-- [[[read_end]]] --><p>struct sem_arrayé‡Œæœ‰å¤šä¸ªä¿¡å·é‡ï¼Œæ”¾åœ¨struct sem sems[]æ•°ç»„é‡Œé¢ï¼Œåœ¨struct semé‡Œé¢æœ‰å½“å‰çš„ä¿¡å·é‡çš„æ•°å€¼semvalã€‚</p><pre><code>struct sem {\n\tint\tsemval;\t\t/* current value */\n\t/*\n\t * PID of the process that last modified the semaphore. For\n\t * Linux, specifically these are:\n\t *  - semop\n\t *  - semctl, via SETVAL and SETALL.\n\t *  - at task exit when performing undo adjustments (see exit_sem).\n\t */\n\tint\tsempid;\n\tspinlock_t\tlock;\t/* spinlock for fine-grained semtimedop */\n\tstruct list_head pending_alter; /* pending single-sop operations that alter the semaphore */\n\tstruct list_head pending_const; /* pending single-sop operations that do not alter the semaphore*/\n\ttime_t\tsem_otime;\t/* candidate for sem_otime */\n} ____cacheline_aligned_in_smp;\n</code></pre><p>struct sem_arrayå’Œstruct semå„æœ‰ä¸€ä¸ªé“¾è¡¨struct list_head pending_alterï¼Œåˆ†åˆ«è¡¨ç¤ºå¯¹äºæ•´ä¸ªä¿¡å·é‡æ•°ç»„çš„ä¿®æ”¹å’Œå¯¹äºæŸä¸ªä¿¡å·é‡çš„ä¿®æ”¹ã€‚</p><p>newaryå‡½æ•°çš„ç¬¬äºŒæ­¥ï¼Œå°±æ˜¯åˆå§‹åŒ–è¿™äº›é“¾è¡¨ã€‚</p><p>newaryå‡½æ•°çš„ç¬¬ä¸‰æ­¥ï¼Œé€šè¿‡ipc_addidå°†æ–°åˆ›å»ºçš„struct sem_arrayç»“æ„ï¼ŒæŒ‚åˆ°sem_idsé‡Œé¢çš„åŸºæ•°æ ‘ä¸Šï¼Œå¹¶è¿”å›ç›¸åº”çš„idã€‚</p><p>ä¿¡å·é‡åˆ›å»ºçš„è¿‡ç¨‹åˆ°æ­¤ç»“æŸï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ï¼Œå¦‚ä½•é€šè¿‡semctlå¯¹ä¿¡å·é‡æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ã€‚</p><pre><code>SYSCALL_DEFINE4(semctl, int, semid, int, semnum, int, cmd, unsigned long, arg)\n{\n\tint version;\n\tstruct ipc_namespace *ns;\n\tvoid __user *p = (void __user *)arg;\n\tns = current-&gt;nsproxy-&gt;ipc_ns;\n\tswitch (cmd) {\n\tcase IPC_INFO:\n\tcase SEM_INFO:\n\tcase IPC_STAT:\n\tcase SEM_STAT:\n\t\treturn semctl_nolock(ns, semid, cmd, version, p);\n\tcase GETALL:\n\tcase GETVAL:\n\tcase GETPID:\n\tcase GETNCNT:\n\tcase GETZCNT:\n\tcase SETALL:\n\t\treturn semctl_main(ns, semid, semnum, cmd, p);\n\tcase SETVAL:\n\t\treturn semctl_setval(ns, semid, semnum, arg);\n\tcase IPC_RMID:\n\tcase IPC_SET:\n\t\treturn semctl_down(ns, semid, cmd, version, p);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n</code></pre><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ï¼ŒSETALLæ“ä½œè°ƒç”¨çš„semctl_mainå‡½æ•°ï¼Œä»¥åŠSETVALæ“ä½œè°ƒç”¨çš„semctl_setvalå‡½æ•°ã€‚</p><p>å¯¹äºSETALLæ“ä½œæ¥è®²ï¼Œä¼ è¿›æ¥çš„å‚æ•°ä¸ºunion semuné‡Œé¢çš„unsigned short *arrayï¼Œä¼šè®¾ç½®æ•´ä¸ªä¿¡å·é‡é›†åˆã€‚</p><pre><code>static int semctl_main(struct ipc_namespace *ns, int semid, int semnum,\n\t\tint cmd, void __user *p)\n{\n\tstruct sem_array *sma;\n\tstruct sem *curr;\n\tint err, nsems;\n\tushort fast_sem_io[SEMMSL_FAST];\n\tushort *sem_io = fast_sem_io;\n\tDEFINE_WAKE_Q(wake_q);\n\tsma = sem_obtain_object_check(ns, semid);\n\tnsems = sma-&gt;sem_nsems;\n......\n\tswitch (cmd) {\n......\n\tcase SETALL:\n\t{\n\t\tint i;\n\t\tstruct sem_undo *un;\n......\n\t\tif (copy_from_user(sem_io, p, nsems*sizeof(ushort))) {\n......\n\t\t}\n......\n\t\tfor (i = 0; i &lt; nsems; i++) {\n\t\t\tsma-&gt;sems[i].semval = sem_io[i];\n\t\t\tsma-&gt;sems[i].sempid = task_tgid_vnr(current);\n\t\t}\n......\n\t\tsma-&gt;sem_ctime = get_seconds();\n\t\t/* maybe some queued-up processes were waiting for this */\n\t\tdo_smart_update(sma, NULL, 0, 0, &amp;wake_q);\n\t\terr = 0;\n\t\tgoto out_unlock;\n\t}\n\t}\n......\n    wake_up_q(&amp;wake_q);\n......\n}\n</code></pre><p>åœ¨semctl_mainå‡½æ•°ä¸­ï¼Œå…ˆæ˜¯é€šè¿‡sem_obtain_object_checkï¼Œæ ¹æ®ä¿¡å·é‡é›†åˆçš„idåœ¨åŸºæ•°æ ‘é‡Œé¢æ‰¾åˆ°struct sem_arrayå¯¹è±¡ï¼Œå‘ç°å¦‚æœæ˜¯SETALLæ“ä½œï¼Œå°±å°†ç”¨æˆ·çš„å‚æ•°ä¸­çš„unsigned short *arrayé€šè¿‡copy_from_useræ‹·è´åˆ°å†…æ ¸é‡Œé¢çš„sem_ioæ•°ç»„ï¼Œç„¶åæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå¯¹äºä¿¡å·é‡é›†åˆé‡Œé¢çš„æ¯ä¸€ä¸ªä¿¡å·é‡ï¼Œè®¾ç½®semvalï¼Œä»¥åŠä¿®æ”¹è¿™ä¸ªä¿¡å·é‡å€¼çš„pidã€‚</p><p>å¯¹äºSETVALæ“ä½œæ¥è®²ï¼Œä¼ è¿›æ¥çš„å‚æ•°union semuné‡Œé¢çš„int valï¼Œä»…ä»…ä¼šè®¾ç½®æŸä¸ªä¿¡å·é‡ã€‚</p><pre><code>static int semctl_setval(struct ipc_namespace *ns, int semid, int semnum,\n\t\tunsigned long arg)\n{\n\tstruct sem_undo *un;\n\tstruct sem_array *sma;\n\tstruct sem *curr;\n\tint err, val;\n\tDEFINE_WAKE_Q(wake_q);\n......\n\tsma = sem_obtain_object_check(ns, semid);\n......\n\tcurr = &amp;sma-&gt;sems[semnum];\n......\n\tcurr-&gt;semval = val;\n\tcurr-&gt;sempid = task_tgid_vnr(current);\n\tsma-&gt;sem_ctime = get_seconds();\n\t/* maybe some queued-up processes were waiting for this */\n\tdo_smart_update(sma, NULL, 0, 0, &amp;wake_q);\n......\n\twake_up_q(&amp;wake_q);\n\treturn 0;\n}\n</code></pre><p>åœ¨semctl_setvalå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å…ˆæ˜¯é€šè¿‡sem_obtain_object_checkï¼Œæ ¹æ®ä¿¡å·é‡é›†åˆçš„idåœ¨åŸºæ•°æ ‘é‡Œé¢æ‰¾åˆ°struct sem_arrayå¯¹è±¡ï¼Œå¯¹äºSETVALæ“ä½œï¼Œç›´æ¥æ ¹æ®å‚æ•°ä¸­çš„valè®¾ç½®semvalï¼Œä»¥åŠä¿®æ”¹è¿™ä¸ªä¿¡å·é‡å€¼çš„pidã€‚</p><p>è‡³æ­¤ï¼Œä¿¡å·é‡æ•°ç»„åˆå§‹åŒ–å®Œæ¯•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹Pæ“ä½œå’ŒVæ“ä½œã€‚æ— è®ºæ˜¯Pæ“ä½œï¼Œè¿˜æ˜¯Væ“ä½œéƒ½æ˜¯è°ƒç”¨semopç³»ç»Ÿè°ƒç”¨ã€‚</p><pre><code>SYSCALL_DEFINE3(semop, int, semid, struct sembuf __user *, tsops,\n\t\tunsigned, nsops)\n{\n\treturn sys_semtimedop(semid, tsops, nsops, NULL);\n}\n\nSYSCALL_DEFINE4(semtimedop, int, semid, struct sembuf __user *, tsops,\n\t\tunsigned, nsops, const struct timespec __user *, timeout)\n{\n\tint error = -EINVAL;\n\tstruct sem_array *sma;\n\tstruct sembuf fast_sops[SEMOPM_FAST];\n\tstruct sembuf *sops = fast_sops, *sop;\n\tstruct sem_undo *un;\n\tint max, locknum;\n\tbool undos = false, alter = false, dupsop = false;\n\tstruct sem_queue queue;\n\tunsigned long dup = 0, jiffies_left = 0;\n\tstruct ipc_namespace *ns;\n\n\tns = current-&gt;nsproxy-&gt;ipc_ns;\n......\n\tif (copy_from_user(sops, tsops, nsops * sizeof(*tsops))) {\n\t\terror =  -EFAULT;\n\t\tgoto out_free;\n\t}\n\n\tif (timeout) {\n\t\tstruct timespec _timeout;\n\t\tif (copy_from_user(&amp;_timeout, timeout, sizeof(*timeout))) {\n\t\t}\n\t\tjiffies_left = timespec_to_jiffies(&amp;_timeout);\n\t}\n......\n\t/* On success, find_alloc_undo takes the rcu_read_lock */\n\tun = find_alloc_undo(ns, semid);\n......\n\tsma = sem_obtain_object_check(ns, semid);\n......\n\tqueue.sops = sops;\n\tqueue.nsops = nsops;\n\tqueue.undo = un;\n\tqueue.pid = task_tgid_vnr(current);\n\tqueue.alter = alter;\n\tqueue.dupsop = dupsop;\n\n\terror = perform_atomic_semop(sma, &amp;queue);\n\tif (error == 0) { /* non-blocking succesfull path */\n\t\tDEFINE_WAKE_Q(wake_q);\n......\n\t\tdo_smart_update(sma, sops, nsops, 1, &amp;wake_q);\n......\n\t\twake_up_q(&amp;wake_q);\n\t\tgoto out_free;\n\t}\n\t/*\n\t * We need to sleep on this operation, so we put the current\n\t * task into the pending queue and go to sleep.\n\t */\n\tif (nsops == 1) {\n\t\tstruct sem *curr;\n\t\tcurr = &amp;sma-&gt;sems[sops-&gt;sem_num];\n......\n\t\tlist_add_tail(&amp;queue.list,\n\t\t\t\t\t\t&amp;curr-&gt;pending_alter);\n......\n\t} else {\n......\n\t\tlist_add_tail(&amp;queue.list, &amp;sma-&gt;pending_alter);\n......\n\t}\n\n\tdo {\n\t\tqueue.status = -EINTR;\n\t\tqueue.sleeper = current;\n\n\t\t__set_current_state(TASK_INTERRUPTIBLE);\n\t\tif (timeout)\n\t\t\tjiffies_left = schedule_timeout(jiffies_left);\n\t\telse\n\t\t\tschedule();\n......\n\t\t/*\n\t\t * If an interrupt occurred we have to clean up the queue.\n\t\t */\n\t\tif (timeout &amp;&amp; jiffies_left == 0)\n\t\t\terror = -EAGAIN;\n\t} while (error == -EINTR &amp;&amp; !signal_pending(current)); /* spurious */\n......\n}\n</code></pre><p>semopä¼šè°ƒç”¨semtimedopï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„å‡½æ•°ã€‚</p><p>semtimedopåšçš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å°†ç”¨æˆ·çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼Œå¯¹äºä¿¡å·é‡çš„æ“ä½œstruct sembufï¼Œæ‹·è´åˆ°å†…æ ¸é‡Œé¢æ¥ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯Pæ“ä½œï¼Œå¾ˆå¯èƒ½è®©è¿›ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œæ˜¯å¦è¦ä¸ºè¿™ä¸ªç­‰å¾…çŠ¶æ€è®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œtimeoutä¹Ÿæ˜¯ä¸€ä¸ªå‚æ•°ï¼Œä¼šæŠŠå®ƒå˜æˆæ—¶é’Ÿçš„æ»´ç­”æ•°ç›®ã€‚</p><p>semtimedopåšçš„ç¬¬äºŒä»¶äº‹æƒ…ï¼Œæ˜¯é€šè¿‡sem_obtain_object_checkï¼Œæ ¹æ®ä¿¡å·é‡é›†åˆçš„idï¼Œè·å¾—struct sem_arrayï¼Œç„¶åï¼Œåˆ›å»ºä¸€ä¸ªstruct sem_queueè¡¨ç¤ºå½“å‰çš„ä¿¡å·é‡æ“ä½œã€‚ä¸ºä»€ä¹ˆå«queueå‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªæ“ä½œå¯èƒ½é©¬ä¸Šå°±èƒ½å®Œæˆï¼Œä¹Ÿå¯èƒ½å› ä¸ºæ— æ³•è·å–ä¿¡å·é‡ä¸èƒ½å®Œæˆï¼Œä¸èƒ½å®Œæˆçš„è¯å°±åªå¥½æ’åˆ—åˆ°é˜Ÿåˆ—ä¸Šï¼Œç­‰å¾…ä¿¡å·é‡æ»¡è¶³æ¡ä»¶çš„æ—¶å€™ã€‚semtimedopä¼šè°ƒç”¨perform_atomic_semopåœ¨å®æ–½ä¿¡å·é‡æ“ä½œã€‚</p><pre><code>static int perform_atomic_semop(struct sem_array *sma, struct sem_queue *q)\n{\n\tint result, sem_op, nsops;\n\tstruct sembuf *sop;\n\tstruct sem *curr;\n\tstruct sembuf *sops;\n\tstruct sem_undo *un;\n\n\tsops = q-&gt;sops;\n\tnsops = q-&gt;nsops;\n\tun = q-&gt;undo;\n\n\tfor (sop = sops; sop &lt; sops + nsops; sop++) {\n\t\tcurr = &amp;sma-&gt;sems[sop-&gt;sem_num];\n\t\tsem_op = sop-&gt;sem_op;\n\t\tresult = curr-&gt;semval;\n......\n\t\tresult += sem_op;\n\t\tif (result &lt; 0)\n\t\t\tgoto would_block;\n......\n\t\tif (sop-&gt;sem_flg &amp; SEM_UNDO) {\n\t\t\tint undo = un-&gt;semadj[sop-&gt;sem_num] - sem_op;\n.....\n\t\t}\n\t}\n\n\tfor (sop = sops; sop &lt; sops + nsops; sop++) {\n\t\tcurr = &amp;sma-&gt;sems[sop-&gt;sem_num];\n\t\tsem_op = sop-&gt;sem_op;\n\t\tresult = curr-&gt;semval;\n\n\t\tif (sop-&gt;sem_flg &amp; SEM_UNDO) {\n\t\t\tint undo = un-&gt;semadj[sop-&gt;sem_num] - sem_op;\n\t\t\tun-&gt;semadj[sop-&gt;sem_num] = undo;\n\t\t}\n\t\tcurr-&gt;semval += sem_op;\n\t\tcurr-&gt;sempid = q-&gt;pid;\n\t}\n\treturn 0;\nwould_block:\n\tq-&gt;blocking = sop;\n\treturn sop-&gt;sem_flg &amp; IPC_NOWAIT ? -EAGAIN : 1;\n}\n</code></pre><p>åœ¨perform_atomic_semopå‡½æ•°ä¸­ï¼Œå¯¹äºæ‰€æœ‰ä¿¡å·é‡æ“ä½œéƒ½è¿›è¡Œä¸¤æ¬¡å¾ªç¯ã€‚åœ¨ç¬¬ä¸€æ¬¡å¾ªç¯ä¸­ï¼Œå¦‚æœå‘ç°è®¡ç®—å‡ºçš„resultå°äº0ï¼Œåˆ™è¯´æ˜å¿…é¡»ç­‰å¾…ï¼Œäºæ˜¯è·³åˆ°would_blockä¸­ï¼Œè®¾ç½®q-&gt;blocking = sopè¡¨ç¤ºè¿™ä¸ªqueueæ˜¯blockåœ¨è¿™ä¸ªæ“ä½œä¸Šï¼Œç„¶åå¦‚æœéœ€è¦ç­‰å¾…ï¼Œåˆ™è¿”å›1ã€‚å¦‚æœç¬¬ä¸€æ¬¡å¾ªç¯ä¸­å‘ç°æ— éœ€ç­‰å¾…ï¼Œåˆ™ç¬¬äºŒä¸ªå¾ªç¯å®æ–½æ‰€æœ‰çš„ä¿¡å·é‡æ“ä½œï¼Œå°†ä¿¡å·é‡çš„å€¼è®¾ç½®ä¸ºæ–°çš„å€¼ï¼Œå¹¶ä¸”è¿”å›0ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å›åˆ°semtimedopï¼Œæ¥çœ‹å®ƒå¹²çš„ç¬¬ä¸‰ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å¦‚æœéœ€è¦ç­‰å¾…ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>å¦‚æœéœ€è¦ç­‰å¾…ï¼Œåˆ™è¦åŒºåˆ†åˆšæ‰çš„å¯¹äºä¿¡å·é‡çš„æ“ä½œï¼Œæ˜¯å¯¹ä¸€ä¸ªä¿¡å·é‡çš„ï¼Œè¿˜æ˜¯å¯¹äºæ•´ä¸ªä¿¡å·é‡é›†åˆçš„ã€‚å¦‚æœæ˜¯å¯¹äºä¸€ä¸ªä¿¡å·é‡çš„ï¼Œé‚£æˆ‘ä»¬å°±å°†queueæŒ‚åˆ°è¿™ä¸ªä¿¡å·é‡çš„pending_alterä¸­ï¼›å¦‚æœæ˜¯å¯¹äºæ•´ä¸ªä¿¡å·é‡é›†åˆçš„ï¼Œé‚£æˆ‘ä»¬å°±å°†queueæŒ‚åˆ°æ•´ä¸ªä¿¡å·é‡é›†åˆçš„pending_alterä¸­ã€‚</p><p>æ¥ä¸‹æ¥çš„do-whileå¾ªç¯ï¼Œå°±æ˜¯è¦å¼€å§‹ç­‰å¾…äº†ã€‚å¦‚æœç­‰å¾…æ²¡æœ‰æ—¶é—´é™åˆ¶ï¼Œåˆ™è°ƒç”¨scheduleè®©å‡ºCPUï¼›å¦‚æœç­‰å¾…æœ‰æ—¶é—´é™åˆ¶ï¼Œåˆ™è°ƒç”¨schedule_timeoutè®©å‡ºCPUï¼Œè¿‡ä¸€æ®µæ—¶é—´è¿˜å›æ¥ã€‚å½“å›æ¥çš„æ—¶å€™ï¼Œåˆ¤æ–­æ˜¯å¦ç­‰å¾…è¶…æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç­‰å¾…è¶…æ—¶åˆ™è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ï¼Œå†æ¬¡ç­‰å¾…ï¼Œå¦‚æœè¶…æ—¶åˆ™é€€å‡ºå¾ªç¯ï¼Œè¿”å›é”™è¯¯ã€‚åœ¨è®©å‡ºCPUçš„æ—¶å€™ï¼Œè®¾ç½®è¿›ç¨‹çš„çŠ¶æ€ä¸ºTASK_INTERRUPTIBLEï¼Œå¹¶ä¸”å¾ªç¯çš„ç»“æŸä¼šé€šè¿‡signal_pendingæŸ¥çœ‹æ˜¯å¦æ”¶åˆ°è¿‡ä¿¡å·ï¼Œè¿™è¯´æ˜è¿™ä¸ªç­‰å¾…ä¿¡å·é‡çš„è¿›ç¨‹æ˜¯å¯ä»¥è¢«ä¿¡å·ä¸­æ–­çš„ï¼Œä¹Ÿå³ä¸€ä¸ªç­‰å¾…ä¿¡å·é‡çš„è¿›ç¨‹æ˜¯å¯ä»¥é€šè¿‡killæ€æ‰çš„ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ï¼Œsemtimedopè¦åšçš„ç¬¬å››ä»¶äº‹æƒ…ï¼Œå¦‚æœä¸éœ€è¦ç­‰å¾…ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>å¦‚æœä¸éœ€è¦ç­‰å¾…ï¼Œå°±è¯´æ˜å¯¹äºä¿¡å·é‡çš„æ“ä½œå®Œæˆäº†ï¼Œä¹Ÿæ”¹å˜äº†ä¿¡å·é‡çš„å€¼ã€‚æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ä¸€ä¸ªæ ‡å‡†æµç¨‹ã€‚æˆ‘ä»¬é€šè¿‡DEFINE_WAKE_Q(wake_q)å£°æ˜ä¸€ä¸ªwake_qï¼Œè°ƒç”¨do_smart_updateï¼Œçœ‹è¿™æ¬¡å¯¹äºä¿¡å·é‡çš„å€¼çš„æ”¹å˜ï¼Œå¯ä»¥å½±å“å¹¶å¯ä»¥æ¿€æ´»ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å“ªäº›struct sem_queueï¼Œç„¶åæŠŠå®ƒä»¬éƒ½æ”¾åœ¨wake_qé‡Œé¢ï¼Œè°ƒç”¨wake_up_qå”¤é†’è¿™äº›è¿›ç¨‹ã€‚å…¶å®ï¼Œæ‰€æœ‰çš„å¯¹äºä¿¡å·é‡çš„å€¼çš„ä¿®æ”¹éƒ½ä¼šæ¶‰åŠè¿™ä¸‰ä¸ªæ“ä½œï¼Œå¦‚æœä½ å›è¿‡å¤´å»ä»”ç»†çœ‹SETALLå’ŒSETVALæ“ä½œï¼Œåœ¨è®¾ç½®å®Œæ¯•ä¿¡å·é‡ä¹‹åï¼Œä¹Ÿæ˜¯è¿™ä¸‰ä¸ªæ“ä½œã€‚</p><p>æˆ‘ä»¬æ¥çœ‹do_smart_updateæ˜¯å¦‚ä½•å®ç°çš„ã€‚do_smart_updateä¼šè°ƒç”¨update_queueã€‚</p><pre><code>static int update_queue(struct sem_array *sma, int semnum, struct wake_q_head *wake_q)\n{\n\tstruct sem_queue *q, *tmp;\n\tstruct list_head *pending_list;\n\tint semop_completed = 0;\n\n\tif (semnum == -1)\n\t\tpending_list = &amp;sma-&gt;pending_alter;\n\telse\n\t\tpending_list = &amp;sma-&gt;sems[semnum].pending_alter;\n\nagain:\n\tlist_for_each_entry_safe(q, tmp, pending_list, list) {\n\t\tint error, restart;\n......\n\t\terror = perform_atomic_semop(sma, q);\n\n\t\t/* Does q-&gt;sleeper still need to sleep? */\n\t\tif (error &gt; 0)\n\t\t\tcontinue;\n\n\t\tunlink_queue(sma, q);\n......\n\t\twake_up_sem_queue_prepare(q, error, wake_q);\n......\n\t}\n\treturn semop_completed;\n}\n\nstatic inline void wake_up_sem_queue_prepare(struct sem_queue *q, int error,\n\t\t\t\t\t     struct wake_q_head *wake_q)\n{\n\twake_q_add(wake_q, q-&gt;sleeper);\n......\n}\n</code></pre><p>update_queueä¼šä¾æ¬¡å¾ªç¯æ•´ä¸ªä¿¡å·é‡é›†åˆçš„ç­‰å¾…é˜Ÿåˆ—pending_alterï¼Œæˆ–è€…æŸä¸ªä¿¡å·é‡çš„ç­‰å¾…é˜Ÿåˆ—ã€‚è¯•å›¾åœ¨ä¿¡å·é‡çš„å€¼å˜äº†çš„æƒ…å†µä¸‹ï¼Œå†æ¬¡å°è¯•perform_atomic_semopè¿›è¡Œä¿¡å·é‡æ“ä½œã€‚å¦‚æœä¸æˆåŠŸï¼Œåˆ™å°è¯•é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªï¼›å¦‚æœå°è¯•æˆåŠŸï¼Œåˆ™è°ƒç”¨unlink_queueä»é˜Ÿåˆ—ä¸Šå–ä¸‹æ¥ï¼Œç„¶åè°ƒç”¨wake_up_sem_queue_prepareï¼Œå°†q-&gt;sleeperåŠ åˆ°wake_qä¸Šå»ã€‚q-&gt;sleeperæ˜¯ä¸€ä¸ªtask_structï¼Œæ˜¯ç­‰å¾…åœ¨è¿™ä¸ªä¿¡å·é‡æ“ä½œä¸Šçš„è¿›ç¨‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œwake_up_qå°±ä¾æ¬¡å”¤é†’wake_qä¸Šçš„æ‰€æœ‰task_structï¼Œè°ƒç”¨çš„æ˜¯æˆ‘ä»¬åœ¨è¿›ç¨‹è°ƒåº¦é‚£ä¸€èŠ‚å­¦è¿‡çš„wake_up_processæ–¹æ³•ã€‚</p><pre><code>void wake_up_q(struct wake_q_head *head)\n{\n\tstruct wake_q_node *node = head-&gt;first;\n\n\twhile (node != WAKE_Q_TAIL) {\n\t\tstruct task_struct *task;\n\n\t\ttask = container_of(node, struct task_struct, wake_q);\n\n\t\tnode = node-&gt;next;\n\t\ttask-&gt;wake_q.next = NULL;\n\n\t\twake_up_process(task);\n\t\tput_task_struct(task);\n\t}\n}\n\n</code></pre><p>è‡³æ­¤ï¼Œå¯¹äºä¿¡å·é‡çš„ä¸»æµæ“ä½œéƒ½è§£æå®Œæ¯•äº†ã€‚</p><p>å…¶å®è¿˜æœ‰ä¸€ç‚¹éœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œä¿¡å·é‡æ˜¯ä¸€ä¸ªæ•´ä¸ªLinuxå¯è§çš„å…¨å±€èµ„æºï¼Œè€Œä¸åƒå’±ä»¬åœ¨çº¿ç¨‹åŒæ­¥é‚£ä¸€èŠ‚è®²è¿‡çš„éƒ½æ˜¯æŸä¸ªè¿›ç¨‹ç‹¬å çš„èµ„æºï¼Œå¥½å¤„æ˜¯å¯ä»¥è·¨è¿›ç¨‹é€šä¿¡ï¼Œåå¤„å°±æ˜¯å¦‚æœä¸€ä¸ªè¿›ç¨‹é€šè¿‡Pæ“ä½œæ‹¿åˆ°äº†ä¸€ä¸ªä¿¡å·é‡ï¼Œä½†æ˜¯ä¸å¹¸å¼‚å¸¸é€€å‡ºäº†ï¼Œå¦‚æœæ²¡æœ‰æ¥å¾—åŠå½’è¿˜è¿™ä¸ªä¿¡å·é‡ï¼Œå¯èƒ½æ‰€æœ‰å…¶ä»–çš„è¿›ç¨‹éƒ½é˜»å¡äº†ã€‚</p><p>é‚£æ€ä¹ˆåŠå‘¢ï¼ŸLinuxæœ‰ä¸€ç§æœºåˆ¶å«SEM_UNDOï¼Œä¹Ÿå³æ¯ä¸€ä¸ªsemopæ“ä½œéƒ½ä¼šä¿å­˜ä¸€ä¸ªåå‘struct sem_undoæ“ä½œï¼Œå½“å› ä¸ºæŸä¸ªè¿›ç¨‹å¼‚å¸¸é€€å‡ºçš„æ—¶å€™ï¼Œè¿™ä¸ªè¿›ç¨‹åšçš„æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šå›é€€ï¼Œä»è€Œä¿è¯å…¶ä»–è¿›ç¨‹å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p><p>å¦‚æœä½ å›å¤´çœ‹ï¼Œæˆ‘ä»¬å†™çš„ç¨‹åºé‡Œé¢çš„semaphore_på‡½æ•°å’Œsemaphore_vå‡½æ•°ï¼Œéƒ½æŠŠsem_flgè®¾ç½®ä¸ºSEM_UNDOï¼Œå°±æ˜¯è¿™ä¸ªä½œç”¨ã€‚</p><p>ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„æ¯ä¸€ä¸ªstruct sem_queueï¼Œéƒ½æœ‰ä¸€ä¸ªstruct sem_undoï¼Œä»¥æ­¤æ¥è¡¨ç¤ºè¿™æ¬¡æ“ä½œçš„åå‘æ“ä½œã€‚</p><pre><code>struct sem_queue {\n\tstruct list_head\tlist;\t /* queue of pending operations */\n\tstruct task_struct\t*sleeper; /* this process */\n\tstruct sem_undo\t\t*undo;\t /* undo structure */\n\tint\t\t\tpid;\t /* process id of requesting process */\n\tint\t\t\tstatus;\t /* completion status of operation */\n\tstruct sembuf\t\t*sops;\t /* array of pending operations */\n\tstruct sembuf\t\t*blocking; /* the operation that blocked */\n\tint\t\t\tnsops;\t /* number of operations */\n\tbool\t\t\talter;\t /* does *sops alter the array? */\n\tbool                    dupsop;\t /* sops on more than one sem_num */\n};\n</code></pre><p>åœ¨è¿›ç¨‹çš„task_structé‡Œé¢å¯¹äºä¿¡å·é‡æœ‰ä¸€ä¸ªæˆå‘˜struct sysv_semï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªstruct sem_undo_listï¼Œå°†è¿™ä¸ªè¿›ç¨‹æ‰€æœ‰çš„semopæ‰€å¸¦æ¥çš„undoæ“ä½œéƒ½ä¸²èµ·æ¥ã€‚</p><pre><code>struct task_struct {\n......\nstruct sysv_sem\t\t\tsysvsem;\n......\n}\n\nstruct sysv_sem {\n\tstruct sem_undo_list *undo_list;\n};\n\nstruct sem_undo {\n\tstruct list_head\tlist_proc;\t/* per-process list: *\n\t\t\t\t\t\t * all undos from one process\n\t\t\t\t\t\t * rcu protected */\n\tstruct rcu_head\t\trcu;\t\t/* rcu struct for sem_undo */\n\tstruct sem_undo_list\t*ulp;\t\t/* back ptr to sem_undo_list */\n\tstruct list_head\tlist_id;\t/* per semaphore array list:\n\t\t\t\t\t\t * all undos for one array */\n\tint\t\t\tsemid;\t\t/* semaphore set identifier */\n\tshort\t\t\t*semadj;\t/* array of adjustments */\n\t\t\t\t\t\t/* one per semaphore */\n};\n\nstruct sem_undo_list {\n\tatomic_t\t\trefcnt;\n\tspinlock_t\t\tlock;\n\tstruct list_head\tlist_proc;\n};\n</code></pre><p>ä¸ºäº†è®©ä½ æ›´æ¸…æ¥šåœ°ç†è§£struct sem_undoçš„åŸç†ï¼Œæˆ‘ä»¬è¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­ã€‚</p><p>å‡è®¾æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªä¿¡å·é‡é›†åˆã€‚ä¸€ä¸ªå«semaphore1ï¼Œå®ƒåŒ…å«ä¸‰ä¸ªä¿¡å·é‡ï¼Œåˆå§‹åŒ–å€¼ä¸º3ï¼Œå¦ä¸€ä¸ªå«semaphore2ï¼Œå®ƒåŒ…å«4ä¸ªä¿¡å·é‡ï¼Œåˆå§‹åŒ–å€¼éƒ½ä¸º4ã€‚åˆå§‹åŒ–æ—¶å€™çš„ä¿¡å·é‡ä»¥åŠundoç»“æ„é‡Œé¢çš„å€¼å¦‚å›¾ä¸­(1)æ ‡å·æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/03/d6/0352227c5f49d194b6094f229220cdd6.png?wh=2983*1897\" alt=\"\"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹è¿›ç¨‹1ã€‚æˆ‘ä»¬è°ƒç”¨semopï¼Œå°†semaphore1çš„ä¸‰ä¸ªä¿¡å·é‡çš„å€¼ï¼Œåˆ†åˆ«åŠ 1ã€åŠ 2å’Œå‡3ï¼Œä»è€Œä¿¡å·é‡çš„å€¼å˜ä¸º4,5,0ã€‚äºæ˜¯åœ¨semaphore1å’Œè¿›ç¨‹1é“¾è¡¨äº¤æ±‡çš„undoç»“æ„é‡Œé¢ï¼Œå¡«å†™-1,-2,+3ï¼Œæ˜¯semopæ“ä½œçš„åå‘æ“ä½œï¼Œå¦‚å›¾ä¸­(2)æ ‡å·æ‰€ç¤ºã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬æ¥çœ‹è¿›ç¨‹2ã€‚æˆ‘ä»¬è°ƒç”¨semopï¼Œå°†semaphore1çš„ä¸‰ä¸ªä¿¡å·é‡çš„å€¼ï¼Œåˆ†åˆ«å‡3ã€åŠ 2å’ŒåŠ 1ï¼Œä»è€Œä¿¡å·é‡çš„å€¼å˜ä¸º1ã€7ã€1ã€‚äºæ˜¯åœ¨semaphore1å’Œè¿›ç¨‹2é“¾è¡¨äº¤æ±‡çš„undoç»“æ„é‡Œé¢ï¼Œå¡«å†™+3ã€-2ã€-1ï¼Œæ˜¯semopæ“ä½œçš„åå‘æ“ä½œï¼Œå¦‚å›¾ä¸­(3)æ ‡å·æ‰€ç¤ºã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬æ¥ç€çœ‹è¿›ç¨‹2ã€‚æˆ‘ä»¬è°ƒç”¨semopï¼Œå°†semaphore2çš„å››ä¸ªä¿¡å·é‡çš„å€¼ï¼Œåˆ†åˆ«å‡3ã€åŠ 1ã€åŠ 4å’Œå‡1ï¼Œä»è€Œä¿¡å·é‡çš„å€¼å˜ä¸º1ã€5ã€8ã€3ã€‚äºæ˜¯ï¼Œåœ¨semaphore2å’Œè¿›ç¨‹2é“¾è¡¨äº¤æ±‡çš„undoç»“æ„é‡Œé¢ï¼Œå¡«å†™+3ã€-1ã€-4ã€+1ï¼Œæ˜¯semopæ“ä½œçš„åå‘æ“ä½œï¼Œå¦‚å›¾ä¸­(4)æ ‡å·æ‰€ç¤ºã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬å†æ¥çœ‹è¿›ç¨‹1ã€‚æˆ‘ä»¬è°ƒç”¨semopï¼Œå°†semaphore2çš„å››ä¸ªä¿¡å·é‡çš„å€¼ï¼Œåˆ†åˆ«å‡1ã€å‡4ã€å‡5å’ŒåŠ 2ï¼Œä»è€Œä¿¡å·é‡çš„å€¼å˜ä¸º0ã€1ã€3ã€5ã€‚äºæ˜¯åœ¨semaphore2å’Œè¿›ç¨‹1é“¾è¡¨äº¤æ±‡çš„undoç»“æ„é‡Œé¢ï¼Œå¡«å†™+1ã€+4ã€+5ã€-2ï¼Œæ˜¯semopæ“ä½œçš„åå‘æ“ä½œï¼Œå¦‚å›¾ä¸­(5)æ ‡å·æ‰€ç¤ºã€‚</p><p>ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œæ— è®ºå“ªä¸ªè¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œåªè¦å°†undoç»“æ„é‡Œé¢çš„å€¼åŠ å›å½“å‰ä¿¡å·é‡çš„å€¼ï¼Œå°±èƒ½å¤Ÿå¾—åˆ°æ­£ç¡®çš„ä¿¡å·é‡çš„å€¼ï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ªè¿›ç¨‹é€€å‡ºï¼Œå¯¼è‡´ä¿¡å·é‡çš„å€¼å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>ä¿¡å·é‡çš„æœºåˆ¶ä¹Ÿå¾ˆå¤æ‚ï¼Œæˆ‘ä»¬å¯¹ç€ä¸‹é¢è¿™ä¸ªå›¾æ€»ç»“ä¸€ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/60/7c/6028c83b0aa00e65916988911aa01b7c.png?wh=4108*3373\" alt=\"\"></p><ol>\n<li>è°ƒç”¨semgetåˆ›å»ºä¿¡å·é‡é›†åˆã€‚</li>\n<li>ipc_findkeyä¼šåœ¨åŸºæ•°æ ‘ä¸­ï¼Œæ ¹æ®keyæŸ¥æ‰¾ä¿¡å·é‡é›†åˆsem_arrayå¯¹è±¡ã€‚å¦‚æœå·²ç»è¢«åˆ›å»ºï¼Œå°±ä¼šè¢«æŸ¥è¯¢å‡ºæ¥ã€‚ä¾‹å¦‚producerè¢«åˆ›å»ºè¿‡ï¼Œåœ¨consumerä¸­å°±ä¼šæŸ¥è¯¢å‡ºæ¥ã€‚</li>\n<li>å¦‚æœä¿¡å·é‡é›†åˆæ²¡æœ‰è¢«åˆ›å»ºè¿‡ï¼Œåˆ™è°ƒç”¨sem_opsçš„newaryæ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªä¿¡å·é‡é›†åˆå¯¹è±¡sem_arrayã€‚ä¾‹å¦‚ï¼Œåœ¨producerä¸­å°±ä¼šæ–°å»ºã€‚</li>\n<li>è°ƒç”¨semctl(SETALL)åˆå§‹åŒ–ä¿¡å·é‡ã€‚</li>\n<li>sem_obtain_object_checkå…ˆä»åŸºæ•°æ ‘é‡Œé¢æ‰¾åˆ°sem_arrayå¯¹è±¡ã€‚</li>\n<li>æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„ä¿¡å·é‡æ•°ç»„ï¼Œåˆå§‹åŒ–ä¿¡å·é‡é›†åˆï¼Œä¹Ÿå³åˆå§‹åŒ–sem_arrayå¯¹è±¡çš„struct sem sems[]æˆå‘˜ã€‚</li>\n<li>è°ƒç”¨semopæ“ä½œä¿¡å·é‡ã€‚</li>\n<li>åˆ›å»ºä¿¡å·é‡æ“ä½œç»“æ„sem_queueï¼Œæ”¾å…¥é˜Ÿåˆ—ã€‚</li>\n<li>åˆ›å»ºundoç»“æ„ï¼Œæ”¾å…¥é“¾è¡¨ã€‚</li>\n</ol><h2>è¯¾å ‚ç»ƒä¹ </h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„å…±äº«å†…å­˜ã€ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—éƒ½è®²å®Œäº†ï¼Œä½ æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œå®ƒä»¬çš„APIéå¸¸ç›¸ä¼¼ã€‚ä¸ºäº†æ–¹ä¾¿è®°å¿†ï¼Œä½ å¯ä»¥è‡ªå·±æ•´ç†ä¸€ä¸ªè¡¨æ ¼ï¼Œåˆ—ä¸€ä¸‹è¿™ä¸‰ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ã€è¡Œä¸ºåˆ›å»ºxxxgetã€ä½¿ç”¨ã€æ§åˆ¶xxxctlã€å¯¹åº”çš„APIå’Œç³»ç»Ÿè°ƒç”¨ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"41 | IPCï¼ˆä¸­ï¼‰ï¼šä¸åŒé¡¹ç›®ç»„ä¹‹é—´æŠ¢èµ„æºï¼Œå¦‚ä½•åè°ƒï¼Ÿ","id":104277},"right":{"article_title":"43 é¢„ä¹  | Socketé€šä¿¡ä¹‹ç½‘ç»œåè®®åŸºæœ¬åŸç†","id":105338}},"comments":[{"had_liked":false,"id":109912,"user_name":"Sharry","can_delete":false,"product_type":"c1","uid":1239293,"ip_address":"","ucode":"045DDB864659F6","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/fd/035f4c94.jpg","comment_is_top":false,"comment_ctime":1562132372,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"61691674516","product_id":100024701,"comment_content":"ç»ˆäºæŠŠå…±äº«å†…å­˜å’Œä¿¡å·é‡é›†åˆçš„çŸ¥è¯†ä¸²è”åœ¨ä¸€èµ·äº†, å…¶ä¸­çš„æ“ä½œçš„ç¡®æœ‰äº›å¤æ‚<br><br>å…±äº«å†…å­˜è‹¥æƒ³å®ç°è¿›ç¨‹ä¹‹é—´çš„åŒæ­¥è¯»å†™, åˆ™éœ€è¦é…åˆä¿¡å·é‡å…±åŒä½¿ç”¨<br>- **å…±äº«å†…å­˜**<br>  - **å…±äº«å†…å­˜çš„åˆ›å»º**<br>    - å¼€è¾Ÿå…±äº«å†…å­˜åŒºåŸŸ, ä½¿ç”¨ shmid_kernel æè¿°<br>    - é€šè¿‡ kvmalloc åœ¨å†…æ ¸çš„ç›´æ¥æ˜ å°„åŒºåˆ†é…ä¸€ä¸ª shmid_kernel ç»“æ„ä½“<br>    - å°†å†…å­˜æ˜ å°„åˆ°æ–‡ä»¶<br>      - è¿™ä¸ªæ–‡ä»¶å¹¶éç£ç›˜æ–‡ä»¶, **è€Œæ˜¯é€šè¿‡å†…å­˜æ–‡ä»¶ç³»ç»Ÿ shmem åˆ›å»ºçš„å†…å­˜æ–‡ä»¶**<br>      - è¿™ä¹ˆåšçš„åŸå› æ˜¯å› ä¸º**æ–‡ä»¶å¯ä»¥è·¨è¿›ç¨‹å…±äº«**<br>      - å°†è¿™ä¸ª shmid_kernel æŒ‚è½½åˆ°å…±äº«å†…å­˜åŸºæ ‘ä¸Š, è¿”å›å¯¹åº”çš„ id<br>  - **å…±äº«å†…å­˜çš„æ˜ å°„**<br>    - é€šè¿‡ id åœ¨å…±äº«å†…å­˜åŸºæ ‘ä¸Šæ‰¾åˆ°å¯¹åº”çš„å…±äº«å†…å­˜æè¿° shmid_kernel<br>    - åˆ›å»ºä¸€ä¸ª shm_file_data æŒ‡å‘å…±äº«å†…å­˜çš„å†…å­˜æ–‡ä»¶<br>    - åˆ›å»ºä¸€ä¸ª file æŒ‡å‘ shm_file_data<br>    - åœ¨ç”¨æˆ·ç©ºé—´æ‰¾ä¸€å—å†…å­˜åŒºåŸŸ, å°†è¿™ä¸ª file æ˜ å°„åˆ°ç”¨æˆ·åœ°å€ç©ºé—´<br>      - é€šè¿‡æ–‡ä»¶æ˜ å°„ä¹‹å, ä¾¿å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´æ“ä½œè¿™å—å†…å­˜äº†<br>- **ä¿¡å·é‡é›†åˆ**<br>  - ä¿¡å·é‡é›†åˆçš„åˆ›å»º<br>    - åˆ›å»º sem_array ç»“æ„ä½“, ç”¨äºæè¿°ä¿¡å·é‡<br>    - å°†è¿™ä¸ª sem_array ä¿¡å·é‡æ·»åŠ åˆ°åŸºæ ‘ä¸Š, è¿”å›å¯¹åº”çš„ id<br>  - ä¿¡å·é‡é›†åˆçš„åˆå§‹åŒ–<br>    - SETALL: ä¸ºæ‰€æœ‰ä¿¡å·é‡é›†åˆèµ‹å€¼<br>    - SETVAL: ä¸ºæŒ‡å®šä¿¡å·é‡èµ‹å€¼<br>  - æ“ä½œä¿¡å·é‡é›†åˆ<br>    - è°ƒç”¨ **perform_atomic_semop** å°è¯•ä»æ“ä½œé˜Ÿåˆ—ä¸­è¯»å–æ‰§è¡Œ<br>    - è‹¥æ‰§è¡ŒæˆåŠŸ, åˆ™è¯´æ˜æ— éœ€ç­‰å¾…<br>      - è°ƒç”¨ do_smart_update, çœ‹çœ‹è¿™æ¬¡æ“ä½œèƒ½å¤Ÿæ¿€æ´»ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å“ªäº›è¿›ç¨‹<br>      - è°ƒç”¨ **wake_up_q** å”¤é†’å› ä¸ºä¿¡å·é‡é˜»å¡çš„è¿›ç¨‹<br>    - è‹¥éœ€è¦ç­‰å¾…<br>      - æ ¹æ®æ˜¯æ“ä½œä¿¡å·é‡è¿˜æ˜¯ä¿¡å·é›†åˆ, å°†å…¶æŒ‚è½½åˆ°å¯¹åº”çš„ pending_alter ä¸­<br>      - æ‰§è¡Œ looper ç­‰å¾…, ç›´åˆ° timeout æˆ–è€…è¢« wake_up_q å”¤é†’<br>        - è‹¥æœªè®¾ç½® timeout, åˆ™è®©å‡º CPU èµ„æº<br>","like_count":14},{"had_liked":false,"id":142428,"user_name":"Helios","can_delete":false,"product_type":"c1","uid":1380758,"ip_address":"","ucode":"BE6B98EE8F0D09","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKJrOl63enWXCRxN0SoucliclBme0qrRb19ATrWIOIvibKIz8UAuVgicBMibIVUznerHnjotI4dm6ibODA/132","comment_is_top":false,"comment_ctime":1571367148,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"40226072812","product_id":100024701,"comment_content":"æ€è€ƒé—®é¢˜æ€»ç»“äº†ä¸ªå›¾ï¼š<br>https:&#47;&#47;user-images.githubusercontent.com&#47;12036324&#47;67062221-431e6f80-f195-11e9-9dd1-4353ebbc730c.png<br><br>https:&#47;&#47;github.com&#47;helios741&#47;myblog&#47;issues&#47;60<br>","like_count":9,"discussions":[{"author":{"id":2022313,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/db/a9/01bf49a9.jpg","nickname":"Neverland","note":"","ucode":"23A84D3A538E0F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":298049,"discussion_content":"å›¾è«å¾—äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597157011,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109927,"user_name":"å…è´¹çš„äºº","can_delete":false,"product_type":"c1","uid":1032106,"ip_address":"","ucode":"2B12D8ED63C564","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/aa/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1562134855,"is_pvip":false,"replies":[{"id":"48805","content":"æ˜¯çš„ï¼Œå› ä¸ºä¸å¤ªè¢«ä½¿ç”¨","user_name":"ä½œè€…å›å¤","comment_id":109927,"uid":"1001590","ip_address":"","utype":1,"ctime":1567497924,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":3,"race_medal":0,"score":"14447036743","product_id":100024701,"comment_content":"æ¶ˆæ¯é˜Ÿåˆ—çš„å†…æ ¸å®ç°å¥½åƒæ²¡è®²è¿‡ï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456643,"discussion_content":"æ˜¯çš„ï¼Œå› ä¸ºä¸å¤ªè¢«ä½¿ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567497924,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1021638,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/96/c6/ac69caa9.jpg","nickname":"ä»Šæ™šåƒå•¥","note":"","ucode":"960608C402BA87","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6404,"discussion_content":"36è®²ï¼šâ€œæ¶ˆæ¯é˜Ÿåˆ—å…¶å®å¾ˆå°‘ç”¨ï¼Œå› ä¸ºæœ‰å¤ªå¤šç”¨æˆ·çº§åˆ«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€‚â€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566886917,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1239293,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e8/fd/035f4c94.jpg","nickname":"Sharry","note":"","ucode":"045DDB864659F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1060,"discussion_content":"è€å¸ˆä¹‹å‰è¯´, æ¶ˆæ¯é˜Ÿåˆ—å‡ ä¹å¾ˆå°‘è¢«ä½¿ç”¨, å¯èƒ½æ˜¯è¿™ä¸ªåŸå› æ‰æ²¡æœ‰ç»†è¯´å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562305316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114332,"user_name":"Geek_835e66","can_delete":false,"product_type":"c1","uid":1284038,"ip_address":"","ucode":"956DF28273A43A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ASWNK7fz2Wo2nzcbxhOsgeOUibSdtGo9icibf7WmXoTLB5lCyeiaC1ibVRVmtNp4P6ocvViaD6Z5LLXTyibgyNBc1pa9A/132","comment_is_top":false,"comment_ctime":1563276163,"is_pvip":false,"replies":[{"id":"46614","content":"å®é™…ç¼–ç¨‹çš„æ—¶å€™ï¼Œç”¨çš„å°‘ï¼Œå°±æ²¡æœ‰è§£æ","user_name":"ä½œè€…å›å¤","comment_id":114332,"uid":"1001590","ip_address":"","utype":1,"ctime":1566367463,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"10153210755","product_id":100024701,"comment_content":"è¯·é—®æ¶ˆæ¯é˜Ÿåˆ—çš„å†…å®¹åœ¨å“ªé‡Œï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458611,"discussion_content":"å®é™…ç¼–ç¨‹çš„æ—¶å€™ï¼Œç”¨çš„å°‘ï¼Œå°±æ²¡æœ‰è§£æ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566367463,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1242864,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqLcWH3mSPmhjrs1aGL4b3TqI7xDqWWibM4nYFrRlp0z7FNSWaJz0mqovrgIA7ibmrPt8zRScSfRaqQ/132","nickname":"æ˜“å„¿æ˜“","note":"","ucode":"B15D1031CA841E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":5018,"discussion_content":"36","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565875787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226413,"user_name":"ä¸€åªç‰¹ç«‹ç‹¬è¡Œçš„çŒª","can_delete":false,"product_type":"c1","uid":1037041,"ip_address":"","ucode":"421D0A6FE29127","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d2/f1/c071cffa.jpg","comment_is_top":false,"comment_ctime":1592089236,"is_pvip":false,"replies":[{"id":"83456","content":"å¯¹å‘€ï¼ŒåŸæ¥æ˜¯4,5,0","user_name":"ä½œè€…å›å¤","comment_id":226413,"uid":"1001590","ip_address":"","utype":1,"ctime":1592185899,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"5887056532","product_id":100024701,"comment_content":"æˆ‘ä»¬æ¥çœ‹è¿›ç¨‹ 2ã€‚æˆ‘ä»¬è°ƒç”¨ semopï¼Œå°† semaphore1 çš„ä¸‰ä¸ªä¿¡å·é‡çš„å€¼ï¼Œåˆ†åˆ«å‡ 3ã€åŠ  2 å’ŒåŠ  1ï¼Œä»è€Œä¿¡å·é‡çš„å€¼å˜ä¸º 1ã€7ã€1   ???","like_count":1,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498230,"discussion_content":"å¯¹å‘€ï¼ŒåŸæ¥æ˜¯4,5,0","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592185899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110114,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1562198163,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5857165459","product_id":100024701,"comment_content":"è€å¸ˆï¼Œæœ‰æ²¡æœ‰æ‰“ç®—è®²ä¸€ä¸‹POSIX IPCå‘¢ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":2027659,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f0/8b/a806789b.jpg","nickname":"int8","note":"","ucode":"EDE812592B8C06","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411560,"discussion_content":"æœ‰çš„ï¼Œè®¡åˆ’ä¸­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635948910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356037,"user_name":"é…·é…·çš„åµ©","can_delete":false,"product_type":"c1","uid":1357315,"ip_address":"å¹¿ä¸œ","ucode":"EF249E96F42491","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoVRER40LhyAhBK6YgPYibRzWARkc3efUquib4j9BPru4y8FfvXK2sBPbXej9314pZdfdcxb07RcjZw/132","comment_is_top":false,"comment_ctime":1661930399,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661930399","product_id":100024701,"comment_content":"åœ¨ perform_atomic_semop å‡½æ•°ä¸­ï¼Œå¯¹äºè®¡ç®—å’Œä¿®æ”¹æ˜¯å¦‚ä½•ç¡®ä¿åŸå­æ€§çš„ï¼Ÿ","like_count":0},{"had_liked":false,"id":327727,"user_name":"Run","can_delete":false,"product_type":"c1","uid":1371941,"ip_address":"","ucode":"6738D2F36ACFF6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLMDBq7lqg9ZasC4f21R0axKJRVCBImPKlQF8yOicLLXIsNgsZxsVyN1mbvFOL6eVPluTNgJofwZeA/132","comment_is_top":false,"comment_ctime":1640252879,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1640252879","product_id":100024701,"comment_content":"ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¸ªçš„æ—¶å€™æœˆè–ª8k","like_count":0,"discussions":[{"author":{"id":1451826,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/4C2AgnHBt1qmRSiaqPQfEPicCdEJp6IgLC1wsVJPa1zQoRztNaZcqiaRXIblkRc1sgn7dUdPmrE011uFbibEQtia3bg/132","nickname":"çŸ³å¤©å…°çˆ±å­¦ä¹ ","note":"","ucode":"0D95CDA7463516","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546944,"discussion_content":"ç°åœ¨å‘¢ï¼ŸğŸ§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642475084,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290150,"user_name":"geek","can_delete":false,"product_type":"c1","uid":2401422,"ip_address":"","ucode":"FF0845140D72A9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/NyFOEueITjaGLpakMEuWAqVQjo1uDIXlpDdpCxXGfaWiaXzibLQ3WgOFCe8D9FvCmyjsGT7jDsLUbkt8jt2aVs9g/132","comment_is_top":false,"comment_ctime":1619403912,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1619403912","product_id":100024701,"comment_content":"ä¸€ä¸ªè¿›ç¨‹å·²ç»ç­‰å¾…åœ¨å¿ƒä¿¡å·é‡ä¸Šæ—¶ï¼Œå¦‚æœå¦ä¸€ä¸ªè¿›ç¨‹é‡Šæ”¾äº†æ­¤ä¿¡å·é‡ï¼ŒåŸå…ˆç­‰å¾…çš„è¿›ç¨‹å¦‚ä½•çŸ¥é“è¯¥æå‰é€€å‡ºäº†ï¼ŸæŒ‰æ–‡ä¸­çš„ä»£ç ï¼Œæ˜¯è¦ä¸€ç›´ç­‰åˆ°è¶…æ—¶ï¼Œå¦‚æœæ²¡è¶…æ—¶ï¼Œå°±ä¼šä¸€ç›´ç­‰ä¸‹å»ã€‚","like_count":0,"discussions":[{"author":{"id":1716827,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/32/5b/d0c7e813.jpg","nickname":"luo","note":"","ucode":"1A1DA8EB916ECF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":564167,"discussion_content":"å‘ä¿¡å·ä¸”å”¤é†’è¿›ç¨‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650174589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282988,"user_name":"å°æ€ªç›—kid","can_delete":false,"product_type":"c1","uid":2333726,"ip_address":"","ucode":"0E210353FE618A","user_header":"https://static001.geekbang.org/account/avatar/00/23/9c/1e/fdce4a6b.jpg","comment_is_top":false,"comment_ctime":1615511831,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615511831","product_id":100024701,"comment_content":"è€å¸ˆæœ‰ä¸¤ä¸ªé—®é¢˜:1.å…±äº«å†…å­˜çš„åˆ›å»ºï¼Œæ˜¯ä¸æ˜¯åªè¦åˆ›å»ºå°±æ˜¯åœ¨å†…å­˜ä¸­å­˜åœ¨ï¼Œä¸åˆ›å»ºå…±äº«å†…å­˜çš„è¿›ç¨‹æ— å…³å§ï¼Œå³ä½¿è¯¥è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œä¹Ÿä¸ä¼šå½±å“åˆ›å»ºå¥½çš„å…±äº«å†…å­˜ï¼Ÿ2.æŸä¸ªè¿›ç¨‹è·å–ä¿¡å·é‡ï¼Œä½†æ˜¯è¿™ä¸ªè¿›ç¨‹ä¹Ÿæ˜¯å¼‚å¸¸é€€å‡ºäº†ï¼Œä¿¡å·é‡æ²¡æœ‰é‡Šæ”¾ï¼Œè¿™ä¸ªæ¢å¤å·¥ä½œç”±å†…æ ¸å®Œæˆï¼Œè¿˜æ˜¯å…¶ä»–è¿›ç¨‹éœ€è¦åˆ¤æ–­undoç»“æ„è¿›è¡Œæ¢å¤ï¼Ÿ","like_count":0},{"had_liked":false,"id":110964,"user_name":"ç‹ä¹‹åˆš","can_delete":false,"product_type":"c1","uid":1121474,"ip_address":"","ucode":"AB2C3BB1867745","user_header":"https://static001.geekbang.org/account/avatar/00/11/1c/c2/adba355c.jpg","comment_is_top":false,"comment_ctime":1562403735,"is_pvip":false,"replies":[{"id":"46752","content":"æˆ–è€…å®¢æˆ·ç«¯ï¼Œæˆ–è€…æœåŠ¡ç«¯ï¼Œè¦è´Ÿè´£åˆ°åº•ï¼Œä¸è´Ÿè´£åˆ°åº•çš„è¯ï¼Œlinuxå°±è¢«ææŒ‚äº†å‘—ã€‚æ‰€ä»¥cè¯­è¨€ä¸åƒjavaé‚£æ ·æœ‰ä¸ªåƒåœ¾å›æ”¶å™¨ï¼Œè€Œæ˜¯è‡ªå·±è¦æ“å¿ƒæ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä¸æ“å¿ƒå°±ä¼šå‡ºäº‹æƒ…","user_name":"ä½œè€…å›å¤","comment_id":110964,"uid":"1001590","ip_address":"","utype":1,"ctime":1566388235,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1562403735","product_id":100024701,"comment_content":"è¯·é—®ä¸€ä¸‹è€å¸ˆï¼Œåœ¨åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œåƒä¿¡å·é‡ å…±äº«å†…å­˜è¿™äº›å†…æ ¸èµ„æºæ€ä¹ˆæ ·é˜²æ­¢æ³„æ¼å‘¢ï¼Ÿæ¯”å¦‚æœ‰è¿›ç¨‹aå’Œbç”¨å…±äº«å†…å­˜å…±äº«æ•°æ®ï¼Œå…±äº«å†…å­˜èµ„æºç”±æ•™ç¨‹aç”³è¯·å’Œç»´æŠ¤ï¼Œä½†ç”±äºå¼‚å¸¸æƒ…å†µå¯¼è‡´æ•™ç¨‹å¼‚å¸¸é€€å‡ºå¯¼è‡´å…±äº«å†…å­˜èµ„æºæ²¡æœ‰é‡Šæ”¾ï¼Œå¯¼è‡´äº†ç”³è¯·çš„å…±äº«å†…å­˜æ²¡æœ‰é‡Šæ”¾ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬æ€ä¹ˆå¤„ç†å‘¢ï¼ŸLinuxå†…æ ¸æ˜¯å¦æœ‰ç›¸å…³èµ„æºä¿æŠ¤å—ï¼Ÿè°¢è°¢äº†","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457146,"discussion_content":"æˆ–è€…å®¢æˆ·ç«¯ï¼Œæˆ–è€…æœåŠ¡ç«¯ï¼Œè¦è´Ÿè´£åˆ°åº•ï¼Œä¸è´Ÿè´£åˆ°åº•çš„è¯ï¼Œlinuxå°±è¢«ææŒ‚äº†å‘—ã€‚æ‰€ä»¥cè¯­è¨€ä¸åƒjavaé‚£æ ·æœ‰ä¸ªåƒåœ¾å›æ”¶å™¨ï¼Œè€Œæ˜¯è‡ªå·±è¦æ“å¿ƒæ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä¸æ“å¿ƒå°±ä¼šå‡ºäº‹æƒ…","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566388235,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110115,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1562198340,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1562198340","product_id":100024701,"comment_content":"schedule_timeoutè°ƒç”¨å®Œåï¼Œä¼šè®©å‡ºcpuï¼Œè¿‡ä¸€æ®µæ—¶é—´è¿˜ä¼šå›æ¥ã€‚è¿™ä¸ªè¿‡ä¸€æ®µæ—¶é—´æ˜¯å¤šé•¿æ—¶é—´å•Šï¼Ÿæ˜¯è¯´è¶…æ—¶ä¹‹åè¿”å›æ¥å—ï¼Œè¿˜æ˜¯è¢«å…¶å®ƒä¿¡å·æ‰“æ–­ç¡çœ ä¹‹åå›æ¥ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1179565,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ff/ad/5020a8c5.jpg","nickname":"Farewellä¸¶","note":"","ucode":"A0D69893C5375C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":36021,"discussion_content":"è¿™ä¸ªå°±è¿æ¥åˆ°è¿›ç¨‹è°ƒåº¦é‚£ç« äº†å§ï¼Œæ ¹æ®è®¾ç½®å½“å‰è¿›ç¨‹å‘—schedæ—¶å€™çš„è®¾ç½®ä¸åŒï¼Œè¿™ä¸ªtimeoutè®¾ç½®åº”è¯¥æ˜¯æœ€çŸ­æ—¶é—´ï¼Œé•¿äº†çš„åŒ–æ¯”å¦‚cpuåœ¨å¿™å…¶ä»–ç´§è¦çš„ä»»åŠ¡ï¼Œå¯èƒ½å°±ä¼šæ¯”è¿™ä¸ªè¿˜è¦é•¿ä¸€äº›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571316741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1576512,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0e/40/49a71ed8.jpg","nickname":"å…«æˆ’","note":"","ucode":"3F262A99492A65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1179565,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ff/ad/5020a8c5.jpg","nickname":"Farewellä¸¶","note":"","ucode":"A0D69893C5375C","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368088,"discussion_content":"æ˜¯æ—¶é—´ç‰‡å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618564288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":36021,"ip_address":""},"score":368088,"extra":""}]}]}]}