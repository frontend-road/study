{"id":154490,"title":"16 | CDN：静态资源如何加速？","content":"<p>你好，我是唐扬。</p><p>前面几节课，我带你了解了缓存的定义以及常用缓存的使用姿势，你应该对包括本地缓存、分布式缓存等缓存组件的适用场景和使用技巧有了一定了解了。结合在<a href=\"https://shimo.im/docs/tqDK6cRX9yR8XJyt\">14讲</a>中我提到的客户端高可用方案，你会将单个缓存节点扩展为高可用的缓存集群，现在，你的电商系统架构演变成了下面这样：</p><p><img src=\"https://static001.geekbang.org/resource/image/1a/ba/1aa34cb9f368727399ba32e2891d48ba.jpg?wh=1142*611\" alt=\"\"></p><p>在这个架构中我们使用分布式缓存对动态请求数据的读取做了加速，但是在我们的系统中存在着大量的静态资源请求：</p><ol>\n<li>\n<p>对于移动APP来说，这些静态资源主要是图片、视频和流媒体信息；</p>\n</li>\n<li>\n<p>对于Web网站来说，则包括了JavaScript文件、CSS文件、静态HTML文件等等。</p>\n</li>\n</ol><p>具体到你的电商系统来说，商品的图片、介绍商品使用方法的视频等等静态资源都放在了Nginx等Web服务器上，它们的读请求量极大并且对访问速度的要求很高还占据了很高的带宽，这时会出现访问速度慢带宽被占满影响动态请求的问题，<strong>那么你就需要考虑如何针对这些静态资源进行读加速了。</strong></p><h2>静态资源加速的考虑点</h2><p>你可能会问：“我们是否也可以使用分布式缓存来解决这个问题呢？”答案是否定的。一般来说，图片和视频的大小会在几兆到几百兆之间不等，如果我们的应用服务器和分布式缓存都部署在北京的机房里，这时一个杭州的用户要访问缓存中的一个视频，那这个视频文件就需要从北京传输到杭州，期间会经过多个公网骨干网络，延迟很高，会让用户感觉视频打开很慢，严重影响到用户的使用体验。</p><!-- [[[read_end]]] --><p>所以，静态资源访问的关键点是<strong>就近访问，</strong>即北京用户访问北京的数据，杭州用户访问杭州的数据，这样才可以达到性能的最优。</p><p>你可能会说：“那我们在杭州也自建一个机房，让用户访问杭州机房的数据就好了呀。”可用户遍布在全国各地，有些应用可能还有国外的用户，我们不可能在每个地域都自建机房，这样成本太高了。</p><p>另外，单个视频和图片等静态资源很大，并且访问量又极高，如果使用业务服务器和分布式缓存来承担这些流量，无论是对于内网还是外网的带宽都会是很大的考验。</p><p>所以我们考虑在业务服务器的上层增加一层特殊的缓存，用来承担绝大部分对于静态资源的访问，这一层特殊缓存的节点需要遍布在全国各地，这样可以让用户选择最近的节点访问。缓存的命中率也需要一定的保证，尽量减少访问资源存储源站的请求数量（回源请求）。<strong>这一层缓存就是我们这节课的重点：CDN。</strong></p><h2>CDN的关键技术</h2><p>CDN（Content Delivery Network/Content Distribution Network，内容分发网络）。简单来说，CDN就是将静态的资源分发到位于多个地理位置机房中的服务器上，因此它能很好地解决数据就近访问的问题，也就加快了静态资源的访问速度。</p><p>在大中型公司里面，CDN的应用非常普遍，大公司为了提供更稳定的CDN服务会选择自建CDN，而大部分公司基于成本的考虑还是会选择专业的CDN厂商，网宿、阿里云、腾讯云、蓝汛等等，其中网宿和蓝汛是老牌的CDN厂商，阿里云和腾讯云是云厂商提供的服务，如果你的服务部署在云上可以选择相应云厂商的CDN服务，这些CDN厂商都是现今行业内比较主流的。</p><p>对于CDN来说，你可能已经从运维的口中听说过，并且也了解了它的作用。但是当让你来配置CDN或者是排查CDN方面的问题时，你就有可能因为不了解它的原理而束手无策了。</p><p>所以我先来带你了解一下搭建一个CDN系统需要考虑哪两点：</p><ol>\n<li>如何将用户的请求映射到CDN节点上；</li>\n<li>如何根据用户的地理位置信息选择到比较近的节点。</li>\n</ol><h3>如何让用户的请求到达CDN节点</h3><p>首先，我们考虑一下如何让用户的请求到达CDN节点，你可能会觉得这很简单啊，只需要告诉用户CDN节点的IP地址，然后请求这个IP地址上面部署的CDN服务就可以了啊。<strong>但是这样会有一个问题：</strong>就是我们使用的是第三方厂商的CDN服务，CDN厂商会给我们一个CDN的节点IP，比如说这个IP地址是“111.202.34.130”，那么我们的电商系统中的图片的地址很可能是这样的：“<code>http://111.202.34.130/1.jpg</code>”, 这个地址是要存储在数据库中的。</p><p>那么如果这个节点IP发生了变更怎么办？或者我们如果更改了CDN厂商怎么办？是不是要修改所有的商品的url域名呢？这就是一个比较大的工作量了。所以，我们要做的事情是将第三方厂商提供的IP隐藏起来，给到用户的最好是一个本公司域名的子域名。</p><p><strong>那么如何做到这一点呢？</strong>这就需要依靠DNS来帮我们解决域名映射的问题了。</p><p>DNS（Domain Name System，域名系统）实际上就是一个存储域名和IP地址对应关系的分布式数据库。而域名解析的结果一般有两种，一种叫做“A记录”，返回的是域名对应的IP地址；另一种是“CNAME记录”，返回的是另一个域名，也就是说当前域名的解析要跳转到另一个域名的解析上。实际上www.baidu.com 域名的解析结果就是一个CNAME记录，域名的解析被跳转到www.a.shifen.com 上了，我们正是利用CNAME记录来解决域名映射问题的，<strong>具体是怎么解决的呢？我给你举个例子。</strong></p><p>比如你的公司的一级域名叫做example.com，那么你可以把你的图片服务的域名定义为“img.example.com”，然后将这个域名的解析结果的CNAME配置到CDN提供的域名上，比如uclound可能会提供一个域名是“80f21f91.cdn.ucloud.com.cn”这个域名。这样你的电商系统使用的图片地址可以是“<code>http://img.example.com/1.jpg</code>”。</p><p>用户在请求这个地址时，DNS服务器会将域名解析到80f21f91.cdn.ucloud.com.cn域名上，然后再将这个域名解析为CDN的节点IP，这样就可以得到CDN上面的资源数据了。</p><p><strong>不过这里面有一个问题：</strong>因为域名解析过程是分级的，每一级有专门的域名服务器承担解析的职责，所以域名的解析过程有可能需要跨越公网做多次DNS查询，在性能上是比较差的。</p><p><img src=\"https://static001.geekbang.org/resource/image/95/96/95d3d6081d8e55860bff6ad0df96c396.jpg?wh=1142*626\" alt=\"\"></p><p>从“ 域名分级解析示意图”中你可以看出DNS分为很多种，有根DNS，顶级DNS等等。除此之外还有两种DNS需要特别留意：一种是Local DNS，它是由你的运营商提供的DNS，一般域名解析的第一站会到这里；另一种是权威DNS，它的含义是自身数据库中存储了这个域名对应关系的DNS。</p><p>下面我以www.baidu.com 这个域名为例给你简单介绍一下域名解析的过程：</p><ul>\n<li>\n<p>一开始，域名解析请求先会检查本机的hosts文件，查看是否有www.baidu.com 对应的IP；</p>\n</li>\n<li>\n<p>如果没有的话，就请求Local DNS是否有域名解析结果的缓存，如果有就返回标识是从非权威DNS返回的结果；</p>\n</li>\n<li>\n<p>如果没有就开始DNS的迭代查询。先请求根DNS，根DNS返回顶级DNS（.com）的地址；再请求.com顶级DNS得到baidu.com的域名服务器地址；再从baidu.com的域名服务器中查询到www.baidu.com 对应的IP地址，返回这个IP地址的同时标记这个结果是来自于权威DNS的结果，同时写入Local DNS的解析结果缓存，这样下一次的解析同一个域名就不需要做DNS的迭代查询了。</p>\n</li>\n</ul><p>经过了向多个DNS服务器做查询之后，整个DNS的解析的时间有可能会到秒级别，<strong>那么我们如何来解决这个性能问题呢？</strong></p><p><strong>一个解决的思路是：</strong>在APP启动时对需要解析的域名做预先解析，然后把解析的结果缓存到本地的一个LRU缓存里面。这样当我们要使用这个域名的时候，只需要从缓存中直接拿到所需要的IP地址就好了，如果缓存中不存在才会走整个DNS查询的过程。同时为了避免DNS解析结果的变更造成缓存内数据失效，我们可以启动一个定时器定期地更新缓存中的数据。</p><p><strong>我曾经测试过这种方式，</strong>对于HTTP请求的响应时间的提升是很明显的，原先DNS解析时间经常会超过1s，使用这种方式后，DNS解析时间可以控制在200ms之内，整个HTTP请求的过程也可以减少大概80ms～100ms。</p><p><img src=\"https://static001.geekbang.org/resource/image/1a/c9/1a692c89b0bcaa8106a8ba045be835c9.jpg?wh=1142*511\" alt=\"\"></p><p><strong>这里总结一下，</strong>将用户的请求映射到CDN服务器上是使用CDN时需要解决的一个核心的问题，而CNAME记录在DNS解析过程中可以充当一个中间代理层的角色，可以把用户最初使用的域名代理到正确的IP地址上。</p><p><img src=\"https://static001.geekbang.org/resource/image/4c/59/4c884118fccb7041fdfb4d3e37003f59.jpg?wh=1142*656\" alt=\"\"></p><p>现在，剩下的一个问题就是如何找到更近的CDN节点了，而GSLB承担了这个职责。</p><h3>如何找到离用户最近的CDN节点</h3><p>GSLB（Global Server Load Balance，全局负载均衡）的含义是对于部署在不同地域的服务器之间做负载均衡，下面可能管理了很多的本地负载均衡组件。<strong>它有两方面的作用：</strong></p><ul>\n<li>\n<p>一方面，它是一种负载均衡服务器，负载均衡，顾名思义嘛，指的是让流量平均分配使得下面管理的服务器的负载更平均；</p>\n</li>\n<li>\n<p>另一方面，它还需要保证流量流经的服务器与流量源头在地缘上是比较接近的。</p>\n</li>\n</ul><p>GSLB可以通过多种策略来保证返回的CDN节点和用户尽量保证在同一地缘区域，比如说可以将用户的IP地址按照地理位置划分为若干个区域，然后将CDN节点对应到一个区域上，根据用户所在区域来返回合适的节点；也可以通过发送数据包测量RTT的方式来决定返回哪一个节点。<strong>不过这些原理不是本节课重点内容，</strong>你了解一下就可以了，我不做详细的介绍。</p><p>有了GSLB之后，节点的解析过程变成了下图中的样子：</p><p><img src=\"https://static001.geekbang.org/resource/image/fc/01/fcc357ff674b4abdc00dc9c33cbf9a01.jpg?wh=1142*676\" alt=\"\"></p><p><strong>当然，是否能够从CDN节点上获取到资源还取决于CDN的同步延时。</strong>一般我们会通过CDN厂商的接口将静态的资源写入到某一个CDN节点上，再由CDN内部的同步机制将资源分散同步到每个CDN节点，即使CDN内部网络经过了优化，这个同步的过程是有延时的，一旦我们无法从选定的CDN节点上获取到数据，我们就不得不从源站获取数据，而用户网络到源站的网络可能会跨越多个主干网，这样不仅性能上有损耗也会消耗源站的带宽，带来更高的研发成本。所以我们在使用CDN的时候需要关注CDN的命中率和源站的带宽情况。</p><h2>课程小结</h2><p>本节课，我主要带你了解了CDN对静态资源进行加速的原理和使用的核心技术，这里你需要了解的重点有以下几点：</p><p>1.DNS技术是CDN实现中使用的核心技术，可以将用户的请求映射到CDN节点上；</p><p>2.DNS解析结果需要做本地缓存，降低DNS解析过程的响应时间；</p><p>3.GSLB可以给用户返回一个离着他更近的节点，加快静态资源的访问速度。</p><p>作为一个服务端开发人员，你可能会忽略CDN的重要性，对于偶尔出现的CDN问题嗤之以鼻，觉得这个不是我们应该关心的内容，<strong>这种想法是错的。</strong></p><p>CDN是我们系统的门面，其缓存的静态数据，如图片和视频数据的请求量很可能是接口请求数据的几倍甚至更高，一旦发生故障，对于整体系统的影响是巨大的。另外CDN的带宽历来是我们研发成本的大头，<strong>尤其是目前处于小视频和直播风口上，</strong>大量的小视频和直播研发团队都在绞尽脑汁地减少CDN的成本。由此看出，CDN是我们整体系统至关重要的组成部分，而它作为一种特殊的缓存，其命中率和可用性也是我们服务端开发人员需要重点关注的指标。</p><h2>一课一思</h2><p>结合今天课程中的内容，我们知道CDN的可用性对系统至关重要，那么你可以思考一下除了CDN厂商对于SLA的保证之外，还有什么方案可以保证CDN的可用性？欢迎在留言区和我一起讨论。</p><p>最后，感谢你的阅读，如果这篇文章让你有所收获，也欢迎你将它分享给更多的朋友。</p>","comments":[{"had_liked":false,"id":143877,"user_name":"小喵喵","can_delete":false,"product_type":"c1","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":false,"comment_ctime":1571802499,"is_pvip":false,"replies":[{"id":"55609","content":"1. 嘿嘿，不是的，我们在做点播系统的时候非常关注CDN的数据<br>2. 厂商有提供，不过更多要靠我们自己来监控回源的信息","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1571855005,"ip_address":"","comment_id":143877,"utype":1}],"discussion_count":5,"race_medal":0,"score":"48816442755","product_id":100035801,"comment_content":"1.cdn不是运维干的事情吗？作为程序员或架构师，只需要了解一下，没必要深入吧？<br>2.CDN命中率是厂商可以监控的到吗？","like_count":12,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471735,"discussion_content":"1. 嘿嘿，不是的，我们在做点播系统的时候非常关注CDN的数据\n2. 厂商有提供，不过更多要靠我们自己来监控回源的信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571855005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1431088,"avatar":"https://static001.geekbang.org/account/avatar/00/15/d6/30/1c7f1c39.jpg","nickname":"收腹，你咋有肚子","note":"","ucode":"F51B6450B41150","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334721,"discussion_content":"世界上有种悲哀叫做：程序员不懂运维，运维不懂程序员","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1607951715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1009831,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/68/a7/c3fd1fd9.jpg","nickname":"聪","note":"","ucode":"9D672A8580A945","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312334,"discussion_content":"很多厂程序员都是啥都干","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602666161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104850,"avatar":"https://static001.geekbang.org/account/avatar/00/10/db/d2/e29f8834.jpg","nickname":"lidashuang","note":"","ucode":"560ABE8032760E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300681,"discussion_content":"我都直接阿里云。啥监控都有","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598232046,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1104850,"avatar":"https://static001.geekbang.org/account/avatar/00/10/db/d2/e29f8834.jpg","nickname":"lidashuang","note":"","ucode":"560ABE8032760E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364574,"discussion_content":"有钱","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617525488,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300681,"ip_address":""},"score":364574,"extra":""}]}]},{"had_liked":false,"id":148920,"user_name":"海罗沃德","can_delete":false,"product_type":"c1","uid":1165364,"ip_address":"","ucode":"8704F1D6980FA0","user_header":"https://static001.geekbang.org/account/avatar/00/11/c8/34/fb871b2c.jpg","comment_is_top":false,"comment_ctime":1573109284,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31637880356","product_id":100035801,"comment_content":"我們公司的靜態資源的域名是公司domain的sub域名，用traceroute命令查看，發現第一層是akamai的一個sub domain，正如老師課裡講的，公司用自己的自域名綁定了akamai的cname","like_count":8},{"had_liked":false,"id":144525,"user_name":"蓝魔丶","can_delete":false,"product_type":"c1","uid":1219438,"ip_address":"","ucode":"2AE4359E263558","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg","comment_is_top":false,"comment_ctime":1571965480,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"31636736552","product_id":100035801,"comment_content":"老师，还可以通过网络运营商来提高可用性，电信用户走电信网络，网通用户走网通网络","like_count":8},{"had_liked":false,"id":144016,"user_name":"Li Shunduo","can_delete":false,"product_type":"c1","uid":1222882,"ip_address":"","ucode":"6C5AB4129E9780","user_header":"https://static001.geekbang.org/account/avatar/00/12/a8/e2/f8e51df2.jpg","comment_is_top":false,"comment_ctime":1571825491,"is_pvip":false,"replies":[{"id":"55607","content":"CDN触发，配置CDN的时候需要配置源站地址。<br>","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1571854718,"ip_address":"","comment_id":144016,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23046661971","product_id":100035801,"comment_content":"CDN回源是由CDN触发的还是用户触发的？具体过程是什么","like_count":5,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471779,"discussion_content":"CDN触发，配置CDN的时候需要配置源站地址。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571854718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":156914,"user_name":"被过去推开","can_delete":false,"product_type":"c1","uid":1276690,"ip_address":"","ucode":"8B4F34FE93FD5B","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Cib5umA0W17N9pichI08pnrXAExdbyh7AVzH4nEhD6KN3FXuELk4LJJuqUPPD7xmIy9nq5Hjbgnzic7sVZG5BKiaUQ/132","comment_is_top":false,"comment_ctime":1574995050,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18754864234","product_id":100035801,"comment_content":"老师把cdn的访问原理讲的很清楚","like_count":4},{"had_liked":false,"id":144113,"user_name":"longslee","can_delete":false,"product_type":"c1","uid":1465986,"ip_address":"","ucode":"C24E32E5B1B6F5","user_header":"https://static001.geekbang.org/account/avatar/00/16/5e/82/438c8534.jpg","comment_is_top":false,"comment_ctime":1571844441,"is_pvip":false,"replies":[{"id":"55636","content":"可以缓存一个ip的列表<br>","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1571883150,"ip_address":"","comment_id":144113,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18751713625","product_id":100035801,"comment_content":"打卡。中了你的甜品毒。。。 老师，问个问题，DNS对应多个IP地址的时候，这种情况APP该怎么缓存呢，该怎么保证它原来的轮训呢。","like_count":4,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471816,"discussion_content":"可以缓存一个ip的列表\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571883150,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144031,"user_name":"Geek_e986e3","can_delete":false,"product_type":"c1","uid":1642716,"ip_address":"","ucode":"EF53D2DEA59A8F","user_header":"","comment_is_top":false,"comment_ctime":1571828410,"is_pvip":false,"replies":[{"id":"55612","content":"没错，要监控CDN的运行状态，有问题随时切换","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1571855049,"ip_address":"","comment_id":144031,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18751697594","product_id":100035801,"comment_content":"自己保证可用的话 我的想法是多个厂商？ 或者自己做cdn节点管理 不可用的赶紧切到最近可用的cdn","like_count":5,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471785,"discussion_content":"没错，要监控CDN的运行状态，有问题随时切换","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571855049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143778,"user_name":"饭团","can_delete":false,"product_type":"c1","uid":1332557,"ip_address":"","ucode":"E24F240CC91BE8","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132","comment_is_top":false,"comment_ctime":1571791663,"is_pvip":false,"replies":[{"id":"55504","content":"是cdn数据过期了吗 可以抓包看看请求包中的header信息","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1571793185,"ip_address":"","comment_id":143778,"utype":1}],"discussion_count":8,"race_medal":0,"score":"18751660847","product_id":100035801,"comment_content":"感谢老师：最近正好在用CDN。用的腾讯云的！我在公司访问某一个资源的时候，大部分情况能命中！但是有时候即使资源没有变化，但是有概率还是会发生回源！不知道这种现象发生的原因是什么？怎么排查！","like_count":4,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471682,"discussion_content":"是cdn数据过期了吗 可以抓包看看请求包中的header信息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571793185,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2041396,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg","nickname":"宙斯","note":"","ucode":"80DF36BAD298AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358274,"discussion_content":"这个问题找到了么？是怎么回事呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615957846,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113445,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fd/65/0b05b5d4.jpg","nickname":"巴特尔","note":"","ucode":"1C5919DE960B23","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":42471,"discussion_content":"如论回答问题还是题目清晰度都是差的老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572676660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1113445,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fd/65/0b05b5d4.jpg","nickname":"巴特尔","note":"","ucode":"1C5919DE960B23","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":42470,"discussion_content":"这个老师就是棒槌","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572676629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1253384,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","nickname":"Dovelol","note":"","ucode":"9B5DDF7720F307","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39440,"discussion_content":"是不是访问到了某个新的cdn节点没有数据，这时会回源去获取数据。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571924709,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1332557,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132","nickname":"饭团","note":"","ucode":"E24F240CC91BE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1253384,"avatar":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","nickname":"Dovelol","note":"","ucode":"9B5DDF7720F307","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39443,"discussion_content":"嗯嗯 感觉是。这两天有点事 等我查查去","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1571925173,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":39440,"ip_address":""},"score":39443,"extra":""}]},{"author":{"id":1332557,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132","nickname":"饭团","note":"","ucode":"E24F240CC91BE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38474,"discussion_content":"老师。理论上！CDN上的资源不会主动回源查看资源变动的吧！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571793385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1332557,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbY9UsqHZhhVoI69yXNibBBg0TRdUVsKLMg2UZ1R3NJxXdMicqceI5yhdKZ5Ad6CJYO0XpFHlJzIYQ/132","nickname":"饭团","note":"","ucode":"E24F240CC91BE8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38473,"discussion_content":"嗯嗯，我今天去了试试！应该没有过期！我设置的过期时间是10天！刚一会！隔一会就会有回源！我一开始怀疑是不是dns给我分配到了不同的CDN服务器上！我今天好好研究一下！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571793345,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144149,"user_name":"刘丹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1571855381,"is_pvip":false,"replies":[{"id":"55633","content":"可以的 不过要在代码中控制用哪一家","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1571883066,"ip_address":"","comment_id":144149,"utype":1}],"discussion_count":4,"race_medal":0,"score":"14456757269","product_id":100035801,"comment_content":"请问一个域名可以同时使用2个CDN厂家吗？","like_count":3,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471826,"discussion_content":"可以的 不过要在代码中控制用哪一家","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571883066,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1217712,"avatar":"https://static001.geekbang.org/account/avatar/00/12/94/b0/b073fe8b.jpg","nickname":"aMaMiMoU","note":"","ucode":"AF1E6CA541E482","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295651,"discussion_content":"如果你业务的域名服务提供商可以支持单域名同时配置多个CNAME解析，则可以同时解析到多个CDN厂商的CDN接入域名上。\n对于权重控制，同样受限于域名服务提供商的功能支持度，如果在上述多CNAME解析的支持上同时支持权重配置，就可以实现楼上的分流需求。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1596274104,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1081922,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","nickname":"刘丹","note":"","ucode":"66594D1C957E15","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39531,"discussion_content":"可以70%流量分给CDN厂家A，30%流量分给CDN厂家B吗？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1571938264,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1033096,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c3/88/d16816a8.jpg","nickname":"如来神掌","note":"","ucode":"45E20FF935BD2F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1081922,"avatar":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","nickname":"刘丹","note":"","ucode":"66594D1C957E15","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312230,"discussion_content":"可以，通过代码来控制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602635816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":39531,"ip_address":""},"score":312230,"extra":""}]}]},{"had_liked":false,"id":234980,"user_name":"云师兄","can_delete":false,"product_type":"c1","uid":1010459,"ip_address":"","ucode":"4475AF1598FBFD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg","comment_is_top":false,"comment_ctime":1594862378,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10184796970","product_id":100035801,"comment_content":"之所以有cname的存在，是不是因为第三方的ip不归本公司所有和管理，所以只能通过第三方的域名去解析","like_count":2},{"had_liked":false,"id":188550,"user_name":"潘政宇","can_delete":false,"product_type":"c1","uid":1254758,"ip_address":"","ucode":"9A6658EE862D95","user_header":"https://static001.geekbang.org/account/avatar/00/13/25/66/4835d92e.jpg","comment_is_top":false,"comment_ctime":1584367702,"is_pvip":true,"replies":[{"id":"73102","content":"是的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1584590798,"ip_address":"","comment_id":188550,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10174302294","product_id":100035801,"comment_content":"配置CDN后，无论请求静态的还是动态的资源，都是流量先走CDN节点，然后动态资源，CDN再请求源站吗","like_count":2,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487444,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584590798,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144013,"user_name":"leechanx","can_delete":false,"product_type":"c1","uid":1700597,"ip_address":"","ucode":"6C0A2B42ABDA35","user_header":"https://static001.geekbang.org/account/avatar/00/19/f2/f5/46c23dd0.jpg","comment_is_top":false,"comment_ctime":1571824320,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10161758912","product_id":100035801,"comment_content":"最后一幅图，2、3步骤 CDN域名解析服务已经为cname返回CDN边缘节点ip了，这时候进行4、5交互还有用吗?<br>就近选ip应该是在CDN域名解析服务里做的吧，即2~3之间","like_count":2,"discussions":[{"author":{"id":1116257,"avatar":"https://static001.geekbang.org/account/avatar/00/11/08/61/9e0f8b8d.jpg","nickname":"金鑫","note":"","ucode":"8AA30E8DD736FB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354964,"discussion_content":"我也没懂，老师有详细解答吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615369099,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1024294,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","nickname":"null","note":"","ucode":"F9039EFED6B55D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":295454,"discussion_content":"2返回的内容可以配置 GSLB 服务器的域名或 ip？\n不太懂，静待老师回复！！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596198086,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":217613,"user_name":"天草二十六","can_delete":false,"product_type":"c1","uid":1360712,"ip_address":"","ucode":"3165EE3007527B","user_header":"https://static001.geekbang.org/account/avatar/00/14/c3/48/3a739da6.jpg","comment_is_top":false,"comment_ctime":1589547829,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5884515125","product_id":100035801,"comment_content":"老师，可以帮梳理下这期需要监控的关键指标么？ 域名解析成功率？CDN命中率？解析耗时？<br>我跟客户端同事说了不知道多少次，一年多了，也不知道他们做了预先解析和定时异步更新缓存与否。其实这个在httpDNS的无论阿里或腾讯的官网，都说得清清楚楚，明明白白了。<br>能够做的不做，我们如何去做指标监控发现问题？","like_count":1},{"had_liked":false,"id":195555,"user_name":"宝仔","can_delete":false,"product_type":"c1","uid":1013493,"ip_address":"","ucode":"A0F17DFF99DB21","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","comment_is_top":false,"comment_ctime":1585196586,"is_pvip":true,"replies":[{"id":"75149","content":"是的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1585659144,"ip_address":"","comment_id":195555,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5880163882","product_id":100035801,"comment_content":"老师在切cdn之前，要对网站的动态资源和静态资源做分离（动静分离），即动态的用动态的域名，静态资源用静态资源的域名","like_count":2,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489109,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585659144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188853,"user_name":"趁早","can_delete":false,"product_type":"c1","uid":1031970,"ip_address":"","ucode":"949FB3AA250D80","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bf/22/26530e66.jpg","comment_is_top":false,"comment_ctime":1584426628,"is_pvip":false,"replies":[{"id":"73099","content":"是的，但是我们也要关注cdn的质量<br>","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1584590651,"ip_address":"","comment_id":188853,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5879393924","product_id":100035801,"comment_content":"Cdn一般用第三方的就行了","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487549,"discussion_content":"是的，但是我们也要关注cdn的质量\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584590651,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":181001,"user_name":"Xiang","can_delete":false,"product_type":"c1","uid":1000070,"ip_address":"","ucode":"374744FF627C00","user_header":"https://static001.geekbang.org/account/avatar/00/0f/42/86/d05de870.jpg","comment_is_top":false,"comment_ctime":1582457223,"is_pvip":true,"replies":[{"id":"70256","content":"可以在客户端做一些丢弃，或者lb上做一些限流策略","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1582513783,"ip_address":"","comment_id":181001,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5877424519","product_id":100035801,"comment_content":"高效的抢购秒杀场景是下在秒杀前(几分钟)在CDN放一个很小的脚本(这个需要跟CDN厂商谈)，逻辑是根据当前人数产生一个概率，只允许 x% 的人真正进入秒杀，其他的直接返回秒杀结束(当然对这部分人是不合理的)。这样到后端的流量是我们可以接受的流量。","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484884,"discussion_content":"可以在客户端做一些丢弃，或者lb上做一些限流策略","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582513783,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1765541,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/f0/a5/ff758400.jpg","nickname":"belief","note":"","ucode":"563EDA9F2C9214","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385224,"discussion_content":"可以使用中间件在请求层做随机拒绝，根据商品库存比设置拒绝的概率","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626946295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364577,"discussion_content":"耗子叔那看到的？\n你查询到CDN厂商谈的价格了嘛？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617525940,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":148053,"user_name":"Eric","can_delete":false,"product_type":"c1","uid":1140494,"ip_address":"","ucode":"8FFC6764ED327B","user_header":"https://static001.geekbang.org/account/avatar/00/11/67/0e/2a51a2df.jpg","comment_is_top":false,"comment_ctime":1572933082,"is_pvip":true,"replies":[{"id":"57338","content":"是域名","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1573170317,"ip_address":"","comment_id":148053,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5867900378","product_id":100035801,"comment_content":"第三方CDN厂商提供我们的是域名还是IP地址?","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473382,"discussion_content":"是域名","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573170317,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146552,"user_name":"冰激凌的眼泪","can_delete":false,"product_type":"c1","uid":1087945,"ip_address":"","ucode":"5DCB974667E93A","user_header":"https://static001.geekbang.org/account/avatar/00/10/99/c9/a7c77746.jpg","comment_is_top":false,"comment_ctime":1572571756,"is_pvip":false,"replies":[{"id":"56833","content":"视频是静态资源","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1572832980,"ip_address":"","comment_id":146552,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5867539052","product_id":100035801,"comment_content":"视频类这种非静态的，如何利用cdn呢？","like_count":1,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472910,"discussion_content":"视频是静态资源","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572832980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1178760,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fc/88/325d6461.jpg","nickname":"GorillaChen","note":"","ucode":"3E165D8E9514BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":235785,"discussion_content":"直播呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587048711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":340599,"user_name":"剑八","can_delete":false,"product_type":"c1","uid":1297630,"ip_address":"","ucode":"0A09F41DB8A4E7","user_header":"https://static001.geekbang.org/account/avatar/00/13/cc/de/e28c01e1.jpg","comment_is_top":false,"comment_ctime":1648968065,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1648968065","product_id":100035801,"comment_content":"cdn集群可以用负载来做，做高可用<br>不过这里涉及集群大小，太大则集群内需要同步的数据过大<br>redis cluster思路也可以考虑下","like_count":0},{"had_liked":false,"id":278060,"user_name":"kay","can_delete":false,"product_type":"c1","uid":1681159,"ip_address":"","ucode":"03F88D31BE2BD5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoHgweicVlhxFOAh4V9Bv0MwamKuOV8IZiacTaYjO3ZMuvwQdYibzeUnQSMpiaSfRTHIhnnLBFLDEq7qA/132","comment_is_top":false,"comment_ctime":1612746723,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612746723","product_id":100035801,"comment_content":"cdn缓存的数据是存储在哪种存储介质的，cos，本地磁盘还是...?","like_count":0},{"had_liked":false,"id":277351,"user_name":"鱼","can_delete":false,"product_type":"c1","uid":1487584,"ip_address":"","ucode":"89EC9CE3AD0281","user_header":"https://static001.geekbang.org/account/avatar/00/16/b2/e0/d856f5a4.jpg","comment_is_top":false,"comment_ctime":1612367442,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612367442","product_id":100035801,"comment_content":"请问GSLB（Global Server Load Balance，全局负载均衡），是CDN服务商提供，还是需要我们自建服务呢?","like_count":0},{"had_liked":false,"id":247091,"user_name":"Geek_18dfaf","can_delete":false,"product_type":"c1","uid":1543018,"ip_address":"","ucode":"CFC27E78220E2D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqw0R25Bt0iahFhEHfnxmzr9iaZf0eLsDQtFUJzgGkYwHTqicU9TydMngrJ4yL7D50awD2VibHBAdqplQ/132","comment_is_top":false,"comment_ctime":1599586812,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1599586812","product_id":100035801,"comment_content":"域名是a记录还是cname这一步判断，是在哪里做的，localdns么","like_count":0,"discussions":[{"author":{"id":2586341,"avatar":"","nickname":"石头","note":"","ucode":"EB3C9A277C7B0C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369936,"discussion_content":"这个应该是域名服务商提供的绑定功能吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619220319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":239591,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1596592443,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596592443","product_id":100035801,"comment_content":"老师，最后一张图，CDN 的 DNS 咋返回的地址是指向 GSLB 服务器，是在哪配置么？<br><br>另外，是谁提供 GSLB 这个服务，是CDN 厂商，还是需要自行搭建？？<br><br>谢谢老师！","like_count":0},{"had_liked":false,"id":222308,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1015754,"ip_address":"","ucode":"00DF2FEC58D2E6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7f/ca/ea85bfdd.jpg","comment_is_top":false,"comment_ctime":1590742806,"is_pvip":false,"replies":[{"id":"83119","content":"下次争取写的详细些~","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1591803654,"ip_address":"","comment_id":222308,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1590742806","product_id":100035801,"comment_content":"对CDN有了更进一步的了解，缺少实战，老师写得再详细点就好了😁","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496746,"discussion_content":"下次争取写的详细些~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591803654,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":218313,"user_name":"飞翔","can_delete":false,"product_type":"c1","uid":1065986,"ip_address":"","ucode":"3D3D10273BED18","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/02/5c8e4b81.jpg","comment_is_top":false,"comment_ctime":1589777352,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1589777352","product_id":100035801,"comment_content":"怎么排查和解决使用cdn后， 部分区域访问特别慢的问题","like_count":0},{"had_liked":false,"id":210496,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1587778759,"is_pvip":false,"replies":[{"id":"78854","content":"👍","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1588069906,"ip_address":"","comment_id":210496,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1587778759","product_id":100035801,"comment_content":"CDN是广义上缓存的一种，不过假设你现在所用的CDN出现问题了，你能做什么？你自己无力自建只能使用他人的，除了配置配置监控一下，真出问题了，猜测也只能打电话过去，其他无能为力。<br>当然，关心还是需要的。","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493035,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588069906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":200646,"user_name":"木木","can_delete":false,"product_type":"c1","uid":1205341,"ip_address":"","ucode":"B446FD36734E75","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/5d/de0536e8.jpg","comment_is_top":false,"comment_ctime":1585628738,"is_pvip":false,"replies":[{"id":"75176","content":"是的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1585700493,"ip_address":"","comment_id":200646,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1585628738","product_id":100035801,"comment_content":"CDN分发呢？同步静态资源到所有CDN节点上的？","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490085,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585700493,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188563,"user_name":"Tommy🍭","can_delete":false,"product_type":"c1","uid":1897024,"ip_address":"","ucode":"7A47B3E0DD9AD3","user_header":"https://static001.geekbang.org/account/avatar/00/1c/f2/40/508d90c6.jpg","comment_is_top":false,"comment_ctime":1584368723,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584368723","product_id":100035801,"comment_content":"你好，CDN专用DNS返回的是GLSB的IP了对吗？另外看有些优化提单IP直通车的，这部分是优化DNS的还是CDN？是指的绕过CDN专用DNS解析直接访问GLSB吗！","like_count":0},{"had_liked":false,"id":166310,"user_name":"androus","can_delete":false,"product_type":"c1","uid":1033758,"ip_address":"","ucode":"F2FE78A7C6E968","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c6/1e/a1e29910.jpg","comment_is_top":false,"comment_ctime":1577436729,"is_pvip":false,"replies":[{"id":"63463","content":"cdn厂家会提供一些删除和更新的接口的","user_name":"作者回复","user_name_real":"唐扬","uid":"1448977","ctime":1577492370,"ip_address":"","comment_id":166310,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1577436729","product_id":100035801,"comment_content":"大神我想问下CDN缓存怎么更新呢？比如商品的图片在cdn上面，但是某个时候后台运营人员对商品修改了图片，如果没有更新cdn信息的话，那用户访问的还是老的图片","like_count":0,"discussions":[{"author":{"id":1448977,"avatar":"https://static001.geekbang.org/account/avatar/00/16/1c/11/4b45993d.jpg","nickname":"唐扬","note":"","ucode":"1AF4C4A4DBC6EF","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479484,"discussion_content":"cdn厂家会提供一些删除和更新的接口的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577492370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":159846,"user_name":"骆驼1089","can_delete":false,"product_type":"c1","uid":1046421,"ip_address":"","ucode":"6E2EA2955BF204","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f7/95/42e16e49.jpg","comment_is_top":false,"comment_ctime":1575809748,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575809748","product_id":100035801,"comment_content":"老师，公司最近在做短视频的相关内容，您能从缓存的角度说一下大致的方向和思路吗？","like_count":0},{"had_liked":false,"id":154871,"user_name":"风中花","can_delete":false,"product_type":"c1","uid":1085237,"ip_address":"","ucode":"067E0A1E116844","user_header":"https://static001.geekbang.org/account/avatar/00/10/8f/35/f1839bb2.jpg","comment_is_top":false,"comment_ctime":1574584469,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1574584469","product_id":100035801,"comment_content":"老师好！按照我对本节的理解！我们有个场景就是压力测试站！性能很差！我想做cdn对于真实访问用户有提升！但是对于内部压力测试是不没有提高！压力测试没有通过！开发给出的方案是增加cdn！貌似这样是不合适","like_count":0,"discussions":[{"author":{"id":2134178,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK2Az5uTh9ZGab0pU6otFrXbzaHzLGvJTleveANhr48ALAJqZGWZ75sxJ5NHEJFWmg1mHurEZYCPg/132","nickname":"InfoQ_86bc07609fbd","note":"","ucode":"000CAFAD2DE0B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404533,"discussion_content":"压力测试，应该关注动态资源吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634318990,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364578,"discussion_content":"动静资源分离，对压力测试有帮助吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617526037,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1246178,"avatar":"https://static001.geekbang.org/account/avatar/00/13/03/e2/5768d26e.jpg","nickname":"inrtyx","note":"","ucode":"81CD18FF34ABAB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":185711,"discussion_content":"可能你是对的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582639041,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":145842,"user_name":"阿卡牛","can_delete":false,"product_type":"c1","uid":1022247,"ip_address":"","ucode":"0BC43A904C3199","user_header":"https://static001.geekbang.org/account/avatar/00/0f/99/27/47aa9dea.jpg","comment_is_top":false,"comment_ctime":1572394109,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1572394109","product_id":100035801,"comment_content":"同理可得，如果是网站可以在登陆页面预请求一次静态资源","like_count":0,"discussions":[{"author":{"id":1886331,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/c8/7b/153181d7.jpg","nickname":"夜辉","note":"","ucode":"9421385F51FF9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":364613,"discussion_content":"感觉在客户端（app/pc端）预启动阶段，获取预解析IP有用\n\n最多预加载首页静态资源","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617538692,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}