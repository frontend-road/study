{"id":466825,"title":"45ï½œé˜¶æ®µå®æ“ï¼ˆ8ï¼‰ï¼šæ„å»ºä¸€ä¸ªç®€å•çš„KV server-é…ç½®/æµ‹è¯•/ç›‘æ§/CI/CD","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é™ˆå¤©ã€‚</p><p>ç»ˆäºæ¥åˆ°äº†æˆ‘ä»¬è¿™ä¸ª KV server ç³»åˆ—çš„ç»ˆç« ã€‚å…¶å®åŸæœ¬ KV server æˆ‘åªè®¡åˆ’äº† 4 è®²ï¼Œä½†ç°åœ¨ 8 è®²ä¼¼ä¹éƒ½è¿˜æœ‰äº›æ„çŠ¹æœªå°½ã€‚è™½ç„¶è¿™æ˜¯ä¸€ä¸ªâ€œç®€å•â€çš„ KV serverï¼Œå®ƒæ²¡æœ‰å¤æ‚çš„æ€§èƒ½ä¼˜åŒ– â€”â€” æˆ‘ä»¬åªç”¨äº†ä¸€å¥ unsafeï¼›ä¹Ÿæ²¡æœ‰å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸå¤„ç† â€”â€” åªæœ‰é›¶æ˜Ÿ 'static æ ‡æ³¨ï¼›æ›´æ²¡æœ‰æ”¯æŒé›†ç¾¤çš„å¤„ç†ã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœä½ èƒ½å¤Ÿç†è§£åˆ°ç›®å‰ä¸ºæ­¢çš„ä»£ç ï¼Œç”šè‡³èƒ½ç‹¬ç«‹å†™å‡ºè¿™æ ·çš„ä»£ç ï¼Œé‚£ä¹ˆï¼Œä½ å·²ç»å…·å¤‡è¶³å¤Ÿçš„ã€èƒ½åœ¨ä¸€çº¿å¤§å‚å¼€å‘çš„å®åŠ›äº†ï¼Œå›½å†…æˆ‘ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œä½†åœ¨åŒ—ç¾è¿™è¾¹ï¼Œä¿å®ˆä¸€äº›åœ°è¯´ï¼Œ300k+ USD çš„ package åº”è¯¥å¯ä»¥è½»æ¾æ‹¿åˆ°ã€‚</p><p>ä»Šå¤©æˆ‘ä»¬å°±ç»™KV serveré¡¹ç›®æ”¶ä¸ªå°¾ï¼Œç»“åˆä¹‹å‰æ¢³ç†çš„å®æˆ˜ä¸­ Rust é¡¹ç›®åº”è¯¥è€ƒè™‘çš„é—®é¢˜ï¼Œæ¥èŠèŠå’Œç”Ÿäº§ç¯å¢ƒæœ‰å…³çš„ä¸€äº›å¤„ç†ï¼ŒæŒ‰å¼€å‘æµç¨‹ï¼Œä¸»è¦è®²äº”ä¸ªæ–¹é¢ï¼šé…ç½®ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€æµ‹é‡å’Œç›‘æ§ã€CI/CDã€‚</p><h2>é…ç½®</h2><p>é¦–å…ˆåœ¨ Cargo.toml é‡Œæ·»åŠ  <a href=\"https://github.com/serde-rs/serde\">serde</a> å’Œ <a href=\"https://github.com/alexcrichton/toml-rs\">toml</a>ã€‚æˆ‘ä»¬è®¡åˆ’ä½¿ç”¨ toml åšé…ç½®æ–‡ä»¶ï¼Œserde ç”¨æ¥å¤„ç†é…ç½®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼š</p><pre><code class=\"language-rust\">[dependencies]\n...\nserde = { version = \"1\", features = [\"derive\"] } # åºåˆ—åŒ–/ååºåˆ—åŒ–\n...\ntoml = \"0.5\" # toml æ”¯æŒ\n...\n</code></pre><!-- [[[read_end]]] --><p>ç„¶åæ¥åˆ›å»ºä¸€ä¸ª src/config.rsï¼Œæ„å»º KV server çš„é…ç½®ï¼š</p><pre><code class=\"language-rust\">use crate::KvError;\nuse serde::{Deserialize, Serialize};\nuse std::fs;\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub struct ServerConfig {\n    pub general: GeneralConfig,\n    pub storage: StorageConfig,\n    pub tls: ServerTlsConfig,\n}\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub struct ClientConfig {\n    pub general: GeneralConfig,\n    pub tls: ClientTlsConfig,\n}\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub struct GeneralConfig {\n    pub addr: String,\n}\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\n#[serde(tag = \"type\", content = \"args\")]\npub enum StorageConfig {\n    MemTable,\n    SledDb(String),\n}\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub struct ServerTlsConfig {\n    pub cert: String,\n    pub key: String,\n    pub ca: Option&lt;String&gt;,\n}\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub struct ClientTlsConfig {\n    pub domain: String,\n    pub identity: Option&lt;(String, String)&gt;,\n    pub ca: Option&lt;String&gt;,\n}\n\nimpl ServerConfig {\n    pub fn load(path: &amp;str) -&gt; Result&lt;Self, KvError&gt; {\n        let config = fs::read_to_string(path)?;\n        let config: Self = toml::from_str(&amp;config)?;\n        Ok(config)\n    }\n}\n\nimpl ClientConfig {\n    pub fn load(path: &amp;str) -&gt; Result&lt;Self, KvError&gt; {\n        let config = fs::read_to_string(path)?;\n        let config: Self = toml::from_str(&amp;config)?;\n        Ok(config)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn server_config_should_be_loaded() {\n        let result: Result&lt;ServerConfig, toml::de::Error&gt; =\n            toml::from_str(include_str!(\"../fixtures/server.conf\"));\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn client_config_should_be_loaded() {\n        let result: Result&lt;ClientConfig, toml::de::Error&gt; =\n            toml::from_str(include_str!(\"../fixtures/client.conf\"));\n        assert!(result.is_ok());\n    }\n}\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Rust ä¸‹ï¼Œæœ‰äº† serde çš„å¸®åŠ©ï¼Œå¤„ç†ä»»ä½•å·²çŸ¥æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œæ˜¯å¤šä¹ˆå®¹æ˜“çš„ä¸€ä»¶äº‹æƒ…ã€‚æˆ‘ä»¬<strong>åªéœ€è¦å®šä¹‰æ•°æ®ç»“æ„ï¼Œå¹¶ä¸ºæ•°æ®ç»“æ„ä½¿ç”¨ Serialize/Deserialize æ´¾ç”Ÿå®ï¼Œå°±å¯ä»¥å¤„ç†ä»»ä½•æ”¯æŒ serde çš„æ•°æ®ç»“æ„</strong>ã€‚</p><p>æˆ‘è¿˜å†™äº†ä¸ª examples/gen_config.rsï¼ˆä½ å¯ä»¥è‡ªè¡Œå»æŸ¥é˜…å®ƒçš„ä»£ç ï¼‰ï¼Œç”¨æ¥ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä¸‹é¢æ˜¯ç”Ÿæˆçš„æœåŠ¡ç«¯çš„é…ç½®ï¼š</p><pre><code class=\"language-rust\">[general]\naddr = '127.0.0.1:9527'\n\n[storage]\ntype = 'SledDb'\nargs = '/tmp/kv_server'\n\n[tls]\ncert = \"\"\"\n-----BEGIN CERTIFICATE-----\\r\nMIIBdzCCASmgAwIBAgIICpy02U2yuPowBQYDK2VwMDMxCzAJBgNVBAYMAkNOMRIw\\r\nEAYDVQQKDAlBY21lIEluYy4xEDAOBgNVBAMMB0FjbWUgQ0EwHhcNMjEwOTI2MDEy\\r\nNTU5WhcNMjYwOTI1MDEyNTU5WjA6MQswCQYDVQQGDAJDTjESMBAGA1UECgwJQWNt\\r\nZSBJbmMuMRcwFQYDVQQDDA5BY21lIEtWIHNlcnZlcjAqMAUGAytlcAMhAK2Z2AjF\\r\nA0uiltNuCvl6EVFl6tpaS/wJYB5IdWT2IISdo1QwUjAcBgNVHREEFTATghFrdnNl\\r\ncnZlci5hY21lLmluYzATBgNVHSUEDDAKBggrBgEFBQcDATAMBgNVHRMEBTADAQEA\\r\nMA8GA1UdDwEB/wQFAwMH4AAwBQYDK2VwA0EASGOmOWFPjbGhXNOmYNCa3lInbgRy\\r\niTNtB/5kElnbKkhKhRU7yQ8HTHWWkyU5WGWbOOIXEtYp+5ERUJC+mzP9Bw==\\r\n-----END CERTIFICATE-----\\r\n\"\"\"\nkey = \"\"\"\n-----BEGIN PRIVATE KEY-----\\r\nMFMCAQEwBQYDK2VwBCIEIPMyINaewhXwuTPUufFO2mMt/MvQMHrGDGxgdgfy/kUu\\r\noSMDIQCtmdgIxQNLopbTbgr5ehFRZeraWkv8CWAeSHVk9iCEnQ==\\r\n-----END PRIVATE KEY-----\\r\n\"\"\"\n</code></pre><p>æœ‰äº†é…ç½®æ–‡ä»¶çš„æ”¯æŒï¼Œå°±å¯ä»¥åœ¨ <a href=\"http://lib.rs\">lib.rs</a> ä¸‹å†™ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè®©æˆ‘ä»¬åˆ›å»ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ›´åŠ ç®€å•ï¼š</p><pre><code class=\"language-rust\">mod config;\nmod error;\nmod network;\nmod pb;\nmod service;\nmod storage;\n\npub use config::*;\npub use error::KvError;\npub use network::*;\npub use pb::abi::*;\npub use service::*;\npub use storage::*;\n\nuse anyhow::Result;\nuse tokio::net::{TcpListener, TcpStream};\nuse tokio_rustls::client;\nuse tokio_util::compat::FuturesAsyncReadCompatExt;\nuse tracing::info;\n\n/// é€šè¿‡é…ç½®åˆ›å»º KV æœåŠ¡å™¨\npub async fn start_server_with_config(config: &amp;ServerConfig) -&gt; Result&lt;()&gt; {\n    let acceptor =\n        TlsServerAcceptor::new(&amp;config.tls.cert, &amp;config.tls.key, config.tls.ca.as_deref())?;\n\n    let addr = &amp;config.general.addr;\n    match &amp;config.storage {\n        StorageConfig::MemTable =&gt; start_tls_server(addr, MemTable::new(), acceptor).await?,\n        StorageConfig::SledDb(path) =&gt; start_tls_server(addr, SledDb::new(path), acceptor).await?,\n    };\n\n    Ok(())\n}\n\n/// é€šè¿‡é…ç½®åˆ›å»º KV å®¢æˆ·ç«¯\npub async fn start_client_with_config(\n    config: &amp;ClientConfig,\n) -&gt; Result&lt;YamuxCtrl&lt;client::TlsStream&lt;TcpStream&gt;&gt;&gt; {\n    let addr = &amp;config.general.addr;\n    let tls = &amp;config.tls;\n\n    let identity = tls.identity.as_ref().map(|(c, k)| (c.as_str(), k.as_str()));\n    let connector = TlsClientConnector::new(&amp;tls.domain, identity, tls.ca.as_deref())?;\n    let stream = TcpStream::connect(addr).await?;\n    let stream = connector.connect(stream).await?;\n\n    // æ‰“å¼€ä¸€ä¸ª stream\n    Ok(YamuxCtrl::new_client(stream, None))\n}\n\nasync fn start_tls_server&lt;Store: Storage&gt;(\n    addr: &amp;str,\n    store: Store,\n    acceptor: TlsServerAcceptor,\n) -&gt; Result&lt;()&gt; {\n    let service: Service&lt;Store&gt; = ServiceInner::new(store).into();\n    let listener = TcpListener::bind(addr).await?;\n    info!(\"Start listening on {}\", addr);\n    loop {\n        let tls = acceptor.clone();\n        let (stream, addr) = listener.accept().await?;\n        info!(\"Client {:?} connected\", addr);\n\n        let svc = service.clone();\n        tokio::spawn(async move {\n            let stream = tls.accept(stream).await.unwrap();\n            YamuxCtrl::new_server(stream, None, move |stream| {\n                let svc1 = svc.clone();\n                async move {\n                    let stream = ProstServerStream::new(stream.compat(), svc1.clone());\n                    stream.process().await.unwrap();\n                    Ok(())\n                }\n            });\n        });\n    }\n}\n</code></pre><p>æœ‰äº† start_server_with_config å’Œ start_client_with_config è¿™ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€åŒ– src/server.rs å’Œ src/client.rs äº†ã€‚ä¸‹é¢æ˜¯ src/server.rs çš„æ–°ä»£ç ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse kv6::{start_server_with_config, ServerConfig};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    tracing_subscriber::fmt::init();\n    let config: ServerConfig = toml::from_str(include_str!(\"../fixtures/server.conf\"))?;\n\n    start_server_with_config(&amp;config).await?;\n\n    Ok(())\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªä»£ç ç®€æ´äº†å¾ˆå¤šã€‚åœ¨è¿™ä¸ªé‡æ„çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€äº›å…¶å®ƒæ”¹åŠ¨ï¼Œä½ å¯ä»¥çœ‹ GitHub repo ä¸‹ 45 è®²çš„ diff_configã€‚</p><h2>é›†æˆæµ‹è¯•</h2><p>ä¹‹å‰æˆ‘ä»¬å†™äº†å¾ˆå¤šå•å…ƒæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰å†™è¿‡ä¸€è¡Œé›†æˆæµ‹è¯•ã€‚ä»Šå¤©å°±æ¥å†™ä¸€ä¸ªç®€å•çš„é›†æˆæµ‹è¯•ï¼Œç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®Œæ•´çš„äº¤äº’å·¥ä½œæ­£å¸¸ã€‚</p><p>ä¹‹å‰æåˆ°åœ¨ Rust é‡Œï¼Œé›†æˆæµ‹è¯•æ”¾åœ¨ tests ç›®å½•ä¸‹ï¼Œæ¯ä¸ªæµ‹è¯•ç¼–æˆå•ç‹¬çš„äºŒè¿›åˆ¶ã€‚æ‰€ä»¥é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºå’Œ src å¹³è¡Œçš„ tests ç›®å½•ã€‚ç„¶åå†åˆ›å»º tests/server.rsï¼Œå¡«å…¥ä»¥ä¸‹ä»£ç ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse kv6::{\n    start_client_with_config, start_server_with_config, ClientConfig, CommandRequest,\n    ProstClientStream, ServerConfig, StorageConfig,\n};\nuse std::time::Duration;\nuse tokio::time;\n\n#[tokio::test]\nasync fn yamux_server_client_full_tests() -&gt; Result&lt;()&gt; {\n    let addr = \"127.0.0.1:10086\";\n\n    let mut config: ServerConfig = toml::from_str(include_str!(\"../fixtures/server.conf\"))?;\n    config.general.addr = addr.into();\n    config.storage = StorageConfig::MemTable;\n\n    // å¯åŠ¨æœåŠ¡å™¨\n    tokio::spawn(async move {\n        start_server_with_config(&amp;config).await.unwrap();\n    });\n\n    time::sleep(Duration::from_millis(10)).await;\n    let mut config: ClientConfig = toml::from_str(include_str!(\"../fixtures/client.conf\"))?;\n    config.general.addr = addr.into();\n\n    let mut ctrl = start_client_with_config(&amp;config).await.unwrap();\n    let stream = ctrl.open_stream().await?;\n    let mut client = ProstClientStream::new(stream);\n\n    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤\n    let cmd = CommandRequest::new_hset(\"table1\", \"hello\", \"world\".to_string().into());\n    client.execute_unary(&amp;cmd).await?;\n\n    // ç”Ÿæˆä¸€ä¸ª HGET å‘½ä»¤\n    let cmd = CommandRequest::new_hget(\"table1\", \"hello\");\n    let data = client.execute_unary(&amp;cmd).await?;\n\n    assert_eq!(data.status, 200);\n    assert_eq!(data.values, &amp;[\"world\".into()]);\n\n    Ok(())\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œ<strong>é›†æˆæµ‹è¯•çš„å†™æ³•å’Œå•å…ƒæµ‹è¯•å…¶å®å¾ˆç±»ä¼¼ï¼Œåªä¸è¿‡æˆ‘ä»¬ä¸éœ€è¦å†ä½¿ç”¨ #[cfg(test)] æ¥åšæ¡ä»¶ç¼–è¯‘</strong>ã€‚</p><p>å¦‚æœä½ çš„é›†æˆæµ‹è¯•æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦æ¯”è¾ƒå¤šçš„è¾…åŠ©ä»£ç ï¼Œé‚£ä¹ˆä½ è¿˜å¯ä»¥åœ¨ tests ä¸‹ cargo new å‡ºä¸€ä¸ªé¡¹ç›®ï¼Œç„¶ååœ¨é‚£ä¸ªé¡¹ç›®é‡Œæ’°å†™è¾…åŠ©ä»£ç å’Œæµ‹è¯•ä»£ç ã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ <a href=\"https://github.com/hyperium/tonic/tree/master/tests\">tonic çš„é›†æˆæµ‹è¯•</a>ã€‚ä¸è¿‡æ³¨æ„äº†ï¼Œé›†æˆæµ‹è¯•å’Œä½ çš„ crate ç”¨åŒæ ·çš„æ¡ä»¶ç¼–è¯‘ï¼Œæ‰€ä»¥åœ¨é›†æˆæµ‹è¯•é‡Œï¼Œæ— æ³•ä½¿ç”¨å•å…ƒæµ‹è¯•ä¸­æ„å»ºçš„è¾…åŠ©ä»£ç ã€‚</p><h2>æ€§èƒ½æµ‹è¯•</h2><p>åœ¨ä¹‹å‰ä¸æ–­å®Œå–„ KV server çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¸€å®šä¼šå¥½å¥‡ï¼šæˆ‘ä»¬çš„ KV server æ€§èƒ½ç©¶ç«Ÿå¦‚ä½•å‘¢ï¼Ÿé‚£æ¥å†™ä¸€ä¸ªå…³äº Pub/Sub çš„æ€§èƒ½æµ‹è¯•å§ã€‚</p><p>åŸºæœ¬çš„æƒ³æ³•æ˜¯æˆ‘ä»¬è¿ä¸Š 100 ä¸ª subscriber ä½œä¸ºèƒŒæ™¯ï¼Œç„¶åçœ‹ publisher publish çš„é€Ÿåº¦ã€‚</p><p>å› ä¸º BROADCAST_CAPACITY æœ‰é™ï¼Œæ˜¯ 128ï¼Œå½“ publisher é€Ÿåº¦å¤ªå¿«ï¼Œè€Œå¯¼è‡´ server ä¸èƒ½åŠæ—¶å¾€ subscriber å‘é€æ—¶ï¼Œserver æ¥æ”¶ client æ•°æ®çš„é€Ÿåº¦å°±ä¼šé™ä¸‹æ¥ï¼Œæ— æ³•æ¥æ”¶æ–°çš„ clientï¼Œæ•´ä½“çš„ publish çš„é€Ÿåº¦ä¹Ÿä¼šé™ä¸‹æ¥ï¼Œæ‰€ä»¥è¿™ä¸ªæµ‹è¯•èƒ½å¤Ÿäº†è§£ server å¤„ç† publish çš„é€Ÿåº¦ã€‚</p><p>ä¸ºäº†ç¡®è®¤è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨ start_tls_server() å‡½æ•°ä¸­ï¼Œåœ¨ process() ä¹‹å‰ï¼Œå†åŠ ä¸ª 100ms çš„å»¶æ—¶ï¼Œäººä¸ºå‡ç¼“ç³»ç»Ÿçš„å¤„ç†é€Ÿåº¦ï¼š</p><pre><code class=\"language-rust\">async move {\n    let stream = ProstServerStream::new(stream.compat(), svc1.clone());\n    // å»¶è¿Ÿ 100ms å¤„ç†\n    time::sleep(Duration::from_millis(100)).await;\n    stream.process().await.unwrap();\n    Ok(())\n}\n</code></pre><p>å¥½ï¼Œç°åœ¨å¯ä»¥å†™æ€§èƒ½æµ‹è¯•äº†ã€‚</p><p>åœ¨ Rust ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <a href=\"https://github.com/bheisler/criterion.rs\">criterion</a> åº“ã€‚å®ƒå¯ä»¥å¤„ç†åŸºæœ¬çš„æ€§èƒ½æµ‹è¯•ï¼Œå¹¶ç”Ÿæˆæ¼‚äº®çš„æŠ¥å‘Šã€‚æ‰€ä»¥åœ¨ Cargo.toml ä¸­åŠ å…¥ï¼š</p><pre><code class=\"language-rust\">[dev-dependencies]\n...\ncriterion = { version = \"0.3\", features = [\"async_futures\", \"async_tokio\", \"html_reports\"] } # benchmark\n...\nrand = \"0.8\" # éšæœºæ•°å¤„ç†\n...\n\n[[bench]]\nname = \"pubsub\"\nharness = false\n</code></pre><p>æœ€åè¿™ä¸ª bench sectionï¼Œæè¿°äº†æ€§èƒ½æµ‹è¯•çš„åå­—ï¼Œå®ƒå¯¹åº” benches ç›®å½•ä¸‹çš„åŒåæ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬åˆ›å»ºå’Œ src å¹³çº§çš„ benchesï¼Œç„¶åå†åˆ›å»º benches/pubsub.rsï¼Œæ·»å…¥å¦‚ä¸‹ä»£ç ï¼š</p><pre><code class=\"language-rust\">use anyhow::Result;\nuse criterion::{criterion_group, criterion_main, Criterion};\nuse futures::StreamExt;\nuse kv6::{\n    start_client_with_config, start_server_with_config, ClientConfig, CommandRequest, ServerConfig,\n    StorageConfig, YamuxCtrl,\n};\nuse rand::prelude::SliceRandom;\nuse std::time::Duration;\nuse tokio::net::TcpStream;\nuse tokio::runtime::Builder;\nuse tokio::time;\nuse tokio_rustls::client::TlsStream;\nuse tracing::info;\n\nasync fn start_server() -&gt; Result&lt;()&gt; {\n    let addr = \"127.0.0.1:9999\";\n    let mut config: ServerConfig = toml::from_str(include_str!(\"../fixtures/server.conf\"))?;\n    config.general.addr = addr.into();\n    config.storage = StorageConfig::MemTable;\n\n    tokio::spawn(async move {\n        start_server_with_config(&amp;config).await.unwrap();\n    });\n\n    Ok(())\n}\n\nasync fn connect() -&gt; Result&lt;YamuxCtrl&lt;TlsStream&lt;TcpStream&gt;&gt;&gt; {\n    let addr = \"127.0.0.1:9999\";\n    let mut config: ClientConfig = toml::from_str(include_str!(\"../fixtures/client.conf\"))?;\n    config.general.addr = addr.into();\n\n    Ok(start_client_with_config(&amp;config).await?)\n}\n\nasync fn start_subscribers(topic: &amp;'static str) -&gt; Result&lt;()&gt; {\n    let mut ctrl = connect().await?;\n    let stream = ctrl.open_stream().await?;\n    info!(\"C(subscriber): stream opened\");\n    let cmd = CommandRequest::new_subscribe(topic.to_string());\n    tokio::spawn(async move {\n        let mut stream = stream.execute_streaming(&amp;cmd).await.unwrap();\n        while let Some(Ok(data)) = stream.next().await {\n            drop(data);\n        }\n    });\n\n    Ok(())\n}\n\nasync fn start_publishers(topic: &amp;'static str, values: &amp;'static [&amp;'static str]) -&gt; Result&lt;()&gt; {\n    let mut rng = rand::thread_rng();\n    let v = values.choose(&amp;mut rng).unwrap();\n\n    let mut ctrl = connect().await.unwrap();\n    let mut stream = ctrl.open_stream().await.unwrap();\n    info!(\"C(publisher): stream opened\");\n\n    let cmd = CommandRequest::new_publish(topic.to_string(), vec![(*v).into()]);\n    stream.execute_unary(&amp;cmd).await.unwrap();\n\n    Ok(())\n}\n\nfn pubsub(c: &amp;mut Criterion) {\n    // tracing_subscriber::fmt::init();\n    // åˆ›å»º Tokio runtime\n    let runtime = Builder::new_multi_thread()\n        .worker_threads(4)\n        .thread_name(\"pubsub\")\n        .enable_all()\n        .build()\n        .unwrap();\n    let values = &amp;[\"Hello\", \"Tyr\", \"Goodbye\", \"World\"];\n    let topic = \"lobby\";\n\n    // è¿è¡ŒæœåŠ¡å™¨å’Œ 100 ä¸ª subscriberï¼Œä¸ºæµ‹è¯•å‡†å¤‡\n    runtime.block_on(async {\n        eprint!(\"preparing server and subscribers\");\n        start_server().await.unwrap();\n        time::sleep(Duration::from_millis(50)).await;\n        for _ in 0..100 {\n            start_subscribers(topic).await.unwrap();\n            eprint!(\".\");\n        }\n        eprintln!(\"Done!\");\n    });\n\n    // è¿›è¡Œ benchmark\n    c.bench_function(\"publishing\", move |b| {\n        b.to_async(&amp;runtime)\n            .iter(|| async { start_publishers(topic, values).await })\n    });\n}\n\ncriterion_group! {\n    name = benches;\n    config = Criterion::default().sample_size(10);\n    targets = pubsub\n}\ncriterion_main!(benches);\n</code></pre><p>å¤§éƒ¨åˆ†çš„ä»£ç éƒ½å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åˆ›å»ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œä¸ºæµ‹è¯•åšå‡†å¤‡ã€‚è¯´ä¸€ä¸‹è¿™é‡Œé¢æ ¸å¿ƒçš„ benchmark ä»£ç ï¼š</p><pre><code class=\"language-rust\">c.bench_function(\"publishing\", move |b| {\n    b.to_async(&amp;runtime)\n        .iter(|| async { start_publishers(topic, values).await })\n});\n</code></pre><p>å¯¹äºè¦æµ‹è¯•çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…æˆä¸€ä¸ªå‡½æ•°è¿›è¡Œæµ‹è¯•ã€‚<strong>è¿™é‡Œå› ä¸ºè¦åš async å‡½æ•°çš„æµ‹è¯•ï¼Œéœ€è¦ä½¿ç”¨ runtimeã€‚æ™®é€šçš„å‡½æ•°ä¸éœ€è¦è°ƒç”¨ to_async</strong>ã€‚å¯¹äºæ›´å¤šæœ‰å…³ criterion çš„ç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒå®ƒçš„æ–‡æ¡£ã€‚</p><p>è¿è¡Œ <code>cargo bench</code> åï¼Œä¼šè§åˆ°å¦‚ä¸‹æ‰“å°ï¼ˆå¦‚æœä½ çš„ä»£ç æ— æ³•é€šè¿‡ï¼Œå¯ä»¥å‚è€ƒ repo é‡Œçš„ diff_benchmarkï¼Œæˆ‘é¡ºä¾¿åšäº†ä¸€ç‚¹å°é‡æ„ï¼‰ï¼š</p><pre><code class=\"language-bash\">preparing server and subscribers....................................................................................................Done!\npublishing              time:   [419.73 ms 426.84 ms 434.20 ms]                     \n                        change: [-1.6712% +1.0499% +3.6586%] (p = 0.48 &gt; 0.05)\n                        No change in performance detected.\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå•ä¸ª publish çš„å¤„ç†é€Ÿåº¦è¦ 426msï¼Œå¥½æ…¢ï¼æˆ‘ä»¬æŠŠä¹‹å‰åœ¨ start_tls_server() é‡ŒåŠ çš„å»¶è¿Ÿå»æ‰ï¼Œå†æ¬¡æµ‹è¯•ï¼š</p><pre><code class=\"language-bash\">preparing server and subscribers....................................................................................................Done!\npublishing              time:   [318.61 ms 324.48 ms 329.81 ms]                     \n                        change: [-25.854% -23.980% -22.144%] (p = 0.00 &lt; 0.05)\n                        Performance has improved.\n</code></pre><p>å—¯ï¼Œè¿™ä¸‹ 324msï¼Œæ­£å¥½æ˜¯å‡å»åˆšæ‰åŠ çš„ 100msã€‚å¯æ˜¯è¿™ä¸ªé€Ÿåº¦ä¾æ—§ä¸åˆç†ï¼Œå‡­ç›´è§‰æˆ‘ä»¬æ„Ÿè§‰ä¸€ä¸‹è¿™ä¸ªé€Ÿåº¦ï¼Œæ˜¯ Python è¿™æ ·çš„è¯­è¨€è¿˜æ­£å¸¸ï¼Œå¦‚æœæ˜¯ Rust ä¹Ÿå¤ªæ…¢äº†å§ï¼Ÿ</p><h2>æµ‹é‡å’Œç›‘æ§</h2><p>å·¥ä¸šç•Œæœ‰å¥åè¨€ï¼šå¦‚æœä½ æ— æ³•æµ‹é‡ï¼Œé‚£ä½ å°±æ— æ³•æ”¹è¿›ï¼ˆIf you canâ€™t measure it, you canâ€™t improve itï¼‰ã€‚ç°åœ¨çŸ¥é“äº† KV server æ€§èƒ½æœ‰é—®é¢˜ï¼Œä½†å¹¶ä¸çŸ¥é“é—®é¢˜å‡ºåœ¨å“ªé‡Œã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆé€‚çš„æµ‹é‡æ–¹å¼ã€‚</p><p>ç›®å‰ï¼Œ<strong>æ¯”è¾ƒå¥½çš„ç«¯å¯¹ç«¯çš„æ€§èƒ½ç›‘æ§å’Œæµ‹é‡å·¥å…·æ˜¯ jaeger</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ KV server/client ä¾§æ”¶é›†ç›‘æ§ä¿¡æ¯ï¼Œå‘é€ç»™ jaeger æ¥æŸ¥çœ‹åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„æ•´ä¸ªå¤„ç†æµç¨‹ä¸­ï¼Œæ—¶é—´éƒ½èŠ±è´¹åˆ°å“ªé‡Œå»äº†ã€‚</p><p>ä¹‹å‰æˆ‘ä»¬åœ¨ KV server é‡Œä½¿ç”¨çš„æ—¥å¿—å·¥å…·æ˜¯ tracingï¼Œä¸è¿‡æ—¥å¿—åªæ˜¯å®ƒçš„è¯¸å¤šåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒè¿˜èƒ½åš <a href=\"https://docs.rs/tracing/0.1.28/tracing/attr.instrument.html\">instrument</a>ï¼Œç„¶åé…åˆ <a href=\"https://github.com/open-telemetry/opentelemetry-rust\">opentelemetry</a> åº“ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠ instrument çš„ç»“æœå‘é€ç»™ jaeger äº†ã€‚</p><p>å¥½ï¼Œåœ¨ Cargo.toml é‡Œæ·»åŠ æ–°çš„ä¾èµ–ï¼š</p><pre><code class=\"language-rust\">[dependencies]\n...\nopentelemetry-jaeger = \"0.15\" # opentelemetry jaeger æ”¯æŒ\n...\ntracing-appender = \"0.1\" # æ–‡ä»¶æ—¥å¿—\ntracing-opentelemetry = \"0.15\" # opentelemetry æ”¯æŒ\ntracing-subscriber = { version = \"0.2\", features = [\"json\", \"chrono\"] } # æ—¥å¿—å¤„ç†\n</code></pre><p>æœ‰äº†è¿™äº›ä¾èµ–åï¼Œåœ¨ benches/pubsub.rs é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆå§‹åŒ– tracing_subscriber æ—¶ï¼Œä½¿ç”¨ jaeger å’Œ opentelemetry tracerï¼š</p><pre><code class=\"language-rust\">fn pubsub(c: &amp;mut Criterion) {\n    let tracer = opentelemetry_jaeger::new_pipeline()\n        .with_service_name(\"kv-bench\")\n        .install_simple()\n        .unwrap();\n    let opentelemetry = tracing_opentelemetry::layer().with_tracer(tracer);\n\n    tracing_subscriber::registry()\n        .with(EnvFilter::from_default_env())\n        .with(opentelemetry)\n        .init();\n\n    let root = span!(tracing::Level::INFO, \"app_start\", work_units = 2);\n    let _enter = root.enter();\n    // åˆ›å»º Tokio runtime\n\t\t...\n}\n</code></pre><p>è®¾ç½®å¥½ tracing åï¼Œå°±åœ¨ç³»ç»Ÿçš„ä¸»æµç¨‹ä¸Šæ·»åŠ ç›¸åº”çš„ instrumentï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/f1/a1/f1680244d5c7901ec26181c01bfea8a1.jpg?wh=2312x1379\" alt=\"\"></p><p>æ–°æ·»åŠ çš„ä»£ç ä½ å¯ä»¥çœ‹ repo ä¸­çš„ diff_telemetryã€‚æ³¨æ„ instrument å¯ä»¥ç”¨ä¸åŒçš„åç§°ï¼Œæ¯”å¦‚ï¼Œå¯¹äº TlsConnector::new() å‡½æ•°ï¼Œå¯ä»¥ç”¨ <code>#[instrument(name = \"tls_connector_new\")]</code>ï¼Œè¿™æ ·å®ƒçš„åå­—è¾¨è¯†åº¦é«˜ä¸€äº›ã€‚</p><p>ä¸ºä¸»æµç¨‹ä¸­çš„å‡½æ•°æ·»åŠ å®Œ instrument åï¼Œä½ éœ€è¦å…ˆæ‰“å¼€ä¸€ä¸ªçª—å£ï¼Œè¿è¡Œ jaegerï¼ˆéœ€è¦ dockerï¼‰ï¼š</p><pre><code class=\"language-bash\">docker run -d -p6831:6831/udp -p6832:6832/udp -p16686:16686 -p14268:14268 jaegertracing/all-in-one:latest\n</code></pre><p>ç„¶åå¸¦ç€ RUST_LOG=info è¿è¡Œ benchmarkï¼š</p><pre><code class=\"language-bash\">RUST_LOG=info cargo bench\n</code></pre><p>ç”±äºæˆ‘çš„ OS X ä¸Šæ²¡è£… dockerï¼ˆdocker ä¸æ”¯æŒ Macï¼Œéœ€è¦ Linux VM ä¸­è½¬ï¼‰ï¼Œæˆ‘å°±åœ¨ä¸€ä¸ª Ubuntu è™šæ‹Ÿæœºé‡Œè¿è¡Œè¿™ä¸¤æ¡å‘½ä»¤ï¼š</p><pre><code class=\"language-bash\">preparing server and subscribers....................................................................................................Done!\npublishing              time:   [1.7464 ms 1.9556 ms 2.2343 ms]                       \nFound 2 outliers among 10 measurements (20.00%)\n  1 (10.00%) high mild\n  1 (10.00%) high severe\n</code></pre><p>å¹¶æ²¡æœ‰åšä»»ä½•äº‹æƒ…ï¼Œä¼¼ä¹åªæ˜¯æ¢äº†ä¸ªç³»ç»Ÿï¼Œæ€§èƒ½å°±æå‡äº†å¾ˆå¤šï¼Œè¿™ç»™æˆ‘ä»¬ä¸€ä¸ª tipï¼šä¹Ÿè®¸é—®é¢˜å‡ºåœ¨ OS X å’Œ Linux ç³»ç»Ÿç›¸å…³çš„éƒ¨åˆ†ã€‚</p><p>ä¸ç®¡æ€æ ·ï¼Œå·²ç»å‘é€äº†ä¸å°‘æ•°æ®ç»™ jaegerï¼Œæˆ‘ä»¬åˆ° jaeger ä¸Šçœ‹çœ‹é—®é¢˜å‡ºåœ¨å“ªé‡Œã€‚</p><p>æ‰“å¼€ <a href=\"http://localhost:16686/\">http://localhost:16686/</a>ï¼Œservice é€‰ kv-benchï¼ŒOperation é€‰ app_startï¼Œç‚¹å‡» â€œFind Tracesâ€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•è·çš„ traceã€‚å› ä¸ºè¿è¡Œäº†ä¸¤æ¬¡ benchmarkï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ª app_start çš„æŸ¥è¯¢ç»“æœï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/ec/77/ecd9b1d06debe7fb3fe507befd803877.png?wh=1920x1048\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡ start_client_with_config éƒ½è¦èŠ± 1.6-2.5msï¼Œå…¶ä¸­æœ‰å·®ä¸å¤šä¸€å°åŠæ—¶é—´èŠ±åœ¨äº† TlsClientConnector::new() ä¸Šï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/fe/b6/fe574ccac09ce5434027fce2afebaeb6.png?wh=1920x1210\" alt=\"\"></p><p>å¦‚æœè¯´ TlsClientConnector::connect() èŠ±ä¸å°‘æ—¶é—´è¿˜æƒ…æœ‰å¯åŸï¼Œå› ä¸ºè¿™æ˜¯æ•´ä¸ª TLS åè®®çš„æ¡æ‰‹è¿‡ç¨‹ï¼Œæ¶‰åŠåˆ°ç½‘ç»œè°ƒç”¨ã€åŒ…çš„åŠ è§£å¯†ç­‰ã€‚<strong>ä½† TlsClientConnector::new() å°±æ˜¯åŠ è½½ä¸€äº›è¯ä¹¦ã€åˆ›å»º TlsConnector è¿™ä¸ªæ•°æ®ç»“æ„è€Œå·²ï¼Œä¸ºä½•è¿™ä¹ˆæ…¢</strong>ï¼Ÿ</p><p>ä»”ç»†é˜…è¯» TlsClientConnector::new() çš„ä»£ç ï¼Œä½ å¯ä»¥å¯¹ç…§æ³¨é‡Šçœ‹ï¼š</p><pre><code class=\"language-rust\">#[instrument(name = \"tls_connector_new\", skip_all)]\npub fn new(\n    domain: impl Into&lt;String&gt; + std::fmt::Debug,\n    identity: Option&lt;(&amp;str, &amp;str)&gt;,\n    server_ca: Option&lt;&amp;str&gt;,\n) -&gt; Result&lt;Self, KvError&gt; {\n    let mut config = ClientConfig::new();\n\n    // å¦‚æœæœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŠ è½½ä¹‹\n    if let Some((cert, key)) = identity {\n        let certs = load_certs(cert)?;\n        let key = load_key(key)?;\n        config.set_single_client_cert(certs, key)?;\n    }\n\n    // åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾\n    config.root_store = match rustls_native_certs::load_native_certs() {\n        Ok(store) | Err((Some(store), _)) =&gt; store,\n        Err((None, error)) =&gt; return Err(error.into()),\n    };\n\n    // å¦‚æœæœ‰ç­¾ç½²æœåŠ¡å™¨çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒï¼Œè¿™æ ·æœåŠ¡å™¨è¯ä¹¦ä¸åœ¨æ ¹è¯ä¹¦é“¾\n    // ä½†æ˜¯è¿™ä¸ª CA è¯ä¹¦èƒ½éªŒè¯å®ƒï¼Œä¹Ÿå¯ä»¥\n    if let Some(cert) = server_ca {\n        let mut buf = Cursor::new(cert);\n        config.root_store.add_pem_file(&amp;mut buf).unwrap();\n    }\n\n    Ok(Self {\n        config: Arc::new(config),\n        domain: Arc::new(domain.into()),\n    })\n}\n</code></pre><p>å¯ä»¥å‘ç°ï¼Œå®ƒçš„ä»£ç å”¯ä¸€å¯èƒ½å½±å“æ€§èƒ½çš„å°±æ˜¯åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾çš„éƒ¨åˆ†ã€‚è¿™ä¸ªä»£ç ä¼šå’Œæ“ä½œç³»ç»Ÿäº¤äº’ï¼Œè·å–ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾ã€‚ä¹Ÿè®¸ï¼Œè¿™å°±æ˜¯å½±å“æ€§èƒ½çš„åŸå› ä¹‹ä¸€ï¼Ÿ</p><p><strong>é‚£æˆ‘ä»¬å°†å…¶ç®€å•é‡æ„ä¸€ä¸‹</strong>ã€‚å› ä¸ºæ ¹è¯ä¹¦é“¾ï¼Œåªæœ‰åœ¨å®¢æˆ·ç«¯æ²¡æœ‰æä¾›ç”¨äºéªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„ CA è¯ä¹¦æ—¶ï¼Œæ‰éœ€è¦ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ²¡æœ‰ CA è¯ä¹¦æ—¶ï¼Œæ‰åŠ è½½æœ¬åœ°çš„æ ¹è¯ä¹¦é“¾ï¼š</p><pre><code class=\"language-rust\">#[instrument(name = \"tls_connector_new\", skip_all)]\npub fn new(\n    domain: impl Into&lt;String&gt; + std::fmt::Debug,\n    identity: Option&lt;(&amp;str, &amp;str)&gt;,\n    server_ca: Option&lt;&amp;str&gt;,\n) -&gt; Result&lt;Self, KvError&gt; {\n    let mut config = ClientConfig::new();\n\n    // å¦‚æœæœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŠ è½½ä¹‹\n    if let Some((cert, key)) = identity {\n        let certs = load_certs(cert)?;\n        let key = load_key(key)?;\n        config.set_single_client_cert(certs, key)?;\n    }\n\n    // å¦‚æœæœ‰ç­¾ç½²æœåŠ¡å™¨çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒï¼Œè¿™æ ·æœåŠ¡å™¨è¯ä¹¦ä¸åœ¨æ ¹è¯ä¹¦é“¾\n    // ä½†æ˜¯è¿™ä¸ª CA è¯ä¹¦èƒ½éªŒè¯å®ƒï¼Œä¹Ÿå¯ä»¥\n    if let Some(cert) = server_ca {\n        let mut buf = Cursor::new(cert);\n        config.root_store.add_pem_file(&amp;mut buf).unwrap();\n    } else {\n        // åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾\n        config.root_store = match rustls_native_certs::load_native_certs() {\n            Ok(store) | Err((Some(store), _)) =&gt; store,\n            Err((None, error)) =&gt; return Err(error.into()),\n        };\n    }\n\n    Ok(Self {\n        config: Arc::new(config),\n        domain: Arc::new(domain.into()),\n    })\n}\n</code></pre><p>å®Œæˆè¿™ä¸ªä¿®æ”¹åï¼Œæˆ‘ä»¬å†è¿è¡Œ <code>RUST_LOG=info cargo bench</code>ï¼Œç°åœ¨çš„æ€§èƒ½è¾¾åˆ°äº† 1.64msï¼Œç›¸æ¯”ä¹‹å‰çš„ 1.95msï¼Œæå‡äº† 16%ã€‚</p><p>æ‰“å¼€ jaegerï¼Œçœ‹æœ€æ–°çš„ app_start ç»“æœï¼Œå‘ç° TlsClientConnector::new() æ‰€èŠ±æ—¶é—´é™åˆ°äº† ~12us å·¦å³ã€‚å—¯ï¼Œè™½ç„¶æ²¡æœ‰æŠ“åˆ°æœåŠ¡å™¨æœ¬èº«çš„ bugï¼Œä½†å®¢æˆ·ç«¯çš„ bug å€’æ˜¯è§£å†³äº†ä¸€ä¸ªã€‚<br>\n<img src=\"https://static001.geekbang.org/resource/image/3c/0b/3cfde740dbe0d4a897e2d4c3684b530b.png?wh=1920x1164\" alt=\"\"></p><p>è‡³äºæœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬çœ‹ Service::execute çš„ä¸»æµç¨‹ï¼Œæ‰§è¡Œé€Ÿåº¦åœ¨ 40-60usï¼Œé—®é¢˜ä¸å¤§ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/7b/31/7be6139668c82fb8b79fb66f3ed06d31.png?wh=1920x1215\" alt=\"\"></p><p>å†çœ‹æœåŠ¡å™¨çš„ä¸»æµç¨‹ server_processï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/07/63/076402ac25b507295d022b980378e363.png?wh=1920x1040\" alt=\"\"></p><p>è¿™æ˜¯æˆ‘ä»¬åœ¨ start_tls_server() é‡Œé¢å¤–æ·»åŠ çš„ tracing spanï¼š</p><pre><code class=\"language-rust\">loop {\n\t\tlet root = span!(tracing::Level::INFO, \"server_process\");\n\t\tlet _enter = root.enter();\n\t\t...\n}\n</code></pre><p>æŠŠå³ä¸Šè§’çš„ trace timeline æ”¹æˆ trace graphï¼Œç„¶åç‚¹å³ä¾§çš„ timeï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/14/41/1499657924a241e43c9d1be467793041.png?wh=1920x1207\" alt=\"\"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦çš„æœåŠ¡å™¨æ—¶é—´éƒ½èŠ±åœ¨äº† TLS accept ä¸Šï¼Œæ‰€ä»¥ï¼Œ<strong>ç›®å‰æœåŠ¡å™¨æ²¡æœ‰å¤ªå¤šå€¼å¾—ä¼˜åŒ–çš„åœ°æ–¹</strong>ã€‚</p><p>ç”±äº tracing æœ¬èº«ä¹Ÿå ç”¨ä¸å°‘ CPUï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ <code>cargo bench</code> çœ‹çœ‹ç›®å‰çš„ç»“æœï¼š</p><pre><code class=\"language-bash\">preparing server and subscribers....................................................................................................Done!\npublishing              time:   [1.3986 ms 1.4140 ms 1.4474 ms]                       \n                        change: [-26.647% -19.977% -10.798%] (p = 0.00 &lt; 0.05)\n                        Performance has improved.\nFound 2 outliers among 10 measurements (20.00%)\n  2 (20.00%) high severe\n</code></pre><p>ä¸åŠ  RUST_LOG=info åï¼Œæ•´ä½“æ€§èƒ½åˆ°äº† 1.4msã€‚è¿™æ˜¯æˆ‘åœ¨ Ubuntu è™šæ‹Ÿæœºä¸‹çš„ç»“æœã€‚</p><p>æˆ‘ä»¬å†å›åˆ° OS X ä¸‹æµ‹è¯•ï¼Œçœ‹çœ‹ TlsClientConnector::new() çš„ä¿®æ”¹ï¼Œå¯¹OS X æ˜¯å¦æœ‰æ•ˆï¼š</p><pre><code class=\"language-bash\">preparing server and subscribers....................................................................................................Done!\npublishing              time:   [1.4086 ms 1.4229 ms 1.4315 ms]                       \n                        change: [-99.570% -99.563% -99.554%] (p = 0.00 &lt; 0.05)\n                        Performance has improved.\n</code></pre><p>å—¯ï¼Œåœ¨æˆ‘çš„ OS Xä¸‹ï¼Œç°åœ¨æ•´ä½“æ€§èƒ½ä¹Ÿåˆ°äº† 1.4ms çš„æ°´å¹³ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œåœ¨æœ‰ 100 ä¸ª subscribers çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ KV server æ¯ç§’é’Ÿå¯ä»¥å¤„ç† 714k publish è¯·æ±‚ï¼›è€Œåœ¨ 1000 ä¸ª subscribers çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½åœ¨ 11.1ms çš„æ°´å¹³ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’å¯ä»¥å¤„ç† 90k publish è¯·æ±‚ï¼š</p><pre><code class=\"language-bash\">publishing              time:   [11.007 ms 11.095 ms 11.253 ms]                      \n                        change: [-96.618% -96.556% -96.486%] (p = 0.00 &lt; 0.05)\n                        Performance has improved.\n</code></pre><p>ä½ ä¹Ÿè®¸ä¼šè§‰å¾—ç›®å‰ publish çš„ value å¤ªå°ï¼Œé‚£æ¢ä¸€äº›æ›´åŠ è´´è¿‘å®é™…çš„å­—ç¬¦ä¸²å¤§å°ï¼š</p><pre><code class=\"language-rust\">// let values = &amp;[\"Hello\", \"Tyr\", \"Goodbye\", \"World\"];\nlet base_str = include_str!(\"../fixtures/server.conf\"); // 891 bytes\n\nlet values: &amp;'static [&amp;'static str] = Box::leak(\n    vec![\n        &amp;base_str[..64],\n        &amp;base_str[..128],\n        &amp;base_str[..256],\n        &amp;base_str[..512],\n    ]\n    .into_boxed_slice(),\n);\n</code></pre><p>æµ‹è¯•ç»“æœå·®ä¸å¤ªå¤šï¼š</p><pre><code class=\"language-plain\">publishing              time:   [10.917 ms 11.098 ms 11.428 ms]                      \n                        change: [-0.4822% +2.3311% +4.9631%] (p = 0.12 &gt; 0.05)\n                        No change in performance detected.\n</code></pre><p>criterion è¿˜ä¼šç”Ÿæˆæ¼‚äº®çš„ reportï¼Œä½ å¯ä»¥ç”¨æµè§ˆå™¨æ‰“å¼€ ./target/criterion/publishing/report/index.html æŸ¥çœ‹ï¼ˆåå­—æ˜¯publishing ï¼Œå› ä¸º benchmark ID æ˜¯ publishingï¼‰ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/d3/85/d3cebd8e3c164171febbe34e43916885.png?wh=1860x2308\" alt=\"\"></p><p>å¥½ï¼Œå¤„ç†å®Œæ€§èƒ½ç›¸å…³çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥<strong>ä¸º server æ·»åŠ æ—¥å¿—å’Œæ€§èƒ½ç›‘æµ‹çš„æ”¯æŒ</strong>ï¼š</p><pre><code class=\"language-rust\">use std::env;\n\nuse anyhow::Result;\nuse kv6::{start_server_with_config, RotationConfig, ServerConfig};\nuse tokio::fs;\nuse tracing::span;\nuse tracing_subscriber::{\n    fmt::{self, format},\n    layer::SubscriberExt,\n    prelude::*,\n    EnvFilter,\n};\n\n#[tokio::main]\nasync fn main() -&gt; Result&lt;()&gt; {\n    // å¦‚æœæœ‰ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ config\n    let config = match env::var(\"KV_SERVER_CONFIG\") {\n        Ok(path) =&gt; fs::read_to_string(&amp;path).await?,\n        Err(_) =&gt; include_str!(\"../fixtures/server.conf\").to_string(),\n    };\n    let config: ServerConfig = toml::from_str(&amp;config)?;\n\n    let tracer = opentelemetry_jaeger::new_pipeline()\n        .with_service_name(\"kv-server\")\n        .install_simple()?;\n    let opentelemetry = tracing_opentelemetry::layer().with_tracer(tracer);\n\n    // æ·»åŠ \n    let log = &amp;config.log;\n    let file_appender = match log.rotation {\n        RotationConfig::Hourly =&gt; tracing_appender::rolling::hourly(&amp;log.path, \"server.log\"),\n        RotationConfig::Daily =&gt; tracing_appender::rolling::daily(&amp;log.path, \"server.log\"),\n        RotationConfig::Never =&gt; tracing_appender::rolling::never(&amp;log.path, \"server.log\"),\n    };\n\n    let (non_blocking, _guard1) = tracing_appender::non_blocking(file_appender);\n    let fmt_layer = fmt::layer()\n        .event_format(format().compact())\n        .with_writer(non_blocking);\n\n    tracing_subscriber::registry()\n        .with(EnvFilter::from_default_env())\n        .with(fmt_layer)\n        .with(opentelemetry)\n        .init();\n\n    let root = span!(tracing::Level::INFO, \"app_start\", work_units = 2);\n    let _enter = root.enter();\n\n    start_server_with_config(&amp;config).await?;\n\n    Ok(())\n}\n</code></pre><p>ä¸ºäº†è®©æ—¥å¿—èƒ½åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œéœ€è¦æ›´æ–°ä¸€ä¸‹ src/config.rsï¼š</p><pre><code class=\"language-rust\">#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub struct ServerConfig {\n    pub general: GeneralConfig,\n    pub storage: StorageConfig,\n    pub tls: ServerTlsConfig,\n    pub log: LogConfig,\n}\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub struct LogConfig {\n    pub path: String,\n    pub rotation: RotationConfig,\n}\n\n#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]\npub enum RotationConfig {\n    Hourly,\n    Daily,\n    Never,\n}\n</code></pre><p>ä½ è¿˜éœ€è¦æ›´æ–° examples/gen_config.rsã€‚ç›¸å…³çš„æ”¹å˜å¯ä»¥çœ‹ repo ä¸‹çš„ diff_loggingã€‚<br>\ntracing å’Œ opentelemetry è¿˜æ”¯æŒ <a href=\"https://github.com/prometheus/prometheus\">prometheus</a>ï¼Œä½ å¯ä»¥ä½¿ç”¨ <a href=\"https://docs.rs/opentelemetry-prometheus\">opentelemetry-prometheus</a> æ¥å’Œ prometheus äº¤äº’ï¼Œå¦‚æœæœ‰å…´è¶£ï¼Œä½ å¯ä»¥è‡ªå·±æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚</p><h2>CI/CD</h2><p>ä¸ºäº†è®²è¿°æ–¹ä¾¿ï¼Œæˆ‘æŠŠ CI/CD æ”¾åœ¨æœ€åï¼Œä½† CI/CD åº”è¯¥æ˜¯åœ¨ä¸€å¼€å§‹çš„æ—¶å€™å°±å¦¥å–„è®¾ç½®çš„ã€‚</p><p>å…ˆè¯´CIå§ã€‚è¿™ä¸ªè¯¾ç¨‹çš„ repo <a href=\"https://github.com/tyrchen/geektime-rust\">tyrchen/geektime-rust</a> åœ¨ä¸€å¼€å§‹å°±è®¾ç½®äº† github actionï¼Œæ¯æ¬¡ commit éƒ½ä¼šè¿è¡Œï¼š</p><ul>\n<li>ä»£ç æ ¼å¼æ£€æŸ¥ï¼šcargo fmt</li>\n<li>ä¾èµ– license æ£€æŸ¥ï¼šcargo deny</li>\n<li>lintingï¼šcargo check å’Œ cargo clippy</li>\n<li>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼šcargo test</li>\n<li>ç”Ÿæˆæ–‡æ¡£ï¼šcargo doc</li>\n</ul><p>github action é…ç½®å¦‚ä¸‹ï¼Œä¾›ä½ å‚è€ƒï¼š</p><pre><code class=\"language-yaml\">name: build\n\non:\n  push:\n    branches:\n      - master\n  pull_request:\n    branches:\n      - master\n\njobs:\n  build-rust:\n    strategy:\n      matrix:\n        platform: [ubuntu-latest, windows-latest]\n    runs-on: ${{ matrix.platform }}\n    steps:\n      - uses: actions/checkout@v2\n      - name: Cache cargo registry\n        uses: actions/cache@v1\n        with:\n          path: ~/.cargo/registry\n          key: ${{ runner.os }}-cargo-registry\n      - name: Cache cargo index\n        uses: actions/cache@v1\n        with:\n          path: ~/.cargo/git\n          key: ${{ runner.os }}-cargo-index\n      - name: Cache cargo build\n        uses: actions/cache@v1\n        with:\n          path: target\n          key: ${{ runner.os }}-cargo-build-target\n      - name: Install stable\n        uses: actions-rs/toolchain@v1\n        with:\n          profile: minimal\n          toolchain: stable\n          override: true\n      - name: Check code format\n        run: cargo fmt -- --check\n      - name: Check the package for errors\n        run: cargo check --all\n      - name: Lint rust sources\n        run: cargo clippy --all-targets --all-features --tests --benches -- -D warnings\n      - name: Run tests\n        run: cargo test --all-features -- --test-threads=1 --nocapture\n      - name: Generate docs\n        run: cargo doc --all-features --no-deps\n      - name: Deploy docs to gh-page\n        uses: peaceiris/actions-gh-pages@v3\n        with:\n          github_token: ${{ secrets.GITHUB_TOKEN }}\n          publish_dir: ./target/doc\n</code></pre><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ¯æ¬¡ push tag æ—¶åš releaseï¼š</p><pre><code class=\"language-yaml\">name: release\n\non:\n  push:\n    tags:\n      - \"v*\" # Push events to matching v*, i.e. v1.0, v20.15.10\n\njobs:\n  build:\n    name: Upload Release Asset\n    runs-on: ${{ matrix.os }}\n    strategy:\n      matrix:\n        os: [ubuntu-latest]\n    steps:\n      - name: Cache cargo registry\n        uses: actions/cache@v1\n        with:\n          path: ~/.cargo/registry\n          key: ${{ runner.os }}-cargo-registry\n      - name: Cache cargo index\n        uses: actions/cache@v1\n        with:\n          path: ~/.cargo/git\n          key: ${{ runner.os }}-cargo-index\n      - name: Cache cargo build\n        uses: actions/cache@v1\n        with:\n          path: target\n          key: ${{ runner.os }}-cargo-build-target\n      - name: Checkout code\n        uses: actions/checkout@v2\n        with:\n          token: ${{ secrets.GH_TOKEN }}\n          submodules: recursive\n      - name: Build project\n        run: |\n          make build-release\n      - name: Create Release\n        id: create_release\n        uses: actions/create-release@v1\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n        with:\n          tag_name: ${{ github.ref }}\n          release_name: Release ${{ github.ref }}\n          draft: false\n          prerelease: false\n      - name: Upload asset\n        id: upload-kv-asset\n        uses: actions/upload-release-asset@v1\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n        with:\n          upload_url: ${{ steps.create_release.outputs.upload_url }}\n          asset_path: ./target/release/kvs\n          asset_name: kvs\n          asset_content_type: application/octet-stream\n      - name: Set env\n        run: echo \"RELEASE_VERSION=${GITHUB_REF#refs/*/}\" &gt;&gt; $GITHUB_ENV\n      - name: Deploy docs to gh-page\n        uses: peaceiris/actions-gh-pages@v3\n        with:\n          github_token: ${{ secrets.GITHUB_TOKEN }}\n          publish_dir: ./target/doc/simple_kv\n          destination_dir: ${{ env.RELEASE_VERSION }}\n</code></pre><p>è¿™æ ·ï¼Œæ¯æ¬¡ push tag æ—¶ï¼Œéƒ½å¯ä»¥æ‰“åŒ…å‡ºæ¥ Linux çš„ kvs ç‰ˆæœ¬ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/1c/19/1c61b7f58dd176bd25a565577d75af19.png?wh=2000x853\" alt=\"\"></p><p>å¦‚æœä½ ä¸å¸Œæœ›ç›´æ¥ä½¿ç”¨ç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶ï¼Œä¹Ÿå¯ä»¥æ‰“åŒ…æˆ dockerï¼Œåœ¨ Kubernetes ä¸‹ä½¿ç”¨ã€‚</p><p><strong>åœ¨åš CI çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è§¦å‘ CD</strong>ï¼Œæ¯”å¦‚ï¼š</p><ul>\n<li>PR merge åˆ° masterï¼Œåœ¨ build å®Œæˆåï¼Œè§¦å‘ dev æœåŠ¡å™¨çš„éƒ¨ç½²ï¼Œå›¢é˜Ÿå†…éƒ¨å¯ä»¥å°è¯•ï¼›</li>\n<li>å¦‚æœ release tag åŒ…å« alphaï¼Œåœ¨ build å®Œæˆåï¼Œè§¦å‘ staging æœåŠ¡å™¨çš„éƒ¨ç½²ï¼Œå…¬å¸å†…éƒ¨å¯ä»¥ä½¿ç”¨ï¼›</li>\n<li>å¦‚æœ release tag åŒ…å« betaï¼Œåœ¨ build å®Œæˆåï¼Œè§¦å‘ beta æœåŠ¡å™¨çš„éƒ¨ç½²ï¼Œbeta ç”¨æˆ·å¯ä»¥ä½¿ç”¨ï¼›</li>\n<li>æ­£å¼çš„ release tag ä¼šè§¦å‘ç”Ÿäº§ç¯å¢ƒçš„æ»šåŠ¨å‡çº§ï¼Œå‡çº§è¦†ç›–åˆ°çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ã€‚</li>\n</ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ¯å®¶ä¼ä¸šéƒ½æœ‰è‡ªå·±çš„ CI/CD çš„å·¥å…·é“¾ï¼Œè¿™é‡Œä¸ºäº†å±•ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ github action å¯¹ Rust ä»£ç åš CIï¼Œä½ å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€è¦æ¥å¤„ç†ã€‚</p><p>åœ¨åˆšæ‰çš„ action ä»£ç ä¸­ï¼Œè¿˜ç¼–è¯‘å¹¶ä¸Šä¼ äº†æ–‡æ¡£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ github pages å¾ˆæ–¹ä¾¿åœ°è®¿é—®æ–‡æ¡£ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/88/a7/885d092273f8cacda1a65867a2489ea7.png?wh=2000x1563\" alt=\"\"></p><h2>å°ç»“</h2><p>æˆ‘ä»¬çš„ KV server ä¹‹æ—…å°±åˆ°æ­¤ä¸ºæ­¢äº†ã€‚åœ¨æ•´æ•´ 7 å ‚è¯¾é‡Œï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹ä»é›¶æ„é€ äº†ä¸€ä¸ªå®Œæ•´çš„ KV serverï¼ŒåŒ…æ‹¬æ³¨é‡Šåœ¨å†…ï¼Œæ’°å†™äº†è¿‘ä¸‰åƒè¡Œä»£ç ï¼š</p><pre><code class=\"language-bash\">â¯ tokei .\n-------------------------------------------------------------------------------\n Language            Files        Lines         Code     Comments       Blanks\n-------------------------------------------------------------------------------\n Makefile                1           24           16            1            7\n Markdown                1            7            7            0            0\n Protocol Buffers        1          119           79           23           17\n Rust                   25         3366         2730          145          491\n TOML                    2          268          107          142           19\n-------------------------------------------------------------------------------\n Total                  30         3784         2939          311          534\n-------------------------------------------------------------------------------\n</code></pre><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸äº†ä¸èµ·çš„æˆå°±ï¼æˆ‘ä»¬åº”è¯¥ä¸ºè‡ªå·±æ„Ÿåˆ°è‡ªè±ªï¼</p><p>åœ¨è¿™ä¸ªç³»åˆ—é‡Œï¼Œæˆ‘ä»¬å¤§é‡ä½¿ç”¨ trait å’Œæ³›å‹ï¼Œæ„å»ºäº†å¾ˆå¤šå¤æ‚çš„æ•°æ®ç»“æ„ï¼›è¿˜ä¸ºè‡ªå·±çš„ç±»å‹å®ç°äº† AsyncRead / AsyncWrite / Stream / Sink è¿™äº›æ¯”è¾ƒé«˜é˜¶çš„ traitã€‚é€šè¿‡è‰¯å¥½çš„è®¾è®¡ï¼Œæˆ‘ä»¬æŠŠç½‘ç»œå±‚å’Œä¸šåŠ¡å±‚åˆ’åˆ†åœ°éå¸¸æ¸…æ™°ï¼Œç½‘ç»œå±‚çš„å˜åŒ–ä¸ä¼šå½±å“åˆ°ä¸šåŠ¡å±‚ï¼Œåä¹‹äº¦ç„¶ï¼š<br>\n<img src=\"https://static001.geekbang.org/resource/image/53/f3/53f5e5cf68b4300c3231885b10c784f3.jpeg?wh=2312x1379\" alt=\"\"></p><p>æˆ‘ä»¬è¿˜æ¨¡æ‹Ÿäº†æ¯”è¾ƒçœŸå®çš„å¼€å‘åœºæ™¯ï¼Œé€šè¿‡å¤§çš„éœ€æ±‚å˜æ›´ï¼Œå¼•å‘äº†ä¸€æ¬¡ä¸å°çš„ä»£ç é‡æ„ã€‚</p><p>æœ€ç»ˆï¼Œé€šè¿‡æ€§èƒ½æµ‹è¯•ï¼Œå‘ç°äº†ä¸€ä¸ªå®¢æˆ·ç«¯å®ç°çš„å° bugã€‚åœ¨å¤„ç†è¿™ä¸ª bug çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¬£å–œåœ°çœ‹åˆ°ï¼ŒRust æœ‰ç€éå¸¸å¼ºå¤§çš„æµ‹è¯•å·¥å…·é“¾ï¼Œé™¤äº†æˆ‘ä»¬ä½¿ç”¨çš„å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ï¼ŒRust è¿˜æ”¯æŒæ¨¡ç³Šæµ‹è¯•ï¼ˆfuzzy testingï¼‰å’ŒåŸºäºç‰¹æ€§çš„æµ‹è¯•ï¼ˆproperty testingï¼‰ã€‚</p><p>å¯¹äºæµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°çš„é—®é¢˜ï¼ŒRust æœ‰ç€éå¸¸å®Œå–„çš„ tracing å·¥å…·é“¾ï¼Œå¯ä»¥å’Œæ•´ä¸ª opentelemetry ç”Ÿæ€ç³»ç»Ÿï¼ˆåŒ…æ‹¬ jaegerã€prometheus ç­‰å·¥å…·ï¼‰æ‰“é€šã€‚æˆ‘ä»¬å°±æ˜¯é€šè¿‡ä½¿ç”¨ jaeger æ‰¾åˆ°å¹¶è§£å†³äº†é—®é¢˜ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRust tracing å·¥å…·é“¾è¿˜æ”¯æŒç”Ÿæˆ <a href=\"https://github.com/tokio-rs/tracing/tree/master/tracing-flame\">flamegraph</a>ï¼Œç¯‡å¹…å…³ç³»ï¼Œæ²¡æœ‰æ¼”ç¤ºï¼Œä½ æ„Ÿå…´è¶£çš„è¯å¯ä»¥è¯•è¯•ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬å®Œå–„äº† KV server çš„é…ç½®ã€æ—¥å¿—ä»¥åŠ CIã€‚å®Œæ•´çš„ä»£ç æˆ‘æ”¾åœ¨äº† <a href=\"http://github.com/tyrchen/simple-kv\">github.com/tyrchen/simple-kv</a> ä¸Šï¼Œæ¬¢è¿æŸ¥çœ‹æœ€ç»ˆçš„ç‰ˆæœ¬ã€‚</p><p>å¸Œæœ›é€šè¿‡è¿™ä¸ªç³»åˆ—ï¼Œä½ å¯¹å¦‚ä½•ä½¿ç”¨ Rust çš„ç‰¹æ€§æ¥æ„é€ åº”ç”¨ç¨‹åºæœ‰äº†æ·±åº¦çš„è®¤è¯†ã€‚æˆ‘ç›¸ä¿¡ï¼Œå¦‚æœä½ èƒ½å¤Ÿè·Ÿå¾—ä¸Šè¿™ä¸ªç³»åˆ—çš„èŠ‚å¥ï¼Œå¦å¤–å¦‚æœé‡åˆ°æ–°çš„åº“ï¼Œç”¨<a href=\"https://time.geekbang.org/column/article/424017\">ç¬¬ 20 è®²</a>é˜…è¯»ä»£ç çš„æ–¹å¼å¿«é€ŸæŒæ¡ï¼Œé‚£ä¹ˆï¼Œå¤§éƒ¨åˆ† Rust å¼€å‘ä¸­çš„æŒ‘æˆ˜ï¼Œå¯¹ä½ è€Œè¨€éƒ½ä¸æ˜¯éš¾äº‹ã€‚</p><h3>æ€è€ƒé¢˜</h3><p>æˆ‘ä»¬ç›®å‰å¹¶æœªå¯¹æ—¥å¿—åšä»»ä½•é…ç½®ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ€ä¹ˆåšæ—¥å¿—ï¼Œä¼šæœ‰ç›¸åº”çš„å¼€å…³ä»¥åŠæ—¥å¿—çº§åˆ«ï¼Œå¦‚æœå¸Œæœ›èƒ½é€šè¿‡å¦‚ä¸‹çš„é…ç½®è®°å½•æ—¥å¿—ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿè¯•è¯•çœ‹ï¼š</p><pre><code class=\"language-rust\">[log]\nenable_log_file = true\nenable_jaeger = false\nlog_level = 'info'\npath = '/tmp/kv-log'\nrotation = 'Daily'\n</code></pre><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«è‡ªå·±åš KV server ç³»åˆ—çš„æƒ³æ³•å’Œæ„Ÿæ‚Ÿã€‚ä½ å·²ç»å®Œæˆäº†ç¬¬45æ¬¡æ‰“å¡ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":326056,"user_name":"Rayjun","can_delete":false,"product_type":"c1","uid":1002514,"ip_address":"","ucode":"61A3D1A3D03569","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4c/12/f0c145d4.jpg","comment_is_top":false,"comment_ctime":1639356813,"is_pvip":true,"replies":[{"id":"118809","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639804494,"ip_address":"","comment_id":326056,"utype":1}],"discussion_count":2,"race_medal":0,"score":"44589029773","product_id":100085301,"comment_content":"è€å¸ˆçš„å·¥ç¨‹åº•å­æ˜¯çœŸçš„åšï¼Œæˆ‘æ„Ÿè§‰æ•´ä¸ªè¯¾ç¨‹ä¸‹æ¥ï¼Œå­¦ rust æ˜¯å…¶æ¬¡ï¼Œæ›´é‡è¦çš„æ˜¯å­¦åˆ°äº†è€å¸ˆåšå·¥ç¨‹çš„æ–¹æ³•ï¼Œå¤ªæ£’äº†","like_count":10,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539682,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639804494,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1023085,"avatar":"","nickname":"å®‰è¿ª","note":"","ucode":"BC23EA989E0A4C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538248,"discussion_content":"æœ‰åŒæ„Ÿï¼Œè€å¸ˆé«˜å±‹å»ºç“´ï¼Œä»‹ç»äº†è¯­è¨€å’Œè½¯ä»¶æ¶æ„çš„å„ç§æ–¹æ³•ã€‚å—ç›ŠåŒªæµ…ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639381836,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326180,"user_name":"ä¹Œé¾™çŒ¹","can_delete":false,"product_type":"c1","uid":2739949,"ip_address":"","ucode":"43F94A0DEC54BE","user_header":"https://static001.geekbang.org/account/avatar/00/29/ce/ed/3dbe915b.jpg","comment_is_top":false,"comment_ctime":1639406988,"is_pvip":false,"replies":[{"id":"118802","content":"åŠ æ²¹ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639804341,"ip_address":"","comment_id":326180,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23114243468","product_id":100085301,"comment_content":"è¿™ç¡®å®æ˜¯ Rust ç¼–ç¨‹çš„ç¬¬ä¸€è¯¾   ä½†ç¡®æ˜¯æ¯ä¸€ä¸ªåŠ¡å®ç¨‹åºå‘˜çš„å¿…ä¿®è¯¾  åœ¨åšä¸€é¡¹å·¥ç¨‹æ—¶ï¼Œè€å¸ˆçš„æ€ç»´æ–¹å¼æ‹†è§£é—®é¢˜çš„æ–¹æ³•éƒ½æ¯«æ— ä¿ç•™çš„åˆ†äº«å‡ºæ¥   å€¼å¾—æˆ‘ä»¬åå¤å»é˜…è¯»  åå¤ç†è§£    ç­‰ä»€ä¹ˆæ—¶å€™èƒ½è¾¾åˆ°èä¼šè´¯é€š ä¸¾ä¸€åä¸‰çš„æ—¶å€™  é‚£æ—¶å€™å°±ç¦» 300k çš„ package ä¸è¿œäº† ","like_count":5,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539675,"discussion_content":"åŠ æ²¹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639804341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326478,"user_name":"å´äº‘é˜","can_delete":false,"product_type":"c1","uid":1224039,"ip_address":"","ucode":"21089FBAFBF61D","user_header":"https://static001.geekbang.org/account/avatar/00/12/ad/67/8563a71f.jpg","comment_is_top":false,"comment_ctime":1639538318,"is_pvip":false,"replies":[{"id":"118793","content":"è°¢è°¢ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639803767,"ip_address":"","comment_id":326478,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18819407502","product_id":100085301,"comment_content":"è¿™èŠ‚è¯¾çš„å†…å®¹ä¸ä»…ä»…æ˜¯rustç¼–ç¨‹ï¼Œæ›´æ˜¯æ¯«æ— ä¿ç•™çš„åˆ†äº«å·¥ç¨‹æ–¹æ³•ã€‚è€å¸ˆä¸ä»…ä»…æ˜¯ä¸€ä¸ªæå…¶ä¼˜ç§€çš„å·¥ç¨‹å¸ˆï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæå…¶ä¼˜ç§€çš„æ•™å­¦è€…ã€‚éå¸¸å€¼å¾—å­¦ä¹ ã€‚","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539666,"discussion_content":"è°¢è°¢ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639803767,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326043,"user_name":"yyxxccc","can_delete":false,"product_type":"c1","uid":2759441,"ip_address":"","ucode":"BEC53F4F4922B8","user_header":"https://static001.geekbang.org/account/avatar/00/2a/1b/11/5e235665.jpg","comment_is_top":false,"comment_ctime":1639326307,"is_pvip":false,"replies":[{"id":"118807","content":"åŠ æ²¹ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639804400,"ip_address":"","comment_id":326043,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18819195491","product_id":100085301,"comment_content":"çœ‹åˆ°300kçš„pkgï¼Œåˆå¢åŠ äº†æŒç»­åå¤å•ƒçš„åŠ¨åŠ›ğŸ˜‚","like_count":4,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539680,"discussion_content":"åŠ æ²¹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639804400,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338851,"user_name":"å•¦å•¦å•¦å•¦å•¦å•¦å•¦","can_delete":false,"product_type":"c1","uid":1470066,"ip_address":"","ucode":"220DC1DF76454F","user_header":"https://static001.geekbang.org/account/avatar/00/16/6e/72/f8e5b97e.jpg","comment_is_top":false,"comment_ctime":1647762870,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5942730166","product_id":100085301,"comment_content":"æƒ³é—®ä¸‹è€å¸ˆåœ¨è·‘ æ€§èƒ½æµ‹è¯•åœ¨ macä¸‹ ä¸ä¼šæŠ›å‡º `Too many open files (os error 24)` é”™è¯¯å—","like_count":1,"discussions":[{"author":{"id":2912722,"avatar":"","nickname":"æ–°æ–°äººç±»","note":"","ucode":"97EACC93996CCB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572404,"discussion_content":"æˆ‘ä¹Ÿé‡åˆ°äº†..","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652771946,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326149,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1639394735,"is_pvip":false,"replies":[{"id":"118805","content":"è°¢è°¢ :)","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639804380,"ip_address":"","comment_id":326149,"utype":1}],"discussion_count":1,"race_medal":2,"score":"5934362031","product_id":100085301,"comment_content":"å®æ“é¡¹ç›® 120 åˆ†ï¼Œæˆ‘è¦æŠ½å‡ºè¿ç»­æ—¶é—´å¥½å¥½å®Œæˆè¿™ä¸ªé¡¹ç›®ï¼Œè¯¥ä¸“æ çœŸçš„å€¼å¾—çœ‹åéã€‚","like_count":1,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539678,"discussion_content":"è°¢è°¢ :)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639804380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359607,"user_name":"è¿›å‡»çš„Lancelot","can_delete":false,"product_type":"c1","uid":2620407,"ip_address":"å¹¿ä¸œ","ucode":"3BCC355801DC61","user_header":"https://static001.geekbang.org/account/avatar/00/27/fb/f7/88ab6f83.jpg","comment_is_top":false,"comment_ctime":1665674351,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1665674351","product_id":100085301,"comment_content":"æ€è€ƒé¢˜å®ç°ï¼šhttps:&#47;&#47;play.rust-lang.org&#47;?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=d6037374ea479690681fecf425424cbb<br>","like_count":0},{"had_liked":false,"id":326048,"user_name":"æ¥ æ¥ å˜»å˜»","can_delete":false,"product_type":"c1","uid":1503202,"ip_address":"","ucode":"3B99180DD8501D","user_header":"https://static001.geekbang.org/account/avatar/00/16/ef/e2/df2a1823.jpg","comment_is_top":false,"comment_ctime":1639350631,"is_pvip":false,"replies":[{"id":"118808","content":":)","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1079375","ctime":1639804409,"ip_address":"","comment_id":326048,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639350631","product_id":100085301,"comment_content":"ç¡®å®å‰å®³ï¼çœŸçš„æ˜¯rust in actionï¼","like_count":0,"discussions":[{"author":{"id":1079375,"avatar":"https://static001.geekbang.org/account/avatar/00/10/78/4f/e74f870c.jpg","nickname":"Tyr","note":"","ucode":"EAAFC8063202E0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539681,"discussion_content":":)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639804409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}