{"id":126872,"title":"40 | ç¼“å­˜ä¸é£æš´å¹¶å­˜ï¼Œè°è¯´ç¼“å­˜é£æš´ä¸å¯é¿å…ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>åœ¨å‰é¢ç¼“å­˜çš„é‚£èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä¸ºä½ ä»‹ç»äº†ï¼Œå…±äº«å­—å…¸å’Œ lru ç¼“å­˜åœ¨é«˜æ€§èƒ½æ–¹é¢çš„ä¸€äº›ä¼˜åŒ–æŠ€å·§ã€‚å…¶å®ï¼Œæˆ‘ä»¬è¿˜é—ç•™äº†ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼Œä¹Ÿå€¼å¾—æˆ‘ä»¬ä»Šå¤©ç”¨å•ç‹¬çš„ä¸€èŠ‚è¯¾æ¥ä»‹ç»ï¼Œé‚£å°±æ˜¯â€œç¼“å­˜é£æš´â€ã€‚</p><h2>ä»€ä¹ˆæ˜¯ç¼“å­˜é£æš´ï¼Ÿ</h2><p>ä»€ä¹ˆæ˜¯ç¼“å­˜é£æš´å‘¢ï¼Ÿè®©æˆ‘ä»¬å…ˆæ¥è®¾æƒ³ä¸‹é¢è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ã€‚</p><p>æ•°æ®æºåœ¨ MySQL æ•°æ®åº“ä¸­ï¼Œç¼“å­˜çš„æ•°æ®æ”¾åœ¨å…±äº«å­—å…¸ä¸­ï¼Œè¶…æ—¶æ—¶é—´ä¸º 60 ç§’ã€‚åœ¨è¿™ 60 ç§’å†…çš„æ—¶é—´é‡Œï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼ŒMySQL æ²¡æœ‰ä»»ä½•çš„å‹åŠ›ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦åˆ°è¾¾ 60 ç§’ï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜æ•°æ®å¤±æ•ˆçš„é‚£ä¸€åˆ»ï¼Œå¦‚æœæ­£å¥½æœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚è¿›æ¥ï¼Œåœ¨ç¼“å­˜ä¸­æ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œå°±è¦è§¦å‘æŸ¥è¯¢æ•°æ®æºçš„å‡½æ•°ï¼Œé‚£ä¹ˆè¿™äº›è¯·æ±‚å…¨éƒ¨éƒ½å°†å»æŸ¥è¯¢ MySQL æ•°æ®åº“ï¼Œç›´æ¥é€ æˆæ•°æ®åº“æœåŠ¡å™¨å¡é¡¿ï¼Œç”šè‡³å¡æ­»ã€‚</p><p>è¿™ç§ç°è±¡å°±å«åšâ€œç¼“å­˜é£æš´â€ï¼Œå®ƒä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„è‹±æ–‡åå­—<code>Dog-Pile</code>ã€‚å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬ä¹‹å‰å‡ºç°çš„ç¼“å­˜ç›¸å…³çš„ä»£ç ï¼Œéƒ½æ²¡æœ‰åšè¿‡å¯¹åº”çš„å¤„ç†ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œå°±æ˜¯æœ‰ç¼“å­˜é£æš´éšæ‚£çš„ä¼ªä»£ç ï¼š</p><pre><code>local value = get_from_cache(key)\nif not value then\n    value = query_db(sql)\n    set_to_cache(value, timeout ï¼ 60)\nend\nreturn value\n</code></pre><p>è¿™æ®µä¼ªä»£ç çœ‹ä¸Šå»é€»è¾‘éƒ½æ˜¯æ­£å¸¸çš„ï¼Œä½ ä½¿ç”¨å•å…ƒæµ‹è¯•æˆ–è€…ç«¯å¯¹ç«¯æµ‹è¯•ï¼Œéƒ½ä¸ä¼šè§¦å‘ç¼“å­˜é£æš´ã€‚åªæœ‰é•¿æ—¶é—´çš„å‹åŠ›æµ‹è¯•æ‰ä¼šå‘ç°è¿™ä¸ªé—®é¢˜ï¼Œæ¯éš” 60 ç§’çš„æ—¶é—´ï¼Œæ•°æ®åº“å°±ä¼šå‡ºç°ä¸€æ¬¡æŸ¥è¯¢çš„å³°å€¼ï¼Œéå¸¸æœ‰è§„å¾‹ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ è¿™é‡Œçš„ç¼“å­˜å¤±æ•ˆæ—¶é—´è®¾ç½®å¾—æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆç¼“å­˜é£æš´é—®é¢˜è¢«å‘ç°çš„å‡ ç‡å°±ä¼šé™ä½ã€‚</p><!-- [[[read_end]]] --><h2>å¦‚ä½•é¿å…ç¼“å­˜é£æš´ï¼Ÿ</h2><p>ç°åœ¨æ˜ç™½äº†ä»€ä¹ˆæ˜¯ç¼“å­˜é£æš´ï¼Œæˆ‘ä»¬çš„ä¸‹ä¸€æ­¥å°±æ˜¯è¦ææ¸…æ¥šå¦‚ä½•é¿å…å®ƒäº†ã€‚ä¸‹é¢ï¼Œè®©æˆ‘ä»¬åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„æƒ…å†µæ¥è®¨è®ºä¸€ä¸‹ã€‚</p><h3>ä¸»åŠ¨æ›´æ–°ç¼“å­˜</h3><p>åœ¨ä¸Šé¢çš„ä¼ªä»£ç ä¸­ï¼Œç¼“å­˜æ˜¯è¢«åŠ¨æ›´æ–°çš„ã€‚åªæœ‰åœ¨ç»ˆç«¯è¯·æ±‚å‘ç°ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œå®ƒæ‰ä¼šå»æ•°æ®åº“æŸ¥è¯¢æ–°çš„æ•°æ®ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬æŠŠç¼“å­˜çš„æ›´æ–°ï¼Œä»è¢«åŠ¨æ”¹ä¸ºä¸»åŠ¨ï¼Œä¹Ÿå°±å¯ä»¥ç›´æ¥ç»•å¼€ç¼“å­˜é£æš´çš„é—®é¢˜äº†ã€‚</p><p>åœ¨ OpenResty ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥å®ç°ã€‚é¦–å…ˆï¼Œä½¿ç”¨ <code>ngx.timer.every</code> æ¥åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼Œå» MySQL æ•°æ®åº“ä¸­è·å–æœ€æ–°çš„æ•°æ®ï¼Œå¹¶æ”¾å…¥å…±äº«å­—å…¸ä¸­:</p><pre><code>local function query_db(premature, sql)\n    local value = query_db(sql)\n    set_to_cache(value, timeout ï¼ 60)\nend\n\nlocal ok, err = ngx.timer.every(60, query_db, sql)\n</code></pre><p>ç„¶åï¼Œåœ¨ç»ˆç«¯è¯·æ±‚çš„ä»£ç é€»è¾‘ä¸­ï¼Œå»æ‰æŸ¥è¯¢ MySQL çš„éƒ¨åˆ†ï¼Œåªä¿ç•™è·å–å…±äº«å­—å…¸ç¼“å­˜çš„ä»£ç ï¼š</p><pre><code>local value = get_from_cache(key)\nreturn value\n</code></pre><p>é€šè¿‡è¿™æ ·ä¸¤æ®µä¼ªç çš„æ“ä½œï¼Œç¼“å­˜é£æš´çš„é—®é¢˜å°±è¢«ç»•è¿‡å»äº†ã€‚ä½†è¿™ç§æ–¹å¼ä¹Ÿå¹¶éå®Œç¾ï¼Œå› ä¸ºè¿™æ ·çš„æ¯ä¸€ä¸ªç¼“å­˜éƒ½è¦å¯¹åº”ä¸€ä¸ªå‘¨æœŸæ€§çš„ä»»åŠ¡ï¼ˆOpenResty ä¸­ timer æ˜¯æœ‰ä¸Šé™çš„ï¼Œä¸èƒ½å¤ªå¤šï¼‰ï¼›è€Œä¸”ç¼“å­˜è¿‡æœŸæ—¶é—´å’Œè®¡åˆ’ä»»åŠ¡çš„å‘¨æœŸæ—¶é—´è¿˜è¦å¯¹åº”å¥½ï¼Œå¦‚æœè¿™ä¸­é—´å‡ºç°äº†ä»€ä¹ˆçº°æ¼ï¼Œç»ˆç«¯å°±å¯èƒ½ä¸€ç›´è·å–åˆ°çš„éƒ½æ˜¯ç©ºæ•°æ®ã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨åŠ é”çš„æ–¹å¼æ¥è§£å†³ç¼“å­˜é£æš´é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä¸ºä½ è®²è§£å‡ ç§ä¸åŒçš„åŠ é”æ–¹å¼ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œé€‰æ‹©ã€‚</p><h3>lua-resty-lock</h3><p>æˆ‘çŸ¥é“ï¼Œä¸€æåˆ°åŠ é”ï¼Œå¾ˆå¤šäººå¯èƒ½ä¼šçœ‰å¤´ä¸€çš±ï¼Œè§‰å¾—è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„æ“ä½œã€‚è€Œä¸”ï¼Œå¦‚æœå‘ç”Ÿæ­»é”äº†è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™æ˜¾ç„¶è¿˜è¦å¤„ç†ä¸å°‘å¼‚å¸¸æƒ…å†µã€‚</p><p>ä½†æ˜¯ï¼Œä½¿ç”¨ OpenResty ä¸­çš„ <code>lua-resty-lock</code> è¿™ä¸ªåº“æ¥åŠ é”ï¼Œè¿™æ ·çš„æ‹…å¿ƒå°±å¤§å¯ä¸å¿…äº†ã€‚<code>lua-resty-lock</code> æ˜¯ OpenResty è‡ªå¸¦çš„ resty åº“ï¼Œå®ƒåº•å±‚æ˜¯åŸºäºå…±äº«å­—å…¸ï¼Œæä¾›éé˜»å¡çš„ lock APIã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p><pre><code>resty --shdict='locks 1m' -e 'local resty_lock = require &quot;resty.lock&quot;\n                            local lock, err = resty_lock:new(&quot;locks&quot;)\n                            local elapsed, err = lock:lock(&quot;my_key&quot;)\n                            -- query db and update cache\n                            local ok, err = lock:unlock()\n                            ngx.say(&quot;unlock: &quot;, ok)'\n</code></pre><p>å› ä¸º <code>lua-resty-lock</code> æ˜¯åŸºäºå…±äº«å­—å…¸æ¥å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦äº‹å…ˆå£°æ˜ shdict çš„åå­—å’Œå¤§å°ï¼›ç„¶åï¼Œå†ä½¿ç”¨ <code>new</code> æ–¹æ³•æ¥æ–°å»º lock å¯¹è±¡ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åªä¼ äº†ç¬¬ä¸€ä¸ªå‚æ•° <code>shdict</code> çš„åå­—ã€‚å…¶å®ï¼Œ <code>new</code> æ–¹æ³•è¿˜æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®šé”çš„è¿‡æœŸæ—¶é—´ã€ç­‰å¾…é”çš„è¶…æ—¶æ—¶é—´ç­‰å¤šä¸ªå‚æ•°ã€‚ä¸è¿‡è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é»˜è®¤å€¼ï¼Œå®ƒä»¬å°±æ˜¯ç”¨æ¥é¿å…æ­»é”ç­‰å„ç§å¼‚å¸¸é—®é¢˜çš„ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ <code>lock</code> æ–¹æ³•å°è¯•è·å–é”ã€‚å¦‚æœæˆåŠŸè·å–åˆ°é”çš„è¯ï¼Œé‚£å°±å¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ªè¯·æ±‚å»æ•°æ®æºæ›´æ–°æ•°æ®ï¼›è€Œå¦‚æœå› ä¸ºé”å·²ç»è¢«æŠ¢å ã€è¶…æ—¶ç­‰å¯¼è‡´åŠ é”å¤±è´¥ï¼Œé‚£å°±éœ€è¦ä»é™ˆæ—§çš„ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œè¿”å›ç»™ç»ˆç«¯ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸æ˜¯å¬èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™ï¼Œè¿™é‡Œå°±æ­£å¥½ç”¨åˆ°äº†æˆ‘ä»¬ä¸ŠèŠ‚è¯¾ä»‹ç»è¿‡çš„çš„ <code>get_stale</code> APIï¼š</p><pre><code>local elapsed, err = lock:lock(&quot;my_key&quot;)\n# elapsed ä¸º nil è¡¨ç¤ºåŠ é”å¤±è´¥ï¼Œerrçš„è¿”å›å€¼æ˜¯ timeoutã€ locked ä¸­çš„ä¸€ä¸ª\nif not elapsed and err then \n    dict:get_stale(&quot;my_key&quot;)\nend\n</code></pre><p>å¦‚æœ <code>lock</code> æˆåŠŸï¼Œé‚£ä¹ˆå°±å¯ä»¥å®‰å…¨åœ°å»æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶æŠŠç»“æœæ›´æ–°åˆ°ç¼“å­˜ä¸­ã€‚æœ€åï¼Œæˆ‘ä»¬å†è°ƒç”¨ <code>unlock</code> æ¥å£ï¼ŒæŠŠé”é‡Šæ”¾æ‰å°±å¯ä»¥äº†ã€‚</p><p>ç»“åˆ <code>lua-resty-lock</code> å’Œ <code>get_stale</code>ï¼Œæˆ‘ä»¬å°±å®Œç¾åœ°è§£å†³äº†ç¼“å­˜é£æš´çš„é—®é¢˜ã€‚åœ¨ <code>lua-resty-lock</code> çš„æ–‡æ¡£ä¸­ï¼Œç»™å‡ºäº†éå¸¸å®Œæ•´çš„å¤„ç†ä»£ç ï¼Œæ¨èä½ å¯ä»¥ç‚¹å‡»<a href=\"https://github.com/openresty/lua-resty-lock#for-cache-locks\">é“¾æ¥</a>æŸ¥çœ‹ã€‚</p><p>ä¸è¿‡ï¼Œæ¯å½“é‡åˆ°ä¸€äº›æœ‰è¶£çš„å®ç°ï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›èƒ½å¤Ÿçœ‹çœ‹å®ƒçš„æºç æ˜¯å¦‚ä½•å®ç°çš„ï¼Œè¿™ä¹Ÿæ˜¯å¼€æºçš„å¥½å¤„ä¹‹ä¸€ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å†æ·±å…¥ä¸€æ­¥ï¼Œçœ‹çœ‹ <code>lock</code> è¿™ä¸ªæ¥å£æ˜¯å¦‚ä½•åŠ é”çš„ï¼Œä¸‹é¢ä¾¿æ˜¯å®ƒçš„æºç ï¼š</p><pre><code>local ok, err = dict:add(key, true, exptime)\nif ok then\n    cdata.key_id = ref_obj(key)\n    self.key = key\n    return 0\nend\n</code></pre><p>åœ¨å…±äº«å­—å…¸ç« èŠ‚ä¸­ï¼Œæˆ‘æ›¾ç»æåˆ°è¿‡ï¼Œshared dict çš„æ‰€æœ‰ API éƒ½æ˜¯åŸå­æ“ä½œï¼Œä¸ç”¨æ‹…å¿ƒå‡ºç°ç«äº‰ï¼Œæ‰€ä»¥ç”¨ shared dict æ¥æ ‡è®°é”çš„çŠ¶æ€æ˜¯ä¸ªä¸é”™çš„ä¸»æ„ã€‚</p><p>è¿™é‡Œ <code>lock</code> æ¥å£çš„å®ç°ï¼Œä¾¿ä½¿ç”¨äº† <code>dict:add</code> æ¥å£æ¥å°è¯•è®¾ç½® keyã€‚å¦‚æœ key åœ¨å…±äº«å†…å­˜ä¸­ä¸å­˜åœ¨ï¼Œ<code>add</code> æ¥å£å°±ä¼šè¿”å›æˆåŠŸï¼Œè¡¨ç¤ºåŠ é”æˆåŠŸï¼›å…¶ä»–å¹¶å‘çš„è¯·æ±‚èµ°åˆ° <code>dict:add</code> è¿™ä¸€è¡Œçš„ä»£ç é€»è¾‘æ—¶ï¼Œå°±ä¼šè¿”å›å¤±è´¥ï¼Œç„¶åæ ¹æ®è¿”å›çš„ err ä¿¡æ¯ï¼Œé€‰æ‹©æ˜¯ç›´æ¥è¿”å›ï¼Œè¿˜æ˜¯å¤šæ¬¡é‡è¯•ã€‚</p><h3>lua-resty-shcache</h3><p>ä¸è¿‡ï¼Œåœ¨ä¸Šé¢ <code>lua-resty-lock</code> çš„å®ç°ä¸­ï¼Œä½ éœ€è¦è‡ªå·±æ¥å¤„ç†åŠ é”ã€è§£é”ã€è·å–è¿‡æœŸæ•°æ®ã€é‡è¯•ã€å¼‚å¸¸å¤„ç†ç­‰å„ç§é—®é¢˜ï¼Œè¿˜æ˜¯ç›¸å½“ç¹ççš„ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘å†ç»™ä½ ä»‹ç»ä¸€ä¸ªç®€å•çš„å°è£…ï¼š<code>lua-resty-shcache</code>ã€‚</p><p><code>lua-resty-shcache</code>æ˜¯ CloudFlare å¼€æºçš„ä¸€ä¸ª lua-resty åº“ï¼Œå®ƒåœ¨å…±äº«å­—å…¸å’Œå¤–éƒ¨å­˜å‚¨ä¹‹ä¸Šï¼Œåšäº†ä¸€å±‚å°è£…ï¼›å¹¶ä¸”é¢å¤–æä¾›äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ¥å£ï¼Œè®©ä½ ä¸ç”¨å»å…³å¿ƒä¸Šè¿°çš„å„ç§ç»†èŠ‚:</p><pre><code>local shcache = require(&quot;shcache&quot;)\n\nlocal my_cache_table = shcache:new(\n        ngx.shared.cache_dict\n        { external_lookup = lookup,\n          encode = cmsgpack.pack,\n          decode = cmsgpack.decode,\n        },\n        { positive_ttl = 10,           -- cache good data for 10s\n          negative_ttl = 3,            -- cache failed lookup for 3s\n          name = 'my_cache',     -- &quot;named&quot; cache, useful for debug / report\n        }\n    )\n\n    local my_table, from_cache = my_cache_table:load(key)\n</code></pre><p>è¿™æ®µç¤ºä¾‹ä»£ç æ‘˜è‡ªå®˜æ–¹çš„ç¤ºä¾‹ï¼Œä¸è¿‡ï¼Œæˆ‘å·²ç»æŠŠç»†èŠ‚éƒ½éšè—äº†ï¼Œæ–¹ä¾¿ä½ æ›´å¥½åœ°æŠŠæ¡é‡ç‚¹ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªç¼“å­˜å°è£…çš„åº“å¹¶éæ˜¯æˆ‘ä»¬çš„æœ€ä½³é€‰æ‹©ï¼Œä½†æ¯”è¾ƒé€‚åˆåˆå­¦è€…å»å­¦ä¹ ï¼Œæ‰€ä»¥æˆ‘é¦–å…ˆä»‹ç»çš„æ˜¯å®ƒã€‚åœ¨ä¸‹ä¸€èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä¼šç»™ä½ ä»‹ç»å…¶ä»–çš„å‡ ä¸ªæ›´å¥½ã€æ›´å¸¸ç”¨çš„å°è£…ï¼Œæ–¹ä¾¿æˆ‘ä»¬é€‰æ‹©æœ€åˆé€‚çš„æ¥ä½¿ç”¨ã€‚</p><h3>Nginx é…ç½®æŒ‡ä»¤</h3><p>å¦å¤–ï¼Œå³ä½¿ä½ æ²¡æœ‰ä½¿ç”¨ OpenResty çš„ lua-resty åº“ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ Nginx çš„é…ç½®æŒ‡ä»¤ï¼Œæ¥å®ç°åŠ é”å’Œè·å–è¿‡æœŸæ•°æ®â€”â€”å³<code>proxy_cache_lock</code> å’Œ <code>proxy_cache_use_stale</code>ã€‚ä¸è¿‡ï¼Œè¿™é‡Œæˆ‘å¹¶ä¸æ¨èä½¿ç”¨ Nginx æŒ‡ä»¤è¿™ç§æ–¹å¼ï¼Œå®ƒæ˜¾ç„¶ä¸å¤Ÿçµæ´»ï¼Œæ€§èƒ½ä¹Ÿæ¯”ä¸ä¸Š Lua ä»£ç ã€‚</p><h2>å†™åœ¨æœ€å</h2><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä¸»è¦ä¸ºä½ ä»‹ç»äº†ç¼“å­˜é£æš´å’Œç›¸åº”çš„å‡ ç§åº”å¯¹æ–¹å¼ã€‚ä¸å¾—ä¸è¯´ï¼Œç¼“å­˜é£æš´ï¼Œå’Œä¹‹å‰æˆ‘ä»¬åå¤æåˆ°çš„ race é—®é¢˜ä¸€æ ·ï¼Œé€šè¿‡ code review å’Œæµ‹è¯•éƒ½å¾ˆéš¾è¢«å‘ç°ï¼Œæœ€å¥½çš„æ–¹æ³•è¿˜æ˜¯æå‡æˆ‘ä»¬æœ¬èº«çš„ç¼–ç æ°´å¹³ï¼Œæˆ–è€…ä½¿ç”¨å°è£…å¥½çš„ç±»åº“æ¥è§£å†³è¿™ç±»é—®é¢˜ã€‚</p><p>æœ€åï¼Œç»™ä½ ç•™ä¸€ä¸ªä½œä¸šé¢˜ã€‚åœ¨ä½ ç†Ÿæ‚‰çš„è¯­è¨€å’Œå¹³å°ä¸­ï¼Œéƒ½æ˜¯å¦‚ä½•å¤„ç†ç¼“å­˜é£æš´ä¹‹ç±»é—®é¢˜çš„å‘¢ï¼Ÿæ˜¯å¦æœ‰æ¯” OpenResty æ›´å¥½çš„è§£å†³æ€æƒ³å’Œæ–¹æ³•å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€å’Œæˆ‘è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹æœ‹å‹ï¼Œä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"39 | é«˜æ€§èƒ½çš„å…³é”®ï¼šshared dict ç¼“å­˜å’Œ lru ç¼“å­˜","id":120834},"right":{"article_title":"41 | lua-resty-* å°è£…ï¼Œè®©ä½ è¿œç¦»å¤šçº§ç¼“å­˜ä¹‹ç—›","id":128131}},"comments":[{"had_liked":false,"id":268204,"user_name":"Geek_30e248","can_delete":false,"product_type":"c1","uid":2349433,"ip_address":"","ucode":"19AEF347F88BE8","user_header":"","comment_is_top":false,"comment_ctime":1608100768,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5903068064","product_id":100028301,"comment_content":"è§£å†³ç¼“å­˜é£æš´ï¼šç»™ttlåŠ ä¸€ä¸ªéšæœºçš„èŒƒå›´å€¼ï¼Œè¿™æ ·å¯ä»¥æå¤§é™ä½ç¼“å­˜é›†ä¸­å¤±æ•ˆçš„æ¦‚ç‡ï¼Œä»è€Œé¿å…ç¼“å­˜é£æš´","like_count":1},{"had_liked":false,"id":128591,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1566909823,"is_pvip":false,"replies":[{"id":"49070","content":"è¿™é‡Œæœ‰å¾ˆå¤š https:&#47;&#47;github.com&#47;bungle&#47;awesome-resty#web-frameworksï¼Œä½†éƒ½ä¸æµè¡ŒğŸ˜¢","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567587788,"ip_address":"","comment_id":128591,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5861877119","product_id":100028301,"comment_content":"è€å¸ˆï¼Œæœ‰æ²¡æœ‰å†™restful apiçš„åç«¯æ¡†æ¶æ¨èï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465012,"discussion_content":"è¿™é‡Œæœ‰å¾ˆå¤š https://github.com/bungle/awesome-resty#web-frameworksï¼Œä½†éƒ½ä¸æµè¡ŒğŸ˜¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567587788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128282,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1105161,"ip_address":"","ucode":"1EECCA0F43E278","user_header":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","comment_is_top":false,"comment_ctime":1566868356,"is_pvip":false,"replies":[{"id":"47624","content":"å› ä¸ºè¿™æ ·æœ€ç®€å•ç›´æ¥ï¼Œä½†å¹¶ä¸æ¨èã€‚ä¸€èˆ¬æˆ‘ä»¬æŠŠé‰´æƒçš„æ”¾åœ¨ access é˜¶æ®µï¼Œæ”¹å†™çš„æ”¾åœ¨ rewrite é˜¶æ®µï¼Œè¿™æ ·é€»è¾‘ä¸Šæ›´æ¸…æ™°ï¼Œåé¢ä¹Ÿå®¹æ˜“åšæ‹†åˆ†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1566888777,"ip_address":"","comment_id":128282,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5861835652","product_id":100028301,"comment_content":"è€å¸ˆï¼Œä¸ºä»€ä¹ˆå¾ˆå¤šorçš„webæ¡†æ¶åªåˆ©ç”¨content_by_luaé˜¶æ®µï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464878,"discussion_content":"å› ä¸ºè¿™æ ·æœ€ç®€å•ç›´æ¥ï¼Œä½†å¹¶ä¸æ¨èã€‚ä¸€èˆ¬æˆ‘ä»¬æŠŠé‰´æƒçš„æ”¾åœ¨ access é˜¶æ®µï¼Œæ”¹å†™çš„æ”¾åœ¨ rewrite é˜¶æ®µï¼Œè¿™æ ·é€»è¾‘ä¸Šæ›´æ¸…æ™°ï¼Œåé¢ä¹Ÿå®¹æ˜“åšæ‹†åˆ†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566888777,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127711,"user_name":"Charles","can_delete":false,"product_type":"c1","uid":1001410,"ip_address":"","ucode":"32646D78CC0389","user_header":"https://static001.geekbang.org/account/avatar/00/0f/47/c2/e9fa4cf6.jpg","comment_is_top":false,"comment_ctime":1566783005,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5861750301","product_id":100028301,"comment_content":"é¡¹ç›®æ¯”è¾ƒå°ï¼Œä¸€èˆ¬ç¢°ä¸åˆ°è€å¸ˆè¯´çš„ç¼“å­˜é£æš´é—®é¢˜ï¼Œä½†æ˜¯èƒ½æƒ³åˆ°çš„å°±æ˜¯ä¸»åŠ¨ç¼“å­˜æ›´æ–°å’Œå‰ç«¯å–åˆ°ç¼“å­˜ç©ºå€¼å°±åŠ ä¸€ä¸ªé˜Ÿåˆ—æ’é˜Ÿå–","like_count":1},{"had_liked":false,"id":356687,"user_name":"å‘æ–‡è¶…","can_delete":false,"product_type":"c1","uid":1976384,"ip_address":"ä¸Šæµ·","ucode":"3DA58D26FF8FCB","user_header":"https://static001.geekbang.org/account/avatar/00/1e/28/40/1c1a34c7.jpg","comment_is_top":false,"comment_ctime":1662514261,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662514261","product_id":100028301,"comment_content":"ç¼“å­˜é£æš´ è¯´çš„å°±æ˜¯ç¼“å­˜è¡€å´©ï¼Œè¡€å´©çš„ç»å…¸è§£å†³æ–¹æ³•å¥½åƒè¿˜æŒºå¤šçš„ï¼Œé™¤äº†åŠ é”ï¼Œè¿˜æœ‰æ¯”å¦‚è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´çš„éšæœºæŠ–åŠ¨ã€å¯¹dbè¯·æ±‚é™æµç­‰","like_count":0},{"had_liked":false,"id":133018,"user_name":"witt","can_delete":false,"product_type":"c1","uid":1005864,"ip_address":"","ucode":"19C8BCA266130A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/59/28/88f9d7f7.jpg","comment_is_top":false,"comment_ctime":1568313775,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568313775","product_id":100028301,"comment_content":"æ¥è§¦åˆ°ä¸¤ç§å¤„ç†ç¼“å­˜çš„æ–¹å¼<br>1. ehcacheä¸­æœ‰å‚æ•°å¯ä»¥è®¾ç½®ç¼“å­˜æœ€åä¸€æ¬¡è®¿é—®åå¤±æ•ˆçš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè¿™ä¸ªç¼“å­˜ä¸€ç›´åœ¨è¢«è®¿é—®å°±ä¸ä¼šå¤±æ•ˆï¼Œç›´åˆ°è¿™ä¸ªç¼“å­˜é—²ç½®æ—¶é—´è¶…è¿‡è®¾ç½®çš„å€¼ï¼Œæ‰ä¼šå¤±æ•ˆ<br>2. è®¾ç½®äºŒçº§ç¼“å­˜ï¼Œè¯»å–æ•°æ®é¦–å…ˆä»ä¸€çº§ç¼“å­˜è¯»å–ï¼Œä¸€çº§ç¼“å­˜ä¸å­˜åœ¨å†ç”¨äºŒçº§ç¼“å­˜é‡Œè¯»å–ï¼ŒäºŒçº§ç¼“å­˜æ¯”ä¸€çº§ç¼“å­˜å¤±æ•ˆæ—¶é—´æœ‰ä¸ª30sçš„å»¶è¿Ÿï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€çº§ç¼“å­˜å¤±æ•ˆå30säºŒçº§ç¼“å­˜æ‰å¤±æ•ˆï¼Œæ›´æ–°æ•°æ®ä¹Ÿæ˜¯å…ˆæ›´æ–°ä¸€çº§ç¼“å­˜å†æ›´æ–°äºŒçº§ç¼“å­˜ï¼Œä½†æ›´æ–°æ˜¯æ²¡æœ‰30sè¿™ä¹ˆé•¿çš„å»¶è¿Ÿ<br><br>å½“ç„¶ï¼Œè¿™ä¸¤ç§ç¼“å­˜éƒ½å¯ä»¥ä¸»åŠ¨æ¸…ç†ï¼Œç¬¬äºŒç§æ¸…ç†ç¼“å­˜çš„æ–¹å¼æ˜¯å…ˆæ¸…ç†äºŒçº§ç¼“å­˜å†æ¸…ç†ä¸€çº§ç¼“å­˜","like_count":0},{"had_liked":false,"id":131391,"user_name":"ææ˜¥æ’","can_delete":false,"product_type":"c1","uid":1033066,"ip_address":"","ucode":"F2DCA19EC66DC1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c3/6a/3272e095.jpg","comment_is_top":false,"comment_ctime":1567737381,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567737381","product_id":100028301,"comment_content":"èµ","like_count":0},{"had_liked":false,"id":127953,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1566813847,"is_pvip":false,"replies":[{"id":"47509","content":"å®šæ—¶æ›´æ–°éœ€è¦å¤„ç†å„ç§å¼‚å¸¸ï¼Œå¦‚æœå¤±è´¥äº†æ˜¯å¦è¦é‡è¯•ï¼Œé‡è¯•å¤šå°‘æ¬¡ï¼Œé€»è¾‘ä¼šæ¯”è¾ƒå¤æ‚ï¼›è€Œè¢«åŠ¨æ›´æ–°å°±å¾ˆç®€å•äº†ï¼Œå¤±è´¥äº†å°±ä½¿ç”¨è¿‡æœŸæ•°æ®ï¼Œç­‰ç€ä¸‹ä¸€ä¸ªè¯·æ±‚å†å»æ›´æ–°å°±è¡Œäº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1566867953,"ip_address":"","comment_id":127953,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1566813847","product_id":100028301,"comment_content":"æƒ³è¯·é—®ä¸‹è€å¸ˆï¼Œå®šæ—¶æ›´æ–°ç¼“å­˜ï¼Œå’Œç¼“å­˜å¤±æ•ˆæ—¶è¢«åŠ¨æŸ¥è¯¢æ•°æ®åº“æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464721,"discussion_content":"å®šæ—¶æ›´æ–°éœ€è¦å¤„ç†å„ç§å¼‚å¸¸ï¼Œå¦‚æœå¤±è´¥äº†æ˜¯å¦è¦é‡è¯•ï¼Œé‡è¯•å¤šå°‘æ¬¡ï¼Œé€»è¾‘ä¼šæ¯”è¾ƒå¤æ‚ï¼›è€Œè¢«åŠ¨æ›´æ–°å°±å¾ˆç®€å•äº†ï¼Œå¤±è´¥äº†å°±ä½¿ç”¨è¿‡æœŸæ•°æ®ï¼Œç­‰ç€ä¸‹ä¸€ä¸ªè¯·æ±‚å†å»æ›´æ–°å°±è¡Œäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566867953,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6310,"discussion_content":"å®šæ—¶æ›´æ–°æ˜¯è®¡åˆ’ä»»åŠ¡ï¼Œæ¯æ¬¡åªä¸»åŠ¨æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ç„¶åæŠŠç»“æœç¼“å­˜ä¸‹æ¥ï¼Œè®©ç¼“å­˜ä¸ä¼šå‡ºç°è¿‡æœŸå¤±æ•ˆçš„é—®é¢˜ï¼›è€Œç¼“å­˜å¤±æ•ˆæ—¶è¢«åŠ¨æŸ¥è¯¢æ•°æ®åº“å°±å¾ˆå¯èƒ½æ˜¯å¤§é‡è¯·æ±‚åŒæ—¶æŸ¥æ•°æ®åº“ï¼Œè¿™æ ·å¾ˆå®¹æ˜“æŠŠæ•°æ®åº“æ‰“æ­»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566829470,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":127875,"user_name":"è®¸ç«¥ç«¥","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1566803672,"is_pvip":false,"replies":[{"id":"47527","content":"ç»ˆç«¯ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´å°±å˜è¾¹é•¿ï¼ŒæœåŠ¡ç«¯ä¼šç»´æŠ¤å¾ˆå¤šå¹¶å‘è¿æ¥ï¼Œå‹å® OpenResty å€’ä¸è‡³äºã€‚<br>ä¸èƒ½æ¥å—è¿‡æœŸæ•°æ®ï¼Œè¿™ä¸ªå…¶å®æ˜¯ä¸ªä¼ªå‘½é¢˜ï¼Œæœ¬æ¥å°±æ˜¯ç¼“å­˜ï¼Œæ˜¯å…è®¸å’Œæ•°æ®åº“çš„æ•°æ®ä¸åŒçš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1566868686,"ip_address":"","comment_id":127875,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1566803672","product_id":100028301,"comment_content":"å¦‚æœä¸èƒ½æ¥å—è¿‡æœŸæ•°æ®ï¼Œä¸€ä¸ªè¯·æ±‚å»æŸ¥è¯¢æ•°æ®åº“ï¼Œå…¶å®ƒè¯·æ±‚æ²¡è·å–åˆ°é”ï¼Œåˆ™æŒç»­ç­‰å¾…ï¼Œæ­¤æ—¶è¿™ä¸ªæŸ¥è¯¢è¯·æ±‚å¾ˆè€—æ—¶ï¼Œä¼šä¸ä¼šå› ä¸ºå¤§æµé‡æŠŠopenRestyå‹å®?","like_count":0,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":464688,"discussion_content":"ç»ˆç«¯ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´å°±å˜è¾¹é•¿ï¼ŒæœåŠ¡ç«¯ä¼šç»´æŠ¤å¾ˆå¤šå¹¶å‘è¿æ¥ï¼Œå‹å® OpenResty å€’ä¸è‡³äºã€‚\nä¸èƒ½æ¥å—è¿‡æœŸæ•°æ®ï¼Œè¿™ä¸ªå…¶å®æ˜¯ä¸ªä¼ªå‘½é¢˜ï¼Œæœ¬æ¥å°±æ˜¯ç¼“å­˜ï¼Œæ˜¯å…è®¸å’Œæ•°æ®åº“çš„æ•°æ®ä¸åŒçš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566868686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6314,"discussion_content":"æˆ‘çš„ç†è§£ï¼šopenrestyä»¥é«˜å¹¶å‘è‘—ç§°ä¸”å¹³è¡Œæ‰©å±•éå¸¸å®¹æ˜“ï¼Œå®¹é‡è§„åˆ’åšå¥½ä¸ä¼šé‚£ä¹ˆå®¹æ˜“å‹å®çš„ï¼Œæ‰€ä»¥è¿™ç‚¹ä¸ç”¨æ‹…å¿ƒã€‚æœ¬æ–‡ä¸»è¦è§£å†³çš„æ˜¯è®©æ•°æ®åº“è¿™ç§ä½å¹¶å‘ä¸”æ‰©å±•æˆæœ¬è¾ƒé«˜çš„åº”ç”¨å°½å¯èƒ½å°‘æ¥æ”¶è¯·æ±‚ã€‚å¦å¤–å¯¹äºæŸ¥è¯¢æ•°æ®åº“å¾ˆè€—æ—¶çš„åº”ç”¨åœºæ™¯ï¼Œåº”è¯¥ä¼˜å…ˆé‡‡ç”¨é€šè¿‡è®¡åˆ’ä»»åŠ¡å®šæœŸæ›´æ–°ç¼“å­˜ä½¿ç¼“å­˜ä¸å‡ºç°è¿‡æœŸå¤±æ•ˆçš„é‚£ä¸ªæ–¹æ¡ˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566830136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}