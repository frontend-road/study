{"id":2278,"title":"18 | 微服务的容错限流是如何工作的？","content":"<p>无</p>\n","comments":[{"had_liked":false,"id":2387,"user_name":"LMD","can_delete":false,"product_type":"c3","uid":1013443,"ip_address":"","ucode":"7626FBB7A4E771","user_header":"","comment_is_top":true,"comment_ctime":1516964873,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"关于《微服务架构核心20讲》课程讲义（PDF 文件），学员可复制下面链接到浏览器下载获取。 http:&#47;&#47;t.cn&#47;RQs9iTw","like_count":11},{"had_liked":false,"id":4206,"user_name":"极客时间攻城狮。","can_delete":false,"product_type":"c3","uid":1015812,"ip_address":"","ucode":"E279553F00309F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/80/04/e6989d2a.jpg","comment_is_top":false,"comment_ctime":1521705480,"is_pvip":true,"replies":[{"id":1851,"content":"谢谢支持🌹","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1524749587,"ip_address":"","comment_id":4206,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"不错","like_count":4,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":416240,"discussion_content":"谢谢支持🌹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1524749587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":3797,"user_name":"GrooveWind","can_delete":false,"product_type":"c3","uid":1023087,"ip_address":"","ucode":"79C44B1D48A748","user_header":"","comment_is_top":false,"comment_ctime":1520611262,"is_pvip":false,"replies":[{"id":1354,"content":"降级函数是可以自定义的，每个节点可以根据自己的实际情况定制（当然对研发人员有一定要求，因为hystrix还是有技术门槛的）。在网关等集中点上，一般统一降级函数，但对于特殊API调用也可以特殊处理。","user_name":"作者回复","user_name_real":"晨晖","uid":1000463,"ctime":1522811687,"ip_address":"","comment_id":3797,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"请问老师，降级函数只有一个吗？不同节点上的降级策略可能不一样，那么是否需要开发人员手动来匹配降级策略呢","like_count":4,"discussions":[{"author":{"id":1000463,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/44/0f/abb7bfe3.jpg","nickname":"Geek_4zi01v","note":"","ucode":"6A485218B87E38","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":416058,"discussion_content":"降级函数是可以自定义的，每个节点可以根据自己的实际情况定制（当然对研发人员有一定要求，因为hystrix还是有技术门槛的）。在网关等集中点上，一般统一降级函数，但对于特殊API调用也可以特殊处理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1522811687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178237,"user_name":"技术修行者","can_delete":false,"product_type":"c3","uid":1013147,"ip_address":"","ucode":"28CA41A1214D6B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/9b/611e74ab.jpg","comment_is_top":false,"comment_ctime":1581638893,"is_pvip":false,"replies":[{"id":74652,"content":"对，超时也是作为一种失败汇报给电路健康监控组件的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585406816,"ip_address":"","comment_id":178237,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100003901,"comment_content":"我理解图中的Run()下面的timeout连线应该去掉，timeout应该作为服务运行失败的一种情况，在后面Success条件判断的时候进行处理，这样可以保证在调用链中所有可能失败的情况，都会汇总到电路健康状态监控组件上。","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483719,"discussion_content":"对，超时也是作为一种失败汇报给电路健康监控组件的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585406816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":56731,"user_name":"lorancechen","can_delete":false,"product_type":"c3","uid":1114303,"ip_address":"","ucode":"2A16CFA4726AE7","user_header":"https://static001.geekbang.org/account/avatar/00/11/00/bf/a44cde46.jpg","comment_is_top":false,"comment_ctime":1546530492,"is_pvip":false,"replies":[{"id":21749,"content":"两点：1，线程池前面一般还有队列，线程用满的话后面的可以暂时排队，如果线程处理完前面的请求，后面队列里头的就可以用空出来的线程。2，服务一般做成无状态集群部署，可以按需扩，一个服务如果并发只能处理20个请求，那么20个服务并发就可以处理400个","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1547618137,"ip_address":"","comment_id":56731,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"对于资源隔离有一个疑问，同步调用情况下会不会很容易导致资源被用满呢？比如某个HystrixCommand分了20个线程资源，如果同一秒并发100个，前20个正在处理，后80个不就因为没有线程资源可用，就直接走fallback了吗？","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":435202,"discussion_content":"两点：1，线程池前面一般还有队列，线程用满的话后面的可以暂时排队，如果线程处理完前面的请求，后面队列里头的就可以用空出来的线程。2，服务一般做成无状态集群部署，可以按需扩，一个服务如果并发只能处理20个请求，那么20个服务并发就可以处理400个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1547618137,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":181644,"user_name":"钱","can_delete":false,"product_type":"c3","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1582602489,"is_pvip":false,"replies":[{"id":74953,"content":"没有所谓标准配置，都是先预估，然后线上监控，根据监控测量数据再逐步调优。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585570999,"ip_address":"","comment_id":181644,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"看图示是否熔断降级，一个是根据熔断的开关，一个是根据分配的资源比如线程池队列等，那此时分配资源的规则就比较关键了，这一块具体的设置依据是什么？系统本身的配置还是实际进行压测评估？","like_count":2,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485064,"discussion_content":"没有所谓标准配置，都是先预估，然后线上监控，根据监控测量数据再逐步调优。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585570999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":132979,"user_name":"thinkcat","can_delete":false,"product_type":"c3","uid":1546829,"ip_address":"","ucode":"5D94C4F26DE1CB","user_header":"","comment_is_top":false,"comment_ctime":1568288794,"is_pvip":false,"replies":[{"id":51317,"content":"不管同步还是异步queue执行，都会进入后续circuit open判断流程。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1568639147,"ip_address":"","comment_id":132979,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"是说只有异步调用执行.queue（）时才会进入后续circuit open判断流程吗？同步或者交互式调用直接返回用户结果？","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467199,"discussion_content":"不管同步还是异步queue执行，都会进入后续circuit open判断流程。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568639147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1546829,"avatar":"","nickname":"thinkcat","note":"","ucode":"5D94C4F26DE1CB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":15173,"discussion_content":"谢谢老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568809319,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":46109,"user_name":"Geek_fb3db2","can_delete":false,"product_type":"c3","uid":1218254,"ip_address":"","ucode":"8089B8311B6C80","user_header":"https://static001.geekbang.org/account/avatar/00/12/96/ce/8c3bdbe5.jpg","comment_is_top":false,"comment_ctime":1543848414,"is_pvip":false,"replies":[{"id":16610,"content":"有封装好的组件，如Hystrix能帮助你对服务进行熔断限流，有些服务需开发人员自己集成，有些可以在框架层统一集成，比较网关熔断限流一般是统一集成的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1543930210,"ip_address":"","comment_id":46109,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"是不是每个请求如果需要限流 都需要这一套逻辑处理","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":431339,"discussion_content":"有封装好的组件，如Hystrix能帮助你对服务进行熔断限流，有些服务需开发人员自己集成，有些可以在框架层统一集成，比较网关熔断限流一般是统一集成的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1543930210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":36253,"user_name":"wmg","can_delete":false,"product_type":"c3","uid":1070036,"ip_address":"","ucode":"BA4CED171B59E9","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/d4/2ed767ea.jpg","comment_is_top":false,"comment_ctime":1540997321,"is_pvip":false,"replies":[{"id":12993,"content":"像hystrix这类组件主要支持信号量和线程池两种隔离机制，把信号量或线程池等资源分隔分配给依赖调用，一个依赖耗量资源，不影响其它依赖，这个就是资源隔离的思想。具体建议看hystrix官方文档，或学习我的进阶课程《微服务架构实践160讲》，里头对隔离有深入分析。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1541160864,"ip_address":"","comment_id":36253,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"隔离是怎么体现的呢？没看懂","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":427799,"discussion_content":"像hystrix这类组件主要支持信号量和线程池两种隔离机制，把信号量或线程池等资源分隔分配给依赖调用，一个依赖耗量资源，不影响其它依赖，这个就是资源隔离的思想。具体建议看hystrix官方文档，或学习我的进阶课程《微服务架构实践160讲》，里头对隔离有深入分析。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1541160864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":3396,"user_name":"self-discipline","can_delete":false,"product_type":"c3","uid":1024457,"ip_address":"","ucode":"A5AEDCA9ACC68A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a1/c9/501a1d02.jpg","comment_is_top":false,"comment_ctime":1519340881,"is_pvip":false,"replies":[{"id":1362,"content":"会记录很多数据，成功失败都要记录，具体可进去看源码","user_name":"作者回复","user_name_real":"晨晖","uid":1000463,"ctime":1522812053,"ip_address":"","comment_id":3396,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100003901,"comment_content":"看图示和老师说的不一样啊,是整个过程都会做记录,然后作为下次短路判断依据,如果不到success标识及其以后的操作,那么根本没有必要作为下次判断的依据啊","like_count":1,"discussions":[{"author":{"id":1000463,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/44/0f/abb7bfe3.jpg","nickname":"Geek_4zi01v","note":"","ucode":"6A485218B87E38","race_medal":0,"user_type":4,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":415889,"discussion_content":"会记录很多数据，成功失败都要记录，具体可进去看源码","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1522812053,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":4}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":50280,"user_name":"believe me","can_delete":false,"product_type":"c3","uid":1101427,"ip_address":"","ucode":"7BF9A3C7BF6A9B","user_header":"https://static001.geekbang.org/account/avatar/00/10/ce/73/cded8343.jpg","comment_is_top":false,"comment_ctime":1544942907,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100003901,"comment_content":"如果流量很大，这个限流组件也会瘫痪吧","like_count":1},{"had_liked":false,"id":374903,"user_name":"Geek_f1c6e5","can_delete":false,"product_type":"c3","uid":1578012,"ip_address":"上海","ucode":"5FCAAD30FE2274","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKTJEia7U5mWwibHTas52tntJ2pG4PeMdIfkwKdTicNhPic66Y2KXO6sxEcyfcvFjRiavBajib6yzF97Bmg/132","comment_is_top":false,"comment_ctime":1684635321,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100003901,"comment_content":"拿一些好多年前第三方公司的组件在这里讲，讲的又都是浮在上层表面的东西，沉不下去，极客时间请架构师讲课的门槛都这么低了吗？","like_count":0}]}