{"id":394084,"title":"28 | éƒ¨é—¨åˆ†ç±»ï¼šå¦‚ä½•è¡¨ç¤ºè®¾å¤‡ç±»å‹ä¸è®¾å¤‡é©±åŠ¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚</p><p>å°åˆ°å…¬å¸ï¼Œå¤§åˆ°å›½å®¶ï¼Œéƒ½æœ‰å„ç§ä¸‹å±éƒ¨é—¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å›½å®¶ç°åœ¨æœ‰æ•™è‚²éƒ¨ã€ç§‘å­¦æŠ€æœ¯éƒ¨ã€å¤–äº¤éƒ¨ï¼Œè´¢æ”¿éƒ¨ç­‰ï¼Œè¿™äº›éƒ¨é—¨å„è‡ªè´Ÿè´£å®Œæˆä¸åŒçš„èŒèƒ½å·¥ä½œï¼Œå¦‚æ•™è‚²éƒ¨è´Ÿè´£æ•™è‚²äº‹ä¸šå’Œè¯­è¨€æ–‡å­—å·¥ä½œï¼Œç§‘å­¦æŠ€æœ¯éƒ¨è´Ÿè´£æ¨åŠ¨è§£å†³ç»æµç¤¾ä¼šå‘å±•çš„é‡å¤§ç§‘æŠ€é—®é¢˜ã€‚</p><p>æ—¢ç„¶å¤§é“ç›¸é€šï¼Œé‚£æˆ‘ä»¬çš„Cosmosä¸­æ˜¯å¦ä¹Ÿæ˜¯ç±»ä¼¼è¿™æ ·çš„ç»“æ„å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œåœ¨å‰é¢çš„è¯¾ä¸­ï¼Œæˆ‘ä»¬æå®šäº†å†…å­˜ç®¡ç†å’Œè¿›ç¨‹ç®¡ç†ï¼Œå®ƒä»¬æ˜¯å†…æ ¸ä¸å¯åˆ†éš”çš„ï¼Œä½†æ˜¯è®¡ç®—æœºä¸­è¿˜æœ‰å„ç§ç±»å‹çš„è®¾å¤‡éœ€è¦ç®¡ç†ã€‚</p><p>æˆ‘ä»¬çš„Cosmosä¹Ÿä¼šâ€œæˆç«‹å„ç±»éƒ¨é—¨â€ï¼Œç”¨äºç®¡ç†ä¼—å¤šè®¾å¤‡ï¼Œä¸€ä¸ªéƒ¨é—¨è´Ÿè´£ä¸€ç±»è®¾å¤‡ã€‚å…·ä½“è¦æ€ä¹ˆç®¡ç†è®¾å¤‡å‘¢ï¼Ÿä½ ä¸å¦¨å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œæ­£å¼å¼€å§‹ä»Šå¤©çš„å­¦ä¹ ï¼</p><p>è¿™èŠ‚è¯¾çš„ä»£ç ï¼Œä½ å¯ä»¥ä»<a href=\"https://gitee.com/lmos/cosmos/tree/master/lesson28~29/Cosmos\">è¿™é‡Œ</a>ä¸‹è½½ã€‚</p><h2>è®¡ç®—æœºçš„ç»“æ„</h2><p>ä¸çŸ¥é“ä½ æ˜¯å¦å’Œæˆ‘ä¸€æ ·ï¼Œç»å¸¸æŠŠè®¡ç®—æœºçš„æœºç®±æ‰“å¼€ï¼Œçœ‹çœ‹ CPUï¼Œçœ‹çœ‹å†…å­˜æ¡ï¼Œçœ‹çœ‹æ˜¾å¡ï¼Œçœ‹çœ‹ä¸»æ¿ä¸Šçš„å„ç§èŠ¯ç‰‡ã€‚</p><p>å…¶å®ï¼Œè¿™äº›èŠ¯ç‰‡å¹¶éç‹¬ç«‹å­˜åœ¨ï¼Œè€Œæ˜¯ä»¥æ€»çº¿ä¸ºåŸºç¡€è¿æ¥åœ¨ä¸€èµ·çš„ï¼Œå„è‡ªå®Œæˆè‡ªå·±çš„å·¥ä½œï¼Œåˆèƒ½äº’ç›¸æ‰“é…åˆï¼Œå…±åŒå®ç°ç”¨æˆ·è¦æ±‚çš„åŠŸèƒ½ã€‚</p><p>ä¸ºäº†å¸®ä½ ç†æ¸…å®ƒä»¬çš„è¿æ¥å…³ç³»ï¼Œæˆ‘ä¸ºä½ ç”»äº†ä¸€å¹…å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2f/4c/2f7697d94bee25d4c036eb4bca16ee4c.jpg?wh=4400x3305\" alt=\"\" title=\"è®¡ç®—æœºç»“æ„ç¤ºæ„å›¾\"></p><p>ä¸Šå›¾æ˜¯ä¸€ä¸ªå…¸å‹çš„æ¡Œé¢ç³»ç»Ÿï¼Œä½ å…ˆä¸ç”¨ç®¡æ˜¯ç‰©ç†ä¸Šæ€ä¹ˆæ ·è¿æ¥çš„ï¼Œé€»è¾‘ä¸Šå°±æ˜¯è¿™æ ·çš„ã€‚å®é™…å¯èƒ½æ¯”å›¾ä¸­æœ‰æ›´å¤šæˆ–è€…æ›´å°‘çš„æ€»çº¿ã€‚ä½†æ˜¯æ€»çº¿æœ‰å±‚çº§å…³ç³»ï¼Œå„ç§è®¾å¤‡é€šè¿‡æ€»çº¿ç›¸è¿ã€‚è¿™é‡Œæˆ‘ä»¬åªéœ€è¦è®°ä½ï¼Œè®¡ç®—æœºä¸­æœ‰å¾ˆå¤šç§ç±»çš„è®¾å¤‡ï¼Œè„‘ä¸­æœ‰åˆšæ‰è¿™å¹…å›¾å°±è¡Œäº†ã€‚</p><!-- [[[read_end]]] --><h2>å¦‚ä½•ç®¡ç†è®¾å¤‡</h2><p>åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ç®¡ç†å†…å­˜å’Œè¿›ç¨‹ï¼Œå…¶å®è¿›ç¨‹ä»æ­£é¢çœ‹å®ƒæ˜¯ç®¡ç†åº”ç”¨ç¨‹åºçš„ï¼Œåè¿‡æ¥çœ‹å®ƒä¹Ÿæ˜¯ç®¡ç†CPUçš„ï¼Œå®ƒèƒ½ä½¿CPUçš„ä½¿ç”¨ç‡è¾¾åˆ°æœ€é«˜ã€‚</p><p>ç®¡ç†å†…å­˜å’Œç®¡ç†CPUæ˜¯æ“ä½œç³»ç»Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œä½†æ˜¯è¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸ºè®¡ç®—æœºä¸æ­¢æœ‰CPUï¼Œè¿˜æœ‰å„ç§è®¾å¤‡ã€‚</p><p>å¦‚æœæŠŠè®¡ç®—æœºå†…éƒ¨æ‰€æœ‰çš„è®¾å¤‡å’Œæ•°æ®éƒ½æè¿°æˆèµ„æºï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸æ— ç–‘æ˜¯è¿™äº›èµ„æºçš„ç®¡ç†è€…ã€‚æ—¢ç„¶è®¾å¤‡ä¹Ÿæ˜¯ä¸€ç§èµ„æºï¼Œå¦‚ä½•é«˜æ•ˆç®¡ç†å®ƒä»¬ï¼Œä»¥ä¾¿æä¾›ç»™åº”ç”¨è¿›ç¨‹ä½¿ç”¨å’Œæ“ä½œï¼Œå°±æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸çš„é‡è¦ä»»åŠ¡ã€‚</p><h3>åˆ†æƒè€Œæ²»</h3><p>ä¸€ä¸ªå›½å®¶ä¹‹æ‰€ä»¥æœ‰é‚£ä¹ˆå¤šéƒ¨é—¨ï¼Œå°±æ˜¯è¦æŠŠç®¡ç†å·¥ä½œåˆ†å¼€ï¼Œä¸“æƒä¸“èŒä¸“è´£ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ä¸€æ ·ã€‚</p><p>ç°ä»£è®¡ç®—æœºæ—©å·²ä¸é™äºåªå¤„ç†è®¡ç®—ä»»åŠ¡ï¼Œå®ƒè¿˜å¯ä»¥å‘ˆç°å›¾åƒã€éŸ³é¢‘ï¼Œå’Œè¿œç¨‹è®¡ç®—æœºé€šä¿¡ï¼Œå‚¨å­˜å¤§é‡æ•°æ®ï¼Œä»¥åŠå’Œç”¨æˆ·äº¤äº’ã€‚æ‰€ä»¥ï¼Œè®¡ç®—æœºå†…éƒ¨éœ€è¦å¤„ç†å›¾åƒã€éŸ³é¢‘ã€ç½‘ç»œã€å‚¨å­˜ã€äº¤äº’çš„è®¾å¤‡ã€‚è¿™ä»ä¸Šé¢çš„å›¾ä¸­ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ã€‚</p><p>æ“ä½œç³»ç»Ÿå†…æ ¸è¦æ§åˆ¶è¿™äº›è®¾å¤‡ï¼Œå°±è¦åŒ…å«æ¯ä¸ªè®¾å¤‡çš„æ§åˆ¶ä»£ç ã€‚å¦‚æœæ“ä½œç³»ç»Ÿå†…æ ¸è¢«è®¾è®¡ä¸ºé€šç”¨å¯ç§»æ¤çš„å†…æ ¸ï¼Œé‚£æ˜¯ç›¸å½“å¯æ€•çš„ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œè¿™ä¸ªä¸–ç•Œä¸Šæœ‰å¦‚æ­¤å¤šçš„è®¾å¤‡ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä»£ç å¾—å¤šåºå¤§ï¼Œè¶Šåºå¤§å°±è¶Šå±é™©ï¼Œå› ä¸ºå…¶ä¸­ä¸€è¡Œä»£ç æœ‰é—®é¢˜ï¼Œæ•´ä¸ªæ“ä½œç³»ç»Ÿå°±å´©æºƒäº†ã€‚</p><p>å¯æ˜¯ä»…ä»…åªæœ‰è¿™äº›é—®é¢˜å—ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘åˆ°åé¢è¿™å‡ ç‚¹ã€‚</p><p>1.æ“ä½œç³»ç»Ÿå†…æ ¸å¼€å‘äººå‘˜ï¼Œä¸å¯èƒ½ç½—åˆ—ä¸–ç•Œä¸Šæ‰€æœ‰çš„è®¾å¤‡ï¼Œå¹¶ä¸ºå…¶å†™ä¸€å¥—æ§åˆ¶ä»£ç ã€‚</p><p>2.ä¸ºäº†å•†ä¸šç›®çš„ï¼Œæœ‰å¾ˆå¤šè®¾å¤‡å‚å•†å¹¶ä¸æ„¿æ„å…¬å¼€è®¾å¤‡çš„ç¼–ç¨‹ç»†èŠ‚ã€‚å°±ç®—å†…æ ¸å¼€å‘äººå‘˜æƒ³ä¸ºå…¶å†™æ§åˆ¶ä»£ç ï¼Œå®é™…ä¹Ÿä¸å¯è¡Œã€‚</p><p>3.å¦‚æœè®¾å¤‡æ›´æ–°æ¢ä»£ï¼Œå°±è¦é‡å†™è®¾å¤‡çš„æ§åˆ¶ä»£ç ï¼Œç„¶åé‡æ–°ç¼–è¯‘æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œè¿™æ ·çš„è¯æ“ä½œå¾ˆéº»çƒ¦ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å¼€å‘äººå‘˜å’Œç”¨æˆ·éƒ½å¯èƒ½å—ä¸äº†ã€‚</p><p>ä»¥ä¸Šä¸‰ç‚¹ï¼Œè¶³äºè¯æ˜è¿™ç§æ–¹æ¡ˆæ ¹æœ¬ä¸å¯å–ã€‚</p><p>æ—¢ç„¶æ“ä½œç³»ç»Ÿå†…æ ¸æ— æ³•åŒ…å«æ‰€æœ‰çš„è®¾å¤‡æ§åˆ¶ä»£ç ï¼Œé‚£å°±ç´¢æ€§ä¸åŒ…å«ï¼Œæˆ–è€…åªåŒ…å«æœ€åŸºæœ¬ã€æœ€é€šç”¨çš„è®¾å¤‡æ§åˆ¶ä»£ç ã€‚è¿™æ ·æ“ä½œç³»ç»Ÿå†…æ ¸å°±å¯ä»¥éå¸¸é€šç”¨ï¼Œéå¸¸ç²¾å·§ã€‚</p><p>ä½†æ˜¯è¦æ§åˆ¶è®¾å¤‡å°±å¿…é¡»è¦æœ‰è®¾å¤‡çš„ç›¸å…³æ§åˆ¶ä»£ç æ‰è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠè®¾å¤‡æ§åˆ¶ä»£ç ç‹¬ç«‹å‡ºæ¥ï¼Œä¸æ“ä½œç³»ç»Ÿå†…æ ¸åˆ†å¼€ã€ç‹¬ç«‹å¼€å‘ï¼Œè®¾å¤‡æ§åˆ¶ä»£ç å¯ç”±è®¾å¤‡å‚å•†äººå‘˜å¼€å‘ã€‚</p><p>æ¯ä¸ªè®¾å¤‡å¯¹åº”ä¸€ä¸ªè®¾å¤‡æ§åˆ¶ä»£ç æ¨¡å—ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸è¦æ§åˆ¶å“ªä¸ªè®¾å¤‡ï¼Œå°±åŠ è½½ç›¸åº”çš„è®¾å¤‡ä»£ç æ¨¡å—ï¼Œä»¥åä¸ä½¿ç”¨è¿™ä¸ªè®¾å¤‡äº†ï¼Œå°±å¯ä»¥åˆ é™¤å¯¹åº”çš„è®¾å¤‡æ§åˆ¶ä»£ç æ¨¡å—ã€‚</p><p>è¿™ç§æ–¹å¼ï¼Œç»™æ“ä½œç³»ç»Ÿå†…æ ¸å¸¦æ¥äº†<strong>å·¨å¤§çš„çµæ´»æ€§</strong>ã€‚è®¾å¤‡å‚å•†åœ¨å‘å¸ƒæ–°è®¾å¤‡æ—¶ï¼Œåªè¦éšä¹‹å‘å¸ƒä¸€ä¸ªä¸æ­¤ç›¸å…³çš„è®¾å¤‡æ§åˆ¶ä»£ç æ¨¡å—å°±è¡Œäº†ã€‚</p><h3>è®¾å¤‡åˆ†ç±»</h3><p>è¦æƒ³ç®¡ç†è®¾å¤‡ï¼Œå…ˆè¦å¯¹å…¶åˆ†é—¨åˆ«ç±»ï¼Œåœ¨å¼€å§‹åˆ†ç±»ä¹‹å‰ï¼Œä½ ä¸å¦¨å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸æ‰€æ„ŸçŸ¥çš„è®¾å¤‡ï¼Œä¸€å®šè¦ä¸ç‰©ç†è®¾å¤‡ä¸€ä¸€å¯¹åº”å—ï¼Ÿ</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‚¨å­˜è®¾å¤‡ï¼Œå…¶å®ä¸ç®¡å®ƒæ˜¯æœºæ¢°ç¡¬ç›˜ï¼Œè¿˜æ˜¯TFå¡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªè®¾å¤‡æ§åˆ¶ä»£ç æ¨¡å—ï¼Œå®ƒå‘æ“ä½œç³»ç»Ÿå†…æ ¸è¡¨æ˜å®ƒæ˜¯å‚¨å­˜è®¾å¤‡ï¼Œä½†å®ƒå®Œå…¨æœ‰å¯èƒ½åˆ†é…ä¸€å—å†…å­˜ç©ºé—´æ¥å‚¨å­˜æ•°æ®ï¼Œä¸å¿…è®¿é—®çœŸæ­£çš„å‚¨å­˜è®¾å¤‡ã€‚<strong>æ‰€ä»¥ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸æ‰€æ„ŸçŸ¥çš„è®¾å¤‡ï¼Œå¹¶ä¸éœ€è¦å’Œç‰©ç†è®¾å¤‡å¯¹åº”ï¼Œè¿™å–å†³äºè®¾å¤‡æ§åˆ¶ä»£ç è‡ªèº«çš„è¡Œä¸ºã€‚</strong></p><p>æ“ä½œç³»ç»Ÿå†…æ ¸æ‰€å®šä¹‰çš„è®¾å¤‡ï¼Œå¯ç§°ä¸ºå†…æ ¸è®¾å¤‡æˆ–è€…é€»è¾‘è®¾å¤‡ï¼Œå…¶å®è¿™åªæ˜¯å¯¹ç‰©ç†è®¡ç®—å¹³å°ä¸­å‡ ç§ç±»å‹è®¾å¤‡çš„ä¸€ç§æŠ½è±¡ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬åœ¨cosmos/include/knlinc/krldevice_t.hæ–‡ä»¶ä¸­å¯¹è®¾å¤‡è¿›è¡Œåˆ†ç±»å®šä¹‰ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>#define NOT_DEVICE 0               //ä¸è¡¨ç¤ºä»»ä½•è®¾å¤‡\n#define BRIDGE_DEVICE 4            //æ€»çº¿æ¡¥æ¥å™¨è®¾å¤‡\n#define CPUCORE_DEVICE 5           //CPUè®¾å¤‡ï¼ŒCPUä¹Ÿæ˜¯è®¾å¤‡\n#define RAMCONTER_DEVICE 6        //å†…å­˜æ§åˆ¶å™¨è®¾å¤‡\n#define RAM_DEVICE 7              //å†…å­˜è®¾å¤‡\n#define USBHOSTCONTER_DEVICE 8    //USBä¸»æ§åˆ¶è®¾å¤‡\n#define INTUPTCONTER_DEVICE 9     //ä¸­æ–­æ§åˆ¶å™¨è®¾å¤‡\n#define DMA_DEVICE 10             //DMAè®¾å¤‡\n#define CLOCKPOWER_DEVICE 11      //æ—¶é’Ÿç”µæºè®¾å¤‡\n#define LCDCONTER_DEVICE 12        //LCDæ§åˆ¶å™¨è®¾å¤‡\n#define NANDFLASH_DEVICE 13       //nandflashè®¾å¤‡\n#define CAMERA_DEVICE 14          //æ‘„åƒå¤´è®¾å¤‡\n#define UART_DEVICE 15             //ä¸²å£è®¾å¤‡\n#define TIMER_DEVICE 16            //å®šæ—¶å™¨è®¾å¤‡\n#define USB_DEVICE 17              //USBè®¾å¤‡\n#define WATCHDOG_DEVICE 18        //çœ‹é—¨ç‹—è®¾å¤‡\n#define RTC_DEVICE 22              //å®æ—¶æ—¶é’Ÿè®¾å¤‡\n#define SD_DEVICE 25               //SDå¡è®¾å¤‡\n#define AUDIO_DEVICE 26            //éŸ³é¢‘è®¾å¤‡\n#define TOUCH_DEVICE 27           //è§¦æ§è®¾å¤‡\n#define NETWORK_DEVICE 28         //ç½‘ç»œè®¾å¤‡\n#define VIR_DEVICE 29               //è™šæ‹Ÿè®¾å¤‡\n#define FILESYS_DEVICE 30            //æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡\n#define SYSTICK_DEVICE 31           //ç³»ç»ŸTICKè®¾å¤‡\n#define UNKNOWN_DEVICE 32        //æœªçŸ¥è®¾å¤‡ï¼Œä¹Ÿæ˜¯è®¾å¤‡\n#define HD_DEVICE 33        //ç¡¬ç›˜è®¾å¤‡\n</code></pre><p>ä¸Šé¢å®šä¹‰çš„è¿™äº›ç±»å‹çš„è®¾å¤‡ï¼Œéƒ½æ˜¯Cosmoså†…æ ¸æŠ½è±¡å‡ºæ¥çš„é€»è¾‘è®¾å¤‡ï¼Œä¾‹å¦‚NETWORK_DEVICEç½‘ç»œè®¾å¤‡ï¼Œä¸ç®¡å®ƒæ˜¯æœ‰çº¿ç½‘å¡è¿˜æ˜¯æ— çº¿ç½‘å¡ï¼Œæˆ–è€…æ˜¯è®¾å¤‡æ§åˆ¶ä»£ç è™šæ‹Ÿå‡ºæ¥çš„è™šæ‹Ÿç½‘å¡ã€‚Cosmoså†…æ ¸éƒ½å°†è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç½‘ç»œè®¾å¤‡ï¼Œè¿™å°±æ˜¯è®¾å¤‡çš„æŠ½è±¡ï¼Œè¿™æ ·æœ‰åˆ©äºæˆ‘ä»¬çµæ´»ã€ç®€ä¾¿ç®¡ç†è®¾å¤‡ã€‚</p><h2>è®¾å¤‡é©±åŠ¨</h2><p>åˆšæ‰æˆ‘ä»¬è§£å†³äº†è®¾å¤‡åˆ†ç±»ï¼Œä¸‹é¢æˆ‘æ¥ç ”ç©¶å¦‚ä½•å®ç°åˆ†æƒè€Œæ²»ï¼Œå°±æ˜¯æŠŠæ“ä½œæ¯ä¸ªè®¾å¤‡çš„ç›¸å…³ä»£ç ç‹¬ç«‹å‡ºæ¥ï¼Œè¿™ç§æ–¹å¼åœ¨ä¸šç•Œæœ‰ä¸€ä¸ªæ›´ä¸“ä¸šçš„åå­—â€”â€”<strong>è®¾å¤‡é©±åŠ¨ç¨‹åº</strong>ã€‚åŒæ—¶åœ¨ä¸‹é¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å°†ä¸åŒºåˆ†è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œé©±åŠ¨ç¨‹åºã€‚</p><p>è¿™ç§â€œåˆ†æƒè€Œæ²»â€çš„æ–¹å¼ï¼Œç»™æ“ä½œç³»ç»Ÿå†…æ ¸å¸¦äº†çµæ´»æ€§ã€å¯æ‰©å±•æ€§â€¦â€¦å¯æ˜¯ä¹Ÿå¸¦æ¥äº†æ–°çš„é—®é¢˜ï¼Œæœ‰å“ªäº›é—®é¢˜å‘¢ï¼Ÿ</p><p>é¦–å…ˆæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸å¦‚ä½•è¡¨ç¤ºå¤šä¸ªè®¾å¤‡ä¸é©±åŠ¨çš„å­˜åœ¨ï¼Ÿç„¶åï¼Œè¿˜æœ‰å¦‚ä½•ç»„ç»‡å¤šä¸ªè®¾å¤‡å’Œå¤šä¸ªé©±åŠ¨ç¨‹åºçš„é—®é¢˜ï¼Œæœ€åæˆ‘ä»¬è¿˜å¾—è€ƒè™‘åº”è¯¥è®©é©±åŠ¨ç¨‹åºæä¾›ä¸€äº›ä»€ä¹ˆæ”¯æŒã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«è§£å†³è¿™äº›é—®é¢˜ã€‚</p><h3>è®¾å¤‡</h3><p>ä½ èƒ½è¯´è¯´ä¸€ä¸ªè®¾å¤‡åŒ…å«å“ªäº›ä¿¡æ¯å—ï¼Ÿæ— éæ˜¯è®¾å¤‡ç±»å‹ï¼Œè®¾å¤‡åç§°ï¼Œè®¾å¤‡çŠ¶æ€ï¼Œè®¾å¤‡idï¼Œè®¾å¤‡çš„é©±åŠ¨ç¨‹åºç­‰ã€‚</p><p>æˆ‘ä»¬æŠŠè¿™äº›ä¿¡æ¯å½’çº³æˆä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œåœ¨æ“ä½œç³»ç»Ÿå†…æ ¸å»ºç«‹è¿™ä¸ªæ•°æ®ç»“æ„çš„å®ä¾‹å˜é‡ï¼Œè¿™ä¸ªè®¾å¤‡æ•°æ®ç»“æ„çš„å®ä¾‹å˜é‡ï¼Œä¸€æ—¦å»ºç«‹ï¼Œå°±è¡¨ç¤ºæ“ä½œç³»ç»Ÿå†…æ ¸ä¸­å­˜åœ¨ä¸€ä¸ªé€»è¾‘è®¾å¤‡äº†ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥å°±ä¸€èµ·æ•´ç†ä¸€ä¸‹è®¾å¤‡çš„ä¿¡æ¯ï¼Œç„¶åæŠŠå®ƒä»¬å˜æˆä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>typedef struct s_DEVID\n{\n    uint_t  dev_mtype;//è®¾å¤‡ç±»å‹å·\n    uint_t  dev_stype; //è®¾å¤‡å­ç±»å‹å·\n    uint_t  dev_nr; //è®¾å¤‡åºå·\n}devid_t;\ntypedef struct s_DEVICE\n{\n    list_h_t    dev_list;//è®¾å¤‡é“¾è¡¨\n    list_h_t    dev_indrvlst; //è®¾å¤‡åœ¨é©±åŠ¨ç¨‹åºæ•°æ®ç»“æ„ä¸­å¯¹åº”çš„æŒ‚è½½é“¾è¡¨\n    list_h_t    dev_intbllst; //è®¾å¤‡åœ¨è®¾å¤‡è¡¨æ•°æ®ç»“æ„ä¸­å¯¹åº”çš„æŒ‚è½½é“¾è¡¨\n    spinlock_t  dev_lock; //è®¾å¤‡è‡ªæ—‹é”\n    uint_t      dev_count; //è®¾å¤‡è®¡æ•°\n    sem_t       dev_sem; //è®¾å¤‡ä¿¡å·é‡\n    uint_t      dev_stus; //è®¾å¤‡çŠ¶æ€\n    uint_t      dev_flgs; //è®¾å¤‡æ ‡å¿—\n    devid_t      dev_id; //è®¾å¤‡ID\n    uint_t      dev_intlnenr; //è®¾å¤‡ä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„ä¸ªæ•°\n    list_h_t    dev_intserlst; //è®¾å¤‡ä¸­æ–­æœåŠ¡ä¾‹ç¨‹çš„é“¾è¡¨\n    list_h_t    dev_rqlist; //å¯¹è®¾å¤‡çš„è¯·æ±‚æœåŠ¡é“¾è¡¨\n    uint_t      dev_rqlnr; //å¯¹è®¾å¤‡çš„è¯·æ±‚æœåŠ¡ä¸ªæ•°\n    sem_t       dev_waitints; //ç”¨äºç­‰å¾…è®¾å¤‡çš„ä¿¡å·é‡\n    struct s_DRIVER* dev_drv; //è®¾å¤‡å¯¹åº”çš„é©±åŠ¨ç¨‹åºæ•°æ®ç»“æ„çš„æŒ‡é’ˆ\n    void* dev_attrb; //è®¾å¤‡å±æ€§æŒ‡é’ˆ\n    void* dev_privdata; //è®¾å¤‡ç§æœ‰æ•°æ®æŒ‡é’ˆ\n    void* dev_userdata;//å°†æ¥æ‰©å±•æ‰€ç”¨\n    void* dev_extdata;//å°†æ¥æ‰©å±•æ‰€ç”¨\n    char_t* dev_name; //è®¾å¤‡å\n}device_t;\n</code></pre><p>è®¾å¤‡çš„ä¿¡æ¯æ¯”è¾ƒå¤šï¼Œå¤§å¤šæ˜¯ç”¨äºç»„ç»‡è®¾å¤‡çš„ã€‚è¿™é‡Œçš„<strong>è®¾å¤‡IDç»“æ„ååˆ†é‡è¦</strong>ï¼Œå®ƒè¡¨ç¤ºè®¾å¤‡çš„ç±»å‹ã€è®¾å¤‡å·ï¼Œå­è®¾å¤‡å·æ˜¯ä¸ºäº†è§£å†³å¤šä¸ªç›¸åŒè®¾å¤‡çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªæŒ‡å‘è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æŒ‡é’ˆï¼Œè¿™æ˜¯ç”¨äºè®¿é—®è®¾å¤‡æ—¶è°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºçš„ï¼Œåªè¦æœ‰äººå»ºç«‹äº†ä¸€ä¸ªè®¾å¤‡ç»“æ„çš„å®ä¾‹å˜é‡ï¼Œå†…æ ¸å°±èƒ½æ„ŸçŸ¥åˆ°ä¸€ä¸ªè®¾å¤‡å­˜åœ¨äº†ã€‚</p><p>è‡³äºæ˜¯è°å»ºç«‹äº†è®¾å¤‡ç»“æ„çš„å®ä¾‹å˜é‡ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬æ¥ç€æ¢ç´¢ã€‚</p><h3>é©±åŠ¨</h3><p>æ“ä½œç³»ç»Ÿå†…æ ¸å’Œåº”ç”¨ç¨‹åºéƒ½ä¸ä¼šä¸»åŠ¨å»ºç«‹è®¾å¤‡ï¼Œé‚£ä¹ˆè°æ¥å»ºç«‹è®¾å¤‡å‘¢ï¼Ÿå½“ç„¶æ˜¯æ§åˆ¶è®¾å¤‡çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<strong>é©±åŠ¨ç¨‹åº</strong>ã€‚</p><p>é‚£ä¹ˆé©±åŠ¨ç¨‹åºå¦‚ä½•è¡¨ç¤ºå‘¢ï¼Œæ¢å¥è¯è¯´ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸æ˜¯å¦‚ä½•æ„ŸçŸ¥åˆ°ä¸€ä¸ªé©±åŠ¨ç¨‹åºçš„å­˜åœ¨å‘¢ï¼Ÿ</p><p>æ ¹æ®å‰é¢çš„ç»éªŒï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ•°æ®ç»“æ„æ¥è¡¨ç¤ºä¸€ä¸ªé©±åŠ¨ç¨‹åºï¼Œæ•°æ®ç»“æ„ä¸­åº”è¯¥åŒ…å«é©±åŠ¨ç¨‹åºåï¼Œé©±åŠ¨ç¨‹åºIDï¼Œé©±åŠ¨ç¨‹åºæ‰€ç®¡ç†çš„è®¾å¤‡ï¼Œæœ€é‡è¦çš„æ˜¯<strong>å®ŒæˆåŠŸèƒ½è®¾å¤‡ç›¸å…³åŠŸèƒ½çš„å‡½æ•°</strong>ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®šä¹‰å®ƒï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>typedef struct s_DRIVER\n{\n    spinlock_t drv_lock; //ä¿æŠ¤é©±åŠ¨ç¨‹åºæ•°æ®ç»“æ„çš„è‡ªæ—‹é”\n    list_h_t drv_list;//æŒ‚è½½é©±åŠ¨ç¨‹åºæ•°æ®ç»“æ„çš„é“¾è¡¨\n    uint_t drv_stuts; //é©±åŠ¨ç¨‹åºçš„ç›¸å…³çŠ¶æ€\n    uint_t drv_flg; //é©±åŠ¨ç¨‹åºçš„ç›¸å…³æ ‡å¿—\n    uint_t drv_id; //é©±åŠ¨ç¨‹åºID\n    uint_t drv_count; //é©±åŠ¨ç¨‹åºçš„è®¡æ•°å™¨\n    sem_t drv_sem; //é©±åŠ¨ç¨‹åºçš„ä¿¡å·é‡\n    void* drv_safedsc; //é©±åŠ¨ç¨‹åºçš„å®‰å…¨ä½“\n    void* drv_attrb; //LMOSEMå†…æ ¸è¦æ±‚çš„é©±åŠ¨ç¨‹åºå±æ€§ä½“\n    void* drv_privdata; //é©±åŠ¨ç¨‹åºç§æœ‰æ•°æ®çš„æŒ‡é’ˆ\n    drivcallfun_t drv_dipfun[IOIF_CODE_MAX]; //é©±åŠ¨ç¨‹åºåŠŸèƒ½æ´¾å‘å‡½æ•°æŒ‡é’ˆæ•°ç»„\n    list_h_t drv_alldevlist; //æŒ‚è½½é©±åŠ¨ç¨‹åºæ‰€ç®¡ç†çš„æ‰€æœ‰è®¾å¤‡çš„é“¾è¡¨\n    drventyexit_t drv_entry; //é©±åŠ¨ç¨‹åºçš„å…¥å£å‡½æ•°æŒ‡é’ˆ\n    drventyexit_t drv_exit; //é©±åŠ¨ç¨‹åºçš„é€€å‡ºå‡½æ•°æŒ‡é’ˆ\n    void* drv_userdata;//ç”¨äºå°†æ¥æ‰©å±•\n    void* drv_extdata; //ç”¨äºå°†æ¥æ‰©å±•\n    char_t* drv_name; //é©±åŠ¨ç¨‹åºçš„åå­—\n}driver_t;\n</code></pre><p>ä¸Šè¿°ä»£ç ï¼Œä½ åº”è¯¥å¾ˆå®¹æ˜“çœ‹æ‡‚ã€‚Cosmoså†…æ ¸æ¯åŠ è½½ä¸€ä¸ªé©±åŠ¨ç¨‹åºæ¨¡å—ï¼Œå°±ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé©±åŠ¨ç¨‹åºæ•°æ®ç»“æ„å¹¶ä¸”å°†å…¶å®ä¾‹åŒ–ã€‚</p><p>è€ŒCosmoså†…æ ¸åœ¨é¦–æ¬¡å¯åŠ¨é©±åŠ¨ç¨‹åºæ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªé©±åŠ¨ç¨‹åºçš„å…¥å£ç‚¹å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­é©±åŠ¨ç¨‹åºä¼šåˆ†é…ä¸€ä¸ªè®¾å¤‡æ•°æ®ç»“æ„ï¼Œå¹¶ç”¨ç›¸å…³çš„ä¿¡æ¯å°†å…¶å®ä¾‹åŒ–ï¼Œæ¯”å¦‚å¡«å†™æ­£ç¡®çš„è®¾å¤‡ç±»å‹ã€è®¾å¤‡IDå·ã€è®¾å¤‡åç§°ç­‰ã€‚</p><p>Cosmoså†…æ ¸è´Ÿè´£å»ºç«‹é©±åŠ¨æ•°æ®ç»“æ„ï¼Œè€Œé©±åŠ¨ç¨‹åºåˆå»ºç«‹äº†è®¾å¤‡æ•°æ®ç»“æ„ï¼Œè¿™ä¸€æ¥äºŒå»ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªé©±åŠ¨ç¨‹åºä¸Cosmoså†…æ ¸<strong>â€œæ¡æ‰‹â€</strong>çš„åŠ¨ä½œã€‚</p><h3>è®¾å¤‡é©±åŠ¨çš„ç»„ç»‡</h3><p>æœ‰äº†è®¾å¤‡ã€é©±åŠ¨ï¼Œæˆ‘ä»¬ä¸‹é¢æ¢ç´¢ä¸€ä¸‹æ€ä¹ˆåˆç†çš„ç»„ç»‡å¥½å®ƒä»¬ã€‚</p><p>ç»„ç»‡å®ƒä»¬è¦è§£å†³çš„é—®é¢˜ï¼Œå°±æ˜¯åœ¨å“ªé‡Œå®‰æ”¾é©±åŠ¨ã€‚ç„¶åæˆ‘ä»¬è¿˜è¦æƒ³å¥½æ€ä¹ˆæ‰¾åˆ°å®ƒä»¬ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨ä¸€ä¸ªå«åš<strong>è®¾å¤‡è¡¨</strong>çš„æ•°æ®ç»“æ„ï¼Œæ¥ç»„ç»‡è¿™äº›é©±åŠ¨ç¨‹åºæ•°æ®ç»“æ„å’Œè®¾å¤‡æ•°æ®ç»“æ„ã€‚</p><p>è¿™ä¸ªç»“æ„æˆ‘å·²ç»å¸®ä½ å®šä¹‰å¥½äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#define DEVICE_MAX 34\ntypedef struct s_DEVTLST\n{\n    uint_t dtl_type;//è®¾å¤‡ç±»å‹\n    uint_t dtl_nr;//è®¾å¤‡è®¡æ•°\n    list_h_t dtl_list;//æŒ‚è½½è®¾å¤‡device_tç»“æ„çš„é“¾è¡¨\n}devtlst_t;\ntypedef struct s_DEVTABLE\n{\n    list_h_t devt_list; //è®¾å¤‡è¡¨è‡ªèº«çš„é“¾è¡¨\n    spinlock_t devt_lock; //è®¾å¤‡è¡¨è‡ªæ—‹é”\n    list_h_t devt_devlist; //å…¨å±€è®¾å¤‡é“¾è¡¨\n    list_h_t devt_drvlist; //å…¨å±€é©±åŠ¨ç¨‹åºé“¾è¡¨ï¼Œé©±åŠ¨ç¨‹åºä¸éœ€è¦åˆ†ç±»ï¼Œä¸€ä¸ªé“¾è¡¨å°±è¡Œ\n    uint_t   devt_devnr; //å…¨å±€è®¾å¤‡è®¡æ•°\n    uint_t   devt_drvnr; //å…¨å±€é©±åŠ¨ç¨‹åºè®¡æ•°\n    devtlst_t devt_devclsl[DEVICE_MAX]; //åˆ†ç±»å­˜æ”¾è®¾å¤‡æ•°æ®ç»“æ„çš„devtlst_tç»“æ„æ•°ç»„\n}devtable_t;\n</code></pre><p>åœ¨è¿™æ®µä»£ç çš„devtable_tç»“æ„ä¸­ï¼Œdevtlst_tæ˜¯æ¯ä¸ªè®¾å¤‡ç±»å‹ä¸€ä¸ªï¼Œè¡¨ç¤ºä¸€ç±»è®¾å¤‡ï¼Œä½†æ¯ä¸€ç±»å¯èƒ½æœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ‰€ä»¥åœ¨devtlst_tç»“æ„ä¸­ï¼Œæœ‰ä¸€ä¸ªè®¾å¤‡è®¡æ•°å’Œè®¾å¤‡é“¾è¡¨ã€‚è€Œä½ å¯èƒ½æƒ³åˆ°Cosmosä¸­è‚¯å®šè¦å®šä¹‰ä¸€ä¸ªdevtable_tç»“æ„çš„å…¨å±€å˜é‡ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>//åœ¨ cosmos/kernel/krlglobal.cæ–‡ä»¶ä¸­\nKRL_DEFGLOB_VARIABLE(devtable_t,osdevtable);\n//åœ¨ cosmos/kernel/krldevice.cæ–‡ä»¶ä¸­\nvoid devtlst_t_init(devtlst_t *initp, uint_t dtype)\n{\n    initp-&gt;dtl_type = dtype;//è®¾ç½®è®¾å¤‡ç±»å‹    initp-&gt;dtl_nr = 0;\n    list_init(&amp;initp-&gt;dtl_list);\n    return;\n}\nvoid devtable_t_init(devtable_t *initp)\n{\n    list_init(&amp;initp-&gt;devt_list);\n    krlspinlock_init(&amp;initp-&gt;devt_lock);\n    list_init(&amp;initp-&gt;devt_devlist);\n    list_init(&amp;initp-&gt;devt_drvlist);\n    initp-&gt;devt_devnr = 0;\n    initp-&gt;devt_drvnr = 0;\n    for (uint_t t = 0; t &lt; DEVICE_MAX; t++)\n    {//åˆå§‹åŒ–è®¾å¤‡é“¾è¡¨\n        devtlst_t_init(&amp;initp-&gt;devt_devclsl[t], t);\n    }\n    return;\n}\nvoid init_krldevice()\n{\n    devtable_t_init(&amp;osdevtable);//åˆå§‹åŒ–ç³»ç»Ÿå…¨å±€è®¾å¤‡è¡¨\n    return;\n}\n//åœ¨ cosmos/kernel/krlinit.cæ–‡ä»¶ä¸­\nvoid init_krl()\n{\n    init_krlmm();\n    init_krldevice();\n    //è®°ä½ä¸€å®šè¦åœ¨åˆå§‹åŒ–è°ƒåº¦å™¨ä¹‹å‰ï¼Œåˆå§‹åŒ–è®¾å¤‡è¡¨\n    init_krlsched();\n    init_krlcpuidle();\n    return;\n}\n</code></pre><p>ä¸Šé¢çš„è®¾å¤‡è¡¨çš„åˆå§‹åŒ–ä»£ç å·²ç»å†™å¥½äº†ï¼Œå¦‚æœä½ å¤§è„‘ä¸­æ²¡æœ‰è®¾å¤‡é©±åŠ¨ç»„ç»‡å›¾ï¼Œå¯èƒ½è„‘å­é‡Œè¿˜æ˜¯æœ‰ç‚¹ä¹±ï¼Œæ‰€ä»¥æˆ‘æ¥å¸®ä½ ç”»ä¸€å¹…å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/17/9f/17d232bd17b0c328yyed37bab98baa9f.jpg?wh=5008x4580\" alt=\"\" title=\"è®¾å¤‡è¡¨ç»“æ„ç¤ºæ„å›¾\"></p><p>ä¸Šå›¾çœ‹ä¼¼å¤æ‚ï¼Œå®åˆ™ç®€å•ï¼Œæˆ‘å¸®ä½ ç†ä¸€ä¸‹é‡ç‚¹ï¼šé¦–å…ˆdevtable_tç»“æ„ä¸­èƒ½æ‰¾åˆ°æ‰€æœ‰çš„è®¾å¤‡å’Œé©±åŠ¨ï¼Œç„¶åä»è®¾å¤‡èƒ½æ‰¾åˆ°å¯¹åº”çš„é©±åŠ¨ï¼Œä»é©±åŠ¨ä¹Ÿèƒ½æ‰¾åˆ°å…¶ç®¡ç†çš„æ‰€æœ‰è®¾å¤‡ ï¼Œæœ€åå°±èƒ½å®ç°ä¸€ä¸ªé©±åŠ¨ç®¡ç†å¤šä¸ªè®¾å¤‡ã€‚</p><h3>é©±åŠ¨ç¨‹åºåŠŸèƒ½</h3><p>æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œé‚£å°±æ˜¯é©±åŠ¨ç¨‹åºï¼Œç©¶ç«Ÿè¦ä¸ºæ“ä½œç³»ç»Ÿå†…æ ¸æä¾›å“ªäº›æœ€åŸºæœ¬çš„åŠŸèƒ½æ”¯æŒï¼Ÿ</p><p>æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œå†™é©±åŠ¨ç¨‹åºå°±æ˜¯ä¸ºäº†æ“æ§ç›¸åº”çš„è®¾å¤‡ï¼Œæ‰€ä»¥è¿™å¾—çœ‹å¤§å¤šæ•°è®¾å¤‡èƒ½å®Œæˆä»€ä¹ˆåŠŸèƒ½äº†ã€‚ç°ä»£è®¡ç®—æœºçš„è®¾å¤‡æ— éå°±æ˜¯å¯ä»¥è¾“å…¥æ•°æ®ã€å¤„ç†æ•°æ®ã€è¾“å‡ºæ•°æ®ï¼Œç„¶åå®Œæˆä¸€äº›ç‰¹æ®Šçš„åŠŸèƒ½ã€‚</p><p>å½“ç„¶ï¼Œç°ä»£è®¡ç®—æœºçš„è®¾å¤‡å¾ˆå¤šï¼Œèƒ½è€—æ˜¯ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿå†…æ ¸åº”è¯¥èƒ½æ§åˆ¶è®¾å¤‡èƒ½è€—ã€‚ä¸‹é¢æˆ‘æ¥å¸®ä½ å½’çº³ä¸€ä¸‹ç”¨æ¥é©±åŠ¨ç¨‹åºçš„å‡ ç§ä¸»è¦å‡½æ•°ï¼Œå¦‚ä¸‹ã€‚</p><pre><code>//é©±åŠ¨ç¨‹åºå…¥å£å’Œé€€å‡ºå‡½æ•°\ndrvstus_t device_entry(driver_t* drvp,uint_t val,void* p);\ndrvstus_t device_exit(driver_t* drvp,uint_t val,void* p);\n//è®¾å¤‡ä¸­æ–­å¤„ç†å‡½æ•°\ndrvstus_t device_handle(uint_t ift_nr,void* devp,void* sframe);\n//æ‰“å¼€ã€å…³é—­è®¾å¤‡å‡½æ•°\ndrvstus_t device_open(device_t* devp,void* iopack);\ndrvstus_t device_close(device_t* devp,void* iopack);\n//è¯»ã€å†™è®¾å¤‡æ•°æ®å‡½æ•°\ndrvstus_t device_read(device_t* devp,void* iopack);\ndrvstus_t device_write(device_t* devp,void* iopack);\n//è°ƒæ•´è¯»å†™è®¾å¤‡æ•°æ®ä½ç½®å‡½æ•°\ndrvstus_t device_lseek(device_t* devp,void* iopack);\n//æ§åˆ¶è®¾å¤‡å‡½æ•°\ndrvstus_t device_ioctrl(device_t* devp,void* iopack);\n//å¼€å¯ã€åœæ­¢è®¾å¤‡å‡½æ•°\ndrvstus_t device_dev_start(device_t* devp,void* iopack);\ndrvstus_t device_dev_stop(device_t* devp,void* iopack);\n//è®¾ç½®è®¾å¤‡ç”µæºå‡½æ•°\ndrvstus_t device_set_powerstus(device_t* devp,void* iopack);\n//æšä¸¾è®¾å¤‡å‡½æ•°\ndrvstus_t device_enum_dev(device_t* devp,void* iopack);\n//åˆ·æ–°è®¾å¤‡ç¼“å­˜å‡½æ•°\ndrvstus_t device_flush(device_t* devp,void* iopack);\n//è®¾å¤‡å…³æœºå‡½æ•°\ndrvstus_t device_shutdown(device_t* devp,void* iopack);\n</code></pre><p>å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸€ä¸ªæ“ä½œå®šä¹‰æˆä¸€ä¸ªå‡½æ•°ï¼Œè®©é©±åŠ¨ç¨‹åºå®ç°è¿™äº›å‡½æ•°ã€‚å‡½æ•°åä½ å¯ä»¥éšä¾¿å†™ï¼Œä½†æ˜¯å‡½æ•°çš„å½¢å¼å´ä¸èƒ½æ”¹å˜ï¼Œè¿™æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ä¸é©±åŠ¨ç¨‹åºæ²Ÿé€šçš„æ¡¥æ¢ã€‚å½“ç„¶æœ‰å¾ˆå¤šè®¾å¤‡æœ¬èº«å¹¶ä¸æ”¯æŒè¿™ä¹ˆå¤šæ“ä½œï¼Œä¾‹å¦‚æ—¶é’Ÿè®¾å¤‡ï¼Œé©±åŠ¨ç¨‹åºå°±ä¸å¿…å®ç°ç›¸åº”çš„æ“ä½œã€‚</p><p>é‚£ä¹ˆè¿™äº›å‡½æ•°å¦‚ä½•å’Œæ“ä½œç³»ç»Ÿå†…æ ¸å…³è”èµ·æ¥å‘¢ï¼Ÿè¿˜è®°å¾—driver_tç»“æ„ä¸­é‚£ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„å—ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#define IOIF_CODE_OPEN 0 //å¯¹åº”äºopenæ“ä½œ\n#define IOIF_CODE_CLOSE 1 //å¯¹åº”äºcloseæ“ä½œ\n#define IOIF_CODE_READ 2 //å¯¹åº”äºreadæ“ä½œ\n#define IOIF_CODE_WRITE 3 //å¯¹åº”äºwriteæ“ä½œ\n#define IOIF_CODE_LSEEK 4 //å¯¹åº”äºlseekæ“ä½œ\n#define IOIF_CODE_IOCTRL 5 //å¯¹åº”äºioctrlæ“ä½œ\n#define IOIF_CODE_DEV_START 6 //å¯¹åº”äºstartæ“ä½œ\n#define IOIF_CODE_DEV_STOP 7 //å¯¹åº”äºstopæ“ä½œ\n#define IOIF_CODE_SET_POWERSTUS 8 //å¯¹åº”äºpowerstusæ“ä½œ\n#define IOIF_CODE_ENUM_DEV 9 //å¯¹åº”äºenumæ“ä½œ\n#define IOIF_CODE_FLUSH 10 //å¯¹åº”äºflushæ“ä½œ\n#define IOIF_CODE_SHUTDOWN 11 //å¯¹åº”äºshutdownæ“ä½œ\n#define IOIF_CODE_MAX 12 //æœ€å¤§åŠŸèƒ½ç \n//é©±åŠ¨ç¨‹åºåˆ†æ´¾å‡½æ•°æŒ‡é’ˆç±»å‹\ntypedef drvstus_t (*drivcallfun_t)(device_t*,void*);\n//é©±åŠ¨ç¨‹åºå…¥å£ã€é€€å‡ºå‡½æ•°æŒ‡é’ˆç±»å‹\ntypedef drvstus_t (*drventyexit_t)(struct s_DRIVER*,uint_t,void*);\ntypedef struct s_DRIVER\n{\n    //â€¦â€¦\n    drivcallfun_t drv_dipfun[IOIF_CODE_MAX];//é©±åŠ¨ç¨‹åºåˆ†æ´¾å‡½æ•°æŒ‡é’ˆæ•°ç»„ã€‚\n    list_h_t drv_alldevlist;//é©±åŠ¨æ‰€ç®¡ç†çš„æ‰€æœ‰è®¾å¤‡ã€‚\n    drventyexit_t drv_entry;\n    drventyexit_t drv_exit;\n    //â€¦â€¦\n}driver_t;\n</code></pre><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ æ˜¯ä¸æ˜¯æ˜ç™½äº†ï¼Ÿdriver_tç»“æ„ä¸­çš„drv_dipfunå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ­£æ˜¯å­˜æ”¾ä¸Šè¿°é‚£12ä¸ªé©±åŠ¨ç¨‹åºå‡½æ•°çš„æŒ‡é’ˆã€‚è¿™æ ·æ“ä½œç³»ç»Ÿå†…æ ¸å°±èƒ½é€šè¿‡driver_tç»“æ„ï¼Œè°ƒç”¨åˆ°å¯¹åº”çš„é©±åŠ¨ç¨‹åºå‡½æ•°æ“ä½œå¯¹åº”çš„è®¾å¤‡äº†ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬ææ˜ç™½äº†ä¸€ä¸ªå…¸å‹è®¡ç®—æœºçš„ç»“æ„ï¼Œé‡Œé¢æœ‰å¾ˆå¤šè®¾å¤‡ï¼Œéœ€è¦æ“ä½œç³»ç»Ÿåˆç†åœ°ç®¡ç†ï¼Œè€Œæ“ä½œç³»ç»Ÿé€šè¿‡åŠ è½½é©±åŠ¨ç¨‹åºæ¥ç®¡ç†å’Œä½¿ç”¨è®¾å¤‡ï¼Œå¹¶ä¸ºæ­¤æä¾›äº†ä¸€ç³»åˆ—çš„æœºåˆ¶ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚</p><p>1.è®¡ç®—æœºç»“æ„ï¼Œæˆ‘ä»¬é€šè¿‡äº†è§£ä¸€ä¸ªå…¸å‹çš„è®¡ç®—æœºç³»ç»Ÿç»“æ„ï¼Œæ˜ç™½äº†è®¾å¤‡çš„å¤šæ ·æ€§ã€‚ç„¶åæˆ‘ä»¬å¯¹è®¾å¤‡åšäº†æŠ½è±¡åˆ†ç±»ï¼Œé‡‡ç”¨åˆ†æƒè€Œæ²»çš„æ–¹å¼ï¼Œè®©æ“ä½œç³»ç»Ÿé€šè¿‡é©±åŠ¨ç¨‹åºæ¥ç®¡ç†è®¾å¤‡ï¼ŒåŒæ—¶åˆèƒ½ä¿è¯æ“ä½œç³»ç»Ÿå’Œé©±åŠ¨ç¨‹åºåˆ†ç¦»ï¼Œè¾¾åˆ°æ“ä½œç³»ç»Ÿå’Œè®¾å¤‡è§£è€¦çš„ç›®çš„ã€‚</p><p>2.å½’çº³æ•´ç†è®¾å¤‡å’Œè®¾å¤‡é©±åŠ¨çš„ä¿¡æ¯ï¼ŒæŠ½è±¡ä¸¤ä¸ªå¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸¤ä¸ªæ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­çš„å®ä¾‹å˜é‡å°±ä»£è¡¨ä¸€ä¸ªè®¾å¤‡å’Œå¯¹åº”çš„é©±åŠ¨ã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡è®¾å¤‡è¡¨ç»“æ„ç»„ç»‡äº†é©±åŠ¨å’Œè®¾å¤‡çš„æ•°æ®ç»“æ„ã€‚</p><p>3.é©±åŠ¨ç¨‹åºæœ€ä¸»è¦çš„å·¥ä½œæ˜¯è¦æ“æ§è®¾å¤‡ï¼Œä½†è¿™äº›ä¸ªæ“ä½œè®¾å¤‡çš„åŠ¨ä½œæ˜¯æ“ä½œç³»ç»Ÿè°ƒç”¨çš„ï¼Œæ‰€ä»¥å¯¹é©±åŠ¨å®šä¹‰äº†å¿…é¡»è¦æ”¯æŒçš„12ç§æ ‡å‡†æ–¹æ³•ï¼Œå¹¶å¯¹åº”åˆ°å‡½æ•°ï¼Œè¿™äº›å‡½æ•°çš„åœ°å€ä¿å­˜åœ¨é©±åŠ¨ç¨‹åºçš„æ•°æ®ç»“æ„ä¸­ã€‚</p><p>ä½ å¯èƒ½åœ¨æƒ³ï¼Œæˆ‘ä»¬é©±åŠ¨ç¨‹åºæ˜¯æ€ä¹ˆåŠ è½½çš„ï¼Œè®¾å¤‡åˆæ˜¯æ€ä¹ˆå»ºç«‹çš„å‘¢ï¼Ÿè¿™æ˜¯æ­£æ˜¯æˆ‘ä»¬åé¢è¯¾ç¨‹è¦è§£å†³çš„ã€‚ä¸è¿‡ä½ å¯ä»¥å…ˆå¼€åŠ¨è„‘ç­‹ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œæå‡ºä½ è‡ªå·±çš„è§è§£ï¼Œè€ƒè™‘ä¸€ä¸‹è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·ä½ å†™å‡ºä¸€ä¸ªç”¨æ¥è®¿é—®è®¾å¤‡çš„æ¥å£å‡½æ•°ï¼Œæˆ–è€…æƒ³ä¸€ä¸‹è®¿é—®ä¸€ä¸ªè®¾å¤‡éœ€è¦ä»€ä¹ˆå‚æ•°ã€‚</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµäº’åŠ¨ï¼Œç§¯æè¾“å‡ºæœ‰åŠ©äºæ›´é«˜æ•ˆåœ°ç†è§£è¿™èŠ‚è¯¾çš„å†…å®¹ã€‚ä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™åŒäº‹ã€æœ‹å‹ã€‚</p><p>å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>","comments":[{"had_liked":false,"id":303163,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":true,"comment_ctime":1626625154,"is_pvip":false,"replies":[{"id":"109729","content":"æ€»ç»“çš„å¥½","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1626661043,"ip_address":"","comment_id":303163,"utype":1}],"discussion_count":1,"race_medal":0,"score":"9.2233720642511995e+18","product_id":100078401,"comment_content":"ä¸€ã€æ•°æ®ç»“æ„<br>æœ‰ä¸€ä¸ªå…¨å±€devtable_tç»“æ„å˜é‡osdevtableï¼Œç”¨äºç®¡ç†å…¨éƒ¨é©±åŠ¨ç¨‹åºåŠè®¾å¤‡ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š<br>Aã€å…¨å±€é©±åŠ¨ç¨‹åºé“¾è¡¨ï¼Œä¿å­˜å…¨éƒ¨é©±åŠ¨ã€driver_tç»“æ„ã€‘<br>Bã€å…¨å±€è®¾å¤‡é“¾è¡¨ï¼ŒåŒ…æ‹¬å„ç§è®¾å¤‡ç±»å‹çš„é“¾è¡¨ã€devtlst_tç»“æ„ã€‘ï¼Œæ¯ä¸ªdevtlst_tä¸­åŒ…æ‹¬äº†æŸä¸€ç±»å‹çš„å…¨éƒ¨è®¾å¤‡é“¾è¡¨ã€device_tç»“æ„ã€‘<br><br>device_tç”¨äºæè¿°ä¸€ä¸ªè®¾å¤‡ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š<br>Aã€devid_tç”¨äºæè¿°è®¾å¤‡IDã€åŒ…æ‹¬è®¾å¤‡ç±»å‹ã€è®¾å¤‡å­ç±»å‹ã€è®¾å¤‡åºåˆ—å·ç­‰ã€‘<br>Bã€driver_tæŒ‡é’ˆç”¨äºæŒ‡å‘è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œä»è®¾å¤‡å¯ä»¥æ‰¾åˆ°é©±åŠ¨<br><br>driver_tç”¨äºæè¿°ä¸€ä¸ªé©±åŠ¨ç¨‹åºï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š<br>Aã€é©±åŠ¨åŠŸèƒ½å‡½æ•°æŒ‡é’ˆæ•°ç»„drivcallfun_t[]<br>Bã€åŒ…æ‹¬ä½¿ç”¨è¯¥é©±åŠ¨ç¨‹åºçš„å…¨éƒ¨è®¾å¤‡çš„åˆ—è¡¨ï¼Œä»é©±åŠ¨å¯ä»¥æ‰¾åˆ°è®¾å¤‡<br><br>äºŒã€é©±åŠ¨ç¨‹åºï¼Œå‡½æ•°æœ‰ä¸‰ç±»<br>è®¾å¤‡ä¸­æ–­å¤„ç†å‡½æ•°<br>é©±åŠ¨å…¥å£å’Œé€€å‡ºå‡½æ•°<br>é©±åŠ¨åŠŸèƒ½å‡½æ•°<br><br>ä¸‰ã€åˆå§‹åŒ–<br>init_krl-&gt;init_krldevice-&gt;devtable_t_init<br>-&gt;åˆå§‹åŒ–å…¨å±€è®¾å¤‡åˆ—è¡¨<br>-&gt;åˆå§‹åŒ–å…¨å±€é©±åŠ¨åˆ—è¡¨<br>-&gt;å¯¹äºæ¯ç±»è®¾å¤‡ï¼Œåˆå§‹åŒ–devtlst_tç»“æ„","like_count":7,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523570,"discussion_content":"æ€»ç»“çš„å¥½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626661043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302325,"user_name":"é’ç‰ç™½éœ²","can_delete":false,"product_type":"c1","uid":2619436,"ip_address":"","ucode":"96FE2D4D2B94A0","user_header":"https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg","comment_is_top":false,"comment_ctime":1626166740,"is_pvip":false,"replies":[{"id":"109425","content":"å¥½çš„ ","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1626228217,"ip_address":"","comment_id":302325,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10216101332","product_id":100078401,"comment_content":"è®¿é—®ä¸€ä¸ªè®¾å¤‡çš„æ¥å£å‡½æ•°å¤§è‡´å¦‚ä¸‹ï¼š<br>drvstus_t device_getdata(device_t* devp,void* iopack);<br>å…¶ä¸­ï¼Œdevice* æŒ‡å‘è®¾å¤‡æœ¬èº«çš„ç»“æ„ä½“ï¼Œç›¸å½“äºç»™è¿™ä¸ªå‡½æ•°ä¼ å…¥äº†è®¾å¤‡çš„å±æ€§å€¼ï¼›<br>è€Œvoid* iopackæ˜¯ä¸€ä¸ªæ— å±æ€§çš„å†…å­˜å—ï¼Œå…·ä½“éœ€è¦ä¼ å…¥ä»€ä¹ˆå‚æ•°ï¼Œæ ¹æ®è®¿é—®è¯¥è®¾å¤‡å°†è¦å®ç°çš„åŠŸèƒ½è€Œå®šã€‚<br>å½­è€å¸ˆåŠ æ²¹ï¼æˆ‘è¿™ä¸¤å¤©ç»ˆäºæŠŠä¹‹å‰å›¤çš„åå‡ èŠ‚è¯¾çœ‹å®Œäº†ï¼Œç­‰å‘¨æœ«å†™å‡ ç¯‡åšå®¢æ€»ç»“ä¸€ä¸‹ï¼","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523261,"discussion_content":"å¥½çš„ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626228217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2098652,"avatar":"https://static001.geekbang.org/account/avatar/00/20/05/dc/b501933a.jpg","nickname":"æœ‰æ‰‹ä¹Ÿä¸è¡Œ","note":"","ucode":"D55D23A2C4517E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385618,"discussion_content":"å¤§ä½¬ç•™ä¸ªåšå®¢é“¾æ¥å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627182475,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302030,"user_name":"ğŸ™ƒ","can_delete":false,"product_type":"c1","uid":2170263,"ip_address":"","ucode":"6E41B3D10A33CA","user_header":"https://static001.geekbang.org/account/avatar/00/21/1d/97/9a8b2d0c.jpg","comment_is_top":false,"comment_ctime":1626050387,"is_pvip":false,"replies":[{"id":"109280","content":"å“ˆå“ˆ æˆ‘åŠªåŠ›è®©å¤§å®¶æ»¡æ„","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1626056809,"ip_address":"","comment_id":302030,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10215984979","product_id":100078401,"comment_content":"å®~ å…ˆæ‰“ä¸ªå¡ ä¸Šä¸€èŠ‚è¿›ç¨‹è°ƒåº¦è®²çš„å¤ªç²¾å½©äº†ï¼Œç›¸ä¿¡è¿™ä¸€ç¯‡ä¹Ÿæ˜¯å®è—æ–‡ç« ","like_count":2,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523155,"discussion_content":"å“ˆå“ˆ æˆ‘åŠªåŠ›è®©å¤§å®¶æ»¡æ„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626056809,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302024,"user_name":"pedro","can_delete":false,"product_type":"c1","uid":1200704,"ip_address":"","ucode":"F40C839DDFD599","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg","comment_is_top":false,"comment_ctime":1626046969,"is_pvip":false,"replies":[{"id":"109281","content":"å¯ä»¥ å¯ä»¥","user_name":"ä½œè€…å›å¤","user_name_real":"LMOS","uid":"1345199","ctime":1626056827,"ip_address":"","comment_id":302024,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5921014265","product_id":100078401,"comment_content":"ç…§è‘«èŠ¦ç”»ç“¢:<br><br>&#47;&#47;è¯»è®¾å¤‡æ•°æ®å‡½æ•°<br>drvstus_t device_read(device_t* devp,void* iopack);","like_count":1,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523154,"discussion_content":"å¯ä»¥ å¯ä»¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626056827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345005,"user_name":"è‰¾æ©å‡","can_delete":false,"product_type":"c1","uid":2950704,"ip_address":"","ucode":"F2B81BF4F0106A","user_header":"https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg","comment_is_top":false,"comment_ctime":1651928526,"is_pvip":false,"replies":[{"id":"125958","content":"åŠ æ²¹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1345199","ctime":1652065279,"ip_address":"","comment_id":345005,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1651928526","product_id":100078401,"comment_content":"ä»£ç çœ‹çš„è¶Šæ¥è¶Šè½»æ¾äº†ï¼Œä¹Ÿæ›´å®¹æ˜“ç†è§£äº†ï¼Œè¿›åº¦ä¹ŸåŠ å¿«äº†ï¼Œæ‰“å¡","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571064,"discussion_content":"åŠ æ²¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652065279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324008,"user_name":"coconut","can_delete":false,"product_type":"c1","uid":2344081,"ip_address":"","ucode":"07B95C7A6AC2F7","user_header":"https://static001.geekbang.org/account/avatar/00/23/c4/91/a017bf72.jpg","comment_is_top":false,"comment_ctime":1638255384,"is_pvip":true,"replies":[{"id":"117619","content":"å¯¹çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1345199","ctime":1638322859,"ip_address":"","comment_id":324008,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1638255384","product_id":100078401,"comment_content":"æ¥å£å‚æ•°åº”è¯¥åŒ…å«:è®¾å¤‡idï¼Œæ“ä½œç±»å‹ï¼Œæ“ä½œæ•°","like_count":0,"discussions":[{"author":{"id":1345199,"avatar":"https://static001.geekbang.org/account/avatar/00/14/86/af/99219321.jpg","nickname":"LMOS","note":"","ucode":"B037712C8B8B3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534942,"discussion_content":"å¯¹çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638322859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}