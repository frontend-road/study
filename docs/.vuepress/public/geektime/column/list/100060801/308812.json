{"id":308812,"title":"模型实战准备（二） | 模型特征、训练样本的处理","content":"<p>你好，我是王喆，欢迎来到模型实战准备第二课。</p><p>这节课，我们来讲实战中所需的模型特征和训练样本的处理。为什么我们要专门花一节课的时间讲这些呢？因为在推荐模型篇中，我们的重点在于学习模型结构的原理和实现，而要实现并且训练这些模型，我们就必须先解决训练所需的样本和特征的处理问题。</p><p>这节课我们先来把模型实战的准备工作做完。具体来说，今天，我会带你用Spark来处理深度学习模型训练所需的样本和特征，再把特征存储到Redis中，供模型线上服务时调用。</p><h2>为什么选择Spark为TensorFlow处理特征和样本？</h2><p>这个时候，你可能会有疑问，我们的深度学习模型将在TensorFlow上进行训练，为什么要用Spark处理样本？可不可以直接让TensorFlow解决所有的事情呢？这是一个好问题，在我们学习具体的技术之前，先解决这个架构上的疑问是很有必要的。</p><p>在业界的实践中，我们需要记住一个原则，就是<strong>让合适的平台做合适的事情</strong>。比如说，数据处理是Spark的专长，流处理是Flink的专长，构建和训练模型是TensorFlow的专长。在使用这些平台的时候，我们最好能够用其所长，避其所短。这也是一个业界应用拥有那么多个模块、平台的原因。</p><!-- [[[read_end]]] --><p>你可能想说，TensorFlow也可以处理数据啊。没错，但是它并不擅长分布式的并行数据处理，在并行数据处理能力上，TensorFlow很难和动辄拥有几百上千个节点的Spark相比。那在面对海量数据的时候，如果我们能够利用Spark进行数据清洗、数据预处理、特征提取的话，最好的方案就是让Spark发挥它的长处，承担“繁重”但相对简单的样本和特征处理的工作，为TensorFlow减轻负担。</p><h2>物品和用户特征都有哪些？</h2><p>既然我们决定用Spark进行样本和特征处理，那下一个问题又接踵而来，我们能从MovieLens的数据集中抽取出什么特征呢？这就要用到我们在特征工程篇中学到的，关于推荐系统特征以及相关特征处理方法的知识，如果你记得还不够扎实，我建议你可以先回去复习一下。</p><p>MovieLens数据集中，可供我们提取特征的数据表有两个，分别是movies表和ratings表，它们的数据格式如下：</p><p><img src=\"https://static001.geekbang.org/resource/image/87/b8/87cd18e09550522e85ef81a8f30869b8.jpg?wh=1920*789\" alt=\"\" title=\"图1 电影基本数据movies表（左），用户评分数据ratings表（右）\"></p><p>接下来，我们按照“物品特征”“用户特征”“场景特征”，这三大类推荐系统特征的顺序，来看一看从这两张表中能提取出什么样的特征。</p><p>“物品特征”在我们的项目里指的就是电影特征了，从movies表中我们可以提取出电影的基本信息，包括movieId、title（电影名）、releaseYear（发布年份）和genre（风格类型）。除此之外，我们还可以利用ratings表为每个电影提取出一些统计类的特征，包括电影的平均评分、评分标准差等等。</p><p>接下来是“用户特征”。乍一看，从movies和ratings表中，除了userId我们好像找不到其他直接可用的用户信息了。这个时候，千万不要忘了我们之前提到过的，用户特征最重要的部分就是历史行为特征。</p><p>所以，从用户的评分历史中，我们其实可以提取出非常多有价值的特征。比如，我们可以根据ratings表的历史联合movies表的电影信息，提取出用户统计类特征，它包括用户评分总数、用户平均评分、用户评分标准差、用户好评电影的发布年份均值、用户好评电影的发布年份标准差、用户最喜欢的电影风格，以及用户好评电影ID等等。</p><p>最后是“场景特征”。我们可用的场景特征就一个，那就是评分的时间戳，我们把它作为代表时间场景的特征放到特征工程中。</p><p>好了，到这儿，我们就梳理完了所有可用的特征，我把它们总结在了下面的表格里，供你参考。</p><p><img src=\"https://static001.geekbang.org/resource/image/ae/d5/ae45f7d9020dcb406291b8519d0312d5.jpeg?wh=1920*1080\" alt=\"\" title=\"图2 所有可用的特征汇总表\"></p><p>用Spark来提取这些特征的总体实现会比较琐碎，所以我就不把全部代码贴在这里了，你可以参考SparrowRecsys项目中的com.wzhe.sparrowrecsys.offline.spark.featureeng.FeatureEngForRecModel对象，里面包含了所有特征工程的代码。这里，我们只讲几个有代表性的统计型特征的处理方法。</p><pre><code>val movieRatingFeatures = samplesWithMovies3.groupBy(col(&quot;movieId&quot;))\n  .agg(count(lit(1)).as(&quot;movieRatingCount&quot;),\n   avg(col(&quot;rating&quot;)).as(&quot;movieAvgRating&quot;),\n   stddev(col(&quot;rating&quot;)).as(&quot;movieRatingStddev&quot;))\n</code></pre><p>计算统计型特征的典型方法，就是利用Spark中的groupBy操作，将原始评分数据按照movieId分组，然后用agg聚合操作来计算一些统计型特征。比如，在上面的代码中，我们就分别使用了count内置聚合函数来统计电影评价次数（movieRatingCount），用avg函数来统计评分均值（movieAvgRating），以及使用stddev函数来计算评价分数的标准差（movieRatingStddev）。</p><p>特征处理具体过程，我们就讲完了。不过，这里我还想和你多分享一些我的经验。<strong>一般来说，我们不会人为预设哪个特征有用，哪个特征无用，而是让模型自己去判断，如果一个特征的加入没有提升模型效果，我们再去除这个特征。就像我刚才虽然提取了不少特征，但并不是说每个模型都会使用全部的特征，而是根据模型结构、模型效果有针对性地部分使用它们。</strong>在接下来的课程中，我们还会详细探讨不同模型对这些特征的具体使用方法。</p><h2>最终的训练样本是什么样的？</h2><p>特征提取之后就到了训练模型的步骤，为了训练模型，我们还需要生成模型所需的训练样本。这里我们需要明确两件事情，一是样本从哪里来，二是样本的标签是什么。这两件事情都跟我们训练模型的目标有关系。</p><p>对于一个推荐模型来说，它的根本任务是预测一个用户U对一个物品I在场景C下的喜好分数。所以在训练时，我们要为模型生成一组包含U、I、C的特征，以及最终真实得分的样本。在SparrowRecsys中，这样的样本就是基于评分数据ratings，联合用户、物品特征得来的。</p><p>其中，用户特征和物品特征都需要我们提前生成好，然后让它们与ratings数据进行join后，生成最终的训练样本，具体的实现也在FeatureEngForRecModel中，你可以先参考我在下面贴出的关键代码。这样，我们就解决了第一个关键问题。</p><pre><code>//读取原始ratings数据\nval ratingSamples = spark.read.format(&quot;csv&quot;).option(&quot;header&quot;, &quot;true&quot;).load(ratingsResourcesPath.getPath)\n//添加样本标签\nval ratingSamplesWithLabel = addSampleLabel(ratingSamples)\n//添加物品（电影）特征\nval samplesWithMovieFeatures = addMovieFeatures(movieSamples, ratingSamplesWithLabel)\n//添加用户特征\nval samplesWithUserFeatures = addUserFeatures(samplesWithMovieFeatures)\n</code></pre><p>接着，我们来看第二个关键问题，也就是样本的标签是什么，对于MovieLens数据集来说，用户对电影的评分是最直接的标签数据，因为它就是我们想要预测的用户对电影的评价，所以ratings表中的0-5的评分数据自然可以作为样本的标签。</p><p>但对于很多应用来说，我们基本上不可能拿到它们的评分数据，更多的是点击、观看、购买这些隐性的反馈数据，所以业界更多使用CTR预估这类解决二分类问题的模型去解决推荐问题。</p><p>为了让我们的实践过程更接近真实的应用场景，我也对MovieLens数据集进行了进一步处理。具体来说就是，把评分大于等于3.5分的样本标签标识为1，意为“喜欢”，评分小于3.5分的样本标签标识为0，意为“不喜欢”。这样一来，我们可以完全把推荐问题转换为CTR预估问题。</p><h2>如何在生成样本时避免引入“未来信息”？</h2><p>训练模型所需要的训练样本我们已经得到了，但是，在处理训练样本的时候，还有一个问题我们一定要注意，那就是引入未来信息（Future Information）的问题，这也是我们在实际工作中经常会遇到的问题。</p><p>什么叫做未来信息呢？如果我们在t时刻进行模型预测，那么t+1时刻的信息就是未来信息。这个问题在模型线上服务的时候是不存在的，因为未来的事情还未发生，我们不可能知道。但在离线训练的时候，我们就容易犯这样的错误。比如说，我们利用t时刻的样本进行训练，但是使用了全量的样本生成特征，这些特征就包含了t+1时刻的未来信息，这就是一个典型的引入未来信息的错误例子。</p><p>这样说可能还是有点抽象，我们用刚才讲过的特征举个例子。刚才我们说到有一个用户特征叫做用户平均评分（userAvgRating），我们通过把用户评论过的电影评分取均值得到它。假设，一个用户今年评论过三部电影，分别是11月1日评价电影A，评分为3分，11月2日评价电影B，评分为4分，11月3日评价电影C，评分为5分。如果让你利用电影B这条评价记录生成样本，样本中userAvgRating这个特征的值应该取多少呢？</p><p>有的同学会说，应该取评价过的电影评分的均值啊，(3+4+5)/3=4分，应该取4分啊。这就错了，因为在样本B发生的时候，样本C还未产生啊，它属于未来信息，你怎么能把C的评分也加进去计算呢？而且样本B的评分也不应该加进去，因为userAvgRating指的是历史评分均值，B的评分是我们要预估的值，也不可以加到历史评分中去，所以正确答案是3分，我们只能考虑电影A的评分。</p><p>因此，在处理历史行为相关的特征的时候，我们一定要考虑未来信息问题。类似的还有用户评分总数、用户评分标准差、用户最喜欢的电影风格、用户好评电影ID等一系列特征。</p><p>那在Spark中，我们应该如何处理这些跟历史行为相关的特征呢？这就需要用到window函数了。比如说，我在生成userAvgRating这个特征的时候，是使用下面的代码生成的：</p><pre><code>withColumn(&quot;userAvgRating&quot;, avg(col(&quot;rating&quot;))\n  .over(Window.partitionBy(&quot;userId&quot;)\n    .orderBy(col(&quot;timestamp&quot;)).rowsBetween(-100, -1)))\n\n</code></pre><p>我们可以看到，代码中有一个<code>over(Window.partitionBy(\"userId\").orderBy(col(\"timestamp\")))</code>操作，它的意思是，在做rating平均这个操作的时候，我们不要对这个userId下面的所有评分取平均值，而是要创建一个滑动窗口，先把这个用户下面的评分按照时间排序，再让这个滑动窗口一一滑动，滑动窗口的位置始终在当前rating前一个rating的位置。这样，我们再对滑动窗口内的分数做平均，就不会引入未来信息了。</p><p>类似的操作，我使用在了所有与历史行为有关的特征中，你也可以在SparrowRecsys的源码中看到。</p><h2>如何把特征数据存入线上供模型服务用？</h2><p>在生成好特征和训练样本之后，还有一个问题需要我们解决，那就是特征的线上存储问题。因为训练样本是供离线训练使用的，而线上模型推断过程是要使用线上特征的。</p><p>好在，特征数据库Redis已经为我们提供了解决办法。我们把用户特征和物品特征分别存入Redis，线上推断的时候，再把所需的用户特征和物品特征分别取出，拼接成模型所需的特征向量就可以了。</p><p>FeatureEngForRecModel中的extractAndSaveUserFeaturesToRedis函数给出了详细的Redis操作，我把其中的关键操作放在了下面。</p><pre><code>val userKey = userFeaturePrefix + sample.getAs[String](&quot;userId&quot;)\nval valueMap = mutable.Map[String, String]()\nvalueMap(&quot;userRatedMovie1&quot;) = sample.getAs[String](&quot;userRatedMovie1&quot;)\nvalueMap(&quot;userRatedMovie2&quot;) = sample.getAs[String](&quot;userRatedMovie2&quot;)\n...\nvalueMap(&quot;userAvgRating&quot;) = sample.getAs[String](&quot;userAvgRating&quot;)\nvalueMap(&quot;userRatingStddev&quot;) = sample.getAs[String](&quot;userRatingStddev&quot;)\n\n\nredisClient.hset(userKey, JavaConversions.mapAsJavaMap(valueMap))\n</code></pre><p>我们可以看到，代码中使用了Redis一个新的操作hset，它的作用是把一个Map存入Redis。这样做有什么好处呢？对于这里的用户特征来说，Map中存储的就是特征的键值对，又因为这个Map本身是userId的值，所以，每个userId都拥有一组用户特征。这样一来，我们就可以在推荐服务器内部，通过userId来取出所有对应的用户特征了。当然，物品特征的储存方式是一样的。</p><p>到这里，我们完成了所有特征工程相关的准备工作，为之后的模型训练也做好了充足的准备。</p><h2>小结</h2><p>这节课，我们选择Spark作为特征和样本处理的平台，是因为Spark更擅长海量数据的分布式处理，为TensorFlow减轻数据处理的负担。在选择具体特征的过程中，我们遵循了“物品特征”“用户特征”“场景特征”这三大类特征分类方式，基于MovieLens的ratings表和movies表完成了特征抽取。</p><p>在样本处理过程中，我们选用评分和基于评分生成的好评差评标识作为样本标签，并基于ratings表的每条数据，通过联合物品和用户数据生成训练样本。在训练样本的生成中，要特别注意“未来信息”的问题，利用Spark中的window函数滑动生成历史行为相关特征。最后我们利用Redis的hset操作把线上推断用的特征存储Redis。</p><p>这些重点内容，我也都总结在了下面的表格里，你可以看一看。</p><p><img src=\"https://static001.geekbang.org/resource/image/48/4d/48e15afe48dba3d35bef1e6f69aee84d.jpg?wh=3632*2290\" alt=\"\"></p><h2>课后思考</h2><p>为了避免引入未来信息，咱们课程中讲了基于userId的window函数方法，你觉得还有哪些方法也能避免引入未来信息吗？</p><p>欢迎把你的思考和答案写在留言区，如果你觉得今天的内容对你有所帮助，也欢迎你分享给你的朋友或同事。我们下节课见！</p>","neighbors":{"left":{"article_title":"模型实战准备（一） | TensorFlow入门和环境配置","id":307655},"right":{"article_title":"17 | Embedding+MLP：如何用TensorFlow实现经典的深度学习模型？","id":309846}},"comments":[{"had_liked":false,"id":261856,"user_name":"onepencil","can_delete":false,"product_type":"c1","uid":1346100,"ip_address":"","ucode":"078FCC302D5FC2","user_header":"","comment_is_top":false,"comment_ctime":1605539360,"is_pvip":false,"replies":[{"id":"95035","content":"赞，这是业界的解决方法之一，存储特征的snapshot。","user_name":"作者回复","comment_id":261856,"uid":"1662192","ip_address":"","utype":1,"ctime":1605553690,"user_name_real":"王喆"}],"discussion_count":3,"race_medal":0,"score":"216353904160","product_id":100060801,"comment_content":"线上会组装当前访问时的历史序列及历史平均值等，可以利用flink实时落盘这些线上特征，这样线下就不用再离线生成，也就杜绝了特征穿越问题","like_count":51,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509640,"discussion_content":"赞，这是业界的解决方法之一，存储特征的snapshot。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605553690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2028957,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f5/9d/104bb8ea.jpg","nickname":"Geek2014","note":"","ucode":"9EB356D8DF287E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352277,"discussion_content":"同，使用flink的window或者process函数，实时落盘数据到下游kafka/tair，然后进入hive或者hdfs","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1614671069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2412684,"avatar":"https://static001.geekbang.org/account/avatar/00/24/d0/8c/76456603.jpg","nickname":"wujian4","note":"","ucode":"2E9F54E4970413","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2028957,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f5/9d/104bb8ea.jpg","nickname":"Geek2014","note":"","ucode":"9EB356D8DF287E","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375104,"discussion_content":"线上实时推荐不能落盘到HDFS吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621483374,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":352277,"ip_address":""},"score":375104,"extra":""}]}]},{"had_liked":false,"id":261693,"user_name":"Sebastian","can_delete":false,"product_type":"c1","uid":1797634,"ip_address":"","ucode":"62E6FC13DB00E3","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/55lYKUdcPFgUHibRYmaRiaBdrsmnLGOHdPp4OicjBh197X0vyGa9qAwruEqicAPuUgibXO4Lz5jLudlcbtsqq2p3CpA/132","comment_is_top":false,"comment_ctime":1605491409,"is_pvip":false,"replies":[{"id":"95034","content":"我在存储模块那节课说过，SparrowRecsys项目确实对存储模块进行了一定程度的简化，实际应用中还是要多考虑分级存储，redis实际上当作一个缓存层来使用。<br><br>关于大量数据key value数据的存储和线上查找，可以多调研rocksdb，cassandra，dynamodb和mongodb。","user_name":"作者回复","comment_id":261693,"uid":"1662192","ip_address":"","utype":1,"ctime":1605553652,"user_name_real":"王喆"}],"discussion_count":2,"race_medal":0,"score":"48850131665","product_id":100060801,"comment_content":"老师好，想问下使用hset把用户和物品的特征存入redis的场景下，如果用户上亿物品也上亿的话，存入redis会使用很大的资源。实际场景下并不是所有用户都是活跃用户，很多情况下可能用不上。那是否是在redis只存入活跃用户的特征呢？但是如果这样解决，遇到非活跃用户是否就没有特征值了？<br><br>从您的实践经验里有什么好的方法吗？","like_count":11,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509569,"discussion_content":"我在存储模块那节课说过，SparrowRecsys项目确实对存储模块进行了一定程度的简化，实际应用中还是要多考虑分级存储，redis实际上当作一个缓存层来使用。\n\n关于大量数据key value数据的存储和线上查找，可以多调研rocksdb，cassandra，dynamodb和mongodb。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605553652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1690913,"avatar":"","nickname":"菜鸟","note":"","ucode":"46F58768896D77","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390451,"discussion_content":"多级缓存，本地，redis，kv类数据库","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1629852814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":281139,"user_name":"AI","can_delete":false,"product_type":"c1","uid":2336126,"ip_address":"","ucode":"46DFC5CDF6EADC","user_header":"https://static001.geekbang.org/account/avatar/00/23/a5/7e/383444bb.jpg","comment_is_top":false,"comment_ctime":1614591933,"is_pvip":false,"replies":[{"id":"102379","content":"用户id和电影id都是非常重要的特征，因为他们之间的关系包含了用户的历史行为信息，其中又隐含了非常多的用户的兴趣偏好。","user_name":"作者回复","comment_id":281139,"uid":"1662192","ip_address":"","utype":1,"ctime":1615023884,"user_name_real":"王喆"}],"discussion_count":2,"race_medal":0,"score":"35974330301","product_id":100060801,"comment_content":"老师好，为什么用户id和电影id要作为特征进行输入，我的理解是id不是相当于一个索引吗？","like_count":8,"discussions":[{"author":{"id":2028957,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/f5/9d/104bb8ea.jpg","nickname":"Geek2014","note":"","ucode":"9EB356D8DF287E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352280,"discussion_content":"https://www.zhihu.com/question/34819617/answer/59967750","likes_number":9,"is_delete":false,"is_hidden":false,"ctime":1614671412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516304,"discussion_content":"用户id和电影id都是非常重要的特征，因为他们之间的关系包含了用户的历史行为信息，其中又隐含了非常多的用户的兴趣偏好。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615023884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261919,"user_name":"那时刻","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1605579063,"is_pvip":false,"replies":[{"id":"95088","content":"两个问题都很好，希望大家都有这样实践中的思考。<br><br>第一个问题。基本原则是我在分析完分数的总体分布后得出的，3.5分基本是正负样本比例1:1的分界线，另外大于3.5分也符合我们直观意义上的高分，所以认为3.5分是比较合理的。<br><br>第二个问题。确实像你说的这样，我们实践中经常从时间戳中提取出周末，假日，季节这些特征，因为这些时间特征往往影响着数据的一些潜在模式，所以还是非常有价值的。","user_name":"作者回复","comment_id":261919,"uid":"1662192","ip_address":"","utype":1,"ctime":1605603989,"user_name_real":"王喆"}],"discussion_count":4,"race_medal":0,"score":"35965317431","product_id":100060801,"comment_content":"把评分大于等于 3.5 分的样本标签标识为 1，意为“喜欢”，评分小于 3.5 分的样本标签标识为 0，意为“不喜欢”。这样可以完全把推荐问题转换为 CTR 预估问题。请问老师，3.5分这个值是怎么来的呢？<br><br>另外一个问题，我们把评分时间戳作为代表时间场景的特征放到特征工程中。请问把时间戳用于特征工程，有木有需要注意的地方？比如是否是周末，假日等？老师在实际应用中有哪些实践么？","like_count":9,"discussions":[{"author":{"id":2311604,"avatar":"","nickname":"Geek_c0fd60","note":"","ucode":"CAB74A2ABCD57C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":354987,"discussion_content":"这里的正负样本划分，我觉得考虑一下有些用户整体打分偏高，有些偏低这样的情况。应该按照每个用户的平均分作为分界线，是不是更合理一些？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1615372844,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509665,"discussion_content":"两个问题都很好，希望大家都有这样实践中的思考。\n\n第一个问题。基本原则是我在分析完分数的总体分布后得出的，3.5分基本是正负样本比例1:1的分界线，另外大于3.5分也符合我们直观意义上的高分，所以认为3.5分是比较合理的。\n\n第二个问题。确实像你说的这样，我们实践中经常从时间戳中提取出周末，假日，季节这些特征，因为这些时间特征往往影响着数据的一些潜在模式，所以还是非常有价值的。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605603989,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1797634,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/55lYKUdcPFgUHibRYmaRiaBdrsmnLGOHdPp4OicjBh197X0vyGa9qAwruEqicAPuUgibXO4Lz5jLudlcbtsqq2p3CpA/132","nickname":"Sebastian","note":"","ucode":"62E6FC13DB00E3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326469,"discussion_content":"2. 做分箱就行了吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605602304,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1797634,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/55lYKUdcPFgUHibRYmaRiaBdrsmnLGOHdPp4OicjBh197X0vyGa9qAwruEqicAPuUgibXO4Lz5jLudlcbtsqq2p3CpA/132","nickname":"Sebastian","note":"","ucode":"62E6FC13DB00E3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327099,"discussion_content":"做分箱应该解决不了这个问题。我们其实是希望从周末，假日，季节这些特征里面挖掘出更多有价值的信息，分箱并不能带来这些可能有用的时间相关信息。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1605747938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":326469,"ip_address":""},"score":327099,"extra":""}]}]},{"had_liked":false,"id":262796,"user_name":"萬里長空","can_delete":false,"product_type":"c1","uid":2199552,"ip_address":"","ucode":"54343639CA8397","user_header":"https://static001.geekbang.org/account/avatar/00/21/90/00/cfc2b463.jpg","comment_is_top":false,"comment_ctime":1605844298,"is_pvip":false,"replies":[{"id":"95558","content":"是的，是spark sql和直接操作dataframe的区别。直接操作dataframe不用register","user_name":"作者回复","comment_id":262796,"uid":"1662192","ip_address":"","utype":1,"ctime":1606115253,"user_name_real":"王喆"}],"discussion_count":1,"race_medal":0,"score":"27375648074","product_id":100060801,"comment_content":"老师，问一个spark-udf的问题，看官网上定义udf的时候要使用register，但是您这里并没有使用，是sql与DataFrame的区别吗？","like_count":6,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509976,"discussion_content":"是的，是spark sql和直接操作dataframe的区别。直接操作dataframe不用register","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606115253,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":275219,"user_name":"倪钰鑫","can_delete":false,"product_type":"c1","uid":2422720,"ip_address":"","ucode":"42C73AD864009D","user_header":"https://static001.geekbang.org/account/avatar/00/24/f7/c0/f9298791.jpg","comment_is_top":false,"comment_ctime":1611394472,"is_pvip":false,"replies":[{"id":"99960","content":"这是个好问题，涉及到默认值选取的问题。常规做法是把全局的均值填进去，但其实没有什么统一的最好的方法。","user_name":"作者回复","comment_id":275219,"uid":"1662192","ip_address":"","utype":1,"ctime":1611550521,"user_name_real":"王喆"}],"discussion_count":2,"race_medal":0,"score":"23086230952","product_id":100060801,"comment_content":"老师好，我想问下用户行为的时间序列，最一开始的那个用户行为的历史数据我们都是置0吗？比如您上面所说的“userAvgRating”，在B上是填A的打分3，那么在A上呢？因为这里收集到的信息A是最前面的，那此时就是置为0吗？还是说可以选一个全局中值填进去呢？","like_count":5,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514268,"discussion_content":"这是个好问题，涉及到默认值选取的问题。常规做法是把全局的均值填进去，但其实没有什么统一的最好的方法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611550521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2437854,"avatar":"https://static001.geekbang.org/account/avatar/00/25/32/de/88e98677.jpg","nickname":"舒光华","note":"","ucode":"D0F63FFB89A3A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370385,"discussion_content":"严格来说，使用全局均值的话是不是也是一种信息泄露呢？因为全局均值包含所有数据的信息。我的理解是因为没有更好的办法，在实际当中常用均值作为默认。同时或许均值是经过求平均的操作，最终这种泄露不会有什么大的影响 (没有实际实验比较过，不确定）。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619397747,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293318,"user_name":"ZLZ","can_delete":false,"product_type":"c1","uid":2281606,"ip_address":"","ucode":"F93D68B3F8F165","user_header":"https://static001.geekbang.org/account/avatar/00/22/d0/86/564f7d06.jpg","comment_is_top":false,"comment_ctime":1621334130,"is_pvip":false,"replies":[{"id":"106648","content":"是这样，第一种方式是不建议采用的。第二种我建议缩短数据分割的粒度，比如改成T-1小时","user_name":"作者回复","comment_id":293318,"uid":"1662192","ip_address":"","utype":1,"ctime":1621703735,"user_name_real":"王喆"}],"discussion_count":3,"race_medal":0,"score":"14506236018","product_id":100060801,"comment_content":"王老师，请问我在训练CTR模型过程中，有两种训练样本处理方式，第一种是使用T-1天的数据进行shuffle，其中80%作为train dataset，20%作为训练过程中的val dataset，即使用T-1天的数据进行模型训练，针对T天的数据进行线上预测；第二种方式是使用T-2天的数据作为train dataset，T-1天的数据作为val dataset，即2使用T-2天的数据进行模型训练，针对第T天的数据进行线上预测；我理解第一种方式是不是容易造成信息穿越，例如在某一天有某个活动，但是第二天没有这个活动，那模型在第二天会效果不好，但是第二种方式线上是采用T-2天的模型，相比于第一种方式（线上使用的是第T-1的模型），是不是效果会打折扣","like_count":4,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520157,"discussion_content":"是这样，第一种方式是不建议采用的。第二种我建议缩短数据分割的粒度，比如改成T-1小时","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621703735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2438072,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/FydBiarFhvwAxkA2fL3IpEGcd31xAfo8WicAgxreCSbPgo0IdcHkAwZQDZDiaeAJg7u2UKqSEmzr8Mopf9lFY1IEw/132","nickname":"郭翊麟","note":"","ucode":"BA37CAE065CF30","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389000,"discussion_content":"请问一下，第一种方式为什么会出现信息穿越，T-1 预测第T天 即使有某个活动，也无法说明数据有穿越？  万分不解 希望老师和同学 明示","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629086072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2403705,"avatar":"","nickname":"Wa","note":"","ucode":"96E28E50FCA96C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2438072,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/FydBiarFhvwAxkA2fL3IpEGcd31xAfo8WicAgxreCSbPgo0IdcHkAwZQDZDiaeAJg7u2UKqSEmzr8Mopf9lFY1IEw/132","nickname":"郭翊麟","note":"","ucode":"BA37CAE065CF30","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":573640,"discussion_content":"看到了val里的特征，导致val不准确","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653559396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":389000,"ip_address":""},"score":573640,"extra":""}]}]},{"had_liked":false,"id":275687,"user_name":"榕","can_delete":false,"product_type":"c1","uid":1053178,"ip_address":"","ucode":"4611A40E21ECEB","user_header":"https://static001.geekbang.org/account/avatar/00/10/11/fa/e0dcc1bf.jpg","comment_is_top":false,"comment_ctime":1611645513,"is_pvip":false,"replies":[{"id":"100246","content":"是这样，最好要进行window处理。可以自行修改提交PR","user_name":"作者回复","comment_id":275687,"uid":"1662192","ip_address":"","utype":1,"ctime":1611787567,"user_name_real":"王喆"}],"discussion_count":1,"race_medal":0,"score":"10201580105","product_id":100060801,"comment_content":"&#47;&#47;add rating features<br>    val movieRatingFeatures = samplesWithMovies3.groupBy(col(&quot;movieId&quot;))<br>      .agg(count(lit(1)).as(&quot;movieRatingCount&quot;),<br>        format_number(avg(col(&quot;rating&quot;)), NUMBER_PRECISION).as(&quot;movieAvgRating&quot;),<br>        stddev(col(&quot;rating&quot;)).as(&quot;movieRatingStddev&quot;))<br>    .na.fill(0).withColumn(&quot;movieRatingStddev&quot;,format_number(col(&quot;movieRatingStddev&quot;), NUMBER_PRECISION))<br><br>老师，特征处理中电影的打分特征应该也是要做window处理吧，谢谢~","like_count":2,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514440,"discussion_content":"是这样，最好要进行window处理。可以自行修改提交PR","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611787567,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":275301,"user_name":"abc-web","can_delete":false,"product_type":"c1","uid":1371804,"ip_address":"","ucode":"DE3B873863EFF9","user_header":"https://static001.geekbang.org/account/avatar/00/14/ee/9c/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1611458648,"is_pvip":false,"replies":[{"id":"99963","content":"先分词再word2vec","user_name":"作者回复","comment_id":275301,"uid":"1662192","ip_address":"","utype":1,"ctime":1611551049,"user_name_real":"王喆"}],"discussion_count":1,"race_medal":0,"score":"10201393240","product_id":100060801,"comment_content":"王老师，想问一下，如果标签或其他属性是中文内容需要进行特征处理还是直接进行word2vec？谢谢！","like_count":3,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514303,"discussion_content":"先分词再word2vec","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611551049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262232,"user_name":"Jay","can_delete":false,"product_type":"c1","uid":1066131,"ip_address":"","ucode":"488BF5D01D3CFD","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/93/2d3d5868.jpg","comment_is_top":false,"comment_ctime":1605669478,"is_pvip":false,"replies":[{"id":"95229","content":"组合特征当然可以通过人工组合的手段进行组合，这点我们仍然可以沿用之前传统机器学习的经验。<br><br>对于深度学习模型来说，也可以交由模型的内部结构来组合，这一点后面关于模型的讲解还会涉及到。","user_name":"作者回复","comment_id":262232,"uid":"1662192","ip_address":"","utype":1,"ctime":1605747215,"user_name_real":"王喆"}],"discussion_count":2,"race_medal":0,"score":"10195604070","product_id":100060801,"comment_content":"刚入坑，好像一直没有看到关于特征组合的内容，这个点一直没有理解清楚，啥时候会讲讲呢？","like_count":2,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509744,"discussion_content":"组合特征当然可以通过人工组合的手段进行组合，这点我们仍然可以沿用之前传统机器学习的经验。\n\n对于深度学习模型来说，也可以交由模型的内部结构来组合，这一点后面关于模型的讲解还会涉及到。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605747215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2414668,"avatar":"","nickname":"夜枭","note":"","ucode":"7A09EC9E003379","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":344855,"discussion_content":"老师请教一下一般语义特征的id化步骤在哪一步做比较合适呢，是利用spark的一些比如zipwithindex直接编号还是利用tf处理更合理呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611585961,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290339,"user_name":"Geek_3c29c3","can_delete":false,"product_type":"c1","uid":2203358,"ip_address":"","ucode":"3D2E73AB1D08FA","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLaoiaerNMy7eoSA5yfibPNhta51jkhPTTL1dD1HGlnjaGnFQ6Uzbbce82Kpnic3g1JlD7rtm41Y83PA/132","comment_is_top":false,"comment_ctime":1619508989,"is_pvip":false,"replies":[{"id":"105352","content":"可以参考我的这篇文章https:&#47;&#47;zhuanlan.zhihu.com&#47;p&#47;351390011","user_name":"作者回复","comment_id":290339,"uid":"1662192","ip_address":"","utype":1,"ctime":1619729650,"user_name_real":"王喆"}],"discussion_count":1,"race_medal":0,"score":"5914476285","product_id":100060801,"comment_content":"老师，由于用户有上亿个，在训练样本时，只是有一部分用户的usrid去进行训练，在模型上线时，不在模型训练所用的usrid里面，一般来说都有哪些处理方法呢？","like_count":1,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519178,"discussion_content":"可以参考我的这篇文章https://zhuanlan.zhihu.com/p/351390011","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619729650,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262339,"user_name":"fsc2016","can_delete":false,"product_type":"c1","uid":1255585,"ip_address":"","ucode":"5480F05703A974","user_header":"https://static001.geekbang.org/account/avatar/00/13/28/a1/fd2bfc25.jpg","comment_is_top":false,"comment_ctime":1605695331,"is_pvip":false,"replies":[{"id":"95227","content":"1. 可以的，也是常用的做法，就是预训练embedding+深度模型的做法<br><br>2. 这个问题不是特别理解，我已经在这节专门讲了如何用window函数生成用户和物品特征，来消除未来信息，应该是回答了你这个问题？","user_name":"作者回复","comment_id":262339,"uid":"1662192","ip_address":"","utype":1,"ctime":1605746996,"user_name_real":"王喆"}],"discussion_count":2,"race_medal":0,"score":"5900662627","product_id":100060801,"comment_content":"老师，有俩个问题请教您：<br>1，前面章节生成了用户和物品的embding，这些embding也会作为一个特征字段加入到本节生成的用户和物品特征中嘛<br>2，本节提取了用户和物品特征，那进行ctr预估的话，是根据rateing表中，为每条记录添加对应提取出的用户特征和物品特征，作为一条训练记录。这样组合的话，是不是使用未来信息了？关于如何组装成一条训练记录进行ctr预估，该怎么做了<br>","like_count":1,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509788,"discussion_content":"1. 可以的，也是常用的做法，就是预训练embedding+深度模型的做法\n\n2. 这个问题不是特别理解，我已经在这节专门讲了如何用window函数生成用户和物品特征，来消除未来信息，应该是回答了你这个问题？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605746996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1809935,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/l3RGUX8aLnPLmsQsra0yU5d8m7Se5jdVpaC3bkb99FuY11BPQNAsH4MPXbZjCTia9VVwn8lnBnKLkdfSiabOgxKg/132","nickname":"Geek_e0d66a","note":"","ucode":"5078900C9CF936","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328827,"discussion_content":"如果是逻辑回归模型的话，embedding的连续性特征不能直接使用吧？需要离散化","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606234157,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347144,"user_name":"Geek_84e43e","can_delete":false,"product_type":"c1","uid":2874015,"ip_address":"","ucode":"9F979EA0D240D6","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/02FlEAh0LxLJ6pkCvfv5gsFC9Ngjc07Hh1fxicArXicDss9osXgVsXUHH596AjyicRT26nU26Ov4Rp6NwcibxuwvDg/132","comment_is_top":false,"comment_ctime":1653743645,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653743645","product_id":100060801,"comment_content":"王喆老师，我在学习您的课程的时候遇到了这个问题：在您使用window函数规避数据穿越问题这一节，我观察到您在切分数据集的时候还是采用的随机分割的方式？那假设我在测试集中是11月3号的数据，但是训练集中包含了11月1日和11月5日这两天的数据，这也就是说我会使用11月1号和5号的数据来训练，最后使用11月3号来测试模型效果，这不会同样带来数据穿越的问题吗？","like_count":0},{"had_liked":false,"id":309878,"user_name":"คิดถึง ","can_delete":false,"product_type":"c1","uid":2735702,"ip_address":"","ucode":"205BA133D638C6","user_header":"https://static001.geekbang.org/account/avatar/00/29/be/56/6a2998ba.jpg","comment_is_top":false,"comment_ctime":1630378784,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630378784","product_id":100060801,"comment_content":"王老师好，如果我想在数据集中添加其他特征，类似用户年龄、性别等，该修改哪些地方呢？","like_count":0},{"had_liked":false,"id":293319,"user_name":"ZLZ","can_delete":false,"product_type":"c1","uid":2281606,"ip_address":"","ucode":"F93D68B3F8F165","user_header":"https://static001.geekbang.org/account/avatar/00/22/d0/86/564f7d06.jpg","comment_is_top":false,"comment_ctime":1621334536,"is_pvip":false,"replies":[{"id":"106649","content":"合理<br><br>确实真实特征是冷启动的问题，可以查阅一些冷启动方面的文章。","user_name":"作者回复","comment_id":293319,"uid":"1662192","ip_address":"","utype":1,"ctime":1621703848,"user_name_real":"王喆"}],"discussion_count":1,"race_medal":0,"score":"1621334536","product_id":100060801,"comment_content":"还有一个问题，电商领域中，在一个新的推荐场景，初期采用的是热门推荐进行积累数据的，就几乎没有用到什么特征，在用户行为数据积累量足够的情况下，准备训练样本，上推荐模型，模型用到的特征有离线特征（根据T-1天用户行为加工得到） + 实时特征（例如最近五分钟的点击次数），但是在离线训练模型时，无法拿到线上真实的实时特征（因为热门推荐没有用到实时特征，但是用户的行为日志是写入hive了），所以我通过历史的用户行为日志（例如：用户在某个时刻点击了某个商品）模拟复现出用户行为时刻的实时特征值，作为离线模型的训练集，这样做合理么，会有什么问题么，对于这种新场景，第一次上推荐模型的时候缺失真实实时特征该如何处理呢","like_count":0,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520158,"discussion_content":"合理\n\n确实真实特征是冷启动的问题，可以查阅一些冷启动方面的文章。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621703848,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":277500,"user_name":"Sanders","can_delete":false,"product_type":"c1","uid":1697075,"ip_address":"","ucode":"3D460FEEDCDF34","user_header":"","comment_is_top":false,"comment_ctime":1612433477,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612433477","product_id":100060801,"comment_content":"&quot;咱们课程中讲了基于 userId 的 window 函数方法，你觉得还有哪些方法也能避免引入未来信息吗？&quot;可以通过构建分区表的方式记录总的rattings，ratting次数以及日期分区","like_count":0},{"had_liked":false,"id":275948,"user_name":"灯灯灯","can_delete":false,"product_type":"c1","uid":2402565,"ip_address":"","ucode":"A801439F74127C","user_header":"https://static001.geekbang.org/account/avatar/00/24/a9/05/6822b8a5.jpg","comment_is_top":false,"comment_ctime":1611725471,"is_pvip":false,"replies":[{"id":"100248","content":"当然可以去尝试，这里只为大家理解原理提供一种方法。","user_name":"作者回复","comment_id":275948,"uid":"1662192","ip_address":"","utype":1,"ctime":1611787688,"user_name_real":"王喆"}],"discussion_count":1,"race_medal":0,"score":"1611725471","product_id":100060801,"comment_content":"老师请问 对于像movielens的数据集给出具体评分的数据集 不把评分分为是否》3.5的两类而是直接对评分做预测 是否会得到更准确地预测呢？","like_count":0,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514541,"discussion_content":"当然可以去尝试，这里只为大家理解原理提供一种方法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611787688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262563,"user_name":"Wiiki","can_delete":false,"product_type":"c1","uid":1797573,"ip_address":"","ucode":"037F2D44C087C5","user_header":"https://static001.geekbang.org/account/avatar/00/1b/6d/c5/c0665034.jpg","comment_is_top":false,"comment_ctime":1605769632,"is_pvip":false,"replies":[{"id":"95332","content":"第一个问题确实是个bug，我已经提交了修改。<br>第二个问题我这边不存在，可能还需要你来debug一下。确认本地的redis环境都配置好了吧？","user_name":"作者回复","comment_id":262563,"uid":"1662192","ip_address":"","utype":1,"ctime":1605835018,"user_name_real":"王喆"}],"discussion_count":4,"race_medal":0,"score":"1605769632","product_id":100060801,"comment_content":"王老师，我按照您的示例代码，将用户特征存入redis(调用extractAndSaveUserFeaturesToRedis(samplesWithUserFeatures)的时候报错了，首先是报错：java.lang.Integer cannot be cast to java.lang.String，我在调试的过程中发现valueMap(&quot;userAvgReleaseYear&quot;) = sample.getAs[String](&quot;userAvgReleaseYear&quot;)这个字段并没有将年份转换成String，还是原来的Int类型，所以改成      valueMap(&quot;userAvgReleaseYear&quot;) = sample.getAs[Int](&quot;userAvgReleaseYear&quot;).toString，这个异常解决了，然后又报错：Exception in thread &quot;main&quot; redis.clients.jedis.exceptions.JedisDataException: ERR wrong number of arguments for &#39;hset&#39; command，定位到return client.getIntegerReply()这个代码出错了。目前没有找到具体原因，麻烦老师帮忙解答一下呀~  谢谢","like_count":0,"discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509885,"discussion_content":"第一个问题确实是个bug，我已经提交了修改。\n第二个问题我这边不存在，可能还需要你来debug一下。确认本地的redis环境都配置好了吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605835018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1903862,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/0c/f6/8ae0beb3.jpg","nickname":"维真","note":"","ucode":"0EAAFEEFC8370A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371574,"discussion_content":"我也怀疑是redis版本的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619852797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1797573,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/6d/c5/c0665034.jpg","nickname":"Wiiki","note":"","ucode":"037F2D44C087C5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327416,"discussion_content":"后面那个问题，我把hset改成hmset之后就没问题了~  为啥hset报错这个问题还米有扎到原因呢~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605834040,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1662192,"avatar":"https://static001.geekbang.org/account/avatar/00/19/5c/f0/46214d29.jpg","nickname":"王喆","note":"","ucode":"2EDC616F905F3F","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":1797573,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/6d/c5/c0665034.jpg","nickname":"Wiiki","note":"","ucode":"037F2D44C087C5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327677,"discussion_content":"怀疑是redis或者redisclient的版本问题，也不用太纠结这类问题。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605903625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":327416,"ip_address":""},"score":327677,"extra":""}]}]}]}