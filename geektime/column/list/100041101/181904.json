{"id":181904,"title":"13 | 性能测试的工程集成：如何与产品开发和运维业务有机集成？","content":"<p>你好，我是庄振运。</p><p>前面几讲，我们讨论了性能测试的几个方面，包括测试的种类、测试的规划、工具以及经验和教训。</p><p>今天我们讨论性能测试如何和其他系统进行智能集成，也就是如何让<strong>性能测试</strong>这一工作从单独的、一次性的、手工发起的、传统的人工操作，进化成一个和开发及运维过程相结合的、持续的、自动重复执行的智能操作。</p><h2>性能测试模式的演化</h2><p>性能测试作为IT公司的一种重要工作，它的工作模式正在从传统的手工模式，不断进化成智能集成的自动模式。</p><p>这样的演化主要归功于这些年互联网技术的进步和业务需求的提高，包括数据量的加大和业务的日益复杂化、客户需求的多元化、公司业务规模的扩大，以及人工智能和机器学习的不断成熟。</p><p>那么，性能测试的模式进化表现在哪些方面呢？主要有四个方面，如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/18/df/189133714d4ed913957d36667dab2bdf.png?wh=2622*1474\" alt=\"\"></p><p>1.从<strong>独立的操作</strong>演化成和其他系统（比如开发和运维）的<strong>有机集成</strong>。</p><p>公司中很多业务都和性能测试有关，尤其是产品开发和系统运维业务。性能测试需要和这些业务紧密结合，从而使相关工作的效率极大提高。</p><p>2.从一次次的<strong>单独执行</strong>演化成<strong>持续而重复的执行</strong>。</p><p>从开发角度来看，一个产品的程序代码会不断被开发和增强，包括加入新的功能和修补发现的错误。每次代码改变都需要进行性能测试，以确保程序面对客户的端到端性能和资源利用效率没有变低。从运维角度来看，公司的产品系统也需要持续地进行性能测试，以尽早发现可能的问题。</p><!-- [[[read_end]]] --><p>3.从<strong>手工进行</strong>测试演化成<strong>自动化</strong>的测试。</p><p>每当需要进行性能测试的时候，系统越来越需要自动触发，并按照既定规则来开始测试。测试完成后也需要自动进行分析，并根据分析的结果继续进行后面的定义好的步骤。整个过程最好不需要测试人员的人工参与，以降低运营成本并减少人为错误。</p><p>4.从常规的<strong>人工操作</strong>演化成基于人工智能（AI）和机器学习（ML）的<strong>智能操作</strong>。</p><p>数据量的变大让有效的机器学习成为可能。同时伴随着人工智能技术的不断成熟，传统常规的性能测试一步步地走向智能的自动性能优化。</p><h2>和产品开发的系统集成</h2><p>性能测试和产品开发密切相关，我用下面这张图片表示它们之间的关系。我分成两部分讲，先讲和产品开发的系统集成。</p><p><img src=\"https://static001.geekbang.org/resource/image/b1/c7/b1a78241835c50a5ec0754fabfbfd9c7.png?wh=2622*1474\" alt=\"\"></p><p>性能测试和产品开发的集成也是所谓“持续集成”（Continuous Integration）的一部分。</p><p>什么是“持续集成”呢？</p><p>这个概念已经在软件开发领域存在很多年了，本来是为了配合敏捷开发（Agile Developement）的速度和效率而产生的，是把源代码管理、代码检查、程序编译、性能和功能测试、产品部署等一系列操作整合在一起的概念和工具。</p><p>怎么才叫“持续”呢？</p><p>就是从程序员提交了源码开始，相关工具就会自动进行编译、测试等一系列运作，并将结果反馈给程序员。这样，提交代码的程序员很快就会知道刚刚提交的代码有没有问题。</p><p>可能发生的问题有很多种，包括编译错误、整个程序不能运作、能编译运行但是整体性能变差等等。如果发现这样的问题，程序员和团队就可以迅速进行改正，不必等到开发周期后期才寻找和修复缺陷。</p><p>什么叫“集成”？</p><p>就是上述一套操作都是有相应工具支持的，几个工具又集成在一起，构成一个完整的系统。</p><p>持续集成包括两个重要阶段：持续交付和持续部署。我们先说一下持续交付。</p><p><strong>持续交付</strong>（Continuous delivery）指的是开发人员的每一次代码提交，都会自动地编译，并且运行已经定义好的测试程序。</p><p>测试程序里面就包括性能测试和结果分析。如果分析的结果确认这次代码提交没有性能问题，就成功接受这次提交。否则，就会采取措施通知代码提交者去修正代码；并重复这个过程，直到通过。</p><p><strong>持续部署</strong>（Continuous deployment）是持续交付的下一步，指的是代码通过评审以后，自动部署到真正的生产环境。</p><p>持续部署的目标是，代码在任何时刻都是可部署的，并且是可以进入生产阶段的。持续部署的前提是能自动化完成测试、构建、部署等步骤。同时，如果一旦部署了的版本发生不能接受的问题，就需要回滚到上一个版本。这个回滚的过程也需要简单方便，否则会造成非常大的混乱。</p><p>持续集成的价值何在？</p><p>持续集成的价值主要有几点：降低代码开发风险，及早发现集成错误，减少手动测试过程，快速生成测试结果，提高程序员和开发团队的安全感。同时，频繁的提交代码，也会鼓励和促使开发人员创建模块化和低复杂性的代码。</p><h3>工具集</h3><p>支持持续集成的工具有很多，按照领域分可以有下面几大类：代码版本管理、代码检查、编译连接、功能测试、性能测试、性能分析、代码覆盖率、结果展示等。有些流行的持续集成服务器可以整合这些工具或功能，比如Jenkins、CruiseControl、Travis等。</p><p>我举一个完整持续集成的工具例子。比如一个Java开发团队，在开发某项目时用了如下的一系列工具：</p><ul>\n<li>用JStyle来分析Java源代码</li>\n<li>用Ant 构建运行JUnit来进行简单的功能测试</li>\n<li>用DbUnit 执行长时间的数据库组件测试</li>\n<li>用JUnitPerf来进行负载和压力测试</li>\n<li>用JProfiler来进行全功能的代码性能剖析</li>\n<li>用 Selenium运行基于 Web 的功能测试</li>\n<li>用 Cobertura测量代码覆盖率</li>\n<li>用 CruiseControl 作为服务器来管理持续集成</li>\n</ul><h2>和运维业务的系统集成</h2><p>讲完了性能测试和开发过程的集成，我们接着谈谈和运维业务的系统集成。</p><p>广义上来讲，性能工作也是运维的一部分，包括性能测试、性能分析和性能优化。但是，如果把性能工作和其他运维业务分开来看，它就需要和其他运维业务有机而智能地集成。</p><p>运维业务的一个趋势是智能化。</p><p>智能化的原因，是互联网数据量的变大，运维业务的多样化和复杂化，以及对运维服务质量要求的提高（比如低成本、低延迟、高防范）。这样一来，很多传统的运维技术和解决方案已经不能满足当前运维所需。另一方面，机器学习（ML）和 人工智能（AI）技术在飞速发展，这就推生了智能运维AIOps（Artificial Intelligence for IT Operations），这是运维未来发展的必然趋势。</p><p>在这样一个趋势里，运维就需要和性能测试的过程紧密集成。</p><p>一是通过持续而智能的性能测试，能及时发现已有的和将来可能会发生的性能问题，从而快速修复和及时预防。比如，根据性能测试的结果，可能会发现在不久的将来，整个系统的某项资源会用光，有可能导致系统挂掉。这种情况，我们就可以提前采取相应的措施，来避免这一问题的发生。</p><p>二是通过不同种类的性能测试，来找出最佳的解决方案。或许，对有些简单的性能问题，我们能很容易发现和解决，但对很多复杂的性能问题，就比较难找出原因和确定最优方案。要找出最主要的性能问题根因，经常需要进一步的性能测试。即使找到根因，现代互联网服务产品的子模块之间依存度很高，互相的交互多而复杂。那么什么样的解决方案才是效果最好，最容易实现的的，往往需要进行进一步测试来验证。</p><p>性能测试和运维的集成必须有两个特点：<strong>有机</strong>和<strong>自动</strong>。</p><p>不管是性能衡量、问题预测、根因分析还是性能优化，人工去执行都非常费时费力，从而不可取。唯一可行的就是借助于人工智能来尽量自动化。除了持续自动地进行性能测试，发现性能问题还需要进行自动分析，找出问题后也要执行自动调整优化。</p><p>我们的目标是<strong>让性能测试和运维业务进行智能的有机集成</strong>，其中的智能来自于对大数据的分析和机器学习。</p><p>无论是本业务系统的历史数据，还是其他业务系统的数据，甚至是业界其他公司的数据和经验，都是机器学习的对象和分析的基础。同时，我们还需要注入适当的知识和规则，来帮助这一套集成的持续优化。</p><p>在这一过程中，数据的采集和整理是一切的基础。公司层面需要全方位，实时、多维度、全量地对各种运维数据采集、整理和存储。这里的运维数据包括基础架构的机器监控数据，内网和外网的网络数据，公司业务流量数据，工单系统数据，日志监控数据等。这些数据需要有统一而合理的接口，以方便访问。</p><h2>总结</h2><p>性能测试虽然有很多讲究和注意的地方，但它本身也是作为整个公司业务的一个子系统而存在的。我们需要把它和其他几个子系统，尤其是产品开发子系统和运维子系统有机地整合集成起来，让这几个子系统之间的操作“浑然天成”，才能获取整个公司业务的最大收益。</p><p><img src=\"https://static001.geekbang.org/resource/image/45/16/4507f2890c2a8a050b4e2c83f8714216.png?wh=2691*2699\" alt=\"\"></p><p>白居易的《长恨歌》有两句：“在天愿作比翼鸟，在地愿为连理枝”，期盼的是一种比翼齐飞，一种同心同德。</p><p>这种期盼用在这一讲的子系统集成也挺合适。性能测试和产品开发子系统的集成，可以使得开发过程的迭代更快、更高效，并保证代码质量。性能测试和运维子系统的集成，可以让整个程序和业务保持高性能运转，提高公司业务质量和公司营收。</p><h2>思考题</h2><p>你现在的开发环境中有没有整合这样的自动测试系统？如果没有，你觉得值得考虑一下吗？如果你能从无到有的搭建一个这样的系统，你老板会不会对你刮目相看？</p><p>欢迎你在留言区分享自己的思考，与我和其他同学一起讨论，也欢迎你把文章分享给自己的朋友。</p>","comments":[{"had_liked":false,"id":173700,"user_name":"Geek_6e8c17","can_delete":false,"product_type":"c1","uid":1613168,"ip_address":"","ucode":"F6E323B2E2169F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIp6Ln5VriaBKz2thHG02t8ibH8bicU9wXOkUB3MeOe4IdrcpsmautKkZYHtPiaUMT2HhCTExDP6Jict2g/132","comment_is_top":false,"comment_ctime":1579663730,"is_pvip":false,"replies":[{"id":"67760","content":"自动分析的确很难；我们能做的就是如果环境固定，常见的问题频繁重复，而且人工步骤繁杂，那可以试试抽取出规则，变成“自动”分析。对于新的问题，基本上是无法“自动分析”的。<br>测试的自动化也是个复杂的题目。我们也踩过的很多坑，比如测试太细，导致太多Task给开发团队，人家抱怨；也有测试太粗，导致没有及时发现问题。<br>这方面最大的教训就是测试的粒度要合适，要考虑团队的实际情况（比如人员多少），软件的性质（比如用的库&#47;设计方案），测试结果的机会成本（比如Miss的代价）等。","user_name":"作者回复","user_name_real":"zhenyun2010","uid":"1272838","ctime":1580179528,"ip_address":"","comment_id":173700,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10169598322","product_id":100041101,"comment_content":"从手工的传统模式进化到智能的自动模式，涉及到开发、测试以及运维的多方改造，请问老师在如何改造方面有比较好的经验吗或者是踩过那些坑？<br>另外，我认为性能测试，最体现价值的应当是根据测试数据和结果做的性能分析，但是性能分析还是主要以人介入的，这块做不了自动化和智能化。","like_count":3,"discussions":[{"author":{"id":1272838,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/nicib8gqImzrCGJYyJW3QEmsvtDcfuLe02wm55HBdC2mAHt1mqc6wT7I9GHyByS19zQRBiaZx2EeXKnyvslCZd4tQ/132","nickname":"zhenyun2010","note":"","ucode":"567187932468D8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482174,"discussion_content":"自动分析的确很难；我们能做的就是如果环境固定，常见的问题频繁重复，而且人工步骤繁杂，那可以试试抽取出规则，变成“自动”分析。对于新的问题，基本上是无法“自动分析”的。\n测试的自动化也是个复杂的题目。我们也踩过的很多坑，比如测试太细，导致太多Task给开发团队，人家抱怨；也有测试太粗，导致没有及时发现问题。\n这方面最大的教训就是测试的粒度要合适，要考虑团队的实际情况（比如人员多少），软件的性质（比如用的库/设计方案），测试结果的机会成本（比如Miss的代价）等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580179528,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":184345,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1583294340,"is_pvip":false,"replies":[{"id":"72962","content":"自动性能分析技术上比较困难，不容易做。<br>自动功能测试和性能测试以及集成交付都是有的，国内的公司应该也很多，虽然具体如何实现的我不是很了解。<br>比如我知道这个公司做JVM方面的： https:&#47;&#47;www.perfma.com&#47; <br>","user_name":"作者回复","user_name_real":"zhenyun2010","uid":"1272838","ctime":1584458223,"ip_address":"","comment_id":184345,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1583294340","product_id":100041101,"comment_content":"目前还没有见识过这些自动化的东西，而且我认为针对个性化的公司业务也比较困难？<br>不知老师讲的自动功能测试、自动性能测试、自动性能分析、自动集成交付的落地方案，目前那些公司有？具体是怎么落地的？","like_count":0,"discussions":[{"author":{"id":1272838,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/nicib8gqImzrCGJYyJW3QEmsvtDcfuLe02wm55HBdC2mAHt1mqc6wT7I9GHyByS19zQRBiaZx2EeXKnyvslCZd4tQ/132","nickname":"zhenyun2010","note":"","ucode":"567187932468D8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":485980,"discussion_content":"自动性能分析技术上比较困难，不容易做。\n自动功能测试和性能测试以及集成交付都是有的，国内的公司应该也很多，虽然具体如何实现的我不是很了解。\n比如我知道这个公司做JVM方面的： https://www.perfma.com/ \n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584458223,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2504378,"avatar":"https://static001.geekbang.org/account/avatar/00/26/36/ba/b177d176.jpg","nickname":"可观测性无声笛","note":"","ucode":"709CE03E7EFCC4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589581,"discussion_content":"想认识下老师","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665138844,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172021,"user_name":"NonStatic","can_delete":false,"product_type":"c1","uid":1048909,"ip_address":"","ucode":"9F8BAD86389890","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/6icqg5GGFVo2CkFnjSGleOuDBvTTpXywFbBKicKSNXUH1PibHEq2IgWWGJZsn4ErV6J9mlcBiczV7T5QnpiajLsOibOw/132","comment_is_top":false,"comment_ctime":1579072752,"is_pvip":false,"replies":[{"id":"67036","content":"这个想法很好，应该是个性能工程领域的趋势。我没有用过这样的产品。<br>不过查了下，似乎有些产品号称可以做一些相关的智能分析，比如Dynatrace, AppDynamics。不过我相信就算有，也很初级。","user_name":"作者回复","user_name_real":"zhenyun2010","uid":"1272838","ctime":1579320279,"ip_address":"","comment_id":172021,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1579072752","product_id":100041101,"comment_content":"请问有没有什么机器学习的模型是针对性能测试结果分析的？我理解这个东西是因测试目标而异的，但总是希望能有一些参考模型学习一下。谢谢！","like_count":0,"discussions":[{"author":{"id":1272838,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/nicib8gqImzrCGJYyJW3QEmsvtDcfuLe02wm55HBdC2mAHt1mqc6wT7I9GHyByS19zQRBiaZx2EeXKnyvslCZd4tQ/132","nickname":"zhenyun2010","note":"","ucode":"567187932468D8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":481588,"discussion_content":"这个想法很好，应该是个性能工程领域的趋势。我没有用过这样的产品。\n不过查了下，似乎有些产品号称可以做一些相关的智能分析，比如Dynatrace, AppDynamics。不过我相信就算有，也很初级。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1579320279,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}