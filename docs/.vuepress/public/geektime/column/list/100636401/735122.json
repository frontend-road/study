{"id":735122,"title":"06ï½œè§„èŒƒåŒ–ï¼šå¼•å…¥HttpRequestä¸HttpResponse","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniTomcatã€‚</p><p>åœ¨å‰é¢çš„å­¦ä¹ ç»“æŸä¹‹åï¼Œæˆ‘ä»¬å¼•å…¥äº†æ± åŒ–æŠ€æœ¯ï¼Œè¿˜å®ç°Processorçš„å¼‚æ­¥åŒ–ã€‚å‰è€…å¤ç”¨å¯¹è±¡ï¼Œå‡å°‘æ„é€ æ–°å¯¹è±¡çš„æ—¶é—´å¼€é”€ï¼›åè€…ä½¿Connectorèƒ½åŒæ—¶æœåŠ¡äºå¤šä¸ªProcessorã€‚è¿™äº›éƒ½æ˜¯æå‡æ€§èƒ½å’Œååé‡çš„å¸¸ç”¨æŠ€æœ¯æ‰‹æ®µã€‚</p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬ç»§ç»­ç ”ç©¶Servletè§„èŒƒï¼Œå¯¹æˆ‘ä»¬ç°æœ‰çš„ä»£ç è¿›è¡Œæ”¹é€ ï¼Œä½¿ä¹‹é€‚é…è¿™ä¸ªè§„èŒƒã€‚åŒæ—¶æˆ‘ä»¬è¿˜è¦è§£æHTTPåè®®ä¸­çš„è¯·æ±‚ä¿¡æ¯ï¼Œå¹¶æŠŠå®ƒå­˜å‚¨åˆ°æœåŠ¡å™¨å†…å­˜ä¹‹ä¸­ã€‚</p><p>ä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥åŠ¨æ‰‹å®ç°ã€‚</p><h2>é¡¹ç›®ç»“æ„</h2><p>è¿™èŠ‚è¯¾å› ä¸ºéœ€è¦è¿›è¡ŒServletè§„èŒƒé€‚é…å·¥ä½œï¼Œè¿˜è¦è§£æå¤´éƒ¨ä¿¡æ¯ï¼Œå› æ­¤ä¼šæ–°å¢å‡ ä¸ªç±»ï¼Œæ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">MiniTomcat\nâ”œâ”€ src\nâ”‚  â”œâ”€ main\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ server\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ DefaultHeaders.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpConnector.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpHeader.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequest.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestLine.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponse.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpServer.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Request.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Response.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ SocketInputStream.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ StatisResourceProcessor.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”œâ”€ webroot\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”œâ”€ hello.txt\nâ”œâ”€ pom.xml\n</code></pre><!-- [[[read_end]]] --><h2>Servletè§„èŒƒé€‚é…</h2><p>åœ¨Servletè§„èŒƒä¸­ï¼Œå¯¹Requestè¯·æ±‚å’ŒResponseè¿”å›æä¾›äº†å¯¹åº”çš„HTTPåè®®æ¥å£å®šä¹‰ï¼Œåˆ†åˆ«æ˜¯javax.servlet.http.HttpServletRequestå’Œjavax.servlet.http.HttpServletResponseã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°å®šä¹‰çš„æ¥å£ï¼Œå¹¶é€æ­¥å¼€å§‹è§£æå·¥ä½œã€‚</p><p>é¦–å…ˆï¼Œå®šä¹‰HttpRequestä¸HttpResponseï¼Œåˆ†åˆ«å®ç°HttpServletRequestä¸HttpServletResponseæ¥å£ã€‚å®ç°äº†è¿™ä¸ªæ¥å£ä¹‹åï¼Œå°±ä¼šè¦æ±‚å®ç°å¾ˆå¤šæ¥å£é‡Œé¢çš„æ–¹æ³•ï¼Œç»å¤§éƒ¨åˆ†æˆ‘ä»¬éƒ½æ²¡æœ‰ç”¨åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘åªåˆ—ä¸¾å‡ºå‡ ä¸ªåŸºæœ¬çš„ï¼Œä¸è¿‡åé¢æˆ‘ä¹Ÿç»™å‡ºäº†å®Œæ•´çš„ä»£ç é“¾æ¥ï¼Œä½ å¯ä»¥å‚è€ƒã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpRequest implements HttpServletRequest {\n    public Object getAttribute(String arg0) {\n        return null;\n    }\n    public Enumeration&lt;String&gt; getAttributeNames() {\n        return null;\n    }\n    public String getCharacterEncoding() {\n        return null;\n    }\n    public int getContentLength() {\n        return 0;\n    }\n    public String getContentType() {\n        return null;\n    }\n    public ServletInputStream getInputStream() throws IOException {\n        return null;\n    }\n    public String getParameter(String arg0) {\n        return null;\n    }\n    public Map&lt;String, String[]&gt; getParameterMap() {\n        return null;\n    }\n    public Enumeration&lt;String&gt; getParameterNames() {\n        return null;\n    }\n    public String[] getParameterValues(String arg0) {\n        return null;\n    }\n    public RequestDispatcher getRequestDispatcher(String arg0) {\n        return null;\n    }\n    public ServletContext getServletContext() {\n        return null;\n    }\n    public void setAttribute(String arg0, Object arg1) {\n    }\n    public void setCharacterEncoding(String arg0) throws UnsupportedEncodingException {\n    }\n    public Cookie[] getCookies() {\n        return null;\n    }\n    public String getQueryString() {\n        return null;\n    }\n    public String getRequestURI() {\n        return null;\n    }\n    public StringBuffer getRequestURL() {\n        return null;\n    }\n    public String getServletPath() {\n        return null;\n    }\n    public HttpSession getSession() {\n        return null;\n    }\n    public HttpSession getSession(boolean arg0) {\n        return null;\n    }\n}\n</code></pre><p>åŒæ ·çš„ï¼ŒHttpServletResponseæ¥å£ä¹Ÿä¼šæœ‰å¾ˆå¤šå®ç°æ–¹æ³•ã€‚æˆ‘ä»¬å…ˆå®šä¹‰ï¼Œç„¶åå†å¼€å§‹æ…¢æ…¢å®ç°ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªæ–¹æ³•éƒ½éœ€è¦ç”¨åˆ°ï¼Œç»å¤§å¤šæ•°æ–¹æ³•æš‚æ—¶å¯ä»¥ä¸ç†ä¼šã€‚ä¸‹é¢æ˜¯HttpResponseçš„å®šä¹‰ï¼Œå’Œå‰é¢ä¸€æ ·ï¼Œä¹Ÿåªåˆ—å‡ºå‡ ä¸ªåŸºæœ¬çš„æ–¹æ³•ã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpResponse implements HttpServletResponse {\n    public String getCharacterEncoding() {\n        return null;\n    }\n    public String getContentType() {\n        return null;\n    }\n    public ServletOutputStream getOutputStream() throws IOException {\n        return null;\n    }\n    public PrintWriter getWriter() throws IOException {\n        return null;\n    }\n    public void setCharacterEncoding(String arg0) {\n    }\n    public void setContentLength(int arg0) {\n    }\n    public void setContentType(String arg0) {\n    }\n    public void addCookie(Cookie arg0) {\n    }\n    public String getHeader(String arg0) {\n        return null;\n    }\n    public Collection&lt;String&gt; getHeaderNames() {\n        return null;\n    }\n    public Collection&lt;String&gt; getHeaders(String arg0) {\n        return null;\n    }\n}\n</code></pre><h2>Requestä¿¡æ¯è§£æ</h2><p>æˆ‘ä»¬æœŸæœ›ä»Servletçš„Requestè¯·æ±‚ä¸­èƒ½æ–¹ä¾¿åœ°è·å–åˆ°Headerå¤´éƒ¨çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å…ˆå…³æ³¨ä¸€ä¸‹å®šä¹‰é‡Œçš„å‡ ä¸ªæ–¹æ³•ï¼šgetHeaderã€getHeaderNamesã€getHeadersã€getParameterã€getPrameterMapã€getParameterNamesã€getParameterValuesã€‚</p><p>åœ¨HttpRequestçš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢è¿™ä¸ªç»“æ„ä¿å­˜è¿™äº›å¤´ä¿¡æ¯ã€‚</p><pre><code class=\"language-java\">protected HashMap&lt;String, String&gt; headers = new HashMap&lt;&gt;();\nprotected Map&lt;String, String&gt; parameters = new ConcurrentHashMap&lt;&gt;();\n</code></pre><p>ç»“æ„ä¸­ï¼Œheadersç”¨æ¥å­˜å‚¨å¤´çš„ä¿¡æ¯ï¼Œè€Œparameterså­˜å‚¨å‚æ•°ä¿¡æ¯ï¼Œé‡‡ç”¨ConcurrentHashMapç»“æ„ä¹Ÿæ˜¯è€ƒè™‘åˆ°å…è®¸Servletå¹¶å‘è¿›è¡Œå¢åŠ åˆ é™¤ä¿®æ”¹æ“ä½œã€‚</p><p>åœ¨æ­£å¼å¼€å§‹è§£æè¿™äº›å‚æ•°ä¿¡æ¯ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šä»€ä¹ˆæ—¶å€™è§£æï¼Ÿç›®å‰å¯ä»¥è€ƒè™‘ä¸¤ç§æ–¹æ¡ˆï¼šä¸€æ˜¯åœ¨Connectorä¸­é¢„å…ˆå…¨éƒ¨è§£æå®Œæ¯•ï¼Œä½†è¿™ç§æ–¹å¼æ€§ä»·æ¯”å¹¶ä¸é«˜ï¼Œå› ä¸ºHeaderä¿¡æ¯æœ‰æ•°åä¸ªï¼Œç”šè‡³ä¸Šç™¾ä¸ªï¼Œè€Œä¸€ä¸ªServletä¸­å®é™…ç”¨åˆ°çš„å¯èƒ½åªæœ‰å¯¥å¯¥æ•°ä¸ªï¼›å¦å¤–ä¸€ç§æ˜¯åœ¨Servletå®é™…è¯»å–Requestçš„æ—¶å€™ï¼Œæ ¹æ®Requestä¼ å…¥çš„Headerä¿¡æ¯æ¯æ¬¡éƒ½è¿›è¡Œè§£æã€‚</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘åšå‡ºé€‰æ‹©ï¼šåœ¨Connectorå¯åŠ¨åï¼Œè§£æå¤´éƒ¨ä¿¡æ¯ï¼Œè€Œå‚æ•°ä¿¡æ¯åˆ™åœ¨Servletéœ€è¦ä½¿ç”¨æ—¶å†è§£æã€‚æ”¾åœ¨ä¸åŒçš„æ—¶é—´ç‚¹è§£æå¤´éƒ¨å’Œå‚æ•°ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ä¸ºäº†æé«˜æ•ˆç‡ã€‚è¿™ä¸ªé€‰æ‹©æ˜¯å‚è€ƒäº†Tomcatçš„åšæ³•ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹ç€æ‰‹<strong>è§£æRequest</strong>ã€‚</p><p>åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬éƒ½æ˜¯ç”¨InputStreamè¿›è¡Œè§£æï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ä¾æ¬¡è¯»å–ï¼Œæ•ˆç‡ä¸é«˜ã€‚è¿™é‡Œæˆ‘ä»¬è‡ªå·±å‡†å¤‡ä¸€ä¸ªç±»â€”â€”SocketInputStreamï¼Œç›´æ¥æŒ‰è¡Œè¯»å–ï¼Œè·å–Request lineä¸Headerã€‚</p><p>é¦–å…ˆå®šä¹‰HttpRequestLineç±»ã€‚è¿™ä¸ªç±»æ˜¯Http Requestå¤´è¡Œçš„æŠ½è±¡ï¼Œæ ¼å¼æ˜¯method uri protocolï¼Œå¦‚ <code>GET /hello.txt HTTP/1.1</code>ã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpRequestLine {\n    public static final int INITIAL_METHOD_SIZE = 8;\n    public static final int INITIAL_URI_SIZE = 128;\n    public static final int INITIAL_PROTOCOL_SIZE = 8;\n    public static final int MAX_METHOD_SIZE = 32;\n    public static final int MAX_URI_SIZE = 2048;\n    public static final int MAX_PROTOCOL_SIZE = 32;\n    \n    //ä¸‹é¢çš„å±æ€§å¯¹åº”äºHttp Requestè§„èŒƒï¼Œå³å¤´è¡Œæ ¼å¼method uri protocol\n    //å¦‚ï¼šGET /hello.txt HTTP/1.1\n    //char[] å­˜å‚¨æ¯æ®µçš„å­—ç¬¦ä¸²ï¼Œå¯¹åº”çš„intå€¼å­˜å‚¨çš„æ˜¯æ¯æ®µçš„ç»“æŸä½ç½®\n    public char[] method;\n    public int methodEnd;\n    public char[] uri;\n    public int uriEnd;\n    public char[] protocol;\n    public int protocolEnd;\n    public HttpRequestLine() {\n        this(new char[INITIAL_METHOD_SIZE], 0, new char[INITIAL_URI_SIZE], 0,\n                new char[INITIAL_PROTOCOL_SIZE], 0);\n    }\n    public HttpRequestLine(char[] method, int methodEnd,\n                           char[] uri, int uriEnd,\n                           char[] protocol, int protocolEnd) {\n        this.method = method;\n        this.methodEnd = methodEnd;\n        this.uri = uri;\n        this.uriEnd = uriEnd;\n        this.protocol = protocol;\n        this.protocolEnd = protocolEnd;\n    }\n    public void recycle() {\n        methodEnd = 0;\n        uriEnd = 0;\n        protocolEnd = 0;\n    }\n    public int indexOf(char[] buf) {\n        return indexOf(buf, buf.length);\n    }\n    //è¿™æ˜¯ä¸»è¦çš„æ–¹æ³•\n    //åœ¨uri[]ä¸­æŸ¥æ‰¾å­—ç¬¦ä¸²bufçš„å‡ºç°ä½ç½®\n    public int indexOf(char[] buf, int end) {\n        char firstChar = buf[0];\n        int pos = 0; //posæ˜¯æŸ¥æ‰¾å­—ç¬¦ä¸²bufåœ¨uri[]ä¸­çš„å¼€å§‹ä½ç½®\n        while (pos &lt; uriEnd) {\n            pos = indexOf(firstChar, pos); //é¦–å­—ç¬¦å®šä½å¼€å§‹ä½ç½®\n            if (pos == -1) {\n                return -1;\n            }\n            if ((uriEnd - pos) &lt; end) {\n                return -1;\n            }\n            for (int i = 0; i &lt; end; i++) { //ä»å¼€å§‹ä½ç½®èµ·é€ä¸ªå­—ç¬¦æ¯”å¯¹\n                if (uri[i + pos] != buf[i]) {\n                    break;\n                }\n                if (i == (end - 1)) { //æ¯ä¸ªå­—ç¬¦éƒ½ç›¸ç­‰ï¼Œåˆ™åŒ¹é…ä¸Šäº†ï¼Œè¿”å›å¼€å§‹ä½ç½®\n                    return pos;\n                }\n            }\n            pos++;\n        }\n        return -1;\n    }\n    public int indexOf(String str) {\n        return indexOf(str.toCharArray(), str.length());\n    }\n    //åœ¨uri[]ä¸­æŸ¥æ‰¾å­—ç¬¦cçš„å‡ºç°ä½ç½®\n    public int indexOf(char c, int start) {\n        for (int i = start; i &lt; uriEnd; i++) {\n            if (uri[i] == c) {\n                return i;\n            }\n        }\n        return -1;\n    }\n}\n</code></pre><p>HttpRequestLineé‡Œï¼ŒåŒ…å«methodã€uriå’Œprotocolç­‰ä¿¡æ¯ï¼Œè¿™æ˜¯æ ¹æ®HTTPåè®®æ¥å®šä¹‰çš„ã€‚åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œç”¨çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªcharæ•°ç»„ï¼Œè¿™æ ·å¯ä»¥ä»inputstreamä¸­ç›´æ¥è¯»å–ä¸‹æ¥ï¼Œä¸ç”¨ç»è¿‡Stringçš„è½¬æ¢ï¼Œæé«˜äº†æ•ˆç‡ï¼Œä½†ä¹Ÿå› æ­¤è¦æä¾›xxxEndå‡ ä¸ªå±æ€§æ¥æ ‡è¯†æœ€åä¸€ä¸ªå­—ç¬¦çš„ä½ç½®ï¼Œç¨‹åºçš„å¤æ‚åº¦æé«˜äº†ä¸€äº›ã€‚</p><p>è¿™ä¸ªå·¥å…·ç±»é‡Œé¢æä¾›äº† <code>indexOf()</code> æ–¹æ³•æ¥åŒ¹é…uriï¼Œå®ç°æ–¹æ³•æ˜¯charæ•°ç»„çš„åŒé‡å¾ªç¯åŒ¹é…ã€‚å…·ä½“å¯ä»¥çœ‹ä¸Šé¢ä»£ç é‡Œçš„æ³¨é‡Šã€‚</p><p>æ¥ä¸‹æ¥å†å®šä¹‰HttpHeaderç±»ã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpHeader {\n     public static final int INITIAL_NAME_SIZE = 64;\n     public static final int INITIAL_VALUE_SIZE = 512;\n     public static final int MAX_NAME_SIZE = 128;\n     public static final int MAX_VALUE_SIZE = 1024;\n     public char[] name;\n     public int nameEnd;\n     public char[] value;\n     public int valueEnd;\n     protected int hashCode = 0;\n     public HttpHeader() {\n         this(new char[INITIAL_NAME_SIZE], 0, new char[INITIAL_VALUE_SIZE], 0);\n     }\n     public HttpHeader(char[] name, int nameEnd, char[] value, int valueEnd) {\n         this.name = name;\n         this.nameEnd = nameEnd;\n         this.value = value;\n         this.valueEnd = valueEnd;\n     }\n     public HttpHeader(String name, String value) {\n         this.name = name.toLowerCase().toCharArray();\n         this.nameEnd = name.length();\n         this.value = value.toCharArray();\n         this.valueEnd = value.length();\n     }\n     public void recycle() {\n         nameEnd = 0;\n         valueEnd = 0;\n         hashCode = 0;\n     }\n}\n\n</code></pre><p>æ ¹æ®ä¸Šé¢çš„å®ç°å¯ä»¥çœ‹åˆ°ï¼ŒHttpRequestLineé‡ŒåŒ…å«methodã€uriä¸protocolï¼ŒHttpHeaderä¸­åŒ…å«nameä¸valueã€‚å®ç°çš„ç±»é‡Œé¢è¿˜åŒ…å«xxxEndç±»å‹çš„åŸŸå®šä¹‰ï¼Œç”¨æ¥æ ‡è¯†æŸä¸€å±æ€§æœ€åçš„ä½ç½®ã€‚</p><p>åœ¨HttpRequestLineä¸HttpHeaderç±»å®šä¹‰å®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨SocketInputStreamä¸­å®šä¹‰ä¸¤ä¸ªæ–¹æ³•ï¼Œç›´æ¥è·å–Request lineä¸Headersã€‚</p><pre><code class=\"language-java\">public void readRequestLine(HttpRequestLine requestLine){}\npublic void readHeader(HttpHeader header){}\n</code></pre><p>å¯ä»¥å›å¿†ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰è§£æHeaderé¦–è¡Œçš„ç»è¿‡ï¼šæŒ‰è¡Œè¯»å–æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¾æ®ç©ºæ ¼åˆ†éš”ï¼Œè·å–methodã€uriå’Œprotocolã€‚ç°åœ¨æˆ‘ä»¬å‚è€ƒTomcatï¼Œåœ¨SocketInputStreamé‡Œæä¾›ä¸€ä¸ªæ›´ä¸“ä¸šã€æ›´é«˜æ•ˆçš„å®ç°ã€‚</p><pre><code class=\"language-java\">protected void fill() throws IOException {\n    pos = 0;\n    count = 0;\n    int nRead = is.read(buf, 0, buf.length);\n    if (nRead &gt; 0) {\n        count = nRead;\n    }\n}\n</code></pre><p>ä¸Šè¿°ä»£ç æ˜¾ç¤ºï¼Œfillæ–¹æ³•ä¼šä»InputStreamé‡Œè¯»å–ä¸€æ‰¹å­—èŠ‚ï¼Œå­˜å‚¨åˆ°byteæ•°ç»„çš„bufå±æ€§ä¸­ã€‚</p><p>è€Œ <code>fill()</code> è¢«è°ƒç”¨åˆ° <code>read()</code> æ–¹æ³•å†…ï¼Œæ¯æ¬¡ä»bufä¸­è¯»åˆ°å½“å‰çš„å­—èŠ‚è¿”å›ï¼Œå¦‚æœ <code>pos &gt;= count</code> è¡¨ç¤ºå½“å‰çš„byteå·²è·å–å®Œæ¯•ï¼Œå†…éƒ¨å°±è°ƒç”¨fillæ–¹æ³•è·å–æ–°çš„å­—èŠ‚æµã€‚å› æ­¤ï¼Œå¯¹ä¸Šå±‚ç¨‹åºå‘˜æ¥è¯´ï¼Œä½¿ç”¨ <code>read()</code> å°±ç›¸å½“äºå¯ä»¥è¿ç»­è¯»å–ç¼“å­˜ä¸­çš„æ•°æ®ã€‚</p><p>readæ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p><pre><code class=\"language-java\">@Override\npublic int read() throws IOException {\n    if (pos &gt;= count) {\n        fill();\n        if (pos &gt;= count) {\n            return -1;\n        }\n    }\n    return buf[pos++] &amp; 0xff;\n}\n</code></pre><p>å…¶ä¸­è¿™ä¸ªæ–¹æ³•è¿”å›-1è¡¨ç¤ºè¯»å–å‡ºé”™ã€‚</p><p>æœ‰äº†è¿™äº›é“ºå«ï¼Œæˆ‘ä»¬å†æ¥çœ‹SocketInputStreamçš„å®Œæ•´å®ç°ã€‚ç®€å•åœ°è¯´ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨å°±æ˜¯ä»è¾“å…¥æµä¸­è¯»å‡ºrequest lineå’Œheaderä¿¡æ¯æ¥ã€‚</p><pre><code class=\"language-java\">package server;\npublic class SocketInputStream extends InputStream {\n    private static final byte CR = (byte) '\\r';\n    private static final byte LF = (byte) '\\n';\n    private static final byte SP = (byte) ' ';\n    private static final byte HT = (byte) '\\t';\n    private static final byte COLON = (byte) ':';\n    private static final int LC_OFFSET = 'A' - 'a';\n    protected byte buf[];\n    protected int count;\n    protected int pos;\n    protected InputStream is;\n    public SocketInputStream(InputStream is, int bufferSize) {\n        this.is = is;\n        buf = new byte[bufferSize];\n    }\n    //ä»è¾“å…¥æµä¸­è§£æå‡ºrequest line\n    public void readRequestLine(HttpRequestLine requestLine)\n        throws IOException {\n        int chr = 0;\n        //è·³è¿‡ç©ºè¡Œ\n        do {\n            try {\n                chr = read();\n            } catch (IOException e) {\n            }\n        } while ((chr == CR) || (chr == LF));\n        //ç¬¬ä¸€ä¸ªéç©ºä½ç½®\n        pos--;\n        int maxRead = requestLine.method.length;\n        int readStart = pos;\n        int readCount = 0;\n        boolean space = false;\n        //è§£æç¬¬ä¸€æ®µmethodï¼Œä»¥ç©ºæ ¼ç»“æŸ\n        while (!space) {\n            if (pos &gt;= count) {\n                int val = read();\n                if (val == -1) {\n                    throw new IOException(\"requestStream.readline.error\");\n                }\n                pos = 0;\n                readStart = 0;\n            }\n            if (buf[pos] == SP) {\n                space = true;\n            }\n            requestLine.method[readCount] = (char) buf[pos];\n            readCount++;\n            pos++;\n        }\n        requestLine.methodEnd = readCount - 1; //methodæ®µçš„ç»“æŸä½ç½®\n        \n        maxRead = requestLine.uri.length;\n        readStart = pos;\n        readCount = 0;\n        space = false;\n        boolean eol = false;\n        //è§£æç¬¬äºŒæ®µuriï¼Œä»¥ç©ºæ ¼ç»“æŸ\n        while (!space) {\n            if (pos &gt;= count) {\n                int val = read();\n                if (val == -1)\n                    throw new IOException(\"requestStream.readline.error\");\n                pos = 0;\n                readStart = 0;\n            }\n            if (buf[pos] == SP) {\n                space = true;\n            }\n            requestLine.uri[readCount] = (char) buf[pos];\n            readCount++;\n            pos++;\n        }\n        requestLine.uriEnd = readCount - 1; //uriç»“æŸä½ç½®\n        \n        maxRead = requestLine.protocol.length;\n        readStart = pos;\n        readCount = 0;\n        //è§£æç¬¬ä¸‰æ®µprotocolï¼Œä»¥eolç»“å°¾\n        while (!eol) {\n            if (pos &gt;= count) {\n                int val = read();\n                if (val == -1)\n                    throw new IOException(\"requestStream.readline.error\");\n                pos = 0;\n                readStart = 0;\n            }\n            if (buf[pos] == CR) {\n                // Skip CR.\n            } else if (buf[pos] == LF) {\n                eol = true;\n            } else {\n                requestLine.protocol[readCount] = (char) buf[pos];\n                readCount++;\n            }\n            pos++;\n        }\n        requestLine.protocolEnd = readCount;\n    }\n    public void readHeader(HttpHeader header)\n        throws IOException {\n        int chr = read();\n        if ((chr == CR) || (chr == LF)) { // Skipping CR\n            if (chr == CR)\n                read(); // Skipping LF\n            header.nameEnd = 0;\n            header.valueEnd = 0;\n            return;\n        } else {\n            pos--;\n        }\n        // æ­£åœ¨è¯»å– header name\n        int maxRead = header.name.length;\n        int readStart = pos;\n        int readCount = 0;\n        boolean colon = false;\n        while (!colon) {\n            // æˆ‘ä»¬å¤„äºå†…éƒ¨ç¼“å†²åŒºçš„æœ«å°¾\n            if (pos &gt;= count) {\n                int val = read();\n                if (val == -1) {\n                    throw new IOException(\"requestStream.readline.error\");\n                }\n                pos = 0;\n                readStart = 0;\n            }\n            if (buf[pos] == COLON) {\n                colon = true;\n            }\n            char val = (char) buf[pos];\n            if ((val &gt;= 'A') &amp;&amp; (val &lt;= 'Z')) {\n                val = (char) (val - LC_OFFSET);\n            }\n            header.name[readCount] = val;\n            readCount++;\n            pos++;\n        }\n        header.nameEnd = readCount - 1;\n        // è¯»å– header å€¼ï¼ˆå¯ä»¥è·¨è¶Šå¤šè¡Œï¼‰\n        maxRead = header.value.length;\n        readStart = pos;\n        readCount = 0;\n        int crPos = -2;\n        boolean eol = false;\n        boolean validLine = true;\n        while (validLine) {\n            boolean space = true;\n            // è·³è¿‡ç©ºæ ¼\n            // æ³¨æ„ï¼šä»…åˆ é™¤å‰é¢çš„ç©ºæ ¼ï¼Œåé¢çš„ä¸åˆ ã€‚\n            while (space) {\n                // æˆ‘ä»¬å·²ç»åˆ°äº†å†…éƒ¨ç¼“å†²åŒºçš„å°½å¤´\n                if (pos &gt;= count) {\n                    // å°†å†…éƒ¨ç¼“å†²åŒºçš„ä¸€éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¤åˆ¶åˆ°è¡Œç¼“å†²åŒº\n                    int val = read();\n                    if (val == -1)\n                        throw new IOException(\"requestStream.readline.error\");\n                    pos = 0;\n                    readStart = 0;\n                }\n                if ((buf[pos] == SP) || (buf[pos] == HT)) {\n                    pos++;\n                } else {\n                    space = false;\n                }\n            }\n            while (!eol) {\n                // æˆ‘ä»¬å·²ç»åˆ°äº†å†…éƒ¨ç¼“å†²åŒºçš„å°½å¤´\n                if (pos &gt;= count) {\n                    // å°†å†…éƒ¨ç¼“å†²åŒºçš„ä¸€éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¤åˆ¶åˆ°è¡Œç¼“å†²åŒº\n                    int val = read();\n                    if (val == -1)\n                        throw new IOException(\"requestStream.readline.error\");\n                    pos = 0;\n                    readStart = 0;\n                }\n                if (buf[pos] == CR) {\n                } else if (buf[pos] == LF) {\n                    eol = true;\n                } else {\n                    // FIXMEï¼šæ£€æŸ¥äºŒè¿›åˆ¶è½¬æ¢æ˜¯å¦æ­£å¸¸\n                    int ch = buf[pos] &amp; 0xff;\n                    header.value[readCount] = (char) ch;\n                    readCount++;\n                }\n                pos++;\n            }\n            int nextChr = read();\n            if ((nextChr != SP) &amp;&amp; (nextChr != HT)) {\n                pos--;\n                validLine = false;\n            } else {\n                eol = false;\n                header.value[readCount] = ' ';\n                readCount++;\n            }\n        }\n        header.valueEnd = readCount;\n    }\n    @Override\n    public int read() throws IOException {\n        if (pos &gt;= count) {\n            fill();\n            if (pos &gt;= count) {\n                return -1;\n            }\n        }\n        return buf[pos++] &amp; 0xff;\n    }\n    public int available() throws IOException {\n        return (count - pos) + is.available();\n    }\n    public void close() throws IOException {\n        if (is == null) {\n            return;\n        }\n        is.close();\n        is = null;\n        buf = null;\n    }\n    protected void fill() throws IOException {\n        pos = 0;\n        count = 0;\n        int nRead = is.read(buf, 0, buf.length);\n        if (nRead &gt; 0) {\n            count = nRead;\n        }\n    }\n}\n</code></pre><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒTomcatåœ¨è¿™é‡Œå°±æ˜¯ç”¨çš„æœ€ç®€å•çš„æ‰«ææ–¹æ³•ï¼Œä»inputstreamé‡Œè¯»ä¸€ä¸ªä¸ªçš„å­—èŠ‚ï¼Œæ”¾åˆ°bufé‡Œï¼Œbufæœ‰é•¿åº¦é™åˆ¶ï¼Œè¯»åˆ°å°¾åå°±ä»å¤´å†æ¥ã€‚ç„¶åä»bufé‡Œä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°åˆ¤æ–­ï¼Œposå˜é‡ä»£è¡¨å½“å‰è¯»å–çš„ä½ç½®ï¼Œæ ¹æ®åè®®è§„å®šçš„åˆ†éš”ç¬¦è§£æåˆ°requestlineå’Œheaderé‡Œã€‚</p><p>æ‹¥æœ‰äº†å·¥å…·ç±»åï¼ŒRequestå†…è·å–Request lineå°±æ¯”è¾ƒå®¹æ˜“äº†ï¼Œåœ¨HttpRequestä¸­å®šä¹‰parseæ–¹æ³•ï¼Œç›´æ¥ç”¨SocketInputStreamè§£æã€‚</p><pre><code class=\"language-java\">public void parse(Socket socket) {\n    this.sis.readRequestLine(requestLine);\n    this.uri = new String(requestLine.uri, 0, requestLine.uriEnd);\n}\n</code></pre><p>è¿™ä¸ªæ—¶å€™HttpProcessorä¸­å°±ä¸ç”¨Requestç±»æ„å»ºå¯¹è±¡äº†ï¼Œæ”¹ç”¨HttpRequestã€‚</p><pre><code class=\"language-java\">HttpRequest request = new HttpRequest(input);\nrequest.parse(socket);\n</code></pre><p>æ‰€ä»¥ServletProcessorå’ŒStaticResourceProcessoré‡Œçš„processæ–¹æ³•ï¼Œä¼ å…¥çš„Requestç±»å‹å‚æ•°éƒ½æ”¹æˆHttpRequestã€‚</p><p>åŒç†ï¼Œæˆ‘ä»¬æ¥è§£æHeaderã€‚å’Œå‰é¢ä¸€æ ·ï¼Œåœ¨SocketInputStreamé‡Œå·²å®šä¹‰äº† <code>readHeader(HttpHeader header)</code> æ–¹æ³•ï¼Œå°†å¤´ä¿¡æ¯è¯»å…¥headerå±æ€§ä¸­ã€‚æˆ‘ä»¬å…ˆå®šä¹‰DefaultHeaderså¸¸é‡ç±»ï¼Œå‡è®¾æ”¯æŒä¸‹é¢è¿™äº›å¤´ä¿¡æ¯ã€‚</p><pre><code class=\"language-java\">package server;\npublic class DefaultHeaders {\n    static final String HOST_NAME = \"host\";\n    static final String CONNECTION_NAME = \"connection\";\n    static final String ACCEPT_LANGUAGE_NAME = \"accept-language\";\n    static final String CONTENT_LENGTH_NAME = \"content-length\";\n    static final String CONTENT_TYPE_NAME = \"content-type\";\n    static final String TRANSFER_ENCODING_NAME = \"transfer-encoding\";\n}\n</code></pre><p>æ¥ä¸‹æ¥åœ¨HttpRequestä¸­å¯å®šä¹‰parseHeadersæ–¹æ³•è§£æå¤´ä¿¡æ¯ã€‚</p><pre><code class=\"language-java\">private void parseHeaders() throws IOException, ServletException {\n    while (true) {\n        HttpHeader header = new HttpHeader();\n        sis.readHeader(header);\n        if (header.nameEnd == 0) {\n            if (header.valueEnd == 0) {\n                return;\n            } else {\n                throw new ServletException(\"httpProcessor.parseHeaders.colon\");\n            }\n        }\n        String name = new String(header.name,0,header.nameEnd);\n        String value = new String(header.value, 0, header.valueEnd);\n        // Set the corresponding request headers\n        if (name.equals(DefaultHeaders.ACCEPT_LANGUAGE_NAME)) {\n            headers.put(name, value);\n        } else if (name.equals(DefaultHeaders.CONTENT_LENGTH_NAME)) {\n            headers.put(name, value);\n        } else if (name.equals(DefaultHeaders.CONTENT_TYPE_NAME)) {\n            headers.put(name, value);\n        } else if (name.equals(DefaultHeaders.HOST_NAME)) {\n            headers.put(name, value);\n        } else if (name.equals(DefaultHeaders.CONNECTION_NAME)) {\n            headers.put(name, value);\n        } else if (name.equals(DefaultHeaders.TRANSFER_ENCODING_NAME)) {\n            headers.put(name, value);\n        } else {\n            headers.put(name, value);\n        }\n    }\n</code></pre><p>ç›®å‰å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æˆ‘ä»¬æ”¯æŒçš„å¤´ä¿¡æ¯ï¼Œæ”¯æŒåç›´æ¥å­˜å…¥headersè¿™ä¸ªmapæ•°æ®ç»“æ„é‡Œã€‚parseæ–¹æ³•åˆ™æ”¯æŒè§£æRequest Lineä¸Headerã€‚</p><p>ç»¼åˆä»¥ä¸Šå†…å®¹ï¼Œæˆ‘ä»¬æ¥é‡æ–°å®ç°HttpRequestç±»ï¼ŒHttpServletRequestæ¥å£çš„é‚£äº›ç°åœ¨æ²¡æœ‰ç”¨åˆ°çš„æ–¹æ³•æš‚æ—¶ä¸åˆ—å‡ºæ¥ã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpRequest implements HttpServletRequest {\n    private InputStream input;\n    private SocketInputStream sis;\n    private String uri;\n    InetAddress address;\n    int port;\n    protected HashMap&lt;String, String&gt; headers = new HashMap&lt;&gt;();\n    protected Map&lt;String, String&gt; parameters = new ConcurrentHashMap&lt;&gt;();\n    HttpRequestLine requestLine = new HttpRequestLine();\n    public HttpRequest(InputStream input) {\n        this.input = input;\n        this.sis = new SocketInputStream(this.input, 2048);\n    }\n    public void parse(Socket socket) {\n        try {\n            parseConnection(socket);\n            this.sis.readRequestLine(requestLine);\n            parseHeaders();\n        } catch (IOException e) {\n            e.printStackTrace();\n        } catch (ServletException e) {\n            e.printStackTrace();\n        }\n        this.uri = new String(requestLine.uri, 0, requestLine.uriEnd);\n    }\n    private void parseConnection(Socket socket) {\n        address = socket.getInetAddress();\n        port = socket.getPort();\n    }\n    private void parseHeaders() throws IOException, ServletException {\n        while (true) {\n            HttpHeader header = new HttpHeader();\n            sis.readHeader(header);\n            if (header.nameEnd == 0) {\n                if (header.valueEnd == 0) {\n                    return;\n                } else {\n                    throw new ServletException(\"httpProcessor.parseHeaders.colon\");\n                }\n            }\n            String name = new String(header.name,0,header.nameEnd);\n            String value = new String(header.value, 0, header.valueEnd);\n            // è®¾ç½®ç›¸åº”çš„è¯·æ±‚å¤´\n            if (name.equals(DefaultHeaders.ACCEPT_LANGUAGE_NAME)) {\n                headers.put(name, value);\n            } else if (name.equals(DefaultHeaders.CONTENT_LENGTH_NAME)) {\n                headers.put(name, value);\n            } else if (name.equals(DefaultHeaders.CONTENT_TYPE_NAME)) {\n                headers.put(name, value);\n            } else if (name.equals(DefaultHeaders.HOST_NAME)) {\n                headers.put(name, value);\n            } else if (name.equals(DefaultHeaders.CONNECTION_NAME)) {\n                headers.put(name, value);\n            } else if (name.equals(DefaultHeaders.TRANSFER_ENCODING_NAME)) {\n                headers.put(name, value);\n            } else {\n                headers.put(name, value);\n            }\n        }\n    }\n    public String getUri() {\n        return this.uri;\n    }\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªHttpRequestå·²ç»ç›¸å¯¹ç®€å•äº†ã€‚</p><h2>æµ‹è¯•</h2><p>æˆ‘ä»¬è¿™ä¸€èŠ‚è¯¾çš„å®ç°åªæ˜¯å†…éƒ¨çš„ç¨‹åºç»“æ„å˜åŠ¨ï¼Œå¹¶ä¸å½±å“ç”¨æˆ·çš„Servletå’Œå®¢æˆ·ç«¯çš„è®¿é—®ã€‚æ‰€ä»¥è¿˜æ˜¯å¯ä»¥æ²¿ç”¨ä¸Šä¸€èŠ‚è¯¾çš„æµ‹è¯•åŠæ³•è¿›è¡ŒéªŒè¯ï¼Œè¿™é‡Œæˆ‘å°±ä¸é‡å¤è¯´äº†ã€‚</p><h2>å°ç»“</h2><p><img src=\"https://static001.geekbang.org/resource/image/7f/12/7fd829bfd127af9e1b2b4e3bc4abe412.jpg?wh=4358x2555\" alt=\"\"></p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼šä¸€æ˜¯è¿›ä¸€æ­¥é€‚é…Servletè§„èŒƒï¼Œå®ç°HttpServletRequestå’ŒHttpServletResponseä¸¤ä¸ªæ¥å£ã€‚æˆ‘ä»¬çœ‹åˆ°æ¥å£ä¸­æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œç›®å‰æˆ‘ä»¬ç»å¤§éƒ¨åˆ†éƒ½æ²¡æœ‰å®ç°ï¼Œæ˜¯ç•™ç©ºçŠ¶æ€ï¼Œåªæ˜¯å…ˆå®ç°æœ€åŸºæœ¬çš„å‡ ä¸ªæ–¹æ³•å°±å¯ä»¥è®©ç¨‹åºè¿è¡Œèµ·æ¥äº†ã€‚</p><p>äºŒæ˜¯å¼•å…¥SocketInputStreamï¼ŒæŒ‰è¡Œè¯»å–Requestä¿¡æ¯ï¼Œè§£æRequest lineä¸headerä¿¡æ¯ï¼Œæé«˜æ•ˆç‡å’Œæ€§èƒ½ï¼Œæ‘’å¼ƒäº†æˆ‘ä»¬åŸæœ‰çš„è§£ææ¨¡å¼ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ç§æ›´åŠ é«˜æ•ˆçš„å®ç°åŠæ³•ã€‚</p><p>è¿™ä¸¤ä»¶äº‹æƒ…æœ¬èº«å¹¶æ²¡æœ‰æ‰©å±•æˆ‘ä»¬æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œç›®çš„æ˜¯ç¬¦åˆè§„èŒƒå¹¶ä¸”é«˜æ•ˆï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬è¦å‘Tomcatå­¦ä¹ ã€‚</p><p>æœ¬èŠ‚è¯¾å®Œæ•´ä»£ç å‚è§ï¼š<a href=\"https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter06\">https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter06</a></p><h2>æ€è€ƒé¢˜</h2><p>å­¦å®Œäº†è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬åœ¨ <code>SocketInputStreamçš„read()</code> æ–¹æ³•ä¸­ï¼Œç”¨åˆ°äº†ketInputStreamçš„read()æ–¹æ³•ä¸­ï¼Œç”¨åˆ°äº† <code>buf[pos++] &amp; 0xff</code> è¿™ä¸ªæ“ä½œï¼Œå®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ æ€è€ƒåçš„ç»“æœåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"05ï½œServeræ€§èƒ½æå‡ï¼šè®¾è®¡å¤šä¸ªProcessor","id":735114},"right":{"article_title":"07ï½œå¯¹å†…çš„ä¿æŠ¤ï¼šå¼•å…¥é—¨é¢æ¨¡å¼å°è£…å†…éƒ¨å®ç°ç±»","id":737438}},"comments":[{"had_liked":false,"id":385662,"user_name":"C.","can_delete":false,"product_type":"c1","uid":1444698,"ip_address":"æ±Ÿè‹","ucode":"5AE269220EFD73","user_header":"https://static001.geekbang.org/account/avatar/00/16/0b/5a/453ad411.jpg","comment_is_top":false,"comment_ctime":1703059839,"is_pvip":false,"replies":[{"id":140572,"content":"ä½ è¯´çš„æ˜¯å¯¹çš„ã€‚æˆ‘ç”¨è‡ªå·±çš„è¯­è¨€ç»„ç»‡ä¸€ä¸‹ï¼š\nbyteè½¬intæˆ–è€…charçš„æ—¶å€™, å¦‚æœbyteåŸæœ¬æ˜¯æ­£æ•°ï¼Œè¡¥é›¶æ‰©å±•æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nä½†æ˜¯å¯¹äºè´Ÿæ•°çš„æƒ…å†µï¼Œé«˜ä½ä¼šè¡¥1ï¼Œé€ æˆäºŒè¿›åˆ¶è¡¥ç ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ç”¨&amp;0xff\nå°†é«˜ä½è¡¥é›¶ï¼Œä½8ä½ä¿æŒåŸæ ·ï¼Œè¿™æ ·äºŒè¿›åˆ¶è¡¥ç æ˜¯ä¸€è‡´çš„ã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1703149379,"ip_address":"æ±Ÿè‹","comment_id":385662,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"buf[pos++]ï¼šè¡¨ç¤ºbufçš„posç´¢å¼•åŠ ä¸€ï¼Œä»¥ä¾¿åç»­readæ“ä½œï¼Œæ˜¯ä¸ªåç¼€é€’å¢çš„æ“ä½œã€‚\n&amp; 0xffï¼šä½æ“ä½œï¼Œå­—èŠ‚åœ¨Javaçš„ä¸­çš„èŒƒå›´ä¸º-128åˆ°127ï¼Œæ˜¯ä¸ªæœ‰ç¬¦å·æ•°ï¼Œæ‰§è¡Œ&amp; 0xffæ˜¯åœ¨åšä¸€ä¸ªæŒ‰ä½ä¸æ“ä½œï¼Œè½¬æ¢ä¸ºä¸€ä¸ªæ— ç¬¦å·æ•°ï¼Œè¿”å›çš„å€¼åœ¨0-255ã€‚0xffç­‰äºåè¿›åˆ¶çš„255ï¼ŒäºŒè¿›åˆ¶ä½11111111ã€‚buf[pos]å­—èŠ‚ä¼šä¸11111111è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œï¼ŒåŸºæœ¬ä¿æŒäº†åŸå§‹å­—èŠ‚çš„å€¼ä¸å˜ã€‚","like_count":4,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634275,"discussion_content":"ä½ è¯´çš„æ˜¯å¯¹çš„ã€‚æˆ‘ç”¨è‡ªå·±çš„è¯­è¨€ç»„ç»‡ä¸€ä¸‹ï¼š\nbyteè½¬intæˆ–è€…charçš„æ—¶å€™, å¦‚æœbyteåŸæœ¬æ˜¯æ­£æ•°ï¼Œè¡¥é›¶æ‰©å±•æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nä½†æ˜¯å¯¹äºè´Ÿæ•°çš„æƒ…å†µï¼Œé«˜ä½ä¼šè¡¥1ï¼Œé€ æˆäºŒè¿›åˆ¶è¡¥ç ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ç”¨&amp;0xff\nå°†é«˜ä½è¡¥é›¶ï¼Œä½8ä½ä¿æŒåŸæ ·ï¼Œè¿™æ ·äºŒè¿›åˆ¶è¡¥ç æ˜¯ä¸€è‡´çš„ã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703149379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ±Ÿè‹","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":2,"child_discussions":[{"author":{"id":1214384,"avatar":"https://static001.geekbang.org/account/avatar/00/12/87/b0/b06d25f4.jpg","nickname":"Yï½é¾™ã€‚ï¼","note":"","ucode":"21D0AF4DCC880A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":635000,"discussion_content":"è¿™æ ·çš„è¯ï¼ŒåŸæœ¬æ˜¯è´Ÿæ•°çš„ï¼Œç»è¿‡é«˜ä½è¡¥0ä¸å°±å˜æˆæ­£æ•°äº†å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704272203,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":634275,"ip_address":"å¹¿è¥¿","group_id":0},"score":635000,"extra":""},{"author":{"id":1607786,"avatar":"https://static001.geekbang.org/account/avatar/00/18/88/6a/fe18b26d.jpg","nickname":"åå­—å¥½è…»å®³","note":"","ucode":"2D157076F1D5B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1214384,"avatar":"https://static001.geekbang.org/account/avatar/00/12/87/b0/b06d25f4.jpg","nickname":"Yï½é¾™ã€‚ï¼","note":"","ucode":"21D0AF4DCC880A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":643066,"discussion_content":"æˆ‘çš„ç†è§£æ˜¯,httpçš„è¯·æ±‚å¤´å¿…é¡»ç”¨ascç¼–ç ,å®ƒå•ä¸ªå­—èŠ‚ä¸ä¼šå‡ºç°è´Ÿå€¼,è€Œjavaçš„å­—èŠ‚æ˜¯æœ‰ç¬¦å·çš„,é‚£ä¹ˆç›´æ¥ç”¨byteè½¬char,ä¼šè¢«å½“åšunicodeç¼–ç å€¼è¿›è¡Œè§£æ,ä¼šé€ æˆé”™è¯¯;ä¸€å®šè¦ç”¨intå…ˆæ¥,ç„¶ååœ¨éœ€è¦çš„æ—¶å€™è½¬char,æ‰èƒ½ä¿è¯æ˜¯ascç¼–ç ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1714014947,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":635000,"ip_address":"æ¹–åŒ—","group_id":0},"score":643066,"extra":""}]}]},{"had_liked":false,"id":385796,"user_name":"Clark Chen","can_delete":false,"product_type":"c1","uid":1939363,"ip_address":"è¾½å®","ucode":"C0E5AECA4CE7C5","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTL212ET0q3e8U5xXuYe7LCBlrpdBFkrgedibfdao2fMUKnCWwxm2I05RB7EyDcgeL0g60ib88cn2dmQ/132","comment_is_top":false,"comment_ctime":1703402309,"is_pvip":false,"replies":[{"id":140594,"content":"å¯¹ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯æ•ˆç‡ä¸Šçš„åŸå› ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1703486998,"ip_address":"å¹¿ä¸œ","comment_id":385796,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è€å¸ˆå¥½ï¼Œ å…³äº`SocketInputStream .readRequestLine(HttpRequestLine requestLine)`   æ–¹æ³•çš„è¿™æ®µä»£ç \n```   \n   while (!space) {\n            if (pos &gt;= count) {\n                int val = read();\n                if (val == -1) {\n                    throw new IOException(&quot;requestStream.readline.error&quot;);\n                }\n                pos = 0;\n                readStart = 0;\n            }\n            if (buf[pos] == SP) {\n                space = true;\n            }\n            requestLine.method[readCount] = (char) buf[pos];\n            readCount++;\n            pos++;\n        }\n```\næœ‰äº›åœ°æ–¹æ²¡æƒ³æ˜ç™½ï¼Œ ä¸ºä»€ä¹ˆè¦åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å¯¹æ‰‹åŠ¨æ§åˆ¶pos++ï¼Œç›´æ¥è·å–buf[]é‡Œé¢çš„å€¼ ï¼Œè€Œä¸æ˜¯é€šè¿‡read æ–¹æ³•æ¥è·å–å€¼ã€‚å¦‚ä¸‹é¢è¿™æ ·\n```\n        while (!space){\n            if(pos &gt;= count ){\n                readStart = 0;\n            }\n            int val = read();\n            if(val == -1){\n                throw new IOException(&quot;requestStream.readline.error&quot;);\n            }\n            if(val == SP){\n                space =true;\n            }\n            requestLine.getMethod()[readCount] = (char)val;\n            readCount++;\n        }\n```\næ˜¯æœ‰æ•ˆç‡ä¸Šçš„åŸå› å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634419,"discussion_content":"å¯¹ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯æ•ˆç‡ä¸Šçš„åŸå› ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703486998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385677,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1703079255,"is_pvip":false,"replies":[{"id":140570,"content":"ifæ˜¯ç”¨æ¥å¤„ç†ç‰¹æ®Šheaderçš„ï¼Œå¦‚æœä¸æ˜¯è¿™äº›ç‰¹æ®Šçš„headerï¼Œç»Ÿä¸€put","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1703148704,"ip_address":"æ±Ÿè‹","comment_id":385677,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š\nQ1ï¼šparametersç”¨æ¥åšä»€ä¹ˆï¼Ÿ\nHttpRequestç±»ä¸­å®šä¹‰äº†parametersï¼Œä½†å¥½åƒå¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œè¿™ä¸ªç±»æ˜¯ç”¨æ¥å­˜ä»€ä¹ˆçš„ï¼Ÿ\nQ2ï¼šparseHeaderså‡½æ•°ç”¨ifåŒºåˆ†æœ‰æ„ä¹‰å—ï¼Ÿ\nHttpRequestç±»ä¸­çš„parseHeadersç”¨if â€¦ elseæ¥åŒºåˆ†å„ä¸ªéƒ¨åˆ†ï¼Œä½†å…¶å®æœ€åéƒ½æ˜¯è°ƒç”¨headers.put(name, value);\næ‰€æœ‰çš„åˆ†æ”¯ï¼Œæœ€åçš„å¤„ç†ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªåŒºåˆ†è¿˜æœ‰æ„ä¹‰å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634273,"discussion_content":"ifæ˜¯ç”¨æ¥å¤„ç†ç‰¹æ®Šheaderçš„ï¼Œå¦‚æœä¸æ˜¯è¿™äº›ç‰¹æ®Šçš„headerï¼Œç»Ÿä¸€put","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703148704,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ±Ÿè‹","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385640,"user_name":"HHğŸ·ğŸ ","can_delete":false,"product_type":"c1","uid":1133678,"ip_address":"å¹¿ä¸œ","ucode":"C50172BDA604D5","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","comment_is_top":false,"comment_ctime":1703033577,"is_pvip":false,"replies":[{"id":140573,"content":"byteè½¬intæˆ–è€…charçš„æ—¶å€™, å¦‚æœbyteåŸæœ¬æ˜¯æ­£æ•°ï¼Œè¡¥é›¶æ‰©å±•æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nä½†æ˜¯å¯¹äºè´Ÿæ•°çš„æƒ…å†µï¼Œé«˜ä½ä¼šè¡¥1ï¼Œé€ æˆäºŒè¿›åˆ¶è¡¥ç ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ç”¨&amp;0xff\nå°†é«˜ä½è¡¥é›¶ï¼Œä½8ä½ä¿æŒåŸæ ·ï¼Œè¿™æ ·äºŒè¿›åˆ¶è¡¥ç æ˜¯ä¸€è‡´çš„ã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1703149404,"ip_address":"æ±Ÿè‹","comment_id":385640,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"ğŸ˜„æ„Ÿè§‰åƒæ˜¯çº æ­£ä»€ä¹ˆæ•°æ®","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634276,"discussion_content":"byteè½¬intæˆ–è€…charçš„æ—¶å€™, å¦‚æœbyteåŸæœ¬æ˜¯æ­£æ•°ï¼Œè¡¥é›¶æ‰©å±•æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nä½†æ˜¯å¯¹äºè´Ÿæ•°çš„æƒ…å†µï¼Œé«˜ä½ä¼šè¡¥1ï¼Œé€ æˆäºŒè¿›åˆ¶è¡¥ç ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ç”¨&amp;0xff\nå°†é«˜ä½è¡¥é›¶ï¼Œä½8ä½ä¿æŒåŸæ ·ï¼Œè¿™æ ·äºŒè¿›åˆ¶è¡¥ç æ˜¯ä¸€è‡´çš„ã€‚\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1703149404,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ±Ÿè‹","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}