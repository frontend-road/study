{"id":829789,"title":"45ï½œMySQLæºç åˆ†æå’ŒGDBè°ƒè¯•å™¨çš„åº”ç”¨","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>ä¹‹å‰åœ¨è¯„è®ºåŒºæœ‰åŒå­¦ç•™è¨€é—®æ˜¯å¦èƒ½åŠ ä¸€è®²æºä»£ç è°ƒè¯•çš„å†…å®¹ã€‚è€ƒè™‘åˆ°è¿™ä¸ªä¸“æ ä¸­æœ‰ç›¸å½“å¤šçš„ç¯‡å¹…æ˜¯è®²MySQLå’ŒInnoDBçš„å†…éƒ¨å®ç°æœºåˆ¶ï¼Œè€Œæˆ‘è‡ªå·±åœ¨æ•´ç†è¿™äº›å†…éƒ¨åŸç†æ—¶ï¼Œä¹Ÿå‚è€ƒäº†å¤§é‡çš„MySQLæºç ï¼Œæœ‰æ—¶ä¹Ÿä¼šç”¨GDBæ¥è°ƒè¯•è·Ÿè¸ªä»£ç çš„æ‰§è¡Œï¼Œå› æ­¤åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å°±æ¥èŠèŠMySQLæºç åˆ†æå’ŒGDBåœ¨æºç åˆ†æä¸­çš„ä¸€äº›ä½¿ç”¨åœºæ™¯ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åªè®¨è®ºMySQLçš„æºç åˆ†æï¼Œä¸æ¶‰åŠåˆ°æ€ä¹ˆä¿®æ”¹MySQLæºç æ¥å®ç°ä¸€äº›å®šåˆ¶åŒ–çš„åŠŸèƒ½ã€‚</p><h2>MySQLæºç ä»‹ç»</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å°±ä»¥å½“å‰8.0ç³»åˆ—ä¸­æœ€æ–°çš„Releaseç‰ˆæœ¬8.0.40ä¸ºä¾‹ï¼Œä¸‹è½½ä»£ç å¹¶è§£å‹ã€‚æˆ‘ä»¬å…ˆç®€å•çœ‹ä¸€ä¸‹MySQLæºç æ–‡ä»¶çš„ç»„ç»‡ï¼ˆåªæ˜¯ä¸ºäº†çœ‹ç»“æ„ï¼Œä¸‹é¢çš„è¾“å‡ºä¸­ï¼ŒæŠŠå¾ˆå¤šå†…å®¹åˆ å‡æ‰äº†ï¼‰ã€‚</p><pre><code class=\"language-plain\"># tree -d -L 2\n...\nâ”œâ”€â”€ include\nâ”œâ”€â”€ mysys\nâ”œâ”€â”€ plugin\nâ”‚   â”œâ”€â”€ auth\nâ”‚   â”œâ”€â”€ clone\n...\nâ”‚   â”œâ”€â”€ group_replication\n...\nâ”‚   â”œâ”€â”€ semisync\nâ”‚   â””â”€â”€ x\n......\nâ”œâ”€â”€ sql\nâ”‚   â”œâ”€â”€ auth\nâ”‚   â”œâ”€â”€ binlog\nâ”‚   â”œâ”€â”€ changestreams\nâ”‚   â”œâ”€â”€ conn_handler\nâ”‚   â”œâ”€â”€ containers\nâ”‚   â”œâ”€â”€ daemon_proxy_keyring\nâ”‚   â”œâ”€â”€ dd\nâ”‚   â”œâ”€â”€ examples\nâ”‚   â”œâ”€â”€ gis\nâ”‚   â”œâ”€â”€ histograms\nâ”‚   â”œâ”€â”€ iterators\nâ”‚   â”œâ”€â”€ join_optimizer\nâ”‚   â”œâ”€â”€ locks\nâ”‚   â”œâ”€â”€ memory\nâ”‚   â”œâ”€â”€ partitioning\nâ”‚   â”œâ”€â”€ protobuf\nâ”‚   â”œâ”€â”€ raii\nâ”‚   â”œâ”€â”€ range_optimizer\nâ”‚   â”œâ”€â”€ server_component\nâ”‚   â””â”€â”€ xa\nâ”œâ”€â”€ sql-common\nâ”‚   â””â”€â”€ oci\nâ”œâ”€â”€ storage\n......\nâ”‚   â”œâ”€â”€ innobase\nâ”‚   â””â”€â”€ temptable\nâ””â”€â”€ vio\n</code></pre><!-- [[[read_end]]] --><p>æˆ‘ä»¬å…ˆå¯¹æºç ä¸­çš„ä¸€éƒ¨åˆ†ç›®å½•åšä¸€ä¸ªç®€å•çš„ä»‹ç»ã€‚</p><h3>plugin</h3><p>pluginç›®å½•ä¸‹æ˜¯æ’ä»¶çš„æºç ï¼Œæ¯”å¦‚ä¸“æ ä¸­ä»‹ç»è¿‡çš„cloneæ’ä»¶ã€semisyncæ’ä»¶ã€group_replicationæ’ä»¶ï¼Œæ¯ä¸ªpluginçš„ä»£ç åœ¨å¯¹åº”çš„ç›®å½•ä¸‹ã€‚</p><h3>sql</h3><p>MySQL Serveræ ¸å¿ƒæ¨¡å—çš„å¤§é‡æºä»£ç éƒ½åœ¨sqlç›®å½•ä¸‹ã€‚8.0.40ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªç›®å½•ä¸‹æœ‰æ¥è¿‘100ä¸‡è¡Œæºç ã€‚</p><pre><code class=\"language-plain\"># find sql -regextype posix-egrep -regex '(.*\\.cc)|(.*\\.h)' | \\\n  xargs wc -l | \\\n  tail -1\n\n940750 total\n</code></pre><ul>\n<li>\n<p>sql/sql_yacc.yyæ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œå®šä¹‰äº†MySQLä¸­SQLçš„è¯­æ³•ã€‚</p>\n</li>\n<li>\n<p>sql/mysqld.ccé‡Œå®šä¹‰äº†mysqld_mainï¼Œè¿™æ˜¯MySQLæ•°æ®åº“å¯åŠ¨æ—¶è°ƒç”¨çš„å…¥å£å‡½æ•°ã€‚</p>\n</li>\n<li>\n<p>sql/iteratorsç›®å½•ä¸‹æ˜¯SQLæ‰§è¡Œå¼•æ“çš„ä»£ç ï¼ŒåŒ…æ‹¬è¡¨æ‰«æã€ç´¢å¼•æ‰«æã€è¡¨è¿æ¥çš„æ‰§è¡Œã€‚</p>\n</li>\n<li>\n<p>sql/sql_optimizer.ccé‡Œçš„JOIN::optimizeæ˜¯ä¼˜åŒ–å™¨çš„ä¸€ä¸ªå…¥å£å‡½æ•°ã€‚</p>\n</li>\n<li>\n<p>sql/sql_parse.ccä¸­çš„do_commandå‡½æ•°ï¼Œè¯»å–å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚ï¼ˆå‘½ä»¤æˆ–SQLï¼‰ï¼Œå¹¶æ ¹æ®è¯·æ±‚çš„ç±»å‹è¿›è¡Œåˆ†å‘ï¼ˆdispatch_commandï¼‰ã€‚</p>\n</li>\n<li>\n<p>sql/conn_handlerç›®å½•ä¸­æ˜¯MySQLå¤„ç†æ–°å»ºè¿æ¥è¯·æ±‚çš„ä»£ç ã€‚é»˜è®¤ä½¿ç”¨connection_handler_per_thread.ccï¼Œä¹Ÿå°±æ˜¯ç»™æ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p>\n</li>\n<li>\n<p>sql/ddç›®å½•ä¸‹æ˜¯æ•°æ®å­—å…¸çš„å®ç°ä»£ç ã€‚æ•°æ®å­—å…¸è¡¨çš„å®šä¹‰ï¼Œåˆå§‹åŒ–æ•°æ®åº“ï¼ˆmysqld --initializeï¼‰æ—¶æ€ä¹ˆåˆ›å»ºæ•°æ®å­—å…¸è¡¨ï¼Œæ•°æ®åº“å¯åŠ¨æ—¶æ€ä¹ˆåŠ è½½æ•°æ®å­—å…¸è¡¨ï¼Œå¾ˆå¤šä»£ç éƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚</p>\n</li>\n<li>\n<p>sql/log_event.ccé‡Œï¼Œå®šä¹‰äº†ä¸åŒç±»å‹Binlogäº‹ä»¶çš„æ ¼å¼ã€‚</p>\n</li>\n<li>\n<p>sql/handler.ccé‡Œå®ç°äº†handlerç±»ã€‚è¯»å–æˆ–ä¿®æ”¹è¡¨é‡Œçš„æ•°æ®ï¼Œéƒ½ä¼šé€šè¿‡handleræ¥å£æ¥å®ç°ã€‚å­˜å‚¨å¼•æ“ç»§æ‰¿handlerç±»ï¼ˆæ¯”å¦‚innodbçš„ha_innobaseï¼‰ï¼Œå®ç°æ•°æ®çš„è¯»å†™åŠŸèƒ½ã€‚</p>\n</li>\n</ul><h3>storage/innobase</h3><p>storageç›®å½•ä¸­æ˜¯MySQLæ”¯æŒçš„å„ä¸ªå­˜å‚¨å¼•æ“çš„å®ç°ä»£ç ã€‚InnoDBçš„ä»£ç åœ¨innobaseç›®å½•ä¸­ï¼Œä»£ç é‡æ¥è¿‘50ä¸‡è¡Œã€‚</p><pre><code class=\"language-plain\"># find storage/innobase -regextype posix-egrep -regex '(.*\\.cc)|(.*\\.h)|(.*\\.ic)' | \\\n    xargs wc -l | \\\n    tail -1\n\n460953 total\n</code></pre><p>InnoDBçš„ä»£ç ï¼ŒæŒ‰åŠŸèƒ½æ¨¡å—ï¼Œåˆ†ä¸ºå¤šä¸ªç›®å½•ã€‚</p><pre><code class=\"language-plain\"># tree -d -L 1\n.\n|-- api\n|-- arch\n|-- btr\n|-- buf\n|-- clone\n|-- data\n|-- ddl\n|-- dict\n|-- eval\n|-- fil\n|-- fsp\n|-- fts\n|-- fut\n|-- gis\n|-- ha\n|-- handler\n|-- ibuf\n|-- include\n|-- lob\n|-- lock\n|-- log\n|-- mach\n|-- mem\n|-- mtr\n|-- os\n|-- page\n|-- pars\n|-- que\n|-- read\n|-- rem\n|-- row\n|-- srv\n|-- sync\n|-- trx\n|-- usr\n`-- ut\n</code></pre><p>è¿™é‡Œå…ˆåšä¸€ä¸ªç®€å•çš„ä»‹ç»ã€‚</p><h4>includeç›®å½•</h4><p>includeç›®å½•é‡Œæ˜¯InnoDBä»£ç ä½¿ç”¨çš„ä¸€äº›å¤´æ–‡ä»¶ã€‚</p><p>fil0types.hä¸­å®šä¹‰äº†InnoDBé¡µé¢çš„åŸºæœ¬æ ¼å¼ï¼Œè¿™é‡Œå®šä¹‰äº†é¡µé¢å¤´éƒ¨å’Œå°¾éƒ¨ä¸­å„ä¸ªå­—æ®µåœ¨é¡µé¢å†…çš„åç§»åœ°å€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9e/ae/9eac015161963d542f6a045c13af91ae.png?wh=1310x1148\" alt=\"å›¾ç‰‡\"></p><p>fsp0fsp.hä¸­å®šä¹‰äº†æ–‡ä»¶å¤´ï¼ˆSpace Headerï¼‰çš„æ ¼å¼ï¼Œè¿˜å®šä¹‰äº†Inodeã€åŒºæè¿°ç¬¦ï¼ˆXDESï¼‰ç­‰è¿™äº›ç”¨æ¥ç®¡ç†æ–‡ä»¶ç©ºé—´çš„æ•°æ®ç»“æ„çš„å­˜å‚¨æ ¼å¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c4/73/c4201d80fff8378c9d4429a290de5373.png?wh=1326x1314\" alt=\"å›¾ç‰‡\"></p><p>page0types.hä¸­å®šä¹‰äº†B+æ ‘é¡µé¢å¤´çš„æ ¼å¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e1/66/e194558ca269e784f7824c6831051166.png?wh=1302x888\" alt=\"å›¾ç‰‡\"></p><p>åœ¨ä»£ç é‡Œæœç´¢è¿™é‡Œå®šä¹‰çš„å¸¸é‡ï¼Œèƒ½å¾ˆå¿«æ‰¾åˆ°ä½¿ç”¨è¿™äº›å¸¸é‡çš„ä»£ç ï¼Œå°±èƒ½ç†è§£è¿™äº›å­—æ®µçš„ä½œç”¨ã€‚æ¯”å¦‚æœç´¢PAGE_HEAP_TOPï¼Œçœ‹åˆ°å‡½æ•°page_mem_alloc_heapä¸­ä¼šå†™å…¥è¿™ä¸ªå­—æ®µï¼ˆpage0page.cc 243è¡Œï¼‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4e/e4/4e9d538b4b123fec083ba273bebc0ae4.png?wh=1454x1162\" alt=\"å›¾ç‰‡\"></p><p>å†æœç´¢page_mem_alloc_heapï¼Œå‘ç°è¿™ä¸ªå‡½æ•°åœ¨insertæ—¶è¢«è°ƒç”¨ï¼ˆpage0cur.cc page_cur_insert_rec_lowï¼‰ï¼Œç„¶åå°±å¯ä»¥çœ‹åˆ°insertçš„è®°å½•æ˜¯æ€ä¹ˆå†™åˆ°æ•°æ®å—ä¸­äº†ï¼ˆå‚è€ƒpage_cur_insert_rec_lowä¸­æ ‡äº†ç¼–å·çš„å‡ è¡Œä»£ç æ³¨é‡Šï¼‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/16/34/161017495c4be2412ebfb699dyy9c434.png?wh=1604x1254\" alt=\"å›¾ç‰‡\"></p><p>æ ¹æ®è¿™å‡ ä¸ªå¤´æ–‡ä»¶ï¼Œå†åˆ°ä»£ç ä¸­æœç´¢å’Œåˆ†æä½¿ç”¨äº†è¿™äº›å¸¸é‡çš„ä¸€äº›ä»£ç ï¼Œå°±èƒ½æ•´ç†å‡º<a href=\"https://time.geekbang.org/column/article/804972\">25</a>ã€<a href=\"https://time.geekbang.org/column/article/816184\">26</a>è¿™ä¸¤è®²ä¸­çš„é¡µé¢ç‰©ç†æ ¼å¼äº†ã€‚</p><h4>rem</h4><p>remç›®å½•ä¸‹æ˜¯å®šä¹‰å’Œæ“ä½œè¡Œè®°å½•æ ¼å¼çš„ä»£ç ã€‚rem0rec.ccé‡Œå®šä¹‰äº†InnoDBæ”¯æŒçš„ä¸¤å¤§ç±»è¡Œæ ¼å¼ï¼Œä¸€ç±»æ˜¯REDUNDANTæ ¼å¼ï¼Œä¹Ÿå°±æ˜¯æ³¨é‡Šä¸­çš„â€œOLD STYLEâ€ï¼Œå¦ä¸€ç±»æ˜¯Compactç±»å‹ï¼ŒåŒ…æ‹¬compactã€dynamicã€compressedï¼Œä¹Ÿå°±æ˜¯æ³¨é‡Šä¸­çš„â€œNEW STYLEâ€ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3b/ce/3b07c08973f62046a21be87cb18ebace.png?wh=1170x1208\" alt=\"å›¾ç‰‡\"></p><h4>page</h4><p>pageç›®å½•ä¸‹ä¸»è¦æ˜¯æ“ä½œB+æ ‘é¡µé¢å†…å®¹çš„ä»£ç ï¼ŒåŒ…æ‹¬åˆ›å»ºB+æ ‘é¡µé¢ã€å¾€é¡µé¢ä¸­æ’å…¥è®°å½•ã€åˆ é™¤é¡µé¢ä¸­çš„è®°å½•ç­‰ä»£ç ï¼Œè¿˜æœ‰ç»´æŠ¤é¡µç›®å½•é¡¹çš„ä»£ç ã€‚</p><h4>btr</h4><p>btrç›®å½•ä¸‹ä¸»è¦B+æ ‘ç›¸å…³çš„ä»£ç ã€‚B+æ ‘æ˜¯InnoDBä¸­æœ€æ ¸å¿ƒçš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚è¿™é‡ŒåŒ…æ‹¬åœ¨B+æ ‘ä¸­æŸ¥æ‰¾è®°å½•ï¼ˆbtr_cur_search_to_nth_levelï¼‰ã€æ’å…¥è®°å½•ï¼ˆbtr_cur_optimistic_insertï¼Œbtr_cur_pessimistic_insertï¼‰ã€æ›´æ–°è®°å½•ï¼ˆbtr_cur_update_in_placeã€btr_cur_optimistic_updateã€btr_cur_pessimistic_updateï¼‰ã€åˆ é™¤è®°å½•ï¼ˆbtr_cur_optimistic_deleteã€btr_cur_pessimistic_deleteï¼‰çš„ä»£ç ï¼Œä¹ŸåŒ…æ‹¬äº†ç»´æŠ¤è‡ªé€‚åº”Hashç´¢å¼•çš„ä»£ç ã€‚</p><h4>row</h4><p>rowç›®å½•ä¸‹åŒ…æ‹¬äº†æ“ä½œè¡Œçš„ç›¸å…³ä»£ç ï¼Œæ¯”å¦‚æ’å…¥è¡Œï¼ˆrow_insert_for_mysqlï¼‰ã€æ›´æ–°æˆ–åˆ é™¤è¡Œï¼ˆrow_update_for_mysqlï¼‰ã€æ¸…ç†è¡Œï¼ˆrow_purgeï¼‰ã€‚</p><p>row_search_mvccæ˜¯è¿™é‡Œæ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼Œä»InnoDBä¸­æŸ¥è¯¢æ•°æ®ï¼ŒåŒ…æ‹¬æ‰§è¡ŒSelectè¯­å¥ï¼Œæˆ–è€…æ‰§è¡ŒDeleteå’ŒUpdateè¯­å¥æ—¶ï¼Œéƒ½ä¼šé€šè¿‡è¿™ä¸ªå‡½æ•°æ¥æŸ¥è¯¢æ•°æ®ã€‚å‡½æ•°row_vers_build_for_consistent_readç”¨æ¥æ„å»ºè®°å½•çš„å†å²ç‰ˆæœ¬ã€‚</p><p>MySQL Serverå±‚å’ŒInnoDBå±‚ä½¿ç”¨äº†ä¸åŒçš„è¡Œå’Œå­—æ®µå­˜å‚¨æ ¼å¼ï¼Œè¿™é‡Œæä¾›äº†æ ¼å¼è½¬æ¢å‡½æ•°ï¼Œrow_mysql_convert_row_to_innobaseå°†MySQLè¡Œæ ¼å¼è½¬æ¢æˆInnoDBè¡Œæ ¼å¼ï¼Œrow_sel_store_mysql_recå°†InnoDBè¡Œæ ¼å¼è½¬æ¢æˆMySQLè¡Œæ ¼å¼ã€‚</p><p>è¿™é‡Œè¿˜åŒ…æ‹¬äº†å›æ»šè¡Œæ“ä½œçš„ä»£ç ï¼ˆrow_undoï¼Œrow_undo_insï¼Œrow_undo_modï¼‰ã€‚</p><p>å½“è¡¨ä¸Šæœ‰Online DDLåœ¨æ‰§è¡Œæ—¶ï¼Œå¯¹è¡¨çš„DMLæ“ä½œéœ€è¦è®°å½•åˆ°åœ¨çº¿å˜æ›´æ—¥å¿—ä¸­ã€‚åœ¨çº¿åˆ›å»ºç´¢å¼•æ—¶ï¼ŒDMLæ“ä½œé€šè¿‡row_log_online_opè®°å½•ï¼ŒDDLæ‰§è¡Œç»“æŸå‰ï¼Œé€šè¿‡row_log_applyå‡½æ•°åº”ç”¨åœ¨çº¿å˜æ›´æ—¥å¿—ã€‚åœ¨çº¿Rebuildè¡¨æ—¶ï¼Œè¡¨ä¸Šçš„DMLæ“ä½œé€šè¿‡row_log_tableå‡½æ•°æ¥è®°å½•ï¼ŒDDLæ‰§è¡Œå®Œæˆå‰ï¼Œä½¿ç”¨row_log_table_applyåº”ç”¨åœ¨çº¿å˜æ›´æ—¥å¿—ã€‚</p><h4>trx</h4><p>trxç›®å½•ä¸­æ˜¯äº‹åŠ¡å¤„ç†çš„ç›¸å…³ä»£ç ï¼ŒåŒ…æ‹¬äº‹åŠ¡æäº¤ï¼ˆtrx_commitï¼Œtrx_commit_in_memory, trx_release_impl_and_expl_locksï¼‰ã€äº‹åŠ¡å›æ»šï¼ˆtrx_rollback_for_mysqlï¼‰ã€‚</p><p>Undoæ—¥å¿—ï¼Œé€šè¿‡å‡½æ•°trx_undo_report_row_operationè®°å½•ã€‚å¦‚æœæƒ³äº†è§£äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è®°å½•äº†å“ªäº›Undoæ—¥å¿—ä»¥åŠUndoæ—¥å¿—çš„å…·ä½“æ ¼å¼ï¼Œå¯ä»¥åˆ†æè¿™ä¸ªå‡½æ•°ã€‚æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œè¦æ‰§è¡Œå´©æºƒæ¢å¤ï¼Œå‡½æ•°trx_recover_for_mysqlç”¨æ¥æŸ¥æ‰¾å¤„äºPreparedçŠ¶æ€çš„äº‹åŠ¡ã€‚è¿™é‡Œè¿˜åŒ…æ‹¬äº†å›æ»šæ®µå’ŒUndoæ®µå¤„ç†çš„ç›¸å…³ä»£ç ã€‚</p><h4>buf</h4><p>bufç›®å½•ä¸­æ˜¯InnoDB Buffer Poolçš„å®ç°ä»£ç ï¼ŒåŒ…æ‹¬Buffer Poolçš„ç»“æ„ï¼ŒBuffer Poolä¸­çš„å„ä¸ªé“¾è¡¨å’ŒHashè¡¨ã€‚</p><h4>fsp</h4><p>fspç›®å½•ä¸­æ˜¯InnoDBè¡¨ç©ºé—´ç®¡ç†çš„ç›¸å…³ä»£ç ï¼ŒåŒ…æ‹¬åˆ†é…é¡µé¢ã€é‡Šæ”¾é¡µé¢ç©ºé—´ç­‰ã€‚</p><h4>handler</h4><p>handerç›®å½•ä¸‹æ˜¯MySQL å­˜å‚¨å¼•æ“Handleræ¥å£çš„å®ç°ä»£ç ã€‚MySQL Serverå±‚è°ƒç”¨InnoDB Handlerä»£ç ï¼Œè¯»å–æˆ–å†™å…¥æ•°æ®ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡ã€‚ç±»ha_innobaseä¸­å®ç°äº†è®¿é—®InnoDBæ•°æ®çš„å‡½æ•°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/0f/b1/0fd58956828d9fe5de56d4844fbf07b1.png?wh=1356x1446\" alt=\"å›¾ç‰‡\"></p><p>å‡½æ•°innodb_initä¸­è®¾ç½®äº†ä¸€ç³»åˆ—ç»™serverå±‚è°ƒç”¨çš„å‡½æ•°ã€‚åŠ è½½InnoDBæ’ä»¶æ—¶è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/08/00/08318a717cyydc968c660e5dceebac00.png?wh=1324x1274\" alt=\"å›¾ç‰‡\"></p><h4>log</h4><p>logç›®å½•ä¸‹æ˜¯Redoçš„ç›¸å…³ä»£ç ï¼ŒåŒ…æ‹¬ç®¡ç†Log Bufferç©ºé—´ï¼Œåˆ†é…Logåºåˆ—å·ï¼Œå°†Redoæ—¥å¿—å†™å…¥Log Bufferã€‚</p><p>log_writerã€log_flusherã€log_checkpointerè¿™å‡ ä¸ªæ˜¯Redoç³»ç»Ÿçš„å‡ ä¸ªå…³é”®çº¿ç¨‹çš„ä¸»å‡½æ•°ï¼Œè´Ÿè´£Redoæ—¥å¿—çš„æŒä¹…åŒ–ã€‚æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œè°ƒç”¨log_start_background_threadså‡½æ•°ï¼Œå¯åŠ¨è¿™äº›çº¿ç¨‹ï¼Œä»¥åŠå…¶ä»–ä¸€äº›çº¿ç¨‹ã€‚</p><p>æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œè°ƒç”¨å‡½æ•°recv_recovery_from_checkpoint_startï¼Œæ‰«æå’Œè§£æcheckpointä¹‹åçš„æ‰€æœ‰Redoæ—¥å¿—ã€‚</p><p>å‡½æ•°recv_scan_log_recsè§£æRedoæ—¥å¿—ï¼Œå¹¶å°†è§£æå‡ºæ¥çš„æ—¥å¿—å…ˆåŠ åˆ°Hashè¡¨ä¸­ã€‚å‡½æ•°recv_apply_hashed_log_recsåº”ç”¨hashè¡¨ä¸­çš„Redoæ—¥å¿—ã€‚</p><h4>mtr</h4><p>mtrç›®å½•ä¸­æ˜¯Mini Transactionç›¸å…³ä»£ç ã€‚mlog_writeå¼€å¤´çš„ä¸€ç³»åˆ—å‡½æ•°ï¼ˆmlog_open_and_write_indexï¼Œmlog_write_stringï¼Œmlog_write_ulintï¼Œmlog_write_ullï¼Œmlog_write_initial_dict_log_recordç­‰ï¼‰ç”ŸæˆRedoæ—¥å¿—ï¼Œå†™åˆ°mtr bufferä¸­ã€‚åœ¨è¿™äº›å‡½æ•°ä¸Šè®¾ç½®æ–­ç‚¹ï¼Œå°±èƒ½çœ‹åˆ°äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šç”Ÿæˆå“ªäº›Redoæ—¥å¿—ï¼Œä»¥åŠæ—¥å¿—çš„æ ¼å¼ã€‚</p><p>mlog_parseå¼€å¤´çš„ä¸€ç³»åˆ—å‡½æ•°ï¼ˆmlog_parse_initial_log_recordï¼Œmlog_parse_nbytesï¼Œmlog_parse_stringï¼Œmlog_parse_indexç­‰ï¼‰ä»Redoæ–‡ä»¶ä¸­è§£ææ—¥å¿—ã€‚mtr_tæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ•°æ®ç»“æ„ï¼Œm_impl.m_memoè®°å½•äº†mtræ‰§è¡Œè¿‡ç¨‹ä¸­ä¿®æ”¹çš„æ•°æ®å—ã€è·å–çš„é”å¯¹è±¡å’Œé”æ¨¡å¼ï¼Œm_impl.m_logä¸­è®°å½•äº†Redoæ—¥å¿—ã€‚mtræäº¤æ—¶ï¼ˆmtr_t::commitï¼‰ï¼Œm_logä¸­çš„Redoæ—¥å¿—å¤åˆ¶åˆ°Redo Log Bufferï¼Œä¿®æ”¹è¿‡çš„è„é¡µæ·»åŠ åˆ°Flushé“¾è¡¨ï¼Œmtræ‰§è¡Œè¿‡ç¨‹ä¸­è·å–çš„é”ï¼Œä¹Ÿä¼šåœ¨æäº¤æ—¶è§£é”ï¼ˆmemo_slot_releaseï¼‰ã€‚</p><h4>srv</h4><p>srvç›®å½•ä¸‹ï¼ŒåŒ…æ‹¬äº†InnoDBä¸€äº›æœåŠ¡çº¿ç¨‹çš„ä»£ç ï¼Œå¦‚srv_master_threadã€srv_worker_threadã€srv_purge_coordinator_threadã€srv_monitor_threadã€srv_error_monitor_threadã€‚æ•°æ®åº“å¯åŠ¨æ—¶è°ƒç”¨srv_startå¯åŠ¨InnoDBã€‚</p><h2>ä½¿ç”¨ä»£ç åˆ†æå·¥å…·</h2><p>å‰é¢å¯¹MySQLçš„ä»£ç åšäº†ä¸€ä¸ªéå¸¸ç®€å•çš„ä»‹ç»ï¼Œè¿˜æä¾›äº†ä¸€äº›æ¯”è¾ƒå…³é”®çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ä»¥ä½œä¸ºäº†è§£MySQLæºç çš„ä¸€ä¸ªèµ·ç‚¹ã€‚ä½†æ˜¯MySQLçš„æºç ï¼Œä»£ç æ–‡ä»¶æ•°å¤šï¼Œä»£ç é‡å¤§ï¼Œä»£ç é£æ ¼ä¸ç»Ÿä¸€ï¼Œå‡½æ•°è°ƒç”¨å±‚æ¬¡æ¯”è¾ƒæ·±ã€‚åˆ©ç”¨ä¸€äº›å·¥å…·ï¼Œèƒ½å¸®æˆ‘ä»¬æ›´å¥½åœ°ç†è§£è¿™äº›ä»£ç ã€‚</p><p>æœ‰ä¸€äº›ä»£ç åˆ†æå·¥å…·ï¼Œæ¯”å¦‚SourceInsightï¼Œèƒ½åˆ†æå‡½æ•°ã€æ–¹æ³•ã€å…¨å±€å˜é‡ã€ç»“æ„ã€ç±»ç­‰ç¬¦å·ä¿¡æ¯ã€‚èƒ½æ˜¾ç¤ºå‚è€ƒæ ‘ã€ç±»ç»§æ‰¿å›¾å’Œè°ƒç”¨æ ‘ç­‰ï¼Œç›´è§‚åœ°å±•ç¤ºå‡½æ•°çš„è°ƒç”¨å…³ç³»ã€ç±»çš„ç»§æ‰¿å±‚æ¬¡ç­‰ã€‚è¿˜èƒ½è¿…é€Ÿæœç´¢æ•´ä¸ªé¡¹ç›®ï¼Œæ‰¾åˆ°ç¬¦å·çš„å®šä¹‰ä½ç½®ã€è¢«è°ƒç”¨ä½ç½®ç­‰æ‰€æœ‰å¼•ç”¨ï¼Œæ–¹ä¾¿è¿½è¸ªä»£ç çš„æ‰§è¡Œè·¯å¾„å’Œæ•°æ®æµå‘ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»‹ç»ä¸€æ¬¾è½»é‡ï¼Œä½†åŠŸèƒ½å¼ºå¤§çš„æºä»£ç ç¼–è¾‘å™¨ï¼ŒVSCodeã€‚å®‰è£…ä¸ŠC/C++æ‰©å±•åï¼Œä½¿ç”¨VSCodeå¯ä»¥æ–¹ä¾¿åœ°åˆ†æMySQLæºç ã€‚VSCodeè¿˜å¯ä»¥æ•´åˆç¼–è¯‘ã€è°ƒè¯•å·¥å…·ï¼Œä¸è¿‡è¿™é‡Œæˆ‘åªç”¨äº†ä»£ç åˆ†æåŠŸèƒ½ã€‚å¦‚æœä½ æœ‰å…´è¶£ï¼Œä¹Ÿå¯ä»¥å°è¯•åœ¨VSCodeä¸­æ•´åˆè°ƒè¯•å·¥å…·ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7c/49/7c3a51702a365f9e8ebf135c87b09a49.png?wh=1232x1108\" alt=\"å›¾ç‰‡\"></p><h3>ä½¿ç”¨VSCodeåˆ†æä»£ç </h3><p>æ¥ä¸‹æ¥å°±ä½¿ç”¨VSCodeï¼Œæ¥åˆ†æä¸‹æ•°æ®åº“å´©æºƒæ¢å¤æ—¶ï¼Œæ€ä¹ˆå¤„ç†PreparedçŠ¶æ€çš„äº‹åŠ¡ã€‚<a href=\"https://time.geekbang.org/column/article/821006\">35 è®²</a>ä¸­çš„â€œäºŒé˜¶æ®µæäº¤â€è¿™ä¸€å°èŠ‚ä¸­ï¼Œæåˆ°è¿‡PreparedçŠ¶æ€çš„äº‹åŠ¡ï¼Œåœ¨æ•°æ®åº“å¯åŠ¨æ—¶æ˜¯æäº¤è¿˜æ˜¯å›æ»šï¼Œå–å†³äºBinlogä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„XIDäº‹ä»¶ã€‚</p><h4>å‡½æ•°trx_recover_for_mysql</h4><p>innobase/trx/trx0trx.ccä¸­æœ‰ä¸€ä¸ªå‡½æ•°trx_recover_for_mysqlï¼Œçœ‹èµ·æ¥å’Œå´©æºƒæ¢å¤æœ‰å…³ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªå‡½æ•°å¼€å§‹åˆ†æã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/37/2d/3758b4b80b540bb194a699ab430b8b2d.png?wh=1438x1246\" alt=\"å›¾ç‰‡\"></p><p>è¿™ä¸ªå‡½æ•°çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç»Ÿè®¡trx_sys-&gt;rw_trx_listä¸­çŠ¶æ€ä¸ºTRX_STATE_PREPAREDçš„äº‹åŠ¡ï¼Œå‡½æ•°çš„è¿”å›å€¼å°±æ˜¯PreparedçŠ¶æ€çš„äº‹åŠ¡æ•°ã€‚</p><p>è¿™é‡Œè¿˜è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•°get_info_about_prepared_transactionï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°å‡½æ•°çš„å®šä¹‰ä¸­ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œå‡½æ•°get_info_about_prepared_transactionçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¼ å…¥äº†ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘trx_listçš„ç¬¬Nä¸ªå…ƒç´ ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°åï¼Œå°±æŠŠç¬¬Nä¸ªPreparedçŠ¶æ€çš„äº‹åŠ¡åŠ åˆ°äº†trx_listä¸­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e5/00/e568f3a25665d79a15992db0464b9500.png?wh=1300x726\" alt=\"å›¾ç‰‡\"></p><h4>é“¾è¡¨trx_sys-&gt;rw_trx_listçš„æ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿ</h4><p>é‚£ä¹ˆæ•°æ®åº“å¯åŠ¨æ—¶ï¼Œrw_trx_listé‡Œçš„æ•°æ®æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿä½¿ç”¨æŸ¥æ‰¾åŠŸèƒ½ï¼ˆCMD + SHIFT + Fï¼‰è¿›è¡Œæœç´¢ï¼Œå‘ç°trx0trx.ccä¸­æœ‰ä¸€å¤„ä»£ç ä¼šå¾€è¿™ä¸ªåˆ—è¡¨ä¸­æ’å…¥æ•°æ®ï¼ˆUT_LIST_ADD_FIRSTï¼‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a3/27/a3287ceb3f5584786b0543b8e975b427.png?wh=1104x1284\" alt=\"å›¾ç‰‡\"></p><p>æŸ¥çœ‹ä»£ç ï¼Œè¿™é‡Œåªæ˜¯å°è£…äº†ä¸€ä¸ªå‡½æ•°trx_add_to_rw_trx_listã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f7/7e/f7a6df33afd59051f08810339e0e6f7e.png?wh=1216x382\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥è¦çœ‹å“ªäº›åœ°æ–¹è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨å…¨å±€æœç´¢ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨â€œæŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨â€ï¼ˆå¿«æ·é”®ALT + SHIFT + F12ï¼‰ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/44/9d/4493a08f7276c0e2ffa2fb19fa50389d.png?wh=1100x398\" alt=\"å›¾ç‰‡\"></p><p>è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„åœ°æ–¹ä¸å¤šï¼Œåˆ†åˆ«æŸ¥çœ‹åï¼Œtrx_sys_init_at_db_startåº”è¯¥æ˜¯æˆ‘ä»¬æƒ³æ‰¾çš„å‡½æ•°ã€‚</p><p><strong>å‡½æ•°trx_sys_init_at_db_start</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/fb/f6/fb8641c87924d985ed64409c8f12d6f6.png?wh=1244x1282\" alt=\"å›¾ç‰‡\"></p><p>è¿™ä¸ªå‡½æ•°ä¸­ä¸»è¦åšäº†å‡ ä»¶äº‹æƒ…ã€‚</p><ul>\n<li>æ‰«ææ¯ä¸€ä¸ªUndoè¡¨ç©ºé—´ä¸­çš„æ¯ä¸€ä¸ªå›æ»šæ®µï¼Œè°ƒç”¨trx_resurrectå‡½æ•°ï¼Œè¯»å–å›æ»šæ®µä¸­æ‰€æœ‰çš„Undoæ®µï¼ŒæŠŠæœªå®Œæˆçš„äº‹åŠ¡è¯†åˆ«å‡ºæ¥ã€‚trx_resurrectå‡½æ•°ä¸­æœ€ç»ˆä¼šè°ƒç”¨trx_sys_rw_trx_addï¼ŒæŠŠäº‹åŠ¡åŠ åˆ°trx_sys-&gt;sharsä¸­ã€‚</li>\n</ul><p><img src=\"https://static001.geekbang.org/resource/image/6f/a4/6f6faac61ea3a23563e7521ab9byy7a4.png?wh=1228x634\" alt=\"å›¾ç‰‡\"></p><ul>\n<li>äº‹åŠ¡åŠ åˆ°trxsï¼ŒæŒ‰äº‹åŠ¡IDæ’åºåï¼ŒåŠ åˆ°trx_sys-&gt;rw_trx_listä¸­ã€‚</li>\n</ul><p>å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥ç»§ç»­åˆ†æå›æ»šæ®µã€Undoæ®µä¸­çš„æ•°æ®æ€ä¹ˆè¯»å–ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1b/53/1bcf3712cd2d54b41294aff1f19a5753.png?wh=1184x920\" alt=\"å›¾ç‰‡\"></p><p>å‡½æ•°trx_resurrectä¸­ç”¨åˆ°äº†rseg-&gt;insert_undo_listï¼Œrseg-&gt;update_undo_listï¼Œåˆ†æè¿™å‡ ä¸ªåˆ—è¡¨çš„æ•°æ®æ€ä¹ˆæ·»åŠ ï¼Œæœ€ç»ˆå¯èƒ½ä¼šå‘ç°ä¸‹é¢è¿™ä¸ªè°ƒç”¨é“¾è·¯ã€‚è¿™é‡Œæˆ‘å°±ä¸å…·ä½“å±•å¼€äº†ã€‚</p><pre><code class=\"language-plain\">trx_rsegs_init -&gt; trx_rseg_mem_create -&gt; \n -&gt; trx_undo_lists_init -&gt; trx_undo_mem_init\n</code></pre><p>ä½ è¿˜å¯ä»¥åˆ†ætrx_sys_init_at_db_startæ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„ã€‚æœ€ç»ˆä½ å¯èƒ½ä¼šå‘ç°å¤§è‡´çš„è°ƒç”¨é“¾è·¯æ˜¯è¿™æ ·çš„ã€‚</p><pre><code class=\"language-plain\">mysqld_main -&gt; process_bootstrap -&gt; dd::init -&gt; Dictionary_impl::init \n -&gt; bootstrap::initialize -&gt; DDSE_dict_init -&gt; innobase_ddse_dict_init\n -&gt; innobase_init_files -&gt; srv_start -&gt; trx_sys_init_at_db_start\n</code></pre><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨è°ƒè¯•å™¨ä¸­è®¾ç½®æ–­ç‚¹ï¼Œä»£ç è¿è¡Œåˆ°trx_sys_init_at_db_startæ—¶ï¼ŒæŸ¥çœ‹è°ƒç”¨æ ˆï¼Œè¿™æ ·æ›´æ–¹ä¾¿ï¼Œä¹Ÿæ›´å‡†ç¡®ã€‚ä¸è¿‡ç›´æ¥é˜…è¯»æºç è¿›è¡Œåˆ†æä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç»ƒä¹ ã€‚</p><h4>äº‹åŠ¡æ˜¯æ€ä¹ˆæ¢å¤çš„</h4><p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯åˆ†æäº†æ€ä¹ˆä»Undoè¡¨ç©ºé—´ä¸­æŠŠæœªå®Œç»“çš„äº‹åŠ¡æ‰«æå‡ºæ¥ã€‚ä½†æ˜¯è¿™äº›äº‹åŠ¡å…·ä½“æ˜¯æ€ä¹ˆæ¢å¤çš„å‘¢ï¼Ÿ</p><p>å›åˆ°trx_recover_for_mysqlè¿™ä¸ªå‡½æ•°ï¼Œè°è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿå¾ˆå¿«å°±æ‰¾åˆ°äº†innobase_xa_recoverã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c3/c2/c3ece1379b6d0df0fa8f86b3dff6e1c2.png?wh=1248x678\" alt=\"å›¾ç‰‡\"></p><p>è°è°ƒç”¨äº†innobase_xa_recoverå‘¢ï¼Ÿä½ ä¼šå‘ç°ä»£ç ä¸­å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚ä½†æ˜¯innodb_initä¸­ï¼Œè¿™ä¸ªå‡½æ•°èµ‹å€¼ç»™äº†innobase_hton-&gt;recoverè¿™ä¸ªå‡½æ•°æŒ‡é’ˆã€‚æ‰§è¡Œinnobase_hton-&gt;recoveræ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨æ‰§è¡Œinnobase_xa_recoverã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e1/56/e1c715bde8252792d1390a08bcbe6e56.png?wh=1276x378\" alt=\"å›¾ç‰‡\"></p><p>ä½ å¯ä»¥è¯•ç€æŸ¥ä¸€ä¸‹hton-&gt;recoveråœ¨å“ªé‡Œè°ƒç”¨ã€‚ç›´æ¥æœç´¢innobase_hton-&gt;recoveræˆ–hton-&gt;recoveræ‰¾ä¸åˆ°è°ƒç”¨çš„åœ°æ–¹ï¼Œå› ä¸ºåœ¨è°ƒç”¨çš„åœ°æ–¹ï¼Œå˜é‡åä¸æ˜¯innobase_htonæˆ–htonã€‚æ”¹æˆæœç´¢â€œ-&gt;recover(â€ï¼Œå¯ä»¥æ‰¾åˆ°è°ƒç”¨çš„åœ°æ–¹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/89/ce/89f66432686e33f3ed487b40d997d5ce.png?wh=1096x816\" alt=\"å›¾ç‰‡\"></p><p><strong>recover_one_ht</strong></p><p>recover_one_htä¸­è°ƒç”¨äº†ht-&gt;recoverã€‚æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œè°ƒç”¨recoveræ—¶ï¼Œä¼šæŠŠPreparedçŠ¶æ€çš„äº‹åŠ¡åŠ åˆ°trxé“¾è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„info-&gt;listä¸­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/11/b6/1181ac9378f0fe25cf1a26c32aa2b8b6.png?wh=1294x1390\" alt=\"å›¾ç‰‡\"></p><p>208è¡Œçš„å¾ªç¯ä¸­ï¼Œä¾æ¬¡å¤„ç†æ¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè°ƒç”¨å‡½æ•°recover_one_external_trxæˆ–recover_one_internal_trxæ¢å¤äº‹åŠ¡ã€‚è¿™ä¸ªä¸“æ ä¸­ï¼Œæ²¡æœ‰æ¶‰åŠåˆ°XAäº‹åŠ¡ï¼Œè¿™é‡Œåªåˆ†ærecover_one_internal_trxã€‚</p><p><strong>recover_one_internal_trx</strong></p><p>å‡½æ•°recover_one_internal_trxä¸­ï¼Œä¼šåˆ¤æ–­info.commit_listä¸­æ˜¯å¦æœ‰å½“å‰å¤„ç†çš„äº‹åŠ¡çš„XIDï¼Œå¦‚æœæœ‰ï¼Œå°±æ‰§è¡Œht.commit_by_xidæäº¤äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æ‰§è¡Œht.rollback_by_xidå›æ»šäº‹åŠ¡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4a/19/4a4f8046233534b781bfa72ceea02519.png?wh=1480x1310\" alt=\"å›¾ç‰‡\"></p><p><strong>commit_list</strong></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦åˆ†æcommit_listã€‚commit_listä½œä¸ºå‚æ•°ä¼ ç»™ha_recoverå‡½æ•°ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9f/db/9fd2c3745097cdf69698d7da27c524db.png?wh=1236x702\" alt=\"å›¾ç‰‡\"></p><p><strong>Binlog_recovery::recover</strong></p><p>ha_recoverç”±å‡½æ•°Binlog_recovery::recoverè°ƒç”¨ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯this-&gt;m_internal_xidsã€‚è¿™é‡Œçš„thisï¼Œå°±æ˜¯Binlog_recoveryå¯¹è±¡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a5/50/a50bf808bda0b7bec7dbc4dcc41f7d50.png?wh=1306x448\" alt=\"å›¾ç‰‡\"></p><p><strong>m_interal_xids</strong></p><p>å†æœç´¢m_internal_xidsï¼Œå¯ä»¥æ‰¾åˆ°Binlog_recovery::process_xid_eventå‡½æ•°ä¸­ä¼šæŠŠXIDåŠ è¿›æ¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/38/87/380d8b2648e4bb7058802fe61fd60f87.png?wh=1250x552\" alt=\"å›¾ç‰‡\"></p><p><strong>Binlog_recovery::recover</strong></p><p>Binlog_recovery::recoverå‡½æ•°ä¸­ä¼šè°ƒç”¨process_xid_eventã€‚64è¡Œçš„å¾ªç¯ä¸­ï¼Œè¯»å–Binlogæ–‡ä»¶ä¸­çš„æ¯ä¸€äº‹ä»¶ï¼Œå¦‚æœè¯»å–åˆ°ä¸€ä¸ªXIDäº‹ä»¶ï¼Œå°±æŠŠXIDåŠ åˆ°m_interal_xidsä¸­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a2/3f/a2ac3d05570e55614c6a89ed8a3e1a3f.png?wh=1308x1246\" alt=\"å›¾ç‰‡\"></p><p><strong>open_binlog</strong></p><p>Binlog_recovery::recoveråœ¨å‡½æ•°open_binlogä¸­è°ƒç”¨ã€‚open_binlogåˆ¤æ–­å½“å‰çš„Binlogæ˜¯ä¸æ˜¯æ•°æ®åº“å´©æºƒæ—¶åœ¨ä½¿ç”¨çš„ï¼Œè¿™å®é™…ä¸Šæ˜¯æ ¹æ®Binlogå¤´éƒ¨çš„FORMAT_DESCRIPTION_EVENTäº‹ä»¶ä¸­ï¼Œæ˜¯å¦æœ‰LOG_EVENT_BINLOG_IN_USE_Fæ ‡è®°æ¥åˆ¤æ–­çš„ã€‚å¦‚æœæœ‰è¿™ä¸ªæ ‡è®°ï¼Œå°±æ‰§è¡ŒBinlog_recovery::recoverï¼Œè¯»å–Binlogä¸­çš„æ‰€æœ‰XIDï¼Œè°ƒç”¨ha_recoverå¤„ç†PreparedçŠ¶æ€çš„äº‹åŠ¡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/a5/f1/a59c65225cb7e682f14d48d2d8786df1.png?wh=1324x962\" alt=\"å›¾ç‰‡\"></p><p>ç»§ç»­åˆ†æï¼Œèƒ½æ‰¾åˆ°ä¸‹é¢è¿™ä¸ªè°ƒç”¨é“¾è·¯ã€‚</p><pre><code class=\"language-plain\">mysqld_main -&gt; init_server_components -&gt; open_binlog \n  -&gt; Binlog_recovery::recover -&gt; ha_recover\n</code></pre><p>ä¸Šé¢åˆ†æäº†PreparedçŠ¶æ€çš„äº‹åŠ¡ï¼Œåœ¨æ¢å¤æ—¶çš„å¤„ç†é€»è¾‘ã€‚</p><p>ç»§ç»­æœç´¢trx_sys-&gt;rw_trx_listï¼Œè¿˜èƒ½æ‰¾åˆ°æ´»åŠ¨çš„äº‹åŠ¡çš„å¤„ç†è¿‡ç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/62/a7/62b5096ed7b7abe15e45aa9be3ae21a7.png?wh=1920x1006\" alt=\"å›¾ç‰‡\"></p><p>ä»ä»£ç ä¸­ï¼Œè¿˜èƒ½æ‰¾åˆ°ä¸‹é¢è¿™ä¸ªè°ƒç”¨é“¾è·¯ã€‚</p><pre><code class=\"language-plain\">trx_recovery_rollback_thread -&gt; trx_recovery_rollback \n  -&gt; trx_rollback_or_clean_recovered -&gt; trx_rollback_or_clean_resurrected\n</code></pre><p>trx_recovery_rollback_threadæ˜¯å›æ»šçº¿ç¨‹çš„ä¸»å‡½æ•°ï¼Œè¿™ä¸ªçº¿ç¨‹åœ¨srv_start_threads_after_ddl_recoveryä¸­åˆ›å»ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8d/82/8d701f49fc516e79f3e50047b8d79482.png?wh=1312x710\" alt=\"å›¾ç‰‡\"></p><p>è°ƒç”¨é“¾è·¯å¤§æ¦‚è¿™è¿™æ ·çš„ã€‚</p><pre><code class=\"language-plain\">mysqld_main -&gt; init_server_components -&gt; ha_post_recover \n  -&gt; post_recover_handlerton -&gt; post_recover \n  -&gt; innobase_post_recover -&gt; srv_start_threads_after_ddl_recovery\n</code></pre><h2>ä½¿ç”¨GDBè°ƒè¯•MySQLæºç </h2><p>ç°åœ¨æˆ‘ä»¬å¯¹MySQLçš„æºç ç»“æ„å·²ç»æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œå¹¶ä¸”å¯ä»¥å€ŸåŠ©ä¸€äº›å·¥å…·æ¥åˆ†ææºç ã€‚ä½†æ˜¯ï¼ŒMySQLæ˜¯ä¸æ˜¯ä¸€å®šæŒ‰æˆ‘ä»¬ç†è§£çš„æ–¹å¼åœ¨è¿è¡Œå‘¢ï¼Ÿæ¯•ç«ŸMySQLæœ‰ä¸Šç™¾ä¸‡è¡Œä»£ç ï¼Œçœ‹ä»£ç æ—¶ï¼Œæœ‰æ—¶å€™å¾ˆå®¹æ˜“å¿½ç•¥æ‰ä¸€äº›ç»†èŠ‚ã€‚è€Œä¸”æœ‰äº›æƒ…å†µä¸‹ï¼Œä»£ç æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸ä¸€å®šèƒ½å®Œå…¨ç†è§£ä»£ç çš„å«ä¹‰ã€‚</p><ul>\n<li>\n<p>ä¼ ç»™å‡½æ•°çš„å‚æ•°å–ä»€ä¹ˆå€¼æ˜¯æ€ä¹ˆç¡®å®šçš„ï¼Ÿæ¯”å¦‚å‡½æ•°row_search_mvccçš„å‚æ•°ä¸­ï¼Œå‚æ•°modeã€prebuiltã€match_modeæ˜¯æ€ä¹ˆç¡®å®šçš„ï¼Œå’Œæ‰§è¡Œçš„SQLæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</p>\n</li>\n<li>\n<p>å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šèµ°åˆ°å“ªä¸ªåˆ†æ”¯ï¼Ÿ</p>\n</li>\n<li>\n<p>äº‹åŠ¡æäº¤è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œåˆ°å“ªä¸€è¡Œä»£ç åï¼Œä¿®æ”¹çš„æ•°æ®å¯¹å…¶ä»–ä¼šè¯å¯è§ï¼Ÿ</p>\n</li>\n</ul><p>ä½¿ç”¨è°ƒè¯•å™¨ï¼Œå°±èƒ½è§‚å¯Ÿç¨‹åºåœ¨è¿è¡Œæ—¶çš„çŠ¶æ€ï¼ŒæŸ¥çœ‹å‚æ•°å’Œå˜é‡å…·ä½“çš„å€¼ï¼Œåˆ†æå‡½æ•°çš„è°ƒç”¨æ ˆã€‚è¿˜èƒ½ä½¿ç”¨è°ƒè¯•å™¨æ¥æ„å»ºä¸€äº›è¾¹ç•Œæ¡ä»¶ã€‚æ¯”å¦‚è¦è°ƒè¯•Preparedäº‹åŠ¡åœ¨æ¢å¤æ—¶çš„å¤„ç†é€»è¾‘ï¼Œå°±å¾—å…ˆç”Ÿæˆä¸€äº›PreparedçŠ¶æ€çš„äº‹åŠ¡ï¼Œç„¶åé‡å¯æ•°æ®åº“ã€‚ä½¿ç”¨è°ƒè¯•å™¨ï¼Œå°±èƒ½è®©äº‹åŠ¡åœç•™åœ¨PreparedçŠ¶æ€ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šé€šè¿‡ä¸€äº›è°ƒè¯•åœºæ™¯ï¼Œæ¥åˆæ­¥ä»‹ç»GDBçš„ä¸€äº›ç”¨æ³•ã€‚</p><p>å…ˆå‡†å¤‡ä¸€ä¸ªè°ƒè¯•ç¯å¢ƒï¼ŒBuildä¸€ä¸ªDebugç‰ˆæœ¬çš„MySQLï¼Œåˆ›å»ºä¸€ä¸ªæ•°æ®åº“ã€‚å…·ä½“çš„æ­¥éª¤åœ¨<a href=\"https://time.geekbang.org/column/article/801720\">ç¬¬1è®²</a>ä»‹ç»è¿‡ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚</p><p>å¦‚æœé‡åˆ°ä¸‹é¢è¿™æ ·çš„æŠ¥é”™ï¼Œå¾ˆå¯èƒ½æ˜¯gdbçš„ç‰ˆæœ¬å¤ªä½ï¼Œå¯ä»¥å®‰è£…ä¸€ä¸ªé«˜ç‰ˆæœ¬çš„è¯•è¯•ã€‚</p><pre><code class=\"language-plain\">Reading symbols from /usr/local/mysql/bin/mysqld...\nDwarf Error: wrong version in compilation unit header (is 5, should be 2, 3, or 4) [in module /usr/local/mysql/bin/mysqld]\n(no debugging symbols found)...\ndone.\n</code></pre><p>æˆ‘çš„æµ‹è¯•ç¯å¢ƒæ˜¯CentOS 7.9çš„ç³»ç»Ÿï¼Œç”¨äº†devtoolset-11ã€‚</p><pre><code class=\"language-plain\">yum install devtoolset-11-gdb\nsource /opt/rh/devtoolset-11/enable\n</code></pre><h3>SQLå¦‚ä½•æ‰§è¡Œï¼Ÿ</h3><p><a href=\"https://time.geekbang.org/column/article/804972\">ç¬¬ 8 è®²</a>ä¸­ä»‹ç»è¿‡â€œSELECTè¯­å¥æ˜¯æ€ä¹ˆæ‰§è¡Œçš„â€ï¼Œåˆ°gdbä¸­éªŒè¯ä¸€ä¸‹ã€‚å…ˆè¿è¡Œgdbï¼Œattachåˆ°mysqldè¿›ç¨‹ã€‚å…ˆç»™do_commandå‡½æ•°è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼ˆbreak do_commandï¼‰ï¼Œæ‰§è¡Œcontinueå‘½ä»¤ã€‚</p><pre><code class=\"language-plain\"># gdb /opt/mysql8.0/bin/mysqld 12312\nGNU gdb (GDB) Red Hat Enterprise Linux 10.2-6.el7\n\n\n(gdb) break do_command\nBreakpoint 1 at 0x330a841: file /root/buildenv/mysql-8.0.40/sql/sql_parse.cc, line 1311.\n(gdb) c\nContinuing.\n</code></pre><p>è¿æ¥åˆ°MySQLï¼Œæ‰§è¡Œä¸€ä¸ªç®€å•çš„SQLè¯­å¥ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select * from ta;\n</code></pre><p>æ‰§è¡Œnextå‘½ä»¤ï¼Œå•æ­¥è·Ÿè¸ªã€‚æ‰§è¡Œå®Œdispatch_commandåï¼Œä½ ä¼šå‘ç°SQLæ‰§è¡Œå®Œæˆäº†ã€‚</p><pre><code class=\"language-plain\">Thread 44 \"connection\" hit Breakpoint 1, do_command (thd=0x7fa5d8017480)\n    at /root/buildenv/mysql-8.0.40/sql/sql_parse.cc:1311\n1311\t  NET *net = nullptr;\n(gdb) n\n1312\t  enum enum_server_command command = COM_SLEEP;\n(gdb)\n1314\t  DBUG_TRACE;\n(gdb)\n1315\t  assert(thd-&gt;is_classic_protocol());\n(gdb)\n1321\t  thd-&gt;lex-&gt;set_current_query_block(nullptr);\n(gdb)\n1329\t  thd-&gt;clear_error();  // Clear error message\n......\n1438\t  DEBUG_SYNC(thd, \"before_command_dispatch\");\n(gdb)\n1440\t  return_value = dispatch_command(thd, &amp;com_data, command);\n(gdb)\n</code></pre><p>æ‰€ä»¥éœ€è¦è·Ÿè¸ªåˆ°dispatch_commandå‡½æ•°é‡Œé¢å»ã€‚å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œæˆ–è€…ä½¿ç”¨stepå‘½ä»¤ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åœ¨sql_parse.ccçš„1440è¡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œè¿è¡Œåˆ°è¿™é‡Œåï¼Œæ‰§è¡Œstepå‘½ä»¤è¿›åˆ°å‡½æ•°dispatch_commandé‡Œã€‚æ‰§è¡Œbacktraceå‘½ä»¤æŸ¥çœ‹è°ƒç”¨å †ã€‚</p><pre><code class=\"language-plain\">(gdb) break /root/buildenv/mysql-8.0.40/sql/sql_parse.cc:1440\n</code></pre><p><img src=\"https://static001.geekbang.org/resource/image/23/2b/235a75620a9b87c287yy949a9c11512b.png?wh=1306x638\" alt=\"å›¾ç‰‡\"></p><p>ç±»ä¼¼è¿™æ ·ï¼Œä½ å¯ä»¥ç»§ç»­å•æ­¥è·Ÿè¸ªæ‰§è¡Œã€‚å› ä¸ºæˆ‘ä»¬çŸ¥é“æŸ¥è¯¢æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨row_search_mvccè·å–è®°å½•ï¼Œå› æ­¤å°±ç»™å‡½æ•°row_search_mvccè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ã€‚</p><pre><code class=\"language-plain\">(gdb) break row_search_mvcc\nBreakpoint 3 at 0x4c85040: file /root/buildenv/mysql-8.0.40/storage/innobase/row/row0sel.cc, line 4423.\n\n\n(gdb) continue\nContinuing.\n\nThread 44 \"connection\" hit Breakpoint 3, row_search_mvcc (buf=0x7fa5d8008420 \"\\375\\351\\a\",\n    mode=PAGE_CUR_G, prebuilt=0x7fa5d8b3c9a8, match_mode=0, direction=0)\n    at /root/buildenv/mysql-8.0.40/storage/innobase/row/row0sel.cc:4423\n4423\t  DBUG_TRACE;\n</code></pre><p>æŸ¥çœ‹è°ƒç”¨å †ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šå‡½æ•°è°ƒç”¨ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/47/ae/4773982b0775803a5d866247acd3e0ae.png?wh=1494x1172\" alt=\"å›¾ç‰‡\"></p><p>ç»è¿‡ä¸€äº›åˆ†æï¼Œå‘ç°sql_union.ccçš„1771è¡Œå¯èƒ½æœ‰æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä»£ç ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2e/c9/2e7d23a7f353b85210019c0b2b96d9c9.png?wh=1184x1234\" alt=\"å›¾ç‰‡\"></p><p>åœ¨å‡½æ•°ExecuteIteratorQueryä¸­ï¼Œå¯ä»¥çœ‹åˆ°SQLå¼•æ“çš„ä¸€ä¸ªåŸºæœ¬æ‰§è¡Œè¿‡ç¨‹ã€‚</p><ul>\n<li>\n<p>1771è¡Œï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“æ¥å£ï¼Œè·å–æ•°æ®ã€‚</p>\n</li>\n<li>\n<p>1774è¡Œï¼Œåˆ¤æ–­å­˜å‚¨å¼•æ“çš„è¿”å›ç ï¼Œå¦‚æœæ•°æ®å–å®Œäº†ï¼Œå°±é€€å‡ºforå¾ªç¯ã€‚å¦‚æœæœ‰å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ã€‚</p>\n</li>\n<li>\n<p>1786è¡Œï¼Œè°ƒç”¨send_dataï¼Œå°†æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>\n</li>\n<li>\n<p>1798è¡Œï¼Œæ•°æ®å–å®Œäº†ï¼Œå‘é€ä¸€ä¸ªç»“æŸæ ‡è®°ç»™å®¢æˆ·ç«¯ã€‚</p>\n</li>\n</ul><p>ä½†æ˜¯ï¼Œå†ä»”ç»†è§‚å¯Ÿä¸€ä¸‹ï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œå­˜å‚¨å¼•æ“ä¸­è·å–çš„è®°å½•ï¼Œæ˜¯æ€ä¹ˆä¼ é€’ç»™send_dataå‡½æ•°çš„å‘¢ï¼Ÿä»å‡½æ•°çš„è¿”å›å€¼ã€å‚æ•°ä¸­éƒ½çœ‹ä¸å‡ºæ¥ã€‚</p><p>å›åˆ°å‰é¢è¿™ä¸ªè°ƒç”¨æ ˆï¼Œå¯ä»¥å‘ç°ä¸€äº›çº¿ç´¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5c/a7/5cd8d59d0e84300355ef80189b137ca7.png?wh=1492x494\" alt=\"å›¾ç‰‡\"></p><p>handler::ha_index_firstæœ‰ä¸€ä¸ªbufå‚æ•°ï¼Œåˆ†æä»£ç ï¼ˆrow_search_mvccï¼‰åå¯ä»¥çŸ¥é“ï¼ŒInnoDBæ˜¯å°†æŸ¥åˆ°çš„è®°å½•å†™åˆ°äº†è¿™ä¸ªbufä¸­ã€‚</p><p>è¿™ä¸ªå‚æ•°æ˜¯IndexScanIterator<false>::Readä¸­ä¼ å…¥çš„ã€‚</false></p><p><img src=\"https://static001.geekbang.org/resource/image/eb/1e/ebb83f5c085e32621d9b75e6dc344b1e.png?wh=950x594\" alt=\"å›¾ç‰‡\"></p><p>è¿™ä¸ªm_recordåˆæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿè¿™æ˜¯IndexScanIteratorç±»çš„ä¸€ä¸ªæˆå‘˜ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–æˆtable-&gt;record[0]ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/de/05/ded72d8b98ebcced2b121ae854f22505.png?wh=1372x706\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬å¯ä»¥åœ¨IndexScanIteratorçš„æ„é€ å‡½æ•°ä¸ŠåŠ ä¸€ä¸ªæ–­ç‚¹ã€‚</p><pre><code class=\"language-plain\">(gdb) break IndexScanIterator&lt;true&gt;::IndexScanIterator\nBreakpoint 4 at 0x389096e: file /root/buildenv/mysql-8.0.40/sql/iterators/basic_row_iterators.cc, line 67.\n\n(gdb) break IndexScanIterator&lt;false&gt;::IndexScanIterator\nBreakpoint 5 at 0x3890bd8: file /root/buildenv/mysql-8.0.40/sql/iterators/basic_row_iterators.cc, line 67.\n\n(gdb) c\nContinuing.\n\nThread 44 \"connection\" hit Breakpoint 5, IndexScanIterator&lt;false&gt;::IndexScanIterator (this=0x7fa5d8af8d28, thd=0x7fa5d8017480, table=0x7fa5d80063a0, idx=0, use_order=false, expected_rows=4,\n    examined_rows=0x7fa5d8af7ea0) at /root/buildenv/mysql-8.0.40/sql/iterators/basic_row_iterators.cc:67\n67\t      m_examined_rows(examined_rows) {}\n</code></pre><p>å°±å¯ä»¥çœ‹åˆ°è¿™æ ·çš„è°ƒç”¨æ ˆï¼Œçœ‹èµ·æ¥æ˜¯åœ¨ä¼˜åŒ–SQLçš„æ—¶å€™ä¼ è¿›æ¥çš„tableå˜é‡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f9/b8/f9da9c2237c9c3ba4e652f80a8192fb8.png?wh=1504x1170\" alt=\"å›¾ç‰‡\"></p><p>è¿™é‡Œçš„tableæ˜¯ä¸€ä¸ªé‡è¦çš„ç»“æ„ï¼Œæˆ‘ä»¬è¯´çš„Open table cacheé‡Œç¼“å­˜çš„ï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯è¿™ä¸ªtableç»“æ„å‘¢ï¼Ÿ</p><p>å¯ä»¥ç”¨printå‘½ä»¤æŸ¥çœ‹å˜é‡tableçš„å€¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/04/d8/049979a61c499491c564a3f3fed2b1d8.png?wh=1440x392\" alt=\"å›¾ç‰‡\"></p><p>å¥½äº†ï¼Œè¿™ä¸ªè°ƒè¯•æ¡ˆä¾‹å°±å…ˆåˆ°è¿™å„¿ã€‚å€ŸåŠ©GDBï¼Œæˆ‘ä»¬åˆ†æäº†ä¸€ä¸ªç®€å•çš„SELECTè¯­å¥æ‰§è¡Œçš„åŸºæœ¬æ­¥éª¤ï¼Œæˆ‘ä»¬è¿˜çŸ¥é“äº†MySQL Serverå±‚å’ŒInnoDBå­˜å‚¨å¼•æ“ä¹‹é—´ï¼Œæ˜¯é€šè¿‡TABLEç»“æ„ä½“çš„record bufferæ¥ä¼ é€’æ•°æ®çš„ã€‚</p><h3>æ•°æ®åº“å¯åŠ¨æµç¨‹åˆ†æ</h3><p>ä¸Šä¸€ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨gdb attachåˆ°ä¸€ä¸ªè¿è¡Œä¸­çš„mysqldè¿›ç¨‹ä¸Šè¿›è¡Œè°ƒè¯•ã€‚å¦‚æœè¦è°ƒè¯•MySQLçš„å¯åŠ¨è¿‡ç¨‹ï¼Œå°±è¦åœ¨gdbä¸­å¯åŠ¨MySQLã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å½“å‰mysqldè¿›ç¨‹çš„è¿è¡Œå‚æ•°ã€‚</p><pre><code class=\"language-plain\"># ps -elf | grep mysqld \n\n... /opt/mysql8.0/bin/mysqld --defaults-file=/data/mysql8.0/my.cnf --basedir=/opt/mysql8.0 --datadir=/data/mysql8.0/data --plugin-dir=/opt/mysql8.0/lib/plugin --user=mysql --log-error=/data/mysql8.0/log/alert.log --open-files-limit=1024 --pid-file=/data/mysql8.0/run/mysqld.pid --socket=/data/mysql8.0/run/mysql.sock --port=3380\n</code></pre><p>å¯åŠ¨gdbï¼ŒåŠ è½½mysqldã€‚</p><pre><code class=\"language-plain\"># gdb /opt/mysql8.0/bin/mysqld\nGNU gdb (GDB) Red Hat Enterprise Linux 10.2-6.el7\n</code></pre><p>è®¾ç½®æ–­ç‚¹ï¼Œæ¯”å¦‚åœ¨å´©æºƒæ¢å¤çš„ä¸€äº›å‡½æ•°ä¸Šè®¾ç½®æ–­ç‚¹ã€‚</p><pre><code class=\"language-plain\">(gdb) break trx_sys_init_at_db_start\nBreakpoint 1 at 0x4d3627f: file /root/buildenv/mysql-8.0.40/storage/innobase/trx/trx0sys.cc, line 440.\n\n(gdb) break open_binlog\nBreakpoint 2 at 0x44e2953: open_binlog. (2 locations)\n\n(gdb) break recv_recovery_from_checkpoint_start\nBreakpoint 3 at 0x4b5afee: file /root/buildenv/mysql-8.0.40/storage/innobase/log/log0recv.cc, line 3770.\n\n(gdb) break do_command\n</code></pre><p>ç„¶åç”¨runå‘½ä»¤ï¼Œå¯åŠ¨MySQLã€‚</p><pre><code class=\"language-plain\">(gdb) run --defaults-file=/data/mysql8.0/my.cnf --basedir=/opt/mysql8.0 --datadir=/data/mysql8.0/data --plugin-dir=/opt/mysql8.0/lib/plugin --user=mysql --log-error=/data/mysql8.0/log/alert.log --open-files-limit=1024 --pid-file=/data/mysql8.0/run/mysqld.pid --socket=/data/mysql8.0/run/mysql.sock --port=3380\n</code></pre><p>ä¼šå…ˆè¿è¡ŒRedoæ¢å¤ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ed/39/edd683ddaed1dbfc96138e1c61d3cc39.png?wh=1462x826\" alt=\"å›¾ç‰‡\"></p><p>è¿è¡Œfininishå‘½ä»¤ï¼Œæ‰§è¡Œå®Œrecv_recovery_from_checkpoint_startåï¼Œå¯ä»¥æ¥ç€è°ƒè¯•ã€‚</p><pre><code class=\"language-plain\">(gdb) fin\nRun till exit from #0  recv_recovery_from_checkpoint_start (log=..., flush_lsn=43940320)\n    at /root/buildenv/mysql-8.0.40/storage/innobase/log/log0recv.cc:3770\n0x0000000004cc4cea in srv_start (create_new_db=false)\n    at /root/buildenv/mysql-8.0.40/storage/innobase/srv/srv0start.cc:1986\n1986\t    err = recv_recovery_from_checkpoint_start(*log_sys, flushed_lsn);\nValue returned is $1 = DB_SUCCESS\n</code></pre><p>ä½ ä¼šå‘ç°æ¥ä¸‹æ¥å…ˆè¿è¡Œåˆ°trx_sys_init_at_db_startå¤„çš„æ–­ç‚¹ï¼Œç„¶åå†è¿è¡Œåˆ°open_binlogã€‚åœ¨ä¸€äº›å…³é”®çš„ä»£ç ç‚¹ä¸Šè®¾ç½®æ–­ç‚¹ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°ä¸€äº›ä»£ç çš„è¿è¡Œé¡ºåºã€‚æ¯”å¦‚æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œå…ˆæ‰§è¡ŒRedoï¼Œå†æ‰§è¡ŒUndoã€‚</p><h3>GDBå‘½ä»¤å‚è€ƒ</h3><p>gdbçš„åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œæˆ‘æŠŠä¸€äº›åŸºæœ¬çš„å‘½ä»¤æ•´ç†åˆ°äº†ä¸‹é¢è¿™ä¸ªè¡¨æ ¼ä¸­ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤çš„ç®€ç§°ï¼Œæ¯”å¦‚æ‰§è¡Œcå°±æ˜¯æ‰§è¡Œcontinueå‘½ä»¤ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e0/26/e0e511f84ab77a348fe6eaebb6b74826.jpg?wh=1928x1412\" alt=\"\"></p><h2>æ€»ç»“</h2><p>MySQLä½¿ç”¨C/C++ç¼–å†™ï¼Œå› æ­¤ç†è®ºä¸Šï¼Œä½ åªè¦ç†Ÿæ‚‰C/C++ï¼Œå°±èƒ½çœ‹æ‡‚MySQLçš„å®ç°ã€‚å½“ç„¶ï¼Œç”±äºMySQLçš„ä»£ç é‡æ¯”è¾ƒå¤šï¼Œåˆ†æè¿™äº›ä»£ç éœ€è¦èŠ±æ¯”è¾ƒå¤šçš„æ—¶é—´ã€‚è¿™ä¸€è®²ä¸­æåˆ°çš„ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥ä¾›ä½ å‚è€ƒï¼Œæ›´é‡è¦çš„å…¶å®æ˜¯èŠ±å¤§é‡çš„æ—¶é—´å»å°è¯•ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>MySQLæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„æœåŠ¡å™¨ï¼Œä»£ç è¿è¡Œåˆ°ä¸€ä¸ªæ–­ç‚¹æ—¶ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½ä¼šæš‚åœè¿è¡Œã€‚æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½åªæƒ³è°ƒè¯•å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹è¦ä¿æŒè¿è¡ŒçŠ¶æ€ã€‚ä½¿ç”¨GDBï¼Œæ€ä¹ˆå®ç°è¿™ä¸€ç‚¹å‘¢ï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ã€‚</p>","comments":[{"had_liked":false,"id":396404,"user_name":"å°çŒªçŒªçŒªè›‹","can_delete":false,"product_type":"c1","uid":2702408,"ip_address":"åŒ—äº¬","ucode":"5117C35B4FA1C9","user_header":"https://static001.geekbang.org/account/avatar/00/29/3c/48/38f84bbc.jpg","comment_is_top":false,"comment_ctime":1734317725,"is_pvip":false,"replies":[{"id":143899,"content":"ğŸ¤ğŸ¤","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1734336101,"ip_address":"æµ™æ±Ÿ","comment_id":396404,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è®²çš„éå¸¸è¯¦ç»†ï¼Œä¸€æ­¥ä¸€æ­¥è·Ÿä¸‹æ¥ å—ç›ŠåŒªæµ…ï¼ è°¢è°¢è€å¸ˆ","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655174,"discussion_content":"ğŸ¤ğŸ¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734336101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}