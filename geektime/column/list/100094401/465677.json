{"id":465677,"title":"22｜表单：如何设计一个表单组件？","content":"<p>你好，我是大圣。</p><p>上一讲我们详细讲解了如何使用Jest框架对组件库进行测试，TypeScript和Jest都为我们的代码质量和研发效率保驾护航。之前我们实现的Container和Button组件都是以渲染功能为主，可以根据不同的属性渲染不同的样式去实现布局和不同格式的按钮。</p><p>那么今天我再带你实现一个非常经典的表单组件，这个组件除了要渲染页面组件之外，还得支持很好的页面交互，下面我们先从Element3的表单组件开始讲解。</p><h2>表单组件</h2><p>在<a href=\"https://e3.shengxinjing.cn/#/component/form\">Element表单组件</a>的页面里，我们能看到表单种类的组件类型有很多，我们常见的输入框、单选框和评分组件等都算是表单组件系列的。</p><p>下面这段代码是Element3官方演示表单的Template，整体表单页面分三层：</p><ul>\n<li>el-form组件负责最外层的表单容器；</li>\n<li>el-form-item组件负责每一个输入项的label和校验管理；</li>\n<li>内部的el-input或者el-switch负责具体的输入组件。</li>\n</ul><pre><code class=\"language-xml\">&lt;el-form\n  :model=\"ruleForm\"\n  :rules=\"rules\"\n  ref=\"form\"\n  label-width=\"100px\"\n  class=\"demo-ruleForm\"\n&gt;\n  &lt;el-form-item label=\"活动名称\" prop=\"name\"&gt;\n    &lt;el-input v-model=\"ruleForm.name\"&gt;&lt;/el-input&gt;\n  &lt;/el-form-item&gt;\n  &lt;el-form-item label=\"活动区域\" prop=\"region\"&gt;\n    &lt;el-select v-model=\"ruleForm.region\" placeholder=\"请选择活动区域\"&gt;\n      &lt;el-option label=\"区域一\" value=\"shanghai\"&gt;&lt;/el-option&gt;\n      &lt;el-option label=\"区域二\" value=\"beijing\"&gt;&lt;/el-option&gt;\n    &lt;/el-select&gt;\n  &lt;/el-form-item&gt;\n  &lt;el-form-item label=\"即时配送\" prop=\"delivery\"&gt;\n    &lt;el-switch v-model=\"ruleForm.delivery\"&gt;&lt;/el-switch&gt;\n  &lt;/el-form-item&gt;\n  &lt;el-form-item label=\"活动性质\" prop=\"type\"&gt;\n    &lt;el-checkbox-group v-model=\"ruleForm.type\"&gt;\n      &lt;el-checkbox label=\"美食/餐厅线上活动\" name=\"type\"&gt;&lt;/el-checkbox&gt;\n      &lt;el-checkbox label=\"地推活动\" name=\"type\"&gt;&lt;/el-checkbox&gt;\n      &lt;el-checkbox label=\"线下主题活动\" name=\"type\"&gt;&lt;/el-checkbox&gt;\n      &lt;el-checkbox label=\"单纯品牌曝光\" name=\"type\"&gt;&lt;/el-checkbox&gt;\n    &lt;/el-checkbox-group&gt;\n  &lt;/el-form-item&gt;\n  &lt;el-form-item label=\"特殊资源\" prop=\"resource\"&gt;\n    &lt;el-radio-group v-model=\"ruleForm.resource\"&gt;\n      &lt;el-radio label=\"线上品牌商赞助\"&gt;&lt;/el-radio&gt;\n      &lt;el-radio label=\"线下场地免费\"&gt;&lt;/el-radio&gt;\n    &lt;/el-radio-group&gt;\n  &lt;/el-form-item&gt;\n  &lt;el-form-item label=\"活动形式\" prop=\"desc\"&gt;\n    &lt;el-input type=\"textarea\" v-model=\"ruleForm.desc\"&gt;&lt;/el-input&gt;\n  &lt;/el-form-item&gt;\n  &lt;el-form-item&gt;\n    &lt;el-button type=\"primary\" @click=\"submitForm('ruleForm')\"\n      &gt;立即创建&lt;/el-button\n    &gt;\n    &lt;el-button @click=\"resetForm('ruleForm')\"&gt;重置&lt;/el-button&gt;\n  &lt;/el-form-item&gt;\n&lt;/el-form&gt;\n</code></pre><!-- [[[read_end]]] --><p>现在我们把上面的代码简化为最简单的形式，只留下el-input作为输入项，就可以清晰地看到表单组件工作的模式：el-form组件使用:model提供数据绑定；使用rules提供输入校验规则，可以规范用户的输入内容；使用el-form-item作为输入项的容器，对输入进行校验，显示错误信息。</p><pre><code class=\"language-xml\">  &lt;el-form :model=\"ruleForm\" :rules=\"rules\" ref=\"form\"&gt;\n    &lt;el-form-item label=\"用户名\" prop=\"username\"&gt;\n      &lt;el-input v-model=\"ruleForm.username\"&gt;&lt;/el-input&gt;\n      &lt;!-- &lt;el-input :model-value=\"\" @update:model-value=\"\"&gt;&lt;/el-input&gt; --&gt;\n    &lt;/el-form-item&gt;\n    &lt;el-form-item label=\"密码\" prop=\"passwd\"&gt;\n      &lt;el-input type=\"textarea\" v-model=\"ruleForm.passwd\"&gt;&lt;/el-input&gt;\n    &lt;/el-form-item&gt;\n    &lt;el-form-item&gt;\n      &lt;el-button type=\"primary\" @click=\"submitForm()\"&gt;登录&lt;/el-button&gt;\n    &lt;/el-form-item&gt;\n  &lt;/el-form&gt;\n</code></pre><p>然后我们看下rules和model是如何工作的。</p><p>这里使用reactive返回用户输入的数据，username和passwd输入项对应，然后rules使用reactive包裹用户输入项校验的配置。</p><p>具体的校验规则，现在主流组件库使用的都是async-validator这个库，详细的校验规则你可以访问 <a href=\"https://github.com/yiminghe/async-validator\">async-validator的官网</a>查看。而表单Ref上我们额外新增了一个validate方法，这个方法会执行所有的校验逻辑来显示用户的报错信息，下图就是用户输入不符合rules配置后，页面的报错提示效果。</p><pre><code class=\"language-typescript\">const ruleForm = reactive&lt;UserForm&gt;({\n  username:\"\",\n  passwd:\"\"\n})\nconst rules = reactive({\n  rules: {\n    username: { required: true,min: 1, max: 20, message: '长度在 1 到 20 个字符', trigger: 'blur' },\n    passwd: [{ required: true, message: '密码', trigger: 'blur' }]\n  }\n})\nfunction submitForm() {\n  form.value.validate((valid) =&gt; {\n    if (valid) {\n      alert('submit!')\n    } else {\n      console.log('error submit!!')\n      return false\n    }\n  })\n}\n</code></pre><h2><img src=\"https://static001.geekbang.org/resource/image/41/52/41183d472a7b16f80ed846c58fe43852.png?wh=1688x1074\" alt=\"图片\"></h2><h2>表单组件实现</h2><p>那么接下来我们就要实现组件了。我们进入到src/components目录下新建Form.vue去实现el-form组件，该组件是整个表单组件的容器，负责管理每一个el-form-item组件的校验方法，并且自身还提供一个检查所有输入项的validate方法。</p><p>在下面的代码中，我们注册了传递的属性的格式，并且注册了validate方法使其对外暴露使用。</p><pre><code class=\"language-typescript\">\ninterface Props {\n  label?: string\n  prop?: string\n}\nconst props = withDefaults(defineProps&lt;Props&gt;(), { \n  label: \"\", \n  prop: \"\" \n})\n\nconst formData = inject(key)\n\nconst o: FormItem = {\n  validate,\n}\n\ndefineExpose(o)\n</code></pre><p>那么在 el-form 组件中如何管理el-form-item组件呢？我们先要新建FormItem.vue文件，这个组件加载完毕之后去通知el-form组件自己加载完毕了，这样在el-form中我们就可以很方便地使用数组来管理所有内部的form-item组件。</p><pre><code class=\"language-typescript\">import { emitter } from \"../../emitter\"\nconst items = ref&lt;FormItem[]&gt;([])\n\nemitter.on(\"addFormItem\", (item) =&gt; {\n  items.value.push(item)\n})\n</code></pre><p>然后el-form-item还要负责管理内部的input输入标签，并且从form组件中获得配置的rules，通过rules的逻辑，来判断用户的输入值是否合法。另外，el-form还要管理当前输入框的label，看看输入状态是否报错，以及报错的信息显示，这是一个承上启下的组件。</p><pre><code class=\"language-typescript\">onMounted(() =&gt; {\n  if (props.prop) {\n    emitter.on(\"validate\", () =&gt; {\n      validate()\n    })\n    emitter.emit(\"addFormItem\", o)\n  }\n})\nfunction validate() {\n  if (formData?.rules === undefined) {\n    return Promise.resolve({ result: true })\n  }\n  const rules = formData.rules[props.prop]\n  const value = formData.model[props.prop]\n  const schema = new Schema({ [props.prop]: rules })\n  return schema.validate({ [props.prop]: value }, (errors) =&gt; {\n    if (errors) {\n      error.value = errors[0].message || \"校验错误\"\n    } else {\n      error.value = \"\"\n    }\n  })\n}\n</code></pre><p>这里我们可以看到，form、form-item和input这三个组件之间是<strong>嵌套使用</strong>的关系：</p><ul>\n<li>form提供了所有的数据对象和配置规则；</li>\n<li>input负责具体的输入交互；</li>\n<li>form-item负责中间的数据和规则管理，以及显示具体的报错信息。<br>\n这就需要一个强有力的组件通信机制，在Vue中组件之间的通信机制有这么几种。</li>\n</ul><p>首先是父子组件通信，通过props和emits来通信。这个我们在全家桶实战篇和评级组件那一讲都有讲过，父元素通过props把需要的数据传递给子元素，子元素通过emits通知父元素内部的变化，并且还可以通过defineDepose的方式暴露给父元素方法，可以让父元素调用自己的方法。</p><p>那么form和input组件如何通信呢？这种祖先元素和后代元素，中间可能嵌套了很多层的关系，Vue则提供了provide和inject两个API来实现这个功能。</p><p>在组件中我们可以使用provide函数向所有子组件提供数据，子组件内部通过inject函数注入使用。注意这里provide提供的只是普通的数据，并没有做响应式的处理，如果子组件内部需要响应式的数据，那么需要在provide函数内部使用ref或者reative包裹才可以。</p><p>关于prvide和inject的类型系统，我们可以使用Vue提供的InjectiveKey来声明。我们在form目录下新建type.ts专门管理表单组件用到的相关类型，在下面的代码中，我们定义了表单form和表单管理form-item的上下文，并且通过InjectionKey管理提供的类型。</p><pre><code class=\"language-typescript\">import { InjectionKey } from \"vue\"\nimport { Rules, Values } from \"async-validator\"\n\nexport type FormData = {\n  model: Record&lt;string, unknown&gt;\n  rules?: Rules\n}\n\nexport type FormItem = {\n  validate: () =&gt; Promise&lt;Values&gt;\n}\n\nexport type FormType = {\n  validate: (cb: (isValid: boolean) =&gt; void) =&gt; void\n}\n\nexport const key: InjectionKey&lt;FormData&gt; = Symbol(\"form-data\")\n</code></pre><p>而下面的代码，我们则通过provide向所有子元素提供form组件的上下文。子组件内部通过inject获取，很多组件都是嵌套成对出现的，provide和inject这种通信机制后面我们还会不停地用到，做好准备。</p><pre><code class=\"language-typescript\">provide(key, {\n  model: props.model,\n  rules?: props.rules,\n})\n\n# 子组件\nconst formData = inject(key)\n</code></pre><p>然后就是具体的input实现逻辑，在下面的代码中，input 的核心逻辑就是对v-model的支持，这个内容我们在评级组件那一讲已经实现过了。</p><p>v-mode其实是:mode-value=\"x\"和@update:modelValute两个写法的简写，组件内部获取对应的属性和modelValue方法即可。这里需要关注的代码是我们输入完成之后的事件，输入的结果校验是由父组件el-form-item来实现的，我们只需要通过emit对外广播出去即可。</p><pre><code class=\"language-xml\">&lt;template&gt;\n  &lt;div\n    class=\"el-form-item\"\n  &gt;\n    &lt;label\n      v-if=\"label\"\n    &gt;{{ label }}&lt;/label&gt;\n    &lt;slot /&gt;\n    &lt;p\n      v-if=\"error\"\n      class=\"error\"\n    &gt;\n      {{ error }}\n    &lt;/p&gt;\n  &lt;/div&gt;\n&lt;/template&gt;\n&lt;script lang=\"ts\"&gt;\nexport default{\n  name:'ElFormItem'\n}\n&lt;/script&gt;\n\n&lt;script setup lang=\"ts\"&gt;\nimport Schema from \"async-validator\"\nimport { onMounted, ref, inject } from \"vue\"\nimport { FormItem, key } from \"./type\"\nimport { emitter } from \"../../emitter\"\n\ninterface Props {\n  label?: string\n  prop?: string\n}\nconst props = withDefaults(defineProps&lt;Props&gt;(), { label: \"\", prop: \"\" })\n// 错误\nconst error = ref(\"\")\n\nconst formData = inject(key)\n\nconst o: FormItem = {\n  validate,\n}\n\ndefineExpose(o)\n\nonMounted(() =&gt; {\n  if (props.prop) {\n    emitter.on(\"validate\", () =&gt; {\n      validate()\n    })\n    emitter.emit(\"addFormItem\", o)\n  }\n})\n\nfunction validate() {\n  if (formData?.rules === undefined) {\n    return Promise.resolve({ result: true })\n  }\n  const rules = formData.rules[props.prop]\n  const value = formData.model[props.prop]\n  const schema = new Schema({ [props.prop]: rules })\n  return schema.validate({ [props.prop]: value }, (errors) =&gt; {\n    if (errors) {\n      error.value = errors[0].message || \"校验错误\"\n    } else {\n      error.value = \"\"\n    }\n  })\n}\n&lt;/script&gt;\n\n&lt;style lang=\"scss\"&gt;\n@import '../styles/mixin';\n@include b(form-item) {\n  margin-bottom: 22px;\n  label{\n    line-height:1.2;\n    margin-bottom:5px;\n    display: inline-block;\n  }\n  &amp; .el-form-item {\n    margin-bottom: 0;\n  }\n}\n.error{\n  color:red;\n}\n&lt;/style&gt;\n</code></pre><p>最后我们点击按钮的时候，在最外层的form标签内部会对所有的输入项进行校验。由于我们管理着所有的form-item，只需要遍历所有的form-item，依次执行即可。</p><p>下面的代码就是表单注册的validate方法，我们遍历全部的表单输入项，调用表单输入项的validate方法，有任何一个输入项有报错信息，整体的校验就会是失败状态。</p><pre><code class=\"language-typescript\">\n\nfunction validate(cb: (isValid: boolean) =&gt; void) {\n  const tasks = items.value.map((item) =&gt; item.validate())\n  Promise.all(tasks)\n    .then(() =&gt; { cb(true) })\n    .catch(() =&gt; { cb(false) })\n}\n</code></pre><p>上面代码实际执行的是每个表单输入项内部的validate方法，这里我们使用的就是async-validate的校验函数。在validate函数内部，我们会获取表单所有的ruls，并且过滤出当前输入项匹配的输入校验规则，然后通过AsyncValidator对输入项进行校验，把所有的校验结果放在model对象中。如果errors[0].message非空，就说明校验失败，需要显示对应的错误消息，页面输入框显示红色状态。</p><pre><code class=\"language-javascript\">import Schema from \"async-validator\"\n\nfunction validate() {\n  if (formData?.rules === undefined) {\n    return Promise.resolve({ result: true })\n  }\n  const rules = formData.rules[props.prop]\n  const value = formData.model[props.prop]\n  const schema = new Schema({ [props.prop]: rules })\n  return schema.validate({ [props.prop]: value }, (errors) =&gt; {\n    if (errors) {\n      error.value = errors[0].message || \"校验错误\"\n    } else {\n      error.value = \"\"\n    }\n  })\n}\n</code></pre><h2>总结</h2><p>今天的课程到这就结束了，我们来总结一下今天学到的内容吧。</p><p>今天我们设计和实现了一个比较复杂的组件类型——表单组件。表单组件在组件库中作用，就是收集和获取用户的输入值，并且提供用户的输入校验，比如输入的长度、邮箱格式等，符合校验规则后，就可以获取用户输入的内容，并提交给后端。</p><p>这一过程中我们要实现三类组件：</p><ul>\n<li>\n<p>el-form提供表单的容器组件，负责全局的输入对象model和校验规则rules的配置，并且在用户点击提交的时候，可以执行全部输入项的校验规则；</p>\n</li>\n<li>\n<p>其次是input类组件，我们日常输入内容的输入框、下拉框、滑块等都属于这一类组件，这类组件主要负责显示对应的交互组件，并且监听所有的输入项，用户在交互的同时通知执行校验；</p>\n</li>\n<li>\n<p>然后就是介于form和input中间的form-item组件，这个组件负责每一个具体输入的管理，从form组件中获取校验规则，从input中获取用户输入的内容，通过async-validator校验输入是否合法后显示对应的输入状态，并且还能把校验方法提供给form组件，form可以很方便地管理所有form-item。</p>\n</li>\n</ul><p>至此，form组件设计完毕，相信你对组件通信、输入类组件的实现已经得心应手了，并且对组件设计中如何使用TypeScript也有了自己的心得。<strong>组件设计我们需要考虑的就是内部交互的逻辑，对子组件提供什么数据，对父组件提供什么方法，需不需要通过provide或者inject来进行跨组件通信等等</strong>。相信实践过后，你会有更加深刻的理解和认识。</p><h2>思考题</h2><p>最后留一道思考题：今天的表单组件在设计上能否通过Vue 2时代流行的event-bus来实现呢？</p><p>期待在评论区看到你的思考，也欢迎你把这一讲分享给你的同事和朋友们，我们下一讲再见！</p>","comments":[{"had_liked":false,"id":326013,"user_name":"Geek_fcdf7b","can_delete":false,"product_type":"c1","uid":2115742,"ip_address":"","ucode":"55A2DBA5C6DF79","user_header":"https://static001.geekbang.org/account/avatar/00/20/48/9e/9bbaa97d.jpg","comment_is_top":false,"comment_ctime":1639307160,"is_pvip":false,"replies":[{"id":"118301","content":"现在ref确实是比reactive优先级更高一些，直接建议ref + toRefs一把梭，我碰到必须有reactive的场景的话会写个加餐对比","user_name":"作者回复","comment_id":326013,"uid":"1003715","ip_address":"","utype":1,"ctime":1639395128,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"18819176344","product_id":100094401,"comment_content":"<br>大圣老师，请教一下，3.2版本之后，是不是定义响应式数据都可以用ref一把梭？我看有的文章是这样说的，ref在3.2之后性能进行了大幅度提升，所以建议使用ref，不管简单数据还是复杂数据都可以用ref，没必要用reactive","like_count":5,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"花果山大圣","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538281,"discussion_content":"现在ref确实是比reactive优先级更高一些，直接建议ref + toRefs一把梭，我碰到必须有reactive的场景的话会写个加餐对比","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1639395128,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343052,"user_name":"江南烟雨时","can_delete":false,"product_type":"c1","uid":1649735,"ip_address":"","ucode":"D1857E595D3E98","user_header":"https://static001.geekbang.org/account/avatar/00/19/2c/47/b0931f00.jpg","comment_is_top":false,"comment_ctime":1650610882,"is_pvip":true,"discussion_count":3,"race_medal":0,"score":"14535512770","product_id":100094401,"comment_content":"感觉还是视频课好一些啊","like_count":4,"discussions":[{"author":{"id":1283806,"avatar":"https://static001.geekbang.org/account/avatar/00/13/96/de/cc26d1eb.jpg","nickname":"一个自闭的人","note":"","ucode":"55CD5FD82670B8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":588870,"discussion_content":"讲了好像又没讲","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1664187290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2444675,"avatar":"https://static001.geekbang.org/account/avatar/00/25/4d/83/dcb5a086.jpg","nickname":"张怼怼","note":"","ucode":"D6FA7037A53D27","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576859,"discussion_content":"听了好像又没有听","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1655817185,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3065977,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/c8/79/981e4e15.jpg","nickname":"小岩岩","note":"","ucode":"F89157B7F4883E","race_medal":4,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":589985,"discussion_content":"臣附议","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665448418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326014,"user_name":"小胖","can_delete":false,"product_type":"c1","uid":1098584,"ip_address":"","ucode":"B1C0EFDD821630","user_header":"https://static001.geekbang.org/account/avatar/00/10/c3/58/ba171e09.jpg","comment_is_top":false,"comment_ctime":1639307613,"is_pvip":false,"replies":[{"id":"118310","content":"这里对input的封装并没有做type的判断，为了更好的展示git hook这一节独立一个github的repo，可以看这里 https:&#47;&#47;github.com&#47;shengxinjing&#47;ailemente&#47;blob&#47;main&#47;src&#47;components&#47;form&#47;Input.vue","user_name":"作者回复","comment_id":326014,"uid":"1003715","ip_address":"","utype":1,"ctime":1639396808,"user_name_real":"编辑"}],"discussion_count":2,"race_medal":0,"score":"5934274909","product_id":100094401,"comment_content":"我总觉得这章的代码和表述有点对不上。<br>比如这段：“然后就是具体的 input 实现逻辑，在下面的代码中，input 的核心逻辑就是对 v-model 的支持，这个内容我们在评级组件那一讲已经实现过了。”<br>我的理解之后应该是要贴上Input或者elInput的代码的，可以后面只有FormItem的代码。<br>而且，每段代码其实是不是第一行可以添加一个文件名的注释。<br>同时，这章节的代码在github也没有看见。","like_count":2,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"花果山大圣","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538295,"discussion_content":"这里对input的封装并没有做type的判断，为了更好的展示git hook这一节独立一个github的repo，可以看这里 https://github.com/shengxinjing/ailemente/blob/main/src/components/form/Input.vue","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639396808,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1198158,"avatar":"https://static001.geekbang.org/account/avatar/00/12/48/4e/51896855.jpg","nickname":"落风","note":"","ucode":"D70B221D22A439","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562517,"discussion_content":"这个需要对 Form 的架构设计有清晰认识，分清不同组件承担的职责","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649843687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":341819,"user_name":"落风","can_delete":false,"product_type":"c1","uid":1198158,"ip_address":"","ucode":"D70B221D22A439","user_header":"https://static001.geekbang.org/account/avatar/00/12/48/4e/51896855.jpg","comment_is_top":false,"comment_ctime":1649843620,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1649843620","product_id":100094401,"comment_content":"form-item 负责中间的数据和规则管理，以及显示具体的报错信息。<br>基于这个描述，rules 配置应该也是放在 FormItem 组件的，而不是在 Form 中通过 provide 传递下来，Form 不需要感知具体某个 FormItem 的规则，只需要感知 FormItem 的校验结果","like_count":0,"discussions":[{"author":{"id":2338500,"avatar":"https://static001.geekbang.org/account/avatar/00/23/ae/c4/eafb9ba1.jpg","nickname":"长寿","note":"","ucode":"5FBDF9E65D2F3F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582151,"discussion_content":"从代码来看form-item负责的是规则验证和错误提示，规则则是由form存放管理的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659268877,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"辽宁"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336960,"user_name":"木子初秋","can_delete":false,"product_type":"c1","uid":2893706,"ip_address":"","ucode":"6DDCB55232E1B3","user_header":"https://static001.geekbang.org/account/avatar/00/2c/27/8a/d65e34c4.jpg","comment_is_top":false,"comment_ctime":1646492684,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1646492684","product_id":100094401,"comment_content":"在FormItem组件中，下面这段代码里面的emitter.on接收的事件有什么用？<br>我理解的是FormItem只需要给Form组件传递addFormItem这个事件就可以了，毕竟validate函数执行只需要在Form中运行即可。<br>主要的疑惑：emitter.on需要其它组件通过emitter.emit广播了事件，才能获得对应事件，可是Form没有使用emitter.emit广播任何事件。<br>onMounted(() =&gt; {<br>  if (props.prop) { <br>      emitter.on(&quot;validate&quot;, () =&gt; { validate() }) <br>      emitter.emit(&quot;addFormItem&quot;, o) <br>   }<br>})","like_count":0,"discussions":[{"author":{"id":2338500,"avatar":"https://static001.geekbang.org/account/avatar/00/23/ae/c4/eafb9ba1.jpg","nickname":"长寿","note":"","ucode":"5FBDF9E65D2F3F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582154,"discussion_content":"validate事件是在input类组件中的input事件中触发的，含义是在输入事件发生时对输入值进行规则校验","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659269207,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"辽宁"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333518,"user_name":"郝本坤","can_delete":false,"product_type":"c1","uid":1262100,"ip_address":"","ucode":"9068BAAA818127","user_header":"https://static001.geekbang.org/account/avatar/00/13/42/14/a3c46730.jpg","comment_is_top":false,"comment_ctime":1644393112,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1644393112","product_id":100094401,"comment_content":"mitt 和 event-bus 好像都有一个问题，当input  emitter.emit(&#39;validate&#39;)时，会触发所有监听了validate 的el-form-item。实际我们只想触发父el-form-item的validate，因此这两种方法应该都不是最好的。","like_count":0,"discussions":[{"author":{"id":2338500,"avatar":"https://static001.geekbang.org/account/avatar/00/23/ae/c4/eafb9ba1.jpg","nickname":"长寿","note":"","ucode":"5FBDF9E65D2F3F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582156,"discussion_content":"你的意思是指为每个表单项单独绑定独特的事件，然后再让input类组件触发这个独特的事件吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659269718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"辽宁"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332334,"user_name":"幺叁叁","can_delete":false,"product_type":"c1","uid":1171881,"ip_address":"","ucode":"1140338924C218","user_header":"https://static001.geekbang.org/account/avatar/00/11/e1/a9/f7e0f17a.jpg","comment_is_top":false,"comment_ctime":1643181399,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1643181399","product_id":100094401,"comment_content":"大圣老师，有个问题请教下怎么处理：<br>```html<br>&lt;el-form :form=&quot;form&quot; :rules=&quot;rules&quot;&gt;<br>    &lt;el-form-item label=&quot;账号&quot; prop=&quot;username&quot;&gt;<br>      &lt;el-input v-model=&quot;form.username&quot;&gt;&lt;&#47;el-input&gt;<br>    &lt;&#47;el-form-item&gt;<br><br>    &lt;el-form-item label=&quot;密码&quot; prop=&quot;password&quot;&gt;<br>      &lt;el-input v-model=&quot;form.password&quot;&gt;&lt;&#47;el-input&gt;<br>    &lt;&#47;el-form-item&gt;<br>  &lt;&#47;el-form&gt;<br>```<br>在form-item组件中，使用emitter.on 监听了 validate事件；当在账号的输入框中触发validate事件，其他的form-item组件也会触发validate事件，请问下要如何避免呢？<br><br>","like_count":1,"discussions":[{"author":{"id":1262100,"avatar":"https://static001.geekbang.org/account/avatar/00/13/42/14/a3c46730.jpg","nickname":"郝本坤","note":"","ucode":"9068BAAA818127","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550154,"discussion_content":"el-form-item和el-input的通信可以使用provide和inject，provide 里面提供el-form-item的validate方法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644396492,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332226,"user_name":"余生只有你","can_delete":false,"product_type":"c1","uid":1488101,"ip_address":"","ucode":"4E05CE2B5EFCEB","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/e5/f4e2341c.jpg","comment_is_top":false,"comment_ctime":1643099770,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1643099770","product_id":100094401,"comment_content":"如果有多一层的数据结构，那岂不是无法读取value值了","like_count":0},{"had_liked":false,"id":331534,"user_name":"风一样","can_delete":false,"product_type":"c1","uid":2818001,"ip_address":"","ucode":"5EA5129D487E43","user_header":"https://static001.geekbang.org/account/avatar/00/2a/ff/d1/7a4a6f4f.jpg","comment_is_top":false,"comment_ctime":1642644267,"is_pvip":false,"replies":[{"id":"121137","content":"你好，type类型别名可以使用 type NameResolver = () =&gt; string 来定义一个函数类型，直接function需要用function(a:string):string来定义 interface需要使用下面的语法，写法不同<br>interface SearchFunc {<br>  (source: string, subString: string): boolean;<br>}","user_name":"作者回复","comment_id":331534,"uid":"1003715","ip_address":"","utype":1,"ctime":1642656784,"user_name_real":"编辑"}],"discussion_count":2,"race_medal":0,"score":"1642644267","product_id":100094401,"comment_content":"老师，问一个基础的问题<br><br>export type FormItem = {<br>  validate: () =&gt; Promise&lt;Values&gt;<br>}<br><br>这个类型声明中，=&gt; 是什么意思呢？函数返回的类型，应该是“:”啊？","like_count":0,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"花果山大圣","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547392,"discussion_content":"你好，type类型别名可以使用 type NameResolver = () =&gt; string 来定义一个函数类型，直接function需要用function(a:string):string来定义 interface需要使用下面的语法，写法不同\ninterface SearchFunc {\n  (source: string, subString: string): boolean;\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642656784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2818001,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/ff/d1/7a4a6f4f.jpg","nickname":"风一样","note":"","ucode":"5EA5129D487E43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547475,"discussion_content":"懂了，谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642688606,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":328173,"user_name":"喵喵酱～","can_delete":false,"product_type":"c1","uid":2839525,"ip_address":"","ucode":"A5414A97CACA69","user_header":"https://static001.geekbang.org/account/avatar/00/2b/53/e5/9f484d74.jpg","comment_is_top":false,"comment_ctime":1640588057,"is_pvip":false,"replies":[{"id":"120873","content":"我看下，看来是element3的bug","user_name":"作者回复","comment_id":328173,"uid":"1003715","ip_address":"","utype":1,"ctime":1642342801,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"1640588057","product_id":100094401,"comment_content":"大圣老师你好，请教一个问题：element3 表单验证组件中，有一个现象，一个必填项鼠标focus再blur后，并没有提示“请输入xxx”, 而是在点击确定后统一提示的错误信息，统一提示错误信息后再在必填项里输入数据，此时的必填项错误信息也没有消失。我是在你的文档里测试的。elementui就不是这样","like_count":0,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"花果山大圣","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546584,"discussion_content":"我看下，看来是element3的bug","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642342801,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325996,"user_name":"酱汁","can_delete":false,"product_type":"c1","uid":2436955,"ip_address":"","ucode":"B206BFCD8416AA","user_header":"https://static001.geekbang.org/account/avatar/00/25/2f/5b/74ba6ffa.jpg","comment_is_top":false,"comment_ctime":1639299840,"is_pvip":false,"replies":[{"id":"118309","content":"https:&#47;&#47;github.com&#47;shengxinjing&#47;ailemente和https:&#47;&#47;github.com&#47;hug-sun&#47;element3 可以看到","user_name":"作者回复","comment_id":325996,"uid":"1003715","ip_address":"","utype":1,"ctime":1639396711,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"1639299840","product_id":100094401,"comment_content":"有该demo的源码吗老师","like_count":0,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"花果山大圣","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538294,"discussion_content":"https://github.com/shengxinjing/ailemente和https://github.com/hug-sun/element3 可以看到","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639396711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325841,"user_name":"180620","can_delete":false,"product_type":"c1","uid":2144927,"ip_address":"","ucode":"E2948CD5D06640","user_header":"https://static001.geekbang.org/account/avatar/00/20/ba/9f/9faee5ce.jpg","comment_is_top":false,"comment_ctime":1639188855,"is_pvip":false,"replies":[{"id":"118312","content":"这里我引入了emitter，是一个event-bus的实现，可以看这里https:&#47;&#47;github.com&#47;shengxinjing&#47;ailemente&#47;blob&#47;main&#47;src&#47;emitter.ts","user_name":"作者回复","comment_id":325841,"uid":"1003715","ip_address":"","utype":1,"ctime":1639396862,"user_name_real":"编辑"}],"discussion_count":2,"race_medal":0,"score":"1639188855","product_id":100094401,"comment_content":"import { emitter } from &quot;..&#47;..&#47;emitter&quot;<br>这段断码的意思是什么","like_count":0,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"花果山大圣","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538298,"discussion_content":"这里我引入了emitter，是一个event-bus的实现，可以看这里https://github.com/shengxinjing/ailemente/blob/main/src/emitter.ts","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639396862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1936087,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/8a/d7/daabec34.jpg","nickname":"tequ1lAneio","note":"","ucode":"41336E87FF2E1A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537892,"discussion_content":"自己定义的事件emitter","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639235285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325669,"user_name":"Johnson","can_delete":false,"product_type":"c1","uid":1326108,"ip_address":"","ucode":"C6B6FF9EA4CC60","user_header":"https://static001.geekbang.org/account/avatar/00/14/3c/1c/47e5b7aa.jpg","comment_is_top":false,"comment_ctime":1639094003,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639094003","product_id":100094401,"comment_content":"思考题:可以实现，但是不太优雅！","like_count":0},{"had_liked":false,"id":325668,"user_name":"海阔天空","can_delete":false,"product_type":"c1","uid":1327016,"ip_address":"","ucode":"16C87A0052A08B","user_header":"https://static001.geekbang.org/account/avatar/00/14/3f/a8/8da58e53.jpg","comment_is_top":false,"comment_ctime":1639093467,"is_pvip":false,"replies":[{"id":"118167","content":"其实复杂的也得自己封装一下  只不过vue3没有内置了","user_name":"作者回复","comment_id":325668,"uid":"1003715","ip_address":"","utype":1,"ctime":1639120441,"user_name_real":"编辑"}],"discussion_count":1,"race_medal":0,"score":"1639093467","product_id":100094401,"comment_content":"表单组件在设计在element中实现原理是通过 Vue 2 时代流行的 event-bus 来实现的，不过他们自己封装了emit和watch方法。vue3这实现更方便更简单了啊。<br>","like_count":0,"discussions":[{"author":{"id":1003715,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/50/c3/0aa50246.jpg","nickname":"花果山大圣","note":"","ucode":"25C0A36D628037","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537617,"discussion_content":"其实复杂的也得自己封装一下  只不过vue3没有内置了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639120442,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}