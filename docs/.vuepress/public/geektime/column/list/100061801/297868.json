{"id":297868,"title":"05ï½œ RWMutexï¼šè¯»å†™é”çš„å®ç°åŸç†åŠé¿å‘æŒ‡å—","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>åœ¨å‰é¢çš„å››èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ç¬¬ä¸€ä¸ªåŒæ­¥åŸè¯­ï¼Œå³Mutexï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥ä¿è¯è¯»å†™å…±äº«èµ„æºçš„å®‰å…¨æ€§ã€‚ä¸ç®¡æ˜¯è¯»è¿˜æ˜¯å†™ï¼Œæˆ‘ä»¬éƒ½é€šè¿‡Mutexæ¥ä¿è¯åªæœ‰ä¸€ä¸ªgoroutineè®¿é—®å…±äº«èµ„æºï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹æœ‰ç‚¹â€œæµªè´¹â€ã€‚æ¯”å¦‚è¯´ï¼Œåœ¨å†™å°‘è¯»å¤šçš„æƒ…å†µä¸‹ï¼Œå³ä½¿ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰å†™æ“ä½œï¼Œå¤§é‡å¹¶å‘çš„è¯»è®¿é—®ä¹Ÿä¸å¾—ä¸åœ¨Mutexçš„ä¿æŠ¤ä¸‹å˜æˆäº†ä¸²è¡Œè®¿é—®ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä½¿ç”¨Mutexï¼Œå¯¹æ€§èƒ½çš„å½±å“å°±æ¯”è¾ƒå¤§ã€‚</p><p>æ€ä¹ˆåŠå‘¢ï¼Ÿä½ æ˜¯ä¸æ˜¯å·²ç»æœ‰æ€è·¯äº†ï¼Œå¯¹ï¼Œå°±æ˜¯åŒºåˆ†è¯»å†™æ“ä½œã€‚</p><p>æˆ‘æ¥å…·ä½“è§£é‡Šä¸€ä¸‹ã€‚å¦‚æœæŸä¸ªè¯»æ“ä½œçš„goroutineæŒæœ‰äº†é”ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå…¶å®ƒè¯»æ“ä½œçš„goroutineå°±ä¸å¿…ä¸€ç›´å‚»å‚»åœ°ç­‰å¾…äº†ï¼Œè€Œæ˜¯å¯ä»¥å¹¶å‘åœ°è®¿é—®å…±äº«å˜é‡ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥<strong>å°†ä¸²è¡Œçš„è¯»å˜æˆå¹¶è¡Œè¯»</strong>ï¼Œæé«˜è¯»æ“ä½œçš„æ€§èƒ½ã€‚å½“å†™æ“ä½œçš„goroutineæŒæœ‰é”çš„æ—¶å€™ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ’å¤–é”ï¼Œå…¶å®ƒçš„å†™æ“ä½œå’Œè¯»æ“ä½œçš„goroutineï¼Œéœ€è¦é˜»å¡ç­‰å¾…æŒæœ‰è¿™ä¸ªé”çš„goroutineé‡Šæ”¾é”ã€‚</p><p>è¿™ä¸€ç±»å¹¶å‘è¯»å†™é—®é¢˜å«ä½œ<a href=\"https://en.wikipedia.org/wiki/Readers%E2%80%93writers_problem\">readers-writersé—®é¢˜</a>ï¼Œæ„æ€å°±æ˜¯ï¼ŒåŒæ—¶å¯èƒ½æœ‰å¤šä¸ªè¯»æˆ–è€…å¤šä¸ªå†™ï¼Œä½†æ˜¯åªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå†™æ“ä½œï¼Œå…¶å®ƒçš„çº¿ç¨‹éƒ½ä¸èƒ½æ‰§è¡Œè¯»å†™æ“ä½œã€‚</p><p><strong>Goæ ‡å‡†åº“ä¸­çš„RWMutexï¼ˆè¯»å†™é”ï¼‰å°±æ˜¯ç”¨æ¥è§£å†³è¿™ç±»readers-writersé—®é¢˜çš„</strong>ã€‚æ‰€ä»¥ï¼Œè¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥å­¦ä¹ RWMutexã€‚æˆ‘ä¼šç»™ä½ ä»‹ç»è¯»å†™é”çš„ä½¿ç”¨åœºæ™¯ã€å®ç°åŸç†ä»¥åŠå®¹æ˜“æ‰å…¥çš„å‘ï¼Œä½ ä¸€å®šè¦è®°ä½è¿™äº›é™·é˜±ï¼Œé¿å…åœ¨å®é™…çš„å¼€å‘ä¸­çŠ¯ç›¸åŒçš„é”™è¯¯ã€‚</p><!-- [[[read_end]]] --><h1>ä»€ä¹ˆæ˜¯RWMutexï¼Ÿ</h1><p>æˆ‘å…ˆç®€å•è§£é‡Šä¸€ä¸‹è¯»å†™é”RWMutexã€‚æ ‡å‡†åº“ä¸­çš„RWMutexæ˜¯ä¸€ä¸ª reader/writer äº’æ–¥é”ã€‚RWMutexåœ¨æŸä¸€æ—¶åˆ»åªèƒ½ç”±ä»»æ„æ•°é‡çš„readeræŒæœ‰ï¼Œæˆ–è€…æ˜¯åªè¢«å•ä¸ªçš„writeræŒæœ‰ã€‚</p><p>RWMutexçš„æ–¹æ³•ä¹Ÿå¾ˆå°‘ï¼Œæ€»å…±æœ‰5ä¸ªã€‚</p><ul>\n<li><strong>Lock/Unlockï¼šå†™æ“ä½œæ—¶è°ƒç”¨çš„æ–¹æ³•</strong>ã€‚å¦‚æœé”å·²ç»è¢«readeræˆ–è€…writeræŒæœ‰ï¼Œé‚£ä¹ˆï¼ŒLockæ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ï¼›Unlockåˆ™æ˜¯é…å¯¹çš„é‡Šæ”¾é”çš„æ–¹æ³•ã€‚</li>\n<li><strong>RLock/RUnlockï¼šè¯»æ“ä½œæ—¶è°ƒç”¨çš„æ–¹æ³•</strong>ã€‚å¦‚æœé”å·²ç»è¢«writeræŒæœ‰çš„è¯ï¼ŒRLockæ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°èƒ½è·å–åˆ°é”ï¼Œå¦åˆ™å°±ç›´æ¥è¿”å›ï¼›è€ŒRUnlockæ˜¯readeré‡Šæ”¾é”çš„æ–¹æ³•ã€‚</li>\n<li><strong>RLocker</strong>ï¼šè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ä¸ºè¯»æ“ä½œè¿”å›ä¸€ä¸ªLockeræ¥å£çš„å¯¹è±¡ã€‚å®ƒçš„Lockæ–¹æ³•ä¼šè°ƒç”¨RWMutexçš„RLockæ–¹æ³•ï¼Œå®ƒçš„Unlockæ–¹æ³•ä¼šè°ƒç”¨RWMutexçš„RUnlockæ–¹æ³•ã€‚</li>\n</ul><p>RWMutexçš„é›¶å€¼æ˜¯æœªåŠ é”çš„çŠ¶æ€ï¼Œæ‰€ä»¥ï¼Œå½“ä½ ä½¿ç”¨RWMutexçš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å£°æ˜å˜é‡ï¼Œè¿˜æ˜¯åµŒå…¥åˆ°å…¶å®ƒstructä¸­ï¼Œéƒ½ä¸å¿…æ˜¾å¼åœ°åˆå§‹åŒ–ã€‚</p><p>æˆ‘ä»¥è®¡æ•°å™¨ä¸ºä¾‹ï¼Œæ¥è¯´æ˜ä¸€ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨RWMutexä¿æŠ¤å…±äº«èµ„æºã€‚è®¡æ•°å™¨çš„<strong>count++<strong>æ“ä½œæ˜¯</strong>å†™</strong>æ“ä½œï¼Œè€Œè·å–countçš„å€¼æ˜¯<strong>è¯»</strong>æ“ä½œï¼Œè¿™ä¸ªåœºæ™¯éå¸¸é€‚åˆè¯»å†™é”ï¼Œå› ä¸ºè¯»æ“ä½œå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œå†™æ“ä½œæ—¶åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œè¿™æ­£æ˜¯readers-writersé—®é¢˜ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½¿ç”¨10ä¸ªgoroutineè¿›è¡Œè¯»æ“ä½œï¼Œæ¯è¯»å–ä¸€æ¬¡ï¼Œsleep 1æ¯«ç§’ï¼ŒåŒæ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªgorotineè¿›è¡Œå†™æ“ä½œï¼Œæ¯ä¸€ç§’å†™ä¸€æ¬¡ï¼Œè¿™æ˜¯ä¸€ä¸ª <strong>1</strong> writer-<strong>n</strong> reader çš„è¯»å†™åœºæ™¯ï¼Œè€Œä¸”å†™æ“ä½œè¿˜ä¸æ˜¯å¾ˆé¢‘ç¹ï¼ˆä¸€ç§’ä¸€æ¬¡ï¼‰ï¼š</p><pre><code>func main() {\n    var counter Counter\n    for i := 0; i &lt; 10; i++ { // 10ä¸ªreader\n        go func() {\n            for {\n                counter.Count() // è®¡æ•°å™¨è¯»æ“ä½œ\n                time.Sleep(time.Millisecond)\n            }\n        }()\n    }\n\n    for { // ä¸€ä¸ªwriter\n        counter.Incr() // è®¡æ•°å™¨å†™æ“ä½œ\n        time.Sleep(time.Second)\n    }\n}\n// ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨\ntype Counter struct {\n    mu    sync.RWMutex\n    count uint64\n}\n\n// ä½¿ç”¨å†™é”ä¿æŠ¤\nfunc (c *Counter) Incr() {\n    c.mu.Lock()\n    c.count++\n    c.mu.Unlock()\n}\n\n// ä½¿ç”¨è¯»é”ä¿æŠ¤\nfunc (c *Counter) Count() uint64 {\n    c.mu.RLock()\n    defer c.mu.RUnlock()\n    return c.count\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒIncræ–¹æ³•ä¼šä¿®æ”¹è®¡æ•°å™¨çš„å€¼ï¼Œæ˜¯ä¸€ä¸ªå†™æ“ä½œï¼Œæˆ‘ä»¬ä½¿ç”¨Lock/Unlockè¿›è¡Œä¿æŠ¤ã€‚Countæ–¹æ³•ä¼šè¯»å–å½“å‰è®¡æ•°å™¨çš„å€¼ï¼Œæ˜¯ä¸€ä¸ªè¯»æ“ä½œï¼Œæˆ‘ä»¬ä½¿ç”¨RLock/RUnlockæ–¹æ³•è¿›è¡Œä¿æŠ¤ã€‚</p><p>Incræ–¹æ³•æ¯ç§’æ‰è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥ï¼Œwriterç«äº‰é”çš„é¢‘æ¬¡æ˜¯æ¯”è¾ƒä½çš„ï¼Œè€Œ10ä¸ªgoroutineæ¯æ¯«ç§’éƒ½è¦æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œé€šè¿‡è¯»å†™é”ï¼Œå¯ä»¥æå¤§æå‡è®¡æ•°å™¨çš„æ€§èƒ½ï¼Œå› ä¸ºåœ¨è¯»å–çš„æ—¶å€™ï¼Œå¯ä»¥å¹¶å‘è¿›è¡Œã€‚å¦‚æœä½¿ç”¨Mutexï¼Œæ€§èƒ½å°±ä¸ä¼šåƒè¯»å†™é”è¿™ä¹ˆå¥½ã€‚å› ä¸ºå¤šä¸ªreaderå¹¶å‘è¯»çš„æ—¶å€™ï¼Œä½¿ç”¨äº’æ–¥é”å¯¼è‡´äº†readerè¦æ’é˜Ÿè¯»çš„æƒ…å†µï¼Œæ²¡æœ‰RWMutexå¹¶å‘è¯»çš„æ€§èƒ½å¥½ã€‚</p><p><strong>å¦‚æœä½ é‡åˆ°å¯ä»¥æ˜ç¡®åŒºåˆ†readerå’Œwriter goroutineçš„åœºæ™¯ï¼Œä¸”æœ‰å¤§é‡çš„å¹¶å‘è¯»ã€å°‘é‡çš„å¹¶å‘å†™ï¼Œå¹¶ä¸”æœ‰å¼ºçƒˆçš„æ€§èƒ½éœ€æ±‚ï¼Œä½ å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨è¯»å†™é”RWMutexæ›¿æ¢Mutexã€‚</strong></p><p>åœ¨å®é™…ä½¿ç”¨RWMutexçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬åœ¨structä¸­ä½¿ç”¨RWMutexä¿æŠ¤æŸä¸ªå­—æ®µï¼Œä¸€èˆ¬ä¼šæŠŠå®ƒå’Œè¿™ä¸ªå­—æ®µæ”¾åœ¨ä¸€èµ·ï¼Œç”¨æ¥æŒ‡ç¤ºä¸¤ä¸ªå­—æ®µæ˜¯ä¸€ç»„å­—æ®µã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é‡‡ç”¨åŒ¿åå­—æ®µçš„æ–¹å¼åµŒå…¥structï¼Œè¿™æ ·ï¼Œåœ¨ä½¿ç”¨è¿™ä¸ªstructæ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è°ƒç”¨Lock/Unlockã€RLock/RUnlockæ–¹æ³•äº†ï¼Œè¿™å’Œæˆ‘ä»¬å‰é¢åœ¨<a href=\"https://time.geekbang.org/column/article/294905\">01è®²</a>ä¸­ä»‹ç»Mutexçš„ä½¿ç”¨æ–¹æ³•å¾ˆç±»ä¼¼ï¼Œä½ å¯ä»¥å›å»å¤ä¹ ä¸€ä¸‹ã€‚</p><h1>RWMutexçš„å®ç°åŸç†</h1><p>RWMutexæ˜¯å¾ˆå¸¸è§çš„å¹¶å‘åŸè¯­ï¼Œå¾ˆå¤šç¼–ç¨‹è¯­è¨€çš„åº“éƒ½æä¾›äº†ç±»ä¼¼çš„å¹¶å‘ç±»å‹ã€‚RWMutexä¸€èˆ¬éƒ½æ˜¯åŸºäºäº’æ–¥é”ã€æ¡ä»¶å˜é‡ï¼ˆcondition variablesï¼‰æˆ–è€…ä¿¡å·é‡ï¼ˆsemaphoresï¼‰ç­‰å¹¶å‘åŸè¯­æ¥å®ç°ã€‚<strong>Goæ ‡å‡†åº“ä¸­çš„RWMutexæ˜¯åŸºäºMutexå®ç°çš„ã€‚</strong></p><p>readers-writersé—®é¢˜ä¸€èˆ¬æœ‰ä¸‰ç±»ï¼ŒåŸºäºå¯¹è¯»å’Œå†™æ“ä½œçš„ä¼˜å…ˆçº§ï¼Œè¯»å†™é”çš„è®¾è®¡å’Œå®ç°ä¹Ÿåˆ†æˆä¸‰ç±»ã€‚</p><ul>\n<li><strong>Read-preferring</strong>ï¼šè¯»ä¼˜å…ˆçš„è®¾è®¡å¯ä»¥æä¾›å¾ˆé«˜çš„å¹¶å‘æ€§ï¼Œä½†æ˜¯ï¼Œåœ¨ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´å†™é¥¥é¥¿ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœæœ‰å¤§é‡çš„è¯»ï¼Œè¿™ç§è®¾è®¡ä¼šå¯¼è‡´åªæœ‰æ‰€æœ‰çš„è¯»éƒ½é‡Šæ”¾äº†é”ä¹‹åï¼Œå†™æ‰å¯èƒ½è·å–åˆ°é”ã€‚</li>\n<li><strong>Write-preferring</strong>ï¼šå†™ä¼˜å…ˆçš„è®¾è®¡æ„å‘³ç€ï¼Œå¦‚æœå·²ç»æœ‰ä¸€ä¸ªwriteråœ¨ç­‰å¾…è¯·æ±‚é”çš„è¯ï¼Œå®ƒä¼šé˜»æ­¢æ–°æ¥çš„è¯·æ±‚é”çš„readerè·å–åˆ°é”ï¼Œæ‰€ä»¥ä¼˜å…ˆä¿éšœwriterã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰ä¸€äº›readerå·²ç»è¯·æ±‚äº†é”çš„è¯ï¼Œæ–°è¯·æ±‚çš„writerä¹Ÿä¼šç­‰å¾…å·²ç»å­˜åœ¨çš„readeréƒ½é‡Šæ”¾é”ä¹‹åæ‰èƒ½è·å–ã€‚æ‰€ä»¥ï¼Œå†™ä¼˜å…ˆçº§è®¾è®¡ä¸­çš„ä¼˜å…ˆæƒæ˜¯é’ˆå¯¹æ–°æ¥çš„è¯·æ±‚è€Œè¨€çš„ã€‚è¿™ç§è®¾è®¡ä¸»è¦é¿å…äº†writerçš„é¥¥é¥¿é—®é¢˜ã€‚</li>\n<li><strong>ä¸æŒ‡å®šä¼˜å…ˆçº§</strong>ï¼šè¿™ç§è®¾è®¡æ¯”è¾ƒç®€å•ï¼Œä¸åŒºåˆ†readerå’Œwriterä¼˜å…ˆçº§ï¼ŒæŸäº›åœºæ™¯ä¸‹è¿™ç§ä¸æŒ‡å®šä¼˜å…ˆçº§çš„è®¾è®¡åè€Œæ›´æœ‰æ•ˆï¼Œå› ä¸ºç¬¬ä¸€ç±»ä¼˜å…ˆçº§ä¼šå¯¼è‡´å†™é¥¥é¥¿ï¼Œç¬¬äºŒç±»ä¼˜å…ˆçº§å¯èƒ½ä¼šå¯¼è‡´è¯»é¥¥é¥¿ï¼Œè¿™ç§ä¸æŒ‡å®šä¼˜å…ˆçº§çš„è®¿é—®ä¸å†åŒºåˆ†è¯»å†™ï¼Œå¤§å®¶éƒ½æ˜¯åŒä¸€ä¸ªä¼˜å…ˆçº§ï¼Œè§£å†³äº†é¥¥é¥¿çš„é—®é¢˜ã€‚</li>\n</ul><p><strong>Goæ ‡å‡†åº“ä¸­çš„RWMutexè®¾è®¡æ˜¯Write-preferringæ–¹æ¡ˆã€‚ä¸€ä¸ªæ­£åœ¨é˜»å¡çš„Lockè°ƒç”¨ä¼šæ’é™¤æ–°çš„readerè¯·æ±‚åˆ°é”ã€‚</strong></p><p>RWMutexåŒ…å«ä¸€ä¸ªMutexï¼Œä»¥åŠå››ä¸ªè¾…åŠ©å­—æ®µwriterSemã€readerSemã€readerCountå’ŒreaderWaitï¼š</p><pre><code>type RWMutex struct {\n\tw           Mutex   // äº’æ–¥é”è§£å†³å¤šä¸ªwriterçš„ç«äº‰\n\twriterSem   uint32  // writerä¿¡å·é‡\n\treaderSem   uint32  // readerä¿¡å·é‡\n\treaderCount int32   // readerçš„æ•°é‡\n\treaderWait  int32   // writerç­‰å¾…å®Œæˆçš„readerçš„æ•°é‡\n}\n\nconst rwmutexMaxReaders = 1 &lt;&lt; 30\n</code></pre><p>æˆ‘æ¥ç®€å•è§£é‡Šä¸€ä¸‹è¿™å‡ ä¸ªå­—æ®µã€‚</p><ul>\n<li>å­—æ®µwï¼šä¸ºwriterçš„ç«äº‰é”è€Œè®¾è®¡ï¼›</li>\n<li>å­—æ®µreaderCountï¼šè®°å½•å½“å‰readerçš„æ•°é‡ï¼ˆä»¥åŠæ˜¯å¦æœ‰writerç«äº‰é”ï¼‰ï¼›</li>\n<li>readerWaitï¼šè®°å½•writerè¯·æ±‚é”æ—¶éœ€è¦ç­‰å¾…readå®Œæˆçš„readerçš„æ•°é‡ï¼›</li>\n<li>writerSem å’ŒreaderSemï¼šéƒ½æ˜¯ä¸ºäº†é˜»å¡è®¾è®¡çš„ä¿¡å·é‡ã€‚</li>\n</ul><p>è¿™é‡Œçš„å¸¸é‡rwmutexMaxReadersï¼Œå®šä¹‰äº†æœ€å¤§çš„readeræ•°é‡ã€‚</p><p>å¥½äº†ï¼ŒçŸ¥é“äº†RWMutexçš„è®¾è®¡æ–¹æ¡ˆå’Œå…·ä½“å­—æ®µï¼Œä¸‹é¢æˆ‘æ¥è§£é‡Šä¸€ä¸‹å…·ä½“çš„æ–¹æ³•å®ç°ã€‚</p><h2>RLock/RUnlockçš„å®ç°</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç§»é™¤äº†raceç­‰æ— å…³ç´§è¦çš„ä»£ç åçš„RLockå’ŒRUnlockæ–¹æ³•ï¼š</p><pre><code>func (rw *RWMutex) RLock() {\n    if atomic.AddInt32(&amp;rw.readerCount, 1) &lt; 0 {\n            // rw.readerCountæ˜¯è´Ÿå€¼çš„æ—¶å€™ï¼Œæ„å‘³ç€æ­¤æ—¶æœ‰writerç­‰å¾…è¯·æ±‚é”ï¼Œå› ä¸ºwriterä¼˜å…ˆçº§é«˜ï¼Œæ‰€ä»¥æŠŠåæ¥çš„readeré˜»å¡ä¼‘çœ \n        runtime_SemacquireMutex(&amp;rw.readerSem, false, 0)\n    }\n}\nfunc (rw *RWMutex) RUnlock() {\n    if r := atomic.AddInt32(&amp;rw.readerCount, -1); r &lt; 0 {\n        rw.rUnlockSlow(r) // æœ‰ç­‰å¾…çš„writer\n    }\n}\nfunc (rw *RWMutex) rUnlockSlow(r int32) {\n    if atomic.AddInt32(&amp;rw.readerWait, -1) == 0 {\n        // æœ€åä¸€ä¸ªreaderäº†ï¼Œwriterç»ˆäºæœ‰æœºä¼šè·å¾—é”äº†\n        runtime_Semrelease(&amp;rw.writerSem, false, 1)\n    }\n}\n</code></pre><p>ç¬¬2è¡Œæ˜¯å¯¹readerè®¡æ•°åŠ 1ã€‚ä½ å¯èƒ½æ¯”è¾ƒå›°æƒ‘çš„æ˜¯ï¼ŒreaderCountæ€ä¹ˆè¿˜å¯èƒ½ä¸ºè´Ÿæ•°å‘¢ï¼Ÿå…¶å®ï¼Œè¿™æ˜¯å› ä¸ºï¼ŒreaderCountè¿™ä¸ªå­—æ®µæœ‰åŒé‡å«ä¹‰ï¼š</p><ul>\n<li>æ²¡æœ‰writerç«äº‰æˆ–æŒæœ‰é”æ—¶ï¼ŒreaderCountå’Œæˆ‘ä»¬æ­£å¸¸ç†è§£çš„readerçš„è®¡æ•°æ˜¯ä¸€æ ·çš„ï¼›</li>\n<li>ä½†æ˜¯ï¼Œå¦‚æœæœ‰writerç«äº‰é”æˆ–è€…æŒæœ‰é”æ—¶ï¼Œé‚£ä¹ˆï¼ŒreaderCountä¸ä»…ä»…æ‰¿æ‹…ç€readerçš„è®¡æ•°åŠŸèƒ½ï¼Œè¿˜èƒ½å¤Ÿæ ‡è¯†å½“å‰æ˜¯å¦æœ‰writerç«äº‰æˆ–æŒæœ‰é”ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚é”çš„readerçš„å¤„ç†è¿›å…¥ç¬¬4è¡Œï¼Œé˜»å¡ç­‰å¾…é”çš„é‡Šæ”¾ã€‚</li>\n</ul><p>è°ƒç”¨RUnlockçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†Readerçš„è®¡æ•°å‡å»1ï¼ˆç¬¬8è¡Œï¼‰ï¼Œå› ä¸ºreaderçš„æ•°é‡å‡å°‘äº†ä¸€ä¸ªã€‚ä½†æ˜¯ï¼Œç¬¬8è¡Œçš„AddInt32çš„è¿”å›å€¼è¿˜æœ‰å¦å¤–ä¸€ä¸ªå«ä¹‰ã€‚å¦‚æœå®ƒæ˜¯è´Ÿå€¼ï¼Œå°±è¡¨ç¤ºå½“å‰æœ‰writerç«äº‰é”ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜ä¼šè°ƒç”¨rUnlockSlowæ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯readeréƒ½é‡Šæ”¾è¯»é”äº†ï¼Œå¦‚æœè¯»é”éƒ½é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆå¯ä»¥å”¤é†’è¯·æ±‚å†™é”çš„writeräº†ã€‚</p><p>å½“ä¸€ä¸ªæˆ–è€…å¤šä¸ªreaderæŒæœ‰é”çš„æ—¶å€™ï¼Œç«äº‰é”çš„writerä¼šç­‰å¾…è¿™äº›readeré‡Šæ”¾å®Œï¼Œæ‰å¯èƒ½æŒæœ‰è¿™æŠŠé”ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œåœ¨æˆ¿åœ°äº§è¡Œä¸šä¸­æœ‰æ¡è§„çŸ©å«åšâ€œ<strong>ä¹°å–ä¸ç ´ç§Ÿèµ</strong>â€ï¼Œæ„æ€æ˜¯è¯´ï¼Œå°±ç®—æˆ¿ä¸œæŠŠæˆ¿å­å–äº†ï¼Œæ–°ä¸šä¸»ä¹Ÿä¸èƒ½æŠŠå½“å‰çš„ç§Ÿæˆ·èµ¶èµ°ï¼Œè€Œæ˜¯è¦ç­‰åˆ°ç§Ÿçº¦ç»“æŸåï¼Œæ‰èƒ½æ¥ç®¡æˆ¿å­ã€‚è¿™å’ŒRWMutexçš„è®¾è®¡æ˜¯ä¸€æ ·çš„ã€‚å½“writerè¯·æ±‚é”çš„æ—¶å€™ï¼Œæ˜¯æ— æ³•æ”¹å˜æ—¢æœ‰çš„readeræŒæœ‰é”çš„ç°å®çš„ï¼Œä¹Ÿä¸ä¼šå¼ºåˆ¶è¿™äº›readeré‡Šæ”¾é”ï¼Œå®ƒçš„ä¼˜å…ˆæƒåªæ˜¯é™å®šåæ¥çš„readerä¸è¦å’Œå®ƒæŠ¢ã€‚</p><p>æ‰€ä»¥ï¼ŒrUnlockSlowå°†æŒæœ‰é”çš„readerè®¡æ•°å‡å°‘1çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥æ—¢æœ‰çš„readeræ˜¯ä¸æ˜¯éƒ½å·²ç»é‡Šæ”¾äº†é”ï¼Œå¦‚æœéƒ½é‡Šæ”¾äº†é”ï¼Œå°±ä¼šå”¤é†’writerï¼Œè®©writeræŒæœ‰é”ã€‚</p><h2>Lock</h2><p>RWMutexæ˜¯ä¸€ä¸ªå¤šwriterå¤šreaderçš„è¯»å†™é”ï¼Œæ‰€ä»¥åŒæ—¶å¯èƒ½æœ‰å¤šä¸ªwriterå’Œreaderã€‚é‚£ä¹ˆï¼Œä¸ºäº†é¿å…writerä¹‹é—´çš„ç«äº‰ï¼ŒRWMutexå°±ä¼šä½¿ç”¨ä¸€ä¸ªMutexæ¥ä¿è¯writerçš„äº’æ–¥ã€‚</p><p>ä¸€æ—¦ä¸€ä¸ªwriterè·å¾—äº†å†…éƒ¨çš„äº’æ–¥é”ï¼Œå°±ä¼šåè½¬readerCountå­—æ®µï¼ŒæŠŠå®ƒä»åŸæ¥çš„æ­£æ•´æ•°readerCount(&gt;=0)ä¿®æ”¹ä¸ºè´Ÿæ•°ï¼ˆreaderCount-rwmutexMaxReadersï¼‰ï¼Œè®©è¿™ä¸ªå­—æ®µä¿æŒä¸¤ä¸ªå«ä¹‰ï¼ˆæ—¢ä¿å­˜äº†readerçš„æ•°é‡ï¼Œåˆè¡¨ç¤ºå½“å‰æœ‰writerï¼‰ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸‹é¢çš„ä»£ç ã€‚ç¬¬5è¡Œï¼Œè¿˜ä¼šè®°å½•å½“å‰æ´»è·ƒçš„readeræ•°é‡ï¼Œæ‰€è°“æ´»è·ƒçš„readerï¼Œå°±æ˜¯æŒ‡æŒæœ‰è¯»é”è¿˜æ²¡æœ‰é‡Šæ”¾çš„é‚£äº›readerã€‚</p><pre><code>func (rw *RWMutex) Lock() {\n    // é¦–å…ˆè§£å†³å…¶ä»–writerç«äº‰é—®é¢˜\n    rw.w.Lock()\n    // åè½¬readerCountï¼Œå‘Šè¯‰readeræœ‰writerç«äº‰é”\n    r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders\n    // å¦‚æœå½“å‰æœ‰readeræŒæœ‰é”ï¼Œé‚£ä¹ˆéœ€è¦ç­‰å¾…\n    if r != 0 &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != 0 {\n        runtime_SemacquireMutex(&amp;rw.writerSem, false, 0)\n    }\n}\n</code></pre><p>å¦‚æœreaderCountä¸æ˜¯0ï¼Œå°±è¯´æ˜å½“å‰æœ‰æŒæœ‰è¯»é”çš„readerï¼ŒRWMutexéœ€è¦æŠŠè¿™ä¸ªå½“å‰readerCountèµ‹å€¼ç»™readerWaitå­—æ®µä¿å­˜ä¸‹æ¥ï¼ˆç¬¬7è¡Œï¼‰ï¼Œ åŒæ—¶ï¼Œè¿™ä¸ªwriterè¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼ˆç¬¬8è¡Œï¼‰ã€‚</p><p>æ¯å½“ä¸€ä¸ªreaderé‡Šæ”¾è¯»é”çš„æ—¶å€™ï¼ˆè°ƒç”¨RUnlockæ–¹æ³•æ—¶ï¼‰ï¼ŒreaderWaitå­—æ®µå°±å‡1ï¼Œç›´åˆ°æ‰€æœ‰çš„æ´»è·ƒçš„readeréƒ½é‡Šæ”¾äº†è¯»é”ï¼Œæ‰ä¼šå”¤é†’è¿™ä¸ªwriterã€‚</p><h2>Unlock</h2><p>å½“ä¸€ä¸ªwriteré‡Šæ”¾é”çš„æ—¶å€™ï¼Œå®ƒä¼šå†æ¬¡åè½¬readerCountå­—æ®µã€‚å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œå› ä¸ºå½“å‰é”ç”±writeræŒæœ‰ï¼Œæ‰€ä»¥ï¼ŒreaderCountå­—æ®µæ˜¯åè½¬è¿‡çš„ï¼Œå¹¶ä¸”å‡å»äº†rwmutexMaxReadersè¿™ä¸ªå¸¸æ•°ï¼Œå˜æˆäº†è´Ÿæ•°ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œçš„åè½¬æ–¹æ³•å°±æ˜¯ç»™å®ƒå¢åŠ rwmutexMaxReadersè¿™ä¸ªå¸¸æ•°å€¼ã€‚</p><p>æ—¢ç„¶writerè¦é‡Šæ”¾é”äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦å”¤é†’ä¹‹åæ–°æ¥çš„readerï¼Œä¸å¿…å†é˜»å¡å®ƒä»¬äº†ï¼Œè®©å®ƒä»¬å¼€å¼€å¿ƒå¿ƒåœ°ç»§ç»­æ‰§è¡Œå°±å¥½äº†ã€‚</p><p>åœ¨RWMutexçš„Unlockè¿”å›ä¹‹å‰ï¼Œéœ€è¦æŠŠå†…éƒ¨çš„äº’æ–¥é”é‡Šæ”¾ã€‚é‡Šæ”¾å®Œæ¯•åï¼Œå…¶ä»–çš„writeræ‰å¯ä»¥ç»§ç»­ç«äº‰è¿™æŠŠé”ã€‚</p><pre><code>func (rw *RWMutex) Unlock() {\n    // å‘Šè¯‰readeræ²¡æœ‰æ´»è·ƒçš„writeräº†\n    r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)\n    \n    // å”¤é†’é˜»å¡çš„readerä»¬\n    for i := 0; i &lt; int(r); i++ {\n        runtime_Semrelease(&amp;rw.readerSem, false, 0)\n    }\n    // é‡Šæ”¾å†…éƒ¨çš„äº’æ–¥é”\n    rw.w.Unlock()\n}\n</code></pre><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘åˆ é™¤äº†raceçš„å¤„ç†å’Œå¼‚å¸¸æƒ…å†µçš„æ£€æŸ¥ï¼Œæ€»ä½“çœ‹æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚è¿™é‡Œæœ‰å‡ ä¸ªé‡ç‚¹ï¼Œæˆ‘è¦å†æé†’ä½ ä¸€ä¸‹ã€‚é¦–å…ˆï¼Œä½ è¦ç†è§£readerCountè¿™ä¸ªå­—æ®µçš„å«ä¹‰ä»¥åŠåè½¬æ–¹å¼ã€‚å…¶æ¬¡ï¼Œä½ è¿˜è¦æ³¨æ„å­—æ®µçš„æ›´æ”¹å’Œå†…éƒ¨äº’æ–¥é”çš„é¡ºåºå…³ç³»ã€‚åœ¨Lockæ–¹æ³•ä¸­ï¼Œæ˜¯å…ˆè·å–å†…éƒ¨äº’æ–¥é”ï¼Œæ‰ä¼šä¿®æ”¹çš„å…¶ä»–å­—æ®µï¼›è€Œåœ¨Unlockæ–¹æ³•ä¸­ï¼Œæ˜¯å…ˆä¿®æ”¹çš„å…¶ä»–å­—æ®µï¼Œæ‰ä¼šé‡Šæ”¾å†…éƒ¨äº’æ–¥é”ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯å­—æ®µçš„ä¿®æ”¹ä¹Ÿå—åˆ°äº’æ–¥é”çš„ä¿æŠ¤ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæ•´å­¦ä¹ äº†RWMutexçš„æ¦‚å¿µå’Œå®ç°åŸç†ã€‚RWMutexçš„åº”ç”¨åœºæ™¯éå¸¸æ˜ç¡®ï¼Œå°±æ˜¯è§£å†³readers-writersé—®é¢˜ã€‚å­¦å®Œäº†ä»Šå¤©çš„å†…å®¹ï¼Œä¹‹åå½“ä½ é‡åˆ°è¿™ç±»é—®é¢˜æ—¶ï¼Œè¦ä¼˜å…ˆæƒ³åˆ°RWMutexã€‚å¦å¤–ï¼ŒGoå¹¶å‘åŸè¯­ä»£ç å®ç°çš„è´¨é‡éƒ½å¾ˆé«˜ï¼Œéå¸¸ç²¾ç‚¼å’Œé«˜æ•ˆï¼Œæ‰€ä»¥ï¼Œä½ å¯ä»¥é€šè¿‡çœ‹å®ƒä»¬çš„å®ç°åŸç†ï¼Œå­¦ä¹ ä¸€äº›ç¼–ç¨‹çš„æŠ€å·§ã€‚å½“ç„¶ï¼Œè¿˜æœ‰éå¸¸é‡è¦çš„ä¸€ç‚¹å°±æ˜¯è¦çŸ¥é“readeræˆ–è€…writerè¯·æ±‚é”çš„æ—¶å€™ï¼Œæ—¢æœ‰çš„reader/writerå’Œåç»­è¯·æ±‚é”çš„reader/writerä¹‹é—´çš„ï¼ˆé‡Šæ”¾é”/è¯·æ±‚é”ï¼‰é¡ºåºå…³ç³»ã€‚</p><p>æœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„äº‹å„¿ï¼Œå°±æ˜¯å®˜æ–¹çš„æ–‡æ¡£å¯¹RWMutexä»‹ç»æ˜¯é”™è¯¯çš„ï¼Œæˆ–è€…è¯´æ˜¯<a href=\"https://github.com/golang/go/issues/41555\">ä¸æ˜ç¡®çš„</a>ï¼Œåœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼ˆGo 1.16ï¼‰ä¸­ï¼Œå®˜æ–¹ä¼šæ›´æ”¹å¯¹RWMutexçš„ä»‹ç»ï¼Œå…·ä½“æ˜¯è¿™æ ·çš„ï¼š</p><blockquote>\n<p>A RWMutex is a reader/writer mutual exclusion lock.</p>\n</blockquote><blockquote>\n<p>The lock can be held by any number of readers or a single writer, and</p>\n</blockquote><blockquote>\n<p>a blocked writer also blocks new readers from acquiring the lock.</p>\n</blockquote><p>è¿™ä¸ªæè¿°æ˜¯ç›¸å½“ç²¾ç¡®çš„ï¼Œå®ƒæŒ‡å‡ºäº†RWMutexå¯ä»¥è¢«è°æŒæœ‰ï¼Œä»¥åŠwriteræ¯”åç»­çš„readeræœ‰è·å–é”çš„ä¼˜å…ˆçº§ã€‚</p><p>è™½ç„¶RWMutexæš´éœ²çš„APIä¹Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ²¡æœ‰å¤æ‚çš„é€»è¾‘ï¼Œä½†æ˜¯å’ŒMutexä¸€æ ·ï¼Œåœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šå¾ˆå®¹æ˜“è¸©åˆ°ä¸€äº›å‘ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ç»™ä½ é‡ç‚¹ä»‹ç»3ä¸ªå¸¸è§çš„è¸©å‘ç‚¹ã€‚</p><h1>RWMutexçš„3ä¸ªè¸©å‘ç‚¹</h1><h2>å‘ç‚¹1ï¼šä¸å¯å¤åˆ¶</h2><p>å‰é¢åˆšåˆšè¯´è¿‡ï¼ŒRWMutexæ˜¯ç”±ä¸€ä¸ªäº’æ–¥é”å’Œå››ä¸ªè¾…åŠ©å­—æ®µç»„æˆçš„ã€‚æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œäº’æ–¥é”æ˜¯ä¸å¯å¤åˆ¶çš„ï¼Œå†åŠ ä¸Šå››ä¸ªæœ‰çŠ¶æ€çš„å­—æ®µï¼ŒRWMutexå°±æ›´åŠ ä¸èƒ½å¤åˆ¶ä½¿ç”¨äº†ã€‚</p><p>ä¸èƒ½å¤åˆ¶çš„åŸå› å’Œäº’æ–¥é”ä¸€æ ·ã€‚ä¸€æ—¦è¯»å†™é”è¢«ä½¿ç”¨ï¼Œå®ƒçš„å­—æ®µå°±ä¼šè®°å½•å®ƒå½“å‰çš„ä¸€äº›çŠ¶æ€ã€‚è¿™ä¸ªæ—¶å€™ä½ å»å¤åˆ¶è¿™æŠŠé”ï¼Œå°±ä¼šæŠŠå®ƒçš„çŠ¶æ€ä¹Ÿç»™å¤åˆ¶è¿‡æ¥ã€‚ä½†æ˜¯ï¼ŒåŸæ¥çš„é”åœ¨é‡Šæ”¾çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šä¿®æ”¹ä½ å¤åˆ¶å‡ºæ¥çš„è¿™ä¸ªè¯»å†™é”ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤åˆ¶å‡ºæ¥çš„è¯»å†™é”çš„çŠ¶æ€ä¸å¯¹ï¼Œå¯èƒ½æ°¸è¿œæ— æ³•é‡Šæ”¾é”ã€‚</p><p>é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå…¶å®ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿå’Œäº’æ–¥é”ä¸€æ ·ã€‚ä½ å¯ä»¥å€ŸåŠ©vetå·¥å…·ï¼Œåœ¨å˜é‡èµ‹å€¼ã€å‡½æ•°ä¼ å‚ã€å‡½æ•°è¿”å›å€¼ã€éå†æ•°æ®ã€structåˆå§‹åŒ–ç­‰æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¯»å†™é”éšå¼å¤åˆ¶çš„æƒ…æ™¯ã€‚</p><h2>å‘ç‚¹2ï¼šé‡å…¥å¯¼è‡´æ­»é”</h2><p>è¯»å†™é”å› ä¸ºé‡å…¥ï¼ˆæˆ–é€’å½’è°ƒç”¨ï¼‰å¯¼è‡´æ­»é”çš„æƒ…å†µæ›´å¤šã€‚</p><p>æˆ‘å…ˆä»‹ç»ç¬¬ä¸€ç§æƒ…å†µã€‚å› ä¸ºè¯»å†™é”å†…éƒ¨åŸºäºäº’æ–¥é”å®ç°å¯¹writerçš„å¹¶å‘è®¿é—®ï¼Œè€Œäº’æ–¥é”æœ¬èº«æ˜¯æœ‰é‡å…¥é—®é¢˜çš„ï¼Œæ‰€ä»¥ï¼Œwriteré‡å…¥è°ƒç”¨Lockçš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°æ­»é”çš„ç°è±¡ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ äº’æ–¥é”çš„æ—¶å€™å·²ç»äº†è§£è¿‡äº†ã€‚</p><pre><code>func foo(l *sync.RWMutex) {\n    fmt.Println(&quot;in foo&quot;)\n    l.Lock()\n    bar(l)\n    l.Unlock()\n}\n\nfunc bar(l *sync.RWMutex) {\n    l.Lock()\n    fmt.Println(&quot;in bar&quot;)\n    l.Unlock()\n}\n\nfunc main() {\n    l := &amp;sync.RWMutex{}\n    foo(l)\n}\n</code></pre><p>è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œä½ å°±ä¼šå¾—åˆ°æ­»é”çš„é”™è¯¯è¾“å‡ºï¼Œåœ¨Goè¿è¡Œçš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ£€æµ‹å‡ºæ¥ã€‚</p><p>ç¬¬äºŒç§æ­»é”çš„åœºæ™¯æœ‰ç‚¹éšè”½ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œæœ‰æ´»è·ƒreaderçš„æ—¶å€™ï¼Œwriterä¼šç­‰å¾…ï¼Œå¦‚æœæˆ‘ä»¬åœ¨readerçš„è¯»æ“ä½œæ—¶è°ƒç”¨writerçš„å†™æ“ä½œï¼ˆå®ƒä¼šè°ƒç”¨Lockæ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªreaderå’Œwriterå°±ä¼šå½¢æˆäº’ç›¸ä¾èµ–çš„æ­»é”çŠ¶æ€ã€‚Readeræƒ³ç­‰å¾…writerå®Œæˆåå†é‡Šæ”¾é”ï¼Œè€Œwriteréœ€è¦è¿™ä¸ªreaderé‡Šæ”¾é”ä¹‹åï¼Œæ‰èƒ½ä¸é˜»å¡åœ°ç»§ç»­æ‰§è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªè¯»å†™é”å¸¸è§çš„æ­»é”åœºæ™¯ã€‚</p><p>ç¬¬ä¸‰ç§æ­»é”çš„åœºæ™¯æ›´åŠ éšè”½ã€‚</p><p>å½“ä¸€ä¸ªwriterè¯·æ±‚é”çš„æ—¶å€™ï¼Œå¦‚æœå·²ç»æœ‰ä¸€äº›æ´»è·ƒçš„readerï¼Œå®ƒä¼šç­‰å¾…è¿™äº›æ´»è·ƒçš„readerå®Œæˆï¼Œæ‰æœ‰å¯èƒ½è·å–åˆ°é”ï¼Œä½†æ˜¯ï¼Œå¦‚æœä¹‹åæ´»è·ƒçš„readerå†ä¾èµ–æ–°çš„readerçš„è¯ï¼Œè¿™äº›æ–°çš„readerå°±ä¼šç­‰å¾…writeré‡Šæ”¾é”ä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œè¿™å°±å½¢æˆäº†ä¸€ä¸ªç¯å½¢ä¾èµ–ï¼š <strong>writerä¾èµ–æ´»è·ƒçš„reader -&gt; æ´»è·ƒçš„readerä¾èµ–æ–°æ¥çš„reader -&gt; æ–°æ¥çš„readerä¾èµ–writer</strong>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c1/35/c18e897967d29e2d5273b88afe626035.jpg?wh=2089*1666\" alt=\"\"></p><p>è¿™ä¸ªæ­»é”ç›¸å½“éšè”½ï¼ŒåŸå› åœ¨äºå®ƒå’ŒRWMutexçš„è®¾è®¡å’Œå®ç°æœ‰å…³ã€‚å•¥æ„æ€å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªè®¡ç®—é˜¶ä¹˜(n!)çš„ä¾‹å­ï¼š</p><pre><code>func main() {\n    var mu sync.RWMutex\n\n    // writer,ç¨å¾®ç­‰å¾…ï¼Œç„¶ååˆ¶é€ ä¸€ä¸ªè°ƒç”¨Lockçš„åœºæ™¯\n    go func() {\n        time.Sleep(200 * time.Millisecond)\n        mu.Lock()\n        fmt.Println(&quot;Lock&quot;)\n        time.Sleep(100 * time.Millisecond)\n        mu.Unlock()\n        fmt.Println(&quot;Unlock&quot;)\n    }()\n\n    go func() {\n        factorial(&amp;mu, 10) // è®¡ç®—10çš„é˜¶ä¹˜, 10!\n    }()\n    \n    select {}\n}\n\n// é€’å½’è°ƒç”¨è®¡ç®—é˜¶ä¹˜\nfunc factorial(m *sync.RWMutex, n int) int {\n    if n &lt; 1 { // é˜¶ä¹˜é€€å‡ºæ¡ä»¶ \n        return 0\n    }\n    fmt.Println(&quot;RLock&quot;)\n    m.RLock()\n    defer func() {\n        fmt.Println(&quot;RUnlock&quot;)\n        m.RUnlock()\n    }()\n    time.Sleep(100 * time.Millisecond)\n    return factorial(m, n-1) * n // é€’å½’è°ƒç”¨\n}\n</code></pre><p>factoriaæ–¹æ³•æ˜¯ä¸€ä¸ªé€’å½’è®¡ç®—é˜¶ä¹˜çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥æ¨¡æ‹Ÿreaderã€‚ä¸ºäº†æ›´å®¹æ˜“åœ°åˆ¶é€ å‡ºæ­»é”åœºæ™¯ï¼Œæˆ‘åœ¨è¿™é‡ŒåŠ ä¸Šäº†sleepçš„è°ƒç”¨ï¼Œå»¶ç¼“é€»è¾‘çš„æ‰§è¡Œã€‚è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨è¯»é”ï¼ˆç¬¬27è¡Œï¼‰ï¼Œåœ¨ç¬¬33è¡Œé€’å½’åœ°è°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šäº§ç”Ÿä¸€æ¬¡è¯»é”çš„è°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥ä¸æ–­åœ°äº§ç”Ÿè¯»é”çš„è°ƒç”¨ï¼Œè€Œä¸”å¿…é¡»ç­‰åˆ°æ–°è¯·æ±‚çš„è¯»é”é‡Šæ”¾ï¼Œè¿™ä¸ªè¯»é”æ‰èƒ½é‡Šæ”¾ã€‚</p><p>åŒæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªgoroutineå»è°ƒç”¨Lockæ–¹æ³•ï¼Œæ¥å®ç°writerï¼Œè¿™ä¸ªwriterä¼šç­‰å¾…200æ¯«ç§’åæ‰ä¼šè°ƒç”¨Lockï¼Œè¿™æ ·åœ¨è°ƒç”¨Lockçš„æ—¶å€™ï¼Œfactoriaæ–¹æ³•è¿˜åœ¨æ‰§è¡Œä¸­ä¸æ–­è°ƒç”¨RLockã€‚</p><p>è¿™ä¸¤ä¸ªgoroutineäº’ç›¸æŒæœ‰é”å¹¶ç­‰å¾…ï¼Œè°ä¹Ÿä¸ä¼šé€€è®©ä¸€æ­¥ï¼Œæ»¡è¶³äº†â€œwriterä¾èµ–æ´»è·ƒçš„reader -&gt; æ´»è·ƒçš„readerä¾èµ–æ–°æ¥çš„reader -&gt; æ–°æ¥çš„readerä¾èµ–writerâ€çš„æ­»é”æ¡ä»¶ï¼Œæ‰€ä»¥å°±å¯¼è‡´äº†æ­»é”çš„äº§ç”Ÿã€‚</p><p>æ‰€ä»¥ï¼Œä½¿ç”¨è¯»å†™é”æœ€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯å°½é‡é¿å…é‡å…¥ï¼Œé‡å…¥å¸¦æ¥çš„æ­»é”éå¸¸éšè”½ï¼Œè€Œä¸”éš¾ä»¥è¯Šæ–­ã€‚</p><h2>å‘ç‚¹3ï¼šé‡Šæ”¾æœªåŠ é”çš„RWMutex</h2><p>å’Œäº’æ–¥é”ä¸€æ ·ï¼ŒLockå’ŒUnlockçš„è°ƒç”¨æ€»æ˜¯æˆå¯¹å‡ºç°çš„ï¼ŒRLockå’ŒRUnlockçš„è°ƒç”¨ä¹Ÿå¿…é¡»æˆå¯¹å‡ºç°ã€‚Lockå’ŒRLockå¤šä½™çš„è°ƒç”¨ä¼šå¯¼è‡´é”æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå¯èƒ½ä¼šå‡ºç°æ­»é”ï¼Œè€ŒUnlockå’ŒRUnlockå¤šä½™çš„è°ƒç”¨ä¼šå¯¼è‡´panicã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°panicæ˜¯å¤§å¿Œï¼Œä½ æ€»ä¸å¸Œæœ›åŠå¤œçˆ¬èµ·æ¥å¤„ç†ç”Ÿäº§ç¯å¢ƒç¨‹åºå´©æºƒçš„é—®é¢˜å§ï¼Ÿæ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨è¯»å†™é”çš„æ—¶å€™ï¼Œä¸€å®šè¦æ³¨æ„ï¼Œ<strong>ä¸é—æ¼ä¸å¤šä½™</strong>ã€‚</p><h1>æµè¡Œçš„Goå¼€å‘é¡¹ç›®ä¸­çš„å‘</h1><p>å¥½äº†ï¼Œåˆåˆ°äº†æ³¡ä¸€æ¯å®å¤æ¸æåŠ æ–°ç–†å¤§æ»©æ£çš„å…»ç”ŸèŒ¶ï¼Œé™é™åœ°æ¬£èµçŸ¥åé¡¹ç›®å‡ºç°Bugçš„æ—¶å€™äº†ï¼Œè¿™æ¬¡è¢«æ‹‰å‡ºæ¥çš„æ˜¯RWMutexçš„Bugã€‚</p><h2>Docker</h2><h3>issue 36840</h3><p><a href=\"https://github.com/moby/moby/pull/36840/files\">issue 36840</a>ä¿®å¤çš„æ˜¯é”™è¯¯åœ°æŠŠwriterå½“æˆreaderçš„Bugã€‚ è¿™ä¸ªåœ°æ–¹æœ¬æ¥éœ€è¦ä¿®æ”¹æ•°æ®ï¼Œéœ€è¦è°ƒç”¨çš„æ˜¯å†™é”ï¼Œç»“æœç”¨çš„å´æ˜¯è¯»é”ã€‚æˆ–è®¸æ˜¯è¢«å®ƒç´§æŒ¨ç€çš„findNodeæ–¹æ³•è°ƒç”¨è¿·æƒ‘äº†ï¼Œè®¤ä¸ºè¿™åªæ˜¯ä¸€ä¸ªè¯»æ“ä½œã€‚å¯å®é™…ä¸Šï¼Œä»£ç åé¢è¿˜ä¼šæœ‰changeNodeStateæ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå†™æ“ä½œã€‚ä¿®å¤åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æ”¹æˆLock/Unlockå³å¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e4/4b/e4d153cb5f81873a726b09bc436b8a4b.png?wh=1642*554\" alt=\"\"></p><h2>Kubernetes</h2><h3>issue 62464</h3><p><a href=\"https://github.com/kubernetes/kubernetes/pull/62464\">issue 62464</a>å°±æ˜¯è¯»å†™é”ç¬¬äºŒç§æ­»é”çš„åœºæ™¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„readerå¯¼è‡´çš„æ­»é”çš„ä¾‹å­ã€‚çŸ¥é“å¢¨è²å®šå¾‹å§ï¼Ÿâ€œå‡¡æ˜¯å¯èƒ½å‡ºé”™çš„äº‹ï¼Œå¿…å®šä¼šå‡ºé”™â€ã€‚ä½ å¯èƒ½è§‰å¾—æˆ‘å‰é¢è®²çš„RWMutexçš„å‘ç»å¯¹ä¸ä¼šè¢«äººè¸©çš„ï¼Œå› ä¸ºé“ç†å¤§å®¶éƒ½æ‡‚ï¼Œä½†æ˜¯ä½ çœ‹ï¼ŒKuberneteså°±è¸©äº†è¿™ä¸ªé‡å…¥çš„å‘ã€‚</p><p>è¿™ä¸ªissueåœ¨ç§»é™¤podçš„æ—¶å€™å¯èƒ½ä¼šå‘ç”Ÿï¼ŒåŸå› å°±åœ¨äºï¼ŒGetCPUSetOrDefaultæ–¹æ³•ä¼šè¯·æ±‚è¯»é”ï¼ŒåŒæ—¶ï¼Œå®ƒè¿˜ä¼šè°ƒç”¨GetCPUSetæˆ–GetDefaultCPUSetæ–¹æ³•ï¼Œè¿™æ—¶åˆä¼šè¯·æ±‚è¯»é”ã€‚å¦‚æœæœŸé—´æœ‰å…¶å®ƒgoroutineè¯·æ±‚å†™é”çš„è¯ï¼ŒGetCPUSetOrDefaultæ–¹æ³•è°ƒç”¨GetCPUSetæˆ–GetDefaultCPUSetæ–¹æ³•æ—¶å°±ä¸ä¼šè¿”å›äº†ï¼Œè¯·æ±‚å†™é”çš„goroutineä¹Ÿä¸ä¼šè¿”å›ï¼Œè¿™å°±ä¼šå½¢æˆæ­»é”ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/06/c2/062ae5d2a6190f86cb7bf57db643d8c2.png?wh=2126*986\" alt=\"\"></p><h1>æ€»ç»“</h1><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸€å¼€å§‹è€ƒè™‘å…±äº«èµ„æºå¹¶å‘è®¿é—®é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šæƒ³åˆ°äº’æ–¥é”Mutexã€‚å› ä¸ºåˆšå¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜å¹¶ä¸å¤ªäº†è§£å¹¶å‘çš„æƒ…å†µï¼Œæ‰€ä»¥ï¼Œå°±ä¼šä½¿ç”¨æœ€ç®€å•çš„åŒæ­¥åŸè¯­æ¥è§£å†³é—®é¢˜ã€‚ç­‰åˆ°ç³»ç»Ÿæˆç†Ÿï¼ŒçœŸæ­£åˆ°äº†éœ€è¦æ€§èƒ½ä¼˜åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±èƒ½é™ä¸‹å¿ƒæ¥åˆ†æå¹¶å‘åœºæ™¯çš„å¯èƒ½æ€§ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±è¦è€ƒè™‘å°†Mutexä¿®æ”¹ä¸ºRWMutexï¼Œæ¥å‹æ¦¨ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœä¸€å¼€å§‹ä½ çš„åœºæ™¯å°±éå¸¸æ˜ç¡®äº†ï¼Œæ¯”å¦‚æˆ‘å°±è¦å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„mapï¼Œé‚£ä¹ˆï¼Œä¸€å¼€å§‹ä½ å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨è¯»å†™é”ã€‚</p><p>æ­£å¦‚æˆ‘åœ¨å‰é¢æåˆ°çš„ï¼Œå¦‚æœä½ èƒ½æ„è¯†åˆ°ä½ è¦è§£å†³çš„é—®é¢˜æ˜¯ä¸€ä¸ªreaders-writersé—®é¢˜ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥æ¯«ä¸çŠ¹è±«åœ°é€‰æ‹©RWMutexï¼Œä¸ç”¨è€ƒè™‘å…¶å®ƒé€‰æ‹©ã€‚é‚£åœ¨ä½¿ç”¨RWMutexæ—¶ï¼Œæœ€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯å°½é‡é¿å…é‡å…¥ï¼Œé‡å…¥å¸¦æ¥çš„æ­»é”éå¸¸éšè”½ï¼Œè€Œä¸”éš¾ä»¥è¯Šæ–­ã€‚</p><p>å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰©å±•RWMutexï¼Œä¸è¿‡å®ç°æ–¹æ³•å’Œäº’æ–¥é”Mutexå·®ä¸å¤šï¼Œåœ¨æŠ€æœ¯ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡unsafeæ¥å®ç°ï¼Œæˆ‘å°±ä¸å†å…·ä½“è®²äº†ã€‚è¯¾ä¸‹ä½ å¯ä»¥å‚ç…§æˆ‘ä»¬<a href=\"https://time.geekbang.org/column/article/296793\">ä¸ŠèŠ‚è¯¾</a>å­¦ä¹ çš„æ–¹æ³•ï¼Œå®ç°ä¸€ä¸ªæ‰©å±•çš„RWMutexã€‚</p><p>è¿™ä¸€è®²æˆ‘ä»¬ç³»ç»Ÿå­¦ä¹ äº†è¯»å†™é”çš„ç›¸å…³çŸ¥è¯†ï¼Œè¿™é‡Œæä¾›ç»™ä½ ä¸€ä¸ªçŸ¥è¯†åœ°å›¾ï¼Œå¸®åŠ©ä½ å¤ä¹ æœ¬èŠ‚è¯¾çš„çŸ¥è¯†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/69/42/695b9aa6027b5d3a61e92cbcbba10042.jpg?wh=2250*2019\" alt=\"\"></p><h1>æ€è€ƒé¢˜</h1><p>è¯·ä½ å†™ä¸€ä¸ªæ‰©å±•çš„è¯»å†™é”ï¼Œæ¯”å¦‚æä¾›TryLockï¼ŒæŸ¥è¯¢å½“å‰æ˜¯å¦æœ‰writerã€readerçš„æ•°é‡ç­‰æ–¹æ³•ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","neighbors":{"left":{"article_title":"04ï½œ Mutexï¼šéª‡å®¢ç¼–ç¨‹ï¼Œå¦‚ä½•æ‹“å±•é¢å¤–åŠŸèƒ½ï¼Ÿ","id":296793},"right":{"article_title":"06 | WaitGroupï¼šååŒç­‰å¾…ï¼Œä»»åŠ¡ç¼–æ’åˆ©å™¨","id":298516}},"comments":[{"had_liked":false,"id":254999,"user_name":"Junes","can_delete":false,"product_type":"c1","uid":1354665,"ip_address":"","ucode":"CD2E829C868970","user_header":"https://static001.geekbang.org/account/avatar/00/14/ab/a9/590d6f02.jpg","comment_is_top":false,"comment_ctime":1603247834,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"130452266714","product_id":100061801,"comment_content":"äº¤ä¸€ä¸‹ä½œä¸šï¼Œæˆ‘å°±ä¸è´´å®Œæ•´ä»£ç äº†ï¼Œåˆ†äº«ä¸€ä¸‹æ ¸å¿ƒæ€è·¯ï¼š<br><br>è·å–ä¸¤ä¸ªå…³é”®å˜é‡ï¼Œå¤§è‡´æ€è·¯æ˜¯æ ¹æ® èµ·å§‹åœ°å€+åç§»é‡ï¼Œ<br>&#47;&#47; readerCount è¿™ä¸ªæˆå‘˜å˜é‡å‰æœ‰1ä¸ªmutex+2ä¸ªuint32<br>readerCount := atomic.LoadInt32((*int32)(unsafe.Pointer(uintptr(unsafe.Pointer(&amp;m)) + unsafe.Sizeof(sync.Mutex{}) + 2*unsafe.Sizeof(uint32(0)))))<br><br>&#47;&#47; readerWait è¿™ä¸ªæˆå‘˜å˜é‡å‰æœ‰1ä¸ªmutex+2ä¸ªuint32+1ä¸ªint32<br>readerWait := atomic.LoadInt32((*int32)(unsafe.Pointer(uintptr(unsafe.Pointer(&amp;m)) + unsafe.Sizeof(sync.Mutex{}) + 2*unsafe.Sizeof(uint32(0)) + unsafe.Sizeof(int32(0)))))<br><br>å‰©ä¸‹çš„ï¼Œå¤§é‡å€Ÿé‰´Mutexé‚£å—TryLockçš„å®ç°äº†ï¼Œå¤§é‡åœ°ä½¿ç”¨atomicåŸå­æ“ä½œï¼š<br><br>TryLock: è¯»å–readerCountï¼Œå°äº0åˆ™è¿”å›falseï¼Œå¦åˆ™å°è¯•Lock<br>æ˜¯å¦æœ‰writerï¼šè¯»å–readerCountï¼Œå°äº0åˆ™æœ‰writerï¼Œå¦åˆ™æ²¡æœ‰ã€‚<br>readerçš„æ•°é‡ï¼šè¯»å–readerCountï¼Œå°äº0åˆ™åŠ ä¸ŠrwmutexMaxReadersï¼Œç»“æœå³ä¸ºreaderæ•°é‡ã€‚<br><br>å¦å¤–è¿˜å¯ä»¥é€šè¿‡readerWaitï¼ŒæŸ¥è¯¢å½“å‰Lockè¢«å¤šå°‘ä¸ªRLocké˜»å¡ç€ã€‚<br><br>å†è°ˆä¸€ä¸ªæ„Ÿå—ï¼ŒRWMutexçš„å®ç°ä¾èµ–äºMutexï¼Œè¿™æœ€å¤§çš„å¥½å¤„æ˜¯ç®€åŒ–äº†ä»£ç ï¼Œä½†åŒæ—¶ï¼Œåœ¨è¯»å°‘å†™å¤šçš„æƒ…å†µä¸‹ï¼Œç”±äºé¢å¤–ç»´æŠ¤äº†4ä¸ªå˜é‡ï¼Œæ€§èƒ½ä¸å¦‚ç›´æ¥è°ƒç”¨Mutexã€‚è¿™ä¸ªè¯»å†™æ¯”ä¾‹çš„ä¸´ç•Œå€¼ï¼Œæ‰¾ä¸ªæ—¶é—´è‡ªå·±æµ‹è¯•æµ‹è¯•ã€‚ :)","like_count":31,"discussions":[{"author":{"id":2197943,"avatar":"","nickname":"ä»£ç çœ‹ä¸æ‡‚ç¯®çƒæ‰“ä¸å¥½","note":"","ucode":"7C5D1D36207F41","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339995,"discussion_content":" è€å“¥æˆ‘é‡æ–°è®¤çœŸçœ‹äº†ä¸‹ï¼Œä½ è¿™ä¸ªè€ƒè™‘å†…å­˜å¯¹é½äº†å—ï¼Œæˆ‘æ€ä¹ˆæ„Ÿè§‰å¦‚æœä¸è€ƒè™‘å†…å­˜å¯¹é½æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯è€ƒè™‘çš„è¯ï¼Œè¿™ä¸ªåç§»é‡ä¸ä¸€å®šå°±æ˜¯sizeçš„å¤§å°","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1609857326,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1140986,"avatar":"https://static001.geekbang.org/account/avatar/00/11/68/fa/446da332.jpg","nickname":"ä¼¼æ°´æµå¹´","note":"","ucode":"B9A035B0CDA7E8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2197943,"avatar":"","nickname":"ä»£ç çœ‹ä¸æ‡‚ç¯®çƒæ‰“ä¸å¥½","note":"","ucode":"7C5D1D36207F41","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367744,"discussion_content":"è¿™ä¸ªç¡®å®æœ‰é—®é¢˜ï¼Œunsafe.Sizeof æ”¹ä¸º unsafe.Alignof å³å¯","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1618457534,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":339995,"ip_address":""},"score":367744,"extra":""}]}]},{"had_liked":false,"id":259215,"user_name":"ç«¯è´º","can_delete":false,"product_type":"c1","uid":1121588,"ip_address":"","ucode":"80F1400B138055","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/34/8201baab.jpg","comment_is_top":false,"comment_ctime":1604654637,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"113273804333","product_id":100061801,"comment_content":"ç®€å•æ¢³ç†é¢è¯•é¢˜:<br>    1. è¯»å†™é”ç”¨è¿‡å—ï¼Œè¯»å†™é”ç”¨åœ¨ä»€ä¹ˆæ ·çš„åœºæ™¯ï¼Ÿï¼ˆæˆ–è¯»å†™é”ä¸»è¦ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œè¯´è¯´å¯¹è¯»å†™é”çš„ç†è§£ï¼Ÿï¼‰<br>    2.è¯´è¯´RWMutexçš„å®ç°åŸç†ï¼Ÿè¯´è¯´RWMutexä¸Mutexçš„åŒºåˆ«ï¼Ÿ<br>    3.RWMutexæºç çœ‹è¿‡å—ï¼Ÿå¦‚æœä½¿ç”¨Mutexæ¥è®¾è®¡ä¸€ä¸ªRWMutexä½ æœ‰ä»€ä¹ˆæ€è·¯ï¼Ÿ<br>    4.åœ¨æ‰§è¡ŒLockï¼ŒUnlockï¼ŒRlockï¼ŒRUnlockæ—¶éœ€è¦è€ƒè™‘ä»€ä¹ˆé—®é¢˜ï¼Ÿ<br>    5.ä½¿ç”¨è¯»å†™é”æ—¶å¦‚ä½•è§„é¿æ­»é”é—®é¢˜ï¼Ÿ<br>    6.å¦‚ä½•ç›‘æ§è¯»å†™é”çš„ç­‰å¾…æƒ…å†µï¼Ÿä½ æœ‰ä»€ä¹ˆæ€è·¯ï¼Ÿ","like_count":27,"discussions":[{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"å´å°æ™º","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382538,"discussion_content":"çœ‹æ–‡ç« ï¼Œç„¶åæ¢³ç†é¢è¯•é¢˜ï¼Œä¹Ÿæ˜¯æ€»ç»“æ–‡ç« è¦ç‚¹çš„å¥½æ–¹æ³•å‘€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625626795,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265806,"user_name":"DigDeeply","can_delete":false,"product_type":"c1","uid":1239008,"ip_address":"","ucode":"113F4D755A1FEC","user_header":"https://static001.geekbang.org/account/avatar/00/12/e7/e0/33521e13.jpg","comment_is_top":false,"comment_ctime":1607041153,"is_pvip":false,"replies":[{"id":"96622","content":"è¿™æ˜¯å¯¹ä½œè€…å¾ˆé«˜çš„è¤’å¥–ï¼Œè°¢è°¢ã€‚æ­¤ç•™è¨€åº”è¯¥ç½®é¡¶å•Š","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1607069401,"ip_address":"","comment_id":265806,"utype":1}],"discussion_count":1,"race_medal":0,"score":"87506387073","product_id":100061801,"comment_content":"è¿™é—¨è¯¾çš„è´¨é‡çœŸé«˜å•Šï¼Œçœ‹çš„é…£ç•…æ·‹æ¼“ğŸ‘","like_count":21,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511053,"discussion_content":"è¿™æ˜¯å¯¹ä½œè€…å¾ˆé«˜çš„è¤’å¥–ï¼Œè°¢è°¢ã€‚æ­¤ç•™è¨€åº”è¯¥ç½®é¡¶å•Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607069401,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255642,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1603385568,"is_pvip":false,"replies":[{"id":"93153","content":"ç°åœ¨ç‰ˆæœ¬çš„goè¿è¡Œæ—¶è¿‡äºæ™ºèƒ½äº†ï¼Œä¼šæŠŠè¿™ä¸ªåœºæ™¯â€œè¯¯æŠ¥â€æˆæ­»é”ï¼Œå…¶å®æˆ‘ä»¬çš„æœ¬æ„æ˜¯è®©ç¨‹åºhangåœ¨è¿™é‡Œã€‚<br>å¯ä»¥æ”¹æˆsleepï¼Œwaitgroupæˆ–è€…ä»å‘½ä»¤è¡Œè¯»å–æ•°æ®ç­‰çš„æ–¹å¼é˜»å¡ä¸»goroutine","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603413935,"ip_address":"","comment_id":255642,"utype":1}],"discussion_count":1,"race_medal":1,"score":"35963123936","product_id":100061801,"comment_content":"è¯·é—®è€å¸ˆä¸€ä¸ªå…³äºselect{}é—®é¢˜ï¼Œ<br><br>func foo() {<br>\tfmt.Println(&quot;in foo&quot;)<br>}<br><br>func goo() {<br>\tvar i int<br>\tfmt.Println(&quot;in goo&quot;, i)<br>}<br><br>func main() {<br>\tgo goo()<br>\tgo foo()<br>\tselect {}<br>}<br><br>è¿™ä¸ªä»£ç ä¼šæŠ¥all goroutines are asleep - deadlockï¼Œæ˜¯ä¸æ˜¯select{}è¿™ç§å†™æ³•ä¸æ¨èä¹ˆï¼Ÿ<br><br>","like_count":8,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507778,"discussion_content":"ç°åœ¨ç‰ˆæœ¬çš„goè¿è¡Œæ—¶è¿‡äºæ™ºèƒ½äº†ï¼Œä¼šæŠŠè¿™ä¸ªåœºæ™¯â€œè¯¯æŠ¥â€æˆæ­»é”ï¼Œå…¶å®æˆ‘ä»¬çš„æœ¬æ„æ˜¯è®©ç¨‹åºhangåœ¨è¿™é‡Œã€‚\nå¯ä»¥æ”¹æˆsleepï¼Œwaitgroupæˆ–è€…ä»å‘½ä»¤è¡Œè¯»å–æ•°æ®ç­‰çš„æ–¹å¼é˜»å¡ä¸»goroutine","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603413935,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":274065,"user_name":"Varphp","can_delete":false,"product_type":"c1","uid":1590892,"ip_address":"","ucode":"889550391E3F75","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTImmLJCKerl9CI4sTpPDNCUgswp04ybsJ4J6mpJmMlHh43Iibp1RPOLam5PpOv2ZDGcjvGrY94lNRw/132","comment_is_top":false,"comment_ctime":1610808094,"is_pvip":false,"replies":[{"id":"99564","content":"ç¬¬ä¸€ä¸ªé—®é¢˜ å¯¹ã€‚ç¬¬äºŒä¸ªé—®é¢˜å¤ªè¿‡ç¬¼ç»Ÿæ‰€ä»¥æ²¡æ³•å›ç­”ï¼Œå½“ç„¶æ–‡ç« ä¸­å·²ç»ä»‹ç»è¯»å†™é”çš„åŠŸèƒ½ï¼Œé€‚åˆå†™å°‘è¯»å¤šçš„åœºæ™¯","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1610947449,"ip_address":"","comment_id":274065,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5905775390","product_id":100061801,"comment_content":"åŸè°…æˆ‘çš„å°ç™½ è¯·æ•™ä¸ªé—®é¢˜<br><br>RWMutexæ˜¯è¯»å†™é”ï¼ŒMutexå°±æ˜¯é”å—ï¼ŸåŒºåˆ«åœ¨äºä¸€ä¸ªç²¾ç¡®åˆ°è¯»å†™ ä¸€ä¸ªåªèƒ½ç²¾ç¡®åˆ°åç¨‹å¯¹å—","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513905,"discussion_content":"ç¬¬ä¸€ä¸ªé—®é¢˜ å¯¹ã€‚ç¬¬äºŒä¸ªé—®é¢˜å¤ªè¿‡ç¬¼ç»Ÿæ‰€ä»¥æ²¡æ³•å›ç­”ï¼Œå½“ç„¶æ–‡ç« ä¸­å·²ç»ä»‹ç»è¯»å†™é”çš„åŠŸèƒ½ï¼Œé€‚åˆå†™å°‘è¯»å¤šçš„åœºæ™¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610947449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":271668,"user_name":"David","can_delete":false,"product_type":"c1","uid":1136236,"ip_address":"","ucode":"8277D3CE881053","user_header":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","comment_is_top":false,"comment_ctime":1609751979,"is_pvip":false,"replies":[{"id":"98549","content":"åœ¨readerså·²å æœ‰é”çš„æƒ…å†µä¸‹ï¼Œåç»­åªè¦æœ‰writerå­˜åœ¨ï¼Œä¼šä¼˜å…ˆwriteræ‰§è¡Œé”ï¼Œåç»­çš„readeréœ€è¦writeré‡Šæ”¾é”æ‰å¯ä»¥è·å–","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1609804780,"ip_address":"","comment_id":271668,"utype":1}],"discussion_count":4,"race_medal":0,"score":"5904719275","product_id":100061801,"comment_content":"func (rw *RWMutex) RLock() {<br>    if atomic.AddInt32(&amp;rw.readerCount, 1) &lt; 0 {<br>            &#47;&#47; rw.readerCountæ˜¯è´Ÿå€¼çš„æ—¶å€™ï¼Œæ„å‘³ç€æ­¤æ—¶æœ‰writerç­‰å¾…è¯·æ±‚é”ï¼Œå› ä¸ºwriterä¼˜å…ˆçº§é«˜ï¼Œæ‰€ä»¥æŠŠåæ¥çš„readeré˜»å¡ä¼‘çœ <br>        runtime_SemacquireMutex(&amp;rw.readerSem, false, 0)<br>    }<br>}<br>è¿™ä¸ªä»£ç ï¼Œ rw.readerCount ä¸ºè´Ÿæ•°ï¼Œè¡¨ç¤ºæœ‰writerï¼Œæ­£åœ¨ç­‰å¾…ï¼Œåˆ™readerè¦è¿›è¡Œä¼‘çœ ã€‚<br><br><br>func (rw *RWMutex) Lock() {<br>    &#47;&#47; é¦–å…ˆè§£å†³å…¶ä»–writerç«äº‰é—®é¢˜<br>    rw.w.Lock()<br>    &#47;&#47; åè½¬readerCountï¼Œå‘Šè¯‰readeræœ‰writerç«äº‰é”<br>    r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders<br>    &#47;&#47; å¦‚æœå½“å‰æœ‰readeræŒæœ‰é”ï¼Œé‚£ä¹ˆéœ€è¦ç­‰å¾…<br>    if r != 0 &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != 0 {<br>        runtime_SemacquireMutex(&amp;rw.writerSem, false, 0)<br>    }<br>}<br>è¿™é‡Œæ˜¯å…ˆè·å–åˆ°äº†é”ï¼Œæ‰å»ä¿®æ”¹ rw.readerCount çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ æ¯ä¸ªwriter åªæœ‰åœ¨è·å–åˆ°é”çš„æƒ…å†µä¸‹ï¼Œæ‰å»æŠŠ rw.readerCountæ”¹æˆè´Ÿæ•°ï¼Œè€Œè¯»é”æ˜¯å¦ä¼‘çœ ï¼Œä¹Ÿæ˜¯æ ¹æ®è¿™ä¸ªå€¼æ¥åˆ¤æ–­ã€‚<br><br><br>func (rw *RWMutex) Unlock() {<br>    &#47;&#47; å‘Šè¯‰readeræ²¡æœ‰æ´»è·ƒçš„writeräº†<br>    r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)<br>    <br>    &#47;&#47; å”¤é†’é˜»å¡çš„readerä»¬<br>    for i := 0; i &lt; int(r); i++ {<br>        runtime_Semrelease(&amp;rw.readerSem, false, 0)<br>    }<br>    &#47;&#47; é‡Šæ”¾å†…éƒ¨çš„äº’æ–¥é”<br>    rw.w.Unlock()<br>}<br><br>è€Œè¿™ä¸ªåœ°æ–¹ å…ˆå»é‡Šæ”¾äº† readerï¼Œå†å»é‡Šæ”¾é˜»å¡çš„writer<br><br>å‡è®¾ä¸€ç§æƒ…å†µï¼Œåœ¨lockçš„æ—¶å€™ï¼Œå…ˆåæœ‰a,bä¸¤ä¸ªwriter è¿›æ¥ï¼Œå‘ç°è¿˜æœ‰å…¶ä»–çš„readeræ­£åœ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆaï¼Œbè¿›è¡Œé˜»å¡ï¼Œå½“reader ä½¿ç”¨å®Œäº†åï¼Œå”¤é†’äº†aï¼Œaè·å–åˆ°äº†é”ï¼Œåœ¨aä½¿ç”¨æœŸé—´ï¼Œä¹Ÿæœ‰å¤šä¸ªreader è¿›æ¥ï¼Œè¿›è¡Œçš„ä¼‘çœ ã€‚å½“aä½¿ç”¨å®Œæˆåï¼Œè°ƒç”¨unlockæ–¹æ³•ï¼Œå…ˆæ˜¯ä¿®æ”¹äº†rw.readerCountï¼ˆæ ¹æ®rlockçš„æ–¹æ³•ï¼Œrw.readerCountæ˜¯å”¯ä¸€åˆ¤æ–­ï¼Œæ˜¯å¦é˜»å¡çš„æ¡ä»¶ï¼Œé‚£ä¹ˆï¼Œå½“è¿™ä¸ªæ—¶å€™ï¼Œæœ‰æ–°çš„readerè¿›æ¥ï¼Œå°±å¯ä»¥æ— æ¡ä»¶ä½¿ç”¨äº†ï¼‰ï¼›å†å»å”¤é†’è¢«é˜»å¡çš„readerï¼ˆè¿™ä¸ªæƒ…å†µä¸‹ï¼Œå”¤é†’çš„reader ä¹Ÿå¯ä»¥è¿›è¡Œæ— æ¡ä»¶ä½¿ç”¨äº†ï¼‰ï¼Œæœ€åå»é‡Šæ”¾é”ï¼Œå”¤é†’äº†bï¼Œbå»è·å–é”çš„æ—¶å€™ï¼Œå‘ç°æœ‰readeråœ¨ä½¿ç”¨ï¼Œä¿®æ”¹rw.readerCountçš„å€¼ï¼ˆæ ‡ç¤ºæœ‰ç­‰å¾…çš„writerï¼‰ï¼Œç„¶åè¿›è¡Œä¼‘çœ ï¼Œå½“æœ€åä¸€ä¸ªreaderä½¿ç”¨å®Œæˆåï¼Œå”¤é†’bï¼Œè¿™ä¸ªæ—¶å€™bæ‰æ­£åœ¨è·å–åˆ°äº†é”ã€‚<br><br>æŒ‰ç…§ä»¥ä¸Šé€»è¾‘ï¼Œå¤šä¸ªwriterçš„æƒ…å†µä¸‹ï¼Œå¹¶æ²¡æœ‰é€ æˆreaderå‡ºç°é¥¥é¥¿çŠ¶æ€ï¼Œåè€Œåœ¨é‡Šæ”¾å†™é”çš„é‚£ä¸€åˆ¹é‚£ï¼Œæ–°çš„reader å äº†å…ˆæœºï¼Œè¿™ç§æƒ…å†µæ€ä¹ˆå« Write-preferring æ–¹æ¡ˆã€‚æˆ‘ç†è§£çš„Write-preferring æ–¹æ¡ˆï¼šæ˜¯åªæœ‰åœ¨æ²¡æœ‰writerçš„æƒ…å†µä¸‹ï¼Œæ‰è½®åˆ°readeræ‰§è¡Œï¼Œå¤šä¸ªwriterçš„æƒ…å†µï¼Œæ˜¯ä¸€ä¸ªwriterä¸€ä¸ªwriteræ‰§è¡Œå®Œï¼Œæ‰ä¼šæ‰§è¡Œreaderã€‚æˆ‘ä»ä»£ç ä¸­çœ‹å‡ºäº†ä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¸Œæœ›è€å¸ˆ å¸®å¿™è§£ç­”ä¸€ä¸‹","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512999,"discussion_content":"åœ¨readerså·²å æœ‰é”çš„æƒ…å†µä¸‹ï¼Œåç»­åªè¦æœ‰writerå­˜åœ¨ï¼Œä¼šä¼˜å…ˆwriteræ‰§è¡Œé”ï¼Œåç»­çš„readeréœ€è¦writeré‡Šæ”¾é”æ‰å¯ä»¥è·å–","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609804780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1058856,"avatar":"https://static001.geekbang.org/account/avatar/00/10/28/28/5ffdd123.jpg","nickname":"æ¼«æ¸¸è€…","note":"","ucode":"7402D9068413D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373522,"discussion_content":"çœ‹äº†ä¸¤éï¼Œç†è§£çš„ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ²¡çœ‹æ‡‚è€å¸ˆè¯„è®ºçš„ç”±æ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620775753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136236,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","nickname":"David","note":"","ucode":"8277D3CE881053","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339802,"discussion_content":"ä»ä»£ç ä¸­ï¼Œåªèƒ½çœ‹å‡ºæ´»è·ƒçš„writer ä¼˜å…ˆçº§é«˜ï¼Œä½†æ˜¯å¯¹äºå·²ç»é˜»å¡ç­‰å¾…çš„writer å¹¶æ²¡ä»€ä¹ˆä¼˜åŠ¿ï¼Œå¯èƒ½æ¯”åæ¥çš„reader è¿˜è¦æ™šæ‰§è¡Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609809725,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136236,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","nickname":"David","note":"","ucode":"8277D3CE881053","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339800,"discussion_content":"è€å¸ˆï¼Œå¯¹äºé‚£ç§æœ¬èº«å°±å·²ç»æœ‰å¤šä¸ªwriteré˜»å¡ç­‰å¾…çš„æƒ…å†µä¸‹ï¼Œåœ¨Unlockä¸­å…ˆä¿®æ”¹readerCountçš„å€¼ï¼Œå”¤é†’readerï¼Œå†å»å”¤é†’writerï¼Œè€Œä¸”ä¸æ˜¯handoffç§»äº¤ï¼Œé‚£ä¹ˆæ€ä¹ˆæ¥ç¡®ä¿ï¼Œé˜»å¡çš„writer æŠ¢å¾—è¿‡æ´»è·ƒçš„readerï¼Œå¦‚æœæŠ¢ä¸è¿‡ï¼Œåˆä¼šç»§ç»­ç¡çœ ï¼Œç­‰åˆ°å·²å æœ‰é”çš„readeræ‰§è¡Œå®Œï¼Œæ‰èƒ½è¿›è¡Œæ‰§è¡Œã€‚æˆ‘ä»ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹å‡ºwriteræœ‰ä¸€å®šçš„ä¼˜å…ˆçº§ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™ä¸ç®—çº¯ç²¹çš„Write-preferring ã€‚mysqlçš„å†™ä¼˜å…ˆï¼Œå°±ä¼šåœ¨å†™å¤šè¯»å°‘çš„æƒ…å†µä¸‹ï¼Œé€ æˆè¯»é¥¥é¥¿ï¼Œè€Œgoè¿™ä¸ªï¼Œä¸ä¼šï¼Œè¿™è¿˜å«Write-preferring å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609809603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259374,"user_name":"50%","can_delete":false,"product_type":"c1","uid":1674992,"ip_address":"","ucode":"3E4247B5844B5B","user_header":"https://static001.geekbang.org/account/avatar/00/19/8e/f0/18720510.jpg","comment_is_top":false,"comment_ctime":1604715177,"is_pvip":false,"replies":[{"id":"94317","content":"å¯¹","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1604735978,"ip_address":"","comment_id":259374,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5899682473","product_id":100061801,"comment_content":"r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders<br>è¿™å¥è€å¸ˆçœ‹æˆ‘ç†è§£çš„å¯¹ä¹ˆã€‚é¦–å…ˆå‰ä¸€æ­¥åè½¬æ“ä½œæ˜¯ç”¨åŸå­æ“ä½œå®ç°çš„ï¼Œæ­¤æ—¶å…¶ä»–çš„readerå¯èƒ½ä¼šæ”¹å˜readerCountå­—æ®µçš„çŠ¶æ€ã€‚è™½ç„¶çœ‹èµ·æ¥åŠ å‡åŒä¸€ä¸ªrwmutexMaxReadersçœ‹ä¼¼ç»“æœç›¸ç­‰ï¼Œä½†åœ¨å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå…¶ä»–readerè¯»åˆ°çš„readerCountçš„çŠ¶æ€ä¸ºè´Ÿå€¼ï¼Œè¡¨ç¤ºæœ‰å†™é”çš„æƒ…å†µå­˜åœ¨ã€‚","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508919,"discussion_content":"å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604735978,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255665,"user_name":"Gopher","can_delete":false,"product_type":"c1","uid":1206229,"ip_address":"","ucode":"3C1F9012BB486D","user_header":"https://static001.geekbang.org/account/avatar/00/12/67/d5/1b26b725.jpg","comment_is_top":false,"comment_ctime":1603409046,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5898376342","product_id":100061801,"comment_content":"ä½œä¸šæ€è·¯<br>å’Œmutexçš„æ‰©å±•æ€è·¯ä¸€æ ·ï¼Œé€šè¿‡unsafeè·å–æŒ‡é’ˆï¼Œåœ¨è¿›è¡Œåç§»è·å–åˆ°readeræ•°é‡ï¼Œä¸ç­‰äº0ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°è¯•lock","like_count":1},{"had_liked":false,"id":255194,"user_name":"Panda","can_delete":false,"product_type":"c1","uid":1095740,"ip_address":"","ucode":"911A200C7B18BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/b8/3c/1a294619.jpg","comment_is_top":false,"comment_ctime":1603278816,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5898246112","product_id":100061801,"comment_content":"RWMutex æ˜¯ Mutex çš„å¢å¼ºç‰ˆæœ¬  ä¹Ÿæ˜¯åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³ä½“ç°","like_count":1},{"had_liked":false,"id":254995,"user_name":"Ethan Liu","can_delete":false,"product_type":"c1","uid":1070043,"ip_address":"","ucode":"231F944F7CD56A","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg","comment_is_top":false,"comment_ctime":1603246792,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5898214088","product_id":100061801,"comment_content":"åŒºåˆ†readerå’Œwriterçš„åœºæ™¯ï¼Œå¯ä¸å¯ä»¥ç”¨channelæ¥å®ç°ï¼Ÿå¦‚æœå¯ä»¥çš„è¯ï¼Œä¸ä½¿ç”¨RWMutexæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ","like_count":1},{"had_liked":false,"id":342610,"user_name":"æå®¢é…±é…±","can_delete":false,"product_type":"c1","uid":2934665,"ip_address":"","ucode":"18CDC1DB754D58","user_header":"https://static001.geekbang.org/account/avatar/00/2c/c7/89/16437396.jpg","comment_is_top":false,"comment_ctime":1650363469,"is_pvip":true,"replies":[{"id":"125222","content":"processon","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1650469750,"ip_address":"","comment_id":342610,"utype":1}],"discussion_count":1,"race_medal":2,"score":"1650363469","product_id":100061801,"comment_content":"é¸Ÿçªè€å¸ˆï¼Œéº»çƒ¦é—®ä¸€ä¸‹æ‚¨è¿™è¾¹ä½¿ç”¨çš„è„‘å›¾å·¥å…·æ˜¯å“ªä¸ªï¼Œæˆ‘æ­£åœ¨å­¦ä¹ è¿™ç§ç”¨è„‘å›¾æ¢³ç†çŸ¥è¯†ç‚¹çš„æ–¹æ³•ï¼Œæ‰‹å¤´çš„å·¥å…·ä¸å¤ªå‹å¥½ï¼Œæ‰‹åŠ¨ç‹—å¤´ã€‚","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565507,"discussion_content":"processon","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650469750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":338269,"user_name":"50%","can_delete":false,"product_type":"c1","uid":1674992,"ip_address":"","ucode":"3E4247B5844B5B","user_header":"https://static001.geekbang.org/account/avatar/00/19/8e/f0/18720510.jpg","comment_is_top":false,"comment_ctime":1647400369,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647400369","product_id":100061801,"comment_content":"r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders<br><br>å†çœ‹ä¸€éåˆæœ‰æ–°çš„ç†è§£å‘€ã€‚è¿™å¥è¯å®é™…ä¸Šä»…æœ‰å‰åŠéƒ¨åˆ†ä¿è¯äº†å¯¹readerCounterçš„åŸå­æ€§æ“ä½œã€‚é‚£ä¹ˆåœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼ŒæŒæœ‰è¯»é”çš„goroutineå°±è¢«é˜»å¡ã€‚","like_count":0},{"had_liked":false,"id":323552,"user_name":"8.13.3.27.30","can_delete":false,"product_type":"c1","uid":1556358,"ip_address":"","ucode":"2DE3CE3E338BAB","user_header":"https://static001.geekbang.org/account/avatar/00/17/bf/86/c0cb35f0.jpg","comment_is_top":false,"comment_ctime":1637985564,"is_pvip":false,"replies":[{"id":"118194","content":"å¾ˆå¥½çš„å‘ç°ï¼Œä½ è¯´çš„å¯¹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1639209881,"ip_address":"","comment_id":323552,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1637985564","product_id":100061801,"comment_content":"æœ‰ä¸€ä¸ªé—®é¢˜ã€å†™é”™unlocké€»è¾‘ä¸­ã€è§£é”ä¹‹å‰ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…è¯»çš„é”ã€ä½†æ˜¯å†é”çš„è¿‡ç¨‹å½“ä¸­å¹¶å¯èƒ½ä¼šç»§ç»­æ¥è¯»å’Œå†™çš„æ“ä½œã€è¿™äº›æ“ä½œè¿™é‡Œè²Œä¼¼å¹¶ä¸èƒ½ä¿è¯å†™é”çš„ä¼˜å…ˆï¼Œå› ä¸ºå†™é”è§£é”çš„è¿‡ç¨‹ä¼šæŠŠåæ¥çš„è¯»é”ä¹Ÿå”¤é†’ã€è€Œè¿™ä¸ªæ—¶å€™åæ¥çš„å†™é”ï¼ˆä½†æ˜¯å®ƒå…ˆäºåæ¥çš„è¯»é”æ“ä½œé”ï¼‰æ²¡æœ‰åŠæ³•ä¼˜å…ˆåæ¥çš„è¯»é”è·å–åˆ°é”ï¼Œä¸çŸ¥é“ç†è§£æ˜¯å¦æ­£ç¡®ï¼Œå¦å¤–è¯»å†™é”çš„å®ç°çœ‹ä¸Šå»åœ¨æé™æƒ…å†µä¸‹ä¼šå¯¼è‡´å†™é¥¥é¥¿ã€å½“ç„¶ä¹Ÿå¯èƒ½æ˜¯è¯»é¥¥é¥¿ï¼ˆç†è®ºä¸Šè¿™ç§æƒ…å†µä¸åº”è¯¥ä½¿ç”¨è¯»å†™é”ï¼‰ã€è¯·æ•™è€å¸ˆæˆ‘çš„ç†è§£æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœæ­£ç¡®æ€ä¹ˆè§£å†³å†™é¥¥é¥¿çš„é—®é¢˜","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":537824,"discussion_content":"å¾ˆå¥½çš„å‘ç°ï¼Œä½ è¯´çš„å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639209882,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305904,"user_name":"ğŸ­","can_delete":false,"product_type":"c1","uid":2384580,"ip_address":"","ucode":"E5CA01ACAEDFC1","user_header":"https://static001.geekbang.org/account/avatar/00/24/62/c4/be92518b.jpg","comment_is_top":false,"comment_ctime":1628226375,"is_pvip":false,"replies":[{"id":"110978","content":" å—¯ï¼Œè¿™ä¸ªä¾‹å­ä¸å¤ªå¥½ï¼Œåº”è¯¥ç”¨ä¸¤ä¸ªwriteræ›´å¥½ç†è§£","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1628604139,"ip_address":"","comment_id":305904,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1628226375","product_id":100061801,"comment_content":"ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œå†™æ“ä½œåœ¨ä¸»æºç¨‹é‡Œï¼Œä¸ºä»€ä¹ˆè¿˜è¦åŠ é”","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524555,"discussion_content":" å—¯ï¼Œè¿™ä¸ªä¾‹å­ä¸å¤ªå¥½ï¼Œåº”è¯¥ç”¨ä¸¤ä¸ªwriteræ›´å¥½ç†è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628604139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304631,"user_name":"GoGoGo","can_delete":false,"product_type":"c1","uid":1622305,"ip_address":"","ucode":"8004C39DD29BA9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIk8csm2UvibqAOdiaZ9fZ4tBI727gpdnwVSmH9dfkY9dSBpPQbibTBc2mm4ONdQj1lYWyZxKTZyFxpQ/132","comment_is_top":false,"comment_ctime":1627526726,"is_pvip":false,"replies":[{"id":"110317","content":"ç¡®ä¿happenbeforeå…³ç³»ï¼Œè¯»çš„æ—¶å€™èƒ½çŸ¥é“æ‰€ä»¥å‘ç”Ÿåœ¨å®ƒä¹‹å‰çš„å†™","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1627730489,"ip_address":"","comment_id":304631,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1627526726","product_id":100061801,"comment_content":"<br>func main() {<br>    var counter Counter<br>    for i := 0; i &lt; 10; i++ { &#47;&#47; 10ä¸ªreader<br>        go func() {<br>            for {<br>                counter.Count() &#47;&#47; è®¡æ•°å™¨è¯»æ“ä½œ<br>                time.Sleep(time.Millisecond)<br>            }<br>        }()<br>    }<br><br>    for { &#47;&#47; ä¸€ä¸ªwriter<br>        counter.Incr() &#47;&#47; è®¡æ•°å™¨å†™æ“ä½œ<br>        time.Sleep(time.Second)<br>    }<br>}<br>&#47;&#47; ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨<br>type Counter struct {<br>    mu    sync.RWMutex<br>    count uint64<br>}<br><br>&#47;&#47; ä½¿ç”¨å†™é”ä¿æŠ¤<br>func (c *Counter) Incr() {<br>    c.mu.Lock()<br>    c.count++<br>    c.mu.Unlock()<br>}<br><br>&#47;&#47; ä½¿ç”¨è¯»é”ä¿æŠ¤<br>func (c *Counter) Count() uint64 {<br>    c.mu.RLock()<br>    defer c.mu.RUnlock()<br>    return c.count<br>}<br><br>å½“èƒ½æ˜ç¡®çš„åŒºåˆ† è¯»å†™æ“ä½œæ—¶  ä¸ºä»€ä¹ˆè¯»è¿˜è¦åŠ é” è¿™æ®µä»£ç é‡Œ åŠ è¯»é”å’Œä¸åŠ è¯»é”æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524106,"discussion_content":"ç¡®ä¿happenbeforeå…³ç³»ï¼Œè¯»çš„æ—¶å€™èƒ½çŸ¥é“æ‰€ä»¥å‘ç”Ÿåœ¨å®ƒä¹‹å‰çš„å†™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627730489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304116,"user_name":"ChuanBing à¸ˆà¸¸à¹Šà¸š","can_delete":false,"product_type":"c1","uid":1628736,"ip_address":"","ucode":"4482E852FC147A","user_header":"https://static001.geekbang.org/account/avatar/00/18/da/40/bda5ad2b.jpg","comment_is_top":false,"comment_ctime":1627262033,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627262033","product_id":100061801,"comment_content":"func (rw *RWMutex) Unlock() {<br>\tif race.Enabled {<br>\t\t_ = rw.w.state<br>\t\trace.Release(unsafe.Pointer(&amp;rw.readerSem))<br>\t\trace.Disable()<br>\t}<br>&#47;&#47; ..........<br>}<br><br>è¯·é—® å…¶ä¸­çš„  _ = rw.w.state  ä½œç”¨æ˜¯ä»€ä¹ˆ?","like_count":0},{"had_liked":false,"id":293228,"user_name":"å°è™¾ç±³","can_delete":false,"product_type":"c1","uid":1005528,"ip_address":"","ucode":"F543987A7FAB20","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/d8/425e1b0a.jpg","comment_is_top":false,"comment_ctime":1621297872,"is_pvip":false,"replies":[{"id":"106132","content":"å…±ç”¨ä¸€ä¸ªstateå˜é‡","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1621306562,"ip_address":"","comment_id":293228,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1621297872","product_id":100061801,"comment_content":"rwmutexMaxReaders ä¸ºä½•ä¸èƒ½ç”¨æ»¡32ä½å‘¢","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520125,"discussion_content":"å…±ç”¨ä¸€ä¸ªstateå˜é‡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621306562,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":284508,"user_name":"Terenceå­«","can_delete":false,"product_type":"c1","uid":1157674,"ip_address":"","ucode":"8C3A89C18A2182","user_header":"https://static001.geekbang.org/account/avatar/00/11/aa/2a/ce7c487d.jpg","comment_is_top":false,"comment_ctime":1616311500,"is_pvip":false,"replies":[{"id":"103216","content":"èµï¼Œåˆ°ä½","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1616415991,"ip_address":"","comment_id":284508,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1616311500","product_id":100061801,"comment_content":"è¯»å†™é”ä¸­è¯»å†™é”Lockçš„æ€»ç»“ï¼š<br>å½“å‰é”å’Œæ–°é”ç±»å‹ä¸åŒï¼Œæ–°é”é˜»å¡ç­‰å¾…<br>å½“å‰é”å’Œæ–°é”ç±»å‹ç›¸åŒï¼Œè¯»é”ä¸é˜»å¡ï¼Œå†™é”é˜»å¡","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517372,"discussion_content":"èµï¼Œåˆ°ä½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616415991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259270,"user_name":"Yimmy","can_delete":false,"product_type":"c1","uid":1177248,"ip_address":"","ucode":"E66EAF7050C74A","user_header":"https://static001.geekbang.org/account/avatar/00/11/f6/a0/8ea0bfba.jpg","comment_is_top":false,"comment_ctime":1604666665,"is_pvip":false,"replies":[{"id":"94518","content":"æ˜¯çš„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¯»é”ã€‚é‡å…¥é—®é¢˜ã€‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1604989265,"ip_address":"","comment_id":259270,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1604666665","product_id":100061801,"comment_content":"è€å¸ˆå¥½ï¼Œâ€œåŒæ—¶ï¼Œå®ƒè¿˜ä¼šè°ƒç”¨ GetCPUSet æˆ– GetDefaultCPUSet æ–¹æ³•ã€‚å½“è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½è¯·æ±‚å†™é”æ—¶ï¼Œæ˜¯è·å–ä¸åˆ°çš„ï¼Œå› ä¸º GetCPUSetOrDefault æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¸ä¼šé‡Šæ”¾è¯»é”ï¼Œè¿™å°±å½¢æˆäº†æ­»é”ã€‚â€<br><br>çœ‹äº†è¿™ä¸ªissue, GetCPUSet æˆ– GetDefaultCPUSet è¿™2ä¸ªæ–¹æ³•ä¸­è°ƒç”¨çš„æ˜¯è¯»é”ï¼Œä¸æ˜¯å†™é”ï¼Œè¿™ä¸ªissuseçš„é—®é¢˜ï¼Œæˆ‘ç†è§£æ˜¯é‡å…¥é”ï¼Œè€Œä¸æ˜¯readerå’Œwriterç›¸äº’ç­‰å¾…çš„æ­»é”<br><br>è¡¥å……æºç ï¼ˆhttps:&#47;&#47;github.com&#47;kubernetes&#47;kubernetes&#47;pull&#47;62464&#47;files ï¼‰<br>func (s *stateMemory) GetCPUSet(containerID string) (cpuset.CPUSet, bool) {<br>\ts.RLock()<br>\tdefer s.RUnlock()<br>\tres, ok := s.assignments[containerID]<br>\treturn res.Clone(), ok<br>}<br>func (s *stateMemory) GetDefaultCPUSet() cpuset.CPUSet {<br>\ts.RLock()<br>\tdefer s.RUnlock()<br>\treturn s.defaultCPUSet.Clone()<br>}","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508891,"discussion_content":"æ˜¯çš„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯è¯»é”ã€‚é‡å…¥é—®é¢˜ã€‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604989265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258855,"user_name":"å‡ºå–çµé­‚çš„æ•™ç»ƒKerry","can_delete":false,"product_type":"c1","uid":1807943,"ip_address":"","ucode":"8C64517DA556FE","user_header":"https://static001.geekbang.org/account/avatar/00/1b/96/47/93838ff7.jpg","comment_is_top":false,"comment_ctime":1604568130,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1604568130","product_id":100061801,"comment_content":"æ¶¨çŸ¥è¯†äº†","like_count":0},{"had_liked":false,"id":258444,"user_name":"syuan","can_delete":false,"product_type":"c1","uid":1215879,"ip_address":"","ucode":"D9BBC2ADAB5F2E","user_header":"https://static001.geekbang.org/account/avatar/00/12/8d/87/47d95f4a.jpg","comment_is_top":false,"comment_ctime":1604448744,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604448744","product_id":100061801,"comment_content":"å¹²è´§æ»¡æ»¡","like_count":0},{"had_liked":false,"id":255697,"user_name":"Yayu","can_delete":false,"product_type":"c1","uid":1058015,"ip_address":"","ucode":"5E7842458D8229","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/df/645f8087.jpg","comment_is_top":false,"comment_ctime":1603415863,"is_pvip":false,"replies":[{"id":"93156","content":"åŸºç¡€æ€§æ•°æ®ç»“æ„ï¼Œè‹±è¯­æ˜¯primitive,ä¸æ˜¯åŸå­æ€§è¯­å¥å“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603416977,"ip_address":"","comment_id":255697,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603415863","product_id":100061801,"comment_content":"è€å¸ˆå¥½ï¼Œè¯·é—®â€œåŸè¯­â€çš„æ„æ€æ˜¯ä»€ä¹ˆï¼ŸåŸå­æ€§è¯­å¥å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507803,"discussion_content":"åŸºç¡€æ€§æ•°æ®ç»“æ„ï¼Œè‹±è¯­æ˜¯primitive,ä¸æ˜¯åŸå­æ€§è¯­å¥å“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603416977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255572,"user_name":"Linuxer","can_delete":false,"product_type":"c1","uid":1153978,"ip_address":"","ucode":"272D9D8089C3D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg","comment_is_top":false,"comment_ctime":1603374808,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603374808","product_id":100061801,"comment_content":"è¯•ç€å›ç­”ä¸€ä¸‹è¯¾åé¢˜ï¼Œåˆå­¦GOï¼Œè¯·å„ä½å¤§ä½¬æŒ‡ç‚¹<br>const {<br>   READ = 0 <br>   WRITE = 1<br>}<br><br>func (rw **RWMutex) TryLock(mode int32)  bool {<br>   n := atomic.LoadInt32(&amp;rw.readerCount)<br>   if n &lt; 0 {<br>      return false <br>   }   <br>   if mod == 0 &amp;&amp; atomic.CompareAndSwapInt32(n, n+1) == n{<br>      return true ;<br>   }else if mod == 1 &amp;&amp; atomic.CompareAndSwapInt32(0, -rwmutexMaxReaders) == 0 {<br>      rw.w.Lock()<br>      return true<br>   }else{<br>      return false<br>   }<br>}<br>func (rw *RWMutex) ExistWriter() bool {<br>     return atomic.LoadInt32(&amp;rw.readerCount) &lt; 0<br>}<br><br>func (rw *RWMutex) GetReaderNum() int32 {<br>   n := atomic.LoadInt32(&amp;rw.readerCount) ;<br>   if n &lt; 0 {<br>       return atomic.LoadInt32(&amp;rw.readerWait)<br>   }else{<br>      return n <br>   }<br>}","like_count":0,"discussions":[{"author":{"id":1289318,"avatar":"https://static001.geekbang.org/account/avatar/00/13/ac/66/a256008b.jpg","nickname":"SuperDai","note":"","ucode":"0CA86D253754CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319528,"discussion_content":"è€å“¥ ä½ è¿™ä»£ç èƒ½ç¼–è¯‘è¿‡å—ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604044124,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255184,"user_name":"pdf","can_delete":false,"product_type":"c1","uid":1649662,"ip_address":"","ucode":"A44250955878BB","user_header":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","comment_is_top":false,"comment_ctime":1603277193,"is_pvip":true,"discussion_count":6,"race_medal":0,"score":"1603277193","product_id":100061801,"comment_content":"Go 1.15<br>mainå‡½æ•°ç»“å°¾ select {} ç›´æ¥æŠ¥æ­»é”","like_count":0,"discussions":[{"author":{"id":1150927,"avatar":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","nickname":"é‚£æ—¶åˆ»","note":"","ucode":"B0D150856C3A4A","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316337,"discussion_content":"æˆ‘æµ‹è¯•äº†ï¼Œåœ¨1.12ä¹Ÿæ˜¯ä¼šdeadlockçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603385200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1150927,"avatar":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","nickname":"é‚£æ—¶åˆ»","note":"","ucode":"B0D150856C3A4A","race_medal":1,"user_type":1,"is_pvip":false},"discussion":{"id":316495,"discussion_content":"éš¾é“æ˜¯1.11ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603417416,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":316337,"ip_address":""},"score":316495,"extra":""}]},{"author":{"id":2227527,"avatar":"https://static001.geekbang.org/account/avatar/00/21/fd/47/499339d1.jpg","nickname":"æ–°å‘³é“","note":"","ucode":"979E3574082CE7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315906,"discussion_content":"select {} æ°¸ä¹…é˜»å¡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603335686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2227527,"avatar":"https://static001.geekbang.org/account/avatar/00/21/fd/47/499339d1.jpg","nickname":"æ–°å‘³é“","note":"","ucode":"979E3574082CE7","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":316216,"discussion_content":"ä½ è¦å…ˆå»å®è·µä¸€ä¸‹â€¦\n1.13æ˜¯å¯ä»¥çš„  1.15ä¸è¡Œ  ç›´æ¥æ­»é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603375966,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":315906,"ip_address":""},"score":316216,"extra":""},{"author":{"id":1024364,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a1/6c/241758d1.jpg","nickname":"Mengå°ç¾½","note":"","ucode":"C5E322F5DDCF12","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":318359,"discussion_content":"sleep è®¾ç½®æ—¶é—´é•¿ä¸€ç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603717687,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":316216,"ip_address":""},"score":318359,"extra":""},{"author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1024364,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a1/6c/241758d1.jpg","nickname":"Mengå°ç¾½","note":"","ucode":"C5E322F5DDCF12","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318378,"discussion_content":"chan waitgroup","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603720273,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":318359,"ip_address":""},"score":318378,"extra":""}]}]},{"had_liked":false,"id":255154,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1603274555,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603274555","product_id":100061801,"comment_content":"åˆæ˜¯ä¸€ä¸ªéœ€è¦èŠ±æ—¶é—´æ¶ˆåŒ–çš„ç« èŠ‚ï¼Œç†è§£è¯»å†™é”çš„åŸç†ä¹‹åï¼Œå†å‚è€ƒä¹‹å‰ Mutex ç« èŠ‚æ‰©å±•çš„å®ç°ï¼Œå†™ä¸€ä¸ªæ‰©å±•çš„è¯»å†™é”åº”è¯¥ä¸éš¾ï¼ŒæƒŠè®¶åœ°å‘ç°å·²ç»æœ‰å¤§ä½¬ç»™å‡ºç­”æ¡ˆäº†â€¦â€¦","like_count":0}]}