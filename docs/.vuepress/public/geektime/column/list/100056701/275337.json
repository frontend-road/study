{"id":275337,"title":"08 | 哨兵集群：哨兵挂了，主从库还能切换吗？","content":"<p>你好，我是蒋德钧。</p><p>上节课，我们学习了哨兵机制，它可以实现主从库的自动切换。通过部署多个实例，就形成了一个哨兵集群。哨兵集群中的多个实例共同判断，可以降低对主库下线的误判率。</p><p>但是，我们还是要考虑一个问题：如果有哨兵实例在运行时发生了故障，主从库还能正常切换吗？</p><p>实际上，一旦多个实例组成了<strong>哨兵集群</strong>，即使有哨兵实例出现故障挂掉了，其他哨兵还能继续协作完成主从库切换的工作，包括判定主库是不是处于下线状态，选择新主库，以及通知从库和客户端。</p><p>如果你部署过哨兵集群的话就会知道，在配置哨兵的信息时，我们只需要用到下面的这个配置项，设置<strong>主库的IP</strong>和<strong>端口</strong>，并没有配置其他哨兵的连接信息。</p><pre><code>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt; \n</code></pre><p>这些哨兵实例既然都不知道彼此的地址，又是怎么组成集群的呢？要弄明白这个问题，我们就需要学习一下哨兵集群的组成和运行机制了。</p><h2>基于pub/sub机制的哨兵集群组成</h2><p>哨兵实例之间可以相互发现，要归功于Redis提供的pub/sub机制，也就是发布/订阅机制。</p><p>哨兵只要和主库建立起了连接，就可以在主库上发布消息了，比如说发布它自己的连接信息（IP和端口）。同时，它也可以从主库上订阅消息，获得其他哨兵发布的连接信息。当多个哨兵实例都在主库上做了发布和订阅操作后，它们之间就能知道彼此的IP地址和端口。</p><!-- [[[read_end]]] --><p>除了哨兵实例，我们自己编写的应用程序也可以通过Redis进行消息的发布和订阅。所以，为了区分不同应用的消息，Redis会以频道的形式，对这些消息进行分门别类的管理。所谓的频道，实际上就是消息的类别。当消息类别相同时，它们就属于同一个频道。反之，就属于不同的频道。<strong>只有订阅了同一个频道的应用，才能通过发布的消息进行信息交换</strong>。</p><p>在主从集群中，主库上有一个名为“<code>__sentinel__:hello</code>”的频道，不同哨兵就是通过它来相互发现，实现互相通信的。</p><p>我来举个例子，具体说明一下。在下图中，哨兵1把自己的IP（172.16.19.3）和端口（26579）发布到“<code>__sentinel__:hello</code>”频道上，哨兵2和3订阅了该频道。那么此时，哨兵2和3就可以从这个频道直接获取哨兵1的IP地址和端口号。</p><p>然后，哨兵2、3可以和哨兵1建立网络连接。通过这个方式，哨兵2和3也可以建立网络连接，这样一来，哨兵集群就形成了。它们相互间可以通过网络连接进行通信，比如说对主库有没有下线这件事儿进行判断和协商。</p><p><img src=\"https://static001.geekbang.org/resource/image/ca/b1/ca42698128aa4c8a374efbc575ea22b1.jpg?wh=2822*1535\" alt=\"\"></p><p>哨兵除了彼此之间建立起连接形成集群外，还需要和从库建立连接。这是因为，在哨兵的监控任务中，它需要对主从库都进行心跳判断，而且在主从库切换完成后，它还需要通知从库，让它们和新主库进行同步。</p><p>那么，<strong>哨兵是如何知道从库的IP地址和端口的呢？</strong></p><p>这是由哨兵向主库发送INFO命令来完成的。就像下图所示，哨兵2给主库发送INFO命令，主库接受到这个命令后，就会把从库列表返回给哨兵。接着，哨兵就可以根据从库列表中的连接信息，和每个从库建立连接，并在这个连接上持续地对从库进行监控。哨兵1和3可以通过相同的方法和从库建立连接。</p><p><img src=\"https://static001.geekbang.org/resource/image/88/e0/88fdc68eb94c44efbdf7357260091de0.jpg?wh=2499*1404\" alt=\"\"></p><p>你看，通过pub/sub机制，哨兵之间可以组成集群，同时，哨兵又通过INFO命令，获得了从库连接信息，也能和从库建立连接，并进行监控了。</p><p>但是，哨兵不能只和主、从库连接。因为，主从库切换后，客户端也需要知道新主库的连接信息，才能向新主库发送请求操作。所以，哨兵还需要完成把新主库的信息告诉客户端这个任务。</p><p>而且，在实际使用哨兵时，我们有时会遇到这样的问题：如何在客户端通过监控了解哨兵进行主从切换的过程呢？比如说，主从切换进行到哪一步了？这其实就是要求，客户端能够获取到哨兵集群在监控、选主、切换这个过程中发生的各种事件。</p><p>此时，我们仍然可以依赖pub/sub机制，来帮助我们完成哨兵和客户端间的信息同步。</p><h2>基于pub/sub机制的客户端事件通知</h2><p>从本质上说，哨兵就是一个运行在特定模式下的Redis实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。所以，每个哨兵实例也提供pub/sub机制，客户端可以从哨兵订阅消息。哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。</p><p>频道有这么多，一下子全部学习容易丢失重点。为了减轻你的学习压力，我把重要的频道汇总在了一起，涉及几个关键事件，包括主库下线判断、新主库选定、从库重新配置。</p><p><img src=\"https://static001.geekbang.org/resource/image/4e/25/4e9665694a9565abbce1a63cf111f725.jpg?wh=2856*1738\" alt=\"\"></p><p>知道了这些频道之后，你就可以<strong>让客户端从哨兵这里订阅消息</strong>了。具体的操作步骤是，客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接。然后，我们可以在客户端执行订阅命令，来获取不同的事件消息。</p><p>举个例子，你可以执行如下命令，来订阅“所有实例进入客观下线状态的事件”：</p><pre><code>SUBSCRIBE +odown\n</code></pre><p>当然，你也可以执行如下命令，订阅所有的事件：</p><pre><code>PSUBSCRIBE  *\n</code></pre><p>当哨兵把新主库选择出来后，客户端就会看到下面的switch-master事件。这个事件表示主库已经切换了，新主库的IP地址和端口信息已经有了。这个时候，客户端就可以用这里面的新主库地址和端口进行通信了。</p><pre><code>switch-master &lt;master name&gt; &lt;oldip&gt; &lt;oldport&gt; &lt;newip&gt; &lt;newport&gt;\n</code></pre><p>有了这些事件通知，客户端不仅可以在主从切换后得到新主库的连接信息，还可以监控到主从库切换过程中发生的各个重要事件。这样，客户端就可以知道主从切换进行到哪一步了，有助于了解切换进度。</p><p>好了，有了pub/sub机制，哨兵和哨兵之间、哨兵和从库之间、哨兵和客户端之间就都能建立起连接了，再加上我们上节课介绍主库下线判断和选主依据，哨兵集群的监控、选主和通知三个任务就基本可以正常工作了。不过，我们还需要考虑一个问题：主库故障以后，哨兵集群有多个实例，那怎么确定由哪个哨兵来进行实际的主从切换呢？</p><h2>由哪个哨兵执行主从切换？</h2><p>确定由哪个哨兵执行主从切换的过程，和主库“客观下线”的判断过程类似，也是一个“投票仲裁”的过程。在具体了解这个过程前，我们再来看下，判断“客观下线”的仲裁过程。</p><p>哨兵集群要判定主库“客观下线”，需要有一定数量的实例都认为该主库已经“主观下线”了。我在上节课向你介绍了判断“客观下线”的原则，接下来，我介绍下具体的判断过程。</p><p>任何一个实例只要自身判断主库“主观下线”后，就会给其他实例发送is-master-down-by-addr命令。接着，其他实例会根据自己和主库的连接情况，做出Y或N的响应，Y相当于赞成票，N相当于反对票。</p><p><img src=\"https://static001.geekbang.org/resource/image/e0/84/e0832d432c14c98066a94e0ef86af384.jpg?wh=2322*1260\" alt=\"\"></p><p>一个哨兵获得了仲裁所需的赞成票数后，就可以标记主库为“客观下线”。这个所需的赞成票数是通过哨兵配置文件中的quorum配置项设定的。例如，现在有5个哨兵，quorum配置的是3，那么，一个哨兵需要3张赞成票，就可以标记主库为“客观下线”了。这3张赞成票包括哨兵自己的一张赞成票和另外两个哨兵的赞成票。</p><p>此时，这个哨兵就可以再给其他哨兵发送命令，表明希望由自己来执行主从切换，并让所有其他哨兵进行投票。这个投票过程称为“Leader选举”。因为最终执行主从切换的哨兵称为Leader，投票过程就是确定Leader。</p><p>在投票过程中，任何一个想成为Leader的哨兵，要满足两个条件：第一，拿到半数以上的赞成票；第二，拿到的票数同时还需要大于等于哨兵配置文件中的quorum值。以3个哨兵为例，假设此时的quorum设置为2，那么，任何一个想成为Leader的哨兵只要拿到2张赞成票，就可以了。</p><p>这么说你可能还不太好理解，我再画一张图片，展示一下3个哨兵、quorum为2的选举过程。</p><p><img src=\"https://static001.geekbang.org/resource/image/5f/d9/5f6ceeb9337e158cc759e23c0f375fd9.jpg?wh=2843*1934\" alt=\"\"></p><p>在T1时刻，S1判断主库为“客观下线”，它想成为Leader，就先给自己投一张赞成票，然后分别向S2和S3发送命令，表示要成为Leader。</p><p>在T2时刻，S3判断主库为“客观下线”，它也想成为Leader，所以也先给自己投一张赞成票，再分别向S1和S2发送命令，表示要成为Leader。</p><p>在T3时刻，S1收到了S3的Leader投票请求。因为S1已经给自己投了一票Y，所以它不能再给其他哨兵投赞成票了，所以S1回复N表示不同意。同时，S2收到了T2时S3发送的Leader投票请求。因为S2之前没有投过票，它会给第一个向它发送投票请求的哨兵回复Y，给后续再发送投票请求的哨兵回复N，所以，在T3时，S2回复S3，同意S3成为Leader。</p><p>在T4时刻，S2才收到T1时S1发送的投票命令。因为S2已经在T3时同意了S3的投票请求，此时，S2给S1回复N，表示不同意S1成为Leader。发生这种情况，是因为S3和S2之间的网络传输正常，而S1和S2之间的网络传输可能正好拥塞了，导致投票请求传输慢了。</p><p>最后，在T5时刻，S1得到的票数是来自它自己的一票Y和来自S2的一票N。而S3除了自己的赞成票Y以外，还收到了来自S2的一票Y。此时，S3不仅获得了半数以上的Leader赞成票，也达到预设的quorum值（quorum为2），所以它最终成为了Leader。接着，S3会开始执行选主操作，而且在选定新主库后，会给其他从库和客户端通知新主库的信息。</p><p>如果S3没有拿到2票Y，那么这轮投票就不会产生Leader。哨兵集群会等待一段时间（也就是哨兵故障转移超时时间的2倍），再重新选举。这是因为，哨兵集群能够进行成功投票，很大程度上依赖于选举命令的正常网络传播。如果网络压力较大或有短时堵塞，就可能导致没有一个哨兵能拿到半数以上的赞成票。所以，等到网络拥塞好转之后，再进行投票选举，成功的概率就会增加。</p><p>需要注意的是，如果哨兵集群只有2个实例，此时，一个哨兵要想成为Leader，必须获得2票，而不是1票。所以，如果有个哨兵挂掉了，那么，此时的集群是无法进行主从库切换的。因此，通常我们至少会配置3个哨兵实例。这一点很重要，你在实际应用时可不能忽略了。</p><h2>小结</h2><p>通常，我们在解决一个系统问题的时候，会引入一个新机制，或者设计一层新功能，就像我们在这两节课学习的内容：为了实现主从切换，我们引入了哨兵；为了避免单个哨兵故障后无法进行主从切换，以及为了减少误判率，又引入了哨兵集群；哨兵集群又需要有一些机制来支撑它的正常运行。</p><p>这节课上，我就向你介绍了支持哨兵集群的这些关键机制，包括：</p><ul>\n<li>基于pub/sub机制的哨兵集群组成过程；</li>\n<li>基于INFO命令的从库列表，这可以帮助哨兵和从库建立连接；</li>\n<li>基于哨兵自身的pub/sub功能，这实现了客户端和哨兵之间的事件通知。</li>\n</ul><p>对于主从切换，当然不是哪个哨兵想执行就可以执行的，否则就乱套了。所以，这就需要哨兵集群在判断了主库“客观下线”后，经过投票仲裁，选举一个Leader出来，由它负责实际的主从切换，即由它来完成新主库的选择以及通知从库与客户端。</p><p>最后，我想再给你分享一个经验：<strong>要保证所有哨兵实例的配置是一致的，尤其是主观下线的判断值down-after-milliseconds</strong>。我们曾经就踩过一个“坑”。当时，在我们的项目中，因为这个值在不同的哨兵实例上配置不一致，导致哨兵集群一直没有对有故障的主库形成共识，也就没有及时切换主库，最终的结果就是集群服务不稳定。所以，你一定不要忽略这条看似简单的经验。</p><h2>每课一问</h2><p>这节课上，我给你提一个小问题。</p><p>假设有一个Redis集群，是“一主四从”，同时配置了包含5个哨兵实例的集群，quorum值设为2。在运行过程中，如果有3个哨兵实例都发生故障了，此时，Redis主库如果有故障，还能正确地判断主库“客观下线”吗？如果可以的话，还能进行主从库自动切换吗？此外，哨兵实例是不是越多越好呢，如果同时调大down-after-milliseconds值，对减少误判是不是也有好处呢？</p><p>欢迎你在留言区跟我交流讨论。如果你身边也有要学习哨兵集群相关知识点的朋友，也欢迎你能帮我把今天的内容分享给他们，帮助他们一起解决问题。我们下节课见。</p>","neighbors":{"left":{"article_title":"07 | 哨兵机制：主库挂了，如何不间断服务？","id":274483},"right":{"article_title":"09 | 切片集群：数据增多了，是该加内存还是加实例？","id":276545}},"comments":[{"had_liked":false,"id":243201,"user_name":"小喵喵","can_delete":false,"product_type":"c1","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":true,"comment_ctime":1597992008,"is_pvip":false,"replies":[{"id":"89695","content":"文章读得很仔细！<br><br>先回答第一个问题：<br>文章中的例子里，要发生S1、S2和S3同时同自己投票的情况，这需要这三个哨兵基本同时判定了主库客观下线。但是，不同哨兵的网络连接、系统压力不完全一样，接收到下线协商消息的时间也可能不同，所以，它们同时做出主库客观下线判定的概率较小，一般都有个先后关系。文章中的例子，就是S1、S3先判定，S2一直没有判定。<br><br>其次，哨兵对主从库进行的在线状态检查等操作，是属于一种时间事件，用一个定时器来完成，一般来说每100ms执行一次这些事件。每个哨兵的定时器执行周期都会加上一个小小的随机时间偏移，目的是让每个哨兵执行上述操作的时间能稍微错开些，也是为了避免它们都同时判定主库下线，同时选举Leader。<br><br>最后，即使出现了都投给自己一票的情况，导致无法选出Leader，哨兵会停一段时间（一般是故障转移超时时间failover_timeout的2倍），然后再可以进行下一轮投票。<br><br>第二个问题：哨兵如果没有给自己投票，就会把票投给第一个给它发送投票请求的哨兵。后续再有投票请求来，哨兵就拒接投票了。","user_name":"作者回复","user_name_real":"蒋德钧","uid":"1609687","ctime":1598079301,"ip_address":"","comment_id":243201,"utype":1}],"discussion_count":18,"race_medal":0,"score":"9.2233727127625994e+18","product_id":100056701,"comment_content":"老师请教下：<br>1、图示哨兵选举过程中，选举的结果取决于S2的投票，如果S2也投给自己，并且每轮投票都是只投给自己，岂不是无法选出“Leader”，是不是这个过程从了死循环呢？<br>2、投票投给谁，依据是什么？","like_count":158,"discussions":[{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"吴小智","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325091,"discussion_content":"跟 Raft 的投票机制异曲同工啊","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1605234094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2476989,"avatar":"","nickname":"Geek_a810d9","note":"","ucode":"B7525D352DF0F9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"吴小智","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548398,"discussion_content":"就是类似raft机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643182530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":325091,"ip_address":""},"score":548398,"extra":""}]},{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"蒋德钧","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504217,"discussion_content":"文章读得很仔细！\n\n先回答第一个问题：\n文章中的例子里，要发生S1、S2和S3同时同自己投票的情况，这需要这三个哨兵基本同时判定了主库客观下线。但是，不同哨兵的网络连接、系统压力不完全一样，接收到下线协商消息的时间也可能不同，所以，它们同时做出主库客观下线判定的概率较小，一般都有个先后关系。文章中的例子，就是S1、S3先判定，S2一直没有判定。\n\n其次，哨兵对主从库进行的在线状态检查等操作，是属于一种时间事件，用一个定时器来完成，一般来说每100ms执行一次这些事件。每个哨兵的定时器执行周期都会加上一个小小的随机时间偏移，目的是让每个哨兵执行上述操作的时间能稍微错开些，也是为了避免它们都同时判定主库下线，同时选举Leader。\n\n最后，即使出现了都投给自己一票的情况，导致无法选出Leader，哨兵会停一段时间（一般是故障转移超时时间failover_timeout的2倍），然后再可以进行下一轮投票。\n\n第二个问题：哨兵如果没有给自己投票，就会把票投给第一个给它发送投票请求的哨兵。后续再有投票请求来，哨兵就拒接投票了。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1598079301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":4,"child_discussions":[{"author":{"id":3050838,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/MnNmAGFwlyPFiazHo4micPVFR4SheUk4VC5gKyoYHyHaZAWbyI16aEhm4xoxa4bNH7h5SdPajZibpC5wlyUGBzoog/132","nickname":"Geek_ad9aec","note":"","ucode":"951E86E64B4844","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"蒋德钧","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":580082,"discussion_content":"老师，有几点疑问：\n1、选举leader。1.1、是只有判断主库下线的哨兵才有机会？1.2、还是所有哨兵都有机会？\n2、如果是1.1的情况，那么是所有判断主库下线的哨兵都会竞争leader么？还是部分哨兵参与leader竞争？如果是部分，那么是那些哨兵竞争leader是怎么确定的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657865797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":504217,"ip_address":""},"score":580082,"extra":""},{"author":{"id":3050838,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/MnNmAGFwlyPFiazHo4micPVFR4SheUk4VC5gKyoYHyHaZAWbyI16aEhm4xoxa4bNH7h5SdPajZibpC5wlyUGBzoog/132","nickname":"Geek_ad9aec","note":"","ucode":"951E86E64B4844","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"蒋德钧","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":580083,"discussion_content":"老师，原文：任何一个实例只要自身判断主库“主观下线”后，就会给其他实例发送 is-master-down-by-addr 命令。\n问题：其他哨兵接到命令判断主库也是“主观下线”，那么他不是又重复原文过程，这不是形成了一个死循环么？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657866411,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":504217,"ip_address":""},"score":580083,"extra":""},{"author":{"id":1592279,"avatar":"https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg","nickname":"William Ning","note":"","ucode":"4DB8D05E69E5F3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":3050838,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/MnNmAGFwlyPFiazHo4micPVFR4SheUk4VC5gKyoYHyHaZAWbyI16aEhm4xoxa4bNH7h5SdPajZibpC5wlyUGBzoog/132","nickname":"Geek_ad9aec","note":"","ucode":"951E86E64B4844","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584501,"discussion_content":"1.1 的情况，所有判断主库下线的哨兵都会竞争leader，有个前提，几乎哨兵同时判断主库下线，但是这个概率比较小，哨兵竞争成为leader的条件有两个 ---- “在投票过程中，任何一个想成为 Leader 的哨兵，要满足两个条件：第一，拿到半数以上的赞成票；第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。”\n\n老师的回答，你再阅读两遍～～ 应该能解决你的疑惑。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1660883574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":580082,"ip_address":"浙江"},"score":584501,"extra":""}]},{"author":{"id":1123163,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","nickname":"悟空聊架构","note":"","ucode":"C2F482A0CF8AF1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373291,"discussion_content":"时间偏移和Raft 选举leader的过程很像","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1620692122,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1411419,"avatar":"https://static001.geekbang.org/account/avatar/00/15/89/5b/b014ce14.jpg","nickname":"小五","note":"","ucode":"B7B1F121837CD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1123163,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","nickname":"悟空聊架构","note":"","ucode":"C2F482A0CF8AF1","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":378886,"discussion_content":"还是有点区别的。Raft 中的随机时间是让节点成为候选者进而发起投票，这里的定时器执行周期时是去检查主从库的在线程状态，发现符合断开超时条件才会发起下线投票请求。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623487900,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373291,"ip_address":""},"score":378886,"extra":""}]},{"author":{"id":1234273,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d5/61/8ad99e09.jpg","nickname":"刘百万","note":"","ucode":"692E23D070641A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368796,"discussion_content":"怎么区别是第二轮的投票呢","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1618834145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1313229,"avatar":"https://static001.geekbang.org/account/avatar/00/14/09/cd/1a1dd08a.jpg","nickname":"黑山老妖怪","note":"","ucode":"17A056D9E5115E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301783,"discussion_content":"没记错的话，这种设计理念就是基于分布式算法Paxos，一些组件的分布式集群间推举leader大概都是这么操作的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598632474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3065276,"avatar":"","nickname":"Geek_b3b8da","note":"","ucode":"5461CD95B1D764","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586185,"discussion_content":"好家伙给我都绕晕了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662023841,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"浙江"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1234273,"avatar":"https://static001.geekbang.org/account/avatar/00/12/d5/61/8ad99e09.jpg","nickname":"刘百万","note":"","ucode":"692E23D070641A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368798,"discussion_content":"应该是每个哨兵节点 以自己定时检查主库 为一轮。也就是100ms加偏移的时间","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618834586,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1295609,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJRFRX8kNzNet7FibNvtavbVpAwK09AhIhrib9k762qWtH6mre8ickP7hM5mgZC4ytr8NnmIfmAhxMSQ/132","nickname":"老大不小","note":"","ucode":"35BCDD3CB13467","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366907,"discussion_content":"哎，一个妹子都这么好学，我无言以对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618215495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1890006,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/d6/d6/5fbb6e00.jpg","nickname":"再忙也要充充电","note":"","ucode":"098F2D9D280D60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1295609,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJRFRX8kNzNet7FibNvtavbVpAwK09AhIhrib9k762qWtH6mre8ickP7hM5mgZC4ytr8NnmIfmAhxMSQ/132","nickname":"老大不小","note":"","ucode":"35BCDD3CB13467","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":374602,"discussion_content":"说不定掏出来比你大，手动滑稽","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1621262072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":366907,"ip_address":""},"score":374602,"extra":""},{"author":{"id":1389314,"avatar":"https://static001.geekbang.org/account/avatar/00/15/33/02/83f47bf9.jpg","nickname":"流沙","note":"","ucode":"6153686D1C34B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1890006,"avatar":"https://static001.geekbang.org/account/avatar/00/1c/d6/d6/5fbb6e00.jpg","nickname":"再忙也要充充电","note":"","ucode":"098F2D9D280D60","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":380266,"discussion_content":"我要下车，这不是去幼儿园的车","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624417516,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":374602,"ip_address":""},"score":380266,"extra":""}]},{"author":{"id":1275690,"avatar":"https://static001.geekbang.org/account/avatar/00/13/77/2a/244d98aa.jpg","nickname":"cp★钊","note":"","ucode":"6B86D4D538BDF7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318135,"discussion_content":"之前看过说是基于raft做的选主，可以了解下这个算法的选主处理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603643507,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062444,"avatar":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","nickname":"小喵喵","note":"","ucode":"FDBBB2A59DB8B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301296,"discussion_content":"谢谢老师的解惑！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598486284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243177,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1597982505,"is_pvip":true,"replies":[{"id":"89756","content":"Kaito同学的答题一如既往的精彩！","user_name":"作者回复","user_name_real":"蒋德钧","uid":"1609687","ctime":1598230772,"ip_address":"","comment_id":243177,"utype":1}],"discussion_count":81,"race_medal":0,"score":"3446161753897","product_id":100056701,"comment_content":"Redis 1主4从，5个哨兵，哨兵配置quorum为2，如果3个哨兵故障，当主库宕机时，哨兵能否判断主库“客观下线”？能否自动切换？<br><br>经过实际测试，我的结论如下：<br><br>1、哨兵集群可以判定主库“主观下线”。由于quorum=2，所以当一个哨兵判断主库“主观下线”后，询问另外一个哨兵后也会得到同样的结果，2个哨兵都判定“主观下线”，达到了quorum的值，因此，哨兵集群可以判定主库为“客观下线”。<br><br>2、但哨兵不能完成主从切换。哨兵标记主库“客观下线后”，在选举“哨兵领导者”时，一个哨兵必须拿到超过多数的选票(5&#47;2+1=3票)。但目前只有2个哨兵活着，无论怎么投票，一个哨兵最多只能拿到2票，永远无法达到多数选票的结果。<br><br>但是投票选举过程的细节并不是大家认为的：每个哨兵各自1票，这个情况是不一定的。下面具体说一下：<br><br>场景a：哨兵A先判定主库“主观下线”，然后马上询问哨兵B（注意，此时哨兵B只是被动接受询问，并没有去询问哨兵A，也就是它还没有进入判定“客观下线”的流程），哨兵B回复主库已“主观下线”，达到quorum=2后哨兵A此时可以判定主库“客观下线”。此时，哨兵A马上可以向其他哨兵发起成为“哨兵领导者”的投票，哨兵B收到投票请求后，由于自己还没有询问哨兵A进入判定“客观下线”的流程，所以哨兵B是可以给哨兵A投票确认的，这样哨兵A就已经拿到2票了。等稍后哨兵B也判定“主观下线”后想成为领导者时，因为它已经给别人投过票了，所以这一轮自己就不能再成为领导者了。<br><br>场景b：哨兵A和哨兵B同时判定主库“主观下线”，然后同时询问对方后都得到可以“客观下线”的结论，此时它们各自给自己投上1票后，然后向其他哨兵发起投票请求，但是因为各自都给自己投过票了，因此各自都拒绝了对方的投票请求，这样2个哨兵各自持有1票。<br><br>场景a是1个哨兵拿到2票，场景b是2个哨兵各自有1票，这2种情况都不满足大多数选票(3票)的结果，因此无法完成主从切换。<br><br>经过测试发现，场景b发生的概率非常小，只有2个哨兵同时进入判定“主观下线”的流程时才可以发生。我测试几次后发现，都是复现的场景a。<br><br>哨兵实例是不是越多越好？<br><br>并不是，我们也看到了，哨兵在判定“主观下线”和选举“哨兵领导者”时，都需要和其他节点进行通信，交换信息，哨兵实例越多，通信的次数也就越多，而且部署多个哨兵时，会分布在不同机器上，节点越多带来的机器故障风险也会越大，这些问题都会影响到哨兵的通信和选举，出问题时也就意味着选举时间会变长，切换主从的时间变久。<br><br>调大down-after-milliseconds值，对减少误判是不是有好处？<br><br>是有好处的，适当调大down-after-milliseconds值，当哨兵与主库之间网络存在短时波动时，可以降低误判的概率。但是调大down-after-milliseconds值也意味着主从切换的时间会变长，对业务的影响时间越久，我们需要根据实际场景进行权衡，设置合理的阈值。","like_count":803,"discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300203,"discussion_content":"重点：只有进入到选举流程的哨兵，才能自己给自己先投一票，如果它还没有进入选举流程，只能给别人投票。\n\n试想，如果3个哨兵，每个都先给自己投1票，那么它们永远无法选出领导者，所以肯定有一个哨兵先进入了选举流程，只有这样，才能让别人给自己投票。","likes_number":32,"is_delete":false,"is_hidden":false,"ctime":1597984080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1799114,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/73/ca/9c5d7e55.jpg","nickname":"kingdompeak","note":"","ucode":"870C9E0726D747","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":300204,"discussion_content":"言之有理，学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597984244,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300203,"ip_address":""},"score":300204,"extra":""}]},{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300202,"discussion_content":"这些结论是我经过实际操作，然后观察哨兵log后得出的，大家可以实验一下，验证下结果。","likes_number":11,"is_delete":false,"is_hidden":false,"ctime":1597983814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1309929,"avatar":"https://static001.geekbang.org/account/avatar/00/13/fc/e9/34437e7f.jpg","nickname":"老申家的哈哈","note":"","ucode":"CE9C851CB95DF6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":308576,"discussion_content":"1主4从，需要5台机器，课代表是在自己的虚拟机上做的实验吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600999882,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300202,"ip_address":""},"score":308576,"extra":""},{"author":{"id":1253652,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","nickname":"Steven","note":"","ucode":"3FE64459842015","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1309929,"avatar":"https://static001.geekbang.org/account/avatar/00/13/fc/e9/34437e7f.jpg","nickname":"老申家的哈哈","note":"","ucode":"CE9C851CB95DF6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383948,"discussion_content":"docker 吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626315179,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308576,"ip_address":""},"score":383948,"extra":""},{"author":{"id":2476989,"avatar":"","nickname":"Geek_a810d9","note":"","ucode":"B7525D352DF0F9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1309929,"avatar":"https://static001.geekbang.org/account/avatar/00/13/fc/e9/34437e7f.jpg","nickname":"老申家的哈哈","note":"","ucode":"CE9C851CB95DF6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548400,"discussion_content":"只要端口不同，一台机器可以部署多个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643182672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":308576,"ip_address":""},"score":548400,"extra":""}]},{"author":{"id":1179028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","nickname":"咸鱼","note":"","ucode":"5E79636DE48155","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300209,"discussion_content":"这么牛逼肯定的给你👍，希望每节课后你都能看到你的精彩回复","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1597987176,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1179028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","nickname":"咸鱼","note":"","ucode":"5E79636DE48155","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300216,"discussion_content":"感谢，一块进步！","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1597989399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300209,"ip_address":""},"score":300216,"extra":""}]},{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":344532,"discussion_content":"加我微信 black-rye 可以进 Redis 技术交流群，每天讨论高质量技术问题哈！","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1611490882,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1503506,"avatar":"https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg","nickname":"你为啥那么牛","note":"","ucode":"1ABC604A54A8F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338807,"discussion_content":"这次回答，没有了那种纯纯的技术味道，描述也很流畅","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1609385116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2082118,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/P1y2k6dcoAWtlXkMcKFGeAmykTKCOKEicKsN0TX4eT6icibATfqnlsDyjicfjvo1zAa9lAS4ZGkSEGjeUUUmy9Qofg/132","nickname":"xyy_Li","note":"","ucode":"81A647AB5F757A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1503506,"avatar":"https://static001.geekbang.org/account/avatar/00/16/f1/12/7dac30d6.jpg","nickname":"你为啥那么牛","note":"","ucode":"1ABC604A54A8F6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539235,"discussion_content":"是啊 是啊 感觉容易理解多了\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639646215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":338807,"ip_address":""},"score":539235,"extra":""}]},{"author":{"id":2308831,"avatar":"https://static001.geekbang.org/account/avatar/00/23/3a/df/ea0fc831.jpg","nickname":"周天航","note":"","ucode":"B28D84594679A6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325318,"discussion_content":"按照老师说的哨兵选leader的算法类似raft，其实应该一旦a,b各自给自己投票，他们就会进入随机等待时间，然后再发起重新投票，由于随机等待时间不一样，因此下次就可能自己没发出投票请求的时候就收到了被投票请求。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1605271031,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2308831,"avatar":"https://static001.geekbang.org/account/avatar/00/23/3a/df/ea0fc831.jpg","nickname":"周天航","note":"","ucode":"B28D84594679A6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375601,"discussion_content":"对的 不这样做反而会发生永远无法选出主的问题。因为网络不会一直都很差 如果是同一个机房 不同机柜 那么怎么办？所以应该是尽快选主 尽快解决共识才是第一位。至于选错 其实不重要 因为每一轮都有epoch","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621763216,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":325318,"ip_address":""},"score":375601,"extra":""}]},{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"蒋德钧","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504210,"discussion_content":"Kaito同学的答题一如既往的精彩！","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598230772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1300285,"avatar":"https://static001.geekbang.org/account/avatar/00/13/d7/3d/a076faf1.jpg","nickname":"蜗牛","note":"","ucode":"A99C9C890F95E4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328969,"discussion_content":"班长的回答一如既往的精彩！","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1606289293,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1543018,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqw0R25Bt0iahFhEHfnxmzr9iaZf0eLsDQtFUJzgGkYwHTqicU9TydMngrJ4yL7D50awD2VibHBAdqplQ/132","nickname":"Geek_18dfaf","note":"","ucode":"CFC27E78220E2D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301336,"discussion_content":"\n细节的地方比老师讲的还细，好厉害啊","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598492636,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1358832,"avatar":"https://static001.geekbang.org/account/avatar/00/14/bb/f0/c36cc6d5.jpg","nickname":"哈喽","note":"","ucode":"33DEB091E31970","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300219,"discussion_content":"课代表再接再厉，������","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1597990265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2894784,"avatar":"","nickname":"Geek_4996c9","note":"","ucode":"98F65C1722D354","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":575958,"discussion_content":"5个哨兵组成的集群，宕掉了3个，集群的哨兵数量为什么还是按5个算呀","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1655211111,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2309475,"avatar":"https://static001.geekbang.org/account/avatar/00/23/3d/63/b4466457.jpg","nickname":"tardis","note":"","ucode":"F33411288D5E27","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":567225,"discussion_content":"quorum：确认odown的最少的哨兵数量\n\nmajority：授权进行主从切换的最少的哨兵数量\n\n每次一个哨兵要做主备切换，首先需要quorum数量的哨兵认为odown，然后选举出一个哨兵来做切换，这个哨兵还得得到majority哨兵的授权，才能正式执行切换\n\n如果quorum &lt; majority，比如5个哨兵，majority就是3，quorum设置为2，那么就3个哨兵授权就可以执行切换，但是如果quorum &gt;= majority，那么必须quorum数量的哨兵都授权，比如5个哨兵，quorum是5，那么必须5个哨兵都同意授权，才能执行切换\n查了一下，上面的就是哨兵判断客观下线，和哨兵选主的算法描述。可以看出你做的实验符合这个结论的。 感觉作者文中把quorum和majority这两个参数当成了一个，所以看的让人迷糊","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1650859693,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1602239,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","nickname":"Geek_e8d55e","note":"","ucode":"5F13626B0E1E45","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334936,"discussion_content":"还是没明白，挂掉三个哨兵之后，活着的哨兵也要求满足原哨兵数的半数以上才能发起主从切换？那我要为了节省资源，本来就打算回收三个哨兵，剩下的两个哨兵还玩不转了？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1608031915,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1602239,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","nickname":"Geek_e8d55e","note":"","ucode":"5F13626B0E1E45","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334958,"discussion_content":"哨兵挂掉和主动把哨兵从集群中下线是两回事。\n\n主动下线哨兵，集群节点数会减1，哨兵挂掉则不会。\n\n你理解一下这两者的区别。","likes_number":30,"is_delete":false,"is_hidden":false,"ctime":1608035899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334936,"ip_address":""},"score":334958,"extra":""}]},{"author":{"id":2105684,"avatar":"https://static001.geekbang.org/account/avatar/00/20/21/54/f172b987.jpg","nickname":"炜","note":"","ucode":"79053A57BCD77A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320263,"discussion_content":"请问数据写到主库，但是还没同步到从库，此时主库不可用，哨兵重新选举从库变成主库，这些数据是丢失吗还是","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1604304063,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2105684,"avatar":"https://static001.geekbang.org/account/avatar/00/20/21/54/f172b987.jpg","nickname":"炜","note":"","ucode":"79053A57BCD77A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320283,"discussion_content":"丢失。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1604308759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":320263,"ip_address":""},"score":320283,"extra":""}]},{"author":{"id":1730042,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/65/fa/4842bd0f.jpg","nickname":"Holiday","note":"","ucode":"6E7EAA0D8BEED0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303065,"discussion_content":"课代表，我有个问题文中“在主从集群中，主库上有一个名为“__sentinel__:hello”的频道，不同哨兵就是通过它来相互发现，实现互相通信的。”，但是哨兵的启动如果是一个一个启动的话。比如哨兵A启动，它向主库的__sentinel__:hello去发布订阅，然后哨兵B再启动，它也向主库的__sentinel__:hello去发布订阅，这个时候哨兵A是可以获得哨兵B的信息的，但是哨兵B怎么获得哨兵A的信息，因为哨兵A已经发布过了自己的信息了。难道哨兵A会不断的去发布自己的信息么？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1599127391,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1730042,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/65/fa/4842bd0f.jpg","nickname":"Holiday","note":"","ucode":"6E7EAA0D8BEED0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303077,"discussion_content":"对，不断的，定时发布自己的消息。","likes_number":14,"is_delete":false,"is_hidden":false,"ctime":1599130088,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303065,"ip_address":""},"score":303077,"extra":""},{"author":{"id":1730042,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/65/fa/4842bd0f.jpg","nickname":"Holiday","note":"","ucode":"6E7EAA0D8BEED0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":303083,"discussion_content":"好的 感谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599132980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303077,"ip_address":""},"score":303083,"extra":""},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1730042,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/65/fa/4842bd0f.jpg","nickname":"Holiday","note":"","ucode":"6E7EAA0D8BEED0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571523,"discussion_content":"用psubscribe *观察 会一直发布自己信息。 效果同gossip 原理不一样","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652257098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303065,"ip_address":""},"score":571523,"extra":""}]},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300844,"discussion_content":"课代表，请教个问题： 在哨兵节点选取Leader 节点的时候，某个节点已经投出了 Y 票，但是该轮没有选举出来Leader, 这时候这个节点怎么知道已经到了下一轮需要继续投票了呢？ 也可以这样问：一个节点在一轮只能投出一个票，但是这个节点怎么知道一轮什么时候，什么时候结束的呢？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598281223,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":300859,"discussion_content":"每一轮选举都有一个ID标识，这个ID是递增的。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1598283313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300844,"ip_address":""},"score":300859,"extra":""},{"author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":300874,"discussion_content":"这个ID是所有哨兵节点共享的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598284998,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300859,"ip_address":""},"score":300874,"extra":""},{"author":{"id":1020573,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/9d/9fe6c5a9.jpg","nickname":"面爸","note":"","ucode":"3AC7F192732223","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1005391,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","nickname":"一步","note":"","ucode":"73CEA468CE70C3","race_medal":1,"user_type":1,"is_pvip":true},"discussion":{"id":301667,"discussion_content":"这个选举其实raft算法，每个哨兵都有自己的选举任期，经过几个任期后是可以最终选举出leader","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598602957,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300874,"ip_address":""},"score":301667,"extra":""}]},{"author":{"id":1124689,"avatar":"https://static001.geekbang.org/account/avatar/00/11/29/51/ca9d27ae.jpg","nickname":"ma xiao","note":"","ucode":"34062717AC15CC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300756,"discussion_content":"可是在上一篇，文章里写的是哨兵集群在N/2+1个实例判断为主观下线，才会判定为客观下线的呀？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598257248,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1124689,"avatar":"https://static001.geekbang.org/account/avatar/00/11/29/51/ca9d27ae.jpg","nickname":"ma xiao","note":"","ucode":"34062717AC15CC","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300858,"discussion_content":"达到quorum则判定为客观下线。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1598283218,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300756,"ip_address":""},"score":300858,"extra":""},{"author":{"id":2108169,"avatar":"","nickname":"Geek_621444","note":"","ucode":"9FA6C34D24FCBD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":300990,"discussion_content":"这个不对吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598358453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300858,"ip_address":""},"score":300990,"extra":""},{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2108169,"avatar":"","nickname":"Geek_621444","note":"","ucode":"9FA6C34D24FCBD","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300994,"discussion_content":"哪里不对？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598359291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300990,"ip_address":""},"score":300994,"extra":""}]},{"author":{"id":1047423,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/7f/746a6f5e.jpg","nickname":"Q","note":"","ucode":"785546C617D3DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300225,"discussion_content":"想问下，如果在机器资源不多的情况下，哨兵和实例一起部署也是没有问题的吧？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597992387,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1047423,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/7f/746a6f5e.jpg","nickname":"Q","note":"","ucode":"785546C617D3DF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300227,"discussion_content":"可以，但是有资源尽量分开部署。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597993913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300225,"ip_address":""},"score":300227,"extra":""},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1047423,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/7f/746a6f5e.jpg","nickname":"Q","note":"","ucode":"785546C617D3DF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":571524,"discussion_content":"可以。而且规避了redis进程与哨兵进程网络问题  缺点是：n个进程位于同一台负载 在不绑核的情况下 会资源竞争","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652257190,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300225,"ip_address":""},"score":571524,"extra":""}]},{"author":{"id":1187286,"avatar":"https://static001.geekbang.org/account/avatar/00/12/1d/d6/76fe5259.jpg","nickname":"Dream.","note":"","ucode":"49B94CE5BA0D21","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584399,"discussion_content":"这个所需的赞成票数是通过哨兵配置文件中的 quorum 配置项设定的。例如，现在有 5 个哨兵，quorum 配置的是 3，那么，一个哨兵需要 3 张赞成票，就可以标记主库为“客观下线”了。这 3 张赞成票包括哨兵自己的一张赞成票和另外两个哨兵的赞成票。\n\n既然quorum配置的是2，那一个从库最多也能获得2票，难道不是可以完成主从切换吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660805125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3013303,"avatar":"https://static001.geekbang.org/account/avatar/00/2d/fa/b7/0342db08.jpg","nickname":"大排泡饭","note":"","ucode":"30B882AAB67CC5","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574178,"discussion_content":"所以monitor的quorum和leader选举的quorum是分开的，前者通过命令指定，后者可以配置吗，还是永远都是majority。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653886686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":3,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2866331,"avatar":"","nickname":"Geek_dc018e","note":"","ucode":"7A414A5829EF99","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":561539,"discussion_content":"请问为什么调大down-after-milliseconds值也意味着主从切换的时间会变长","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649666136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1592279,"avatar":"https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg","nickname":"William Ning","note":"","ucode":"4DB8D05E69E5F3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":556977,"discussion_content":"你好，关于回答中的第二点\n--------------------------------------------------\n“2、但哨兵不能完成主从切换。哨兵标记主库“客观下线后”，在选举“哨兵领导者”时，一个哨兵必须拿到超过多数的选票(5/2+1=3票)。但目前只有2个哨兵活着，无论怎么投票，一个哨兵最多只能拿到2票，永远无法达到多数选票的结果。”\n--------------------------------------------------\n\n应是没有规定一定要超过半数，根据配置而来，这里的quorum为2 \n--------------------------------------------------\n\n“假设有一个 Redis 集群，是“一主四从”，同时配置了包含 5 个哨兵实例的集群，quorum 值设为 2” -- 也就是场景a下，是能完成主从切换的。\n--------------------------------------------------\n\n理解不对之处，望指出～ \n谢谢～","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647593117,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1114878,"avatar":"https://static001.geekbang.org/account/avatar/00/11/02/fe/d539b96b.jpg","nickname":"曹翔","note":"","ucode":"B4D8B42DFB535C","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548508,"discussion_content":"可以搞个小册哇","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643243286,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1344535,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOn7k48KXia5rf0eXpzv2EGtqGibz3eNb8QnL8X72uia0g1rBwzXef4dV2JEdz3r4bu9GC1FLIeic4UA/132","nickname":"Lee","note":"","ucode":"6B8D59A0B1A1A9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544960,"discussion_content":"“所以当一个哨兵判断主库“主观下线”后，询问另外一个哨兵后也会得到同样的结果”\n后半句为什么是也会同样结果？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641791177,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2041993,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/28/89/8d953a33.jpg","nickname":"易水流川","note":"","ucode":"36EAC398EE580B","race_medal":2,"user_type":1,"is_pvip":true},"reply_author":{"id":1344535,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOn7k48KXia5rf0eXpzv2EGtqGibz3eNb8QnL8X72uia0g1rBwzXef4dV2JEdz3r4bu9GC1FLIeic4UA/132","nickname":"Lee","note":"","ucode":"6B8D59A0B1A1A9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572887,"discussion_content":"因为是假设了主库故障了，所有另外一个哨兵去ping的话，也会判定为主观下线","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653028823,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":544960,"ip_address":""},"score":572887,"extra":""}]},{"author":{"id":2550743,"avatar":"https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg","nickname":"if...else...","note":"","ucode":"D0565908C99695","race_medal":4,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381914,"discussion_content":"学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625287864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1110757,"avatar":"","nickname":"钟先生","note":"","ucode":"A5234325DB541A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375130,"discussion_content":"您好，我想请教下，哨兵们一起投票判断 Master 客观下线和哨兵选举Leader，这里是不是两个动作？他的先后顺序是怎么的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621492757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1110757,"avatar":"","nickname":"钟先生","note":"","ucode":"A5234325DB541A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375174,"discussion_content":"先判定客观下线，后选举leader。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1621501422,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":375130,"ip_address":""},"score":375174,"extra":""}]},{"author":{"id":1024294,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","nickname":"null","note":"","ucode":"F9039EFED6B55D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373323,"discussion_content":"k 神好，想请教一下，“基于 pub/sub 机制的客户端事件通知”中提到：客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接。\n\n客户端如何读取哨兵的配置文件吖？如此 sentinel master 宕机重新选主后，该配置文件的内容不就失效了？\n谢谢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620697748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1024294,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","nickname":"null","note":"","ucode":"F9039EFED6B55D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375599,"discussion_content":"基内部做了一个job 也就是serverCron()会不间端的发出info指令","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621763068,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":373323,"ip_address":""},"score":375599,"extra":""}]},{"author":{"id":1023101,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/9c/7d/774e07f9.jpg","nickname":"study的程序员","note":"","ucode":"E5AE9037D24429","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":371048,"discussion_content":"5这个数字是在哨兵启动后，订阅消息后收到4个哨兵，再加上自己算出5，然后记下来的吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619618682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1315254,"avatar":"https://static001.geekbang.org/account/avatar/00/14/11/b6/5e1158e6.jpg","nickname":"GJ","note":"","ucode":"CE310D11706D0A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337407,"discussion_content":"你好！quorum的值是怎么加的？不是单个哨兵拿到的Y去累加的吗？如果哨兵1发出请求，哨兵2给了N，给自己Y，那quorum不是1吗！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608895903,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1355831,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b0/37/d654fbac.jpg","nickname":"几近虚年","note":"","ucode":"28CD6486EED8E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1315254,"avatar":"https://static001.geekbang.org/account/avatar/00/14/11/b6/5e1158e6.jpg","nickname":"GJ","note":"","ucode":"CE310D11706D0A","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":361325,"discussion_content":"应该是如果哨兵2知道了主库主观下线，就会给自己投票，并且发送请求给其他哨兵让它们投票。\n所以最主要是哨兵是否知道了主库主观下线。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1616642459,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":337407,"ip_address":""},"score":361325,"extra":""},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1355831,"avatar":"https://static001.geekbang.org/account/avatar/00/14/b0/37/d654fbac.jpg","nickname":"几近虚年","note":"","ucode":"28CD6486EED8E2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375600,"discussion_content":"每一轮都会有个opoch","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621763106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":361325,"ip_address":""},"score":375600,"extra":""}]},{"author":{"id":2212143,"avatar":"https://static001.geekbang.org/account/avatar/00/21/c1/2f/5c8167aa.jpg","nickname":"油纸伞","note":"","ucode":"C2655B9F8874E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":314479,"discussion_content":"文中说的：具体的操作步骤是，客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接。然后，我们可以在客户端执行订阅命令，来获取不同的事件消息。-----------客户端并不知道哨兵的ip和端口号，怎么获取到哨兵的配置文件读取呢？难道是通过主从库获取？具体的流程是怎样呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603161024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":4,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":2212143,"avatar":"https://static001.geekbang.org/account/avatar/00/21/c1/2f/5c8167aa.jpg","nickname":"油纸伞","note":"","ucode":"C2655B9F8874E2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":314489,"discussion_content":"客户端读服务的配置文件，配置文件写了哨兵的地址和端口，然后客户端去连哨兵拿信息。","likes_number":5,"is_delete":false,"is_hidden":false,"ctime":1603162112,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":314479,"ip_address":""},"score":314489,"extra":""},{"author":{"id":2212143,"avatar":"https://static001.geekbang.org/account/avatar/00/21/c1/2f/5c8167aa.jpg","nickname":"油纸伞","note":"","ucode":"C2655B9F8874E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":315167,"discussion_content":"好的，感谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603245833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":314489,"ip_address":""},"score":315167,"extra":""},{"author":{"id":1977474,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/2c/82/98e2b82a.jpg","nickname":"Reborn 2.0","note":"","ucode":"BA506E7455D91C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2212143,"avatar":"https://static001.geekbang.org/account/avatar/00/21/c1/2f/5c8167aa.jpg","nickname":"油纸伞","note":"","ucode":"C2655B9F8874E2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315953,"discussion_content":"谢谢提问, 这个我也纳闷","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603339362,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":314479,"ip_address":""},"score":315953,"extra":""}]},{"author":{"id":1312339,"avatar":"https://static001.geekbang.org/account/avatar/00/14/06/53/29fa4e12.jpg","nickname":"✨胡小东","note":"","ucode":"314D40A5857C17","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312266,"discussion_content":"想请教一下，如果选出leader节点后，在进行主从切换的过程中，选出的leader节点挂了，还能正常进行主从切换嘛？是不是就无法切换新的主节点了呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602645401,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1312339,"avatar":"https://static001.geekbang.org/account/avatar/00/14/06/53/29fa4e12.jpg","nickname":"✨胡小东","note":"","ucode":"314D40A5857C17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312281,"discussion_content":"此次无法进行主从切换了。\n\n但是剩下的哨兵集群，可以重新选出leader，再次切换。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602648558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":312266,"ip_address":""},"score":312281,"extra":""},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1312339,"avatar":"https://static001.geekbang.org/account/avatar/00/14/06/53/29fa4e12.jpg","nickname":"✨胡小东","note":"","ucode":"314D40A5857C17","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375602,"discussion_content":"下一次serverCron发现后接着干一次","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621763259,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":312266,"ip_address":""},"score":375602,"extra":""}]},{"author":{"id":1179028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","nickname":"咸鱼","note":"","ucode":"5E79636DE48155","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301794,"discussion_content":"关于哨兵的相互发现，后加入哨兵的怎么知道已经在哨兵集群中其他哨兵的信息呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598661987,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1179028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","nickname":"咸鱼","note":"","ucode":"5E79636DE48155","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301795,"discussion_content":"每个哨兵都互相订阅pubsub hello频道，通过这个频道互相通信。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1598662628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":301794,"ip_address":""},"score":301795,"extra":""},{"author":{"id":1179028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","nickname":"咸鱼","note":"","ucode":"5E79636DE48155","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":303067,"discussion_content":"后连上来的哨兵获取到已连接的哨兵地址然后在向已连接的这个哨兵hello频道发送信息，是这个意思不","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599127660,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":301795,"ip_address":""},"score":303067,"extra":""},{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1179028,"avatar":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","nickname":"咸鱼","note":"","ucode":"5E79636DE48155","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375603,"discussion_content":"是的 这里有两种方式。一种是像zk这样配置里写死 还有一种就是pub/sub 或者gossip 反熵","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621763327,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303067,"ip_address":""},"score":375603,"extra":""}]},{"author":{"id":1020573,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/92/9d/9fe6c5a9.jpg","nickname":"面爸","note":"","ucode":"3AC7F192732223","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":301668,"discussion_content":"回复精彩的不行不行的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598603024,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1671917,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqvfH3iatrDMG3YaW1LlCtibKbPe4lSib8CvWTK78emvAu0dNCQY7OOZPZfQicdCUKUyFpTcia5exNibvIQ/132","nickname":"akka","note":"","ucode":"FCD0964E761172","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300329,"discussion_content":"课代表，请教几个问题：\n1.master和slave中的“__sentinel__:hello”频道，只有哨兵会向里面publish发布消息吗？那么哨兵里的各个频道，都是谁向里面publish消息的？除了客户端可以订阅这些频道，用来获取故障转移后新master的地址以外，还有谁订阅了这些频道？订阅这些频道用来实现什么目的？   \n   \n 2.如老师所讲，哨兵刚连上master时，是通过向master发送info replication命令来发现slaves的，但是如果在之后的时间里，有一个slave挂掉了或者有一个新的slave加入集群，那么哨兵是如何感知到这个变动的？？？？\n       我实验了一下：\n       如果停掉某个slave，哨兵是隔了几秒钟才发现的，哨兵服务的某频道里收到了一条“主观下线”消息，应该是通过多次ping这个slave，结果是在一定的时间内一直ping不通，所以判断此slave“主观下线”了；\n        而如果有一个新slave加入集群，结果哨兵瞬间就发现了，哨兵服务的某频道里收到了一条“+slave ip port ...”消息。哨兵是通过什么机制发现的？\n        我知道哨兵服务里有一个定时任务，好像是每间隔10秒（网上文章中说的，conf文件里没找到相应的配置项），都会向master和所有slave发送info命令；但是从这个10秒的时间间隔来看，这个定时任务好像不能瞬间发现吧？\n       ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598032561,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1010819,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6c/83/48e528cb.jpg","nickname":"Luke","note":"","ucode":"8368A63185356D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1671917,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqvfH3iatrDMG3YaW1LlCtibKbPe4lSib8CvWTK78emvAu0dNCQY7OOZPZfQicdCUKUyFpTcia5exNibvIQ/132","nickname":"akka","note":"","ucode":"FCD0964E761172","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300374,"discussion_content":"而如果有一个新slave加入集群，结果哨兵瞬间就发现了，哨兵服务的某频道里收到了一条“+slave ip port ...”消息。哨兵是通过什么机制发现的？\n\n新slave加入集群，master能够感知到，并且向__sentinel__:hello频道pub告知订阅的所有哨兵。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598068043,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300329,"ip_address":""},"score":300374,"extra":""},{"author":{"id":1671917,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqvfH3iatrDMG3YaW1LlCtibKbPe4lSib8CvWTK78emvAu0dNCQY7OOZPZfQicdCUKUyFpTcia5exNibvIQ/132","nickname":"akka","note":"","ucode":"FCD0964E761172","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1010819,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/6c/83/48e528cb.jpg","nickname":"Luke","note":"","ucode":"8368A63185356D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300395,"discussion_content":"好像不是通过__sentinel__:hello这个频道传递出去的，我实验过，当新从机加入集群时，这个频道里没有相关的消息","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598080579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300374,"ip_address":""},"score":300395,"extra":""},{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1671917,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqvfH3iatrDMG3YaW1LlCtibKbPe4lSib8CvWTK78emvAu0dNCQY7OOZPZfQicdCUKUyFpTcia5exNibvIQ/132","nickname":"akka","note":"","ucode":"FCD0964E761172","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300428,"discussion_content":"不是master主动通知哨兵的。应该是哨兵定时从master获取slave节点信息的，只不过你测试时正好是哨兵从master拿信息的时刻，多测试几次，应该会发现是有延迟的。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1598092786,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300395,"ip_address":""},"score":300428,"extra":""}]},{"author":{"id":1312184,"avatar":"https://static001.geekbang.org/account/avatar/00/14/05/b8/8d468842.jpg","nickname":"JulyRemember","note":"","ucode":"9E3D5D60D82999","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300256,"discussion_content":"有个问题问下，老师在课程中提到部署哨兵集群的时候一定要大于3台机器，是因为选举领导的时候收到的赞成数一定是大于集群数一半加一吗？这个是Redis官方规定是吗？当然还有quorum的标准。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598000197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":5,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1312184,"avatar":"https://static001.geekbang.org/account/avatar/00/14/05/b8/8d468842.jpg","nickname":"JulyRemember","note":"","ucode":"9E3D5D60D82999","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300271,"discussion_content":"哨兵集群建议是基数个数，如果是偶数个，在选举投票时很大概率平票导致选举失败。\n\n基数的话这个概率就很小了，所以基数的最小个数是3个，当然部署5个也是可以的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598007671,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300256,"ip_address":""},"score":300271,"extra":""},{"author":{"id":1513070,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ibb1HJTBX85TuIYRQv3eUxib5Zdc5paH1mULBaLFZf0N6C1WxLrw6ZUc4oiaEPQEdfrQMkIjIYtTib66l8VfgrtHRQ/132","nickname":"Geek_71d4ac","note":"","ucode":"81FBA4DA79F5E4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":300300,"discussion_content":"奇数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598014657,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300271,"ip_address":""},"score":300300,"extra":""},{"author":{"id":1020042,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","nickname":"Kaito","note":"","ucode":"79775FA35A95F2","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1513070,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ibb1HJTBX85TuIYRQv3eUxib5Zdc5paH1mULBaLFZf0N6C1WxLrw6ZUc4oiaEPQEdfrQMkIjIYtTib66l8VfgrtHRQ/132","nickname":"Geek_71d4ac","note":"","ucode":"81FBA4DA79F5E4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300304,"discussion_content":"打错了，感谢指正！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598016218,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300300,"ip_address":""},"score":300304,"extra":""}]}]},{"had_liked":false,"id":243544,"user_name":"注定非凡","can_delete":false,"product_type":"c1","uid":1113597,"ip_address":"","ucode":"80673056E131B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg","comment_is_top":false,"comment_ctime":1598177552,"is_pvip":true,"discussion_count":9,"race_medal":0,"score":"392440201488","product_id":100056701,"comment_content":"一，作者讲了什么？<br>哨兵集群的工作机制<br><br>二，作者是怎么把这事给讲明白的？<br>    1，哨兵之间互通机制：基于pub&#47;sub机制，在主库中有一个&quot;__sentinel__:hello&quot;的频道，哨兵之间互相发现通信<br>    2，哨兵与主从库互通机制：哨兵向主库发送INFO指令，可以获取所有从库的信息，实现对主库，从库的监控<br>    3，哨兵判定主库异常机制：哨兵集群中任意一个实例都可以发起主库异常“投票仲裁”流程<br><br>三，为了讲明白，作者都讲了哪些要点？有哪些亮点？<br>    1，亮点1：哨兵之间的互动是通过发布订阅机制完成的，利用自身的特性来实现。这让我联想到kafka对于日息位置偏移量的管理<br>    2，要点1：哨兵之间通信不是哨兵之间之间联系，而是通过订阅主库的同一频道来获取彼此的信息<br>    3，要点2：哨兵是通过INFO指令，从主库获取从库信息，并与每个从库建立连接，监控所有主从库状态<br>    4，要点3：哨兵是一个特殊的redis实例，所以客户端可以订阅哨兵的指定频道获得redis主从库的信息<br>    5，要点4：哨兵集群执行主从切换机制：谁发现，谁就发起投票流程，谁获得多数票，谁就是哨兵Leader，由Leader负责主从库切换<br>    6，要点5：哨兵集群Leader选举成功与否，依赖于网络通信状况，网络拥塞会导致选举失败，重新进行新一轮选举<br><br>四，对于作者所讲，我有哪些发散性思考？<br><br>五，在未来的哪些场景里，我可以使用它？<br><br>六，留言区的收获：（感谢 @ 小喵喵 的提问）<br>    1，哨兵投票机制：<br>            a：哨兵实例只有在自己判定主库下线时，才会给自己投票，而其他的哨兵实例会把票投给第一个来要票的请求，其后的都拒绝<br>            b：如果出现多个哨兵同时发现主库下线并给自己投票，导致投票选举失败，就会触发新一轮投票，直至成功<br><br>    2，哨兵Leader切换主从库的机制：（感谢 @Kaito ，@Darren   大神的解答）<br>            哨兵成为Leader的必要条件：a：获得半数以上的票数，b：得到的票数要达到配置的quorum阀值<br>            主从切换只能由Leader执行，而成为Leader有两个必要的条件，所以当哨兵集群中实例异常过多时，会导致主从库无法切换<br>        ","like_count":92,"discussions":[{"author":{"id":1175246,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ee/ce/c024a857.jpg","nickname":"藏锋","note":"","ucode":"D5F811B16725A0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368043,"discussion_content":"老哥，其实你和Kaito大神都是值得大家学习的，不必谦虚。从Kaito那里学到的是对问题和知识更深层次的掌握，这种掌握是大量理论结合实践出来的东西，对于我们自身很有借鉴意义。而从你这里学到的是更多的是读书学习的一种方式和思路，也很有借鉴价值。","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1618549573,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2028945,"avatar":"","nickname":"Geek5198","note":"","ucode":"2BEBE6A39D9A0E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381547,"discussion_content":"你和K神，一个是学习委员整理笔记，一个是课代表帮忙解答同学问题，都是棒棒哒","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1625123106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2104255,"avatar":"https://static001.geekbang.org/account/avatar/00/20/1b/bf/48de2ca3.jpg","nickname":"脚踏实地，砥砺前行","note":"","ucode":"273EAD9741748D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349078,"discussion_content":"我会一直向你学习","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1612875821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"吴小智","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325094,"discussion_content":"老哥的思路，才是读专栏的正确打开方式啊，赞一个������","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605234364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2027258,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/ee/fa/31361552.jpg","nickname":"X","note":"","ucode":"688D816A4931CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":567929,"discussion_content":" b：如果出现多个哨兵同时发现主库下线并给自己投票，这个主库下线是指的客观下线吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651029862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1181844,"avatar":"https://static001.geekbang.org/account/avatar/00/12/08/94/2c22bd4e.jpg","nickname":"克里斯","note":"","ucode":"00B755C10AC1C3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":405287,"discussion_content":"加个好友伐","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634549283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2144915,"avatar":"https://static001.geekbang.org/account/avatar/00/20/ba/93/7d58263a.jpg","nickname":"梦之光","note":"","ucode":"2E808240409BDD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":391617,"discussion_content":"老哥的学习方式真的值得借鉴","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630553519,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1411419,"avatar":"https://static001.geekbang.org/account/avatar/00/15/89/5b/b014ce14.jpg","nickname":"小五","note":"","ucode":"B7B1F121837CD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378889,"discussion_content":"好的学习方式，向大佬学习！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623489885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2104255,"avatar":"https://static001.geekbang.org/account/avatar/00/20/1b/bf/48de2ca3.jpg","nickname":"脚踏实地，砥砺前行","note":"","ucode":"273EAD9741748D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349076,"discussion_content":"为什么作者不回复你呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612875797,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243142,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1597975140,"is_pvip":true,"discussion_count":4,"race_medal":0,"score":"91792288356","product_id":100056701,"comment_content":"1、可以正确的判断主库“客观下线”，以为其中一个哨兵已经获得了“客观下线”所需要的投票数；<br>2、不能进行自动的主从切换，因为在主从切换的时候，必须选择出一个主哨兵，但是选择主哨兵有2个条件：<br>\t2.1 拿到半数以上的赞成票；<br>\t2.2 拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。<br>\t此时可以满足投票数，但是拿不到半数以上的投票，因此无法选出主哨兵，所以无法进行主从切换。<br>3、哨兵的实例不是越多越好，因为哨兵的选举使用的是Raft协议，这个协议是Paxos协议的变种，这种协议在选主时，需要所有的节点参与投票，所以节点越多，选举耗时可能就会更久，所以根据对服务SLA的要求，评估一个节点可能出现问题的概率，选择合适的哨兵数量。<br>4、down-after-milliseconds不是越大越好的，虽然可以减少误判的概率，但是问题真正发生时，服务的不可用状态也会更久，所以down-after-milliseconds要根据真实的业务场景，进行取舍。","like_count":21,"discussions":[{"author":{"id":1602239,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","nickname":"Geek_e8d55e","note":"","ucode":"5F13626B0E1E45","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334937,"discussion_content":"你好，有个问题请教下，选择主哨兵需要半数以上选票，这个半数是指当前活着的哨兵数的半数，还是原先最多哨兵数时的半数？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608032089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1016575,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/82/ff/00e7614e.jpg","nickname":"robyy","note":"","ucode":"773337C9942A7F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1602239,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","nickname":"Geek_e8d55e","note":"","ucode":"5F13626B0E1E45","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346706,"discussion_content":"原先（总共）的哨兵数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612041784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334937,"ip_address":""},"score":346706,"extra":""}]},{"author":{"id":1150927,"avatar":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","nickname":"那时刻","note":"","ucode":"B0D150856C3A4A","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300208,"discussion_content":"请问一下，您提到哨兵使用了raft协议，但是我翻了redis文档和代码，并没有发现raft的影子。请问您是在哪里看到的呢？\n另外我看到个redis-raft但是貌似得等到7.0才有可能release...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597986732,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1254968,"avatar":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","nickname":"Darren","note":"","ucode":"CCD2B2C492BE9A","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1150927,"avatar":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","nickname":"那时刻","note":"","ucode":"B0D150856C3A4A","race_medal":1,"user_type":1,"is_pvip":false},"discussion":{"id":300215,"discussion_content":"http://redis.cn/topics/sentinel.html","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1597989347,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300208,"ip_address":""},"score":300215,"extra":""}]}]},{"had_liked":false,"id":243764,"user_name":"吕","can_delete":false,"product_type":"c1","uid":1210890,"ip_address":"","ucode":"8F08E2CB81C4C3","user_header":"https://static001.geekbang.org/account/avatar/00/12/7a/0a/0ce5c232.jpg","comment_is_top":false,"comment_ctime":1598269594,"is_pvip":false,"replies":[{"id":"89803","content":"有帮助就好 :D","user_name":"作者回复","user_name_real":"蒋德钧","uid":"1609687","ctime":1598283039,"ip_address":"","comment_id":243764,"utype":1}],"discussion_count":4,"race_medal":0,"score":"74612713626","product_id":100056701,"comment_content":"这篇文章太好了，直接解决了一个困惑我很久的问题，我一直把判断下线和选主主当成了同一件事，把quorum当成是判断下线和选举leader的阀值，原来判断下线还选主是两个分开的事情","like_count":17,"discussions":[{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"蒋德钧","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504388,"discussion_content":"有帮助就好 :D","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598283039,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1227840,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bc/40/2279cfb5.jpg","nickname":"大力水手Jerry","note":"","ucode":"E4A6C71E275DB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375072,"discussion_content":"可以参考：https://redis.io/topics/sentinel\n1. The quorum is the number of Sentinels that need to agree about the fact the master is not reachable, in order to really mark the master as failing, and eventually start a failover procedure if possible.\n2. However the quorum is only used to detect the failure. In order to actually perform a failover, one of the Sentinels need to be elected leader for the failover and be authorized to proceed. This only happens with the vote of the majority of the Sentinel processes.","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621475042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2094925,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/f7/4d/09554c96.jpg","nickname":"iron bo","note":"","ucode":"4BFB1331637AA3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369947,"discussion_content":"阈值 不是fazhi","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619228074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1415619,"avatar":"https://static001.geekbang.org/account/avatar/00/15/99/c3/e4f408d4.jpg","nickname":"陌兮","note":"","ucode":"00CE47CAECD5CD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":358650,"discussion_content":"我也理解差了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616028069,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":292097,"user_name":"悟空聊架构","can_delete":false,"product_type":"c1","uid":1123163,"ip_address":"","ucode":"C2F482A0CF8AF1","user_header":"https://static001.geekbang.org/account/avatar/00/11/23/5b/983408b9.jpg","comment_is_top":false,"comment_ctime":1620692064,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"61750234208","product_id":100056701,"comment_content":"选举leader的过程和分布式Raft协议很像。之前写过一篇介绍Raft机制的文章，可以看看：《用动图讲解分布式Raft》https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;US12ux7osqH_L0CtQyw-9A","like_count":14},{"had_liked":false,"id":243812,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1598281203,"is_pvip":true,"discussion_count":2,"race_medal":1,"score":"35958019571","product_id":100056701,"comment_content":"在哨兵节点选取Leader 节点的时候，某个节点已经投出了 Y 票，但是该轮没有选举出来Leader, 这时候这个节点怎么知道已经到了下一轮需要继续投票了呢？ 也可以这样问：一个节点在一轮只能投出一个票，但是这个节点怎么知道一轮什么时候，什么时候结束的呢？","like_count":8,"discussions":[{"author":{"id":1046714,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg","nickname":"约书亚","note":"","ucode":"81EA27ADD9EC1A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":346000,"discussion_content":"有epoch的概念，不过可能是考虑太复杂文章没提","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611836086,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1618828,"avatar":"","nickname":"面向工资编程","note":"","ucode":"07F797F021BDD0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306492,"discussion_content":"感觉会有事件，不然不知道一轮投票什么时候结束，什么时候要重置自己上一轮的投票，这票就没法投多次了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600302089,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243100,"user_name":"kingdompeak","can_delete":false,"product_type":"c1","uid":1799114,"ip_address":"","ucode":"870C9E0726D747","user_header":"https://static001.geekbang.org/account/avatar/00/1b/73/ca/9c5d7e55.jpg","comment_is_top":false,"comment_ctime":1597966866,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"23072803346","product_id":100056701,"comment_content":"1.可以判断主库“客观下线”。比如哨兵实例1判断主库为客观下线，然后向哨兵实例2发送is-master-down-by-addr命令，如果哨兵实例2此时也判断主库为客观下线，就会返回Y，此时哨兵实例1就会有两个Y（包括自己的），满足配置项quorum，所以就可以判断主库客观下线。<br>2.不能进行主从进行主从切换前需要选执行切换操作的Leader。由于两个哨兵实例在选Leader的事情上都只会给自己投票，所以各自的得票数只能为1，满足不了成为Leader的两个条件（1.得票数大于哨兵实例数的一半；2.满足quorum配置项），所以选不出Leader，自然无法执行主从切换。<br>3.调大此参数对误判有好处，由于存活的哨兵实例只有两个，如果恰好某段时间，两个实例与主库的网络连接不好，则很容易都将其标记为主观下线，进而就标记为客观下线了，进而就产生了误判，时间长点，在哨兵实例少的情况下会减少误判情况的发生。","like_count":5,"discussions":[{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576147,"discussion_content":"哨兵1就能直接判断客观下线了?       先主观吧.........","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655302130,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1047423,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/7f/746a6f5e.jpg","nickname":"Q","note":"","ucode":"785546C617D3DF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300156,"discussion_content":"难怪我一直切换不成功，学习了，原来还要自己给自己投一票的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597971524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1799114,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/73/ca/9c5d7e55.jpg","nickname":"kingdompeak","note":"","ucode":"870C9E0726D747","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1047423,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/7f/746a6f5e.jpg","nickname":"Q","note":"","ucode":"785546C617D3DF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300200,"discussion_content":"哈哈，哨兵对自己有信心，有上进心，勇于投自己","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597983283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300156,"ip_address":""},"score":300200,"extra":""}]}]},{"had_liked":false,"id":245116,"user_name":"可怜大灰狼","can_delete":false,"product_type":"c1","uid":1928373,"ip_address":"","ucode":"6CA9D6D460B967","user_header":"https://static001.geekbang.org/account/avatar/00/1d/6c/b5/32374f93.jpg","comment_is_top":false,"comment_ctime":1598839805,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"18778708989","product_id":100056701,"comment_content":"老师你好。看到“同时，哨兵又通过 INFO 命令，获得了从库连接信息，也能和从库建立连接，并进行监控了”这句话。我翻了一下代码sentinel.c&#47;sentinelSendPeriodicCommands。发现sentinelSendPeriodicCommands里有一行代码：<br>redisAsyncCommand(ri-&gt;cc, sentinelInfoReplyCallback, NULL, &quot;INFO&quot;);<br>的确哨兵也是会往从库发送INFO命令的，而从库的INFO返回值中，我发现包含以下的内容：<br>run_id:d7e50cc730c3851fcb9d8b4b6af425f59e5207a6<br>slave_repl_offset:140354728<br>slave_priority:100<br>07节里说的三轮打分，是不是根据从库INFO监控信息来进行打分的？也就是说，第一轮根据slave_priority，第二轮根据slave_repl_offset，第三轮根据run_id。感觉和前面内容串起来了。<br>不对的地方，麻烦老师纠错下。","like_count":4},{"had_liked":false,"id":243111,"user_name":"小贤","can_delete":false,"product_type":"c1","uid":1045642,"ip_address":"","ucode":"BF81E83E5CCEF2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f4/8a/ab9e3028.jpg","comment_is_top":false,"comment_ctime":1597971085,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18777840269","product_id":100056701,"comment_content":"down-after-milliseconds 这个参数一般设置多大合适呢？","like_count":4},{"had_liked":false,"id":341933,"user_name":"ivhong","can_delete":false,"product_type":"c1","uid":2659871,"ip_address":"","ucode":"9947B228807AC9","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8ic8eLTo5rnqIMJicUfpkVBrOUJAW4fANicKIbHdC54O9SOdwSoeK6o8icibaUbh7ZUXAkGF9zwHqo0Q/132","comment_is_top":false,"comment_ctime":1649923750,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10239858342","product_id":100056701,"comment_content":"我有另一个问题很困惑，如课后问题，一个1主4从的redis集群，5个哨兵集群，是不是得需要10台服务器？那么维护redis集群的成本是不是有些太高了，比如说我们小公司控制成本很严格，redis集群1主2从，至少3个哨兵做哨兵集群，那么就需要6台服务器了～公司可能申请不下来这么多的钱","like_count":2},{"had_liked":false,"id":243325,"user_name":"范闲","can_delete":false,"product_type":"c1","uid":1073125,"ip_address":"","ucode":"F21FD7DF6BA53C","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/e5/54325854.jpg","comment_is_top":false,"comment_ctime":1598059607,"is_pvip":false,"replies":[{"id":"89693","content":"理解到位了！<br><br>不过，一般我们还是叫主观下线和客观下线更多些。。","user_name":"作者回复","user_name_real":"蒋德钧","uid":"1609687","ctime":1598074502,"ip_address":"","comment_id":243325,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10187994199","product_id":100056701,"comment_content":"哨兵判断下线分为可能下线和确定下线两种状态。<br>在课后的例子中，5个哨兵正常2个，异常3个，qurum为2（判断确定下线的哨兵数目）<br><br>根据主从选举要求必须半数以上的节点同意，即要求数量大于N&#47;2+1。此例中是5&#47;2+1＝3，而只有2个哨兵活着因此不可能完成主从切换。<br><br><br>而确定下线的数目为2，2个哨兵可以完成确定下线的判断。<br><br>","like_count":2,"discussions":[{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"蒋德钧","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504256,"discussion_content":"理解到位了！\n\n不过，一般我们还是叫主观下线和客观下线更多些。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598074502,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1780797,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/2c/3d/0bd58aa4.jpg","nickname":"Em","note":"","ucode":"32012A5C603C8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576148,"discussion_content":"可能和确定还通俗一点......","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655302193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243133,"user_name":"riryoutexi","can_delete":false,"product_type":"c1","uid":2112144,"ip_address":"","ucode":"2A3C7060F4D677","user_header":"https://static001.geekbang.org/account/avatar/00/20/3a/90/2ab62cd9.jpg","comment_is_top":false,"comment_ctime":1597974015,"is_pvip":false,"replies":[{"id":"89685","content":"哨兵都挂了，无能为力了。。。","user_name":"作者回复","user_name_real":"蒋德钧","uid":"1609687","ctime":1598027490,"ip_address":"","comment_id":243133,"utype":1}],"discussion_count":4,"race_medal":0,"score":"10187908607","product_id":100056701,"comment_content":"整个哨兵集群都挂了，还会主从切换吗","like_count":2,"discussions":[{"author":{"id":1609687,"avatar":"https://static001.geekbang.org/account/avatar/00/18/8f/d7/fb60129d.jpg","nickname":"蒋德钧","note":"","ucode":"833985C2C37C0A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504191,"discussion_content":"哨兵都挂了，无能为力了。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598027490,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1402254,"avatar":"https://static001.geekbang.org/account/avatar/00/15/65/8e/d0c3bed3.jpg","nickname":"kg200704","note":"","ucode":"C58729CE07CCA9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":566441,"discussion_content":"发号施令的都没了，下面就一盘散沙了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650686097,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1317425,"avatar":"https://static001.geekbang.org/account/avatar/00/14/1a/31/075fa608.jpg","nickname":"相少龙","note":"","ucode":"E5EF811D7EE8B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548701,"discussion_content":"那怎么人工处理呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643335262,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1804087,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/87/37/b071398c.jpg","nickname":"等风来🎧","note":"","ucode":"B6BB8714A0B019","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300192,"discussion_content":"肯定不能啊，哨兵就是用来解决主从切换的。。。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597980999,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243117,"user_name":"Q","can_delete":false,"product_type":"c1","uid":1047423,"ip_address":"","ucode":"785546C617D3DF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fb/7f/746a6f5e.jpg","comment_is_top":false,"comment_ctime":1597971643,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"10187906235","product_id":100056701,"comment_content":"干货满满。。 最近一直在测试哨兵集群，get 到一个点: 自己还要给自己投一票！也就是每个哨兵只有一次投票权，投自己或别人！","like_count":2,"discussions":[{"author":{"id":1178018,"avatar":"https://static001.geekbang.org/account/avatar/00/11/f9/a2/d1075252.jpg","nickname":"蚂蚁闲游","note":"","ucode":"D69831114028EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304784,"discussion_content":"一次投y","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599662682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1804087,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/87/37/b071398c.jpg","nickname":"等风来🎧","note":"","ucode":"B6BB8714A0B019","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300190,"discussion_content":"这一点和zk，一样，一个选举周期只会有一次投票权，其实老师该提一下这个点。虽然悟也能悟出来","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597980929,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343457,"user_name":"tardis","can_delete":false,"product_type":"c1","uid":2309475,"ip_address":"","ucode":"F33411288D5E27","user_header":"https://static001.geekbang.org/account/avatar/00/23/3d/63/b4466457.jpg","comment_is_top":false,"comment_ctime":1650860002,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"5945827298","product_id":100056701,"comment_content":"quorum：确认odown的最少的哨兵数量<br><br>majority：授权进行主从切换的最少的哨兵数量<br><br>每次一个哨兵要做主备切换，首先需要quorum数量的哨兵认为odown，然后选举出一个哨兵来做切换，这个哨兵还得得到majority哨兵的授权，才能正式执行切换<br><br>如果quorum &lt; majority，比如5个哨兵，majority就是3，quorum设置为2，那么就3个哨兵授权就可以执行切换，但是如果quorum &gt;= majority，那么必须quorum数量的哨兵都授权，比如5个哨兵，quorum是5，那么必须5个哨兵都同意授权，才能执行切换<br>查了一下，上面的就是哨兵判断客观下线，和哨兵选主的算法描述。感觉作者文中把quorum和majority这两个参数当成了一个，看的让人迷糊。想一下，本来就是两个不同的含义，如果只用一个参数来表示，也不符合常理。不过也可能是redis版本不同","like_count":1,"discussions":[{"author":{"id":3039904,"avatar":"https://static001.geekbang.org/account/avatar/00/2e/62/a0/e46bdbeb.jpg","nickname":"粽","note":"","ucode":"7BD43464776385","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":582445,"discussion_content":"我觉得讲的很好，因为看完了我一直在疑惑，主从切换和判断主库的客观下线，这是两个个事情，为什么都用quorum。看完你这个评论，一下子开朗了，我以为只有我觉得文章在这一块讲的有点奇怪？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1659433376,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314014,"user_name":"俯瞰风景.","can_delete":false,"product_type":"c1","uid":1044166,"ip_address":"","ucode":"A6DB68B7B84AEE","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ee/c6/bebcbcf0.jpg","comment_is_top":false,"comment_ctime":1632801400,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5927768696","product_id":100056701,"comment_content":"为了解决主库宕机问题，需要进行监控和重新选主并执行切换，所以引入哨兵机制，而为了减小哨兵误判主库下线的概率，引入了哨兵集群。<br><br>哨兵通过redis的发布&#47;订阅模式可以通过“**sentinel**:hello”频道获取其他哨兵的连接信息，从而和其他哨兵建立哨兵集群，也可以通过info命令从主库获取从库列表，从而实现对从库的监控，另外，客户端也可以订阅哨兵提供的频道，实时获取redis集群中发生的事件，以做出反应。<br><br>哨兵判定主库客观下线后，需要选举出一个Leader来执行切换操作。成为Leader的条件是：<br>  1、拿到半数以上的赞成票；<br>  2、拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。","like_count":1},{"had_liked":false,"id":308428,"user_name":"科科","can_delete":false,"product_type":"c1","uid":1647304,"ip_address":"","ucode":"7DAE6FE781172E","user_header":"https://static001.geekbang.org/account/avatar/00/19/22/c8/f2892022.jpg","comment_is_top":false,"comment_ctime":1629618018,"is_pvip":false,"discussion_count":1,"race_medal":1,"score":"5924585314","product_id":100056701,"comment_content":"好像理解了为什么redis除了要满足大多数的判定条件，还要加一个quorom这个条件，因为如果哨兵挂的特别多的话，剩下的那些哨兵，如果小于等于一半的数量，就永远也无法让redis客观下线。所以还要加一个quorom值。<br>因为这两个哨兵已经都判断了主观下线，两个已经到达了设置的quorom值，所以该数据库可以被判定为主观下线。<br>但是，选主需要大多数哨兵得票数，起码得是总数除以二加上一这么大，也就是说最少也得拿到三票才可以。<br>今天在看mongo的副本集相关内容，发现不管是mango也好还是redis也好，在做冗余的时候都要涉及到“大多数”的概念。<br>mongo这边的解释是说，在网络不好的情况下，副本1，2，3部署在A集群，副本4，5部署在B集群。 AB集群现在连不上，在123的角度上来看是45挂了，在45的角度上来看是123挂了。如果他们两个都有机会进行选主的话，就会产生两个主。所以只有123才有机会选主，45不可能完成选主。也是防止出现多个主。<br>我就联想到redis的哨兵选主大多数的限制应该也是类似的思路，而且在实际的经验上来看，基本上都部署奇数个实例。<br>不知道我这个理解对不对？","like_count":1,"discussions":[{"author":{"id":2762186,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/25/ca/96734ade.jpg","nickname":"随机漫步的傻瓜","note":"","ucode":"FBEFB27BF45ED4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":399493,"discussion_content":"客观下线只和quorom有关，哨兵领导者选举才和两者都有关系，必须都满足","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632974381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269034,"user_name":"蚂蚁","can_delete":false,"product_type":"c1","uid":2371435,"ip_address":"","ucode":"D20553722864CA","user_header":"https://static001.geekbang.org/account/avatar/00/24/2f/6b/27b50c5e.jpg","comment_is_top":false,"comment_ctime":1608478467,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"5903445763","product_id":100056701,"comment_content":"第二个问题：哨兵如果没有给自己投票，就会把票投给第一个给它发送投票请求的哨兵。后续再有投票请求来，哨兵就拒接投票了。<br>————<br>老师请问下，你说的后续再有投票就拒绝投票，那哨兵怎么知道是同一轮的投票呢？怎么判断又是一轮新的投票，可以把这个投票的报文贴上来看看吗","like_count":1,"discussions":[{"author":{"id":1645684,"avatar":"https://static001.geekbang.org/account/avatar/00/19/1c/74/eb472cc3.jpg","nickname":"海强","note":"","ucode":"EF4971CD58E4E5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":349032,"discussion_content":"我没有看过源码，但是如果参照raft的话，会有个任期的概念，每轮投票是基于同一个任期。任期每经过一轮后会递增。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1612855290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1410642,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJQyP4WVaRJVX6j5k8ZblWHo2BicmehWWSz571L8Lou2QWOSxPOg6ib0fuibfic6q6dS3ficLGNibIEo4uw/132","nickname":"果酱","note":"","ucode":"087EF822507201","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540538,"discussion_content":"是term统一了任期，就阻止别的投票了，通过term来判断下一轮是否继续","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640077171,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2027435,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/ef/ab/ea3488c8.jpg","nickname":"Bijiasuo","note":"","ucode":"6DB63A899D184C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":406633,"discussion_content":"每轮投票和mysql中事务概念相似，有一个id，单调递增","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634810357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253650,"user_name":"Hinimix","can_delete":false,"product_type":"c1","uid":1316937,"ip_address":"","ucode":"7994136C93BD89","user_header":"https://static001.geekbang.org/account/avatar/00/14/18/49/b1d864e5.jpg","comment_is_top":false,"comment_ctime":1602818894,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"5897786190","product_id":100056701,"comment_content":"请问：如果3个哨兵节点有1个宕机了，剩下俩有一个判定主库宕了发起投票，另一个收到选举leader回复了Y，这时候这个节点是有2个票的，为什么不能当leader进行主从切换呢","like_count":1,"discussions":[{"author":{"id":1544952,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIsnzhj3J3dmVT7bsv4kiaYStsT24g8tHu0Ynyk0kPhajU1mgbUUeib5bdibtX4TMKBEhSH4Axqrjvsw/132","nickname":"Geek_6e08ee","note":"","ucode":"F6F51303660C0D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":328563,"discussion_content":"说的是5个","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606181214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1602239,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","nickname":"Geek_e8d55e","note":"","ucode":"5F13626B0E1E45","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1544952,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIsnzhj3J3dmVT7bsv4kiaYStsT24g8tHu0Ynyk0kPhajU1mgbUUeib5bdibtX4TMKBEhSH4Axqrjvsw/132","nickname":"Geek_6e08ee","note":"","ucode":"F6F51303660C0D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":334940,"discussion_content":"但是有三个挂了，只剩两个，难道还是按5个算？那我如果想把5个哨兵减少为3个怎么办，重启所有哨兵吗？这点一直没想明白","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608032360,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":328563,"ip_address":""},"score":334940,"extra":""},{"author":{"id":2361231,"avatar":"https://static001.geekbang.org/account/avatar/00/24/07/8f/b11a8cc6.jpg","nickname":"迷失的小廖","note":"","ucode":"389C9310F242DA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1602239,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","nickname":"Geek_e8d55e","note":"","ucode":"5F13626B0E1E45","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":342356,"discussion_content":"节点被动挂掉和主动停掉是两回事，如果是被动挂掉，当然还是按5个来算。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1610644447,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334940,"ip_address":""},"score":342356,"extra":""},{"author":{"id":1253652,"avatar":"https://static001.geekbang.org/account/avatar/00/13/21/14/423a821f.jpg","nickname":"Steven","note":"","ucode":"3FE64459842015","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1602239,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKyobcyicicCQoldZofsS36xrjA2R2hk2F89pu1hCqwjlRaRG4xKkgCicZibEVdOwpfN5rWjEchrsxicSQ/132","nickname":"Geek_e8d55e","note":"","ucode":"5F13626B0E1E45","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383949,"discussion_content":"不用重启，有运行时命令 SENTINEL REMOVE ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626315480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":334940,"ip_address":""},"score":383949,"extra":""}]}]},{"had_liked":false,"id":243618,"user_name":"heyman","can_delete":false,"product_type":"c1","uid":1173894,"ip_address":"","ucode":"92EF9EF1B1B1B3","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg","comment_is_top":false,"comment_ctime":1598233069,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5893200365","product_id":100056701,"comment_content":"老师，请教一下：哨兵和主库建立连接后，通过info来获取从库信息。那么，后续从库有新增或摘除，哨兵是怎样知道的呢？","like_count":1,"discussions":[{"author":{"id":1388092,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2e/3c/eae43616.jpg","nickname":"sid","note":"","ucode":"3D1F9169A19D29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304332,"discussion_content":"事件通知或者哨兵轮询查询吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599548159,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1173894,"avatar":"https://static001.geekbang.org/account/avatar/00/11/e9/86/d34800a4.jpg","nickname":"heyman","note":"","ucode":"92EF9EF1B1B1B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1388092,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2e/3c/eae43616.jpg","nickname":"sid","note":"","ucode":"3D1F9169A19D29","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305886,"discussion_content":"哨兵会周期性执行info命令","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1600103260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":304332,"ip_address":""},"score":305886,"extra":""}]}]},{"had_liked":false,"id":243084,"user_name":"test","can_delete":false,"product_type":"c1","uid":1065849,"ip_address":"","ucode":"9A4973E591DD12","user_header":"https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg","comment_is_top":false,"comment_ctime":1597942224,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5892909520","product_id":100056701,"comment_content":"可以判断客观下线，但是无法进行选主。调大参数对误判有好处。","like_count":1},{"had_liked":false,"id":359196,"user_name":"Geek_590385","can_delete":false,"product_type":"c1","uid":3190922,"ip_address":"江西","ucode":"BE5BDD9180FA0E","user_header":"","comment_is_top":false,"comment_ctime":1665317655,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665317655","product_id":100056701,"comment_content":"通过老师的讲解，我总结以下三点...展开","like_count":0},{"had_liked":false,"id":355095,"user_name":"蔡欧","can_delete":false,"product_type":"c1","uid":1317604,"ip_address":"广东","ucode":"39470A1DCAA7A9","user_header":"https://static001.geekbang.org/account/avatar/00/14/1a/e4/5e2a8190.jpg","comment_is_top":false,"comment_ctime":1661073776,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1661073776","product_id":100056701,"comment_content":"哨兵挂了，主从库还能切换吗 ：只要哨兵集群保证可以选举出Leader就可以切换，否则就不行，例如5个哨兵节点，需要得到3票，如果3个哨兵节点故障，就不能完成切换<br>哨兵集群底层依赖的通讯机制是什么：主Redis的pubsub模式，通过该模式哨兵可以感知其他哨兵和整个Redis集群的其他几点<br>怎么监控哨兵集群的切换过程：哨兵集群底层使用pubsub通讯机制，需要监控指定的主题，即可知道对应的切换过程的事件<br>哨兵集群配置注意点：最好保证哨兵集群每一个几点配置一致，避免配置不一致导致主观下线判定不一致导致Redis集群切换异常","like_count":0},{"had_liked":false,"id":352190,"user_name":"going","can_delete":false,"product_type":"c1","uid":2313353,"ip_address":"","ucode":"3AA83F9B07BE8B","user_header":"https://static001.geekbang.org/account/avatar/00/23/4c/89/82a3ee04.jpg","comment_is_top":false,"comment_ctime":1658451343,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658451343","product_id":100056701,"comment_content":"蒋老师，请教一个问题，由于哨兵下线导致所剩在线哨兵数量少于quorum这时候如何进行选举？<br>","like_count":1},{"had_liked":false,"id":351991,"user_name":"A 拽丫头","can_delete":false,"product_type":"c1","uid":1470434,"ip_address":"","ucode":"F875D99D18DF6E","user_header":"https://static001.geekbang.org/account/avatar/00/16/6f/e2/f3b05833.jpg","comment_is_top":false,"comment_ctime":1658315656,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1658315656","product_id":100056701,"comment_content":"老师呀!  你的标题起的很有吸引力，但能不能在结尾做个总结了，那到底是能切换还是不能切换呀!  看完了这篇文章，感觉对这个问题的回答还是不自信呀!  看了 &quot;精彩的&quot; 评论后，知道答案了。","like_count":0},{"had_liked":false,"id":350887,"user_name":"burning","can_delete":false,"product_type":"c1","uid":1484231,"ip_address":"","ucode":"2D46BF59B01A46","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/c7/053a2a5c.jpg","comment_is_top":false,"comment_ctime":1657284849,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1657284849","product_id":100056701,"comment_content":"请问“客观下线”，这个所需的赞成票数是通过哨兵配置文件中的 quorum 配置项设定的；而第七讲提到当有 N 个哨兵实例时，最好要有 N&#47;2 + 1 个实例判断主库为“主观下线”。如果quorum与N&#47;2 + 1不同时，该如何判断呢","like_count":0},{"had_liked":false,"id":350089,"user_name":"Geek_9adefb","can_delete":false,"product_type":"c1","uid":2980933,"ip_address":"","ucode":"DE7D4E98F892AE","user_header":"","comment_is_top":false,"comment_ctime":1656565974,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1656565974","product_id":100056701,"comment_content":"老师好：在setinal发现master节点客观下线之后，同时在下个master节点被选举出来之前，redis的集群是没法对外提供写服务的吧？<br><br>那可不可以说，redis没有做到AP？","like_count":0},{"had_liked":false,"id":349483,"user_name":"格局","can_delete":false,"product_type":"c1","uid":2481167,"ip_address":"","ucode":"EDF3736A1FAA8C","user_header":"https://static001.geekbang.org/account/avatar/00/25/dc/0f/4d38b101.jpg","comment_is_top":false,"comment_ctime":1655989749,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1655989749","product_id":100056701,"comment_content":"客户端既然能从哨兵订阅消息，必然是与哨兵建立了连接，那么为啥在哨兵主导主从切换完成后，不直接告诉客户端呢？还要通过sub&#47;pub机制操作一下？","like_count":0},{"had_liked":false,"id":348055,"user_name":"+1","can_delete":false,"product_type":"c1","uid":2062412,"ip_address":"","ucode":"9CE97442D75966","user_header":"","comment_is_top":false,"comment_ctime":1654693711,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1654693711","product_id":100056701,"comment_content":"那master被标记成主观下线状态，还没被统一成客观下线状态时，客户端是否还能正常与master进行通信呢","like_count":0},{"had_liked":false,"id":347792,"user_name":"xlyyy","can_delete":false,"product_type":"c1","uid":2995410,"ip_address":"","ucode":"C1962641D7168B","user_header":"https://static001.geekbang.org/account/avatar/00/2d/b4/d2/d83e8d6c.jpg","comment_is_top":false,"comment_ctime":1654434160,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1654434160","product_id":100056701,"comment_content":"请教一下，老师说哨兵是依赖redis的发布订阅功能来通信的，如果主库挂掉了，发布订阅功能还能用吗，如果不能，那这期间哨兵集群互相是如何通信的？","like_count":0},{"had_liked":false,"id":347713,"user_name":"樱桃汁。","can_delete":false,"product_type":"c1","uid":2907715,"ip_address":"","ucode":"36EE9D8B9C5122","user_header":"https://static001.geekbang.org/account/avatar/00/2c/5e/43/004a52fa.jpg","comment_is_top":false,"comment_ctime":1654337827,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654337827","product_id":100056701,"comment_content":"1、可以正确判断客观下线，但是正确率会有所下降<br>    3个挂了还有2个，如果其中一个发送了选举，剩下的一个投赞成票，就可以判断客观下线<br>    正确率下降是因为可能误判，发起选举的哨兵因为网络阻塞等原因PING不通主库<br>2、可以进行自动切换<br>    2个哨兵可以满足监控、选主、通知流程完整<br>3、不是越多越好<br>    实例多了互相选举流程会比较复杂，重新选举的可能性提高、比如9个哨兵，quorum是5，有5个哨兵发起选举<br>4、不一定有好处<br>    个人认为down-after-milliseconds和实例数量没有特别大的关系<br>    以及down-after-milliseconds值在一定范围才有意义，如果很大，主库已经挂了很久才被发现<br><br>最后有一个关于选举的看法，希望老师可以看见给与经验，谢谢~<br>    5个哨兵<br>         哨兵1和哨兵2和哨兵3和哨兵4和哨兵5都发现下线了（暂不考虑上线）<br>         哨兵1先发起选举（票+1）<br>         哨兵1发起选举请求到达哨兵2的时机是哨兵2发现下线之后，并且哨兵2发起选举之前（票+1）<br>         哨兵1发起选举请求到达哨兵3的时机是哨兵3发现下线之后，并且哨兵3发起选举之后（票+0）<br>         哨兵1发起选举请求到达哨兵4的时机是哨兵4发现下线之前（票+0）<br>         哨兵1发起选举请求到达哨兵5的时机是哨兵5发现下线之后，并且已经给哨兵3投票（票+0）<br>         以及其他一些情况<br>总结下来发现选举成功概率大大小于选举失败，这样岂不是很容易多次选举很费时<br>    ","like_count":0},{"had_liked":false,"id":345723,"user_name":"第四单元","can_delete":false,"product_type":"c1","uid":1747184,"ip_address":"","ucode":"3ED9D553E1DE17","user_header":"https://static001.geekbang.org/account/avatar/00/1a/a8/f0/529f15e9.jpg","comment_is_top":false,"comment_ctime":1652525745,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652525745","product_id":100056701,"comment_content":"请教下大家，哨兵什么情况下会“想成为leader”？如果所有哨兵都想成为leader，都给自己投票那不就永远选不出leader了？","like_count":0},{"had_liked":false,"id":342162,"user_name":"helloWorld","can_delete":false,"product_type":"c1","uid":2793822,"ip_address":"","ucode":"E7D28A9F456959","user_header":"https://static001.geekbang.org/account/avatar/00/2a/a1/5e/4c53cb49.jpg","comment_is_top":false,"comment_ctime":1650077358,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1650077358","product_id":100056701,"comment_content":"哨兵节点选举完新的主库，这时主库有从库数据吗？采用INFO命令获取从库信息再让从库执行salveof命令","like_count":0},{"had_liked":false,"id":341369,"user_name":"阿昕","can_delete":false,"product_type":"c1","uid":1012906,"ip_address":"","ucode":"F3AD093B68E074","user_header":"https://static001.geekbang.org/account/avatar/00/0f/74/aa/178a6797.jpg","comment_is_top":false,"comment_ctime":1649569753,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1649569753","product_id":100056701,"comment_content":"1.可以正确的判断客观下线和主从切换，但是在哨兵实例都在线时，会发生脑裂问题；<br>2.哨兵实例太多，会加大选主等过程的投票时间；<br>3.down-after-millsecodnes过大会影响恢复的等待时间；","like_count":0},{"had_liked":false,"id":340377,"user_name":"黄巍","can_delete":false,"product_type":"c1","uid":2543966,"ip_address":"","ucode":"F1ED280179EA67","user_header":"","comment_is_top":false,"comment_ctime":1648784033,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648784033","product_id":100056701,"comment_content":"老师，如果客户端连接的哨兵挂了，另外的哨兵还正常启动，客户端也连接主库进行正常读写，当主库发生切换的时候，由于直连的哨兵也挂了，客户端无法通过订阅事件来获取主库切换的信息，那么客户端这个时候是不是不可用情况呀？","like_count":0},{"had_liked":false,"id":339761,"user_name":"剑八","can_delete":false,"product_type":"c1","uid":1297630,"ip_address":"","ucode":"0A09F41DB8A4E7","user_header":"https://static001.geekbang.org/account/avatar/00/13/cc/de/e28c01e1.jpg","comment_is_top":false,"comment_ctime":1648365262,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1648365262","product_id":100056701,"comment_content":"sentinal选举可以等待随机时间再发起， 这样避免两个选举者同一时刻选举争抢导致的迟迟达不成一致的问题","like_count":0},{"had_liked":false,"id":338608,"user_name":"William Ning","can_delete":false,"product_type":"c1","uid":1592279,"ip_address":"","ucode":"4DB8D05E69E5F3","user_header":"https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg","comment_is_top":false,"comment_ctime":1647593765,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1647593765","product_id":100056701,"comment_content":"老师同学好，关于文中，“在投票过程中，任何一个想成为 Leader 的哨兵，要满足两个条件：第一，拿到半数以上的赞成票；第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值”<br><br>有疑问，<br>条件一，这个半数以上，包不包含半数，<br>另外，这个总数，是怎么计算的，原始的哨兵数，还是剩余存活的数量？<br><br>谢谢～","like_count":0},{"had_liked":false,"id":335736,"user_name":"kls","can_delete":false,"product_type":"c1","uid":1446570,"ip_address":"","ucode":"9DC31790DD6924","user_header":"https://static001.geekbang.org/account/avatar/00/16/12/aa/83a3cd03.jpg","comment_is_top":false,"comment_ctime":1645669080,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1645669080","product_id":100056701,"comment_content":"老师，哨兵进行 客观下线，选举新的主节点的期间，整个集群对外是不可写入的状态吗？<br>从节点是可以被 客户端读取数据的吧？","like_count":0,"discussions":[{"author":{"id":1183318,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0e/56/2c5691b2.jpg","nickname":"布兜兜","note":"","ucode":"E8B0F47D52E826","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558362,"discussion_content":"Redis应该是ap 模型，选主期间不能对外提供服务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648256210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":335595,"user_name":"平衡的红果","can_delete":false,"product_type":"c1","uid":1264687,"ip_address":"","ucode":"FC06861D00B9B1","user_header":"https://static001.geekbang.org/account/avatar/00/13/4c/2f/3ec98bc1.jpg","comment_is_top":false,"comment_ctime":1645599782,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1645599782","product_id":100056701,"comment_content":"进行主从切换的过程中，redis还能正常执行写操作么？","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554071,"discussion_content":"不能，所以要合理配置down-after-milliseconds的值，太大影响业务时间过长，太小容易误判","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646205540,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334554,"user_name":"rjkfs","can_delete":false,"product_type":"c1","uid":2174117,"ip_address":"","ucode":"082A71EDBD415A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/OOLN4OJeQSBXnc1YoVIu2uvBS7OGDeicsfMhQGsC8HddfhsH0xrf4KCjvsR31SABLy6uz88c1GOnIpjXlY3Uqvw/132","comment_is_top":false,"comment_ctime":1644999293,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1644999293","product_id":100056701,"comment_content":"老师请教一下：<br>老师在文章中介绍到：客户端可以从哨兵订阅消息，那么存在多个哨兵的情况下，客户端是怎么订阅的哨兵呢？<br>1、若是客户端配置了所有哨兵信息，那么怎么在众多哨兵中选择的一个哨兵订阅消息呢？负载均衡吗？<br>2、若是客户端只选择其中一个哨兵订阅消息，那么该订阅的哨兵正好下线了，客户端就与服务失联了？","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554080,"discussion_content":"1、跟客户端实现有关，以Java的lettuce为例，会依次连接sentinel（就是从头遍历这个list，没有特殊的算法，也没有负载均衡），直到连接成功，如果都不成功，就连接失败而报错。\n2、任何一个合格的数据库连接池，都会做连接保活，如果正好哨兵下线，连接池再重新连一个就好了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646207106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331722,"user_name":"lobby","can_delete":false,"product_type":"c1","uid":1181960,"ip_address":"","ucode":"8D81722BE36AD4","user_header":"https://static001.geekbang.org/account/avatar/00/12/09/08/f3547e77.jpg","comment_is_top":false,"comment_ctime":1642736785,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1642736785","product_id":100056701,"comment_content":"quorum这个数量可以用于判定主库客观下线，却不能用于哨兵选主，是因为选leader的算法自身理论的性质，还是其他的什么原因呢","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554082,"discussion_content":"因为sentinel选leader是基于raft协议，raft协议必须半数以上投票","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646207263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":330084,"user_name":"Lee","can_delete":false,"product_type":"c1","uid":1344535,"ip_address":"","ucode":"6B8D59A0B1A1A9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqOn7k48KXia5rf0eXpzv2EGtqGibz3eNb8QnL8X72uia0g1rBwzXef4dV2JEdz3r4bu9GC1FLIeic4UA/132","comment_is_top":false,"comment_ctime":1641791478,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1641791478","product_id":100056701,"comment_content":"询问另一个哨兵时，如果刚好这个哨兵已经发送了心跳检测，还会再发一次，最后告诉发起询问的哨兵，ping的结果？","like_count":0},{"had_liked":false,"id":328153,"user_name":"小陶子","can_delete":false,"product_type":"c1","uid":2530294,"ip_address":"","ucode":"96B606717EC3FB","user_header":"https://static001.geekbang.org/account/avatar/00/26/9b/f6/f81cc835.jpg","comment_is_top":false,"comment_ctime":1640575687,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1640575687","product_id":100056701,"comment_content":"请问，哨兵实例和数据库实例在数量上有关系吗，可以哨兵实例和数据库实例数量不一样吗","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554083,"discussion_content":"可以，没有必然联系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646207310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":325318,"user_name":"树心","can_delete":false,"product_type":"c1","uid":1589523,"ip_address":"","ucode":"6C329F0FF798B9","user_header":"https://static001.geekbang.org/account/avatar/00/18/41/13/ab14ad25.jpg","comment_is_top":false,"comment_ctime":1638923601,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"1638923601","product_id":100056701,"comment_content":"第6-9小节讲解了如何通过减少服务中断提高redis可靠性。<br>首先是通过主从库模式（第6节），增加从库冗余备份，主从之间可以增量备份。<br>但是主库可能会挂掉，那么就需要主从切换，这时需要哨兵（第7节）判断主库下线、选出新主库并通知从库。<br>架构演进到这一步发现哨兵也可能会挂掉，那么提供哨兵集群机制（第8节）。哨兵与哨兵之间、哨兵和从库之间、哨兵和客户端之间通过pub&#47;sub机制建立连接。确定哪个哨兵执行主从切换也是一个“投票仲裁”的过程。最后，老师分享了一个经验：要保证所有哨兵实例的配置是一致的，尤其是主观下线的判断值 down-after-milliseconds。","like_count":0},{"had_liked":false,"id":320802,"user_name":"InfoQ_小汤","can_delete":false,"product_type":"c1","uid":1739070,"ip_address":"","ucode":"E4C30DB7A9B54C","user_header":"https://static001.geekbang.org/account/avatar/00/1a/89/3e/0dd8e96b.jpg","comment_is_top":false,"comment_ctime":1636515133,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1636515133","product_id":100056701,"comment_content":"想问老师一个问题 假如有5个哨兵实例 设置quorum为5，单5个哨兵都认为主节点下线，这个这个时候主哨兵投票需要3票以上就可以进行主从切换还是必须要5票？<br><br>按照老师文章说的是过半就可以 感觉这个说法跟官网的有点出出入","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554084,"discussion_content":"必须5票","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646207345,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316489,"user_name":"Wind","can_delete":false,"product_type":"c1","uid":1887603,"ip_address":"","ucode":"AD108636DE44C4","user_header":"https://static001.geekbang.org/account/avatar/00/1c/cd/73/f6889c2f.jpg","comment_is_top":false,"comment_ctime":1634353474,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634353474","product_id":100056701,"comment_content":"我补充一句：为什么主从切换的Leader强制要求一定要票数过半？因为主从切换是整个高可用里面至关重要的事情，这个设定是避免用户把quorum值设置过低，选出两个Leader，导致主从切换混乱（票数要求一定要过半，意味着不可能出现两个Leader情况了）<br><br>换句话说，对于主从切换选Leader，用户可以通过 quorum来增加达到共识的要求，但是不能降低到集群数量的一半。<br><br>知道这一点的话，老师特别标注的，两个哨兵情况需要获取两票就不难理解了，如果只有一票情况下，不满足票数过半（并且也不知道另外一票是不是对方投给自己了）","like_count":0},{"had_liked":false,"id":308471,"user_name":"赴","can_delete":false,"product_type":"c1","uid":2675954,"ip_address":"","ucode":"D47B3179BE3950","user_header":"https://static001.geekbang.org/account/avatar/00/28/d4/f2/3c0bfa0e.jpg","comment_is_top":false,"comment_ctime":1629636181,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1629636181","product_id":100056701,"comment_content":"有大佬回答小结问题，说不能主从切换。从文章里可以看到，哨兵是可以知道其它哨兵的信息的，如果其它故障了，为什么不做着，以他们下线为准。总哨兵就是2个。那主从切换不就可以了。redis不这么设置的原因是为什么","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":396500,"discussion_content":"试着回答一下，哨兵的选leader是不进行通知的，都是自行判断票数后达标既可，如果不用总数，而用哨兵的有效节点数，failover期间故障的节点可能又正常了，巧合又过半数了，有可能同时进行两次的选主","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632446835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":305116,"user_name":"Heaven","can_delete":false,"product_type":"c1","uid":1694207,"ip_address":"","ucode":"FA33FBCC66C911","user_header":"https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg","comment_is_top":false,"comment_ctime":1627826508,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1627826508","product_id":100056701,"comment_content":"不能做到主从切换,因为必须要拿到一个多数的选票<br>然后如果调大down-after-milliseconds的值,可以减低误判,但是会加大真正出现下线时候的主从切换时间,影响业务<br>","like_count":0},{"had_liked":false,"id":303700,"user_name":"leyuan","can_delete":false,"product_type":"c1","uid":1546485,"ip_address":"","ucode":"D7D9205A9B3B2A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/AJmpR2F7VOW8z4Q5OKj4MqQMpWBcj6880QUZTv5bf7SLpLzhtUEGh1krnLyV4jiaGFp3V5S96uvzO7dGmh4mmWQ/132","comment_is_top":false,"comment_ctime":1626937076,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626937076","product_id":100056701,"comment_content":"是不是还有一个进程去执行客观下线和哨兵leader选举的执行，类似裁判的角色，还是哨兵自己承担了这个角色","like_count":0},{"had_liked":false,"id":301492,"user_name":"Inno","can_delete":false,"product_type":"c1","uid":2142543,"ip_address":"","ucode":"8CB14D9A54CC9B","user_header":"https://static001.geekbang.org/account/avatar/00/20/b1/4f/f0b9b11d.jpg","comment_is_top":false,"comment_ctime":1625714612,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1625714612","product_id":100056701,"comment_content":"有一个问题，判定主库客观线下的quorum值与哨兵选举leader的quorum是同一个吗？","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":396512,"discussion_content":"是的，leader选举还有个值要判断，那就是总数过半的投票数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632447310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300967,"user_name":"hosea","can_delete":false,"product_type":"c1","uid":1139587,"ip_address":"","ucode":"59F44F97A6288F","user_header":"https://static001.geekbang.org/account/avatar/00/11/63/83/17d246f1.jpg","comment_is_top":false,"comment_ctime":1625472262,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1625472262","product_id":100056701,"comment_content":"果哨兵之间是通过master节点来通讯的，哨兵a发现了master节点a挂了 假设是网络问题，他怎么通知别的哨兵节点，是不是也要运用从节点的发布和订阅","like_count":0,"discussions":[{"author":{"id":1357315,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoVRER40LhyAhBK6YgPYibRzWARkc3efUquib4j9BPru4y8FfvXK2sBPbXej9314pZdfdcxb07RcjZw/132","nickname":"酷酷的嵩","note":"","ucode":"EF249E96F42491","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":386818,"discussion_content":"哨兵是通过pubsub来感知其他哨兵的地址，之后哨兵间建立连接通信，不需要依赖master了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1627818175,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":300185,"user_name":"bigben","can_delete":false,"product_type":"c1","uid":1169313,"ip_address":"","ucode":"DBD15A6C8E2590","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJkeOAC8k7aPMfQZ4ickiavpfR9mTQs1wGhGtIicotzAoszE5qkLfFTabkDU2E39ovSgoibJ1IiaLXtGicg/132","comment_is_top":false,"comment_ctime":1625039207,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1625039207","product_id":100056701,"comment_content":"每个哨兵的频道发布的数据是不是不一样？那不同的客户端连接不同的哨兵，得到的通知也是不一样的喽？","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389175,"discussion_content":"哨兵的频道主要是pub一些监控选主通知这些主从切换过程中关键事件的状态，应该是一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629166898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":297337,"user_name":"--","can_delete":false,"product_type":"c1","uid":1284574,"ip_address":"","ucode":"99ECDDCFAF477D","user_header":"https://static001.geekbang.org/account/avatar/00/13/99/de/a8b1e731.jpg","comment_is_top":false,"comment_ctime":1623467650,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1623467650","product_id":100056701,"comment_content":"从库也需要 __sentinel__:hello 吧","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389172,"discussion_content":"应该不需要吧。按理来说从库与从库之间都是独立的，不需要进行相互通信","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629166585,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":296304,"user_name":"“”","can_delete":false,"product_type":"c1","uid":1158276,"ip_address":"","ucode":"37C98AE6E7ABDB","user_header":"https://static001.geekbang.org/account/avatar/00/11/ac/84/0411ee6e.jpg","comment_is_top":false,"comment_ctime":1622892212,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622892212","product_id":100056701,"comment_content":"您好 请教下 创建哨兵实例时候 和每个master创建了两个链接 cc 和 pc， 请问创建pc 的目的是什么，用cc 完成hello频道的注册不行吗？ 我目前觉得源代码里创建pc链接的作用为0 但是肯定有什么目的我是在不得而知 目前唯一猜测是 因为异步创建了cc 如果想用cc完成注册hello频道的话 要在cc链接回调里来注册 请赐教。","like_count":0},{"had_liked":false,"id":295205,"user_name":"ldd","can_delete":false,"product_type":"c1","uid":1048068,"ip_address":"","ucode":"7045284AF9038B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fe/04/7ef0b0b8.jpg","comment_is_top":false,"comment_ctime":1622296958,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1622296958","product_id":100056701,"comment_content":"redis也太费机器了","like_count":0},{"had_liked":false,"id":291923,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1620609885,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620609885","product_id":100056701,"comment_content":"课后习题<br><br>客观下线：可以。<br>s1 询问是否主观下线，s2 表示 master 已主观下线。2台 slave 判定主观下线，大于等于 quorum。判定 master 客观下线。<br>注意，这里和 leader 选举的投票不同，没有投完了就不能再投这限制。<br><br>主从自动切换：不行。<br>虽然能满足 quorum 条件，但是不满足超过半数：5&#47;2+1=3。","like_count":0},{"had_liked":false,"id":291612,"user_name":"BertGeek","can_delete":false,"product_type":"c1","uid":1452799,"ip_address":"","ucode":"8E1D72C9F9778C","user_header":"https://static001.geekbang.org/account/avatar/00/16/2a/ff/a9d72102.jpg","comment_is_top":false,"comment_ctime":1620383162,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620383162","product_id":100056701,"comment_content":"1. 假设有一个 Redis 集群，是“一主四从”，同时配置了包含 5 个哨兵实例的集群，quorum 值设为 2。<br>在运行过程中，如果有 3 个哨兵实例都发生故障了，<br>此时，Redis 主库如果有故障，可以正常进行故障切换。<br>仅有的2个哨兵同时判定主库客观下线<br><br>2. 主从库自动切换吗也支持<br><br>3. 哨兵实例不是越多越好，实例级数多，指令信息交互更复杂，等待选举信号延迟、网络波动等环境复杂<br>","like_count":0},{"had_liked":false,"id":288900,"user_name":"第四单元","can_delete":false,"product_type":"c1","uid":1747184,"ip_address":"","ucode":"3ED9D553E1DE17","user_header":"https://static001.geekbang.org/account/avatar/00/1a/a8/f0/529f15e9.jpg","comment_is_top":false,"comment_ctime":1618756203,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1618756203","product_id":100056701,"comment_content":"请问每次判断主库下线后，都要重新选一遍leader吗？还是Leader选出一次后就固定了。","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389170,"discussion_content":"应该是一次性的，不是固定的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629166174,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":288449,"user_name":"杨","can_delete":false,"product_type":"c1","uid":1971269,"ip_address":"","ucode":"7EFEFE285975C6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/oltLEqTrmHm2aJP99BK6tHu5h7hp4aj08wR5Wt6H31iadFduDAVvjYKmhQ2nvGbLV3lkVdiat2GRasgWXoJeTibUg/132","comment_is_top":false,"comment_ctime":1618473553,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1618473553","product_id":100056701,"comment_content":"毫不犹豫的踩进坑  自己认为应该是能主从切换的   看了下面的解释意外但又合乎常理 果然实践是检验真理的唯一标准  ","like_count":0},{"had_liked":false,"id":287206,"user_name":"而立斋","can_delete":false,"product_type":"c1","uid":1087258,"ip_address":"","ucode":"5FED6E9E148195","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/1a/389eab84.jpg","comment_is_top":false,"comment_ctime":1617839783,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617839783","product_id":100056701,"comment_content":"这里的频道其实也应该是对redis基础能力的封装。也是kv进行存储，所以它的一些所谓的过期，持久化等问题都是redis的底层能力包圆儿了。<br><br>还有一个问题不太清晰，客户端知道主从切换的进度干啥？它不是只知道结果就行啦？","like_count":0},{"had_liked":false,"id":286602,"user_name":"ausehk","can_delete":false,"product_type":"c1","uid":2222217,"ip_address":"","ucode":"51907491F3477B","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erTxyBgqxZZ5sLGJYicO2ibQURNnGynnQChpfLgq3QgV6eWhw3agYzDz5zDFQ8SNhdbb4ibKdmvTyuHw/132","comment_is_top":false,"comment_ctime":1617419589,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617419589","product_id":100056701,"comment_content":"老师请教下：<br>redis启动了多少个实例就会配置多少个哨兵吗？哨兵跟实例是否是一一对应的。看您的举例图上面是三个哨兵后面是一主三从，这点让我有点迷茫。<br>","like_count":0},{"had_liked":false,"id":285990,"user_name":"Geek_c98a70","can_delete":false,"product_type":"c1","uid":2290127,"ip_address":"","ucode":"17D5ACBF7E44B7","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epIdmlBLywcLF3ADKyicFoRkVocJnu0CBbv6wYMeNGDEKlXRicaok498ybaozAzZbpr8qn8fA3LCdBA/132","comment_is_top":false,"comment_ctime":1617095742,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1617095742","product_id":100056701,"comment_content":"我用的cluster模式3主3从，不用哨兵也能正常切换，请教下，是不是如果一主多从就必须使用哨兵模式了？","like_count":0,"discussions":[{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375605,"discussion_content":"不是必须 如果有更好的自研方案可以不用。集群模式是基于哨兵做开发的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621765194,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285745,"user_name":"脱缰的野马__","can_delete":false,"product_type":"c1","uid":1447569,"ip_address":"","ucode":"D5F993E7232C61","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/WtHCCMoLJ2DvzqQwPYZyj2RlN7eibTLMHDMTSO4xIKjfKR1Eh9L98AMkkZY7FmegWyGLahRQJ5ibPzeeFtfpeSow/132","comment_is_top":false,"comment_ctime":1616999788,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1616999788","product_id":100056701,"comment_content":"老师您好！请问两个问题。这里有你说的一段话：“哨兵如果没有给自己投票，就会把票投给第一个给它发送投票请求的哨兵。后续再有投票请求来，哨兵就拒接投票了”。<br>问题1：某一次投票无法选出Leader，停一段时间之后，某个哨兵之前给别人投票的记录是会清空吧？不然新的选举那不是还是会给拒绝投票？具体是怎么做的呢？<br>问题2：某个哨兵收到其它哨兵的拉票请求，首先不会进行安全验证什么的吗？只要有拉票请求进来，还没投过票就会答应第一次拉票的请求？那如果黑客创建的恶意哨兵节点或者恶意请求，不是会严重干扰哨兵集群？","like_count":0},{"had_liked":false,"id":284322,"user_name":"escray","can_delete":false,"product_type":"c1","uid":1020525,"ip_address":"","ucode":"1F4204930E47C4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/92/6d/becd841a.jpg","comment_is_top":false,"comment_ctime":1616167244,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"1616167244","product_id":100056701,"comment_content":"哨兵是一个运行在特定模式下的 Redis 实例，不服务请求操作，只完成监控、选主和通知的任务。<br><br>如果哨兵集群只有 2 个实例，那么一个哨兵想要成为 Leader，就必须获得两票，那么这个时候，就很容易平分（死锁）。<br><br>有一个疑问，哨兵是单独部署还是和 Redis 的节点部署在一起？我觉得可能是部署在一起的。<br><br>对于课后题，因为没有实战经验，只能当做思考练习来做。<br><br>我觉的在“一主四从” + 5 个哨兵实例的集群，如果 3 个哨兵实例故障，而 quorum 的值是 2，似乎能够判断出主库“客观下线”，但是在选主的时候，有可能会遇到问题。<br><br>哨兵似乎并不是越多越好，最好是单数，但是多了之后也容易起冲突。<br><br>如果调大 down-after-milliseconds 的值，那么可能在主库“客观下线”之后很长一段时间没有办法确认，影响主从切换，进而影响业务。","like_count":0},{"had_liked":false,"id":283980,"user_name":"浩瀚有边","can_delete":false,"product_type":"c1","uid":1087384,"ip_address":"","ucode":"B4540E94EAFFE0","user_header":"https://static001.geekbang.org/account/avatar/00/10/97/98/5ef15aa0.jpg","comment_is_top":false,"comment_ctime":1616028659,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1616028659","product_id":100056701,"comment_content":"如果主库挂了，哨兵集群就要选举leader来执行主从切换，如果经过几轮投票才选出，那这个过程redis集群对外就无法提供写服务，有没有好的解决办法呢？","like_count":0,"discussions":[{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375606,"discussion_content":"把请求记录下来 再回放 只不过回放完成前写操作不能对外","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621765250,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":278327,"user_name":"八百","can_delete":false,"product_type":"c1","uid":1253530,"ip_address":"","ucode":"79F1F79ADF5A00","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/9a/3b1c65fd.jpg","comment_is_top":false,"comment_ctime":1612881355,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1612881355","product_id":100056701,"comment_content":"第一轮投票没有达到共识，选出leader哨兵，第二轮的时候怎么知道自己还可以投票？超时重置投票机会？还是会有一个轮数的标志？","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389177,"discussion_content":"每轮投票都有一个纪元（epoch）的概念，可以简单理解为一个递增版本号。选主后超过一定时间还没选出来会，递增一个版本号重新开始","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629167120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":278114,"user_name":"Jaime","can_delete":false,"product_type":"c1","uid":1078333,"ip_address":"","ucode":"904192CC4E916F","user_header":"https://static001.geekbang.org/account/avatar/00/10/74/3d/54bbc1df.jpg","comment_is_top":false,"comment_ctime":1612768083,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1612768083","product_id":100056701,"comment_content":"问问老师，哨兵可以跟主库从库部署在同一台机器上，还是必须要单独部署呢？","like_count":0},{"had_liked":false,"id":277504,"user_name":"ladba","can_delete":false,"product_type":"c1","uid":1232522,"ip_address":"","ucode":"78ADCE66B403A4","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/K8uoNDBqLNQicA8KOecJIb6DWrt7YJuy99VsVpAqPZia2SzSGyECAaPhFU5td1cO9wqjWIqLWIzfxd5DqmUXTKibw/132","comment_is_top":false,"comment_ctime":1612435649,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1612435649","product_id":100056701,"comment_content":"这些频道，我理解为像kafka中的topic的概念。这个哨兵机制感觉集成了raft和消息订阅。","like_count":0},{"had_liked":false,"id":276687,"user_name":"silentyears","can_delete":false,"product_type":"c1","uid":1061748,"ip_address":"","ucode":"6E137BFEB874CA","user_header":"https://static001.geekbang.org/account/avatar/00/10/33/74/d9d143fa.jpg","comment_is_top":false,"comment_ctime":1612078291,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1612078291","product_id":100056701,"comment_content":"请问老师：<br>文中“”让客户端从哨兵这里订阅消息了。具体的操作步骤是，客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接”     <br>1、配置的哨兵如果挂了怎么办？<br>2、多个客户端监听到的来自不同哨兵的事件是否会不一致？<br>3、哨兵leader是只有在指挥主&#47;从切换过程时才有的概念吗？","like_count":0},{"had_liked":false,"id":275553,"user_name":"林肯","can_delete":false,"product_type":"c1","uid":1008582,"ip_address":"","ucode":"D2C97220230DE5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/63/c6/d6ea3df3.jpg","comment_is_top":false,"comment_ctime":1611582824,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1611582824","product_id":100056701,"comment_content":"哨兵机制有点类似于kafka中的zookeeper，kafka是引入外部注册中心，redis是自己实现一套","like_count":0,"discussions":[{"author":{"id":1980201,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg","nickname":"凯文小猪","note":"","ucode":"36D8AD0229547F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375607,"discussion_content":"用zk是因为当时自己写一套raft比较繁琐 2.8的版本已经拿掉了 自己写了kraft","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621765324,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":274528,"user_name":"hpfish","can_delete":false,"product_type":"c1","uid":1217377,"ip_address":"","ucode":"86DB066E5B6D89","user_header":"https://static001.geekbang.org/account/avatar/00/12/93/61/3e4607c7.jpg","comment_is_top":false,"comment_ctime":1611047671,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611047671","product_id":100056701,"comment_content":"老师，有个问题请教下，我在鲲鹏环境（arm64）通过k8s部了3个节点的哨兵，碰到一个问题，哨兵老是会主动 +reboot master mymaster，并且也没有触发故障转移，Redis的版本是4.0.12，想问一下有没有好的定位手段","like_count":0},{"had_liked":false,"id":273879,"user_name":"CityAnimal","can_delete":false,"product_type":"c1","uid":1139902,"ip_address":"","ucode":"206491F70572AE","user_header":"https://static001.geekbang.org/account/avatar/00/11/64/be/12c37d15.jpg","comment_is_top":false,"comment_ctime":1610703523,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1610703523","product_id":100056701,"comment_content":"笔记打卡<br>    * [ ] 哨兵集群中的多个实例共同判断，可以降低对**主库下线**的**误判率**<br>    * [ ] 配置<br>        * [ ] sentinel monitor &amp;lt;master-name&amp;gt; &amp;lt;ip&amp;gt; &amp;lt;redis-port&amp;gt; &amp;lt;quorum&amp;gt;<br>            * [ ] **quorum**: the number of Sentinels that need to agree about the fact the master is not reachable<br>            * [ ] **Sentinel never starts a failover if the majority of Sentinel processes are unable to talk**<br>    * [ ] 哨兵集群组成: 基于 **pub&#47;sub** 机制<br>        * [ ] 哨兵发现：<br>            * [ ] 主库频道“__sentinel__:hello”，不同哨兵通过它相互发现，实现互相通信<br>        * [ ] 发现从库<br>            * [ ] 向主库发送 INFO 命令<br>    * [ ] 基于 pub&#47;sub 机制的客户端事件通知<br>        * [ ] 事件：主库下线事件<br>            * [ ] +sdown : 实例进入“主观下线”状态<br>            * [ ] -sdown : 实例退出“主观下线”状态<br>            * [ ] +odown : 实例进入“客观下线”状态<br>            * [ ] -odown : 实例退出“客观下线”状态<br>        * [ ] 事件：从库重新配置事件<br>            * [ ] +slave-reconf-sent : 哨兵发送 SLAVEOF 命令重新配置从库<br>            * [ ] +slave-reconf-inprog : 从库配置了新主库，但尚未进行同步<br>            * [ ] +slave-reconf-done : 从库配置了新主库，且完成同步<br>        * [ ] 事件：新主库切换<br>            * [ ] +switch-master : 主库地址发生变化<br>    * [ ] 由哪个哨兵执行主从切换？<br>        * [ ] 一个哨兵获得了仲裁**所需的赞成票数**后，就可以标记主库为“客观下线”<br>            * [ ] 所需的赞成票数 &amp;lt;= quorum 配置项<br>        * [ ] “Leader 选举”<br>            * [ ] 两个条件：<br>                * [ ] 拿到半数以上的赞成票<br>                * [ ] 拿到的票数&amp;gt;= quorum<br>            * [ ] 如果未选出，则集群会等待一段时间（哨兵故障转移超时时间的 2 倍），再重新选举<br>    * [ ] 经验：要保证所有哨兵实例的**配置是一致**的<br>        * [ ] 尤其是主观下线的判断值 down-after-milliseconds","like_count":0,"discussions":[{"author":{"id":1102245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d1/a5/2bbedc3b.jpg","nickname":"over","note":"","ucode":"FE272AC19842D3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376168,"discussion_content":"用什么软件导出来的？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621999793,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":272376,"user_name":"大阿拉伯人","can_delete":false,"product_type":"c1","uid":1012981,"ip_address":"","ucode":"C0FC9D58B7F7D6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Ieq85mIZlQOujShKNS1j3nJa3KXmxG9ib3CoxHibmBlbLGUs6SURZS5XuOyb9El9McLWs25NNVZo5TUazErUEGVg/132","comment_is_top":false,"comment_ctime":1610071264,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1610071264","product_id":100056701,"comment_content":"老师问下：有两台机器分别为master&#47;slave，这两台上有分别各有一个哨兵实例，现在master机器挂了，我如果设置quorum的值为1，能正常切换吗","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"木几丶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373411,"discussion_content":"能判定客观下线，但不能正常切换。选举的时候要超过半数的赞成票，2台挂了1台是没办法完成的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620720702,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1022411,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/99/cb/8964faab.jpg","nickname":"-只是小小配角_","note":"","ucode":"EFC1CD54A23F39","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348402,"discussion_content":"认为quorum设置成1可以完成故障恢复，但设置成1会导致误判的情况大量发生，主从切换增多，对集群可用性有影响","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612535134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270135,"user_name":"Andrew.Fang","can_delete":false,"product_type":"c1","uid":2359194,"ip_address":"","ucode":"1D754BBFC223F4","user_header":"https://static001.geekbang.org/account/avatar/00/23/ff/9a/f7d84a69.jpg","comment_is_top":false,"comment_ctime":1608948925,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608948925","product_id":100056701,"comment_content":"具体项目中哨兵集群应该放在哪些机器上，是每个主从库都有一个哨兵，还是一台机器上可以多个哨兵，还是单独一台没有redis实例的机器上运行哨兵?<br>还有，两个处理不同业务的redis主从集群可以用一套哨兵集群来监控吗?","like_count":0},{"had_liked":false,"id":261134,"user_name":"花开季末","can_delete":false,"product_type":"c1","uid":1113883,"ip_address":"","ucode":"5D44075AEB737D","user_header":"https://static001.geekbang.org/account/avatar/00/10/ff/1b/09b4d12f.jpg","comment_is_top":false,"comment_ctime":1605226063,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1605226063","product_id":100056701,"comment_content":"小白提问：<br>请问老师，哨兵间的通信是通过发布自己的IP地址到主，其他哨兵订阅的方式实现的。<br>那么是每一个哨兵都需要发布自己的IP到主吗？","like_count":0,"discussions":[{"author":{"id":1232522,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/K8uoNDBqLNQicA8KOecJIb6DWrt7YJuy99VsVpAqPZia2SzSGyECAaPhFU5td1cO9wqjWIqLWIzfxd5DqmUXTKibw/132","nickname":"ladba","note":"","ucode":"78ADCE66B403A4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":348134,"discussion_content":"我理解是的，一个主库通信的所有哨兵为一个集群。所以我们在初始化哨兵的时候，其实已经确定了一个哨兵集群","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612435841,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259811,"user_name":"明月几时","can_delete":false,"product_type":"c1","uid":1675716,"ip_address":"","ucode":"E46C844EAB2CD0","user_header":"https://static001.geekbang.org/account/avatar/00/19/91/c4/bcdcda65.jpg","comment_is_top":false,"comment_ctime":1604845522,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1604845522","product_id":100056701,"comment_content":"哨兵机制，它可以实现主从库的自动切换。通过部署多个实例，就形成了一个哨兵集群。哨兵集群中的多个实例共同判断，可以降低对主库下线的误判率。<br>","like_count":0},{"had_liked":false,"id":258971,"user_name":"好好学习","can_delete":false,"product_type":"c1","uid":1762191,"ip_address":"","ucode":"9D44D9530D9A1D","user_header":"https://static001.geekbang.org/account/avatar/00/1a/e3/8f/77b5a753.jpg","comment_is_top":false,"comment_ctime":1604589284,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604589284","product_id":100056701,"comment_content":"哨兵通过想主库发送消息，获取从库的信息，以此建立连接。","like_count":0},{"had_liked":false,"id":258969,"user_name":"好好学习","can_delete":false,"product_type":"c1","uid":1762191,"ip_address":"","ucode":"9D44D9530D9A1D","user_header":"https://static001.geekbang.org/account/avatar/00/1a/e3/8f/77b5a753.jpg","comment_is_top":false,"comment_ctime":1604589237,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604589237","product_id":100056701,"comment_content":"哨兵连接主从库，可以判断是否主观，客观下线。<br>客户端订阅频道，可以接收哨兵发布的消息，比如主库切换。","like_count":0},{"had_liked":false,"id":256817,"user_name":"Lenny👣","can_delete":false,"product_type":"c1","uid":1433639,"ip_address":"","ucode":"EC3DDE27BB0138","user_header":"https://static001.geekbang.org/account/avatar/00/15/e0/27/40aa4e30.jpg","comment_is_top":false,"comment_ctime":1603759297,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603759297","product_id":100056701,"comment_content":"老师好，想确认一个事情，哨兵模式中，客户端每次请求都是通过哨兵跟主服务器通信，还是通过哨兵拿到主服务器ip端口后直接连接服务器通信？","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389180,"discussion_content":"根据sentinel的定义和定位应该是第一种情况","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629168204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255418,"user_name":"Reborn 2.0","can_delete":false,"product_type":"c1","uid":1977474,"ip_address":"","ucode":"BA506E7455D91C","user_header":"https://static001.geekbang.org/account/avatar/00/1e/2c/82/98e2b82a.jpg","comment_is_top":false,"comment_ctime":1603339509,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603339509","product_id":100056701,"comment_content":"客观下线 和 leader选举公用的一个quorum值, 因为他们都是sentinels之间的投票. 但是客观下线和leader选举是两个步骤?","like_count":0},{"had_liked":false,"id":255414,"user_name":"Reborn 2.0","can_delete":false,"product_type":"c1","uid":1977474,"ip_address":"","ucode":"BA506E7455D91C","user_header":"https://static001.geekbang.org/account/avatar/00/1e/2c/82/98e2b82a.jpg","comment_is_top":false,"comment_ctime":1603339208,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603339208","product_id":100056701,"comment_content":"老师你好.  文章介绍 sentinel之间通过pub&#47;sub的&quot;__sentinel:hell&quot;来感知对方, 我想知道:client怎么感知到的sentinels呢? 这个好像没说.","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389181,"discussion_content":"客户端需要配置sentinel的ip和端口的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629168295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":254462,"user_name":"LovePeace","can_delete":false,"product_type":"c1","uid":1010319,"ip_address":"","ucode":"5BA5B11FAF953E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6a/8f/5b224f54.jpg","comment_is_top":false,"comment_ctime":1603118505,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603118505","product_id":100056701,"comment_content":"请问哨兵选leader是采用raft算法吗？","like_count":0,"discussions":[{"author":{"id":2326907,"avatar":"","nickname":"Geek_bbd494","note":"","ucode":"148EA9397207A8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329214,"discussion_content":"有点类似，单次选举一人一票，先来先得的方法类似，比raft简单，raft还要判断数据完整度","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606349762,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253190,"user_name":"✨胡小东","can_delete":false,"product_type":"c1","uid":1312339,"ip_address":"","ucode":"314D40A5857C17","user_header":"https://static001.geekbang.org/account/avatar/00/14/06/53/29fa4e12.jpg","comment_is_top":false,"comment_ctime":1602645166,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1602645166","product_id":100056701,"comment_content":"如何在选举出Leader节点后，在进行主从切换的过程中，leader节点挂掉了，还能正常完成主从切换嘛？是重新在进行leader选举？还是就无法正常正常选举，集群就不可用了，需要人工干预呢？","like_count":0},{"had_liked":false,"id":250616,"user_name":"Geek_445b7f","can_delete":false,"product_type":"c1","uid":1780830,"ip_address":"","ucode":"F2207FE874A94E","user_header":"","comment_is_top":false,"comment_ctime":1601172044,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1601172044","product_id":100056701,"comment_content":"哨兵Leader选举的时机是什么？是每当客观下线主库的时候就进行一次选举吗？","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389182,"discussion_content":"个人觉得是","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629168380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249819,"user_name":"英宁","can_delete":false,"product_type":"c1","uid":1241380,"ip_address":"","ucode":"C6CB1C4FFCADC7","user_header":"https://static001.geekbang.org/account/avatar/00/12/f1/24/d15cf6af.jpg","comment_is_top":false,"comment_ctime":1600822820,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1600822820","product_id":100056701,"comment_content":"老师你好，关于哨兵和客户端之间的事件通知，有个地方没有明白，客户端是怎么知道哨兵集群地址的？","like_count":0,"discussions":[{"author":{"id":1316937,"avatar":"https://static001.geekbang.org/account/avatar/00/14/18/49/b1d864e5.jpg","nickname":"Hinimix","note":"","ucode":"7994136C93BD89","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312817,"discussion_content":"直连哨兵集群，获取主的地址","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602825650,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":249694,"user_name":"萧","can_delete":false,"product_type":"c1","uid":1229143,"ip_address":"","ucode":"0C2239867AFF5F","user_header":"https://static001.geekbang.org/account/avatar/00/12/c1/57/27de274f.jpg","comment_is_top":false,"comment_ctime":1600763519,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1600763519","product_id":100056701,"comment_content":"### Redis高可用之哨兵集群<br>基于pub&#47;sub机制的哨兵集群组成<br>哨兵与主库建立连接以后，可发送和订阅信息，以频道进行分类管理（和kafka有点相像）<br>哨兵可以发送INFO命令从主库获取从库的信息<br><br>基于pub&#47;sub的客户端事件通知<br>- 主库下线事件：<br>    - +sdown：实例进入主观下线状态<br>    - -sdown：实例退出主观下线状态<br>    - +odown：实例进入客观下线状态<br>    - -sdown：实例退出客观下线状态<br>- 从库重新配置事件<br>    - +slave-reconf-sent：哨兵发送SLAVEOF命令重新配置从库<br>    - +slave-reconf-inpprog：从库配置了新主库，但尚未进行同步<br>    - +slave-reconf-done：从库配置了新主库，且和新主库完成同步<br>- 新主库切换：<br>    - +swith-master：主库地址发送变化<br><br>哨兵领导选举：需有半数及以上的票数和大于预设的quorum值<br><br>疑问：这里的哨兵选举的具体算法是？有所以哨兵都选自己的吗？","like_count":0},{"had_liked":false,"id":249054,"user_name":"上学威龙007","can_delete":false,"product_type":"c1","uid":2116689,"ip_address":"","ucode":"B24D8A2E7D01F8","user_header":"https://static001.geekbang.org/account/avatar/00/20/4c/51/61003d76.jpg","comment_is_top":false,"comment_ctime":1600416073,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600416073","product_id":100056701,"comment_content":"1、多个哨兵之间建立互相通信的过程，类似于dubbo中把redis作为注册中心的场景，每个dubbo的实例，通过其他实例注册是发布的消息，来获取其他实例的通讯信息等<br>2、哨兵节点是不是越多越好，越多会增加网络的开销，减慢选举的效率。在此时，隔壁的zk提出了观察者的概念，只用来完成数据同步，但是不参与选举的过程","like_count":0},{"had_liked":false,"id":248626,"user_name":"jason-台北","can_delete":false,"product_type":"c1","uid":1456024,"ip_address":"","ucode":"EB59FE96D03835","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/gFE2skMqzrfiaRCmRTqCVK2ZfqUOhXXJE3BsUPvpibEEibwaFMVuiaQ41JSHZL2fhanhtVheEjlGrroiavl5Fgh7mYw/132","comment_is_top":false,"comment_ctime":1600246180,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600246180","product_id":100056701,"comment_content":"老師好，我請教一下。<br>那在實務上把從庫當作哨兵會比較好嗎？","like_count":0},{"had_liked":false,"id":248047,"user_name":"学习学个屁","can_delete":false,"product_type":"c1","uid":1049017,"ip_address":"","ucode":"DF2D61E6FB2FCE","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/b9/73435279.jpg","comment_is_top":false,"comment_ctime":1599992333,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599992333","product_id":100056701,"comment_content":"1 可以判断主观下线 <br>2 不能 切换 :  切换的因素是 投票必须大于基数 ,剩下2个哨兵各自给对方和自己投票 ,那么是票数是2 这样子不能进行切换, 还有一个因素是 投票的票数必须是超过多数的选票(这个值也就是3), 很明显2小于3票,这目前这个哨兵模式来说,一半的哨兵挂了,选举切换主库肯定是有问题的,哨兵模式也不是很好的容灾... <br>3 哨兵实例不是越多越好,这就跟选举国家主席似的,100个人很容易就能选择出来,13亿人得选到什么时候去... 客户端可等不了那么长时间... <br>4 这个参数不是越大越好,如果设置大了,等待的超时时间也会越来越大,客户端等不了这么长时间,客户就关闭页面或者应用了; 实际情况不允许!<br>","like_count":0},{"had_liked":false,"id":247252,"user_name":"hsggj","can_delete":false,"product_type":"c1","uid":1312093,"ip_address":"","ucode":"EA36957C4ED800","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLRCxev73gpRIKKwjvuU2WgFKcZ1rKrGhDSZpUMzRsEgvAEZN00XscsTXp0ib1OrNkn9LgH2hYxX1w/132","comment_is_top":false,"comment_ctime":1599641327,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1599641327","product_id":100056701,"comment_content":"HI 老师，一套哨兵集群可以为多个master&#47;slave服务吗？还是只能服务一套master&#47;slave?","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389183,"discussion_content":"可以多套","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629168564,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246912,"user_name":"凯文1985","can_delete":false,"product_type":"c1","uid":1036921,"ip_address":"","ucode":"9A42344649072B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d2/79/0a432fde.jpg","comment_is_top":false,"comment_ctime":1599529161,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1599529161","product_id":100056701,"comment_content":"在判断主库下线和选取哨兵leader过程中 什么情况下可以判断哨兵只可以投一张票？ 比如哨兵a和哨兵b接连判断主库主观下线的时候 是不是只能投一张票？","like_count":0},{"had_liked":false,"id":246288,"user_name":"前方的灯有点弱","can_delete":false,"product_type":"c1","uid":2058455,"ip_address":"","ucode":"5CEDBCF3DDC991","user_header":"https://static001.geekbang.org/account/avatar/00/1f/68/d7/29025f1f.jpg","comment_is_top":false,"comment_ctime":1599266325,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1599266325","product_id":100056701,"comment_content":"redis哨兵集群主从切换的时候回造成分布式锁失效吗？redis集群选举算法是Raft共识算法吗？redis在网络拥塞的时候认为主机主管下线会有脑裂问题吗","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389184,"discussion_content":"1.分布式锁可能失效，主从切换时从库可能会丢失部分数据 2.类raft算法或者简化版的raft算法3.会有脑裂问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629168807,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245996,"user_name":"Holiday","can_delete":false,"product_type":"c1","uid":1730042,"ip_address":"","ucode":"6E7EAA0D8BEED0","user_header":"https://static001.geekbang.org/account/avatar/00/1a/65/fa/4842bd0f.jpg","comment_is_top":false,"comment_ctime":1599127459,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599127459","product_id":100056701,"comment_content":"老师，我有个问题，文中“在主从集群中，主库上有一个名为“__sentinel__:hello”的频道，不同哨兵就是通过它来相互发现，实现互相通信的。”。但如果哨兵的启动是一个一个启动的话，比如哨兵A先启动，它向主库的__sentinel__:hello去发布订阅，然后哨兵B再启动，它也向主库的__sentinel__:hello去发布订阅，这个时候哨兵A是可以获得哨兵B的信息的，但是哨兵B怎么获得哨兵A的信息，因为哨兵A已经发布过了自己的信息了。难道哨兵A会不断的去发布自己的信息么？","like_count":0},{"had_liked":false,"id":245848,"user_name":"dfuru","can_delete":false,"product_type":"c1","uid":2110772,"ip_address":"","ucode":"0222FADA093D95","user_header":"","comment_is_top":false,"comment_ctime":1599094029,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599094029","product_id":100056701,"comment_content":"1.不能正确判断主库故障，剩余的状态正常的哨兵是2个，不满足大多数要求。<br>2.不能执行主从切换，同理选不出leader哨兵，虽然quorum=2。<br>3.哨兵越多，不一定好，哨兵越多通信量指数增长，网络带宽占用高。","like_count":0},{"had_liked":false,"id":245230,"user_name":"monkeyzi","can_delete":false,"product_type":"c1","uid":1448216,"ip_address":"","ucode":"CF415E5AF0CF67","user_header":"https://static001.geekbang.org/account/avatar/00/16/19/18/c3bc4905.jpg","comment_is_top":false,"comment_ctime":1598869640,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1598869640","product_id":100056701,"comment_content":"老师，我有个问题，就是在redis  m-s 架构中，master 在没有把数据同步给slave，这个时候 slave成为master 这个数据不一致，导致库存超卖，怎么情况下怎么解决呢？","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389185,"discussion_content":"强制读主库","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629168849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245208,"user_name":"Alex","can_delete":false,"product_type":"c1","uid":1122284,"ip_address":"","ucode":"92BD46245FB5B6","user_header":"https://static001.geekbang.org/account/avatar/00/11/1f/ec/d611ce6c.jpg","comment_is_top":false,"comment_ctime":1598864048,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598864048","product_id":100056701,"comment_content":"老师问下，如果主服务的写入的数据还有一部分没有同步到从服务器，这时候主服务器挂了，哨兵进行了主从切换，没同步的这部分数据是不是丢了","like_count":0},{"had_liked":false,"id":245033,"user_name":"张三","can_delete":false,"product_type":"c1","uid":1004092,"ip_address":"","ucode":"1155528FAE1546","user_header":"https://static001.geekbang.org/account/avatar/00/0f/52/3c/d6fcb93a.jpg","comment_is_top":false,"comment_ctime":1598790487,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598790487","product_id":100056701,"comment_content":"思考题，首先正确判断“客观下线”的要求是达到设定的“客观下线”的赞成票数，这个可以达到；而主从切换还需要哨兵选举出Leader，这个无法满足，因为两个哨兵是无论如何也拿不到半数以上的选举票的。","like_count":0},{"had_liked":false,"id":244984,"user_name":"松果","can_delete":false,"product_type":"c1","uid":1274379,"ip_address":"","ucode":"22D872F0532BE6","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erCXMLHlLs8TTRvw6BL13Zd0IGFeVZdicCsHnjJmM1FUC43sibcHIK0ViaIaOvOb5BVTlr3OTJNwaKzA/132","comment_is_top":false,"comment_ctime":1598773280,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598773280","product_id":100056701,"comment_content":"sentinel leader 是 raft协议？","like_count":0},{"had_liked":false,"id":244141,"user_name":"Geek_0cf59c","can_delete":false,"product_type":"c1","uid":2113137,"ip_address":"","ucode":"BD9E77E46B0249","user_header":"","comment_is_top":false,"comment_ctime":1598408435,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1598408435","product_id":100056701,"comment_content":"老师请教下：<br>有1主（172.168.3.1）2从（172.168.3.2,172.168.3.3）。客户端当前连接ip是172.168.3.1，当发生主从切换后，主库变成172.168.3.2,如何在不改变客户端原连接ip的情况下，访问新主库？","like_count":0,"discussions":[{"author":{"id":1123146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/23/4a/c608bdf6.jpg","nickname":"三石","note":"","ucode":"734DCECABC3BEC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389186,"discussion_content":"不要直接连主库，用sentinel集群呐","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629168923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":244115,"user_name":"李二木","can_delete":false,"product_type":"c1","uid":1103091,"ip_address":"","ucode":"30E03BB84ADB27","user_header":"https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg","comment_is_top":false,"comment_ctime":1598404799,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1598404799","product_id":100056701,"comment_content":"投票选举过程中跟投票的先后顺序有关系吗?","like_count":0},{"had_liked":false,"id":243487,"user_name":"Kvicii.Y","can_delete":false,"product_type":"c1","uid":1442588,"ip_address":"","ucode":"446BFA633569EA","user_header":"https://static001.geekbang.org/account/avatar/00/16/03/1c/c9fe6738.jpg","comment_is_top":false,"comment_ctime":1598152926,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598152926","product_id":100056701,"comment_content":"应该是类似于Raft的Leader选举，但是我记得哨兵这里应该还有一个majority的配置吧，不是超过半数再执行故障转移吧？","like_count":0},{"had_liked":false,"id":243397,"user_name":"yyl","can_delete":false,"product_type":"c1","uid":1170843,"ip_address":"","ucode":"1741DACDFCA9AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/dd/9b/0bc44a78.jpg","comment_is_top":false,"comment_ctime":1598086793,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598086793","product_id":100056701,"comment_content":"解答：<br>1. 主观下线 票数达到quorum即可标记客观下线。因此仍可正确判断主库“客观下线”。<br>2. 哨兵Leader选举 票数需达到半数，且大于等于quorum。Leader选举可正确进行，因此仍可完成主从自动切换。 <br>3. 哨兵实例，并非越多越好。其一，哨兵需要与主从库和客户端建立连接，实例越多，相互间的网络交互更加复杂。其二，实例越多，选定主库，哨兵Leader选举耗时势必增加，加之网络抖动，二次筛选与选举的可能性增加。<br>4. 调大down-after-milliseconds对减少误判有一定的好处，但也有风险：从库对主库运行状态的感知变得迟钝，无法及时完成主从切换，可能导致丢失客户端写请求，造成数据丢失。","like_count":0},{"had_liked":false,"id":243389,"user_name":"yyl","can_delete":false,"product_type":"c1","uid":1170843,"ip_address":"","ucode":"1741DACDFCA9AF","user_header":"https://static001.geekbang.org/account/avatar/00/11/dd/9b/0bc44a78.jpg","comment_is_top":false,"comment_ctime":1598083610,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598083610","product_id":100056701,"comment_content":"“客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接。然后，我们可以在客户端执行订阅命令，来获取不同的事件消息。”<br><br>客户端需要与所有的哨兵实例建立网络连接吗？","like_count":0},{"had_liked":false,"id":243176,"user_name":"盟讯","can_delete":false,"product_type":"c1","uid":1590262,"ip_address":"","ucode":"EE057FC9ADEF91","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ZLhicyPutHBNOfYrtwOT4K7D7MvORg3HJlm9HicVj6Zjzp9Cib0JnddrTNVoxFxiautXUgYNBXD6XEVyXK9eP87Y4g/132","comment_is_top":false,"comment_ctime":1597982457,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597982457","product_id":100056701,"comment_content":"可以判断客观下线，两个哨兵都会判断“主观下线”，达到仲裁值所需要的数：2。<br>    不会进行主从切换，因为在哨兵选择leader时，每一个哨兵都会选择自己，票数问题相等<br>\t<br>\t哨兵实例不是越多越好，实例越多通信越频繁，会造成网络拥塞。<br>\tdown-after-milliseconds的值高大对误判有好处，调大会对网络不稳定的导致通信不畅有好处，但是当主库出现故障时<br>\t主从切换操作过程会增长，而且监控不迅速","like_count":0},{"had_liked":false,"id":243153,"user_name":"倪大人","can_delete":false,"product_type":"c1","uid":1193052,"ip_address":"","ucode":"4798D69F3E86FB","user_header":"https://static001.geekbang.org/account/avatar/00/12/34/5c/6b4757a0.jpg","comment_is_top":false,"comment_ctime":1597977934,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597977934","product_id":100056701,"comment_content":"问个问题，文章里的S1、S2、S3那张图，为什么S2不能给自己投票？是不是在“客观下线”中投了赞成票的哨兵才能竞选leader？","like_count":0},{"had_liked":false,"id":243144,"user_name":"zhou","can_delete":false,"product_type":"c1","uid":1065310,"ip_address":"","ucode":"E5D21F2A3359CB","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/5e/9d2953a3.jpg","comment_is_top":false,"comment_ctime":1597975519,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597975519","product_id":100056701,"comment_content":"因为只有两个实例，quorum 是 2，所以两个实例必须都判断为主观下线，才会确认为客观下线。<br><br>但只要其中一个实例确认为客观下线，另一个实例必然也会确认为客观下线。此时两个实例都希望申请成为 Leader，先给自己投票，然后请求对方投票。由于都已给自己投过票，无法给其他实例投票，最终导致这一轮无法产生 Leader。<br><br>等待一段时间后，如果其中一个实例先发出 Leader 申请，可能会得到另一个实例的投票，该实例就会成为 Leader，可以进行选主。","like_count":0},{"had_liked":false,"id":243128,"user_name":"Kirito","can_delete":false,"product_type":"c1","uid":1257284,"ip_address":"","ucode":"142F85F14D18F9","user_header":"https://static001.geekbang.org/account/avatar/00/13/2f/44/65462190.jpg","comment_is_top":false,"comment_ctime":1597973304,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1597973304","product_id":100056701,"comment_content":"会有3个哨兵都投给自己的情况吗？那不是平票了😂","like_count":0,"discussions":[{"author":{"id":1388092,"avatar":"https://static001.geekbang.org/account/avatar/00/15/2e/3c/eae43616.jpg","nickname":"sid","note":"","ucode":"3D1F9169A19D29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304338,"discussion_content":"肯定会有的，不过概率比较低。没有选举出leader的话，会继续进行下一届选举。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599549199,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}