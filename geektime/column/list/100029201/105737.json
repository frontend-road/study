{"id":105737,"title":"17 | 消费者组重平衡能避免吗？","content":"<p>你好，我是胡夕。今天我要和你分享的内容是：消费者组重平衡能避免吗?</p><p>其实在专栏<a href=\"https://time.geekbang.org/column/article/105112\">第15期</a>中，我们讲过重平衡，也就是Rebalance，现在先来回顾一下这个概念的原理和用途。Rebalance就是让一个Consumer Group下所有的Consumer实例就如何消费订阅主题的所有分区达成共识的过程。在Rebalance过程中，所有Consumer实例共同参与，在协调者组件的帮助下，完成订阅主题分区的分配。但是，在整个过程中，所有实例都不能消费任何消息，因此它对Consumer的TPS影响很大。</p><p>你可能会对这里提到的“协调者”有些陌生，我来简单介绍下。所谓协调者，在Kafka中对应的术语是Coordinator，它专门为Consumer Group服务，负责为Group执行Rebalance以及提供位移管理和组成员管理等。</p><p>具体来讲，Consumer端应用程序在提交位移时，其实是向Coordinator所在的Broker提交位移。同样地，当Consumer应用启动时，也是向Coordinator所在的Broker发送各种请求，然后由Coordinator负责执行消费者组的注册、成员管理记录等元数据管理操作。</p><!-- [[[read_end]]] --><p>所有Broker在启动时，都会创建和开启相应的Coordinator组件。也就是说，<strong>所有Broker都有各自的Coordinator组件</strong>。那么，Consumer Group如何确定为它服务的Coordinator在哪台Broker上呢？答案就在我们之前说过的Kafka内部位移主题__consumer_offsets身上。</p><p>目前，Kafka为某个Consumer Group确定Coordinator所在的Broker的算法有2个步骤。</p><p>第1步：确定由位移主题的哪个分区来保存该Group数据：partitionId=Math.abs(groupId.hashCode() % offsetsTopicPartitionCount)。</p><p>第2步：找出该分区Leader副本所在的Broker，该Broker即为对应的Coordinator。</p><p>简单解释一下上面的算法。首先，Kafka会计算该Group的group.id参数的哈希值。比如你有个Group的group.id设置成了“test-group”，那么它的hashCode值就应该是627841412。其次，Kafka会计算__consumer_offsets的分区数，通常是50个分区，之后将刚才那个哈希值对分区数进行取模加求绝对值计算，即abs(627841412 % 50) = 12。此时，我们就知道了位移主题的分区12负责保存这个Group的数据。有了分区号，算法的第2步就变得很简单了，我们只需要找出位移主题分区12的Leader副本在哪个Broker上就可以了。这个Broker，就是我们要找的Coordinator。</p><p>在实际使用过程中，Consumer应用程序，特别是Java Consumer API，能够自动发现并连接正确的Coordinator，我们不用操心这个问题。知晓这个算法的最大意义在于，它能够帮助我们解决<strong>定位问题</strong>。当Consumer Group出现问题，需要快速排查Broker端日志时，我们能够根据这个算法准确定位Coordinator对应的Broker，不必一台Broker一台Broker地盲查。</p><p>好了，我们说回Rebalance。既然我们今天要讨论的是如何避免Rebalance，那就说明Rebalance这个东西不好，或者说至少有一些弊端需要我们去规避。那么，Rebalance的弊端是什么呢？总结起来有以下3点：</p><ol>\n<li>\n<p>Rebalance影响Consumer端TPS。这个之前也反复提到了，这里就不再具体讲了。总之就是，在Rebalance期间，Consumer会停下手头的事情，什么也干不了。</p>\n</li>\n<li>\n<p>Rebalance很慢。如果你的Group下成员很多，就一定会有这样的痛点。还记得我曾经举过的那个国外用户的例子吧？他的Group下有几百个Consumer实例，Rebalance一次要几个小时。在那种场景下，Consumer Group的Rebalance已经完全失控了。</p>\n</li>\n<li>\n<p>Rebalance效率不高。当前Kafka的设计机制决定了每次Rebalance时，Group下的所有成员都要参与进来，而且通常不会考虑局部性原理，但局部性原理对提升系统性能是特别重要的。</p>\n</li>\n</ol><p>关于第3点，我们来举个简单的例子。比如一个Group下有10个成员，每个成员平均消费5个分区。假设现在有一个成员退出了，此时就需要开启新一轮的Rebalance，把这个成员之前负责的5个分区“转移”给其他成员。显然，比较好的做法是维持当前9个成员消费分区的方案不变，然后将5个分区随机分配给这9个成员，这样能最大限度地减少Rebalance对剩余Consumer成员的冲击。</p><p>遗憾的是，目前Kafka并不是这样设计的。在默认情况下，每次Rebalance时，之前的分配方案都不会被保留。就拿刚刚这个例子来说，当Rebalance开始时，Group会打散这50个分区（10个成员 * 5个分区），由当前存活的9个成员重新分配它们。显然这不是效率很高的做法。基于这个原因，社区于0.11.0.0版本推出了StickyAssignor，即有粘性的分区分配策略。所谓的有粘性，是指每次Rebalance时，该策略会尽可能地保留之前的分配方案，尽量实现分区分配的最小变动。不过有些遗憾的是，这个策略目前还有一些bug，而且需要升级到0.11.0.0才能使用，因此在实际生产环境中用得还不是很多。</p><p>总而言之，Rebalance有以上这三个方面的弊端。你可能会问，这些问题有解吗？特别是针对Rebalance慢和影响TPS这两个弊端，社区有解决办法吗？针对这两点，我可以很负责任地告诉你：“无解！”特别是Rebalance慢这个问题，Kafka社区对此无能为力。“本事大不如不摊上”，既然我们没办法解决Rebalance过程中的各种问题，干脆就避免Rebalance吧，特别是那些不必要的Rebalance。</p><p>就我个人经验而言，<strong>在真实的业务场景中，很多Rebalance都是计划外的或者说是不必要的</strong>。我们应用的TPS大多是被这类Rebalance拖慢的，因此避免这类Rebalance就显得很有必要了。下面我们就来说说如何避免Rebalance。</p><p>要避免Rebalance，还是要从Rebalance发生的时机入手。我们在前面说过，Rebalance发生的时机有三个：</p><ul>\n<li>组成员数量发生变化</li>\n<li>订阅主题数量发生变化</li>\n<li>订阅主题的分区数发生变化</li>\n</ul><p>后面两个通常都是运维的主动操作，所以它们引发的Rebalance大都是不可避免的。接下来，我们主要说说因为组成员数量变化而引发的Rebalance该如何避免。</p><p>如果Consumer Group下的Consumer实例数量发生变化，就一定会引发Rebalance。这是Rebalance发生的最常见的原因。我碰到的99%的Rebalance，都是这个原因导致的。</p><p>Consumer实例增加的情况很好理解，当我们启动一个配置有相同group.id值的Consumer程序时，实际上就向这个Group添加了一个新的Consumer实例。此时，Coordinator会接纳这个新实例，将其加入到组中，并重新分配分区。通常来说，增加Consumer实例的操作都是计划内的，可能是出于增加TPS或提高伸缩性的需要。总之，它不属于我们要规避的那类“不必要Rebalance”。</p><p>我们更在意的是Group下实例数减少这件事。如果你就是要停掉某些Consumer实例，那自不必说，关键是在某些情况下，Consumer实例会被Coordinator错误地认为“已停止”从而被“踢出”Group。如果是这个原因导致的Rebalance，我们就不能不管了。</p><p>Coordinator会在什么情况下认为某个Consumer实例已挂从而要退组呢？这个绝对是需要好好讨论的话题，我们来详细说说。</p><p>当Consumer Group完成Rebalance之后，每个Consumer实例都会定期地向Coordinator发送心跳请求，表明它还存活着。如果某个Consumer实例不能及时地发送这些心跳请求，Coordinator就会认为该Consumer已经“死”了，从而将其从Group中移除，然后开启新一轮Rebalance。Consumer端有个参数，叫session.timeout.ms，就是被用来表征此事的。该参数的默认值是10秒，即如果Coordinator在10秒之内没有收到Group下某Consumer实例的心跳，它就会认为这个Consumer实例已经挂了。可以这么说，session.timeout.ms决定了Consumer存活性的时间间隔。</p><p>除了这个参数，Consumer还提供了一个允许你控制发送心跳请求频率的参数，就是heartbeat.interval.ms。这个值设置得越小，Consumer实例发送心跳请求的频率就越高。频繁地发送心跳请求会额外消耗带宽资源，但好处是能够更加快速地知晓当前是否开启Rebalance，因为，目前Coordinator通知各个Consumer实例开启Rebalance的方法，就是将REBALANCE_NEEDED标志封装进心跳请求的响应体中。</p><p>除了以上两个参数，Consumer端还有一个参数，用于控制Consumer实际消费能力对Rebalance的影响，即max.poll.interval.ms参数。它限定了Consumer端应用程序两次调用poll方法的最大时间间隔。它的默认值是5分钟，表示你的Consumer程序如果在5分钟之内无法消费完poll方法返回的消息，那么Consumer会主动发起“离开组”的请求，Coordinator也会开启新一轮Rebalance。</p><p>搞清楚了这些参数的含义，接下来我们来明确一下到底哪些Rebalance是“不必要的”。</p><p><strong>第一类非必要Rebalance是因为未能及时发送心跳，导致Consumer被“踢出”Group而引发的</strong>。因此，你需要仔细地设置<strong>session.timeout.ms和heartbeat.interval.ms</strong>的值。我在这里给出一些推荐数值，你可以“无脑”地应用在你的生产环境中。</p><ul>\n<li>设置session.timeout.ms = 6s。</li>\n<li>设置heartbeat.interval.ms = 2s。</li>\n<li>要保证Consumer实例在被判定为“dead”之前，能够发送至少3轮的心跳请求，即session.timeout.ms &gt;= 3 * heartbeat.interval.ms。</li>\n</ul><p>将session.timeout.ms设置成6s主要是为了让Coordinator能够更快地定位已经挂掉的Consumer。毕竟，我们还是希望能尽快揪出那些“尸位素餐”的Consumer，早日把它们踢出Group。希望这份配置能够较好地帮助你规避第一类“不必要”的Rebalance。</p><p><strong>第二类非必要Rebalance是Consumer消费时间过长导致的</strong>。我之前有一个客户，在他们的场景中，Consumer消费数据时需要将消息处理之后写入到MongoDB。显然，这是一个很重的消费逻辑。MongoDB的一丁点不稳定都会导致Consumer程序消费时长的增加。此时，<strong>max.poll.interval.ms</strong>参数值的设置显得尤为关键。如果要避免非预期的Rebalance，你最好将该参数值设置得大一点，比你的下游最大处理时间稍长一点。就拿MongoDB这个例子来说，如果写MongoDB的最长时间是7分钟，那么你可以将该参数设置为8分钟左右。</p><p>总之，你要为你的业务处理逻辑留下充足的时间。这样，Consumer就不会因为处理这些消息的时间太长而引发Rebalance了。</p><p>如果你按照上面的推荐数值恰当地设置了这几个参数，却发现还是出现了Rebalance，那么我建议你去排查一下<strong>Consumer端的GC表现</strong>，比如是否出现了频繁的Full GC导致的长时间停顿，从而引发了Rebalance。为什么特意说GC？那是因为在实际场景中，我见过太多因为GC设置不合理导致程序频发Full GC而引发的非预期Rebalance了。</p><h2>小结</h2><p>总而言之，我们一定要避免因为各种参数或逻辑不合理而导致的组成员意外离组或退出的情形，与之相关的主要参数有：</p><ul>\n<li>session.timeout.ms</li>\n<li>heartbeat.interval.ms</li>\n<li>max.poll.interval.ms</li>\n<li>GC参数</li>\n</ul><p>按照我们今天所说的内容，恰当地设置这些参数，你一定能够大幅度地降低生产环境中的Rebalance数量，从而整体提升Consumer端TPS。</p><p><img src=\"https://static001.geekbang.org/resource/image/32/d3/321c73b51f5e5c3124765101edc53ed3.jpg?wh=2069*2569\" alt=\"\"></p><h2>开放讨论</h2><p>说说在你的业务场景中，Rebalance发生的频率、原因，以及你是怎么应对的，我们一起讨论下是否有更好的解决方案。</p><p>欢迎写下你的思考和答案，我们一起讨论。如果你觉得有所收获，也欢迎把文章分享给你的朋友。</p>","comments":[{"had_liked":false,"id":112732,"user_name":"Icedmaze","can_delete":false,"product_type":"c1","uid":1104245,"ip_address":"","ucode":"DC05117685CAB5","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","comment_is_top":false,"comment_ctime":1562811238,"is_pvip":false,"replies":[{"id":"41124","content":"你所谓的处理是指业务上的处理逻辑。对于Kafka而言，从poll方法返回消息的那一刻开始这条消息已经算是“消费”完成了。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892827,"ip_address":"","comment_id":112732,"utype":1}],"discussion_count":9,"race_medal":0,"score":"220606143334","product_id":100029201,"comment_content":"在 Rebalance 过程中，所有 Consumer 实例都会停止消费，等待Rebalance的完成。<br>这里想问的是，如果我有一个长耗时的业务逻辑需要处理，并且offset还未提交，这时候系统发生了Rebalance的话，是等待所有消费端当前消息都处理完成，再进行停止消费，并进行重新分配分区，还是说强制停止消费。<br>如果强制停止消费的话，那么那些已经处理完成一半的数据并offset未提交的数据，势必会导致Rebalance后重新进行消费，导致数据产生重复消费。","like_count":52,"discussions":[{"author":{"id":1282575,"avatar":"https://static001.geekbang.org/account/avatar/00/13/92/0f/cff30522.jpg","nickname":"江湖夜雨","note":"","ucode":"C64913C7000899","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":67628,"discussion_content":"这情况在自动提交后，的确会出现消费重复问题！","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1575162578,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457883,"discussion_content":"你所谓的处理是指业务上的处理逻辑。对于Kafka而言，从poll方法返回消息的那一刻开始这条消息已经算是“消费”完成了。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1562892827,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1104245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","nickname":"Icedmaze","note":"","ucode":"DC05117685CAB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1782,"discussion_content":"那可否认为，之前poll的数据还是会被继续进行业务逻辑处理，若在rebalance停止消费期间offset并未进行提交，可能会造成该partition里面的同一批消息被重新分配给其他消费实例，造成重复消费问题。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562911425,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":5,"child_discussions":[{"author":{"id":1112182,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f8/76/3db69173.jpg","nickname":"onepieceJT2018","note":"","ucode":"C8C214C3D5D285","race_medal":3,"user_type":1,"is_pvip":true},"reply_author":{"id":1104245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","nickname":"Icedmaze","note":"","ucode":"DC05117685CAB5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1789,"discussion_content":"你说的是两个问题 \n1. 因为rebalance会可能导致消息被其他消费者消费 \n2. 因为你的业务逻辑虽然执行完了 但是offset没有提交就是会出现重复消费的问题\n所以你需要做的是在业务逻辑里面混合同步提交和异步提交 保证offset能提交 还有就是要做的就是引入分布式缓存来对你执行job去重\n个人理解","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562913462,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1782,"ip_address":""},"score":1789,"extra":""},{"author":{"id":1104245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","nickname":"Icedmaze","note":"","ucode":"DC05117685CAB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1112182,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f8/76/3db69173.jpg","nickname":"onepieceJT2018","note":"","ucode":"C8C214C3D5D285","race_medal":3,"user_type":1,"is_pvip":true},"discussion":{"id":1805,"discussion_content":"当然分布式缓存去重处理无论有没有rebalance都是需要做的，只要采取先处理业务，后提交offset的形式避免不了消息重复消费，这里只是想搞清楚rebalance的实际处理机制。\n针对消息去重，目前采用redis缓存Topic+partition+group的偏移量，使精度提升到每一条消息，当然有何更好的去重方法，这边也想请教下。","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1562919417,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1789,"ip_address":""},"score":1805,"extra":""},{"author":{"id":1797809,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLpuXh4ibibw0eI0r2TEI0FM07QnKjVK8fLiaorX17ia5lpeoBJr383dMeLh7m8CFrfOPYJazDIdbVYdA/132","nickname":"Geek_3094fd","note":"","ucode":"96D4049C54A23D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1112182,"avatar":"https://static001.geekbang.org/account/avatar/00/10/f8/76/3db69173.jpg","nickname":"onepieceJT2018","note":"","ucode":"C8C214C3D5D285","race_medal":3,"user_type":1,"is_pvip":true},"discussion":{"id":303263,"discussion_content":"所以rebalance到底是等consumer处理完消息之后停止消费者的消费还是如果rebalance了 消费者直接就会放弃手里消息呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599204779,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1789,"ip_address":""},"score":303263,"extra":""}]},{"author":{"id":1101071,"avatar":"https://static001.geekbang.org/account/avatar/00/10/cd/0f/fa810f69.jpg","nickname":"☆appleう","note":"","ucode":"54F4A73057E02A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1754,"discussion_content":"如果消费者1从poll取出数据，另一个消费者2从poll取数据，那么是这两个消费者都处理完，才能rebalance吗(两个消费者属于同一个组的)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562894308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112711,"user_name":"Liam","can_delete":false,"product_type":"c1","uid":1094597,"ip_address":"","ucode":"1D15D3B64F2606","user_header":"https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg","comment_is_top":false,"comment_ctime":1562808867,"is_pvip":false,"replies":[{"id":"41132","content":"去找Coordinator所在的broker日志，如果经常发生rebalance，会有类似于&quot;(Re)join group&quot; 之类的日志","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562893106,"ip_address":"","comment_id":112711,"utype":1}],"discussion_count":7,"race_medal":0,"score":"169066533411","product_id":100029201,"comment_content":"问个小白问题，如何排查得知broker rebalance 过多，通过broker日志吗？什么日志呢","like_count":40,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457868,"discussion_content":"去找Coordinator所在的broker日志，如果经常发生rebalance，会有类似于&amp;quot;(Re)join group&amp;quot; 之类的日志","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1034204,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","nickname":"ban","note":"","ucode":"E523CE97E48266","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1839,"discussion_content":"这个问题提的好","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562943078,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2071279,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/9a/ef/6162b0e0.jpg","nickname":"Rangarok","note":"","ucode":"D13AF6E247EFCF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577305,"discussion_content":"Mark","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656034058,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2860851,"avatar":"","nickname":"Geek_e78fa5","note":"","ucode":"713677ED3B5745","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":540776,"discussion_content":"mark,问题不错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1640164025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366891,"discussion_content":"有没有专门的监控管理平台，可以用于分析、预警这类问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618212869,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":50083,"discussion_content":"马克. 问题不错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573660152,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1319959,"avatar":"https://static001.geekbang.org/account/avatar/00/14/24/17/0705993b.jpg","nickname":"尔我","note":"","ucode":"3D219237D7ED16","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1709,"discussion_content":"kafka日志里有","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562834020,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175522,"user_name":"What for","can_delete":false,"product_type":"c1","uid":1254381,"ip_address":"","ucode":"1308573CE047B0","user_header":"https://static001.geekbang.org/account/avatar/00/13/23/ed/a4a774a8.jpg","comment_is_top":false,"comment_ctime":1580738590,"is_pvip":false,"replies":[{"id":"68342","content":"不会。standalone consumer就没有rebalance一说了。<br>它的特点主要是灵活和。虽然社区一直在改进rebalance的性能，但大数据量下consumer group机制依然有很多弊病（比如rebalance太慢等），所以很多大数据框架(Spark<br>&#47;Flink)的kafka connector并不使用group机制，而是使用standalone consumer","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1580864746,"ip_address":"","comment_id":175522,"utype":1}],"discussion_count":3,"race_medal":0,"score":"130429757470","product_id":100029201,"comment_content":"老师您好！<br>请问如果使用 Standalone Consumer，是不是也不会发生 rebalance 了？<br>感觉专栏里对 Standalone Consumer 就是提了两句，没有太多的介绍，相较于订阅模式它们有什么特点嘛？","like_count":31,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482775,"discussion_content":"不会。standalone consumer就没有rebalance一说了。\n它的特点主要是灵活和。虽然社区一直在改进rebalance的性能，但大数据量下consumer group机制依然有很多弊病（比如rebalance太慢等），所以很多大数据框架(Spark\n/Flink)的kafka connector并不使用group机制，而是使用standalone consumer","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580864746,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337749,"discussion_content":"大数据场景，学到了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609068559,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1927947,"avatar":"http://thirdwx.qlogo.cn/mmopen/h0KAdRFKjCOSLRjzictvlaDCZa1icVbVRrXX10iaJxUgcFlwQP21k1R4O9lKjRzaKpQWexAjTLEia8fpsmubJ0ibM47eokfibLlMAk/132","nickname":"罗成林","note":"","ucode":"125DBC26EC26FF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":216284,"discussion_content":"学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585411938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113189,"user_name":"Icedmaze","can_delete":false,"product_type":"c1","uid":1104245,"ip_address":"","ucode":"DC05117685CAB5","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","comment_is_top":false,"comment_ctime":1562911474,"is_pvip":false,"replies":[{"id":"41195","content":"是的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562913521,"ip_address":"","comment_id":113189,"utype":1}],"discussion_count":1,"race_medal":0,"score":"113232061170","product_id":100029201,"comment_content":"那可否认为，之前poll的数据还是会被继续进行业务逻辑处理，若在rebalance停止消费期间offset并未进行提交，可能会造成该partition里面的同一批消息被重新分配给其他消费实例，造成重复消费问题。","like_count":27,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458100,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562913521,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112712,"user_name":"李奕慧","can_delete":false,"product_type":"c1","uid":1201005,"ip_address":"","ucode":"0D8871ED38859C","user_header":"https://static001.geekbang.org/account/avatar/00/12/53/6d/c3828950.jpg","comment_is_top":false,"comment_ctime":1562808898,"is_pvip":false,"replies":[{"id":"41131","content":"0.10.1之前是在调用poll方法时发送的，0.10.1之后consumer使用单独的心跳线程来发送","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562893052,"ip_address":"","comment_id":112712,"utype":1}],"discussion_count":3,"race_medal":0,"score":"100347056706","product_id":100029201,"comment_content":"“每个 Consumer 实例都会定期地向 Coordinator 发送心跳请求，表明它还存活着。”这个是后台自动触发的还是每次主动poll消息触发的啊？","like_count":23,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457869,"discussion_content":"0.10.1之前是在调用poll方法时发送的，0.10.1之后consumer使用单独的心跳线程来发送","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893052,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2642315,"avatar":"","nickname":"Geek_c695c1","note":"","ucode":"FC2AD53F54582D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388719,"discussion_content":"如果使用单独的线程放心跳，在消费耗时较长的情况下Coordinator 是不是也能正常接收consumer的心跳？那还存在这种Consumer 消费时间过长导致的rebalance吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628926005,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":50084,"discussion_content":"马克. .  不同版本心跳请求不同","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573660191,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112765,"user_name":"墨渊战神01","can_delete":false,"product_type":"c1","uid":1046665,"ip_address":"","ucode":"79668ADBB2A4DA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f8/89/7431e82e.jpg","comment_is_top":false,"comment_ctime":1562818825,"is_pvip":false,"replies":[{"id":"41120","content":"consumer主动关闭会主动向Coordinator发送LeaveGroup请求，从而让Coordinator第一时间开启rebalance","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892499,"ip_address":"","comment_id":112765,"utype":1}],"discussion_count":2,"race_medal":0,"score":"78872230153","product_id":100029201,"comment_content":"Consumer 消费时间过长为啥会导致rebalance？是不能及时发心跳 导致coordinator认为该consumer挂了吗？","like_count":18,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457902,"discussion_content":"consumer主动关闭会主动向Coordinator发送LeaveGroup请求，从而让Coordinator第一时间开启rebalance","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892499,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1584204,"avatar":"https://static001.geekbang.org/account/avatar/00/18/2c/4c/0eb5d084.jpg","nickname":"刚好","note":"","ucode":"05447FCF4D85B0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":357512,"discussion_content":"老师，请问为什么consumer消费时间长会导致主动关闭呢，谢谢","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1615815791,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112726,"user_name":"诗泽","can_delete":false,"product_type":"c1","uid":1031865,"ip_address":"","ucode":"F28BE01C3FD12F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/be/b9/f2481c2c.jpg","comment_is_top":false,"comment_ctime":1562810396,"is_pvip":false,"replies":[{"id":"41127","content":"取最大的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892898,"ip_address":"","comment_id":112726,"utype":1}],"discussion_count":2,"race_medal":0,"score":"78872221724","product_id":100029201,"comment_content":"如果同一个group 的不同consumer 设置的session.timeout.ms 的不一样怎么办？协调者以最后一个consumer 为准吗？","like_count":18,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457880,"discussion_content":"取最大的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892898,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1035562,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/cd/2a/bdbed6ed.jpg","nickname":"无菇朋友","note":"","ucode":"80482C5F0464A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1724,"discussion_content":"应该不冲突 不同配置的consumer，coordinator会分别处理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562847871,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112929,"user_name":"千屿","can_delete":false,"product_type":"c1","uid":1339010,"ip_address":"","ucode":"825ABAA910EA82","user_header":"https://static001.geekbang.org/account/avatar/00/14/6e/82/b058eca5.jpg","comment_is_top":false,"comment_ctime":1562849536,"is_pvip":false,"replies":[{"id":"41113","content":"是否是因为某个分区的数据量太多，造成了其他分区的“假饿死”？","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892170,"ip_address":"","comment_id":112929,"utype":1}],"discussion_count":4,"race_medal":0,"score":"61692391680","product_id":100029201,"comment_content":"我遇到一个很奇怪的问题，我消费者单线程使用订阅模式消费主题，主题下有三个分区，但是每次启动消费者，只能消费到一个分区的数据，在启动的日志里已经显示了该group已经分配到了三个分区，可是只会poll一个分区的数据。当我用多线程启动三个消费者实例是正常的，启动两个实例只能消费到两个分区数据，求各位大神指点下，谢谢了!","like_count":14,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457959,"discussion_content":"是否是因为某个分区的数据量太多，造成了其他分区的“假饿死”？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1612068,"avatar":"https://static001.geekbang.org/account/avatar/00/18/99/24/460937df.jpg","nickname":"借你一秒","note":"","ucode":"CA2F0EC4E26889","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313186,"discussion_content":"那如何避免呢？@作者","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602992255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2017160,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJFAbKtf9ceENwqyUPlduvtsrFZvwAM06nRnmAib6tePqFRqLYsN9xsiccBcXpibickWSt1H9eS9KIqrg/132","nickname":"邱天","note":"","ucode":"4B321100B8C426","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1612068,"avatar":"https://static001.geekbang.org/account/avatar/00/18/99/24/460937df.jpg","nickname":"借你一秒","note":"","ucode":"CA2F0EC4E26889","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388508,"discussion_content":"这个是Producer 的发送消息的分区策略有问题吧~正常都会均匀分配的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628815544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":313186,"ip_address":""},"score":388508,"extra":""}]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":50079,"discussion_content":"马克, 假饿死!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573660067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112883,"user_name":"丘壑","can_delete":false,"product_type":"c1","uid":1118203,"ip_address":"","ucode":"ECFEDA5A93828D","user_header":"https://static001.geekbang.org/account/avatar/00/11/0f/fb/68196d4c.jpg","comment_is_top":false,"comment_ctime":1562837004,"is_pvip":false,"replies":[{"id":"41115","content":"不同的group id会被哈希到不同的分区上，从而不同的broker能充当不同group的Coordinator","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892230,"ip_address":"","comment_id":112883,"utype":1}],"discussion_count":1,"race_medal":0,"score":"57397411852","product_id":100029201,"comment_content":"根据公式计算记过：partitionId=Math.abs(groupId.hashCode() % offsetsTopicPartitionCount)只可能是一个分区值，该分区值对于的leader副本的broker也只可能是集群中的一台，那么一个group进行位移提交的时候，只能是与集群中的一台broker进行交互了？这样是不是就会有性能瓶颈啊，没有充分利用集群中的broker啊，","like_count":13,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457941,"discussion_content":"不同的group id会被哈希到不同的分区上，从而不同的broker能充当不同group的Coordinator","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892230,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131407,"user_name":"不能扮演天使","can_delete":false,"product_type":"c1","uid":1046172,"ip_address":"","ucode":"9922330BFF7FFB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f6/9c/b457a937.jpg","comment_is_top":false,"comment_ctime":1567741054,"is_pvip":false,"replies":[{"id":"49851","content":"因为poll和业务处理通常是在一个线程中，因此业务处理速度会影响poll调用频率","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567763225,"ip_address":"","comment_id":131407,"utype":1}],"discussion_count":6,"race_medal":0,"score":"44517414014","product_id":100029201,"comment_content":"老师问个问题，max.poll.interval.ms是拉取的时间间隔，如果过了这个时间没有拉取则会发生重平衡，但是什么情况consumer会不拉取呢？上面mongodb的例子那是业务逻辑处理重，但是对于kafka来说poll()之后就已经算是消费完了，为啥这个参数的设置还要依赖消费的后序业务处理？","like_count":11,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466436,"discussion_content":"因为poll和业务处理通常是在一个线程中，因此业务处理速度会影响poll调用频率","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567763225,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":271130,"discussion_content":"创建新的线程处理消费的数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590077511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1682027,"avatar":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","nickname":"对与错","note":"","ucode":"EF55733E3BD78B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":300023,"discussion_content":"spring-kafka就是这么干的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597914055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":271130,"ip_address":""},"score":300023,"extra":""},{"author":{"id":1054827,"avatar":"https://static001.geekbang.org/account/avatar/00/10/18/6b/a1448af1.jpg","nickname":"贝影","note":"","ucode":"19545C8DCBF8A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1682027,"avatar":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","nickname":"对与错","note":"","ucode":"EF55733E3BD78B","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":544162,"discussion_content":"spring-kafka提供了多种提交方式，你选择手动提交照样有这个问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641433339,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":300023,"ip_address":""},"score":544162,"extra":""}]},{"author":{"id":1132315,"avatar":"https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg","nickname":"胡小禾","note":"","ucode":"1C23B7492C0C9E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":260592,"discussion_content":"老师说的应该只针对原生的kafka client SDK的实现吧？实际上poll和业务线程完全可以分开","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588867013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":50099,"discussion_content":"马克.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573660558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":208301,"user_name":"Berk","can_delete":false,"product_type":"c1","uid":1010701,"ip_address":"","ucode":"9BA886BEB2AAF2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6c/0d/c0735400.jpg","comment_is_top":false,"comment_ctime":1587333065,"is_pvip":false,"replies":[{"id":"77805","content":"这是可能的。你可以试试换一个分配策略，比如设置partition.assignment.strategy=org.apache.kafka.clients.consumer.RoundRobinAssignor试试。后引入的RoundRobinAssingor在对抗极端情况时比默认的RangeAssignor要均匀一些，不妨试试","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1587345213,"ip_address":"","comment_id":208301,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35947071433","product_id":100029201,"comment_content":"老师您好, 我们在生产环境中有一个90个分区的主题。部署了三十台机器的consumer group. 每个consumer理论上消费三个分区。我们发现有时rebalance发生后，分区不能平均的分配到consumer group中。极端情况下有的consumer被分到三十个分区。请问老师这种情况应该如何排查？","like_count":9,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492409,"discussion_content":"这是可能的。你可以试试换一个分配策略，比如设置partition.assignment.strategy=org.apache.kafka.clients.consumer.RoundRobinAssignor试试。后引入的RoundRobinAssingor在对抗极端情况时比默认的RangeAssignor要均匀一些，不妨试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587345213,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":200351,"user_name":"Sruby","can_delete":false,"product_type":"c1","uid":1016232,"ip_address":"","ucode":"A7D1B93F41DA0F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/81/a8/559afe8b.jpg","comment_is_top":false,"comment_ctime":1585575908,"is_pvip":false,"replies":[{"id":"75002","content":"可以啊。这的确是一种办法","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1585618092,"ip_address":"","comment_id":200351,"utype":1}],"discussion_count":2,"race_medal":1,"score":"35945314276","product_id":100029201,"comment_content":"将consumer端的业务逻辑放到另外一个线程中处理，是不是可以避免Consumer 消费时间过长的问题，同时提高消费速率？","like_count":9,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490002,"discussion_content":"可以啊。这的确是一种办法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585618092,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2981489,"avatar":"","nickname":"Geek_ca01c7","note":"","ucode":"AF79AEA9644EB2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":565854,"discussion_content":"麻烦问一下，要是这里单独的线程异步消费，那还可以手机提交offset吗，要是不能手动提交了，那是不是会有重复消费的风险呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650549308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":490002,"ip_address":""},"score":565854,"extra":""}]}]},{"had_liked":false,"id":195338,"user_name":"冬风向左吹","can_delete":false,"product_type":"c1","uid":1066928,"ip_address":"","ucode":"376C45C5134F93","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/b0/a9b77a1e.jpg","comment_is_top":false,"comment_ctime":1585181916,"is_pvip":false,"replies":[{"id":"74240","content":"hmmm.... 是这样的，所以社区2.4引入了静态consumer group成员，某种程度上可以规避这样的问题","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1585183701,"ip_address":"","comment_id":195338,"utype":1}],"discussion_count":2,"race_medal":0,"score":"35944920284","product_id":100029201,"comment_content":"如果代码升级，进程要重启，岂不是每次升级都会导致rebalance???","like_count":9,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489034,"discussion_content":"hmmm.... 是这样的，所以社区2.4引入了静态consumer group成员，某种程度上可以规避这样的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585183701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1762252,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e3/cc/0947ff0b.jpg","nickname":"nestle","note":"","ucode":"469800BED81B54","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":284922,"discussion_content":"instance id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592669805,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":133591,"user_name":"miwucc","can_delete":false,"product_type":"c1","uid":1326429,"ip_address":"","ucode":"7935BD907119AE","user_header":"https://static001.geekbang.org/account/avatar/00/14/3d/5d/ac666969.jpg","comment_is_top":false,"comment_ctime":1568616109,"is_pvip":false,"replies":[{"id":"51336","content":"会的。max.poll.interval.ms是rebalance的超时时间。broker端Coordinator挂掉不会引发rebalance","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1568678874,"ip_address":"","comment_id":133591,"utype":1}],"discussion_count":4,"race_medal":0,"score":"35928354477","product_id":100029201,"comment_content":"从0.10.1.x开始，客户端貌似已经把心跳线程和业务线程分开了，这样的话max.poll.interval.ms还是会影响心跳导致rebanlance吗？另外加入某个broker主分区挂掉，broker重新选组是不是也要引发reblance？","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467439,"discussion_content":"会的。max.poll.interval.ms是rebalance的超时时间。broker端Coordinator挂掉不会引发rebalance","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568678874,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":50102,"discussion_content":"brokder挂了,不会导致订阅主题的分区数发生变化吗,然后重平衡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573660659,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":2,"child_discussions":[{"author":{"id":1802337,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/80/61/ae3bb67c.jpg","nickname":"毛毛虫大帝","note":"","ucode":"1EBB026121C060","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337743,"discussion_content":"内部会不断的循环去发送FindCoordinatorRequest 请求发送给负载少的节点上获取元数据 直到找到新的协调者位置再恢复","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609066958,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":50102,"ip_address":""},"score":337743,"extra":""},{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1134861,"avatar":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","nickname":"James","note":"","ucode":"48B0F2A334D1C1","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379608,"discussion_content":"别人有副本的呀，这台的offset_topic的主分片挂了，选其他broker上的备份作为主分片","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624010520,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":50102,"ip_address":""},"score":379608,"extra":""}]}]},{"had_liked":false,"id":124494,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1565912783,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"35925651151","product_id":100029201,"comment_content":"1：rebalance是啥？<br>Rebalance 就是让一个 Consumer Group 下所有的 Consumer 实例就如何消费订阅主题的所有分区达成共识的过程。在 Rebalance 过程中，所有 Consumer 实例共同参与，在协调者组件的帮助下，完成订阅主题分区的分配。但是，在整个过程中，所有实例都不能消费任何消息，因此它对 Consumer 的 TPS 影响很大。<br><br>2：rebalance有啥弊端？<br>2-1：Rebalance 影响 Consumer 端 TPS。这个之前也反复提到了，这里就不再具体讲了。总之就是，在 Rebalance 期间，Consumer 会停下手头的事情，什么也干不了。<br>2-2：Rebalance 很慢。如果你的 Group 下成员很多，就一定会有这样的痛点。还记得我曾经举过的那个国外用户的例子吧？他的 Group 下有几百个 Consumer 实例，Rebalance 一次要几个小时。在那种场景下，Consumer Group 的 Rebalance 已经完全失控了。<br>2-3：Rebalance 效率不高。当前 Kafka 的设计机制决定了每次 Rebalance 时，Group 下的所有成员都要参与进来，而且通常不会考虑局部性原理，但局部性原理对提升系统性能是特别重要的。<br><br>3：rebalance啥时候发生？<br>3-1：组成员数量发生变化<br>3-2：订阅主题数量发生变化<br>3-3：订阅主题的分区数发生变化<br><br>4：rebalance的算法是啥？<br>4-1：全员参与的分区分配策略——目前的算法，也是rebalance慢的根源<br>4-2：粘性的分区分配策略——尽量不动没有问题的分区，重新分配有问题的分区<br><br>5：rebalance能否避免？<br>不能完全避免<br>只能最大限度的设置更为合理的参数，来避免非必要的rebalance，比如这些参数<br>5-1：session.timeout.ms<br>5-2：heartbeat.interval.ms<br>5-3：max.poll.interval.ms<br>5-4：GC参数<br><br>疑问？<br>rebalance的算法为啥最早是全员参与的方式？kafka起源于大数据，估计分区数比较多的情况应该早已经猜到。<br>另外，粘性的分区分配策略具体是怎么实现的，听起来不难，但是写kafka的人都实现的不佳，想必不是那么容易的，老师觉得实现的痛点在哪里？<br>","like_count":8},{"had_liked":false,"id":113303,"user_name":"z.l","can_delete":false,"product_type":"c1","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg","comment_is_top":false,"comment_ctime":1562940428,"is_pvip":false,"replies":[{"id":"41427","content":"是的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563157401,"ip_address":"","comment_id":113303,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35922678796","product_id":100029201,"comment_content":"”0.10.1之前是在调用poll方法时发送心跳的的，0.10.1之后consumer使用单独的心跳线程来发送“，是否意味着0.10.1之前如果一批消息的消费时间超过了session.timeout.ms，也会触发rebalabce?此时是不是应该保证max.poll.records个消息的消费时间必须小于session.timeout.ms？","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458158,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563157401,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":147178,"user_name":"注定非凡","can_delete":false,"product_type":"c1","uid":1113597,"ip_address":"","ucode":"80673056E131B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg","comment_is_top":false,"comment_ctime":1572832979,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"31637604051","product_id":100029201,"comment_content":"1 什么是重平衡<br>\tA ：让一个Consumer Group下所有的consumer实例就如何消费订阅主题的所有分区达成共识的过程。<br>\tB ：在重平衡过程中，所有Consumer实例共同参与，在协调者组件的帮助下，完成订阅分区的分配。<br>\tC ：整个过程中，所有实例都不能消费任何消息，因此对Consumer的TPS影响很大<br><br>2 为什要避免重平衡<br>\tA ：Rebalance影响Consumer端的TPS，因为重平衡过程中消费者不能消费消息<br>\tB ：Rebalance很慢，如果有数百个消费者实例，整个过程耗时可能达到几个小时<br>\tC ：Rebalance效率低，这个过程是全员参与，通常不考虑局部性原理，但局部性原理对系统性能提升特别重要。<br>\tD ：真实的业务场景中，很多Rebalance都是计划外或是不必要的。<br><br>3 何时会触发重平衡<br>\tA ：组成员数量发生变化<br>\tB ：订阅主题数量发生变化<br>\tC ：订阅主题分区数发生变化。<br><br>4, 要避免哪些重平衡<br>\t最常见的是消费者数发生变化触发的重平衡，其他的重平衡是不可避免的，但消费者数量变化是可避免的<br>\t<br>\tA ：Consumer实例增加<br>\t当启动一个配置相同的group.id值的consumer程序时，就是向这个组中增加一个消费者实例，这中秋情况一般是我们为了提升消费者端的TPS，是计划内的，所以也不用避免。<br>\t<br>\tB ：Consumer实例减少<br>\t\t（1）按计划的减少消费者实例，同样不用避免<br>\t\t（2）计划外的减少触发的重平衡才是我们要关注的。<br><br>5 如何避免重平衡<br>\t在某些情况下，Consumer实例会被Coordinateor错误地认为“已停止”，进而被踢出Group。这种情况导致的重平衡是需要避免的。<br>\t<br>\tA ：Consumer实例不能及时的发送心跳请求<br>当消费者组完成重平衡后，每个Consumer实例都会定期地向Coordinator发送心跳请求，如这个心跳请求没有被及时发送，Coordinator就会认为该Consumer已经掉线，将其从组中移除，并开启新一轮重平衡。<br><br>\t解决：Consumer端设置：<br>\t\t》Session.timeout.ms：默认为10秒，表示10秒内Coordinator没有收到Group下某个Consumer实例的心跳，就认为实例下线。这个可以适当的增大<br>\t\t》heartbeat.interval.ms：控制发送心跳请求的频率，频繁的发送心跳请求会额外消耗带库资源。<br>\t\t》max.poll.interval.ms：限定Consumer端应用程序两次调用poll方法的最大时间间隔。默认值是5分钟，表示如果Consumer程序在5分钟之内无法消费完poll方法返回的消息，那么consumer会主动的发起“离开组”的请求，<br>\t<br>建议：session.timeout.ms=6s<br>\tHeartbeat.interval.ms=2s<br>\t保证Consumer实例在判定为“dead”之前，能够发送至少3轮的心跳请求，即session.timeout.ms &gt;=3 * heartbeat.interval.ms。<br><br>\tB ：Consumer消费时间过长<br>\t\t消费者端处理了一个很重的消费逻辑，耗时较长，导致Consumer端应用程序两次调用poll方法的时间超出设置的最大时间间隔。<br>\t\t<br>\t\t解决：<br>                    1，将max.poll.interval.ms参数设置较大一些<br>                    2，优化消费者端业务逻辑，压缩消费耗时<br>\t<br>\tC ：GC影响<br>\t\tConsumer端的GC表现也会导致频繁的重平衡，频繁的Ful GC会导致长时间的断顿。<br>\t\t解决：<br>\t\t\tJVM调优。<br>","like_count":8},{"had_liked":false,"id":161841,"user_name":"杨陆伟","can_delete":false,"product_type":"c1","uid":1108457,"ip_address":"","ucode":"3BC968447406EB","user_header":"https://static001.geekbang.org/account/avatar/00/10/e9/e9/1f95e422.jpg","comment_is_top":false,"comment_ctime":1576375631,"is_pvip":true,"replies":[{"id":"61668","content":"一旦Coordinator将consumer踢出组，该consumer实例会禁掉心跳并等待前端主线程重新加入组","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1576457861,"ip_address":"","comment_id":161841,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27346179407","product_id":100029201,"comment_content":"消费者给协调者踢出后，还会继续保持心跳并重新连上吗？","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477878,"discussion_content":"一旦Coordinator将consumer踢出组，该consumer实例会禁掉心跳并等待前端主线程重新加入组","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576457861,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113288,"user_name":"花开成海","can_delete":false,"product_type":"c1","uid":1179974,"ip_address":"","ucode":"ED73A4ACFC5F72","user_header":"https://static001.geekbang.org/account/avatar/00/12/01/46/faf75ba6.jpg","comment_is_top":false,"comment_ctime":1562936031,"is_pvip":true,"replies":[{"id":"41428","content":"别增加。目前源代码中内部topic的分区被hard code成50了，如果后面修改会造成各种问题。已经有对应的bug来解决此事了，但代码还没有merge","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563157445,"ip_address":"","comment_id":113288,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27332739807","product_id":100029201,"comment_content":"请问，内部topic可以增加分区数量吗？有实践过吗？有一个很大集群，内部topic某个分区的副备偶发的被剔除isr然后再加入，观察发现这个分区的写入较大，所以希望增加分区数量。","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458153,"discussion_content":"别增加。目前源代码中内部topic的分区被hard code成50了，如果后面修改会造成各种问题。已经有对应的bug来解决此事了，但代码还没有merge","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563157445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119215,"user_name":"EricJones","can_delete":false,"product_type":"c1","uid":1207580,"ip_address":"","ucode":"0A80B609400D6B","user_header":"https://static001.geekbang.org/account/avatar/00/12/6d/1c/d9746372.jpg","comment_is_top":false,"comment_ctime":1564538646,"is_pvip":false,"replies":[{"id":"43865","content":"使用kafka-topics --describe 查看","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564627714,"ip_address":"","comment_id":119215,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23039375126","product_id":100029201,"comment_content":"查找 Coordinator 的第二步算法，如何查看 12 分区 的 Leader 副本呢？我有一个kafka集群 三个实例，结果我查看的时候只有第一个实例的数据目录下有 __consumer_offsets 目录有五十个。其他的两个实例下面并没有。我要怎么查看 12 分区 的 Leader 副本呢？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460791,"discussion_content":"使用kafka-topics --describe 查看","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564627714,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1197447,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","nickname":"😈😈😈😈😈","note":"","ucode":"A563EC007FEB7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":35814,"discussion_content":"offsets.topic.replication.factor可以改下这个参数","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1571307055,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":115113,"user_name":"其实我很屌","can_delete":false,"product_type":"c1","uid":1138722,"ip_address":"","ucode":"2B75EAAD748A60","user_header":"https://static001.geekbang.org/account/avatar/00/11/60/22/92284df2.jpg","comment_is_top":false,"comment_ctime":1563497385,"is_pvip":false,"replies":[{"id":"42089","content":"嗯，是的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563517552,"ip_address":"","comment_id":115113,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23038333865","product_id":100029201,"comment_content":"老师你好，问下，一个group.id内所有topic和分区的消费信息都是放在offset topic的一个分区里吗？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458972,"discussion_content":"嗯，是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563517552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113605,"user_name":"小白","can_delete":false,"product_type":"c1","uid":1004755,"ip_address":"","ucode":"9BB9A170023CD8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/d3/46fd4aa3.jpg","comment_is_top":false,"comment_ctime":1563092487,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"23037928967","product_id":100029201,"comment_content":"一个consumer group下的多个consumer部署在k8s上，每次发布新版本滚动升级的过程，就是不断发生Rebalance的过程好像没有太好的解决办法。","like_count":5,"discussions":[{"author":{"id":1115918,"avatar":"https://static001.geekbang.org/account/avatar/00/11/07/0e/b1676f59.jpg","nickname":"渡河人","note":"","ucode":"194F8C222554E4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":177098,"discussion_content":"个人思路：先把上面文章提到的各项设参数设置的大一些，然后进行滚动更新，这样操作的前提是需要参数配置中心的配合，不知道这样是否能搞定","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1582078649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112791,"user_name":"yhh","can_delete":false,"product_type":"c1","uid":1105102,"ip_address":"","ucode":"B566981788B6A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/ce/a144dea1.jpg","comment_is_top":false,"comment_ctime":1562827667,"is_pvip":false,"replies":[{"id":"41117","content":"也可以适当减少max.poll.records","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892366,"ip_address":"","comment_id":112791,"utype":1}],"discussion_count":1,"race_medal":0,"score":"23037664147","product_id":100029201,"comment_content":"想问下，如果消费者的业务处理时间不可控，比较难预知，，为避免Rebalance和消息重复消费，这种有什么好的解决办法吗？max.poll.interval.ms设得非常大？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457916,"discussion_content":"也可以适当减少max.poll.records","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892366,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112734,"user_name":"lmtoo","can_delete":false,"product_type":"c1","uid":1133918,"ip_address":"","ucode":"FCD5B9C941D448","user_header":"https://static001.geekbang.org/account/avatar/00/11/4d/5e/c5c62933.jpg","comment_is_top":false,"comment_ctime":1562811732,"is_pvip":false,"replies":[{"id":"41123","content":"针对整个group的。如果消费者组订阅信息发生变化也是会发生rebalance的。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892781,"ip_address":"","comment_id":112734,"utype":1}],"discussion_count":3,"race_medal":0,"score":"23037648212","product_id":100029201,"comment_content":"这个Rebalance是针对ConsumerGroup消费的某一个主题的，还是针对所有消费主题的？如果给消费者组增加了一个新的topic，会对该ConsumerGroup在其他已经消费的主题再平衡吗？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457885,"discussion_content":"针对整个group的。如果消费者组订阅信息发生变化也是会发生rebalance的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892781,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1051102,"avatar":"https://static001.geekbang.org/account/avatar/00/10/09/de/55cc6c2f.jpg","nickname":"大树","note":"","ucode":"53768ABF0013E7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4456,"discussion_content":"那是不是不建议多个topic放在一个consumergroup消费？我们有接近上百个topic在一个消费组消费，如果增加或者减少topic,都会引起rebalance么？","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1565434692,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1445399,"avatar":"https://static001.geekbang.org/account/avatar/00/16/0e/17/e16e679f.jpg","nickname":"guoyinbo2019","note":"","ucode":"19D86CB3E42839","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1762,"discussion_content":"从胡老师的文章看，貌似rebalance 会导致该group所有的consumer都重新平衡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562897733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112976,"user_name":"nightmare","can_delete":false,"product_type":"c1","uid":1056314,"ip_address":"","ucode":"EF2E51C2122A86","user_header":"https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg","comment_is_top":false,"comment_ctime":1562858852,"is_pvip":false,"replies":[{"id":"41108","content":"不能保证~","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562891503,"ip_address":"","comment_id":112976,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18742728036","product_id":100029201,"comment_content":"rebalance的时候必须等所有消费者都提交offset吗？如果没有提交，reblance这么保证精准一次的语义","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457990,"discussion_content":"不能保证~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562891503,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112931,"user_name":"RouGE","can_delete":false,"product_type":"c1","uid":1579581,"ip_address":"","ucode":"B8E9C9A4A5BFAF","user_header":"https://static001.geekbang.org/account/avatar/00/18/1a/3d/0b38d5bc.jpg","comment_is_top":false,"comment_ctime":1562849849,"is_pvip":false,"replies":[{"id":"41112","content":"会的。组成员发生了变更","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892110,"ip_address":"","comment_id":112931,"utype":1}],"discussion_count":4,"race_medal":0,"score":"18742719033","product_id":100029201,"comment_content":"假设这样的场景：开始groupa下只有一个consumer1，只注册在topic1下面。后来groupa下来了另一个consumer2，只注册在topic2下面。会发生rebalance吗？","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457960,"discussion_content":"会的。组成员发生了变更","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1270262,"avatar":"https://static001.geekbang.org/account/avatar/00/13/61/f6/1d6b548a.jpg","nickname":"wang","note":"","ucode":"C1A3BCACCB188E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":258274,"discussion_content":"我的理解是关于coordinator 是在哪个broker 上还是由两步算法决定的，1. 通过consumeGroupId 算出 hashcode=》paritionId ，2.从而得到改分区属于哪个broker 的被leader ，也就是在这个broker上的coordinator，也即是，这两个topic 分区leader 是在不通的broker上和coordinator 在哪个broker 上木有直接关系的","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588673256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1439408,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f6/b0/7ffbe2d4.jpg","nickname":"Bobo","note":"","ucode":"0E573F53BF417D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1770,"discussion_content":"如果这两个topic所在分区leader是不同的borker那是由哪一个协调器来rebalance呢","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1562901236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"lzh","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1439408,"avatar":"https://static001.geekbang.org/account/avatar/00/15/f6/b0/7ffbe2d4.jpg","nickname":"Bobo","note":"","ucode":"0E573F53BF417D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324100,"discussion_content":"别人不是根据group id对分区取余来决定coordinate的嘛...","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605057715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1770,"ip_address":""},"score":324100,"extra":""}]}]},{"had_liked":false,"id":112706,"user_name":"曹操","can_delete":false,"product_type":"c1","uid":1104259,"ip_address":"","ucode":"CCE34BD1C054DF","user_header":"https://static001.geekbang.org/account/avatar/00/10/d9/83/7c3ba3dc.jpg","comment_is_top":false,"comment_ctime":1562808523,"is_pvip":false,"replies":[{"id":"41133","content":"如果是之前的版本，设置该参数长一点是有意义的。有了max.poll.interval.ms之后，session.timeout.ms就唯一被用于检测failed consumer了。所以还是尽早发现为好吧","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562893158,"ip_address":"","comment_id":112706,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18742677707","product_id":100029201,"comment_content":"将 session.timeout.ms 设置成 6s 主要是为了让 Coordinator 能够更快地定位已经挂掉的 Consumer。<br><br>尽快发现已经挂掉的consumer好像不能避免rebalance<br>kafka默认时间10s，这个时间间隔设置长一点是不是能避免由于网络不稳导致的心跳发送不及时问题，这样是不是能更好的避免rebalance？","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457865,"discussion_content":"如果是之前的版本，设置该参数长一点是有意义的。有了max.poll.interval.ms之后，session.timeout.ms就唯一被用于检测failed consumer了。所以还是尽早发现为好吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893158,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112649,"user_name":"honnkyou","can_delete":false,"product_type":"c1","uid":1026608,"ip_address":"","ucode":"FD5EC4120EE803","user_header":"https://static001.geekbang.org/account/avatar/00/0f/aa/30/acc91f01.jpg","comment_is_top":false,"comment_ctime":1562800873,"is_pvip":false,"replies":[{"id":"40971","content":"每个consumer可能设置不同的session.timeout.ms","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562803851,"ip_address":"","comment_id":112649,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18742670057","product_id":100029201,"comment_content":"session.timeout.ms为什么设置在customer端而不是coordinator端？","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457835,"discussion_content":"每个consumer可能设置不同的session.timeout.ms","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562803851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":273423,"user_name":"Z","can_delete":false,"product_type":"c1","uid":1253772,"ip_address":"","ucode":"A0ADA997048FC8","user_header":"https://static001.geekbang.org/account/avatar/00/13/21/8c/489792fd.jpg","comment_is_top":false,"comment_ctime":1610593515,"is_pvip":true,"replies":[{"id":"99087","content":"牛掰！","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1610620705,"ip_address":"","comment_id":273423,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14495495403","product_id":100029201,"comment_content":"1. 缩短单条消息处理的时间：这个涉及业务流程的优化或者改造，得具体问题具体分析，在 bps 这个场景，暂时没有优化的空间<br>2. 增加消费者端允许下游系统消费一批消息的最大时长：当消费者组完成重平衡之后，每个消费者实例都会定期地向协调者发送心跳请求，表明它还存活着。如果某个消费者实例不能及时地发送这些心跳请求，协调者就会认为该消费者已经“死”了，从而将其从组中移除，然后开启新一轮重平衡。消费者端有个参数，叫 session.timeout.ms，就是被用来表征此事的。该参数的默认值是 10 秒，即如果协调者在 10 秒之内没有收到组内某个消费者实例的心跳，它就会认为这个消费者实例已经挂了。可以这么说，session.timeout.ms 决定了消费者存活性的时间间隔<br>3. 控制发送心跳请求频率：消费者还提供了一个允许你控制发送心跳请求频率的参数，就是 heartbeat.interval.ms。这个值设置得越小，消费者实例发送心跳请求的频率就越高。频繁地发送心跳请求会额外消耗带宽资源，但好处是能够更加快速地知晓当前是否开启重平衡<br>4. 减少下游系统一次性消费的消息总数：这取决于消费者端参数 max.poll.records 的值。当前该参数的默认值是 500 条，表明调用一次 KafkaConsumer.poll 方法，最多返回 500 条消息。可以说，该参数规定了单次 poll 方法能够返回的消息总数的上限。如果前两种方法对你都不适用的话，降低此参数值是避免 CommitFailedException 异常最简单的手段<br>5. 调整两次调用 poll 方法的最大时间间隔：消费者端还有一个参数，用于控制消费者实际消费能力对重平衡的影响，即 max.poll.interval.ms 参数。它限定了消费者端应用程序两次调用 poll 方法的最大时间间隔。它的默认值是 5 分钟，表示你的消费者程序如果在 5 分钟之内无法消费完 poll 方法返回的消息，那么消费者会主动发起“离开组”的请求，协调者也会开启新一轮重平衡<br>6. 下游系统使用多线程来加速消费：具体的思路就是，让下游系统手动创建多个消费线程处理 poll 方法返回的一批消息。之前你使用 Kafka 消费者消费数据更多是单线程的，所以当消费速度无法匹及 Kafka 消费者消息返回的速度时，它就会抛出 CommitFailedException 异常。如果是多线程，你就可以灵活地控制线程数量，随时调整消费承载能力，再配以目前多核的硬件条件，该方法可谓是防止 CommitFailedException 最高档的解决之道。事实上，很多主流的大数据流处理框架使用的都是这个方法，比如 Apache Flink 在集成 Kafka 时，就是创建了多个 KafkaConsumerThread 线程，自行处理多线程间的数据消费。不过，凡事有利就有弊，这个方法实现起来并不容易，特别是在多个线程间如何处理位移提交这个问题上，更是极容易出错。","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513603,"discussion_content":"牛掰！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610620705,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":266664,"user_name":"Lvjsky","can_delete":false,"product_type":"c1","uid":1257661,"ip_address":"","ucode":"9DC0F199596CAF","user_header":"https://static001.geekbang.org/account/avatar/00/13/30/bd/00cc9f72.jpg","comment_is_top":false,"comment_ctime":1607431791,"is_pvip":false,"replies":[{"id":"96918","content":"如果不是structured streaming，Spark streaming并未使用consumer group机制。它用的是standalone consumer","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1607562023,"ip_address":"","comment_id":266664,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14492333679","product_id":100029201,"comment_content":"老师，作为小白用户，我想问一下，以Spark Streaming为例，在集群上实时消费Kafka的数据。假如这个任务给的资源是--num-executors 20，--executor-cores 4，一共有80个cores，也就是80个并行的Task。是不是表示当前在同一个Consumer Group中，有80个Consumer实例呢","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511344,"discussion_content":"如果不是structured streaming，Spark streaming并未使用consumer group机制。它用的是standalone consumer","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607562023,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":155429,"user_name":"美美","can_delete":false,"product_type":"c1","uid":1148422,"ip_address":"","ucode":"44CC95C45AF345","user_header":"https://static001.geekbang.org/account/avatar/00/11/86/06/72b01bb7.jpg","comment_is_top":false,"comment_ctime":1574688486,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14459590374","product_id":100029201,"comment_content":"为啥rebalance很慢没有解释","like_count":3},{"had_liked":false,"id":151175,"user_name":"James","can_delete":false,"product_type":"c1","uid":1134861,"ip_address":"","ucode":"48B0F2A334D1C1","user_header":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","comment_is_top":false,"comment_ctime":1573660669,"is_pvip":false,"replies":[{"id":"58199","content":"broker挂了，分区数不会变啊","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1573694816,"ip_address":"","comment_id":151175,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14458562557","product_id":100029201,"comment_content":"请问一下<br>brokder挂了,不会导致订阅主题的分区数发生变化吗,然后重平衡","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474391,"discussion_content":"broker挂了，分区数不会变啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573694816,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128995,"user_name":"蛋炒番茄","can_delete":false,"product_type":"c1","uid":1095049,"ip_address":"","ucode":"3F963347C4A97C","user_header":"https://static001.geekbang.org/account/avatar/00/10/b5/89/9a1b4dee.jpg","comment_is_top":false,"comment_ctime":1567003254,"is_pvip":false,"replies":[{"id":"48030","content":"1. 单独的心跳线程汇报，不是poll调用时上报<br>2. 该参数控制心跳频率，没有其他方式能做到这点<br>3. 你只提到了一个参数，另一个参数是什么？？","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567040774,"ip_address":"","comment_id":128995,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14451905142","product_id":100029201,"comment_content":"kafka中消费者与broke有几种保持心跳的方式？<br>1、每次消费者调用poll拉取数据的时候都会向上报心跳？<br><br>2、heartbeat.interval.ms该参数也可以控制上报心跳？<br>是否还有其他的方式？<br>求指点<br><br>这两个参数有啥区别，为什么要这两种两种渠道保持心跳？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465217,"discussion_content":"1. 单独的心跳线程汇报，不是poll调用时上报\n2. 该参数控制心跳频率，没有其他方式能做到这点\n3. 你只提到了一个参数，另一个参数是什么？？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567040774,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113367,"user_name":"wykkx","can_delete":false,"product_type":"c1","uid":1122358,"ip_address":"","ucode":"ABCDF49E7A95C8","user_header":"https://static001.geekbang.org/account/avatar/00/11/20/36/b3e2f1d5.jpg","comment_is_top":false,"comment_ctime":1562985272,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"14447887160","product_id":100029201,"comment_content":"老师今天提到这几个参数，貌似都不能避免Rebalance，而是尽快让Rebalance发生吧。。。。。。 如果是要尽量避免的话，session.timeout.ms和max.poll.interval.ms都应该设置的大一些，来增加时间窗口，过滤掉网络抖动或者个别情况下下游处理慢的情况。","like_count":3,"discussions":[{"author":{"id":1122358,"avatar":"https://static001.geekbang.org/account/avatar/00/11/20/36/b3e2f1d5.jpg","nickname":"wykkx","note":"","ucode":"ABCDF49E7A95C8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2420,"discussion_content":"请老师解惑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563588891,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112717,"user_name":"刘易宁","can_delete":false,"product_type":"c1","uid":1566569,"ip_address":"","ucode":"EE337683D08B9A","user_header":"https://static001.geekbang.org/account/avatar/00/17/e7/69/0c426b52.jpg","comment_is_top":false,"comment_ctime":1562809354,"is_pvip":false,"replies":[{"id":"41129","content":"试想如果heartbeat.interval.ms &gt; session.timeout.ms，那么当下次发送心跳时，会话已经过期了，心跳也就没有意义了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892967,"ip_address":"","comment_id":112717,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14447711242","product_id":100029201,"comment_content":"在官方文档上面看到：heartbeat.interval.ms必须设置为session.timeout.ms以下，通常应设置不高于session.timeout.ms的1&#47;3。请问这样设置的原因是什么呢？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457874,"discussion_content":"试想如果heartbeat.interval.ms &amp;gt; session.timeout.ms，那么当下次发送心跳时，会话已经过期了，心跳也就没有意义了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892967,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112645,"user_name":"ikimiy","can_delete":false,"product_type":"c1","uid":1067295,"ip_address":"","ucode":"CC67E87B99EE3C","user_header":"https://static001.geekbang.org/account/avatar/00/10/49/1f/37e18877.jpg","comment_is_top":false,"comment_ctime":1562796734,"is_pvip":false,"replies":[{"id":"40972","content":"0.9的确没有这个参数。你依然只能设置session.timeout.ms来规避<br><br>","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562803885,"ip_address":"","comment_id":112645,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14447698622","product_id":100029201,"comment_content":"0.9版本里面好像没有最长消费时间参数max.poll.interval.ms，在0.9版本中如何控制消费时长<br>关于GC的设置，老师后续会有讲到吗？应该如何设置是最佳实践<br><br>","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457833,"discussion_content":"0.9的确没有这个参数。你依然只能设置session.timeout.ms来规避\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562803885,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":262257,"user_name":"风","can_delete":false,"product_type":"c1","uid":1147929,"ip_address":"","ucode":"AFDBEFA49F269E","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","comment_is_top":false,"comment_ctime":1605677549,"is_pvip":true,"replies":[{"id":"95238","content":"不是的。分区数和broker挂不挂没关系。broker A挂了，broker B会顶上来继续为分区提供服务","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1605750445,"ip_address":"","comment_id":262257,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10195612141","product_id":100029201,"comment_content":"老师,我看您回复问题是说 broker挂了，分区数不会变,这是为什么,假设一个topic有8个分区,均匀分布在8个broker上,其中一个挂了,实际上可访问到的分区不就只有7个了吗？还是说这个分区数就是看topic配置了多少个分区？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509754,"discussion_content":"不是的。分区数和broker挂不挂没关系。broker A挂了，broker B会顶上来继续为分区提供服务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605750445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1147929,"avatar":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","nickname":"风","note":"","ucode":"AFDBEFA49F269E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":327170,"discussion_content":"就是说broker A挂了，那么原来broker  A对应分区在其他broker的分区副本会成为leader提供服务是吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605758239,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253962,"user_name":"借你一秒","can_delete":false,"product_type":"c1","uid":1612068,"ip_address":"","ucode":"CA2F0EC4E26889","user_header":"https://static001.geekbang.org/account/avatar/00/18/99/24/460937df.jpg","comment_is_top":false,"comment_ctime":1602992548,"is_pvip":false,"replies":[{"id":"92792","content":"也没有多大的隐患。。。Kafka Streams内部就是把这个参数设置成Integer.MAX_VALUE的","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1603073663,"ip_address":"","comment_id":253962,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10192927140","product_id":100029201,"comment_content":"老师，我采用了Consumer Group消费组模型，把max.poll.interval.ms设置为int最大值，消息被处理后手动进行offset提交（消息处理比慢，时间不可控），这样会不会有什么隐患？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507230,"discussion_content":"也没有多大的隐患。。。Kafka Streams内部就是把这个参数设置成Integer.MAX_VALUE的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603073663,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175566,"user_name":"西边一抹残阳","can_delete":false,"product_type":"c1","uid":1197178,"ip_address":"","ucode":"6836AB08783DC5","user_header":"https://static001.geekbang.org/account/avatar/00/12/44/7a/d27c1ed3.jpg","comment_is_top":false,"comment_ctime":1580745686,"is_pvip":false,"replies":[{"id":"68340","content":"后者。整个Kafka集群只有一个位移主题","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1580864630,"ip_address":"","comment_id":175566,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10170680278","product_id":100029201,"comment_content":"老师，我有个问题・_・?是每个主题都会对应一个位移主题，还是所有主题都复用同一个位移主题","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482803,"discussion_content":"后者。整个Kafka集群只有一个位移主题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580864630,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146714,"user_name":"未来小娃","can_delete":false,"product_type":"c1","uid":1047329,"ip_address":"","ucode":"477D166EBB6B70","user_header":"https://static001.geekbang.org/account/avatar/00/0f/fb/21/d017438c.jpg","comment_is_top":false,"comment_ctime":1572614983,"is_pvip":true,"replies":[{"id":"56780","content":"新版本已经推出来了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1572769295,"ip_address":"","comment_id":146714,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10162549575","product_id":100029201,"comment_content":"觉得很有必要实现粘性分区分配（局部性原理），我觉得实现起来应该不难，为啥一直不推出呢","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472991,"discussion_content":"新版本已经推出来了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572769295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1130929,"avatar":"https://static001.geekbang.org/account/avatar/00/11/41/b1/565d0f56.jpg","nickname":".cc","note":"","ucode":"D99025BD7626C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158659,"discussion_content":"胡老师，是哪个版本呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580612523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":132643,"user_name":"快跑","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1568184083,"is_pvip":false,"replies":[{"id":"50881","content":"很多种原因而且如果我没记错的话，这是个INFO日志，你最好调整一下日志级别，看看能否打出真实的原因。从这个错误本身来看，这个异常就是表示consumer无法连接上Coordinator或Coordinator本身不可用了，可能的原因确实太多了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1568250472,"ip_address":"","comment_id":132643,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10158118675","product_id":100029201,"comment_content":"Spark Streaming消费Kafka的日志中，会有很多Marking the coordinator xxx:9092 (id: 2147483645 rack: null) dead for group xxx_etl日志。请教老师，这是什么原因引起的，对消费者任务有影响么？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":467051,"discussion_content":"很多种原因而且如果我没记错的话，这是个INFO日志，你最好调整一下日志级别，看看能否打出真实的原因。从这个错误本身来看，这个异常就是表示consumer无法连接上Coordinator或Coordinator本身不可用了，可能的原因确实太多了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1568250472,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1905527,"avatar":"","nickname":"Geek_03","note":"","ucode":"1502D858542269","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":289768,"discussion_content":"遇到了相同的问题，mark一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594207711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112945,"user_name":"其实我很屌","can_delete":false,"product_type":"c1","uid":1138722,"ip_address":"","ucode":"2B75EAAD748A60","user_header":"https://static001.geekbang.org/account/avatar/00/11/60/22/92284df2.jpg","comment_is_top":false,"comment_ctime":1562852968,"is_pvip":false,"replies":[{"id":"41110","content":"是你自己的非compact topic还是内部topic？它们是不同的策略。如果是compact topic，然后空间一直增长，那么有可能触发了其他的bug，应该不是这个bug。你可以用jstack去检查一下Log cleaner  thread的运行状态。通常都是因为这个线程挂了导致没法执行compaction了。<br><br>如果你的topic不是compact的，那就很奇怪了，你最好提供更多的信息，比如日志是否出现错误等。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562891773,"ip_address":"","comment_id":112945,"utype":1}],"discussion_count":3,"race_medal":0,"score":"10152787560","product_id":100029201,"comment_content":"老师你好，生产上遇到一个问题，log.retention.bytes配置的5g，log.segment.bytes是500m，然后这个topic就一直不会被清理，空间一直增长，已经十几g了单分区单副本，请问是触发了bug吗，见KAFKA-6030，急，求老师指教","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457968,"discussion_content":"是你自己的非compact topic还是内部topic？它们是不同的策略。如果是compact topic，然后空间一直增长，那么有可能触发了其他的bug，应该不是这个bug。你可以用jstack去检查一下Log cleaner  thread的运行状态。通常都是因为这个线程挂了导致没法执行compaction了。\n\n如果你的topic不是compact的，那就很奇怪了，你最好提供更多的信息，比如日志是否出现错误等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562891773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1138722,"avatar":"https://static001.geekbang.org/account/avatar/00/11/60/22/92284df2.jpg","nickname":"其实我很屌","note":"","ucode":"2B75EAAD748A60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1752,"discussion_content":"我严重怀疑Log里def size: Long = logSegments.map(_.size).sum这句话的问题，LogSegment里的size是int，这里应该是先执行遍历加和吧，那5G就会溢出int。但是5G的配置并不算大吧，难道社区没有人测试或者发现这个问题？因为我对scala不熟，所以也不敢确定这里是否一定有问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1138722,"avatar":"https://static001.geekbang.org/account/avatar/00/11/60/22/92284df2.jpg","nickname":"其实我很屌","note":"","ucode":"2B75EAAD748A60","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1751,"discussion_content":"日志里没有出现异常，其他topic都在正常清理，当然那些topic都是因为时间到了被清理的，没有因为大小到了被roll然后dleete的。我刚才在新评论里说明了，现在使用电脑版才发现还可以评论。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112861,"user_name":"尔我","can_delete":false,"product_type":"c1","uid":1319959,"ip_address":"","ucode":"3D219237D7ED16","user_header":"https://static001.geekbang.org/account/avatar/00/14/24/17/0705993b.jpg","comment_is_top":false,"comment_ctime":1562833543,"is_pvip":false,"replies":[{"id":"41116","content":"这个30秒是写死在代码中的，不是由参数控制的。不过你可以调用带参数的close方法来指定关闭等待时长","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892349,"ip_address":"","comment_id":112861,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10152768135","product_id":100029201,"comment_content":"之前我们从0.9.0.0升级到0.10.2.0版本时，日志消费高峰期发生过每30s触发一次reblance的情况；查看官方文档发现版本变更中有这么一条“Java consumer now shuts down gracefully. By default, the consumer waits up to 30 seconds to complete pending requests. A new close API with timeout has been added to KafkaConsumer to control the maximum wait time.” 我的理解应该是默认情况下kafka等待 consumer处理一条消息超过30s没有提交offset的话就把这个consumer标记为下线然后就触发reblance，但是查看max.poll.interval.ms参数默认设置是300000(300s),感觉不是这个参数限制的，求老师解惑。","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457933,"discussion_content":"这个30秒是写死在代码中的，不是由参数控制的。不过你可以调用带参数的close方法来指定关闭等待时长","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892349,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280537,"user_name":"快跑","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1614244089,"is_pvip":false,"replies":[{"id":"102233","content":"尚未找到Coordinator对应的broker的意思","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1614821925,"ip_address":"","comment_id":280537,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5909211385","product_id":100029201,"comment_content":"实际项目遇到这样一个Case：<br>User class threw exception: org.apache.kafka.clients.consumer.RetriableCommitFailedException: Offset commit failed with a retriable exception. You should retry committing the latest consumed offsets.<br>Caused by: org.apache.kafka.common.errors.TimeoutException: The request timed out.<br><br>查看源码，有一个if (!coordinatorUnknown())的判断，请教老师coordinatorUnknown是怎么样的一个状态，什么情况会到这coordinator Unknown呢","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516127,"discussion_content":"尚未找到Coordinator对应的broker的意思","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614821925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268149,"user_name":"Geek_315567","can_delete":false,"product_type":"c1","uid":1100316,"ip_address":"","ucode":"9D4B2E95087B90","user_header":"https://static001.geekbang.org/account/avatar/00/10/ca/1c/9ce0eaea.jpg","comment_is_top":false,"comment_ctime":1608084604,"is_pvip":false,"replies":[{"id":"97817","content":"是经常性地碰到这个异常吗？这个问题可能的原因是rebalance太频繁了，可以按照这个思路查下","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1608775563,"ip_address":"","comment_id":268149,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5903051900","product_id":100029201,"comment_content":"请问老师，生产环境遇到这个问题，查了很多资料也没找到原因，请指导下。org.apache.kafka.clients.consumer.RetriableCommitFailedException: Offset commit failed with a retriable exception. You should retry committing offsets.<br>Caused by: org.apache.kafka.common.errors.TimeoutException: Failed to send request after 85000 ms.","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511859,"discussion_content":"是经常性地碰到这个异常吗？这个问题可能的原因是rebalance太频繁了，可以按照这个思路查下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608775563,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264577,"user_name":"但爱","can_delete":false,"product_type":"c1","uid":1170751,"ip_address":"","ucode":"6F885E6EC3F4F9","user_header":"https://static001.geekbang.org/account/avatar/00/11/dd/3f/6310de91.jpg","comment_is_top":false,"comment_ctime":1606529328,"is_pvip":false,"replies":[{"id":"96044","content":"目前看也没有什么太大的问题，可以尝试下。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606698792,"ip_address":"","comment_id":264577,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5901496624","product_id":100029201,"comment_content":"老师你好，在我的应用场景中也碰到了由于max.poll.interval.ms配置过低导致rebalance，但是我们不同的是，我们的业务处理时间不可控，那这个配置做成多少合理，我也看到一些人将配置做成max integer，这样配置会有什么问题吗？谢谢","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510607,"discussion_content":"目前看也没有什么太大的问题，可以尝试下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606698792,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259519,"user_name":"慎独明强","can_delete":false,"product_type":"c1","uid":1965699,"ip_address":"","ucode":"DC2F7F2C0C8F60","user_header":"https://static001.geekbang.org/account/avatar/00/1d/fe/83/df562574.jpg","comment_is_top":false,"comment_ctime":1604739898,"is_pvip":false,"replies":[{"id":"94407","content":"1. 消费者实例指的是KafkaConsumer实例。你可以把它运行在一个进程中，也可以用在线程中。每个实例对应于一个分区。<br>2. 每个实例每次poll最多不会超过100条，但可能小于100。<br>3. 取决于这个异常是什么以及你如何应对异常。如果异常很严重且不可重试，那么你需要确定后面如何处理并根据这个决定来决定要不要为这条消息提交位移。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1604886790,"ip_address":"","comment_id":259519,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5899707194","product_id":100029201,"comment_content":"胡老师我这边有个疑问一直没想明白，希望得到老师的解答。一个消费者实例会对应一个broker的分区，这一个消费者实例指的是进程还是线程，生产环境基本都是一台服务器启动一个消费者进程，在消费端配置是可以配置并发线程数，并发线程配置为3，问题一，那这三个线程是对应一个分区还是三个分区？还有个max.poll.record=100参数，指每次去服务端拉取100条消息，那么如果我配置了消费线程为3，问题二，是指每个线程都去拉取100条吗？ 问题三，开启的手动提交，我们写消费者实例时，每次是监听一条消息，如果在这一批消息里，调用下沉服务处理时异常，如果没有手动去提交，这条消息还会被消费吗？会不会被这100条消息后面消息消费成功后把消费进度覆盖了，造成消息丢失？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508949,"discussion_content":"1. 消费者实例指的是KafkaConsumer实例。你可以把它运行在一个进程中，也可以用在线程中。每个实例对应于一个分区。\n2. 每个实例每次poll最多不会超过100条，但可能小于100。\n3. 取决于这个异常是什么以及你如何应对异常。如果异常很严重且不可重试，那么你需要确定后面如何处理并根据这个决定来决定要不要为这条消息提交位移。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604886790,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253170,"user_name":"对与错","can_delete":false,"product_type":"c1","uid":1682027,"ip_address":"","ucode":"EF55733E3BD78B","user_header":"https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg","comment_is_top":false,"comment_ctime":1602640857,"is_pvip":false,"replies":[{"id":"92795","content":"这是非常可能的。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1603073920,"ip_address":"","comment_id":253170,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5897608153","product_id":100029201,"comment_content":"请问发生full GC引起的rebalance，是因为长时间的GC导致停顿时间超过了心跳监测的时间而引起的吗?","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506992,"discussion_content":"这是非常可能的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603073920,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329373,"discussion_content":"session时间是6  GC了7s 一直无回复 肯定协调者认为他 挂了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606373274,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245951,"user_name":"李同学","can_delete":false,"product_type":"c1","uid":2143931,"ip_address":"","ucode":"DE69BAB9C27756","user_header":"https://static001.geekbang.org/account/avatar/00/20/b6/bb/fa825992.jpg","comment_is_top":false,"comment_ctime":1599119435,"is_pvip":true,"replies":[{"id":"90468","content":"如果你未使用消费者组机制，就没有rebalance的问题。否则，默认情况下是会rebalance的，因为max.poll.interval.ms默认值要小于2个小时","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1599205152,"ip_address":"","comment_id":245951,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5894086731","product_id":100029201,"comment_content":"老师您好，一个消费者消费40个分区的数据，经常会出现消费速度太慢，延迟能达到2小时，这种情况会不会涉及到rebalance呢？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505017,"discussion_content":"如果你未使用消费者组机制，就没有rebalance的问题。否则，默认情况下是会rebalance的，因为max.poll.interval.ms默认值要小于2个小时","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599205152,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":227674,"user_name":"J.Smile","can_delete":false,"product_type":"c1","uid":1336475,"ip_address":"","ucode":"C4D98DFDBF7584","user_header":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","comment_is_top":false,"comment_ctime":1592451548,"is_pvip":false,"replies":[{"id":"83932","content":"所以动态Rebalance成员管理机制很难用，社区于2.4引入了静态Rebalance成员管理","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592472701,"ip_address":"","comment_id":227674,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5887418844","product_id":100029201,"comment_content":"Rebalance 发生的时机有三个：<br>● 组成员数量发生变化   ----可以避免非必要Rebalance<br>      第一类非必要 Rebalance 是因为未能及时发送心跳，导致 Consumer 被“踢出”Group 而引发的<br>      第二类非必要 Rebalance 是 Consumer 消费时间过长导致的Consumer主动发起离开Group请求<br><br>● 订阅主题数量发生变化    ------通常都是运维的主动操作，不可避免<br>● 订阅主题的分区数发生变化   ------通常都是运维的主动操作，不可避免<br>","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498744,"discussion_content":"所以动态Rebalance成员管理机制很难用，社区于2.4引入了静态Rebalance成员管理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592472701,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":220783,"user_name":"老邢","can_delete":false,"product_type":"c1","uid":1433138,"ip_address":"","ucode":"28944333440C0D","user_header":"https://static001.geekbang.org/account/avatar/00/15/de/32/509d6b10.jpg","comment_is_top":false,"comment_ctime":1590323600,"is_pvip":false,"replies":[{"id":"81428","content":"可以不使用消费者组，改使用standalone consumer","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1590328848,"ip_address":"","comment_id":220783,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5885290896","product_id":100029201,"comment_content":"老师，有配置可以关闭reblance吗","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496237,"discussion_content":"可以不使用消费者组，改使用standalone consumer","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590328848,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214596,"user_name":"花开成海","can_delete":false,"product_type":"c1","uid":1179974,"ip_address":"","ucode":"ED73A4ACFC5F72","user_header":"https://static001.geekbang.org/account/avatar/00/12/01/46/faf75ba6.jpg","comment_is_top":false,"comment_ctime":1588770638,"is_pvip":true,"replies":[{"id":"79564","content":"会发生rebalance","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1588846016,"ip_address":"","comment_id":214596,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5883737934","product_id":100029201,"comment_content":"max.poll.interval.ms 表示相邻两次poll的时间间隔不大于的阀值，如果process过程因为下游服务问题，某个时间点数据都无返回响应，并且因为没有设置超时断开时间，连接一直保持，因为poll是单线程处理，当前也无法执行下一次poll 方法，这种情况下消费组是不是不会发生重组？ 这种情况其实我期望的是发生重组。        ","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494133,"discussion_content":"会发生rebalance","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588846016,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210973,"user_name":"dawn","can_delete":false,"product_type":"c1","uid":1296063,"ip_address":"","ucode":"1757B28F1EF5C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/c6/bf/52b3f71d.jpg","comment_is_top":false,"comment_ctime":1587872112,"is_pvip":false,"replies":[{"id":"78507","content":"你的意思是：消费不同主题时，是不是最好用不同的消费者组？<br><br>嗯，使用多少消费者组更多还是基于业务来考虑的。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1587896603,"ip_address":"","comment_id":210973,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5882839408","product_id":100029201,"comment_content":"请问老师，消费不同主题时，消费者组名是不是最好设置成不同的？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493162,"discussion_content":"你的意思是：消费不同主题时，是不是最好用不同的消费者组？\n\n嗯，使用多少消费者组更多还是基于业务来考虑的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587896603,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":195341,"user_name":"冬风向左吹","can_delete":false,"product_type":"c1","uid":1066928,"ip_address":"","ucode":"376C45C5134F93","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/b0/a9b77a1e.jpg","comment_is_top":false,"comment_ctime":1585182062,"is_pvip":false,"replies":[{"id":"74239","content":"1. 新增topic；2. topic新增分区<br>","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1585183670,"ip_address":"","comment_id":195341,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5880149358","product_id":100029201,"comment_content":"订阅主题数量发生变化 指的是增加了新的topic？还是某个已有的topic增加了新的订阅对象？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489036,"discussion_content":"1. 新增topic；2. topic新增分区\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585183670,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164946,"user_name":"kevin","can_delete":false,"product_type":"c1","uid":1237471,"ip_address":"","ucode":"5F6D82F118C6F6","user_header":"https://static001.geekbang.org/account/avatar/00/12/e1/df/6e6a4c6b.jpg","comment_is_top":false,"comment_ctime":1577115088,"is_pvip":false,"replies":[{"id":"62872","content":"消息处理时间太久依然会触发rebalance的。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1577149065,"ip_address":"","comment_id":164946,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5872082384","product_id":100029201,"comment_content":"0.10.1之后consumer使用单独的心跳线程来发送<br>—-如果是单独线程发心跳，是不是不会因为消息太久而导致rebalance尼，毕竟两线程并无相互印象","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478963,"discussion_content":"消息处理时间太久依然会触发rebalance的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577149065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":164833,"user_name":"InkInn","can_delete":false,"product_type":"c1","uid":1181035,"ip_address":"","ucode":"FFE79181F3D29B","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/6b/8ab7601c.jpg","comment_is_top":false,"comment_ctime":1577097771,"is_pvip":false,"replies":[{"id":"62873","content":"消息如果在max.poll.interval.ms时间内处理不完就会触发rebalance。社区提供该参数的目的就是为了把这个含义从session.timeout.ms中剥离，因此这是个与rebalance很有关系的参数","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1577149194,"ip_address":"","comment_id":164833,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5872065067","product_id":100029201,"comment_content":"max.poll.interval.ms 和 心跳机制 这两个条件是或的关系吗？不满足其中一个，就会Rebalance？能不能一直保持心跳，而不关注max.poll.interval.ms，不让consumer被踢出去？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478910,"discussion_content":"消息如果在max.poll.interval.ms时间内处理不完就会触发rebalance。社区提供该参数的目的就是为了把这个含义从session.timeout.ms中剥离，因此这是个与rebalance很有关系的参数","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577149194,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":141087,"user_name":"绿箭侠","can_delete":false,"product_type":"c1","uid":1528536,"ip_address":"","ucode":"B994F558A98E29","user_header":"https://static001.geekbang.org/account/avatar/00/17/52/d8/123a4981.jpg","comment_is_top":false,"comment_ctime":1571112169,"is_pvip":false,"replies":[{"id":"54650","content":"C++应该没有向Java GC的担忧吧：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1571188059,"ip_address":"","comment_id":141087,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5866079465","product_id":100029201,"comment_content":"胡大，请问GC的问题只是在实现Consumer JAVA API的情况下才需要考虑的呗？比如我使用C++ 的API呢？！","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470666,"discussion_content":"C++应该没有向Java GC的担忧吧：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571188059,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":114108,"user_name":"外星人","can_delete":false,"product_type":"c1","uid":1132861,"ip_address":"","ucode":"D8469B13F2AB37","user_header":"https://static001.geekbang.org/account/avatar/00/11/49/3d/4ac37cc2.jpg","comment_is_top":false,"comment_ctime":1563238795,"is_pvip":false,"replies":[{"id":"41691","content":"不会。rebalance是针对消费者组而言的，但迁移任何主题的分区都要小心，尽量避免业务高峰吧。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563274652,"ip_address":"","comment_id":114108,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5858206091","product_id":100029201,"comment_content":"您好，请问对内部主题__consumer_offset做reassign会不会导致rebalance？做reassign过程中，cosumer端commit失败，会不会重试？重试逻辑是怎样的啊？还有没有其他影响呢？谢谢","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458521,"discussion_content":"不会。rebalance是针对消费者组而言的，但迁移任何主题的分区都要小心，尽量避免业务高峰吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563274652,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113187,"user_name":"天天~","can_delete":false,"product_type":"c1","uid":1198331,"ip_address":"","ucode":"782A23AB38D39B","user_header":"https://static001.geekbang.org/account/avatar/00/12/48/fb/eb91160d.jpg","comment_is_top":false,"comment_ctime":1562911056,"is_pvip":false,"replies":[{"id":"41192","content":"嗯，是这样的。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562912648,"ip_address":"","comment_id":113187,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5857878352","product_id":100029201,"comment_content":"老师您好，我们的consumer是部署在某个项目中，线上有2个实例，那岂不是每次该项目上线部署时，都会触发Rebalance？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458099,"discussion_content":"嗯，是这样的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562912648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113065,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1562892720,"is_pvip":false,"replies":[{"id":"41139","content":"刚快地感知rebalance的好处就是能更快地参与到rebalance过程中，省的做无用功了。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562894125,"ip_address":"","comment_id":113065,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5857860016","product_id":100029201,"comment_content":"再问一次老师消费者组可以很快的感知到Rebalance后接下来比较好的做法是什么呢，我认为感知应该不是目的而是知道下一步行动的信号，那比较好的下一步行动应该是啥？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458040,"discussion_content":"刚快地感知rebalance的好处就是能更快地参与到rebalance过程中，省的做无用功了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562894125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112779,"user_name":"dream","can_delete":false,"product_type":"c1","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1562824980,"is_pvip":false,"replies":[{"id":"41119","content":"只要你的consumer调用poll方法就没事。和有没有新消息产生没关心","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892463,"ip_address":"","comment_id":112779,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5857792276","product_id":100029201,"comment_content":"请问，由于一段时间内没有 producer 往 kafka 里面写消息，导致 Consumer 组中没有消息，这个时间超过 max.poll.interval.ms 的设置，那 consumer 会离开组吗？那如果过一段时间有消息写入 kafka ，consumer 会怎么样？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457910,"discussion_content":"只要你的consumer调用poll方法就没事。和有没有新消息产生没关心","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892463,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1035562,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/cd/2a/bdbed6ed.jpg","nickname":"无菇朋友","note":"","ucode":"80482C5F0464A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1725,"discussion_content":"可能在一个循环里，没有消息消费代表不断做无结果的poll操作，而由于业务导致两次poll的时间超过max值会导致rebalance","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562848098,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112750,"user_name":"yhh","can_delete":false,"product_type":"c1","uid":1105102,"ip_address":"","ucode":"B566981788B6A2","user_header":"https://static001.geekbang.org/account/avatar/00/10/dc/ce/a144dea1.jpg","comment_is_top":false,"comment_ctime":1562814840,"is_pvip":false,"replies":[{"id":"41122","content":"消费完消息后需要再次调用poll方法才行。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892748,"ip_address":"","comment_id":112750,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5857782136","product_id":100029201,"comment_content":"max.poll.interval.ms，在这个时间内不能消费完一次poll的消息，就要让它离开消费者组，感觉是不是有点粗暴的？还有怎么才算是消费完消息，是要提交位移吗？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457893,"discussion_content":"消费完消息后需要再次调用poll方法才行。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112689,"user_name":"明翼","can_delete":false,"product_type":"c1","uid":1068361,"ip_address":"","ucode":"E77F86BEB3D5C1","user_header":"https://static001.geekbang.org/account/avatar/00/10/4d/49/28e73b9c.jpg","comment_is_top":false,"comment_ctime":1562807084,"is_pvip":false,"replies":[{"id":"41135","content":"hmmm..... 如果GC超过了6s，感觉还是先解决GC为好：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562893364,"ip_address":"","comment_id":112689,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5857774380","product_id":100029201,"comment_content":"我们遇到的问题和老师案例中很像是因为消费的数据处理逻辑太重造成的超时，以前0.8.2版本，session_timeout和那个最大时间间隔参数是一起的只能加大这个参数的配置。<br>有个问题请教下，为什么文中设置了session_timeout为6秒尽快剔除死掉的消费者能够避免平衡那？如果有gc超过了6s，岂不是增加了重新平衡的次数","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457858,"discussion_content":"hmmm..... 如果GC超过了6s，感觉还是先解决GC为好：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562893364,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":353062,"user_name":"陆凌枫","can_delete":false,"product_type":"c1","uid":1349513,"ip_address":"陕西","ucode":"622DEFC9DACDBA","user_header":"https://static001.geekbang.org/account/avatar/00/14/97/89/51f532f8.jpg","comment_is_top":false,"comment_ctime":1659105191,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1659105191","product_id":100029201,"comment_content":"老师你好，为什么不提供参数，直接关闭rebalance机制呢？或者说直接关闭掉可能会造成什么问题？","like_count":0},{"had_liked":false,"id":348303,"user_name":"设置昵称","can_delete":false,"product_type":"c1","uid":2644306,"ip_address":"","ucode":"7B0199B53B9B96","user_header":"https://static001.geekbang.org/account/avatar/00/28/59/52/1d92a110.jpg","comment_is_top":false,"comment_ctime":1654948318,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654948318","product_id":100029201,"comment_content":"rebalance不会导致消息重复消费吗","like_count":0},{"had_liked":false,"id":347900,"user_name":"懵逼猴","can_delete":false,"product_type":"c1","uid":1204947,"ip_address":"","ucode":"BDC748A96AC316","user_header":"https://static001.geekbang.org/account/avatar/00/12/62/d3/663de972.jpg","comment_is_top":false,"comment_ctime":1654567882,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654567882","product_id":100029201,"comment_content":"如果消费者版本更新造成的重启是不是也会造成Rebalance?","like_count":0},{"had_liked":false,"id":336280,"user_name":"后视镜抗衰老","can_delete":false,"product_type":"c1","uid":1122023,"ip_address":"","ucode":"BDD8974BD44C9D","user_header":"https://static001.geekbang.org/account/avatar/00/11/1e/e7/942becae.jpg","comment_is_top":false,"comment_ctime":1646048719,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646048719","product_id":100029201,"comment_content":"如果分区是3个，consumer是8个，那么增加一个或者减少一个会不会引起Rebalance ？还是说减少的是消费了分区的consumer才会去Rebalance？","like_count":0},{"had_liked":false,"id":335618,"user_name":"冷酷无情的刷题机器","can_delete":false,"product_type":"c1","uid":1806593,"ip_address":"","ucode":"3BBC91020770BF","user_header":"https://static001.geekbang.org/account/avatar/00/1b/91/01/f99ba551.jpg","comment_is_top":false,"comment_ctime":1645605500,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645605500","product_id":100029201,"comment_content":"遭遇过kafka阻塞的情况，从日志发现是重平衡次数过多，当时也试过老师说的这几个参数，但是效果不大，后来发现是full gc 次数过多导致的，分析内存占用并重新分配内存后，重平衡次数就减少了","like_count":0},{"had_liked":false,"id":333800,"user_name":"起风了","can_delete":false,"product_type":"c1","uid":2719086,"ip_address":"","ucode":"730DC69D98608F","user_header":"https://static001.geekbang.org/account/avatar/00/29/7d/6e/ac873f72.jpg","comment_is_top":false,"comment_ctime":1644541892,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644541892","product_id":100029201,"comment_content":"老师，请教一下。能监控重平衡的发生吗","like_count":0},{"had_liked":false,"id":330846,"user_name":"Angle","can_delete":false,"product_type":"c1","uid":2894168,"ip_address":"","ucode":"6C9A5D25EFC431","user_header":"https://static001.geekbang.org/account/avatar/00/2c/29/58/81c32ccb.jpg","comment_is_top":false,"comment_ctime":1642221559,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642221559","product_id":100029201,"comment_content":"老师我有2个问题：<br>1如何查看一个consumer group里面的consumer的数量，或者consumer group和consumer的关系是？<br>2为什么&#47;什么情况下消费者组成员个数会发生变化？请举例说明。谢谢~","like_count":0},{"had_liked":false,"id":328499,"user_name":"just code it","can_delete":false,"product_type":"c1","uid":1140836,"ip_address":"","ucode":"9953DAD398F33D","user_header":"https://static001.geekbang.org/account/avatar/00/11/68/64/756ba667.jpg","comment_is_top":false,"comment_ctime":1640754630,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1640754630","product_id":100029201,"comment_content":"老师你好，如果一个消费组里的所有消费者一直连续阻塞好几个小时，broker认为消费者死掉了，会一直rebalance吗？","like_count":0},{"had_liked":false,"id":326753,"user_name":"Geek_61f664","can_delete":false,"product_type":"c1","uid":2421631,"ip_address":"","ucode":"A97893B5367CF1","user_header":"","comment_is_top":false,"comment_ctime":1639661335,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639661335","product_id":100029201,"comment_content":"还有一个机制static member可以解决同一个consumer临时下线然后在session.timeout.ms时间内重新上线后，不会触发重平衡。","like_count":0},{"had_liked":false,"id":311590,"user_name":"郑印","can_delete":false,"product_type":"c1","uid":1005282,"ip_address":"","ucode":"181B0FDE5E1532","user_header":"https://static001.geekbang.org/account/avatar/00/0f/56/e2/2dcab30d.jpg","comment_is_top":false,"comment_ctime":1631327689,"is_pvip":false,"replies":[{"id":"114444","content":"引入静态消费者组的主要目的就是为了应对这种场景下不出现rebalance","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1634004754,"ip_address":"","comment_id":311590,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1631327689","product_id":100029201,"comment_content":"请问一下，如果业务服务更新了程序代码，在部署重启过程中也会导致consumer被判断下线，然后重启完成就恢复了，这个过程可能也就1分钟内，需要避免这样情况导致的rebalance吗?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526670,"discussion_content":"引入静态消费者组的主要目的就是为了应对这种场景下不出现rebalance","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634004754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":307621,"user_name":"lv_xinrong","can_delete":false,"product_type":"c1","uid":1495405,"ip_address":"","ucode":"6D2E9177D2C7CC","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJiaqmSyTArAd2iaf5xF5PZBxDoFGknLqQ8SyJAIdBEaYRDLg3ExdPLvjqjTbduefRW7vklA9t4JySQ/132","comment_is_top":false,"comment_ctime":1629181846,"is_pvip":false,"replies":[{"id":"112535","content":"是的。","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1630810773,"ip_address":"","comment_id":307621,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1629181846","product_id":100029201,"comment_content":"看起来，业务服务的日常发版，就会造成rebalance啊，是这样吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525219,"discussion_content":"是的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630810773,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":303397,"user_name":"光","can_delete":false,"product_type":"c1","uid":1284618,"ip_address":"","ucode":"BDA7F41566E4FE","user_header":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","comment_is_top":false,"comment_ctime":1626768234,"is_pvip":true,"replies":[{"id":"110335","content":"是否会自动加回来取决于你的consumer程序是怎么实现的","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1627784453,"ip_address":"","comment_id":303397,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1626768234","product_id":100029201,"comment_content":"问下，消费实例被踢出去之后还会自动加回来么。现在看到个问题是踢出去之后一直没有加进来。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523660,"discussion_content":"是否会自动加回来取决于你的consumer程序是怎么实现的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627784453,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1284618,"avatar":"https://static001.geekbang.org/account/avatar/00/13/9a/0a/6c74e932.jpg","nickname":"光","note":"","ucode":"BDA7F41566E4FE","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":397472,"discussion_content":"能具体讲讲么。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632625889,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298754,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1624289262,"is_pvip":true,"replies":[{"id":"108486","content":"不是。控制器是controller，完全是两个东西","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1624497452,"ip_address":"","comment_id":298754,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1624289262","product_id":100029201,"comment_content":"所有 Broker 都有各自的 Coordinator 组件<br>--------------------------------------------<br>请问这个Coordinator 与 26讲kafka控制器是一个概念吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522231,"discussion_content":"不是。控制器是controller，完全是两个东西","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624497452,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295493,"user_name":"Jason Ding","can_delete":false,"product_type":"c1","uid":1365944,"ip_address":"","ucode":"E62AB51E7F2D6E","user_header":"https://static001.geekbang.org/account/avatar/00/14/d7/b8/74819eb4.jpg","comment_is_top":false,"comment_ctime":1622449665,"is_pvip":false,"replies":[{"id":"107776","content":"不会的","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1623120435,"ip_address":"","comment_id":295493,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1622449665","product_id":100029201,"comment_content":"GroupCoordinator发生变化是不是也会导致Rebalance？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521099,"discussion_content":"不会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623120435,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":293658,"user_name":"Johnson","can_delete":false,"product_type":"c1","uid":1218343,"ip_address":"","ucode":"E05B656B238C33","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/27/385b3e33.jpg","comment_is_top":false,"comment_ctime":1621480503,"is_pvip":false,"replies":[{"id":"106415","content":"从100开始","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1621509449,"ip_address":"","comment_id":293658,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1621480503","product_id":100029201,"comment_content":"老师，请教一个问题：<br>假如原来主题分区p1被consumer c1消费，并且offset为100， 那么如果rebalance后p1被分配给consumer c2消费，那么c2是从头开始消费p1分区，还是从c1之前提交的offset 100开始消费呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520309,"discussion_content":"从100开始","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621509449,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1218343,"avatar":"https://static001.geekbang.org/account/avatar/00/12/97/27/385b3e33.jpg","nickname":"Johnson","note":"","ucode":"E05B656B238C33","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375203,"discussion_content":"也就是Rebalance后换个消费者去消费一个被其它消费者消费过的分区，新的消费者是从原来消费者的offset开始消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1621513620,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290478,"user_name":"liian2019","can_delete":false,"product_type":"c1","uid":1503741,"ip_address":"","ucode":"22F639944F0EA0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epvjpicXzEv02d9ztRzIWIicbejyFTTtRA5K6oYmdicq9HQgGfRn3DLytTHQ6CHspb0TibqFkMibhBXj2g/132","comment_is_top":false,"comment_ctime":1619581188,"is_pvip":true,"replies":[{"id":"105277","content":"1、不一定啊，__consumer_offsets对应分区的leader副本可能变更到别的机器上<br>2、是的，会做迁移。offset管理机制是不变的，这个过程就是一个普通topic leader副本变更的过程<br>3、consumer通常是处理完消息后发现要rebalance了。至于是否能提交成功，取决于后面join group的速度，可能成功也可能不成功","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1619599591,"ip_address":"","comment_id":290478,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1619581188","product_id":100029201,"comment_content":"有下面一些疑惑，烦请各位帮忙解惑一下<br>1. partitionId=Math.abs(groupId.hashCode() % offsetsTopicPartitionCount)，这个算法获取分区ID，那是否说明只要分区数不变，groupId不变那Coordinator就一直在这台机器上。<br>2. 如果这台broker坏了，下线了，kafka有什么处理机制吗，Coordinator会自动迁移到别的机器吗？后续的offset如何管理。<br>3. Rebalance的时候，正在消费的消息是否能正常消费结束，消费完之后offset会正常提交吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":519214,"discussion_content":"1、不一定啊，__consumer_offsets对应分区的leader副本可能变更到别的机器上\n2、是的，会做迁移。offset管理机制是不变的，这个过程就是一个普通topic leader副本变更的过程\n3、consumer通常是处理完消息后发现要rebalance了。至于是否能提交成功，取决于后面join group的速度，可能成功也可能不成功","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619599591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287694,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1618110690,"is_pvip":true,"replies":[{"id":"104999","content":"大概率不回","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1619004042,"ip_address":"","comment_id":287694,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1618110690","product_id":100029201,"comment_content":"去除zk 依赖， 应该会缩减rebalance 的时间吧","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518392,"discussion_content":"大概率不回","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619004042,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":285771,"user_name":"Geek_f7defb","can_delete":false,"product_type":"c1","uid":2404088,"ip_address":"","ucode":"1B1CA533385C6A","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/HCeXc20SSFyyGZibOrHF2WxWia146MrIGgYSsmxGdl48LZC1LmBC4Vnk8Rv1fqQUibTssiaZnGeia2O08uhM8G2yOmw/132","comment_is_top":false,"comment_ctime":1617007768,"is_pvip":false,"replies":[{"id":"103780","content":"会回来。consumer会尝试重新加入组","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1617067706,"ip_address":"","comment_id":285771,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1617007768","product_id":100029201,"comment_content":"问一个比较白痴的问题，如果由max.poll.records 引起的Rebalance触发 对应该消费者被踢出去 此消费者还会重新回来吗，几时回来","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":517776,"discussion_content":"会回来。consumer会尝试重新加入组","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617067706,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280878,"user_name":"波罗学","can_delete":false,"product_type":"c1","uid":1205078,"ip_address":"","ucode":"CB78EF873C68B6","user_header":"https://static001.geekbang.org/account/avatar/00/12/63/56/859add63.jpg","comment_is_top":false,"comment_ctime":1614434341,"is_pvip":true,"replies":[{"id":"102232","content":"新版引入了静态成员，值得一试","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1614821899,"ip_address":"","comment_id":280878,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1614434341","product_id":100029201,"comment_content":"rebalance 的消耗时间有参考数据吗？不同的分区数、不同的 consumer 数，大概 rebalance 的时间，总觉的被那个几个小时 rebalance 的案例给吓到了，过百的 consumer rebalance 要几个小时，原因是什么？已经不敢用 consumer group 模式，而且重启又不可避免的 rebalance，而且还会丢失精确一致性。为什么觉得还是要单分区靠谱。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516231,"discussion_content":"新版引入了静态成员，值得一试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614821899,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":279715,"user_name":"Geek_505716","can_delete":false,"product_type":"c1","uid":1879982,"ip_address":"","ucode":"4D521700DE208E","user_header":"","comment_is_top":false,"comment_ctime":1613919646,"is_pvip":false,"replies":[{"id":"101807","content":"就是consumer.poll方法调用返回的消息集合","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1614217312,"ip_address":"","comment_id":279715,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1613919646","product_id":100029201,"comment_content":"老师，什么叫poll方法返回的消息","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515847,"discussion_content":"就是consumer.poll方法调用返回的消息集合","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614217312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":276428,"user_name":"快跑","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1611920471,"is_pvip":false,"replies":[{"id":"100450","content":"这个通常是因为连不上broker导致的，看下与broker之间的连通性吧。重设group id跟这个问题关系不大","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1612143211,"ip_address":"","comment_id":276428,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1611920471","product_id":100029201,"comment_content":"老师你好，实际工作中遇到这样情况，Spark Streaming任务消费kafka，启动任务会报错如下，重新设置group id也无济于事。<br>报错如下：<br>org.apache.kafka.common.errors.TimeoutException: Timeout of 60000ms expired before the position for partition topic-name-1 could be determined<br><br>目前猜测是因为rebalance.timeout.ms参数相关错误。但没有想清楚为什么会产生rebalance<br><br>请教老师，产生这个问题的原因会是什么呢？ 我应该怎么解决","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514699,"discussion_content":"这个通常是因为连不上broker导致的，看下与broker之间的连通性吧。重设group id跟这个问题关系不大","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612143211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":273759,"user_name":"猪头粽","can_delete":false,"product_type":"c1","uid":2053214,"ip_address":"","ucode":"4A0F54FA00B3D9","user_header":"https://static001.geekbang.org/account/avatar/00/1f/54/5e/2cfeb6a4.jpg","comment_is_top":false,"comment_ctime":1610672071,"is_pvip":false,"replies":[{"id":"99932","content":"通过心跳线程通知consumer rebalance开启，consumer收到后会自觉停止工作，参与到rebalance","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1611539502,"ip_address":"","comment_id":273759,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1610672071","product_id":100029201,"comment_content":"请问一下coordinator是如何让所有的consumer停止工作的。是触发rabalance的时候，给所有consumer发送通知吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513802,"discussion_content":"通过心跳线程通知consumer rebalance开启，consumer收到后会自觉停止工作，参与到rebalance","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611539502,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":270646,"user_name":"张三丰","can_delete":false,"product_type":"c1","uid":1155275,"ip_address":"","ucode":"3A6215A40B3B21","user_header":"https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg","comment_is_top":false,"comment_ctime":1609206101,"is_pvip":false,"replies":[{"id":"98446","content":"这里给出的值只是一个best pratice。你当然可以设置自己觉得合适的值，不过一切效果以测试为准：）","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1609724047,"ip_address":"","comment_id":270646,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1609206101","product_id":100029201,"comment_content":"请教老师一个问题，这个地方为何要至少保证三次？<br>一次不行吗？session.timeout.ms时间内只要有心跳，它就不会发生重平衡。<br><br>要保证 Consumer 实例在被判定为“dead”之前，能够发送至少 3 轮的心跳请求，即 session.timeout.ms &gt;= 3 * heartbeat.interval.ms。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512701,"discussion_content":"这里给出的值只是一个best pratice。你当然可以设置自己觉得合适的值，不过一切效果以测试为准：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609724047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268496,"user_name":"夏日","can_delete":false,"product_type":"c1","uid":1214167,"ip_address":"","ucode":"A5DBEB3E437728","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/d7/33d628b1.jpg","comment_is_top":false,"comment_ctime":1608217145,"is_pvip":false,"replies":[{"id":"97589","content":"嗯，但依然存在：消息未及时处理完而被Coordinator认为consumer已死从未被踢出组的情形","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1608516619,"ip_address":"","comment_id":268496,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1608217145","product_id":100029201,"comment_content":"胡老师，文中提及到在0.11版本后kafka将消费线程和发送心跳线程分开了，那是不是意味0.11版本后不存在因为消息未处理完导致心跳未提交情况？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511954,"discussion_content":"嗯，但依然存在：消息未及时处理完而被Coordinator认为consumer已死从未被踢出组的情形","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608516619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":266069,"user_name":"风","can_delete":false,"product_type":"c1","uid":1147929,"ip_address":"","ucode":"AFDBEFA49F269E","user_header":"https://static001.geekbang.org/account/avatar/00/11/84/19/7ed2ffa6.jpg","comment_is_top":false,"comment_ctime":1607158129,"is_pvip":true,"replies":[{"id":"97245","content":"不会的。目前只能手动迁移分区数据","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1607909253,"ip_address":"","comment_id":266069,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1607158129","product_id":100029201,"comment_content":"老师,请问主题增加分区数的话,那原分区的数据会自动迁移部分到新的分区吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511141,"discussion_content":"不会的。目前只能手动迁移分区数据","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607909253,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263983,"user_name":"Coding小先","can_delete":false,"product_type":"c1","uid":1051563,"ip_address":"","ucode":"965B1CC757E026","user_header":"https://static001.geekbang.org/account/avatar/00/10/0b/ab/0e2857e5.jpg","comment_is_top":false,"comment_ctime":1606307538,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606307538","product_id":100029201,"comment_content":"问题排查指南，值得收藏了","like_count":0},{"had_liked":false,"id":257047,"user_name":"Jace.L","can_delete":false,"product_type":"c1","uid":2221085,"ip_address":"","ucode":"2E9301594DBB17","user_header":"https://static001.geekbang.org/account/avatar/00/21/e4/1d/2bf0bab1.jpg","comment_is_top":false,"comment_ctime":1603844405,"is_pvip":false,"replies":[{"id":"93586","content":"查看server或client端的日志。你也可以在ConsumerRebalanceListener接口的方法中实现自己的通知机制","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1603851091,"ip_address":"","comment_id":257047,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1603844405","product_id":100029201,"comment_content":"老师，请问下，如何知道是否发生了rebalance啊","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508200,"discussion_content":"查看server或client端的日志。你也可以在ConsumerRebalanceListener接口的方法中实现自己的通知机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603851091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255428,"user_name":"piboye","can_delete":false,"product_type":"c1","uid":1066752,"ip_address":"","ucode":"7CFD8712857A85","user_header":"https://static001.geekbang.org/account/avatar/00/10/47/00/3202bdf0.jpg","comment_is_top":false,"comment_ctime":1603341454,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1603341454","product_id":100029201,"comment_content":"如果是k8s, pod 因为调度导致下线上线，如果这样都会导致rebalance, 感觉很难接受啊。","like_count":0},{"had_liked":false,"id":252955,"user_name":"Geek_b9f53f","can_delete":false,"product_type":"c1","uid":2043150,"ip_address":"","ucode":"BCC528E8692196","user_header":"","comment_is_top":false,"comment_ctime":1602548258,"is_pvip":false,"replies":[{"id":"92489","content":"两个可能想到的原因是：1. 这个主题所有的消息都已经被消费完了，没有可消费的新消息了；2. 这个主题有格式不完整消息（corruptted message)导致consumer卡住了。可以具体调研下consumer端或server.log的日志来确认下","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1602637101,"ip_address":"","comment_id":252955,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1602548258","product_id":100029201,"comment_content":"老师您好，我现在遇到一个问题是：有一个主题，消费者消费一段时间后（大约两分钟）就死了，再也不消费了，只有重启程序才恢复正常，而同样的代码消费另外一个主题就没有问题，请问这一般是什么原因造成的","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506925,"discussion_content":"两个可能想到的原因是：1. 这个主题所有的消息都已经被消费完了，没有可消费的新消息了；2. 这个主题有格式不完整消息（corruptted message)导致consumer卡住了。可以具体调研下consumer端或server.log的日志来确认下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602637101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2043150,"avatar":"","nickname":"Geek_b9f53f","note":"","ucode":"BCC528E8692196","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":312657,"discussion_content":"谢谢。目前已通过重启broker解决。怀疑是有部分broker出问题了，因为用自带的kafka-consumer-groups.sh工具也无法获取到消费者组的信息，卡在那里，最后提示超时","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602760754,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":243416,"user_name":"无妄","can_delete":false,"product_type":"c1","uid":1132385,"ip_address":"","ucode":"E29805189AA7FE","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/61/6b114c98.jpg","comment_is_top":false,"comment_ctime":1598099623,"is_pvip":false,"replies":[{"id":"89762","content":"使用2.4新增的静态消费者组功能可以避免<br>","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1598232357,"ip_address":"","comment_id":243416,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1598099623","product_id":100029201,"comment_content":"老师您好，在日常工作中需求发布上线必不可少，上线时在平滑也避免不了单个服务暂停十几秒，这个时候消费群组的消费者实例肯定会有变更，感觉这个重平衡没办法避免啊，还是我理解有误，还有每次流量高峰秒杀的时候可能会扩容，这个时候实例增多还是会重平衡，想问下实际是怎么避免这类问题的","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504280,"discussion_content":"使用2.4新增的静态消费者组功能可以避免\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1598232357,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":242651,"user_name":"王晓辉","can_delete":false,"product_type":"c1","uid":1716922,"ip_address":"","ucode":"EA3D488F5269F1","user_header":"https://static001.geekbang.org/account/avatar/00/1a/32/ba/16a12b9e.jpg","comment_is_top":false,"comment_ctime":1597805146,"is_pvip":false,"replies":[{"id":"89545","content":"使用assign表示不使用消费者组机制，自然就没有rebalance一说了。使用assign就是所谓的standalone consumer","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1597885498,"ip_address":"","comment_id":242651,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1597805146","product_id":100029201,"comment_content":"老师能介绍一下KafkaConsumer.assign 接口的相关特性吗？使用assign接口是不是就可以规避rebalancing了","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504064,"discussion_content":"使用assign表示不使用消费者组机制，自然就没有rebalance一说了。使用assign就是所谓的standalone consumer","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597885498,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230928,"user_name":"盐多必失","can_delete":false,"product_type":"c1","uid":1218415,"ip_address":"","ucode":"B9DBB12E0D1D74","user_header":"https://static001.geekbang.org/account/avatar/00/12/97/6f/4cd459f2.jpg","comment_is_top":false,"comment_ctime":1593524962,"is_pvip":false,"replies":[{"id":"85367","content":"嗯，各家工具各有所长，鼓励大家各显其能","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1593607100,"ip_address":"","comment_id":230928,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1593524962","product_id":100029201,"comment_content":"查看某分区的 leader？用 kafka tool 查看不香麽？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500077,"discussion_content":"嗯，各家工具各有所长，鼓励大家各显其能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593607100,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226882,"user_name":"密码123456","can_delete":false,"product_type":"c1","uid":1126593,"ip_address":"","ucode":"9889463CC0EA71","user_header":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","comment_is_top":false,"comment_ctime":1592223124,"is_pvip":false,"replies":[{"id":"83661","content":"“每个分区会生成5～6的位移主题文件夹” --- 这句话是什么意思？ 这里的分区是指__consumer_offsets的分区吗？","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592296445,"ip_address":"","comment_id":226882,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1592223124","product_id":100029201,"comment_content":"我的kafka是2.11。window环境下。3分区，3副本。在第一个consumer连接下，每个分区会生成5～6的位移主题文件夹。但是没有通过公式算出来的那个分区，咋回事？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498401,"discussion_content":"“每个分区会生成5～6的位移主题文件夹” --- 这句话是什么意思？ 这里的分区是指__consumer_offsets的分区吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592296445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1126593,"avatar":"https://static001.geekbang.org/account/avatar/00/11/30/c1/2dde6700.jpg","nickname":"密码123456","note":"","ucode":"9889463CC0EA71","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":283710,"discussion_content":"嗯。是的。__consumer_offsets_xx","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592351980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226805,"user_name":"末北。","can_delete":false,"product_type":"c1","uid":1246109,"ip_address":"","ucode":"6C6C06416E77D3","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/9d/a245af6a.jpg","comment_is_top":false,"comment_ctime":1592206812,"is_pvip":false,"replies":[{"id":"83667","content":"没有详细的信息很难进一步分析原因。可能的原因是消息格式有问题导致consumer卡住了","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1592297151,"ip_address":"","comment_id":226805,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1592206812","product_id":100029201,"comment_content":"老师好，我们业务场景中经常出现消费者（监听的某个topic）突然之间收不到消息，消息阻塞了，重启之后又正常了，但是同一个消费者组的其他消费者（监听的其他topic）都是正常的，想请问下这种现象会是什么原因导致的。","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498370,"discussion_content":"没有详细的信息很难进一步分析原因。可能的原因是消息格式有问题导致consumer卡住了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592297151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":200816,"user_name":"Tengsir","can_delete":false,"product_type":"c1","uid":1284893,"ip_address":"","ucode":"F442C81A34850C","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqibbTP09CH2pB0oicJeE1xHJedhkASnGsxVrLOavuC0x8o8L8RzhCQwGjAnCqJbBy6cbW8RJ6CAe0g/132","comment_is_top":false,"comment_ctime":1585655961,"is_pvip":false,"replies":[{"id":"75164","content":"进程重启，正常情况下只会触发一次rebalance","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1585665105,"ip_address":"","comment_id":200816,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1585655961","product_id":100029201,"comment_content":"想讨论个问题，消费者所在进程重启，那么会触发两次rebalance吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":490140,"discussion_content":"进程重启，正常情况下只会触发一次rebalance","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585665105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1284893,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqibbTP09CH2pB0oicJeE1xHJedhkASnGsxVrLOavuC0x8o8L8RzhCQwGjAnCqJbBy6cbW8RJ6CAe0g/132","nickname":"Tengsir","note":"","ucode":"F442C81A34850C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":218820,"discussion_content":"比如我重启的时候消费者并不是主动退出的，【1，2，3，4】四个消费者，我重启3，我理解的是，session时间内，3并没有主动退出，但3进程重启时创建了一个新的消费者5，那消费成员的变化就变为了【1，2，3，4，5】，这样会重平衡一次，然后3的session时间过了，组成员又变更为了【1，3，4，5】这样又会重平衡，不知道理解的对不对","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585703749,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":188865,"user_name":"大坏狐狸","can_delete":false,"product_type":"c1","uid":1325678,"ip_address":"","ucode":"5044F89A505C5B","user_header":"https://static001.geekbang.org/account/avatar/00/14/3a/6e/e39e90ca.jpg","comment_is_top":false,"comment_ctime":1584428091,"is_pvip":false,"replies":[{"id":"72973","content":"加油！","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1584491493,"ip_address":"","comment_id":188865,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584428091","product_id":100029201,"comment_content":"写总结最好的点就在于会更仔细的阅读文章，反复的思考，而且会更加集中精神","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487552,"discussion_content":"加油！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584491493,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":163546,"user_name":"高志强","can_delete":false,"product_type":"c1","uid":1276563,"ip_address":"","ucode":"68737002043752","user_header":"https://static001.geekbang.org/account/avatar/00/13/7a/93/c9302518.jpg","comment_is_top":false,"comment_ctime":1576741220,"is_pvip":false,"replies":[{"id":"62279","content":"您指的积压是什么意思？另外宕机的log trace有吗？看看是因为什么原因宕机？","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1576802879,"ip_address":"","comment_id":163546,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1576741220","product_id":100029201,"comment_content":"老师，kafka 分区消息积压量过大，每个分区达到4000往上，消费时linux内存增高，占用40%以上机器不一会儿就宕机了，请问有什么参数可以避免这种情况，kafka消息从磁盘读取后放到内存的量如何控制呢","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":478442,"discussion_content":"您指的积压是什么意思？另外宕机的log trace有吗？看看是因为什么原因宕机？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576802879,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1130929,"avatar":"https://static001.geekbang.org/account/avatar/00/11/41/b1/565d0f56.jpg","nickname":".cc","note":"","ucode":"D99025BD7626C6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":158657,"discussion_content":"1、&#34;Linux内存增高，占用40%以上机器不一会就宕机&#34;，两个问题:\n1.机器是物理机还是虚拟机或者胖容器？\n2.机器宕机的日志中看宕机原因？不一定与kafka有关系。\n2、消息消费最理想的情况是都走pagecache，不涉及磁盘IO，但消息大量堆积情况下，pagecache换入换出避免不了，这时磁盘IO\n是瓶颈，内存不是；\n3、Linux操作系统通过设置min_free_kbytes参数来控制机器预留最小内存，不一定对你有帮助，主要还是看具体问题，具体现象。\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1580612284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1276563,"avatar":"https://static001.geekbang.org/account/avatar/00/13/7a/93/c9302518.jpg","nickname":"高志强","note":"","ucode":"68737002043752","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1130929,"avatar":"https://static001.geekbang.org/account/avatar/00/11/41/b1/565d0f56.jpg","nickname":".cc","note":"","ucode":"D99025BD7626C6","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":161823,"discussion_content":"是虚拟机，内存耗尽导致的宕机","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1580918121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":158657,"ip_address":""},"score":161823,"extra":""}]}]},{"had_liked":false,"id":151165,"user_name":"James","can_delete":false,"product_type":"c1","uid":1134861,"ip_address":"","ucode":"48B0F2A334D1C1","user_header":"https://static001.geekbang.org/account/avatar/00/11/51/0d/fc1652fe.jpg","comment_is_top":false,"comment_ctime":1573659920,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573659920","product_id":100029201,"comment_content":"今天出现Rebalance,但是还是不知道是什么原因.<br>不知道是gc,还是因为Rebalance导致gc..还是参数的设置不合理.(有数据处理后插入redis),好像也有出现broker一个节点挂了. 问题真多都不知道是什么原因.慢慢排查吧(累死了)<br>","like_count":0},{"had_liked":false,"id":144435,"user_name":"快跑","can_delete":false,"product_type":"c1","uid":1564645,"ip_address":"","ucode":"90ED7E6D40C58E","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","comment_is_top":false,"comment_ctime":1571921234,"is_pvip":false,"replies":[{"id":"55698","content":"不太清楚你是用的哪种模式（Direct&#47;Receiver）。从输出来看consumer id变化就是生成了新的消费者实例。你可以关注下Kafka端的日志，看看是否存在group rebalance的情况。当然如果你使用的是Direct模式，应该不存在rebalance，因为压根也没有使用group机制。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1571965672,"ip_address":"","comment_id":144435,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1571921234","product_id":100029201,"comment_content":"Spark Streaming做为消费者，batch时间间隔是40s，使用kafka-consumer-groups.sh --bootstrap-server local:9092 --describe --group  test_v1命令，发现CONSUMER-ID一直有变化。如果batch间隔是20s则CONSUMER-ID一直保持不变。<br>请问老师这个是什么情况？kafka consumer的分配怎么被spark batch的间隔影响到呢？ 我需要关注session.timeout.ms么？<br>目前用的是kafka版本是kafka_2.11-0.11.0.2，session.timeout.ms=10秒，要是老版本的30s貌似会更好理解一些","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471938,"discussion_content":"不太清楚你是用的哪种模式（Direct/Receiver）。从输出来看consumer id变化就是生成了新的消费者实例。你可以关注下Kafka端的日志，看看是否存在group rebalance的情况。当然如果你使用的是Direct模式，应该不存在rebalance，因为压根也没有使用group机制。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571965672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1564645,"avatar":"https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg","nickname":"快跑","note":"","ucode":"90ED7E6D40C58E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":39849,"discussion_content":"使用的就是direct模式，原来direct模式没有重平衡。一直在往这个方向排查。那设置40秒批次间隔，什么情况会导致每个批次任务都是新的消费者实例呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572001268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119223,"user_name":"EricJones","can_delete":false,"product_type":"c1","uid":1207580,"ip_address":"","ucode":"0A80B609400D6B","user_header":"https://static001.geekbang.org/account/avatar/00/12/6d/1c/d9746372.jpg","comment_is_top":false,"comment_ctime":1564539321,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564539321","product_id":100029201,"comment_content":"```<br>$ bin&#47;kafka-topics.sh  --zookeeper localhost:2181 --topic __consumer_offsets --describe<br>```<br>知道了。","like_count":0},{"had_liked":false,"id":117720,"user_name":"大楷","can_delete":false,"product_type":"c1","uid":1106663,"ip_address":"","ucode":"FD646018ED20BD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLnTzRY667VmE9IUCSLALeVBlu8mdHfkm02FGcpza42QJ9qicp8KOdMDgFABys0ZnZfGd6j0W1V9zw/132","comment_is_top":false,"comment_ctime":1564118830,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564118830","product_id":100029201,"comment_content":"老师好，请问Apache Pulsar如何，它貌似解决了kafka目前的一些痛点，未来是否可以代替kafka呢","like_count":0},{"had_liked":false,"id":114842,"user_name":"天天向上","can_delete":false,"product_type":"c1","uid":1031113,"ip_address":"","ucode":"5948D359734193","user_header":"https://static001.geekbang.org/account/avatar/00/0f/bb/c9/37924ad4.jpg","comment_is_top":false,"comment_ctime":1563415351,"is_pvip":false,"discussion_count":6,"race_medal":0,"score":"1563415351","product_id":100029201,"comment_content":"一个poll线程 拉下来一批数据假设1000条，然后在并发处理，分10个并发线程消费，谁消费完谁提交位移，这样的场景如何处理？<br>Max不回退原则？对每次的位移提交设置全局最大值记录？如果小位移的批次消费失败就丢消息啦！<br>不控制原则？谁消费完就各种提交自己的位移？最后一次提交恰好是第一批次，尴尬啦，要有大量重复消费<br><br>拉取线程内就地消费原则？<br><br>这些问题麻烦给教导下，谢谢","like_count":0,"discussions":[{"author":{"id":1197447,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","nickname":"😈😈😈😈😈","note":"","ucode":"A563EC007FEB7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":35818,"discussion_content":"因为分区的存在，这个问题不会出现吧？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571307254,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":3,"child_discussions":[{"author":{"id":1031113,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/bb/c9/37924ad4.jpg","nickname":"天天向上","note":"","ucode":"5948D359734193","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1197447,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","nickname":"😈😈😈😈😈","note":"","ucode":"A563EC007FEB7D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":36317,"discussion_content":"一个分区只能一个线程拉取和消费吗？如果多个线程拉取并消费一个分区的数据，或者一个线程拉取，多个线程消费一个分区的数据呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571362704,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":35818,"ip_address":""},"score":36317,"extra":""},{"author":{"id":1197447,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","nickname":"😈😈😈😈😈","note":"","ucode":"A563EC007FEB7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1031113,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/bb/c9/37924ad4.jpg","nickname":"天天向上","note":"","ucode":"5948D359734193","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38166,"discussion_content":"一个分区只能有一个消费者去消费！！也可说是一个进程去消费","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571738923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":36317,"ip_address":""},"score":38166,"extra":""},{"author":{"id":1031113,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/bb/c9/37924ad4.jpg","nickname":"天天向上","note":"","ucode":"5948D359734193","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1197447,"avatar":"https://static001.geekbang.org/account/avatar/00/12/45/87/b32dc1ea.jpg","nickname":"😈😈😈😈😈","note":"","ucode":"A563EC007FEB7D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38220,"discussion_content":"如果这样 省事了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571746439,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":38166,"ip_address":""},"score":38220,"extra":""}]},{"author":{"id":1308502,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83erabhkvu3jKSia1Y3l7pvicBy1YibN6GuIxLuZmI9E9icR8zdjP7BZ570PsDXv7ZLlMTU4Xr3Xz6N9bZg/132","nickname":"Geek_669721","note":"","ucode":"631471460ACFF3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":23492,"discussion_content":"线程同步啊，了解下barrier","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1569826160,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1031113,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/bb/c9/37924ad4.jpg","nickname":"天天向上","note":"","ucode":"5948D359734193","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1308502,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83erabhkvu3jKSia1Y3l7pvicBy1YibN6GuIxLuZmI9E9icR8zdjP7BZ570PsDXv7ZLlMTU4Xr3Xz6N9bZg/132","nickname":"Geek_669721","note":"","ucode":"631471460ACFF3","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":24355,"discussion_content":"不是技术方案选什么 是流程应该是什么样，流程清楚技术不是问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570102381,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":23492,"ip_address":""},"score":24355,"extra":""}]}]},{"had_liked":false,"id":114833,"user_name":"柯察金","can_delete":false,"product_type":"c1","uid":1115149,"ip_address":"","ucode":"F722BF8FCD2C47","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/0d/3dc5683a.jpg","comment_is_top":false,"comment_ctime":1563414165,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563414165","product_id":100029201,"comment_content":"现在好像有单独的线程发送心跳了。消费时间长也没有关系了吧","like_count":0},{"had_liked":false,"id":113528,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1563069301,"is_pvip":false,"replies":[{"id":"41418","content":"嗯嗯，2.3修复了之前StickyAssignor的一个重大bug，可以试试看：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563156736,"ip_address":"","comment_id":113528,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1563069301","product_id":100029201,"comment_content":"“基于这个原因，社区于 0.11.0.0 版本推出了 StickyAssignor，即有粘性的分区分配策略。” 现在已经到2.3了，这个测量的稳定性有好转吗？可以生产使用吗？","like_count":0,"discussions":[{"author":{"id":1272716,"avatar":"https://static001.geekbang.org/account/avatar/00/13/6b/8c/bf9e6f2c.jpg","nickname":"Lee","note":"","ucode":"BF4E54DD903A18","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":209772,"discussion_content":"试试看?小白鼠！怎么感觉kafka好多坑了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1584670973,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113515,"user_name":"Chloe","can_delete":false,"product_type":"c1","uid":1004953,"ip_address":"","ucode":"C4848ED5B35752","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/99/4bdadfd3.jpg","comment_is_top":false,"comment_ctime":1563054278,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1563054278","product_id":100029201,"comment_content":"谢谢老师，全部都是干货啊！","like_count":0},{"had_liked":false,"id":113322,"user_name":"rm -rf 😊ི","can_delete":false,"product_type":"c1","uid":1070908,"ip_address":"","ucode":"BC448EC4206D95","user_header":"https://static001.geekbang.org/account/avatar/00/10/57/3c/081b89ec.jpg","comment_is_top":false,"comment_ctime":1562951608,"is_pvip":false,"replies":[{"id":"41426","content":"因为通常我们拿到数据之后还要处理，然后会再次调用poll方法","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563157391,"ip_address":"","comment_id":113322,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562951608","product_id":100029201,"comment_content":"有个问题，就是上面说的max.poll.interval.ms的设置，我看留言里面说的，poll方法返回的那一刻消息就是消费完成了，那为什么会有这句话：&quot;它的默认值是 5 分钟，表示你的 Consumer 程序如果在 5 分钟之内无法消费完成...&quot;","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458167,"discussion_content":"因为通常我们拿到数据之后还要处理，然后会再次调用poll方法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563157391,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113277,"user_name":"calljson","can_delete":false,"product_type":"c1","uid":1505262,"ip_address":"","ucode":"A5F81A6A5B4497","user_header":"https://static001.geekbang.org/account/avatar/00/16/f7/ee/6eeb58a3.jpg","comment_is_top":false,"comment_ctime":1562932606,"is_pvip":false,"replies":[{"id":"41430","content":"consumer重启了，rebalance就开始了","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1563157717,"ip_address":"","comment_id":113277,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1562932606","product_id":100029201,"comment_content":"在一个session.timeout.ms周期内，如果consumer重启了，relalance是否就可以避免？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":458146,"discussion_content":"consumer重启了，rebalance就开始了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563157717,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1547667,"avatar":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","nickname":"朴素柠檬c","note":"","ucode":"2D4CBB70D801B1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329374,"discussion_content":"rebalance 不是协调者控制的吗，协调者在session应该不知道到consumer宕机了，跟之前老师回答的矛盾啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606373694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":113213,"user_name":"你好旅行者","can_delete":false,"product_type":"c1","uid":1154101,"ip_address":"","ucode":"5C72A428DC28F3","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg","comment_is_top":false,"comment_ctime":1562916772,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1562916772","product_id":100029201,"comment_content":"关于@Icedmaze提出来的问题，如果Consumer的poll返回了，此时Consumer还没有消费数据就发生了Rebalance，这个分区被分配给另一个消费者。这不是会导致之前还没被消费的消息丢失吗。因为我还没有消费，就提交了offset，导致Coordinator误认为Consumer已经消费了这条消息。","like_count":0,"discussions":[{"author":{"id":1104245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","nickname":"Icedmaze","note":"","ucode":"DC05117685CAB5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1833,"discussion_content":"个人理解 消费端处理逻辑分为3个步骤\n第一步：poll数据\n第二步：业务逻辑处理\n第三步：提交offset\n      其中第二步和第三步理论上可以互换 ，可以拉到数据后直接提交offset，然后再进行业务逻辑处理。但是这样一旦消费端因异常终止，导致业务逻辑未处理完成，就会造成数据丢失的问题，这在生产环境是绝对不允许的。\n      所以通常会选择在处理完业务逻辑后，再对offset进行提交，这样保证了起码数据不会丢失，但是同样也会造成如果发生异常终止，导致offset未来得及提交的情况，那么这时候，由于kafka是以你是否提交offset作为基准判断你是否消费成功，所以该批次的数据会在rebalance或重启后被分配，就会导致了所谓的重复问题。\n原则上来说，数据不允许丢失，但是允许被重复消费。因为重复消费有很多种解决办法可以保证最终数据一致，但是数据丢失就真的没办法了。\n      当然，本人还遇到过因为网络过于糟糕，导致offset提交失败的情况，这时候也会导致已经处理过的业务逻辑再次被重复消费。\n      解决数据重复消费的主要办法就个人知道的 ，主要是进行幂等操作，比如在保证业务主键消费顺序的前提下，无论数据更新多少次，最终的结果还是一致的。\n还有一种思路是在每次业务逻辑处理后，都将Topic_Group_Partition的offset缓存下来，但是会牺牲一定的性能。\n\n以上个人愚见","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1562938146,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1034204,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","nickname":"ban","note":"","ucode":"E523CE97E48266","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1104245,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d9/75/3598e0de.jpg","nickname":"Icedmaze","note":"","ucode":"DC05117685CAB5","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":1841,"discussion_content":"好详细，解决消费比较方便的做法还是把消费的记录缓存下来，每次消费的时候检查是否成功消费过，消费过就不处理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562945911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":1833,"ip_address":""},"score":1841,"extra":""}]}]},{"had_liked":false,"id":113076,"user_name":"其实我很屌","can_delete":false,"product_type":"c1","uid":1138722,"ip_address":"","ucode":"2B75EAAD748A60","user_header":"https://static001.geekbang.org/account/avatar/00/11/60/22/92284df2.jpg","comment_is_top":false,"comment_ctime":1562893477,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1562893477","product_id":100029201,"comment_content":"老师你好，接上面Kafka-6030那个issue的问题。我们是自己的topic数据不被清理，一直增长。内置的__consumer_offsets比较健康。有好几个疑问：1、我看了我们实际跑着的kafka的源码，在Log.scala关于日志清理有一句 def size: Long = logSegments.map(_.size).sum，这句话在我segment是500M，保留5G的情况下，是不是会int溢出了？因为我至少有5G的数据，就是50亿+，但是int只能容纳21亿，所以我在想是不是这里除了问题，导致每次程序制定到这里线程崩溃。这是kafka0.11.0的源码，现在gitLab上已经改了，不是这么写的了，但这是我们生产安装的包里带的source。2、我看log-cleaner.log为何只有__consumer_offsets这个topic的清理日志，其他健康的topic怎么都不在这里有日志啊？3、log cleaner和log清除是一回事吗，不太理解LogManager和LogCleaner的分工。我看LogManager里并不需要LogCleaner就能删除日志片段好像。4、LogManager.scala里的startup，启动了一个kafka-log-retention和一个kafka-delete-logs线程任务，这两个区别是啥？我scala不懂，好难读下去。麻烦老师有空帮忙解答下，尤其是第一个，感谢~","like_count":0},{"had_liked":false,"id":112919,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1562844734,"is_pvip":false,"replies":[{"id":"41114","content":"不是避免rebalance，而是更快地感知到failure以及更快地感知到rebalance已经开启","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892195,"ip_address":"","comment_id":112919,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562844734","product_id":100029201,"comment_content":"想问一下老师，配置session.timeout.ms和heartbeat.interval.ms让Coordinator马上识别出哪个Consumer出问题了就可以避免Rebalance了吗？ 如果不能避免即使快速识别出来感觉也于事无补了啊","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457957,"discussion_content":"不是避免rebalance，而是更快地感知到failure以及更快地感知到rebalance已经开启","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892195,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112782,"user_name":"dream","can_delete":false,"product_type":"c1","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1562825962,"is_pvip":false,"replies":[{"id":"41118","content":"Leader和Leader副本是一个意思~~ Leader、Follower本来就是对副本而言的，分区和broker没有什么leader的概念啊","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562892410,"ip_address":"","comment_id":112782,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562825962","product_id":100029201,"comment_content":" Consumer Group 确定 Coordinator 所在的 Broker 的算法的第二步中说：“找出该分区 Leader 副本所在的 Broker，该 Broker 即为对应的 Coordinator。”，为什么不是 leader 所在的 broker ，而是 Leader 副本所在的 Broker？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457912,"discussion_content":"Leader和Leader副本是一个意思~~ Leader、Follower本来就是对副本而言的，分区和broker没有什么leader的概念啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562892410,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112656,"user_name":"30斤的大番薯","can_delete":false,"product_type":"c1","uid":1564545,"ip_address":"","ucode":"1C85FEE30B1CF2","user_header":"https://static001.geekbang.org/account/avatar/00/17/df/81/756f7a87.jpg","comment_is_top":false,"comment_ctime":1562803136,"is_pvip":false,"replies":[{"id":"40985","content":"&quot;关闭了rebalance&quot;  ？如果你使用consumer group是没法关闭rebalance的，而且你只能依赖rebalance帮你做这件事情。<br><br>或者你自己来做且不使用consumer group机制","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562805260,"ip_address":"","comment_id":112656,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562803136","product_id":100029201,"comment_content":"胡老师，请问在关闭了reblance的情况下，我多个消费者轮流重新启动的话，所有分区的任务会不会最新压到了一个消费者身上？或者说启动的时候刚开始只有一个消费者，后面才逐渐增加消费者，新增加的消费者如果没有reblance的话如何可以能接管一部分分区呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457841,"discussion_content":"&amp;quot;关闭了rebalance&amp;quot;  ？如果你使用consumer group是没法关闭rebalance的，而且你只能依赖rebalance帮你做这件事情。\n\n或者你自己来做且不使用consumer group机制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562805260,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112629,"user_name":"kursk.ye","can_delete":false,"product_type":"c1","uid":1015995,"ip_address":"","ucode":"9D6A3854E408F9","user_header":"https://static001.geekbang.org/account/avatar/00/0f/80/bb/c0ed9d76.jpg","comment_is_top":false,"comment_ctime":1562776299,"is_pvip":false,"replies":[{"id":"40973","content":"因为有新的分区需要被分配","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1562803902,"ip_address":"","comment_id":112629,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1562776299","product_id":100029201,"comment_content":"为什么“订阅主题数量发生变化”会引发rebalance?","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457826,"discussion_content":"因为有新的分区需要被分配","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562803902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}