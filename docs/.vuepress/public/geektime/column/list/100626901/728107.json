{"id":728107,"title":"16ï½œtokioç¼–ç¨‹ï¼šä½¿ç”¨channelåœ¨ä¸åŒä»»åŠ¡é—´é€šä¿¡ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeã€‚ä»Šå¤©æˆ‘ä»¬æ¥äº†è§£å¹¶å‘ç¼–ç¨‹çš„å¦ä¸€ç§èŒƒå¼â€”â€”ä½¿ç”¨channelåœ¨ä¸åŒçš„ä»»åŠ¡é—´è¿›è¡Œé€šä¿¡ã€‚</p><p>channelç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯é€šé“æˆ–ç®¡é“ï¼Œç”¨æ¥åœ¨taskä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚è¿™ä¸ªæ¦‚å¿µæœ¬èº«å¹¶ä¸éš¾ã€‚æˆ‘ä»¬å›å¿†ä¸€ä¸‹ä¸ŠèŠ‚è¯¾çš„ç›®æ ‡ï¼šè¦åœ¨å¤šä¸ªä»»åŠ¡ä¸­åŒæ—¶å¯¹ä¸€ä¸ªå†…å­˜æ•°æ®åº“è¿›è¡Œæ›´æ–°ã€‚å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨channelçš„æ€è·¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥åˆ†è§£ä¸€ä¸‹ä»»åŠ¡ã€‚</p><ol>\n<li>åˆ›å»ºä¸‰ä¸ªå­ä»»åŠ¡ï¼Œtask_aã€task_b å’Œå¦ä¸€ä¸ªèµ·ä»£ç†ä½œç”¨çš„ task_cã€‚</li>\n<li>åœ¨ task_a å’Œ task_b ä¸­ï¼Œä¸ç›´æ¥æ“ä½œdbæœ¬èº«ï¼Œè€Œæ˜¯å‘ task_c å‘ä¸€ä¸ªæ¶ˆæ¯ã€‚</li>\n<li>task_c é‡Œé¢ä¼šæ‹¿åˆ° db çš„æ‰€æœ‰æƒï¼Œæ”¶åˆ°ä» task_a å’Œ task_b æ¥çš„æ¶ˆæ¯åï¼Œå¯¹dbè¿›è¡Œæ“ä½œã€‚</li>\n</ol><p>åŸºäºè¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ¥é‡å†™ä¸Šä¸€èŠ‚è¯¾çš„ç¤ºä¾‹ã€‚</p><h2>MPSC Channel</h2><p>æˆ‘ä»¬ä½¿ç”¨tokioä¸­çš„MPSC Channelæ¥å®ç°ã€‚MPSC Channelæ˜¯å¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…é€šé“ï¼ˆMulti-Producers Single Consumerï¼‰ã€‚</p><p>MPSCçš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">let (tx, mut rx) = mpsc::channel(100);\n</code></pre><p>ä½¿ç”¨MPSCæ¨¡å—çš„ <code>channel()</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªé€šé“å¯¹ï¼Œtxè¡¨ç¤ºå‘é€ç«¯ï¼Œrxè¡¨ç¤ºæ¥æ”¶ç«¯ï¼Œrxå‰é¢è¦åŠ mutä¿®é¥°ç¬¦ï¼Œå› ä¸ºrxåœ¨æ¥æ”¶æ•°æ®çš„æ—¶å€™ä½¿ç”¨äº†å¯å˜å€Ÿç”¨ã€‚channelä½¿ç”¨çš„æ—¶å€™è¦ç»™ä¸€ä¸ªæ•´æ•°å‚æ•°ï¼Œè¡¨ç¤ºè¿™ä¸ªé€šé“å®¹é‡å¤šå¤§ã€‚tokioçš„è¿™ä¸ª <code>mpsc::channel</code> æ˜¯å¸¦èƒŒå‹åŠŸèƒ½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå‘é€ç«¯å‘å¾—å¤ªå¿«ï¼Œæ¥æ”¶ç«¯æ¥ä¸åŠæ¶ˆè€—å¯¼è‡´é€šé“å µå¡äº†çš„è¯ï¼Œè¿™ä¸ªchannelä¼šè®©å‘é€ç«¯é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é€šé“é‡Œé¢çš„æ•°æ®åŒ…è¢«æ¶ˆè€—åˆ°ç•™å‡ºç©ºä½ä¸ºæ­¢ã€‚</p><!-- [[[read_end]]] --><p>MPSCçš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥æœ‰å¤šä¸ªç”Ÿäº§è€…ï¼Œä½†åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚å› æ­¤ï¼Œtxå¯ä»¥è¢«éšæ„cloneå¤šä»½ï¼Œä½†æ˜¯rxåªèƒ½æœ‰ä¸€ä¸ªã€‚</p><p>å‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç”¨channelæ¥å®ç°ã€‚</p><pre><code class=\"language-plain\">use tokio::sync::mpsc;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let mut db: Vec&lt;u32&gt; = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n&nbsp; &nbsp; let (tx, mut rx) = mpsc::channel::&lt;u32&gt;(100);  // åˆ›å»ºchannel\n\n&nbsp; &nbsp; let tx1 = tx.clone();  // æ‹·è´ä¸¤ä»½arc\n&nbsp; &nbsp; let tx2 = tx.clone();\n\n&nbsp; &nbsp; let task_a = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; if let Err(_) = tx1.send(50).await {  // å‘é€ç«¯æ ‡å‡†å†™æ³•\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"receiver dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; if let Err(_) = tx2.send(100).await {  // å‘é€ç«¯æ ‡å‡†å†™æ³•\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"receiver dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; let task_c = tokio::task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; while let Some(i) = rx.recv().await {  // æ¥æ”¶ç«¯æ ‡å‡†å†™æ³•\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"got = {}\", i);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db[4] = i;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{:?}\", db);\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n&nbsp; &nbsp; _ = task_a.await.unwrap();\n&nbsp; &nbsp; _ = task_b.await.unwrap();\n&nbsp; &nbsp; _ = task_c.await.unwrap();\n}\n//è¾“å‡º\ngot = 50\n[1, 2, 3, 4, 50, 6, 7, 8, 9, 10]\ngot = 100\n[1, 2, 3, 4, 100, 6, 7, 8, 9, 10]\n^C\n</code></pre><p>ä»£ç ç¬¬6è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>let (tx, mut rx) = mpsc::channel::&lt;u32&gt;(100);</code> åˆ›å»ºä¸€ä¸ªchannelï¼Œæ³¨æ„ï¼Œè¿™ä¸€å¥ä½¿ç”¨ <code>::&lt;u32&gt;</code> æŒ‡å®šäº†è¿™ä¸ªchannelä¸­è¦ä¼ è¾“çš„æ¶ˆæ¯ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä¼ u32ç±»å‹çš„æ•´æ•°ï¼Œé€šé“å®¹é‡ä¸º100ä¸ªæ¶ˆæ¯ã€‚<br>\nç¬¬8è¡Œå’Œç¬¬9è¡Œï¼Œcloneäº†ä¸¤ä»½txã€‚å› ä¸ºtxæœ¬è´¨ä¸Šå®ç°ä¸ºä¸€ä¸ªArcå¯¹è±¡ï¼Œå› æ­¤cloneå®ƒä¹Ÿå°±åªå¢åŠ äº†å¼•ç”¨è®¡æ•°ï¼Œæ²¡æœ‰å¤šä½™çš„æ€§èƒ½æ¶ˆè€—ã€‚</p><p>ç¬¬11è¡Œå’Œç¬¬17è¡Œï¼Œåˆ›å»ºäº†ä¸¤ä¸ªå·¥ä½œè€…ä»»åŠ¡ï¼Œåœ¨é‡Œé¢æˆ‘ä»¬ç”¨ <code>if let Err(_) = tx1.send(50).await</code> è¿™ç§å†™æ³•æ¥å‘ channel ä¸­å‘é€ä¿¡æ¯ï¼Œå› ä¸ºå‘ MPSC Channel ä¸­çŒæ•°æ®æ—¶ï¼Œæ˜¯æœ‰å¯èƒ½ä¼šå‡ºé”™çš„ï¼Œæ¯”å¦‚channelçš„å¦ä¸€ç«¯ rx å·²ç»å…³é—­äº†ï¼ˆè¢«é‡Šæ”¾äº†ï¼‰ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å†ç”¨ tx å‘æ•°æ®å°±ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨ <code>if let Err(_)</code> è¿™ç§å½¢å¼æ¥å¤„ç†é”™è¯¯ã€‚</p><p>ç¬¬24è¡Œï¼Œåˆ›å»ºä¸€ä¸ªä»£ç†ä»»åŠ¡ task_cï¼Œä½¿ç”¨è¿™ç§å†™æ³• <code>while let Some(i) = rx.recv().await</code> æ¥æ¥æ”¶æ¶ˆæ¯ã€‚è¿™é‡Œ <code>rx.recv().await</code> è·å–å›æ¥çš„æ˜¯ä¸€ä¸ª <code>Option&lt;u32&gt;</code> ç±»å‹ï¼Œå› æ­¤è¦ç”¨ <code>while let Some(i)</code> è¿™ç§æ¨¡å¼åŒ¹é…è¯­æ³•æ¥å†™ï¼Œi å°±æ˜¯æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ç„¶ååœ¨whileå†…éƒ¨å¤„ç†å…·ä½“çš„ä¸šåŠ¡å°±è¡Œäº†ã€‚å½“ rx æ”¶åˆ°ä¸€ä¸ª None å€¼ï¼ˆchannelå…³é—­äº§ç”Ÿçš„ï¼‰çš„æ—¶å€™ï¼Œä¼šé€€å‡ºè¿™ä¸ªå¾ªç¯ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸šåŠ¡æ­£å¸¸è¿›è¡Œæ—¶ï¼Œè¿™ä¸ªç¨‹åºä¸ä¼šè‡ªåŠ¨ç»ˆæ­¢ï¼Œè€Œæ˜¯ä¼šä¸€ç›´å¤„äºå·¥ä½œçŠ¶æ€ï¼Œæœ€åæˆ‘ä»¬å¾—ç”¨ Ctrl-C åœ¨ç»ˆç«¯ç»ˆæ­¢å®ƒçš„è¿è¡Œã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º while let æ²¡æœ‰é€€å‡ºã€‚<code>rx.recv().await</code> ä¸€ç›´åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªmsgçš„åˆ°æ¥ï¼Œä½†æ˜¯å‰é¢ä¸¤ä¸ªå‘æ¶ˆæ¯çš„ä»»åŠ¡ task_aã€task_b çš„å·¥ä½œå·²ç»å®Œæˆï¼Œé€€å‡ºäº†ï¼Œäºæ˜¯æ²¡æœ‰è§’è‰²ç»™rxå‘æ¶ˆæ¯äº†ï¼Œå®ƒå°±ä¼šä¸€ç›´ç­‰ä¸‹å»ã€‚è¿™é‡Œçš„ <code>.await</code> æ˜¯ä¸€ç§ä¸æ¶ˆè€—èµ„æºçš„ç­‰å¾…ï¼Œtokioä¿è¯è¿™ç§ç­‰å¾…ä¸ä¼šè®©ä¸€ä¸ªCPUå¿™ç©ºè½¬ã€‚</p><p>ç¬¬31è¡Œï½ç¬¬33è¡Œçš„é¡ºåºåœ¨è¿™é‡Œå¹¶ä¸æ˜¯å¾ˆé‡è¦ï¼Œä½ å¯ä»¥è¯•è¯•æ”¹å˜ task_aã€task_bã€task_c çš„ await çš„é¡ºåºï¼Œçœ‹çœ‹è¾“å‡ºç»“æœçš„å˜åŒ–ã€‚</p><p>èŠ±å‡ åˆ†é’Ÿç†è§£äº†è¿™ä¸ªè¿‡ç¨‹åï¼Œä½ ä¼šå‘ç°è¿™ä¸ªæ–¹æ¡ˆçš„æ€ç»´æ–¹å¼å’Œå‰é¢ä½¿ç”¨é”çš„æ–¹å¼å®Œå…¨ä¸åŒã€‚è¿™å…¶å®æ˜¯ä¸€ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼šä»£ç†æ¨¡å¼ã€‚</p><h3>çœŸæ­£çš„å¹¶å‘æ‰§è¡Œ</h3><p><code>tokio::task::spawn()</code> è¿™ä¸ªAPIæœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯é€šè¿‡å®ƒåˆ›å»ºçš„å¼‚æ­¥ä»»åŠ¡ï¼Œä¸€æ—¦åˆ›å»ºå¥½ï¼Œå°±ä¼šç«‹å³æ‰”åˆ°tokio runtime é‡Œæ‰§è¡Œï¼Œä¸éœ€è¦å¯¹å…¶è¿”å›çš„ JoinHandler è¿›è¡Œ await æ‰é©±åŠ¨æ‰§è¡Œï¼Œè¿™ä¸ªç‰¹æ€§å¾ˆé‡è¦ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç‰¹æ€§åˆ†æä¸€ä¸‹å‰é¢çš„ç¤ºä¾‹ï¼štask_aã€task_bã€task_c åˆ›å»ºå¥½ä¹‹åï¼Œå®é™…å°±å·²ç»å¼€å§‹æ‰§è¡Œäº†ã€‚task_c å·²ç»åœ¨ç­‰å¾…channelæ•°æ®çš„åˆ°æ¥äº†ã€‚ç¬¬31åˆ°33è¡ŒJoinHandlerçš„awaitåªæ˜¯åœ¨ç­‰å¾…ä»»åŠ¡æœ¬èº«ç»“æŸè€Œå·²ã€‚æˆ‘ä»¬è¯•ç€ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">use std::time::Duration;\nuse tokio::sync::mpsc;\nuse tokio::task;\nuse tokio::time;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let mut db: Vec&lt;u32&gt; = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n&nbsp; &nbsp; let (tx, mut rx) = mpsc::channel::&lt;u32&gt;(100);\n\n&nbsp; &nbsp; let tx1 = tx.clone();\n&nbsp; &nbsp; let tx2 = tx.clone();\n\n&nbsp; &nbsp; let task_a = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_a 1\");\n&nbsp; &nbsp; &nbsp; &nbsp; time::sleep(Duration::from_secs(3)).await;  // ç­‰å¾…3s\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_a 2\");\n&nbsp; &nbsp; &nbsp; &nbsp; if let Err(_) = tx1.send(50).await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"receiver dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_b\");\n&nbsp; &nbsp; &nbsp; &nbsp; if let Err(_) = tx2.send(100).await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"receiver dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; let task_c = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; while let Some(i) = rx.recv().await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"got = {}\", i);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db[4] = i;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{:?}\", db);\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; _ = task_c.await.unwrap();  // task_c æ”¾åœ¨å‰é¢æ¥await\n&nbsp; &nbsp; _ = task_a.await.unwrap();\n&nbsp; &nbsp; _ = task_b.await.unwrap();\n}\n// è¾“å‡º \nin task_a 1\nin task_b\ngot = 100\n[1, 2, 3, 4, 100, 6, 7, 8, 9, 10]\nin task_a 2\ngot = 50\n[1, 2, 3, 4, 50, 6, 7, 8, 9, 10]\n^C\n</code></pre><p>åœ¨è¿™ä¸ªç¤ºä¾‹é‡Œï¼Œæˆ‘ä»¬åœ¨task_aä¸­sleepäº†3ç§’ï¼ˆç¬¬16è¡Œï¼‰ã€‚åŒæ—¶æŠŠ task_c æ”¾åˆ°æœ€å‰é¢å» await äº†ï¼ˆç¬¬39è¡Œï¼‰ã€‚å¯ä»¥çœ‹åˆ°ï¼Œtask_bå‘æ¥çš„æ•°æ®å…ˆæ‰“å°ï¼Œ3ç§’åï¼Œtask_aå‘æ¥çš„æ•°æ®æ‰“å°äº†ã€‚</p><p>å®é™…å¯¹äºmain å‡½æ•°è¿™ä¸ª task æ¥è®²ï¼Œå®ƒå…¶å®è¢«é˜»å¡åœ¨äº†ç¬¬39è¡Œï¼Œå› ä¸º task_c ä¸€ç›´åœ¨ awaitï¼Œå¹¶æ²¡æœ‰ç»“æŸã€‚task_a å’Œ task_b è™½ç„¶å·²ç»ç»“æŸäº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‰§è¡Œåˆ°ç¬¬ 40 è¡Œå’Œç¬¬ 41 è¡Œå»ã€‚å¯¹æ•´ä¸ªç¨‹åºçš„è¾“å‡ºæ¥è®²ï¼Œæ²¡æœ‰æ‰§è¡Œåˆ°ç¬¬ 40 è¡Œå’Œç¬¬ 41 è¡Œå¹¶ä¸å½±å“æœ€ç»ˆæ•ˆæœã€‚ä½ ä»”ç»†ä½“ä¼šä¸€ä¸‹ã€‚</p><p>æ‰€ä»¥ä½¿ç”¨ <code>task::spawn()</code> åˆ›å»ºçš„å¤šä¸ªä»»åŠ¡ä¹‹é—´ï¼Œæœ¬èº«å°±æ˜¯å¹¶å‘æ‰§è¡Œçš„å…³ç³»ã€‚ä½ å¯ä»¥å¯¹æ¯”ä¸€ä¸‹è¿™ä¸¤ä¸ªç¤ºä¾‹ã€‚</p><h3>unbounded channel</h3><p>tokio::mpscæ¨¡å—é‡Œè¿˜æœ‰ä¸€ä¸ªå‡½æ•° <code>mpsc::unbounded_channel()</code>ï¼Œå¯ä»¥ç”¨æ¥åˆ›å»ºæ²¡æœ‰å®¹é‡ä¸Šé™çš„é€šé“ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œå®ƒä¸å…·æœ‰èƒŒå‹åŠŸèƒ½ã€‚è¿™ä¸ªé€šé“é‡Œé¢èƒ½å­˜å¤šå°‘æ•°æ®ï¼Œå°±çœ‹æœºå™¨çš„å†…å­˜å¤šå¤§ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæ’‘çˆ†ä½ çš„æœåŠ¡å™¨ã€‚è€Œåœ¨ä½¿ç”¨æ–¹æ³•ä¸Šï¼Œè¿™ä¸¤ç§channelåŒºåˆ«ä¸å¤§ï¼Œå› æ­¤ä¸å†ä¸¾ä¾‹è¯´æ˜ã€‚å¦‚æœä½ æ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ç»™å‡ºçš„<a href=\"https://docs.rs/tokio/1.33.0/tokio/sync/mpsc/fn.unbounded_channel.html\">é“¾æ¥</a>ã€‚</p><h2>Oneshot Channel</h2><p>å¦‚æœç°åœ¨æˆ‘ä»¬è¦åœ¨å‰é¢ç¤ºä¾‹çš„åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéœ€æ±‚ï¼šæˆ‘åœ¨task_cä¸­å°†dbæ›´æ–°å®Œæˆï¼Œæƒ³ç»™ task_a å’Œ task_b è¿”å›ä¸€ä¸ªäº‹ä»¶é€šçŸ¥è¯´ï¼Œæˆ‘å·²ç»å®Œæˆäº†ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ</p><p>è¿™ä¸ªé—®é¢˜å½“ç„¶ä¸æ­¢ä¸€ç§è§£æ³•ï¼Œæ¯”å¦‚å¤–éƒ¨å¢åŠ ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°†è¿™ä¸¤ä¸ªæ¶ˆæ¯æŠ›è¿›æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢ï¼Œè®©task_aå’Œtask_bç›‘å¬è¿™ä¸ªé˜Ÿåˆ—ã€‚ç„¶è€Œè¿™ä¸ªæ–¹æ¡ˆä¼šå¢åŠ å¯¹å¤–éƒ¨æœåŠ¡çš„ä¾èµ–ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªè®¢é˜…-å‘å¸ƒæœåŠ¡ï¼›task_aå’Œtask_b é‡Œéœ€è¦è®¢é˜…å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è¿‡æ»¤å¯¹åº”çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚</p><p>tokioå…¶å®å†…ç½®äº†å¦å¤–ä¸€ä¸ªå¥½ç”¨çš„ä¸œè¥¿ Oneshot channelï¼Œå®ƒå¯ä»¥é…åˆ MPSC Channel å®Œæˆæˆ‘ä»¬çš„ä»»åŠ¡ã€‚Oneshotå®šä¹‰äº†è¿™æ ·ä¸€ä¸ªæ¨¡å‹ï¼Œè¿™ä¸ªé€šé“åªèƒ½ç”¨ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½å‘é€ä¸€æ¡æ•°æ®ï¼Œå‘é€å®Œä¹‹åå°±å…³é—­äº†ï¼Œå¯¹åº”çš„txå’Œrxå°±æ— æ³•å†æ¬¡ä½¿ç”¨äº†ã€‚è¿™ä¸ªå¾ˆé€‚åˆç­‰å¾…è®¡ç®—ç»“æœè¿”å›çš„åœºæ™¯ã€‚æˆ‘ä»¬è¯•ç€ç”¨è¿™ä¸ªæ–°è®¾æ–½æ¥å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p><pre><code class=\"language-plain\">use std::time::Duration;\nuse tokio::sync::{mpsc, oneshot};\nuse tokio::task;\nuse tokio::time;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let mut db: Vec&lt;u32&gt; = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n&nbsp; &nbsp; let (tx, mut rx) = mpsc::channel::&lt;(u32, oneshot::Sender&lt;bool&gt;)&gt;(100);\n\n&nbsp; &nbsp; let tx1 = tx.clone();\n&nbsp; &nbsp; let tx2 = tx.clone();\n\n&nbsp; &nbsp; let task_a = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; time::sleep(Duration::from_secs(3)).await;\n&nbsp; &nbsp; &nbsp; &nbsp; let (resp_tx, resp_rx) = oneshot::channel();\n&nbsp; &nbsp; &nbsp; &nbsp; if let Err(_) = tx1.send((50, resp_tx)).await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"receiver dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if let Ok(ret) = resp_rx.await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ret {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"task_a finished with success.\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"task_a finished with failure.\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"oneshot sender dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; let (resp_tx, resp_rx) = oneshot::channel();\n&nbsp; &nbsp; &nbsp; &nbsp; if let Err(_) = tx2.send((100, resp_tx)).await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"receiver dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; if let Ok(ret) = resp_rx.await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ret {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"task_b finished with success.\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"task_b finished with failure.\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; &nbsp; } else {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"oneshot sender dropped\");\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; let task_c = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; while let Some((i, resp_tx)) = rx.recv().await {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"got = {}\", i);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db[4] = i;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println!(\"{:?}\", db);\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resp_tx.send(true).unwrap();\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; _ = task_a.await.unwrap();\n&nbsp; &nbsp; _ = task_b.await.unwrap();\n&nbsp; &nbsp; _ = task_c.await.unwrap();\n}\n// è¾“å‡º\ngot = 100\n[1, 2, 3, 4, 100, 6, 7, 8, 9, 10]\ntask_b finished with success.\ngot = 50\n[1, 2, 3, 4, 50, 6, 7, 8, 9, 10]\ntask_a finished with success.\n^C\n</code></pre><p>è§£é‡Šä¸€ä¸‹è¿™ä¸ªä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­é‡Œçš„ç¬¬9è¡Œï¼ŒæŠŠæ¶ˆæ¯ç±»å‹å®šä¹‰æˆäº† <code>(u32, oneshot::Sender&lt;bool&gt;)</code>ã€‚å¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œæ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œå…ƒç»„çš„ç¬¬äºŒä¸ªå…ƒç´ ä¸ºoneshot channel çš„å‘é€ç«¯ç±»å‹ã€‚</p><p>ç„¶åç¬¬16è¡Œï¼Œåœ¨task_aä¸­åˆ›å»ºäº†ä¸€ä¸ª Oneshot channelï¼Œä¸¤ä¸ªç«¯ä¸º resp_txå’Œresp_rxã€‚ç„¶ååœ¨ç¬¬17è¡Œï¼ŒæŠŠresp_txå®ä¾‹ç›´æ¥æ”¾åœ¨æ¶ˆæ¯ä¸­ï¼Œéšç€MPSC Channelä¸€èµ·å‘é€ç»™ task_cäº†ã€‚ç„¶ååœ¨ task_a é‡Œç”¨ resp_rx ç­‰å¾… oneshot é€šé“çš„å€¼ä¼ è¿‡æ¥ã€‚è¿™ç‚¹å¾ˆå…³é”®ã€‚task_bä¹Ÿæ˜¯ç±»ä¼¼çš„å¤„ç†ã€‚</p><p>åœ¨task_cé‡Œï¼Œç¬¬51è¡Œæ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ <code>Some((i, resp_tx))</code>ï¼Œtask_c æ‹¿åˆ°äº† task_a å’Œ task_b é‡Œåˆ›å»ºçš„ Oneshot channel çš„å‘é€ç«¯ resp_txï¼Œå°±å¯ä»¥ç”¨å®ƒåœ¨ç¬¬55è¡ŒæŠŠè®¡ç®—çš„ç»“æœå‘é€å›å»: <code>resp_tx.send(true).unwrap();</code>ã€‚</p><p>è¿™ä¸ªä¾‹å­éå¸¸ç²¾å½©ï¼Œä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒå›ºå®šçš„æ¨¡å¼ã€‚å› ä¸ºé€šé“ä¸¤ä¸ªç«¯æœ¬èº«å°±æ˜¯ç±»å‹çš„å®ä¾‹ï¼Œå½“ç„¶å¯ä»¥è¢«å…¶ä»–é€šé“ä¼ è¾“ã€‚è¿™é‡Œæˆ‘ä»¬ MPSC + Oneshot ä¸¤ç§é€šé“æˆåŠŸå®ç°äº† Request/Response æ¨¡å¼ã€‚</p><h2>tokioä¸­çš„å…¶ä»–channelç±»å‹</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†ä»‹ç»ä¸€ä¸‹tokioä¸­çš„å…¶ä»–channelç±»å‹ã€‚tokioä¸­è¿˜æœ‰ä¸¤ä¸ªå†…ç½®é€šé“ç±»å‹ï¼Œç”¨å¾—ä¸æ˜¯é‚£ä¹ˆå¤šï¼Œä½†åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œä½ å¯ä»¥åœ¨é‡åˆ°åˆé€‚çš„åœºæ™¯æ—¶å†å»å…·ä½“ç ”ç©¶ã€‚</p><h3>broadcast channel</h3><p>å¹¿æ’­æ¨¡å¼ï¼Œå®ç°äº†MPMCæ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼ï¼Œå¯ä»¥ç”¨æ¥å®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€‚æ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šæ”¶åˆ°æ¯ä¸ªç”Ÿäº§è€…å‘å‡ºçš„åŒæ ·çš„æ¶ˆæ¯å‰¯æœ¬ã€‚ä½ å¯ä»¥æŸ¥çœ‹<a href=\"https://docs.rs/tokio/1.33.0/tokio/sync/broadcast/index.html\">é“¾æ¥</a>äº†è§£å­¦ä¹ ã€‚</p><p>broadcasté€šé“å®é™…å·²è¦†ç›–SPMCæ¨¡å‹ï¼Œæ‰€ä»¥ä¸ç”¨å†å•ç‹¬å®šä¹‰SPMCäº†ã€‚</p><h3>watch channel</h3><p>watché€šé“å®é™…æ˜¯ä¸€ä¸ªç‰¹å®šåŒ–ç‰ˆæœ¬çš„broadcasté€šé“ï¼Œå®ƒæœ‰2ä¸ªç‰¹æ€§ã€‚</p><ol>\n<li>åªæœ‰ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ã€‚</li>\n<li>åªå…³å¿ƒæœ€åä¸€ä¸ªå€¼ã€‚</li>\n</ol><p>å®ƒé€‚ç”¨äºä¸€äº›ç‰¹å®šçš„åœºæ™¯ï¼Œæ¯”å¦‚é…ç½®æ›´æ–°éœ€è¦é€šçŸ¥å·¥ä½œä»»åŠ¡é‡æ–°åŠ è½½ï¼Œå¹³æ»‘å…³é—­ä»»åŠ¡ç­‰ç­‰ã€‚ä½ å¯ä»¥é€šè¿‡æˆ‘ç»™å‡ºçš„<a href=\"https://docs.rs/tokio/1.33.0/tokio/sync/watch/index.html\">é“¾æ¥</a>è¿›ä¸€æ­¥å­¦ä¹ ã€‚</p><h2>è¡¥å……çŸ¥è¯†ï¼šä»»åŠ¡ç®¡ç†çš„2ç§å¸¸è§æ¨¡å¼</h2><h3>ç­‰å¾…æ‰€æœ‰ä»»åŠ¡ä¸€èµ·è¿”å›</h3><p>å‰é¢ç¤ºä¾‹ä¸­task_cå¾ˆå…³é”®ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå®ƒä¸ä½†èµ·åˆ°äº†æœé›†æ•°æ®æ‰§è¡Œæ“ä½œçš„ä½œç”¨ï¼Œå®ƒè¿˜æŠŠæ•´ä¸ªç¨‹åºé˜»å¡ä½äº†ï¼Œä¿è¯äº†ç¨‹åºçš„æŒç»­è¿è¡Œã€‚é‚£å¦‚æœä¸€ä¸ªç¨‹åºé‡Œé¢æ²¡æœ‰è´Ÿè´£è¿™ä¸ªä»»åŠ¡çš„è§’è‰²ï¼Œåº”è¯¥æ€ä¹ˆå»æœé›†å…¶ä»–ä»»åŠ¡è¿”å›çš„ç»“æœå‘¢ï¼Ÿæˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/725837\">ç¬¬ 13 è®²</a>ä¸­å·²ç»æåˆ°äº†ä¸€ç§æ–¹å¼ã€‚</p><pre><code class=\"language-plain\">use tokio::task;\n\nasync fn my_background_op(id: i32) -&gt; String {\n    let s = format!(\"Starting background task {}.\", id);\n    println!(\"{}\", s);\n    s\n}\n\n#[tokio::main]\nasync fn main() {\n    let ops = vec![1, 2, 3];\n    let mut tasks = Vec::with_capacity(ops.len());\n    for op in ops {\n        // ä»»åŠ¡åˆ›å»ºåï¼Œç«‹å³å¼€å§‹è¿è¡Œï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªVecæ¥æŒæœ‰å„ä¸ªä»»åŠ¡çš„handler\n        tasks.push(tokio::spawn(my_background_op(op)));\n    }\n    let mut outputs = Vec::with_capacity(tasks.len());\n    for task in tasks {\n        // åœ¨è¿™é‡Œä¾æ¬¡ç­‰å¾…ä»»åŠ¡å®Œæˆ\n        outputs.push(task.await.unwrap());\n    }\n    println!(\"{:?}\", outputs);\n}\n</code></pre><p>ä¸Šé¢çš„ä»£ç æœ‰ä¸¤ä¸ªå…³é”®è¦ç‚¹ã€‚</p><ol>\n<li>åœ¨ç¬¬15è¡Œç”¨ä¸€ä¸ªVecæ¥å­˜æ”¾æ‰€æœ‰ä»»åŠ¡çš„handlerã€‚</li>\n<li>åœ¨ç¬¬20è¡Œä¾æ¬¡å¯¹ task è¿›è¡Œ awaitï¼Œè·å–ä»»åŠ¡çš„è¿”å›å€¼ã€‚</li>\n</ol><p>è¿™ä»£è¡¨äº†ä¸€ç§æ¨¡å¼ã€‚è¿™ä¸ªæ¨¡å¼æœ‰ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯è¦ç­‰å¾…å‰é¢ä»»åŠ¡ç»“æŸï¼Œæ‰èƒ½æ‹¿åˆ°åé¢ä»»åŠ¡çš„è¿”å›ç»“æœã€‚å¦‚æœå‰é¢æŸä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå³ä½¿åé¢çš„ä»»åŠ¡å®é™…å·²ç»æ‰§è¡Œå®Œäº†ï¼Œåœ¨æœ€åæœé›†ç»“æœçš„æ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦ç­‰å‰é¢é‚£ä¸ªä»»åŠ¡ç»“æŸäº†åï¼Œæˆ‘ä»¬æ‰èƒ½æœé›†åˆ°åé¢ä»»åŠ¡çš„ç»“æœã€‚æ¯”å¦‚ï¼š</p><pre><code class=\"language-plain\">use std::time::Duration;\nuse tokio::task;\nuse tokio::time;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let task_a = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_a\");\n&nbsp; &nbsp; &nbsp; &nbsp; time::sleep(Duration::from_secs(3)).await; // ç­‰å¾…3s\n&nbsp; &nbsp; &nbsp; &nbsp; 1\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_b\");\n&nbsp; &nbsp; &nbsp; &nbsp; 2\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_c = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_c\");\n&nbsp; &nbsp; &nbsp; &nbsp; 3\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; let mut tasks = Vec::with_capacity(3);\n&nbsp; &nbsp; tasks.push(task_a);\n&nbsp; &nbsp; tasks.push(task_b);\n&nbsp; &nbsp; tasks.push(task_c);\n\n&nbsp; &nbsp; let mut outputs = Vec::with_capacity(tasks.len());\n&nbsp; &nbsp; for task in tasks {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"iterate task result..\");\n&nbsp; &nbsp; &nbsp; &nbsp; // åœ¨è¿™é‡Œä¾æ¬¡ç­‰å¾…ä»»åŠ¡å®Œæˆ\n&nbsp; &nbsp; &nbsp; &nbsp; outputs.push(task.await.unwrap());\n&nbsp; &nbsp; }\n&nbsp; &nbsp; println!(\"{:?}\", outputs);\n}\n// è¾“å‡º \niterate task result..\nin task_a\nin task_b\nin task_c   // åœ¨è¿™ä¹‹åä¼šç­‰å¾… 3 ç§’ï¼Œç„¶åç»§ç»­æ‰“å° \niterate task result..\niterate task result..\n[1, 2, 3]\n</code></pre><p>ä¸Šé¢çš„ç¤ºä¾‹åˆ›å»ºäº†ä¸‰ä¸ªä»»åŠ¡ task_aã€task_bã€task_cï¼Œåœ¨task_aé‡Œç­‰å¾…3ç§’è¿”å›ï¼Œtask_bå’Œtask_céƒ½æ˜¯ç«‹å³è¿”å›ã€‚æ‰§è¡Œçš„æ—¶å€™ï¼Œå½“æ‰“å°å‡º <code>\"in task_c\"</code> åï¼Œä¼šåœæ­¢3ç§’å·¦å³ï¼Œç„¶åç»§ç»­æ‰“å°å‰©ä¸‹çš„ï¼Œå°è¯äº†æˆ‘ä»¬å‰é¢çš„åˆ†æã€‚</p><p>tokioæä¾›äº†ä¸€ä¸ªå® <code>tokio::join!()</code>ï¼Œç”¨æ¥ç®€åŒ–ä¸Šé¢ä»£ç çš„å†™æ³•ï¼Œè¡¨ç¤ºç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œä¸€èµ·è¿”å›ä¸€ä¸ªç»“æœã€‚ç”¨æ³•å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">use std::time::Duration;\nuse tokio::task;\nuse tokio::time;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let task_a = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_a\");\n&nbsp; &nbsp; &nbsp; &nbsp; time::sleep(Duration::from_secs(3)).await; // ç­‰å¾…3s\n&nbsp; &nbsp; &nbsp; &nbsp; 1\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_b\");\n&nbsp; &nbsp; &nbsp; &nbsp; 2\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_c = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_c\");\n&nbsp; &nbsp; &nbsp; &nbsp; 3\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; let (r1, r2, r3) = tokio::join!(task_a, task_b, task_c);\n\n&nbsp; &nbsp; println!(\"{}, {}, {}\", r1.unwrap(), r2.unwrap(), r3.unwrap());\n}\n// è¾“å‡º\nin task_a\nin task_b\nin task_c\n1, 2, 3\n</code></pre><p>è¿™ä¸¤ä¸ªç¤ºä¾‹åŸºæœ¬ç­‰ä»·ï¼Œéƒ½æ˜¯åœ¨æ‰€æœ‰ä»»åŠ¡ä¸­ç­‰å¾…æœ€é•¿çš„é‚£ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œç»Ÿä¸€è¿”å›ã€‚ä½ å¯ä»¥æƒ³æƒ³ä¸ºä»€ä¹ˆå®ƒä»¬å·®ä¸å¤šã€‚</p><h3>ç­‰å¾…å…¶ä¸­ä¸€ä¸ªä»»åŠ¡å…ˆè¿”å›</h3><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œè¿˜æœ‰å¦å¤–ä¸€å¤§ç±»éœ€æ±‚ï¼Œå°±æ˜¯åœ¨ä¸€æ‰¹ä»»åŠ¡ä¸­ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæ‰§è¡Œå®Œï¼Œå°±é©¬ä¸Šè¿”å›é‚£ä¸ªä»»åŠ¡çš„ç»“æœã€‚å‰©ä¸‹çš„ä»»åŠ¡ï¼Œè¦ä¹ˆæ˜¯ä¸å…³å¿ƒå®ƒä»¬çš„æ‰§è¡Œç»“æœï¼Œè¦ä¹ˆæ˜¯ç›´æ¥å–æ¶ˆå®ƒä»¬ç»§ç»­æ‰§è¡Œã€‚</p><p>é’ˆå¯¹è¿™ç§åœºæ™¯ï¼Œtokioæä¾›äº† <code>tokio::select!()</code> å®ã€‚ç”¨æ³•å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">use std::time::Duration;\nuse tokio::task;\nuse tokio::time;\n\n#[tokio::main]\nasync fn main() {\n&nbsp; &nbsp; let task_a = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_a\");\n&nbsp; &nbsp; &nbsp; &nbsp; time::sleep(Duration::from_secs(3)).await; // ç­‰å¾…3s\n&nbsp; &nbsp; &nbsp; &nbsp; 1\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_b = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_b\");\n&nbsp; &nbsp; &nbsp; &nbsp; 2\n&nbsp; &nbsp; });\n&nbsp; &nbsp; let task_c = task::spawn(async move {\n&nbsp; &nbsp; &nbsp; &nbsp; println!(\"in task_c\");\n&nbsp; &nbsp; &nbsp; &nbsp; 3\n&nbsp; &nbsp; });\n\n&nbsp; &nbsp; let ret = tokio::select! {\n&nbsp; &nbsp; &nbsp; &nbsp; r = task_a =&gt; r.unwrap(),\n&nbsp; &nbsp; &nbsp; &nbsp; r = task_b =&gt; r.unwrap(),\n&nbsp; &nbsp; &nbsp; &nbsp; r = task_c =&gt; r.unwrap(),\n&nbsp; &nbsp; };\n\n&nbsp; &nbsp; println!(\"{}\", ret);\n}\n// è¾“å‡º\n// ç¬¬ä¸€æ¬¡\nin task_b\nin task_a\n2\nin task_c\n// ç¬¬äºŒæ¬¡\nin task_a\nin task_c\nin task_b\n2\n// ç¬¬næ¬¡\nin task_a\nin task_c\nin task_b\n3\n</code></pre><p>è¯·æ³¨æ„ç¤ºä¾‹é‡Œç¬¬21è¡Œåˆ°ç¬¬25è¡Œçš„å†™æ³•ï¼Œè¿™æ˜¯ <code>tokio::select!</code> å®å®šä¹‰çš„è¯­æ³•ï¼Œä¸æ˜¯Rustæ ‡å‡†è¯­æ³•ã€‚å˜é‡rè¡¨ç¤ºä»»åŠ¡çš„è¿”å›å€¼ã€‚å½“ä½ å¤šæ¬¡æ‰§è¡Œä¸Šé¢ä»£ç åï¼Œä½ ä¼šå‘ç°ï¼Œè¾“å‡ºç»“æœå¹¶ä¸å›ºå®šï¼Œä½ å¯ä»¥æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šè¿™æ ·ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è®¨è®ºäº†åœ¨Rustä¸­å¦‚ä½•åº”ç”¨channelè¿™ç§ç¼–ç¨‹èŒƒå¼ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­é¿å…ä½¿ç”¨é”ã€‚Rustçš„tokioåº“æä¾›äº†å¸¸ç”¨çš„é€šé“æ¨¡å‹åŸºç¡€è®¾æ–½ã€‚</p><ol>\n<li>MPSC å¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€… channel</li>\n<li>Oneshot ä¸€æ¬¡æ€§ channel</li>\n<li>broadcast å¹¿æ’­æ¨¡å¼</li>\n<li>watch è§‚å¯Ÿè€…æ¨¡å¼</li>\n</ol><p>æ¯ç§é€šé“éƒ½æœ‰å„è‡ªçš„ç”¨é€”ï¼Œé€‚ç”¨äºä¸åŒçš„åœºæ™¯éœ€æ±‚ã€‚è¿™ä¸€è®²æˆ‘ä»¬é‡ç‚¹è®²è§£äº†å‰ä¸¤ç§é€šé“ï¼Œåªè¦ä½ æŒæ¡äº†å®ƒä»¬ï¼Œå¦å¤–ä¸¤ç§ä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯å·®ä¸å¤šçš„ã€‚è¿™èŠ‚è¯¾è®¨è®ºçš„è¿™äº›æ¨¡å¼ç›¸å½“å›ºå®šï¼Œåªè¦ç…§æ¬å¥—ç”¨å°±å¯ä»¥äº†ã€‚</p><p>æœ¬è®²ä»£ç é“¾æ¥ï¼š<a href=\"https://github.com/miketang84/jikeshijian/tree/master/16-channel\">https://github.com/miketang84/jikeshijian/tree/master/16-channel</a></p><h2>æ€è€ƒé¢˜</h2><p>ä½ å¯ä»¥è¯´ä¸€è¯´ä»ä»»åŠ¡ä¸­æœé›†è¿”å›ç»“æœæœ‰å‡ ç§æ–¹å¼å—ï¼Ÿæ¬¢è¿ä½ æŠŠä½ å¯¹è¯¾ç¨‹çš„æ€è€ƒå’Œç–‘é—®ç•™åœ¨è¯„è®ºåŒºï¼Œæˆ‘ä¼šå’Œä½ ä¸€èµ·äº¤æµæ¢è®¨ï¼Œå¦‚æœä½ è§‰å¾—è¿™èŠ‚è¯¾çš„å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿ä½ åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"15ï½œtokioç¼–ç¨‹ï¼šåœ¨å¤šä»»åŠ¡ä¹‹é—´æ“ä½œåŒä¸€ç‰‡æ•°æ®","id":728055},"right":{"article_title":"17ï½œtokioç¼–ç¨‹ï¼š Rustå¼‚æ­¥ç¼–ç¨‹è¿˜æœ‰å“ªäº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼Ÿ","id":728198}},"comments":[{"had_liked":false,"id":384389,"user_name":"åˆ˜ä¸¹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"å¹¿ä¸œ","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1700787756,"is_pvip":false,"replies":[{"id":140247,"content":"è¿™æ˜¯tokioé‚£ä¸ªå®é‡Œé¢çš„ç‰¹æ®Šè¯­æ³•ï¼Œä¸æ˜¯æ ‡å‡†çš„rustè¯­æ³•ã€‚å°±æ˜¯ä¸€ä¸ªè¯­æ³•è€Œå·²ã€‚æ—¢ä¸æ˜¯é—­åŒ…ï¼Œä¹Ÿä¸æ˜¯åŒ¿åå‡½æ•°","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700793571,"ip_address":"é‡åº†","comment_id":384389,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¯·é—®è€å¸ˆï¼š r = task_a =&gt; r.unwrap() è¿™æ˜¯é—­åŒ…ï¼Œè¿˜æ˜¯åŒ¿åå‡½æ•°ï¼Ÿ\n\n","like_count":3,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632460,"discussion_content":"è¿™æ˜¯tokioé‚£ä¸ªå®é‡Œé¢çš„ç‰¹æ®Šè¯­æ³•ï¼Œä¸æ˜¯æ ‡å‡†çš„rustè¯­æ³•ã€‚å°±æ˜¯ä¸€ä¸ªè¯­æ³•è€Œå·²ã€‚æ—¢ä¸æ˜¯é—­åŒ…ï¼Œä¹Ÿä¸æ˜¯åŒ¿åå‡½æ•°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700793571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1508755,"avatar":"https://static001.geekbang.org/account/avatar/00/17/05/93/3c3f2a6d.jpg","nickname":"å®‰çŸ³","note":"","ucode":"185AD0046CF1C2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":646784,"discussion_content":"ä¸ºä»€ä¹ˆrustè¿™ä¹ˆå¤šä¸æ˜¯æ ‡å‡†çš„è¯­æ³•ï¼Œæ€ä¹ˆé€šè¿‡ç¼–è¯‘çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1718719385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":387042,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1706254174,"is_pvip":false,"replies":[{"id":141117,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1706673547,"ip_address":"é‡åº†","comment_id":387042,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"èƒŒå‹ - back pressure\n\nå¸¦èƒŒå‹çš„ channel\ntokio::mpsc::channel(n)\nstd::mpsc::sync_channel(n)\n\nä¸å¸¦èƒŒå‹çš„ channel\ntokio::mpsc::unbounded_channel();\nstd::mpsc::channel();","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636660,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1706673547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":387036,"user_name":"Aaaaaaaaaaayou","can_delete":false,"product_type":"c1","uid":1073601,"ip_address":"å¹¿ä¸œ","ucode":"67BA315B87587D","user_header":"https://static001.geekbang.org/account/avatar/00/10/61/c1/93031a2a.jpg","comment_is_top":false,"comment_ctime":1706237925,"is_pvip":false,"replies":[{"id":141095,"content":"ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1706240456,"ip_address":"é‡åº†","comment_id":387036,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"join å’Œ select ç±»ä¼¼äº JavaScript ä¸­çš„ Promise.all å’Œ Promise.race","like_count":1,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636498,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1706240456,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385830,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1703483764,"is_pvip":false,"replies":[{"id":140629,"content":"æ£’æ£’å“’","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703577611,"ip_address":"é‡åº†","comment_id":385830,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æ€è€ƒé¢˜\n- Arc::new(Mutex::new(target_var));\n- res = join_handler.await.unwrap();\n- channel\n","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634495,"discussion_content":"æ£’æ£’å“’","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1703577612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385827,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1703476295,"is_pvip":false,"replies":[{"id":140628,"content":"å“ˆå“ˆï¼Œæ„Ÿè°¢æŒ‡å‡ºï¼Œå¯èƒ½ç¼–è¾‘çš„æ—¶å€™æ¼äº†ã€‚å°½å¿«å¤„ç†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703577533,"ip_address":"é‡åº†","comment_id":385827,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æ‰è™«ï¼š `ç­‰å¾…æ‰€æœ‰ä»»åŠ¡ä¸€èµ·è¿”å›`  main å‰é¢å°‘ä¸ª fn","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634494,"discussion_content":"å“ˆå“ˆï¼Œæ„Ÿè°¢æŒ‡å‡ºï¼Œå¯èƒ½ç¼–è¾‘çš„æ—¶å€™æ¼äº†ã€‚å°½å¿«å¤„ç†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1703577533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384539,"user_name":"åˆ˜æ°¸è‡£","can_delete":false,"product_type":"c1","uid":2033098,"ip_address":"åŒ—äº¬","ucode":"31426CE31CA514","user_header":"https://static001.geekbang.org/account/avatar/00/1f/05/ca/eefef69b.jpg","comment_is_top":false,"comment_ctime":1701130367,"is_pvip":false,"replies":[{"id":140280,"content":"awaitæ˜¯å•ä¸ªä»»åŠ¡ã€‚rustä¸­waitgroupå®ç°ä¹Ÿå¾ˆç®€å•ã€‚å››ç§æ¨¡å¼å¯¹åº”èµ·æ¥äº†ï¼Œå¯èƒ½tokioå°±æ˜¯å€Ÿé‰´çš„go channelã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1701158381,"ip_address":"é‡åº†","comment_id":384539,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":".await()ç±»ä¼¼äºç­‰å¾…ç»„å§ï¼Ÿ channelçš„å››ç§æ¨¡å¼ä¹Ÿæ˜¯go channelå¸¸ç”¨çš„å››ç§åœºæ™¯ã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632663,"discussion_content":"awaitæ˜¯å•ä¸ªä»»åŠ¡ã€‚rustä¸­waitgroupå®ç°ä¹Ÿå¾ˆç®€å•ã€‚å››ç§æ¨¡å¼å¯¹åº”èµ·æ¥äº†ï¼Œå¯èƒ½tokioå°±æ˜¯å€Ÿé‰´çš„go channelã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701158382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384428,"user_name":"å­¦æ°´","can_delete":false,"product_type":"c1","uid":2557688,"ip_address":"åŠ æ‹¿å¤§","ucode":"F8B27FD11187EC","user_header":"https://static001.geekbang.org/account/avatar/00/27/06/f8/09ad484b.jpg","comment_is_top":false,"comment_ctime":1700851703,"is_pvip":false,"replies":[{"id":140252,"content":"rx.awaitå°±æ˜¯åœ¨taskå±‚é¢é˜»å¡ä½ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700888937,"ip_address":"é‡åº†","comment_id":384428,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å¦‚æœé€šé“éƒ½æ²¡æœ‰ä»»ä½•ç”Ÿäº§è€…æ¶ˆæ¯ï¼Œselectè¯­å¥ä¸­çš„æ¶ˆè´¹è€…æ˜¯å µå¡åœ¨é‚£é‡Œè¿˜æ˜¯ä¼šä¹‹é—´è¿›å…¥ä¸‹ä¸€ä¸ªè¯­å¥å‘¢","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632503,"discussion_content":"rx.awaitå°±æ˜¯åœ¨taskå±‚é¢é˜»å¡ä½ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700888937,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384409,"user_name":"è€å¤§","can_delete":false,"product_type":"c1","uid":1109637,"ip_address":"æ²³å—","ucode":"1134808B441F74","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/85/c0cf6544.jpg","comment_is_top":false,"comment_ctime":1700817008,"is_pvip":false,"replies":[{"id":140250,"content":"ä½ å¯ä»¥å¸–ä¸€ä¸‹ä»£ç ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700837390,"ip_address":"é‡åº†","comment_id":384409,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"ä¸ºå•¥æˆ‘æŒ‰ç…§ä½ å†™çš„ï¼Œè¿è¡Œä¸èµ·æ¥å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632492,"discussion_content":"ä½ å¯ä»¥å¸–ä¸€ä¸‹ä»£ç ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700837390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384408,"user_name":"PEtFiSh","can_delete":false,"product_type":"c1","uid":1765926,"ip_address":"ä¸Šæµ·","ucode":"C4922398A92E05","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLO6XvxfFPMGcVSSX8uIZY2yib29qlyat178pU4QM3gIic5GXZ8PC0tzRiazP3FiajXbTj19SE4ZhV0gQ/132","comment_is_top":false,"comment_ctime":1700816941,"is_pvip":false,"replies":[{"id":140249,"content":"ğŸ‘ï¼Œå¾ˆæ£’ã€‚mpsc å’Œ oneshot éƒ½å¯ä»¥æ´¾ä¸Šç”¨åœºã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700837371,"ip_address":"é‡åº†","comment_id":384408,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"ä»ä»»åŠ¡æ”¶é›†è¿”å›ç»“æœçš„æ–¹å¼æœ‰ï¼š\n1ã€ä»»åŠ¡ç›´æ¥è¿”å›å€¼ï¼Œç„¶åé€šè¿‡handlerå–å›ï¼Œæ¯”å¦‚ï¼ša = task_a.await.unwrap();\n2ã€é€šè¿‡é”çš„æ–¹å¼ç›´æ¥å†™åœ¨ç›®æ ‡ä½ç½®\n3ã€é€šè¿‡channelçš„å½¢å¼ä¼ é€’ç»“æœ\n4ã€ä¼¼ä¹ä¹Ÿå¯ä»¥unsafeæ¥å†™å…¨å±€å˜é‡ã€‚","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632491,"discussion_content":"ğŸ‘ï¼Œå¾ˆæ£’ã€‚mpsc å’Œ oneshot éƒ½å¯ä»¥æ´¾ä¸Šç”¨åœºã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700837371,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":384384,"user_name":"ä¼¯é˜³","can_delete":false,"product_type":"c1","uid":1596631,"ip_address":"åŒ—äº¬","ucode":"DBDC8735AA54AD","user_header":"https://static001.geekbang.org/account/avatar/00/18/5c/d7/3b92bb0d.jpg","comment_is_top":false,"comment_ctime":1700777887,"is_pvip":false,"replies":[{"id":140246,"content":"æ‰“æ»¡äº†å°±é˜»å¡äº†ã€‚æ‰“ä¸è¿›å»äº†ï¼Œå°±ç­‰å§ï¼Œæ¶ˆè€—ä¸€ä¸ªå°±èƒ½æ‰“è¿›å»ä¸€ä¸ªã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1700793524,"ip_address":"é‡åº†","comment_id":384384,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¿™ç§æ— é”å¹¶å‘ï¼Œå¿«æ˜¯å¿«äº†ç‚¹ï¼Œä½†æ˜¯å¦‚æœç»™é€šé“æ‰“æ»¡äº†ï¼Œæ€ä¹ˆå¤„ç†å‘¢","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632459,"discussion_content":"æ‰“æ»¡äº†å°±é˜»å¡äº†ã€‚æ‰“ä¸è¿›å»äº†ï¼Œå°±ç­‰å§ï¼Œæ¶ˆè€—ä¸€ä¸ªå°±èƒ½æ‰“è¿›å»ä¸€ä¸ªã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700793524,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":389979,"user_name":"BBJB","can_delete":false,"product_type":"c1","uid":1179528,"ip_address":"ä¸Šæµ·","ucode":"AE1717150476A3","user_header":"https://static001.geekbang.org/account/avatar/00/11/ff/88/36fb189f.jpg","comment_is_top":false,"comment_ctime":1714025446,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"MPSC Channelæ¨¡å¼ï¼Œå¦‚æœåœ¨sendçš„å¼‚æ­¥çº¿ç¨‹ä¸­ï¼Œå¥—ä¸€å±‚å¾ªç¯ for i in 0..100{tx1.send(50).await}\nä¸ºä»€ä¹ˆæ¥å—çº¿ç¨‹éœ€è¦ç­‰å¾ªç¯å®Œæ‰å¼€å§‹æ‰§è¡Œrecvã€‚è€Œä¸æ˜¯sendä¸€ä¸ªï¼Œrecvä¸€ä¸ªã€‚","like_count":0},{"had_liked":false,"id":387043,"user_name":"superggn","can_delete":false,"product_type":"c1","uid":3623568,"ip_address":"åŒ—äº¬","ucode":"831CCD98B393FE","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/7Q403U68Oy4lXG5sFBPVKLrfwaRzBqpBZibpEBXcPf9UOO3qrnh7RELoByTLzBZLkN9Nukfsj7DibynbZjKAKgag/132","comment_is_top":false,"comment_ctime":1706254182,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100626901,"comment_content":"èƒŒå‹ - back pressure\n\nå¸¦èƒŒå‹çš„ channel\ntokio::mpsc::channel(n)\nstd::mpsc::sync_channel(n)\n\nä¸å¸¦èƒŒå‹çš„ channel\ntokio::mpsc::unbounded_channel();\nstd::mpsc::channel();","like_count":0}]}