{"id":86710,"title":"51 | æ¡ˆä¾‹ç¯‡ï¼šåŠ¨æ€è¿½è¸ªæ€ä¹ˆç”¨ï¼Ÿï¼ˆä¸‹ï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·å­¦ä¹ äº†å¸¸è§çš„åŠ¨æ€è¿½è¸ªæ–¹æ³•ã€‚æ‰€è°“åŠ¨æ€è¿½è¸ªï¼Œå°±æ˜¯åœ¨ç³»ç»Ÿæˆ–è€…åº”ç”¨ç¨‹åºæ­£å¸¸è¿è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡å†…æ ¸ä¸­æä¾›çš„æ¢é’ˆï¼Œæ¥åŠ¨æ€è¿½è¸ªå®ƒä»¬çš„è¡Œä¸ºï¼Œä»è€Œè¾…åŠ©æ’æŸ¥å‡ºæ€§èƒ½é—®é¢˜çš„ç“¶é¢ˆã€‚</p><p>ä½¿ç”¨åŠ¨æ€è¿½è¸ªï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç ã€ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€äº†è§£åº”ç”¨ç¨‹åºæˆ–è€…å†…æ ¸çš„è¡Œä¸ºï¼Œè¿™å¯¹æ’æŸ¥çº¿ä¸Šé—®é¢˜ã€ç‰¹åˆ«æ˜¯ä¸å®¹æ˜“é‡ç°çš„é—®é¢˜å°¤å…¶æœ‰æ•ˆã€‚</p><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå¸¸è§çš„åŠ¨æ€è¿½è¸ªæ–¹æ³•åŒ…æ‹¬ ftraceã€perfã€eBPF ä»¥åŠ SystemTap ç­‰ã€‚ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬å…·ä½“å­¦ä¹ äº† ftrace çš„ä½¿ç”¨æ–¹æ³•ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å†æ¥ä¸€èµ·çœ‹çœ‹å…¶ä»–å‡ ç§æ–¹æ³•ã€‚</p><h2>perf</h2><p>perf å·²ç»æ˜¯æˆ‘ä»¬çš„è€æœ‹å‹äº†ã€‚åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¤šæ¬¡ç”¨åˆ°å®ƒï¼Œæ¥æŸ¥æ‰¾åº”ç”¨ç¨‹åºæˆ–è€…å†…æ ¸ä¸­çš„çƒ­ç‚¹å‡½æ•°ï¼Œä»è€Œå®šä½æ€§èƒ½ç“¶é¢ˆã€‚è€Œåœ¨å†…æ ¸çº¿ç¨‹ CPU é«˜çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨ç«ç„°å›¾åŠ¨æ€å±•ç¤º perf çš„äº‹ä»¶è®°å½•ï¼Œä»è€Œæ›´ç›´è§‚åœ°å‘ç°äº†é—®é¢˜ã€‚</p><p>ä¸è¿‡ï¼Œæˆ‘ä»¬å‰é¢ä½¿ç”¨ perf record/topæ—¶ï¼Œéƒ½æ˜¯å…ˆå¯¹äº‹ä»¶è¿›è¡Œé‡‡æ ·ï¼Œç„¶åå†æ ¹æ®é‡‡æ ·æ•°ï¼Œè¯„ä¼°å„ä¸ªå‡½æ•°çš„è°ƒç”¨é¢‘ç‡ã€‚å®é™…ä¸Šï¼Œperf çš„åŠŸèƒ½è¿œä¸æ­¢äºæ­¤ã€‚æ¯”å¦‚ï¼Œ</p><ul>\n<li>\n<p>perf å¯ä»¥ç”¨æ¥åˆ†æ CPU cacheã€CPU è¿ç§»ã€åˆ†æ”¯é¢„æµ‹ã€æŒ‡ä»¤å‘¨æœŸç­‰å„ç§ç¡¬ä»¶äº‹ä»¶ï¼›</p>\n</li>\n<li>\n<p>perf ä¹Ÿå¯ä»¥åªå¯¹æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡ŒåŠ¨æ€è¿½è¸ªã€‚</p>\n</li>\n</ul><!-- [[[read_end]]] --><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥å†…æ ¸å‡½æ•° do_sys_openï¼Œä»¥åŠç”¨æˆ·ç©ºé—´å‡½æ•° readline ä¸ºä¾‹ï¼Œçœ‹ä¸€çœ‹ perf åŠ¨æ€è¿½è¸ªçš„ä½¿ç”¨æ–¹æ³•ã€‚</p><p>åŒ ftrace ä¸€æ ·ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ perf list ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ”¯æŒçš„äº‹ä»¶ï¼š</p><pre><code>$ perf list\n</code></pre><p>ç„¶åï¼Œåœ¨ perf çš„å„ä¸ªå­å‘½ä»¤ä¸­æ·»åŠ  --event é€‰é¡¹ï¼Œè®¾ç½®è¿½è¸ªæ„Ÿå…´è¶£çš„äº‹ä»¶ã€‚å¦‚æœè¿™äº›é¢„å®šä¹‰çš„äº‹ä»¶ä¸æ»¡è¶³å®é™…éœ€è¦ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ perf probe æ¥åŠ¨æ€æ·»åŠ ã€‚è€Œä¸”ï¼Œé™¤äº†è¿½è¸ªå†…æ ¸äº‹ä»¶å¤–ï¼Œperf è¿˜å¯ä»¥ç”¨æ¥è·Ÿè¸ªç”¨æˆ·ç©ºé—´çš„å‡½æ•°ã€‚</p><p><strong>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ª perf ç¤ºä¾‹ï¼Œå†…æ ¸å‡½æ•° do_sys_open çš„ä¾‹å­</strong>ã€‚ä½ å¯ä»¥æ‰§è¡Œ perf probe å‘½ä»¤ï¼Œæ·»åŠ  do_sys_open æ¢é’ˆï¼š</p><pre><code>$ perf probe --add do_sys_open\nAdded new event:\n  probe:do_sys_open    (on do_sys_open)\nYou can now use it in all perf tools, such as:\n    perf record -e probe:do_sys_open -aR sleep 1\n</code></pre><p>æ¢é’ˆæ·»åŠ æˆåŠŸåï¼Œå°±å¯ä»¥åœ¨æ‰€æœ‰çš„ perf å­å‘½ä»¤ä¸­ä½¿ç”¨ã€‚æ¯”å¦‚ï¼Œä¸Šè¿°è¾“å‡ºå°±æ˜¯ä¸€ä¸ª perf record çš„ç¤ºä¾‹ï¼Œæ‰§è¡Œå®ƒå°±å¯ä»¥å¯¹ 10s å†…çš„ do_sys_open è¿›è¡Œé‡‡æ ·ï¼š</p><pre><code>$ perf record -e probe:do_sys_open -aR sleep 10\n[ perf record: Woken up 1 times to write data ]\n[ perf record: Captured and wrote 0.148 MB perf.data (19 samples) ]\n</code></pre><p>è€Œé‡‡æ ·æˆåŠŸåï¼Œå°±å¯ä»¥æ‰§è¡Œ perf script ï¼Œæ¥æŸ¥çœ‹é‡‡æ ·ç»“æœäº†ï¼š</p><pre><code>$ perf script\n            perf 12886 [000] 89565.879875: probe:do_sys_open: (ffffffffa807b290)\n           sleep 12889 [000] 89565.880362: probe:do_sys_open: (ffffffffa807b290)\n           sleep 12889 [000] 89565.880382: probe:do_sys_open: (ffffffffa807b290)\n           sleep 12889 [000] 89565.880635: probe:do_sys_open: (ffffffffa807b290)\n           sleep 12889 [000] 89565.880669: probe:do_sys_open: (ffffffffa807b290)\n</code></pre><p>è¾“å‡ºä¸­ï¼ŒåŒæ ·ä¹Ÿåˆ—å‡ºäº†è°ƒç”¨ do_sys_open çš„ä»»åŠ¡åç§°ã€è¿›ç¨‹ PID ä»¥åŠè¿è¡Œçš„ CPU ç­‰ä¿¡æ¯ã€‚ä¸è¿‡ï¼Œå¯¹äº open ç³»ç»Ÿè°ƒç”¨æ¥è¯´ï¼ŒåªçŸ¥é“å®ƒè¢«è°ƒç”¨äº†å¹¶ä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œè¿›ç¨‹åˆ°åº•åœ¨æ‰“å¼€å“ªäº›æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›è¿½è¸ªæ—¶èƒ½æ˜¾ç¤ºè¿™äº›å‡½æ•°çš„å‚æ•°ã€‚</p><p>å¯¹äºå†…æ ¸å‡½æ•°æ¥è¯´ï¼Œä½ å½“ç„¶å¯ä»¥å»æŸ¥çœ‹å†…æ ¸æºç ï¼Œæ‰¾å‡ºå®ƒçš„æ‰€æœ‰å‚æ•°ã€‚ä¸è¿‡è¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯ç›´æ¥ä»è°ƒè¯•ç¬¦å·è¡¨ä¸­æŸ¥è¯¢ã€‚æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½ å°±å¯ä»¥çŸ¥é“ do_sys_open çš„æ‰€æœ‰å‚æ•°ï¼š</p><pre><code>$ perf probe -V do_sys_open\nAvailable variables at do_sys_open\n        @&lt;do_sys_open+0&gt;\n                char*   filename\n                int     dfd\n                int     flags\n                struct open_flags       op\n                umode_t mode\n</code></pre><p>ä»è¿™å„¿å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ–‡ä»¶è·¯å¾„ï¼Œå°±æ˜¯ç¬¬ä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆå‚æ•°ï¼ˆä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ï¼‰ï¼Œå‚æ•°åç§°ä¸º filenameã€‚å¦‚æœè¿™ä¸ªå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå°±è¯´æ˜è°ƒè¯•ç¬¦å·è¡¨è¿˜æ²¡æœ‰å®‰è£…ã€‚é‚£ä¹ˆï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå®‰è£…è°ƒè¯•ä¿¡æ¯åé‡è¯•ï¼š</p><pre><code># Ubuntu\n$ apt-get install linux-image-`uname -r`-dbgsym\n# CentOS\n$ yum --enablerepo=base-debuginfo install -y kernel-debuginfo-$(uname -r)\n\n</code></pre><p>æ‰¾å‡ºå‚æ•°åç§°å’Œç±»å‹åï¼Œå°±å¯ä»¥æŠŠå‚æ•°åŠ åˆ°æ¢é’ˆä¸­äº†ã€‚ä¸è¿‡ç”±äºæˆ‘ä»¬å·²ç»æ·»åŠ è¿‡åŒåæ¢é’ˆï¼Œæ‰€ä»¥åœ¨è¿™æ¬¡æ·»åŠ å‰ï¼Œéœ€è¦å…ˆæŠŠæ—§æ¢é’ˆç»™åˆ æ‰ï¼š</p><pre><code># å…ˆåˆ é™¤æ—§çš„æ¢é’ˆ\nperf probe --del probe:do_sys_open\n\n# æ·»åŠ å¸¦å‚æ•°çš„æ¢é’ˆ\n$ perf probe --add 'do_sys_open filename:string'\nAdded new event:\n  probe:do_sys_open    (on do_sys_open with filename:string)\nYou can now use it in all perf tools, such as:\n    perf record -e probe:do_sys_open -aR sleep 1\n</code></pre><p>æ–°çš„æ¢é’ˆæ·»åŠ åï¼Œé‡æ–°æ‰§è¡Œ record å’Œ script å­å‘½ä»¤ï¼Œé‡‡æ ·å¹¶æŸ¥çœ‹è®°å½•ï¼š</p><pre><code># é‡æ–°é‡‡æ ·è®°å½•\n$ perf record -e probe:do_sys_open -aR ls\n\n# æŸ¥çœ‹ç»“æœ\n$ perf script\n            perf 13593 [000] 91846.053622: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/proc/13596/status&quot;\n              ls 13596 [000] 91846.053995: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/etc/ld.so.cache&quot;\n              ls 13596 [000] 91846.054011: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/lib/x86_64-linux-gnu/libselinux.so.1&quot;\n              ls 13596 [000] 91846.054066: probe:do_sys_open: (ffffffffa807b290) filename_string=&quot;/lib/x86_64-linux-gnu/libc.so.6â€\n              ...\n# ä½¿ç”¨å®Œæˆåä¸è¦å¿˜è®°åˆ é™¤æ¢é’ˆ\n$ perf probe --del probe:do_sys_open\n</code></pre><p>ç°åœ¨ï¼Œä½ å°±å¯ä»¥çœ‹åˆ°æ¯æ¬¡è°ƒç”¨ open æ—¶æ‰“å¼€çš„æ–‡ä»¶äº†ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªç»“æœæ˜¯ä¸æ˜¯çœ‹ç€å¾ˆç†Ÿæ‚‰å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨ strace è·Ÿè¸ªè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¹Ÿç»å¸¸ä¼šçœ‹åˆ°è¿™äº›åŠ¨æ€åº“çš„å½±å­ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨ strace è·Ÿè¸ª ls æ—¶ï¼Œä½ å¯ä»¥å¾—åˆ°ä¸‹é¢çš„ç»“æœï¼š</p><pre><code>$ strace ls\n...\naccess(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)\naccess(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)\nopenat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3\n...\naccess(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)\nopenat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libselinux.so.1&quot;, O_RDONLY|O_CLOEXEC) = 3\n...\n</code></pre><p>ä½ ä¼°è®¡åœ¨æƒ³ï¼Œæ—¢ç„¶strace ä¹Ÿèƒ½å¾—åˆ°ç±»ä¼¼ç»“æœï¼Œæœ¬èº«åˆå®¹æ˜“æ“ä½œï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜è¦ç”¨perf å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œå¾ˆå¤šäººåªçœ‹åˆ°äº† strace ç®€å•æ˜“ç”¨çš„å¥½å¤„ï¼Œå´å¿½ç•¥äº†å®ƒå¯¹è¿›ç¨‹æ€§èƒ½å¸¦æ¥çš„å½±å“ã€‚ä»åŸç†ä¸Šæ¥è¯´ï¼Œ<strong>strace åŸºäºç³»ç»Ÿè°ƒç”¨ ptrace å®ç°</strong>ï¼Œè¿™å°±å¸¦æ¥äº†ä¸¤ä¸ªé—®é¢˜ã€‚</p><ul>\n<li>\n<p>ç”±äºptrace æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œå°±éœ€è¦åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€åˆ‡æ¢ã€‚å½“äº‹ä»¶æ•°é‡æ¯”è¾ƒå¤šæ—¶ï¼Œç¹å¿™çš„åˆ‡æ¢å¿…ç„¶ä¼šå½±å“åŸæœ‰æœåŠ¡çš„æ€§èƒ½ï¼›</p>\n</li>\n<li>\n<p>ptrace éœ€è¦å€ŸåŠ© SIGSTOP ä¿¡å·æŒ‚èµ·ç›®æ ‡è¿›ç¨‹ã€‚è¿™ç§ä¿¡å·æ§åˆ¶å’Œè¿›ç¨‹æŒ‚èµ·ï¼Œä¼šå½±å“ç›®æ ‡è¿›ç¨‹çš„è¡Œä¸ºã€‚</p>\n</li>\n</ul><p>æ‰€ä»¥ï¼Œåœ¨æ€§èƒ½æ•æ„Ÿçš„åº”ç”¨ï¼ˆæ¯”å¦‚æ•°æ®åº“ï¼‰ä¸­ï¼Œæˆ‘å¹¶ä¸æ¨èä½ ç”¨ strace ï¼ˆæˆ–è€…å…¶ä»–åŸºäº ptrace çš„æ€§èƒ½å·¥å…·ï¼‰å»æ’æŸ¥å’Œè°ƒè¯•ã€‚</p><p>åœ¨ strace çš„å¯å‘ä¸‹ï¼Œç»“åˆå†…æ ¸ä¸­çš„ utrace æœºåˆ¶ï¼Œ perf ä¹Ÿæä¾›äº†ä¸€ä¸ª trace å­å‘½ä»¤ï¼Œæ˜¯å–ä»£ strace çš„é¦–é€‰å·¥å…·ã€‚ç›¸å¯¹äº ptrace æœºåˆ¶æ¥è¯´ï¼Œperf trace åŸºäºå†…æ ¸äº‹ä»¶ï¼Œè‡ªç„¶è¦æ¯”è¿›ç¨‹è·Ÿè¸ªçš„æ€§èƒ½å¥½å¾ˆå¤šã€‚</p><p>perf trace çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œè·Ÿ strace å…¶å®å¾ˆåƒï¼š</p><pre><code>$ perf trace ls\n         ? (         ): ls/14234  ... [continued]: execve()) = 0\n     0.177 ( 0.013 ms): ls/14234 brk(                                                                  ) = 0x555d96be7000\n     0.224 ( 0.014 ms): ls/14234 access(filename: 0xad98082                                            ) = -1 ENOENT No such file or directory\n     0.248 ( 0.009 ms): ls/14234 access(filename: 0xad9add0, mode: R                                   ) = -1 ENOENT No such file or directory\n     0.267 ( 0.012 ms): ls/14234 openat(dfd: CWD, filename: 0xad98428, flags: CLOEXEC                  ) = 3\n     0.288 ( 0.009 ms): ls/14234 fstat(fd: 3&lt;/usr/lib/locale/C.UTF-8/LC_NAME&gt;, statbuf: 0x7ffd2015f230 ) = 0\n     0.305 ( 0.011 ms): ls/14234 mmap(len: 45560, prot: READ, flags: PRIVATE, fd: 3                    ) = 0x7efe0af92000\n     0.324 Dockerfile  test.sh\n( 0.008 ms): ls/14234 close(fd: 3&lt;/usr/lib/locale/C.UTF-8/LC_NAME&gt;                          ) = 0\n     ...\n</code></pre><p>ä¸è¿‡ï¼Œperf trace è¿˜å¯ä»¥è¿›è¡Œç³»ç»Ÿçº§çš„ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªï¼ˆå³è·Ÿè¸ªæ‰€æœ‰è¿›ç¨‹ï¼‰ï¼Œè€Œ strace åªèƒ½è·Ÿè¸ªç‰¹å®šçš„è¿›ç¨‹ã€‚</p><p><strong>ç¬¬äºŒä¸ª perf çš„ä¾‹å­æ˜¯ç”¨æˆ·ç©ºé—´çš„åº“å‡½æ•°</strong>ã€‚ä»¥ bash è°ƒç”¨çš„åº“å‡½æ•° readline ä¸ºä¾‹ï¼Œä½¿ç”¨ç±»ä¼¼çš„æ–¹æ³•ï¼Œå¯ä»¥è·Ÿè¸ªåº“å‡½æ•°çš„è°ƒç”¨ï¼ˆåŸºäº uprobesï¼‰ã€‚</p><p>readline çš„ä½œç”¨ï¼Œæ˜¯ä»ç»ˆç«¯ä¸­è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œå¹¶æŠŠè¿™äº›æ•°æ®è¿”å›è°ƒç”¨æ–¹ã€‚æ‰€ä»¥ï¼Œè·Ÿ open ç³»ç»Ÿè°ƒç”¨ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬æ›´å…³æ³¨ readline çš„è°ƒç”¨ç»“æœã€‚</p><p>æˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œé€šè¿‡ -x æŒ‡å®š bash äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ï¼Œå°±å¯ä»¥åŠ¨æ€è·Ÿè¸ªåº“å‡½æ•°ã€‚è¿™å…¶å®å°±æ˜¯è·Ÿè¸ªäº†æ‰€æœ‰ç”¨æˆ·åœ¨ bash ä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼š</p><pre><code># ä¸º/bin/bashæ·»åŠ readlineæ¢é’ˆ\n$ perf probe -x /bin/bash 'readline%return +0($retval):stringâ€™\n\n# é‡‡æ ·è®°å½•\n$ perf record -e probe_bash:readline__return -aR sleep 5\n\n# æŸ¥çœ‹ç»“æœ\n$ perf script\n    bash 13348 [000] 93939.142576: probe_bash:readline__return: (5626ffac1610 &lt;- 5626ffa46739) arg1=&quot;ls&quot;\n\n# è·Ÿè¸ªå®Œæˆååˆ é™¤æ¢é’ˆ\n$ perf probe --del probe_bash:readline__return\n</code></pre><p>å½“ç„¶ï¼Œå¦‚æœä½ ä¸ç¡®å®šæ¢é’ˆæ ¼å¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ”¯æŒçš„å‡½æ•°å’Œå‡½æ•°å‚æ•°ï¼š</p><pre><code># æŸ¥è¯¢æ‰€æœ‰çš„å‡½æ•°\n$ perf probe -x /bin/bash â€”funcs\n\n# æŸ¥è¯¢å‡½æ•°çš„å‚æ•°\n$ perf probe -x /bin/bash -V readline\nAvailable variables at readline\n        @&lt;readline+0&gt;\n                char*   prompt\n</code></pre><p>è·Ÿå†…æ ¸å‡½æ•°ç±»ä¼¼ï¼Œå¦‚æœä½ æƒ³è¦æŸ¥çœ‹æ™®é€šåº”ç”¨çš„å‡½æ•°åç§°å’Œå‚æ•°ï¼Œé‚£ä¹ˆåœ¨åº”ç”¨ç¨‹åºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼ŒåŒæ ·éœ€è¦åŒ…å«è°ƒè¯•ä¿¡æ¯ã€‚</p><h2>eBPF å’Œ BCC</h2><p>ftrace å’Œ perf çš„åŠŸèƒ½å·²ç»æ¯”è¾ƒä¸°å¯Œäº†ï¼Œä¸è¿‡ï¼Œå®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒçš„ç¼ºé™·ï¼Œé‚£å°±æ˜¯ä¸å¤Ÿçµæ´»ï¼Œæ²¡æ³•åƒ DTrace é‚£æ ·é€šè¿‡è„šæœ¬è‡ªç”±æ‰©å±•ã€‚</p><p>è€Œ eBPF å°±æ˜¯ Linux ç‰ˆçš„ DTraceï¼Œå¯ä»¥é€šè¿‡C è¯­è¨€è‡ªç”±æ‰©å±•ï¼ˆè¿™äº›æ‰©å±•é€šè¿‡ LLVM è½¬æ¢ä¸º BPF å­—èŠ‚ç åï¼ŒåŠ è½½åˆ°å†…æ ¸ä¸­æ‰§è¡Œï¼‰ã€‚ä¸‹é¢è¿™å¼ å›¾ï¼Œå°±è¡¨ç¤ºäº† eBPF è¿½è¸ªçš„å·¥ä½œåŸç†ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a3/e9/a3547f2ac1d4d75b850a02a2735560e9.png?wh=580*325\" alt=\"\"></p><p>ï¼ˆå›¾ç‰‡æ¥è‡ª <a href=\"https://thenewstack.io/long-last-linux-gets-dynamic-tracing/\">THE NEW STACK</a>ï¼‰</p><p>ä»å›¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼ŒeBPF çš„æ‰§è¡Œéœ€è¦ä¸‰æ­¥ï¼š</p><ul>\n<li>\n<p>ä»ç”¨æˆ·è·Ÿè¸ªç¨‹åºç”Ÿæˆ BPF å­—èŠ‚ç ï¼›</p>\n</li>\n<li>\n<p>åŠ è½½åˆ°å†…æ ¸ä¸­è¿è¡Œï¼›</p>\n</li>\n<li>\n<p>å‘ç”¨æˆ·ç©ºé—´è¾“å‡ºç»“æœã€‚</p>\n</li>\n</ul><p>æ‰€ä»¥ï¼Œä»ä½¿ç”¨ä¸Šæ¥è¯´ï¼ŒeBPF è¦æ¯”æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„ ftrace å’Œ perf ï¼Œéƒ½æ›´åŠ ç¹æ‚ã€‚</p><p>å®é™…ä¸Šï¼Œåœ¨ eBPF æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘ã€åŠ è½½è¿˜æœ‰ maps ç­‰æ“ä½œï¼Œå¯¹æ‰€æœ‰çš„è·Ÿè¸ªç¨‹åºæ¥è¯´éƒ½æ˜¯é€šç”¨çš„ã€‚æŠŠè¿™äº›è¿‡ç¨‹é€šè¿‡ Python æŠ½è±¡èµ·æ¥ï¼Œä¹Ÿå°±è¯ç”Ÿäº† BCCï¼ˆBPF Compiler Collectionï¼‰ã€‚</p><p>BCC æŠŠ eBPF ä¸­çš„å„ç§äº‹ä»¶æºï¼ˆæ¯”å¦‚ kprobeã€uprobeã€tracepoint ç­‰ï¼‰å’Œæ•°æ®æ“ä½œï¼ˆç§°ä¸º Mapsï¼‰ï¼Œä¹Ÿéƒ½è½¬æ¢æˆäº† Python æ¥å£ï¼ˆä¹Ÿæ”¯æŒ luaï¼‰ã€‚è¿™æ ·ï¼Œä½¿ç”¨ BCC è¿›è¡ŒåŠ¨æ€è¿½è¸ªæ—¶ï¼Œç¼–å†™ç®€å•çš„è„šæœ¬å°±å¯ä»¥äº†ã€‚</p><p>ä¸è¿‡è¦æ³¨æ„ï¼Œå› ä¸ºéœ€è¦è·Ÿå†…æ ¸ä¸­çš„æ•°æ®ç»“æ„äº¤äº’ï¼ŒçœŸæ­£æ ¸å¿ƒçš„äº‹ä»¶å¤„ç†é€»è¾‘ï¼Œè¿˜æ˜¯éœ€è¦æˆ‘ä»¬ç”¨ C è¯­è¨€æ¥ç¼–å†™ã€‚</p><p>è‡³äº BCC çš„å®‰è£…æ–¹æ³•ï¼Œåœ¨å†…å­˜æ¨¡å—çš„<a href=\"https://time.geekbang.org/column/article/0?cid=140\">ç¼“å­˜æ¡ˆä¾‹</a>ä¸­ï¼Œæˆ‘å°±å·²ç»ä»‹ç»è¿‡äº†ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£…è¿‡ï¼Œå¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥å®‰è£…ï¼ˆå…¶ä»–ç³»ç»Ÿçš„å®‰è£…è¯·å‚è€ƒ<a href=\"https://github.com/iovisor/bcc/blob/master/INSTALL.md\">è¿™é‡Œ</a>ï¼‰ï¼š</p><pre><code># Ubuntu\nsudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 4052245BD4284CDD\necho &quot;deb https://repo.iovisor.org/apt/$(lsb_release -cs) $(lsb_release -cs) main&quot; | sudo tee /etc/apt/sources.list.d/iovisor.list\nsudo apt-get update\nsudo apt-get install bcc-tools libbcc-examples linux-headers-$(uname -r)\n\n# REHL 7.6\nyum install bcc-tools\n</code></pre><p>å®‰è£…åï¼ŒBCC ä¼šæŠŠæ‰€æœ‰ç¤ºä¾‹ï¼ˆåŒ…æ‹¬ Python å’Œ luaï¼‰ï¼Œæ”¾åˆ° /usr/share/bcc/examples ç›®å½•ä¸­ï¼š</p><pre><code>$ ls /usr/share/bcc/examples\nhello_world.py  lua  networking  tracing\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œè¿˜æ˜¯ä»¥ do_sys_open ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ï¼Œå¦‚ä½•ç”¨ eBPF å’Œ BCC å®ç°åŒæ ·çš„åŠ¨æ€è·Ÿè¸ªã€‚</p><p>é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ BCC åº”ç”¨ï¼Œæ‹†åˆ†ä¸ºä¸‹é¢è¿™å››ä¸ªæ­¥éª¤ã€‚</p><p>ç¬¬ä¸€ï¼Œè·Ÿæ‰€æœ‰çš„ Python æ¨¡å—ä½¿ç”¨æ–¹æ³•ä¸€æ ·ï¼Œåœ¨ä½¿ç”¨ä¹‹å‰ï¼Œå…ˆå¯¼å…¥è¦ç”¨åˆ°çš„æ¨¡å—ï¼š</p><pre><code>from bcc import BPF\n</code></pre><p>ç¬¬äºŒï¼Œéœ€è¦å®šä¹‰äº‹ä»¶ä»¥åŠå¤„ç†äº‹ä»¶çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°éœ€è¦ç”¨ C è¯­è¨€æ¥ç¼–å†™ï¼Œä½œç”¨æ˜¯åˆå§‹åŒ–åˆšæ‰å¯¼å…¥çš„ BPF å¯¹è±¡ã€‚è¿™äº›ç”¨ C è¯­è¨€ç¼–å†™çš„å¤„ç†å‡½æ•°ï¼Œè¦ä»¥å­—ç¬¦ä¸²çš„å½¢å¼é€åˆ° BPF æ¨¡å—ä¸­å¤„ç†ï¼š</p><pre><code># define BPF program (&quot;&quot;&quot; is used for multi-line string).\n# '#' indicates comments for python, while '//' indicates comments for C.\nprog = &quot;&quot;&quot;\n#include &lt;uapi/linux/ptrace.h&gt;\n#include &lt;uapi/linux/limits.h&gt;\n#include &lt;linux/sched.h&gt;\n// define output data structure in C\nstruct data_t {\n    u32 pid;\n    u64 ts;\n    char comm[TASK_COMM_LEN];\n    char fname[NAME_MAX];\n};\nBPF_PERF_OUTPUT(events);\n\n// define the handler for do_sys_open.\n// ctx is required, while other params depends on traced function.\nint hello(struct pt_regs *ctx, int dfd, const char __user *filename, int flags){\n    struct data_t data = {};\n    data.pid = bpf_get_current_pid_tgid();\n    data.ts = bpf_ktime_get_ns();\n    if (bpf_get_current_comm(&amp;data.comm, sizeof(data.comm)) == 0) {\n        bpf_probe_read(&amp;data.fname, sizeof(data.fname), (void *)filename);\n    }\n    events.perf_submit(ctx, &amp;data, sizeof(data));\n    return 0;\n}\n&quot;&quot;&quot;\n# load BPF program\nb = BPF(text=prog)\n# attach the kprobe for do_sys_open, and set handler to hello\nb.attach_kprobe(event=&quot;do_sys_open&quot;, fn_name=&quot;hello&quot;)\n</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œæ˜¯å®šä¹‰ä¸€ä¸ªè¾“å‡ºå‡½æ•°ï¼Œå¹¶æŠŠè¾“å‡ºå‡½æ•°è·Ÿ BPF äº‹ä»¶ç»‘å®šï¼š</p><pre><code># process event\nstart = 0\ndef print_event(cpu, data, size):\n    global start\n    # eventâ€™s type is data_t\n    event = b[&quot;events&quot;].event(data)\n    if start == 0:\n            start = event.ts\n    time_s = (float(event.ts - start)) / 1000000000\n    print(&quot;%-18.9f %-16s %-6d %-16s&quot; % (time_s, event.comm, event.pid, event.fname))\n\n# loop with callback to print_event\nb[&quot;events&quot;].open_perf_buffer(print_event)\n</code></pre><p>æœ€åä¸€æ­¥ï¼Œå°±æ˜¯æ‰§è¡Œäº‹ä»¶å¾ªç¯ï¼Œå¼€å§‹è¿½è¸ª do_sys_open çš„è°ƒç”¨ï¼š</p><pre><code># print header\nprint(&quot;%-18s %-16s %-6s %-16s&quot; % (&quot;TIME(s)&quot;, &quot;COMM&quot;, &quot;PID&quot;, &quot;FILEâ€))\n# start the event polling loop\nwhile 1:\n    try:\n        b.perf_buffer_poll()\n    except KeyboardInterrupt:\n        exit()\n</code></pre><p>æˆ‘ä»¬æŠŠä¸Šé¢å‡ ä¸ªæ­¥éª¤çš„ä»£ç ï¼Œä¿å­˜åˆ°æ–‡ä»¶ trace-open.py ä¸­ï¼Œç„¶åå°±å¯ä»¥ç”¨ Python æ¥è¿è¡Œäº†ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><pre><code>$ python trace-open.py\nTIME(s)            COMM             PID    FILE\n0.000000000        irqbalance       1073   /proc/interrupts\n0.000175401        irqbalance       1073   /proc/stat\n0.000258802        irqbalance       1073   /proc/irq/9/smp_affinity\n0.000290102        irqbalance       1073   /proc/irq/0/smp_affinity\n</code></pre><p>ä»è¾“å‡ºä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° irqbalance è¿›ç¨‹ï¼ˆä½ çš„ç¯å¢ƒä¸­å¯èƒ½è¿˜ä¼šæœ‰å…¶ä»–è¿›ç¨‹ï¼‰æ­£åœ¨æ‰“å¼€å¾ˆå¤šæ–‡ä»¶ï¼Œè€Œ irqbalance ä¾èµ–è¿™äº›æ–‡ä»¶ä¸­è¯»å–çš„å†…å®¹ï¼Œæ¥æ‰§è¡Œä¸­æ–­è´Ÿè½½å‡è¡¡ã€‚</p><p>é€šè¿‡è¿™ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œä½ ä¹Ÿå¯ä»¥å‘ç°ï¼ŒeBPF å’Œ BCC çš„ä½¿ç”¨ï¼Œå…¶å®æ¯” ftrace å’Œ perf æœ‰æ›´é«˜çš„é—¨æ§›ã€‚æƒ³ç”¨ BCC å¼€å‘è‡ªå·±çš„åŠ¨æ€è·Ÿè¸ªç¨‹åºï¼Œè‡³å°‘è¦ç†Ÿæ‚‰ C è¯­è¨€ã€Python è¯­è¨€ã€è¢«è·Ÿè¸ªäº‹ä»¶æˆ–å‡½æ•°çš„ç‰¹å¾ï¼ˆæ¯”å¦‚å†…æ ¸å‡½æ•°çš„å‚æ•°å’Œè¿”å›æ ¼å¼ï¼‰ä»¥åŠ eBPF æä¾›çš„å„ç§æ•°æ®æ“ä½œæ–¹æ³•ã€‚</p><p>ä¸è¿‡ï¼Œå› ä¸ºå¼ºå¤§çš„çµæ´»æ€§ï¼Œè™½ç„¶ eBPF åœ¨ä½¿ç”¨ä¸Šæœ‰ä¸€å®šçš„é—¨æ§›ï¼Œå´ä¹Ÿæ— æ³•é˜»æ­¢å®ƒæˆä¸ºç›®å‰æœ€çƒ­é—¨ã€æœ€å—å…³æ³¨çš„åŠ¨æ€è¿½è¸ªæŠ€æœ¯ã€‚</p><p>å½“ç„¶ï¼ŒBCC è½¯ä»¶åŒ…ä¹Ÿå†…ç½®äº†å¾ˆå¤šå·²ç»å¼€å‘å¥½çš„å®ç”¨å·¥å…·ï¼Œé»˜è®¤å®‰è£…åˆ° /usr/share/bcc/tools/ ç›®å½•ä¸­ï¼Œå®ƒä»¬çš„ä½¿ç”¨åœºæ™¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/fc/21/fc5f387a982db98c49c7cefb77342c21.png?wh=1500*1050\" alt=\"\"></p><p>ï¼ˆå›¾ç‰‡æ¥è‡ª <a href=\"http://www.brendangregg.com/ebpf.html#bcc\">Linux Extended BPF (eBPF) Tracing Tools</a>ï¼‰</p><p>è¿™äº›å·¥å…·ï¼Œä¸€èˆ¬éƒ½å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ã€‚è€Œåœ¨ç¼–å†™å…¶ä»–çš„åŠ¨æ€è¿½è¸ªè„šæœ¬æ—¶ï¼Œå®ƒä»¬ä¹Ÿæ˜¯æœ€å¥½çš„å‚è€ƒèµ„æ–™ã€‚ä¸è¿‡ï¼Œæœ‰ä¸€ç‚¹éœ€è¦ä½ ç‰¹åˆ«æ³¨æ„ï¼Œå¾ˆå¤š eBPF çš„æ–°ç‰¹æ€§ï¼Œéƒ½éœ€è¦æ¯”è¾ƒæ–°çš„<a href=\"https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md\">å†…æ ¸ç‰ˆæœ¬</a>ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚å¦‚æœæŸäº›å·¥å…·æ— æ³•è¿è¡Œï¼Œå¾ˆå¯èƒ½å°±æ˜¯å› ä¸ºä½¿ç”¨äº†å½“å‰å†…æ ¸ä¸æ”¯æŒçš„ç‰¹æ€§ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/61/e8/61abce1affc770a15dae7d489e50a8e8.png?wh=1500*1050\" alt=\"\"></p><p>ï¼ˆå›¾ç‰‡æ¥è‡ª <a href=\"http://www.brendangregg.com/ebpf.html#bcc\">Linux Extended BPF (eBPF) Tracing Tools</a>ï¼‰</p><h2>SystemTap å’Œ sysdig</h2><p>é™¤äº†å‰é¢æåˆ°çš„ ftraceã€perfã€eBPF å’Œ BCC å¤–ï¼ŒSystemTap å’Œ sysdig ä¹Ÿæ˜¯å¸¸ç”¨çš„åŠ¨æ€è¿½è¸ªå·¥å…·ã€‚</p><p><strong>SystemTap</strong> ä¹Ÿæ˜¯ä¸€ç§å¯ä»¥é€šè¿‡è„šæœ¬è¿›è¡Œè‡ªç”±æ‰©å±•çš„åŠ¨æ€è¿½è¸ªæŠ€æœ¯ã€‚åœ¨ eBPF å‡ºç°ä¹‹å‰ï¼ŒSystemTap æ˜¯Linux ç³»ç»Ÿä¸­ï¼ŒåŠŸèƒ½æœ€æ¥è¿‘ DTrace çš„åŠ¨æ€è¿½è¸ªæœºåˆ¶ã€‚ä¸è¿‡è¦æ³¨æ„ï¼ŒSystemTap åœ¨å¾ˆé•¿æ—¶é—´ä»¥æ¥éƒ½æ¸¸ç¦»äºå†…æ ¸ä¹‹å¤–ï¼ˆè€Œ eBPF è‡ªè¯ç”Ÿä»¥æ¥ï¼Œä¸€ç›´æ ¹æ¤åœ¨å†…æ ¸ä¸­ï¼‰ã€‚</p><p>æ‰€ä»¥ï¼Œä»ç¨³å®šæ€§ä¸Šæ¥è¯´ï¼ŒSystemTap åªåœ¨ RHEL ç³»ç»Ÿä¸­å¥½ç”¨ï¼Œåœ¨å…¶ä»–ç³»ç»Ÿä¸­åˆ™å®¹æ˜“å‡ºç°å„ç§å¼‚å¸¸é—®é¢˜ã€‚å½“ç„¶ï¼Œåè¿‡æ¥è¯´ï¼Œæ”¯æŒ 3.x ç­‰æ—§ç‰ˆæœ¬çš„å†…æ ¸ï¼Œä¹Ÿæ˜¯ SystemTap ç›¸å¯¹äº eBPF çš„ä¸€ä¸ªå·¨å¤§ä¼˜åŠ¿ã€‚</p><p><strong>sysdig</strong> åˆ™æ˜¯éšç€å®¹å™¨æŠ€æœ¯çš„æ™®åŠè€Œè¯ç”Ÿçš„ï¼Œä¸»è¦ç”¨äºå®¹å™¨çš„åŠ¨æ€è¿½è¸ªã€‚sysdig æ±‡é›†äº†ä¸€äº›åˆ—æ€§èƒ½å·¥å…·çš„ä¼˜åŠ¿ï¼Œå¯ä»¥è¯´æ˜¯é›†ç™¾å®¶ä¹‹æ‰€é•¿ã€‚æˆ‘ä¹ æƒ¯ç”¨è¿™ä¸ªå…¬å¼æ¥è¡¨ç¤ºsysdigçš„ç‰¹ç‚¹ï¼š sysdig = strace + tcpdump + htop + iftop + lsof + docker inspectã€‚</p><p>è€Œåœ¨æœ€æ–°çš„ç‰ˆæœ¬ä¸­ï¼ˆå†…æ ¸ç‰ˆæœ¬ &gt;= 4.14ï¼‰ï¼Œsysdig è¿˜å¯ä»¥é€šè¿‡ eBPF æ¥è¿›è¡Œæ‰©å±•ï¼Œæ‰€ä»¥ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥è¿½è¸ªå†…æ ¸ä¸­çš„å„ç§å‡½æ•°å’Œäº‹ä»¶ã€‚</p><h2>å¦‚ä½•é€‰æ‹©è¿½è¸ªå·¥å…·</h2><p>åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½åˆè§‰å¾—å¤´å¤§äº†ï¼Œè¿™ä¹ˆå¤šåŠ¨æ€è¿½è¸ªå·¥å…·ï¼Œåœ¨å®é™…åœºæ™¯ä¸­åˆ°åº•è¯¥æ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿè¿˜æ˜¯é‚£å¥è¯ï¼Œå…·ä½“æ€§èƒ½å·¥å…·çš„é€‰æ‹©ï¼Œå°±è¦ä»å…·ä½“çš„å·¥ä½œåŸç†æ¥å…¥æ‰‹ã€‚</p><p>è¿™ä¸¤èŠ‚è¯¾ï¼Œæˆ‘ä»¬å·²ç»æŠŠå¸¸è§å·¥å…·çš„åŸç†å’Œç‰¹ç‚¹éƒ½ä»‹ç»è¿‡äº†ï¼Œä½ å¯ä»¥å…ˆè‡ªå·±æ€è€ƒåŒºåˆ†ä¸€ä¸‹ï¼Œä¸åŒåœºæ™¯çš„å·¥å…·é€‰æ‹©é—®é¢˜ã€‚æ¯”å¦‚ï¼š</p><ul>\n<li>\n<p>åœ¨ä¸éœ€è¦å¾ˆé«˜çµæ´»æ€§çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨ perf å¯¹æ€§èƒ½äº‹ä»¶è¿›è¡Œé‡‡æ ·ï¼Œç„¶åå†é…åˆç«ç„°å›¾è¾…åŠ©åˆ†æï¼Œå°±æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§æ–¹æ³•ï¼›</p>\n</li>\n<li>\n<p>è€Œéœ€è¦å¯¹äº‹ä»¶æˆ–å‡½æ•°è°ƒç”¨è¿›è¡Œç»Ÿè®¡åˆ†æï¼ˆæ¯”å¦‚è§‚å¯Ÿä¸åŒå¤§å°çš„ I/O åˆ†å¸ƒï¼‰æ—¶ï¼Œå°±è¦ç”¨ SystemTap æˆ–è€… eBPFï¼Œé€šè¿‡ä¸€äº›è‡ªå®šä¹‰çš„è„šæœ¬æ¥è¿›è¡Œæ•°æ®å¤„ç†ã€‚</p>\n</li>\n</ul><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä¹Ÿæ€»ç»“äº†å‡ ä¸ªå¸¸è§çš„åŠ¨æ€è¿½è¸ªä½¿ç”¨åœºæ™¯ï¼Œå¹¶ä¸”åˆ†åˆ«æ¨èäº†é€‚åˆçš„å·¥å…·ã€‚ä½ å¯ä»¥ä¿å­˜è¿™ä¸ªè¡¨æ ¼ï¼Œæ–¹ä¾¿è‡ªå·±æŸ¥æ‰¾å¹¶ä½¿ç”¨ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5a/25/5a2b2550547d5eaee850bfb806f76625.png?wh=1659*872\" alt=\"\"></p><h2>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä¸»è¦å¸¦ä½ å­¦ä¹ äº† perfã€eBPF å’Œ BCC ç­‰åŠ¨æ€è¿½è¸ªæ–¹æ³•ï¼Œå¹¶æ€»ç»“äº†ä¸åŒåœºæ™¯ä¸­å¦‚ä½•é€‰æ‹©åŠ¨æ€è¿½è¸ªæ–¹æ³•ã€‚</p><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå¸¸è§çš„åŠ¨æ€è¿½è¸ªæ–¹æ³•ï¼ŒåŒ…æ‹¬ ftraceã€perfã€eBPF ä»¥åŠ SystemTap ç­‰ã€‚åœ¨å¤§å¤šæ•°æ€§èƒ½é—®é¢˜ä¸­ï¼Œä½¿ç”¨ perf é…åˆç«ç„°å›¾æ˜¯ä¸€ä¸ªä¸é”™çš„æ–¹æ³•ã€‚å¦‚æœè¿™æ»¡è¶³ä¸äº†ä½ çš„è¦æ±‚ï¼Œé‚£ä¹ˆï¼š</p><ul>\n<li>\n<p>åœ¨æ–°ç‰ˆçš„å†…æ ¸ä¸­ï¼ŒeBPF å’Œ BCC æ˜¯æœ€çµæ´»çš„åŠ¨æ€è¿½è¸ªæ–¹æ³•ï¼›</p>\n</li>\n<li>\n<p>è€Œåœ¨æ—§ç‰ˆæœ¬å†…æ ¸ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨ RHEL ç³»ç»Ÿä¸­ï¼Œç”±äº eBPF æ”¯æŒå—é™ï¼ŒSystemTap å¾€å¾€æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p>\n</li>\n</ul><p>æ­¤å¤–ï¼Œåœ¨ä½¿ç”¨åŠ¨æ€è¿½è¸ªæŠ€æœ¯æ—¶ï¼Œä¸ºäº†å¾—åˆ°åˆ†æç›®æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¸€èˆ¬éœ€è¦å†…æ ¸ä»¥åŠåº”ç”¨ç¨‹åºçš„è°ƒè¯•ç¬¦å·è¡¨ã€‚åŠ¨æ€è¿½è¸ªå®é™…ä¸Šä¹Ÿæ˜¯åœ¨è¿™äº›ç¬¦å·ï¼ˆåŒ…æ‹¬å‡½æ•°å’Œäº‹ä»¶ï¼‰ä¸Šè¿›è¡Œçš„ï¼Œæ‰€ä»¥æ˜“è¯»æ˜“ç†è§£çš„ç¬¦å·ï¼Œæœ‰åŠ©äºåŠ å¿«åŠ¨æ€è¿½è¸ªçš„è¿‡ç¨‹ã€‚</p><h2>æ€è€ƒ</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ ä¸€èµ·æ¥èŠèŠï¼Œä½ æ‰€ç†è§£çš„åŠ¨æ€è¿½è¸ªæŠ€æœ¯ã€‚ä½ æœ‰æ²¡æœ‰åœ¨å®é™…ç¯å¢ƒä¸­ç”¨è¿‡åŠ¨æ€è¿½è¸ªå‘¢ï¼Ÿè¿™ä¹ˆå¤šçš„åŠ¨æ€è¿½è¸ªæ–¹æ³•ï¼Œä½ ä¸€èˆ¬ä¼šæ€ä¹ˆé€‰æ‹©å‘¢ï¼Ÿä½ å¯ä»¥ç»“åˆä»Šå¤©çš„å†…å®¹ï¼Œå’Œä½ è‡ªå·±çš„æ“ä½œè®°å½•ï¼Œæ¥æ€»ç»“æ€è·¯ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":78875,"user_name":"æˆ‘æ¥ä¹Ÿ","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1553266094,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"48797906350","product_id":100020901,"comment_content":"[D51æ‰“å¡]<br>é•¿è§è¯†äº†ã€‚<br>è¿˜æ˜¯å…ˆæŠŠperf å’Œ ç«ç„°å›¾ç”¨èµ·æ¥å§ã€‚<br>çŸ¥é“è¿˜æœ‰æ›´å¥½çš„å·¥å…·åœ¨å†…æ ¸æ”¶é›†ä¿¡æ¯å°±è¡Œäº†ã€‚æœ‰éœ€è¦äº†å†æ¥é’ˆå¯¹æ€§çš„ çœ‹å§ã€‚ğŸ¤¦â€â™‚ï¸","like_count":12},{"had_liked":false,"id":79859,"user_name":"xfan","can_delete":false,"product_type":"c1","uid":1315147,"ip_address":"","ucode":"48ED8D498D7F56","user_header":"https://static001.geekbang.org/account/avatar/00/14/11/4b/fa64f061.jpg","comment_is_top":false,"comment_ctime":1553564730,"is_pvip":false,"replies":[{"id":"29334","content":"å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–‡æ¡£ï¼šhttps:&#47;&#47;docs.cilium.io&#47;en&#47;stable&#47;bpf&#47;","user_name":"ä½œè€…å›å¤","comment_id":79859,"uid":"1001282","ip_address":"","utype":1,"ctime":1553697859,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"31618335802","product_id":100020901,"comment_content":"æˆ‘æƒ³çŸ¥é“ebpfç¨‹åºç¼–å†™æœ‰ä»€ä¹ˆå¥½ç‚¹çš„å­¦ä¹ èµ„æºå—ï¼Œæœ‰ç§å¿ƒæœ‰ä½™è€ŒåŠ›ä¸è¶³çš„æ„Ÿè§‰","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444656,"discussion_content":"å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–‡æ¡£ï¼šhttps://docs.cilium.io/en/stable/bpf/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553697859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":112566,"user_name":"lyonger","can_delete":false,"product_type":"c1","uid":1313840,"ip_address":"","ucode":"E89A75DADEA2A1","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/30/bb4bfe9d.jpg","comment_is_top":false,"comment_ctime":1562760907,"is_pvip":false,"replies":[{"id":"41995","content":"1. å¯ä»¥å…ˆè¯•è¯•ç«ç„°å›¾ï¼Œç„¶åè·Ÿç€ç«ç„°å›¾è°ƒç”¨å †æ ˆå»æŸ¥è¯¢å†…æ ¸æºç ã€‚<br>2. æ¢é’ˆçš„è¯ï¼Œå·¥å…·é‡Œé¢éƒ½æä¾›äº†æ¢é’ˆæŸ¥è¯¢çš„å‘½ä»¤ï¼Œæ¯”å¦‚ perf list","user_name":"ä½œè€…å›å¤","comment_id":112566,"uid":"1001282","ip_address":"","utype":1,"ctime":1563458707,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"14447662795","product_id":100020901,"comment_content":"è€å¸ˆï¼Œæœ€è¿‘kvmè™šæ‹Ÿæœºå™¨ï¼Œxfsæ–‡ä»¶ç³»ç»Ÿä¸‹ä½¿ç”¨devmapperçš„é©±åŠ¨ï¼Œæ¯æ¬¡ä½¿ç”¨dockerè·‘ä»»åŠ¡ci buildçš„æ—¶å€™ï¼Œç”¨iotopæŸ¥çœ‹å‘ç°runneræœºå™¨çš„[loop1]ã€[loop2]ã€[kworker&#47;u32:2]çš„io 99%ï¼Œä»»åŠ¡ä¸­æ­¢äº†ä»¥åå°±æ²¡æœ‰å‘ç°å¼‚å¸¸äº†ã€‚æˆ‘ç”¨perfå®šä½åˆ°äº†çƒ­ç‚¹å‡½æ•°æ˜¯xfsaildã€xfs_inode_item_pushã€‚ç”¨ftraceå’Œtrace-cmdè¦å…ˆçŸ¥é“è¿è¡Œçš„å‘½ä»¤ã€‚é‚£ä¹ˆ2ä¸ªç–‘é—®ï¼š<br>1ã€æœ‰åŠæ³•ç›´æ¥æŸ¥çœ‹æŸä¸ªçƒ­ç‚¹å‡½æ•°é‡Œçš„æ‰§è¡Œé€»è¾‘å—ï¼Ÿåœ¨ä¸çŸ¥é“æ‰§è¡Œä»€ä¹ˆå‘½ä»¤çš„æƒ…å†µä¸‹ï¼Œæˆ‘åªçŸ¥é“æŸä¸ªçƒ­ç‚¹å‡½æ•°åç§°<br>2ã€å¯ä»¥ä½¿ç”¨çš„æ¢é’ˆæœ‰å“ªäº›ï¼Œæ˜¯æ€ä¹ˆæŸ¥çœ‹å‘¢ï¼Ÿ<br><br>æœŸå¾…æ‚¨çš„å›å¤ï¼Œå¤šè°¢ã€‚","like_count":4,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457797,"discussion_content":"1. å¯ä»¥å…ˆè¯•è¯•ç«ç„°å›¾ï¼Œç„¶åè·Ÿç€ç«ç„°å›¾è°ƒç”¨å †æ ˆå»æŸ¥è¯¢å†…æ ¸æºç ã€‚\n2. æ¢é’ˆçš„è¯ï¼Œå·¥å…·é‡Œé¢éƒ½æä¾›äº†æ¢é’ˆæŸ¥è¯¢çš„å‘½ä»¤ï¼Œæ¯”å¦‚ perf list","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563458707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":85753,"user_name":"Geek_007","can_delete":false,"product_type":"c1","uid":1467182,"ip_address":"","ucode":"C80107538EAA7F","user_header":"https://static001.geekbang.org/account/avatar/00/16/63/2e/e49116d1.jpg","comment_is_top":false,"comment_ctime":1555222517,"is_pvip":false,"replies":[{"id":"31293","content":"åº”è¯¥æ˜¯ perf trace -e fs:do_sys_open","user_name":"ä½œè€…å›å¤","comment_id":85753,"uid":"1001282","ip_address":"","utype":1,"ctime":1555501842,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":1,"score":"10145157109","product_id":100020901,"comment_content":"è€å¸ˆä½ å¥½ï¼Œæˆ‘åœ¨ä½¿ç”¨ perf trace å‘½ä»¤æ—¶å‘ç°ï¼Œperf trace è¿½è¸ªæ—¶ï¼Œä¸èƒ½æ‰“å°å‡ºæ‰“å¼€æ–‡ä»¶çš„æ–‡ä»¶åï¼Œå°½ç®¡æˆ‘å·²ç»ä½¿ç”¨ perf probe å°†filename åŠ å…¥ï¼Œä½†æ˜¯ä¾ç„¶æ— æ³•æ‰“å°å‡ºæ–‡ä»¶åã€‚å¦å¤–æˆ‘ä½¿ç”¨ perf trace -e probe:do_sys_open ,ä¾ç„¶è¿˜æ˜¯è®°å½•æ‰€æœ‰çš„äº‹ä»¶ï¼Œè¯·é—®è€å¸ˆï¼Œæ˜¯æˆ‘ä½¿ç”¨çš„æœ‰é—®é¢˜ï¼Ÿè¿˜æ˜¯å…¶ä»–é—®é¢˜ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446793,"discussion_content":"åº”è¯¥æ˜¯ perf trace -e fs:do_sys_open","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555501842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":101294,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1559779430,"is_pvip":false,"replies":[{"id":"37103","content":"æœ€ä¸»è¦çš„æ˜¯è°ƒè¯•ä¿¡æ¯é—®é¢˜ï¼Œå®¹å™¨è¿›ç¨‹å’Œä¾èµ–ç¯å¢ƒè·Ÿä¸»æœºåœ¨ä¸åŒnamespaceä¸­ï¼Œå¾ˆå¤šå·¥å…·å¯èƒ½æ— æ³•æ­£ç¡®æ‰¾å‡ºç›¸åº”çš„ç¬¦å·è¡¨","user_name":"ä½œè€…å›å¤","comment_id":101294,"uid":"1001282","ip_address":"","utype":1,"ctime":1560261047,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"5854746726","product_id":100020901,"comment_content":"æƒ³è¯·æ•™ä¸‹è€å¸ˆï¼Œåœ¨å®¹å™¨ç¯å¢ƒä¸‹ä½¿ç”¨ä»¥ä¸ŠåŠ¨æ€è¿½è¸ªæŠ€æœ¯æœ‰å“ªäº›æ³¨æ„ç‚¹å’Œå‘å‘¢","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":452895,"discussion_content":"æœ€ä¸»è¦çš„æ˜¯è°ƒè¯•ä¿¡æ¯é—®é¢˜ï¼Œå®¹å™¨è¿›ç¨‹å’Œä¾èµ–ç¯å¢ƒè·Ÿä¸»æœºåœ¨ä¸åŒnamespaceä¸­ï¼Œå¾ˆå¤šå·¥å…·å¯èƒ½æ— æ³•æ­£ç¡®æ‰¾å‡ºç›¸åº”çš„ç¬¦å·è¡¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560261047,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78659,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1553213528,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5848180824","product_id":100020901,"comment_content":"æ‰“å¡day54<br>æ•´ä¸ªåŠ¨æ€è¿½è¸ªéƒ½æ¯”è¾ƒæ‡µé€¼ï¼Œå¸¸ç”¨çš„ä¹Ÿå°±æ˜¯traceå’Œperfå¾ˆç®€å•çš„ç”¨æ³•ï¼Œç­‰å•ƒå®Œå†…æ ¸çš„ä¹¦å†å›è¿‡å¤´æ¥çœ‹æ–‡ç« ï¼Œä¼°è®¡å®¹æ˜“æ¶ˆåŒ–ç‚¹ï½","like_count":1},{"had_liked":false,"id":336255,"user_name":"AceslupK","can_delete":false,"product_type":"c1","uid":1284474,"ip_address":"","ucode":"048F84D019CBBB","user_header":"https://static001.geekbang.org/account/avatar/00/13/99/7a/558666a5.jpg","comment_is_top":false,"comment_ctime":1646039093,"is_pvip":false,"replies":[{"id":"122896","content":"å¯ä»¥ç»§ç»­çœ‹ä¸€ä¸‹eBPFä¸“æ ğŸ˜Š","user_name":"ä½œè€…å›å¤","comment_id":336255,"uid":"1001282","ip_address":"","utype":1,"ctime":1646046139,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1646039093","product_id":100020901,"comment_content":"åŠ¨æ€è¿½è¸ªå¥½éš¾","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":553737,"discussion_content":"å¯ä»¥ç»§ç»­çœ‹ä¸€ä¸‹eBPFä¸“æ ğŸ˜Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646046139,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":298294,"user_name":"Geek_b85295","can_delete":false,"product_type":"c1","uid":1487998,"ip_address":"","ucode":"51CBB577C255EA","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqtXSgThiaEiaEqqic5YIJ7v469nCM3VXiccOJ4SxbYjW91ciczuYYEzcTVtYWaWXaokZqShuLdKsXjnFA/132","comment_is_top":false,"comment_ctime":1624004861,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624004861","product_id":100020901,"comment_content":"apt-get install linux-image-`uname -r`-dbgsym  <br>è¿™å¥è¯æ‰§è¡Œç‰¹åˆ«æ…¢æ€ä¹ˆåŠï¼Œå®‰è£…åŒ…éå¸¸å¤§ï¼Œæœ‰å›½å†…çš„æºæ›¿ä»£æºå—ï¼ŒæŠŠä¸‹é¢ä¸¤ä¸ªæ›¿æ¢æ‰<br>deb http:&#47;&#47;ddebs.ubuntu.com&#47; bionic main<br>deb http:&#47;&#47;ddebs.ubuntu.com&#47; bionic-updates main<br>","like_count":0},{"had_liked":false,"id":298293,"user_name":"Geek_b85295","can_delete":false,"product_type":"c1","uid":1487998,"ip_address":"","ucode":"51CBB577C255EA","user_header":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqtXSgThiaEiaEqqic5YIJ7v469nCM3VXiccOJ4SxbYjW91ciczuYYEzcTVtYWaWXaokZqShuLdKsXjnFA/132","comment_is_top":false,"comment_ctime":1624004763,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1624004763","product_id":100020901,"comment_content":"apt-get install linux-image-`uname -r`-dbgsym  ","like_count":0},{"had_liked":false,"id":292023,"user_name":"bruceyk","can_delete":false,"product_type":"c1","uid":1033556,"ip_address":"","ucode":"DD1E8AFEDFD69B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c5/54/a9b1d9f1.jpg","comment_is_top":false,"comment_ctime":1620647310,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620647310","product_id":100020901,"comment_content":"é—®ä¸‹è€å¸ˆï¼Œåº”ç”¨ç¨‹åºå®‰è£…ç¬¦å·è¡¨ï¼Œæ˜¯éœ€è¦å¼€å¯â€“gé€‰é¡¹ç¼–è¯‘å—ï¼Œä¼šä¸ä¼šæœ¬èº«å½±å“ç¨‹åºçš„æ€§èƒ½ï¼Ÿ","like_count":0},{"had_liked":false,"id":235473,"user_name":"Michael","can_delete":false,"product_type":"c1","uid":1118976,"ip_address":"","ucode":"35F4FFAC4A4B15","user_header":"https://static001.geekbang.org/account/avatar/00/11/13/00/a4a2065f.jpg","comment_is_top":false,"comment_ctime":1595052329,"is_pvip":false,"replies":[{"id":"87266","content":"æ˜¯Ubuntuç³»ç»Ÿå—ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œå¯ä»¥å‚è€ƒå®ƒçš„å®˜æ–¹æ–‡æ¡£ https:&#47;&#47;wiki.ubuntu.com&#47;Debug%20Symbol%20Packages","user_name":"ä½œè€…å›å¤","comment_id":235473,"uid":"1001282","ip_address":"","utype":1,"ctime":1595343784,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1595052329","product_id":100020901,"comment_content":"è°ƒè¯•ç¬¦å·è¡¨å®‰è£…ä¸äº†<br><br>root@iZ94lcu45k0Z:~# apt-get install linux-image-`uname -r`-dbgsym<br>Reading package lists... Done<br>Building dependency tree<br>Reading state information... Done<br>E: Unable to locate package linux-image-4.15.0-72-generic-dbgsym<br>E: Couldn&#39;t find any package by glob &#39;linux-image-4.15.0-72-generic-dbgsym&#39;<br>E: Couldn&#39;t find any package by regex &#39;linux-image-4.15.0-72-generic-dbgsym&#39;","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501737,"discussion_content":"æ˜¯Ubuntuç³»ç»Ÿå—ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œå¯ä»¥å‚è€ƒå®ƒçš„å®˜æ–¹æ–‡æ¡£ https://wiki.ubuntu.com/Debug%20Symbol%20Packages","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595343784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223064,"user_name":"ä»˜é’±","can_delete":false,"product_type":"c1","uid":1050694,"ip_address":"","ucode":"DE8384795EE69D","user_header":"https://static001.geekbang.org/account/avatar/00/10/08/46/7103cbdc.jpg","comment_is_top":false,"comment_ctime":1590992919,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1590992919","product_id":100020901,"comment_content":"$ apt-get install linux-image-`uname -r`-dbgsym<br>è¿™ä¸ªå‘½ä»¤ä¹Ÿè¿è¡Œå¤±è´¥äº†ï¼Œæç¤ºæ‰¾ä¸åˆ°package","like_count":0,"discussions":[{"author":{"id":1487998,"avatar":"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqtXSgThiaEiaEqqic5YIJ7v469nCM3VXiccOJ4SxbYjW91ciczuYYEzcTVtYWaWXaokZqShuLdKsXjnFA/132","nickname":"Geek_b85295","note":"","ucode":"51CBB577C255EA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379620,"discussion_content":"è¦æŠŠæºåŠ è¿›å»ï¼Œå†update","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624016821,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":204977,"user_name":"å‡³å­","can_delete":false,"product_type":"c1","uid":1274869,"ip_address":"","ucode":"2A19894DF4E1F4","user_header":"https://static001.geekbang.org/account/avatar/00/13/73/f5/29138f17.jpg","comment_is_top":false,"comment_ctime":1586503300,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1586503300","product_id":100020901,"comment_content":"è€å¸ˆï¼Œæƒ³é—®ä¸‹ï¼Œåœ¨k8sä¸Šï¼Œå¦‚æœåœ¨ä¸€ä¸ªå®¹å™¨å†…ä½¿ç”¨eBPFè¿½è¸ªsyscallï¼Œæ˜¯ä¸æ˜¯ä¼šå½±å“å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰å®¹å™¨ï¼Ÿ","like_count":0},{"had_liked":false,"id":202204,"user_name":"linker","can_delete":false,"product_type":"c1","uid":1803259,"ip_address":"","ucode":"6C5799F2FC2C82","user_header":"https://static001.geekbang.org/account/avatar/00/1b/83/fb/621adceb.jpg","comment_is_top":false,"comment_ctime":1585923470,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1585923470","product_id":100020901,"comment_content":"ä¹‹å‰ä½¿ç”¨ftraceä¸trace-cmdå®šä½å¤šè°ƒåº¦å»¶è¿Ÿçš„é—®é¢˜ï¼Œæ‰“å°å‡ºçš„æŠ¥å‘Šæ¯”è¾ƒå¤šï¼Œè¿˜å¾—æ‰‹åŠ¨å†™è„šæœ¬åˆ†æé‚£ä¸ªå‡½æ•°å»¶è¿Ÿå¤§","like_count":0},{"had_liked":false,"id":191740,"user_name":"201200986","can_delete":false,"product_type":"c1","uid":1900861,"ip_address":"","ucode":"6042C42D1C904E","user_header":"","comment_is_top":false,"comment_ctime":1584793596,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584793596","product_id":100020901,"comment_content":"ebpfç›¸å…³çš„å†…å®¹æœ‰æ²¡æœ‰æ›´å¤šææ–™æ¨èå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":191292,"user_name":"è‘£çš‹","can_delete":false,"product_type":"c1","uid":1902756,"ip_address":"","ucode":"2F05C3DDBC18F7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJGMphabeneYRlxs1biaO9oKic6Dwgbe312561lE56V93uUHgXXAsGmK1pH18mvpElygoJh8SUtQPUA/132","comment_is_top":false,"comment_ctime":1584761215,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584761215","product_id":100020901,"comment_content":"æ‰“å¡","like_count":0},{"had_liked":false,"id":146649,"user_name":"Cloudfull","can_delete":false,"product_type":"c1","uid":1034811,"ip_address":"","ucode":"464E7B2F8DDC10","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ca/3b/6dd2b1e2.jpg","comment_is_top":false,"comment_ctime":1572592993,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1572592993","product_id":100020901,"comment_content":"è€å¸ˆ perf probe -a æ·»åŠ è‡ªå®šä¹‰æ¢é’ˆæ—¶  å¦‚ä½•æŸ¥çœ‹é‡Œé¢çš„ struct ç±»å‹çš„å˜é‡ï¼Ÿ","like_count":0},{"had_liked":false,"id":112678,"user_name":"lyonger","can_delete":false,"product_type":"c1","uid":1313840,"ip_address":"","ucode":"E89A75DADEA2A1","user_header":"https://static001.geekbang.org/account/avatar/00/14/0c/30/bb4bfe9d.jpg","comment_is_top":false,"comment_ctime":1562805866,"is_pvip":false,"replies":[{"id":"41994","content":"ğŸ‘","user_name":"ä½œè€…å›å¤","comment_id":112678,"uid":"1001282","ip_address":"","utype":1,"ctime":1563458533,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1562805866","product_id":100020901,"comment_content":"æˆ‘æ˜¨å¤©æŸ¥åˆ°äº†é—®é¢˜æ ¹æºï¼Œå‘ç°dockerå¯¹äºä½¿ç”¨å­˜å‚¨é©±åŠ¨æœ‰é€‰æ‹©æ¨èçš„è¯´æ˜ï¼Œé‚£ä¸ªé—®é¢˜æ˜¯å­˜å‚¨é©±åŠ¨é—®é¢˜å¯¼è‡´ï¼Œé€šè¿‡çƒ­ç‚¹å‡½æ•°å’Œè°ƒè¯•å‘ç°æ”¹æˆoverlay2åloopå†…æ ¸çº¿ç¨‹çš„ioå‡ ä¹æ²¡æœ‰äº†ã€‚ä¸šåŠ¡ä¹Ÿæ­£å¸¸äº†ã€‚ä½†æ˜¯é‚£2ä¸ªé—®é¢˜ï¼ŒæœŸå¾…è€å¸ˆæœ‰ç©ºåç»™äºˆè§£ç­”ï¼Œå¤šè°¢ã€‚","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":457852,"discussion_content":"ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1563458533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":93512,"user_name":"cuikt","can_delete":false,"product_type":"c1","uid":1242702,"ip_address":"","ucode":"9A1DB426CEFEEA","user_header":"https://static001.geekbang.org/account/avatar/00/12/f6/4e/0066303c.jpg","comment_is_top":false,"comment_ctime":1557483874,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557483874","product_id":100020901,"comment_content":"é«˜å¤§ä¸Šï¼Œå†…å®¹å¹²è´§å¤šå¤šã€‚","like_count":0},{"had_liked":false,"id":87596,"user_name":"å¦‚æœ","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1555639320,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555639320","product_id":100020901,"comment_content":"DAY51ï¼Œæ‰“å¡","like_count":0},{"had_liked":false,"id":80843,"user_name":"york","can_delete":false,"product_type":"c1","uid":1318852,"ip_address":"","ucode":"EE938B81A7FC04","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epGMibYc0m7cDHMsNRBUur2NPVnlBZFXoNjWomibfjnHeAO3XRt27VaH3WNtdUX11d3uIT1ZHWCxLeg/132","comment_is_top":false,"comment_ctime":1553741194,"is_pvip":false,"replies":[{"id":"29589","content":"è¦å®‰è£…debuginfoçš„ï¼Œå…ˆç½‘ç»œæœç´¢æŸ¥æŸ¥","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1554003607,"ip_address":"","comment_id":80843,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1553741194","product_id":100020901,"comment_content":"# perf probe -x &#47;bin&#47;bash -V readline<br>The &#47;bin&#47;bash file has no debug information.<br>Rebuild with -g, or install an appropriate debuginfo package.<br>  Error: Failed to show vars.<br><br>è¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444997,"discussion_content":"è¦å®‰è£…debuginfoçš„ï¼Œå…ˆç½‘ç»œæœç´¢æŸ¥æŸ¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554003607,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":80153,"user_name":"å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1553610111,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1553610111","product_id":100020901,"comment_content":"æŠ¥é“","like_count":0},{"had_liked":false,"id":79206,"user_name":"cliff(äº®å‰‘)","can_delete":false,"product_type":"c1","uid":1314866,"ip_address":"","ucode":"A8D1A92331AE20","user_header":"https://static001.geekbang.org/account/avatar/00/14/10/32/e37aacfe.jpg","comment_is_top":false,"comment_ctime":1553400892,"is_pvip":false,"replies":[{"id":"29056","content":"sorryï¼Œæ²¡æœ‰ã€‚è¿™äº›æ›´å¤šçš„ç”¨åœ¨è°ƒè¯•ç¨‹åºé”™è¯¯è€Œä¸æ˜¯æ€§èƒ½ä¼˜åŒ–ä¸­","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1553526849,"ip_address":"","comment_id":79206,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1553400892","product_id":100020901,"comment_content":"æœ‰æ²¡æœ‰è®²Linuxæ±‡ç¼–å’ŒGDBçš„ä¸€æœŸï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444397,"discussion_content":"sorryï¼Œæ²¡æœ‰ã€‚è¿™äº›æ›´å¤šçš„ç”¨åœ¨è°ƒè¯•ç¨‹åºé”™è¯¯è€Œä¸æ˜¯æ€§èƒ½ä¼˜åŒ–ä¸­","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553526849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":78908,"user_name":"ichen","can_delete":false,"product_type":"c1","uid":1156973,"ip_address":"","ucode":"2A931EBE9098D0","user_header":"https://static001.geekbang.org/account/avatar/00/11/a7/6d/19bff1f9.jpg","comment_is_top":false,"comment_ctime":1553287279,"is_pvip":false,"replies":[{"id":"28737","content":"å‡çº§ç‰ˆæœ¬è¯•è¯•ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"å€ªæœ‹é£","uid":"1001282","ctime":1553315804,"ip_address":"","comment_id":78908,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1553287279","product_id":100020901,"comment_content":"# perf probe<br>perf: &#39;probe&#39; is not a perf-command. See &#39;perf --help&#39;.","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444282,"discussion_content":"å‡çº§ç‰ˆæœ¬è¯•è¯•ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553315804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}