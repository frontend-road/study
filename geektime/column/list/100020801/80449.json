{"id":80449,"title":"36 | 为什么临时表可以重名？","content":"<p><span class=\"orange\">今天是大年三十，在开始我们今天的学习之前，我要先和你道一声春节快乐！</span></p><p>在上一篇文章中，我们在优化join查询的时候使用到了临时表。当时，我们是这么用的：</p><pre><code>create temporary table temp_t like t1;\nalter table temp_t add index(b);\ninsert into temp_t select * from t2 where b&gt;=1 and b&lt;=2000;\nselect * from t1 join temp_t on (t1.b=temp_t.b);\n</code></pre><p>你可能会有疑问，为什么要用临时表呢？直接用普通表是不是也可以呢？</p><p>今天我们就从这个问题说起：临时表有哪些特征，为什么它适合这个场景？</p><p>这里，我需要先帮你厘清一个容易误解的问题：有的人可能会认为，临时表就是内存表。但是，这两个概念可是完全不同的。</p><ul>\n<li>\n<p>内存表，指的是使用Memory引擎的表，建表语法是create table … engine=memory。这种表的数据都保存在内存里，系统重启的时候会被清空，但是表结构还在。除了这两个特性看上去比较“奇怪”外，从其他的特征上看，它就是一个正常的表。</p>\n</li>\n<li>\n<p>而临时表，可以使用各种引擎类型 。如果是使用InnoDB引擎或者MyISAM引擎的临时表，写数据的时候是写到磁盘上的。当然，临时表也可以使用Memory引擎。</p>\n</li>\n</ul><p>弄清楚了内存表和临时表的区别以后，我们再来看看临时表有哪些特征。</p><h1>临时表的特性</h1><p>为了便于理解，我们来看下下面这个操作序列：</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/e3/3cbb2843ef9a84ee582330fb1bd0d6e3.png?wh=934*631\" alt=\"\"></p><center><span class=\"reference\">图1 临时表特性示例</span></center><p>可以看到，临时表在使用上有以下几个特点：</p><ol>\n<li>\n<p>建表语法是create temporary table …。</p>\n</li>\n<li>\n<p>一个临时表只能被创建它的session访问，对其他线程不可见。所以，图中session A创建的临时表t，对于session B就是不可见的。</p>\n</li>\n<li>\n<p>临时表可以与普通表同名。</p>\n</li>\n<li>\n<p>session A内有同名的临时表和普通表的时候，show create语句，以及增删改查语句访问的是临时表。</p>\n</li>\n<li>\n<p>show tables命令不显示临时表。</p>\n</li>\n</ol><!-- [[[read_end]]] --><p>由于临时表只能被创建它的session访问，所以在这个session结束的时候，会自动删除临时表。也正是由于这个特性，<strong>临时表就特别适合我们文章开头的join优化这种场景</strong>。为什么呢？</p><p>原因主要包括以下两个方面：</p><ol>\n<li>\n<p>不同session的临时表是可以重名的，如果有多个session同时执行join优化，不需要担心表名重复导致建表失败的问题。</p>\n</li>\n<li>\n<p>不需要担心数据删除问题。如果使用普通表，在流程执行过程中客户端发生了异常断开，或者数据库发生异常重启，还需要专门来清理中间过程中生成的数据表。而临时表由于会自动回收，所以不需要这个额外的操作。</p>\n</li>\n</ol><h1>临时表的应用</h1><p>由于不用担心线程之间的重名冲突，临时表经常会被用在复杂查询的优化过程中。其中，分库分表系统的跨库查询就是一个典型的使用场景。</p><p>一般分库分表的场景，就是要把一个逻辑上的大表分散到不同的数据库实例上。比如。将一个大表ht，按照字段f，拆分成1024个分表，然后分布到32个数据库实例上。如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/dd/81/ddb9c43526dfd9b9a3e6f8c153478181.jpg?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图2 分库分表简图</span></center><p>一般情况下，这种分库分表系统都有一个中间层proxy。不过，也有一些方案会让客户端直接连接数据库，也就是没有proxy这一层。</p><p>在这个架构中，分区key的选择是以“减少跨库和跨表查询”为依据的。如果大部分的语句都会包含f的等值条件，那么就要用f做分区键。这样，在proxy这一层解析完SQL语句以后，就能确定将这条语句路由到哪个分表做查询。</p><p>比如下面这条语句：</p><pre><code>select v from ht where f=N;\n</code></pre><p>这时，我们就可以通过分表规则（比如，N%1024)来确认需要的数据被放在了哪个分表上。这种语句只需要访问一个分表，是分库分表方案最欢迎的语句形式了。</p><p>但是，如果这个表上还有另外一个索引k，并且查询语句是这样的：</p><pre><code>select v from ht where k &gt;= M order by t_modified desc limit 100;\n</code></pre><p>这时候，由于查询条件里面没有用到分区字段f，只能到所有的分区中去查找满足条件的所有行，然后统一做order by 的操作。这种情况下，有两种比较常用的思路。</p><p><strong>第一种思路是，</strong>在proxy层的进程代码中实现排序。</p><p>这种方式的优势是处理速度快，拿到分库的数据以后，直接在内存中参与计算。不过，这个方案的缺点也比较明显：</p><ol>\n<li>\n<p>需要的开发工作量比较大。我们举例的这条语句还算是比较简单的，如果涉及到复杂的操作，比如group by，甚至join这样的操作，对中间层的开发能力要求比较高；</p>\n</li>\n<li>\n<p>对proxy端的压力比较大，尤其是很容易出现内存不够用和CPU瓶颈的问题。</p>\n</li>\n</ol><p><strong>另一种思路就是，</strong>把各个分库拿到的数据，汇总到一个MySQL实例的一个表中，然后在这个汇总实例上做逻辑操作。</p><p>比如上面这条语句，执行流程可以类似这样：</p><ul>\n<li>在汇总库上创建一个临时表temp_ht，表里包含三个字段v、k、t_modified；</li>\n<li>在各个分库上执行</li>\n</ul><pre><code>select v,k,t_modified from ht_x where k &gt;= M order by t_modified desc limit 100;\n</code></pre><ul>\n<li>把分库执行的结果插入到temp_ht表中；</li>\n<li>执行</li>\n</ul><pre><code>select v from temp_ht order by t_modified desc limit 100; \n</code></pre><p>得到结果。</p><p>这个过程对应的流程图如下所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/f5/0d/f5ebe0f5af37deeb4d0b63d6fb11fc0d.jpg?wh=1142*880\" alt=\"\"></p><center><span class=\"reference\">图3 跨库查询流程示意图</span></center><p><strong>在实践中，我们往往会发现每个分库的计算量都不饱和，所以会直接把临时表temp_ht放到32个分库中的某一个上。</strong>这时的查询逻辑与图3类似，你可以自己再思考一下具体的流程。</p><h1>为什么临时表可以重名？</h1><p>你可能会问，不同线程可以创建同名的临时表，这是怎么做到的呢？</p><p>接下来，我们就看一下这个问题。</p><p>我们在执行</p><pre><code>create temporary table temp_t(id int primary key)engine=innodb;\n</code></pre><p>这个语句的时候，MySQL要给这个InnoDB表创建一个frm文件保存表结构定义，还要有地方保存表数据。</p><p><strong>这个frm文件放在临时文件目录下，文件名的后缀是.frm，前缀是“#sql{进程id}_{线程id}_序列号”</strong>。你可以使用select @@tmpdir命令，来显示实例的临时文件目录。</p><p>而关于表中数据的存放方式，在不同的MySQL版本中有着不同的处理方式：</p><ul>\n<li>在5.6以及之前的版本里，MySQL会在临时文件目录下创建一个相同前缀、以.ibd为后缀的文件，用来存放数据文件；</li>\n<li>而从 5.7版本开始，MySQL引入了一个临时文件表空间，专门用来存放临时文件的数据。因此，我们就不需要再创建ibd文件了。</li>\n</ul><p>从文件名的前缀规则，我们可以看到，其实创建一个叫作t1的InnoDB临时表，MySQL在存储上认为我们创建的表名跟普通表t1是不同的，因此同一个库下面已经有普通表t1的情况下，还是可以再创建一个临时表t1的。</p><p>为了便于后面讨论，我先来举一个例子。</p><p><img src=\"https://static001.geekbang.org/resource/image/22/1b/22078eab5c7688c9fbfd6185555bd91b.png?wh=930*261\" alt=\"\"></p><center><span class=\"reference\">图4 临时表的表名</span></center><p>这个进程的进程号是1234，session A的线程id是4，session B的线程id是5。所以你看到了，session A和session B创建的临时表，在磁盘上的文件不会重名。</p><p>MySQL维护数据表，除了物理上要有文件外，内存里面也有一套机制区别不同的表，每个表都对应一个table_def_key。</p><ul>\n<li>一个普通表的table_def_key的值是由“库名+表名”得到的，所以如果你要在同一个库下创建两个同名的普通表，创建第二个表的过程中就会发现table_def_key已经存在了。</li>\n<li>而对于临时表，table_def_key在“库名+表名”基础上，又加入了“server_id+thread_id”。</li>\n</ul><p>也就是说，session A和sessionB创建的两个临时表t1，它们的table_def_key不同，磁盘文件名也不同，因此可以并存。</p><p>在实现上，每个线程都维护了自己的临时表链表。这样每次session内操作表的时候，先遍历链表，检查是否有这个名字的临时表，如果有就优先操作临时表，如果没有再操作普通表；在session结束的时候，对链表里的每个临时表，执行 “DROP TEMPORARY TABLE +表名”操作。</p><p>这时候你会发现，binlog中也记录了DROP TEMPORARY TABLE这条命令。你一定会觉得奇怪，临时表只在线程内自己可以访问，为什么需要写到binlog里面？</p><p>这，就需要说到主备复制了。</p><h1>临时表和主备复制</h1><p>既然写binlog，就意味着备库需要。</p><p>你可以设想一下，在主库上执行下面这个语句序列：</p><pre><code>create table t_normal(id int primary key, c int)engine=innodb;/*Q1*/\ncreate temporary table temp_t like t_normal;/*Q2*/\ninsert into temp_t values(1,1);/*Q3*/\ninsert into t_normal select * from temp_t;/*Q4*/\n</code></pre><p>如果关于临时表的操作都不记录，那么在备库就只有create table t_normal表和insert into t_normal select * from temp_t这两个语句的binlog日志，备库在执行到insert into t_normal的时候，就会报错“表temp_t不存在”。</p><p>你可能会说，如果把binlog设置为row格式就好了吧？因为binlog是row格式时，在记录insert into t_normal的binlog时，记录的是这个操作的数据，即：write_row event里面记录的逻辑是“插入一行数据（1,1)”。</p><p>确实是这样。如果当前的binlog_format=row，那么跟临时表有关的语句，就不会记录到binlog里。也就是说，只在binlog_format=statment/mixed 的时候，binlog中才会记录临时表的操作。</p><p>这种情况下，创建临时表的语句会传到备库执行，因此备库的同步线程就会创建这个临时表。主库在线程退出的时候，会自动删除临时表，但是备库同步线程是持续在运行的。所以，这时候我们就需要在主库上再写一个DROP TEMPORARY TABLE传给备库执行。</p><p><strong>之前有人问过我一个有趣的问题：</strong>MySQL在记录binlog的时候，不论是create table还是alter table语句，都是原样记录，甚至于连空格都不变。但是如果执行drop table t_normal，系统记录binlog就会写成：</p><pre><code>DROP TABLE `t_normal` /* generated by server */\n</code></pre><p>也就是改成了标准的格式。为什么要这么做呢 ？</p><p>现在你知道原因了，那就是：drop table命令是可以一次删除多个表的。比如，在上面的例子中，设置binlog_format=row，如果主库上执行 \"drop table t_normal, temp_t\"这个命令，那么binlog中就只能记录：</p><pre><code>DROP TABLE `t_normal` /* generated by server */\n</code></pre><p>因为备库上并没有表temp_t，将这个命令重写后再传到备库执行，才不会导致备库同步线程停止。</p><p>所以，drop table命令记录binlog的时候，就必须对语句做改写。“/* generated by server */”说明了这是一个被服务端改写过的命令。</p><p>说到主备复制，<strong>还有另外一个问题需要解决</strong>：主库上不同的线程创建同名的临时表是没关系的，但是传到备库执行是怎么处理的呢？</p><p>现在，我给你举个例子，下面的序列中实例S是M的备库。</p><p><img src=\"https://static001.geekbang.org/resource/image/74/ba/74e789024f10bcde515f21c0368847ba.png?wh=935*293\" alt=\"\"></p><center><span class=\"reference\">图5 主备关系中的临时表操作</span></center><p>主库M上的两个session创建了同名的临时表t1，这两个create temporary table t1 语句都会被传到备库S上。</p><p>但是，备库的应用日志线程是共用的，也就是说要在应用线程里面先后执行这个create 语句两次。（即使开了多线程复制，也可能被分配到从库的同一个worker中执行）。那么，这会不会导致同步线程报错 ？</p><p>显然是不会的，否则临时表就是一个bug了。也就是说，备库线程在执行的时候，要把这两个t1表当做两个不同的临时表来处理。这，又是怎么实现的呢？</p><p>MySQL在记录binlog的时候，会把主库执行这个语句的线程id写到binlog中。这样，在备库的应用线程就能够知道执行每个语句的主库线程id，并利用这个线程id来构造临时表的table_def_key：</p><ol>\n<li>\n<p>session A的临时表t1，在备库的table_def_key就是：库名+t1+“M的serverid”+“session A的thread_id”;</p>\n</li>\n<li>\n<p>session B的临时表t1，在备库的table_def_key就是 ：库名+t1+“M的serverid”+“session B的thread_id”。</p>\n</li>\n</ol><p>由于table_def_key不同，所以这两个表在备库的应用线程里面是不会冲突的。</p><h1>小结</h1><p>今天这篇文章，我和你介绍了临时表的用法和特性。</p><p>在实际应用中，临时表一般用于处理比较复杂的计算逻辑。由于临时表是每个线程自己可见的，所以不需要考虑多个线程执行同一个处理逻辑时，临时表的重名问题。在线程退出的时候，临时表也能自动删除，省去了收尾和异常处理的工作。</p><p>在binlog_format='row’的时候，临时表的操作不记录到binlog中，也省去了不少麻烦，这也可以成为你选择binlog_format时的一个考虑因素。</p><p>需要注意的是，我们上面说到的这种临时表，是用户自己创建的 ，也可以称为用户临时表。与它相对应的，就是内部临时表，在<a href=\"https://time.geekbang.org/column/article/73795\">第17篇文章</a>中我已经和你介绍过。</p><p>最后，我给你留下一个思考题吧。</p><p>下面的语句序列是创建一个临时表，并将其改名：</p><p><img src=\"https://static001.geekbang.org/resource/image/33/f9/333ad95b2ce16de1931fe347128caff9.png?wh=1087*214\" alt=\"\"></p><center><span class=\"reference\">图6 关于临时表改名的思考题</span></center><p>可以看到，我们可以使用alter table语法修改临时表的表名，而不能使用rename语法。你知道这是什么原因吗？</p><p>你可以把你的分析写在留言区，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>上期的问题是，对于下面这个三个表的join语句，</p><pre><code>select * from t1 join t2 on(t1.a=t2.a) join t3 on (t2.b=t3.b) where t1.c&gt;=X and t2.c&gt;=Y and t3.c&gt;=Z;\n</code></pre><p>如果改写成straight_join，要怎么指定连接顺序，以及怎么给三个表创建索引。</p><p>第一原则是要尽量使用BKA算法。需要注意的是，使用BKA算法的时候，并不是“先计算两个表join的结果，再跟第三个表join”，而是直接嵌套查询的。</p><p>具体实现是：在t1.c&gt;=X、t2.c&gt;=Y、t3.c&gt;=Z这三个条件里，选择一个经过过滤以后，数据最少的那个表，作为第一个驱动表。此时，可能会出现如下两种情况。</p><p>第一种情况，如果选出来是表t1或者t3，那剩下的部分就固定了。</p><ol>\n<li>\n<p>如果驱动表是t1，则连接顺序是t1-&gt;t2-&gt;t3，要在被驱动表字段创建上索引，也就是t2.a 和 t3.b上创建索引；</p>\n</li>\n<li>\n<p>如果驱动表是t3，则连接顺序是t3-&gt;t2-&gt;t1，需要在t2.b 和 t1.a上创建索引。</p>\n</li>\n</ol><p>同时，我们还需要在第一个驱动表的字段c上创建索引。</p><p>第二种情况是，如果选出来的第一个驱动表是表t2的话，则需要评估另外两个条件的过滤效果。</p><p>总之，整体的思路就是，尽量让每一次参与join的驱动表的数据集，越小越好，因为这样我们的驱动表就会越小。</p><p>评论区留言点赞板：</p><blockquote>\n<p>@库淘淘 做了实验验证；<br>\n@poppy同学做了很不错的分析；<br>\n@dzkk 同学在评论中介绍了MariaDB支持的hash join，大家可以了解一下；<br>\n@老杨同志提了一个好问题，如果语句使用了索引a，结果还要对a排序，就不用MRR优化了，否则回表完还要增加额外的排序过程，得不偿失。</p>\n</blockquote><p></p>","comments":[{"had_liked":false,"id":65599,"user_name":"辣椒","can_delete":false,"product_type":"c1","uid":1330376,"ip_address":"","ucode":"85C62DE976C6A5","user_header":"https://static001.geekbang.org/account/avatar/00/14/4c/c8/bed1e08a.jpg","comment_is_top":false,"comment_ctime":1549494444,"is_pvip":false,"replies":[{"id":"23225","content":"会，“临时表会自动回收”这个功能，主要用于“应用程序异常断开、MySQL异常重启”后，不需要主动去删除表。<br><br>而平时正常使用的时候，用完删除，还是应该有的好习惯。😆<br><br>好问题，新年快乐~","user_name":"作者回复","comment_id":65599,"uid":"1264162","ip_address":"","utype":1,"ctime":1549502884,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"804708378796","product_id":100020801,"comment_content":"老师，不同线程可以使用同名的临时表，这个没有问题。但是如果在程序中，用的是连接池中的连接来操作的，而这些连接不会释放，和数据库保持长连接。这样使用临时表会有问题吗?。","like_count":188,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438513,"discussion_content":"会，“临时表会自动回收”这个功能，主要用于“应用程序异常断开、MySQL异常重启”后，不需要主动去删除表。\n\n而平时正常使用的时候，用完删除，还是应该有的好习惯。😆\n\n好问题，新年快乐~","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1549502884,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1466840,"avatar":"https://static001.geekbang.org/account/avatar/00/16/61/d8/3bc19bff.jpg","nickname":"恋在那时","note":"","ucode":"7F026B4B708C7D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":555771,"discussion_content":"在我还没有读完的时候，我就想问我们平时使用的都是数据库连接池，不会断开连接，会复用连接，文中说的是线程断开连接的时候会自动删除这个临时表，那么使用临时表，不手动删除会不会有问题？问出我的心声，点赞。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647071194,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1227366,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ba/66/7d9f45e7.jpg","nickname":"太空牛仔","note":"","ucode":"0205635C3854AF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543934,"discussion_content":"使用 mysql_reset_conection 重置连接资源","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641357056,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65378,"user_name":"老杨同志","can_delete":false,"product_type":"c1","uid":1246199,"ip_address":"","ucode":"3F334F0CFD3DE6","user_header":"https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg","comment_is_top":false,"comment_ctime":1549295703,"is_pvip":false,"replies":[{"id":"23203","content":"新年好！<br><br>“insert into  select语句好像会给select的表加锁，如果没有索引，就锁全表”，是的。<br><br>这类最好不要很大胆😆，如果不是业务急需的，从源表导出来再写到目标表也是好的。<br><br> 后面第40篇会说到哈。<br><br>","user_name":"作者回复","comment_id":65378,"uid":"1264162","ip_address":"","utype":1,"ctime":1549338757,"user_name_real":"林晓斌"}],"discussion_count":4,"race_medal":0,"score":"233477529687","product_id":100020801,"comment_content":"新年快乐，老师好勤奋！<br>有个问题，insert into  select语句好像会给select的表加锁，如果没有索引，就锁全表，是不是这样？什么时候可以大胆的用这类语句？","like_count":55,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438431,"discussion_content":"新年好！\n\n“insert into  select语句好像会给select的表加锁，如果没有索引，就锁全表”，是的。\n\n这类最好不要很大胆😆，如果不是业务急需的，从源表导出来再写到目标表也是好的。\n\n 后面第40篇会说到哈。\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1549338757,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1227366,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ba/66/7d9f45e7.jpg","nickname":"太空牛仔","note":"","ucode":"0205635C3854AF","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543936,"discussion_content":"如果innodb_auto_lock_mode=2   bbinlog_format=row也会锁表吗？我感觉这样就不会锁表了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1641357276,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2355521,"avatar":"https://static001.geekbang.org/account/avatar/00/23/f1/41/76c0758f.jpg","nickname":"君战","note":"","ucode":"A8619A79A5CED9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367225,"discussion_content":"我有个大胆的想法","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618300288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2252648,"avatar":"https://static001.geekbang.org/account/avatar/00/22/5f/68/8e4407c7.jpg","nickname":"💡","note":"","ucode":"8AB762A8CDFEF7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2355521,"avatar":"https://static001.geekbang.org/account/avatar/00/23/f1/41/76c0758f.jpg","nickname":"君战","note":"","ucode":"A8619A79A5CED9","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390971,"discussion_content":"开除！","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1630205711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":367225,"ip_address":""},"score":390971,"extra":""}]}]},{"had_liked":false,"id":70585,"user_name":"天王","can_delete":false,"product_type":"c1","uid":1239337,"ip_address":"","ucode":"C074B2F9A5F007","user_header":"https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg","comment_is_top":false,"comment_ctime":1551143792,"is_pvip":false,"replies":[{"id":"25187","content":"👍","user_name":"作者回复","comment_id":70585,"uid":"1264162","ip_address":"","utype":1,"ctime":1551145215,"user_name_real":"林晓斌"}],"discussion_count":3,"race_medal":0,"score":"220594475888","product_id":100020801,"comment_content":"临时表建表语法create temporary table ，和普通的表不一样，和内存表也不一样。内存表数据保存到内存里，重启会丢失，临时表会写入到磁盘。临时表只对自己的session中可见，session结束后自动删除表结构和表数据。适用场景是分库分表，查询到的数据在临时表中做聚合。临时表可以重名，实际的存储文件名有线程id，在内存中表的命名有table_ref_key，是由库名加表名加serverid+线程id组成。bin log设置为row模式，临时表不会同步到备库中，设置为statement模式，会同步到备库中。","like_count":52,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":440710,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1551145215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1988150,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/56/36/91f69881.jpg","nickname":"JackieDeng","note":"","ucode":"6FFC39F9B482AE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":343771,"discussion_content":"大佬，我这个小白都能看懂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611153811,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":282441,"discussion_content":"总结的不错","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591972545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65337,"user_name":"poppy","can_delete":false,"product_type":"c1","uid":1182792,"ip_address":"","ucode":"2ED2BDF703D0D9","user_header":"https://static001.geekbang.org/account/avatar/00/12/0c/48/ba59d28d.jpg","comment_is_top":false,"comment_ctime":1549249522,"is_pvip":false,"replies":[{"id":"23181","content":"春节快乐<br><br>👍<br>","user_name":"作者回复","comment_id":65337,"uid":"1264162","ip_address":"","utype":1,"ctime":1549270183,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"151873104882","product_id":100020801,"comment_content":"老师，新年快乐。<br>关于思考题，alter table temp_t rename to temp_t2,我的理解是mysql直接修改的是table_def_key，而对于rename table temp_t2 to temp_t3,mysql直接去mysql的data目录下该数据库的目录(例如老师实验用的应该是test数据库，所以对应的是test目录)下寻找名为temp_t2.frm的文件去修改名称，所以就出现了&quot;Can&#39;t find file &#39;.&#47;test&#47;temp_t2.frm&#39;(errno: 2 - No such file or directory)","like_count":36,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438412,"discussion_content":"春节快乐\n\n👍\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549270183,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":218244,"user_name":"Carisy","can_delete":false,"product_type":"c1","uid":1657429,"ip_address":"","ucode":"67E887967347BA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLwTZdUafC5YM7bCASt8icUnoyYfV4hUHulexibDI7B4eaokTxYXHFtoic97DBlCAU9j5Jw4QUuGhyZQ/132","comment_is_top":false,"comment_ctime":1589764586,"is_pvip":false,"replies":[{"id":"80727","content":"是的，所以一般一个事务创建临时表以后，读写分离就会默认接下来的请求都路由到主库去了","user_name":"作者回复","comment_id":218244,"uid":"1264162","ip_address":"","utype":1,"ctime":1589773780,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"134733750762","product_id":100020801,"comment_content":"老师有个问题，如果说创建临时表在主库，查询的时候打到从库上，查询是不是就有问题了，查询主库的线程id跟从库不一致","like_count":32,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495400,"discussion_content":"是的，所以一般一个事务创建临时表以后，读写分离就会默认接下来的请求都路由到主库去了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589773780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":67290,"user_name":"Ryoma","can_delete":false,"product_type":"c1","uid":1130590,"ip_address":"","ucode":"7F692369239692","user_header":"https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg","comment_is_top":false,"comment_ctime":1550124730,"is_pvip":true,"discussion_count":0,"race_medal":2,"score":"134694110906","product_id":100020801,"comment_content":"贴一下官方文档中的说明：To rename TEMPORARY tables, RENAME TABLE does not work. Use ALTER TABLE instead.<br>全文见：https:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;8.0&#47;en&#47;rename-table.html<br><br>","like_count":32},{"had_liked":false,"id":66446,"user_name":"鸠翱","can_delete":false,"product_type":"c1","uid":1116568,"ip_address":"","ucode":"7D498AF2BC4289","user_header":"https://static001.geekbang.org/account/avatar/00/11/09/98/b11c372b.jpg","comment_is_top":false,"comment_ctime":1549940574,"is_pvip":false,"replies":[{"id":"23576","content":"是这样的，要看连接池怎么实现。<br><br>如果A客户端在执行过程中创建了临时表，用完了连接就放回池子里面，没有做别的清理工作，然后新的客户端B复用这个连接，就可能会看到A的临时表","user_name":"作者回复","comment_id":66446,"uid":"1264162","ip_address":"","utype":1,"ctime":1549978107,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"87449286494","product_id":100020801,"comment_content":"放假结束该补课了😅<br><br>评论区有个回答说到了连接池的问题问到会不会有问题……而老师您回答的是会有问题 可是临时表在session结束后不就删除了嘛 那么即使是用同一个线程又有什么问题呢？","like_count":20,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438803,"discussion_content":"是这样的，要看连接池怎么实现。\n\n如果A客户端在执行过程中创建了临时表，用完了连接就放回池子里面，没有做别的清理工作，然后新的客户端B复用这个连接，就可能会看到A的临时表","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549978107,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1644104,"avatar":"https://static001.geekbang.org/account/avatar/00/19/16/48/09493874.jpg","nickname":"茶没喝完","note":"","ucode":"D72D88C42A1258","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":347922,"discussion_content":"最好是用完主动删除临时表","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612365529,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65324,"user_name":"亮","can_delete":false,"product_type":"c1","uid":1086346,"ip_address":"","ucode":"5B8E59AEA6E3F2","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/8a/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1549244853,"is_pvip":false,"replies":[{"id":"23182","content":"用户没有显示指定主键的话，InnoDB引擎会自己创建一个隐藏的主键，但是这个主键对Server层是透明的，优化器用不上。<br><br>新年快乐~","user_name":"作者回复","comment_id":65324,"uid":"1264162","ip_address":"","utype":1,"ctime":1549270333,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"78858656181","product_id":100020801,"comment_content":"老师您好，在25课里面的置顶留言“6.表上无主键的情况(主库利用索引更改数据,备库回放只能用全表扫描,这种情况可以调整slave_rows_search_algorithms参数适当优化下)”<br>为啥会存在无主键的表呢，就算dba没创建主键，Innodb可以用rowid给自动建一个虚拟主键呀，这样不就是所有的表都有主键了吗？","like_count":19,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438407,"discussion_content":"用户没有显示指定主键的话，InnoDB引擎会自己创建一个隐藏的主键，但是这个主键对Server层是透明的，优化器用不上。\n\n新年快乐~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549270333,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66055,"user_name":"undifined","can_delete":false,"product_type":"c1","uid":1068920,"ip_address":"","ucode":"449CB4CD2DC089","user_header":"https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg","comment_is_top":false,"comment_ctime":1549864714,"is_pvip":false,"replies":[{"id":"23400","content":"1. 好问题，重启以后MySQL会扫描临时目录，把表都删掉；<br>2. 就是我们文中说的，如果binlog是statement的时候，也需要同步到备库去，否则备库上执行一个<br>insert into t_normal (select * from t_temp) 就会报错了","user_name":"作者回复","comment_id":66055,"uid":"1264162","ip_address":"","utype":1,"ctime":1549873483,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"53089472266","product_id":100020801,"comment_content":"老师 有几个问题<br>1. 在 session 结束的时候会执行 DROP TEMPORARY TABLE，如果数据库掉电，这个临时表什么时候会被清除<br>2. 如果binlog 中记录了临时表的操作，因为 session 不同，在从库中访问不到，这样做的意义是什么<br><br>辛苦老师解答一下，谢谢老师","like_count":12,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438689,"discussion_content":"1. 好问题，重启以后MySQL会扫描临时目录，把表都删掉；\n2. 就是我们文中说的，如果binlog是statement的时候，也需要同步到备库去，否则备库上执行一个\ninsert into t_normal (select * from t_temp) 就会报错了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549873483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2172435,"avatar":"https://static001.geekbang.org/account/avatar/00/21/26/13/0319db8a.jpg","nickname":"Allen","note":"","ucode":"AFDFD3036A8779","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":379480,"discussion_content":"备库的同步线程可以用到啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623922451,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66052,"user_name":"布衣骇客","can_delete":false,"product_type":"c1","uid":1256280,"ip_address":"","ucode":"5226B0F67090D1","user_header":"https://static001.geekbang.org/account/avatar/00/13/2b/58/11c05ccb.jpg","comment_is_top":false,"comment_ctime":1549864079,"is_pvip":false,"replies":[{"id":"23396","content":"新年快乐，加油💪","user_name":"作者回复","comment_id":66052,"uid":"1264162","ip_address":"","utype":1,"ctime":1549872896,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"27319667855","product_id":100020801,"comment_content":"错过得还是得补上，新得一年，新的开始，加油","like_count":6,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438688,"discussion_content":"新年快乐，加油💪","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549872896,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65314,"user_name":"亮","can_delete":false,"product_type":"c1","uid":1086346,"ip_address":"","ucode":"5B8E59AEA6E3F2","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/8a/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1549241515,"is_pvip":false,"replies":[{"id":"23175","content":"新年快乐，共同进步😄","user_name":"作者回复","comment_id":65314,"uid":"1264162","ip_address":"","utype":1,"ctime":1549258835,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"23024077995","product_id":100020801,"comment_content":"老师过年好呀，祝您猪年大吉，财源广进；老师咱们这个课结束后，再开一期好不好啊，没学够啊，这是我的新年愿望哦","like_count":5,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438400,"discussion_content":"新年快乐，共同进步😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549258835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84840,"user_name":"砖瓦工","can_delete":false,"product_type":"c1","uid":1021194,"ip_address":"","ucode":"A0AAF93973D6A8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/95/0a/817c4356.jpg","comment_is_top":false,"comment_ctime":1554925727,"is_pvip":false,"replies":[{"id":"30745","content":"🤝  加油","user_name":"作者回复","comment_id":84840,"uid":"1264162","ip_address":"","utype":1,"ctime":1555146575,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"18734794911","product_id":100020801,"comment_content":"一点一点刷新着我对mysql的认识，真心谢谢老师！期待老师有更加多的课程！祝福老师！","like_count":4,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":446466,"discussion_content":"🤝  加油","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1555146575,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65343,"user_name":"某、人","can_delete":false,"product_type":"c1","uid":1308784,"ip_address":"","ucode":"ADB42AA12A11C1","user_header":"https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg","comment_is_top":false,"comment_ctime":1549260255,"is_pvip":false,"replies":[{"id":"23180","content":"春节快乐 新年身体健康哈","user_name":"作者回复","comment_id":65343,"uid":"1264162","ip_address":"","utype":1,"ctime":1549270110,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"14434162143","product_id":100020801,"comment_content":"老师，新年快乐。由于自身原因，错过几期精彩的内容，年后上班以后在好好补补。","like_count":3,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438416,"discussion_content":"春节快乐 新年身体健康哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549270110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":172549,"user_name":"没有昵称","can_delete":false,"product_type":"c1","uid":1763208,"ip_address":"","ucode":"565783BDD01CE4","user_header":"https://static001.geekbang.org/account/avatar/00/1a/e7/88/c8b4ad9c.jpg","comment_is_top":false,"comment_ctime":1579222506,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5874189802","product_id":100020801,"comment_content":"老师，备库的线程id和主库应该是不同的吧，这样怎么保证主库创建的临时表备库上可以访问？","like_count":1,"discussions":[{"author":{"id":1788647,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/4a/e7/6c16af5d.jpg","nickname":"汉江","note":"","ucode":"01622D984B8F9B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":360178,"discussion_content":"备库访问不了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616383144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1649662,"avatar":"https://static001.geekbang.org/account/avatar/00/19/2b/fe/7925eb7e.jpg","nickname":"pdf","note":"","ucode":"A44250955878BB","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":338155,"discussion_content":"写binlog的时候  把主库的线程ID写上了   ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609204587,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":84666,"user_name":"唯她命","can_delete":false,"product_type":"c1","uid":1240398,"ip_address":"","ucode":"8F687E8D306840","user_header":"https://static001.geekbang.org/account/avatar/00/12/ed/4e/ef406442.jpg","comment_is_top":false,"comment_ctime":1554891855,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5849859151","product_id":100020801,"comment_content":"老师 为什么过滤了条件之后，选择了t1或者t3,剩下的就固定了呢？选择了t2就需要重新评估t1和t3呢？不明白","like_count":1,"discussions":[{"author":{"id":1997293,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/79/ed/4737a49b.jpg","nickname":"雪の雫·雨の音","note":"","ucode":"0693DA3939A321","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":272768,"discussion_content":"不知道这么理解对不对：如果选择了t2作为驱动表，那么剩下的t1和t3就是被驱动表，但是t1和t3被驱动的先后顺序不一样最终是会影响性能的，这个影响跟t1和t3的过滤条件有关系","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590338569,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1371095,"avatar":"https://static001.geekbang.org/account/avatar/00/14/eb/d7/712912a7.jpg","nickname":"mumu","note":"","ucode":"E409BDA36091A3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":42413,"discussion_content":"t1和t3 没有连接","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572667200,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":83376,"user_name":"土门一哥","can_delete":false,"product_type":"c1","uid":1155883,"ip_address":"","ucode":"0F1EBE439E10F3","user_header":"","comment_is_top":false,"comment_ctime":1554549301,"is_pvip":false,"replies":[{"id":"30149","content":"😆加油","user_name":"作者回复","comment_id":83376,"uid":"1264162","ip_address":"","utype":1,"ctime":1554608558,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"5849516597","product_id":100020801,"comment_content":"又要去学习分库分表了，学老师的一节课程从来都不止学一节课……","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445998,"discussion_content":"😆加油","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554608558,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66909,"user_name":"夜空中最亮的星","can_delete":false,"product_type":"c1","uid":1267566,"ip_address":"","ucode":"ADC3E7B6789955","user_header":"https://static001.geekbang.org/account/avatar/00/13/57/6e/b6795c44.jpg","comment_is_top":false,"comment_ctime":1550040055,"is_pvip":false,"replies":[{"id":"23673","content":"新年快乐","user_name":"作者回复","comment_id":66909,"uid":"1264162","ip_address":"","utype":1,"ctime":1550047779,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"5845007351","product_id":100020801,"comment_content":"过年的时候课程落下了，给老师拜个年。","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438971,"discussion_content":"新年快乐","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1550047779,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":66089,"user_name":"☞","can_delete":false,"product_type":"c1","uid":1302793,"ip_address":"","ucode":"6FAEF05F234D2A","user_header":"https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg","comment_is_top":false,"comment_ctime":1549875707,"is_pvip":false,"replies":[{"id":"23415","content":"正常create 语句也会记录的。<br><br>还有，因为drop 语句里面因为有TEMPORARY，所以拿到备库执行，即使备库没这个临时表，也没关系。","user_name":"作者回复","comment_id":66089,"uid":"1264162","ip_address":"","utype":1,"ctime":1549880001,"user_name_real":"林晓斌"}],"discussion_count":2,"race_medal":0,"score":"5844843003","product_id":100020801,"comment_content":"老师新年好：<br>        请问老师一下我做的实验，主从情况下，binlog为row模式的时候，退出线程从主库的binlog中关于临时表只找到了DROP &#47;*!40005 TEMPORARY *&#47; TABLE IF EXISTS `temp_t`，没有找到create相关的信息，从库是怎么应用这部分create的呢，而且关于drop操作那里也提到了从库没有这个临时表，是不是有所冲突啊","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438698,"discussion_content":"正常create 语句也会记录的。\n\n还有，因为drop 语句里面因为有TEMPORARY，所以拿到备库执行，即使备库没这个临时表，也没关系。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549880001,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2076283,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/ae/7b/47200692.jpg","nickname":"贺子","note":"","ucode":"A64DC9D9CF7CCD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370943,"discussion_content":"row格式不是不记录binlog吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1619588348,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65377,"user_name":"慕塔","can_delete":false,"product_type":"c1","uid":1302106,"ip_address":"","ucode":"5C6C668C1106A5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/A94RKUfWfwzRzb68T9xskctQ43TBgXSBIL78p0N0ria2tQxmsTTJebYmefhkbHK7zwpoxokxs43UxpgDTdwm5tg/132","comment_is_top":false,"comment_ctime":1549295659,"is_pvip":false,"replies":[{"id":"23202","content":"新年快乐、共同进步🤝<br><br>好勤奋呀😆","user_name":"作者回复","comment_id":65377,"uid":"1264162","ip_address":"","utype":1,"ctime":1549332804,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"5844262955","product_id":100020801,"comment_content":"打卡 新年快乐😲😲😲","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438430,"discussion_content":"新年快乐、共同进步🤝\n\n好勤奋呀😆","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549332804,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65363,"user_name":"cheriston","can_delete":false,"product_type":"c1","uid":1309984,"ip_address":"","ucode":"617CBFCE0925C4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fd/20/2761ef0e.jpg","comment_is_top":false,"comment_ctime":1549282925,"is_pvip":false,"replies":[{"id":"23197","content":"同祝新年好，共同进步😄","user_name":"作者回复","comment_id":65363,"uid":"1264162","ip_address":"","utype":1,"ctime":1549299312,"user_name_real":"林晓斌"}],"discussion_count":1,"race_medal":0,"score":"5844250221","product_id":100020801,"comment_content":"老师辛苦了，大年三十还给我们分享技术，老师新年好🎉.","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438423,"discussion_content":"同祝新年好，共同进步😄","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549299312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65360,"user_name":"长杰","can_delete":false,"product_type":"c1","uid":1312212,"ip_address":"","ucode":"DD52C9494005F7","user_header":"https://static001.geekbang.org/account/avatar/00/14/05/d4/e06bf86d.jpg","comment_is_top":false,"comment_ctime":1549282251,"is_pvip":false,"replies":[{"id":"23196","content":"新春快乐～","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549299288,"ip_address":"","comment_id":65360,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5844249547","product_id":100020801,"comment_content":"老师，新年快乐，万事如意！","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438421,"discussion_content":"新春快乐～","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549299288,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65346,"user_name":"杰","can_delete":false,"product_type":"c1","uid":1336109,"ip_address":"","ucode":"9947A0B159727A","user_header":"https://static001.geekbang.org/account/avatar/00/14/63/2d/80427196.jpg","comment_is_top":false,"comment_ctime":1549262724,"is_pvip":false,"replies":[{"id":"23179","content":"新年快乐 工作顺利~","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549270094,"ip_address":"","comment_id":65346,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5844230020","product_id":100020801,"comment_content":"丁大大新春快乐","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438417,"discussion_content":"新年快乐 工作顺利~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549270094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":65320,"user_name":"尘封","can_delete":false,"product_type":"c1","uid":1247006,"ip_address":"","ucode":"CEE0C006387A03","user_header":"https://static001.geekbang.org/account/avatar/00/13/07/1e/bdbe93f4.jpg","comment_is_top":false,"comment_ctime":1549241964,"is_pvip":false,"replies":[{"id":"23174","content":"新年快乐🤝","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1549258803,"ip_address":"","comment_id":65320,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5844209260","product_id":100020801,"comment_content":"新年快乐","like_count":1,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":438405,"discussion_content":"新年快乐🤝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1549258803,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":344467,"user_name":"核桃","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1651571666,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1651571666","product_id":100020801,"comment_content":"关于binlog格式为row不记录临时表操作这个，我查了一下，现在有不一样的，如果是基于gtid的话，那么主从是会记录的.<br><br>https:&#47;&#47;dev.mysql.com&#47;blog-archive&#47;temporary-tables-are-now-allowed-in-transactions-when-gtids-are-enabled&#47;","like_count":0},{"had_liked":false,"id":304372,"user_name":"一步","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1627375633,"is_pvip":true,"discussion_count":1,"race_medal":1,"score":"1627375633","product_id":100020801,"comment_content":"对于思考题，我为什么都可以执行成功的？<br><br>alter table temp_t rename to temp_2;<br>rename table temp_2 to temp_3;","like_count":0,"discussions":[{"author":{"id":1657561,"avatar":"https://static001.geekbang.org/account/avatar/00/19/4a/d9/b8046b4b.jpg","nickname":"zhangm365","note":"","ucode":"60E7DEFB3F5840","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387262,"discussion_content":"你有个普通表吧，rename 修改的普通表。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628075623,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290488,"user_name":"贺子","can_delete":false,"product_type":"c1","uid":2076283,"ip_address":"","ucode":"A64DC9D9CF7CCD","user_header":"https://static001.geekbang.org/account/avatar/00/1f/ae/7b/47200692.jpg","comment_is_top":false,"comment_ctime":1619587815,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1619587815","product_id":100020801,"comment_content":"这种情况下，创建临时表的语句会传到备库执行，因此备库的同步线程就会创建这个临时表。主库在线程退出的时候，会自动删除临时表，但是备库同步线程是持续在运行的。所以，这时候我们就需要在主库上再写一个 DROP TEMPORARY TABLE 传给备库执行。<br>您好老师，这里有点疑问，row格式不记binlog那么也就不会同步到从库，所以不需要考虑DROP TEMPORARY TABLE，如果是statement或者mix格式那么就会记录binlog，自然也会记录drop，那么您怎么说还要再主库上写一个 DROP TEMPORARY TABLE 传给备库执行？为什么呢？","like_count":0},{"had_liked":false,"id":287144,"user_name":"Z","can_delete":false,"product_type":"c1","uid":1588016,"ip_address":"","ucode":"13BB106EABA035","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIz50ciaONXadCquPf8WDzKzyMYMeDSChgZcMR605sMfSibdw1vXbXvpAFkQxW70GkRtDqFu9lwPlFg/132","comment_is_top":false,"comment_ctime":1617793925,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1617793925","product_id":100020801,"comment_content":"关于分库分表使用临时表优化的点有些疑惑，已经在所有分区进行了扫描，为何不直接拿到数据，而是要放到临时表中再查一遍临时表呢","like_count":0,"discussions":[{"author":{"id":1385204,"avatar":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","nickname":"核桃","note":"","ucode":"7AB05270CBCCCB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":569842,"discussion_content":"需要有个地方合并数据过滤啊，就类似mapreduce的过程那样.","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651570870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286383,"user_name":"帝江","can_delete":false,"product_type":"c1","uid":1590610,"ip_address":"","ucode":"93CBA4E4D05DA5","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/B9vSOjMc2a86kYA8R5yDkVdFiaj2JeBZ1PuI9oUKhbnvuZwuibdUam6FTcGzDaiaFdk2GWJveUGhfCVpv4KaOdicoQ/132","comment_is_top":false,"comment_ctime":1617275595,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1617275595","product_id":100020801,"comment_content":"session结束会自动删除临时表.长连接会不会有影响?不理解长连接.尤其是在有proxy层的时候.","like_count":0},{"had_liked":false,"id":279179,"user_name":"uking","can_delete":false,"product_type":"c1","uid":1522824,"ip_address":"","ucode":"41005AC547327B","user_header":"https://static001.geekbang.org/account/avatar/00/17/3c/88/e83528da.jpg","comment_is_top":false,"comment_ctime":1613645634,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1613645634","product_id":100020801,"comment_content":"&quot;一个临时表只能被创建它的 session 访问，对其他线程不可见&quot;，丁老师你好，这里我不是很明白，session和线程不是两个概念么，在很多文章中提到的线程我理解是innoDB的执行线程哇","like_count":0},{"had_liked":false,"id":268023,"user_name":"浩克","can_delete":false,"product_type":"c1","uid":1333389,"ip_address":"","ucode":"99F5D4F24AF574","user_header":"https://static001.geekbang.org/account/avatar/00/14/58/8d/bc69cde1.jpg","comment_is_top":false,"comment_ctime":1608033029,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608033029","product_id":100020801,"comment_content":"老师您好，在25课里面的置顶留言“6.表上无主键的情况(主库利用索引更改数据,备库回放只能用全表扫描,这种情况可以调整slave_rows_search_algorithms参数适当优化下)”<br>为啥会存在无主键的表呢，就算dba没创建主键，Innodb可以用rowid给自动建一个虚拟主键呀，这样不就是所有的表都有主键了吗？<br>作者回复: 用户没有显示指定主键的话，InnoDB引擎会自己创建一个隐藏的主键，但是这个主键对Server层是透明的，优化器用不上。<br><br>老师你看这么理解对不，表上无主键的情况(主库利用索引更改数据,备库回放只能用全表扫描,这种情况可以调整slave_rows_search_algorithms参数适当优化下)，这个描述的场景是，在binlog_format=row，如果主库使用update更新很多条语句的话，同步到从库就是一行行的更新记录，每一个更新记录从库都需要全表扫面一遍，而主库的更新只需要一次全表扫描就更新完成了，即使主库使用索引更新，那么也是需要一次全表扫描，是这么理解的吧？也就是说表在无主键的情况下的更新都是走全表扫描来更新的，即使通过二级索引来更新也是需要全表扫描更新行数据页的，有理解偏差的地方麻烦请老师帮忙指正下，抱拳了<br>","like_count":0},{"had_liked":false,"id":239072,"user_name":"lleft","can_delete":false,"product_type":"c1","uid":1970443,"ip_address":"","ucode":"D573EB509455AE","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIx1V1QAxC4NHaxYZGyuibBN8lcURJWc5nrnO4yic1kxnDemYV2FJGialf47kYX9qtDnZZOfe1SJeLicg/132","comment_is_top":false,"comment_ctime":1596426722,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596426722","product_id":100020801,"comment_content":"binlog_format=row，binlog中没有记录任何与临时表相关的语句，创建临时表、增删改也都没有记录，只有在主动drop临时表的时候，才会在binlog中记录drop temporay table。。的信息。","like_count":0},{"had_liked":false,"id":232379,"user_name":"咸鱼","can_delete":false,"product_type":"c1","uid":1179028,"ip_address":"","ucode":"5E79636DE48155","user_header":"https://static001.geekbang.org/account/avatar/00/11/fd/94/0247f945.jpg","comment_is_top":false,"comment_ctime":1593990719,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593990719","product_id":100020801,"comment_content":"MySQL的线程是不是也是池化的资源？一般在使用时客户端的池化连接和和MySQL服务的执行线程是不是没有直接关系？","like_count":0},{"had_liked":false,"id":178047,"user_name":"温故而知新可以为师矣","can_delete":false,"product_type":"c1","uid":1453053,"ip_address":"","ucode":"FADCDFA9F9E5E8","user_header":"https://static001.geekbang.org/account/avatar/00/16/2b/fd/7013289d.jpg","comment_is_top":false,"comment_ctime":1581578007,"is_pvip":false,"replies":[{"id":"69153","content":"新年快乐🤝","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1581651968,"ip_address":"","comment_id":178047,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1581578007","product_id":100020801,"comment_content":"新年快乐，哈哈哈","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483646,"discussion_content":"新年快乐🤝","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581651968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":173214,"user_name":"Socket","can_delete":false,"product_type":"c1","uid":1313213,"ip_address":"","ucode":"932CF3D692FFB5","user_header":"https://static001.geekbang.org/account/avatar/00/14/09/bd/cc31c95d.jpg","comment_is_top":false,"comment_ctime":1579480187,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1579480187","product_id":100020801,"comment_content":"有个问题既然临时表是线程断开后删除，那是不是没有必要写入binglog然后主从同步。反正断开或关机都会删除。","like_count":0},{"had_liked":false,"id":154710,"user_name":"长期规划","can_delete":false,"product_type":"c1","uid":1019332,"ip_address":"","ucode":"5EF65E9115834B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/c4/6f97daea.jpg","comment_is_top":false,"comment_ctime":1574517704,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574517704","product_id":100020801,"comment_content":"的确，在业务层进行聚合，成本高。SQL改变，业务层的实现也要变。在MySQL内实现最好，实现时可以用临时表，我个人感觉中间件应该实现这部分功能，这样，分库分表对业务层透明。<br>我之前在公司时，使用了在业务层聚合，是有些复杂，最麻烦的是SQL不同，业务代码就不同，无法复用同一套业务代码。准确说，在业务层实现一个通用的函数实现任意SQL难度大一些，实现后的效率如何也不好说，但应该能实现，因为SQL有一个统一语句","like_count":0},{"had_liked":false,"id":153963,"user_name":"随心而至","can_delete":false,"product_type":"c1","uid":1097836,"ip_address":"","ucode":"31866865255101","user_header":"https://static001.geekbang.org/account/avatar/00/10/c0/6c/29be1864.jpg","comment_is_top":false,"comment_ctime":1574337888,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574337888","product_id":100020801,"comment_content":"我觉得临时表, 普通表是不是可以类比Java里面的方法的局部变量和类的字段","like_count":0},{"had_liked":false,"id":150114,"user_name":"笑着活下去","can_delete":false,"product_type":"c1","uid":1621001,"ip_address":"","ucode":"23B8B4F9390A2B","user_header":"https://static001.geekbang.org/account/avatar/00/18/bc/09/d6b138fb.jpg","comment_is_top":false,"comment_ctime":1573463809,"is_pvip":false,"replies":[{"id":"57916","content":"row格式下，备库根本就不产生临时表了，也没有往临时表里面写数据的操作了","user_name":"作者回复","user_name_real":"林晓斌","uid":"1264162","ctime":1573564461,"ip_address":"","comment_id":150114,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1573463809","product_id":100020801,"comment_content":"老师，row格式的binlog不记录临时表的操作，那么在备库插入记录（对应主库上面插入到临时表）是插入到哪里呢？","like_count":0,"discussions":[{"author":{"id":1264162,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4a/22/2681d602.jpg","nickname":"林晓斌","note":"","ucode":"CDE42D44F26240","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474067,"discussion_content":"row格式下，备库根本就不产生临时表了，也没有往临时表里面写数据的操作了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573564461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":148826,"user_name":"Fs","can_delete":false,"product_type":"c1","uid":1083184,"ip_address":"","ucode":"0AD0EFB5544B9A","user_header":"https://static001.geekbang.org/account/avatar/00/10/87/30/4626c8c0.jpg","comment_is_top":false,"comment_ctime":1573091877,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573091877","product_id":100020801,"comment_content":"把各个分库拿到的数据，汇总到一个 MySQL 实例的一个表中，然后在这个汇总实例上做逻辑操作。<br><br>这个是server端是怎么做到？分布式数据库比如cassandra这种是有coordinate node去做这种事。mysql各个库表都是一样的角色，怎么做到的？","like_count":0},{"had_liked":false,"id":142864,"user_name":"Chocolate","can_delete":false,"product_type":"c1","uid":1013822,"ip_address":"","ucode":"242CF0E3C10E97","user_header":"https://static001.geekbang.org/account/avatar/00/0f/78/3e/c39d86f1.jpg","comment_is_top":false,"comment_ctime":1571567078,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1571567078","product_id":100020801,"comment_content":"老师，你好，在上一期的问题回答里，有一个问题咨询一下，为什么选择在 t1.c &gt; X、t2.c &gt; Y、t3.c &gt;Z 里面选择数据量最小的一张表作为驱动表，不是直接选在 t1、t2、t3 里数据量最小的？然后，假设 1 数据量最小，在与 t2、t3 join 的时候直接将 t2.c &gt; Y 放在与 t2 join on 的条件上，将 t3.c &gt; Z 放在与 t3 join on 的条件上，这种做法可以吗？","like_count":0},{"had_liked":false,"id":135088,"user_name":"-W.LI-","can_delete":false,"product_type":"c1","uid":1210699,"ip_address":"","ucode":"3556786538664F","user_header":"https://static001.geekbang.org/account/avatar/00/12/79/4b/740f91ca.jpg","comment_is_top":false,"comment_ctime":1569018048,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1569018048","product_id":100020801,"comment_content":"老师好!我有个问题，二叉树到底有多少叉和内存每页大小和，索引大小有关约(页大小&#47;单个索引大小)。那如果内存页大小改变了(变大或变小)会出现什么情况啊?叉数会变么?","like_count":0},{"had_liked":false,"id":123482,"user_name":"加载中……","can_delete":false,"product_type":"c1","uid":1366948,"ip_address":"","ucode":"3E59A0A0784D0A","user_header":"https://static001.geekbang.org/account/avatar/00/14/db/a4/191be6ad.jpg","comment_is_top":false,"comment_ctime":1565685175,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565685175","product_id":100020801,"comment_content":"老师好，请教个问题。<br>“第一原则尽量使用BKA”。我查看阿里云的数据库(5.7.27)默认配置结果如下：<br>show variables like &#39;optimizer_switch&#39;;<br>mrr=on,mrr_cost_based=on,batched_key_access=off<br>应该是没有开启BKA和MRR的功能, 阿里云的数据库默认配置没有启用BKA和MRR是有什么考虑么？<br>如果打开MRR和BKA 的设置是不是只有好处，没有坏处?","like_count":0},{"had_liked":false,"id":121262,"user_name":"null","can_delete":false,"product_type":"c1","uid":1024294,"ip_address":"","ucode":"F9039EFED6B55D","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132","comment_is_top":false,"comment_ctime":1565089665,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1565089665","product_id":100020801,"comment_content":"表结构文件：#sql{进程 id}_{线程 id}_ 序列号.frm<br>table_def_key： 库名+表名+server_id+thread_id<br><br>----<br>操作步骤<br><br>0. create temporary table temp_t1(id int primary key)engine=innodb;<br>表结构文件：#sql15d86_168_0.frm<br><br>1. create temporary table temp_t2(id int primary key)engine=innodb;<br>表结构文件：#sql15d86_100000168_1.frm<br><br>2. create temporary table temp_t3(id int primary key)engine=innodb;<br>表结构文件：#sql15d86_200000168_2.frm<br><br>3. create temporary table temp_t4(id int primary key)engine=innodb;<br>表结构文件：#sql15d86_300000168_3.frm<br><br>4. create temporary table temp_t1(id int primary key)engine=innodb;<br>=》Error : Table &#39;temp_t1&#39; already exists<br><br>5. create temporary table temp_t5(id int primary key)engine=innodb;<br>表结构文件：#sql15d86_500000168_5.frm<br><br>----<br><br>问题一：表结构文件是的 {线程 id} 和 table_def_key 中的 thread_id 是同一个值么？<br><br>问题二：&#39;168&#39; 和 &#39;x00000168&#39;，哪个是线程 id?<br><br>在第 4. 时，重复创建 temp_t1，报错：表已存在，并且序列号跳过了 4。这里的 &#39;线程 id&#39; 是 &#39;168&#39;，还是 &#39;x00000168&#39;（感觉这个 x 是序列号添加进去的）?<br>如果 &#39;线程 id&#39; 是 &#39;x00000168&#39;，则 &#39;线程 id&#39; 是变化的，这是如何确定 &#39;temp_t1&#39; 已存在的呢？<br>而 table_def_key 也是由 &#39;线程 id&#39; 组成，因此 table_def_key 也无法校验临时表名的唯一性呀。<br><br>谢谢老师！！","like_count":0,"discussions":[{"author":{"id":1324550,"avatar":"https://static001.geekbang.org/account/avatar/00/14/36/06/08c46bcd.jpg","nickname":"聂利","note":"","ucode":"808E064089724D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":587783,"discussion_content":"这里所有的数字都是16进制的，所以加x, 验证过","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1663292597,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":121053,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1565053148,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565053148","product_id":100020801,"comment_content":"和猜测近似，临时表可以重名，是个相对判定。<br>同一个库的表名是不能重复的，否则查询的时候就懵逼了。这里的重名，只是表名重复了，但是查的时候会带上其他识别信息，并且所在的圈层也变化了。<br>临时表在某些场景确实好用，不过实际工作中几乎未用过，感觉写存储过程才用的到，平时的业务开发不会这么玩。","like_count":0},{"had_liked":false,"id":118877,"user_name":"ZHANG","can_delete":false,"product_type":"c1","uid":1442437,"ip_address":"","ucode":"BAFD110AE33328","user_header":"https://static001.geekbang.org/account/avatar/00/16/02/85/9a81a973.jpg","comment_is_top":false,"comment_ctime":1564456485,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1564456485","product_id":100020801,"comment_content":"老师，有个疑问哈<br>临时表的特性第4点里说“session A内有同名的临时表和普通表的时候，show create语句，以及增删改查语句访问的是临时表”<br>如果这时候想访问和临时表同名的普通表怎么访问呢？","like_count":0,"discussions":[{"author":{"id":1812970,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/a9/ea/5bfce6c5.jpg","nickname":"mgs2002","note":"","ucode":"F5931108BD509B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":299804,"discussion_content":"show tables","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597826378,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":92597,"user_name":"llx","can_delete":false,"product_type":"c1","uid":1153012,"ip_address":"","ucode":"95741E1BD74B26","user_header":"https://static001.geekbang.org/account/avatar/00/11/97/f4/6709b8cf.jpg","comment_is_top":false,"comment_ctime":1557305498,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1557305498","product_id":100020801,"comment_content":"查询需要session，所以同步到备库其实是查询不到的，只是备份用","like_count":0}]}