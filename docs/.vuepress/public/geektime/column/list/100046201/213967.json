{"id":213967,"title":"14 | 优雅启动：如何避免流量打到没有启动完成的节点？","content":"<p>你好，我是何小锋。上一讲我们介绍了优雅停机，就是为了让服务提供方在停机应用的时候，保证所有调用方都能“安全”地切走流量，不再调用自己，从而做到对业务无损。其中实现的关键点就在于，让正在停机的服务提供方应用有状态，让调用方感知到服务提供方正在停机。</p><p>接着上一讲的内容，今天我们来聊聊优雅启动。</p><p>是不是很诧异？应用启动居然也要这么“讲究”吗？这就好比我们日常生活中的热车，行驶之前让发动机空跑一会，可以让汽车的各个部件都“热”起来，减小磨损。</p><p>换到应用上来看，原理也是一样的。运行了一段时间后的应用，执行速度会比刚启动的应用更快。这是因为在Java里面，在运行过程中，JVM虚拟机会把高频的代码编译成机器码，被加载过的类也会被缓存到JVM缓存中，再次使用的时候不会触发临时加载，这样就使得“热点”代码的执行不用每次都通过解释，从而提升执行速度。</p><p>但是这些“临时数据”，都在我们应用重启后就消失了。重启后的这些“红利”没有了之后，如果让我们刚启动的应用就承担像停机前一样的流量，这会使应用在启动之初就处于高负载状态，从而导致调用方过来的请求可能出现大面积超时，进而对线上业务产生损害行为。</p><p>在上一讲我们说过，在微服务架构里面，上线肯定是频繁发生的，那我们总不能因为上线，就让过来的请求出现大面积超时吧？所以我们得想点办法。既然问题的关键是在于“刚重启的服务提供方因为没有预跑就承担了大流量”，那我们是不是可以通过某些方法，让应用一开始只接少许流量呢？这样低功率运行一段时间后，再逐渐提升至最佳状态。</p><!-- [[[read_end]]] --><p>这其实就是我今天要和你分享的重点，RPC里面的一个实用功能——启动预热。</p><h2>启动预热</h2><p>那什么叫启动预热呢？</p><p>简单来说，就是让刚启动的服务提供方应用不承担全部的流量，而是让它被调用的次数随着时间的移动慢慢增加，最终让流量缓和地增加到跟已经运行一段时间后的水平一样。</p><p><strong>那在RPC里面，我们该怎么实现这个功能呢？</strong></p><p>我们现在是要控制调用方发送到服务提供方的流量。我们可以先简单地回顾下调用方发起的RPC调用流程是怎样的，调用方应用通过服务发现能够获取到服务提供方的IP地址，然后每次发送请求前，都需要通过负载均衡算法从连接池中选择一个可用连接。那这样的话，我们是不是就可以让负载均衡在选择连接的时候，区分一下是否是刚启动不久的应用？对于刚启动的应用，我们可以让它被选择到的概率特别低，但这个概率会随着时间的推移慢慢变大，从而实现一个动态增加流量的过程。</p><p><strong>现在方案有了，我们就可以考虑具体实现了。</strong></p><p>首先对于调用方来说，我们要知道服务提供方启动的时间，这个怎么获取呢？我这里给出两种方法，一种是服务提供方在启动的时候，把自己启动的时间告诉注册中心；另外一种就是注册中心收到的服务提供方的请求注册时间。这两个时间我认为都可以，不过可能你会犹豫我们该怎么确保所有机器的日期时间是一样的？这其实不用太关心，因为整个预热过程的时间是一个粗略值，即使机器之间的日期时间存在1分钟的误差也不影响，并且在真实环境中机器都会默认开启NTP时间同步功能，来保证所有机器时间的一致性。</p><p>不管你是选择哪个时间，最终的结果就是，调用方通过服务发现，除了可以拿到IP列表，还可以拿到对应的启动时间。我们需要把这个时间作用在负载均衡上，在<a href=\"https://time.geekbang.org/column/article/210893\">[第 11 讲]</a> 我们介绍过一种基于权重的负载均衡，但是这个权重是由服务提供方设置的，属于一个固定状态。现在我们要让这个权重变成动态的，并且是随着时间的推移慢慢增加到服务提供方设定的固定值，整个过程如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/e7/d4/e796da8cf26f056479a59fd97b43d0d4.jpg?wh=2558*2523\" alt=\"\" title=\"预热过程图\"></p><p>通过这个小逻辑的改动，我们就可以保证当服务提供方运行时长小于预热时间时，对服务提供方进行降权，减少被负载均衡选择的概率，避免让应用在启动之初就处于高负载状态，从而实现服务提供方在启动后有一个预热的过程。</p><p>看到这儿，你可能还会有另外一个疑问，就是当我在大批量重启服务提供方的时候，会不会导致没有重启的机器因为扛的流量太大而出现问题？</p><p>关于这个问题，我是这么考虑的。当你大批量重启服务提供方的时候，对于调用方来说，这些刚重启的机器权重基本是一样的，也就是说这些机器被选中的概率是一样的，大家都是一样得低，也就不存在权重区分的问题了。但是对于那些没有重启过的应用提供方来说，它们被负载均衡选中的概率是相对较高的，但是我们可以通过<a href=\"https://time.geekbang.org/column/article/210893\">[第 11 讲]</a> 学到的自适应负载的方法平缓地切换，所以也是没有问题的。</p><p>启动预热更多是从调用方的角度出发，去解决服务提供方应用冷启动的问题，让调用方的请求量通过一个时间窗口过渡，慢慢达到一个正常水平，从而实现平滑上线。但对于服务提供方本身来说，有没有相关方案可以实现这种效果呢？</p><p>当然有，这也是我今天要分享的另一个重点，和热启动息息相关，那就是延迟暴露。</p><h2>延迟暴露</h2><p>我们应用启动的时候都是通过main入口，然后顺序加载各种相关依赖的类。以Spring应用启动为例，在加载的过程中，Spring容器会顺序加载Spring Bean，如果某个Bean是RPC服务的话，我们不光要把它注册到Spring-BeanFactory里面去，还要把这个Bean对应的接口注册到注册中心。注册中心在收到新上线的服务提供方地址的时候，会把这个地址推送到调用方应用内存中；当调用方收到这个服务提供方地址的时候，就会去建立连接发请求。</p><p>但这时候是不是存在服务提供方可能并没有启动完成的情况？因为服务提供方应用可能还在加载其它的Bean。对于调用方来说，只要获取到了服务提供方的IP，就有可能发起RPC调用，但如果这时候服务提供方没有启动完成的话，就会导致调用失败，从而使业务受损。</p><p><strong>那有什么办法可以避免这种情况吗？</strong></p><p>在解决问题前，我们先看下出现上述问题的根本原因。这是因为服务提供方应用在没有启动完成的时候，调用方的请求就过来了，而调用方请求过来的原因是，服务提供方应用在启动过程中把解析到的RPC服务注册到了注册中心，这就导致在后续加载没有完成的情况下服务提供方的地址就被服务调用方感知到了。</p><p>这样的话，其实我们就可以把接口注册到注册中心的时间挪到应用启动完成后。具体的做法就是在应用启动加载、解析Bean的时候，如果遇到了RPC服务的Bean，只先把这个Bean注册到Spring-BeanFactory里面去，而并不把这个Bean对应的接口注册到注册中心，只有等应用启动完成后，才把接口注册到注册中心用于服务发现，从而实现让服务调用方延迟获取到服务提供方地址。</p><p>这样是可以保证应用在启动完后才开始接入流量的，但其实这样做，我们还是没有实现最开始的目标。因为这时候应用虽然启动完成了，但并没有执行相关的业务代码，所以JVM内存里面还是冷的。如果这时候大量请求过来，还是会导致整个应用在高负载模式下运行，从而导致不能及时地返回请求结果。而且在实际业务中，一个服务的内部业务逻辑一般会依赖其它资源的，比如缓存数据。如果我们能在服务正式提供服务前，先完成缓存的初始化操作，而不是等请求来了之后才去加载，我们就可以降低重启后第一次请求出错的概率。</p><p><strong>那具体怎么实现呢？</strong></p><p>我们还是需要利用服务提供方把接口注册到注册中心的那段时间。我们可以在服务提供方应用启动后，接口注册到注册中心前，预留一个Hook过程，让用户可以实现可扩展的Hook逻辑。用户可以在Hook里面模拟调用逻辑，从而使JVM指令能够预热起来，并且用户也可以在Hook里面事先预加载一些资源，只有等所有的资源都加载完成后，最后才把接口注册到注册中心。整个应用启动过程如下图所示：</p><p><img src=\"https://static001.geekbang.org/resource/image/3c/bd/3c84f9cf6745f2d50e34bd8431c84abd.jpg?wh=3374*893\" alt=\"\" title=\"启动顺序图\"></p><h2>总结</h2><p>包括<a href=\"https://time.geekbang.org/column/article/210893\">[第 11 讲]</a> 在内，到今天为止，我们就已经把整个RPC里面的启停机流程都讲完了。就像前面说过的那样，虽然启停机流程看起来不属于RPC主流程，但是如果你能在RPC里面把这些“微小”的工作做好，就可以让你的技术团队感受到更多的微服务带来的好处。</p><p>另外，我们今天的两大重点——启动预热与延迟暴露，它们并不是RPC的专属功能，我们在开发其它系统时，也可以利用这两点来减少冷启动对业务的影响。</p><h2>课后思考</h2><p>在启动预热那部分，我们特意提到过一个问题，就是“当大批量重启服务提供方的时候，会导致请求大概率发到没有重启的机器上，这时服务提供方有可能扛不住”，不知道你是怎么看待这个问题的，是否有好的解决方案呢？</p><p>欢迎留言和我分享你的思考，也欢迎你把文章分享给你的朋友，邀请他加入学习。我们下节课再见！</p>","comments":[{"had_liked":false,"id":190628,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1584674402,"is_pvip":true,"replies":[{"id":"73827","content":"分批次启动很重要","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585007088,"ip_address":"","comment_id":190628,"utype":1}],"discussion_count":1,"race_medal":0,"score":"113253824098","product_id":100046201,"comment_content":"如果是大批量重启，可以通过：<br>1、分时分批启动，就和灰度发布一样；<br>2、在请求低峰把，在热点的应用肯定是有使用低峰的；<br>3、如果必须同时大批量重启，为了保证服务的可用性，可以在低峰时期，限流，为PLUS服务，非PLUS的就提醒暂时不可用之类的友好提示。<br>暂时就能想到这么多，请老师指点","like_count":27,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488017,"discussion_content":"分批次启动很重要","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585007088,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":199442,"user_name":"小可","can_delete":false,"product_type":"c1","uid":1006735,"ip_address":"","ucode":"8834AF621FA67D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5c/8f/551b5624.jpg","comment_is_top":false,"comment_ctime":1585489280,"is_pvip":false,"replies":[{"id":"74948","content":"是的，尽量延迟注册时机","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585570788,"ip_address":"","comment_id":199442,"utype":1}],"discussion_count":1,"race_medal":0,"score":"35945227648","product_id":100046201,"comment_content":"1.启动时逐步增加流量<br>2.等服务资源完全启动完成，再去注册服务<br>3.最好在注册前预热jvm，比如提前加载业务缓存","like_count":9,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":489834,"discussion_content":"是的，尽量延迟注册时机","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585570788,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":190439,"user_name":"高源","can_delete":false,"product_type":"c1","uid":1048887,"ip_address":"","ucode":"751B41FD38EF7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg","comment_is_top":false,"comment_ctime":1584661625,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27354465401","product_id":100046201,"comment_content":"老师把服务能够遇到和需要处理的细节讲的很全面了，微服务就应该做到这，但是对于我们非互联网企业使用微服务，落地有很大借鉴👍️","like_count":7},{"had_liked":false,"id":191005,"user_name":"武装到牙齿","can_delete":false,"product_type":"c1","uid":1629842,"ip_address":"","ucode":"66F549E9C225A7","user_header":"https://static001.geekbang.org/account/avatar/00/18/de/92/f867b68c.jpg","comment_is_top":false,"comment_ctime":1584717173,"is_pvip":false,"replies":[{"id":"73826","content":"是的，速度很重要。但也可以通过在调用方那边快速加权重到新启动的实例上","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585007017,"ip_address":"","comment_id":191005,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18764586357","product_id":100046201,"comment_content":"串行重启啊，明知道留下的机器顶不住流量，硬生生的给同时强制重启肯定不行啊","like_count":4,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488098,"discussion_content":"是的，速度很重要。但也可以通过在调用方那边快速加权重到新启动的实例上","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585007017,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265612,"user_name":"codewor","can_delete":false,"product_type":"c1","uid":2343990,"ip_address":"","ucode":"2715765269385B","user_header":"https://static001.geekbang.org/account/avatar/00/23/c4/36/4f7239de.jpg","comment_is_top":false,"comment_ctime":1606962397,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14491864285","product_id":100046201,"comment_content":"老师很牛逼，是我遇到过最牛的一个了","like_count":4},{"had_liked":false,"id":190573,"user_name":"吴小智","can_delete":false,"product_type":"c1","uid":1310798,"ip_address":"","ucode":"C7C9F58B5C9F7B","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","comment_is_top":false,"comment_ctime":1584669521,"is_pvip":false,"replies":[{"id":"73829","content":"👍","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585007163,"ip_address":"","comment_id":190573,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14469571409","product_id":100046201,"comment_content":"重要的还是减少大批量重启服务的情况，应该滚动升级，逐步替代。","like_count":3,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488006,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585007163,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233413,"user_name":"邹","can_delete":false,"product_type":"c1","uid":1184406,"ip_address":"","ucode":"06BB69F19CA34F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyibojtJCnzALT1CleOHlTfS1XpFQHibXA7B2j631I2icHL2Uy5XvvviaEXBWPSNkU5G7LQP3JJHicgzQ/132","comment_is_top":false,"comment_ctime":1594309785,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10184244377","product_id":100046201,"comment_content":"大批量重启时：<br>1. 分批重启<br>2. 根据重启比例来设置重启服务的权重","like_count":2},{"had_liked":false,"id":190538,"user_name":"每天晒白牙","can_delete":false,"product_type":"c1","uid":1004698,"ip_address":"","ucode":"A1B102CD933DEA","user_header":"https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg","comment_is_top":false,"comment_ctime":1584667361,"is_pvip":false,"replies":[{"id":"73830","content":"需要容量预估，才好控制并发","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585007224,"ip_address":"","comment_id":190538,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10174601953","product_id":100046201,"comment_content":"确实有这个问题，我们在上线服务提供方时，重启的并行度会控制在比较低的状态，比如只并行2台，避免发生大量请求打到未重启的服务提供方上","like_count":2,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487997,"discussion_content":"需要容量预估，才好控制并发","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585007224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":343208,"user_name":"cc","can_delete":false,"product_type":"c1","uid":1037891,"ip_address":"","ucode":"68E69205A7D5BC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/d6/43/0704d7db.jpg","comment_is_top":false,"comment_ctime":1650707793,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5945675089","product_id":100046201,"comment_content":"hook 这个做预热很难达到理想的效果了，尤其是业务代码复杂的情况。","like_count":1},{"had_liked":false,"id":215011,"user_name":"dancer","can_delete":false,"product_type":"c1","uid":1019036,"ip_address":"","ucode":"B8D5641A3AC490","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/9c/d48473ab.jpg","comment_is_top":false,"comment_ctime":1588868339,"is_pvip":false,"replies":[{"id":"80440","content":"从单个实例角度出发，是一样的","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1589500320,"ip_address":"","comment_id":215011,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5883835635","product_id":100046201,"comment_content":"感谢老师的分享，文中举的例子是基于服务先关闭再启动的情况。像K8s这种先启动一定数量新实例再关闭旧实例的发布流程，我们在关闭和启动时要注意哪些问呢","like_count":1,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494272,"discussion_content":"从单个实例角度出发，是一样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589500320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":190448,"user_name":"刘楠","can_delete":false,"product_type":"c1","uid":1120773,"ip_address":"","ucode":"9F19D44CBEE039","user_header":"https://static001.geekbang.org/account/avatar/00/11/1a/05/f154d134.jpg","comment_is_top":false,"comment_ctime":1584662141,"is_pvip":false,"replies":[{"id":"73822","content":"对，这就是延迟暴露","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585006772,"ip_address":"","comment_id":190448,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5879629437","product_id":100046201,"comment_content":"启动成功，后早单独搞个任务来注册呢？","like_count":1,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":487981,"discussion_content":"对，这就是延迟暴露","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585006772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":359431,"user_name":"hillwater","can_delete":false,"product_type":"c1","uid":2826205,"ip_address":"上海","ucode":"FB16D5FCE8C7E6","user_header":"","comment_is_top":false,"comment_ctime":1665538861,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665538861","product_id":100046201,"comment_content":"在哪里判断业务启动完毕了呢？写个空bean，把order降到最低？","like_count":0},{"had_liked":false,"id":337243,"user_name":"天二","can_delete":false,"product_type":"c1","uid":1100092,"ip_address":"","ucode":"F03EF223F2A4AE","user_header":"https://static001.geekbang.org/account/avatar/00/10/c9/3c/7d9b3baa.jpg","comment_is_top":false,"comment_ctime":1646714313,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1646714313","product_id":100046201,"comment_content":"老师，启动预热是rpc本身就有的能力呢？还是需要使用者自己实现呢？","like_count":0},{"had_liked":false,"id":333958,"user_name":"核桃","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1644639125,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1644639125","product_id":100046201,"comment_content":"大批重启有时候是大面积宕机导致的，这种不一定是可控的，很多朋友提到的串行重启，这个前提很难存在。想到一个比较好的方式，就是业务策做出调整了，例如像学校选课官网那样，在选课高峰期，其实也可以类似节点大面积宕机那样，切换业务模式，把很多动态的网页什么的全部暂停，只有一个最基础的业务静态网页请求等等，通过减少大量的网络请求，并且削峰来压平流量，但是这样需要在业务那里也做好策略才行。","like_count":0,"discussions":[{"author":{"id":2826205,"avatar":"","nickname":"hillwater","note":"","ucode":"FB16D5FCE8C7E6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":590102,"discussion_content":"这是降级预案了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1665538495,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":304474,"user_name":"易轻尘","can_delete":false,"product_type":"c1","uid":1136684,"ip_address":"","ucode":"0D0CB9D6D45A70","user_header":"https://static001.geekbang.org/account/avatar/00/11/58/2c/92c7ce3b.jpg","comment_is_top":false,"comment_ctime":1627441081,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1627441081","product_id":100046201,"comment_content":"个人猜想可以进行限流，限制注册中心发给调用方ip列表的速度","like_count":0},{"had_liked":false,"id":281845,"user_name":"曹翔","can_delete":false,"product_type":"c1","uid":1114878,"ip_address":"","ucode":"B4D8B42DFB535C","user_header":"https://static001.geekbang.org/account/avatar/00/11/02/fe/d539b96b.jpg","comment_is_top":false,"comment_ctime":1614923254,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1614923254","product_id":100046201,"comment_content":"根据负载情况，比如读取promethus上的数据，分批启动","like_count":0},{"had_liked":false,"id":251833,"user_name":"Simple life","can_delete":false,"product_type":"c1","uid":1571460,"ip_address":"","ucode":"1902D7F72FB43F","user_header":"https://static001.geekbang.org/account/avatar/00/17/fa/84/f01d203a.jpg","comment_is_top":false,"comment_ctime":1601899527,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601899527","product_id":100046201,"comment_content":"旧服务不下线啊，重启成功后再下线啊，这样旧的服务也能承载流量，如果考虑到预热，可以分批重启","like_count":0},{"had_liked":false,"id":246003,"user_name":"星星滴蓝天","can_delete":false,"product_type":"c1","uid":1465990,"ip_address":"","ucode":"2F2F56F93AD828","user_header":"https://static001.geekbang.org/account/avatar/00/16/5e/86/40877404.jpg","comment_is_top":false,"comment_ctime":1599129921,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1599129921","product_id":100046201,"comment_content":"我们是晚上低峰时上线，白天不让上线","like_count":0},{"had_liked":false,"id":242042,"user_name":"阿卧","can_delete":false,"product_type":"c1","uid":1229566,"ip_address":"","ucode":"68C0CC25E57707","user_header":"https://static001.geekbang.org/account/avatar/00/12/c2/fe/038a076e.jpg","comment_is_top":false,"comment_ctime":1597571188,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597571188","product_id":100046201,"comment_content":"大批量服务重启需要做到以下几点：<br>1. 分批次重启服务<br>2. 在服务低峰时候进行服务重启<br>3. 重启过程中对服务做限流操作","like_count":0},{"had_liked":false,"id":229974,"user_name":"灿烂明天","can_delete":false,"product_type":"c1","uid":1322455,"ip_address":"","ucode":"07DA56B0680D0C","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg","comment_is_top":false,"comment_ctime":1593229489,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593229489","product_id":100046201,"comment_content":"还有老师，这里给了两个方案，是从客户端和服务端方面的，实际用是两个最好一起用，还是哪个方案比较好点的","like_count":0},{"had_liked":false,"id":229968,"user_name":"灿烂明天","can_delete":false,"product_type":"c1","uid":1322455,"ip_address":"","ucode":"07DA56B0680D0C","user_header":"https://static001.geekbang.org/account/avatar/00/14/2d/d7/74fc8f38.jpg","comment_is_top":false,"comment_ctime":1593228976,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1593228976","product_id":100046201,"comment_content":"老师你好，那个启动预热那里权重达到了设定的固定值后挪出列表是挪出调用方的服务列表吗，达到了正常还要挪出？这里不太明白，能解惑下吗老师，谢谢","like_count":0},{"had_liked":false,"id":217758,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1589604369,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1589604369","product_id":100046201,"comment_content":"优雅启动：<br>第一启动预热<br>第二延迟暴露<br>第三分批启动<br><br>实际上线时，我们一般遵循这样的逻辑：<br>前提是各种测试OK，然后预发布也OK<br>第一先上线一台机器，验证是否OK<br>第二每个分组再上线一台，都验证是否OK<br>第三分批次把其他组内未上线部分机器都上线<br><br>一次启停大部分机器，这种场景在发现上线完成后存在某些问题，为了及时止损，可能会一次回滚大批量机器，这时就非常需要优雅启停的控制了，否则业务异常一定比较多。这是就是异常处理的事情了，及时没有优雅启停也需要赶紧回滚及时止损，出现这种情况，主要是线上验证存在漏洞造成的，还需要完善上线验证流程。","like_count":0},{"had_liked":false,"id":213936,"user_name":"有米","can_delete":false,"product_type":"c1","uid":1005042,"ip_address":"","ucode":"C9A10B7A67BC12","user_header":"https://static001.geekbang.org/account/avatar/00/0f/55/f2/ba68d931.jpg","comment_is_top":false,"comment_ctime":1588592966,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1588592966","product_id":100046201,"comment_content":"老师留下的问题其实就是引出下一节内容，限流和熔断，吃不了那么多就不给他吃了，总比撑死好","like_count":0},{"had_liked":false,"id":194882,"user_name":"波波","can_delete":false,"product_type":"c1","uid":1034120,"ip_address":"","ucode":"F63725D3416CC5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c7/88/a2e42dc8.jpg","comment_is_top":false,"comment_ctime":1585114870,"is_pvip":false,"replies":[{"id":"74967","content":"hook就是一个接口，可以让使用者注入具体实现","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585571658,"ip_address":"","comment_id":194882,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1585114870","product_id":100046201,"comment_content":"老师，延迟暴露那个hook具体怎么实现，如何确定资源加载完毕了呢？","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488920,"discussion_content":"hook就是一个接口，可以让使用者注入具体实现","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585571658,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1121588,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/34/8201baab.jpg","nickname":"端贺","note":"","ucode":"80F1400B138055","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":217501,"discussion_content":"这是一种模板方法模式，你来实现具体的逻辑，逻辑执行完成以后，在执行注册到注册中心的操作。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585565730,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1239557,"avatar":"https://static001.geekbang.org/account/avatar/00/12/ea/05/c0d8014d.jpg","nickname":"一道阳光","note":"","ucode":"F35207CCCEC6E2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1121588,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/34/8201baab.jpg","nickname":"端贺","note":"","ucode":"80F1400B138055","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":284080,"discussion_content":"嗯，是的，但是还没有解释清楚怎么确定资源加载完毕的时机，可能是通过改造框架或者web容器来实现吧。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592442278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":217501,"ip_address":""},"score":284080,"extra":""}]}]},{"had_liked":false,"id":193896,"user_name":"陈国林","can_delete":false,"product_type":"c1","uid":1438037,"ip_address":"","ucode":"83D12F3E79F197","user_header":"https://static001.geekbang.org/account/avatar/00/15/f1/55/8ac4f169.jpg","comment_is_top":false,"comment_ctime":1584978085,"is_pvip":false,"replies":[{"id":"73812","content":"是的，控制速度很重要","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585005666,"ip_address":"","comment_id":193896,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584978085","product_id":100046201,"comment_content":"控制发布的步长，类似K8s里面的Deployment的RollingUpgrade，滚动升级保证有足够的服务在抗流量","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488695,"discussion_content":"是的，控制速度很重要","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585005666,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":193015,"user_name":"桂冠远航","can_delete":false,"product_type":"c1","uid":1155463,"ip_address":"","ucode":"5959E1A1DAA05D","user_header":"https://static001.geekbang.org/account/avatar/00/11/a1/87/259ab5a3.jpg","comment_is_top":false,"comment_ctime":1584882173,"is_pvip":false,"replies":[{"id":"73817","content":"是的","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585006114,"ip_address":"","comment_id":193015,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584882173","product_id":100046201,"comment_content":"优雅启动确实优雅关闭一样重要。","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488495,"discussion_content":"是的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585006114,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":190849,"user_name":"D","can_delete":false,"product_type":"c1","uid":1027596,"ip_address":"","ucode":"5BB4D16FE39BFF","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ae/0c/f39f847a.jpg","comment_is_top":false,"comment_ctime":1584699005,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584699005","product_id":100046201,"comment_content":"老师有没有更通用的技术方案，不和语言绑定的","like_count":0},{"had_liked":false,"id":190627,"user_name":"高源","can_delete":false,"product_type":"c1","uid":1048887,"ip_address":"","ucode":"751B41FD38EF7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg","comment_is_top":false,"comment_ctime":1584674152,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584674152","product_id":100046201,"comment_content":"客户端毫秒级别不停发日志数据过来，服务端写入文件，服务端也有自己的日志文件也不少","like_count":0},{"had_liked":false,"id":190618,"user_name":"hello","can_delete":false,"product_type":"c1","uid":1464199,"ip_address":"","ucode":"854500026E2187","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132","comment_is_top":false,"comment_ctime":1584673091,"is_pvip":false,"replies":[{"id":"73828","content":"👍","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585007153,"ip_address":"","comment_id":190618,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584673091","product_id":100046201,"comment_content":"在服务端重启时，应该需要考虑服务端重启服务器的比例，一般是将服务按批重启，确保在线的服务能扛住请求端过来的流量。","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488016,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585007153,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":190591,"user_name":"高源","can_delete":false,"product_type":"c1","uid":1048887,"ip_address":"","ucode":"751B41FD38EF7D","user_header":"https://static001.geekbang.org/account/avatar/00/10/01/37/12e4c9c9.jpg","comment_is_top":false,"comment_ctime":1584671130,"is_pvip":false,"replies":[{"id":"73821","content":"看看是否有tcp重传","user_name":"作者回复","user_name_real":"何小锋","uid":"1541007","ctime":1585006626,"ip_address":"","comment_id":190591,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1584671130","product_id":100046201,"comment_content":"老师请教个问题，socket客户端和服务端通讯，开始时间同步后，跑业务跑了一段时间后，后来发现日志客户端发出和服务端接收时间差了2秒，客户端有超时设置超了2秒就报警了，这是怎么解决啊，偶尔出现现象","like_count":0,"discussions":[{"author":{"id":1541007,"avatar":"https://static001.geekbang.org/account/avatar/00/17/83/8f/8471d633.jpg","nickname":"何小锋","note":"","ucode":"E9B3B4A1B75D8B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488010,"discussion_content":"看看是否有tcp重传","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585006626,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}