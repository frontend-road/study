{"id":296541,"title":"03ï½œMutexï¼š4ç§æ˜“é”™åœºæ™¯å¤§ç›˜ç‚¹","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>ä¸Šä¸€è®²ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·é¢†ç•¥äº†Mutexçš„æ¶æ„æ¼”è¿›ä¹‹ç¾ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æ¸…æ¥šMutexçš„å®ç°ç»†èŠ‚äº†ã€‚å½“å‰Mutexçš„å®ç°è²Œä¼¼éå¸¸å¤æ‚ï¼Œå…¶å®ä¸»è¦è¿˜æ˜¯é’ˆå¯¹é¥¥é¥¿æ¨¡å¼å’Œå…¬å¹³æ€§é—®é¢˜ï¼Œåšäº†ä¸€äº›é¢å¤–å¤„ç†ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€è®²ä¸­å·²ç»ä½“éªŒè¿‡äº†ï¼ŒMutexä½¿ç”¨èµ·æ¥è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œæ¯•ç«Ÿï¼Œå®ƒåªæœ‰Lockå’ŒUnlockä¸¤ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨èµ·æ¥è¿˜èƒ½å¤æ‚åˆ°å“ªé‡Œå»ï¼Ÿ</p><p>æ­£å¸¸ä½¿ç”¨Mutexæ—¶ï¼Œç¡®å®æ˜¯è¿™æ ·çš„ï¼Œå¾ˆç®€å•ï¼ŒåŸºæœ¬ä¸ä¼šæœ‰ä»€ä¹ˆé”™è¯¯ï¼Œå³ä½¿å‡ºç°é”™è¯¯ï¼Œä¹Ÿæ˜¯åœ¨ä¸€äº›å¤æ‚çš„åœºæ™¯ä¸­ï¼Œæ¯”å¦‚è·¨å‡½æ•°è°ƒç”¨Mutexæˆ–è€…æ˜¯åœ¨é‡æ„æˆ–è€…ä¿®è¡¥Bugæ—¶è¯¯æ“ä½œã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨Mutexæ—¶ï¼Œç¡®å®ä¼šå‡ºç°ä¸€äº›Bugï¼Œæ¯”å¦‚è¯´å¿˜è®°é‡Šæ”¾é”ã€é‡å…¥é”ã€å¤åˆ¶å·²ä½¿ç”¨äº†çš„Mutexç­‰æƒ…å†µã€‚é‚£åœ¨è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹ä½¿ç”¨Mutexå¸¸çŠ¯çš„å‡ ä¸ªé”™è¯¯ï¼Œåšåˆ°â€œBugæå‰çŸ¥ï¼Œåé¢æ—©é˜²èŒƒâ€ã€‚</p><h1>å¸¸è§çš„4ç§é”™è¯¯åœºæ™¯</h1><p>æˆ‘æ€»ç»“äº†ä¸€ä¸‹ï¼Œä½¿ç”¨Mutexå¸¸è§çš„é”™è¯¯åœºæ™¯æœ‰4ç±»ï¼Œåˆ†åˆ«æ˜¯Lock/Unlockä¸æ˜¯æˆå¯¹å‡ºç°ã€Copyå·²ä½¿ç”¨çš„Mutexã€é‡å…¥å’Œæ­»é”ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€ä¸€æ¥çœ‹ã€‚</p><h2>Lock/Unlockä¸æ˜¯æˆå¯¹å‡ºç°</h2><p>Lock/Unlockæ²¡æœ‰æˆå¯¹å‡ºç°ï¼Œå°±æ„å‘³ç€ä¼šå‡ºç°æ­»é”çš„æƒ…å†µï¼Œæˆ–è€…æ˜¯å› ä¸ºUnlockä¸€ä¸ªæœªåŠ é”çš„Mutexè€Œå¯¼è‡´panicã€‚</p><!-- [[[read_end]]] --><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç¼ºå°‘Unlockçš„åœºæ™¯ï¼Œå¸¸è§çš„æœ‰ä¸‰ç§æƒ…å†µï¼š</p><ol>\n<li>ä»£ç ä¸­æœ‰å¤ªå¤šçš„if-elseåˆ†æ”¯ï¼Œå¯èƒ½åœ¨æŸä¸ªåˆ†æ”¯ä¸­æ¼å†™äº†Unlockï¼›</li>\n<li>åœ¨é‡æ„çš„æ—¶å€™æŠŠUnlockç»™åˆ é™¤äº†ï¼›</li>\n<li>Unlockè¯¯å†™æˆäº†Lockã€‚</li>\n</ol><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé”è¢«è·å–ä¹‹åï¼Œå°±ä¸ä¼šè¢«é‡Šæ”¾äº†ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå…¶å®ƒçš„goroutineæ°¸è¿œéƒ½æ²¡æœºä¼šè·å–åˆ°é”ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ç¼ºå°‘Lockçš„åœºæ™¯ï¼Œè¿™å°±å¾ˆç®€å•äº†ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯è¯¯æ“ä½œåˆ é™¤äº†Lockã€‚ æ¯”å¦‚å…ˆå‰ä½¿ç”¨Mutexéƒ½æ˜¯æ­£å¸¸çš„ï¼Œç»“æœåæ¥å…¶ä»–äººé‡æ„ä»£ç çš„æ—¶å€™ï¼Œç”±äºå¯¹ä»£ç ä¸ç†Ÿæ‚‰ï¼Œæˆ–è€…ç”±äºå¼€å‘è€…çš„é©¬è™ï¼ŒæŠŠLockè°ƒç”¨ç»™åˆ é™¤äº†ï¼Œæˆ–è€…æ³¨é‡Šæ‰äº†ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œmu.Lock()ä¸€è¡Œä»£ç è¢«åˆ é™¤äº†ï¼Œç›´æ¥Unlockä¸€ä¸ªæœªåŠ é”çš„Mutexä¼španicï¼š</p><pre><code>func foo() {\n    var mu sync.Mutex\n    defer mu.Unlock()\n    fmt.Println(&quot;hello world!&quot;)\n}\n</code></pre><p>è¿è¡Œçš„æ—¶å€™panicï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/55/4f/5597316079a8fa37abef2a82bdac7b4f.png?wh=831*189\" alt=\"\"></p><h2>Copyå·²ä½¿ç”¨çš„Mutex</h2><p>ç¬¬äºŒç§è¯¯ç”¨æ˜¯Copyå·²ä½¿ç”¨çš„Mutexã€‚åœ¨æ­£å¼åˆ†æè¿™ä¸ªé”™è¯¯ä¹‹å‰ï¼Œæˆ‘å…ˆäº¤ä»£ä¸€ä¸ªå°çŸ¥è¯†ç‚¹ï¼Œé‚£å°±æ˜¯Package syncçš„åŒæ­¥åŸè¯­åœ¨ä½¿ç”¨åæ˜¯ä¸èƒ½å¤åˆ¶çš„ã€‚æˆ‘ä»¬çŸ¥é“Mutexæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªåŒæ­¥åŸè¯­ï¼Œé‚£å®ƒä¹Ÿæ˜¯ä¸èƒ½å¤åˆ¶çš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åŸå› åœ¨äºï¼ŒMutexæ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„å¯¹è±¡ï¼Œå®ƒçš„stateå­—æ®µè®°å½•è¿™ä¸ªé”çš„çŠ¶æ€ã€‚å¦‚æœä½ è¦å¤åˆ¶ä¸€ä¸ªå·²ç»åŠ é”çš„Mutexç»™ä¸€ä¸ªæ–°çš„å˜é‡ï¼Œé‚£ä¹ˆæ–°çš„åˆšåˆå§‹åŒ–çš„å˜é‡å±…ç„¶è¢«åŠ é”äº†ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆä½ çš„æœŸæœ›ï¼Œå› ä¸ºä½ æœŸæœ›çš„æ˜¯ä¸€ä¸ªé›¶å€¼çš„Mutexã€‚å…³é”®æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä½ æ ¹æœ¬ä¸çŸ¥é“è¦å¤åˆ¶çš„MutexçŠ¶æ€æ˜¯ä»€ä¹ˆï¼Œå› ä¸ºè¦å¤åˆ¶çš„Mutexæ˜¯ç”±å…¶å®ƒgoroutineå¹¶å‘è®¿é—®çš„ï¼ŒçŠ¶æ€å¯èƒ½æ€»æ˜¯åœ¨å˜åŒ–ã€‚</p><p>å½“ç„¶ï¼Œä½ å¯èƒ½è¯´ï¼Œä½ è¯´çš„æˆ‘éƒ½æ‡‚ï¼Œä½ çš„è­¦å‘Šæˆ‘éƒ½è®°ä¸‹äº†ï¼Œä½†æ˜¯å®é™…åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¸€ä¸å°å¿ƒå°±è¸©äº†è¿™ä¸ªå‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p><pre><code>type Counter struct {\n    sync.Mutex\n    Count int\n}\n\n\nfunc main() {\n    var c Counter\n    c.Lock()\n    defer c.Unlock()\n    c.Count++\n    foo(c) // å¤åˆ¶é”\n}\n\n// è¿™é‡ŒCounterçš„å‚æ•°æ˜¯é€šè¿‡å¤åˆ¶çš„æ–¹å¼ä¼ å…¥çš„\nfunc foo(c Counter) {\n    c.Lock()\n    defer c.Unlock()\n    fmt.Println(&quot;in foo&quot;)\n}\n</code></pre><p>ç¬¬12è¡Œåœ¨è°ƒç”¨fooå‡½æ•°çš„æ—¶å€™ï¼Œè°ƒç”¨è€…ä¼šå¤åˆ¶Mutexå˜é‡cä½œä¸ºfooå‡½æ•°çš„å‚æ•°ï¼Œä¸å¹¸çš„æ˜¯ï¼Œå¤åˆ¶ä¹‹å‰å·²ç»ä½¿ç”¨äº†è¿™ä¸ªé”ï¼Œè¿™å°±å¯¼è‡´ï¼Œå¤åˆ¶çš„Counteræ˜¯ä¸€ä¸ªå¸¦çŠ¶æ€Counterã€‚</p><p>æ€ä¹ˆåŠå‘¢ï¼ŸGoåœ¨è¿è¡Œæ—¶ï¼Œæœ‰<strong>æ­»é”çš„æ£€æŸ¥æœºåˆ¶</strong>ï¼ˆ<a href=\"https://golang.org/src/runtime/proc.go?h=checkdead#L4345\">checkdead()</a>  æ–¹æ³•ï¼‰ï¼Œå®ƒèƒ½å¤Ÿå‘ç°æ­»é”çš„goroutineã€‚è¿™ä¸ªä¾‹å­ä¸­å› ä¸ºå¤åˆ¶äº†ä¸€ä¸ªä½¿ç”¨äº†çš„Mutexï¼Œå¯¼è‡´é”æ— æ³•ä½¿ç”¨ï¼Œç¨‹åºå¤„äºæ­»é”çš„çŠ¶æ€ã€‚ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œæ­»é”æ£€æŸ¥æœºåˆ¶èƒ½å¤Ÿå‘ç°è¿™ç§æ­»é”æƒ…å†µå¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ä¸­é”™è¯¯ä¿¡æ¯ä»¥åŠé”™è¯¯å †æ ˆï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/cf/ee/cfb7a4a0e744c5ff534a676fd830d0ee.png?wh=777*251\" alt=\"\"></p><p>ä½ è‚¯å®šä¸æƒ³è¿è¡Œçš„æ—¶å€™æ‰å‘ç°è¿™ä¸ªå› ä¸ºå¤åˆ¶Mutexå¯¼è‡´çš„æ­»é”é—®é¢˜ï¼Œé‚£ä¹ˆä½ æ€ä¹ˆèƒ½å¤ŸåŠæ—¶å‘ç°é—®é¢˜å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨<strong>vetå·¥å…·</strong>ï¼ŒæŠŠæ£€æŸ¥å†™åœ¨Makefileæ–‡ä»¶ä¸­ï¼Œåœ¨æŒç»­é›†æˆçš„æ—¶å€™è·‘ä¸€è·‘ï¼Œè¿™æ ·å¯ä»¥åŠæ—¶å‘ç°é—®é¢˜ï¼ŒåŠæ—¶ä¿®å¤ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨go vetæ£€æŸ¥è¿™ä¸ªGoæ–‡ä»¶ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/fa/b8/fa56520yy37009ca58d6640a933f01b8.png?wh=665*94\" alt=\"\"></p><p>ä½ çœ‹ï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å°±å¯ä»¥å‘ç°Mutexå¤åˆ¶çš„é—®é¢˜ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤ºå¾—å¾ˆæ¸…æ¥šï¼Œæ˜¯åœ¨è°ƒç”¨fooå‡½æ•°çš„æ—¶å€™å‘ç”Ÿäº†lock valueå¤åˆ¶çš„æƒ…å†µï¼Œè¿˜å‘Šè¯‰æˆ‘ä»¬å‡ºé—®é¢˜çš„ä»£ç è¡Œæ•°ä»¥åŠcopy lockå¯¼è‡´çš„é”™è¯¯ã€‚</p><p>é‚£ä¹ˆï¼Œvetå·¥å…·æ˜¯æ€ä¹ˆå‘ç°Mutexå¤åˆ¶ä½¿ç”¨é—®é¢˜çš„å‘¢ï¼Ÿæˆ‘å¸¦ä½ ç®€å•åˆ†æä¸€ä¸‹ã€‚</p><p>æ£€æŸ¥æ˜¯é€šè¿‡<a href=\"https://github.com/golang/tools/blob/master/go/analysis/passes/copylock/copylock.go\">copylock</a>åˆ†æå™¨é™æ€åˆ†æå®ç°çš„ã€‚è¿™ä¸ªåˆ†æå™¨ä¼šåˆ†æå‡½æ•°è°ƒç”¨ã€rangeéå†ã€å¤åˆ¶ã€å£°æ˜ã€å‡½æ•°è¿”å›å€¼ç­‰ä½ç½®ï¼Œæœ‰æ²¡æœ‰é”çš„å€¼copyçš„æƒ…æ™¯ï¼Œä»¥æ­¤æ¥åˆ¤æ–­æœ‰æ²¡æœ‰é—®é¢˜ã€‚å¯ä»¥è¯´ï¼Œåªè¦æ˜¯å®ç°äº†Lockeræ¥å£ï¼Œå°±ä¼šè¢«åˆ†æã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸‹é¢çš„ä»£ç å°±æ˜¯ç¡®å®šä»€ä¹ˆç±»å‹ä¼šè¢«åˆ†æï¼Œå…¶å®å°±æ˜¯å®ç°äº†Lock/Unlockä¸¤ä¸ªæ–¹æ³•çš„Lockeræ¥å£ï¼š</p><pre><code>var lockerType *types.Interface\n\t\n\t// Construct a sync.Locker interface type.\n\tfunc init() {\n\t\tnullary := types.NewSignature(nil, nil, nil, false) // func()\n\t\tmethods := []*types.Func{\n\t\t\ttypes.NewFunc(token.NoPos, nil, &quot;Lock&quot;, nullary),\n\t\t\ttypes.NewFunc(token.NoPos, nil, &quot;Unlock&quot;, nullary),\n\t\t}\n\t\tlockerType = types.NewInterface(methods, nil).Complete()\n\t}\n</code></pre><p>å…¶å®ï¼Œæœ‰äº›æ²¡æœ‰å®ç°Lockeræ¥å£çš„åŒæ­¥åŸè¯­ï¼ˆæ¯”å¦‚WaitGroupï¼‰ï¼Œä¹Ÿèƒ½è¢«åˆ†æã€‚æˆ‘å…ˆå–ä¸ªå…³å­ï¼Œåé¢æˆ‘ä»¬ä¼šä»‹ç»è¿™ç§æƒ…å†µæ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><h2>é‡å…¥</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è®¨è®ºâ€œé‡å…¥â€è¿™ä¸ªé—®é¢˜ã€‚åœ¨è¯´è¿™ä¸ªé—®é¢˜å‰ï¼Œæˆ‘å…ˆè§£é‡Šä¸€ä¸‹ä¸ªæ¦‚å¿µï¼Œå«â€œå¯é‡å…¥é”â€ã€‚</p><p>å¦‚æœä½ å­¦è¿‡Javaï¼Œå¯èƒ½ä¼šå¾ˆç†Ÿæ‚‰ReentrantLockï¼Œå°±æ˜¯å¯é‡å…¥é”ï¼Œè¿™æ˜¯Javaå¹¶å‘åŒ…ä¸­éå¸¸å¸¸ç”¨çš„ä¸€ä¸ªåŒæ­¥åŸè¯­ã€‚å®ƒçš„åŸºæœ¬è¡Œä¸ºå’Œäº’æ–¥é”ç›¸åŒï¼Œä½†æ˜¯åŠ äº†ä¸€äº›æ‰©å±•åŠŸèƒ½ã€‚</p><p>å¦‚æœä½ æ²¡æ¥è§¦è¿‡Javaï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œè¿™é‡Œåªæ˜¯æä¸€ä¸‹ï¼Œå¸®åŠ©ä¼šJavaçš„åŒå­¦å¯¹æ¯”æ¥å­¦ã€‚é‚£ä¸‹é¢æˆ‘æ¥å…·ä½“è®²è§£å¯é‡å…¥é”æ˜¯å’‹å›äº‹å„¿ã€‚</p><p>å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçº¿ç¨‹æ‹¥æœ‰è¿™ä¸ªé”ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªçº¿ç¨‹å°±æˆåŠŸè·å–åˆ°è¿™ä¸ªé”ã€‚ä¹‹åï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹å†è¯·æ±‚è¿™ä¸ªé”ï¼Œå°±ä¼šå¤„äºé˜»å¡ç­‰å¾…çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‹¥æœ‰è¿™æŠŠé”çš„çº¿ç¨‹å†è¯·æ±‚è¿™æŠŠé”çš„è¯ï¼Œä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯æˆåŠŸè¿”å›ï¼Œæ‰€ä»¥å«å¯é‡å…¥é”ï¼ˆæœ‰æ—¶å€™ä¹Ÿå«åšé€’å½’é”ï¼‰ã€‚åªè¦ä½ æ‹¥æœ‰è¿™æŠŠé”ï¼Œä½ å¯ä»¥å¯ç€åŠ²å„¿åœ°è°ƒç”¨ï¼Œæ¯”å¦‚é€šè¿‡é€’å½’å®ç°ä¸€äº›ç®—æ³•ï¼Œè°ƒç”¨è€…ä¸ä¼šé˜»å¡æˆ–è€…æ­»é”ã€‚</p><p>äº†è§£äº†å¯é‡å…¥é”çš„æ¦‚å¿µï¼Œé‚£æˆ‘ä»¬æ¥çœ‹Mutexä½¿ç”¨çš„é”™è¯¯åœºæ™¯ã€‚åˆ’é‡ç‚¹äº†ï¼š<strong>Mutexä¸æ˜¯å¯é‡å…¥çš„é”ã€‚</strong></p><p>æƒ³æƒ³ä¹Ÿä¸å¥‡æ€ªï¼Œå› ä¸ºMutexçš„å®ç°ä¸­æ²¡æœ‰è®°å½•å“ªä¸ªgoroutineæ‹¥æœ‰è¿™æŠŠé”ã€‚ç†è®ºä¸Šï¼Œä»»ä½•goroutineéƒ½å¯ä»¥éšæ„åœ°Unlockè¿™æŠŠé”ï¼Œæ‰€ä»¥æ²¡åŠæ³•è®¡ç®—é‡å…¥æ¡ä»¶ï¼Œæ¯•ç«Ÿï¼Œâ€œè‡£å¦¾åšä¸åˆ°å•Šâ€ï¼</p><p>æ‰€ä»¥ï¼Œä¸€æ—¦è¯¯ç”¨Mutexçš„é‡å…¥ï¼Œå°±ä¼šå¯¼è‡´æŠ¥é”™ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè¯¯ç”¨Mutexçš„é‡å…¥ä¾‹å­ï¼š</p><pre><code>func foo(l sync.Locker) {\n    fmt.Println(&quot;in foo&quot;)\n    l.Lock()\n    bar(l)\n    l.Unlock()\n}\n\n\nfunc bar(l sync.Locker) {\n    l.Lock()\n    fmt.Println(&quot;in bar&quot;)\n    l.Unlock()\n}\n\n\nfunc main() {\n    l := &amp;sync.Mutex{}\n    foo(l)\n}\n</code></pre><p>å†™å®Œè¿™ä¸ªMutexé‡å…¥çš„ä¾‹å­åï¼Œè¿è¡Œä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°ç±»ä¼¼ä¸‹é¢çš„é”™è¯¯ã€‚ç¨‹åºä¸€ç›´åœ¨è¯·æ±‚é”ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰åŠæ³•è·å–åˆ°é”ï¼Œç»“æœå°±æ˜¯Goè¿è¡Œæ—¶å‘ç°æ­»é”äº†ï¼Œæ²¡æœ‰å…¶å®ƒåœ°æ–¹èƒ½å¤Ÿé‡Šæ”¾é”è®©ç¨‹åºè¿è¡Œä¸‹å»ï¼Œä½ é€šè¿‡ä¸‹é¢çš„é”™è¯¯å †æ ˆä¿¡æ¯å°±èƒ½å®šä½åˆ°å“ªä¸€è¡Œé˜»å¡è¯·æ±‚é”ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/0b/79/0bc98ef74c15d9640806d52bf030f979.png?wh=855*299\" alt=\"\"></p><p>å­¦åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½è¦é—®äº†ï¼Œè™½ç„¶æ ‡å‡†åº“Mutexä¸æ˜¯å¯é‡å…¥é”ï¼Œä½†æ˜¯å¦‚æœæˆ‘å°±æ˜¯æƒ³è¦å®ç°ä¸€ä¸ªå¯é‡å…¥é”ï¼Œå¯ä»¥å—ï¼Ÿ</p><p>å¯ä»¥ï¼Œé‚£æˆ‘ä»¬å°±è‡ªå·±å®ç°ä¸€ä¸ªã€‚è¿™é‡Œçš„å…³é”®å°±æ˜¯ï¼Œå®ç°çš„é”è¦èƒ½è®°ä½å½“å‰æ˜¯å“ªä¸ªgoroutineæŒæœ‰è¿™ä¸ªé”ã€‚æˆ‘æ¥æä¾›ä¸¤ä¸ªæ–¹æ¡ˆã€‚</p><ul>\n<li>æ–¹æ¡ˆä¸€ï¼šé€šè¿‡hackerçš„æ–¹å¼è·å–åˆ°goroutine idï¼Œè®°å½•ä¸‹è·å–é”çš„goroutine idï¼Œå®ƒå¯ä»¥å®ç°Lockeræ¥å£ã€‚</li>\n<li>æ–¹æ¡ˆäºŒï¼šè°ƒç”¨Lock/Unlockæ–¹æ³•æ—¶ï¼Œç”±goroutineæä¾›ä¸€ä¸ªtokenï¼Œç”¨æ¥æ ‡è¯†å®ƒè‡ªå·±ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬é€šè¿‡hackerçš„æ–¹å¼è·å–åˆ°goroutine idï¼Œä½†æ˜¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±ä¸æ»¡è¶³Lockeræ¥å£äº†ã€‚</li>\n</ul><p>å¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰è§£å†³äº†ä»£ç é‡å…¥æˆ–è€…é€’å½’è°ƒç”¨å¸¦æ¥çš„æ­»é”é—®é¢˜ï¼ŒåŒæ—¶å®ƒä¹Ÿå¸¦æ¥äº†å¦ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥è¦æ±‚ï¼Œåªæœ‰æŒæœ‰é”çš„goroutineæ‰èƒ½unlockè¿™ä¸ªé”ã€‚è¿™ä¹Ÿå¾ˆå®¹æ˜“å®ç°ï¼Œå› ä¸ºåœ¨ä¸Šé¢è¿™ä¸¤ä¸ªæ–¹æ¡ˆä¸­ï¼Œéƒ½å·²ç»è®°å½•äº†æ˜¯å“ªä¸€ä¸ªgoroutineæŒæœ‰è¿™ä¸ªé”ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å…·ä½“æ¥çœ‹è¿™ä¸¤ä¸ªæ–¹æ¡ˆæ€ä¹ˆå®ç°ã€‚</p><p><strong>æ–¹æ¡ˆä¸€</strong>ï¼š<strong>goroutine id</strong></p><p>è¿™ä¸ªæ–¹æ¡ˆçš„å…³é”®ç¬¬ä¸€æ­¥æ˜¯è·å–goroutine idï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ç®€å•æ–¹å¼å’Œhackeræ–¹å¼ã€‚</p><p>ç®€å•æ–¹å¼ï¼Œå°±æ˜¯é€šè¿‡runtime.Stackæ–¹æ³•è·å–æ ˆå¸§ä¿¡æ¯ï¼Œæ ˆå¸§ä¿¡æ¯é‡ŒåŒ…å«goroutine idã€‚ä½ å¯ä»¥çœ‹çœ‹ä¸Šé¢panicæ—¶å€™çš„è´´å›¾ï¼Œgoroutine idæ˜æ˜ç™½ç™½åœ°æ˜¾ç¤ºåœ¨é‚£é‡Œã€‚runtime.Stackæ–¹æ³•å¯ä»¥è·å–å½“å‰çš„goroutineä¿¡æ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºtrueä¼šè¾“å‡ºæ‰€æœ‰çš„goroutineä¿¡æ¯ï¼Œä¿¡æ¯çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><pre><code>goroutine 1 [running]:\nmain.main()\n        ....../main.go:19 +0xb1\n</code></pre><p>ç¬¬ä¸€è¡Œæ ¼å¼ä¸ºgoroutine xxxï¼Œå…¶ä¸­xxxå°±æ˜¯goroutine idï¼Œä½ åªè¦è§£æå‡ºè¿™ä¸ªidå³å¯ã€‚è§£æçš„æ–¹æ³•å¯ä»¥é‡‡ç”¨ä¸‹é¢çš„ä»£ç ï¼š</p><pre><code>func GoID() int {\n    var buf [64]byte\n    n := runtime.Stack(buf[:], false)\n    // å¾—åˆ°idå­—ç¬¦ä¸²\n    idField := strings.Fields(strings.TrimPrefix(string(buf[:n]), &quot;goroutine &quot;))[0]\n    id, err := strconv.Atoi(idField)\n    if err != nil {\n        panic(fmt.Sprintf(&quot;cannot get goroutine id: %v&quot;, err))\n    }\n    return id\n}\n</code></pre><p>äº†è§£äº†ç®€å•æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹hackerçš„æ–¹å¼ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ–¹æ¡ˆä¸€é‡‡å–çš„æ–¹å¼ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è·å–è¿è¡Œæ—¶çš„gæŒ‡é’ˆï¼Œåè§£å‡ºå¯¹åº”çš„gçš„ç»“æ„ã€‚æ¯ä¸ªè¿è¡Œçš„goroutineç»“æ„çš„gæŒ‡é’ˆä¿å­˜åœ¨å½“å‰goroutineçš„ä¸€ä¸ªå«åšTLSå¯¹è±¡ä¸­ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼šæˆ‘ä»¬å…ˆè·å–åˆ°TLSå¯¹è±¡ï¼›</p><p>ç¬¬äºŒæ­¥ï¼šå†ä»TLSä¸­è·å–goroutineç»“æ„çš„gæŒ‡é’ˆï¼›</p><p>ç¬¬ä¸‰æ­¥ï¼šå†ä»gæŒ‡é’ˆä¸­å–å‡ºgoroutine idã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åŒGoç‰ˆæœ¬çš„goroutineçš„ç»“æ„å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®Goçš„<a href=\"https://github.com/golang/go/blob/89f687d6dbc11613f715d1644b4983905293dd33/src/runtime/runtime2.go#L412\">ä¸åŒç‰ˆæœ¬</a>è¿›è¡Œè°ƒæ•´ã€‚å½“ç„¶äº†ï¼Œå¦‚æœæƒ³è¦ææ¸…æ¥šå„ä¸ªç‰ˆæœ¬çš„goroutineç»“æ„å·®å¼‚ï¼Œæ‰€æ¶‰åŠçš„å†…å®¹åˆè¿‡äºåº•å±‚è€Œä¸”å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬å¤ªé«˜ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é‡ç‚¹å…³æ³¨ä¸€äº›åº“ã€‚æˆ‘ä»¬æ²¡æœ‰å¿…è¦é‡å¤å‘æ˜è½®å­ï¼Œç›´æ¥ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„åº“æ¥è·å–goroutine idå°±å¯ä»¥äº†ã€‚</p><p>å¥½æ¶ˆæ¯æ˜¯ç°åœ¨å·²ç»æœ‰å¾ˆå¤šæˆç†Ÿçš„æ–¹æ³•äº†ï¼Œå¯ä»¥æ”¯æŒå¤šä¸ªGoç‰ˆæœ¬çš„goroutine idï¼Œç»™ä½ æ¨èä¸€ä¸ªå¸¸ç”¨çš„åº“ï¼š<a href=\"https://github.com/petermattis/goid\">petermattis/goid</a>ã€‚</p><p>çŸ¥é“äº†å¦‚ä½•è·å–goroutine idï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœ€åçš„å…³é”®ä¸€æ­¥äº†ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„å¯é‡å…¥é”ï¼š</p><pre><code>// RecursiveMutex åŒ…è£…ä¸€ä¸ªMutex,å®ç°å¯é‡å…¥\ntype RecursiveMutex struct {\n    sync.Mutex\n    owner     int64 // å½“å‰æŒæœ‰é”çš„goroutine id\n    recursion int32 // è¿™ä¸ªgoroutine é‡å…¥çš„æ¬¡æ•°\n}\n\nfunc (m *RecursiveMutex) Lock() {\n    gid := goid.Get()\n    // å¦‚æœå½“å‰æŒæœ‰é”çš„goroutineå°±æ˜¯è¿™æ¬¡è°ƒç”¨çš„goroutine,è¯´æ˜æ˜¯é‡å…¥\n    if atomic.LoadInt64(&amp;m.owner) == gid {\n        m.recursion++\n        return\n    }\n    m.Mutex.Lock()\n    // è·å¾—é”çš„goroutineç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œè®°å½•ä¸‹å®ƒçš„goroutine id,è°ƒç”¨æ¬¡æ•°åŠ 1\n    atomic.StoreInt64(&amp;m.owner, gid)\n    m.recursion = 1\n}\n\nfunc (m *RecursiveMutex) Unlock() {\n    gid := goid.Get()\n    // éæŒæœ‰é”çš„goroutineå°è¯•é‡Šæ”¾é”ï¼Œé”™è¯¯çš„ä½¿ç”¨\n    if atomic.LoadInt64(&amp;m.owner) != gid {\n        panic(fmt.Sprintf(&quot;wrong the owner(%d): %d!&quot;, m.owner, gid))\n    }\n    // è°ƒç”¨æ¬¡æ•°å‡1\n    m.recursion--\n    if m.recursion != 0 { // å¦‚æœè¿™ä¸ªgoroutineè¿˜æ²¡æœ‰å®Œå…¨é‡Šæ”¾ï¼Œåˆ™ç›´æ¥è¿”å›\n        return\n    }\n    // æ­¤goroutineæœ€åä¸€æ¬¡è°ƒç”¨ï¼Œéœ€è¦é‡Šæ”¾é”\n    atomic.StoreInt64(&amp;m.owner, -1)\n    m.Mutex.Unlock()\n}\n</code></pre><p>ä¸Šé¢è¿™æ®µä»£ç ä½ å¯ä»¥æ‹¿æ¥å³ç”¨ã€‚æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹è¿™ä¸ªå®ç°ï¼ŒçœŸæ˜¯éå¸¸å·§å¦™ï¼Œå®ƒç›¸å½“äºç»™Mutexæ‰“ä¸€ä¸ªè¡¥ä¸ï¼Œè§£å†³äº†è®°å½•é”çš„æŒæœ‰è€…çš„é—®é¢˜ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç”¨ownerå­—æ®µï¼Œè®°å½•å½“å‰é”çš„æ‹¥æœ‰è€…goroutineçš„idï¼›recursion æ˜¯è¾…åŠ©å­—æ®µï¼Œç”¨äºè®°å½•é‡å…¥çš„æ¬¡æ•°ã€‚</p><p>æœ‰ä¸€ç‚¹ï¼Œæˆ‘è¦æé†’ä½ ä¸€å¥ï¼Œå°½ç®¡æ‹¥æœ‰è€…å¯ä»¥å¤šæ¬¡è°ƒç”¨Lockï¼Œä½†æ˜¯ä¹Ÿå¿…é¡»è°ƒç”¨ç›¸åŒæ¬¡æ•°çš„Unlockï¼Œè¿™æ ·æ‰èƒ½æŠŠé”é‡Šæ”¾æ‰ã€‚è¿™æ˜¯ä¸€ä¸ªåˆç†çš„è®¾è®¡ï¼Œå¯ä»¥ä¿è¯Lockå’ŒUnlockä¸€ä¸€å¯¹åº”ã€‚</p><p><strong>æ–¹æ¡ˆäºŒ</strong>ï¼š<strong>token</strong></p><p>æ–¹æ¡ˆä¸€æ˜¯ç”¨goroutine idåšgoroutineçš„æ ‡è¯†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®©goroutineè‡ªå·±æ¥æä¾›æ ‡è¯†ã€‚ä¸ç®¡æ€ä¹ˆè¯´ï¼ŒGoå¼€å‘è€…ä¸æœŸæœ›ä½ åˆ©ç”¨goroutine idåšä¸€äº›ä¸ç¡®å®šçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ï¼Œä»–ä»¬æ²¡æœ‰æš´éœ²è·å–goroutine idçš„æ–¹æ³•ã€‚</p><p>ä¸‹é¢çš„ä»£ç æ˜¯ç¬¬äºŒç§æ–¹æ¡ˆã€‚è°ƒç”¨è€…è‡ªå·±æä¾›ä¸€ä¸ªtokenï¼Œè·å–é”çš„æ—¶å€™æŠŠè¿™ä¸ªtokenä¼ å…¥ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ä¹Ÿéœ€è¦æŠŠè¿™ä¸ªtokenä¼ å…¥ã€‚é€šè¿‡ç”¨æˆ·ä¼ å…¥çš„tokenæ›¿æ¢æ–¹æ¡ˆä¸€ä¸­goroutine idï¼Œå…¶å®ƒé€»è¾‘å’Œæ–¹æ¡ˆä¸€ä¸€è‡´ã€‚</p><pre><code>// Tokenæ–¹å¼çš„é€’å½’é”\ntype TokenRecursiveMutex struct {\n    sync.Mutex\n    token     int64\n    recursion int32\n}\n\n// è¯·æ±‚é”ï¼Œéœ€è¦ä¼ å…¥token\nfunc (m *TokenRecursiveMutex) Lock(token int64) {\n    if atomic.LoadInt64(&amp;m.token) == token { //å¦‚æœä¼ å…¥çš„tokenå’ŒæŒæœ‰é”çš„tokenä¸€è‡´ï¼Œè¯´æ˜æ˜¯é€’å½’è°ƒç”¨\n        m.recursion++\n        return\n    }\n    m.Mutex.Lock() // ä¼ å…¥çš„tokenä¸ä¸€è‡´ï¼Œè¯´æ˜ä¸æ˜¯é€’å½’è°ƒç”¨\n    // æŠ¢åˆ°é”ä¹‹åè®°å½•è¿™ä¸ªtoken\n    atomic.StoreInt64(&amp;m.token, token)\n    m.recursion = 1\n}\n\n// é‡Šæ”¾é”\nfunc (m *TokenRecursiveMutex) Unlock(token int64) {\n    if atomic.LoadInt64(&amp;m.token) != token { // é‡Šæ”¾å…¶å®ƒtokenæŒæœ‰çš„é”\n        panic(fmt.Sprintf(&quot;wrong the owner(%d): %d!&quot;, m.token, token))\n    }\n    m.recursion-- // å½“å‰æŒæœ‰è¿™ä¸ªé”çš„tokené‡Šæ”¾é”\n    if m.recursion != 0 { // è¿˜æ²¡æœ‰å›é€€åˆ°æœ€åˆçš„é€’å½’è°ƒç”¨\n        return\n    }\n    atomic.StoreInt64(&amp;m.token, 0) // æ²¡æœ‰é€’å½’è°ƒç”¨äº†ï¼Œé‡Šæ”¾é”\n    m.Mutex.Unlock()\n}\n\n</code></pre><h2>æ­»é”</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ç¬¬å››ç§é”™è¯¯åœºæ™¯ï¼šæ­»é”ã€‚</p><p>æˆ‘å…ˆè§£é‡Šä¸‹ä»€ä¹ˆæ˜¯æ­»é”ã€‚ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼Œgoroutineï¼‰åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºå…±äº«èµ„æºè€Œå¤„äºä¸€ç§äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰å¤–éƒ¨å¹²æ¶‰ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ã€‚</p><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶ã€‚å¦‚æœä½ æƒ³é¿å…æ­»é”ï¼Œåªè¦ç ´åè¿™å››ä¸ªæ¡ä»¶ä¸­çš„ä¸€ä¸ªæˆ–è€…å‡ ä¸ªï¼Œå°±å¯ä»¥äº†ã€‚</p><ol>\n<li><strong>äº’æ–¥</strong>ï¼š è‡³å°‘ä¸€ä¸ªèµ„æºæ˜¯è¢«æ’ä»–æ€§ç‹¬äº«çš„ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°èµ„æºè¢«é‡Šæ”¾ã€‚</li>\n<li><strong>æŒæœ‰å’Œç­‰å¾…</strong>ï¼šgoroutineæŒæœ‰ä¸€ä¸ªèµ„æºï¼Œå¹¶ä¸”è¿˜åœ¨è¯·æ±‚å…¶å®ƒgoroutineæŒæœ‰çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯å’±ä»¬å¸¸è¯´çš„â€œåƒç€ç¢—é‡Œï¼Œçœ‹ç€é”…é‡Œâ€çš„æ„æ€ã€‚</li>\n<li><strong>ä¸å¯å‰¥å¤º</strong>ï¼šèµ„æºåªèƒ½ç”±æŒæœ‰å®ƒçš„goroutineæ¥é‡Šæ”¾ã€‚</li>\n<li><strong>ç¯è·¯ç­‰å¾…</strong>ï¼šä¸€èˆ¬æ¥è¯´ï¼Œå­˜åœ¨ä¸€ç»„ç­‰å¾…è¿›ç¨‹ï¼ŒP={P1ï¼ŒP2ï¼Œâ€¦ï¼ŒPN}ï¼ŒP1ç­‰å¾…P2æŒæœ‰çš„èµ„æºï¼ŒP2ç­‰å¾…P3æŒæœ‰çš„èµ„æºï¼Œä¾æ­¤ç±»æ¨ï¼Œæœ€åæ˜¯PNç­‰å¾…P1æŒæœ‰çš„èµ„æºï¼Œè¿™å°±å½¢æˆäº†ä¸€ä¸ªç¯è·¯ç­‰å¾…çš„æ­»ç»“ã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/4a/d5/4ace1eecf856ef80607yyb6f7a45abd5.jpg?wh=2106*1597\" alt=\"\"></p><p>ä½ çœ‹ï¼Œæ­»é”é—®é¢˜è¿˜çœŸæ˜¯æŒºæœ‰æ„æ€çš„ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šäººç ”ç©¶è¿™ä¸ªäº‹å„¿ã€‚ä¸€ä¸ªç»å…¸çš„æ­»é”é—®é¢˜å°±æ˜¯<a href=\"https://zh.wikipedia.org/wiki/%E5%93%B2%E5%AD%A6%E5%AE%B6%E5%B0%B1%E9%A4%90%E9%97%AE%E9%A2%98\">å“²å­¦å®¶å°±é¤é—®é¢˜</a>ï¼Œæˆ‘ä¸åšä»‹ç»äº†ï¼Œä½ å¯ä»¥ç‚¹å‡»é“¾æ¥è¿›ä¸€æ­¥äº†è§£ã€‚å…¶å®ï¼Œæ­»é”é—®é¢˜åœ¨ç°å®ç”Ÿæ´»ä¸­ä¹Ÿæ¯”æ¯”çš†æ˜¯ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ã€‚æœ‰ä¸€æ¬¡æˆ‘å»æ´¾å‡ºæ‰€å¼€è¯æ˜ï¼Œæ´¾å‡ºæ‰€è¦æ±‚ç‰©ä¸šå…ˆè¯æ˜æˆ‘æ˜¯æœ¬ç‰©ä¸šçš„ä¸šä¸»ï¼Œä½†æ˜¯ï¼Œç‰©ä¸šè¦æˆ‘æä¾›æ´¾å‡ºæ‰€çš„è¯æ˜ï¼Œæ‰èƒ½ç»™æˆ‘å¼€ç‰©ä¸šè¯æ˜ï¼Œç»“æœå°±é™·å…¥äº†æ­»é”çŠ¶æ€ã€‚ä½ å¯ä»¥æŠŠæ´¾å‡ºæ‰€å’Œç‰©ä¸šçœ‹æˆä¸¤ä¸ªgoroutineï¼Œæ´¾å‡ºæ‰€è¯æ˜å’Œç‰©ä¸šè¯æ˜æ˜¯ä¸¤ä¸ªèµ„æºï¼ŒåŒæ–¹éƒ½æŒæœ‰è‡ªå·±çš„èµ„æºè€Œè¦æ±‚å¯¹æ–¹çš„èµ„æºï¼Œè€Œä¸”è‡ªå·±çš„èµ„æºè‡ªå·±æŒæœ‰ï¼Œä¸å¯å‰¥å¤ºã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„åªæœ‰ä¸¤ä¸ªgoroutineç›¸äº’ç­‰å¾…çš„æ­»é”çš„ä¾‹å­ï¼Œè½¬åŒ–æˆä»£ç å¦‚ä¸‹ï¼š</p><pre><code>package main\n\n\nimport (\n    &quot;fmt&quot;\n    &quot;sync&quot;\n    &quot;time&quot;\n)\n\n\nfunc main() {\n    // æ´¾å‡ºæ‰€è¯æ˜\n    var psCertificate sync.Mutex\n    // ç‰©ä¸šè¯æ˜\n    var propertyCertificate sync.Mutex\n\n\n    var wg sync.WaitGroup\n    wg.Add(2) // éœ€è¦æ´¾å‡ºæ‰€å’Œç‰©ä¸šéƒ½å¤„ç†\n\n\n    // æ´¾å‡ºæ‰€å¤„ç†goroutine\n    go func() {\n        defer wg.Done() // æ´¾å‡ºæ‰€å¤„ç†å®Œæˆ\n\n\n        psCertificate.Lock()\n        defer psCertificate.Unlock()\n\n\n        // æ£€æŸ¥ææ–™\n        time.Sleep(5 * time.Second)\n        // è¯·æ±‚ç‰©ä¸šçš„è¯æ˜\n        propertyCertificate.Lock()\n        propertyCertificate.Unlock()\n    }()\n\n\n    // ç‰©ä¸šå¤„ç†goroutine\n    go func() {\n        defer wg.Done() // ç‰©ä¸šå¤„ç†å®Œæˆ\n\n\n        propertyCertificate.Lock()\n        defer propertyCertificate.Unlock()\n\n\n        // æ£€æŸ¥ææ–™\n        time.Sleep(5 * time.Second)\n        // è¯·æ±‚æ´¾å‡ºæ‰€çš„è¯æ˜\n        psCertificate.Lock()\n        psCertificate.Unlock()\n    }()\n\n\n    wg.Wait()\n    fmt.Println(&quot;æˆåŠŸå®Œæˆ&quot;)\n}\n</code></pre><p>è¿™ä¸ªç¨‹åºæ²¡æœ‰åŠæ³•è¿è¡ŒæˆåŠŸï¼Œå› ä¸ºæ´¾å‡ºæ‰€çš„å¤„ç†å’Œç‰©ä¸šçš„å¤„ç†æ˜¯ä¸€ä¸ªç¯è·¯ç­‰å¾…çš„æ­»ç»“ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3e/f4/3ea07805dea9d33d5a5c1a8244a7ccf4.png?wh=854*262\" alt=\"\"></p><p>Goè¿è¡Œæ—¶ï¼Œæœ‰æ­»é”æ¢æµ‹çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿæ£€æŸ¥å‡ºæ˜¯å¦å‡ºç°äº†æ­»é”çš„æƒ…å†µï¼Œå¦‚æœå‡ºç°äº†ï¼Œè¿™ä¸ªæ—¶å€™ä½ å°±éœ€è¦è°ƒæ•´ç­–ç•¥æ¥å¤„ç†äº†ã€‚</p><p>ä½ å¯ä»¥å¼•å…¥ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„é”ï¼Œå¤§å®¶éƒ½ä¾èµ–è¿™ä¸ªé”è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œæ¯”å¦‚ç°åœ¨æ”¿åºœæ¨è¡Œçš„ä¸€ç«™å¼æ”¿åŠ¡æœåŠ¡ä¸­å¿ƒã€‚æˆ–è€…æ˜¯è§£å†³æŒæœ‰ç­‰å¾…é—®é¢˜ï¼Œç‰©ä¸šä¸éœ€è¦çœ‹åˆ°æ´¾å‡ºæ‰€çš„è¯æ˜æ‰ç»™å¼€ç‰©ä¸šè¯æ˜ï¼Œç­‰ç­‰ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ç»™ä½ è®²äº†ä½¿ç”¨Mutexå¸¸è§çš„4ç±»é—®é¢˜ã€‚ä½ æ˜¯ä¸æ˜¯è§‰å¾—ï¼Œå“å‘€ï¼Œè¿™å‡ ç±»é—®é¢˜ä¹Ÿå¤ªä¸åº”è¯¥äº†å§ï¼ŒçœŸçš„ä¼šæœ‰äººçŠ¯è¿™ä¹ˆåŸºç¡€çš„é”™è¯¯å—ï¼Ÿ</p><p>è¿˜çœŸæ˜¯æœ‰ã€‚è™½ç„¶Mutexä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯ï¼Œä»ç„¶å¯èƒ½å‡ºç°ä½¿ç”¨é”™è¯¯çš„é—®é¢˜ã€‚è€Œä¸”ï¼Œå°±è¿ä¸€äº›ç»éªŒä¸°å¯Œçš„å¼€å‘äººå‘˜ï¼Œä¹Ÿä¼šå‡ºç°ä¸€äº›Mutexä½¿ç”¨çš„é—®é¢˜ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°±å¸¦ä½ å›´è§‚å‡ ä¸ªéå¸¸æµè¡Œçš„Goå¼€å‘é¡¹ç›®ï¼Œçœ‹çœ‹è¿™äº›é”™è¯¯æ˜¯æ€ä¹ˆäº§ç”Ÿå’Œä¿®å¤çš„ã€‚</p><h1>æµè¡Œçš„Goå¼€å‘é¡¹ç›®è¸©å‘è®°</h1><h2>Docker</h2><p>Docker å®¹å™¨æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œå¼€å‘è€…å¯ä»¥ä»¥ç»Ÿä¸€çš„æ–¹å¼ï¼ŒæŠŠä»–ä»¬çš„åº”ç”¨å’Œä¾èµ–åŒ…æ‰“åŒ…åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„å®¹å™¨ä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•å®‰è£…äº†dockerå¼•æ“çš„æœåŠ¡å™¨ä¸Šã€‚</p><p>Dockeræ˜¯ä½¿ç”¨Goå¼€å‘çš„ï¼Œä¹Ÿç®—æ˜¯Goçš„ä¸€ä¸ªæ€æ‰‹çº§äº§å“äº†ï¼Œå®ƒçš„Mutexç›¸å…³çš„Bugä¹Ÿä¸å°‘ï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå…¸å‹çš„Bugã€‚</p><h3>issue 36114</h3><p>Dockerçš„<a href=\"https://github.com/moby/moby/pull/36114/files\">issue 36114</a> æ˜¯ä¸€ä¸ªæ­»é”é—®é¢˜ã€‚</p><p>åŸå› åœ¨äºï¼ŒhotAddVHDsAtStartæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰§è¡Œäº†åŠ é”svmæ“ä½œã€‚ä½†æ˜¯ï¼Œåœ¨å…¶ä¸­è°ƒç”¨hotRemoveVHDsAtStartæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªhotRemoveVHDsAtStartæ–¹æ³•ä¹Ÿæ˜¯è¦åŠ é”svmçš„ã€‚å¾ˆä¸å¹¸ï¼ŒGoæ ‡å‡†åº“ä¸­çš„Mutexæ˜¯ä¸å¯é‡å…¥çš„ï¼Œæ‰€ä»¥ï¼Œä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå°±å‡ºç°äº†æ­»é”çš„ç°è±¡ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/da/8c/dac838666ee09c98dd9ac5db479aae8c.png?wh=1206*654\" alt=\"\"></p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œè§£å†³åŠæ³•å°±æ˜¯ï¼Œå†æä¾›ä¸€ä¸ªä¸éœ€è¦é”çš„hotRemoveVHDsNoLockæ–¹æ³•ï¼Œé¿å…Mutexçš„é‡å…¥ã€‚</p><h3>issue 34881</h3><p><a href=\"https://github.com/moby/moby/pull/34881/files\">issue 34881</a>æœ¬æ¥æ˜¯ä¿®å¤Dockerçš„ä¸€ä¸ªç®€å•é—®é¢˜ï¼Œå¦‚æœèŠ‚ç‚¹åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå‘ç°è‡ªå·±ä¸æ˜¯ä¸€ä¸ªswarm manangerï¼Œå°±å¿«é€Ÿè¿”å›ï¼Œè¿™ä¸ªä¿®å¤å°±å‡ è¡Œä»£ç ï¼Œä½ çœ‹å‡ºé—®é¢˜æ¥äº†å—ï¼Ÿ</p><p><img src=\"https://static001.geekbang.org/resource/image/bf/34/bf78904a947d4228dc006fff94f97334.png?wh=897*325\" alt=\"\"></p><p>åœ¨ç¬¬34è¡Œï¼ŒèŠ‚ç‚¹å‘ç°ä¸æ»¡è¶³æ¡ä»¶å°±è¿”å›äº†ï¼Œä½†æ˜¯ï¼Œc.muè¿™ä¸ªé”æ²¡æœ‰é‡Šæ”¾ï¼ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå…¶å®ï¼Œè¿™æ˜¯åœ¨é‡æ„æˆ–è€…æ·»åŠ æ–°åŠŸèƒ½çš„æ—¶å€™ç»å¸¸çŠ¯çš„ä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºä¸å¤ªäº†è§£ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…æ˜¯æ²¡æœ‰ä»”ç»†çœ‹å‡½æ•°çš„é€»è¾‘ï¼Œä»è€Œå¯¼è‡´é”æ²¡æœ‰è¢«é‡Šæ”¾ã€‚ç°åœ¨çš„Dockerå½“ç„¶å·²ç»æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1c/f1/1c7a5f8e12f642d82aac8045c046c6f1.png?wh=690*170\" alt=\"\"></p><p>è¿™æ ·çš„issueè¿˜æœ‰å¾ˆå¤šï¼Œæˆ‘å°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ã€‚æˆ‘ç»™ä½ æ¨èå‡ ä¸ªå…³äºMutexçš„issueæˆ–è€…pull requestï¼Œä½ å¯ä»¥å…³æ³¨ä¸€ä¸‹ï¼Œåˆ†åˆ«æ˜¯36840ã€37583ã€35517ã€35482ã€33305ã€32826ã€30696ã€29554ã€29191ã€28912ã€26507ç­‰ã€‚</p><h2>Kubernetes</h2><h3>issue 72361</h3><p>issue 72361 å¢åŠ Mutexä¸ºäº†ä¿æŠ¤èµ„æºã€‚è¿™æ˜¯ä¸ºäº†è§£å†³data raceé—®é¢˜è€Œåšçš„ä¸€ä¸ªä¿®å¤ï¼Œä¿®å¤æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨äº’æ–¥é”å³å¯ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è§£å†³data raceæ—¶å¸¸ç”¨çš„æ–¹æ³•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/21/31/2171a7a0de179904ceba463026ee7231.png?wh=755*375\" alt=\"\"></p><h3>issue 45192</h3><p><a href=\"https://github.com/kubernetes/kubernetes/pull/45192/files\">issue 45192</a>ä¹Ÿæ˜¯ä¸€ä¸ªè¿”å›æ—¶å¿˜è®°Unlockçš„å…¸å‹ä¾‹å­ï¼Œå’Œ docker issue 34881çŠ¯çš„é”™è¯¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>ä¸¤å¤§çŸ¥åé¡¹ç›®çš„å¼€å‘è€…éƒ½çŠ¯äº†è¿™ä¸ªé”™è¯¯ï¼Œæ‰€ä»¥ï¼Œä½ å°±å¯ä»¥çŸ¥é“ï¼Œå¼•å…¥è¿™ä¸ªBugæ˜¯å¤šä¹ˆå®¹æ˜“ï¼Œè®°ä½æ™è€å¸ˆè¿™å¥è¯ï¼š<strong>ä¿è¯Lock/Unlockæˆå¯¹å‡ºç°ï¼Œå°½å¯èƒ½é‡‡ç”¨defer mutex.Unlockçš„æ–¹å¼ï¼ŒæŠŠå®ƒä»¬æˆå¯¹ã€ç´§å‡‘åœ°å†™åœ¨ä¸€èµ·</strong>ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/ba/61/ba0f7671fd64951a47365e46ab68db61.png?wh=985*429\" alt=\"\"></p><p>é™¤äº†è¿™äº›ï¼Œæˆ‘ä¹Ÿå»ºè®®ä½ å…³æ³¨ä¸€ä¸‹å…¶å®ƒçš„Mutexç›¸å…³çš„issueï¼Œæ¯”å¦‚ 71617ã€70605ç­‰ã€‚</p><h2><strong>gRPC</strong></h2><p>gRPCæ˜¯Googleå‘èµ·çš„ä¸€ä¸ªå¼€æºè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ ï¼ˆRemote procedure callï¼‰ç³»ç»Ÿã€‚è¯¥ç³»ç»ŸåŸºäº HTTP/2 åè®®ä¼ è¾“ï¼Œä½¿ç”¨Protocol Buffers ä½œä¸ºæ¥å£æè¿°è¯­è¨€ã€‚å®ƒæä¾›Goè¯­è¨€çš„å®ç°ã€‚</p><p>å³ä½¿æ˜¯Googleå®˜æ–¹å‡ºå“çš„ç³»ç»Ÿï¼Œä¹Ÿæœ‰ä¸€äº›Mutexçš„issueã€‚</p><h3>issue 795</h3><p><a href=\"https://github.com/grpc/grpc-go/pull/795\">issue 795</a>æ˜¯ä¸€ä¸ªä½ å¯èƒ½æƒ³ä¸åˆ°çš„bugï¼Œé‚£å°±æ˜¯å°†Unlockè¯¯å†™æˆäº†Lockã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b6/f0/b6e97a6938586e95c3427e693eb712f0.png?wh=580*223\" alt=\"\"></p><p>å…³äºè¿™ä¸ªé¡¹ç›®ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä¸ºäº†ä¿æŠ¤å…±äº«èµ„æºè€Œæ·»åŠ Mutexçš„issueï¼Œæ¯”å¦‚1318ã€2074ã€2542ç­‰ã€‚</p><h2>etcd</h2><p>etcdæ˜¯ä¸€ä¸ªéå¸¸çŸ¥åçš„åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„ key-value å­˜å‚¨æŠ€æœ¯ï¼Œ è¢«ç”¨æ¥åšé…ç½®å…±äº«å’ŒæœåŠ¡å‘ç°ã€‚</p><h2>issue 10419</h2><p><a href=\"https://github.com/etcd-io/etcd/pull/10419/files\">issue 10419</a>æ˜¯ä¸€ä¸ªé”é‡å…¥å¯¼è‡´çš„é—®é¢˜ã€‚ Storeæ–¹æ³•å†…å¯¹è¯·æ±‚äº†é”ï¼Œè€Œè°ƒç”¨çš„Compactçš„æ–¹æ³•å†…åˆè¯·æ±‚äº†é”ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¼šå¯¼è‡´æ­»é”ï¼Œä¸€ç›´ç­‰å¾…ï¼Œè§£å†³åŠæ³•å°±æ˜¯æä¾›ä¸éœ€è¦åŠ é”çš„Compactæ–¹æ³•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/5f/7f/5fed22fb735c107d130477562c28477f.png?wh=878*344\" alt=\"\"></p><h1>æ€»ç»“</h1><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Mutexçš„ä¸€äº›æ˜“é”™åœºæ™¯ï¼Œè€Œä¸”ï¼Œæˆ‘ä»¬è¿˜åˆ†æäº†æµè¡Œçš„Goå¼€æºé¡¹ç›®çš„é”™è¯¯ï¼Œæˆ‘ä¹Ÿç»™ä½ åˆ†äº«äº†æˆ‘è‡ªå·±åœ¨å¼€å‘ä¸­çš„ç»éªŒæ€»ç»“ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œ<strong>æ‰‹è¯¯å’Œé‡å…¥å¯¼è‡´çš„æ­»é”ï¼Œæ˜¯æœ€å¸¸è§çš„ä½¿ç”¨Mutexçš„Bug</strong>ã€‚</p><p>Goæ­»é”æ¢æµ‹å·¥å…·åªèƒ½æ¢æµ‹æ•´ä¸ªç¨‹åºæ˜¯å¦å› ä¸ºæ­»é”è€Œå†»ç»“äº†ï¼Œä¸èƒ½æ£€æµ‹å‡ºä¸€ç»„goroutineæ­»é”å¯¼è‡´çš„æŸä¸€å—ä¸šåŠ¡å†»ç»“çš„æƒ…å†µã€‚ä½ è¿˜å¯ä»¥é€šè¿‡Goè¿è¡Œæ—¶è‡ªå¸¦çš„æ­»é”æ£€æµ‹å·¥å…·ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸‰æ–¹çš„å·¥å…·ï¼ˆæ¯”å¦‚<a href=\"https://github.com/sasha-s/go-deadlock\">go-deadlock</a>ã€<a href=\"https://github.com/dominikh/go-tools\">go-tools</a>ï¼‰è¿›è¡Œæ£€æŸ¥ï¼Œè¿™æ ·å¯ä»¥å°½æ—©å‘ç°ä¸€äº›æ­»é”çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œæœ‰äº›æ—¶å€™ï¼Œæ­»é”åœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹æ‰ä¼šè¢«è§¦å‘ï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ çš„æµ‹è¯•æˆ–è€…çŸ­æ—¶é—´çš„è¿è¡Œæ²¡é—®é¢˜ï¼Œä¸ä»£è¡¨ç¨‹åºä¸€å®šä¸ä¼šæœ‰æ­»é”é—®é¢˜ã€‚</p><p>å¹¶å‘ç¨‹åºæœ€éš¾è·Ÿè¸ªè°ƒè¯•çš„å°±æ˜¯å¾ˆéš¾é‡ç°ï¼Œå› ä¸ºå¹¶å‘é—®é¢˜ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„é¡ºåºæ‰§è¡Œçš„ï¼Œç”±äºè®¡ç®—æœºè°ƒåº¦çš„é—®é¢˜å’Œäº‹ä»¶è§¦å‘çš„æ—¶æœºä¸åŒï¼Œæ­»é”çš„Bugå¯èƒ½ä¼šåœ¨æç«¯çš„æƒ…å†µä¸‹å‡ºç°ã€‚é€šè¿‡æœç´¢æ—¥å¿—ã€æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬èƒ½å¤ŸçŸ¥é“ç¨‹åºæœ‰å¼‚å¸¸äº†ï¼Œæ¯”å¦‚æŸä¸ªæµç¨‹ä¸€ç›´æ²¡æœ‰ç»“æŸã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é€šè¿‡Go pprofå·¥å…·åˆ†æï¼Œå®ƒæä¾›äº†ä¸€ä¸ªblock profilerç›‘æ§é˜»å¡çš„goroutineã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹å…¨éƒ¨çš„goroutineçš„å †æ ˆä¿¡æ¯ï¼Œé€šè¿‡å®ƒï¼Œä½ å¯ä»¥æŸ¥çœ‹é˜»å¡çš„groutineç©¶ç«Ÿé˜»å¡åœ¨å“ªä¸€è¡Œå“ªä¸€ä¸ªå¯¹è±¡ä¸Šäº†ã€‚</p><h1>æ€è€ƒé¢˜</h1><p>æŸ¥æ‰¾çŸ¥åçš„æ•°æ®åº“ç³»ç»ŸTiDBçš„issueï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰Mutexç›¸å…³çš„issueï¼Œçœ‹çœ‹å®ƒä»¬éƒ½æ˜¯å“ªäº›ç›¸å…³çš„Bugã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","comments":[{"had_liked":false,"id":253754,"user_name":"Junes","can_delete":false,"product_type":"c1","uid":1354665,"ip_address":"","ucode":"CD2E829C868970","user_header":"https://static001.geekbang.org/account/avatar/00/14/ab/a9/590d6f02.jpg","comment_is_top":false,"comment_ctime":1602856799,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"224941156191","product_id":100061801,"comment_content":"åˆ†äº«ä¸€ä¸ªæˆ‘è§‰å¾—å¾ˆæœ‰é¡¹ç›®å€Ÿé‰´æ„ä¹‰çš„PRå§ï¼š<br><br>https:&#47;&#47;github.com&#47;pingcap&#47;tidb&#47;pull&#47;20381&#47;files <br><br>è¿™ä¸ªé—®é¢˜æ˜¯åœ¨å½“å‰çš„å‡½æ•°ä¸­Lockï¼Œç„¶ååœ¨è°ƒç”¨çš„å‡½æ•°ä¸­Unlockã€‚è¿™ç§æ–¹å¼ä¼šå¯¼è‡´ï¼Œå¦‚æœè¿è¡Œå­å‡½æ•°æ—¶panicäº†ï¼Œè€Œå¤–éƒ¨åˆæœ‰recoveræœºåˆ¶ä¸å¸Œæœ›ç¨‹åºå´©æºƒï¼Œå°±è§¦å‘ä¸åˆ°Unlockï¼Œå¼•èµ·æ­»é”ã€‚<br><br>PRä¸­åŠ äº†ä¸ªrecoverå¤„ç†ï¼Œå¹¶ä¸”åˆ¤æ–­recoveræœ‰erroræ‰Unlockï¼Œè¿™æ˜¯ä¸€ç§å¤„ç†æ–¹æ³•ã€‚<br><br>ç†æƒ³çš„è®¾è®¡ï¼Œæ˜¯å°†å­å‡½æ•°çš„UnlockæŒªåˆ°ä¸Lockå¹³çº§çš„ä»£ç ï¼Œæˆ–è€…ä¸è¿›è¡Œrecoverå¤„ç†ï¼ŒLet it panicåä¿®å¤é—®é¢˜ã€‚ä½†å¤§å‹é¡¹ç›®é¡¹ç›®ç»å¸¸ä¼šå› ä¸ºé€»è¾‘é”™ç»¼å¤æ‚æˆ–è€…å„ç§å†å²åŸå› ï¼Œä¸å¥½æ”¹åŠ¨å§ï¼Œè¿™ç§å¤„ç†æ–¹å¼è™½ç„¶ä¸å¥½çœ‹ï¼Œä½†èƒ½è§£å†³é—®é¢˜ï¼Œæœ‰æ—¶å€™ä¹ŸæŒºæ— å¥ˆçš„~","like_count":53},{"had_liked":false,"id":253984,"user_name":"Rememberä¹ç¦»","can_delete":false,"product_type":"c1","uid":1237327,"ip_address":"","ucode":"97EE6E6344689F","user_header":"https://static001.geekbang.org/account/avatar/00/12/e1/4f/00476b4c.jpg","comment_is_top":false,"comment_ctime":1603003533,"is_pvip":false,"replies":[{"id":"92757","content":"èµã€‚å…¶ä»–è¯»è€…å¯ä»¥å…³æ³¨è¿™ä½æœ‹å‹çš„æ•´ç†","user_name":"ä½œè€…å›å¤","comment_id":253984,"uid":"1066613","ip_address":"","utype":1,"ctime":1603011629,"user_name_real":"é¸Ÿçª"}],"discussion_count":3,"race_medal":0,"score":"66027512973","product_id":100061801,"comment_content":"ç¬¬ä¸‰è¯¾ä»£ç æ•´ç†:https:&#47;&#47;github.com&#47;wuqinqiang&#47;Go_Concurrency&#47;tree&#47;main&#47;class_3","like_count":16,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507238,"discussion_content":"èµã€‚å…¶ä»–è¯»è€…å¯ä»¥å…³æ³¨è¿™ä½æœ‹å‹çš„æ•´ç†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603011629,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1237327,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e1/4f/00476b4c.jpg","nickname":"Rememberä¹ç¦»","note":"","ucode":"97EE6E6344689F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":375657,"discussion_content":"åœ°å€é”™äº†ä¸€ä¸ªå­—æ¯ï¼Œæ˜¯\nhttps://github.com/wuqinqiang/Go_Concurrency","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1621787271,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2233985,"avatar":"","nickname":"ä¸œé£","note":"","ucode":"BB8594F7A660BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":313343,"discussion_content":"ç»™ä½ ï¼Œå¥¥åˆ©ç»™ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603036461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257948,"user_name":"iamjohnnyzhuang","can_delete":false,"product_type":"c1","uid":1015327,"ip_address":"","ucode":"E694C1828907F6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7e/1f/b1d458a9.jpg","comment_is_top":false,"comment_ctime":1604220970,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"61733763114","product_id":100061801,"comment_content":"ä¹°è¿™ä¸ªè¯¾ç¨‹æœ¬æ¥æ²¡æŠ¥å¤šå¤§å¸Œæœ›ï¼Œæ²¡æƒ³åˆ°çœ‹çœ‹å‡ èŠ‚ä¸‹æ¥å¤ªèµäº†ï¼Œä¸ä»…è¯´åˆ°äº†ä¸€äº›æŠ€æœ¯çš„å®ç°ç»†èŠ‚ï¼ŒåŒæ—¶ç»™å‡ºçš„è®©æˆ‘ä»¬ä¸šåŠ¡å¼€å‘é¿å…çš„ç»éªŒã€æ’æŸ¥æ–¹æ³•ä¹Ÿååˆ†æœ‰å€Ÿé‰´ä»·å€¼","like_count":14,"discussions":[{"author":{"id":1241757,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f2/9d/26ea1126.jpg","nickname":"Jesse Rau","note":"","ucode":"9BDA1552A57010","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320383,"discussion_content":"åŸæ¥æˆ‘ä¸æ˜¯å”¯ä¸€è¿™ä¹ˆæƒ³çš„ã€‚ :-)","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1604345142,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065849,"avatar":"https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg","nickname":"test","note":"","ucode":"9A4973E591DD12","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":376526,"discussion_content":"ä¿ºä¹Ÿä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622174291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1067505,"avatar":"https://static001.geekbang.org/account/avatar/00/10/49/f1/3d3b02fd.jpg","nickname":"onmyway","note":"","ucode":"452276A5B783AD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331817,"discussion_content":"ä¿ºä¹Ÿä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606986506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1200231,"avatar":"https://static001.geekbang.org/account/avatar/00/12/50/67/29ad08bc.jpg","nickname":"æ¢¦é‡Œæ˜¯è°ğŸŒš","note":"","ucode":"0050BC150EDBF4","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325609,"discussion_content":"åŸæ¥æˆ‘ä¹Ÿä¸æ˜¯å”¯ä¸€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605361602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253674,"user_name":"buckwheat","can_delete":false,"product_type":"c1","uid":1466067,"ip_address":"","ucode":"3FE4251F6BD2B9","user_header":"https://static001.geekbang.org/account/avatar/00/16/5e/d3/e4d2ae68.jpg","comment_is_top":false,"comment_ctime":1602827742,"is_pvip":false,"discussion_count":3,"race_medal":1,"score":"31667598814","product_id":100061801,"comment_content":"çœ‹äº†ä¸€çœ¼tidbå…³äºmutexçš„issueï¼Œå‘ç°å¤§éƒ¨é—®é¢˜éƒ½å‡ºç°åœ¨Unlockçš„æ—¶æœºä¸Šé¢ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°å¤šä¸ªé”çš„æ—¶å€™ï¼ŒæŠŠLockå’ŒUnlockæ”¾åˆ°ä¸¤ä¸ªæ–¹æ³•é‡Œé¢å°±éå¸¸å®¹æ˜“å‡ºç°è¿™ç§æƒ…å†µã€‚tidbå‡ºç°data raceçš„issueè¦æ¯”dead lockçš„è¦å¤šçš„å¤šã€‚è€å¸ˆï¼Œä¸šåŠ¡å¤æ‚æ—¶ï¼Œåœ¨æ¶‰åŠåˆ°é“¾å¼åŠ é”æ—¶æœ‰æ²¡æœ‰ä»€ä¹ˆå¥½çš„åŠæ³•é¿å…æ­»é”å‘¢ï¼Ÿ","like_count":7,"discussions":[{"author":{"id":1713473,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIYML5ZzlzYzMDNPSo25ZicwU6LNbOGqQ1ItY4X9dZqOK00GUv1eTlWbYolvYczx4cmTdqNicBmtfkw/132","nickname":"Geek_cba546","note":"","ucode":"200CD29B405A76","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":383768,"discussion_content":"åŒé—®ï¼Œè¯·è€å¸ˆæŒ‡æ•™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1626234305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1241757,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f2/9d/26ea1126.jpg","nickname":"Jesse Rau","note":"","ucode":"9BDA1552A57010","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320382,"discussion_content":"é ‚ä½ ä¸Šå»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604345091,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315989,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603343351,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255981,"user_name":"pony","can_delete":false,"product_type":"c1","uid":1021530,"ip_address":"","ucode":"B72FA864CDD286","user_header":"https://static001.geekbang.org/account/avatar/00/0f/96/5a/846a09f7.jpg","comment_is_top":false,"comment_ctime":1603494342,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"23078330822","product_id":100061801,"comment_content":"è€å¸ˆè®²è§£çš„å¾ˆä»”ç»†ï¼Œå¯¹mutexä½¿ç”¨é”™è¯¯åœºæ™¯éƒ½åˆ—ä¸¾äº†<br>è¡¥å……ç‚¹ï¼šGoè¯­è¨€æ ¸å¿ƒ36è®²çš„è§£é”ä¸€ä¸ªæœªåŠ é”çš„mutex å¯¼è‡´çš„panicï¼Œæ— æ³•è¢«recover()æ•è·","like_count":5,"discussions":[{"author":{"id":2730577,"avatar":"","nickname":"kdocsæœåŠ¡ç»„2","note":"","ucode":"F1B0D5EB2E4B31","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530954,"discussion_content":"å’‹è¯´ï¼Œå…·ä½“ç‚¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637195409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253653,"user_name":"æ‰“å¥¥ç‰¹æ›¼çš„å°æ€ªå…½","can_delete":false,"product_type":"c1","uid":1060596,"ip_address":"","ucode":"DE9FF2D598BED2","user_header":"https://static001.geekbang.org/account/avatar/00/10/2e/f4/1e4d6941.jpg","comment_is_top":false,"comment_ctime":1602819447,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23077655927","product_id":100061801,"comment_content":"è¿™ä¸ªè¯¾ç¨‹çœ‹èµ·æ¥å¾ˆæœ‰æ„æ€","like_count":5},{"had_liked":false,"id":253630,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1602815893,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18782685077","product_id":100061801,"comment_content":"åœ¨ TiDB Pull requests å·²ç» closed çš„æœç´¢ deadlock å…³é”®å­—å‘ç°å¥½å¤šï¼Œä¾‹å¦‚ https:&#47;&#47;github.com&#47;pingcap&#47;tidb&#47;pull&#47;500ï¼Œé—®é¢˜çš„åŸå› åœ¨äºé‡Šæ”¾çš„ä½ç½®æœ‰é—®é¢˜ã€‚","like_count":4,"discussions":[{"author":{"id":1629565,"avatar":"https://static001.geekbang.org/account/avatar/00/18/dd/7d/5d3ab033.jpg","nickname":"ä¸æ±‚é—»è¾¾","note":"","ucode":"B265859B9566D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318664,"discussion_content":"TIDBæ˜¯è¿™å‡ å¹´å‡ºæ¥çš„å…³ç³»å‹æ•°æ®åº“ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603801578,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":254122,"user_name":"ç½—æ°","can_delete":false,"product_type":"c1","uid":1320487,"ip_address":"","ucode":"96BAFAA147341F","user_header":"https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg","comment_is_top":false,"comment_ctime":1603069374,"is_pvip":false,"discussion_count":0,"race_medal":2,"score":"14487971262","product_id":100061801,"comment_content":"ç®€å•æ˜“æ‡‚ åˆ—ä¸¾çŸ¥åå¼€æºé¡¹ç›®æ¼æ´æ¥å¯¹åº”è‡ªå·±çš„æ€»ç»“ å¤ªæ£’äº†ğŸ‘","like_count":3},{"had_liked":false,"id":253726,"user_name":"Stony.ä¿®è¡Œåƒ§","can_delete":false,"product_type":"c1","uid":1061277,"ip_address":"","ucode":"0F2368F7D93E4A","user_header":"https://static001.geekbang.org/account/avatar/00/10/31/9d/daad92d2.jpg","comment_is_top":false,"comment_ctime":1602844979,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14487746867","product_id":100061801,"comment_content":"æ´»æ‰ä¸€åªå¤§ä½¬ï¼Œå†™çš„çœŸå¥½ï¼Œæ„Ÿè§‰ç¼–ç¨‹è¯­è¨€é‡Œé¢é”æŠ€æœ¯æ˜¯ç²¾é«“ä¹‹ä¸€","like_count":3},{"had_liked":false,"id":279881,"user_name":"é˜¿ç‰›","can_delete":false,"product_type":"c1","uid":1073236,"ip_address":"","ucode":"DC8C189FCF3289","user_header":"https://static001.geekbang.org/account/avatar/00/10/60/54/b3eb605b.jpg","comment_is_top":false,"comment_ctime":1613990147,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"10203924739","product_id":100061801,"comment_content":"Mutexå¸¸è§å››ç§é”™è¯¯åœºæ™¯<br>1ã€Lock&#47;Unlockä¸æ˜¯æˆå¯¹å‡ºç°<br>2ã€Copyå·²ä½¿ç”¨çš„Mutex<br>3ã€é‡å…¥<br>4ã€æ­»é”","like_count":2},{"had_liked":false,"id":262249,"user_name":"David","can_delete":false,"product_type":"c1","uid":1136236,"ip_address":"","ucode":"8277D3CE881053","user_header":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","comment_is_top":false,"comment_ctime":1605673666,"is_pvip":false,"replies":[{"id":"95150","content":"å¦‚æœéƒ½æŒ‰ç…§ä½ çš„è®¾è®¡ï¼Œæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹ä¸šåŠ¡æ¯”è¾ƒå¤æ‚ï¼Œä¼šå‡ºç°a,b,c,b,e,f,c,e,gè¿™æ ·çš„è°ƒç”¨å…³ç³»ï¼Œå¦‚æœaå’Œeéƒ½ä½¿ç”¨äº†é”ï¼Œå°±å¯èƒ½å‡ºç°é‡å…¥é—®é¢˜ã€‚<br>ä¹Ÿè®¸ä½ è§‰å¾—è¿™æ ·çš„é”™è¯¯ä¸å¯èƒ½å‡ºç°ï¼Œä½†æ˜¯çœ‹çœ‹å¤§é¡¹ç›®ä¸­ï¼Œè¿™ç§é—®é¢˜è¿˜çœŸå°±å‡ºç°äº†","user_name":"ä½œè€…å›å¤","comment_id":262249,"uid":"1066613","ip_address":"","utype":1,"ctime":1605676418,"user_name_real":"é¸Ÿçª"}],"discussion_count":3,"race_medal":0,"score":"10195608258","product_id":100061801,"comment_content":"ä¸ªäººç†è§£ï¼šæˆ‘è§‰å¾—goé‡Œé¢çš„å¯é‡å…¥é”ï¼Œæœ‰ç‚¹é¸¡è‚‹ï¼Œè¿™ä¹Ÿæ˜¯goå®˜æ–¹æ²¡æœ‰å®ç°çš„åŸå› å§ã€‚ç¬¬ä¸€ï¼Œå¦‚æœæˆ‘åŠ äº†äº’æ–¥é”ï¼Œè¯´æ˜è¿™ä¸´ç•ŒåŒºçš„èµ„æºéƒ½æ˜¯æŸä¸ªgroutineç‹¬äº«ï¼Œé‚£ä½•å¿…è¦åœ¨ä¸´ç•ŒåŒºé‡Œé¢å†å»è¯·æ±‚é”å‘¢ï¼Œä¸æ˜¯å¤šæ­¤ä¸€ä¸¾å—ï¼Œç¬¬äºŒï¼Œå°±æ‹¿é€’å½’æ¥è¯´ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠåŠ åœ¨é€’å½’å‡½æ•°é‡Œé¢çš„é”ï¼Œæå–åˆ°è°ƒç”¨é€’å½’ä¹‹å‰ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…é€’å½’å‡½æ•°åŠ é”çš„æƒ…å†µã€‚è¿™æ˜¯æˆ‘çš„ä¸ªäººç†è§£ã€‚åœ¨redisé‡Œé¢æœ‰åˆ†å¸ƒå¼é”ï¼Œä¼šå‡ºç°ä¸€ä¸ªæŒæœ‰é”çš„çº¿ç¨‹å†æ¬¡åŠ é”çš„æƒ…å†µï¼Œä½†æ˜¯å‘¢ï¼Œå’Œè¿™é‡Œçš„ä½¿ç”¨æƒ…å†µè¿˜æ˜¯ä¸ä¸€æ ·ï¼Œredisä¸€èˆ¬åŠ é”ï¼Œéƒ½ä¼šåŠ ä¸ªæœ‰æ•ˆæœŸ(æ‹…å¿ƒå¿˜è®°é‡Šæ”¾é”ï¼Œé€ æˆæ­»é”)ï¼Œè¿™ä¸ªæœ‰æ•ˆæœŸæ—¶é—´é•¿åº¦ï¼Œä¸èƒ½å¤ªå¤§äºç¨‹åºæ‰§è¡Œæ—¶é—´ï¼Œè¿™æ ·å¦‚æœé”æ¥ä¸åŠé‡Šæ”¾çš„æ—¶å€™å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥ä¸€èˆ¬æœ‰æ•ˆæœŸéƒ½å’Œç¨‹åºæ‰§è¡Œæ—¶é—´å·®ä¸å¤šã€‚ä½†æ˜¯æœ‰æ—¶å€™ï¼Œå‡ºç°æ‰§è¡Œæ—¶é—´é•¿è¶…è¿‡äº†æœ‰æ•ˆæœŸçš„æ—¶å€™ï¼Œéœ€è¦ç»­æœŸï¼Œæ‰æœ‰å†æ¬¡è¯·æ±‚é”ã€‚ä»¥ä¸Šæ˜¯æˆ‘ä¸ªäººç†è§£ï¼Œå¦‚æœè€å¸ˆçœ‹åˆ°è¯„è®ºï¼Œå¯ä»¥ç‚¹è¯„ä¸€ä¸‹æˆ‘çš„æ€ç»´æ˜¯å¦æœ‰é—®é¢˜","like_count":2,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509748,"discussion_content":"å¦‚æœéƒ½æŒ‰ç…§ä½ çš„è®¾è®¡ï¼Œæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹ä¸šåŠ¡æ¯”è¾ƒå¤æ‚ï¼Œä¼šå‡ºç°a,b,c,b,e,f,c,e,gè¿™æ ·çš„è°ƒç”¨å…³ç³»ï¼Œå¦‚æœaå’Œeéƒ½ä½¿ç”¨äº†é”ï¼Œå°±å¯èƒ½å‡ºç°é‡å…¥é—®é¢˜ã€‚\nä¹Ÿè®¸ä½ è§‰å¾—è¿™æ ·çš„é”™è¯¯ä¸å¯èƒ½å‡ºç°ï¼Œä½†æ˜¯çœ‹çœ‹å¤§é¡¹ç›®ä¸­ï¼Œè¿™ç§é—®é¢˜è¿˜çœŸå°±å‡ºç°äº†","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1605676418,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1109522,"avatar":"https://static001.geekbang.org/account/avatar/00/10/ee/12/77ddaeb8.jpg","nickname":"Yabo","note":"","ucode":"D193B6AB9686D9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":330773,"discussion_content":"å¢¨è²å®šå¾‹ï¼šæœ‰å¯èƒ½å‘ç”Ÿçš„äº‹æƒ…ä¸€å®šä¼šå‘ç”Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606706313,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1136236,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","nickname":"David","note":"","ucode":"8277D3CE881053","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326786,"discussion_content":"å½“ç„¶redisæœ¬èº«æ²¡æœ‰ä»€ä¹ˆå¯é‡å…¥é”ï¼Œåªèƒ½è‡ªå·±é€šè¿‡å®¢æˆ·ç«¯å®ç°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605675918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259993,"user_name":"æ¶ˆé€æ–‡å­—","can_delete":false,"product_type":"c1","uid":2070541,"ip_address":"","ucode":"F6722D8AF38F52","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/vRoYUplibtKY2YFg7icP8A7SBSicAuhxz2mxgY6kibzaKRO8c1PXpNskGJB2Z3WfFoRaX5nh8oztib0NOr5qNdibCyaw/132","comment_is_top":false,"comment_ctime":1604904372,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10194838964","product_id":100061801,"comment_content":"çœŸæ˜¯æƒ³ä¸åˆ°ï¼ŒçŸ¥åçš„å¼€æºé¡¹ç›®é‡Œé¢å±…ç„¶ä¹Ÿä¼šæœ‰ä¸€äº›æˆ‘ä»¬ç¼–ç æ—¶å¸¸çŠ¯çš„ä½çº§é”™è¯¯","like_count":3},{"had_liked":false,"id":254991,"user_name":"gitxuzan","can_delete":false,"product_type":"c1","uid":1081566,"ip_address":"","ucode":"B0E20F892DA716","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/de/c6191045.jpg","comment_is_top":false,"comment_ctime":1603246190,"is_pvip":false,"replies":[{"id":"92949","content":"è¿™ä¸ªå¯ä»¥ç­‰atomicé‚£ä¸€è®²å‡ºæ¥å†äº†è§£","user_name":"ä½œè€…å›å¤","comment_id":254991,"uid":"1066613","ip_address":"","utype":1,"ctime":1603248441,"user_name_real":"é¸Ÿçª"}],"discussion_count":3,"race_medal":0,"score":"10193180782","product_id":100061801,"comment_content":"æœ‰ä¸ªåœ°æ–¹ä¸æ˜ç™½ï¼Œ ä¸ºä»€ä¹ˆæºç é‡Œé¢éœ€è¦ç”¨atomic åŸå­æ“ä½œå’Œç›´æ¥èµ‹å€¼æœ‰ä»€ä¹ˆåŒºåˆ«","like_count":2,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507580,"discussion_content":"è¿™ä¸ªå¯ä»¥ç­‰atomicé‚£ä¸€è®²å‡ºæ¥å†äº†è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603248441,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2536820,"avatar":"https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg","nickname":"å‹","note":"","ucode":"972A4333A8B101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388466,"discussion_content":"å¯ä»¥äº†è§£ä¸‹æ±‡ç¼–ï¼Œç›´æ¥èµ‹å€¼ä¸ä¸€å®šæ˜¯åŸå­çš„ï¼Œå¯èƒ½ä¼šæœ‰å¤šæ¡æŒ‡ä»¤ï¼Œæ¯”å¦‚ *xxx = x  é‚£ä¹ˆä¼šæœ‰å¤šæ¡æŒ‡ä»¤ï¼Œ æ¯”å¦‚å…ˆä»æ ˆå¸§æŒ‡é’ˆxxxåç§»é‡è·å– é‚£ä¹ˆä¼šå…ˆæŠŠ&amp;xxxçš„ä¸­å­˜çš„å†…å­˜åœ°å€è¯»åˆ°å¯„å­˜å™¨ï¼Œç„¶åå†é—´æ¥å¯»å€åˆ°å€¼ å†èµ‹å€¼ç»™å‡†ç¡®çš„å˜é‡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628774243,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1081566,"avatar":"https://static001.geekbang.org/account/avatar/00/10/80/de/c6191045.jpg","nickname":"gitxuzan","note":"","ucode":"B0E20F892DA716","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":315901,"discussion_content":"å¥½çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603335140,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":253851,"user_name":"roseduan","can_delete":false,"product_type":"c1","uid":1246451,"ip_address":"","ucode":"5BB69BB9D329EC","user_header":"https://static001.geekbang.org/account/avatar/00/13/04/f3/a3ff8a58.jpg","comment_is_top":false,"comment_ctime":1602918988,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10192853580","product_id":100061801,"comment_content":"å°† Unlock è¯¯å†™æˆäº† Lockï¼Œå“ˆå“ˆå“ˆï¼ŒåŸæ¥è¿™äº›å¤§ä½¬ä¹Ÿä¼šçŠ¯ä½çº§é”™è¯¯","like_count":2},{"had_liked":false,"id":340833,"user_name":"å¼ ç”³å‚²","can_delete":false,"product_type":"c1","uid":1182372,"ip_address":"","ucode":"22D46BC529BA8A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg","comment_is_top":false,"comment_ctime":1649170770,"is_pvip":true,"discussion_count":0,"race_medal":1,"score":"5944138066","product_id":100061801,"comment_content":"èƒ½æŠŠå¹¶å‘çš„è¯¾ç¨‹è®²å¾—è¿™ä¹ˆæ·±å…¥æµ…å‡ºï¼Œè€å¸ˆçš„åŠŸåº•å¯è§ä¸€æ–‘~","like_count":1},{"had_liked":false,"id":276360,"user_name":"æ ¡æ­Œ","can_delete":false,"product_type":"c1","uid":2054611,"ip_address":"","ucode":"CD257668BB1A33","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKBENQekdV3e9XwRQ5kpO9Y9d81sEMm52qcwJWbFbWbW2rniaTFYCChoR0ibZ0E3soQqod9rvfmBibmQ/132","comment_is_top":false,"comment_ctime":1611898245,"is_pvip":true,"replies":[{"id":"100313","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","comment_id":276360,"uid":"1066613","ip_address":"","utype":1,"ctime":1611966933,"user_name_real":"é¸Ÿçª"}],"discussion_count":1,"race_medal":1,"score":"5906865541","product_id":100061801,"comment_content":"Tidbåœ¨ç”¨mutexçš„æ—¶å€™ç‰¹æ„æ”¹æˆäº†defer è¿™ç§æ–¹å¼ï¼Œhttps:&#47;&#47;github.com&#47;pingcap&#47;tidb&#47;pull&#47;19072ï¼Œ<br>ä¸è¿‡æ‰¾äº†ä¸ªæ¯”è¾ƒè€çš„issueï¼Œhttps:&#47;&#47;github.com&#47;pingcap&#47;tidb&#47;pull&#47;5171 ï¼Œlockå’Œunlockè¿˜æ˜¯æ²¡æœ‰ç»Ÿä¸€ç”¨deferçš„æ–¹å¼ï¼Œè¿™ä¸ªä»¥åå¯èƒ½æˆä¸ºéšæ‚£å§ã€‚","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514678,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1611966933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":269602,"user_name":"Fan","can_delete":false,"product_type":"c1","uid":1115232,"ip_address":"","ucode":"3BF28670FD9407","user_header":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","comment_is_top":false,"comment_ctime":1608712528,"is_pvip":false,"replies":[{"id":"97761","content":"åŠ æ²¹ï¼ï¼ï¼","user_name":"ä½œè€…å›å¤","comment_id":269602,"uid":"1066613","ip_address":"","utype":1,"ctime":1608718712,"user_name_real":"é¸Ÿçª"}],"discussion_count":2,"race_medal":0,"score":"5903679824","product_id":100061801,"comment_content":"çœ‹äº†å‰ä¸‰èŠ‚ï¼Œè¿™é—¨è¯¾å†™çš„å¤ªæ£’äº†ã€‚ç»§ç»­æ‰“å¡ã€‚","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512333,"discussion_content":"åŠ æ²¹ï¼ï¼ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608718712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1115232,"avatar":"https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg","nickname":"Fan","note":"","ucode":"3BF28670FD9407","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":337438,"discussion_content":"å·²ç»åˆ·å®Œä¸€éï¼Œå†™å¾—å¤ªæ£’ï¼Œå‡†å¤‡äºŒåˆ·ï¼ŒæŠŠçŸ¥è¯†ç‚¹æ•´ç†ç³»ç»Ÿæ¢³ç†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1608905552,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265741,"user_name":"ç§‘ç§‘","can_delete":false,"product_type":"c1","uid":1647304,"ip_address":"","ucode":"7DAE6FE781172E","user_header":"https://static001.geekbang.org/account/avatar/00/19/22/c8/f2892022.jpg","comment_is_top":false,"comment_ctime":1606999487,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"5901966783","product_id":100061801,"comment_content":"å¤§ä½¬ä¹Ÿæœ‰å†™é”™çš„æ—¶å€™ï¼Œä¸èƒ½è¯´å®Œå…¨é¿å…é—®é¢˜ï¼Œä½†ä¸€å®šè¦å­¦ä¹ å¦‚ä½•è§£å†³é—®é¢˜","like_count":1},{"had_liked":false,"id":255076,"user_name":"è™«å­æ¨±æ¡ƒ","can_delete":false,"product_type":"c1","uid":1226331,"ip_address":"","ucode":"F8244A9E9BC5A6","user_header":"https://static001.geekbang.org/account/avatar/00/12/b6/5b/4486e4f9.jpg","comment_is_top":false,"comment_ctime":1603262905,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5898230201","product_id":100061801,"comment_content":"è·Ÿè¿™ä¸ªå¾ˆç±»ä¼¼ https:&#47;&#47;medium.com&#47;@bytecraze.com&#47;recursive-locking-in-go-9c1c2a106a38","like_count":1},{"had_liked":false,"id":354432,"user_name":"è èå¹é›ªâ€”Code","can_delete":false,"product_type":"c1","uid":1650378,"ip_address":"åŒ—äº¬","ucode":"A5B2FC661EE17D","user_header":"https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg","comment_is_top":false,"comment_ctime":1660383158,"is_pvip":true,"replies":[{"id":"129135","content":"ğŸ‘ğŸ»","user_name":"ä½œè€…å›å¤","comment_id":354432,"uid":"1066613","ip_address":"åŒ—äº¬","utype":1,"ctime":1660964923,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1660383158","product_id":100061801,"comment_content":"æ‰“å¡<br><br>ä½œä¸šï¼š<br><br>https:&#47;&#47;github.com&#47;pingcap&#47;tidb&#47;issues&#47;27725  <br>","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":584605,"discussion_content":"ğŸ‘ğŸ»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660964923,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŒ—äº¬"},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":351652,"user_name":"echo","can_delete":false,"product_type":"c1","uid":2794917,"ip_address":"","ucode":"50D1D6B0ECD803","user_header":"https://static001.geekbang.org/account/avatar/00/2a/a5/a5/ad715d22.jpg","comment_is_top":false,"comment_ctime":1658053264,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658053264","product_id":100061801,"comment_content":"åŒå¿—ä»¬ æˆ‘åˆæ¥äº†","like_count":0},{"had_liked":false,"id":341509,"user_name":"taro","can_delete":false,"product_type":"c1","uid":2658985,"ip_address":"","ucode":"69971AF9FE4857","user_header":"","comment_is_top":false,"comment_ctime":1649666529,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1649666529","product_id":100061801,"comment_content":"å¯¹owner&#47;tokençš„æ“ä½œä¸ºä»€ä¹ˆè¦ç”¨åŸå­æ“ä½œå‘¢ï¼Ÿå¤šä¸ªgoroutineè¯»å–æˆ–è€…å†™å…¥owner&#47;tokençš„å€¼ä¼šå½±å“å¯é‡å…¥é”çš„è¿è¡Œæ•ˆæœå—ï¼Ÿ","like_count":0},{"had_liked":false,"id":333906,"user_name":"echo","can_delete":false,"product_type":"c1","uid":2794917,"ip_address":"","ucode":"50D1D6B0ECD803","user_header":"https://static001.geekbang.org/account/avatar/00/2a/a5/a5/ad715d22.jpg","comment_is_top":false,"comment_ctime":1644575253,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1644575253","product_id":100061801,"comment_content":"æ‰“å¼€","like_count":0},{"had_liked":false,"id":326582,"user_name":"Bynow","can_delete":false,"product_type":"c1","uid":2735072,"ip_address":"","ucode":"1E4F3ADD65CF18","user_header":"https://static001.geekbang.org/account/avatar/00/29/bb/e0/c7cd5170.jpg","comment_is_top":false,"comment_ctime":1639570646,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639570646","product_id":100061801,"comment_content":"go vet ä¸ºä»€ä¹ˆæ— æ³•æ£€æŸ¥ goroutine é‡Œçš„é”é—®é¢˜ï¼Ÿ","like_count":0},{"had_liked":false,"id":309307,"user_name":"æé‡‘ç‹—","can_delete":false,"product_type":"c1","uid":1605237,"ip_address":"","ucode":"9A38CA646B06C3","user_header":"https://static001.geekbang.org/account/avatar/00/18/7e/75/3e6bdc4c.jpg","comment_is_top":false,"comment_ctime":1630039739,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1630039739","product_id":100061801,"comment_content":"å†™äº†ä¸€ä¸ªåº“ https:&#47;&#47;github.com&#47;longlihale&#47;goid è·å– goid çš„æ¬¢è¿å¤§å®¶ä½¿ç”¨ï½ ","like_count":0},{"had_liked":false,"id":303013,"user_name":"ã€è’å”_æˆ_","can_delete":false,"product_type":"c1","uid":1149297,"ip_address":"","ucode":"BF6E05A94272E4","user_header":"https://static001.geekbang.org/account/avatar/00/11/89/71/03a99e56.jpg","comment_is_top":false,"comment_ctime":1626516649,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626516649","product_id":100061801,"comment_content":"docker ç¬¬äºŒä¸ªé”é—®é¢˜ï¼Œé‡åˆ°ç›¸åŒçš„ï¼Œå½“æ—¶æ’æŸ¥äº†ä¸€å¤©å¤šã€‚æåˆ°å‡Œæ™¨ä¸€ç‚¹ï¼Œæ²¡æå®šï¼Œç¬¬äºŒå¤©ä¸­åˆåä¸€ç‚¹å‘ç°ä¾èµ–çš„åŒäº‹å¼€å‘çš„åº“æœ‰è¿™ä¸ªé—®é¢˜ï¼Œ å‘ç°åŸå› çš„æ—¶å€™æƒ³æ­»çš„å¿ƒéƒ½æœ‰äº†","like_count":0},{"had_liked":false,"id":271625,"user_name":"David","can_delete":false,"product_type":"c1","uid":1136236,"ip_address":"","ucode":"8277D3CE881053","user_header":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","comment_is_top":false,"comment_ctime":1609740815,"is_pvip":false,"replies":[{"id":"98518","content":"ç¬¬11è¡ŒæœªåŠ é”","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1609754975,"ip_address":"","comment_id":271625,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1609740815","product_id":100061801,"comment_content":"æ‚¨å¥½è€å¸ˆï¼Œåœ¨è®¾è®¡å¯é‡å…¥é”çš„æ—¶å€™ï¼Œåœ¨lockæ–¹æ³•ä¸­ï¼Œ<br>\t&#47;&#47; å»¶ç”¨mutexçš„åŠ é”æœºåˆ¶<br>\tm.Mutex.Lock()<br>\tatomic.StoreInt64(&amp;m.owner, gid)<br>è¿™ä¸ªåœ°æ–¹æœ‰å¿…è¦ ä½¿ç”¨atomicå—ï¼Ÿ<br>      <br><br>å…¶æ¬¡ï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œä¸ºä»€ä¹ˆ  m.recursion = 1  ä¸ç”¨äº†å‘¢<br>æˆ‘ä¸ªäººè®¤ä¸ºï¼Œåœ¨é”é‡Œé¢ï¼Œå¥½åƒæ˜¯æ²¡å¿…è¦ä½¿ç”¨çš„å§","like_count":1,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":512979,"discussion_content":"ç¬¬11è¡ŒæœªåŠ é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609754975,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1554075,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/6BNrtko7d9ZXic04QhUuQic7N9XEVFtXciaHNlYMVvIic8bv4k52GmFRuYotiaJpjGiaj35rCdhWcFojKsgFIvZ5XlMA/132","nickname":"Geek_7f28ff","note":"","ucode":"DEC79BC88B72FE","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":378582,"discussion_content":"è€å¸ˆï¼Œ11è¡ŒæœªåŠ é”ï¼Œå’Œè¿™é‡Œæœ‰ä»€ä¹ˆå…³ç³»ï¼Œè¿™é‡Œå·²ç»Lockäº†ï¼Œé‚£æ˜¯éšä¾¿è¯»å†™ï¼Œéƒ½ä¸ä¼šå½±å“å•Šï¼Œè€å¸ˆèƒ½ä¸èƒ½è¯¦ç»†ç‚¹ï¼Œæ²¡çœ‹æ˜ç™½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1623294002,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":264914,"user_name":"Yabo","can_delete":false,"product_type":"c1","uid":1109522,"ip_address":"","ucode":"D193B6AB9686D9","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/12/77ddaeb8.jpg","comment_is_top":false,"comment_ctime":1606706359,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606706359","product_id":100061801,"comment_content":"è®°ä½é‡ç‚¹ï¼šä¿è¯ Lock&#47;Unlock æˆå¯¹å‡ºç°ï¼Œå°½å¯èƒ½é‡‡ç”¨ defer mutex.Unlock çš„æ–¹å¼ï¼ŒæŠŠå®ƒä»¬æˆå¯¹ã€ç´§å‡‘åœ°å†™åœ¨ä¸€èµ·ã€‚","like_count":0},{"had_liked":false,"id":264769,"user_name":"ç‹éº’","can_delete":false,"product_type":"c1","uid":1265260,"ip_address":"","ucode":"330017C5A911B6","user_header":"https://static001.geekbang.org/account/avatar/00/13/4e/6c/71020c59.jpg","comment_is_top":false,"comment_ctime":1606639738,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606639738","product_id":100061801,"comment_content":"åœ¨deferæ€§èƒ½æå‡ä¹‹åç°åœ¨æˆ‘æ˜¯å¦å¯ä»¥ç®€å•åœ°åœ¨æ¯ä¸€ä¸ªlockåé¢æ¥ä¸€ä¸ªdefer unlockæ¥é¿å…é—æ¼unlockæˆ–è€…å‡½æ•°è¿”å›å¯¼è‡´unlockæœªæ‰§è¡Œçš„æƒ…å†µå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":263862,"user_name":"Geek_771dd0","can_delete":false,"product_type":"c1","uid":1207372,"ip_address":"","ucode":"FC8F77F7D75EE9","user_header":"https://static001.geekbang.org/account/avatar/00/12/6c/4c/d87bb144.jpg","comment_is_top":false,"comment_ctime":1606283611,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606283611","product_id":100061801,"comment_content":"func (m *TokenRecursiveMutex) Lock(token int64) {<br>if atomic.LoadInt64(&amp;m.token)==token{<br>m.recursion++<br>return<br>}<br>m.Mutex.Lock()<br>atomic.StoreInt64(&amp;m.token,token)<br>m.recursion = 1<br>}<br>è¿™ä¸ªæ–¹æ³•åœ¨ä½¿ç”¨åŒä¸€ä¸ªstructå’Œtokenå¹¶å‘è°ƒç”¨çš„æƒ…å†µä¸‹ä¹Ÿä¼šé€ æˆé‡å¤åŠ é”çš„é—®é¢˜å§ï¼Œæ˜¯å¦åº”è¯¥åœ¨è¿›å…¥æ–¹æ³•æ—¶åŠ ä¸Šäº’æ–¥é”ï¼Œåœ¨é€€å‡ºæ—¶é‡Šæ”¾ï¼Ÿ","like_count":0},{"had_liked":false,"id":257700,"user_name":"niceshot","can_delete":false,"product_type":"c1","uid":1312493,"ip_address":"","ucode":"2C2BBC07A6E02D","user_header":"https://static001.geekbang.org/account/avatar/00/14/06/ed/5a167dda.jpg","comment_is_top":false,"comment_ctime":1604066938,"is_pvip":false,"replies":[{"id":"93894","content":"ç¬¬äºŒæ¬¡ä¸å°±é˜»å¡åœ¨è¿™é‡Œäº†ä¹ˆï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1604219993,"ip_address":"","comment_id":257700,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1604066938","product_id":100061801,"comment_content":"func (m *TokenRecursiveMutex) Lock(token int64)  {<br>\tif atomic.LoadInt64(&amp;m.token)==token{<br>\t\tm.recursion++<br>\t\treturn<br>\t}<br>\tm.Mutex.Lock()<br>\tatomic.StoreInt64(&amp;m.token,token)<br>\tm.recursion = 1<br>}<br>è¿™é‡Œå¦‚æœè°ƒç”¨è€…æä¾›å‰åä¸¤æ¬¡ä¸¤ä¸ªä¸åŒçš„token Mutex.Lock()ä¸å°±è°ƒç”¨ä¸¤æ¬¡äº†å—","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508421,"discussion_content":"ç¬¬äºŒæ¬¡ä¸å°±é˜»å¡åœ¨è¿™é‡Œäº†ä¹ˆï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604219993,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1312493,"avatar":"https://static001.geekbang.org/account/avatar/00/14/06/ed/5a167dda.jpg","nickname":"niceshot","note":"","ucode":"2C2BBC07A6E02D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319987,"discussion_content":"å¯¹å¯¹å‚»ä½äº† è°¢è°¢å›å¤","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604222028,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":255182,"user_name":"niceshot","can_delete":false,"product_type":"c1","uid":1312493,"ip_address":"","ucode":"2C2BBC07A6E02D","user_header":"https://static001.geekbang.org/account/avatar/00/14/06/ed/5a167dda.jpg","comment_is_top":false,"comment_ctime":1603277067,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1603277067","product_id":100061801,"comment_content":"å¯é‡å…¥é”åˆ°åº•æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1050946,"avatar":"https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg","nickname":"Hurt","note":"","ucode":"DCE7428CCF08EF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":324782,"discussion_content":"Docker çš„issue 36114 æ˜¯ä¸€ä¸ªæ­»é”é—®é¢˜ã€‚ è€å¸ˆä¸æ˜¯ä¸¾ä¾‹å­äº†å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605170301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1312493,"avatar":"https://static001.geekbang.org/account/avatar/00/14/06/ed/5a167dda.jpg","nickname":"niceshot","note":"","ucode":"2C2BBC07A6E02D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1050946,"avatar":"https://static001.geekbang.org/account/avatar/00/10/09/42/1f762b72.jpg","nickname":"Hurt","note":"","ucode":"DCE7428CCF08EF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":325015,"discussion_content":"æˆ‘å¯¹è¿™ä¸ªä¸æ˜¯å¾ˆæ˜ç™½ æˆ‘çš„æ„æ€åœ¨lockå†…éƒ¨ç»§ç»­lockæ˜¯åŸºäºä»€ä¹ˆè€ƒè™‘ å¤–éƒ¨ä¸æ˜¯å·²ç»lockäº†å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605222686,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":324782,"ip_address":""},"score":325015,"extra":""}]}]},{"had_liked":false,"id":255003,"user_name":"Jasper","can_delete":false,"product_type":"c1","uid":1202174,"ip_address":"","ucode":"A07ABF45D39089","user_header":"https://static001.geekbang.org/account/avatar/00/12/57/fe/beab006d.jpg","comment_is_top":false,"comment_ctime":1603248505,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1603248505","product_id":100061801,"comment_content":"æ„Ÿè§‰å¤§ä½¬ä»¬çŠ¯çš„é”™è¯¯éƒ½æ˜¯æˆ‘ä¼šçŠ¯çš„ï¼Œå“ˆå“ˆå“ˆã€‚è€å¸ˆè®²çš„ç®€å•æ˜“æ‡‚ï¼Œæ³¨é‡Šä¹Ÿå¾ˆå…¨é¢ã€‚åŠ æ²¹åŠ æ²¹ã€‚","like_count":0},{"had_liked":false,"id":254734,"user_name":"Panda","can_delete":false,"product_type":"c1","uid":1095740,"ip_address":"","ucode":"911A200C7B18BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/b8/3c/1a294619.jpg","comment_is_top":false,"comment_ctime":1603177871,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603177871","product_id":100061801,"comment_content":"ä¿è¯ Lock&#47;Unlock æˆå¯¹å‡ºç°","like_count":0},{"had_liked":false,"id":254330,"user_name":"å°é¾™è™¾","can_delete":false,"product_type":"c1","uid":1141385,"ip_address":"","ucode":"A6DFC7DD17E297","user_header":"https://static001.geekbang.org/account/avatar/00/11/6a/89/3cac9f83.jpg","comment_is_top":false,"comment_ctime":1603101053,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603101053","product_id":100061801,"comment_content":"æ‰“å¡","like_count":0},{"had_liked":false,"id":254135,"user_name":"Bug? Feature!","can_delete":false,"product_type":"c1","uid":1164531,"ip_address":"","ucode":"F8FA8A0094FBA0","user_header":"https://static001.geekbang.org/account/avatar/00/11/c4/f3/92f654f1.jpg","comment_is_top":false,"comment_ctime":1603070877,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603070877","product_id":100061801,"comment_content":"è€å¸ˆè®²çš„çœŸå¥½ï¼Œè·Ÿç€è€å¸ˆä¸€è·¯æ‰“æ€ª~","like_count":0},{"had_liked":false,"id":253725,"user_name":"æ˜Ÿäº¦è¾°","can_delete":false,"product_type":"c1","uid":1284592,"ip_address":"","ucode":"B0388FBFFDEE7E","user_header":"https://static001.geekbang.org/account/avatar/00/13/99/f0/d9343049.jpg","comment_is_top":false,"comment_ctime":1602844945,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1602844945","product_id":100061801,"comment_content":"A-&gt;B-&gt;C-&gt;A å…¸å‹çš„æ­»é”äº† ","like_count":0},{"had_liked":false,"id":253621,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1602813657,"is_pvip":false,"replies":[{"id":"92628","content":"åˆçœ‹åˆ°ä½ æ‰“å¡äº†","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1602820323,"ip_address":"","comment_id":253621,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1602813657","product_id":100061801,"comment_content":"æ›´æ–°åœ°å¥½å¿«ï¼Œä¸Šä¸€è®²çš„æºç è¿˜æ²¡æ¶ˆåŒ–å®Œï¼Œæ–°çš„ä¸€è®²åˆå‡ºäº†â€¦â€¦","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":507127,"discussion_content":"åˆçœ‹åˆ°ä½ æ‰“å¡äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1602820323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}