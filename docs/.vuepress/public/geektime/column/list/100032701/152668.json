{"id":152668,"title":"32 | è‡ªå·±åŠ¨æ‰‹å†™é«˜æ€§èƒ½HTTPæœåŠ¡å™¨ï¼ˆä¸€ï¼‰ï¼šè®¾è®¡å’Œæ€è·¯","content":"<p>\bä½ å¥½ï¼Œæˆ‘æ˜¯ç››å»¶æ•ï¼Œè¿™é‡Œæ˜¯ç½‘ç»œç¼–ç¨‹å®æˆ˜ç¬¬32è®²ï¼Œæ¬¢è¿å›æ¥ã€‚</p><p>ä»è¿™ä¸€è®²å¼€å§‹ï¼Œæˆ‘ä»¬è¿›å…¥å®æˆ˜ç¯‡ï¼Œå¼€å¯ä¸€ä¸ªé«˜æ€§èƒ½HTTPæœåŠ¡å™¨çš„ç¼–å†™ä¹‹æ—…ã€‚</p><p>åœ¨å¼€å§‹ç¼–å†™é«˜æ€§èƒ½HTTPæœåŠ¡å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦æ„å»ºä¸€ä¸ªæ”¯æŒTCPçš„é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œå®Œæˆè¿™ä¸ªTCPé«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶ä¹‹åï¼Œå†å¢åŠ HTTPç‰¹æ€§çš„æ”¯æŒå°±æ¯”è¾ƒå®¹æ˜“äº†ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå¿«å¼€å‘å‡ºä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPæœåŠ¡å™¨ç¨‹åºã€‚</p><h2>è®¾è®¡éœ€æ±‚</h2><p>åœ¨ç¬¬ä¸‰ä¸ªæ¨¡å—æ€§èƒ½ç¯‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨è¿™ä¸ªç½‘ç»œç¼–ç¨‹æ¡†æ¶å®Œæˆäº†å¤šä¸ªåº”ç”¨ç¨‹åºçš„å¼€å‘ï¼Œè¿™ä¹Ÿç­‰äºå¯¹ç½‘ç»œç¼–ç¨‹æ¡†æ¶æå‡ºäº†ç¼–ç¨‹æ¥å£æ–¹é¢çš„éœ€æ±‚ã€‚ç»¼åˆä¹‹å‰çš„ä½¿ç”¨ç»éªŒï¼ŒTCPé«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶éœ€è¦æ»¡è¶³çš„éœ€æ±‚æœ‰ä»¥ä¸‹ä¸‰ç‚¹ã€‚</p><p>ç¬¬ä¸€ï¼Œé‡‡ç”¨reactoræ¨¡å‹ï¼Œå¯ä»¥çµæ´»ä½¿ç”¨poll/epollä½œä¸ºäº‹ä»¶åˆ†å‘å®ç°ã€‚</p><p>ç¬¬äºŒï¼Œå¿…é¡»æ”¯æŒå¤šçº¿ç¨‹ï¼Œä»è€Œå¯ä»¥æ”¯æŒå•çº¿ç¨‹å•reactoræ¨¡å¼ï¼Œä¹Ÿå¯ä»¥æ”¯æŒå¤šçº¿ç¨‹ä¸»-ä»reactoræ¨¡å¼ã€‚å¯ä»¥å°†å¥—æ¥å­—ä¸Šçš„I/Oäº‹ä»¶åˆ†ç¦»åˆ°å¤šä¸ªçº¿ç¨‹ä¸Šã€‚</p><p>ç¬¬ä¸‰ï¼Œå°è£…è¯»å†™æ“ä½œåˆ°Bufferå¯¹è±¡ä¸­ã€‚</p><p>æŒ‰ç…§è¿™ä¸‰ä¸ªéœ€æ±‚ï¼Œæ­£å¥½å¯ä»¥æŠŠæ•´ä½“è®¾è®¡æ€è·¯åˆ†æˆä¸‰å—æ¥è®²è§£ï¼Œåˆ†åˆ«åŒ…æ‹¬ååº”å †æ¨¡å¼è®¾è®¡ã€I/Oæ¨¡å‹å’Œå¤šçº¿ç¨‹æ¨¡å‹è®¾è®¡ã€æ•°æ®è¯»å†™å°è£…å’Œbufferã€‚ä»Šå¤©æˆ‘ä»¬ä¸»è¦è®²ä¸€ä¸‹ä¸»è¦çš„è®¾è®¡æ€è·¯å’Œæ•°æ®ç»“æ„ï¼Œä»¥åŠååº”å †æ¨¡å¼è®¾è®¡ã€‚</p><!-- [[[read_end]]] --><h2>ä¸»è¦è®¾è®¡æ€è·¯</h2><h3>ååº”å †æ¨¡å¼è®¾è®¡</h3><p>ååº”å †æ¨¡å¼ï¼ŒæŒ‰ç…§æ€§èƒ½ç¯‡çš„è®²è§£ï¼Œä¸»è¦æ˜¯è®¾è®¡ä¸€ä¸ªåŸºäºäº‹ä»¶åˆ†å‘å’Œå›è°ƒçš„ååº”å †æ¡†æ¶ã€‚è¿™ä¸ªæ¡†æ¶é‡Œé¢çš„ä¸»è¦å¯¹è±¡åŒ…æ‹¬ï¼š</p><ul>\n<li>\n<h3>event_loop</h3>\n</li>\n</ul><p>ä½ å¯ä»¥æŠŠevent_loopè¿™ä¸ªå¯¹è±¡ç†è§£æˆå’Œä¸€ä¸ªçº¿ç¨‹ç»‘å®šçš„æ— é™äº‹ä»¶å¾ªç¯ï¼Œä½ ä¼šåœ¨å„ç§è¯­è¨€é‡Œçœ‹åˆ°event_loopè¿™ä¸ªæŠ½è±¡ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ç€çš„äº‹ä»¶åˆ†å‘å™¨ï¼Œä¸€æ—¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå®ƒå°±ä¼šå›è°ƒé¢„å…ˆå®šä¹‰å¥½çš„å›è°ƒå‡½æ•°ï¼Œå®Œæˆäº‹ä»¶çš„å¤„ç†ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œevent_loopä½¿ç”¨pollæˆ–è€…epollæ–¹æ³•å°†ä¸€ä¸ªçº¿ç¨‹é˜»å¡ï¼Œç­‰å¾…å„ç§I/Oäº‹ä»¶çš„å‘ç”Ÿã€‚</p><ul>\n<li>\n<h3>channel</h3>\n</li>\n</ul><p>å¯¹å„ç§æ³¨å†Œåˆ°event_loopä¸Šçš„å¯¹è±¡ï¼Œæˆ‘ä»¬æŠ½è±¡æˆchannelæ¥è¡¨ç¤ºï¼Œä¾‹å¦‚æ³¨å†Œåˆ°event_loopä¸Šçš„ç›‘å¬äº‹ä»¶ï¼Œæ³¨å†Œåˆ°event_loopä¸Šçš„å¥—æ¥å­—è¯»å†™äº‹ä»¶ç­‰ã€‚åœ¨å„ç§è¯­è¨€çš„APIé‡Œï¼Œä½ éƒ½ä¼šçœ‹åˆ°channelè¿™ä¸ªå¯¹è±¡ï¼Œå¤§ä½“ä¸Šå®ƒä»¬è¡¨è¾¾çš„æ„æ€è·Ÿæˆ‘ä»¬è¿™é‡Œçš„è®¾è®¡æ€è·¯æ˜¯æ¯”è¾ƒä¸€è‡´çš„ã€‚</p><ul>\n<li>\n<h3>acceptor</h3>\n</li>\n</ul><p>acceptorå¯¹è±¡è¡¨ç¤ºçš„æ˜¯æœåŠ¡å™¨ç«¯ç›‘å¬å™¨ï¼Œacceptorå¯¹è±¡æœ€ç»ˆä¼šä½œä¸ºä¸€ä¸ªchannelå¯¹è±¡ï¼Œæ³¨å†Œåˆ°event_loopä¸Šï¼Œä»¥ä¾¿è¿›è¡Œè¿æ¥å®Œæˆçš„äº‹ä»¶åˆ†å‘å’Œæ£€æµ‹ã€‚</p><ul>\n<li>\n<h3>event_dispatcher</h3>\n</li>\n</ul><p>event_dispatcheræ˜¯å¯¹äº‹ä»¶åˆ†å‘æœºåˆ¶çš„ä¸€ç§æŠ½è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŸºäºpollçš„poll_dispatcherï¼Œä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªåŸºäºepollçš„epoll_dispatcherã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç»Ÿä¸€è®¾è®¡ä¸€ä¸ªevent_dispatcherç»“æ„ä½“ï¼Œæ¥æŠ½è±¡è¿™äº›è¡Œä¸ºã€‚</p><ul>\n<li>\n<h3>channel_map</h3>\n</li>\n</ul><p>channel_mapä¿å­˜äº†æè¿°å­—åˆ°channelçš„æ˜ å°„ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ ¹æ®äº‹ä»¶ç±»å‹å¯¹åº”çš„å¥—æ¥å­—å¿«é€Ÿæ‰¾åˆ°channelå¯¹è±¡é‡Œçš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚</p><h3>I/Oæ¨¡å‹å’Œå¤šçº¿ç¨‹æ¨¡å‹è®¾è®¡</h3><p>I/Oçº¿ç¨‹å’Œå¤šçº¿ç¨‹æ¨¡å‹ï¼Œä¸»è¦è§£å†³event_loopçš„çº¿ç¨‹è¿è¡Œé—®é¢˜ï¼Œä»¥åŠäº‹ä»¶åˆ†å‘å’Œå›è°ƒçš„çº¿ç¨‹æ‰§è¡Œé—®é¢˜ã€‚</p><ul>\n<li>\n<h3>thread_pool</h3>\n</li>\n</ul><p>thread_poolç»´æŠ¤äº†ä¸€ä¸ªsub-reactorçš„çº¿ç¨‹åˆ—è¡¨ï¼Œå®ƒå¯ä»¥æä¾›ç»™ä¸»reactorçº¿ç¨‹ä½¿ç”¨ï¼Œæ¯æ¬¡å½“æœ‰æ–°çš„è¿æ¥å»ºç«‹æ—¶ï¼Œå¯ä»¥ä»thread_poolé‡Œè·å–ä¸€ä¸ªçº¿ç¨‹ï¼Œä»¥ä¾¿ç”¨å®ƒæ¥å®Œæˆå¯¹æ–°è¿æ¥å¥—æ¥å­—çš„read/writeäº‹ä»¶æ³¨å†Œï¼Œå°†I/Oçº¿ç¨‹å’Œä¸»reactorçº¿ç¨‹åˆ†ç¦»ã€‚</p><ul>\n<li>\n<h3>event_loop_thread</h3>\n</li>\n</ul><p>event_loop_threadæ˜¯reactorçš„çº¿ç¨‹å®ç°ï¼Œè¿æ¥å¥—æ¥å­—çš„read/writeäº‹ä»¶æ£€æµ‹éƒ½æ˜¯åœ¨è¿™ä¸ªçº¿ç¨‹é‡Œå®Œæˆçš„ã€‚</p><h3>Bufferå’Œæ•°æ®è¯»å†™</h3><ul>\n<li>\n<h3>buffer</h3>\n</li>\n</ul><p>bufferå¯¹è±¡å±è”½äº†å¯¹å¥—æ¥å­—è¿›è¡Œçš„å†™å’Œè¯»çš„æ“ä½œï¼Œå¦‚æœæ²¡æœ‰bufferå¯¹è±¡ï¼Œè¿æ¥å¥—æ¥å­—çš„read/writeäº‹ä»¶éƒ½éœ€è¦å’Œå­—èŠ‚æµç›´æ¥æ‰“äº¤é“ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å‹å¥½çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿæä¾›äº†ä¸€ä¸ªåŸºæœ¬çš„bufferå¯¹è±¡ï¼Œç”¨æ¥è¡¨ç¤ºä»è¿æ¥å¥—æ¥å­—æ”¶å–çš„æ•°æ®ï¼Œä»¥åŠåº”ç”¨ç¨‹åºå³å°†éœ€è¦å‘é€å‡ºå»çš„æ•°æ®ã€‚</p><ul>\n<li>\n<h3>tcp_connection</h3>\n</li>\n</ul><p>tcp_connectionè¿™ä¸ªå¯¹è±¡æè¿°çš„æ˜¯å·²å»ºç«‹çš„TCPè¿æ¥ã€‚å®ƒçš„å±æ€§åŒ…æ‹¬æ¥æ”¶ç¼“å†²åŒºã€å‘é€ç¼“å†²åŒºã€channelå¯¹è±¡ç­‰ã€‚è¿™äº›éƒ½æ˜¯ä¸€ä¸ªTCPè¿æ¥çš„å¤©ç„¶å±æ€§ã€‚</p><p>tcp_connectionæ˜¯å¤§éƒ¨åˆ†åº”ç”¨ç¨‹åºå’Œæˆ‘ä»¬çš„é«˜æ€§èƒ½æ¡†æ¶ç›´æ¥æ‰“äº¤é“çš„æ•°æ®ç»“æ„ã€‚æˆ‘ä»¬ä¸æƒ³æŠŠæœ€ä¸‹å±‚çš„channelå¯¹è±¡æš´éœ²ç»™åº”ç”¨ç¨‹åºï¼Œå› ä¸ºæŠ½è±¡çš„channelå¯¹è±¡ä¸ä»…ä»…å¯ä»¥è¡¨ç¤ºtcp_connectionï¼Œå‰é¢æåˆ°çš„ç›‘å¬å¥—æ¥å­—ä¹Ÿæ˜¯ä¸€ä¸ªchannelå¯¹è±¡ï¼Œåé¢æåˆ°çš„å”¤é†’socketpairä¹Ÿæ˜¯ä¸€ä¸ª channelå¯¹è±¡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è®¾è®¡äº†tcp_connectionè¿™ä¸ªå¯¹è±¡ï¼Œå¸Œæœ›å¯ä»¥æä¾›ç»™ç”¨æˆ·æ¯”è¾ƒæ¸…æ™°çš„ç¼–ç¨‹å…¥å£ã€‚</p><h2>ååº”å †æ¨¡å¼è®¾è®¡</h2><h3>æ¦‚è¿°</h3><p>ä¸‹é¢ï¼Œæˆ‘ä»¬è¯¦ç»†è®²è§£ä¸€ä¸‹ä»¥event_loopä¸ºæ ¸å¿ƒçš„ååº”å †æ¨¡å¼è®¾è®¡ã€‚è¿™é‡Œæœ‰ä¸€å¼ event_loopçš„è¿è¡Œè¯¦å›¾ï¼Œä½ å¯ä»¥å¯¹ç…§è¿™å¼ å›¾æ¥ç†è§£ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7a/61/7ab9f89544aba2021a9d2ceb94ad9661.jpg?wh=3499*1264\" alt=\"\"></p><p>å½“event_loop_runå®Œæˆä¹‹åï¼Œçº¿ç¨‹è¿›å…¥å¾ªç¯ï¼Œé¦–å…ˆæ‰§è¡Œdispatchäº‹ä»¶åˆ†å‘ï¼Œä¸€æ—¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå°±ä¼šè°ƒç”¨channel_event_activateå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆäº‹ä»¶å›è°ƒå‡½æ•°eventReadcallbackå’ŒeventWritecallbackçš„è°ƒç”¨ï¼Œæœ€åå†è¿›è¡Œevent_loop_handle_pending_channelï¼Œç”¨æ¥ä¿®æ”¹å½“å‰ç›‘å¬çš„äº‹ä»¶åˆ—è¡¨ï¼Œå®Œæˆè¿™ä¸ªéƒ¨åˆ†ä¹‹åï¼Œåˆè¿›å…¥äº†äº‹ä»¶åˆ†å‘å¾ªç¯ã€‚</p><h3>event_loopåˆ†æ</h3><p>è¯´event_loopæ˜¯æ•´ä¸ªååº”å †æ¨¡å¼è®¾è®¡çš„æ ¸å¿ƒï¼Œä¸€ç‚¹ä¹Ÿä¸ä¸ºè¿‡ã€‚å…ˆçœ‹ä¸€ä¸‹event_loopçš„æ•°æ®ç»“æ„ã€‚</p><p>åœ¨è¿™ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œæœ€é‡è¦çš„è«è¿‡äºevent_dispatcherå¯¹è±¡äº†ã€‚ä½ å¯ä»¥ç®€å•åœ°æŠŠevent_dispatcherç†è§£ä¸ºpollæˆ–è€…epollï¼Œå®ƒå¯ä»¥è®©æˆ‘ä»¬çš„çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œå°±æ˜¯event_dispatcher_dataï¼Œå®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªvoid *ç±»å‹ï¼Œå¯ä»¥æŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä»»æ„æ”¾ç½®ä¸€ä¸ªæˆ‘ä»¬éœ€è¦çš„å¯¹è±¡æŒ‡é’ˆã€‚è¿™æ ·ï¼Œé’ˆå¯¹ä¸åŒçš„å®ç°ï¼Œä¾‹å¦‚pollæˆ–è€…epollï¼Œéƒ½å¯ä»¥æ ¹æ®éœ€æ±‚ï¼Œæ”¾ç½®ä¸åŒçš„æ•°æ®å¯¹è±¡ã€‚</p><p>event_loopä¸­è¿˜ä¿ç•™äº†å‡ ä¸ªè·Ÿå¤šçº¿ç¨‹æœ‰å…³çš„å¯¹è±¡ï¼Œå¦‚owner_thread_idæ˜¯ä¿ç•™äº†æ¯ä¸ªevent loopçš„çº¿ç¨‹IDï¼Œmutexå’Œconæ˜¯ç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥çš„ã€‚</p><p>socketPairæ˜¯çˆ¶çº¿ç¨‹ç”¨æ¥é€šçŸ¥å­çº¿ç¨‹æœ‰æ–°çš„äº‹ä»¶éœ€è¦å¤„ç†ã€‚pending_headå’Œpending_tailæ˜¯ä¿ç•™åœ¨å­çº¿ç¨‹å†…çš„éœ€è¦å¤„ç†çš„æ–°äº‹ä»¶ã€‚</p><pre><code>struct event_loop {\n    int quit;\n    const struct event_dispatcher *eventDispatcher;\n\n    /** å¯¹åº”çš„event_dispatcherçš„æ•°æ®. */\n    void *event_dispatcher_data;\n    struct channel_map *channelMap;\n\n    int is_handle_pending;\n    struct channel_element *pending_head;\n    struct channel_element *pending_tail;\n\n    pthread_t owner_thread_id;\n    pthread_mutex_t mutex;\n    pthread_cond_t cond;\n    int socketPair[2];\n    char *thread_name;\n};\n</code></pre><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹event_loopæœ€ä¸»è¦çš„æ–¹æ³•event_loop_runæ–¹æ³•ï¼Œå‰é¢æåˆ°è¿‡ï¼Œevent_loopå°±æ˜¯ä¸€ä¸ªæ— é™whileå¾ªç¯ï¼Œä¸æ–­åœ°åœ¨åˆ†å‘äº‹ä»¶ã€‚</p><pre><code>/**\n *\n * 1.å‚æ•°éªŒè¯\n * 2.è°ƒç”¨dispatcheræ¥è¿›è¡Œäº‹ä»¶åˆ†å‘,åˆ†å‘å®Œå›è°ƒäº‹ä»¶å¤„ç†å‡½æ•°\n */\nint event_loop_run(struct event_loop *eventLoop) {\n    assert(eventLoop != NULL);\n\n    struct event_dispatcher *dispatcher = eventLoop-&gt;eventDispatcher;\n\n    if (eventLoop-&gt;owner_thread_id != pthread_self()) {\n        exit(1);\n    }\n\n    yolanda_msgx(&quot;event loop run, %s&quot;, eventLoop-&gt;thread_name);\n    struct timeval timeval;\n    timeval.tv_sec = 1;\n\n    while (!eventLoop-&gt;quit) {\n        //block here to wait I/O event, and get active channels\n        dispatcher-&gt;dispatch(eventLoop, &amp;timeval);\n\n        //handle the pending channel\n        event_loop_handle_pending_channel(eventLoop);\n    }\n\n    yolanda_msgx(&quot;event loop end, %s&quot;, eventLoop-&gt;thread_name);\n    return 0;\n}\n</code></pre><p>ä»£ç å¾ˆæ˜æ˜¾åœ°åæ˜ äº†è¿™ä¸€ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨event_loopä¸é€€å‡ºçš„æƒ…å†µä¸‹ï¼Œä¸€ç›´åœ¨å¾ªç¯ï¼Œå¾ªç¯ä½“ä¸­è°ƒç”¨äº†dispatcherå¯¹è±¡çš„dispatchæ–¹æ³•æ¥ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚</p><h3>event_dispacheråˆ†æ</h3><p>ä¸ºäº†å®ç°ä¸åŒçš„äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Œè¿™é‡ŒæŠŠpollã€epollç­‰æŠ½è±¡æˆäº†ä¸€ä¸ªevent_dispatcherç»“æ„ã€‚event_dispatcherçš„å…·ä½“å®ç°æœ‰poll_dispatcherå’Œepoll_dispatcherä¸¤ç§ï¼Œå®ç°çš„æ–¹æ³•å’Œæ€§èƒ½ç¯‡<a href=\"https://time.geekbang.org/column/article/140520\">21</a><a href=\"https://time.geekbang.org/column/article/140520\">è®²</a>å’Œ<a href=\"https://time.geekbang.org/column/article/141573\">22è®²</a>ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œä½ å¦‚æœæœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥ç›´æ¥ç ”è¯»ä»£ç ã€‚</p><pre><code>/** æŠ½è±¡çš„event_dispatcherç»“æ„ä½“ï¼Œå¯¹åº”çš„å®ç°å¦‚select,poll,epollç­‰I/Oå¤ç”¨. */\nstruct event_dispatcher {\n    /**  å¯¹åº”å®ç° */\n    const char *name;\n\n    /**  åˆå§‹åŒ–å‡½æ•° */\n    void *(*init)(struct event_loop * eventLoop);\n\n    /** é€šçŸ¥dispatcheræ–°å¢ä¸€ä¸ªchanneläº‹ä»¶*/\n    int (*add)(struct event_loop * eventLoop, struct channel * channel);\n\n    /** é€šçŸ¥dispatcheråˆ é™¤ä¸€ä¸ªchanneläº‹ä»¶*/\n    int (*del)(struct event_loop * eventLoop, struct channel * channel);\n\n    /** é€šçŸ¥dispatcheræ›´æ–°channelå¯¹åº”çš„äº‹ä»¶*/\n    int (*update)(struct event_loop * eventLoop, struct channel * channel);\n\n    /** å®ç°äº‹ä»¶åˆ†å‘ï¼Œç„¶åè°ƒç”¨event_loopçš„event_activateæ–¹æ³•æ‰§è¡Œcallback*/\n    int (*dispatch)(struct event_loop * eventLoop, struct timeval *);\n\n    /** æ¸…é™¤æ•°æ® */\n    void (*clear)(struct event_loop * eventLoop);\n};\n</code></pre><h3>channelå¯¹è±¡åˆ†æ</h3><p>channelå¯¹è±¡æ˜¯ç”¨æ¥å’Œevent_dispatherè¿›è¡Œäº¤äº’çš„æœ€ä¸»è¦çš„ç»“æ„ä½“ï¼Œå®ƒæŠ½è±¡äº†äº‹ä»¶åˆ†å‘ã€‚ä¸€ä¸ªchannelå¯¹åº”ä¸€ä¸ªæè¿°å­—ï¼Œæè¿°å­—ä¸Šå¯ä»¥æœ‰READå¯è¯»äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥æœ‰WRITEå¯å†™äº‹ä»¶ã€‚channelå¯¹è±¡ç»‘å®šäº†äº‹ä»¶å¤„ç†å‡½æ•°event_read_callbackå’Œevent_write_callbackã€‚</p><pre><code>typedef int (*event_read_callback)(void *data);\n\ntypedef int (*event_write_callback)(void *data);\n\nstruct channel {\n    int fd;\n    int events;   //è¡¨ç¤ºeventç±»å‹\n\n    event_read_callback eventReadCallback;\n    event_write_callback eventWriteCallback;\n    void *data; //callback data, å¯èƒ½æ˜¯event_loopï¼Œä¹Ÿå¯èƒ½æ˜¯tcp_serveræˆ–è€…tcp_connection\n};\n</code></pre><h3>channel_mapå¯¹è±¡åˆ†æ</h3><p>event_dispatcheråœ¨è·å¾—æ´»åŠ¨äº‹ä»¶åˆ—è¡¨ä¹‹åï¼Œéœ€è¦é€šè¿‡æ–‡ä»¶æè¿°å­—æ‰¾åˆ°å¯¹åº”çš„channelï¼Œä»è€Œå›è°ƒchannelä¸Šçš„äº‹ä»¶å¤„ç†å‡½æ•°event_read_callbackå’Œevent_write_callbackï¼Œä¸ºæ­¤ï¼Œè®¾è®¡äº†channel_mapå¯¹è±¡ã€‚</p><pre><code>/**\n * channelæ˜ å°„è¡¨, keyä¸ºå¯¹åº”çš„socketæè¿°å­—\n */\nstruct channel_map {\n    void **entries;\n\n    /* The number of entries available in entries */\n    int nentries;\n};\n</code></pre><p>channel_mapå¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ä¸‹æ ‡å³ä¸ºæè¿°å­—ï¼Œæ•°ç»„çš„å…ƒç´ ä¸ºchannelå¯¹è±¡çš„åœ°å€ã€‚</p><p>æ¯”å¦‚æè¿°å­—3å¯¹åº”çš„channelï¼Œå°±å¯ä»¥è¿™æ ·ç›´æ¥å¾—åˆ°ã€‚</p><pre><code>struct chanenl * channel = map-&gt;entries[3];\n</code></pre><p>è¿™æ ·ï¼Œå½“event_dispatcheréœ€è¦å›è°ƒchannelä¸Šçš„è¯»ã€å†™å‡½æ•°æ—¶ï¼Œè°ƒç”¨channel_event_activateå°±å¯ä»¥ï¼Œä¸‹é¢æ˜¯channel_event_activateçš„å®ç°ï¼Œåœ¨æ‰¾åˆ°äº†å¯¹åº”çš„channelå¯¹è±¡ä¹‹åï¼Œæ ¹æ®äº‹ä»¶ç±»å‹ï¼Œå›è°ƒäº†è¯»å‡½æ•°æˆ–è€…å†™å‡½æ•°ã€‚æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨äº†EVENT_READå’ŒEVENT_WRITEæ¥æŠ½è±¡äº†pollå’Œepollçš„æ‰€æœ‰è¯»å†™äº‹ä»¶ç±»å‹ã€‚</p><pre><code>int channel_event_activate(struct event_loop *eventLoop, int fd, int revents) {\n    struct channel_map *map = eventLoop-&gt;channelMap;\n    yolanda_msgx(&quot;activate channel fd == %d, revents=%d, %s&quot;, fd, revents, eventLoop-&gt;thread_name);\n\n    if (fd &lt; 0)\n        return 0;\n\n    if (fd &gt;= map-&gt;nentries)return (-1);\n\n    struct channel *channel = map-&gt;entries[fd];\n    assert(fd == channel-&gt;fd);\n\n    if (revents &amp; (EVENT_READ)) {\n        if (channel-&gt;eventReadCallback) channel-&gt;eventReadCallback(channel-&gt;data);\n    }\n    if (revents &amp; (EVENT_WRITE)) {\n        if (channel-&gt;eventWriteCallback) channel-&gt;eventWriteCallback(channel-&gt;data);\n    }\n\n    return 0;\n}\n</code></pre><h3>å¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹channel event</h3><p>é‚£ä¹ˆå¦‚ä½•å¢åŠ æ–°çš„channel eventäº‹ä»¶å‘¢ï¼Ÿä¸‹é¢è¿™å‡ ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹channel eventäº‹ä»¶çš„ã€‚</p><pre><code>int event_loop_add_channel_event(struct event_loop *eventLoop, int fd, struct channel *channel1);\n\nint event_loop_remove_channel_event(struct event_loop *eventLoop, int fd, struct channel *channel1);\n\nint event_loop_update_channel_event(struct event_loop *eventLoop, int fd, struct channel *channel1);\n</code></pre><p>å‰é¢ä¸‰ä¸ªå‡½æ•°æä¾›äº†å…¥å£èƒ½åŠ›ï¼Œè€ŒçœŸæ­£çš„å®ç°åˆ™è½åœ¨è¿™ä¸‰ä¸ªå‡½æ•°ä¸Šï¼š</p><pre><code>int event_loop_handle_pending_add(struct event_loop *eventLoop, int fd, struct channel *channel);\n\nint event_loop_handle_pending_remove(struct event_loop *eventLoop, int fd, struct channel *channel);\n\nint event_loop_handle_pending_update(struct event_loop *eventLoop, int fd, struct channel *channel);\n</code></pre><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶ä¸­çš„ä¸€ä¸ªå®ç°ï¼Œevent_loop_handle_pending_addåœ¨å½“å‰event_loopçš„channel_mapé‡Œå¢åŠ ä¸€ä¸ªæ–°çš„key-valueå¯¹ï¼Œkeyæ˜¯æ–‡ä»¶æè¿°å­—ï¼Œvalueæ˜¯channelå¯¹è±¡çš„åœ°å€ã€‚ä¹‹åè°ƒç”¨event_dispatcherå¯¹è±¡çš„addæ–¹æ³•å¢åŠ channel eventäº‹ä»¶ã€‚æ³¨æ„è¿™ä¸ªæ–¹æ³•æ€»åœ¨å½“å‰çš„I/Oçº¿ç¨‹ä¸­æ‰§è¡Œã€‚</p><pre><code>// in the i/o thread\nint event_loop_handle_pending_add(struct event_loop *eventLoop, int fd, struct channel *channel) {\n    yolanda_msgx(&quot;add channel fd == %d, %s&quot;, fd, eventLoop-&gt;thread_name);\n    struct channel_map *map = eventLoop-&gt;channelMap;\n\n    if (fd &lt; 0)\n        return 0;\n\n    if (fd &gt;= map-&gt;nentries) {\n        if (map_make_space(map, fd, sizeof(struct channel *)) == -1)\n            return (-1);\n    }\n\n    //ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œå¢åŠ \n    if ((map)-&gt;entries[fd] == NULL) {\n        map-&gt;entries[fd] = channel;\n        //add channel\n        struct event_dispatcher *eventDispatcher = eventLoop-&gt;eventDispatcher;\n        eventDispatcher-&gt;add(eventLoop, channel);\n        return 1;\n    }\n\n    return 0;\n}\n</code></pre><h2>æ€»ç»“</h2><p>åœ¨è¿™ä¸€è®²é‡Œï¼Œæˆ‘ä»¬ä»‹ç»äº†é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ¡†æ¶çš„ä¸»è¦è®¾è®¡æ€è·¯å’ŒåŸºæœ¬æ•°æ®ç»“æ„ï¼Œä»¥åŠååº”å †è®¾è®¡ç›¸å…³çš„å…·ä½“åšæ³•ã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­ç¼–å†™é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ¡†æ¶çš„çº¿ç¨‹æ¨¡å‹ä»¥åŠè¯»å†™Bufferéƒ¨åˆ†ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>å’Œå¾€å¸¸ä¸€æ ·ï¼Œç»™ä½ ç•™ä¸¤é“æ€è€ƒé¢˜:</p><p>ç¬¬ä¸€é“ï¼Œå¦‚æœä½ æœ‰å…´è¶£ï¼Œä¸å¦¨å®ç°ä¸€ä¸ªselect_dispatcherå¯¹è±¡ï¼Œç”¨selectæ–¹æ³•å®ç°å®šä¹‰å¥½çš„event_dispatcheræ¥å£ï¼›</p><p>ç¬¬äºŒé“ï¼Œä»”ç»†ç ”è¯»channel_mapå®ç°ä¸­çš„map_make_spaceéƒ¨åˆ†ï¼Œè¯´è¯´ä½ çš„ç†è§£ã€‚</p><p>æ¬¢è¿ä½ åœ¨è¯„è®ºåŒºå†™ä¸‹ä½ çš„æ€è€ƒï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–è€…åŒäº‹ï¼Œä¸€èµ·äº¤æµä¸€ä¸‹ã€‚</p>","comments":[{"had_liked":false,"id":143255,"user_name":"LDxy","can_delete":false,"product_type":"c1","uid":1188710,"ip_address":"","ucode":"956432CE7B7761","user_header":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","comment_is_top":false,"comment_ctime":1571657459,"is_pvip":false,"replies":[{"id":"55843","content":"è¿™å—æ˜¯æˆ‘çš„ç–å¿½ï¼Œåº”è¯¥ç›´æ¥èµ‹å€¼çš„ï¼Œå¯èƒ½æ˜¯å¼€å§‹æˆ‘æ’°å†™çš„æ—¶å€™channelå¯¹è±¡çš„åˆå§‹åŒ–æ”¾åˆ°äº†event_loop_handle_pending_addå‡½æ•°ä¸­ï¼Œåæ¥æŠŠchannelå¯¹è±¡çš„åˆå§‹åŒ–é‡æ„åˆ°å¤–é¢ï¼Œè¿™é‡Œå¿˜è®°åˆ æ‰äº†ã€‚<br><br>å·²ç»æ›´æ–°æ–‡ç¨¿(å¾…å‘¨ä¸€ç¼–è¾‘æ›´æ–°)å’Œgithubä»£ç ï¼Œæ„Ÿè°¢æŒ‡æ­£ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572064101,"ip_address":"","comment_id":143255,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31636428531","product_id":100032701,"comment_content":"event_loop_handle_pending_addå‡½æ•°ä¸­ï¼Œ<br>map-&gt;entries[fd] = calloc(1, sizeof(struct channel *));<br>map-&gt;entries[fd] = channel;<br>è¿™ä¸¤è¡Œéƒ½ç»™map-&gt;entries[fd] èµ‹å€¼ï¼Œåä¸€è¡Œä¸æ˜¯è¦†ç›–ä¸Šä¸€è¡Œçš„èµ‹å€¼äº†ä¹ˆï¼Ÿæœ‰ä½•ç”¨æ„ï¼Ÿ","like_count":7,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471449,"discussion_content":"è¿™å—æ˜¯æˆ‘çš„ç–å¿½ï¼Œåº”è¯¥ç›´æ¥èµ‹å€¼çš„ï¼Œå¯èƒ½æ˜¯å¼€å§‹æˆ‘æ’°å†™çš„æ—¶å€™channelå¯¹è±¡çš„åˆå§‹åŒ–æ”¾åˆ°äº†event_loop_handle_pending_addå‡½æ•°ä¸­ï¼Œåæ¥æŠŠchannelå¯¹è±¡çš„åˆå§‹åŒ–é‡æ„åˆ°å¤–é¢ï¼Œè¿™é‡Œå¿˜è®°åˆ æ‰äº†ã€‚\n\nå·²ç»æ›´æ–°æ–‡ç¨¿(å¾…å‘¨ä¸€ç¼–è¾‘æ›´æ–°)å’Œgithubä»£ç ï¼Œæ„Ÿè°¢æŒ‡æ­£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572064101,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143470,"user_name":"å´å°æ™º","can_delete":false,"product_type":"c1","uid":1310798,"ip_address":"","ucode":"C7C9F58B5C9F7B","user_header":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","comment_is_top":false,"comment_ctime":1571714198,"is_pvip":false,"replies":[{"id":"55831","content":"æ˜¾ç„¶æ˜¯çœ‹è¿›å»äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572058676,"ip_address":"","comment_id":143470,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27341517974","product_id":100032701,"comment_content":"map_make_space() å‡½æ•°é‡Œ realloc() å’Œ memset() ä¸¤ä¸ªå‡½æ•°ç”¨çš„å¾ˆå·§å¦™å•Šï¼Œrealloc() ç”¨æ¥æ‰©å®¹ï¼Œä¸”æŠŠæ—§çš„å†…å®¹æ¬è¿‡å»ï¼Œmemset() ç”¨æ¥ç»™æ–°ç”³è¯·çš„å†…å­˜èµ‹ 0 å€¼ã€‚èµï¼ŒC è¯­è¨€å¤ªå¼ºå¤§äº†ã€‚","like_count":7,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471554,"discussion_content":"æ˜¾ç„¶æ˜¯çœ‹è¿›å»äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572058676,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143088,"user_name":"ä¼ è¯´ä¸­çš„æˆå¤§å¤§","can_delete":false,"product_type":"c1","uid":1236766,"ip_address":"","ucode":"103543D6E706BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg","comment_is_top":false,"comment_ctime":1571628389,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14456530277","product_id":100032701,"comment_content":"ç¬¬äºŒé“é¢˜ å°±æ˜¯ä¸€ä¸ªæ‰©å®¹å•Š ç±»ä¼¼stdçš„vectorè‡ªåŠ¨æ‰©å®¹ è€Œä¸”æ¯æ¬¡æˆå€çš„å¢é•¿","like_count":3},{"had_liked":false,"id":157398,"user_name":"é…¸è‘¡è„","can_delete":false,"product_type":"c1","uid":1154146,"ip_address":"","ucode":"9D059C4FB327C0","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/62/f625b2bb.jpg","comment_is_top":false,"comment_ctime":1575132420,"is_pvip":false,"replies":[{"id":"60375","content":"è¿™é‡Œæ˜¯ä½ä¸æ“ä½œï¼Œä¸¾ä¸ªä¾‹å­ï¼ŒEVENT_READå¯èƒ½ä¸ºäºŒè¿›åˆ¶çš„00000010ï¼Œå¦‚æœæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªä½ä¸Šçš„bitå€¼ä¸€å®šä½1ï¼Œè¿™æ ·ä½ä¸çš„ç»“æœå°±è¯´æ˜è¿™ä¸ªäº‹ä»¶å‘ç”Ÿäº†ã€‚ä¹‹æ‰€ä»¥é‡‡ç”¨ä½ä¸ï¼Œè€Œä¸æ˜¯ä½æˆ–ï¼Œæ˜¯å› ä¸ºåªéœ€è¦å…³å¿ƒè¿™ä¸€ç§ç±»å‹çš„äº‹ä»¶ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1575186077,"ip_address":"","comment_id":157398,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10165067012","product_id":100032701,"comment_content":"è€å¸ˆä½ å¥½ï¼Œé—®ä¸ªåŸºç¡€çš„é—®é¢˜ï¼š<br>epoll_dispatcherå’Œpoll_dispatcheréƒ½æœ‰ï¼Œåœ¨æ·»åŠ ï¼Œåˆ é™¤ï¼Œæ›´æ–°äº‹ä»¶æ—¶éƒ½æœ‰å¦‚ä¸‹çš„é€»è¾‘ï¼Œå…¶ä¸­ifæ¡ä»¶ä¸­çš„åˆ¤æ–­æ€ä¹ˆç†è§£å•Šï¼Ÿ<br>if (channel1-&gt;events &amp; EVENT_READ) {<br>        events = events | POLLRDNORM;<br>    }<br><br>    if (channel1-&gt;events &amp; EVENT_WRITE) {<br>        events = events | POLLWRNORM;<br>    }","like_count":2,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476417,"discussion_content":"è¿™é‡Œæ˜¯ä½ä¸æ“ä½œï¼Œä¸¾ä¸ªä¾‹å­ï¼ŒEVENT_READå¯èƒ½ä¸ºäºŒè¿›åˆ¶çš„00000010ï¼Œå¦‚æœæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªä½ä¸Šçš„bitå€¼ä¸€å®šä½1ï¼Œè¿™æ ·ä½ä¸çš„ç»“æœå°±è¯´æ˜è¿™ä¸ªäº‹ä»¶å‘ç”Ÿäº†ã€‚ä¹‹æ‰€ä»¥é‡‡ç”¨ä½ä¸ï¼Œè€Œä¸æ˜¯ä½æˆ–ï¼Œæ˜¯å› ä¸ºåªéœ€è¦å…³å¿ƒè¿™ä¸€ç§ç±»å‹çš„äº‹ä»¶ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575186077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1154146,"avatar":"https://static001.geekbang.org/account/avatar/00/11/9c/62/f625b2bb.jpg","nickname":"é…¸è‘¡è„","note":"","ucode":"9D059C4FB327C0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":73145,"discussion_content":"è°¢è°¢è€å¸ˆ,æˆ‘æƒ³é—®çš„æ˜¯ä¸ºä»€ä¹ˆchannel1->events è¦å’ŒEVENT_READ/EVENT_WRITE  &amp;.   æé—®è¿‡ä¹‹åå°±çœ‹æ˜ç™½äº†äº†,EVENT_READ/EVENT_WRITE æ˜¯å‰é¢æ³¨å†Œè¿‡çš„.  è°¢è°¢è€å¸ˆçš„è§£ç­”äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575553910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":296545,"user_name":"å‡Œç©ºé£èµ·çš„å‰ªåˆ€è…¿","can_delete":false,"product_type":"c1","uid":1243680,"ip_address":"","ucode":"16FBBF4A3B54C6","user_header":"https://static001.geekbang.org/account/avatar/00/12/fa/20/0f06b080.jpg","comment_is_top":false,"comment_ctime":1623036367,"is_pvip":false,"replies":[{"id":"108676","content":"å¾ˆå¥½çš„é—®é¢˜ã€‚<br><br>ç¬¬ä¸€ï¼Œä½ å¯ä»¥çœ‹çœ‹å®é™…åˆ†é…çš„fdï¼Œå¤§æ¦‚ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼›<br>ç¬¬äºŒï¼Œé™¤äº†è¿™ä¸ªæ–¹æ³•ï¼Œä½ æœ‰åˆ«çš„æ›´é«˜æ•ˆçš„æ–¹æ³•å—ï¼Ÿå› ä¸ºä»fdæ¥æŸ¥æ‰¾æ•°æ®ï¼Œéœ€è¦éå¸¸çš„å¿«ï¼›<br><br>æˆ‘ä¸ªäººçš„åˆ¤æ–­ï¼Œè¿™ç‚¹å†…å­˜ä¸ç®—ä»€ä¹ˆï¼Œå› ä¸ºæˆ‘åœ¨è®¾è®¡è¿™ä¸ªç»“æ„æ—¶ï¼Œå¤§éƒ¨åˆ†æ•°æ®éƒ½æ˜¯æŒ‡é’ˆç±»å‹çš„ã€‚<br>","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1624805715,"ip_address":"","comment_id":296545,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5918003663","product_id":100032701,"comment_content":"int map_make_space(struct channel_map *map, int slot, int msize) {<br>    if (map-&gt;nentries &lt;= slot) {<br>        int nentries = map-&gt;nentries ? map-&gt;nentries : 32;<br>        void **tmp;<br><br>        while (nentries &lt;= slot)<br>            nentries &lt;&lt;= 1;<br><br>        tmp = (void **) realloc(map-&gt;entries, nentries * msize);<br>        if (tmp == NULL)<br>            return (-1);<br><br>        memset(&amp;tmp[map-&gt;nentries], 0,<br>               (nentries - map-&gt;nentries) * msize);<br><br>        map-&gt;nentries = nentries;<br>        map-&gt;entries = tmp;<br>    }<br><br>    return (0);<br>}<br>è€å¸ˆï¼Œfdä¸ä¸€å®šæ˜¯è¿ç»­çš„å§ï¼Œè¿™æ ·ä¼šæµªè´¹å†…å­˜å­˜å‚¨ç©ºé—´å§ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":521479,"discussion_content":"å¾ˆå¥½çš„é—®é¢˜ã€‚\n\nç¬¬ä¸€ï¼Œä½ å¯ä»¥çœ‹çœ‹å®é™…åˆ†é…çš„fdï¼Œå¤§æ¦‚ä¼šæ˜¯ä»€ä¹ˆæ ·å­ï¼›\nç¬¬äºŒï¼Œé™¤äº†è¿™ä¸ªæ–¹æ³•ï¼Œä½ æœ‰åˆ«çš„æ›´é«˜æ•ˆçš„æ–¹æ³•å—ï¼Ÿå› ä¸ºä»fdæ¥æŸ¥æ‰¾æ•°æ®ï¼Œéœ€è¦éå¸¸çš„å¿«ï¼›\n\næˆ‘ä¸ªäººçš„åˆ¤æ–­ï¼Œè¿™ç‚¹å†…å­˜ä¸ç®—ä»€ä¹ˆï¼Œå› ä¸ºæˆ‘åœ¨è®¾è®¡è¿™ä¸ªç»“æ„æ—¶ï¼Œå¤§éƒ¨åˆ†æ•°æ®éƒ½æ˜¯æŒ‡é’ˆç±»å‹çš„ã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624805715,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":287971,"user_name":"è°å®¶å†…å­˜æ³„éœ²äº†","can_delete":false,"product_type":"c1","uid":2436042,"ip_address":"","ucode":"CDDA3BE17FE40E","user_header":"https://static001.geekbang.org/account/avatar/00/25/2b/ca/71ff1fd7.jpg","comment_is_top":false,"comment_ctime":1618236226,"is_pvip":false,"replies":[{"id":"104846","content":"æ‰€æœ‰çš„ä½œç”¨èŒƒå›´æ˜¯å…¨å±€çš„ï¼Œè€Œmutexé”çœ‹æƒ…å†µï¼Œæœ‰äº›æ˜¯çº¿ç¨‹çº§åˆ«çš„ï¼Œæ¯”å¦‚è¿™é‡Œï¼š<br>    pthread_mutex_lock(&amp;eventLoopThread-&gt;mutex);","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1618751350,"ip_address":"","comment_id":287971,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5913203522","product_id":100032701,"comment_content":"è€å¸ˆå¥½ï¼Œè¯·é—®æ‚¨çš„ä»£ç ä¸­å…³äºé”çš„ä½¿ç”¨ï¼Œæˆ‘æƒ³çŸ¥é“æ‚¨å…³äºæ¯ä¸ªloopéƒ½è®¾è®¡äº†ä¸€ä¸ªé”ï¼Œå¯æ˜¯è¿™å‡ ä¸ªmutexéƒ½æ˜¯å±€éƒ¨å˜é‡å§ï¼Ÿä»–ä»¬çš„ä½œç”¨èŒƒå›´æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿè¿™é‡Œæƒ³ä¸æ¸…æ¥šï¼Œè¯·æŒ‡ç‚¹ä¸€ä¸‹ï¼","like_count":1,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518477,"discussion_content":"æ‰€æœ‰çš„ä½œç”¨èŒƒå›´æ˜¯å…¨å±€çš„ï¼Œè€Œmutexé”çœ‹æƒ…å†µï¼Œæœ‰äº›æ˜¯çº¿ç¨‹çº§åˆ«çš„ï¼Œæ¯”å¦‚è¿™é‡Œï¼š\n    pthread_mutex_lock(&amp;amp;eventLoopThread-&amp;gt;mutex);","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618751350,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":279197,"user_name":"Steiner","can_delete":false,"product_type":"c1","uid":1622329,"ip_address":"","ucode":"232C1C75207A1E","user_header":"https://static001.geekbang.org/account/avatar/00/18/c1/39/11904266.jpg","comment_is_top":false,"comment_ctime":1613654837,"is_pvip":false,"replies":[{"id":"102001","content":"è¿æ¥ç€clientç«¯çš„å¥—æ¥å­—å’Œserverç«¯çš„å¥—æ¥å­—ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1614516145,"ip_address":"","comment_id":279197,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5908622133","product_id":100032701,"comment_content":"å¦‚æœChannelæ˜¯ä¸€ä¸ªç®¡é“ï¼Œä»–è¿æ¥ç€å“ªä¸¤ä¸ªå¯¹è±¡ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515658,"discussion_content":"è¿æ¥ç€clientç«¯çš„å¥—æ¥å­—å’Œserverç«¯çš„å¥—æ¥å­—ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614516145,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143567,"user_name":"æ²‰æ·€çš„æ¢¦æƒ³","can_delete":false,"product_type":"c1","uid":1177315,"ip_address":"","ucode":"BCB7C26F9D214B","user_header":"https://static001.geekbang.org/account/avatar/00/11/f6/e3/e4bcd69e.jpg","comment_is_top":false,"comment_ctime":1571733875,"is_pvip":false,"replies":[{"id":"55824","content":"å¥½é—®é¢˜ï¼Œæˆ‘è¯•ç€è§£è¯»ä¸€ä¸‹:<br>ç¬¬ä¸€ï¼ŒJavaæœ‰JVMå®ç°ï¼Œåœ¨Javaçš„ä¸–ç•Œé‡Œï¼Œå®ƒçš„å¯¹è±¡æ˜¯ç»Ÿä¸€è¢«JVMç®¡ç†çš„ï¼ŒåŒ…æ‹¬GCï¼Œå¯¹è±¡ç®¡ç†ï¼ŒåŸºäºè¿™ä¸€å±‚è€ƒè™‘ï¼Œå®ƒä¸å¯èƒ½ä½¿ç”¨ç³»ç»Ÿçº§åˆ«çš„å¯¹è±¡å†…å­˜ç®¡ç†ï¼Œè¿™ä¸¤ä¸ªæ²¡æœ‰åŠæ³•è°ƒå’Œï¼Œå°±åƒä½ ä¸¾çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»ä¼¼ReallocListå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡çš„å†…å­˜ç®¡ç†å®Œå…¨ä¸æ˜¯JVMé‚£å¥—äº†ï¼›<br><br>ç¬¬äºŒï¼ŒJVMæ˜¯ä¸€ä¸ªè·¨OSçš„å®ç°ï¼Œæˆ‘ä¸çŸ¥é“æ˜¯å¦Windowsä¹Ÿæœ‰ç±»ä¼¼reallocå‡½æ•°ï¼Œè¿™æ ·å°±éœ€è¦JVMåšåˆ°è·¨OSçš„ç›´æ¥å†…å­˜æ¥ç®¡ï¼Œè¿™å’ŒJavaçš„æ€æƒ³æ˜¯ä¸ä¸€è‡´çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572058320,"ip_address":"","comment_id":143567,"utype":1}],"discussion_count":3,"race_medal":0,"score":"5866701171","product_id":100032701,"comment_content":"çœ‹åˆ°map_make_spaceé‡Œé¢çš„reallocå‡½æ•°ï¼Œçªç„¶æœ‰ä¸ªç–‘é—®ï¼Œæ—¢ç„¶æ“ä½œç³»ç»Ÿåº•å±‚æ”¯æŒç›´æ¥åœ¨åŸæ•°ç»„ä¸Šæ‰©å……å†…å­˜ï¼Œä¸ºä»€ä¹ˆJavaä¸æ”¯æŒç›´æ¥åœ¨åŸæ•°ç»„ä¸Šæ‰©å®¹å‘¢ï¼ŒArrayListæ¯æ¬¡æ‰©å®¹éƒ½è¦é‡æ–°æ‹·è´ä¸€ä»½åŸæ¥çš„æ•°æ®ã€‚","like_count":1,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471596,"discussion_content":"å¥½é—®é¢˜ï¼Œæˆ‘è¯•ç€è§£è¯»ä¸€ä¸‹:\nç¬¬ä¸€ï¼ŒJavaæœ‰JVMå®ç°ï¼Œåœ¨Javaçš„ä¸–ç•Œé‡Œï¼Œå®ƒçš„å¯¹è±¡æ˜¯ç»Ÿä¸€è¢«JVMç®¡ç†çš„ï¼ŒåŒ…æ‹¬GCï¼Œå¯¹è±¡ç®¡ç†ï¼ŒåŸºäºè¿™ä¸€å±‚è€ƒè™‘ï¼Œå®ƒä¸å¯èƒ½ä½¿ç”¨ç³»ç»Ÿçº§åˆ«çš„å¯¹è±¡å†…å­˜ç®¡ç†ï¼Œè¿™ä¸¤ä¸ªæ²¡æœ‰åŠæ³•è°ƒå’Œï¼Œå°±åƒä½ ä¸¾çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»ä¼¼ReallocListå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡çš„å†…å­˜ç®¡ç†å®Œå…¨ä¸æ˜¯JVMé‚£å¥—äº†ï¼›\n\nç¬¬äºŒï¼ŒJVMæ˜¯ä¸€ä¸ªè·¨OSçš„å®ç°ï¼Œæˆ‘ä¸çŸ¥é“æ˜¯å¦Windowsä¹Ÿæœ‰ç±»ä¼¼reallocå‡½æ•°ï¼Œè¿™æ ·å°±éœ€è¦JVMåšåˆ°è·¨OSçš„ç›´æ¥å†…å­˜æ¥ç®¡ï¼Œè¿™å’ŒJavaçš„æ€æƒ³æ˜¯ä¸ä¸€è‡´çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572058320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1258839,"avatar":"https://static001.geekbang.org/account/avatar/00/13/35/57/ab4ba792.jpg","nickname":"å°é±¼","note":"","ucode":"9F3D087A95D0C9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38482,"discussion_content":"æˆ‘è®¤ä¸ºæ•°ç»„æ˜¯è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œä¸€æ—¦ç”³è¯·å¥½äº†å†…å­˜ç©ºé—´ï¼Œé‚£ä¹ˆè¿™ä¸ªç©ºé—´ä¹‹å¤–çš„åœ°å€æ˜¯éšæ—¶å¯ä»¥è¢«åˆ«çš„ç¨‹åºå ç”¨è´¹ï¼Œå¦‚æœä¸é‡æ–°ç”³è¯·ç©ºé—´åˆ™æ•°ç»„å¾ˆå¯èƒ½æ— æ³•æ‰©å®¹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571794264,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1300678,"avatar":"https://static001.geekbang.org/account/avatar/00/13/d8/c6/2b2a58cf.jpg","nickname":"ææ€ªè€…ğŸ˜˜ ğŸ˜’ ğŸ˜ ğŸ‘¿","note":"","ucode":"40DFF5D3E3B24C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":38283,"discussion_content":"å› ä¸ºé¢‘ç¹ç”³è¯·å†…å­˜å¾ˆè€—æ—¶é—´çš„ç¼˜æ•…å§ï¼Œæ¯æ¬¡æ–°å¢æ•°æ®å°±è¦ç”³è¯·å†…å­˜ï¼Œè¿˜ä¸å¦‚ä¸€å£æ°”ç”³è¯·å¤§çš„ï¼Œç„¶åå¤åˆ¶è¿‡å»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571755312,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":358406,"user_name":"åŠŸå¤«ç†ŠçŒ«","can_delete":false,"product_type":"c1","uid":2732243,"ip_address":"æ±Ÿè‹","ucode":"D124F4FA4E816F","user_header":"https://static001.geekbang.org/account/avatar/00/29/b0/d3/200e82ff.jpg","comment_is_top":false,"comment_ctime":1664275482,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1664275482","product_id":100032701,"comment_content":"è€å¸ˆï¼Œå¥—æ¥å­—ä¸æ˜¯ç”¨äºè¿›åŸé€šä¿¡çš„å˜›ï¼Œçº¿ç¨‹ä¹Ÿèƒ½ç”¨ï¼Ÿ","like_count":0},{"had_liked":false,"id":352572,"user_name":"èœé¸¡äº’å•„","can_delete":false,"product_type":"c1","uid":2765079,"ip_address":"","ucode":"59162B81398399","user_header":"https://static001.geekbang.org/account/avatar/00/2a/31/17/ab2c27a6.jpg","comment_is_top":false,"comment_ctime":1658766623,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658766623","product_id":100032701,"comment_content":"å†æ¥çœ‹çœ‹ é‡æ¸©é‡æ¸©ã€‚æ„Ÿè°¢è€å¸ˆ è¿™ä¸ªæ•™ç¨‹ æ˜¯æˆ‘å…¥é—¨ç½‘ç»œç¼–ç¨‹çš„é¢†è·¯äººã€‚æˆ‘æ˜¯åšiOSå¼€å‘çš„ å› ä¸ºä¸€äº›åŸå› è½¬åˆ°ç½‘ç»œè¿™è¾¹ ä¸€å¼€å§‹ä¸€å¤´æ‡µé€¼ å­¦ä¹ äº†è€å¸ˆçš„æ•™ç¨‹å°±æ¸…æ™°äº†å¾ˆå¤šã€‚åé¢æ¥è§¦åˆ°çš„çŸ¥è¯† è€å¸ˆçš„æ•™ç¨‹éƒ½èƒ½å¼•ç”³åˆ° çœŸçš„å¾ˆèµã€‚","like_count":0},{"had_liked":false,"id":346673,"user_name":"æ¼ åšåµ©","can_delete":false,"product_type":"c1","uid":2660316,"ip_address":"","ucode":"33704880E9790F","user_header":"https://static001.geekbang.org/account/avatar/00/28/97/dc/8eacc8f1.jpg","comment_is_top":false,"comment_ctime":1653352875,"is_pvip":true,"replies":[{"id":"126586","content":"è¿˜çœŸä¸æ˜¯ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1618647","ctime":1653808019,"ip_address":"","comment_id":346673,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1653352875","product_id":100032701,"comment_content":"æ„Ÿè§‰å°±æ˜¯ä»¿ç…§nettyæ¡†æ¶åšçš„","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574034,"discussion_content":"è¿˜çœŸä¸æ˜¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653808019,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345093,"user_name":"èœé¸¡","can_delete":false,"product_type":"c1","uid":1683117,"ip_address":"","ucode":"A3102C3ECCA332","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLmWgscKlnjXiaBugNJ2ozMmZibAEKichZv7OfGwQX9voDicVy2qnKtlm5kWQAKZ414vFohR8FV5N9ZhA/132","comment_is_top":false,"comment_ctime":1652018324,"is_pvip":false,"replies":[{"id":"126189","content":"è¿˜å¥½å§ï¼Œchannel_mapä¸­çš„å…ƒç´ æ²¡å‡ ä¸ªå­—èŠ‚ï¼Œæ¯”èµ·å¤æ‚çš„å‹ç¼©ç®—æ³•ï¼Œè¿™ç‚¹å®åœ¨æ˜¯å¾®ä¸è¶³é“ã€‚è€Œä¸”ï¼Œä½ ä¹Ÿæ²¡åŠæ³•é¢„æµ‹åé¢çš„è¿æ¥æƒ…å†µï¼Œå‡†å¤‡å¥½ä¸€ä¸ªä¸Šé™æ¯”è¾ƒå¤§çš„fdå­˜å‚¨ç©ºé—´ï¼Œå…¶å®æ˜¯æ•ˆç‡æ¯”è¾ƒé«˜çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1618647","ctime":1652614214,"ip_address":"","comment_id":345093,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1652018324","product_id":100032701,"comment_content":"ç¬¬äºŒä¸ªé—®é¢˜æœ‰ç‚¹ç–‘é—®ã€‚channel_mapä¸­å…ƒç´ çš„ç©ºé—´å¤§å°æ˜¯ä¸fdçš„å€¼æ­£ç›¸å…³çš„ï¼Œè€Œä¸æ˜¯è·Ÿå½“å‰åœ¨çº¿çš„è¿æ¥æ•°é‡æ­£ç›¸å…³ï¼Œè¿™æ ·åšæ˜¯ä¸æ˜¯æœ‰ç‚¹æµªè´¹å†…å­˜ï¼Ÿæ¯”å¦‚ç»å†äº†å¾ˆå¤šæ¬¡è¿æ¥ã€æ–­å¼€ä¹‹åï¼Œfdè¿”å›çš„å€¼æ¯”è¾ƒå¤§ï¼Œè€Œæ­¤æ—¶åªæœ‰å‡ ä¸ªæœªæ–­å¼€çš„è¿æ¥ï¼Œé‚£ä¹ˆchannel_mapæœ‰å¿…è¦ç”³è¯·é‚£ä¹ˆå¤§çš„å†…å­˜ç©ºé—´å˜›ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572130,"discussion_content":"è¿˜å¥½å§ï¼Œchannel_mapä¸­çš„å…ƒç´ æ²¡å‡ ä¸ªå­—èŠ‚ï¼Œæ¯”èµ·å¤æ‚çš„å‹ç¼©ç®—æ³•ï¼Œè¿™ç‚¹å®åœ¨æ˜¯å¾®ä¸è¶³é“ã€‚è€Œä¸”ï¼Œä½ ä¹Ÿæ²¡åŠæ³•é¢„æµ‹åé¢çš„è¿æ¥æƒ…å†µï¼Œå‡†å¤‡å¥½ä¸€ä¸ªä¸Šé™æ¯”è¾ƒå¤§çš„fdå­˜å‚¨ç©ºé—´ï¼Œå…¶å®æ˜¯æ•ˆç‡æ¯”è¾ƒé«˜çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652614215,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":321134,"user_name":"ç¾¤ä¹¦","can_delete":false,"product_type":"c1","uid":1437036,"ip_address":"","ucode":"BA9EE71D2D818A","user_header":"https://static001.geekbang.org/account/avatar/00/15/ed/6c/6fb35017.jpg","comment_is_top":false,"comment_ctime":1636686388,"is_pvip":true,"replies":[{"id":"116709","content":"ä¸ä¼šã€‚å› ä¸ºå”¤é†’æ˜¯kernelå¹²çš„ï¼Œåªä¸è¿‡æ˜¯å¤šäº†ä¸€è·¯I&#47;Oè€Œå·²ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1636875080,"ip_address":"","comment_id":321134,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1636686388","product_id":100032701,"comment_content":"ç”¨sockå¯¹é€šçŸ¥ å”¤é†’ä¼šä¸ä¼šå¢åŠ é€»è¾‘çº¿ç¨‹æˆ–ä¸»çº¿ç¨‹çš„ç³»ç»Ÿè°ƒç”¨æ¬¡æ•° é™åˆ¶äº†ååé‡å‘¢","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":530226,"discussion_content":"ä¸ä¼šã€‚å› ä¸ºå”¤é†’æ˜¯kernelå¹²çš„ï¼Œåªä¸è¿‡æ˜¯å¤šäº†ä¸€è·¯I/Oè€Œå·²ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636875080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":279144,"user_name":"Steiner","can_delete":false,"product_type":"c1","uid":1622329,"ip_address":"","ucode":"232C1C75207A1E","user_header":"https://static001.geekbang.org/account/avatar/00/18/c1/39/11904266.jpg","comment_is_top":false,"comment_ctime":1613636119,"is_pvip":false,"replies":[{"id":"102008","content":"å› ä¸ºæ˜¯Cçš„ä»£ç ï¼Œé€šç¯‡éƒ½æ˜¯Cè¯­è¨€ï¼Œä¸éœ€è¦å­¦ä¹ C++çŸ¥è¯†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1614516770,"ip_address":"","comment_id":279144,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1613636119","product_id":100032701,"comment_content":"æˆ‘çœ‹äº†ä¸‹å®šä¹‰ï¼Œchannel_elementå°±åƒæ˜¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼Œä¸ºä»€ä¹ˆä¸ç”¨C++æ¥åšè¿™å—å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515636,"discussion_content":"å› ä¸ºæ˜¯Cçš„ä»£ç ï¼Œé€šç¯‡éƒ½æ˜¯Cè¯­è¨€ï¼Œä¸éœ€è¦å­¦ä¹ C++çŸ¥è¯†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614516770,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258927,"user_name":"YUAN","can_delete":false,"product_type":"c1","uid":2153838,"ip_address":"","ucode":"98EF68EEE21893","user_header":"https://static001.geekbang.org/account/avatar/00/20/dd/6e/8f6f79d2.jpg","comment_is_top":false,"comment_ctime":1604583755,"is_pvip":false,"replies":[{"id":"95515","content":"å—¯ï¼Œå·®ä¸å¤šçš„æ„æ€ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1606042291,"ip_address":"","comment_id":258927,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1604583755","product_id":100032701,"comment_content":"è€å¸ˆè¯·é—®è¿™ä¸ªchannelå°±ç›¸å½“äºlibeventä¸­çš„eventç»“æ„ä½“å§ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508790,"discussion_content":"å—¯ï¼Œå·®ä¸å¤šçš„æ„æ€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606042291,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":250380,"user_name":"spark","can_delete":false,"product_type":"c1","uid":1264022,"ip_address":"","ucode":"D84C36D957ECCF","user_header":"https://static001.geekbang.org/account/avatar/00/13/49/96/7523cdb6.jpg","comment_is_top":false,"comment_ctime":1601042194,"is_pvip":false,"replies":[{"id":"92054","content":"æ˜¯çš„å‘€ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹å¯¹åº”è‡ªå·±çš„event_loopå¯¹è±¡ï¼Œè€Œå‘èµ·event_loop_handle_pending_channelæ“ä½œçš„çº¿ç¨‹å¯èƒ½æ˜¯ä¸åŒçš„çº¿ç¨‹ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯çº¿ç¨‹çº§åˆ«çš„lockï¼Œä¹Ÿå°±æ˜¯event_loopé‡Œé¢çš„lockã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1601871155,"ip_address":"","comment_id":250380,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1601042194","product_id":100032701,"comment_content":"ç››è€å¸ˆå¥½: ä¸ºä»€ä¹ˆè¦åœ¨ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸­lockå’Œunlock? ä¸æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½å¯¹åº”ä¸€ä¸ªè‡ªå·±çš„event_loopå—?<br>è¿™æ ·çš„è¯event_loopå°±ä¸æ˜¯shared resourceã€‚<br>int event_loop_handle_pending_channel(struct event_loop *eventLoop) {<br>    &#47;&#47;get the lock<br>    pthread_mutex_lock(&amp;eventLoop-&gt;mutex);<br>    eventLoop-&gt;is_handle_pending = 1;<br><br>    struct channel_element *channelElement = eventLoop-&gt;pending_head;<br>    while (channelElement != NULL) {<br>        &#47;&#47;save into event_map<br>        struct channel *channel = channelElement-&gt;channel;<br>        int fd = channel-&gt;fd;<br>        if (channelElement-&gt;type == 1) {<br>            event_loop_handle_pending_add(eventLoop, fd, channel);<br>        } else if (channelElement-&gt;type == 2) {<br>            event_loop_handle_pending_remove(eventLoop, fd, channel);<br>        } else if (channelElement-&gt;type == 3) {<br>            event_loop_handle_pending_update(eventLoop, fd, channel);<br>        }<br>        channelElement = channelElement-&gt;next;<br>    }<br><br>    eventLoop-&gt;pending_head = eventLoop-&gt;pending_tail = NULL;<br>    eventLoop-&gt;is_handle_pending = 0;<br><br>    &#47;&#47;release the lock<br>    pthread_mutex_unlock(&amp;eventLoop-&gt;mutex);<br><br>    return 0;<br>}","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506196,"discussion_content":"æ˜¯çš„å‘€ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹å¯¹åº”è‡ªå·±çš„event_loopå¯¹è±¡ï¼Œè€Œå‘èµ·event_loop_handle_pending_channelæ“ä½œçš„çº¿ç¨‹å¯èƒ½æ˜¯ä¸åŒçš„çº¿ç¨‹ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯çº¿ç¨‹çº§åˆ«çš„lockï¼Œä¹Ÿå°±æ˜¯event_loopé‡Œé¢çš„lockã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601871155,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2063923,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83er4rbCWDxib3FHibYBouTwZqZBH6h5IgvjibEiaBv4Ceekib9SYg0peBBlFGu8hDuGvwjKp6LNznvEAibYw/132","nickname":"DonaldTrumpppppppppp","note":"","ucode":"211B1A25C53172","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390535,"discussion_content":"å› ä¸ºä¸»reactorçº¿ç¨‹æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥åï¼Œä¼šè°ƒç”¨çº¿ç¨‹æ± ä¸­çš„æŸä¸ªçº¿ç¨‹ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚æŒ‰æˆ‘çš„ç†è§£ï¼Œè¿™ä¸ªé”æ˜¯ä¸ºäº†é˜²æ­¢ä¸»çº¿ç¨‹å’Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å†²çª","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629881256,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236746,"user_name":"è¡¬è¡«çš„ä»·æ ¼æ˜¯19ç¾å…ƒ","can_delete":false,"product_type":"c1","uid":1397631,"ip_address":"","ucode":"655F925451F772","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKVUskibDnhMt5MCIJ8227HWkeg2wEEyewps8GuWhWaY5fy7Ya56bu2ktMlxdla3K29Wqia9efCkWaQ/132","comment_is_top":false,"comment_ctime":1595515842,"is_pvip":false,"replies":[{"id":"87602","content":"æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ä¸è¿‡ï¼Œç¬¬ä¸€ï¼Œè·³å˜ä¸æ˜¯éå¸¸å·¨å¤§ï¼Œè¿™ä¸ªå¯ä»¥ä»å®é™…çš„ç¨‹åºè¿è¡Œå¯ä»¥çœ‹åˆ°fdçš„å¢é•¿ï¼Œä¸€ä¸ªåˆç†çš„è§£é‡Šæ˜¯OSä¹Ÿæ˜¯åœ¨&quot;æ™ºèƒ½&quot;çš„åˆ†é…æ–‡ä»¶æè¿°å­—ï¼›ç¬¬äºŒï¼Œå³ä½¿è·³å˜ï¼Œä¸€ä¸ªchannelåœ°å€ä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚(64bit OS)ï¼Œå ç”¨çš„å†…å­˜ä¹Ÿä¸æ˜¯ç‰¹åˆ«å¤šã€‚<br><br>å¥½å¤„fdåˆ°channelçš„æŸ¥è¯¢ï¼Œæ˜¯éå¸¸éå¸¸å¿«çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1595680251,"ip_address":"","comment_id":236746,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1595515842","product_id":100032701,"comment_content":"channel_mapè¿™é‡Œmap-&gt;entriesæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ä¸‹æ ‡æ˜¯fd,æ•°ç»„çš„å…ƒç´ æ˜¯channelçš„åœ°å€ï¼Œå¦‚æœæ–°å¢çš„fdè·³å˜å¾ˆå¤§çš„è¯æ¯”å¦‚ä»3å˜æˆäº†100ï¼Œä¼šä¸ä¼šæµªè´¹äº†å¾ˆå¤šçš„ç©ºé—´","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502187,"discussion_content":"æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ä¸è¿‡ï¼Œç¬¬ä¸€ï¼Œè·³å˜ä¸æ˜¯éå¸¸å·¨å¤§ï¼Œè¿™ä¸ªå¯ä»¥ä»å®é™…çš„ç¨‹åºè¿è¡Œå¯ä»¥çœ‹åˆ°fdçš„å¢é•¿ï¼Œä¸€ä¸ªåˆç†çš„è§£é‡Šæ˜¯OSä¹Ÿæ˜¯åœ¨&amp;quot;æ™ºèƒ½&amp;quot;çš„åˆ†é…æ–‡ä»¶æè¿°å­—ï¼›ç¬¬äºŒï¼Œå³ä½¿è·³å˜ï¼Œä¸€ä¸ªchannelåœ°å€ä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚(64bit OS)ï¼Œå ç”¨çš„å†…å­˜ä¹Ÿä¸æ˜¯ç‰¹åˆ«å¤šã€‚\n\nå¥½å¤„fdåˆ°channelçš„æŸ¥è¯¢ï¼Œæ˜¯éå¸¸éå¸¸å¿«çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595680251,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2075086,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/a9/ce/23f2e185.jpg","nickname":"Running man","note":"","ucode":"F3357D6696A5C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586222,"discussion_content":"è¿™ä¸ªæœ‰ç‚¹åƒå“ˆå¸ŒæŸ¥æ‰¾æ€æƒ³ï¼Œç”¨ç©ºé—´æ¢æ—¶é—´","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662045787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213959,"user_name":"èƒ¤","can_delete":false,"product_type":"c1","uid":1158091,"ip_address":"","ucode":"0BFD0A021B05A6","user_header":"https://static001.geekbang.org/account/avatar/00/11/ab/cb/55eddaf1.jpg","comment_is_top":false,"comment_ctime":1588600369,"is_pvip":true,"replies":[{"id":"79831","content":"å¥½é—®é¢˜ã€‚<br><br>æŒ‰ç…§é“ç†è¯´ï¼Œè¿”å›å€¼é0è¡¨ç¤ºæœ‰é”™è¯¯ä¿¡æ¯ï¼Œåªæ˜¯è¿™é‡Œæˆ‘æ²¡æœ‰è¿”å›è€Œå·²ã€‚ä¸ªäººä¹ æƒ¯å“ˆï¼Œä½ å¯ä»¥æ”¹æˆæ— è¿”å›å€¼ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1589099214,"ip_address":"","comment_id":213959,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1588600369","product_id":100032701,"comment_content":"é—®ä¸ªcè¯­è¨€çš„é—®é¢˜ï¼Œæ¯”å¦‚event_loop_handle_pending_channelè¿™ä¸ªå‡½æ•°ï¼Œè¿”å›å€¼æ˜¯intç±»å‹ï¼Œä½†æ˜¯é™¤äº†å‡½æ•°æœ€åæ˜¯ä¸ªreturn 0ï¼Œå…¶ä»–åœ°æ–¹æ²¡æœ‰é”™è¯¯å¤„ç†ï¼Œä¸ºä»€ä¹ˆè¦è¿”å›0ï¼Ÿè¿˜æ˜¯å°±æ˜¯ä¸€ç§ä¹ æƒ¯ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493913,"discussion_content":"å¥½é—®é¢˜ã€‚\n\næŒ‰ç…§é“ç†è¯´ï¼Œè¿”å›å€¼é0è¡¨ç¤ºæœ‰é”™è¯¯ä¿¡æ¯ï¼Œåªæ˜¯è¿™é‡Œæˆ‘æ²¡æœ‰è¿”å›è€Œå·²ã€‚ä¸ªäººä¹ æƒ¯å“ˆï¼Œä½ å¯ä»¥æ”¹æˆæ— è¿”å›å€¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589099214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":165105,"user_name":"chs","can_delete":false,"product_type":"c1","uid":1618711,"ip_address":"","ucode":"BE4B6A19317400","user_header":"https://static001.geekbang.org/account/avatar/00/18/b3/17/19ea024f.jpg","comment_is_top":false,"comment_ctime":1577162440,"is_pvip":false,"replies":[{"id":"63891","content":"è¿™ä¸ªæ˜¯é€šè¿‡ä¸‹é¢çš„æ–¹å¼åœ¨å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼š<br><br>extern const struct event_dispatcher poll_dispatcher;<br>extern const struct event_dispatcher epoll_dispatcher;<br>","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1577603766,"ip_address":"","comment_id":165105,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1577162440","product_id":100032701,"comment_content":"è€å¸ˆï¼Œæ‚¨ä¸ºäº†æ”¯æŒpollå’Œepollï¼ŒæŠ½è±¡å‡ºäº†struct event_dispatcherç»“æ„ä½“ï¼Œç„¶ååœ¨epoll_dispatcher.c å’Œpoll_dispatcher.cä¸­åˆ†åˆ«å®ç°struct event_dispatcherä¸­å®šä¹‰çš„æ¥å£ã€‚è¯·é—®epoll_dispatcher.cä¸­çš„ const struct event_dispatcher epoll_dispatcherå˜é‡ å’Œpoll_dispatcher.cä¸­çš„const struct event_dispatcher poll_dispatcherå˜é‡æ€æ ·è®©å…¶ä»–æ–‡ä»¶çŸ¥é“å…¶å®šä¹‰çš„ã€‚æˆ‘è‡ªå·±å†™çš„æç¤ºä¸Šè¾¹ä¸¤ä¸ªå˜é‡æœªå®šä¹‰ã€‚","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":479028,"discussion_content":"è¿™ä¸ªæ˜¯é€šè¿‡ä¸‹é¢çš„æ–¹å¼åœ¨å¤´æ–‡ä»¶ä¸­å£°æ˜ï¼š\n\nextern const struct event_dispatcher poll_dispatcher;\nextern const struct event_dispatcher epoll_dispatcher;\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1577603766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143697,"user_name":"Steiner","can_delete":false,"product_type":"c1","uid":1622329,"ip_address":"","ucode":"232C1C75207A1E","user_header":"https://static001.geekbang.org/account/avatar/00/18/c1/39/11904266.jpg","comment_is_top":false,"comment_ctime":1571757443,"is_pvip":false,"replies":[{"id":"55822","content":"channelé‡Œçš„fdæ˜¯åœ¨æœ‰è¿æ¥å»ºç«‹æ—¶åˆ›å»ºå¥½çš„ï¼Œå½“ç„¶ï¼Œä¹Ÿæ˜¯è¢«è®¾ç½®ä¸ºéé˜»å¡çš„ï¼Œè¿™é‡Œchannleå¯¹è±¡ä¸éœ€è¦å…³ç³»fdçš„å±æ€§ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572058072,"ip_address":"","comment_id":143697,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571757443","product_id":100032701,"comment_content":"è¯·é—®channelé‡Œçš„fdä¹Ÿéœ€è¦è®¾ç½®ä¸ºéé˜»å¡å—","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471656,"discussion_content":"channelé‡Œçš„fdæ˜¯åœ¨æœ‰è¿æ¥å»ºç«‹æ—¶åˆ›å»ºå¥½çš„ï¼Œå½“ç„¶ï¼Œä¹Ÿæ˜¯è¢«è®¾ç½®ä¸ºéé˜»å¡çš„ï¼Œè¿™é‡Œchannleå¯¹è±¡ä¸éœ€è¦å…³ç³»fdçš„å±æ€§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572058072,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143276,"user_name":"ä¼ è¯´ä¸­çš„æˆå¤§å¤§","can_delete":false,"product_type":"c1","uid":1236766,"ip_address":"","ucode":"103543D6E706BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg","comment_is_top":false,"comment_ctime":1571659976,"is_pvip":false,"replies":[{"id":"55883","content":"æ”¾åˆ°ç»Ÿä¸€ç­”ç–‘é‡Œäº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572099118,"ip_address":"","comment_id":143276,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571659976","product_id":100032701,"comment_content":"è€å¸ˆ ä½ å¥½ é—®ä½ ä¸€ä¸ªå’Œè¯¾ç¨‹æ²¾ç‚¹ç‚¹è¾¹çš„å…³ç³»çš„é—®é¢˜å“ˆï¼Œè™½ç„¶æˆ‘æ™“å¾—ä»€ä¹ˆè¿™æ ·æ¨¡å¼é‚£æ ·æ¨¡å¼ ä½†æ˜¯è¿˜æ˜¯ä¸ä¼šè®¾è®¡ æ¯”å¦‚åƒè€å¸ˆä¸ºè¯¾ç¨‹è®¾è®¡çš„æ¡†æ¶ å›è°ƒéƒ½æ˜¯ä¸¤å±‚ ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡æˆ‘å´ä¸æ˜ç™½ æœ‰æ²¡æœ‰ä»€ä¹ˆè§„èŒƒå•¥çš„å¯ä»¥æŒ‡å¯¼ä¸€ä¸‹ å¯èƒ½çœŸçš„æ˜¯æ²¡å¥½å¥½å­¦è¿‡è®¾è®¡æ¨¡å¼,æ—¢ç„¶ç°åœ¨éƒ½æ¶‰åŠåˆ°è¦è‡ªå·±åŠ¨æ‰‹ä¸€ä¸ªæœåŠ¡å™¨æ¡†æ¶äº†  æˆ‘ä¹Ÿæƒ³è§£å†³è®¾è®¡è¿™æ–¹é¢çš„é—®é¢˜ï¼Œå¸Œæœ›è€å¸ˆç‚¹æ’­ä¸€ä¸‹","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471462,"discussion_content":"æ”¾åˆ°ç»Ÿä¸€ç­”ç–‘é‡Œäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572099118,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143270,"user_name":"ä¼ è¯´ä¸­çš„æˆå¤§å¤§","can_delete":false,"product_type":"c1","uid":1236766,"ip_address":"","ucode":"103543D6E706BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg","comment_is_top":false,"comment_ctime":1571659124,"is_pvip":false,"replies":[{"id":"55884","content":"ç»Ÿä¸€ç­”ç–‘ä¸­è§£é‡Šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572099129,"ip_address":"","comment_id":143270,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571659124","product_id":100032701,"comment_content":"è€Œä¸”æ–°è¿æ¥,åˆ›å»ºçš„channelå¯¹è±¡ä¸Šçš„å›è°ƒä¹Ÿåº”è¯¥æ˜¯tcp_connectionä¸Šçš„å›è°ƒ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471460,"discussion_content":"ç»Ÿä¸€ç­”ç–‘ä¸­è§£é‡Šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572099129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143269,"user_name":"ä¼ è¯´ä¸­çš„æˆå¤§å¤§","can_delete":false,"product_type":"c1","uid":1236766,"ip_address":"","ucode":"103543D6E706BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg","comment_is_top":false,"comment_ctime":1571659052,"is_pvip":false,"replies":[{"id":"55885","content":"ç»Ÿä¸€ç­”ç–‘ä¸­è§£é‡Šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572099137,"ip_address":"","comment_id":143269,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571659052","product_id":100032701,"comment_content":"lib&#47;tcp_connection.cæœ€ç»ˆæ˜¯åœ¨lib&#47;tcp_connection.c ç¬¬22è¡Œæ‰§è¡Œäº†åº”ç”¨å±‚çš„readcallbackå‡½æ•°æ‰§è¡Œ epoll-server-multithreads.c onMessageä¸ºä»€ä¹ˆè¦å°è£…ä¸¤æ¬¡å‘¢ï¼Ÿ å°è£…ä¸€ä¸ªtcp_connectionæ˜¯ä¸ºäº†éšè—è¯»å–å­—èŠ‚æµçš„å®ç°å—,ä¸»è¦æ˜¯å¥—æ¥å­—å±‚ï¼Ÿ tcp_serverå±‚ä¸»è¦å°±æ˜¯å¼•ç”¨å±‚çš„è¿™æ ·ç†è§£å¯ä»¥å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471459,"discussion_content":"ç»Ÿä¸€ç­”ç–‘ä¸­è§£é‡Šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572099137,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143268,"user_name":"ä¼ è¯´ä¸­çš„æˆå¤§å¤§","can_delete":false,"product_type":"c1","uid":1236766,"ip_address":"","ucode":"103543D6E706BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg","comment_is_top":false,"comment_ctime":1571658805,"is_pvip":false,"replies":[{"id":"55886","content":"ç»Ÿä¸€ç­”ç–‘ä¸­è§£é‡Šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572099143,"ip_address":"","comment_id":143268,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571658805","product_id":100032701,"comment_content":"ä»Šå¤©ä»”ç»†ç ”è¯»äº†è€å¸ˆçš„ä»£ç çªç„¶å‘ç°æœ‰ä¸¤å±‚å›è°ƒ<br>1. epoll-server-multithreads.cé‡Œé¢å†™çš„æœ‰å›è°ƒ å¹¶ä¸”èµ‹ç»™äº†tcp_server<br>2. tcp_connection.c å®ç°äº† handle_read handle_write ç­‰ç­‰äº‹ä»¶çš„å›è°ƒ ä¸ºä»€ä¹ˆè¦å°è£…ä¸¤å±‚å›è°ƒå‘¢ æˆ‘è®¾è®¡æ¨¡å¼æ²¡æ€ä¹ˆå­¦è¿‡ å¸Œæœ›è€å¸ˆæŒ‡ç‚¹å“ˆ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471458,"discussion_content":"ç»Ÿä¸€ç­”ç–‘ä¸­è§£é‡Šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572099143,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143206,"user_name":"ä¼ è¯´ä¸­çš„æˆå¤§å¤§","can_delete":false,"product_type":"c1","uid":1236766,"ip_address":"","ucode":"103543D6E706BF","user_header":"https://static001.geekbang.org/account/avatar/00/12/df/1e/cea897e8.jpg","comment_is_top":false,"comment_ctime":1571648499,"is_pvip":false,"replies":[{"id":"55844","content":"ç¬”è¯¯ï¼Œå·²ä¿®å¤ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1572065110,"ip_address":"","comment_id":143206,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571648499","product_id":100032701,"comment_content":"epollDispatcherData-&gt;events = calloc(MAXEVENTS, sizeof(struct acceptor));<br>è¿™ä¸€è¡Œä¸å¤ªæ˜ç™½ä¸ºä»€ä¹ˆè¦åˆ†é…MAXEVENTS* sizeof( struct acceptor )è¿™ä¹ˆå¤šå†…å­˜ï¼Ÿæˆ‘çš„å…³æ³¨ç‚¹åœ¨sizeof( <br>struct acceptor ),ä¸ºä»€ä¹ˆå–å®ƒçš„å¤§å°ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471420,"discussion_content":"ç¬”è¯¯ï¼Œå·²ä¿®å¤ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572065110,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143156,"user_name":"é±¼å‘åŒ—æ¸¸","can_delete":false,"product_type":"c1","uid":1439908,"ip_address":"","ucode":"580EC7DCE57E9A","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/IPdZZXuHVMibwfZWmm7NiawzeEFGsaRoWjhuN99iaoj5amcRkiaOePo6rH1KJ3jictmNlic4OibkF4I20vOGfwDqcBxfA/132","comment_is_top":false,"comment_ctime":1571640511,"is_pvip":false,"replies":[{"id":"55599","content":"æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„èƒ½åŠ›å°±æ˜¯è¿™æ ·ï¼Œå¤§å®¶éƒ½è¿™ä¹ˆå‘æŒ¥äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"froghui","uid":"1618647","ctime":1571846399,"ip_address":"","comment_id":143156,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1571640511","product_id":100032701,"comment_content":"è€å¸ˆçš„ç¨‹åºè¯»äº†ä¸€éï¼Œcç‰ˆçš„nettyï¼Œæœç„¶é«˜æ‰‹ä»¬çš„æ€è·¯éƒ½æ˜¯ç›¸é€šçš„","like_count":0,"discussions":[{"author":{"id":1618647,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b2/d7/df4086cf.jpg","nickname":"froghui","note":"","ucode":"843028B4E07F41","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471401,"discussion_content":"æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„èƒ½åŠ›å°±æ˜¯è¿™æ ·ï¼Œå¤§å®¶éƒ½è¿™ä¹ˆå‘æŒ¥äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571846399,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":143013,"user_name":"åˆ˜ç³»","can_delete":false,"product_type":"c1","uid":1009725,"ip_address":"","ucode":"A772E5BCAE640E","user_header":"","comment_is_top":false,"comment_ctime":1571620054,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1571620054","product_id":100032701,"comment_content":"ç¬¬äºŒè¯¾åé¢˜ï¼šå½“æè¿°å­—å¤§äºchannel_mapçš„å®¹é‡æ—¶ï¼Œmap_make_spaceä¼šè¢«è°ƒç”¨ã€‚åœ¨mapåˆå§‹åŒ–æ—¶ï¼Œå®¹é‡ä¸º0ï¼Œå¾€mapé‡Œå†™æè¿°å­—æ—¶å…ˆç»™å®¹é‡ä¸º32ï¼Œå¦‚æœæè¿°å­—ä»ç„¶å¤§äºç­‰äº32å°†ä¼šä½¿å®¹é‡å³ç§»ä¸€ä½ï¼Œä¹Ÿå°±æ˜¯æè¿°å­—å®¹é‡å¢åŠ ä¸¤å€å†ä¸è¦å†™å…¥çš„æè¿°å­—è¿›è¡Œæ¯”è¾ƒï¼Œç›´è‡³å®¹é‡å¤§äºè¦å†™å…¥çš„æè¿°å­—ã€‚ç„¶åä½¿ç”¨reallocè¿›è¡Œç©ºé—´å¼€è¾Ÿï¼Œä¿ç•™åŸæœ‰ç©ºé—´ï¼Œæ‰©å±•æ–°ç©ºé—´ã€‚å°†æ–°ç©ºé—´å†…å­˜ç½®0ã€‚æœ€åæ›´æ–°map","like_count":0,"discussions":[{"author":{"id":2075086,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/a9/ce/23f2e185.jpg","nickname":"Running man","note":"","ucode":"F3357D6696A5C1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":586223,"discussion_content":"åªå¢ä¸å‡ï¼Œå†…å­˜ä¼šè¶Šæ¥è¶Šå¤šè¢«å ç”¨","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1662046057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1009725,"avatar":"","nickname":"åˆ˜ç³»","note":"","ucode":"A772E5BCAE640E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":37474,"discussion_content":"åº”è¯¥æ˜¯å¢åŠ ä¸€å€ï¼Œä¹Ÿå°±æ˜¯ä¹˜ä»¥2ã€‚æè¿°ä¸å‡†ç¡®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571622151,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}