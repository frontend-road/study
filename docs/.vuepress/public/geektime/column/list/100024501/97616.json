{"id":97616,"title":"34 | iOS é»‘é­”æ³• Runtime Method Swizzling èƒŒåçš„åŸç†","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æˆ´é“­ã€‚</p><p>æåˆ°Object-Cä¸­çš„Runtimeï¼Œä½ å¯èƒ½ä¸€ä¸‹å°±æƒ³åˆ°äº†iOSçš„é»‘é­”æ³•Method Swizzlingã€‚æ¯•ç«Ÿï¼Œè¿™ä¸ªé»‘é­”æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨è¿è¡Œæ—¶è¿›è¡Œæ–¹æ³•äº¤æ¢ï¼Œæˆ–è€…åœ¨åŸæ–¹æ³•æ‰§è¡Œä¹‹å‰æ’å…¥è‡ªå®šä¹‰æ–¹æ³•ï¼Œä»¥ä¿è¯åœ¨ä¸šåŠ¡é¢å‘å¯¹è±¡ç¼–ç¨‹æ–¹å¼ä¸è¢«æ”¹å˜çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œåˆ‡é¢åŠŸèƒ½çš„å¼€å‘ã€‚ä½†æ˜¯ï¼Œè¿è¡Œæ—¶è¿›è¡Œæ–¹æ³•äº¤æ¢åŒæ—¶ä¹Ÿä¼šå¸¦æ¥ä¸€å®šçš„é£é™©ã€‚æ‰€ä»¥ï¼Œä»Šå¤©æˆ‘å°±æ¥å’Œä½ è¯¦ç»†èŠèŠRuntime Method Swizzling çš„åŸç†ã€‚</p><p>Runtime Method Swizzling ç¼–ç¨‹æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å«ä½œAOPï¼ˆAspect-Oriented Programmingï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ã€‚</p><p>AOP æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œä½¿ç”¨ AOP å¯ä»¥è§£å†³ OOPï¼ˆObject Oriented Programmingï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰ç”±äºåˆ‡é¢éœ€æ±‚å¯¼è‡´å•ä¸€èŒè´£è¢«ç ´åçš„é—®é¢˜ã€‚é€šè¿‡ AOP å¯ä»¥ä¸ä¾µå…¥ OOP å¼€å‘ï¼Œéå¸¸æ–¹ä¾¿åœ°æ’å…¥åˆ‡é¢éœ€æ±‚åŠŸèƒ½ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘åœ¨ä¸“æ <a href=\"https://time.geekbang.org/column/article/87925\">ç¬¬9ç¯‡æ–‡ç« </a>ä¸­ä»‹ç»æ— ä¾µå…¥åŸ‹ç‚¹æ–¹æ¡ˆæ—¶ï¼Œå°±æåˆ°äº†é€šè¿‡ AOP åœ¨ä¸ä¾µå…¥åŸæœ‰åŠŸèƒ½ä»£ç çš„æƒ…å†µä¸‹æ’å…¥æ”¶é›†åŸ‹ç‚¹çš„åŠŸèƒ½ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä¸»ä¸šåŠ¡æ— å…³çš„é€»è¾‘åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ AOP æ¥å®Œæˆï¼Œè¿™æ ·ä¸»ä¸šåŠ¡é€»è¾‘å°±èƒ½å¤Ÿæ»¡è¶³ OOP å•ä¸€èŒè´£çš„è¦æ±‚ã€‚è€Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ AOPï¼Œé‰´äºOOPçš„å±€é™æ€§ï¼Œè¿™äº›ä¸ä¸»ä¸šåŠ¡æ— å…³çš„ä»£ç å°±ä¼šåˆ°å¤„éƒ½æ˜¯ï¼Œå¢å¤§äº†å·¥ä½œé‡ä¸è¯´ï¼Œè¿˜ä¼šåŠ å¤§ç»´æŠ¤æˆæœ¬ã€‚</p><!-- [[[read_end]]] --><p>ä½†æ˜¯æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼ŒiOS åœ¨è¿è¡Œæ—¶è¿›è¡Œ AOP å¼€å‘ä¼šæœ‰é£é™©ï¼Œä¸èƒ½ç®€å•åœ°ä½¿ç”¨ Runtime è¿›è¡Œæ–¹æ³•äº¤æ¢æ¥å®ç° AOP å¼€å‘ã€‚å› æ­¤ï¼Œæˆ‘ä»Šå¤©å°±æ¥è·Ÿä½ è¯´ä¸‹ç›´æ¥ä½¿ç”¨ Runtime æ–¹æ³•äº¤æ¢å¼€å‘çš„é£é™©æœ‰å“ªäº›ï¼Œè€Œå®‰å…¨çš„æ–¹æ³•äº¤æ¢åŸç†åˆæ˜¯æ€æ ·çš„ï¼Ÿ</p><h2>ç›´æ¥ä½¿ç”¨ Runtime æ–¹æ³•äº¤æ¢å¼€å‘çš„é£é™©æœ‰å“ªäº›ï¼Ÿ</h2><p>Objective-C æ˜¯é—¨åŠ¨æ€è¯­è¨€ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åšä»»ä½•å®ƒèƒ½åšçš„äº‹æƒ…ã€‚è¿™å…¶ä¸­çš„åŠŸåŠ³ç¦»ä¸å¼€ Runtime è¿™ä¸ªåº“ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒRuntime æˆä¸ºäº† iOS å¼€å‘ä¸­ Objective-C å’Œ C çš„åˆ†æ°´å²­ã€‚</p><p>Runtime ä¸å…‰èƒ½å¤Ÿè¿›è¡Œæ–¹æ³•äº¤æ¢ï¼Œè¿˜èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶å¤„ç† Objective-C ç‰¹æ€§ç›¸å…³ï¼ˆæ¯”å¦‚ç±»ã€æˆå‘˜å‡½æ•°ã€ç»§æ‰¿ï¼‰çš„å¢åˆ æ”¹æ“ä½œã€‚</p><p>è‹¹æœå…¬å¸å·²ç»å¼€æºäº†Runtimeï¼Œåœ¨ GitHub ä¸Šæœ‰<a href=\"https://github.com/0xxd0/objc4\">å¯ç¼–è¯‘çš„ Runtime å¼€æºç‰ˆæœ¬</a>ã€‚ä½ å¯ä»¥é€šè¿‡äºå¾·å¿— (@halfrost)åšå®¢çš„ä¸‰ç¯‡ Runtime æ–‡ç« ï¼Œå³<a href=\"https://halfrost.com/objc_runtime_isa_class/\">isaå’ŒClass</a>ã€<a href=\"https://halfrost.com/objc_runtime_objc_msgsend/\">æ¶ˆæ¯å‘é€ä¸è½¬å‘</a>ï¼Œä»¥åŠ<a href=\"https://halfrost.com/how_to_use_runtime/\">å¦‚ä½•æ­£ç¡®ä½¿ç”¨Runtime</a>ï¼Œæ¥ä¸€è¾¹å­¦ä¹ ä¸€è¾¹è°ƒè¯•ã€‚</p><p>ç›´æ¥ä½¿ç”¨ Runtime è¿›è¡Œæ–¹æ³•äº¤æ¢éå¸¸ç®€å•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code>#import &quot;SMHook.h&quot;\n#import &lt;objc/runtime.h&gt;\n\n@implementation SMHook\n\n+ (void)hookClass:(Class)classObject fromSelector:(SEL)fromSelector toSelector:(SEL)toSelector {\n    Class class = classObject;\n    // å¾—åˆ°è¢«äº¤æ¢ç±»çš„å®ä¾‹æ–¹æ³•\n    Method fromMethod = class_getInstanceMethod(class, fromSelector);\n    // å¾—åˆ°äº¤æ¢ç±»çš„å®ä¾‹æ–¹æ³•\n    Method toMethod = class_getInstanceMethod(class, toSelector);\n    \n    // class_addMethod() å‡½æ•°è¿”å›æˆåŠŸè¡¨ç¤ºè¢«äº¤æ¢çš„æ–¹æ³•æ²¡å®ç°ï¼Œç„¶åä¼šé€šè¿‡ class_addMethod() å‡½æ•°å…ˆå®ç°ï¼›è¿”å›å¤±è´¥åˆ™è¡¨ç¤ºè¢«äº¤æ¢æ–¹æ³•å·²å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œ IMP æŒ‡é’ˆäº¤æ¢ \n    if(class_addMethod(class, fromSelector, method_getImplementation(toMethod), method_getTypeEncoding(toMethod))) {\n        // è¿›è¡Œæ–¹æ³•çš„äº¤æ¢\n        class_replaceMethod(class, toSelector, method_getImplementation(fromMethod), method_getTypeEncoding(fromMethod));\n    } else {\n        // äº¤æ¢ IMP æŒ‡é’ˆ\n        method_exchangeImplementations(fromMethod, toMethod);\n    }\n}\n@end\n</code></pre><p>å¦‚ä»£ç æ‰€ç¤ºï¼šé€šè¿‡ class_getInstanceMethod() å‡½æ•°å¯ä»¥å¾—åˆ°è¢«äº¤æ¢ç±»çš„å®ä¾‹æ–¹æ³•å’Œäº¤æ¢ç±»çš„å®ä¾‹æ–¹æ³•ã€‚ä½¿ç”¨ class_addMethod() å‡½æ•°æ¥æ·»åŠ æ–¹æ³•ï¼Œè¿”å›æˆåŠŸè¡¨ç¤ºè¢«äº¤æ¢çš„æ–¹æ³•æ²¡è¢«å®ç°ï¼Œç„¶åé€šè¿‡ class_addMethod() å‡½æ•°å®ç°ï¼›è¿”å›å¤±è´¥åˆ™è¡¨ç¤ºè¢«äº¤æ¢æ–¹æ³•å·²å­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡ method_exchangeImplementations() å‡½æ•°ç›´æ¥è¿›è¡Œ IMP æŒ‡é’ˆäº¤æ¢ä»¥å®ç°æ–¹æ³•äº¤æ¢ã€‚</p><p>ä½†æ˜¯ï¼Œåƒä¸Šé¢è¿™æ®µä»£ç ä¸€æ ·ï¼Œç›´æ¥ä½¿ç”¨ Runtime çš„æ–¹æ³•è¿›è¡Œæ–¹æ³•äº¤æ¢ä¼šæœ‰å¾ˆå¤šé£é™©ï¼Œ<a href=\"https://github.com/rabovik/RSSwizzle/\">RSSwizzle</a>åº“é‡ŒæŒ‡å‡ºäº†<strong>å››ä¸ªå…¸å‹çš„ç›´æ¥ä½¿ç”¨ Runtime æ–¹æ³•è¿›è¡Œæ–¹æ³•äº¤æ¢çš„é£é™©</strong>ã€‚æˆ‘ç¨ä½œæ•´ç†ï¼Œä»¥æ–¹ä¾¿ä½ æŸ¥çœ‹ï¼Œå¹¶ä¾¿äºä½ ç†è§£åç»­çš„å†…å®¹ã€‚</p><p>ç¬¬ä¸€ä¸ªé£é™©æ˜¯ï¼Œéœ€è¦åœ¨ +load æ–¹æ³•ä¸­è¿›è¡Œæ–¹æ³•äº¤æ¢ã€‚å› ä¸ºå¦‚æœåœ¨å…¶ä»–æ—¶å€™è¿›è¡Œæ–¹æ³•äº¤æ¢ï¼Œéš¾ä»¥ä¿è¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­ä¸ä¼šåŒæ—¶è°ƒç”¨è¢«äº¤æ¢çš„æ–¹æ³•ï¼Œä»è€Œå¯¼è‡´ç¨‹åºä¸èƒ½æŒ‰é¢„æœŸæ‰§è¡Œã€‚</p><p>ç¬¬äºŒä¸ªé£é™©æ˜¯ï¼Œè¢«äº¤æ¢çš„æ–¹æ³•å¿…é¡»æ˜¯å½“å‰ç±»çš„æ–¹æ³•ï¼Œä¸èƒ½æ˜¯çˆ¶ç±»çš„æ–¹æ³•ï¼Œç›´æ¥æŠŠçˆ¶ç±»çš„å®ç°æ‹·è´è¿‡æ¥ä¸ä¼šèµ·ä½œç”¨ã€‚çˆ¶ç±»çš„æ–¹æ³•å¿…é¡»åœ¨è°ƒç”¨çš„æ—¶å€™ä½¿ç”¨ï¼Œè€Œä¸æ˜¯æ–¹æ³•äº¤æ¢æ—¶ä½¿ç”¨ã€‚</p><p>ç¬¬ä¸‰ä¸ªé£é™©æ˜¯ï¼Œäº¤æ¢çš„æ–¹æ³•å¦‚æœä¾èµ–äº† cmdï¼Œé‚£ä¹ˆäº¤æ¢åï¼Œå¦‚æœ cmd å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šå‡ºç°å„ç§å¥‡æ€ªé—®é¢˜ï¼Œè€Œä¸”è¿™äº›é—®é¢˜è¿˜å¾ˆéš¾æ’æŸ¥ã€‚ç‰¹åˆ«æ˜¯äº¤æ¢äº†ç³»ç»Ÿæ–¹æ³•ï¼Œä½ æ— æ³•ä¿è¯ç³»ç»Ÿæ–¹æ³•å†…éƒ¨æ˜¯å¦ä¾èµ–äº† cmdã€‚</p><p>ç¬¬å››ä¸ªé£é™©æ˜¯ï¼Œæ–¹æ³•äº¤æ¢å‘½åå†²çªã€‚å¦‚æœå‡ºç°å†²çªï¼Œå¯èƒ½ä¼šå¯¼è‡´æ–¹æ³•äº¤æ¢å¤±è´¥ã€‚</p><p>æ›´å¤šå…³äºè¿è¡Œæ—¶æ–¹æ³•äº¤æ¢çš„é£é™©ï¼Œä½ å¯ä»¥æŸ¥çœ‹ Stackoverflow ä¸Šçš„é—®é¢˜è®¨è®ºâ€œ<a href=\"https://stackoverflow.com/questions/5339276/what-are-the-dangers-of-method-swizzling-in-objective-c\">What are the Dangers of Method Swizzling in Objective C?</a>â€ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œç›´æ¥ä½¿ç”¨ Runtime è¿›è¡Œæ–¹æ³•äº¤æ¢çš„é£é™©éå¸¸å¤§ï¼Œé‚£ä¹ˆå®‰å…¨çš„æ–¹æ³•äº¤æ¢æ˜¯æ€æ ·çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥è·Ÿä½ ä»‹ç»ä¸€ä¸ªæ›´å®‰å…¨çš„è¿è¡Œæ—¶æ–¹æ³•äº¤æ¢åº“ <a href=\"https://github.com/steipete/Aspects\">Aspects</a>ã€‚</p><h2>æ›´å®‰å…¨çš„æ–¹æ³•äº¤æ¢åº“Aspects</h2><p>Aspects æ˜¯ä¸€ä¸ªé€šè¿‡ Runtime æ¶ˆæ¯è½¬å‘æœºåˆ¶æ¥å®ç°æ–¹æ³•äº¤æ¢çš„åº“ã€‚å®ƒå°†æ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨éƒ½æŒ‡åˆ° _objc_msgForward å‡½æ•°è°ƒç”¨ä¸Šï¼ŒæŒ‰ç…§è‡ªå·±çš„æ–¹å¼å®ç°äº†æ¶ˆæ¯è½¬å‘ï¼Œè‡ªå·±å¤„ç†å‚æ•°åˆ—è¡¨ï¼Œå¤„ç†è¿”å›å€¼ï¼Œæœ€åé€šè¿‡ NSInvocation è°ƒç”¨æ¥å®ç°æ–¹æ³•äº¤æ¢ã€‚åŒæ—¶ï¼ŒAspects è¿˜è€ƒè™‘äº†ä¸€äº›æ–¹æ³•äº¤æ¢å¯èƒ½ä¼šå¼•å‘çš„é£é™©ï¼Œå¹¶è¿›è¡Œäº†å¤„ç†ã€‚</p><p>é€šè¿‡å­¦ä¹ Aspects çš„æºç ï¼Œä½ èƒ½å¤Ÿä»ä¸­å­¦ä¹ åˆ°å¦‚ä½•å¤„ç†è¿™äº›é£é™©ã€‚ æ¯”å¦‚ï¼Œçƒ­ä¿®å¤æ¡†æ¶ <a href=\"https://github.com/bang590/JSPatch\">JSPatch</a>å°±æ˜¯å­¦ä¹ äº† Aspects çš„å®ç°æ–¹å¼ã€‚å› æ­¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šå±•å¼€Aspectsçš„æºç ï¼Œå¸¦ä½ ä¸€èµ·çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚è¿™æ ·ï¼Œä½ å†é‡åˆ°ç±»ä¼¼é—®é¢˜æ—¶ï¼Œæˆ–å€Ÿé‰´å…¶ä¸­çš„è§£å†³æ€è·¯ï¼Œæˆ–ç»è¿‡å®è·µã€æ€è€ƒåå½¢æˆè‡ªå·±çš„æ›´ä¼˜é›…çš„è§£å†³æ–¹æ³•ã€‚</p><p>è™½ç„¶ Aspects å¯¹äºä¸€äº›é£é™©è¿›è¡Œäº†è§„é¿ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ä¸å½“çš„æƒ…å†µä¸‹ä¾ç„¶ä¼šæœ‰é£é™©ï¼Œæ¯”å¦‚ hook å·²ç»è¢« hook è¿‡çš„æ–¹æ³•ï¼Œé‚£ä¹ˆä¹‹å‰çš„ hook ä¼šå¤±æ•ˆï¼Œè€Œä¸”æ–°çš„ hook ä¹Ÿä¼šå‡ºé”™ã€‚æ‰€ä»¥ï¼Œå³ä½¿æ˜¯ Aspectsï¼Œ åœ¨å·¥ç¨‹ä¸­ä¹Ÿä¸èƒ½æ»¥ç”¨ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·çœ‹ä¸€æ®µ<strong>å¦‚ä½•ä½¿ç”¨ Aspects çš„ç¤ºä¾‹ä»£ç </strong>ï¼š</p><pre><code>[UIViewController aspect_hookSelector:@selector(viewWillAppear:) withOptions:AspectPositionAfter usingBlock:^(id&lt;AspectInfo&gt; aspectInfo, BOOL animated) {\n    NSLog(@&quot;View Controller %@ will appear animated: %tu&quot;, aspectInfo.instance, animated);\n} error:NULL];\n</code></pre><p>ä¸Šé¢è¿™æ®µä»£ç æ˜¯ Aspects é€šè¿‡è¿è¡Œæ—¶æ–¹æ³•äº¤æ¢ï¼ŒæŒ‰ç…§ AOP æ–¹å¼æ·»åŠ åŸ‹ç‚¹çš„å®ç°ã€‚ä»£ç ç®€å•ï¼Œå¯è¯»æ€§é«˜ï¼Œæ¥å£ä½¿ç”¨ Block ä¹Ÿéå¸¸æ˜“ç”¨ã€‚æŒ‰ç…§è¿™ç§æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨Aspectså³å¯ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±è·Ÿä½ è¯´ä¸‹ <strong>Aspect å®ç°æ–¹æ³•äº¤æ¢çš„åŸç†</strong>ã€‚</p><p>Aspects çš„æ•´ä½“æµç¨‹æ˜¯ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦å¯è¿›è¡Œæ–¹æ³•äº¤æ¢ã€‚è¿™ä¸€æ­¥ä¼šè¿›è¡Œå®‰å…¨é—®é¢˜çš„åˆ¤æ–­å¤„ç†ã€‚å¦‚æœæ²¡æœ‰é£é™©çš„è¯ï¼Œå†é’ˆå¯¹è¦äº¤æ¢çš„æ˜¯ç±»å¯¹è±¡è¿˜æ˜¯å®ä¾‹å¯¹è±¡åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚</p><ul>\n<li>å¯¹äºç±»å¯¹è±¡çš„æ–¹æ³•äº¤æ¢ï¼Œä¼šå…ˆä¿®æ”¹ç±»çš„ forwardInvocation ï¼Œå°†ç±»çš„å®ç°è½¬æˆè‡ªå·±çš„ã€‚ç„¶åï¼Œé‡æ–°ç”Ÿæˆä¸€ä¸ªæ–¹æ³•ç”¨æ¥äº¤æ¢ã€‚æœ€åï¼Œäº¤æ¢æ–¹æ³•çš„ IMPï¼Œæ–¹æ³•è°ƒç”¨æ—¶å°±ä¼šç›´æ¥å¯¹äº¤æ¢æ–¹æ³•è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚</li>\n<li>å¯¹äºå®ä¾‹å¯¹è±¡çš„æ–¹æ³•äº¤æ¢ï¼Œä¼šå…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»ï¼Œå¹¶å°†å½“å‰å®ä¾‹å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘æ–°åˆ›å»ºçš„ç±»ï¼Œç„¶åå†ä¿®æ”¹ç±»çš„æ–¹æ³•ã€‚</li>\n</ul><p>æ•´ä¸ªæµç¨‹çš„å…¥å£æ˜¯ aspect_add() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡ŒåŒ…å«äº† Aspects çš„ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿›è¡Œå®‰å…¨åˆ¤æ–­çš„ aspect_isSelectorAllowedAndTrack æ–¹æ³•ï¼Œç¬¬äºŒä¸ªæ˜¯æ‰§è¡Œç±»å¯¹è±¡å’Œå®ä¾‹å¯¹è±¡æ–¹æ³•äº¤æ¢çš„ aspect_prepareClassAndHookSelector æ–¹æ³•ã€‚</p><p>aspect_isSelectorAllowedAndTrack æ–¹æ³•ï¼Œä¼šå¯¹ä¸€äº›æ–¹æ³•æ¯”å¦‚ retainã€releaseã€autoreleaseã€forwardInvocation è¿›è¡Œè¿‡æ»¤ï¼Œå¹¶å¯¹ dealloc æ–¹æ³•äº¤æ¢åšäº†é™åˆ¶ï¼Œè¦æ±‚åªèƒ½ä½¿ç”¨ AspectPositionBefore é€‰é¡¹ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šè¿‡æ»¤æ²¡æœ‰å“åº”çš„æ–¹æ³•ï¼Œç›´æ¥è¿”å› NOã€‚</p><p>å®‰å…¨åˆ¤æ–­æ‰§è¡Œå®Œï¼Œå°±å¼€å§‹æ‰§è¡Œæ–¹æ³•äº¤æ¢çš„ aspect_prepareClassAndHookSelector æ–¹æ³•ï¼Œå…¶å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>static void aspect_prepareClassAndHookSelector(NSObject *self, SEL selector, NSError **error) {\n    NSCParameterAssert(selector);\n    Class klass = aspect_hookClass(self, error);\n    Method targetMethod = class_getInstanceMethod(klass, selector);\n    IMP targetMethodIMP = method_getImplementation(targetMethod);\n    if (!aspect_isMsgForwardIMP(targetMethodIMP)) {\n        // åˆ›å»ºæ–¹æ³•åˆ«å\n        const char *typeEncoding = method_getTypeEncoding(targetMethod);\n        SEL aliasSelector = aspect_aliasForSelector(selector);\n        if (![klass instancesRespondToSelector:aliasSelector]) {\n            __unused BOOL addedAlias = class_addMethod(klass, aliasSelector, method_getImplementation(targetMethod), typeEncoding);\n            NSCAssert(addedAlias, @&quot;Original implementation for %@ is already copied to %@ on %@&quot;, NSStringFromSelector(selector), NSStringFromSelector(aliasSelector), klass);\n        }\n\n        // ä½¿ç”¨ forwardInvocation è¿›è¡Œæ–¹æ³•äº¤æ¢.\n        class_replaceMethod(klass, selector, aspect_getMsgForwardIMP(self, selector), typeEncoding);\n        AspectLog(@&quot;Aspects: Installed hook for -[%@ %@].&quot;, klass, NSStringFromSelector(selector));\n    }\n}\n\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ aspect_hookClass()å‡½æ•°å¯ä»¥åˆ¤æ–­å‡º class çš„ selector æ˜¯å®ä¾‹æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•ï¼Œå¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼Œä¼šé€šè¿‡ class_addMethod æ–¹æ³•ç”Ÿæˆä¸€ä¸ªäº¤æ¢æ–¹æ³•ï¼Œè¿™æ ·åœ¨ forwordInvocation æ—¶å°±èƒ½å¤Ÿç›´æ¥æ‰§è¡Œäº¤æ¢æ–¹æ³•ã€‚aspect_hookClass è¿˜ä¼šå¯¹ç±»å¯¹è±¡ã€å…ƒç±»ã€KVO å­ç±»åŒ–çš„å®ä¾‹å¯¹è±¡ã€class å’Œ isa æŒ‡å‘ä¸åŒçš„æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨ aspect_swizzleClassInPlace æ··å†™ baseClassã€‚</p><h2>å°ç»“</h2><p>åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å’Œä½ æ¢³ç†äº†ç›´æ¥ä½¿ç”¨ Runtimeè¿›è¡Œæ–¹æ³•äº¤æ¢ä¼šæœ‰å“ªäº›é—®é¢˜ï¼Œè¿›è€Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘åˆå’Œä½ åˆ†äº«äº†ä¸€ä¸ªæ›´å®‰å…¨çš„æ–¹æ³•äº¤æ¢åº“ Aspectsã€‚</p><p>åœ¨æ–‡ç« æœ€åï¼Œæˆ‘æƒ³å’Œä½ è¯´çš„æ˜¯ï¼Œå¯¹äºè¿è¡Œæ—¶è¿›è¡Œæ–¹æ³•äº¤æ¢ï¼Œæœ‰çš„å¼€å‘è€…åœ¨ç¢°åˆ°äº†å‡ æ¬¡é—®é¢˜ä¹‹åï¼Œå°±æ•¬è€Œè¿œä¹‹äº†ï¼Œä½†å…¶å®å¾ˆå¤šé—®é¢˜åœ¨ä½ äº†è§£äº†åŸå› åå°±ä¸é‚£ä¹ˆå¯æ€•äº†ã€‚å°±æ¯”å¦‚è¯´ï¼Œäº†è§£æ›´å¤šè¿è¡Œæ—¶åŸç†å’Œä¼˜ç§€æ–¹æ³•äº¤æ¢åº“çš„å®ç°ç»†èŠ‚ï¼Œèƒ½å¤Ÿå¢å¼ºä½ ä½¿ç”¨è¿è¡Œæ—¶æ–¹æ³•äº¤æ¢çš„ä¿¡å¿ƒï¼Œä»è€Œè¿™ä¸ªæŠ€æœ¯èƒ½å¤Ÿæ›´å¥½åœ°ä¸ºä½ æä¾›æœåŠ¡ï¼Œå»å¸®åŠ©ä½ æ›´åŠ é«˜æ•ˆåœ°å»è§£å†³æŸä¸€ç±»é—®é¢˜ã€‚</p><h2>è¯¾åä½œä¸š</h2><p>ä½ æ˜¯æ€ä¹ˆä½¿ç”¨æ–¹æ³•äº¤æ¢çš„ï¼Ÿç”¨çš„ä»€ä¹ˆåº“ï¼Ÿå’Œ Aspects æ¯”ï¼Œè¿™äº›åº“å¥½åœ¨å“ªå„¿ï¼Ÿ</p><p>æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œæ¬¢è¿ä½ åœ¨è¯„è®ºåŒºç»™æˆ‘ç•™è¨€åˆ†äº«ä½ çš„è§‚ç‚¹ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚</p><p></p>","neighbors":{"left":{"article_title":"33 | iOS ç³»ç»Ÿå†…æ ¸ XNUï¼šApp å¦‚ä½•åŠ è½½ï¼Ÿ","id":97200},"right":{"article_title":"35 | libffiï¼šåŠ¨æ€è°ƒç”¨å’Œå®šä¹‰ C å‡½æ•°","id":98154}},"comments":[{"had_liked":false,"id":98489,"user_name":"Vicky","can_delete":false,"product_type":"c1","uid":1200641,"ip_address":"","ucode":"6F802C8AF8090E","user_header":"https://static001.geekbang.org/account/avatar/00/12/52/01/a8d3db35.jpg","comment_is_top":false,"comment_ctime":1559010519,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"96048291031","product_id":100024501,"comment_content":"æˆ´è€å¸ˆï¼š<br>   â€œç¬¬ä¸‰ä¸ªé£é™©æ˜¯ï¼Œäº¤æ¢çš„æ–¹æ³•å¦‚æœä¾èµ–äº† cmdï¼Œé‚£ä¹ˆäº¤æ¢åï¼Œå¦‚æœ...â€è¿™å¥è¯æœ‰ç‚¹ä¸å¤ªç†è§£ï¼Œèƒ½åšä¸ªè¯¦ç»†çš„é˜è¿°å—ï¼Ÿäº¤æ¢æ–¹æ³•åœ¨ä»€ä¹ˆæƒ…å†µä¼šä¾èµ–cmdï¼Ÿä¸æ˜¯ç‰¹åˆ«ç†è§£ï¼Œè°¢è°¢~","like_count":22,"discussions":[{"author":{"id":1183797,"avatar":"https://static001.geekbang.org/account/avatar/00/12/10/35/e5ecc7b5.jpg","nickname":"Frankyâ€¢æœ¨ä¸‹","note":"","ucode":"A720F2A18A62D8","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":239100,"discussion_content":"çœ‹ @daniel çš„è¯„è®º","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1587273734,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":110431,"user_name":"daniel","can_delete":false,"product_type":"c1","uid":1370456,"ip_address":"","ucode":"3516AF7F9A4DEA","user_header":"https://static001.geekbang.org/account/avatar/00/14/e9/58/397a4ab2.jpg","comment_is_top":false,"comment_ctime":1562257186,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"78871668514","product_id":100024501,"comment_content":"cmdæ˜¯æŒ‡æ¯ä¸ªå‡½æ•°ä¸­éƒ½ä¼šå­˜åœ¨çš„ä¸€ä¸ªéšè—å‚æ•°ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦çŸ¥é“å½“å‰å‡½æ•°çš„åå­—å¯ä»¥é€šè¿‡åœ¨å‡½æ•°å†…éƒ¨NSStringFromSelector(_cmd)æ‰“å°å½“å‰å‡½æ•°åå­—ï¼Œæ–¹æ³•äº¤æ¢åæ˜¾ç„¶åŸæ–¹æ³•çš„cmdä¸åŒäº†ï¼Œå°±è·Ÿè¯„è®ºå…¶ä»–äººè¯´çš„å·®ä¸å¤šï¼Œå‡å¦‚åŸå‡½æ•°æœ‰äº›é€»è¾‘æ˜¯å¯¹_cmdè¿›è¡Œçš„ï¼Œè¿™æ—¶å€™å°±ä¼šå‡ºç°å¥‡æ€ªçš„é”™è¯¯ã€‚","like_count":18},{"had_liked":false,"id":98500,"user_name":"Trust me Ò‰Ò‰Ò‰Ò‰Ò‰Ò‰Ò‰â€","can_delete":false,"product_type":"c1","uid":1112913,"ip_address":"","ucode":"B576CBDE262A40","user_header":"https://static001.geekbang.org/account/avatar/00/10/fb/51/870a6fcb.jpg","comment_is_top":false,"comment_ctime":1559012269,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"40213717933","product_id":100024501,"comment_content":"aspecté£é™©æ‰å¤š bugä¹Ÿå¤š","like_count":9},{"had_liked":false,"id":98805,"user_name":"å¹å•Šå¹å¹","can_delete":false,"product_type":"c1","uid":1455385,"ip_address":"","ucode":"FFB7D85C26145B","user_header":"https://static001.geekbang.org/account/avatar/00/16/35/19/4f9dc4b5.jpg","comment_is_top":false,"comment_ctime":1559098390,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"31623869462","product_id":100024501,"comment_content":"é—®é¢˜è·ŸVicky æœ‹å‹ä¸€æ ·ï¼Œæˆ‘ä¸æ¸…æ¥šè¿™é‡Œçš„cmdæŒ‡çš„æ˜¯ä»€ä¹ˆï¼Œè°¢è°¢","like_count":7,"discussions":[{"author":{"id":1471806,"avatar":"https://static001.geekbang.org/account/avatar/00/16/75/3e/71b16443.jpg","nickname":"Struggle","note":"","ucode":"C769D8FFD9C1B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":290757,"discussion_content":"ä¸æ˜¯å¾ˆå¤šæ—¶å€™ï¼Œåœ¨ä½¿ç”¨dispatchçš„æ—¶å€™ï¼Œä¼šç”¨cmdä½œä¸ºkeyä¹ˆ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594600482,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98435,"user_name":"Usama Bin Laden","can_delete":false,"product_type":"c1","uid":1381768,"ip_address":"","ucode":"5D6CAB1FB73713","user_header":"https://static001.geekbang.org/account/avatar/00/15/15/88/e0845b51.jpg","comment_is_top":false,"comment_ctime":1559004425,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27328808201","product_id":100024501,"comment_content":"æ–¹æ³•äº¤æ¢ï¼Œéƒ½æ²¡ç”¨è¿‡åº“ï¼Œéƒ½æ˜¯ç›´æ¥å†™çš„ã€‚ã€‚ã€‚","like_count":6},{"had_liked":false,"id":98707,"user_name":"Realtime","can_delete":false,"product_type":"c1","uid":1107989,"ip_address":"","ucode":"CCE761CF2CD804","user_header":"https://static001.geekbang.org/account/avatar/00/10/e8/15/c60311ab.jpg","comment_is_top":false,"comment_ctime":1559062274,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23033898754","product_id":100024501,"comment_content":"è€å¸ˆï¼Œswift æœ‰ ç›¸å…³åŠŸèƒ½ä¹ˆï¼Ÿ æ²¡æœ‰çš„è¯ï¼Œæ€ä¹ˆåšæ— ä¾µå…¥åŸ‹ç‚¹å‘€ã€‚è‹¹æœä¸ºå•¥æŠŠåŠ¨æ€åŠŸèƒ½å»æ‰äº†ï¼Œæ€ä¹ˆè€ƒè™‘çš„å‘€ï¼Ÿæœ‰ç›¸å…³çš„æ›¿ä»£æ–¹æ³•ä¹ˆï¼Ÿ","like_count":5},{"had_liked":false,"id":100330,"user_name":"bart","can_delete":false,"product_type":"c1","uid":1394152,"ip_address":"","ucode":"CDB3351F85A65D","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoGRhUIWgJcgLOkpH6p4EfxVGvF0daA9r91CoEcJ0lRIAiad8FJFzf4WVHgJRh0OdicX5PZ2MpWCV0Q/132","comment_is_top":false,"comment_ctime":1559529616,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18739398800","product_id":100024501,"comment_content":"@Vicky æˆ‘å¸®ä½ ä¸¾ä¸ªæ —å­<br>å½“ä½ åœ¨è¿è¡Œæ—¶æ›¿æ¢æŸå¯¹è±¡ä¸­çš„æŸå‡½æ•°å®ç°æ—¶ï¼Œå¦‚æœéœ€è¦åœ¨æ›¿æ¢å‡½æ•°ä¸­è°ƒç”¨åŸå§‹å‡½æ•°å®ç°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨cmdã€‚<br><br> 1.åˆ›å»ºæ–°ç±»ç»§æ‰¿è€ç±»å®ç°ç›¸åŒçš„å‡½æ•°<br> 2.åœ¨è€ç±»çš„åˆ†ç±»çš„å‡½æ•°ä¸­å°†è¢«hookçš„ç±»çš„isaæŒ‡å‘æ–°ç±»(ä¹Ÿå°±æ˜¯ä¿®æ”¹äº†å…ƒç±»)<br> æ­¤æ—¶çš„å®ä¾‹å®é™…ä¸Šå°±æ˜¯æ–°åˆ›å»ºå­ç±»çš„å®ä¾‹äº†<br> 3.æ‰€ä»¥æ­¤æ—¶è°ƒç”¨å®ä¾‹çš„å‡½æ•°å°±ä¼šè°ƒç”¨å­ç±»çš„å‡½æ•°<br> 4.(å¯é€‰ï¼šåœ¨å­ç±»ä¸­åŠ¨æ€è·å–çˆ¶ç±»ï¼Œè°ƒç”¨çˆ¶ç±»çš„eatå‡½æ•°)å°±æ˜¯è¿™æ­¥ï¼Œå¯ä»¥ä½¿ç”¨cmdã€‚<br><br>","like_count":4,"discussions":[{"author":{"id":1785940,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/rWMGIQG1z13nekorr9I4PY1w7rlskssf949IQ24SvIewpM7mmZoH2QEZ2aKHu5tkmicGQ7KTGrN9vFYhrDsdp9w/132","nickname":"Geek_9dbcb4","note":"","ucode":"BB92D5E844A743","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":238014,"discussion_content":"ä½ çš„ç¬¬2æ¡ï¼Œä¸çŸ¥é“è¯´çš„ä»€ä¹ˆæ„æ€ï¼Œèƒ½å±•å¼€è¯´ä¸‹å˜›ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587205341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98517,"user_name":"å¸­ğŸğŸ","can_delete":false,"product_type":"c1","uid":1454597,"ip_address":"","ucode":"EEF51E246A55FD","user_header":"https://static001.geekbang.org/account/avatar/00/16/32/05/b662ff98.jpg","comment_is_top":false,"comment_ctime":1559015332,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14443917220","product_id":100024501,"comment_content":"@Vicky é‚£æ˜¯æŒ‡æ–¹æ³•å†…éƒ¨å¯¹cmdåšäº†åˆ¤æ–­ï¼Œè¿è¡Œç‰¹æ®Šçš„é€»è¾‘ï¼Œè¿›è¡Œswizzä¹‹ååŸæ–¹æ³•çš„cmdä¼šå˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´é€»è¾‘é”™è¯¯","like_count":3},{"had_liked":false,"id":99094,"user_name":"Chouee","can_delete":false,"product_type":"c1","uid":1244701,"ip_address":"","ucode":"F74E58A430C470","user_header":"https://static001.geekbang.org/account/avatar/00/12/fe/1d/ed26272a.jpg","comment_is_top":false,"comment_ctime":1559141572,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5854108868","product_id":100024501,"comment_content":"åŸæ¥çº¯OCå¼€å‘ï¼ŒAspectæ— åŸ‹ç‚¹ç»Ÿè®¡ç”¨å¾—66çš„ã€‚è‡ªä»æ··ç¼–äº†ä¹‹åã€‚ã€‚ã€‚ğŸ•³ğŸ•³ğŸ•³","like_count":1},{"had_liked":false,"id":98762,"user_name":"ç­‡ç¼","can_delete":false,"product_type":"c1","uid":1458239,"ip_address":"","ucode":"A0DB5CC0884E64","user_header":"https://static001.geekbang.org/account/avatar/00/16/40/3f/63fc1b53.jpg","comment_is_top":false,"comment_ctime":1559091589,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"5854058885","product_id":100024501,"comment_content":"æˆ´è€å¸ˆä½ å¥½ï¼Œç”¨ Aspects è¿›è¡Œæ–¹æ³•æ‹¦æˆªæ—¶ï¼Œå¦‚ä½•å®ç°å¸¦æœ‰è¿”å›å€¼æ–¹æ³•çš„æ›¿æ¢ï¼Ÿæ­¤æ—¶çš„è¿”å›å€¼ç”±æˆ‘è‡ªå·±å®šä¹‰ï¼Œè€Œè°ƒç”¨åŸæ–¹æ³•çš„å¯¹è±¡å¯ä»¥å¾—åˆ°è¿™ä¸ªè¿”å›å€¼ã€‚","like_count":1,"discussions":[{"author":{"id":1147205,"avatar":"https://static001.geekbang.org/account/avatar/00/11/81/45/9aa91b75.jpg","nickname":"çŸ®ä¸ªå­å…ˆç”ŸğŸ˜","note":"","ucode":"2242A457B0E10D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":4063,"discussion_content":"é‚£å°±åªèƒ½ç”¨AspectPositionInsteadäº†,ç„¶ååœ¨blocké‡Œè°ƒç”¨åŸæ¥çš„æ–¹æ³•è·å–è¿”å›å€¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565085910,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1085895,"avatar":"https://static001.geekbang.org/account/avatar/00/10/91/c7/68962a38.jpg","nickname":"Geek_2e70e0","note":"","ucode":"B0FDF6C2B96E74","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":2968,"discussion_content":"è¯´çš„ä¹Ÿæ˜¯","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1564073236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":98721,"user_name":"Kai","can_delete":false,"product_type":"c1","uid":1024088,"ip_address":"","ucode":"CD3FACF1803D8F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/58/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1559081419,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5854048715","product_id":100024501,"comment_content":"swiftæ€ä¹ˆè¿›è¡Œç±»ä¼¼method swizzlingçš„æŠ€æœ¯å‘¢ï¼Ÿ","like_count":1},{"had_liked":false,"id":98566,"user_name":"hopestar90","can_delete":false,"product_type":"c1","uid":1457492,"ip_address":"","ucode":"99F2A5664FE1F0","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epVhRFBLPOic3kUju3dkpmwEeI1aBxy7WSGtq5smkicKz4bTbicsSElekSjnBhCQvibncVOHBHeY6pnuA/132","comment_is_top":false,"comment_ctime":1559030934,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5853998230","product_id":100024501,"comment_content":"Aspectsç¡®å®åœ¨åšhookä¸Šå¾ˆæœ‰æƒ³æ³•ï¼Œä¸ä»…èƒ½å¯¹ç±»åšhookï¼Œè¿˜èƒ½å¯¹å•ç‹¬å®ä¾‹åšhookã€‚ä½†æ˜¯æœ¬è´¨ä¸Šä»–ç”¨äº†æ¶ˆæ¯è½¬å‘æµç¨‹ï¼Œä½œè€…ä¹Ÿè¯´äº† ä¸é€‚åˆäºé«˜é¢‘åº¦è°ƒç”¨çš„æ–¹æ³•","like_count":1},{"had_liked":false,"id":357223,"user_name":"å°è‰¯","can_delete":false,"product_type":"c1","uid":1057062,"ip_address":"å¹¿ä¸œ","ucode":"5B5F5AAA843A79","user_header":"https://static001.geekbang.org/account/avatar/00/10/21/26/77f1900a.jpg","comment_is_top":false,"comment_ctime":1663077448,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1663077448","product_id":100024501,"comment_content":"æˆ‘è§‰å¾—æ–‡ç« æ‰€è¯´çš„ã€Œé£é™©ã€ï¼Œåº”è¯¥æ˜¯æ³¨æ„äº‹é¡¹å§ï¼šâ‘  åœ¨ +load æ–¹æ³•äº¤æ¢ï¼ˆè°ƒç”¨å‰å®Œæˆæ–¹æ³•çš„äº¤æ¢ï¼‰ï¼›â‘¡ éœ€è¦é¿å…çˆ¶ç±»äº¤æ¢ï¼›â‘¢ è¿™ä¸ªçš„ç¡®æˆ‘ä¹‹å‰æ²¡æƒ³åˆ°ï¼Œå¯èƒ½æˆ‘æ²¡æœ‰è¯•è¿‡åœ¨æ–¹æ³•é‡Œä½¿ç”¨ _cmd æ¥åšä¸€äº›ä¸šåŠ¡é€»è¾‘å§ï¼›â‘£ æ–¹æ³•äº¤æ¢å‘½åå†²çªï¼ˆæ³¨æ„åŠ å‰ç¼€ï¼‰ğŸ¶","like_count":0},{"had_liked":false,"id":251511,"user_name":"henry_shr","can_delete":false,"product_type":"c1","uid":1028936,"ip_address":"","ucode":"6C32A676D58992","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b3/48/353f9e32.jpg","comment_is_top":false,"comment_ctime":1601633187,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1601633187","product_id":100024501,"comment_content":"ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•å¯ä»¥äº¤æ¢ä¹ˆ","like_count":0},{"had_liked":false,"id":240380,"user_name":"mersa","can_delete":false,"product_type":"c1","uid":1330156,"ip_address":"","ucode":"A9F0B2FF9457C9","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epzwbJGbUmgEC77J6QY6A5pLPdPbw7sqk4DcsHK8qPw7OiaiaMD7pjzb8uHlkY5uLZRibWVvPDDAgM5A/132","comment_is_top":false,"comment_ctime":1596881544,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1596881544","product_id":100024501,"comment_content":"è¯´çš„é‚£ä¸ª_cmdé£é™©ï¼ŒAspectä¹Ÿå­˜åœ¨çš„ã€‚hookæ–¹æ³•ä»¥ååŸæ–¹æ³•æ‰“å°_cmdæ˜¯aliasSelector","like_count":0},{"had_liked":false,"id":187976,"user_name":"ç‹ä¸‡æ°","can_delete":false,"product_type":"c1","uid":1862681,"ip_address":"","ucode":"D1C6C9439712A2","user_header":"https://static001.geekbang.org/account/avatar/00/1c/6c/19/d6814107.jpg","comment_is_top":false,"comment_ctime":1584286043,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584286043","product_id":100024501,"comment_content":"Aspectsæ€§èƒ½ä¸å¦‚Stingerï¼Œæ˜¯å¤§ä¸å¦‚","like_count":0},{"had_liked":false,"id":182713,"user_name":"iHTC","can_delete":false,"product_type":"c1","uid":1048531,"ip_address":"","ucode":"22065449F54F40","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ff/d3/f249eefe.jpg","comment_is_top":false,"comment_ctime":1582854585,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1582854585","product_id":100024501,"comment_content":"ã€Swiftèƒ½ä¸èƒ½ç”¨hookï¼Ÿã€‘<br>æˆ‘ä»¬ä¸ Runtime è¿›è¡Œäº¤äº’çš„åªèƒ½é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹å¼ï¼š<br><br>1ã€Objective-C Source Codeï¼š è¿™ä¸ªæœ€ç›´æ¥ï¼Œæˆ‘ä»¬å†™çš„ OC ä»£ç æœ€ç»ˆéƒ½ä¼šè¢«è½¬æ¢ä¸ºè¿è¡Œæ—¶çš„ä»£ç ï¼Œåœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æ‰§è¡Œçš„å°±æ˜¯è¿™äº›è¿è¡Œæ—¶ä»£ç ã€‚æ¯”å¦‚å‘é€ã€è½¬å‘æ¶ˆæ¯ç­‰ç­‰ã€‚<br><br>2ã€NSObject Methodsï¼š OC ä¸­ï¼Œé™¤äº† NSProxy è¿™ä¸ªç±»ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„ç±»éƒ½ç»§æ‰¿è‡ª NSObjectã€‚è€Œ NSObject ä¸­æœ‰ç€ç±»ä¼¼ class,isKindOfClass,respondsToSelector è¿™æ ·çš„æ–¹æ³•ï¼Œä»–ä»¬éƒ½æ˜¯é€šè¿‡ Runtime æ¥å®ç°çš„ã€‚<br><br>3ã€Runtime Functionsï¼š åœ¨ &#47;usr&#47;include&#47;objc è¿™ä¸ªç›®å½•ä¸­å¯ä»¥æ‰¾åˆ° Runtime æš´éœ²å‡ºæ¥çš„ä¸€äº›å‡½æ•°å’Œæ•°æ®ç»“æ„ï¼Œé€šè¿‡è¿™äº›æ¥å£æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æ›´é«˜çº§çš„æ“ä½œã€‚æ¯”å¦‚ Method Swizzle,AssociatedObject ç­‰ç­‰ã€‚<br><br>æ‰€ä»¥ï¼Œå¦‚æœç”¨Swiftå†™çš„ä»£ç ç»§æ‰¿äº NSObjectå°±å¯ä»¥hookï¼Œäº†è§£æ›´å¤šï¼Œå¯ä»¥çœ‹è¿™ä¸ªæ–‡ç«  https:&#47;&#47;juejin.im&#47;entry&#47;5e3c30cd6fb9a07cad3b8d98","like_count":0},{"had_liked":false,"id":101771,"user_name":"æ™¯å¤©å„¿","can_delete":false,"product_type":"c1","uid":1018983,"ip_address":"","ucode":"1A5EFE9DE2597B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/67/e91fe8d3.jpg","comment_is_top":false,"comment_ctime":1559966772,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559966772","product_id":100024501,"comment_content":"cmdå°±æ˜¯_cmdå§ï¼Œæ„æ€æ˜¯swizzçš„æ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº†_cmdè¿™ä¸ªå®å®šä¹‰ã€‚","like_count":0},{"had_liked":false,"id":101770,"user_name":"æ™¯å¤©å„¿","can_delete":false,"product_type":"c1","uid":1018983,"ip_address":"","ucode":"1A5EFE9DE2597B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8c/67/e91fe8d3.jpg","comment_is_top":false,"comment_ctime":1559966745,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1559966745","product_id":100024501,"comment_content":"è¿™ç¯‡å…³äºAspectä¸ºä»€ä¹ˆæ›´å®‰å…¨ï¼Œä¹Ÿå°±æ˜¯ä»–å¡«å‘çš„åŸç†ï¼Œè®²çš„æœ‰ç‚¹å„¿æŠ½è±¡â€¦â€¦","like_count":0}]}