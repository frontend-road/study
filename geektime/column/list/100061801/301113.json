{"id":301113,"title":"08 | Onceï¼šä¸€ä¸ªç®€çº¦è€Œä¸ç®€å•çš„å¹¶å‘åŸè¯­","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é¸Ÿçªã€‚</p><p>è¿™ä¸€è®²æˆ‘æ¥è®²ä¸€ä¸ªç®€å•çš„å¹¶å‘åŸè¯­ï¼šOnceã€‚ä¸ºä»€ä¹ˆè¦å­¦ä¹ Onceå‘¢ï¼Ÿæˆ‘å…ˆç»™ä½ ç­”æ¡ˆï¼š<strong>Onceå¯ä»¥ç”¨æ¥æ‰§è¡Œä¸”ä»…ä»…æ‰§è¡Œä¸€æ¬¡åŠ¨ä½œï¼Œå¸¸å¸¸ç”¨äºå•ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–åœºæ™¯ã€‚</strong></p><p>é‚£è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±ä»å¯¹å•ä¾‹å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–è¿™ä»¶äº‹å„¿è¯´èµ·ã€‚</p><p>åˆå§‹åŒ–å•ä¾‹èµ„æºæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¯”å¦‚å®šä¹‰packageçº§åˆ«çš„å˜é‡ï¼Œè¿™æ ·ç¨‹åºåœ¨å¯åŠ¨çš„æ—¶å€™å°±å¯ä»¥åˆå§‹åŒ–ï¼š</p><pre><code>package abc\n\nimport time\n\nvar startTime = time.Now()\n</code></pre><p>æˆ–è€…åœ¨initå‡½æ•°ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼š</p><pre><code>package abc\n\nvar startTime time.Time\n\nfunc init() {\n  startTime = time.Now()\n}\n\n</code></pre><p>åˆæˆ–è€…åœ¨mainå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰§è¡Œä¸€ä¸ªåˆå§‹åŒ–çš„å‡½æ•°ï¼š</p><pre><code>package abc\n\nvar startTime time.Tim\n\nfunc initApp() {\n    startTime = time.Now()\n}\nfunc main() {\n  initApp()\n}\n</code></pre><p>è¿™ä¸‰ç§æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”åä¸¤ç§æ–¹æ³•è¿˜å¯ä»¥æ ¹æ®ä¼ å…¥çš„å‚æ•°å®ç°å®šåˆ¶åŒ–çš„åˆå§‹åŒ–æ“ä½œã€‚</p><p>ä½†æ˜¯å¾ˆå¤šæ—¶å€™æˆ‘ä»¬æ˜¯è¦å»¶è¿Ÿè¿›è¡Œåˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å€™å•ä¾‹èµ„æºçš„åˆå§‹åŒ–ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p><pre><code>package main\n\nimport (\n    &quot;net&quot;\n    &quot;sync&quot;\n    &quot;time&quot;\n)\n\n// ä½¿ç”¨äº’æ–¥é”ä¿è¯çº¿ç¨‹(goroutine)å®‰å…¨\nvar connMu sync.Mutex\nvar conn net.Conn\n\nfunc getConn() net.Conn {\n    connMu.Lock()\n    defer connMu.Unlock()\n\n    // è¿”å›å·²åˆ›å»ºå¥½çš„è¿æ¥\n    if conn != nil {\n        return conn\n    }\n\n    // åˆ›å»ºè¿æ¥\n    conn, _ = net.DialTimeout(&quot;tcp&quot;, &quot;baidu.com:80&quot;, 10*time.Second)\n    return conn\n}\n\n// ä½¿ç”¨è¿æ¥\nfunc main() {\n    conn := getConn()\n    if conn == nil {\n        panic(&quot;conn is nil&quot;)\n    }\n}\n</code></pre><p>è¿™ç§æ–¹å¼è™½ç„¶å®ç°èµ·æ¥ç®€å•ï¼Œä½†æ˜¯æœ‰æ€§èƒ½é—®é¢˜ã€‚ä¸€æ—¦è¿æ¥åˆ›å»ºå¥½ï¼Œæ¯æ¬¡è¯·æ±‚çš„æ—¶å€™è¿˜æ˜¯å¾—ç«äº‰é”æ‰èƒ½è¯»å–åˆ°è¿™ä¸ªè¿æ¥ï¼Œè¿™æ˜¯æ¯”è¾ƒæµªè´¹èµ„æºçš„ï¼Œå› ä¸ºè¿æ¥å¦‚æœåˆ›å»ºå¥½ä¹‹åï¼Œå…¶å®å°±ä¸éœ€è¦é”çš„ä¿æŠ¤äº†ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™ä¸€è®²è¦ä»‹ç»çš„Onceå¹¶å‘åŸè¯­äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šè¯¦ç»†ä»‹ç»Onceçš„ä½¿ç”¨ã€å®ç°å’Œæ˜“é”™åœºæ™¯ã€‚</p><h1>Onceçš„ä½¿ç”¨åœºæ™¯</h1><p><strong>sync.Onceåªæš´éœ²äº†ä¸€ä¸ªæ–¹æ³•Doï¼Œä½ å¯ä»¥å¤šæ¬¡è°ƒç”¨Doæ–¹æ³•ï¼Œä½†æ˜¯åªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨Doæ–¹æ³•æ—¶få‚æ•°æ‰ä¼šæ‰§è¡Œï¼Œè¿™é‡Œçš„fæ˜¯ä¸€ä¸ªæ— å‚æ•°æ— è¿”å›å€¼çš„å‡½æ•°ã€‚</strong></p><!-- [[[read_end]]] --><pre><code>func (o *Once) Do(f func())\n</code></pre><p>å› ä¸ºå½“ä¸”ä»…å½“ç¬¬ä¸€æ¬¡è°ƒç”¨Doæ–¹æ³•çš„æ—¶å€™å‚æ•°fæ‰ä¼šæ‰§è¡Œï¼Œå³ä½¿ç¬¬äºŒæ¬¡ã€ç¬¬ä¸‰æ¬¡ã€ç¬¬næ¬¡è°ƒç”¨æ—¶få‚æ•°çš„å€¼ä¸ä¸€æ ·ï¼Œä¹Ÿä¸ä¼šè¢«æ‰§è¡Œï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œè™½ç„¶f1å’Œf2æ˜¯ä¸åŒçš„å‡½æ•°ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå‡½æ•°f2å°±ä¸ä¼šæ‰§è¡Œã€‚</p><pre><code>package main\n\n\nimport (\n    &quot;fmt&quot;\n    &quot;sync&quot;\n)\n\nfunc main() {\n    var once sync.Once\n\n    // ç¬¬ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°\n    f1 := func() {\n        fmt.Println(&quot;in f1&quot;)\n    }\n    once.Do(f1) // æ‰“å°å‡º in f1\n\n    // ç¬¬äºŒä¸ªåˆå§‹åŒ–å‡½æ•°\n    f2 := func() {\n        fmt.Println(&quot;in f2&quot;)\n    }\n    once.Do(f2) // æ— è¾“å‡º\n}\n</code></pre><p>å› ä¸ºè¿™é‡Œçš„få‚æ•°æ˜¯ä¸€ä¸ªæ— å‚æ•°æ— è¿”å›çš„å‡½æ•°ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šé€šè¿‡é—­åŒ…çš„æ–¹å¼å¼•ç”¨å¤–é¢çš„å‚æ•°ï¼Œæ¯”å¦‚ï¼š</p><pre><code>    var addr = &quot;baidu.com&quot;\n\n    var conn net.Conn\n    var err error\n\n    once.Do(func() {\n        conn, err = net.Dial(&quot;tcp&quot;, addr)\n    })\n</code></pre><p>è€Œä¸”åœ¨å®é™…çš„ä½¿ç”¨ä¸­ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¼šä½¿ç”¨é—­åŒ…çš„æ–¹å¼å»åˆå§‹åŒ–å¤–éƒ¨çš„ä¸€ä¸ªèµ„æºã€‚</p><p>ä½ çœ‹ï¼ŒOnceçš„ä½¿ç”¨åœºæ™¯å¾ˆæ˜ç¡®ï¼Œæ‰€ä»¥ï¼Œåœ¨æ ‡å‡†åº“å†…éƒ¨å®ç°ä¸­ä¹Ÿå¸¸å¸¸èƒ½çœ‹åˆ°Onceçš„èº«å½±ã€‚</p><p>æ¯”å¦‚æ ‡å‡†åº“å†…éƒ¨<a href=\"https://github.com/golang/go/blob/f0e97546962736fe4aa73b7c7ed590f0134515e1/src/cmd/go/internal/cache/default.go\">cache</a>çš„å®ç°ä¸Šï¼Œå°±ä½¿ç”¨äº†Onceåˆå§‹åŒ–Cacheèµ„æºï¼ŒåŒ…æ‹¬defaultDirå€¼çš„è·å–ï¼š</p><pre><code>    func Default() *Cache { // è·å–é»˜è®¤çš„Cache\n\t\tdefaultOnce.Do(initDefaultCache) // åˆå§‹åŒ–cache\n\t\treturn defaultCache\n\t}\n\t\n    // å®šä¹‰ä¸€ä¸ªå…¨å±€çš„cacheå˜é‡ï¼Œä½¿ç”¨Onceåˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªOnceå˜é‡\n\tvar (\n\t\tdefaultOnce  sync.Once\n\t\tdefaultCache *Cache\n\t)\n\n    func initDefaultCache() { //åˆå§‹åŒ–cache,ä¹Ÿå°±æ˜¯Once.Doä½¿ç”¨çš„få‡½æ•°\n\t\t......\n\t\tdefaultCache = c\n\t}\n\n    // å…¶å®ƒä¸€äº›Onceåˆå§‹åŒ–çš„å˜é‡ï¼Œæ¯”å¦‚defaultDir\n    var (\n\t\tdefaultDirOnce sync.Once\n\t\tdefaultDir     string\n\t\tdefaultDirErr  error\n\t)\n\n\n</code></pre><p>è¿˜æœ‰ä¸€äº›æµ‹è¯•çš„æ—¶å€™åˆå§‹åŒ–æµ‹è¯•çš„èµ„æºï¼ˆ<a href=\"https://github.com/golang/go/blob/50bd1c4d4eb4fac8ddeb5f063c099daccfb71b26/src/time/export_windows_test.go\">export_windows_test</a>ï¼‰ï¼š</p><pre><code>    // æµ‹è¯•windowç³»ç»Ÿè°ƒç”¨æ—¶åŒºç›¸å…³å‡½æ•°\n    func ForceAusFromTZIForTesting() {\n\t\tResetLocalOnceForTest()\n        // ä½¿ç”¨Onceæ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–\n\t\tlocalOnce.Do(func() { initLocalFromTZI(&amp;aus) })\n\t}\n</code></pre><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¿è¯åªè°ƒç”¨ä¸€æ¬¡copyenvçš„envOnceï¼ŒstringsåŒ…ä¸‹çš„Replacerï¼ŒtimeåŒ…ä¸­çš„<a href=\"https://github.com/golang/go/blob/b71eafbcece175db33acfb205e9090ca99a8f984/src/time/export_test.go#L12\">æµ‹è¯•</a>ï¼ŒGoæ‹‰å–åº“æ—¶çš„<a href=\"https://github.com/golang/go/blob/8535008765b4fcd5c7dc3fb2b73a856af4d51f9b/src/cmd/go/internal/modfetch/proxy.go#L103\">proxy</a>ï¼Œnet.pipeï¼Œcrc64ï¼ŒRegexpï¼Œâ€¦â€¦ï¼Œæ•°ä¸èƒœæ•°ã€‚æˆ‘ç»™ä½ é‡ç‚¹ä»‹ç»ä¸€ä¸‹å¾ˆå€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„ math/big/sqrt.goä¸­å®ç°çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒé€šè¿‡Onceå°è£…äº†ä¸€ä¸ªåªåˆå§‹åŒ–ä¸€æ¬¡çš„å€¼ï¼š</p><pre><code>   // å€¼æ˜¯3.0æˆ–è€…0.0çš„ä¸€ä¸ªæ•°æ®ç»“æ„\n   var threeOnce struct {\n\t\tsync.Once\n\t\tv *Float\n\t}\n\t\n    // è¿”å›æ­¤æ•°æ®ç»“æ„çš„å€¼ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ä¸º3.0ï¼Œåˆ™åˆå§‹åŒ–\n\tfunc three() *Float {\n\t\tthreeOnce.Do(func() { // ä½¿ç”¨Onceåˆå§‹åŒ–\n\t\t\tthreeOnce.v = NewFloat(3.0)\n\t\t})\n\t\treturn threeOnce.v\n\t}\n</code></pre><p>å®ƒå°†sync.Onceå’Œ*Floatå°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œæä¾›äº†åªåˆå§‹åŒ–ä¸€æ¬¡çš„å€¼vã€‚ ä½ çœ‹å®ƒçš„threeæ–¹æ³•çš„å®ç°ï¼Œè™½ç„¶æ¯æ¬¡éƒ½è°ƒç”¨threeOnce.Doæ–¹æ³•ï¼Œä½†æ˜¯å‚æ•°åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p><p>å½“ä½ ä½¿ç”¨Onceçš„æ—¶å€™ï¼Œä½ ä¹Ÿå¯ä»¥å°è¯•é‡‡ç”¨è¿™ç§ç»“æ„ï¼Œå°†å€¼å’ŒOnceå°è£…æˆä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„ï¼Œæä¾›åªåˆå§‹åŒ–ä¸€æ¬¡çš„å€¼ã€‚</p><p>æ€»ç»“ä¸€ä¸‹Onceå¹¶å‘åŸè¯­è§£å†³çš„é—®é¢˜å’Œä½¿ç”¨åœºæ™¯ï¼š<strong>Onceå¸¸å¸¸ç”¨æ¥åˆå§‹åŒ–å•ä¾‹èµ„æºï¼Œæˆ–è€…å¹¶å‘è®¿é—®åªéœ€åˆå§‹åŒ–ä¸€æ¬¡çš„å…±äº«èµ„æºï¼Œæˆ–è€…åœ¨æµ‹è¯•çš„æ—¶å€™åˆå§‹åŒ–ä¸€æ¬¡æµ‹è¯•èµ„æº</strong>ã€‚</p><p>äº†è§£äº†Onceçš„ä½¿ç”¨åœºæ™¯ï¼Œé‚£åº”è¯¥æ€æ ·å®ç°ä¸€ä¸ªOnceå‘¢ï¼Ÿ</p><h1>å¦‚ä½•å®ç°ä¸€ä¸ªOnceï¼Ÿ</h1><p>å¾ˆå¤šäººè®¤ä¸ºå®ç°ä¸€ä¸ªOnceä¸€æ ·çš„å¹¶å‘åŸè¯­å¾ˆç®€å•ï¼Œåªéœ€ä½¿ç”¨ä¸€ä¸ªflagæ ‡è®°æ˜¯å¦åˆå§‹åŒ–è¿‡å³å¯ï¼Œæœ€å¤šæ˜¯ç”¨atomicåŸå­æ“ä½œè¿™ä¸ªflagï¼Œæ¯”å¦‚ä¸‹é¢çš„å®ç°ï¼š</p><pre><code>type Once struct {\n    done uint32\n}\n\nfunc (o *Once) Do(f func()) {\n    if !atomic.CompareAndSwapUint32(&amp;o.done, 0, 1) {\n        return\n    }\n    f()\n}\n</code></pre><p>è¿™ç¡®å®æ˜¯ä¸€ç§å®ç°æ–¹å¼ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªå®ç°æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå°±æ˜¯å¦‚æœå‚æ•°fæ‰§è¡Œå¾ˆæ…¢çš„è¯ï¼Œåç»­è°ƒç”¨Doæ–¹æ³•çš„goroutineè™½ç„¶çœ‹åˆ°doneå·²ç»è®¾ç½®ä¸ºæ‰§è¡Œè¿‡äº†ï¼Œä½†æ˜¯è·å–æŸäº›åˆå§‹åŒ–èµ„æºçš„æ—¶å€™å¯èƒ½ä¼šå¾—åˆ°ç©ºçš„èµ„æºï¼Œå› ä¸ºfè¿˜æ²¡æœ‰æ‰§è¡Œå®Œã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>ä¸€ä¸ªæ­£ç¡®çš„Onceå®ç°è¦ä½¿ç”¨ä¸€ä¸ªäº’æ–¥é”ï¼Œ<strong>è¿™æ ·åˆå§‹åŒ–çš„æ—¶å€™å¦‚æœæœ‰å¹¶å‘çš„goroutineï¼Œå°±ä¼šè¿›å…¥</strong>doSlowæ–¹æ³•</strong>ã€‚äº’æ–¥é”çš„æœºåˆ¶ä¿è¯åªæœ‰ä¸€ä¸ªgoroutineè¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒæ—¶åˆ©ç”¨<strong>åŒæ£€æŸ¥çš„æœºåˆ¶</strong>ï¼ˆdouble-checkingï¼‰ï¼Œå†æ¬¡åˆ¤æ–­o.doneæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œåˆ™æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œå°±å°†o.doneè®¾ç½®ä¸º1ï¼Œç„¶åé‡Šæ”¾é”ã€‚</p><p>å³ä½¿æ­¤æ—¶æœ‰å¤šä¸ªgoroutineåŒæ—¶è¿›å…¥äº†doSlowæ–¹æ³•ï¼Œå› ä¸ºåŒæ£€æŸ¥çš„æœºåˆ¶ï¼Œåç»­çš„goroutineä¼šçœ‹åˆ°o.doneçš„å€¼ä¸º1ï¼Œä¹Ÿä¸ä¼šå†æ¬¡æ‰§è¡Œfã€‚</p><p>è¿™æ ·æ—¢ä¿è¯äº†å¹¶å‘çš„goroutineä¼šç­‰å¾…få®Œæˆï¼Œè€Œä¸”è¿˜ä¸ä¼šå¤šæ¬¡æ‰§è¡Œfã€‚</p><pre><code>type Once struct {\n    done uint32\n    m    Mutex\n}\n\nfunc (o *Once) Do(f func()) {\n    if atomic.LoadUint32(&amp;o.done) == 0 {\n        o.doSlow(f)\n    }\n}\n\n\nfunc (o *Once) doSlow(f func()) {\n    o.m.Lock()\n    defer o.m.Unlock()\n    // åŒæ£€æŸ¥\n    if o.done == 0 {\n        defer atomic.StoreUint32(&amp;o.done, 1)\n        f()\n    }\n}\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°±äº†è§£äº†Onceçš„ä½¿ç”¨åœºæ™¯ï¼Œå¾ˆæ˜ç¡®ï¼ŒåŒæ—¶å‘¢ï¼Œä¹Ÿæ„Ÿå—åˆ°Onceçš„å®ç°ä¹Ÿæ˜¯ç›¸å¯¹ç®€å•çš„ã€‚åœ¨å®è·µä¸­ï¼Œå…¶å®å¾ˆå°‘ä¼šå‡ºç°é”™è¯¯ä½¿ç”¨Onceçš„æƒ…å†µï¼Œä½†æ˜¯å°±åƒå¢¨è²å®šå¾‹è¯´çš„ï¼Œå‡¡æ˜¯å¯èƒ½å‡ºé”™çš„äº‹å°±ä¸€å®šä¼šå‡ºé”™ã€‚ä½¿ç”¨Onceä¹Ÿæœ‰å¯èƒ½å‡ºç°ä¸¤ç§é”™è¯¯åœºæ™¯ï¼Œå°½ç®¡éå¸¸ç½•è§ã€‚æˆ‘è¿™é‡Œæå‰è®²ç»™ä½ ï¼Œå’±æ‰“ä¸ªé¢„é˜²é’ˆã€‚</p><h1>ä½¿ç”¨Onceå¯èƒ½å‡ºç°çš„2ç§é”™è¯¯</h1><h2>ç¬¬ä¸€ç§é”™è¯¯ï¼šæ­»é”</h2><p>ä½ å·²ç»çŸ¥é“äº†Doæ–¹æ³•ä¼šæ‰§è¡Œä¸€æ¬¡fï¼Œä½†æ˜¯å¦‚æœfä¸­å†æ¬¡è°ƒç”¨è¿™ä¸ªOnceçš„Doæ–¹æ³•çš„è¯ï¼Œå°±ä¼šå¯¼è‡´æ­»é”çš„æƒ…å†µå‡ºç°ã€‚è¿™è¿˜ä¸æ˜¯æ— é™é€’å½’çš„æƒ…å†µï¼Œè€Œæ˜¯çš„çš„ç¡®ç¡®çš„Lockçš„é€’å½’è°ƒç”¨å¯¼è‡´çš„æ­»é”ã€‚</p><pre><code>func main() {\n    var once sync.Once\n    once.Do(func() {\n        once.Do(func() {\n            fmt.Println(&quot;åˆå§‹åŒ–&quot;)\n        })\n    })\n}\n</code></pre><p>å½“ç„¶ï¼Œæƒ³è¦é¿å…è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œå°±ä¸è¦åœ¨få‚æ•°ä¸­è°ƒç”¨å½“å‰çš„è¿™ä¸ªOnceï¼Œä¸ç®¡æ˜¯ç›´æ¥çš„è¿˜æ˜¯é—´æ¥çš„ã€‚</p><h2>ç¬¬äºŒç§é”™è¯¯ï¼šæœªåˆå§‹åŒ–</h2><p>å¦‚æœfæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™panicï¼Œæˆ–è€…fæ‰§è¡Œåˆå§‹åŒ–èµ„æºçš„æ—¶å€™å¤±è´¥äº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒOnceè¿˜æ˜¯ä¼šè®¤ä¸ºåˆæ¬¡æ‰§è¡Œå·²ç»æˆåŠŸäº†ï¼Œå³ä½¿å†æ¬¡è°ƒç”¨Doæ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå†æ¬¡æ‰§è¡Œfã€‚</p><p>æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œç”±äºä¸€äº›é˜²ç«å¢™çš„åŸå› ï¼ŒgoogleConnå¹¶æ²¡æœ‰è¢«æ­£ç¡®çš„åˆå§‹åŒ–ï¼Œåé¢å¦‚æœæƒ³å½“ç„¶è®¤ä¸ºæ—¢ç„¶æ‰§è¡Œäº†Doæ–¹æ³•googleConnå°±å·²ç»åˆå§‹åŒ–çš„è¯ï¼Œä¼šæŠ›å‡ºç©ºæŒ‡é’ˆçš„é”™è¯¯ï¼š</p><pre><code>func main() {\n    var once sync.Once\n    var googleConn net.Conn // åˆ°Googleç½‘ç«™çš„ä¸€ä¸ªè¿æ¥\n\n    once.Do(func() {\n        // å»ºç«‹åˆ°google.comçš„è¿æ¥ï¼Œæœ‰å¯èƒ½å› ä¸ºç½‘ç»œçš„åŸå› ï¼ŒgoogleConnå¹¶æ²¡æœ‰å»ºç«‹æˆåŠŸï¼Œæ­¤æ—¶å®ƒçš„å€¼ä¸ºnil\n        googleConn, _ = net.Dial(&quot;tcp&quot;, &quot;google.com:80&quot;)\n    })\n    // å‘é€httpè¯·æ±‚\n    googleConn.Write([]byte(&quot;GET / HTTP/1.1\\r\\nHost: google.com\\r\\n Accept: */*\\r\\n\\r\\n&quot;))\n    io.Copy(os.Stdout, googleConn)\n}\n</code></pre><p>æ—¢ç„¶æ‰§è¡Œè¿‡Once.Doæ–¹æ³•ä¹Ÿå¯èƒ½å› ä¸ºå‡½æ•°æ‰§è¡Œå¤±è´¥çš„åŸå› æœªåˆå§‹åŒ–èµ„æºï¼Œå¹¶ä¸”ä»¥åä¹Ÿæ²¡æœºä¼šå†æ¬¡åˆå§‹åŒ–èµ„æºï¼Œé‚£ä¹ˆè¿™ç§åˆå§‹åŒ–æœªå®Œæˆçš„é—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘æ¥å‘Šè¯‰ä½ ä¸€æ‹›ç‹¬å®¶ç§˜ç¬ˆï¼Œæˆ‘ä»¬å¯ä»¥<strong>è‡ªå·±å®ç°ä¸€ä¸ªç±»ä¼¼Onceçš„å¹¶å‘åŸè¯­</strong>ï¼Œæ—¢å¯ä»¥è¿”å›å½“å‰è°ƒç”¨Doæ–¹æ³•æ˜¯å¦æ­£ç¡®å®Œæˆï¼Œè¿˜å¯ä»¥åœ¨åˆå§‹åŒ–å¤±è´¥åè°ƒç”¨Doæ–¹æ³•å†æ¬¡å°è¯•åˆå§‹åŒ–ï¼Œç›´åˆ°åˆå§‹åŒ–æˆåŠŸæ‰ä¸å†åˆå§‹åŒ–äº†ã€‚</p><pre><code>// ä¸€ä¸ªåŠŸèƒ½æ›´åŠ å¼ºå¤§çš„Once\ntype Once struct {\n    m    sync.Mutex\n    done uint32\n}\n// ä¼ å…¥çš„å‡½æ•°fæœ‰è¿”å›å€¼errorï¼Œå¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œéœ€è¦è¿”å›å¤±è´¥çš„error\n// Doæ–¹æ³•ä¼šæŠŠè¿™ä¸ªerrorè¿”å›ç»™è°ƒç”¨è€…\nfunc (o *Once) Do(f func() error) error {\n    if atomic.LoadUint32(&amp;o.done) == 1 { //fast path\n        return nil\n    }\n    return o.slowDo(f)\n}\n// å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–\nfunc (o *Once) slowDo(f func() error) error {\n    o.m.Lock()\n    defer o.m.Unlock()\n    var err error\n    if o.done == 0 { // åŒæ£€æŸ¥ï¼Œè¿˜æ²¡æœ‰åˆå§‹åŒ–\n        err = f()\n        if err == nil { // åˆå§‹åŒ–æˆåŠŸæ‰å°†æ ‡è®°ç½®ä¸ºå·²åˆå§‹åŒ–\n            atomic.StoreUint32(&amp;o.done, 1)\n        }\n    }\n    return err\n}\n</code></pre><p>æˆ‘ä»¬æ‰€åšçš„æ”¹å˜å°±æ˜¯Doæ–¹æ³•å’Œå‚æ•°få‡½æ•°éƒ½ä¼šè¿”å›errorï¼Œå¦‚æœfæ‰§è¡Œå¤±è´¥ï¼Œä¼šæŠŠè¿™ä¸ªé”™è¯¯ä¿¡æ¯è¿”å›ã€‚</p><p>å¯¹slowDoæ–¹æ³•ä¹Ÿåšäº†è°ƒæ•´ï¼Œå¦‚æœfè°ƒç”¨å¤±è´¥ï¼Œæˆ‘ä»¬ä¸ä¼šæ›´æ”¹doneå­—æ®µçš„å€¼ï¼Œè¿™æ ·åç»­çš„goroutineè¿˜ä¼šç»§ç»­è°ƒç”¨fã€‚å¦‚æœfæ‰§è¡ŒæˆåŠŸï¼Œæ‰ä¼šä¿®æ”¹doneçš„å€¼ä¸º1ã€‚</p><p>å¯ä»¥è¯´ï¼ŒçœŸæ˜¯ä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œæˆ‘ä»¬ä½¿ç”¨Onceæœ‰ç‚¹å¾—å¿ƒåº”æ‰‹çš„æ„Ÿè§‰äº†ã€‚ç­‰ç­‰ï¼Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆæŸ¥è¯¢æ˜¯å¦åˆå§‹åŒ–è¿‡å‘¢ï¼Ÿ</p><p>ç›®å‰çš„Onceå®ç°å¯ä»¥ä¿è¯ä½ è°ƒç”¨ä»»æ„æ¬¡æ•°çš„once.Doæ–¹æ³•ï¼Œå®ƒåªä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•ä¸€æ¬¡ã€‚ä½†æ˜¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰“ä¸€ä¸ªæ ‡è®°ã€‚å¦‚æœåˆå§‹åŒ–åæˆ‘ä»¬å°±å»æ‰§è¡Œå…¶å®ƒçš„æ“ä½œï¼Œæ ‡å‡†åº“çš„Onceå¹¶ä¸ä¼šå‘Šè¯‰ä½ æ˜¯å¦åˆå§‹åŒ–å®Œæˆäº†ï¼Œåªæ˜¯è®©ä½ æ”¾å¿ƒå¤§èƒ†åœ°å»æ‰§è¡ŒDoæ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œ<strong>ä½ è¿˜éœ€è¦ä¸€ä¸ªè¾…åŠ©å˜é‡ï¼Œè‡ªå·±å»æ£€æŸ¥æ˜¯å¦åˆå§‹åŒ–è¿‡äº†</strong>ï¼Œæ¯”å¦‚é€šè¿‡ä¸‹é¢çš„ä»£ç ä¸­çš„initedå­—æ®µï¼š</p><pre><code>type AnimalStore struct {once   sync.Once;inited uint32}\nfunc (a *AnimalStore) Init() // å¯ä»¥è¢«å¹¶å‘è°ƒç”¨\n\ta.once.Do(func() {\n\t\tlongOperationSetupDbOpenFilesQueuesEtc()\n\t\tatomic.StoreUint32(&amp;a.inited, 1)\n\t})\n}\nfunc (a *AnimalStore) CountOfCats() (int, error) { // å¦å¤–ä¸€ä¸ªgoroutine\n\tif atomic.LoadUint32(&amp;a.inited) == 0 { // åˆå§‹åŒ–åæ‰ä¼šæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘\n\t\treturn 0, NotYetInitedError\n\t}\n        //Real operation\n}\n</code></pre><p>å½“ç„¶ï¼Œé€šè¿‡è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥è§£å†³è¿™ç±»é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå¦‚æœå®˜æ–¹çš„Onceç±»å‹æœ‰Doneè¿™æ ·ä¸€ä¸ªæ–¹æ³•çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚è¿™æ˜¯æœ‰äººåœ¨Goä»£ç åº“ä¸­æå‡ºçš„ä¸€ä¸ªissue(<a href=\"https://github.com/golang/go/issues/41690\">#41690</a>)ã€‚å¯¹äºè¿™ç±»é—®é¢˜ï¼Œä¸€èˆ¬éƒ½ä¼šè¢«å»ºè®®é‡‡ç”¨å…¶å®ƒç±»å‹ï¼Œæˆ–è€…è‡ªå·±å»æ‰©å±•ã€‚æˆ‘ä»¬å¯ä»¥å°è¯•æ‰©å±•è¿™ä¸ªå¹¶å‘åŸè¯­ï¼š</p><pre><code>// Once æ˜¯ä¸€ä¸ªæ‰©å±•çš„sync.Onceç±»å‹ï¼Œæä¾›äº†ä¸€ä¸ªDoneæ–¹æ³•\ntype Once struct {\n    sync.Once\n}\n\n// Done è¿”å›æ­¤Onceæ˜¯å¦æ‰§è¡Œè¿‡\n// å¦‚æœæ‰§è¡Œè¿‡åˆ™è¿”å›true\n// å¦‚æœæ²¡æœ‰æ‰§è¡Œè¿‡æˆ–è€…æ­£åœ¨æ‰§è¡Œï¼Œè¿”å›false\nfunc (o *Once) Done() bool {\n    return atomic.LoadUint32((*uint32)(unsafe.Pointer(&amp;o.Once))) == 1\n}\n\nfunc main() {\n    var flag Once\n    fmt.Println(flag.Done()) //false\n\n    flag.Do(func() {\n        time.Sleep(time.Second)\n    })\n\n    fmt.Println(flag.Done()) //true\n}\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå…³äºå¹¶å‘åŸè¯­Onceçš„å†…å®¹æˆ‘è®²å¾—å°±å·®ä¸å¤šäº†ã€‚æœ€åå‘¢ï¼Œå’Œä½ åˆ†äº«ä¸€ä¸ªOnceçš„è¸©å‘æ¡ˆä¾‹ã€‚</p><p>å…¶å®å•Šï¼Œä½¿ç”¨OnceçœŸçš„ä¸å®¹æ˜“çŠ¯é”™ï¼Œæƒ³çŠ¯é”™éƒ½å¾ˆå›°éš¾ï¼Œå› ä¸ºå¾ˆå°‘æœ‰äººä¼šå‚»å‚»åœ°åœ¨åˆå§‹åŒ–å‡½æ•°fä¸­é€’å½’è°ƒç”¨fï¼Œè¿™ç§æ­»é”çš„ç°è±¡å‡ ä¹ä¸ä¼šå‘ç”Ÿã€‚å¦å¤–å¦‚æœå‡½æ•°åˆå§‹åŒ–ä¸æˆåŠŸï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼španicï¼Œæˆ–è€…åœ¨ä½¿ç”¨çš„æ—¶å€™åšæ£€æŸ¥ï¼Œä¼šåŠæ—©å‘ç°è¿™ä¸ªé—®é¢˜ï¼Œåœ¨åˆå§‹åŒ–å‡½æ•°ä¸­åŠ å¼ºä»£ç ã€‚</p><p>æ‰€ä»¥æŸ¥çœ‹å¤§éƒ¨åˆ†çš„Goé¡¹ç›®ï¼Œå‡ ä¹æ‰¾ä¸åˆ°Onceçš„é”™è¯¯ä½¿ç”¨åœºæ™¯ï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯å‘ç°äº†ä¸€ä¸ªã€‚è¿™ä¸ªissueå…ˆä»å¦å¤–ä¸€ä¸ªéœ€æ±‚(<a href=\"https://github.com/golang/go/issues/25955\">go#25955</a>)è°ˆèµ·ã€‚</p><h1>Onceçš„è¸©å‘æ¡ˆä¾‹</h1><p>go#25955æœ‰ç½‘å‹æå‡ºä¸€ä¸ªéœ€æ±‚ï¼Œå¸Œæœ›Onceæä¾›ä¸€ä¸ªResetæ–¹æ³•ï¼Œèƒ½å¤Ÿå°†Onceé‡ç½®ä¸ºåˆå§‹åŒ–çš„çŠ¶æ€ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼ŒSté€šè¿‡ä¸¤ä¸ªOnceæ§åˆ¶å®ƒçš„Open/CloseçŠ¶æ€ã€‚ä½†æ˜¯åœ¨Closeä¹‹åå†è°ƒç”¨Opençš„è¯ï¼Œä¸ä¼šå†æ‰§è¡Œinitå‡½æ•°ï¼Œå› ä¸ºOnceåªä¼šæ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–å‡½æ•°ã€‚</p><pre><code>type St struct {\n    openOnce *sync.Once\n    closeOnce *sync.Once\n}\n\nfunc(st *St) Open(){\n    st.openOnce.Do(func() { ... }) // init\n    ...\n}\n\nfunc(st *St) Close(){\n    st.closeOnce.Do(func() { ... }) // deinit\n    ...\n}\n</code></pre><p>æ‰€ä»¥æäº¤è¿™ä¸ªIssueçš„å¼€å‘è€…å¸Œæœ›Onceå¢åŠ ä¸€ä¸ªResetæ–¹æ³•ï¼ŒResetä¹‹åå†è°ƒç”¨once.Doå°±åˆå¯ä»¥åˆå§‹åŒ–äº†ã€‚</p><p>Goçš„æ ¸å¿ƒå¼€å‘è€…Ian Lance Taylorç»™ä»–äº†ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªä½¿ç”¨ä¸€ä¸ªponce *sync.Once åšåˆå§‹åŒ–ï¼ŒResetçš„æ—¶å€™ç»™ponceè¿™ä¸ªå˜é‡èµ‹å€¼ä¸€ä¸ªæ–°çš„Onceå®ä¾‹å³å¯(ponce = new(sync.Once))ã€‚Onceçš„æœ¬æ„å°±æ˜¯æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥Resetç ´åäº†è¿™ä¸ªå¹¶å‘åŸè¯­çš„æœ¬æ„ã€‚</p><p>è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸€ç‚¹éƒ½æ²¡é—®é¢˜ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä½å¼€å‘è€…çš„éœ€æ±‚ã€‚Dockerè¾ƒæ—©çš„ç‰ˆæœ¬ï¼ˆ1.11.2ï¼‰ä¸­ä½¿ç”¨äº†å®ƒä»¬çš„ä¸€ä¸ªç½‘ç»œåº“libnetworkï¼Œè¿™ä¸ªç½‘ç»œåº“åœ¨ä½¿ç”¨Onceçš„æ—¶å€™å°±ä½¿ç”¨Ian Lance Taylorä»‹ç»çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œå®ƒçš„Resetæ–¹æ³•ä¸­åˆæ”¹å˜äº†OnceæŒ‡é’ˆçš„å€¼ï¼Œå¯¼è‡´ç¨‹åºpanicäº†ã€‚åŸå§‹é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œä¸€ä¸ªç®€åŒ–ç‰ˆå¯é‡ç°çš„<a href=\"https://play.golang.org/p/xPULnrVKiY\">ä»£ç </a>å¦‚ä¸‹ï¼š</p><pre><code>package main\n\nimport (\n\t&quot;fmt&quot;\n\t&quot;sync&quot;\n\t&quot;time&quot;\n)\n\n// ä¸€ä¸ªç»„åˆçš„å¹¶å‘åŸè¯­\ntype MuOnce struct {\n\tsync.RWMutex\n\tsync.Once\n\tmtime time.Time\n\tvals  []string\n}\n\n// ç›¸å½“äºresetæ–¹æ³•ï¼Œä¼šå°†m.Onceé‡æ–°å¤åˆ¶ä¸€ä¸ªOnce\nfunc (m *MuOnce) refresh() {\n\tm.Lock()\n\tdefer m.Unlock()\n\tm.Once = sync.Once{}\n\tm.mtime = time.Now()\n\tm.vals = []string{m.mtime.String()}\n}\n\n// è·å–æŸä¸ªåˆå§‹åŒ–çš„å€¼ï¼Œå¦‚æœè¶…è¿‡æŸä¸ªæ—¶é—´ï¼Œä¼šreset Once\nfunc (m *MuOnce) strings() []string {\n\tnow := time.Now()\n\tm.RLock()\n\tif now.After(m.mtime) {\n\t\tdefer m.Do(m.refresh) // ä½¿ç”¨refreshå‡½æ•°é‡æ–°åˆå§‹åŒ–\n\t}\n\tvals := m.vals\n\tm.RUnlock()\n\treturn vals\n}\n\nfunc main() {\n\tfmt.Println(&quot;Hello, playground&quot;)\n\tm := new(MuOnce)\n\tfmt.Println(m.strings())\n\tfmt.Println(m.strings())\n}\n</code></pre><p>å¦‚æœä½ æ‰§è¡Œè¿™æ®µä»£ç å°±ä¼španic:</p><p><img src=\"https://static001.geekbang.org/resource/image/f3/af/f3401f75a86e1d0c3b257f52696228af.png?wh=1323*482\" alt=\"\"></p><p>åŸå› åœ¨äºç¬¬31è¡Œæ‰§è¡Œm.Once.Doæ–¹æ³•çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯m.Onceçš„æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨m.refreshï¼Œåœ¨æ‰§è¡Œm.refreshçš„æ—¶å€™Onceå†…éƒ¨çš„Mutexé¦–å…ˆä¼šåŠ é”ï¼ˆå¯ä»¥å†ç¿»çœ‹ä¸€ä¸‹è¿™ä¸€è®²çš„Onceçš„å®ç°åŸç†ï¼‰ï¼Œ ä½†æ˜¯ï¼Œåœ¨refreshä¸­æ›´æ”¹äº†OnceæŒ‡é’ˆçš„å€¼ä¹‹åï¼Œç»“æœåœ¨æ‰§è¡Œå®Œrefreshé‡Šæ”¾é”çš„æ—¶å€™ï¼Œé‡Šæ”¾çš„æ˜¯ä¸€ä¸ªåˆšåˆå§‹åŒ–æœªåŠ é”çš„Mutexï¼Œæ‰€ä»¥å°±panicäº†ã€‚</p><p>å¦‚æœä½ è¿˜ä¸å¤ªæ˜ç™½ï¼Œæˆ‘å†ç»™ä½ ç®€åŒ–æˆä¸€ä¸ªæ›´ç®€å•çš„ä¾‹å­ï¼š</p><pre><code>package main\n\n\nimport (\n    &quot;sync&quot;\n)\n\ntype Once struct {\n    m sync.Mutex\n}\n\nfunc (o *Once) doSlow() {\n    o.m.Lock()\n    defer o.m.Unlock()\n\n    // è¿™é‡Œæ›´æ–°çš„oæŒ‡é’ˆçš„å€¼!!!!!!!, ä¼šå¯¼è‡´ä¸Šä¸€è¡ŒUnlockå‡ºé”™\n    *o = Once{}\n}\n\nfunc main() {\n    var once Once\n    once.doSlow()\n}\n</code></pre><p>doSlowæ–¹æ³•å°±æ¼”ç¤ºäº†è¿™ä¸ªé”™è¯¯ã€‚Ian Lance Taylorä»‹ç»çš„Resetæ–¹æ³•æ²¡æœ‰é”™è¯¯ï¼Œä½†æ˜¯ä½ åœ¨ä½¿ç”¨çš„æ—¶å€™åƒä¸‡åˆ«å†åˆå§‹åŒ–å‡½æ•°ä¸­Resetè¿™ä¸ªOnceï¼Œå¦åˆ™åŠ¿å¿…ä¼šå¯¼è‡´Unlockä¸€ä¸ªæœªåŠ é”çš„Mutexçš„é”™è¯¯ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œè¿™è¿˜æ˜¯å¯¹Onceçš„å®ç°æœºåˆ¶ä¸ç†Ÿæ‚‰ï¼Œåˆè¿›è¡Œå¤æ‚ä½¿ç”¨å¯¼è‡´çš„é”™è¯¯ã€‚ä¸è¿‡æœ€æ–°ç‰ˆçš„libnetworkç›¸å…³çš„åœ°æ–¹å·²ç»å»æ‰äº†Onceçš„ä½¿ç”¨äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘å¸¦ä½ ä¸€èµ·æ¥çœ‹è¿™ä¸ªæ¡ˆä¾‹ï¼Œä¸»è¦ç›®çš„è¿˜æ˜¯æƒ³å·©å›ºä¸€ä¸‹æˆ‘ä»¬å¯¹Onceçš„ç†è§£ã€‚</p><h1>æ€»ç»“</h1><p>ä»Šå¤©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†Onceï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨å®ƒæ¥å®ç°å•ä¾‹æ¨¡å¼ã€‚</p><p>å•ä¾‹æ˜¯23ç§è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å¸¸å¸¸å¼•èµ·äº‰è®®çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œç”šè‡³æœ‰äººæŠŠå®ƒå½’ä¸ºåæ¨¡å¼ã€‚ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯åæ¨¡å¼å‘¢ï¼Œæˆ‘æ‹¿æ ‡å‡†åº“ä¸­çš„å•ä¾‹æ¨¡å¼ç»™ä½ ä»‹ç»ä¸‹ã€‚</p><p>å› ä¸ºGoæ²¡æœ‰immutableç±»å‹ï¼Œå¯¼è‡´æˆ‘ä»¬å£°æ˜çš„å…¨å±€å˜é‡éƒ½æ˜¯å¯å˜çš„ï¼Œåˆ«çš„åœ°æ–¹æˆ–è€…ç¬¬ä¸‰æ–¹åº“å¯ä»¥éšæ„æ›´æ”¹è¿™äº›å˜é‡ã€‚æ¯”å¦‚package ioä¸­å®šä¹‰äº†å‡ ä¸ªå…¨å±€å˜é‡ï¼Œæ¯”å¦‚io.EOFï¼š</p><pre><code>var EOF = errors.New(&quot;EOF&quot;)\n</code></pre><p>å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªpackageçº§åˆ«çš„å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­å·å·æŠŠå®ƒæ”¹äº†ï¼Œè¿™ä¼šå¯¼è‡´ä¸€äº›ä¾èµ–io.EOFè¿™ä¸ªå˜é‡åšåˆ¤æ–­çš„ä»£ç å‡ºé”™ã€‚</p><pre><code>io.EOF = errors.New(&quot;æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„EOF&quot;)\n</code></pre><p>ä»æˆ‘ä¸ªäººçš„è§’åº¦æ¥è¯´ï¼Œä¸€äº›å•ä¾‹ï¼ˆå…¨å±€å˜é‡ï¼‰çš„ç¡®å¾ˆæ–¹ä¾¿ï¼Œæ¯”å¦‚Bufferæ± æˆ–è€…è¿æ¥æ± ï¼Œæ‰€ä»¥æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿä¸è¦è°ˆè™è‰²å˜ã€‚è™½ç„¶æœ‰äººæŠŠå•ä¾‹æ¨¡å¼ç§°ä¹‹ä¸ºåæ¨¡å¼ï¼Œä½†æ¯•ç«Ÿåªèƒ½ä»£è¡¨ä¸€éƒ¨åˆ†å¼€å‘è€…çš„è§‚ç‚¹ï¼Œå¦åˆ™ä¹Ÿä¸ä¼šæŠŠå®ƒåˆ—åœ¨23ç§è®¾è®¡æ¨¡å¼ä¸­äº†ã€‚</p><p>å¦‚æœä½ çœŸçš„æ‹…å¿ƒè¿™ä¸ªpackageçº§åˆ«çš„å˜é‡è¢«äººä¿®æ”¹ï¼Œä½ å¯ä»¥ä¸æŠŠå®ƒä»¬æš´éœ²å‡ºæ¥ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªåªè¯»çš„GetXXXçš„æ–¹æ³•ï¼Œè¿™æ ·åˆ«äººå°±ä¸ä¼šè¿›è¡Œä¿®æ”¹äº†ã€‚</p><p>è€Œä¸”ï¼ŒOnceä¸åªåº”ç”¨äºå•ä¾‹æ¨¡å¼ï¼Œä¸€äº›å˜é‡åœ¨ä¹Ÿéœ€è¦åœ¨ä½¿ç”¨çš„æ—¶å€™åšå»¶è¿Ÿåˆå§‹åŒ–ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨Onceå¤„ç†è¿™äº›åœºæ™¯çš„ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼ŒOnceçš„åº”ç”¨åœºæ™¯è¿˜æ˜¯å¾ˆå¹¿æ³›çš„ã€‚<strong>ä¸€æ—¦ä½ é‡åˆ°åªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡çš„åœºæ™¯ï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±åº”è¯¥æ˜¯Onceå¹¶å‘åŸè¯­ã€‚</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/4b/ba/4b1721a63d7bd3f3995eb18cee418fba.jpg?wh=2250*880\" alt=\"\"></p><h1>æ€è€ƒé¢˜</h1><ol>\n<li>\n<p>æˆ‘å·²ç»åˆ†æäº†å‡ ä¸ªå¹¶å‘åŸè¯­çš„å®ç°ï¼Œä½ å¯èƒ½æ³¨æ„åˆ°æ€»æ˜¯æœ‰äº›slowXXXXçš„æ–¹æ³•ï¼Œä»XXXXæ–¹æ³•ä¸­å•ç‹¬æŠ½å–å‡ºæ¥ï¼Œä½ æ˜ç™½ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå—ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p>\n</li>\n<li>\n<p>Onceåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨ä¹‹åï¼Œè¿˜èƒ½å¤åˆ¶ç»™å…¶å®ƒå˜é‡ä½¿ç”¨å—ï¼Ÿ</p>\n</li>\n</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„æ€è€ƒå’Œç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸€èµ·äº¤æµè®¨è®ºã€‚å¦‚æœä½ è§‰å¾—æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ã€‚</p>","comments":[{"had_liked":false,"id":260823,"user_name":"ç«¯è´º","can_delete":false,"product_type":"c1","uid":1121588,"ip_address":"","ucode":"80F1400B138055","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/34/8201baab.jpg","comment_is_top":false,"comment_ctime":1605137605,"is_pvip":false,"replies":[{"id":"94718","content":"å¯¹","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605142963,"ip_address":"","comment_id":260823,"utype":1}],"discussion_count":3,"race_medal":0,"score":"66029647045","product_id":100061801,"comment_content":"é—®é¢˜ä¸€ï¼šåˆ†ç¦»å›ºå®šå†…å®¹å’Œéå›ºå®šå†…å®¹ï¼Œä½¿å¾—å›ºå®šçš„å†…å®¹èƒ½è¢«å†…è”è°ƒç”¨ï¼Œä»è€Œä¼˜åŒ–æ‰§è¡Œè¿‡ç¨‹ã€‚<br>é—®é¢˜äºŒï¼šOnceè¢«æ‹·è´çš„è¿‡ç¨‹ä¸­å†…éƒ¨çš„å·²æ‰§è¡ŒçŠ¶æ€ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥Onceä¸èƒ½é€šè¿‡æ‹·è´å¤šæ¬¡æ‰§è¡Œã€‚<br>ä¸çŸ¥é“å›ç­”å¯¹ä¸å¯¹ï¼Œè¯·è€å¸ˆæŒ‡ç‚¹ã€‚","like_count":16,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509297,"discussion_content":"å¯¹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605142963,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1629565,"avatar":"https://static001.geekbang.org/account/avatar/00/18/dd/7d/5d3ab033.jpg","nickname":"ä¸æ±‚é—»è¾¾","note":"","ucode":"B265859B9566D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":329485,"discussion_content":"å¯ä»¥æ‹·è´ï¼Œä½†è¿™æ ·æ‹·è´ä¸ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œæ‰€ä»¥æ‹·è´æ²¡æœ‰æ„ä¹‰ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1606390500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1181650,"avatar":"https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg","nickname":"æƒ˜ é—»","note":"","ucode":"C5909F034BF072","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":385865,"discussion_content":"éå›ºå®šçš„å†…å®¹æŒ‡ä»€ä¹ˆå‘€ï¼Œæœ‰ä»£ç ç¤ºä¾‹å—ï¼Ÿå¯¹æ¯”ä¸€ä¸‹å›ºå®šä¸éå›ºå®š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627305169,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":261660,"user_name":"å¤§åŠ›","can_delete":false,"product_type":"c1","uid":1199805,"ip_address":"","ucode":"29785E3575761C","user_header":"https://static001.geekbang.org/account/avatar/00/12/4e/bd/4b19cda0.jpg","comment_is_top":false,"comment_ctime":1605485569,"is_pvip":false,"replies":[{"id":"94988","content":"ä½ å¯ä»¥æœä¸€ä¸‹golang inline,æœ‰å‡ ä½å¤§ç‰›å·²ç»ä»‹ç»äº†å†…è”ä¼˜åŒ–çš„çŸ¥è¯†","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1605512515,"ip_address":"","comment_id":261660,"utype":1}],"discussion_count":1,"race_medal":0,"score":"27375289345","product_id":100061801,"comment_content":"è¯·æ•™è¿™é‡Œæ‰€è¯´çš„å†…è”ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":509556,"discussion_content":"ä½ å¯ä»¥æœä¸€ä¸‹golang inline,æœ‰å‡ ä½å¤§ç‰›å·²ç»ä»‹ç»äº†å†…è”ä¼˜åŒ–çš„çŸ¥è¯†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605512515,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257098,"user_name":"ğŸ€æŸ æª¬é±¼ä¹Ÿæ˜¯é±¼","can_delete":false,"product_type":"c1","uid":2178501,"ip_address":"","ucode":"DCF033636465F3","user_header":"https://static001.geekbang.org/account/avatar/00/21/3d/c5/f43fa619.jpg","comment_is_top":false,"comment_ctime":1603851973,"is_pvip":false,"replies":[{"id":"93591","content":"å› ä¸ºæœ‰å¹¶å‘åˆå§‹åŒ–çš„é—®é¢˜","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603861913,"ip_address":"","comment_id":257098,"utype":1}],"discussion_count":4,"race_medal":0,"score":"27373655749","product_id":100061801,"comment_content":"onceä¸ºä»€ä¹ˆä¸ç›´æ¥åŠ é”ï¼Œè¿˜éœ€è¦åŠ å¤šä¸€ä¸ª åŒé‡æ£€æµ‹å‘¢ï¼Ÿè¿™å—ä¸å¤ªæ‡‚ï¼Œæœ›è€å¸ˆè§£ç­”ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œè°ƒç”¨do()ä¹‹åç›´æ¥ä¸Šé”ï¼Œç­‰æ‰§è¡Œå®Œf()å†è§£é”ä¸å°±è¡Œäº†å—","like_count":6,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508222,"discussion_content":"å› ä¸ºæœ‰å¹¶å‘åˆå§‹åŒ–çš„é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603861913,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1217952,"avatar":"","nickname":"xueleixi","note":"","ucode":"C2F25B4D1FEF76","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318871,"discussion_content":"ç¬¬ä¸€æ¬¡æ£€æµ‹ä¸éœ€è¦åŠ é”ï¼Œæ€§èƒ½é«˜","likes_number":6,"is_delete":false,"is_hidden":false,"ctime":1603870986,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1556358,"avatar":"https://static001.geekbang.org/account/avatar/00/17/bf/86/c0cb35f0.jpg","nickname":"8.13.3.27.30","note":"","ucode":"2DE3CE3E338BAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535554,"discussion_content":"ä¸‹é¢æ˜¯æˆ‘çš„ç†è§£: \nå…ˆç›´æ¥å›ç­”ä½ çš„é—®é¢˜,å¦‚æœç›´æ¥åŠ é”,ä»ç»“æœä¸Šçœ‹æ²¡æœ‰åŒºåˆ«,éƒ½èƒ½å®ç°åªåšä¸€æ¬¡\n\né—®é¢˜åœ¨äºlockçš„æ€§èƒ½é—®é¢˜,å°±æ˜¯ä¸Šé¢xueleixiè¯´çš„,lockå¯èƒ½ä¼šå¯¼è‡´goroutineä¼‘çœ \n\nä¸ºä»€ä¹ˆæ˜¯å¯èƒ½å‘¢\n\nmutexé‚£ä¸€ç« èŠ‚è¯´è¿‡å¦‚æœlockæ²¡æœ‰è¢«äººå ç”¨,é‚£ä¹ˆä»–å°±æ„‰å¿«çš„æ‰§è¡Œäº†\n\nå¦‚æœåœ¨åšdoçš„æ—¶å€™å‘ç°å¦å¤–ä¸€ä¸ªgoruotineæ­£åœ¨æ‰§è¡Œlock,é‚£ç³»ç»Ÿå¯èƒ½å°±è¦å¯¹ä¸èµ·ä½ äº†,\n\nä½ å…ˆä¼‘æ¯ä¸€ä¼š,å¯¼è‡´goroutineä¼‘çœ ,goroutineä¼‘çœ æ˜¯æœ‰ä»£ä»·çš„ï¼Œcpuä¼šè¿›è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢,\n\nå¯¼è‡´çš„ç»“æœå°±æ˜¯ä¸Šé¢åŒå­¦è¯´çš„æ€§èƒ½ä¸é«˜äº†ã€‚\n\nå¦å¤–,æˆ‘è®¤ä¸ºè¿™ä¸ªlockçš„ç›®çš„æ˜¯ä¸ºäº†æœ€å¼€å§‹è°ƒç”¨è¿™ä¸ªdoçš„æ—¶å€™,å¦‚æœæœ‰å¹¶å‘,èƒ½ä¿è¯å¹¶å‘çš„æ‰€æœ‰doç»“æŸçš„æ—¶å€™få‡½æ•°å·²ç»è¢«è°ƒç”¨å®Œæˆã€‚ä¹‹åçš„doä¸éœ€è¦æ‰§è¡Œå‡½æ•°äº†ä¹Ÿå°±æ²¡å¿…è¦å»åšä¸ªlockäº†,åšäº†å°±ä¼šåƒä¸Šé¢è¯´çš„ä¸€æ ·æ€§èƒ½å˜å·®\n\nä»¥ä¸Šä¸ªäººç†è§£,ä»…ä¾›å‚è€ƒ,å¦‚æœ‰ç†è§£é—®é¢˜,æœ›æŒ‡ç‚¹\n\n\n\n\n\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1638459252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1556358,"avatar":"https://static001.geekbang.org/account/avatar/00/17/bf/86/c0cb35f0.jpg","nickname":"8.13.3.27.30","note":"","ucode":"2DE3CE3E338BAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":535557,"discussion_content":"è¡¥å……ä¸€ç‚¹,è€å¸ˆè¯´çš„fast path åº”è¯¥å°±æ˜¯è¿™ä¸ªæ„æ€","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638459412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257337,"user_name":"moooofly","can_delete":false,"product_type":"c1","uid":1008348,"ip_address":"","ucode":"4A20795C281B6F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","comment_is_top":false,"comment_ctime":1603940749,"is_pvip":false,"replies":[{"id":"93741","content":"fast pathä¸­è¯»å–o.done,å¹¶æ²¡æœ‰åœ¨mutexä¿æŠ¤ä¹‹ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1604014175,"ip_address":"","comment_id":257337,"utype":1}],"discussion_count":10,"race_medal":0,"score":"23078777229","product_id":100061801,"comment_content":"è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ç¤ºä¾‹ä»£ç ä¸­æœ‰å¦‚ä¸‹ç‰‡æ®µ<br><br>```<br>func (o *Once) doSlow(f func()) {<br>    o.m.Lock()<br>    defer o.m.Unlock()<br>    &#47;&#47; åŒæ£€æŸ¥<br>    if o.done == 0 {<br>        defer atomic.StoreUint32(&amp;o.done, 1)<br>        f()<br>    }<br>}<br>```<br><br>åœ¨åŒæ£€æŸ¥æ•´æ”¹åœ°æ–¹ï¼Œè¯»å– o.done çš„å€¼å¹¶æ²¡æœ‰ä½¿ç”¨ä½¿ç”¨ atomic.LoadUint32(&amp;o.done) çš„æ–¹å¼ï¼ŒæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œæ˜¯å› ä¸ºå·²ç»å¤„äº o.m.Lock() çš„ä¿æŠ¤ä¸‹çš„ç¼˜æ•…ï¼›é‚£æ˜¯å¦ atomic.StoreUint32(&amp;o.done, 1) ä¹Ÿå¯ä»¥ç›´æ¥ o.done = 1 å‘¢ï¼Ÿæ¯•ç«Ÿè¿™ä¸ªä»£ç ä¹Ÿåœ¨ o.m.Lock() çš„ä¿æŠ¤ä¸‹","like_count":5,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508299,"discussion_content":"fast pathä¸­è¯»å–o.done,å¹¶æ²¡æœ‰åœ¨mutexä¿æŠ¤ä¹‹ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604014175,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1193874,"avatar":"https://static001.geekbang.org/account/avatar/00/12/37/92/961ba560.jpg","nickname":"æˆäººä»¥ğŸŸï¼Œä¸å¦‚æˆäººä»¥æ¸”","note":"","ucode":"BD53829E924B66","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":411473,"discussion_content":"moooofly è¯´çš„æ˜¯ ã€Œ if o.done == 0 ã€ è¿™ä¸ªåœ°æ–¹æ˜¯åœ¨ o.m.Lock() è¯»å–çš„ã€‚è€å¸ˆè¯´çš„ï¼šã€Œfast pathä¸­è¯»å–o.done,å¹¶æ²¡æœ‰åœ¨mutexä¿æŠ¤ä¹‹ä¸‹ã€æ˜¯ ã€Œatomic.LoadUint32(&amp;o.done)ã€ æ²¡æœ‰åŠ é”ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1635936028,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1055479,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1a/f7/cb61b37f.jpg","nickname":"Tatum è‹å¤©æ–Œ","note":"","ucode":"75F09E6C5FB27B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":388611,"discussion_content":"å¯èƒ½è¿™ä¸ªæœ‰ç”¨ï¼š https://github.com/wisecsj/wisecsj.github.io/issues/25","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628847682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"å´å°æ™º","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382058,"discussion_content":"åŒæ²¡ç†è§£è€å¸ˆçš„å›ç­”ï¼Œfast path çš„è¯»ï¼Œæ˜¯æŒ‡é‚£ä¸ªè¯»ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625391849,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1196531,"avatar":"https://static001.geekbang.org/account/avatar/00/12/41/f3/8bca4aba.jpg","nickname":"æ™®é€šç†ŠçŒ« à¬˜(à©­ËŠê’³â€‹Ë‹)à©­âœ§","note":"","ucode":"7FEF9C72B4801B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":326053,"discussion_content":"å…³äºè¿™ä¸ªé—®é¢˜ï¼Œä¸€ç›´æ²¡æœ‰æ‰¾åˆ°ç›¸å…³èµ„æ–™çš„è§£é‡Š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1605507875,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":319379,"discussion_content":"ä½ è¿™å›ç­”çš„ä¸æ˜¯æˆ‘é—®çš„é—®é¢˜å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604019678,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":4,"child_discussions":[{"author":{"id":1136236,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","nickname":"David","note":"","ucode":"8277D3CE881053","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":339991,"discussion_content":"è€å¸ˆè¯´çš„æ²¡é”™ï¼Œæ˜¯ä½ åº”è¯¥æ²¡ç†è§£åˆ°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1609856423,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":319379,"ip_address":""},"score":339991,"extra":""},{"author":{"id":1157786,"avatar":"https://static001.geekbang.org/account/avatar/00/11/aa/9a/92d2df36.jpg","nickname":"tianfeiyu","note":"","ucode":"E65E6841AD5D7F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1136236,"avatar":"https://static001.geekbang.org/account/avatar/00/11/56/6c/042a2e41.jpg","nickname":"David","note":"","ucode":"8277D3CE881053","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":387438,"discussion_content":"åŒæ²¡ç†è§£è€å¸ˆçš„æ„æ€ï¼Œå¸Œæœ›å¤§ä½¬ç»™è¯¦ç»†è§£é‡Šä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628170872,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":339991,"ip_address":""},"score":387438,"extra":""},{"author":{"id":1368768,"avatar":"https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg","nickname":"chongsheng","note":"","ucode":"859DF328FCA608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":543996,"discussion_content":"è€å¸ˆå›ç­”æ²¡é—®é¢˜ï¼Œåªæ˜¯ä½ æ²¡getåˆ°ç‚¹ã€‚\nè€å¸ˆçš„æ„æ€æ˜¯ï¼Œå¦‚æœä½¿ç”¨defer once.done=1ï¼Œé‚£ä¹ˆè¿™ä¸ªä¿®æ”¹ä¸ä¼šè¢«fast pathé‡Œçš„Loadè§‚å¯Ÿåˆ°ï¼Œå¯ä»¥ç”¨-raceæµ‹ä¸€ä¸‹ä¼šæœ‰å¹¶å‘è¯»å†™é—®é¢˜ã€‚\né™¤éå¯¹fast pathé‡Œè·å–once.doneå€¼ä¹Ÿç”¨once.måŠ é”ï¼Œæ ¹æ®lockçš„happens-beforeåŸåˆ™ï¼Œæ‰ä¼šè¢«fast pathè§‚æµ‹åˆ°ã€‚\néƒ½ç”¨atomicæ“ä½œä¿è¯äº†å¯è§æ€§å’ŒåŸå­æ€§ï¼Œå°±ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜äº†ã€‚","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1641376977,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":319379,"ip_address":""},"score":543996,"extra":""}]}]},{"had_liked":false,"id":257101,"user_name":"Linuxer","can_delete":false,"product_type":"c1","uid":1153978,"ip_address":"","ucode":"272D9D8089C3D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/9b/ba/333b59e5.jpg","comment_is_top":false,"comment_ctime":1603852078,"is_pvip":false,"replies":[{"id":"93594","content":"fast pathçš„ä¸€ä¸ªå¥½å¤„æ˜¯æ­¤æ–¹æ³•å¯ä»¥å†…è”","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1603862129,"ip_address":"","comment_id":257101,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18783721262","product_id":100061801,"comment_content":"ç¬¬ä¸€ä¸ªæ€è€ƒé¢˜ï¼šLinuxå†…æ ¸ä¹Ÿæœ‰å¾ˆå¤šè¿™ç§fast code pathå’Œslow  code pathï¼Œæˆ‘æƒ³è¿™æ ·åˆ’åˆ†æ˜¯ä¸æ˜¯å†…èšæ€§æ›´å¥½ï¼Œå®ç°æ›´æ¸…æ™°å‘¢,ä»linuxæ€§èƒ½åˆ†ææ¥çœ‹ï¼Œè²Œä¼¼æ›´å¤šå…³æ³¨ç‚¹æ˜¯åœ¨slow code path<br>ç¬¬äºŒä¸ªæ€è€ƒé¢˜ï¼šåº”è¯¥ä¸å¯ä»¥å§ï¼ŒOnceçš„å†…éƒ¨çŠ¶æ€å·²ç»è¢«æ”¹å˜äº†","like_count":4,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508224,"discussion_content":"fast pathçš„ä¸€ä¸ªå¥½å¤„æ˜¯æ­¤æ–¹æ³•å¯ä»¥å†…è”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603862129,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257259,"user_name":"Rememberä¹ç¦»","can_delete":false,"product_type":"c1","uid":1237327,"ip_address":"","ucode":"97EE6E6344689F","user_header":"https://static001.geekbang.org/account/avatar/00/12/e1/4f/00476b4c.jpg","comment_is_top":false,"comment_ctime":1603896804,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5898864100","product_id":100061801,"comment_content":"ä¸€ä¸ªonce,çœ‹ç€å°±ä¸€ç‚¹ä»£ç è¿˜èƒ½è¿™ä¹ˆç©ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¼Œä»Šæ—¥ä»½æ•´ç†ï¼šhttps:&#47;&#47;github.com&#47;wuqinqiang&#47;Go_Concurrency&#47;tree&#47;main&#47;class_8","like_count":1},{"had_liked":false,"id":352684,"user_name":"è¸¢è½¦ç‰›","can_delete":false,"product_type":"c1","uid":1200020,"ip_address":"","ucode":"D6D793EF5314A0","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/94/05044c31.jpg","comment_is_top":false,"comment_ctime":1658880647,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1658880647","product_id":100061801,"comment_content":"å†™äº†ä¸€ç¯‡æ–‡ç« ä»ä»‹ç»äº†å•ä¾‹æ¨¡å¼ï¼Œä¹Ÿä»‹ç»äº† sync.once çš„åˆæ¥ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è¯»ä¸€ä¸‹ï¼Œä¿å‡†ä½ æœ‰æ”¶è·<br><br>https:&#47;&#47;juejin.cn&#47;post&#47;7124720007447052302","like_count":0},{"had_liked":false,"id":352371,"user_name":"i_chase","can_delete":false,"product_type":"c1","uid":1795511,"ip_address":"","ucode":"09C41C863F4EA3","user_header":"https://static001.geekbang.org/account/avatar/00/1b/65/b7/058276dc.jpg","comment_is_top":false,"comment_ctime":1658590731,"is_pvip":true,"replies":[{"id":"128194","content":"å†…è”æ•´ä¸ªå‡½æ•°","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1658705707,"ip_address":"","comment_id":352371,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1658590731","product_id":100061801,"comment_content":"è¿˜å¯ä»¥åªå†…è”å‡½æ•°åœ¨doSlowçš„å‰çš„éƒ¨åˆ†å—ï¼Œä¸€ç›´ä»¥ä¸ºå†…è”æ˜¯å°†æ•´ä¸ªå‡½æ•°å†…è”ä¸Šå»äº†","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581275,"discussion_content":"å†…è”æ•´ä¸ªå‡½æ•°","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658705707,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333497,"user_name":"xl666","can_delete":false,"product_type":"c1","uid":2046604,"ip_address":"","ucode":"CF9A8086F91053","user_header":"https://static001.geekbang.org/account/avatar/00/1f/3a/8c/fc2c3e5c.jpg","comment_is_top":false,"comment_ctime":1644387396,"is_pvip":false,"replies":[{"id":"121867","content":"å…¶å®ƒgoroutineä¹Ÿåœ¨ç­‰å¾…é”å•Šï¼Œç­‰ç¬¬ä¸€ä¸ªé‡Šæ”¾é”åå°±è¿›æ¥äº†","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1644401606,"ip_address":"","comment_id":333497,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1644387396","product_id":100061801,"comment_content":"â€˜â€™è¿™ç¡®å®æ˜¯ä¸€ç§å®ç°æ–¹å¼ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªå®ç°æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå°±æ˜¯å¦‚æœå‚æ•° f æ‰§è¡Œå¾ˆæ…¢çš„è¯ï¼Œåç»­è°ƒç”¨ Do æ–¹æ³•çš„ goroutine è™½ç„¶çœ‹åˆ° done å·²ç»è®¾ç½®ä¸ºæ‰§è¡Œè¿‡äº†ï¼Œä½†æ˜¯è·å–æŸäº›åˆå§‹åŒ–èµ„æºçš„æ—¶å€™å¯èƒ½ä¼šå¾—åˆ°ç©ºçš„èµ„æºï¼Œå› ä¸º f è¿˜æ²¡æœ‰æ‰§è¡Œå®Œã€‚â€˜â€™è€å¸ˆæˆ‘ä»¬è¿è¡ŒDoåˆå§‹åŒ–çš„æ—¶å€™ ä¸€èˆ¬åŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨ é‚£å°±å°±æ˜¯è¯´ æŠ¢åˆ°é”çš„gofuncåœ¨åˆå§‹åŒ–fn()æ²¡æœ‰è¿è¡Œç»“æŸæ—¶ä¸ä¼šé‡Šæ”¾é” å…¶ä»–gofuncè¿›ä¸æ¥ æ‰€ä»¥ä¸ä¼šå¯¼è‡´ä¸Šé¢è¯´çš„é‚£ç§æƒ…å†µ<br><br>æˆ‘æ˜¯è¿™æ ·ç†è§£çš„<br><br>è¦æ˜¯åˆå§‹åŒ–ä¸åŠ é”å€’æ˜¯ä¼š ","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550168,"discussion_content":"å…¶å®ƒgoroutineä¹Ÿåœ¨ç­‰å¾…é”å•Šï¼Œç­‰ç¬¬ä¸€ä¸ªé‡Šæ”¾é”åå°±è¿›æ¥äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644401606,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":326868,"user_name":"Bynow","can_delete":false,"product_type":"c1","uid":2735072,"ip_address":"","ucode":"1E4F3ADD65CF18","user_header":"https://static001.geekbang.org/account/avatar/00/29/bb/e0/c7cd5170.jpg","comment_is_top":false,"comment_ctime":1639727912,"is_pvip":false,"replies":[{"id":"118825","content":"è¿™æ˜¯unsafe.Pointerå¸¸ç”¨æ–¹æ³•ï¼Œä½ å¯ä»¥æ‰¾è¿™ä¸ªç±»å‹çš„æ•™ç¨‹æ·±å…¥äº†è§£ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1066613","ctime":1639806978,"ip_address":"","comment_id":326868,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1639727912","product_id":100061801,"comment_content":"è¯·é—®ï¼š(*uint32)(unsafe.Pointer(&amp;o.Once))  è¿™ä¸ªè¡¨è¾¾å¼ä¸ºä»€ä¹ˆä¼šæ˜¯1ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539701,"discussion_content":"è¿™æ˜¯unsafe.Pointerå¸¸ç”¨æ–¹æ³•ï¼Œä½ å¯ä»¥æ‰¾è¿™ä¸ªç±»å‹çš„æ•™ç¨‹æ·±å…¥äº†è§£ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639806979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":309653,"user_name":"æ–¯è’‚èŠ¬.èµµ","can_delete":false,"product_type":"c1","uid":1200179,"ip_address":"","ucode":"AA0FF2DA654418","user_header":"https://static001.geekbang.org/account/avatar/00/12/50/33/9dcd30c4.jpg","comment_is_top":false,"comment_ctime":1630291229,"is_pvip":true,"replies":[{"id":"112418","content":"å¦‚ä½•ä¿®ï¼Ÿ","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1630589842,"ip_address":"","comment_id":309653,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1630291229","product_id":100061801,"comment_content":"æ—¢ç„¶æœ‰æœªåˆå§‹åŒ–é”™è¯¯çš„é—®é¢˜ï¼Œä¸ºå•¥å®˜æ–¹ä¸å»ä¿®å¤å®ƒå‘¢","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525948,"discussion_content":"å¦‚ä½•ä¿®ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630589842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302906,"user_name":"Yayu","can_delete":false,"product_type":"c1","uid":1058015,"ip_address":"","ucode":"5E7842458D8229","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/df/645f8087.jpg","comment_is_top":false,"comment_ctime":1626429249,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1626429249","product_id":100061801,"comment_content":"â€œå¦‚æœä½ çœŸçš„æ‹…å¿ƒè¿™ä¸ª package çº§åˆ«çš„å˜é‡è¢«äººä¿®æ”¹ï¼Œä½ å¯ä»¥ä¸æŠŠå®ƒä»¬æš´éœ²å‡ºæ¥ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªåªè¯»çš„ GetXXX çš„æ–¹æ³•ï¼Œè¿™æ ·åˆ«äººå°±ä¸ä¼šè¿›è¡Œä¿®æ”¹äº†ã€‚â€<br><br>è¿™ä¸ªæ–¹æ³•æ²¡æ³•è§£å†³å…¨å±€å˜é‡æ˜¯æŒ‡é’ˆç±»å‹æˆ–è€…ç»“æ„å†…åŒ…å«æŒ‡é’ˆç±»å‹çš„å˜é‡å‘€ï¼Œè¿™ç§æƒ…å†µåˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":299550,"user_name":"Geek_c0a611","can_delete":false,"product_type":"c1","uid":2398259,"ip_address":"","ucode":"B4E036C6690DBB","user_header":"https://static001.geekbang.org/account/avatar/00/24/98/33/04e9d1a4.jpg","comment_is_top":false,"comment_ctime":1624701247,"is_pvip":false,"replies":[{"id":"108651","content":"è¿™é‡Œå€’ä¸æ˜¯æ§åˆ¶å¹¶å‘å†™ï¼Œè€Œæ˜¯ä¿è¯å¯ç”¨æ€§ã€‚åœ¨intelcpuå¯èƒ½æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¯¹arm,è¦ä¿è¯è¯»å–è¿™ä¸ªflagçš„æ—¶å€™çœ‹åˆ°å…ˆå‰çš„å†™","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1624764883,"ip_address":"","comment_id":299550,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1624701247","product_id":100061801,"comment_content":"func (a *AnimalStore) Init() {<br>        a.once.Do(func() { <br>            longOperationSetupDbOpenFilesQueuesEtc() <br>             atomic.StoreUint32(&amp;a.inited, 1) <br>        })<br>}<br><br>è€å¸ˆï¼Œæ„Ÿè§‰è¿™é‡Œçš„atomic.StoreUint32æ˜¯ä¸æ²¡å¿…è¦å‘€ï¼Œå› ä¸ºDoåœ¨æ‰§è¡Œf()çš„æ—¶å€™æ˜¯å·²ç»åŠ äº†é”çš„","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":522469,"discussion_content":"è¿™é‡Œå€’ä¸æ˜¯æ§åˆ¶å¹¶å‘å†™ï¼Œè€Œæ˜¯ä¿è¯å¯ç”¨æ€§ã€‚åœ¨intelcpuå¯èƒ½æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¯¹arm,è¦ä¿è¯è¯»å–è¿™ä¸ªflagçš„æ—¶å€™çœ‹åˆ°å…ˆå‰çš„å†™","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624764883,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1310798,"avatar":"https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg","nickname":"å´å°æ™º","note":"","ucode":"C7C9F58B5C9F7B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":382220,"discussion_content":"https://colobu.com/2021/05/05/triple-gates-of-sync-Once/#more","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625477321,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":275735,"user_name":"Panda","can_delete":false,"product_type":"c1","uid":1095740,"ip_address":"","ucode":"911A200C7B18BE","user_header":"https://static001.geekbang.org/account/avatar/00/10/b8/3c/1a294619.jpg","comment_is_top":false,"comment_ctime":1611654642,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1611654642","product_id":100061801,"comment_content":"ä¸€æ—¦ä½ é‡åˆ°åªéœ€è¦åˆå§‹åŒ–ä¸€æ¬¡çš„åœºæ™¯ï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±åº”è¯¥æ˜¯ Once å¹¶å‘åŸè¯­ã€‚","like_count":0},{"had_liked":false,"id":272668,"user_name":"KèŒæ— æƒ¨","can_delete":false,"product_type":"c1","uid":2194764,"ip_address":"","ucode":"97A532D588FD49","user_header":"","comment_is_top":false,"comment_ctime":1610196036,"is_pvip":false,"replies":[{"id":"98836","content":"ä¸ä¼š","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1610239541,"ip_address":"","comment_id":272668,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1610196036","product_id":100061801,"comment_content":"é¸Ÿçªè€å¸ˆ,æˆ‘ä¹‹å‰å•ä¾‹æ¨¡å¼çš„æ—¶å€™è¯´double-checkingæœºåˆ¶å¯èƒ½ä¼šç”±äºcpuå¯¹ä»£ç è¯­å¥æ‰§è¡Œé¡ºåºçš„ä¼˜åŒ–å¯¼è‡´åŒæ£€æŸ¥æœºåˆ¶å¤±è´¥,æˆ‘æƒ³çŸ¥é“sync.Onceé‡Œé¢çš„åŒæ£€æŸ¥æœºåˆ¶ä¼šå‡ºç°åŒæ ·çš„æƒ…å†µå—","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":513347,"discussion_content":"ä¸ä¼š","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1610239541,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":268961,"user_name":"( ï½¥á·„á½¢ï½¥á·… )","can_delete":false,"product_type":"c1","uid":2234129,"ip_address":"","ucode":"E5F5EDEBB74C46","user_header":"https://static001.geekbang.org/account/avatar/00/22/17/11/a63acc6a.jpg","comment_is_top":false,"comment_ctime":1608450430,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1608450430","product_id":100061801,"comment_content":"1.slow ä¸ºäº†å†…è”<br>2.ä¸èƒ½å¤åˆ¶ onceé‡Œé¢æœ‰mutex è¿™ç©æ„æœ¬èº«å°±ä¸èƒ½å¤åˆ¶","like_count":0},{"had_liked":false,"id":263399,"user_name":"å‡æœŸ","can_delete":false,"product_type":"c1","uid":2226920,"ip_address":"","ucode":"CF6464E859E1F2","user_header":"https://static001.geekbang.org/account/avatar/00/21/fa/e8/45211b5a.jpg","comment_is_top":false,"comment_ctime":1606124604,"is_pvip":false,"replies":[{"id":"95570","content":"å…¶å®ƒgoroutineçœ‹åˆ°çš„å¯èƒ½æ˜¯è¿™æ ·çš„","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1606132851,"ip_address":"","comment_id":263399,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1606124604","product_id":100061801,"comment_content":"func (o *Once) doSlow(f func()) {<br>    o.m.Lock()<br>    defer o.m.Unlock()<br>    &#47;&#47; åŒæ£€æŸ¥<br>    if o.done == 0 {<br>        defer atomic.StoreUint32(&amp;o.done, 1)<br>        f()<br>    }<br>}<br><br>è€å¸ˆä½ å¥½ï¼Œæˆ‘çœ‹äº†ä¸€äº›å†…å­˜æ¨¡å‹èµ„æ–™ä¹‹åæƒ³é—®ï¼Œ<br>defer atomic.StoreUint32(&amp;o.done, 1)è¿™ä¸€è¡Œå¦‚æœæ¢æˆo.done = 1 çš„è¯æ˜¯ä¸æ˜¯ä¸èƒ½ä¿è¯<br>o.done=1 å’Œ f()çš„æ‰§è¡Œé¡ºåº ï¼Ÿ<br>","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510172,"discussion_content":"å…¶å®ƒgoroutineçœ‹åˆ°çš„å¯èƒ½æ˜¯è¿™æ ·çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606132851,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1265260,"avatar":"https://static001.geekbang.org/account/avatar/00/13/4e/6c/71020c59.jpg","nickname":"ç‹éº’","note":"","ucode":"330017C5A911B6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":369561,"discussion_content":"è¿™é‡Œä¸æ˜¯åŠ é”äº†å—ã€‚ã€‚ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯ï¼Ÿ åŠ é”äº†ä¸ºå•¥è¿˜è¦ç”¨åŸå­æ“ä½œå‘¢ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1619079185,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257565,"user_name":"æ‚¦æ‚¦","can_delete":false,"product_type":"c1","uid":1032388,"ip_address":"","ucode":"7D20EFCFC0546C","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c0/c4/3f7b5eed.jpg","comment_is_top":false,"comment_ctime":1604028735,"is_pvip":false,"replies":[{"id":"93803","content":"çœ‹goå†…å­˜æ¨¡å‹ã€‚éœ€è¦ä¿è¯happen-beforeå…³ç³»","user_name":"ä½œè€…å›å¤","user_name_real":"é¸Ÿçª","uid":"1066613","ctime":1604034602,"ip_address":"","comment_id":257565,"utype":1}],"discussion_count":3,"race_medal":0,"score":"1604028735","product_id":100061801,"comment_content":"package sync_once<br><br>import (<br>\t&quot;sync&quot;<br>)<br><br>type Once struct {<br>\tdone uint32<br>\tm    sync.Mutex<br>}<br><br>func (o *Once) Do(f func()) {<br>\t&#47;&#47;if atomic.LoadUint32(&amp;o.done) == 0 {<br>\t&#47;&#47;\to.doSlow(f)<br>\t&#47;&#47;}<br><br>\tif o.done == 0 {<br>\t\to.doSlow(f)<br>\t}<br>}<br><br>func (o *Once) doSlow(f func()) {<br>\to.m.Lock()<br>\tdefer o.m.Unlock()<br>\t&#47;&#47; åŒæ£€æŸ¥<br>\tif o.done == 0 {<br>\t\t&#47;&#47;defer atomic.StoreUint32(&amp;o.done, 1)<br>\t\tdefer func() { o.done = 1 }()<br>\t\tf()<br>\t}<br>}<br><br><br>ä¸ä¸ä½¿ç”¨atomicæœ‰ä»€ä¹ˆåŒºåˆ«","like_count":0,"discussions":[{"author":{"id":1066613,"avatar":"https://static001.geekbang.org/account/avatar/00/10/46/75/d35c7623.jpg","nickname":"é¸Ÿçª","note":"","ucode":"E49D44F9613F17","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508377,"discussion_content":"çœ‹goå†…å­˜æ¨¡å‹ã€‚éœ€è¦ä¿è¯happen-beforeå…³ç³»","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604034602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008348,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/62/dc/8876c73b.jpg","nickname":"moooofly","note":"","ucode":"4A20795C281B6F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":320159,"discussion_content":"è¿™ä¸ªåœ°æ–¹ç¡®å®æ²¡å¼„æ˜ç™½ï¼Œå¦å¤–è€å¸ˆçš„è§£é‡Šä¹Ÿä¸æ˜¯å¾ˆæ˜ç™½ï¼Œå’‹æ•´","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1604279864,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1207372,"avatar":"https://static001.geekbang.org/account/avatar/00/12/6c/4c/d87bb144.jpg","nickname":"Geek_771dd0","note":"","ucode":"FC8F77F7D75EE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":331673,"discussion_content":"é™¤äº†ä¸èƒ½ä¿è¯happens beforeï¼Œåº”è¯¥è¿˜æœ‰ç«æ€é—®é¢˜å§ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606924983,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257510,"user_name":"gitxuzan","can_delete":false,"product_type":"c1","uid":1081566,"ip_address":"","ucode":"B0E20F892DA716","user_header":"https://static001.geekbang.org/account/avatar/00/10/80/de/c6191045.jpg","comment_is_top":false,"comment_ctime":1604017882,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604017882","product_id":100061801,"comment_content":"ç¬¬äºŒä¸ªå‘å‰å‡ å¤©å°±é‡‡äº†ï¼Œä»æ•°æ®åº“æ‹‰ä¸€ä»½ç¼“å­˜ï¼Œç»“æœåˆšå¥½æ•°æ®åº“é‡å¯ï¼Œå¯¼è‡´åˆå§‹åŒ–å¤±è´¥äº†ï¼Œåé¢æ”¹æˆ == nilï¼Œæœ€å¤šæ˜¯ä¸æ˜¯é‚£ä¸€åˆ»å¹¶å‘æ‰§è¡Œäº†ï¼Œå› ä¸ºæ˜¯ç¼“å­˜æ•°æ®é—®é¢˜ä¸å¤§ï¼Œæ˜¯ä¸æ˜¯å¦‚æœå•å®ä¾‹æ²¡åŠ é”å°±ä¸èƒ½ç”¨ nilè¿™ä¹ˆåˆ¤æ–­ï¼Ÿ","like_count":0},{"had_liked":false,"id":257341,"user_name":"fsyyft","can_delete":false,"product_type":"c1","uid":1348727,"ip_address":"","ucode":"AF966553B607BB","user_header":"","comment_is_top":false,"comment_ctime":1603941489,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603941489","product_id":100061801,"comment_content":"è¿™æ ·æ‰©å±•æ˜¯å¦å¯ä»¥ï¼Ÿ<br><br>type (<br>\tOnceDo interface {<br>\t\tDoOnce(p ...interface{}) (interface{}, error)<br>\t}<br><br>\tOnceFunc func(p ...interface{}) (interface{}, error)<br>)<br><br>func (o OnceFunc) DoOnce(p ...interface{}) (interface{}, error) {<br>\treturn o(p)<br>}<br><br>type (<br>\tOnce struct {<br>\t\tdone uint32<br>\t\tm    sync.Mutex<br>\t}<br>)<br><br>func (o *Once) Do(i OnceDo, p ...interface{}) (interface{}, error) {<br>\treturn o.DoFunc(i.DoOnce, p)<br>}<br><br>func (o *Once) DoFunc(f OnceFunc, p ...interface{}) (interface{}, error) {<br>\tvar v interface{}<br>\tvar err error<br><br>\tif atomic.LoadUint32(&amp;o.done) == 0 {<br>\t\tv, err = o.doSlow(f, p)<br>\t}<br><br>\treturn v, err<br>}<br><br>func (o *Once) Done() bool {<br>\treturn atomic.LoadUint32(&amp;o.done) == 1<br>}<br><br>func (o *Once) doSlow(f OnceFunc, p ...interface{}) (interface{}, error) {<br>\to.m.Lock()<br>\tdefer o.m.Unlock()<br><br>\tvar v interface{}<br>\tvar err error<br><br>\t&#47;&#47; å·²ç»åŠ é”äº†ï¼Œå¯ä»¥ä¸éœ€è¦ä½¿ç”¨ atomic.LoadUint32(&amp;o.done) == 0 åˆ¤æ–­ã€‚<br>\tif o.done == 0 {<br>\t\tdefer func() {<br>\t\t\tif r := recover(); nil != r {<br>\t\t\t\t&#47;&#47; å¦‚æœå‡ºç° panic äº†ï¼Œrecover åï¼Œç»§ç»­å‘å¤–æŠ›å‡ºã€‚<br>\t\t\t\tpanic(r)<br>\t\t\t} else if nil == err {<br>\t\t\t\t&#47;&#47; æ²¡æœ‰å¼‚å¸¸æ—¶ï¼Œæ‰è®¾ç½®å®Œæˆã€‚<br>\t\t\t\tatomic.StoreUint32(&amp;o.done, 1)<br>\t\t\t}<br>\t\t}()<br>\t\tv, err = f(p)<br>\t}<br><br>\treturn v, err<br>}","like_count":0},{"had_liked":false,"id":257161,"user_name":"å¤§æ¼ èƒ¡èåœ","can_delete":false,"product_type":"c1","uid":1198953,"ip_address":"","ucode":"FBE51E4A13EF4F","user_header":"https://static001.geekbang.org/account/avatar/00/12/4b/69/c02eac91.jpg","comment_is_top":false,"comment_ctime":1603867717,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603867717","product_id":100061801,"comment_content":"```go<br>atomic.LoadUint32((*uint32)(unsafe.Pointer(&amp;o.Once))) == 1<br>```<br>è¿™ä¸ªæ˜¯æ€ä¹ˆåˆ¤æ–­æ‰§è¡Œå®Œçš„å‘¢","like_count":0,"discussions":[{"author":{"id":1237327,"avatar":"https://static001.geekbang.org/account/avatar/00/12/e1/4f/00476b4c.jpg","nickname":"Rememberä¹ç¦»","note":"","ucode":"97EE6E6344689F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":318990,"discussion_content":"å¯ä»¥å›å¤´çœ‹çœ‹Mutexé‚£å‡ ç¯‡ï¼Œèƒ½æ‰¾åˆ°ä½ çš„ç­”æ¡ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603896613,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257109,"user_name":"é‚£æ—¶åˆ»","can_delete":false,"product_type":"c1","uid":1150927,"ip_address":"","ucode":"B0D150856C3A4A","user_header":"https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg","comment_is_top":false,"comment_ctime":1603852736,"is_pvip":false,"discussion_count":0,"race_medal":1,"score":"1603852736","product_id":100061801,"comment_content":"slowXXXX çš„æ–¹æ³•ï¼Œä» XXXX æ–¹æ³•ä¸­å•ç‹¬æŠ½å–å‡ºæ¥ï¼Œæ˜¯ä¸ºäº†ä¼˜åŒ–ä»£ç ï¼Œæ–¹ä¾¿å†…è”","like_count":0},{"had_liked":false,"id":257103,"user_name":"ğŸ€æŸ æª¬é±¼ä¹Ÿæ˜¯é±¼","can_delete":false,"product_type":"c1","uid":2178501,"ip_address":"","ucode":"DCF033636465F3","user_header":"https://static001.geekbang.org/account/avatar/00/21/3d/c5/f43fa619.jpg","comment_is_top":false,"comment_ctime":1603852205,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1603852205","product_id":100061801,"comment_content":"å™¢å™¢ç†è§£äº†ï¼Œå‘œå‘œï¼ŒåŒé‡æ£€æµ‹æ˜¯ä¸ºäº†é¿å…é‡å¤æ‰§è¡Œf()","like_count":0,"discussions":[{"author":{"id":2735072,"avatar":"https://static001.geekbang.org/account/avatar/00/29/bb/e0/c7cd5170.jpg","nickname":"Bynow","note":"","ucode":"1E4F3ADD65CF18","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":539490,"discussion_content":"æˆ‘è§‰å¾—ä¸»è¦è¿˜æ˜¯å› ä¸ºé”å¯¹æ€§èƒ½çš„æ¶ˆè€—å¤ªå¤§ï¼Œä½ çœ‹å¯ä»¥å‡è®¾æ²¡æœ‰ç¬¬ä¸€å±‚æ£€æŸ¥ï¼Œç„¶å goroutine å¹¶å‘æ—¶éƒ½è¦å…ˆæ‹¿åˆ°é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639728608,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257042,"user_name":"æ©™å­888","can_delete":false,"product_type":"c1","uid":1447790,"ip_address":"","ucode":"8FB8A9AAE526E3","user_header":"https://static001.geekbang.org/account/avatar/00/16/17/6e/76b4aa3d.jpg","comment_is_top":false,"comment_ctime":1603843480,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1603843480","product_id":100061801,"comment_content":"æ‰“å¡ã€‚","like_count":0}]}