{"id":813350,"title":"22ï½œMySQLå­æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ä¿Šè¾¾ã€‚</p><p>è¿™ä¸€è®²ï¼Œæˆ‘ä»¬æ¥è®¨è®ºå­æŸ¥è¯¢çš„ä¸€äº›ä¼˜åŒ–ç­–ç•¥ã€‚å­æŸ¥è¯¢æ˜¯SQLå¾ˆé‡è¦çš„ä¸€ä¸ªèƒ½åŠ›ï¼Œå¹³æ—¶ä¹Ÿä¸å°‘è§ã€‚</p><h2>å­æŸ¥è¯¢çš„ä¸€ä¸ªä¾‹å­</h2><p>æ—©æœŸMySQLï¼ˆ5.5ä»¥åŠæ›´æ—©çš„ç‰ˆæœ¬ï¼‰å¯¹å­æŸ¥è¯¢çš„æ”¯æŒæ¯”è¾ƒå¼±ï¼Œä½¿ç”¨å­æŸ¥è¯¢æ—¶å®¹æ˜“é‡åˆ°æ€§èƒ½é—®é¢˜ã€‚</p><p>åœ¨13è®²çš„æ€è€ƒé¢˜ä¸­ï¼Œå°±æœ‰ä¸€ä¸ªæ‰§è¡Œäº†å‡ å¤©éƒ½æ²¡æœ‰å®Œæˆçš„SQLã€‚</p><pre><code class=\"language-plain\">Command: Query \nTime: 184551 \nState: Sending data \nInfo: select item_id, sum(sold) as sold \n      from stat_item_detail \n      where item_id in (\n           select item_id \n           from stat_item_detail \n           where gmt_create &gt;= '2019-10-05 08:59:00') \n      group by item_id\n</code></pre><p>ä¸Šé¢è¿™ä¸ªSQLè¯­å¥å¹¶ä¸å¤æ‚ï¼Œæˆ‘ä»¬æ¥æ„å»ºä¸€ä¸ªæµ‹è¯•è¡¨ï¼Œå‡†å¤‡ä¸€äº›æ•°æ®ï¼Œå¹¶åšä¸€äº›æµ‹è¯•ã€‚ä½¿ç”¨ä¸‹é¢è¿™æ®µSQLåˆ›å»ºè¡¨ï¼Œå¹¶å†™å…¥100ä¸‡è¡Œæ•°æ®ã€‚</p><pre><code class=\"language-plain\">create table stat_item_detail(\n    id int not null auto_increment,\n    item_id int not null,\n    sold int not null,\n    gmt_create datetime not null,\n    padding varchar(4000),\n    primary key(id),\n    key idx_item_id(item_id),\n    key idx_gmt_create(gmt_create)\n) engine=innodb;\n\n\ncreate view digit \n  as select 0 as a union all select 1 union all select 2 union all select 3 \n     union all select 4  union all select 5 union all select 6 \n     union all select 7  union all select 8 union all select 9 ;\n\ncreate view numbers_1m AS \nselect ((((a.a * 10 + b.a)*10 + c.a)*10 + d.a)*10+e.a)*10+f.a as n\nfrom digit a, digit b, digit c, digit d, digit e, digit f;\n\ninsert into stat_item_detail(item_id, sold, gmt_create, padding)\nselect n + 1000000 - n % 2 as item_id, \n    n % 100 - n%100%2,  \n    date_add('2024-06-01 00:00:00', interval n minute) as gmt_create,\n    rpad('x', 1000, 'abcdefg ') as padding\nfrom numbers_1m;\n</code></pre><!-- [[[read_end]]] --><p>å½“æ—¶ç”¨çš„è¿˜æ˜¯MySQL 5.1å’Œ5.5çš„ç‰ˆæœ¬ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨5.5ä¸­è¿™ä¸ªSQLçš„æ‰§è¡Œè®¡åˆ’ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select item_id, sum(sold) as sold \n      from stat_item_detail \n      where item_id in (\n           select item_id \n           from stat_item_detail \n           where Gmt_create &gt;= '2026-04-26 10:30:00') \n      group by item_id;\n\n+----+--------------------+------------------+----------------+----------------------------+-------------+---------+------+---------+-------------+\n| id | select_type        | table            | type           | possible_keys              | key         | key_len | ref  | rows    | Extra       |\n+----+--------------------+------------------+----------------+----------------------------+-------------+---------+------+---------+-------------+\n|  1 | PRIMARY            | stat_item_detail | index          | NULL                       | idx_item_id | 4       | NULL | 1000029 | Using where |\n|  2 | DEPENDENT SUBQUERY | stat_item_detail | index_subquery | idx_item_id,idx_gmt_create | idx_item_id | 4       | func |       1 | Using where |\n+----+--------------------+------------------+----------------+----------------------------+-------------+---------+------+---------+-------------+\n</code></pre><p>ä»ä¸Šé¢çš„è¿™ä¸ªæ‰§è¡Œè®¡åˆ’å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªSQLåœ¨æ‰§è¡Œæ—¶ï¼Œå…ˆå…¨é‡æ‰«æç´¢å¼•idx_item_idï¼Œæ¯å¾—åˆ°ä¸€ä¸ªitem_idåï¼Œæ‰§è¡Œç›¸å…³å­æŸ¥è¯¢ï¼ˆDEPENDENT SUBQUERYï¼‰select 1 from stat_item_detail where gmt_create &gt;= â€˜2026-04-26 10:30:00â€™ and item_id = primary.item_idã€‚å½“ä¸»æŸ¥è¯¢ä¸­è¡¨ä¸­çš„æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œå­æŸ¥è¯¢æ‰§è¡Œçš„æ¬¡æ•°ä¹Ÿä¼šå¾ˆå¤šï¼Œå› æ­¤SQLçš„æ€§èƒ½éå¸¸å·®ã€‚</p><p>åœ¨æˆ‘çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œè¿™ä¸ªSQLéœ€è¦45ç§’å·¦å³ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select item_id, sum(sold) as sold\n          from stat_item_detail\n          where item_id in (\n               select item_id\n               from stat_item_detail\n               where Gmt_create &gt;= '2026-04-26 10:30:00')\n          group by item_id;\n+---------+------+\n| item_id | sold |\n+---------+------+\n| 1999990 |  180 |\n| 1999992 |  184 |\n| 1999994 |  188 |\n| 1999996 |  192 |\n| 1999998 |  196 |\n+---------+------+\n5 rows in set (44.64 sec)\n</code></pre><p>é‚£ä¹ˆå°†INæ”¹æˆexistsåï¼Œæ˜¯å¦èƒ½æå‡æ€§èƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œæ—¶é—´å’Œä½¿ç”¨INåŸºæœ¬ä¸€æ ·ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select item_id, sum(sold) as sold\nfrom stat_item_detail t1\nwhere exists (\n    select 1\n    from stat_item_detail\n    where gmt_create &gt;= '2026-04-26 10:30:00'\n\tand item_id = t1.item_id )\ngroup by item_id;\n\n+---------+------+\n| item_id | sold |\n+---------+------+\n| 1999990 |  180 |\n| 1999992 |  184 |\n| 1999994 |  188 |\n| 1999996 |  192 |\n| 1999998 |  196 |\n+---------+------+\n5 rows in set (44.71 sec)\n</code></pre><p>å®é™…ä¸Šï¼Œä½ ä¼šå‘ç°ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨INè¿˜æ˜¯Existsï¼Œæ‰§è¡Œè®¡åˆ’éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select item_id, sum(sold) as sold\n     from stat_item_detail t1\n     where exists (\n         select 1\n         from stat_item_detail\n         where gmt_create &gt;= '2026-04-26 10:30:00'\n         and item_id = t1.item_id )\n     group by item_id;\n+----+--------------------+------------------+-------+----------------------------+-------------+---------+----------------+---------+-------------+\n| id | select_type        | table            | type  | possible_keys              | key         | key_len | ref            | rows    | Extra       |\n+----+--------------------+------------------+-------+----------------------------+-------------+---------+----------------+---------+-------------+\n|  1 | PRIMARY            | t1               | index | NULL                       | idx_item_id | 4       | NULL           | 1000029 | Using where |\n|  2 | DEPENDENT SUBQUERY | stat_item_detail | ref   | idx_item_id,idx_gmt_create | idx_item_id | 4       | rep.t1.item_id |       1 | Using where |\n+----+--------------------+------------------+-------+----------------------------+-------------+---------+----------------+---------+-------------+\n</code></pre><p>è§‚å¯Ÿè¿™ä¸ªSQLæœ€ç»ˆè¿”å›çš„æ•°æ®å®é™…ä¸Šå¹¶ä¸å¤šï¼Œå› ä¸ºå­æŸ¥è¯¢select item_id from stat_item_detail where gmt_create &gt;= '2026-04-26 10:30:00â€™åªéœ€è¦è¿”å›æœ€è¿‘å†™å…¥çš„æ•°æ®ã€‚</p><p>é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥å…ˆæ‰§è¡Œå­æŸ¥è¯¢å‘¢ï¼Ÿæˆ‘ä»¬å°è¯•æ”¹å†™ä¸€ä¸‹SQLã€‚æ”¹å†™åï¼ŒæŸ¥è¯¢çš„æ•ˆç‡æé«˜äº†å¾ˆå¤šï¼Œä½†æ˜¯æŸ¥è¯¢çš„ç»“æœæœ‰ç‚¹é—®é¢˜äº†ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select t1.item_id, sum(t1.sold) as sold\n     from stat_item_detail t1, stat_item_detail t2\n     where t1.item_id = t2.item_id\n     and t2.gmt_create &gt;= '2026-04-26 10:30:00'\n     group by t1.item_id;\n+---------+------+\n| item_id | sold |\n+---------+------+\n| 1999990 |  360 |\n| 1999992 |  368 |\n| 1999994 |  376 |\n| 1999996 |  384 |\n| 1999998 |  392 |\n+---------+------+\n5 rows in set (0.00 sec)\n</code></pre><p>é—®é¢˜å‡ºåœ¨å“ªé‡Œå‘¢ï¼Ÿå› ä¸ºå­æŸ¥è¯¢ä¸­ï¼Œitem_idä¸æ˜¯å”¯ä¸€çš„ã€‚æ”¹æˆæ™®é€šçš„è¡¨è¿æ¥åï¼Œæ•°æ®æœ‰é‡å¤ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å¯¹æ•°æ®åšä¸€ä¸ªå»é‡ã€‚</p><pre><code class=\"language-plain\">select item_id, sum(sold) from (\n    select distinct t1.item_id, t1.sold as sold, t2.sold as sold2\n    from stat_item_detail t1, stat_item_detail t2\n    where t1.item_id = t2.item_id\n    and t2.gmt_create &gt;= '2026-04-26 10:30:00'\n) t group by item_id;\n+---------+-----------+\n| item_id | sum(sold) |\n+---------+-----------+\n| 1999990 |        90 |\n| 1999992 |        92 |\n| 1999994 |        94 |\n| 1999996 |        96 |\n| 1999998 |        98 |\n+---------+-----------+\n5 rows in set (0.00 sec)\n</code></pre><p>ä½†æ˜¯ï¼Œè¿™æ ·å»é‡åï¼Œæ•°æ®è¿˜æ˜¯ä¸å¯¹ã€‚å› ä¸ºä¸»è¡¨ä¸­item_idæ˜¯å…è®¸é‡å¤çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹å­æŸ¥è¯¢ä¸­çš„item_idå»é‡ã€‚å°†SQLæ”¹æˆä¸‹é¢è¿™ä¸ªæ ·å­ï¼ŒæŸ¥è¯¢ç»“æœç»ˆäºæ­£ç¡®äº†ï¼ŒSQLçš„æ•ˆç‡ä¹Ÿè¿˜ä¸é”™ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select t1.item_id, sum(t1.sold) as sold\nfrom stat_item_detail t1, (\n  select distinct item_id \n  from stat_item_detail t2\n  where t2.gmt_create &gt;= '2026-04-26 10:30:00') t22\nwhere t1.item_id = t22.item_id\ngroup by t1.item_id;\n+---------+------+\n| item_id | sold |\n+---------+------+\n| 1999990 |  180 |\n| 1999992 |  184 |\n| 1999994 |  188 |\n| 1999996 |  192 |\n| 1999998 |  196 |\n+---------+------+\n5 rows in set (0.00 sec)\n</code></pre><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹æ³•æ¥å»é‡ï¼Œä¹Ÿå°±æ˜¯æŒ‰ä¸»è¡¨çš„ä¸»é”®å­—æ®µæ¥å»é‡ã€‚</p><pre><code class=\"language-plain\">select item_id, sum(sold) from (\n    select distinct t1.id,  t1.item_id, t1.sold as sold\n    from stat_item_detail t1, stat_item_detail t2\n    where t1.item_id = t2.item_id\n    and t2.gmt_create &gt;= '2026-04-26 10:30:00'\n) t group by item_id;\n\n+---------+-----------+\n| item_id | sum(sold) |\n+---------+-----------+\n| 1999990 |       180 |\n| 1999992 |       184 |\n| 1999994 |       188 |\n| 1999996 |       192 |\n| 1999998 |       196 |\n+---------+-----------+\n5 rows in set (0.00 sec)\n</code></pre><h2>MySQLçš„åŠè¿æ¥ï¼ˆSEMIJOINï¼‰ä¼˜åŒ–</h2><p>MySQL 5.6å¼€å§‹å¼•å…¥äº†åŠè¿æ¥è½¬æ¢ï¼Œå¯¹äºå‰é¢ä¾‹å­ä¸­çš„SQLï¼Œä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨è¿›è¡ŒæŸ¥è¯¢è½¬æ¢ï¼Œä¸éœ€è¦å†æ‰‹åŠ¨æ”¹å†™SQLäº†ã€‚åœ¨MySQL 5.6å’Œ5.7ä¸­ï¼Œè¿˜ä¸ä¼šå¯¹existsåšåŠè¿æ¥ä¼˜åŒ–ã€‚ä»MySQL 8.0.16å¼€å§‹ï¼Œä¼˜åŒ–å™¨å¯¹existså­æŸ¥è¯¢ä¹Ÿä¼šè¿›è¡ŒåŠè¿æ¥è½¬æ¢ã€‚</p><p>åœ¨8.0çš„ç¯å¢ƒä¸­æ‰§è¡Œè¿™ä¸ªSQLï¼ŒMySQLè‡ªåŠ¨æŠŠæŸ¥è¯¢è½¬æ¢æˆäº†åŠè¿æ¥ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select item_id, sum(sold) as sold \n      from stat_item_detail \n      where item_id in (\n           select item_id \n           from stat_item_detail \n           where Gmt_create &gt;= '2026-04-26 10:30:00') \n      group by item_id;\n\n+----+--------------+------------------+-------+----------------------------+----------------+---------+---------------------+------+----------+-----------------------+\n| id | select_type  | table            | type  | possible_keys              | key            | key_len | ref                 | rows | filtered | Extra                 |\n+----+--------------+------------------+-------+----------------------------+----------------+---------+---------------------+------+----------+-----------------------+\n|  1 | SIMPLE       | &lt;subquery2&gt;      | ALL   | NULL                       | NULL           | NULL    | NULL                | NULL |   100.00 | Using temporary       |\n|  1 | SIMPLE       | stat_item_detail | ref   | idx_item_id                | idx_item_id    | 4       | &lt;subquery2&gt;.item_id |    1 |   100.00 | NULL                  |\n|  2 | MATERIALIZED | stat_item_detail | range | idx_item_id,idx_gmt_create | idx_gmt_create | 5       | NULL                |   10 |   100.00 | Using index condition |\n+----+--------------+------------------+-------+----------------------------+----------------+---------+---------------------+------+----------+-----------------------+\n</code></pre><p>ä¸Šé¢çš„è¿™ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œå®é™…ä¸Šå’Œæˆ‘ä»¬çš„ç¬¬ä¸€ç§æ‰‹åŠ¨æ”¹å†™çš„æ–¹å¼ç±»ä¼¼ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select t1.item_id, sum(t1.sold) as sold\nfrom stat_item_detail t1, (\n  select distinct item_id \n  from stat_item_detail t2\n  where t2.gmt_create &gt;= '2026-04-26 10:30:00') t22\nwhere t1.item_id = t22.item_id\ngroup by t1.item_id;\n\n+----+-------------+------------+-------+----------------------------+----------------+---------+-------------+------+----------+----------------------------------------+\n| id | select_type | table      | type  | possible_keys              | key            | key_len | ref         | rows | filtered | Extra                                  |\n+----+-------------+------------+-------+----------------------------+----------------+---------+-------------+------+----------+----------------------------------------+\n|  1 | PRIMARY     | &lt;derived2&gt; | ALL   | NULL                       | NULL           | NULL    | NULL        |   10 |   100.00 | Using temporary                        |\n|  1 | PRIMARY     | t1         | ref   | idx_item_id                | idx_item_id    | 4       | t22.item_id |    1 |   100.00 | NULL                                   |\n|  2 | DERIVED     | t2         | range | idx_item_id,idx_gmt_create | idx_gmt_create | 5       | NULL        |   10 |   100.00 | Using index condition; Using temporary |\n+----+-------------+------------+-------+----------------------------+----------------+---------+-------------+------+----------+----------------------------------------+\n</code></pre><p>å½“ç„¶ï¼Œèƒ½è¿›è¡ŒåŠè¿æ¥è½¬æ¢çš„SQLï¼Œéœ€è¦æ»¡è¶³ä¸€äº›åŸºæœ¬çš„æ¡ä»¶ã€‚</p><ol>\n<li>\n<p>å­æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨UNIONã€‚</p>\n</li>\n<li>\n<p>å­æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨Havingã€‚</p>\n</li>\n<li>\n<p>å­æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨èšåˆå‡½æ•°ï¼ˆå¦‚avgã€sumç­‰ï¼‰ã€‚</p>\n</li>\n<li>\n<p>å­æŸ¥è¯¢ä¸­ä¸å…è®¸ä½¿ç”¨limitã€‚</p>\n</li>\n<li>\n<p>ä¸»æŸ¥è¯¢å’Œå­æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨STRAIGHT_JOINã€‚</p>\n</li>\n<li>\n<p>ä¸»æŸ¥è¯¢ä¸­è¡¨çš„æ•°é‡å’Œå­æŸ¥è¯¢ä¸­è¡¨çš„æ•°é‡ç›¸åŠ ä¸è¶…è¿‡MySQLå…è®¸çš„æœ€å¤§è¡¨è¿æ¥æ•°é‡ã€‚MySQLæœ€å¤šå…è®¸61è¡¨çš„è¿æ¥ã€‚</p>\n</li>\n</ol><p>å­æŸ¥è¯¢ä¸­å¯ä»¥ä½¿ç”¨distinctã€order byã€group byè¿™äº›å…³é”®è¯ï¼Œå®é™…ä¸Šå­æŸ¥è¯¢ä¸­çš„è¿™äº›å…³é”®è¯ä¼šè¢«ä¼˜åŒ–å™¨å¿½ç•¥æ‰ï¼ˆå‰ææ˜¯æ²¡æœ‰åŒæ—¶ä½¿ç”¨äº†èšåˆå‡½æ•°ï¼‰ã€‚</p><p>å¦‚æœå­æŸ¥è¯¢æ»¡è¶³äº†ä¸Šé¢è¿™äº›æ¡ä»¶ï¼Œä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨æŸ¥è¯¢è½¬æ¢ï¼Œå°†å­æŸ¥è¯¢è½¬æ¢ä¸ºåŠè¿æ¥ã€‚ä¼˜åŒ–å™¨ä¼šæ ¹æ®è¯­å¥çš„å…·ä½“æƒ…å†µï¼Œé€‰æ‹©åˆé€‚ç­–ç•¥æ¥æ‰§è¡ŒåŠè¿æ¥ã€‚è¿™äº›ç­–ç•¥åˆ†åˆ«æ˜¯pulloutã€duplicate weedoutã€first matchã€loose scanã€materializationã€‚</p><ul>\n<li>\n<p>Pulloutï¼šç›´æ¥å°†å­æŸ¥è¯¢æåˆ°å¤–å±‚ï¼Œæ”¹å†™æˆè¡¨è¿æ¥ã€‚</p>\n</li>\n<li>\n<p>Duplicate weedoutï¼šå¦‚æœå­æŸ¥è¯¢ä¸­çš„æ•°æ®å¯èƒ½å­˜åœ¨é‡å¤ï¼ŒMySQLä¼šå¯¹ç»“æœæ•°æ®è¿›è¡Œå»é‡ã€‚</p>\n</li>\n<li>\n<p>First Matchï¼šæ‰§è¡Œè¡¨è¿æ¥æ—¶ï¼Œå¯¹äºé©±åŠ¨è¡¨ä¸­çš„æ¯ä¸€è¡Œè®°å½•ï¼Œåªéœ€è¦åŒ¹é…å­æŸ¥è¯¢çš„ç¬¬ä¸€æ¡è®°å½•å°±è¿”å›ã€‚</p>\n</li>\n<li>\n<p>Loose Scanï¼šåˆ©ç”¨å­æŸ¥è¯¢ä¸­ç´¢å¼•çš„æœ‰åºæ€§ï¼Œè·å–å…³è”æ¡ä»¶çš„å”¯ä¸€å€¼ã€‚</p>\n</li>\n<li>\n<p>Materializationï¼šå°†å­æŸ¥è¯¢çš„ç»“æœå­˜å‚¨åœ¨ä¸´æ—¶è¡¨ï¼Œä¸´æ—¶è¡¨å†å’Œçˆ¶è¡¨è¿›è¡Œå…³è”ã€‚</p>\n</li>\n</ul><p>å‚æ•°optimizer_switchä¸­æœ‰ä¸€äº›é€‰é¡¹ç”¨æ¥æ§åˆ¶æ˜¯å¦å¼€å¯æŸä¸ªåŠè¿æ¥ç­–ç•¥ï¼Œæˆ‘æ•´ç†æˆäº†ä¸‹é¢è¿™ä¸ªè¡¨æ ¼ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9d/50/9d5e62743caf6f6724f37dcda5218050.png?wh=1920x879\" alt=\"å›¾ç‰‡\"></p><p>ä¼˜åŒ–å™¨ä¼šè®¡ç®—è¿™äº›åŠè¿æ¥ç­–ç•¥çš„æˆæœ¬ï¼Œä»ä¸­é€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ç”¨ä¸€äº›å…·ä½“çš„ä¾‹å­æ¥è¯´æ˜è¿™äº›æ‰§è¡Œç­–ç•¥çš„ä½¿ç”¨åœºæ™¯ã€‚</p><p>å…ˆæ ¹æ®ä¸‹é¢çš„SQLï¼Œåˆ›å»ºå‡ ä¸ªæµ‹è¯•è¡¨ï¼Œå‡†å¤‡ä¸€äº›æµ‹è¯•æ•°æ®ã€‚</p><pre><code class=\"language-plain\">CREATE TABLE t_parent (\n  id int not null auto_increment,\n  a int,\n  b int ,\n  c int ,\n  padding varchar(2000),\n  primary key(id),\n  KEY idx_a (a)\n) ENGINE=InnoDB;\n\nCREATE TABLE t_subq (\n  id int not null auto_increment,\n  a int ,\n  b int ,\n  c int ,\n  d int ,\n  padding varchar(2000),\n  primary key(id),\n  UNIQUE KEY uk_cb (c,b),\n  KEY idx_abc (a,b,c)\n) ENGINE=InnoDB;\n\ninsert into t_parent(a,b,c) values \n(1,1,1),(2,2,2),(3,3,3),(4,4,4),(5,5,5),(null,0,0),(2,2,2);\n\ninsert into t_subq (a,b,c,d) values\n(1,1,1,1),(2,2,2,2),(3,3,3,3),(2,4,4,2);\n</code></pre><h3>Pullout</h3><p>å¦‚æœå­æŸ¥è¯¢ä¸­ï¼Œè¡¨ä¸Šçš„å”¯ä¸€ç´¢å¼•æˆ–ä¸»é”®èƒ½ä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ï¼Œå°±å¯ä»¥ç›´æ¥å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºè¡¨è¿æ¥ï¼Œä¸ç”¨åšå…¶ä»–é¢å¤–çš„å¤„ç†ï¼Œè¿™ç§è½¬æ¢å°±å«åšPulloutï¼Œä¸‹é¢çš„æŸ¥è¯¢æ¼”ç¤ºäº†è¿™ç§æƒ…å†µã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_parent where a in (\n    select b from t_subq where c = 1);\n\n+----+-------------+----------+------+---------------+-------+---------+--------------+------+----------+--------------------------+\n| id | select_type | table    | type | possible_keys | key   | key_len | ref          | rows | filtered | Extra                    |\n+----+-------------+----------+------+---------------+-------+---------+--------------+------+----------+--------------------------+\n|  1 | SIMPLE      | t_subq   | ref  | uk_cb         | uk_cb | 5       | const        |    1 |   100.00 | Using where; Using index |\n|  1 | SIMPLE      | t_parent | ref  | idx_a         | idx_a | 5       | rep.t_subq.b |    1 |   100.00 | NULL                     |\n+----+-------------+----------+------+---------------+-------+---------+--------------+------+----------+--------------------------+\n</code></pre><p>ç”±äºå­æŸ¥è¯¢å†…çš„tyè¡¨ä¸Šæœ‰å”¯ä¸€ç´¢å¼•uk_cb(c,b)ï¼Œåœ¨c=1çš„æƒ…å†µä¸‹ï¼Œbæ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥ç›´æ¥å°†å­æŸ¥è¯¢è½¬æ¢æˆäº†è¡¨è¿æ¥ã€‚</p><p>æ‰§è¡Œshow warningsåï¼Œå¯ä»¥çœ‹åˆ°SQLå·²ç»è¢«æ”¹å†™æˆäº†æ™®é€šçš„è¡¨è¿æ¥ã€‚</p><pre><code class=\"language-plain\">mysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ select `rep`.`t_parent`.`id` AS `id`,`rep`.`t_parent`.`a` AS `a`,`rep`.`t_parent`.`b` AS `b`,`rep`.`t_parent`.`c` AS `c`,`rep`.`t_parent`.`padding` AS `padding` from `rep`.`t_subq` join `rep`.`t_parent` where ((`rep`.`t_parent`.`a` = `rep`.`t_subq`.`b`) and (`rep`.`t_subq`.`c` = 1))\n</code></pre><h3>Duplicate Weedout</h3><p>å¦‚æœå­æŸ¥è¯¢ä¸­çš„æ•°æ®æœ‰å¯èƒ½å‡ºç°é‡å¤å€¼ï¼Œé‚£ä¹ˆå°†å­æŸ¥è¯¢è½¬æ¢ä¸ºè¡¨è¿æ¥æ—¶ï¼Œéœ€è¦å¯¹å­æŸ¥è¯¢çš„æ•°æ®è¿›è¡Œå»é‡ï¼Œè¿™ç§æƒ…å†µä¸ºDuplicate Weedoutï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-plain\">mysql&gt;  explain  select * from t_parent where a in (\n  select d from t_subq where a in (1,3));\n+----+-------------+----------+-------+---------------+---------+---------+--------------+------+----------+-----------------------------------------------------+\n| id | select_type | table    | type  | possible_keys | key     | key_len | ref          | rows | filtered | Extra                                               |\n+----+-------------+----------+-------+---------------+---------+---------+--------------+------+----------+-----------------------------------------------------+\n|  1 | SIMPLE      | t_subq   | range | idx_abc       | idx_abc | 5       | NULL         |    2 |   100.00 | Using index condition; Using where; Start temporary |\n|  1 | SIMPLE      | t_parent | ref   | idx_a         | idx_a   | 5       | rep.t_subq.d |    1 |   100.00 | End temporary                                       |\n+----+-------------+----------+-------+---------------+---------+---------+--------------+------+----------+-----------------------------------------------------+\n</code></pre><p>æ³¨æ„åˆ°æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œselect_typeåˆ—æ˜¾ç¤ºSIMPLEï¼Œè¯´æ˜å­æŸ¥è¯¢å·²ç»è¢«è½¬æ¢æˆè¡¨è¿æ¥äº†ã€‚Extraåˆ—ä¸­çš„Start temporaryå’ŒEnd temporaryè¯´æ˜ä½¿ç”¨äº†ä¸´æ—¶è¡¨æ¥å¯¹æ•°æ®è¿›è¡Œå»é‡ã€‚è¿™é‡Œä¼šä½¿ç”¨t_parentè¡¨çš„ä¸»é”®å­—æ®µæ¥å»é‡ã€‚</p><p>æ‰§è¡Œshow warningså¯ä»¥çœ‹åˆ°è½¬æ¢åçš„æŸ¥è¯¢ä½¿ç”¨äº†semi joinã€‚</p><pre><code class=\"language-plain\">mysql&gt; show warnings\\G\n*************************** 1. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ select `rep`.`t_parent`.`id` AS `id`,`rep`.`t_parent`.`a` AS `a`,`rep`.`t_parent`.`b` AS `b`,`rep`.`t_parent`.`c` AS `c`,`rep`.`t_parent`.`padding` AS `padding` from `rep`.`t_parent` semi join (`rep`.`t_subq`) where ((`rep`.`t_parent`.`a` = `rep`.`t_subq`.`d`) and (`rep`.`t_subq`.`a` in (1,3)))\n1 row in set (0.00 sec)\n</code></pre><h3>First match</h3><p>å­æŸ¥è¯¢è½¬æ¢ä¸ºåŠè¿æ¥åï¼Œå¦‚æœä¼˜åŒ–å™¨é€‰æ‹©ä»¥åŸå…ˆçš„ä¸»æŸ¥è¯¢ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè¿˜å¯ä»¥ä½¿ç”¨First matchç­–ç•¥ã€‚First matchçš„æ„æ€æ˜¯ï¼Œå¯¹äºé©±åŠ¨è¡¨çš„æ¯ä¸€è¡Œæ•°æ®ï¼Œå…³è”å­æŸ¥è¯¢ä¸­çš„è¡¨æ—¶ï¼Œåªå…³è”åˆ°1è¡Œæ•°æ®å°±è¿”å›ï¼Œè¿™æ ·å°±ä¸éœ€è¦å¯¹å­æŸ¥è¯¢ä¸­çš„æ•°æ®è¿›è¡Œå»é‡å¤„ç†äº†ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨First matchçš„ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_parent where c in (select c from t_subq);\n+----+-------------+----------+------+---------------+-------+---------+----------------+------+----------+-----------------------------------+\n| id | select_type | table    | type | possible_keys | key   | key_len | ref            | rows | filtered | Extra                             |\n+----+-------------+----------+------+---------------+-------+---------+----------------+------+----------+-----------------------------------+\n|  1 | SIMPLE      | t_parent | ALL  | NULL          | NULL  | NULL    | NULL           |    7 |   100.00 | Using where                       |\n|  1 | SIMPLE      | t_subq   | ref  | uk_cb         | uk_cb | 5       | rep.t_parent.c |    1 |   100.00 | Using index; FirstMatch(t_parent) |\n+----+-------------+----------+------+---------------+-------+---------+----------------+------+----------+-----------------------------------+\n</code></pre><p>æ³¨æ„åˆ°ä¸Šé¢çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼ŒExtraåˆ—æ˜¾ç¤ºçš„FirstMatch(t_parent)ã€‚First Matchå’ŒDuplicate Weedoutçš„ä¸€ä¸ªä¸»è¦çš„åŒºåˆ«æ˜¯<strong>è¡¨è¿æ¥çš„é¡ºåºä¸ä¸€æ ·</strong>ã€‚å¦‚æœä»¥å­æŸ¥è¯¢ä¸­çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œå°±æ— æ³•ä½¿ç”¨First Matchç­–ç•¥äº†ã€‚</p><h3>LooseScan</h3><p>LooseScanç­–ç•¥ä¼šåˆ©ç”¨å­æŸ¥è¯¢ä¸­è¡¨ä¸Šçš„ç´¢å¼•æ¥è·å–åˆ°ä¸€ç»„å”¯ä¸€çš„å€¼ï¼Œå†è·Ÿä¸»æŸ¥è¯¢ä¸­çš„è¡¨è¿›è¡Œè¿æ¥ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨LooseScançš„ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-plain\">mysql&gt; explain  select * from t_parent where a in (select a from t_subq);\n+----+-------------+----------+-------+---------------+---------+---------+--------------+------+----------+-------------------------------------+\n| id | select_type | table    | type  | possible_keys | key     | key_len | ref          | rows | filtered | Extra                               |\n+----+-------------+----------+-------+---------------+---------+---------+--------------+------+----------+-------------------------------------+\n|  1 | SIMPLE      | t_subq   | index | idx_abc       | idx_abc | 15      | NULL         |    4 |   100.00 | Using where; Using index; LooseScan |\n|  1 | SIMPLE      | t_parent | ref   | idx_a         | idx_a   | 5       | rep.t_subq.a |    1 |   100.00 | NULL                                |\n+----+-------------+----------+-------+---------------+---------+---------+--------------+------+----------+-------------------------------------+\n</code></pre><p>æ³¨æ„åˆ°ä¸Šé¢çš„æ‰§è¡Œè®¡åˆ’Extraä¸­æ˜¾ç¤ºçš„LooseScanï¼Œä½¿ç”¨äº†t_subqè¡¨ä¸Šçš„ç´¢å¼•idx_abcè·å–åˆ°açš„ä¸€ç³»åˆ—å”¯ä¸€å€¼ï¼Œè¿™ç§æ–¹å¼å’Œç´¢å¼•è·³è·ƒæ‰«æï¼ˆindex skip scanï¼‰æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ã€‚ä½¿ç”¨LooseScanç­–ç•¥æ—¶ï¼Œä»¥å­æŸ¥è¯¢ä¸­çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ã€‚</p><h3>Materialize with deduplication</h3><p>åœ¨Materialize with deduplicationè¿™ç§ç­–ç•¥ä¸‹ï¼Œå­æŸ¥è¯¢è¢«ç‰©åŒ–ï¼ˆMaterializeï¼‰æˆä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œç”Ÿæˆä¸´æ—¶è¡¨çš„æ—¶å€™ä¼šåŒæ—¶å¯¹æ•°æ®è¿›è¡Œå»é‡ã€‚å»é‡åçš„ä¸´æ—¶è¡¨å†å’ŒåŸå…ˆä¸»æŸ¥è¯¢ä¸­çš„è¡¨è¿›è¡Œè¿æ¥ã€‚ä¸‹é¢å°±æ˜¯ä½¿ç”¨è¿™ç§ç­–ç•¥çš„ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class=\"language-plain\">mysql&gt; explain  select * from t_parent where a in (select d from t_subq where a in (2));\n+----+--------------+-------------+------+---------------+---------+---------+---------------+------+----------+-------------+\n| id | select_type  | table       | type | possible_keys | key     | key_len | ref           | rows | filtered | Extra       |\n+----+--------------+-------------+------+---------------+---------+---------+---------------+------+----------+-------------+\n|  1 | SIMPLE       | &lt;subquery2&gt; | ALL  | NULL          | NULL    | NULL    | NULL          | NULL |   100.00 | Using where |\n|  1 | SIMPLE       | t_parent    | ref  | idx_a         | idx_a   | 5       | &lt;subquery2&gt;.d |    1 |   100.00 | NULL        |\n|  2 | MATERIALIZED | t_subq      | ref  | idx_abc       | idx_abc | 5       | const         |    2 |   100.00 | NULL        |\n+----+--------------+-------------+------+---------------+---------+---------+---------------+------+----------+-------------+\n</code></pre><p>æ³¨æ„åˆ°ä¸Šé¢æ‰§è¡Œè®¡åˆ’ä¸­IDä¸º2çš„æŸ¥è¯¢å•å…ƒï¼Œselect_typeä¸ºMATERIALIZEDï¼Œè¿™æ˜¯åŸºäºå­æŸ¥è¯¢ä¸­çš„è¡¨t_subqäº§ç”Ÿçš„ä¸´æ—¶è¡¨ã€‚</p><h3>åŠè¿æ¥ç­–ç•¥çš„æ‰§è¡Œæˆæœ¬</h3><p>ä½¿ç”¨Pulloutç­–ç•¥æ—¶ï¼Œå­æŸ¥è¯¢ä¸­éœ€è¦æœ‰ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æ¥ä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ã€‚ä½¿ç”¨LooseScanç­–ç•¥æ—¶ï¼Œä¹Ÿéœ€è¦å­æŸ¥è¯¢ä¸­æœ‰ç´¢å¼•ã€‚å…¶ä»–å‡ ç§ç­–ç•¥ï¼Œå¯¹å­æŸ¥è¯¢ä¸­çš„ç´¢å¼•æ²¡æœ‰è¦æ±‚ã€‚</p><p>é‚£ä¹ˆåœ¨æ‰§è¡Œä¸€ä¸ªå…·ä½“çš„å­æŸ¥è¯¢æ—¶ï¼Œä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆæ¥é€‰æ‹©åŠè¿æ¥ç­–ç•¥çš„å‘¢ï¼Ÿå®é™…ä¸Šåœ¨è¿™é‡Œï¼Œä¼˜åŒ–å™¨ä¸»è¦ä¹Ÿæ˜¯åŸºäºæˆæœ¬æ¥é€‰æ‹©æ‰§è¡Œç­–ç•¥ã€‚æ¯ä¸€ç§åŠè¿æ¥è½¬æ¢ç­–ç•¥éƒ½æœ‰ç›¸åº”çš„æˆæœ¬è®¡ç®—æ–¹å¼ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼˜åŒ–å™¨è·Ÿè¸ªï¼Œæ¥çœ‹ä¸€ä¸‹å­æŸ¥è¯¢ç­–ç•¥çš„é€‰æ‹©è¿‡ç¨‹ã€‚</p><pre><code class=\"language-plain\">mysql&gt; set optimizer_trace='enabled=on';\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; explain select item_id, sum(sold) as sold\n           from stat_item_detail\n           where item_id in (\n                select item_id\n                from stat_item_detail\n                where gmt_create &gt;= '2026-04-26 10:30:00')\n           group by item_id;\n\n+----+--------------+------------------+-------+----------------------------+----------------+---------+---------------------+------+----------+-----------------------+\n| id | select_type  | table            | type  | possible_keys              | key            | key_len | ref                 | rows | filtered | Extra                 |\n+----+--------------+------------------+-------+----------------------------+----------------+---------+---------------------+------+----------+-----------------------+\n|  1 | SIMPLE       | &lt;subquery2&gt;      | ALL   | NULL                       | NULL           | NULL    | NULL                | NULL |   100.00 | Using temporary       |\n|  1 | SIMPLE       | stat_item_detail | ref   | idx_item_id                | idx_item_id    | 4       | &lt;subquery2&gt;.item_id |    1 |   100.00 | NULL                  |\n|  2 | MATERIALIZED | stat_item_detail | range | idx_item_id,idx_gmt_create | idx_gmt_create | 5       | NULL                |   10 |   100.00 | Using index condition |\n+----+--------------+------------------+-------+----------------------------+----------------+---------+---------------------+------+----------+-----------------------+\n    \nmysql&gt; select * from information_schema.optimizer_trace\\G\n</code></pre><ul>\n<li>LooseScan</li>\n</ul><p>å­æŸ¥è¯¢ä¸­æ²¡æœ‰åˆé€‚çš„ç´¢å¼•å¯ä»¥ç”¨æ¥æ‰§è¡ŒLooseScanç­–ç•¥ã€‚</p><ul>\n<li>MaterializeScançš„æˆæœ¬</li>\n</ul><p>MaterializeScançš„æˆæœ¬ä¸»è¦æ˜¯åˆ›å»ºä¸´æ—¶è¡¨çš„æˆæœ¬ï¼Œä»¥åŠå¾€ä¸´æ—¶è¡¨å†™å…¥æ•°æ®çš„æˆæœ¬ã€‚éœ€è¦å†™å…¥ä¸´æ—¶è¡¨çš„è®°å½•é€šè¿‡è®¿é—®ç´¢å¼•idx_gmt_createå¾—åˆ°ï¼Œéœ€è¦å†™å…¥10è¡Œè®°å½•ã€‚</p><pre><code class=\"language-plain\">\"execution_plan_for_potential_materialization\": {\n  \"steps\": [\n    {\n      \"considered_execution_plans\": [\n        {\n          \"plan_prefix\": [\n          ],\n          \"table\": \"`stat_item_detail`\",\n          \"best_access_path\": {\n            \"considered_access_paths\": [\n              {\n                \"access_type\": \"ref\",\n                \"index\": \"idx_item_id\",\n                \"usable\": false,\n                \"chosen\": false\n              },\n              {\n                \"rows_to_scan\": 10,\n                \"filtering_effect\": [\n                ],\n                \"final_filtering_effect\": 1,\n                \"access_type\": \"range\",\n                \"range_details\": {\n                  \"used_index\": \"idx_gmt_create\"\n                },\n                \"resulting_rows\": 10,\n                \"cost\": 12.5992,\n                \"chosen\": true\n              }\n            ]\n          },\n          \"condition_filtering_pct\": 100,\n          \"rows_for_plan\": 10,\n          \"cost_for_plan\": 12.5992,\n          \"sort_cost\": 10,\n          \"new_cost_for_plan\": 22.5992,\n          \"chosen\": true\n        }\n      ]\n    }\n  ]\n}\n</code></pre><p>å†å…³è”ä¸»è¡¨ï¼Œå¾—åˆ°æ‰§è¡Œè®¡åˆ’çš„æ€»æˆæœ¬ä¸º35.6627ã€‚</p><pre><code class=\"language-plain\">{\n  \"strategy\": \"MaterializeScan\",\n  \"recalculate_access_paths_and_cost\": {\n    \"tables\": [\n      {\n        \"table\": \"`stat_item_detail`\",\n        \"best_access_path\": {\n          \"considered_access_paths\": [\n            {\n              \"access_type\": \"ref\",\n              \"index\": \"idx_item_id\",\n              \"rows\": 1.88804,\n              \"cost\": 20.0634,\n              \"chosen\": true\n            },\n            {\n              \"access_type\": \"scan\",\n              \"cost\": 159249,\n              \"rows\": 903690,\n              \"chosen\": false,\n              \"cause\": \"cost\"\n            }\n          ]\n        }\n      }\n    ]\n  },\n  \"cost\": 35.6627,\n  \"rows\": 1.88804,\n  \"duplicate_tables_left\": true,\n  \"chosen\": true\n}\n</code></pre><ul>\n<li>DuplicatesWeedoutçš„æˆæœ¬</li>\n</ul><p>DuplicatesWeedoutçš„æˆæœ¬ï¼Œç”±æ­£å¸¸çš„è¡¨è¿æ¥æˆæœ¬å’Œå»é‡æˆæœ¬ç»„æˆï¼Œå»é‡çš„æˆæœ¬ä¸ºåˆ›å»ºä¸´æ—¶è¡¨çš„æˆæœ¬åŠ ä¸Šå¾€ä¸´æ—¶è¡¨ä¸­å†™å…¥æ•°æ®çš„æˆæœ¬ã€‚ä»ä¼˜åŒ–å™¨è·Ÿè¸ªå¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨DuplicatesWeedoutç­–ç•¥æ—¶ï¼ŒæŸ¥è¯¢çš„æ€»æˆæœ¬ä¸º37.4387ï¼Œè¶…è¿‡äº†Materializeçš„æˆæœ¬ï¼Œå› æ­¤æ²¡æœ‰é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚</p><pre><code class=\"language-plain\">{\n  \"strategy\": \"DuplicatesWeedout\",\n  \"cost\": 37.4387,\n  \"rows\": 18.8804,\n  \"duplicate_tables_left\": false,\n  \"chosen\": false\n}\n</code></pre><ul>\n<li>ä¸»æŸ¥è¯¢ä½œä¸ºé©±åŠ¨è¡¨çš„æˆæœ¬</li>\n</ul><p>ä½¿ç”¨FirstMatchæ—¶ï¼Œä»¥åŸå…ˆçš„ä¸»æŸ¥è¯¢ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè®¿é—®ä¸»è¡¨æ—¶ï¼Œéœ€è¦å…¨è¡¨æ‰«æï¼Œæˆæœ¬è¶…è¿‡äº†ä¹‹å‰Materializeçš„æˆæœ¬ï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰é€‰æ‹©è¿™ä¸ªæ‰§è¡Œè®¡åˆ’ã€‚</p><pre><code class=\"language-plain\"> {\n  \"plan_prefix\": [\n  ],\n  \"table\": \"`stat_item_detail`\",\n  \"best_access_path\": {\n    \"considered_access_paths\": [\n      {\n        \"access_type\": \"ref\",\n        \"index\": \"idx_item_id\",\n        \"usable\": false,\n        \"chosen\": false\n      },\n      {\n        \"rows_to_scan\": 903690,\n        \"filtering_effect\": [\n        ],\n        \"final_filtering_effect\": 1,\n        \"access_type\": \"scan\",\n        \"resulting_rows\": 903690,\n        \"cost\": 159249,\n        \"chosen\": true,\n        \"use_tmp_table\": true\n      }\n    ]\n  },\n  \"condition_filtering_pct\": 100,\n  \"rows_for_plan\": 903690,\n  \"cost_for_plan\": 159249,\n  \"semijoin_strategy_choice\": [\n  ],\n  \"pruned_by_cost\": true\n}\n</code></pre><h2>åè¿æ¥ï¼ˆANTI Joinï¼‰ç®€ä»‹</h2><p>æŒ‰å®˜æ–¹æ–‡æ¡£çš„è¯´æ³•ï¼ŒMySQL 8.0.17å¼€å§‹ï¼Œå¯¹äºæ»¡è¶³åŠè¿æ¥è½¬æ¢æ¡ä»¶çš„not inã€not existsæŸ¥è¯¢ï¼ŒMySQLè¿˜ä¼šä½¿ç”¨åæŸ¥è¯¢ï¼ˆANTI Joinï¼‰è½¬æ¢ã€‚</p><p>ä½†æ˜¯åœ¨æˆ‘çš„æµ‹è¯•ä¸­ï¼Œnot inçš„æ‰§è¡Œè®¡åˆ’ä¸­ä»æ—§æ˜¯ç›¸å…³å­æŸ¥è¯¢ï¼ˆDEPENDENT SUBQUERYï¼‰ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_parent \n    where b not in (\n        select b from t_subq where b is not null\n    );\n+----+--------------------+----------+-------+---------------+-------+---------+------+------+----------+--------------------------+\n| id | select_type        | table    | type  | possible_keys | key   | key_len | ref  | rows | filtered | Extra                    |\n+----+--------------------+----------+-------+---------------+-------+---------+------+------+----------+--------------------------+\n|  1 | PRIMARY            | t_parent | ALL   | NULL          | NULL  | NULL    | NULL |    7 |   100.00 | Using where              |\n|  2 | DEPENDENT SUBQUERY | t_subq   | index | NULL          | uk_cb | 10      | NULL |    3 |    66.67 | Using where; Using index |\n+----+--------------------+----------+-------+---------------+-------+---------+------+------+----------+--------------------------+\n</code></pre><p>ç»™ä¸»æŸ¥è¯¢çš„not inå­—æ®µåŠ ä¸Šnot nullæ¡ä»¶åï¼ŒæŸ¥è¯¢æ‰è½¬æ¢æˆäº†åè¿æ¥ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from t_parent \n    where not exists (\n        select 1 from t_subq where a=t_parent.a) \n    and a is not null;\n+----+-------------+----------+-------+---------------+---------+---------+----------------+------+----------+--------------------------------------+\n| id | select_type | table    | type  | possible_keys | key     | key_len | ref            | rows | filtered | Extra                                |\n+----+-------------+----------+-------+---------------+---------+---------+----------------+------+----------+--------------------------------------+\n|  1 | SIMPLE      | t_parent | range | idx_a         | idx_a   | 5       | NULL           |    6 |   100.00 | Using index condition                |\n|  1 | SIMPLE      | t_subq   | ref   | idx_abc       | idx_abc | 5       | rep.t_parent.a |    1 |   100.00 | Using where; Not exists; Using index |\n+----+-------------+----------+-------+---------------+---------+---------+----------------+------+----------+--------------------------------------+\n\nmysql&gt; show warnings\\G\n*************************** 2. row ***************************\n  Level: Note\n   Code: 1003\nMessage: /* select#1 */ select `rep`.`t_parent`.`id` AS `id`,\n     `rep`.`t_parent`.`a` AS `a`,`rep`.`t_parent`.`b` AS `b`,\n     `rep`.`t_parent`.`c` AS `c`,`rep`.`t_parent`.`padding` AS `padding` \nfrom `rep`.`t_parent` anti join (`rep`.`t_subq`) \non((`rep`.`t_subq`.`a` = `rep`.`t_parent`.`a`)) \nwhere (`rep`.`t_parent`.`a` is not null)\n</code></pre><p>å…³äºåè¿æ¥ï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯not inå’Œnot existså¹¶ä¸å®Œå…¨ç­‰ä»·ã€‚å¦‚æœå­æŸ¥è¯¢ä¸­å­˜åœ¨NULLå€¼ï¼Œé‚£ä¹ˆnot inä¸ä¼šè¿”å›ä»»ä½•æ•°æ®ã€‚</p><p>æˆ‘ä»¬æ¥æ‰§è¡Œä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œå­è¡¨t_subqå†™å…¥ä¸€æ¡nullçš„æ•°æ®ã€‚</p><pre><code class=\"language-plain\">mysql&gt; insert into t_subq values(5,null, 0,0,0,null);\nQuery OK, 1 row affected (0.25 sec)\n\nmysql&gt; select * from t_parent;\n+----+------+------+------+---------+\n| id | a    | b    | c    | padding |\n+----+------+------+------+---------+\n|  1 |    1 |    1 |    1 | NULL    |\n|  2 |    2 |    2 |    2 | NULL    |\n|  3 |    3 |    3 |    3 | NULL    |\n|  4 |    4 |    4 |    4 | NULL    |\n|  5 |    5 |    5 |    5 | NULL    |\n|  6 | NULL |    0 |    0 | NULL    |\n|  7 |    2 |    2 |    2 | NULL    |\n+----+------+------+------+---------+\n7 rows in set (0.00 sec)\n\nmysql&gt; select * from t_subq;\n+----+------+------+------+------+---------+\n| id | a    | b    | c    | d    | padding |\n+----+------+------+------+------+---------+\n|  1 |    1 |    1 |    1 |    1 | NULL    |\n|  2 |    2 |    2 |    2 |    2 | NULL    |\n|  3 |    3 |    3 |    3 |    3 | NULL    |\n|  4 |    2 |    4 |    4 |    2 | NULL    |\n|  5 | NULL |    0 |    0 |    0 | NULL    |\n+----+------+------+------+------+---------+\n</code></pre><p>ä½¿ç”¨not inæ—¶ï¼ŒæŸ¥è¯¢æ²¡æœ‰è¿”å›ä»»ä½•æ•°æ®ã€‚è¿™ä¸€ç‚¹æ˜¯ä½¿ç”¨not inæ—¶éœ€è¦æ³¨æ„çš„ã€‚è¿™æ˜¯ç”±not inå’Œnullçš„è¯­æ„å†³å®šçš„ï¼Œä¸å…‰æ˜¯MySQLï¼Œåœ¨å…¶ä»–æ•°æ®åº“ä¸­ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select * from t_parent where a not in (select a from t_subq);\nEmpty set (0.01 sec)\n</code></pre><p>ä½¿ç”¨not existsæ—¶ï¼Œå¯ä»¥æŸ¥è¯¢åˆ°æ•°æ®ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select * from t_parent where not exists (\n    select 1 from t_subq where a=t_parent.a);\n+----+------+------+------+---------+\n| id | a    | b    | c    | padding |\n+----+------+------+------+---------+\n|  4 |    4 |    4 |    4 | NULL    |\n|  5 |    5 |    5 |    5 | NULL    |\n|  6 | NULL |    0 |    0 | NULL    |\n+----+------+------+------+---------+\n</code></pre><p>å­æŸ¥è¯¢ä¸­éœ€è¦å¢åŠ not nullæ¡ä»¶ï¼Œnot inæ‰èƒ½æŸ¥è¯¢åˆ°æ•°æ®ã€‚ä½†æ˜¯å’Œnot existsè¿”å›çš„æ•°æ®è¿˜æ˜¯æœ‰ä¸€ç‚¹ä¸åŒï¼Œå°±æ˜¯not existsæŸ¥è¯¢è¿”å›äº†ä¸»è¡¨ä¸­å…³è”å­—æ®µä¸ºnullçš„æ•°æ®ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select * from t_parent where a not in (\n   select a from t_subq where a is not null);\n+----+------+------+------+---------+\n| id | a    | b    | c    | padding |\n+----+------+------+------+---------+\n|  4 |    4 |    4 |    4 | NULL    |\n|  5 |    5 |    5 |    5 | NULL    |\n+----+------+------+------+---------+\n</code></pre><h2>æ— æ³•ä½¿ç”¨åŠè¿æ¥ä¼˜åŒ–çš„å­æŸ¥è¯¢</h2><p>MySQLä¸­ï¼Œå­æŸ¥è¯¢å¯ä»¥å‡ºç°åœ¨è¯­å¥çš„ä¸åŒéƒ¨åˆ†ã€‚å­æŸ¥è¯¢å¯ä»¥å‡ºç°åœ¨Whereæ¡ä»¶ä¸­ï¼Œä¸€èˆ¬ä»¥existsã€not existsã€inã€not inçš„å½¢å¼å‡ºç°ï¼Œè¿™ç§æƒ…å†µå‰é¢æˆ‘ä»¬å·²ç»åšäº†ä¸€äº›è®¨è®ºäº†ã€‚å­æŸ¥è¯¢è¿˜å¯ä»¥å‡ºç°åœ¨SELECTçš„å­—æ®µåˆ—è¡¨ä¸­ï¼Œæˆ–è€…å‡ºç°åœ¨FROMå­å¥ä¸­ï¼ŒFROMå­å¥ä¸­çš„å­æŸ¥è¯¢ä¸€èˆ¬ä¹Ÿç§°ä¸ºæ´¾ç”Ÿè¡¨ã€‚</p><p>æœ‰äº›æƒ…å†µä¸‹ï¼ŒMySQLæ— æ³•ä½¿ç”¨åŠè¿æ¥è½¬æ¢æ¥è‡ªåŠ¨ä¼˜åŒ–å­æŸ¥è¯¢ï¼Œæ¯”å¦‚å½“å­æŸ¥è¯¢å‡ºç°åœ¨selectçš„åˆ—è¡¨ä¸­ï¼Œæˆ–è€…å­æŸ¥è¯¢ä¸­ä½¿ç”¨äº†èšåˆå‡½æ•°ã€‚è¿™äº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦æ‰‹åŠ¨æ”¹å†™SQLï¼Œæ¥ä¼˜åŒ–æ€§èƒ½ã€‚</p><p>æˆ‘ä»¬æ¥ä¸¾å‡ ä¸ªä¾‹å­ã€‚å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨ï¼Œå†™å…¥ä¸€äº›æ•°æ®ã€‚</p><pre><code class=\"language-plain\">create table emp_salary(\n    id int not null auto_increment,\n\temp_id int not null,\n\tdept_id int not null,\n\tsalary int not null,\n\tpadding varchar(2000),\n\tprimary key(id),\n\tkey idx_emp_id(emp_id),\n\tkey idx_dept_id(dept_id)\n) engine=innodb;\n\ninsert into emp_salary(emp_id, dept_id, salary, padding)\nselect 100000 + n, n % 10, 10000 + (n * n) % 10000, rpad('A', 1000, 'ABCD') \nfrom numbers;\n</code></pre><p>ä¸‹é¢è¿™ä¸ªSQLï¼Œå­æŸ¥è¯¢ä¸­ä½¿ç”¨äº†èšåˆå‡½æ•°ï¼Œä¼˜åŒ–å™¨æ— æ³•ä½¿ç”¨åŠè¿æ¥è½¬æ¢ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from emp_salary t1\nwhere salary &gt; (select avg(salary) \n                from emp_salary \n                where dept_id = t1.dept_id)\n\n+----+--------------------+------------+------+---------------+-------------+---------+-----------------+------+----------+-------------+\n| id | select_type        | table      | type | possible_keys | key         | key_len | ref             | rows | filtered | Extra       |\n+----+--------------------+------------+------+---------------+-------------+---------+-----------------+------+----------+-------------+\n|  1 | PRIMARY            | t1         | ALL  | NULL          | NULL        | NULL    | NULL            | 9295 |   100.00 | Using where |\n|  2 | DEPENDENT SUBQUERY | emp_salary | ref  | idx_dept_id   | idx_dept_id | 4       | test.t1.dept_id |  929 |   100.00 | NULL        |\n+----+--------------------+------------+------+---------------+-------------+---------+-----------------+------+----------+-------------+\n</code></pre><p>åœ¨æˆ‘çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œè¿™ä¸ªSQLéœ€è¦å¤§çº¦æ‰§è¡Œ9ç§’ï¼ŒåŸå› ä¸»è¦æ˜¯å­æŸ¥è¯¢æ‰§è¡Œçš„æ¬¡æ•°æ¯”è¾ƒå¤šã€‚</p><p>ç±»ä¼¼çš„ï¼Œä¸‹é¢è¿™ä¸ªSQLä¹Ÿéœ€è¦æ‰§è¡Œ9ç§’ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from (\n    select t1.emp_id, t1.dept_id, t1.salary, \n        (select avg(salary) \n         from emp_salary where dept_id = t1.dept_id\n        ) as dept_avg_salary\n    from emp_salary t1 ) t\nwhere salary &gt; dept_avg_salary;\n\n+----+--------------------+------------+------+---------------+-------------+---------+-----------------+------+----------+-------------+\n| id | select_type        | table      | type | possible_keys | key         | key_len | ref             | rows | filtered | Extra       |\n+----+--------------------+------------+------+---------------+-------------+---------+-----------------+------+----------+-------------+\n|  1 | PRIMARY            | &lt;derived2&gt; | ALL  | NULL          | NULL        | NULL    | NULL            | 9295 |    33.33 | Using where |\n|  2 | DERIVED            | t1         | ALL  | NULL          | NULL        | NULL    | NULL            | 9295 |   100.00 | NULL        |\n|  3 | DEPENDENT SUBQUERY | emp_salary | ref  | idx_dept_id   | idx_dept_id | 4       | test.t1.dept_id |  929 |   100.00 | NULL        |\n+----+--------------------+------------+------+---------------+-------------+---------+-----------------+------+----------+-------------+\n</code></pre><p>å¯¹äºè¿™æ ·çš„SQLï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•æ”¹å†™ï¼Œå°†ç›¸å…³å­æŸ¥è¯¢æ”¹æˆä¸ç›¸å…³å­æŸ¥è¯¢ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å­æŸ¥è¯¢çš„æ‰§è¡Œæ¬¡æ•°ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select t1.* \nfrom emp_salary t1,  (\n    select dept_id, avg(salary) as avg_salary \n    from emp_salary \n    group by dept_id ) t2\nwhere t1.dept_id = t2.dept_id\nand t1.salary &gt; t2.avg_salary;\n\n+----+-------------+------------+-------+---------------+-------------+---------+-----------------+------+----------+--------------------------+\n| id | select_type | table      | type  | possible_keys | key         | key_len | ref             | rows | filtered | Extra                    |\n+----+-------------+------------+-------+---------------+-------------+---------+-----------------+------+----------+--------------------------+\n|  1 | PRIMARY     | t1         | ALL   | idx_dept_id   | NULL        | NULL    | NULL            | 9295 |   100.00 | NULL                     |\n|  1 | PRIMARY     | &lt;derived2&gt; | ref   | &lt;auto_key0&gt;   | &lt;auto_key0&gt; | 4       | test.t1.dept_id |   92 |    33.33 | Using where; Using index |\n|  2 | DERIVED     | emp_salary | index | idx_dept_id   | idx_dept_id | 4       | NULL            | 9295 |   100.00 | NULL                     |\n+----+-------------+------------+-------+---------------+-------------+---------+-----------------+------+----------+--------------------------+\n</code></pre><p>æŒ‰ä¸Šé¢è¿™ä¸ªæ–¹å¼æ”¹å†™åï¼ŒSQLçš„æ‰§è¡Œæ•ˆç‡æå‡äº†å¾ˆå¤šå€ã€‚ä½ ä¹Ÿå¯ä»¥åˆ°è‡ªå·±çš„ç¯å¢ƒä¸­éªŒè¯ä¸€ä¸‹ã€‚è¿˜å¯ä»¥å¯¹æ¯”ä¸€ä¸‹è¿™å‡ ä¸ªSQLåœ¨æ…¢æ—¥å¿—ä¸­çš„Rows_examinedæŒ‡æ ‡ã€‚</p><h2>æ€»ç»“</h2><p>MySQL 8.0å¢å¼ºäº†å­æŸ¥è¯¢çš„ä¼˜åŒ–èƒ½åŠ›ï¼Œå¯¹å¾ˆå¤šç®€å•çš„å­æŸ¥è¯¢ï¼Œä¼˜åŒ–å™¨å¯ä»¥è‡ªåŠ¨å¤„ç†ã€‚å¦‚æœä½ åœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨äº†èšåˆå‡½æ•°ï¼Œæˆ–è€…åœ¨selectå­—æ®µä¸­ä½¿ç”¨äº†å­æŸ¥è¯¢ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œæ‰‹åŠ¨çš„ä¼˜åŒ–ã€‚ä½¿ç”¨not inæ—¶ï¼Œè¦æ³¨æ„å­æŸ¥è¯¢ä¸­ä¸è¦å‡ºç°nullçš„æ•°æ®ï¼Œè¿™ä¼šå¯¼è‡´æŸ¥è¯¢ä¸åˆ°ä»»ä½•æ•°æ®ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¿™ä¸€è®²ä¸­ï¼Œæˆ‘æä¾›äº†ä¸¤ç§æ‰‹åŠ¨æ”¹å†™å­æŸ¥è¯¢çš„æ€è·¯ã€‚</p><p>æ€è·¯1ï¼š</p><pre><code class=\"language-plain\">mysql&gt; select t1.item_id, sum(t1.sold) as sold\nfrom stat_item_detail t1, (\n  select distinct item_id \n  from stat_item_detail t2\n  where t2.gmt_create &gt;= '2026-04-26 10:30:00') t22\nwhere t1.item_id = t22.item_id\ngroup by t1.item_id;\n</code></pre><p>æ€è·¯2ï¼š</p><pre><code class=\"language-plain\">select item_id, sum(sold) from (\n    select distinct t1.id,  t1.item_id, t1.sold as sold\n    from stat_item_detail t1, stat_item_detail t2\n    where t1.item_id = t2.item_id\n    and t2.gmt_create &gt;= '2026-04-26 10:30:00'\n) t group by item_id;\n</code></pre><p>è¯·é—®è¿™ä¸¤ç§æ”¹å†™æ–¹å¼ï¼Œåˆ†åˆ«å¯¹åº”äº†MySQLåŠè¿æ¥è½¬æ¢ä¸­çš„å“ªä¸€ä¸ªç­–ç•¥ï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","neighbors":{"left":{"article_title":"21ï½œè¡¨è¿æ¥å¦‚ä½•æ‰§è¡Œï¼Ÿ","id":813345},"right":{"article_title":"23ï½œ10+ SQLæ‰§è¡Œæ€§èƒ½ä¸ä½³çš„çœŸå®æ¡ˆä¾‹ï¼ˆä¸Šï¼‰","id":813361}},"comments":[{"had_liked":false,"id":394906,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1728718697,"is_pvip":false,"replies":[{"id":143399,"content":"ğŸ‘ğŸ‘\n\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728886802,"ip_address":"æµ™æ±Ÿ","comment_id":394906,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è·¯1\n+----+-------------+------------+------------+-------+----------------------------------------+\n| id | select_type | table      | partitions | type  | Extra                                  |\n+----+-------------+------------+------------+-------+----------------------------------------+\n|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ALL   | Using temporary                        |\n|  1 | PRIMARY     | t1         | NULL       | ref   | NULL                                   |\n|  2 | DERIVED     | t2         | NULL       | range | Using index condition; Using temporary |\n+----+-------------+------------+------------+-------+----------------------------------------+\n\n\nç¬¬ä¸€ç§æ”¹å†™æ–¹å¼å¯¹åº”åŠè¿æ¥è½¬æ¢ä¸­çš„ Materialize with deduplication ç­–ç•¥ï¼Œ\nä» distinct item_id çš„è¯­ä¹‰å’Œæ‰§è¡Œè®¡åˆ’ä¸­ Extra åˆ—ä¸­çš„ Using temporaryï¼Œå†é€šè¿‡æ‰§è¡Œè®¡åˆ’çš„æ‰§è¡Œé¡ºåºå¯çŸ¥ï¼Œå…ˆç”Ÿæˆä¸€ä¸ªå†…å­˜ä¸´æ—¶è¡¨ï¼Œå°† item_id åˆ—è®¾ç½®ä¸ºå”¯ä¸€é”®ï¼Œ\nç„¶åèŒƒå›´æ‰«æç´¢å¼• idx_gmt_create ï¼Œå°†æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„ item_id æ’å…¥åˆ°è¡¨ä¸­ã€‚æ’å…¥å®Œæˆåï¼Œç”¨è¯¥ä¸´æ—¶è¡¨ä¸è¡¨ stat_item_detail è¿›è¡Œ join æ“ä½œã€‚\nè¿™ä¸ªè¿‡ç¨‹ä¸ materialize with deduplication ç­–ç•¥çš„è¿‡ç¨‹ä¸€æ ·â€”â€”å…ˆå°†å­æŸ¥è¯¢ç‰©åŒ–æˆä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œç„¶åå¯¹ä¸´æ—¶è¡¨ä¸­çš„è®°å½•è¿›è¡Œå»é‡æ“ä½œï¼Œæœ€åå°†å»é‡åçš„ä¸´æ—¶è¡¨ä¸åŸä¸»æŸ¥è¯¢ä¸­çš„è¡¨è¿›è¡Œå…³è”æŸ¥è¯¢ã€‚\n\n\næ€è·¯2\n+----+-------------+------------+------------+-------+----------------------------------------+\n| id | select_type | table      | partitions | type  | Extra                                  |\n+----+-------------+------------+------------+-------+----------------------------------------+\n|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ALL   | Using temporary                        |\n|  2 | DERIVED     | t2         | NULL       | range | Using index condition; Using temporary |\n|  2 | DERIVED     | t1         | NULL       | ref   | NULL                                   |\n+----+-------------+------------+------------+-------+----------------------------------------+\n\nç¬¬äºŒç§æ”¹å†™æ–¹å¼å¯¹åº”åŠè¿æ¥è½¬æ¢ä¸­çš„ Duplicate Weedout ç­–ç•¥ï¼Œä½¿ç”¨åˆ°äº†å†…å­˜ä¸´æ—¶è¡¨ï¼Œå¹¶ç”¨ä¸»é”®æ¥å»é‡ã€‚","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652410,"discussion_content":"ğŸ‘ğŸ‘\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728886802,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394883,"user_name":"é™ˆæ˜Ÿå®‡(2.11)","can_delete":false,"product_type":"c1","uid":1450562,"ip_address":"å››å·","ucode":"970E48260B7924","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/42/11674804.jpg","comment_is_top":false,"comment_ctime":1728650509,"is_pvip":false,"replies":[{"id":143388,"content":"MySQL 5.6å°±å¼€å§‹æ”¯æŒsemijoinäº†ï¼Œä¸è¿‡8.0ä¸­æ”¯æŒçš„åœºæ™¯æ›´å¤šã€‚\n5.6ï¼Œ5.7ä¸ä¼šè‡ªåŠ¨è½¬æ¢existsï¼Œ8.0å¼€å§‹æ”¯æŒexistsçš„è½¬æ¢ã€‚\n\nè¿™æ˜¯5.7 semijoinçš„å®˜æ–¹æ–‡æ¡£ï¼šhttps:&#47;&#47;dev.mysql.com&#47;doc&#47;refman&#47;5.7&#47;en&#47;semijoins.html","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728714979,"ip_address":"æµ™æ±Ÿ","comment_id":394883,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è¿™äº›ç­–ç•¥åˆ†åˆ«æ˜¯ pulloutã€duplicate weedoutã€first matchã€loose scanã€materializationã€‚ è¿™äº›æ˜¯8.0æ‰æœ‰å—ï¼Ÿåœ¨5.7é‡Œå¾ˆå°‘çœ‹åˆ°ã€‚","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652334,"discussion_content":"MySQL 5.6å°±å¼€å§‹æ”¯æŒsemijoinäº†ï¼Œä¸è¿‡8.0ä¸­æ”¯æŒçš„åœºæ™¯æ›´å¤šã€‚\n5.6ï¼Œ5.7ä¸ä¼šè‡ªåŠ¨è½¬æ¢existsï¼Œ8.0å¼€å§‹æ”¯æŒexistsçš„è½¬æ¢ã€‚\n\nè¿™æ˜¯5.7 semijoinçš„å®˜æ–¹æ–‡æ¡£ï¼šhttps://dev.mysql.com/doc/refman/5.7/en/semijoins.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728714979,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394882,"user_name":"é™ˆæ˜Ÿå®‡(2.11)","can_delete":false,"product_type":"c1","uid":1450562,"ip_address":"å››å·","ucode":"970E48260B7924","user_header":"https://static001.geekbang.org/account/avatar/00/16/22/42/11674804.jpg","comment_is_top":false,"comment_ctime":1728650435,"is_pvip":false,"replies":[{"id":143387,"content":"è¿™ä¸ªæ‰§è¡Œè®¡åˆ’æ˜¯å…ˆä» IDä¸º1çš„è·å–ä¸€è¡Œæ•°æ®ï¼Œå†é©±åŠ¨ç›¸å…³å­æŸ¥è¯¢ã€‚\n\nä½¿ç”¨explain extended + show warningsï¼Œèƒ½çœ‹åˆ°è½¬æ¢åçš„SQLï¼š\n\nselect `rep`.`stat_item_detail`.`item_id` AS `item_id`,sum(`rep`.`stat_item_detail`.`sold`) AS `sold` \nfrom `rep`.`stat_item_detail` \nwhere &lt;in_optimizer&gt;(\n    `rep`.`stat_item_detail`.`item_id`, &lt;exists&gt;(&lt;index_lookup&gt;(&lt;cache&gt;(`rep`.`stat_item_detail`.`item_id`) in stat_item_detail on idx_item_id \n\twhere ((`rep`.`stat_item_detail`.`gmt_create` &gt;= &#39;2026-04-26 10:30:00&#39;) \n\tand (&lt;cache&gt;(`rep`.`stat_item_detail`.`item_id`) = `rep`.`stat_item_detail`.`item_id`))))) \ngroup by `rep`.`stat_item_detail`.`item_id`ã€‚\n\nè¿™æ˜¯5.5ä¸­çš„æ‰§è¡Œè®¡åˆ’ã€‚åœ¨8.0é‡Œï¼Œæˆ‘è¯•äº†ä¸‹ï¼Œå¦‚æœå…³é—­semijoinä¼˜åŒ–ï¼Œæ‰§è¡Œè®¡åˆ’æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œ\n\nmysql&gt; explain select item_id, sum(sold) as sold from stat_item_detail where item_id in (\n   select item_id from stat_item_detail where Gmt_create &gt;= &#39;2026-04-26 10:30:00&#39;) group by item_id;\n+----+-------------+------------------+-------+----------------------------+----------------+---------+--------+\n| id | select_type | table            | type  | possible_keys              | key            | key_len | rows   |\n+----+-------------+------------------+-------+----------------------------+----------------+---------+--------+\n|  1 | PRIMARY     | stat_item_detail | index | idx_item_id                | idx_item_id    | 4       | 903690 |\n|  2 | SUBQUERY    | stat_item_detail | range | idx_item_id,idx_gmt_create | idx_gmt_create | 5       |     10 |\n+----+-------------+------------------+-------+----------------------------+----------------+---------+--------+\n\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1728714627,"ip_address":"æµ™æ±Ÿ","comment_id":394882,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"mysql&gt; explain select item_id, sum(sold) as sold \n      from stat_item_detail \n      where item_id in (\n           select item_id \n           from stat_item_detail \n           where Gmt_create &gt;= &#39;2026-04-26 10:30:00&#39;) \n      group by item_id;\n\n+----+--------------------+------------------+----------------+----------------------------+-------------+---------+------+---------+-------------+\n| id | select_type        | table            | type           | possible_keys              | key         | key_len | ref  | rows    | Extra       |\n+----+--------------------+------------------+----------------+----------------------------+-------------+---------+------+---------+-------------+\n|  1 | PRIMARY            | stat_item_detail | index          | NULL                       | idx_item_id | 4       | NULL | 1000029 | Using where |\n|  2 | DEPENDENT SUBQUERY | stat_item_detail | index_subquery | idx_item_id,idx_gmt_create | idx_item_id | 4       | func |       1 | Using where |\n+----+--------------------+------------------+----------------+----------------------------+-------------+---------+------+---------+-------------+\næ‰§è¡Œä¸æ˜¯æŒ‰idä»å¤§åˆ°å°æ‰§è¡Œå—ï¼Ÿæ„Ÿè§‰å­æŸ¥è¯¢åº”è¯¥èµ°æ—¶é—´å­—æ®µçš„ç´¢å¼•ï¼Œè¿™é‡Œæ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Œæœ‰ç‚¹æ²¡ç†è§£ã€‚\nâ€œä»ä¸Šé¢çš„è¿™ä¸ªæ‰§è¡Œè®¡åˆ’å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª SQL åœ¨æ‰§è¡Œæ—¶ï¼Œå…ˆå…¨é‡æ‰«æç´¢å¼• idx_item_idï¼Œæ¯å¾—åˆ°ä¸€ä¸ª item_id åï¼Œæ‰§è¡Œç›¸å…³å­æŸ¥è¯¢ï¼ˆDEPENDENT SUBQUERYï¼‰select 1 from stat_item_detail where gmt_create &gt;= â€˜2026-04-26 10:30:00â€™ and item_id = primary.item_idã€‚å½“ä¸»æŸ¥è¯¢ä¸­è¡¨ä¸­çš„æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œå­æŸ¥è¯¢æ‰§è¡Œçš„æ¬¡æ•°ä¹Ÿä¼šå¾ˆå¤šï¼Œå› æ­¤ SQL çš„æ€§èƒ½éå¸¸å·®ã€‚â€","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":652333,"discussion_content":"è¿™ä¸ªæ‰§è¡Œè®¡åˆ’æ˜¯å…ˆä» IDä¸º1çš„è·å–ä¸€è¡Œæ•°æ®ï¼Œå†é©±åŠ¨ç›¸å…³å­æŸ¥è¯¢ã€‚\n\nä½¿ç”¨explain extended + show warningsï¼Œèƒ½çœ‹åˆ°è½¬æ¢åçš„SQLï¼š\n\nselect `rep`.`stat_item_detail`.`item_id` AS `item_id`,sum(`rep`.`stat_item_detail`.`sold`) AS `sold` \nfrom `rep`.`stat_item_detail` \nwhere &lt;in_optimizer&gt;(\n    `rep`.`stat_item_detail`.`item_id`, &lt;exists&gt;(&lt;index_lookup&gt;(&lt;cache&gt;(`rep`.`stat_item_detail`.`item_id`) in stat_item_detail on idx_item_id \n\twhere ((`rep`.`stat_item_detail`.`gmt_create` &gt;= &#39;2026-04-26 10:30:00&#39;) \n\tand (&lt;cache&gt;(`rep`.`stat_item_detail`.`item_id`) = `rep`.`stat_item_detail`.`item_id`))))) \ngroup by `rep`.`stat_item_detail`.`item_id`ã€‚\n\nè¿™æ˜¯5.5ä¸­çš„æ‰§è¡Œè®¡åˆ’ã€‚åœ¨8.0é‡Œï¼Œæˆ‘è¯•äº†ä¸‹ï¼Œå¦‚æœå…³é—­semijoinä¼˜åŒ–ï¼Œæ‰§è¡Œè®¡åˆ’æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œ\n\nmysql&gt; explain select item_id, sum(sold) as sold from stat_item_detail where item_id in (\n   select item_id from stat_item_detail where Gmt_create &gt;= &#39;2026-04-26 10:30:00&#39;) group by item_id;\n+----+-------------+------------------+-------+----------------------------+----------------+---------+--------+\n| id | select_type | table            | type  | possible_keys              | key            | key_len | rows   |\n+----+-------------+------------------+-------+----------------------------+----------------+---------+--------+\n|  1 | PRIMARY     | stat_item_detail | index | idx_item_id                | idx_item_id    | 4       | 903690 |\n|  2 | SUBQUERY    | stat_item_detail | range | idx_item_id,idx_gmt_create | idx_gmt_create | 5       |     10 |\n+----+-------------+------------------+-------+----------------------------+----------------+---------+--------+\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1728714627,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}