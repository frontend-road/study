{"id":86330,"title":"49 | æ¡ˆä¾‹ç¯‡ï¼šå†…æ ¸çº¿ç¨‹ CPU åˆ©ç”¨ç‡å¤ªé«˜ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å€ªæœ‹é£ã€‚</p><p>ä¸Šä¸€æœŸï¼Œæˆ‘ä»¬ä¸€èµ·æ¢³ç†äº†ï¼Œç½‘ç»œæ—¶ä¸æ—¶ä¸¢åŒ…çš„åˆ†æå®šä½å’Œä¼˜åŒ–æ–¹æ³•ã€‚å…ˆç®€å•å›é¡¾ä¸€ä¸‹ã€‚</p><p>ç½‘ç»œä¸¢åŒ…ï¼Œé€šå¸¸ä¼šå¸¦æ¥ä¸¥é‡çš„æ€§èƒ½ä¸‹é™ï¼Œç‰¹åˆ«æ˜¯å¯¹ TCP æ¥è¯´ï¼Œä¸¢åŒ…é€šå¸¸æ„å‘³ç€ç½‘ç»œæ‹¥å¡å’Œé‡ä¼ ï¼Œè¿›è€Œä¼šå¯¼è‡´ç½‘ç»œå»¶è¿Ÿå¢å¤§ä»¥åŠååé‡é™ä½ã€‚</p><p>è€Œåˆ†æä¸¢åŒ…é—®é¢˜ï¼Œè¿˜æ˜¯ç”¨æˆ‘ä»¬çš„è€å¥—è·¯ï¼Œä» Linux ç½‘ç»œæ”¶å‘çš„æµç¨‹å…¥æ‰‹ï¼Œç»“åˆ TCP/IP åè®®æ ˆçš„åŸç†æ¥é€å±‚åˆ†æã€‚</p><p>å…¶å®ï¼Œåœ¨æ’æŸ¥ç½‘ç»œé—®é¢˜æ—¶ï¼Œæˆ‘ä»¬è¿˜ç»å¸¸ç¢°åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å†…æ ¸çº¿ç¨‹çš„ CPU ä½¿ç”¨ç‡å¾ˆé«˜ã€‚æ¯”å¦‚ï¼Œåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸­ï¼Œå†…æ ¸çº¿ç¨‹ ksoftirqd çš„ CPU ä½¿ç”¨ç‡é€šå¸¸å°±ä¼šæ¯”è¾ƒé«˜ã€‚å›é¡¾ä¸€ä¸‹å‰é¢å­¦è¿‡çš„ CPU å’Œç½‘ç»œæ¨¡å—ï¼Œä½ åº”è¯¥çŸ¥é“ï¼Œè¿™æ˜¯ç½‘ç»œæ”¶å‘çš„è½¯ä¸­æ–­å¯¼è‡´çš„ã€‚</p><p>è€Œè¦åˆ†æ ksoftirqd è¿™ç±» CPU ä½¿ç”¨ç‡æ¯”è¾ƒé«˜çš„å†…æ ¸çº¿ç¨‹ï¼Œå¦‚æœç”¨æˆ‘å‰é¢ä»‹ç»è¿‡çš„é‚£äº›åˆ†ææ–¹æ³•ï¼Œä½ ä¸€èˆ¬éœ€è¦å€ŸåŠ©äºå…¶ä»–æ€§èƒ½å·¥å…·ï¼Œè¿›è¡Œè¾…åŠ©åˆ†æã€‚</p><p>æ¯”å¦‚ï¼Œè¿˜æ˜¯ä»¥ ksoftirqd ä¸ºä¾‹ï¼Œå¦‚æœä½ æ€€ç–‘æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå°±å¯ä»¥ç”¨ sarã€tcpdump ç­‰åˆ†æç½‘ç»œæµé‡ï¼Œè¿›ä¸€æ­¥ç¡®è®¤ç½‘ç»œé—®é¢˜çš„æ ¹æºã€‚</p><p>ä¸è¿‡ï¼Œæ˜¾ç„¶ï¼Œè¿™ç§æ–¹æ³•åœ¨å®é™…æ“ä½œä¸­éœ€è¦æ­¥éª¤æ¯”è¾ƒå¤šï¼Œå¯èƒ½å¹¶ä¸ç®—å¿«æ·ã€‚ä½ è‚¯å®šä¹Ÿå¾ˆæƒ³çŸ¥é“ï¼Œæœ‰æ²¡æœ‰å…¶ä»–æ›´ç®€å•çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è§‚å¯Ÿå†…æ ¸çº¿ç¨‹çš„è¡Œä¸ºï¼Œæ›´å¿«å®šä½ç“¶é¢ˆå‘¢ï¼Ÿ</p><p>ä»Šå¤©ï¼Œæˆ‘å°±ç»§ç»­ä»¥ ksoftirqd ä¸ºä¾‹ï¼Œå¸¦ä½ ä¸€èµ·çœ‹çœ‹ï¼Œå¦‚ä½•åˆ†æå†…æ ¸çº¿ç¨‹çš„æ€§èƒ½é—®é¢˜ã€‚</p><!-- [[[read_end]]] --><h2>å†…æ ¸çº¿ç¨‹</h2><p>æ—¢ç„¶è¦è®²å†…æ ¸çº¿ç¨‹çš„æ€§èƒ½é—®é¢˜ï¼Œåœ¨æ¡ˆä¾‹å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹çœ‹ï¼Œæœ‰å“ªäº›å¸¸è§çš„å†…æ ¸çº¿ç¨‹ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ Linux ä¸­ï¼Œç”¨æˆ·æ€è¿›ç¨‹çš„â€œç¥–å…ˆâ€ï¼Œéƒ½æ˜¯ PID å·ä¸º 1 çš„ init è¿›ç¨‹ã€‚æ¯”å¦‚ï¼Œç°åœ¨ä¸»æµçš„ Linux å‘è¡Œç‰ˆä¸­ï¼Œinit éƒ½æ˜¯ systemd è¿›ç¨‹ï¼›è€Œå…¶ä»–çš„ç”¨æˆ·æ€è¿›ç¨‹ï¼Œä¼šé€šè¿‡ systemd æ¥è¿›è¡Œç®¡ç†ã€‚</p><p>ç¨å¾®æƒ³ä¸€ä¸‹ Linux ä¸­çš„å„ç§è¿›ç¨‹ï¼Œé™¤äº†ç”¨æˆ·æ€è¿›ç¨‹å¤–ï¼Œè¿˜æœ‰å¤§é‡çš„å†…æ ¸æ€çº¿ç¨‹ã€‚æŒ‰è¯´å†…æ ¸æ€çš„çº¿ç¨‹ï¼Œåº”è¯¥å…ˆäºç”¨æˆ·æ€è¿›ç¨‹å¯åŠ¨ï¼Œå¯æ˜¯ systemd åªç®¡ç†ç”¨æˆ·æ€è¿›ç¨‹ã€‚é‚£ä¹ˆï¼Œå†…æ ¸æ€çº¿ç¨‹åˆæ˜¯è°æ¥ç®¡ç†çš„å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼ŒLinux åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªç‰¹æ®Šçš„è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯ PID å·æœ€å°çš„ä¸‰ä¸ªè¿›ç¨‹ã€‚</p><ul>\n<li>\n<p>0 å·è¿›ç¨‹ä¸º idle è¿›ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯ç³»ç»Ÿåˆ›å»ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒåœ¨åˆå§‹åŒ– 1 å·å’Œ 2 å·è¿›ç¨‹åï¼Œæ¼”å˜ä¸ºç©ºé—²ä»»åŠ¡ã€‚å½“ CPU ä¸Šæ²¡æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå°±ä¼šè¿è¡Œå®ƒã€‚</p>\n</li>\n<li>\n<p>1 å·è¿›ç¨‹ä¸º init è¿›ç¨‹ï¼Œé€šå¸¸æ˜¯ systemd è¿›ç¨‹ï¼Œåœ¨ç”¨æˆ·æ€è¿è¡Œï¼Œç”¨æ¥ç®¡ç†å…¶ä»–ç”¨æˆ·æ€è¿›ç¨‹ã€‚</p>\n</li>\n<li>\n<p>2 å·è¿›ç¨‹ä¸º kthreadd è¿›ç¨‹ï¼Œåœ¨å†…æ ¸æ€è¿è¡Œï¼Œç”¨æ¥ç®¡ç†å†…æ ¸çº¿ç¨‹ã€‚</p>\n</li>\n</ul><p>æ‰€ä»¥ï¼Œè¦æŸ¥æ‰¾å†…æ ¸çº¿ç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä» 2 å·è¿›ç¨‹å¼€å§‹ï¼ŒæŸ¥æ‰¾å®ƒçš„å­å­™è¿›ç¨‹å³å¯ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ ps å‘½ä»¤ï¼Œæ¥æŸ¥æ‰¾ kthreadd çš„å­è¿›ç¨‹ï¼š</p><pre><code>$ ps -f --ppid 2 -p 2\nUID         PID   PPID  C STIME TTY          TIME CMD\nroot          2      0  0 12:02 ?        00:00:01 [kthreadd]\nroot          9      2  0 12:02 ?        00:00:21 [ksoftirqd/0]\nroot         10      2  0 12:02 ?        00:11:47 [rcu_sched]\nroot         11      2  0 12:02 ?        00:00:18 [migration/0]\n...\nroot      11094      2  0 14:20 ?        00:00:00 [kworker/1:0-eve]\nroot      11647      2  0 14:27 ?        00:00:00 [kworker/0:2-cgr]\n</code></pre><p>ä»ä¸Šé¢çš„è¾“å‡ºï¼Œä½ èƒ½å¤Ÿçœ‹åˆ°ï¼Œå†…æ ¸çº¿ç¨‹çš„åç§°ï¼ˆCMDï¼‰éƒ½åœ¨ä¸­æ‹¬å·é‡Œï¼ˆè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å‰é¢å†…å®¹ä¹Ÿæœ‰æåˆ°è¿‡ï¼‰ã€‚æ‰€ä»¥ï¼Œæ›´ç®€å•çš„æ–¹æ³•ï¼Œå°±æ˜¯ç›´æ¥æŸ¥æ‰¾åç§°åŒ…å«ä¸­æ‹¬å·çš„è¿›ç¨‹ã€‚æ¯”å¦‚ï¼š</p><pre><code>$ ps -ef | grep &quot;\\[.*\\]&quot;\nroot         2     0  0 08:14 ?        00:00:00 [kthreadd]\nroot         3     2  0 08:14 ?        00:00:00 [rcu_gp]\nroot         4     2  0 08:14 ?        00:00:00 [rcu_par_gp]\n...\n</code></pre><p>äº†è§£å†…æ ¸çº¿ç¨‹çš„åŸºæœ¬åŠŸèƒ½ï¼Œå¯¹æˆ‘ä»¬æ’æŸ¥é—®é¢˜æœ‰éå¸¸å¤§çš„å¸®åŠ©ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æ›¾ç»åœ¨è½¯ä¸­æ–­æ¡ˆä¾‹ä¸­æåˆ°è¿‡ ksoftirqdã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†è½¯ä¸­æ–­çš„å†…æ ¸çº¿ç¨‹ï¼Œå¹¶ä¸”æ¯ä¸ª CPU ä¸Šéƒ½æœ‰ä¸€ä¸ªã€‚</p><p>å¦‚æœä½ çŸ¥é“äº†è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆï¼Œä»¥åé‡åˆ° ksoftirqd çš„ CPU ä½¿ç”¨é«˜çš„æƒ…å†µï¼Œå°±ä¼šé¦–å…ˆæ€€ç–‘æ˜¯è½¯ä¸­æ–­çš„é—®é¢˜ï¼Œç„¶åä»è½¯ä¸­æ–­çš„è§’åº¦æ¥è¿›ä¸€æ­¥åˆ†æã€‚</p><p>å…¶å®ï¼Œé™¤äº†åˆšæ‰çœ‹åˆ°çš„ kthreadd å’Œ ksoftirqd å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå¸¸è§çš„å†…æ ¸çº¿ç¨‹ï¼Œæˆ‘ä»¬åœ¨æ€§èƒ½åˆ†æä¸­éƒ½ç»å¸¸ä¼šç¢°åˆ°ï¼Œæ¯”å¦‚ä¸‹é¢è¿™å‡ ä¸ªå†…æ ¸çº¿ç¨‹ã€‚</p><ul>\n<li>\n<p><strong>kswapd0</strong>ï¼šç”¨äºå†…å­˜å›æ”¶ã€‚åœ¨  <a href=\"https://time.geekbang.org/column/article/75797\">Swapå˜é«˜</a> æ¡ˆä¾‹ä¸­ï¼Œæˆ‘æ›¾ä»‹ç»è¿‡å®ƒçš„å·¥ä½œåŸç†ã€‚</p>\n</li>\n<li>\n<p><strong>kworker</strong>ï¼šç”¨äºæ‰§è¡Œå†…æ ¸å·¥ä½œé˜Ÿåˆ—ï¼Œåˆ†ä¸ºç»‘å®š CPU ï¼ˆåç§°æ ¼å¼ä¸º kworker/CPU:IDï¼‰å’Œæœªç»‘å®š CPUï¼ˆåç§°æ ¼å¼ä¸º kworker/uPOOL:IDï¼‰ä¸¤ç±»ã€‚</p>\n</li>\n<li>\n<p><strong>migration</strong>ï¼šåœ¨è´Ÿè½½å‡è¡¡è¿‡ç¨‹ä¸­ï¼ŒæŠŠè¿›ç¨‹è¿ç§»åˆ° CPU ä¸Šã€‚æ¯ä¸ª CPU éƒ½æœ‰ä¸€ä¸ª migration å†…æ ¸çº¿ç¨‹ã€‚</p>\n</li>\n<li>\n<p><strong>jbd2</strong>/sda1-8ï¼šjbd æ˜¯ Journaling Block Device çš„ç¼©å†™ï¼Œç”¨æ¥ä¸ºæ–‡ä»¶ç³»ç»Ÿæä¾›æ—¥å¿—åŠŸèƒ½ï¼Œä»¥ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼›åç§°ä¸­çš„ sda1-8ï¼Œè¡¨ç¤ºç£ç›˜åˆ†åŒºåç§°å’Œè®¾å¤‡å·ã€‚æ¯ä¸ªä½¿ç”¨äº† ext4 æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜åˆ†åŒºï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ª jbd2 å†…æ ¸çº¿ç¨‹ã€‚</p>\n</li>\n<li>\n<p><strong>pdflush</strong>ï¼šç”¨äºå°†å†…å­˜ä¸­çš„è„é¡µï¼ˆè¢«ä¿®æ”¹è¿‡ï¼Œä½†è¿˜æœªå†™å…¥ç£ç›˜çš„æ–‡ä»¶é¡µï¼‰å†™å…¥ç£ç›˜ï¼ˆå·²ç»åœ¨ 3.10 ä¸­åˆå¹¶å…¥äº† kworker ä¸­ï¼‰ã€‚</p>\n</li>\n</ul><p>äº†è§£è¿™å‡ ä¸ªå®¹æ˜“å‘ç”Ÿæ€§èƒ½é—®é¢˜çš„å†…æ ¸çº¿ç¨‹ï¼Œæœ‰åŠ©äºæˆ‘ä»¬æ›´å¿«åœ°å®šä½æ€§èƒ½ç“¶é¢ˆã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä»Šå¤©çš„æ¡ˆä¾‹ã€‚</p><h2>æ¡ˆä¾‹å‡†å¤‡</h2><p>ä»Šå¤©çš„æ¡ˆä¾‹è¿˜æ˜¯åŸºäº Ubuntu 18.04ï¼ŒåŒæ ·é€‚ç”¨äºå…¶ä»–çš„ Linux ç³»ç»Ÿã€‚æˆ‘ä½¿ç”¨çš„æ¡ˆä¾‹ç¯å¢ƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul>\n<li>\n<p>æœºå™¨é…ç½®ï¼š2 CPUï¼Œ8GB å†…å­˜ã€‚</p>\n</li>\n<li>\n<p>é¢„å…ˆå®‰è£… dockerã€perfã€hping3ã€curl ç­‰å·¥å…·ï¼Œå¦‚ apt install docker.io linux-tools-common hping3ã€‚</p>\n</li>\n</ul><p>æœ¬æ¬¡æ¡ˆä¾‹ç”¨åˆ°ä¸¤å°è™šæ‹Ÿæœºï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾æ¥è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/7d/11/7dd0763a14713940e7c762a62387dd11.png?wh=816*516\" alt=\"\"></p><p>ä½ éœ€è¦æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œåˆ†åˆ«ç™»å½•è¿™ä¸¤å°è™šæ‹Ÿæœºä¸­ï¼Œå¹¶å®‰è£…ä¸Šè¿°å·¥å…·ã€‚</p><p>æ³¨æ„ï¼Œä»¥ä¸‹æ‰€æœ‰å‘½ä»¤éƒ½é»˜è®¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œå¦‚æœä½ ç”¨æ™®é€šç”¨æˆ·èº«ä»½ç™»é™†ç³»ç»Ÿï¼Œè¯·è¿è¡Œ sudo su root å‘½ä»¤ï¼Œåˆ‡æ¢åˆ° root ç”¨æˆ·ã€‚</p><blockquote>\n<p>å¦‚æœå®‰è£…è¿‡ç¨‹æœ‰é—®é¢˜ï¼Œä½ å¯ä»¥å…ˆä¸Šç½‘æœç´¢è§£å†³ï¼Œå®åœ¨è§£å†³ä¸äº†çš„ï¼Œè®°å¾—åœ¨ç•™è¨€åŒºå‘æˆ‘æé—®ã€‚</p>\n</blockquote><p>åˆ°è¿™é‡Œï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­£å¼è¿›å…¥æ“ä½œç¯èŠ‚ã€‚</p><h2>æ¡ˆä¾‹åˆ†æ</h2><p>å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å…ˆåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿è¡Œæ¡ˆä¾‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„ Nginx åº”ç”¨ï¼š</p><pre><code># è¿è¡ŒNginxæœåŠ¡å¹¶å¯¹å¤–å¼€æ”¾80ç«¯å£\n$ docker run -itd --name=nginx -p 80:80 nginx\n</code></pre><p>ç„¶åï¼Œåœ¨ç¬¬äºŒä¸ªç»ˆç«¯ï¼Œä½¿ç”¨ curl è®¿é—® Nginx ç›‘å¬çš„ç«¯å£ï¼Œç¡®è®¤ Nginx æ­£å¸¸å¯åŠ¨ã€‚å‡è®¾ 192.168.0.30 æ˜¯ Nginx æ‰€åœ¨è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼Œè¿è¡Œ curl å‘½ä»¤åï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸‹é¢è¿™ä¸ªè¾“å‡ºç•Œé¢ï¼š</p><pre><code>$ curl http://192.168.0.30/\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n...\n</code></pre><p>æ¥ç€ï¼Œè¿˜æ˜¯åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­ï¼Œè¿è¡Œ hping3 å‘½ä»¤ï¼Œæ¨¡æ‹Ÿ Nginx çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼š</p><pre><code># -Så‚æ•°è¡¨ç¤ºè®¾ç½®TCPåè®®çš„SYNï¼ˆåŒæ­¥åºåˆ—å·ï¼‰ï¼Œ-pè¡¨ç¤ºç›®çš„ç«¯å£ä¸º80\n# -i u10è¡¨ç¤ºæ¯éš”10å¾®ç§’å‘é€ä¸€ä¸ªç½‘ç»œå¸§\n# æ³¨ï¼šå¦‚æœä½ åœ¨å®è·µè¿‡ç¨‹ä¸­ç°è±¡ä¸æ˜æ˜¾ï¼Œå¯ä»¥å°è¯•æŠŠ10è°ƒå°ï¼Œæ¯”å¦‚è°ƒæˆ5ç”šè‡³1\n$ hping3 -S -p 80 -i u10 192.168.0.30\n</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å†å›åˆ°ç¬¬ä¸€ä¸ªç»ˆç«¯ï¼Œä½ åº”è¯¥å°±ä¼šå‘ç°å¼‚å¸¸â€”â€”ç³»ç»Ÿçš„å“åº”æ˜æ˜¾å˜æ…¢äº†ã€‚æˆ‘ä»¬ä¸å¦¨æ‰§è¡Œ topï¼Œè§‚å¯Ÿä¸€ä¸‹ç³»ç»Ÿå’Œè¿›ç¨‹çš„ CPU ä½¿ç”¨æƒ…å†µï¼š</p><pre><code>$ top\ntop - 08:31:43 up 17 min,  1 user,  load average: 0.00, 0.00, 0.02\nTasks: 128 total,   1 running,  69 sleeping,   0 stopped,   0 zombie\n%Cpu0  :  0.3 us,  0.3 sy,  0.0 ni, 66.8 id,  0.3 wa,  0.0 hi, 32.4 si,  0.0 st\n%Cpu1  :  0.0 us,  0.3 sy,  0.0 ni, 65.2 id,  0.0 wa,  0.0 hi, 34.5 si,  0.0 st\nKiB Mem :  8167040 total,  7234236 free,   358976 used,   573828 buff/cache\nKiB Swap:        0 total,        0 free,        0 used.  7560460 avail Mem\n\n  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n    9 root      20   0       0      0      0 S   7.0  0.0   0:00.48 ksoftirqd/0\n   18 root      20   0       0      0      0 S   6.9  0.0   0:00.56 ksoftirqd/1\n 2489 root      20   0  876896  38408  21520 S   0.3  0.5   0:01.50 docker-containe\n 3008 root      20   0   44536   3936   3304 R   0.3  0.0   0:00.09 top\n    1 root      20   0   78116   9000   6432 S   0.0  0.1   0:11.77 systemd\n ...\n</code></pre><p>ä» top çš„è¾“å‡ºä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ª CPU çš„è½¯ä¸­æ–­ä½¿ç”¨ç‡éƒ½è¶…è¿‡äº† 30%ï¼›è€Œ CPU ä½¿ç”¨ç‡æœ€é«˜çš„è¿›ç¨‹ï¼Œæ­£å¥½æ˜¯è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹ ksoftirqd/0 å’Œ ksoftirqd/1ã€‚</p><p>è™½ç„¶ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† ksoftirqd çš„åŸºæœ¬åŠŸèƒ½ï¼Œå¯ä»¥çŒœæµ‹æ˜¯å› ä¸ºå¤§é‡ç½‘ç»œæ”¶å‘ï¼Œå¼•èµ·äº† CPU ä½¿ç”¨ç‡å‡é«˜ï¼›ä½†å®ƒåˆ°åº•åœ¨æ‰§è¡Œä»€ä¹ˆé€»è¾‘ï¼Œæˆ‘ä»¬å´å¹¶ä¸çŸ¥é“ã€‚</p><p>å¯¹äºæ™®é€šè¿›ç¨‹ï¼Œæˆ‘ä»¬è¦è§‚å¯Ÿå…¶è¡Œä¸ºæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¯”å¦‚ straceã€pstackã€lsof ç­‰ç­‰ã€‚ä½†è¿™äº›å·¥å…·å¹¶ä¸é€‚åˆå†…æ ¸çº¿ç¨‹ï¼Œæ¯”å¦‚ï¼Œå¦‚æœä½ ç”¨ pstack ï¼Œæˆ–è€…é€šè¿‡ /proc/pid/stack æŸ¥çœ‹ ksoftirqd/0ï¼ˆè¿›ç¨‹å·ä¸º 9ï¼‰çš„è°ƒç”¨æ ˆæ—¶ï¼Œåˆ†åˆ«å¯ä»¥å¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p><pre><code>$ pstack 9\nCould not attach to target 9: Operation not permitted.\ndetach: No such process\n</code></pre><pre><code>$ cat /proc/9/stack\n[&lt;0&gt;] smpboot_thread_fn+0x166/0x170\n[&lt;0&gt;] kthread+0x121/0x140\n[&lt;0&gt;] ret_from_fork+0x35/0x40\n[&lt;0&gt;] 0xffffffffffffffff\n</code></pre><p>æ˜¾ç„¶ï¼Œpstack æŠ¥å‡ºçš„æ˜¯ä¸å…è®¸æŒ‚è½½è¿›ç¨‹çš„é”™è¯¯ï¼›è€Œ /proc/9/stack æ–¹å¼è™½ç„¶æœ‰è¾“å‡ºï¼Œä½†è¾“å‡ºä¸­å¹¶æ²¡æœ‰è¯¦ç»†çš„è°ƒç”¨æ ˆæƒ…å†µã€‚</p><p>é‚£è¿˜æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•ï¼Œæ¥è§‚å¯Ÿå†…æ ¸çº¿ç¨‹ ksoftirqd çš„è¡Œä¸ºå‘¢ï¼Ÿ</p><p>æ—¢ç„¶æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œè‡ªç„¶åº”è¯¥ç”¨åˆ°å†…æ ¸ä¸­æä¾›çš„æœºåˆ¶ã€‚å›é¡¾ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰ç”¨è¿‡çš„ CPU æ€§èƒ½å·¥å…·ï¼Œæˆ‘æƒ³ä½ è‚¯å®šè¿˜è®°å¾— perf ï¼Œè¿™ä¸ªå†…æ ¸è‡ªå¸¦çš„æ€§èƒ½å‰–æå·¥å…·ã€‚</p><p>perf å¯ä»¥å¯¹æŒ‡å®šçš„è¿›ç¨‹æˆ–è€…äº‹ä»¶è¿›è¡Œé‡‡æ ·ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ç”¨è°ƒç”¨æ ˆçš„å½¢å¼ï¼Œè¾“å‡ºæ•´ä¸ªè°ƒç”¨é“¾ä¸Šçš„æ±‡æ€»ä¿¡æ¯ã€‚ æˆ‘ä»¬ä¸å¦¨å°±ç”¨ perf ï¼Œæ¥è¯•ç€åˆ†æä¸€ä¸‹è¿›ç¨‹å·ä¸º 9 çš„ ksoftirqdã€‚</p><p>ç»§ç»­åœ¨ç»ˆç«¯ä¸€ä¸­ï¼Œæ‰§è¡Œä¸‹é¢çš„ perf record å‘½ä»¤ï¼›å¹¶æŒ‡å®šè¿›ç¨‹å· 9 ï¼Œä»¥ä¾¿è®°å½• ksoftirqd çš„è¡Œä¸º:</p><pre><code># é‡‡æ ·30såé€€å‡º\n$ perf record -a -g -p 9 -- sleep 30\n</code></pre><p>ç¨ç­‰ä¸€ä¼šå„¿ï¼Œåœ¨ä¸Šè¿°å‘½ä»¤ç»“æŸåï¼Œç»§ç»­æ‰§è¡Œ <code>perf report</code>å‘½ä»¤ï¼Œä½ å°±å¯ä»¥å¾—åˆ° perf çš„æ±‡æ€»æŠ¥å‘Šã€‚æŒ‰ä¸Šä¸‹æ–¹å‘é”®ä»¥åŠå›è½¦é”®ï¼Œå±•å¼€æ¯”ä¾‹æœ€é«˜çš„ ksoftirqd åï¼Œä½ å°±å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™ä¸ªè°ƒç”¨å…³ç³»é“¾å›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/73/01/73f5e9a9e510b9f3bf634c5e94e67801.png?wh=1494*1366\" alt=\"\"></p><p>ä»è¿™ä¸ªå›¾ä¸­ï¼Œä½ å¯ä»¥æ¸…æ¥šçœ‹åˆ° ksoftirqd æ‰§è¡Œæœ€å¤šçš„è°ƒç”¨è¿‡ç¨‹ã€‚è™½ç„¶ä½ å¯èƒ½ä¸å¤ªç†Ÿæ‚‰å†…æ ¸æºç ï¼Œä½†é€šè¿‡è¿™äº›å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´çœ‹å‡ºå®ƒçš„è°ƒç”¨æ ˆè¿‡ç¨‹ã€‚</p><ul>\n<li>\n<p>net_rx_action å’Œ netif_receive_skbï¼Œè¡¨æ˜è¿™æ˜¯æ¥æ”¶ç½‘ç»œåŒ…ï¼ˆrx è¡¨ç¤º receiveï¼‰ã€‚</p>\n</li>\n<li>\n<p>br_handle_frame ï¼Œè¡¨æ˜ç½‘ç»œåŒ…ç»è¿‡äº†ç½‘æ¡¥ï¼ˆbr è¡¨ç¤º bridgeï¼‰ã€‚</p>\n</li>\n<li>\n<p>br_nf_pre_routing ï¼Œè¡¨æ˜åœ¨ç½‘æ¡¥ä¸Šæ‰§è¡Œäº† netfilter çš„ PREROUTINGï¼ˆnf è¡¨ç¤º netfilterï¼‰ã€‚è€Œæˆ‘ä»¬å·²ç»çŸ¥é“ PREROUTING ä¸»è¦ç”¨æ¥æ‰§è¡Œ DNATï¼Œæ‰€ä»¥å¯ä»¥çŒœæµ‹è¿™é‡Œæœ‰ DNAT å‘ç”Ÿã€‚</p>\n</li>\n<li>\n<p>br_pass_frame_upï¼Œè¡¨æ˜ç½‘æ¡¥å¤„ç†åï¼Œå†äº¤ç»™æ¡¥æ¥çš„å…¶ä»–æ¡¥æ¥ç½‘å¡è¿›ä¸€æ­¥å¤„ç†ã€‚æ¯”å¦‚ï¼Œåœ¨æ–°çš„ç½‘å¡ä¸Šæ¥æ”¶ç½‘ç»œåŒ…ã€æ‰§è¡Œ netfilter è¿‡æ»¤è§„åˆ™ç­‰ç­‰ã€‚</p>\n</li>\n</ul><p>æˆ‘ä»¬çš„çŒœæµ‹å¯¹ä¸å¯¹å‘¢ï¼Ÿå®é™…ä¸Šï¼Œæˆ‘ä»¬æ¡ˆä¾‹æœ€å¼€å§‹ç”¨ Docker å¯åŠ¨äº†å®¹å™¨ï¼Œè€Œ Docker ä¼šè‡ªåŠ¨ä¸ºå®¹å™¨åˆ›å»ºè™šæ‹Ÿç½‘å¡ã€æ¡¥æ¥åˆ° docker0 ç½‘æ¡¥å¹¶é…ç½® NAT è§„åˆ™ã€‚è¿™ä¸€è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/72/70/72f2f1fa7a464e4465108d4eadcc1b70.png?wh=1244*1620\" alt=\"\"></p><p>å½“ç„¶äº†ï¼Œå‰é¢ perf report ç•Œé¢çš„è°ƒç”¨é“¾è¿˜å¯ä»¥ç»§ç»­å±•å¼€ã€‚ä½†å¾ˆä¸å¹¸ï¼Œæˆ‘çš„å±å¹•ä¸å¤Ÿå¤§ï¼Œå¦‚æœå±•å¼€æ›´å¤šçš„å±‚çº§ï¼Œæœ€åå‡ ä¸ªå±‚çº§ä¼šè¶…å‡ºå±å¹•èŒƒå›´ã€‚è¿™æ ·ï¼Œå³ä½¿æˆ‘ä»¬èƒ½çœ‹åˆ°å¤§éƒ¨åˆ†çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå´ä¹Ÿä¸èƒ½è¯´æ˜åé¢å±‚çº§å°±æ²¡é—®é¢˜ã€‚</p><p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œæ¥æŸ¥çœ‹æ•´ä¸ªè°ƒç”¨æ ˆçš„ä¿¡æ¯å‘¢ï¼Ÿ</p><h2>ç«ç„°å›¾</h2><p>é’ˆå¯¹ perf æ±‡æ€»æ•°æ®çš„å±•ç¤ºé—®é¢˜ï¼ŒBrendan Gragg å‘æ˜äº†<a href=\"http://www.brendangregg.com/flamegraphs.html\">ç«ç„°å›¾</a>ï¼Œé€šè¿‡çŸ¢é‡å›¾çš„å½¢å¼ï¼Œæ›´ç›´è§‚å±•ç¤ºæ±‡æ€»ç»“æœã€‚ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªé’ˆå¯¹ mysql çš„ç«ç„°å›¾ç¤ºä¾‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/68/61/68b80d299b23b0cee518001f78960f61.png?wh=1976*1184\" alt=\"\"></p><p>ï¼ˆå›¾ç‰‡æ¥è‡ª Brendan Gregg <a href=\"http://www.brendangregg.com/flamegraphs.html\">åšå®¢</a>ï¼‰</p><p>è¿™å¼ å›¾çœ‹èµ·æ¥åƒæ˜¯è·³åŠ¨çš„ç«ç„°ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¸ºç«ç„°å›¾ã€‚è¦ç†è§£ç«ç„°å›¾ï¼Œæˆ‘ä»¬æœ€é‡è¦çš„æ˜¯åŒºåˆ†æ¸…æ¥šæ¨ªè½´å’Œçºµè½´çš„å«ä¹‰ã€‚</p><ul>\n<li>\n<p><strong>æ¨ªè½´è¡¨ç¤ºé‡‡æ ·æ•°å’Œé‡‡æ ·æ¯”ä¾‹</strong>ã€‚ä¸€ä¸ªå‡½æ•°å ç”¨çš„æ¨ªè½´è¶Šå®½ï¼Œå°±ä»£è¡¨å®ƒçš„æ‰§è¡Œæ—¶é—´è¶Šé•¿ã€‚åŒä¸€å±‚çš„å¤šä¸ªå‡½æ•°ï¼Œåˆ™æ˜¯æŒ‰ç…§å­—æ¯æ¥æ’åºã€‚</p>\n</li>\n<li>\n<p><strong>çºµè½´è¡¨ç¤ºè°ƒç”¨æ ˆ</strong>ï¼Œç”±ä¸‹å¾€ä¸Šæ ¹æ®è°ƒç”¨å…³ç³»é€ä¸ªå±•å¼€ã€‚æ¢å¥è¯è¯´ï¼Œä¸Šä¸‹ç›¸é‚»çš„ä¸¤ä¸ªå‡½æ•°ä¸­ï¼Œä¸‹é¢çš„å‡½æ•°ï¼Œæ˜¯ä¸Šé¢å‡½æ•°çš„çˆ¶å‡½æ•°ã€‚è¿™æ ·ï¼Œè°ƒç”¨æ ˆè¶Šæ·±ï¼Œçºµè½´å°±è¶Šé«˜ã€‚</p>\n</li>\n</ul><p>å¦å¤–ï¼Œè¦æ³¨æ„å›¾ä¸­çš„é¢œè‰²ï¼Œå¹¶æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œåªæ˜¯ç”¨æ¥åŒºåˆ†ä¸åŒçš„å‡½æ•°ã€‚</p><p>ç«ç„°å›¾æ˜¯åŠ¨æ€çš„çŸ¢é‡å›¾æ ¼å¼ï¼Œæ‰€ä»¥å®ƒè¿˜æ”¯æŒä¸€äº›åŠ¨æ€ç‰¹æ€§ã€‚æ¯”å¦‚ï¼Œé¼ æ ‡æ‚¬åœåˆ°æŸä¸ªå‡½æ•°ä¸Šæ—¶ï¼Œå°±ä¼šè‡ªåŠ¨æ˜¾ç¤ºè¿™ä¸ªå‡½æ•°çš„é‡‡æ ·æ•°å’Œé‡‡æ ·æ¯”ä¾‹ã€‚è€Œå½“ä½ ç”¨é¼ æ ‡ç‚¹å‡»å‡½æ•°æ—¶ï¼Œç«ç„°å›¾å°±ä¼šæŠŠè¯¥å±‚åŠå…¶ä¸Šçš„å„å±‚æ”¾å¤§ï¼Œæ–¹ä¾¿ä½ è§‚å¯Ÿè¿™äº›å¤„äºç«ç„°å›¾é¡¶éƒ¨çš„è°ƒç”¨æ ˆçš„ç»†èŠ‚ã€‚</p><p>ä¸Šé¢ mysql ç«ç„°å›¾çš„ç¤ºä¾‹ï¼Œå°±è¡¨ç¤ºäº† CPU çš„ç¹å¿™æƒ…å†µï¼Œè¿™ç§ç«ç„°å›¾ä¹Ÿè¢«ç§°ä¸º on-CPU ç«ç„°å›¾ã€‚å¦‚æœæˆ‘ä»¬æ ¹æ®æ€§èƒ½åˆ†æçš„ç›®æ ‡æ¥åˆ’åˆ†ï¼Œç«ç„°å›¾å¯ä»¥åˆ†ä¸ºä¸‹é¢è¿™å‡ ç§ã€‚</p><ul>\n<li>\n<p><strong>on-CPU ç«ç„°å›¾</strong>ï¼šè¡¨ç¤º CPU çš„ç¹å¿™æƒ…å†µï¼Œç”¨åœ¨ CPU ä½¿ç”¨ç‡æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸­ã€‚</p>\n</li>\n<li>\n<p><strong>off-CPU ç«ç„°å›¾</strong>ï¼šè¡¨ç¤º CPU ç­‰å¾… I/Oã€é”ç­‰å„ç§èµ„æºçš„é˜»å¡æƒ…å†µã€‚</p>\n</li>\n<li>\n<p><strong>å†…å­˜ç«ç„°å›¾</strong>ï¼šè¡¨ç¤ºå†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æƒ…å†µã€‚</p>\n</li>\n<li>\n<p><strong>çƒ­/å†·ç«ç„°å›¾</strong>ï¼šè¡¨ç¤ºå°† on-CPU å’Œ off-CPU ç»“åˆåœ¨ä¸€èµ·ç»¼åˆå±•ç¤ºã€‚</p>\n</li>\n<li>\n<p><strong>å·®åˆ†ç«ç„°å›¾</strong>ï¼šè¡¨ç¤ºä¸¤ä¸ªç«ç„°å›¾çš„å·®åˆ†æƒ…å†µï¼Œçº¢è‰²è¡¨ç¤ºå¢é•¿ï¼Œè“è‰²è¡¨ç¤ºè¡°å‡ã€‚å·®åˆ†ç«ç„°å›¾å¸¸ç”¨æ¥æ¯”è¾ƒä¸åŒåœºæ™¯å’Œä¸åŒæ—¶æœŸçš„ç«ç„°å›¾ï¼Œä»¥ä¾¿åˆ†æç³»ç»Ÿå˜åŒ–å‰åå¯¹æ€§èƒ½çš„å½±å“æƒ…å†µã€‚</p>\n</li>\n</ul><p>äº†è§£äº†ç«ç„°å›¾çš„å«ä¹‰å’ŒæŸ¥çœ‹æ–¹æ³•åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†å›åˆ°æ¡ˆä¾‹ï¼Œè¿ç”¨ç«ç„°å›¾æ¥è§‚å¯Ÿåˆšæ‰ perf record å¾—åˆ°çš„è®°å½•ã€‚</p><h2>ç«ç„°å›¾åˆ†æ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆç«ç„°å›¾ã€‚æˆ‘ä»¬å…ˆä¸‹è½½å‡ ä¸ªèƒ½ä» perf record è®°å½•ç”Ÿæˆç«ç„°å›¾çš„å·¥å…·ï¼Œè¿™äº›å·¥å…·éƒ½æ”¾åœ¨ <a href=\"https://github.com/brendangregg/FlameGraph\">https://github.com/brendangregg/FlameGraph</a> ä¸Šé¢ã€‚ä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥ä¸‹è½½ï¼š</p><pre><code>$ git clone https://github.com/brendangregg/FlameGraph\n$ cd FlameGraph\n</code></pre><p>å®‰è£…å¥½å·¥å…·åï¼Œè¦ç”Ÿæˆç«ç„°å›¾ï¼Œå…¶å®ä¸»è¦éœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol>\n<li>\n<p>æ‰§è¡Œ perf script ï¼Œå°† perf record çš„è®°å½•è½¬æ¢æˆå¯è¯»çš„é‡‡æ ·è®°å½•ï¼›</p>\n</li>\n<li>\n<p>æ‰§è¡Œ stackcollapse-perf.pl è„šæœ¬ï¼Œåˆå¹¶è°ƒç”¨æ ˆä¿¡æ¯ï¼›</p>\n</li>\n<li>\n<p>æ‰§è¡Œ flamegraph.pl è„šæœ¬ï¼Œç”Ÿæˆç«ç„°å›¾ã€‚</p>\n</li>\n</ol><p>ä¸è¿‡ï¼Œåœ¨ Linux ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç®¡é“ï¼Œæ¥ç®€åŒ–è¿™ä¸‰ä¸ªæ­¥éª¤çš„æ‰§è¡Œè¿‡ç¨‹ã€‚å‡è®¾åˆšæ‰ç”¨ perf record ç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„ä¸º /root/perf.dataï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½ å°±å¯ä»¥ç›´æ¥ç”Ÿæˆç«ç„°å›¾ï¼š</p><pre><code>$ perf script -i /root/perf.data | ./stackcollapse-perf.pl --all |  ./flamegraph.pl &gt; ksoftirqd.svg\n</code></pre><p>æ‰§è¡ŒæˆåŠŸåï¼Œä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ ksoftirqd.svg ï¼Œä½ å°±å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ç«ç„°å›¾äº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/6d/cd/6d4f1fece12407906aacedf5078e53cd.png?wh=2370*1360\" alt=\"\"></p><p>æ ¹æ®åˆšåˆšè®²è¿‡çš„ç«ç„°å›¾åŸç†ï¼Œè¿™ä¸ªå›¾åº”è¯¥ä»ä¸‹å¾€ä¸Šçœ‹ï¼Œæ²¿ç€è°ƒç”¨æ ˆä¸­æœ€å®½çš„å‡½æ•°æ¥åˆ†ææ‰§è¡Œæ¬¡æ•°æœ€å¤šçš„å‡½æ•°ã€‚è¿™å„¿çœ‹åˆ°çš„ç»“æœï¼Œå…¶å®è·Ÿåˆšæ‰çš„ perf report ç±»ä¼¼ï¼Œä½†ç›´è§‚äº†å¾ˆå¤šï¼Œä¸­é—´è¿™ä¸€å›¢ç«ï¼Œå¾ˆæ˜æ˜¾å°±æ˜¯æœ€éœ€è¦æˆ‘ä»¬å…³æ³¨çš„åœ°æ–¹ã€‚</p><p>æˆ‘ä»¬é¡ºç€è°ƒç”¨æ ˆç”±ä¸‹å¾€ä¸Šçœ‹ï¼ˆé¡ºç€å›¾ä¸­è“è‰²ç®­å¤´ï¼‰ï¼Œå°±å¯ä»¥å¾—åˆ°è·Ÿåˆšæ‰ perf report ä¸­ä¸€æ ·çš„ç»“æœï¼š</p><ul>\n<li>\n<p>æœ€å¼€å§‹ï¼Œè¿˜æ˜¯ net_rx_action åˆ° netif_receive_skb å¤„ç†ç½‘ç»œæ”¶åŒ…ï¼›</p>\n</li>\n<li>\n<p>ç„¶åï¼Œ br_handle_frame åˆ° br_nf_pre_routing ï¼Œåœ¨ç½‘æ¡¥ä¸­æ¥æ”¶å¹¶æ‰§è¡Œ netfilter é’©å­å‡½æ•°ï¼›</p>\n</li>\n<li>\n<p>å†å‘ä¸Šï¼Œ br_pass_frame_up åˆ° netif_receive_skb ï¼Œä»ç½‘æ¡¥è½¬åˆ°å…¶ä»–ç½‘ç»œè®¾å¤‡åˆä¸€æ¬¡æ¥æ”¶ã€‚</p>\n</li>\n</ul><p>ä¸è¿‡æœ€åï¼Œåˆ°äº† ip_forward è¿™é‡Œï¼Œå·²ç»çœ‹ä¸æ¸…å‡½æ•°åç§°äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç‚¹å‡» ip_forwardï¼Œå±•å¼€æœ€ä¸Šé¢è¿™ä¸€å—è°ƒç”¨æ ˆï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/41/a3/416291ba2f9c039a0507f913572a21a3.png?wh=2388*1374\" alt=\"\"></p><p>è¿™æ ·ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥çœ‹åˆ° ip_forward åçš„è¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯æŠŠç½‘ç»œåŒ…å‘é€å‡ºå»ã€‚æ ¹æ®è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹ï¼Œå†ç»“åˆæˆ‘ä»¬å‰é¢å­¦ä¹ çš„ç½‘ç»œæ”¶å‘å’Œ TCP/IP åè®®æ ˆåŸç†ï¼Œè¿™ä¸ªæµç¨‹ä¸­çš„ç½‘ç»œæ¥æ”¶ã€ç½‘æ¡¥ä»¥åŠ netfilter è°ƒç”¨ç­‰ï¼Œéƒ½æ˜¯å¯¼è‡´è½¯ä¸­æ–­ CPU å‡é«˜çš„é‡è¦å› ç´ ï¼Œä¹Ÿå°±æ˜¯å½±å“ç½‘ç»œæ€§èƒ½çš„æ½œåœ¨ç“¶é¢ˆã€‚</p><p>ä¸è¿‡ï¼Œå›æƒ³ä¸€ä¸‹ç½‘ç»œæ”¶å‘çš„æµç¨‹ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—å®ƒç¼ºäº†å¥½å¤šæ­¥éª¤ã€‚</p><p>æ¯”å¦‚ï¼Œè¿™ä¸ªå †æ ˆä¸­å¹¶æ²¡æœ‰ TCP ç›¸å…³çš„è°ƒç”¨ï¼Œä¹Ÿæ²¡æœ‰è¿æ¥è·Ÿè¸ª conntrack ç›¸å…³çš„å‡½æ•°ã€‚å®é™…ä¸Šï¼Œè¿™äº›æµç¨‹éƒ½åœ¨å…¶ä»–æ›´å°çš„ç«ç„°ä¸­ï¼Œä½ å¯ä»¥ç‚¹å‡»ä¸Šå›¾å·¦ä¸Šè§’çš„â€œReset Zoomâ€ï¼Œå›åˆ°å®Œæ•´ç«ç„°å›¾ä¸­ï¼Œå†å»æŸ¥çœ‹å…¶ä»–å°ç«ç„°çš„å †æ ˆã€‚</p><p>æ‰€ä»¥ï¼Œåœ¨ç†è§£è¿™ä¸ªè°ƒç”¨æ ˆæ—¶è¦æ³¨æ„ã€‚ä»ä»»ä½•ä¸€ä¸ªç‚¹å‡ºå‘ã€çºµå‘æ¥çœ‹çš„æ•´ä¸ªè°ƒç”¨æ ˆï¼Œå…¶å®åªæ˜¯æœ€é¡¶ç«¯é‚£ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨å †æ ˆï¼Œè€Œéå®Œæ•´çš„å†…æ ¸ç½‘ç»œæ‰§è¡Œæµç¨‹ã€‚</p><p>å¦å¤–ï¼Œæ•´ä¸ªç«ç„°å›¾ä¸åŒ…å«ä»»ä½•æ—¶é—´çš„å› ç´ ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½çœ‹å‡ºæ¨ªå‘å„ä¸ªå‡½æ•°çš„æ‰§è¡Œæ¬¡åºã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±æ‰¾å‡ºäº†å†…æ ¸çº¿ç¨‹ ksoftirqd æ‰§è¡Œæœ€é¢‘ç¹çš„å‡½æ•°è°ƒç”¨å †æ ˆï¼Œè€Œè¿™ä¸ªå †æ ˆä¸­çš„å„å±‚çº§å‡½æ•°ï¼Œå°±æ˜¯æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆæ¥æºã€‚è¿™æ ·ï¼Œåé¢æƒ³è¦è¿›ä¸€æ­¥åˆ†æã€ä¼˜åŒ–æ—¶ï¼Œä¹Ÿå°±æœ‰äº†æ ¹æ®ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—æ¯”è¾ƒç†Ÿæ‚‰ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ¡ˆä¾‹ï¼Œæ­£æ˜¯æˆ‘ä»¬ä¸“æ  CPU æ¨¡å—ä¸­çš„  <a href=\"https://time.geekbang.org/column/article/72147\">è½¯ä¸­æ–­æ¡ˆä¾‹</a>ã€‚</p><p>å½“æ—¶ï¼Œæˆ‘ä»¬ä»è½¯ä¸­æ–­ CPU ä½¿ç”¨ç‡çš„è§’åº¦å…¥æ‰‹ï¼Œç”¨ç½‘ç»œæŠ“åŒ…çš„æ–¹æ³•æ‰¾å‡ºäº†ç“¶é¢ˆæ¥æºï¼Œç¡®è®¤æ˜¯æµ‹è¯•æœºå™¨å‘é€çš„å¤§é‡ SYN åŒ…å¯¼è‡´çš„ã€‚è€Œé€šè¿‡ä»Šå¤©çš„ perf å’Œç«ç„°å›¾æ–¹æ³•ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥æ‰¾å‡ºäº†è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹çš„çƒ­ç‚¹å‡½æ•°ï¼Œå…¶å®ä¹Ÿå°±æ‰¾å‡ºäº†æ½œåœ¨çš„ç“¶é¢ˆå’Œä¼˜åŒ–æ–¹å‘ã€‚</p><p>å…¶å®ï¼Œå¦‚æœé‡åˆ°çš„æ˜¯å†…æ ¸çº¿ç¨‹çš„èµ„æºä½¿ç”¨å¼‚å¸¸ï¼Œå¾ˆå¤šå¸¸ç”¨çš„è¿›ç¨‹çº§æ€§èƒ½å·¥å…·å¹¶ä¸èƒ½å¸®ä¸Šå¿™ã€‚è¿™æ—¶ï¼Œä½ å°±å¯ä»¥ç”¨å†…æ ¸è‡ªå¸¦çš„ perf æ¥è§‚å¯Ÿå®ƒä»¬çš„è¡Œä¸ºï¼Œæ‰¾å‡ºçƒ­ç‚¹å‡½æ•°ï¼Œè¿›ä¸€æ­¥å®šä½æ€§èƒ½ç“¶ã€‚å½“ç„¶ï¼Œperf äº§ç”Ÿçš„æ±‡æ€»æŠ¥å‘Šå¹¶ä¸å¤Ÿç›´è§‚ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ¨èä½ ç”¨ç«ç„°å›¾æ¥ååŠ©æ’æŸ¥ã€‚</p><p>å®é™…ä¸Šï¼Œç«ç„°å›¾æ–¹æ³•åŒæ ·é€‚ç”¨äºæ™®é€šè¿›ç¨‹ã€‚æ¯”å¦‚ï¼Œåœ¨åˆ†æ Nginxã€MySQL ç­‰å„ç§åº”ç”¨åœºæ™¯çš„æ€§èƒ½é—®é¢˜æ—¶ï¼Œç«ç„°å›¾ä¹Ÿèƒ½å¸®ä½ æ›´å¿«å®šä½çƒ­ç‚¹å‡½æ•°ï¼Œæ‰¾å‡ºæ½œåœ¨æ€§èƒ½é—®é¢˜ã€‚</p><h2>æ€è€ƒ</h2><p>æœ€åï¼Œæˆ‘æƒ³é‚€è¯·ä½ ä¸€èµ·æ¥èŠèŠï¼Œä½ ç¢°åˆ°è¿‡çš„å†…æ ¸çº¿ç¨‹æ€§èƒ½é—®é¢˜ã€‚ä½ æ˜¯æ€ä¹ˆåˆ†æå®ƒä»¬çš„æ ¹æºï¼Ÿåˆæ˜¯æ€ä¹ˆè§£å†³çš„ï¼Ÿä½ å¯ä»¥ç»“åˆæˆ‘çš„è®²è¿°ï¼Œæ€»ç»“è‡ªå·±çš„æ€è·¯ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå’Œæˆ‘è®¨è®ºï¼Œä¹Ÿæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„åŒäº‹ã€æœ‹å‹ã€‚æˆ‘ä»¬ä¸€èµ·åœ¨å®æˆ˜ä¸­æ¼”ç»ƒï¼Œåœ¨äº¤æµä¸­è¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"48 | æ¡ˆä¾‹ç¯‡ï¼šæœåŠ¡å™¨æ€»æ˜¯æ—¶ä¸æ—¶ä¸¢åŒ…ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿï¼ˆä¸‹ï¼‰","id":85688},"right":{"article_title":"50 | æ¡ˆä¾‹ç¯‡ï¼šåŠ¨æ€è¿½è¸ªæ€ä¹ˆç”¨ï¼Ÿï¼ˆä¸Šï¼‰","id":86490}},"comments":[{"had_liked":false,"id":82010,"user_name":"æé€é¥","can_delete":false,"product_type":"c1","uid":1109750,"ip_address":"","ucode":"DB74823527E203","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/xzHDjCSFicNY3MUMECtNz6sM8yDJhBoyGk5IRoOtUat6ZIkGzxjqEqwqKYWMD3GjehScKvMjicGOGDog5FF18oyg/132","comment_is_top":false,"comment_ctime":1554102137,"is_pvip":false,"replies":[{"id":"29831","content":"ç«ç„°å›¾çš„ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å‡½æ•°å †æ ˆä¸ä¸€æ ·ï¼Œå†…å­˜ç«ç„°å›¾ä¾§é‡äºå†…å­˜ç®¡ç†å‡½æ•°çš„è°ƒç”¨æ ˆ","user_name":"ä½œè€…å›å¤","comment_id":82010,"uid":"1001282","ip_address":"","utype":1,"ctime":1554209408,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"31618873209","product_id":100020901,"comment_content":"cpuç«ç„°å›¾å’Œå†…å­˜ç«ç„°å›¾ï¼Œåœ¨ç”Ÿæˆæ•°æ®æ—¶æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445427,"discussion_content":"ç«ç„°å›¾çš„ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å‡½æ•°å †æ ˆä¸ä¸€æ ·ï¼Œå†…å­˜ç«ç„°å›¾ä¾§é‡äºå†…å­˜ç®¡ç†å‡½æ•°çš„è°ƒç”¨æ ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554209408,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":82560,"user_name":"æé€é¥","can_delete":false,"product_type":"c1","uid":1109750,"ip_address":"","ucode":"DB74823527E203","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/xzHDjCSFicNY3MUMECtNz6sM8yDJhBoyGk5IRoOtUat6ZIkGzxjqEqwqKYWMD3GjehScKvMjicGOGDog5FF18oyg/132","comment_is_top":false,"comment_ctime":1554251967,"is_pvip":false,"replies":[{"id":"30195","content":"è¦åŠ ä¸Šå†…å­˜ç®¡ç†ç›¸å…³çš„äº‹ä»¶ï¼ˆå‡½æ•°ï¼‰ï¼Œæ¯”å¦‚perf record -e syscalls:sys_enter_mmap -a -g -- sleep 60","user_name":"ä½œè€…å›å¤","comment_id":82560,"uid":"1001282","ip_address":"","utype":1,"ctime":1554639382,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"23029088447","product_id":100020901,"comment_content":"è€å¸ˆï¼Œèƒ½è®²è®²å†…å­˜ç«ç„°å›¾ç”Ÿæˆperf.dataæ•°æ®æ—¶,perf recordåŠ å“ªäº›é€‰é¡¹å—ï¼Ÿ","like_count":6,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":445638,"discussion_content":"è¦åŠ ä¸Šå†…å­˜ç®¡ç†ç›¸å…³çš„äº‹ä»¶ï¼ˆå‡½æ•°ï¼‰ï¼Œæ¯”å¦‚perf record -e syscalls:sys_enter_mmap -a -g -- sleep 60","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1554639382,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174255,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1580110535,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"18759979719","product_id":100020901,"comment_content":"æ¨ªè½´çš„é•¿çŸ­ä»£è¡¨æ‰§è¡Œæ—¶é—´é•¿çŸ­ï¼Œä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨å¤šæ¬¡é‚£æ¨ªè½´å¾ˆé•¿ï¼Œä¸€ä¸ªå‡½æ•°æ‰§è¡Œä¸€æ¬¡ä½†æ˜¯åœ¨é‡Œé¢ä¼‘çœ äº†ï¼Œè¿™ç®—æ‰§è¡Œæ—¶é—´å¾ˆé•¿å—ï¼Ÿon-cpuç«ç„°å›¾æ˜¯ä¸æ˜¯åªè®°å½•çœŸæ­£çš„åœ¨cpuä¸Šçš„æ‰§è¡Œæ—¶é—´è€Œä¸æŠŠç¡çœ æ—¶é—´ç®—åœ¨å†…ï¼Ÿ","like_count":5},{"had_liked":false,"id":78716,"user_name":"é’çŸ³","can_delete":false,"product_type":"c1","uid":1215531,"ip_address":"","ucode":"B0056AD6453322","user_header":"https://static001.geekbang.org/account/avatar/00/12/8c/2b/3ab96998.jpg","comment_is_top":false,"comment_ctime":1553223721,"is_pvip":false,"replies":[{"id":"28746","content":"å†…æ ¸é‡Œé¢å…¶å®å°±æä¾›äº†å¾ˆå¤šå·¥å…·ï¼Œå¯ä»¥å‚è€ƒä¸‹50å’Œ51ç¯‡ä¸­çš„åŠ¨æ€è¿½è¸ªæ–¹æ³•","user_name":"ä½œè€…å›å¤","comment_id":78716,"uid":"1001282","ip_address":"","utype":1,"ctime":1553316460,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"10143158313","product_id":100020901,"comment_content":"ä¸¤å‘¨æ—¶é—´ï¼Œç»ˆäºè¿½ä¸Šæ¥äº†ã€‚<br><br>è¯·é—®è€å¸ˆï¼Œæœ‰å“ªäº›ä¹¦æœ‰åŠ©äºé€šè¿‡å†…æ ¸å‡½æ•°æ¥å®šä½æ•…éšœï¼ŒLinuxç”¨äº†9å¹´ï¼Œçœ‹åˆ°è¿™è¿˜æ˜¯æ„Ÿè§‰æœ‰äº›åƒåŠ›ã€‚<br><br>å†…æ ¸çº¿ç¨‹é—®é¢˜ï¼Œæˆ‘çš„ç¯å¢ƒå’Œè€å¸ˆçš„æœ‰äº›åŒºåˆ«ï¼Œæ²¡æœ‰br_nf_pre_routingå‡½æ•°è°ƒç”¨ï¼Œä½†æ˜¯ä»ip_forwardæ¨æµ‹ä¸æ¶ˆæ¯è½¬å‘æœ‰å…³ï¼Œsarå‘ç°æœ‰å¤§é‡å°åŒ…æ¥æ”¶ï¼Œconntrack -Lçœ‹åˆ°å¤§é‡æœ¬æœºåˆ°dockeråœ°å€çš„SYN_SENTçŠ¶æ€çš„è¿æ¥ã€hping3æœåŠ¡å™¨åˆ°æµ‹è¯•æœåŠ¡å™¨çš„SYN_RECVçŠ¶æ€è¿æ¥ã€‚åˆæ­¥å®šä½åˆ°å…·ä½“çš„dockerã€‚<br><br>ä¸Šé¢æ€è€ƒçš„è¿‡ç¨‹ï¼Œæœ‰ç‚¹å› ä¸ºçŸ¥é“é—®é¢˜ç‚¹ï¼Œæ‰€ä»¥æœè¿™ä¸ªæ–¹å‘èµ°çš„æ„Ÿè§‰ã€‚","like_count":3,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":444204,"discussion_content":"å†…æ ¸é‡Œé¢å…¶å®å°±æä¾›äº†å¾ˆå¤šå·¥å…·ï¼Œå¯ä»¥å‚è€ƒä¸‹50å’Œ51ç¯‡ä¸­çš„åŠ¨æ€è¿½è¸ªæ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1553316460,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77450,"user_name":"è¡Œè€…","can_delete":false,"product_type":"c1","uid":1063734,"ip_address":"","ucode":"EA31201A7C5AE1","user_header":"https://static001.geekbang.org/account/avatar/00/10/3b/36/2d61e080.jpg","comment_is_top":false,"comment_ctime":1552928084,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5847895380","product_id":100020901,"comment_content":"å¾ˆèµï¼Œå‡†å¤‡å›å»ç”¨ç«ç„°å›¾åˆ†æä¸‹æˆ‘ä»¬åç«¯æœåŠ¡ã€‚^â€†_â€†^","like_count":1},{"had_liked":false,"id":77255,"user_name":"2xshu","can_delete":false,"product_type":"c1","uid":1188473,"ip_address":"","ucode":"71584CB9676EDF","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKsz8j0bAayjSne9iakvjzUmvUdxWEbsM9iasQ74spGFayIgbSE232sH2LOWmaKtx1WqAFDiaYgVPwIQ/132","comment_is_top":false,"comment_ctime":1552898555,"is_pvip":false,"replies":[{"id":"28162","content":"ä¸æ˜¯ï¼Œçœ‹åŸæ¥çš„ç›®å½•ï¼Œè¿˜æœ‰å¥½äº›ç¯‡","user_name":"ä½œè€…å›å¤","comment_id":77255,"uid":"1001282","ip_address":"","utype":1,"ctime":1552903829,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"5847865851","product_id":100020901,"comment_content":"è€å¸ˆï¼Œè¿™æ˜¯æœ€åä¸€èŠ‚è¯¾ç¨‹å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443658,"discussion_content":"ä¸æ˜¯ï¼Œçœ‹åŸæ¥çš„ç›®å½•ï¼Œè¿˜æœ‰å¥½äº›ç¯‡","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552903829,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":345149,"user_name":"Geek_1b7d36","can_delete":false,"product_type":"c1","uid":2247772,"ip_address":"","ucode":"A003032EAD0CFD","user_header":"","comment_is_top":false,"comment_ctime":1652079522,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652079522","product_id":100020901,"comment_content":"topå‘ç°load average : 2270.00  ,2270.26,  2270.26,<br>ä½†æ˜¯cpuä½¿ç”¨ç‡ä¸è¶…è¿‡10% ï¼Œ32C64Gçš„æœºå™¨ï¼Œå…¶ä»–çš„è¿›ç¨‹çš„CPUå¾ˆä½ï¼Œå°±æ˜¯è¿™ä¸ªè´Ÿè½½å¾ˆé«˜ï¼Œè¿™ä¸ªæ€ä¹ˆæ’æŸ¥å‘¢ï¼Œè€å¸ˆ","like_count":0},{"had_liked":false,"id":333037,"user_name":"æ— ","can_delete":false,"product_type":"c1","uid":1015918,"ip_address":"","ucode":"CF9F79815606F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/80/6e/7f78292e.jpg","comment_is_top":false,"comment_ctime":1644018278,"is_pvip":true,"replies":[{"id":"121728","content":"å¯ä»¥ç”¨ ebpf è·Ÿè¸ªè°ƒç”¨æ ˆ","user_name":"ä½œè€…å›å¤","comment_id":333037,"uid":"1001282","ip_address":"","utype":1,"ctime":1644116428,"user_name_real":"ç¼–è¾‘"}],"discussion_count":1,"race_medal":0,"score":"1644018278","product_id":100020901,"comment_content":"è¯·é—®æœ‰æ²¡æœ‰å¯ä»¥è¡¨ç¤ºè°ƒç”¨é¡ºåºçš„ç«ç„°å›¾? æˆ–è€…ç±»ä¼¼çš„å…¶å®ƒå›¾??? æ„Ÿè§‰è¿™æ ·æ›´æœ‰ç”¨é˜¿","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549585,"discussion_content":"å¯ä»¥ç”¨ ebpf è·Ÿè¸ªè°ƒç”¨æ ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644116429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316351,"user_name":"AceslupK","can_delete":false,"product_type":"c1","uid":1284474,"ip_address":"","ucode":"048F84D019CBBB","user_header":"https://static001.geekbang.org/account/avatar/00/13/99/7a/558666a5.jpg","comment_is_top":false,"comment_ctime":1634281547,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1634281547","product_id":100020901,"comment_content":"æ­¤å¤„ç«ç„°å›¾ï¼ŒåƒåŠ›äº†ã€‚ä¾æ—§è¿˜æ˜¯æ²¡çœ‹æ˜ç™½è¯¥æ€ä¹ˆæ‰¾å‡ºæœªçŸ¥é—®é¢˜ï¼Œè¿˜æ˜¯è§‰å¾—è¿™æ¬¡æ˜¯æœ‰ç€æ–¹å‘çš„è§£å†³é—®é¢˜","like_count":0},{"had_liked":false,"id":301642,"user_name":"opdozz","can_delete":false,"product_type":"c1","uid":2641975,"ip_address":"","ucode":"25E81DC87D6213","user_header":"","comment_is_top":false,"comment_ctime":1625796638,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1625796638","product_id":100020901,"comment_content":"è€å¸ˆï¼Œæœ€è¿‘ç¢°åˆ°ä¸€ä¸ªkworkerå†…æ ¸è¿›ç¨‹é—®é¢˜ï¼Œ48Cçš„æœåŠ¡å™¨ï¼Œdockerå®¿ä¸»æœºï¼Œ æŸä¸ªkworkerä¼šå æ»¡ä¸¤ä¸ªCPUï¼Œä¸€ä¸ªsysè·‘æ»¡ï¼Œå¦å¤–ä¸€ä¸ªiowaitè·‘æ»¡ï¼Œå‰©ä¸‹çš„CPUéƒ½å¾ˆç©ºé—²ï¼Œä½†æ˜¯ä¸šåŠ¡å¤„ç†å¾ˆæ…¢ï¼Œé‡å¯ä¹‹åå°±å¥½äº†ï¼Œä½†æ˜¯è¿‡æ®µæ—¶é—´åˆå¤å‘ï¼Œ ä¸è§„å¾‹ã€‚<br>perfæ”¶é›†äº†ä¿¡æ¯ï¼Œ__rpc_execute è¿™ä¸ªè°ƒç”¨å äº†å¾ˆå¤šï¼Œä¸‹å±‚nfs4_xdr_enc_openè°ƒç”¨ä¹Ÿå äº†å¾ˆå¤šï¼Œå’ŒæŒ‚çš„naså­˜å‚¨æœ‰å…³ç³»å—ï¼Œä½†æ˜¯å­˜å‚¨é‚£è¾¹æ’æŸ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚","like_count":1},{"had_liked":false,"id":268609,"user_name":"Geek_c2089d","can_delete":false,"product_type":"c1","uid":1489545,"ip_address":"","ucode":"C66D345042525F","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/4Lprf2mIWpJOPibgibbFCicMtp5bpIibyLFOnyOhnBGbusrLZC0frG0FGWqdcdCkcKunKxqiaOHvXbCFE7zKJ8TmvIA/132","comment_is_top":false,"comment_ctime":1608272841,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1608272841","product_id":100020901,"comment_content":"æ‰§è¡Œ  <br>perf script -i &#47;root&#47;perf.data | .&#47;stackcollapse-perf.pl --all |  .&#47;flamegraph.pl &gt; ksoftirqd.svg<br>ä¼šæŠ¥ERROR: No stack counts foundé”™è¯¯ï¼Œä½†æ˜¯æƒé™æ˜¯éƒ½777çš„","like_count":0,"discussions":[{"author":{"id":2104708,"avatar":"https://static001.geekbang.org/account/avatar/00/20/1d/84/c35e492e.jpg","nickname":"é£æ¸…æ‰¬","note":"","ucode":"0505791F8EA497","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574877,"discussion_content":"æ˜¯å› ä¸ºä½ çš„perfçš„pidé‡Œé¢æ²¡æœ‰å‡½æ•°å¯¹æ ˆï¼Œæˆ‘çŒœæƒ³ä½ åº”è¯¥ä¸æ˜¯æŠ“å–äº†ä¸€ä¸ªæ­£å¸¸çš„æœ‰æ•°æ®è¯·æ±‚çš„è¿›ç¨‹å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1654416390,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":190970,"user_name":"è‘£çš‹","can_delete":false,"product_type":"c1","uid":1902756,"ip_address":"","ucode":"2F05C3DDBC18F7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJGMphabeneYRlxs1biaO9oKic6Dwgbe312561lE56V93uUHgXXAsGmK1pH18mvpElygoJh8SUtQPUA/132","comment_is_top":false,"comment_ctime":1584714765,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1584714765","product_id":100020901,"comment_content":"æ‰“å¡","like_count":0},{"had_liked":false,"id":155848,"user_name":"Littlesoup","can_delete":false,"product_type":"c1","uid":1502232,"ip_address":"","ucode":"CA1A3AFE0B25D6","user_header":"","comment_is_top":false,"comment_ctime":1574766878,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574766878","product_id":100020901,"comment_content":"&quot;ä¸€ä¸ªå‡½æ•°å ç”¨çš„æ¨ªè½´è¶Šå®½ï¼Œå°±ä»£è¡¨å®ƒçš„æ‰§è¡Œæ—¶é—´è¶Šé•¿ã€‚&quot;<br>&quot;å¦å¤–ï¼Œæ•´ä¸ªç«ç„°å›¾ä¸åŒ…å«ä»»ä½•æ—¶é—´çš„å› ç´ ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½çœ‹å‡ºæ¨ªå‘å„ä¸ªå‡½æ•°çš„æ‰§è¡Œæ¬¡åºã€‚&quot;<br>åŸæ–‡è¿™ä¸¤å¥è¯è¯»èµ·æ¥æœ‰ç‚¹å›°æƒ‘ï¼Œç¬¬äºŒå¥çš„æ„æ€æ˜¯ä¸æ˜¯ä¸åŒ…å«ä»»ä½•æ—¶åºçš„å› ç´ ï¼Ÿ","like_count":0},{"had_liked":false,"id":141084,"user_name":"ä¹–ï¼Œæ‘¸æ‘¸å¤´","can_delete":false,"product_type":"c1","uid":1611745,"ip_address":"","ucode":"BD92741A11D3CD","user_header":"https://static001.geekbang.org/account/avatar/00/18/97/e1/0f4d90ff.jpg","comment_is_top":false,"comment_ctime":1571111415,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1571111415","product_id":100020901,"comment_content":"ä¸ºå•¥æˆ‘çš„ä¸€å€¼éƒ½æ˜¯æ˜¾ç¤ºçš„16è¿›åˆ¶è€Œä¸æ˜¯å‡½æ•°å","like_count":0},{"had_liked":false,"id":86925,"user_name":"å¦‚æœ","can_delete":false,"product_type":"c1","uid":1320638,"ip_address":"","ucode":"138A3EEEE50850","user_header":"","comment_is_top":false,"comment_ctime":1555479940,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1555479940","product_id":100020901,"comment_content":"DAY49ï¼Œæ‰“å¡<br>","like_count":0},{"had_liked":false,"id":77197,"user_name":"æˆ‘æ¥ä¹Ÿ","can_delete":false,"product_type":"c1","uid":1205253,"ip_address":"","ucode":"773D6104F56767","user_header":"https://static001.geekbang.org/account/avatar/00/12/64/05/6989dce6.jpg","comment_is_top":false,"comment_ctime":1552881799,"is_pvip":false,"replies":[{"id":"28160","content":"å—¯å—¯ Goå†…ç½®äº†pprof å·¥å…·ï¼Œç”¨èµ·æ¥æ›´ç®€å•","user_name":"ä½œè€…å›å¤","comment_id":77197,"uid":"1001282","ip_address":"","utype":1,"ctime":1552903478,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1552881799","product_id":100020901,"comment_content":"[D49æ‰“å¡]<br>ä¹‹å‰ç”¨ç«ç„°å›¾åˆ†æè¿‡golangç¨‹åºçš„å†…å­˜åˆ†é…åŠcpuä½¿ç”¨ç‡æƒ…å†µ.æ„Ÿè§‰éå¸¸ç›´è§‚.èƒ½å¿«é€Ÿæ‰¾åˆ°ç“¶é¢ˆ.","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443633,"discussion_content":"å—¯å—¯ Goå†…ç½®äº†pprof å·¥å…·ï¼Œç”¨èµ·æ¥æ›´ç®€å•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552903478,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":77136,"user_name":"ninuxer","can_delete":false,"product_type":"c1","uid":1243135,"ip_address":"","ucode":"5394ADAF2667D6","user_header":"https://wx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKQMM4m7NHuicr55aRiblTSEWIYe0QqbpyHweaoAbG7j2v7UUElqqeP3Ihrm3UfDPDRb1Hv8LvPwXqA/132","comment_is_top":false,"comment_ctime":1552867778,"is_pvip":false,"replies":[{"id":"28156","content":"å—¯å—¯","user_name":"ä½œè€…å›å¤","comment_id":77136,"uid":"1001282","ip_address":"","utype":1,"ctime":1552903018,"user_name_real":"å€ªæœ‹é£"}],"discussion_count":1,"race_medal":0,"score":"1552867778","product_id":100020901,"comment_content":"æ‰“å¡day52<br>æœ‰ç¢°åˆ°ä¸€ä¸ªå†…æ ¸é—®é¢˜ï¼Œdockerå®¿ä¸»æœºä¸Škworker&#47;u80è¿›ç¨‹çš„cpuå ç”¨ç‡ä¸€ç›´100%ï¼Œå…¶ä»–çš„kworkerè¿›ç¨‹éƒ½æ­£å¸¸ï¼Œæ¯éš”å‡ ä¸ªæœˆå°±ä¼šç¢°åˆ°ä¸€æ¬¡ï¼Œä¸ºäº†å¿«é€Ÿæ¢å¤ä¸šåŠ¡ï¼Œå°±ç›´æ¥é‡å¯äº†ï¼Œä¸»è¦æ˜¯æ²¡åŠæ³•åœ¨çº¿ä¸‹å®éªŒçš„æ—¶å€™å¤ç°é—®é¢˜ï¼Œæ‰€ä»¥å°±æ²¡æœ‰æ·±å…¥çš„åˆ†æï¼Œåé¢ç¢°åˆ°åï¼Œå¯ä»¥ç”¨è€å¸ˆçš„æ–¹æ³•ï¼ŒæŠŠperf recordé‡‡é›†ä¸€æ®µæ—¶é—´çš„è°ƒç”¨ä¿¡æ¯ï¼Œç„¶åæ‹¿å‡ºå»åˆ†æä¸‹ğŸ‘","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"å€ªæœ‹é£","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":443598,"discussion_content":"å—¯å—¯","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1552903018,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}