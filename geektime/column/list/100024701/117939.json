{"id":117939,"title":"61 | æ­å»ºæ“ä½œç³»ç»Ÿå®éªŒç¯å¢ƒï¼ˆä¸‹ï¼‰ï¼šæˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”","content":"<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬åšäº†ä¸€ä¸ªå®éªŒï¼Œæ·»åŠ äº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä¸”ç¼–è¯‘äº†å†…æ ¸ã€‚è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥å°è¯•è°ƒè¯•å†…æ ¸ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸€æ­¥ä¸€æ­¥æ¥çœ‹ï¼Œå†…æ ¸çš„ä»£ç é€»è¾‘æ‰§è¡Œåˆ°å“ªä¸€æ­¥äº†ï¼Œå¯¹åº”çš„å˜é‡å€¼æ˜¯ä»€ä¹ˆã€‚</p><h2>äº†è§£gdb</h2><p>åœ¨Linuxä¸‹é¢ï¼Œè°ƒè¯•ç¨‹åºä½¿ç”¨ä¸€ä¸ªå«ä½œgdbçš„å·¥å…·ã€‚é€šè¿‡è¿™ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥é€è¡Œè¿è¡Œç¨‹åºã€‚</p><p>ä¾‹å¦‚ï¼Œä¸Šä¸€èŠ‚æˆ‘ä»¬å†™çš„syscall.cè¿™ä¸ªç¨‹åºï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ç¼–è¯‘ã€‚</p><pre><code>gcc -g syscall.c\n</code></pre><p>å…¶ä¸­ï¼Œå‚æ•°-gçš„æ„æ€å°±æ˜¯åœ¨ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ç¨‹åºä¸­ï¼ŒåŠ å…¥debugæ‰€éœ€çš„ä¿¡æ¯ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®‰è£…ä¸€ä¸‹gdbã€‚</p><pre><code>apt-get install gdb\n</code></pre><p>ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥è°ƒè¯•è¿™ä¸ªç¨‹åºäº†ã€‚</p><pre><code>~/syscall# gdb ./a.out        \nGNU gdb (Ubuntu 8.1-0ubuntu3.1) 8.1.0.20180409-git\n......\nReading symbols from ./a.out...done.\n(gdb) l\n1       #include &lt;stdio.h&gt;\n2       #include &lt;stdlib.h&gt;\n3       #include &lt;unistd.h&gt;\n4       #include &lt;linux/kernel.h&gt;\n5       #include &lt;sys/syscall.h&gt;\n6       #include &lt;string.h&gt;\n7\n8       int main ()\n9       {\n10        char * words = &quot;I am liuchao from user mode.&quot;;\n(gdb) b 10\nBreakpoint 1 at 0x6e2: file syscall.c, line 10.\n(gdb) r\nStarting program: /root/syscall/a.out \n\nBreakpoint 1, main () at syscall.c:10\n10        char * words = &quot;I am liuchao from user mode.&quot;;\n(gdb) n\n12        ret = syscall(333, words, strlen(words)+1);\n(gdb) p words\n$1 = 0x5555555547c4 &quot;I am liuchao from user mode.&quot;\n(gdb) s\n__strlen_sse2 () at ../sysdeps/x86_64/multiarch/../strlen.S:79\n(gdb) bt\n#0  __strlen_sse2 () at ../sysdeps/x86_64/multiarch/../strlen.S:79\n#1  0x00005555555546f9 in main () at syscall.c:12\n(gdb) c\nContinuing.\nreturn 63 from kernel mode.\n[Inferior 1 (process 1774) exited normally]\n(gdb) q\n</code></pre><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªè¦æŒæ¡ç®€å•çš„å‡ ä¸ªgdbçš„å‘½ä»¤å°±å¯ä»¥äº†ã€‚</p><ul>\n<li>lï¼Œå³listï¼Œç”¨äºæ˜¾ç¤ºå¤šè¡Œæºä»£ç ã€‚</li>\n<li>bï¼Œå³breakï¼Œç”¨äºè®¾ç½®æ–­ç‚¹ã€‚</li>\n<li>rï¼Œå³runï¼Œç”¨äºå¼€å§‹è¿è¡Œç¨‹åºã€‚</li>\n<li>nï¼Œå³nextï¼Œç”¨äºæ‰§è¡Œä¸‹ä¸€æ¡è¯­å¥ã€‚å¦‚æœè¯¥è¯­å¥ä¸ºå‡½æ•°è°ƒç”¨ï¼Œåˆ™ä¸ä¼šè¿›å…¥å‡½æ•°å†…éƒ¨æ‰§è¡Œã€‚</li>\n<li>pï¼Œå³printï¼Œç”¨äºæ‰“å°å†…éƒ¨å˜é‡å€¼ã€‚</li>\n<li>sï¼Œå³stepï¼Œç”¨äºæ‰§è¡Œä¸‹ä¸€æ¡è¯­å¥ã€‚å¦‚æœè¯¥è¯­å¥ä¸ºå‡½æ•°è°ƒç”¨ï¼Œåˆ™è¿›å…¥å‡½æ•°ï¼Œæ‰§è¡Œå…¶ä¸­çš„ç¬¬ä¸€æ¡è¯­å¥ã€‚</li>\n<li>cï¼Œå³continueï¼Œç”¨äºç»§ç»­ç¨‹åºçš„è¿è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹ã€‚</li>\n<li>btï¼Œå³backtraceï¼Œç”¨äºæŸ¥çœ‹å‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚</li>\n<li>qï¼Œå³quitï¼Œç”¨äºé€€å‡ºgdbç¯å¢ƒã€‚</li>\n</ul><!-- [[[read_end]]] --><h2>Debug kernel</h2><p>çœ‹äº†debugä¸€ä¸ªè¿›ç¨‹è¿˜æ˜¯ç®€å•çš„ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯•ç€debugæ•´ä¸ªkernelã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œè¦æƒ³kernelèƒ½å¤Ÿè¢«debugï¼Œéœ€è¦åƒä¸Šé¢ç¼–è¯‘ç¨‹åºä¸€æ ·ï¼Œå°†debugæ‰€éœ€ä¿¡æ¯ä¹Ÿæ”¾å…¥äºŒè¿›åˆ¶æ–‡ä»¶é‡Œé¢å»ã€‚è¿™ä¸ªæˆ‘ä»¬åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™å·²ç»è®¾ç½®è¿‡äº†ï¼Œä¹Ÿå°±æ˜¯æŠŠâ€œCONFIG_DEBUG_INFOâ€å’Œâ€œCONFIG_FRAME_POINTERâ€ä¸¤ä¸ªå˜é‡è®¾ç½®ä¸ºyesã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œå°±æ˜¯å®‰è£…gdbã€‚kernelè¿è¡Œåœ¨qemuè™šæ‹Ÿæœºé‡Œé¢ï¼Œgdbè¿è¡Œåœ¨å®¿ä¸»æœºä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨å®¿ä¸»æœºä¸Šè¿›è¡Œå®‰è£…ã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œæ‰¾åˆ°gdbè¦è¿è¡Œçš„é‚£ä¸ªå†…æ ¸çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶åœ¨å“ªé‡Œå‘¢ï¼Ÿæ ¹æ®grubé‡Œé¢çš„é…ç½®ï¼Œå®ƒåº”è¯¥åœ¨/boot/vmlinuz-4.15.18è¿™é‡Œã€‚</p><p>å¦å¤–ï¼Œä¸ºäº†æ–¹ä¾¿åœ¨debugçš„è¿‡ç¨‹ä¸­æŸ¥çœ‹æºä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å°†/usr/src/linux-source-4.15.0æ•´ä¸ªç›®å½•ï¼Œéƒ½æ‹·è´åˆ°å®¿ä¸»æœºä¸Šæ¥ã€‚å› ä¸ºå†…æ ¸ä¸€æ—¦è¿›å…¥debugæ¨¡å¼ï¼Œå°±ä¸èƒ½è¿è¡Œäº†ã€‚</p><pre><code>scp -r popsuper@192.168.57.100:/usr/src/linux-source-4.15.0 ./\n</code></pre><p>åœ¨/usr/src/linux-source-4.15.0è¿™ä¸ªç›®å½•ä¸‹é¢ï¼Œvmlinuxæ–‡ä»¶ä¹Ÿæ˜¯å†…æ ¸çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p>ç¬¬å››æ­¥ï¼Œä¿®æ”¹qemuçš„å¯åŠ¨å‚æ•°å’Œqemué‡Œé¢è™šæ‹Ÿæœºçš„å¯åŠ¨å‚æ•°ï¼Œä»è€Œä½¿å¾—gdbå¯ä»¥è¿œç¨‹attachåˆ°qemué‡Œé¢çš„å†…æ ¸ä¸Šã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œgdb debugä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œgdbä¼šç›‘æ§è¿›ç¨‹çš„è¿è¡Œï¼Œä½¿å¾—è¿›ç¨‹ä¸€è¡Œä¸€è¡Œåœ°æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¦‚æœåƒsyscall.cçš„äºŒè¿›åˆ¶æ–‡ä»¶a.outä¸€æ ·ï¼Œå°±åœ¨æœ¬åœ°ï¼Œgdbå¯ä»¥é€šè¿‡attachåˆ°è¿™ä¸ªè¿›ç¨‹ä¸Šï¼Œä½œä¸ºè¿™ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œæ¥ç›‘æ§å®ƒçš„è¿è¡Œã€‚</p><p>ä½†æ˜¯ï¼Œgdb debugä¸€ä¸ªå†…æ ¸çš„æ—¶å€™ï¼Œå› ä¸ºå†…æ ¸åœ¨qemuè™šæ‹Ÿæœºé‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›‘æ§æœ¬åœ°è¿›ç¨‹ï¼Œè€Œè¦é€šè¿‡qemuæ¥ç›‘æ§qemué‡Œé¢çš„å†…æ ¸ï¼Œè¿™å°±è¦å€ŸåŠ©qemuçš„æœºåˆ¶ã€‚</p><p>qemuæœ‰ä¸ªå‚æ•°-sï¼Œå®ƒä»£è¡¨å‚æ•°-gdb tcp::1234ï¼Œæ„æ€æ˜¯qemuç›‘å¬1234ç«¯å£ï¼Œgdbå¯ä»¥attachåˆ°è¿™ä¸ªç«¯å£ä¸Šæ¥ï¼Œdebug qemué‡Œé¢çš„å†…æ ¸ã€‚</p><p>ä¸ºäº†å®Œæˆè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ubuntutestè¿™ä¸ªè™šæ‹Ÿæœºçš„å®šä¹‰æ–‡ä»¶ã€‚</p><pre><code>virsh edit ubuntutest\n</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬èƒ½å°†è™šæ‹Ÿæœºçš„å®šä¹‰æ–‡ä»¶ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­ï¼Œå…¶ä¸­ä¸»è¦æ”¹äº†ä¸¤é¡¹ï¼š</p><ul>\n<li>åœ¨domainçš„æœ€ååŠ ä¸Šäº†qemu:commandlineï¼Œé‡Œé¢æŒ‡å®šäº†å‚æ•°-sï¼›</li>\n<li>åœ¨domainä¸­æ·»åŠ xmlns:qemuã€‚æ²¡æœ‰è¿™ä¸ªXMLçš„namespaceï¼Œqemu:commandlineè¿™ä¸ªå‚æ•°libvirtä¸è®¤ã€‚</li>\n</ul><pre><code>&lt;domain type='qemu' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;\n  &lt;name&gt;ubuntutest&lt;/name&gt;\n  &lt;uuid&gt;0f0806ab-531d-6134-5def-c5b4955292aa&lt;/uuid&gt;\n  &lt;memory unit='KiB'&gt;8388608&lt;/memory&gt;\n  &lt;currentMemory unit='KiB'&gt;8388608&lt;/currentMemory&gt;\n  &lt;vcpu placement='static'&gt;8&lt;/vcpu&gt;\n  &lt;os&gt;\n    &lt;type arch='x86_64' machine='pc-i440fx-trusty'&gt;hvm&lt;/type&gt;\n    &lt;boot dev='hd'/&gt;\n  &lt;/os&gt;\n  &lt;clock offset='utc'/&gt;\n  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;\n  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;\n  &lt;on_crash&gt;restart&lt;/on_crash&gt;\n  &lt;devices&gt;\n    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;\n    &lt;disk type='file' device='disk'&gt;\n      &lt;driver name='qemu' type='qcow2'/&gt;\n      &lt;source file='/mnt/vdc/ubuntutest.img'/&gt;\n      &lt;backingStore/&gt;\n      &lt;target dev='vda' bus='virtio'/&gt;\n      &lt;alias name='virtio-disk0'/&gt;\n      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;\n    &lt;/disk&gt;\n......\n    &lt;interface type='bridge'&gt;\n      &lt;mac address='fa:16:3e:6e:89:ce'/&gt;\n      &lt;source bridge='br0'/&gt;\n      &lt;target dev='tap1'/&gt;\n      &lt;model type='virtio'/&gt;\n      &lt;alias name='net0'/&gt;\n      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;\n    &lt;/interface&gt;\n......\n  &lt;/devices&gt;\n  &lt;qemu:commandline&gt;\n    &lt;qemu:arg value='-s'/&gt;\n  &lt;/qemu:commandline&gt;\n&lt;/domain&gt;\n</code></pre><p>å¦å¤–ï¼Œä¸ºäº†è¿œç¨‹debugæˆåŠŸï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹qemué‡Œé¢çš„è™šæ‹Ÿæœºçš„grubå’Œmenu.listï¼Œåœ¨å†…æ ¸å‘½ä»¤è¡Œä¸­æ·»åŠ nokaslrï¼Œæ¥å…³é—­KASLRã€‚KASLRä¼šä½¿å¾—å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼Œä»è€Œä¼šé€ æˆæˆ‘ä»¬æ‰“çš„æ–­ç‚¹ä¸èµ·ä½œç”¨ã€‚</p><p>å¯¹äºgrub.confï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p><pre><code>submenu 'Advanced options for Ubuntu' $menuentry_id_option 'gnulinux-advanced-470f3a42-7a97-4b9d-aaa0-26deb3d234f9' {\n        menuentry 'Ubuntu, with Linux 4.15.18' --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-4.15.18-advanced-470f3a42-7a97-4b9d-aaa0-26deb3d234f9' {\n                recordfail\n                load_video\n                gfxmode $linux_gfx_mode\n                insmod gzio\n                if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi\n                insmod part_gpt\n                insmod ext2\n                if [ x$feature_platform_search_hint = xy ]; then\n                  search --no-floppy --fs-uuid --set=root  470f3a42-7a97-4b9d-aaa0-26deb3d234f9\n                else\n                  search --no-floppy --fs-uuid --set=root 470f3a42-7a97-4b9d-aaa0-26deb3d234f9\n                fi\n                echo    'Loading Linux 4.15.18 ...'\n                linux   /boot/vmlinuz-4.15.18 root=UUID=470f3a42-7a97-4b9d-aaa0-26deb3d234f9 ro nokaslr console=ttyS0 maybe-ubiquity\n                echo    'Loading initial ramdisk ...'\n                initrd  /boot/initrd.img-4.15.18\n        }\n</code></pre><p>å¯¹äºmenu.listï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p><pre><code>title           Ubuntu 18.04.2 LTS, kernel 4.15.18\nroot            (hd0)\nkernel          /boot/vmlinuz-4.15.18 root=/dev/hda1 ro nokaslr console=hvc0 console=ttyS0\ninitrd          /boot/initrd.img-4.15.18\n</code></pre><p>ä¿®æ”¹å®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦åœ¨è™šæ‹Ÿæœºé‡Œé¢shutdown -h nowï¼Œæ¥å…³é—­è™šæ‹Ÿæœºã€‚æ³¨æ„ä¸è¦rebootï¼Œå› ä¸ºè™šæ‹Ÿæœºé‡Œé¢è¿è¡Œrebootï¼Œæˆ‘ä»¬æ”¹è¿‡çš„é‚£ä¸ªXMLä¼šä¸èµ·ä½œç”¨ã€‚</p><p>å½“æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šå‘ç°è™šæ‹Ÿæœºå…³æœºä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡virsh start ubuntutestå¯åŠ¨è™šæ‹Ÿæœºï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ·»åŠ çš„å‚æ•°-sæ‰èµ·ä½œç”¨ã€‚</p><p>ç¬¬äº”æ­¥ï¼Œä½¿ç”¨gdbè¿è¡Œå†…æ ¸çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰§è¡Œgdb vmlinuxã€‚</p><pre><code>/mnt/vdc/linux-source-4.15.0# gdb vmlinux\nGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1\n......\nTo enable execution of this file add\n        add-auto-load-safe-path /mnt/vdc/linux-source-4.15.0/vmlinux-gdb.py\n......\n(gdb) b sys_sayhelloworld\nBreakpoint 1 at 0xffffffff8109e2f0: file kernel/sys.c, line 192.\n(gdb) target remote :1234\nRemote debugging using :1234\nnative_safe_halt () at ./arch/x86/include/asm/irqflags.h:61\n61      }\n(gdb) c\nContinuing.\n[Switching to Thread 2]\nThread 2 hit Breakpoint 1, sys_sayhelloworld (words=0x563cbfa907c4 &quot;I am liuchao from user mode.&quot;, count=29) at kernel/sys.c:192\n192     {\n(gdb) bt\n#0  sys_sayhelloworld (words=0x55b2811537c4 &quot;I am liuchao from user mode.&quot;, count=29) at kernel/sys.c:192\n#1  0xffffffff810039f7 in do_syscall_64 (regs=0xffffc9000133bf58) at arch/x86/entry/common.c:290\n#2  0xffffffff81a00081 in entry_SYSCALL_64 () at arch/x86/entry/entry_64.S:237\n(gdb) n\n195             if(count &gt;= 1024){\n(gdb) n\n198             copy_from_user(buffer, words, count);\n(gdb) n\n199             ret=printk(&quot;User Mode says %s to the Kernel Mode!&quot;, buffer);\n(gdb) p buffer\n$1 = &quot;I am liuchao from user mode.\\000\\177\\000\\000\\...\n(gdb) n\n200             return ret;\n(gdb) p ret\n$2 = 63\n(gdb) c\n(gdb) n\ndo_syscall_64 (regs=0xffffc9000133bf58) at arch/x86/entry/common.c:295\n295             syscall_return_slowpath(regs);\n(gdb) s\nsyscall_return_slowpath (regs=&lt;optimized out&gt;) at arch/x86/entry/common.c:295\n(gdb) n\n268             prepare_exit_to_usermode(regs);\n(gdb) n\ndo_syscall_64 (regs=0xffffc9000133bf58) at arch/x86/entry/common.c:296\n296     }\n(gdb) n\nentry_SYSCALL_64 () at arch/x86/entry/entry_64.S:246\n246             movq    RCX(%rsp), %rcx\n......\n(gdb) n\nentry_SYSCALL_64 () at arch/x86/entry/entry_64.S:330\n330             USERGS_SYSRET64\n</code></pre><p>æˆ‘ä»¬å…ˆè®¾ç½®ä¸€ä¸ªæ–­ç‚¹åœ¨æˆ‘ä»¬è‡ªå·±å†™çš„ç³»ç»Ÿè°ƒç”¨ä¸Šb sys_sayhelloworldï¼Œé€šè¿‡æ‰§è¡Œtarget remote :1234ï¼Œæ¥attachåˆ°qemuä¸Šï¼Œç„¶åï¼Œæ‰§è¡Œcï¼Œä¹Ÿå³continueè¿è¡Œå†…æ ¸ã€‚è¿™ä¸ªæ—¶å€™å†…æ ¸å§‹ç»ˆåœ¨Continuingçš„çŠ¶æ€ï¼Œä¹Ÿå³æŒç»­åœ¨è¿è¡Œä¸­ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥è¿œç¨‹ç™»å½•åˆ°qemué‡Œçš„è™šæ‹Ÿæœºä¸Šï¼Œæ‰§è¡Œå„ç§å‘½ä»¤ã€‚</p><p>å¦‚æœæˆ‘ä»¬åœ¨è™šæ‹Ÿæœºé‡Œé¢è¿è¡Œsyscall.cç¼–è¯‘å¥½çš„a.outï¼Œè¿™ä¸ªæ—¶å€™è‚¯å®šä¼šè°ƒç”¨åˆ°å†…æ ¸ã€‚å†…æ ¸è‚¯å®šä¼šç»è¿‡ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ï¼Œåˆ°è¾¾sys_sayhelloworldè¿™ä¸ªå‡½æ•°ï¼Œè¿™å°±ç¢°åˆ°äº†æˆ‘ä»¬è®¾ç½®çš„é‚£ä¸ªæ–­ç‚¹ã€‚</p><p>å¦‚æœæ‰§è¡Œbtï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯ä»entry_64.Sé‡Œé¢çš„entry_SYSCALL_64 ()å‡½æ•°ï¼Œè°ƒç”¨åˆ°do_syscall_64å‡½æ•°ï¼Œå†è°ƒç”¨åˆ°sys_sayhelloworldå‡½æ•°çš„ã€‚è¿™ä¸€ç‚¹å’Œæˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/90394\">ç³»ç»Ÿè°ƒç”¨</a>é‚£ä¸€èŠ‚åˆ†æçš„è¿‡ç¨‹æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œnextå‘½ä»¤ï¼Œæ¥çœ‹sys_sayhelloworldä¸€æ­¥ä¸€æ­¥æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Œé€šè¿‡p bufferæŸ¥çœ‹bufferé‡Œé¢çš„å†…å®¹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç”±äºå†…æ ¸æ˜¯é€è¡Œè¿è¡Œçš„ï¼Œå› è€Œæˆ‘ä»¬åœ¨è™šæ‹Ÿæœºé‡Œé¢çš„å‘½ä»¤è¡Œæ˜¯å¡æ­»çš„çŠ¶æ€ã€‚</p><p>å½“æˆ‘ä»¬ä¸æ–­åœ°nextï¼Œç›´åˆ°æ‰§è¡Œå®Œæ¯•sys_sayhelloworldçš„æ—¶å€™ï¼Œä¼šçœ‹åˆ°ï¼Œdo_syscall_64ä¼šè°ƒç”¨syscall_return_slowpathã€‚å®ƒä¼šè°ƒç”¨prepare_exit_to_usermodeï¼Œç„¶åä¼šå›åˆ°entry_SYSCALL_64ï¼Œç„¶åå¯¹äºå¯„å­˜å™¨è¿›è¡Œæ“ä½œï¼Œæœ€åè°ƒç”¨æŒ‡ä»¤USERGS_SYSRET64å›åˆ°ç”¨æˆ·æ€ã€‚è¿™ä¸ªè¿”å›çš„è¿‡ç¨‹å’Œç³»ç»Ÿè°ƒç”¨é‚£ä¸€èŠ‚ä¹Ÿä¸€æ¨¡ä¸€æ ·ã€‚</p><p>çœ‹ï¼Œé€šè¿‡debugæˆ‘ä»¬èƒ½å¤Ÿè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ä½ å¯ä»¥å°†æˆ‘ä»¬è¿™ä¸€é—¨è¯¾é‡Œé¢å­¦çš„æ‰€æœ‰çš„è¿‡ç¨‹éƒ½debugä¸€ä¸‹ï¼Œçœ‹çœ‹å˜é‡çš„å€¼ï¼Œä»è€Œå¯¹äºå†…æ ¸çš„å·¥ä½œæœºåˆ¶æœ‰æ›´åŠ æ·±å…¥çš„äº†è§£ã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>åœ¨è¿™ä¸ªè¯¾ç¨‹é‡Œé¢ï¼Œæˆ‘ä»¬å†™è¿‡ä¸€äº›ç¨‹åºï¼Œä¸ºäº†ä¿è¯ç¨‹åºèƒ½å¤Ÿé¡ºåˆ©è¿è¡Œï¼Œæˆ‘ä¸€èˆ¬ä¼šå°†ä»£ç å®Œæ•´åœ°æ”¾åˆ°æ–‡æœ¬ä¸­ï¼Œè®©ä½ æ‹·è´ä¸‹æ¥å°±èƒ½ç¼–è¯‘å’Œè¿è¡Œã€‚å¦‚æœä½ è¿è¡Œçš„æ—¶å€™å‘ç°æœ‰é—®é¢˜ï¼Œæˆ–è€…æƒ³äº†è§£ä¸€æ­¥ä¸€æ­¥è¿è¡Œçš„ç»†èŠ‚ï¼Œè¿™ä¸€èŠ‚ä»‹ç»çš„gdbæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·ã€‚</p><p>è¿™ä¸€èŠ‚ä½ å°¤å…¶åº”è¯¥æŒæ¡çš„æ˜¯ï¼Œå¦‚ä½•é€šè¿‡å®¿ä¸»æœºä¸Šçš„gdbæ¥debugè™šæ‹Ÿæœºé‡Œé¢çš„å†…æ ¸ã€‚è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œä¼šäº†è¿™ä¸ªï¼Œä½ å°±èƒ½å¤Ÿè¿”å›å»ï¼ŒæŒ¨ä¸ªç ”ç©¶æ¯ä¸€ç« æ¯ä¸€èŠ‚çš„å†…æ ¸æ•°æ®ç»“æ„å’Œè¿è¡Œé€»è¾‘äº†ã€‚</p><p>åœ¨è¿™é—¨è¯¾ä¸­ï¼Œè¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ã€æ–‡ä»¶ç®¡ç†ã€è®¾å¤‡ç®¡ç†ç½‘ç»œç®¡ç†ï¼Œæˆ‘ä»¬éƒ½ä»‹ç»äº†ä»ç³»ç»Ÿè°ƒç”¨åˆ°åº•å±‚çš„æ•´ä¸ªé€»è¾‘ã€‚å¦‚æœä½ å¯¹æˆ‘å‰é¢çš„ä»£ç è§£æè¿˜æ¯”è¾ƒå›°æƒ‘ï¼Œä½ å¯ä»¥å°è¯•ç€å»debugè¿™äº›è¿‡ç¨‹ï¼Œåªè¦æŠŠæ–­ç‚¹æ‰“åœ¨ç³»ç»Ÿè°ƒç”¨çš„å…¥å£ä½ç½®å°±å¯ä»¥äº†ã€‚</p><p>ä»æ­¤ï¼Œå¼€å¯ä½ çš„å†…æ ¸debugä¹‹æ—…å§ï¼</p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>è¿™é‡Œç»™ä½ ç•™ä¸€é“é¢˜ç›®ï¼Œä½ å¯ä»¥è¯•ç€debugä¸€ä¸‹æ–‡ä»¶æ‰“å¼€çš„è¿‡ç¨‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ï¼Œä¹Ÿæ¬¢è¿ä½ æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ ã€è¿›æ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659\" alt=\"\"></p>","comments":[{"had_liked":false,"id":134968,"user_name":"é­é¢–çª","can_delete":false,"product_type":"c1","uid":1184964,"ip_address":"","ucode":"097544C71EBDA7","user_header":"https://static001.geekbang.org/account/avatar/00/12/14/c4/e354d8ba.jpg","comment_is_top":false,"comment_ctime":1568964237,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"23043800717","product_id":100024701,"comment_content":"ç»ˆäºåœ¨virtualboxä¸­åšå®Œäº†è¿™ä¸¤è¯¾çš„å®éªŒã€‚è¯·é—®è€å¸ˆï¼Œäº‘æœåŠ¡æ˜¯å¦å¾ˆå°‘ç”¨ vboxï¼ŒåŸºæœ¬éƒ½ç”¨qemu?","like_count":6},{"had_liked":false,"id":175050,"user_name":"yanger","can_delete":false,"product_type":"c1","uid":1233837,"ip_address":"","ucode":"491426CA7DE1E8","user_header":"https://static001.geekbang.org/account/avatar/00/12/d3/ad/bfaae364.jpg","comment_is_top":false,"comment_ctime":1580538961,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10170473553","product_id":100024701,"comment_content":"ç¼ºçœå¾ˆå¤šå˜é‡è¢«ç¼–è¯‘ä¼˜åŒ–äº†ï¼Œæœ‰O0ç¼–è¯‘kernelçš„æ–¹æ³•å—","like_count":3,"discussions":[{"author":{"id":2344081,"avatar":"https://static001.geekbang.org/account/avatar/00/23/c4/91/a017bf72.jpg","nickname":"coconut","note":"","ucode":"07B95C7A6AC2F7","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":579736,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1657640116,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":124923,"user_name":"LDxy","can_delete":false,"product_type":"c1","uid":1188710,"ip_address":"","ucode":"956432CE7B7761","user_header":"https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg","comment_is_top":false,"comment_ctime":1566016018,"is_pvip":false,"replies":[{"id":"46262","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘","uid":"1001590","ctime":1566280341,"ip_address":"","comment_id":124923,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10155950610","product_id":100024701,"comment_content":"æ‰“æ–­ç‚¹çš„æŒ‡ä»¤båé¢æ˜¯ä¸æ˜¯æ—¢å¯ä»¥è·Ÿè¡Œå·ä¹Ÿå¯ä»¥è·Ÿå‡½æ•°åï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":463360,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1566280341,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":346592,"user_name":"é‚¹å¾·è™","can_delete":false,"product_type":"c1","uid":1943679,"ip_address":"","ucode":"1F3583873BD771","user_header":"https://static001.geekbang.org/account/avatar/00/1d/a8/7f/d49a56b5.jpg","comment_is_top":false,"comment_ctime":1653272319,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1653272319","product_id":100024701,"comment_content":"å¦‚æœæ²¡æœ‰è™šæ‹Ÿæœºè€Œæ˜¯å®ä½“çš„æœåŠ¡å™¨ï¼Œæ€ä¹ˆè°ƒè¯•å†…æ ¸å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":250115,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1600940542,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1600940542","product_id":100024701,"comment_content":"ç¼–è¯‘ã€è°ƒè¯•è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸ç¨å¾®æœ‰äº›åŒºåˆ«ï¼Œå¤§ä½“æµç¨‹åŸºæœ¬ç›¸åŒã€‚","like_count":0},{"had_liked":false,"id":124755,"user_name":"kkxue","can_delete":false,"product_type":"c1","uid":1159904,"ip_address":"","ucode":"0DCB861D5543D6","user_header":"https://static001.geekbang.org/account/avatar/00/11/b2/e0/bf56878a.jpg","comment_is_top":false,"comment_ctime":1565962710,"is_pvip":true,"discussion_count":0,"race_medal":5,"score":"1565962710","product_id":100024701,"comment_content":"èµğŸ‘","like_count":0},{"had_liked":false,"id":124664,"user_name":"è®¸ç«¥ç«¥","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1565939713,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565939713","product_id":100024701,"comment_content":"è·Ÿç€è€å¸ˆä¸€èµ·ç²¾è¿›ã€‚","like_count":0}]}