{"id":342891,"title":"11 | å‹ç¼©ï¼šå¦‚ä½•å›æ”¶æ—§ç‰ˆæœ¬æ•°æ®ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å”èªã€‚</p><p>ä»Šå¤©æ˜¯å¤§å¹´åˆä¸€ï¼Œä½ è¿‡å¹´éƒ½æœ‰ä»€ä¹ˆå®‰æ’ï¼Ÿä»Šå¹´è¿‡å¹´å¯¹æˆ‘æ¥è¯´ï¼Œå…¶å®æ˜¯æ¯”è¾ƒç‰¹åˆ«çš„ã€‚é™¤äº†å®¶åº­å›¢èšèµ°äº²è®¿å‹å¤–ï¼Œæˆ‘å¤šäº†ä¸€ä»½é™ªä¼´ã€‚æ„Ÿè°¢ä½ å’Œæˆ‘åœ¨è¿™ä¸ªä¸“æ é‡Œä¸€å—ç²¾è¿›ï¼Œæˆ‘è¡·å¿ƒç¥ä½ åœ¨æ–°çš„ä¸€å¹´é‡Œå¹³å®‰å–œä¹ï¼Œä¸‡äº‹èƒœæ„ã€‚</p><p>è¿™èŠ‚è¯¾æ˜¯æˆ‘ä»¬åŸºç¡€ç¯‡é‡Œçš„æœ€åä¸€èŠ‚ï¼Œæ­£å·§è¿™èŠ‚è¯¾çš„å†…å®¹ä¹Ÿæ˜¯æœ€è½»æ¾çš„ã€‚æ–°å¹´æ–°æ°”è±¡ï¼Œæˆ‘ä»¬å°±å¸¦ç€è½»æ¾çš„å¿ƒæƒ…å¼€å§‹å§ï¼</p><p>åœ¨<a href=\"https://time.geekbang.org/column/article/340226\">07</a>é‡Œï¼Œæˆ‘ä»¬çŸ¥é“etcdä¸­çš„æ¯ä¸€æ¬¡æ›´æ–°ã€åˆ é™¤keyæ“ä½œï¼ŒtreeIndexçš„keyIndexç´¢å¼•ä¸­éƒ½ä¼šè¿½åŠ ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œåœ¨boltdbä¸­ä¼šç”Ÿæˆä¸€ä¸ªæ–°ç‰ˆæœ¬boltdb keyå’Œvalueã€‚ä¹Ÿå°±æ˜¯éšç€ä½ ä¸åœæ›´æ–°ã€åˆ é™¤ï¼Œä½ çš„etcdè¿›ç¨‹å†…å­˜å ç”¨å’Œdbæ–‡ä»¶å°±ä¼šè¶Šæ¥è¶Šå¤§ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¼šå¯¼è‡´etcd OOMå’Œdbå¤§å°å¢é•¿åˆ°æœ€å¤§dbé…é¢ï¼Œæœ€ç»ˆä¸å¯å†™ã€‚</p><p>é‚£ä¹ˆetcdæ˜¯é€šè¿‡ä»€ä¹ˆæœºåˆ¶æ¥å›æ”¶å†å²ç‰ˆæœ¬æ•°æ®ï¼Œæ§åˆ¶ç´¢å¼•å†…å­˜å ç”¨å’Œdbå¤§å°çš„å‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯æˆ‘ä»Šå¤©è¦å’Œä½ åˆ†äº«çš„etcdå‹ç¼©æœºåˆ¶ã€‚å¸Œæœ›é€šè¿‡ä»Šå¤©çš„è¿™èŠ‚è¯¾ï¼Œèƒ½å¸®åŠ©ä½ ç†è§£etcdå‹ç¼©åŸç†ï¼Œåœ¨ä½¿ç”¨etcdè¿‡ç¨‹ä¸­èƒ½æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯ï¼Œé€‰æ‹©é€‚åˆçš„å‹ç¼©ç­–ç•¥ï¼Œé¿å…dbå¤§å°å¢é•¿å¤±æ§è€Œä¸å¯å†™å…¥ï¼Œå¸®åŠ©ä½ æ„å»ºç¨³å®šçš„etcdæœåŠ¡ã€‚</p><h2>æ•´ä½“æ¶æ„</h2><p><img src=\"https://static001.geekbang.org/resource/image/7c/21/7c5d5212fa14yy6aaf843ae3dfc5f721.png?wh=1920*918\" alt=\"\"></p><p>åœ¨äº†è§£etcdå‹ç¼©æ¨¡å—å®ç°ç»†èŠ‚å‰ï¼Œæˆ‘å…ˆç»™ä½ ç”»äº†ä¸€å¹…å‹ç¼©æ¨¡å—çš„æ•´ä½“æ¶æ„å›¾ã€‚ä»å›¾ä¸­å¯çŸ¥ï¼Œä½ å¯ä»¥é€šè¿‡client APIå‘èµ·äººå·¥çš„å‹ç¼©(Compact)æ“ä½œï¼Œä¹Ÿå¯ä»¥é…ç½®è‡ªåŠ¨å‹ç¼©ç­–ç•¥ã€‚åœ¨è‡ªåŠ¨å‹ç¼©ç­–ç•¥ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„å‹ç¼©æ¨¡å¼ã€‚ç›®å‰etcdæ”¯æŒä¸¤ç§å‹ç¼©æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯æ—¶é—´å‘¨æœŸæ€§å‹ç¼©å’Œç‰ˆæœ¬å·å‹ç¼©ã€‚</p><!-- [[[read_end]]] --><p>å½“ä½ é€šè¿‡APIå‘èµ·ä¸€ä¸ªCompactè¯·æ±‚åï¼ŒKV Serveræ”¶åˆ°Compactè¯·æ±‚æäº¤åˆ°Raftæ¨¡å—å¤„ç†ï¼Œåœ¨Raftæ¨¡å—ä¸­æäº¤åï¼ŒApplyæ¨¡å—å°±ä¼šé€šè¿‡MVCCæ¨¡å—çš„Compactæ¥å£æ‰§è¡Œæ­¤å‹ç¼©ä»»åŠ¡ã€‚</p><p>Compactæ¥å£é¦–å…ˆä¼šæ›´æ–°å½“å‰serverå·²å‹ç¼©çš„ç‰ˆæœ¬å·ï¼Œå¹¶å°†è€—æ—¶æ˜‚è´µçš„å‹ç¼©ä»»åŠ¡ä¿å­˜åˆ°FIFOé˜Ÿåˆ—ä¸­å¼‚æ­¥æ‰§è¡Œã€‚å‹ç¼©ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå®ƒé¦–å…ˆä¼šå‹ç¼©treeIndexæ¨¡å—ä¸­çš„keyIndexç´¢å¼•ï¼Œå…¶æ¬¡ä¼šéå†boltdbä¸­çš„keyï¼Œåˆ é™¤å·²åºŸå¼ƒçš„keyã€‚</p><p>ä»¥ä¸Šå°±æ˜¯å‹ç¼©æ¨¡å—çš„ä¸€ä¸ªå·¥ä½œæµç¨‹ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šé¦–å…ˆå’Œä½ ä»‹ç»å¦‚ä½•äººå·¥å‘èµ·ä¸€ä¸ªCompactæ“ä½œï¼Œç„¶åè¯¦ç»†ä»‹ç»å‘¨æœŸæ€§å‹ç¼©æ¨¡å¼ã€ç‰ˆæœ¬å·å‹ç¼©æ¨¡å¼çš„å·¥ä½œåŸç†ï¼Œæœ€åå†ç»™ä½ ä»‹ç»Compactæ“ä½œæ ¸å¿ƒçš„åŸç†ã€‚</p><h2>å‹ç¼©ç‰¹æ€§åˆä½“éªŒ</h2><p>åœ¨ä½¿ç”¨etcdè¿‡ç¨‹ä¸­ï¼Œå½“ä½ é‡åˆ°\"etcdserver: mvcc: database space exceeded\"é”™è¯¯æ—¶ï¼Œè‹¥æ˜¯ä½ æœªå¼€å¯å‹ç¼©ç­–ç•¥å¯¼è‡´dbå¤§å°è¾¾åˆ°é…é¢ï¼Œè¿™æ—¶ä½ å¯ä»¥ä½¿ç”¨etcdctl compactå‘½ä»¤ï¼Œä¸»åŠ¨è§¦å‘å‹ç¼©æ“ä½œï¼Œå›æ”¶å†å²ç‰ˆæœ¬ã€‚</p><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œä½ å¯ä»¥å…ˆé€šè¿‡endpoint statuså‘½ä»¤è·å–etcdå½“å‰ç‰ˆæœ¬å·ï¼Œç„¶åå†é€šè¿‡etcdctl compactå‘½ä»¤å‘èµ·å‹ç¼©æ“ä½œå³å¯ã€‚</p><pre><code># è·å–etcdå½“å‰ç‰ˆæœ¬å·\n$ rev=$(etcdctl endpoint status --write-out=&quot;json&quot; | egrep -o '&quot;revision&quot;:[0-9]*' | egrep -o '[0-9].*')\n$ echo $rev\n9\n# æ‰§è¡Œå‹ç¼©æ“ä½œï¼ŒæŒ‡å®šå‹ç¼©çš„ç‰ˆæœ¬å·ä¸ºå½“å‰ç‰ˆæœ¬å·\n$ etcdctl compact $rev\nCompacted revision 9\n# å‹ç¼©ä¸€ä¸ªå·²ç»å‹ç¼©çš„ç‰ˆæœ¬å·\n$ etcdctl compact $rev\nError: etcdserver: mvcc: required revision has been compacted\n# å‹ç¼©ä¸€ä¸ªæ¯”å½“å‰æœ€å¤§ç‰ˆå·å¤§çš„ç‰ˆæœ¬å·\n$ etcdctl compact 12\nError: etcdserver: mvcc: required revision is a future revision\n</code></pre><p>è¯·æ³¨æ„ï¼Œå¦‚æœä½ å‹ç¼©å‘½ä»¤ä¼ é€’çš„ç‰ˆæœ¬å·å°äºç­‰äºå½“å‰etcd serverè®°å½•çš„å‹ç¼©ç‰ˆæœ¬å·ï¼Œetcd serverä¼šè¿”å›å·²å‹ç¼©é”™è¯¯(\"mvcc: required revision has been compacted\")ç»™clientã€‚å¦‚æœç‰ˆæœ¬å·å¤§äºå½“å‰etcd serveræœ€æ–°çš„ç‰ˆæœ¬å·ï¼Œetcd serveråˆ™è¿”å›ä¸€ä¸ªæœªæ¥çš„ç‰ˆæœ¬å·é”™è¯¯ç»™client(\"mvcc: required revision is a future revision\")ã€‚</p><p>æ‰§è¡Œå‹ç¼©å‘½ä»¤çš„æ—¶å€™ï¼Œä¸å°‘åˆå­¦è€…æœ‰ä¸€ä¸ªå¸¸è§çš„è¯¯åŒºï¼Œå°±æ˜¯æ‹…å¿ƒå‹ç¼©ä¼šä¸ä¼šæŠŠæˆ‘æœ€æ–°ç‰ˆæœ¬æ•°æ®ç»™åˆ é™¤ï¼Ÿ</p><p>å‹ç¼©çš„æœ¬è´¨æ˜¯<strong>å›æ”¶å†å²ç‰ˆæœ¬</strong>ï¼Œç›®æ ‡å¯¹è±¡ä»…æ˜¯<strong>å†å²ç‰ˆæœ¬</strong>ï¼Œä¸åŒ…æ‹¬ä¸€ä¸ªkey-valueæ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå› æ­¤ä½ å¯ä»¥æ”¾å¿ƒæ‰§è¡Œå‹ç¼©å‘½ä»¤ï¼Œä¸ä¼šåˆ é™¤ä½ çš„æœ€æ–°ç‰ˆæœ¬æ•°æ®ã€‚ä¸è¿‡æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/341060\">08</a>ä»‹ç»Watchæœºåˆ¶æ—¶æåˆ°ï¼ŒWatchç‰¹æ€§ä¸­çš„å†å²ç‰ˆæœ¬æ•°æ®åŒæ­¥ï¼Œä¾èµ–äºMVCCä¸­æ˜¯å¦è¿˜ä¿å­˜äº†ç›¸å…³æ•°æ®ï¼Œå› æ­¤æˆ‘å»ºè®®ä½ ä¸è¦æ¯æ¬¡ç®€å•ç²—æš´åœ°å›æ”¶æ‰€æœ‰å†å²ç‰ˆæœ¬ã€‚</p><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘å»ºè®®ä½ ç²¾ç»†åŒ–çš„æ§åˆ¶å†å²ç‰ˆæœ¬æ•°ï¼Œé‚£å¦‚ä½•å®ç°ç²¾ç»†åŒ–æ§åˆ¶å‘¢ï¼Ÿ</p><p>ä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯ä½¿ç”¨etcd serverçš„è‡ªå¸¦çš„è‡ªåŠ¨å‹ç¼©æœºåˆ¶ï¼Œæ ¹æ®ä½ çš„ä¸šåŠ¡åœºæ™¯ï¼Œé…ç½®åˆé€‚çš„å‹ç¼©ç­–ç•¥å³å¯ã€‚</p><p>å¦å¤–ä¸€ç§æ–¹æ¡ˆæ˜¯å¦‚æœä½ è§‰å¾—etcd serverçš„è‡ªå¸¦å‹ç¼©æœºåˆ¶æ— æ³•æ»¡è¶³ä½ çš„è¯‰æ±‚ï¼Œæƒ³æ›´ç²¾ç»†åŒ–çš„æ§åˆ¶etcdä¿ç•™çš„å†å²ç‰ˆæœ¬è®°å½•ï¼Œä½ å°±å¯ä»¥åŸºäºetcdçš„Compact APIï¼Œåœ¨ä¸šåŠ¡é€»è¾‘ä»£ç ä¸­ã€æˆ–å®šæ—¶ä»»åŠ¡ä¸­ä¸»åŠ¨è§¦å‘å‹ç¼©æ“ä½œã€‚ä½ éœ€è¦ç¡®ä¿å‘èµ·Compactæ“ä½œçš„ç¨‹åºé«˜å¯ç”¨ï¼Œå‹ç¼©çš„é¢‘ç‡ã€ä¿ç•™çš„å†å²ç‰ˆæœ¬åœ¨åˆç†èŒƒå›´å†…ï¼Œå¹¶æœ€ç»ˆèƒ½ä½¿etcdçš„db å¤§å°ä¿æŒå¹³ç¨³ï¼Œå¦åˆ™ä¼šå¯¼è‡´dbå¤§å°ä¸æ–­å¢é•¿ï¼Œç›´è‡³dbé…é¢æ»¡ï¼Œæ— æ³•å†™å…¥ã€‚</p><p>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘å»ºè®®ä½¿ç”¨etcdè‡ªå¸¦çš„å‹ç¼©æœºåˆ¶ã€‚å®ƒæ”¯æŒä¸¤ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯æŒ‰æ—¶é—´å‘¨æœŸæ€§å‹ç¼©å’Œä¿ç•™ç‰ˆæœ¬å·çš„å‹ç¼©ï¼Œé…ç½®ç›¸åº”ç­–ç•¥åï¼ŒetcdèŠ‚ç‚¹ä¼šè‡ªåŠ¨åŒ–çš„å‘èµ·Compactæ“ä½œã€‚</p><p>æ¥ä¸‹æ¥æˆ‘å°±å’Œä½ è¯¦ç»†ä»‹ç»ä¸‹etcdçš„å‘¨æœŸæ€§å’Œä¿ç•™ç‰ˆæœ¬å·å‹ç¼©æ¨¡å¼ã€‚</p><h2>å‘¨æœŸæ€§å‹ç¼©</h2><p>é¦–å…ˆæ˜¯å‘¨æœŸæ€§å‹ç¼©æ¨¡å¼ï¼Œå®ƒé€‚ç”¨äºä»€ä¹ˆåœºæ™¯å‘¢ï¼Ÿ</p><p>å½“ä½ å¸Œæœ›etcdåªä¿ç•™æœ€è¿‘ä¸€æ®µæ—¶é—´å†™å…¥çš„å†å²ç‰ˆæœ¬æ—¶ï¼Œä½ å°±å¯ä»¥é€‰æ‹©é…ç½®etcdçš„å‹ç¼©æ¨¡å¼ä¸ºperiodicï¼Œä¿ç•™æ—¶é—´ä¸ºä½ è‡ªå®šä¹‰çš„1hç­‰ã€‚</p><p>å¦‚ä½•ç»™etcd serveré…ç½®å‹ç¼©æ¨¡å¼å’Œä¿ç•™æ—¶é—´å‘¢?</p><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œetcd serveræä¾›äº†é…ç½®å‹ç¼©æ¨¡å¼å’Œä¿ç•™æ—¶é—´çš„å‚æ•°ï¼š</p><pre><code>--auto-compaction-retention '0'\nAuto compaction retention length. 0 means disable auto Compaction.\n--auto-compaction-mode 'periodic'\nInterpret 'auto-Compaction-retention' one of: periodic|revision.\n</code></pre><p>auto-compaction-modeä¸ºperiodicæ—¶ï¼Œå®ƒè¡¨ç¤ºå¯ç”¨æ—¶é—´å‘¨æœŸæ€§å‹ç¼©ï¼Œauto-compaction-retentionä¸ºä¿ç•™çš„æ—¶é—´çš„å‘¨æœŸï¼Œæ¯”å¦‚1hã€‚</p><p>auto-compaction-modeä¸ºrevisionæ—¶ï¼Œå®ƒè¡¨ç¤ºå¯ç”¨ç‰ˆæœ¬å·å‹ç¼©æ¨¡å¼ï¼Œauto-compaction-retentionä¸ºä¿ç•™çš„å†å²ç‰ˆæœ¬å·æ•°ï¼Œæ¯”å¦‚10000ã€‚</p><p>æ³¨æ„ï¼Œetcd serverçš„auto-compaction-retentionä¸º'0'æ—¶ï¼Œå°†å…³é—­è‡ªåŠ¨å‹ç¼©ç­–ç•¥ï¼Œ</p><p>é‚£ä¹ˆå‘¨æœŸæ€§å‹ç¼©æ¨¡å¼çš„åŸç†æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ etcdæ˜¯å¦‚ä½•çŸ¥é“ä½ é…ç½®çš„1hå‰çš„etcd serverç‰ˆæœ¬å·å‘¢ï¼Ÿ</p><p>å…¶å®éå¸¸ç®€å•ï¼Œetcd serverå¯åŠ¨åï¼Œæ ¹æ®ä½ çš„é…ç½®çš„æ¨¡å¼periodicï¼Œä¼šåˆ›å»ºperiodic Compactorï¼Œå®ƒä¼šå¼‚æ­¥çš„è·å–ã€è®°å½•è¿‡å»ä¸€æ®µæ—¶é—´çš„ç‰ˆæœ¬å·ã€‚periodic Compactorç»„ä»¶è·å–ä½ è®¾ç½®çš„å‹ç¼©é—´éš”å‚æ•°1hï¼Œ å¹¶å°†å…¶åˆ’åˆ†æˆ10ä¸ªåŒºé—´ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªåŒºé—´6åˆ†é’Ÿã€‚æ¯éš”6åˆ†é’Ÿï¼Œå®ƒä¼šé€šè¿‡etcd MVCCæ¨¡å—çš„æ¥å£è·å–å½“å‰çš„serverç‰ˆæœ¬å·ï¼Œè¿½åŠ åˆ°revæ•°ç»„ä¸­ã€‚</p><p>å› ä¸ºä½ åªéœ€è¦ä¿ç•™è¿‡å»1ä¸ªå°æ—¶çš„å†å²ç‰ˆæœ¬ï¼Œperiodic Compactorç»„ä»¶ä¼šé€šè¿‡å½“å‰æ—¶é—´å‡å»ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡ŒCompactæ“ä½œçš„æ—¶é—´ï¼Œå¦‚æœé—´éš”å¤§äºä¸€ä¸ªå°æ—¶ï¼Œå®ƒä¼šå–å‡ºrevæ•°ç»„çš„é¦–å…ƒç´ ï¼Œé€šè¿‡etcd serverçš„Compactæ¥å£ï¼Œå‘èµ·å‹ç¼©æ“ä½œã€‚</p><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨etcd v3.3.3ç‰ˆæœ¬ä¹‹å‰ï¼Œä¸åŒçš„etcdç‰ˆæœ¬å¯¹å‘¨æœŸæ€§å‹ç¼©çš„è¡Œä¸ºæ˜¯æœ‰ä¸€å®šå·®å¼‚çš„ï¼Œå…·ä½“çš„åŒºåˆ«ä½ å¯ä»¥å‚è€ƒä¸‹<a href=\"https://github.com/etcd-io/etcd/blob/v3.4.9/Documentation/op-guide/maintenance.md\">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><h2>ç‰ˆæœ¬å·å‹ç¼©</h2><p>äº†è§£å®Œå‘¨æœŸæ€§å‹ç¼©æ¨¡å¼ï¼Œæˆ‘ä»¬å†çœ‹çœ‹ç‰ˆæœ¬å·å‹ç¼©æ¨¡å¼ï¼Œå®ƒåˆé€‚ç”¨äºä»€ä¹ˆåœºæ™¯å‘¢ï¼Ÿ</p><p>å½“ä½ å†™è¯·æ±‚æ¯”è¾ƒå¤šï¼Œå¯èƒ½äº§ç”Ÿæ¯”è¾ƒå¤šçš„å†å²ç‰ˆæœ¬å¯¼è‡´dbå¢é•¿æ—¶ï¼Œæˆ–è€…ä¸ç¡®å®šé…ç½®periodicå‘¨æœŸä¸ºå¤šå°‘æ‰æ˜¯æœ€ä½³çš„æ—¶å€™ï¼Œä½ å¯ä»¥é€šè¿‡è®¾ç½®å‹ç¼©æ¨¡å¼ä¸ºrevisionï¼ŒæŒ‡å®šä¿ç•™çš„å†å²ç‰ˆæœ¬å·æ•°ã€‚æ¯”å¦‚ä½ å¸Œæœ›etcdå°½é‡åªä¿å­˜1ä¸‡ä¸ªå†å²ç‰ˆæœ¬ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŒ‡å®šcompaction-modeä¸ºrevisionï¼Œauto-compaction-retentionä¸º10000ã€‚</p><p>å®ƒçš„å®ç°åŸç†åˆæ˜¯æ€æ ·çš„å‘¢?</p><p>ä¹Ÿå¾ˆç®€å•ï¼Œetcdå¯åŠ¨åä¼šæ ¹æ®ä½ çš„å‹ç¼©æ¨¡å¼revisionï¼Œåˆ›å»ºrevision Compactorã€‚revision Compactorä¼šæ ¹æ®ä½ è®¾ç½®çš„ä¿ç•™ç‰ˆæœ¬å·æ•°ï¼Œæ¯éš”5åˆ†é’Ÿå®šæ—¶è·å–å½“å‰serverçš„æœ€å¤§ç‰ˆæœ¬å·ï¼Œå‡å»ä½ æƒ³ä¿ç•™çš„å†å²ç‰ˆæœ¬æ•°ï¼Œç„¶åé€šè¿‡etcd serverçš„Compactæ¥å£å‘èµ·å¦‚ä¸‹çš„å‹ç¼©æ“ä½œå³å¯ã€‚</p><pre><code># è·å–å½“å‰ç‰ˆæœ¬å·ï¼Œå‡å»ä¿ç•™çš„ç‰ˆæœ¬å·æ•°\nrev := rc.rg.Rev() - rc.retention\n# è°ƒç”¨serverçš„Compactæ¥å£å‹ç¼©\n_ï¼Œerr := rc.c.Compact(rc.ctxï¼Œ&amp;pb.CompactionRequest{Revision: rev})\n</code></pre><h2>å‹ç¼©åŸç†</h2><p>ä»‹ç»å®Œä¸¤ç§è‡ªåŠ¨åŒ–çš„å‹ç¼©æ¨¡å¼åŸç†åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ·±å…¥åˆ†æä¸‹å‹ç¼©çš„æœ¬è´¨ã€‚å½“etcd serveræ”¶åˆ°Compactè¯·æ±‚åï¼Œå®ƒæ˜¯å¦‚ä½•æ‰§è¡Œçš„å‘¢ï¼Ÿ æ ¸å¿ƒåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>å¦‚å‰é¢çš„æ•´ä½“æ¶æ„å›¾æ‰€è¿°ï¼ŒCompactè¯·æ±‚ç»è¿‡Raftæ—¥å¿—åŒæ­¥ç»™å¤šæ•°èŠ‚ç‚¹åï¼Œetcdä¼šä»Raftæ—¥å¿—å–å‡ºCompactè¯·æ±‚ï¼Œåº”ç”¨æ­¤è¯·æ±‚åˆ°çŠ¶æ€æœºæ‰§è¡Œã€‚</p><p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMVCCæ¨¡å—çš„Compactæ¥å£é¦–å…ˆä¼šæ£€æŸ¥Compactè¯·æ±‚çš„ç‰ˆæœ¬å·revæ˜¯å¦å·²è¢«å‹ç¼©è¿‡ï¼Œè‹¥æ˜¯åˆ™è¿”å›ErrCompactedé”™è¯¯ç»™clientã€‚å…¶æ¬¡ä¼šæ£€æŸ¥revæ˜¯å¦å¤§äºå½“å‰etcd serverçš„æœ€å¤§ç‰ˆæœ¬å·ï¼Œè‹¥æ˜¯åˆ™è¿”å›ErrFutureRevç»™clientï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰§è¡Œetcdctl compactå‘½ä»¤æ‰€çœ‹åˆ°çš„é‚£ä¸¤ä¸ªé”™è¯¯åŸç†ã€‚</p><p>é€šè¿‡æ£€æŸ¥åï¼ŒCompactæ¥å£ä¼šé€šè¿‡boltdbçš„APIåœ¨meta bucketä¸­æ›´æ–°å½“å‰å·²è°ƒåº¦çš„å‹ç¼©ç‰ˆæœ¬å·(scheduledCompactedRev)å·ï¼Œç„¶åå°†å‹ç¼©ä»»åŠ¡è¿½åŠ åˆ°FIFO Scheduledä¸­ï¼Œå¼‚æ­¥è°ƒåº¦æ‰§è¡Œã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9a/ff/9ac55d639f564b56324b96dc02f0c0ff.png?wh=1920*1332\" alt=\"\"></p><p>ä¸ºä»€ä¹ˆCompactæ¥å£éœ€è¦æŒä¹…åŒ–å­˜å‚¨å½“å‰å·²è°ƒåº¦çš„å‹ç¼©ç‰ˆæœ¬å·åˆ°boltdbä¸­å‘¢ï¼Ÿ</p><p>è¯•æƒ³ä¸‹å¦‚æœä¸ä¿å­˜è¿™ä¸ªç‰ˆæœ¬å·ï¼Œetcdåœ¨å¼‚æ­¥æ‰§è¡Œçš„Compactä»»åŠ¡è¿‡ç¨‹ä¸­crashäº†ï¼Œé‚£ä¹ˆå¼‚å¸¸èŠ‚ç‚¹é‡å¯åï¼Œå„ä¸ªèŠ‚ç‚¹æ•°æ®å°±ä¼šä¸ä¸€è‡´ã€‚</p><p>å› æ­¤etcdé€šè¿‡æŒä¹…åŒ–å­˜å‚¨scheduledCompactedRevï¼ŒèŠ‚ç‚¹crashé‡å¯åï¼Œä¼šé‡æ–°å‘FIFO Scheduledä¸­æ·»åŠ å‹ç¼©ä»»åŠ¡ï¼Œå·²ä¿è¯å„ä¸ªèŠ‚ç‚¹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>å¼‚æ­¥çš„æ‰§è¡Œå‹ç¼©ä»»åŠ¡ä¼šåšå“ªäº›å·¥ä½œå‘¢ï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸‹<a href=\"https://time.geekbang.org/column/article/340226\">07</a>é‡Œä»‹ç»çš„treeIndexç´¢å¼•æ¨¡å—ï¼Œå®ƒæ˜¯etcdæ”¯æŒä¿å­˜å†å²ç‰ˆæœ¬çš„æ ¸å¿ƒæ¨¡å—ï¼Œæ¯ä¸ªkeyåœ¨treeIndexæ¨¡å—ä¸­éƒ½æœ‰ä¸€ä¸ªkeyIndexæ•°æ®ç»“æ„ï¼Œè®°å½•å…¶å†å²ç‰ˆæœ¬å·ä¿¡æ¯ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/4f/dc/4f9cb015a842da0d5bd556d6b45970dc.png?wh=1920*1124\" alt=\"\"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå› æ­¤å¼‚æ­¥å‹ç¼©ä»»åŠ¡çš„ç¬¬ä¸€é¡¹å·¥ä½œï¼Œå°±æ˜¯<strong>å‹ç¼©treeIndexæ¨¡å—ä¸­çš„å„keyçš„å†å²ç‰ˆæœ¬</strong>ã€å·²åˆ é™¤çš„ç‰ˆæœ¬ã€‚ä¸ºäº†é¿å…å‹ç¼©å·¥ä½œå½±å“è¯»å†™æ€§èƒ½ï¼Œé¦–å…ˆä¼šå…‹éš†ä¸€ä¸ªB-treeï¼Œç„¶åé€šè¿‡å…‹éš†åçš„B-treeéå†æ¯ä¸€ä¸ªkeyIndexå¯¹è±¡ï¼Œå‹ç¼©å†å²ç‰ˆæœ¬å·ã€æ¸…ç†å·²åˆ é™¤çš„ç‰ˆæœ¬ã€‚</p><p>å‡è®¾å½“å‰å‹ç¼©çš„ç‰ˆæœ¬å·æ˜¯CompactedRevï¼Œ å®ƒä¼šä¿ç•™keyIndexä¸­æœ€å¤§çš„ç‰ˆæœ¬å·ï¼Œç§»é™¤å°äºç­‰äºCompactedRevçš„ç‰ˆæœ¬å·ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªmapè®°å½•treeIndexä¸­æœ‰æ•ˆçš„ç‰ˆæœ¬å·è¿”å›ç»™boltdbæ¨¡å—ä½¿ç”¨ã€‚</p><p>ä¸ºä»€ä¹ˆè¦ä¿ç•™æœ€å¤§ç‰ˆæœ¬å·å‘¢?</p><p>å› ä¸ºæœ€å¤§ç‰ˆæœ¬å·æ˜¯è¿™ä¸ªkeyçš„æœ€æ–°ç‰ˆæœ¬ï¼Œç§»é™¤äº†ä¼šå¯¼è‡´keyä¸¢å¤±ã€‚è€ŒCompactçš„ç›®çš„æ˜¯å›æ”¶æ—§ç‰ˆæœ¬ã€‚å½“ç„¶å¦‚æœkeyIndexä¸­çš„æœ€å¤§ç‰ˆæœ¬å·è¢«æ‰“äº†åˆ é™¤æ ‡è®°(tombstone)ï¼Œ å°±ä¼šä»treeIndexä¸­åˆ é™¤è¿™ä¸ªkeyIndexï¼Œå¦åˆ™ä¼šå‡ºç°å†…å­˜æ³„éœ²ã€‚</p><p>Compactä»»åŠ¡æ‰§è¡Œå®Œç´¢å¼•å‹ç¼©åï¼Œå®ƒé€šè¿‡éå†B-treeã€keyIndexä¸­çš„æ‰€æœ‰generationè·å¾—å½“å‰å†…å­˜ç´¢å¼•æ¨¡å—ä¸­æœ‰æ•ˆçš„ç‰ˆæœ¬å·ï¼Œè¿™äº›ä¿¡æ¯å°†å¸®åŠ©etcdæ¸…ç†boltdbä¸­çš„åºŸå¼ƒå†å²ç‰ˆæœ¬ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d6/70/d625753e5a7f0f7f37987764b9204270.png?wh=1920*1129\" alt=\"\"></p><p>å‹ç¼©ä»»åŠ¡çš„ç¬¬äºŒé¡¹å·¥ä½œå°±æ˜¯<strong>åˆ é™¤boltdbä¸­åºŸå¼ƒçš„å†å²ç‰ˆæœ¬æ•°æ®</strong>ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒé€šè¿‡etcdä¸€ä¸ªåä¸ºscheduleCompactionä»»åŠ¡æ¥å®Œæˆã€‚</p><p>scheduleCompactionä»»åŠ¡ä¼šæ ¹æ®keyåŒºé—´ï¼Œä»0åˆ°CompactedRevéå†boltdbä¸­çš„æ‰€æœ‰keyï¼Œé€šè¿‡treeIndexæ¨¡å—è¿”å›çš„æœ‰æ•ˆç´¢å¼•ä¿¡æ¯ï¼Œåˆ¤æ–­è¿™ä¸ªkeyæ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆåˆ™è°ƒç”¨boltdbçš„deleteæ¥å£å°†key-valueæ•°æ®åˆ é™¤ã€‚</p><p>åœ¨è¿™è¿‡ç¨‹ä¸­ï¼ŒscheduleCompactionä»»åŠ¡è¿˜ä¼šæ›´æ–°å½“å‰etcdå·²ç»å®Œæˆçš„å‹ç¼©ç‰ˆæœ¬å·(finishedCompactRev)ï¼Œå°†å…¶ä¿å­˜åˆ°boltdbçš„meta bucketä¸­ã€‚</p><p>scheduleCompactionä»»åŠ¡éå†ã€åˆ é™¤keyçš„è¿‡ç¨‹å¯èƒ½ä¼šå¯¹boltdbé€ æˆå‹åŠ›ï¼Œä¸ºäº†ä¸å½±å“æ­£å¸¸è¯»å†™è¯·æ±‚ï¼Œå®ƒåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šé€šè¿‡å‚æ•°æ§åˆ¶æ¯æ¬¡éå†ã€åˆ é™¤çš„keyæ•°ï¼ˆé»˜è®¤ä¸º100ï¼Œæ¯æ‰¹é—´éš”10msï¼‰ï¼Œåˆ†æ‰¹å®Œæˆboltdb keyçš„åˆ é™¤æ“ä½œã€‚</p><h2>ä¸ºä»€ä¹ˆå‹ç¼©ådbå¤§å°ä¸å‡å°‘å‘¢?</h2><p>å½“ä½ æ‰§è¡Œå®Œå‹ç¼©ä»»åŠ¡åï¼Œdbå¤§å°å‡å°‘äº†å—ï¼Ÿ äº‹å®æ˜¯å¹¶æ²¡æœ‰å‡å°‘ã€‚é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬éƒ½é€šè¿‡boltdb APIåˆ é™¤äº†keyï¼Œdbå¤§å°è¿˜ä¸å‡å°‘å‘¢ï¼Ÿ</p><p>ä¸ŠèŠ‚è¯¾æˆ‘ä»¬ä»‹ç»boltdbå®ç°æ—¶ï¼Œæåˆ°è¿‡boltdbå°†dbæ–‡ä»¶åˆ’åˆ†æˆè‹¥å¹²ä¸ªpageé¡µï¼Œpageé¡µåˆæœ‰å››ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯meta pageã€branch pageã€leaf pageä»¥åŠfreelist pageã€‚branch pageä¿å­˜B+ treeçš„éå¶å­èŠ‚ç‚¹keyæ•°æ®ï¼Œleaf pageä¿å­˜bucketå’Œkey-valueæ•°æ®ï¼Œfreelistä¼šè®°å½•å“ªäº›é¡µæ˜¯ç©ºé—²çš„ã€‚</p><p>å½“æˆ‘ä»¬é€šè¿‡boltdbåˆ é™¤å¤§é‡çš„keyï¼Œåœ¨äº‹åŠ¡æäº¤åB+ treeç»è¿‡åˆ†è£‚ã€å¹³è¡¡ï¼Œä¼šé‡Šæ”¾å‡ºè‹¥å¹²branch/leaf pageé¡µé¢ï¼Œç„¶è€Œboltdbå¹¶ä¸ä¼šå°†å…¶é‡Šæ”¾ç»™ç£ç›˜ï¼Œè°ƒæ•´dbå¤§å°æ“ä½œæ˜¯æ˜‚è´µçš„ï¼Œä¼šå¯¹æ€§èƒ½æœ‰è¾ƒå¤§çš„æŸå®³ã€‚</p><p>boltdbæ˜¯é€šè¿‡freelist pageè®°å½•è¿™äº›ç©ºé—²é¡µçš„åˆ†å¸ƒä½ç½®ï¼Œå½“æ”¶åˆ°æ–°çš„å†™è¯·æ±‚æ—¶ï¼Œä¼˜å…ˆä»ç©ºé—²é¡µæ•°ç»„ä¸­ç”³è¯·è‹¥å¹²è¿ç»­é¡µä½¿ç”¨ï¼Œå®ç°é«˜æ€§èƒ½çš„è¯»å†™ï¼ˆè€Œä¸æ˜¯ç›´æ¥æ‰©å¤§dbå¤§å°ï¼‰ã€‚å½“è¿ç»­ç©ºé—²é¡µç”³è¯·æ— æ³•å¾—åˆ°æ»¡è¶³çš„æ—¶å€™ï¼Œ  boltdbæ‰ä¼šé€šè¿‡å¢å¤§dbå¤§å°æ¥è¡¥å……ç©ºé—²é¡µã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå‹ç¼©æ“ä½œé‡Šæ”¾çš„ç©ºé—²é¡µå°±èƒ½æ»¡è¶³åç»­æ–°å¢å†™è¯·æ±‚çš„ç©ºé—²é¡µéœ€æ±‚ï¼Œdbå¤§å°ä¼šè¶‹äºæ•´ä½“ç¨³å®šã€‚</p><h2>å°ç»“</h2><p>æœ€åæˆ‘ä»¬æ¥å°ç»“ä¸‹ä»Šå¤©çš„å†…å®¹ã€‚</p><p>etcdå‹ç¼©æ“ä½œå¯é€šè¿‡APIäººå·¥è§¦å‘ï¼Œä¹Ÿå¯ä»¥é…ç½®å‹ç¼©æ¨¡å¼ç”±etcd serverè‡ªåŠ¨è§¦å‘ã€‚å‹ç¼©æ¨¡å¼æ”¯æŒæŒ‰å‘¨æœŸå’Œç‰ˆæœ¬ä¸¤ç§ã€‚åœ¨å‘¨æœŸæ¨¡å¼ä¸­ä½ å¯ä»¥å®ç°ä¿ç•™æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å†å²ç‰ˆæœ¬æ•°ï¼Œåœ¨ç‰ˆæœ¬æ¨¡å¼ä¸­ä½ å¯ä»¥å®ç°ä¿ç•™æœŸæœ›çš„å†å²ç‰ˆæœ¬æ•°ã€‚</p><p>å‹ç¼©çš„æ ¸å¿ƒå·¥ä½œåŸç†åˆ†ä¸ºä¸¤å¤§ä»»åŠ¡ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯å‹ç¼©treeIndexä¸­çš„å„keyå†å²ç´¢å¼•ï¼Œæ¸…ç†å·²åˆ é™¤keyï¼Œå¹¶å°†æœ‰æ•ˆçš„ç‰ˆæœ¬å·ä¿å­˜åˆ°mapæ•°æ®ç»“æ„ä¸­ã€‚</p><p>ç¬¬äºŒä¸ªä»»åŠ¡æ˜¯åˆ é™¤boltdbä¸­çš„æ— æ•ˆkeyã€‚åŸºæœ¬åŸç†æ˜¯æ ¹æ®ç‰ˆæœ¬å·éå†boltdbå·²å‹ç¼©åŒºé—´èŒƒå›´çš„keyï¼Œé€šè¿‡treeIndexè¿”å›çš„æœ‰æ•ˆç´¢å¼•mapæ•°æ®ç»“æ„åˆ¤æ–­keyæ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆåˆ™é€šè¿‡boltdb APIåˆ é™¤å®ƒã€‚</p><p>æœ€ååœ¨æ‰§è¡Œå‹ç¼©çš„æ“ä½œä¸­ï¼Œè™½ç„¶æˆ‘ä»¬åˆ é™¤äº†boltdb dbçš„key-valueæ•°æ®ï¼Œä½†æ˜¯dbå¤§å°å¹¶ä¸ä¼šå‡å°‘ã€‚dbå¤§å°ä¸å˜çš„åŸå› æ˜¯å­˜æ”¾key-valueæ•°æ®çš„branchå’Œleafé¡µï¼Œå®ƒä»¬é‡Šæ”¾åå˜æˆäº†ç©ºé—²é¡µï¼Œå¹¶ä¸ä¼šå°†ç©ºé—´é‡Šæ”¾ç»™ç£ç›˜ã€‚</p><p>boltdbé€šè¿‡freelist pageæ¥ç®¡ç†ä¸€ç³»åˆ—ç©ºé—²é¡µï¼Œåç»­æ–°å¢çš„å†™è¯·æ±‚ä¼˜å…ˆä»freelistä¸­ç”³è¯·ç©ºé—²é¡µä½¿ç”¨ï¼Œä»¥æé«˜æ€§èƒ½ã€‚åœ¨å†™è¯·æ±‚é€Ÿç‡ç¨³å®šã€æ–°å¢key-valueè¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œå‹ç¼©æ“ä½œé‡Šæ”¾çš„ç©ºé—²é¡µå°±å¯ä»¥åŸºæœ¬æ»¡è¶³åç»­å†™è¯·æ±‚å¯¹ç©ºé—²é¡µçš„éœ€æ±‚ï¼Œdbå¤§å°å°±ä¼šå¤„äºä¸€ä¸ªåŸºæœ¬ç¨³å®šã€å¥åº·çš„çŠ¶æ€ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ä½ çŸ¥é“å‹ç¼©ä¸ç¢ç‰‡æ•´ç†(defrag)æœ‰å“ªäº›åŒºåˆ«å—ï¼Ÿä¸ºä»€ä¹ˆç¢ç‰‡æ•´ç†ä¼šå½±å“æœåŠ¡æ€§èƒ½å‘¢ï¼Ÿ ä½ èƒ½æƒ³åˆ°å“ªäº›ä¼˜åŒ–æ–¹æ¡ˆæ¥é™ä½ç¢ç‰‡æ•´ç†å¯¹æœåŠ¡æ€§èƒ½çš„å½±å“å‘¢?</p><p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¦‚æœä½ è®¤ä¸ºè¿™èŠ‚è¯¾çš„å†…å®¹æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œè°¢è°¢ã€‚</p>","comments":[{"had_liked":false,"id":278656,"user_name":"äº‘åŸç”Ÿå·¥ç¨‹å¸ˆ","can_delete":false,"product_type":"c1","uid":2243294,"ip_address":"","ucode":"40CB692F21D3BC","user_header":"https://static001.geekbang.org/account/avatar/00/22/3a/de/e5c30589.jpg","comment_is_top":false,"comment_ctime":1613182442,"is_pvip":false,"replies":[{"id":"101354","content":"è°¢è°¢ï¼Œæ–°å¹´å¿«ä¹ï¼Œç¥ç‰›å¹´å‡èŒåŠ è–ª","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1613435750,"ip_address":"","comment_id":278656,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31677953514","product_id":100069901,"comment_content":"æ–°å¹´ä¸è€å¸ˆä¸€å—ç²¾è¿›ï¼Œæ–°å¹´å¿«ä¹ï¼Œç‰›å¹´ä¸€èµ·æ—ºæ—ºæ—ºã€‚","like_count":7,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515460,"discussion_content":"è°¢è°¢ï¼Œæ–°å¹´å¿«ä¹ï¼Œç¥ç‰›å¹´å‡èŒåŠ è–ª","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613435750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282378,"user_name":"ä¸äºŒ","can_delete":false,"product_type":"c1","uid":1027123,"ip_address":"","ucode":"D0700609740FB5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ac/33/110437cc.jpg","comment_is_top":false,"comment_ctime":1615209974,"is_pvip":false,"replies":[{"id":"102608","content":"æ„Ÿè°¢ä½ çš„æé—®ï¼Œå¹³æ—¶æœ‰ä½¿ç”¨è¿‡etcdå—ï¼Ÿ<br>æ¯”å¦‚åŸºæœ¬çš„etcdctlå·¥å…·ï¼Œäº†è§£ä¸‹å¸¸è§çš„å‘½ä»¤ï¼Œä¸‹è½½etcdäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæœ¬åœ°å¯åŠ¨ä¸€ä¸ªetcdé›†ç¾¤ã€‚<br>åŸºç¡€ç¯‡æ¯è®²éƒ½æœ‰ä¸å°‘çš„æ¡ˆä¾‹ï¼Œå»ºè®®ä½ å®é™…åŠ¨æ‰‹æ‰§è¡Œä¸‹ï¼Œå¾ˆå¤šä¸œè¥¿ä½ äº²è‡ªå»ä½“éªŒä¸‹ï¼Œå°±æœ‰ä¸ä¸€æ ·çš„æ”¶è·ã€‚<br>ä¸“æ é¢å‘çš„å¯¹è±¡åŒ…æ‹¬åˆå­¦è€…ã€æœ‰ä¸€å®šçš„åŸºç¡€çš„ã€æœ‰æ¯”è¾ƒä¸°å¯Œç»éªŒçš„åŒå­¦ï¼Œæ¯è®²æœ¬èº«å·²ç»éå¸¸é•¿äº†ï¼Œå—é™äºç¯‡å¹…ï¼Œå› æ­¤å¾ˆå¤šç½‘ä¸Šä¸€æœç´¢çš„å°±èƒ½æ‰¾åˆ°çš„èµ„æºï¼Œæ¯”å¦‚etcdctlä½¿ç”¨ã€etcdé›†ç¾¤æ­å»ºæˆ‘å°±æ²¡ä»‹ç»äº†ï¼Œä¸è¿‡åœ¨åé¢ä¸“æ ç»“æŸåï¼Œæˆ‘è€ƒè™‘å¢åŠ ä¸ªå…¥é—¨ç¯‡ï¼Œæ›´åŠ é€šä¿—æ˜“æ‡‚çš„ï¼Œå¸®åŠ©æ²¡å®é™…ä½¿ç”¨etcdçš„åŒå­¦ä»¬å¿«é€Ÿä¸Šæ‰‹ã€‚<br>å¯¹kubernetesæ¯”è¾ƒäº†è§£å¯ä»¥çœ‹çœ‹19å’Œ20ä¼šä¸ä¼šè®©ä½ æ„Ÿè§‰æ›´åŠ äº²åˆ‡ç‚¹ã€‚<br>æœ€åï¼Œæ¯è®²æœ‰ä»€ä¹ˆç–‘é—®ï¼Œå¯ç›´æ¥ç•™è¨€æé—®å“ˆï¼Œæ²¡äº‹çš„ï¼Œä¸ç”¨æ‹…å¿ƒé—®é¢˜æ˜¯å¦ç®€å•ï¼Œè¯´ä¸å®šå…¶ä»–å…¥é—¨çš„åŒå­¦ä¹Ÿèƒ½é‡åˆ°ã€‚<br>æœ€è¿‘ä¸“æ è¿˜åœ¨å®šæ—¶æ›´æ–°é˜¶æ®µï¼Œéå¸¸å¿™ï¼Œå¯èƒ½è¯„è®ºå›å¤æ²¡é‚£ä¹ˆå¿«ï¼Œå®šæ—¶æ›´æ–°ç»“æŸåï¼Œæˆ‘ä¼šå®šæ—¶æŠ½ç©ºå›ç­”å¤§å®¶é—®é¢˜å“ˆã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1615370611,"ip_address":"","comment_id":282378,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18795079158","product_id":100069901,"comment_content":"è€å¸ˆå¥½ï¼Œæœ‰ä¸€ä¸ªå­¦ä¹ æ–¹é¢çš„ç–‘é—®è¯·æ•™ä¸€ä¸‹ï¼šæˆ‘åœ¨å·¥ä½œä¸­å¤§é‡ä½¿ç”¨åˆ°kubernetesï¼Œç®—æ˜¯æ¯”è¾ƒäº†è§£ï¼Œä½†æ˜¯etcdç¡®å®æ²¡æœ‰æ·±å…¥ã€‚<br>ä¸“æ ä»ç¬¬ä¸€è®²å¼€å§‹ï¼Œæ¯ä¸€è®²çš„å†…å®¹æˆ‘éƒ½çœ‹å¾—æå…¶åƒåŠ›ï¼Œç”šè‡³å®Œå…¨çœ‹ä¸æ‡‚ï¼Œæ˜¯ä¸æ˜¯ç¼ºå°‘äº†å“ªä¸€æ•´å—çš„å…ˆéªŒçŸ¥è¯†ï¼Ÿ<br>æœŸå¾…å¾—åˆ°ä½ çš„å›å¤ï¼","like_count":4,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516724,"discussion_content":"æ„Ÿè°¢ä½ çš„æé—®ï¼Œå¹³æ—¶æœ‰ä½¿ç”¨è¿‡etcdå—ï¼Ÿ\næ¯”å¦‚åŸºæœ¬çš„etcdctlå·¥å…·ï¼Œäº†è§£ä¸‹å¸¸è§çš„å‘½ä»¤ï¼Œä¸‹è½½etcdäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæœ¬åœ°å¯åŠ¨ä¸€ä¸ªetcdé›†ç¾¤ã€‚\nåŸºç¡€ç¯‡æ¯è®²éƒ½æœ‰ä¸å°‘çš„æ¡ˆä¾‹ï¼Œå»ºè®®ä½ å®é™…åŠ¨æ‰‹æ‰§è¡Œä¸‹ï¼Œå¾ˆå¤šä¸œè¥¿ä½ äº²è‡ªå»ä½“éªŒä¸‹ï¼Œå°±æœ‰ä¸ä¸€æ ·çš„æ”¶è·ã€‚\nä¸“æ é¢å‘çš„å¯¹è±¡åŒ…æ‹¬åˆå­¦è€…ã€æœ‰ä¸€å®šçš„åŸºç¡€çš„ã€æœ‰æ¯”è¾ƒä¸°å¯Œç»éªŒçš„åŒå­¦ï¼Œæ¯è®²æœ¬èº«å·²ç»éå¸¸é•¿äº†ï¼Œå—é™äºç¯‡å¹…ï¼Œå› æ­¤å¾ˆå¤šç½‘ä¸Šä¸€æœç´¢çš„å°±èƒ½æ‰¾åˆ°çš„èµ„æºï¼Œæ¯”å¦‚etcdctlä½¿ç”¨ã€etcdé›†ç¾¤æ­å»ºæˆ‘å°±æ²¡ä»‹ç»äº†ï¼Œä¸è¿‡åœ¨åé¢ä¸“æ ç»“æŸåï¼Œæˆ‘è€ƒè™‘å¢åŠ ä¸ªå…¥é—¨ç¯‡ï¼Œæ›´åŠ é€šä¿—æ˜“æ‡‚çš„ï¼Œå¸®åŠ©æ²¡å®é™…ä½¿ç”¨etcdçš„åŒå­¦ä»¬å¿«é€Ÿä¸Šæ‰‹ã€‚\nå¯¹kubernetesæ¯”è¾ƒäº†è§£å¯ä»¥çœ‹çœ‹19å’Œ20ä¼šä¸ä¼šè®©ä½ æ„Ÿè§‰æ›´åŠ äº²åˆ‡ç‚¹ã€‚\næœ€åï¼Œæ¯è®²æœ‰ä»€ä¹ˆç–‘é—®ï¼Œå¯ç›´æ¥ç•™è¨€æé—®å“ˆï¼Œæ²¡äº‹çš„ï¼Œä¸ç”¨æ‹…å¿ƒé—®é¢˜æ˜¯å¦ç®€å•ï¼Œè¯´ä¸å®šå…¶ä»–å…¥é—¨çš„åŒå­¦ä¹Ÿèƒ½é‡åˆ°ã€‚\næœ€è¿‘ä¸“æ è¿˜åœ¨å®šæ—¶æ›´æ–°é˜¶æ®µï¼Œéå¸¸å¿™ï¼Œå¯èƒ½è¯„è®ºå›å¤æ²¡é‚£ä¹ˆå¿«ï¼Œå®šæ—¶æ›´æ–°ç»“æŸåï¼Œæˆ‘ä¼šå®šæ—¶æŠ½ç©ºå›ç­”å¤§å®¶é—®é¢˜å“ˆã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615370611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1210356,"avatar":"https://static001.geekbang.org/account/avatar/00/12/77/f4/f669fcca.jpg","nickname":"ğŸ˜‰","note":"","ucode":"859AAE5AABDF1E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365371,"discussion_content":"æˆ‘ä¹Ÿä¸€æ ·ï¼ŒæK8Sè¿ç»´çš„ï¼Œå¬è¿™ä¸ªå¾ˆè´¹åŠ²","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617784444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":280640,"user_name":"å†™ç‚¹å•¥å‘¢","can_delete":false,"product_type":"c1","uid":1065272,"ip_address":"","ucode":"C19032CF1C41BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/41/38/4f89095b.jpg","comment_is_top":false,"comment_ctime":1614302895,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"18794172079","product_id":100069901,"comment_content":"è¯·é—®è€å¸ˆï¼ŒåŸºäºç‰ˆæœ¬å·å‹ç¼©ä¸­çš„ç‰ˆæœ¬å·æ˜¯etcdçš„å…¨å±€å•è°ƒé€’å¢çš„revisionå§ï¼Œè¿™ç§æ–¹å¼ä¸‹æ¯ä¸ªkeyä¿ç•™çš„å†å²ç‰ˆæœ¬åº”è¯¥æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚Aæ˜¯æ˜¨å¤©ä¿®æ”¹è¿‡10æ¬¡ï¼ŒBæ˜¯æœ€è¿‘ä¿®æ”¹äº†10æ¬¡ï¼Œæ­¤æ—¶å‹ç¼©å¯èƒ½Bä¼šä¿ç•™å¤šä¸ªå†å²ç‰ˆæœ¬è€ŒAå¯èƒ½åªä¿ç•™å½“å‰ç‰ˆæœ¬ï¼Œä¸çŸ¥é“è¿™æ ·ç†è§£æ˜¯å¦æ­£ç¡®ï¼Ÿ<br><br>é‚£ä¹ˆå¦‚æœæ˜¯è¿™æ ·ï¼Œæœ‰æ²¡æœ‰åŠæ³•è®©etcdå‹ç¼©èƒ½å¯¹æ¯ä¸ªkeyå‡åŒ€ä¿ç•™å†å²ç‰ˆæœ¬ï¼Œæ¯”å¦‚æŒ‡å®šæ¯ä¸ªkeyæœ€å°‘ä¿ç•™2ä¸ªç‰ˆæœ¬ï¼Ÿ<br><br>è°¢è°¢è€å¸ˆ","like_count":5,"discussions":[{"author":{"id":1391143,"avatar":"https://static001.geekbang.org/account/avatar/00/15/3a/27/5d218272.jpg","nickname":"å…«å°ä¸Š","note":"","ucode":"FB3D74B522C720","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390249,"discussion_content":"ç›®å‰çœ‹æ¥æ˜¯ä¸è¡Œçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629728338,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":278649,"user_name":"Geek_cb2b43","can_delete":false,"product_type":"c1","uid":2253932,"ip_address":"","ucode":"BB6C92BDCA0761","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/05Wiazxo0OS5w9KdJ4OQAe7RzgyHLuBCMNrZicDAQ8ZlSMx4NNdAgSLBYPJGn9W1y45ZTtUMlCxsQHqD7ycicQJyg/132","comment_is_top":false,"comment_ctime":1613177143,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"18793046327","product_id":100069901,"comment_content":"å‹ç¼©çš„ç¬¬ä¸€é¡¹ä»»åŠ¡ä¸­å…‹éš†B+treeï¼Œæ˜¯å¦‚ä½•ä¿ä¸¤ä»½æ•°æ®ä¸€è‡´çš„å‘¢ï¼Ÿå³å¦‚æœåœ¨æ­¤æœŸé—´B+treeå‡ºç°äº†åˆ†è£‚ï¼ŒåŸæ¥çš„è®°å½•å¯èƒ½å‘ç”Ÿäº†å˜åŒ–","like_count":4,"discussions":[{"author":{"id":1795511,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/65/b7/058276dc.jpg","nickname":"i_chase","note":"","ucode":"09C41C863F4EA3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570347,"discussion_content":"func (ti *treeIndex) Compact(rev int64) map[revision]struct{} {\n\tavailable := make(map[revision]struct{})\n\tti.lg.Info(&#34;compact tree index&#34;, zap.Int64(&#34;revision&#34;, rev))\n\tti.Lock()\n\tclone := ti.tree.Clone()\n\tti.Unlock()\n\n\t//å¤åˆ¶ä¸€ä»½tree index\n\tclone.Ascend(func(item btree.Item) bool {\n\t\tkeyi := item.(*keyIndex)\n\t\t// Lock is needed here to prevent modification to the keyIndex while\n\t\t// compaction is going on or revision added to empty before deletion\n\t\tti.Lock()\n\t\tkeyi.compact(ti.lg, rev, available) //åˆ é™¤tree indexä¸Šéœ€è¦compactçš„keyIndexã€‚availableæ˜¯ä»éœ€è¦ä¿ç•™çš„revision\n\t\tif keyi.isEmpty() {\n\t\t\titem := ti.tree.Delete(keyi)\n\t\t\tif item == nil {\n\t\t\t\tti.lg.Panic(&#34;failed to delete during compaction&#34;)\n\t\t\t}\n\t\t}\n\t\tti.Unlock()\n\t\treturn true\n\t})\n\treturn available\n}","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651739012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1795511,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/65/b7/058276dc.jpg","nickname":"i_chase","note":"","ucode":"09C41C863F4EA3","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":570346,"discussion_content":"tree indexæ˜¯b-treeã€‚å¤„ç†æ¯ä¸ªkeyIndexçš„æ—¶å€™æœ‰åŠ é”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651738996,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313782,"user_name":"å…«å°ä¸Š","can_delete":false,"product_type":"c1","uid":1391143,"ip_address":"","ucode":"FB3D74B522C720","user_header":"https://static001.geekbang.org/account/avatar/00/15/3a/27/5d218272.jpg","comment_is_top":false,"comment_ctime":1632664163,"is_pvip":false,"replies":[{"id":"114590","content":"å—¯ï¼ŒdefragæœŸé—´ä¼šæŒæœ‰boltdbäº‹åŠ¡é”å¯¼è‡´è¯»å†™è¶…æ—¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦defragçš„ï¼Œåªæœ‰å½“æœªé…ç½®compactç­–ç•¥æˆ–é…ç½®çš„ç­–ç•¥éå¸¸ä¸åˆç†ã€ä»¥åŠçº¿ä¸Šçªå‘å¤§è§„æ¨¡å†™å…¥ç­‰åœºæ™¯ä¸‹å¯¼è‡´dbæ–‡ä»¶éå¸¸å¤§çš„æ—¶å€™æ‰éœ€è¦æ‰§è¡Œdefragã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1634311965,"ip_address":"","comment_id":313782,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10222598755","product_id":100069901,"comment_content":"è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ defrag çš„æ—¶å€™ æ˜¯ä¸æ˜¯æœåŠ¡ä¸å¯ç”¨å‘€ï¼Ÿ å¦‚æœæ˜¯ ä»€ä¹ˆæ—¶æœºdefrag å‘¢","like_count":2,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527468,"discussion_content":"å—¯ï¼ŒdefragæœŸé—´ä¼šæŒæœ‰boltdbäº‹åŠ¡é”å¯¼è‡´è¯»å†™è¶…æ—¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦defragçš„ï¼Œåªæœ‰å½“æœªé…ç½®compactç­–ç•¥æˆ–é…ç½®çš„ç­–ç•¥éå¸¸ä¸åˆç†ã€ä»¥åŠçº¿ä¸Šçªå‘å¤§è§„æ¨¡å†™å…¥ç­‰åœºæ™¯ä¸‹å¯¼è‡´dbæ–‡ä»¶éå¸¸å¤§çš„æ—¶å€™æ‰éœ€è¦æ‰§è¡Œdefragã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634311965,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":313739,"user_name":"å…«å°ä¸Š","can_delete":false,"product_type":"c1","uid":1391143,"ip_address":"","ucode":"FB3D74B522C720","user_header":"https://static001.geekbang.org/account/avatar/00/15/3a/27/5d218272.jpg","comment_is_top":false,"comment_ctime":1632642131,"is_pvip":false,"replies":[{"id":"114591","content":"æœ‰è¶£çš„é—®é¢˜ï¼Œå„ä¸ªèŠ‚ç‚¹éƒ½ä¼šå‘èµ·compactè¯·æ±‚ï¼Œetcdä¼šè®°å½•å·²å‹ç¼©çš„æœ€å¤§ç‰ˆæœ¬å·ï¼Œå¦‚æœå…¶ä»–èŠ‚ç‚¹å‘èµ·çš„compactç‰ˆæœ¬å·å°äºå®ƒï¼Œå°±ç›´æ¥è¿”å›ErrCompactedäº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1634312184,"ip_address":"","comment_id":313739,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10222576723","product_id":100069901,"comment_content":"æƒ³é—®ä¸€ä¸‹ å¦‚æœä¸åŒçš„etcd serveré…ç½®çš„auto compact ç­–ç•¥ä¸ä¸€æ ·  ä»¥è°ä¸ºå‡†å‘¢","like_count":2,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527455,"discussion_content":"æœ‰è¶£çš„é—®é¢˜ï¼Œå„ä¸ªèŠ‚ç‚¹éƒ½ä¼šå‘èµ·compactè¯·æ±‚ï¼Œetcdä¼šè®°å½•å·²å‹ç¼©çš„æœ€å¤§ç‰ˆæœ¬å·ï¼Œå¦‚æœå…¶ä»–èŠ‚ç‚¹å‘èµ·çš„compactç‰ˆæœ¬å·å°äºå®ƒï¼Œå°±ç›´æ¥è¿”å›ErrCompactedäº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634312184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":302747,"user_name":"æµ·é˜”å¤©ç©º","can_delete":false,"product_type":"c1","uid":1733275,"ip_address":"","ucode":"8658B1610192E7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJOBwR7MCVqwZzc3keFAJT12Sic3VYWx4PrZbCGDm4kBZD3oqnR4xsibGGtGy4tFO8y05Ims27SiaavA/132","comment_is_top":false,"comment_ctime":1626353259,"is_pvip":false,"replies":[{"id":"110134","content":"æ„Ÿè°¢æ”¯æŒï¼Œæœ€è¿‘é¡¹ç›®å’Œå®¶åº­äº‹æƒ…æ¯”è¾ƒå¤šï¼Œæ€è€ƒé¢˜ç­”æ¡ˆæˆ‘å°†å°½å¿«åœ¨å‘¨æœ«æŠ½ç©ºè¡¥å……å¥½ï¼ˆé¢„è®¡9æœˆä»½ï¼‰","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1627367680,"ip_address":"","comment_id":302747,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5921320555","product_id":100069901,"comment_content":"æ€è€ƒé¢˜çš„ç­”æ¡ˆä»€ä¹ˆæ˜¯å¯ä»¥ç»Ÿä¸€ç»™å‡ºå‘€","like_count":1,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":523408,"discussion_content":"æ„Ÿè°¢æ”¯æŒï¼Œæœ€è¿‘é¡¹ç›®å’Œå®¶åº­äº‹æƒ…æ¯”è¾ƒå¤šï¼Œæ€è€ƒé¢˜ç­”æ¡ˆæˆ‘å°†å°½å¿«åœ¨å‘¨æœ«æŠ½ç©ºè¡¥å……å¥½ï¼ˆé¢„è®¡9æœˆä»½ï¼‰","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1627367680,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":356153,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"æ¹–åŒ—","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1662015061,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1662015061","product_id":100069901,"comment_content":"æ€è€ƒé¢˜é‡Œé¢å…³äºå‹ç¼©å’Œç¢ç‰‡åŒ–ï¼Œæˆ‘æ¥è§¦è¿‡ï¼Œç®€å•åˆ†äº«ä¸€ä¸‹ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿé‡Œé¢ï¼Œæ‰€è°“çš„ç¢ç‰‡åŒ–ï¼Œæ˜¯æ–‡ä»¶çš„å…¶ä¸­éƒ¨åˆ†åŒºé—´æ•°æ®è¢«åˆ æ‰äº†ï¼Œå¯¼è‡´å‰åä¸è¿ç»­ï¼Œä¸ºäº†è®©æ•°æ®è¯»å†™æ›´å¿«ï¼Œæœ‰æ—¶å€™ä¼šé‡æ–°åˆ†é…ä¸€ä¸ªè¿ç»­çš„åŒºé—´æ¥åŠ é€Ÿå¹¶ä¸”å‡å°‘ç¢ç‰‡åŒ–çš„ã€‚ å› æ­¤ç¢ç‰‡åŒ–çš„ä½œç”¨ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åˆ é™¤æ•°æ®ï¼Œæ›´å¤šçš„æ˜¯é€šè¿‡ç”³è¯·æ–°çš„æ•°æ®ç©ºé—´ï¼Œæ¥è®©åŸæ¥çš„æ•°æ®åœ¨ç£ç›˜çš„ç‰©ç†ç©ºé—´æ›´åŠ ä¸€è‡´ï¼Œè®©éšæœºè¯»å†™å˜æˆé¡ºåºè¯»å†™ã€‚<br><br>è€Œetcdçš„å‹ç¼©åˆ™æ˜¯ï¼Œå…¶å®è¿™é‡Œå°±æ˜¯ä¼šåˆ é™¤æ•°æ®äº†ã€‚","like_count":0},{"had_liked":false,"id":334415,"user_name":"è“è“ä¾ ","can_delete":false,"product_type":"c1","uid":1620722,"ip_address":"","ucode":"2E02AC43D21103","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDRPejHodutia9Ud8UZLY8g5lTkKXgf3J104c0jM9aFfAGNoUdxkRLnnWRc5Kd3jIeN3EqXxKFT0g/132","comment_is_top":false,"comment_ctime":1644925275,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1644925275","product_id":100069901,"comment_content":"treeIndex compactçš„æ—¶å€™ï¼Œæ‹·è´ä¸€ä¸ªbæ ‘å¤„ç†ï¼Œå¤„ç†å®Œåï¼Œæ€ä¹ˆæ›¿æ¢å½“å‰å†…å­˜ä¸­ä½¿ç”¨çš„é‚£ï¼Ÿå¢é‡å¦‚ä½•å¤„ç†é‚£ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2012886,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/b6/d6/3b1fbf9b.jpg","nickname":"2018","note":"","ucode":"436D1F4CA63CB9","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":565739,"discussion_content":"\tclone := ti.tree.Clone()\n\tti.Unlock()\n\n\tclone.Ascend(func(item btree.Item) bool {\n\t\tkeyi := item.(*keyIndex)\n\t\t// Lock is needed here to prevent modification to the keyIndex while\n\t\t// compaction is going on or revision added to empty before deletion\n\t\tti.Lock()\n\t\tkeyi.compact(ti.lg, rev, available)\n\t\tif keyi.isEmpty() {\n\t\t\titem := ti.tree.Delete(keyi)\n\t\t\tif item == nil {\n\t\t\t\tti.lg.Panic(&#34;failed to delete during compaction&#34;)\n\t\t\t}\n\t\t}\n\t\tti.Unlock()\n\t\treturn true\n\t})","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1650532444,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1368768,"avatar":"https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg","nickname":"chongsheng","note":"","ucode":"859DF328FCA608","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":557376,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1647782205,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":320900,"user_name":"æ„è„¾æ°”çš„æ„å¦–ç²¾","can_delete":false,"product_type":"c1","uid":2132933,"ip_address":"","ucode":"81778A821819FA","user_header":"https://static001.geekbang.org/account/avatar/00/20/8b/c5/6e06e49c.jpg","comment_is_top":false,"comment_ctime":1636548160,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"1636548160","product_id":100069901,"comment_content":"è€å¸ˆï¼Œä½ å¥½ï¼Œæˆ‘æƒ³é—®å°±æ˜¯ç”¨etcdctl,etcd 3.4ç‰ˆæœ¬ï¼Œæˆ‘è®¾ç½®å‘¨æœŸè‡ªåŠ¨å‹ç¼©24h,ä½ æ–‡ç« ä¸­è¯´æ˜¯åˆ†æˆåä¸ªé—´éš”ï¼Œä½†æ˜¯æˆ‘çœ‹æˆ‘çš„æ—¥å¿—æ˜¯1å°æ—¶ä¸ºé—´éš”ï¼Œè¿˜è¦å°±æ˜¯æ¯”å¦‚è¯´æˆ‘è¿™24å°æ—¶éƒ½æ²¡æœ‰å¯¹etcdäº§ç”Ÿrevisionæ•°æ®çš„æ“ä½œï¼Œé‚£æœ€ç»ˆè‡ªåŠ¨å‹ç¼©ä¹‹ååªä¼šä¿ç•™æœ€æ–°çš„revisionæ•°æ®å§ï¼Œæ¯”å¦‚è¯´æœ€æ–°çš„revvisionæ˜¯11ï¼Œï¼Œä½†æ˜¯æœ‰æŠ¥warningï¼Œå°±æ˜¯è¯´æœ€æ–°çš„11ç‰ˆæœ¬å·²ç»è¢«å‹ç¼©ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºä»–ä¼šæ ‡è®°æœ€æ–°çš„revisionæ˜¯11ï¼Œä»–ä¸èƒ½è¢«å‹ç¼©æ˜¯å§ï¼Œä½†æ˜¯è¿™ä¸ªwarningæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œæœ›è§£ç­”ï¼Œ2021-11-10 19:02:59.643037 N | compactor: Starting auto-compaction at revision 11 (retention: 24h0m0s)<br>2021-11-10 19:02:59.643281 W | etcdserver: failed to apply request &quot;header:&lt;ID:5580941819101844742 &gt; compaction:&lt;revision:11 &gt; &quot; with response &quot;&quot; took (10.017?s) to execute, err is mvcc: required revision has been compacted<br>2021-11-10 19:02:59.643309 N | compactor: Finished auto-compaction at revision 11<br>2021-11-10 20:02:59.662628 N | compactor: Starting auto-compaction at revision 11 (retention: 24h0m0s)<br>2021-11-10 20:02:59.662873 W | etcdserver: failed to apply request &quot;header:&lt;ID:5580941819101844743 &gt; compaction:&lt;revision:11 &gt; &quot; with response &quot;&quot; took (9.473?s) to execute, err is mvcc: required revision has been compacted<br>2021-11-10 20:02:59.662907 N | compactor: Finished auto-compaction at revision 11<br>","like_count":0,"discussions":[{"author":{"id":1635542,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/PoJwvAqp3658sonACyia1VOicKG4ncRqKbtQiayiaVJp1BbUrBQFfH5eibEoejh9GIToU2SsibsanntZeft9YGhCTfhA/132","nickname":"Geek_2a4ae2","note":"","ucode":"98CB6A81C7FBB6","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":583425,"discussion_content":"3.3.3ç‰ˆæœ¬ä»¥åï¼Œå¦‚æœé…ç½®å‹ç¼©å‘¨æœŸå¤§äº1hï¼Œæ‰§è¡Œé—´éš”æ˜¯1hï¼Œå¦‚æœå°äº1hæ¯”å¦‚30mï¼Œæ‰§è¡Œé—´éš”æ˜¯30m(å³é…ç½®æ—¶é—´)ï¼Œä¸å†æ˜¯ä¹‹å‰çš„1/10æ—¶é—´ï¼› \nå¦‚æœæ˜¯æŒ‰ç…§ç‰ˆæœ¬å‹æµ‹ï¼Œæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1660113152,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¤©æ´¥"},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1752348,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/jA97yib7VetXc4iclOg2gGfZu1fO7efyib2mKeqvIxDdmgLqukusyFzPrbIQeZYR0WDJUicRakgVGroaYC7aWGFrEw/132","nickname":"Turing","note":"","ucode":"F88679276D4841","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":532635,"discussion_content":"æ˜¯ä¸æ˜¯å¤šä¸ªèŠ‚ç‚¹éƒ½é…ç½®äº†è‡ªåŠ¨å‹ç¼©çš„ç­–ç•¥?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1637657918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"user_type\":1}","child_discussion_number":1,"child_discussions":[{"author":{"id":2132933,"avatar":"https://static001.geekbang.org/account/avatar/00/20/8b/c5/6e06e49c.jpg","nickname":"æ„è„¾æ°”çš„æ„å¦–ç²¾","note":"","ucode":"81778A821819FA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1752348,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/jA97yib7VetXc4iclOg2gGfZu1fO7efyib2mKeqvIxDdmgLqukusyFzPrbIQeZYR0WDJUicRakgVGroaYC7aWGFrEw/132","nickname":"Turing","note":"","ucode":"F88679276D4841","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534645,"discussion_content":"åªèµ·äº†å•èŠ‚ç‚¹çš„ï¼Œè¿˜è¦æƒ³é—®å¯¹äºetcd 3.4 ç‰ˆæœ¬ï¼Œ24å°æ—¶çš„å‹ç¼©ç­–ç•¥ï¼Œåœ¨ç¬¬ä¸€ä¸ª24å°æ—¶ä¹‹åçš„æ¯ä¸€ä¸ªå°æ—¶å‹ç¼©ä¸€æ¬¡æ˜¯å—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638249247,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":532635,"ip_address":""},"score":534645,"extra":""}]}]},{"had_liked":false,"id":315396,"user_name":"types","can_delete":false,"product_type":"c1","uid":2449777,"ip_address":"","ucode":"8B50927EF1804F","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132","comment_is_top":false,"comment_ctime":1633877532,"is_pvip":false,"replies":[{"id":"114587","content":"å—¯ï¼Œetcdæœ‰è®°å½•å·²å‹ç¼©æœ€å¤§çš„ç‰ˆæœ¬å·ï¼Œä¸ä¼šé‡å¤å‹ç¼©ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1634309611,"ip_address":"","comment_id":315396,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1633877532","product_id":100069901,"comment_content":"å¦‚æœæ˜¯etcd é›†ç¾¤ï¼Œ æ¯ä¸ªèŠ‚ç‚¹éƒ½é…ç½®äº†è‡ªåŠ¨å‹ç¼©ç­–ç•¥ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šäº§ç”ŸCompactè¯·æ±‚å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":527950,"discussion_content":"å—¯ï¼Œetcdæœ‰è®°å½•å·²å‹ç¼©æœ€å¤§çš„ç‰ˆæœ¬å·ï¼Œä¸ä¼šé‡å¤å‹ç¼©ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634309611,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308673,"user_name":"å…«å°ä¸Š","can_delete":false,"product_type":"c1","uid":1391143,"ip_address":"","ucode":"FB3D74B522C720","user_header":"https://static001.geekbang.org/account/avatar/00/15/3a/27/5d218272.jpg","comment_is_top":false,"comment_ctime":1629728621,"is_pvip":false,"replies":[{"id":"112699","content":"ä½ å¥½ï¼Œä½ åº”è¯¥æ˜¯æŒ‡å‹ç¼©å§ï¼Œé»˜è®¤æ²¡å¼€å¯å†å²æ•°æ®å‹ç¼©åŠŸèƒ½ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªè¦ä½ ä¸ä¿ç•™å¤ªä¹…(æ¯”å¦‚6hä»¥ä¸Š)ï¼Œå†™å…¥ä¸è¦å¤ªé¢‘ç¹ï¼Œdbå¤§å°ä¼šä¿æŒç¨³å®šçš„ã€‚ç¢ç‰‡æ•´ç†æ˜¯æŒ‡defragå‘½ä»¤ï¼Œå®ƒçš„æ ¸å¿ƒåŸç†æ˜¯éå†è€dbæ•°æ®ï¼Œé‡æ–°å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„dbæ–‡ä»¶ï¼Œä½¿å…¶æ›´ç´§å‡‘ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹ä¼šå½±å“etcdå¯ç”¨æ€§ã€‚ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸‹ä¸éœ€è¦æ‰§è¡Œdefragå‘½ä»¤ï¼Œé™¤éå†™å…¥å¤§é‡æ•°æ®åï¼Œåˆåˆ é™¤äº†æ•°æ®ï¼Œdbæ–‡ä»¶ç‰¹åˆ«å¤§ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1631026772,"ip_address":"","comment_id":308673,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1629728621","product_id":100069901,"comment_content":"æƒ³é—®ä¸€ä¸‹   ç›¸å½“äºæ²¡æœ‰è‡ªåŠ¨æ¸…ç†ç¢ç‰‡çš„é…ç½®æ˜¯å—   æ‰€ä»¥å¦‚æœè‡ªåŠ¨å‹ç¼©ç­–ç•¥å’Œå†™å…¥é¢‘ç‡  é…åˆä¸å¥½çš„è¯  dbæ–‡ä»¶æ˜¯ä¼šè†¨èƒ€çš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525583,"discussion_content":"ä½ å¥½ï¼Œä½ åº”è¯¥æ˜¯æŒ‡å‹ç¼©å§ï¼Œé»˜è®¤æ²¡å¼€å¯å†å²æ•°æ®å‹ç¼©åŠŸèƒ½ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªè¦ä½ ä¸ä¿ç•™å¤ªä¹…(æ¯”å¦‚6hä»¥ä¸Š)ï¼Œå†™å…¥ä¸è¦å¤ªé¢‘ç¹ï¼Œdbå¤§å°ä¼šä¿æŒç¨³å®šçš„ã€‚ç¢ç‰‡æ•´ç†æ˜¯æŒ‡defragå‘½ä»¤ï¼Œå®ƒçš„æ ¸å¿ƒåŸç†æ˜¯éå†è€dbæ•°æ®ï¼Œé‡æ–°å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„dbæ–‡ä»¶ï¼Œä½¿å…¶æ›´ç´§å‡‘ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹ä¼šå½±å“etcdå¯ç”¨æ€§ã€‚ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸‹ä¸éœ€è¦æ‰§è¡Œdefragå‘½ä»¤ï¼Œé™¤éå†™å…¥å¤§é‡æ•°æ®åï¼Œåˆåˆ é™¤äº†æ•°æ®ï¼Œdbæ–‡ä»¶ç‰¹åˆ«å¤§ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631026772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":295734,"user_name":"Geek_a69552","can_delete":false,"product_type":"c1","uid":2369839,"ip_address":"","ucode":"D5776850E4911E","user_header":"","comment_is_top":false,"comment_ctime":1622564840,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622564840","product_id":100069901,"comment_content":"è€å¸ˆå¥½ï¼Œæƒ³é—®ä¸€ä¸‹ã€‚åœ¨å‹ç¼©treeindexæ—¶ï¼Œå…‹éš†ä¸€ä¸ªB+æ ‘ï¼Œå¯¹è¯¥æ ‘è¿›è¡Œæ“ä½œã€‚é‚£ä¹ˆåˆ é™¤treeindexçš„æ— æ•ˆæ•°æ®åï¼Œæ€ä¹ˆæ¸…ç†åçš„B+æ ‘æ›¿æ¢åŸæœ‰çš„treeindexï¼Œä»¥åŠåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ–°å†™å…¥çš„æ•°æ®ï¼Œæ€ä¹ˆåŒæ­¥åˆ°è¿™ä¸ªæ–°treeindexä¸Šã€‚è¿˜æ˜¯è¯´å…‹éš†çš„ç›®çš„åªæ˜¯è·å–å½“å‰æœ‰æ•ˆçš„key reverionï¼Œå¹¶ä¸ä¼šæ¸…ç†treeindex","like_count":0},{"had_liked":false,"id":294689,"user_name":"å“ˆå¸Œç¢°æ’","can_delete":false,"product_type":"c1","uid":1244496,"ip_address":"","ucode":"DF82678E60095D","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM49ONuR097wB6LqR8nn5kWiaQiaPic1y8UznibDOScQergTj5qeL6zQ4bIicYEkqlMiash3CUCAYmSt9tQA/132","comment_is_top":false,"comment_ctime":1622042874,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1622042874","product_id":100069901,"comment_content":"è¯·é—®,etcd ç¢ç‰‡æ•´ç† å®‰å…¨å—ï¼Œä¼šä¸ä¼šé€ æˆæ•°æ®æŸåæˆ–è€…ä¸¢å¤±ï¼Ÿ<br>etcd ç¢ç‰‡æ•´ç†å’Œå‹ç¼©æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ","like_count":0},{"had_liked":false,"id":283883,"user_name":"ly","can_delete":false,"product_type":"c1","uid":1004331,"ip_address":"","ucode":"EA0C159386898E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/53/2b/94b5b872.jpg","comment_is_top":false,"comment_ctime":1615971504,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1615971504","product_id":100069901,"comment_content":"defrag ä¼šblock å†™æ•°æ®ï¼Œç»å¸¸ä¼šå¯¼è‡´ä¸€äº›åˆ‡ä¸»çš„è¡Œä¸ºã€‚<br>è€å¸ˆè¿™è¾¹æœ‰ä»€ä¹ˆå¥½çš„å»ºè®®å—","like_count":0},{"had_liked":false,"id":280930,"user_name":"ä¸€æ­¥","can_delete":false,"product_type":"c1","uid":1005391,"ip_address":"","ucode":"73CEA468CE70C3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg","comment_is_top":false,"comment_ctime":1614493809,"is_pvip":true,"replies":[{"id":"102014","content":"éƒ½å¯ä»¥çš„å“ˆ","user_name":"ä½œè€…å›å¤","user_name_real":"å”èª","uid":"1009582","ctime":1614521748,"ip_address":"","comment_id":280930,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1614493809","product_id":100069901,"comment_content":"etcd çš„é…ç½®å‚æ•°åªèƒ½åœ¨å¯åŠ¨çš„æ—¶å€™å†™åˆ°åé¢å—ï¼Ÿ  ä¸èƒ½ç”¨ç»Ÿä¸€å†™åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1009582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/67/ae/37b492db.jpg","nickname":"å”èª","note":"","ucode":"99CB061EDF35EA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516248,"discussion_content":"éƒ½å¯ä»¥çš„å“ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614521748,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}