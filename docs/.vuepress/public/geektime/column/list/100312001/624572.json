{"id":624572,"title":"22｜如何使用 ArgoCD 快速打造生产可用的 GitOps 工作流？","content":"<p>你好，我是王炜。</p><p>在之前的课程中，我们学习了如何使用 Kustomize 和 Helm 和来定义应用。其中，Helm Chart在实际工作中使用较多，它有两种存储方式，一种是以源码的方式存储在 Git 仓库中，另一种是以 tgz 压缩包的方式存储在专用的 OCI 仓库中。</p><p>此外，在自动化镜像构建部分，我还向你介绍了如何使用 GitHub Action、GitLab CI 以及自托管 Tekton 来自动构建镜像。</p><p>当我们具备这些 GitOps 的核心基础后，接下来我们就可以根据实际场景，选择合适的技术栈来构建 GitOps 流水线了。</p><p>在这节课，我仍然会以示例应用为例，使用 GitHub Action 和 Helm 分别作为自动构建镜像和应用定义的工具，并通过 ArgoCD 来构建一个完整的 GitOps 工作流。</p><p>在开始今天的学习之前，你需要准备好下面这几个条件。</p><ul>\n<li>按照<a href=\"https://time.geekbang.org/column/article/612571\">第 2 讲</a>的内容在本地配置好 Kind 集群，安装 Ingress-Nginx，<strong>并暴露 80 和 443 端口。</strong></li>\n<li>配置好 Kubectl，使其能够访问 Kind 集群。</li>\n<li>克隆 <a href=\"https://github.com/lyzhang1999/kubernetes-example\">kubernetes-example</a> 示例应用代码并推送到自己的 GitHub 仓库中，然后按照<a href=\"https://time.geekbang.org/column/article/622743\">第 16 讲</a>的内容配置好 GitHub Action 和 DockerHub Registry。</li>\n</ul><!-- [[[read_end]]] --><h2>ArgoCD</h2><p>在“从零上手 GitOps”这一章，我使用了 FluxCD 来构建 GitOps 流水线。FluxCD 的主要特点是比较轻量，但同时也缺少友好的 UI 控制台。相比较而言，在社区和维护方面，ArgoCD 更为活跃。所以，<strong>在生产环境下，我推荐你使用 ArgoCD 来构建 GitOps 工作流</strong>。</p><h3>安装 ArgoCD</h3><p>要使用 ArgoCD，首先需要在 Kind 集群安装它，你可以通过下面的命令来安装。</p><p>首先，创建 argocd 命名空间。</p><pre><code class=\"language-powershell\">$ kubectl create namespace argocd\nnamespace/argocd created\n</code></pre><p>然后，部署 ArgoCD。</p><pre><code class=\"language-plain\">$ kubectl apply -n argocd -f https://ghproxy.com/https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml\ncustomresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created\ncustomresourcedefinition.apiextensions.k8s.io/applicationsets.argoproj.io created\ncustomresourcedefinition.apiextensions.k8s.io/appprojects.argoproj.io created\n......\n</code></pre><p>最后，等待 argocd 命名空间所有的工作负载处于就绪状态。</p><pre><code class=\"language-plain\">$ kubectl wait --for=condition=Ready pods --all -n argocd --timeout 300s\npod/argocd-application-controller-0 condition met\npod/argocd-applicationset-controller-57bfc6fdb8-x5jxc condition met\n......\n</code></pre><p>请注意，由于云厂商 Kubernetes 版本存在差异，所以如果你在安装过程中发现 argocd-repo-server 工作负载一直无法启动，可以尝试删除 argocd-repo-server Deployment seccompProfile 节点的内容。</p><pre><code class=\"language-plain\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: argocd-repo-server\nspec:\n  template:\n    spec:\n      securityContext:\n        seccompProfile:\n          type: RuntimeDefault\n</code></pre><h3>安装 ArgoCD CLI</h3><p>为了更加方便地配置 ArgoCD，官方还为我们提供了 CLI 工具。不同操作系统的安装方法有所差异，这里以 MacOS 和 Windows 为例简单介绍。</p><p>MacOS 可以通过 Brew 来安装。</p><pre><code class=\"language-plain\">$ brew install argocd\n</code></pre><p>也可以在<a href=\"https://github.com/argoproj/argo-cd/releases\">这个链接</a>下载最新版本的 Binary 二进制文件，并移动到 /usr/local/bin/ 目录下。</p><p>Windows 则需要在下载过后，将可执行文件移动到 PATH 下。</p><p>更详细的方法可以查看<a href=\"https://argo-cd.readthedocs.io/en/stable/cli_installation/\">这份文档。</a></p><h3>本地访问 ArgoCD</h3><p>要在本地访问 ArgoCD，最简单的方式是通过端口转发来完成。你可以使用下面的命令来进行端口转发。</p><pre><code class=\"language-plain\">$ kubectl port-forward service/argocd-server 8080:80 -n argocd\nForwarding from 127.0.0.1:8080 -&gt; 8080\nForwarding from [::1]:8080 -&gt; 8080\n</code></pre><p>接下来，使用浏览器打开：<a href=\"http://127.0.0.1:8080\">http://127.0.0.1:8080</a>，这样就可以访问 ArgoCD 控制台了，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/de/14/dee91919a11f2b01615738a899eab414.png?wh=1920x1010\" alt=\"\"></p><p>ArgoCD 的默认账号为 admin，密码可以通过下面的命令来获取。</p><pre><code class=\"language-plain\">$ kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d\nGn4b2PFG6vKm1ADm\n</code></pre><p>登录后，即可访问 ArgoCD 的控制台。</p><h2>GitOps 工作流总览</h2><p>到这里，你是不是已经迫不及待想要构建工作流了？别急，在创建 GitOps 工作流之前，我们先来认识一下一个完整 GitOps 工作流都需要哪些关键步骤。</p><p><img src=\"https://static001.geekbang.org/resource/image/d5/1a/d597b74ec83be42c2308d251c7868c1a.jpg?wh=1920x604\" alt=\"\"></p><p>我们可以把这个完整的 GitOps 工作流分成三个部分来看。</p><p>第一部分是开发者推送代码到 GitHub 仓库，然后触发 GitHub Action 自动构建。</p><p>第二部分是 GitHub Action 自动构建，它包括下面三个步骤。</p><pre><code>1. 构建示例应用的镜像。\n2. 将示例应用的镜像推送到 Docker Registry 镜像仓库。\n3. 更新代码仓库中 Helm Chart values.yaml 文件的镜像版本。\n</code></pre><p>第三部分的核心是 ArgoCD，它包括下面两个步骤。</p><pre><code>4. 通过定期 Poll 的方式持续拉取 Git 仓库，并判断是否有新的 commit。\n5. 从 Git 仓库获取 Kubernetes 对象，与集群对象进行实时比较，自动更新集群内有差异的资源。\n</code></pre><p>在之前的课程中，我们已经为示例应用创建好了 GitHub Action 来自动构建镜像，但还缺少自动更新 Helm Chart values.yaml 文件的镜像版本逻辑，我会在稍后进行配置。</p><p>现在，我们开始创建 GitOps 工作流中的第三部分，也就是创建 ArgoCD 应用，实现 Kubernetes 资源的自动同步。</p><h2>创建 ArgoCD 应用</h2><p>我们以示例应用为例子来创建 ArgoCD 应用，这里主要分成两个步骤。</p><ol>\n<li>配置仓库访问权限。</li>\n<li>创建 ArgoCD 应用。</li>\n</ol><p>其中，如果你的示例应用仓库是公开的，可以跳过第一步。</p><h3>配置 ArgoCD 仓库访问权限（可选）</h3><p>在实际场景下，我们存放应用定义的仓库一般都是私有仓库，这就需要为 ArgoCD 配置仓库访问权限。</p><p>你可以通过下面的 ArgoCD CLI 工具来为 ArgoCD 添加仓库访问权限。</p><p>在使用 ArgoCD CLI 工具之前，你需要先执行 argocd login 命令登录。</p><pre><code class=\"language-plain\">$ argocd login 127.0.0.1:8080 --insecure\nUsername: admin\nPassword:\n'admin:login' logged in successfully\n</code></pre><p>注意，这里我们指定了 ArgoCD 的服务端地址为 127.0.0.1:8080，并且使用了 --insecur 参数来跳过 SSL 认证，你需要保持在上面运行的端口转发命令才能够顺利登录。</p><p>登录成功后，通过 argocd repo add 命令添加你的示例应用仓库。</p><pre><code class=\"language-plain\">$ argocd repo add https://github.com/lyzhang1999/kubernetes-example.git --username $USERNAME --password $PASSWORD\nRepository 'https://github.com/lyzhang1999/kubernetes-example.git' added\n</code></pre><p>这里要注意将仓库地址修改为你实际的 GitHub 仓库地址，并将 <code>$USERNAME</code> 替换为 GitHub 账户 ID，将 <code>$PASSWORD</code> 替换为 GitHub Personal Token。你可以在<a href=\"https://github.com/settings/tokens\">这个页面</a>创建 GitHub Personal Token，并赋予仓库相关权限，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/ba/35/ba7703a5429af8f1b0ccf34174114035.png?wh=1608x1056\" alt=\"图片\"></p><h3>创建 ArgoCD 应用</h3><p>接下来，就可以创建 ArgoCD 应用了。ArgoCD 同时支持使用 Helm Chart、Kustomize 和 Manifest 来创建应用，这里我们以示例应用的 Helm Chart 为例。</p><p>你可以通过 argocd app create 命令来创建应用。</p><pre><code class=\"language-plain\">$ argocd app create example --sync-policy automated --repo https://github.com/lyzhang1999/kubernetes-example.git --revision main --path helm --dest-namespace gitops-example --dest-server https://kubernetes.default.svc --sync-option CreateNamespace=true\napplication 'example' created\n</code></pre><p>这里我简单解释一下每个参数的作用。</p><p>–sync-policy 参数代表设置自动同步策略。automated 的含义是自动同步，也就是说当集群内的资源和 Git 仓库 Helm Chart 定义的资源有差异时，ArgoCD 会自动执行同步操作，实时确保集群资源和 Helm Chart 的一致性。</p><p>–repo 参数表示 Helm Chart 的仓库地址。这里的值是示例应用的仓库地址，注意需要替换成你实际的 Git 仓库地址。</p><p>–revision 参数表示需要跟踪的分支或者 Tag，这里我们让 ArgoCD 跟踪 main 分支的改动。</p><p>–path 参数表示 Helm Chart 的路径。在示例应用中，存放 Helm Chart 的目录是 helm 目录。</p><p>–dest-namespace 参数表示命名空间。这里指定了 gitops-example 命名空间，注意，这是一个不存在的命名空间，所以我们额外通过 --sync-option 参数来让 ArgoCD 自动创建这个命名空间。</p><p>最后，–dest-server 参数表示要部署的集群，<a href=\"https://kubernetes.default.svc\">https://kubernetes.default.svc</a> 表示 ArgoCD 所在的集群。</p><h3>查看 ArgoCD 同步状态</h3><p>创建好应用之后，GitOps 工作流中的自动同步部分也就建立起来了。现在，你可以打开 ArgoCD 控制台，进入左侧的“Application”菜单来查看示例应用详情。</p><p><img src=\"https://static001.geekbang.org/resource/image/23/34/23df1a812a1a4ea33ddaf3d63ba97b34.png?wh=4320x2272\" alt=\"图片\"></p><p>在应用详情页面，我们需要重点关注三个状态。</p><ol>\n<li>\n<p><strong>APP HEALTH：</strong>应用整体的健康状态，它包含下面三个值。</p>\n<ol>\n<li>Progressing：处理中</li>\n<li>Healthy：健康状态</li>\n<li>Degraded：宕机</li>\n</ol>\n</li>\n<li>\n<p><strong>CURRENT SYNC STATUS：</strong> 应用定义和集群对象的差异状态，也包含下面三个值。</p>\n<ol>\n<li>Synced：完全同步</li>\n<li>OutOfSync：存在差异</li>\n<li>Unknown：未知</li>\n</ol>\n</li>\n<li>\n<p><strong>LAST SYNC RESULT：</strong>最后一次同步到 Git 仓库的信息，包括 Commit ID 和提交者信息。</p>\n</li>\n</ol><h3>访问应用</h3><p>当应用健康状态变为 Healthy 之后，我们就可以访问应用了。</p><p>在这之前，如果你已经在 example 命名空间下手动部署了示例应用，为了避免 Ingress 策略冲突，你需要先删除这个命名空间。</p><pre><code class=\"language-plain\">$ kubectl delete ns example\n</code></pre><p>然后，使用浏览器访问 <a href=\"http://127.0.0.1\">http://127.0.0.1</a>，你应该能看到示例应用的界面，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/5b/58/5b67ae11fa94d69132955524d9dcyy58.png?wh=4320x2272\" alt=\"图片\"></p><p>到这里，ArgoCD 部分就配置完成了。</p><h2>连接 GitOps 工作流</h2><p>在完成 ArgoCD 的应用配置之后，我们就已经将示例应用的 Helm Chart 定义和集群资源关联起来了，但整个 GitOps 工作流还缺少非常重要的一部分，就是我在上面提到的自动更新 Helm Chart values.yaml 文件镜像版本的部分，我在下面这张示意图中用“❌”把这个环节标记了出来。</p><p><img src=\"https://static001.geekbang.org/resource/image/d2/0f/d214c5416ab33f2f876b74baecf4550f.jpg?wh=1920x607\" alt=\"\"></p><p>在这部分工作流没有打通之前，提交的新代码虽然会构建出新的镜像，但是 Helm Chart 定义的镜像版本并不会产生变化，<strong>这会导致 ArgoCD 不能自动更新集群内工作负载的镜像版本</strong>。</p><p>要解决这个问题，我们还需要在 GitHub Action 中添加自动修改 Helm Chart 并重新推送到仓库操作。</p><p>接下来，我们修改示例应用的 .github/workflows/build.yaml 文件，在“Build frontend and push”阶段后面添加一个新的阶段，代码如下。</p><pre><code class=\"language-powershell\">- name: Update helm values.yaml\n&nbsp; uses: fjogeleit/yaml-update-action@main\n&nbsp; with:\n&nbsp; &nbsp; valueFile: 'helm/values.yaml'\n&nbsp; &nbsp; commitChange: true\n    branch: main\n    message: 'Update Image Version to ${{ steps.vars.outputs.sha_short }}'\n&nbsp; &nbsp; changes: |\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; \"backend.tag\": \"${{ steps.vars.outputs.sha_short }}\",\n&nbsp; &nbsp; &nbsp; &nbsp; \"frontend.tag\": \"${{ steps.vars.outputs.sha_short }}\"\n&nbsp; &nbsp; &nbsp; }\n</code></pre><p>在这里，我使用了 GitHub Action 中 yaml-update-action 插件来修改 values.yaml 文件并把它推送到仓库。如果你是使用 GitLab 或者 Tekton 构建镜像，可以调用 yq 命令行工具来修改 YAML 文件，再使用 git 命令行将变更推送到仓库。</p><p>到这里，<strong>一个完整的 GitOps 工作流就建立好了</strong>。</p><h3>体验 GitOps 工作流</h3><p>接下来，你可以尝试修改 frontend/src/App.js 文件，例如修改文件第 49 行的“Hi! I am a geekbang”。修改完成后，<strong>将代码推送到 GitHub 仓库 main 分支</strong>，此时，GitHub Action 会自动构建镜像，并且还会更新代码仓库中 Helm values.yaml 文件的镜像版本。</p><p><img src=\"https://static001.geekbang.org/resource/image/2d/e7/2d292107a101c522af9fedbabe8339e7.png?wh=1920x845\" alt=\"图片\"></p><p>ArgoCD 默认每 3 分钟会拉取仓库检查是否有新的提交，你也可以在 ArgoCD 控制台手动点击 Sync 按钮来触发同步。</p><p><img src=\"https://static001.geekbang.org/resource/image/be/14/be46c591ddd73yy3da6d4a930ae9c414.png?wh=1920x409\" alt=\"图片\"></p><p>ArgoCD 同步完成后，我们可以在“LAST SYNC RESULT”一栏中看到 GitHub Action 修改 values.yaml 的提交记录，当应用状态为 Healthy 时，我们就可以访问新的应用版本了。</p><p><img src=\"https://static001.geekbang.org/resource/image/d8/e6/d878f196cd14d116bae01fdfc3f6cbe6.png?wh=4320x2272\" alt=\"图片\"></p><p>从截图可以看出，前端界面输出内容为“Hi, I am GitOps workflow”，说明 ArgoCD 已经将新版本的应用部署到集群中了。</p><p>自此，我们体验了提交代码到构建镜像、修改应用定义和更新自动化的全流程。</p><h2>生产建议</h2><p>在生产环境下，我也给你提几个 ArgoCD 的配置建议，你可以根据实际情况来配置。</p><h3>建议一：修改默认密码</h3><p>默认情况下，ArgoCD 会在部署时生成一个随机密码，为了方便记忆和增加密码强度，你可以使用下面的命令来修改密码。</p><pre><code class=\"language-plain\">$ argocd account update-password\n*** Enter password of currently logged in user (admin):\n*** Enter new password for user admin:\n</code></pre><p>要注意是的是，在修改密码前，你需要先使用 argocd login 登录到 ArgoCD 服务端。</p><h3>建议二：配置 Ingress 和 TLS</h3><p>在生产环境下，为了更方便地访问 ArgoCD，你可以为它配置 Ingress，你可以将下面的 Ingress 对象部署到集群内。</p><pre><code class=\"language-plain\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd-server-ingress\n  namespace: argocd\n  annotations:\n    cert-manager.io/cluster-issuer: letsencrypt-prod\n    kubernetes.io/ingress.class: nginx\n    kubernetes.io/tls-acme: \"true\"\n    nginx.ingress.kubernetes.io/ssl-passthrough: \"true\"\n    nginx.ingress.kubernetes.io/backend-protocol: \"HTTPS\"\nspec:\n  rules:\n  - host: argocd.example.com\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service: \n            name: argocd-server\n            port:\n              name: https\n  tls:\n  - hosts:\n    - argocd.example.com\n    secretName: argocd-secret # do not change, this is provided by Argo CD\n</code></pre><p>此外，你还需要安装 Cert-manager，具体方法可以参考<a href=\"https://time.geekbang.org/column/article/624150\">第 19 讲</a>的内容。</p><h3>建议三：使用 Webhook 触发 ArgoCD</h3><p>在这节课的例子中，我们在创建应用的时候提供了参数 --sync-policy=automated。这时候，ArgoCD 会默认以 3 分钟一次的频率来自动拉取仓库的更改，在生产环境下，这个同步频率可能并不能满足快速发布的要求。</p><p>如果 ArgoCD 可以在公网进行访问，那么你就可以使用 ArgoCD 提供的 Webhook 触发方式来解决这个问题了，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/e9/9d/e907726d7f2eded0cc2eb3a923538c9d.jpg?wh=1920x617\" alt=\"\"></p><p>和主动 Poll 模型不同的是，源码仓库在收到开发者推送代码的事件后，将实时通过 HTTP 请求来通知 ArgoCD，也就是图中红色字体的部分。</p><p>要使用 Webhook 通知的方式，首先你需要在源码仓库进行配置。以 GitHub 为例，首先进入仓库的“Settings”页面，点击左侧的“Webhook”菜单进入配置页面，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/0b/cd2676a447fe66666e5yyd2611ea4b0b.png?wh=1564x1608\" alt=\"图片\"></p><p>在 Payload URL 中输入你的 ArgoCD Server 外网访问域名，/api/webhook ArgoCD 专门用于接收外部 Webhook 消息的固定路径。</p><p>Content type 选择 application/json，并在 Secret 中输入你要配置的 Webhook 的密钥，这个密钥需要提供给 ArgoCD 来校验 Webhook 来源是否合法。</p><p>接下来点击“Add webhook” 就可以保存了。</p><p>接下来，你还需要为 ArgoCD 提供 GitHub Webhook 密钥，使用下面的命令来编辑 argocd-secret 对象。</p><pre><code class=\"language-powershell\">$ kubectl edit secret argocd-secret -n argocd\n</code></pre><p>并将 GitHub Webhook 的密钥加入到 Secret 对象的内容里。</p><pre><code class=\"language-yaml\">apiVersion: v1\nkind: Secret\nmetadata:\n  name: argocd-secret\n  namespace: argocd\ntype: Opaque\ndata:\n...\nstringData:\n  # 加入这一项\n  webhook.github.secret: my-secret\n</code></pre><p>注意，stringData 可以直接输入 Webhook Secret 内容而不需要进行 Base64 编码。</p><p>如果你使用的是其他的代码托管平台，例如 GitLab，可以参考<a href=\"https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/\">这份文档</a>进行配置。</p><h3>建议四：将源码仓库和应用定义仓库分离</h3><p>为了方便演示，我将示例应用的源码和 Helm Chart 存储在了同一个 Git 仓库，实际上，<strong>这并不是一个好的实践。</strong></p><p>这种方案有两个比较大的问题。首先，当我们手动修改 Helm Chart 并推送到 Git 仓库之后，在业务代码不变的情况下也会触发应用镜像构建，这个过程是没有必要的。</p><p>其次，在有一定规模的团队中，开发和发布过程是分开的，应用定义仓库一般只有基础架构部门或者 SRE 部门具有修改权限，将源码和应用定义放在同一个 Git 仓库不利于权限控制，开发者也很容易误操作。</p><p><strong>所以，基于上面这两个问题，我强烈建议你将业务代码和应用定义分开存储</strong>。</p><h3>建议五：加密 GitOps 中存储的秘钥</h3><p>在示例应用中，我使用的是 DockerHub 公开仓库，所以 Kubernetes 集群不需要镜像拉取凭据就可以拉取到镜像。</p><p>在实际生产环境下，一般我们会使用内部自建例如 Harbor 私有仓库。所以在大部分情况下，我们会在 Helm Chart 里增加一个包含镜像拉取凭据的 Secret 对象。</p><pre><code class=\"language-plain\">apiVersion: v1\nkind: Secret\nmetadata:\n&nbsp; name: regcred\ntype: kubernetes.io/dockerconfigjson\ndata:\n&nbsp; .dockerconfigjson: &gt;-\n&nbsp; &nbsp; eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJseXpoYW5nMTk5OSIsInBhc3N3b3JkIjoibXktdG9rZW4iLCJhdXRoIjoiYkhsNmFHRnVaekU1T1RrNmJYa3RkRzlyWlc0PSJ9fX0=\n</code></pre><p>这样，当 ArgoCD 部署应用时，会一并将拉取凭据部署到集群中，这就解决了镜像拉取权限的问题。</p><p>但是，Secret 对象并没有加密功能，<strong>这可能会导致凭据泄露。</strong>所以，我们需要对这些敏感信息进行加密处理。关于如何加密秘钥，我会在后续“多环境管理和安全”章节为你详细介绍。</p><h2>总结</h2><p>在这节课，我以示例应用为例，将 GitHub Action、应用定义以及 ArgoCD 连接起来，构建了完整的 GitOps 工作流。</p><p>通过这个例子我们会发现，建立完整的 GitOps 工作流涉及到下面这几个技术：</p><ol>\n<li>Docker 镜像</li>\n<li>CI 构建</li>\n<li>镜像仓库</li>\n<li>应用定义</li>\n<li>Kubernetes</li>\n<li>ArgoCD</li>\n</ol><p>在建立 GitOps 工作流的过程中，通常有两个难点。<strong>第一是如何进行技术选型和组合，第二是如何将它们连接起来。</strong></p><p>我先总结一下如何解决第一个问题：技术选型和组合。</p><p>在这节课的例子中，我使用了 GitHub Action 作为 CI 构建工具，此外，你还可以选择 GitLab CI 或者自托管的 Tekton 。对于镜像仓库，我使用了 DockerHub 来存储镜像，你也可以使用 GitHub Package 或者自建 Harbor 来存储镜像。最后，在应用定义方面，我使用了 Helm Chart 作为例子，你还可以选择 Kustomize 甚至是 Kubernetes Manifest 。</p><p>在建立 GitOps 的过程中，你可以根据团队实际的情况，对这些技术栈任意组合。</p><p>对于如何连接的问题，它最底层的追问是，在构建好镜像并将其推送到镜像仓库之后，怎么通知 ArgoCD 部署新镜像版本。</p><p>在这节课的例子中，我在 GitHub Action 里修改了 values.yaml 文件，并将其推送到了 Git 仓库，所以会产生新的 commit，进而达到通知 ArgoCD 的效果。</p><p><strong>这种方式虽然能解决问题，但在一些场景下可能并不适合</strong>。例如，在开发和发布相对独立的场景下，因为权限和安全的问题可能并不允许 CI 直接修改应用定义。在这种情况下，我们就可以使用另外一种方式来通知 ArgoCD，也就是 <strong>Argo CD Image Updater。</strong>它可以通过监听镜像版本的更新来触发 ArgoCD 同步，我们会在下一节课详细介绍。</p><h2>思考题</h2><p>最后，给你留一道思考题吧。</p><p>在 ArgoCD 自动同步完成后，应用的“CURRENT SYNC STATUS”会从“Synced”很快变为“OutOfSync”，这是为什么呢？如何解决？</p><p>欢迎你给我留言交流讨论，你也可以把这节课分享给更多的朋友一起阅读。我们下节课见。</p>","comments":[{"had_liked":false,"id":370849,"user_name":"邵涵","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"北京","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1679315674,"is_pvip":false,"replies":[{"id":135309,"content":"回答正确。解决方案也非常简单，把 Deployment 的 replicas 字段删除即可，这样该字段会由 HPA 的最小副本数控制。\n另外两个问题提的非常好，你可以参考 27 讲的内容，多环境自动创建的方法。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1679363394,"ip_address":"广东","comment_id":370849,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"对于思考题，CURRENT SYNC STATUS 从 Synced 变为 OutOfSync 可能是应用定义中的Deployment的replicas指定的数量与k8s集群中该Deployment下pod的实际数量不符造成的吗？因为集群中Deployment下的pod实际数量可能是HPA动态管控的\n如果是这个原因的话，那是有什么方法可以声明忽略对这个数量的比对吗？\n\n另外，还有两个问题，使用ArgoCD做自动的拉取、比对，和更新k8s集群中对象\n1. 如何指定给某个环境使用的values-xxx.yaml文件？\n2. 如果是要同时更新多个环境，是要为每个环境都创建一个ArgoCD应用吗？","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610040,"discussion_content":"回答正确。解决方案也非常简单，把 Deployment 的 replicas 字段删除即可，这样该字段会由 HPA 的最小副本数控制。\n另外两个问题提的非常好，你可以参考 27 讲的内容，多环境自动创建的方法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679363395,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368359,"user_name":"gyl1989113","can_delete":false,"product_type":"c1","uid":1363213,"ip_address":"四川","ucode":"B7F2860B3FB101","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","comment_is_top":false,"comment_ctime":1676254100,"is_pvip":false,"replies":[{"id":134152,"content":"尝试用 git 协议，这个仓库是公开的。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1676261183,"ip_address":"广东","comment_id":368359,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"argocd repo add https:&#47;&#47;github.com&#47;xxx&#47;kubernetes-example.git --username xxx --password xxx 为什么我执行这句报错rpc error: code = Unknown desc = error testing repository connectivity: authentication required","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603650,"discussion_content":"尝试用 git 协议，这个仓库是公开的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676261184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1363213,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","nickname":"gyl1989113","note":"","ucode":"B7F2860B3FB101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603765,"discussion_content":"谢老，这个问题已经解决，但是按照文档一步步操作新出现错误，github action构建镜像成功，但是尝试修改helm value.yaml出现Error: HttpError: Resource not accessible by integration","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676278580,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"四川","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367007,"user_name":"无名无姓","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"北京","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1674798830,"is_pvip":false,"replies":[{"id":133916,"content":"没有开源方案，可以自研~","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675416197,"ip_address":"广东","comment_id":367007,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"这个流程可以放在一个平台里面监控么","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601821,"discussion_content":"没有开源方案，可以自研~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416197,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":378915,"user_name":"Sophia-百鑫","can_delete":false,"product_type":"c1","uid":1269105,"ip_address":"上海","ucode":"070DC977441003","user_header":"https://static001.geekbang.org/account/avatar/00/13/5d/71/4f6aad17.jpg","comment_is_top":false,"comment_ctime":1690970135,"is_pvip":false,"replies":[{"id":138070,"content":"是一种方案，另一种方案是使用 argo image updater 自动监听镜像版本的变化。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1691019635,"ip_address":"广东","comment_id":378915,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师好，如果技术栈是   gitlabCI  pipeline +ArgoCD,应用定义 helm chart，\n              如果修改 gitlab-ci.yaml文件，使CI 自动修改 helm  values.yaml 文件 的 image tag ？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624869,"discussion_content":"是一种方案，另一种方案是使用 argo image updater 自动监听镜像版本的变化。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1691019635,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372194,"user_name":"辣条愛乃","can_delete":false,"product_type":"c1","uid":1616998,"ip_address":"湖北","ucode":"89EE26AF40E920","user_header":"https://static001.geekbang.org/account/avatar/00/18/ac/66/9bc49bcd.jpg","comment_is_top":false,"comment_ctime":1680835790,"is_pvip":false,"replies":[{"id":135832,"content":"把 gitlab ci 当做是一台机器，本质上可以通过 shell 命令实现任何操作，比如编辑 yaml 文件可以用 yq 命令行工具。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1680836850,"ip_address":"广东","comment_id":372194,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"请教下，&quot;连接GitOps工作流&quot;这一步，我使用的gitlab，但是似乎没有找到，类似github的&quot;valueFile&quot;用来修改helm里面的tag id，不知道gitlab是怎么修改的","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":612661,"discussion_content":"把 gitlab ci 当做是一台机器，本质上可以通过 shell 命令实现任何操作，比如编辑 yaml 文件可以用 yq 命令行工具。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680836850,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371468,"user_name":"辣条愛乃","can_delete":false,"product_type":"c1","uid":1616998,"ip_address":"湖北","ucode":"89EE26AF40E920","user_header":"https://static001.geekbang.org/account/avatar/00/18/ac/66/9bc49bcd.jpg","comment_is_top":false,"comment_ctime":1679975645,"is_pvip":false,"replies":[{"id":135566,"content":"看着是网络原因导致的，你可以尝试用托管的 GitLab 跑流程。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1679987156,"ip_address":"广东","comment_id":371468,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"自己搭建的gitlab，但是报错\nFATA[0003] rpc error: code = Unknown desc = error testing repository connectivity: Get &quot;https:&#47;&#47;www.gittest.com&#47;root&#47;kubernetes-example.git&#47;info&#47;refs?service=git-upload-pack&quot;: dial tcp 128.14.151.194:443: connect: connection refused ","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611233,"discussion_content":"看着是网络原因导致的，你可以尝试用托管的 GitLab 跑流程。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679987156,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370825,"user_name":"大圈","can_delete":false,"product_type":"c1","uid":1803089,"ip_address":"北京","ucode":"17932DD2349C38","user_header":"https://static001.geekbang.org/account/avatar/00/1b/83/51/aa521f2a.jpg","comment_is_top":false,"comment_ctime":1679305762,"is_pvip":false,"replies":[{"id":135294,"content":"很容易实现，Jenkins 里通过 shell 命令调用 YQ 工具来更新 helm chart，核心原理不变，只要能更新 values.yaml 即可。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1679307094,"ip_address":"广东","comment_id":370825,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"感谢老师的解答，还有一个问题请教一下：\n我们目前直接使用jenkins做CI&#47;CD，然后我准备把CD工具替换为argocd。\n关于&quot;自动更新 Helm Chart values.yaml 文件镜像版本的部分&quot;这块实践，看老师的教程可得github、gitlab-ci都可以实现。但是我暂时不想用gitlab-ci做CI工具，继续使用Jenkins做CI操作的话能否实现&quot;自动更新 Helm Chart values.yaml 文件镜像版本的部分&quot;呢？\n我目前想到的方案就是通过自己写脚本来实现了。","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":609945,"discussion_content":"很容易实现，Jenkins 里通过 shell 命令调用 YQ 工具来更新 helm chart，核心原理不变，只要能更新 values.yaml 即可。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679307094,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370477,"user_name":"大圈","can_delete":false,"product_type":"c1","uid":1803089,"ip_address":"北京","ucode":"17932DD2349C38","user_header":"https://static001.geekbang.org/account/avatar/00/1b/83/51/aa521f2a.jpg","comment_is_top":false,"comment_ctime":1678866654,"is_pvip":false,"replies":[{"id":135121,"content":"非常好的问题，你可以查看第27讲，这里面有提到多环境管理。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1678874971,"ip_address":"广东","comment_id":370477,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"请教一下，假如我有3个java服务，每个服务对应3套环境，test,preview,product，那么我是不是就得给这3个服务分别创建3个application，在argocd上。\n\n有什么好的方式来解决在argocd上重复创建application的问题吗？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":609214,"discussion_content":"非常好的问题，你可以查看第27讲，这里面有提到多环境管理。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678874971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369612,"user_name":"bob","can_delete":false,"product_type":"c1","uid":2057134,"ip_address":"广东","ucode":"26E2840FB5C048","user_header":"https://static001.geekbang.org/account/avatar/00/1f/63/ae/eb536e1d.jpg","comment_is_top":false,"comment_ctime":1677727534,"is_pvip":false,"replies":[{"id":134689,"content":"示例应用的后端服务的镜像版本 latest 和 1276e23 都是运行正常的，请问你使用的镜像版本是？","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1677734370,"ip_address":"广东","comment_id":369612,"utype":1}],"discussion_count":5,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师，您好！请问后端运行报错会是什么原因？谢谢！\nTraceback (most recent call last):\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;runpy.py&quot;, line 194, in _run_module_as_main\n  return _run_code(code, main_globals, None,\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;runpy.py&quot;, line 87, in _run_code\n  exec(code, run_globals)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;flask&#47;__main__.py&quot;, line 3, in &lt;module&gt;\n  main()\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;flask&#47;cli.py&quot;, line 1050, in main\n  cli.main()\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;click&#47;core.py&quot;, line 1055, in main\n  rv = self.invoke(ctx)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;click&#47;core.py&quot;, line 1657, in invoke\n  return _process_result(sub_ctx.command.invoke(sub_ctx))\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;click&#47;core.py&quot;, line 1404, in invoke\n  return ctx.invoke(self.callback, **ctx.params)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;click&#47;core.py&quot;, line 760, in invoke\n  return __callback(*args, **kwargs)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;click&#47;decorators.py&quot;, line 84, in new_func\n  return ctx.invoke(f, obj, *args, **kwargs)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;click&#47;core.py&quot;, line 760, in invoke\n  return __callback(*args, **kwargs)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;flask&#47;cli.py&quot;, line 911, in run_command\n  raise e from None\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;flask&#47;cli.py&quot;, line 897, in run_command\n  app = info.load_app()\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;flask&#47;cli.py&quot;, line 312, in load_app\n  app = locate_app(import_name, None, raise_if_not_found=False)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;flask&#47;cli.py&quot;, line 218, in locate_app\n  __import__(module_name)\nFile &quot;&#47;app&#47;app.py&quot;, line 18, in &lt;module&gt;\n  db.init_app(app)\nFile &quot;&#47;usr&#47;local&#47;lib&#47;python3.8&#47;site-packages&#47;flask_sqlalchemy&#47;extension.py&quot;, line 253, in init_app\n  raise RuntimeError(\nRuntimeError: A &#39;SQLAlchemy&#39; instance has already been registered on this Flask app. Import and use that instance instead.","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607279,"discussion_content":"示例应用的后端服务的镜像版本 latest 和 1276e23 都是运行正常的，请问你使用的镜像版本是？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677734370,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2057134,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/63/ae/eb536e1d.jpg","nickname":"bob","note":"","ucode":"26E2840FB5C048","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":607368,"discussion_content":"按照这个步骤：克隆 kubernetes-example 示例应用代码并推送到自己的 GitHub 仓库中，然后按照第 16 讲的内容配置好 GitHub Action 和 DockerHub Registry，因此镜像版本就是重新生成的了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677813049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":607279,"ip_address":"广东","group_id":0},"score":607368,"extra":""}]},{"author":{"id":1206126,"avatar":"https://static001.geekbang.org/account/avatar/00/12/67/6e/d59a413f.jpg","nickname":"羽仔","note":"","ucode":"F364B23E857DB2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":619781,"discussion_content":"试试把backend/app.py文件里“db = SQLAlchemy(app)”改为“db = SQLAlchemy()”","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1685496673,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"美国","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":2863876,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/b3/04/791d0f5e.jpg","nickname":"凡之","note":"","ucode":"1EA24BB5780C5C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1206126,"avatar":"https://static001.geekbang.org/account/avatar/00/12/67/6e/d59a413f.jpg","nickname":"羽仔","note":"","ucode":"F364B23E857DB2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":644672,"discussion_content":"有效","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1715417695,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":619781,"ip_address":"北京","group_id":0},"score":644672,"extra":""}]},{"author":{"id":2485491,"avatar":"https://static001.geekbang.org/account/avatar/00/25/ec/f3/f140576e.jpg","nickname":"Jich","note":"","ucode":"7127C10EBB27F0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610418,"discussion_content":"我也存在这个问题，一模一样的。请问解决了吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679554265,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369060,"user_name":"加菲老猫","can_delete":false,"product_type":"c1","uid":1316514,"ip_address":"上海","ucode":"65FE75E211BCD3","user_header":"https://static001.geekbang.org/account/avatar/00/14/16/a2/26ed8f44.jpg","comment_is_top":false,"comment_ctime":1677052215,"is_pvip":false,"replies":[{"id":134424,"content":"把 updateFile 参数删除即可。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1677056867,"ip_address":"广东","comment_id":369060,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师您好，我尝试根据您的范例，在github action中 Update helm values.yaml遇到以下错误，请您给个思路，谢谢！\n\n\n\nupdateFile is deprected, the updated content will be written to the file by default from now on\nError: HttpError: Resource not accessible by integration","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606288,"discussion_content":"把 updateFile 参数删除即可。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677056867,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368262,"user_name":"Andrew","can_delete":false,"product_type":"c1","uid":1856849,"ip_address":"美国","ucode":"B1598E1E447EC6","user_header":"https://static001.geekbang.org/account/avatar/00/1c/55/51/c7bffc64.jpg","comment_is_top":false,"comment_ctime":1676079982,"is_pvip":false,"replies":[{"id":134093,"content":"Values.yaml 文件需要静态的内容。不支持这种方式。可以调研一下 helmfile 是否满足你的诉求。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1676084994,"ip_address":"广东","comment_id":368262,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"是否可以通过export环境变量的方式\n\n比如\n定义values.yaml\nimage:\n  tag: _${IMAGE_TAG}\n然后再deploy的时候通过脚本 export IMAGE_TAG=${DOCKER_IMAGE_ID}","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603294,"discussion_content":"Values.yaml 文件需要静态的内容。不支持这种方式。可以调研一下 helmfile 是否满足你的诉求。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676084994,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368132,"user_name":"BertGeek","can_delete":false,"product_type":"c1","uid":1452799,"ip_address":"上海","ucode":"8E1D72C9F9778C","user_header":"https://static001.geekbang.org/account/avatar/00/16/2a/ff/a9d72102.jpg","comment_is_top":false,"comment_ctime":1675927513,"is_pvip":false,"replies":[{"id":134033,"content":"ArgoCD 会在集群部署一个 Redis 实例，从稳定性的角度考虑可以用云厂商的托管 Redis 服务。其他的都是 CRD 资源持久化在 ETCD，只要保证 K8s 的可用性就可以了。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675930253,"ip_address":"广东","comment_id":368132,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"最近项目也要实现灰度发布，项目落地argocd方案\n1. argocd 是否需要持久化部署，比如挂载云盘等\n2. argocd 3个状态是必须ok，才能确定定义资源yaml和集群资源状态一致","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603070,"discussion_content":"ArgoCD 会在集群部署一个 Redis 实例，从稳定性的角度考虑可以用云厂商的托管 Redis 服务。其他的都是 CRD 资源持久化在 ETCD，只要保证 K8s 的可用性就可以了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675930253,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1452799,"avatar":"https://static001.geekbang.org/account/avatar/00/16/2a/ff/a9d72102.jpg","nickname":"BertGeek","note":"","ucode":"8E1D72C9F9778C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603085,"discussion_content":"谢谢！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675935316,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367620,"user_name":"bob","can_delete":false,"product_type":"c1","uid":2057134,"ip_address":"广东","ucode":"26E2840FB5C048","user_header":"https://static001.geekbang.org/account/avatar/00/1f/63/ae/eb536e1d.jpg","comment_is_top":false,"comment_ctime":1675385325,"is_pvip":false,"replies":[{"id":133887,"content":"原理上没问题，往两个方向去查：\n1. Windows 宿主机和虚拟机的网络连通性\n2. 虚拟机的端口是否被防火墙阻止\n\n建议通过端口转发的方式来访问，只需要确保能和 API Server 的连通性，这是最简单的办法~","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675412818,"ip_address":"广东","comment_id":367620,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"老师，您好！由于我本地采用的是centos虚拟机，所以需要通过windowns宿主机去访问ArgoCD，所以未使用端口转发方式——kubectl port-forward service&#47;argocd-server 8080:80 -n argocd，而是将argocd-server这个service的类型改为NodePort，但宿主机还是无法访问——http:&#47;&#47;虚拟机IP:nodeport，请问这是什么原因？谢谢！","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601785,"discussion_content":"原理上没问题，往两个方向去查：\n1. Windows 宿主机和虚拟机的网络连通性\n2. 虚拟机的端口是否被防火墙阻止\n\n建议通过端口转发的方式来访问，只需要确保能和 API Server 的连通性，这是最简单的办法~","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675412818,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1072095,"avatar":"https://static001.geekbang.org/account/avatar/00/10/5b/df/bd258088.jpg","nickname":"focus","note":"","ucode":"D410E1E356BB29","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607212,"discussion_content":"请问这个有解决吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677674121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366987,"user_name":"Amosヾ","can_delete":false,"product_type":"c1","uid":1567014,"ip_address":"江苏","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1674755650,"is_pvip":true,"replies":[{"id":133914,"content":"1. 没记错的话应该是存在 Secret 对象里，是持久化的。\n2. 参考这个项目：https:&#47;&#47;argocd-notifications.readthedocs.io&#47;en&#47;stable&#47;","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675416056,"ip_address":"广东","comment_id":366987,"utype":1}],"discussion_count":4,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"有两个问题请教老师\n1、argocd 页面更改密码、添加 git 仓库、添加私有 git 仓库密钥、添加私有镜像仓库和密钥等是否是持久化存储的？\n2、argocd 是否有相应的通知机制，比如收到 git 应用仓库 webhook 通知准备更新，开始更新，更新完毕，更新失败等","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601819,"discussion_content":"1. 没记错的话应该是存在 Secret 对象里，是持久化的。\n2. 参考这个项目：https://argocd-notifications.readthedocs.io/en/stable/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675416057,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1567014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","nickname":"Amosヾ","note":"","ucode":"833F6FCB4042AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601288,"discussion_content":"1、持久化存储的\n2、argocd notice 可以进行通知，但目前因为思考题中的情况会出现重复通知，即使根据 revision 配置了 oncePer 依然重复通知","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675180389,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1332257,"avatar":"https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg","nickname":"橙汁","note":"","ucode":"EC3FF10D708C9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":600802,"discussion_content":"我认为这俩问题，都需要你去argocd官网去翻，你觉得呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1674891612,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1567014,"avatar":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","nickname":"Amosヾ","note":"","ucode":"833F6FCB4042AD","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1332257,"avatar":"https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg","nickname":"橙汁","note":"","ucode":"EC3FF10D708C9D","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601611,"discussion_content":"已经翻到了，哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675319648,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":600802,"ip_address":"广东","group_id":0},"score":601611,"extra":""}]}]},{"had_liked":false,"id":366985,"user_name":"êｗěｎ","can_delete":false,"product_type":"c1","uid":1066707,"ip_address":"湖南","ucode":"5000233111BEFA","user_header":"https://static001.geekbang.org/account/avatar/00/10/46/d3/e25d104a.jpg","comment_is_top":false,"comment_ctime":1674751405,"is_pvip":false,"replies":[{"id":133913,"content":"不是主要原因哈，ArgoCD 会屏蔽掉自己的差异，可以从 HPA 和 Replicas 角度看看。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675415983,"ip_address":"广东","comment_id":366985,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"猜是K8S会自动添加一些field，argocd 应该可以屏蔽这些吧","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601818,"discussion_content":"不是主要原因哈，ArgoCD 会屏蔽掉自己的差异，可以从 HPA 和 Replicas 角度看看。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675415984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":387203,"user_name":"文康","can_delete":false,"product_type":"c1","uid":1593681,"ip_address":"上海","ucode":"E1952B9DFB5DF4","user_header":"https://static001.geekbang.org/account/avatar/00/18/51/51/60d729d0.jpg","comment_is_top":false,"comment_ctime":1706698852,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"分享下gitlab ci 同步脚本 https:&#47;&#47;github.com&#47;vwenkk&#47;gitlab-ci-demo&#47;","like_count":2},{"had_liked":false,"id":395157,"user_name":"Geek_305a09","can_delete":false,"product_type":"c1","uid":3292977,"ip_address":"美国","ucode":"939F020904B605","user_header":"","comment_is_top":false,"comment_ctime":1729620540,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"我给ArgoCD 用的github 里面 只有两个文件, &quot;Chart.yaml&quot; and &quot;values.yaml&quot;. 同时我把 full Helm package pushed to our Harbor, along with the APP image. 在这种情况下, how ArgoCD  know where and which helm package to access to get the templates ? ","like_count":0},{"had_liked":false,"id":393083,"user_name":"vivi","can_delete":false,"product_type":"c1","uid":3229150,"ip_address":"广东","ucode":"038BFD5E3E69BF","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIcUUoxHNRJLbOSrYtgT98s76yX3Sibynt2oL3jf3czWfKWS0tqibDsiaiatnQDQ0wKu2GvAxHJvxl80Q/132","comment_is_top":false,"comment_ctime":1722757210,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"4. 通过定期 Poll 的方式持续拉取 Git 仓库，并判断是否有新的 commit。\n5. 从 Git 仓库获取 Kubernetes 对象，与集群对象进行实时比较，自动更新集群内有差异的资源。\n\n老师，这里是否为“git pull”，文中命令似乎写错了","like_count":0}]}