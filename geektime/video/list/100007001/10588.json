{"id":10588,"title":"60 | Zuul网关路由管理实践","content":"无","comments":[{"had_liked":false,"id":192776,"user_name":"Jason","can_delete":false,"product_type":"c3","uid":1085947,"ip_address":"","ucode":"6EECC0C25A9FCC","user_header":"https://static001.geekbang.org/account/avatar/00/10/91/fb/9b9d22a0.jpg","comment_is_top":false,"comment_ctime":1584872481,"is_pvip":false,"replies":[{"id":74026,"content":"建议zuul网关之前部署LB(如硬件F5或者软件nginx)，这样LB可以对zuul集群做负载均衡。同时在LB层做https终结，这样zuul网关层只需处理http。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585057008,"ip_address":"","comment_id":192776,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"https 这种 zuul 转发怎么保证 sni 与微服务域名一致呢？还是网关将 https 转成 http 协议？","like_count":5,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488458,"discussion_content":"建议zuul网关之前部署LB(如硬件F5或者软件nginx)，这样LB可以对zuul集群做负载均衡。同时在LB层做https终结，这样zuul网关层只需处理http。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585057008,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":157018,"user_name":"花错","can_delete":false,"product_type":"c3","uid":1757419,"ip_address":"","ucode":"510F435E4ECE3E","user_header":"https://static001.geekbang.org/account/avatar/00/1a/d0/eb/96e11b82.jpg","comment_is_top":false,"comment_ctime":1575013842,"is_pvip":false,"replies":[{"id":60500,"content":"传统的DNS解析是有这个问题，解决思路一种是智能dns client，具有侦测ip存活情况，如不存活则再次发起dns查询(假设下一次轮询到健康的ip，可缓存)。另外一种是虚拟ip(vip)机制，dns配置的是一个vip，这个vip指向某种LB负载均衡设备(例如nginx集群)，实际的负载均衡和错误重试是由LB管的。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1575284733,"ip_address":"","comment_id":157018,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"域名解析不能保证解析出来的IP所对应的那台服务可用的，比如说域名svca.xxxms.com配置两个IP\n192.168.0.10\n192.168.0.11\n某一次解析出来的IP为192.168.0.11,而这个IP所对应的机器已经宕机,这个时候再路由到它就有问题。\n请问杨波老师,这种情况怎么办? 还是我的理解有问题？\n我理解的相同微服务的集群(比如订单微服务集群)配置的域名都是一样的,一个这样的集群对应配置一条服务元数据。","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":476304,"discussion_content":"传统的DNS解析是有这个问题，解决思路一种是智能dns client，具有侦测ip存活情况，如不存活则再次发起dns查询(假设下一次轮询到健康的ip，可缓存)。另外一种是虚拟ip(vip)机制，dns配置的是一个vip，这个vip指向某种LB负载均衡设备(例如nginx集群)，实际的负载均衡和错误重试是由LB管的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1575284733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129893,"user_name":"Bootis","can_delete":false,"product_type":"c3","uid":1388421,"ip_address":"","ucode":"834251DC0FE2E7","user_header":"https://static001.geekbang.org/account/avatar/00/15/2f/85/9d1230c9.jpg","comment_is_top":false,"comment_ctime":1567318603,"is_pvip":false,"replies":[{"id":48638,"content":"具体看Archaius的配置项有没有添加动态更新回调(callback)逻辑，你可以看s2g-zuul里头的TestRoute.groovy源码，ROUTING_TABLE_STRING_PROPERTY后面跟了一个回调方法，如果zuul.routing_table_string变了，这个回调会执行，动态更新内存里头的路由表，所以就无需重启了。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1567427878,"ip_address":"","comment_id":129893,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100007001,"comment_content":"在简单基于Apollo做法中，老师说更新配置后需要重启Zuul网关，但是在之前Apollo集成Zuul网关的例子中，我们更新了路由表字符串zuul.routing_table_string后不是没有重启，等待变色龙拉取配置后就生效了吗？这两者有什么区别么","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465701,"discussion_content":"具体看Archaius的配置项有没有添加动态更新回调(callback)逻辑，你可以看s2g-zuul里头的TestRoute.groovy源码，ROUTING_TABLE_STRING_PROPERTY后面跟了一个回调方法，如果zuul.routing_table_string变了，这个回调会执行，动态更新内存里头的路由表，所以就无需重启了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567427878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":108465,"user_name":"心宿二","can_delete":false,"product_type":"c3","uid":1063313,"ip_address":"","ucode":"94C3F11ECC92BA","user_header":"https://static001.geekbang.org/account/avatar/00/10/39/91/791d0f5e.jpg","comment_is_top":false,"comment_ctime":1561777695,"is_pvip":false,"replies":[{"id":39523,"content":"加油！","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1561981946,"ip_address":"","comment_id":108465,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"非常感谢杨波老师倾囊相授，受益很大","like_count":1,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455990,"discussion_content":"加油！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561981946,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":245660,"user_name":"杰","can_delete":false,"product_type":"c3","uid":1109562,"ip_address":"","ucode":"036B010A45070A","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/3a/c0ad9c43.jpg","comment_is_top":false,"comment_ctime":1599018577,"is_pvip":false,"replies":[{"id":90424,"content":"你那样做的话就相当于自己手动去做refresh的事情，实际这样弄应该也可以行，但RefreshScope是Spring Cloud提供的自动Refresh的一种标准机制，它试图把你手动做的事情封装自动化。\n\nRefreshScope也是Apollo作者推荐做法：\nhttps:&#47;&#47;github.com&#47;ctripcorp&#47;apollo&#47;tree&#47;master&#47;apollo-demo&#47;src&#47;main&#47;java&#47;com&#47;ctrip&#47;framework&#47;apollo&#47;demo&#47;spring&#47;springBootDemo","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1599140362,"ip_address":"","comment_id":245660,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"波波老师您好，第二模块讲Apollo的时候有用到@RefreshScope这个注解，我印象当时说是有@ConditionalOnProperty这个注解的时候需要动态刷新用到。spring里面的bean默认都是单例的，收到配置修改通知直接从beanfactory取出来这个bean，然后给属性重新赋值不就行了吗？为啥还需要@RefreshScope","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":504945,"discussion_content":"你那样做的话就相当于自己手动去做refresh的事情，实际这样弄应该也可以行，但RefreshScope是Spring Cloud提供的自动Refresh的一种标准机制，它试图把你手动做的事情封装自动化。\n\nRefreshScope也是Apollo作者推荐做法：\nhttps://github.com/ctripcorp/apollo/tree/master/apollo-demo/src/main/java/com/ctrip/framework/apollo/demo/spring/springBootDemo","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599140362,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}