{"id":734130,"title":"22ï½œWebå¼€å‘ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªTodo Liståº”ç”¨ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeï¼Œä»Šå¤©æˆ‘ä»¬ç»§ç»­è®²å¦‚ä½•ä½¿ç”¨Axumå¼€å‘Webåç«¯ã€‚å­¦å®Œè¿™èŠ‚è¯¾çš„å†…å®¹åï¼Œä½ åº”è¯¥èƒ½ä½¿ç”¨Axumç‹¬ç«‹å¼€å‘ä¸€ä¸ªç®€å•çš„Webåç«¯åº”ç”¨äº†ã€‚</p><p>ç¬¬21è®²ï¼Œæˆ‘ä»¬å·²ç»è®²åˆ°äº†ç¬¬4æ­¥ï¼Œå¤„ç†Get queryè¯·æ±‚ï¼Œæ‹¿åˆ°queryä¸­çš„å‚æ•°ã€‚ä¸‹é¢æˆ‘ä»¬è®²å¦‚ä½•å¤„ç†Postè¯·æ±‚å¹¶æ‹¿åˆ°å‚æ•°ã€‚</p><p>è¿™èŠ‚è¯¾çš„ä»£ç é€‚ç”¨äº Axum v0.7 ç‰ˆæœ¬ã€‚</p><h2>åŸºæœ¬æ­¥éª¤</h2><h3>ç¬¬äº”æ­¥ï¼šè§£æ Post è¯·æ±‚å‚æ•°</h3><p>å½“æˆ‘ä»¬æƒ³å‘æœåŠ¡ç«¯æäº¤ä¸€äº›æ•°æ®çš„æ—¶å€™ï¼Œä¸€èˆ¬ä½¿ç”¨HTTP POSTæ–¹æ³•ã€‚Postçš„æ•°æ®ä¼šæ”¾åœ¨HTTPçš„bodyä¸­ï¼Œåœ¨HTMLé¡µé¢ä¸Šï¼Œé€šå¸¸ä¼šä½¿ç”¨è¡¨å•formæ”¶é›†æ•°æ®ã€‚</p><p>å’Œå‰é¢çš„Queryå·®ä¸å¤šï¼ŒAxumç»™æˆ‘ä»¬æä¾›äº†Formè§£åŒ…å™¨ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å–å¾—formè¡¨å•æ•°æ®ã€‚ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">#[derive(Deserialize, Debug)]\nstruct Input {\n&nbsp; &nbsp; name: String,\n&nbsp; &nbsp; email: String,\n}\n\nasync fn accept_form(Form(input): Form&lt;Input&gt;) -&gt; Html&lt;&amp;'static str&gt; {\n&nbsp; &nbsp; tracing::debug!(\"form params {:?}\", input);\n\n&nbsp; &nbsp; Html(\"&lt;h3&gt;Form posted&lt;/h3&gt;\")\n}\n</code></pre><!-- [[[read_end]]] --><p>å¯ä»¥çœ‹åˆ°ï¼Œç›¸æ¯”äºå‰é¢çš„Queryç¤ºä¾‹ï¼Œformç¤ºä¾‹ä»£ç ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯è§£åŒ…å™¨ç”±Queryæ¢æˆäº† Formã€‚è¿™ä½“ç°äº†Axumå…·æœ‰ç›¸å½“è‰¯å¥½çš„äººä½“å·¥ç¨‹å­¦ï¼Œè®©æˆ‘ä»¬éå¸¸çœåŠ›ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œåœ¨ç»“æ„ä½“ä¸Šderiveäº† Deserializeï¼Œå®ƒæ˜¯serdeåº“æä¾›çš„ååºåˆ—åŒ–å®ã€‚serdeåº“æ˜¯Rustç”Ÿæ€ä¸­ç”¨å¾—æœ€å¹¿æ³›çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¡†æ¶ã€‚</p><p>è¦æµ‹è¯•Postè¯·æ±‚ï¼Œä½ éœ€è¦å®‰è£…ä¸€ä¸ªæµè§ˆå™¨æ’ä»¶ï¼Œæ¯”å¦‚ Postmanï¼Œå®ƒå¯ä»¥è®©ä½ åœ¨æµè§ˆå™¨ä¸­æ–¹ä¾¿åœ°æ„å»ºä¸€ä¸ªFormæ ¼å¼çš„Postè¯·æ±‚ã€‚</p><p>å®Œæ•´ä»£ç ç¤ºä¾‹åœ¨<a href=\"https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp05_form\">è¿™é‡Œ</a>ï¼Œè¿™ä¸ªç¤ºä¾‹è¿è¡Œåï¼Œè®¿é—® <code>http://127.0.0.1:3000/form</code>ï¼Œä¼šå‡ºç°ä¸€ä¸ªè¡¨å•ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/86/e1/8648455e46194dc0d9d1828d304364e1.png?wh=1356x196\" alt=\"\"></p><p>åœ¨è¡¨å•ä¸­å¡«å…¥æ•°æ®åï¼Œå¯ä»¥è§‚å¯Ÿåˆ°æ—¥å¿—è¾“å‡ºåƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><pre><code class=\"language-plain\">2023-12-11T07:08:33.520071Z DEBUG axumapp05: listening on 127.0.0.1:3000\n2023-12-11T07:08:33.720071Z DEBUG request{method=GET uri=/ version=HTTP/1.1}: tower_http::trace::on_request: started processing request\n2023-12-11T07:08:33.720274Z DEBUG request{method=GET uri=/ version=HTTP/1.1}: tower_http::trace::on_response: finished processing request latency=0 ms status=200\n2023-12-11T07:08:33.833684Z DEBUG request{method=GET uri=/favicon.ico version=HTTP/1.1}: tower_http::trace::on_request: started processing request\n2023-12-11T07:08:33.833779Z DEBUG request{method=GET uri=/favicon.ico version=HTTP/1.1}: tower_http::trace::on_response: finished processing request latency=0 ms status=404\n2023-12-11T07:09:09.309848Z DEBUG request{method=GET uri=/form version=HTTP/1.1}: tower_http::trace::on_request: started processing request\n2023-12-11T07:09:09.309975Z DEBUG request{method=GET uri=/form version=HTTP/1.1}: tower_http::trace::on_response: finished processing request latency=0 ms status=200\n2023-12-11T07:09:13.964549Z DEBUG request{method=POST uri=/form version=HTTP/1.1}: tower_http::trace::on_request: started processing request\n2023-12-11T07:09:13.964713Z DEBUG request{method=POST uri=/form version=HTTP/1.1}: axumapp05: form params Input { name: \"111\", email: \"2222\" }\n2023-12-11T07:09:13.964796Z DEBUG request{method=POST uri=/form version=HTTP/1.1}: tower_http::trace::on_response: finished processing request latency=0 ms status=200\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ—¥å¿—çš„ç¬¬9è¡Œ form è¡¨å•çš„æ•°æ®å·²ç»è§£æå‡ºæ¥äº†ã€‚</p><p>ä¸‹ä¸€æ­¥æˆ‘ä»¬ç ”ç©¶å¦‚ä½•å¤„ç†ä¼ ä¸Šæ¥çš„Jsonæ ¼å¼çš„è¯·æ±‚ã€‚</p><h3>ç¬¬å…­æ­¥ï¼šè§£æ Json è¯·æ±‚å‚æ•°</h3><p>åœ¨ç°ä»£Webå¼€å‘ä¸­ï¼Œå‘POSTè¯·æ±‚æ›´å¤šçš„æ—¶å€™æ˜¯æäº¤Jsonæ•°æ®ï¼Œè¿™æ—¶HTTPè¯·æ±‚çš„content-type æ˜¯ application/jsonã€‚è¿™ç§æƒ…å†µAxumåº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><p>è¿˜æ˜¯ä¸€æ ·çš„ï¼Œéå¸¸ç®€å•ã€‚Axumæä¾›äº†è§£åŒ…å™¨Jsonï¼Œåªéœ€è¦æŠŠå‚æ•°è§£åŒ…å™¨ä¿®æ”¹ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œè§£æåçš„ç±»å‹éƒ½ä¸ç”¨å˜ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ä¿®æ”¹åçš„ä»£ç ã€‚</p><pre><code class=\"language-plain\">#[derive(Deserialize, Debug)]\nstruct Input {\n&nbsp; &nbsp; name: String,\n&nbsp; &nbsp; email: String,\n}\n\nasync fn accept_json(Json(input): Json&lt;Input&gt;) -&gt; Html&lt;&amp;'static str&gt; {\n&nbsp; &nbsp; tracing::debug!(\"json params {:?}\", input);\n&nbsp; &nbsp; Html(\"&lt;h3&gt;Json posted&lt;/h3&gt;\")\n}\n</code></pre><p>å®Œæ•´ä»£ç ç¤ºä¾‹åœ¨<a href=\"https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp06_jsoninput\">è¿™é‡Œ</a>ã€‚è¿™ç§Postè¯·æ±‚åœ¨æµè§ˆå™¨URLåœ°å€æ é‡Œé¢å°±ä¸å¤ªå¥½æµ‹è¯•äº†ã€‚æœ€å¥½å®‰è£…Postmanç­‰å·¥å…·æ¥æµ‹è¯•ã€‚æˆ‘ç”¨çš„Postwomanæ’ä»¶æ“ä½œç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/2d/bc/2d374c92df13c23394c1d18835ae53bc.png?wh=1920x957\" alt=\"å›¾ç‰‡\"></p><p>æ§åˆ¶å°logè¾“å‡ºä¸ºï¼š</p><pre><code class=\"language-plain\">2023-12-11T07:37:02.093884Z DEBUG axumapp06: listening on 127.0.0.1:3000\n2023-12-11T07:37:07.665064Z DEBUG request{method=POST uri=/json version=HTTP/1.1}: tower_http::trace::on_request: started processing request\n2023-12-11T07:37:07.665244Z DEBUG request{method=POST uri=/json version=HTTP/1.1}: axumapp06: json params Input { name: \"mike\", email: \"mike@jksj.com\" }\n2023-12-11T07:37:07.665309Z DEBUG request{method=POST uri=/json version=HTTP/1.1}: tower_http::trace::on_response: finished processing request latency=0 ms status=200\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸè§£æå‡ºäº†jsonå‚æ•°ï¼Œå¹¶è½¬æ¢æˆäº†Rustç»“æ„ä½“ã€‚</p><p>æˆªæ­¢ç›®å‰ï¼Œæˆ‘ä»¬æ¥è§¦åˆ°äº†ä¸‰ä¸ªè§£åŒ…å™¨ï¼šQueryã€Formã€Jsonã€‚Axumè¿˜å†…ç½®å¾ˆå¤šé«˜çº§è§£åŒ…å™¨ï¼Œæ„Ÿå…´è¶£çš„è¯ä½ å¯ä»¥ç‚¹å‡»è¿™ä¸ª<a href=\"https://docs.rs/axum/latest/axum/extract/index.html\">é“¾æ¥</a>äº†è§£ä¸€ä¸‹ã€‚</p><h3>è§£æå‡ºé”™äº†æ€ä¹ˆåŠï¼Ÿ</h3><p>è¿™é‡Œæˆ‘ä»¬å…ˆæš‚åœä¸€ä¸‹ï¼Œå›å¤´æƒ³æƒ³ã€‚Axumå¸®æˆ‘ä»¬è‡ªåŠ¨åšäº†å‚æ•°çš„è§£æï¼Œè¿™ç‚¹å›ºç„¶å¾ˆå¥½ã€å¾ˆæ–¹ä¾¿ã€‚ä½†æ˜¯ï¼Œå¦‚æœå‚æ•°æ²¡æœ‰è§£ææˆåŠŸï¼ŒAxumå°±ä¼šè‡ªåŠ¨è¿”å›ä¸€äº›ä¿¡æ¯ï¼Œè€Œè¿™äº›ä¿¡æ¯æˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰æ¥è§¦åˆ°ï¼Œå¥½åƒä¹Ÿä¸èƒ½æ§åˆ¶ï¼Œè¿™å°±ä¸€ç‚¹ä¹Ÿä¸çµæ´»äº†ã€‚</p><p>Axumçš„è®¾è®¡è€…å…¶å®è€ƒè™‘åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿæä¾›äº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆâ€”â€”Rejectionã€‚åªéœ€è¦åœ¨å†™è§£åŒ…å™¨çš„æ—¶å€™ï¼ŒæŠŠå‚æ•°ç±»å‹æ”¹æˆä½¿ç”¨ Result åŒ…èµ·æ¥ï¼ŒResultçš„é”™è¯¯ç±»å‹ä¸ºç›¸åº”çš„è§£åŒ…å™¨å¯¹åº”çš„Rejectionç±»å‹å°±è¡Œäº†ã€‚æ¯”å¦‚Jsonè§£åŒ…å™¨å°±å¯¹åº”JsonRejectionï¼ŒFormè§£åŒ…å™¨å°±å¯¹åº”FormRejectionã€‚</p><pre><code class=\"language-plain\">async fn create_user(payload: Result&lt;Json&lt;Value&gt;, JsonRejection&gt;) {\n</code></pre><p>ç”¨è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½è·å¾—è§£æè¢«é©³å›çš„è¯¦ç»†é”™è¯¯åŸå› ï¼Œè¿˜å¯ä»¥æ ¹æ®è¿™äº›åŸå› æ¥å…·ä½“å¤„ç†ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥è¿”å›è‡ªå®šä¹‰çš„é”™è¯¯ä¿¡æ¯æ¨¡æ¿ã€‚</p><p>æ¯”å¦‚ï¼š</p><pre><code class=\"language-plain\">use axum::{\n    extract::{Json, rejection::JsonRejection},\n    routing::post,\n    Router,\n};\nuse serde_json::Value;\nasync fn create_user(payload: Result&lt;Json&lt;Value&gt;, JsonRejection&gt;) {\n    match payload {\n        Ok(payload) =&gt; {\n            // We got a valid JSON payload\n        }\n        Err(JsonRejection::MissingJsonContentType(_)) =&gt; {\n            // Request didn't have `Content-Type: application/json`\n            // header\n        }\n        Err(JsonRejection::JsonDataError(_)) =&gt; {\n            // Couldn't deserialize the body into the target type\n        }\n        Err(JsonRejection::JsonSyntaxError(_)) =&gt; {\n            // Syntax error in the body\n        }\n        Err(JsonRejection::BytesRejection(_)) =&gt; {\n            // Failed to extract the request body\n        }\n        Err(_) =&gt; {\n            // `JsonRejection` is marked `#[non_exhaustive]` so match must\n            // include a catch-all case.\n        }\n    }\n}\nlet app = Router::new().route(\"/users\", post(create_user));\n</code></pre><p>æ›´å¤šè¯¦ç»†çš„Rejectionçš„ä¿¡æ¯ï¼Œè¯·å‚è€ƒ<a href=\"https://docs.rs/axum/latest/axum/extract/rejection/index.html\">è¿™é‡Œ</a>ã€‚</p><h3>è‡ªå®šä¹‰Extractor</h3><p>å½“ç„¶ï¼Œé¢å¯¹ä¸šåŠ¡çš„åƒå˜ä¸‡åŒ–ï¼ŒAxumè¿˜ç»™äº†æˆ‘ä»¬è‡ªå®šä¹‰è§£åŒ…å™¨çš„èƒ½åŠ›ã€‚å¹³æ—¶ç”¨å¾—ä¸å¤šï¼Œä½†å¿…è¦çš„æ—¶å€™ä½ ä¸ä¼šæ„Ÿè§‰è¢«é™åˆ¶ä½ã€‚</p><p>è¿™æ–¹é¢çš„å†…å®¹å±äºæ‰©å±•å†…å®¹ï¼Œæœ‰å…´è¶£çš„è¯ä½ å¯ä»¥è‡ªå·±ç ”ç©¶ä¸€ä¸‹ã€‚è¯·å‚è€ƒ<a href=\"https://docs.rs/axum/latest/axum/extract/index.html#defining-custom-extractors\">è¿™é‡Œ</a>ã€‚</p><h3>ç¬¬ä¸ƒæ­¥ï¼šHandlerè¿”å›å€¼</h3><p>Axum handlerçš„è¿”å›ç±»å‹ä¹Ÿå¾ˆçµæ´»ã€‚é™¤äº†å‰é¢ä¾‹å­é‡Œæåˆ°çš„ HTML ç±»å‹çš„è¿”å›ä¹‹å¤–ï¼Œå¸¸è§çš„è¿˜æœ‰ Stringã€Jsonã€Redirect ç­‰ç±»å‹ã€‚å®é™…ä¸Šï¼Œåªè¦å®ç°äº† IntoResponse è¿™ä¸ª trait çš„ç±»å‹ï¼Œéƒ½èƒ½ç”¨ä½œ handler çš„è¿”å›å€¼ã€‚Axumä¼šæ ¹æ®è¿”å›å€¼çš„ç±»å‹ï¼Œå¯¹Http Response çš„status codeå’Œheaderç­‰è¿›è¡Œè‡ªåŠ¨é…ç½®ï¼Œå‡å°‘äº†å¼€å‘è€…å¯¹ç»†èŠ‚çš„å¤„ç†ã€‚</p><p>æ¯”å¦‚è¿”å›ä¸€ä¸ªHTMLï¼š</p><pre><code class=\"language-plain\">async fn query(Json(params): Json&lt;InputParams&gt;) -&gt; impl IntoResponse {\n&nbsp; &nbsp; Html(\"&lt;h3&gt;Test json&lt;/h3&gt;\")\n}\n</code></pre><p>è¿”å›ä¸€ä¸ªStringï¼š</p><pre><code class=\"language-plain\">async fn query(Json(params): Json&lt;InputParams&gt;) -&gt; impl IntoResponse {\n&nbsp; &nbsp; \"Hello, world\".\n}\n</code></pre><p>è¿”å›ä¸€ä¸ªJsonï¼š</p><pre><code class=\"language-plain\">async fn query(Json(params): Json&lt;InputParams&gt;) -&gt; impl IntoResponse {\n&nbsp; &nbsp; let ajson = ...;\n    Json(ajson)\n}\n</code></pre><p>ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨Axumé‡ŒJsonæ—¢æ˜¯è§£åŒ…å™¨ï¼Œåˆå¯ä»¥ç”¨åœ¨responseé‡Œé¢ã€‚<br>\nåœ¨Rustä¸­ï¼Œå€ŸåŠ©serde_jsonæä¾›çš„json!å®ï¼Œä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·æ–¹ä¾¿åœ°æ„é€ Jsonå¯¹è±¡ï¼š</p><pre><code class=\"language-plain\">async fn accept_json(Json(input): Json&lt;Input&gt;) -&gt; impl IntoResponse {\n&nbsp; &nbsp; tracing::debug!(\"json params {:?}\", input);\n&nbsp; &nbsp; Json(json!({\n&nbsp; &nbsp; &nbsp; &nbsp; \"result\": \"ok\",\n&nbsp; &nbsp; &nbsp; &nbsp; \"number\": 1,\n&nbsp; &nbsp; }))\n}\n</code></pre><p>ä½ è¿˜å¯ä»¥è¿”å›ä¸€ä¸ªRedirectï¼Œè‡ªåŠ¨é‡å®šå‘é¡µé¢ã€‚</p><pre><code class=\"language-plain\">async fn query(Json(params): Json&lt;InputParams&gt;) -&gt; impl IntoResponse {\n    Redirect::to(\"/\")\n}\n</code></pre><p>ä½ ç”šè‡³å¯ä»¥è¿”å›ä¸€ä¸ª <code>(StatusCode, String)</code>ã€‚</p><pre><code class=\"language-plain\">async fn query(Json(params): Json&lt;InputParams&gt;) -&gt; impl IntoResponse {\n    (StatusCode::Ok, \"Hello, world!\")\n}\n</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå½¢å¼å˜åŒ–å¤šç«¯ï¼Œéå¸¸çµæ´»ã€‚è‡³äºä½ å¯ä»¥è¿”å›å“ªäº›å½¢å¼ï¼Œå¯ä»¥åœ¨<a href=\"https://docs.rs/axum/latest/axum/response/trait.IntoResponse.html#foreign-impls\">è¿™é‡Œ</a>çœ‹åˆ°ã€‚</p><p>æ³¨æ„ï¼Œå¦‚æœä¸€ä¸ªhandleré‡Œéœ€è¦è¿”å›ä¸¤ä¸ªæˆ–å¤šä¸ªä¸åŒçš„ç±»å‹ï¼Œé‚£ä¹ˆéœ€è¦è°ƒç”¨ .into_response() è½¬æ¢ä¸€ä¸‹ã€‚è¿™é‡Œä½ å¯ä»¥å›é¡¾ä¸€ä¸‹<a href=\"https://time.geekbang.org/column/article/726207\">ç¬¬14è®²</a>çš„çŸ¥è¯†ç‚¹ï¼šimpl trait è¿™ç§åœ¨å‡½æ•°ä¸­çš„å†™æ³•ï¼Œæœ¬è´¨ä¸Šä»ç„¶æ˜¯ç¼–è¯‘æœŸå•æ€åŒ–ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½ä¼šæ›¿æ¢æˆä¸€ä¸ªå…·ä½“çš„ç±»å‹ã€‚</p><pre><code class=\"language-plain\">async fn query(Json(params): Json&lt;InputParams&gt;) -&gt; impl IntoResponse {\n    if some_flag {\n        let ajson = ...;\n        Json(ajson).into_response()\n    } else {\n        Redirect::to(\"/\").into_response()\n    }\n}\n</code></pre><p>æœ‰æ²¡æœ‰æ„Ÿè§‰åˆ°ä¸€ä¸ä¸éœ‡æ’¼ã€‚Rustè™½ç„¶æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œä½†æ˜¯æ„Ÿè§‰AxumæŠŠå®ƒç©å‡ºäº†å¼±ï¼ˆåŠ¨æ€ï¼‰ç±»å‹è¯­è¨€çš„æ•ˆæœã€‚è¿™å›ºç„¶æ˜¯Axumçš„ä¼˜ç§€ä¹‹å¤„ï¼Œä¸è¿‡ä¸»è¦è¿˜æ˜¯Rustå¤ªç‰›äº†ã€‚</p><p>å…³äºè¿”å›Jsonçš„å®Œæ•´ç¤ºä¾‹ï¼Œè¯·å‚è€ƒ<a href=\"https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp07_jsonres\">è¿™é‡Œ</a>ã€‚</p><p>æµ‹è¯•æ•ˆæœå›¾ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/84/cb/8414fb520b8a8b63f45cf9dyya221ecb.png?wh=1920x860\" alt=\"å›¾ç‰‡\"></p><h3>ç¬¬å…«æ­¥ï¼šå…¨å±€404 Fallback</h3><p>æœ‰æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ç»™å…¨å±€çš„Routeræ·»åŠ ä¸€ä¸ªç»Ÿä¸€çš„404è‡ªå®šä¹‰é¡µé¢ï¼Œè¿™åœ¨Axumä¸­å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€å¥è¯ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p><pre><code class=\"language-plain\">&nbsp; &nbsp; let app = Router::new()\n&nbsp; &nbsp; &nbsp; &nbsp; .route(\"/\", get(handler))\n&nbsp; &nbsp; &nbsp; &nbsp; .route(\"/query\", get(query))\n&nbsp; &nbsp; &nbsp; &nbsp; .route(\"/form\", get(show_form).post(accept_form))\n&nbsp; &nbsp; &nbsp; &nbsp; .route(\"/json\", post(accept_json));\n\n&nbsp; &nbsp; let app = app.fallback(handler_404);\n</code></pre><p>ä¸Šé¢ç¬¬7è¡Œå°±ç»™æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•ä¸€ä¸ªurl patternçš„æƒ…å†µé…ç½®äº†ä¸€ä¸ª fallbackï¼Œç»™äº†ä¸€ä¸ª 404 handlerï¼Œä½ è‡ªè¡Œåœ¨é‚£ä¸ªhandleré‡Œé¢å†™ä½ çš„å¤„ç†é€»è¾‘å°±å¥½äº†ï¼Œæ¯”å¦‚ç›´æ¥è¿”å›ä¸€ä¸ª404é¡µé¢ã€‚</p><p>å®Œæ•´ä»£ç ç¤ºä¾‹åœ¨<a href=\"https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp08_global404\">è¿™é‡Œ</a>ã€‚</p><h3>ç¬¬ä¹æ­¥ï¼šæ¨¡æ¿æ¸²æŸ“</h3><p>è¿™é‡Œçš„æ¨¡æ¿æ¸²æŸ“æŒ‡æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä¸€èˆ¬æ˜¯åœ¨æœåŠ¡ç«¯æ¸²æŸ“HTMLé¡µé¢ã€‚åœ¨Rustç”Ÿæ€ä¸­æœ‰éå¸¸å¤šçš„æ¨¡æ¿æ¸²æŸ“åº“ã€‚å¸¸è§çš„æœ‰ Askamaã€Terraç­‰ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥Askamaä¸ºä¾‹æ¥ä»‹ç»ä¸€ä¸‹ã€‚</p><p>Askamaæ˜¯ä¸€ç§Jinja-likeè¯­æ³•çš„æ¨¡æ¿æ¸²æŸ“å¼•æ“ï¼Œæ”¯æŒä½¿ç”¨Rustè¯­è¨€åœ¨æ¨¡æ¿ä¸­å†™é€»è¾‘ã€‚ä½œä¸ºæ¨¡æ¿æ¸²æŸ“åº“ï¼Œå®ƒå¾ˆæœ‰Rustçš„å‘³é“ï¼Œ<strong>é€šè¿‡ç±»å‹æ¥ä¿è¯å†™å‡ºçš„æ¨¡æ¿æ˜¯æ­£ç¡®çš„</strong>ã€‚å¦‚æœæ¨¡æ¿ä¸­æœ‰ä»»ä½•éé€»è¾‘é”™è¯¯ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™å°±èƒ½å‘ç°é—®é¢˜ã€‚å¸¦æ¥çš„ç›´æ¥æ•ˆæœå°±æ˜¯ï¼Œå¯ä»¥èŠ‚çº¦å¼€å‘è€…å¤§é‡è°ƒè¯•é¡µé¢æ¨¡æ¿çš„æ—¶é—´ã€‚å‡¡æ˜¯ä½¿ç”¨è¿‡çš„äººï¼Œéƒ½ä½“ä¼šåˆ°äº†å…¶ä¸­çš„ä¾¿åˆ©ã€‚</p><p>å…ˆå¼•å…¥ askamaã€‚</p><pre><code class=\"language-plain\">cargo add askama\n</code></pre><p>ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿå¾ˆç®€å•ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç ç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">#[derive(Template)]\n#[template(path = \"hello.html\")]\nstruct HelloTemplate {\n&nbsp; &nbsp; name: String,\n}\n\nasync fn greet(Path(name): Path&lt;String&gt;) -&gt; impl IntoResponse {\n&nbsp; &nbsp; HelloTemplate { name } .to_string()\n}\n</code></pre><p>æ¨¡æ¿ä¸­ä½¿ç”¨çš„æ˜¯Jinjaè¯­æ³•ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ¨¡æ¿è¯­æ³•ï¼Œå¦‚æœä¸äº†è§£çš„å¯æŸ¥é˜…<a href=\"https://docs.jinkan.org/docs/jinja2/\">ç›¸å…³èµ„æ–™</a>ã€‚Askamaçš„å®Œæ•´æ–‡æ¡£ï¼Œè¯·å‚è€ƒ<a href=\"https://djc.github.io/askama/askama.html\">é“¾æ¥</a></p><p>æœ¬å°èŠ‚å®Œæ•´å¯è¿è¡Œç¤ºä¾‹ï¼Œè¯·å‚è€ƒ<a href=\"https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp09_template\">è¿™é‡Œ</a>ã€‚</p><p>è¿è¡Œæ•ˆæœï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/1y/d7/1yy39ee412661fca7c8bdb8a4c5f89d7.png?wh=1126x302\" alt=\"\"></p><h3>ç¬¬åæ­¥ï¼šä½¿ç”¨è¿æ¥æ± è¿æ¥ PostgreSQL DB</h3><p>ä¸€ä¸ªçœŸæ­£çš„äº’è”ç½‘åº”ç”¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½ä¼šç”¨æ•°æ®åº“æ¥å­˜å‚¨æ•°æ®ã€‚å› æ­¤ï¼Œæ“ä½œæ•°æ®åº“æ˜¯æœ€å¸¸è§çš„éœ€æ±‚ï¼Œè€ŒAxumå°±å†…ç½®äº†è¿™æ–¹é¢çš„æ”¯æŒã€‚ä¸‹é¢æˆ‘ä»¬ç”¨ Postgres æ¥ä¸¾ä¾‹ã€‚</p><p>ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰ä¸€ä¸ªå…¨å±€åº”ç”¨çŠ¶æ€ï¼ŒæŠŠæ‰€æœ‰éœ€è¦å…¨å±€å…±äº«çš„ä¿¡æ¯æ”¾è¿›å»ã€‚</p><pre><code class=\"language-plain\">struct AppState {\n    // ...\n}\n</code></pre><p>å…¨å±€çŠ¶æ€èƒ½å¤Ÿè¢«æ‰€æœ‰handlerã€ä¸­é—´ä»¶layerè®¿é—®åˆ°ï¼Œæ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„è®¾è®¡æ¨¡å¼ã€‚</p><p>åœ¨ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ç”¨ Pool::builder()åˆ›å»ºä¸€ä¸ªè¿æ¥æ± å¯¹è±¡ï¼Œå¹¶ä¼ é€åˆ°AppStateçš„å®ä¾‹é‡Œã€‚</p><pre><code class=\"language-plain\">let manager = PostgresConnectionManager::new_from_stringlike(\n&nbsp; &nbsp; &nbsp; &nbsp; \"host=localhost user=postgres dbname=postgres password=123456\",\n&nbsp; &nbsp; &nbsp; &nbsp; NoTls,\n&nbsp; &nbsp; )\n&nbsp; &nbsp; .unwrap();\nlet pool = Pool::builder().build(manager).await.unwrap();\n\nlet app_state = AppState { dbpool: pool};\n</code></pre><p>å†ä½¿ç”¨ router çš„ .with_state() æ–¹æ³•å°±å¯ä»¥æŠŠè¿™ä¸ªå…¨å±€çŠ¶æ€ä¼ é€’åˆ°æ¯ä¸€ä¸ªhandlerå’Œä¸­é—´ä»¶é‡Œäº†ã€‚</p><pre><code class=\"language-plain\">.with_state(app_state);\n</code></pre><p>å¦ä¸€æ–¹é¢ï¼Œåœ¨ handler ä¸­ä½¿ç”¨ State è§£åŒ…å™¨æ¥è§£å‡º app_state ã€‚</p><pre><code class=\"language-plain\">async fn handler(\n    State(app_state): State&lt;AppState&gt;,\n) {\n    // use `app_state`...\n}\n</code></pre><p>è¿™é‡Œï¼Œå–å‡ºæ¥çš„è¿™ä¸ªapp_state å°±æ˜¯å‰é¢åˆ›å»ºçš„AppStateçš„å®ä¾‹ï¼Œåœ¨handleré‡Œç›´æ¥ä½¿ç”¨å°±å¯ä»¥äº†ã€‚</p><p>å½“ç„¶é™¤äº†ä¸Šé¢çš„è¿™äº›çŸ¥è¯†ï¼Œä½ è¿˜éœ€è¦åœ¨æœ¬åœ°ç¯å¢ƒå®‰è£… PostgreSQLï¼Œæˆ–ä½¿ç”¨ Docker Compose ä¹‹ç±»çš„å·¥å…·å¿«é€Ÿæ„å»ºä¾èµ–ç¯å¢ƒã€‚è¿™ä¸ªæ­¥éª¤çš„å®Œæ•´å¯è¿è¡Œçš„ä»£ç åœ¨<a href=\"https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp10_db\">è¿™é‡Œ</a>ï¼Œä½ å¯ä»¥åœ¨å®‰è£…å¥½PostgreSQLæ•°æ®åº“åï¼Œè®¾ç½®å¥½æ•°æ®åº“çš„å¯†ç ç­‰é…ç½®ï¼Œç¼–è¯‘æ­¤ä»£ç è¿ä¸Šå»æµ‹è¯•ã€‚</p><p>åœ¨Ubuntu/Debianä¸‹ï¼Œå®‰è£…é…ç½®PostgreSQLå¯èƒ½ç”¨åˆ°çš„æŒ‡ä»¤æœ‰ä¸‹é¢è¿™å‡ ç§ã€‚</p><pre><code class=\"language-plain\">sudo apt install postgresql\nsudo su postgres\npsql\npostgres=# ALTER USER postgres WITH PASSWORD '123456'; # é…ç½®é»˜è®¤ç”¨æˆ·å¯†ç \n</code></pre><p>æµ‹è¯•ç•Œé¢ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/c1/y9/c165807a7b9c109f928a64fdb2ae4yy9.png?wh=1354x348\" alt=\"\"></p><p>è¿™ä¸ªç¤ºä¾‹è¾“å‡ºlogç±»ä¼¼å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">2023-12-11T09:20:41.919226Z DEBUG axumapp10: listening on 127.0.0.1:3000\n2023-12-11T09:20:50.224031Z DEBUG request{method=GET uri=/query_from_db version=HTTP/1.1}: tower_http::trace::on_request: started processing request\n2023-12-11T09:20:50.224099Z DEBUG request{method=GET uri=/query_from_db version=HTTP/1.1}: axumapp10: get db conn Pool(PoolInner(0x557c6994ed80))\n2023-12-11T09:20:50.255306Z DEBUG request{method=GET uri=/query_from_db version=HTTP/1.1}: axumapp10: query_from_db: 1\n2023-12-11T09:20:50.256060Z DEBUG request{method=GET uri=/query_from_db version=HTTP/1.1}: axumapp10: query_from_db: 2\n2023-12-11T09:20:50.256109Z DEBUG request{method=GET uri=/query_from_db version=HTTP/1.1}: axumapp10: query_from_db: 3\n2023-12-11T09:20:50.256134Z DEBUG request{method=GET uri=/query_from_db version=HTTP/1.1}: axumapp10: calc_result 2\n2023-12-11T09:20:50.256218Z DEBUG request{method=GET uri=/query_from_db version=HTTP/1.1}: tower_http::trace::on_response: finished processing request latency=32 ms status=200\n</code></pre><p>è·Ÿæˆ‘ä»¬é¢„æœŸä¸€è‡´ï¼Œè¯´æ˜æˆåŠŸè¿ä¸Šäº†æ•°æ®åº“ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»¼åˆç¤ºä¾‹ï¼ŒæŠŠè¿™äº›å·¥ä½œæ•´åˆèµ·æ¥ï¼Œæ„å»ºä¸€ä¸ªTodo Liståº”ç”¨çš„åç«¯æœåŠ¡ã€‚</p><h2>ç»¼åˆç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ª Todo List åº”ç”¨</h2><p>TodoListæ˜¯æœ€å¸¸è§çš„Webåº”ç”¨ç¤ºä¾‹ï¼Œç›¸å½“äºå‰åç«¯åˆ†ç¦»å‹Webåº”ç”¨é¢†åŸŸä¸­çš„Helloworldã€‚ä¸€èˆ¬è¯´æ¥ï¼Œæˆ‘ä»¬è¦åšä¸€ä¸ªç®€å•çš„äº’è”ç½‘åº”ç”¨ï¼Œæœ€åŸºæœ¬çš„æ­¥éª¤æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p><ol>\n<li>è®¾è®¡å‡†å¤‡db schemaã€‚</li>\n<li>å¯¹åº” db schema ç”Ÿæˆå¯¹åº”çš„ Rust model typesã€‚</li>\n<li>è§„åˆ’ Routerï¼ŒåŠ å…¥éœ€è¦çš„ http endpointsã€‚</li>\n<li>è§„åˆ’ handlersã€‚</li>\n<li>è§„åˆ’å‰åç«¯æ•°æ®äº¤äº’æ–¹å¼ï¼Œæ˜¯ç”¨ form æ ¼å¼è¿˜æ˜¯ json æ ¼å¼å‰åç«¯äº¤äº’æ•°æ®ï¼Œæˆ–è€…æ˜¯å¦ç»Ÿä¸€ä½¿ç”¨ Graphql è¿›è¡Œqueryå’Œmutationã€‚</li>\n<li>ä»£ç å®ç°ã€‚</li>\n<li>æµ‹è¯•ã€‚</li>\n</ol><p>ä¸‹é¢æˆ‘ä»¬å°±æŒ‰ç…§è¿™ä¸ªæµç¨‹ä¸€æ­¥æ­¥æ¥å®ç°ã€‚</p><h3>ç¬¬ä¸€æ­¥ï¼šå»ºç«‹æ¨¡å‹</h3><p>è¿™ä¸€æ­¥éœ€è¦ä½ å¯¹sqlæ•°æ®åº“çš„åŸºæœ¬æ“ä½œæœ‰ä¸€äº›äº†è§£ã€‚è¿™é‡Œæˆ‘ä»¬è¦åˆ›å»ºæ•°æ®åº“å’Œè¡¨ã€‚</p><p>åˆ›å»ºæ•°æ®åº“ï¼š</p><pre><code class=\"language-plain\">create database todolist;\n</code></pre><p>åœ¨ psql ä¸­ ä½¿ç”¨ <code>\\c todolist</code> è¿ä¸Šåˆšåˆ›å»ºçš„todolistæ•°æ®åº“ï¼Œç„¶ååˆ›å»ºè¡¨ã€‚</p><pre><code class=\"language-plain\">create table todo (\n   id varchar not null,\n   description varchar not null,\n   completed bool not null);\n</code></pre><p>ç„¶ååœ¨psqlä¸­ä½¿ç”¨  <code>\\d</code> æŒ‡ä»¤æŸ¥çœ‹å·²ç»åˆ›å»ºå¥½çš„tableã€‚</p><pre><code class=\"language-plain\">todolist=# \\d\n&nbsp; &nbsp; &nbsp; &nbsp; List of relations\n&nbsp;Schema | Name | Type&nbsp; |&nbsp; Owner\n--------+------+-------+----------\n&nbsp;public | todo | table | postgres\n(1 row)\n</code></pre><p>å¦‚æœä½ å¯¹SQLè¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„æ•™ç¨‹å¯ä¾›å‚è€ƒï¼š<a href=\"https://www.runoob.com/postgresql/postgresql-tutorial.html\">PostgreSQL æ•™ç¨‹ | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p><h3>ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå¯¹åº”çš„Rust Struct</h3><p>å¯¹åº”ä¸Šé¢åˆ›å»ºçš„todo tableï¼Œæˆ‘ä»¬è®¾è®¡å‡ºå¦‚ä¸‹ç»“æ„ä½“ç±»å‹ï¼š</p><pre><code class=\"language-plain\">#[derive(Debug, Serialize, Clone)]\nstruct Todo {\n&nbsp; &nbsp; id: String,\n&nbsp; &nbsp; description: String,\n&nbsp; &nbsp; completed: bool,\n}\n</code></pre><h3>ç¬¬ä¸‰æ­¥ï¼šè§„åˆ’Router</h3><p>Todolistä¼šæœ‰å¢åˆ æ”¹æŸ¥çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯4ä¸ªåŸºæœ¬çš„url endpointsã€‚å¦å¤–ï¼Œéœ€è¦å°†æ•°æ®åº“è¿æ¥çš„å…¨å±€çŠ¶æ€ä¼ åˆ°å„ä¸ªhandlerä¸­ã€‚</p><pre><code class=\"language-plain\">let app = Router::new()\n&nbsp; &nbsp; .route(\"/todos\", get(todos_list))\n&nbsp; &nbsp; .route(\"/todo/new\", post(todo_create))\n&nbsp; &nbsp; .route(\"/todo/update\", post(todo_update))\n&nbsp; &nbsp; .route(\"/todo/delete/:id\", post(todo_delete))\n&nbsp; &nbsp; .with_state(pool);\n</code></pre><p>æˆ‘ä»¬åœ¨è¿™é‡Œæ·»åŠ äº†4ä¸ªURLï¼Œåˆ†åˆ«å¯¹åº”query listã€createã€updateã€delete å››ç§æ“ä½œã€‚</p><h3>ç¬¬å››æ­¥ï¼šè®¾è®¡ä¸šåŠ¡å¯¹åº”çš„handler</h3><p>ä¸€ä¸ªæ ‡å‡†çš„Todo Listçš„åç«¯æœåŠ¡ï¼Œåªéœ€è¦å¯¹Todoæ¨¡å‹åšåŸºæœ¬çš„å¢åˆ æ”¹æŸ¥å°±å¯ä»¥äº†ã€‚</p><ol>\n<li>create åˆ›å»ºä¸€ä¸ªTodo itemã€‚</li>\n<li>update æ›´æ–°ä¸€ä¸ªTodo itemã€‚</li>\n<li>delete åˆ é™¤ä¸€ä¸ªTodo itemã€‚</li>\n<li>query listï¼ŒåŠ è½½ä¸€ä¸ªTodo item listã€‚åœ¨è¿™ä¸ªTodoListåº”ç”¨é‡Œï¼Œæˆ‘ä»¬ä¸éœ€è¦å¯¹ä¸€ä¸ªå…·ä½“çš„itemåšqueryã€‚</li>\n</ol><p>äºæ˜¯å¯¹åº”çš„ï¼Œæˆ‘ä»¬ä¼šæœ‰4ä¸ªhandlersã€‚æˆ‘ä»¬å…ˆæŠŠæ¡†æ¶å†™å‡ºæ¥ã€‚</p><pre><code class=\"language-plain\">async fn todo_create(\n&nbsp; &nbsp; State(pool): State&lt;ConnectionPool&gt;,\n&nbsp; &nbsp; Json(input): Json&lt;CreateTodo&gt;,\n) -&gt; Result&lt;(StatusCode, Json&lt;Todo&gt;), (StatusCode, String)&gt; {\n\nasync fn todo_update(\n&nbsp; &nbsp; State(pool): State&lt;ConnectionPool&gt;,\n&nbsp; &nbsp; Json(utodo): Json&lt;UpdateTodo&gt;,\n) -&gt; Result&lt;(StatusCode, Json&lt;String&gt;), (StatusCode, String)&gt; {\n\nasync fn todo_delete(\n&nbsp; &nbsp; Path(id): Path&lt;String&gt;,\n&nbsp; &nbsp; State(pool): State&lt;ConnectionPool&gt;,\n) -&gt; Result&lt;(StatusCode, Json&lt;String&gt;), (StatusCode, String)&gt; {\n\nasync fn todos_list(\n&nbsp; &nbsp; pagination: Option&lt;Query&lt;Pagination&gt;&gt;,\n&nbsp; &nbsp; State(pool): State&lt;ConnectionPool&gt;,\n) -&gt; Result&lt;Json&lt;Vec&lt;Todo&gt;&gt;, (StatusCode, String)&gt; {\n</code></pre><p>ä¸Šé¢æˆ‘ä»¬è®¾è®¡å¥½äº† 4 ä¸ªhandlerçš„å‡½æ•°ç­¾åï¼Œè¿™å°±ç›¸å½“äºæˆ‘ä»¬å†™äº†ä¹¦çš„ç›®å½•ï¼Œåé¢è¦å®Œæˆå“ªäº›ä¸œè¥¿å°±èƒ½å¿ƒä¸­æœ‰æ•°äº†ã€‚å‡½æ•°ç­¾åé‡Œæœ‰ä¸€äº›ä¿¡æ¯è¿˜éœ€è¦è¡¥å……ï¼Œæ¯”å¦‚HTTPè¯·æ±‚ä¸Šæ¥åçš„å…¥å‚ç±»å‹ã€‚</p><p>ä¸‹é¢å®šä¹‰äº†åˆ›å»ºæ–°itemå’Œæ›´æ–°itemçš„å…¥å‚DTOï¼ˆdata transform objectï¼‰ï¼Œç”¨æ¥åœ¨Axumé‡ŒæŠŠHttp Requestçš„å‚æ•°ä¿¡æ¯ç›´æ¥è½¬åŒ–æˆRustçš„structç±»å‹ã€‚</p><pre><code class=\"language-plain\">#[derive(Debug, Deserialize)]\nstruct CreateTodo {\n&nbsp; &nbsp; description: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct UpdateTodo {\n&nbsp; &nbsp; id: String,\n&nbsp; &nbsp; description: Option&lt;String&gt;,\n&nbsp; &nbsp; completed: Option&lt;bool&gt;,\n}\n</code></pre><p>æœ‰äº†è¿™äº›ç±»å‹ï¼ŒAxumä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬åšè½¬æ¢å·¥ä½œï¼Œæˆ‘ä»¬åœ¨handlerä¸­æ‹¿åˆ°è¿™äº›ç±»å‹çš„å®ä¾‹ï¼Œå°±å¯ä»¥ç›´æ¥å†™ä¸šåŠ¡äº†ã€‚</p><h3>ç¬¬äº”æ­¥ï¼šè§„åˆ’å‰åç«¯çš„æ•°æ®äº¤äº’æ–¹å¼</h3><p>è¿™ä¸€æ­¥éœ€è¦åš4ä»¶äº‹æƒ…ã€‚</p><ul>\n<li>queryå‚æ•°æ”¾åœ¨URLé‡Œé¢ï¼Œç”¨GETæŒ‡ä»¤æäº¤ã€‚</li>\n<li>deleteæ“ä½œçš„å‚æ•°æ”¾åœ¨pathé‡Œé¢ï¼Œç”¨ /todo/delete/:id è¿™ç§å½¢å¼è¡¨è¾¾ã€‚</li>\n<li>createå’Œupdateå‚æ•°æ˜¯æ”¾åœ¨bodyé‡Œé¢ï¼Œç”¨POSTæŒ‡ä»¤æäº¤ï¼Œç”¨jsonæ ¼å¼ä¸Šä¼ ã€‚</li>\n<li>ä»æœåŠ¡ç«¯è¿”å›ç»™å‰ç«¯çš„æ•°æ®éƒ½æ˜¯ä»¥jsonæ ¼å¼è¿”å›ã€‚</li>\n</ul><p>è¿™ä¸€æ­¥å®šä¹‰å¥½äº†ï¼Œå°±å¯ä»¥é‡æ–°å®¡è§†ä¸€ä¸‹4ä¸ªhandlerçš„å‡½æ•°ç­¾åï¼Œçœ‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚</p><h3>ç¬¬å…­æ­¥ï¼šä»£ç å®ç°</h3><p>å‰é¢é‚£äº›æ­¥éª¤è®¾è®¡è§„åˆ’å¥½åï¼Œå®ç°ä»£ç å°±æ˜¯ä¸€ä»¶éå¸¸è½»æ¾çš„äº‹æƒ…äº†ã€‚åŸºæœ¬ä¸Šå°±æ˜¯æŒ‰ç…§Axumçš„è¦æ±‚ï¼Œå†™å‡ºç›¸åº”çš„éƒ¨åˆ†å°±è¡Œäº†ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹å®Œæ•´å¯è¿è¡Œçš„<a href=\"https://github.com/miketang84/jikeshijian/tree/master/2122-axumapp_stepbystep/axumapp11_todo\">ç¤ºä¾‹</a>ã€‚åœ¨ç¤ºä¾‹é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†bb8è¿™ä¸ªæ•°æ®åº“è¿æ¥æ± æ¥è¿æ¥pgæ•°æ®åº“ã€‚è¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦å»æ‹…å¿ƒè¿æ¥æ–­å¼€ã€é‡è¿è¿™äº›åº•å±‚çš„çäº‹äº†ã€‚</p><h3>ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•</h3><p>ä¸€èˆ¬ï¼Œæµ‹è¯•åç«¯æœåŠ¡æœ‰å‡ ç§æ–¹å¼ï¼š</p><ol>\n<li>æ¡†æ¶çš„å•å…ƒå’Œé›†æˆæµ‹è¯•æ–¹æ³•ï¼Œä¸åŒçš„æ¡†æ¶æœ‰ä¸åŒçš„å®ç°å’Œä½¿ç”¨æ–¹å¼ï¼ŒAxumé‡Œä¹Ÿæœ‰é…å¥—çš„è®¾æ–½ã€‚</li>\n<li>Curl å‘½ä»¤è¡Œè„šæœ¬æµ‹è¯•ã€‚</li>\n<li>Webæµè§ˆå™¨æ’ä»¶å·¥å…·æµ‹è¯•ã€‚</li>\n</ol><p>ä¸‰ç§æ–¹å¼å¹¶ä¸å†²çªï¼Œæ˜¯ç›¸äº’è¡¥å……çš„ã€‚ç¬¬3ç§æ–¹å¼å¸¸è§çš„æœ‰Postmanè¿™ç§æµè§ˆå™¨æ’ä»¶ï¼Œå®ƒä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¸®æˆ‘ä»¬å¯¹Webåº”ç”¨è¿›è¡Œæµ‹è¯•ã€‚</p><p>æµ‹è¯•åˆ›å»ºä¸€ä¸ªItemï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/82/29/823ab4dd841a844b0247be8cecf7ff29.png?wh=1920x921\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¤šåˆ›å»ºå‡ ä¸ªã€‚</p><p>ä»¥ä¸‹æ˜¯åˆ›å»ºäº†5ä¸ªitemçš„listè¿”å›ï¼Œé€šè¿‡Get æ–¹æ³•è®¿é—® <code>http://127.0.0.1:3000/todos</code>ã€‚</p><pre><code class=\"language-plain\">[\n{\n\"id\": \"77de4aa746c74eb19b8bf451eab6fbf3\",\n\"description\": \"hello, item 1\",\n\"completed\": false\n},\n{\n\"id\": \"3c158df02c724695ac67d4cbff180717\",\n\"description\": \"hello, item 2\",\n\"completed\": false\n},\n{\n\"id\": \"0c687f7b4d4442dc9c3381cc4d0e4a1d\",\n\"description\": \"hello, item 3\",\n\"completed\": false\n},\n{\n\"id\": \"df0bb07aa0f84696896ad86d8f13a61c\",\n\"description\": \"hello, item 4\",\n\"completed\": false\n},\n{\n\"id\": \"3ec8f48f5fd34cf9afa299427066ef35\",\n\"description\": \"hello, item 5\",\n\"completed\": false\n}\n]\n</code></pre><p>å…¶ä»–çš„æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼Œä½ å¯ä»¥è‡ªå·±åŠ¨æ‰‹æµ‹è¯•ä¸€ä¸‹ã€‚</p><p>ä½ é˜…è¯»ä»£ç æ—¶ï¼Œæœ‰3ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼š</p><ol>\n<li>æ³¨æ„å‚æ•°ä¼ å…¥ä¸­çš„å¯çœå‚æ•° Option çš„å¤„ç†ã€‚</li>\n<li>handlerçš„è¿”å›å€¼ç”¨çš„Resultï¼Œè¯·æ³¨æ„ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„é”™è¯¯è½¬æ¢ã€‚</li>\n<li>pg db çš„æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ORMè¿™ç§ä¸œè¥¿ï¼Œå› æ­¤çº¯é æ‰‹åŠ¨æ‹¼sqlå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æ‰‹åŠ¨è½¬æ¢ä»pg dbè¿”å›çš„rowå€¼çš„ç±»å‹ã€‚è¿™æ¯”è¾ƒåŸå§‹ï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“å‡ºé”™ã€‚ä½†æ˜¯å¯¹äºæˆ‘ä»¬å­¦ä¹ æ¥è®²ï¼Œæ˜¯æœ‰å¥½å¤„çš„ã€‚åé¢ä½ åšWebåº”ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªORMï¼ŒRustç”Ÿæ€ä¸­æ¯”è¾ƒå‡ºåçš„æœ‰ sqlxã€SeaORMã€Rbatis ç­‰ã€‚</li>\n</ol><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬å­¦ä¼šäº†å¦‚ä½•ä½¿ç”¨Axumè¿›è¡ŒWebåç«¯å¼€å‘ã€‚Webå¼€å‘æœ¬èº«æ˜¯ä¸€ä¸ªåºå¤§çš„é¢†åŸŸï¼Œè¦ç²¾é€šéœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´ã€‚æˆ‘é€šè¿‡ä¸¤èŠ‚è¯¾çš„æ—¶é—´ï¼ŒæŠ½å‡ºäº†é‡Œé¢çš„æ€è·¯å’Œé‡è¦æ­¥éª¤ï¼Œå¿«é€Ÿå¸¦ä½ ä½“éªŒäº†å¦‚ä½•å®ç°ä¸€ä¸ªtodolist appã€‚</p><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è´¯å½»äº†å¾ªåºæ¸è¿›çš„å­¦ä¹ æ–¹å¼ã€‚å…ˆå¯¹å¤§ç›®æ ‡è¿›è¡Œåˆ†è§£ï¼Œäº†è§£è¦å®Œæˆä¸€ä¸ªç›®æ ‡ä¹‹å‰ï¼Œéœ€è¦æŒæ¡å¤šå°‘åŸºç¡€çš„çŸ¥è¯†ç‚¹ã€‚ç„¶åï¼Œå°±ä¸€ç‚¹ä¸€ç‚¹å»æŒæ¡å¥½ï¼Œç†è§£é€ã€‚è¿™æ ·ä¸€æ­¥ä¸€æ­¥æŠŠç§¯æœ¨æ­ä¸Šæ¥ï¼Œå®é™…ä¹ŸèŠ±ä¸äº†å¤šå°‘æ—¶é—´ã€‚è¿™å®é™…æ˜¯ä¸€ç§ä¼¼æ…¢å®å¿«çš„æ–¹æ³•ã€‚åœ¨Rustä¸­ï¼Œè¿™ç§æ–¹æ³•æ¯”é‚£ç§å…ˆæ€»ä½“çŸä¸€çœ¼æ•™ç¨‹ï¼Œç›´æ¥åŠ¨æ‰‹åšå¼€å‘ï¼Œä¸æ¸…æ¥šçš„åœ°æ–¹å†å»æŸ¥é˜…ç›¸å…³èµ„æ–™çš„æ–¹å¼ï¼Œæ•ˆæœè¦å¥½ä¸€äº›ï¼Œå¹¶ä¸”ä¼šæ‰å®å¾ˆå¤šã€‚</p><p>Axumæ˜¯ä¸€ä¸ªç›¸å½“å¼ºå¤§çµæ´»çš„æ¡†æ¶ï¼Œé‡Œé¢è¿˜æœ‰å¾ˆå¤šä¸œè¥¿ï¼ˆæ¯”å¦‚ï¼šå¦‚ä½•å†™ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè‡ªå®šä¹‰extractorï¼Œå¦‚ä½•å¤„ç†æµæ–‡ä»¶ä¸Šä¼ ç­‰ï¼‰å€¼å¾—ä½ å»æ¢ç´¢ã€‚å¥½åœ¨ï¼Œæˆ‘ä»¬å·²ç»æŒæ¡äº†Axumçš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•äº†ï¼ŒWebå¼€å‘çš„ç‰¹ç‚¹è®©æˆ‘ä»¬å¯ä»¥å°æ­¥å¿«è·‘ï¼Œä¸€ç‚¹ä¸€ç‚¹åŠ åŠŸèƒ½ï¼Œèƒ½ç«‹å³çœ‹åˆ°æ•ˆæœã€‚åªè¦è‚¯èŠ±æ—¶é—´ï¼Œè¿™äº›éƒ½ä¸æ˜¯é—®é¢˜ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/fd/d6/fd0af99a9a7ce1814947fa2240a015d6.jpg?wh=2646x2777\" alt=\"\"></p><h2>æ€è€ƒé¢˜</h2><p>å½“Axum Handlerä¸­æœ‰å¤šä¸ªå‚æ•°çš„æ—¶å€™ï¼Œä½ å¯ä»¥è¯•ç€æ”¹å˜ä¸€ä¸‹å‚æ•°çš„é¡ºåºï¼Œçœ‹çœ‹æ•ˆæœæœ‰æ²¡æœ‰å˜åŒ–ã€‚å¹¶åœ¨è¿™ä¸ªåŸºç¡€ä¸Šè¯´ä¸€è¯´ä½ å¯¹<a href=\"https://docs.rs/axum/latest/axum/index.html#high-level-features\">å£°æ˜å¼å‚æ•°</a>æ¦‚å¿µçš„ç†è§£ã€‚</p><p>è¯·ä½ å±•å¼€èŠä¸€èŠï¼Œæ¬¢è¿ä½ ç•™è¨€å’Œæˆ‘åˆ†äº«ã€è®¨è®ºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œé‚€ä»–ä¸€èµ·å­¦ä¹ ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":385312,"user_name":"å°è™å­ğŸ¯","can_delete":false,"product_type":"c1","uid":2843479,"ip_address":"åŒ—äº¬","ucode":"4C9530B3FB407B","user_header":"https://static001.geekbang.org/account/avatar/00/2b/63/57/cba4c68b.jpg","comment_is_top":true,"comment_ctime":1702430483,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"å› ä¸ºåˆšåˆšæ›´æ–°äº†ç‰ˆæœ¬ï¼Œæ–‡å­—å†…å®¹æœ‰è°ƒæ•´ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›æ—¶é—´å¤„ç†éŸ³é¢‘ï¼Œæ‰€ä»¥ä»Šå¤©çš„éŸ³é¢‘ä¸­åˆå‘å¸ƒå“¦","like_count":2},{"had_liked":false,"id":385573,"user_name":"å¤©ç©¹æ™ºèƒ½","can_delete":false,"product_type":"c1","uid":2853524,"ip_address":"ä¸Šæµ·","ucode":"989318E61BDDCB","user_header":"https://static001.geekbang.org/account/avatar/00/2b/8a/94/cbbf8b4d.jpg","comment_is_top":false,"comment_ctime":1702914783,"is_pvip":false,"replies":[{"id":140559,"content":"ä½ å¥½ï¼Œè¿™ä¸ªå°±æŒ‰rustçš„è§„èŒƒå‘½åå°±å¯ä»¥äº†ã€‚Rustçš„ç¤¾åŒºé¡¹ç›®å‘½åéƒ½æ¯”è¾ƒä¸€è‡´çš„ï¼Œè¿™æ ·å¤§å®¶éƒ½ä¼šæ¯”è¾ƒä¹ æƒ¯ã€‚ç›®å½•ç»„ç»‡çš„è¯ï¼Œç”¨ 2015 é£æ ¼ å’Œ 2018 é£æ ¼çš„éƒ½æœ‰ï¼Œå¦å¤–ï¼Œå¦‚æœé¡¹ç›®æ¯”è¾ƒå¤§ï¼Œç°åœ¨æ¨èä½¿ç”¨ workspaceï¼šhttps:&#47;&#47;doc.rust-lang.org&#47;cargo&#47;reference&#47;workspaces.html","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1703122918,"ip_address":"é‡åº†","comment_id":385573,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è€å¸ˆï¼Œè¯·æ•™ä¸€ä¸‹axumå¼€å‘webçš„åŒ…ç»“æ„å‘½åç»„ç»‡è§„èŒƒæœ‰æ²¡æœ‰ç›¸å¯¹æ¯”è¾ƒæ­£å¼ç‚¹çš„ï¼Œæœ€è¿‘å…¬å¸åœ¨ç”¨axumå¼€å‘ä¸€ä¸ªé¡¹ç›®ï¼Œä¸€ç›´åœ¨æ„æ€æ¨¡å—å’ŒåŒ…çš„ç»“æ„ç»„ç»‡ã€‚","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634235,"discussion_content":"ä½ å¥½ï¼Œè¿™ä¸ªå°±æŒ‰rustçš„è§„èŒƒå‘½åå°±å¯ä»¥äº†ã€‚Rustçš„ç¤¾åŒºé¡¹ç›®å‘½åéƒ½æ¯”è¾ƒä¸€è‡´çš„ï¼Œè¿™æ ·å¤§å®¶éƒ½ä¼šæ¯”è¾ƒä¹ æƒ¯ã€‚ç›®å½•ç»„ç»‡çš„è¯ï¼Œç”¨ 2015 é£æ ¼ å’Œ 2018 é£æ ¼çš„éƒ½æœ‰ï¼Œå¦å¤–ï¼Œå¦‚æœé¡¹ç›®æ¯”è¾ƒå¤§ï¼Œç°åœ¨æ¨èä½¿ç”¨ workspaceï¼šhttps://doc.rust-lang.org/cargo/reference/workspaces.html","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703122918,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1228080,"avatar":"https://static001.geekbang.org/account/avatar/00/12/bd/30/55488a4c.jpg","nickname":"æå¿—å‹‡(Leo)","note":"","ucode":"5833C0831DD271","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634544,"discussion_content":"ä½ ä»¬ä½¿ç”¨DDDï¼Œç®€æ´æ¶æ„è¿™äº›ä¸œè¥¿å—ï¼Ÿ\nä½ ä»¬ç°åœ¨çš„æ¨¡å—å’ŒåŒ…ç»“æ„å¤§è‡´æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703642308,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385396,"user_name":"My dream","can_delete":false,"product_type":"c1","uid":1077733,"ip_address":"å››å·","ucode":"2FEFB344230C17","user_header":"https://static001.geekbang.org/account/avatar/00/10/71/e5/bcdc382a.jpg","comment_is_top":false,"comment_ctime":1702559074,"is_pvip":false,"replies":[{"id":140457,"content":"https:&#47;&#47;crates.io&#47;crates&#47;xlsxwriter\nhttps:&#47;&#47;crates.io&#47;crates&#47;calamine\nhttps:&#47;&#47;crates.io&#47;crates&#47;docx-rs\nhttps:&#47;&#47;crates.io&#47;crates&#47;cairo-rs\nhttps:&#47;&#47;crates.io&#47;crates&#47;lopdf","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1702610752,"ip_address":"é‡åº†","comment_id":385396,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æ€ä¹ˆå®ç°ç”Ÿæˆpdfæ–‡ä»¶ï¼Œç”Ÿæˆxlsæ–‡æ¡£å¯¼å…¥å¯¼å‡ºï¼Ÿç”Ÿæˆwordå¯¼å‡ºï¼Ÿ","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633775,"discussion_content":"https://crates.io/crates/xlsxwriter\nhttps://crates.io/crates/calamine\nhttps://crates.io/crates/docx-rs\nhttps://crates.io/crates/cairo-rs\nhttps://crates.io/crates/lopdf","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702610752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385370,"user_name":"-","can_delete":false,"product_type":"c1","uid":1546505,"ip_address":"åŒ—äº¬","ucode":"7B34258D346793","user_header":"https://static001.geekbang.org/account/avatar/00/17/99/09/29c46a7b.jpg","comment_is_top":false,"comment_ctime":1702524012,"is_pvip":false,"replies":[{"id":140455,"content":"éå¸¸æ£’çš„å‘ç°ï¼\n\nAxumä¼šå¯¹handleré‡Œé¢çš„è§£åŒ…å™¨å‚æ•°æŒ‰é¡ºåºå¯¹Requestè¿›è¡Œå¤„ç†ã€‚\n\nå¦‚æœä½ å°è¯•å°†Stateæ”¾åœ¨Jsonè§£åŒ…å™¨çš„åé¢ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºJsonè§£åŒ…å™¨ä¼šæ¶ˆè€—è¯·æ±‚çš„ä¸»ä½“ï¼ˆbodyï¼‰ï¼Œè€Œåœ¨è¯·æ±‚çš„ä¸»ä½“è¢«æ¶ˆè€—ä¹‹åï¼ŒStateå°±æ— æ³•å†ä»è¯·æ±‚ä¸­æå–æ•°æ®ï¼ˆéœ€è¦ç ”ç©¶Axumå†…éƒ¨çš„å®ç°ï¼‰ã€‚å› æ­¤ï¼Œä½ éœ€è¦å…ˆä½¿ç”¨Stateæå–å™¨ï¼Œç„¶åå†ä½¿ç”¨Jsonè§£åŒ…å™¨ã€‚è¯¦æƒ…è§è¿™é‡Œï¼šâš ï¸ Since parsing JSON requires consuming the request body, the Json extractor must be last if there are multiple extractors in a handler. See â€œthe order of extractorsâ€\n\nhttps:&#47;&#47;docs.rs&#47;axum&#47;latest&#47;axum&#47;struct.Json.html\n\næ‰€ä»¥ï¼ŒAxumè™½ç„¶è¯´å®ƒçš„handleré‡Œé¢çš„å‚æ•°é¡ºåºæ˜¯å£°æ˜å¼çš„ï¼ˆä¹Ÿå°±æ˜¯å¯ä»¥éšæ„æ¢ä½ç½®ï¼‰ï¼Œä½†ä¹Ÿä¸æ˜¯å¯¹æ‰€æœ‰å‚æ•°éƒ½å¹³ç­‰å¯¹å¾…ã€‚å¯¹äºä¼šæ¶ˆè€—bodyçš„è§£åŒ…å™¨ï¼Œè¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹å…¶é¡ºåºã€‚\n\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1702610320,"ip_address":"é‡åº†","comment_id":385370,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æˆ‘å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åŒæ ·çš„State,handlerä¸­æˆ‘æ”¾ç¬¬ä¸€ä¸ªå‚æ•°æ²¡é—®é¢˜ï¼Œæˆ‘æ”¾åˆ°Jsonå‚æ•°åæŠ¥é”™ï¼Œå¸Œæœ›è€å¸ˆååŠ©åˆ†æä¸‹","like_count":2,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633773,"discussion_content":"éå¸¸æ£’çš„å‘ç°ï¼\n\nAxumä¼šå¯¹handleré‡Œé¢çš„è§£åŒ…å™¨å‚æ•°æŒ‰é¡ºåºå¯¹Requestè¿›è¡Œå¤„ç†ã€‚\n\nå¦‚æœä½ å°è¯•å°†Stateæ”¾åœ¨Jsonè§£åŒ…å™¨çš„åé¢ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºJsonè§£åŒ…å™¨ä¼šæ¶ˆè€—è¯·æ±‚çš„ä¸»ä½“ï¼ˆbodyï¼‰ï¼Œè€Œåœ¨è¯·æ±‚çš„ä¸»ä½“è¢«æ¶ˆè€—ä¹‹åï¼ŒStateå°±æ— æ³•å†ä»è¯·æ±‚ä¸­æå–æ•°æ®ï¼ˆéœ€è¦ç ”ç©¶Axumå†…éƒ¨çš„å®ç°ï¼‰ã€‚å› æ­¤ï¼Œä½ éœ€è¦å…ˆä½¿ç”¨Stateæå–å™¨ï¼Œç„¶åå†ä½¿ç”¨Jsonè§£åŒ…å™¨ã€‚è¯¦æƒ…è§è¿™é‡Œï¼šâš ï¸ Since parsing JSON requires consuming the request body, the Json extractor must be last if there are multiple extractors in a handler. See â€œthe order of extractorsâ€\n\nhttps://docs.rs/axum/latest/axum/struct.Json.html\n\næ‰€ä»¥ï¼ŒAxumè™½ç„¶è¯´å®ƒçš„handleré‡Œé¢çš„å‚æ•°é¡ºåºæ˜¯å£°æ˜å¼çš„ï¼ˆä¹Ÿå°±æ˜¯å¯ä»¥éšæ„æ¢ä½ç½®ï¼‰ï¼Œä½†ä¹Ÿä¸æ˜¯å¯¹æ‰€æœ‰å‚æ•°éƒ½å¹³ç­‰å¯¹å¾…ã€‚å¯¹äºä¼šæ¶ˆè€—bodyçš„è§£åŒ…å™¨ï¼Œè¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹å…¶é¡ºåºã€‚\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702610320,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1979955,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/36/33/3411df0d.jpg","nickname":"seven9t","note":"","ucode":"B7CA7D62C56938","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635919,"discussion_content":"é—®çš„å¥½åƒæ˜¯Stateå’ŒJsonçš„é¡ºåºï¼ŸStateä¸æ¶ˆè€—è¾“å…¥å§","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705379045,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":388281,"user_name":"meteor","can_delete":false,"product_type":"c1","uid":1438402,"ip_address":"ä¸Šæµ·","ucode":"E7B1A2AD359D69","user_header":"https://static001.geekbang.org/account/avatar/00/15/f2/c2/939bec1c.jpg","comment_is_top":false,"comment_ctime":1709791458,"is_pvip":false,"replies":[{"id":141752,"content":"è¿™ä¸ªéœ€è¦æŸ¥ä¸€ä¸‹ï¼ŒRuståœ¨å‰ç«¯ç»„ä»¶è¿™ä¸€å—ï¼Œè¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åšã€‚ä½ å¯ä»¥çœ‹çœ‹ dioxus æˆ– tauri ç¤¾åŒºæœ‰æ²¡æœ‰ç›¸å…³ç»„ä»¶ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1713028759,"ip_address":"åŠ æ‹¿å¤§","comment_id":388281,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"è¯·é—®ä¸‹ï¼Œrustæœ‰ä»€ä¹ˆå¥½ç”¨çš„è¡¨æ ¼ç»„ä»¶å—ï¼Œå¯ä»¥ç¼–è¯‘æˆwasmçš„ã€‚æˆ‘ä»¬çš„ç½‘é¡µéœ€è¦ä¸€ä¸ªé«˜æ€§èƒ½è¡¨æ ¼ï¼Œæƒ³ç”¨rustå¼€å‘ï¼Œç„¶åç¼–è¯‘ä¸ºwasmã€‚ç›®å‰çœ‹äº†egui,è¯·é—®è¿˜æœ‰å…¶ä»–å¥½ç”¨çš„åº“å—","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":641834,"discussion_content":"è¿™ä¸ªéœ€è¦æŸ¥ä¸€ä¸‹ï¼ŒRuståœ¨å‰ç«¯ç»„ä»¶è¿™ä¸€å—ï¼Œè¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åšã€‚ä½ å¯ä»¥çœ‹çœ‹ dioxus æˆ– tauri ç¤¾åŒºæœ‰æ²¡æœ‰ç›¸å…³ç»„ä»¶ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1713028759,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"åŠ æ‹¿å¤§","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386335,"user_name":"-HedonğŸ­","can_delete":false,"product_type":"c1","uid":3176234,"ip_address":"æ¹–åŒ—","ucode":"FAE541E7A2B88F","user_header":"https://static001.geekbang.org/account/avatar/00/30/77/2a/0cd4c373.jpg","comment_is_top":false,"comment_ctime":1704605274,"is_pvip":false,"replies":[{"id":140811,"content":"rustè¯­è¨€é‡Œé¢ä¸æ¨èç”¨å…¨å±€å˜é‡ï¼Œå› ä¸ºå¾ˆä¸åˆ©äºå¹¶å‘ç¼–ç¨‹ã€‚å®é™…stateå°±å¯ä»¥æ‰®æ¼”ä¸€å…¨å±€å˜é‡çš„ä½œç”¨ã€‚å¤šä¸ªå…ƒç´ å°±å£°æ˜structï¼Œéƒ½æ”¾ä¸€ä¸ªstructé‡Œé¢ç®¡ç†èµ·æ¥å°±è¡Œã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1704684711,"ip_address":"é‡åº†","comment_id":386335,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æ€è€ƒé¢˜ï¼šå£°æ˜å¼å‚æ•°ï¼Œæˆ‘ä¸ªäººè§‰å¾—æœ‰ä¸€ç‚¹â€œå¼ºç±»å‹â€çš„å‘³é“ï¼Œè¿™è¦æ±‚æŠŠå‚æ•°æ˜¯ä»€ä¹ˆæ˜ç¡®è¡¨ç¤ºå‡ºæ¥ï¼Œå³åˆ©äºä»£ç çš„å¯è¯»æ€§ï¼Œä¹Ÿæœ‰åŠ©äºç±»å‹æ£€æŸ¥ã€‚\n\nå¦å¤–ï¼Œæƒ³é—®ä¸€ä¸‹è€å¸ˆï¼Œç¤ºä¾‹ä»£ç ä¸­æ•°æ®åº“è¿æ¥æ± é€šè¿‡ State çš„æ–¹å¼æ¥ä¼ é€’ï¼Œè¿™ç§æ–¹å¼è·Ÿå£°æ˜å…¨å±€å˜é‡ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ£å‘¢ï¼Ÿä»¥åŠï¼Œå¦‚æœæˆ‘æœ‰å¤šä¸ªå¯¹è±¡éœ€è¦å…±äº«ï¼Œé‚£æ€ä¹ˆåšå‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635272,"discussion_content":"rustè¯­è¨€é‡Œé¢ä¸æ¨èç”¨å…¨å±€å˜é‡ï¼Œå› ä¸ºå¾ˆä¸åˆ©äºå¹¶å‘ç¼–ç¨‹ã€‚å®é™…stateå°±å¯ä»¥æ‰®æ¼”ä¸€å…¨å±€å˜é‡çš„ä½œç”¨ã€‚å¤šä¸ªå…ƒç´ å°±å£°æ˜structï¼Œéƒ½æ”¾ä¸€ä¸ªstructé‡Œé¢ç®¡ç†èµ·æ¥å°±è¡Œã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704684711,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385320,"user_name":"ä¸å¿˜åˆå¿ƒ","can_delete":false,"product_type":"c1","uid":3737491,"ip_address":"å››å·","ucode":"8262D42405F4E2","user_header":"https://static001.geekbang.org/account/avatar/00/39/07/93/710c7ee2.jpg","comment_is_top":false,"comment_ctime":1702445341,"is_pvip":false,"replies":[{"id":140454,"content":"bb8ä¸æ”¯æŒmysqlã€‚ä½ å¯ä»¥ç”¨ r2d2 https:&#47;&#47;github.com&#47;sfackler&#47;r2d2","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1702609718,"ip_address":"é‡åº†","comment_id":385320,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"bb8 æœ‰mysqlçš„crateå—? crates.ioä¸Šæ²¡æœ‰æ‰¾åˆ°å“¦","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633771,"discussion_content":"bb8ä¸æ”¯æŒmysqlã€‚ä½ å¯ä»¥ç”¨ r2d2 https://github.com/sfackler/r2d2","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702609718,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385309,"user_name":"åˆ˜ä¸¹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"å¹¿ä¸œ","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1702428526,"is_pvip":false,"replies":[{"id":140428,"content":"æ‰“é”™å•¦ï¼Œç”±äº æ¢æˆ æ²¡æœ‰ï¼Œæˆ‘ç»™å°ç¼–åé¦ˆã€‚æ„Ÿè°¢æ„Ÿè°¢","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1702436066,"ip_address":"é‡åº†","comment_id":385309,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"æœ¬æ–‡æ˜¯ç”¨äº† ORM å—ï¼Ÿ\n\nå› ä¸ºæˆ‘ä»¬ç”±äºä½¿ç”¨ ORM è¿™ç§ä¸œè¥¿ï¼Œå› æ­¤çº¯é æ‰‹åŠ¨æ‹¼ sql å­—ç¬¦ä¸²","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633650,"discussion_content":"æ‰“é”™å•¦ï¼Œç”±äº æ¢æˆ æ²¡æœ‰ï¼Œæˆ‘ç»™å°ç¼–åé¦ˆã€‚æ„Ÿè°¢æ„Ÿè°¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702436066,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385305,"user_name":"ä¼¯é˜³","can_delete":false,"product_type":"c1","uid":1596631,"ip_address":"åŒ—äº¬","ucode":"DBDC8735AA54AD","user_header":"https://static001.geekbang.org/account/avatar/00/18/5c/d7/3b92bb0d.jpg","comment_is_top":false,"comment_ctime":1702422396,"is_pvip":false,"replies":[{"id":140429,"content":"æ”¯æŒçš„ï¼Œæœ‰mysqlé©±åŠ¨ï¼Œç”¨æ³•åŸºæœ¬ä¸€æ ·","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":2186062,"ctime":1702436088,"ip_address":"é‡åº†","comment_id":385305,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"ç¡®å®æŒºæ–¹ä¾¿ï¼Œå¤©ç”Ÿæ”¯æŒMySQLä¹ˆ","like_count":0,"discussions":[{"author":{"id":2186062,"avatar":"https://static001.geekbang.org/account/avatar/00/21/5b/4e/8e1f699e.jpg","nickname":"Mike Tang","note":"","ucode":"55775BCEDB5937","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":633651,"discussion_content":"æ”¯æŒçš„ï¼Œæœ‰mysqlé©±åŠ¨ï¼Œç”¨æ³•åŸºæœ¬ä¸€æ ·","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1702436088,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"é‡åº†","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":391081,"user_name":"å±±èŒ¶èŠ±","can_delete":false,"product_type":"c1","uid":1014676,"ip_address":"æ²³å—","ucode":"103BF2B46C5E56","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7b/94/8f68c15b.jpg","comment_is_top":false,"comment_ctime":1717239061,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100626901,"comment_content":"bb8å¥½åƒæ²¡æœ‰mysqlé©±åŠ¨ï¼Œr2d2çš„mysqlé©±åŠ¨ä¸å¤ªä¼šç”¨ï¼Œç½‘ä¸Šæ‰¾äº†ä¸ªsqlxæ¥ç”¨\n\ndbåˆå§‹åŒ–:\n```\nuse sqlx::{MySql, Pool};\nuse sqlx::mysql::MySqlPoolOptions;\n\nlet url = &quot;mysql:&#47;&#47;username:password@127.0.0.1:3306&#47;test&quot;;\nlet pool = MySqlPoolOptions::new().connect(&amp;url).await.unwrap();\n```\n\nç”¨æ³•:\n```\nasync fn todo_list(pagination: Option&lt;Query&lt;Pagination&gt;&gt;,\n                   State(pool): State&lt;ConnectionPool&gt;,\n) -&gt; Result&lt;Json&lt;Vec&lt;Todo&gt;&gt;, (StatusCode, String)&gt; {\n    let Query(patination) = pagination.unwrap_or_default();\n    let offset = patination.offset.unwrap_or(0);\n    let limit = patination.limit.unwrap_or(100);\n\n    let mut conn = pool.acquire().await.map_err(internal_error)?;\n    let todos = sqlx::query_as::&lt;_, Todo&gt;(&quot;select id, description, completed from todo limit ?, ?&quot;)\n        .bind(&amp;offset)\n        .bind(&amp;limit)\n        .fetch_all(&amp;mut conn)\n        .await\n        .map_err(internal_error)?;\n    \n    Ok(Json(todos))\n}\n```","like_count":0}]}