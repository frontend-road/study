{"id":260695,"title":"ç­”ç–‘ç¯‡ï¼šä»£ç ç¯‡æ€è€ƒé¢˜é›†é”¦ï¼ˆä¸€ï¼‰","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æœ±æ™”ã€‚</p><p>åœ¨å›å¤ã€ŠJava ä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯100ä¾‹ã€‹è¿™é—¨è¯¾ç•™è¨€çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘çœ‹åˆ°æœ‰äº›åŒå­¦ç‰¹åˆ«æƒ³çœ‹ä¸€çœ‹å’±ä»¬è¿™ä¸ªè¯¾ç¨‹æ‰€æœ‰æ€è€ƒé¢˜çš„ç­”æ¡ˆã€‚å› æ­¤å‘¢ï¼Œæˆ‘ç‰¹åœ°å°†è¿™ä¸ªè¯¾ç¨‹æ¶‰åŠçš„æ€è€ƒé¢˜è¿›è¡Œäº†æ¢³ç†ï¼ŒæŠŠå…¶ä¸­çš„67ä¸ªé—®é¢˜çš„ç­”æ¡ˆæˆ–è€…è¯´è§£é¢˜æ€è·¯ï¼Œè¯¦ç»†åœ°å†™äº†å‡ºæ¥ï¼Œå¹¶æ•´ç†æˆäº†ä¸€ä¸ªâ€œç­”ç–‘ç¯‡â€æ¨¡å—ã€‚</p><p>æˆ‘æŠŠè¿™äº›é—®é¢˜æ‹†åˆ†ä¸ºäº†6ç¯‡åˆ†åˆ«æ›´æ–°ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ—¶é—´æ¥å­¦ä¹ ï¼Œä»¥ä¿è¯å­¦ä¹ æ•ˆæœã€‚ä½ å¯ä»¥é€šè¿‡è¿™äº›å›ç­”ï¼Œå†æ¥å›é¡¾ä¸‹è¿™äº›çŸ¥è¯†ç‚¹ï¼Œä»¥æ±‚æ¸©æ•…è€ŒçŸ¥æ–°ï¼›åŒæ—¶ï¼Œä½ ä¹Ÿå¯ä»¥å¯¹ç…§ç€æˆ‘çš„å›ç­”ï¼Œå¯¹æ¯”ä¸‹è‡ªå·±çš„è§£é¢˜æ€è·¯ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œå¹¶ç•™è¨€ç»™æˆ‘ã€‚</p><p>ä»Šå¤©æ˜¯ç­”ç–‘ç¯‡çš„ç¬¬ä¸€è®²ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥åˆ†æä¸‹å’±ä»¬è¿™é—¨è¯¾å‰6è®²çš„è¯¾åæ€è€ƒé¢˜ã€‚è¿™äº›é¢˜ç›®æ¶‰åŠäº†å¹¶å‘å·¥å…·ã€ä»£ç åŠ é”ã€çº¿ç¨‹æ± ã€è¿æ¥æ± ã€HTTPè°ƒç”¨å’ŒSpringå£°æ˜å¼äº‹åŠ¡çš„12é“æ€è€ƒé¢˜ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€ä¸€å…·ä½“åˆ†æå§ã€‚</p><h3><a href=\"https://time.geekbang.org/column/article/209494\">01 | ä½¿ç”¨äº†å¹¶å‘å·¥å…·ç±»åº“ï¼Œçº¿ç¨‹å®‰å…¨å°±é«˜æ•æ— å¿§äº†å—ï¼Ÿ</a></h3><p><strong>é—®é¢˜1ï¼š</strong>ThreadLocalRandomæ˜¯Java 7å¼•å…¥çš„ä¸€ä¸ªç”Ÿæˆéšæœºæ•°çš„ç±»ã€‚ä½ è§‰å¾—å¯ä»¥æŠŠå®ƒçš„å®ä¾‹è®¾ç½®åˆ°é™æ€å˜é‡ä¸­ï¼Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹é‡ç”¨å—ï¼Ÿ</p><p>ç­”ï¼šä¸èƒ½ã€‚</p><p><a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadLocalRandom.html\">ThreadLocalRandomæ–‡æ¡£</a>é‡Œæœ‰è¿™ä¹ˆä¸€æ¡ï¼š</p><blockquote>\n<p>Usages of this class should typically be of the form: ThreadLocalRandom.current().nextX(â€¦) (where X is Int, Long, etc). When all usages are of this form, it is never possible to accidently share a ThreadLocalRandom across multiple threads.</p>\n</blockquote><!-- [[[read_end]]] --><p>é‚£ä¸ºä»€ä¹ˆè§„å®šè¦ThreadLocalRandom.current().nextX(â€¦)è¿™æ ·æ¥ä½¿ç”¨å‘¢ï¼Ÿæˆ‘æ¥åˆ†æä¸‹åŸå› å§ã€‚</p><p>current()çš„æ—¶å€™åˆå§‹åŒ–ä¸€ä¸ªåˆå§‹åŒ–ç§å­åˆ°çº¿ç¨‹ï¼Œæ¯æ¬¡nextseedå†ä½¿ç”¨ä¹‹å‰çš„ç§å­ç”Ÿæˆæ–°çš„ç§å­ï¼š</p><pre><code>UNSAFE.putLong(t = Thread.currentThread(), SEED, r = UNSAFE.getLong(t, SEED) + GAMMA);\n</code></pre><p>å¦‚æœä½ é€šè¿‡ä¸»çº¿ç¨‹è°ƒç”¨ä¸€æ¬¡currentç”Ÿæˆä¸€ä¸ªThreadLocalRandomçš„å®ä¾‹ä¿å­˜èµ·æ¥ï¼Œé‚£ä¹ˆå…¶å®ƒçº¿ç¨‹æ¥è·å–ç§å­çš„æ—¶å€™å¿…ç„¶å–ä¸åˆ°åˆå§‹ç§å­ï¼Œå¿…é¡»æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹è‡ªå·±ç”¨çš„æ—¶å€™åˆå§‹åŒ–ä¸€ä¸ªç§å­åˆ°çº¿ç¨‹ã€‚ä½ å¯ä»¥åœ¨nextSeedæ–¹æ³•è®¾ç½®ä¸€ä¸ªæ–­ç‚¹æ¥æµ‹è¯•ï¼š</p><pre><code>UNSAFE.getLong(Thread.currentThread(),SEED);\n</code></pre><p><strong>é—®é¢˜2ï¼š</strong>ConcurrentHashMapè¿˜æä¾›äº†putIfAbsentæ–¹æ³•ï¼Œä½ èƒ½å¦é€šè¿‡æŸ¥é˜…<a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html\">JDKæ–‡æ¡£</a>ï¼Œè¯´è¯´computeIfAbsentå’ŒputIfAbsentæ–¹æ³•çš„åŒºåˆ«ï¼Ÿ</p><p>ç­”ï¼šcomputeIfAbsentå’ŒputIfAbsentè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œéƒ½æ˜¯åˆ¤æ–­å€¼ä¸å­˜åœ¨çš„æ—¶å€™ä¸ºMapè¿›è¡Œèµ‹å€¼çš„åŸå­æ–¹æ³•ï¼Œå®ƒä»¬çš„åŒºåˆ«å…·ä½“åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š</p><ol>\n<li>å½“Keyå­˜åœ¨çš„æ—¶å€™ï¼Œå¦‚æœValueçš„è·å–æ¯”è¾ƒæ˜‚è´µçš„è¯ï¼ŒputIfAbsentæ–¹æ³•å°±ä¼šç™½ç™½æµªè´¹æ—¶é—´åœ¨è·å–è¿™ä¸ªæ˜‚è´µçš„Valueä¸Šï¼ˆè¿™ä¸ªç‚¹ç‰¹åˆ«æ³¨æ„ï¼‰ï¼Œè€ŒcomputeIfAbsentåˆ™ä¼šå› ä¸ºä¼ å…¥çš„æ˜¯Lambdaè¡¨è¾¾å¼è€Œä¸æ˜¯å®é™…å€¼ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚</li>\n<li>Keyä¸å­˜åœ¨çš„æ—¶å€™ï¼ŒputIfAbsentä¼šè¿”å›nullï¼Œè¿™æ—¶å€™æˆ‘ä»¬è¦å°å¿ƒç©ºæŒ‡é’ˆï¼›è€ŒcomputeIfAbsentä¼šè¿”å›è®¡ç®—åçš„å€¼ï¼Œä¸å­˜åœ¨ç©ºæŒ‡é’ˆçš„é—®é¢˜ã€‚</li>\n<li>å½“Keyä¸å­˜åœ¨çš„æ—¶å€™ï¼ŒputIfAbsentå…è®¸put nullè¿›å»ï¼Œè€ŒcomputeIfAbsentä¸èƒ½ï¼ˆå½“ç„¶äº†ï¼Œæ­¤æ¡é’ˆå¯¹HashMapï¼ŒConcurrentHashMapä¸å…è®¸put null valueè¿›å»ï¼‰ã€‚</li>\n</ol><p>æˆ‘å†™äº†ä¸€æ®µä»£ç æ¥è¯æ˜è¿™ä¸‰ç‚¹ï¼Œä½ å¯ä»¥ç‚¹å‡»<a href=\"https://github.com/JosephZhu1983/java-common-mistakes/blob/master/src/main/java/org/geekbang/time/commonmistakes/concurrenttool/ciavspia/CommonMistakesApplication.java\">è¿™é‡Œ</a>çš„GitHubé“¾æ¥æŸ¥çœ‹ã€‚</p><h3><a href=\"https://time.geekbang.org/column/article/209520\">02 | ä»£ç åŠ é”ï¼šä¸è¦è®©â€œé”â€äº‹æˆä¸ºçƒ¦å¿ƒäº‹</a></h3><p><strong>é—®é¢˜1ï¼š</strong>åœ¨è¿™ä¸€è®²å¼€å¤´çš„ä¾‹å­é‡Œï¼Œæˆ‘ä»¬ä¸ºå˜é‡aã€béƒ½ä½¿ç”¨äº†volatileå…³é”®å­—è¿›è¡Œä¿®é¥°ï¼Œä½ çŸ¥é“volatileå…³é”®å­—çš„ä½œç”¨å—ï¼Ÿæˆ‘ä¹‹å‰é‡åˆ°è¿‡è¿™æ ·ä¸€ä¸ªå‘ï¼šæˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹æ— é™å¾ªç¯æ¥è·‘ä¸€äº›ä»»åŠ¡ï¼Œæœ‰ä¸€ä¸ªboolç±»å‹çš„å˜é‡æ¥æ§åˆ¶å¾ªç¯çš„é€€å‡ºï¼Œé»˜è®¤ä¸ºtrueä»£è¡¨æ‰§è¡Œï¼Œä¸€æ®µæ—¶é—´åä¸»çº¿ç¨‹å°†è¿™ä¸ªå˜é‡è®¾ç½®ä¸ºäº†falseã€‚å¦‚æœè¿™ä¸ªå˜é‡ä¸æ˜¯volatileä¿®é¥°çš„ï¼Œå­çº¿ç¨‹å¯ä»¥é€€å‡ºå—ï¼Ÿä½ èƒ½å¦è§£é‡Šå…¶ä¸­çš„åŸå› å‘¢ï¼Ÿ</p><p>ç­”ï¼šä¸èƒ½é€€å‡ºã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œ3ç§’åå¦ä¸€ä¸ªçº¿ç¨‹æŠŠbè®¾ç½®ä¸ºfalseï¼Œä½†æ˜¯ä¸»çº¿ç¨‹æ— æ³•é€€å‡ºï¼š</p><pre><code>private static boolean b = true;\npublic static void main(String[] args) throws InterruptedException {\n    new Thread(()-&gt;{\n        try {\n            TimeUnit.SECONDS.sleep(3);\n        } catch (InterruptedException e) { }\n        b =false;\n    }).start();\n    while (b) {\n        TimeUnit.MILLISECONDS.sleep(0);\n    }\n    System.out.println(&quot;done&quot;);\n}\n</code></pre><p>å…¶å®ï¼Œè¿™æ˜¯å¯è§æ€§çš„é—®é¢˜ã€‚</p><p>è™½ç„¶å¦ä¸€ä¸ªçº¿ç¨‹æŠŠbè®¾ç½®ä¸ºäº†falseï¼Œä½†æ˜¯è¿™ä¸ªå­—æ®µåœ¨CPUç¼“å­˜ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰è¿˜æ˜¯è¯»ä¸åˆ°æœ€æ–°çš„å€¼ã€‚ä½¿ç”¨volatileå…³é”®å­—ï¼Œå¯ä»¥è®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚å‡†ç¡®æ¥è¯´ï¼Œè®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»æ˜¯ä¸¤ä»¶äº‹æƒ…ï¼š</p><ol>\n<li>å°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®ï¼Œå†™å›åˆ°ç³»ç»Ÿå†…å­˜ï¼›</li>\n<li>è¿™ä¸ªå†™å›å†…å­˜çš„æ“ä½œä¼šå¯¼è‡´å…¶ä»–CPUé‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®å˜ä¸ºæ— æ•ˆã€‚</li>\n</ol><p>å½“ç„¶ï¼Œä½¿ç”¨AtomicBooleanç­‰å…³é”®å­—æ¥ä¿®æ”¹å˜é‡bä¹Ÿè¡Œã€‚ä½†ç›¸æ¯”volatileæ¥è¯´ï¼ŒAtomicBooleanç­‰å…³é”®å­—é™¤äº†ç¡®ä¿å¯è§æ€§ï¼Œè¿˜æä¾›äº†CASæ–¹æ³•ï¼Œå…·æœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Œåœ¨æœ¬ä¾‹çš„åœºæ™¯ä¸­ç”¨ä¸åˆ°ã€‚</p><p><strong>é—®é¢˜2ï¼š</strong>å…³äºä»£ç åŠ é”è¿˜æœ‰ä¸¤ä¸ªå‘ï¼Œä¸€æ˜¯åŠ é”å’Œé‡Šæ”¾æ²¡æœ‰é…å¯¹çš„é—®é¢˜ï¼ŒäºŒæ˜¯åˆ†å¸ƒå¼é”è‡ªåŠ¨é‡Šæ”¾å¯¼è‡´çš„é‡å¤é€»è¾‘æ‰§è¡Œçš„é—®é¢˜ã€‚ä½ æœ‰ä»€ä¹ˆæ–¹æ³•æ¥å‘ç°å’Œè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜å—ï¼Ÿ</p><p>ç­”ï¼šé’ˆå¯¹åŠ è§£é”æ²¡æœ‰é…å¯¹çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€äº›ä»£ç è´¨é‡å·¥å…·æˆ–ä»£ç æ‰«æå·¥å…·ï¼ˆæ¯”å¦‚Sonarï¼‰æ¥å¸®åŠ©æ’æŸ¥ã€‚è¿™ä¸ªé—®é¢˜åœ¨ç¼–ç é˜¶æ®µå°±èƒ½å‘ç°ã€‚</p><p>é’ˆå¯¹åˆ†å¸ƒå¼é”è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒRedissonçš„RedissonLockçš„<a href=\"https://github.com/redisson/redisson/blob/e11c1e14ba50bc5938184fb96d9b72782e591df7/redisson/src/main/java/org/redisson/RedissonLock.java#L265\">é”ç»­æœŸæœºåˆ¶</a>ã€‚é”ç»­æœŸæ˜¯æ¯æ¬¡ç»­ä¸€æ®µæ—¶é—´ï¼Œæ¯”å¦‚30ç§’ï¼Œç„¶å10ç§’æ‰§è¡Œä¸€æ¬¡ç»­æœŸã€‚è™½ç„¶æ˜¯æ— é™æ¬¡ç»­æœŸï¼Œä½†å³ä½¿å®¢æˆ·ç«¯å´©æºƒäº†ä¹Ÿæ²¡å…³ç³»ï¼Œä¸ä¼šæ— é™æœŸå ç”¨é”ï¼Œå› ä¸ºå´©æºƒåæ— æ³•è‡ªåŠ¨ç»­æœŸè‡ªç„¶æœ€ç»ˆä¼šè¶…æ—¶ã€‚</p><h3><a href=\"https://time.geekbang.org/column/article/210337\">03 | çº¿ç¨‹æ± ï¼šä¸šåŠ¡ä»£ç æœ€å¸¸ç”¨ä¹Ÿæœ€å®¹æ˜“çŠ¯é”™çš„ç»„ä»¶</a></h3><p><strong>é—®é¢˜1ï¼š</strong>åœ¨è®²çº¿ç¨‹æ± çš„ç®¡ç†ç­–ç•¥æ—¶æˆ‘ä»¬æåˆ°ï¼Œæˆ–è®¸ä¸€ä¸ªæ¿€è¿›åˆ›å»ºçº¿ç¨‹çš„å¼¹æ€§çº¿ç¨‹æ± æ›´ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½ èƒ½ç»™å‡ºç›¸å…³çš„å®ç°å—ï¼Ÿå®ç°åå†æµ‹è¯•ä¸€ä¸‹ï¼Œæ˜¯å¦æ‰€æœ‰çš„ä»»åŠ¡éƒ½å¯ä»¥æ­£å¸¸å¤„ç†å®Œæˆå‘¢ï¼Ÿ</p><p>ç­”ï¼šæˆ‘ä»¬æŒ‰ç…§æ–‡ä¸­æåˆ°çš„ä¸¤ä¸ªæ€è·¯æ¥å®ç°ä¸€ä¸‹æ¿€è¿›çº¿ç¨‹æ± ï¼š</p><ol>\n<li>ç”±äºçº¿ç¨‹æ± åœ¨å·¥ä½œé˜Ÿåˆ—æ»¡äº†æ— æ³•å…¥é˜Ÿçš„æƒ…å†µä¸‹ä¼šæ‰©å®¹çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é‡å†™é˜Ÿåˆ—çš„ offer æ–¹æ³•ï¼Œé€ æˆè¿™ä¸ªé˜Ÿåˆ—å·²æ»¡çš„å‡è±¡ï¼›</li>\n<li>ç”±äºæˆ‘ä»¬ Hack äº†é˜Ÿåˆ—ï¼Œåœ¨è¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹ååŠ¿å¿…ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥å¤„ç†ç¨‹åºï¼Œè¿™ä¸ªæ—¶å€™å†æŠŠä»»åŠ¡çœŸæ­£æ’å…¥é˜Ÿåˆ—ã€‚</li>\n</ol><p>å®Œæ•´çš„å®ç°ä»£ç ä»¥åŠç›¸åº”çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>@GetMapping(&quot;better&quot;)\npublic int better() throws InterruptedException {\n    //è¿™é‡Œå¼€å§‹æ˜¯æ¿€è¿›çº¿ç¨‹æ± çš„å®ç°\n    BlockingQueue&lt;Runnable&gt; queue = new LinkedBlockingQueue&lt;Runnable&gt;(10) {\n        @Override\n        public boolean offer(Runnable e) {\n            //å…ˆè¿”å›falseï¼Œé€ æˆé˜Ÿåˆ—æ»¡çš„å‡è±¡ï¼Œè®©çº¿ç¨‹æ± ä¼˜å…ˆæ‰©å®¹\n            return false;\n        }\n    };\n\n    ThreadPoolExecutor threadPool = new ThreadPoolExecutor(\n            2, 5,\n            5, TimeUnit.SECONDS,\n            queue, new ThreadFactoryBuilder().setNameFormat(&quot;demo-threadpool-%d&quot;).get(), (r, executor) -&gt; {\n        try {\n            //ç­‰å‡ºç°æ‹’ç»åå†åŠ å…¥é˜Ÿåˆ—\n            //å¦‚æœå¸Œæœ›é˜Ÿåˆ—æ»¡äº†é˜»å¡çº¿ç¨‹è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå¯ä»¥æ³¨é‡Šæ‰ä¸‹é¢ä¸‰è¡Œä»£ç ï¼Œä¿®æ”¹ä¸ºexecutor.getQueue().put(r);\n            if (!executor.getQueue().offer(r, 0, TimeUnit.SECONDS)) {\n                throw new RejectedExecutionException(&quot;ThreadPool queue full, failed to offer &quot; + r.toString());\n            }\n        } catch (InterruptedException e) {\n            Thread.currentThread().interrupt();\n        }\n    });\n    //æ¿€è¿›çº¿ç¨‹æ± å®ç°ç»“æŸ\n\n    printStats(threadPool);\n    //æ¯ç§’æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡è€—æ—¶10ç§’æ‰§è¡Œå®Œæˆï¼Œä¸€å…±æäº¤20ä¸ªä»»åŠ¡\n\n    //ä»»åŠ¡ç¼–å·è®¡æ•°å™¨\n    AtomicInteger atomicInteger = new AtomicInteger();\n\n    IntStream.rangeClosed(1, 20).forEach(i -&gt; {\n        try {\n            TimeUnit.SECONDS.sleep(1);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        int id = atomicInteger.incrementAndGet();\n        try {\n            threadPool.submit(() -&gt; {\n                log.info(&quot;{} started&quot;, id);\n                try {\n                    TimeUnit.SECONDS.sleep(10);\n                } catch (InterruptedException e) {\n                }\n                log.info(&quot;{} finished&quot;, id);\n            });\n        } catch (Exception ex) {\n            log.error(&quot;error submitting task {}&quot;, id, ex);\n            atomicInteger.decrementAndGet();\n        }\n    });\n\n    TimeUnit.SECONDS.sleep(60);\n    return atomicInteger.intValue();\n}\n</code></pre><p>ä½¿ç”¨è¿™ä¸ªæ¿€è¿›çš„çº¿ç¨‹æ± å¯ä»¥å¤„ç†å®Œè¿™20ä¸ªä»»åŠ¡ï¼Œå› ä¸ºæˆ‘ä»¬ä¼˜å…ˆå¼€å¯äº†æ›´å¤šçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚</p><pre><code>[10:57:16.092] [demo-threadpool-4] [INFO ] [o.g.t.c.t.t.ThreadPoolOOMController:157 ] - 20 finished\n[10:57:17.062] [pool-8-thread-1] [INFO ] [o.g.t.c.t.t.ThreadPoolOOMController:22  ] - =========================\n[10:57:17.062] [pool-8-thread-1] [INFO ] [o.g.t.c.t.t.ThreadPoolOOMController:23  ] - Pool Size: 5\n[10:57:17.062] [pool-8-thread-1] [INFO ] [o.g.t.c.t.t.ThreadPoolOOMController:24  ] - Active Threads: 0\n[10:57:17.062] [pool-8-thread-1] [INFO ] [o.g.t.c.t.t.ThreadPoolOOMController:25  ] - Number of Tasks Completed: 20\n[10:57:17.062] [pool-8-thread-1] [INFO ] [o.g.t.c.t.t.ThreadPoolOOMController:26  ] - Number of Tasks in Queue: 0\n[10:57:17.062] [pool-8-thread-1] [INFO ] [o.g.t.c.t.t.ThreadPoolOOMController:28  ] - =========================\n</code></pre><p><strong>é—®é¢˜2ï¼š</strong>åœ¨è®²â€œåŠ¡å¿…ç¡®è®¤æ¸…æ¥šçº¿ç¨‹æ± æœ¬èº«æ˜¯ä¸æ˜¯å¤ç”¨â€æ—¶ï¼Œæˆ‘ä»¬æ”¹è¿›äº†ThreadPoolHelperä½¿å…¶èƒ½å¤Ÿè¿”å›å¤ç”¨çš„çº¿ç¨‹æ± ã€‚å¦‚æœæˆ‘ä»¬ä¸å°å¿ƒæ¯æ¬¡éƒ½åˆ›å»ºäº†è¿™æ ·ä¸€ä¸ªè‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼ˆ10æ ¸å¿ƒçº¿ç¨‹ï¼Œ50æœ€å¤§çº¿ç¨‹ï¼Œ2ç§’å›æ”¶çš„ï¼‰ï¼Œåå¤æ‰§è¡Œæµ‹è¯•æ¥å£çº¿ç¨‹ï¼Œæœ€ç»ˆå¯ä»¥è¢«å›æ”¶å—ï¼Ÿä¼šå‡ºç°OOMé—®é¢˜å—ï¼Ÿ</p><p>ç­”ï¼šä¼šå› ä¸ºåˆ›å»ºè¿‡å¤šçº¿ç¨‹å¯¼è‡´OOMï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹æ ¸å¿ƒçº¿ç¨‹ä¸ä¼šå›æ”¶ï¼Œå¹¶ä¸”ThreadPoolExecutorä¹Ÿå›æ”¶ä¸äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹å®ƒçš„æºç ï¼Œå·¥ä½œçº¿ç¨‹Workeræ˜¯å†…éƒ¨ç±»ï¼Œåªè¦å®ƒæ´»ç€ï¼Œæ¢å¥è¯è¯´å°±æ˜¯çº¿ç¨‹åœ¨è·‘ï¼Œå°±ä¼šé˜»æ­¢ThreadPoolExecutorå›æ”¶ï¼š</p><pre><code>public class ThreadPoolExecutor extends AbstractExecutorService {\n    private final class Worker\n        extends AbstractQueuedSynchronizer\n        implements Runnable \n        { \n        }\n }\n</code></pre><p>å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½è®¤ä¸ºThreadPoolExecutoræ²¡æœ‰å¼•ç”¨ï¼Œå°±èƒ½å›æ”¶ã€‚</p><h3><a href=\"https://time.geekbang.org/column/article/211388\">04 | è¿æ¥æ± ï¼šåˆ«è®©è¿æ¥æ± å¸®äº†å€’å¿™</a></h3><p><strong>é—®é¢˜1ï¼š</strong>æœ‰äº†è¿æ¥æ± ä¹‹åï¼Œè·å–è¿æ¥æ˜¯ä»è¿æ¥æ± è·å–ï¼Œæ²¡æœ‰è¶³å¤Ÿè¿æ¥æ—¶è¿æ¥æ± ä¼šåˆ›å»ºè¿æ¥ã€‚è¿™æ—¶ï¼Œè·å–è¿æ¥æ“ä½œå¾€å¾€æœ‰ä¸¤ä¸ªè¶…æ—¶æ—¶é—´ï¼šä¸€ä¸ªæ˜¯ä»è¿æ¥æ± è·å–è¿æ¥çš„æœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œé€šå¸¸å«ä½œè¯·æ±‚è¿æ¥è¶…æ—¶connectRequestTimeoutï¼Œæˆ–è¿æ¥ç­‰å¾…è¶…æ—¶connectWaitTimeoutï¼›ä¸€ä¸ªæ˜¯è¿æ¥æ± æ–°å»ºTCPè¿æ¥ä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥è¶…æ—¶ï¼Œé€šå¸¸å«ä½œè¿æ¥è¶…æ—¶connectTimeoutã€‚é’ˆå¯¹JedisPoolã€Apache HttpClientå’ŒHikariæ•°æ®åº“è¿æ¥æ± ï¼Œä½ çŸ¥é“å¦‚ä½•è®¾ç½®è¿™2ä¸ªå‚æ•°å—ï¼Ÿ</p><p>ç­”ï¼šå‡è®¾æˆ‘ä»¬å¸Œæœ›è®¾ç½®è¿æ¥è¶…æ—¶5sã€è¯·æ±‚è¿æ¥è¶…æ—¶10sï¼Œä¸‹é¢æˆ‘æ¥æ¼”ç¤ºä¸‹ï¼Œå¦‚ä½•é…ç½®Hikariã€Jediså’ŒHttpClientçš„ä¸¤ä¸ªè¶…æ—¶å‚æ•°ã€‚</p><p>é’ˆå¯¹Hikariï¼Œè®¾ç½®ä¸¤ä¸ªè¶…æ—¶æ—¶é—´çš„æ–¹å¼ï¼Œæ˜¯ä¿®æ”¹æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸­çš„connectTimeoutå±æ€§å’Œé…ç½®æ–‡ä»¶ä¸­çš„hikarié…ç½®çš„connection-timeoutï¼š</p><pre><code>spring.datasource.hikari.connection-timeout=10000\n\nspring.datasource.url=jdbc:mysql://localhost:6657/common_mistakes?connectTimeout=5000&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;rewriteBatchedStatements=true\n</code></pre><p>é’ˆå¯¹Jedisï¼Œæ˜¯è®¾ç½®JedisPoolConfigçš„MaxWaitMilliså±æ€§å’Œè®¾ç½®åˆ›å»ºJedisPoolæ—¶çš„timeoutå±æ€§ï¼š</p><pre><code>JedisPoolConfig config = new JedisPoolConfig();\nconfig.setMaxWaitMillis(10000);\ntry (JedisPool jedisPool = new JedisPool(config, &quot;127.0.0.1&quot;, 6379, 5000);\n     Jedis jedis = jedisPool.getResource()) {\n    return jedis.set(&quot;test&quot;, &quot;test&quot;);\n}\n</code></pre><p>é’ˆå¯¹HttpClientï¼Œæ˜¯è®¾ç½®RequestConfigçš„ConnectionRequestTimeoutå’ŒConnectTimeoutå±æ€§ï¼š</p><pre><code>RequestConfig requestConfig = RequestConfig.custom()\n        .setConnectTimeout(5000)\n        .setConnectionRequestTimeout(10000)\n        .build();\nHttpGet httpGet = new HttpGet(&quot;http://127.0.0.1:45678/twotimeoutconfig/test&quot;);\nhttpGet.setConfig(requestConfig);\ntry (CloseableHttpResponse response = httpClient.execute(httpGet)) {\n    return EntityUtils.toString(response.getEntity());\n} catch (Exception ex) {\n    ex.printStackTrace();\n}\nreturn null;\n</code></pre><p>ä¹Ÿå¯ä»¥ç›´æ¥å‚è€ƒæˆ‘æ”¾åœ¨<a href=\"https://github.com/JosephZhu1983/java-common-mistakes/tree/master/src/main/java/org/geekbang/time/commonmistakes/connectionpool/twotimeoutconfig\">GitHub</a>ä¸Šçš„æºç ã€‚</p><p><strong>é—®é¢˜2ï¼š</strong>å¯¹äºå¸¦æœ‰è¿æ¥æ± çš„SDKçš„ä½¿ç”¨å§¿åŠ¿ï¼Œæœ€ä¸»è¦çš„æ˜¯é‰´åˆ«å…¶å†…éƒ¨æ˜¯å¦å®ç°äº†è¿æ¥æ± ï¼Œå¦‚æœå®ç°äº†è¿æ¥æ± è¦å°½é‡å¤ç”¨Clientã€‚å¯¹äºNoSQLä¸­çš„MongoDBæ¥è¯´ï¼Œä½¿ç”¨MongoDB Javaé©±åŠ¨æ—¶ï¼ŒMongoClientç±»åº”è¯¥æ˜¯æ¯æ¬¡éƒ½åˆ›å»ºè¿˜æ˜¯å¤ç”¨å‘¢ï¼Ÿä½ èƒ½å¦åœ¨<a href=\"https://mongodb.github.io/mongo-java-driver/3.12/\">å®˜æ–¹æ–‡æ¡£</a>ä¸­æ‰¾åˆ°ç­”æ¡ˆå‘¢ï¼Ÿ</p><p>ç­”ï¼šå®˜æ–¹æ–‡æ¡£é‡Œæœ‰è¿™ä¹ˆä¸€æ®µè¯ï¼š</p><blockquote>\n<p>Typically you only create one MongoClient instance for a given MongoDB deployment (e.g. standalone, replica set, or a sharded cluster) and use it across your application. However, if you do create multiple instances:<br>\nAll resource usage limits (e.g. max connections, etc.) apply per MongoClient instance.<br>\nTo dispose of an instance, call MongoClient.close() to clean up resources.</p>\n</blockquote><p>MongoClientç±»åº”è¯¥å°½å¯èƒ½å¤ç”¨ï¼ˆä¸€ä¸ªMongoDBéƒ¨ç½²åªä½¿ç”¨ä¸€ä¸ªMongoClientï¼‰ï¼Œä¸è¿‡å¤ç”¨ä¸ç­‰äºåœ¨ä»»ä½•æƒ…å†µä¸‹å°±åªç”¨ä¸€ä¸ªã€‚æ­£å¦‚æ–‡æ¡£é‡Œæ‰€è¯´ï¼Œæ¯ä¸€ä¸ªMongoClientç¤ºä¾‹æœ‰è‡ªå·±ç‹¬ç«‹çš„èµ„æºé™åˆ¶ã€‚</p><h3><a href=\"https://time.geekbang.org/column/article/213273\">05 | HTTPè°ƒç”¨ï¼šä½ è€ƒè™‘åˆ°è¶…æ—¶ã€é‡è¯•ã€å¹¶å‘äº†å—ï¼Ÿ</a></h3><p><strong>é—®é¢˜1ï¼š</strong>åœ¨â€œé…ç½®è¿æ¥è¶…æ—¶å’Œè¯»å–è¶…æ—¶å‚æ•°çš„å­¦é—®â€è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¼ºè°ƒäº†è¦æ³¨æ„è¿æ¥è¶…æ—¶å’Œè¯»å–è¶…æ—¶å‚æ•°çš„é…ç½®ï¼Œå¤§å¤šæ•°çš„HTTPå®¢æˆ·ç«¯ä¹Ÿéƒ½æœ‰è¿™ä¸¤ä¸ªå‚æ•°ã€‚æœ‰è¯»å°±æœ‰å†™ï¼Œä½†ä¸ºä»€ä¹ˆæˆ‘ä»¬å¾ˆå°‘çœ‹åˆ°â€œå†™å…¥è¶…æ—¶â€çš„æ¦‚å¿µå‘¢ï¼Ÿ</p><p>ç­”ï¼šå…¶å®å†™å…¥æ“ä½œåªæ˜¯å°†æ•°æ®å†™å…¥TCPçš„å‘é€ç¼“å†²åŒºï¼Œå·²ç»å‘é€åˆ°ç½‘ç»œçš„æ•°æ®ä¾ç„¶éœ€è¦æš‚å­˜åœ¨å‘é€ç¼“å†²åŒºä¸­ï¼Œåªæœ‰æ”¶åˆ°å¯¹æ–¹çš„ackåï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸æ‰ä»ç¼“å†²åŒºä¸­æ¸…é™¤è¿™ä¸€éƒ¨åˆ†æ•°æ®ï¼Œä¸ºåç»­å‘é€æ•°æ®è…¾å‡ºç©ºé—´ã€‚</p><p>å¦‚æœæ¥æ”¶ç«¯ä»socketè¯»å–æ•°æ®çš„é€Ÿåº¦å¤ªæ…¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‘é€ç«¯å‘é€ç¼“å†²åŒºæ»¡ï¼Œå¯¼è‡´å†™å…¥æ“ä½œé˜»å¡ï¼Œäº§ç”Ÿå†™å…¥è¶…æ—¶ã€‚ä½†æ˜¯ï¼Œå› ä¸ºæœ‰æ»‘åŠ¨çª—å£çš„æ§åˆ¶ï¼Œé€šå¸¸ä¸å¤ªå®¹æ˜“å‘ç”Ÿå‘é€ç¼“å†²åŒºæ»¡å¯¼è‡´å†™å…¥è¶…æ—¶çš„æƒ…å†µã€‚ç›¸åï¼Œè¯»å–è¶…æ—¶åŒ…å«äº†æœåŠ¡ç«¯å¤„ç†æ•°æ®æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„æ—¶é—´ï¼Œæ‰€ä»¥è¯»å–è¶…æ—¶æ˜¯æ¯”è¾ƒå®¹æ˜“å‘ç”Ÿçš„ã€‚</p><p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šæ¯”è¾ƒé‡è§†è¯»å–è¶…æ—¶è€Œä¸æ˜¯å†™å…¥è¶…æ—¶çš„åŸå› äº†ã€‚</p><p><strong>é—®é¢˜2ï¼š</strong>é™¤äº†Ribbonçš„AutoRetriesNextServeré‡è¯•æœºåˆ¶ï¼ŒNginxä¹Ÿæœ‰ç±»ä¼¼çš„é‡è¯•åŠŸèƒ½ã€‚ä½ äº†è§£Nginxç›¸å…³çš„é…ç½®å—ï¼Ÿ</p><p>ç­”ï¼šå…³äºNginxçš„é‡è¯•åŠŸèƒ½ï¼Œä½ å¯ä»¥å‚è€ƒ<a href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream\">è¿™é‡Œ</a>ï¼Œäº†è§£ä¸‹Nginxçš„proxy_next_upstreamé…ç½®ã€‚</p><p>proxy_next_upstreamï¼Œç”¨äºæŒ‡å®šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹Nginxä¼šå°†è¯·æ±‚è½¬ç§»åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šã€‚å…¶é»˜è®¤å€¼æ˜¯proxy_next_upstream error timeoutï¼Œå³å‘ç”Ÿç½‘ç»œé”™è¯¯ä»¥åŠè¶…æ—¶ï¼Œæ‰ä¼šé‡è¯•å…¶ä»–æœåŠ¡å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡è¿”å›500çŠ¶æ€ç æ˜¯ä¸ä¼šé‡è¯•çš„ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨è¯·æ±‚è¿”å›500çŠ¶æ€ç æ—¶ä¹Ÿè¿›è¡Œé‡è¯•ï¼Œå¯ä»¥é…ç½®ï¼š</p><pre><code>proxy_next_upstream error timeout http_500;\n</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œproxy_next_upstreamé…ç½®ä¸­æœ‰ä¸€ä¸ªé€‰é¡¹non_idempotentï¼Œä¸€å®šè¦å°å¿ƒå¼€å¯ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè¯·æ±‚ä½¿ç”¨éç­‰å¹‚æ–¹æ³•ï¼ˆPOSTã€PATCHï¼‰ï¼Œè¯·æ±‚å¤±è´¥åä¸ä¼šå†åˆ°å…¶ä»–æœåŠ¡å™¨è¿›è¡Œé‡è¯•ã€‚ä½†æ˜¯ï¼ŒåŠ ä¸Šnon_idempotentè¿™ä¸ªé€‰é¡¹åï¼Œå³ä½¿æ˜¯éå¹‚ç­‰è¯·æ±‚ç±»å‹ï¼ˆä¾‹å¦‚POSTè¯·æ±‚ï¼‰ï¼Œå‘ç”Ÿé”™è¯¯åä¹Ÿä¼šé‡è¯•ã€‚</p><h3><a href=\"https://time.geekbang.org/column/article/213295\">06 | 20%çš„ä¸šåŠ¡ä»£ç çš„Springå£°æ˜å¼äº‹åŠ¡ï¼Œå¯èƒ½éƒ½æ²¡å¤„ç†æ­£ç¡®</a></h3><p><strong>é—®é¢˜1ï¼š</strong>è€ƒè™‘åˆ°Demoçš„ç®€æ´ï¼Œè¿™ä¸€è®²ä¸­æ‰€æœ‰æ•°æ®è®¿é—®ä½¿ç”¨çš„éƒ½æ˜¯Spring Data JPAã€‚å›½å†…å¤§å¤šæ•°äº’è”ç½‘ä¸šåŠ¡é¡¹ç›®æ˜¯ä½¿ç”¨MyBatisè¿›è¡Œæ•°æ®è®¿é—®çš„ï¼Œä½¿ç”¨MyBatisé…åˆSpringçš„å£°æ˜å¼äº‹åŠ¡ä¹ŸåŒæ ·éœ€è¦æ³¨æ„è¿™ä¸€è®²ä¸­æåˆ°çš„è¿™äº›ç‚¹ã€‚ä½ å¯ä»¥å°è¯•æŠŠä»Šå¤©çš„Demoæ”¹ä¸ºMyBatisåšæ•°æ®è®¿é—®å®ç°ï¼Œçœ‹çœ‹æ—¥å¿—ä¸­æ˜¯å¦å¯ä»¥ä½“ç°å‡ºè¿™äº›å‘ï¼Ÿ</p><p>ç­”ï¼šä½¿ç”¨mybatis-spring-boot-starteræ— éœ€åšä»»ä½•é…ç½®ï¼Œå³å¯ä½¿MyBatisæ•´åˆSpringçš„å£°æ˜å¼äº‹åŠ¡ã€‚åœ¨GitHubä¸Šçš„è¯¾ç¨‹<a href=\"https://github.com/JosephZhu1983/java-common-mistakes/tree/master/src/main/java/org/geekbang/time/commonmistakes/transaction/nested\">æºç </a>ä¸­ï¼Œæˆ‘æ›´æ–°äº†ä¸€ä¸ªä½¿ç”¨MyBatisé…å¥—åµŒå¥—äº‹åŠ¡çš„ä¾‹å­ï¼Œå®ç°çš„æ•ˆæœæ˜¯ä¸»æ–¹æ³•å‡ºç°å¼‚å¸¸ï¼Œå­æ–¹æ³•çš„åµŒå¥—äº‹åŠ¡ä¹Ÿä¼šå›æ»šã€‚</p><p>æˆ‘æ¥å’Œä½ è§£é‡Šä¸‹è¿™ä¸ªä¾‹å­ä¸­çš„æ ¸å¿ƒä»£ç ï¼š</p><pre><code>@Transactional\npublic void createUser(String name) {\n    createMainUser(name);\n    try {\n        subUserService.createSubUser(name);\n    } catch (Exception ex) {\n        log.error(&quot;create sub user error:{}&quot;, ex.getMessage());\n    }\n    //å¦‚æœcreateSubUseræ˜¯NESTEDæ¨¡å¼ï¼Œè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ä¼šå¯¼è‡´åµŒå¥—äº‹åŠ¡æ— æ³•â€œæäº¤â€\n    throw new RuntimeException(&quot;create main user error&quot;);\n}\n</code></pre><p>å­æ–¹æ³•ä½¿ç”¨äº†NESTEDäº‹åŠ¡ä¼ æ’­æ¨¡å¼ï¼š</p><pre><code>@Transactional(propagation = Propagation.NESTED)\npublic void createSubUser(String name) {\n    userDataMapper.insert(name, &quot;sub&quot;);\n}\n</code></pre><p>æ‰§è¡Œæ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/0e/cda8d69f99c0063046a085a39d520c0e.png?wh=1280*360\" alt=\"\"></p><p>æ¯ä¸ªNESTEDäº‹åŠ¡æ‰§è¡Œå‰ï¼Œä¼šå°†å½“å‰æ“ä½œä¿å­˜ä¸‹æ¥ï¼Œå«åšsavepointï¼ˆä¿å­˜ç‚¹ï¼‰ã€‚NESTEDäº‹åŠ¡åœ¨å¤–éƒ¨äº‹åŠ¡æäº¤ä»¥åè‡ªå·±æ‰ä¼šæäº¤ï¼Œå¦‚æœå½“å‰NESTEDäº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å›æ»šåˆ°ä¹‹å‰çš„ä¿å­˜ç‚¹ã€‚</p><p><strong>é—®é¢˜2ï¼š</strong>åœ¨è®²â€œå°å¿ƒ Spring çš„äº‹åŠ¡å¯èƒ½æ²¡æœ‰ç”Ÿæ•ˆâ€æ—¶æˆ‘ä»¬æåˆ°ï¼Œå¦‚æœè¦é’ˆå¯¹privateæ–¹æ³•å¯ç”¨äº‹åŠ¡ï¼ŒåŠ¨æ€ä»£ç†æ–¹å¼çš„AOPä¸å¯è¡Œï¼Œéœ€è¦ä½¿ç”¨é™æ€ç»‡å…¥æ–¹å¼çš„AOPï¼Œä¹Ÿå°±æ˜¯åœ¨ç¼–è¯‘æœŸé—´ç»‡å…¥äº‹åŠ¡å¢å¼ºä»£ç ï¼Œå¯ä»¥é…ç½®Springæ¡†æ¶ä½¿ç”¨AspectJæ¥å®ç°AOPã€‚ä½ èƒ½å¦å‚é˜…Springçš„æ–‡æ¡£â€œ<a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative-aspectj\">Using @Transactional with AspectJ</a>â€è¯•è¯•å‘¢ï¼Ÿæ³¨æ„ï¼šAspectJé…åˆlombokä½¿ç”¨ï¼Œè¿˜å¯èƒ½ä¼šè¸©ä¸€äº›å‘ã€‚</p><p>ç­”ï¼šæˆ‘ä»¬éœ€è¦åŠ å…¥aspectjçš„ä¾èµ–å’Œé…ç½®aspectj-maven-pluginæ’ä»¶ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®Springå¼€å¯AspectJäº‹åŠ¡ç®¡ç†æ¨¡å¼ã€‚å…·ä½“çš„å®ç°æ–¹å¼ï¼ŒåŒ…æ‹¬å¦‚ä¸‹4æ­¥ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œå¼•å…¥spring-aspectsä¾èµ–ï¼š</p><pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.springframework&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre><p>ç¬¬äºŒæ­¥ï¼ŒåŠ å…¥lombokå’Œaspectjæ’ä»¶ï¼š</p><pre><code>&lt;plugin&gt;\n    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n    &lt;artifactId&gt;lombok-maven-plugin&lt;/artifactId&gt;\n    &lt;version&gt;1.18.0.0&lt;/version&gt;\n    &lt;executions&gt;\n        &lt;execution&gt;\n            &lt;phase&gt;generate-sources&lt;/phase&gt;\n            &lt;goals&gt;\n                &lt;goal&gt;delombok&lt;/goal&gt;\n            &lt;/goals&gt;\n        &lt;/execution&gt;\n    &lt;/executions&gt;\n    &lt;configuration&gt;\n        &lt;addOutputDirectory&gt;false&lt;/addOutputDirectory&gt;\n        &lt;sourceDirectory&gt;src/main/java&lt;/sourceDirectory&gt;\n    &lt;/configuration&gt;\n&lt;/plugin&gt;\n&lt;plugin&gt;\n    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;\n    &lt;artifactId&gt;aspectj-maven-plugin&lt;/artifactId&gt;\n    &lt;version&gt;1.10&lt;/version&gt;\n    &lt;configuration&gt;\n        &lt;complianceLevel&gt;1.8&lt;/complianceLevel&gt;\n        &lt;source&gt;1.8&lt;/source&gt;\n        &lt;aspectLibraries&gt;\n            &lt;aspectLibrary&gt;\n                &lt;groupId&gt;org.springframework&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;\n            &lt;/aspectLibrary&gt;\n        &lt;/aspectLibraries&gt;\n    &lt;/configuration&gt;\n    &lt;executions&gt;\n        &lt;execution&gt;\n            &lt;goals&gt;\n                &lt;goal&gt;compile&lt;/goal&gt;\n                &lt;goal&gt;test-compile&lt;/goal&gt;\n            &lt;/goals&gt;\n        &lt;/execution&gt;\n    &lt;/executions&gt;\n&lt;/plugin&gt;\n</code></pre><p>ä½¿ç”¨delombokæ’ä»¶çš„ç›®çš„æ˜¯ï¼ŒæŠŠä»£ç ä¸­çš„Lombokæ³¨è§£å…ˆç¼–è¯‘ä¸ºä»£ç ï¼Œè¿™æ ·AspectJç¼–è¯‘ä¸ä¼šæœ‰é—®é¢˜ï¼ŒåŒæ—¶éœ€è¦è®¾ç½®<build>ä¸­çš„sourceDirectoryä¸ºdelombokç›®å½•ï¼š</build></p><pre><code>&lt;sourceDirectory&gt;${project.build.directory}/generated-sources/delombok&lt;/sourceDirectory&gt;\n</code></pre><p>ç¬¬ä¸‰æ­¥ï¼Œè®¾ç½®@EnableTransactionManagementæ³¨è§£ï¼Œå¼€å¯äº‹åŠ¡ç®¡ç†èµ°AspectJæ¨¡å¼ï¼š</p><pre><code>@SpringBootApplication\n@EnableTransactionManagement(mode = AdviceMode.ASPECTJ)\npublic class CommonMistakesApplication {\n</code></pre><p>ç¬¬å››æ­¥ï¼Œä½¿ç”¨Mavenç¼–è¯‘é¡¹ç›®ï¼Œç¼–è¯‘åæŸ¥çœ‹createUserPrivateæ–¹æ³•çš„æºç ï¼Œå¯ä»¥å‘ç°AspectJå¸®æˆ‘ä»¬åšç¼–è¯‘æ—¶ç»‡å…¥ï¼ˆCompile Time Weavingï¼‰ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/11/1d/11da9146b324e47fcd96631d47db961d.png?wh=3184*1204\" alt=\"\"></p><p>è¿è¡Œç¨‹åºï¼Œè§‚å¯Ÿæ—¥å¿—å¯ä»¥å‘ç°createUserPrivateï¼ˆç§æœ‰ï¼‰æ–¹æ³•åŒæ ·åº”ç”¨äº†äº‹åŠ¡ï¼Œå‡ºå¼‚å¸¸åäº‹åŠ¡å›æ»šï¼š</p><pre><code>[14:21:39.155] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:370 ] - Creating new transaction with name [org.geekbang.time.commonmistakes.transaction.transactionproxyfailed.UserService.createUserPrivate]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT\n[14:21:39.155] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:393 ] - Opened new EntityManager [SessionImpl(1087443072&lt;open&gt;)] for JPA transaction\n[14:21:39.158] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:421 ] - Exposing JPA transaction as JDBC [org.springframework.orm.jpa.vendor.HibernateJpaDialect$HibernateConnectionHandle@4e16e6ea]\n[14:21:39.159] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:356 ] - Found thread-bound EntityManager [SessionImpl(1087443072&lt;open&gt;)] for JPA transaction\n[14:21:39.159] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:471 ] - Participating in existing transaction\n[14:21:39.173] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:834 ] - Initiating transaction rollback\n[14:21:39.173] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:555 ] - Rolling back JPA transaction on EntityManager [SessionImpl(1087443072&lt;open&gt;)]\n[14:21:39.176] [http-nio-45678-exec-2] [DEBUG] [o.s.orm.jpa.JpaTransactionManager:620 ] - Closing JPA EntityManager [SessionImpl(1087443072&lt;open&gt;)] after transaction\n[14:21:39.176] [http-nio-45678-exec-2] [ERROR] [o.g.t.c.t.t.UserService:28  ] - create user failed because invalid username!\n[14:21:39.177] [http-nio-45678-exec-2] [DEBUG] [o.s.o.j.SharedEntityManagerCreator$SharedEntityManagerInvocationHandler:305 ] - Creating new EntityManager for shared EntityManager invocation\n</code></pre><p>ä»¥ä¸Šï¼Œå°±æ˜¯å’±ä»¬è¿™é—¨è¯¾å‰6è®²çš„æ€è€ƒé¢˜ç­”æ¡ˆäº†ã€‚</p><p>å…³äºè¿™äº›é¢˜ç›®ï¼Œä»¥åŠèƒŒåæ¶‰åŠçš„çŸ¥è¯†ç‚¹ï¼Œå¦‚æœä½ è¿˜æœ‰å“ªé‡Œæ„Ÿè§‰ä¸æ¸…æ¥šçš„ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºä¸æˆ‘ç•™è¨€ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹æˆ–åŒäº‹ï¼Œä¸€èµ·äº¤æµã€‚</p>","comments":[{"had_liked":false,"id":234454,"user_name":"Darren","can_delete":false,"product_type":"c1","uid":1254968,"ip_address":"","ucode":"CCD2B2C492BE9A","user_header":"https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg","comment_is_top":false,"comment_ctime":1594695062,"is_pvip":true,"replies":[{"id":"86514","content":"èµ","user_name":"ä½œè€…å›å¤","comment_id":234454,"uid":"1001470","ip_address":"","utype":1,"ctime":1594701009,"user_name_real":"æœ±æ™”"}],"discussion_count":3,"race_medal":0,"score":"139033648534","product_id":100047701,"comment_content":"è€å¸ˆçš„ç­”ç–‘æ–‡ç« çœŸçš„æ˜¯è¶…çº§æ£’ï¼›çœ‹åˆ°äº‹åŠ¡ä¼ æ’­ç‰¹æ€§ï¼Œçªç„¶è§‰å¾—å¥½é™Œç”Ÿï¼Œå¥½ä¹…æ²¡æœ‰å…³æ³¨äº†ï¼Œå†æ¬¡ç†Ÿæ‚‰äº†ä¸‹ğŸ˜‚ï¼Œç®€å•çš„æ€»ç»“ä¸‹ï¼š<br><br>é¦–å…ˆä¸¾ä¸ªå¯èƒ½ä¸æ˜¯å¾ˆé€‚åˆçš„ä¾‹å­è§£é‡Šä¸‹ä¿å­˜ç‚¹ï¼šæ¯”å¦‚é“¶è¡Œè½¬è´¦å‘é€çŸ­ä¿¡ä¸šåŠ¡ï¼ˆåœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼‰ï¼›å¯ä»¥ç®€å•çš„ç†è§£ä¸ºè½¬è´¦å’Œå‘é€çŸ­ä¿¡ä¸¤ä¸ªä¸šåŠ¡ï¼Œå¦‚æœæ²¡æœ‰ä¿å­˜ç‚¹çš„è¯ï¼Œå‘é€çŸ­ä¿¡å¤±è´¥äº†ï¼Œè½¬è´¦ä¸šåŠ¡ä¹Ÿéœ€è¦å›æ»šï¼Œæƒ³æƒ³æ˜¯ä¸æ˜¯å¾ˆææ€–ï¼Œä½†æ˜¯å¦‚æœæœ‰äº†ä¿å­˜ç‚¹çš„æ¦‚å¿µï¼Œå°±å¯ä»¥åªéœ€è¦å›æ»šåˆ°ä¸Šä¸€ä¸ªä¿å­˜ç‚¹å³å¯ï¼Œæ— éœ€å›æ»šæ•´ä¸ªäº‹åŠ¡ï¼›æ‰€ä»¥åœ¨ä¸Šé¢çš„åœºæ™¯ä¸­ï¼Œè™½ç„¶è½¬è´¦å’Œå‘é€çŸ­ä¿¡åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œä½†æ˜¯è½¬è´¦ç»“æŸåï¼Œå¯ä»¥å¢åŠ ä¿å­˜ç‚¹ï¼Œå³ä½¿å‘é€çŸ­ä¿¡å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå½±å“è½¬è´¦ä¸šåŠ¡ã€‚<br><br>Spring ä¸­å°±æ˜¯é‡‡ç”¨ä¿å­˜ç‚¹(Savepoint)å®ç°åµŒå¥—ï¼ˆNESTEDï¼‰äº‹åŠ¡åŸç†ï¼ŒSpringå®˜æ–¹æ–‡æ¡£æè¿°å¦‚ä¸‹ï¼š<br>PROPAGATION_NESTED uses a single physical transaction with multiple savepoints that it can roll back to. Such partial rollbacks let an inner transaction scope trigger a rollback for its scope, with the outer transaction being able to continue the physical transaction despite some operations having been rolled back. This setting is typically mapped onto JDBC savepoints, so it works only with JDBC resource transactions. See Springâ€™s DataSourceTransactionManager.<br><br>NESTEDå’ŒREQUIREDä¿®é¥°çš„å†…éƒ¨æ–¹æ³•éƒ½å±äºå¤–å›´æ–¹æ³•äº‹åŠ¡ï¼Œå¦‚æœå¤–å›´æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„äº‹åŠ¡éƒ½ä¼šè¢«å›æ»šã€‚ä½†æ˜¯REQUIREDæ˜¯åŠ å…¥å¤–å›´æ–¹æ³•äº‹åŠ¡ï¼Œæ‰€ä»¥å’Œå¤–å›´äº‹åŠ¡åŒå±äºä¸€ä¸ªäº‹åŠ¡ï¼Œä¸€æ—¦REQUIREDäº‹åŠ¡æŠ›å‡ºå¼‚å¸¸è¢«å›æ»šï¼Œå¤–å›´æ–¹æ³•äº‹åŠ¡ä¹Ÿå°†è¢«å›æ»šã€‚è€ŒNESTEDæ˜¯å¤–å›´æ–¹æ³•çš„å­äº‹åŠ¡ï¼Œæœ‰å•ç‹¬çš„ä¿å­˜ç‚¹ï¼Œæ‰€ä»¥NESTEDæ–¹æ³•æŠ›å‡ºå¼‚å¸¸è¢«å›æ»šï¼Œä¸ä¼šå½±å“åˆ°å¤–å›´æ–¹æ³•çš„äº‹åŠ¡ã€‚<br><br>NESTEDå’ŒREQUIRES_NEWéƒ½å¯ä»¥åšåˆ°å†…éƒ¨æ–¹æ³•äº‹åŠ¡å›æ»šè€Œä¸å½±å“å¤–å›´æ–¹æ³•äº‹åŠ¡ã€‚ä½†æ˜¯å› ä¸ºNESTEDæ˜¯åµŒå¥—äº‹åŠ¡ï¼Œæ‰€ä»¥å¤–å›´æ–¹æ³•å›æ»šä¹‹åï¼Œä½œä¸ºå¤–å›´æ–¹æ³•äº‹åŠ¡çš„å­äº‹åŠ¡ä¹Ÿä¼šè¢«å›æ»šã€‚è€ŒREQUIRES_NEWæ˜¯é€šè¿‡å¼€å¯æ–°çš„äº‹åŠ¡å®ç°çš„ï¼Œå†…éƒ¨äº‹åŠ¡å’Œå¤–å›´äº‹åŠ¡æ˜¯ä¸¤ä¸ªäº‹åŠ¡ï¼Œå¤–å›´äº‹åŠ¡å›æ»šä¸ä¼šå½±å“å†…éƒ¨äº‹åŠ¡ã€‚<br>","like_count":32,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501395,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594701009,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2357964,"avatar":"https://static001.geekbang.org/account/avatar/00/23/fa/cc/d4b3ce87.jpg","nickname":"ç§ƒå¦‚å…¶æ¥","note":"","ucode":"9130CE773F31B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550656,"discussion_content":"å­¦åˆ°äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644657943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":293163,"discussion_content":"æ€»ç»“çš„å¾ˆè¯¦ç»†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595467136,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":235571,"user_name":"kyl","can_delete":false,"product_type":"c1","uid":1406090,"ip_address":"","ucode":"DBDFD0FEB5A135","user_header":"https://static001.geekbang.org/account/avatar/00/15/74/8a/d5b0cf30.jpg","comment_is_top":false,"comment_ctime":1595088568,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"27364892344","product_id":100047701,"comment_content":"æœ±è€å¸ˆçš„è¯¾ç¨‹ä¸è¦å¤ªæ£’ğŸ‘","like_count":6},{"had_liked":false,"id":259506,"user_name":"é›¨åæ™´å¤©","can_delete":false,"product_type":"c1","uid":2154820,"ip_address":"","ucode":"6A0D13AC5DFB3A","user_header":"https://static001.geekbang.org/account/avatar/00/20/e1/44/8f26fe96.jpg","comment_is_top":false,"comment_ctime":1604737855,"is_pvip":false,"replies":[{"id":"94341","content":"ä¸æ˜¯åŒä¸€ä¸ªé‡è½½æ–¹æ³•","user_name":"ä½œè€…å›å¤","comment_id":259506,"uid":"1001470","ip_address":"","utype":1,"ctime":1604792834,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"10194672447","product_id":100047701,"comment_content":"è€å¸ˆï¼Œè‡ªå®šä¹‰æ¿€è¿›çš„çº¿ç¨‹æ± ï¼Œåœ¨è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°åé€šè¿‡æ‹’ç»ç­–ç•¥å†™é˜Ÿåˆ—ï¼Œexecutor.getQueue().offer()æ‰§è¡Œåä¸æ˜¯ç›´æ¥è¿”å›falseå—ï¼Ÿè¿˜èƒ½å†™å¾—è¿›å»å—","like_count":2,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508948,"discussion_content":"ä¸æ˜¯åŒä¸€ä¸ªé‡è½½æ–¹æ³•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604792834,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":257159,"user_name":"LGY001","can_delete":false,"product_type":"c1","uid":1188176,"ip_address":"","ucode":"29CA0F9501D3EC","user_header":"https://static001.geekbang.org/account/avatar/00/12/21/50/265671fd.jpg","comment_is_top":false,"comment_ctime":1603867218,"is_pvip":false,"replies":[{"id":"93818","content":"å¦‚æœè§‰å¾—å¥½å¤šåˆ†äº«ç»™èº«è¾¹æœ‹å‹","user_name":"ä½œè€…å›å¤","comment_id":257159,"uid":"1001470","ip_address":"","utype":1,"ctime":1604054457,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"10193801810","product_id":100047701,"comment_content":"æœ±è€å¸ˆçš„è¯¾ç¨‹çœŸçš„å¥½ï¼Œå¾ˆæ—©å°±ä¹°äº†è¯¾ä½†æ˜¯ä¸€ç›´æ²¡æœ‰æ²‰ä¸‹å¿ƒå»çœ‹ï¼Œæœ€è¿‘é€šå‹¤çš„æ—¶å€™å¬äº†å‡ ç¯‡ï¼Œå¬åˆ°æœ±è€å¸ˆæ–‡ç« æ—¶å€™æ„Ÿè§‰å¾ˆæƒŠè‰³ï¼Œä¸‹ç­äº†èµ¶ç´§ä»”ç»†é˜…è¯»å‘ç°èƒ½ä»ä¸­æ”¶è·åˆ°éœ€è¦çŸ¥è¯†ï¼Œéå¸¸æ„Ÿè°¢æœ±è€å¸ˆçš„åˆ†äº«ï¼ï¼ï¼","like_count":2,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508238,"discussion_content":"å¦‚æœè§‰å¾—å¥½å¤šåˆ†äº«ç»™èº«è¾¹æœ‹å‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1604054457,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":314420,"user_name":"é¥­ç²’","can_delete":false,"product_type":"c1","uid":1153455,"ip_address":"","ucode":"4C3220B0D43997","user_header":"https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg","comment_is_top":false,"comment_ctime":1633016202,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5927983498","product_id":100047701,"comment_content":"ä¸»è¯¾ï¼Œä»£ç ï¼Œç­”ç–‘åšçš„éƒ½å¤ªåˆ°ä½äº†ã€‚","like_count":1},{"had_liked":false,"id":234652,"user_name":"æé±¼çš„æ¬ç –å¥‡","can_delete":false,"product_type":"c1","uid":1021539,"ip_address":"","ucode":"2FD194C4DA26E5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/96/63/7eb32c9b.jpg","comment_is_top":false,"comment_ctime":1594741750,"is_pvip":false,"replies":[{"id":"86624","content":"pomé‡Œçš„mainclassæ‰“åŒ…ç”¨ï¼Œç›´æ¥è¿è¡Œmainæ–¹æ³•å³å¯ï¼Œspringbootç¨‹åº","user_name":"ä½œè€…å›å¤","comment_id":234652,"uid":"1001470","ip_address":"","utype":1,"ctime":1594783893,"user_name_real":"æœ±æ™”"}],"discussion_count":2,"race_medal":0,"score":"5889709046","product_id":100047701,"comment_content":"è€å®æ–¹ä¾¿è¯´ä¸‹è¯¾ç¨‹ä»£ç æ€ä¹ˆè¿è¡Œä¹ˆï¼Œè¦å»è°ƒæ•´ POM é‡Œçš„ main class é…ç½®å˜›","like_count":1,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501449,"discussion_content":"pomé‡Œçš„mainclassæ‰“åŒ…ç”¨ï¼Œç›´æ¥è¿è¡Œmainæ–¹æ³•å³å¯ï¼Œspringbootç¨‹åº","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594783893,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1021539,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/96/63/7eb32c9b.jpg","nickname":"æé±¼çš„æ¬ç –å¥‡","note":"","ucode":"2FD194C4DA26E5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":291344,"discussion_content":"å“¦ å¥½çš„ ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594785290,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":234431,"user_name":"Bug? Feature!","can_delete":false,"product_type":"c1","uid":1164531,"ip_address":"","ucode":"F8FA8A0094FBA0","user_header":"https://static001.geekbang.org/account/avatar/00/11/c4/f3/92f654f1.jpg","comment_is_top":false,"comment_ctime":1594691782,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5889659078","product_id":100047701,"comment_content":"Mark!","like_count":1},{"had_liked":false,"id":359866,"user_name":"Geek_f7adad","can_delete":false,"product_type":"c1","uid":3201890,"ip_address":"å±±ä¸œ","ucode":"A58D96E649ABC8","user_header":"","comment_is_top":false,"comment_ctime":1665999181,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665999181","product_id":100047701,"comment_content":"è¿™ä¸ªä¸æ˜¯è§†é¢‘æ•™å­¦ä¹ˆï¼Œæ˜¯éŸ³é¢‘ï¼Ÿï¼Ÿ","like_count":0},{"had_liked":false,"id":359046,"user_name":"å…¨éº¦å°é¢åŒ…","can_delete":false,"product_type":"c1","uid":1086413,"ip_address":"ä¸Šæµ·","ucode":"823C65BF366097","user_header":"https://static001.geekbang.org/account/avatar/00/10/93/cd/dbafc7d1.jpg","comment_is_top":false,"comment_ctime":1665199136,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1665199136","product_id":100047701,"comment_content":"çˆ±ä½ ~","like_count":0},{"had_liked":false,"id":356737,"user_name":"åœ¨é›¨ä¸­","can_delete":false,"product_type":"c1","uid":1188220,"ip_address":"æ±Ÿè¥¿","ucode":"C4A0B725C8A009","user_header":"https://static001.geekbang.org/account/avatar/00/12/21/7c/940627a7.jpg","comment_is_top":false,"comment_ctime":1662540787,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1662540787","product_id":100047701,"comment_content":"å¼ºçš„ä¸€ç¬”ï¼Œåˆå¯ä»¥æ„‰å¿«åœ°è£…å‘—äº†","like_count":0},{"had_liked":false,"id":347538,"user_name":"Geek_8b92bf","can_delete":false,"product_type":"c1","uid":2573588,"ip_address":"","ucode":"0EED09DA79D171","user_header":"","comment_is_top":false,"comment_ctime":1654137345,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654137345","product_id":100047701,"comment_content":"volatileå…³é”®å­—åº”è¯¥åªæ˜¯è®©cpuç¼“å­˜å¤±æ•ˆçš„æ„æ€å§ã€‚ä¸åŠ volatileå…³é”®å­—ï¼Œæ•°æ®åº”è¯¥ä¹Ÿå†™å›äº†ä¸»å†…å­˜ã€‚è­¬å¦‚è¿‡äº†å‡ åˆ†é’Ÿï¼Œå¦å¤–æœ‰ä¸€ä¸ªçº¿ç¨‹è¯»å–è¯¥å˜é‡ï¼Œåº”è¯¥æ˜¯ä»ä¸»å†…å­˜ä¸­è¯»åˆ°æœ€æ–°çš„å€¼ã€‚<br>---è™½ç„¶å¦ä¸€ä¸ªçº¿ç¨‹æŠŠ b è®¾ç½®ä¸ºäº† falseï¼Œä½†æ˜¯è¿™ä¸ªå­—æ®µåœ¨ CPU ç¼“å­˜ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰è¿˜æ˜¯è¯»ä¸åˆ°æœ€æ–°çš„å€¼ã€‚ä½¿ç”¨ volatile å…³é”®å­—ï¼Œå¯ä»¥è®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚å‡†ç¡®æ¥è¯´ï¼Œè®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»æ˜¯ä¸¤ä»¶äº‹æƒ…ï¼šå°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®ï¼Œå†™å›åˆ°ç³»ç»Ÿå†…å­˜ï¼›è¿™ä¸ªå†™å›å†…å­˜çš„æ“ä½œä¼šå¯¼è‡´å…¶ä»– CPU é‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®å˜ä¸ºæ— æ•ˆã€‚","like_count":0},{"had_liked":false,"id":347537,"user_name":"Geek_8b92bf","can_delete":false,"product_type":"c1","uid":2573588,"ip_address":"","ucode":"0EED09DA79D171","user_header":"","comment_is_top":false,"comment_ctime":1654137141,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654137141","product_id":100047701,"comment_content":"è™½ç„¶å¦ä¸€ä¸ªçº¿ç¨‹æŠŠ b è®¾ç½®ä¸ºäº† falseï¼Œä½†æ˜¯è¿™ä¸ªå­—æ®µåœ¨ CPU ç¼“å­˜ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰è¿˜æ˜¯è¯»ä¸åˆ°æœ€æ–°çš„å€¼ã€‚ä½¿ç”¨ volatile å…³é”®å­—ï¼Œå¯ä»¥è®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚å‡†ç¡®æ¥è¯´ï¼Œè®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»æ˜¯ä¸¤ä»¶äº‹æƒ…ï¼šå°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®ï¼Œå†™å›åˆ°ç³»ç»Ÿå†…å­˜ï¼›è¿™ä¸ªå†™å›å†…å­˜çš„æ“ä½œä¼šå¯¼è‡´å…¶ä»– CPU é‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®å˜ä¸ºæ— æ•ˆã€‚","like_count":0},{"had_liked":false,"id":339785,"user_name":"luke Y","can_delete":false,"product_type":"c1","uid":2311463,"ip_address":"","ucode":"111F98D367235B","user_header":"https://static001.geekbang.org/account/avatar/00/23/45/27/4fbf8f6a.jpg","comment_is_top":false,"comment_ctime":1648379751,"is_pvip":true,"replies":[{"id":"124254","content":"å¹¶ä¸èƒ½è¿™ä¹ˆç†è§£","user_name":"ä½œè€…å›å¤","comment_id":339785,"uid":"1001470","ip_address":"","utype":1,"ctime":1648446304,"user_name_real":"ç¼–è¾‘"}],"discussion_count":2,"race_medal":0,"score":"1648379751","product_id":100047701,"comment_content":"&quot;è™½ç„¶å¦ä¸€ä¸ªçº¿ç¨‹æŠŠ b è®¾ç½®ä¸ºäº† falseï¼Œä½†æ˜¯è¿™ä¸ªå­—æ®µåœ¨ CPU ç¼“å­˜ä¸­ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰è¿˜æ˜¯è¯»ä¸åˆ°æœ€æ–°çš„å€¼ã€‚ä½¿ç”¨ volatile å…³é”®å­—ï¼Œå¯ä»¥è®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚å‡†ç¡®æ¥è¯´ï¼Œè®©æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»æ˜¯ä¸¤ä»¶äº‹.....&quot;<br><br>è€å¸ˆæˆ‘æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯å•æ ¸cpué‚£ä¹ˆæ˜¯ä¸æ˜¯å°±æ²¡æœ‰ æ–‡ä¸­çš„å¯è§æ€§é—®é¢˜äº†","like_count":0,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":558739,"discussion_content":"å¹¶ä¸èƒ½è¿™ä¹ˆç†è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1648446305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1541263,"avatar":"https://static001.geekbang.org/account/avatar/00/17/84/8f/a305cc1e.jpg","nickname":"otakuhuang","note":"","ucode":"283641975339AD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572600,"discussion_content":"çº¿ç¨‹çš„ b æ˜¯çº¿ç¨‹çš„ bï¼Œä¸»å­˜çš„ b æ˜¯ä¸»å­˜çš„ bã€‚å¦‚æœæ²¡æœ‰ volatileï¼Œä¸€ä¸ªçº¿ç¨‹æ”¹å˜äº† bï¼Œåªæ˜¯æ”¹å˜äº†å®ƒè‡ªå·±çš„ bï¼Œå¹¶æ²¡æœ‰æŠŠè¿™ä¸ª b çš„å€¼èµ‹å€¼ç»™ä¸»å­˜çš„ bï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹åˆ°ä¸»å­˜é‡Œæ‹¿è¿™ä¸ª bï¼Œåªèƒ½æ‹¿åˆ°æœ€å¼€å§‹çš„å€¼ã€‚åº”è¯¥å¯ä»¥è¿™æ ·ç†è§£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652866906,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":297534,"user_name":"shawn","can_delete":false,"product_type":"c1","uid":1297169,"ip_address":"","ucode":"277F74CF1201BF","user_header":"https://static001.geekbang.org/account/avatar/00/13/cb/11/3733b781.jpg","comment_is_top":false,"comment_ctime":1623602533,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1623602533","product_id":100047701,"comment_content":"å¾ˆæœ‰ç”¨,ç†è§£äº†,æ„Ÿè°¢","like_count":0},{"had_liked":false,"id":275323,"user_name":"xmeng","can_delete":false,"product_type":"c1","uid":1731543,"ip_address":"","ucode":"C0CA2182BA3B4B","user_header":"https://static001.geekbang.org/account/avatar/00/1a/6b/d7/8872624a.jpg","comment_is_top":false,"comment_ctime":1611471996,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1611471996","product_id":100047701,"comment_content":"èµèµèµ","like_count":0},{"had_liked":false,"id":271624,"user_name":"æ‚Ÿç©ºWuKong","can_delete":false,"product_type":"c1","uid":1139455,"ip_address":"","ucode":"49AFD2B048C1BA","user_header":"https://static001.geekbang.org/account/avatar/00/11/62/ff/f71034e9.jpg","comment_is_top":false,"comment_ctime":1609740700,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1609740700","product_id":100047701,"comment_content":"æˆåŠŸå®‰åˆ©ä¸€ååŒäº‹è´­ä¹°è¿™ä¸ªè¯¾","like_count":0},{"had_liked":false,"id":266315,"user_name":"terryking","can_delete":false,"product_type":"c1","uid":1012371,"ip_address":"","ucode":"39433F06D6BEF6","user_header":"https://static001.geekbang.org/account/avatar/00/0f/72/93/46895883.jpg","comment_is_top":false,"comment_ctime":1607301213,"is_pvip":false,"replies":[{"id":"96742","content":"ç‹¬ç«‹ç¼“å†²åŒºï¼Œç½‘ç»œã€osã€åº”ç”¨å±‚æ•°æ®æµè½¬è¿‡ç¨‹ï¼Œè¯¦ç»†çœ‹ä¸‹Understanding Linux Network Internalsä¸€ä¹¦","user_name":"ä½œè€…å›å¤","comment_id":266315,"uid":"1001470","ip_address":"","utype":1,"ctime":1607313682,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"1607301213","product_id":100047701,"comment_content":"è€å¸ˆï¼Œé—®ä¸€ä¸‹ï¼Œå¯¹äºsocketçš„å‘é€ç¼“å†²åŒºæ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªsocketéƒ½æ˜¯ç‹¬ç«‹çš„ä¸€ä»½ç¼“å†²åŒºè¿˜æ˜¯å…¨å±€tcpåè®®å°±ä¸€ä¸ªå‘¢ï¼Ÿå¦‚æœæ˜¯ç‹¬ç«‹çš„ä¸€ä»½é‚£ç½‘å¡é©±åŠ¨åˆæ˜¯æ€ä¹ˆæ‰¾è¿™äº›ç¼“å†²åŒºçš„å‘¢ï¼Ÿä¼˜å…ˆçº§åˆæ˜¯æ€æ ·çš„ï¼Ÿå¦‚æœæ˜¯å…¨å±€ä¸€ä»½ï¼Œé‚£å¯¹äºæ²¡æœ‰æ”¶åˆ°ackçš„æ¶ˆæ¯æ˜¯ä¼šä¸€ç›´é˜»å¡å‘ç½‘ç»œä¸­å‘é€æ•°æ®ï¼Œç›´åˆ°æŸä¸€ä¸ªå®¢æˆ·ç«¯çš„ackè¿”å›ä¹ˆï¼Ÿè°¢è°¢è€å¸ˆï¼Œéº»çƒ¦æœ‰æ—¶é—´å›å¤ä¸€ä¸‹","like_count":0,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":511207,"discussion_content":"ç‹¬ç«‹ç¼“å†²åŒºï¼Œç½‘ç»œã€osã€åº”ç”¨å±‚æ•°æ®æµè½¬è¿‡ç¨‹ï¼Œè¯¦ç»†çœ‹ä¸‹Understanding Linux Network Internalsä¸€ä¹¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1607313682,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259539,"user_name":"WangBo","can_delete":false,"product_type":"c1","uid":1080812,"ip_address":"","ucode":"8BFCC4E2639175","user_header":"https://static001.geekbang.org/account/avatar/00/10/7d/ec/ccd30c1d.jpg","comment_is_top":false,"comment_ctime":1604748287,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1604748287","product_id":100047701,"comment_content":"è€å¸ˆï¼Œé—®é¢˜3çš„ç­”æ¡ˆä»£ç ä¸­ï¼Œåœ¨è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥ä¸­ï¼Œä½¿ç”¨äº†queue.put(r) æ–¹æ³•ï¼Œputæ–¹æ³•ä¼šä¸€ç›´é˜»å¡ã€‚å¦‚æœä¸æƒ³è¢«é˜»å¡ï¼Œå¸Œæœ›å®ç° å¦‚æœé˜Ÿåˆ—æ»¡äº†å°±æŠ›å‡ºå¼‚å¸¸ï¼Œé˜Ÿåˆ—ä¸æ»¡å°±æ”¾å…¥ä»»åŠ¡ï¼Œæ€ä¹ˆå®ç°å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":257170,"user_name":"LGY001","can_delete":false,"product_type":"c1","uid":1188176,"ip_address":"","ucode":"29CA0F9501D3EC","user_header":"https://static001.geekbang.org/account/avatar/00/12/21/50/265671fd.jpg","comment_is_top":false,"comment_ctime":1603871009,"is_pvip":false,"replies":[{"id":"93716","content":"pom é‡Œé¢é…ç½®","user_name":"ä½œè€…å›å¤","comment_id":257170,"uid":"1001470","ip_address":"","utype":1,"ctime":1603969103,"user_name_real":"æœ±æ™”"}],"discussion_count":1,"race_medal":0,"score":"1603871009","product_id":100047701,"comment_content":"æœ±è€å¸ˆï¼Œæˆ‘æƒ³é—®ä¸€ä¸‹ç¬¬å…­ç¯‡çš„ç¬¬äºŒä¸ªé—®é¢˜ç­”ç–‘ä¸­çš„Aspectjä¸lombokæ’ä»¶å†²çªè§£å†³çš„ç›¸å…³é—®é¢˜ï¼Œâ€œè¿™æ · AspectJ ç¼–è¯‘ä¸ä¼šæœ‰é—®é¢˜ï¼ŒåŒæ—¶éœ€è¦è®¾ç½®ä¸­çš„ sourceDirectory ä¸º delombok ç›®å½• ï¼š<br>&lt;sourceDirectory&gt;${project.build.directory}&#47;generated-sources&#47;delombok&lt;&#47;sourceDirectory&gt;â€ï¼Œæ‚¨æ–‡ç« ä¸­çš„è¿™å¥è¯ä»€ä¹ˆæ„æ€ï¼Œç›¸å…³é…ç½®é¡¹åº”è¯¥åœ¨å“ªé‡Œé…ç½®å‘¢ï¼Ÿå¸Œæœ›è€å¸ˆå¯ä»¥è§£ç­”ä¸€ä¸‹","like_count":0,"discussions":[{"author":{"id":1001470,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/fe/d0e25d57.jpg","nickname":"æœ±æ™”","note":"","ucode":"0B7F0BADE6AAB8","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":508242,"discussion_content":"pom é‡Œé¢é…ç½®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603969103,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":246711,"user_name":"å‘åšå£«åè¿›å†›","can_delete":false,"product_type":"c1","uid":1903452,"ip_address":"","ucode":"CFDC3CF31C582D","user_header":"https://static001.geekbang.org/account/avatar/00/1d/0b/5c/9734702d.jpg","comment_is_top":false,"comment_ctime":1599459576,"is_pvip":false,"replies":[{"id":"90668","content":"æˆ‘å†™äº†ä¸€æ®µä»£ç æ¥è¯æ˜è¿™ä¸‰ç‚¹ï¼Œä½ å¯ä»¥ç‚¹å‡»è¿™é‡Œçš„ GitHub é“¾æ¥æŸ¥çœ‹ã€‚ã€‚ã€‚","user_name":"ä½œè€…å›å¤","comment_id":246711,"uid":"1001470","ip_address":"","utype":1,"ctime":1599474583,"user_name_real":"æœ±æ™”"}],"discussion_count":0,"race_medal":0,"score":"1599459576","product_id":100047701,"comment_content":"æ²¡çœ‹æ‡‚computeIfAbsentï¼ŒputIfAbsentçš„åŒºåˆ«å‘¢","like_count":0},{"had_liked":false,"id":244910,"user_name":"æå°å¹³","can_delete":false,"product_type":"c1","uid":1435672,"ip_address":"","ucode":"397F7E802D1C0F","user_header":"","comment_is_top":false,"comment_ctime":1598749449,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1598749449","product_id":100047701,"comment_content":"03 | çº¿ç¨‹æ± ï¼šä¸šåŠ¡ä»£ç æœ€å¸¸ç”¨ä¹Ÿæœ€å®¹æ˜“çŠ¯é”™çš„ç»„ä»¶<br>é—®é¢˜ 1<br>  TimeUnit.SECONDS.sleep(60); <br>  æ”¹æˆï¼š<br>  threadPool.close();<br>  threadPool.awaitTermination(60, TimeUnit.SECONDS);<br><br>æ„Ÿè§‰ä¸»åŠ¨å…³é—­çº¿ç¨‹æ± æ¯”è¾ƒå¥½ã€‚","like_count":0},{"had_liked":false,"id":242395,"user_name":"æ¢µé«˜","can_delete":false,"product_type":"c1","uid":1360741,"ip_address":"","ucode":"E2E07B78382395","user_header":"https://static001.geekbang.org/account/avatar/00/14/c3/65/b5f8581d.jpg","comment_is_top":false,"comment_ctime":1597712370,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1597712370","product_id":100047701,"comment_content":"è€å¸ˆï¼Œä½ å¥½ã€‚é”æ—¶é—´è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œé™¤äº†æ–‡ä¸­è®²çš„ç»­æœŸï¼Œè¿˜æœ‰æ²¡æœ‰åˆ«çš„æ–¹æ³•ï¼Ÿ","like_count":0},{"had_liked":false,"id":238663,"user_name":"æé±¼çš„æ¬ç –å¥‡","can_delete":false,"product_type":"c1","uid":1021539,"ip_address":"","ucode":"2FD194C4DA26E5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/96/63/7eb32c9b.jpg","comment_is_top":false,"comment_ctime":1596252719,"is_pvip":false,"discussion_count":4,"race_medal":0,"score":"1596252719","product_id":100047701,"comment_content":"â€œvalue çš„è·å–æ¯”è¾ƒæ˜‚è´µâ€ è¿™é‡Œçš„æ˜‚è´µè¦æ€ä¹ˆç†è§£å‘¢","like_count":0,"discussions":[{"author":{"id":1604468,"avatar":"https://static001.geekbang.org/account/avatar/00/18/7b/74/9b88e040.jpg","nickname":"æŸæ²¹","note":"","ucode":"92BFEEEE8BBFA0","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":303469,"discussion_content":"ä¿©æ–¹æ³•éƒ½æ˜¯åœ¨å€¼ç¼ºçœçš„æ—¶å€™æ‰æ·»åŠ ï¼ŒputIfAbsentå°±æ˜¯ä¸ç®¡å€¼æ˜¯å¦ç¼ºçœéƒ½è¦å…ˆè·å–å€¼ï¼Œæ‰€ä»¥å¯èƒ½ä¼šæµªè´¹è¿™ä¹ˆä¸€ä¸ªæ“ä½œï¼Œå°¤å…¶æ˜¯å½“è¿™ä¸ªå€¼éœ€è¦å¾ˆé•¿æ—¶é—´èŠ±è´¹çš„æƒ…å†µä¸‹ã€‚åä¹‹computeIfAbsentä¼ å…¥çš„æ˜¯ä¸€ä¸ªaction, çœŸæ­£åšåˆ°äº†ç”¨çš„æ—¶å€™æ‰å»åŠ è½½å€¼çš„è¿™ä¹ˆä¸€ä¸ªæƒ°æ€§åŠ è½½æ€æƒ³","likes_number":4,"is_delete":false,"is_hidden":false,"ctime":1599276369,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1242121,"avatar":"https://static001.geekbang.org/account/avatar/00/12/f4/09/d78fa748.jpg","nickname":"æ ¤æ«","note":"","ucode":"72C5D6EB22CA9F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1604468,"avatar":"https://static001.geekbang.org/account/avatar/00/18/7b/74/9b88e040.jpg","nickname":"æŸæ²¹","note":"","ucode":"92BFEEEE8BBFA0","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309494,"discussion_content":"äººè¨€!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601303842,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":303469,"ip_address":""},"score":309494,"extra":""}]},{"author":{"id":2340596,"avatar":"","nickname":"é˜³å°","note":"","ucode":"CD76C0917139AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":393785,"discussion_content":"å¯¹å“ï¼Œæˆ‘ä¹Ÿä¸ç†è§£","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631600113,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2076251,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/ae/5b/4bd42286.jpg","nickname":"å®‹è®¡æ´‹","note":"","ucode":"9A34E8F71C6CBD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":297612,"discussion_content":"å°±æ˜¯ä»£ä»·æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚éœ€è¦æŸ¥ä¸€æ¬¡æ•°æ®åº“æ‰èƒ½è·å–åˆ°Value,  å¦‚æœä½¿ç”¨computeIfAbsentå¯ä»¥çœå»ä¸€æ¬¡æŸ¥æ•°æ®åº“ï¼Œæˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1596985118,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}