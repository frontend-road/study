{"id":67676,"title":"126 |【实验】Prometheus起步查询实验（下）","content":"无","comments":[{"had_liked":false,"id":155169,"user_name":"梦典","can_delete":false,"product_type":"c3","uid":1203920,"ip_address":"","ucode":"0A6F91068A13E8","user_header":"https://static001.geekbang.org/account/avatar/00/12/5e/d0/e676ac19.jpg","comment_is_top":false,"comment_ctime":1574655547,"is_pvip":false,"replies":[{"id":59651,"content":"思考题做得很认真，赞！如果能参考波波的实验，自己在本地prometheus的查询界面上实际调试一把，这样体会更深。","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1574689712,"ip_address":"","comment_id":155169,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"肯请指教\nRequest Rate\n\n求 http simulator 的总体请求率 (1分钟滚动窗口)\n  sum(rate(http_requests_total{job=&quot;http&quot;}[1m]))\n\n求 每分钟多少是错误请求\n  http_requests_total{job=&quot;http&quot;,status=&quot;500&quot;} - http_requests_total{job=&quot;http&quot;,status=&quot;500&quot;} offset 1m\n\n求对 &#47;users 端点的错误请求率\n  rate(http_requests_total{job=&quot;http&quot;,endpoint=&quot;&#47;users&quot;,status=&quot;500&quot;}[1m])\n\nLatency distribution\n\n求 延迟中位数\n  histogram_quantile(0.5, http_request_duration_milliseconds_bucket)\n\n求 错误请求的 90 百分位延迟，按端点分组\n  sort_desc(\n    histogram_quantile(0.9, sum by (endpoint, le) (http_request_duration_milliseconds_bucket{status=&quot;500&quot;}) )\n  )\n\n对 &#47;users 端点的请求延迟 ，是否满足3个9都在400ms以内的 SLO\n  histogram_quantile(0.999, sum by (le) (http_request_duration_milliseconds_bucket{endpoint=&quot;&#47;users&quot;}))","like_count":3,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475680,"discussion_content":"思考题做得很认真，赞！如果能参考波波的实验，自己在本地prometheus的查询界面上实际调试一把，这样体会更深。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574689712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":193338,"user_name":"stg609","can_delete":false,"product_type":"c3","uid":1073025,"ip_address":"","ucode":"FB70A75A891BB8","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/81/1c614f4a.jpg","comment_is_top":false,"comment_ctime":1584890285,"is_pvip":false,"replies":[{"id":74354,"content":"这个rate的确有点绕，但是promethues的histogram_quantile就是要和rate配合才能计算百分位的，这是它的规定语法，rate()函数用于指定百分位计算的时间窗口(Use the rate() function to specify the time window for the quantile calculation)，参考它的官方文档：\nhttps:&#47;&#47;prometheus.io&#47;docs&#47;prometheus&#47;latest&#47;querying&#47;functions&#47;#histogram_quantile\n","user_name":"作者回复","user_name_real":"杨波","uid":1030344,"ctime":1585231592,"ip_address":"","comment_id":193338,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100007001,"comment_content":"不是很理解，最后的 histogram_quantile ，为什么使用rate？ 这里的rate得到的是个什么？","like_count":0,"discussions":[{"author":{"id":1030344,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/b8/c8/c94d38a7.jpg","nickname":"杨波","note":"","ucode":"FA3418BB703BCA","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488541,"discussion_content":"这个rate的确有点绕，但是promethues的histogram_quantile就是要和rate配合才能计算百分位的，这是它的规定语法，rate()函数用于指定百分位计算的时间窗口(Use the rate() function to specify the time window for the quantile calculation)，参考它的官方文档：\nhttps://prometheus.io/docs/prometheus/latest/querying/functions/#histogram_quantile\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585231592,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1636568,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q3auHgzwzM6iagw7ct4ca3niaSEFNicu2wy2KuCibO6eiaRzoRGJb50WTrbkKQib9mTArnTr8jJUazO9O2ibLZNfjjl35cfCHkBPs7N/132","nickname":"Geek_f39659","note":"","ucode":"2206A8C590423C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":245808,"discussion_content":"可不可以这样理解，这个rate（增长率）才是当前这个时间点上的样本个数。拿到了给定时间每个区间的样本个数以后，才能用histogram_quantile拟合估算P99. ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587700815,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}