{"id":810868,"title":"18ï½œè¯»æ‡‚MySQLä¸­çš„æ‰§è¡Œè®¡åˆ’ï¼ˆä¸‹ï¼‰","content":"<p>æ¥ä¸Šä¸€è®²</p><h3>POSSIBLE_KEYS</h3><p>possible_keysåˆ—æ˜¾ç¤ºæŸ¥è¯¢å•å…ƒèƒ½ä½¿ç”¨rangeã€refç­‰è®¿é—®è·¯å¾„è®¿é—®çš„ç´¢å¼•ã€‚æ‰§è¡Œè®¡åˆ’æœ€ç»ˆé€‰æ‹©çš„ç´¢å¼•åœ¨keysåˆ—æ˜¾ç¤ºã€‚æ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼Œä»¥åŠä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼Œå–å†³äºä¼˜åŒ–å™¨å¯¹å„ç§è®¿é—®æ–¹å¼çš„æˆæœ¬è¯„ä¼°ï¼Œè¿˜è·Ÿè¡¨è¿æ¥çš„é¡ºåºå’Œè¿æ¥ç®—æ³•ä¹Ÿæœ‰å…³ç³»ã€‚</p><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œt1è¡¨çš„possible_keysæœ‰ç´¢å¼•idx_abcï¼Œä½†æ˜¯å½“t1è¡¨ä½œä¸ºé©±åŠ¨è¡¨æ—¶ï¼Œå°±æ— æ³•ä½¿ç”¨ç´¢å¼•idx_abcã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1, tab t2 where t1.a = t2.a and t1.b = t2.b;\n\n\n+----+-------------+-------+------+---------------+---------+---------+-------------------+------+----------+-------+\n| id | select_type | table | type | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| rows | filtered | Extra |\n+----+-------------+-------+------+---------------+---------+---------+-------------------+------+----------+-------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | t1&nbsp; &nbsp; | ALL&nbsp; | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| NULL&nbsp; &nbsp; | NULL&nbsp; &nbsp; | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 9913 |&nbsp; &nbsp;100.00 | NULL&nbsp; |\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | t2&nbsp; &nbsp; | ref&nbsp; | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 8&nbsp; &nbsp; &nbsp; &nbsp;| rep.t1.a,rep.t1.b |&nbsp; &nbsp; 1 |&nbsp; &nbsp;100.00 | NULL&nbsp; |\n+----+-------------+-------+------+---------------+---------+---------+-------------------+------+----------+-------+\n</code></pre><!-- [[[read_end]]] --><h3>KEY</h3><p>keyåˆ—æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’å®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚å¦‚æœkeyåˆ—ä¸ºNULLï¼Œåˆ™è¯´æ˜æŸ¥è¯¢å•å…ƒæ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚å¯¹äºindex_mergeè®¿é—®è·¯å¾„ï¼Œkeyåˆ—ä¸­ä¼šæ˜¾ç¤ºå¤šä¸ªç´¢å¼•ã€‚</p><h3>KEY_LEN</h3><p>key_lenåˆ—æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’ä½¿ç”¨åˆ°çš„ç´¢å¼•åˆ—çš„æ€»é•¿åº¦ã€‚æ ¹æ®key_lenå¯ä»¥æ¨ç®—å‡ºæ‰§è¡Œè®¡åˆ’ä½¿ç”¨åˆ°äº†ç´¢å¼•ä¸­çš„å“ªå‡ ä¸ªå­—æ®µã€‚key_lenæ ¹æ®ç´¢å¼•å­—æ®µçš„ç±»å‹å’Œå­—æ®µæ˜¯å¦ä¸ºç©ºè®¡ç®—å¾—åˆ°ã€‚å¯¹äºå­—ç¬¦ç±»å‹å¦‚varcharã€charï¼Œkey_lenä¸ºå­—ç¬¦æ•°ä¹˜ä»¥å•ä¸ªå­—ç¬¦çš„æœ€å¤§å¯èƒ½å­—èŠ‚æ•°ã€‚å¯¹äºæ¯ä¸ªå¯å˜é•¿ç±»å‹å¦‚varcharï¼Œkey_lené¢å¤–åŠ 2ã€‚å¯¹äºæ¯ä¸ªå¯ä»¥ä¸ºç©ºçš„å­—æ®µï¼Œkey_lené¢å¤–åŠ 1ã€‚</p><pre><code class=\"language-plain\"> create table t_k(\n     a varchar(20), \n     b char(20), \n     key idx_a(a,b)\n) engine=innodb charset=utf8mb4;\n\n\n\n\nmysql&gt; explain select * from t_k where  a='x';\n+----+-------------+-------+------+---------------+-------+---------+-------+------+----------+-------------+\n| id | select_type | table | type | possible_keys | key&nbsp; &nbsp;| key_len | ref&nbsp; &nbsp;| rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp;|\n+----+-------------+-------+------+---------------+-------+---------+-------+------+----------+-------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | t_k&nbsp; &nbsp;| ref&nbsp; | idx_a&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| idx_a | 83&nbsp; &nbsp; &nbsp; | const |&nbsp; &nbsp; 1 |&nbsp; &nbsp;100.00 | Using index |\n+----+-------------+-------+------+---------------+-------+---------+-------+------+----------+-------------+\n\n\n\n\nmysql&gt; explain select * from t_k where  a='x' and b='x';\n\n\n+----+-------------+-------+------+---------------+-------+---------+-------------+------+----------+--------------------------+\n| id | select_type | table | type | possible_keys | key&nbsp; &nbsp;| key_len | ref&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+------+---------------+-------+---------+-------------+------+----------+--------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | t_k&nbsp; &nbsp;| ref&nbsp; | idx_a&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| idx_a | 164&nbsp; &nbsp; &nbsp;| const,const |&nbsp; &nbsp; 1 |&nbsp; &nbsp;100.00 | Using where; Using index |\n+----+-------------+-------+------+---------------+-------+---------+-------------+------+----------+--------------------------+\n</code></pre><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼ŒSQL 1ä½¿ç”¨ç´¢å¼•ä¸­çš„å­—æ®µaï¼Œå­—æ®µAçš„ç±»å‹ä¸ºvarchar(20)ï¼Œå­—ç¬¦é›†ä¸ºutf8mb4ï¼Œkey_lenä¸º20 * 4 + 2 + 1 = 83ã€‚</p><p>SQL 2ä½¿ç”¨åˆ°äº†å­—æ®µAå’ŒBï¼Œå­—æ®µAçš„key_lenä¸º83ï¼Œå­—æ®µBçš„key_lenä¸º20 * 4 + 1 = 81ï¼Œæ•´ä½“Key_lenä¸ºå­—æ®µAå’Œå­—æ®µBç›¸åŠ 164ã€‚</p><h3>REF</h3><p>refåˆ—æ˜¾ç¤ºç”¨æ¥è¿›è¡Œç´¢å¼•æŸ¥æ‰¾çš„å€¼ï¼Œrefçš„å–å€¼å¯èƒ½æ˜¯ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul>\n<li>\n<p>constï¼šä½¿ç”¨å¸¸é‡åŒ¹é…</p>\n</li>\n<li>\n<p>db.tab.cï¼šä½¿ç”¨é©±åŠ¨è¡¨çš„æŸä¸ªå­—æ®µåŒ¹é…</p>\n</li>\n<li>\n<p>funcï¼šä½¿ç”¨æŸä¸ªå‡½æ•°çš„è®¡ç®—ç»“æœåŒ¹é…ã€‚å¯ä»¥åœ¨æ‰§è¡Œexplainåä½¿ç”¨show warningså‘½ä»¤æŸ¥çœ‹è½¬æ¢åçš„SQLã€‚</p>\n</li>\n</ul><h3>ROWS</h3><p>æŸ¥è¯¢å•å…ƒéœ€è¦è®¿é—®çš„è®°å½•æ•°ã€‚å¯¹äºInnoDBå¼•æ“ï¼Œè¿™é‡Œçš„è®°å½•æ•°æ˜¯ä¸€ä¸ªé¢„ä¼°çš„è¡Œæ•°ï¼Œè·Ÿå®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­çœŸå®è®¿é—®çš„è®°å½•æ•°å¯èƒ½ä¼šæœ‰ä¸€äº›å·®å¼‚ã€‚å¯¹äºå…¨è¡¨æ‰«æå’Œå…¨ç´¢å¼•æ‰«æï¼Œè¿™é‡Œçš„è¡Œæ•°ä»ç»Ÿè®¡ä¿¡æ¯ä¸­è·å–ã€‚å¯¹äºç´¢å¼•è®¿é—®ï¼ˆtypeä¸ºrefæˆ–rangeï¼‰ï¼Œrowsé€šè¿‡è®¿é—®ç´¢å¼•è¯„ä¼°å¾—åˆ°ï¼Œæˆ–é€šè¿‡ç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯è®¡ç®—å¾—åˆ°ã€‚å¯¹åº”æ´¾ç”Ÿè¡¨ï¼Œrowsé€šè¿‡ä¸€äº›è§„åˆ™è¯„ä¼°å¾—åˆ°ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œrowsè¶Šå¤§ï¼Œè¯´æ˜æŸ¥è¯¢å•å…ƒéœ€è¦è®¿é—®çš„è®°å½•æ•°è¶Šå¤šï¼Œæ‰§è¡Œæ—¶é—´è¶Šé•¿ã€‚</p><h3>FILTERED</h3><p>filteredå­—æ®µå•ä½ä¸ºç™¾åˆ†æ¯”ï¼Œå–å€¼èŒƒå›´ä¸º0-100ï¼Œè¡¨ç¤ºç»è¿‡whereå­å¥ä¸­çš„æ¡ä»¶è¿‡æ»¤åï¼Œæ»¡è¶³æ¡ä»¶çš„è®°å½•æ•°ç›¸å¯¹äºrowsåˆ—ä¸­æ˜¾ç¤ºçš„è¡Œæ•°æ‰€å çš„ç™¾åˆ†æ¯”ã€‚ä½¿ç”¨å…¬ç¤ºrows * filtered / 100å¯ä»¥å¾—åˆ°ä¼˜åŒ–å™¨é¢„ä¼°çš„æŸ¥è¯¢å•å…ƒè¿”å›çš„è®°å½•æ•°ã€‚å¦‚æœå½“å‰çš„æŸ¥è¯¢å•å…ƒä½œä¸ºé©±åŠ¨è¡¨ï¼Œé‚£ä¹ˆè¿™é‡Œçš„è®°å½•æ•°è¿˜å†³å®šäº†è¢«é©±åŠ¨çš„æŸ¥è¯¢å•å…ƒéœ€è¦æ‰§è¡Œå¤šæ¬¡ã€‚</p><p>ä¼˜åŒ–å™¨ä¸­æœ‰ä¸€ç³»åˆ—å›ºå®šçš„è§„åˆ™æ¥è®¡ç®—filteredçš„å–å€¼ã€‚ä½ å¯ä»¥åœ¨åˆ†æè¡¨ï¼ˆanalyze tableï¼‰çš„æ—¶å€™ç»™å­—æ®µæ·»åŠ ç›´æ–¹å›¾ï¼Œä½¿ä¼˜åŒ–å™¨èƒ½æ›´ç²¾ç¡®åœ°è®¡ç®—filteredã€‚å‚æ•°optimizer_switchä¸­çš„é€‰é¡¹condition_fanout_filterç”¨æ¥æ§åˆ¶æ˜¯å¦å¼€å¯æ¡ä»¶è¿‡æ»¤ã€‚</p><h3>EXTRA</h3><p>Extraåˆ—ä¸­æ˜¾ç¤ºäº†æ‰§è¡Œè®¡åˆ’é¢å¤–çš„ä¸€äº›é‡è¦ä¿¡æ¯ã€‚</p><ul>\n<li>using where</li>\n</ul><p>å¦‚æœè®¿é—®è·¯å¾„ä¸ºALLæˆ–indexï¼ŒExtraä¸­æ²¡ç”¨using whereï¼Œè¯´æ˜æŸ¥è¯¢éœ€è¦è¯»å–æ•´ä¸ªè¡¨æˆ–ç´¢å¼•çš„æ•°æ®ã€‚</p><ul>\n<li>Range checked for each record (index map: 0x n)</li>\n</ul><p>å¦‚æœExtraä¸­å‡ºç°äº†â€œRange checked for each recordâ€ï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„æ€§èƒ½å¾ˆå¯èƒ½ä¸å¤ªå¥½ã€‚è¿™é‡Œindex mapæ˜¯ç´¢å¼•ç¼–å·çš„ä½å›¾ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab a, tab b where  a.id &gt; b.id and a.c &gt; b.c;\n\n\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+------------------------------------------------+\n| id | select_type | table | type | possible_keys | key&nbsp; | key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+------------------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | a&nbsp; &nbsp; &nbsp;| ALL&nbsp; | PRIMARY&nbsp; &nbsp; &nbsp; &nbsp;| NULL | NULL&nbsp; &nbsp; | NULL | 9913 |&nbsp; &nbsp;100.00 | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | b&nbsp; &nbsp; &nbsp;| ALL&nbsp; | PRIMARY&nbsp; &nbsp; &nbsp; &nbsp;| NULL | NULL&nbsp; &nbsp; | NULL | 9913 |&nbsp; &nbsp; 11.11 | Range checked for each record (index map: 0x1) |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+------------------------------------------------+\n</code></pre><ul>\n<li>Using index; Using temporary</li>\n</ul><p>Extraä¸­å‡ºç°Using temporaryï¼Œè¯´æ˜ç”¨åˆ°äº†ä¸´æ—¶è¡¨ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select b,a,count(*) from  tab group by b,a;\n\n\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+------------------------------+\n| id | select_type | table | type&nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tab&nbsp; &nbsp;| index | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 12&nbsp; &nbsp; &nbsp; | NULL | 9913 |&nbsp; &nbsp;100.00 | Using index; Using temporary |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+------------------------------+\n</code></pre><ul>\n<li>Using index for skip scan</li>\n</ul><p>æŸ¥è¯¢æ¡ä»¶æ²¡æœ‰ä¼ å…¥ç´¢å¼•çš„å‰ç¼€å­—æ®µï¼Œåˆç”¨åˆ°äº†è¦†ç›–ç´¢å¼•æ—¶ï¼ŒMySQLå¯èƒ½ä¼šä½¿ç”¨skip scanã€‚å¦‚æœå‰ç¼€åˆ—çš„å”¯ä¸€å€¼å¾ˆä½ï¼Œskip scanä¹Ÿå¯èƒ½ä¼šæœ‰ä¸é”™çš„æ€§èƒ½ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select c from tab where b=1;\n\n\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+----------------------------------------+\n| id | select_type | table | type&nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+----------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tab&nbsp; &nbsp;| range | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 8&nbsp; &nbsp; &nbsp; &nbsp;| NULL |&nbsp; 991 |&nbsp; &nbsp;100.00 | Using where; Using index for skip scan |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+----------------------------------------+\n</code></pre><ul>\n<li>Using index</li>\n</ul><p>ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯æŸ¥è¯¢ä¸­æ‰€æœ‰åˆ—éƒ½åŒ…å«åœ¨ç´¢å¼•ä¸­ã€‚</p><ul>\n<li>no matching row in const table</li>\n</ul><p>è¯´æ˜è¡¨é‡Œé¢ä¸å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where id = 12345;\n\n\n+----+-------------+-------------+---------------+------+---------+------+------+----------+--------------------------------+\n| id | select_type | table&nbsp; type | possible_keys | key&nbsp; | key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------------+---------------+------+---------+------+------+----------+--------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | NULL&nbsp; &nbsp;NULL | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | NULL | NULL&nbsp; &nbsp; | NULL | NULL |&nbsp; &nbsp; &nbsp;NULL | no matching row in const table |\n+----+-------------+-------------+---------------+------+---------+------+------+----------+--------------------------------+\n</code></pre><ul>\n<li>Using index for group-by</li>\n</ul><pre><code class=\"language-plain\">mysql&gt; explain select a, min(b) from tab group by a;\n\n\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+--------------------------+\n| id | select_type | table | type&nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+--------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tab&nbsp; &nbsp;| range | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 4&nbsp; &nbsp; &nbsp; &nbsp;| NULL |&nbsp; &nbsp; 4 |&nbsp; &nbsp;100.00 | Using index for group-by |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+--------------------------+\n</code></pre><ul>\n<li>LooseScan</li>\n</ul><p>LooseScanï¼Œä»¥åŠFirstMatchã€Start temporaryã€End temporaryï¼Œéƒ½æ˜¯å­æŸ¥è¯¢è‡ªåŠ¨æ”¹å†™ä¸ºè¡¨è¿æ¥åçš„æ‰§è¡Œæ–¹å¼ï¼Œæˆ‘ä»¬åœ¨åç»­çš„å­æŸ¥è¯¢è¿™ä¸€è®²ä¸­å†å…·ä½“ä»‹ç»ã€‚</p><pre><code class=\"language-plain\">mysql&gt; set optimizer_switch='materialization=off';\nQuery OK, 0 rows affected (0.01 sec)\n\n\nmysql&gt; explain select * from tab ta \n  where a=1 and c in (select a from tab tb);\n\n\n+----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+------------------------+\n| id | select_type | table | type&nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; &nbsp;| rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tb&nbsp; &nbsp; | index | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 12&nbsp; &nbsp; &nbsp; | NULL&nbsp; | 9913 |&nbsp; &nbsp; &nbsp;0.03 | Using index; LooseScan |\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | ta&nbsp; &nbsp; | ref&nbsp; &nbsp;| idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 4&nbsp; &nbsp; &nbsp; &nbsp;| const | 3333 |&nbsp; &nbsp; 10.00 | Using index condition&nbsp; |\n+----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+------------------------+\n</code></pre><ul>\n<li>FirstMatch(ta)</li>\n</ul><pre><code class=\"language-plain\">mysql&gt; set optimizer_switch='materialization=off';\nQuery OK, 0 rows affected (0.01 sec)\n\n\nmysql&gt; explain select * from tab ta where a=1 and c in (select c from tab tb);\n+----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+-------------------------------------------------------------------------+\n| id | select_type | table | type&nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; &nbsp;| rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n+----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+-------------------------------------------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | ta&nbsp; &nbsp; | ref&nbsp; &nbsp;| idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 4&nbsp; &nbsp; &nbsp; &nbsp;| const | 3333 |&nbsp; &nbsp;100.00 | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tb&nbsp; &nbsp; | index | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | idx_abc | 12&nbsp; &nbsp; &nbsp; | NULL&nbsp; | 9913 |&nbsp; &nbsp; 10.00 | Using where; Using index; FirstMatch(ta); Using join buffer (hash join) |\n+----+-------------+-------+-------+---------------+---------+---------+-------+------+----------+-------------------------------------------------------------------------+\n</code></pre><ul>\n<li>Start temporary, End temporary</li>\n</ul><pre><code class=\"language-plain\">mysql&gt; set optimizer_switch='materialization=off';\nQuery OK, 0 rows affected (0.01 sec)\n\n\nmysql&gt; explain select * from tab ta where id in (select b from tab tb where b &lt; 10);\n\n\n+----+-------------+-------+--------+---------------+---------+---------+----------+------+----------+-------------------------------------------+\n| id | select_type | table | type&nbsp; &nbsp;| possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; &nbsp; &nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n+----+-------------+-------+--------+---------------+---------+---------+----------+------+----------+-------------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tb&nbsp; &nbsp; | index&nbsp; | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | idx_abc | 12&nbsp; &nbsp; &nbsp; | NULL&nbsp; &nbsp; &nbsp;| 9913 |&nbsp; &nbsp; 33.33 | Using where; Using index; Start temporary |\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | ta&nbsp; &nbsp; | eq_ref | PRIMARY&nbsp; &nbsp; &nbsp; &nbsp;| PRIMARY | 4&nbsp; &nbsp; &nbsp; &nbsp;| rep.tb.b |&nbsp; &nbsp; 1 |&nbsp; &nbsp;100.00 | End temporary&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n+----+-------------+-------+--------+---------------+---------+---------+----------+------+----------+-------------------------------------------+\n</code></pre><ul>\n<li>Using index condition</li>\n</ul><p>ä½¿ç”¨åˆ°äº†ç´¢å¼•ä¸‹æ¨æ¡ä»¶ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab where a=1 and c=1;\n\n\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+\n| id | select_type | table | type | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; &nbsp;| rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tab&nbsp; &nbsp;| ref&nbsp; | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 4&nbsp; &nbsp; &nbsp; &nbsp;| const | 3333 |&nbsp; &nbsp; 10.00 | Using index condition |\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+-----------------------+\n</code></pre><ul>\n<li>Using filesort</li>\n</ul><p>è¯´æ˜æŸ¥è¯¢éœ€è¦æ’åºã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab order by b;\n\n\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+----------------+\n| id | select_type | table | type | possible_keys | key&nbsp; | key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+----------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tab&nbsp; &nbsp;| ALL&nbsp; | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | NULL | NULL&nbsp; &nbsp; | NULL | 9913 |&nbsp; &nbsp;100.00 | Using filesort |\n+----+-------------+-------+------+---------------+------+---------+------+------+----------+----------------+\n</code></pre><ul>\n<li>Using join buffer (hash join)</li>\n</ul><p>è¢«é©±åŠ¨è¡¨ç¼ºå°‘åˆé€‚çš„ç´¢å¼•æ—¶ï¼ŒMySQLä¼šè€ƒè™‘ä½¿ç”¨Hashè¿æ¥ç®—æ³•ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select * from tab t1, tab t2 where t1.a = 1 and t1.c=t2.c;\n\n\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+--------------------------------------------+\n| id | select_type | table | type | possible_keys | key     | key_len | ref   | rows | filtered | Extra                                      |\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+--------------------------------------------+\n|  1 | SIMPLE      | t1    | ref  | idx_abc       | idx_abc | 4       | const | 3333 |   100.00 | NULL                                       |\n|  1 | SIMPLE      | t2    | ALL  | NULL          | NULL    | NULL    | NULL  | 9913 |    10.00 | Using where; Using join buffer (hash join) |\n+----+-------------+-------+------+---------------+---------+---------+-------+------+----------+--------------------------------------------+\n</code></pre><ul>\n<li>Using join buffer (Batched Key Access)</li>\n</ul><p>è¡¨å…³è”æ—¶ï¼Œä½¿ç”¨äº†BKAä¼˜åŒ–ã€‚å’ŒMRRç±»ä¼¼ï¼ŒBKAä¹Ÿæ˜¯ä¸ºäº†å‡å°‘æŸ¥è¯¢çš„éšæœºIOçš„æ•°é‡ã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select /*+ BKA(tb) */ * \n  from tab ta, tab tb where ta.a = tb.a;\n\n\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+----------------------------------------+\n| id | select_type | table | type | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; &nbsp; &nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+----------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | ta&nbsp; &nbsp; | ALL&nbsp; | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| NULL&nbsp; &nbsp; | NULL&nbsp; &nbsp; | NULL&nbsp; &nbsp; &nbsp;| 9913 |&nbsp; &nbsp;100.00 | NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tb&nbsp; &nbsp; | ref&nbsp; | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 4&nbsp; &nbsp; &nbsp; &nbsp;| rep.ta.a | 3304 |&nbsp; &nbsp;100.00 | Using join buffer (Batched Key Access) |\n+----+-------------+-------+------+---------------+---------+---------+----------+------+----------+----------------------------------------+\n</code></pre><ul>\n<li>Using MRR</li>\n</ul><p>æŸ¥è¯¢ä½¿ç”¨äº†MRRï¼ˆMulti-Range Readï¼‰ï¼ŒMRRä¸»è¦æ˜¯ä¸ºäº†å‡å°‘å›è¡¨æŸ¥è¯¢æ•°æ®æ—¶éšæœºIOçš„æ•°é‡ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ä½¿ç”¨äº†BKAæç¤ºï¼Œå¼ºåˆ¶ä¼˜åŒ–å™¨ä½¿ç”¨MRRã€‚</p><pre><code class=\"language-plain\">mysql&gt; explain select /*+ BKA(tab) */ * \n  from tab \n  where a=1 and b in (1,2,3);\n\n\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n| id | select_type | table | type&nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | tab&nbsp; &nbsp;| range | idx_abc&nbsp; &nbsp; &nbsp; &nbsp;| idx_abc | 8&nbsp; &nbsp; &nbsp; &nbsp;| NULL |&nbsp; &nbsp; 3 |&nbsp; &nbsp;100.00 | Using index condition; Using MRR |\n+----+-------------+-------+-------+---------------+---------+---------+------+------+----------+----------------------------------+\n</code></pre><ul>\n<li>Using sort_union(â€¦), Using union(â€¦), Using intersect(â€¦)</li>\n</ul><pre><code class=\"language-plain\">mysql&gt; explain select * \n  from t_merge \n  where b=2 and c=2 and d=1;\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+---------------------------------------------+\n| id | select_type | table&nbsp; &nbsp;| type&nbsp; &nbsp; &nbsp; &nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+---------------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | t_merge | index_merge | idx_bd,idx_cd | idx_cd,idx_bd | 8,8&nbsp; &nbsp; &nbsp;| NULL |&nbsp; &nbsp; 2 |&nbsp; &nbsp; 66.99 | Using intersect(idx_cd,idx_bd); Using where |\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+---------------------------------------------+\n\n\n\n\nmysql&gt; explain select * \n  from t_merge \n  where (b=2 and d=1) or (c=2 and d=1);\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+-----------------------------------------+\n| id | select_type | table&nbsp; &nbsp;| type&nbsp; &nbsp; &nbsp; &nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+-----------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | t_merge | index_merge | idx_bd,idx_cd | idx_bd,idx_cd | 8,8&nbsp; &nbsp; &nbsp;| NULL |&nbsp; 108 |&nbsp; &nbsp;100.00 | Using union(idx_bd,idx_cd); Using where |\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+-----------------------------------------+\n\n\n\n\nmysql&gt; explain select * \n  from t_merge \n  where (b=2 and d between 1 and 2) or (d=1 and c=2);\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+----------------------------------------------+\n| id | select_type | table&nbsp; &nbsp;| type&nbsp; &nbsp; &nbsp; &nbsp; | possible_keys | key&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| key_len | ref&nbsp; | rows | filtered | Extra&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+----------------------------------------------+\n|&nbsp; 1 | SIMPLE&nbsp; &nbsp; &nbsp; | t_merge | index_merge | idx_bd,idx_cd | idx_bd,idx_cd | 8,8&nbsp; &nbsp; &nbsp;| NULL |&nbsp; 165 |&nbsp; &nbsp;100.00 | Using sort_union(idx_bd,idx_cd); Using where |\n+----+-------------+---------+-------------+---------------+---------------+---------+------+------+----------+----------------------------------------------+\n</code></pre><h2>æ€»ç»“</h2><p>å‡ºäºå®Œæ•´æ€§çš„è€ƒè™‘ï¼Œè¿™ä¸€è®²ä¸­æˆ‘ä»¬ä½¿ç”¨äº†å››åå¤šä¸ªSQLè¯­å¥ï¼Œæ¼”ç¤ºå¹¶è§£é‡Šäº†MySQLæ‰§è¡Œè®¡åˆ’çš„å„ç§è¾“å‡ºã€‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šé‡åˆ°è¿™é‡Œçš„æ¯ä¸€ç§æƒ…å†µã€‚</p><p>æ‰§è¡Œè®¡åˆ’æœ‰å‡ ä¸ªä¿¡æ¯è¦é‡ç‚¹å…³æ³¨ï¼š</p><ul>\n<li>\n<p>é€šè¿‡IDã€SELECT_TYPEã€TABLEè¿™å‡ åˆ—å¯ä»¥äº†è§£è¯­å¥æ•´ä½“çš„è¿æ¥ã€åµŒå¥—ç»“æ„ã€‚</p>\n</li>\n<li>\n<p>TYPEåˆ—ä¸ºrefã€rangeæ—¶ï¼Œæ‰æ˜¯æˆ‘ä»¬å¹³æ—¶è¯´çš„ç”¨åˆ°äº†ç´¢å¼•ã€‚typeä¸ºindexæ—¶ï¼Œå®é™…ä¸Šæ˜¯ä½¿ç”¨äº†å…¨ç´¢å¼•æ‰«æã€‚</p>\n</li>\n<li>\n<p>ROWSåˆ—æ˜¯ä¼˜åŒ–å™¨è¯„ä¼°çš„éœ€è¦ä»åˆ°å­˜å‚¨å¼•æ“é‡Œè®¿é—®çš„è®°å½•çš„æ•°é‡ï¼Œè¿™ä¸ªæ•°é‡å¯¹æ€§èƒ½æœ‰ç›´æ¥çš„å½±å“ã€‚</p>\n</li>\n<li>\n<p>EXTRAåˆ—é‡Œé¢æä¾›äº†æ‰§è¡Œè®¡åˆ’çš„é¢å¤–ä¿¡æ¯ï¼Œå¯¹è¿™é‡Œå‡ºç°çš„å†…å®¹è¦æœ‰å¤§è‡´çš„äº†è§£ã€‚</p>\n</li>\n</ul><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨FORMAT=TREEï¼Œä»¥æ ‘çš„å½¢å¼æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’ï¼Œæœ‰æ—¶å€™è¿™æ ·å¯èƒ½ä¼šæ›´ç›´è§‚ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¿™ä¸€è®²ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªSQLï¼š</p><pre><code class=\"language-plain\">select id, a, (select avg(b) from tab where a=t1.a) from tab t1;\n</code></pre><p>åœ¨æˆ‘ä»¬çš„æµ‹è¯•è¡¨ä¸­ï¼Œå­—æ®µAçš„å”¯ä¸€å€¼æœ‰ä¸‰ä¸ªï¼Œæ‰€ä»¥ç†è®ºä¸Šï¼Œæœ€ä¼˜çš„æƒ…å†µä¸‹åªéœ€è¦å°†3ä¸ªä¸åŒçš„Açš„å€¼åˆ†åˆ«ä¼ å…¥å­æŸ¥è¯¢ä¸­ï¼ˆselect avg(b) from tab where a = t1.aï¼‰ï¼Œå¹¶å°†è®¡ç®—ç»“æœç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·å­æŸ¥è¯¢åªéœ€è¦æ‰§è¡Œ3æ¬¡ã€‚</p><p>MariaDBå®é™…ä¸Šå°±æœ‰è¿™æ ·çš„å¤„ç†ï¼Œå› æ­¤åœ¨æ‰§è¡Œä¸Šé¢è¿™ä¸ªSQLæ—¶ï¼Œé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚</p><pre><code class=\"language-plain\">mariadb&gt; select id, a, (select avg(b) from tab where a=t1.a) from tab t1 order by id;\n+------+---+---------------------------------------+\n| id   | a | (select avg(b) from tab where a=t1.a) |\n+------+---+---------------------------------------+\n|    0 | 0 |                             4999.5000 |\n|    1 | 1 |                             4999.0000 |\n|    2 | 2 |                             5000.0000 |\n......\n| 9999 | 0 |                             4999.5000 |\n+------+---+---------------------------------------+\n10000 rows in set (0.01 sec)\n</code></pre><p>ä½†æ˜¯MySQLä¸­ï¼ŒåŒæ ·çš„è¡¨ç»“æ„å’Œæ•°æ®ï¼Œé…ç½®ä¸€æ ·çš„æœåŠ¡å™¨ï¼Œæ‰§è¡Œè¿™ä¸ªSQLæ—¶ï¼Œæ‰§è¡Œæ—¶é—´æ˜¯å¥½å‡ ä¸ªæ•°é‡çº§ã€‚</p><pre><code class=\"language-plain\">mysql&gt; select id, a, (select avg(b) from tab where a=t1.a) from tab t1 order by id;\n+------+------+---------------------------------------+\n| id   | a    | (select avg(b) from tab where a=t1.a) |\n+------+------+---------------------------------------+\n|    0 |    0 |                             4999.5000 |\n|    1 |    1 |                             4999.0000 |\n|    2 |    2 |                             5000.0000 |\n......\n| 9999 |    0 |                             4999.5000 |\n+------+------+---------------------------------------+\n10000 rows in set (4 min 17.90 sec)\n</code></pre><p>å¯¹äºè¿™ç§æƒ…å†µï¼Œä½ ä¼šæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p><p>æœŸå¾…ä½ çš„æ€è€ƒï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºä¸­ä¸æˆ‘äº¤æµã€‚å¦‚æœä»Šå¤©çš„è¯¾ç¨‹è®©ä½ æœ‰æ‰€æ”¶è·ï¼Œä¹Ÿæ¬¢è¿è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":394653,"user_name":"Shelly","can_delete":false,"product_type":"c1","uid":2422713,"ip_address":"ç¾å›½","ucode":"75BA35C2737EA6","user_header":"https://static001.geekbang.org/account/avatar/00/24/f7/b9/f2eec64e.jpg","comment_is_top":false,"comment_ctime":1727430128,"is_pvip":false,"replies":[{"id":143283,"content":"å°±è¿™ä¸ªSQLï¼Œè¿™æ ·æ”¹æ€§èƒ½ä¹Ÿèƒ½æå‡å¾ˆå¤šã€‚ä¸è¿‡å»ºè®®ä½¿ç”¨å†…è¿æ¥ã€‚æ”¹æˆå¤–è¿æ¥ï¼ŒSQLçš„å«ä¹‰æœ‰åŒºåˆ«ï¼Œè™½ç„¶åœ¨è¿™é‡Œæ‰§è¡Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚\n\nå¦‚æœè¦æŒ‡å®šè¡¨è¿æ¥çš„é¡ºåºï¼Œå¯ä»¥ç”¨STRAIGHT_JOINã€‚\n\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1727686530,"ip_address":"æµ™æ±Ÿ","comment_id":394653,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è€ƒé¢˜ï¼š \nSELECT   \n    t1.id, \n    t1.a, \n    t2.avg_b \nFROM \n    tab t1   \nRIGHT JOIN \n    (SELECT \n        a, \n        AVG(b) AS avg_b \n     FROM \n        tab     \n     GROUP BY \n        a) t2 \nON\n    t1.a = t2.a \nORDER BY \n    t1.id;\nè¿™ä¹ˆå†™ä¼šç”Ÿæˆä¸´æ—¶è¡¨ï¼Œè¢«é©±åŠ¨è¡¨t1è¢«æ‰«æä¸‰æ¬¡","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651905,"discussion_content":"å°±è¿™ä¸ªSQLï¼Œè¿™æ ·æ”¹æ€§èƒ½ä¹Ÿèƒ½æå‡å¾ˆå¤šã€‚ä¸è¿‡å»ºè®®ä½¿ç”¨å†…è¿æ¥ã€‚æ”¹æˆå¤–è¿æ¥ï¼ŒSQLçš„å«ä¹‰æœ‰åŒºåˆ«ï¼Œè™½ç„¶åœ¨è¿™é‡Œæ‰§è¡Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚\n\nå¦‚æœè¦æŒ‡å®šè¡¨è¿æ¥çš„é¡ºåºï¼Œå¯ä»¥ç”¨STRAIGHT_JOINã€‚\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727686530,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394650,"user_name":"123","can_delete":false,"product_type":"c1","uid":2662872,"ip_address":"æµ™æ±Ÿ","ucode":"5A343B568B9524","user_header":"https://static001.geekbang.org/account/avatar/00/28/a1/d8/42252c48.jpg","comment_is_top":false,"comment_ctime":1727423401,"is_pvip":false,"replies":[{"id":143275,"content":"æˆ‘ç†è§£æ˜¯åœ¨ä¼˜åŒ–é˜¶æ®µå°±æŠŠè¡¨ç»™æ›¿æ¢æ‰äº†ã€‚å¯¹æ¯”ä¸‹è¿™é¢ä¾‹å­ä¸­çš„2ä¸ªSQLï¼Œç¬¬ä¸€ä¸ªSQLï¼Œå½¢å¼ä¸Šæ˜¯è¡¨è¿æ¥ï¼Œä½†æ˜¯çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œå®é™…ä¸Šæ˜¯å•è¡¨æŸ¥è¯¢äº†ã€‚\n\ncreate table t1(\n\tid int not null, \n\ta int not null, \n\tb int not null, \n\tc int, \n\tprimary key(id), \n\tunique key uk_a(a),\n\tkey idx_b(b)\n)engine=innodb;\n\ncreate table t2(\n\tid int not null, \n\ta int not null, \n\tb int not null, \n\tc int, \n\tprimary key(id), \n    key udx_c(c)\n)engine=innodb;\n\ninsert into t1(id, a,b,c) values(100, 1000, 1000, 10);\ninsert into t1(id, a,b,c) values(200, 2000, 2000, 10);\ninsert into t1(id, a,b,c) values(300, 3000, 3000, 10);\n\ninsert into t2(id, a,b,c)  values(101, 101, 201, 10);\ninsert into t2(id, a,b,c)  values(102, 102, 202, 10);\ninsert into t2(id, a,b,c)  values(103, 103, 203, 10);\n\nexplain format=tree select * from t1, t2 where t1.a=1000 and t2.c=t1.c\\G\n\nEXPLAIN: \n-&gt; Index lookup on t2 using udx_c (c=&#39;10&#39;)  (cost=0.80 rows=3)\n\n\nexplain format=tree select * from t1, t2 where t1.b=1000 and t2.c=t1.c\\G\n\nEXPLAIN: \n-&gt; Nested loop inner join  (cost=0.70 rows=1)\n    -&gt; Filter: (t1.c is not null)  (cost=0.35 rows=1)\n        -&gt; Index lookup on t1 using idx_b (b=1000)  (cost=0.35 rows=1)\n    -&gt; Index lookup on t2 using udx_c (c=t1.c)  (cost=0.35 rows=1)","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1727570933,"ip_address":"æµ™æ±Ÿ","comment_id":394650,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"è€å¸ˆï¼Œæ–‡ä¸­è¯´åˆ°â€œconst è¡¨ç¤ºæŸ¥è¯¢æœ€å¤šè¿”å› 1 è¡Œè®°å½•ã€‚å¯¹ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•çš„æ‰€æœ‰å­—æ®µéƒ½ä½¿ç”¨å¸¸é‡ç­‰å€¼åŒ¹é…æ—¶ï¼Œtype ä¸º constã€‚ä¼˜åŒ–å™¨ä¼šå°† type ä¸º const çš„æŸ¥è¯¢å•å…ƒç›´æ¥æ›¿æ¢ä¸ºå¸¸é‡è¡¨ã€‚â€è¿™ä¸ªå¸¸é‡è¡¨å…·ä½“æŒ‡ä»€ä¹ˆï¼Œæ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿè¯¥ä¸»é”®ç´¢å¼•çš„æŸ¥è¯¢åˆ°çš„å€¼ä¸ä¹Ÿæ˜¯éœ€è¦é€šè¿‡B+æ ‘å±‚çº§æ‰«æé“¾æ¥è·å–åˆ°å—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651847,"discussion_content":"æˆ‘ç†è§£æ˜¯åœ¨ä¼˜åŒ–é˜¶æ®µå°±æŠŠè¡¨ç»™æ›¿æ¢æ‰äº†ã€‚å¯¹æ¯”ä¸‹è¿™é¢ä¾‹å­ä¸­çš„2ä¸ªSQLï¼Œç¬¬ä¸€ä¸ªSQLï¼Œå½¢å¼ä¸Šæ˜¯è¡¨è¿æ¥ï¼Œä½†æ˜¯çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œå®é™…ä¸Šæ˜¯å•è¡¨æŸ¥è¯¢äº†ã€‚\n\ncreate table t1(\n\tid int not null, \n\ta int not null, \n\tb int not null, \n\tc int, \n\tprimary key(id), \n\tunique key uk_a(a),\n\tkey idx_b(b)\n)engine=innodb;\n\ncreate table t2(\n\tid int not null, \n\ta int not null, \n\tb int not null, \n\tc int, \n\tprimary key(id), \n    key udx_c(c)\n)engine=innodb;\n\ninsert into t1(id, a,b,c) values(100, 1000, 1000, 10);\ninsert into t1(id, a,b,c) values(200, 2000, 2000, 10);\ninsert into t1(id, a,b,c) values(300, 3000, 3000, 10);\n\ninsert into t2(id, a,b,c)  values(101, 101, 201, 10);\ninsert into t2(id, a,b,c)  values(102, 102, 202, 10);\ninsert into t2(id, a,b,c)  values(103, 103, 203, 10);\n\nexplain format=tree select * from t1, t2 where t1.a=1000 and t2.c=t1.c\\G\n\nEXPLAIN: \n-&gt; Index lookup on t2 using udx_c (c=&#39;10&#39;)  (cost=0.80 rows=3)\n\n\nexplain format=tree select * from t1, t2 where t1.b=1000 and t2.c=t1.c\\G\n\nEXPLAIN: \n-&gt; Nested loop inner join  (cost=0.70 rows=1)\n    -&gt; Filter: (t1.c is not null)  (cost=0.35 rows=1)\n        -&gt; Index lookup on t1 using idx_b (b=1000)  (cost=0.35 rows=1)\n    -&gt; Index lookup on t2 using udx_c (c=t1.c)  (cost=0.35 rows=1)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727570933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394642,"user_name":"å¶æ˜","can_delete":false,"product_type":"c1","uid":1412429,"ip_address":"æ±Ÿè‹","ucode":"D0B4B7660DA766","user_header":"https://static001.geekbang.org/account/avatar/00/15/8d/4d/992070e8.jpg","comment_is_top":false,"comment_ctime":1727407712,"is_pvip":false,"replies":[{"id":143254,"content":"è¿™æ ·æ”¹æ•ˆæœä¸é”™ğŸ‘","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":3898827,"ctime":1727421424,"ip_address":"æµ™æ±Ÿ","comment_id":394642,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100799401,"comment_content":"æ€è€ƒé¢˜\nå°†å­æŸ¥è¯¢æ”¹ä¸ºè”è¡¨æŸ¥è¯¢ï¼Œå…ˆèšåˆå join,é¿å…å¯¹è¡¨ä¸­æ¯è¡Œè®°å½•éƒ½è¿›è¡Œèšåˆè®¡ç®—\n  \nselect\n  t1.id,\n  t1.a,\n  t2.avg_b\nfrom\n  tab t1\n  inner join (\n    select\n      a,\n      avg(b) avg_b\n    from\n      tab\n    group by\n      a\n  ) t2 on t1.a = t2.a\norder by\n  id;\n\n10000 rows in set (0.04 sec)","like_count":0,"discussions":[{"author":{"id":3898827,"avatar":"https://static001.geekbang.org/account/avatar/00/3b/7d/cb/fa3dae58.jpg","nickname":"ä¿Šè¾¾","note":"","ucode":"F79BF9651AD086","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":651779,"discussion_content":"è¿™æ ·æ”¹æ•ˆæœä¸é”™ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1727421424,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æµ™æ±Ÿ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]}]}