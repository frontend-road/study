{"id":479384,"title":"01｜技术概览：eBPF的发展历程及工作原理","content":"<p>你好，我是倪朋飞。</p><p>在正式介绍 eBPF 的使用方法和具体应用之前，我会用两讲的内容，带你了解eBPF的技术脉络和学习路线，为你后面的学习做好准备。</p><p>在开篇词里，我带你一起了解了这门课的设计思路和主要内容，也简单介绍了 eBPF 的主要应用场景，包括故障诊断、网络优化、安全控制、性能监控等。那你可能就要问了：为什么 eBPF 可以应用到这么广泛的领域呢？</p><p>eBPF 广泛的应用场景和强大的功能，跟它的发展历程、基本原理密切相关。那么，eBPF 的发展历程是什么样的？它又是如何在确保安全的前提下，允许非内核开发者去扩展内核的功能的呢？今天，我就带你一起来看看这些问题。</p><h2>eBPF 的发展历程是什么样的?</h2><p>在开篇词中，我曾经提到，eBPF 是从 BPF (Berkeley Packet Filter) 技术扩展而来的。而说起 BPF，它的历史就更悠长了。</p><p>早在 1992 年的 USENIX 会议上，Steven McCanne 和 Van Jacobson 发布的论文“<a href=\"https://www.tcpdump.org/papers/bpf-usenix93.pdf\">The BSD Packet Filter: A New Architecture for User-level Packet Capture</a>” 就为 BSD 操作系统带来了革命性的包过滤机制 BSD Packet Filter（简称为 BPF），这比当时最先进的数据包过滤技术还快 20 倍。为什么性能这么好呢？这主要得益于 BPF 的两大设计：</p><!-- [[[read_end]]] --><ul>\n<li>第一，内核态引入一个新的虚拟机，所有指令都在内核虚拟机中运行。</li>\n<li>第二，用户态使用 BPF 字节码来定义过滤表达式，然后传递给内核，由内核虚拟机解释执行。</li>\n</ul><p>这就使得包过滤可以直接在内核中执行，避免了向用户态复制每个数据包，从而极大提升了包过滤的性能，进而被各大操作系统广泛接受。BPF 最初的名字 BSD Packet Filter ，也被作者的工作单位名所替代，变成了 Berkeley Packet Filter（很巧的是，还是简称 BPF）。</p><p>在 BPF 诞生五年后，Linux 2.1.75 首次引入了 BPF 技术，随后&nbsp;BPF 开始了不温不火的发展历程。其中，Linux 3.0 中增加的 BPF 即时编译器可以算是一个最重大的更新了。它替换掉了原本性能更差的解释器，进一步优化了 BPF 指令运行的效率。但直到此时，BPF 的应用还是仅限于网络包过滤这个传统的领域中。</p><p>时间到了 2014 年。为了研究新的软件定义网络方案，Alexei Starovoitov 为 BPF 带来了第一次革命性的更新，将 BPF 扩展为一个通用的虚拟机，也就是 eBPF。eBPF 不仅扩展了寄存器的数量，引入了全新的 BPF 映射存储，还在 4.x 内核中将原本单一的数据包过滤事件逐步扩展到了内核态函数、用户态函数、跟踪点、性能事件（perf_events）以及安全控制等。</p><p><strong>eBPF 的诞生是 BPF 技术的一个转折点，使得 BPF 不再仅限于网络栈，而是成为内核的一个顶级子系统。</strong></p><p>在内核发展的同时，eBPF 繁荣的生态也进一步促进了 eBPF 的蓬勃发展。这其中，最典型的就是 iovisor 带来的 BCC、bpftrace 等工具，成为 eBPF 在跟踪和排错领域的最佳实践。由于 eBPF 无需修改内核源码和重新编译内核就可以扩展内核的功能，Cilium、Katran、Falco 等一系列基于 eBPF 优化网络和安全的开源项目也逐步诞生。并且，越来越多的开源和商业解决方案开始借助 eBPF，优化其网络、安全以及观测的性能。比如，最流行的网络解决方案之一 Calico，就在最近的版本中引入了 <a href=\"https://www.tigera.io/blog/introducing-the-calico-ebpf-dataplane/\">eBPF 数据面网络</a>，大大提升了网络的性能。</p><p>为了帮你更好地理解 eBPF 的发展历程，我把 eBPF 诞生以来的发展过程整理成了一张图片：</p><p><img src=\"https://static001.geekbang.org/resource/image/b4/ff/b44562381748de369b50403219c0d1ff.jpg?wh=2284x7454\" alt=\"\" title=\"eBPF 发展历程\"></p><p>直到今天，eBPF 依然是内核社区最活跃的子模块之一，还处在一个快速发展的过程中。可以说，<strong>eBPF 开启的创新才刚刚开始</strong>，在未来我们会看到更多的创新案例。正是为了确保每个 eBPF 学习者不掉队，我们把这门课设计成了动态发布的形式，带你随时跟踪这些最新的发展和案例。</p><p>了解了 eBPF 的诞生过程后，还有一点需要你留意：在内核社区的开发讨论中，通常还是使用 BPF 这个缩略词，而在很多应用的文档中可能会倾向使用 eBPF。其实它们的含义是一样的，都是指扩展版的 BPF。</p><h2>eBPF 是怎么工作的?</h2><p>eBPF 程序并不像常规的线程那样，启动后就一直运行在那里，它需要事件触发后才会执行。这些事件包括系统调用、内核跟踪点、内核函数和用户态函数的调用退出、网络事件，等等。借助于强大的内核态插桩（kprobe）和用户态插桩（uprobe），eBPF 程序几乎可以在内核和应用的任意位置进行插桩。</p><p>看到这个令人惊叹的能力，你一定有疑问：这会不会像内核模块一样，一个异常的 eBPF 程序就会损坏整个内核的稳定性呢？其实，<strong>确保安全和稳定一直都是 eBPF 的首要任务</strong>，不安全的 eBPF 程序根本就不会提交到内核虚拟机中执行。</p><p>Linux 内核是如何实现 eBPF 程序的安全和稳定的呢？其实很简单，我带你看个 eBPF 程序的执行过程，你就明白了。</p><p>如下图（图片来自<a href=\"https://www.brendangregg.com/ebpf.html\">brendangregg.com</a>）所示，通常我们借助 <a href=\"https://llvm.org/\">LLVM</a> 把编写的 eBPF 程序转换为 BPF 字节码，然后再通过 bpf 系统调用提交给内核执行。内核在接受 BPF 字节码之前，会首先通过验证器对字节码进行校验，只有校验通过的 BPF 字节码才会提交到即时编译器执行。</p><p><img src=\"https://static001.geekbang.org/resource/image/a7/6a/a7165eea1fd9fc24090a3a1e8987986a.png?wh=1500x550\" alt=\"图片\" title=\"eBPF 程序执行过程\"></p><p>如果 BPF 字节码中包含了不安全的操作，验证器会直接拒绝 BPF 程序的执行。比如，下面就是一些典型的验证过程：</p><ul>\n<li>只有特权进程才可以执行 bpf 系统调用；</li>\n<li>BPF 程序不能包含无限循环；</li>\n<li>BPF 程序不能导致内核崩溃；</li>\n<li>BPF 程序必须在有限时间内完成。</li>\n</ul><p>BPF 程序可以利用 BPF 映射（map）进行存储，而用户程序通常也需要通过 BPF 映射同运行在内核中的 BPF 程序进行交互。如下图（图片来自<a href=\"https://ebpf.io/what-is-ebpf\">ebpf.io</a>）所示，在性能观测中，BPF 程序收集内核运行状态存储在映射中，用户程序再从映射中读出这些状态。</p><p><img src=\"https://static001.geekbang.org/resource/image/53/dd/53af7f7db99c3ca57f981f00303949dd.png?wh=1401x733\" alt=\"图片\" title=\"BPF 映射\"></p><p>可以看到，eBPF 程序的运行需要历经编译、加载、验证和内核态执行等过程，而用户态程序则需要借助 BPF 映射来获取内核态 eBPF 程序的运行状态。</p><h2>eBPF 是万能的吗?</h2><p>看到这里，你是不是因为 eBPF 在扩展内核功能上的强大能力而兴奋不已？我猜你已经迫不及待想要体验一下了。不过，在你体验之前，我还要提醒你一点：eBPF 并不是万能的，它也有很多的局限性。下面是一些最常见的&nbsp;eBPF 限制：</p><ul>\n<li>eBPF 程序必须被验证器校验通过后才能执行，且不能包含无法到达的指令；</li>\n<li>eBPF 程序不能随意调用内核函数，只能调用在 API 中定义的辅助函数；</li>\n<li>eBPF 程序栈空间最多只有 512 字节，想要更大的存储，就必须要借助映射存储；</li>\n<li>在内核 5.2 之前，eBPF 字节码最多只支持 4096 条指令，而 5.2 内核把这个限制提高到了 100 万条；</li>\n<li>由于内核的快速变化，在不同版本内核中运行时，需要访问内核数据结构的 eBPF 程序很可能需要调整源码，并重新编译。</li>\n</ul><p>此外，虽然 Linux 内核很早就已经支持了 eBPF，但很多新特性都是在 4.x 版本中逐步增加的，具体你可以看下<a href=\"https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md#main-features\">这个链接</a>。所以，想要稳定运行 eBPF 程序，<strong>内核版本至少需要 4.9 或者更新</strong>。而在开发和学习 eBPF 时，<strong>为了体验最新的 eBPF 特性，我推荐使用更新的 5.x 内核</strong>。在这门课后面的内容中，我还会给你详细讲解开发环境的搭建步骤，以及推荐的 Linux&nbsp;发行版。</p><h2>小结</h2><p>今天，我带你一起探索了 eBPF 技术的发展历程，并梳理了 eBPF 的工作原理。</p><p>eBPF 是从 BPF 技术扩展而来的。BPF 出现后，一直都是网络数据包过滤的核心，但直到 eBPF 诞生前，BPF 都仅用于包过滤这个场景中。eBPF 的诞生是 BPF 技术的一个转折点，使它的应用范围逐步从包过滤扩展到内核函数、用户函数、跟踪点、性能事件、安全控制等全新的领域中。而这也进一步催生了Cilium、Katran、Falco 等一大批基于 eBPF 构建的网络和安全解决方案，形成了繁荣的 eBPF 生态。</p><p>eBPF 程序以内核事件触发的方式运行，并且其运行过程包括编译、加载、验证和内核态执行等。为了保护内核的安全和稳定，如果编译后 BPF 字节码中包含了不安全的操作，验证阶段会直接拒绝 BPF 程序的执行。</p><p>不过，需要提醒你的是：为了确保安全和稳定，eBPF 程序也有很多的限制，这是你在后续的学习过程中需要特别留心的。</p><h2>思考题</h2><p>在这一讲的最后，想和你交流的问题是：在之前的学习和工作中，你有没有使用过 eBPF 呢？如果使用过，你又用 eBPF 解决过哪些实际的问题呢？期待你在留言区分享，并和我交流讨论。</p><p>今天的内容到这里就结束了，欢迎把它分享给你的同事和朋友，我们下一讲见。</p>","comments":[{"had_liked":false,"id":331099,"user_name":"大卫李","can_delete":false,"product_type":"c1","uid":1012163,"ip_address":"","ucode":"CFEB849481BCB3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/71/c3/09e22c1d.jpg","comment_is_top":false,"comment_ctime":1642420835,"is_pvip":false,"replies":[{"id":120924,"content":"欢迎在留言区跟同学们分享学习中的问题和经验。","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642425835,"ip_address":"","comment_id":331099,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"非常高兴看到eBPF技术能在极客时间开学习专栏了，算是中文圈的一个里程碑！本人也在一直学习bpf技术（也简单写了发展史：https:&#47;&#47;davidlovezoe.club&#47;bpf ），希望跟倪老师及大家共勉。","like_count":24,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546791,"discussion_content":"欢迎在留言区跟同学们分享学习中的问题和经验。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642425835,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1012735,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/73/ff/e5423989.jpg","nickname":"罗进","note":"","ucode":"2E14721531A07C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546981,"discussion_content":"@大卫李 催更BPF MAP 2 😄","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1642487720,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1254489,"avatar":"https://static001.geekbang.org/account/avatar/00/13/24/59/e9867100.jpg","nickname":"Unknown","note":"","ucode":"5FBF3D1044CA20","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546822,"discussion_content":"谢谢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642432752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331204,"user_name":"余生","can_delete":false,"product_type":"c1","uid":2421369,"ip_address":"","ucode":"AEF6C96738F03B","user_header":"https://static001.geekbang.org/account/avatar/00/24/f2/79/b2012f53.jpg","comment_is_top":false,"comment_ctime":1642483891,"is_pvip":false,"replies":[{"id":121071,"content":"谢谢对专栏的支持，我们一起加油！","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642594016,"ip_address":"","comment_id":331204,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100104501,"comment_content":"极客上特别喜欢的几位大咖老师，倪朋飞、陶辉、刘超、彭东！","like_count":10,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547241,"discussion_content":"谢谢对专栏的支持，我们一起加油！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642594016,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":333432,"user_name":"Unknown element","can_delete":false,"product_type":"c1","uid":2028277,"ip_address":"","ucode":"34A129800D0238","user_header":"https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg","comment_is_top":false,"comment_ctime":1644367010,"is_pvip":false,"replies":[{"id":122028,"content":"这儿可能有一点说的不是特别清楚，“加载”可能对应两个操作：\n1）第一个是用户态程序通过BPF系统调用加载字节码；\n2）第二个是内核态收到这个系统调用后，再执行验证+加载的过程。\n\n所以，对内核来说，“验证+加载”是在用户态程序调用“加载”操作之后的执行步骤。","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1644730523,"ip_address":"","comment_id":333432,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"老师我看您在评论区说ebpf程序是在加载到内核之前验证，那文中的执行顺序是不是不太准确？应该是 编译 验证 加载 内核执行？","like_count":8,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":550778,"discussion_content":"这儿可能有一点说的不是特别清楚，“加载”可能对应两个操作：\n1）第一个是用户态程序通过BPF系统调用加载字节码；\n2）第二个是内核态收到这个系统调用后，再执行验证+加载的过程。\n\n所以，对内核来说，“验证+加载”是在用户态程序调用“加载”操作之后的执行步骤。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1644730523,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331732,"user_name":"我要收购腾讯","can_delete":false,"product_type":"c1","uid":1220604,"ip_address":"","ucode":"58575658350537","user_header":"https://static001.geekbang.org/account/avatar/00/12/9f/fc/0232f005.jpg","comment_is_top":false,"comment_ctime":1642742139,"is_pvip":false,"replies":[{"id":121185,"content":"谢谢分享！欢迎在学习过程中分享更多的学习和实践经验！","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642766616,"ip_address":"","comment_id":331732,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"用过 bcc profile + crd 的方式给公司内部的k8s控制台开发过一键生成火焰图的功能, （全套的可观测性部署不太适合开发测试用集群）","like_count":7,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547607,"discussion_content":"谢谢分享！欢迎在学习过程中分享更多的学习和实践经验！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642766616,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331124,"user_name":"Unknown","can_delete":false,"product_type":"c1","uid":1254489,"ip_address":"","ucode":"5FBF3D1044CA20","user_header":"https://static001.geekbang.org/account/avatar/00/13/24/59/e9867100.jpg","comment_is_top":false,"comment_ctime":1642433063,"is_pvip":false,"replies":[{"id":121081,"content":"嗯嗯，是的，谢谢分享。欢迎在学习过程中分享更多的实践经验！","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642594925,"ip_address":"","comment_id":331124,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"bcc tools 工具都很好用，比如Diffie-Hellman密钥交换算法使得就算有key都无法解密，不过如果通过bcc tools中的sslsniff能直接查看了，对调试来说挺方便的","like_count":7,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547252,"discussion_content":"嗯嗯，是的，谢谢分享。欢迎在学习过程中分享更多的实践经验！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642594925,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2621412,"avatar":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","nickname":"无名无姓","note":"","ucode":"487BD5AA2CD305","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":609890,"discussion_content":"这些工具怎么查找和使用呢?","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679282556,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331277,"user_name":"Damoncui","can_delete":false,"product_type":"c1","uid":1566446,"ip_address":"","ucode":"5F09EB267F0572","user_header":"https://static001.geekbang.org/account/avatar/00/17/e6/ee/8fdbd5db.jpg","comment_is_top":false,"comment_ctime":1642514487,"is_pvip":false,"replies":[{"id":121082,"content":"嗯嗯，这本书也不错，我们一起加油！","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642595065,"ip_address":"","comment_id":331277,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"好激动！目前正在看翻译版的《bpf之巅》，配合食用简直快乐到不行～英文版吃起来太痛苦……\n\n选对课程、教程基本节约了一半时间！\n\n希望和各类牛人一起加油进步！\n\nebpf一定会越来越火🔥～","like_count":6,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547253,"discussion_content":"嗯嗯，这本书也不错，我们一起加油！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642595065,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331353,"user_name":"Sports","can_delete":false,"product_type":"c1","uid":1757265,"ip_address":"","ucode":"1AC6035DFA4ECB","user_header":"https://static001.geekbang.org/account/avatar/00/1a/d0/51/f1c9ae2d.jpg","comment_is_top":false,"comment_ctime":1642559800,"is_pvip":false,"replies":[{"id":121069,"content":"感谢对专栏的支持，我们一起加油！","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642593895,"ip_address":"","comment_id":331353,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"刚来到极客时间买的早期课程就有倪老师的Linux优化实战，看过多遍，大神必出精品！","like_count":2,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547239,"discussion_content":"感谢对专栏的支持，我们一起加油！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642593896,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":332596,"user_name":"dovefi","can_delete":false,"product_type":"c1","uid":1007670,"ip_address":"","ucode":"9F8C59F095B187","user_header":"https://static001.geekbang.org/account/avatar/00/0f/60/36/1848c2b7.jpg","comment_is_top":false,"comment_ctime":1643358889,"is_pvip":false,"replies":[{"id":121563,"content":"谢谢分享实践经验👍","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1643460862,"ip_address":"","comment_id":332596,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"使用过bcc-tools 中的filetop cachetop等工具分析过缓存占用的问题，第一次接触到ebpf工具，同事的大佬也有使用systemtap解决过很多问题","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548960,"discussion_content":"谢谢分享实践经验👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643460862,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331153,"user_name":"坚","can_delete":false,"product_type":"c1","uid":2019536,"ip_address":"","ucode":"C02AB1CDE39D1A","user_header":"https://static001.geekbang.org/account/avatar/00/1e/d0/d0/a6c6069d.jpg","comment_is_top":false,"comment_ctime":1642466521,"is_pvip":false,"replies":[{"id":121072,"content":"嗯嗯，我们第03讲会详细介绍开发环境的搭建的","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642594109,"ip_address":"","comment_id":331153,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"倪老师好，我是做嵌入式开发，需要自己配置内核，在搭建bpf的使用环境的时候可以也提一下需要开启内核哪些配置吗？","like_count":1,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547242,"discussion_content":"嗯嗯，我们第03讲会详细介绍开发环境的搭建的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642594109,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1007254,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","nickname":"莫名","note":"","ucode":"E28F2602BA25DD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547224,"discussion_content":"嵌入式环境建议使用 iovisor/ply，相比 bcc、bpftrace 较轻量，不需要依赖 llvm、clang。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1642588591,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367074,"user_name":"Geek_07f1e3","can_delete":false,"product_type":"c1","uid":3297575,"ip_address":"江苏","ucode":"1A344451F30651","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqKmVMIqxRO00L8J1iatIzeMHwzYb0s762j9B2dicy4P8tciat26cNDgoyMREjtluZEBXGvwz9nUSO2g/132","comment_is_top":false,"comment_ctime":1674894237,"is_pvip":false,"replies":[{"id":134631,"content":"谢谢分享，欢迎在后续的学习过程中分享更多的经验！","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1677499968,"ip_address":"上海","comment_id":367074,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100104501,"comment_content":"曾利用bcc解决过容器DNS请求监控的问题场景，但是正如倪老师文末所提及的eBPF与内核版本之间的限制关系，导致方案最后没被通过，但也算是一次不错的实践体验。","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606942,"discussion_content":"谢谢分享，欢迎在后续的学习过程中分享更多的经验！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677499968,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"上海","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":336759,"user_name":"十七","can_delete":false,"product_type":"c1","uid":2298813,"ip_address":"","ucode":"B2341AF0E7AD47","user_header":"https://static001.geekbang.org/account/avatar/00/23/13/bd/3e86e791.jpg","comment_is_top":false,"comment_ctime":1646356997,"is_pvip":false,"replies":[{"id":123073,"content":"要看系统的，如果是Linux并且内核版本比较新，那应该是没问题的","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1646394123,"ip_address":"","comment_id":336759,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"嵌入式系统ebpf是否适合使用?","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":554475,"discussion_content":"要看系统的，如果是Linux并且内核版本比较新，那应该是没问题的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1646394123,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334776,"user_name":"坚","can_delete":false,"product_type":"c1","uid":2019536,"ip_address":"","ucode":"C02AB1CDE39D1A","user_header":"https://static001.geekbang.org/account/avatar/00/1e/d0/d0/a6c6069d.jpg","comment_is_top":false,"comment_ctime":1645108661,"is_pvip":false,"replies":[{"id":122618,"content":"他们都可以用来跟踪和排查内核问题，但ebpf功能更完善，还可以自己写程序自定义处理逻辑。","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1645611283,"ip_address":"","comment_id":334776,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"老师，我想问一下eBPF和perf有关系吗？还是说这是两个东西","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":552844,"discussion_content":"他们都可以用来跟踪和排查内核问题，但ebpf功能更完善，还可以自己写程序自定义处理逻辑。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645611283,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":334310,"user_name":"helloworld","can_delete":false,"product_type":"c1","uid":1584653,"ip_address":"","ucode":"66F6A106E11B69","user_header":"https://static001.geekbang.org/account/avatar/00/18/2e/0d/72a65e1c.jpg","comment_is_top":false,"comment_ctime":1644883067,"is_pvip":false,"replies":[{"id":122217,"content":"很多ebpf特性在老版本的内核都是不支持的，所以基于新特性开发的程序有可能是没法直接适配的（一般重新开发一个或者换成systemtap等工具可能更容易）。具体内核版本中支持的特性列表可以参考https:&#47;&#47;github.com&#47;iovisor&#47;bcc&#47;blob&#47;master&#47;docs&#47;kernel-versions.md","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1645019012,"ip_address":"","comment_id":334310,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"非常高兴看到这样的课程。我这里工作实践中用个疑问，我们一般遇到的操作系统低版本的比较多，比如centos内核3.1x的，怎么能做到在低版本适配呢？","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":551457,"discussion_content":"很多ebpf特性在老版本的内核都是不支持的，所以基于新特性开发的程序有可能是没法直接适配的（一般重新开发一个或者换成systemtap等工具可能更容易）。具体内核版本中支持的特性列表可以参考https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1645019012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331641,"user_name":"Ethan Liu","can_delete":false,"product_type":"c1","uid":1070043,"ip_address":"","ucode":"231F944F7CD56A","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg","comment_is_top":false,"comment_ctime":1642682104,"is_pvip":false,"replies":[{"id":121173,"content":"只是在加载到内核之前进行验证，加载之后就不需要了","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642749673,"ip_address":"","comment_id":331641,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"eBPF程序执行需要进行验证，不影响性能吗？","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547566,"discussion_content":"只是在加载到内核之前进行验证，加载之后就不需要了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642749674,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1120024,"avatar":"https://static001.geekbang.org/account/avatar/00/11/17/18/e4382a8e.jpg","nickname":"有识之士","note":"","ucode":"23F5594193D200","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":581052,"discussion_content":"机器开启了ebpf后，进行系统的插桩，感觉会影响机器的性能吧","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1658474624,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331638,"user_name":"娟","can_delete":false,"product_type":"c1","uid":1082078,"ip_address":"","ucode":"0B6D2558344F31","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/de/7f6cae1f.jpg","comment_is_top":false,"comment_ctime":1642681141,"is_pvip":false,"replies":[{"id":121170,"content":"加油！","user_name":"作者回复","user_name_real":"编辑","uid":1001282,"ctime":1642749494,"ip_address":"","comment_id":331638,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"bpf很早就有一些了解，觉得那些语法挺好玩，跟着大牛一起进步，系统化了解了解ebpf。希望结束的时候能很有收获。","like_count":0,"discussions":[{"author":{"id":1001282,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/47/42/5b55bd1a.jpg","nickname":"倪朋飞","note":"","ucode":"F0FAC195CDE7AC","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547563,"discussion_content":"加油！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642749494,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2727658,"avatar":"https://static001.geekbang.org/account/avatar/00/29/9e/ea/f9e0726a.jpg","nickname":"马超","note":"","ucode":"EA3E38E2D97F38","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":591751,"discussion_content":"这个只有音频吗？感觉入不了门啊！！！这个课程不要这么敷衍啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1666793019,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":396337,"user_name":"Geek_cc0645","can_delete":false,"product_type":"c1","uid":1971407,"ip_address":"陕西","ucode":"13B59F82095602","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/UWDBUEsDLIKpeIujPLsrRG9l0cFhWlXB9CcaOpNKrOdhDAia6PialmJZ4MQgYtBpDdu58leIDDlsOxaZsRvknZZA/132","comment_is_top":false,"comment_ctime":1734011413,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"原来的版本是 3.10，centos7, 请问下自己编译 5.4.286版本的内核，sudo modprobe bpf\nmodprobe: FATAL: Module bpf not found. 报错是因为什么，\n使用的配置参数\nCONFIG_BPF=y\nCONFIG_BPF_SYSCALL=y\nCONFIG_BPF_EVENTS=y\nCONFIG_BPF_JIT=y\nCONFIG_HAVE_EBPF_JIT=y","like_count":0},{"had_liked":false,"id":394717,"user_name":"愚人","can_delete":false,"product_type":"c1","uid":1428998,"ip_address":"北京","ucode":"4BD4E097983FA3","user_header":"https://static001.geekbang.org/account/avatar/00/15/ce/06/273dcc0d.jpg","comment_is_top":false,"comment_ctime":1727874969,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"“但直到 eBPF 诞生前，BPF 都仅用于包过滤这个场景中”这里似乎不对哦，今天看到 Linux 的 seccomp 使用了 bpf 来更灵活地控制进程能使用哪些系统调用，这个机制在 2012 年的 3.5 版本内核引入，但从文章看起来 ebpf 的出现时间应该在 2014 年🤔","like_count":0},{"had_liked":false,"id":393735,"user_name":"阴晦","can_delete":false,"product_type":"c1","uid":3219777,"ip_address":"浙江","ucode":"9B1DA9947FAB45","user_header":"https://static001.geekbang.org/account/avatar/00/31/21/41/d8f2fe6d.jpg","comment_is_top":false,"comment_ctime":1724744738,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"最近打算脱离云做传统软件的时候，突然想起来ebpf可以在一些注入网关之类的需要做代理转发的地方使用。\n不过目前还没有是深入学习，还不知道想法现实与否","like_count":0},{"had_liked":false,"id":386852,"user_name":"屠步空杯","can_delete":false,"product_type":"c1","uid":1810877,"ip_address":"浙江","ucode":"40F513E3F57505","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKf9jqppL0WenjNzGAykMcWZuec94gvGYlb5LwhROXD8Ym0SkhnN3H1oObsqmoIoU95zqz8FGNIOA/132","comment_is_top":false,"comment_ctime":1705709123,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"倪老师，您提到的内核社区，具体位置在哪，能发一下吗？谢谢","like_count":0},{"had_liked":false,"id":377501,"user_name":"Geek_5674cf","can_delete":false,"product_type":"c1","uid":3666762,"ip_address":"中国香港","ucode":"FD63BBEE719797","user_header":"","comment_is_top":false,"comment_ctime":1688611476,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100104501,"comment_content":"老师，在androids系统中，通过ebpf是否可以实现转发指定app中指定接口的明文数据","like_count":0},{"had_liked":false,"id":357395,"user_name":"Slience-0°C","can_delete":false,"product_type":"c1","uid":1151612,"ip_address":"山东","ucode":"B50665EC6A80F5","user_header":"https://static001.geekbang.org/account/avatar/00/11/92/7c/12c571b6.jpg","comment_is_top":false,"comment_ctime":1663223252,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"老师，eBPF可以做控制操作的功能？","like_count":0},{"had_liked":false,"id":352325,"user_name":"magina","can_delete":false,"product_type":"c1","uid":1138499,"ip_address":"","ucode":"9546701896A09F","user_header":"https://static001.geekbang.org/account/avatar/00/11/5f/43/3799a0f3.jpg","comment_is_top":false,"comment_ctime":1658559402,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"看完没懂“内核态引入一个新的虚拟机，所有指令都在内核虚拟机中运行”，怎么体现在文中的图上？","like_count":0},{"had_liked":false,"id":352239,"user_name":"有识之士","can_delete":false,"product_type":"c1","uid":1120024,"ip_address":"","ucode":"23F5594193D200","user_header":"https://static001.geekbang.org/account/avatar/00/11/17/18/e4382a8e.jpg","comment_is_top":false,"comment_ctime":1658474510,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100104501,"comment_content":"开发 eBPF 程序，如何进行调试？类似 go、java 这种高级语言可以方便 debug 一样的？ ","like_count":0}]}