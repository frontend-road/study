{"id":633224,"title":"32｜CQRS（下）：CQRS还有哪些变化？","content":"<p>你好，我是钟敬。</p><p>上节课，我们从业务需求出发，一步步推演，学习了CQRS的基本原理。另外，我们还学习了“代码结构分离”和“数据库结构分离”两种策略。</p><p>在这两种策略中，程序仍然在同一个微服务，数据库也只有一个实例。但是，当我们遇到更高的并发性能需求时，就要考虑分布式程序和数据库了。这就是今天的两种策略要解决的问题。之后，我们还会讨论如何权衡这些策略，做出恰当的技术决策。</p><h2>应用服务分离</h2><p>我们先回顾一下<a href=\"https://time.geekbang.org/column/article/633063\">上节课</a>里，“数据库结构分离”部分的架构图。</p><p><img src=\"https://static001.geekbang.org/resource/image/b3/5f/b3fb11bdd53747684020c488dc01265f.jpg?wh=3600x3956\" alt=\"\"></p><p>如果我们发现，使用命令的并发请求相对比较少，而使用查询的并发请求却很多，需要横向扩展才能满足性能和可用性要求，那么就可以考虑拆成两个微服务了。我们把这种策略称为“应用服务分离”。</p><p>拆分后的架构图是后面这样。<br>\n<img src=\"https://static001.geekbang.org/resource/image/65/72/656061a78fa5cfdb3cd55a602683fe72.jpg?wh=3600x3956\" alt=\"\"></p><p>对照这张图我们可以看到，命令处理器和查询处理器原来是在同一个微服务中的，现在拆成了两个。这样，两个服务的可伸缩性就可以不一样了。例如负责处理命令的微服务可以部署在 5 个容器里，而负责处理查询的微服务部署在 10 个容器里。</p><p>另外还有一个小细节，你可以结合后面这张图看一下。</p><p><img src=\"https://static001.geekbang.org/resource/image/61/yy/611f0feb8662f020c1ae1db97240beyy.jpg?wh=3600x3956\" alt=\"\"></p><p>在之前的组件图里，供给接口和需求接口是直接相连的。而这里使用了表示依赖的线。这两种方法都可以。如果供给和需求接口离得比较远，或者像这张图一样，两个需求接口共用一个供给接口，就可以采用依赖的形式来描述。</p><!-- [[[read_end]]] --><p>应用服务分离策略的好处是容易横向扩展，代价则是微服务的数量增加了，相应的运维和治理成本也就随之增加了。</p><h2>数据库实例分离</h2><p>在上面的例子里，微服务分开了，但是数据库实例并没有分开。虽然通过微服务的横向扩展，可以解决由于应用程序造成的性能瓶颈，但是如果性能瓶颈是由数据库引发的，那么拆分微服务的策略就无法解决问题了。这时候，就可以考虑“数据库实例分离”的策略了。</p><p>数据库实例分离的架构图是后面这样。<br>\n<img src=\"https://static001.geekbang.org/resource/image/77/9d/772323c076a73ddf91d4fe5b631dbf9d.jpg?wh=2236x2266\" alt=\"\"></p><p>采用这种策略时，我们把数据库实例也分成了两个，分别用于命令和查询两种数据模型。</p><p>数据库之间用“变更数据捕获”（change data capture, 简称 CDC）机制来同步。目前有多种开源或商业的方案可以选择。多数方案的原理都是由命令模型的数据库日志的变化来触发，然后同步到查询模型的数据库。</p><p>除了通过数据库底层机制来同步数据以外，我们还可以在应用程序层面同步数据。</p><p><img src=\"https://static001.geekbang.org/resource/image/27/33/2748c4f720e8790ac0f2e4bf44485e33.jpg?wh=2236x2266\" alt=\"\"></p><p>上面的架构图中，我们又使用了一个自定义的衍型 &lt;&lt;event&gt;&gt; ，表示当<strong>工时记录已创建</strong>、<strong>工时记录已更改</strong>和<strong>工时记录已删除</strong>三个领域事件发生时，这三个事件会被发送到消息队列（message queue）。之后，订阅了这些事件的服务就会被触发，然后进行相应的处理。在这个例子中，相应的处理就是指对数据的同步。</p><p>数据库实例分离以后，查询模型库就未必是关系型数据库了，我们可以选择 NoSql 数据库、内存数据库或其他数据存储技术。</p><p>数据库实例分离策略的好处是查询数据库可以横向扩展，可以灵活地选择数据存储机制，比较容易解决数据库造成的性能瓶颈。代价是增加了数据同步的复杂性，数据同步的延迟也可能会更高。</p><h2>各种策略的组合</h2><p>到现在，我们学习了 CQRS 四个层面的策略，分别是“代码结构分离”“数据库结构分离”“应用服务分离”和“数据库实例分离”。其中，“代码结构分离”是其他几种策略的基础，一般来说对于 CQRS 是必选的。</p><p>而其他三种策略都是可选的。而且，虽然咱们讲课的时候是按照层层递进的方式讲的，但其实这三种策略之间并没有依赖关系，你可以根据情况灵活组合使用。你可以先想想，一共有多少种组合，各自的优缺点是什么。</p><p>由于一共三种可选策略，每种都有使用和不使用两种选择，所以一共就可以有 8 种组合。我帮你梳理了一张策略选择表，列出了 8 种组合的主要优缺点。</p><p><img src=\"https://static001.geekbang.org/resource/image/7b/3e/7b721db307784a868918dbfc6cd86b3e.jpg?wh=3600x2557\" alt=\"\"></p><h2>为了实现命令进行的查询</h2><p>最后，我再说一个微妙的问题。前面说命令和查询分离，给你的感觉可能是所有的数据库查询，都要绕过领域模型吧？</p><p>其实，有一种查询一般来说不会绕过领域模型，这种查询就是“为了实现命令而进行的查询”。比如说，修改员工信息，相应的应用服务可以经过后面这四个步骤。</p><p>第一步，把这个员工聚合从数据库里查询出来。</p><p>第二步，进行校验，看看是否符合修改的条件。</p><p>第三步，在内存中对员工聚合进行修改。</p><p>第四步，把修改的员工聚合存回数据库。</p><p>这里面的第一步，就是为了实现命令而进行的查询。这种查询，一般仍然要在命令处理器内部做，而不是在查询处理器中完成。</p><p>这是因为，这种查询的目的就是查出领域对象，然后进一步执行领域逻辑。而查询模型中的表结构可能已经按照查询的要求进行了反规范化，返回结果也是DTO而不是领域对象，这时候，转换回领域模型反而会更麻烦了。</p><p>这个问题，我们也可以从另一个角度来理解。CQRS 中的 Q（查询），指的其实是来自客户端的意图。也就是说，客户端的目的就是查询，才算是 CQRS 里的 Q，如果客户端的目的是增、删、改，在这个过程中发生的查询，一般不算是 CQRS 里的 Q。</p><h2>总结</h2><p>好，这节课的主要内容就讲完了，下面来总结一下。</p><p>今天我们学习了 CQRS 的另外两种策略，“应用服务分离”和“数据库实例分离”。我们还需要了解每种策略的优点和代价，这样才能结合项目实际情况，选择适合的策略。</p><p>对于 CQRS 来说，“代码结构分离”是必选的，其他几种则是可选的，并且相对独立，可以根据情况组合使用。 我们用表格总结了 8 种组合的主要优缺点。</p><p>另外，我们还讨论了“为了实现命令而进行的查询”其实不算 CQRS 里的 Q，而是应该在命令处理器中处理。不要小看了这个问题，虽然只是个细节，但也给不少小伙伴的实践带来过困扰。</p><p>学习了CQRS这两节课以后，不知道你的收获如何？之后，如果再有人对 CQRS 有不同意见，你就不要和他笼统地谈，而是问他，他所理解的是哪个层面的 CQRS。然后，根据他实际所指的含义来进行讨论，这样就比较容易达成一致了。</p><p>下节课，我们来聊聊怎样用分析模式解决更加复杂的建模问题，敬请期待。</p><h2>思考题</h2><p>最后给你留两道思考题。</p><p>1.其实我们之前还提出了另外两个需求。一个需求是给定一个时间段，可以看到某员工在这个时期内各个工时项的累计工时信息；另一个需求是，给定一个项目，可以看到这个项目下各成员的累计工时信息。你觉得可以有哪些方法实现这两个需求呢？</p><p>2.你以前是否用过 CDC 工具，可否分享一下你的使用经验，比较一下不同 CDC 工具的特点？</p><p>好，今天的课程结束了，有什么问题欢迎你在评论区留言，下节课再见。</p>","comments":[{"had_liked":false,"id":369729,"user_name":"aoe","can_delete":false,"product_type":"c1","uid":1121758,"ip_address":"浙江","ucode":"1C6201EDB4E954","user_header":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","comment_is_top":false,"comment_ctime":1677848352,"is_pvip":false,"replies":[{"id":134723,"content":"你能注意到这一点非常好！\n有些同学读这一段，可能就略过去了。","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1677918380,"ip_address":"广东","comment_id":369729,"utype":1}],"discussion_count":5,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"“为了实现命令而进行的查询”其实不算 CQRS 里的 Q，而是应该在命令处理器中处理，这点提醒的太及时了，不然不知道什么时候才能从迷惑中走出来","like_count":8,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607472,"discussion_content":"你能注意到这一点非常好！\n有些同学读这一段，可能就略过去了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677918380,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":607647,"discussion_content":"纯粹出于准备跟着老师的课程写代码，多注意文章中的内容，可以少走弯路","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1678066511,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":607472,"ip_address":"浙江","group_id":0},"score":607647,"extra":""},{"author":{"id":1336475,"avatar":"https://static001.geekbang.org/account/avatar/00/14/64/9b/d1ab239e.jpg","nickname":"J.Smile","note":"","ucode":"C4D98DFDBF7584","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632377,"discussion_content":"有这么舔的吗😂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1700721426,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":607647,"ip_address":"广东","group_id":0},"score":632377,"extra":""}]},{"author":{"id":2532272,"avatar":"https://static001.geekbang.org/account/avatar/00/26/a3/b0/3ad0a504.jpg","nickname":"🍊 Niko","note":"","ucode":"FEF9B603D882A2","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":642198,"discussion_content":"为了实现命令而进行的查询，应该走哪个库呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1713407496,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1121758,"avatar":"https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg","nickname":"aoe","note":"","ucode":"1C6201EDB4E954","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2532272,"avatar":"https://static001.geekbang.org/account/avatar/00/26/a3/b0/3ad0a504.jpg","nickname":"🍊 Niko","note":"","ucode":"FEF9B603D882A2","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":642254,"discussion_content":"不好意思，我已经不记得了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1713440007,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":642198,"ip_address":"浙江","group_id":0},"score":642254,"extra":""}]}]},{"had_liked":false,"id":369614,"user_name":"Fredo","can_delete":false,"product_type":"c1","uid":1438470,"ip_address":"广东","ucode":"681D6692617DAB","user_header":"https://static001.geekbang.org/account/avatar/00/15/f3/06/8da1bf0c.jpg","comment_is_top":false,"comment_ctime":1677728965,"is_pvip":false,"replies":[{"id":134731,"content":"是的，CQRS不是必须要用的\n","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1677919952,"ip_address":"广东","comment_id":369614,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"1. 如果查询比较简单，是不是可以直接走领域模型，而不用 Q\n2. 搜索场景，canal 增量同步 ES；flink CDC 同步到数仓","like_count":4,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607482,"discussion_content":"是的，CQRS不是必须要用的\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677919952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1803623,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/85/67/0d121bc4.jpg","nickname":"神经蛙","note":"","ucode":"2D71FC12E420AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607431,"discussion_content":"666","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677857128,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371064,"user_name":"你来吧","can_delete":false,"product_type":"c1","uid":2839519,"ip_address":"浙江","ucode":"156377BDE53D4E","user_header":"https://static001.geekbang.org/account/avatar/00/2b/53/df/77fa7fbd.jpg","comment_is_top":false,"comment_ctime":1679497822,"is_pvip":false,"replies":[{"id":135353,"content":"https:&#47;&#47;github.com&#47;zhongjinggz&#47;geekdemo 目前放出了迭代1的，后面的正在逐渐补充","user_name":"编辑回复","user_name_real":"编辑","uid":1501385,"ctime":1679537080,"ip_address":"北京","comment_id":371064,"utype":2}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"手把手教你落地DDD的源代码在哪里呢","like_count":1,"discussions":[{"author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"听水的湖","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610345,"discussion_content":"https://github.com/zhongjinggz/geekdemo 目前放出了迭代1的，后面的正在逐渐补充","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679537080,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":8}","child_discussion_number":2,"child_discussions":[{"author":{"id":1129601,"avatar":"https://static001.geekbang.org/account/avatar/00/11/3c/81/7ccdb399.jpg","nickname":"+ 糠","note":"","ucode":"2D5A91900FCA43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"听水的湖","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"discussion":{"id":630871,"discussion_content":"几时把迭代3的补充一下\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1698998236,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":610345,"ip_address":"广东","group_id":0},"score":630871,"extra":""},{"author":{"id":1501385,"avatar":"https://static001.geekbang.org/account/avatar/00/16/e8/c9/59bcd490.jpg","nickname":"听水的湖","note":"","ucode":"B1759F90165D81","race_medal":0,"user_type":8,"is_pvip":false},"reply_author":{"id":1129601,"avatar":"https://static001.geekbang.org/account/avatar/00/11/3c/81/7ccdb399.jpg","nickname":"+ 糠","note":"","ucode":"2D5A91900FCA43","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":631145,"discussion_content":"收到催更，老师在写书中，等他忙过这几个月的。有具体的问题可以留言提问。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1699343015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":630871,"ip_address":"北京","group_id":0},"score":631145,"extra":""}]}]},{"had_liked":false,"id":380232,"user_name":"黑夜看星星","can_delete":false,"product_type":"c1","uid":2760458,"ip_address":"广东","ucode":"20A2FDA0CC5DC1","user_header":"https://static001.geekbang.org/account/avatar/00/2a/1f/0a/3dd0cabc.jpg","comment_is_top":false,"comment_ctime":1693235914,"is_pvip":false,"replies":[{"id":138566,"content":"一般用 create database 语句可以创建一个 database 也就是数据库实例。数据库结构分离，指的是有两套表，但还在同一个 database; 数据库实例分离，指的是在两个不同的 database.","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1693554938,"ip_address":"广东","comment_id":380232,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"老师，请教数据库结构分离和数据库实例分离的区别","like_count":0,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":626978,"discussion_content":"一般用 create database 语句可以创建一个 database 也就是数据库实例。数据库结构分离，指的是有两套表，但还在同一个 database; 数据库实例分离，指的是在两个不同的 database.","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1693554938,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":2760458,"avatar":"https://static001.geekbang.org/account/avatar/00/2a/1f/0a/3dd0cabc.jpg","nickname":"黑夜看星星","note":"","ucode":"20A2FDA0CC5DC1","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":628560,"discussion_content":"学习了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695526029,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":626978,"ip_address":"广东","group_id":0},"score":628560,"extra":""}]}]},{"had_liked":false,"id":373260,"user_name":"NoSuchMethodError","can_delete":false,"product_type":"c1","uid":3326684,"ip_address":"江苏","ucode":"F227B98677E3C3","user_header":"https://static001.geekbang.org/account/avatar/00/32/c2/dc/78e809b7.jpg","comment_is_top":false,"comment_ctime":1682327041,"is_pvip":false,"replies":[{"id":136608,"content":"如果仅仅是查询功能，那么不用","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1683373301,"ip_address":"广东","comment_id":373260,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"比如领域服务中需要查询list，list中的item是聚合根，且只需要item中的部分属性，那么还需要挨个重新生成聚合根嘛","like_count":0,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":617199,"discussion_content":"如果仅仅是查询功能，那么不用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1683373301,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1047442,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/fb/92/4de0c05c.jpg","nickname":"bin","note":"","ucode":"F540DADF3AAD87","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":646200,"discussion_content":"其实也可以，列表里面的聚合根从缓存加载就很快了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1717549120,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372733,"user_name":"胡昌龙","can_delete":false,"product_type":"c1","uid":1077216,"ip_address":"浙江","ucode":"DE958CE0241576","user_header":"https://static001.geekbang.org/account/avatar/00/10/6f/e0/ddfc33a5.jpg","comment_is_top":false,"comment_ctime":1681521035,"is_pvip":false,"replies":[{"id":136131,"content":"需要了解更多背景，才能准确回答。营销补贴规则这个聚合有哪几个领域对象组成、作为一个聚合的理由是什么？这些对象各有多少属性？计算时希望用到属性有多少？来自于哪个对象？等等。\n现在只能按常理回答一下，如果要用到的对象总共字段不多，比如5个，用到其中3个，那么整体拿出来也不会影响太大性能。如果对象字段很多，比如几十个，那么就应该进一步拆成值对象或实体。拆分的时候，不完全是按照使用的需求，而是按照业务概念。由于是按照业务概念，所以即使有不同的计算场景，拆出的实体或值对象也应该基本上保持稳定。","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1681633106,"ip_address":"广东","comment_id":372733,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"钟老师，如果一个聚合如营销补贴计算。需要用到同一限界上下文里的另一个聚合 如营销补贴规则。考虑到性能，此时希望从数据库只查询出补贴规则的局部属性，是建一个新的值对象类来接收并参与运算，还是使用原来的补贴规则聚合对象类，只是对局部属性赋值呢（感觉模型重建就不完整啦）？假设新建值对象类，那如果有多种计算场景，需要用到不同的补贴规则局部属性，这样会导致建出很多的类来，这些个类放在哪里又比较合适？","like_count":0,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":614013,"discussion_content":"需要了解更多背景，才能准确回答。营销补贴规则这个聚合有哪几个领域对象组成、作为一个聚合的理由是什么？这些对象各有多少属性？计算时希望用到属性有多少？来自于哪个对象？等等。\n现在只能按常理回答一下，如果要用到的对象总共字段不多，比如5个，用到其中3个，那么整体拿出来也不会影响太大性能。如果对象字段很多，比如几十个，那么就应该进一步拆成值对象或实体。拆分的时候，不完全是按照使用的需求，而是按照业务概念。由于是按照业务概念，所以即使有不同的计算场景，拆出的实体或值对象也应该基本上保持稳定。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681633106,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372665,"user_name":"胡昌龙","can_delete":false,"product_type":"c1","uid":1077216,"ip_address":"上海","ucode":"DE958CE0241576","user_header":"https://static001.geekbang.org/account/avatar/00/10/6f/e0/ddfc33a5.jpg","comment_is_top":false,"comment_ctime":1681431020,"is_pvip":false,"replies":[{"id":136134,"content":"已经在另一个问题里统一回复了","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1681633303,"ip_address":"广东","comment_id":372665,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"钟老师，如果一个聚合如营销补贴计算。需要用到同一限界上下文里的另一个聚合 如营销补贴规则。考虑到性能，此时希望从数据库只查询出补贴规则的局部属性，是建一个新的值对象类来接收并参与运算，还是使用原来的补贴规则聚合对象类，只是对局部属性赋值呢（感觉模型重建就不完整啦）？假设新建值对象类，那如果有多种计算场景，需要用到不同的补贴规则局部属性，这样会导致建出很多的类来，这些个类放在哪里又比较合适？","like_count":0,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":614016,"discussion_content":"已经在另一个问题里统一回复了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681633303,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372662,"user_name":"胡昌龙","can_delete":false,"product_type":"c1","uid":1077216,"ip_address":"上海","ucode":"DE958CE0241576","user_header":"https://static001.geekbang.org/account/avatar/00/10/6f/e0/ddfc33a5.jpg","comment_is_top":false,"comment_ctime":1681428447,"is_pvip":false,"replies":[{"id":136133,"content":"在另一个题里统一回复了","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1681633284,"ip_address":"广东","comment_id":372662,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"钟老师，如果一个聚合如营销补贴计算。需要用到同一限界上下文里的另一个聚合 如营销补贴规则。考虑到性能，此时希望从数据库只查询出补贴规则的局部属性，是建一个新的值对象类来接收并参与运算，还是使用原来的补贴规则聚合对象类，只是对局部属性赋值呢（感觉模型重建就不完整啦）？假设新建值对象类，那如果有多种计算场景，需要用到不同的补贴规则局部属性，这样会导致建出很多的类来，这些个类放在哪里又比较合适？","like_count":0,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":614015,"discussion_content":"在另一个题里统一回复了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681633284,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372523,"user_name":"杰","can_delete":false,"product_type":"c1","uid":1109562,"ip_address":"广东","ucode":"036B010A45070A","user_header":"https://static001.geekbang.org/account/avatar/00/10/ee/3a/c0ad9c43.jpg","comment_is_top":false,"comment_ctime":1681256326,"is_pvip":false,"replies":[{"id":136001,"content":"在“Q”的部分是这样的","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1681304405,"ip_address":"广东","comment_id":372523,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"老师，如果是应用和数据库都不分离的情况，用cqrs是不是可以理解为我直接跟以前一样，使用表关联查询就行？","like_count":0,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":613409,"discussion_content":"在“Q”的部分是这样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681304405,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1129601,"avatar":"https://static001.geekbang.org/account/avatar/00/11/3c/81/7ccdb399.jpg","nickname":"+ 糠","note":"","ucode":"2D5A91900FCA43","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":630872,"discussion_content":"啥意思？不是说最基础也要代码结构分离，分成2个包吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1698998323,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":613409,"ip_address":"广东","group_id":0},"score":630872,"extra":""}]}]},{"had_liked":false,"id":369422,"user_name":"6点无痛早起学习的和尚","can_delete":false,"product_type":"c1","uid":1703256,"ip_address":"北京","ucode":"33A8A1CDA103F9","user_header":"https://static001.geekbang.org/account/avatar/00/19/fd/58/1af629c7.jpg","comment_is_top":false,"comment_ctime":1677543539,"is_pvip":false,"replies":[{"id":134783,"content":"是累计工时实践。sql 语句里少了 sum()，应该group by emp_id","user_name":"作者回复","user_name_real":"编辑","uid":1288110,"ctime":1677932297,"ip_address":"广东","comment_id":369422,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100311801,"comment_content":"思考题：\n1. 需求一：没有说清楚累计工时信息是不是 累计工时时间？\n直接 select effort_item_id,xxx effort_record where emp_id = xxx and 时间区间 group by effort_item_id\n\n需求二：把项目表、工时项、工时记录表 join\n\n越到后面，留言越少","like_count":0,"discussions":[{"author":{"id":1288110,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/VBLEAcychgbs5CicUczSYcibicoicZmyk1JHHFiae94KuvVsibAKtcQAvnOPWp0C4yvia8mzvQAORiazjWSoc1XQ9QkLrQ/132","nickname":"钟敬","note":"","ucode":"20B3D31A2C8C86","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607541,"discussion_content":"是累计工时实践。sql 语句里少了 sum()，应该group by emp_id","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677932297,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1803623,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/85/67/0d121bc4.jpg","nickname":"神经蛙","note":"","ucode":"2D71FC12E420AB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607432,"discussion_content":"挺好的课 很适合入门","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677857285,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372661,"user_name":"胡昌龙","can_delete":false,"product_type":"c1","uid":1077216,"ip_address":"上海","ucode":"DE958CE0241576","user_header":"https://static001.geekbang.org/account/avatar/00/10/6f/e0/ddfc33a5.jpg","comment_is_top":false,"comment_ctime":1681427935,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100311801,"comment_content":"钟老师，如果是一个聚合（如营销补贴计算）的命令，用到同一个限界上下文另一个聚合（营销补贴规则）的查询，此时考虑到性能，希望只从数据库查询出部分补贴规则的属性，此时是创建新的补贴规则值对象，还是直接重建出带有部分属性的补贴规则聚合呢（感觉模型重建不完整）？假设创建新的值对象，那如果有多种补贴计算场景需要用到不同的补贴规则局部属性，就可能建出很多新entity出来，这些个类又放在哪里合适？感谢\n\n备注：","like_count":0},{"had_liked":false,"id":372660,"user_name":"胡昌龙","can_delete":false,"product_type":"c1","uid":1077216,"ip_address":"上海","ucode":"DE958CE0241576","user_header":"https://static001.geekbang.org/account/avatar/00/10/6f/e0/ddfc33a5.jpg","comment_is_top":false,"comment_ctime":1681427186,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100311801,"comment_content":"钟老师，如果一个聚合（如营销补贴计算）的命令逻辑，需要用到另一个聚合（如营销补贴规则）里面的少部分字段，因为并发量较高，考虑到性能希望只从数据库查询出部分字段，而不是重建整个补贴规则聚合出来，这时怎么处理合适？如果有多种补贴计算场景分别需要不同的补贴规则局部属性，是分别创建多个补贴规则的值对象，还是都用补贴规则这个领域模型实体（也就是同一个实体类），只是每次只赋需要的那几个字段的属性（感觉只重建了部分，会带来模型不完整的问题）？\n\n备注：是命令计算里的q哈，只是q了另一个关联紧密的聚合而已","like_count":0}]}