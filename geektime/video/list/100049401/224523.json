{"id":224523,"title":"15 | 服务入口：用Service Entry扩展你的网格服务","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":220602,"user_name":"3Golds","can_delete":false,"product_type":"c3","uid":1203477,"ip_address":"","ucode":"A27DEF9616432A","user_header":"https://static001.geekbang.org/account/avatar/00/12/5d/15/7df9df88.jpg","comment_is_top":false,"comment_ctime":1590292689,"is_pvip":false,"replies":[{"id":81539,"content":"👍","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1590410560,"ip_address":"","comment_id":220602,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"1.6默认从configmap过滤不到了, 用1.6的同学可以自行增加以下字段到configmap\n\n```\n    outboundTrafficPolicy:\n      mode: REGISTRY_ONLY\n```","like_count":5,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":496185,"discussion_content":"👍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1590410560,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"ileruza","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":576501,"discussion_content":"mesh: |-\n    accessLogEncoding: TEXT\n    accessLogFile: /dev/stdout\n    accessLogFormat: &#34;&#34;\n    outboundTrafficPolicy:\n        mode: REGISTRY_ONLY\n\n\n要讲就能不能讲清楚一点……","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1655609461,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":223152,"user_name":"骨汤鸡蛋面","can_delete":false,"product_type":"c3","uid":1050002,"ip_address":"","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1591010165,"is_pvip":false,"replies":[{"id":82331,"content":"首先确认一下非mesh的服务是否需要纳入到mesh内进行流控？如果不需要，就不用非得用ServiceEntry。\nmesh服务和非mesh服务建议分namespace，方便管理，逐步迁移。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1591092437,"ip_address":"","comment_id":223152,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，我在研究如何将mesh 落地到公司，公司已有的容器集群 没办法一下子全切入到mesh 中来，比如有一部分pod 有envoy sidecar ，有一部分pod 没有envoy，我今天尝试使用istio ingress 访问不带sidecar的pod时，返回no healthy upstream\n请问这个问题能用 ServiceEntry 解决嘛？或者更优雅的方式老师可以指点一下嘛？","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":497030,"discussion_content":"首先确认一下非mesh的服务是否需要纳入到mesh内进行流控？如果不需要，就不用非得用ServiceEntry。\nmesh服务和非mesh服务建议分namespace，方便管理，逐步迁移。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1591092437,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210382,"user_name":"思维决定未来","can_delete":false,"product_type":"c3","uid":1412891,"ip_address":"","ucode":"88CC245B3C6E2D","user_header":"","comment_is_top":false,"comment_ctime":1587733361,"is_pvip":false,"replies":[{"id":78428,"content":"简单来说：\n1. 如果resolution配的是DNS，没有配置endpoint，它会配合hosts字段进行解析；\n2. 如果设置了endpoint为具体IP，resolution就要设置为STATIC，表示直接使用IP，不用解析；\n3. 如果resolution配的是DNS，也配置了endpoint，会解析endpoint里设置的地址；\n4. address这个字段是关联服务的VIP地址，对HTTP是不生效的。\n可以再仔细琢磨下这个示例：\napiVersion: networking.istio.io&#47;v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: external-svc-mongocluster\nspec:\n  hosts:\n  - mymongodb.somedomain # not used\n  addresses:\n  - 192.192.192.192&#47;24 # VIPs\n  ports:\n  - number: 27018\n    name: mongodb\n    protocol: MONGO\n  location: MESH_INTERNAL\n  resolution: STATIC\n  endpoints:\n  - address: 2.2.2.2\n  - address: 3.3.3.3\n","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1587808356,"ip_address":"","comment_id":210382,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师能详细讲下resolution，addresses和endpoint这几个参数的配合使用吗？看了官方文档还是似懂非懂","like_count":1,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493010,"discussion_content":"简单来说：\n1. 如果resolution配的是DNS，没有配置endpoint，它会配合hosts字段进行解析；\n2. 如果设置了endpoint为具体IP，resolution就要设置为STATIC，表示直接使用IP，不用解析；\n3. 如果resolution配的是DNS，也配置了endpoint，会解析endpoint里设置的地址；\n4. address这个字段是关联服务的VIP地址，对HTTP是不生效的。\n可以再仔细琢磨下这个示例：\napiVersion: networking.istio.io/v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: external-svc-mongocluster\nspec:\n  hosts:\n  - mymongodb.somedomain # not used\n  addresses:\n  - 192.192.192.192/24 # VIPs\n  ports:\n  - number: 27018\n    name: mongodb\n    protocol: MONGO\n  location: MESH_INTERNAL\n  resolution: STATIC\n  endpoints:\n  - address: 2.2.2.2\n  - address: 3.3.3.3\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587808356,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2037440,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/16/c0/753248c0.jpg","nickname":"MonsterSquad","note":"","ucode":"D13ABF4B906A8B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372501,"discussion_content":"老师 这个endpoints中的address是真实mongodb的地址吗（我理解为Pod地址），那spec.address对应的VIPS就是K8s原生的service吗（我理解为k8s原生service 的地址，那么如果是我写成headerless的域名mymongodb.dev「后面.svc.cluster.local省略」我的location就得写成DNS），老师是这样理解的吗","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620356537,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":247887,"user_name":"肥小肉","can_delete":false,"product_type":"c3","uid":1934265,"ip_address":"","ucode":"9BAE9BE5734B38","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTINjIqCwibaXkoq9acCZg7YnEXKYFT20ng01sCHf6iaLlkSdRIJ15F8olsBicMZwT9IIPa2OlNrdicgJA/132","comment_is_top":false,"comment_ctime":1599902453,"is_pvip":false,"replies":[{"id":91192,"content":"这个不应该啊，istioctl profile diff default demo 看看是不是profile有什么问题。不行再重新安装一下","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1600060980,"ip_address":"","comment_id":247887,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"安装istio1.7，按照命令帮助提示用下列命令安装demo配置\nistioctl install --set profile=demo --skip-confirmation\n安装好后只有istiod ingress egress三个服务，那些demo应该有的kiali，jager等都没有","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":505521,"discussion_content":"这个不应该啊，istioctl profile diff default demo 看看是不是profile有什么问题。不行再重新安装一下","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600060980,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1005634,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/58/42/abb7bfe3.jpg","nickname":"eric-xin","note":"","ucode":"B10BB7796CDF6B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":366953,"discussion_content":"用这个命令：istioctl manifest apply --set profile=demo \n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618223491,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1934265,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTINjIqCwibaXkoq9acCZg7YnEXKYFT20ng01sCHf6iaLlkSdRIJ15F8olsBicMZwT9IIPa2OlNrdicgJA/132","nickname":"肥小肉","note":"","ucode":"9BAE9BE5734B38","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":305693,"discussion_content":"我只好再使用命令才安装好那几个插件\nkubectl apply -f samples/addones -n istio-system","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1600061252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":242033,"user_name":"彬少","can_delete":false,"product_type":"c3","uid":1460396,"ip_address":"","ucode":"B4A7FDC62C48B1","user_header":"https://static001.geekbang.org/account/avatar/00/16/48/ac/045a2ccb.jpg","comment_is_top":false,"comment_ctime":1597567010,"is_pvip":false,"replies":[{"id":89582,"content":"你说的都对，主要是看你需不需要把外部流量纳入到mesh统一管理，如果不需要，你的解决方案都ok。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1597919134,"ip_address":"","comment_id":242033,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"课后习题，配置针对https协议的服务入口。\napiVersion: networking.istio.io&#47;v1alpha3\nkind: ServiceEntry\nmetadata:\n name: baidu-portal\nspec:\n hosts:\n - www.baidu.com\n ports:\n - number: 443\n   name: https-port\n   protocol: HTTPS\n resolution: DNS\n\n另外想请教一下老师，serviceEntry在生产环境应用得多不多，有什么具体的业务场景适用？感觉如果只是控制外部资源是否可访问，一般都会在安全工具上添加限制；如果是外部资源处理能力不佳需要限流，也是要结合具体业务在业务系统中进行控制比较合适。","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503907,"discussion_content":"你说的都对，主要是看你需不需要把外部流量纳入到mesh统一管理，如果不需要，你的解决方案都ok。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597919134,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":230069,"user_name":"龚巧","can_delete":false,"product_type":"c3","uid":1045844,"ip_address":"","ucode":"97FABC0B91971A","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f5/54/8062d599.jpg","comment_is_top":false,"comment_ctime":1593250328,"is_pvip":false,"replies":[{"id":85008,"content":"kubectl get configmap istio -n istio-system -o yaml | sed &#39;s&#47;mode: ALLOW_ANY&#47;mode: ALLOW_ANYREGISTRY_ONLY&#47;g&#39; | kubectl replace -n istio-system -f -\n先看看configmap生效没；\n另外你是怎么访问的？访问外网的服务是否注入了sidecar？","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1593334628,"ip_address":"","comment_id":230069,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"我 istio 1.5.1 版本 configmap   outboundTrafficPolicy: mode: REGISTRY_ONLY  没有定义服务入口还是直接可以访问外网？哪里设置的有问题？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":499752,"discussion_content":"kubectl get configmap istio -n istio-system -o yaml | sed &amp;#39;s/mode: ALLOW_ANY/mode: ALLOW_ANYREGISTRY_ONLY/g&amp;#39; | kubectl replace -n istio-system -f -\n先看看configmap生效没；\n另外你是怎么访问的？访问外网的服务是否注入了sidecar？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1593334628,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1600767,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epvYc3REh3jaTt9hPxj4alDicbzsawNyvaxMCTKcPHtK2b8EoI0HTsicaTzsrVo2hBhl9tbGXiaUxFYA/132","nickname":"WandaYu","note":"","ucode":"17D97DF0803BF4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":365603,"discussion_content":"k8s 1.14, istio 1.15.1 \n替换了还是可以访问公网\n\n$ kubectl get configmap istio -n istio-system -o yaml | sed &#39;s/mode: ALLOW_ANY/mode: ALLOW_ANYREGISTRY_ONLY/g&#39; | kubectl replace -n istio-system -f -\nconfigmap/istio replaced\n\n$ kbe sleep-666475687f-f8xnr -c sleep curl http://httpbin.org/headers\nkubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.\n{\n  &#34;headers&#34;: {\n    &#34;Accept&#34;: &#34;*/*&#34;,\n    &#34;Content-Length&#34;: &#34;0&#34;,\n    &#34;Host&#34;: &#34;httpbin.org&#34;,\n    &#34;User-Agent&#34;: &#34;curl/7.69.1&#34;,\n    &#34;X-Amzn-Trace-Id&#34;: &#34;Root=1-606e69c0-3e2293ac11fd2a652e2d827a&#34;,\n    &#34;X-B3-Sampled&#34;: &#34;1&#34;,\n    &#34;X-B3-Spanid&#34;: &#34;001bde352601dc9e&#34;,\n    &#34;X-B3-Traceid&#34;: &#34;fd18b098c7f43bc3001bde352601dc9e&#34;,\n    &#34;X-Envoy-Peer-Metadata&#34;: &#34;ChwKDElOU1RBTkNFX0lQUxIMGgoxMC4xLjAuMTE1CsQBCgZMQUJFTFMSuQEqtgEKDgoDYXBwEgcaBXNsZWVwCiEKEXBvZC10ZW1wbGF0ZS1oYXNoEgwaCjY2NjQ3NTY4N2YKJAoZc2VjdXJpdHkuaXN0aW8uaW8vdGxzTW9kZRIHGgVpc3RpbwoqCh9zZXJ2aWNlLmlzdGlvLmlvL2Nhbm9uaWNhbC1uYW1lEgcaBXNsZWVwCi8KI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEggaBmxhdGVzdAoaCgdNRVNIX0lEEg8aDWNsdXN0ZXIubG9jYWwKIAoETkFNRRIYGhZzbGVlcC02NjY0NzU2ODdmLWY4eG5yChYKCU5BTUVTUEFDRRIJGgdkZWZhdWx0CkkKBU9XTkVSEkAaPmt1YmVybmV0ZXM6Ly9hcGlzL2FwcHMvdjEvbmFtZXNwYWNlcy9kZWZhdWx0L2RlcGxveW1lbnRzL3NsZWVwChoKD1NFUlZJQ0VfQUNDT1VOVBIHGgVzbGVlcAoYCg1XT1JLTE9BRF9OQU1FEgcaBXNsZWVw&#34;,\n    &#34;X-Envoy-Peer-Metadata-Id&#34;: &#34;sidecar~10.1.0.115~sleep-666475687f-f8xnr.default~default.svc.cluster.local&#34;\n  }\n}\n\n$ k get pod | grep -i sleep\nsleep-666475687f-f8xnr            2/2     Running   0          15h\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1617848865,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":3684311,"avatar":"","nickname":"Geek_b04bc8","note":"","ucode":"143D8631AF1A4E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1600767,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epvYc3REh3jaTt9hPxj4alDicbzsawNyvaxMCTKcPHtK2b8EoI0HTsicaTzsrVo2hBhl9tbGXiaUxFYA/132","nickname":"WandaYu","note":"","ucode":"17D97DF0803BF4","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":624783,"discussion_content":"新版本已经不是在configmap中控制了，你可以看一下官方文档","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1690904952,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":365603,"ip_address":"浙江","group_id":0},"score":624783,"extra":""}]}]},{"had_liked":false,"id":212257,"user_name":"Geek_2655db","can_delete":false,"product_type":"c3","uid":1809331,"ip_address":"","ucode":"3BC81783F791BD","user_header":"","comment_is_top":false,"comment_ctime":1588080371,"is_pvip":false,"replies":[{"id":78988,"content":"咱们先确定一个问题：存量系统的部署环境是什么？是云上？实体机？K8s？如果不是基于k8s的，istio是没法管理的，不过可以选择托管的mesh服务，比如aws appmesh。\n假设第一个问题满足要求（k8s），那么第二点：“管理底层通讯和流量” ，我理解没错的话，是有其他系统（或服务）通过ServiceEntry访问存量系统？如果是这样的话，这个访问存量系统的，是下游系统（服务），需要接入istio，存量系统不需要任何侵入。当然前提是它能提供可支持的协议（http&#47;grpc等）","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588159595,"ip_address":"","comment_id":212257,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，请教下，我们现在有存量系统，我想是不是可以基于serviceEntry来管理这些存量系统的底层通讯和流量，当然，前提条件是对这些存量系统没有任何的侵入性改造，是否可以实现，有没有什么需要满足的前置条件？","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493462,"discussion_content":"咱们先确定一个问题：存量系统的部署环境是什么？是云上？实体机？K8s？如果不是基于k8s的，istio是没法管理的，不过可以选择托管的mesh服务，比如aws appmesh。\n假设第一个问题满足要求（k8s），那么第二点：“管理底层通讯和流量” ，我理解没错的话，是有其他系统（或服务）通过ServiceEntry访问存量系统？如果是这样的话，这个访问存量系统的，是下游系统（服务），需要接入istio，存量系统不需要任何侵入。当然前提是它能提供可支持的协议（http/grpc等）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588159595,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1809331,"avatar":"","nickname":"Geek_2655db","note":"","ucode":"3BC81783F791BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":252969,"discussion_content":"感谢老师解惑！\n一、\n1.存量系统跑在虚拟机上；\n2.想基于k8s+istio构建一套防腐层，由这一层暴露(http/grpc)对下游系统的服务；\n3.防腐层通过ServiceEntry来管理存量系统的服务流量及通讯；\n4.我们负责存量系统的，不管下游系统好与不好，我们作为服务提供方还是需要保证自身的可用性及可观测性，所以想着是不是搞个这样的防腐层是可行的；\n二、\n1.课程中介绍了ServiceEntry和Gateway是相反的概念，我的理解是\na.ServiceEntry是用来控制网格内服务调用外部服务的，控制主体还是在网格内部的服务本身，而这个服务在使用场景中扮演的消费者的角色\nb.Gateway是用来控制外部服务调用网格内服务的，控制主体也是网格内部的服务本身，而这个服务在使用场景中扮演的是服务者的角色\nc.b中所述Gateway准确点，应该是指Ingress Gw，那Egress Gw和SE的区别在哪里？\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588208211,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1809331,"avatar":"","nickname":"Geek_2655db","note":"","ucode":"3BC81783F791BD","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":259715,"discussion_content":"求大佬解惑啊！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588812843,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355914,"user_name":"Brilliant","can_delete":false,"product_type":"c3","uid":1522168,"ip_address":"上海","ucode":"CFF4F5BCAF21EE","user_header":"https://static001.geekbang.org/account/avatar/00/17/39/f8/b5a1b669.jpg","comment_is_top":false,"comment_ctime":1661849482,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"```\n$ kc exec -it sleep-5887ccbb67-gqkdw -c sleep --  curl http:&#47;&#47;httpbin.org&#47;headers\ncurl: (6) Could not resolve host: httpbin.org\n```\n版本信息如下：\nistio相关\nclient version: 1.14.3\ncontrol plane version: 1.14.3\ndata plane version: 1.14.3 (9 proxies)\nk8s相关\nClient Version: v1.24.3\nKustomize Version: v4.5.4\nServer Version: v1.24.3+k3s1\n\n这边做了如下尝试\n1. 进入sleep容器中`$cat &#47;etc&#47;resolv.conf`, nameserver为kube-dns的serivce地址，在该容器中，直接curl同样提示无法解析\n2. 进入注入的istio-proxy容器中`$cat &#47;etc&#47;resolv.conf`, nameserver同上，在该容器中curl, 可以正常拿到数据","like_count":0},{"had_liked":false,"id":335525,"user_name":"Amosヾ","can_delete":false,"product_type":"c3","uid":1567014,"ip_address":"","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1645576143,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，如果想使用类似k8s endpoint的方式将外部流量管理起来，应该是使用se吧？那host该如何指定？","like_count":0}]}