{"id":625316,"title":"23｜如何监听镜像版本变化触发 GitOps？","content":"<p>你好，我是王炜。</p><p>上一节课，我带你学习了如何使用 ArgoCD 来创建生产可用的 GitOps 工作流。值得注意的是，我们创建的 GitOps 工作流有下面两个重要的特点。</p><ol>\n<li>源码和 Helm Chart 在同一个仓库下。</li>\n<li>在 CI 阶段更新了 Helm Chart 镜像版本。</li>\n</ol><p>在开发和发布分工明确的团队中，我更推荐你将源码和应用定义分离，考虑到安全性和发布的严谨性，也尽量不要通过 CI 直接修改应用定义。</p><p>更合理的研发规范设计应该是这样的：开发负责编写代码，并通过 CI 生成制品，也就是 Docker 镜像，并对生成的制品负责。而基础架构部门或者 SRE 团队则对应用定义负责。在发布环节，<strong>开发可以随时控制要发布的镜像版本，而无需关注其他的应用细节</strong>，他们之间的工作流程图如下。</p><p><img src=\"https://static001.geekbang.org/resource/image/ca/00/ca9a2a6b7c938738ae56153906e4b200.jpg?wh=1920x1267\" alt=\"图片\"></p><p>从上面这张工作流程图我们可以看出，开发和 SRE 团队各司其职，只操作和自己相关的 Git 仓库，互不干扰。但 SRE 团队要怎么知道开发团队什么时候发布以及发布什么版本的镜像呢？</p><p>最原始的办法是：开发在需要发布的时候将镜像版本告诉 SRE 团队，SRE 团队手动修改 Helm Chart 镜像版本并推送到 Git 仓库，等待 ArgoCD 同步完成。</p><p>这种办法虽然有效，但沟通效率低且容易出错，<strong>我们需要一种自动化的机制来替代这个过程</strong>。</p><!-- [[[read_end]]] --><p>借助 ArgoCD Image Updater，我们可以让 ArgoCD 自动监控镜像仓库的更新情况，一旦工作负载的镜像版本有更新，ArgoCD 就会自动将工作负载升级为新的镜像版本，并且还可以自动将镜像的版本号回写到 Helm Chart 仓库中，保持应用定义和集群状态的一致性。</p><p>这节课，我会进一步改造在上一节课创建的 GitOps 工作流，并加入 ArgoCD Image Updater，实现自动监听镜像变更以及回写 Helm Chart。</p><p>在开始今天的学习之前，你需要做好如下准备。</p><ul>\n<li>按照第一章<a href=\"https://time.geekbang.org/column/article/612571\">第 2 讲</a>的内容在本地配置好 Kind 集群，安装 Ingress-Nginx，并暴露 80 和 443 端口。</li>\n<li>配置好 Kubectl，使其能够访问 Kind 集群。</li>\n<li>按照上一节课的内容在集群内安装 ArgoCD 和 CLI 工具。</li>\n<li>克隆 <a href=\"https://github.com/lyzhang1999/kubernetes-example\">kubernetes-example</a> 示例应用代码并推送到自己的 GitHub 仓库中，然后按照<a href=\"https://time.geekbang.org/column/article/622743\">第 16 讲</a>的内容配置好 GitHub Action 和 DockerHub Registry。</li>\n<li>将示例应用 .github/workflows/argocd-image-updater.yaml 文件的 env.DOCKERHUB_USERNAME 字段修改为你的 DockerHub 用户名。</li>\n</ul><h2>工作流总览</h2><p>在正式进入实战之前，我先简单介绍一下我们最终要实现的效果，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/c2/27/c23e00e27754a19a91321c85bfba5e27.jpg?wh=1920x1400\" alt=\"图片\"></p><p>相比较上一节课的 GitOps 工作流，这节课实现的效果主要有下面两个差异。</p><ol>\n<li>将一个 Git 仓库拆分成了两个，一个存放源码，一个存放 Helm Chart。</li>\n<li>不再使用 CI 更新 Helm Chart 镜像版本，而是使用 ArgoCD Image Updater 来自动监控镜像仓库的变更。</li>\n</ol><p>此外，由于在日常开发中，我们一般会采用多分支进行开发，这就随时可能产生新的镜像版本。为了将开发过程和需要发布到生产环境的镜像区分开，我们会为 Main 分支构建出来的镜像增加一个 Prefix 标识，例如 <code>main-${commit_Id}</code>，并配置 ArgoCD Image Updater 只监控包含特定标识的镜像版本。</p><p>最终实现的效果是，当开发将代码提交到 Git 仓库 Main 分支后，将触发自动构建，并将新的镜像版本推送到镜像仓库。ArgoCD Image Updater 会以 Poll 的方式每 2 分钟检查一次工作负载的镜像是否有新的版本，如果有，那么就将工作负载的镜像更新为最新版本，并将镜像版本号写入到存放 Helm Chart 的仓库中。</p><h2>安装和配置 ArgoCD Image Updater</h2><p>监听镜像版本的变更需要用到 ArgoCD Image Updater，而它要求和 ArgoCD 一起协同工作，所以在安装之前，请务必先确保在集群内已经安装好 ArgoCD。</p><h3>安装 ArgoCD Image Updater</h3><p>你可以通过下面的命令进行安装。</p><pre><code class=\"language-plain\">kubectl apply -n argocd -f https://ghproxy.com/https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/stable/manifests/install.yaml\nserviceaccount/argocd-image-updater created\nrole.rbac.authorization.k8s.io/argocd-image-updater created\nrolebinding.rbac.authorization.k8s.io/argocd-image-updater created\n......\n</code></pre><h3>创建 Image Pull Secret（可选）</h3><p>由于 ArgoCD 会主动 Poll 镜像仓库来检查是否存在新版本，如果你使用的是私有镜像仓库，那么你需要创建 Secret 对象，以便为 ArgoCD 提供访问镜像仓库的权限。</p><p>以 DockerHub 仓库为例，执行下面的命令来创建 Secret 对象。</p><pre><code class=\"language-plain\">$ kubectl create -n argocd secret docker-registry dockerhub-secret \\\n&nbsp; --docker-username $DOCKER_USERNAME \\\n&nbsp; --docker-password $DOCKER_PERSONAL_TOKEN \\\n&nbsp; --docker-server \"https://registry-1.docker.io\"\n\nsecret/dockerhub-secret created\n</code></pre><p>注意将 <code>$DOCKER_USERNAME</code> 和 <code>$DOCKER_PERSONAL_TOKEN</code> 替换为 Docker Hub 用户名和个人凭据。</p><p>如果你忘记如何创建 Docker Personal Token 了，可以查看<a href=\"https://time.geekbang.org/column/article/622743\">第 16 讲</a>的内容。另外关于如何为其他镜像仓库类型配置凭据，你可以查看<a href=\"https://argocd-image-updater.readthedocs.io/en/stable/configuration/registries/\">这份文档</a>。</p><h2>创建 Helm Chart 仓库</h2><p>接下来，我们需要为示例应用的 helm 目录单独创建一个 Git 仓库，在将 <a href=\"https://github.com/lyzhang1999/kubernetes-example\">kubernetes-example</a>克隆到本地后，执行下面的命令。</p><pre><code class=\"language-plain\"> $ cp -r ./kubernetes-example/helm ./kubernetes-example-helm\n</code></pre><p>然后，进入 kubernetes-example-helm 目录并初始化 Git。</p><pre><code class=\"language-plain\">$ cd kubernetes-example-helm &amp;&amp; git init\n</code></pre><p>前往 GitHub 创建一个新的仓库，将其命名为 kubernetes-example-helm。</p><p><img src=\"https://static001.geekbang.org/resource/image/5a/4c/5a8502bba504a6597d539b7298304e4c.png?wh=1484x1084\" alt=\"图片\"></p><p>将 kubernetes-example-helm 提交到远端仓库中。</p><pre><code class=\"language-plain\">$ git add .\n$ git commit -m \"first commit\"\n$ git branch -M main\n$ git remote add origin https://github.com/lyzhang1999/kubernetes-example-helm.git\n$ git push -u origin main\n</code></pre><h2>创建 ArgoCD Application</h2><p>创建好 kubernetes-example-helm 仓库之后，接下来我们需要使用它创建一个新的应用。</p><h3>删除旧应用（可选）</h3><p>在正式创建新的应用之前，为了避免 Ingress 策略冲突，如果你已经按照上节课的内容创建了 ArgoCD example 应用，需要先删除应用及其资源，你可以使用下面的命令来删除应用。</p><pre><code class=\"language-plain\">$ argocd app delete example --cascade\n</code></pre><h3>配置仓库访问权限</h3><p>此外，上节课我们创建 ArgoCD 应用时，虽然同样配置了仓库访问权限，但这里的步骤额外还实现了一个重要的功能：为 ArgoCD Image Updater 提供回写 kubernetes-example-helm 仓库的权限。</p><p>要配置仓库访问权限，你可以使用 argocd repo add 命令。</p><pre><code class=\"language-plain\">$ argocd repo add https://github.com/lyzhang1999/kubernetes-example-helm.git --username $USERNAME --password $PASSWORD\nRepository 'https://github.com/lyzhang1999/kubernetes-example-helm.git' added\n</code></pre><p>注意要将仓库地址修改为你新创建的用于存放 Helm Chart 的 GitHub 仓库地址，并将 <code>$USERNAME</code> 替换为 GitHub 账户 ID，将 <code>$PASSWORD</code> 替换为 GitHub Personal Token。你可以在<a href=\"https://github.com/settings/tokens\">这个页面</a>创建 GitHub Personal Token，并赋予仓库相关权限。</p><h3>创建 ArgoCD 应用</h3><p>接下来我们正式创建 ArgoCD 应用。在上一节课中，我们是使用 argocd app create 命令创建的 ArgoCD 应用 。实际上，它会创建一个特殊类型的资源，也就是 ArgoCD Application，它和 K8s 其他标准的资源对象一样，也是使用 YAML 来定义的。</p><p>在这里，我们直接使用 YAML 来创建新的 Application，将下面的文件内容保存为 application.yaml。</p><pre><code class=\"language-yaml\">apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: example\n  annotations:\n    argocd-image-updater.argoproj.io/backend.allow-tags: regexp:^main\n    argocd-image-updater.argoproj.io/backend.helm.image-name: backend.image\n    argocd-image-updater.argoproj.io/backend.helm.image-tag: backend.tag\n    argocd-image-updater.argoproj.io/backend.pull-secret: pullsecret:argocd/dockerhub-secret\n    argocd-image-updater.argoproj.io/frontend.allow-tags: regexp:^main\n    argocd-image-updater.argoproj.io/frontend.helm.image-name: frontend.image\n    argocd-image-updater.argoproj.io/frontend.helm.image-tag: frontend.tag\n    argocd-image-updater.argoproj.io/frontend.pull-secret: pullsecret:argocd/dockerhub-secret\n    argocd-image-updater.argoproj.io/image-list: frontend=lyzhang1999/frontend, backend=lyzhang1999/backend\n    argocd-image-updater.argoproj.io/update-strategy: latest\n    argocd-image-updater.argoproj.io/write-back-method: git\nspec:\n  destination:\n    namespace: gitops-example-updater\n    server: https://kubernetes.default.svc\n  project: default\n  source:\n    path: .\n    repoURL: https://github.com/lyzhang1999/kubernetes-example-helm.git\n    targetRevision: main\n  syncPolicy:\n    automated: {}\n    syncOptions:\n      - CreateNamespace=true\n</code></pre><p>然后，使用 kubectl apply 命令创建 ArgoCD Application，效果等同于使用 argocd app create 命令创建应用。</p><pre><code class=\"language-yaml\">$ kubectl apply -n argocd -f application.yaml\napplication.argoproj.io/example created\n</code></pre><p>ArgoCD Image Updater 通过 Application Annotations 标签来实现对应的功能，我简单解释一下每一个标签的作用。</p><ul>\n<li>argocd-image-updater.argoproj.io/image-list：指定需要监听的镜像，这里我们指定示例应用的前后端镜像 lyzhang1999/frontend 和 lyzhang1999/backend，同时为前后端镜像法指定了别名，分别为 frontend 和 backend。这里的别名非常重要，会影响下面所有的设置。</li>\n<li>argocd-image-updater.argoproj.io/update-strategy：指定镜像更新策略。注意，<strong>latest 并不代表监听 latest 镜像版本</strong>，而是以最新推送的镜像作为更新策略。此外，semver 策略可以识别最高语义化版本的标签，digest 策略可以用来区分同一 Tag 下不同镜像 digest 的变更。</li>\n<li>argocd-image-updater.argoproj.io/write-back-method：表示将镜像版本回写到镜像仓库。注意，这里对仓库的写权限来源于使用 argocd repo add 命令为 ArgoCD 配置的仓库访问权限。</li>\n<li>argocd-image-updater.argoproj.io/&lt;镜像别名&gt;.pull-secret：为不同的镜像别名指定镜像拉取凭据。</li>\n<li>argocd-image-updater.argoproj.io/&lt;镜像别名&gt;.allow-tags：配置符合更新条件的镜像 Tag，在这里我们使用正则表达式匹配那些镜像 Tag 以 main 开头的镜像版本，其他镜像版本则忽略。</li>\n<li>argocd-image-updater.argoproj.io/&lt;镜像别名&gt;.helm.image-name：配置 Helm Chart values.yaml 镜像名称所在的节点，在示例应用中，backend.image 和 frontend.image 是values.yaml 配置镜像名称的节点，ArgoCD 在回写仓库时会覆盖这个值。</li>\n<li>argocd-image-updater.argoproj.io/&lt;镜像别名&gt;.helm.image-tag：配置 Helm Chart values.yaml 镜像版本所在的节点，在示例应用中，backend.tag 和 frontend.tag 是 values.yaml 配置镜像版本的节点，ArgoCD 在回写仓库时将会覆盖这个值。</li>\n</ul><h2>体验 GitOps 工作流</h2><p>接下来，你可以尝试修改 frontend/src/App.js 文件，例如修改文件第 49 行的“Hi! I am a geekbang”内容。修改完成后，<strong>将代码推送到 GitHub 的 main 分支</strong>。</p><p>此时会触发两个 GitHub Action 工作流。其中，当 build-every-branch 工作流被触发时，它将构建 Tag 为 main 开头的镜像版本，并将其推送到镜像仓库中，如下图所示。</p><p><img src=\"https://static001.geekbang.org/resource/image/a5/66/a571d8f3f53ce2547d8e9df97b789b66.png?wh=1920x407\" alt=\"图片\"></p><p>和我们上一节课介绍的另一个 GitHub Action 工作流不同的是，它也不会去主动修改 kubernetes-example-helm 仓库的 values.yaml 文件，在完成镜像推送后工作流也就结束了。</p><p>与此同时，ArgoCD Image Updater 将会每 2 分钟从镜像仓库检索 frontend 和 backend 的镜像版本，一旦发现有新的并且以 main 开头的镜像版本，它将自动使用新版本来更新集群内工作负载的镜像，并将镜像版本回写到 kubernetes-example-helm 仓库。</p><p>在回写时，ArgoCD Image Updater 并不会直接修改仓库的 values.yaml 文件，而是会创建一个专门用于覆盖 Helm Chart values.yaml 的 .argocd-source-example.yaml 文件。</p><p><img src=\"https://static001.geekbang.org/resource/image/15/0e/15df9ed2a0d349c7b6448fe0be99cb0e.png?wh=1818x522\" alt=\"图片\"></p><p>当我们看到这个文件时，说明 ArgoCD Image Updater 已经触发了镜像更新，并且成功将镜像版本回写到了镜像仓库。同时，这个文件记录了详细的覆盖 values.yaml 值的策略。</p><pre><code class=\"language-yaml\">helm:\n&nbsp; parameters:\n&nbsp; - name: frontend.image\n&nbsp; &nbsp; value: lyzhang1999/frontend\n&nbsp; &nbsp; forcestring: true\n&nbsp; - name: frontend.tag\n&nbsp; &nbsp; value: main-b99bc73\n&nbsp; &nbsp; forcestring: true\n&nbsp; - name: backend.image\n&nbsp; &nbsp; value: lyzhang1999/backend\n&nbsp; &nbsp; forcestring: true\n&nbsp; - name: backend.tag\n&nbsp; &nbsp; value: main-b99bc73\n&nbsp; &nbsp; forcestring: true\n</code></pre><p>这样，当 ArgoCD 在做自动同步时，会将这份文件的内容覆盖 values.yaml 对应的值，比如 frontend.tag 的值会被覆盖为 main-b99bc73，这样，回写后的 Helm Chart 和集群内资源对象就仍然能够保持一致性。</p><p>到这里，我们就完成了通过监听新镜像版本来触发 GitOps 工作流的整个过程。</p><h2>总结</h2><p>在这节课，我为你介绍了如何使用 ArgoCD Image Updater 实现自动监听镜像版本并触发 GitOps 工作流。</p><p>在这个例子中，我们将应用源码和应用定义（Helm Chart）拆分成了两个仓库，在开发和发布角色相对独立的研发流程下，这种方式既能够保持他们之间职责独立，权责清晰，同时还保留了开发随时发布生产环境的能力。</p><p>值得注意的是，在实际的业务场景中，我们一般会使用多分支的模式来开发。这意味着每个分支的每个提交都会产生新的镜像版本，所以，为了区分开发过程的镜像和需要被发布到生产环境的镜像，我在这节课的例子中约定了以 main 开头的镜像版本即为需要发布到生产环境的镜像版本。你可以根据项目的实际情况做调整，例如使用诸如 v1.0.0 的版本号来区分，同时更新 argocd-image-updater.argoproj.io/&lt;镜像别名&gt;.allow-tags 字段的正则表达式。</p><p>总结来说，在这种仓库分离的场景下，要将开发者的提交和发布过程自动化地连接起来，双方需要重点关注生产环境的镜像版本策略，并将它配置到 ArgoCD 应用的 Annotations 注解内，这样便能够让 ArgoCD Image Updater 代替人工来自动监控需要发布到生产环境的镜像。</p><h2>思考题</h2><p>最后，给你留一道思考题吧。</p><p>如果在 Helm Chart 内使用了固定的 latest 镜像版本，并且在 CI 过程也只会覆盖更新 latest 版本的镜像，这种场景下如何配置 ArgoCD Image Updater 的 update-strategy 的策略呢？</p><p>提示：当新的镜像覆盖 latest 版本后，digest 会产生变化。</p><p>欢迎你给我留言交流讨论，你也可以把这节课分享给更多的朋友一起阅读。我们下节课见。</p>","neighbors":{"left":{"article_title":"22｜如何使用 ArgoCD 快速打造生产可用的 GitOps 工作流？","id":624572},"right":{"article_title":"24｜生产稳定的秘密武器：如何实施蓝绿发布？","id":625912}},"comments":[{"had_liked":false,"id":367554,"user_name":"农民园丁","can_delete":false,"product_type":"c1","uid":1155913,"ip_address":"内蒙古","ucode":"6A91EBBC9DCE6C","user_header":"https://static001.geekbang.org/account/avatar/00/11/a3/49/4a488f4c.jpg","comment_is_top":false,"comment_ctime":1675318738,"is_pvip":false,"replies":[{"id":133893,"content":"Harbor 需要通过 Cert-manager 颁发 TLS 证书，如果还是有错误的话，可以在 argocd-image-updater 项目提交一个 issue：https:&#47;&#47;github.com&#47;argoproj-labs&#47;argocd-image-updater&#47;issues","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675414214,"ip_address":"广东","comment_id":367554,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师，我用的是自建的gitlab和harbor（自签名证书），CI部分没有问题，build了main开头的镜像并推送到了harbor中，但是CD部分不能更新应用，在pod argocd-image-updater中的日志如下：\ntime=&quot;2023-02-02T06:11:46Z&quot; level=error msg=&quot;Could not get tags from registry: Get \\&quot;https:&#47;&#47;harbor.imustyckz.com&#47;v2&#47;\\&quot;: x509: certificate signed by unknown authority&quot; alias=frontend application=example image_name=richey&#47;frontend image_tag=95717a65 registry=harbor.imustyckz.com\ntime=&quot;2023-02-02T06:11:46Z&quot; level=error msg=&quot;Could not get tags from registry: Get \\&quot;https:&#47;&#47;harbor.imustyckz.com&#47;v2&#47;\\&quot;: x509: certificate signed by unknown authority&quot; alias=backend application=example image_name=richey&#47;backend image_tag=95717a65 registry=harbor.imustyckz.com\ntime=&quot;2023-02-02T06:11:46Z&quot; level=info msg=&quot;Processing results: applications=1 images_considered=2 images_skipped=0 images_updated=0 errors=2&quot;\n\n看提示是这个pod没有信任自签名证书，搞了2天还不行，请教怎么解决呢？","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601794,"discussion_content":"Harbor 需要通过 Cert-manager 颁发 TLS 证书，如果还是有错误的话，可以在 argocd-image-updater 项目提交一个 issue：https://github.com/argoproj-labs/argocd-image-updater/issues","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675414214,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367304,"user_name":"m1k3","can_delete":false,"product_type":"c1","uid":1027018,"ip_address":"广东","ucode":"896BCA57B7766E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ab/ca/bb1ebf5d.jpg","comment_is_top":false,"comment_ctime":1675128407,"is_pvip":false,"replies":[{"id":133903,"content":"👍🏻正确！","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675415229,"ip_address":"广东","comment_id":367304,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"argocd-image-updater.argoproj.io&#47;update-strategy：digest 策略可以用来区分同一 Tag 下不同镜像 digest 的变更。","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601808,"discussion_content":"👍🏻正确！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675415229,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367520,"user_name":"宝仔","can_delete":false,"product_type":"c1","uid":1013493,"ip_address":"浙江","ucode":"A0F17DFF99DB21","user_header":"https://static001.geekbang.org/account/avatar/00/0f/76/f5/e3f5bd8d.jpg","comment_is_top":false,"comment_ctime":1675301674,"is_pvip":false,"replies":[{"id":133894,"content":"每个环境所需要的配置文件是不同的，比如测试环境你可能用集群内的数据库，生产环境用云数据库。\n配置文件并不是一定要存放在 Git 仓库中，比如你可以在创建 ArgoCD 应用的时候配置额外的环境参数。\n但我建议将不同环境的配置都存储到仓库里，优点有很多，最大的优点是由于 Git 仓库是唯一可信源，所以在未来你要做环境迁移的时候，可以随时拉起一套环境。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675414397,"ip_address":"广东","comment_id":367520,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师你好，这种helm chart gitops 是不是不同的环境的values文件都要存在git仓库里？比方说我预发环境有staging-values.yaml文件，生产有production-values.yaml文件，因为会存在感配置的情况","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601797,"discussion_content":"每个环境所需要的配置文件是不同的，比如测试环境你可能用集群内的数据库，生产环境用云数据库。\n配置文件并不是一定要存放在 Git 仓库中，比如你可以在创建 ArgoCD 应用的时候配置额外的环境参数。\n但我建议将不同环境的配置都存储到仓库里，优点有很多，最大的优点是由于 Git 仓库是唯一可信源，所以在未来你要做环境迁移的时候，可以随时拉起一套环境。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675414397,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":380003,"user_name":"RRR","can_delete":false,"product_type":"c1","uid":1014991,"ip_address":"新加坡","ucode":"F32A579D201EC5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/7c/cf/d5382404.jpg","comment_is_top":false,"comment_ctime":1692813641,"is_pvip":false,"replies":[{"id":138390,"content":"👍🏻这个方案也挺不错的，简单直接。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1692867984,"ip_address":"广东","comment_id":380003,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"其实 只要能在 CI 阶段修改 GitOps 的那个仓库就行了\n\n我们现在在 Github Action 中做了这一步，在 Docker Image 构建好之后，使用 yq 直接去仓库提 PR，修改 tag verison 即可。\n\n然后交给别人 approval，通过后就部署了。\n\n很完美的 CD 过程。","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":626385,"discussion_content":"👍🏻这个方案也挺不错的，简单直接。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1692867984,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2536149,"avatar":"","nickname":"Geek_5dacb9","note":"","ucode":"8B82F41DE292F5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":632939,"discussion_content":"您好大佬，您的这个方案的设计是不再通过ArgoCD Image Updater插件监听镜像版本的变化，而是通过ArgoCD自动监听git仓库有更新后自动执行更新应用吗？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1701660206,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"河北","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372930,"user_name":"Geek_06ea70","can_delete":false,"product_type":"c1","uid":2617207,"ip_address":"广东","ucode":"988E0500284B7B","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIFEQibKmCdPwDP9CcOuEdVNiatE0ekwBZKt5utJhzDKlZiciaEnRTN48eoNzXZpXTDEXMkwU3GQbSDLQ/132","comment_is_top":false,"comment_ctime":1681808938,"is_pvip":false,"replies":[{"id":136284,"content":"Latest 策略会拿最近一次推送到镜像仓库的镜像来进行更新。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1681875125,"ip_address":"广东","comment_id":372930,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师，我镜像版本是用$CI_COMMIT_SHORT_SHA打的，镜像更新策略用的latest，但ArgoCD Image Updater发现最新的镜像是按$CI_COMMIT_SHORT_SHA的ASCII码取的，而不是最后推送到镜像仓库的","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":614702,"discussion_content":"Latest 策略会拿最近一次推送到镜像仓库的镜像来进行更新。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681875125,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":372750,"user_name":"黄在在同学","can_delete":false,"product_type":"c1","uid":1620379,"ip_address":"广东","ucode":"D3468962B5E1F6","user_header":"https://static001.geekbang.org/account/avatar/00/18/b9/9b/31585eda.jpg","comment_is_top":false,"comment_ctime":1681549166,"is_pvip":false,"replies":[{"id":136150,"content":"可以参考这里定制通知模板：https:&#47;&#47;argocd-notifications.readthedocs.io&#47;en&#47;stable&#47;templates&#47;","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1681711859,"ip_address":"广东","comment_id":372750,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"老师您好，通常情况下，我们可能需要对部署结果进行通知，比如通知到钉钉里。我用argocd notifications 做了通知，但是这只知道应用的同步结果，无法做到具体哪个pod 部署结果的通知，可以提供下有什么解决思路吗？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":614127,"discussion_content":"可以参考这里定制通知模板：https://argocd-notifications.readthedocs.io/en/stable/templates/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681711859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1620379,"avatar":"https://static001.geekbang.org/account/avatar/00/18/b9/9b/31585eda.jpg","nickname":"黄在在同学","note":"","ucode":"D3468962B5E1F6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":614595,"discussion_content":"这文档看了，还是没有太多的思路，我一个应用下会有多个服务pod，一次更新可能只有其中某些服务pod会更新。但我在文档中没有找到有对应的能获取到pod更新的条件，无法判断是哪个pod更新部署了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1681828322,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":614127,"ip_address":"广东","group_id":0},"score":614595,"extra":""}]}]},{"had_liked":false,"id":371832,"user_name":"公众号：程序员大兵","can_delete":false,"product_type":"c1","uid":1142526,"ip_address":"北京","ucode":"AD0D05864C6913","user_header":"https://static001.geekbang.org/account/avatar/00/11/6e/fe/79955244.jpg","comment_is_top":false,"comment_ctime":1680405967,"is_pvip":true,"replies":[{"id":135636,"content":"可能是 frontend 的 hpa 表现差异导致的，你可以尝试修改 hpa 对象的阈值或者先临时删除它。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1680418943,"ip_address":"广东","comment_id":371832,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"为什么按专栏的操作部署后，frontend 的Pod数一直在增加呢，增加到了10个pod","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611917,"discussion_content":"可能是 frontend 的 hpa 表现差异导致的，你可以尝试修改 hpa 对象的阈值或者先临时删除它。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1680418943,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370998,"user_name":"黄在在同学","can_delete":false,"product_type":"c1","uid":1620379,"ip_address":"广东","ucode":"D3468962B5E1F6","user_header":"https://static001.geekbang.org/account/avatar/00/18/b9/9b/31585eda.jpg","comment_is_top":false,"comment_ctime":1679453692,"is_pvip":false,"replies":[{"id":135394,"content":"可以自定义镜像拉取的间隔时间，具体方法是为 Argocd image updater 的工作负载添加启动参数 --interval 并指定时间，参考这里：https:&#47;&#47;github.com&#47;argoproj-labs&#47;argocd-image-updater&#47;blob&#47;master&#47;docs&#47;install&#47;reference.md#flags","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1679573753,"ip_address":"广东","comment_id":370998,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"ArgoCD Image Updater  默认每2分钟检索一次镜像是否需要更新。这个时间可以可以自定义设置吗？或者是否可以改为webhook推送的方式？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610466,"discussion_content":"可以自定义镜像拉取的间隔时间，具体方法是为 Argocd image updater 的工作负载添加启动参数 --interval 并指定时间，参考这里：https://github.com/argoproj-labs/argocd-image-updater/blob/master/docs/install/reference.md#flags","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679573753,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370947,"user_name":"邵涵","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"北京","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1679394063,"is_pvip":false,"replies":[{"id":135330,"content":"先更新集群工作负载的镜像版本，再回写。\n换个角度，你可以这么考虑，回写仓库是可选的。如果不回写，那么 image updater 为了更新工作负载的镜像，就必须要修改集群内 Manifest image 字段。\n这样就清楚了。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1679452217,"ip_address":"广东","comment_id":370947,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"对于文中的\n“ArgoCD Image Updater 会以 Poll 的方式每 2 分钟检查一次工作负载的镜像是否有新的版本，如果有，那么就将工作负载的镜像更新为最新版本，并将镜像版本号写入到存放 Helm Chart 的仓库中。”\n“当 ArgoCD 在做自动同步时，会将这份文件的内容覆盖 values.yaml 对应的值，比如 frontend.tag 的值会被覆盖为 main-b99bc73，这样，回写后的 Helm Chart 和集群内资源对象就仍然能够保持一致性”\n这两部分说明，该怎么理解？是\na. ArgoCD先更新Chart仓库，也就是添加&#47;更新.argocd-source-example.yaml，然后使用Chart原本的所有文件加上这个.argocd-source-example.yaml计算出工作负载对象的预期状态，以此去与k8s集群中的工作负载做对比和更新\n还是\nb. 先更新k8s集群中的工作负载，然后再更新Chart仓库中的文件\n个人理解应该是a，因为ArgoCD应该是对比应用定义和k8s中的工作负载，应用定义的变更可能有多种，不止是镜像版本的自动更新，还可能有其他人工手动做的变更，ArgoCD应该是都能监控、比对、更新。但是，从上边两段描述看，感觉像是b……请您指教","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":610194,"discussion_content":"先更新集群工作负载的镜像版本，再回写。\n换个角度，你可以这么考虑，回写仓库是可选的。如果不回写，那么 image updater 为了更新工作负载的镜像，就必须要修改集群内 Manifest image 字段。\n这样就清楚了。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1679452217,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3654504,"avatar":"","nickname":"Geek_45a572","note":"","ucode":"B0503B2F0D8A6D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":637546,"discussion_content":"这个操作应该是原子的，不能只成功一部分，否则会有不一致的问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1708611004,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"陕西","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368444,"user_name":"gyl1989113","can_delete":false,"product_type":"c1","uid":1363213,"ip_address":"四川","ucode":"B7F2860B3FB101","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","comment_is_top":false,"comment_ctime":1676343960,"is_pvip":false,"replies":[{"id":134186,"content":"这部分在 argocd-image-updater.yaml 文件下定义了。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1676355025,"ip_address":"广东","comment_id":368444,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"问下老师build-every-branch 的触发逻辑写到哪的呢。。build.yaml里没找到呢","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603997,"discussion_content":"这部分在 argocd-image-updater.yaml 文件下定义了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676355025,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368152,"user_name":"BertGeek","can_delete":false,"product_type":"c1","uid":1452799,"ip_address":"上海","ucode":"8E1D72C9F9778C","user_header":"https://static001.geekbang.org/account/avatar/00/16/2a/ff/a9d72102.jpg","comment_is_top":false,"comment_ctime":1675936150,"is_pvip":false,"replies":[{"id":134041,"content":"感谢认可。\n是的，image updater 是更安全和更高效的做法。","user_name":"作者回复","user_name_real":"作者","uid":1275456,"ctime":1675944589,"ip_address":"广东","comment_id":368152,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"非常好的专栏，及时雨呀！\n上周只是基本测试了argocd demo，在阿里云ack 中的使用，\n1. jenkins 构建镜像推送到harbor 仓库，然后改动对应应用 yaml文件中的镜像版本\n2. argocd 手动sync ，更新应用deployment 镜像版本\n\n本文提到的  ArgoCD Image Updater  ，更智能和高级的处理了这部分镜像变更。\n\n\n","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603106,"discussion_content":"感谢认可。\n是的，image updater 是更安全和更高效的做法。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675944589,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367391,"user_name":"Amosヾ","can_delete":false,"product_type":"c1","uid":1567014,"ip_address":"广东","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1675182582,"is_pvip":true,"replies":[{"id":133896,"content":"没办法。试想一下，你的 Deployment 可能是通过 Helm 渲染出来的，如果修改了集群的 Deployment，ArgoCD 是没法知道要改 Helm Chart 的哪个字段的。\nGitOps 的核心理念是 Git 作为唯一可信源，任何修改都应该产生提交记录，以便回溯。","user_name":"作者回复","user_name_real":"编辑","uid":1275456,"ctime":1675414619,"ip_address":"广东","comment_id":367391,"utype":1}],"discussion_count":2,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"如果紧急或特殊情况去集群修改了 deploy，是否可以回写到仓库呢？","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"王炜","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601799,"discussion_content":"没办法。试想一下，你的 Deployment 可能是通过 Helm 渲染出来的，如果修改了集群的 Deployment，ArgoCD 是没法知道要改 Helm Chart 的哪个字段的。\nGitOps 的核心理念是 Git 作为唯一可信源，任何修改都应该产生提交记录，以便回溯。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675414619,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1332257,"avatar":"https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg","nickname":"橙汁","note":"","ucode":"EC3FF10D708C9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":601651,"discussion_content":"换个思路，把获取镜像换成push形式，更换仓库内的版本 argo收到通知给你改，耗时不逊于你紧急情况下的手工","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1675331672,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":395796,"user_name":"裝甲","can_delete":false,"product_type":"c1","uid":1152736,"ip_address":"中国台湾","ucode":"11183EA8CD8A7C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/BJib7ba1CL6W9O0OhgLQX0cRMlO9IAsAWiblpcPbFugOPrBdkwB5tVibvnLhwgxc24UwnV7AXVSOObXJmw8ibmUBpw/132","comment_is_top":false,"comment_ctime":1732093426,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"想问一下老师 如果用 google artifact registry 作为镜像仓库，该如何设定呢？谢谢","like_count":0},{"had_liked":false,"id":390384,"user_name":"Dexter","can_delete":false,"product_type":"c1","uid":2608728,"ip_address":"芬兰","ucode":"909CABC4AC4AC9","user_header":"https://static001.geekbang.org/account/avatar/00/27/ce/58/71ed845f.jpg","comment_is_top":false,"comment_ctime":1715237058,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"time=&quot;2024-05-09T06:21:25Z&quot; level=error msg=&quot;Could not get tags from registry: Get \\&quot;https:&#47;&#47;registry-1.docker.io&#47;v2&#47;\\&quot;: dial tcp 54.198.86.24:443: connect: connection timed out&quot; alias=frontend application=example image_name=dexterliu3&#47;frontend image_tag=1276e23 registry=\ntime=&quot;2024-05-09T06:27:58Z&quot; level=error msg=&quot;Could not get tags from registry: Get \\&quot;https:&#47;&#47;registry-1.docker.io&#47;v2&#47;\\&quot;: dial tcp 54.236.113.205:443: connect: connection timed out&quot; alias=backend application=example image_name=dexterliu3&#47;backend image_tag=1276e23 registry=\ntime=&quot;2024-05-09T06:27:58Z&quot; level=info msg=&quot;Processing results: applications=1 images_considered=2 images_skipped=0 images_updated=0 errors=2&quot;\ntime=&quot;2024-05-09T06:29:58Z&quot; level=info msg=&quot;Starting image update cycle, considering 1 annotated application(s) for update&quot;\ntime=&quot;2024-05-09T06:36:30Z&quot; level=error msg=&quot;Could not get tags from registry: Get \\&quot;https:&#47;&#47;registry-1.docker.io&#47;v2&#47;\\&quot;: dial tcp 54.198.86.24:443: connect: connection timed out&quot; alias=frontend application=example image_name=dexterliu3&#47;frontend image_tag=1276e23 registry=\nroot@dexter-kind:~&#47;gitops#\n\n我的环境是装kind的server需要proxy才能上网，现在argocd-image-updater的pod看起来无法访问docker-hub， 这个有什么解决办法吗？\n","like_count":0},{"had_liked":false,"id":382716,"user_name":"小威仔","can_delete":false,"product_type":"c1","uid":1676305,"ip_address":"北京","ucode":"FB650201B7ABBB","user_header":"https://static001.geekbang.org/account/avatar/00/19/94/11/6345da29.jpg","comment_is_top":false,"comment_ctime":1697879104,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"老师，使用ArgoCD Image Updater只要镜像版本变化就会自动更新服务吗。可不可以配置成手动的方式。","like_count":0},{"had_liked":false,"id":367205,"user_name":"无名无姓","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"北京","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1675040909,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100312001,"comment_content":"应该会触发吧","like_count":0}]}