{"id":627364,"title":"26ï½œç”Ÿäº§ç¨³å®šçš„ç§˜å¯†æ­¦å™¨ï¼šå¦‚ä½•å®æ–½è‡ªåŠ¨åŒ–æ¸è¿›å¼äº¤ä»˜ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä¸ºä½ ä»‹ç»äº†ä»€ä¹ˆæ˜¯é‡‘ä¸é›€å‘å¸ƒä»¥åŠå¦‚ä½•å®æ–½è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒã€‚</p><p>åœ¨å®æ–½é‡‘ä¸é›€å‘å¸ƒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ Argo Rollout çš„é‡‘ä¸é›€ç­–ç•¥å°†å‘å¸ƒè¿‡ç¨‹åˆ†æˆäº† 3 ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µé‡‘ä¸é›€çš„æµé‡æ¯”ä¾‹éƒ½ä¸åŒï¼Œç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œé‡‘ä¸é›€ç¯å¢ƒå˜æˆäº†æ–°çš„ç”Ÿäº§ç¯å¢ƒã€‚å®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§æ¸è¿›å¼çš„äº¤ä»˜æ–¹å¼ï¼Œå®ƒé€šè¿‡å»¶é•¿å‘å¸ƒæ—¶é—´æ¥ä¿æŠ¤ç”Ÿäº§ç¯å¢ƒï¼Œé™ä½äº†å‘ç”Ÿç”Ÿäº§äº‹æ•…çš„æ¦‚ç‡ã€‚</p><p>ä¸è¿‡ï¼Œè¿™ç§æ¸è¿›å¼çš„äº¤ä»˜æ–¹å¼å­˜åœ¨ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼šæ— æ³•è‡ªåŠ¨åˆ¤æ–­é‡‘ä¸é›€ç¯å¢ƒæ˜¯å¦å‡ºé”™ã€‚</p><p>è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€ç§æƒ…å†µï¼Œå½“é‡‘ä¸é›€ç¯å¢ƒåœ¨æ¥æ”¶ç”Ÿäº§æµé‡ä¹‹åï¼Œå®ƒäº§ç”Ÿäº†å¤§é‡çš„è¯·æ±‚é”™è¯¯ï¼Œåœ¨ç¼ºå°‘äººå·¥ä»‹å…¥çš„æƒ…å†µä¸‹ï¼Œå‘å¸ƒä»ç„¶æŒ‰ç…§è®¡åˆ’è¿›è¡Œï¼Œæœ€ç»ˆå¯¼è‡´ç”Ÿäº§ç¯å¢ƒæ•…éšœã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¸Œæœ›æ¸è¿›å¼äº¤ä»˜å˜å¾—æ›´åŠ æ™ºèƒ½ï¼Œä¸€ä¸ªå¥½çš„å·¥ç¨‹å®è·µæ–¹å¼æ˜¯ï¼š<strong>é€šè¿‡æŒ‡æ ‡åˆ†ææ¥è‡ªåŠ¨åˆ¤æ–­é‡‘ä¸é›€å‘å¸ƒçš„è´¨é‡ï¼Œå¦‚æœç¬¦åˆé¢„æœŸï¼Œå°±ç»§ç»­é‡‘ä¸é›€æ­¥éª¤ï¼›å¦‚æœä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™è¿›è¡Œå›æ»šã€‚</strong>è¿™æ ·ï¼Œä¹Ÿå°±èƒ½å¤Ÿé¿å…å°†é‡‘ä¸é›€ç¯å¢ƒçš„æ•…éšœå¸¦åˆ°ç”Ÿäº§ç¯å¢ƒä¸­äº†ï¼Œè¿™ç§åˆ†ææ–¹æ³•ä¹Ÿå«åšé‡‘ä¸é›€åˆ†æã€‚</p><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±æ¥å­¦ä¹ å¦‚ä½•å°† Argo Rollout å’Œ Prometheus ç»“åˆï¼Œå®ç°è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜ã€‚</p><p>åœ¨å¼€å§‹ä»Šå¤©çš„å­¦ä¹ ä¹‹å‰ï¼Œä½ éœ€è¦åšå¥½ä¸‹é¢è¿™äº›å‡†å¤‡ã€‚</p><ul>\n<li>æŒ‰ç…§ç¬¬ä¸€ç« <a href=\"https://time.geekbang.org/column/article/612571\">ç¬¬ 2 è®²</a>çš„å†…å®¹åœ¨æœ¬åœ°é…ç½®å¥½ Kind é›†ç¾¤ï¼Œå®‰è£… Ingress-Nginxï¼Œ<strong>å¹¶æš´éœ² 80 å’Œ 443 ç«¯å£ã€‚</strong></li>\n<li>é…ç½®å¥½ Kubectlï¼Œä½¿å…¶èƒ½å¤Ÿè®¿é—® Kind é›†ç¾¤ã€‚</li>\n<li>æŒ‰ç…§<a href=\"https://time.geekbang.org/column/article/625912\">ç¬¬ 24 è®²</a>çš„å†…å®¹å®‰è£…å¥½ Argo Rollout ä»¥åŠ kubectl æ’ä»¶ã€‚</li>\n</ul><!-- [[[read_end]]] --><h2>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜æ¦‚è¿°</h2><p>ä¸ºäº†æ›´å¥½åœ°å¸®åŠ©ä½ ç†è§£è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜ï¼Œæˆ‘ç»™ä½ ç”»äº†ä¸€å¼ æ•´ä½“çš„æ¶æ„å’Œæµç¨‹å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/42/49/4214bc7180548e84e5f42a8d31411f49.jpg?wh=1920x953\" alt=\"å›¾ç‰‡\"></p><p>ç›¸æ¯”è¾ƒé‡‘ä¸é›€å‘å¸ƒï¼Œè‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å¢åŠ äº† Prometheusã€Analysis Template å’Œ AnalysisRun å¯¹è±¡ã€‚å…¶ä¸­ï¼ŒAnalysis Template å®šä¹‰ç”¨äºåˆ†æçš„æ¨¡æ¿ï¼ŒAnalysisRun æ˜¯åˆ†ææ¨¡æ¿çš„å®ä¾‹åŒ–ï¼ŒPrometheus æ˜¯ç”¨æ¥å­˜å‚¨æŒ‡æ ‡çš„æ•°æ®åº“ã€‚</p><p>åœ¨è¿™èŠ‚è¯¾çš„ä¾‹å­ä¸­ï¼Œæˆ‘è®¾è®¡çš„è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜æµç¨‹ä¼šæŒ‰ç…§ä¸‹é¢è¿™å¼ æµç¨‹å›¾æ¥è¿›è¡Œã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/bd/b2/bd6fa71710420b7e67dca5c6f0c5d7b2.jpg?wh=1920x663\" alt=\"å›¾ç‰‡\"></p><p>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å¼€å§‹æ—¶ï¼Œé¦–å…ˆä¼šå…ˆå°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹è®¾ç½®ä¸º 20% å¹¶æŒç»­ä¸¤åˆ†é’Ÿï¼Œç„¶åå°†é‡‘ä¸é›€ç¯å¢ƒçš„æµé‡æ¯”ä¾‹è®¾ç½®ä¸º 40% å¹¶æŒç»­ä¸¤åˆ†é’Ÿï¼Œç„¶åå†ä»¥æ­¤ç±»æ¨åˆ° 60%ã€80%ï¼Œç›´åˆ°å°†é‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºç”Ÿäº§ç¯å¢ƒä¸ºæ­¢ã€‚</p><p>ä»ç¬¬äºŒä¸ªé˜¶æ®µå¼€å§‹ï¼Œè‡ªåŠ¨é‡‘ä¸é›€åˆ†æå¼€å§‹è¿è¡Œï¼Œåœ¨æŒç»­è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡‘ä¸é›€åˆ†æå¤±è´¥ï¼Œé‚£ä¹ˆé‡‘ä¸é›€ç¯å¢ƒå°†è¿›è¡Œè‡ªåŠ¨å›æ»šã€‚è¿™æ ·å°±è¾¾åˆ°äº†è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜çš„ç›®çš„ã€‚</p><h2>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å®æˆ˜</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°æ¸è¿›å¼äº¤ä»˜çš„å®æˆ˜ç¯èŠ‚ï¼Œå®æˆ˜è¿‡ç¨‹å¤§è‡´åˆ†æˆä¸‹é¢å‡ ä¸ªæ­¥éª¤ã€‚</p><ol>\n<li>åˆ›å»ºç”Ÿäº§ç¯å¢ƒï¼ŒåŒ…æ‹¬ Rollout å¯¹è±¡ã€Service å’Œ Ingressã€‚</li>\n<li>åˆ›å»ºç”¨äºè‡ªåŠ¨é‡‘ä¸é›€åˆ†æçš„ AnalysisTemplate æ¨¡æ¿ã€‚</li>\n<li>å®‰è£… Prometheus å¹¶é…ç½® Ingress-Nginxã€‚</li>\n<li>ä¿®æ”¹é•œåƒç‰ˆæœ¬ï¼Œå¯åŠ¨æ¸è¿›å¼äº¤ä»˜ã€‚</li>\n</ol><h3>åˆ›å»ºç”Ÿäº§ç¯å¢ƒ</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºç”¨äºæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„ Rollout å¯¹è±¡ã€Service å’Œ Ingressã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º rollout-with-analysis.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: canary-demo\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: canary-demo\n  strategy:\n    canary:\n      analysis:\n        templates:\n        - templateName: success-rate\n        startingStep: 2\n        args:\n        - name: ingress\n          value: canary-demo\n      canaryService: canary-demo-canary\n      stableService: canary-demo\n      trafficRouting:\n        nginx:\n          stableIngress: canary-demo\n      steps:\n      - setWeight: 20\n      - pause:\n          duration: 2m\n      - setWeight: 40\n      - pause:\n          duration: 2m\n      - setWeight: 60\n      - pause:\n          duration: 2m\n      - setWeight: 80\n      - pause:\n          duration: 2m\n  template:\n    metadata:\n      labels:\n        app: canary-demo\n    spec:\n      containers:\n      - image: argoproj/rollouts-demo:blue\n        imagePullPolicy: Always\n        name: canary-demo\n        ports:\n        - containerPort: 8080\n          name: http\n          protocol: TCP\n        resources:\n          requests:\n            cpu: 5m\n            memory: 32Mi\n</code></pre><p>ä¸Šé¢çš„å†…å®¹ç›¸æ¯”è¾ƒ<a href=\"https://time.geekbang.org/column/article/626641\">ç¬¬ 25 è®²</a>é‡‘ä¸é›€å‘å¸ƒçš„ Rollout å¯¹è±¡å¹¶æ²¡æœ‰å¤ªå¤§å·®å¼‚ï¼Œåªæ˜¯åœ¨ canary å­—æ®µä¸‹é¢å¢åŠ äº† analysis å­—æ®µï¼Œå®ƒçš„ä½œç”¨æ˜¯æŒ‡å®šé‡‘ä¸é›€åˆ†æçš„æ¨¡æ¿ï¼Œæ¨¡æ¿å†…å®¹æˆ‘ä»¬ä¼šåœ¨ç¨ååˆ›å»ºã€‚å¦å¤–ï¼Œè¿™é‡ŒåŒæ ·ä½¿ç”¨äº† argoproj/rollouts-demo:blue é•œåƒæ¥æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒã€‚</p><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å‘½ä»¤å°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f rollout-with-analysis.yaml\nrollout.argoproj.io/canary-demo created\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»º Service å¯¹è±¡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸€å¹¶åˆ›å»ºç”Ÿäº§ç¯å¢ƒå’Œé‡‘ä¸é›€ç¯å¢ƒæ‰€éœ€è¦ç”¨åˆ°çš„ Service ï¼Œå°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º canary-demo-service.yamlã€‚</p><pre><code class=\"language-yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: canary-demo\n  labels: \n    app: canary-demo\nspec:\n  ports:\n  - port: 80\n    targetPort: http\n    protocol: TCP\n    name: http\n  selector:\n    app: canary-demo\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: canary-demo-canary\n  labels: \n    app: canary-demo\nspec:\n  ports:\n  - port: 80\n    targetPort: http\n    protocol: TCP\n    name: http\n  selector:\n    app: canary-demo\n</code></pre><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å‘½ä»¤å°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary-demo-service.yaml\nservice/canary-demo created\nservice/canary-demo-canary created\n</code></pre><p>æœ€åï¼Œå†åˆ›å»º Ingress å¯¹è±¡ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º canary-demo-ingress.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: canary-demo\n  labels:\n    app: canary-demo\n  annotations:\n    kubernetes.io/ingress.class: nginx\nspec:\n  rules:\n    - host: progressive.auto\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: canary-demo\n                port:\n                  name: http\n</code></pre><p>åœ¨è¿™ä¸ª Ingress å¯¹è±¡ä¸­ï¼ŒæŒ‡å®šäº† progressive.auto ä½œä¸ºè®¿é—®åŸŸåã€‚</p><p>ç„¶åï¼Œä½¿ç”¨ kubectl apply å‘½ä»¤å°†å®ƒåº”ç”¨åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f canary-demo-ingress.yaml\ningress.networking.k8s.io/canary-demo created\n</code></pre><h3>åˆ›å»º AnalysisTemplate</h3><p>ç”±äºæˆ‘ä»¬åœ¨ Rollout å¯¹è±¡ä¸­æŒ‡å®šäº†åä¸º success-rate çš„é‡‘ä¸é›€åˆ†ææ¨¡æ¿ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºå®ƒã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º analysis-success.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: argoproj.io/v1alpha1\nkind: AnalysisTemplate\nmetadata:\n  name: success-rate\nspec:\n  args:\n  - name: ingress\n  metrics:\n  - name: success-rate\n    interval: 10s\n    failureLimit: 3\n    successCondition: result[0] &gt; 0.90\n    provider:\n      prometheus:\n        address: http://prometheus-kube-prometheus-prometheus.prometheus:9090\n        query: &gt;+\n          sum(\n            rate(nginx_ingress_controller_requests{ingress=\"{{args.ingress}}\",status!~\"[4-5].*\"}[60s]))\n            /\n            sum(rate(nginx_ingress_controller_requests{ingress=\"{{args.ingress}}\"}[60s])\n          )\n</code></pre><p>è¿™é‡Œæˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ AnalysisTemplate å¯¹è±¡å­—æ®µçš„å«ä¹‰ã€‚</p><p>é¦–å…ˆ spec.args å­—æ®µå®šä¹‰äº†å‚æ•°ï¼Œè¯¥å‚æ•°ä¼šåœ¨åç»­çš„ query è¯­å¥ä¸­ä½¿ç”¨ï¼Œå®ƒçš„å€¼æ˜¯ä» Rollout å¯¹è±¡çš„ canary.analysis.args å­—æ®µä¼ é€’è¿›æ¥çš„ã€‚</p><p>spec.metrics å­—æ®µå®šä¹‰äº†è‡ªåŠ¨åˆ†æçš„ç›¸å…³é…ç½®ã€‚å…¶ä¸­ï¼Œinterval å­—æ®µä¸ºé¢‘ç‡ï¼Œæ¯ 10 ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡åˆ†æã€‚failureLimit å­—æ®µä»£è¡¨â€œè¿ç»­ 3 æ¬¡å¤±è´¥åˆ™é‡‘ä¸é›€åˆ†æå¤±è´¥â€ï¼Œæ­¤æ—¶è¦æ‰§è¡Œå›æ»šåŠ¨ä½œã€‚successCondition å­—æ®µä»£è¡¨åˆ¤æ–­æ¡ä»¶ï¼Œè¿™é‡Œçš„ result[0] æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä»£è¡¨çš„å«ä¹‰æ˜¯å½“æŸ¥è¯¢è¯­å¥çš„è¿”å›å€¼å¤§äº 0.90 æ—¶ï¼Œè¯´æ˜æœ¬æ¬¡é‡‘ä¸é›€åˆ†ææˆåŠŸäº†ã€‚</p><p>æœ€åï¼Œspec.metrics.provider å­—æ®µå®šä¹‰äº†åˆ†ææ•°æ®æ¥æºäº Prometheusï¼Œè¿˜å®šä¹‰äº† Prometheus Server çš„è¿æ¥åœ°å€ï¼Œæˆ‘ä»¬å°†åœ¨ç¨åéƒ¨ç½² Prometheusã€‚</p><p>query å­—æ®µæ˜¯é‡‘ä¸é›€åˆ†æçš„æŸ¥è¯¢è¯­å¥ã€‚è¿™æ¡æŸ¥è¯¢è¯­å¥çš„å«ä¹‰ä½ å¯ä»¥ç®€å•åœ°ç†è§£æˆï¼šåœ¨ 60 ç§’å†… HTTP çŠ¶æ€ç ä¸ä¸º 4xx å’Œ 5xx çš„è¯·æ±‚å æ‰€æœ‰è¯·æ±‚çš„æ¯”ä¾‹ã€‚æ¢å¥è¯è¯´ï¼Œå½“ HTTP è¯·æ±‚æˆåŠŸçš„æ¯”ä¾‹å¤§äº 0.90 æ—¶ï¼Œä»£è¡¨ä¸€æ¬¡é‡‘ä¸é›€åˆ†ææˆåŠŸã€‚</p><h3>è®¿é—®ç”Ÿäº§ç¯å¢ƒ</h3><p>æ¥ä¸‹æ¥ï¼Œä¸ºäº†è®¿é—®ç”Ÿäº§ç¯å¢ƒï¼Œä½ è¿˜éœ€è¦å…ˆé…ç½® Hostsã€‚</p><pre><code class=\"language-yaml\">127.0.0.1 progressive.auto\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://progressive.auto\">http://progressive.auto</a>ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°å¦‚ä¸‹é¡µé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/cd/4e/cd029631060f31f7f2282361ecc1d34e.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><h3>å®‰è£… Prometheus</h3><p>Prometheus&nbsp;æ˜¯ Kubernetes å¹³å°å¼€æºçš„ç›‘æ§å’ŒæŠ¥è­¦ç³»ç»Ÿã€‚ç”±äºé‡‘ä¸é›€åˆ†æéœ€è¦ç”¨åˆ° Prometheus æ¥æŸ¥è¯¢æŒ‡æ ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆéƒ¨ç½²å®ƒã€‚è¿™é‡Œæˆ‘ä½¿ç”¨ Helm çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚</p><pre><code class=\"language-yaml\">$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\n$ helm upgrade prometheus prometheus-community/kube-prometheus-stack \\\n--namespace prometheus&nbsp; --create-namespace --install \\\n--set prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues=false \\\n--set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false\n\nRelease \"prometheus\" does not exist. Installing it now.\n......\nSTATUS: deployed\n</code></pre><p>åœ¨ä¸Šé¢çš„å®‰è£…å‘½ä»¤ä¸­ï¼Œæˆ‘ä½¿ç”¨ --set å¯¹å®‰è£…å‚æ•°è¿›è¡Œäº†é…ç½®ï¼Œè¿™æ˜¯ä¸ºäº†è®©å®ƒåç»­èƒ½å¤Ÿé¡ºåˆ©è·å–åˆ° Ingress-Nginx çš„ç›‘æ§æŒ‡æ ‡ã€‚</p><p>ç„¶åï¼Œä½ éœ€è¦ç­‰å¾… prometheus å‘½åç©ºé—´ä¸‹çš„å·¥ä½œè´Ÿè½½å¤„äºå°±ç»ªçŠ¶æ€ã€‚</p><pre><code class=\"language-yaml\">$ kubectl wait --for=condition=Ready pods --all -n prometheus\npod/alertmanager-prometheus-kube-prometheus-alertmanager-0 condition met\npod/prometheus-grafana-64b6c46fb5-6hz2z condition met\npod/prometheus-kube-prometheus-operator-696cc64986-pv9rg condition met\npod/prometheus-kube-state-metrics-649f8795d4-glbcq condition met\npod/prometheus-prometheus-kube-prometheus-prometheus-0 condition met\npod/prometheus-prometheus-node-exporter-mqnrw condition met\n</code></pre><p>åˆ°è¿™é‡Œï¼ŒPrometheus å°±éƒ¨ç½²å®Œæˆäº†ã€‚</p><h3>é…ç½® Ingress-Nginx å’Œ ServiceMonitor</h3><p>ä¸ºäº†è®© Prometheus èƒ½å¤Ÿé¡ºåˆ©åœ°è·å–åˆ° HTTP è¯·æ±‚æŒ‡æ ‡ï¼Œæˆ‘ä»¬éœ€è¦æ‰“å¼€ Ingress-Nginx Metric æŒ‡æ ‡ç«¯å£ã€‚</p><p>é¦–å…ˆéœ€è¦ä¸º Ingress-Nginx Deployment æ·»åŠ å®¹å™¨çš„æŒ‡æ ‡ç«¯å£ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥å®Œæˆã€‚</p><pre><code class=\"language-yaml\">$ kubectl patch deployment ingress-nginx-controller -n ingress-nginx --type='json' -p='[{\"op\": \"add\", \"path\": \"/spec/template/spec/containers/0/ports/-\", \"value\": {\"name\": \"prometheus\",\"containerPort\":10254}}]'\ndeployment.apps/ingress-nginx-controller patched\n</code></pre><p>ç„¶åï¼Œä¸º Ingrss-Nginx Service æ·»åŠ æŒ‡æ ‡ç«¯å£ã€‚</p><pre><code class=\"language-yaml\">$ kubectl patch service ingress-nginx-controller -n ingress-nginx --type='json' -p='[{\"op\": \"add\", \"path\": \"/spec/ports/-\", \"value\": {\"name\": \"prometheus\",\"port\":10254,\"targetPort\":\"prometheus\"}}]'\nservice/ingress-nginx-controller patched\n</code></pre><p>æœ€åï¼Œä¸ºäº†è®© Prometheus èƒ½å¤ŸæŠ“å–åˆ° Ingress-Nginx æŒ‡æ ‡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»º ServiceMonitor å¯¹è±¡ï¼Œå®ƒå¯ä»¥ä¸º Prometheus é…ç½®æŒ‡æ ‡è·å–çš„ç­–ç•¥ã€‚å°†ä¸‹é¢çš„å†…å®¹ä¿å­˜ä¸º servicemonitor.yaml æ–‡ä»¶ã€‚</p><pre><code class=\"language-yaml\">apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: nginx-ingress-controller-metrics\n  namespace: prometheus\n  labels:\n    app: nginx-ingress\n    release: prometheus-operator\nspec:\n  endpoints:\n  - interval: 10s\n    port: prometheus\n  selector:\n    matchLabels:\n      app.kubernetes.io/instance: ingress-nginx\n      app.kubernetes.io/name: ingress-nginx\n  namespaceSelector:\n    matchNames:\n    - ingress-nginx\n</code></pre><p>ç„¶åï¼Œé€šè¿‡ kubectl å°†å®ƒéƒ¨ç½²åˆ°é›†ç¾¤å†…ã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f servicemonitor.yaml\nservicemonitor.monitoring.coreos.com/nginx-ingress-controller-metrics created\n</code></pre><p>å½“æŠŠ ServiceMonitor åº”ç”¨åˆ°é›†ç¾¤åï¼ŒPrometheus ä¼šæŒ‰ç…§æ ‡ç­¾æ¥åŒ¹é… Ingress-Nginx Podï¼Œå¹¶ä¸”ä¼šæ¯ 10s ä¸»åŠ¨æ‹‰å–ä¸€æ¬¡æŒ‡æ ‡æ•°æ®ï¼Œå¹¶ä¿å­˜åˆ° Prometheus æ—¶åºæ•°æ®åº“ä¸­ã€‚</p><h3>éªŒè¯ Ingress-Nginx æŒ‡æ ‡</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éªŒè¯ Prometheus æ˜¯å¦å·²ç»æˆåŠŸè·å–åˆ°äº† Ingress-Nginx æŒ‡æ ‡ï¼Œè¿™å°†å†³å®šè‡ªåŠ¨é‡‘ä¸é›€åˆ†ææ˜¯å¦èƒ½æˆåŠŸè·å–åˆ°æ•°æ®ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è¿›å…¥ Prometheus æ§åˆ¶å°éªŒè¯æ˜¯å¦æˆåŠŸè·å–äº† Ingress-Nginx æŒ‡æ ‡ã€‚é¦–å…ˆï¼Œä½¿ç”¨ kubectl port-forward å‘½ä»¤å°† Prometheus è½¬å‘åˆ°æœ¬åœ°ã€‚</p><pre><code class=\"language-yaml\">$ kubectl port-forward service/prometheus-kube-prometheus-prometheus 9090:9090 -n prometheus\nForwarding from 127.0.0.1:9090 -&gt; 9090\nForwarding from [::1]:9090 -&gt; 9090 \n</code></pre><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ <a href=\"http://127.0.0.1:9090\">http://127.0.0.1:9090</a> è¿›å…¥æ§åˆ¶å°ï¼Œåœ¨æœç´¢æ¡†ä¸­è¾“å…¥ nginx_ingressï¼Œå¦‚æœå‡ºç°ä¸€ç³»åˆ—æŒ‡æ ‡ï¼Œåˆ™è¯´æ˜ Prometheus å’Œ Ingress-Nginx å·²ç»é…ç½®å®Œæˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/06/64/062d98ea9739e8dbd36c11a1d0d47f64.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><h2>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å®éªŒ</h2><p>ç°åœ¨ï¼Œæ‰€æœ‰çš„å‡†å¤‡å·¥ä½œéƒ½å·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿›è¡Œè‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å®éªŒã€‚</p><p>è®©æˆ‘ä»¬é‡æ–°å›å¿†ä¸€ä¸‹æˆ‘åœ¨å‰é¢æåˆ°çš„è¿™å¼ æµç¨‹å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b4/5f/b40e2044e5a92a635dc8732357f1a25f.jpg?wh=1920x616\" alt=\"å›¾ç‰‡\"></p><p>åœ¨å®éªŒè¿‡ç¨‹è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šæŒ‰ç…§è¿™å¼ æµç¨‹å›¾åˆ†åˆ«è¿›è¡Œä¸¤ä¸ªå®éªŒã€‚</p><ol>\n<li>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜æˆåŠŸï¼ˆå›¾ä¸­â‘ å·é“¾è·¯ï¼‰ã€‚</li>\n<li>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å¤±è´¥ï¼ˆå›¾ä¸­â‘¡å·é“¾è·¯ï¼‰ã€‚</li>\n</ol><h3>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜æˆåŠŸ</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›è¡Œè‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜æˆåŠŸçš„å®éªŒã€‚</p><p>è¦å¼€å§‹å®éªŒï¼Œåªè¦æ›´æ–° Rollout å¯¹è±¡çš„é•œåƒç‰ˆæœ¬å³å¯ã€‚åœ¨<a href=\"https://time.geekbang.org/column/article/626641\">ç¬¬ 25 è®²</a>ä¸­ï¼Œæˆ‘æåˆ°äº†ç¼–è¾‘ Rollout å¯¹è±¡å¹¶é€šè¿‡ kubectl apply çš„æ–¹æ³•æ¥æ›´æ–°é•œåƒç‰ˆæœ¬ã€‚è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦ä¸€ç§æ›´æ–°é•œåƒçš„æ–¹æ³•ï¼Œé€šè¿‡ Argo Rollout kubectl æ’ä»¶æ¥æ›´æ–°é•œåƒã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts set image canary-demo canary-demo=argoproj/rollouts-demo:green\nrollout \"canary-demo\" image updated\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ <a href=\"http://progressive.auto\">http://progressive.auto</a> è¿”å›åº”ç”¨ï¼Œè¿‡ä¸€ä¼šå„¿çœ‹åˆ°ç»¿è‰²æ–¹å—å¼€å§‹å‡ºç°ï¼Œæµé‡å æ¯”çº¦ä¸º 20%ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/f7/78/f7c2116134499eddff81d44939355e78.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>ç°åœ¨ï¼Œä½ å¯ä»¥å°è¯•æ‰“å¼€ Argo Rollout æ§åˆ¶å°ã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts dashboard\nINFO[0000] Argo Rollouts Dashboard is now available at http://localhost:3100/rollouts\n</code></pre><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—® <a href=\"http://localhost:3100/rollouts\">http://localhost:3100/rollouts</a> è¿›å…¥æ§åˆ¶å°ï¼Œè§‚å¯Ÿè‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜è¿‡ç¨‹ã€‚å¯ä»¥çœ‹åˆ°ç›®å‰å¤„åœ¨ 20% é‡‘ä¸é›€æµé‡çš„ä¸‹ä¸€é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯æš‚åœ 2 åˆ†é’Ÿçš„é˜¶æ®µã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/45/41/4505900970309b8f3bb1de844671ca41.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>2 åˆ†é’Ÿåï¼Œå°†è¿›å…¥åˆ° 40% é‡‘ä¸é›€æµé‡é˜¶æ®µï¼Œä»è¿™ä¸ªé˜¶æ®µå¼€å§‹ï¼Œè‡ªåŠ¨é‡‘ä¸é›€åˆ†æå¼€å§‹å·¥ä½œï¼Œç›´åˆ°æœ€åé‡‘ä¸é›€å‘å¸ƒå®Œæˆï¼Œé‡‘ä¸é›€ç¯å¢ƒæå‡ä¸ºäº†ç”Ÿäº§ç¯å¢ƒï¼Œè¿™æ—¶è‡ªåŠ¨åˆ†æä¹Ÿå®Œæˆäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9c/e5/9c611d54433b937840c60b7aacfb98e5.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œä¸€æ¬¡å®Œæ•´çš„è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å°±å®Œæˆäº†ã€‚</p><h3>è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å¤±è´¥</h3><p>åœ¨ä¸Šé¢çš„å®éªŒä¸­ï¼Œç”±äºåº”ç”¨è¿”å›çš„ HTTP çŠ¶æ€ç éƒ½æ˜¯ 200 ï¼Œæ‰€ä»¥é‡‘ä¸é›€åˆ†æè‡ªç„¶æ˜¯ä¼šæˆåŠŸçš„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å°è¯•è¿›è¡Œè‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜å¤±è´¥çš„å®éªŒã€‚</p><p>ç»è¿‡äº†è‡ªåŠ¨æ¸è¿›å¼äº¤ä»˜æˆåŠŸçš„å®éªŒä¹‹åï¼Œå½“å‰ç”Ÿäº§ç¯å¢ƒä¸­çš„é•œåƒä¸º argoproj/rollouts-demo:greenï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨ Argo Rollout kubectl æ’ä»¶æ¥æ›´æ–°é•œåƒï¼Œå¹¶å°†é•œåƒç‰ˆæœ¬ä¿®æ”¹ä¸º yellow ç‰ˆæœ¬ã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts set image canary-demo canary-demo=argoproj/rollouts-demo:yellow\nrollout \"canary-demo\" image updated\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œé‡æ–°è¿”å› <a href=\"http://progressive.auto\">http://progressive.auto</a> æ‰“å¼€åº”ç”¨ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œä½ ä¼šçœ‹åˆ°è¯·æ±‚å¼€å§‹å‡ºç°é»„è‰²æ–¹å—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/79/d5/7926c8e71af9aa0f08301fa71161b5d5.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®©åº”ç”¨è¿”å›é”™è¯¯çš„ HTTP çŠ¶æ€ç ã€‚ä½ å¯ä»¥æ»‘åŠ¨ç•Œé¢ä¸Šçš„ ERROR æ»‘åŠ¨å—ï¼Œå°†é”™è¯¯ç‡è®¾ç½®ä¸º 50%ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/bc/a9/bc1178ee8698f16bc6ec35690d9698a9.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>ç°åœ¨ï¼Œä½ ä¼šåœ¨é»„è‰²æ–¹å—ä¸­çœ‹åˆ°å¸¦æœ‰çº¢è‰²æè¾¹çš„æ–¹å—ï¼Œè¿™ä»£è¡¨æœ¬æ¬¡è¯·æ±‚è¿”å›çš„ HTTP çŠ¶æ€ç ä¸ç­‰äº 200ï¼Œè¯´æ˜<strong>æˆ‘ä»¬æˆåŠŸæ§åˆ¶äº†ä¸€éƒ¨åˆ†è¯·æ±‚è¿”å›é”™è¯¯</strong>ã€‚</p><p>2 åˆ†é’Ÿåï¼Œé‡‘ä¸é›€å‘å¸ƒä¼šè¿›å…¥åˆ° 40% æµé‡çš„é˜¶æ®µï¼Œæ­¤æ—¶è‡ªåŠ¨åˆ†æå°†å¼€å§‹è¿›è¡Œã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è¿›å…¥ Argo Rollout æ§åˆ¶å°ã€‚</p><pre><code class=\"language-yaml\">$ kubectl argo rollouts dashboard\nINFO[0000] Argo Rollouts Dashboard is now available at http://localhost:3100/rollouts\n</code></pre><p>ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ <a href=\"http://localhost:3100/rollouts\">http://localhost:3100/rollouts</a>ï¼Œè¿›å…¥å‘å¸ƒè¯¦æƒ…ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œé‡‘ä¸é›€åˆ†æå°†å¤±è´¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9e/3e/9e29d8050d91702c74b43fc1d599b03e.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>æ­¤æ—¶ï¼ŒArgo Rollout å°†æ‰§è¡Œè‡ªåŠ¨å›æ»šæ“ä½œï¼Œè¿™æ—¶å€™é‡æ–°è¿”å› <a href=\"http://progressive.auto\">http://progressive.auto</a> æ‰“å¼€åº”ç”¨ï¼Œä½ ä¼šçœ‹åˆ°é»„è‰²æ–¹å—çš„æµé‡æ¶ˆå¤±ï¼Œæ‰€æœ‰è¯·æ±‚è¢«ç»¿è‰²æ–¹å—å–ä»£ï¼Œè¯´æ˜å·²ç»å®Œæˆå›æ»šäº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d5/9d/d54d1f999e990cf7cc224ffc34be8f9d.png?wh=1920x1005\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œä¸€æ¬¡å®Œæ•´çš„æ¸è¿›å¼äº¤ä»˜å¤±è´¥å®éªŒå°±å®Œæˆäº†ã€‚</p><h2>æ€»ç»“</h2><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä¸ºä½ ä»‹ç»äº†ä»€ä¹ˆæ˜¯æ¸è¿›å¼äº¤ä»˜ï¼Œä»¥åŠå¦‚ä½•å€ŸåŠ© ArgoCD å®æ–½æ¸è¿›å¼äº¤ä»˜ï¼Œå®ƒçš„å‘å¸ƒæµç¨‹å’Œæˆ‘ä»¬åœ¨ 25 è®²æåˆ°çš„é‡‘ä¸é›€å‘å¸ƒéå¸¸ç±»ä¼¼ã€‚</p><p>ä¸åŒçš„æ˜¯ï¼Œæ¸è¿›å¼äº¤ä»˜åœ¨é‡‘ä¸é›€å‘å¸ƒçš„è¿‡ç¨‹ä¸­åŠ å…¥äº†è‡ªåŠ¨é‡‘ä¸é›€åˆ†æï¼Œå®ƒå¯ä»¥éªŒè¯æ–°ç‰ˆæœ¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„è¡¨ç°ï¼Œè€Œè¿™æ˜¯å•çº¯çš„é‡‘ä¸é›€å‘å¸ƒæ‰€æ— æ³•å®ç°çš„ã€‚å€ŸåŠ©æ¸è¿›å¼äº¤ä»˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‘å¸ƒè¿‡ç¨‹é€šè¿‡æŒ‡æ ‡å®æ—¶åˆ†æé‡‘ä¸é›€ç¯å¢ƒï¼Œå…¼é¡¾å‘å¸ƒçš„å®‰å…¨æ€§å’Œæ•ˆç‡ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†èƒ½å¤ŸæŸ¥è¯¢åˆ°ç¤ºä¾‹åº”ç”¨çš„ HTTP æŒ‡æ ‡ï¼Œæˆ‘å¼€å¯äº† Ingress-Nginx çš„æŒ‡æ ‡å¼€å…³ï¼Œè¿™æ ·æ‰€æœ‰ç»è¿‡ Ingress-Nginx çš„æµé‡éƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œç»“åˆ Prometheus ServiceMonitor å®ç°äº† HTTP è¯·æ±‚æŒ‡æ ‡çš„é‡‡é›†ã€‚</p><p>æ­¤å¤–ï¼Œä¸ºäº†è®© ArgoCD åœ¨æ¸è¿›å¼äº¤ä»˜æ—¶é¡ºåˆ©è¿è¡Œé‡‘ä¸é›€åˆ†æï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»º AnalysisTemplate å¯¹è±¡ï¼Œå®ƒå®é™…ä¸Šæ˜¯ PromQL ç¼–å†™çš„æŸ¥è¯¢è¯­å¥ï¼ŒArgoCD åœ¨äº¤ä»˜è¿‡ç¨‹ä¸­ä¼šç”¨è¿™æ¡è¯­å¥å» Prometheus æŸ¥è¯¢ï¼Œå¹¶å°†è¿”å›çš„ç»“æœå’Œé¢„å®šä¹‰çš„é˜ˆå€¼è¿›è¡Œå¯¹æ¯”ï¼Œä»¥æ­¤æ§åˆ¶æ¸è¿›å¼äº¤ä»˜åº”è¯¥ç»§ç»­è¿›è¡Œè¿˜æ˜¯å›æ»šã€‚</p><p>åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¦‚æœä½ å¸Œæœ›éªŒè¯å¤šä¸ªç»´åº¦çš„æŒ‡æ ‡ï¼Œä½ å¯ä»¥åˆ›å»ºå¤šä¸ª AnalysisTemplate å¹¶å°†å®ƒé…ç½®åˆ° Rollout å¯¹è±¡ä¸­ï¼Œè¿›ä¸€æ­¥æé«˜åˆ†æçš„å¯é æ€§ã€‚å¦å¤–ï¼Œä½ è¿˜å¯ä»¥åœ¨é‡‘ä¸é›€å‘å¸ƒçš„ steps é˜¶æ®µé‡Œé…ç½®â€œå†…è”â€çš„åˆ†ææ­¥éª¤ï¼Œæ¯”å¦‚åœ¨é‡‘ä¸é›€ç¯å¢ƒ 20% å’Œ 40% æµé‡é˜¶æ®µçš„ä¸‹ä¸€é˜¶æ®µåˆ†åˆ«è¿è¡Œä¸åŒçš„é‡‘ä¸é›€åˆ†æï¼Œå…·ä½“é…ç½®æ–¹æ³•ä½ å¯ä»¥å‚è€ƒ<a href=\"https://argoproj.github.io/argo-rollouts/features/analysis/\">è¿™ä»½æ–‡æ¡£</a>ã€‚</p><p>è¿™èŠ‚è¯¾æˆ‘å¹¶æ²¡æœ‰æ·±å…¥ä»‹ç» Prometheusã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨å®ƒæ¥æ„å»ºå¼ºå¤§çš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿï¼Œæˆ‘å°†åœ¨åç»­çš„è¯¾ç¨‹ä¸ºä½ è¯¦ç»†ä»‹ç»ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜å§ã€‚</p><p>å½“è‡ªåŠ¨åˆ†æå¤±è´¥å¯¼è‡´å›æ»šæ—¶ï¼Œæ˜¯å¦æœ‰å¿…è¦å°†é•œåƒç‰ˆæœ¬å›å†™åˆ° GitOps åº”ç”¨å®šä¹‰çš„ä»“åº“ä¸­å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","comments":[{"had_liked":false,"id":369542,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"åŒ—äº¬","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1677653058,"is_pvip":false,"replies":[{"id":134679,"content":"ğŸ‘ğŸ» è¿™é‡Œç¡®å®æ˜¯æœ‰ç½‘ç»œé—®é¢˜ï¼Œå¾ˆæ£’çš„è§£å†³æ–¹æ¡ˆï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1677661608,"ip_address":"å¹¿ä¸œ","comment_id":369542,"utype":1}],"discussion_count":1,"race_medal":1,"score":2,"product_id":100312001,"comment_content":"åœ¨è¿™ç¯‡ helm éƒ¨ç½² prometheus-operatorçš„æ—¶å€™å¡ä½äº†ï¼Œå‘ç°æœ‰ä¸¤ä¸ªé•œåƒæ²¡æœ‰æ‹‰å–æˆåŠŸï¼Œå‘ç°æ˜¯registry.k8s.ioï¼š\n registry.k8s.io&#47;ingress-nginx&#47;kube-webhook-certgen:v1.3.0\nregistry.k8s.io&#47;kube-state-metrics&#47;kube-state-metrics:v2.8.0\næˆ‘åˆ©ç”¨ github action è‡ªåŠ¨æ‹‰å–registry.k8s.ioé•œåƒæ¨é€dockerhubï¼Œé‡æ–°å®šåˆ¶äº†kube-prometheus-stackçš„chartså¹¶æ¨é€åˆ°github packageæˆ–è€…ç§æœ‰harborï¼Œæ€»ç»“äº†ä¸€ç¯‡æ–‡ç« ï¼š https:&#47;&#47;mp.weixin.qq.com&#47;s&#47;8AYyAb-Uj8dOWxQxHCfD6A","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":607186,"discussion_content":"ğŸ‘ğŸ» è¿™é‡Œç¡®å®æ˜¯æœ‰ç½‘ç»œé—®é¢˜ï¼Œå¾ˆæ£’çš„è§£å†³æ–¹æ¡ˆï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677661608,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":379318,"user_name":"Sophia-ç™¾é‘«","can_delete":false,"product_type":"c1","uid":1269105,"ip_address":"ä¸Šæµ·","ucode":"070DC977441003","user_header":"https://static001.geekbang.org/account/avatar/00/13/5d/71/4f6aad17.jpg","comment_is_top":false,"comment_ctime":1691722638,"is_pvip":false,"replies":[{"id":138218,"content":"æ£€æŸ¥ä¸€ä¸‹ ingress è·¯ç”±ç­–ç•¥","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1691763533,"ip_address":"å¹¿ä¸œ","comment_id":379318,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æˆ‘åœ¨25è®²é‡‘ä¸é›€è‡ªåŠ¨åŒ–å‘å¸ƒå®æˆ˜çš„åŸºç¡€ä¸Šï¼Œç›´æ¥è¿›è¡Œäº†æœ¬è®²çš„å®æˆ˜ï¼Œå®ŒæˆæŒ‰è€å¸ˆçš„æ­¥éª¤æ‰§è¡Œã€‚å‘ç°http:&#47;&#47;progressive.auto&#47;  ä¸€ç›´æ˜¾ç¤ºçš„æ˜¯ç»¿è‰²æ ¼å­ã€‚ å¦‚ä½•è§£å†³ï¼Ÿ\n","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":625504,"discussion_content":"æ£€æŸ¥ä¸€ä¸‹ ingress è·¯ç”±ç­–ç•¥","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1691763533,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368332,"user_name":"gyl1989113","can_delete":false,"product_type":"c1","uid":1363213,"ip_address":"å››å·","ucode":"B7F2860B3FB101","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","comment_is_top":false,"comment_ctime":1676210476,"is_pvip":false,"replies":[{"id":134148,"content":"Jenkins ä½œä¸º ci å·¥å…·ç”¨çš„æ¯”è¾ƒå¤šï¼ŒæŒç»­éƒ¨ç½²å°±ä¸å¤ªæ“…é•¿äº†ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1676252488,"ip_address":"å¹¿ä¸œ","comment_id":368332,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"é—®ä¸‹å¤§ä½¬å·¥ä½œä¸­åŸºæœ¬ä¸Šéƒ½ç”¨argocdå˜›ã€‚ã€‚æˆ‘çœ‹tektonå°±ä¸€ç« èŠ‚ï¼Œjenkinsçœ‹ä¸åˆ°ï½","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603489,"discussion_content":"Jenkins ä½œä¸º ci å·¥å…·ç”¨çš„æ¯”è¾ƒå¤šï¼ŒæŒç»­éƒ¨ç½²å°±ä¸å¤ªæ“…é•¿äº†ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676252489,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1363213,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/cBh6rmNsSIbHEAGKiaq25yz9tqGuJEjbIYn2K0uFBLEe8lBNjL3SUOicibPbAO5SdH6TxV65kcCpK6FOB1hBr3PBQ/132","nickname":"gyl1989113","note":"","ucode":"B7F2860B3FB101","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":605028,"discussion_content":"å¥½çš„ï¼Œé¡ºä¾¿é—®ä¸‹ingress-nginxå¼€å¯prometheusé‚£ä¸€å¥kubect patchçœ‹ä¸æ‡‚ã€‚ã€‚èƒ½è§£é‡Šä¸‹å˜›ã€‚ã€‚ å¹³æ—¶å·¥ä½œçš„è¯ciç”¨tekton,cdç”¨argocdå˜›ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676554577,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å››å·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":367812,"user_name":"m1k3","can_delete":false,"product_type":"c1","uid":1027018,"ip_address":"å¹¿ä¸œ","ucode":"896BCA57B7766E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ab/ca/bb1ebf5d.jpg","comment_is_top":false,"comment_ctime":1675649969,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æœ‰å¿…è¦ï¼Œå¯ä»¥ä½œä¸ºå†å²æ•°æ®åˆ†æã€‚è¿™ä¸ªç‰ˆæœ¬é•œåƒæœ‰ä»€ä¹ˆé—®é¢˜å¯èƒ½æ¨ç»™å¼€å‘è€…debug","like_count":1},{"had_liked":false,"id":367805,"user_name":"Amosãƒ¾","can_delete":false,"product_type":"c1","uid":1567014,"ip_address":"å¹¿ä¸œ","ucode":"833F6FCB4042AD","user_header":"https://static001.geekbang.org/account/avatar/00/17/e9/26/472e16e4.jpg","comment_is_top":false,"comment_ctime":1675646641,"is_pvip":true,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"é•œåƒç‰ˆæœ¬è‚¯å®šéœ€è¦å›å†™åˆ°ä»“åº“ä¸­ï¼Œå¦åˆ™å¼€å§‹è‡ªåŠ¨æ›´æ–°çš„åº”ç”¨å²‚ä¸æ˜¯è¦é‡å¤æ‰§è¡Œå‘å¸ƒå›æ»šçš„æ“ä½œã€‚","like_count":1,"discussions":[{"author":{"id":1983237,"avatar":"https://static001.geekbang.org/account/avatar/00/1e/43/05/3fbf26cf.jpg","nickname":"Noel ZHANG","note":"","ucode":"DF4E7E1FAFB509","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":608160,"discussion_content":"ä½ çš„ååŠå¥æˆ‘ä¸ç†è§£ï¼Œç†è®ºä¸Šä¸‹ä¸€æ¬¡æ˜¯ä¸‹ä¸€ä¸ªimageç‰ˆæœ¬äº†ï¼Œä¸ºä»€ä¹ˆä¼šé‡å¤å›æ»šæ“ä½œå‘¢ï¼Ÿå½“ç„¶ï¼Œå‘å¸ƒå¤±è´¥ä¸ä¸€å®šå°±æ˜¯imageçš„é—®é¢˜ï¼Œå¯èƒ½æ˜¯æƒé™ï¼Œç½‘ç»œï¼Œé…ç½®å„ç§éimageé—®é¢˜äº§ç”Ÿçš„ã€‚ä¸€å¸®æƒ…å†µä¸‹ä»devåˆ°prodéƒ½è¦å®ç°åŒ…æµè½¬ï¼Œå¦‚æœæ˜¯äº§å“å‘ç”Ÿå›æ»šï¼Œå¤§æ¦‚ç‡ä¸æ˜¯imageé—®é¢˜ï¼Œæ‰€ä»¥é•œåƒè‚¯å®šè¦ç•™ç€ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1678289281,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ±Ÿè‹","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":385110,"user_name":"DeenJun","can_delete":false,"product_type":"c1","uid":1026010,"ip_address":"å¹¿ä¸œ","ucode":"6D40BA39A33C9D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a7/da/f057374c.jpg","comment_is_top":false,"comment_ctime":1702100037,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"å¦‚æœè¦æŠŠç‰ˆæœ¬å›å†™åˆ°ä»“åº“ï¼Œé‚£å°±æ˜¯argocdè¦æœ‰gitçš„å†™å…¥æƒé™ï¼Ÿè¿™æ„Ÿè§‰ä¸æ˜¯ä¸€ä¸ªå¥½çš„å®è·µå‘¢","like_count":0},{"had_liked":false,"id":384858,"user_name":"Geek_9acf33","can_delete":false,"product_type":"c1","uid":2191611,"ip_address":"å¹¿ä¸œ","ucode":"3C39B88C3B7813","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI4tSatQ0rLPu7KBPyxnicmNj0SznMibMK85mFcRKvZrjA7XzP48CKUx0K7xbs2pbxzjTfsbyZicQ6Lg/132","comment_is_top":false,"comment_ctime":1701691362,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"éœ€è¦ï¼Œgitopsä¸å°±æ˜¯ä¸ºäº†è®©çº¿ä¸Šç¯å¢ƒè·Ÿgitä»“åº“é‡Œä¸€è‡´","like_count":0},{"had_liked":false,"id":367793,"user_name":"æ— åæ— å§“","can_delete":false,"product_type":"c1","uid":2621412,"ip_address":"åŒ—äº¬","ucode":"487BD5AA2CD305","user_header":"https://static001.geekbang.org/account/avatar/00/27/ff/e4/927547a9.jpg","comment_is_top":false,"comment_ctime":1675614434,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"éªŒè¯éœ€è¦å“ªäº›æŒ‡æ ‡å‘¢ï¼Ÿ","like_count":0}]}