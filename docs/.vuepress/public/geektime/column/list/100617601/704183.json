{"id":704183,"title":"10ï½œè®°å¿†ï¼šé€šè¿‡Memoryè®°ä½å®¢æˆ·ä¸Šæ¬¡ä¹°èŠ±æ—¶çš„å¯¹è¯ç»†èŠ‚","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯é»„ä½³ï¼Œæ¬¢è¿æ¥åˆ°LangChainå®æˆ˜è¯¾ï¼</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯LLMè¿˜æ˜¯ä»£ç†éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼Œæ¯æ¬¡æ¨¡å‹çš„è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹äºå…¶ä»–äº¤äº’çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ¯æ¬¡é€šè¿‡APIå¼€å§‹å’Œå¤§è¯­è¨€æ¨¡å‹å±•å¼€ä¸€æ¬¡æ–°çš„å¯¹è¯ï¼Œå®ƒéƒ½ä¸çŸ¥é“ä½ å…¶å®æ˜¨å¤©æˆ–è€…å‰å¤©æ›¾ç»å’Œå®ƒèŠè¿‡å¤©äº†ã€‚</p><p>ä½ è‚¯å®šä¼šè¯´ï¼Œä¸å¯èƒ½å•Šï¼Œæ¯æ¬¡å’ŒChatGPTèŠå¤©çš„æ—¶å€™ï¼ŒChatGPTæ˜æ˜ç™½ç™½åœ°è®°å¾—æˆ‘ä¹‹å‰äº¤å¾…è¿‡çš„äº‹æƒ…ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c9/97/c9907bc695521228cdfb5d3f75c13897.png?wh=588x593\" alt=\"\"></p><p>çš„ç¡®å¦‚æ­¤ï¼ŒChatGPTä¹‹æ‰€ä»¥èƒ½å¤Ÿè®°å¾—ä½ ä¹‹å‰è¯´è¿‡çš„è¯ï¼Œæ­£æ˜¯å› ä¸ºå®ƒä½¿ç”¨äº†<strong>è®°å¿†ï¼ˆMemoryï¼‰æœºåˆ¶</strong>ï¼Œè®°å½•äº†ä¹‹å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªä¸Šä¸‹æ–‡ä½œä¸ºæç¤ºçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨æœ€æ–°çš„è°ƒç”¨ä¸­ä¼ é€’ç»™äº†æ¨¡å‹ã€‚åœ¨èŠå¤©æœºå™¨äººçš„æ„å»ºä¸­ï¼Œè®°å¿†æœºåˆ¶éå¸¸é‡è¦ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e2/de/e26993dd3957bfd2947424abb9de7cde.png?wh=1965x1363\" alt=\"\"></p><h2>ä½¿ç”¨ConversationChain</h2><p>ä¸è¿‡ï¼Œåœ¨å¼€å§‹ä»‹ç»LangChainä¸­è®°å¿†æœºåˆ¶çš„å…·ä½“å®ç°ä¹‹å‰ï¼Œå…ˆé‡æ–°çœ‹ä¸€ä¸‹æˆ‘ä»¬ä¸Šä¸€èŠ‚è¯¾æ›¾ç»è§è¿‡çš„ConversationChainã€‚</p><p>è¿™ä¸ªChainæœ€ä¸»è¦çš„ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæä¾›äº†åŒ…å«AI å‰ç¼€å’Œäººç±»å‰ç¼€çš„å¯¹è¯æ‘˜è¦æ ¼å¼ï¼Œè¿™ä¸ªå¯¹è¯æ ¼å¼å’Œè®°å¿†æœºåˆ¶ç»“åˆå¾—éå¸¸ç´§å¯†ã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå¹¶æ‰“å°å‡ºConversationChainä¸­çš„å†…ç½®æç¤ºæ¨¡æ¿ï¼Œä½ å°±ä¼šæ˜ç™½è¿™ä¸ªå¯¹è¯æ ¼å¼çš„æ„ä¹‰äº†ã€‚</p><pre><code class=\"language-plain\">from langchain import OpenAI\nfrom langchain.chains import ConversationChain\n\n# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹\nllm = OpenAI(\n&nbsp; &nbsp; temperature=0.5,\n&nbsp; &nbsp; model_name=\"gpt-3.5-turbo-instruct\"\n)\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconv_chain = ConversationChain(llm=llm)\n\n# æ‰“å°å¯¹è¯çš„æ¨¡æ¿\nprint(conv_chain.prompt.template)\n</code></pre><!-- [[[read_end]]] --><p>è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">The following is a friendly conversation between a human and an AI. The AI is talkative and provides lots of specific details from its context. If the AI does not know the answer to a question, it truthfully says it does not know.\n\nCurrent conversation:\n{history}\nHuman: {input}\nAI:\n</code></pre><p>è¿™é‡Œçš„æç¤ºä¸ºäººç±»ï¼ˆæˆ‘ä»¬ï¼‰å’Œäººå·¥æ™ºèƒ½ï¼ˆtext-davinci-003ï¼‰ä¹‹é—´çš„å¯¹è¯è®¾ç½®äº†ä¸€ä¸ªåŸºæœ¬å¯¹è¯æ¡†æ¶ï¼šè¿™æ˜¯<strong>äººç±»å’Œ</strong> <strong>AI</strong> <strong>ä¹‹é—´çš„å‹å¥½å¯¹è¯ã€‚AI</strong> <strong>éå¸¸å¥è°ˆå¹¶ä»å…¶ä¸Šä¸‹æ–‡ä¸­æä¾›äº†å¤§é‡çš„å…·ä½“ç»†èŠ‚ã€‚</strong> (The following is a friendly conversation between a human and an AI. The AI is talkative and provides lots of specific details from its context. )</p><p>åŒæ—¶ï¼Œè¿™ä¸ªæç¤ºè¯•å›¾é€šè¿‡è¯´æ˜ä»¥ä¸‹å†…å®¹æ¥å‡å°‘å¹»è§‰ï¼Œä¹Ÿå°±æ˜¯å°½é‡å‡å°‘æ¨¡å‹ç¼–é€ çš„ä¿¡æ¯ï¼š</p><p><strong>â€œå¦‚æœ</strong> <strong>AI</strong> <strong>ä¸çŸ¥é“é—®é¢˜çš„ç­”æ¡ˆï¼Œå®ƒå°±ä¼šå¦‚å®è¯´å®ƒä¸çŸ¥é“ã€‚â€</strong>ï¼ˆIf the AI does not know the answer to a question, it truthfully says it does not know.ï¼‰</p><p>ä¹‹åï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸¤ä¸ªå‚æ•° {history} å’Œ {input}ã€‚</p><ul>\n<li><strong>{history}</strong> æ˜¯å­˜å‚¨ä¼šè¯è®°å¿†çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯äººç±»å’Œäººå·¥æ™ºèƒ½ä¹‹é—´å¯¹è¯å†å²çš„ä¿¡æ¯ã€‚</li>\n<li><strong>{input}</strong> æ˜¯æ–°è¾“å…¥çš„åœ°æ–¹ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯å’ŒChatGPTå¯¹è¯æ—¶ï¼Œæ–‡æœ¬æ¡†ä¸­çš„è¾“å…¥ã€‚</li>\n</ul><p>è¿™ä¸¤ä¸ªå‚æ•°ä¼šé€šè¿‡æç¤ºæ¨¡æ¿ä¼ é€’ç»™ LLMï¼Œæˆ‘ä»¬å¸Œæœ›è¿”å›çš„è¾“å‡ºåªæ˜¯å¯¹è¯çš„å»¶ç»­ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c1/7c/c11b24c318dbd762f13781e3e40f9b7c.png?wh=1592x1066\" alt=\"\"></p><p><strong>é‚£ä¹ˆå½“æœ‰äº†</strong> <strong>{history}</strong> <strong>å‚æ•°ï¼Œä»¥åŠ</strong> <strong>Human</strong> <strong>å’Œ</strong> <strong>AI</strong> <strong>è¿™ä¸¤ä¸ªå‰ç¼€ï¼Œæˆ‘ä»¬å°±èƒ½å¤ŸæŠŠå†å²å¯¹è¯ä¿¡æ¯å­˜å‚¨åœ¨æç¤ºæ¨¡æ¿ä¸­ï¼Œå¹¶ä½œä¸ºæ–°çš„æç¤ºå†…å®¹åœ¨æ–°ä¸€è½®çš„å¯¹è¯è¿‡ç¨‹ä¸­ä¼ é€’ç»™æ¨¡å‹ã€‚â€”â€” è¿™å°±æ˜¯è®°å¿†æœºåˆ¶çš„åŸç†</strong>ã€‚</p><p>ä¸‹é¢å°±è®©æˆ‘ä»¬æ¥åœ¨ConversationChainä¸­åŠ å…¥è®°å¿†åŠŸèƒ½ã€‚</p><h2>ä½¿ç”¨ConversationBufferMemory</h2><p>åœ¨LangChainä¸­ï¼Œé€šè¿‡ConversationBufferMemoryï¼ˆ<strong>ç¼“å†²è®°å¿†</strong>ï¼‰å¯ä»¥å®ç°æœ€ç®€å•çš„è®°å¿†æœºåˆ¶ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±åœ¨å¯¹è¯é“¾ä¸­å¼•å…¥ConversationBufferMemoryã€‚</p><pre><code class=\"language-plain\">from langchain import OpenAI\nfrom langchain.chains import ConversationChain\nfrom langchain.chains.conversation.memory import ConversationBufferMemory\n\n# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹\nllm = OpenAI(\n&nbsp; &nbsp; temperature=0.5,\n&nbsp; &nbsp; model_name=\"gpt-3.5-turbo-instruct\")\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconversation = ConversationChain(\n&nbsp; &nbsp; llm=llm,\n&nbsp; &nbsp; memory=ConversationBufferMemory()\n)\n\n# ç¬¬ä¸€å¤©çš„å¯¹è¯\n# å›åˆ1\nconversation(\"æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\")\nprint(\"ç¬¬ä¸€æ¬¡å¯¹è¯åçš„è®°å¿†:\", conversation.memory.buffer)\n</code></pre><p>è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">ç¬¬ä¸€æ¬¡å¯¹è¯åçš„è®°å¿†: \nHuman: æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\nAI:&nbsp; å“¦ï¼Œä½ å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œé‚£å¤ªæ£’äº†ï¼æˆ‘å¯ä»¥å¸®ä½ æ¨èä¸€äº›ç”Ÿæ—¥èŠ±æŸï¼Œä½ æƒ³è¦ä»€ä¹ˆæ ·çš„ï¼Ÿæˆ‘çŸ¥é“æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ç«ç‘°ã€åº·ä¹ƒé¦¨ã€éƒé‡‘é¦™ç­‰ç­‰ã€‚\n</code></pre><p>åœ¨ä¸‹ä¸€è½®å¯¹è¯ä¸­ï¼Œè¿™äº›è®°å¿†ä¼šä½œä¸ºä¸€éƒ¨åˆ†ä¼ å…¥æç¤ºã€‚</p><pre><code class=\"language-plain\"># å›åˆ2\nconversation(\"å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\")\nprint(\"ç¬¬äºŒæ¬¡å¯¹è¯åçš„è®°å¿†:\", conversation.memory.buffer)\n</code></pre><p>è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">ç¬¬äºŒæ¬¡å¯¹è¯åçš„è®°å¿†: \nHuman: æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\nAI:&nbsp; å“¦ï¼Œä½ å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œé‚£å¤ªæ£’äº†ï¼æˆ‘å¯ä»¥å¸®ä½ æ¨èä¸€äº›ç”Ÿæ—¥èŠ±æŸï¼Œä½ æƒ³è¦ä»€ä¹ˆæ ·çš„ï¼Ÿæˆ‘çŸ¥é“æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ç«ç‘°ã€åº·ä¹ƒé¦¨ã€éƒé‡‘é¦™ç­‰ç­‰ã€‚\nHuman: å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\nAI:&nbsp; å¥½çš„ï¼Œé‚£æˆ‘å¯ä»¥æ¨èä¸€æŸç²‰è‰²ç«ç‘°çš„ç”Ÿæ—¥èŠ±æŸç»™ä½ ã€‚ä½ æƒ³è¦å¤šå°‘æœµï¼Ÿæˆ‘å¯ä»¥å¸®ä½ å®šåˆ¶ä¸€æŸï¼Œæ¯”å¦‚è¯´åæœµã€äºŒåæœµæˆ–è€…æ›´å¤šï¼Ÿ\n</code></pre><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ç»§ç»­å¯¹è¯ï¼ŒåŒæ—¶æ‰“å°å‡ºæ­¤æ—¶æç¤ºæ¨¡æ¿çš„ä¿¡æ¯ã€‚</p><pre><code class=\"language-plain\"># å›åˆ3 ï¼ˆç¬¬äºŒå¤©çš„å¯¹è¯ï¼‰\nconversation(\"æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ\")\nprint(\"/nç¬¬ä¸‰æ¬¡å¯¹è¯åæ—¶æç¤º:/n\",conversation.prompt.template)\nprint(\"/nç¬¬ä¸‰æ¬¡å¯¹è¯åçš„è®°å¿†:/n\", conversation.memory.buffer)\n</code></pre><p>æ¨¡å‹è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">Human: æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\nAI:&nbsp; å“¦ï¼Œä½ å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œé‚£å¤ªæ£’äº†ï¼æˆ‘å¯ä»¥å¸®ä½ æ¨èä¸€äº›ç”Ÿæ—¥èŠ±æŸï¼Œä½ æƒ³è¦ä»€ä¹ˆæ ·çš„ï¼Ÿæˆ‘çŸ¥é“æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ç«ç‘°ã€åº·ä¹ƒé¦¨ã€éƒé‡‘é¦™ç­‰ç­‰ã€‚\nHuman: å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\nAI:&nbsp; å¥½çš„ï¼Œé‚£æˆ‘å¯ä»¥æ¨èä¸€æŸç²‰è‰²ç«ç‘°çš„ç”Ÿæ—¥èŠ±æŸç»™ä½ ï¼Œä½ æƒ³è¦å¤šå°‘æœµï¼Ÿ\nHuman: æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ\nAI:&nbsp; æ˜¯çš„ï¼Œæˆ‘è®°å¾—ä½ æ˜¨å¤©æ¥ä¹°èŠ±æ˜¯å› ä¸ºä½ å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œä½ æƒ³è¦ä¹°ä¸€æŸç²‰è‰²ç«ç‘°çš„ç”Ÿæ—¥èŠ±æŸç»™å¥¹ã€‚\n</code></pre><p>å®é™…ä¸Šï¼Œè¿™äº›èŠå¤©å†å²ä¿¡æ¯ï¼Œéƒ½è¢«ä¼ å…¥äº†ConversationChainçš„æç¤ºæ¨¡æ¿ä¸­çš„ {history} å‚æ•°ï¼Œæ„å»ºå‡ºäº†åŒ…å«èŠå¤©è®°å½•çš„æ–°çš„æç¤ºè¾“å…¥ã€‚</p><p>æœ‰äº†è®°å¿†æœºåˆ¶ï¼ŒLLMèƒ½å¤Ÿäº†è§£ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œè¿™æ ·ç®€å•ç›´æ¥åœ°å­˜å‚¨æ‰€æœ‰å†…å®¹ä¸ºLLMæä¾›äº†æœ€å¤§é‡çš„ä¿¡æ¯ï¼Œä½†æ˜¯æ–°è¾“å…¥ä¸­ä¹ŸåŒ…å«äº†æ›´å¤šçš„Tokenï¼ˆæ‰€æœ‰çš„èŠå¤©å†å²è®°å½•ï¼‰ï¼Œè¿™æ„å‘³ç€å“åº”æ—¶é—´å˜æ…¢å’Œæ›´é«˜çš„æˆæœ¬ã€‚è€Œä¸”ï¼Œå½“è¾¾åˆ°LLMçš„ä»¤ç‰Œæ•°ï¼ˆä¸Šä¸‹æ–‡çª—å£ï¼‰é™åˆ¶æ—¶ï¼Œå¤ªé•¿çš„å¯¹è¯æ— æ³•è¢«è®°ä½ï¼ˆå¯¹äºtext-davinci-003å’Œgpt-3.5-turboï¼Œæ¯æ¬¡çš„æœ€å¤§è¾“å…¥é™åˆ¶æ˜¯4096ä¸ªTokenï¼‰ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹é’ˆå¯¹Tokenå¤ªå¤šã€èŠå¤©å†å²è®°å½•è¿‡é•¿çš„ä¸€äº›è§£å†³æ–¹æ¡ˆã€‚</p><h2>ä½¿ç”¨ConversationBufferWindowMemory</h2><p>è¯´åˆ°è®°å¿†ï¼Œæˆ‘ä»¬äººç±»çš„å¤§è„‘ä¹Ÿä¸æ˜¯æ— ç©·æ— å°½çš„ã€‚æ‰€ä»¥è¯´ï¼Œæœ‰çš„æ—¶å€™äº‹æƒ…å¤ªå¤šï¼Œæˆ‘ä»¬åªèƒ½æŠŠæœ‰äº›é¥è¿œçš„è®°å¿†æŠ¹æ‰ã€‚æ¯•ç«Ÿï¼Œæœ€æ–°çš„ç»å†æœ€é²œæ´»ï¼Œä¹Ÿæœ€é‡è¦ã€‚</p><p>ConversationBufferWindowMemory æ˜¯<strong>ç¼“å†²çª—å£è®°å¿†</strong>ï¼Œå®ƒçš„æ€è·¯å°±æ˜¯åªä¿å­˜æœ€æ–°æœ€è¿‘çš„å‡ æ¬¡äººç±»å’ŒAIçš„äº’åŠ¨ã€‚å› æ­¤ï¼Œå®ƒåœ¨ä¹‹å‰çš„â€œç¼“å†²è®°å¿†â€åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ªçª—å£å€¼ kã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åªä¿ç•™ä¸€å®šæ•°é‡çš„è¿‡å»äº’åŠ¨ï¼Œç„¶åâ€œå¿˜è®°â€ä¹‹å‰çš„äº’åŠ¨ã€‚</p><p>ä¸‹é¢çœ‹ä¸€ä¸‹ç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">from langchain import OpenAI\nfrom langchain.chains import ConversationChain\nfrom langchain.chains.conversation.memory import ConversationBufferWindowMemory\n\n# åˆ›å»ºå¤§è¯­è¨€æ¨¡å‹å®ä¾‹\nllm = OpenAI(\n&nbsp; &nbsp; temperature=0.5,\n&nbsp; &nbsp; model_name=\"gpt-3.5-turbo-instruct\")\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconversation = ConversationChain(\n&nbsp; &nbsp; llm=llm,\n&nbsp; &nbsp; memory=ConversationBufferWindowMemory(k=1)\n)\n\n# ç¬¬ä¸€å¤©çš„å¯¹è¯\n# å›åˆ1\nresult = conversation(\"æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\")\nprint(result)\n# å›åˆ2\nresult = conversation(\"å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\")\n# print(\"\\nç¬¬äºŒæ¬¡å¯¹è¯åçš„è®°å¿†:\\n\", conversation.memory.buffer)\nprint(result)\n\n# ç¬¬äºŒå¤©çš„å¯¹è¯\n# å›åˆ3\nresult = conversation(\"æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ\")\nprint(result)\n</code></pre><p>ç¬¬ä¸€å›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚', \n'history': '',\n 'response': ' å“¦ï¼Œä½ å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼é‚£å¤ªæ£’äº†ï¼ä½ æƒ³è¦ä¸€æŸä»€ä¹ˆæ ·çš„èŠ±æŸå‘¢ï¼Ÿæœ‰å¾ˆå¤šç§ç±»å¯ä»¥é€‰æ‹©ï¼Œæ¯”å¦‚ç«ç‘°èŠ±æŸã€åº·ä¹ƒé¦¨èŠ±æŸã€éƒé‡‘é¦™èŠ±æŸç­‰ç­‰ï¼Œä½ æœ‰ä»€ä¹ˆå–œæ¬¢çš„å—ï¼Ÿ'}\n</code></pre><p>ç¬¬äºŒå›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚', \n'history': 'Human: æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\\nAI:&nbsp; å“¦ï¼Œä½ å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼é‚£å¤ªæ£’äº†ï¼ä½ æƒ³è¦ä¸€æŸä»€ä¹ˆæ ·çš„èŠ±æŸå‘¢ï¼Ÿæœ‰å¾ˆå¤šç§ç±»å¯ä»¥é€‰æ‹©ï¼Œæ¯”å¦‚ç«ç‘°èŠ±æŸã€åº·ä¹ƒé¦¨èŠ±æŸã€éƒé‡‘é¦™èŠ±æŸç­‰ç­‰ï¼Œä½ æœ‰ä»€ä¹ˆå–œæ¬¢çš„å—ï¼Ÿ', \n'response': ' å¥½çš„ï¼Œé‚£ç²‰è‰²ç«ç‘°èŠ±æŸæ€ä¹ˆæ ·ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ æ‰¾åˆ°ä¸€æŸéå¸¸æ¼‚äº®çš„ç²‰è‰²ç«ç‘°èŠ±æŸï¼Œä½ è§‰å¾—æ€ä¹ˆæ ·ï¼Ÿ'}\n</code></pre><p>ç¬¬ä¸‰å›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ', \n'history': 'Human: å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\\nAI:&nbsp; å¥½çš„ï¼Œé‚£ç²‰è‰²ç«ç‘°èŠ±æŸæ€ä¹ˆæ ·ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ æ‰¾åˆ°ä¸€æŸéå¸¸æ¼‚äº®çš„ç²‰è‰²ç«ç‘°èŠ±æŸï¼Œä½ è§‰å¾—æ€ä¹ˆæ ·ï¼Ÿ', \n'response': '&nbsp; å½“ç„¶è®°å¾—ï¼Œä½ æ˜¨å¤©æ¥ä¹°èŠ±æ˜¯ä¸ºäº†ç»™ä½ å–œæ¬¢çš„äººé€ä¸€æŸç²‰è‰²ç«ç‘°èŠ±æŸï¼Œè¡¨è¾¾ä½ å¯¹TAçš„çˆ±æ„ã€‚'}\n</code></pre><p>åœ¨ç»™å®šçš„ä¾‹å­ä¸­ï¼Œè®¾ç½® k=1ï¼Œè¿™æ„å‘³ç€çª—å£åªä¼šè®°ä½ä¸AIä¹‹é—´çš„æœ€æ–°çš„äº’åŠ¨ï¼Œå³åªä¿ç•™ä¸Šä¸€æ¬¡çš„äººç±»å›åº”å’ŒAIçš„å›åº”ã€‚</p><p>åœ¨ç¬¬ä¸‰ä¸ªå›åˆï¼Œå½“æˆ‘ä»¬è¯¢é—®â€œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿâ€ï¼Œç”±äºæˆ‘ä»¬åªä¿ç•™äº†æœ€è¿‘çš„äº’åŠ¨ï¼ˆk=1ï¼‰ï¼Œæ¨¡å‹å·²ç»å¿˜è®°äº†æ­£ç¡®çš„ç­”æ¡ˆã€‚æ‰€ä»¥ï¼Œè™½ç„¶å®ƒè¯´è®°å¾—ï¼Œä½†åªèƒ½æ¨¡ç³Šåœ°è¯´å‡ºâ€œå–œæ¬¢çš„äººâ€ï¼Œè€Œæ²¡æœ‰è¯´å…³é”®å­—â€œå§å§â€ã€‚ä¸è¿‡ï¼Œå¦‚æœï¼ˆæˆ‘æ˜¯è¯´å¦‚æœå“ˆï¼‰åœ¨ç¬¬äºŒä¸ªå›åˆï¼Œæ¨¡å‹èƒ½å›ç­”â€œæˆ‘å¯ä»¥å¸®ä½ <strong>ä¸ºä½ å§å§</strong>æ‰¾åˆ°â€¦â€ï¼Œé‚£ä¹ˆï¼Œå°½ç®¡æˆ‘ä»¬æ²¡æœ‰ç¬¬ä¸€å›åˆçš„å†å²è®°å½•ï¼Œä½†å‡­ç€ä¸Šä¸€ä¸ªå›åˆçš„ä¿¡æ¯ï¼Œæ¨¡å‹è¿˜æ˜¯æœ‰å¯èƒ½æ¨æ–­å‡ºæ˜¨å¤©æ¥çš„äººä¹°èŠ±çš„çœŸå®æ„å›¾ã€‚</p><p>å°½ç®¡è¿™ç§æ–¹æ³•ä¸é€‚åˆè®°ä½é¥è¿œçš„äº’åŠ¨ï¼Œä½†å®ƒéå¸¸æ“…é•¿é™åˆ¶ä½¿ç”¨çš„Tokenæ•°é‡ã€‚å¦‚æœåªéœ€è¦è®°ä½æœ€è¿‘çš„äº’åŠ¨ï¼Œç¼“å†²çª—å£è®°å¿†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯ï¼Œå¦‚æœéœ€è¦æ··åˆè¿œæœŸå’Œè¿‘æœŸçš„äº’åŠ¨ä¿¡æ¯ï¼Œåˆ™è¿˜æœ‰å…¶ä»–é€‰æ‹©ã€‚</p><h2>ä½¿ç”¨ConversationSummaryMemory</h2><p>ä¸Šé¢è¯´äº†ï¼Œå¦‚æœæ¨¡å‹åœ¨ç¬¬äºŒè½®å›ç­”çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè¯´å‡ºâ€œæˆ‘å¯ä»¥å¸®ä½ ä¸ºä½ å§å§æ‰¾åˆ°â€¦â€ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸‰è½®å›ç­”æ—¶ï¼Œå³ä½¿çª—å£å¤§å° k=1ï¼Œè¿˜æ˜¯èƒ½å¤Ÿå›ç­”å‡ºæ­£ç¡®ç­”æ¡ˆã€‚</p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>å› ä¸ºæ¨¡å‹<strong>åœ¨å›ç­”æ–°é—®é¢˜çš„æ—¶å€™ï¼Œå¯¹ä¹‹å‰çš„é—®é¢˜è¿›è¡Œäº†æ€»ç»“æ€§çš„é‡è¿°</strong>ã€‚</p><p>ConversationSummaryMemoryï¼ˆ<strong>å¯¹è¯æ€»ç»“è®°å¿†</strong>ï¼‰çš„æ€è·¯å°±æ˜¯å°†å¯¹è¯å†å²è¿›è¡Œæ±‡æ€»ï¼Œç„¶åå†ä¼ é€’ç»™ {history} å‚æ•°ã€‚è¿™ç§æ–¹æ³•æ—¨åœ¨é€šè¿‡å¯¹ä¹‹å‰çš„å¯¹è¯è¿›è¡Œæ±‡æ€»æ¥é¿å…è¿‡åº¦ä½¿ç”¨ Tokenã€‚</p><p>ConversationSummaryMemoryæœ‰è¿™ä¹ˆå‡ ä¸ªæ ¸å¿ƒç‰¹ç‚¹ã€‚</p><ol>\n<li>æ±‡æ€»å¯¹è¯ï¼šæ­¤æ–¹æ³•ä¸æ˜¯ä¿å­˜æ•´ä¸ªå¯¹è¯å†å²ï¼Œè€Œæ˜¯æ¯æ¬¡æ–°çš„äº’åŠ¨å‘ç”Ÿæ—¶å¯¹å…¶è¿›è¡Œæ±‡æ€»ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°ä¹‹å‰æ‰€æœ‰äº’åŠ¨çš„â€œè¿è¡Œæ±‡æ€»â€ä¸­ã€‚</li>\n<li>ä½¿ç”¨LLMè¿›è¡Œæ±‡æ€»ï¼šè¯¥æ±‡æ€»åŠŸèƒ½ç”±å¦ä¸€ä¸ªLLMé©±åŠ¨ï¼Œè¿™æ„å‘³ç€å¯¹è¯çš„æ±‡æ€»å®é™…ä¸Šæ˜¯ç”±AIè‡ªå·±è¿›è¡Œçš„ã€‚</li>\n<li>é€‚åˆé•¿å¯¹è¯ï¼šå¯¹äºé•¿å¯¹è¯ï¼Œæ­¤æ–¹æ³•çš„ä¼˜åŠ¿å°¤ä¸ºæ˜æ˜¾ã€‚è™½ç„¶æœ€åˆä½¿ç”¨çš„ Token æ•°é‡è¾ƒå¤šï¼Œä½†éšç€å¯¹è¯çš„è¿›å±•ï¼Œæ±‡æ€»æ–¹æ³•çš„å¢é•¿é€Ÿåº¦ä¼šå‡æ…¢ã€‚ä¸æ­¤åŒæ—¶ï¼Œå¸¸è§„çš„ç¼“å†²å†…å­˜æ¨¡å‹ä¼šç»§ç»­çº¿æ€§å¢é•¿ã€‚</li>\n</ol><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä½¿ç”¨ConversationSummaryMemoryçš„ä»£ç ç¤ºä¾‹ã€‚</p><pre><code class=\"language-plain\">from langchain.chains.conversation.memory import ConversationSummaryMemory\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconversation = ConversationChain(\n&nbsp; &nbsp; llm=llm,\n&nbsp; &nbsp; memory=ConversationSummaryMemory(llm=llm)\n)\n</code></pre><p>ç¬¬ä¸€å›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚', \n'history': '', \n'response': ' æˆ‘æ˜ç™½ï¼Œä½ éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚æˆ‘å¯ä»¥ä¸ºä½ æä¾›ä¸€äº›å»ºè®®å—ï¼Ÿæˆ‘å¯ä»¥æ¨èä¸€äº›èŠ±æŸç»™ä½ ï¼Œæ¯”å¦‚ç«ç‘°ï¼Œåº·ä¹ƒé¦¨ï¼Œç™¾åˆï¼Œä»™å®¢æ¥ï¼Œéƒé‡‘é¦™ï¼Œæ»¡å¤©æ˜Ÿç­‰ç­‰ã€‚æŒ‘é€‰ä¸€æŸæœ€é€‚åˆä½ å§å§çš„ç”Ÿæ—¥èŠ±æŸå§ï¼'}\n</code></pre><p>ç¬¬äºŒå›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚', \n'history': \"\\nThe human asked what the AI thinks of artificial intelligence. The AI thinks artificial intelligence is a force for good because it will help humans reach their full potential. The human then asked the AI for advice on what type of flower bouquet to get for their sister's birthday, to which the AI provided a variety of suggestions.\", \n'response': ' ä¸ºäº†ä¸ºä½ çš„å§å§çš„ç”Ÿæ—¥å‡†å¤‡ä¸€æŸèŠ±ï¼Œæˆ‘å»ºè®®ä½ æ­é…ç²‰è‰²ç«ç‘°å’Œç™½è‰²åº·ä¹ƒé¦¨ã€‚ä½ å¯ä»¥åœ¨ç«ç‘°èŠ±æŸä¸­æ·»åŠ ä¸€äº›ç´«è‰²çš„æ»¡å¤©æ˜Ÿï¼Œæˆ–è€…æ·»åŠ ä¸€äº›ç»¿å¶ä»¥å¢åŠ é¢œè‰²å¯¹æ¯”ã€‚è¿™å°†æ˜¯ä¸€æŸå¯çˆ±çš„èŠ±æŸï¼Œè®©ä½ å§å§çš„ç”Ÿæ—¥æ›´åŠ ç‰¹åˆ«ã€‚'}\n</code></pre><p>ç¬¬ä¸‰å›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ', \n'history': \"\\n\\nThe human asked what the AI thinks of artificial intelligence. The AI thinks artificial intelligence is a force for good because it will help humans reach their full potential. The human then asked the AI for advice on what type of flower bouquet to get for their sister's birthday, to which the AI suggested pink roses and white carnations with the addition of purple aster flowers and green leaves for contrast. This would make a lovely bouquet to make the sister's birthday extra special.\",\n'response': ' ç¡®å®ï¼Œæˆ‘è®°å¾—ä½ æ˜¨å¤©æƒ³ä¹°ä¸€æŸèŠ±ç»™ä½ çš„å§å§ä½œä¸ºç”Ÿæ—¥ç¤¼ç‰©ã€‚æˆ‘å»ºè®®ä½ ä¹°ç²‰çº¢è‰²çš„ç«ç‘°èŠ±å’Œç™½è‰²çš„åº·ä¹ƒé¦¨èŠ±ï¼Œå†åŠ ä¸Šç´«è‰²çš„é›èŠèŠ±å’Œç»¿å¶ï¼Œè¿™æ ·å¯ä»¥è®©ä½ çš„å§å§çš„ç”Ÿæ—¥æ›´åŠ ç‰¹åˆ«ã€‚'}\n</code></pre><p>çœ‹å¾—å‡ºæ¥ï¼Œè¿™é‡Œçš„ <code>'history'</code>ï¼Œä¸å†æ˜¯ä¹‹å‰äººç±»å’ŒAIå¯¹è¯çš„ç®€å•å¤åˆ¶ç²˜è´´ï¼Œè€Œæ˜¯ç»è¿‡äº†æ€»ç»“å’Œæ•´ç†ä¹‹åçš„ä¸€ä¸ªç»¼è¿°ä¿¡æ¯ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘ä»¬<strong>ä¸ä»…ä»…åˆ©ç”¨äº†LLMæ¥å›ç­”æ¯è½®é—®é¢˜ï¼Œè¿˜åˆ©ç”¨LLMæ¥å¯¹ä¹‹å‰çš„å¯¹è¯è¿›è¡Œæ€»ç»“æ€§çš„é™ˆè¿°ï¼Œä»¥èŠ‚çº¦Tokenæ•°é‡</strong>ã€‚è¿™é‡Œï¼Œå¸®æˆ‘ä»¬æ€»ç»“å¯¹è¯çš„LLMï¼Œå’Œç”¨æ¥å›ç­”é—®é¢˜çš„LLMï¼Œå¯ä»¥æ˜¯åŒä¸€ä¸ªå¤§æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„å¤§æ¨¡å‹ã€‚</p><p>ConversationSummaryMemoryçš„ä¼˜ç‚¹æ˜¯å¯¹äºé•¿å¯¹è¯ï¼Œå¯ä»¥å‡å°‘ä½¿ç”¨çš„ Token æ•°é‡ï¼Œå› æ­¤å¯ä»¥è®°å½•æ›´å¤šè½®çš„å¯¹è¯ä¿¡æ¯ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿç›´è§‚æ˜“æ‡‚ã€‚ä¸è¿‡ï¼Œå®ƒçš„ç¼ºç‚¹æ˜¯ï¼Œå¯¹äºè¾ƒçŸ­çš„å¯¹è¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ›´é«˜çš„ Token ä½¿ç”¨ã€‚å¦å¤–ï¼Œå¯¹è¯å†å²çš„è®°å¿†å®Œå…¨ä¾èµ–äºä¸­é—´æ±‡æ€»LLMçš„èƒ½åŠ›ï¼Œè¿˜éœ€è¦ä¸ºæ±‡æ€»LLMä½¿ç”¨ Tokenï¼Œè¿™å¢åŠ äº†æˆæœ¬ï¼Œä¸”å¹¶ä¸é™åˆ¶å¯¹è¯é•¿åº¦ã€‚</p><p>é€šè¿‡å¯¹è¯å†å²çš„æ±‡æ€»æ¥ä¼˜åŒ–å’Œç®¡ç† Token çš„ä½¿ç”¨ï¼ŒConversationSummaryMemory ä¸ºé‚£äº›é¢„æœŸä¼šæœ‰å¤šè½®çš„ã€é•¿æ—¶é—´å¯¹è¯çš„åœºæ™¯æä¾›äº†ä¸€ç§å¾ˆå¥½çš„æ–¹æ³•ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•ä»ç„¶å—åˆ° Token æ•°é‡çš„é™åˆ¶ã€‚åœ¨ä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬ä»ç„¶ä¼šè¶…è¿‡å¤§æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£é™åˆ¶ã€‚</p><p>è€Œä¸”ï¼Œæ€»ç»“çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰åŒºåˆ†è¿‘æœŸçš„å¯¹è¯å’Œé•¿æœŸçš„å¯¹è¯ï¼ˆé€šå¸¸æƒ…å†µä¸‹è¿‘æœŸçš„å¯¹è¯æ›´é‡è¦ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦ç»§ç»­å¯»æ‰¾æ–°çš„è®°å¿†ç®¡ç†æ–¹æ³•ã€‚</p><h2>ä½¿ç”¨ConversationSummaryBufferMemory</h2><p>æˆ‘è¦ä¸ºä½ ä»‹ç»çš„æœ€åä¸€ç§è®°å¿†æœºåˆ¶æ˜¯ConversationSummaryBufferMemoryï¼Œå³<strong>å¯¹è¯æ€»ç»“ç¼“å†²è®°å¿†</strong>ï¼Œå®ƒæ˜¯ä¸€ç§<strong>æ··åˆè®°å¿†</strong>æ¨¡å‹ï¼Œç»“åˆäº†ä¸Šè¿°å„ç§è®°å¿†æœºåˆ¶ï¼ŒåŒ…æ‹¬ConversationSummaryMemory å’Œ ConversationBufferWindowMemoryçš„ç‰¹ç‚¹ã€‚è¿™ç§æ¨¡å‹æ—¨åœ¨åœ¨å¯¹è¯ä¸­æ€»ç»“æ—©æœŸçš„äº’åŠ¨ï¼ŒåŒæ—¶å°½é‡ä¿ç•™æœ€è¿‘äº’åŠ¨ä¸­çš„åŸå§‹å†…å®¹ã€‚</p><p>å®ƒæ˜¯é€šè¿‡max_token_limitè¿™ä¸ªå‚æ•°åšåˆ°è¿™ä¸€ç‚¹çš„ã€‚å½“æœ€æ–°çš„å¯¹è¯æ–‡å­—é•¿åº¦åœ¨300å­—ä¹‹å†…çš„æ—¶å€™ï¼ŒLangChainä¼šè®°å¿†åŸå§‹å¯¹è¯å†…å®¹ï¼›å½“å¯¹è¯æ–‡å­—è¶…å‡ºäº†è¿™ä¸ªå‚æ•°çš„é•¿åº¦ï¼Œé‚£ä¹ˆæ¨¡å‹å°±ä¼šæŠŠæ‰€æœ‰è¶…è¿‡é¢„è®¾é•¿åº¦çš„å†…å®¹è¿›è¡Œæ€»ç»“ï¼Œä»¥èŠ‚çœTokenæ•°é‡ã€‚</p><pre><code class=\"language-plain\">from langchain.chains.conversation.memory import ConversationSummaryBufferMemory\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconversation = ConversationChain(\n&nbsp; &nbsp; llm=llm,\n&nbsp; &nbsp; memory=ConversationSummaryBufferMemory(\n&nbsp; &nbsp; &nbsp; &nbsp; llm=llm,\n&nbsp; &nbsp; &nbsp; &nbsp; max_token_limit=300))\n</code></pre><p>ç¬¬ä¸€å›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚', \n'history': '', \n'response': ' å“‡ï¼Œä½ å§å§è¦è¿‡ç”Ÿæ—¥å•Šï¼é‚£å¤ªæ£’äº†ï¼æˆ‘å»ºè®®ä½ å»ä¹°ä¸€æŸè‰²å½©é²œè‰³çš„èŠ±æŸï¼Œå› ä¸ºè¿™æ ·å¯ä»¥ä»£è¡¨ä½ ç»™å¥¹çš„ç¥ç¦å’Œç¥æ„¿ã€‚ä½ å¯ä»¥å»ä½ å®¶é™„è¿‘çš„èŠ±åº—ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥çœ‹çœ‹æœ‰æ²¡æœ‰ç‰¹åˆ«çš„èŠ±æŸï¼Œæ¯”å¦‚å½©è‰²ç«ç‘°æˆ–è€…ç™¾åˆèŠ±ï¼Œå®ƒä»¬ä¼šæ›´æœ‰ç‰¹è‰²ã€‚'}\n</code></pre><p>ç¬¬äºŒå›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚', \n'history': 'Human: æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\\nAI:&nbsp; å“‡ï¼Œä½ å§å§è¦è¿‡ç”Ÿæ—¥å•Šï¼é‚£å¤ªæ£’äº†ï¼æˆ‘å»ºè®®ä½ å»ä¹°ä¸€æŸè‰²å½©é²œè‰³çš„èŠ±æŸï¼Œå› ä¸ºè¿™æ ·å¯ä»¥ä»£è¡¨ä½ ç»™å¥¹çš„ç¥ç¦å’Œç¥æ„¿ã€‚ä½ å¯ä»¥å»ä½ å®¶é™„è¿‘çš„èŠ±åº—ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥çœ‹çœ‹æœ‰æ²¡æœ‰ç‰¹åˆ«çš„èŠ±æŸï¼Œæ¯”å¦‚å½©è‰²ç«ç‘°æˆ–è€…ç™¾åˆèŠ±ï¼Œå®ƒä»¬ä¼šæ›´æœ‰ç‰¹è‰²ã€‚', \n'response': ' å¥½çš„ï¼Œé‚£ç²‰è‰²ç«ç‘°å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼ä½ å¯ä»¥ä¹°ä¸€æŸç²‰è‰²ç«ç‘°èŠ±æŸï¼Œè¿™æ ·ä½ å§å§ä¼šå¾ˆå¼€å¿ƒçš„ï¼ä½ å¯ä»¥åœ¨èŠ±åº—é‡Œæ‰¾åˆ°ç²‰è‰²ç«ç‘°ï¼Œä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„é¢„ç®—ï¼Œé€‰æ‹©åˆé€‚çš„æ•°é‡ã€‚å¦å¤–ï¼Œä½ å¯ä»¥è€ƒè™‘æ·»åŠ ä¸€äº›è£…é¥°ï¼Œæ¯”å¦‚ç»†ç»³ã€å½©å¸¦æˆ–è€…å°ç¤¼å“'}\n</code></pre><p>ç¬¬ä¸‰å›åˆçš„è¾“å‡ºï¼š</p><pre><code class=\"language-plain\">{'input': 'æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ', \n'history': \"System: \\nThe human asked the AI for advice on buying a bouquet for their sister's birthday. The AI suggested buying a vibrant bouquet as a representation of their wishes and blessings, and recommended looking for special bouquets like colorful roses or lilies for something more unique.\\nHuman: å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\\nAI:&nbsp; å¥½çš„ï¼Œé‚£ç²‰è‰²ç«ç‘°å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼ä½ å¯ä»¥ä¹°ä¸€æŸç²‰è‰²ç«ç‘°èŠ±æŸï¼Œè¿™æ ·ä½ å§å§ä¼šå¾ˆå¼€å¿ƒçš„ï¼ä½ å¯ä»¥åœ¨èŠ±åº—é‡Œæ‰¾åˆ°ç²‰è‰²ç«ç‘°ï¼Œä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„é¢„ç®—ï¼Œé€‰æ‹©åˆé€‚çš„æ•°é‡ã€‚å¦å¤–ï¼Œä½ å¯ä»¥è€ƒè™‘æ·»åŠ ä¸€äº›è£…é¥°ï¼Œæ¯”å¦‚ç»†ç»³ã€å½©å¸¦æˆ–è€…å°ç¤¼å“\", \n'response': ' æ˜¯çš„ï¼Œæˆ‘è®°å¾—ä½ æ˜¨å¤©æ¥ä¹°èŠ±æ˜¯ä¸ºäº†ç»™ä½ å§å§çš„ç”Ÿæ—¥ã€‚ä½ æƒ³ä¹°ä¸€æŸç²‰è‰²ç«ç‘°èŠ±æŸæ¥è¡¨è¾¾ä½ çš„ç¥ç¦å’Œç¥æ„¿ï¼Œä½ å¯ä»¥åœ¨èŠ±åº—é‡Œæ‰¾åˆ°ç²‰è‰²ç«ç‘°ï¼Œä¹Ÿå¯ä»¥ä»ç½‘ä¸Šè®¢è´­ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„é¢„ç®—ï¼Œé€‰æ‹©åˆé€‚çš„æ•°é‡ã€‚å¦å¤–ï¼Œä½ å¯ä»¥è€ƒè™‘æ·»åŠ ä¸€äº›è£…é¥°ï¼Œæ¯”å¦‚ç»†ç»³ã€å½©å¸¦æˆ–è€…å°ç¤¼å“}\n</code></pre><p>ä¸éš¾çœ‹å‡ºï¼Œåœ¨ç¬¬äºŒå›åˆï¼Œè®°å¿†æœºåˆ¶å®Œæ•´åœ°è®°å½•äº†ç¬¬ä¸€å›åˆçš„å¯¹è¯ï¼Œä½†æ˜¯åœ¨ç¬¬ä¸‰å›åˆï¼Œå®ƒå¯Ÿè§‰å‡ºå‰ä¸¤è½®çš„å¯¹è¯å·²ç»è¶…å‡ºäº†300ä¸ªå­—èŠ‚ï¼Œå°±æŠŠæ—©æœŸçš„å¯¹è¯åŠ ä»¥æ€»ç»“ï¼Œä»¥èŠ‚çœTokenèµ„æºã€‚</p><p>ConversationSummaryBufferMemoryçš„ä¼˜åŠ¿æ˜¯é€šè¿‡æ€»ç»“å¯ä»¥å›å¿†èµ·è¾ƒæ—©çš„äº’åŠ¨ï¼Œè€Œä¸”æœ‰ç¼“å†²åŒºç¡®ä¿æˆ‘ä»¬ä¸ä¼šé”™è¿‡æœ€è¿‘çš„äº’åŠ¨ä¿¡æ¯ã€‚å½“ç„¶ï¼Œå¯¹äºè¾ƒçŸ­çš„å¯¹è¯ï¼ŒConversationSummaryBufferMemoryä¹Ÿä¼šå¢åŠ Tokenæ•°é‡ã€‚</p><p>æ€»ä½“æ¥è¯´ï¼ŒConversationSummaryBufferMemoryä¸ºæˆ‘ä»¬æä¾›äº†å¤§é‡çš„çµæ´»æ€§ã€‚å®ƒæ˜¯æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢çš„å”¯ä¸€è®°å¿†ç±»å‹ï¼Œå¯ä»¥å›å¿†èµ·è¾ƒæ—©çš„äº’åŠ¨å¹¶å®Œæ•´åœ°å­˜å‚¨æœ€è¿‘çš„äº’åŠ¨ã€‚åœ¨èŠ‚çœTokenæ•°é‡æ–¹é¢ï¼ŒConversationSummaryBufferMemoryä¸å…¶ä»–æ–¹æ³•ç›¸æ¯”ï¼Œä¹Ÿå…·æœ‰ç«äº‰åŠ›ã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>å¥½çš„ï¼Œä»Šå¤©æˆ‘ç»™ä½ ä»‹ç»äº†ä¸€ç§å¯¹è¯é“¾å’Œå››ç§ç±»å‹çš„å¯¹è¯è®°å¿†æœºåˆ¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªè¡¨æ ¼å¯¹è¿™å››ç§ç±»å‹çš„è®°å¿†åšä¸€ä¸ªæ•´ä½“æ¯”è¾ƒã€‚</p><p>å››ç§è®°å¿†æœºåˆ¶çš„æ¯”è¾ƒå¦‚ä¸‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a0/c0/a06b5db35405b74yy317de917eacbdc0.jpg?wh=1660x640\" alt=\"\"></p><p>ç½‘ä¸Šè¿˜æœ‰äººæ€»ç»“äº†ä¸€ä¸ªç¤ºæ„å›¾ï¼Œä½“ç°å‡ºäº†å½“å¯¹è¯è½®æ¬¡é€æ¸å¢åŠ æ—¶ï¼Œå„ç§è®°å¿†æœºåˆ¶å¯¹Tokençš„æ¶ˆè€—æ•°é‡ã€‚æ„å›¾å‘æˆ‘ä»¬è¡¨è¾¾çš„æ˜¯ï¼šæœ‰äº›è®°å¿†æœºåˆ¶ï¼Œæ¯”å¦‚è¯´ConversationSummaryBufferMemoryå’ŒConversationSummaryMemoryï¼Œåœ¨å¯¹è¯è½®æ¬¡è¾ƒå°‘çš„æ—¶å€™å¯èƒ½ä¼šæµªè´¹ä¸€äº›Tokenï¼Œä½†æ˜¯å¤šè½®å¯¹è¯è¿‡åï¼ŒTokençš„èŠ‚çœå°±é€æ¸ä½“ç°å‡ºæ¥äº†ã€‚</p><p>å½“ç„¶ConversationBufferWindowMemoryå¯¹äºTokençš„èŠ‚çœæœ€ä¸ºç›´æ¥ï¼Œä½†æ˜¯å®ƒä¼šå®Œå…¨é—å¿˜æ‰Kè½®ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œå› æ­¤å¯¹äºæŸäº›åœºæ™¯ä¹Ÿä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c5/ea/c56yyd7eb61637687de448512yy426ea.png?wh=3676x1478\" alt=\"\" title=\"å½“å¯¹è¯è½®æ¬¡é€æ¸å¢åŠ æ—¶ï¼Œå„ç§è®°å¿†æœºåˆ¶å¯¹ Token çš„æ¶ˆè€—æ•°é‡ï¼ˆä¼°ç®—ï¼‰\"></p><h2>æ€è€ƒé¢˜</h2><ol>\n<li>åœ¨ä½ çš„å®¢æœèŠå¤©æœºå™¨äººè®¾è®¡ä¸­ï¼Œä½ ä¼šé¦–å…ˆå‘ŠçŸ¥å®¢æˆ·ï¼šâ€œäº²ï¼Œæˆ‘çš„è®°å¿†èƒ½åŠ›æœ‰é™ï¼Œåªèƒ½è®°ä½å’Œä½ çš„æœ€è¿‘10æ¬¡å¯¹è¯å“¦ã€‚å¦‚æœæˆ‘å¿˜äº†ä¹‹å‰çš„å¯¹è¯ï¼Œè¯·ä½ ä½“è°…æˆ‘ã€‚â€ å½“æœ‰äº†è¿™æ ·çš„é¢„è®¾ï¼Œä½ ä¼šä¸ºä½ çš„ChatBoté€‰æ‹©é‚£ç§è®°å¿†æœºåˆ¶ï¼Ÿ</li>\n<li>å°è¯•æ”¹å˜ç¤ºä¾‹ç¨‹åºConversationBufferWindowMemoryä¸­çš„kå€¼ï¼Œå¹¶å¢åŠ å¯¹è¯è½®æ¬¡ï¼Œçœ‹çœ‹è®°å¿†æ•ˆæœã€‚</li>\n<li>å°è¯•æ”¹å˜ç¤ºä¾‹ç¨‹åºConversationSummaryBufferMemoryä¸­çš„max_token_limitå€¼ï¼Œçœ‹çœ‹è®°å¿†æ•ˆæœã€‚</li>\n</ol><p>æœŸå¾…åœ¨ç•™è¨€åŒºçœ‹åˆ°ä½ çš„åˆ†äº«ã€‚å¦‚æœä½ è§‰å¾—å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æœ‰éœ€è¦çš„æœ‹å‹ï¼æœ€åå¦‚æœä½ å­¦æœ‰ä½™åŠ›ï¼Œå¯ä»¥è¿›ä¸€æ­¥å­¦ä¹ ä¸‹é¢çš„å»¶ä¼¸é˜…è¯»ã€‚</p><h2>å»¶ä¼¸é˜…è¯»</h2><ol>\n<li>ä»£ç ï¼ŒConversationBufferMemoryçš„<a href=\"https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/buffer.py\">å®ç°ç»†èŠ‚</a></li>\n<li>ä»£ç ï¼ŒConversationSummaryMemoryçš„<a href=\"https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/memory/summary.py\">å®ç°ç»†èŠ‚</a></li>\n</ol>","neighbors":{"left":{"article_title":"09ï½œé“¾ï¼ˆä¸‹ï¼‰ï¼šæƒ³å­¦â€œè‚²èŠ±â€è¿˜æ˜¯â€œæ’èŠ±â€ï¼Ÿç”¨RouterChainç¡®å®šå®¢æˆ·æ„å›¾","id":703556},"right":{"article_title":"11ï½œä»£ç†ï¼ˆä¸Šï¼‰ï¼šReActæ¡†æ¶ï¼Œæ¨ç†ä¸è¡ŒåŠ¨çš„ååŒ","id":707191}},"comments":[{"had_liked":false,"id":381654,"user_name":"åœ¨è·¯ä¸Š","can_delete":false,"product_type":"c1","uid":1402511,"ip_address":"å¹¿ä¸œ","ucode":"6E31908EFE1107","user_header":"https://static001.geekbang.org/account/avatar/00/15/66/8f/02be926d.jpg","comment_is_top":false,"comment_ctime":1695610712,"is_pvip":false,"replies":[{"id":139018,"content":"å¾ˆèµï¼æ·±å…¥æºç åˆ†æï¼ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1695704071,"ip_address":"æ–°åŠ å¡","comment_id":381654,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"æˆ‘ä»¬å¯ä»¥é€šè¿‡æºç æ¥åˆ†æConversationSummaryBufferMemoryæ˜¯å¦‚ä½•å®ç°é•¿çŸ­æœŸè®°å¿†çš„ã€‚é¦–å…ˆè¦å…³æ³¨ConversationSummaryBufferMemory.save_context()æ–¹æ³•ï¼Œå®ƒå°†æ¯è½®å¯¹è¯çš„inputså’Œoutputsæˆå¯¹åŠ å…¥memoryï¼Œç„¶åè°ƒç”¨self.prune()æ–¹æ³•ã€‚prune()æ–¹æ³•ä¼šè®¡ç®—memoryçš„å½“å‰tokenæ•°ï¼Œå¦‚æœè¶…è¿‡self.max_token_limitï¼Œåˆ™å¯¹è¶…å‡ºçš„messagesæ€»ç»“ï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯self.predict_new_summary(pruned_memory, self.moving_summary_buffer)ã€‚æ€»ç»“æ—¶ä½¿ç”¨çš„PromptTemplateæ¥è‡ªprompt.pyçš„_DEFAULT_SUMMARIZER_TEMPLATEï¼Œ_DEFAULT_SUMMARIZER_TEMPLATEçš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š\nEXAMPLE\n...\nCurrent summary:\n{summary}\nNew lines of conversation:\n{new_lines}\nä¹Ÿå°±æ˜¯é€šè¿‡ç¤ºä¾‹ï¼Œè®©llmå­¦ä¹ å¦‚ä½•å®Œæˆé•¿æœŸè®°å¿†çš„æ€»ç»“ã€‚\n\nConversationSummaryBufferMemoryæ˜¯åœ¨åº”ç”¨å±‚å¹³è¡¡é•¿çŸ­æœŸè®°å¿†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹çœ‹æ¨¡å‹å±‚æ˜¯å¦‚ä½•å¹³è¡¡é•¿çŸ­æœŸè®°å¿†çš„ã€‚RNNæ¨¡å‹tæ—¶é—´æ­¥çš„éšè—å±‚å‚æ•°H_tè®¡ç®—å…¬å¼ä¸ºï¼šH_t = phi(X_t*W_xh+H_(t-1)*W_hh+b_h)ï¼ŒX_t*W_xhè¡¨ç¤ºçŸ­æœŸè®°å¿†ï¼ŒH_(t-1)*W_hhè¡¨ç¤ºé•¿æœŸè®°å¿†ï¼Œå¹³è¡¡é•¿çŸ­æœŸè®°å¿†ï¼Œå°±æ˜¯ç»™çŸ­æœŸè®°å¿†å’Œé•¿æœŸè®°å¿†åŠ ä¸€ä¸ªæƒé‡ï¼Œæ¥æ§åˆ¶å¯¹æ•´ä½“è®°å¿†ï¼ˆH_tï¼‰çš„å½±å“ã€‚ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œGRUå’ŒLSTMçš„æ¨¡å‹æœ‰åŒºåˆ«ï¼Œä½†æ˜¯åŸç†ä¸Šéƒ½æ˜¯ä¸ºçŸ­æœŸè®°å¿†å’Œé•¿æœŸè®°å¿†åŠ æƒé‡ã€‚","like_count":13,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628665,"discussion_content":"å¾ˆèµï¼æ·±å…¥æºç åˆ†æï¼ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695704071,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ–°åŠ å¡","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":3801776,"avatar":"","nickname":"Geek_42e319","note":"","ucode":"234FA8CA3A1013","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634168,"discussion_content":"_DEFAULT_SUMMARIZER_TEMPLATE è¿™ä¸ªpromptå¯ä»¥åœ¨å¤–éƒ¨è¢«ä¿®æ”¹å—ï¼Ÿè¿™ä¸ªpromptå¯¹ä¸­æ–‡å¾ˆä¸å‹å¥½ï¼Œéƒ½æŒ‰ç…§è‹±æ–‡summaryï¼Œå®¹æ˜“ä¸¢å¤±ä¸­æ–‡å…³é”®ä¿¡æ¯ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1703065105,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":381676,"user_name":"iLeGeND","can_delete":false,"product_type":"c1","uid":1055475,"ip_address":"åŒ—äº¬","ucode":"4055A628A6E97C","user_header":"https://static001.geekbang.org/account/avatar/00/10/1a/f3/41d5ba7d.jpg","comment_is_top":false,"comment_ctime":1695644899,"is_pvip":false,"replies":[{"id":139011,"content":"æ›´æ–°äº†ï¼ŒåŒå­¦å¿«å»çœ‹çœ‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1695701012,"ip_address":"æ–°åŠ å¡","comment_id":381676,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"githubä»£ç æ˜¯ä¸æ˜¯æ²¡æ›´æ–°å‘¢","like_count":4,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628656,"discussion_content":"æ›´æ–°äº†ï¼ŒåŒå­¦å¿«å»çœ‹çœ‹ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1695701012,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ–°åŠ å¡","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":389094,"user_name":"aloha66","can_delete":false,"product_type":"c1","uid":1469820,"ip_address":"å¹¿ä¸œ","ucode":"60AF4685BF38A2","user_header":"https://static001.geekbang.org/account/avatar/00/16/6d/7c/e91866cf.jpg","comment_is_top":false,"comment_ctime":1711547625,"is_pvip":false,"replies":[{"id":141712,"content":"å¯¹äºConversationSummaryBufferMemoryæ²¡æœ‰è®°ä½æ˜¨å¤©ä¹°èŠ±åŸå› çš„é—®é¢˜,å¯èƒ½æœ‰å‡ ä¸ªåŸå› :\n\n(1)ç¬¬äºŒå¤©çš„å¯¹è¯é‡æ–°åˆå§‹åŒ–äº†ä¸€ä¸ªConversationChainå¯¹è±¡,æ²¡æœ‰å¤ç”¨ç¬¬ä¸€å¤©çš„å¯¹è±¡,å¯¼è‡´è®°å¿†ä¸¢å¤±ã€‚éœ€è¦ç¡®ä¿ä¸¤å¤©ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªChainå’ŒMemoryå¯¹è±¡ã€‚\n\n(2)è®¾ç½®çš„max_token_limitå¤ªå°,æ— æ³•å­˜å‚¨è¾ƒé•¿çš„å¯¹è¯å†å²ã€‚å¯ä»¥å°è¯•é€‚å½“å¢å¤§max_token_limitã€‚\n\n(3)ç”¨æ¥ç”Ÿæˆæ€»ç»“çš„promptå¯èƒ½ä¸å¤Ÿæ¸…æ™°,æ²¡æœ‰å¾ˆå¥½åœ°æç‚¼å‡ºä¹°èŠ±çš„åŸå› ã€‚å¯ä»¥è°ƒæ•´summary_prompt,æ˜ç¡®è¦æ±‚æ€»ç»“çš„è¦ç‚¹ã€‚\n\næˆ‘å»ºè®®ä¾æ¬¡æ’æŸ¥ä»¥ä¸ŠåŸå› ,åº”è¯¥å¯ä»¥æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1712809464,"ip_address":"æ–°åŠ å¡","comment_id":389094,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"ä¸ºä»€ä¹ˆæˆ‘çš„ConversationSummaryBufferMemoryæ²¡è®°ä½æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±ã€‚\nfrom langchain_openai import ChatOpenAI\nfrom langchain.chains import ConversationChain\nfrom langchain.chains.conversation.memory import ConversationSummaryBufferMemory\nfrom util import base_url\n\n\n# åˆ›å»ºå¤§è¯­è¨€æ¨¡å‹å®ä¾‹\nllm = ChatOpenAI(temperature=0.5, base_url=base_url)\n\n\n# åˆå§‹åŒ–å¯¹è¯é“¾\nconversation = ConversationChain(\n    llm=llm, memory=ConversationSummaryBufferMemory(llm=llm, max_token_limit=300)\n)\n\n\n# ç¬¬ä¸€å¤©çš„å¯¹è¯\n# å›åˆ1\nresult = conversation.invoke(&quot;æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚&quot;)\nprint(&quot;å›åˆ1&quot;, result)\n# å›åˆ2\nresult = conversation.invoke(&quot;å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚&quot;)\n# print(&quot;\\nç¬¬äºŒæ¬¡å¯¹è¯åçš„è®°å¿†:\\n&quot;, conversation.memory.buffer)\nprint(&quot;å›åˆ2&quot;, result)\n\n# ç¬¬äºŒå¤©çš„å¯¹è¯\n# å›åˆ3\nresult = conversation.invoke(&quot;æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ&quot;)\nprint(&quot;å›åˆ3&quot;, result)\n# å›å¤\nå›åˆ3 {&#39;input&#39;: &#39;æˆ‘åˆæ¥äº†ï¼Œè¿˜è®°å¾—æˆ‘æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿ&#39;, &#39;history&#39;: &#39;Human: æˆ‘å§å§æ˜å¤©è¦è¿‡ç”Ÿæ—¥ï¼Œæˆ‘éœ€è¦ä¸€æŸç”Ÿæ—¥èŠ±æŸã€‚\\nAI:  \nå“‡ï¼Œç”Ÿæ—¥å¿«ä¹ç»™æ‚¨çš„å§å§ï¼æ‚¨æƒ³è¦ä»€ä¹ˆæ ·çš„èŠ±æŸå‘¢ï¼Ÿç«ç‘°ã€éƒé‡‘é¦™ã€ç™¾åˆè¿˜æ˜¯å…¶ä»–èŠ±å‰ï¼Ÿæ‚¨å¯ä»¥é€‰æ‹©å¥¹å–œæ¬¢çš„é¢œè‰²å’ŒèŠ±æï¼Œæˆ‘å¯ä»¥å¸®æ‚¨æ‰¾åˆ°æœ€åˆ\né€‚çš„èŠ±æŸã€‚æ‚¨çŸ¥é“å¥¹å–œæ¬¢çš„èŠ±å—ï¼Ÿ\\nHuman: å¥¹å–œæ¬¢ç²‰è‰²ç«ç‘°ï¼Œé¢œè‰²æ˜¯ç²‰è‰²çš„ã€‚\\nAI: ç²‰è‰²ç«ç‘°æ˜¯ä¸€ä¸ªå¾ˆæµªæ¼«çš„é€‰æ‹©ï¼æˆ‘ä¼šå¸®æ‚¨æ‰¾åˆ°ä¸€æŸç²‰è‰²ç« \nç‘°èŠ±æŸã€‚æ‚¨å¸Œæœ›èŠ±æŸé‡Œè¿˜æœ‰å…¶ä»–èŠ±å‰æ­é…å—ï¼Ÿæ¯”å¦‚ä¸€äº›ç»¿å¶æˆ–è€…å…¶ä»–é¢œè‰²çš„èŠ±æœµï¼Ÿæ‚¨è¿˜æœ‰å…¶ä»–è¦æ±‚å—ï¼Ÿè®©æˆ‘çŸ¥é“ï¼Œæˆ‘ä¼šä¸ºæ‚¨æ‰¾åˆ°å®Œç¾çš„ç”Ÿæ—¥èŠ±æŸ\nã€‚&#39;, &#39;response&#39;: &#39;æŠ±æ­‰ï¼Œæˆ‘æ— æ³•è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚æ‚¨å¯ä»¥å‘Šè¯‰æˆ‘æ‚¨æ˜¨å¤©ä¸ºä»€ä¹ˆè¦æ¥ä¹°èŠ±å—ï¼Ÿæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨æ‰¾åˆ°åˆé€‚çš„èŠ±æŸã€‚&#39;} ","like_count":1,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":641602,"discussion_content":"å¯¹äºConversationSummaryBufferMemoryæ²¡æœ‰è®°ä½æ˜¨å¤©ä¹°èŠ±åŸå› çš„é—®é¢˜,å¯èƒ½æœ‰å‡ ä¸ªåŸå› :\n\n(1)ç¬¬äºŒå¤©çš„å¯¹è¯é‡æ–°åˆå§‹åŒ–äº†ä¸€ä¸ªConversationChainå¯¹è±¡,æ²¡æœ‰å¤ç”¨ç¬¬ä¸€å¤©çš„å¯¹è±¡,å¯¼è‡´è®°å¿†ä¸¢å¤±ã€‚éœ€è¦ç¡®ä¿ä¸¤å¤©ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªChainå’ŒMemoryå¯¹è±¡ã€‚\n\n(2)è®¾ç½®çš„max_token_limitå¤ªå°,æ— æ³•å­˜å‚¨è¾ƒé•¿çš„å¯¹è¯å†å²ã€‚å¯ä»¥å°è¯•é€‚å½“å¢å¤§max_token_limitã€‚\n\n(3)ç”¨æ¥ç”Ÿæˆæ€»ç»“çš„promptå¯èƒ½ä¸å¤Ÿæ¸…æ™°,æ²¡æœ‰å¾ˆå¥½åœ°æç‚¼å‡ºä¹°èŠ±çš„åŸå› ã€‚å¯ä»¥è°ƒæ•´summary_prompt,æ˜ç¡®è¦æ±‚æ€»ç»“çš„è¦ç‚¹ã€‚\n\næˆ‘å»ºè®®ä¾æ¬¡æ’æŸ¥ä»¥ä¸ŠåŸå› ,åº”è¯¥å¯ä»¥æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1712809464,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ–°åŠ å¡","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1722719,"avatar":"","nickname":"Geek_Mask","note":"","ucode":"8F12201D679C25","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":653345,"discussion_content":"æˆ‘å‘ç°ä½ æŠŠ&#34;æ˜å¤©&#34;å»æ‰ä»–å°±èƒ½å›ç­”äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»–æ ¹æ®ä½ çš„é—®é—®é¢˜çš„æ—¶æ€æ–­å®šå¯¹è¯çš„æ˜¨å¤©ä¸æ˜¯æŒ‡ä»Šå¤©ã€‚è¿™ä¸ªåº”è¯¥è¿˜æ˜¯æ¨¡å‹çš„èƒ½åŠ›é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1730717641,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"åŒ—äº¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":382341,"user_name":"Webber","can_delete":false,"product_type":"c1","uid":2776202,"ip_address":"éŸ©å›½","ucode":"F9662546472FA7","user_header":"https://static001.geekbang.org/account/avatar/00/2a/5c/8a/244128ff.jpg","comment_is_top":false,"comment_ctime":1697094432,"is_pvip":false,"replies":[{"id":139284,"content":"å¥½é—®é¢˜ã€‚å¯ä»¥åšåˆ°ï¼Œå¤§æ¦‚è¿™æ ·ï¼ŒåŒå­¦å¯ä»¥è¯•è¯•è¡¥å…¨ä¸‹é¢ä»£ç ã€‚\n\nfrom langchain.memory import ConversationBufferMemory\nfrom langchain.agents import Tool\nfrom langchain.agents import AgentType\nfrom langchain.memory import ConversationBufferMemory\nfrom langchain.llms import OpenAI\nfrom langchain.utilities import SerpAPIWrapper\nfrom langchain.agents import initialize_agent\nfrom langchain.agents import AgentExecutor\n\nmemory = ConversationBufferMemory() \n\nagent_executor = initialize_agent(tools, llm, agent=AgentType.CONVERSATIONAL_REACT_DESCRIPTION, verbose=True, memory=memory)\nagent_executor = AgentExecutor(\n    agent=agent, \n    tools=tools,\n    memory=memory\n)\n\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1697425378,"ip_address":"ç‘å£«","comment_id":382341,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"è€å¸ˆï¼ŒConversationChainä¸­å¯ä»¥åŠ å…¥memoryæœºåˆ¶ï¼Œä½†æ˜¯agentsä¸­æ€ä¹ˆåŠ å…¥memoryæœºåˆ¶ä¸­å‘¢ã€‚initialize_agentå‡½æ•°ä¸­çš„å‚æ•°æ²¡æœ‰Chainç±»å‹ï¼Œåªæ˜¯LLMç±»å‹ã€‚","like_count":1,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":629597,"discussion_content":"å¥½é—®é¢˜ã€‚å¯ä»¥åšåˆ°ï¼Œå¤§æ¦‚è¿™æ ·ï¼ŒåŒå­¦å¯ä»¥è¯•è¯•è¡¥å…¨ä¸‹é¢ä»£ç ã€‚\n\nfrom langchain.memory import ConversationBufferMemory\nfrom langchain.agents import Tool\nfrom langchain.agents import AgentType\nfrom langchain.memory import ConversationBufferMemory\nfrom langchain.llms import OpenAI\nfrom langchain.utilities import SerpAPIWrapper\nfrom langchain.agents import initialize_agent\nfrom langchain.agents import AgentExecutor\n\nmemory = ConversationBufferMemory() \n\nagent_executor = initialize_agent(tools, llm, agent=AgentType.CONVERSATIONAL_REACT_DESCRIPTION, verbose=True, memory=memory)\nagent_executor = AgentExecutor(\n    agent=agent, \n    tools=tools,\n    memory=memory\n)\n\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1697425379,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ç‘å£«","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1763638,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/e9/36/96294f1d.jpg","nickname":"ç¨‹åºå‘˜åœ¨ä¿®è¡Œ","note":"","ucode":"384F2D1FDB7345","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636026,"discussion_content":"è€å¸ˆ, æˆ‘æ˜¯ç›´æ¥ç”¨çš„csv agent, çœ‹èµ·æ¥ä¸work. Googleäº†ä¸€ä¸‹åˆ, ä¼¼ä¹æ²¡æœ‰è§£, éº»çƒ¦å¸®å¿™çœ‹ä¸‹. è°¢è°¢\nmemory = ConversationBufferMemory()\nagent = create_csv_agent(OpenAI(temperature=0), file_path, verbose=True, agent_type=AgentType.ZERO_SHOT_REACT_DESCRIPTION,memory=memory)\nprint(agent.memory)\nprint(agent.run(&#34;how many records we have&#34;));  # =&gt; There are 100 records in the dataframe.\nprint(agent.run(&#34;how many records we have&#34;));  # =&gt; ä»ç„¶æ‰§è¡Œäº†ç›¸åŒçš„è·¯å¾„æ¥è®¡ç®— çœ‹èµ·æ¥æ²¡æœ‰åˆ©ç”¨memory\nprint(agent.memory)  # =&gt; None","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705482198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ—¥æœ¬","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":381800,"user_name":"æŠ½è±¡æ´¾","can_delete":false,"product_type":"c1","uid":2599971,"ip_address":"å¹¿ä¸œ","ucode":"6879F90CB702FC","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/YflLdCdbUAkfr9LPzF50EibDrMxBibPicQ5NNAETaPP0ytTmuR3h6QNichDMhDbR2XelSIXpOrPwbiaHgBkMJYOeULA/132","comment_is_top":false,"comment_ctime":1695882938,"is_pvip":false,"replies":[{"id":139087,"content":"æ˜¯çš„ï¼Œå°±ä¸å¤ªå‡†ç¡®äº†ã€‚ä»¥åçš„å¤§æ¨¡å‹ä¼šé€æ¸æ¥æ”¶æ›´é•¿çš„Tokençª—å£ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1696058644,"ip_address":"æ–°åŠ å¡","comment_id":381800,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"å¦‚æœå¯¹è¯çš„å†…å®¹è·¨åº¦æ¯”è¾ƒå¹¿ï¼Œæ˜¯ä¸æ˜¯æ€»ç»“å‡ºæ¥çš„å°±ä¸å¤ªå‡†ç¡®äº†ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628866,"discussion_content":"æ˜¯çš„ï¼Œå°±ä¸å¤ªå‡†ç¡®äº†ã€‚ä»¥åçš„å¤§æ¨¡å‹ä¼šé€æ¸æ¥æ”¶æ›´é•¿çš„Tokençª—å£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1696058644,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ–°åŠ å¡","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386265,"user_name":"humor","can_delete":false,"product_type":"c1","uid":1181867,"ip_address":"æµ™æ±Ÿ","ucode":"9B48C4C7BEC92C","user_header":"https://static001.geekbang.org/account/avatar/00/12/08/ab/caec7bca.jpg","comment_is_top":false,"comment_ctime":1704420874,"is_pvip":false,"replies":[{"id":140906,"content":"å—¯å—¯å¯¹çš„ï¼ŒåŒå­¦å¯¹äººç±»è®°å¿†çš„æ€è€ƒå’Œè¡¥å……éå¸¸æ·±åˆ»ã€‚å…¶å®æˆ‘ä»¬äººè„‘æ‰æ˜¯æ— ç©·æ— å°½çš„å®è—ã€‚æˆ‘ä»¬æœ‰ä¸å¦‚æœºå™¨çš„éƒ¨åˆ†ï¼Œä¹Ÿæœ‰è¿œè¶…æœºå™¨çš„è®¾å®šã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1705065711,"ip_address":"ç‘å£«","comment_id":386265,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"è€å¸ˆï¼Œé—®ä¸ªé¢˜å¤–è¯\n\nè¯´åˆ°è®°å¿†ï¼Œæˆ‘ä»¬äººç±»çš„å¤§è„‘ä¹Ÿä¸æ˜¯æ— ç©·æ— å°½çš„ã€‚æ‰€ä»¥è¯´ï¼Œæœ‰çš„æ—¶å€™äº‹æƒ…å¤ªå¤šï¼Œæˆ‘ä»¬åªèƒ½æŠŠæœ‰äº›é¥è¿œçš„è®°å¿†æŠ¹æ‰ã€‚æ¯•ç«Ÿï¼Œæœ€æ–°çš„ç»å†æœ€é²œæ´»ï¼Œä¹Ÿæœ€é‡è¦ã€‚\n\nä½ åœ¨æ–‡ä¸­è¯´äººç±»çš„è®°å¿†ä¸æ˜¯æ— ç©·æ— å°½çš„ï¼Œæˆ‘ä»¬åªèƒ½æŠŠé¥è¿œçš„è®°å¿†æŠ¹æ‰ã€‚ä½†æ˜¯æˆ‘è§‰å¾—äººç±»çš„è®°å¿†å¯ä»¥è®¤ä¸ºæ˜¯æ— ç©·æ— å°½çš„ï¼Œå› ä¸ºæˆ‘ä»¬å‡ ä¹ä¸å¯èƒ½è€—å°½æˆ‘ä»¬çš„è®°å¿†ç©ºé—´ï¼Œå¤§è„‘è¿˜æœ‰æå¼ºçš„å¯å¡‘æ€§ï¼Œè€Œä¸”æˆ‘ä»¬äººç±»ä¹Ÿæ²¡åŠæ³•ç›´æ¥æŠ¹å»é¥è¿œçš„è®°å¿†å§ã€‚äººç±»ä¼šå¯¹äºå°è±¡æ·±åˆ»çš„è®°å¿†æˆ–è€…ç»å¸¸é‡å¤çš„è®°å¿†ä¿ç•™å¾ˆé•¿æ—¶é—´ï¼Œå¹¶ä¸ä»…ä»…ä¸æ—¶é—´æœ‰å…³ï¼Œå¦‚æœä»…ä¸æ—¶é—´æœ‰å…³çš„è¯ï¼Œæˆ‘ä»¬å­¦ä¹ çš„æ„ä¹‰å°±æ²¡äº†å•Šï¼Œå› ä¸ºæˆ‘ä»¬å°±åªè®°å¾—åˆšå­¦è¿‡çš„ä¸œè¥¿äº†ğŸ¤”","like_count":0,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635710,"discussion_content":"å—¯å—¯å¯¹çš„ï¼ŒåŒå­¦å¯¹äººç±»è®°å¿†çš„æ€è€ƒå’Œè¡¥å……éå¸¸æ·±åˆ»ã€‚å…¶å®æˆ‘ä»¬äººè„‘æ‰æ˜¯æ— ç©·æ— å°½çš„å®è—ã€‚æˆ‘ä»¬æœ‰ä¸å¦‚æœºå™¨çš„éƒ¨åˆ†ï¼Œä¹Ÿæœ‰è¿œè¶…æœºå™¨çš„è®¾å®šã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705065712,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"ç‘å£«","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":381669,"user_name":"é˜¿æ–¯è’‚èŠ¬","can_delete":false,"product_type":"c1","uid":1024164,"ip_address":"å¹¿ä¸œ","ucode":"61D5E3BDA4EBC5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/a0/a4/b060c723.jpg","comment_is_top":false,"comment_ctime":1695633610,"is_pvip":false,"replies":[{"id":139075,"content":"å·®ä¸å¤šä¸€ä¸ªæ„æ€å“ˆã€‚è‡³äºåšæ±‡æ€»çš„æ¨¡å‹æ˜¯å¦æ›´ä¾¿å®œï¼Œæˆ‘ä¸å¤§æ¸…æ¥šã€‚ç»™ä½ ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·:https:&#47;&#47;gptforwork.com&#47;tools&#47;openai-chatgpt-api-pricing-calculator\nèƒ½çœ‹åˆ°æ‰€æœ‰æ¨¡å‹çš„ä»·æ ¼æ¯”è¾ƒã€‚gpt-3.5-turboæ˜¯æœ€ç‰©ç¾ä»·å»‰çš„ï¼Œæ¯”text-è¾¾æ–‡è¥¿ä¾¿å®œå¥½å¤šå‘¢ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1695872463,"ip_address":"æ–°åŠ å¡","comment_id":381669,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"â€œæ±‡æ€»â€çš„ç†å¿µè·Ÿâ€œæ‘˜è¦â€çš„ç†å¿µæ˜¯ä¸€è‡´çš„å—ï¼Ÿæ‰€ä»¥æ˜¯ä¸æ˜¯å®é™…åº”ç”¨ä¸­ï¼Œä¸“é—¨çš„â€œæ±‡æ€»â€æ¨¡å‹æˆ–è®¸ä»·æ ¼æ¯”Completions å’Œ chat  æ¨¡å‹æ›´ä¾¿å®œï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628807,"discussion_content":"å·®ä¸å¤šä¸€ä¸ªæ„æ€å“ˆã€‚è‡³äºåšæ±‡æ€»çš„æ¨¡å‹æ˜¯å¦æ›´ä¾¿å®œï¼Œæˆ‘ä¸å¤§æ¸…æ¥šã€‚ç»™ä½ ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·:https://gptforwork.com/tools/openai-chatgpt-api-pricing-calculator\nèƒ½çœ‹åˆ°æ‰€æœ‰æ¨¡å‹çš„ä»·æ ¼æ¯”è¾ƒã€‚gpt-3.5-turboæ˜¯æœ€ç‰©ç¾ä»·å»‰çš„ï¼Œæ¯”text-è¾¾æ–‡è¥¿ä¾¿å®œå¥½å¤šå‘¢ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695872464,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ–°åŠ å¡","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1024164,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/a0/a4/b060c723.jpg","nickname":"é˜¿æ–¯è’‚èŠ¬","note":"","ucode":"61D5E3BDA4EBC5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628639,"discussion_content":"æ¥äº¤ä½œä¸šäº†ã€‚\n1. ä¿ç•™æœ€è¿‘çš„10è½®å¯¹è¯ï¼Œä½¿ç”¨ConversationBufferWindowMemoryï¼Œè®¾ç½®k=10å³å¯\n2. ConversationBufferWindowMemory ä¸­kè¶Šå¤§ï¼Œä¿ç•™çš„å®Œæ•´å¯¹è¯å†å²è¶Šå¤šï¼Œå½“ç„¶ä¿ç•™è¶Šå¤šï¼Œä¹Ÿè¶Šå®¹æ˜“è§¦å‘tokensé™åˆ¶\n3. ConversationSummaryBufferMemory çš„ max_token_limit å½±å“äº†å…¶åœ¨ä¿ç•™æœ€è¿‘å’Œæœ€è¿œçš„å†å²å¯¹è¯çš„ç­–ç•¥ï¼Œè¿™å— @åœ¨è·¯ä¸Š çš„ä½œä¸šå€¼å¾—å­¦ä¹ ï¼\n\nè®°å½•ä¸€äº›ä¸Šæœºè¿‡ç¨‹ä¸­ç»éªŒ\n* é»˜è®¤conversationä½¿ç”¨çš„ memory facotry å°±æ˜¯ ConversationBufferMemory\n* å³ä½¿ä½¿ç”¨äº†ConversationBufferWindowMemoryï¼Œæ‰“å°çš„ memory.buffer ä¹Ÿæ˜¯å®Œæ•´çš„è®°å½•ï¼Œåªæ˜¯å†…éƒ¨è¯·æ±‚llmçš„æ—¶å€™åº”è¯¥æ˜¯æˆªæ–­äº†ï¼ˆæ­¤å¤„æºç çœ‹çš„ä¸æ·±ï¼‰\n* å› ä¸ºæ¢äº†å°è®¾å¤‡ï¼Œé‡æ–°å†™ä»£ç çš„æ—¶å€™å‘ç°æ²¡æœ‰ ConversationBufferWindowMemory åªæœ‰ ConversationalBufferWindowMemoryï¼Œè€Œä¸”æ— æ³•å¯¼å…¥ConversationSummaryBufferMemoryï¼Œçœ‹githubæœ€æ–°ä»£ç ï¼Œç¡®è®¤æ˜¯è‡ªå·±æœ¬åœ°é—®é¢˜ï¼Œä½†æŸ¥çœ‹langchainç‰ˆæœ¬ä¹Ÿæ˜¯æœ€æ–°ï¼Œæ— å¥ˆä½¿ç”¨é‡æ–°ç¼–è¯‘æºç æ–¹å¼ï¼Œæœç„¶å¥æ•ˆï¼Œä¸è€å¸ˆä»£ç ä¸€è‡´äº†ã€‚\n* åœ¨ä½¿ç”¨ Summary ç±»çš„ memory çš„æ—¶å€™ï¼Œä¼šå‘ç°æ—¶ä¸æ—¶å‡ºç° history æ˜¯è‹±æ–‡çš„æƒ…å†µï¼Œè¿™æ˜¯æ¨¡å‹çš„å¤„ç†ï¼Œè¿˜æ˜¯ LangChain çš„å¤„ç†å‘¢ï¼Ÿè¿™é‡Œå­˜ç–‘ã€‚\n","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1695653735,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628808,"discussion_content":"å’±ä»¬å…ˆæœŸå­¦ä¹ LangChainçš„åŒå­¦å­¦çš„éƒ½ç‰¹åˆ«è®¤çœŸï¼Œæˆ‘ç›¸ä¿¡è¿™ä¼šç»™ä»¥åå­¦ä¹ çš„åŒå­¦åšå‡ºæ¦œæ ·ï¼\næ—¢æ¥ä¹‹ï¼Œåˆ™å­¦ä¹‹ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695872625,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"æ–°åŠ å¡","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":381662,"user_name":"éª¨æ±¤é¸¡è›‹é¢","can_delete":false,"product_type":"c1","uid":1050002,"ip_address":"ä¸Šæµ·","ucode":"2AC141A523E710","user_header":"https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg","comment_is_top":false,"comment_ctime":1695625142,"is_pvip":false,"replies":[{"id":139076,"content":"æ€è·¯å¯¹çš„å“ˆã€‚åªæ˜¯è¿™è¾¹æˆ‘ä»¬ä¸€èˆ¬ä¸ç”¨â€œå˜é‡â€è¿™ä¸ªè¯ã€‚æˆ‘è§‰å¾—åŒå­¦çš„æ„æ€æ˜¯ï¼Œå„ç§Chainçš„æ ¸å¿ƒå°±æ˜¯çº¦å®šï¼ˆé¢„å®šï¼‰äº†å¾ˆå¤šæå‡æ¨¡æ¿çš„æ„å»ºæ–¹æ³•ã€‚è¿™æ˜¯LangChainç»™æˆ‘ä»¬å¸¦æ¥çš„ä¸€ä¸ªæ ¸å¿ƒæœºåˆ¶ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1809833,"ctime":1695874555,"ip_address":"æ–°åŠ å¡","comment_id":381662,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"è€å¸ˆï¼Œå¯ä»¥è®¤ä¸ºä¸åŒçš„chainéƒ½å¯¹åº”ä¸€ä¸ªpromptï¼Œçº¦å®šäº†å¾ˆå¤š å˜é‡ï¼Œmemory è¿™äº›æœºåˆ¶éƒ½é¢„å®šäº†è‡ªå·±å¯ä»¥æä¾›å“ªäº›å˜é‡å˜›ï¼Ÿ\n","like_count":0,"discussions":[{"author":{"id":1809833,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/9d/a9/4602808f.jpg","nickname":"é»„ä½³","note":"","ucode":"8EC41D2EAB0E3C","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":628811,"discussion_content":"æ€è·¯å¯¹çš„å“ˆã€‚åªæ˜¯è¿™è¾¹æˆ‘ä»¬ä¸€èˆ¬ä¸ç”¨â€œå˜é‡â€è¿™ä¸ªè¯ã€‚æˆ‘è§‰å¾—åŒå­¦çš„æ„æ€æ˜¯ï¼Œå„ç§Chainçš„æ ¸å¿ƒå°±æ˜¯çº¦å®šï¼ˆé¢„å®šï¼‰äº†å¾ˆå¤šæå‡æ¨¡æ¿çš„æ„å»ºæ–¹æ³•ã€‚è¿™æ˜¯LangChainç»™æˆ‘ä»¬å¸¦æ¥çš„ä¸€ä¸ªæ ¸å¿ƒæœºåˆ¶ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1695874555,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ–°åŠ å¡","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":393025,"user_name":"yanyu-xin","can_delete":false,"product_type":"c1","uid":1899757,"ip_address":"å¹¿ä¸œ","ucode":"3AA389F9E4C236","user_header":"","comment_is_top":false,"comment_ctime":1722517703,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100617601,"comment_content":"ç”¨ä»¥ä¸‹é€šä¹‰åƒé—®ä»£ç ä»£æ›¿OpenAI ï¼Œå­¦ä¹ è¯¾ç¨‹ä»£ç ã€‚\næ—§ä»£ç ï¼š\n# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹\n llm = OpenAI(\n     temperature=0.5,\n     model_name=&quot;text-davinci-003&quot;\n )\n\næ–°ä»£ç ï¼š\nfrom langchain_openai import ChatOpenAI\n# åˆå§‹åŒ–å¤§è¯­è¨€æ¨¡å‹\nllm = ChatOpenAI(\n    api_key=&quot;ï½˜ï½˜ï½˜ï½˜&quot;, ã€€# æ­¤å¤„ç”¨æ‚¨çš„DASHSCOPE_API_KEYè¿›è¡Œæ›¿æ¢\n    base_url=&quot;https:&#47;&#47;dashscope.aliyuncs.com&#47;compatible-mode&#47;v1&quot;, # å¡«å†™DashScope base_url\n    model=&quot;qwen-plus&quot;\n    )\n\nä½†æ˜¯ä½¿ç”¨ConversationSummaryBufferMemory æ—¶ï¼Œå‡ºç°NotImplementedError: get_num_tokens_from_messages() is not presently implemented for model cl100k_base.  æœç´¢äº†å¾ˆå¤šèµ„æ–™ï¼Œæ²¡æœ‰æ‰¾åˆ°ç®€å•çš„æ›¿ä»£æ–¹æ³•ã€‚å¯èƒ½æ˜¯é˜¿é‡Œäº‘çš„æŸäº›ç‰¹å®šæ¨¡å‹ä¸æ”¯æŒæŸäº›åŠŸèƒ½ã€‚","like_count":1},{"had_liked":false,"id":392502,"user_name":"å¼ ç”³å‚²","can_delete":false,"product_type":"c1","uid":1182372,"ip_address":"åŒ—äº¬","ucode":"22D46BC529BA8A","user_header":"https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg","comment_is_top":false,"comment_ctime":1721113751,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":2,"score":2,"product_id":100617601,"comment_content":"ç¬¬10è®²æ‰“å¡~\nå¯¹äºè®°å¿†ç³»ç»Ÿï¼Œå¯ä»¥å°è¯•ç»“åˆConversationSummaryBufferMemory+RAGçš„æ–¹æ¡ˆï¼Œå³çŸ­æœŸå…¨é‡è®°å¿†+é•¿æœŸæ‘˜è¦è®°å¿†+å‘é‡æ•°æ®åº“è¾…åŠ©è®°å¿†ï¼Œè¿™æ ·çš„è®°å¿†æ–¹å¼å¯èƒ½æ›´å¥½åœ°å¹³è¡¡æ€§èƒ½ã€å‡†ç¡®æ€§å’ŒTokenæˆæœ¬","like_count":1},{"had_liked":false,"id":389743,"user_name":"ç‹å‡¯","can_delete":false,"product_type":"c1","uid":1066040,"ip_address":"åŒ—äº¬","ucode":"52FD9ED35AA506","user_header":"https://static001.geekbang.org/account/avatar/00/10/44/38/8e05dac1.jpg","comment_is_top":false,"comment_ctime":1713358131,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100617601,"comment_content":"langchiané‡Œçš„memoryè®°å¿†æœºåˆ¶é¢å¯¹å¤šç”¨æˆ·åŒæ—¶æé—®ï¼Œæ˜¯æ€ä¹ˆåŒºåˆ†ä¸åŒçš„ç”¨æˆ·çš„å†å²è®°å½•çš„ï¼Ÿ","like_count":1},{"had_liked":false,"id":394376,"user_name":"åˆ˜åŒè£","can_delete":false,"product_type":"c1","uid":3870283,"ip_address":"åŒ—äº¬","ucode":"FB42C207F24A18","user_header":"https://static001.geekbang.org/account/avatar/00/3b/0e/4b/ff4a21de.jpg","comment_is_top":false,"comment_ctime":1726653296,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100617601,"comment_content":"æåˆ°äº†4ç§ä¼šä¹‰è®°å¿†æ¨¡å¼ï¼Œ","like_count":0},{"had_liked":false,"id":389687,"user_name":"onemao","can_delete":false,"product_type":"c1","uid":1969439,"ip_address":"æ–°åŠ å¡","ucode":"1CB4101525C2D1","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/rURvBicplInVqwb9rX21a4IkcKkITIGIo7GE1Tcp3WWU49QtwV53qY8qCKAIpS6x68UmH4STfEcFDJddffGC7lw/132","comment_is_top":false,"comment_ctime":1713252388,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100617601,"comment_content":"ä½¿ç”¨ConversationSummaryMemory, åé¢AIçš„å›å¤å§å§ç¼–ç¨‹å¦¹å¦¹äº†ğŸ˜„","like_count":0},{"had_liked":false,"id":388608,"user_name":"å¤§å¸ˆå…„","can_delete":false,"product_type":"c1","uid":1136897,"ip_address":"åŒ—äº¬","ucode":"37273A01E3A205","user_header":"https://static001.geekbang.org/account/avatar/00/11/59/01/b8709bb9.jpg","comment_is_top":false,"comment_ctime":1710470537,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":3,"product_id":100617601,"comment_content":"è¯·é—®ConversationSummaryBufferMemoryåœ¨è¶…è¿‡max_token_limitä»¥åæ˜¯å°†æ‰€æœ‰å†…å®¹è¿›è¡Œæ€»ç»“è¿˜æ˜¯å°†è¶…è¿‡max_token_limitçš„å†…å®¹è¿›è¡Œæ€»ç»“ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1052191,"avatar":"https://static001.geekbang.org/account/avatar/00/10/0e/1f/d0472177.jpg","nickname":"å‰å®³äº†æˆ‘çš„å›½","note":"","ucode":"CD0A54A1B998AA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":639440,"discussion_content":"    def save_context(self, inputs: Dict[str, Any], outputs: Dict[str, str]) -&gt; None:\n        &#34;&#34;&#34;Save context from this conversation to buffer.&#34;&#34;&#34;\n        super().save_context(inputs, outputs)\n        self.prune()\n\n    def prune(self) -&gt; None:\n        &#34;&#34;&#34;Prune buffer if it exceeds max token limit&#34;&#34;&#34;\n        buffer = self.chat_memory.messages\n        curr_buffer_length = self.llm.get_num_tokens_from_messages(buffer)\n        if curr_buffer_length &gt; self.max_token_limit:\n            pruned_memory = []\n            while curr_buffer_length &gt; self.max_token_limit:\n                pruned_memory.append(buffer.pop(0))\n                curr_buffer_length = self.llm.get_num_tokens_from_messages(buffer)\n            self.moving_summary_buffer = self.predict_new_summary(\n                pruned_memory, self.moving_summary_buffer\n            )\n\nçœ‹ConversationSummaryBufferMemoryçš„æºç ï¼Œæ¯æ¬¡ä¿å­˜æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨pruneæ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœmessagesé•¿åº¦å¤§äºmax_token_limitï¼Œä¼šæŒ‰ç…§ä»è¿œåˆ°è¿‘çš„é¡ºåºä¾æ¬¡æŠŠå†å²messageæ”¾å…¥åˆ°ä¸€ä¸ªå¾…æ€»ç»“çš„æ¶ˆæ¯åˆ—è¡¨é‡Œï¼Œç„¶åå¯¹è¿™ä¸ªæ¶ˆæ¯åˆ—è¡¨åšæ€»ç»“","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1710671122,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"ä¸Šæµ·","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}