{"id":621941,"title":"83｜关系型数据库：怎样使用关系型数据库？","content":"<p><strong>课后习题</strong><br>\n请尝试通过 Python 读取当前执行程序的电脑的 IP 地址，并将 IP 地址存储到 MySQL 数据库中。</p><p><strong>课程代码、课件及其他相关资料地址</strong><br>\n<a href=\"https://gitee.com/wilsonyin/zero-basics-python\">https://gitee.com/wilsonyin/zero-basics-python</a></p>","comments":[{"had_liked":false,"id":386285,"user_name":"Guan YD","can_delete":false,"product_type":"c3","uid":2000972,"ip_address":"陕西","ucode":"76540F350800A9","user_header":"https://static001.geekbang.org/account/avatar/00/1e/88/4c/9a732f67.jpg","comment_is_top":false,"comment_ctime":1704442375,"is_pvip":false,"replies":[{"id":140984,"content":"根据你的留言，提几个小建议：\n1使用实例属性而非类属性：在你的代码中，数据库连接和游标作为类属性，意味着所有DB类的实例都将共享同一个数据库连接和游标。这可能导致在多线程环境中的问题。建议将它们定义为实例属性。\n2 异常处理：当执行数据库操作时，最好捕获特定异常以提供更详细的错误信息。","user_name":"作者回复","user_name_real":"编辑","uid":1056235,"ctime":1705419191,"ip_address":"广东","comment_id":386285,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"按照自己的想法写了一个class 但是在类属性的使用上感觉很别扭，不知道这么写是不是合适\n\nimport pymysql\nimport socket\n\n\nclass DB:\n    tableName = &quot;py_test.ip_record&quot;\n    conn = None\n    cursors = None\n\n    def __init__(self):\n        DB.conn = pymysql.connect(\n            host=&quot;127.0.0.1&quot;,\n            user=&quot;root&quot;,\n            password=&quot;123456&quot;,\n            database=&quot;py_test&quot;,\n            cursorclass=pymysql.cursors.DictCursor\n        )\n\n        DB.cursors = DB.conn.cursor()\n\n    def __del__(self):\n        DB.conn.close()\n\n    def get_by_ip(self, ip):\n        sql = f&quot;select id,ip_addr from {DB.tableName} where ip_addr = &#39;{ip}&#39;&quot;\n        DB.cursors.execute(sql)\n        result = DB.cursors.fetchall()\n        return result\n\n    def add_info(self, ip):\n        sql = f&quot;insert into {DB.tableName} set ip_addr = &#39;{ip}&#39;&quot;\n        DB.cursors.execute(sql)\n        try:\n            DB.conn.commit()\n            return &quot;add success&quot;\n        except:\n            DB.conn.rollback()\n            return &quot;add error&quot;\n\n\n# 获取本机ip\ndef get_local_ip():\n    hostname = socket.gethostname()\n    ip = socket.gethostbyname(hostname)\n    return ip\n\n\nlocal_ip = get_local_ip()\ndb = DB()\nadd_res = db.add_info(local_ip)\nprint(add_res)\nres = db.get_by_ip(local_ip)\nprint(res)","like_count":0,"discussions":[{"author":{"id":1056235,"avatar":"https://static001.geekbang.org/account/avatar/00/10/1d/eb/b2123759.jpg","nickname":"尹会生","note":"","ucode":"D1093DBD093617","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635979,"discussion_content":"根据你的留言，提几个小建议：\n1使用实例属性而非类属性：在你的代码中，数据库连接和游标作为类属性，意味着所有DB类的实例都将共享同一个数据库连接和游标。这可能导致在多线程环境中的问题。建议将它们定义为实例属性。\n2 异常处理：当执行数据库操作时，最好捕获特定异常以提供更详细的错误信息。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705419192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":366473,"user_name":"Matthew","can_delete":false,"product_type":"c3","uid":2843865,"ip_address":"江苏","ucode":"96093089773740","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKSVuNarJuDhBSvHY0giaq6yriceEBKiaKuc04wCYWOuso50noqDexaPJJibJN7PHwvcQppnzsDia1icZkw/132","comment_is_top":false,"comment_ctime":1673838847,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"CREATE TABLE `ip_record` (\n    `id` int(11) NOT NULL AUTO_INCREMENT,\n    `ip_addr` varchar(255) COLLATE utf8_bin NOT NULL,\n    PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin\nAUTO_INCREMENT=1 ;","like_count":1},{"had_liked":false,"id":366472,"user_name":"Matthew","can_delete":false,"product_type":"c3","uid":2843865,"ip_address":"江苏","ucode":"96093089773740","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKSVuNarJuDhBSvHY0giaq6yriceEBKiaKuc04wCYWOuso50noqDexaPJJibJN7PHwvcQppnzsDia1icZkw/132","comment_is_top":false,"comment_ctime":1673838840,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"import socket\nimport pymysql\n\n# 创建 socket，获取 client_ip\nwith socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as s:\n    s.connect((&quot;8.8.8.8&quot;, 80))\n    client_ip = s.getsockname()[0]\n    print(client_ip)\n\n# 连接数据库\nconnection = pymysql.connect(host=&#39;localhost&#39;,\n                             user=&#39;root&#39;,\n                             password=&#39;admin123&#39;,\n                             database=&#39;db&#39;,\n                             cursorclass=pymysql.cursors.DictCursor)\n\nwith connection:\n    # 插入纪录\n    with connection.cursor() as cursor:\n        sql = &quot;INSERT INTO ip_record (ip_addr) VALUES (%s)&quot;\n        try:\n            cursor.execute(sql, str(client_ip))\n            connection.commit()\n            print(&quot;Insert success!&quot;)\n        except:\n            connection.rollback()\n            print(&quot;Insert fail!&quot;)\n    \n    # 读取纪录\n    with connection.cursor() as cursor:\n        sql = &quot;SELECT id, ip_addr FROM ip_record&quot;\n        cursor.execute(sql)\n        # result = cursor.fetchone()\n        result = cursor.fetchall()\n        print(result)\n        \n    # 删除记录\n    with connection.cursor() as cursor:\n        sql = &quot;DELETE FROM ip_record WHERE ip_addr = %s&quot;\n        try:\n            cursor.execute(sql, str(client_ip))\n            connection.commit()\n            print(&quot;Delete success!&quot;)\n        except:\n            connection.rollback()\n            print(&quot;Delete fail!&quot;)\n            \n    # 读取纪录\n    with connection.cursor() as cursor:\n        sql = &quot;SELECT id, ip_addr FROM ip_record&quot;\n        cursor.execute(sql)\n        # result = cursor.fetchone()\n        result = cursor.fetchall()\n        print(result)","like_count":1},{"had_liked":false,"id":385100,"user_name":"Geek_631607","can_delete":false,"product_type":"c3","uid":3789991,"ip_address":"广东","ucode":"EAF874838F0BE4","user_header":"","comment_is_top":false,"comment_ctime":1702042006,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"import socket\nimport pymysql\n\ndef get_ip_address():\n    hostname = socket.gethostname()\n    ip_address = socket.gethostbyname(hostname)\n    return ip_address\n\ndef store_ip_address(ip_address):\n    db = pymysql.connect(host=&#39;localhost&#39;, user=&#39;root&#39;, password=&#39;admin&#39;, database=&#39;kkb&#39;, cursorclass=pymysql.cursors.DictCursor)\n    with db:\n        with db.cursor() as cu:\n            cu.execute(&quot;CREATE TABLE IF NOT EXISTS ip_addresss(ip varchar(255))&quot;)\n            cu.execute(f&quot;INSERT INTO ip_addresss VALUES (&#39;{ip_address}&#39;)&quot;)\n        \n        db.commit()\n\nip_address = get_ip_address()\nstore_ip_address(ip_address)","like_count":0},{"had_liked":false,"id":385099,"user_name":"Geek_631607","can_delete":false,"product_type":"c3","uid":3789991,"ip_address":"广东","ucode":"EAF874838F0BE4","user_header":"","comment_is_top":false,"comment_ctime":1702041503,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"在 Python 中，你可以使用 `socket` 库来获取当前执行程序的电脑的 IP 地址，然后使用 `pymysql` 库将 IP 地址存储到 MySQL 数据库中。以下是一个示例：\n\n```python\nimport socket\nimport pymysql\n\n# 获取本机 IP 地址\ndef get_ip_address():\n    hostname = socket.gethostname()\n    ip_address = socket.gethostbyname(hostname)\n    return ip_address\n\n# 将 IP 地址存储到 MySQL 数据库中\ndef store_ip_address(ip_address):\n    # 连接到数据库（请替换为你的数据库信息）\n    db = pymysql.connect(&quot;localhost&quot;, &quot;username&quot;, &quot;password&quot;, &quot;database&quot;)\n    cursor = db.cursor()\n    # 创建表\n    cursor.execute(&quot;CREATE TABLE IF NOT EXISTS ip_addresses (ip VARCHAR(255))&quot;)\n    # 插入 IP 地址\n    cursor.execute(f&quot;INSERT INTO ip_addresses VALUES (&#39;{ip_address}&#39;)&quot;)\n    db.commit()\n    db.close()\n\nip_address = get_ip_address()\nstore_ip_address(ip_address)\n```\n\n在这个代码中，`get_ip_address` 函数用于获取本机的 IP 地址，`store_ip_address` 函数用于将 IP 地址存储到 MySQL 数据库中。你需要将数据库连接信息（如主机名、用户名、密码和数据库名）替换为你自己的信息。\n\n请注意，这只是一个基本的示例，你可能需要根据实际情况调整代码，例如处理可能出现的异常，或者添加更多的数据库操作。                                                                                                   .","like_count":0},{"had_liked":false,"id":383836,"user_name":"William","can_delete":false,"product_type":"c3","uid":1346215,"ip_address":"吉林","ucode":"55F5D9DEE485B1","user_header":"https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg","comment_is_top":false,"comment_ctime":1699777098,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"# pip3 install PyMqSQL 安装库\n\nimport pymysql\n\n# 连接\nconnect = pymysql.connect(host=&#39;localhost&#39;,\n                          user=&#39;root&#39;,\n                          passwd=&#39;ac&#39;,\n                          db=&#39;db&#39;,\n                          cursorclass=pymysql.cursors.DictCursor)\n\nwith connect:\n    # 查询\n    with connect.cursor() as cursor:\n        sql = &quot;select * from users&quot;\n        # 执行语句\n        cursor.execute(sql)\n        result = cursor.fetchall()\n        print(result)\n\n    # 新增\n    # with connect.cursor() as cursor:\n    #     sql = &quot;insert into users (email, password)   values (%s, %s)&quot;\n    #     cursor.execute(sql, (&#39;lyy@qq.com&#39;, &#39;lyypw&#39;))\n    #     connect.commit()\n\n    # 修改\n    with connect.cursor() as cursor:\n        sql = &quot;update users set email = %s where id =%s&quot;\n        cursor.execute(sql, [&quot;lyy22@qq.com&quot;, 3])\n        connect.commit()\n\n    # 查询\n    with connect.cursor() as cursor:\n        sql = &quot;select * from users&quot;\n        # 执行语句\n        cursor.execute(sql)\n        result = cursor.fetchall()\n        print(result)","like_count":0},{"had_liked":false,"id":382801,"user_name":"MarkG","can_delete":false,"product_type":"c3","uid":3675806,"ip_address":"山东","ucode":"454082595FE769","user_header":"https://static001.geekbang.org/account/avatar/00/38/16/9e/48621655.jpg","comment_is_top":false,"comment_ctime":1698061482,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"课后习题：\n先获取ip地址，然后保存起来\n写入sql的把ip地址写进入\n\n获取ip，保存到ip_address中\nimport socket\n\nhostname = socket.gethostname()\nip_address = socket.gethostbyname(hostname)\n\n\n# 写入sql\nwith connection:\n    with connection.cursor() as cursor:\n        # 建立一条记录\n        sql = &quot;INSERT INTO `users` (`email`, `password`, `ip`) VALUES (%s, %s, %s)&quot;\n        cursor.execute(sql, (&#39;bianlin@alibaba-inc.com&#39;, &#39;bianlin&#39;, ip_address))\n\n    # connection 不能自动提交数据，必须手动提交\n    connection.commit()\n\n\n读取：\nwith connection:\n    with connection.cursor() as cursor:\n        # 读取记录\n        sql = &quot;SELECT `id`, `password`, `ip` FROM `users` WHERE `email`=%s&quot;\n        cursor.execute(sql, (&#39;bianlin@alibaba-inc.com&#39;,))\n        result = cursor.fetchone()\n        print(result)","like_count":0},{"had_liked":false,"id":380134,"user_name":"Geek_Mike","can_delete":false,"product_type":"c3","uid":3196376,"ip_address":"云南","ucode":"CFA942192C3B74","user_header":"https://static001.geekbang.org/account/avatar/00/30/c5/d8/c5509b9c.jpg","comment_is_top":false,"comment_ctime":1693061874,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"import pymysql\nimport socket\n\nip_adress = socket.gethostbyname(socket.gethostname())\n\nconn = pymysql.connect(host=&#39;localhost&#39;, user=&#39;root&#39;, \n                       password=&#39;123123123&#39;, database=&#39;db&#39;)\n# print(db)\n\nwith conn:\n    with conn.cursor() as cursor:\n        sql = &#39;INSERT INTO info (ip_address) VALUES (%s)&#39;\n        cursor.execute(sql, (ip_adress))\n    conn.commit()\n\n    with conn.cursor() as cursor:\n        sql = &#39;SELECT ip_address FROM info&#39;\n        cursor.execute(sql)\n        result = cursor.fetchone()\n        print(result)\n    conn.commit()","like_count":0},{"had_liked":false,"id":367965,"user_name":"繁星不灭","can_delete":false,"product_type":"c3","uid":3042945,"ip_address":"广东","ucode":"7610E71D8FF224","user_header":"https://static001.geekbang.org/account/avatar/00/2e/6e/81/a52fe3f6.jpg","comment_is_top":false,"comment_ctime":1675771393,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"一.习题练习（Linux版）\n1.搭建数据库，创建表\n#编译安装mysql数据库，依然使用db数据库，创建表\nmysql&gt; create table hostname_ip (\n    -&gt; id int(11) not null auto_increment,\n    -&gt; hostname varchar(255) not null,\n    -&gt; ip varchar(255) not null,\n    -&gt; primary key (id)\n    -&gt; );\n\n2.linux环境\npython服务器IP：10.100.36.29\nmysql服务器IP：10.100.36.25\n\n2.编写.py文件\nimport pymysql.cursors\nimport socket\n\n#获取本地主机名和IP\nhostname=socket.gethostname()\nip=socket.gethostbyname(hostname)\n\n#连接数据库\nconnection=pymysql.connect(host=&quot;10.100.36.25&quot;,user=&quot;root&quot;,password=&quot;rootroot&quot;,database=&quot;db&quot;,port=33600,cursorclass=pymysql.cursors.DictCursor)\n\nwith connection:\n    # 插入数据\n    with connection.cursor() as cursor:\n        sql=&quot;INSERT INTO `hostname_ip` (`hostname`,`ip`) values (%s,%s)&quot;\n        cursor.execute(sql,(hostname,ip))\n    connection.commit()\n\n    #查询结果\n    with connection.cursor() as cursor:\n        sql = &quot;SELECT * FROM `hostname_ip`&quot;\n        cursor.execute(sql)\n        result = cursor.fetchone()\n        print(result)\n\n3.执行结果\n{&#39;id&#39;: 1, &#39;hostname&#39;: &#39;python01&#39;, &#39;ip&#39;: &#39;10.100.36.29&#39;}","like_count":0},{"had_liked":false,"id":367077,"user_name":"Cy23","can_delete":false,"product_type":"c3","uid":1591293,"ip_address":"辽宁","ucode":"8DC561C5151758","user_header":"https://static001.geekbang.org/account/avatar/00/18/47/fd/895f0c27.jpg","comment_is_top":false,"comment_ctime":1674895504,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100310001,"comment_content":"import pymysql\nimport socket\nip_address = socket.gethostbyname(socket.gethostname())\nprint(f&quot;IP_Address: {ip_address}&quot;)\n\nconn = pymysql.connect(\n  host=&#39;localhost&#39;,\n  user=&#39;root&#39;,\n  password=&#39;&#39;,\n  database=&#39;pydb&#39;,\n  cursorclass=pymysql.cursors.DictCursor)\n\nwith conn:\n  with conn.cursor() as cursor:\n    sql = &quot;insert into `user_ips` (`ip`) values (%s)&quot;\n    cursor.execute(sql, (ip_address))\n  conn.commit()\n\n  with conn.cursor() as cursor:\n    sql = &quot;select * from `user_ips`&quot;\n    cursor.execute(sql)\n    result = cursor.fetchall()\n    print(result)","like_count":0},{"had_liked":false,"id":366179,"user_name":"PatrickL","can_delete":false,"product_type":"c3","uid":1341431,"ip_address":"上海","ucode":"EF0EC18639B9B2","user_header":"https://static001.geekbang.org/account/avatar/00/14/77/f7/11548247.jpg","comment_is_top":false,"comment_ctime":1673442291,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100310001,"comment_content":"import socket\nimport pymysql\n\nIP = socket.gethostbyname(socket.gethostname())\nprint(IP)\n\nconn = pymysql.connect(host=&#39;127.0.0.1&#39;,\n                       port=3306,\n                       user=&#39;root&#39;,\n                       password=&#39;1234&#39;,\n                       database=&#39;zero_basics_python&#39;)\n\nwith conn:\n    # 插入数据\n    with conn.cursor() as cursor:\n        sql = &#39;INSERT INTO my_ip VALUES(%s);&#39;\n        try:\n            cursor.execute(sql,IP)\n            conn.commit()\n            print(&#39;Sucess&#39;)\n        except:\n            conn.rollback()\n            print(&#39;Fail&#39;)\n    # 读取数据\n    with conn.cursor() as cursor:\n        sql = &#39;SELECT IP FROM my_ip;&#39;\n        cursor.execute(sql)\n        rst = cursor.fetchall()\n        print(rst)\n    # 删除数据\n    with conn.cursor() as cursor:\n        sql = &#39;DELETE FROM my_ip WHERE IP = %s;&#39;\n        try:\n            cursor.execute(sql,IP)\n            conn.commit()\n            print(&#39;Sucess&#39;)\n        except:\n            conn.rollback()\n            print(&#39;Fail&#39;)","like_count":0}]}