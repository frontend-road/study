{"id":100068,"title":"32 | å­—ç¬¦è®¾å¤‡ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å»ºç«‹ç›´é”€æ¨¡å¼ï¼Ÿ","content":"<p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬è®²äº†è¾“å…¥è¾“å‡ºè®¾å¤‡çš„å±‚æ¬¡æ¨¡å‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå—è®¾å¤‡å°¤å…¶å¤æ‚ã€‚è¿™ä¸€èŠ‚ä¸ºäº†è®©ä½ æ›´æ¸…æ™°åœ°äº†è§£è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ¶æ„ï¼Œæˆ‘ä»¬å…ˆæ¥è®²ç¨å¾®ç®€å•ä¸€ç‚¹çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨ã€‚</p><p>è¿™ä¸€èŠ‚ï¼Œæˆ‘æ‰¾äº†ä¸¤ä¸ªæ¯”è¾ƒç®€å•çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è§£æä¸€ä¸‹ã€‚ä¸€ä¸ªæ˜¯è¾“å…¥å­—ç¬¦è®¾å¤‡ï¼Œé¼ æ ‡ã€‚ä»£ç åœ¨drivers/input/mouse/logibm.cè¿™é‡Œã€‚</p><pre><code>/*\n * Logitech Bus Mouse Driver for Linux\n */\nmodule_init(logibm_init);\nmodule_exit(logibm_exit);\n</code></pre><p>å¦å¤–ä¸€ä¸ªæ˜¯è¾“å‡ºå­—ç¬¦è®¾å¤‡ï¼Œæ‰“å°æœºï¼Œä»£ç drivers/char/lp.cè¿™é‡Œã€‚</p><pre><code>/*\n * Generic parallel printer driver\n */\nmodule_init(lp_init_module);\nmodule_exit(lp_cleanup_module);\n</code></pre><h2>å†…æ ¸æ¨¡å—</h2><p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬è®²è¿‡ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºæ˜¯ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œä»¥koçš„æ–‡ä»¶å½¢å¼å­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡insmodåŠ è½½åˆ°å†…æ ¸ä¸­ã€‚é‚£æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œæ€ä¹ˆæ ·æ‰èƒ½æ„å»ºä¸€ä¸ªå†…æ ¸æ¨¡å—å‘¢ï¼Ÿ</p><p>ä¸€ä¸ªå†…æ ¸æ¨¡å—åº”è¯¥ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆã€‚</p><p><strong>ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¤´æ–‡ä»¶éƒ¨åˆ†</strong>ã€‚ä¸€èˆ¬çš„å†…æ ¸æ¨¡å—ï¼Œéƒ½éœ€è¦includeä¸‹é¢ä¸¤ä¸ªå¤´æ–‡ä»¶ï¼š</p><pre><code>#include &lt;linux/module.h&gt;\n#include &lt;linux/init.h&gt;\n</code></pre><p>å¦‚æœä½ å»çœ‹ä¸Šé¢ä¸¤ä¸ªé©±åŠ¨ç¨‹åºï¼Œéƒ½èƒ½æ‰¾åˆ°è¿™ä¸¤ä¸ªå¤´æ–‡ä»¶ã€‚å½“ç„¶å¦‚æœéœ€è¦çš„è¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¼•å…¥æ›´å¤šçš„å¤´æ–‡ä»¶ã€‚</p><p><strong>ç¬¬äºŒéƒ¨åˆ†ï¼Œå®šä¹‰ä¸€äº›å‡½æ•°ï¼Œç”¨äºå¤„ç†å†…æ ¸æ¨¡å—çš„ä¸»è¦é€»è¾‘</strong>ã€‚ä¾‹å¦‚æ‰“å¼€ã€å…³é—­ã€è¯»å–ã€å†™å…¥è®¾å¤‡çš„å‡½æ•°æˆ–è€…å“åº”ä¸­æ–­çš„å‡½æ•°ã€‚</p><p>ä¾‹å¦‚ï¼Œlogibm.cé‡Œé¢å°±å®šä¹‰äº†logibm_openã€‚logibm_closeå°±æ˜¯å¤„ç†æ‰“å¼€å’Œå…³é—­çš„ï¼Œå®šä¹‰äº†logibm_interruptå°±æ˜¯ç”¨æ¥å“åº”ä¸­æ–­çš„ã€‚å†å¦‚ï¼Œlp.cé‡Œé¢å°±å®šä¹‰äº†lp_readï¼Œlp_writeå°±æ˜¯å¤„ç†è¯»å†™çš„ã€‚</p><!-- [[[read_end]]] --><p><strong>ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå®šä¹‰ä¸€ä¸ªfile_operationsç»“æ„</strong>ã€‚å‰é¢æˆ‘ä»¬è®²è¿‡ï¼Œè®¾å¤‡æ˜¯å¯ä»¥é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£è¿›è¡Œè®¿é—®çš„ã€‚å’±ä»¬è®²æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™è¯´è¿‡ï¼Œå¯¹äºæŸç§æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œï¼Œéƒ½æ˜¯æ”¾åœ¨file_operationsé‡Œé¢çš„ã€‚ä¾‹å¦‚ext4å°±å®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ªç»“æ„ï¼Œé‡Œé¢éƒ½æ˜¯ext4_xxxä¹‹ç±»çš„å‡½æ•°ã€‚è®¾å¤‡è¦æƒ³è¢«æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£æ“ä½œï¼Œä¹Ÿéœ€è¦å®šä¹‰è¿™æ ·ä¸€ä¸ªç»“æ„ã€‚</p><p>ä¾‹å¦‚ï¼Œlp.cé‡Œé¢å°±å®šä¹‰äº†è¿™æ ·ä¸€ä¸ªç»“æ„ã€‚</p><pre><code>static const struct file_operations lp_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.write\t\t= lp_write,\n\t.unlocked_ioctl\t= lp_ioctl,\n#ifdef CONFIG_COMPAT\n\t.compat_ioctl\t= lp_compat_ioctl,\n#endif\n\t.open\t\t= lp_open,\n\t.release\t= lp_release,\n#ifdef CONFIG_PARPORT_1284\n\t.read\t\t= lp_read,\n#endif\n\t.llseek\t\t= noop_llseek,\n};\n</code></pre><p>åœ¨logibm.cé‡Œé¢ï¼Œæˆ‘ä»¬æ‰¾ä¸åˆ°è¿™æ ·çš„ç»“æ„ï¼Œæ˜¯å› ä¸ºå®ƒå±äºä¼—å¤šè¾“å…¥è®¾å¤‡çš„ä¸€ç§ï¼Œè€Œè¾“å…¥è®¾å¤‡çš„æ“ä½œè¢«ç»Ÿä¸€å®šä¹‰åœ¨drivers/input/input.cé‡Œé¢ï¼Œlogibm.cåªæ˜¯å®šä¹‰äº†ä¸€äº›è‡ªå·±ç‹¬æœ‰çš„æ“ä½œã€‚</p><pre><code>static const struct file_operations input_devices_fileops = {\n\t.owner\t\t= THIS_MODULE,\n\t.open\t\t= input_proc_devices_open,\n\t.poll\t\t= input_proc_devices_poll,\n\t.read\t\t= seq_read,\n\t.llseek\t\t= seq_lseek,\n\t.release\t= seq_release,\n};\n</code></pre><p><strong>ç¬¬å››éƒ¨åˆ†ï¼Œå®šä¹‰æ•´ä¸ªæ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°å’Œé€€å‡ºå‡½æ•°</strong>ï¼Œç”¨äºåŠ è½½å’Œå¸è½½è¿™ä¸ªkoçš„æ—¶å€™è°ƒç”¨ã€‚</p><p>ä¾‹å¦‚lp.cå°±å®šä¹‰äº†lp_init_moduleå’Œlp_cleanup_moduleï¼Œlogibm.cå°±å®šä¹‰äº†logibm_initå’Œlogibm_exitã€‚</p><p><strong>ç¬¬äº”éƒ¨åˆ†ï¼Œè°ƒç”¨module_initå’Œmodule_exit</strong>ï¼Œåˆ†åˆ«æŒ‡å‘ä¸Šé¢ä¸¤ä¸ªåˆå§‹åŒ–å‡½æ•°å’Œé€€å‡ºå‡½æ•°ã€‚å°±åƒæœ¬èŠ‚æœ€å¼€å¤´å±•ç¤ºçš„ä¸€æ ·ã€‚</p><p><strong>ç¬¬å…­éƒ¨åˆ†ï¼Œå£°æ˜ä¸€ä¸‹lisenseï¼Œè°ƒç”¨MODULE_LICENSE</strong>ã€‚</p><p>æœ‰äº†è¿™å…­éƒ¨åˆ†ï¼Œä¸€ä¸ªå†…æ ¸æ¨¡å—å°±åŸºæœ¬åˆæ ¼äº†ï¼Œå¯ä»¥å·¥ä½œäº†ã€‚</p><h2>æ‰“å¼€å­—ç¬¦è®¾å¤‡</h2><p>å­—ç¬¦è®¾å¤‡å¯ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„å†…æ ¸æ¨¡å—ï¼Œå®ƒæœ‰è‡ªå·±ç‹¬ç‰¹çš„è¡Œä¸ºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ²¿ç€æ‰“å¼€ä¸€ä¸ªå­—ç¬¦è®¾å¤‡çš„è¿‡ç¨‹ï¼Œçœ‹çœ‹å­—ç¬¦è®¾å¤‡è¿™ä¸ªå†…æ ¸æ¨¡å—åšäº†å“ªäº›ç‰¹æ®Šçš„äº‹æƒ…ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/2e/e6/2e29767e84b299324ea7fc524a3dcee6.jpeg?wh=3037*3400\" alt=\"\"></p><p>è¦ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æŠŠå†™å¥½çš„å†…æ ¸æ¨¡å—ï¼Œé€šè¿‡insmodåŠ è½½è¿›å†…æ ¸ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå…ˆè°ƒç”¨çš„å°±æ˜¯module_initè°ƒç”¨çš„åˆå§‹åŒ–å‡½æ•°ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨lp.cçš„åˆå§‹åŒ–å‡½æ•°lp_initå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>static int __init lp_init (void)\n{\n......\n\tif (register_chrdev (LP_MAJOR, &quot;lp&quot;, &amp;lp_fops)) {\n\t\tprintk (KERN_ERR &quot;lp: unable to get major %d\\n&quot;, LP_MAJOR);\n\t\treturn -EIO;\n\t}\n......\n}\n\n\nint __register_chrdev(unsigned int major, unsigned int baseminor,\n\t\t      unsigned int count, const char *name,\n\t\t      const struct file_operations *fops)\n{\n\tstruct char_device_struct *cd;\n\tstruct cdev *cdev;\n\tint err = -ENOMEM;\n......\n\tcd = __register_chrdev_region(major, baseminor, count, name);\n\tcdev = cdev_alloc();\n\tcdev-&gt;owner = fops-&gt;owner;\n\tcdev-&gt;ops = fops;\n\tkobject_set_name(&amp;cdev-&gt;kobj, &quot;%s&quot;, name);\n\terr = cdev_add(cdev, MKDEV(cd-&gt;major, baseminor), count);\n\tcd-&gt;cdev = cdev;\n\treturn major ? 0 : cd-&gt;major;\n}\n</code></pre><p>åœ¨å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å†…æ ¸æ¨¡å—åŠ è½½çš„æ—¶å€™ï¼Œæœ€é‡è¦çš„ä¸€ä»¶äº‹æƒ…å°±æ˜¯ï¼Œæ³¨å†Œè¿™ä¸ªå­—ç¬¦è®¾å¤‡ã€‚æ³¨å†Œçš„æ–¹å¼æ˜¯è°ƒç”¨__register_chrdev_regionï¼Œæ³¨å†Œå­—ç¬¦è®¾å¤‡çš„ä¸»æ¬¡è®¾å¤‡å·å’Œåç§°ï¼Œç„¶ååˆ†é…ä¸€ä¸ªstruct cdevç»“æ„ï¼Œå°†cdevçš„opsæˆå‘˜å˜é‡æŒ‡å‘è¿™ä¸ªæ¨¡å—å£°æ˜çš„file_operationsã€‚ç„¶åï¼Œcdev_addä¼šå°†è¿™ä¸ªå­—ç¬¦è®¾å¤‡æ·»åŠ åˆ°å†…æ ¸ä¸­ä¸€ä¸ªå«ä½œstruct kobj_map *cdev_mapçš„ç»“æ„ï¼Œæ¥ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å­—ç¬¦è®¾å¤‡ã€‚</p><p>å…¶ä¸­ï¼ŒMKDEV(cd-&gt;major, baseminor)è¡¨ç¤ºå°†ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ç”Ÿæˆä¸€ä¸ªdev_tçš„æ•´æ•°ï¼Œç„¶åå°†è¿™ä¸ªæ•´æ•°dev_tå’Œcdevå…³è”èµ·æ¥ã€‚</p><pre><code>/**\n * cdev_add() - add a char device to the system\n * @p: the cdev structure for the device\n * @dev: the first device number for which this device is responsible\n * @count: the number of consecutive minor numbers corresponding to this\n *         device\n *\n * cdev_add() adds the device represented by @p to the system, making it\n * live immediately.  A negative error code is returned on failure.\n */\nint cdev_add(struct cdev *p, dev_t dev, unsigned count)\n{\n\tint error;\n\n\n\tp-&gt;dev = dev;\n\tp-&gt;count = count;\n\n\n\terror = kobj_map(cdev_map, dev, count, NULL,\n\t\t\t exact_match, exact_lock, p);\n\tkobject_get(p-&gt;kobj.parent);\n\n\n\treturn 0;\n</code></pre><p>åœ¨logibm.cä¸­ï¼Œæˆ‘ä»¬åœ¨logibm_initæ‰¾ä¸åˆ°æ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼Œè¿™æ˜¯å› ä¸ºinput.cé‡Œé¢çš„åˆå§‹åŒ–å‡½æ•°input_initä¼šè°ƒç”¨register_chrdev_regionï¼Œæ³¨å†Œè¾“å…¥çš„å­—ç¬¦è®¾å¤‡ï¼Œä¼šåœ¨logibm_initä¸­è°ƒç”¨input_register_deviceï¼Œå°†logibm.cè¿™ä¸ªå­—ç¬¦è®¾å¤‡æ³¨å†Œåˆ°input.cé‡Œé¢å»ï¼Œè¿™å°±ç›¸å½“äºinput.cå¯¹å¤šä¸ªè¾“å…¥å­—ç¬¦è®¾å¤‡è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†ã€‚</p><p>å†…æ ¸æ¨¡å—åŠ è½½å®Œæ¯•åï¼Œæ¥ä¸‹æ¥è¦é€šè¿‡mknodåœ¨/devä¸‹é¢åˆ›å»ºä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œåªæœ‰æœ‰äº†è¿™ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œæˆ‘ä»¬æ‰èƒ½é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£ï¼Œå¯¹è¿™ä¸ªè®¾å¤‡æ–‡ä»¶è¿›è¡Œæ“ä½œã€‚</p><p>mknodä¹Ÿæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>SYSCALL_DEFINE3(mknod, const char __user *, filename, umode_t, mode, unsigned, dev)\n{\n\treturn sys_mknodat(AT_FDCWD, filename, mode, dev);\n}\n\n\nSYSCALL_DEFINE4(mknodat, int, dfd, const char __user *, filename, umode_t, mode,\n\t\tunsigned, dev)\n{\n\tstruct dentry *dentry;\n\tstruct path path;\n......\n\tdentry = user_path_create(dfd, filename, &amp;path, lookup_flags);\n......\n\tswitch (mode &amp; S_IFMT) {\n......\n\t\tcase S_IFCHR: case S_IFBLK:\n\t\t\terror = vfs_mknod(path.dentry-&gt;d_inode,dentry,mode,\n\t\t\t\t\tnew_decode_dev(dev));\n\t\t\tbreak;\n......\n\t}\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨é‡Œçœ‹åˆ°ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œé¡ºç€è·¯å¾„æ‰¾åˆ°/dev/xxxæ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œç„¶åä¸ºè¿™ä¸ªæ–°åˆ›å»ºçš„è®¾å¤‡æ–‡ä»¶åˆ›å»ºä¸€ä¸ªdentryã€‚è¿™æ˜¯ç»´æŠ¤æ–‡ä»¶å’Œinodeä¹‹é—´çš„å…³è”å…³ç³»çš„ç»“æ„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå¦‚æœæ˜¯å­—ç¬¦æ–‡ä»¶S_IFCHRæˆ–è€…è®¾å¤‡æ–‡ä»¶S_IFBLKï¼Œæˆ‘ä»¬å°±è°ƒç”¨vfs_mknodã€‚</p><pre><code>int vfs_mknod(struct inode *dir, struct dentry *dentry, umode_t mode, dev_t dev)\n{\n......\n\terror = dir-&gt;i_op-&gt;mknod(dir, dentry, mode, dev);\n......\n}\n</code></pre><p>è¿™é‡Œéœ€è¦è°ƒç”¨å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿçš„inode_operationsã€‚åº”è¯¥è°ƒç”¨å“ªä¸ªæ–‡ä»¶ç³»ç»Ÿå‘¢ï¼Ÿ</p><p>å¦‚æœæˆ‘ä»¬åœ¨linuxä¸‹é¢æ‰§è¡Œmountå‘½ä»¤ï¼Œèƒ½çœ‹åˆ°ä¸‹é¢è¿™ä¸€è¡Œï¼š</p><pre><code>devtmpfs on /dev type devtmpfs (rw,nosuid,size=3989584k,nr_inodes=997396,mode=755)\n</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ/devä¸‹é¢çš„æ–‡ä»¶ç³»ç»Ÿçš„åç§°ä¸ºdevtmpfsï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸ä¸­æ‰¾åˆ°å®ƒã€‚</p><pre><code>static struct dentry *dev_mount(struct file_system_type *fs_type, int flags,\n\t\t      const char *dev_name, void *data)\n{\n#ifdef CONFIG_TMPFS\n\treturn mount_single(fs_type, flags, data, shmem_fill_super);\n#else\n\treturn mount_single(fs_type, flags, data, ramfs_fill_super);\n#endif\n}\n\n\nstatic struct file_system_type dev_fs_type = {\n\t.name = &quot;devtmpfs&quot;,\n\t.mount = dev_mount,\n\t.kill_sb = kill_litter_super,\n};\n</code></pre><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œdevtmpfsåœ¨æŒ‚è½½çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯ramfsï¼Œä¸€ç§æ˜¯shmeméƒ½æ˜¯åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™é‡Œä½ å…ˆä¸ç”¨ç®¡ï¼ŒåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿå…·ä½“æ˜¯æ€ä¹ˆå›äº‹å„¿ã€‚</p><pre><code>static const struct inode_operations ramfs_dir_inode_operations = {\n......\n\t.mknod\t\t= ramfs_mknod,\n};\n\n\nstatic const struct inode_operations shmem_dir_inode_operations = {\n#ifdef CONFIG_TMPFS\n......\n\t.mknod\t\t= shmem_mknod,\n};\n</code></pre><p>è¿™ä¸¤ä¸ªmknodè™½ç„¶å®ç°ä¸åŒï¼Œä½†æ˜¯éƒ½ä¼šè°ƒç”¨åˆ°åŒä¸€ä¸ªå‡½æ•°init_special_inodeã€‚</p><pre><code>void init_special_inode(struct inode *inode, umode_t mode, dev_t rdev)\n{\n\tinode-&gt;i_mode = mode;\n\tif (S_ISCHR(mode)) {\n\t\tinode-&gt;i_fop = &amp;def_chr_fops;\n\t\tinode-&gt;i_rdev = rdev;\n\t} else if (S_ISBLK(mode)) {\n\t\tinode-&gt;i_fop = &amp;def_blk_fops;\n\t\tinode-&gt;i_rdev = rdev;\n\t} else if (S_ISFIFO(mode))\n\t\tinode-&gt;i_fop = &amp;pipefifo_fops;\n\telse if (S_ISSOCK(mode))\n\t\t;\t/* leave it no_open_fops */\n}\n</code></pre><p>æ˜¾ç„¶è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸ªç‰¹æ®Šæ–‡ä»¶ï¼Œinodeä¹Ÿæ˜¯ç‰¹æ®Šçš„ã€‚è¿™é‡Œè¿™ä¸ªinodeå¯ä»¥å…³è”å­—ç¬¦è®¾å¤‡ã€å—è®¾å¤‡ã€FIFOæ–‡ä»¶ã€Socketç­‰ã€‚æˆ‘ä»¬è¿™é‡Œåªçœ‹å­—ç¬¦è®¾å¤‡ã€‚</p><p>è¿™é‡Œçš„inodeçš„file_operationsæŒ‡å‘ä¸€ä¸ªdef_chr_fopsï¼Œè¿™é‡Œé¢åªæœ‰ä¸€ä¸ªopenï¼Œå°±ç­‰ç€ä½ æ‰“å¼€å®ƒã€‚</p><p>å¦å¤–ï¼Œinodeçš„i_rdevæŒ‡å‘è¿™ä¸ªè®¾å¤‡çš„dev_tã€‚è¿˜è®°å¾—cdev_mapå—ï¼Ÿé€šè¿‡è¿™ä¸ªdev_tï¼Œå¯ä»¥æ‰¾åˆ°æˆ‘ä»¬åˆšåœ¨åŠ è½½çš„å­—ç¬¦è®¾å¤‡cdevã€‚</p><pre><code>const struct file_operations def_chr_fops = {\n\t.open = chrdev_open,\n};\n</code></pre><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†/devä¸‹é¢çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å’Œç›¸åº”çš„è®¾å¤‡å·å…³è”èµ·æ¥ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ‰“å¼€è¿™ä¸ª/devä¸‹é¢çš„è®¾å¤‡æ–‡ä»¶ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥æ‰“å¼€å®ƒã€‚æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶çš„æµç¨‹ï¼Œæˆ‘ä»¬åœ¨<a href=\"https://time.geekbang.org/column/article/97876\">æ–‡ä»¶ç³»ç»Ÿ</a>é‚£ä¸€èŠ‚è®²è¿‡äº†ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚æœ€ç»ˆå°±åƒæ‰“å¼€å­—ç¬¦è®¾å¤‡çš„å›¾ä¸­ä¸€æ ·ï¼Œæ‰“å¼€æ–‡ä»¶çš„è¿›ç¨‹çš„task_structé‡Œï¼Œæœ‰ä¸€ä¸ªæ•°ç»„ä»£è¡¨å®ƒæ‰“å¼€çš„æ–‡ä»¶ï¼Œä¸‹æ ‡å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦fdï¼Œæ¯ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªstruct fileç»“æ„ï¼Œä¼šæŒ‡å‘ä¸€ä¸ªdentryé¡¹ã€‚dentryå¯ä»¥ç”¨æ¥å…³è”inodeã€‚è¿™ä¸ªdentryå°±æ˜¯å’±ä»¬ä¸Šé¢mknodçš„æ—¶å€™åˆ›å»ºçš„ã€‚</p><p>åœ¨è¿›ç¨‹é‡Œé¢è°ƒç”¨openå‡½æ•°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªç‰¹æ®Šçš„inodeçš„openå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯chrdev_openã€‚</p><pre><code>static int chrdev_open(struct inode *inode, struct file *filp)\n{\n\tconst struct file_operations *fops;\n\tstruct cdev *p;\n\tstruct cdev *new = NULL;\n\tint ret = 0;\n\n\n\tp = inode-&gt;i_cdev;\n\tif (!p) {\n\t\tstruct kobject *kobj;\n\t\tint idx;\n\t\tkobj = kobj_lookup(cdev_map, inode-&gt;i_rdev, &amp;idx);\n\t\tnew = container_of(kobj, struct cdev, kobj);\n\t\tp = inode-&gt;i_cdev;\n\t\tif (!p) {\n\t\t\tinode-&gt;i_cdev = p = new;\n\t\t\tlist_add(&amp;inode-&gt;i_devices, &amp;p-&gt;list);\n\t\t\tnew = NULL;\n\t\t} \n\t} \n......\n\tfops = fops_get(p-&gt;ops);\n......\n\treplace_fops(filp, fops);\n\tif (filp-&gt;f_op-&gt;open) {\n\t\tret = filp-&gt;f_op-&gt;open(inode, filp);\n......\n\t}\n......\n}\n</code></pre><p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹è¿™ä¸ªinodeçš„i_cdevï¼Œæ˜¯å¦å·²ç»å…³è”åˆ°cdevã€‚å¦‚æœç¬¬ä¸€æ¬¡æ‰“å¼€ï¼Œå½“ç„¶æ²¡æœ‰ã€‚æ²¡æœ‰æ²¡å…³ç³»ï¼Œinodeé‡Œé¢æœ‰i_rdevå‘€ï¼Œä¹Ÿå°±æ˜¯æœ‰dev_tã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒåœ¨cdev_mapä¸­æ‰¾cdevã€‚å’±ä»¬ä¸Šé¢æ³¨å†Œè¿‡äº†ï¼Œæ‰€ä»¥è‚¯å®šèƒ½å¤Ÿæ‰¾åˆ°ã€‚æ‰¾åˆ°åæˆ‘ä»¬å°±å°†inodeçš„i_cdevï¼Œå…³è”åˆ°æ‰¾åˆ°çš„cdev newã€‚</p><p>æ‰¾åˆ°cdevå°±å¥½åŠäº†ã€‚cdevé‡Œé¢æœ‰file_operationsï¼Œè¿™æ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºè‡ªå·±å®šä¹‰çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥æ“ä½œè®¾å¤‡é©±åŠ¨ç¨‹åºï¼ŒæŠŠå®ƒä»˜ç»™struct fileé‡Œé¢çš„file_operationsã€‚è¿™æ ·ä»¥åæ“ä½œæ–‡ä»¶æè¿°ç¬¦ï¼Œå°±æ˜¯ç›´æ¥æ“ä½œè®¾å¤‡äº†ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºçš„file_operationsçš„openå‡½æ•°ï¼ŒçœŸæ­£æ‰“å¼€è®¾å¤‡ã€‚å¯¹äºæ‰“å°æœºï¼Œè°ƒç”¨çš„æ˜¯lp_openã€‚å¯¹äºé¼ æ ‡è°ƒç”¨çš„æ˜¯input_proc_devices_openï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°logibm_openã€‚è¿™äº›å¤šå’Œè®¾å¤‡ç›¸å…³ï¼Œä½ ä¸å¿…çœ‹æ‡‚å®ƒä»¬ã€‚</p><h2>å†™å…¥å­—ç¬¦è®¾å¤‡</h2><p>å½“æˆ‘ä»¬åƒæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ä¸€æ ·æ‰“å¼€ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹è¿™ä¸ªè®¾å¤‡çš„è¯»å†™ã€‚å¯¹äºæ–‡ä»¶çš„è¯»å†™å’±ä»¬åœ¨æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€ç« è¯¦ç»†è®²è¿°è¿‡ï¼Œè¯»å†™çš„è¿‡ç¨‹æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªè§£ææ‰“å°æœºé©±åŠ¨å†™å…¥çš„è¿‡ç¨‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/9b/e2/9bd3cd8a8705dbf69f889ba3b2b5c2e2.jpeg?wh=3037*3400\" alt=\"\"></p><p>å†™å…¥ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼Œå°±æ˜¯ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ ‡å‡†æ¥å£writeï¼Œå‚æ•°æ–‡ä»¶æè¿°ç¬¦fdï¼Œåœ¨å†…æ ¸é‡Œé¢è°ƒç”¨çš„sys_writeï¼Œåœ¨sys_writeé‡Œé¢æ ¹æ®æ–‡ä»¶æè¿°ç¬¦fdå¾—åˆ°struct fileç»“æ„ã€‚æ¥ä¸‹æ¥å†è°ƒç”¨vfs_writeã€‚</p><pre><code>ssize_t __vfs_write(struct file *file, const char __user *p, size_t count, loff_t *pos)\n{\n\tif (file-&gt;f_op-&gt;write)\n\t\treturn file-&gt;f_op-&gt;write(file, p, count, pos);\n\telse if (file-&gt;f_op-&gt;write_iter)\n\t\treturn new_sync_write(file, p, count, pos);\n\telse\n\t\treturn -EINVAL;\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨__vfs_writeé‡Œé¢ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨struct fileç»“æ„é‡Œçš„file_operationsçš„writeå‡½æ•°ã€‚ä¸Šé¢æˆ‘ä»¬æ‰“å¼€å­—ç¬¦è®¾å¤‡çš„æ—¶å€™ï¼Œå·²ç»å°†struct fileç»“æ„é‡Œé¢çš„file_operationsæŒ‡å‘äº†è®¾å¤‡é©±åŠ¨ç¨‹åºçš„file_operationsç»“æ„ï¼Œæ‰€ä»¥è¿™é‡Œçš„writeå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨åˆ°lp_writeã€‚</p><pre><code>static ssize_t lp_write(struct file * file, const char __user * buf,\n\t\t        size_t count, loff_t *ppos)\n{\n\tunsigned int minor = iminor(file_inode(file));\n\tstruct parport *port = lp_table[minor].dev-&gt;port;\n\tchar *kbuf = lp_table[minor].lp_buffer;\n\tssize_t retv = 0;\n\tssize_t written;\n\tsize_t copy_size = count;\n......\n\t/* Need to copy the data from user-space. */\n\tif (copy_size &gt; LP_BUFFER_SIZE)\n\t\tcopy_size = LP_BUFFER_SIZE;\n......\n\tif (copy_from_user (kbuf, buf, copy_size)) {\n\t\tretv = -EFAULT;\n\t\tgoto out_unlock;\n\t}\n......\n\tdo {\n\t\t/* Write the data. */\n\t\twritten = parport_write (port, kbuf, copy_size);\n\t\tif (written &gt; 0) {\n\t\t\tcopy_size -= written;\n\t\t\tcount -= written;\n\t\t\tbuf  += written;\n\t\t\tretv += written;\n\t\t}\n......\n        if (need_resched())\n\t\t\tschedule ();\n\n\n\t\tif (count) {\n\t\t\tcopy_size = count;\n\t\t\tif (copy_size &gt; LP_BUFFER_SIZE)\n\t\t\t\tcopy_size = LP_BUFFER_SIZE;\n\n\n\t\t\tif (copy_from_user(kbuf, buf, copy_size)) {\n\t\t\t\tif (retv == 0)\n\t\t\t\t\tretv = -EFAULT;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\t\n\t} while (count &gt; 0);\n......\n</code></pre><p>è¿™ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºçš„å†™å…¥å‡½æ•°çš„å®ç°è¿˜æ˜¯æ¯”è¾ƒå…¸å‹çš„ã€‚å…ˆæ˜¯è°ƒç”¨copy_from_userå°†æ•°æ®ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€çš„ç¼“å­˜ä¸­ï¼Œç„¶åè°ƒç”¨parport_writeå†™å…¥å¤–éƒ¨è®¾å¤‡ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªscheduleå‡½æ•°ï¼Œä¹Ÿå³å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œç»™å…¶ä»–çº¿ç¨‹æŠ¢å CPUçš„æœºä¼šã€‚ç„¶åï¼Œå¦‚æœcountè¿˜æ˜¯å¤§äº0ï¼Œä¹Ÿå°±æ˜¯æ•°æ®è¿˜æ²¡æœ‰å†™å®Œï¼Œé‚£æˆ‘ä»¬å°±æ¥ç€copy_from_userï¼Œæ¥ç€parport_writeï¼Œç›´åˆ°å†™å®Œä¸ºæ­¢ã€‚</p><h2>ä½¿ç”¨IOCTLæ§åˆ¶è®¾å¤‡</h2><p>å¯¹äºI/Oè®¾å¤‡æ¥è®²ï¼Œæˆ‘ä»¬å‰é¢ä¹Ÿè¯´è¿‡ï¼Œé™¤äº†è¯»å†™è®¾å¤‡ï¼Œè¿˜ä¼šè°ƒç”¨ioctlï¼Œåšä¸€äº›ç‰¹æ®Šçš„I/Oæ“ä½œã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/c3/1d/c3498dad4f15712529354e0fa123c31d.jpeg?wh=1666*703\" alt=\"\"></p><p>ioctlä¹Ÿæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒåœ¨å†…æ ¸é‡Œé¢çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>SYSCALL_DEFINE3(ioctl, unsigned int, fd, unsigned int, cmd, unsigned long, arg)\n{\n\tint error;\n\tstruct fd f = fdget(fd);\n......\n\terror = do_vfs_ioctl(f.file, fd, cmd, arg);\n\tfdput(f);\n\treturn error;\n}\n</code></pre><p>å…¶ä¸­ï¼Œfdæ˜¯è¿™ä¸ªè®¾å¤‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œcmdæ˜¯ä¼ ç»™è¿™ä¸ªè®¾å¤‡çš„å‘½ä»¤ï¼Œargæ˜¯å‘½ä»¤çš„å‚æ•°ã€‚å…¶ä¸­ï¼Œå¯¹äºå‘½ä»¤å’Œå‘½ä»¤çš„å‚æ•°ï¼Œä½¿ç”¨ioctlç³»ç»Ÿè°ƒç”¨çš„ç”¨æˆ·å’Œé©±åŠ¨ç¨‹åºçš„å¼€å‘äººå‘˜çº¦å®šå¥½è¡Œä¸ºå³å¯ã€‚</p><p>å…¶å®cmdçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªintï¼Œå…¶å®ä»–çš„ç»„æˆæ¯”è¾ƒå¤æ‚ï¼Œå®ƒç”±å‡ éƒ¨åˆ†ç»„æˆï¼š</p><ul>\n<li>æœ€ä½å…«ä½ä¸ºNRï¼Œæ˜¯å‘½ä»¤å·ï¼›</li>\n<li>ç„¶åå…«ä½æ˜¯TYPEï¼Œæ˜¯ç±»å‹ï¼›</li>\n<li>ç„¶ååå››ä½æ˜¯å‚æ•°çš„å¤§å°ï¼›</li>\n<li>æœ€é«˜ä¸¤ä½æ˜¯DIRï¼Œæ˜¯æ–¹å‘ï¼Œè¡¨ç¤ºå†™å…¥ã€è¯»å‡ºï¼Œè¿˜æ˜¯è¯»å†™ã€‚</li>\n</ul><p>ç”±äºç»„æˆæ¯”è¾ƒå¤æ‚ï¼Œæœ‰ä¸€äº›å®æ˜¯ä¸“é—¨ç”¨äºç»„æˆè¿™ä¸ªcmdå€¼çš„ã€‚</p><pre><code>/*\n * Used to create numbers.\n */\n#define _IO(type,nr)\t\t_IOC(_IOC_NONE,(type),(nr),0)\n#define _IOR(type,nr,size)\t_IOC(_IOC_READ,(type),(nr),(_IOC_TYPECHECK(size)))\n#define _IOW(type,nr,size)\t_IOC(_IOC_WRITE,(type),(nr),(_IOC_TYPECHECK(size)))\n#define _IOWR(type,nr,size)\t_IOC(_IOC_READ|_IOC_WRITE,(type),(nr),(_IOC_TYPECHECK(size)))\n\n\n/* used to decode ioctl numbers.. */\n#define _IOC_DIR(nr)\t\t(((nr) &gt;&gt; _IOC_DIRSHIFT) &amp; _IOC_DIRMASK)\n#define _IOC_TYPE(nr)\t\t(((nr) &gt;&gt; _IOC_TYPESHIFT) &amp; _IOC_TYPEMASK)\n#define _IOC_NR(nr)\t\t(((nr) &gt;&gt; _IOC_NRSHIFT) &amp; _IOC_NRMASK)\n#define _IOC_SIZE(nr)\t\t(((nr) &gt;&gt; _IOC_SIZESHIFT) &amp; _IOC_SIZEMASK)\n</code></pre><p>åœ¨ç”¨æˆ·ç¨‹åºä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸Šé¢çš„â€œUsed to create numbersâ€è¿™äº›å®ï¼Œæ ¹æ®å‚æ•°ç”Ÿæˆcmdï¼Œåœ¨é©±åŠ¨ç¨‹åºä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„â€œused to decode ioctl numbersâ€è¿™äº›å®ï¼Œè§£æcmdåï¼Œæ‰§è¡ŒæŒ‡ä»¤ã€‚</p><p>ioctlä¸­ä¼šè°ƒç”¨do_vfs_ioctlï¼Œè¿™é‡Œé¢å¯¹äºå·²ç»å®šä¹‰å¥½çš„cmdï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚å¦‚æœä¸æ˜¯é»˜è®¤å®šä¹‰å¥½çš„cmdï¼Œåˆ™æ‰§è¡Œé»˜è®¤æ“ä½œã€‚å¯¹äºæ™®é€šæ–‡ä»¶ï¼Œè°ƒç”¨file_ioctlï¼›å¯¹äºå…¶ä»–æ–‡ä»¶è°ƒç”¨vfs_ioctlã€‚</p><pre><code>int do_vfs_ioctl(struct file *filp, unsigned int fd, unsigned int cmd,\n\t     unsigned long arg)\n{\n\tint error = 0;\n\tint __user *argp = (int __user *)arg;\n\tstruct inode *inode = file_inode(filp);\n\n\n\tswitch (cmd) {\n......\n\tcase FIONBIO:\n\t\terror = ioctl_fionbio(filp, argp);\n\t\tbreak;\n\n\n\tcase FIOASYNC:\n\t\terror = ioctl_fioasync(fd, filp, argp);\n\t\tbreak;\n......\n\tcase FICLONE:\n\t\treturn ioctl_file_clone(filp, arg, 0, 0, 0);\n\n\n\tdefault:\n\t\tif (S_ISREG(inode-&gt;i_mode))\n\t\t\terror = file_ioctl(filp, cmd, arg);\n\t\telse\n\t\t\terror = vfs_ioctl(filp, cmd, arg);\n\t\tbreak;\n\t}\n\treturn error;\n</code></pre><p>ç”±äºå’±ä»¬è¿™é‡Œæ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œæ‰€ä»¥è°ƒç”¨çš„æ˜¯vfs_ioctlã€‚</p><pre><code>/**\n * vfs_ioctl - call filesystem specific ioctl methods\n * @filp:\topen file to invoke ioctl method on\n * @cmd:\tioctl command to execute\n * @arg:\tcommand-specific argument for ioctl\n *\n * Invokes filesystem specific -&gt;unlocked_ioctl, if one exists; otherwise\n * returns -ENOTTY.\n *\n * Returns 0 on success, -errno on error.\n */\nlong vfs_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n\tint error = -ENOTTY;\n\n\n\tif (!filp-&gt;f_op-&gt;unlocked_ioctl)\n\t\tgoto out;\n\n\n\terror = filp-&gt;f_op-&gt;unlocked_ioctl(filp, cmd, arg);\n\tif (error == -ENOIOCTLCMD)\n\t\terror = -ENOTTY;\n out:\n\treturn error;\n</code></pre><p>è¿™é‡Œé¢è°ƒç”¨çš„æ˜¯struct fileé‡Œfile_operationsçš„unlocked_ioctlå‡½æ•°ã€‚æˆ‘ä»¬å‰é¢åˆå§‹åŒ–è®¾å¤‡é©±åŠ¨çš„æ—¶å€™ï¼Œå·²ç»å°†file_operationsæŒ‡å‘è®¾å¤‡é©±åŠ¨çš„file_operationsäº†ã€‚è¿™é‡Œè°ƒç”¨çš„æ˜¯è®¾å¤‡é©±åŠ¨çš„unlocked_ioctlã€‚å¯¹äºæ‰“å°æœºç¨‹åºæ¥è®²ï¼Œè°ƒç”¨çš„æ˜¯lp_ioctlã€‚å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™é‡Œé¢å°±æ˜¯switchè¯­å¥ï¼Œå®ƒä¼šæ ¹æ®ä¸åŒçš„cmdï¼Œåšä¸åŒçš„æ“ä½œã€‚</p><pre><code>static long lp_ioctl(struct file *file, unsigned int cmd,\n\t\t\tunsigned long arg)\n{\n\tunsigned int minor;\n\tstruct timeval par_timeout;\n\tint ret;\n\n\n\tminor = iminor(file_inode(file));\n\tmutex_lock(&amp;lp_mutex);\n\tswitch (cmd) {\n......\n\tdefault:\n\t\tret = lp_do_ioctl(minor, cmd, arg, (void __user *)arg);\n\t\tbreak;\n\t}\n\tmutex_unlock(&amp;lp_mutex);\n\treturn ret;\n}\n\n\nstatic int lp_do_ioctl(unsigned int minor, unsigned int cmd,\n\tunsigned long arg, void __user *argp)\n{\n\tint status;\n\tint retval = 0;\n\n\n\tswitch ( cmd ) {\n\t\tcase LPTIME:\n\t\t\tif (arg &gt; UINT_MAX / HZ)\n\t\t\t\treturn -EINVAL;\n\t\t\tLP_TIME(minor) = arg * HZ/100;\n\t\t\tbreak;\n\t\tcase LPCHAR:\n\t\t\tLP_CHAR(minor) = arg;\n\t\t\tbreak;\n\t\tcase LPABORT:\n\t\t\tif (arg)\n\t\t\t\tLP_F(minor) |= LP_ABORT;\n\t\t\telse\n\t\t\t\tLP_F(minor) &amp;= ~LP_ABORT;\n\t\t\tbreak;\n\t\tcase LPABORTOPEN:\n\t\t\tif (arg)\n\t\t\t\tLP_F(minor) |= LP_ABORTOPEN;\n\t\t\telse\n\t\t\t\tLP_F(minor) &amp;= ~LP_ABORTOPEN;\n\t\t\tbreak;\n\t\tcase LPCAREFUL:\n\t\t\tif (arg)\n\t\t\t\tLP_F(minor) |= LP_CAREFUL;\n\t\t\telse\n\t\t\t\tLP_F(minor) &amp;= ~LP_CAREFUL;\n\t\t\tbreak;\n\t\tcase LPWAIT:\n\t\t\tLP_WAIT(minor) = arg;\n\t\t\tbreak;\n\t\tcase LPSETIRQ: \n\t\t\treturn -EINVAL;\n\t\t\tbreak;\n\t\tcase LPGETIRQ:\n\t\t\tif (copy_to_user(argp, &amp;LP_IRQ(minor),\n\t\t\t\t\tsizeof(int)))\n\t\t\t\treturn -EFAULT;\n\t\t\tbreak;\n\t\tcase LPGETSTATUS:\n\t\t\tif (mutex_lock_interruptible(&amp;lp_table[minor].port_mutex))\n\t\t\t\treturn -EINTR;\n\t\t\tlp_claim_parport_or_block (&amp;lp_table[minor]);\n\t\t\tstatus = r_str(minor);\n\t\t\tlp_release_parport (&amp;lp_table[minor]);\n\t\t\tmutex_unlock(&amp;lp_table[minor].port_mutex);\n\n\n\t\t\tif (copy_to_user(argp, &amp;status, sizeof(int)))\n\t\t\t\treturn -EFAULT;\n\t\t\tbreak;\n\t\tcase LPRESET:\n\t\t\tlp_reset(minor);\n\t\t\tbreak;\n \t\tcase LPGETFLAGS:\n \t\t\tstatus = LP_F(minor);\n\t\t\tif (copy_to_user(argp, &amp;status, sizeof(int)))\n\t\t\t\treturn -EFAULT;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tretval = -EINVAL;\n\t}\n\treturn retval\n</code></pre><h2>æ€»ç»“æ—¶åˆ»</h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬è®²äº†å­—ç¬¦è®¾å¤‡çš„æ‰“å¼€ã€å†™å…¥å’Œioctlç­‰æœ€å¸¸è§çš„æ“ä½œã€‚ä¸€ä¸ªå­—ç¬¦è®¾å¤‡è¦èƒ½å¤Ÿå·¥ä½œï¼Œéœ€è¦ä¸‰éƒ¨åˆ†é…åˆã€‚</p><p>ç¬¬ä¸€ï¼Œæœ‰ä¸€ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºçš„koæ¨¡å—ï¼Œé‡Œé¢æœ‰æ¨¡å—åˆå§‹åŒ–å‡½æ•°ã€ä¸­æ–­å¤„ç†å‡½æ•°ã€è®¾å¤‡æ“ä½œå‡½æ•°ã€‚è¿™é‡Œé¢å°è£…äº†å¯¹äºå¤–éƒ¨è®¾å¤‡çš„æ“ä½œã€‚åŠ è½½è®¾å¤‡é©±åŠ¨ç¨‹åºæ¨¡å—çš„æ—¶å€™ï¼Œæ¨¡å—åˆå§‹åŒ–å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚åœ¨å†…æ ¸ç»´æŠ¤æ‰€æœ‰å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„æ•°æ®ç»“æ„cdev_mapé‡Œé¢æ³¨å†Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆå®¹æ˜“æ ¹æ®è®¾å¤‡å·ï¼Œæ‰¾åˆ°ç›¸åº”çš„è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚</p><p>ç¬¬äºŒï¼Œåœ¨/devç›®å½•ä¸‹æœ‰ä¸€ä¸ªæ–‡ä»¶è¡¨ç¤ºè¿™ä¸ªè®¾å¤‡ï¼Œè¿™ä¸ªæ–‡ä»¶åœ¨ç‰¹æ®Šçš„devtmpfsæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œå› è€Œä¹Ÿæœ‰ç›¸åº”çš„dentryå’Œinodeã€‚è¿™é‡Œçš„inodeæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„inodeï¼Œé‡Œé¢æœ‰è®¾å¤‡å·ã€‚é€šè¿‡å®ƒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨cdev_mapä¸­æ‰¾åˆ°è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œé‡Œé¢è¿˜æœ‰é’ˆå¯¹å­—ç¬¦è®¾å¤‡æ–‡ä»¶çš„é»˜è®¤æ“ä½œdef_chr_fopsã€‚</p><p>ç¬¬ä¸‰ï¼Œæ‰“å¼€ä¸€ä¸ªå­—ç¬¦è®¾å¤‡æ–‡ä»¶å’Œæ‰“å¼€ä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶æœ‰ç±»ä¼¼çš„æ•°æ®ç»“æ„ï¼Œæœ‰æ–‡ä»¶æè¿°ç¬¦ã€æœ‰struct fileã€æŒ‡å‘å­—ç¬¦è®¾å¤‡æ–‡ä»¶çš„dentryå’Œinodeã€‚å­—ç¬¦è®¾å¤‡æ–‡ä»¶çš„ç›¸å…³æ“ä½œfile_operationsä¸€å¼€å§‹æŒ‡å‘def_chr_fopsï¼Œåœ¨è°ƒç”¨def_chr_fopsé‡Œé¢çš„chrdev_openå‡½æ•°çš„æ—¶å€™ï¼Œä¿®æ”¹ä¸ºæŒ‡å‘è®¾å¤‡æ“ä½œå‡½æ•°ï¼Œä»è€Œè¯»å†™ä¸€ä¸ªå­—ç¬¦è®¾å¤‡æ–‡ä»¶å°±ä¼šç›´æ¥å˜æˆè¯»å†™å¤–éƒ¨è®¾å¤‡äº†ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/fb/cd/fba61fe95e0d2746235b1070eb4c18cd.jpeg?wh=2323*2671\" alt=\"\"></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>è¿™èŠ‚æˆ‘ç”¨æ‰“å°æœºé©±åŠ¨ç¨‹åºä½œä¸ºä¾‹å­æ¥ç»™ä½ è®²è§£å­—ç¬¦è®¾å¤‡ï¼Œè¯·ä½ ä»”ç»†çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç ï¼Œè®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœè®©ä½ è‡ªå·±å†™ä¸€ä¸ªå­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œåº”è¯¥å®ç°å“ªäº›å‡½æ•°å‘¢ï¼Ÿ</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/8c/37/8c0a95fa07a8b9a1abfd394479bdd637.jpg?wh=1110*659\" alt=\"\"></p>","comments":[{"had_liked":false,"id":183332,"user_name":"è¥¿å±±è–„å‡‰","can_delete":false,"product_type":"c1","uid":1438400,"ip_address":"","ucode":"7A44850F99EC02","user_header":"https://static001.geekbang.org/account/avatar/00/15/f2/c0/bf148d4f.jpg","comment_is_top":false,"comment_ctime":1582999195,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"113252148891","product_id":100024701,"comment_content":"è¯¾ä»£è¡¨ä¸åœ¨äº†ï¼Œæˆ‘æ¥å½“è¯¾ä»£è¡¨ã€‚<br><br>## å­—ç¬¦è®¾å¤‡<br>### å†…æ ¸æ¨¡å—<br>- é©±åŠ¨ç¨‹åºçš„å†…æ ¸æ¨¡å—ï¼Œä»¥ ko çš„æ–‡ä»¶å½¢å¼å­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡ insmod åŠ è½½åˆ°å†…æ ¸ä¸­<br>- ä¸€ä¸ªå†…æ ¸æ¨¡å—åº”è¯¥ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆ<br>    - å¤´æ–‡ä»¶éƒ¨åˆ†:include &lt;linux&#47;module.h&gt; åŠ &lt;linux&#47;init.h&gt;<br>    - å®šä¹‰ä»¥å†…ç§‘æ¨¡å—å¤„ç†é€»è¾‘çš„å‡½æ•°ï¼Œå¦‚å¼€ã€å…³ã€è¯»å†™åŠå“åº”ä¸­æ–­ã€‚<br>    - å®šä¹‰ä¸€ä¸ª file_operations æ¥å£ï¼Œä½¿å¾—å¯¹ä¸Šå±‚æ¥å£ç»Ÿä¸€<br>    - å®šä¹‰æ•´ä¸ªæ¨¡å—çš„åˆå§‹åŒ–å’Œé€€å‡ºå‡½æ•°<br>    - è°ƒç”¨ module_init å’Œ module_exitï¼Œåˆ†åˆ«æŒ‡å‘ä¸Šé¢ä¸¤ä¸ªåˆå§‹åŒ–å‡½æ•°å’Œé€€å‡ºå‡½æ•°<br>    - å£°æ˜ä¸€ä¸‹ lisenseï¼Œè°ƒç”¨ MODULE_LICENSE<br>### æ‰“å¼€å­—ç¬¦è®¾å¤‡<br>- æ‰“å¼€å­—ç¬¦è®¾å¤‡<br>    - æ³¨å†Œå­—ç¬¦è®¾å¤‡:é€šè¿‡ insmod åŠ è½½è¿›å†…æ ¸<br>        - è°ƒç”¨ __register_chrdev_region<br>        - æ³¨å†Œè®¾å¤‡çš„ä¸»æ¬¡è®¾å¤‡å·å’Œåç§°<br>        - åˆå§‹åŒ– cdev ç»“æ„ä½“ï¼Œå°†å…¶ ops æˆå‘˜æŒ‡å‘è®¾å¤‡å®šä¹‰çš„ file_operations<br>        - è°ƒç”¨ cdev_add å°†è®¾å¤‡æ·»åŠ åˆ°å†…æ ¸ä¸­çš„ cdev_mapï¼Œç»Ÿä¸€ç®¡ç†å­—ç¬¦è®¾å¤‡<br>    - åˆ›å»ºè®¾å¤‡æ–‡ä»¶:é€šè¿‡ mknod åœ¨ &#47;dev ä¸‹é¢åˆ›å»ºä¸€ä¸ªè®¾å¤‡æ–‡ä»¶<br>        - æ‰¾åˆ°è®¾å¤‡æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œç„¶åä¸ºè¿™ä¸ªæ–°åˆ›å»ºçš„è®¾å¤‡æ–‡ä»¶åˆ›å»ºä¸€ä¸ª dentryï¼Œç”¨äºå…³è”æ–‡ä»¶å’Œ inode<br>        - åˆ›å»ºç‰¹æ®Š inodeï¼Œç”¨äºå…³è”è®¾å¤‡ï¼ˆè¿˜å¯å…³è”FIFOæ–‡ä»¶ã€socketç­‰ï¼‰<br>    - æ‰“å¼€è®¾å¤‡æ–‡ä»¶:è°ƒç”¨ inode çš„ open å‡½æ•°<br>        - å¦‚æœ cdev è¿˜æ²¡æœ‰å…³è”ï¼Œä» cdev_map ä¸­æ‰¾åˆ° cdev å¹¶å…³è”<br>        - æ‰¾åˆ° cdev çš„  file_operationsï¼Œå°†å…¶è®¾ç½®ç»™æ–‡ä»¶æè¿°ç¬¦<br>        - è°ƒç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºçš„ file_operations çš„ open å‡½æ•°ï¼ŒçœŸæ­£æ‰“å¼€è®¾å¤‡<br>### å†™å…¥å­—ç¬¦è®¾å¤‡<br>- å†™å…¥å­—ç¬¦è®¾å¤‡<br>    - è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿæ ‡å‡†æ¥å£ writeï¼Œå‚æ•°ä¸ºè®¾å¤‡çš„æ–‡ä»¶æè¿°ç¬¦<br>    - ç”±äºå·²ç»å°† file_operations æ›¿æ¢æˆäº†è®¾å¤‡çš„ï¼Œæ‰€ä»¥ä¼šç›´æ¥è°ƒç”¨è®¾å¤‡å®šä¹‰çš„ writeï¼ˆå¤šæ€ï¼‰<br>### IOCTLæ§åˆ¶è®¾å¤‡<br>- å‘é€ IOCTL ä¿¡ä»¤æ§åˆ¶è®¾å¤‡<br>    - cmd ç»„æˆ(32ä½):<br>        - æœ€ä½ 8 ä½ä¸º NRï¼Œæ˜¯å‘½ä»¤å·ï¼›<br>        - ç„¶å 8 ä½æ˜¯ TYPEï¼Œæ˜¯ç±»å‹ï¼›<br>        - ç„¶å 14 ä½æ˜¯å‚æ•°çš„å¤§å°ï¼›<br>        - æœ€é«˜ 2 ä½æ˜¯ DIRï¼Œæ˜¯æ–¹å‘ï¼Œè¡¨ç¤ºå†™å…¥ã€è¯»å‡ºï¼Œè¿˜æ˜¯è¯»å†™ã€‚<br>        - æœ‰å¯¹åº”çš„å®æ–¹ä¾¿æ“ä½œ cmd<br>    - è°ƒç”¨ do_vfs_ioctlï¼Œåˆ†æ”¯åˆ¤æ–­ cmd æ‰§è¡Œå¯¹åº”æ“ä½œï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ç§<br>        - é»˜è®¤å®šä¹‰å¥½çš„ cmdï¼Œæ‰§è¡Œç³»ç»Ÿé»˜è®¤æ“ä½œ<br>        - æ™®é€šæ–‡ä»¶ï¼Œè°ƒç”¨ file_ioctl<br>        - å…¶ä»–æ–‡ä»¶è°ƒç”¨ vfs_ioctl<br>        - vfs_ioctl å†…éƒ¨è¿˜æ˜¯ä¼šç›´æ¥è°ƒç”¨è®¾å¤‡å®šä¹‰çš„ cmd å¯¹åº”çš„æ¥æ”¶å‡½æ•°ï¼Œé‡Œé¢å¯¹ä¸åŒ cmd æ‰§è¡Œä¸åŒæ“ä½œ","like_count":27,"discussions":[{"author":{"id":1655940,"avatar":"https://static001.geekbang.org/account/avatar/00/19/44/84/4da14994.jpg","nickname":"å‘†ç“œ","note":"","ucode":"C98C7B224D0640","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":306108,"discussion_content":"å“ˆå“ˆå“ˆ,è¯¾ä»£è¡¨æ˜¯æŒ‡&#34;why&#34;?","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1600171911,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2769183,"avatar":"","nickname":"Geek_ad1659","note":"","ucode":"00E216AC341A8A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538672,"discussion_content":"whyï¼Ÿå“ˆå“ˆå“ˆ\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639480859,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102113,"user_name":"æœ‰é“­","can_delete":false,"product_type":"c1","uid":1046302,"ip_address":"","ucode":"2C7CB36CA5C04C","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/3XbCueYYVWTiclv8T5tFpwiblOxLphvSZxL4ujMdqVMibZnOiaFK2C5nKRGv407iaAsrI0CDICYVQJtiaITzkjfjbvrQ/132","comment_is_top":false,"comment_ctime":1560139021,"is_pvip":false,"replies":[{"id":"37000","content":"draw.io","user_name":"ä½œè€…å›å¤","comment_id":102113,"uid":"1001590","ip_address":"","utype":1,"ctime":1560241077,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"18740008205","product_id":100024701,"comment_content":"é—®ä¸€ä¸‹è€å¸ˆä½ çš„è¿™äº›å›¾æ˜¯ç”¨å•¥å·¥å…·ç”»çš„ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453265,"discussion_content":"draw.io","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560241077,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102035,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1560123994,"is_pvip":false,"replies":[{"id":"37002","content":"èµ","user_name":"ä½œè€…å›å¤","comment_id":102035,"uid":"1001590","ip_address":"","utype":1,"ctime":1560241170,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"18739993178","product_id":100024701,"comment_content":"å¦å¤–è´´ä¸Šä¸€ä¸ªå­—ç¬¦è®¾å¤‡æˆ–è€…å—è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ã€‚ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ç»Ÿç§°ä¸ºè®¾å¤‡å·ã€‚ä¸»è®¾å¤‡å·ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç‰¹å®šçš„é©±åŠ¨ç¨‹åºã€‚æ¬¡è®¾å¤‡å·ç”¨æ¥è¡¨ç¤ºä½¿ç”¨è¯¥é©±åŠ¨ç¨‹åºçš„å„è®¾å¤‡ã€‚","like_count":5,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453228,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560241170,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102030,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1560123568,"is_pvip":false,"replies":[{"id":"37003","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":102030,"uid":"1001590","ip_address":"","utype":1,"ctime":1560241184,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"14445025456","product_id":100024701,"comment_content":"è¿˜æœ‰ä¸ªæ”¶è·å°±æ˜¯ç¨‹åºè®¾è®¡çš„é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œä¹‹å‰å¼€å‘ä¸€ä¸ªéŸ³è§†é¢‘æ¨æµæœåŠ¡å™¨ï¼Œä¸€ä¸ªéŸ³è§†é¢‘ç±»å‹çš„æ“ä½œç¼–ç è§£ç éƒ½æ˜¯ç±»ä¸­å®Œæˆï¼Œç°åœ¨çœ‹æ¥å¯ä»¥æŠŠæ“ä½œå•ç‹¬è®¾è®¡æˆä¸€ä¸ªåŸºç±»ï¼Œå„ç§ç±»å‹çš„éŸ³è§†é¢‘æ“ä½œéƒ½å¯ä»¥ç»§æ‰¿è¿™ä¸ªç±»ï¼Œä»£ç å¯ä»¥è®¾è®¡çš„æ›´ä¸ºä¼˜é›…","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453224,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560241184,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":346217,"user_name":"å°é³„é±¼","can_delete":false,"product_type":"c1","uid":1178888,"ip_address":"","ucode":"9C30CAFB41A263","user_header":"https://static001.geekbang.org/account/avatar/00/11/fd/08/c039f840.jpg","comment_is_top":false,"comment_ctime":1652923682,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652923682","product_id":100024701,"comment_content":"è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œç»Ÿä¸€æ‰€æœ‰è®¾å¤‡æ“ä½œã€‚è€Œè¿™ä¸ªè®¾è®¡ï¼Œçœ‹èµ·æ¥åªæ˜¯ä½¿ç”¨å¤šæ€ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™æ˜¯æŠ½è±¡å‡ºæ¥çš„ç»Ÿä¸€æ“ä½œå±‚ã€‚æœ‰è¿™ä¸ªæƒ³æ³•ï¼Œè¦å®ç°å¯¹å„ç§å„æ ·çš„è®¾å¤‡ï¼Œç¹æ‚çš„åŠŸèƒ½è€Œè¨€ï¼Œå¹¶ä¸ç®€å•ï¼è€ŒæŠ½è±¡æœ¬èº«ï¼Œå°±å¾ˆå¤æ‚äº†ï¼Œå€¼å¾—ç»§ç»­æ·±å…¥ï¼ï¼ï¼","like_count":1},{"had_liked":false,"id":291298,"user_name":"æ ¸æ¡ƒ","can_delete":false,"product_type":"c1","uid":1385204,"ip_address":"","ucode":"7AB05270CBCCCB","user_header":"https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg","comment_is_top":false,"comment_ctime":1620194005,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1620194005","product_id":100024701,"comment_content":"å­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºæ²¡æœ‰äº†è§£è¿‡ï¼Œä½†æ˜¯åœ¨githubä¸Šé¢æ‰¾åˆ°è¿‡å®ç°è‡ªå®šä¹‰æ–‡ä»¶ç³»ç»Ÿçš„hellofsï¼Œè¿™ä¸ªå¯ä»¥æ ¸å¿ƒå…³é”®è¿˜æ˜¯è‡ªå®šä¹‰çš„file operationså’Œæ³¨å†Œè¿™äº›ï¼Œå¤§åŒå°å¼‚çš„","like_count":0},{"had_liked":false,"id":160887,"user_name":"è€¿é•¿å­¦","can_delete":false,"product_type":"c1","uid":1309948,"ip_address":"","ucode":"C7A262812854D4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fc/fc/1e235814.jpg","comment_is_top":false,"comment_ctime":1576054261,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1576054261","product_id":100024701,"comment_content":"&#47;procæ–‡ä»¶ç³»ç»Ÿçš„åŸç†æ˜¯å®ç°æ˜¯åŸºäºä»€ä¹ˆï¼Ÿ&#47;procé‡Œé¢è¿™äº›æ–‡ä»¶ä½¿ç”¨çš„æ˜¯å†…å­˜å­˜æ”¾è¿˜æ˜¯ç£ç›˜å­˜æ”¾çš„ï¼Œå½“å‘½ä»¤ç»ˆæ­¢åè¿™äº›æ–‡ä»¶åˆå»äº†å“ªé‡Œï¼Œæ€ä¹ˆé”€æ¯çš„ï¼Œè°¢è°¢ï¼Œä¹‹å‰ä¹°äº†ç½‘ç»œåè®®çš„å­¦äº†ä¸å»ç½‘ç»œåŸç†","like_count":0},{"had_liked":false,"id":160886,"user_name":"è€¿é•¿å­¦","can_delete":false,"product_type":"c1","uid":1309948,"ip_address":"","ucode":"C7A262812854D4","user_header":"https://static001.geekbang.org/account/avatar/00/13/fc/fc/1e235814.jpg","comment_is_top":false,"comment_ctime":1576054062,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1576054062","product_id":100024701,"comment_content":"æ‚¨å¥½è€å¸ˆï¼Œæˆ‘æƒ³è¯·æ•™ä¸€ä¸ªé—®é¢˜ï¼Œnohub  ping  www.baidu.com  &amp;çš„è¾“å‡ºå­˜æ”¾åˆ°å“ªé‡Œå»äº†ï¼Œå¦‚æœé•¿æ—¶é—´pingä½¿ç”¨killç»ˆæ­¢çš„æ—¶å€™ä¸ºä»€ä¹ˆä¼šå¼•èµ·å†…å­˜å‡é«˜å‘¢ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1318941,"avatar":"https://static001.geekbang.org/account/avatar/00/14/20/1d/0c1a184c.jpg","nickname":"ç½—è¾‘æ€ç»´","note":"","ucode":"D257A06EDE928E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":185296,"discussion_content":"nohup.out","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582613741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154781,"user_name":"è«å","can_delete":false,"product_type":"c1","uid":1007254,"ip_address":"","ucode":"E28F2602BA25DD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg","comment_is_top":false,"comment_ctime":1574563045,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1574563045","product_id":100024701,"comment_content":"è€å¸ˆè®²å¾—å¾ˆèµ","like_count":0},{"had_liked":false,"id":103287,"user_name":"Sharry","can_delete":false,"product_type":"c1","uid":1239293,"ip_address":"","ucode":"045DDB864659F6","user_header":"https://static001.geekbang.org/account/avatar/00/12/e8/fd/035f4c94.jpg","comment_is_top":false,"comment_ctime":1560409559,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560409559","product_id":100024701,"comment_content":"è€å¸ˆ, åœ¨ç³»ç»Ÿåˆå§‹åŒ–å’Œæœ¬èŠ‚çš„å†…å®¹ä¸­, æˆ‘éƒ½çœ‹åˆ°äº†åŸºäºå†…å­˜æ–‡ä»¶ç³»ç»Ÿ, è®©æˆ‘å¾ˆå¥½å¥‡å®ƒæ˜¯å¦‚ä½•è¿ä½œçš„, ä¸çŸ¥è€å¸ˆä»€ä¹ˆæ—¶å€™å¯ä»¥å‡ºä¸ä¹‹ç›¸å…³çš„æ–‡ç« å‘¢?","like_count":0},{"had_liked":false,"id":102369,"user_name":"ezra.xu","can_delete":false,"product_type":"c1","uid":1014005,"ip_address":"","ucode":"6C3E11889BC6AB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/78/f5/ae200a94.jpg","comment_is_top":false,"comment_ctime":1560214065,"is_pvip":false,"replies":[{"id":"36997","content":"è¿™å°±å¤ªå¤æ‚å•¦ï¼Œæ¯ä¸€ç¯‡æ–‡ç« éƒ½æ‰¾åˆ°ä¸€æœ¬ä¹¦","user_name":"ä½œè€…å›å¤","comment_id":102369,"uid":"1001590","ip_address":"","utype":1,"ctime":1560241003,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1560214065","product_id":100024701,"comment_content":"é™¤äº†openï¼Œcloseï¼Œreadï¼Œwriteç­‰ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥åŠ å…¥äº›å¼‚å¸¸æ•è·ï¼Œå¼‚æ­¥æ“ä½œï¼Œå¤šçº¿ç¨‹çš„å‡½æ•°â€¦â€¦","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453382,"discussion_content":"è¿™å°±å¤ªå¤æ‚å•¦ï¼Œæ¯ä¸€ç¯‡æ–‡ç« éƒ½æ‰¾åˆ°ä¸€æœ¬ä¹¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1560241003,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":102028,"user_name":"LeonğŸ“·","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1560123348,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1560123348","product_id":100024701,"comment_content":"è¿™èŠ‚æ„å¤–çš„æ”¶è·æ˜¯å­¦ä¼šäº†æ€ä¹ˆç”»é¡¹ç›®ç»“æ„æµç¨‹å›¾å’Œå„ç§è‰²è°ƒæ­é…ï¼Œè€å¸ˆçœŸæ˜¯å¤šé¢å°èƒ½æ‰‹","like_count":0}]}