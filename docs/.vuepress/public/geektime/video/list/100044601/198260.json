{"id":198260,"title":"23 | 静态文件中间件：前后端分离开发合并部署骚操作","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/NET-Core\">https://gitee.com/geektime-geekbang/NET-Core</a></p>","comments":[{"had_liked":false,"id":178008,"user_name":"多读书","can_delete":false,"product_type":"c3","uid":1151239,"ip_address":"","ucode":"A0F87F106C5BED","user_header":"https://static001.geekbang.org/account/avatar/00/11/91/07/f270f35f.jpg","comment_is_top":false,"comment_ctime":1581568510,"is_pvip":false,"replies":[{"id":69283,"content":"这段逻辑之前是先注册了一个静态文件中间件的，如果文件存在，就已经响应出去了，不会执行到这里。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1581754102,"ip_address":"","comment_id":178008,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"那个只对api路由拦截，重定向到index.html。比如图片的url中不包含api，重定向到index.html会不会出现访问不到的情况","like_count":2,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483633,"discussion_content":"这段逻辑之前是先注册了一个静态文件中间件的，如果文件存在，就已经响应出去了，不会执行到这里。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581754102,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":252110,"user_name":"🏌","can_delete":false,"product_type":"c3","uid":1808559,"ip_address":"","ucode":"20DBFD7DDBEF38","user_header":"https://static001.geekbang.org/account/avatar/00/1b/98/af/c1afa78b.jpg","comment_is_top":false,"comment_ctime":1602128631,"is_pvip":false,"replies":[{"id":93107,"content":"是这样的","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1603377780,"ip_address":"","comment_id":252110,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"这骚操作岂不是可以把 Vue Build 好的项目放到 wwwroot就可以用了？","like_count":1,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":506716,"discussion_content":"是这样的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1603377780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":226372,"user_name":"高胜杰","can_delete":false,"product_type":"c3","uid":1884560,"ip_address":"","ucode":"7141DBA4E30CF7","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKGiaLDlazWNmN0vicIH3By3dTRibN6JuBwJCR9JwWQtCsZxOGpjnuPQmugnqj4SerXOnja0LSntAic5g/132","comment_is_top":false,"comment_ctime":1592053049,"is_pvip":false,"replies":[{"id":86006,"content":"前端最终都是静态文件，一般会有index.html文件作为主页面，可以单独部署，也可以放到core的wwwroot目录，其它文件都作为资源放到cdn服务器","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1594222810,"ip_address":"","comment_id":226372,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"前后端分离，前端打包生成的文件能否作为静态文件？这样部署的时候就不用单独部署前端了","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":498216,"discussion_content":"前端最终都是静态文件，一般会有index.html文件作为主页面，可以单独部署，也可以放到core的wwwroot目录，其它文件都作为资源放到cdn服务器","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594222810,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1884560,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKGiaLDlazWNmN0vicIH3By3dTRibN6JuBwJCR9JwWQtCsZxOGpjnuPQmugnqj4SerXOnja0LSntAic5g/132","nickname":"高胜杰","note":"","ucode":"7141DBA4E30CF7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":309159,"discussion_content":"感谢老师指导，已经按照此方法实现此功能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1601200649,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":194883,"user_name":"Jerry","can_delete":false,"product_type":"c3","uid":1500705,"ip_address":"","ucode":"C8607D39BEA625","user_header":"https://static001.geekbang.org/account/avatar/00/16/e6/21/c62f354a.jpg","comment_is_top":false,"comment_ctime":1585115496,"is_pvip":false,"replies":[{"id":77437,"content":"是的，因此这里说它是个“骚操作”，主要还是讲ASP.NET Core的一些能力。\n\n当某些场景下对前端生成index.html有动态处理的需求时，例如AB测试、功能灰度等，就可以借助这个能力来实现。","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1587042928,"ip_address":"","comment_id":194883,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"用Nginx部署前端生成的文件，配置一下就可以了，不用Api层管","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488921,"discussion_content":"是的，因此这里说它是个“骚操作”，主要还是讲ASP.NET Core的一些能力。\n\n当某些场景下对前端生成index.html有动态处理的需求时，例如AB测试、功能灰度等，就可以借助这个能力来实现。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587042928,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1907116,"avatar":"https://static001.geekbang.org/account/avatar/00/1d/19/ac/bdb46d30.jpg","nickname":"雷洛","note":"","ucode":"C847A4AA13C8AF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":215137,"discussion_content":"naginx配置后，前后端合并部署的时候，用户刷新浏览器还是会有问题的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585289769,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":179639,"user_name":"Geek_d38f30","can_delete":false,"product_type":"c3","uid":1512147,"ip_address":"","ucode":"955D6480731336","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/ib1aca6ibMC3bcTZeVdTFalyyhdvy4DLQ7s4WBTWaw95k8IJNTUkZ5VwfB9rYwxVz3PAz4chBJhWcyMHib9KdEEnQ/132","comment_is_top":false,"comment_ctime":1582046703,"is_pvip":false,"replies":[{"id":70271,"content":"history路由是指无刷新，但实质上如果用户刷新浏览器的话，还是会去后端请求这个html的\n例如 &#47;order&#47;detail\n","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1582520245,"ip_address":"","comment_id":179639,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"前端一般使用history的路由（是指无刷新那种吗）。有先后顺序后后端路由就不会把前端的路由覆盖","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":484338,"discussion_content":"history路由是指无刷新，但实质上如果用户刷新浏览器的话，还是会去后端请求这个html的\n例如 /order/detail\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582520245,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178275,"user_name":"公号:阿Q看世界","can_delete":false,"product_type":"c3","uid":1095682,"ip_address":"","ucode":"5BB20D829789D6","user_header":"https://static001.geekbang.org/account/avatar/00/10/b8/02/b2268557.jpg","comment_is_top":false,"comment_ctime":1581649125,"is_pvip":false,"replies":[{"id":69288,"content":"开启目录浏览，是可以看到的","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1581754294,"ip_address":"","comment_id":178275,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"a文件夹点进去之后不会显示下一层的文件了吗？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483740,"discussion_content":"开启目录浏览，是可以看到的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581754294,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1065351,"avatar":"https://static001.geekbang.org/account/avatar/00/10/41/87/d26efb2e.jpg","nickname":"SuperSnow","note":"","ucode":"84C89AA8083E6A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":214521,"discussion_content":"那为什么没看到，直接访问a下面的index.html，是因为也usedefaultFiles()了？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1585202245,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":178232,"user_name":"Noah","can_delete":false,"product_type":"c3","uid":1018526,"ip_address":"","ucode":"A13DBCE8BA74CC","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8a/9e/94bdcdc5.jpg","comment_is_top":false,"comment_ctime":1581635408,"is_pvip":false,"replies":[{"id":69291,"content":"静态文件中间件不支持授权，要做的话，需要使用Controller响应文件的方式来控制","user_name":"作者回复","user_name_real":"肖伟宇","uid":1756585,"ctime":1581754430,"ip_address":"","comment_id":178232,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"请问给静态文件加上authentication和authorization的比较好的方法是什么呢？","like_count":0,"discussions":[{"author":{"id":1756585,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/cd/a9/791d0f5e.jpg","nickname":"老肖想当外语大佬","note":"","ucode":"F662D1BF671E92","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":483716,"discussion_content":"静态文件中间件不支持授权，要做的话，需要使用Controller响应文件的方式来控制","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1581754430,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1774701,"avatar":"https://static001.geekbang.org/account/avatar/00/1b/14/6d/b1270132.jpg","nickname":"霍尔顿","note":"","ucode":"222AF06CA5A7CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":181344,"discussion_content":"\nController返回View，View对应的.cshtml文件内容用前端Index.html的内容，可以人肉拷，也可以写拷贝脚本，每次发布的时候自动执行。","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1582362760,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1512147,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/ib1aca6ibMC3bcTZeVdTFalyyhdvy4DLQ7s4WBTWaw95k8IJNTUkZ5VwfB9rYwxVz3PAz4chBJhWcyMHib9KdEEnQ/132","nickname":"Geek_d38f30","note":"","ucode":"955D6480731336","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":179550,"discussion_content":"来个关系表，保存真实路径和虚拟路径。读取的时候用流返回。这样就不会暴露url。接口权限按平台接口的来。你可以试试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582219412,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286537,"user_name":"辣么大","can_delete":false,"product_type":"c3","uid":1396951,"ip_address":"","ucode":"AB308B6DCA0108","user_header":"https://static001.geekbang.org/account/avatar/00/15/50/d7/f82ed283.jpg","comment_is_top":false,"comment_ctime":1617360936,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"就是我想要的骚操作! 老师教的好几个点我都已经用在实际项目上了。","like_count":0},{"had_liked":false,"id":226180,"user_name":"小喵喵","can_delete":false,"product_type":"c3","uid":1062444,"ip_address":"","ucode":"FDBBB2A59DB8B6","user_header":"https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg","comment_is_top":false,"comment_ctime":1591972755,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100044601,"comment_content":"请教老师：\nservices.AddDirectoryBrowser();\napp.UseDirectoryBrowser();\n这两个有什么区别呢？为什么不加services.AddDirectoryBrowser();只加app.UseDirectoryBrowser();，程序为什么一样能运行正确？","like_count":0}]}