{"id":424827,"title":"26 | ä»Ping-Pongæ¶ˆæ¯å­¦ä¹ Gossipåè®®çš„å®ç°","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è’‹å¾·é’§ã€‚</p><p></p><p>ä»è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬åˆå°†è¿›å…¥ä¸€ä¸ªæ–°çš„æ¨¡å—ï¼šâ€œRedis Clusterâ€æ¨¡å—ã€‚åœ¨è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæˆ‘ä¼šå¸¦ä½ äº†è§£Redis Clusterçš„å…³é”®åŠŸèƒ½å®ç°ï¼ŒåŒ…æ‹¬äº†Gossipåè®®é€šä¿¡ã€é›†ç¾¤å…³é”®å‘½ä»¤å’Œæ•°æ®è¿ç§»ç­‰æœºåˆ¶çš„è®¾è®¡ä¸å®ç°ã€‚</p><p></p><p>é€šè¿‡è¿™äº›è¯¾ç¨‹çš„å­¦ä¹ ï¼Œä¸€æ–¹é¢ï¼Œä½ å¯ä»¥æ·±å…¥äº†è§£Redisæ˜¯å¦‚ä½•å®Œæˆé›†ç¾¤å…³ç³»ç»´æŠ¤ã€è¯·æ±‚è½¬å‘å’Œæ•°æ®è¿ç§»çš„ã€‚å½“ä½ é‡åˆ°é›†ç¾¤é—®é¢˜æ—¶ï¼Œè¿™äº›çŸ¥è¯†å¯ä»¥å¸®åŠ©ä½ æ’æŸ¥é—®é¢˜ã€‚å¦ä¸€æ–¹é¢ï¼Œå½“ä½ åœ¨å¼€å‘åˆ†å¸ƒå¼é›†ç¾¤æ—¶ï¼Œä¸å¯é¿å…åœ°ä¼šé‡åˆ°èŠ‚ç‚¹ä¿¡æ¯ç»´æŠ¤ã€æ•°æ®æ”¾ç½®å’Œè¿ç§»ç­‰è®¾è®¡é—®é¢˜ï¼Œæ¥ä¸‹æ¥çš„å‡ èŠ‚è¯¾å¯ä»¥è®©ä½ æŒæ¡Gossipåè®®ã€æ•°æ®è¿ç§»ç­‰åˆ†å¸ƒå¼é›†ç¾¤ä¸­å…³é”®æœºåˆ¶çš„å…¸å‹è®¾è®¡å’Œå®ç°ï¼Œè€Œè¿™äº›å®ç°æ–¹æ³•å¯¹äºä½ å¼€å‘åˆ†å¸ƒå¼é›†ç¾¤æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚</p><p></p><p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘å°±å…ˆå¸¦ä½ æ¥å­¦ä¹ Redis Clusterä¸­èŠ‚ç‚¹çš„é€šä¿¡æœºåˆ¶ï¼Œè€Œè¿™ä¸ªé€šä¿¡æœºåˆ¶çš„å…³é”®æ˜¯Gossipåè®®ã€‚æ‰€ä»¥ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸»è¦æ¥äº†è§£ä¸‹Gossipåè®®åœ¨Redisä¸­æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p></p><h2>Gossipåè®®çš„åŸºæœ¬å·¥ä½œæœºåˆ¶</h2><p>å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤æ¥è¯´ï¼Œå®ƒçš„è‰¯å¥½è¿è¡Œç¦»ä¸å¼€é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯å’ŒèŠ‚ç‚¹çŠ¶æ€çš„æ­£å¸¸ç»´æŠ¤ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥é€‰æ‹©<strong>ä¸­å¿ƒåŒ–</strong>çš„æ–¹æ³•ï¼Œä½¿ç”¨ä¸€ä¸ªç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œæ¯”å¦‚Zookeeperæˆ–etcdï¼Œæ¥ç»´æŠ¤é›†ç¾¤èŠ‚ç‚¹çš„ä¿¡æ¯ã€çŠ¶æ€ç­‰ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©<strong>å»ä¸­å¿ƒåŒ–</strong>çš„æ–¹æ³•ï¼Œè®©æ¯ä¸ªèŠ‚ç‚¹éƒ½ç»´æŠ¤å½¼æ­¤çš„ä¿¡æ¯ã€çŠ¶æ€ï¼Œå¹¶ä¸”ä½¿ç”¨é›†ç¾¤é€šä¿¡åè®®Gossipåœ¨èŠ‚ç‚¹é—´ä¼ æ’­æ›´æ–°çš„ä¿¡æ¯ï¼Œä»è€Œå®ç°æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½æ‹¥æœ‰ä¸€è‡´çš„ä¿¡æ¯ã€‚</p><!-- [[[read_end]]] --><p></p><p>ä¸‹å›¾å°±å±•ç¤ºäº†è¿™ä¸¤ç§é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ç»´æŠ¤çš„æ–¹æ³•ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p></p><p><img src=\"https://static001.geekbang.org/resource/image/08/c7/08e25d1645b196f0143b495071d219c7.jpg?wh=1920x894\" alt=\"å›¾ç‰‡\"></p><p>æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/310347\">ç¬¬ä¸€å­£</a>çš„â€œé€šä¿¡å¼€é”€ï¼šé™åˆ¶Redis Clusterè§„æ¨¡çš„å…³é”®å› ç´ â€è¯¾ç¨‹ä¸­ï¼Œä»‹ç»è¿‡Gossipåè®®çš„å·¥ä½œæœºåˆ¶ï¼Œä½ å¯ä»¥å»å‚è€ƒæˆ–å›é¡¾ä¸‹ã€‚è¿™é‡Œï¼Œæˆ‘å°±ç®€å•ä»‹ç»ä¸‹Gossipåè®®çš„ä¸»è¦æœºåˆ¶ï¼Œæ¥å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£æ¥ä¸‹æ¥è¦å­¦ä¹ çš„Gossipåè®®ï¼Œåœ¨æºç å±‚é¢çš„è®¾è®¡ä¸å®ç°ã€‚</p><p></p><p>ç®€å•æ¥è¯´ï¼Œåœ¨ä¸€ä¸ªä½¿ç”¨äº†Gossipåè®®çš„é›†ç¾¤ä¸­ï¼Œæ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¼šç»´æŠ¤ä¸€ä»½é›†ç¾¤çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬é›†ç¾¤ä¸­å„èŠ‚ç‚¹çš„ä¿¡æ¯ã€è¿è¡ŒçŠ¶æ€ï¼Œä»¥åŠæ•°æ®åœ¨å„èŠ‚ç‚¹é—´çš„åˆ†å¸ƒæƒ…å†µã€‚</p><p></p><p>å¯¹äºRedisæ¥è¯´ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯åŒ…æ‹¬äº†èŠ‚ç‚¹åç§°ã€IPã€ç«¯å£å·ç­‰ï¼Œè€ŒèŠ‚ç‚¹è¿è¡ŒçŠ¶æ€ä¸»è¦ç”¨ä¸¤ä¸ªæ—¶é—´æ¥è¡¨ç¤ºï¼Œåˆ†åˆ«æ˜¯èŠ‚ç‚¹å‘å…¶ä»–èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯çš„æ—¶é—´ï¼Œä»¥åŠå®ƒè‡ªå·±æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹è¿”å›çš„PONGæ¶ˆæ¯çš„æ—¶é—´ã€‚æœ€åï¼Œé›†ç¾¤ä¸­æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œåœ¨Redisä¸­å°±å¯¹åº”äº†Redis Clusterçš„slotsåˆ†é…æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹æ‹¥æœ‰å“ªäº›slotsã€‚</p><p></p><p>å½“é›†ç¾¤èŠ‚ç‚¹æŒ‰ç…§Gossipåè®®å·¥ä½œæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šä»¥ä¸€å®šçš„é¢‘ç‡ä»é›†ç¾¤ä¸­éšæœºæŒ‘é€‰ä¸€äº›å…¶ä»–èŠ‚ç‚¹ï¼ŒæŠŠè‡ªèº«çš„ä¿¡æ¯å’Œå·²çŸ¥çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯ï¼Œç”¨PINGæ¶ˆæ¯å‘é€ç»™é€‰å‡ºçš„èŠ‚ç‚¹ã€‚è€Œå…¶ä»–èŠ‚ç‚¹æ”¶åˆ°PINGæ¶ˆæ¯åï¼Œä¹Ÿä¼šæŠŠè‡ªå·±çš„ä¿¡æ¯å’Œå·²çŸ¥çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯ï¼Œç”¨PONGæ¶ˆæ¯è¿”å›ç»™å‘é€èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p></p><p><img src=\"https://static001.geekbang.org/resource/image/44/1b/44b8b114acyy59f9eb5ac410a28fe01b.jpg?wh=1920x489\" alt=\"å›¾ç‰‡\"></p><p>Gossipåè®®æ­£æ˜¯é€šè¿‡è¿™ç§<strong>éšæœºæŒ‘é€‰é€šä¿¡èŠ‚ç‚¹</strong>çš„æ–¹æ³•ï¼Œè®©èŠ‚ç‚¹ä¿¡æ¯åœ¨æ•´ä¸ªé›†ç¾¤ä¸­ä¼ æ’­ã€‚å½“æœ‰èŠ‚ç‚¹ç»´æŠ¤çš„ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¯”å¦‚æ•°æ®å¸ƒå±€ä¿¡æ¯å‘ç”Ÿäº†æ”¹å˜ï¼Œé‚£ä¹ˆé€šè¿‡å‡ è½®é€šä¿¡åï¼Œå…¶ä»–èŠ‚ç‚¹ä¹Ÿå¯ä»¥è·å¾—è¿™ä¸€å˜åŒ–çš„ä¿¡æ¯äº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±å®ç°äº†åˆ†å¸ƒå¼é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ç»´æŠ¤ä¸€è‡´çš„çŠ¶æ€ä¿¡æ¯çš„ç›®æ ‡ã€‚</p><p></p><p>å¥½äº†ï¼Œäº†è§£äº†Gossipåè®®çš„åŸºæœ¬å·¥ä½œæœºåˆ¶åï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥å­¦ä¹ Redisä¸­æ˜¯å¦‚ä½•å®ç°Gossipåè®®çš„ã€‚</p><p></p><h2>Redisæ˜¯å¦‚ä½•å®ç°Gossipé€šä¿¡çš„ï¼Ÿ</h2><p>é¦–å…ˆï¼Œä½ è¦çŸ¥é“Redis Clusterçš„ä¸»è¦åŠŸèƒ½æ˜¯åœ¨<strong>cluster.hå’Œcluster.c</strong>ä¸¤ä¸ªæ–‡ä»¶ä¸­å®šä¹‰å’Œå®ç°çš„ã€‚å¦‚æœä½ æœ‰è¿›ä¸€æ­¥é˜…è¯»æºç çš„éœ€æ±‚ï¼Œå¯ä»¥é‡ç‚¹ä»è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­æŸ¥æ‰¾ã€‚</p><p></p><p>ç„¶åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Redis Clusterä¸­é€šä¿¡çš„æ¶ˆæ¯æœ‰å“ªäº›ï¼Œè¿™ä¹Ÿæ˜¯Gossipåè®®é€šä¿¡çš„åŸºç¡€æ•°æ®ç»“æ„ã€‚</p><p></p><h3>èŠ‚ç‚¹é€šä¿¡çš„å¸¸è§æ¶ˆæ¯æœ‰å“ªäº›ï¼Ÿ</h3><p>Redisæºç åœ¨cluster.hæ–‡ä»¶ä¸­ï¼Œé€šè¿‡å®å®šä¹‰å®šä¹‰äº†èŠ‚ç‚¹é—´é€šä¿¡çš„æ¶ˆæ¯ç±»å‹ã€‚ä¸‹é¢çš„ä»£ç åˆ—äº†å‡ ç§å¸¸è§çš„æ¶ˆæ¯ï¼ŒåŒ…æ‹¬<strong>Ping</strong>æ¶ˆæ¯ï¼Œè¿™æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ç”¨æ¥å‘å…¶ä»–èŠ‚ç‚¹å‘é€ä¿¡æ¯çš„æ¶ˆæ¯ç±»å‹ï¼Œè€Œ<strong>Pong</strong>æ˜¯å¯¹Pingæ¶ˆæ¯çš„å›å¤ã€‚<strong>Meet</strong>æ¶ˆæ¯æ˜¯ä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºè¦åŠ å…¥é›†ç¾¤çš„æ¶ˆæ¯ç±»å‹ï¼Œè€Œ<strong>Fail</strong>æ¶ˆæ¯è¡¨ç¤ºæŸä¸ªèŠ‚ç‚¹æœ‰æ•…éšœã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šçš„æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥è¿›ä¸€æ­¥é˜…è¯»cluster.hæ–‡ä»¶ã€‚</p><pre><code class=\"language-plain\">#define CLUSTERMSG_TYPE_PING 0&nbsp; //Pingæ¶ˆæ¯ï¼Œç”¨æ¥å‘å…¶ä»–èŠ‚ç‚¹å‘é€å½“å‰èŠ‚ç‚¹ä¿¡æ¯\n#define CLUSTERMSG_TYPE_PONG 1&nbsp; //Pongæ¶ˆæ¯ï¼Œå¯¹Pingæ¶ˆæ¯çš„å›å¤\n#define CLUSTERMSG_TYPE_MEET 2&nbsp; //Meetæ¶ˆæ¯ï¼Œè¡¨ç¤ºæŸä¸ªèŠ‚ç‚¹è¦åŠ å…¥é›†ç¾¤\n#define CLUSTERMSG_TYPE_FAIL 3&nbsp; //Failæ¶ˆæ¯ï¼Œè¡¨ç¤ºæŸä¸ªèŠ‚ç‚¹æœ‰æ•…éšœ\n</code></pre><p>åˆšæ‰æˆ‘ä»‹ç»çš„æ˜¯èŠ‚ç‚¹é—´é€šä¿¡çš„æ¶ˆæ¯ç±»å‹ï¼Œé‚£ä¹ˆï¼Œ<strong>Redisæºç ä¸­æ¶ˆæ¯çš„æ•°æ®ç»“æ„å…·ä½“æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</strong>è¿™éƒ¨åˆ†å†…å®¹ä¹Ÿæ˜¯åœ¨cluster.hæ–‡ä»¶ä¸­å®šä¹‰çš„ã€‚</p><p></p><p>Rediså®šä¹‰äº†ä¸€ä¸ª<strong>ç»“æ„ä½“clusterMsg</strong>ï¼Œå®ƒç”¨æ¥è¡¨ç¤ºèŠ‚ç‚¹é—´é€šä¿¡çš„ä¸€æ¡æ¶ˆæ¯ã€‚å®ƒåŒ…å«çš„ä¿¡æ¯åŒ…æ‹¬å‘é€æ¶ˆæ¯èŠ‚ç‚¹çš„åç§°ã€IPã€é›†ç¾¤é€šä¿¡ç«¯å£å’Œè´Ÿè´£çš„slotsï¼Œä»¥åŠæ¶ˆæ¯ç±»å‹ã€æ¶ˆæ¯é•¿åº¦å’Œå…·ä½“çš„æ¶ˆæ¯ä½“ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†clusterMsgå®šä¹‰ä¸­çš„éƒ¨åˆ†é‡è¦å†…å®¹ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code class=\"language-plain\">typedef struct {\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; uint32_t totlen;&nbsp;&nbsp;&nbsp; //æ¶ˆæ¯é•¿åº¦\n&nbsp;&nbsp; uint16_t type;&nbsp;&nbsp;&nbsp;&nbsp; //æ¶ˆæ¯ç±»å‹\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; char sender[CLUSTER_NAMELEN]; &nbsp;//å‘é€æ¶ˆæ¯èŠ‚ç‚¹çš„åç§°\n&nbsp;&nbsp; unsigned char myslots[CLUSTER_SLOTS/8]; //å‘é€æ¶ˆæ¯èŠ‚ç‚¹è´Ÿè´£çš„slots\n&nbsp;&nbsp; char myip[NET_IP_STR_LEN];&nbsp; //å‘é€æ¶ˆæ¯èŠ‚ç‚¹çš„IP\n&nbsp;&nbsp; uint16_t cport;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //å‘é€æ¶ˆæ¯èŠ‚ç‚¹çš„é€šä¿¡ç«¯å£\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; union clusterMsgData data;&nbsp; //æ¶ˆæ¯ä½“\n} clusterMsg;\n</code></pre><p>ä»clusterMsgæ•°æ®ç»“æ„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒåŒ…å«äº†ä¸€ä¸ª<strong>è”åˆä½“ç»“æ„clusterMsgData</strong>ï¼Œè€Œè¿™ä¸ªæ•°æ®ç»“æ„æ­£æ˜¯å®šä¹‰äº†èŠ‚ç‚¹é—´é€šä¿¡çš„å®é™…æ¶ˆæ¯ä½“ã€‚</p><p></p><p>åœ¨cluster.hæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°clusterMsgDataçš„å®šä¹‰ï¼Œå®ƒåŒ…å«äº†å¤šç§æ¶ˆæ¯ç±»å‹å¯¹åº”çš„æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬clusterMsgDataGossipã€clusterMsgDataFailã€clusterMsgDataPublishå’ŒclusterMsgDataUpdateï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè€Œè¿™äº›æ•°æ®ç»“æ„ä¹Ÿå°±å¯¹åº”äº†ä¸åŒç±»å‹æ¶ˆæ¯çš„æ¶ˆæ¯ä½“ã€‚</p><p></p><pre><code class=\"language-plain\">union clusterMsgData {\n&nbsp;&nbsp;&nbsp; //Pingã€Pongå’ŒMeetæ¶ˆæ¯ç±»å‹å¯¹åº”çš„æ•°æ®ç»“æ„\n&nbsp;&nbsp;&nbsp; struct {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterMsgDataGossip gossip[1];\n&nbsp;&nbsp;&nbsp; } ping;\n&nbsp;\n&nbsp;&nbsp;&nbsp; //Failæ¶ˆæ¯ç±»å‹å¯¹åº”çš„æ•°æ®ç»“æ„\n&nbsp;&nbsp;&nbsp; struct {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterMsgDataFail about;\n&nbsp;&nbsp;&nbsp; } fail;\n&nbsp;\n&nbsp;&nbsp;&nbsp; //Publishæ¶ˆæ¯ç±»å‹å¯¹åº”çš„æ•°æ®ç»“æ„\n&nbsp;&nbsp;&nbsp; struct {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterMsgDataPublish msg;\n&nbsp;&nbsp;&nbsp; } publish;\n&nbsp;\n&nbsp;&nbsp;&nbsp; //Updateæ¶ˆæ¯ç±»å‹å¯¹åº”çš„æ•°æ®ç»“æ„\n&nbsp;&nbsp;&nbsp; struct {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterMsgDataUpdate nodecfg;\n&nbsp;&nbsp;&nbsp; } update;\n&nbsp;\n&nbsp;&nbsp;&nbsp; //Moduleæ¶ˆæ¯ç±»å‹å¯¹åº”çš„æ•°æ®ç»“æ„\n&nbsp;&nbsp;&nbsp; struct {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterMsgModule msg;\n&nbsp;&nbsp;&nbsp; } module;\n};\n</code></pre><p>åœ¨è¿™ä¸ªè”åˆä½“ç»“æ„ä¸­ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹<strong>clusterMsgDataGossipæ•°æ®ç»“æ„</strong>ï¼Œå› ä¸ºå®ƒå¯¹åº”äº†Gossipåè®®é€šä¿¡è¿‡ç¨‹ä¸­ä½¿ç”¨çš„Pingã€Pongå’ŒMeetæ¶ˆæ¯çš„æ¶ˆæ¯ä½“ã€‚clusterMsgDataGossipæ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">typedef struct {\n&nbsp;&nbsp;&nbsp; char nodename[CLUSTER_NAMELEN]; //èŠ‚ç‚¹åç§°\n&nbsp;&nbsp;&nbsp; uint32_t ping_sent;&nbsp; //èŠ‚ç‚¹å‘é€Pingçš„æ—¶é—´\n&nbsp;&nbsp;&nbsp; uint32_t pong_received; //èŠ‚ç‚¹æ”¶åˆ°Pongçš„æ—¶é—´\n&nbsp;&nbsp;&nbsp; char ip[NET_IP_STR_LEN];&nbsp; //èŠ‚ç‚¹IP\n&nbsp;&nbsp;&nbsp; uint16_t port;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯çš„é€šä¿¡ç«¯å£\n&nbsp;&nbsp;&nbsp; uint16_t cport;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //èŠ‚ç‚¹ç”¨äºé›†ç¾¤é€šä¿¡çš„ç«¯å£\n&nbsp;&nbsp;&nbsp; uint16_t flags;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//èŠ‚ç‚¹çš„æ ‡è®°\n&nbsp;&nbsp;&nbsp; uint32_t notused1;&nbsp;&nbsp;&nbsp; //æœªç”¨å­—æ®µ\n} clusterMsgDataGossip;\n</code></pre><p>ä»clusterMsgDataGossipæ•°æ®ç»“æ„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒé‡Œé¢åŒ…å«äº†èŠ‚ç‚¹çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚èŠ‚ç‚¹åç§°ã€IPå’Œé€šä¿¡ç«¯å£ï¼Œä»¥åŠä½¿ç”¨Pingã€Pongæ¶ˆæ¯å‘é€å’Œæ¥æ”¶æ—¶é—´æ¥è¡¨ç¤ºçš„èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€ã€‚è¿™å°±å’Œæˆ‘åˆšæ‰ç»™ä½ ä»‹ç»çš„Gossipåè®®å·¥ä½œæœºåˆ¶ä¸­çš„é€šä¿¡å†…å®¹å¯¹åº”ä¸Šäº†ã€‚</p><p></p><p>é‚£ä¹ˆï¼ŒGossipåè®®åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ä¼ æ’­çš„slotsåˆ†å¸ƒä¿¡æ¯ï¼Œä¹Ÿå·²ç»åœ¨åˆšæ‰ä»‹ç»çš„clusterMsgæ•°æ®ç»“æ„ä¸­å®šä¹‰äº†ã€‚æ‰€ä»¥ï¼Œ<strong>Redisä½¿ç”¨clusterMsgç»“æ„ä½“ä½œä¸ºèŠ‚ç‚¹é—´é€šä¿¡çš„æ¶ˆæ¯ï¼Œå°±å¯ä»¥å®ç°Gossipåè®®çš„é€šä¿¡ç›®çš„</strong>ã€‚å¦‚æœä½ è¦å¼€å‘Gossipåè®®ï¼Œå¯ä»¥å‚è€ƒè¿™é‡ŒclusterMsgã€clusterMsgDataå’ŒclusterMsgDataGossipçš„å®šä¹‰ã€‚</p><p></p><p>å¥½äº†ï¼Œäº†è§£äº†Redis Clusterä¸­èŠ‚ç‚¹é€šä¿¡çš„æ¶ˆæ¯å®šä¹‰åï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Gossipåè®®ä¸­çš„æ”¶å‘æ¶ˆæ¯å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p></p><h3>Pingæ¶ˆæ¯çš„ç”Ÿæˆå’Œå‘é€</h3><p>Gossipåè®®æ˜¯æŒ‰ä¸€å®šçš„é¢‘ç‡éšæœºé€‰ä¸€äº›èŠ‚ç‚¹è¿›è¡Œé€šä¿¡çš„ã€‚é‚£ä¹ˆåœ¨å‰é¢è¯¾ç¨‹çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒRedisçš„serverCronå‡½æ•°æ˜¯åœ¨å‘¨æœŸæ€§æ‰§è¡Œçš„ã€‚è€Œå®ƒä¼šè°ƒç”¨<strong>clusterCronå‡½æ•°</strong>ï¼ˆåœ¨cluster.cæ–‡ä»¶ä¸­ï¼‰æ¥å®ç°é›†ç¾¤çš„å‘¨æœŸæ€§æ“ä½œï¼Œè¿™å°±åŒ…æ‹¬äº†Gossipåè®®çš„é€šä¿¡ã€‚</p><pre><code class=\"language-plain\">int serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) {\n&nbsp; &nbsp;â€¦\n&nbsp; &nbsp;run_with_period(100) {\n&nbsp; &nbsp; &nbsp; //æ¯100msè°ƒç”¨ä¾æ¬¡clusterCronå‡½æ•°\n&nbsp; &nbsp; &nbsp; if (server.cluster_enabled) clusterCron();&nbsp; \n&nbsp; &nbsp;}\n&nbsp; &nbsp;â€¦\n}\n</code></pre><p>clusterCronå‡½æ•°çš„ä¸€ä¸ªä¸»è¦é€»è¾‘å°±æ˜¯æ¯ç»è¿‡10æ¬¡æ‰§è¡Œï¼Œå°±ä¼šéšæœºé€‰äº”ä¸ªèŠ‚ç‚¹ï¼Œç„¶ååœ¨è¿™äº”ä¸ªèŠ‚ç‚¹ä¸­ï¼Œé´é€‰å‡ºæœ€æ—©å‘å½“å‰èŠ‚ç‚¹å‘é€Pongæ¶ˆæ¯çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œå¹¶å‘å®ƒå‘é€Pingæ¶ˆæ¯ã€‚è€ŒclusterCronå‡½æ•°æœ¬èº«æ˜¯æ¯1ç§’æ‰§è¡Œ10æ¬¡ï¼Œæ‰€ä»¥ï¼Œè¿™ä¹Ÿç›¸å½“äºæ˜¯<strong>é›†ç¾¤èŠ‚ç‚¹æ¯1ç§’å‘ä¸€ä¸ªéšæœºèŠ‚ç‚¹å‘é€Gossipåè®®çš„Pingæ¶ˆæ¯</strong>ã€‚</p><p></p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†clusterCronå‡½æ•°çš„è¿™ä¸€æ‰§è¡Œé€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code class=\"language-plain\">void clusterCron(void) {\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; if (!(iteration % 10)) { //æ¯æ‰§è¡Œ10æ¬¡clusterCronå‡½æ•°ï¼Œæ‰§è¡Œ1æ¬¡è¯¥åˆ†æ”¯ä»£ç \n&nbsp;&nbsp; int j;\n&nbsp;&nbsp; for (j = 0; j &lt; 5; j++) { //éšæœºé€‰5ä¸ªèŠ‚ç‚¹\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de = dictGetRandomKey(server.cluster-&gt;nodes);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterNode *this = dictGetVal(de);\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //ä¸å‘æ–­è¿çš„èŠ‚ç‚¹ã€å½“å‰èŠ‚ç‚¹å’Œæ­£åœ¨æ¡æ‰‹çš„èŠ‚ç‚¹å‘é€Pingæ¶ˆæ¯\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;if (this-&gt;link == NULL || this-&gt;ping_sent != 0) continue;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this-&gt;flags &amp; (CLUSTER_NODE_MYSELF|CLUSTER_NODE_HANDSHAKE))\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;continue;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //é´é€‰å‘å½“å‰èŠ‚ç‚¹å‘é€Pongæ¶ˆæ¯æœ€æ—©çš„èŠ‚ç‚¹\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (min_pong_node == NULL || min_pong &gt; this-&gt;pong_received) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; min_pong_node = this;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; min_pong = this-&gt;pong_received;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; }\n&nbsp;&nbsp;&nbsp; //å¦‚æœé´é€‰å‡ºäº†æœ€æ—©å‘å½“å‰èŠ‚ç‚¹å‘é€Pongæ¶ˆæ¯çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè°ƒç”¨clusterSendPingå‡½æ•°å‘è¯¥èŠ‚ç‚¹å‘é€Pingæ¶ˆæ¯\n&nbsp;&nbsp;&nbsp; if (min_pong_node) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serverLog(LL_DEBUG,\"Pinging node %.40s\", min_pong_node-&gt;name);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterSendPing(min_pong_node-&gt;link, CLUSTERMSG_TYPE_PING);\n&nbsp;&nbsp;&nbsp; }\n&nbsp; }\n&nbsp; â€¦\n}\n</code></pre><p>ä»è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘é€Pingæ¶ˆæ¯çš„å‡½æ•°æ˜¯<strong>clusterSendPing</strong>ï¼Œè€Œå®é™…ä¸Šï¼ŒPingæ¶ˆæ¯ä¹Ÿæ˜¯åœ¨è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆæ„å»ºå’Œå‘é€çš„ã€‚ clusterSendPingå‡½æ•°çš„ä¸»è¦é€»è¾‘å¯ä»¥åˆ†æˆä¸‰æ­¥ï¼Œåˆ†åˆ«æ˜¯ï¼šæ„å»ºPingæ¶ˆæ¯å¤´ã€æ„å»ºPingæ¶ˆæ¯ä½“å’Œå‘é€æ¶ˆæ¯ã€‚æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‹ã€‚</p><p></p><p><strong>ç¬¬ä¸€æ­¥ï¼Œæ„å»ºPingæ¶ˆæ¯å¤´</strong></p><p></p><p>clusterSendPingå‡½æ•°ä¼šè°ƒç”¨<strong>clusterBuildMessageHdrå‡½æ•°</strong>æ¥æ„å»ºPingæ¶ˆæ¯å¤´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">if (link-&gt;node &amp;&amp; type == CLUSTERMSG_TYPE_PING)\n&nbsp;&nbsp; link-&gt;node-&gt;ping_sent = mstime(); //å¦‚æœå½“å‰æ˜¯Pingæ¶ˆæ¯ï¼Œé‚£ä¹ˆåœ¨å‘é€ç›®æ ‡èŠ‚ç‚¹çš„ç»“æ„ä¸­è®°å½•Pingæ¶ˆæ¯çš„å‘é€æ—¶é—´\nclusterBuildMessageHdr(hdr,type); //è°ƒç”¨clusterBuildMessageHdrå‡½æ•°æ„å»ºPingæ¶ˆæ¯å¤´\n</code></pre><p>åœ¨åˆšæ‰å­¦ä¹ Redis ClusterèŠ‚ç‚¹é—´é€šä¿¡æ¶ˆæ¯çš„æ•°æ®ç»“æ„æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯çš„æ•°æ®ç»“æ„æ˜¯clusterMsgï¼Œæ‰€ä»¥åœ¨è¿™é‡Œï¼ŒclusterBuildMessageHdrå‡½æ•°ä¹Ÿæ˜¯è®¾ç½®clusterMsgç»“æ„ä½“ä¸­çš„å„ä¸ªæˆå‘˜å˜é‡ï¼Œæ¯”å¦‚æ¶ˆæ¯ç±»å‹ï¼Œå‘é€æ¶ˆæ¯èŠ‚ç‚¹çš„åç§°ã€IPã€slotsåˆ†å¸ƒç­‰ä¿¡æ¯ã€‚ä½ å¯ä»¥è¿›ä¸€æ­¥ä»”ç»†é˜…è¯»clusterBuildMessageHdrå‡½æ•°çš„æºç ï¼Œäº†è§£è¿™äº›æˆå‘˜å˜é‡çš„å…·ä½“è®¾ç½®ã€‚</p><p></p><p>ä¸è¿‡ï¼ŒclusterBuildMessageHdrå‡½æ•°å¹¶ä¸ä¼šè®¾ç½®clusterMsgç»“æ„ä½“ä¸­çš„dataæˆå‘˜å˜é‡ï¼Œè¿™ä¸ªæˆå‘˜å˜é‡å°±æ˜¯åˆšæ‰æˆ‘ä»‹ç»çš„clusterMsgDataè”åˆä½“ï¼Œä¹Ÿå°±æ˜¯Pingæ¶ˆæ¯çš„æ¶ˆæ¯ä½“ã€‚å› ä¸ºåœ¨å®Œæˆæ¶ˆæ¯å¤´çš„æ„å»ºåï¼ŒclusterSendPingå‡½æ•°å°±ä¼šæ¥æ„å»ºæ¶ˆæ¯ä½“ã€‚</p><p></p><p><strong>ç¬¬äºŒæ­¥ï¼Œæ„å»ºPingæ¶ˆæ¯ä½“</strong></p><p>ä½ å¯ä»¥å†çœ‹ä¸‹clusterMsgDataçš„æ•°æ®ç»“æ„å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å½“å®ƒè¡¨ç¤ºPingã€Pongæ¶ˆæ¯æ—¶ï¼Œå…¶å®æ˜¯ä¸€ä¸ªclusterMsgDataGossipç±»å‹çš„æ•°ç»„ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªPingæ¶ˆæ¯ä¸­ä¼šåŒ…å«å¤šä¸ªclusterMsgDataGossipç»“æ„ä½“ï¼Œè€Œæ¯ä¸ªclusterMsgDataGossipç»“æ„ä½“å®é™…å¯¹åº”äº†ä¸€ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</p><p></p><pre><code class=\"language-plain\">union clusterMsgData {\n&nbsp;&nbsp;&nbsp; struct {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //å½“æ¶ˆæ¯æ˜¯Pingæˆ–Pongæ—¶ï¼Œä½¿ç”¨clusterMsgDataGossipç±»å‹çš„æ•°ç»„\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clusterMsgDataGossip gossip[1];\n\t} ping;\n\tâ€¦\n}\n</code></pre><p>æ‰€ä»¥ï¼Œå½“clusterSendPingå‡½æ•°æ„å»ºPingæ¶ˆæ¯ä½“æ—¶ï¼Œå®ƒä¼šå°†å¤šä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯å†™å…¥Pingæ¶ˆæ¯ã€‚é‚£ä¹ˆï¼Œ<strong>clusterSendPingå‡½æ•°å…·ä½“ä¼šå†™å…¥å¤šå°‘ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯å‘¢ï¼Ÿ</strong>è¿™å…¶å®æ˜¯ç”±ä¸‰ä¸ªå˜é‡æ§åˆ¶çš„ï¼Œåˆ†åˆ«æ˜¯freshnodesã€wantedå’Œmaxiterationsã€‚</p><p></p><p>å…¶ä¸­ï¼Œfreshnodesçš„å€¼ç­‰äºé›†ç¾¤èŠ‚ç‚¹æ•°å‡2ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">int freshnodes = dictSize(server.cluster-&gt;nodes)-2;\n</code></pre><p>è€Œwantedå˜é‡çš„å€¼å’Œfreshnodeså¤§å°ä¹Ÿæœ‰å…³ï¼Œwantedçš„é»˜è®¤å€¼æ˜¯é›†ç¾¤èŠ‚ç‚¹æ•°çš„1/10ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªé»˜è®¤å€¼å°äº3ï¼Œé‚£ä¹ˆwantedå°±ç­‰äº3ã€‚å¦‚æœè¿™ä¸ªé»˜è®¤å€¼å¤§äºfreshnodesï¼Œé‚£ä¹ˆwantedå°±ç­‰äºfreshnodesçš„å¤§å°ï¼Œè¿™éƒ¨åˆ†çš„è®¡ç®—é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">wanted = floor(dictSize(server.cluster-&gt;nodes)/10);\nif (wanted &lt; 3) wanted = 3;\nif (wanted &gt; freshnodes) wanted = freshnodes;\n</code></pre><p>æœ‰äº†wantedå€¼ä¹‹åï¼Œmaxiterationsçš„å€¼å°±ç­‰äºwantedçš„ä¸‰å€å¤§å°ã€‚</p><pre><code class=\"language-plain\">int maxiterations = wanted*3;\n</code></pre><p>åœ¨è®¡ç®—å®Œfreshnodesã€wantedå’Œmaxiterationsè¿™ä¸‰ä¸ªå€¼çš„å¤§å°åï¼ŒclusterSendPingä¼šæ ¹æ®è¿™ä¸‰ä¸ªå€¼çš„å¤§å°ï¼Œæ‰§è¡Œä¸€ä¸ª<strong>å¾ªç¯æµç¨‹</strong>ï¼Œåœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œå®ƒæ¯æ¬¡ä»é›†ç¾¤èŠ‚ç‚¹ä¸­éšæœºé€‰ä¸€ä¸ªèŠ‚ç‚¹å‡ºæ¥ï¼Œå¹¶è°ƒç”¨clusterSetGossipEntryå‡½æ•°ä¸ºè¿™ä¸ªèŠ‚ç‚¹è®¾ç½®ç›¸åº”çš„Pingæ¶ˆæ¯ä½“ï¼Œä¹Ÿå°±æ˜¯clusterMsgDataGossipç»“æ„ã€‚å…³äºclusterSetGossipEntryå‡½æ•°å¯¹clusterMsgDataGossipç»“æ„çš„å…·ä½“è®¾ç½®ï¼Œä½ å¯ä»¥è¿›ä¸€æ­¥çœ‹ä¸‹å®ƒçš„æºç ã€‚</p><p></p><p>å½“ç„¶ï¼Œå¦‚æœé€‰å‡ºçš„èŠ‚ç‚¹æ˜¯å½“å‰èŠ‚ç‚¹è‡ªèº«ã€å¯èƒ½æœ‰æ•…éšœçš„èŠ‚ç‚¹ã€æ­£åœ¨æ¡æ‰‹çš„èŠ‚ç‚¹ã€å¤±è”çš„èŠ‚ç‚¹ä»¥åŠæ²¡æœ‰åœ°å€ä¿¡æ¯çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆclusterSendPingæ˜¯ä¸ä¼šä¸ºè¿™äº›èŠ‚ç‚¹è®¾ç½®Pingæ¶ˆæ¯ä½“çš„ã€‚</p><p></p><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†clusterSendPingå‡½æ•°è®¾ç½®Pingæ¶ˆæ¯ä½“çš„åŸºæœ¬é€»è¾‘ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code class=\"language-plain\">while(freshnodes &gt; 0 &amp;&amp; gossipcount &lt; wanted &amp;&amp; maxiterations--) {\n&nbsp;&nbsp; dictEntry *de = dictGetRandomKey(server.cluster-&gt;nodes);\n&nbsp;&nbsp; clusterNode *this = dictGetVal(de);\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; clusterSetGossipEntry(hdr,gossipcount,this); //è°ƒç”¨clusterSetGossipEntryè®¾ç½®Pingæ¶ˆæ¯ä½“\n&nbsp;&nbsp; freshnodes--;\n&nbsp;&nbsp; gossipcount++;\n}\n</code></pre><p>è¿™é‡Œï¼Œä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹å¯èƒ½æœ‰æ•…éšœçš„èŠ‚ç‚¹ï¼ŒclusterSendPingå‡½æ•°ä¼šå°†å®ƒä»¬çš„ä¿¡æ¯æ”¾åœ¨Pingæ¶ˆæ¯ä½“çš„æœ€åã€‚</p><p></p><p><strong>ç¬¬ä¸‰æ­¥ï¼Œå‘é€Pingæ¶ˆæ¯</strong></p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼ŒPingæ¶ˆæ¯ä½“çš„æ„å»ºå°±å®Œæˆäº†ã€‚é‚£ä¹ˆï¼ŒclusterSendPingå‡½æ•°ä¸»ä½“é€»è¾‘çš„æœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨clusterSendMessageå‡½æ•°ï¼Œå°†Pingæ¶ˆæ¯å‘é€ç»™éšæœºé€‰å‡ºçš„ç›®æ ‡èŠ‚ç‚¹ã€‚è¿™æ ·ä¸€æ¥ï¼ŒGossipåè®®è¦æ±‚çš„ï¼Œå‘éšæœºé€‰å‡ºçš„èŠ‚ç‚¹å‘é€å½“å‰èŠ‚ç‚¹ä¿¡æ¯çš„æ“ä½œå°±å®Œæˆäº†ã€‚</p><p></p><p>æˆ‘ç”»äº†ä¸‹é¢çš„è¿™å¼ å›¾ï¼Œå±•ç¤ºäº†clusterSendPingå‡½æ•°çš„ä¸»ä½“é€»è¾‘ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e4/da/e4fd8037321e805027d604ee130c70da.jpg?wh=1920x1080\" alt=\"å›¾ç‰‡\"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹å½“èŠ‚ç‚¹æ”¶åˆ°Pingæ¶ˆæ¯åçš„å¤„ç†ï¼Œä¹Ÿå°±æ˜¯Pongæ¶ˆæ¯çš„å‘é€ã€‚</p><p></p><h3>Pingæ¶ˆæ¯çš„å¤„ç†å’ŒPongæ¶ˆæ¯çš„å›å¤</h3><p>åœ¨åˆšæ‰ä»‹ç»çš„clusterCronå‡½æ•°ä¸­ï¼ŒèŠ‚ç‚¹åœ¨è°ƒç”¨clusterSendPingå‡½æ•°å‘å…¶ä»–èŠ‚ç‚¹å‘é€Pingæ¶ˆæ¯å‰ï¼Œä¼šæ£€æŸ¥å®ƒå’Œå…¶ä»–èŠ‚ç‚¹è¿æ¥æƒ…å†µï¼Œå¦‚æœè¿æ¥æ–­å¼€äº†ï¼ŒèŠ‚ç‚¹ä¼šé‡æ–°å»ºç«‹è¿æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">void clusterCron(void) {\nâ€¦\ndi = dictGetSafeIterator(server.cluster-&gt;nodes);\nwhile((de = dictNext(di)) != NULL) {\n&nbsp;&nbsp; clusterNode *node = dictGetVal(de);\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; if (node-&gt;link == NULL) {\n&nbsp;&nbsp; &nbsp;â€¦\n&nbsp;&nbsp;&nbsp; fd = anetTcpNonBlockBindConnect(server.neterr, node-&gt;ip,&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node-&gt;cport, NET_FIRST_BIND_ADDR);\n\tâ€¦\n\tlink = createClusterLink(node);\n\tlink-&gt;fd = fd;\n\tnode-&gt;link = link;\n\taeCreateFileEvent(server.el,link-&gt;fd,AE_READABLE, clusterReadHandler,link);\n\tâ€¦\n\t}\n\tâ€¦\n}\nâ€¦\n}\n</code></pre><p>ä»ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªèŠ‚ç‚¹åœ¨å’Œå…¶ä»–èŠ‚ç‚¹å»ºç«‹çš„è¿æ¥ä¸Šï¼Œè®¾ç½®çš„<strong>ç›‘å¬å‡½æ•°æ˜¯clusterReadHandler</strong>ã€‚æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°Pingæ¶ˆæ¯æ—¶ï¼Œå®ƒå°±ä¼šåœ¨clusterReadHandlerå‡½æ•°ä¸­è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p><p>clusterReadHandlerå‡½æ•°æ‰§è¡Œä¸€ä¸ªwhile(1)å¾ªç¯ï¼Œå¹¶åœ¨è¿™ä¸ªå¾ªç¯ä¸­è¯»å–æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå½“è¯»åˆ°ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯åï¼Œå®ƒä¼šè°ƒç”¨<strong>clusterProcessPacketå‡½æ•°</strong>å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">void clusterReadHandler(aeEventLoop *el, int fd, void *privdata, int mask) {\nâ€¦\nwhile(1) { //æŒç»­è¯»å–æ”¶åˆ°çš„æ•°æ®\n&nbsp;&nbsp; rcvbuflen = sdslen(link-&gt;rcvbuf);\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; nread = read(fd,buf,readlen); //è¯»å–æ”¶åˆ°çš„æ•°æ®\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; //è¯»å–åˆ°ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯\n&nbsp;&nbsp; if (rcvbuflen &gt;= 8 &amp;&amp; rcvbuflen == ntohl(hdr-&gt;totlen)) {\n&nbsp;&nbsp; if (clusterProcessPacket(link)) { â€¦} //è°ƒç”¨clusterProcessPacketå‡½æ•°å¤„ç†æ¶ˆæ¯\n&nbsp;&nbsp; â€¦\n}\n}\n</code></pre><p>å› ä¸ºèŠ‚ç‚¹é—´å‘é€çš„æ¶ˆæ¯ç±»å‹ä¸æ­¢Pingæ¶ˆæ¯ï¼Œæ‰€ä»¥clusterProcessPacketå‡½æ•°ä¼šå…ˆä»æ”¶åˆ°çš„æ¶ˆæ¯å¤´ä¸­è¯»å–æ¶ˆæ¯ç±»å‹ï¼Œç„¶åæ ¹æ®ä¸åŒçš„æ¶ˆæ¯ç±»å‹ï¼Œæ‰§è¡Œä¸åŒçš„ä»£ç åˆ†æ”¯ã€‚</p><p></p><p>å½“æ”¶åˆ°çš„æ˜¯Pingæ¶ˆæ¯æ—¶ï¼ŒclusterProcessPacketå‡½æ•°ä¼šå…ˆè°ƒç”¨clusterSendPingå‡½æ•°ï¼Œå‘Pingæ¶ˆæ¯å‘é€èŠ‚ç‚¹è¿”å›Pongæ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=\"language-plain\">int clusterProcessPacket(clusterLink *link) {\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; if (type == CLUSTERMSG_TYPE_PING || type == CLUSTERMSG_TYPE_MEET) {\n&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;â€¦ //å¤„ç†Meetæ¶ˆæ¯ï¼Œå°†å‘é€Meetæ¶ˆæ¯çš„èŠ‚ç‚¹åŠ å…¥æœ¬åœ°è®°å½•çš„èŠ‚ç‚¹åˆ—è¡¨ä¸­\n&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;clusterSendPing(link,CLUSTERMSG_TYPE_PONG); //è°ƒç”¨clusterSendPingå‡½æ•°è¿”å›Pongæ¶ˆæ¯ã€‚\n&nbsp;&nbsp; }\n&nbsp;&nbsp; â€¦\n}\n</code></pre><p>ä»è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°ï¼Œ<strong>Pingå’ŒPongæ¶ˆæ¯ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªå‡½æ•°clusterSendPingæ¥ç”Ÿæˆå’Œå‘é€çš„ï¼Œæ‰€ä»¥å®ƒä»¬åŒ…å«çš„å†…å®¹ä¹Ÿæ˜¯ç›¸åŒçš„</strong>ã€‚è¿™ä¹Ÿå°±æ˜¯è¯´ï¼ŒPongæ¶ˆæ¯ä¸­ä¹ŸåŒ…å«äº†Pongæ¶ˆæ¯å‘é€èŠ‚ç‚¹çš„ä¿¡æ¯å’Œå®ƒå·²çŸ¥çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯ã€‚å› æ­¤ï¼ŒPingæ¶ˆæ¯çš„å‘é€èŠ‚ç‚¹ä»Pongæ¶ˆæ¯ä¸­ï¼Œä¹Ÿèƒ½è·å–å…¶ä»–èŠ‚ç‚¹çš„æœ€æ–°ä¿¡æ¯ï¼Œè¿™å°±èƒ½å®ç°Gossipåè®®é€šè¿‡å¤šè½®æ¶ˆæ¯ä¼ æ’­ï¼Œè¾¾åˆ°æ¯ä¸ªèŠ‚ç‚¹æ‹¥æœ‰ä¸€è‡´ä¿¡æ¯çš„ç›®çš„ã€‚</p><p>è¿™é‡Œï¼Œä½ è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºæ˜¯Pingæ¶ˆæ¯çš„ç›®æ ‡èŠ‚ç‚¹æ”¶åˆ°Pingæ¶ˆæ¯ï¼Œè¿˜æ˜¯å‘é€Pingæ¶ˆæ¯çš„èŠ‚ç‚¹æ”¶åˆ°ç›®æ ‡èŠ‚ç‚¹è¿”å›çš„Pongæ¶ˆæ¯ï¼Œå®ƒä»¬éƒ½ä¼š<strong>åœ¨clusterProcessPacketå‡½æ•°çš„åŒä¸€ä¸ªä»£ç åˆ†æ”¯ä¸­è¿›è¡Œå¤„ç†</strong>ï¼Œæ¯”å¦‚æ›´æ–°æœ€æ–°Pongæ¶ˆæ¯çš„è¿”å›æ—¶é—´ï¼Œæ ¹æ®æ¶ˆæ¯å¤´ä¸­çš„slotsåˆ†å¸ƒä¿¡æ¯æ›´æ–°æœ¬åœ°çš„slotsä¿¡æ¯ã€‚æ­¤å¤–ï¼ŒclusterProcessPacketå‡½æ•°è¿˜ä¼šè°ƒç”¨<strong>clusterProcessGossipSectionå‡½æ•°</strong>ï¼Œä¾æ¬¡å¤„ç†Ping-Pongæ¶ˆæ¯ä¸­åŒ…å«çš„å¤šä¸ªæ¶ˆæ¯ä½“ã€‚</p><p></p><p>è¿™æ ·ä¸€æ¥ï¼Œæ”¶åˆ°Pingæˆ–Pongæ¶ˆæ¯çš„èŠ‚ç‚¹ï¼Œå°±å¯ä»¥æ ¹æ®æ¶ˆæ¯ä½“ä¸­çš„ä¿¡æ¯ï¼Œæ›´æ–°æœ¬åœ°è®°å½•çš„å¯¹åº”èŠ‚ç‚¹çš„ä¿¡æ¯äº†ã€‚ä½ å¯ä»¥è¿›ä¸€æ­¥é˜…è¯»clusterProcessGossipSectionå‡½æ•°æºç ï¼Œäº†è§£å®ƒæ ¹æ®æ¶ˆæ¯ä½“å†…å®¹å¯¹æœ¬åœ°è®°å½•çš„èŠ‚ç‚¹ä¿¡æ¯çš„æ›´æ–°è®¾ç½®ã€‚</p><p></p><p>ä¸‹é¢çš„ä»£ç å°±å±•ç¤ºäº†èŠ‚ç‚¹æ”¶åˆ°Ping-Pongæ¶ˆæ¯åï¼Œå¯¹æœ¬åœ°ä¿¡æ¯è¿›è¡Œæ›´æ–°çš„ä»£ç åˆ†æ”¯ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code class=\"language-plain\">int clusterProcessPacket(clusterLink *link) {\n&nbsp;&nbsp; â€¦\n&nbsp;&nbsp; if (type == CLUSTERMSG_TYPE_PING || type == CLUSTERMSG_TYPE_PONG ||\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type == CLUSTERMSG_TYPE_MEET)\n\t{\n\t&nbsp;&nbsp; â€¦\n\t&nbsp;&nbsp; //å½“æ”¶åˆ°Pongæ¶ˆæ¯æ—¶ï¼Œæ›´æ–°æœ¬åœ°è®°å½•çš„ç›®æ ‡èŠ‚ç‚¹Pongæ¶ˆæ¯æœ€æ–°è¿”å›æ—¶é—´\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (link-&gt;node &amp;&amp; type == CLUSTERMSG_TYPE_PONG) {\n&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;link-&gt;node-&gt;pong_received = mstime();\n&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â€¦\n\t}\n\tâ€¦//å¦‚æœå‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹æ˜¯ä¸»èŠ‚ç‚¹ï¼Œæ›´æ–°æœ¬åœ°è®°å½•çš„slotsåˆ†å¸ƒä¿¡æ¯\n\t//è°ƒç”¨clusterProcessGossipSectionå‡½æ•°å¤„ç†Pingæˆ–Pongæ¶ˆæ¯çš„æ¶ˆæ¯ä½“\n\tif (sender) clusterProcessGossipSection(hdr,link);\n\t}\n\tâ€¦\n}\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±äº†è§£äº†æŒ‰ç…§Gossipåè®®å‘é€çš„Pingã€Pongæ¶ˆæ¯çš„æ•´ä½“å¤„ç†è¿‡ç¨‹ã€‚ä»ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†Rediså®ç°Gossipåè®®ç”¨åˆ°çš„æ•°æ®ç»“æ„å’Œä¸»è¦å‡½æ•°ï¼Œæˆ‘ç”»äº†ä¸¤å¼ è¡¨ï¼Œåˆ†åˆ«æ±‡æ€»äº†åˆšæ‰ä»‹ç»çš„æ•°æ®ç»“æ„å’Œå‡½æ•°ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸‹ã€‚</p><p></p><p><img src=\"https://static001.geekbang.org/resource/image/98/4b/9828680d9e8fe70c3af6e7b02484304b.jpg?wh=1920x778\" alt=\"å›¾ç‰‡\"><img src=\"https://static001.geekbang.org/resource/image/eb/20/ebfa014888404b1a0f087a43e0e61820.jpg?wh=1920x1080\" alt=\"å›¾ç‰‡\"></p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ç»™ä½ ä»‹ç»äº†Redis Clusterä½¿ç”¨çš„Gossipåè®®çš„è®¾è®¡å’Œå®ç°ã€‚Gossipåè®®å®ç°çš„å…³é”®æœ‰ä¸¤ä¸ªï¼Œ<strong>ä¸€ä¸ªæ˜¯è¦é€šè¿‡Ping-Pongæ¶ˆæ¯å‘é€èŠ‚ç‚¹è‡ªèº«çš„ä¿¡æ¯ï¼Œä»¥åŠèŠ‚ç‚¹å·²çŸ¥çš„å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯</strong>ã€‚é’ˆå¯¹è¿™ä¸€ç‚¹ï¼ŒRedisæ˜¯è®¾è®¡äº†clusterMsgç»“æ„çš„æ¶ˆæ¯ï¼Œå…¶ä¸­æ¶ˆæ¯å¤´åŒ…å«äº†å‘é€æ¶ˆæ¯èŠ‚ç‚¹è‡ªèº«çš„ä¿¡æ¯ï¼Œæ¯”å¦‚åç§°ã€IPã€ç«¯å£å·ã€slotsåˆ†å¸ƒç­‰ã€‚</p><p>è€ŒclusterMsgç»“æ„ä¸­çš„æ¶ˆæ¯ä½“ï¼Œæ˜¯è®¾è®¡ä½¿ç”¨äº†<strong>clusterMsgDataGossip</strong>ç±»å‹çš„æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„çš„æ¯ä¸€ä¸ªå…ƒç´ å¯¹åº”äº†å‘é€æ¶ˆæ¯èŠ‚ç‚¹å·²çŸ¥çš„ä¸€ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ã€‚è¿™æ ·ä¸€æ¥ï¼Œå‘é€æ¶ˆæ¯èŠ‚ç‚¹é€šè¿‡Pingæ¶ˆæ¯å¯ä»¥æŠŠè‡ªå·±çš„ä¿¡æ¯å’Œå·²çŸ¥çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯ä¼ æ’­å‡ºå»ã€‚</p><p>åŒæ ·çš„ï¼Œæ”¶åˆ°Pingæ¶ˆæ¯çš„èŠ‚ç‚¹ï¼Œä¹Ÿä¼šä½¿ç”¨åŒæ ·ç»“æ„çš„Pongæ¶ˆæ¯å°†è‡ªå·±çš„ä¿¡æ¯å’Œå®ƒå·²çŸ¥çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯è¿”å›ç»™å‘é€èŠ‚ç‚¹ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±èƒ½å®ç°Gossipåè®®çš„è¦æ±‚ã€‚</p><p></p><p><strong>Gossipåè®®å®ç°çš„å¦ä¸€ä¸ªå…³é”®å°±æ˜¯è¦éšæœºé€‰æ‹©èŠ‚ç‚¹å‘é€</strong>ï¼Œè¿™ä¸€ç‚¹ï¼ŒRedis Clusteråœ¨æºç ä¸­å°±æ¯”è¾ƒå®¹æ˜“å®ç°äº†ã€‚å…¶å®ï¼Œå°±æ˜¯clusterCronå‡½æ•°å…ˆé€šè¿‡éšæœºé€‰æ‹©äº”ä¸ªèŠ‚ç‚¹ï¼Œç„¶åï¼Œå†åœ¨å…¶ä¸­æŒ‘é€‰å’Œå½“å‰èŠ‚ç‚¹æœ€é•¿æ—¶é—´æ²¡æœ‰å‘é€Pongæ¶ˆæ¯çš„èŠ‚ç‚¹ï¼Œä½œä¸ºç›®æ ‡èŠ‚ç‚¹ï¼Œè¿™æ ·ä¸€æ¥ï¼Œä¹Ÿæ»¡è¶³äº†Gossipåè®®çš„è¦æ±‚ã€‚</p><p></p><p>é€šè¿‡ä»Šå¤©è¿™èŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½äº†è§£Redis Clusterè®¾è®¡çš„æ¶ˆæ¯ç»“æ„ã€å‘¨æœŸå‘é€Pingå’ŒPongæ¶ˆæ¯çš„æ•´ä½“æ‰§è¡Œé€»è¾‘ã€‚è¿™äº›éƒ½æ˜¯ä½ å¯ä»¥ç”¨åœ¨è‡ªè¡Œå¼€å‘Gossipåè®®æ—¶çš„ç»å…¸å‚è€ƒè®¾è®¡ã€‚</p><p></p><p></p><h2>æ¯è¯¾ä¸€é—®</h2><p>åœ¨ä»Šå¤©è¯¾ç¨‹ä»‹ç»çš„æºç ä¸­ï¼Œä½ çŸ¥é“ä¸ºä»€ä¹ˆclusterSendPingå‡½æ•°è®¡ç®—wantedå€¼æ—¶ï¼Œæ˜¯ç”¨çš„é›†ç¾¤èŠ‚ç‚¹ä¸ªæ•°çš„ååˆ†ä¹‹ä¸€å—ï¼Ÿ</p>","comments":[{"had_liked":false,"id":315299,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1633793316,"is_pvip":true,"discussion_count":2,"race_medal":0,"score":"70353270052","product_id":100084301,"comment_content":"1ã€å¤šä¸ªèŠ‚ç‚¹ç»„æˆä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå®ƒä»¬ä¹‹é—´éœ€è¦äº¤æ¢æ•°æ®ï¼Œå¯ä»¥é‡‡ç”¨ä¸­å¿ƒåŒ–çš„æ–¹å¼ï¼ˆä¾èµ–ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä¾‹å¦‚ZKï¼‰ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨éä¸­å¿ƒåŒ–ï¼ˆåˆ†å¸ƒå¼åè®®ï¼Œä¾‹å¦‚ Gossipï¼‰çš„æ–¹å¼<br><br>2ã€Redis Cluster é‡‡ç”¨éä¸­å¿ƒåŒ–çš„æ–¹å¼ Gossip åè®®ï¼Œå®ç°å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ä¿¡æ¯äº¤æ¢<br><br>3ã€é›†ç¾¤ä¸­çš„æ¯ä¸ªå®ä¾‹ï¼Œä¼šæŒ‰ç…§å›ºå®šé¢‘ç‡ï¼Œä»é›†ç¾¤ä¸­ã€Œéšæœºã€æŒ‘é€‰éƒ¨åˆ†å®ä¾‹ï¼Œå‘é€ PING æ¶ˆæ¯ï¼ˆè‡ªèº«å®ä¾‹çŠ¶æ€ã€å·²çŸ¥éƒ¨åˆ†å®ä¾‹ä¿¡æ¯ã€slots åˆ†å¸ƒï¼‰ï¼Œç”¨æ¥äº¤æ¢å½¼æ­¤çŠ¶æ€ä¿¡æ¯<br><br>4ã€æ”¶åˆ° PING çš„å®ä¾‹ï¼Œä¼šå“åº” PONG æ¶ˆæ¯ï¼ŒPONG æ¶ˆæ¯å’Œ PING æ¶ˆæ¯æ ¼å¼ä¸€æ ·ï¼ŒåŒ…å«äº†è‡ªèº«å®ä¾‹çŠ¶æ€ã€å·²çŸ¥éƒ¨åˆ†å®ä¾‹ä¿¡æ¯ã€slots åˆ†å¸ƒ<br><br>5ã€è¿™æ ·ç»è¿‡å‡ æ¬¡äº¤æ¢åï¼Œé›†ç¾¤ä¸­æ¯ä¸ªå®ä¾‹éƒ½èƒ½æ‹¿åˆ°å…¶å®ƒå®ä¾‹çš„çŠ¶æ€ä¿¡æ¯<br><br>6ã€å³ä½¿æœ‰èŠ‚ç‚¹çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆæ–°å®ä¾‹åŠ å…¥ã€èŠ‚ç‚¹æ•…éšœã€æ•°æ®è¿ç§»ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Gossip åè®®çš„ PING-PONG æ¶ˆæ¯å®Œæˆæ•´ä¸ªé›†ç¾¤çŠ¶æ€åœ¨æ¯ä¸ªå®ä¾‹ä¸Šçš„åŒæ­¥<br><br>è¯¾åé¢˜ï¼šä¸ºä»€ä¹ˆ clusterSendPing å‡½æ•°è®¡ç®— wanted å€¼æ—¶ï¼Œæ˜¯ç”¨çš„é›†ç¾¤èŠ‚ç‚¹ä¸ªæ•°çš„ååˆ†ä¹‹ä¸€ï¼Ÿ<br><br>è¿™ä¸ªå’Œ Redis Cluster åˆ¤å®šå®ä¾‹ã€Œæ•…éšœã€é€»è¾‘æœ‰å…³äº†ã€‚<br><br>Redis Cluster å®ä¾‹åœ¨å‘¨æœŸæ€§å‘å…¶å®ƒå®ä¾‹äº¤æ¢ä¿¡æ¯æ—¶ï¼Œä¼šå…ˆéšæœºé€‰å‡º 5 ä¸ªå®ä¾‹ï¼Œç„¶åä»ä¸­æ‰¾å‡ºæœ€ä¹…æ²¡é€šä¿¡è¿‡çš„å®ä¾‹ï¼Œå‘é€ PING æ¶ˆæ¯ã€‚<br><br>ä½†è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œéšæœºé€‰å‡ºçš„è¿™ 5 ä¸ªå®ä¾‹ï¼Œæœ‰å¯èƒ½å¹¶ä¸æ˜¯æ•´ä¸ªã€Œé›†ç¾¤ã€ä¸­æœ€ä¹…æ²¡é€šä¿¡è¿‡çš„ï¼Œä¸ºäº†é¿å…æ‹¿ä¸åˆ°è¿™äº›å®ä¾‹çš„çŠ¶æ€ï¼Œå¯¼è‡´é›†ç¾¤è¯¯ä»¥ä¸ºè¿™äº›å®ä¾‹å·²è¿‡æœŸï¼Œæ‰€ä»¥åˆ¶å®šäº†ä¸€ä¸ªç­–ç•¥ï¼šå¦‚æœå’Œå®ä¾‹æœ€è¿‘é€šä¿¡æ—¶é—´è¶…è¿‡äº† cluster-node-timeout &#47; 2ï¼Œé‚£ä¼šç«‹å³å‘è¿™ä¸ªå®ä¾‹å‘é€ PING æ¶ˆæ¯ã€‚<br><br>æ¯æ¬¡ PING éƒ½ä¼šæ”¶åˆ° PONG å“åº”ï¼Œä¸€æ¥ä¸€å› 2 æ¬¡å¿ƒè·³åŒ…ï¼Œæ¥å›éƒ½å¸¦æœ‰éƒ¨åˆ†å®ä¾‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£åœ¨ cluster-node-timeout æ—¶é—´å†…ä¼šæ”¶åˆ° 4 æ¬¡å¿ƒè·³åŒ…ã€‚<br><br>åˆå› ä¸º Redis Cluster è®¡ç®—æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´æ˜¯ cluster-node-timeout * 2ï¼Œé‚£è¿™æ®µæ—¶é—´å†…å°±èƒ½æ”¶åˆ° 8 ä¸ª PING + PONG å¿ƒè·³åŒ…ï¼Œæ¯ä¸ªå¿ƒè·³åŒ…ä¸­å®ä¾‹ä¸ªæ•°è®¾ç½®ä¸ºé›†ç¾¤çš„ 1&#47;10ï¼Œé‚£åœ¨æ•…éšœè½¬ç§»æœŸé—´å°±èƒ½æ”¶åˆ°é›†ç¾¤ 80%ï¼ˆ8 * 1&#47;10ï¼‰èŠ‚ç‚¹å‘æ¥çš„æ•…éšœçŠ¶æ€ä¿¡æ¯äº†ï¼Œæ»¡è¶³é›†ç¾¤å¤§éƒ¨åˆ†èŠ‚ç‚¹å‘æ¥çš„èŠ‚ç‚¹æ•…éšœæƒ…å†µã€‚","like_count":17,"discussions":[{"author":{"id":1399058,"avatar":"https://static001.geekbang.org/account/avatar/00/15/59/12/49458cb3.jpg","nickname":"ğŸ™„","note":"","ucode":"294786B5F39F8E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404407,"discussion_content":"åˆšæ‰åˆšäº†ä¸‹githubçš„æäº¤è®°å½•ï¼Œå¼„æ¸…æ¥šäº†ï¼Œç°åœ¨çš„1/10å¥½åƒæ˜¯ä½œç”¨ä¸å¤§äº†ï¼Œå› ä¸º4.0ä¹‹åæ— è®ºå¦‚ä½•éƒ½ä¼šæŠŠå½“å‰nodeè®¤ä¸ºPFAILçš„å®ä¾‹æ”¾åˆ°æ¶ˆæ¯ä½“é‡Œé¢äº†ï¼Œå¤§ä½¬æœ‰ç©ºçœ‹ä¸‹ï¼Œçœ‹æˆ‘æœ‰æ²¡æœ‰ç†è§£é”™ã€‚ğŸ™\n\nhttps://github.com/redis/redis/commit/1e659a04cf19e4349c8dbba931d1606336970b8c#diff-55c2de0fa49d05f6ed8f0c13cacedc85fba5d5739c8360567743f9f740df3179\n\n/* If there are PFAIL nodes, add them at the end. */\n    if (pfail_wanted) {\n        dictIterator *di;\n        dictEntry *de;\n\n        di = dictGetSafeIterator(server.cluster->nodes);\n        while((de = dictNext(di)) != NULL &amp;&amp; pfail_wanted > 0) {\n            clusterNode *node = dictGetVal(de);\n            if (node->flags &amp; CLUSTER_NODE_HANDSHAKE) continue;\n            if (node->flags &amp; CLUSTER_NODE_NOADDR) continue;\n            if (!(node->flags &amp; CLUSTER_NODE_PFAIL)) continue;\n            clusterSetGossipEntry(hdr,gossipcount,node);\n            freshnodes--;\n            gossipcount++;\n            /* We take the count of the slots we allocated, since the\n             * PFAIL stats may not match perfectly with the current number\n             * of PFAIL nodes. */\n            pfail_wanted--;\n        }\n        dictReleaseIterator(di);\n    }","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634301833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1399058,"avatar":"https://static001.geekbang.org/account/avatar/00/15/59/12/49458cb3.jpg","nickname":"ğŸ™„","note":"","ucode":"294786B5F39F8E","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":404323,"discussion_content":"å¤§ä½¬ä½ å¥½ï¼Œæˆ‘çœ‹redisæºç ä¹Ÿæ˜¯è¿™ä¹ˆè§£é‡Šçš„ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆç–‘æƒ‘ã€‚\n\næ¯ä¸ªèŠ‚ç‚¹ï¼Œåœ¨cluster-node-timeout/2 å†…éƒ½èƒ½æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘è¿‡æ¥çš„PINGåŒ…ï¼Œæ¯ä¸ªPINGåŒ…çš„æ¶ˆæ¯ä½“éƒ½ä¼šåŒ…å«å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰æ•…éšœèŠ‚ç‚¹ï¼Œé‚£ä¸å°±ä»£è¡¨æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½å¤Ÿæ”¶åˆ°æ‰€æœ‰èŠ‚ç‚¹å‘è¿‡æ¥çš„èŠ‚ç‚¹æ•…éšœæƒ…å†µå—ï¼Ÿ ä¸ºå•¥è¿˜éœ€è¦è¿™ä¸ª1/10å•Šï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1634287198,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":316429,"user_name":"ğŸ™„","can_delete":false,"product_type":"c1","uid":1399058,"ip_address":"","ucode":"294786B5F39F8E","user_header":"https://static001.geekbang.org/account/avatar/00/15/59/12/49458cb3.jpg","comment_is_top":false,"comment_ctime":1634301728,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5929269024","product_id":100084301,"comment_content":"å…³äºPINGæ¶ˆæ¯ ç”¨çš„é›†ç¾¤èŠ‚ç‚¹ä¸ªæ•°çš„ååˆ†ä¹‹ä¸€ä½œä¸ºwantedå€¼å¦‚è¯¾ä»£è¡¨æ‰€è¯´ï¼Œä½†æ˜¯åœ¨æˆ‘é˜…è¯»æºç çš„æ—¶å€™å‘ç°ï¼ŒPINGæ¶ˆæ¯æ˜¯å…ˆæŠŠwantedæ•°é‡çš„å®ä¾‹æ”¾åˆ°æ¶ˆæ¯ä½“ï¼Œç„¶åå†æŠŠæ‰€æœ‰å½“å‰nodesè®¤ä¸ºæ˜¯PFAILçš„å®ä¾‹æ”¾åˆ°æ¶ˆæ¯ä½“æœ«å°¾ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ–°ç‰ˆçš„rediså®ä¾‹åŠ é€Ÿäº† PFAIL-&gt;FAILçš„åˆ¤æ–­ï¼Œè·Ÿååˆ†ä¹‹ä¸€çš„å…³ç³»å·²ç»ä¸å¤§äº†ã€‚<br><br>PS: å½“æ—¶çœ‹è¿™æ®µä»£ç çš„æ—¶å€™éå¸¸ç–‘æƒ‘ï¼Œçœ‹æºç çš„æ³¨é‡Šä¹Ÿå¾ˆç–‘æƒ‘...ç›´åˆ°ç¿»é˜…githubä¸Šé¢çš„æäº¤è®°å½•<br><br>https:&#47;&#47;github.com&#47;redis&#47;redis&#47;commit&#47;1e659a04cf19e4349c8dbba931d1606336970b8c#diff-55c2de0fa49d05f6ed8f0c13cacedc85fba5d5739c8360567743f9f740df3179<br><br><br>&#47;* If there are PFAIL nodes, add them at the end. *&#47;<br>    if (pfail_wanted) {<br>        dictIterator *di;<br>        dictEntry *de;<br><br>        di = dictGetSafeIterator(server.cluster-&gt;nodes);<br>        while((de = dictNext(di)) != NULL &amp;&amp; pfail_wanted &gt; 0) {<br>            clusterNode *node = dictGetVal(de);<br>            if (node-&gt;flags &amp; CLUSTER_NODE_HANDSHAKE) continue;<br>            if (node-&gt;flags &amp; CLUSTER_NODE_NOADDR) continue;<br>            if (!(node-&gt;flags &amp; CLUSTER_NODE_PFAIL)) continue;<br>            clusterSetGossipEntry(hdr,gossipcount,node);<br>            freshnodes--;<br>            gossipcount++;<br>            &#47;* We take the count of the slots we allocated, since the<br>             * PFAIL stats may not match perfectly with the current number<br>             * of PFAIL nodes. *&#47;<br>            pfail_wanted--;<br>        }<br>        dictReleaseIterator(di);<br>    }","like_count":1},{"had_liked":false,"id":343587,"user_name":"è¾¹é™…é©å‘½","can_delete":false,"product_type":"c1","uid":1124665,"ip_address":"","ucode":"EC15C0AE4D487A","user_header":"https://static001.geekbang.org/account/avatar/00/11/29/39/be9d2e88.jpg","comment_is_top":false,"comment_ctime":1650942449,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1650942449","product_id":100084301,"comment_content":"ä¸»ä»å¦‚ä½•åšæ•…éšœåˆ‡æ¢çš„ ä¸è®²ä¸€ä¸‹å—ï¼Ÿ","like_count":0},{"had_liked":false,"id":339541,"user_name":"neohope","can_delete":false,"product_type":"c1","uid":1043475,"ip_address":"","ucode":"C0268F6E7E2B6E","user_header":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","comment_is_top":false,"comment_ctime":1648177350,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648177350","product_id":100084301,"comment_content":"ä¸ºä½•é€‰æ‹©äº†1&#47;10çš„èŠ‚ç‚¹ï¼Œåœ¨æºç æ³¨é‡Šé‡Œå…¶å®å°±æœ‰ï¼Œåˆ†ä¸¤éƒ¨åˆ†è§£é‡Šä¸€ä¸‹ï¼š<br><br>ä¸€ã€åœ¨clusterCronå‡½æ•°ä¸­ï¼Œæœ‰ä¸€ä¸ªå¼ºåˆ¶PINGç­–ç•¥ï¼š<br>å¦‚æœèŠ‚ç‚¹Aå’ŒèŠ‚ç‚¹Bæœ€åé€šä¿¡æ—¶é—´è¶…è¿‡äº† cluster-node-timeout&#47;2ï¼ŒèŠ‚ç‚¹Aä¼šç«‹å³å‘èŠ‚ç‚¹Bå‘é€ PING æ¶ˆæ¯ã€‚æ‰€ä»¥ï¼Œåœ¨åœ¨cluster-node-timeoutæ—¶é—´å†…ï¼ŒèŠ‚ç‚¹Aå’ŒèŠ‚ç‚¹Bæœ€å°‘ä¹Ÿä¼šæ”¶å‘2æ¥2å›å…±4æ¬¡å¿ƒè·³åŒ…ã€‚<br>Redis Clusterè®¡ç®—æ•…éšœè½¬ç§»ç¡®è®¤æ—¶é—´æ˜¯cluster-node-timeout*2ï¼Œé‚£è¿™æ®µæ—¶é—´å†…èŠ‚ç‚¹Aå’ŒèŠ‚ç‚¹Bæœ€å°‘ä¼šæ”¶å‘4æ¥4å›å…±8ä¸ªå¿ƒè·³åŒ…ã€‚<br><br>äºŒã€åœ¨ä¸€ä¸ª100ä¸ªå…¨masterèŠ‚ç‚¹çš„é›†ç¾¤ä¸­ï¼Œæœ‰ä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹Aï¼Œä¸€ä¸ªè¢«Aåˆ¤æ–­ä¸ºPFAILèŠ‚ç‚¹Cï¼Œåœ¨æ²¡æœ‰pfail_wantedçš„æ—¶å€™ï¼š<br>å¯¹äºèŠ‚ç‚¹Aï¼Œåœ¨cluster-node-timeout*2çš„æ•…éšœè½¬ç§»ç¡®è®¤æ—¶é—´å†…ï¼Œæœ€å°‘ä¹Ÿå¯ä»¥ä¸ä»–èŠ‚ç‚¹äº¤æ¢å…³äºCèŠ‚ç‚¹åˆ°è¿™ä¹ˆå¤šä¸ªåŒ…ï¼š<br>PROB * GOSSIP_ENTRIES_PER_PACKET * TOTAL_PACKETS<br>(èŠ‚ç‚¹Cè¢«åŒ…å«åœ¨ä¸€ä¸ªentryä¸­çš„å‡ ç‡ï¼Œ100é€‰1ï¼Œä¹Ÿå°±æ˜¯1%)*(ä¸€ä¸ªGOSSIPåŒ…ä¸­çš„entryæ•°é‡ï¼Œ10åˆ†ä¹‹1ï¼Œ100ä¸ªèŠ‚ç‚¹ç½‘ç»œä¸­æ˜¯10)*ï¼ˆå…¶ä»–èŠ‚ç‚¹ä¸Aäº¤æ¢çš„æœ€å°æ€»åŒ…æ•°ï¼ŒèŠ‚ç‚¹æ•°*8ï¼‰<br>1%*10*(100*8)=80<br>ç”±äºè¿™äº›åŒ…éƒ½æ˜¯éšæœºé€‰æ‹©entryçš„ï¼ŒèŠ‚ç‚¹Aæ”¶å‘çš„è¿™80ä¸ªåŒ…å«CèŠ‚ç‚¹ä¿¡æ¯çš„åŒ…ï¼Œä¹Ÿå°±æ˜¯ä¸Aäº¤æ¢è¿‡CèŠ‚ç‚¹ä¿¡æ¯çš„èŠ‚ç‚¹ä¹Ÿå·®ä¸å¤šä¸º80ä¸ªï¼Œå¤§æ¦‚ç‡è¦†ç›–äº†100ä¸ªèŠ‚ç‚¹çš„å¤šæ•°èŠ‚ç‚¹ï¼Œä¹Ÿå°±å¯ä»¥ç¡®å®è¯æ˜äº†Cç‚¹æœ‰é—®é¢˜äº†ã€‚<br><br>ä¸ºä½•ä¸å†é«˜ä¸€äº›ï¼šç°åœ¨è¿™ä¸ªæ¯”ä¾‹å·²ç»å¤Ÿé«˜äº†ï¼Œå¦‚æœå†é«˜ä¸€äº›ï¼Œåªä¼šå¢åŠ ç½‘ç»œè´Ÿæ‹…è€Œå·²ã€‚è€Œä¸”ï¼Œæ”¶å‘8ä¸ªåŒ…å·²ç»æ˜¯æœ€å·®æƒ…å†µäº†ï¼Œå¹³æ—¶æ¯”8ä¸ªåŒ…è¿˜ä¼šå¤šä¸€äº›ã€‚ <br>åŒæ—¶ï¼Œåœ¨4.xçš„æºç ä¸­ï¼Œå·²ç»è¡¥å……äº†pfail_wantedçš„ä»£ç ï¼Œä¼šè®©PFAILèŠ‚ç‚¹æ›´å¿«çš„ä¼ æ’­ã€‚<br><br>ä¸ºä½•ä¸å†ä½ä¸€äº›ï¼šåœ¨æ­£å¸¸çš„redis clusteré›†ç¾¤ä¸­ï¼Œæœ‰ä¸€äº›slaveèŠ‚ç‚¹ï¼Œä¸ä¼šå‚ä¸æŠ•ç¥¨ï¼Œæ‰€ä»¥ä¿æŒäº†è¿™æ ·ä¸€ä¸ªæ¯”ä¾‹ã€‚<br><br>æ­¤å¤–ï¼Œè¿™é‡Œå°±æ˜¯ä¸ªä¼°ç®—ï¼Œåˆ«çº ç»“ä¸ºä½•ç”¨100ä¸ç”¨99æˆ–98ä»€ä¹ˆçš„ï¼Œä¸å½±å“ç»“è®ºã€‚ä¹Ÿä¸ç”¨çº ç»“è¿™80ä¸ªåŒ…ï¼Œå¦‚æœæ”¶å‘å…¨éƒ¨é‡å ï¼Œä¸å°±åªæœ‰40ä¸ªèŠ‚ç‚¹äº¤æ¢ä¿¡æ¯å—ï¼Œä¼°ç®—æ—¶ä¸è¦è€ƒè™‘å°æ¦‚ç‡æ—¶é—´ã€‚","like_count":0},{"had_liked":false,"id":334538,"user_name":"OAuth","can_delete":false,"product_type":"c1","uid":1234664,"ip_address":"","ucode":"691F528EB533B5","user_header":"https://static001.geekbang.org/account/avatar/00/12/d6/e8/50b58ed8.jpg","comment_is_top":false,"comment_ctime":1644993353,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1644993353","product_id":100084301,"comment_content":"è¿™ä¸ªè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§æ˜¯Gossipä¸­çš„è°£è¨€ä¼ æ’­å—","like_count":0},{"had_liked":false,"id":326955,"user_name":"æè‰³ä¼Ÿ","can_delete":false,"product_type":"c1","uid":1199957,"ip_address":"","ucode":"0B166D0E68F217","user_header":"https://static001.geekbang.org/account/avatar/00/12/4f/55/0a5fd84a.jpg","comment_is_top":false,"comment_ctime":1639795931,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1639795931","product_id":100084301,"comment_content":"è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹ï¼Œæˆ‘é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªæ­£å¸¸é›†ç¾¤ç”±äºèŠ‚ç‚¹æ•…éšœäº§ç”Ÿäº†ä¸€æ¡failä¿¡æ¯ï¼Œæ²¡æœ‰åŠæ—¶æ¸…ç†ï¼Œè¿™ä¸ªipåˆè¢«åˆ«çš„é›†ç¾¤ä½¿ç”¨äº†ï¼Œè¯·é—®è¿™ä¸ªæ˜¯ping pongä¿¡æ¯äº¤æ¢çš„ï¼Œè¿˜æ˜¯meetå‘¢","like_count":0}]}