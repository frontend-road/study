{"id":405524,"title":"32 | æ•°æ®å¤„ç†ï¼šå¦‚ä½•é«˜æ•ˆå¤„ç†åº”ç”¨ç¨‹åºäº§ç”Ÿçš„æ•°æ®ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠï¼Œå¦‚ä½•æ›´å¥½åœ°è¿›è¡Œå¼‚æ­¥æ•°æ®å¤„ç†ã€‚</p><p>ä¸€ä¸ªå¤§å‹åº”ç”¨ä¸ºäº†åæœŸçš„æ’éšœã€è¿è¥ç­‰ï¼Œä¼šå°†ä¸€äº›è¯·æ±‚æ•°æ®ä¿å­˜åœ¨å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œä¾›æ—¥åä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šåº”ç”¨å°†è¯·æ±‚æ—¥å¿—ä¿å­˜åˆ° Elasticsearch ä¸­ï¼Œæ–¹ä¾¿æ’éšœï¼›ç½‘å…³å°† API è¯·æ±‚æ¬¡æ•°ã€è¯·æ±‚æ¶ˆæ¯ä½“ç­‰æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œä¾›æ§åˆ¶å°æŸ¥è¯¢å±•ç¤ºã€‚</p><p>ä¸ºäº†æ»¡è¶³è¿™äº›éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œæ•°æ®é‡‡é›†ï¼Œæ•°æ®é‡‡é›†åœ¨å¤§å‹åº”ç”¨ä¸­å¾ˆå¸¸è§ï¼Œä½†æˆ‘å‘ç°ä¸å°‘å¼€å‘è€…è®¾è®¡çš„æ•°æ®é‡‡é›†æœåŠ¡ï¼Œé€šå¸¸ä¼šå­˜åœ¨ä¸‹é¢è¿™äº›é—®é¢˜ï¼š</p><ul>\n<li>é‡‡é›†æœåŠ¡åªé’ˆå¯¹æŸä¸ªé‡‡é›†éœ€æ±‚å¼€å‘ï¼Œå¦‚æœé‡‡é›†éœ€æ±‚æœ‰å˜ï¼Œéœ€è¦ä¿®æ”¹ä¸»ä»£ç é€»è¾‘ï¼Œä»£ç æ”¹åŠ¨åŠ¿å¿…ä¼šå¸¦æ¥æ½œåœ¨çš„ Bugï¼Œå¢åŠ å¼€å‘æµ‹è¯•å·¥ä½œé‡ã€‚</li>\n<li>æ•°æ®é‡‡é›†æœåŠ¡ä¼šå¯¼è‡´å·²æœ‰çš„æœåŠ¡è¯·æ±‚å»¶æ—¶å˜é«˜ã€‚</li>\n<li>é‡‡é›†æ•°æ®æ€§èƒ½å·®ï¼Œéœ€è¦è¾ƒé•¿æ—¶é—´æ‰èƒ½é‡‡é›†å®Œä¸€æ‰¹æ•°æ®ã€‚</li>\n<li>å¯åœæœåŠ¡æ—¶ï¼Œä¼šå¯¼è‡´é‡‡é›†çš„æ•°æ®ä¸¢å¤±ã€‚</li>\n</ul><p>è¿™ä¸€è®²ï¼Œæˆ‘å°±æ¥è¯¦ç»†æ•™ä½ å¦‚ä½•è®¾è®¡å’Œè½åœ°ä¸€ä¸ªæ•°æ®é‡‡é›†æœåŠ¡ï¼Œè§£å†³ä¸Šé¢è¿™äº›é—®é¢˜ã€‚</p><h2>æ•°æ®é‡‡é›†æ–¹å¼çš„åˆ†ç±»</h2><p>é¦–å…ˆï¼Œä½ éœ€è¦çŸ¥é“å½“å‰æ•°æ®é‡‡é›†æœ‰å“ªäº›æ–¹å¼ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£å¼‚æ­¥æ•°æ®å¤„ç†æ–¹æ¡ˆã€‚</p><p>ç›®å‰ï¼Œæ•°æ®é‡‡é›†ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯åŒæ­¥é‡‡é›†å’Œå¼‚æ­¥é‡‡é›†ã€‚äºŒè€…çš„æ¦‚å¿µå’Œä¼˜ç¼ºç‚¹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/d4/b9/d4d4d6547225de5b565f99957106dbb9.jpg?wh=1920x1058\" alt=\"å›¾ç‰‡\"></p><p>ç°ä»£åº”ç”¨å¯¹æ€§èƒ½çš„è¦æ±‚è¶Šæ¥è¶Šé«˜ï¼Œè€Œå¼‚æ­¥é‡‡é›†å¯¹åº”ç”¨ç¨‹åºçš„æ€§èƒ½å½±å“æ›´å°ï¼Œå› æ­¤å¼‚æ­¥é‡‡é›†æ›´å—å¼€å‘è€…æ¬¢è¿ï¼Œå¾—åˆ°äº†å¤§è§„æ¨¡çš„åº”ç”¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘è¦ä»‹ç»çš„ IAM Pump Server æœåŠ¡ï¼Œé‡‡ç”¨çš„å°±æ˜¯å¼‚æ­¥é‡‡é›†çš„æ–¹å¼ã€‚</p><!-- [[[read_end]]] --><h2>æ•°æ®é‡‡é›†ç³»ç»Ÿè®¾è®¡</h2><p>è¿™ä¸€è®²ï¼Œæˆ‘é‡‡ç”¨ç†è®º+å®æˆ˜çš„æ–¹å¼æ¥å±•ç¤ºå¦‚ä½•è®¾è®¡ä¸€ä¸ªæ•°æ®é‡‡é›†æœåŠ¡ï¼Œè¿™é‡Œå…ˆæ¥ä»‹ç»ä¸‹å…³äºæ•°æ®é‡‡é›†çš„ç†è®ºçŸ¥è¯†ï¼Œåé¢ä¼šæœ‰å…·ä½“çš„å®æˆ˜æ¡ˆä¾‹ã€‚</p><p>åœ¨è¿‡å¾€çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘å‘ç°å¾ˆå¤šå¼€å‘äººå‘˜æ·»åŠ äº†æ•°æ®é‡‡é›†åŠŸèƒ½åï¼Œå› ä¸ºåŒæ­¥ä¸ŠæŠ¥æ•°æ®ã€å•çº¿ç¨‹ã€ä¸ŠæŠ¥é€»è¾‘ä¸å¯¹ç­‰åŸå› ï¼Œè®©æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ€§èƒ½å—åˆ°äº†ä¸¥é‡å½±å“ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨é‡‡é›†è¿‡ç¨‹ä¸­ä¸å½±å“ç¨‹åºçš„æ€§èƒ½ï¼Ÿ</p><p>ç­”æ¡ˆå°±æ˜¯è®©æ•°æ®é‡‡é›†æ¨¡å‹åŒ–ã€‚é€šè¿‡æ¨¡å‹åŒ–ï¼Œå¯ä»¥ä½¿è®¾è®¡å‡ºæ¥çš„é‡‡é›†ç³»ç»ŸåŠŸèƒ½æ›´åŠ é€šç”¨ï¼Œèƒ½å¤Ÿæ»¡è¶³æœªæ¥çš„å¾ˆå¤šåŒç±»éœ€æ±‚ï¼Œæˆ‘ä»¬ä¹Ÿå°±ä¸éœ€è¦é‡å¤å¼€å‘ç›¸åŒçš„ç³»ç»Ÿäº†ã€‚</p><p>æˆ‘ä»Šå¤©å°±æ¥ç»™ä½ è¯¦ç»†ä»‹ç»ä¸‹ï¼Œå¦‚ä½•å°†æ•°æ®é‡‡é›†åŠŸèƒ½æ¨¡å‹åŒ–ï¼Œä»¥åŠè¯¥æ¨¡å‹æ˜¯å¦‚ä½•è§£å†³ä¸Šé¢è¯´çš„çš„å„ç§é—®é¢˜çš„ã€‚</p><h3>è®¾è®¡æ•°æ®é‡‡é›†ç³»ç»Ÿæ—¶éœ€è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜</h3><p>é‡‡é›†ç³»ç»Ÿé¦–å…ˆéœ€è¦ä¸€ä¸ªæ•°æ®æº Inputï¼ŒInput å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼ŒInput ä¸­çš„æ•°æ®æ¥è‡ªäºåº”ç”¨ç¨‹åºä¸ŠæŠ¥ã€‚é‡‡é›†åçš„æ•°æ®é€šå¸¸éœ€è¦ç»è¿‡å¤„ç†ï¼Œæ¯”å¦‚æ ¼å¼åŒ–ã€å¢åˆ å­—æ®µã€è¿‡æ»¤æ— ç”¨çš„æ•°æ®ç­‰ï¼Œç„¶åå°†å¤„ç†åçš„æ•°æ®å­˜å‚¨åˆ°ä¸‹æ¸¸ç³»ç»Ÿï¼ˆOutputï¼‰ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/a9/75/a91db8c7818af0898a1774073e9bfe75.jpg?wh=1920x1145\" alt=\"å›¾ç‰‡\"></p><p>è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦è§£å†³è¿™ 3 ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š</p><ul>\n<li>è¿›è¡Œæ•°æ®é‡‡é›†ï¼Œå°±éœ€è¦åœ¨æ­£å¸¸æµç¨‹ä¸­å¤šåŠ ä¸€ä¸ªä¸ŠæŠ¥æ•°æ®ç¯èŠ‚ï¼Œè¿™åŠ¿å¿…ä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•è®©ç¨‹åºçš„æ€§èƒ½æŸå¤±æœ€å°åŒ–ï¼Ÿ</li>\n<li>å¦‚æœ Input äº§ç”Ÿæ•°æ®çš„é€Ÿåº¦å¤§äº Output çš„æ¶ˆè´¹èƒ½åŠ›ï¼Œäº§ç”Ÿæ•°æ®å †ç§¯æ€ä¹ˆåŠï¼Ÿ</li>\n<li>æ•°æ®é‡‡é›†åéœ€è¦å­˜å‚¨åˆ°ä¸‹æ¸¸ç³»ç»Ÿã€‚åœ¨å­˜å‚¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œå¹¶å¯èƒ½ä¼šå­˜å‚¨åˆ°ä¸åŒçš„ä¸‹æ¸¸ç³»ç»Ÿï¼Œè¿™ç§å¯å˜çš„éœ€æ±‚å¦‚ä½•æ»¡è¶³ï¼Ÿ</li>\n</ul><p>å¯¹äºè®©ç¨‹åºæ€§èƒ½æŸå¤±æœ€å°åŒ–è¿™ä¸€ç‚¹ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯å¼‚æ­¥ä¸ŠæŠ¥ã€‚å¦‚æœæ˜¯å¼‚æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŠŠæ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶åå†å¼‚æ­¥ä¸ŠæŠ¥åˆ°ç›®æ ‡ç³»ç»Ÿä¸­ã€‚å½“ç„¶ï¼Œä¸ºäº†æé«˜ä¸ŠæŠ¥çš„æ•ˆç‡ï¼Œå¯ä»¥é‡‡ç”¨æ‰¹é‡ä¸ŠæŠ¥çš„æ–¹å¼ã€‚</p><p>å¯¹äºæ•°æ®å †ç§¯è¿™ä¸ªé—®é¢˜ï¼Œæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ³•æ˜¯ï¼Œå°†é‡‡é›†çš„æ•°æ®å…ˆä¸ŠæŠ¥åˆ°ä¸€äº›å…·æœ‰é«˜ååé‡ã€å¯ä»¥å­˜å‚¨å¤§é‡æ•°æ®çš„ä¸­é—´ç»„ä»¶ï¼Œæ¯”å¦‚ Kafkaã€Redis ä¸­ã€‚è¿™ç§æ–¹å¼ä¹Ÿæ˜¯ä¸šç•Œæ ‡å‡†çš„å¤„ç†æ–¹å¼ã€‚</p><p>å¯¹äºé‡‡é›†éœ€æ±‚å¤šæ ·åŒ–è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†é‡‡é›†ç¨‹åºåšæˆæ’ä»¶åŒ–ã€å¯æ‰©å±•çš„ï¼Œæ»¡è¶³å¯å˜çš„éœ€æ±‚ã€‚</p><p>è¦è§£å†³è¿™ 3 ä¸ªé—®é¢˜ï¼Œå…¶å®å°±æ¶‰åŠåˆ°äº†æ•°æ®é‡‡é›†ç³»ç»Ÿä¸­çš„ä¸¤ä¸ªåŠŸèƒ½ç‚¹çš„è®¾è®¡ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½å’Œæ•°æ®é‡‡é›†åŠŸèƒ½ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œå¦‚ä½•è®¾è®¡è¿™ä¸¤ä¸ªåŠŸèƒ½ç‚¹ã€‚</p><h3>æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½è®¾è®¡</h3><p>ä¸ºäº†æé«˜å¼‚æ­¥ä¸ŠæŠ¥çš„ååé‡ï¼Œä½ å¯ä»¥å°†æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼ˆGo ä¸­å¯ä»¥ä½¿ç”¨æœ‰ç¼“å†² channelï¼‰ï¼Œå¹¶ä½¿ç”¨å¤šä¸ª worker å»æ¶ˆè´¹å†…å­˜ä¸­çš„æ•°æ®ã€‚ä½¿ç”¨å¤šä¸ª worker ï¼Œå¯ä»¥å……åˆ†å‘æŒ¥ CPU çš„å¤šæ ¸èƒ½åŠ›ã€‚å¦å¤–ï¼Œä¸ŠæŠ¥ç»™ä¸‹æ¸¸ç³»ç»Ÿæ—¶ï¼Œä½ ä¹Ÿå¯ä»¥é‡‡ç”¨æ‰¹é‡ä¸ŠæŠ¥çš„æ–¹å¼ã€‚</p><h3>æ•°æ®é‡‡é›†åŠŸèƒ½è®¾è®¡</h3><p>ç°ä»£åº”ç”¨ç¨‹åºè¶Šæ¥è¶Šè®²ç©¶æ’ä»¶åŒ–ã€æ‰©å±•æ€§ï¼Œåœ¨è®¾è®¡é‡‡é›†ç³»ç»Ÿæ—¶ï¼Œä¹Ÿåº”è¯¥è€ƒè™‘åˆ°æœªæ¥çš„éœ€æ±‚ã€‚æ¯”å¦‚ï¼Œæœªæ¥ä½ å¯èƒ½éœ€è¦å°†æ•°æ®ä»ä¸ŠæŠ¥åˆ° MongoDB åˆ‡æ¢åˆ° HBase ä¸­ï¼Œæˆ–è€…åŒæ—¶å°†æ•°æ®ä¸ŠæŠ¥åˆ° MongoDB å’Œ HBase ä¸­ã€‚å› æ­¤ï¼Œä¸ŠæŠ¥ç»™ä¸‹æ¸¸çš„ç¨‹åºé€»è¾‘è¦å…·æœ‰æ’ä»¶åŒ–çš„èƒ½åŠ›ï¼Œå¹¶èƒ½é€šè¿‡é…ç½®é€‰æ‹©éœ€è¦çš„æ’ä»¶ã€‚</p><p>ä¸ºäº†æé«˜ç¨‹åºæ€§èƒ½ï¼Œä¼šå…ˆæŠŠæ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚ä½†æ˜¯è¿™æ ·æœ‰ä¸ªç¼ºç‚¹ï¼šåœ¨å…³åœç¨‹åºæ—¶ï¼Œå†…å­˜ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±ã€‚æ‰€ä»¥ï¼Œåœ¨ç¨‹åºç»“æŸä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿å†…å­˜ä¸­çš„æ•°æ®èƒ½å¤Ÿä¸ŠæŠ¥æˆåŠŸï¼Œä¹Ÿå°±æ˜¯è¯´é‡‡é›†ç¨‹åºéœ€è¦å®ç°ä¼˜é›…å…³åœåŠŸèƒ½ã€‚ä¼˜é›…å…³åœä¸ä»…è¦ç¡®ä¿ç¼“å­˜ä¸­çš„æ•°æ®è¢«æˆåŠŸä¸ŠæŠ¥ï¼Œè¿˜è¦ç¡®ä¿æ­£åœ¨å¤„ç†çš„æ•°æ®è¢«æˆåŠŸä¸ŠæŠ¥ã€‚</p><p>å½“ç„¶äº†ï¼Œæ—¢ç„¶æ˜¯æ•°æ®é‡‡é›†ï¼Œè¿˜è¦èƒ½å¤Ÿé…ç½®é‡‡é›†çš„é¢‘ç‡ã€‚æœ€åï¼Œå› ä¸ºé‡‡é›†ç¨‹åºé€šå¸¸æ˜¯é API ç±»å‹çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯¹å¤–æš´éœ²ä¸€ä¸ªç‰¹æ®Šçš„ APIï¼Œç”¨æ¥è¿”å›é‡‡é›†ç¨‹åºçš„å¥åº·çŠ¶æ€ã€‚</p><h3>æ•°æ®é‡‡é›†åº”ç”¨æ¨¡å‹</h3><p>é€šè¿‡ä¸Šé¢çš„åˆ†æå’Œè®¾è®¡ï¼Œå¯ä»¥ç»˜åˆ¶å‡ºä¸‹é¢è¿™ä¸ªé‡‡é›†æ¨¡å‹ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/2e/34/2ecccdb3c851577f9cd5a56bb7197c34.jpg?wh=1920x910\" alt=\"å›¾ç‰‡\"></p><p>å¼‚æ­¥ä¸ŠæŠ¥éœ€è¦é¢å¤–çš„å¼‚æ­¥é€»è¾‘ï¼Œä¼šå¢åŠ å¼€å‘å·¥ä½œé‡å’Œç¨‹åºå¤æ‚åº¦ï¼Œæ‰€ä»¥ï¼Œå¯¹äºä¸€äº› Input æ•°æ®ç”Ÿäº§é€Ÿåº¦å°äº Output æ¶ˆè´¹é€Ÿåº¦ï¼Œå¹¶ä¸” Output å…·æœ‰é«˜ååé‡ã€ä½å»¶æ—¶ç‰¹æ€§çš„åœºæ™¯ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨åŒæ­¥ä¸ŠæŠ¥ï¼Œä¾‹å¦‚åŒæ­¥ä¸ŠæŠ¥ç»™ Redisã€‚</p><h2>æ•°æ®é‡‡é›†ç³»ç»Ÿè½åœ°é¡¹ç›®ï¼šiam-authz-server + iam-pump</h2><p>ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†æ•°æ®é‡‡é›†ç³»ç»Ÿçš„æ¶æ„ï¼Œä½†æ˜¯åªæœ‰æ¨¡å‹å’Œç†è®ºï¼Œè‚¯å®šè¿˜ä¸è¶³ä»¥è§£å†³ä½ å¯¹æ•°æ®é‡‡é›†ç¨‹åºçš„å¼€å‘éœ€æ±‚ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•è½åœ°ä¸Šé¢çš„æ•°æ®é‡‡é›†æ¶æ„ã€‚æ•´ä¸ªæ¶æ„åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«ç”±ä¸åŒçš„æœåŠ¡å®ç°ï¼š</p><ul>\n<li>iam-authz-serverï¼šå®ç°æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½ã€‚</li>\n<li>iam-pumpï¼šå®ç°æ•°æ®é‡‡é›†åŠŸèƒ½ã€‚</li>\n</ul><p>æ•´ä¸ªé‡‡é›†ç³»ç»Ÿçš„æ¶æ„ï¼Œè·Ÿä¸Šé¢æè¿°çš„æ•°æ®é‡‡é›†æ¶æ„å®Œå…¨ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸é‡å¤è¯´æ˜äº†ã€‚</p><h2>iam-authz-serverï¼šæ•°æ®ä¸ŠæŠ¥</h2><p>æ•°æ®ä¸ŠæŠ¥çš„æœ€å¤§éš¾ç‚¹ï¼Œå°±æ˜¯å¦‚ä½•å‡å°‘ä¸ŠæŠ¥é€»è¾‘å¯¹åº”ç”¨æ€§èƒ½çš„å½±å“ã€‚å¯¹æ­¤ï¼Œæˆ‘ä»¬ä¸»è¦çš„è§£å†³æ€è·¯å°±æ˜¯å¼‚æ­¥ä¸ŠæŠ¥æ•°æ®ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç» iam-authz-server çš„æ•°æ®ä¸ŠæŠ¥è®¾è®¡ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æˆç†Ÿçš„è®¾è®¡ï¼Œåœ¨æˆ‘æ‰€å¼€å‘å’Œäº†è§£çš„é¡¹ç›®ä¸­è¢«å¤§é‡é‡‡ç”¨ï¼Œæœ‰äº›é¡¹ç›®å¯ä»¥æ‰¿è½½åäº¿çº§/å¤©çš„è¯·æ±‚é‡ã€‚é€šè¿‡ä»‹ç»è¿™ä¸ªè®¾è®¡ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¼‚æ­¥ä¸ŠæŠ¥çš„å…·ä½“æ–¹æ³•ï¼Œä»¥åŠä¸ŠæŠ¥è¿‡ç¨‹ä¸­è¦è€ƒè™‘çš„å› ç´ ã€‚</p><p>iam-authz-server çš„æ•°æ®ä¸ŠæŠ¥æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/4d/3f/4d288a15fa6ebaae5ef25df8af5ac13f.jpg?wh=1920x764\" alt=\"å›¾ç‰‡\"></p><p>iam-authz-server æœåŠ¡ä¸­çš„æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½å¯ä»¥é€‰æ‹©æ€§å¼€å¯ï¼Œå¼€å¯ä»£ç è§ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/server.go#L147-L156\">internal/authzserver/server.go</a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">&nbsp;if s.analyticsOptions.Enable {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; analyticsStore := storage.RedisCluster{KeyPrefix: RedisKeyPrefix}&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; analyticsIns := analytics.NewAnalytics(s.analyticsOptions, &amp;analyticsStore)&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; analyticsIns.Start()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; s.gs.AddShutdownCallback(shutdown.ShutdownFunc(func(string) error {&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; analyticsIns.Stop()&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return nil&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; }))&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; }&nbsp; &nbsp;&nbsp; \n</code></pre><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå½“ <code>s.analyticsOptions.Enable</code> ä¸º <code>true</code> æ—¶ï¼Œå¼€å¯æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½ã€‚å› ä¸ºæ•°æ®ä¸ŠæŠ¥ä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ï¼Œè€Œä¸”åœ¨æœªæ¥å¯èƒ½ä¼šå­˜åœ¨ç¦æ‰æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½çš„åœºæ™¯ï¼Œæ‰€ä»¥åœ¨è®¾è®¡ iam-authz-server æ—¶ï¼Œå°±æŠŠæ•°æ®ä¸ŠæŠ¥åŠŸèƒ½åšæˆäº†å¯é…ç½®çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¯ç”¨/ç¦ç”¨æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½ã€‚é…ç½®æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼šå°† <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/configs/iam-authz-server.yaml#L63\">iam-authz-server.yaml</a> çš„ analytics.enable è®¾ç½®ä¸º trueï¼Œä»£è¡¨å¼€å¯æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½ï¼›è®¾ç½®ä¸º false ï¼Œåˆ™ä»£è¡¨å…³é—­æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½ã€‚</p><p>è¿™é‡Œï¼Œæˆ‘å»ºè®®ä½ åœ¨è®¾è®¡ç¨‹åºæ—¶ï¼Œå°†æœªæ¥çš„å¯èƒ½å˜é‡è€ƒè™‘è¿›å»ï¼Œå¹¶å°†è¿™äº›å˜é‡åšæˆå¯é…ç½®çš„ã€‚è¿™æ ·ï¼Œå¦‚æœå“ªå¤©éœ€æ±‚å˜åŒ–ï¼Œæˆ‘ä»¬å°±èƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¿®æ”¹ä»£ç çš„æ–¹å¼æ¥æ»¡è¶³éœ€æ±‚ã€‚è¿™ç§æ–¹å¼å¯ä»¥å°†åº”ç”¨ç¨‹åºçš„å˜åŠ¨å±€é™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä»è€Œå¤§å¤§å‡å°ç°ç½‘æœåŠ¡å‡ºç°æ•…éšœçš„æ¦‚ç‡ï¼Œåšåˆ°åªå˜æ›´é…ç½®æ–‡ä»¶å°±å¯ä»¥ç¼©çŸ­å‘å¸ƒå˜æ›´çš„å‘¨æœŸã€‚</p><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé€šè¿‡ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L64-L79\">NewAnalytics</a> åˆ›å»ºä¸€ä¸ªæ•°æ®ä¸ŠæŠ¥æœåŠ¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func NewAnalytics(options *AnalyticsOptions, store storage.AnalyticsHandler) *Analytics {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; ps := options.PoolSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; recordsBufferSize := options.RecordsBufferSize&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; workerBufferSize := recordsBufferSize / uint64(ps)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; log.Debug(\"Analytics pool worker buffer size\", log.Uint64(\"workerBufferSize\", workerBufferSize))&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; recordsChan := make(chan *AnalyticsRecord, recordsBufferSize)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; return &amp;Analytics{&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; store:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; store,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; poolSize:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ps,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; recordsChan:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; recordsChan,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; workerBufferSize:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;workerBufferSize,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; recordsBufferFlushInterval: options.FlushInterval,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;\n}&nbsp; &nbsp; &nbsp;&nbsp;\n</code></pre><p>è¿™é‡Œçš„ä»£ç æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼Œåˆ›å»º Analytics ç±»å‹çš„å˜é‡å¹¶è¿”å›ï¼Œå˜é‡ä¸­æœ‰ 5 ä¸ªå­—æ®µéœ€è¦ä½ å…³æ³¨ï¼š</p><ul>\n<li>storeï¼š <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/pkg/storage/storage.go#L65-L71\">storage.AnalyticsHandler</a> æ¥å£ç±»å‹ï¼Œæä¾›äº† <code>Connect() bool</code>å’Œ <code>AppendToSetPipelined(string, byte)</code>å‡½æ•°ï¼Œåˆ†åˆ«ç”¨æ¥è¿æ¥ storage å’Œä¸ŠæŠ¥æ•°æ®ç»™ storageã€‚iam-authz-server ç”¨äº† redis storageã€‚</li>\n<li>recordsChanï¼šæˆæƒæ—¥å¿—ä¼šç¼“å­˜åœ¨ recordsChan å¸¦ç¼“å†² channel ä¸­ï¼Œå…¶é•¿åº¦å¯ä»¥é€šè¿‡ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/configs/iam-authz-server.yaml#L65\">iam-authz-server.yaml</a> é…ç½®æ–‡ä»¶ä¸­çš„  <code>analytics.records-buffer-size</code>  é…ç½®ã€‚</li>\n<li>poolSizeï¼šæŒ‡å®šå¼€å¯ worker çš„ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯å¼€å¯å¤šå°‘ä¸ª Go åç¨‹æ¥æ¶ˆè´¹ recordsChan ä¸­çš„æ¶ˆæ¯ã€‚</li>\n<li>workerBufferSizeï¼šæ‰¹é‡æŠ•é€’ç»™ä¸‹æ¸¸ç³»ç»Ÿçš„çš„æ¶ˆæ¯æ•°ã€‚é€šè¿‡æ‰¹é‡æŠ•é€’ï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜æ¶ˆè´¹èƒ½åŠ›ã€å‡å°‘ CPU æ¶ˆè€—ã€‚</li>\n<li>recordsBufferFlushIntervalï¼šè®¾ç½®æœ€è¿Ÿå¤šä¹…æŠ•é€’ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯æŠ•é€’æ•°æ®çš„è¶…æ—¶æ—¶é—´ã€‚</li>\n</ul><p>analytics.ecords-buffer-size å’Œ analytics.pool-size å»ºè®®æ ¹æ®éƒ¨ç½²æœºå™¨çš„ CPU å’Œå†…å­˜æ¥é…ç½®ã€‚åœ¨åº”ç”¨çœŸæ­£ä¸Šçº¿å‰ï¼Œæˆ‘å»ºè®®ä½ é€šè¿‡å‹åŠ›å’Œè´Ÿè½½æµ‹è¯•ï¼Œæ¥é…ç½®ä¸€ä¸ªåˆé€‚çš„å€¼ã€‚</p><p>Analyticsæä¾›äº† 3 ç§æ–¹æ³•ï¼š</p><ul>\n<li>Start()ï¼Œç”¨æ¥å¯åŠ¨æ•°æ®ä¸ŠæŠ¥æœåŠ¡ã€‚</li>\n<li>Stop()ï¼Œç”¨æ¥å…³åœæ•°æ®ä¸ŠæŠ¥æœåŠ¡ã€‚ä¸»ç¨‹åºåœ¨æ”¶åˆ°ç³»ç»Ÿçš„ç»ˆæ­¢å‘½ä»¤åï¼Œè°ƒç”¨ Stop æ–¹æ³•ä¼˜é›…å…³åœæ•°æ®ä¸ŠæŠ¥æœåŠ¡ï¼Œç¡®ä¿ç¼“å­˜ä¸­çš„æ•°æ®éƒ½ä¸ŠæŠ¥æˆåŠŸã€‚</li>\n<li>RecordHit(record *AnalyticsRecord) errorï¼Œç”¨æ¥è®°å½• AnalyticsRecord çš„æ•°æ®ã€‚</li>\n</ul><p>é€šè¿‡ NewXxx ï¼ˆNewAnalyticsï¼‰è¿”å›ä¸€ä¸ª Xxx ï¼ˆAnalyticsï¼‰ç±»å‹çš„ç»“æ„ä½“ï¼ŒXxxï¼ˆAnalyticsï¼‰ ç±»å‹å¸¦æœ‰ä¸€äº›æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func NewAnalytics(options) *Analytics {\n    ...\n}\n\nfunc (r *Analytics) Start() {\n    ...\n}\nfunc (r *Analytics) Stop() {\n    ...\n}\nfunc (r *Analytics) RecordHit(record *AnalyticsRecord) error {\n    ...\n}\n</code></pre><p>å…¶å®ï¼Œä¸Šè¿°ä»£ç æ®µæ˜¯ä¸€ç§å¸¸è§çš„ Go ä»£ç ç¼–å†™æ–¹å¼/è®¾è®¡æ¨¡å¼ã€‚ä½ åœ¨ä»¥åçš„å¼€å‘ç”Ÿæ¶¯ä¸­ï¼Œä¼šç»å¸¸é‡åˆ°è¿™ç§è®¾è®¡æ–¹å¼ã€‚ä½¿ç”¨ä¸Šè¿°ä»£ç è®¾è®¡æ–¹å¼æœ‰ä¸‹é¢ä¸¤ä¸ªå¥½å¤„ã€‚</p><ul>\n<li><strong>åŠŸèƒ½æ¨¡å—åŒ–ï¼š</strong>å°†æ•°æ®ä¸ŠæŠ¥çš„åŠŸèƒ½å°è£…æˆä¸€ä¸ªæœåŠ¡æ¨¡å—ï¼Œæ•°æ®å’Œæ–¹æ³•éƒ½å›´ç»•ç€ Xxx ç»“æ„ä½“æ¥å±•å¼€ã€‚è¿™å’Œ C++ã€Javaã€Python çš„ç±»æœ‰ç›¸ä¼¼çš„åœ°æ–¹ï¼Œä½ å¯ä»¥è¿™ä¹ˆç†è§£ï¼šXxx ç›¸å½“äºç±»ï¼ŒNewXxx ç›¸å½“äºåˆå§‹åŒ–ä¸€ä¸ªç±»å®ä¾‹ï¼ŒStartã€Stopã€RecordHit æ˜¯è¿™ä¸ªç±»æä¾›çš„æ–¹æ³•ã€‚åŠŸèƒ½æ¨¡å—åŒ–å¯ä»¥ä½¿ç¨‹åºé€»è¾‘æ›´åŠ æ¸…æ™°ï¼ŒåŠŸèƒ½æ›´ç‹¬ç«‹ã€æ›´å¥½ç»´æŠ¤ï¼Œä¹Ÿå¯ä»¥ä¾›å…¶ä»–åº”ç”¨ä½¿ç”¨ã€‚</li>\n<li><strong>æ–¹ä¾¿æ•°æ®ä¼ é€’ï¼š</strong>å¯ä»¥å°†æ•°æ®å­˜æ”¾åœ¨ Xxx ç»“æ„ä½“å­—æ®µä¸­ï¼Œä¾›ä¸åŒçš„æ–¹æ³•å…±äº«ä½¿ç”¨ï¼Œå¦‚æœæœ‰å¹¶å‘ï¼Œæ•°æ®å…±äº«æ—¶ï¼Œæ³¨æ„è¦ç»™éå¹¶å‘å®‰å…¨çš„ç±»å‹åŠ é”ï¼Œä¾‹å¦‚recordsChanã€‚</li>\n</ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šä»‹ç» iam-authz-server æœåŠ¡ä¸­è·Ÿæ•°æ®ä¸ŠæŠ¥ç›¸å…³çš„ 3 éƒ¨åˆ†æ ¸å¿ƒä»£ç ï¼Œåˆ†åˆ«æ˜¯å¯åŠ¨æ•°æ®ä¸ŠæŠ¥æœåŠ¡ã€å¼‚æ­¥ä¸ŠæŠ¥æˆæƒæ—¥å¿—å’Œä¼˜é›…å…³åœæ•°æ®ä¸ŠæŠ¥ã€‚</p><h3>å¯åŠ¨æœåŠ¡ï¼šå¯åŠ¨æ•°æ®ä¸ŠæŠ¥æœåŠ¡</h3><p>åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œé¦–å…ˆè¦å¯åŠ¨æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½æ¨¡å—ã€‚æˆ‘ä»¬é€šè¿‡è°ƒç”¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L87-L100\">analyticsIns.Start()</a> å¯åŠ¨æ•°æ®ä¸ŠæŠ¥æœåŠ¡ã€‚Start ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func (r *Analytics) Start() {\n    analytics = r\n    r.store.Connect()\n\n    // start worker pool\n    atomic.SwapUint32(&amp;r.shouldStop, 0)\n    for i := 0; i &lt; r.poolSize; i++ {\n        r.poolWg.Add(1)\n        go r.recordWorker()\n    }\n\n    // stop analytics workers\n    go r.Stop()\n}\n</code></pre><p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦ä½ æ³¨æ„ï¼Œæ•°æ®ä¸ŠæŠ¥å’Œæ•°æ®é‡‡é›†éƒ½å¤§é‡åº”ç”¨äº† Go åç¨‹æ¥å¹¶å‘åœ°æ‰§è¡Œæ“ä½œï¼Œä¸ºäº†é˜²æ­¢æ½œåœ¨çš„å¹¶å‘è¯»å†™å¼•èµ·çš„Bugï¼Œå»ºè®®ä½ çš„æµ‹è¯•ç¨‹åºç¼–è¯‘æ—¶åŠ ä¸Š -raceï¼Œä¾‹å¦‚go build -race cmd/iam-authz-server/authzserver.goã€‚ç„¶åï¼Œåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œè§‚å¯Ÿç¨‹åºæ—¥å¿—ï¼Œçœ‹æœ‰æ— å¹¶å‘é—®é¢˜å‡ºç°ã€‚</p><p>Start ä¸­ä¼šå¼€å¯ poolSize ä¸ªæ•°çš„ worker åç¨‹ï¼Œè¿™äº›åç¨‹å…±åŒæ¶ˆè´¹ recordsChan ä¸­çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹é€»è¾‘è§ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L128-L173\">recordWorker()</a> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func (r *Analytics) recordWorker() {\n\tdefer r.poolWg.Done()\n\n\t// this is buffer to send one pipelined command to redis\n\t// use r.recordsBufferSize as cap to reduce slice re-allocations\n\trecordsBuffer := make([][]byte, 0, r.workerBufferSize)\n\n\t// read records from channel and process\n\tlastSentTS := time.Now()\n\tfor {\n\t\treadyToSend := false\n\t\tselect {\n\t\tcase record, ok := &lt;-r.recordsChan:\n\t\t\t// check if channel was closed and it is time to exit from worker\n\t\t\tif !ok {\n\t\t\t\t// send what is left in buffer\n\t\t\t\tr.store.AppendToSetPipelined(analyticsKeyName, recordsBuffer)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// we have new record - prepare it and add to buffer\n\n\t\t\tif encoded, err := msgpack.Marshal(record); err != nil {\n\t\t\t\tlog.Errorf(\"Error encoding analytics data: %s\", err.Error())\n\t\t\t} else {\n\t\t\t\trecordsBuffer = append(recordsBuffer, encoded)\n\t\t\t}\n\n\t\t\t// identify that buffer is ready to be sent\n\t\t\treadyToSend = uint64(len(recordsBuffer)) == r.workerBufferSize\n\n\t\tcase &lt;-time.After(r.recordsBufferFlushInterval):\n\t\t\t// nothing was received for that period of time\n\t\t\t// anyways send whatever we have, don't hold data too long in buffer\n\t\t\treadyToSend = true\n\t\t}\n\n\t\t// send data to Redis and reset buffer\n\t\tif len(recordsBuffer) &gt; 0 &amp;&amp; (readyToSend || time.Since(lastSentTS) &gt;= recordsBufferForcedFlushInterval) {\n\t\t\tr.store.AppendToSetPipelined(analyticsKeyName, recordsBuffer)\n\t\t\trecordsBuffer = recordsBuffer[:0]\n\t\t\tlastSentTS = time.Now()\n\t\t}\n\t}\n}\n</code></pre><p>recordWorker å‡½æ•°ä¼šå°†æ¥æ”¶åˆ°çš„æˆæƒæ—¥å¿—ä¿å­˜åœ¨ recordsBuffer åˆ‡ç‰‡ä¸­ï¼Œå½“æ•°ç»„å†…å…ƒç´ ä¸ªæ•°ä¸º workerBufferSize ï¼Œæˆ–è€…è·ç¦»ä¸Šä¸€æ¬¡æŠ•é€’æ—¶é—´é—´éš”ä¸º recordsBufferFlushInterval æ—¶ï¼Œå°±ä¼šå°† recordsBuffer æ•°ç»„ä¸­çš„æ•°æ®ä¸ŠæŠ¥ç»™ç›®æ ‡ç³»ç»Ÿï¼ˆInputï¼‰ã€‚<br>\nrecordWorker()ä¸­æœ‰äº›è®¾è®¡æŠ€å·§ï¼Œå¾ˆå€¼å¾—ä½ å‚è€ƒã€‚</p><ul>\n<li>ä½¿ç”¨ <a href=\"https://github.com/vmihailenco/msgpack\">msgpack</a> åºåˆ—åŒ–æ¶ˆæ¯ï¼šmsgpack æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„äºŒè¿›åˆ¶åºåˆ—åŒ–æ ¼å¼ã€‚å®ƒåƒ JSON ä¸€æ ·ï¼Œè®©ä½ å¯ä»¥åœ¨å„ç§è¯­è¨€ä¹‹é—´äº¤æ¢æ•°æ®ã€‚ä½†æ˜¯å®ƒæ¯” JSON æ›´å¿«ã€æ›´å°ã€‚</li>\n<li>æ”¯æŒ Batch Windowsï¼šå½“ worker çš„æ¶ˆæ¯æ•°è¾¾åˆ°æŒ‡å®šé˜ˆå€¼æ—¶ï¼Œä¼šæ‰¹é‡æŠ•é€’æ¶ˆæ¯ç»™ Redisï¼Œé˜ˆå€¼åˆ¤æ–­ä»£ç ä¸º<code>readyToSend = uint64(len(recordsBuffer)) == r.workerBufferSize</code>ã€‚</li>\n<li>è¶…æ—¶æŠ•é€’ï¼šä¸ºäº†é¿å…å› ä¸ºäº§ç”Ÿæ¶ˆæ¯å¤ªæ…¢ï¼Œä¸€ç›´è¾¾ä¸åˆ° Batch Windowsï¼Œæ— æ³•æŠ•é€’æ¶ˆæ¯è¿™ç§æƒ…å†µï¼ŒæŠ•é€’é€»è¾‘ä¹Ÿæ”¯æŒè¶…æ—¶æŠ•é€’ï¼Œé€šè¿‡ <code>case &lt;-time.After(r.recordsBufferFlushInterval)</code>ä»£ç æ®µå®ç°ã€‚</li>\n<li>æ”¯æŒä¼˜é›…å…³åœï¼šå½“ recordsChan å…³é—­æ—¶ï¼Œå°† recordsBuffer ä¸­çš„æ¶ˆæ¯æ‰¹é‡æŠ•é€’ç»™ Redisï¼Œä¹‹åé€€å‡º worker åç¨‹ã€‚</li>\n</ul><p>è¿™é‡Œæœ‰ä¸ªæ³¨æ„äº‹é¡¹ï¼šæŠ•é€’å®Œæˆåï¼Œä½ éœ€è¦é‡ç½® recordsBuffer å’Œè®¡æ—¶å™¨ï¼Œå¦åˆ™ä¼šé‡å¤æŠ•é€’æ•°æ®ï¼š</p><pre><code class=\"language-go\">recordsBuffer = recordsBuffer[:0]\nlastSentTS = time.Now()\n</code></pre><p>è¿™é‡Œè¿˜è®¾ç½®äº†ä¸€ä¸ªæœ€å¤§çš„è¶…æ—¶æ—¶é—´ recordsBufferForcedFlushIntervalï¼Œç¡®ä¿æ¶ˆæ¯æœ€è¿Ÿè¢«æŠ•é€’çš„æ—¶é—´é—´éš”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ iam-authz-server å¼ºåˆ¶è¦æ±‚æœ€å¤§æŠ•é€’é—´éš”ä¸º recordsBufferForcedFlushInterval ç§’ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢é…ç½®æ–‡ä»¶å°† recordsBufferFlushInterval è®¾å¾—è¿‡å¤§ã€‚</p><h3>è¿è¡ŒæœåŠ¡ï¼šå¼‚æ­¥ä¸ŠæŠ¥æˆæƒæ—¥å¿—</h3><p>å¼€å¯äº†æ•°æ®ä¸ŠæŠ¥æœåŠ¡åï¼Œå½“æœ‰æˆæƒæ—¥å¿—äº§ç”Ÿæ—¶ï¼Œç¨‹åºå°±ä¼šè‡ªåŠ¨ä¸ŠæŠ¥æ•°æ®ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šè¯¦ç»†ä»‹ç»ä¸‹å¦‚ä½•é«˜æ•ˆä¸ŠæŠ¥æ•°æ®ã€‚</p><p>iam-authz-server ä¼šåœ¨æˆæƒæˆåŠŸæ—¶è°ƒç”¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/authorization/authorizer/authorizer.go#L100-L115\">LogGrantedAccessRequest</a> å‡½æ•°ï¼Œåœ¨æˆæƒå¤±è´¥æ—¶è°ƒç”¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/authorization/authorizer/authorizer.go#L71-L97\">LogRejectedAccessRequest</a> å‡½æ•°ã€‚å¹¶ä¸”ï¼Œåœ¨è¿™ä¸¤ä¸ªå‡½æ•°ä¸­ï¼Œè°ƒç”¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L115-L126\">RecordHit </a>å‡½æ•°ï¼Œè®°å½•æˆæƒæ—¥å¿—ã€‚</p><p>iam-authz-server é€šè¿‡è°ƒç”¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L115-L126\">RecordHit(record *AnalyticsRecord) error</a> å‡½æ•°ï¼Œå¼‚æ­¥ç¼“å­˜æˆæƒæ—¥å¿—ã€‚è°ƒç”¨ RecordHit åï¼Œä¼šå°† <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L26-L35\">AnalyticsRecord</a> ç±»å‹çš„æ¶ˆæ¯å­˜æ”¾åˆ° recordsChan æœ‰ç¼“å†² channel ä¸­ã€‚</p><p>è¿™é‡Œè¦æ³¨æ„ï¼šåœ¨ç¼“å­˜å‰ï¼Œéœ€è¦åˆ¤æ–­ä¸ŠæŠ¥æœåŠ¡æ˜¯å¦åœ¨ä¼˜é›…å…³åœä¸­ï¼Œå¦‚æœåœ¨å…³åœä¸­ï¼Œåˆ™ä¸¢å¼ƒè¯¥æ¶ˆæ¯ï¼š</p><pre><code class=\"language-go\">if atomic.LoadUint32(&amp;r.shouldStop) &gt; 0 {\n    return nil\n}\n</code></pre><p>é€šè¿‡å°†æˆæƒæ—¥å¿—ç¼“å†™å…¥ recordsChan æœ‰ç¼“å†² channel ä¸­ï¼ŒLogGrantedAccessRequest å’Œ LogRejectedAccessRequest å‡½æ•°å¯ä»¥ä¸ç”¨ç­‰å¾…æˆæƒæ—¥å¿—ä¸ŠæŠ¥æˆåŠŸå°±è¿”å›ï¼Œè¿™æ ·å°±ä½¿å¾—æ•´ä¸ªæˆæƒè¯·æ±‚çš„æ€§èƒ½æŸè€—å‡ ä¹ä¸ºé›¶ã€‚</p><h3>å…³åœæœåŠ¡ï¼šä¼˜é›…å…³åœæ•°æ®ä¸ŠæŠ¥</h3><p>å®Œæˆæ•°æ®ä¸ŠæŠ¥ä¹‹åçš„ä¸‹ä¸€æ­¥ï¼Œå°±æ˜¯è¦ä¼˜é›…åœ°å°†æ•°æ®ä¸ŠæŠ¥å…³åœã€‚ä¸ºäº†ç¡®ä¿åœ¨åº”ç”¨å…³åœæ—¶ï¼Œç¼“å­˜ä¸­çš„æ•°æ®å’Œæ­£åœ¨æŠ•é€’ä¸­çš„æ•°æ®éƒ½èƒ½å¤ŸæŠ•é€’åˆ° Redisï¼Œiam-authz-server å®ç°äº†æ•°æ®ä¸ŠæŠ¥å…³åœåŠŸèƒ½ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">gs.AddShutdownCallback(shutdown.ShutdownFunc(func(string) error {\n    analyticsIns.Stop()\n    return nil\n}))\n</code></pre><p>å½“æ”¶åˆ° os.Interrupt å’Œ syscall.SIGTERM ç³»ç»Ÿä¿¡å·åï¼Œè°ƒç”¨ analyticsIns.Stop()å‡½æ•°ï¼Œå…³åœæ•°æ®ä¸ŠæŠ¥æœåŠ¡ï¼Œ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L103-L112\">Stop</a> å‡½æ•°ä¼šåœæ­¢æ¥æ”¶æ–°çš„æˆæƒæ—¥å¿—ï¼Œå¹¶ç­‰å¾…æ­£åœ¨ä¸ŠæŠ¥çš„æ•°æ®ä¸ŠæŠ¥å®Œæˆã€‚</p><p>ä¸Šé¢æˆ‘ä»‹ç»äº†æ•°æ®ä¸ŠæŠ¥éƒ¨åˆ†çš„åŠŸèƒ½è®¾è®¡ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘æ¥ä»‹ç»ä¸‹æ•°æ®é‡‡é›†éƒ¨åˆ†çš„åŠŸèƒ½è®¾è®¡ã€‚</p><h2>iam-pumpï¼šæ•°æ®é‡‡é›†</h2><p>iam-authz-server å°†æ•°æ®ä¸ŠæŠ¥åˆ° Redisï¼Œiam-pump æ¶ˆè´¹ Redis ä¸­çš„æ•°æ®ï¼Œå¹¶ä¿å­˜åœ¨ MongoDB ä¸­åšæŒä¹…åŒ–å­˜å‚¨ã€‚</p><p>iam-pump çš„è®¾è®¡è¦ç‚¹æ˜¯ï¼šæ’ä»¶åŒ–ã€å¯é…ç½®åœ°å°† Redis ä¸­çš„æ•°æ®å¤„ç†åå­˜å‚¨åˆ°ä¸‹æ¸¸ç³»ç»Ÿä¸­ï¼Œå¹¶ä¸”å®ç°ä¼˜é›…å…³åœåŠŸèƒ½ï¼Œè¿™äº›ä¹Ÿæ˜¯è®¾è®¡æ•°æ®é‡‡é›†ç¨‹åºçš„è¦ç‚¹å’Œéš¾ç‚¹æ‰€åœ¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ iam-pump æ˜¯å¦‚ä½•æ’ä»¶åŒ–åœ°å®ç°ä¸€ä¸ªæ•°æ®é‡‡é›†ç¨‹åºçš„ã€‚è¿™ä¸ªæ•°æ®é‡‡é›†ç¨‹åºçš„è®¾è®¡æ€è·¯ï¼Œåœ¨æˆ‘å¼€å‘çš„å¤§å‹ä¼ä¸šåº”ç”¨ä¸­æœ‰å®é™…çš„è½åœ°éªŒè¯ï¼Œä½ å¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚</p><p>iam-pump æ•°æ®é‡‡é›†æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/91/ed/913b92d58cfd7cba0dff26612be9e9ed.jpg?wh=1920x1129\" alt=\"å›¾ç‰‡\"></p><p>åœ¨iam-pumpæœåŠ¡å¯åŠ¨æ—¶ï¼Œè¦å¯åŠ¨æ•°æ®é‡‡é›†åŠŸèƒ½ï¼Œå¯åŠ¨ä»£ç è§ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server.go#L58\">internal/pump/server.go</a>ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šä»‹ç»ä¸‹ iam-pump æœåŠ¡ä¸­çš„ 5 éƒ¨åˆ†æ ¸å¿ƒä»£ç ï¼š</p><ul>\n<li>æ•°æ®é‡‡é›†æ’ä»¶å®šä¹‰ã€‚</li>\n<li>åˆå§‹åŒ–æ•°æ®é‡‡é›†æ’ä»¶ã€‚</li>\n<li>å¥åº·æ£€æŸ¥ã€‚</li>\n<li>å¯åŠ¨ Loop å‘¨æœŸæ€§æ¶ˆè´¹ Redis æ•°æ®ã€‚</li>\n<li>ä¼˜é›…å…³åœæ•°æ®é‡‡é›†æœåŠ¡ã€‚</li>\n</ul><h3>åˆå§‹åŒ–æœåŠ¡ï¼šæ•°æ®é‡‡é›†æ’ä»¶å®šä¹‰</h3><p>æ•°æ®é‡‡é›†ç»„ä»¶è®¾è®¡çš„æ ¸å¿ƒæ˜¯æ’ä»¶åŒ–ï¼Œè¿™é‡Œæˆ‘<strong>å°†éœ€è¦ä¸ŠæŠ¥çš„ç³»ç»ŸæŠ½è±¡æˆä¸€ä¸ªä¸ªçš„ pump</strong>ï¼Œé‚£ä¹ˆå¦‚ä½•å®šä¹‰ pump æ¥å£å‘¢ï¼Ÿæ¥å£å®šä¹‰éœ€è¦å‚è€ƒå®é™…çš„é‡‡é›†éœ€æ±‚ï¼Œé€šå¸¸æ¥è¯´ï¼Œè‡³å°‘éœ€è¦ä¸‹é¢è¿™å‡ ä¸ªå‡½æ•°ã€‚</p><ul>\n<li><strong>Newï¼š</strong>åˆ›å»ºä¸€ä¸ª pumpã€‚</li>\n<li><strong>Initï¼š</strong>åˆå§‹åŒ–ä¸€ä¸ª pumpï¼Œä¾‹å¦‚ï¼Œå¯ä»¥åœ¨ Init ä¸­åˆ›å»ºä¸‹æ¸¸ç³»ç»Ÿçš„ç½‘ç»œè¿æ¥ã€‚</li>\n<li><strong>WriteDataï¼š</strong>å¾€ä¸‹æ¸¸ç³»ç»Ÿå†™å…¥æ•°æ®ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæœ€å¥½æ”¯æŒæ‰¹é‡å†™å…¥ã€‚</li>\n<li><strong>SetFiltersï¼š</strong>è®¾ç½®æ˜¯å¦è¿‡æ»¤æŸæ¡æ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯éœ€è¦çš„ã€‚</li>\n<li><strong>SetTimeoutï¼š</strong>è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚æˆ‘å°±åœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°è¿‡ä¸€ä¸ªå‘ï¼Œè¿æ¥ Kafka è¶…æ—¶ï¼Œå¯¼è‡´æ•´ä¸ªé‡‡é›†ç¨‹åºè¶…æ—¶ã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦æœ‰è¶…æ—¶å¤„ç†ï¼Œé€šè¿‡è¶…æ—¶å¤„ç†ï¼Œå¯ä»¥ä¿è¯æ•´ä¸ªé‡‡é›†æ¡†æ¶æ­£å¸¸è¿è¡Œã€‚</li>\n</ul><p>æˆ‘ä¹‹å‰å¼€å‘è¿‡å…¬æœ‰äº‘çš„ç½‘å…³æœåŠ¡ï¼Œç½‘å…³æœåŠ¡éœ€è¦æŠŠç½‘å…³çš„è¯·æ±‚æ•°æ®è½¬å­˜åˆ° MongoDB ä¸­ã€‚æˆ‘ä»¬çš„ç½‘å…³æœåŠ¡æ›¾ç»é‡åˆ°ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å‘ï¼šæœ‰äº›ç”¨æˆ·ä¼šé€šè¿‡ç½‘å…³ä¸Šä¼ éå¸¸å¤§çš„æ–‡ä»¶ï¼ˆç™¾ M çº§åˆ«ï¼‰ï¼Œè¿™äº›æ•°æ®è½¬å­˜åˆ° MongoDB ä¸­ï¼Œå¿«é€Ÿæ¶ˆè€—äº† MongoDB çš„å­˜å‚¨ç©ºé—´ï¼ˆ500G å­˜å‚¨ç©ºé—´ï¼‰ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è½¬å­˜æ•°æ®æ—¶ï¼Œéœ€è¦è¿‡æ»¤æ‰ä¸€äº›æ¯”è¾ƒè¯¦ç»†çš„æ•°æ®ï¼Œæ‰€ä»¥ iam-pump æ·»åŠ äº† SetOmitDetailedRecording æ¥è¿‡æ»¤æ‰è¯¦ç»†çš„æ•°æ®ã€‚</p><p>æ‰€ä»¥ï¼Œæœ€å iam-pump çš„æ’ä»¶æ¥å£å®šä¹‰ä¸º <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/pumps/pump.go#L15-L26\">internal/pump/pumps/pump.go</a> ï¼š</p><pre><code class=\"language-go\">type Pump interface {\n\tGetName() string\n\tNew() Pump\n\tInit(interface{}) error\n\tWriteData(context.Context, []interface{}) error\n\tSetFilters(analytics.AnalyticsFilters)\n\tGetFilters() analytics.AnalyticsFilters\n\tSetTimeout(timeout int)\n\tGetTimeout() int\n\tSetOmitDetailedRecording(bool)\n\tGetOmitDetailedRecording() bool\n}\n</code></pre><p>ä½ åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¦‚æœæœ‰æ›´å¤šçš„éœ€æ±‚ï¼Œå¯ä»¥åœ¨ Pump interface å®šä¹‰ä¸­ç»§ç»­æ·»åŠ éœ€è¦çš„å¤„ç†å‡½æ•°ã€‚</p><h3>åˆå§‹åŒ–æœåŠ¡ï¼šåˆå§‹åŒ–æ•°æ®é‡‡é›†æ’ä»¶</h3><p>å®šä¹‰å¥½æ’ä»¶ä¹‹åï¼Œéœ€è¦åˆå§‹åŒ–æ’ä»¶ã€‚åœ¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server.go#L97-L124\">initialize</a> å‡½æ•°ä¸­åˆå§‹åŒ– pumpsï¼š</p><pre><code class=\"language-go\">func (s *pumpServer) initialize() {\n\tpmps = make([]pumps.Pump, len(s.pumps))\n\ti := 0\n\tfor key, pmp := range s.pumps {\n\t\tpumpTypeName := pmp.Type\n\t\tif pumpTypeName == \"\" {\n\t\t\tpumpTypeName = key\n\t\t}\n\n\t\tpmpType, err := pumps.GetPumpByName(pumpTypeName)\n\t\tif err != nil {\n\t\t\tlog.Errorf(\"Pump load error (skipping): %s\", err.Error())\n\t\t} else {\n\t\t\tpmpIns := pmpType.New()\n\t\t\tinitErr := pmpIns.Init(pmp.Meta)\n\t\t\tif initErr != nil {\n\t\t\t\tlog.Errorf(\"Pump init error (skipping): %s\", initErr.Error())\n\t\t\t} else {\n\t\t\t\tlog.Infof(\"Init Pump: %s\", pmpIns.GetName())\n\t\t\t\tpmpIns.SetFilters(pmp.Filters)\n\t\t\t\tpmpIns.SetTimeout(pmp.Timeout)\n\t\t\t\tpmpIns.SetOmitDetailedRecording(pmp.OmitDetailedRecording)\n\t\t\t\tpmps[i] = pmpIns\n\t\t\t}\n\t\t}\n\t\ti++\n\t}\n}\n</code></pre><p>initialize ä¼šåˆ›å»ºã€åˆå§‹åŒ–ï¼Œå¹¶è°ƒç”¨ SetFiltersã€SetTimeoutã€SetOmitDetailedRecording æ¥è®¾ç½®è¿™äº› pumpã€‚Filtersã€Timeoutã€OmitDetailedRecording ç­‰ä¿¡æ¯åœ¨ pump çš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šã€‚</p><p>è¿™é‡Œæœ‰ä¸ªæŠ€å·§ä½ ä¹Ÿå¯ä»¥æ³¨æ„ä¸‹ï¼špump é…ç½®æ–‡ä»¶æ”¯æŒé€šç”¨çš„é…ç½®ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰çš„é…ç½®ï¼Œé…ç½®ç»“æ„ä¸º <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/options/options.go#L18-L24\">PumpConfig</a> ï¼š</p><pre><code class=\"language-go\">type PumpConfig struct {\n\tType                  string\n\tFilters               analytics.AnalyticsFilters\n\tTimeout               int\n\tOmitDetailedRecording bool\n\tMeta                  map[string]interface{}\n}\n</code></pre><p>pump è‡ªå®šä¹‰çš„é…ç½®å¯ä»¥å­˜æ”¾åœ¨ map ç±»å‹çš„å˜é‡ Meta ä¸­ã€‚é€šç”¨é…ç½®å¯ä»¥ä½¿é…ç½®å…±äº«ï¼Œå‡å°‘å¼€å‘å’Œç»´æŠ¤å·¥ä½œé‡ï¼Œè‡ªå®šä¹‰é…ç½®å¯ä»¥é€‚é…ä¸åŒpumpçš„å·®å¼‚åŒ–é…ç½®ã€‚</p><h3>åˆå§‹åŒ–æœåŠ¡ï¼šå¥åº·æ£€æŸ¥</h3><p>å› ä¸º iam-pump æ˜¯ä¸€ä¸ªé API æœåŠ¡ï¼Œä¸ºäº†ç›‘æ§å…¶è¿è¡ŒçŠ¶æ€ï¼Œè¿™é‡Œä¹Ÿè®¾ç½®äº†ä¸€ä¸ªå¥åº·æ£€æŸ¥æ¥å£ã€‚iam-pump ç»„ä»¶é€šè¿‡è°ƒç”¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server/server.go#L15-L25\">server.ServeHealthCheck</a> å‡½æ•°å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡ï¼ŒServeHealthCheck å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-go\">func ServeHealthCheck(healthPath string, healthAddress string) {\n\thttp.HandleFunc(\"/\"+healthPath, func(w http.ResponseWriter, r *http.Request) {\n\t\tw.Header().Set(\"Content-type\", \"application/json\")\n\t\tw.WriteHeader(http.StatusOK)\n\t\t_, _ = w.Write([]byte(`{\"status\": \"ok\"}`))\n\t})\n\n\tif err := http.ListenAndServe(healthAddress, nil); err != nil {\n\t\tlog.Fatalf(\"Error serving health check endpoint: %s\", err.Error())\n\t}\n}\n</code></pre><p>è¯¥å‡½æ•°å¯åŠ¨äº†ä¸€ä¸ª HTTP æœåŠ¡ï¼ŒæœåŠ¡ç›‘å¬åœ°å€é€šè¿‡ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/configs/iam-pump.yaml#L7\">health-check-address</a> é…ç½®ï¼Œå¥åº·æ£€æŸ¥è·¯å¾„é€šè¿‡ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/configs/iam-pump.yaml#L6\">health-check-path</a> é…ç½®ã€‚å¦‚æœè¯·æ±‚ <code>http://&lt;health-check-address&gt;/&lt;health-check-path&gt;</code>è¿”å›<code>{\"status\": \"ok\"}</code>ï¼Œè¯´æ˜ iam-pump å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p><p>è¿™é‡Œçš„å¥åº·æ£€æŸ¥åªæ˜¯ç®€å•è¿”å›äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®é™…å¼€å‘ä¸­ï¼Œå¯ä»¥å°è£…æ›´å¤æ‚çš„é€»è¾‘ã€‚æ¯”å¦‚ï¼Œæ£€æŸ¥è¿›ç¨‹æ˜¯å¦å¯ä»¥æˆåŠŸ ping é€šæ•°æ®åº“ï¼Œè¿›ç¨‹å†…çš„å·¥ä½œè¿›ç¨‹æ˜¯å¦å¤„äº worker çŠ¶æ€ç­‰ã€‚</p><p>iam-pump é»˜è®¤çš„å¥åº·æ£€æŸ¥è¯·æ±‚åœ°å€ä¸º<code>http://127.0.0.1:7070/healthz</code> ã€‚</p><h3>è¿è¡ŒæœåŠ¡ï¼šå¯åŠ¨ Loop å‘¨æœŸæ€§æ¶ˆè´¹ Redis æ•°æ®</h3><p>åˆå§‹åŒ– pumps ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server.go#L58-L95\">Run</a> å‡½æ•°å¯åŠ¨æ¶ˆè´¹é€»è¾‘äº†ã€‚åœ¨ Run å‡½æ•°ä¸­ï¼Œä¼šå®šæœŸï¼ˆé€šè¿‡é…ç½® <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/configs/iam-pump.yaml#L5\">purge-delay</a> è®¾ç½®è½®è®­æ—¶é—´ï¼‰ä» Redis ä¸­è·å–æ‰€æœ‰æ•°æ®ï¼Œç»è¿‡ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server.go#L72\">msgpack.Unmarshal</a> è§£å‹åï¼Œä¼ ç»™ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server.go#L126\">writeToPumps</a> å¤„ç†ï¼š</p><pre><code class=\"language-go\">func (s preparedPumpServer) Run(stopCh &lt;-chan struct{}) error {\n\tticker := time.NewTicker(time.Duration(s.secInterval) * time.Second)\n\tdefer ticker.Stop()\n\n\tfor {\n\t\tselect {\n\t\tcase &lt;-ticker.C:\n\t\t\tanalyticsValues := s.analyticsStore.GetAndDeleteSet(storage.AnalyticsKeyName)\n\t\t\tif len(analyticsValues) &gt; 0 {\n\t\t\t\t// Convert to something clean\n\t\t\t\tkeys := make([]interface{}, len(analyticsValues))\n\n\t\t\t\tfor i, v := range analyticsValues {\n\t\t\t\t\tdecoded := analytics.AnalyticsRecord{}\n\t\t\t\t\terr := msgpack.Unmarshal([]byte(v.(string)), &amp;decoded)\n\t\t\t\t\tlog.Debugf(\"Decoded Record: %v\", decoded)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\tlog.Errorf(\"Couldn't unmarshal analytics data: %s\", err.Error())\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif s.omitDetails {\n\t\t\t\t\t\t\tdecoded.Policies = \"\"\n\t\t\t\t\t\t\tdecoded.Deciders = \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t\tkeys[i] = interface{}(decoded)\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Send to pumps\n\t\t\t\twriteToPumps(keys, s.secInterval)\n\t\t\t}\n\t\t// exit consumption cycle when receive SIGINT and SIGTERM signal\n\t\tcase &lt;-stopCh:\n\t\t\tlog.Info(\"stop purge loop\")\n\n\t\t\treturn nil\n\t\t}\n\t}\n}\n</code></pre><p>writeToPumps å‡½æ•°é€šè¿‡è°ƒç”¨ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server.go#L165-L213\">execPumpWriting</a> å‡½æ•°ï¼Œå¼‚æ­¥è°ƒç”¨ pump çš„ WriteData å‡½æ•°å†™å…¥æ•°æ®ã€‚execPumpWriting å‡½æ•°ä¸­æœ‰ä¸€äº›è®¾è®¡æŠ€å·§ï¼Œä½ å¯ä»¥æ³¨æ„ä¸‹è¿™ä¸¤ä¸ªï¼š</p><ul>\n<li>å°†ä¸€äº›é€šç”¨çš„å¤„ç†ï¼Œä¾‹å¦‚ Filtersã€Timeoutã€OmitDetailedRecording æ”¾åœ¨ pump ä¹‹å¤–å¤„ç†ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ pump ä¸­ä»£ç çš„é‡å¤æ€§ã€‚</li>\n<li>ä¼˜é›…å…³åœã€‚é€šè¿‡å¦‚ä¸‹ä»£ç å®ç°ä¼˜é›…å…³åœåŠŸèƒ½ï¼š</li>\n</ul><pre><code class=\"language-go\">select {\n    case &lt;-stopCh:\n        log.Info(\"stop purge loop\")\n        return\n    default:\n}\n</code></pre><p>ä¸Šé¢çš„ä»£ç éœ€è¦æ”¾åœ¨ writeToPumps ä¹‹åï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½æˆåŠŸå†™å…¥ pumps ä¹‹åï¼Œå†åœæ­¢é‡‡é›†é€»è¾‘ã€‚</p><h3>å…³åœæœåŠ¡ï¼šä¼˜é›…å…³åœæ•°æ®é‡‡é›†æœåŠ¡</h3><p>åœ¨å…³åœæœåŠ¡æ—¶ï¼Œä¸ºäº†ç¡®ä¿æ­£åœ¨å¤„ç†çš„æ•°æ®è¢«æˆåŠŸå­˜å‚¨ï¼Œè¿˜éœ€è¦æä¾›ä¼˜é›…å…³åœåŠŸèƒ½ã€‚iam-pump é€šè¿‡ channel ä¼ é€’ SIGINT å’Œ SIGTERM ä¿¡å·ï¼Œå½“æ¶ˆè´¹é€»è¾‘æ”¶åˆ°è¿™ä¸¤ä¸ªä¿¡å·åï¼Œä¼šé€€å‡ºæ¶ˆè´¹å¾ªç¯ï¼Œè§ <a href=\"https://github.com/marmotedu/iam/blob/v1.0.6/internal/pump/server.go#L58\">Run</a> å‡½æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class=\"language-plain\">func (s preparedPumpServer) Run(stopCh &lt;-chan struct{}) error {&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; ticker := time.NewTicker(time.Duration(s.secInterval) * time.Second)&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; defer ticker.Stop()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; for {&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; select {&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; case &lt;-ticker.C:&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// æ¶ˆè´¹é€»è¾‘\n         ...\n        // exit consumption cycle when receive SIGINT and SIGTERM signal\n&nbsp; &nbsp; &nbsp; &nbsp; case &lt;-stopCh:&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.Info(\"stop purge loop\")&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp;&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return nil\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n}\n\n</code></pre><h2>æ€»ç»“</h2><p>è¿™ä¸€è®²ï¼Œæˆ‘ä¸»è¦ä»‹ç»äº†å¦‚ä½•å°†æ•°æ®é‡‡é›†éœ€æ±‚è½¬åŒ–æˆä¸€ä¸ªæ•°æ®é‡‡é›†æ¨¡å‹ï¼Œå¹¶ä»è¿™ä¸ªæ¨¡å‹å‡ºå‘ï¼Œè®¾è®¡å‡ºä¸€ä¸ªå¯æ‰©å±•ã€é«˜æ€§èƒ½çš„æ•°æ®é‡‡é›†æœåŠ¡ï¼Œå¹¶é€šè¿‡ iam-pump ç»„ä»¶æ¥è½åœ°è¯¥é‡‡é›†æ¨¡å‹ã€‚</p><p>æœ€åï¼Œæˆ‘è¿˜æƒ³ç»™ä½ ä¸€ä¸ªå»ºè®®ï¼šåœ¨å¼€å‘ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥å°†ä¸€äº›åŠŸèƒ½æŠ½è±¡æˆä¸€äº›é€šç”¨çš„æ¨¡å‹ï¼Œå¹¶ä¸ºè¯¥æ¨¡å‹å®ç°åŸºæœ¬æ¡†æ¶ï¼ˆå¼•æ“ï¼‰ï¼Œç„¶åå°†ä¸€äº›éœ€è¦å®šåˆ¶åŒ–çš„éƒ¨åˆ†æ’ä»¶åŒ–ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥è®¾è®¡å‡ºä¸€ä¸ªé«˜æ‰©å±•çš„æœåŠ¡ï¼Œä½¿å¾—æœåŠ¡ä¸ä»…èƒ½å¤Ÿæ»¡è¶³ç°åœ¨çš„éœ€æ±‚ï¼Œè¿˜èƒ½å¤Ÿæ»¡è¶³æœªæ¥çš„éœ€æ±‚ã€‚</p><h2>è¯¾åç»ƒä¹ </h2><ol>\n<li>æ€è€ƒä¸‹ï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªæ•°æ®ä¸ŠæŠ¥å’Œæ•°æ®é‡‡é›†åº”ç”¨ï¼Œè®¾è®¡æ—¶æœ‰å“ªäº›ç‚¹éœ€è¦æ³¨æ„ï¼Ÿ</li>\n<li>åŠ¨æ‰‹ç»ƒä¹ ä¸‹ï¼Œå¯åŠ¨ iam-authz-server å’Œ iam-pump æœåŠ¡ï¼ŒéªŒè¯æ•´ä¸ªæµç¨‹ã€‚</li>\n</ol><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²è§ã€‚</p>","comments":[{"had_liked":false,"id":307509,"user_name":"Sch0ng","can_delete":false,"product_type":"c1","uid":1145554,"ip_address":"","ucode":"73F6113931B1AC","user_header":"https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg","comment_is_top":false,"comment_ctime":1629127373,"is_pvip":false,"replies":[{"id":"111380","content":"åˆ°ä½ï¼","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1629242547,"ip_address":"","comment_id":307509,"utype":1}],"discussion_count":2,"race_medal":0,"score":"23103963853","product_id":100079601,"comment_content":"æ•°æ®é‡‡é›†æœåŠ¡åˆ†æ•°æ®ä¸ŠæŠ¥å’Œæ•°æ®é‡‡é›†ï¼Œå…ˆåšæ‹†åˆ†å†æœ‰é’ˆå¯¹æ€§è¾¾æˆç›®æ ‡æ€§èƒ½ã€‚<br>æŠŠåŠŸèƒ½æŠ½è±¡æˆæ¨¡å‹ï¼Œå†æŠŠå®ç°å°è£…æˆç‹¬ç«‹çš„æ¨¡å—ï¼Œåº”ç”¨ä¾èµ–æ¨¡å‹çš„æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“çš„å®ç°ã€‚","like_count":5,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":525181,"discussion_content":"åˆ°ä½ï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629242547,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1105161,"avatar":"https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg","nickname":"helloworld","note":"","ucode":"1EECCA0F43E278","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":389503,"discussion_content":"å¾ˆå¥½ğŸ‘","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629296344,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":306077,"user_name":"Vackine","can_delete":false,"product_type":"c1","uid":1139588,"ip_address":"","ucode":"8E412EE82D3B59","user_header":"https://static001.geekbang.org/account/avatar/00/11/63/84/f45c4af9.jpg","comment_is_top":false,"comment_ctime":1628329473,"is_pvip":false,"replies":[{"id":"110902","content":"è¿™é‡Œæš‚æ—¶ä¸æ”¯æŒã€‚<br><br>è€å“¥ï¼Œå¯ä»¥å°è¯•å°†redisåˆ‡æ¢æˆkafkaï¼Œkafkaå¯ä»¥è®°å½•æ¶ˆè´¹ä½ç½®","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1628524880,"ip_address":"","comment_id":306077,"utype":1}],"discussion_count":2,"race_medal":0,"score":"14513231361","product_id":100079601,"comment_content":"pumpå¦‚æœä¸­é€”é€€å‡ºäº†ï¼Œä¼šè®°å½•å·²ç»æ¶ˆè´¹çš„ä½ç½®ä¹ˆï¼Ÿ","like_count":3,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":524616,"discussion_content":"è¿™é‡Œæš‚æ—¶ä¸æ”¯æŒã€‚\n\nè€å“¥ï¼Œå¯ä»¥å°è¯•å°†redisåˆ‡æ¢æˆkafkaï¼Œkafkaå¯ä»¥è®°å½•æ¶ˆè´¹ä½ç½®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1628524880,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1975831,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/rSzzqGwHcvhwPejiaPsCY9XBX7ib7zTxJ6cUDORdhGIakX8dTPVsz6ibud5ec1FeWQGTseF2TPRECCjky5JMlHvDg/132","nickname":"Struggle~honor","note":"","ucode":"EBC6DFC6CF0973","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":549613,"discussion_content":"è€å¸ˆï¼Œè¯·é—®æ–‡ä¸­çš„åœºæ™¯ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨kafkaå—","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1644132538,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331892,"user_name":"Geek_63505f","can_delete":false,"product_type":"c1","uid":2879366,"ip_address":"","ucode":"E6CA4A7A9057B4","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKXjfJWVQGDHmDEI73VQO4dgTzaK5LLz2ax9XUF4FCPy1Oib8aQLibFzpcsiavVVbAQlG4pbrfibdwaYA/132","comment_is_top":false,"comment_ctime":1642856342,"is_pvip":false,"replies":[{"id":"121267","content":"å°† . ä¹Ÿè½¬æ¢ä¸º_","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1167883","ctime":1642867870,"ip_address":"","comment_id":331892,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5937823638","product_id":100079601,"comment_content":"è€å¸ˆè¿™å¥è¯æ˜¯ä»€ä¹ˆæ„æ€ viper.SetEnvKeyReplacer(strings.NewReplacer(&quot;.&quot;, &quot;_&quot;, &quot;-&quot;, &quot;_&quot;)) <br>    strings.NewReplaceré‡Œé¢ä¸åº”è¯¥æ˜¯(&quot;-&quot;,&quot;_&quot;)è¿™æ ·å—ï¼Ÿå‰é¢é‚£ä¸¤ä¸ªå­—ç¬¦å¤šå‡ºæ¥æ˜¯å¹²å˜›ç”¨çš„ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547828,"discussion_content":"å°† . ä¹Ÿè½¬æ¢ä¸º_","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642867870,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2879366,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKXjfJWVQGDHmDEI73VQO4dgTzaK5LLz2ax9XUF4FCPy1Oib8aQLibFzpcsiavVVbAQlG4pbrfibdwaYA/132","nickname":"Geek_63505f","note":"","ucode":"E6CA4A7A9057B4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":547840,"discussion_content":"ğŸ˜‚è°¢è°¢è€å¸ˆï¼çœ‹äº†Viperæ–‡æ¡£æ˜¯è‡ªå·±æ²¡æœ‰ç†è§£æ¸…æ¥š!","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642877785,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":324735,"user_name":"yandongxiao","can_delete":false,"product_type":"c1","uid":1017700,"ip_address":"","ucode":"D397F4DB0109C8","user_header":"https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg","comment_is_top":false,"comment_ctime":1638594915,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5933562211","product_id":100079601,"comment_content":"æ€»ç»“ï¼š<br>æ•°æ®é‡‡é›†æœåŠ¡å¸¸è§é—®é¢˜ï¼šä¸å¤Ÿé€šç”¨åŒ–ï¼›é‡‡é›†æœåŠ¡å»¶è¿Ÿé«˜ã€æ€§èƒ½å·®ã€å¯åœæœåŠ¡æ—¶ä¼šæœ‰æ•°æ®ä¸¢å¤±ã€‚<br>æ•°æ®é‡‡é›†æœåŠ¡ä¸€èˆ¬éœ€è¦å®Œæˆï¼šæ•°æ®ä¸ŠæŠ¥ å’Œ æ•°æ®å¤„ç†ã€‚å®ƒä»¬ä¸€èˆ¬ä¸æ˜¯åŒä¸€ä¸ªè¿›ç¨‹å†…ã€‚<br>æ•°æ®ä¸ŠæŠ¥ï¼šå¯¹æ•°æ®å‹ç¼©ã€æ”¯æŒæ‰¹é‡ä¸ŠæŠ¥ã€è¶…æ—¶ä¸ŠæŠ¥ã€ä¼˜é›…å…³åœï¼ˆåœæ­¢æ¥æ”¶æ–°è¯·æ±‚ï¼Œå®ŒæˆæœåŠ¡ä¸­çš„è¯·æ±‚ï¼‰<br>æ•°æ®å¤„ç†ï¼šæ•°æ®å¤„ç†å®Œæ¯•åï¼Œè¿˜éœ€è¦è¿›è¡Œä¸ŠæŠ¥ã€‚å°†ä¸ŠæŠ¥çš„æ¨¡å—åšæˆæ’ä»¶åŒ–ï¼Œéå¸¸é‡è¦ã€‚","like_count":1},{"had_liked":false,"id":318934,"user_name":"é™å¿ƒ","can_delete":false,"product_type":"c1","uid":1335457,"ip_address":"","ucode":"EB264FA6519FDA","user_header":"https://static001.geekbang.org/account/avatar/00/14/60/a1/8f003697.jpg","comment_is_top":false,"comment_ctime":1635486229,"is_pvip":true,"replies":[{"id":"115961","content":"è¿™ä¸ªæ¨¡å‹å°±æ˜¯æºè‡ªäº¿çº§QPSçš„ç”Ÿäº§é¡¹ç›®ï¼Œå®Œå…¨å¯ä»¥ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"å­”ä»¤é£","uid":"1167883","ctime":1636003971,"ip_address":"","comment_id":318934,"utype":1}],"discussion_count":1,"race_medal":5,"score":"5930453525","product_id":100079601,"comment_content":"è¿™ä¸ªæ’ä»¶åŒ–çš„pumpæ¨¡å‹æŠ½è±¡çš„çœŸå¥½ï¼Œæ„Ÿè§‰è¿™ä¸ªpumpé¡¹ç›®å®Œå…¨å¯ä»¥ç”¨åˆ°ç”Ÿäº§äº†ã€‚","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":529434,"discussion_content":"è¿™ä¸ªæ¨¡å‹å°±æ˜¯æºè‡ªäº¿çº§QPSçš„ç”Ÿäº§é¡¹ç›®ï¼Œå®Œå…¨å¯ä»¥ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1636003971,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311371,"user_name":"Ethan Liu","can_delete":false,"product_type":"c1","uid":1070043,"ip_address":"","ucode":"231F944F7CD56A","user_header":"https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg","comment_is_top":false,"comment_ctime":1631190895,"is_pvip":true,"replies":[{"id":"113694","content":"åŒæ­¥ä¸ŠæŠ¥æŒ‡çš„æ˜¯ï¼šè°ƒç”¨ä¸ŠæŠ¥æ¥å£ï¼Œå¹¶é˜»å¡ç›´åˆ°ä¸ŠæŠ¥æ¥å£è¿”å›ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"CK1.0","uid":"1167883","ctime":1632760531,"ip_address":"","comment_id":311371,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5926158191","product_id":100079601,"comment_content":"åº”ç”¨äº§ç”Ÿçš„æ•°æ®æ”¾åˆ°æ—¥å¿—ä¸­,å†ç”±æ•°æ®ä¸ŠæŠ¥æœåŠ¡è¯»å–è‡³bufferd channelå—? <br>åŒæ­¥ä¸ŠæŠ¥æ–¹å¼æŒ‡çš„æ˜¯rpcå—?","like_count":1,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":526572,"discussion_content":"åŒæ­¥ä¸ŠæŠ¥æŒ‡çš„æ˜¯ï¼šè°ƒç”¨ä¸ŠæŠ¥æ¥å£ï¼Œå¹¶é˜»å¡ç›´åˆ°ä¸ŠæŠ¥æ¥å£è¿”å›ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632760531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347048,"user_name":"æ¥å’¯","can_delete":false,"product_type":"c1","uid":1073090,"ip_address":"","ucode":"64B8BF24BED979","user_header":"https://static001.geekbang.org/account/avatar/00/10/5f/c2/997e298b.jpg","comment_is_top":false,"comment_ctime":1653641811,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1653641811","product_id":100079601,"comment_content":"ensureConnection   redis é‡æ–°è¿æ¥ å¤±è´¥ åº”è¯¥éœ€è¦sleepå§ ä¸ç„¶æ—¥å¿—å†™çˆ†  CPU ä¹Ÿå æ»¡äº†","like_count":0},{"had_liked":false,"id":338060,"user_name":"å·¦è€³æœµä¸œ","can_delete":false,"product_type":"c1","uid":1160678,"ip_address":"","ucode":"60134ACF12BB52","user_header":"https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg","comment_is_top":false,"comment_ctime":1647261349,"is_pvip":false,"replies":[{"id":"125567","content":"è¿™é‡Œæ˜¯ä¸ªbugå“ˆï¼Œmasteråˆ†æ”¯æœ‰çº æ­£è¿‡æ¥ï¼Œè¿™é‡Œæˆ‘è®©ç¼–è¾‘æ”¹ä¸‹","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":"1167883","ctime":1651080751,"ip_address":"","comment_id":338060,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1647261349","product_id":100079601,"comment_content":"<br>func (r *Analytics) Start() {<br>    analytics = r<br>    r.store.Connect()<br><br>    &#47;&#47; start worker pool<br>    atomic.SwapUint32(&amp;r.shouldStop, 0)<br>    for i := 0; i &lt; r.poolSize; i++ {<br>        r.poolWg.Add(1)<br>        go r.recordWorker()<br>    }<br><br>    &#47;&#47; stop analytics workers<br>    go r.Stop()<br>}<br><br>å€’æ•°ç¬¬äºŒè¡Œä»£ç  go r.Stop()ï¼Œè¿™é‡ŒæŠŠ recordsChan é©¬ä¸Šåˆå…³é—­äº†ï¼Ÿé‚£åé¢è¿˜æ€ä¹ˆç»™è¿™ä¸ª channel å‘æ¶ˆæ¯ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1167883,"avatar":"https://static001.geekbang.org/account/avatar/00/11/d2/0b/cdd0787a.jpg","nickname":"å­”ä»¤é£","note":"","ucode":"8363EA4BD0AAF0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":568264,"discussion_content":"è¿™é‡Œæ˜¯ä¸ªbugå“ˆï¼Œmasteråˆ†æ”¯æœ‰çº æ­£è¿‡æ¥ï¼Œè¿™é‡Œæˆ‘è®©ç¼–è¾‘æ”¹ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1651080751,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}