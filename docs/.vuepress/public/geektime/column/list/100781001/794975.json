{"id":794975,"title":"04｜预案：预案的三板斧指的是什么？","content":"<p>你好，我是白园，今天我们来聊聊可靠性的第四个部分—预案。</p><p>在《隋唐演义》中，程咬金以其独特的三招绝技——三板斧，战胜了众多强敌。尽管他掌握的招数不多，但每一招都运用得炉火纯青。预案也是这样，它的价值不在于数量的多寡，而在于其精准性和熟练度。</p><p>历史上，超过90%的系统故障都通过一些基础而通用的应急预案得到了有效解决。这些预案的高效和熟练运用是提高故障恢复速度的关键因素。例如，2021年B站遭遇的重大故障，就是通过执行服务回滚和系统重启的策略成功恢复的。</p><p>这节课我会给你介绍六个最常用的应急预案，并详细解释它们的执行顺序。我们将探讨如何确保这些预案能够被有效且迅速地执行，以便在面临系统故障时，能够最大限度地减少业务损失。</p><h2>六大通用预案</h2><p>六大预案就是<strong>回滚、扩容、重启、切流、限流、降级</strong>。这六种预案可以分为三类，第一类是几乎无损的预案，包括切流、扩容；第二类是短时间内有损的预案，包括重启和回滚；第三类是持续有损的预案，包括限流和降级。我们在选择的时候，需要看一下选择哪种或者哪几种，还有操作顺序是怎样的。</p><p><img src=\"https://static001.geekbang.org/resource/image/46/40/4630f7f22f5f408d37c9b8a483c64940.png?wh=2034x790\" alt=\"图片\"></p><h3><strong>切流</strong></h3><p>切流是一种常见的技术手段，用于在发生单机房故障时保持服务的连续性和可用性。由于流量切换是一种无损操作，它成为处理此类问题的首要选择。在服务部署时，应实施多机房冗余部署策略，至少确保两个机房的冗余，以便在一个机房发生故障时，能够迅速将流量切换到其他正常运行的机房。这里我来介绍几种常见的切流场景。</p><!-- [[[read_end]]] --><ul>\n<li><strong>客户端自动故障转移</strong>：一种常见的做法是让服务端配置多个域名，端上自动探测这些域名的健康状况。当某个域名的失败率异常升高时，客户端可以自动执行故障转移。这种方法的优势在于能够在故障发生时自动切换服务，无需人工干预，有效应对机房故障和域名封禁等问题。</li>\n<li><strong>DNS层面的流量切换</strong>：面对网络故障，如特定地区的网络问题，可以通过修改DNS记录来实现流量的切换。这种方法的优点在于操作简单，只需更改DNS设置即可。然而，DNS更新通常需要至少5分钟才能生效，且完全收敛可能需要更长的时间，这是它主要的局限性。</li>\n<li><strong>4层（LVS）流量切换</strong>：在正常情况下，4层负载均衡设备具备自动故障转移功能，能够在下游服务出现故障时自动切换流量。这种切换的生效时间通常在秒级，响应速度较快。缺点是一旦LVS本身也受到了影响就只能通过客户端或者DNS层面进行切换。</li>\n<li><strong>7层流量切换（如Nginx）</strong>：面对内部机房问题，可以在Nginx层面统一切换流量，这种方法的优点是切换迅速，但通常需要人工干预。人工操作缺点就是操作时间会相对比较长。</li>\n<li><strong>服务层的切换，</strong>比如利用服务网格技术进行服务调用之间的跨机房切换，这种方式的优缺点跟7层切换类似，都需要人工切换。</li>\n<li><strong>数据库层面的流量切换</strong>：如果数据库所在的机房发生故障，我们可以通过数据库层面来控制流量切换，也可以在业务的服务层进行配置，统一执行。推荐的做法是由数据库层面进行流量切换，因为这种方式更灵活、更快，同时呢，也能降低业务操作带来的风险。</li>\n</ul><p>注意，虽然流量切换是一种有效的手段，但在执行前必须进行充分的容量评估和准备。在高峰期进行流量切换时，需要确保目标机房有足够的容量来承载转移过来的流量。</p><p>扩容相关的预案你可以看一下前面<a href=\"https://time.geekbang.org/column/article/793332\">容量</a>那一讲里的详细介绍，这里我就不重复了。</p><h3><strong>重启</strong></h3><p>重启服务是一种常见的预案手段，但它也具有潜在的风险。因此在执行重启操作时，必须谨慎地分级进行，在紧急情况下也要考虑操作的影响范围。之前我遇到过一个案例，一个关键的核心服务在业务更新后长时间未进行重启。当服务出现故障时，预案中的一个环节是执行降级重启，即修改配置文件并重启服务。当时因为配置跟代码不匹配导致重启失败，最终扩散到了整个服务，核心功能瘫痪了一个多小时。</p><p>如果确实需要进行重启，务必要实施分级重启策略，并且在每次重启后仔细观察，确保服务运行正常。只有在确认无误后，才能继续下一步的重启操作。通过这种方式，我们可以最大限度地减少因重启导致的服务中断风险。</p><h3><strong>降级</strong></h3><p>降级旨在确保服务在面临资源限制或故障时仍能保持关键功能的运行。所以降级的主要目的其实有两个：资源重新分配和故障屏蔽隔离。</p><p><strong>资源重新分配</strong>：当系统容量不足时，通过降级非核心服务来释放资源，优先保障核心功能或服务的运行。例如，在网盘服务中，可以暂停在线转码和个性化推荐等非核心功能；在搜索服务中，可以减少搜索结果的数量和实时性；短视频平台可以降低推荐内容的实时性和页面大小，移除电商、直播等商业化元素；电商平台则可以保留商品图片展示，降低或移除视频内容和个性化推荐。</p><p><strong>故障屏蔽隔离</strong>：在服务出现问题难以迅速定位或恢复的时候，通过逐步降级非核心服务，来达到快速恢复的目的。例如，在一个大规模故障中，如果不确定是哪个接口导致的问题，可以通过逐步降级各个接口来定位问题源头。逐一移除二级接口，如果问题依旧，继续简化至一级服务，并逐一检查一级服务的每个接口，直至找到故障原因并恢复服务。</p><p>下面我们来看下实施降级的具体策略。</p><ul>\n<li><strong>梳理和分级</strong>：首先，我们需要梳理服务和接口，把它们分成三个等级。第一级是最关键的服务和接口；第二级是比较重要的服务和接口；第三级就是那些非核心的可以增加用户体验的接口。</li>\n<li><strong>设置明确的开关</strong>：确保有明确的降级开关，并保持上下游服务的连续性。避免出现下游服务已降级，而上游服务仍在不断重试的情况，这可能导致更严重的后果。必须确保上下游服务同步降级，并能识别降级状态。</li>\n<li><strong>演练</strong>：由于降级是一个有损的操作，必须通过演练来验证预案的可靠性。演练可以从测试环境开始，逐步过渡到线上灰度环境（针对特定用户群体），再到线上部分环境（按比例进行）。在演练过程中，要注意控制影响范围，确保不会对生产环境造成不必要的损害。</li>\n</ul><h3><strong>限流</strong></h3><p>限流是确保系统稳定性和性能的关键策略，主要通过<strong>控制并发数和请求量</strong>来实现。并发数是指系统能同时处理的任务数量。请求量是指单位时间内系统接收的请求总数。最常见的两种限流算法令牌桶和漏桶算法。</p><p>最后注意的是限流一定要多层进行，7层限流、waf限流、服务层限流、DB限流。同时限流一定要依次往下减少，因为上游是对下游的保护。</p><p><img src=\"https://static001.geekbang.org/resource/image/78/bf/786503c2d914a192468de403da363abf.png?wh=1652x934\" alt=\"图片\"></p><h3><strong>回滚</strong></h3><p>在当前普遍采用Kubernetes进行部署的环境下，回滚操作可以视为一次新的部署过程。通常分为分批和蓝绿两种策略，它们各有优势和局限性。</p><p><strong>分批回滚</strong>是一种逐步替换旧实例（老版本）的部署方法，通过逐个替换为新实例（新版本），实现服务的平滑过渡。在这个过程中，新旧实例会短暂共存。这种方法的优势在于操作简单，资源消耗相对较少。然而，它的主要缺点是在更新过程中，新旧实例可能因为同时存在，增加了系统不稳定的风险。</p><p><strong>蓝绿回滚</strong>涉及同时运行两个完全独立的环境——蓝色环境（旧版本）和绿色环境（新版本）。当新版本准备就绪后，流量会从蓝色环境切换到绿色环境。如果新版本出现问题，可以迅速将流量切回蓝色环境，实现快速回滚。这种方式的优点是能够快速响应问题并保持服务的稳定性，同时新旧版本之间相互隔离，减少了相互影响的风险。不过，蓝绿部署的缺点在于资源消耗较大，因为它需要同时维护两套独立、完整的环境。</p><h2><img src=\"https://static001.geekbang.org/resource/image/bd/8e/bd16498c815bcc31b9a199bba530b68e.png?wh=1900x710\" alt=\"图片\"></h2><h2>如何保障预案有效执行？</h2><p>这里我分享一下我的经验。在故障学习方面，我们不仅要回顾以往的故障预案，更要深入研究经典案例，学习他人的问题处理经验。在主动演练方面，应定期进行预案演练，确保每个人都能熟练运用。此外，通过不定期实施故障注入，即目前流行的混沌工程方法，检验团队对突发情况的响应速度和应急能力。</p><h3>定期演练</h3><p>通过对关键服务进行定期的故障演练，我们可以在真正的业务故障发生之前识别潜在的弱点和风险点，并制定相应的应对措施。这种做法不仅能增强团队对服务的信心，还能提高处理突发事件的能力。演练的频率最好是每月一次，如果时间间隔太久的话，演练可能就会失去作用。</p><p>此外，这里还需要明确一下几个关键点。</p><ul>\n<li><strong>定义清晰的触发条件</strong>：明确在何种场景和标准下可以启动预案。例如，如果直播服务无法建立新的长连接，且单列请求量下降超过90%。</li>\n<li><strong>量化的决策指标</strong>：设定可量化的指标来指导决策。例如，如果下游风控服务不可用导致API整体延迟超过预定阈值，并且故障持续时间超过10分钟。</li>\n<li><strong>可观测性</strong>：确保故障发生和预案执行后，系统是可观测的。这意味着需要有适当的监控和日志记录系统来追踪系统状态。</li>\n<li><strong>简单明了的执行步骤</strong>：预案的执行步骤应该清晰、简洁，并经过实践验证。这有助于在紧急情况下快速且无误地执行预案。</li>\n<li><strong>可回滚性</strong>：在故障得到解决后，应能够对预案执行的结果进行回滚。</li>\n</ul><h2>小结</h2><p>最后我想分享一下自己这些年在做预案的过程中的一些心得。</p><p>在处理问题的时候，应该优先考虑无损预案，也就是那些不会引入新问题的解决方案。在需要迅速响应的情况下，要选择那些能够快速生效的预案。通常流量切换会比回滚生效更快，切流一般在1分钟内，而回滚可能需要5～10分钟。</p><p>在紧急情况下，简单直接的预案往往更可靠，减少了执行过程中出错的可能性。在上线过程中如果出现问题，比如你可以选择回滚或修改代码重新上线两种方案。如果选择了修改代码的方案，但由于时间紧迫导致修改不正确引发更大的问题，所以要优先通过回滚来解决问题。</p><p>这里我给你一个预案场景的列表与演练模版，你可以参考。</p><p><img src=\"https://static001.geekbang.org/resource/image/05/70/051351bd450a48087a6be04c98e5d870.jpg?wh=1856x3016\" alt=\"图片\"></p><h2>思考题</h2><p>如果在上线过程中出现故障，同时也出现了容量过载的情况，你应该如何处理呢？欢迎你把思考后的结果分享到评论区，和我一起交流，如果你觉得这节课的内容对你有帮助的话，也欢迎你分享给其他朋友，邀他一起学习。我们下节课再见！</p>","neighbors":{"left":{"article_title":"03｜变更：为什么说变更是可靠性的第一杀手？","id":793365},"right":{"article_title":"05｜备份和恢复：可靠性的最后一道防线","id":794990}},"comments":[{"had_liked":false,"id":392775,"user_name":"枕畔雪","can_delete":false,"product_type":"c1","uid":1258675,"ip_address":"北京","ucode":"F2932722CB7CC4","user_header":"https://static001.geekbang.org/account/avatar/00/13/34/b3/cf70e0f5.jpg","comment_is_top":false,"comment_ctime":1721735523,"is_pvip":false,"replies":[{"id":142717,"content":"👍 写的很透彻","user_name":"作者回复","user_name_real":"编辑","uid":1186099,"ctime":1722054121,"ip_address":"北京","comment_id":392775,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100781001,"comment_content":"拆开来看：\n1.变更操作故障的通用解法：回滚。\n2.容量过载故障的通用解法：限流、扩容、降级非核心。\n\n综合场景来：\n一、快速止损：\n1.先判断影响范围，如果故障集中在单可用区，且容量足够的话，第一时间切流到其他正常可用区，并迅速回滚。\n2.如果故障集中在多可用区或者其他可用区容量不足，无法通过切部署中心快速恢复，处置效率就会直线降低。按照先止损再定位的思路做处置，止损思路如下：1.）优先回滚 2.）入口侧按照容量上限做限流，保障可承担请求的服务质量 3.）并行做扩容、降级处置。 PS：整体过程要考虑到流量、实例规模变化带来的连接数突增、缓存压力增大等链路影响。\n二、快速定位：\n思路：一般情况下变更和容量过载关联性不大，也就是说很可能容量过载是由其他因素导致，这里分两种场景。\n1.容量过载是当前变更导致：大概率是代码 bug 引起流量放大。比如 并发数设置异常引发大量请求、各级缓存策略异常导致穿透、限流策略异常、风控策略异常等等。\n2.容量过载不是当前变更导致：可能是突发热点事件导致用户请求变多，可能是上游应用调整导致主调并发数变多，可能是外部攻击等等。\n\n最后，无论属于哪种情况，优先止损是第一原则，除非特殊情况，故障发生点的一切引起系统熵增的变更都应该迅速回滚。","like_count":3,"discussions":[{"author":{"id":1186099,"avatar":"https://static001.geekbang.org/account/avatar/00/12/19/33/b0907af9.jpg","nickname":"白园","note":"","ucode":"929F252AD1F5F3","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":648720,"discussion_content":"👍 写的很透彻","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1722054121,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":394592,"user_name":"怀揣梦想的学渣","can_delete":false,"product_type":"c1","uid":1916685,"ip_address":"山东","ucode":"2349B9F4F6FDE3","user_header":"https://static001.geekbang.org/account/avatar/00/1d/3f/0d/1e8dbb2c.jpg","comment_is_top":false,"comment_ctime":1727253979,"is_pvip":true,"replies":[{"id":143884,"content":"预案可回滚主要是防止错误的预案导致更大的故障","user_name":"作者回复","user_name_real":"编辑","uid":1186099,"ctime":1734090237,"ip_address":"北京","comment_id":394592,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100781001,"comment_content":"咨询一下，文中提到故障处理后，预案操作可回滚。我没能理解这部分，回滚预案操作不会导致已处理的故障复现吗。","like_count":0,"discussions":[{"author":{"id":1186099,"avatar":"https://static001.geekbang.org/account/avatar/00/12/19/33/b0907af9.jpg","nickname":"白园","note":"","ucode":"929F252AD1F5F3","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":655084,"discussion_content":"预案可回滚主要是防止错误的预案导致更大的故障","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1734090237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":393058,"user_name":"书豪","can_delete":false,"product_type":"c1","uid":1337725,"ip_address":"北京","ucode":"CBC75BC712B915","user_header":"https://static001.geekbang.org/account/avatar/00/14/69/7d/59143808.jpg","comment_is_top":false,"comment_ctime":1722644428,"is_pvip":false,"replies":[{"id":142798,"content":"这个思考挺好的。 这个思路也没有问题，是另一种逻辑，大促期间就是这种。 文章中介绍的日常情况下通常的思路，容量是从上往下依次衰减的，需要让资源最大化。如果利用正三角的方式限流，则下流的限流将会失去意义，同时资源就无法充分的使用。比如上游限流8000，下游10000，那下游剩余的2000的资源将永远无法使用。另外就是上游的一般是NG或者lb等吞吐很强的组件，资源消耗不多，所以浪费也是有限的。同时也需要给下游扩容留出空间。","user_name":"作者回复","user_name_real":"作者","uid":1186099,"ctime":1723024531,"ip_address":"北京","comment_id":393058,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100781001,"comment_content":"限流的漏斗模型应该是反的，如果上游限10000，下游限8000，那么在流量9000时，上游放行下游拦截且是强依赖，则上游的请求处理白费了系统资源","like_count":0,"discussions":[{"author":{"id":1251111,"avatar":"https://static001.geekbang.org/account/avatar/00/13/17/27/ec30d30a.jpg","nickname":"Jxin","note":"","ucode":"4C03928388C413","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":650987,"discussion_content":"从上到下流量逐层减少没问题吧。 毕竟限流的粒度有差异，比如上游限制1W，下游有两个实例，各限制8k，合起来能支撑1.6W，没啥毛病呀。 为啥下游不是各5k？ 虽然有负载均衡策略，但是可能集群规模有差异，也可能突发情况要某一边集群多承接一些流量（请求平均分了，但左边给的都是100个详情的大订单，右边都是一个详情的订单。单请求的RT差距大，并行连接数的增速也会拉开），按资源情况和业务场景适当调整撒。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1726021371,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"新加坡","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1186099,"avatar":"https://static001.geekbang.org/account/avatar/00/12/19/33/b0907af9.jpg","nickname":"白园","note":"","ucode":"929F252AD1F5F3","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":649239,"discussion_content":"这个思考挺好的。 这个思路也没有问题，是另一种逻辑，大促期间就是这种。 文章中介绍的日常情况下通常的思路，容量是从上往下依次衰减的，需要让资源最大化。如果利用正三角的方式限流，则下流的限流将会失去意义，同时资源就无法充分的使用。比如上游限流8000，下游10000，那下游剩余的2000的资源将永远无法使用。另外就是上游的一般是NG或者lb等吞吐很强的组件，资源消耗不多，所以浪费也是有限的。同时也需要给下游扩容留出空间。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1723024531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":392728,"user_name":"奔跑的阿飞","can_delete":false,"product_type":"c1","uid":1135314,"ip_address":"浙江","ucode":"E4850EC5BFBBC3","user_header":"https://static001.geekbang.org/account/avatar/00/11/52/d2/a0a800e9.jpg","comment_is_top":false,"comment_ctime":1721634904,"is_pvip":false,"replies":[{"id":142720,"content":"是解决方案之一，没问题","user_name":"作者回复","user_name_real":"编辑","uid":1186099,"ctime":1722054292,"ip_address":"北京","comment_id":392728,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100781001,"comment_content":"尝试回答一下：上线过程中出现故障，应该是上线导致的故障，这时候应该快速回滚。同时出现容量过载，可能是出现故障导致的雪崩效应，可以通过自动扩容或降级不分非核心业务措施处理。","like_count":0,"discussions":[{"author":{"id":1186099,"avatar":"https://static001.geekbang.org/account/avatar/00/12/19/33/b0907af9.jpg","nickname":"白园","note":"","ucode":"929F252AD1F5F3","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":648723,"discussion_content":"是解决方案之一，没问题","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1722054292,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"北京","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2077348,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEJoUy5PB5xHX4bMhOJIAmbp459Kg0f8frQrPzgUyeiaCmuLr1RicyQrpzcIQLicvUgXR2khcibE1RxJOwqWpNYDW5gF0XOt5E5pQBfj4n2uH4zJtQ/132","nickname":"Geek_9201a6","note":"","ucode":"411D3D7C9EE887","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":648545,"discussion_content":"这里还有个问题，目前大家普遍使用k8s，部分工作负载如deployment无法指定版本快速扩容，此时如果是单机房阶段应该考虑切流，全量阶段应该考虑降级","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1721785531,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"广东","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}