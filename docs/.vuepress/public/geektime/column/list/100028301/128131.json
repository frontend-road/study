{"id":128131,"title":"41 | lua-resty-* å°è£…ï¼Œè®©ä½ è¿œç¦»å¤šçº§ç¼“å­˜ä¹‹ç—›","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯æ¸©é“­ã€‚</p><p>å‰é¢ä¸¤èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº† OpenResty ä¸­çš„ç¼“å­˜ï¼Œä»¥åŠå®¹æ˜“å‡ºé”™çš„ç¼“å­˜é£æš´é—®é¢˜ï¼Œè¿™äº›éƒ½æ˜¯å±äºååŸºç¡€çš„ä¸€äº›çŸ¥è¯†ã€‚åœ¨å®é™…çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œå¼€å‘è€…è‡ªç„¶æ›´å¸Œæœ›æœ‰ä¸€ä¸ªå·²ç»æŠŠå„ç§ç»†èŠ‚å¤„ç†å¥½å¹¶éšè—èµ·æ¥çš„å¼€ç®±å³ç”¨çš„åº“ï¼Œå¯ä»¥æ‹¿æ¥ç›´æ¥å¼€å‘ä¸šåŠ¡ä»£ç ã€‚</p><p>è¿™å…¶å®å°±æ˜¯åˆ†å·¥çš„ä¸€ä¸ªå¥½å¤„ï¼ŒåŸºç¡€ç»„ä»¶çš„å¼€å‘è€…ï¼Œé‡å¿ƒåœ¨äºæ¶æ„çµæ´»ã€æ€§èƒ½æè‡´ã€ä»£ç ç¨³å®šï¼Œå¹¶ä¸éœ€è¦å…³å¿ƒä¸Šå±‚ä¸šåŠ¡é€»è¾‘ï¼›è€Œåº”ç”¨å±‚çš„å·¥ç¨‹å¸ˆï¼Œæ›´å…³å¿ƒçš„æ˜¯ä¸šåŠ¡å®ç°å’Œå¿«é€Ÿè¿­ä»£ï¼Œå¹¶ä¸å¸Œæœ›è¢«åº•å±‚çš„å„ç§æŠ€æœ¯ç»†èŠ‚åˆ†å¿ƒã€‚è¿™ä¸­é—´çš„é¸¿æ²Ÿï¼Œå°±éœ€è¦æœ‰ä¸€äº›å°è£…åº“æ¥å¡«å¹³äº†ã€‚</p><p>OpenResty ä¸­çš„ç¼“å­˜ï¼Œä¹Ÿé¢ä¸´ä¸€æ ·çš„é—®é¢˜ã€‚å…±äº«å­—å…¸å’Œ lru ç¼“å­˜è¶³å¤Ÿç¨³å®šå’Œé«˜æ•ˆï¼Œä½†éœ€è¦å¤„ç†å¤ªå¤šçš„ç»†èŠ‚ã€‚å¦‚æœæ²¡æœ‰ä¸€äº›å¥½ç”¨çš„å°è£…ï¼Œé‚£ä¹ˆåˆ°è¾¾åº”ç”¨å¼€å‘å·¥ç¨‹å¸ˆçš„â€œæœ€åä¸€å…¬é‡Œâ€ï¼Œå°±ä¼šå˜å¾—æ¯”è¾ƒç—›è‹¦ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±è¦ä½“ç°ç¤¾åŒºçš„é‡è¦æ€§äº†ã€‚ä¸€ä¸ªæ´»è·ƒçš„ç¤¾åŒºï¼Œä¼šä¸»åŠ¨å»å‘ç°é¸¿æ²Ÿï¼Œå¹¶è¿…é€Ÿåœ°å¡«å¹³ã€‚</p><h2>lua-resty-memcached-shdict</h2><p>è®©æˆ‘ä»¬å›åˆ°ç¼“å­˜çš„å°è£…ä¸Šæ¥ã€‚<code>lua-resty-memcached-shdict</code> æ˜¯ OpenResty å®˜æ–¹çš„ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒä½¿ç”¨ shared dict ä¸º memcached åšäº†ä¸€å±‚å°è£…ï¼Œå¤„ç†äº†ç¼“å­˜é£æš´å’Œè¿‡æœŸæ•°æ®ç­‰ç»†èŠ‚ã€‚å¦‚æœä½ çš„ç¼“å­˜æ•°æ®æ­£å¥½å­˜å‚¨åœ¨åç«¯çš„ memcached ä¸­ï¼Œé‚£ä¹ˆä½ å¯ä»¥å°è¯•ä½¿ç”¨è¿™ä¸ªåº“ã€‚</p><!-- [[[read_end]]] --><p>å®ƒè™½ç„¶æ˜¯ OpenResty å®˜æ–¹å¼€å‘çš„åº“ï¼Œä½†é»˜è®¤å¹¶æ²¡æœ‰æ‰“è¿› OpenResty çš„åŒ…ä¸­ã€‚å¦‚æœä½ æƒ³åœ¨æœ¬åœ°æµ‹è¯•ï¼Œéœ€è¦å…ˆæŠŠå®ƒçš„<a href=\"https://github.com/openresty/lua-resty-memcached-shdict\">æºç </a>ä¸‹è½½åˆ°æœ¬åœ° OpenResty çš„æŸ¥æ‰¾è·¯å¾„ä¸‹ã€‚</p><p>è¿™ä¸ªå°è£…åº“ï¼Œå…¶å®å’Œæˆ‘ä»¬ä¸ŠèŠ‚è¯¾ä¸­æåˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸€æ ·çš„ã€‚å®ƒä½¿ç”¨ <code>lua-resty-lock</code> æ¥åšåˆ°äº’æ–¥ï¼Œåœ¨ç¼“å­˜å¤±æ•ˆçš„æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªè¯·æ±‚å» memcached ä¸­è·å–æ•°æ®ï¼Œé¿å…ç¼“å­˜é£æš´ã€‚å¦‚æœæ²¡æœ‰è·å–åˆ°æœ€æ–°æ•°æ®ï¼Œåˆ™ä½¿ç”¨ stale æ•°æ®è¿”å›ç»™ç»ˆç«¯ã€‚</p><p>ä¸è¿‡ï¼Œè¿™ä¸ª lua-resty åº“è™½è¯´æ˜¯ OpenResty å®˜æ–¹çš„é¡¹ç›®ï¼Œä½†ä¹Ÿå¹¶ä¸å®Œç¾ã€‚é¦–å…ˆï¼Œå®ƒæ²¡æœ‰æµ‹è¯•æ¡ˆä¾‹è¦†ç›–ï¼Œè¿™å°±æ„å‘³ç€ä»£ç è´¨é‡æ— æ³•å¾—åˆ°æŒç»­çš„ä¿è¯ï¼›å…¶æ¬¡ï¼Œå®ƒæš´éœ²çš„æ¥å£å‚æ•°è¿‡å¤šï¼Œæœ‰ 11 ä¸ªå¿…å¡«å‚æ•°å’Œ 7 ä¸ªé€‰å¡«å‚æ•°ï¼š</p><pre><code>local memc_fetch, memc_store =\n    shdict_memc.gen_memc_methods{\n        tag = &quot;my memcached server tag&quot;,\n        debug_logger = dlog,\n        warn_logger = warn,\n        error_logger = error_log,\n\n        locks_shdict_name = &quot;some_lua_shared_dict_name&quot;,\n\n        shdict_set = meta_shdict_set,  \n        shdict_get = meta_shdict_get,  \n\n        disable_shdict = false,  -- optional, default false\n\n        memc_host = &quot;127.0.0.1&quot;,\n        memc_port = 11211,\n        memc_timeout = 200,  -- in ms\n        memc_conn_pool_size = 5,\n        memc_fetch_retries = 2,  -- optional, default 1\n        memc_fetch_retry_delay = 100, -- in ms, optional, default to 100 (ms)\n\n        memc_conn_max_idle_time = 10 * 1000,  -- in ms, for in-pool connections,optional, default to nil\n\n        memc_store_retries = 2,  -- optional, default to 1\n        memc_store_retry_delay = 100,  -- in ms, optional, default to 100 (ms)\n\n        store_ttl = 1,  -- in seconds, optional, default to 0 (i.e., never expires)\n    }\n</code></pre><p>è¿™å…¶ä¸­æš´éœ²çš„ç»å¤§éƒ¨åˆ†å‚æ•°ï¼Œå…¶å®å¯ä»¥é€šè¿‡â€œæ–°å»ºä¸€ä¸ª memcached çš„å¤„ç†å‡½æ•°â€çš„æ–¹å¼æ¥ç®€åŒ–ã€‚å½“å‰è¿™ç§æŠŠæ‰€æœ‰å‚æ•°ä¸€è‚¡è„‘å„¿åœ°ä¸¢ç»™ç”¨æˆ·æ¥å¡«å†™çš„å°è£…æ–¹å¼å¹¶ä¸å‹å¥½ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä¹Ÿå¾ˆæ¬¢è¿æœ‰å…´è¶£çš„å¼€å‘è€…ï¼Œè´¡çŒ® PR æ¥åšè¿™æ–¹é¢çš„ä¼˜åŒ–ã€‚</p><p>å¦å¤–ï¼Œåœ¨è¿™ä¸ªå°è£…åº“çš„æ–‡æ¡£ä¸­ï¼Œå…¶å®ä¹Ÿæåˆ°äº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–æ–¹å‘ï¼š</p><ul>\n<li>ä¸€æ˜¯ä½¿ç”¨ <code>lua-resty-lrucache</code> ï¼Œæ¥å¢åŠ  worker å±‚çš„ç¼“å­˜ï¼Œè€Œä¸ä»…ä»…æ˜¯ server çº§åˆ«çš„ shared dict ç¼“å­˜ï¼›</li>\n<li>äºŒæ˜¯ä½¿ç”¨ <code>ngx.timer</code> ï¼Œæ¥åšå¼‚æ­¥çš„ç¼“å­˜æ›´æ–°æ“ä½œã€‚</li>\n</ul><p>ç¬¬ä¸€ä¸ªæ–¹å‘å…¶å®æ˜¯å¾ˆä¸é”™çš„å»ºè®®ï¼Œå› ä¸º worker å†…çš„ç¼“å­˜æ€§èƒ½è‡ªç„¶ä¼šæ›´å¥½ï¼›è€Œç¬¬äºŒä¸ªå»ºè®®ï¼Œå°±éœ€è¦ä½ æ ¹æ®è‡ªå·±çš„å®é™…åœºæ™¯æ¥è€ƒé‡äº†ã€‚ä¸è¿‡ï¼Œä¸€èˆ¬æˆ‘å¹¶ä¸æ¨èä½¿ç”¨ï¼Œè¿™ä¸ä»…æ˜¯å› ä¸º timer çš„æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œè€Œä¸”å¦‚æœè¿™é‡Œçš„æ›´æ–°é€»è¾‘å‡ºé”™ï¼Œå°±å†ä¹Ÿä¸ä¼šå»æ›´æ–°ç¼“å­˜äº†ï¼Œå½±å“é¢æ¯”è¾ƒå¤§ã€‚</p><h2>lua-resty-mlcache</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥ä»‹ç»ä¸‹ï¼Œåœ¨ OpenResty ä¸­è¢«æ™®éä½¿ç”¨çš„ç¼“å­˜å°è£…ï¼š <code>lua-resty-mlcache</code>ã€‚å®ƒä½¿ç”¨ shared dict å’Œ lua-resty-lrucache ï¼Œå®ç°äº†å¤šå±‚ç¼“å­˜æœºåˆ¶ã€‚æˆ‘ä»¬ä¸‹é¢å°±é€šè¿‡ä¸¤æ®µä»£ç ç¤ºä¾‹ï¼Œæ¥çœ‹çœ‹è¿™ä¸ªåº“å¦‚ä½•ä½¿ç”¨ï¼š</p><pre><code>local mlcache = require &quot;resty.mlcache&quot;\n\nlocal cache, err = mlcache.new(&quot;cache_name&quot;, &quot;cache_dict&quot;, {\n    lru_size = 500,    -- size of the L1 (Lua VM) cache\n    ttl = 3600,   -- 1h ttl for hits\n    neg_ttl  = 30,     -- 30s ttl for misses\n})\nif not cache then\n    error(&quot;failed to create mlcache: &quot; .. err)\nend\n</code></pre><p>å…ˆæ¥çœ‹ç¬¬ä¸€æ®µä»£ç ã€‚è¿™æ®µä»£ç çš„å¼€å¤´å¼•å…¥äº† mlcache åº“ï¼Œå¹¶è®¾ç½®äº†åˆå§‹åŒ–çš„å‚æ•°ã€‚æˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠè¿™æ®µä»£ç æ”¾åˆ° init é˜¶æ®µï¼Œåªéœ€è¦åšä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>é™¤äº†ç¼“å†²åå’Œå­—å…¸åè¿™ä¸¤ä¸ªå¿…å¡«çš„å‚æ•°å¤–ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œé‡Œé¢ 12 ä¸ªé€‰é¡¹éƒ½æ˜¯é€‰å¡«çš„ï¼Œä¸å¡«çš„è¯å°±ä½¿ç”¨é»˜è®¤å€¼ã€‚è¿™ç§æ–¹å¼æ˜¾ç„¶å°±æ¯” <code>lua-resty-memcached-shdict</code> è¦ä¼˜é›…å¾ˆå¤šã€‚å…¶å®ï¼Œæˆ‘ä»¬è‡ªå·±æ¥è®¾è®¡æ¥å£çš„è¯ï¼Œä¹Ÿæœ€å¥½é‡‡ç”¨ mlcache è¿™æ ·çš„åšæ³•â€”â€”è®©æ¥å£å°½å¯èƒ½åœ°ç®€å•ï¼ŒåŒæ—¶è¿˜ä¿ç•™è¶³å¤Ÿçš„çµæ´»æ€§ã€‚</p><p>ä¸‹é¢å†æ¥çœ‹ç¬¬äºŒæ®µä»£ç ï¼Œè¿™æ˜¯è¯·æ±‚å¤„ç†æ—¶çš„é€»è¾‘ä»£ç ï¼š</p><pre><code>local function fetch_user(id)\n    return db:query_user(id)\nend\n\nlocal id = 123\nlocal user , err = cache:get(id , nil , fetch_user , id)\nif err then\n    ngx.log(ngx.ERR , &quot;failed to fetch user: &quot;, err)\n    return\nend\n\nif user then\n    print(user.id) -- 123\nend\n</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå·²ç»æŠŠå¤šå±‚ç¼“å­˜éƒ½ç»™éšè—äº†ï¼Œä½ åªéœ€è¦ä½¿ç”¨ mlcache çš„å¯¹è±¡å»è·å–ç¼“å­˜ï¼Œå¹¶åŒæ—¶è®¾ç½®å¥½ç¼“å­˜å¤±æ•ˆåçš„å›è°ƒå‡½æ•°å°±å¯ä»¥äº†ã€‚è¿™èƒŒåå¤æ‚çš„é€»è¾‘ï¼Œå°±å¯ä»¥è¢«å®Œå…¨åœ°éšè—äº†ã€‚</p><p>è¯´åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½å¥½å¥‡ï¼Œè¿™ä¸ªåº“å†…éƒ¨ç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥ï¼Œå†è®©æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªåº“çš„æ¶æ„å’Œå®ç°ã€‚ä¸‹é¢è¿™å¼ å›¾ï¼Œæ¥è‡ª mlcache çš„ä½œè€… thibault åœ¨ 2018 å¹´ OpenResty å¤§ä¼šä¸Šæ¼”è®²çš„å¹»ç¯ç‰‡ï¼š</p><p><img src=\"https://static001.geekbang.org/resource/image/19/97/19a701636a95e931e6a9a8d0127e4f97.png?wh=1709*1121\" alt=\"\"></p><p>ä»å›¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œmlcache æŠŠæ•°æ®åˆ†ä¸ºäº†ä¸‰å±‚ï¼Œå³L1ã€L2å’ŒL3ã€‚</p><p>L1 ç¼“å­˜å°±æ˜¯ lua-resty-lrucacheã€‚æ¯ä¸€ä¸ª worker ä¸­éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸€ä»½ï¼Œæœ‰ N ä¸ª workerï¼Œå°±ä¼šæœ‰ N ä»½æ•°æ®ï¼Œè‡ªç„¶ä¹Ÿå°±å­˜åœ¨æ•°æ®å†—ä½™ã€‚ç”±äºåœ¨å• worker å†…æ“ä½œ lrucache ä¸ä¼šè§¦å‘é”ï¼Œæ‰€ä»¥å®ƒçš„æ€§èƒ½æ›´é«˜ï¼Œé€‚åˆä½œä¸ºç¬¬ä¸€çº§ç¼“å­˜ã€‚</p><p>L2 ç¼“å­˜æ˜¯ shared dictã€‚æ‰€æœ‰çš„ worker å…±ç”¨ä¸€ä»½ç¼“å­˜æ•°æ®ï¼Œåœ¨ L1 ç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šæ¥æŸ¥è¯¢ L2 ç¼“å­˜ã€‚ngx.shared.DICT æä¾›çš„ APIï¼Œä½¿ç”¨äº†è‡ªæ—‹é”æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¹¶ä¸ç”¨æ‹…å¿ƒç«äº‰çš„é—®é¢˜ï¼›</p><p>L3 åˆ™æ˜¯åœ¨ L2 ç¼“å­˜ä¹Ÿæ²¡æœ‰å‘½ä¸­çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ‰§è¡Œå›è°ƒå‡½æ•°å»å¤–éƒ¨æ•°æ®åº“ç­‰æ•°æ®æºæŸ¥è¯¢åï¼Œå†ç¼“å­˜åˆ° L2 ä¸­ã€‚åœ¨è¿™é‡Œï¼Œä¸ºäº†é¿å…ç¼“å­˜é£æš´ï¼Œå®ƒä¼šä½¿ç”¨ lua-resty-lock ï¼Œæ¥ä¿è¯åªæœ‰ä¸€ä¸ª worker å»æ•°æ®æºè·å–æ•°æ®ã€‚</p><p>æ•´ä½“è€Œè¨€ï¼Œä»è¯·æ±‚çš„è§’åº¦æ¥çœ‹ï¼Œ</p><ul>\n<li>é¦–å…ˆä¼šå»æŸ¥è¯¢ worker å†…çš„ L1 ç¼“å­˜ï¼Œå¦‚æœL1å‘½ä¸­å°±ç›´æ¥è¿”å›ã€‚</li>\n<li>å¦‚æœL1æ²¡æœ‰å‘½ä¸­æˆ–è€…ç¼“å­˜å¤±æ•ˆï¼Œå°±ä¼šå»æŸ¥è¯¢ worker é—´çš„ L2 ç¼“å­˜ã€‚å¦‚æœL2å‘½ä¸­å°±è¿”å›ï¼Œå¹¶æŠŠç»“æœç¼“å­˜åˆ° L1 ä¸­ã€‚</li>\n<li>å¦‚æœL2 ä¹Ÿæ²¡æœ‰å‘½ä¸­æˆ–è€…ç¼“å­˜å¤±æ•ˆï¼Œå°±ä¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œä»æ•°æ®æºä¸­æŸ¥åˆ°æ•°æ®ï¼Œå¹¶å†™å…¥åˆ° L2 ç¼“å­˜ä¸­ï¼Œè¿™ä¹Ÿå°±æ˜¯L3æ•°æ®å±‚çš„åŠŸèƒ½ã€‚</li>\n</ul><p>ä»è¿™ä¸ªè¿‡ç¨‹ä½ ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç¼“å­˜çš„æ›´æ–°æ˜¯ç”±ç»ˆç«¯è¯·æ±‚æ¥è¢«åŠ¨è§¦å‘çš„ã€‚å³ä½¿æŸä¸ªè¯·æ±‚è·å–ç¼“å­˜å¤±è´¥äº†ï¼Œåç»­çš„è¯·æ±‚ä¾ç„¶å¯ä»¥è§¦å‘æ›´æ–°çš„é€»è¾‘ï¼Œä»¥ä¾¿æœ€å¤§ç¨‹åº¦åœ°ä¿è¯ç¼“å­˜çš„å®‰å…¨æ€§ã€‚</p><p>ä¸è¿‡ï¼Œè™½ç„¶ mlcache å·²ç»å®ç°å¾—æ¯”è¾ƒå®Œç¾äº†ï¼Œä½†åœ¨ç°å®ä½¿ç”¨ä¸­ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªç—›ç‚¹â€”â€”æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚è¿™ä¸ªå…¶å®å¹¶ä¸æ˜¯ mlcache çš„é—®é¢˜ï¼Œè€Œæ˜¯æˆ‘ä»¬ä¹‹å‰åå¤æåˆ°çš„  lrucache å’Œ shared dict ä¹‹é—´çš„å·®å¼‚é€ æˆçš„ã€‚åœ¨ lrucache ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å­˜å‚¨ Lua çš„å„ç§æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬ tableï¼›ä½† shared dict ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ã€‚</p><p>L1 ä¹Ÿå°±æ˜¯ lrucache ç¼“å­˜ï¼Œæ˜¯ç”¨æˆ·çœŸæ­£æ¥è§¦åˆ°çš„é‚£ä¸€å±‚æ•°æ®ï¼Œæˆ‘ä»¬è‡ªç„¶å¸Œæœ›åœ¨å…¶ä¸­å¯ä»¥ç¼“å­˜å„ç§æ•°æ®ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ã€tableã€cdata ç­‰ã€‚å¯æ˜¯ï¼Œé—®é¢˜åœ¨äºï¼Œ L2 ä¸­åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ã€‚é‚£ä¹ˆï¼Œå½“æ•°æ®ä» L2 æå‡åˆ° L1 çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦åšä¸€å±‚è½¬æ¢ï¼Œä¹Ÿå°±æ˜¯ä»å­—ç¬¦ä¸²è½¬æˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ç»™ç”¨æˆ·çš„æ•°æ®ç±»å‹ã€‚</p><p>è¿˜å¥½ï¼Œmlcache å·²ç»è€ƒè™‘åˆ°äº†è¿™ç§æƒ…å†µï¼Œå¹¶åœ¨ <code>new</code> å’Œ <code>get</code> æ¥å£ä¸­ï¼Œæä¾›äº†å¯é€‰çš„å‡½æ•° <code>l1_serializer</code>ï¼Œä¸“é—¨ç”¨äºå¤„ç† L2 æå‡åˆ° L1 æ—¶å¯¹æ•°æ®çš„å¤„ç†ã€‚æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼Œå®ƒæ˜¯æˆ‘ä»æµ‹è¯•æ¡ˆä¾‹é›†ä¸­æ‘˜é€‰å‡ºæ¥çš„ï¼š</p><pre><code>local mlcache = require &quot;resty.mlcache&quot;\n\nlocal cache, err = mlcache.new(&quot;my_mlcache&quot;, &quot;cache_shm&quot;, {\nl1_serializer = function(i)\n    return i + 2\nend,\n})\n\nlocal function callback()\n    return 123456\nend\n\nlocal data = assert(cache:get(&quot;number&quot;, nil, callback))\nassert(data == 123458)\n</code></pre><p>ç®€å•è§£é‡Šä¸€ä¸‹ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œå›è°ƒå‡½æ•°è¿”å›æ•°å­— 123456ï¼›è€Œåœ¨ <code>new</code> ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®çš„ <code>l1_serializer</code> å‡½æ•°ä¼šåœ¨è®¾ç½® L1 ç¼“å­˜å‰ï¼ŒæŠŠä¼ å…¥çš„æ•°å­—åŠ  2ï¼Œä¹Ÿå°±æ˜¯å˜æˆ 123458ã€‚é€šè¿‡è¿™æ ·çš„åºåˆ—åŒ–å‡½æ•°ï¼Œæ•°æ®åœ¨ L1 å’Œ L2 ä¹‹é—´è½¬æ¢çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ›´åŠ çµæ´»äº†ã€‚</p><p>å¯ä»¥è¯´ï¼Œmlcache æ˜¯ä¸€ä¸ªåŠŸèƒ½å¾ˆå¼ºå¤§çš„ç¼“å­˜åº“ï¼Œè€Œä¸”<a href=\"https://github.com/thibaultcha/lua-resty-mlcache\">æ–‡æ¡£</a>ä¹Ÿå†™å¾—éå¸¸è¯¦å°½ã€‚ä»Šå¤©è¿™èŠ‚è¯¾æˆ‘åªæåˆ°äº†æ ¸å¿ƒçš„ä¸€äº›åŸç†ï¼Œæ›´å¤šçš„ä½¿ç”¨æ–¹æ³•ï¼Œå»ºè®®ä½ ä¸€å®šè¦è‡ªå·±èŠ±æ—¶é—´å»æ¢ç´¢å’Œå®è·µã€‚</p><h2>å†™åœ¨æœ€å</h2><p>æœ‰äº†å¤šå±‚ç¼“å­˜ï¼ŒæœåŠ¡ç«¯çš„æ€§èƒ½æ‰èƒ½å¾—åˆ°æœ€å¤§é™åº¦çš„ä¿è¯ï¼Œè€Œè¿™ä¸­é—´åˆéšè—äº†å¾ˆå¤šçš„ç»†èŠ‚ã€‚è¿™æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªç¨³å®šã€é«˜æ•ˆçš„å°è£…åº“ï¼Œæˆ‘ä»¬å°±èƒ½çœå¿ƒå¾ˆå¤šã€‚æˆ‘ä¹Ÿå¸Œæœ›é€šè¿‡ä»Šå¤©ä»‹ç»çš„è¿™ä¸¤ä¸ªå°è£…åº“ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ç¼“å­˜ã€‚</p><p>æœ€åç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼Œå…±äº«å­—å…¸è¿™ä¸€å±‚ç¼“å­˜æ˜¯å¿…é¡»çš„å—ï¼Ÿå¦‚æœåªç”¨ lrucache æ˜¯å¦å¯ä»¥å‘¢ï¼Ÿæ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„è§‚ç‚¹ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«å‡ºå»ï¼Œå’Œæ›´å¤šçš„äººä¸€èµ·äº¤æµå’Œè¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"40 | ç¼“å­˜ä¸é£æš´å¹¶å­˜ï¼Œè°è¯´ç¼“å­˜é£æš´ä¸å¯é¿å…ï¼Ÿ","id":126872},"right":{"article_title":"42 | å¦‚ä½•åº”å¯¹çªå‘æµé‡ï¼šæ¼æ¡¶å’Œä»¤ç‰Œæ¡¶çš„æ¦‚å¿µ","id":128788}},"comments":[{"had_liked":false,"id":128685,"user_name":"manatee","can_delete":false,"product_type":"c1","uid":1041112,"ip_address":"","ucode":"708D90E7A265BD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/e2/d8/f0562ede.jpg","comment_is_top":false,"comment_ctime":1566950623,"is_pvip":false,"replies":[{"id":"49071","content":"lua_max_pending_timers å’Œ lua_max_running_timers è¿™ä¸¤ä¸ªæŒ‡ä»¤æ¥åšæ§åˆ¶","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567587894,"ip_address":"","comment_id":128685,"utype":1}],"discussion_count":3,"race_medal":0,"score":"18746819807","product_id":100028301,"comment_content":"æƒ³è¯·é—®ä¸‹è€å¸ˆå¤šæ¬¡æåˆ°çš„timeræ•°é‡é™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶å…·ä½“æ˜¯å¤šå°‘å‘¢ï¼Œä»å“ªé‡Œå¯ä»¥æŸ¥åˆ°ç›¸å…³èµ„æ–™å‘¢","like_count":4,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465056,"discussion_content":"lua_max_pending_timers å’Œ lua_max_running_timers è¿™ä¸¤ä¸ªæŒ‡ä»¤æ¥åšæ§åˆ¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567587894,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1198028,"avatar":"https://static001.geekbang.org/account/avatar/00/12/47/cc/04a749e1.jpg","nickname":"Shliesce","note":"","ucode":"75B1DCE6989B38","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":7069,"discussion_content":"ä½ ä»¬ google ä¸€ä¸‹è¿™ä¸¤ä¸ªå‚æ•°å°±çŸ¥é“äº†ï¼šlua_max_pending_timers directiveï¼Œlua_max_running_timers ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567335557,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1175100,"avatar":"https://static001.geekbang.org/account/avatar/00/11/ee/3c/a2b67971.jpg","nickname":"Rye","note":"","ucode":"5BDC40ED641A6C","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":6666,"discussion_content":"æˆ‘ä¹Ÿæƒ³é—®è¿™ä¸ªé—®é¢˜ï¼Œéº»çƒ¦æ¸©è€å¸ˆè§£ç­”ä¸‹","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567043571,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129950,"user_name":"Shliesce","can_delete":false,"product_type":"c1","uid":1198028,"ip_address":"","ucode":"75B1DCE6989B38","user_header":"https://static001.geekbang.org/account/avatar/00/12/47/cc/04a749e1.jpg","comment_is_top":false,"comment_ctime":1567335363,"is_pvip":false,"replies":[{"id":"49068","content":"å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç¡®å®å¦‚ä½ æ‰€è¯´ï¼Œå…±äº«å­—å…¸åœ¨ reload çš„æ—¶å€™ä¸ä¼šä¸¢å¤±ã€‚ä¹Ÿæœ‰ä¸€ç§ç‰¹ä¾‹ï¼Œå¦‚æœåœ¨ init é˜¶æ®µæˆ–è€…init_workeré˜¶æ®µå°±èƒ½ä» L3 ä¸»åŠ¨è·å–åˆ°æ‰€æœ‰æ•°æ®ï¼Œé‚£ä¹ˆåªæœ‰ L1 å…¶å®ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567587349,"ip_address":"","comment_id":129950,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14452237251","product_id":100028301,"comment_content":"åœ¨å®é™…çš„ç”Ÿäº§åº”ç”¨ä¸­ï¼Œæˆ‘è®¤ä¸º shared dict è¿™ä¸€å±‚ç¼“å­˜æ˜¯å¿…é¡»çš„ï¼Œè²Œä¼¼å¤§å®¶éƒ½åªè®°å¾—lrucacheçš„å¥½ï¼Œæ•°æ®æ ¼å¼æ²¡é™åˆ¶ï¼Œä¸éœ€è¦ååºåˆ—åŒ–ï¼Œä¸éœ€è¦æ ¹æ® k&#47;v ä½“ç§¯ç®—å†…å­˜ç©ºé—´ï¼Œworker é—´ç‹¬ç«‹ä¸ç›¸äº’äº‰æŠ¢ï¼Œæ²¡æœ‰è¯»å†™é”ï¼Œæ€§èƒ½é«˜äº‘äº‘ï¼Œä½†æ˜¯å´å¿˜è®°äº†å®ƒæœ€è‡´å‘½çš„ä¸€ä¸ªå¼±ç‚¹å°±æ˜¯ lrucache çš„ç”Ÿå‘½å‘¨æœŸæ˜¯è·Ÿç€ worker èµ°çš„ï¼Œæ¯å½“nginx reload æ—¶ï¼Œè¿™éƒ¨åˆ†ç¼“å­˜ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œè¿™æ—¶å€™å¦‚æœæ²¡æœ‰ shared dictï¼Œé‚£ L3 çš„æ•°æ®æºåˆ†åˆ†é’Ÿè¢«æ‰“æŒ‚ï¼Œå½“ç„¶è¿™æ˜¯å¹¶å‘æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œä½†æ˜¯æ—¢ç„¶ç”¨åˆ°äº†ç¼“å­˜ï¼Œè¯´æ˜ä¸šåŠ¡ä½“é‡è‚¯å®šä¸ä¼šå°ã€‚ã€‚ä¸çŸ¥é“æˆ‘çš„è¿™ä¸ªè§‚ç‚¹å¯¹å—ï¼Ÿ","like_count":4,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465730,"discussion_content":"å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç¡®å®å¦‚ä½ æ‰€è¯´ï¼Œå…±äº«å­—å…¸åœ¨ reload çš„æ—¶å€™ä¸ä¼šä¸¢å¤±ã€‚ä¹Ÿæœ‰ä¸€ç§ç‰¹ä¾‹ï¼Œå¦‚æœåœ¨ init é˜¶æ®µæˆ–è€…init_workeré˜¶æ®µå°±èƒ½ä» L3 ä¸»åŠ¨è·å–åˆ°æ‰€æœ‰æ•°æ®ï¼Œé‚£ä¹ˆåªæœ‰ L1 å…¶å®ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567587349,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129967,"user_name":"Shliesce","can_delete":false,"product_type":"c1","uid":1198028,"ip_address":"","ucode":"75B1DCE6989B38","user_header":"https://static001.geekbang.org/account/avatar/00/12/47/cc/04a749e1.jpg","comment_is_top":false,"comment_ctime":1567341510,"is_pvip":false,"replies":[{"id":"49069","content":"æ²¡æœ‰æ˜ç™½ä¸ºä»€ä¹ˆæŠŠä¸»åŠ¨æ›´æ–°çš„é€»è¾‘æ”¾åœ¨ init é˜¶æ®µå‘¢ï¼Ÿ<br>ä½ å¯ä»¥åœ¨ init é˜¶æ®µè·å–å…¨é‡æ•°æ®ï¼Œé€šè¿‡é•¿è¿æ¥ç›‘å¬äº‹ä»¶é€šçŸ¥ï¼Œå»è·å–å¢é‡çš„æ•°æ®ã€‚<br>è¿™æ—¶å€™å…¶å®ä½ å¯ä»¥åªç”¨ lru ç¼“å­˜ï¼Œå»æ‰å…±äº«å­—å…¸è¿™ä¸ª L2 ç¼“å­˜ã€‚<br>APISIXï¼ˆhttps:&#47;&#47;github.com&#47;iresty&#47;apisixï¼‰ä¹Ÿæ˜¯è¿™ä¹ˆå®ç°çš„ï¼Œå®ƒçš„æ•°æ®æºåœ¨ etcdï¼Œé€šè¿‡ etcd çš„ watch æ¥è·å–ä¸Šæ¸¸çš„å˜æ›´ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"æ¸©é“­@OpenResty","uid":"1017955","ctime":1567587731,"ip_address":"","comment_id":129967,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10157276102","product_id":100028301,"comment_content":"æ¥ç€æˆ‘ä¸Šé¢çš„è¿™ä¸ªè§‚ç‚¹ï¼Œæœ€è¿‘åœ¨è®¾è®¡â€œè”åŠ¨æ³¨å†Œå‘ç°ä¸­å¿ƒ åŠ¨æ€æ›´æ–° upstream å¹¶ç¼“å­˜åœ¨è¿›ç¨‹å†…â€çš„æ’ä»¶æ—¶ï¼Œç›®å‰ä»…åšäº†shared dictè¿™ä¸€å±‚çš„ç¼“å­˜ï¼Œä»åˆæ­¥çš„å‹æµ‹ç»“æœæ¥çœ‹ï¼Œå•æœº 32C çš„ cpu å¹³å‡ä½¿ç”¨ç‡ 30%å¯ä»¥è¾¾åˆ° 8w çš„ qpsï¼Œä¹Ÿä¸çŸ¥é“æ˜¯ä¸æ˜¯é”™è§‰ï¼Œæ€§èƒ½æ¯”æˆ‘ä»¬ç”¨ upsync æ—¶è¿˜è¦å¥½ã€‚ã€‚ã€‚<br>é‡ç‚¹æ˜¯åœ¨åç»­å¢åŠ  lrucache æ—¶ï¼Œå› ä¸ºè€ƒè™‘åˆ°è¿™ç§åœºæ™¯ä¸å­˜åœ¨key expired çš„é—®é¢˜ï¼Œä¸»è¦æ˜¯ value å˜æ›´æ¯”è¾ƒé¢‘ç¹ï¼Œä¸”éœ€è¦ä¿è¯å°½å¯èƒ½çš„æ•°æ®ä¸€è‡´æ€§ï¼Œåƒ mlcache è¿™ç§è¢«åŠ¨æ›´æ–°çš„é€»è¾‘å°±ä¸å¤ªå¥½å®ç°ï¼Œè€Œä¸”è¿˜è¦è€ƒè™‘åˆ°æ¯æ¬¡ reload æ—¶çš„lrucache å…¨é‡ miss çš„åœºæ™¯ï¼Œæœ€ç»ˆè¯„ä¼°ä¸‹æ¥æˆ‘å†³å®šé‡‡ç”¨ä¸»åŠ¨æ›´æ–°ç¼“å­˜çš„æ–¹æ¡ˆã€‚åŒæ—¶å› ä¸º nginx æ¯æ¬¡ reload æ—¶éƒ½ä¼šåŠ è½½ init_by_lua*é˜¶æ®µï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—æŠŠä¸»åŠ¨æ›´æ–°çš„é€»è¾‘åšåˆ° init é˜¶æ®µï¼Œå€ŸåŠ© master fork worker æ—¶ç»§æ‰¿å†…å­˜ç©ºé—´çš„é€»è¾‘æå‰é¢„çƒ­ç¼“å­˜ï¼›å¦å¤–å°±æ˜¯æ¯æ¬¡æ›´æ–° shared dict æ—¶åŒæ­¥æ›´æ–° lrucacheã€‚æš‚æ—¶è¿˜ä¸ç¡®å®šè¿™ä¸ªæ–¹æ¡ˆæœ‰æ²¡æœ‰ä»€ä¹ˆå‘ï¼Œè€å¸ˆèƒ½å¸®å¿™æå‡ æ¡å»ºè®®å—ï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1017955,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/88/63/88cf886d.jpg","nickname":"æ¸©é“­@APISIX","note":"","ucode":"343567571DA16A","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465741,"discussion_content":"æ²¡æœ‰æ˜ç™½ä¸ºä»€ä¹ˆæŠŠä¸»åŠ¨æ›´æ–°çš„é€»è¾‘æ”¾åœ¨ init é˜¶æ®µå‘¢ï¼Ÿ\nä½ å¯ä»¥åœ¨ init é˜¶æ®µè·å–å…¨é‡æ•°æ®ï¼Œé€šè¿‡é•¿è¿æ¥ç›‘å¬äº‹ä»¶é€šçŸ¥ï¼Œå»è·å–å¢é‡çš„æ•°æ®ã€‚\nè¿™æ—¶å€™å…¶å®ä½ å¯ä»¥åªç”¨ lru ç¼“å­˜ï¼Œå»æ‰å…±äº«å­—å…¸è¿™ä¸ª L2 ç¼“å­˜ã€‚\nAPISIXï¼ˆhttps://github.com/iresty/apisixï¼‰ä¹Ÿæ˜¯è¿™ä¹ˆå®ç°çš„ï¼Œå®ƒçš„æ•°æ®æºåœ¨ etcdï¼Œé€šè¿‡ etcd çš„ watch æ¥è·å–ä¸Šæ¸¸çš„å˜æ›´ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567587731,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":128852,"user_name":"è®¸ç«¥ç«¥","can_delete":false,"product_type":"c1","uid":1003005,"ip_address":"","ucode":"4B799C0C6BC678","user_header":"https://static001.geekbang.org/account/avatar/00/0f/4d/fd/0aa0e39f.jpg","comment_is_top":false,"comment_ctime":1566975765,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"10156910357","product_id":100028301,"comment_content":"å…±äº«å­—å…¸è¿™ä¸€å±‚ç¼“å­˜ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æœ‰è¿™ä¸€å±‚æ€§èƒ½ä¼šé«˜å¾ˆå¤šï¼Œå› ä¸ºlrucache åªèƒ½åœ¨å•ä¸ªworkerä¸­å…±äº«ï¼Œè€Œå…±äº«å­—å…¸å¯ä»¥åœ¨æ•´ä¸ªserverä¸­å…±äº«ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªworkerä¸­å‘½ä¸­ä¸äº†æ—¶ï¼Œæ­¤æ—¶æ•°æ®å¯èƒ½åœ¨å¦ä¸€ä¸ªworkerä¸­å­˜åœ¨ï¼Œå¦‚æœæœ‰serverå±‚çš„ç¼“å­˜ï¼Œé‚£å‘½ä¸­ç‡å°†å¤§å¤§æé«˜ã€‚","like_count":2},{"had_liked":false,"id":228992,"user_name":"ğŸ†•","can_delete":false,"product_type":"c1","uid":2002028,"ip_address":"","ucode":"9325BB3442D0CF","user_header":"","comment_is_top":false,"comment_ctime":1592876508,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5887843804","product_id":100028301,"comment_content":"shared.DICT.getä½¿ç”¨ä¸Šä¸‹æ–‡é™åˆ¶äº†init*é˜¶æ®µï¼ŒåŒæ ·çš„è¿˜æœ‰resty.lockåº“ä¸­çš„éƒ¨åˆ†apiï¼Œåœ¨inité˜¶æ®µä¹Ÿå¯èƒ½ä¼šå¤±æ•ˆï¼Œæ‰€ä»¥æƒ³é—®ä¸€ä¸‹mlcache æ˜¯å¦æœ‰åŒæ ·çš„ä¸Šä¸‹æ–‡ä½¿ç”¨é™åˆ¶ï¼Ÿ","like_count":1},{"had_liked":false,"id":272310,"user_name":"è±†è…å±…å£«","can_delete":false,"product_type":"c1","uid":1100239,"ip_address":"","ucode":"F7C82FEB60C2B8","user_header":"https://static001.geekbang.org/account/avatar/00/10/c9/cf/af720d94.jpg","comment_is_top":false,"comment_ctime":1610027318,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1610027318","product_id":100028301,"comment_content":"è€å¸ˆå¥½ï¼Œä½¿ç”¨httpåº“è®¿é—®ç½‘ç»œçš„æ—¶å€™ï¼Œdnsè§£æè¿™å—æ€ä¹ˆåš ï¼Ÿç›®å‰æˆ‘çš„åšæ³•æ˜¯åœ¨serveré‡Œç”¨resolveræŒ‡å®šäº†å¤šä¸ªdns IPåœ°å€ï¼ä½†æ˜¯ç¼“å­˜å¤±æ•ˆåä¼šå‡ºç°è§£æåŸŸåå¤§é‡è§£æè¶…æ—¶çš„æƒ…å†µï¼tks","like_count":0},{"had_liked":false,"id":172575,"user_name":"å¼ ä»•å","can_delete":false,"product_type":"c1","uid":1054248,"ip_address":"","ucode":"8D41E96A5889FC","user_header":"https://static001.geekbang.org/account/avatar/00/10/16/28/c11e7aae.jpg","comment_is_top":false,"comment_ctime":1579226292,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1579226292","product_id":100028301,"comment_content":"å¤šçº§ç¼“å­˜çš„æ›´æ–°ç±»ä¼¼cpuï¼Œå¿…é¡»æœ‰lrucacheå±‚çš„ç¼“å­˜å¤±æ•ˆä¿¡å·ï¼Œçœ‹äº†çœ‹æ–‡æ¡£ä¹Ÿç¡®å®æ˜¯è¿™æ ·ã€‚ä½†å…¶å®è¿˜æœ‰ä¸ªç–‘é—®ï¼Œå¦‚ä½•æ›´æ–°dbä¸­çš„æ•°æ®ç„¶åè®©ç¼“å­˜å¤±æ•ˆå‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":134525,"user_name":"è¨€èº«å¯¸é£","can_delete":false,"product_type":"c1","uid":1446071,"ip_address":"","ucode":"3381F030A64FC1","user_header":"https://static001.geekbang.org/account/avatar/00/16/10/b7/d8ae07c8.jpg","comment_is_top":false,"comment_ctime":1568858848,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1568858848","product_id":100028301,"comment_content":"æˆ‘è§‰å¾—shared dictæ˜¯å¿…é¡»çš„ã€‚å¦‚æœåªæœ‰L1çš„è¯ï¼Œé‡çº§å¤§çš„ã€ç¼“å­˜ç»å¸¸å˜åŒ–çš„åº”ç”¨çš„è¯workå¤šçš„è¯åé¢çš„æ•°æ®ä¼šæœ‰è¿æ¥å‹åŠ›å§ã€‚","like_count":0},{"had_liked":false,"id":128996,"user_name":"wusiration","can_delete":false,"product_type":"c1","uid":1104438,"ip_address":"","ucode":"A9403377054F1E","user_header":"https://static001.geekbang.org/account/avatar/00/10/da/36/ac0ff6a7.jpg","comment_is_top":false,"comment_ctime":1567003269,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1567003269","product_id":100028301,"comment_content":"å…±äº«å­—å…¸è¿™ä¸€å±‚ç¼“å­˜å¹¶éå¿…é¡»ï¼Œåªç”¨lrucacheåŒæ ·å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚åªä¸è¿‡å¤šåŠ ä¸€å±‚L2ç¼“å­˜ï¼ˆå…±äº«å­—å…¸ï¼‰ï¼Œå¯ä»¥ä½¿å¾—æœåŠ¡å™¨åœ¨L1ç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡å¤šä¸ªworkerä¹‹é—´çš„å…±äº«æ•°æ®ï¼Œä»¥å‡å°‘è¯»åº“çš„æ¬¡æ•°ã€‚","like_count":0}]}