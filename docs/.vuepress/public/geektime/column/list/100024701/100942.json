{"id":100942,"title":"34 | å—è®¾å¤‡ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å»ºç«‹ä»£ç†å•†é”€å”®æ¨¡å¼ï¼Ÿ","content":"<p>ä¸Šä¸€ç« ï¼Œæˆ‘ä»¬è§£æäº†æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€åè®²æ–‡ä»¶ç³»ç»Ÿè¯»å†™çš„æµç¨‹åˆ°è¾¾åº•å±‚çš„æ—¶å€™ï¼Œæ²¡æœ‰æ›´æ·±å…¥åœ°åˆ†æä¸‹å»ï¼Œè¿™æ˜¯å› ä¸ºæ–‡ä»¶ç³»ç»Ÿå†å¾€ä¸‹å°±æ˜¯ç¡¬ç›˜è®¾å¤‡äº†ã€‚ä¸Šä¸¤èŠ‚ï¼Œæˆ‘ä»¬è§£æäº†å­—ç¬¦è®¾å¤‡çš„mknodã€æ‰“å¼€å’Œè¯»å†™æµç¨‹ã€‚é‚£è¿™ä¸€èŠ‚æˆ‘ä»¬å°±æ¥è®²å—è®¾å¤‡çš„mknodã€æ‰“å¼€æµç¨‹ï¼Œä»¥åŠæ–‡ä»¶ç³»ç»Ÿå’Œä¸‹å±‚çš„ç¡¬ç›˜è®¾å¤‡çš„è¯»å†™æµç¨‹ã€‚</p><p>å—è®¾å¤‡ä¸€èˆ¬ä¼šè¢«æ ¼å¼åŒ–ä¸ºæ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯ï¼Œä¸‹é¢çš„è®²è¿°ä¸­ï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸€ç‚¹å›°æƒ‘ã€‚ä½ ä¼šçœ‹åˆ°å„ç§å„æ ·çš„dentryå’Œinodeã€‚å—è®¾å¤‡æ¶‰åŠä¸‰ç§æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ä½ çœ‹åˆ°çš„è¿™äº›dentryå’Œinodeå¯èƒ½éƒ½ä¸æ˜¯ä¸€å›äº‹å„¿ï¼Œè¯·æ³¨æ„åˆ†è¾¨ã€‚</p><p>å—è®¾å¤‡éœ€è¦mknodå—ï¼Ÿå¯¹äºå¯åŠ¨ç›˜ï¼Œä½ å¯èƒ½è§‰å¾—ï¼Œå¯åŠ¨äº†å°±åœ¨é‚£é‡Œäº†ã€‚å¯æ˜¯å¦‚æœæˆ‘ä»¬è¦æ’è¿›ä¸€å—æ–°çš„USBç›˜ï¼Œè¿˜æ˜¯è¦æœ‰è¿™ä¸ªæ“ä½œçš„ã€‚</p><p>mknodè¿˜æ˜¯ä¼šåˆ›å»ºåœ¨/devè·¯å¾„ä¸‹é¢ï¼Œè¿™ä¸€ç‚¹å’Œå­—ç¬¦è®¾å¤‡ä¸€æ ·ã€‚/devè·¯å¾„ä¸‹é¢æ˜¯devtmpfsæ–‡ä»¶ç³»ç»Ÿã€‚<strong>è¿™æ˜¯å—è®¾å¤‡é‡åˆ°çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚æˆ‘ä»¬ä¼šä¸ºè¿™ä¸ªå—è®¾å¤‡æ–‡ä»¶ï¼Œåˆ†é…ä¸€ä¸ªç‰¹æ®Šçš„inodeï¼Œè¿™ä¸€ç‚¹å’Œå­—ç¬¦è®¾å¤‡ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚åªä¸è¿‡å­—ç¬¦è®¾å¤‡èµ°S_ISCHRè¿™ä¸ªåˆ†æ”¯ï¼Œå¯¹åº”inodeçš„file_operationsæ˜¯def_chr_fopsï¼›è€Œå—è®¾å¤‡èµ°S_ISBLKè¿™ä¸ªåˆ†æ”¯ï¼Œå¯¹åº”çš„inodeçš„file_operationsæ˜¯def_blk_fopsã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œinodeé‡Œé¢çš„i_rdevè¢«è®¾ç½®æˆäº†å—è®¾å¤‡çš„è®¾å¤‡å·dev_tï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢ä¼šç”¨åˆ°ï¼Œä½ å…ˆè®°ä½æœ‰è¿™ä¹ˆä¸€å›äº‹å„¿ã€‚</p><!-- [[[read_end]]] --><pre><code>void init_special_inode(struct inode *inode, umode_t mode, dev_t rdev)\n{\n\tinode-&gt;i_mode = mode;\n\tif (S_ISCHR(mode)) {\n\t\tinode-&gt;i_fop = &amp;def_chr_fops;\n\t\tinode-&gt;i_rdev = rdev;\n\t} else if (S_ISBLK(mode)) {\n\t\tinode-&gt;i_fop = &amp;def_blk_fops;\n\t\tinode-&gt;i_rdev = rdev;\n\t} else if (S_ISFIFO(mode))\n\t\tinode-&gt;i_fop = &amp;pipefifo_fops;\n\telse if (S_ISSOCK(mode))\n\t\t;\t/* leave it no_open_fops */\n}\n</code></pre><p>ç‰¹æ®Šinodeçš„é»˜è®¤file_operationsæ˜¯def_blk_fopsï¼Œå°±åƒå­—ç¬¦è®¾å¤‡ä¸€æ ·ï¼Œæœ‰æ‰“å¼€ã€è¯»å†™è¿™ä¸ªå—è®¾å¤‡æ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬å¸¸è§„æ“ä½œä¸ä¼šè¿™æ ·åšã€‚æˆ‘ä»¬ä¼šå°†è¿™ä¸ªå—è®¾å¤‡æ–‡ä»¶mountåˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ã€‚</p><pre><code>const struct file_operations def_blk_fops = {\n        .open           = blkdev_open,\n        .release        = blkdev_close,\n        .llseek         = block_llseek,\n        .read_iter      = blkdev_read_iter,\n        .write_iter     = blkdev_write_iter,\n        .mmap           = generic_file_mmap,\n        .fsync          = blkdev_fsync,\n        .unlocked_ioctl = block_ioctl,\n        .splice_read    = generic_file_splice_read,\n        .splice_write   = iter_file_splice_write,\n        .fallocate      = blkdev_fallocate,\n};\n</code></pre><p>ä¸è¿‡ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ç®€å•çœ‹ä¸€ä¸‹ï¼Œæ‰“å¼€è¿™ä¸ªå—è®¾å¤‡çš„æ“ä½œblkdev_openã€‚å®ƒé‡Œé¢è°ƒç”¨çš„æ˜¯blkdev_getæ‰“å¼€è¿™ä¸ªå—è®¾å¤‡ï¼Œäº†è§£åˆ°è¿™ä¸€ç‚¹å°±å¯ä»¥äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦è°ƒç”¨mountï¼Œå°†è¿™ä¸ªå—è®¾å¤‡æ–‡ä»¶æŒ‚è½½åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ã€‚å¦‚æœè¿™ä¸ªå—è®¾å¤‡åŸæ¥è¢«æ ¼å¼åŒ–ä¸ºä¸€ç§æ–‡ä»¶ç³»ç»Ÿçš„æ ¼å¼ï¼Œä¾‹å¦‚ext4ï¼Œé‚£æˆ‘ä»¬è°ƒç”¨çš„å°±æ˜¯ext4ç›¸åº”çš„mountæ“ä½œã€‚<strong>è¿™æ˜¯å—è®¾å¤‡é‡åˆ°çš„ç¬¬äºŒä¸ªæ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œä¹Ÿæ˜¯å‘è¿™ä¸ªå—è®¾å¤‡è¯»å†™æ–‡ä»¶ï¼Œéœ€è¦åŸºäºçš„ä¸»æµæ–‡ä»¶ç³»ç»Ÿã€‚å’±ä»¬åœ¨æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€èŠ‚è§£æçš„å¯¹äºæ–‡ä»¶çš„è¯»å†™æµç¨‹ï¼Œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ã€‚</p><p>è¿˜è®°å¾—ï¼Œå’±ä»¬æ³¨å†Œext4æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œæœ‰ä¸‹é¢è¿™æ ·çš„ç»“æ„ï¼š</p><pre><code>static struct file_system_type ext4_fs_type = {\n\t.owner\t\t= THIS_MODULE,\n\t.name\t\t= &quot;ext4&quot;,\n\t.mount\t\t= ext4_mount,\n\t.kill_sb\t= kill_block_super,\n\t.fs_flags\t= FS_REQUIRES_DEV,\n};\n</code></pre><p>åœ¨å°†ä¸€ä¸ªç¡¬ç›˜çš„å—è®¾å¤‡mountæˆä¸ºext4çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ext4_mount-&gt;mount_bdevã€‚</p><pre><code>static struct dentry *ext4_mount(struct file_system_type *fs_type, int flags, const char *dev_name, void *data)\n{\n\treturn mount_bdev(fs_type, flags, dev_name, data, ext4_fill_super);\n}\n\n\nstruct dentry *mount_bdev(struct file_system_type *fs_type,\n\tint flags, const char *dev_name, void *data,\n\tint (*fill_super)(struct super_block *, void *, int))\n{\n\tstruct block_device *bdev;\n\tstruct super_block *s;\n\tfmode_t mode = FMODE_READ | FMODE_EXCL;\n\tint error = 0;\n\n\n\tif (!(flags &amp; MS_RDONLY))\n\t\tmode |= FMODE_WRITE;\n\n\n\tbdev = blkdev_get_by_path(dev_name, mode, fs_type);\n......\n\ts = sget(fs_type, test_bdev_super, set_bdev_super, flags | MS_NOSEC, bdev);\n......\n\treturn dget(s-&gt;s_root);\n......\n}\n</code></pre><p>mount_bdevä¸»è¦åšäº†ä¸¤ä»¶å¤§äº‹æƒ…ã€‚ç¬¬ä¸€ï¼Œblkdev_get_by_pathæ ¹æ®/dev/xxxè¿™ä¸ªåå­—ï¼Œæ‰¾åˆ°ç›¸åº”çš„è®¾å¤‡å¹¶æ‰“å¼€å®ƒï¼›ç¬¬äºŒï¼Œsgetæ ¹æ®æ‰“å¼€çš„è®¾å¤‡æ–‡ä»¶ï¼Œå¡«å……ext4æ–‡ä»¶ç³»ç»Ÿçš„super_blockï¼Œä»è€Œä»¥æ­¤ä¸ºåŸºç¡€ï¼Œå»ºç«‹ä¸€æ•´å¥—å’±ä»¬åœ¨æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€ç« è®²çš„ä½“ç³»ã€‚</p><p>ä¸€æ—¦è¿™å¥—ä½“ç³»å»ºç«‹èµ·æ¥ä»¥åï¼Œå¯¹äºæ–‡ä»¶çš„è¯»å†™éƒ½æ˜¯é€šè¿‡ext4æ–‡ä»¶ç³»ç»Ÿè¿™ä¸ªä½“ç³»è¿›è¡Œçš„ï¼Œåˆ›å»ºçš„inodeç»“æ„ä¹Ÿæ˜¯æŒ‡å‘ext4æ–‡ä»¶ç³»ç»Ÿçš„ã€‚æ–‡ä»¶ç³»ç»Ÿé‚£ä¸€ç« æˆ‘ä»¬åªè§£æäº†è¿™éƒ¨åˆ†ï¼Œç”±äºæ²¡æœ‰åˆ°è¾¾åº•å±‚ï¼Œä¹Ÿå°±æ²¡æœ‰å…³æ³¨å—è®¾å¤‡ç›¸å…³çš„æ“ä½œã€‚è¿™ä¸€ç« æˆ‘ä»¬é‡æ–°å›è¿‡å¤´æ¥ï¼Œä¸€æ–¹é¢çœ‹mountçš„æ—¶å€™ï¼Œå¯¹äºå—è®¾å¤‡éƒ½åšäº†å“ªäº›æ“ä½œï¼Œå¦ä¸€æ–¹é¢çœ‹è¯»å†™çš„æ—¶å€™ï¼Œåˆ°äº†åº•å±‚ï¼Œå¯¹äºå—è®¾å¤‡åšäº†å“ªäº›æ“ä½œã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å…ˆæ¥çœ‹mount_bdevåšçš„ç¬¬ä¸€ä»¶å¤§äº‹æƒ…ï¼Œé€šè¿‡blkdev_get_by_pathï¼Œæ ¹æ®è®¾å¤‡å/dev/xxxï¼Œå¾—åˆ°struct block_device *bdevã€‚</p><pre><code>/**\n * blkdev_get_by_path - open a block device by name\n * @path: path to the block device to open\n * @mode: FMODE_* mask\n * @holder: exclusive holder identifier\n *\n * Open the blockdevice described by the device file at @path.  @mode\n * and @holder are identical to blkdev_get().\n *\n * On success, the returned block_device has reference count of one.\n */\nstruct block_device *blkdev_get_by_path(const char *path, fmode_t mode,\n\t\t\t\t\tvoid *holder)\n{\n\tstruct block_device *bdev;\n\tint err;\n\n\n\tbdev = lookup_bdev(path);\n......\n\terr = blkdev_get(bdev, mode, holder);\n......\n\treturn bdev;\n}\n</code></pre><p>blkdev_get_by_pathå¹²äº†ä¸¤ä»¶äº‹æƒ…ã€‚ç¬¬ä¸€ä¸ªï¼Œlookup_bdevæ ¹æ®è®¾å¤‡è·¯å¾„/dev/xxxå¾—åˆ°block_deviceã€‚ç¬¬äºŒä¸ªï¼Œæ‰“å¼€è¿™ä¸ªè®¾å¤‡ï¼Œè°ƒç”¨blkdev_getã€‚</p><p>å’±ä»¬ä¸Šé¢åˆ†æè¿‡def_blk_fopsçš„é»˜è®¤æ‰“å¼€è®¾å¤‡å‡½æ•°blkdev_openï¼Œå®ƒä¹Ÿæ˜¯è°ƒç”¨blkdev_getçš„ã€‚å—è®¾å¤‡çš„æ‰“å¼€å¾€å¾€ä¸æ˜¯ç›´æ¥è°ƒç”¨è®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€å‡½æ•°ï¼Œè€Œæ˜¯è°ƒç”¨mountæ¥æ‰“å¼€çš„ã€‚</p><pre><code>/**\n * lookup_bdev  - lookup a struct block_device by name\n * @pathname:\tspecial file representing the block device\n *\n * Get a reference to the blockdevice at @pathname in the current\n * namespace if possible and return it.  Return ERR_PTR(error)\n * otherwise.\n */\nstruct block_device *lookup_bdev(const char *pathname)\n{\n\tstruct block_device *bdev;\n\tstruct inode *inode;\n\tstruct path path;\n\tint error;\n\n\n\tif (!pathname || !*pathname)\n\t\treturn ERR_PTR(-EINVAL);\n\n\n\terror = kern_path(pathname, LOOKUP_FOLLOW, &amp;path);\n\tif (error)\n\t\treturn ERR_PTR(error);\n\n\n\tinode = d_backing_inode(path.dentry);\n......\n\tbdev = bd_acquire(inode);\n......\n\tgoto out;\n}\n</code></pre><p>lookup_bdevè¿™é‡Œçš„pathnameæ˜¯è®¾å¤‡çš„æ–‡ä»¶åï¼Œä¾‹å¦‚/dev/xxxã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯åœ¨devtmpfsæ–‡ä»¶ç³»ç»Ÿä¸­çš„ï¼Œkern_pathå¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿé‡Œé¢ï¼Œä¸€ç›´æ‰¾åˆ°å®ƒå¯¹åº”çš„dentryã€‚æ¥ä¸‹æ¥ï¼Œd_backing_inodeä¼šè·å¾—inodeã€‚è¿™ä¸ªinodeå°±æ˜¯é‚£ä¸ªinit_special_inodeç”Ÿæˆçš„ç‰¹æ®Šinodeã€‚</p><p>æ¥ä¸‹æ¥ï¼Œbd_acquireé€šè¿‡è¿™ä¸ªç‰¹æ®Šçš„inodeï¼Œæ‰¾åˆ°struct block_deviceã€‚</p><pre><code>static struct block_device *bd_acquire(struct inode *inode)\n{\n\tstruct block_device *bdev;\n......\n\tbdev = bdget(inode-&gt;i_rdev);\n\tif (bdev) {\n\t\tspin_lock(&amp;bdev_lock);\n\t\tif (!inode-&gt;i_bdev) {\n\t\t\t/*\n\t\t\t * We take an additional reference to bd_inode,\n\t\t\t * and it's released in clear_inode() of inode.\n\t\t\t * So, we can access it via -&gt;i_mapping always\n\t\t\t * without igrab().\n\t\t\t */\n\t\t\tbdgrab(bdev);\n\t\t\tinode-&gt;i_bdev = bdev;\n\t\t\tinode-&gt;i_mapping = bdev-&gt;bd_inode-&gt;i_mapping;\n\t\t}\n\t}\n\treturn bdev;\n}\n</code></pre><p>bd_acquireä¸­æœ€ä¸»è¦çš„å°±æ˜¯è°ƒç”¨bdgetï¼Œå®ƒçš„å‚æ•°æ˜¯ç‰¹æ®Šinodeçš„i_rdevã€‚è¿™é‡Œé¢åœ¨mknodçš„æ—¶å€™ï¼Œæ”¾çš„æ˜¯è®¾å¤‡å·dev_tã€‚</p><pre><code>struct block_device *bdget(dev_t dev)\n{\n        struct block_device *bdev;\n        struct inode *inode;\n\n\n        inode = iget5_locked(blockdev_superblock, hash(dev),\n                        bdev_test, bdev_set, &amp;dev);\n \n        bdev = &amp;BDEV_I(inode)-&gt;bdev;\n\n\n        if (inode-&gt;i_state &amp; I_NEW) {\n                bdev-&gt;bd_contains = NULL;\n                bdev-&gt;bd_super = NULL;\n                bdev-&gt;bd_inode = inode;\n                bdev-&gt;bd_block_size = i_blocksize(inode);\n                bdev-&gt;bd_part_count = 0;\n                bdev-&gt;bd_invalidated = 0;\n                inode-&gt;i_mode = S_IFBLK;\n                inode-&gt;i_rdev = dev;\n                inode-&gt;i_bdev = bdev;\n                inode-&gt;i_data.a_ops = &amp;def_blk_aops;\n                mapping_set_gfp_mask(&amp;inode-&gt;i_data, GFP_USER);\n                spin_lock(&amp;bdev_lock);\n                list_add(&amp;bdev-&gt;bd_list, &amp;all_bdevs);\n                spin_unlock(&amp;bdev_lock);\n                unlock_new_inode(inode);\n        }\n        return bdev;\n}\n</code></pre><p><strong>åœ¨bdgetä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†ç¬¬ä¸‰ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œbdevä¼ªæ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚bdgetå‡½æ•°æ ¹æ®ä¼ è¿›æ¥çš„dev_tï¼Œåœ¨blockdev_superblockè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿé‡Œé¢æ‰¾åˆ°inodeã€‚è¿™é‡Œæ³¨æ„ï¼Œè¿™ä¸ªinodeå·²ç»ä¸æ˜¯devtmpfsæ–‡ä»¶ç³»ç»Ÿçš„inodeäº†ã€‚blockdev_superblockçš„åˆå§‹åŒ–åœ¨æ•´ä¸ªç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨bdev_cache_initè¿›è¡Œåˆå§‹åŒ–ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>struct super_block *blockdev_superblock __read_mostly;\n\n\nstatic struct file_system_type bd_type = {\n        .name           = &quot;bdev&quot;,\n        .mount          = bd_mount,\n        .kill_sb        = kill_anon_super,\n};\n\n\nvoid __init bdev_cache_init(void)\n{\n        int err;\n        static struct vfsmount *bd_mnt;\n\n\n        bdev_cachep = kmem_cache_create(&quot;bdev_cache&quot;, sizeof(struct bdev_inode), 0, (SLAB_HWCACHE_ALIGN|SLAB_RECLAIM_ACCOUNT|SLAB_MEM_SPREAD|SLAB_ACCOUNT|SLAB_PANIC), init_once);\n        err = register_filesystem(&amp;bd_type);\n        if (err)\n                panic(&quot;Cannot register bdev pseudo-fs&quot;);\n        bd_mnt = kern_mount(&amp;bd_type);\n        if (IS_ERR(bd_mnt))\n                panic(&quot;Cannot create bdev pseudo-fs&quot;);\n        blockdev_superblock = bd_mnt-&gt;mnt_sb;   /* For writeback */\n}\n</code></pre><p>æ‰€æœ‰è¡¨ç¤ºå—è®¾å¤‡çš„inodeéƒ½ä¿å­˜åœ¨ä¼ªæ–‡ä»¶ç³»ç»Ÿ bdevä¸­ï¼Œè¿™äº›å¯¹ç”¨æˆ·å±‚ä¸å¯è§ï¼Œä¸»è¦ä¸ºäº†æ–¹ä¾¿å—è®¾å¤‡çš„ç®¡ç†ã€‚Linuxå°†å—è®¾å¤‡çš„block_deviceå’Œbdevæ–‡ä»¶ç³»ç»Ÿçš„å—è®¾å¤‡çš„inodeï¼Œé€šè¿‡struct bdev_inodeè¿›è¡Œå…³è”ã€‚æ‰€ä»¥ï¼Œåœ¨bdgetä¸­ï¼ŒBDEV_Iå°±æ˜¯é€šè¿‡bdevæ–‡ä»¶ç³»ç»Ÿçš„inodeï¼Œè·å¾—æ•´ä¸ªstruct bdev_inodeç»“æ„çš„åœ°å€ï¼Œç„¶åå–æˆå‘˜bdevï¼Œå¾—åˆ°block_deviceã€‚</p><pre><code>struct bdev_inode {\n\tstruct block_device bdev;\n\tstruct inode vfs_inode;\n};\n</code></pre><p>ç»•äº†ä¸€å¤§åœˆï¼Œæˆ‘ä»¬ç»ˆäºé€šè¿‡è®¾å¤‡æ–‡ä»¶/dev/xxxï¼Œè·å¾—äº†è®¾å¤‡çš„ç»“æ„block_deviceã€‚æœ‰ç‚¹å„¿ç»•ï¼Œæˆ‘ä»¬å†æ‹ä¸€ä¸‹ã€‚è®¾å¤‡æ–‡ä»¶/dev/xxxåœ¨devtmpfsæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ‰¾åˆ°devtmpfsæ–‡ä»¶ç³»ç»Ÿä¸­çš„inodeï¼Œé‡Œé¢æœ‰dev_tã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡dev_tï¼Œåœ¨ä¼ªæ–‡ä»¶ç³»ç»Ÿ bdevä¸­æ‰¾åˆ°å¯¹åº”çš„inodeï¼Œç„¶åæ ¹æ®struct bdev_inodeæ‰¾åˆ°å…³è”çš„block_deviceã€‚</p><p>æ¥ä¸‹æ¥ï¼Œblkdev_get_by_pathå¼€å§‹åšç¬¬äºŒä»¶äº‹æƒ…ï¼Œåœ¨æ‰¾åˆ°block_deviceä¹‹åï¼Œè¦è°ƒç”¨blkdev_getæ‰“å¼€è¿™ä¸ªè®¾å¤‡ã€‚blkdev_getä¼šè°ƒç”¨__blkdev_getã€‚</p><p>åœ¨åˆ†ææ‰“å¼€ä¸€ä¸ªè®¾å¤‡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹block_deviceè¿™ä¸ªç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p><pre><code>struct block_device {\n\tdev_t\t\t\tbd_dev;  /* not a kdev_t - it's a search key */\n\tint\t\t\tbd_openers;\n\tstruct super_block *\tbd_super;\n......\n\tstruct block_device *\tbd_contains;\n\tunsigned\t\tbd_block_size;\n\tstruct hd_struct *\tbd_part;\n\tunsigned\t\tbd_part_count;\n\tint\t\t\tbd_invalidated;\n\tstruct gendisk *\tbd_disk;\n\tstruct request_queue *  bd_queue;\n\tstruct backing_dev_info *bd_bdi;\n\tstruct list_head\tbd_list;\n......\n} ;\n</code></pre><p>ä½ åº”è¯¥èƒ½å‘ç°ï¼Œè¿™ä¸ªç»“æ„å’Œå…¶ä»–å‡ ä¸ªç»“æ„æœ‰ç€åƒä¸ä¸‡ç¼•çš„è”ç³»ï¼Œæ¯”è¾ƒå¤æ‚ã€‚è¿™æ˜¯å› ä¸ºå—è®¾å¤‡æœ¬èº«å°±æ¯”è¾ƒå¤æ‚ã€‚</p><p>æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç£ç›˜/dev/sdaï¼Œæˆ‘ä»¬æ—¢å¯ä»¥æŠŠå®ƒæ•´ä¸ªæ ¼å¼åŒ–æˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒåˆ†æˆå¤šä¸ªåˆ†åŒº/dev/sda1ã€ /dev/sda2ï¼Œç„¶åæŠŠæ¯ä¸ªåˆ†åŒºæ ¼å¼åŒ–æˆä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿã€‚å¦‚æœæˆ‘ä»¬è®¿é—®æŸä¸ªåˆ†åŒºçš„è®¾å¤‡æ–‡ä»¶/dev/sda2ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½çŸ¥é“å®ƒæ˜¯å“ªä¸ªç£ç›˜è®¾å¤‡çš„ã€‚æŒ‰è¯´å®ƒä»¬çš„é©±åŠ¨åº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœæˆ‘ä»¬è®¿é—®æ•´ä¸ªç£ç›˜çš„è®¾å¤‡æ–‡ä»¶/dev/sdaï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥èƒ½çŸ¥é“å®ƒåˆ†äº†å‡ ä¸ªåŒºåŸŸï¼Œæ‰€ä»¥å°±æœ‰äº†ä¸‹å›¾è¿™ä¸ªå¤æ‚çš„å…³ç³»ç»“æ„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/85/76/85f4d83e7ebf2aadf7ffcd5fd393b176.png?wh=4156*3061\" alt=\"\"></p><p>struct gendiskæ˜¯ç”¨æ¥æè¿°æ•´ä¸ªè®¾å¤‡çš„ï¼Œå› è€Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œgendiskåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼ŒæŒ‡å‘/dev/sdaã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>struct gendisk {\n\tint major;\t\t\t/* major number of driver */\n\tint first_minor;\n\tint minors;                     /* maximum number of minors, =1 for disks that can't be partitioned. */\n\tchar disk_name[DISK_NAME_LEN];\t/* name of major driver */\n\tchar *(*devnode)(struct gendisk *gd, umode_t *mode);\n......\n\tstruct disk_part_tbl __rcu *part_tbl;\n\tstruct hd_struct part0;\n\n\n\tconst struct block_device_operations *fops;\n\tstruct request_queue *queue;\n\tvoid *private_data;\n\n\n\tint flags;\n\tstruct kobject *slave_dir;\n......\n};\n</code></pre><p>è¿™é‡Œmajoræ˜¯ä¸»è®¾å¤‡å·ï¼Œfirst_minorè¡¨ç¤ºç¬¬ä¸€ä¸ªåˆ†åŒºçš„ä»è®¾å¤‡å·ï¼Œminorsè¡¨ç¤ºåˆ†åŒºçš„æ•°ç›®ã€‚</p><p>disk_nameç»™å‡ºäº†ç£ç›˜å—è®¾å¤‡çš„åç§°ã€‚</p><p>struct disk_part_tblç»“æ„é‡Œæ˜¯ä¸€ä¸ªstruct hd_structçš„æ•°ç»„ï¼Œç”¨äºè¡¨ç¤ºå„ä¸ªåˆ†åŒºã€‚struct block_device_operations fopsæŒ‡å‘å¯¹äºè¿™ä¸ªå—è®¾å¤‡çš„å„ç§æ“ä½œã€‚struct request_queue queueæ˜¯è¡¨ç¤ºåœ¨è¿™ä¸ªå—è®¾å¤‡ä¸Šçš„è¯·æ±‚é˜Ÿåˆ—ã€‚</p><p>struct hd_structæ˜¯ç”¨æ¥è¡¨ç¤ºæŸä¸ªåˆ†åŒºçš„ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæœ‰ä¸¤ä¸ªhd_structçš„å®ä¾‹ï¼Œåˆ†åˆ«æŒ‡å‘/dev/sda1ã€ /dev/sda2ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><pre><code>struct hd_struct {\n\tsector_t start_sect;\n\tsector_t nr_sects;\n......\n\tstruct device __dev;\n\tstruct kobject *holder_dir;\n\tint policy, partno;\n\tstruct partition_meta_info *info;\n......\n\tstruct disk_stats dkstats;\n\tstruct percpu_ref ref;\n\tstruct rcu_head rcu_head;\n};\n</code></pre><p>åœ¨hd_structä¸­ï¼Œæ¯”è¾ƒé‡è¦çš„æˆå‘˜å˜é‡ä¿å­˜äº†å¦‚ä¸‹çš„ä¿¡æ¯ï¼šä»ç£ç›˜çš„å“ªä¸ªæ‰‡åŒºå¼€å§‹ï¼Œåˆ°å“ªä¸ªæ‰‡åŒºç»“æŸã€‚</p><p>è€Œblock_deviceæ—¢å¯ä»¥è¡¨ç¤ºæ•´ä¸ªå—è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºæŸä¸ªåˆ†åŒºï¼Œæ‰€ä»¥å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œblock_deviceæœ‰ä¸‰ä¸ªå®ä¾‹ï¼Œåˆ†åˆ«æŒ‡å‘/dev/sda1ã€/dev/sda2ã€/dev/sdaã€‚</p><p>block_deviceçš„æˆå‘˜å˜é‡bd_diskï¼ŒæŒ‡å‘çš„gendiskå°±æ˜¯æ•´ä¸ªå—è®¾å¤‡ã€‚è¿™ä¸‰ä¸ªå®ä¾‹éƒ½æŒ‡å‘åŒä¸€ä¸ªgendiskã€‚bd_partæŒ‡å‘çš„æŸä¸ªåˆ†åŒºçš„hd_structï¼Œbd_containsæŒ‡å‘çš„æ˜¯æ•´ä¸ªå—è®¾å¤‡çš„block_deviceã€‚</p><p>äº†è§£äº†è¿™äº›å¤æ‚çš„å…³ç³»ï¼Œæˆ‘ä»¬å†æ¥çœ‹æ‰“å¼€è®¾å¤‡æ–‡ä»¶çš„ä»£ç ï¼Œå°±ä¼šæ¸…æ™°å¾ˆå¤šã€‚</p><pre><code>static int __blkdev_get(struct block_device *bdev, fmode_t mode, int for_part)\n{\n\tstruct gendisk *disk;\n\tstruct module *owner;\n\tint ret;\n\tint partno;\n\tint perm = 0;\n\n\n\tif (mode &amp; FMODE_READ)\n\t\tperm |= MAY_READ;\n\tif (mode &amp; FMODE_WRITE)\n\t\tperm |= MAY_WRITE;\n......\n\tdisk = get_gendisk(bdev-&gt;bd_dev, &amp;partno);\n......\n\towner = disk-&gt;fops-&gt;owner;\n......\n\tif (!bdev-&gt;bd_openers) {\n\t\tbdev-&gt;bd_disk = disk;\n\t\tbdev-&gt;bd_queue = disk-&gt;queue;\n\t\tbdev-&gt;bd_contains = bdev;\n\n\n\t\tif (!partno) {\n\t\t\tret = -ENXIO;\n\t\t\tbdev-&gt;bd_part = disk_get_part(disk, partno);\n......\n\t\t\tif (disk-&gt;fops-&gt;open) {\n\t\t\t\tret = disk-&gt;fops-&gt;open(bdev, mode);\n......\n\t\t\t}\n\n\n\t\t\tif (!ret)\n\t\t\t\tbd_set_size(bdev,(loff_t)get_capacity(disk)&lt;&lt;9);\n\n\n\t\t\tif (bdev-&gt;bd_invalidated) {\n\t\t\t\tif (!ret)\n\t\t\t\t\trescan_partitions(disk, bdev);\n......\n\t\t\t}\n......\n\t\t} else {\n\t\t\tstruct block_device *whole;\n\t\t\twhole = bdget_disk(disk, 0);\n......\n\t\t\tret = __blkdev_get(whole, mode, 1);\n......\n\t\t\tbdev-&gt;bd_contains = whole;\n\t\t\tbdev-&gt;bd_part = disk_get_part(disk, partno);\n......\n\t\t\tbd_set_size(bdev, (loff_t)bdev-&gt;bd_part-&gt;nr_sects &lt;&lt; 9);\n\t\t}\n\t} \n......\n\tbdev-&gt;bd_openers++;\n\tif (for_part)\n\t\tbdev-&gt;bd_part_count++;\n.....\n}\n</code></pre><p>åœ¨__blkdev_getå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å…ˆè°ƒç”¨get_gendiskï¼Œæ ¹æ®block_deviceè·å–gendiskã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>/**\n * get_gendisk - get partitioning information for a given device\n * @devt: device to get partitioning information for\n * @partno: returned partition index\n *\n * This function gets the structure containing partitioning\n * information for the given device @devt.\n */\nstruct gendisk *get_gendisk(dev_t devt, int *partno)\n{\n\tstruct gendisk *disk = NULL;\n\n\n\tif (MAJOR(devt) != BLOCK_EXT_MAJOR) {\n\t\tstruct kobject *kobj;\n\n\n\t\tkobj = kobj_lookup(bdev_map, devt, partno);\n\t\tif (kobj)\n\t\t\tdisk = dev_to_disk(kobj_to_dev(kobj));\n\t} else {\n\t\tstruct hd_struct *part;\n\t\tpart = idr_find(&amp;ext_devt_idr, blk_mangle_minor(MINOR(devt)));\n\t\tif (part &amp;&amp; get_disk(part_to_disk(part))) {\n\t\t\t*partno = part-&gt;partno;\n\t\t\tdisk = part_to_disk(part);\n\t\t}\n\t}\n\treturn disk;\n}\n</code></pre><p>æˆ‘ä»¬å¯ä»¥æƒ³è±¡è¿™é‡Œé¢æœ‰ä¸¤ç§æƒ…å†µã€‚ç¬¬ä¸€ç§æƒ…å†µæ˜¯ï¼Œblock_deviceæ˜¯æŒ‡å‘æ•´ä¸ªç£ç›˜è®¾å¤‡çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®dev_tï¼Œåœ¨bdev_mapä¸­å°†å¯¹åº”çš„gendiskæ‹¿å‡ºæ¥å°±å¥½ã€‚</p><p>bdev_mapæ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿå‰é¢å’±ä»¬å­¦ä¹ å­—ç¬¦è®¾å¤‡é©±åŠ¨çš„æ—¶å€™è®²è¿‡ï¼Œä»»ä½•ä¸€ä¸ªå­—ç¬¦è®¾å¤‡åˆå§‹åŒ–çš„æ—¶å€™ï¼Œéƒ½éœ€è¦è°ƒç”¨__register_chrdev_regionï¼Œæ³¨å†Œè¿™ä¸ªå­—ç¬¦è®¾å¤‡ã€‚å¯¹äºå—è®¾å¤‡ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œæ¯ä¸€ä¸ªå—è®¾å¤‡é©±åŠ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨add_diskæ³¨å†Œä¸€ä¸ªgendiskã€‚</p><p>è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œgençš„æ„æ€æ˜¯generalé€šç”¨çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„å—è®¾å¤‡ï¼Œä¸ä»…ä»…æ˜¯ç¡¬ç›˜diskï¼Œéƒ½ä¼šç”¨ä¸€ä¸ªgendiskæ¥è¡¨ç¤ºï¼Œç„¶åé€šè¿‡è°ƒç”¨é“¾add_disk-&gt;device_add_disk-&gt;blk_register_regionï¼Œå°†dev_tå’Œä¸€ä¸ªgendiskå…³è”èµ·æ¥ï¼Œä¿å­˜åœ¨bdev_mapä¸­ã€‚</p><pre><code>static struct kobj_map *bdev_map;\n\n\nstatic inline void add_disk(struct gendisk *disk)\n{\n\tdevice_add_disk(NULL, disk);\n}\n\n\n/**\n * device_add_disk - add partitioning information to kernel list\n * @parent: parent device for the disk\n * @disk: per-device partitioning information\n *\n * This function registers the partitioning information in @disk\n * with the kernel.\n */\nvoid device_add_disk(struct device *parent, struct gendisk *disk)\n{\n......\nblk_register_region(disk_devt(disk), disk-&gt;minors, NULL,\n\t\t\t    exact_match, exact_lock, disk);\n.....\n}\n\n\n/*\n * Register device numbers dev..(dev+range-1)\n * range must be nonzero\n * The hash chain is sorted on range, so that subranges can override.\n */\nvoid blk_register_region(dev_t devt, unsigned long range, struct module *module,\n\t\t\t struct kobject *(*probe)(dev_t, int *, void *),\n\t\t\t int (*lock)(dev_t, void *), void *data)\n{\n\tkobj_map(bdev_map, devt, range, module, probe, lock, data);\n}\n</code></pre><p>get_gendiskè¦å¤„ç†çš„ç¬¬äºŒç§æƒ…å†µæ˜¯ï¼Œblock_deviceæ˜¯æŒ‡å‘æŸä¸ªåˆ†åŒºçš„ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¦å…ˆå¾—åˆ°hd_structï¼Œç„¶åé€šè¿‡hd_structï¼Œæ‰¾åˆ°å¯¹åº”çš„æ•´ä¸ªè®¾å¤‡çš„gendiskï¼Œå¹¶ä¸”æŠŠpartnoè®¾ç½®ä¸ºåˆ†åŒºå·ã€‚</p><p>æˆ‘ä»¬å†å›åˆ°__blkdev_getå‡½æ•°ä¸­ï¼Œå¾—åˆ°gendiskã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥åˆ†ä¸¤ç§æƒ…å†µã€‚</p><p>å¦‚æœpartnoä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰“å¼€çš„æ˜¯æ•´ä¸ªè®¾å¤‡è€Œä¸æ˜¯åˆ†åŒºï¼Œé‚£æˆ‘ä»¬å°±è°ƒç”¨disk_get_partï¼Œè·å–gendiskä¸­çš„åˆ†åŒºæ•°ç»„ï¼Œç„¶åè°ƒç”¨block_device_operationsé‡Œé¢çš„openå‡½æ•°æ‰“å¼€è®¾å¤‡ã€‚</p><p>å¦‚æœpartnoä¸ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰“å¼€çš„æ˜¯åˆ†åŒºï¼Œé‚£æˆ‘ä»¬å°±è·å–æ•´ä¸ªè®¾å¤‡çš„block_deviceï¼Œèµ‹å€¼ç»™å˜é‡struct block_device *wholeï¼Œç„¶åè°ƒç”¨é€’å½’__blkdev_getï¼Œæ‰“å¼€wholeä»£è¡¨çš„æ•´ä¸ªè®¾å¤‡ï¼Œå°†bd_containsè®¾ç½®ä¸ºå˜é‡wholeã€‚</p><p>block_device_operationså°±æ˜¯åœ¨é©±åŠ¨å±‚äº†ã€‚ä¾‹å¦‚åœ¨drivers/scsi/sd.cé‡Œé¢ï¼Œä¹Ÿå°±æ˜¯MODULE_DESCRIPTION(â€œSCSI disk (sd) driverâ€)ä¸­ï¼Œå°±æœ‰è¿™æ ·çš„å®šä¹‰ã€‚</p><pre><code>static const struct block_device_operations sd_fops = {\n\t.owner\t\t\t= THIS_MODULE,\n\t.open\t\t\t= sd_open,\n\t.release\t\t= sd_release,\n\t.ioctl\t\t\t= sd_ioctl,\n\t.getgeo\t\t\t= sd_getgeo,\n#ifdef CONFIG_COMPAT\n\t.compat_ioctl\t\t= sd_compat_ioctl,\n#endif\n\t.check_events\t\t= sd_check_events,\n\t.revalidate_disk\t= sd_revalidate_disk,\n\t.unlock_native_capacity\t= sd_unlock_native_capacity,\n\t.pr_ops\t\t\t= &amp;sd_pr_ops,\n};\n\n\n/**\n *\tsd_open - open a scsi disk device\n *\t@bdev: Block device of the scsi disk to open\n *\t@mode: FMODE_* mask\n *\n *\tReturns 0 if successful. Returns a negated errno value in case \n *\tof error.\n **/\nstatic int sd_open(struct block_device *bdev, fmode_t mode)\n{\n......\n}\n</code></pre><p>åœ¨é©±åŠ¨å±‚æ‰“å¼€äº†ç£ç›˜è®¾å¤‡ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œblock_deviceç›¸åº”çš„æˆå‘˜å˜é‡è¯¥å¡«çš„éƒ½å¡«ä¸Šäº†ï¼Œè¿™æ‰å®Œæˆäº†mount_bdevçš„ç¬¬ä¸€ä»¶å¤§äº‹ï¼Œé€šè¿‡blkdev_get_by_pathå¾—åˆ°block_deviceã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯ç¬¬äºŒä»¶å¤§äº‹æƒ…ï¼Œæˆ‘ä»¬è¦é€šè¿‡sgetï¼Œå°†block_deviceå¡è¿›superblocké‡Œé¢ã€‚æ³¨æ„ï¼Œè°ƒç”¨sgetçš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°set_bdev_superã€‚è¿™é‡Œé¢å°†block_deviceè®¾ç½®è¿›äº†super_blockã€‚è€Œsgetè¦åšçš„ï¼Œå°±æ˜¯åˆ†é…ä¸€ä¸ªsuper_blockï¼Œç„¶åè°ƒç”¨set_bdev_superè¿™ä¸ªcallbackå‡½æ•°ã€‚è¿™é‡Œçš„super_blockæ˜¯ext4æ–‡ä»¶ç³»ç»Ÿçš„super_blockã€‚</p><p>sget(fs_type, test_bdev_super, set_bdev_super, flags | MS_NOSEC, bdev);</p><pre><code>static int set_bdev_super(struct super_block *s, void *data)\n{\n\ts-&gt;s_bdev = data;\n\ts-&gt;s_dev = s-&gt;s_bdev-&gt;bd_dev;\n\ts-&gt;s_bdi = bdi_get(s-&gt;s_bdev-&gt;bd_bdi);\n\treturn 0;\n}\n\n\n/**\n *\tsget\t-\tfind or create a superblock\n *\t@type:\t  filesystem type superblock should belong to\n *\t@test:\t  comparison callback\n *\t@set:\t  setup callback\n *\t@flags:\t  mount flags\n *\t@data:\t  argument to each of them\n */\nstruct super_block *sget(struct file_system_type *type,\n\t\t\tint (*test)(struct super_block *,void *),\n\t\t\tint (*set)(struct super_block *,void *),\n\t\t\tint flags,\n\t\t\tvoid *data)\n{\n......\n\treturn sget_userns(type, test, set, flags, user_ns, data);\n}\n\n\n/**\n *\tsget_userns -\tfind or create a superblock\n *\t@type:\tfilesystem type superblock should belong to\n *\t@test:\tcomparison callback\n *\t@set:\tsetup callback\n *\t@flags:\tmount flags\n *\t@user_ns: User namespace for the super_block\n *\t@data:\targument to each of them\n */\nstruct super_block *sget_userns(struct file_system_type *type,\n\t\t\tint (*test)(struct super_block *,void *),\n\t\t\tint (*set)(struct super_block *,void *),\n\t\t\tint flags, struct user_namespace *user_ns,\n\t\t\tvoid *data)\n{\n\tstruct super_block *s = NULL;\n\tstruct super_block *old;\n\tint err;\n......\n\tif (!s) {\n\t\ts = alloc_super(type, (flags &amp; ~MS_SUBMOUNT), user_ns);\n......\n\t}\n\terr = set(s, data);\n......\n\ts-&gt;s_type = type;\n\tstrlcpy(s-&gt;s_id, type-&gt;name, sizeof(s-&gt;s_id));\n\tlist_add_tail(&amp;s-&gt;s_list, &amp;super_blocks);\n\thlist_add_head(&amp;s-&gt;s_instances, &amp;type-&gt;fs_supers);\n\tspin_unlock(&amp;sb_lock);\n\tget_filesystem(type);\n\tregister_shrinker(&amp;s-&gt;s_shrink);\n\treturn s;\n}\n</code></pre><p>å¥½äº†ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œmountä¸­ä¸€ä¸ªå—è®¾å¤‡çš„è¿‡ç¨‹å°±ç»“æŸäº†ã€‚è®¾å¤‡æ‰“å¼€äº†ï¼Œå½¢æˆäº†block_deviceç»“æ„ï¼Œå¹¶ä¸”å¡åˆ°äº†super_blockä¸­ã€‚</p><p>æœ‰äº†ext4æ–‡ä»¶ç³»ç»Ÿçš„super_blockä¹‹åï¼Œæ¥ä¸‹æ¥å¯¹äºæ–‡ä»¶çš„è¯»å†™è¿‡ç¨‹ï¼Œå°±å’Œæ–‡ä»¶ç³»ç»Ÿé‚£ä¸€ç« çš„è¿‡ç¨‹ä¸€æ‘¸ä¸€æ ·äº†ã€‚åªè¦ä¸æ¶‰åŠçœŸæ­£å†™å…¥è®¾å¤‡çš„ä»£ç ï¼Œsuper_blockä¸­çš„è¿™ä¸ªblock_deviceå°±æ²¡å•¥ç”¨å¤„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ–‡ä»¶ç³»ç»Ÿé‚£ä¸€ç« ï¼Œæˆ‘ä»¬ä¸æ¯«æ„Ÿè§‰ä¸åˆ°å®ƒçš„å­˜åœ¨ï¼Œä½†æ˜¯ä¸€æ—¦åˆ°äº†åº•å±‚ï¼Œå°±åˆ°äº†block_deviceèµ·ä½œç”¨çš„æ—¶å€™äº†ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸‹ä¸€èŠ‚ä»”ç»†åˆ†æã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>ä»è¿™ä¸€èŠ‚æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå—è®¾å¤‡æ¯”å­—ç¬¦è®¾å¤‡å¤æ‚å¤šäº†ï¼Œæ¶‰åŠä¸‰ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå·¥ä½œè¿‡ç¨‹æˆ‘ç”¨ä¸€å¼ å›¾æ€»ç»“äº†ä¸€ä¸‹ï¼Œä¸‹é¢å¸¦ä½ æ€»ç»“ä¸€ä¸‹ã€‚</p><ol>\n<li>æ‰€æœ‰çš„å—è®¾å¤‡è¢«ä¸€ä¸ªmapç»“æ„ç®¡ç†ä»dev_tåˆ°gendiskçš„æ˜ å°„ï¼›</li>\n<li>æ‰€æœ‰çš„block_deviceè¡¨ç¤ºçš„è®¾å¤‡æˆ–è€…åˆ†åŒºéƒ½åœ¨bdevæ–‡ä»¶ç³»ç»Ÿçš„inodeåˆ—è¡¨ä¸­ï¼›</li>\n<li>mknodåˆ›å»ºå‡ºæ¥çš„å—è®¾å¤‡æ–‡ä»¶åœ¨devtemfsæ–‡ä»¶ç³»ç»Ÿé‡Œé¢ï¼Œç‰¹æ®Šinodeé‡Œé¢æœ‰å—è®¾å¤‡å·ï¼›</li>\n<li>mountä¸€ä¸ªå—è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œè°ƒç”¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„mountæ¥å£ï¼›</li>\n<li>é€šè¿‡æŒ‰ç…§/dev/xxxåœ¨æ–‡ä»¶ç³»ç»Ÿdevtmpfsæ–‡ä»¶ç³»ç»Ÿä¸Šæœç´¢åˆ°ç‰¹æ®Šinodeï¼Œå¾—åˆ°å—è®¾å¤‡å·ï¼›</li>\n<li>æ ¹æ®ç‰¹æ®Šinodeé‡Œé¢çš„dev_tåœ¨bdevæ–‡ä»¶ç³»ç»Ÿé‡Œé¢æ‰¾åˆ°inodeï¼›</li>\n<li>æ ¹æ®bdevæ–‡ä»¶ç³»ç»Ÿä¸Šçš„inodeæ‰¾åˆ°å¯¹åº”çš„block_deviceï¼Œæ ¹æ®dev_tåœ¨mapä¸­æ‰¾åˆ°gendiskï¼Œå°†ä¸¤è€…å…³è”èµ·æ¥ï¼›</li>\n<li>æ‰¾åˆ°block_deviceåæ‰“å¼€è®¾å¤‡ï¼Œè°ƒç”¨å’Œblock_deviceå…³è”çš„gendiské‡Œé¢çš„block_device_operationsæ‰“å¼€è®¾å¤‡ï¼›</li>\n<li>åˆ›å»ºè¢«mountçš„æ–‡ä»¶ç³»ç»Ÿçš„super_blockã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/62/20/6290b73283063f99d6eb728c26339620.png?wh=3469*5797\" alt=\"\"></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>åˆ°è¿™é‡Œï¼Œä½ æ˜¯å¦çœŸçš„ä½“ä¼šåˆ°äº†Linuxé‡Œé¢â€œä¸€åˆ‡çš†æ–‡ä»¶â€äº†å‘¢ï¼Ÿé‚£ä¸ªç‰¹æ®Šçš„inodeé™¤äº†èƒ½å¤Ÿè¡¨ç¤ºå­—ç¬¦è®¾å¤‡å’Œå—è®¾å¤‡ï¼Œè¿˜èƒ½è¡¨ç¤ºä»€ä¹ˆå‘¢ï¼Ÿè¯·ä½ çœ‹ä»£ç åˆ†æä¸€ä¸‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p></p>","neighbors":{"left":{"article_title":"33 | å­—ç¬¦è®¾å¤‡ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•å»ºç«‹ç›´é”€æ¨¡å¼ï¼Ÿ","id":100576},"right":{"article_title":"35 | å—è®¾å¤‡ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•å»ºç«‹ä»£ç†å•†é”€å”®æ¨¡å¼ï¼Ÿ","id":101397}},"comments":[{"had_liked":false,"id":106385,"user_name":"Spring","can_delete":false,"product_type":"c1","uid":1222211,"ip_address":"","ucode":"8175463FB4705B","user_header":"https://static001.geekbang.org/account/avatar/00/12/a6/43/cb6ab349.jpg","comment_is_top":false,"comment_ctime":1561285227,"is_pvip":false,"replies":[{"id":"38647","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":106385,"uid":"1001590","ip_address":"","utype":1,"ctime":1561420035,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"100345533035","product_id":100024701,"comment_content":"è¯»å®Œè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘æ„Ÿè§‰ç”¨ä¸‰ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸»è¦æ˜¯ä¸ºäº†è§£è€¦å’Œå¯æ‰©å±•ã€‚é¦–å…ˆæ˜¯openä¸€ä¸ªå—è®¾å¤‡ï¼Œæ¶‰åŠä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼šdevtmpfså’Œä¼ªæ–‡ä»¶ç³»ç»Ÿbdevã€‚é€šè¿‡devtmpfsä¸­çš„è®¾å¤‡å·dev_tåœ¨ä¼ªæ–‡ä»¶ç³»ç»Ÿbdevä¸­æ‰¾åˆ°block_deviceï¼Œç„¶åæ‰“å¼€ï¼Œæ‰“å¼€åå†å°†block_deviceè®¾ç½®åˆ°ä¸»æµæ–‡ä»¶ç³»ç»Ÿçš„super_blockä¸­ã€‚è®¾ç½®åˆ°ä¸»æµæ–‡ä»¶ç³»ç»Ÿçš„super_blockåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸»æµæ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ext4ï¼‰çš„file_operationså¯¹å—è®¾å¤‡è¿›è¡Œæ“ä½œäº†ã€‚ç”±äºä¸»æµæ–‡ä»¶ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œè€Œä¸”æœªæ¥å¯èƒ½é€€å‡ºæ–°çš„ï¼Œå†™æ“ä½œç³»ç»Ÿå†…æ ¸æ—¶ä¸å¯èƒ½æ¯æ¬¡éƒ½é’ˆå¯¹æ–°çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ›´æ”¹ï¼Œå› æ­¤devtmpfså’Œä¼ªæ–‡ä»¶ç³»ç»Ÿåªæ˜¯ä¸ºäº†è·å–å’Œæ‰“å¼€block_deviceï¼Œæœ€ç»ˆå¯¹block_deviceè¿›è¡Œè¯»å†™æ˜¯äº¤ç»™ä¸»æµæ–‡ä»¶ç³»ç»Ÿçš„ã€‚","like_count":24,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455072,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1561420035,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1576512,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0e/40/49a71ed8.jpg","nickname":"å…«æˆ’","note":"","ucode":"3F262A99492A65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":362648,"discussion_content":"å“¦ï¼Œçªç„¶æ‡‚äº†ï¼Œå‰å®³äº†ğŸ‘\nä»Šåè‡ªå·±è®¾è®¡ä»£ç ä¹Ÿå¯ä»¥å­¦è¿™ä¸ªæ€æƒ³â€¦â€¦","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1616998278,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":106247,"user_name":"djfhchdh","can_delete":false,"product_type":"c1","uid":1484184,"ip_address":"","ucode":"E71D75328CE398","user_header":"https://static001.geekbang.org/account/avatar/00/16/a5/98/a65ff31a.jpg","comment_is_top":false,"comment_ctime":1561216970,"is_pvip":false,"replies":[{"id":"48883","content":"æ˜¯çš„","user_name":"ä½œè€…å›å¤","comment_id":106247,"uid":"1001590","ip_address":"","utype":1,"ctime":1567504310,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"23036053450","product_id":100024701,"comment_content":"void init_special_inode(struct inode *inode, umode_t mode, dev_t rdev)<br>{<br>\tinode-&gt;i_mode = mode;<br>\tif (S_ISCHR(mode)) {<br>\t\tinode-&gt;i_fop = &amp;def_chr_fops;<br>\t\tinode-&gt;i_rdev = rdev;<br>\t} else if (S_ISBLK(mode)) {<br>\t\tinode-&gt;i_fop = &amp;def_blk_fops;<br>\t\tinode-&gt;i_rdev = rdev;<br>\t} else if (S_ISFIFO(mode))<br>\t\tinode-&gt;i_fop = &amp;pipefifo_fops;<br>\telse if (S_ISSOCK(mode))<br>\t\t;\t&#47;* leave it no_open_fops *&#47;<br>}<br>ä»è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œ&#47;dev&#47;xxxè®¾å¤‡æ–‡ä»¶å¯¹åº”çš„ç‰¹æ®Šinodeè¿˜å¯ä»¥è¡¨ç¤ºFIFOã€SOCK","like_count":5,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":455013,"discussion_content":"æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567504310,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103703,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1560494696,"is_pvip":false,"replies":[{"id":"49044","content":"æœ‰æŒ‡é’ˆ","user_name":"ä½œè€…å›å¤","comment_id":103703,"uid":"1001590","ip_address":"","utype":1,"ctime":1567584237,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":2,"race_medal":0,"score":"10150429288","product_id":100024701,"comment_content":"å¦‚æœblock_deviceæ˜¯æŒ‡å‘æŸä¸ªåˆ†åŒºçš„ï¼Œæˆ‘ä»¬è¦å…ˆæ‰¾åˆ°hd_structï¼Œç„¶åæ ¹æ®hd_structæ‰¾åˆ°å¯¹åº”æ•´ä¸ªè®¾å¤‡çš„gendiskï¼Œè¿™é‡Œæ˜¯æ€ä¹ˆæ ¹æ®hd_structæ‰¾åˆ°å¯¹åº”æ•´ä¸ªè®¾å¤‡çš„gendiskçš„å•Šï¼Ÿ","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453971,"discussion_content":"æœ‰æŒ‡é’ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567584237,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1030816,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ba/a0/f03d20cd.jpg","nickname":"likun","note":"","ucode":"9145ED059CCC6D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":229141,"discussion_content":"#define dev_to_disk(device) container_of((device), struct gendisk, part0.__dev)","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1586611500,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103581,"user_name":"å°é¾™çš„åŸå ¡","can_delete":false,"product_type":"c1","uid":1005727,"ip_address":"","ucode":"7F1F9704548E2D","user_header":"https://static001.geekbang.org/account/avatar/00/0f/58/9f/abb7bfe3.jpg","comment_is_top":false,"comment_ctime":1560474760,"is_pvip":false,"replies":[{"id":"49056","content":"æ¯ä¸€ä¸ªéƒ½æœ‰è‡ªå·±çš„ç”¨å¤„å‘€ï¼Œä¸€åˆ‡æ¥æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ºäº†ç®¡ç†æ–¹ä¾¿ï¼Œæ‰€æœ‰æƒ³å¯¹å¤–æš´éœ²ç®¡ç†æ¥å£çš„ï¼Œæ–‡ä»¶éƒ½æ˜¯é¦–é€‰çš„æ–¹å¼ã€‚","user_name":"ä½œè€…å›å¤","comment_id":103581,"uid":"1001590","ip_address":"","utype":1,"ctime":1567584985,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"10150409352","product_id":100024701,"comment_content":"èƒ½è§£é‡Šä¸‹ä¸ºä»€ä¹ˆæ‰“å¼€ä¸€ä¸ªå—è®¾å¤‡éœ€è¦3ä¸ªæ–‡ä»¶ç³»ç»Ÿé…åˆï¼Ÿä¸ºä»€ä¹ˆä¸æ˜¯ä¸¤ä¸ªï¼Œä¹Ÿä¸æ˜¯4ä¸ªï¼Ÿæ„Ÿè§‰ä¸€å †ä»£ç åˆ†æï¼Œè¶Šæ¥è¶Šæ™•äº†ã€‚","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453930,"discussion_content":"æ¯ä¸€ä¸ªéƒ½æœ‰è‡ªå·±çš„ç”¨å¤„å‘€ï¼Œä¸€åˆ‡æ¥æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸ºäº†ç®¡ç†æ–¹ä¾¿ï¼Œæ‰€æœ‰æƒ³å¯¹å¤–æš´éœ²ç®¡ç†æ¥å£çš„ï¼Œæ–‡ä»¶éƒ½æ˜¯é¦–é€‰çš„æ–¹å¼ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567584985,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":259388,"user_name":"çš®çš®ä¾ ","can_delete":false,"product_type":"c1","uid":1258402,"ip_address":"","ucode":"04205990C1DE1F","user_header":"https://static001.geekbang.org/account/avatar/00/13/33/a2/6c0ffc15.jpg","comment_is_top":false,"comment_ctime":1604717510,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5899684806","product_id":100024701,"comment_content":"å›ç­”è€å¸ˆé—®é¢˜ï¼šè¿˜å¯ä»¥è¡¨ç¤ºç½‘ç»œsocketå’Œç®¡é“","like_count":1},{"had_liked":false,"id":349652,"user_name":"å½­ä¸œæ—","can_delete":false,"product_type":"c1","uid":1252080,"ip_address":"","ucode":"C163053098CD91","user_header":"https://static001.geekbang.org/account/avatar/00/13/1a/f0/29721362.jpg","comment_is_top":false,"comment_ctime":1656207840,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1656207840","product_id":100024701,"comment_content":"æˆ‘è®°å¾—hd_structçš„ç¬¬0é¡¹è¡¨ç¤ºçš„å¹¶ä¸æ˜¯åˆ†åŒºï¼Œè€Œæ˜¯æ•´ä¸ªç£ç›˜ï¼Œå³æŒ‡å‘çš„æ˜¯disk-&gt;part0","like_count":0},{"had_liked":false,"id":338767,"user_name":"æå¯Œ","can_delete":false,"product_type":"c1","uid":2901552,"ip_address":"","ucode":"6CAF5077334E49","user_header":"","comment_is_top":false,"comment_ctime":1647705157,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1647705157","product_id":100024701,"comment_content":"å­—ç¬¦è®¾å¤‡ä¸ºä»€ä¹ˆä¸ç”¨æŒ‚è½½çš„è€å¸ˆ","like_count":0},{"had_liked":false,"id":259390,"user_name":"çš®çš®ä¾ ","can_delete":false,"product_type":"c1","uid":1258402,"ip_address":"","ucode":"04205990C1DE1F","user_header":"https://static001.geekbang.org/account/avatar/00/13/33/a2/6c0ffc15.jpg","comment_is_top":false,"comment_ctime":1604717665,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1604717665","product_id":100024701,"comment_content":"å†è¯·æ•™ä¸¤ä¸ªé—®é¢˜ï¼š1.block_deviceç»“æ„å’Œgendiské‡Œçš„operationæ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¸¤æ–¹çš„ç»“åˆç‚¹ï¼Ÿ2.adddiskæ“ä½œä¸ºä½•ç”¨è‡ªæ—‹é”è€Œä¸ç”¨å…¶ä»–é”å‘¢ï¼Ÿ","like_count":0},{"had_liked":false,"id":151269,"user_name":"å°åº„.Jerry","can_delete":false,"product_type":"c1","uid":1222795,"ip_address":"","ucode":"72EECA77AAA1CA","user_header":"https://static001.geekbang.org/account/avatar/00/12/a8/8b/c5c234b6.jpg","comment_is_top":false,"comment_ctime":1573693271,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1573693271","product_id":100024701,"comment_content":"æ ¼å¼åŒ–çš„æ—¶å€™ä¸ä¼šè®¾ç½®superblockå—","like_count":1},{"had_liked":false,"id":104227,"user_name":"ä¸€ç¬”ä¸€ç”»","can_delete":false,"product_type":"c1","uid":1495254,"ip_address":"","ucode":"2B9BC8ADF97106","user_header":"https://static001.geekbang.org/account/avatar/00/16/d0/d6/f335954b.jpg","comment_is_top":false,"comment_ctime":1560690626,"is_pvip":false,"replies":[{"id":"49031","content":"ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œç®¡ç†å®ƒä¹Ÿéœ€è¦æ–‡ä»¶","user_name":"ä½œè€…å›å¤","comment_id":104227,"uid":"1001590","ip_address":"","utype":1,"ctime":1567581480,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1560690626","product_id":100024701,"comment_content":"ä¸ºä»€ä¹ˆæŸ¥æ‰¾ext4fsæ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹éœ€è¦devtmpsæ¥ç®¡ç†ï¼Œæ„Ÿè§‰è®¾è®¡ä¸å¤ªåˆç†ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":454179,"discussion_content":"ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œç®¡ç†å®ƒä¹Ÿéœ€è¦æ–‡ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567581480,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":103705,"user_name":"å®‰æ’","can_delete":false,"product_type":"c1","uid":1260026,"ip_address":"","ucode":"F78CFA9624CAEF","user_header":"https://static001.geekbang.org/account/avatar/00/13/39/fa/a7edbc72.jpg","comment_is_top":false,"comment_ctime":1560495272,"is_pvip":false,"replies":[{"id":"49043","content":"ä¸€åˆ‡çš†æ–‡ä»¶","user_name":"ä½œè€…å›å¤","comment_id":103705,"uid":"1001590","ip_address":"","utype":1,"ctime":1567584204,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1560495272","product_id":100024701,"comment_content":"bdevè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹æ˜¯ä¸ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜çš„ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¦ç»„ç»‡æˆæ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼å‘¢ï¼Ÿ<br>å¯¹å†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿä¸å¤ªäº†è§£ï¼Œä¸‹é¢æ˜¯æˆ‘çš„ç†è§£ï¼Œå¸Œæœ›è€å¸ˆç»™äºˆæŒ‡æ­£ï¼š<br>bdevé‡Œé¢ç”±å„ç§æ•°æ®ç»“æ„ç»„æˆï¼Œä¾‹å¦‚é“¾è¡¨ã€æ ‘ä¹‹ç±»çš„ã€‚è¿™äº›ç»“æ„å’Œé€šå¸¸çš„æ–‡ä»¶ç³»ç»Ÿç”¨çš„é‚£äº›æ•°æ®ç»“æ„ç›¸åŒï¼Œè€Œä¸”ç»„ç»‡æˆäº†å’Œé€šå¸¸çš„æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼çš„å½¢å¼ï¼Œæ‰€ä»¥è¿™é‡Œå°±æŠŠbdevä»£è¡¨çš„è¿™ä¸€å¯¹æ•°æ®ç»“æ„ç»„æˆçš„ä¸œè¥¿å«åšæ–‡ä»¶ç³»ç»Ÿã€‚ å¦‚æœæŠŠbdevç»„ç»‡æˆå’Œé€šå¸¸çš„æ–‡ä»¶ç³»ç»Ÿå¤§ä¸ç›¸åŒçš„å½¢å¼ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥å®Œæˆæœ¬æ–‡ä¸­çš„åŠŸèƒ½ï¼Ÿé‚£ä¹ˆè¿™æ—¶å€™å°±ä¸æŠŠbdevå«åšæ–‡ä»¶ç³»ç»Ÿäº†ï¼Œè€Œå®ƒå°±æ˜¯ä¸€å †æ™®é€šçš„æ•°æ®ç»“æ„ã€‚","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":453973,"discussion_content":"ä¸€åˆ‡çš†æ–‡ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567584204,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}