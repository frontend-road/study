{"id":742667,"title":"15ï½œç±»åŠ è½½æœºåˆ¶çš„æ”¹å˜ï¼šå¦‚ä½•è‡ªå®šä¹‰ClassLoaderï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniTomcatã€‚</p><p>ä¸ŠèŠ‚è¯¾æˆ‘ä»¬å¼•å…¥äº†å¤šåº”ç”¨çš„æ”¯æŒï¼Œå®ç°äº†é€šè¿‡è·¯ç”±å°†è¯·æ±‚å‘é€åˆ°ä¸åŒåº”ç”¨ä¸­ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿå®šä¹‰äº†WebappClassLoaderè¿™ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ¥è¿›è¡Œéš”ç¦»ã€‚</p><p>ä½†æ˜¯å…‰æœ‰éš”ç¦»è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä¸åŒçš„ç±»åŠ è½½å™¨æœ‰ä¸åŒçš„åŠ è½½æ–¹å¼å’Œé¡ºåºï¼Œè€ŒJavaè‡ªèº«çš„ç³»ç»Ÿçº§ClassLoaderä¹Ÿä¸èƒ½å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼Œæ‰€ä»¥è¿™èŠ‚è¯¾æˆ‘ä»¬è¦ç»§ç»­æ‰©å±•è¿™ä¸ªè¯é¢˜ï¼Œæ·±å…¥è®¨è®ºè‡ªå®šä¹‰çš„ClassLoaderã€‚</p><h2>ç±»åŠ è½½å™¨åŸç†</h2><p>æˆ‘ä»¬å¹³æ—¶å†™ç¨‹åºçš„æ—¶å€™ä¼¼ä¹æ„Ÿè§‰ä¸åˆ°ç±»åŠ è½½å™¨ï¼Œå…¶å®æ˜¯å› ä¸ºJavaåœ¨å¸®æˆ‘ä»¬é»˜è®¤ä½¿ç”¨ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¸­æ¯æ¶‰åŠåˆ°ä¸€ä¸ªç±»çš„ä½¿ç”¨ï¼Œè¿è¡Œæ—¶Javaéƒ½ä¼šé€šè¿‡ä¸€ä¸ªç±»åŠ è½½å™¨æ¥åŠ è½½å®ƒã€‚Javaé‡Œé¢å¯¹å®ƒçš„å®šä¹‰æ˜¯ï¼šç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒè´Ÿè´£åŠ è½½åˆ«çš„ç±»ï¼ˆClass Loader is an object that is responsible for loading classesï¼‰ã€‚</p><p>æˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹ä¸€ä¸ªJavaå¯¹è±¡æ˜¯å¦‚ä½•åœ¨JVMé‡Œé¢è¿è¡Œèµ·æ¥çš„ã€‚ä¸€ä¸ªç®€å•çš„è¯­å¥ <code>new Test();</code> å¤§ä½“ä¼šç»è¿‡ä¸‹é¢å‡ ä¸ªæ­¥éª¤ã€‚</p><p>æ­¥éª¤ä¸€ï¼š<strong>ç±»çº§åˆ«çš„å·¥ä½œã€‚</strong>å…·ä½“æŸä¸ªç±»çš„åŠ è½½è¿‡ç¨‹åªä¼šåšä¸€æ¬¡ã€‚</p><ol>\n<li>åŠ è½½ï¼šæ‰¾åˆ°classæ–‡ä»¶ï¼Œæ‰“å¼€å¹¶è·å–å®ƒçš„å­—èŠ‚æµï¼ŒæŒ‰ç…§è™šæ‹Ÿæœºè§„èŒƒå­˜å‚¨åœ¨JVMé‡Œï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªå’Œå®ƒåŒ¹é…çš„java.lang.Classç±»å¯¹è±¡ã€‚è¿™ä¸ªæ—¶å€™ï¼Œç±»çš„å®šä¹‰å’Œå†…å­˜è¡¨è¾¾å°±å‡†å¤‡å¥½äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å¼€å§‹å¯¹è±¡çš„åˆ›å»ºã€‚</li>\n<li>é“¾æ¥ï¼šè¿™ä¸ªé˜¶æ®µæ‰§è¡Œç±»çš„é“¾æ¥è¿‡ç¨‹ï¼Œç»™ç±»åˆ†é…å†…å­˜ã€‚å…·ä½“å®ƒæœ‰ä¸‰ä¸ªåŠ¨ä½œè¦åšã€‚</li>\n</ol><!-- [[[read_end]]] --><ul>\n<li>éªŒè¯ï¼šç”¨äºéªŒè¯classæ–‡ä»¶æ˜¯å¦åˆè§„ã€‚æŒ‰ç…§å­—èŠ‚ç çš„è§„èŒƒæ£€éªŒclassæ–‡ä»¶çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå°±æ˜¯åœ¨è¿™ä¸€æ­¥å®Œæˆçš„ã€‚</li>\n<li>å‡†å¤‡ï¼šè¿™ä¸ªé˜¶æ®µç»™ç±»é‡Œé¢çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œèµ‹äºˆé»˜è®¤å€¼ã€‚</li>\n<li>è§£æï¼šå°†ç¬¦å·å¼•ç”¨è½¬æˆç›´æ¥å†…å­˜å¼•ç”¨ã€‚</li>\n</ul><ol start=\"3\">\n<li>åˆå§‹åŒ–ï¼šè¿™ä¸ªé˜¶æ®µå®Œæˆç±»åŠ è½½ï¼ŒæŠŠæ‰€æœ‰é™æ€å˜é‡èµ‹åˆå§‹å€¼ï¼Œæ‰§è¡Œé™æ€ä»£ç å—ã€‚</li>\n</ol><p>æ­¥éª¤äºŒï¼š<strong>å¯¹è±¡çº§åˆ«çš„å·¥ä½œã€‚</strong>ç»è¿‡ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬çš„ç±»å°±å‡†å¤‡å¥½äº†ï¼Œå¯¹è±¡æœ‰äº†æ¨¡å­ã€‚åˆ›å»ºå¯¹è±¡ï¼ˆå®ä¾‹ï¼‰çš„äº‹æƒ…å°±ç®€å•äº†ã€‚</p><ol>\n<li>ä¸ºå¯¹è±¡åœ¨å †ä¸­åˆ†é…å†…å­˜ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ä¾‹å­—æ®µåŒ…æ‹¬è‡ªèº«å®šä¹‰çš„å’Œä»çˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„ä¸¤ä¸ªéƒ¨åˆ†ã€‚</li>\n<li>å¯¹å®ä¾‹å†…å­˜è¿›è¡Œé›¶å€¼åˆå§‹åŒ–ã€‚</li>\n<li>è°ƒç”¨å¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚</li>\n</ol><p>è¿™å°±æ˜¯åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚</p><p>æˆ‘ä»¬ç»§ç»­æ¢è®¨ç±»çš„åŠ è½½ï¼Œ<strong>åœ¨ Java ä¸­æœ‰ä¸‰ç§ç±»åŠ è½½å™¨å­˜åœ¨ï¼Œä¸€ä¸ªåº”ç”¨åŠ è½½å™¨ï¼Œä¸€ä¸ªæ‰©å±•åŠ è½½å™¨ï¼Œä¸€ä¸ªæ ¹åŠ è½½å™¨ã€‚</strong>å®ƒä»¬æœ‰ä¸åŒçš„ç”¨å¤„ï¼šåº”ç”¨ç±»åŠ è½½å™¨åŠ è½½æˆ‘ä»¬è‡ªå·±å†™çš„ç±»ï¼›æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½Javaæ ¸å¿ƒç±»çš„æ‰©å±•éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯é‚£äº›æ”¾åœ¨ <code>$JRE_HOME/lib/ext</code> ç›®å½•ä¸‹çš„ç±»ï¼›æ ¹ç±»åŠ è½½å™¨åŠ è½½Javaå¹³å°æ ¸å¿ƒç±»ï¼Œæ¯”å¦‚java.lang.Objectå’Œjava.lang.Thread ä»¥åŠrt.jaré‡Œçš„ç±»ã€‚</p><p>è¿™å‡ ä¸ªç±»åŠ è½½å™¨ä¹‹é—´æ˜¯æœ‰å±‚æ¬¡å…³ç³»çš„ï¼Œè¿™ç§å…³ç³»å°±å«åšå§”æ‰˜æ¨¡å‹ï¼ˆDelegation Modelï¼‰ã€‚ä¸€ä¸ªç±»åŠ è½½å™¨æŠŠå¯¹ç±»çš„åŠ è½½ä»»åŠ¡å§”æ‰˜ç»™å®ƒçš„ä¸Šå±‚ï¼ˆParentï¼‰å»åšã€‚å…·ä½“æ¥è¯´ï¼Œä¸€ä¸ªç±»åŠ è½½å™¨è‡ªå·±å…ˆä¸åŠ è½½ï¼Œè€Œæ˜¯äº¤ç»™å®ƒçš„ä¸Šå±‚å»å¤„ç†ï¼Œè€Œä¸Šå±‚å†äº¤ç»™å®ƒçš„ä¸Šå±‚å»å¤„ç†ï¼Œä¸€å±‚å±‚å§”æ‰˜ä¸Šå»ä¸€ç›´åˆ°æ ¹ç±»åŠ è½½å™¨ï¼Œå¦‚æœä¸Šå±‚å‘ç°è‡ªå·±åŠ è½½ä¸äº†è¿™ä¸ªç±»ï¼Œæ‰ä¼šäº¤ç»™ä¸‹å±‚åŠ è½½ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯è¿™æ ·çš„æ¬¡åºï¼Œå…ˆæ˜¯åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½å®¢æˆ·ç¨‹åºï¼Œå®ƒè‡ªå·±ä¸åšï¼Œäº¤ç»™ä¸Šå±‚çš„æ‰©å±•ç±»åŠ è½½å™¨ï¼Œå†äº¤ç»™æ ¹ç±»åŠ è½½å™¨ã€‚ä¹‹åæ–¹å‘åè¿‡æ¥ï¼Œæ ¹ç±»åŠ è½½å™¨å‘ç°ä¸èƒ½åŠ è½½ï¼Œå°±è¿”ç»™æ‰©å±•ç±»åŠ è½½å™¨ï¼Œå¦‚æœè¿˜æ˜¯åŠ è½½ä¸äº†ï¼Œæœ€åå†è¿”ç»™åº”ç”¨ç±»åŠ è½½å™¨ã€‚</p><p>è¿™å°±æ˜¯Javaé‡Œé¢çš„æ ‡å‡†ç±»åŠ è½½æ¨¡å¼ï¼Œå«åš<strong>åŒäº²å§”æ‰˜æ¨¡å‹</strong>ã€‚è¿™ä¸ªæ¨¡å¼åˆçœ‹èµ·æ¥å¥‡æ€ªï¼Œä½†æ˜¯å®ƒè¿™ä¸ªæœºåˆ¶ä¿è¯äº†Javaç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œä¿æŠ¤äº†Javaè‡ªèº«çš„æ ¸å¿ƒç±»ä¸è¢«æ›¿æ¢æ‰ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒJavaæŠŠè¿™ä¸€å¥—æœºåˆ¶è®¾è®¡å¾—å¥½å¥½çš„ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨å‘¢ï¼Ÿè¿™æ˜¯ç”±æˆ‘ä»¬çš„éœ€æ±‚å†³å®šçš„ï¼Œæˆ‘ä»¬çš„MiniTomcatæ˜¯ä¸€ä¸ªåº”ç”¨æœåŠ¡å™¨ï¼Œå®ƒè´Ÿè´£ç®¡ç†å¤šä¸ªJavaåº”ç”¨ï¼Œå› æ­¤å®ƒéœ€è¦æ»¡è¶³å‡ ä¸ªç‰¹æ€§ã€‚</p><ol>\n<li>åº”ç”¨ä¹‹é—´ç±»éš”ç¦»ï¼Œä¸åŒçš„åº”ç”¨ä½¿ç”¨åŒä¸€ä¸ªç±»æ˜¯å¯ä»¥çš„ï¼Œè¿™ä¸ªç±»è¿˜å¯ä»¥æœ‰ä¸åŒç‰ˆæœ¬ï¼Œä¸åº”è¯¥å†²çªã€‚</li>\n<li>ä¸åŒåº”ç”¨ä¹‹é—´å¯ä»¥å…±äº«æŸäº›åŸºç¡€åŒ…ã€‚</li>\n<li>åº”ç”¨ä¸MiniTomcatæœ¬èº«çš„ç±»åº”è¯¥äº’ç›¸ä¸å¹²æ‰°ã€‚</li>\n</ol><p>å¯¹è¿™äº›ç‰¹æ€§ï¼Œç”¨æ ‡å‡†æ¨¡å¼ä¸èƒ½æ»¡è¶³åº”ç”¨ã€‚å› ä¸ºæŒ‰ç…§åŒäº²å§”æ‰˜æ¨¡å‹ï¼Œéƒ½å…ˆäº¤ç»™ä¸Šå±‚ç±»åŠ è½½å™¨ï¼Œå°±æ˜¯AppClassLoaderå»åŠ è½½äº†ã€‚è¿™ä¸ªçˆ¶ç±»åŠ è½½å™¨åˆ†ä¸æ¸…å…·ä½“æ¯ä¸€ä¸ªåº”ç”¨æ‰€éœ€è¦çš„ç±»ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è‡ªå·±çš„ç±»åŠ è½½å™¨ä¸­éœ€è¦è‡ªå·±å®šä¹‰ä¸åŒçš„åŠ è½½é¡ºåºã€‚ç®€å•æ¥è®²ï¼Œåº”è¯¥ç”±è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨è‡ªè¡ŒåŠ è½½ç±»ï¼Œè€Œä¸æ˜¯ä¸€æ¦‚äº¤ç»™ä¸Šå±‚å»åŠ è½½ã€‚</p><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€èµ·åŠ¨æ‰‹å®ç°ã€‚</p><h2>é¡¹ç›®ç»“æ„</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬æ–°å¢äº†Loaderé€šç”¨æ¥å£ï¼Œå®šä¹‰äº†WebappLoaderç±»ï¼Œå¹¶ä¸”ä¸ºäº†ä½¿ç»“æ„ä¿æŒä¸€è‡´ï¼ŒæŠŠåŸæœ‰çš„webrootç›®å½•æ›´åä¸ºwebappsï¼Œå¹¶è¿›ä¸€æ­¥è°ƒæ•´ä¼˜åŒ–ç›®å½•ç»“æ„ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹ç›®å‰çš„é¡¹ç›®ç»“æ„ã€‚</p><pre><code class=\"language-plain\">MiniTomcat\nâ”œâ”€ src\nâ”‚  â”œâ”€ main\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ com\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ minit\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ connector\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ http\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ DefaultHeaders.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpConnector.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpHeader.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestImpl.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestLine.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponseImpl.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ SocketInputStream.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StatisResourceProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponseFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ core\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ApplicationFilterChain.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ApplicationFilterConfig.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ CommonClassLoader.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ CommonLoader.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerBase.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerListenerDef.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ FilterDef.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ FilterMap.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardContext.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardContextValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardHost.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardHostValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardPipeline.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardWrapper.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardWrapperValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ WebappClassLoader.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ WebappLoader.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ logger\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ Constants.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ FileLogger.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ LoggerBase.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ SystemErrLogger.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ SystemOutLogger.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ session\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardSession.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StandardSessionFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ startup\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ BootStrap.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ util\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ CookieTools.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ StringManager.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ URLDecoder.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ valves\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ AccessLogValve.java\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ ValveBase.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Connector.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Container.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerEvent.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ContainerListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Context.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ InstanceEvent.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ InstanceListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Loader.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Logger.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Pipeline.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Request.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Response.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Session.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ SessionEvent.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ SessionListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Valve.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ValveContext.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Wrapper.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ TestFilter.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ TestListener.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ TestServlet.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”œâ”€ webapps\nâ”‚  â”œâ”€ app1\nâ”‚  â”‚  â”œâ”€ WEB-INF\nâ”‚  â”‚  â”‚  â”œâ”€ classes\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ TestFilter.class\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ TestListener.class\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ TestServlet.class\nâ”‚  â”‚  â”œâ”€ hello.txt\nâ”‚  â”œâ”€ app2\nâ”‚  â”‚  â”œâ”€ WEB-INF\nâ”‚  â”‚  â”‚  â”œâ”€ classes\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ TestFilter.class\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ TestListener.class\nâ”‚  â”‚  â”‚  â”‚  â”‚  â”œâ”€ TestServlet.class\nâ”‚  â”‚  â”œâ”€ hello.txt\nâ”œâ”€ pom.xml\n</code></pre><h2>å¼•å…¥è‡ªå®šä¹‰åŠ è½½å™¨</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„MiniTomcatæ¡†æ¶é‡Œæ¶‰åŠåˆ°ä¸¤ç±»ClassLoaderï¼Œä¸€ç±»æ˜¯Javaæä¾›çš„ç³»ç»Ÿçº§çš„ClassLoaderï¼Œå¦å¤–ä¸€ç±»æ˜¯MiniTomcatæ‰€ç®¡ç†çš„æ¯ä¸€ä¸ªContextåº”ç”¨çº§åˆ«çš„WebappClassLoaderã€‚</p><p>å…¶ä¸­WebappClassLoaderæ˜¯æˆ‘ä»¬åœ¨æ¡†æ¶ä¸­è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œè¿™æ˜¯è¿™èŠ‚è¯¾çš„é‡ç‚¹ï¼Œæˆ‘ä»¬æ•´ç†ä¸€ä¸‹ï¼Œå…ˆå®šä¹‰Loaderé€šç”¨æ¥å£ã€‚</p><pre><code class=\"language-java\">package com.minit;\npublic interface Loader {\n    public Container getContainer();\n    public void setContainer(Container container);\n    public String getPath();\n    public void setPath(String path);\n    public String getDocbase();\n    public void setDocbase(String docbase);\n    public ClassLoader getClassLoader();\n    public String getInfo();\n    public void addRepository(String repository);\n    public String[] findRepositories();\n    public void start();\n    public void stop();\n}\n</code></pre><p>åœ¨Containeré€šç”¨æ¥å£ä¸­ï¼ŒæŠŠå¼•ç”¨çš„WebappClassLoaderä¹Ÿæ”¹ä¸ºå¼•ç”¨Loaderç±»å‹ã€‚</p><pre><code class=\"language-java\">package com.minit;\npublic interface Container {\n    public Loader getLoader();\n    public void setLoader(Loader loader);\n}\n</code></pre><p>å› æ­¤å®ç°çš„Containeræ¥å£é‡Œçš„getLoaderå’ŒsetLoaderæ–¹æ³•çš„ContainerBaseéœ€è¦è°ƒæ•´ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“è°ƒæ•´äº†å“ªäº›åœ°æ–¹ã€‚</p><pre><code class=\"language-java\">package com.minit.core;\nimport java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\npublic abstract class ContainerBase implements Container,Pipeline {\n     public Loader getLoader() {\n        if (loader != null)\n            return (loader);\n        if (parent != null)\n            return (parent.getLoader());\n        return (null);\n    }\n    public synchronized void setLoader(Loader loader) {\n        loader.setPath(path);\n        loader.setDocbase(docbase);\n        loader.setContainer(this);\n        Loader oldLoader = this.loader;\n        if (oldLoader == loader)\n            return;\n        this.loader = loader;\n    }\n}\n</code></pre><p>åç»­è°ƒç”¨ContainerBaseä¸­çš„getLoaderå’ŒsetLoaderæ–¹æ³•éƒ½éœ€è¦å°†è¿”å›å€¼æ”¹ä¸ºLoaderï¼Œè¿™ä¼šæ¶‰åŠåˆ°ApplicationFilterConfigã€StandardContextã€StandardHostã€StandardWrapperç­‰ç±»çš„ä¿®æ”¹ï¼Œå› ä¸ºæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å°±ä¸å†æŠŠè¿™äº›ä»£ç ä¸€ä¸€åˆ—å‡ºäº†ã€‚</p><h2>ä¿®æ”¹ç±»åŠ è½½è¿‡ç¨‹</h2><p>å‰é¢æåˆ°è¿‡ï¼Œæ ‡å‡†çš„ç±»åŠ è½½è¿‡ç¨‹ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹ã€‚å‚ç…§Tomcatçš„å®ç°ï¼Œæˆ‘ä»¬ä¼šæä¾›ä¸¤ä¸ªClassLoaderï¼Œä¸€ä¸ªæ˜¯CommonClassLoaderï¼Œä¸€ä¸ªæ˜¯WebappClassLoaderã€‚</p><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦æä¾›ä¸¤ä¸ªClassLoaderï¼Ÿå› ä¸ºæˆ‘ä»¬è¦æŠŠMiniTomcatè‡ªèº«éœ€è¦çš„ç±»åº“å’Œåº”ç”¨éœ€è¦çš„ç±»åº“åˆ†å¼€ï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ªä¸åŒçš„ClassLoaderã€‚æˆ‘ä»¬æŠŠMiniTomcatè‡ªèº«éœ€è¦çš„ç±»ç”±CommonClassLoaderåŠ è½½ï¼Œæ”¾åœ¨libç›®å½•ä¸‹ï¼Œåº”ç”¨ç¨‹åºçš„ç±»ç”±WebappClassLoaderåŠ è½½ï¼Œæ”¾åœ¨\\WEB-INF\\classesç›®å½•ä¸‹ã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹Tomcatï¼ˆMiniTomcatï¼‰çš„ç±»åŠ è½½å›¾ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b2/f5/b2245fb9336b2ddd8f4a4e6da33b40f5.png?wh=1920x1066\" alt=\"å›¾ç‰‡\"></p><p>æ³¨æ„äº†ï¼Œè™½ç„¶æˆ‘ä»¬è¿™é‡Œä¹Ÿæ˜¯ç”¨çš„parentè¿™ä¸ªè¯ï¼Œä½†æ˜¯å…¶å®å¹¶ä¸æ˜¯çˆ¶å­å…³ç³»ï¼Œè€Œæ˜¯ç»„åˆå…³ç³»ã€‚</p><p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹Tomcatçš„ç±»åŠ è½½è¿‡ç¨‹ã€‚Webåº”ç”¨é»˜è®¤çš„ç±»åŠ è½½é¡ºåºæ˜¯è¿™æ ·çš„ï¼ˆæ‰“ç ´äº†åŒäº²å§”æ´¾è§„åˆ™ï¼‰ã€‚</p><ol>\n<li>å…ˆä»JVMçš„BootStrapClassLoaderä¸­åŠ è½½ã€‚</li>\n<li>åŠ è½½Webåº”ç”¨ä¸‹/WEB-INF/classesä¸­çš„ç±»ã€‚</li>\n<li>åŠ è½½System classpathè·¯å¾„ä¸‹é¢çš„ç±»ã€‚</li>\n<li>åŠ è½½Commonè·¯å¾„ä¸‹é¢çš„ç±»ã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/30/c6/30fc14b602aee704d85a5bd36e6196c6.png?wh=1920x1110\" alt=\"å›¾ç‰‡\"></p><p>å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº† <code>&lt;Loader delegate=\"true\"/&gt;</code>ï¼Œé‚£ä¹ˆå°±æ˜¯éµå¾ªåŒäº²å§”æ´¾è§„åˆ™ï¼Œé‚£ä¹ˆåŠ è½½é¡ºåºå°±æ˜¯è¿™æ ·çš„ã€‚</p><ol>\n<li>å…ˆä»JVMçš„BootStrapClassLoaderä¸­åŠ è½½ã€‚</li>\n<li>åŠ è½½ä¸Šé¢å®šä¹‰çš„System classpathè·¯å¾„ä¸‹é¢çš„ç±»ã€‚</li>\n<li>åŠ è½½ä¸Šé¢å®šä¹‰çš„Commonè·¯å¾„ä¸‹é¢çš„ç±»ã€‚</li>\n<li>åŠ è½½Webåº”ç”¨ä¸‹/WEB-INF/classesä¸­çš„ç±»ã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/de/e6/de323218fbf1e925685c99a9e2ab80e6.png?wh=1920x1066\" alt=\"å›¾ç‰‡\"></p><p>å¯ä»¥çœ‹å‡ºï¼Œä¸¤ç§åŠ è½½æ¬¡åºçš„ä¸åŒåœ¨äºè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åœ¨ä½•æ—¶èµ·æ•ˆï¼ŒMiniTomcatå‚ç…§Tomcatçš„å®ç°ï¼Œå…ˆç”±è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ï¼Œç„¶åå†ç»™systemåŠ è½½å™¨ã€‚ä»£ç ä¸Tomcatæœ‰æ‰€ä¸åŒï¼Œä¸»è¦çš„ç›®çš„æ˜¯å±•ç¤ºä¸æ ‡å‡†ä¸åŒçš„åŠ è½½é¡ºåºã€‚</p><p>ä½ å¯ä»¥çœ‹ä¸€ä¸‹CommonLoaderå’ŒCommonClassLoaderçš„ä»£ç å®šä¹‰ã€‚</p><p>CommonLoaderï¼š</p><pre><code class=\"language-java\">package com.minit.core;\npublic class CommonLoader implements Loader {\n    ClassLoader classLoader;\n    ClassLoader parent;\n    String path;\n    String docbase;\n    Container container;\n    public CommonLoader() {\n    }\n    public CommonLoader(ClassLoader parent) {\n        this.parent = parent;\n    }\n    public Container getContainer() {\n        return container;\n    }\n    public void setContainer(Container container) {\n        this.container = container;\n    }\n    public String getPath() {\n        return path;\n    }\n    public void setPath(String path) {\n        this.path = path;\n    }\n    public String getDocbase() {\n        return docbase;\n    }\n    public void setDocbase(String docbase) {\n        this.docbase = docbase;\n    }\n\n    public ClassLoader getClassLoader() {\n        return classLoader;\n    }\n    public String getInfo() {\n        return \"A simple loader\";\n    }\n    public void addRepository(String repository) {\n    }\n    public String[] findRepositories() {\n        return null;\n    }\n    public synchronized void start() {\n        System.out.println(\"Starting Common Loader, docbase: \" + docbase);\n        try {\n            // åˆ›å»ºä¸€ä¸ªURLClassLoader\n            //ç±»åŠ è½½ç›®å½•æ˜¯minitå®‰è£…ç›®å½•ä¸‹çš„libç›®å½•\n            URL[] urls = new URL[1];\n            URLStreamHandler streamHandler = null;\n            File classPath = new File(System.getProperty(\"minit.home\"));\n            String repository = (new URL(\"file\", null, classPath.getCanonicalPath() + File.separator)).toString() ;\n            repository = repository + \"lib\" + File.separator;\n            urls[0] = new URL(null, repository, streamHandler);\n            System.out.println(\"Common classloader Repository : \"+repository);\n            classLoader = new CommonClassLoader(urls);\n        }\n        catch (Exception e) {\n            System.out.println(e.toString() );\n        }\n    }\n    public void stop() {\n    }\n}\n</code></pre><p>CommonClassLoaderï¼š</p><pre><code class=\"language-java\">package com.minit.core;\npublic class CommonClassLoader extends URLClassLoader {\n    protected boolean delegate = false;\n    private ClassLoader parent = null;\n    private ClassLoader system = null;\n    public CommonClassLoader() {\n        super(new URL[0]);\n        this.parent = getParent();\n        system = getSystemClassLoader();\n    }\n    public CommonClassLoader(URL[] urls) {\n        super(urls);\n        this.parent = getParent();\n        system = getSystemClassLoader();\n    }\n    public CommonClassLoader(ClassLoader parent) {\n        super(new URL[0], parent);\n        this.parent = parent;\n        system = getSystemClassLoader();\n    }\n    public CommonClassLoader(URL[] urls, ClassLoader parent) {\n        super(urls, parent);\n        this.parent = parent;\n        system = getSystemClassLoader();\n    }\n    public boolean getDelegate() {\n        return (this.delegate);\n    }\n    public void setDelegate(boolean delegate) {\n        this.delegate = delegate;\n    }\n    public Class findClass(String name) throws ClassNotFoundException {\n        Class clazz = null;\n        try {\n            clazz = super.findClass(name);\n        } catch (RuntimeException e) {\n            throw e;\n        }\n        if (clazz == null) {\n            throw new ClassNotFoundException(name);\n        }\n        // è¿”å›æˆ‘ä»¬å®šä½çš„ç±»\n        return (clazz);\n    }\n    public Class loadClass(String name) throws ClassNotFoundException {\n        return (loadClass(name, false));\n    }\n    //åŠ è½½ç±»ï¼Œæ³¨æ„åŠ è½½æ¬¡åºï¼Œè¿™ä¸ªæ–¹æ³•åŒæ—¶è€ƒè™‘äº†åŒäº²å§”æ‰˜æ¨¡å¼\n    public Class&lt;?&gt; loadClass(String name, boolean resolve)\n            throws ClassNotFoundException {\n        Class&lt;?&gt; clazz = null;\n        // å…ˆæ˜¯å°è¯•ä½¿ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½ç±»ï¼Œä»¥é˜²æ­¢Webåº”ç”¨ç¨‹åºè¦†ç›–J2SEç±»\n        try {\n            clazz = system.loadClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return (clazz);\n            }\n        } catch (ClassNotFoundException e) {\n            // Ignore\n        }\n        boolean delegateLoad = delegate;\n        // åˆ°è¿™é‡Œï¼Œç³»ç»Ÿç±»åŠ è½½å™¨ä¸èƒ½åŠ è½½ï¼Œå°±åˆ¤æ–­æ˜¯ä¸æ˜¯å§”æ‰˜ä»£ç†æ¨¡å¼ï¼Œå°†å…¶å§”æ‰˜ç»™çˆ¶ç±»\n        if (delegateLoad) {\n            ClassLoader loader = parent;\n            if (loader == null)\n                loader = system;\n            try {\n                clazz = loader.loadClass(name);\n                if (clazz != null) {\n                    if (resolve)\n                        resolveClass(clazz);\n                    return (clazz);\n                }\n            } catch (ClassNotFoundException e) {\n                ;\n            }\n        }\n        // åˆ°è¿™é‡Œï¼Œæœç´¢æœ¬åœ°å­˜å‚¨åº“ï¼Œè‡ªå·±åŠ è½½\n        try {\n            clazz = findClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return (clazz);\n            }\n        } catch (ClassNotFoundException e) {\n            ;\n        }\n        // (3) åˆ°äº†è¿™é‡Œï¼Œè‡ªå·±åŠ è½½ä¸äº†ï¼Œå°±å§”æ‰˜ç»™çˆ¶ç±»\n        if (!delegateLoad) {\n            ClassLoader loader = parent;\n            if (loader == null)\n                loader = system;\n            try {\n                clazz = loader.loadClass(name);\n                if (clazz != null) {\n                    if (resolve)\n                        resolveClass(clazz);\n                    return (clazz);\n                }\n            } catch (ClassNotFoundException e) {\n                ;\n            }\n        }\n        // è¯¥ç±»æœªæ‰¾åˆ°\n        throw new ClassNotFoundException(name);\n    }\n    private void log(String message) {\n        System.out.println(\"WebappClassLoader: \" + message);\n    }\n    private void log(String message, Throwable throwable) {\n        System.out.println(\"WebappClassLoader: \" + message);\n        throwable.printStackTrace(System.out);\n    }\n}\n</code></pre><p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒTomcatåœ¨CommonClassLoaderä¸­ï¼Œä¾ç„¶ä¼šæ²¿ç”¨åŒäº²å§”æ‰˜æœºåˆ¶ï¼Œè¿™æ˜¯å› ä¸º\\libç›®å½•ä¸‹çš„ç±»æ˜¯æ•´ä¸ªTomcatä½¿ç”¨çš„ï¼Œåªæœ‰ä¸€ä»½ï¼Œè¿™æ ·åŠ è½½å°±å¯ä»¥ã€‚CommonLoaderæ˜¯Minitå…¨å±€å…±é€šçš„ï¼Œå®ƒä»libç›®å½•ä¸‹åŠ è½½ç±»ã€‚</p><pre><code class=\"language-java\">&nbsp;public synchronized void start() {\n    repository = repository + \"lib\" + File.separator;\n    urls[0] = new URL(null, repository, streamHandler);\n    classLoader = new CommonClassLoader(urls);\n}\n</code></pre><p>æˆ‘ä»¬å†æ¥çœ‹WebappClassLoaderï¼Œå› ä¸ºéœ€è¦ç®¡ç†æ¯ä¸€ä¸ªåº”ç”¨ï¼Œæ‰€ä»¥åŠ è½½æœºåˆ¶æœ‰æ‰€ä¸åŒã€‚</p><p>WebappLoaderè¿™é‡ŒæŒ‡å®šäº†ä¸€ä¸ªåº”ç”¨çš„ç±»åŠ è½½ç›®å½•ã€‚</p><pre><code class=\"language-java\">package com.minit.core;\npublic class WebappLoader implements Loader {\n    ClassLoader classLoader;\n    ClassLoader parent;\n    String path;\n    String docbase;\n    Container container;\n    public WebappLoader(String docbase) {\n        this.docbase = docbase;\n    }\n    public WebappLoader(String docbase, ClassLoader parent) {\n        this.docbase = docbase;\n        this.parent = parent;\n    }\n    public Container getContainer() {\n        return container;\n    }\n    public void setContainer(Container container) {\n        this.container = container;\n    }\n    public String getPath() {\n        return path;\n    }\n    public void setPath(String path) {\n        this.path = path;\n    }\n    public String getDocbase() {\n        return docbase;\n    }\n    public void setDocbase(String docbase) {\n        this.docbase = docbase;\n    }\n\n    public ClassLoader getClassLoader() {\n        return classLoader;\n    }\n    public String getInfo() {\n        return \"A simple loader\";\n    }\n    public void addRepository(String repository) {\n    }\n    public String[] findRepositories() {\n        return null;\n    }\n    public synchronized void start() {\n        System.out.println(\"Starting WebappLoader\");\n        try {\n            // create a URLClassLoader\n            //åŠ è½½ç›®å½•æ˜¯minit.baseè§„å®šçš„æ ¹ç›®å½•ï¼ŒåŠ ä¸Šåº”ç”¨ç›®å½•ï¼Œ\n            //ç„¶åä¹‹ä¸‹çš„WEB-INF/classesç›®å½•\n            //è¿™æ„å‘³ç€æ¯ä¸€ä¸ªåº”ç”¨æœ‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œè¾¾åˆ°éš”ç¦»çš„ç›®çš„\n            URL[] urls = new URL[1];\n            URLStreamHandler streamHandler = null;\n            File classPath = new File(System.getProperty(\"minit.base\"));\n            String repository = (new URL(\"file\", null, classPath.getCanonicalPath() + File.separator)).toString();\n            if (docbase != null &amp;&amp; !docbase.equals(\"\")) {\n                repository = repository + docbase + File.separator;\n            }\n            repository = repository + \"WEB-INF\" + File.separator + \"classes\" + File.separator;\n            urls[0] = new URL(null, repository, streamHandler);\n            System.out.println(\"WEbapp classloader Repository : \" + repository);\n            classLoader = new WebappClassLoader(urls, parent);\n        } catch (Exception e) {\n            System.out.println(e.toString());\n        }\n    }\n    public void stop() {\n    }\n}\n</code></pre><p>å¯ä»¥çœ‹å‡ºWebappLoaderæ˜¯æŸä¸ªåº”ç”¨contextçš„ï¼Œå®ƒä»åº”ç”¨çš„WEB-INF/classesä¸‹åŠ è½½ç±»ã€‚</p><pre><code class=\"language-java\">public synchronized void start() {\n    if (docbase!=null &amp;&amp; !docbase.equals(\"\")) {\n    repository = repository + docbase + File.separator;\n    }\n    repository = repository + \"WEB-INF\"+File.separator+\"classes\" + File.separator;\n    urls[0] = new URL(null, repository, streamHandler);\n    classLoader = new WebappClassLoader(urls,parent);\n}\n</code></pre><p>ç„¶åå†æ¥çœ‹çœ‹WebappClassLoaderæ˜¯å¦‚ä½•åŠ è½½ç±»çš„ã€‚</p><pre><code class=\"language-java\">package com.minit.core;\npublic class WebappClassLoader extends URLClassLoader {\n    protected boolean delegate = false;\n    private ClassLoader parent = null;\n    private ClassLoader system = null;\n    public WebappClassLoader() {\n        super(new URL[0]);\n        this.parent = getParent();\n        system = getSystemClassLoader();\n    }\n    public WebappClassLoader(URL[] urls) {\n        super(urls);\n        this.parent = getParent();\n        system = getSystemClassLoader();\n    }\n    public WebappClassLoader(ClassLoader parent) {\n        super(new URL[0], parent);\n        this.parent = parent;\n        system = getSystemClassLoader();\n    }\n    public WebappClassLoader(URL[] urls, ClassLoader parent) {\n        super(urls, parent);\n        this.parent = parent;\n        system = getSystemClassLoader();\n    }\n    public boolean getDelegate() {\n        return (this.delegate);\n    }\n    public void setDelegate(boolean delegate) {\n        this.delegate = delegate;\n    }\n    public Class findClass(String name) throws ClassNotFoundException {\n        Class clazz = null;\n        try {\n            clazz = super.findClass(name);\n        } catch (RuntimeException e) {\n            throw e;\n        }\n        if (clazz == null) {\n            throw new ClassNotFoundException(name);\n        }\n        // Return the class we have located\n        return (clazz);\n    }\n    public Class loadClass(String name) throws ClassNotFoundException {\n        return (loadClass(name, false));\n    }\n    //æ ¸å¿ƒæ–¹æ³•ï¼ŒæŒ‰ç…§è‡ªå®šä¹‰çš„åŠ è½½æ¬¡åºåŠ è½½ç±»\n    public Class&lt;?&gt; loadClass(String name, boolean resolve)\n            throws ClassNotFoundException {\n        Class&lt;?&gt; clazz = null;\n        try {\n            //é¦–å…ˆæ˜¯ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½ç±»\n            clazz = system.loadClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return (clazz);\n            }\n        } catch (ClassNotFoundException e) {\n        }\n        \n        boolean delegateLoad = delegate;\n        //åˆ°äº†è¿™é‡Œï¼Œç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½ä¸æˆåŠŸï¼Œåˆ™åˆ¤æ–­æ˜¯å¦ä¸ºåŒäº²å§”æ‰˜æ¨¡å¼ï¼Œå¦‚æœæ˜¯ï¼Œ\n        //åˆ™ç”¨parentæ¥åŠ è½½å™¨æ¥åŠ è½½\n        if (delegateLoad) {\n            ClassLoader loader = parent;\n            if (loader == null)\n                loader = system;\n            try {\n                clazz = loader.loadClass(name);\n                if (clazz != null) {\n                    if (resolve)\n                        resolveClass(clazz);\n                    return (clazz);\n                }\n            } catch (ClassNotFoundException e) {\n                ;\n            }\n        }\n        //åˆ°äº†è¿™é‡Œï¼Œæˆ–è€…æ˜¯çˆ¶ç±»åŠ è½½å™¨åŠ è½½ä¸æˆåŠŸï¼Œæˆ–è€…æ˜¯ä¸æ”¯æŒåŒäº²å§”æ‰˜æ¨¡å¼ï¼Œ\n        //æ‰€ä»¥è¦è‡ªå·±å»åŠ è½½ç±»\n        try {\n            clazz = findClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return (clazz);\n            }\n        } catch (ClassNotFoundException e) {\n            ;\n        }\n        //åˆ°è¿™é‡Œï¼Œè‡ªå·±åŠ è½½ä¸æˆåŠŸï¼Œåˆ™åè¿‡æ¥äº¤ç»™çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½\n        if (!delegateLoad) {\n            ClassLoader loader = parent;\n            if (loader == null)\n                loader = system;\n            try {\n                clazz = loader.loadClass(name);\n                if (clazz != null) {\n                    if (resolve)\n                        resolveClass(clazz);\n                    return (clazz);\n                }\n            } catch (ClassNotFoundException e) {\n                ;\n            }\n        }\n        throw new ClassNotFoundException(name);\n    }\n    private void log(String message) {\n        System.out.println(\"WebappClassLoader: \" + message);\n    }\n    private void log(String message, Throwable throwable) {\n        System.out.println(\"WebappClassLoader: \" + message);\n        throwable.printStackTrace(System.out);\n    }\n}\n</code></pre><p>æˆ‘ä»¬å†è¯¦ç»†çœ‹çœ‹WebappClassLoaderç±»çš„å®ç°ï¼Œç”±äºè¿™ä¸ªç±»ç»§æ‰¿è‡ªURLClassLoaderï¼Œæ‰€ä»¥findClass()æ²¡æœ‰å˜åŒ–ï¼Œå°±æ˜¯ç®€å•åœ°ä½¿ç”¨çˆ¶ç±»URLClassLoaderçš„findClass()ã€‚è€Œæ„é€ æ–¹æ³•è®°å½•äº†parentå’Œsystemä¸¤ä¸ªå˜é‡ï¼Œè¿™ä¹Ÿæ˜¯ä¸¤ä¸ªClassLoaderï¼Œparentæ˜¯è°ƒç”¨çš„æ—¶å€™ä¼ è¿›æ¥çš„ï¼Œå¯¹äºæ¯ä¸€ä¸ªåº”ç”¨contextæ¥è¯´ï¼Œclassloaderå°±æ˜¯WebappClassLoaderï¼Œè€Œparentå°±æ˜¯CommonClassLoaderï¼Œsystemæ˜¯Javaå†…ç½®æä¾›çš„é‚£äº›ClassLoaderã€‚</p><p>å˜åŒ–æ¯”è¾ƒå¤§çš„æ˜¯loadClass()ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹å®ç°ä»£ç ã€‚</p><pre><code class=\"language-java\">public Class&lt;?&gt; loadClass(String name, boolean resolve)\n        throws ClassNotFoundException {\n    Class&lt;?&gt; clazz = null;\n    try {\n        //å…ˆç”¨ç³»ç»Ÿç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½\n        clazz = system.loadClass(name);\n        if (clazz != null) {\n            if (resolve)\n                resolveClass(clazz);\n            return (clazz);\n        }\n    } catch (ClassNotFoundException e) {\n    }\n    boolean delegateLoad = delegate;\n    //åˆ°è¿™é‡Œï¼Œç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½ä¸æˆåŠŸï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒäº²å§”æ‰˜æ¨¡å¼\n    //å¦‚æœæ˜¯ï¼Œåˆ™ç”¨parentç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½\n    if (delegateLoad) {\n        ClassLoader loader = parent;\n        if (loader == null)\n            loader = system;\n        try {\n            clazz = loader.loadClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return (clazz);\n            }\n        } catch (ClassNotFoundException e) {\n            ;\n        }\n    }\n    //åˆ°è¿™é‡Œï¼Œç³»ç»Ÿå’Œçˆ¶ç±»åŠ è½½å™¨éƒ½åŠ è½½ä¸æˆåŠŸï¼Œåˆ™è‡ªå·±å»åŠ è½½\n    try {\n        clazz = findClass(name);\n        if (clazz != null) {\n            if (resolve)\n                resolveClass(clazz);\n            return (clazz);\n        }\n    } catch (ClassNotFoundException e) {\n        ;\n    }\n    //åˆ°è¿™é‡Œï¼Œè‡ªå·±åŠ è½½ä¸æˆåŠŸï¼Œå¦‚æœä¸æ˜¯åŒäº²å§”æ‰˜æ¨¡å¼ï¼Œåˆ™äº¤ç»™çˆ¶ç±»å»åŠ è½½\n    if (!delegateLoad) {\n        ClassLoader loader = parent;\n        if (loader == null)\n            loader = system;\n        try {\n            clazz = loader.loadClass(name);\n            if (clazz != null) {\n                if (resolve)\n                    resolveClass(clazz);\n                return (clazz);\n            }\n        } catch (ClassNotFoundException e) {\n            ;\n        }\n    }\n    throw new ClassNotFoundException(name);\n</code></pre><p>åœ¨è¿™æ®µä»£ç é‡Œï¼Œå®ƒæ˜¯æŒ‰ç…§ä¸‹é¢è¿™ä¸ªæ¬¡åºæ¥åŠ è½½ç±»çš„ã€‚</p><ol>\n<li>å°è¯•ç”¨ç³»ç»Ÿçš„ClassLoaderå»åŠ è½½æŸä¸ªç±»ï¼Œé˜²æ­¢è¦†ç›–Javaè‡ªèº«çš„ç±»ã€‚</li>\n<li>å¦‚æœæ˜¯delegateæ¨¡å¼ï¼ˆJavaç±»åŠ è½½æœºåˆ¶çš„æ ‡å‡†æ¨¡å¼ï¼‰ï¼Œå°±ç”±parentå»åŠ è½½è¿™ä¸ªç±»ï¼Œéšåå†è¯•ç€è‡ªå·±åŠ è½½ç±»ã€‚</li>\n<li>å¦‚æœä¸æ˜¯delegateæ¨¡å¼ï¼Œå…ˆè‡ªå·±åŠ è½½ç±»ï¼Œå¤±è´¥äº†å†ç”¨parentåŠ è½½ï¼Œå¦‚æœparentä¸ºç©ºï¼Œå°±ç”¨systemåŠ è½½ã€‚</li>\n</ol><p>é€šè¿‡è¿™ä¸ªæ¬¡åºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒJavaæ ‡å‡†ç±»åŠ è½½æœºåˆ¶å·²ç»è¢«æ‰“ç ´ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€å¥—åŠ è½½è§„åˆ™ï¼Œå…ˆå°è¯•ä½¿ç”¨è‡ªèº«å®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œå¦‚æœä¸ç”Ÿæ•ˆå†è€ƒè™‘ä½¿ç”¨åŒäº²ç±»åŠ è½½å™¨ã€‚</p><p>è€Œç›®å½•ç»“æ„åœ¨BootStrapå¯åŠ¨ç±»ä¸­é€šè¿‡MINIT_HOMEå’ŒWEB_ROOTå¸¸é‡å®šä¹‰ã€‚æ‰€ä»¥æ ¹æ®ä¸Šè¿°å®šä¹‰ï¼Œå¦‚æœMinitçš„å®‰è£…ç›®å½•æ˜¯f:\\minitï¼Œé‚£ä¹ˆç›®å½•ç»“æ„å°±æ˜¯è¿™æ ·çš„ã€‚</p><pre><code class=\"language-plain\">f:\\minit\nf:\\minit\\lib&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\nf:\\minit\\webapps\nf:\\mimit\\webapps\\app1\nf:\\mimit\\webapps\\app2\nf:\\mimit\\webapps\\app1\\WEB-INF\\classes\n\nf:\\minit\\lib&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ç”±CommonClassLoaderåŠ è½½\nf:\\mimit\\webapps\\app1\\WEB-INF\\classes&nbsp; &nbsp; &nbsp; ç”±WebappClassLoaderåŠ è½½\n</code></pre><h2>è°ƒæ•´æœåŠ¡å™¨ä»£ç </h2><p>æœ€åæˆ‘ä»¬æŠŠBootStrapå¯åŠ¨ç±»è°ƒæ•´ä¸€ä¸‹ã€‚</p><pre><code class=\"language-java\">package com.minit.startup;\npublic class BootStrap {\n    public static final String MINIT_HOME = System.getProperty(\"user.dir\");\n    public static final String WEB_ROOT =\n            System.getProperty(\"user.dir\") + File.separator + \"webapps\";\n    public static final int PORT = 8080;\n    private static int debug = 0;\n    public static void main(String[] args) {\n        if (debug &gt;= 1)\n            log(\".... startup ....\");\n        System.setProperty(\"minit.home\", MINIT_HOME);\n        System.setProperty(\"minit.base\", WEB_ROOT);\n        HttpConnector connector = new HttpConnector();\n        StandardHost container = new StandardHost();\n        Loader loader = new CommonLoader();\n        container.setLoader(loader);\n        loader.start();\n        connector.setContainer(container);\n        container.setConnector(connector);\n        container.start();\n        connector.start();\n    }\n}\n</code></pre><p>ç¨‹åºé‡Œé¢ä½¿ç”¨çš„æ˜¯StandardHostï¼ŒHostä»£è¡¨äº†æ€»å®¹å™¨ï¼ŒMinitå¯åŠ¨çš„æ—¶å€™ä¼šå¯åŠ¨Connectorå’ŒHostã€‚Hostçš„ç±»åŠ è½½å™¨å°±æ˜¯åˆšæ‰æˆ‘ä»¬å®šä¹‰çš„CommonLoaderã€‚ä»¥åç”±requestå‘invoke()çš„æ—¶å€™ï¼Œéƒ½ä¼šä»hostå¼€å§‹äº†ã€‚</p><p>å…¶å®Hostä¹Ÿæ˜¯å®¹å™¨ï¼Œåªæ˜¯åœ¨Contextæ›´ä¸Šä¸€å±‚ï¼Œè€ŒContexté‡Œçš„ç±»åŠ è½½å™¨åˆ™ä½¿ç”¨çš„æ˜¯WebappClassLoaderï¼Œä½ å¯ä»¥å‚è€ƒStandardHostç±»é‡Œå…³äºgetContextæ–¹æ³•çš„å®ç°ã€‚</p><pre><code class=\"language-java\">public StandardContext getContext(String name){\n\t\tStandardContext context = contextMap.get(name);&nbsp;\n\t\tif ( context == null) {\n\t\t\tcontext = new StandardContext();\n\t&nbsp; &nbsp; &nbsp; &nbsp; context.setDocBase(name);\n\t&nbsp; &nbsp; &nbsp; &nbsp; context.setConnector(connector);\n\t&nbsp; &nbsp; &nbsp; &nbsp; Loader loader = new WebappLoader(name,this.loader.getClassLoader());\n\t&nbsp; &nbsp; &nbsp; &nbsp; context.setLoader(loader);\n\t&nbsp; &nbsp; &nbsp; &nbsp; loader.start();\n\t\t\t\n\t\t\tthis.contextMap.put(name, context);\n\t\t}\n\t\treturn context;\n\t}\n</code></pre><p>å®ƒå†…éƒ¨æœ‰ä¸ªMapæ•°æ®ç»“æ„ä¿å­˜äº†å½“å‰åœ¨ç”¨çš„contextï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±åˆ›å»ºä¸€ä¸ªï¼ŒæŒ‡å®šå®ƒç”¨ä¸€ä¸ªå¯¹åº”çš„WebappLoaderã€‚å¯¹åº”å­˜åœ¨ä¸€ä¸ªStandardHostValveï¼Œè°ƒç”¨invokeæ–¹æ³•åï¼Œå°±ä¼šæ‰§è¡ŒgetContextæ–¹æ³•ï¼Œæ‹¿åˆ°contextå†åšåç»­å·¥ä½œã€‚</p><p>æœ€åï¼Œä¸ºäº†ä½¿ä»£ç ä¿æŒä¸€è‡´ï¼Œå¯ä»¥é€‚å½“è°ƒæ•´ä»£ç ã€‚ä¸€æ˜¯å°†æœåŠ¡å™¨å¯åŠ¨ç«¯å£ç»Ÿä¸€åœ¨BootStrapä¸­å®šä¹‰ï¼ŒHttpConnectorç±»é‡Œæ¶‰åŠportå˜é‡çš„åœ°æ–¹éƒ½ä½¿ç”¨BootStrap.PORTæ›¿æ¢ã€‚äºŒæ˜¯ä¸ºäº†å’Œç±»åŠ è½½å™¨åç§°ä¸€è‡´ï¼ŒåŸæœ¬/webrootç›®å½•æ”¹åä¸º/webappsï¼Œå¹¶åœ¨åº”ç”¨ä¸‹æ–°å¢WEB-INFå±‚çº§ï¼Œéƒ½å’Œä¸Šè¿°ç±»åŠ è½½å™¨é‡Œçš„ä»£ç å®šä¹‰ä¿æŒä¸€è‡´ã€‚</p><h2>æµ‹è¯•</h2><p>ä¸ä»¥å‰ä¸€æ ·ï¼Œæ²¡æœ‰å˜åŒ–ã€‚æˆ‘ä»¬æ‰€æœ‰çš„ä¿®æ”¹éƒ½æ˜¯å†…éƒ¨ç»“æ„çš„ä¿®æ”¹ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬è¿›ä¸€æ­¥å®Œå–„äº†MiniTomcatï¼Œåœ¨åŸæœ‰WebappClassLoaderå®šä¹‰çš„åŸºç¡€ä¸Šï¼Œæ–°å¢Loaderé€šç”¨æ¥å£ä»¥åŠè‡ªå®šä¹‰ClassLoaderï¼Œåœ¨åŠ è½½æ—¶ä¿®æ”¹ç±»çš„åŠ è½½é¡ºåºï¼Œæ‰“ç ´äº†åŒäº²å§”æ‰˜æœºåˆ¶ï¼Œè¿›è€Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œè‡ªå®šä¹‰çš„ç±»åŠ è½½æ“ä½œã€‚</p><p>æˆ‘ä»¬ä¹‹æ‰€ä»¥è¦è‡ªå·±å®šä¹‰ç±»åŠ è½½æ¬¡åºï¼Œä¸»è¦æ˜¯å› ä¸ºMiniTomcatæ˜¯ä¸€ä¸ªæ”¯æŒå¤šåº”ç”¨çš„æœåŠ¡å™¨ï¼Œåº”ç”¨ä¹‹é—´è¦éš”ç¦»ï¼Œå¹¶ä¸”åŒä¸€ä¸ªç±»çš„ä¸åŒç‰ˆæœ¬è¿˜è¦å¯ä»¥åŒæ—¶è¿è¡Œåœ¨ä¸åŒçš„åº”ç”¨ä¸­ã€‚è¿™ä¸ªéœ€æ±‚å°±å¾—é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨å…ˆåŠ è½½è‡ªå·±èƒ½åŠ è½½çš„ç±»ï¼Œç„¶åå†äº¤ç»™ä¸Šå±‚çˆ¶åŠ è½½å™¨å»åŠ è½½ï¼Œè¿™ä¸ªæ¬¡åºåŒºåˆ«äºæ ‡å‡†çš„ç±»åŠ è½½æ¨¡å¼ï¼Œä½ è¦æ³¨æ„ä¸€ä¸‹ã€‚</p><p>è¿™èŠ‚è¯¾ä»£ç å‚è§ï¼š<a href=\"https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter15\">https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter15</a></p><h2>æ€è€ƒé¢˜</h2><p>å­¦å®Œäº†è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœMiniTomcatç®¡ç†ä¸¤ä¸ªWebåº”ç”¨Aå’ŒBï¼Œåº”ç”¨é‡Œé¢ç”¨åˆ°äº†åŒä¸€ä¸ªUserç±»ï¼Œä½†æ˜¯æ˜¯ä¸åŒçš„ç‰ˆæœ¬ï¼Œåº”ç”¨Aé‡Œç”¨çš„Userç±»ç‰ˆæœ¬ä¸º1ï¼Œåº”ç”¨Bçš„Userç±»ç‰ˆæœ¬ä¸º2ï¼Œä¸ºä»€ä¹ˆé‡‡ç”¨åŒäº²å§”æ‰˜æ¨¡å¼å®ç°ä¸äº†è¿™ä¸ªéœ€æ±‚ï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ æƒ³åˆ°çš„ç­”æ¡ˆåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":386924,"user_name":"Geek_50a5cc","can_delete":false,"product_type":"c1","uid":1786951,"ip_address":"åŒ—äº¬","ucode":"0F6C1C2552261F","user_header":"","comment_is_top":false,"comment_ctime":1705907172,"is_pvip":false,"replies":[{"id":141071,"content":"æ˜¯çš„æ˜¯çš„","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705964991,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386924,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"åŒäº²å§”æ‰˜ æ˜¯ å°†ç±»çš„åŠ è½½æ”¾åˆ°ä¸Šä¸€å±‚å¤„ç†ï¼Œå¦‚æœåŠ è½½åˆ°ï¼Œå°±ä¸éœ€è¦é‡å¤åŠ è½½ï¼›æ‰€ä»¥é‡åˆ°ä¸€ä¸ªUserç±»ï¼Œä¸ç®¡æ˜¯ç‰ˆæœ¬1ï¼Œ2ï¼Œéƒ½ä¼šåŠ è½½ï¼Œä¸ä¼šå†å»å¤„ç†å…¶ä»–çš„Userç±»","like_count":2,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":636334,"discussion_content":"æ˜¯çš„æ˜¯çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705964991,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386480,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1704932186,"is_pvip":false,"replies":[{"id":140994,"content":"Q1ï¼Œloaderæ˜¯Tomcatè‡ªå·±çš„åŒ…è£…ï¼Œclassloaderæ˜¯Javaçš„ã€‚MiniTomcatåŒæ ·è¿™ä¹ˆåšçš„ã€‚\nQ2ï¼Œcommonç”¨äºTomcatçš„libç›®å½•ä¸‹çš„åŒ…ï¼Œwebappclassloaderç”¨äºwebappsç›®å½•ä¸‹çš„åº”ç”¨\nQ3ï¼Œsystemæ˜¯æŒ‡Javaæä¾›çš„åŠ è½½å™¨ï¼ŒåŒ…æ‹¬app, extå’Œæ ¹\nQ4ï¼Œä¸€ä¸ªç±»ï¼Œä¿®æ”¹ä¸€ä¸‹ï¼Œé‡æ–°ç¼–è¯‘ï¼Œå°±æ˜¯ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬äº†\nQ5ï¼Œç±»æœ¬èº«çš„ä¿¡æ¯æ”¾åœ¨æ–¹æ³•åŒºçš„(ç°åœ¨å«MetaåŒº)ã€‚è¿™äº›ä¹Ÿä¾èµ–äºJVMæœ¬èº«çš„å®ç°ã€‚\n","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705447255,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386480,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·æ•™è€å¸ˆå‡ ä¸ªé—®é¢˜ï¼š\nQ1ï¼šCommonLoaderä¸CommonClassLoaderæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ\nCommonClassLoaderå¹¶æ²¡æœ‰ç»§æ‰¿CommonLoaderã€‚\nQ2ï¼šTomcatåªæœ‰CommonåŠ è½½å™¨å—ï¼Ÿ\nMiniTomcatç”¨CommonåŠ è½½å™¨æ¥åŠ è½½æœåŠ¡å™¨é€šç”¨çš„ç±»ï¼Œç”¨WebappClassLoaderæ¥åŠ è½½åº”ç”¨çš„ç±»ã€‚ä½†æ˜¯ï¼Œæ–‡ç« ä¸­è®²åˆ°çš„Tomcatçš„ç±»åŠ è½½å›¾ä¸­ï¼Œåªæœ‰Commonï¼Œå¹¶æ²¡æœ‰WebappClassLoaderã€‚\nQ3ï¼šSystemæ˜¯æ‰©å±•ç±»åŠ è½½å™¨å—ï¼Ÿ\næ–‡ä¸­å‡ ä¸ªå…³äºç±»åŠ è½½çš„å›¾ä¸­ï¼Œéƒ½æœ‰â€œSystemâ€è¿™ä¸ªæªè¾ï¼Œå®ƒæ˜¯æŒ‡æ‰©å±•ç±»åŠ è½½å™¨å—ï¼Ÿ\nQ4ï¼šç±»çš„ç‰ˆæœ¬æ€ä¹ˆä½“ç°ï¼Ÿ\nä¸€ä¸ªç±»æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œæ€ä¹ˆä½“ç°ï¼Ÿé€šè¿‡ç±»åå­—æ¥ä½“ç°ï¼Ÿ\nQ5ï¼šç±»è¢«åŠ è½½ä»¥åæ˜¯æ”¾åœ¨æ–¹æ³•åŒºå—ï¼Ÿ\næ¯”å¦‚ï¼Œç±»Personï¼Œè¢«åŠ è½½ä»¥åä¼šåˆ›å»ºä¸€ä¸ªé’ˆå¯¹Personçš„å¯¹è±¡ï¼Œå‡è®¾åå­—æ˜¯Aã€‚é‚£ä¹ˆï¼ŒåŠ è½½ä»¥åå¾—ç±»Personå’ŒAæ˜¯è¢«æ”¾åœ¨å†…å­˜ä¸­çš„æ–¹æ³•åŒºå—ï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635991,"discussion_content":"Q1ï¼Œloaderæ˜¯Tomcatè‡ªå·±çš„åŒ…è£…ï¼Œclassloaderæ˜¯Javaçš„ã€‚MiniTomcatåŒæ ·è¿™ä¹ˆåšçš„ã€‚\nQ2ï¼Œcommonç”¨äºTomcatçš„libç›®å½•ä¸‹çš„åŒ…ï¼Œwebappclassloaderç”¨äºwebappsç›®å½•ä¸‹çš„åº”ç”¨\nQ3ï¼Œsystemæ˜¯æŒ‡Javaæä¾›çš„åŠ è½½å™¨ï¼ŒåŒ…æ‹¬app, extå’Œæ ¹\nQ4ï¼Œä¸€ä¸ªç±»ï¼Œä¿®æ”¹ä¸€ä¸‹ï¼Œé‡æ–°ç¼–è¯‘ï¼Œå°±æ˜¯ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬äº†\nQ5ï¼Œç±»æœ¬èº«çš„ä¿¡æ¯æ”¾åœ¨æ–¹æ³•åŒºçš„(ç°åœ¨å«MetaåŒº)ã€‚è¿™äº›ä¹Ÿä¾èµ–äºJVMæœ¬èº«çš„å®ç°ã€‚\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705447255,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386602,"user_name":"HHğŸ·ğŸ ","can_delete":false,"product_type":"c1","uid":1133678,"ip_address":"å¹¿ä¸œ","ucode":"C50172BDA604D5","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","comment_is_top":false,"comment_ctime":1705204071,"is_pvip":false,"replies":[{"id":140973,"content":"å¯ä»¥æŒ‡å®šdelegateï¼Œæ²¡é—®é¢˜ã€‚ä¸è¿‡æˆ‘æ²¡æ³¨æ„æŸ¥Tomcatè¿™ä¸€éƒ¨åˆ†æºä»£ç æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705401429,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386602,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"JVM é‡Œä¸€ä¸ªç±»çš„å”¯ä¸€æ ‡è¯†æ˜¯ ClassLoader + ç±»å,  æŒ‰ç…§åŒäº²å§”æ´¾æ¨¡å¼éƒ½æ˜¯ç”±ç›¸åŒçš„ ClassLoader å»åŠ è½½ï¼Œ æ— ç–‘ä¼šå†²çªã€‚ è€å¸ˆï¼Œ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ CommonClassLoader æ˜¯ä¸æ˜¯è¦æŒ‡å®šä¸€ä¸‹ delegateï¼Œé»˜è®¤ä¸º false","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635956,"discussion_content":"å¯ä»¥æŒ‡å®šdelegateï¼Œæ²¡é—®é¢˜ã€‚ä¸è¿‡æˆ‘æ²¡æ³¨æ„æŸ¥Tomcatè¿™ä¸€éƒ¨åˆ†æºä»£ç æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705401429,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386453,"user_name":"InfoQ_1f089af08bc8","can_delete":false,"product_type":"c1","uid":1696549,"ip_address":"åŒ—äº¬","ucode":"47D4B6FDCFBE73","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDhIpvB4hJnsn4utiatsHtTwriaSiaWXfMc0FyicBKB7Aibh0x5uxQ5TxMIl2ZhZp0G6jHUib9SPf3T76Q/132","comment_is_top":false,"comment_ctime":1704856531,"is_pvip":false,"replies":[{"id":140897,"content":"loadæ˜¯è§„å®šä¸€ä¸ªæ­¥éª¤ç­–ç•¥ï¼Œæ¯”å¦‚è¯´ç¬¬ä¸€æ­¥ç”¨systemå»æ‰¾ï¼Œç¬¬äºŒæ­¥ç”¨extåŠ è½½å™¨å»æ‰¾ï¼Œè§„å®šäº†ä¸€ä¸ªæ­¥éª¤ã€‚ findæ˜¯æ ¹æ®ä½ç½®æŒ‰ç…§å­—èŠ‚ç è§„èŒƒå»åŠ è½½è¿™ä¸ªç±»,ç„¶åç”¨defineClasså°±æŠŠå­—èŠ‚æµå˜æˆäº†ä¸€ä¸ªç±»ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705024593,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386453,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è€å¸ˆèƒ½å¦è®²è§£ä¸€ä¸‹ç±»åŠ è½½å™¨çš„findClass(String name)å’ŒloadClass(String name)ä¹‹é—´æœ‰ä»€ä¹ˆå…³è”å—ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635653,"discussion_content":"loadæ˜¯è§„å®šä¸€ä¸ªæ­¥éª¤ç­–ç•¥ï¼Œæ¯”å¦‚è¯´ç¬¬ä¸€æ­¥ç”¨systemå»æ‰¾ï¼Œç¬¬äºŒæ­¥ç”¨extåŠ è½½å™¨å»æ‰¾ï¼Œè§„å®šäº†ä¸€ä¸ªæ­¥éª¤ã€‚ findæ˜¯æ ¹æ®ä½ç½®æŒ‰ç…§å­—èŠ‚ç è§„èŒƒå»åŠ è½½è¿™ä¸ªç±»,ç„¶åç”¨defineClasså°±æŠŠå­—èŠ‚æµå˜æˆäº†ä¸€ä¸ªç±»ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705024593,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386451,"user_name":"InfoQ_1f089af08bc8","can_delete":false,"product_type":"c1","uid":1696549,"ip_address":"åŒ—äº¬","ucode":"47D4B6FDCFBE73","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIDhIpvB4hJnsn4utiatsHtTwriaSiaWXfMc0FyicBKB7Aibh0x5uxQ5TxMIl2ZhZp0G6jHUib9SPf3T76Q/132","comment_is_top":false,"comment_ctime":1704853339,"is_pvip":false,"replies":[{"id":140993,"content":"ä¸€ä¸ªèµ„æºçš„å®šä½ç”¨urlè¡¨ç¤ºï¼Œå¦‚ä½•æ‰“å¼€è¿™ä¸ªèµ„æºå‘¢ï¼Ÿé€šè¿‡æŸç§åè®®ï¼Œå¦‚http, httpsï¼Œæˆ–è€…fileï¼Œè¿™ä¸ªhandlerå°±æ˜¯æ¥å¤„ç†åè®®çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1705446934,"ip_address":"æ¾³å¤§åˆ©äºš","comment_id":386451,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·é—®è€å¸ˆï¼ŒURLStreamHandler è¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635990,"discussion_content":"ä¸€ä¸ªèµ„æºçš„å®šä½ç”¨urlè¡¨ç¤ºï¼Œå¦‚ä½•æ‰“å¼€è¿™ä¸ªèµ„æºå‘¢ï¼Ÿé€šè¿‡æŸç§åè®®ï¼Œå¦‚http, httpsï¼Œæˆ–è€…fileï¼Œè¿™ä¸ªhandlerå°±æ˜¯æ¥å¤„ç†åè®®çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1705446934,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¾³å¤§åˆ©äºš","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":390878,"user_name":"å¤©æ•Œ","can_delete":false,"product_type":"c1","uid":1059944,"ip_address":"å››å·","ucode":"CD29A622197197","user_header":"https://static001.geekbang.org/account/avatar/00/10/2c/68/c299bc71.jpg","comment_is_top":false,"comment_ctime":1716554210,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"CommonClassLoader æ˜¯å¦éœ€è¦å°† lib ç›®å½•ä¸‹çš„æ‰€æœ‰jaræ–‡ä»¶è¯»å–åˆ°ï¼Œè½¬æ¢æˆURLä¼ å…¥æ„é€ å‡½æ•°æ‰èƒ½æˆåŠŸè¯»å–ï¼Ÿ","like_count":0}]}