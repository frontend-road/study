{"id":104277,"title":"41 | IPCï¼ˆä¸­ï¼‰ï¼šä¸åŒé¡¹ç›®ç»„ä¹‹é—´æŠ¢èµ„æºï¼Œå¦‚ä½•åè°ƒï¼Ÿ","content":"<p>äº†è§£äº†å¦‚ä½•ä½¿ç”¨å…±äº«å†…å­˜å’Œä¿¡å·é‡é›†åˆä¹‹åï¼Œä»Šå¤©æˆ‘ä»¬æ¥è§£æä¸€ä¸‹ï¼Œå†…æ ¸é‡Œé¢éƒ½åšäº†ä»€ä¹ˆã€‚</p><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œå’±ä»¬è®²æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ã€ä¿¡å·é‡çš„æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…¶å®èƒ½å¤Ÿä»ä¸­çœ‹åˆ°ä¸€äº›ç»Ÿä¸€çš„è§„å¾‹ï¼š<strong>å®ƒä»¬åœ¨ä½¿ç”¨ä¹‹å‰éƒ½è¦ç”Ÿæˆkeyï¼Œç„¶åé€šè¿‡keyå¾—åˆ°å”¯ä¸€çš„idï¼Œå¹¶ä¸”éƒ½æ˜¯é€šè¿‡xxxgetå‡½æ•°ã€‚</strong></p><p>åœ¨å†…æ ¸é‡Œé¢ï¼Œè¿™ä¸‰ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶æ˜¯ä½¿ç”¨ç»Ÿä¸€çš„æœºåˆ¶ç®¡ç†èµ·æ¥çš„ï¼Œéƒ½å«ipcxxxã€‚</p><p>ä¸ºäº†ç»´æŠ¤è¿™ä¸‰ç§è¿›ç¨‹é—´é€šä¿¡è¿›åˆ¶ï¼Œåœ¨å†…æ ¸é‡Œé¢ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªæœ‰ä¸‰é¡¹çš„æ•°ç»„ã€‚</p><p>æˆ‘ä»¬é€šè¿‡è¿™æ®µä»£ç ï¼Œæ¥å…·ä½“çœ‹ä¸€çœ‹ã€‚</p><pre><code>struct ipc_namespace {\n......\n\tstruct ipc_ids\tids[3];\n......\n}\n\n#define IPC_SEM_IDS\t0\n#define IPC_MSG_IDS\t1\n#define IPC_SHM_IDS\t2\n\n#define sem_ids(ns)\t((ns)-&gt;ids[IPC_SEM_IDS])\n#define msg_ids(ns)\t((ns)-&gt;ids[IPC_MSG_IDS])\n#define shm_ids(ns)\t((ns)-&gt;ids[IPC_SHM_IDS])\n</code></pre><p>æ ¹æ®ä»£ç ä¸­çš„å®šä¹‰ï¼Œç¬¬0é¡¹ç”¨äºä¿¡å·é‡ï¼Œç¬¬1é¡¹ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç¬¬2é¡¹ç”¨äºå…±äº«å†…å­˜ï¼Œåˆ†åˆ«å¯ä»¥é€šè¿‡sem_idsã€msg_idsã€shm_idsæ¥è®¿é—®ã€‚</p><p>è¿™æ®µä»£ç é‡Œé¢æœ‰nsï¼Œå…¨ç§°å«namespaceã€‚å¯èƒ½ä¸å®¹æ˜“ç†è§£ï¼Œä½ ç°åœ¨å¯ä»¥å°†å®ƒè®¤ä¸ºæ˜¯å°†ä¸€å°LinuxæœåŠ¡å™¨é€»è¾‘çš„éš”ç¦»ä¸ºå¤šå°LinuxæœåŠ¡å™¨çš„æœºåˆ¶ï¼Œå®ƒèƒŒåçš„åŸç†æ˜¯ä¸€ä¸ªç›¸å½“å¤§çš„è¯é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®¹å™¨é‚£ä¸€ç« è¯¦ç»†è®²è¿°ã€‚ç°åœ¨ï¼Œä½ å°±å¯ä»¥ç®€å•çš„è®¤ä¸ºæ²¡æœ‰namespaceï¼Œæ•´ä¸ªLinuxåœ¨ä¸€ä¸ªnamespaceä¸‹é¢ï¼Œé‚£è¿™äº›idsä¹Ÿæ˜¯æ•´ä¸ªLinuxåªæœ‰ä¸€ä»½ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹struct ipc_idsé‡Œé¢ä¿å­˜äº†ä»€ä¹ˆã€‚</p><!-- [[[read_end]]] --><p>é¦–å…ˆï¼Œin_useè¡¨ç¤ºå½“å‰æœ‰å¤šå°‘ä¸ªipcï¼›å…¶æ¬¡ï¼Œseqå’Œnext_idç”¨äºä¸€èµ·ç”Ÿæˆipcå”¯ä¸€çš„idï¼Œå› ä¸ºä¿¡å·é‡ï¼Œå…±äº«å†…å­˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒä»¬ä¸‰ä¸ªçš„idä¹Ÿä¸èƒ½é‡å¤ï¼›ipcs_idræ˜¯ä¸€æ£µåŸºæ•°æ ‘ï¼Œæˆ‘ä»¬åˆç¢°åˆ°å®ƒäº†ï¼Œä¸€æ—¦æ¶‰åŠä»ä¸€ä¸ªæ•´æ•°æŸ¥æ‰¾ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒéƒ½æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p><pre><code>struct ipc_ids {\n\tint in_use;\n\tunsigned short seq;\n\tstruct rw_semaphore rwsem;\n\tstruct idr ipcs_idr;\n\tint next_id;\n};\n\nstruct idr {\n\tstruct radix_tree_root\tidr_rt;\n\tunsigned int\t\tidr_next;\n};\n</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºsem_idsã€msg_idsã€shm_idså„æœ‰ä¸€æ£µåŸºæ•°æ ‘ã€‚é‚£è¿™æ£µæ ‘é‡Œé¢ç©¶ç«Ÿå­˜æ”¾äº†ä»€ä¹ˆï¼Œèƒ½å¤Ÿç»Ÿä¸€ç®¡ç†è¿™ä¸‰ç±»ipcå¯¹è±¡å‘¢ï¼Ÿ</p><p>é€šè¿‡ä¸‹é¢è¿™ä¸ªå‡½æ•°ipc_obtain_object_idrï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºç«¯å€ªã€‚è¿™ä¸ªå‡½æ•°æ ¹æ®idï¼Œåœ¨åŸºæ•°æ ‘é‡Œé¢æ‰¾å‡ºæ¥çš„æ˜¯struct kern_ipc_permã€‚</p><pre><code>struct kern_ipc_perm *ipc_obtain_object_idr(struct ipc_ids *ids, int id)\n{\n\tstruct kern_ipc_perm *out;\n\tint lid = ipcid_to_idx(id);\n\tout = idr_find(&amp;ids-&gt;ipcs_idr, lid);\n\treturn out;\n}\n</code></pre><p>å¦‚æœæˆ‘ä»¬çœ‹ç”¨äºè¡¨ç¤ºä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜çš„ç»“æ„ï¼Œå°±ä¼šå‘ç°ï¼Œè¿™ä¸‰ä¸ªç»“æ„çš„ç¬¬ä¸€é¡¹éƒ½æ˜¯struct kern_ipc_permã€‚</p><pre><code>struct sem_array {\n\tstruct kern_ipc_perm\tsem_perm;\t/* permissions .. see ipc.h */\n\ttime_t\t\t\tsem_ctime;\t/* create/last semctl() time */\n\tstruct list_head\tpending_alter;\t/* pending operations */\n\t\t\t\t\t\t                /* that alter the array */\n\tstruct list_head\tpending_const;\t/* pending complex operations */\n\t\t\t\t\t\t/* that do not alter semvals */\n\tstruct list_head\tlist_id;\t/* undo requests on this array */\n\tint\t\t\tsem_nsems;\t/* no. of semaphores in array */\n\tint\t\t\tcomplex_count;\t/* pending complex operations */\n\tunsigned int\t\tuse_global_lock;/* &gt;0: global lock required */\n\n\tstruct sem\t\tsems[];\n} __randomize_layout;\n\nstruct msg_queue {\n\tstruct kern_ipc_perm q_perm;\n\ttime_t q_stime;\t\t\t/* last msgsnd time */\n\ttime_t q_rtime;\t\t\t/* last msgrcv time */\n\ttime_t q_ctime;\t\t\t/* last change time */\n\tunsigned long q_cbytes;\t\t/* current number of bytes on queue */\n\tunsigned long q_qnum;\t\t/* number of messages in queue */\n\tunsigned long q_qbytes;\t\t/* max number of bytes on queue */\n\tpid_t q_lspid;\t\t\t/* pid of last msgsnd */\n\tpid_t q_lrpid;\t\t\t/* last receive pid */\n\n\tstruct list_head q_messages;\n\tstruct list_head q_receivers;\n\tstruct list_head q_senders;\n} __randomize_layout;\n\nstruct shmid_kernel /* private to the kernel */\n{\t\n\tstruct kern_ipc_perm\tshm_perm;\n\tstruct file\t\t*shm_file;\n\tunsigned long\t\tshm_nattch;\n\tunsigned long\t\tshm_segsz;\n\ttime_t\t\t\tshm_atim;\n\ttime_t\t\t\tshm_dtim;\n\ttime_t\t\t\tshm_ctim;\n\tpid_t\t\t\tshm_cprid;\n\tpid_t\t\t\tshm_lprid;\n\tstruct user_struct\t*mlock_user;\n\n\t/* The task created the shm object.  NULL if the task is dead. */\n\tstruct task_struct\t*shm_creator;\n\tstruct list_head\tshm_clist;\t/* list by creator */\n} __randomize_layout;\n</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡struct kern_ipc_permçš„æŒ‡é’ˆï¼Œé€šè¿‡è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢åï¼Œå¾—åˆ°æ•´ä¸ªç»“æ„ã€‚åšè¿™ä»¶äº‹æƒ…çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><pre><code>static inline struct sem_array *sem_obtain_object(struct ipc_namespace *ns, int id)\n{\n\tstruct kern_ipc_perm *ipcp = ipc_obtain_object_idr(&amp;sem_ids(ns), id);\n\treturn container_of(ipcp, struct sem_array, sem_perm);\n}\n\nstatic inline struct msg_queue *msq_obtain_object(struct ipc_namespace *ns, int id)\n{\n\tstruct kern_ipc_perm *ipcp = ipc_obtain_object_idr(&amp;msg_ids(ns), id);\n\treturn container_of(ipcp, struct msg_queue, q_perm);\n}\n\nstatic inline struct shmid_kernel *shm_obtain_object(struct ipc_namespace *ns, int id)\n{\n\tstruct kern_ipc_perm *ipcp = ipc_obtain_object_idr(&amp;shm_ids(ns), id);\n\treturn container_of(ipcp, struct shmid_kernel, shm_perm);\n}\n</code></pre><p>é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜æŠ½è±¡ä¸ºipcç±»å‹è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚ä½ æœ‰æ²¡æœ‰è§‰å¾—ï¼Œè¿™æœ‰ç‚¹å„¿é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­æŠ½è±¡ç±»å’Œå®ç°ç±»çš„æ„æ€ï¼Ÿæ²¡é”™ï¼Œå¦‚æœä½ è¯•å›¾å»äº†è§£C++ä¸­ç±»çš„å®ç°æœºåˆ¶ï¼Œå…¶å®ä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/08/af/082b742753d862cfeae520fb02aa41af.png?wh=1813*1771\" alt=\"\"></p><p>æœ‰äº†æŠ½è±¡ç±»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å…±äº«å†…å­˜å’Œä¿¡å·é‡çš„å…·ä½“å®ç°ã€‚</p><h2>å¦‚ä½•åˆ›å»ºå…±äº«å†…å­˜ï¼Ÿ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹åˆ›å»ºå…±äº«å†…å­˜çš„çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><pre><code>SYSCALL_DEFINE3(shmget, key_t, key, size_t, size, int, shmflg)\n{\n\tstruct ipc_namespace *ns;\n\tstatic const struct ipc_ops shm_ops = {\n\t\t.getnew = newseg,\n\t\t.associate = shm_security,\n\t\t.more_checks = shm_more_checks,\n\t};\n\tstruct ipc_params shm_params;\n\tns = current-&gt;nsproxy-&gt;ipc_ns;\n\tshm_params.key = key;\n\tshm_params.flg = shmflg;\n\tshm_params.u.size = size;\n\treturn ipcget(ns, &amp;shm_ids(ns), &amp;shm_ops, &amp;shm_params);\n}\n</code></pre><p>è¿™é‡Œé¢è°ƒç”¨äº†æŠ½è±¡çš„ipcgetã€å‚æ•°åˆ†åˆ«ä¸ºå…±äº«å†…å­˜å¯¹åº”çš„shm_idsã€å¯¹åº”çš„æ“ä½œshm_opsä»¥åŠå¯¹åº”çš„å‚æ•°shm_paramsã€‚</p><p>å¦‚æœkeyè®¾ç½®ä¸ºIPC_PRIVATEåˆ™æ°¸è¿œåˆ›å»ºæ–°çš„ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±ä¼šè°ƒç”¨ipcget_publicã€‚ipcgetçš„å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code>int ipcget(struct ipc_namespace *ns, struct ipc_ids *ids,\n\t\t\tconst struct ipc_ops *ops, struct ipc_params *params)\n{\n\tif (params-&gt;key == IPC_PRIVATE)\n\t\treturn ipcget_new(ns, ids, ops, params);\n\telse\n\t\treturn ipcget_public(ns, ids, ops, params);\n}\n\nstatic int ipcget_public(struct ipc_namespace *ns, struct ipc_ids *ids, const struct ipc_ops *ops, struct ipc_params *params)\n{\n\tstruct kern_ipc_perm *ipcp;\n\tint flg = params-&gt;flg;\n\tint err;\n\tipcp = ipc_findkey(ids, params-&gt;key);\n\tif (ipcp == NULL) {\n\t\tif (!(flg &amp; IPC_CREAT))\n\t\t\terr = -ENOENT;\n\t\telse\n\t\t\terr = ops-&gt;getnew(ns, params);\n\t} else {\n\t\tif (flg &amp; IPC_CREAT &amp;&amp; flg &amp; IPC_EXCL)\n\t\t\terr = -EEXIST;\n\t\telse {\n\t\t\terr = 0;\n\t\t\tif (ops-&gt;more_checks)\n\t\t\t\terr = ops-&gt;more_checks(ipcp, params);\n......\n\t\t}\n\t}\n\treturn err;\n}\n</code></pre><p>åœ¨ipcget_publicä¸­ï¼Œæˆ‘ä»¬ä¼šæŒ‰ç…§keyï¼Œå»æŸ¥æ‰¾struct kern_ipc_permã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£å°±çœ‹æ˜¯å¦è®¾ç½®äº†IPC_CREATï¼›å¦‚æœè®¾ç½®äº†ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±å°†å¯¹åº”çš„idè¿”å›ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œé‡ç‚¹çœ‹ï¼Œå¦‚ä½•æŒ‰ç…§å‚æ•°shm_opsï¼Œåˆ›å»ºæ–°çš„å…±äº«å†…å­˜ï¼Œä¼šè°ƒç”¨newsegã€‚</p><pre><code>static int newseg(struct ipc_namespace *ns, struct ipc_params *params)\n{\n\tkey_t key = params-&gt;key;\n\tint shmflg = params-&gt;flg;\n\tsize_t size = params-&gt;u.size;\n\tint error;\n\tstruct shmid_kernel *shp;\n\tsize_t numpages = (size + PAGE_SIZE - 1) &gt;&gt; PAGE_SHIFT;\n\tstruct file *file;\n\tchar name[13];\n\tvm_flags_t acctflag = 0;\n......\n\tshp = kvmalloc(sizeof(*shp), GFP_KERNEL);\n......\n\tshp-&gt;shm_perm.key = key;\n\tshp-&gt;shm_perm.mode = (shmflg &amp; S_IRWXUGO);\n\tshp-&gt;mlock_user = NULL;\n\n\tshp-&gt;shm_perm.security = NULL;\n......\n\tfile = shmem_kernel_file_setup(name, size, acctflag);\n......\n\tshp-&gt;shm_cprid = task_tgid_vnr(current);\n\tshp-&gt;shm_lprid = 0;\n\tshp-&gt;shm_atim = shp-&gt;shm_dtim = 0;\n\tshp-&gt;shm_ctim = get_seconds();\n\tshp-&gt;shm_segsz = size;\n\tshp-&gt;shm_nattch = 0;\n\tshp-&gt;shm_file = file;\n\tshp-&gt;shm_creator = current;\n\n\terror = ipc_addid(&amp;shm_ids(ns), &amp;shp-&gt;shm_perm, ns-&gt;shm_ctlmni);\n......\n\tlist_add(&amp;shp-&gt;shm_clist, &amp;current-&gt;sysvshm.shm_clist);\n......\n\tfile_inode(file)-&gt;i_ino = shp-&gt;shm_perm.id;\n\n\tns-&gt;shm_tot += numpages;\n\terror = shp-&gt;shm_perm.id;\n......\n\treturn error;\n}\n</code></pre><p><strong>newsegå‡½æ•°çš„ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡kvmallocåœ¨ç›´æ¥æ˜ å°„åŒºåˆ†é…ä¸€ä¸ªstruct shmid_kernelç»“æ„ã€‚</strong>è¿™ä¸ªç»“æ„å°±æ˜¯ç”¨æ¥æè¿°å…±äº«å†…å­˜çš„ã€‚è¿™ä¸ªç»“æ„æœ€å¼€å§‹å°±æ˜¯ä¸Šé¢è¯´çš„struct kern_ipc_permç»“æ„ã€‚æ¥ä¸‹æ¥å°±æ˜¯å¡«å……è¿™ä¸ªstruct shmid_kernelç»“æ„ï¼Œä¾‹å¦‚keyã€æƒé™ç­‰ã€‚</p><p><strong>newsegå‡½æ•°çš„ç¬¬äºŒæ­¥ï¼Œå…±äº«å†…å­˜éœ€è¦å’Œæ–‡ä»¶è¿›è¡Œå…³è”</strong>ã€‚**ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªå‘¢ï¼Ÿæˆ‘ä»¬åœ¨è®²å†…å­˜æ˜ å°„çš„æ—¶å€™è®²è¿‡ï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´å¯ä»¥å’Œç‰©ç†å†…å­˜å…³è”ï¼Œä½†æ˜¯ç‰©ç†å†…å­˜æ˜¯æŸä¸ªè¿›ç¨‹ç‹¬äº«çš„ã€‚è™šæ‹Ÿåœ°å€ç©ºé—´ä¹Ÿå¯ä»¥æ˜ å°„åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶æ˜¯å¯ä»¥è·¨è¿›ç¨‹å…±äº«çš„ã€‚</p><p>å’±ä»¬è¿™é‡Œçš„å…±äº«å†…å­˜éœ€è¦è·¨è¿›ç¨‹å…±äº«ï¼Œä¹Ÿåº”è¯¥å€Ÿé‰´æ–‡ä»¶æ˜ å°„çš„æ€è·¯ã€‚åªä¸è¿‡ä¸åº”è¯¥æ˜ å°„ä¸€ä¸ªç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œè€Œæ˜¯æ˜ å°„åˆ°ä¸€ä¸ªå†…å­˜æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ã€‚mm/shmem.cé‡Œé¢å°±å®šä¹‰äº†è¿™æ ·ä¸€ä¸ªåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™é‡Œä½ ä¸€å®šè¦æ³¨æ„åŒºåˆ†shmemå’Œshmçš„åŒºåˆ«ï¼Œå‰è€…æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œåè€…æ˜¯è¿›ç¨‹é€šä¿¡æœºåˆ¶ã€‚</p><p>åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œshmem_initæ³¨å†Œäº†shmemæ–‡ä»¶ç³»ç»Ÿshmem_fs_typeï¼Œå¹¶ä¸”æŒ‚åœ¨åˆ°äº†shm_mntä¸‹é¢ã€‚</p><pre><code>int __init shmem_init(void)\n{\n\tint error;\n\terror = shmem_init_inodecache();\n\terror = register_filesystem(&amp;shmem_fs_type);\n\tshm_mnt = kern_mount(&amp;shmem_fs_type);\n......\n\treturn 0;\n}\n\nstatic struct file_system_type shmem_fs_type = {\n\t.owner\t\t= THIS_MODULE,\n\t.name\t\t= &quot;tmpfs&quot;,\n\t.mount\t\t= shmem_mount,\n\t.kill_sb\t= kill_litter_super,\n\t.fs_flags\t= FS_USERNS_MOUNT,\n};\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œnewsegå‡½æ•°ä¼šè°ƒç”¨shmem_kernel_file_setupï¼Œå…¶å®å°±æ˜¯åœ¨shmemæ–‡ä»¶ç³»ç»Ÿé‡Œé¢åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ã€‚</p><pre><code>/**\n * shmem_kernel_file_setup - get an unlinked file living in tmpfs which must be kernel internal.  \n * @name: name for dentry (to be seen in /proc/&lt;pid&gt;/maps\n * @size: size to be set for the file\n * @flags: VM_NORESERVE suppresses pre-accounting of the entire object size */\nstruct file *shmem_kernel_file_setup(const char *name, loff_t size, unsigned long flags)\n{\n\treturn __shmem_file_setup(name, size, flags, S_PRIVATE);\n}\n\nstatic struct file *__shmem_file_setup(const char *name, loff_t size,\n\t\t\t\t       unsigned long flags, unsigned int i_flags)\n{\n\tstruct file *res;\n\tstruct inode *inode;\n\tstruct path path;\n\tstruct super_block *sb;\n\tstruct qstr this;\n......\n\tthis.name = name;\n\tthis.len = strlen(name);\n\tthis.hash = 0; /* will go */\n\tsb = shm_mnt-&gt;mnt_sb;\n\tpath.mnt = mntget(shm_mnt);\n\tpath.dentry = d_alloc_pseudo(sb, &amp;this);\n\td_set_d_op(path.dentry, &amp;anon_ops);\n......\n\tinode = shmem_get_inode(sb, NULL, S_IFREG | S_IRWXUGO, 0, flags);\n\tinode-&gt;i_flags |= i_flags;\n\td_instantiate(path.dentry, inode);\n\tinode-&gt;i_size = size;\n......\n\tres = alloc_file(&amp;path, FMODE_WRITE | FMODE_READ,\n\t\t  &amp;shmem_file_operations);\n\treturn res;\n}\n</code></pre><p>__shmem_file_setupä¼šåˆ›å»ºæ–°çš„shmemæ–‡ä»¶å¯¹åº”çš„dentryå’Œinodeï¼Œå¹¶å°†å®ƒä»¬ä¸¤ä¸ªå…³è”èµ·æ¥ï¼Œç„¶ååˆ†é…ä¸€ä¸ªstruct fileç»“æ„ï¼Œæ¥è¡¨ç¤ºæ–°çš„shmemæ–‡ä»¶ï¼Œå¹¶ä¸”æŒ‡å‘ç‹¬ç‰¹çš„shmem_file_operationsã€‚</p><pre><code>static const struct file_operations shmem_file_operations = {\n\t.mmap\t\t= shmem_mmap,\n\t.get_unmapped_area = shmem_get_unmapped_area,\n#ifdef CONFIG_TMPFS\n\t.llseek\t\t= shmem_file_llseek,\n\t.read_iter\t= shmem_file_read_iter,\n\t.write_iter\t= generic_file_write_iter,\n\t.fsync\t\t= noop_fsync,\n\t.splice_read\t= generic_file_splice_read,\n\t.splice_write\t= iter_file_splice_write,\n\t.fallocate\t= shmem_fallocate,\n#endif\n};\n</code></pre><p><strong>newsegå‡½æ•°çš„ç¬¬ä¸‰æ­¥ï¼Œé€šè¿‡ipc_addidå°†æ–°åˆ›å»ºçš„struct shmid_kernelç»“æ„æŒ‚åˆ°shm_idsé‡Œé¢çš„åŸºæ•°æ ‘ä¸Šï¼Œå¹¶è¿”å›ç›¸åº”çš„idï¼Œå¹¶ä¸”å°†struct shmid_kernelæŒ‚åˆ°å½“å‰è¿›ç¨‹çš„sysvshmé˜Ÿåˆ—ä¸­ã€‚</strong></p><p>è‡³æ­¤ï¼Œå…±äº«å†…å­˜çš„åˆ›å»ºå°±å®Œæˆäº†ã€‚</p><h2>å¦‚ä½•å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Ÿ</h2><p>ä»ä¸Šé¢çš„ä»£ç è§£æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå…±äº«å†…å­˜çš„æ•°æ®ç»“æ„struct shmid_kernelï¼Œæ˜¯é€šè¿‡å®ƒçš„æˆå‘˜struct file *shm_fileï¼Œæ¥ç®¡ç†å†…å­˜æ–‡ä»¶ç³»ç»Ÿshmemä¸Šçš„å†…å­˜æ–‡ä»¶çš„ã€‚æ— è®ºè¿™ä¸ªå…±äº«å†…å­˜æ˜¯å¦è¢«æ˜ å°„ï¼Œshm_fileéƒ½æ˜¯å­˜åœ¨çš„ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ã€‚è°ƒç”¨çš„æ˜¯shmatï¼Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å¦‚ä¸‹ï¼š</p><pre><code>SYSCALL_DEFINE3(shmat, int, shmid, char __user *, shmaddr, int, shmflg)\n{\n    unsigned long ret;\n    long err;\n    err = do_shmat(shmid, shmaddr, shmflg, &amp;ret, SHMLBA);\n    force_successful_syscall_return();\n    return (long)ret;\n}\n\nlong do_shmat(int shmid, char __user *shmaddr, int shmflg,\n\t      ulong *raddr, unsigned long shmlba)\n{\n\tstruct shmid_kernel *shp;\n\tunsigned long addr = (unsigned long)shmaddr;\n\tunsigned long size;\n\tstruct file *file;\n\tint    err;\n\tunsigned long flags = MAP_SHARED;\n\tunsigned long prot;\n\tint acc_mode;\n\tstruct ipc_namespace *ns;\n\tstruct shm_file_data *sfd;\n\tstruct path path;\n\tfmode_t f_mode;\n\tunsigned long populate = 0;\n......\n\tprot = PROT_READ | PROT_WRITE;\n\tacc_mode = S_IRUGO | S_IWUGO;\n\tf_mode = FMODE_READ | FMODE_WRITE;\n......\n\tns = current-&gt;nsproxy-&gt;ipc_ns;\n\tshp = shm_obtain_object_check(ns, shmid);\n......\n\tpath = shp-&gt;shm_file-&gt;f_path;\n\tpath_get(&amp;path);\n\tshp-&gt;shm_nattch++;\n\tsize = i_size_read(d_inode(path.dentry));\n......\n\tsfd = kzalloc(sizeof(*sfd), GFP_KERNEL);\n......\n\tfile = alloc_file(&amp;path, f_mode,\n\t\t\t  is_file_hugepages(shp-&gt;shm_file) ?\n\t\t\t\t&amp;shm_file_operations_huge :\n\t\t\t\t&amp;shm_file_operations);\n......\n\tfile-&gt;private_data = sfd;\n\tfile-&gt;f_mapping = shp-&gt;shm_file-&gt;f_mapping;\n\tsfd-&gt;id = shp-&gt;shm_perm.id;\n\tsfd-&gt;ns = get_ipc_ns(ns);\n\tsfd-&gt;file = shp-&gt;shm_file;\n\tsfd-&gt;vm_ops = NULL;\n......\n\taddr = do_mmap_pgoff(file, addr, size, prot, flags, 0, &amp;populate, NULL);\n\t*raddr = addr;\n\terr = 0;\n......\n\treturn err;\n}\n</code></pre><p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œshm_obtain_object_checkä¼šé€šè¿‡å…±äº«å†…å­˜çš„idï¼Œåœ¨åŸºæ•°æ ‘ä¸­æ‰¾åˆ°å¯¹åº”çš„struct shmid_kernelç»“æ„ï¼Œé€šè¿‡å®ƒæ‰¾åˆ°shmemä¸Šçš„å†…å­˜æ–‡ä»¶ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦åˆ†é…ä¸€ä¸ªstruct shm_file_dataï¼Œæ¥è¡¨ç¤ºè¿™ä¸ªå†…å­˜æ–‡ä»¶ã€‚å°†shmemä¸­æŒ‡å‘å†…å­˜æ–‡ä»¶çš„shm_fileèµ‹å€¼ç»™struct shm_file_dataä¸­çš„fileæˆå‘˜ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªstruct fileï¼ŒæŒ‡å‘çš„ä¹Ÿæ˜¯shmemä¸­çš„å†…å­˜æ–‡ä»¶ã€‚</p><p>ä¸ºä»€ä¹ˆè¦å†åˆ›å»ºä¸€ä¸ªå‘¢ï¼Ÿè¿™ä¸¤ä¸ªçš„åŠŸèƒ½ä¸åŒï¼Œshmemä¸­shm_fileç”¨äºç®¡ç†å†…å­˜æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªä¸­ç«‹çš„ï¼Œç‹¬ç«‹äºä»»ä½•ä¸€ä¸ªè¿›ç¨‹çš„è§’è‰²ã€‚è€Œæ–°åˆ›å»ºçš„struct fileæ˜¯ä¸“é—¨ç”¨äºåšå†…å­˜æ˜ å°„çš„ï¼Œå°±åƒå’±ä»¬åœ¨è®²å†…å­˜æ˜ å°„é‚£ä¸€èŠ‚è®²è¿‡çš„ï¼Œä¸€ä¸ªç¡¬ç›˜ä¸Šçš„æ–‡ä»¶è¦æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„æ—¶å€™ï¼Œéœ€è¦åœ¨vm_area_structé‡Œé¢æœ‰ä¸€ä¸ªstruct file *vm_fileæŒ‡å‘ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œç°åœ¨å˜æˆå†…å­˜æ–‡ä»¶äº†ï¼Œä½†æ˜¯è¿™ä¸ªç»“æ„è¿˜æ˜¯ä¸èƒ½å°‘ã€‚</p><p>æ–°åˆ›å»ºçš„struct fileçš„private_dataï¼ŒæŒ‡å‘struct shm_file_dataï¼Œè¿™æ ·å†…å­˜æ˜ å°„é‚£éƒ¨åˆ†çš„æ•°æ®ç»“æ„ï¼Œå°±èƒ½å¤Ÿé€šè¿‡å®ƒæ¥è®¿é—®å†…å­˜æ–‡ä»¶äº†ã€‚</p><p>æ–°åˆ›å»ºçš„struct fileçš„file_operationsä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œå˜æˆäº†shm_file_operationsã€‚</p><pre><code>static const struct file_operations shm_file_operations = {\n\t.mmap\t\t= shm_mmap,\n\t.fsync\t\t= shm_fsync,\n\t.release\t= shm_release,\n\t.get_unmapped_area\t= shm_get_unmapped_area,\n\t.llseek\t\t= noop_llseek,\n\t.fallocate\t= shm_fallocate,\n};\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œdo_mmap_pgoffå‡½æ•°æˆ‘ä»¬é‡åˆ°è¿‡ï¼ŒåŸæ¥æ˜ å°„ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯è°ƒç”¨å®ƒã€‚è¿™é‡Œæˆ‘ä»¬ä¸å†è¯¦ç»†è§£æäº†ã€‚å®ƒä¼šåˆ†é…ä¸€ä¸ªvm_area_structæŒ‡å‘è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ²¡æœ‰åˆ†é…çš„åŒºåŸŸï¼Œå®ƒçš„vm_fileæŒ‡å‘è¿™ä¸ªå†…å­˜æ–‡ä»¶ï¼Œç„¶åå®ƒä¼šè°ƒç”¨shm_file_operationsçš„mmapå‡½æ•°ï¼Œä¹Ÿå³shm_mmapè¿›è¡Œæ˜ å°„ã€‚</p><pre><code>static int shm_mmap(struct file *file, struct vm_area_struct *vma)\n{\n\tstruct shm_file_data *sfd = shm_file_data(file);\n\tint ret;\n\tret = __shm_open(vma);\n\tret = call_mmap(sfd-&gt;file, vma);\n\tsfd-&gt;vm_ops = vma-&gt;vm_ops;\n\tvma-&gt;vm_ops = &amp;shm_vm_ops;\n\treturn 0;\n}\n</code></pre><p>shm_mmapä¸­è°ƒç”¨äº†shm_file_dataä¸­çš„fileçš„mmapå‡½æ•°ï¼Œè¿™æ¬¡è°ƒç”¨çš„æ˜¯shmem_file_operationsçš„mmapï¼Œä¹Ÿå³shmem_mmapã€‚</p><pre><code>static int shmem_mmap(struct file *file, struct vm_area_struct *vma)\n{\n\tfile_accessed(file);\n\tvma-&gt;vm_ops = &amp;shmem_vm_ops;\n\treturn 0;\n}\n</code></pre><p>è¿™é‡Œé¢ï¼Œvm_area_structçš„vm_opsæŒ‡å‘shmem_vm_opsã€‚ç­‰ä»call_mmapä¸­è¿”å›ä¹‹åï¼Œshm_file_dataçš„vm_opsæŒ‡å‘äº†shmem_vm_opsï¼Œè€Œvm_area_structçš„vm_opsæ”¹ä¸ºæŒ‡å‘shm_vm_opsã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œshm_vm_opså’Œshmem_vm_opsçš„å®šä¹‰ã€‚</p><pre><code>static const struct vm_operations_struct shm_vm_ops = {\n\t.open\t= shm_open,\t/* callback for a new vm-area open */\n\t.close\t= shm_close,\t/* callback for when the vm-area is released */\n\t.fault\t= shm_fault,\n};\n\nstatic const struct vm_operations_struct shmem_vm_ops = {\n\t.fault\t\t= shmem_fault,\n\t.map_pages\t= filemap_map_pages,\n};\n</code></pre><p>å®ƒä»¬é‡Œé¢æœ€å…³é”®çš„å°±æ˜¯faultå‡½æ•°ï¼Œä¹Ÿå³è®¿é—®è™šæ‹Ÿå†…å­˜çš„æ—¶å€™ï¼Œè®¿é—®ä¸åˆ°åº”è¯¥æ€ä¹ˆåŠã€‚</p><p>å½“è®¿é—®ä¸åˆ°çš„æ—¶å€™ï¼Œå…ˆè°ƒç”¨vm_area_structçš„vm_opsï¼Œä¹Ÿå³shm_vm_opsçš„faultå‡½æ•°shm_faultã€‚ç„¶åå®ƒä¼šè½¬è€Œè°ƒç”¨shm_file_dataçš„vm_opsï¼Œä¹Ÿå³shmem_vm_opsçš„faultå‡½æ•°shmem_faultã€‚</p><pre><code>static int shm_fault(struct vm_fault *vmf)\n{\n\tstruct file *file = vmf-&gt;vma-&gt;vm_file;\n\tstruct shm_file_data *sfd = shm_file_data(file);\n\treturn sfd-&gt;vm_ops-&gt;fault(vmf);\n}\n</code></pre><p>è™½ç„¶åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå·²ç»ä¸ºè¿™ä¸ªå†…å­˜æ–‡ä»¶åˆ†é…äº†inodeï¼Œä½†æ˜¯å†…å­˜ä¹Ÿå´æ˜¯ä¸€ç‚¹å„¿éƒ½æ²¡åˆ†é…ï¼Œåªæœ‰åœ¨å‘ç”Ÿç¼ºé¡µå¼‚å¸¸çš„æ—¶å€™æ‰è¿›è¡Œåˆ†é…ã€‚</p><pre><code>static int shmem_fault(struct vm_fault *vmf)\n{\n\tstruct vm_area_struct *vma = vmf-&gt;vma;\n\tstruct inode *inode = file_inode(vma-&gt;vm_file);\n\tgfp_t gfp = mapping_gfp_mask(inode-&gt;i_mapping);\n......\n\terror = shmem_getpage_gfp(inode, vmf-&gt;pgoff, &amp;vmf-&gt;page, sgp,\n\t\t\t\t  gfp, vma, vmf, &amp;ret);\n......\n}\n\n/*\n * shmem_getpage_gfp - find page in cache, or get from swap, or allocate\n *\n * If we allocate a new one we do not mark it dirty. That's up to the\n * vm. If we swap it in we mark it dirty since we also free the swap\n * entry since a page cannot live in both the swap and page cache.\n *\n * fault_mm and fault_type are only supplied by shmem_fault:\n * otherwise they are NULL.\n */\nstatic int shmem_getpage_gfp(struct inode *inode, pgoff_t index,\n\tstruct page **pagep, enum sgp_type sgp, gfp_t gfp,\n\tstruct vm_area_struct *vma, struct vm_fault *vmf, int *fault_type)\n{\n......\n    page = shmem_alloc_and_acct_page(gfp, info, sbinfo,\n\t\t\t\t\tindex, false);\n......\n}\n</code></pre><p>shmem_faultä¼šè°ƒç”¨shmem_getpage_gfpåœ¨page cacheå’Œswapä¸­æ‰¾ä¸€ä¸ªç©ºé—²é¡µï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±é€šè¿‡shmem_alloc_and_acct_pageåˆ†é…ä¸€ä¸ªæ–°çš„é¡µï¼Œä»–æœ€ç»ˆä¼šè°ƒç”¨å†…å­˜ç®¡ç†ç³»ç»Ÿçš„alloc_page_vmaåœ¨ç‰©ç†å†…å­˜ä¸­åˆ†é…ä¸€ä¸ªé¡µã€‚</p><p>è‡³æ­¤ï¼Œå…±äº«å†…å­˜æ‰çœŸçš„æ˜ å°„åˆ°äº†è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œè¿›ç¨‹å¯ä»¥åƒè®¿é—®æœ¬åœ°å†…å­˜ä¸€æ ·è®¿é—®å…±äº«å†…å­˜ã€‚</p><h2>æ€»ç»“æ—¶åˆ»</h2><p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹å…±äº«å†…å­˜çš„åˆ›å»ºå’Œæ˜ å°„è¿‡ç¨‹ã€‚</p><ol>\n<li>è°ƒç”¨shmgetåˆ›å»ºå…±äº«å†…å­˜ã€‚</li>\n<li>å…ˆé€šè¿‡ipc_findkeyåœ¨åŸºæ•°æ ‘ä¸­æŸ¥æ‰¾keyå¯¹åº”çš„å…±äº«å†…å­˜å¯¹è±¡shmid_kernelæ˜¯å¦å·²ç»è¢«åˆ›å»ºè¿‡ï¼Œå¦‚æœå·²ç»è¢«åˆ›å»ºï¼Œå°±ä¼šè¢«æŸ¥è¯¢å‡ºæ¥ï¼Œä¾‹å¦‚produceråˆ›å»ºè¿‡ï¼Œåœ¨consumerä¸­å°±ä¼šæŸ¥è¯¢å‡ºæ¥ã€‚</li>\n<li>å¦‚æœå…±äº«å†…å­˜æ²¡æœ‰è¢«åˆ›å»ºè¿‡ï¼Œåˆ™è°ƒç”¨shm_opsçš„newsegæ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡shmid_kernelã€‚ä¾‹å¦‚ï¼Œåœ¨producerä¸­å°±ä¼šæ–°å»ºã€‚</li>\n<li>åœ¨shmemæ–‡ä»¶ç³»ç»Ÿé‡Œé¢åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå…±äº«å†…å­˜å¯¹è±¡shmid_kernelæŒ‡å‘è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ç”¨struct fileè¡¨ç¤ºï¼Œæˆ‘ä»¬å§‘ä¸”ç§°å®ƒä¸ºfile1ã€‚</li>\n<li>è°ƒç”¨shmatï¼Œå°†å…±äº«å†…å­˜æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</li>\n<li>shm_obtain_object_checkå…ˆä»åŸºæ•°æ ‘é‡Œé¢æ‰¾åˆ°shmid_kernelå¯¹è±¡ã€‚</li>\n<li>åˆ›å»ºç”¨äºå†…å­˜æ˜ å°„åˆ°æ–‡ä»¶çš„fileå’Œshm_file_dataï¼Œè¿™é‡Œçš„struct fileæˆ‘ä»¬å§‘ä¸”ç§°ä¸ºfile2ã€‚</li>\n<li>å…³è”å†…å­˜åŒºåŸŸvm_area_structå’Œç”¨äºå†…å­˜æ˜ å°„åˆ°æ–‡ä»¶çš„fileï¼Œä¹Ÿå³file2ï¼Œè°ƒç”¨file2çš„mmapå‡½æ•°ã€‚</li>\n<li>file2çš„mmapå‡½æ•°shm_mmapï¼Œä¼šè°ƒç”¨file1çš„mmapå‡½æ•°shmem_mmapï¼Œè®¾ç½®shm_file_dataå’Œvm_area_structçš„vm_opsã€‚</li>\n<li>å†…å­˜æ˜ å°„å®Œæ¯•ä¹‹åï¼Œå…¶å®å¹¶æ²¡æœ‰çœŸçš„åˆ†é…ç‰©ç†å†…å­˜ï¼Œå½“è®¿é—®å†…å­˜çš„æ—¶å€™ï¼Œä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸do_page_faultã€‚</li>\n<li>vm_area_structçš„vm_opsçš„shm_faultä¼šè°ƒç”¨shm_file_dataçš„vm_opsçš„shmem_faultã€‚</li>\n<li>åœ¨page cacheä¸­æ‰¾ä¸€ä¸ªç©ºé—²é¡µï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªç©ºé—²é¡µã€‚</li>\n</ol><p><img src=\"https://static001.geekbang.org/resource/image/20/51/20e8f4e69d47b7469f374bc9fbcf7251.png?wh=4903*3352\" alt=\"\"></p><h2>è¯¾å ‚ç»ƒä¹ </h2><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªåˆ†æäº†shm_idsçš„ç»“æ„ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„ç¨‹åºæˆ‘ä»¬å†™è¿‡äº†ï¼Œä½†æ˜¯msg_idsçš„ç»“æ„æ²¡æœ‰è§£æï¼Œä½ å¯ä»¥è¯•ç€è§£æä¸€ä¸‹ã€‚</p><p>æ¬¢è¿ç•™è¨€å’Œæˆ‘åˆ†äº«ä½ çš„ç–‘æƒ‘å’Œè§è§£ ï¼Œä¹Ÿæ¬¢è¿å¯ä»¥æ”¶è—æœ¬èŠ‚å†…å®¹ï¼Œåå¤ç ”è¯»ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼Œå’Œä»–ä¸€èµ·å­¦ä¹ å’Œè¿›æ­¥ã€‚</p><p></p>","comments":[{"had_liked":false,"id":137097,"user_name":"Spring","can_delete":false,"product_type":"c1","uid":1222211,"ip_address":"","ucode":"8175463FB4705B","user_header":"https://static001.geekbang.org/account/avatar/00/12/a6/43/cb6ab349.jpg","comment_is_top":false,"comment_ctime":1569595903,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"70289072639","product_id":100024701,"comment_content":"æ–‡ç« ä¸€éçœ‹ä¸æ‡‚ä½†åº•ä¸‹æ€»ç»“çš„å›¾å¾ˆå¥½ï¼Œç»ˆäºæ˜ç™½äº†ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªfileã€‚file1æ˜¯shmemå†…å­˜æ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ–‡ä»¶ï¼Œfile2æ˜¯è¿›ç¨‹è™šæ‹Ÿå†…å­˜é‡Œæ˜ å°„çš„æ–‡ä»¶ï¼Œæ‰€ä»¥file1æ˜¯å±äºå…±äº«å†…å­˜çš„ï¼Œfile2æ˜¯å±äºæŸä¸ªè¿›ç¨‹çš„ã€‚","like_count":16,"discussions":[{"author":{"id":1576512,"avatar":"https://static001.geekbang.org/account/avatar/00/18/0e/40/49a71ed8.jpg","nickname":"å…«æˆ’","note":"","ucode":"3F262A99492A65","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367836,"discussion_content":"é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥æ˜ å°„åˆ°file1ï¼Ÿ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618479724,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":148439,"user_name":"å°æ©™å­","can_delete":false,"product_type":"c1","uid":1244724,"ip_address":"","ucode":"7E3DD87C3DE6F9","user_header":"https://static001.geekbang.org/account/avatar/00/12/fe/34/67c1ed1e.jpg","comment_is_top":false,"comment_ctime":1573007468,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"48817647724","product_id":100024701,"comment_content":"å·¥ä½œäº†å‡ å¹´ ï¼Œä¸šåŠ¡ä»£ç å†™å¤šäº†ï¼Œæ¡†æ¶ä¸APIè°ƒæ¥è°ƒå»çš„ï¼Œé‡åˆ°å¾ˆå¤šç–‘éš¾æ‚ç—‡ï¼Œè¿˜æ˜¯ä¸æ˜æ‰€ä»¥ã€‚<br>å›è¿‡å¤´å†çœ‹ä¸‹ æ“ä½œç³»ç»ŸçœŸæ˜¯æ ¸å¿ƒï¼Œå¾ˆå¤šäººè¯´æ“ä½œç³»ç»Ÿå°±æ˜¯åŠŸå¤«é‡Œé¢çš„æ˜“ç­‹ç»ï¼Œå†…åŠŸç« æ³•ã€‚å­¦ä¹ äº†æ“ä½œç³»ç»Ÿï¼Œå†çœ‹å¾ˆå¤šå…¶ä»–çš„æŠ€æœ¯ï¼Œæ„Ÿè§‰æ›´è‡ªç„¶ï¼Œç†è§£çš„æ›´æ·±åˆ»äº†ã€‚ä¸€ç›´æƒ³è¯»å†…æ ¸ä»£ç ï¼Œä½†æ˜¯å•ƒèµ·æ¥å¾ˆè´¹åŠ²ï¼Œè¿™ä¸ªä¸“æ ä¸€ç›´å†çœ‹ï¼Œè¶Šçœ‹è¶Šå–œæ¬¢ï¼Œå¾ˆå¤šç¯‡ç« éƒ½ä¼šåå¤çš„çœ‹ã€‚ç›¸ä¿¡çœ‹å®Œä¸“æ åï¼Œå†å»çœ‹ä¸€äº›æ·±å…¥ç†è§£linuxå†…æ ¸ï¼Œä¼šæ¸…æ™°å¾ˆå¤šã€‚","like_count":11,"discussions":[{"author":{"id":1731543,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/6b/d7/8872624a.jpg","nickname":"xmeng","note":"","ucode":"C0CA2182BA3B4B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":396544,"discussion_content":"ä¸€æ ·çš„æ„Ÿå—ï¼Œä¸€æ ·çš„å–œæ¬¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1632449566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211771,"user_name":"bookå°¾æ±","can_delete":false,"product_type":"c1","uid":1446375,"ip_address":"","ucode":"AE2B8DFC643ACC","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","comment_is_top":false,"comment_ctime":1588002692,"is_pvip":true,"replies":[{"id":"83783","content":"èµ","user_name":"ä½œè€…å›å¤","comment_id":211771,"uid":"1001590","ip_address":"","utype":1,"ctime":1592359483,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":3,"race_medal":0,"score":"23062839172","product_id":100024701,"comment_content":"å…±äº«å†…å­˜:<br>åˆ›å»ºå…±äº«å†…å­˜,é€šè¿‡shmgetç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜,ä¸»è¦æ˜¯é€šè¿‡keyæ¥åˆ›å»ºä¸€ä¸ªstruct kern_ipc_perm,ä¿¡å·é‡ é˜Ÿåˆ—å’Œå…±äº«å†…å­˜çš„ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„,å¯ä»¥é€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢æ¥è½¬åŒ–æˆä»»æ„ä¸€ä¸ªç±»å‹.ç„¶åæ¥ä¸‹æ¥å»å¡«å……è¿™ä¸ªç»“æ„,ç„¶åå°†ä¸€ä¸ªæ–‡ä»¶ä¸å…±äº«å†…å­˜å…³è”,å†…å­˜æ˜ å°„æœ‰ä¸¤ç§æ–¹å¼ä¸€ç§æ˜¯åŒ¿åæ˜ å°„ ä¸€ç§æ˜¯æ˜ å°„åˆ°ä¸€ä¸ªæ–‡ä»¶,ç‰©ç†å†…å­˜æ˜¯ä¸èƒ½å…±äº«çš„,æ–‡ä»¶å¯ä»¥è·¨è¿›ç¨‹å…±äº«,æ‰€ä»¥è¦æ˜ å°„åˆ°æ–‡ä»¶.ä½†è¿™é‡Œçš„æ–‡ä»¶æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶,è¿™ä¸ªå†…å­˜æ–‡ä»¶ç³»ç»Ÿä¹Ÿä¼šåœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œ æŒ‚è½½, è¯¥æ–‡ä»¶ä¹Ÿæœ‰ç›®å½•é¡¹å’Œinodeä»¥åŠå…¶fs_operation,ç„¶åä¼šå°†æ–°åˆ›å»ºçš„å…±äº«å†…å­˜å¯¹è±¡åŠ å…¥åˆ°shm_idsåŸºæ•°ä¸Š,å¹¶å°†å…¶åŠ åˆ°å½“å‰è¿›ç¨‹çš„sysvshmé˜Ÿåˆ—ä¸­.<br><br>ç°åœ¨å…±äº«å†…å­˜å…¶å®è¿˜åªæ˜¯å†…æ ¸ä¸­çš„ä¸€ä¸ªç»“æ„ä½“,æˆ‘ä»¬åªæœ‰å…±äº«å†…å­˜çš„id,è¦æƒ³ä½¿ç”¨å…±äº«å†…å­˜è¿˜è¦é€šè¿‡idæ¥å°†å…¶æ˜ å°„åˆ°ä½¿ç”¨è€…çš„ç”¨æˆ·æ€çš„è¿›ç¨‹ç©ºé—´ä¸­,é€šè¿‡shmatç³»ç»Ÿè°ƒç”¨å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹,è¯¥ç³»ç»Ÿè°ƒç”¨çš„ä¸»è¦å·¥ä½œå¦‚ä¸‹:<br>1 é€šè¿‡å…±äº«å†…å­˜çš„ipåœ¨ shm_idsåŸºæ•°æ ‘ä¸Šæ‰¾åˆ°è¯¥å…±äº«å†…å­˜çš„ç»“æ„ä½“,ç„¶åå–å‡ºå†…å­˜æ–‡ä»¶ç³»ç»Ÿé‡Œfileå¹¶å°†å…¶èµ‹å€¼ç»™æ–°åˆ›å»ºçš„struct shm_file_data-&gt;file,è¿™é‡Œæˆ‘ä»¬å·²ç»æœ‰äº†å¯ä»¥å…±äº«çš„æ–‡ä»¶&quot;file&quot;,ç„¶ååœ¨ç”¨æˆ·è¿›ç¨‹è™šæ‹Ÿç©ºé—´çš„mmapæ˜ å°„åŒºåˆ†é…ä¸€ä¸ªvm_area structæ¥åšæ–‡ä»¶æ˜ å°„å°±å¯ä»¥äº†,å°†vm_area_structé‡Œçš„vm_fileçš„private_dataæŒ‡å‘shm_file_data,ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨fileå‘¢?private_dataè²Œä¼¼åªæœ‰å…±äº«å†…å­˜æ‰æœ‰ç”¨,ä¸å¤ªç†è§£,å¯èƒ½å› ä¸ºvm_fileæœ‰å…¶ç‹¬ç‰¹çš„file_operationçš„é—®é¢˜å§,ä¸¤ä¸ªfile&#39;è™½ç„¶å¯ä»¥æ˜¯åŒä¸€ç±»ç»“æ„ä½“,ä½†å·®å¼‚è¿˜æ˜¯å¾ˆå¤§.åœ¨åˆ›å»ºvm_fileçš„è¿‡ç¨‹ä¸­åº”è¯¥å¯ä»¥æ‰¾åˆ°ç­”æ¡ˆ,ç•¥è¿‡,æ˜ å°„å†…å­˜æ—¶è¿˜ä¼šå°†vm_areaçš„vm_opså…ˆæŒ‡å‘shmem_vm_ops,ç„¶ååœ¨æŒ‡å‘shm_vm_ops, å°†shm_file_dataçš„vm_opsæŒ‡å‘shmem_vm_opså³å†…å­˜æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶çš„vm_ops,åˆ°è¿™é‡Œå°±å®Œæˆäº†.åé¢è¿›ç¨‹è¯»æˆ–å†™æ•°æ®æ—¶,å¦‚æœå¯¹åº”çš„é¡µè¡¨é¡¹æ²¡æœ‰å»ºç«‹ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸,è·Ÿä¹‹å‰çš„ç¼ºé¡µå¼‚å¸¸æµç¨‹å·®ä¸å¤š,æœ€ç»ˆä¼šè°ƒç”¨å†…å­˜æ–‡ä»¶ç³»ç»Ÿçš„ç¼ºé¡µå¼‚å¸¸å‡½æ•°æ¥åˆ†é…å¯¹åº”çš„ç‰©ç†é¡µ,å¹¶å»ºç«‹é¡µè¡¨é¡¹.","like_count":5,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493360,"discussion_content":"èµ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592359483,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1099199,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c5/bf/a2fa5bf2.jpg","nickname":"ä¾¯è¶…","note":"","ucode":"56D6A5471392D1","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":381209,"discussion_content":"ä¸¤ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åœ°å€ä¸åŒï¼Œå…±äº«å†…å­˜æ€ä¹ˆå®ç°çš„ï¼Œæ€ä¹ˆæ˜ å°„åˆ°ç›¸åŒçš„ç‰©ç†å†…å­˜çš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624954252,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1446375,"avatar":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","nickname":"bookå°¾æ±","note":"","ucode":"AE2B8DFC643ACC","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":1099199,"avatar":"https://static001.geekbang.org/account/avatar/00/10/c5/bf/a2fa5bf2.jpg","nickname":"ä¾¯è¶…","note":"","ucode":"56D6A5471392D1","race_medal":0,"user_type":1,"is_pvip":true},"discussion":{"id":381440,"discussion_content":"è¿™ä¸ªå¥½ä¹…æ²¡å¤ä¹ äº†ï¼Œå¿˜è®°äº†ï¼Œæ–‡ä»¶å¯ä»¥å…±äº«ï¼Œå…±äº«å†…å­˜ä¹Ÿæ˜¯ç‰¹æ®Šçš„æ–‡ä»¶","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1625053982,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":381209,"ip_address":""},"score":381440,"extra":""}]}]},{"had_liked":false,"id":185574,"user_name":"ç é—ªé—ª","can_delete":false,"product_type":"c1","uid":1300447,"ip_address":"","ucode":"45BE0D586A3839","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eov38ZkwCyNoBdr5drgX0cp2eOGCv7ibkhUIqCvcnFk8FyUIS6K4gHXIXh0fu7TB67jaictdDlic4OwQ/132","comment_is_top":false,"comment_ctime":1583636894,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"23058473374","product_id":100024701,"comment_content":"æ–‡ç« ä¸¤éè¯»ä¸‹æ¥è’™è’™çš„ï¼Œæœ€åå¯¹ç€æ€»ç»“å›¾æŠŠå…±äº«å†…å­˜çš„åˆ›å»ºå’Œåœ¨ç”¨æˆ·æ€æ˜ å°„çš„æµç¨‹ç†é¡ºäº†ã€‚å…³é”®å°±æ˜¯å› ä¸ºå…±äº«å†…å­˜åˆšå¼€å§‹ç”³è¯·çš„ç‰©ç†å†…å­˜æ— æ³•åœ¨è¿›ç¨‹ä¸­å…±äº«ï¼Œæ‰€ä»¥å…ˆè¦æŠŠç‰©ç†å†…å­˜çš„shmid_kernelå¯¹åº”åˆ°shmemæ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·shmemä¸­çš„æ–‡ä»¶å¯ä»¥å†è¿›ç¨‹ä¸­å…±äº«ï¼›ç„¶ååœ¨shmatå‡½æ•°æ—¶ï¼Œç›¸å½“äºå°†shmæ˜ å°„åˆ°shmemçš„file2ï¼Œå…ˆæ˜ å°„åˆ°shmemæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶file1ï¼Œç„¶åå†é€šè¿‡file1çš„mmapå‡½æ•°å®Œæˆshm_file_dataå’Œvm_area_structçš„opsè®¾ç½®ã€‚è¿™æ ·å†…å­˜æ˜ å°„å®Œæ¯•åï¼Œå¹¶æ²¡æœ‰çœŸçš„åˆ†é…ç‰©ç†å†…å­˜ï¼Œå½“è®¿é—®å†…å­˜ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ã€‚ç„¶åvm_area_structçš„vm_opsçš„shm_faultä¼šè°ƒç”¨shm_file_dataçš„vm_opsçš„shmem_faultã€‚æœ€ååœ¨page cacheä¸­æ‰¾ä¸€ä¸ªç©ºé—²é¡µï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªç©ºé—²é¡µã€‚","like_count":5,"discussions":[{"author":{"id":2365071,"avatar":"https://static001.geekbang.org/account/avatar/00/24/16/8f/c1baee96.jpg","nickname":"muse","note":"","ucode":"43B0C82639E39F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":373621,"discussion_content":"æ‚¨å¥½ï¼Œè¯·é—®ä¸ºä»€ä¹ˆåˆšå¼€å§‹ç”³è¯·çš„ç‰©ç†å†…å­˜æ— æ³•åœ¨è¿›ç¨‹ä¸­å…±äº«å‘¢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620801015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":211781,"user_name":"bookå°¾æ±","can_delete":false,"product_type":"c1","uid":1446375,"ip_address":"","ucode":"AE2B8DFC643ACC","user_header":"https://static001.geekbang.org/account/avatar/00/16/11/e7/044a9a6c.jpg","comment_is_top":false,"comment_ctime":1588003863,"is_pvip":true,"replies":[{"id":"83782","content":"å¯¹çš„ï¼Œ","user_name":"ä½œè€…å›å¤","comment_id":211781,"uid":"1001590","ip_address":"","utype":1,"ctime":1592359459,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"14472905751","product_id":100024701,"comment_content":"è¡¥å……ä¸‹è¯¥æŸ¥äº†ä¸‹fileæ˜¯VFSæ¡†æ¶çš„ä¸€ä¸ªåŸºæœ¬æ¦‚å¿µï¼Œä¸€åˆ‡çš†æ–‡ä»¶æŒ‡çš„å°±æ˜¯è¿™ä¸ª,f,ç„¶ååœ¨è¿™ä¸ªfileä¸‹é¢ä¼šæœ‰å„ç§å„æ ·çš„å®ç°,æ¯”å¦‚è®¾å¤‡æ˜¯æ–‡ä»¶ sockæ˜¯æ–‡ä»¶ pipeæ˜¯æ–‡ä»¶ å…±äº«å†…å­˜ä¹Ÿæ˜¯æ–‡ä»¶,fileç»“æ„ä½“é‡Œé¢éƒ½æ˜¯ä¸€äº›é€šç”¨çš„å±æ€§,è€Œprivate_dataé‡Œé¢æ˜¯ä¸€äº›å„ä¸ªæŠ«ç€æ–‡ä»¶å¤–è¡£çš„å„ç§ç»“æ„ä½“çš„ä¸€ä¸ªç‹¬ç‰¹çš„ä¸œè¥¿,å› æ­¤è¿™é‡Œä¼šæœ‰ä¸¤ä¸ªfile,vm_fileå°±æ˜¯è¿™ä¸ªå¤–å£³,å…¶private_dataé‡Œå°±æ˜¯å…±äº«å†…å­˜çš„ç›¸å…³æ•°æ®","like_count":3,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493364,"discussion_content":"å¯¹çš„ï¼Œ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1592359459,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":109530,"user_name":"Amark","can_delete":false,"product_type":"c1","uid":1121326,"ip_address":"","ucode":"E5F48633654002","user_header":"https://static001.geekbang.org/account/avatar/00/11/1c/2e/93812642.jpg","comment_is_top":false,"comment_ctime":1562051640,"is_pvip":false,"replies":[{"id":"48811","content":"çš„ç¡®æ¯”è¾ƒç¡¬æ ¸ï¼Œæˆ‘å®åœ¨æ˜¯æ²¡åŠæ³•å†æ¯”å–»äº†","user_name":"ä½œè€…å›å¤","comment_id":109530,"uid":"1001590","ip_address":"","utype":1,"ctime":1567498219,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"10151986232","product_id":100024701,"comment_content":"è€å¸ˆæœ‰æ²¡æœ‰ä»€ä¹ˆé€šä¿—æ˜“æ‡‚çš„èµ„æ–™ï¼Œæ‚¨å°†çš„å¤ªä¸“ä¸šäº†","like_count":2,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456453,"discussion_content":"çš„ç¡®æ¯”è¾ƒç¡¬æ ¸ï¼Œæˆ‘å®åœ¨æ˜¯æ²¡åŠæ³•å†æ¯”å–»äº†","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567498219,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":348380,"user_name":"NeverSeeYouAgainBUG","can_delete":false,"product_type":"c1","uid":2930836,"ip_address":"","ucode":"1B0E8CA284C181","user_header":"https://static001.geekbang.org/account/avatar/00/2c/b8/94/d20583ef.jpg","comment_is_top":false,"comment_ctime":1655035258,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1655035258","product_id":100024701,"comment_content":"å“å‘€è¶…å“¥ï¼Œæ·±å…¥æµ…å‡ºå•Šæ·±å…¥æµ…å‡ºå•Šã€‚å…³é”®åœ¨ æµ…å‡ºï¼Œè¦å¥½å¥½æ€»ç»“ï¼Œ","like_count":0},{"had_liked":false,"id":347528,"user_name":"å°é³„é±¼","can_delete":false,"product_type":"c1","uid":1178888,"ip_address":"","ucode":"9C30CAFB41A263","user_header":"https://static001.geekbang.org/account/avatar/00/11/fd/08/c039f840.jpg","comment_is_top":false,"comment_ctime":1654130649,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654130649","product_id":100024701,"comment_content":"ä¸ºäº†ç»Ÿä¸€æ“ä½œå…¥å£ï¼šä¸€åˆ‡çš†æ–‡ä»¶ã€‚æ„å»ºäº†å„ç§å„æ ·çš„â€œæ–‡ä»¶ç³»ç»Ÿâ€ã€‚å…±äº«å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œç¡¬ç›˜æ–‡ä»¶ç³»ç»Ÿï¼ˆext4ç­‰ï¼‰ï¼Œè®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼Œç›¸ä¿¡è¿˜æœ‰å„ç§å„æ ·çš„æ–‡ä»¶ç³»ç»Ÿï¼è™½ç„¶æ„Ÿè§‰å¤æ‚äº†ï¼Œä½†æ˜¯å®é™…çš„åœºæ™¯æœ¬æ¥å°±ä¸ç®€å•ã€‚åè€Œç»Ÿä¸€å…¥å£ä¹‹åï¼Œâ€œä¸Šå±‚å»ºç­‘â€çš„å¼€å‘äººå‘˜ä¸å†éœ€è¦å…³ç³»åº•å±‚çš„å…·ä½“å®ç°ï¼Œä»è€Œå®ç°å¹¶è¡Œå¼€å‘ï¼Œç‹¬ç«‹ç»´æŠ¤ã€‚","like_count":0},{"had_liked":false,"id":345112,"user_name":"Geek_2b44d4","can_delete":false,"product_type":"c1","uid":2925499,"ip_address":"","ucode":"8283C03D322999","user_header":"","comment_is_top":false,"comment_ctime":1652057126,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1652057126","product_id":100024701,"comment_content":"è¿™ä¸ªpage cache è·Ÿswapçš„é€‰æ‹©æ—¶æœºæ˜¯æ€æ ·çš„ï¼Ÿ","like_count":0},{"had_liked":false,"id":159511,"user_name":"è‰¾ç‘å…‹å°éœ¸ç‹","can_delete":false,"product_type":"c1","uid":1674555,"ip_address":"","ucode":"58FCCAC0F675E1","user_header":"https://static001.geekbang.org/account/avatar/00/19/8d/3b/42d9c669.jpg","comment_is_top":false,"comment_ctime":1575642762,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1575642762","product_id":100024701,"comment_content":"å¯¹äº sem_idsã€msg_idsã€shm_ids å„æœ‰ä¸€æ£µåŸºæ•°æ ‘<br>---------------------------------------------------<br>åº”è¯¥æ˜¯å…±äº«ä¸€ä¸ªæ ‘å§ï¼Ÿ","like_count":0},{"had_liked":false,"id":151352,"user_name":"Leosocy","can_delete":false,"product_type":"c1","uid":1132542,"ip_address":"","ucode":"5E076D6B981F84","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/fe/f2ce12cd.jpg","comment_is_top":false,"comment_ctime":1573704387,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1573704387","product_id":100024701,"comment_content":"seq å’Œ next_id ç”¨äºä¸€èµ·ç”Ÿæˆ ipc å”¯ä¸€çš„ idï¼Œå› ä¸ºä¿¡å·é‡ï¼Œå…±äº«å†…å­˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒä»¬ä¸‰ä¸ªçš„ id ä¹Ÿä¸èƒ½é‡å¤<br><br>è¿™å¥è¯ä¸å¤ªæ˜ç™½ï¼Œä¸åŒçš„ipc_idsä¸æ˜¯æœ‰ä¸åŒçš„idrå—ï¼Ÿä¸ºä»€ä¹ˆè¦ä¿è¯ä»–ä»¬ä¸‰ä¸ªidä¸é‡å¤ï¼Ÿ","like_count":0},{"had_liked":false,"id":137636,"user_name":"å¥”è·‘çš„ç ä»”","can_delete":false,"product_type":"c1","uid":1609871,"ip_address":"","ucode":"AB3B02B07B8B8C","user_header":"https://static001.geekbang.org/account/avatar/00/18/90/8f/9c691a5f.jpg","comment_is_top":false,"comment_ctime":1569810480,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1569810480","product_id":100024701,"comment_content":"å°†æœ¬èŠ‚æ‰€è®²çš„å…±äº«å†…å­˜å®ç°æµç¨‹ä¸æ–‡ä»¶å†…å­˜æ˜ é‚£èŠ‚æ‰€è®²çš„æµç¨‹å¯¹æ¯”ç€æ¢³ç†ä¸€ä¸‹ï¼Œæ„Ÿè§‰æ˜æœ—äº†å¥½å¤š","like_count":0},{"had_liked":false,"id":123361,"user_name":"å˜‰æœ¨","can_delete":false,"product_type":"c1","uid":1317999,"ip_address":"","ucode":"AF4877693782C0","user_header":"https://static001.geekbang.org/account/avatar/00/14/1c/6f/3ea2a599.jpg","comment_is_top":false,"comment_ctime":1565661505,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1565661505","product_id":100024701,"comment_content":"Cçš„é¢å‘å¯¹è±¡å±…ç„¶è¿™ä¹ˆå·§å¦™","like_count":0},{"had_liked":false,"id":109066,"user_name":"ä¸ä¸€æ ·çš„çƒŸç«","can_delete":false,"product_type":"c1","uid":1473251,"ip_address":"","ucode":"6E305F0EE90E8B","user_header":"https://static001.geekbang.org/account/avatar/00/16/7a/e3/145adba9.jpg","comment_is_top":false,"comment_ctime":1561954739,"is_pvip":false,"replies":[{"id":"39605","content":"ç‰›","user_name":"ä½œè€…å›å¤","comment_id":109066,"uid":"1001590","ip_address":"","utype":1,"ctime":1562031295,"user_name_real":"åˆ˜è¶…@ç½‘æ˜“äº‘"}],"discussion_count":1,"race_medal":0,"score":"1561954739","product_id":100024701,"comment_content":"å¬å®Œäº† å¿«ç‚¹æ›´æ–°ğŸ˜","like_count":0,"discussions":[{"author":{"id":1001590,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/48/76/0c7d4d23.jpg","nickname":"åˆ˜è¶…","note":"","ucode":"196BF3F499E8FE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":456232,"discussion_content":"ç‰›","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1562031295,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]}]}