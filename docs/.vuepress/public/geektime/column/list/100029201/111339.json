{"id":111339,"title":"26 | 你一定不能错过的Kafka控制器","content":"<p>你好，我是胡夕。今天我要和你分享的主题是：Kafka中的控制器组件。</p><p><strong>控制器组件（Controller），是Apache Kafka的核心组件。它的主要作用是在Apache ZooKeeper的帮助下管理和协调整个Kafka集群</strong>。集群中任意一台Broker都能充当控制器的角色，但是，在运行过程中，只能有一个Broker成为控制器，行使其管理和协调的职责。换句话说，每个正常运转的Kafka集群，在任意时刻都有且只有一个控制器。官网上有个名为activeController的JMX指标，可以帮助我们实时监控控制器的存活状态。这个JMX指标非常关键，你在实际运维操作过程中，一定要实时查看这个指标的值。下面，我们就来详细说说控制器的原理和内部运行机制。</p><p>在开始之前，我先简单介绍一下Apache ZooKeeper框架。要知道，<strong>控制器是重度依赖ZooKeeper的</strong>，因此，我们有必要花一些时间学习下ZooKeeper是做什么的。</p><p><strong>Apache ZooKeeper是一个提供高可靠性的分布式协调服务框架</strong>。它使用的数据模型类似于文件系统的树形结构，根目录也是以“/”开始。该结构上的每个节点被称为znode，用来保存一些元数据协调信息。</p><!-- [[[read_end]]] --><p>如果以znode持久性来划分，<strong>znode可分为持久性znode和临时znode</strong>。持久性znode不会因为ZooKeeper集群重启而消失，而临时znode则与创建该znode的ZooKeeper会话绑定，一旦会话结束，该节点会被自动删除。</p><p>ZooKeeper赋予客户端监控znode变更的能力，即所谓的Watch通知功能。一旦znode节点被创建、删除，子节点数量发生变化，抑或是znode所存的数据本身变更，ZooKeeper会通过节点变更监听器(ChangeHandler)的方式显式通知客户端。</p><p>依托于这些功能，ZooKeeper常被用来实现<strong>集群成员管理、分布式锁、领导者选举</strong>等功能。Kafka控制器大量使用Watch功能实现对集群的协调管理。我们一起来看一张图片，它展示的是Kafka在ZooKeeper中创建的znode分布。你不用了解每个znode的作用，但你可以大致体会下Kafka对ZooKeeper的依赖。</p><p><img src=\"https://static001.geekbang.org/resource/image/4a/fb/4a2ec3372ff5e4639e5e9c780ec7fcfb.jpg?wh=2250*2896\" alt=\"\"></p><p>掌握了ZooKeeper的这些基本知识，现在我们就可以开启对Kafka控制器的讨论了。</p><h2>控制器是如何被选出来的？</h2><p>你一定很想知道，控制器是如何被选出来的呢？我们刚刚在前面说过，每台Broker都能充当控制器，那么，当集群启动后，Kafka怎么确认控制器位于哪台Broker呢？</p><p>实际上，Broker在启动时，会尝试去ZooKeeper中创建/controller节点。Kafka当前选举控制器的规则是：<strong>第一个成功创建/controller节点的Broker会被指定为控制器</strong>。</p><h2>控制器是做什么的？</h2><p>我们经常说，控制器是起协调作用的组件，那么，这里的协调作用到底是指什么呢？我想了一下，控制器的职责大致可以分为5种，我们一起来看看。</p><p>1.<strong>主题管理（创建、删除、增加分区）</strong></p><p>这里的主题管理，就是指控制器帮助我们完成对Kafka主题的创建、删除以及分区增加的操作。换句话说，当我们执行<strong>kafka-topics脚本</strong>时，大部分的后台工作都是控制器来完成的。关于kafka-topics脚本，我会在专栏后面的内容中，详细介绍它的使用方法。</p><p>2.<strong>分区重分配</strong></p><p>分区重分配主要是指，<strong>kafka-reassign-partitions脚本</strong>（关于这个脚本，后面我也会介绍）提供的对已有主题分区进行细粒度的分配功能。这部分功能也是控制器实现的。</p><p>3.<strong>Preferred领导者选举</strong></p><p>Preferred领导者选举主要是Kafka为了避免部分Broker负载过重而提供的一种换Leader的方案。在专栏后面说到工具的时候，我们再详谈Preferred领导者选举，这里你只需要了解这也是控制器的职责范围就可以了。</p><p>4.<strong>集群成员管理（新增Broker、Broker主动关闭、Broker宕机）</strong></p><p>这是控制器提供的第4类功能，包括自动检测新增Broker、Broker主动关闭及被动宕机。这种自动检测是依赖于前面提到的Watch功能和ZooKeeper临时节点组合实现的。</p><p>比如，控制器组件会利用<strong>Watch机制</strong>检查ZooKeeper的/brokers/ids节点下的子节点数量变更。目前，当有新Broker启动后，它会在/brokers下创建专属的znode节点。一旦创建完毕，ZooKeeper会通过Watch机制将消息通知推送给控制器，这样，控制器就能自动地感知到这个变化，进而开启后续的新增Broker作业。</p><p>侦测Broker存活性则是依赖于刚刚提到的另一个机制：<strong>临时节点</strong>。每个Broker启动后，会在/brokers/ids下创建一个临时znode。当Broker宕机或主动关闭后，该Broker与ZooKeeper的会话结束，这个znode会被自动删除。同理，ZooKeeper的Watch机制将这一变更推送给控制器，这样控制器就能知道有Broker关闭或宕机了，从而进行“善后”。</p><p>5.<strong>数据服务</strong></p><p>控制器的最后一大类工作，就是向其他Broker提供数据服务。控制器上保存了最全的集群元数据信息，其他所有Broker会定期接收控制器发来的元数据更新请求，从而更新其内存中的缓存数据。</p><h2>控制器保存了什么数据？</h2><p>接下来，我们就详细看看，控制器中到底保存了哪些数据。我用一张图来说明一下。</p><p><img src=\"https://static001.geekbang.org/resource/image/21/d4/2174fb81fa7db42122915fee856790d4.jpg?wh=2250*3303\" alt=\"\"></p><p>怎么样，图中展示的数据量是不是很多？几乎把我们能想到的所有Kafka集群的数据都囊括进来了。这里面比较重要的数据有：</p><ul>\n<li>所有主题信息。包括具体的分区信息，比如领导者副本是谁，ISR集合中有哪些副本等。</li>\n<li>所有Broker信息。包括当前都有哪些运行中的Broker，哪些正在关闭中的Broker等。</li>\n<li>所有涉及运维任务的分区。包括当前正在进行Preferred领导者选举以及分区重分配的分区列表。</li>\n</ul><p>值得注意的是，这些数据其实在ZooKeeper中也保存了一份。每当控制器初始化时，它都会从ZooKeeper上读取对应的元数据并填充到自己的缓存中。有了这些数据，控制器就能对外提供数据服务了。这里的对外主要是指对其他Broker而言，控制器通过向这些Broker发送请求的方式将这些数据同步到其他Broker上。</p><h2>控制器故障转移（Failover）</h2><p>我们在前面强调过，在Kafka集群运行过程中，只能有一台Broker充当控制器的角色，那么这就存在<strong>单点失效</strong>（Single Point of Failure）的风险，Kafka是如何应对单点失效的呢？答案就是，为控制器提供故障转移功能，也就是说所谓的Failover。</p><p><strong>故障转移指的是，当运行中的控制器突然宕机或意外终止时，Kafka能够快速地感知到，并立即启用备用控制器来代替之前失败的控制器</strong>。这个过程就被称为Failover，该过程是自动完成的，无需你手动干预。</p><p>接下来，我们一起来看一张图，它简单地展示了控制器故障转移的过程。</p><p><img src=\"https://static001.geekbang.org/resource/image/fb/7d/fb9c538a27253fe069ff7ea2f02fa17d.jpg?wh=3507*1989\" alt=\"\"></p><p>最开始时，Broker 0是控制器。当Broker 0宕机后，ZooKeeper通过Watch机制感知到并删除了/controller临时节点。之后，所有存活的Broker开始竞选新的控制器身份。Broker 3最终赢得了选举，成功地在ZooKeeper上重建了/controller节点。之后，Broker 3会从ZooKeeper中读取集群元数据信息，并初始化到自己的缓存中。至此，控制器的Failover完成，可以行使正常的工作职责了。</p><h2>控制器内部设计原理</h2><p>在Kafka 0.11版本之前，控制器的设计是相当繁琐的，代码更是有些混乱，这就导致社区中很多控制器方面的Bug都无法修复。控制器是多线程的设计，会在内部创建很多个线程。比如，控制器需要为每个Broker都创建一个对应的Socket连接，然后再创建一个专属的线程，用于向这些Broker发送特定请求。如果集群中的Broker数量很多，那么控制器端需要创建的线程就会很多。另外，控制器连接ZooKeeper的会话，也会创建单独的线程来处理Watch机制的通知回调。除了以上这些线程，控制器还会为主题删除创建额外的I/O线程。</p><p>比起多线程的设计，更糟糕的是，这些线程还会访问共享的控制器缓存数据。我们都知道，多线程访问共享可变数据是维持线程安全最大的难题。为了保护数据安全性，控制器不得不在代码中大量使用<strong>ReentrantLock同步机制</strong>，这就进一步拖慢了整个控制器的处理速度。</p><p>鉴于这些原因，社区于0.11版本重构了控制器的底层设计，最大的改进就是，<strong>把多线程的方案改成了单线程加事件队列的方案</strong>。我直接使用社区的一张图来说明。</p><p><img src=\"https://static001.geekbang.org/resource/image/90/a3/90be543d426a6a450f360ab40e2734a3.jpg?wh=4160*2155\" alt=\"\"></p><p>从这张图中，我们可以看到，社区引入了一个<strong>事件处理线程</strong>，统一处理各种控制器事件，然后控制器将原来执行的操作全部建模成一个个独立的事件，发送到专属的事件队列中，供此线程消费。这就是所谓的单线程+队列的实现方式。</p><p>值得注意的是，这里的单线程不代表之前提到的所有线程都被“干掉”了，控制器只是把缓存状态变更方面的工作委托给了这个线程而已。</p><p>这个方案的最大好处在于，控制器缓存中保存的状态只被一个线程处理，因此不再需要重量级的线程同步机制来维护线程安全，Kafka不用再担心多线程并发访问的问题，非常利于社区定位和诊断控制器的各种问题。事实上，自0.11版本重构控制器代码后，社区关于控制器方面的Bug明显少多了，这也说明了这种方案是有效的。</p><p>针对控制器的第二个改进就是，<strong>将之前同步操作ZooKeeper全部改为异步操作</strong>。ZooKeeper本身的API提供了同步写和异步写两种方式。之前控制器操作ZooKeeper使用的是同步的API，性能很差，集中表现为，<strong>当有大量主题分区发生变更时，ZooKeeper容易成为系统的瓶颈</strong>。新版本Kafka修改了这部分设计，完全摒弃了之前的同步API调用，转而采用异步API写入ZooKeeper，性能有了很大的提升。根据社区的测试，改成异步之后，ZooKeeper写入提升了10倍！</p><p>除了以上这些，社区最近又发布了一个重大的改进！之前Broker对接收的所有请求都是一视同仁的，不会区别对待。这种设计对于控制器发送的请求非常不公平，因为这类请求应该有更高的优先级。</p><p>举个简单的例子，假设我们删除了某个主题，那么控制器就会给该主题所有副本所在的Broker发送一个名为<strong>StopReplica</strong>的请求。如果此时Broker上存有大量积压的Produce请求，那么这个StopReplica请求只能排队等。如果这些Produce请求就是要向该主题发送消息的话，这就显得很讽刺了：主题都要被删除了，处理这些Produce请求还有意义吗？此时最合理的处理顺序应该是，<strong>赋予StopReplica请求更高的优先级，使它能够得到抢占式的处理。</strong></p><p>这在2.2版本之前是做不到的。不过自2.2开始，Kafka正式支持这种不同优先级请求的处理。简单来说，Kafka将控制器发送的请求与普通数据类请求分开，实现了控制器请求单独处理的逻辑。鉴于这个改进还是很新的功能，具体的效果我们就拭目以待吧。</p><h2>小结</h2><p>好了，有关Kafka控制器的内容，我已经讲完了。最后，我再跟你分享一个小窍门。当你觉得控制器组件出现问题时，比如主题无法删除了，或者重分区hang住了，你不用重启Kafka Broker或控制器。有一个简单快速的方式是，去ZooKeeper中手动删除/controller节点。<strong>具体命令是rmr /controller</strong>。这样做的好处是，既可以引发控制器的重选举，又可以避免重启Broker导致的消息处理中断。</p><p><img src=\"https://static001.geekbang.org/resource/image/a7/07/a77479402c0fddbf7541d26d72a97707.jpg?wh=2069*2580\" alt=\"\"></p><h2>开放讨论</h2><p>目前，控制器依然是重度依赖于ZooKeeper的。未来如果要减少对ZooKeeper的依赖，你觉得可能的方向是什么？</p><p>欢迎写下你的思考和答案，我们一起讨论。如果你觉得有所收获，也欢迎把文章分享给你的朋友。</p>","neighbors":{"left":{"article_title":"25 | 消费者组重平衡全流程解析","id":111226},"right":{"article_title":"27 | 关于高水位和Leader Epoch的讨论","id":112118}},"comments":[{"had_liked":false,"id":121045,"user_name":"曾轼麟","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1565052725,"is_pvip":false,"replies":[{"id":"44530","content":"嗯嗯，是的。fencing机制很重要的，应该要提一下的<br>","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1565071196,"ip_address":"","comment_id":121045,"utype":1}],"discussion_count":7,"race_medal":0,"score":"263558057781","product_id":100029201,"comment_content":"老师控制器选举是不是漏了一个环节，重新选出的controller会增加epoch的值，避免旧的controller复活导致出现两个控制器","like_count":62,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461590,"discussion_content":"嗯嗯，是的。fencing机制很重要的，应该要提一下的\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565071196,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1481811,"avatar":"https://static001.geekbang.org/account/avatar/00/16/9c/53/ade0afb0.jpg","nickname":"ub8","note":"","ucode":"0D937C3EAEB781","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":562017,"discussion_content":"这老师不行啊 强烈推荐老是先学习下 深入理解kafka 那本书\n","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1649764582,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1062864,"avatar":"https://static001.geekbang.org/account/avatar/00/10/37/d0/26975fba.jpg","nickname":"aof","note":"","ucode":"5815D63C4926BC","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":18382,"discussion_content":"为了避免出现类似于脑裂的情况吗？","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1569053474,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2313382,"avatar":"https://static001.geekbang.org/account/avatar/00/23/4c/a6/e6f1d773.jpg","nickname":"鸣己","note":"","ucode":"4FC0C37457F21A","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":368057,"discussion_content":"出现过，大量topic的的分区找不到leader，是重启解决的，但我不知道什么原因","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1618553343,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2355391,"avatar":"","nickname":"Geek_110f21","note":"","ucode":"67495EAEAF5D61","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":343615,"discussion_content":"/controller节点是临时节点，旧controller对应的broker断连后会话过期临时节点自动删除，复活后新的临时节点已经不是它的了，可以处理直接去除controller角色吧","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1611111688,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2412914,"avatar":"","nickname":"Geek_7154d8","note":"","ucode":"AF1AF3171BF744","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":352273,"discussion_content":"同问，出现两个控制器会导致什么问题呢\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1614670878,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":2412914,"avatar":"","nickname":"Geek_7154d8","note":"","ucode":"AF1AF3171BF744","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367768,"discussion_content":"脑裂？","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1618465445,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":352273,"ip_address":""},"score":367768,"extra":""}]}]},{"had_liked":false,"id":149790,"user_name":"注定非凡","can_delete":false,"product_type":"c1","uid":1113597,"ip_address":"","ucode":"80673056E131B7","user_header":"https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg","comment_is_top":false,"comment_ctime":1573378629,"is_pvip":true,"discussion_count":6,"race_medal":0,"score":"130422397509","product_id":100029201,"comment_content":"1作用：<br>控制器组件（Controller），是Apache Kafka的核心组件。它的主要作用是Apache Zookeeper的帮助下管理和协调整个Kafka集群。<br>集群中任意一台Broker都能充当控制器的角色，但在运行过程中，只能有一个Broker成为控制器。<br><br>2 特点：控制器是重度依赖Zookeeper。<br>3 产生：<br>\t控制器是被选出来的，Broker在启动时，会尝试去Zookeeper中创建&#47;controller节点。Kafka当前选举控制器的规则是：第一个成功创建&#47;controller节点的Broker会被指定为控制器。<br>\t<br>4 功能：<br>\tA ：主题管理（创建，删除，增加分区）<br>\t当执行kafka-topics脚本时，大部分的后台工作都是控制器来完成的。<br>\tB ：分区重分配<br>\t\tKafka-reassign-partitions脚本提供的对已有主题分区进行细粒度的分配功能。<br>\tC ：Preferred领导者选举<br>\t\tPreferred领导者选举主要是Kafka为了避免部分Broker负载过重而提供的一种换Leade的方案。<br>\t\tD ：集群成员管理（新增Broker，Broker主动关闭，Broker宕机）<br>\t\t控制器组件会利用watch机制检查Zookeeper的&#47;brokers&#47;ids节点下的子节点数量变更。当有新Broker启动后，它会在&#47;brokers下创建专属的znode节点。一旦创建完毕，Zookeeper会通过Watch机制将消息通知推送给控制器，这样，控制器就能自动地感知到这个变化。进而开启后续新增Broker作业。<br>\t\t侦测Broker存活性则是依赖于刚刚提到的另一个机制：临时节点。每个Broker启动后，会在&#47;brokers&#47;ids下创建一个临时的znode。当Broker宕机或主机关闭后，该Broker与Zookeeper的会话结束，这个znode会被自动删除。同理，Zookeeper的Watch机制将这一变更推送给控制器，这样控制器就能知道有Broker关闭或宕机了，从而进行善后。<br>\t\t<br>E ：数据服务<br>控制器上保存了最全的集群元数据信息，其他所有Broker会定期接收控制器发来的元数据更新请求，从而更新其内存中的缓存数据。<br>\t<br>\t5 控制器保存的数据<br>\t <br>\t\t<br>\t控制器中保存的这些数据在Zookeeper中也保存了一份。每当控制器初始化时，它都会从Zookeeper上读取对应的元数据并填充到自己的缓存中。<br><br>\t6 控制器故障转移（Failover）<br>\t故障转移是指：当运行中的控制器突然宕机或意外终止时，Kafka能够快速地感知到，并立即启用备用控制器来替代之前失败的控制器。<br><br>\t7 内部设计原理<br>\t\tA ：控制器的内部设计相当复杂<br>\t\t控制器是多线程的设计，会在内部创建很多线程。如：<br>（1）为每个Broker创建一个对应的Socket连接，然后在创建一个专属的线程，用于向这些Broker发送特定的请求。<br>\t\t（2）控制连接zookeeper,也会创建单独的线程来处理Watch机制通知回调。<br>\t\t（3）控制器还会为主题删除创建额外的I&#47;O线程。<br>\t这些线程还会访问共享的控制器缓存数据，为了维护数据安全性，控制在代码中大量使用ReetrantLock同步机制，进一步拖慢了整个控制器的处理速度。<br><br>\t\tB ：在0.11版对控制器的低沉设计进了重构。<br><br>（1）最大的改进是：把多线程的方案改成了单线程加事件对列的方案。<br>\t \t<br>\t\ta. 单线程+队列的实现方式：社区引入了一个事件处理线程，统一处理各种控制器事件，然后控制器将原来执行的操作全部建模成一个个独立的事件，发送到专属的事件队列中，供此线程消费。<br>\t\tb. 单线程不代表之前提到的所有线程都被干掉了，控制器只是把缓存状态变更方面的工作委托给了这个线程而已。<br>（2）第二个改进：将之前同步操作Zookeeper全部改为异步操作。<br>\t\t\ta.  Zookeeper本身的API提供了同步写和异步写两种方式。同步操作zk，在有大量主题分区发生变更时，Zookeeper容易成为系统的瓶颈。","like_count":31,"discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367772,"discussion_content":"老课代表了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1618465690,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2058852,"avatar":"https://static001.geekbang.org/account/avatar/00/1f/6a/64/3d4fccf8.jpg","nickname":"Z_Z","note":"","ucode":"654BE3F3C7DBA4","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":572684,"discussion_content":"我感觉每篇文章直接拉到下面看你评论就够了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1652891383,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1675951,"avatar":"https://static001.geekbang.org/account/avatar/00/19/92/af/2062bb36.jpg","nickname":"张晗","note":"","ucode":"B171A0A9C23421","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":546210,"discussion_content":"学习委员","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1642230873,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2455712,"avatar":"https://static001.geekbang.org/account/avatar/00/25/78/a0/7a248ddc.jpg","nickname":"福","note":"","ucode":"F2FC7AF5D433C6","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":538728,"discussion_content":"厉害啊，课代表","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1639494163,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2832753,"avatar":"https://static001.geekbang.org/account/avatar/00/2b/39/71/da2d477e.jpg","nickname":"边界","note":"","ucode":"79F0418180D1E9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":534453,"discussion_content":"老哥，真有毅力","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1638193192,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2642315,"avatar":"","nickname":"Geek_c695c1","note":"","ucode":"FC2AD53F54582D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390898,"discussion_content":"希望在后面能看到你","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630124074,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119451,"user_name":"nightmare","can_delete":false,"product_type":"c1","uid":1056314,"ip_address":"","ucode":"EF2E51C2122A86","user_header":"https://static001.geekbang.org/account/avatar/00/10/1e/3a/5b21c01c.jpg","comment_is_top":false,"comment_ctime":1564592250,"is_pvip":false,"discussion_count":3,"race_medal":0,"score":"108938774650","product_id":100029201,"comment_content":"类似rocket mq写一个name server的注册模块出来，代替zookeeper   ，从而实现 控制器选举 ，元数据共享，还有broker信息注册等功能","like_count":26,"discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367770,"discussion_content":"这不就是重复造轮子了吗？关键是用zk有什么缺陷，新造的轮子能不能解决这些缺陷","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1618465566,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1277081,"avatar":"https://static001.geekbang.org/account/avatar/00/13/7c/99/4dac6ce6.jpg","nickname":"lakeslove","note":"","ucode":"65E14D29D3C981","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":370070,"discussion_content":"使用zk的主要缺陷是运维太重，必须同时部署zk和kafka，所以2.8版本已经计划把zk去掉了","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1619272780,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":367770,"ip_address":""},"score":370070,"extra":""}]},{"author":{"id":1103208,"avatar":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","nickname":"归零","note":"","ucode":"C99B8E93009A46","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":350070,"discussion_content":"期待老师能够展开说说","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613698119,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":122361,"user_name":"icejoywoo","can_delete":false,"product_type":"c1","uid":1019222,"ip_address":"","ucode":"E68C8B54D07EC3","user_header":"https://static001.geekbang.org/account/avatar/00/0f/8d/56/2a04dd88.jpg","comment_is_top":false,"comment_ctime":1565348842,"is_pvip":false,"replies":[{"id":"44933","content":"嗯，做一组controller，基于Raft算法组成quorum","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1565351032,"ip_address":"","comment_id":122361,"utype":1}],"discussion_count":2,"race_medal":0,"score":"70284825578","product_id":100029201,"comment_content":"基于raft搞一套来替代zookeeper？","like_count":17,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462220,"discussion_content":"嗯，做一组controller，基于Raft算法组成quorum","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565351032,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367776,"discussion_content":"但是有点重复造轮子之嫌啊","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618467049,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119549,"user_name":"野性力量","can_delete":false,"product_type":"c1","uid":1578718,"ip_address":"","ucode":"B6C152FA332B14","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/diaGeaLuw3oTAcyFMnkiaVur33RXdUZL8z1LtfHibIyh4r629YSexJQz5JXYjBH7v9rwHH7ham5CzqDZF75QnGIwg/132","comment_is_top":false,"comment_ctime":1564624786,"is_pvip":false,"replies":[{"id":"43864","content":"暂时可以理解成版本","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564627703,"ip_address":"","comment_id":119549,"utype":1}],"discussion_count":2,"race_medal":0,"score":"53104232338","product_id":100029201,"comment_content":"epoch这个词我经常看到，查了是纪元的意思，不过用在这里应该怎么理解呢。（在图里）","like_count":13,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460949,"discussion_content":"暂时可以理解成版本","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564627703,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2577451,"avatar":"","nickname":"Geek_9c6c3e","note":"","ucode":"F3B71465B25BC6","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":372810,"discussion_content":"投票周期，选期","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1620469013,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119979,"user_name":"Stony.修行僧","can_delete":false,"product_type":"c1","uid":1061277,"ip_address":"","ucode":"0F2368F7D93E4A","user_header":"https://static001.geekbang.org/account/avatar/00/10/31/9d/daad92d2.jpg","comment_is_top":false,"comment_ctime":1564743432,"is_pvip":false,"replies":[{"id":"44264","content":"嗯，看到这个KIP了，最近很火，有人还翻译出来了。事实上这个KIP只是在讨论阶段，目前还没有被accept","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564966602,"ip_address":"","comment_id":119979,"utype":1}],"discussion_count":3,"race_medal":0,"score":"48809383688","product_id":100029201,"comment_content":"KIP-500: Replace ZooKeeper with a Self-Managed Metadata Quorum<br>了解一下","like_count":11,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461158,"discussion_content":"嗯，看到这个KIP了，最近很火，有人还翻译出来了。事实上这个KIP只是在讨论阶段，目前还没有被accept","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966602,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1521451,"avatar":"https://static001.geekbang.org/account/avatar/00/17/37/2b/b32f1d66.jpg","nickname":"Ball","note":"","ucode":"1EE949E68D84CA","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":132479,"discussion_content":"这个 KIP 已经被社区接受了，赶紧学习一下新机制","likes_number":7,"is_delete":false,"is_hidden":false,"ctime":1578911796,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1182802,"avatar":"https://static001.geekbang.org/account/avatar/00/12/0c/52/f25c3636.jpg","nickname":"长脖子树","note":"","ucode":"D9090EF67EEB1B","race_medal":0,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":288383,"discussion_content":"https://cwiki.apache.org/confluence/display/KAFKA/KIP-500%3A+Replace+ZooKeeper+with+a+Self-Managed+Metadata+Quorum","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1593739752,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119610,"user_name":"你好旅行者","can_delete":false,"product_type":"c1","uid":1154101,"ip_address":"","ucode":"5C72A428DC28F3","user_header":"https://static001.geekbang.org/account/avatar/00/11/9c/35/9dc79371.jpg","comment_is_top":false,"comment_ctime":1564636977,"is_pvip":false,"replies":[{"id":"43970","content":"Controller有个context，里面缓存了很多数据。以前的设计是多个线程会同时访问这些数据，比如topic删除线程、controller线程等。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564708032,"ip_address":"","comment_id":119610,"utype":1}],"discussion_count":1,"race_medal":0,"score":"44514309937","product_id":100029201,"comment_content":"老师好，关于线程的优化，我能否这样理解:之前是为每一个事件分配一个线程，线程本身的切换以及锁会带来繁重的开销。在后续的版本中，讲请求封装成了一个个的事件，采用异步串行化的方式，放入到队列中，由统一的一个线程来轮询这个队列，从而避免了锁的开销。不知道这样的理解是否准确？<br><br>此外，老师说的多个线程之间共享Broker缓内存区域，可否举个例子，在什么情况下他们需要共享内存区域呢？<br><br>谢谢老师！","like_count":10,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460977,"discussion_content":"Controller有个context，里面缓存了很多数据。以前的设计是多个线程会同时访问这些数据，比如topic删除线程、controller线程等。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564708032,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":213416,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1588409413,"is_pvip":true,"replies":[{"id":"79346","content":"1. Controller所在broker发生故障，ZooKeeper上的&#47;controller节点会自动消失。其他broker监控这个节点的存在，因此会第一时间感知到<br>2. 极少数情况下，不排除出现脑裂的情形，比如出现network partitioning，Zookeeper ensemble被分割成两个，的确有可能出现两个controller","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1588725742,"ip_address":"","comment_id":213416,"utype":1}],"discussion_count":2,"race_medal":0,"score":"35948147781","product_id":100029201,"comment_content":"老师，请问：<br>1. 当控制器发生故障时，其他broker是如何感知到的？是ZK watch controller没有节点，然后广播通知其他的broker, 来争抢新建一个控制器节点吗？ 还是其他broker没定时收到控制器发送的元数据同步请求？<br>2. ZK不是可以确保节点的唯一性，为什么还会出现控制器大于1的情况？","like_count":8,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493774,"discussion_content":"1. Controller所在broker发生故障，ZooKeeper上的/controller节点会自动消失。其他broker监控这个节点的存在，因此会第一时间感知到\n2. 极少数情况下，不排除出现脑裂的情形，比如出现network partitioning，Zookeeper ensemble被分割成两个，的确有可能出现两个controller","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1588725742,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1902220,"avatar":"","nickname":"Geek_9d0e04","note":"","ucode":"F5560CE5BDB125","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":292244,"discussion_content":"zookeeper不是一个cp系统吗，如果出现网络分区，是不会提供服务的，为啥会出现两个controller呢？而且很多的选主服务都是通过zookeeper来做的呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595153544,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":139768,"user_name":"谢特","can_delete":false,"product_type":"c1","uid":1248684,"ip_address":"","ucode":"9C30DBFECFE649","user_header":"https://static001.geekbang.org/account/avatar/00/13/0d/ac/09678490.jpg","comment_is_top":false,"comment_ctime":1570720408,"is_pvip":false,"replies":[{"id":"54018","content":"一般不共享内存，甚至什么都不共享， 这就是所谓的Shard-Nothing架构","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1570764202,"ip_address":"","comment_id":139768,"utype":1}],"discussion_count":1,"race_medal":0,"score":"31635491480","product_id":100029201,"comment_content":"多个节点之间内存一般怎么共享","like_count":7,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470105,"discussion_content":"一般不共享内存，甚至什么都不共享， 这就是所谓的Shard-Nothing架构","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570764202,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119736,"user_name":"QQ怪","can_delete":false,"product_type":"c1","uid":1211223,"ip_address":"","ucode":"1A39B8433D9208","user_header":"https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg","comment_is_top":false,"comment_ctime":1564668509,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"31629439581","product_id":100029201,"comment_content":"我也想知道rocketmq的name server和用zk的区别和优劣势？","like_count":7,"discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367774,"discussion_content":"这个对比应该可以直接搜到吧，甚至火箭mq的官方文档应该有介绍","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618466244,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":131622,"user_name":"电光火石","can_delete":false,"product_type":"c1","uid":1013160,"ip_address":"","ucode":"3AD33BB4AA940F","user_header":"https://static001.geekbang.org/account/avatar/00/0f/75/a8/dfe4cade.jpg","comment_is_top":false,"comment_ctime":1567826712,"is_pvip":false,"replies":[{"id":"50333","content":"1. 执行reassign命令总提示分区在reassign中，或者ZooKeeper中的&#47;admin&#47;reassign_partitions下相应节点未被删除<br>2. 不会丢失数据，如果真丢失了，果断开jira，因为这是一个严重的bug：）","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567843409,"ip_address":"","comment_id":131622,"utype":1}],"discussion_count":3,"race_medal":0,"score":"27337630488","product_id":100029201,"comment_content":"老师好，想问一下：<br>1.如何看出重分区被hang住了，是长时间没有响应就被hang住，还是有一些jmx的参数可以观察？<br>2.当我们删除&#47;controller的时候，是否会有数据丢失的可能，比如重分区的请求，是否会先存储在zk，然后controler从中读取请求进行处理，这个时候发生重failover，是否新的controller会重新读到这个请求？<br>谢谢了","like_count":6,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":466543,"discussion_content":"1. 执行reassign命令总提示分区在reassign中，或者ZooKeeper中的/admin/reassign_partitions下相应节点未被删除\n2. 不会丢失数据，如果真丢失了，果断开jira，因为这是一个严重的bug：）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567843409,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1068369,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/51/5fc23a43.jpg","nickname":"原红帅","note":"","ucode":"E23D29F4FCACFF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":304405,"discussion_content":"没明白，删除/controller为什么不会丢数据呢？controller数据分别在zookkeeper和 controller(broker)中保存，控制器出问题了，所以从控制器中已经获取不到数据了，再删除zookeeper中的数据，那初始化的controller的数据从哪里获取呢？","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1599566210,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":1,"child_discussions":[{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1068369,"avatar":"https://static001.geekbang.org/account/avatar/00/10/4d/51/5fc23a43.jpg","nickname":"原红帅","note":"","ucode":"E23D29F4FCACFF","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390614,"discussion_content":"不是删除全部啊，只是删除控制器标识内容","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629941268,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":304405,"ip_address":""},"score":390614,"extra":""}]}]},{"had_liked":false,"id":215566,"user_name":"thomas","can_delete":false,"product_type":"c1","uid":1016777,"ip_address":"","ucode":"9AB945308F1B50","user_header":"https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg","comment_is_top":false,"comment_ctime":1589017951,"is_pvip":true,"replies":[{"id":"79803","content":"严格来说，Kafka是把这个事情交由ZooKeeper来完成的。如果你指定了多台，那么ZooKeeper会把Kafka的建立连接请求发送给ZooKeeper的leader节点，其他standby<br>","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1589035927,"ip_address":"","comment_id":215566,"utype":1}],"discussion_count":1,"race_medal":0,"score":"18768887135","product_id":100029201,"comment_content":"老师，若给kafka-server配置文件中的zookeeper.connect参数写了3个zk的节点，他们是如何交换？kafka-server先尝试和第一个zk节点开始建立tcp socket连接，若成功，那么后面两个就不用建立连接, 待异常情况下，做备用吗？","like_count":4,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":494479,"discussion_content":"严格来说，Kafka是把这个事情交由ZooKeeper来完成的。如果你指定了多台，那么ZooKeeper会把Kafka的建立连接请求发送给ZooKeeper的leader节点，其他standby\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589035927,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":140041,"user_name":"林肯","can_delete":false,"product_type":"c1","uid":1008582,"ip_address":"","ucode":"D2C97220230DE5","user_header":"https://static001.geekbang.org/account/avatar/00/0f/63/c6/d6ea3df3.jpg","comment_is_top":false,"comment_ctime":1570794591,"is_pvip":false,"replies":[{"id":"54180","content":"异步发送元数据来保持一致性。最权威的数据保存在Zk上。当controller挂掉之后，Zk上的临时节点&#47;controller消失，所有存活broker都会感知到这一变化，于是抢注&#47;controller，谁抢上谁就是新的controller","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1570840706,"ip_address":"","comment_id":140041,"utype":1}],"discussion_count":2,"race_medal":0,"score":"18750663775","product_id":100029201,"comment_content":"各个broker之间怎样保证元数据的一致性？controller挂了后重新选举的机制是怎样的？","like_count":5,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":470220,"discussion_content":"异步发送元数据来保持一致性。最权威的数据保存在Zk上。当controller挂掉之后，Zk上的临时节点/controller消失，所有存活broker都会感知到这一变化，于是抢注/controller，谁抢上谁就是新的controller","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570840706,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1008582,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/63/c6/d6ea3df3.jpg","nickname":"林肯","note":"","ucode":"D2C97220230DE5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":30581,"discussion_content":"异步发送时如果接收方没有成功写入呢？是否需要ack？这里为什么不做成类似于消费者rebalance机制？感谢老师答疑","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1570843741,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":144192,"user_name":"云师兄","can_delete":false,"product_type":"c1","uid":1010459,"ip_address":"","ucode":"4475AF1598FBFD","user_header":"https://static001.geekbang.org/account/avatar/00/0f/6b/1b/4b397b80.jpg","comment_is_top":false,"comment_ctime":1571877580,"is_pvip":false,"replies":[{"id":"55696","content":"据我所知没有性能方面的报告出来。改进最大的收益来自于可理解性和可维护性方面的提升","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1571964969,"ip_address":"","comment_id":144192,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14456779468","product_id":100029201,"comment_content":"社区改造单线程加队列的方式，有没有数据或者图标对比下改造前后性能的差异？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":471843,"discussion_content":"据我所知没有性能方面的报告出来。改进最大的收益来自于可理解性和可维护性方面的提升","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1571964969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":122001,"user_name":"信信","can_delete":false,"product_type":"c1","uid":1303865,"ip_address":"","ucode":"8DF0EC045579FD","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg","comment_is_top":false,"comment_ctime":1565267114,"is_pvip":false,"replies":[{"id":"44817","content":"客户端会先去找controller所在节点，然后直接给它发送请求","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1565276866,"ip_address":"","comment_id":122001,"utype":1}],"discussion_count":1,"race_medal":0,"score":"14450169002","product_id":100029201,"comment_content":"修改主题分区的broker_host是随便指定一个吗？最后由zk通知到控制器？<br>作者: 其实如果指定的是broker host，后面是不走ZooKeeper的<br><br>追问：<br>前面文章提到增加分区是控制器完成的。  <br>那如果随机在一个broker上执行增加分区的命令，再由这个broker通知控制器去做吗？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":462052,"discussion_content":"客户端会先去找controller所在节点，然后直接给它发送请求","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1565276866,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119529,"user_name":"Leon📷","can_delete":false,"product_type":"c1","uid":1219496,"ip_address":"","ucode":"B9BBD1EFAAE5A2","user_header":"https://static001.geekbang.org/account/avatar/00/12/9b/a8/6a391c66.jpg","comment_is_top":false,"comment_ctime":1564622490,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"14449524378","product_id":100029201,"comment_content":"脑裂问题希望详细说说","like_count":3},{"had_liked":false,"id":119484,"user_name":"玉剑冰锋","can_delete":false,"product_type":"c1","uid":1214202,"ip_address":"","ucode":"8EA56A71BA5B22","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg","comment_is_top":false,"comment_ctime":1564618325,"is_pvip":false,"replies":[{"id":"43855","content":"znode的ephemeralOwner不为0的就是临时节点","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564627385,"ip_address":"","comment_id":119484,"utype":1}],"discussion_count":3,"race_medal":0,"score":"14449520213","product_id":100029201,"comment_content":"如何区分临时znode和永久znode？","like_count":3,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460921,"discussion_content":"znode的ephemeralOwner不为0的就是临时节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564627385,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1333607,"avatar":"https://static001.geekbang.org/account/avatar/00/14/59/67/f4ba1da4.jpg","nickname":"Hello world","note":"","ucode":"4D2EF3034571B7","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3602,"discussion_content":"用get命令查看节点的Stat数据结构信息，其中有一个字段是ephemeralOwner意思是这个节点的临时拥有者。当ephemeralOwner 值不为0时，表明这个节点是临时节点，值为会话id，当ephemeralOwner 值为0时，表明这个节点是持久节点。","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1564629154,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1117793,"avatar":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","nickname":"dream","note":"","ucode":"65B33D32FA8BE9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3593,"discussion_content":"这是zk的吧。。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564625756,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":233002,"user_name":"Geek_03","can_delete":false,"product_type":"c1","uid":1905527,"ip_address":"","ucode":"1502D858542269","user_header":"","comment_is_top":false,"comment_ctime":1594188585,"is_pvip":false,"replies":[{"id":"86024","content":"负载大的时候才抛这个错误还是一开始就抛。如果是后者，那么连不上Coordinator的可能性很大，如果是前者，可能和Rebalance的设置有关，比如max.poll.interval.ms，max.poll.records是否合理","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1594256897,"ip_address":"","comment_id":233002,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10184123177","product_id":100029201,"comment_content":"老师，consumer频繁打印Marking the coorinator dead for group日志是什么原因呢？网上很多答案都是说要配置host，但是我们这边consumer端的服务器上已经配置了host，而且感觉这个信息的打印跟consumer的拉取速度有很大关系","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":500846,"discussion_content":"负载大的时候才抛这个错误还是一开始就抛。如果是后者，那么连不上Coordinator的可能性很大，如果是前者，可能和Rebalance的设置有关，比如max.poll.interval.ms，max.poll.records是否合理","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1594256897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":210462,"user_name":"猕猴桃 盛哥","can_delete":false,"product_type":"c1","uid":1102535,"ip_address":"","ucode":"D652436CB1E506","user_header":"https://static001.geekbang.org/account/avatar/00/10/d2/c7/14d235bb.jpg","comment_is_top":false,"comment_ctime":1587754855,"is_pvip":false,"replies":[{"id":"78460","content":"&#47;consumer已经被弃用了。&#47;controller没有说明你的Kafka集群没起来。一个正常启动的Kafka集群必然有个Broker充当Controller，去抢注&#47;controller节点","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1587866096,"ip_address":"","comment_id":210462,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10177689447","product_id":100029201,"comment_content":"为何在2.2.1版本的zk的controller和consumer节点下没有任何数据和子节点呢？(单机环境)","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":493026,"discussion_content":"/consumer已经被弃用了。/controller没有说明你的Kafka集群没起来。一个正常启动的Kafka集群必然有个Broker充当Controller，去抢注/controller节点","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587866096,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":129456,"user_name":"张庆","can_delete":false,"product_type":"c1","uid":1050284,"ip_address":"","ucode":"17AE1E23B83304","user_header":"https://static001.geekbang.org/account/avatar/00/10/06/ac/604de2e8.jpg","comment_is_top":false,"comment_ctime":1567132182,"is_pvip":false,"replies":[{"id":"48314","content":"每次变更都会更新zookeeper","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1567154969,"ip_address":"","comment_id":129456,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10157066774","product_id":100029201,"comment_content":"胡夕大拿，您好，zookeeper中保存了一份kafka的元数据信息，控制器中也会保存一份。当控制器初始化的时候会从zookeeper中拉一份数据，那么之后zookeeper和controller中的数据怎么保持一致啊？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":465479,"discussion_content":"每次变更都会更新zookeeper","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1567154969,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119964,"user_name":"dream","can_delete":false,"product_type":"c1","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1564739904,"is_pvip":false,"replies":[{"id":"44265","content":"不会的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564966618,"ip_address":"","comment_id":119964,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10154674496","product_id":100029201,"comment_content":"老师，突然想到一个与本节无关的问题：如果一台机器系统彻底坏了，不能恢复了，这时候副本肯定会丢一个，kafka 会直接把其它机器中的 一个 Follower 副本提升为 Leader 副本，对外提供服务，但是kafka会自动为其创建新的副本吗？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461152,"discussion_content":"不会的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564966618,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1044182,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ee/d6/a9b34bd3.jpg","nickname":"Joypan","note":"","ucode":"B7298241E7AAAF","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":192176,"discussion_content":"需要启动一个新的kafka，但是broker id需要配置为宕掉的id，启动后就会自动开始副本复制了","likes_number":3,"is_delete":false,"is_hidden":false,"ctime":1583066902,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119782,"user_name":"WL","can_delete":false,"product_type":"c1","uid":1173771,"ip_address":"","ucode":"6277DCD776B87E","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/0b/1171ac71.jpg","comment_is_top":false,"comment_ctime":1564701174,"is_pvip":false,"replies":[{"id":"43960","content":"也会提供正常的读写服务","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564707772,"ip_address":"","comment_id":119782,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10154635766","product_id":100029201,"comment_content":"请问控制器也会像其他的broker一样提供消息的读写服务吗? 还是只做Broker的控制和协调工作?","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":461069,"discussion_content":"也会提供正常的读写服务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564707772,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119568,"user_name":"玉剑冰锋","can_delete":false,"product_type":"c1","uid":1214202,"ip_address":"","ucode":"8EA56A71BA5B22","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg","comment_is_top":false,"comment_ctime":1564627547,"is_pvip":false,"replies":[{"id":"43979","content":"都可能","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564708554,"ip_address":"","comment_id":119568,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10154562139","product_id":100029201,"comment_content":"文章中说的重分区hang住，指的是failed还是一直处于in progress还是两种情况都可以？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460958,"discussion_content":"都可能","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564708554,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119520,"user_name":"calljson","can_delete":false,"product_type":"c1","uid":1505262,"ip_address":"","ucode":"A5F81A6A5B4497","user_header":"https://static001.geekbang.org/account/avatar/00/16/f7/ee/6eeb58a3.jpg","comment_is_top":false,"comment_ctime":1564621746,"is_pvip":false,"replies":[{"id":"43848","content":"嗯嗯，会有短暂的不可用","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564627299,"ip_address":"","comment_id":119520,"utype":1}],"discussion_count":2,"race_medal":0,"score":"10154556338","product_id":100029201,"comment_content":"手动删除 &#47;controller 节点在找到新的controller节点前，这个时间窗口期kafka集群是不是无法提供服务？比如：删除topic操作、消费消息等，请老师帮忙解惑，谢谢您","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460939,"discussion_content":"嗯嗯，会有短暂的不可用","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564627299,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367779,"discussion_content":"所以从这个角度看，Kafka提供了CP保证","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618468396,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119510,"user_name":"Dovelol","can_delete":false,"product_type":"c1","uid":1253384,"ip_address":"","ucode":"9B5DDF7720F307","user_header":"https://static001.geekbang.org/account/avatar/00/13/20/08/bc06bc69.jpg","comment_is_top":false,"comment_ctime":1564620651,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"10154555243","product_id":100029201,"comment_content":"老师好，想问下rocketmq的name server和用zk的区别和优劣势是什么呢？","like_count":2,"discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367780,"discussion_content":"这个问题的格局比较大","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618468476,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119476,"user_name":"玉剑冰锋","can_delete":false,"product_type":"c1","uid":1214202,"ip_address":"","ucode":"8EA56A71BA5B22","user_header":"https://static001.geekbang.org/account/avatar/00/12/86/fa/4bcd7365.jpg","comment_is_top":false,"comment_ctime":1564617019,"is_pvip":false,"replies":[{"id":"43856","content":"可以试试在reassign的过程中删除topic","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564627407,"ip_address":"","comment_id":119476,"utype":1}],"discussion_count":1,"race_medal":0,"score":"10154551611","product_id":100029201,"comment_content":"如何在测试环境模拟一个重分区hang住的现象？","like_count":2,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460918,"discussion_content":"可以试试在reassign的过程中删除topic","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564627407,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":294988,"user_name":"Geek_b98e35","can_delete":false,"product_type":"c1","uid":1542486,"ip_address":"","ucode":"7143501BD7EA25","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKlllSKrpQkhSxAUhpcFk7oJicA50fBQPSmF0Knicd1LN4SVMwbmuFmXRhB9TARHyaNlG1XL0t470uw/132","comment_is_top":false,"comment_ctime":1622171918,"is_pvip":false,"replies":[{"id":"107168","content":"前者是指为分区选定不同的leader副本；后者是为将同一个consumer group下的所有成员选择它们要消费的分区。两者不是一回事<br>","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1622353431,"ip_address":"","comment_id":294988,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5917139214","product_id":100029201,"comment_content":"分区重分配和rebalance的区别是啥呀！都是将分区重新分配给消费者？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520905,"discussion_content":"前者是指为分区选定不同的leader副本；后者是为将同一个consumer group下的所有成员选择它们要消费的分区。两者不是一回事\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1622353431,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":286277,"user_name":"一飞冲天","can_delete":false,"product_type":"c1","uid":1980707,"ip_address":"","ucode":"14CB54F27C4DD4","user_header":"https://static001.geekbang.org/account/avatar/00/1e/39/23/a8a23268.jpg","comment_is_top":false,"comment_ctime":1617238837,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5912206133","product_id":100029201,"comment_content":"之后会采取raft算法并去掉zookeeper","like_count":1},{"had_liked":false,"id":279469,"user_name":"微博账号登录","can_delete":false,"product_type":"c1","uid":2016208,"ip_address":"","ucode":"577214FC6D7CDD","user_header":"","comment_is_top":false,"comment_ctime":1613794074,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5908761370","product_id":100029201,"comment_content":"手动删除 &#47;controller触发集群选举新的controller是有风险的，风险点存在于，在老的controller卸任逻辑执行完成之前，集群内同时存在两个controller。老controller在执行卸任逻辑过程中，会关闭controller的相关任务，其中在执行autoRebalanceScheduler定时任务线程时，如果恰好触发了preferred leader elect 会等待所有已经提交的leader选举任务执行完成。如果新的controller已经通过zk数据初始化了controller context，并已经向集群其他controller广播了UpdateMetadataRequest后，在老的controller执行preferred leader elect这个过程中，老的controller会修改zk上的数据，但是老的controller向其他broker发送的LeaderAndIsr请求和UpdateMetadata请求会被拒绝，因为集群内的其他broker已经收到了新的controller的请求，会认定老的controller已经过期了，这就造成了zk上的数据和集群broker上的数据不一致。<br>被老的controller执行了preferred leader elect的分区，如果发生了ISR的收缩，controller最终会通过zk上的数据向所有broker发送UpdateMetadata请求，但是不会发送LeaderAndIsr请求，这就导致这些副本的实际leader和MetadataCache中的leader不一致，客户端发送消息会失败。","like_count":1},{"had_liked":false,"id":278236,"user_name":"归零","can_delete":false,"product_type":"c1","uid":1103208,"ip_address":"","ucode":"C99B8E93009A46","user_header":"https://static001.geekbang.org/account/avatar/00/10/d5/68/2201b6b9.jpg","comment_is_top":false,"comment_ctime":1612838821,"is_pvip":true,"replies":[{"id":"101515","content":"两者没有什么关联。控制器的协调作用不是指Coordinator","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1613780764,"ip_address":"","comment_id":278236,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5907806117","product_id":100029201,"comment_content":"老师，controller和Coordinator二者有关系吗？看到文章中有一句话控制器是起协调作用的组件。谢谢！","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":515321,"discussion_content":"两者没有什么关联。控制器的协调作用不是指Coordinator","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1613780764,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367781,"discussion_content":"有可能会位于同一个broker中","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618468506,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":263858,"user_name":"长青","can_delete":false,"product_type":"c1","uid":1360825,"ip_address":"","ucode":"035E147C097C09","user_header":"https://static001.geekbang.org/account/avatar/00/14/c3/b9/5cd84471.jpg","comment_is_top":false,"comment_ctime":1606282785,"is_pvip":false,"replies":[{"id":"95855","content":"controller如果挂掉了，zookeeper会监控到，然后重新选举controller","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1606440352,"ip_address":"","comment_id":263858,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5901250081","product_id":100029201,"comment_content":"老师好，请问控制器其实也是一个broker，正常一个broker宕机，被controller监听到，会触发以宕机broker为leader的主题分区的重新选举，那如果是controller宕机了呢? 那么以这台controller为leader的主题分区的重新选举是在什么时候进行的呢？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":510336,"discussion_content":"controller如果挂掉了，zookeeper会监控到，然后重新选举controller","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1606440352,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":125198,"user_name":"钱","can_delete":false,"product_type":"c1","uid":1009652,"ip_address":"","ucode":"2C92A243A463D4","user_header":"https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg","comment_is_top":false,"comment_ctime":1566116322,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5861083618","product_id":100029201,"comment_content":"小结一下<br>1：kafka控制器是什么？<br>kafka控制器是kafka的核心组件，kafka集群中任意一台 Broker 都能充当控制器的角色，但是，在运行过程中，只能有一个 Broker 成为控制器，行使其管理和协调的职责。<br><br>2：kafka控制器有什么用？<br>它的主要作用是在 Apache ZooKeeper 的帮助下管理和协调整个 Kafka 集群。<br>2-1：主题管理——主题及主题下的分区的增删改查<br>2-2：分区重分配——提供对已有主题分区进行细粒度的分配功能。<br>2-3：preferred领导者选举——防止leader负载过重宕机的备份<br>2-4：集群成员管理——broker的增删<br>2-5：数据服务——向其他 Broker 提供数据服务。控制器上保存了最全的集群元数据信息，其他所有 Broker 会定期接收控制器发来的元数据更新请求，从而更新其内存中的缓存数据<br><br>3：kafka控制器是如何设计和实现的？<br>Kafka 当前选举控制器的规则是：第一个成功创建 &#47;controller 节点的 Broker 会被指定为控制器。<br>如果运行中的控制器突然宕机或意外终止，Kafka 能够快速地感知到，并立即启用备用控制器来代替之前失败的控制器。<br>控制器的内部设计≈单线程+事件队列+异步+请求分类<br><br><br>","like_count":1},{"had_liked":false,"id":119872,"user_name":"Johnson","can_delete":false,"product_type":"c1","uid":1060473,"ip_address":"","ucode":"FF29D9659284FD","user_header":"https://static001.geekbang.org/account/avatar/00/10/2e/79/05261bd7.jpg","comment_is_top":false,"comment_ctime":1564716061,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5859683357","product_id":100029201,"comment_content":"看到社区在计划移除zookeeper依赖了<br><br>https:&#47;&#47;cwiki.apache.org&#47;confluence&#47;display&#47;KAFKA&#47;KIP-500%3A+Replace+ZooKeeper+with+a+Self-Managed+Metadata+Quorum","like_count":1},{"had_liked":false,"id":119558,"user_name":"dream","can_delete":false,"product_type":"c1","uid":1117793,"ip_address":"","ucode":"65B33D32FA8BE9","user_header":"https://static001.geekbang.org/account/avatar/00/11/0e/61/ae68f8eb.jpg","comment_is_top":false,"comment_ctime":1564626114,"is_pvip":false,"replies":[{"id":"43980","content":"老版本位移的znode，也顺带画出来了。。。。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564708574,"ip_address":"","comment_id":119558,"utype":1}],"discussion_count":2,"race_medal":0,"score":"5859593410","product_id":100029201,"comment_content":"怎么zookeeper的那张图里面还有consumer的offset呢？<br>不是consumer的offset都保存在kafka内部位移主题 __consumer_offsets中吗？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460955,"discussion_content":"老版本位移的znode，也顺带画出来了。。。。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564708574,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1034204,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/c7/dc/9408c8c2.jpg","nickname":"ban","note":"","ucode":"E523CE97E48266","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":3669,"discussion_content":"老版的消费者会把位移保存到zk","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564676962,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119550,"user_name":"never leave","can_delete":false,"product_type":"c1","uid":1241638,"ip_address":"","ucode":"62888A1446A1E8","user_header":"https://static001.geekbang.org/account/avatar/00/12/f2/26/8d42ea6f.jpg","comment_is_top":false,"comment_ctime":1564624872,"is_pvip":false,"replies":[{"id":"43863","content":"里面没有子节点，但是该节点本身有内容啊。","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564627694,"ip_address":"","comment_id":119550,"utype":1}],"discussion_count":1,"race_medal":0,"score":"5859592168","product_id":100029201,"comment_content":"老师   我自己在虚拟机中搭建的kafka集群   为什么zookeeper的&#47;controller是空的？","like_count":1,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460950,"discussion_content":"里面没有子节点，但是该节点本身有内容啊。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564627694,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":347933,"user_name":"南瓜","can_delete":false,"product_type":"c1","uid":1500785,"ip_address":"","ucode":"A3828CEC6257CC","user_header":"https://static001.geekbang.org/account/avatar/00/16/e6/71/491dcad1.jpg","comment_is_top":false,"comment_ctime":1654591517,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1654591517","product_id":100029201,"comment_content":"当有新 Broker 启动后，它会在 &#47;brokers 下创建专属的 znode 节点。 老师这个znode节点是临时的还是永久的。","like_count":0},{"had_liked":false,"id":339825,"user_name":"ABC","can_delete":false,"product_type":"c1","uid":1054958,"ip_address":"","ucode":"7501AD9C0C4A70","user_header":"https://static001.geekbang.org/account/avatar/00/10/18/ee/a1ed60d1.jpg","comment_is_top":false,"comment_ctime":1648425487,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1648425487","product_id":100029201,"comment_content":"2022年，Kafka3.x确实准备移除zk的依赖了，做法是raft。","like_count":0},{"had_liked":false,"id":336890,"user_name":"不归橙","can_delete":false,"product_type":"c1","uid":1319969,"ip_address":"","ucode":"4F3D84E9395F61","user_header":"https://static001.geekbang.org/account/avatar/00/14/24/21/90b748a2.jpg","comment_is_top":false,"comment_ctime":1646450686,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1646450686","product_id":100029201,"comment_content":"减少对zk的依赖，可以借鉴微服务配置管理中心","like_count":0},{"had_liked":false,"id":334559,"user_name":"追风筝的人","can_delete":false,"product_type":"c1","uid":1488020,"ip_address":"","ucode":"2993D60F94C396","user_header":"https://static001.geekbang.org/account/avatar/00/16/b4/94/2796de72.jpg","comment_is_top":false,"comment_ctime":1645000406,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1645000406","product_id":100029201,"comment_content":"控制器组件（Controller），是 Apache Kafka 的核心组件。它的主要作用是在 Apache ZooKeeper 的帮助下管理和协调整个 Kafka 集群。","like_count":0},{"had_liked":false,"id":324745,"user_name":"懒猫","can_delete":false,"product_type":"c1","uid":2538092,"ip_address":"","ucode":"094F30C802C0F6","user_header":"","comment_is_top":false,"comment_ctime":1638600480,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1638600480","product_id":100029201,"comment_content":"就是把多线程改成了协程","like_count":0},{"had_liked":false,"id":287229,"user_name":"多襄丸","can_delete":false,"product_type":"c1","uid":1074310,"ip_address":"","ucode":"1AA1497C5A293C","user_header":"https://static001.geekbang.org/account/avatar/00/10/64/86/f5a9403a.jpg","comment_is_top":false,"comment_ctime":1617847216,"is_pvip":false,"replies":[{"id":"104424","content":"差不多这个意思","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1618026147,"ip_address":"","comment_id":287229,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1617847216","product_id":100029201,"comment_content":"去掉zk的依赖，也是要去掉 zk 保存元数据 的功能，将元数据交给controller 节点们来做吗？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":518238,"discussion_content":"差不多这个意思","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618026147,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367783,"discussion_content":"参考rocketMQ nameserver","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618468787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282930,"user_name":"胡小禾","can_delete":false,"product_type":"c1","uid":1132315,"ip_address":"","ucode":"1C23B7492C0C9E","user_header":"https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg","comment_is_top":false,"comment_ctime":1615468485,"is_pvip":false,"replies":[{"id":"102954","content":"那依然需要一个协调总控似的角色做这事啊，不能让所有broker都去zk直接拿数据？如果有1000个broker，想想这个复杂度就很高","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1615942404,"ip_address":"","comment_id":282930,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1615468485","product_id":100029201,"comment_content":"为什么需要有controller？假如没有controller 直接从ZK 拿数据，会有什么实质性的问题？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":516881,"discussion_content":"那依然需要一个协调总控似的角色做这事啊，不能让所有broker都去zk直接拿数据？如果有1000个broker，想想这个复杂度就很高","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1615942404,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":282196,"user_name":"Geek_505716","can_delete":false,"product_type":"c1","uid":1879982,"ip_address":"","ucode":"4D521700DE208E","user_header":"","comment_is_top":false,"comment_ctime":1615127831,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1615127831","product_id":100029201,"comment_content":"我看有人说基于raft kafka自己做一套共识组件。但是，这其实会增加整个系统的复杂度，而且项目的维护成本也会变高。我搜了一下去资料，etcd的性能要优于zk不少，是基于raft协议的，感觉用etcd替代zk会好不少。","like_count":0,"discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367784,"discussion_content":"https://github.com/etcd-io/dbtester","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618469330,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":276103,"user_name":"建华","can_delete":false,"product_type":"c1","uid":2381065,"ip_address":"","ucode":"668977F598DA01","user_header":"https://static001.geekbang.org/account/avatar/00/24/55/09/73f24874.jpg","comment_is_top":false,"comment_ctime":1611795629,"is_pvip":false,"replies":[{"id":"100453","content":"是的呢","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1612143263,"ip_address":"","comment_id":276103,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1611795629","product_id":100029201,"comment_content":"老师好，你说的zk上也会保存kafka的元数据信息，这些信息是不是存在不同的节点上，比如，&#47;broker,&#47;config等下面呀","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":514600,"discussion_content":"是的呢","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1612143263,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":265177,"user_name":"朴素柠檬c","can_delete":false,"product_type":"c1","uid":1547667,"ip_address":"","ucode":"2D4CBB70D801B1","user_header":"https://static001.geekbang.org/account/avatar/00/17/9d/93/4159edaa.jpg","comment_is_top":false,"comment_ctime":1606805751,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1606805751","product_id":100029201,"comment_content":"从新启动broker 如果上面又leader分区，会导致rebalance,在zk上删除，会触发watch，然后从新选举","like_count":0},{"had_liked":false,"id":236236,"user_name":"杨逸林","can_delete":false,"product_type":"c1","uid":1167233,"ip_address":"","ucode":"4BF3CF3E2F1AC7","user_header":"https://static001.geekbang.org/account/avatar/00/11/cf/81/96f656ef.jpg","comment_is_top":false,"comment_ctime":1595375179,"is_pvip":false,"replies":[{"id":"87313","content":"嗯嗯，未来Kafka会摆脱ZooKeeper成为一个自治服务","user_name":"作者回复","user_name_real":"胡夕","uid":"1288090","ctime":1595386743,"ip_address":"","comment_id":236236,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1595375179","product_id":100029201,"comment_content":"我只知道装RabbitMQ的时候根本不用装其他的，当然除了erlang包，应该会借鉴这个？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":501999,"discussion_content":"嗯嗯，未来Kafka会摆脱ZooKeeper成为一个自治服务","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595386743,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390616,"discussion_content":"Kafka2. 8已经这么干了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629942605,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":174220,"user_name":"小罗希冀","can_delete":false,"product_type":"c1","uid":1311995,"ip_address":"","ucode":"88416458FF0041","user_header":"https://static001.geekbang.org/account/avatar/00/14/04/fb/40f298bb.jpg","comment_is_top":false,"comment_ctime":1580094350,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1580094350","product_id":100029201,"comment_content":"要减少对zookeeper的依赖，可以效仿redis的sentinel模式？<br>运行几个特殊状态下的broker，用做检测普通broker集群中，broker主动被动宕机，集群元数据管理等","like_count":0,"discussions":[{"author":{"id":1339409,"avatar":"https://static001.geekbang.org/account/avatar/00/14/70/11/42cf8f9d.jpg","nickname":"chenjia","note":"","ucode":"61983C29FF4987","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":367795,"discussion_content":"那不如直接做个单独的，面得代码交织在一起","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1618471144,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119596,"user_name":"大楷","can_delete":false,"product_type":"c1","uid":1106663,"ip_address":"","ucode":"FD646018ED20BD","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLnTzRY667VmE9IUCSLALeVBlu8mdHfkm02FGcpza42QJ9qicp8KOdMDgFABys0ZnZfGd6j0W1V9zw/132","comment_is_top":false,"comment_ctime":1564632584,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564632584","product_id":100029201,"comment_content":"老师好，请问Apache Pulsar如何，它貌似解决了kafka目前的一些痛点，未来是否可以代替kafka呢","like_count":0},{"had_liked":false,"id":119595,"user_name":"宋晓明","can_delete":false,"product_type":"c1","uid":1146507,"ip_address":"","ucode":"DC866DCE2FBA9E","user_header":"https://static001.geekbang.org/account/avatar/00/11/7e/8b/3cc461b3.jpg","comment_is_top":false,"comment_ctime":1564632248,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1564632248","product_id":100029201,"comment_content":"我怎么感觉zk分布式锁和zk的高可用功能都是通过临时节点来实现的？","like_count":0},{"had_liked":false,"id":119584,"user_name":"刘丹","can_delete":false,"product_type":"c1","uid":1081922,"ip_address":"","ucode":"66594D1C957E15","user_header":"https://static001.geekbang.org/account/avatar/00/10/82/42/8b04d489.jpg","comment_is_top":false,"comment_ctime":1564630274,"is_pvip":false,"replies":[{"id":"43972","content":"目前设计是只有一个active controller，同时配以failover功能。社区的确在考虑引入多个active controller方案","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564708141,"ip_address":"","comment_id":119584,"utype":1}],"discussion_count":1,"race_medal":0,"score":"1564630274","product_id":100029201,"comment_content":"如果控制器只有1个，那么出现故障后不就没有控制器了。是否是只有1个激活的控制器，再加N个备选的控制器呢？","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460966,"discussion_content":"目前设计是只有一个active controller，同时配以failover功能。社区的确在考虑引入多个active controller方案","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564708141,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":119494,"user_name":"Liam","can_delete":false,"product_type":"c1","uid":1094597,"ip_address":"","ucode":"1D15D3B64F2606","user_header":"https://static001.geekbang.org/account/avatar/00/10/b3/c5/7fc124e2.jpg","comment_is_top":false,"comment_ctime":1564619485,"is_pvip":false,"replies":[{"id":"43852","content":"IO线程池是用于执行请求处理逻辑的","user_name":"作者回复","user_name_real":"huxi_2b","uid":"1288090","ctime":1564627340,"ip_address":"","comment_id":119494,"utype":1}],"discussion_count":2,"race_medal":0,"score":"1564619485","product_id":100029201,"comment_content":"为啥需要两个队列，io队列不能省略吗","like_count":0,"discussions":[{"author":{"id":1288090,"avatar":"https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg","nickname":"胡夕","note":"","ucode":"5709A689B6683B","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":460929,"discussion_content":"IO线程池是用于执行请求处理逻辑的","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1564627340,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":""},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1736462,"avatar":"https://static001.geekbang.org/account/avatar/00/1a/7f/0e/e3a8dbd9.jpg","nickname":"Liujun","note":"","ucode":"3DB1F3CA57B5B3","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":390618,"discussion_content":"去了解一下netty就懂了","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1629942766,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}