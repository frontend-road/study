{"id":627994,"title":"27ï½œå¼€å‘äº’ä¸å¹²æ‰°ï¼Œå¦‚ä½•å®ç°è‡ªåŠ¨å¤šç¯å¢ƒç®¡ç†ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯ç‹ç‚œã€‚</p><p>ä»è¿™èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹  GitOps çš„å¤šç¯å¢ƒç®¡ç†å’Œå®‰å…¨æ–¹é¢çš„å†…å®¹ã€‚</p><p>èŠèµ·å¤šç¯å¢ƒï¼Œä½ å¯èƒ½ä¼šç«‹å³æƒ³åˆ°ä¸‹é¢å‡ ä¸ªå¸¸è§çš„ç¯å¢ƒï¼š</p><ul>\n<li>å¼€å‘ç¯å¢ƒ</li>\n<li>æµ‹è¯•ç¯å¢ƒ</li>\n<li>é¢„å‘å¸ƒç¯å¢ƒ</li>\n<li>ç”Ÿäº§ç¯å¢ƒ</li>\n</ul><p>ä¸ºäº†è®©ä¸åŒèŒè´£çš„äººå‘˜åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹ç‹¬ç«‹å·¥ä½œï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†ä¸åŒç¯å¢ƒéš”ç¦»ã€‚é€šå¸¸ï¼Œå¼€å‘ç¯å¢ƒä¸»è¦ç”¨äºå¼€å‘äººå‘˜çš„æ—¥å¸¸å¼€å‘ï¼Œæµ‹è¯•ç¯å¢ƒåˆ™æ˜¯ä¸ºæµ‹è¯•å›¢é˜Ÿè€Œå‡†å¤‡çš„ï¼Œé¢„å‘å¸ƒæ˜¯æ­£å¼å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰çš„æœ€åä¸€é“é˜²çº¿ï¼Œé™¤äº†æ•°æ®ä»¥å¤–ï¼Œåº”è¯¥å°½é‡å’Œç”Ÿäº§ç¯å¢ƒä¿æŒä¸€è‡´ã€‚</p><p>å½“ç„¶ï¼Œå¯¹æœ‰äº›å›¢é˜Ÿæ¥è¯´ï¼Œä»–ä»¬å¯èƒ½è¿˜å¸Œæœ›å¼€å‘äººå‘˜ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œä¹Ÿå°±æ˜¯ä¸ºæ¯ä¸€ä¸ªå¼€å‘è€…åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å¼€å‘ç¯å¢ƒï¼Œä½¿ä»–ä»¬äº’ä¸å¹²æ‰°ã€‚</p><p>åœ¨éäº‘åŸç”ŸæŠ€æœ¯æ¶æ„ä½“ç³»ä¸‹ï¼Œç¯å¢ƒä¸€èˆ¬æ˜¯ç”±ç‰¹å®šçš„å›¢é˜Ÿäººå·¥ç»´æŠ¤çš„ã€‚æ‰€ä»¥ï¼Œè¦æƒ³å¾—åˆ°ä¸€ä¸ªæ–°çš„ç¯å¢ƒï¼Œç”±äºæ–‡æ¡£å’ŒæŠ€æœ¯æ–¹é¢çš„åŸå› ï¼Œè¿‡ç¨‹å¹¶ä¸ç®€å•ã€‚ä½†æ˜¯ï¼Œåœ¨äº‘åŸç”Ÿçš„ä¸šåŠ¡æ¶æ„ä½“ç³»ä¸‹ï¼Œåº”ç”¨æ˜¯é€šè¿‡æ ‡å‡†çš„ Kubernetes å¯¹è±¡è¢«â€œå®šä¹‰â€å‡ºæ¥çš„ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ç¯å¢ƒå°±å˜å¾—éå¸¸å®¹æ˜“äº†ã€‚</p><p>åœ¨ä¹‹å‰ä»‹ç»çš„ GitOps å·¥ä½œæµä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä»¥éƒ¨ç½²å•ä¸ªç¯å¢ƒä½œä¸ºä¾‹å­çš„ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘å¸Œæœ›ä¸ºåŒä¸€ä¸ªåº”ç”¨åˆ›å»ºæ–°çš„ç¯å¢ƒï¼Œç”šè‡³æ˜¯ä¸ºä¸åŒçš„å¼€å‘è€…åˆ›å»ºéš”ç¦»çš„å¼€å‘ç¯å¢ƒï¼Œæ€ä¹ˆåšæ‰æœ€åˆé€‚å‘¢ï¼Ÿé™¤äº†æ‰‹åŠ¨åˆ›å»ºé‡å¤çš„ ArgoCD åº”ç”¨ï¼Œè¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„æŠ€æœ¯æ–¹æ¡ˆï¼Ÿ</p><!-- [[[read_end]]] --><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ ArgoCD ApplicationSet æ¥å®ç° GitOps è‡ªåŠ¨å¤šç¯å¢ƒç®¡ç†ï¼Œå¹¶é€šè¿‡ ArgoCD Generator æ¥è¾¾åˆ°<strong>â€œä»£ç å³ç¯å¢ƒâ€</strong>çš„æ•ˆæœã€‚</p><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œä½ éœ€è¦åœ¨æœ¬åœ°çš„ Kind é›†ç¾¤å®‰è£…ä¸‹é¢ä¸¤ä¸ªç»„ä»¶ã€‚</p><ul>\n<li>å®‰è£… ArgoCDã€‚</li>\n<li>å®‰è£… Ingress-Nginxã€‚</li>\n</ul><p>æ­¤å¤–ï¼Œä½ è¿˜éœ€è¦å…‹éš†<a href=\"https://github.com/lyzhang1999/kubernetes-example\">ç¤ºä¾‹ä»“åº“</a>ï¼Œå¹¶å°†å®ƒæ¨é€åˆ°ä½ çš„ Git ä»“åº“ä¸­ã€‚</p><h2>è‡ªåŠ¨å¤šç¯å¢ƒç®¡ç†æ¦‚è¿°</h2><p>åœ¨æ­£å¼è¿›å…¥å®æˆ˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä½¿ç”¨ ArgoCD ApplicationSet æ¥å®ç°è‡ªåŠ¨å¤šç¯å¢ƒç®¡ç†çš„æ•´ä½“æ¶æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d4/42/d433a1023d1eb239cc21a4baf8f4a342.jpg?wh=1920x1606\" alt=\"å›¾ç‰‡\"></p><p>åœ¨è¿™å¼ æ¶æ„å›¾ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª ApplicationSet å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ª Application é›†åˆã€‚å®ƒå¯ä»¥ç”Ÿæˆ Application CRD èµ„æºï¼Œè¿›è€Œè‡ªåŠ¨åˆ›å»ºå¤šä¸ª ArgoCD åº”ç”¨ã€‚ä¸åŒåº”ç”¨å®é™…ä¸Šå°±å¯¹åº”äº†ä¸åŒçš„ç¯å¢ƒã€‚</p><p>é‚£ä¹ˆï¼ŒApplicationSet æ€ä¹ˆçŸ¥é“è¦åˆ›å»ºå‡ ä¸ª Application å¯¹è±¡å‘¢ï¼Ÿè¿™å°±éœ€è¦ç”¨åˆ° ApplicationSet Generators äº†ã€‚</p><p>ApplicationSet Generators æ˜¯ä¸€ä¸ªå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ Application å¯¹è±¡çš„ç”Ÿæˆå™¨ï¼Œå®ƒå¯ä»¥é€šè¿‡éå† Git ä»“åº“ä¸­çš„ç›®å½•æ¥å†³å®šç”Ÿæˆå‡ ä¸ª Application å¯¹è±¡ã€‚è¿™ä¹ˆè¯´æœ‰ç‚¹æŠ½è±¡ï¼Œä½ å¯ä»¥ç»“åˆä¸‹é¢è¿™å¼ å›¾æ¥è¿›ä¸€æ­¥ç†è§£ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/75/5b/75d5b27fc07dcd5192e2e118d51b3f5b.jpg?wh=1920x1227\" alt=\"å›¾ç‰‡\"></p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ª Helm åº”ç”¨çš„ Git ä»“åº“ï¼Œenv ç›®å½•ä¸‹å­˜æ”¾äº†ä¸åŒç¯å¢ƒçš„ values.yaml é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆï¼ŒApplicationSet Generators å°±å¯ä»¥éå†è¿™äº›ç›®å½•ï¼Œå¹¶ä¸”è‡ªåŠ¨åˆ›å»ºä¸åŒç¯å¢ƒçš„ Application å¯¹è±¡ï¼Œè¿™æ ·å°±å®ç°äº†ç›®å½•å’Œç¯å¢ƒçš„æ˜ å°„å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ç¯å¢ƒæ—¶ï¼Œ<strong>åªéœ€è¦åˆ›å»ºä¸€ä¸ªç›®å½•ä»¥åŠé…ç½®æ–‡ä»¶ values.yaml å°±å¯ä»¥äº†ï¼</strong></p><p>è¿™æ ·ï¼Œä¸ç®¡æ˜¯ä¸ºåŒä¸€ä¸ªåº”ç”¨åˆ›å»ºä¸åŒçš„ç¯å¢ƒï¼Œè¿˜æ˜¯ä¸ºä¸åŒçš„å¼€å‘è€…åˆ›å»ºéš”ç¦»çš„å¼€å‘ç¯å¢ƒï¼Œéƒ½å¯ä»¥æŠŠåˆ›å»ºç¯å¢ƒç­‰åŒäºåˆ›å»ºç›®å½•ï¼Œå®ç°äº†<strong>â€œä»£ç å³ç¯å¢ƒâ€</strong>ã€‚</p><h2>è‡ªåŠ¨å¤šç¯å¢ƒç®¡ç†å®æˆ˜</h2><p>åœ¨å®é™…åˆ›å»º ApplicationSet å¯¹è±¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹<a href=\"https://github.com/lyzhang1999/kubernetes-example\">ç¤ºä¾‹ä»“åº“</a>ã€‚ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™èŠ‚è¯¾æ‰€éœ€è¦ç”¨åˆ°çš„ç¤ºä¾‹åº”ç”¨åœ¨ helm-env ç›®å½•ä¸‹ã€‚</p><h3>ç¤ºä¾‹åº”ç”¨ç®€ä»‹</h3><p>åœ¨å°†ç¤ºä¾‹åº”ç”¨å…‹éš†åˆ°æœ¬åœ°ä¹‹åï¼Œè¿›å…¥ helm-env ç›®å½•ï¼Œå®ƒçš„ç›®å½•ç»“æ„æ˜¯ä¸‹é¢è¿™æ ·çš„ã€‚</p><pre><code class=\"language-yaml\">.\nâ”œâ”€â”€ Chart.yaml\nâ”œâ”€â”€ applicationset.yaml\nâ”œâ”€â”€ env\nâ”‚&nbsp; &nbsp;â”œâ”€â”€ dev\nâ”‚&nbsp; &nbsp;â”‚&nbsp; &nbsp;â””â”€â”€ values.yaml\nâ”‚&nbsp; &nbsp;â”œâ”€â”€ prod\nâ”‚&nbsp; &nbsp;â”‚&nbsp; &nbsp;â””â”€â”€ values.yaml\nâ”‚&nbsp; &nbsp;â””â”€â”€ test\nâ”‚&nbsp; &nbsp; &nbsp; &nbsp;â””â”€â”€ values.yaml\nâ””â”€â”€ templates\n&nbsp; &nbsp; â”œâ”€â”€ frontend.yaml\n&nbsp; &nbsp; â””â”€â”€ ingress.yaml\n</code></pre><p>ä»å®ƒçš„ç›®å½•ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œå®ƒç”± Chart.yamlã€applicationset.yamlã€env ç›®å½•å’Œ templates ç›®å½•ç»„æˆï¼Œç†Ÿæ‚‰ Helm çš„åŒå­¦åº”è¯¥ä¸€çœ¼å°±èƒ½çœ‹å‡ºï¼Œå…¶å®å®ƒæ˜¯ä¸€ä¸ª Helm Chartã€‚ä¸åŒçš„æ˜¯ï¼ŒHelm çš„é…ç½®æ–‡ä»¶ values.yaml å¹¶æ²¡æœ‰æ”¾åœ¨ Chart çš„æ ¹ç›®å½•ï¼Œè€Œæ˜¯æ”¾åœ¨äº† env ç›®å½•ä¸‹ã€‚</p><p>templates ç›®å½•å­˜æ”¾ç€ç¤ºä¾‹åº”ç”¨çš„ Kubernetes å¯¹è±¡ï¼Œä¸ºäº†ç®€åŒ–æ¼”ç¤ºè¿‡ç¨‹ï¼Œè¿™èŠ‚è¯¾æˆ‘ä»¬åªéƒ¨ç½²å‰ç«¯ç›¸å…³çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ frontend.yamlã€‚</p><p>æ­¤å¤–ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹åº”ç”¨ä¸­ï¼Œingress.yaml ä¼šç”¨æ¥éƒ¨ç½² Ingress å¯¹è±¡ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ã€‚</p><pre><code class=\"language-yaml\">apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: frontend\n  annotations:\n    kubernetes.io/ingress.class: nginx\nspec:\n  rules:\n    - host: {{ .Release.Namespace }}.env.my\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: frontend-service\n                port:\n                  number: 3000\n</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘åœ¨ Ingress å¯¹è±¡ä¸­ä½¿ç”¨äº† Helm çš„å†…ç½®å˜é‡ï¼Œä¹Ÿå°±æ˜¯ Release.Namespaceï¼Œå®ƒå®é™…ä¸ŠæŒ‡çš„æ˜¯ Helm Chart éƒ¨ç½²çš„å‘½åç©ºé—´ï¼Œæˆ‘æŠŠå®ƒå’ŒåŸŸååšäº†æ‹¼æ¥ã€‚åœ¨è¿™èŠ‚è¯¾çš„ä¾‹å­ä¸­ï¼Œä¸åŒçš„ç¯å¢ƒå°†ä¼šè¢«éƒ¨ç½²åˆ°ç‹¬ç«‹çš„å‘½åç©ºé—´ä¸‹ï¼Œè¿™æ ·ä¹Ÿå°±ä½¿ä¸åŒçš„ç¯å¢ƒå…·å¤‡äº†ç‹¬ç«‹çš„è®¿é—®åŸŸåï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/d0/ac/d01250f01e623e91e0a5db1cb68a23ac.jpg?wh=1920x1302\" alt=\"å›¾ç‰‡\"></p><h3>ApplicationSet ç®€ä»‹</h3><p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹ApplicationSetã€‚ApplicationSet æ˜¯è¿™èŠ‚è¯¾ä»‹ç»çš„é‡ç‚¹ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨ç”Ÿæˆå¤šä¸ª Application å¯¹è±¡ï¼Œä¸åŒçš„ Application å¯¹è±¡å®é™…ä¸Šå¯¹åº”äº†ä¸åŒçš„ç¯å¢ƒã€‚</p><p>ç¤ºä¾‹åº”ç”¨ç›®å½•ä¸‹æœ‰ä¸€ä¸ªåä¸º applicationset.yaml çš„æ–‡ä»¶ï¼Œå®ƒå®šä¹‰äº† ApplicationSet çš„å†…å®¹ã€‚</p><pre><code class=\"language-yaml\">apiVersion: argoproj.io/v1alpha1\nkind: ApplicationSet\nmetadata:\n  name: frontend\n  namespace: argocd\nspec:\n  generators:\n  - git:\n      repoURL: \"https://github.com/lyzhang1999/kubernetes-example.git\"\n      revision: HEAD\n      files:\n      - path: \"helm-env/env/*/values.yaml\"\n  template:\n    metadata:\n      name: \"{{path.basename}}\"\n    spec:\n      project: default\n      source:\n        repoURL: \"https://github.com/lyzhang1999/kubernetes-example.git\"\n        targetRevision: HEAD\n        path: \"helm-env\"\n        helm:\n          valueFiles:\n          - \"env/{{path.basename}}/values.yaml\"\n      destination:\n        server: 'https://kubernetes.default.svc'\n        namespace: '{{path.basename}}'\n      syncPolicy:\n        automated: {}\n        syncOptions:\n          - CreateNamespace=true\n</code></pre><p>è¿™é‡Œæˆ‘ä»¬åˆ†æˆä¸¤éƒ¨åˆ†æ¥ä»‹ç»ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ spec.generatorsï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ spec.templateã€‚</p><p>Generators æŒ‡çš„æ˜¯ç”Ÿæˆå™¨ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ Git ç”Ÿæˆå™¨ï¼Œå¹¶æŒ‡å®šäº† Helm Chart ä»“åº“åœ°å€ã€‚è¯·æ³¨æ„ï¼Œ<strong>ä½ éœ€è¦å°†è¿™ä¸ªåœ°å€æ›¿æ¢ä¸ºè‡ªå·±çš„ä»“åº“åœ°å€</strong>ï¼Œå¦‚æœä»“åº“ä¸ºç§æœ‰æƒé™ï¼Œé‚£ä¹ˆè¿˜éœ€è¦åœ¨ ArgoCD æ§åˆ¶å°é…ç½®ä»“åº“çš„å‡­æ®ä¿¡æ¯ï¼Œå…·ä½“ä½ å¯ä»¥å‚è€ƒ<a href=\"https://time.geekbang.org/column/article/624572\">ç¬¬ 22 è®²</a>çš„å†…å®¹ã€‚</p><p>revision çš„å€¼çš„ HEADï¼ŒæŒ‡çš„æ˜¯è¿œç«¯æœ€æ–°ä¿®æ”¹çš„ç‰ˆæœ¬ã€‚files å­—æ®µæ˜¯é…ç½®çš„é‡ç‚¹ï¼Œå®ƒé€šè¿‡é€šé…ç¬¦â€œ*â€å·æ¥åŒ¹é… env ç›®å½•ä¸‹çš„ values.yaml æ–‡ä»¶ï¼Œå¹¶ä¸º template å­—æ®µä¸‹çš„ path å˜é‡æä¾›å€¼ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹ template å­—æ®µã€‚ä½ å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼Œtemplate å®é™…ä¸Šå°±æ˜¯åœ¨ä¸º Application é…ç½®æ¨¡æ¿ï¼Œç»“åˆç”Ÿæˆå™¨ï¼Œå®ƒèƒ½å¤ŸåŠ¨æ€ç”Ÿæˆ Application å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œmetadata.name å­—æ®µé…ç½®äº†æ¯ä¸€ä¸ª Application çš„åç§°ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œpath.basename å˜é‡å¯¹åº”ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯ env ä¸‹å­ç›®å½•çš„åç§°ï¼Œä¹Ÿå°±æ˜¯ devã€test å’Œ prodã€‚</p><p>source.repoURL å­—æ®µè¡¨ç¤º Helm Chart çš„æ¥æºä»“åº“ï¼Œ<strong>ä½ ä¹Ÿéœ€è¦å°†å®ƒæ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€</strong>ã€‚</p><p>æ­¤å¤–ï¼Œåœ¨ helm.valueFiles é‡ŒåŒæ ·ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªå˜é‡ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸ºä¸åŒçš„ç¯å¢ƒæŒ‡å®šäº†ä¸åŒçš„ values.yamlï¼Œè¿™æ ·å°±å®ç°äº†ç¯å¢ƒéš”ç¦»ã€‚</p><p>æœ€åï¼Œdestination.namespace å­—æ®µä¹Ÿä½¿ç”¨äº†å˜é‡ï¼Œå®ƒé…ç½®äº†éƒ¨ç½²åº”ç”¨çš„å‘½åç©ºé—´ã€‚</p><p>æœ€ç»ˆï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒApplicationSet ä¼šæ ¹æ®ç›®å½•ç»“æ„ç”Ÿæˆ<strong>ä¸‰ä¸ª Application å¯¹è±¡</strong>ï¼Œè€Œ Application å¯¹è±¡åˆä¼šåœ¨ä¸åŒçš„å‘½åç©ºé—´ä¸‹éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº” devã€test å’Œ prod ç¯å¢ƒã€‚</p><h3>éƒ¨ç½² ApplicationSet</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°è¯•éƒ¨ç½² ApplicationSet å¯¹è±¡ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨ kubectl apply å‘½ä»¤æ¥éƒ¨ç½²å®ƒã€‚</p><pre><code class=\"language-yaml\">$ kubectl apply -f applicationset.yaml&nbsp;\napplicationset.argoproj.io/frontend created\n</code></pre><p>éƒ¨ç½²å®Œæˆåï¼Œæ‰“å¼€ ArgoCD æ§åˆ¶å°ï¼Œä½ ä¼šçœ‹åˆ° ApplicationSet åˆ›å»ºäº†ä¸‰ä¸ªåº”ç”¨ï¼Œåç§°åˆ†åˆ«ä¸º devã€test å’Œ prodï¼Œå¹¶ä¸”å®ƒä»¬åˆ†åˆ«è¢«éƒ¨ç½²åœ¨äº†ä¸åŒçš„å‘½åç©ºé—´ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/03/b6/03cd75b21a01ed44yy6d88fb75dbd1b6.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿›å…¥ ArgoCD æ§åˆ¶å°ä¹‹å‰ï¼Œä½ éœ€è¦è¿›è¡Œç«¯å£è½¬å‘æ“ä½œï¼Œå¹¶è·å– ArgoCD admin ç™»é™†å¯†ç ï¼Œå…·ä½“æ“ä½œä½ å¯ä»¥å‚è€ƒ<a href=\"https://time.geekbang.org/column/article/624572\">ç¬¬ 22 è®²</a>ã€‚</p><p>åˆ°è¿™é‡Œï¼ŒApplicationSet å°±å·²ç»åˆ›å»ºæˆåŠŸäº†ã€‚</p><h3>è®¿é—®å¤šç¯å¢ƒ</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•è®¿é—®è¿™ä¸‰ä¸ªç¯å¢ƒã€‚</p><p>åœ¨è®¿é—®ä¹‹å‰ï¼Œä½ éœ€è¦é…ç½®ä¸‹é¢è¿™ä¸‰ä¸ª Hostsã€‚</p><pre><code class=\"language-yaml\">127.0.0.1 dev.env.my\n127.0.0.1 test.env.my\n127.0.0.1 prod.env.my\n</code></pre><p>å…·ä½“çš„é…ç½®æ–¹æ³•ä½ å¯ä»¥å‚è€ƒ<a href=\"https://time.geekbang.org/column/article/625912\">ç¬¬ 24 è®²</a>çš„å†…å®¹ã€‚</p><p>Hosts é…ç½®å®Œæˆåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•è®¿é—®<strong>å¼€å‘ç¯å¢ƒ</strong>ã€‚æ‰“å¼€æµè§ˆå™¨è®¿é—® <a href=\"http://dev.env.my\">http://dev.env.my</a> ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ä¸‹å›¾æ‰€ç¤ºçš„ç•Œé¢ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/bb/3e/bb72afa9eb288c138318b28559dcyy3e.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>ç„¶åï¼Œä½ è¿˜å¯ä»¥è®¿é—®<strong>æµ‹è¯•ç¯å¢ƒã€‚</strong>è®¿é—®é“¾æ¥ä¸º <a href=\"http://test.env.my\">http://test.env.my</a> ï¼ŒåŒæ ·åœ°ï¼Œä½ èƒ½çœ‹åˆ°ç›¸åŒçš„åº”ç”¨ç•Œé¢ï¼Œåªä¸è¿‡è¿”å›çš„å†…å®¹ä¸­å‘½åç©ºé—´æ¥æºäº§ç”Ÿäº†å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/61/84/61294eacd82773b6d36a4f1a0596e484.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±æˆåŠŸä½¿ç”¨ ApplicationSet åˆ›å»ºäº†å¤šä¸ªéš”ç¦»ç¯å¢ƒã€‚å½“æˆ‘ä»¬éœ€è¦å¯¹ä¸åŒçš„ç¯å¢ƒè¿›è¡Œæ›´æ–°æ—¶ï¼Œåªéœ€è¦æ›´æ–° env ç›®å½•ä¸‹å¯¹åº”ç¯å¢ƒçš„ values.yaml æ–‡ä»¶ï¼Œå°±å¯ä»¥è§¦å‘ ArgoCD è‡ªåŠ¨åŒæ­¥äº†ï¼Œä¸åŒç¯å¢ƒä¹‹é—´äº’ä¸å½±å“ã€‚</p><p>æ­¤å¤–ï¼Œå½“æˆ‘ä»¬éœ€è¦åˆ›å»ºæ–°çš„ç¯å¢ƒæ—¶ï¼Œåªéœ€è¦åœ¨ env ç›®å½•ä¸‹å¢åŠ ä¸€ä¸ªç›®å½•å’Œ values.yaml æ–‡ä»¶å°±å¯ä»¥äº†ï¼ŒArgoCD ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨åˆ›å»ºæ–°çš„ç¯å¢ƒã€‚</p><h2>åˆ›å»ºæ–°ç¯å¢ƒå®éªŒ</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„ç¯å¢ƒã€‚</p><p>é¦–å…ˆï¼Œåœ¨ env ç›®å½•ä¸‹åˆ›å»º staging ç›®å½•ï¼Œè¡¨ç¤ºé¢„å‘å¸ƒç¯å¢ƒã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥åˆ›å»ºå®ƒã€‚</p><pre><code class=\"language-yaml\">cd helm-env/env\nmkdir staging\n</code></pre><p>ç„¶åï¼Œå°† dev ç›®å½•ä¸‹çš„ values.yaml å¤åˆ¶åˆ° staging ç›®å½•ä¸‹ã€‚</p><pre><code class=\"language-yaml\">$ cp dev/values.yaml staging\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œå°†ä¿®æ”¹æäº¤åˆ°è¿œç«¯ä»“åº“ã€‚</p><pre><code class=\"language-yaml\">$ git add .\n$ git commit -m 'add stagign'\n$ git push origin main\n</code></pre><p>ç¨ç­‰å‡ åˆ†é’Ÿï¼ŒArgoCD å°†è‡ªåŠ¨åŒæ­¥ï¼Œå¹¶ä¸ºæˆ‘ä»¬åˆ›å»ºæ–°çš„ staging ç¯å¢ƒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/e1/7b/e130e7a9yyc0e862b7915e822db9907b.png?wh=1920x1041\" alt=\"å›¾ç‰‡\"></p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€æ¬¡åˆ›å»ºæ–°ç¯å¢ƒçš„å…¨è¿‡ç¨‹ã€‚æ€ä¹ˆæ ·ï¼Ÿåˆ›å»ºç¯å¢ƒæ˜¯ä¸æ˜¯ç¬é—´å˜å¾—éå¸¸ç®€å•ï¼Ÿ</p><h2>æ€»ç»“</h2><p>è¿™èŠ‚è¯¾ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•é€šè¿‡ ApplicationSet æ¥åˆ›å»ºå’Œç®¡ç†å¤šç¯å¢ƒã€‚åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæœ‰å¤šç¯å¢ƒçš„ä¸šåŠ¡éœ€æ±‚ï¼Œç›¸æ¯”è¾ƒä¼ ç»Ÿçš„åˆ›å»ºç¯å¢ƒçš„æ–¹å¼ï¼Œä½¿ç”¨ ApplicationSet å¤§å¤§ç®€åŒ–äº†æ‹‰èµ·ä¸€ä¸ªæ–°ç¯å¢ƒçš„è¿‡ç¨‹ã€‚</p><p>â€œä»£ç å³ç¯å¢ƒâ€å¬èµ·æ¥è™½ç„¶æ¯”è¾ƒæŠ½è±¡ï¼Œä½†å®ç°èµ·æ¥å¹¶æ²¡æœ‰è¿™ä¹ˆå›°éš¾ã€‚å€ŸåŠ©åº”ç”¨å®šä¹‰ï¼Œç»“åˆ Git ä»“åº“ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±å¯ä»¥å®ç°å¤šç¯å¢ƒç®¡ç†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¼—å¤š GitOps å¤šç¯å¢ƒç®¡ç†çš„æ–¹æ¡ˆä¸­ï¼Œä½ å¯èƒ½è¿˜ä¼šçœ‹åˆ°å¦ä¸€ç§åœ¨è¿™èŠ‚è¯¾æ²¡æœ‰ä»‹ç»çš„æ–¹æ¡ˆï¼š<strong>é€šè¿‡åˆ†æ”¯æ¥ç®¡ç†å¤šç¯å¢ƒ</strong>ã€‚</p><p>æˆ‘ä¹Ÿä¸ºä½ ç®€å•å¯¹æ¯”ä¸€ä¸‹è¿™ä¸¤ç§æ–¹å¼ã€‚å°±æˆ‘çš„ç»éªŒæ¥çœ‹ï¼Œé‡‡ç”¨å¤šåˆ†æ”¯æ¥ç®¡ç† GitOps ä¸­çš„å¤šç¯å¢ƒå¹¶ä¸èƒ½å¤Ÿå¾ˆå¥½åœ°åŒæ—¶è§£å†³å¯ç»´æŠ¤æ€§å’Œå”¯ä¸€å¯ä¿¡æºçš„é—®é¢˜ã€‚é¦–å…ˆï¼Œåˆ†æ”¯ç®¡ç†æ¨¡å‹ä¼šä½¿æˆ‘ä»¬é¢ä¸´å·®å¼‚å’Œåˆå¹¶çš„é—®é¢˜ï¼Œè¿™å¯¹é•¿æœŸç»´æŠ¤æ¥è¯´æˆæœ¬è¾ƒé«˜ï¼Œå¹¶ä¸”åœ¨æ›´æ–°ç¯å¢ƒæ—¶ï¼Œéœ€è¦åˆ‡æ¢åˆ°ä¸åŒçš„åˆ†æ”¯å»æ“ä½œï¼Œè¿™æ›´å®¹æ˜“å¯¼è‡´äººä¸ºçš„é”™è¯¯ã€‚å…¶æ¬¡ï¼Œåˆ†æ”¯çš„ç®¡ç†æ–¹å¼æ²¡æœ‰ç›®å½•ç®¡ç†æ–¹å¼æ¥å¾—ç›´è§‚ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘æ¨èä½ æŒ‰ç…§è¿™èŠ‚è¯¾çš„è®²è§£ä»¥ç›®å½•çš„æ–¹å¼æ¥ç®¡ç†ä¸åŒçš„ç¯å¢ƒã€‚</strong></p><p>å¤šç¯å¢ƒé™¤äº†å¯ä»¥ç”¨æ¥åŒºåˆ†å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¸ºæ¯ä¸€ä½å¼€å‘è€…æä¾›ç‹¬ç«‹çš„å¼€å‘ç¯å¢ƒã€‚</p><p>åœ¨è¿™èŠ‚è¯¾çš„ä¾‹å­ä¸­ï¼Œç”±äºæ‰€æœ‰ç¯å¢ƒéƒ½å…±ç”¨ Helm Chart çš„ Template ç›®å½•ï¼Œæ‰€ä»¥å¯¹äºåº”ç”¨è€Œè¨€ï¼Œæˆ‘ä»¬åªéœ€è¦ç»´æŠ¤ Template ç›®å½•å°±å¯ä»¥é—´æ¥ç®¡ç†æ‰€æœ‰çš„ç¯å¢ƒäº†ã€‚è€Œå¯¹äºä¸åŒçš„ç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¯å¢ƒç›®å½•ä¸‹çš„ values.yaml æ–‡ä»¶è¿›è¡Œå·®å¼‚åŒ–çš„é…ç½®ã€‚è¿™æ ·å°±åŒæ—¶å…¼é¡¾äº†å¯ç»´æŠ¤æ€§å’Œç¯å¢ƒçš„å·®å¼‚åŒ–é…ç½®ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æœ€åï¼Œç»™ä½ ç•™ä¸€é“æ€è€ƒé¢˜å§ã€‚</p><p>åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†ç¯å¢ƒè¿›è¡Œç¡¬éš”ç¦»ï¼Œå¹¶å°†å®ƒä»¬éƒ¨ç½²åˆ°ä¸åŒçš„é›†ç¾¤ä¸­ã€‚è¯·ä½ å°è¯•ä¿®æ”¹ ApplicationSetï¼Œè®©æ¯ä¸ªç¯å¢ƒåœ¨ä¸åŒçš„é›†ç¾¤ä¸­è¿è¡Œã€‚</p><p>æç¤ºï¼šä½ éœ€è¦ä¸º ArgoCD æ·»åŠ é›†ç¾¤ï¼Œå¹¶å°† destination å­—æ®µé…ç½®ä¸ºé›†ç¾¤åç§° name æ¥ä»£æ›¿ serverï¼Œé€šè¿‡ç›®å½•åå’Œé›†ç¾¤åçš„æ˜ å°„æ¥å®ç°æœ€ç»ˆç›®æ ‡ã€‚</p><p>æ¬¢è¿ä½ ç»™æˆ‘ç•™è¨€äº¤æµè®¨è®ºï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚æˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ã€‚</p>","neighbors":{"left":{"article_title":"26ï½œç”Ÿäº§ç¨³å®šçš„ç§˜å¯†æ­¦å™¨ï¼šå¦‚ä½•å®æ–½è‡ªåŠ¨åŒ–æ¸è¿›å¼äº¤ä»˜ï¼Ÿ","id":627364},"right":{"article_title":"28ï½œå®‰å…¨æå‡ï¼šGitOps åœ¨å“ªäº›ç¯èŠ‚éœ€è¦å…³æ³¨å®‰å…¨é—®é¢˜ï¼Ÿ","id":628572}},"comments":[{"had_liked":false,"id":371505,"user_name":"é‚µæ¶µ","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"åŒ—äº¬","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1679994516,"is_pvip":false,"replies":[{"id":135570,"content":"ğŸ‘ğŸ»æ­£ç¡®ï¼Œçœ‹æ¥å·²ç»æŒæ¡äº† list gennerators ç±»å‹äº†ï¼Œèµï¼","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1679999685,"ip_address":"å¹¿ä¸œ","comment_id":371505,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æ€è€ƒé¢˜ï¼Œå°†ä¸€å¥—åº”ç”¨å®šä¹‰éƒ¨ç½²åœ¨å¤šä¸ªé›†ç¾¤ä¸­ï¼ŒApplicationSetå®šä¹‰ç¤ºä¾‹\napiVersion: argoproj.io&#47;v1alpha1\nkind: ApplicationSet\nmetadata:\n  name: echo-server\nspec:\n  generators:\n  - list:\n      elements:\n      - cluster: production\n        url: https:&#47;&#47;47.91.XX.XX:6443\n      - cluster: staging\n        url: https:&#47;&#47;47.111.XX.XX:6443\n  template:\n    metadata:\n      name: &#39;{{cluster}}-echo-server&#39;\n    spec:\n      project: default\n      source:\n        repoURL: https:&#47;&#47;code.aliyun.com&#47;shuwei.hsw&#47;echo-server.git\n        targetRevision: main\n        path: manifests&#47;directory&#47;{{cluster}}\n      destination:\n        server: &#39;{{url}}&#39;\n        namespace: multi-echo-server","like_count":2,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611264,"discussion_content":"ğŸ‘ğŸ»æ­£ç¡®ï¼Œçœ‹æ¥å·²ç»æŒæ¡äº† list gennerators ç±»å‹äº†ï¼Œèµï¼","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679999685,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":371410,"user_name":"é‚µæ¶µ","can_delete":false,"product_type":"c1","uid":1069135,"ip_address":"åŒ—äº¬","ucode":"43A16551A82F2F","user_header":"","comment_is_top":false,"comment_ctime":1679908124,"is_pvip":false,"replies":[{"id":135567,"content":"éå¸¸å¥½çš„é—®é¢˜ã€‚\nä¸¤ä¸ªé—®é¢˜éƒ½èƒ½å®ç°ï¼Œapplicationset å¯ä»¥ä¸º Deployment å·¥ä½œè´Ÿè½½å®šä¹‰ Annotations å­—æ®µï¼Œä½ åªéœ€è¦æŠŠ Image updater ç›¸å…³çš„å­—æ®µå®šä¹‰å¥½å°±èƒ½æ»¡è¶³ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1679987305,"ip_address":"å¹¿ä¸œ","comment_id":371410,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"å‡ ä¸ªé—®é¢˜ï¼š\n1. applicationset.yaml ä¸­å¯ä»¥ä½¿ç”¨ values.yaml ä¸­å®šä¹‰çš„å˜é‡å—ï¼Ÿ\n2. applicationset.yaml ä¸­å®šä¹‰çš„ application æ¨¡æ¿ï¼Œæ˜¯å¦å¯ä»¥åƒ23è®²ä»‹ç»çš„é‚£æ ·ä½¿ç”¨ ArgoCD Image Updaterï¼Ÿæ¢å¥è¯è¯´ï¼Œèƒ½åœ¨å‘ç°ç¬¦åˆallow-tagsè¿‡æ»¤æ¡ä»¶çš„æ–°ç‰ˆæœ¬çš„é•œåƒä¹‹åï¼Œæ›´æ–°å·¥ä½œè´Ÿè½½å¹¶å›å†™å„ä¸ªç¯å¢ƒçš„values.yamlå—ï¼Ÿ\n3. å¦‚æœä¸Šè¾¹ä¸¤ä¸ªé—®é¢˜éƒ½æ˜¯â€œå¯ä»¥â€çš„è¯ï¼Œä¸ªäººè®¤ä¸ºåº”è¯¥æ˜¯å¯ä»¥å®ç°â€œdevã€testã€prodç¯å¢ƒåˆ†åˆ«ä½¿ç”¨ä»ä¸åŒçš„æºç åˆ†æ”¯æ„å»ºçš„é•œåƒâ€è¿™ç§éœ€æ±‚çš„ï¼Œä½†å¦‚æœä¸Šè¾¹ä¸¤ä¸ªé—®é¢˜æ˜¯â€œä¸å¯ä»¥â€çš„è¯ï¼Œè¦å¦‚ä½•å®ç°è¿™ä¸ªéœ€æ±‚å‘¢ï¼Ÿä¸ºæ¯ä¸ªç¯å¢ƒåˆ›å»ºç‹¬ç«‹çš„gitä»“åº“ä¿å­˜è¯¥ç¯å¢ƒå¯¹åº”çš„åº”ç”¨å®šä¹‰ï¼Œè¿›è€Œä¸ºæ¯ä¸ªç¯å¢ƒå•ç‹¬åˆ›å»ºApplicationå¯¹è±¡ï¼Œè€Œä¸ä½¿ç”¨ApplicationSetï¼Ÿ","like_count":1,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":611234,"discussion_content":"éå¸¸å¥½çš„é—®é¢˜ã€‚\nä¸¤ä¸ªé—®é¢˜éƒ½èƒ½å®ç°ï¼Œapplicationset å¯ä»¥ä¸º Deployment å·¥ä½œè´Ÿè½½å®šä¹‰ Annotations å­—æ®µï¼Œä½ åªéœ€è¦æŠŠ Image updater ç›¸å…³çš„å­—æ®µå®šä¹‰å¥½å°±èƒ½æ»¡è¶³ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1679987305,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":370788,"user_name":"îŒ’","can_delete":false,"product_type":"c1","uid":1054966,"ip_address":"åŒ—äº¬","ucode":"7C1566DF59C99A","user_header":"https://static001.geekbang.org/account/avatar/00/10/18/f6/aeed67fc.jpg","comment_is_top":false,"comment_ctime":1679277149,"is_pvip":true,"replies":[{"id":135286,"content":"å‡ åä¸ªå¾®æœåŠ¡å…¶å®ä¹Ÿè¿˜å¥½ï¼Œç»“åˆåˆç†çš„ resource request å’Œ limit å¯ä»¥å®ç°èµ„æºè¶…å–ã€‚ä¸è¿‡å¯¹äºå¤§å‹çš„æœåŠ¡æ¥è¯´ï¼Œå…±ç”¨ä¸€å¥—åŸºç¡€æœåŠ¡çš„æ–¹å¼ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„æ–¹æ¡ˆã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1679279334,"ip_address":"å¹¿ä¸œ","comment_id":370788,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è¿™ç§æ–¹å¼æ„Ÿè§‰æ¯”è¾ƒé€‚åˆç‹¬ç«‹å¼€å‘æµ‹è¯•çš„æœåŠ¡ï¼Œå¦‚æœæœ‰æ¯”è¾ƒå¤šå…³è”çš„ä¸Šä¸‹æ¸¸æœåŠ¡çš„è¯ï¼Œæ„Ÿè§‰å°±ä¼šç›´æ¥æ‹‰èµ·ä¸€å¥—å¾ˆåºå¤§çš„ç¯å¢ƒï¼Œè¿™ç§æƒ…å†µæ˜¯ä¸æ˜¯å°±ä¸é€‚åˆè¿™ä¹ˆæäº†ã€‚","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":609880,"discussion_content":"å‡ åä¸ªå¾®æœåŠ¡å…¶å®ä¹Ÿè¿˜å¥½ï¼Œç»“åˆåˆç†çš„ resource request å’Œ limit å¯ä»¥å®ç°èµ„æºè¶…å–ã€‚ä¸è¿‡å¯¹äºå¤§å‹çš„æœåŠ¡æ¥è¯´ï¼Œå…±ç”¨ä¸€å¥—åŸºç¡€æœåŠ¡çš„æ–¹å¼ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„æ–¹æ¡ˆã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1679279334,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":369331,"user_name":"po","can_delete":false,"product_type":"c1","uid":1023905,"ip_address":"ä¸Šæµ·","ucode":"7DB36C278F34D7","user_header":"https://static001.geekbang.org/account/avatar/00/0f/9f/a1/d75219ee.jpg","comment_is_top":false,"comment_ctime":1677415294,"is_pvip":true,"replies":[{"id":134591,"content":"æ˜¯çš„ï¼Œæ„Ÿè°¢æŒ‡æ­£ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1677465895,"ip_address":"å¹¿ä¸œ","comment_id":369331,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"é¦–å…ˆï¼Œã€Œä¸ç”¨åˆ†æ”¯ã€ä¼šä½¿æˆ‘ä»¬é¢ä¸´å·®å¼‚å’Œåˆå¹¶çš„é—®é¢˜ï¼Œè¿™å¯¹é•¿æœŸç»´æŠ¤æ¥è¯´æˆæœ¬è¾ƒé«˜ï¼Œå¹¶ä¸”åœ¨æ›´æ–°ç¯å¢ƒæ—¶ï¼Œéœ€è¦åˆ‡æ¢åˆ°ä¸åŒçš„åˆ†æ”¯å»æ“ä½œï¼Œè¿™æ›´å®¹æ˜“å¯¼è‡´äººä¸ºçš„é”™è¯¯ã€‚å…¶æ¬¡ï¼Œåˆ†æ”¯çš„ç®¡ç†æ–¹å¼æ²¡æœ‰ç›®å½•ç®¡ç†æ–¹å¼æ¥å¾—ç›´è§‚ã€‚\n==============================\nçœ‹ä¸Šä¸‹æ–‡å†…å®¹ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ ä¸ç”¨åˆ†æ”¯ --&gt; ç”¨åˆ†æ”¯?","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":606858,"discussion_content":"æ˜¯çš„ï¼Œæ„Ÿè°¢æŒ‡æ­£ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1677465895,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":368849,"user_name":"æ©™æ±","can_delete":false,"product_type":"c1","uid":1332257,"ip_address":"åŒ—äº¬","ucode":"EC3FF10D708C9D","user_header":"https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg","comment_is_top":false,"comment_ctime":1676804856,"is_pvip":false,"replies":[{"id":134338,"content":"ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯å¯è¡Œçš„ã€‚\nç¬¬ä¸€ç§æ–¹æ¡ˆå€¼å¾—å®è·µä¸€ä¸‹ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1275456,"ctime":1676810579,"ip_address":"å¹¿ä¸œ","comment_id":368849,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"æœ‰ç§å®é™…åœºæ™¯å€ŸåŠ©applicationsetåœ¨ä¸åŒé›†ç¾¤ä¸­åˆ›å»ºäº†å„è‡ªçš„ç¯å¢ƒï¼Œæ¥ä¸‹æ¥æƒ³è¿›è¡Œé•œåƒæ›´æ–°æƒ³åˆ°ä¸¤ç§å®ç°æ–¹æ¡ˆã€‚\n1. å€ŸåŠ©images updateræ’ä»¶ï¼Œæ ¹æ®23ç« å†…å®¹æ¥çœ‹æ˜¯ä¿®æ”¹applicationèµ„æºï¼Œå½“å‰applicationæ˜¯è‡ªåŠ¨åˆ›å»ºä¸ç¡®å®šä¿®æ”¹åæ˜¯å¦ä¼šæœ‰é—®é¢˜ã€‚\n2. å°†æ‰“åŒ…æˆåŠŸåé•œåƒçš„tagæ›´æ–°åˆ°helmä»“åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯value.yamlæ–‡ä»¶ã€‚å‡è®¾ä»£ç å’Œéƒ¨ç½²æ˜¯ä¸¤ä¸ªä»“åº“ï¼Œå°±éœ€è¦åœ¨ciæœ€åé˜¶æ®µæ›´æ–°helmä»“åº“çš„value.yamlã€‚\nå¸Œæœ›è€å¸ˆèƒ½æŒ‡æ­£ä¸‹æ€è·¯æ˜¯å¦æ­£ç¡®ã€‚","like_count":0,"discussions":[{"author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":605640,"discussion_content":"ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯å¯è¡Œçš„ã€‚\nç¬¬ä¸€ç§æ–¹æ¡ˆå€¼å¾—å®è·µä¸€ä¸‹ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676810579,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":1,"child_discussions":[{"author":{"id":1332257,"avatar":"https://static001.geekbang.org/account/avatar/00/14/54/21/0bac2254.jpg","nickname":"æ©™æ±","note":"","ucode":"EC3FF10D708C9D","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1275456,"avatar":"https://static001.geekbang.org/account/avatar/00/13/76/40/791d0f5e.jpg","nickname":"ç‹ç‚œ","note":"","ucode":"B6F98A1EC06BDB","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":605642,"discussion_content":"å¥½çš„ æ„Ÿè°¢è€å¸ˆ","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676810633,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":605640,"ip_address":"åŒ—äº¬","group_id":0},"score":605642,"extra":""}]}]},{"had_liked":false,"id":394120,"user_name":"é˜¿ç”˜","can_delete":false,"product_type":"c1","uid":1057843,"ip_address":"æ–°åŠ å¡","ucode":"BC93175B70E05D","user_header":"https://static001.geekbang.org/account/avatar/00/10/24/33/bcf37f50.jpg","comment_is_top":false,"comment_ctime":1725876251,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"çœŸå®ç ”å‘æµç¨‹å¤æ‚çš„åœ°æ–¹åœ¨äºéœ€è¦æ¯ä¸ªå¼€å‘äººå‘˜ä¸€ä¸ªç¯å¢ƒï¼Œæ¯ä¸ªç‰ˆæœ¬ä¸€ä¸ªç¯å¢ƒï¼Œç¯å¢ƒä¸­çš„åº”ç”¨è¿˜éœ€è¦é½å¥—ï¼Œä¸æ˜¯ç®€å•çš„devã€sitã€uatã€prodå„ä¸€ä¸ªç¯å¢ƒã€‚è¿™ä¸ªä¸çŸ¥é“è€å¸ˆæœ‰ä»€ä¹ˆå¥½çš„å®è·µå’Œå»ºè®®ã€‚","like_count":1},{"had_liked":false,"id":369890,"user_name":"ghostwritten","can_delete":false,"product_type":"c1","uid":1308196,"ip_address":"åŒ—äº¬","ucode":"AE512F2E24A1A0","user_header":"https://static001.geekbang.org/account/avatar/00/13/f6/24/547439f1.jpg","comment_is_top":false,"comment_ctime":1678100647,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":1,"score":2,"product_id":100312001,"comment_content":"æ€»ç»“ï¼š\nGit &amp; k8s &amp; argocd &amp; ApplationSet\n1.å®‰è£… kind\n2. å®‰è£…argo\n3. å®‰è£… ingress\n4. ä¸‹è½½ kubernetes-example\n5. æ˜ç¡®helm-envåå½•\n6. å®šä¹‰ template çš„ingress.yamlã€fronted.yamlå˜é‡ï¼Œä¾‹å¦‚ï¼šå‘½åç©ºé—´ã€é•œåƒåç§°ç‰ˆæœ¬\n7. é‡ç‚¹ç†è§£applationset.yamlçš„å‚æ•°å®šä¹‰\n\næ‰©å±•ï¼šhttps:&#47;&#47;argo-cd.readthedocs.io&#47;en&#47;stable&#47;\nArgocd ApplationSetæœ‰ä»¥ä¸‹Generatorï¼š\n- List Generator ï¼ˆå®ç°å¤šé›†ç¾¤ï¼‰\n- Cluster Generator\n- Git Generator\n- Matrix generator\nç©æ³•å¤šå¤š\n\né—®é¢˜ï¼š\nArgoCD + ApplationSet VS ArgoCD +kustomize å¤šç¯å¢ƒï¼ˆå¤šé›†ç¾¤å¤šç©ºé—´ï¼‰è°æ›´å‡ºè‰²ï¼Ÿ","like_count":1},{"had_liked":false,"id":383706,"user_name":"bingo","can_delete":false,"product_type":"c1","uid":1880434,"ip_address":"å‰æ—","ucode":"B78AEBC15F9456","user_header":"https://thirdwx.qlogo.cn/mmopen/vi_32/0yFVUquLaq9HdHr0qjegD612UqJqLmCCekDGQDWJF3a7kbYWicLIJ6QLViaZqqKprekfDXsZX0qYgBX7JVDxPwoic9DGrHTBZaUtE3j6Y4MznM/132","comment_is_top":false,"comment_ctime":1699499107,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100312001,"comment_content":"è€å¸ˆæ‚¨å¥½ï¼Œè¯·é—®å¦‚ä½•åœ¨gitopsæµç¨‹ä¸­å¼•å…¥åˆ¶å“æ™‹çº§çš„æœºåˆ¶ï¼Œæ¯”å¦‚ä¸åŒç¯å¢ƒçš„å‘å¸ƒéœ€è¦å…ˆåœ¨å¼€å‘ç¯å¢ƒéªŒè¯è¿‡å†å‘æµ‹è¯•ï¼Œæµ‹è¯•éªŒè¯è¿‡å†å‘ç”Ÿäº§ç¯å¢ƒï¼Ÿ","like_count":0}]}