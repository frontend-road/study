{"id":410666,"title":"13 | Redis 6.0å¤šIOçº¿ç¨‹çš„æ•ˆç‡æé«˜äº†å—ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯è’‹å¾·é’§ã€‚</p><p>é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“Redis serverå¯åŠ¨åçš„è¿›ç¨‹ä¼šä»¥å•çº¿ç¨‹çš„æ–¹å¼ï¼Œæ‰§è¡Œå®¢æˆ·ç«¯è¯·æ±‚è§£æå’Œå¤„ç†å·¥ä½œã€‚ä½†æ˜¯ï¼ŒRedis serverä¹Ÿä¼šé€šè¿‡bioInitå‡½æ•°å¯åŠ¨ä¸‰ä¸ªåå°çº¿ç¨‹ï¼Œæ¥å¤„ç†åå°ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒRedisä¸å†è®©ä¸»çº¿ç¨‹æ‰§è¡Œä¸€äº›è€—æ—¶æ“ä½œï¼Œæ¯”å¦‚åŒæ­¥å†™ã€åˆ é™¤ç­‰ï¼Œè€Œæ˜¯äº¤ç»™åå°çº¿ç¨‹å¼‚æ­¥å®Œæˆï¼Œä»è€Œé¿å…äº†å¯¹ä¸»çº¿ç¨‹çš„é˜»å¡ã€‚</p><p>å®é™…ä¸Šï¼Œåœ¨2020å¹´5æœˆæ¨å‡ºçš„Redis 6.0ç‰ˆæœ¬ä¸­ï¼ŒRedisåœ¨æ‰§è¡Œæ¨¡å‹ä¸­è¿˜è¿›ä¸€æ­¥ä½¿ç”¨äº†å¤šçº¿ç¨‹æ¥å¤„ç†IOä»»åŠ¡ï¼Œè¿™æ ·è®¾è®¡çš„ç›®çš„ï¼Œå°±æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨å½“å‰æœåŠ¡å™¨çš„å¤šæ ¸ç‰¹æ€§ï¼Œä½¿ç”¨å¤šæ ¸è¿è¡Œå¤šçº¿ç¨‹ï¼Œè®©å¤šçº¿ç¨‹å¸®åŠ©åŠ é€Ÿæ•°æ®è¯»å–ã€å‘½ä»¤è§£æä»¥åŠæ•°æ®å†™å›çš„é€Ÿåº¦ï¼Œæå‡Redisæ•´ä½“æ€§èƒ½ã€‚</p><p><strong>é‚£ä¹ˆï¼Œè¿™äº›å¤šçº¿ç¨‹å…·ä½“æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å¯åŠ¨ï¼Œåˆæ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥å¤„ç†IOè¯·æ±‚çš„å‘¢ï¼Ÿ</strong></p><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘å°±æ¥ç»™ä½ ä»‹ç»ä¸‹Redis 6.0å®ç°çš„å¤šIOçº¿ç¨‹æœºåˆ¶ã€‚é€šè¿‡è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ ï¼Œä½ å¯ä»¥å……åˆ†äº†è§£åˆ°Redis 6.0æ˜¯å¦‚ä½•é€šè¿‡å¤šçº¿ç¨‹æ¥æå‡IOè¯·æ±‚å¤„ç†æ•ˆç‡çš„ã€‚è¿™æ ·ä½ ä¹Ÿå°±å¯ä»¥ç»“åˆå®é™…ä¸šåŠ¡æ¥è¯„ä¼°ï¼Œè‡ªå·±æ˜¯å¦éœ€è¦ä½¿ç”¨Redis 6.0äº†ã€‚</p><p>å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å¤šIOçº¿ç¨‹çš„åˆå§‹åŒ–ã€‚æ³¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰è¯¾ç¨‹ä¸­é˜…è¯»çš„æ˜¯Redis 5.0.8ç‰ˆæœ¬çš„ä»£ç ï¼Œæ‰€ä»¥åœ¨å¼€å§‹å­¦ä¹ ä»Šå¤©çš„è¯¾ç¨‹ä¹‹å‰ï¼Œä½ è¿˜éœ€è¦ä¸‹è½½<a href=\"https://github.com/redis/redis/tree/6.0\">Redis 6.0.15</a>çš„æºç ï¼Œä»¥ä¾¿èƒ½æŸ¥çœ‹åˆ°å’Œå¤šIOçº¿ç¨‹æœºåˆ¶ç›¸å…³çš„ä»£ç ã€‚</p><!-- [[[read_end]]] --><h2>å¤šIOçº¿ç¨‹çš„åˆå§‹åŒ–</h2><p>æˆ‘åœ¨ä¸Šä¸€è®²ç»™ä½ ä»‹ç»è¿‡ï¼ŒRedis 5.0ä¸­çš„ä¸‰ä¸ªåå°çº¿ç¨‹ï¼Œæ˜¯serveråœ¨åˆå§‹åŒ–è¿‡ç¨‹çš„æœ€åï¼Œè°ƒç”¨InitSeverLastå‡½æ•°ï¼Œè€ŒInitServerLastå‡½æ•°å†è¿›ä¸€æ­¥è°ƒç”¨bioInitå‡½æ•°æ¥å®Œæˆçš„ã€‚å¦‚æœæˆ‘ä»¬åœ¨Redis 6.0ä¸­æŸ¥çœ‹InitServerLastå‡½æ•°ï¼Œä¼šå‘ç°å’ŒRedis 5.0ç›¸æ¯”ï¼Œè¯¥å‡½æ•°åœ¨è°ƒå®ŒbioInitå‡½æ•°åï¼Œåˆè°ƒç”¨äº†<strong>initThreadedIOå‡½æ•°</strong>ã€‚è€ŒinitThreadedIOå‡½æ•°æ­£æ˜¯ç”¨æ¥åˆå§‹åŒ–å¤šIOçº¿ç¨‹çš„ï¼Œè¿™éƒ¨åˆ†çš„ä»£ç è°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>void InitServerLast() {\n    bioInit();\n    initThreadedIO();  //è°ƒç”¨initThreadedIOå‡½æ•°åˆå§‹åŒ–IOçº¿ç¨‹\n    set_jemalloc_bg_thread(server.jemalloc_bg_thread);\n    server.initial_memory_usage = zmalloc_used_memory();\n}\n</code></pre><p>æ‰€ä»¥ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹initThreadedIOå‡½æ•°çš„ä¸»è¦æ‰§è¡Œæµç¨‹ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨<a href=\"http://github.com/redis/redis/tree/5.0/src/networking.c\">networking.c</a>æ–‡ä»¶ä¸­å®ç°çš„ã€‚</p><p><strong>é¦–å…ˆï¼ŒinitThreadedIOå‡½æ•°ä¼šè®¾ç½®IOçº¿ç¨‹çš„æ¿€æ´»æ ‡å¿—ã€‚</strong>è¿™ä¸ªæ¿€æ´»æ ‡å¿—ä¿å­˜åœ¨redisServerç»“æ„ä½“ç±»å‹çš„å…¨å±€å˜é‡serverå½“ä¸­ï¼Œå¯¹åº”redisServerç»“æ„ä½“çš„æˆå‘˜å˜é‡io_threads_activeã€‚initThreadedIOå‡½æ•°ä¼šæŠŠio_threads_activeåˆå§‹åŒ–ä¸º0ï¼Œè¡¨ç¤ºIOçº¿ç¨‹è¿˜æ²¡æœ‰è¢«æ¿€æ´»ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>void initThreadedIO(void) {\n\tserver.io_threads_active = 0;\n\tâ€¦\n}\n</code></pre><p>è¿™é‡Œï¼Œä½ è¦æ³¨æ„ä¸€ä¸‹ï¼Œåˆšæ‰æåˆ°çš„<strong>å…¨å±€å˜é‡server</strong>æ˜¯Redis serverè¿è¡Œæ—¶ï¼Œç”¨æ¥ä¿å­˜å„ç§å…¨å±€ä¿¡æ¯çš„ç»“æ„ä½“å˜é‡ã€‚æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/406556\">ç¬¬8è®²</a>ç»™ä½ ä»‹ç»Redis serveråˆå§‹åŒ–è¿‡ç¨‹çš„æ—¶å€™ï¼Œæåˆ°è¿‡Redis serverçš„å„ç§å‚æ•°åˆå§‹åŒ–é…ç½®ï¼Œéƒ½æ˜¯ä¿å­˜åœ¨è¿™ä¸ªå…¨å±€å˜é‡serverä¸­çš„ã€‚æ‰€ä»¥ï¼Œå½“ä½ åœ¨é˜…è¯»Redisæºç æ—¶ï¼Œå¦‚æœåœ¨æŸä¸ªå‡½æ•°ä¸­çœ‹åˆ°å˜é‡serverï¼Œè¦çŸ¥é“å…¶å®å°±æ˜¯è¿™ä¸ªå…¨å±€å˜é‡ã€‚</p><p><strong>ç´§æ¥ç€ï¼ŒinitThreadedIOå‡½æ•°ä¼šå¯¹è®¾ç½®çš„IOçº¿ç¨‹æ•°é‡è¿›è¡Œåˆ¤æ–­ã€‚</strong>è¿™ä¸ªæ•°é‡å°±æ˜¯ä¿å­˜åœ¨å…¨å±€å˜é‡serverçš„æˆå‘˜å˜é‡io_threads_numä¸­çš„ã€‚é‚£ä¹ˆåœ¨è¿™é‡Œï¼ŒIOçº¿ç¨‹çš„æ•°é‡åˆ¤æ–­ä¼šæœ‰ä¸‰ç§ç»“æœã€‚</p><p>ç¬¬ä¸€ç§ï¼Œå¦‚æœIOçº¿ç¨‹æ•°é‡ä¸º1ï¼Œå°±è¡¨ç¤ºåªæœ‰1ä¸ªä¸»IOçº¿ç¨‹ï¼ŒinitThreadedIOå‡½æ•°å°±ç›´æ¥è¿”å›äº†ã€‚æ­¤æ—¶ï¼ŒRedis serverçš„IOçº¿ç¨‹å’ŒRedis 6.0ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯ç›¸åŒçš„ã€‚</p><pre><code>if (server.io_threads_num == 1) return;\n</code></pre><p>ç¬¬äºŒç§ï¼Œå¦‚æœIOçº¿ç¨‹æ•°é‡å¤§äºå®å®šä¹‰IO_THREADS_MAX_NUMï¼ˆé»˜è®¤å€¼ä¸º128ï¼‰ï¼Œé‚£ä¹ˆinitThreadedIOå‡½æ•°ä¼šæŠ¥é”™ï¼Œå¹¶é€€å‡ºæ•´ä¸ªç¨‹åºã€‚</p><pre><code>if (server.io_threads_num &gt; IO_THREADS_MAX_NUM) {\n        â€¦  //æŠ¥é”™æ—¥å¿—è®°å½•\n        exit(1);  //é€€å‡ºç¨‹åº\n }\n</code></pre><p>ç¬¬ä¸‰ç§ï¼Œå¦‚æœIOçº¿ç¨‹æ•°é‡å¤§äº1ï¼Œå¹¶ä¸”å°äºå®å®šä¹‰IO_THREADS_MAX_NUMï¼Œé‚£ä¹ˆï¼ŒinitThreadedIOå‡½æ•°ä¼šæ‰§è¡Œä¸€ä¸ªå¾ªç¯æµç¨‹ï¼Œè¯¥æµç¨‹çš„å¾ªç¯æ¬¡æ•°å°±æ˜¯è®¾ç½®çš„IOçº¿ç¨‹æ•°é‡ã€‚</p><p>å¦‚æ­¤ä¸€æ¥ï¼Œåœ¨è¯¥å¾ªç¯æµç¨‹ä¸­ï¼ŒinitThreadedIOå‡½æ•°å°±ä¼šç»™ä»¥ä¸‹å››ä¸ªæ•°ç»„è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><ul>\n<li><strong>io_threads_listæ•°ç»„</strong>ï¼šä¿å­˜äº†æ¯ä¸ªIOçº¿ç¨‹è¦å¤„ç†çš„å®¢æˆ·ç«¯ï¼Œå°†æ•°ç»„æ¯ä¸ªå…ƒç´ åˆå§‹åŒ–ä¸ºä¸€ä¸ªListç±»å‹çš„åˆ—è¡¨ï¼›</li>\n<li><strong>io_threads_pendingæ•°ç»„</strong>ï¼šä¿å­˜ç­‰å¾…æ¯ä¸ªIOçº¿ç¨‹å¤„ç†çš„å®¢æˆ·ç«¯ä¸ªæ•°ï¼›</li>\n<li><strong>io_threads_mutexæ•°ç»„</strong>ï¼šä¿å­˜çº¿ç¨‹äº’æ–¥é”ï¼›</li>\n<li><strong>io_threadsæ•°ç»„</strong>ï¼šä¿å­˜æ¯ä¸ªIOçº¿ç¨‹çš„æè¿°ç¬¦ã€‚</li>\n</ul><p>è¿™å››ä¸ªæ•°ç»„çš„å®šä¹‰éƒ½åœ¨networking.cæ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>pthread_t io_threads[IO_THREADS_MAX_NUM];   //è®°å½•çº¿ç¨‹æè¿°ç¬¦çš„æ•°ç»„\npthread_mutex_t io_threads_mutex[IO_THREADS_MAX_NUM];  //è®°å½•çº¿ç¨‹äº’æ–¥é”çš„æ•°ç»„\n_Atomic unsigned long io_threads_pending[IO_THREADS_MAX_NUM];  //è®°å½•çº¿ç¨‹å¾…å¤„ç†çš„å®¢æˆ·ç«¯ä¸ªæ•°\nlist *io_threads_list[IO_THREADS_MAX_NUM];  //è®°å½•çº¿ç¨‹å¯¹åº”å¤„ç†çš„å®¢æˆ·ç«¯\n</code></pre><p>ç„¶åï¼Œåœ¨å¯¹è¿™äº›æ•°ç»„è¿›è¡Œåˆå§‹åŒ–çš„åŒæ—¶ï¼ŒinitThreadedIOå‡½æ•°è¿˜ä¼šæ ¹æ®IOçº¿ç¨‹æ•°é‡ï¼Œ<strong>è°ƒç”¨pthread_createå‡½æ•°åˆ›å»ºç›¸åº”æ•°é‡çš„çº¿ç¨‹</strong>ã€‚æˆ‘åœ¨ä¸ŠèŠ‚è¯¾ç»™ä½ ä»‹ç»è¿‡ï¼Œpthread_createå‡½æ•°çš„å‚æ•°åŒ…æ‹¬åˆ›å»ºçº¿ç¨‹è¦è¿è¡Œçš„å‡½æ•°å’Œå‡½æ•°å‚æ•°ï¼ˆ*tidpã€*attrã€*start_routineã€*argï¼‰ã€‚</p><p>æ‰€ä»¥ï¼Œå¯¹äºinitThreadedIOå‡½æ•°æ¥è¯´ï¼Œå®ƒåˆ›å»ºçš„çº¿ç¨‹è¦è¿è¡Œçš„å‡½æ•°æ˜¯<strong>IOThreadMain</strong>ï¼Œå‚æ•°æ˜¯å½“å‰åˆ›å»ºçº¿ç¨‹çš„ç¼–å·ã€‚ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç¼–å·æ˜¯ä»1å¼€å§‹çš„ï¼Œç¼–å·ä¸º0çš„çº¿ç¨‹å…¶å®æ˜¯è¿è¡ŒRedis serverä¸»æµç¨‹çš„ä¸»IOçº¿ç¨‹ã€‚</p><p>ä»¥ä¸‹ä»£ç å°±å±•ç¤ºäº†initThreadedIOå‡½æ•°å¯¹æ•°ç»„çš„åˆå§‹åŒ–ï¼Œä»¥åŠåˆ›å»ºIOçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>for (int i = 0; i &lt; server.io_threads_num; i++) {\n \n        io_threads_list[i] = listCreate();\n        if (i == 0) continue; //ç¼–å·ä¸º0çš„çº¿ç¨‹æ˜¯ä¸»IOçº¿ç¨‹\n \n        pthread_t tid;\n        pthread_mutex_init(&amp;io_threads_mutex[i],NULL);  //åˆå§‹åŒ–io_threads_mutexæ•°ç»„\n        io_threads_pending[i] = 0;   //åˆå§‹åŒ–io_threads_pendingæ•°ç»„\n        pthread_mutex_lock(&amp;io_threads_mutex[i]);\n        //è°ƒç”¨pthread_createå‡½æ•°åˆ›å»ºIOçº¿ç¨‹ï¼Œçº¿ç¨‹è¿è¡Œå‡½æ•°ä¸ºIOThreadMain\n        if (pthread_create(&amp;tid,NULL,IOThreadMain,(void*)(long)i) != 0) {\n            â€¦ //å‡ºé”™å¤„ç†\n        }\n        io_threads[i] = tid;  //åˆå§‹åŒ–io_threadsæ•°ç»„ï¼Œè®¾ç½®å€¼ä¸ºçº¿ç¨‹æ ‡è¯†\n    }\n</code></pre><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼Œåˆšæ‰ä»‹ç»çš„IOçº¿ç¨‹å¯åŠ¨åè¦è¿è¡Œçš„å‡½æ•°IOThreadMainã€‚äº†è§£è¿™ä¸ªå‡½æ•°ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æŒæ¡IOçº¿ç¨‹å®é™…åšçš„å·¥ä½œã€‚</p><h2>IOçº¿ç¨‹çš„è¿è¡Œå‡½æ•°IOThreadMain</h2><p>IOThreadMainå‡½æ•°ä¹Ÿæ˜¯åœ¨networking.cæ–‡ä»¶ä¸­å®šä¹‰çš„ï¼Œå®ƒçš„ä¸»è¦æ‰§è¡Œé€»è¾‘æ˜¯ä¸€ä¸ª<strong>while(1)å¾ªç¯</strong>ã€‚åœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼ŒIOThreadMainå‡½æ•°ä¼šæŠŠio_threads_listæ•°ç»„ä¸­ï¼Œæ¯ä¸ªIOçº¿ç¨‹å¯¹åº”çš„åˆ—è¡¨è¯»å–å‡ºæ¥ã€‚</p><p>å°±åƒæˆ‘åœ¨å‰é¢ç»™ä½ ä»‹ç»çš„ä¸€æ ·ï¼Œio_threads_listæ•°ç»„ä¸­ä¼šé’ˆå¯¹æ¯ä¸ªIOçº¿ç¨‹ï¼Œä½¿ç”¨ä¸€ä¸ªåˆ—è¡¨è®°å½•è¯¥çº¿ç¨‹è¦å¤„ç†çš„å®¢æˆ·ç«¯ã€‚æ‰€ä»¥ï¼ŒIOThreadMainå‡½æ•°å°±ä¼šä»æ¯ä¸ªIOçº¿ç¨‹å¯¹åº”çš„åˆ—è¡¨ä¸­ï¼Œè¿›ä¸€æ­¥å–å‡ºè¦å¤„ç†çš„å®¢æˆ·ç«¯ï¼Œç„¶ååˆ¤æ–­çº¿ç¨‹è¦æ‰§è¡Œçš„æ“ä½œæ ‡è®°ã€‚è¿™ä¸ªæ“ä½œæ ‡è®°æ˜¯ç”¨å˜é‡io_threads_opè¡¨ç¤ºçš„ï¼Œå®ƒæœ‰ä¸¤ç§å–å€¼ã€‚</p><ul>\n<li><strong>io_threads_opçš„å€¼ä¸ºå®å®šä¹‰IO_THREADS_OP_WRITE</strong>ï¼šè¿™è¡¨æ˜è¯¥IOçº¿ç¨‹è¦åšçš„æ˜¯å†™æ“ä½œï¼Œçº¿ç¨‹ä¼šè°ƒç”¨writeToClientå‡½æ•°å°†æ•°æ®å†™å›å®¢æˆ·ç«¯ã€‚</li>\n<li><strong>io_threads_opçš„å€¼ä¸ºå®å®šä¹‰IO_THREADS_OP_READ</strong>ï¼šè¿™è¡¨æ˜è¯¥IOçº¿ç¨‹è¦åšçš„æ˜¯è¯»æ“ä½œï¼Œçº¿ç¨‹ä¼šè°ƒç”¨readQueryFromClientå‡½æ•°ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ã€‚</li>\n</ul><p>è¿™éƒ¨åˆ†çš„ä»£ç é€»è¾‘ä½ å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p><pre><code>void *IOThreadMain(void *myid) {\nâ€¦\nwhile(1) {\n   listIter li;\n   listNode *ln;\n   //è·å–IOçº¿ç¨‹è¦å¤„ç†çš„å®¢æˆ·ç«¯åˆ—è¡¨\n   listRewind(io_threads_list[id],&amp;li);\n   while((ln = listNext(&amp;li))) {\n      client *c = listNodeValue(ln); //ä»å®¢æˆ·ç«¯åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªå®¢æˆ·ç«¯\n      if (io_threads_op == IO_THREADS_OP_WRITE) {\n         writeToClient(c,0);  //å¦‚æœçº¿ç¨‹æ“ä½œæ˜¯å†™æ“ä½œï¼Œåˆ™è°ƒç”¨writeToClientå°†æ•°æ®å†™å›å®¢æˆ·ç«¯\n       } else if (io_threads_op == IO_THREADS_OP_READ) {\n          readQueryFromClient(c-&gt;conn); //å¦‚æœçº¿ç¨‹æ“ä½œæ˜¯è¯»æ“ä½œï¼Œåˆ™è°ƒç”¨readQueryFromClientä»å®¢æˆ·ç«¯è¯»å–æ•°æ®\n       } else {\n          serverPanic(&quot;io_threads_op value is unknown&quot;);\n       }\n   }\n   listEmpty(io_threads_list[id]); //å¤„ç†å®Œæ‰€æœ‰å®¢æˆ·ç«¯åï¼Œæ¸…ç©ºè¯¥çº¿ç¨‹çš„å®¢æˆ·ç«¯åˆ—è¡¨\n   io_threads_pending[id] = 0; //å°†è¯¥çº¿ç¨‹çš„å¾…å¤„ç†ä»»åŠ¡æ•°é‡è®¾ç½®ä¸º0\n \n   }\n}\n</code></pre><p>æˆ‘ä¹Ÿç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œå±•ç¤ºäº†IOThreadMainå‡½æ•°çš„åŸºæœ¬æµç¨‹ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/03/5a/03232ff01d8b0fca4af0981b7097495a.jpg?wh=2000x1125\" alt=\"\"></p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œä½ åº”è¯¥å°±äº†è§£äº†ï¼Œæ¯ä¸€ä¸ªIOçº¿ç¨‹è¿è¡Œæ—¶ï¼Œéƒ½ä¼šä¸æ–­æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…å®ƒå¤„ç†çš„å®¢æˆ·ç«¯ã€‚å¦‚æœæœ‰ï¼Œå°±æ ¹æ®æ“ä½œç±»å‹ï¼Œä»å®¢æˆ·ç«¯è¯»å–æ•°æ®æˆ–æ˜¯å°†æ•°æ®å†™å›å®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯Redisè¦å’Œå®¢æˆ·ç«¯å®Œæˆçš„IOæ“ä½œï¼Œæ‰€ä»¥ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æŠŠè¿™äº›çº¿ç¨‹ç§°ä¸ºIOçº¿ç¨‹çš„åŸå› ã€‚</p><p>é‚£ä¹ˆï¼Œä½ çœ‹åˆ°è¿™é‡Œï¼Œå¯èƒ½ä¹Ÿä¼šäº§ç”Ÿä¸€äº›ç–‘é—®ï¼Œ<strong>IOçº¿ç¨‹è¦å¤„ç†çš„å®¢æˆ·ç«¯æ˜¯å¦‚ä½•æ·»åŠ åˆ°io_threads_listæ•°ç»„ä¸­çš„å‘¢ï¼Ÿ</strong></p><p>è¿™å°±è¦è¯´åˆ°Redis serverå¯¹åº”çš„å…¨å±€å˜é‡serveräº†ã€‚serverå˜é‡ä¸­æœ‰ä¸¤ä¸ªListç±»å‹çš„æˆå‘˜å˜é‡ï¼šclients_pending_writeå’Œclients_pending_readï¼Œå®ƒä»¬åˆ†åˆ«è®°å½•äº†å¾…å†™å›æ•°æ®çš„å®¢æˆ·ç«¯å’Œå¾…è¯»å–æ•°æ®çš„å®¢æˆ·ç«¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>struct redisServer {\n...\nlist *clients_pending_write;  //å¾…å†™å›æ•°æ®çš„å®¢æˆ·ç«¯\nlist *clients_pending_read;  //å¾…è¯»å–æ•°æ®çš„å®¢æˆ·ç«¯\n...\n}\n</code></pre><p>ä½ è¦çŸ¥é“ï¼ŒRedis serveråœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚å’Œç»™å®¢æˆ·ç«¯è¿”å›æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ ¹æ®ä¸€å®šæ¡ä»¶ï¼Œæ¨è¿Ÿå®¢æˆ·ç«¯çš„è¯»å†™æ“ä½œï¼Œå¹¶åˆ†åˆ«æŠŠå¾…è¯»å†™çš„å®¢æˆ·ç«¯ä¿å­˜åˆ°è¿™ä¸¤ä¸ªåˆ—è¡¨ä¸­ã€‚ç„¶åï¼ŒRedis serveråœ¨æ¯æ¬¡è¿›å…¥äº‹ä»¶å¾ªç¯å‰ï¼Œä¼šå†æŠŠåˆ—è¡¨ä¸­çš„å®¢æˆ·ç«¯æ·»åŠ åˆ°io_threads_listæ•°ç»„ä¸­ï¼Œäº¤ç»™IOçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚</p><p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸‹ï¼ŒRedisæ˜¯å¦‚ä½•æ¨è¿Ÿå®¢æˆ·ç«¯çš„è¯»å†™æ“ä½œï¼Œå¹¶æŠŠè¿™äº›å®¢æˆ·ç«¯æ·»åŠ åˆ°clients_pending_writeå’Œclients_pending_readè¿™ä¸¤ä¸ªåˆ—è¡¨ä¸­çš„ã€‚</p><h2>å¦‚ä½•æ¨è¿Ÿå®¢æˆ·ç«¯è¯»æ“ä½œï¼Ÿ</h2><p>Redis serveråœ¨å’Œä¸€ä¸ªå®¢æˆ·ç«¯å»ºç«‹è¿æ¥åï¼Œå°±ä¼šå¼€å§‹ç›‘å¬è¿™ä¸ªå®¢æˆ·ç«¯ä¸Šçš„å¯è¯»äº‹ä»¶ï¼Œè€Œå¤„ç†å¯è¯»äº‹ä»¶çš„å›è°ƒå‡½æ•°æ˜¯<strong>readQueryFromClient</strong>ã€‚æˆ‘åœ¨<a href=\"https://time.geekbang.org/column/article/408857\">ç¬¬11è®²</a>ä¸­ç»™ä½ ä»‹ç»äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œä½ å¯ä»¥å†å»å›é¡¾ä¸‹ã€‚</p><p>é‚£ä¹ˆè¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹Redis 6.0ç‰ˆæœ¬ä¸­çš„readQueryFromClientå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¸€å¼€å§‹ä¼šå…ˆä»ä¼ å…¥å‚æ•°connä¸­è·å–å®¢æˆ·ç«¯cï¼Œç´§æ¥ç€å°±è°ƒç”¨postponeClientReadå‡½æ•°ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ¨è¿Ÿä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ã€‚è¿™éƒ¨åˆ†çš„æ‰§è¡Œé€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>void readQueryFromClient(connection *conn) {\n    client *c = connGetPrivateData(conn);  //ä»è¿æ¥æ•°æ®ç»“æ„ä¸­è·å–å®¢æˆ·\n    ...\n    if (postponeClientRead(c)) return;  //åˆ¤æ–­æ˜¯å¦æ¨è¿Ÿä»å®¢æˆ·ç«¯è¯»å–æ•°æ®\n    ...\n}\n</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹<strong>postponeClientReadå‡½æ•°</strong>çš„æ‰§è¡Œé€»è¾‘ã€‚è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®å››ä¸ªæ¡ä»¶åˆ¤æ–­èƒ½å¦æ¨è¿Ÿä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ã€‚</p><p><strong>æ¡ä»¶ä¸€ï¼šå…¨å±€å˜é‡serverçš„io_threads_activeå€¼ä¸º1</strong></p><p>è¿™è¡¨ç¤ºå¤šIOçº¿ç¨‹å·²ç»æ¿€æ´»ã€‚æˆ‘åˆšæ‰è¯´è¿‡ï¼Œè¿™ä¸ªå˜é‡å€¼åœ¨initThreadedIOå‡½æ•°ä¸­æ˜¯ä¼šè¢«åˆå§‹åŒ–ä¸º0çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šIOçº¿ç¨‹åˆå§‹åŒ–åï¼Œé»˜è®¤è¿˜æ²¡æœ‰æ¿€æ´»ï¼ˆæˆ‘ä¸€ä¼šå„¿è¿˜ä¼šç»™ä½ ä»‹ç»è¿™ä¸ªå˜é‡å€¼ä½•æ—¶è¢«è®¾ç½®ä¸º1ï¼‰ã€‚</p><p><strong>æ¡ä»¶äºŒï¼šå…¨å±€å˜é‡serverçš„io_threads_do_readå€¼ä¸º1</strong></p><p>è¿™è¡¨ç¤ºå¤šIOçº¿ç¨‹å¯ä»¥ç”¨äºå¤„ç†å»¶åæ‰§è¡Œçš„å®¢æˆ·ç«¯è¯»æ“ä½œã€‚è¿™ä¸ªå˜é‡å€¼æ˜¯åœ¨Redisé…ç½®æ–‡ä»¶redis.confä¸­ï¼Œé€šè¿‡é…ç½®é¡¹io-threads-do-readsè®¾ç½®çš„ï¼Œé»˜è®¤å€¼ä¸ºnoï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šIOçº¿ç¨‹æœºåˆ¶é»˜è®¤å¹¶ä¸ä¼šç”¨äºå®¢æˆ·ç«¯è¯»æ“ä½œã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³ç”¨å¤šIOçº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯è¯»æ“ä½œï¼Œå°±éœ€è¦æŠŠio-threads-do-readsé…ç½®é¡¹è®¾ä¸ºyesã€‚</p><p><strong>æ¡ä»¶ä¸‰ï¼šProcessingEventsWhileBlockedå˜é‡å€¼ä¸º0</strong></p><p>è¿™è¡¨ç¤ºprocessEventsWhileBlokcedå‡½æ•°æ²¡æœ‰åœ¨æ‰§è¡Œã€‚ProcessingEventsWhileBlockedæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒä¼šåœ¨processEventsWhileBlokcedå‡½æ•°æ‰§è¡Œæ—¶è¢«è®¾ç½®ä¸º1ï¼Œåœ¨processEventsWhileBlokcedå‡½æ•°æ‰§è¡Œå®Œæˆæ—¶è¢«è®¾ç½®ä¸º0ã€‚</p><p>è€ŒprocessEventsWhileBlokcedå‡½æ•°æ˜¯åœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/networking.c\">networking.c</a>æ–‡ä»¶ä¸­å®ç°çš„ã€‚å½“Redisåœ¨è¯»å–RDBæ–‡ä»¶æˆ–æ˜¯AOFæ–‡ä»¶æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œç”¨æ¥å¤„ç†äº‹ä»¶é©±åŠ¨æ¡†æ¶æ•è·åˆ°çš„äº‹ä»¶ã€‚è¿™æ ·å°±é¿å…äº†å› è¯»å–RDBæˆ–AOFæ–‡ä»¶é€ æˆRedisé˜»å¡ï¼Œè€Œæ— æ³•åŠæ—¶å¤„ç†äº‹ä»¶çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œå½“processEventsWhileBlokcedå‡½æ•°æ‰§è¡Œå¤„ç†å®¢æˆ·ç«¯å¯è¯»äº‹ä»¶æ—¶ï¼Œè¿™äº›å®¢æˆ·ç«¯è¯»æ“ä½œæ˜¯ä¸ä¼šè¢«æ¨è¿Ÿæ‰§è¡Œçš„ã€‚</p><p><strong>æ¡ä»¶å››ï¼šå®¢æˆ·ç«¯ç°æœ‰æ ‡è¯†ä¸èƒ½æœ‰CLIENT_MASTERã€CLIENT_SLAVEå’ŒCLIENT_PENDING_READ</strong></p><p>å…¶ä¸­ï¼ŒCLIENT_MASTERå’ŒCLIENT_SLAVEæ ‡è¯†åˆ†åˆ«è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ç”¨äºä¸»ä»å¤åˆ¶çš„å®¢æˆ·ç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›å®¢æˆ·ç«¯ä¸ä¼šæ¨è¿Ÿè¯»æ“ä½œã€‚CLIENT_PENDING_READæœ¬èº«å°±è¡¨ç¤ºä¸€ä¸ªå®¢æˆ·ç«¯å·²ç»è¢«è®¾ç½®ä¸ºæ¨è¿Ÿè¯»æ“ä½œäº†ï¼Œæ‰€ä»¥ï¼Œå¯¹äºå·²å¸¦æœ‰CLIENT_PENDING_READæ ‡è¯†çš„å®¢æˆ·ç«¯ï¼ŒpostponeClientReadå‡½æ•°å°±ä¸ä¼šå†æ¨è¿Ÿå®ƒçš„è¯»æ“ä½œäº†ã€‚</p><p>æ€»ä¹‹ï¼Œåªæœ‰å‰é¢è¿™å››ä¸ªæ¡ä»¶éƒ½æ»¡è¶³äº†ï¼ŒpostponeClientReadå‡½æ•°æ‰ä¼šæ¨è¿Ÿå½“å‰å®¢æˆ·ç«¯çš„è¯»æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼ŒpostponeClientReadå‡½æ•°ä¼šç»™è¯¥å®¢æˆ·ç«¯è®¾ç½®CLIENT_PENDING_REAæ ‡è¯†ï¼Œå¹¶è°ƒç”¨listAddNodeHeadå‡½æ•°ï¼ŒæŠŠè¿™ä¸ªå®¢æˆ·ç«¯æ·»åŠ åˆ°å…¨å±€å˜é‡serverçš„clients_pending_readåˆ—è¡¨ä¸­ã€‚</p><p>æˆ‘æŠŠpostponeClientReadå‡½æ•°çš„ä»£ç æ”¾åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>int postponeClientRead(client *c) {\n    //åˆ¤æ–­IOçº¿ç¨‹æ˜¯å¦æ¿€æ´»ï¼Œ\n    if (server.io_threads_active &amp;&amp; server.io_threads_do_reads &amp;&amp;          \n         !ProcessingEventsWhileBlocked &amp;&amp;\n        !(c-&gt;flags &amp; (CLIENT_MASTER|CLIENT_SLAVE|CLIENT_PENDING_READ)))\n    {\n        c-&gt;flags |= CLIENT_PENDING_READ; //ç»™å®¢æˆ·ç«¯çš„flagæ·»åŠ CLIENT_PENDING_READæ ‡è®°ï¼Œè¡¨ç¤ºæ¨è¿Ÿè¯¥å®¢æˆ·ç«¯çš„è¯»æ“ä½œ\n        listAddNodeHead(server.clients_pending_read,c); //å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°clients_pending_readåˆ—è¡¨ä¸­\n        return 1;\n    } else {\n        return 0;\n    }\n}\n</code></pre><p>å¥½ï¼Œç°åœ¨ä½ å·²ç»çŸ¥é“ï¼ŒRedisæ˜¯åœ¨å®¢æˆ·ç«¯è¯»äº‹ä»¶å›è°ƒå‡½æ•°readQueryFromClientä¸­ï¼Œé€šè¿‡è°ƒç”¨postponeClientReadå‡½æ•°æ¥åˆ¤æ–­å’Œæ¨è¿Ÿå®¢æˆ·ç«¯è¯»æ“ä½œã€‚ä¸‹é¢ï¼Œæˆ‘å†å¸¦ä½ æ¥çœ‹ä¸‹Redisæ˜¯å¦‚ä½•æ¨è¿Ÿå®¢æˆ·ç«¯å†™æ“ä½œçš„ã€‚</p><h2>å¦‚ä½•æ¨è¿Ÿå®¢æˆ·ç«¯å†™æ“ä½œï¼Ÿ</h2><p>Redisåœ¨æ‰§è¡Œäº†å®¢æˆ·ç«¯å‘½ä»¤ï¼Œè¦ç»™å®¢æˆ·ç«¯è¿”å›ç»“æœæ—¶ï¼Œä¼šè°ƒç”¨<strong>addReplyå‡½æ•°</strong>å°†å¾…è¿”å›ç»“æœå†™å…¥å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºã€‚</p><p>è€Œåœ¨addReplyå‡½æ•°çš„ä¸€å¼€å§‹ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨<strong>prepareClientToWriteå‡½æ•°</strong>ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ¨è¿Ÿæ‰§è¡Œå®¢æˆ·ç«¯å†™æ“ä½œã€‚ä¸‹é¢ä»£ç å±•ç¤ºäº†addReplyå‡½æ•°å¯¹prepareClientToWriteå‡½æ•°çš„è°ƒç”¨ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>void addReply(client *c, robj *obj) {\n    if (prepareClientToWrite(c) != C_OK) return;\n    ...\n}\n</code></pre><p>æ‰€ä»¥è¿™é‡Œï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ä¸‹prepareClientToWriteå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®å®¢æˆ·ç«¯è®¾ç½®çš„æ ‡è¯†è¿›è¡Œä¸€ç³»åˆ—çš„åˆ¤æ–­ã€‚å…¶ä¸­ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨<strong>clientHasPendingReplieså‡½æ•°</strong>ï¼Œåˆ¤æ–­å½“å‰å®¢æˆ·ç«¯æ˜¯å¦è¿˜æœ‰ç•™å­˜åœ¨è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®ç­‰å¾…å†™å›ã€‚</p><p>å¦‚æœæ²¡æœ‰çš„è¯ï¼Œé‚£ä¹ˆï¼ŒprepareClientToWriteå°±ä¼šè°ƒç”¨<strong>clientInstallWriteHandlerå‡½æ•°</strong>ï¼Œå†è¿›ä¸€æ­¥åˆ¤æ–­èƒ½å¦æ¨è¿Ÿè¯¥å®¢æˆ·ç«¯å†™æ“ä½œã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†è¿™ä¸€è°ƒç”¨è¿‡ç¨‹ï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>int prepareClientToWrite(client *c) {\n   ...\n   //å¦‚æœå½“å‰å®¢æˆ·ç«¯æ²¡æœ‰å¾…å†™å›æ•°æ®ï¼Œè°ƒç”¨clientInstallWriteHandlerå‡½æ•°\n   if (!clientHasPendingReplies(c)) clientInstallWriteHandler(c);\n   return C_OK;\n}\n</code></pre><p>é‚£ä¹ˆè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å…¶å®å°±çŸ¥é“äº†ï¼Œèƒ½å¦æ¨è¿Ÿå®¢æˆ·ç«¯å†™æ“ä½œï¼Œæœ€ç»ˆæ˜¯ç”±clientInstallWriteHandlerå‡½æ•°æ¥å†³å®šçš„ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåˆ¤æ–­ä¸¤ä¸ªæ¡ä»¶ã€‚</p><ul>\n<li><strong>æ¡ä»¶ä¸€</strong>ï¼šå®¢æˆ·ç«¯æ²¡æœ‰è®¾ç½®è¿‡CLIENT_PENDING_WRITEæ ‡è¯†ï¼Œå³æ²¡æœ‰è¢«æ¨è¿Ÿè¿‡æ‰§è¡Œå†™æ“ä½œã€‚</li>\n<li><strong>æ¡ä»¶äºŒ</strong>ï¼šå®¢æˆ·ç«¯æ‰€åœ¨å®ä¾‹æ²¡æœ‰è¿›è¡Œä¸»ä»å¤åˆ¶ï¼Œæˆ–è€…å®¢æˆ·ç«¯æ‰€åœ¨å®ä¾‹æ˜¯ä¸»ä»å¤åˆ¶ä¸­çš„ä»èŠ‚ç‚¹ï¼Œä½†å…¨é‡å¤åˆ¶çš„RDBæ–‡ä»¶å·²ç»ä¼ è¾“å®Œæˆï¼Œå®¢æˆ·ç«¯å¯ä»¥æ¥æ”¶è¯·æ±‚ã€‚</li>\n</ul><p>ä¸€æ—¦è¿™ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³äº†ï¼ŒclientInstallWriteHandlerå‡½æ•°å°±ä¼šæŠŠå®¢æˆ·ç«¯æ ‡è¯†è®¾ç½®ä¸ºCLIENT_PENDING_WRITEï¼Œè¡¨ç¤ºæ¨è¿Ÿè¯¥å®¢æˆ·ç«¯çš„å†™æ“ä½œã€‚åŒæ—¶ï¼ŒclientInstallWriteHandlerå‡½æ•°ä¼šæŠŠè¿™ä¸ªå®¢æˆ·ç«¯æ·»åŠ åˆ°å…¨å±€å˜é‡serverçš„å¾…å†™å›å®¢æˆ·ç«¯åˆ—è¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯clients_pending_writeåˆ—è¡¨ä¸­ã€‚</p><pre><code>void clientInstallWriteHandler(client *c) {\n    //å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰è®¾ç½®è¿‡CLIENT_PENDING_WRITEæ ‡è¯†ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯æ²¡æœ‰åœ¨è¿›è¡Œä¸»ä»å¤åˆ¶ï¼Œæˆ–è€…å®¢æˆ·ç«¯æ˜¯ä¸»ä»å¤åˆ¶ä¸­çš„ä»èŠ‚ç‚¹ï¼Œå·²ç»èƒ½æ¥æ”¶è¯·æ±‚\n    if (!(c-&gt;flags &amp; CLIENT_PENDING_WRITE) &amp;&amp;\n        (c-&gt;replstate == REPL_STATE_NONE ||\n         (c-&gt;replstate == SLAVE_STATE_ONLINE &amp;&amp; !c-&gt;repl_put_online_on_ack)))\n    {\n        //å°†å®¢æˆ·ç«¯çš„æ ‡è¯†è®¾ç½®ä¸ºå¾…å†™å›ï¼Œå³CLIENT_PENDING_WRITE\n        c-&gt;flags |= CLIENT_PENDING_WRITE;\n        listAddNodeHead(server.clients_pending_write,c);  //å°†å¯è·å¾—åŠ å…¥clients_pending_writeåˆ—è¡¨\n    }\n}\n</code></pre><p>ä¸ºäº†ä¾¿äºä½ æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œå±•ç¤ºäº†Redisæ¨è¿Ÿå®¢æˆ·ç«¯å†™æ“ä½œçš„å‡½æ•°è°ƒç”¨å…³ç³»ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/67/50/672977e056fba83aba183f82600c6d50.jpg?wh=2000x949\" alt=\"\"></p><p>ä¸è¿‡ï¼Œå½“Redisä½¿ç”¨clients_pending_readå’Œclients_pending_writeä¸¤ä¸ªåˆ—è¡¨ï¼Œä¿å­˜äº†æ¨è¿Ÿæ‰§è¡Œçš„å®¢æˆ·ç«¯åï¼Œ<strong>è¿™äº›å®¢æˆ·ç«¯åˆæ˜¯å¦‚ä½•åˆ†é…ç»™å¤šIOçº¿ç¨‹æ‰§è¡Œçš„å‘¢ï¼Ÿ</strong>è¿™å°±å’Œä¸‹é¢ä¸¤ä¸ªå‡½æ•°ç›¸å…³äº†ã€‚</p><ul>\n<li>handleClientsWithPendingReadsUsingThreadså‡½æ•°ï¼šè¯¥å‡½æ•°ä¸»è¦è´Ÿè´£å°†clients_pending_readåˆ—è¡¨ä¸­çš„å®¢æˆ·ç«¯åˆ†é…ç»™IOçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚</li>\n<li>handleClientsWithPendingWritesUsingThreadså‡½æ•°ï¼šè¯¥å‡½æ•°ä¸»è¦è´Ÿè´£å°†clients_pending_writeåˆ—è¡¨ä¸­çš„å®¢æˆ·ç«¯åˆ†é…ç»™IOçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚</li>\n</ul><p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„å…·ä½“æ“ä½œã€‚</p><h2>å¦‚ä½•æŠŠå¾…è¯»å®¢æˆ·ç«¯åˆ†é…ç»™IOçº¿ç¨‹æ‰§è¡Œï¼Ÿ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥äº†è§£<strong>handleClientsWithPendingReadsUsingThreadså‡½æ•°</strong>ã€‚è¿™ä¸ªå‡½æ•°æ˜¯åœ¨beforeSleepå‡½æ•°ä¸­è°ƒç”¨çš„ã€‚</p><p>åœ¨Redis 6.0ç‰ˆæœ¬çš„ä»£ç ä¸­ï¼Œäº‹ä»¶é©±åŠ¨æ¡†æ¶åŒæ ·æ˜¯è°ƒç”¨aeMainå‡½æ•°æ¥æ‰§è¡Œäº‹ä»¶å¾ªç¯æµç¨‹ï¼Œè¯¥å¾ªç¯æµç¨‹ä¼šè°ƒç”¨aeProcessEventså‡½æ•°å¤„ç†å„ç§äº‹ä»¶ã€‚è€Œåœ¨aeProcessEventså‡½æ•°å®é™…è°ƒç”¨aeApiPollå‡½æ•°æ•è·IOäº‹ä»¶ä¹‹å‰ï¼ŒbeforeSleepå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/b8/87/b823cf93b7dcyy10069136c4a5c78787.jpg?wh=2000x969\" alt=\"\"></p><p>handleClientsWithPendingReadsUsingThreadså‡½æ•°çš„ä¸»è¦æ‰§è¡Œé€»è¾‘å¯ä»¥åˆ†æˆå››æ­¥ã€‚</p><p><strong>ç¬¬ä¸€æ­¥</strong>ï¼Œè¯¥å‡½æ•°ä¼šå…ˆæ ¹æ®å…¨å±€å˜é‡serverçš„io_threads_activeæˆå‘˜å˜é‡ï¼Œåˆ¤å®šIOçº¿ç¨‹æ˜¯å¦æ¿€æ´»ï¼Œå¹¶ä¸”æ ¹æ®serverçš„io_threads_do_readsæˆå‘˜å˜é‡ï¼Œåˆ¤å®šç”¨æˆ·æ˜¯å¦è®¾ç½®äº†Rediså¯ä»¥ç”¨IOçº¿ç¨‹å¤„ç†å¾…è¯»å®¢æˆ·ç«¯ã€‚åªæœ‰åœ¨IOçº¿ç¨‹æ¿€æ´»ï¼Œå¹¶ä¸”IOçº¿ç¨‹å¯ä»¥ç”¨äºå¤„ç†å¾…è¯»å®¢æˆ·ç«¯æ—¶ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°æ‰ä¼šç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¯¥å‡½æ•°å°±ç›´æ¥ç»“æŸè¿”å›äº†ã€‚è¿™ä¸€æ­¥çš„åˆ¤æ–­é€»è¾‘å¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><pre><code>if (!server.io_threads_active || !server.io_threads_do_reads) \nreturn 0;\n</code></pre><p><strong>ç¬¬äºŒæ­¥</strong>ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ä¼šè·å–clients_pending_readåˆ—è¡¨çš„é•¿åº¦ï¼Œè¿™ä»£è¡¨äº†è¦å¤„ç†çš„å¾…è¯»å®¢æˆ·ç«¯ä¸ªæ•°ã€‚ç„¶åï¼Œè¯¥å‡½æ•°ä¼šä»clients_pending_readåˆ—è¡¨ä¸­é€ä¸€å–å‡ºå¾…å¤„ç†çš„å®¢æˆ·ç«¯ï¼Œå¹¶ç”¨å®¢æˆ·ç«¯åœ¨åˆ—è¡¨ä¸­çš„åºå·ï¼Œå¯¹IOçº¿ç¨‹æ•°é‡è¿›è¡Œå–æ¨¡è¿ç®—ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å–æ¨¡å¾—åˆ°çš„ä½™æ•°ï¼ŒæŠŠè¯¥å®¢æˆ·ç«¯åˆ†é…ç»™å¯¹åº”çš„IOçº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚ç´§æ¥ç€ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ä¼š<strong>è°ƒç”¨listAddNodeTailå‡½æ•°ï¼ŒæŠŠåˆ†é…å¥½çš„å®¢æˆ·ç«¯æ·»åŠ åˆ°io_threads_liståˆ—è¡¨çš„ç›¸åº”å…ƒç´ ä¸­</strong>ã€‚æˆ‘åˆšæ‰ç»™ä½ ä»‹ç»è¿‡ï¼Œio_threads_listæ•°ç»„çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯¹åº”ä¿å­˜äº†æ¯ä¸ªIOçº¿ç¨‹è¦å¤„ç†çš„å®¢æˆ·ç«¯ã€‚</p><p>ä¸ºäº†ä¾¿äºä½ ç†è§£ï¼Œæˆ‘æ¥ç»™ä½ ä¸¾ä¸ªä¾‹å­ã€‚</p><p>å‡è®¾IOçº¿ç¨‹æ•°é‡è®¾ç½®ä¸º3ï¼Œclients_pending_readåˆ—è¡¨ä¸­ä¸€å…±æœ‰5ä¸ªå¾…è¯»å®¢æˆ·ç«¯ï¼Œå®ƒä»¬åœ¨åˆ—è¡¨ä¸­çš„åºå·åˆ†åˆ«æ˜¯0ï¼Œ1ï¼Œ2ï¼Œ3å’Œ4ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œ0å·åˆ°4å·å®¢æˆ·ç«¯å¯¹çº¿ç¨‹æ•°é‡3å–æ¨¡çš„ç»“æœåˆ†åˆ«æ˜¯0ï¼Œ1ï¼Œ2ï¼Œ0ï¼Œ1ï¼Œè¿™ä¹Ÿå¯¹åº”äº†å³å°†å¤„ç†è¿™äº›å®¢æˆ·ç«¯çš„IOçº¿ç¨‹ç¼–å·ã€‚è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œ0å·å®¢æˆ·ç«¯ç”±0å·çº¿ç¨‹å¤„ç†ï¼Œ1å·å®¢æˆ·ç«¯æœ‰1å·çº¿ç¨‹å¤„ç†ï¼Œä»¥æ­¤ç±»æ¨ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªåˆ†é…æ–¹å¼å…¶å®å°±æ˜¯æŠŠå¾…å¤„ç†å®¢æˆ·ç«¯ï¼Œä»¥<strong>è½®è¯¢æ–¹å¼</strong>é€ä¸€åˆ†é…ç»™å„ä¸ªIOçº¿ç¨‹ã€‚</p><p>æˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾ï¼Œå±•ç¤ºäº†è¿™ä¸ªåˆ†é…ç»“æœï¼Œä½ å¯ä»¥å†çœ‹ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/3e/cc/3ea75f26c5c1fb527e4ec99fe07a4ccc.jpg?wh=2000x790\" alt=\"\"></p><p>ä»¥ä¸‹ä»£ç å±•ç¤ºçš„å°±æ˜¯ä»¥è½®è¯¢æ–¹å¼å°†å®¢æˆ·ç«¯åˆ†é…ç»™IOçº¿ç¨‹çš„æ‰§è¡Œé€»è¾‘ï¼š</p><pre><code>int processed = listLength(server.clients_pending_read);\nlistRewind(server.clients_pending_read,&amp;li);\nint item_id = 0;\nwhile((ln = listNext(&amp;li))) {\n        client *c = listNodeValue(ln);\n        int target_id = item_id % server.io_threads_num;\n        listAddNodeTail(io_threads_list[target_id],c);\n        item_id++;\n }\n</code></pre><p>è¿™æ ·ï¼Œå½“handleClientsWithPendingReadsUsingThreadså‡½æ•°å®Œæˆå®¢æˆ·ç«¯çš„IOçº¿ç¨‹åˆ†é…ä¹‹åï¼Œå®ƒä¼šå°†IOçº¿ç¨‹çš„æ“ä½œæ ‡è¯†è®¾ç½®ä¸º<strong>è¯»æ“ä½œ</strong>ï¼Œä¹Ÿå°±æ˜¯IO_THREADS_OP_READã€‚ç„¶åï¼Œå®ƒä¼šéå†io_threads_listæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆ—è¡¨é•¿åº¦ï¼Œç­‰å¾…æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å®¢æˆ·ç«¯æ•°é‡ï¼Œèµ‹å€¼ç»™ io_threads_pendingæ•°ç»„ã€‚è¿™ä¸€è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code> io_threads_op = IO_THREADS_OP_READ;\n for (int j = 1; j &lt; server.io_threads_num; j++) {\n        int count = listLength(io_threads_list[j]);\n        io_threads_pending[j] = count;\n }\n</code></pre><p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ä¼šå°†io_threads_listæ•°ç»„0å·åˆ—è¡¨ï¼ˆä¹Ÿå°±æ˜¯io_threads_list[0]å…ƒç´ ï¼‰ä¸­çš„å¾…è¯»å®¢æˆ·ç«¯é€ä¸€å–å‡ºæ¥ï¼Œå¹¶è°ƒç”¨readQueryFromClientå‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p><p>å…¶å®ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°æœ¬èº«å°±æ˜¯ç”±IOä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼Œè€Œio_threads_listæ•°ç»„å¯¹åº”çš„0å·çº¿ç¨‹æ­£æ˜¯IOä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œå°±æ˜¯è®©ä¸»IOçº¿ç¨‹æ¥å¤„ç†å®ƒçš„å¾…è¯»å®¢æˆ·ç«¯ã€‚</p><pre><code>  listRewind(io_threads_list[0],&amp;li);  //è·å–0å·åˆ—è¡¨ä¸­çš„æ‰€æœ‰å®¢æˆ·ç«¯\n    while((ln = listNext(&amp;li))) {\n        client *c = listNodeValue(ln);\n        readQueryFromClient(c-&gt;conn);\n    }\n    listEmpty(io_threads_list[0]); //å¤„ç†å®Œåï¼Œæ¸…ç©º0å·åˆ—è¡¨\n</code></pre><p>ç´§æ¥ç€ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ä¼šæ‰§è¡Œä¸€ä¸ªwhile(1)å¾ªç¯ï¼Œç­‰å¾…æ‰€æœ‰IOçº¿ç¨‹å®Œæˆå¾…è¯»å®¢æˆ·ç«¯çš„å¤„ç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code> while(1) {\n        unsigned long pending = 0;\n        for (int j = 1; j &lt; server.io_threads_num; j++)\n            pending += io_threads_pending[j];\n        if (pending == 0) break;\n    }\n</code></pre><p><strong>ç¬¬å››æ­¥</strong>ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ä¼šå†æ¬¡éå†ä¸€éclients_pending_readåˆ—è¡¨ï¼Œä¾æ¬¡å–å‡ºå…¶ä¸­çš„å®¢æˆ·ç«¯ã€‚ç´§æ¥ç€ï¼Œå®ƒä¼šåˆ¤æ–­å®¢æˆ·ç«¯çš„æ ‡è¯†ä¸­æ˜¯å¦æœ‰CLIENT_PENDING_COMMANDã€‚å¦‚æœæœ‰CLIENT_PENDING_COMMANDæ ‡è¯†ï¼Œè¡¨æ˜è¯¥å®¢æˆ·ç«¯ä¸­çš„å‘½ä»¤å·²ç»è¢«æŸä¸€ä¸ªIOçº¿ç¨‹è§£æè¿‡ï¼Œå·²ç»å¯ä»¥è¢«æ‰§è¡Œäº†ã€‚</p><p>æ­¤æ—¶ï¼ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ä¼šè°ƒç”¨processCommandAndResetClientå‡½æ•°æ‰§è¡Œå‘½ä»¤ã€‚æœ€åï¼Œå®ƒä¼šç›´æ¥è°ƒç”¨processInputBufferå‡½æ•°è§£æå®¢æˆ·ç«¯ä¸­æ‰€æœ‰å‘½ä»¤å¹¶æ‰§è¡Œã€‚</p><p>è¿™éƒ¨åˆ†çš„ä»£ç é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼Œä½ å¯ä»¥çœ‹ä¸‹ã€‚</p><pre><code>while(listLength(server.clients_pending_read)) {\n        ln = listFirst(server.clients_pending_read);\n        client *c = listNodeValue(ln);\n        ...\n        //å¦‚æœå‘½ä»¤å·²ç»è§£æè¿‡ï¼Œåˆ™æ‰§è¡Œè¯¥å‘½ä»¤\n        if (c-&gt;flags &amp; CLIENT_PENDING_COMMAND) {\n            c-&gt;flags &amp;= ~CLIENT_PENDING_COMMAND;\n            if (processCommandAndResetClient(c) == C_ERR) {          \n                continue;\n            }\n        }\n        //è§£æå¹¶æ‰§è¡Œæ‰€æœ‰å‘½ä»¤\n        processInputBuffer(c);\n}\n</code></pre><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œä½ å°±äº†è§£äº†clients_pending_readåˆ—è¡¨ä¸­çš„å¾…è¯»å®¢æˆ·ç«¯ï¼Œæ˜¯å¦‚ä½•ç»è¿‡ä»¥ä¸Šå››ä¸ªæ­¥éª¤æ¥åˆ†é…ç»™IOçº¿ç¨‹è¿›è¡Œå¤„ç†çš„ã€‚ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸ªä¸»è¦è¿‡ç¨‹ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸‹ã€‚</p><p><img src=\"https://static001.geekbang.org/resource/image/1b/45/1b4bb7d5367d9184a9eacefbabfe3345.jpg?wh=2000x1125\" alt=\"\"></p><p>é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹å¾…å†™å®¢æˆ·ç«¯çš„åˆ†é…å’Œå¤„ç†ã€‚</p><h2>å¦‚ä½•æŠŠå¾…å†™å®¢æˆ·ç«¯åˆ†é…ç»™IOçº¿ç¨‹æ‰§è¡Œï¼Ÿ</h2><p>å’Œå¾…è¯»å®¢æˆ·ç«¯çš„åˆ†é…å¤„ç†ç±»ä¼¼ï¼Œå¾…å†™å®¢æˆ·ç«¯åˆ†é…å¤„ç†æ˜¯ç”±<strong>handleClientsWithPendingWritesUsingThreadså‡½æ•°</strong>æ¥å®Œæˆçš„ã€‚è¯¥å‡½æ•°ä¹Ÿæ˜¯åœ¨beforeSleepå‡½æ•°ä¸­è¢«è°ƒç”¨çš„ã€‚</p><p>handleClientsWithPendingWritesUsingThreadså‡½æ•°çš„ä¸»è¦æµç¨‹åŒæ ·ä¹Ÿå¯ä»¥åˆ†æˆ4æ­¥ï¼Œå…¶ä¸­ï¼Œç¬¬2ã€3å’Œ4æ­¥çš„æ‰§è¡Œé€»è¾‘ï¼Œå’ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ç±»ä¼¼ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œåœ¨ç¬¬2æ­¥ï¼ŒhandleClientsWithPendingWritesUsingThreadså‡½æ•°ä¼šæŠŠå¾…å†™å®¢æˆ·ç«¯ï¼ŒæŒ‰ç…§<strong>è½®è¯¢æ–¹å¼</strong>åˆ†é…ç»™IOçº¿ç¨‹ï¼Œæ·»åŠ åˆ°io_threads_listæ•°ç»„å„å…ƒç´ ä¸­ã€‚</p><p>ç„¶åï¼Œåœ¨ç¬¬3æ­¥ï¼ŒhandleClientsWithPendingWritesUsingThreadså‡½æ•°ä¼šè®©ä¸»IOçº¿ç¨‹å¤„ç†å…¶å¾…å†™å®¢æˆ·ç«¯ï¼Œå¹¶æ‰§è¡Œwhile(1)å¾ªç¯ç­‰å¾…æ‰€æœ‰IOçº¿ç¨‹å®Œæˆå¤„ç†ã€‚</p><p>åœ¨ç¬¬4æ­¥ï¼ŒhandleClientsWithPendingWritesUsingThreadså‡½æ•°ä¼šå†æ¬¡æ£€æŸ¥clients_pending_writeåˆ—è¡¨ä¸­ï¼Œæ˜¯å¦è¿˜æœ‰å¾…å†™çš„å®¢æˆ·ç«¯ã€‚å¦‚æœæœ‰çš„è¯ï¼Œå¹¶ä¸”è¿™äº›å®¢æˆ·ç«¯è¿˜æœ‰ç•™å­˜åœ¨ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œé‚£ä¹ˆï¼ŒhandleClientsWithPendingWritesUsingThreadså‡½æ•°å°±ä¼šè°ƒç”¨connSetWriteHandlerå‡½æ•°æ³¨å†Œå¯å†™äº‹ä»¶ï¼Œè€Œè¿™ä¸ªå¯å†™äº‹ä»¶å¯¹åº”çš„å›è°ƒå‡½æ•°æ˜¯<strong>sendReplyToClientå‡½æ•°</strong>ã€‚</p><p>ç­‰åˆ°äº‹ä»¶å¾ªç¯æµç¨‹å†æ¬¡æ‰§è¡Œæ—¶ï¼Œåˆšæ‰handleClientsWithPendingWritesUsingThreadså‡½æ•°æ³¨å†Œçš„å¯å†™äº‹ä»¶å°±ä¼šè¢«å¤„ç†ï¼Œç´§æ¥ç€sendReplyToClientå‡½æ•°ä¼šæ‰§è¡Œï¼Œå®ƒä¼šç›´æ¥è°ƒç”¨writeToClientå‡½æ•°ï¼ŒæŠŠå®¢æˆ·ç«¯ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å›ã€‚</p><p>è¿™é‡Œï¼Œ<strong>ä½ éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼ŒconnSetWriteHandlerå‡½æ•°æœ€ç»ˆä¼šæ˜ å°„ä¸ºconnSocketSetWriteHandlerå‡½æ•°ï¼Œè€ŒconnSocketSetWriteHandlerå‡½æ•°æ˜¯åœ¨<a href=\"https://github.com/redis/redis/tree/5.0/src/connection.c\">connection.c</a>æ–‡ä»¶ä¸­å®ç°çš„ã€‚connSocketSetWriteHandlerå‡½æ•°ä¼šè°ƒç”¨aeCreateFileEventå‡½æ•°åˆ›å»ºAE_WRITABLEäº‹ä»¶ï¼Œè¿™å°±æ˜¯åˆšæ‰ä»‹ç»çš„å¯å†™äº‹ä»¶çš„æ³¨å†Œï¼ˆå…³äºaeCreateFileEventå‡½æ•°çš„ä½¿ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥å†å›é¡¾ä¸‹ç¬¬11è®²ï¼‰ã€‚</p><p>ä¸è¿‡ï¼Œå’ŒhandleClientsWithPendingReadsUsingThreadså‡½æ•°ä¸åŒçš„æ˜¯åœ¨ç¬¬1æ­¥ï¼ŒhandleClientsWithPendingWritesUsingThreadså‡½æ•°ï¼Œ<strong>ä¼šåˆ¤æ–­IOçº¿ç¨‹æ•°é‡æ˜¯å¦ä¸º1ï¼Œæˆ–è€…å¾…å†™å®¢æˆ·ç«¯æ•°é‡æ˜¯å¦å°äºIOçº¿ç¨‹æ•°é‡çš„2å€ã€‚</strong></p><p>å¦‚æœè¿™ä¸¤ä¸ªæ¡ä»¶ä¸­æœ‰ä¸€ä¸ªæ¡ä»¶æˆç«‹ï¼Œé‚£ä¹ˆhandleClientsWithPendingWritesUsingThreadså‡½æ•°å°±ä¸ä¼šç”¨å¤šçº¿ç¨‹æ¥å¤„ç†å®¢æˆ·ç«¯äº†ï¼Œè€Œæ˜¯ä¼šè°ƒç”¨handleClientsWithPendingWriteså‡½æ•°ç”±ä¸»IOçº¿ç¨‹ç›´æ¥å¤„ç†å¾…å†™å®¢æˆ·ç«¯ã€‚è¿™æ ·åšçš„ç›®çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨å¾…å†™å®¢æˆ·ç«¯æ•°é‡ä¸å¤šæ—¶ï¼Œé¿å…é‡‡ç”¨å¤šçº¿ç¨‹ï¼Œä»è€Œ<strong>èŠ‚çœCPUå¼€é”€</strong>ã€‚</p><p>è¿™ä¸€æ­¥çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºã€‚å…¶ä¸­ï¼ŒstopThreadedIOIfNeededå‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥åˆ¤æ–­å¾…å†™å®¢æˆ·ç«¯æ•°é‡ï¼Œæ˜¯å¦ä¸è¶³ä¸ºIOçº¿ç¨‹æ•°é‡çš„2å€ã€‚</p><pre><code>if (server.io_threads_num == 1 || stopThreadedIOIfNeeded()) {\n        return handleClientsWithPendingWrites();\n}\n</code></pre><p>å¦å¤–ï¼ŒhandleClientsWithPendingWritesUsingThreadså‡½æ•°åœ¨ç¬¬1æ­¥ä¸­ï¼Œè¿˜ä¼š<strong>åˆ¤æ–­IOçº¿ç¨‹æ˜¯å¦å·²æ¿€æ´»</strong>ã€‚å¦‚æœæ²¡æœ‰æ¿€æ´»ï¼Œå®ƒå°±ä¼šè°ƒç”¨startThreadedIOå‡½æ•°ï¼ŒæŠŠå…¨å±€å˜é‡serverçš„io_threads_activeæˆå‘˜å˜é‡å€¼è®¾ç½®ä¸º1ï¼Œè¡¨ç¤ºIOçº¿ç¨‹å·²æ¿€æ´»ã€‚è¿™æ­¥åˆ¤æ–­æ“ä½œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>if (!server.io_threads_active) startThreadedIO();\n</code></pre><p>æ€»ä¹‹ä½ è¦çŸ¥é“çš„å°±æ˜¯ï¼ŒRedisæ˜¯é€šè¿‡handleClientsWithPendingWritesUsingThreadså‡½æ•°ï¼ŒæŠŠå¾…å†™å®¢æˆ·ç«¯æŒ‰è½®è¯¢æ–¹å¼åˆ†é…ç»™å„ä¸ªIOçº¿ç¨‹ï¼Œå¹¶ç”±å®ƒä»¬æ¥è´Ÿè´£å†™å›æ•°æ®çš„ã€‚</p><h2>å°ç»“</h2><p>ä»Šå¤©è¿™èŠ‚è¯¾ï¼Œæˆ‘ç»™ä½ ä»‹ç»äº†Redis 6.0ä¸­æ–°è®¾è®¡å®ç°çš„<strong>å¤šIOçº¿ç¨‹æœºåˆ¶</strong>ã€‚è¿™ä¸ªæœºåˆ¶çš„è®¾è®¡ä¸»è¦æ˜¯ä¸ºäº†ä½¿ç”¨å¤šä¸ªIOçº¿ç¨‹ï¼Œæ¥å¹¶å‘å¤„ç†å®¢æˆ·ç«¯è¯»å–æ•°æ®ã€è§£æå‘½ä»¤å’Œå†™å›æ•°æ®ã€‚ä½¿ç”¨äº†å¤šçº¿ç¨‹åï¼ŒRediså°±å¯ä»¥å……åˆ†åˆ©ç”¨æœåŠ¡å™¨çš„å¤šæ ¸ç‰¹æ€§ï¼Œä»è€Œ<strong>æé«˜IOæ•ˆç‡</strong>ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼ŒRedis 6.0å…ˆæ˜¯åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®ç”¨æˆ·è®¾ç½®çš„IOçº¿ç¨‹æ•°é‡ï¼Œåˆ›å»ºå¯¹åº”æ•°é‡çš„IOçº¿ç¨‹ã€‚</p><p>å½“Redis serveråˆå§‹åŒ–å®Œæˆåæ­£å¸¸è¿è¡Œæ—¶ï¼Œå®ƒä¼šåœ¨readQueryFromClientå‡½æ•°ä¸­é€šè¿‡è°ƒç”¨postponeClientReadå‡½æ•°æ¥å†³å®šæ˜¯å¦æ¨è¿Ÿå®¢æˆ·ç«¯è¯»æ“ä½œã€‚åŒæ—¶ï¼ŒRedis serverä¼šåœ¨addReplyå‡½æ•°ä¸­é€šè¿‡è°ƒç”¨prepareClientToWriteå‡½æ•°ï¼Œæ¥å†³å®šæ˜¯å¦æ¨è¿Ÿå®¢æˆ·ç«¯å†™æ“ä½œã€‚è€Œå¾…è¯»å†™çš„å®¢æˆ·ç«¯ä¼šè¢«åˆ†åˆ«åŠ å…¥åˆ°clients_pending_readå’Œclients_pending_writeä¸¤ä¸ªåˆ—è¡¨ä¸­ã€‚</p><p>è¿™æ ·ï¼Œæ¯å½“Redis serverè¦è¿›å…¥äº‹ä»¶å¾ªç¯æµç¨‹å‰ï¼Œéƒ½ä¼šåœ¨beforeSleepå‡½æ•°ä¸­åˆ†åˆ«è°ƒç”¨handleClientsWithPendingReadsUsingThreadså‡½æ•°å’ŒhandleClientsWithPendingWritesUsingThreadså‡½æ•°ï¼Œå°†å¾…è¯»å†™å®¢æˆ·ç«¯<strong>ä»¥è½®è¯¢æ–¹å¼åˆ†é…ç»™IOçº¿ç¨‹</strong>ï¼ŒåŠ å…¥åˆ°IOçº¿ç¨‹çš„å¾…å¤„ç†å®¢æˆ·ç«¯åˆ—è¡¨io_threads_listä¸­ã€‚</p><p>è€ŒIOçº¿ç¨‹ä¸€æ—¦è¿è¡Œåï¼Œæœ¬èº«ä¼šä¸€ç›´æ£€æµ‹io_threads_listä¸­çš„å®¢æˆ·ç«¯ï¼Œå¦‚æœæœ‰å¾…è¯»å†™å®¢æˆ·ç«¯ï¼ŒIOçº¿ç¨‹å°±ä¼šè°ƒç”¨readQueryFromClientæˆ–writeToClientå‡½æ•°æ¥è¿›è¡Œå¤„ç†ã€‚</p><p>æœ€åï¼Œæˆ‘ä¹Ÿæƒ³å†æé†’ä½ ä¸€ä¸‹ï¼Œ<strong>å¤šIOçº¿ç¨‹æœ¬èº«å¹¶ä¸ä¼šæ‰§è¡Œå‘½ä»¤</strong>ï¼Œå®ƒä»¬åªæ˜¯åˆ©ç”¨å¤šæ ¸å¹¶è¡Œåœ°è¯»å–æ•°æ®å’Œè§£æå‘½ä»¤ï¼Œæˆ–æ˜¯å°†serveræ•°æ®å†™å›ï¼ˆä¸‹èŠ‚è¯¾æˆ‘è¿˜ä¼šç»“åˆåˆ†å¸ƒå¼é”çš„åŸå­æ€§ä¿è¯ï¼Œæ¥ç»™ä½ ä»‹ç»è¿™ä¸€éƒ¨åˆ†çš„æºç å®ç°ã€‚ï¼‰ã€‚æ‰€ä»¥ï¼Œ<strong>Redisæ‰§è¡Œå‘½ä»¤çš„çº¿ç¨‹è¿˜æ˜¯ä¸»IOçº¿ç¨‹</strong>ã€‚è¿™ä¸€ç‚¹å¯¹äºä½ ç†è§£å¤šIOçº¿ç¨‹æœºåˆ¶å¾ˆé‡è¦ï¼Œå¯ä»¥é¿å…ä½ è¯¯è§£Redisæœ‰å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œå‘½ä»¤ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬åŸæ¥é’ˆå¯¹Redis å•ä¸ªä¸»IOçº¿ç¨‹åšçš„ä¼˜åŒ–ä»ç„¶æœ‰æ•ˆï¼Œæ¯”å¦‚é¿å…bigkeyã€é¿å…é˜»å¡æ“ä½œç­‰ã€‚</p><h2>æ¯è¯¾ä¸€é—®</h2><p>Redis å¤šIOçº¿ç¨‹æœºåˆ¶ä½¿ç”¨startThreadedIOå‡½æ•°å’ŒstopThreadedIOå‡½æ•°ï¼Œæ¥è®¾ç½®IOçº¿ç¨‹æ¿€æ´»æ ‡è¯†io_threads_activeä¸º1å’Œä¸º0ã€‚æ­¤å¤„ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°è¿˜ä¼šå¯¹çº¿ç¨‹äº’æ–¥é”æ•°ç»„è¿›è¡Œè§£é”å’ŒåŠ é”æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä½ çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°è¦æ‰§è¡Œè§£é”å’ŒåŠ é”æ“ä½œä¹ˆï¼Ÿ</p><pre><code>void startThreadedIO(void) {\n    ...\n    for (int j = 1; j &lt; server.io_threads_num; j++)\n        pthread_mutex_unlock(&amp;io_threads_mutex[j]);  //ç»™äº’æ–¥é”æ•°ç»„ä¸­æ¯ä¸ªçº¿ç¨‹å¯¹åº”çš„äº’æ–¥é”åšè§£é”æ“ä½œ\n    server.io_threads_active = 1;\n}\n\nvoid stopThreadedIO(void) {\n    ...\n    for (int j = 1; j &lt; server.io_threads_num; j++)\n        pthread_mutex_lock(&amp;io_threads_mutex[j]);  //ç»™äº’æ–¥é”æ•°ç»„ä¸­æ¯ä¸ªçº¿ç¨‹å¯¹åº”çš„äº’æ–¥é”åšåŠ é”æ“ä½œ\n    server.io_threads_active = 0;\n}\n</code></pre><p>æ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ä½ çš„ç­”æ¡ˆå’Œæ€è€ƒè¿‡ç¨‹ï¼Œå¦‚æœè§‰å¾—æœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠä»Šå¤©çš„å†…å®¹åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p>","neighbors":{"left":{"article_title":"12 | RedisçœŸçš„æ˜¯å•çº¿ç¨‹å—ï¼Ÿ","id":409927},"right":{"article_title":"14 | ä»ä»£ç å®ç°çœ‹åˆ†å¸ƒå¼é”çš„åŸå­æ€§ä¿è¯","id":411558}},"comments":[{"had_liked":false,"id":308790,"user_name":"Kaito","can_delete":false,"product_type":"c1","uid":1020042,"ip_address":"","ucode":"79775FA35A95F2","user_header":"https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg","comment_is_top":false,"comment_ctime":1629799554,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"113298949250","product_id":100084301,"comment_content":"1ã€Redis 6.0 ä¹‹å‰ï¼Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ˜¯å•çº¿ç¨‹ï¼Œè¿™ç§æ¨¡å‹çš„ç¼ºç‚¹æ˜¯ï¼Œåªèƒ½ç”¨åˆ°ã€Œå•æ ¸ã€CPUã€‚å¦‚æœå¹¶å‘é‡å¾ˆé«˜ï¼Œé‚£ä¹ˆåœ¨è¯»å†™å®¢æˆ·ç«¯æ•°æ®æ—¶ï¼Œå®¹æ˜“å¼•å‘æ€§èƒ½ç“¶é¢ˆï¼Œæ‰€ä»¥ Redis 6.0 å¼•å…¥äº†å¤š IO çº¿ç¨‹è§£å†³è¿™ä¸ªé—®é¢˜<br><br>2ã€é…ç½®æ–‡ä»¶å¼€å¯ io-threads N åï¼ŒRedis Server å¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨ N - 1 ä¸ª IO çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ä¹Ÿç®—ä¸€ä¸ª IO çº¿ç¨‹ï¼‰ï¼Œè¿™äº› IO çº¿ç¨‹æ‰§è¡Œçš„é€»è¾‘æ˜¯ networking.c çš„ IOThreadMain å‡½æ•°ã€‚ä½†é»˜è®¤åªå¼€å¯å¤šçº¿ç¨‹ã€Œå†™ã€client socketï¼Œå¦‚æœè¦å¼€å¯å¤šçº¿ç¨‹ã€Œè¯»ã€ï¼Œè¿˜éœ€é…ç½® io-threads-do-reads = yes<br><br>3ã€Redis åœ¨è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œåˆ¤æ–­å¦‚æœå¼€å¯äº† IO å¤šçº¿ç¨‹ï¼Œåˆ™æŠŠè¿™ä¸ª client æ”¾åˆ° clients_pending_read é“¾è¡¨ä¸­ï¼ˆpostponeClientRead å‡½æ•°ï¼‰ï¼Œä¹‹åä¸»çº¿ç¨‹åœ¨å¤„ç†æ¯æ¬¡äº‹ä»¶å¾ªç¯ä¹‹å‰ï¼ŒæŠŠé“¾è¡¨æ•°æ®è½®è¯¢æ”¾åˆ° IO çº¿ç¨‹çš„é“¾è¡¨ï¼ˆio_threads_listï¼‰ä¸­<br><br>4ã€åŒæ ·åœ°ï¼Œåœ¨å†™å›å“åº”æ—¶ï¼Œæ˜¯æŠŠ client æ”¾åˆ° clients_pending_write ä¸­ï¼ˆprepareClientToWrite å‡½æ•°ï¼‰ï¼Œæ‰§è¡Œäº‹ä»¶å¾ªç¯ä¹‹å‰æŠŠæ•°æ®è½®è¯¢æ”¾åˆ° IO çº¿ç¨‹çš„é“¾è¡¨ï¼ˆio_threads_listï¼‰ä¸­<br><br>5ã€ä¸»çº¿ç¨‹æŠŠ client åˆ†å‘åˆ° IO çº¿ç¨‹æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¯»å†™å®¢æˆ·ç«¯ socketï¼ˆä¸»çº¿ç¨‹ä¹Ÿè¦åˆ†æ‹…ä¸€éƒ¨åˆ†è¯»å†™æ“ä½œï¼‰ï¼Œä¹‹åã€Œç­‰å¾…ã€æ‰€æœ‰ IO çº¿ç¨‹å®Œæˆè¯»å†™ï¼Œå†ç”±ä¸»çº¿ç¨‹ã€Œä¸²è¡Œã€æ‰§è¡Œåç»­é€»è¾‘<br><br>6ã€æ¯ä¸ª IO çº¿ç¨‹ï¼Œä¸åœåœ°ä» io_threads_list é“¾è¡¨ä¸­å–å‡º clientï¼Œå¹¶æ ¹æ®æŒ‡å®šç±»å‹è¯»ã€å†™ client socket<br><br>7ã€IO çº¿ç¨‹åœ¨å¤„ç†è¯»ã€å†™ client æ—¶æœ‰äº›è®¸å·®å¼‚ï¼Œå¦‚æœ write_client_pedding &lt; io_threads * 2ï¼Œåˆ™ç›´æ¥ç”±ã€Œä¸»çº¿ç¨‹ã€è´Ÿè´£å†™ï¼Œä¸å†äº¤ç»™ IO çº¿ç¨‹å¤„ç†ï¼Œä»è€ŒèŠ‚çœ CPU æ¶ˆè€—<br><br>8ã€Redis å®˜æ–¹å»ºè®®ï¼ŒæœåŠ¡å™¨æœ€å°‘ 4 æ ¸ CPU æ‰å»ºè®®å¼€å¯ IO å¤šçº¿ç¨‹ï¼Œ4 æ ¸ CPU å»ºè®®å¼€ 2-3 ä¸ª IO çº¿ç¨‹ï¼Œ8 æ ¸ CPU å¼€ 6 ä¸ª IO çº¿ç¨‹ï¼Œè¶…è¿‡ 8 ä¸ªçº¿ç¨‹æ€§èƒ½æå‡ä¸å¤§<br><br>9ã€Redis å®˜æ–¹è¡¨ç¤ºï¼Œå¼€å¯å¤š IO çº¿ç¨‹åï¼Œæ€§èƒ½å¯æå‡ 1 å€ã€‚å½“ç„¶ï¼Œå¦‚æœ Redis æ€§èƒ½è¶³å¤Ÿç”¨ï¼Œæ²¡å¿…è¦å¼€ IO çº¿ç¨‹<br><br>è¯¾åé¢˜ï¼šä¸ºä»€ä¹ˆ startThreadedIO &#47; stopThreadedIO è¦æ‰§è¡ŒåŠ è§£é”ï¼Ÿ<br><br>æ—¢ç„¶æ¶‰åŠåˆ°åŠ é”æ“ä½œï¼Œå¿…ç„¶æ˜¯ä¸ºäº†ã€Œäº’æ–¥ã€ä»è€Œæ§åˆ¶æŸäº›é€»è¾‘ã€‚å¯ä»¥åœ¨ä»£ç ä¸­æ£€ç´¢è¿™ä¸ªé”å˜é‡ï¼Œçœ‹å­˜åœ¨å“ªäº›é€»è¾‘å¯¹ io_threads_mutex æ“ä½œäº†åŠ è§£é”ã€‚<br><br>è·Ÿè¸ªä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ networking.c çš„ IOThreadMain å‡½æ•°ï¼Œä¹Ÿå¯¹è¿™ä¸ªå˜é‡è¿›è¡Œäº†åŠ è§£é”æ“ä½œï¼Œé‚£å°±è¯´æ˜ startThreadedIO &#47; stopThreadedIO å‡½æ•°ï¼Œå¯ä»¥æ§åˆ¶ IOThreadMain é‡Œé€»è¾‘çš„æ‰§è¡Œï¼ŒIOThreadMain ä»£ç å¦‚ä¸‹ã€‚<br><br>void *IOThreadMain(void *myid) {<br>    ...<br>    while(1) {<br>        ...<br>        &#47;* Give the main thread a chance to stop this thread. *&#47;<br>        if (io_threads_pending[id] == 0) {<br>            pthread_mutex_lock(&amp;io_threads_mutex[id]);<br>            pthread_mutex_unlock(&amp;io_threads_mutex[id]);<br>            continue;<br>        }<br>        &#47;&#47; è¯»å†™ client socket <br>        &#47;&#47; ...<br>    }<br><br><br>è¿™ä¸ªå‡½æ•°æ­£æ˜¯ IO å¤šçº¿ç¨‹çš„ä¸»é€»è¾‘ã€‚<br><br>ä»æ³¨é‡Šå¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸ºäº†ç»™ä¸»çº¿ç¨‹åœæ­¢ IO çº¿ç¨‹çš„çš„æœºä¼šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œçš„ç›®çš„æ˜¯ä¸ºäº†è®©ä¸»çº¿ç¨‹å¯ä»¥æ§åˆ¶ IO çº¿ç¨‹çš„å¼€å¯ &#47; æš‚åœã€‚<br><br>å› ä¸ºæ¯æ¬¡ IO çº¿ç¨‹åœ¨æ‰§è¡Œæ—¶å¿…é¡»å…ˆæ‹¿åˆ°é”ï¼Œæ‰èƒ½æ‰§è¡Œåé¢çš„é€»è¾‘ï¼Œå¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œäº† stopThreadedIOï¼Œå°±ä¼šå…ˆæ‹¿åˆ°é”ï¼Œé‚£ä¹ˆ IOThreadMain å‡½æ•°åœ¨æ‰§è¡Œæ—¶å°±ä¼šå› ä¸ºæ‹¿ä¸åˆ°é”é˜»å¡ã€Œç­‰å¾…ã€ï¼Œè¿™å°±è¾¾åˆ°äº† stop IO çº¿ç¨‹çš„ç›®çš„ã€‚<br><br>åŒæ ·åœ°ï¼Œè°ƒç”¨ startThreadedIO å‡½æ•°åï¼Œä¼šé‡Šæ”¾é”ï¼ŒIO çº¿ç¨‹å°±å¯ä»¥æ‹¿åˆ°é”ï¼Œç»§ç»­ã€Œæ¢å¤ã€æ‰§è¡Œã€‚<br>","like_count":27},{"had_liked":false,"id":309855,"user_name":"æ›¾è½¼éºŸ","can_delete":false,"product_type":"c1","uid":1451391,"ip_address":"","ucode":"D418371AC11270","user_header":"https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg","comment_is_top":false,"comment_ctime":1630374957,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"27400178733","product_id":100084301,"comment_content":"ä¸€æ ·é¦–å…ˆå›ç­”è€å¸ˆçš„é—®é¢˜ï¼Œä½ çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°è¦æ‰§è¡Œè§£é”å’ŒåŠ é”æ“ä½œä¹ˆï¼Ÿ<br><br>ç­”æ¡ˆï¼šæ˜¯ä¸ºäº†æ–¹ä¾¿ä¸»çº¿ç¨‹åŠ¨æ€ï¼Œçµæ´»è°ƒæ•´IOçº¿ç¨‹è€Œè®¾è®¡çš„ï¼Œå½“clientsæ•°é‡è¾ƒå°‘çš„æ—¶å€™å¯ä»¥æ–¹ä¾¿ç›´æ¥åœæ­¢IOçº¿ç¨‹ã€‚åœæ­¢IOçº¿ç¨‹çš„é˜ˆå€¼æ˜¯ï¼Œå½“ç­‰å¾…å†™çš„clientå®¢æˆ·ç«¯æ•°é‡å°äºIOçº¿ç¨‹æ•°é‡çš„ä¸¤å€ï¼Œå°±ä¼šåœæ­¢IOçº¿ç¨‹é¿å…å¤šçº¿ç¨‹å¸¦æ¥ä¸å¿…è¦çš„å¼€é”€<br><br>å›å½’ä»£ç ï¼š<br>1ã€stopThreadedIOï¼ŒstartThreadedIO å’Œ stopThreadedIOIfNeededè¿™ä¸‰ä¸ªå‡½æ•°ä¸­æœ‰ä½“ç°ï¼Œå…¶ä¸­åœ¨stopThreadedIOIfNeededä¸­ä¼šåˆ¤æ–­å½“å‰å¾…å†™å‡ºå®¢æˆ·ç«¯æ•°é‡æ˜¯å¦å¤§äº2å€IOçº¿ç¨‹æ•°é‡ï¼Œå¦‚æœä¸æ˜¯åˆ™ä¼šè°ƒç”¨stopThreadedIOå‡½æ•°é€šè¿‡io_threads_mutexçš„æ–¹å¼åœæ­¢æ‰€æœ‰IOçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼Œå› ä¸ºindexæ˜¯ä»1å¼€å§‹çš„ï¼‰å¹¶ä¸”å°†io_threads_activeè®¾ç½®ä¸º0ï¼Œå¹¶ä¸”åç»­è°ƒç”¨stopThreadedIOIfNeededå‡½æ•°ä¼šè¿”å›0ï¼Œåœ¨handleClientsWithPendingWritesUsingThreadså‡½æ•°ä¸­ä¼šç›´æ¥è°ƒç”¨handleClientsWithPendingWritesæ¥ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œå†™å‡ºã€‚<br><br>    æµç¨‹å¦‚ä¸‹ï¼š<br>        ç¬¬ä¸€æ¬¡ï¼šhandleClientsWithPendingWritesUsingThreads -&gt; stopThreadedIOIfNeeded -&gt; stopThreadedIO -&gt; è®¾ç½®io_threads_activeä¸º0å¹¶lockä½IOçº¿ç¨‹<br>        ç¬¬äºŒæ¬¡: handleClientsWithPendingWritesUsingThreads -&gt; stopThreadedIOIfNeeded -&gt; ç›´æ¥è¿”å›1 -&gt; handleClientsWithPendingWritesè¿›è¡Œå•çº¿ç¨‹å¤„ç†<br><br>2ã€å½“å¾…å†™å‡ºclientçš„æ•°é‡ä¸Šæ¥çš„æ—¶å€™ï¼ŒstopThreadedIOIfNeededå‡½æ•°ä¸­åˆ¤æ–­ï¼Œå¾…å†™å‡ºclientæ•°é‡å¤§äº2å€IOçº¿ç¨‹æ•°é‡ï¼Œè¿”å›0ï¼Œç„¶åè°ƒç”¨startThreadedIOæ¿€æ´»IOçº¿ç¨‹<br>    <br>    æµç¨‹å¦‚ä¸‹ï¼š<br>        handleClientsWithPendingWritesUsingThreads -&gt; stopThreadedIOIfNeeded(å‘ç°ä¸æ»¡è¶³éœ€è¦IOçº¿ç¨‹ï¼Œè¿”å›0) -&gt; startThreadedIO(æ¿€æ´»IOçº¿ç¨‹) -&gt; è®¾ç½®io_threads_activeä¸º1<br><br>æ­¤å¤–æ³¨æ„ï¼šIOçº¿ç¨‹ä¸€å®šæ˜¯å¤„ç†å®Œäº†æ‰€æœ‰clientä¹‹åï¼Œæ‰ä¼šå€lockï¼Œåœ¨IOThreadMainæœ‰ä¸€ä¸ªæ¡ä»¶ if (getIOPendingCount(id) == 0) <br><br>æ€»ç»“ï¼š<br>    æœ¬ç¯‡æ–‡ç« ï¼Œè€å¸ˆå¸¦æˆ‘ä»¬äº†è§£äº†IOçº¿ç¨‹çš„è®¾è®¡åŸç†å’Œå¤šIOç»™Rediså¸¦äº†äº†æ€§èƒ½ä¸Šçš„æå‡ï¼Œä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼ŒIOçº¿ç¨‹çš„æ•°é‡å¹¶ä¸æ˜¯éšå¿ƒæ‰€æ¬²çš„è®¾ç½®çš„ï¼Œåº”å½“ç»“åˆRedis clientçš„æ•°é‡è€Œå®šçš„ï¼Œå¹¶ä¸”ä¸Šé™æ˜¯128ï¼Œæ­¤å¤–IOçº¿ç¨‹ï¼Œæ˜¯å’Œä¸»çº¿ç¨‹å…±åŒåè°ƒè¿è¡Œçš„ï¼Œæœ€å…¸å‹çš„å°±æ˜¯ä¸»çº¿ç¨‹é€šè¿‡æ§åˆ¶io_threads_opæ¥åè°ƒIOçº¿ç¨‹æ˜¯åŒæ­¥è¯»å–è¿˜æ˜¯å†™å…¥<br><br>å»ºè®®:<br>    IOçº¿ç¨‹è¿™å—å…¶å®è¿˜æ¶‰åŠä¸€ä¸ªæ¯”è¾ƒå¤§çš„å†…å®¹ï¼Œå°±æ˜¯RESPçš„åè®®ç¼–è§£ç ï¼ŒIOçº¿ç¨‹è™½ç„¶ä¸æ¶‰åŠå‘½ä»¤æ‰§è¡Œï¼Œä½†æ˜¯ä¼šååŠ©ä¸»çº¿ç¨‹è¿›è¡Œåè®®ç¼–è§£ç ï¼Œè€ŒRESPåè®®çš„è®¾è®¡å¾ˆå·§å¦™ï¼Œå¯¹ç²˜åŒ…æ‹†åŒ…ç­‰å¤„ç†ä¹Ÿæ˜¯å…¶ä¸€å¤§äº®ç‚¹","like_count":6,"discussions":[{"author":{"id":1411419,"avatar":"https://static001.geekbang.org/account/avatar/00/15/89/5b/b014ce14.jpg","nickname":"å°äº”","note":"","ucode":"B7B1F121837CD9","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392970,"discussion_content":"åè®®ç¼–è§£ç å¯ä»¥æ¢è®¨ä¸‹","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1631192684,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":311358,"user_name":"é‡Œå’¯ç ´","can_delete":false,"product_type":"c1","uid":1224546,"ip_address":"","ucode":"2DA41A6D44B3C4","user_header":"https://static001.geekbang.org/account/avatar/00/12/af/62/5eeb9041.jpg","comment_is_top":false,"comment_ctime":1631186048,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5926153344","product_id":100084301,"comment_content":"redis6åˆšå‡ºæ—¶ç”¨redis-benchmark æµ‹è¯•è¿‡,çš„ç¡®ä¼šæœ‰æå‡,getèƒ½æœ‰å°†è¿‘ä¸€å€,setæ ¹æ®æ•°æ®é‡ä¸åŒæœ‰20%~40%çš„æå‡.ä½†æ˜¯åªæ˜¯å•æœºæµ‹è¯•,æ²¡æœ‰è€ƒè™‘ç½‘ç»œç¯å¢ƒ.","like_count":1},{"had_liked":false,"id":310710,"user_name":"åœŸè±†ç§å—åŸ","can_delete":false,"product_type":"c1","uid":2719230,"ip_address":"","ucode":"0CE8E5EDEB452B","user_header":"https://static001.geekbang.org/account/avatar/00/29/7d/fe/2220c6cf.jpg","comment_is_top":false,"comment_ctime":1630853321,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"5925820617","product_id":100084301,"comment_content":"å›ç­”è¯¾åé¢˜ï¼šä¸ºä»€ä¹ˆ startThreadedIO &#47; stopThreadedIO è¦æ‰§è¡ŒåŠ è§£é”ï¼Ÿ<br>å‡ ä¸ªè¯„è®ºéƒ½æåˆ°è¿™éƒ¨åˆ†ä»£ç ï¼š<br><br>&#47;* Give the main thread a chance to stop this thread. *&#47;<br>if (io_threads_pending[id] == 0) {<br>    pthread_mutex_lock(&amp;io_threads_mutex[id]);<br>    pthread_mutex_unlock(&amp;io_threads_mutex[id]);<br>    continue;<br>}<br>æˆ‘è§‰å¾—å…‰çœ‹è¿™é‡Œè¿˜ä¸å¤Ÿï¼Œè¿˜åº”è¯¥ç»“åˆè¿™éƒ¨åˆ†ä»£ç çš„å‰é¢ä¸€æ®µæ¥çœ‹ï¼š<br><br>&#47;* Wait for start *&#47;<br>for (int j = 0; j &lt; 1000000; j++) {<br>    if (getIOPendingCount(id) != 0) break;<br>}<br>&#47;* Give the main thread a chance to stop this thread. *&#47;<br>if (io_threads_pending[id] == 0) {<br>    pthread_mutex_lock(&amp;io_threads_mutex[id]);<br>    pthread_mutex_unlock(&amp;io_threads_mutex[id]);<br>    continue;<br>}<br>æ€»ä½“é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œioå­çº¿ç¨‹å¯åŠ¨åç›´æ¥ä¸€å…¥ä¸€æ®µâ€œç‹‚çƒ­â€æ—¶é—´ï¼Œå­çº¿ç¨‹ä¼šç§¯æå“åº”ä¸»çº¿ç¨‹è®¾ç½®çš„ä»»åŠ¡ã€‚ä½†æ˜¯å¦‚æœä¸€æ®µæ—¶é—´ï¼ˆä¸€ç™¾ä¸‡æ¬¡å¾ªç¯ï¼‰ä¹‹åä»»åŠ¡æ•°é‡è¿˜æ˜¯0ä¼šå‘ç”Ÿä¸¤ç§æƒ…å†µï¼š<br><br>1. ä¸»çº¿ç¨‹æ²¡æ‰“å¼€å¤šçº¿ç¨‹æ¨¡å¼ï¼ˆæ²¡æœ‰è°ƒç”¨è¿‡startThreadedIOï¼‰ï¼Œè¿™æƒ…å†µå¯èƒ½æ˜¯ä¸»çº¿ç¨‹æœ¬èº«å°±æ²¡æ”¶åˆ°ä»»ä½•è¯·æ±‚ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸»çº¿ç¨‹è§‰å¾—ä¸éœ€è¦å­çº¿ç¨‹æ¥å¤„ç†ï¼ˆstopThreadedIOIfNeededï¼‰<br>2. ä¸»çº¿ç¨‹æ‰“å¼€äº†å¤šçº¿ç¨‹æ¨¡å¼ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠè°ƒç”¨setIOPendingCountè®¾ç½®ä»»åŠ¡<br>1æƒ…å†µä¸‹pthread_mutex_lockä¼šé˜»å¡å­çº¿ç¨‹ï¼Œç›¸å½“äºå­çº¿ç¨‹è¿›å…¥æ²‰ç¡çŠ¶æ€äº†<br>2æƒ…å†µä¸‹ä¸ä¼šé˜»å¡å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹è¿›å…¥ä¸‹æ¬¡å¾ªç¯ï¼Œä¾ç„¶å¤„äºâ€œç‹‚çƒ­â€çŠ¶æ€ï¼Œåªè¦ä¸»çº¿ç¨‹è°ƒç”¨setIOPendingCountå°±å¯ä»¥ç«‹å³å·¥ä½œ<br>ç»¼ä¸Šï¼ŒstartThreadedIOçš„è§£é”æ“ä½œç›¸å½“äºæ˜¯â€œå”¤é†’â€äº†å­çº¿ç¨‹åœ¨â€œç‹‚çƒ­â€çŠ¶æ€æœªæ»¡è¶³ä¸‹è¿›å…¥çš„æ²‰ç¡ã€‚stopThreadedIOèƒ½è®©å­çº¿ç¨‹åœ¨ä¸€ä¸ªé˜¶æ®µçš„â€œç‹‚çƒ­â€ç»“æŸåè¿›å…¥æ²‰ç¡","like_count":1},{"had_liked":false,"id":308743,"user_name":"å¯æ€œå¤§ç°ç‹¼","can_delete":false,"product_type":"c1","uid":1928373,"ip_address":"","ucode":"6CA9D6D460B967","user_header":"https://static001.geekbang.org/account/avatar/00/1d/6c/b5/32374f93.jpg","comment_is_top":false,"comment_ctime":1629778956,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"5924746252","product_id":100084301,"comment_content":"networking.cä¸­IOThreadMainæ–¹æ³•æœ‰å¦‚ä¸‹ä¸€å°æ®µä»£ç ï¼š<br>&#47;* Give the main thread a chance to stop this thread. *&#47;<br>if (getIOPendingCount(id) == 0) {<br>       pthread_mutex_lock(&amp;io_threads_mutex[id]);<br>       pthread_mutex_unlock(&amp;io_threads_mutex[id]);<br>       continue;<br> }<br>å°±åƒä»£ç é‡Œè¯´çš„ï¼Œç»™ä¸»çº¿ç¨‹æš‚åœå­çº¿ç¨‹çš„æœºä¼šã€‚<br>å¦‚æœä¸»çº¿ç¨‹æ²¡æœ‰åœ¨startThreadedIOåšunlockå’Œåœ¨stopThreadedIOåšlockï¼Œä¸»çº¿ç¨‹ä¹Ÿæ— æ³•æš‚åœå’Œå¼€å§‹å­çº¿ç¨‹ï¼Œè¿›è€Œä¼šå¯¼è‡´cpuèµ„æºæµªè´¹ã€‚","like_count":1},{"had_liked":false,"id":349603,"user_name":"æ°´æ»´s","can_delete":false,"product_type":"c1","uid":1264431,"ip_address":"","ucode":"1C684514B54B6F","user_header":"https://static001.geekbang.org/account/avatar/00/13/4b/2f/2f73fd52.jpg","comment_is_top":false,"comment_ctime":1656131265,"is_pvip":false,"discussion_count":1,"race_medal":0,"score":"1656131265","product_id":100084301,"comment_content":"åˆ¤æ–­æ‰€æœ‰å¤šçº¿ç¨‹æ˜¯å¦å¤„ç†å®Œè¯»ï¼Œè¿™é‡Œä¸ä¼šé€ æˆCPUå¿™ç­‰å¾…å—ï¼Œä¸ºå•¥ä¸ä½¿ç”¨é”æ¡ä»¶å˜é‡å®ç°å‘¢ï¼Ÿ<br> while(1) {<br>        unsigned long pending = 0;<br>        for (int j = 1; j &lt; server.io_threads_num; j++)<br>            pending += io_threads_pending[j];<br>        if (pending == 0) break;<br>    }","like_count":0,"discussions":[{"author":{"id":2420294,"avatar":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","nickname":"æœ¨å‡ ä¸¶","note":"","ucode":"FFDB958DA64F8C","race_medal":5,"user_type":1,"is_pvip":true},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":578204,"discussion_content":"è¿™å°±ç±»ä¼¼äºè‡ªæ—‹é”ï¼Œå¦‚æœèƒ½é¢„è§ä¸ä¼šç­‰å¤ªä¹…ï¼Œé‚£ä¹ˆCPUç©ºè½¬çš„æ¶ˆè€—è¦æ¯”åŠ é”æ¶ˆè€—è¦å°ã€‚\næ€ä¹ˆé¢„è§ä¸ä¼šç­‰å¤ªä¹…å‘¢ï¼Œå› ä¸ºä¸»çº¿ç¨‹ä¹Ÿå‚ä¸IOæ“ä½œï¼Œæ¯ä¸ªçº¿ç¨‹çš„ä»»åŠ¡æ˜¯è½®è¯¢åˆ†é…çš„ï¼Œæ‰€ä»¥åˆ†é…åˆ°çš„ä»»åŠ¡å‡ ä¹ç›¸ç­‰ï¼Œä¸»çº¿ç¨‹ç»“æŸäº†é‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¹Ÿå·®ä¸å¤šç»“æŸäº†","likes_number":2,"is_delete":false,"is_hidden":false,"ctime":1656578750,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":339655,"user_name":"ğŸŸğŸ™ğŸ¬ğŸ†ğŸ¦ŒğŸ¦ğŸ‘ğŸ¦ƒ","can_delete":false,"product_type":"c1","uid":1531189,"ip_address":"","ucode":"2F954654BCE13B","user_header":"https://static001.geekbang.org/account/avatar/00/17/5d/35/b1eb964a.jpg","comment_is_top":false,"comment_ctime":1648278332,"is_pvip":true,"discussion_count":1,"race_medal":0,"score":"1648278332","product_id":100084301,"comment_content":"handleClientsWithPendingReadsUsingThreads åœ¨æŠŠclients_pending_read æ”¾åˆ°io_threads_list æ—¶ï¼Œä¸ºå•¥ä¸åŠ é”ï¼Œä¸»çº¿ç¨‹æ”¾ï¼Œæ¶ˆè´¹çº¿ç¨‹è¯»å–æ—¶ï¼Œä¸ä¼šæœ‰é—®é¢˜ä¹ˆï¼ŒåŠ å…¥æ—¶ï¼Œæœ‰æŒ‡é’ˆçš„å˜æ›´","like_count":0,"discussions":[{"author":{"id":3014676,"avatar":"","nickname":"Geek_ceac35","note":"","ucode":"51759F85EEA785","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":574195,"discussion_content":"å› ä¸ºä»£ç æ‰§è¡Œé¡ºåºä¸¥æ ¼ä¿è¯äº†å…ˆç”Ÿäº§åæ¶ˆè´¹ï¼Œæœ‰ä¸€ä¸ªå˜é‡è®°å½•io_threads_list ä»»åŠ¡æ•°é‡ï¼Œæ•°é‡å¤§äº0æ‰å¼€å§‹æ¶ˆè´¹ï¼Œè¿™ä¸ªå˜é‡æ›´æ–°æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1653894434,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":331901,"user_name":"YFW","can_delete":false,"product_type":"c1","uid":1781486,"ip_address":"","ucode":"CFCF76BE99C4A4","user_header":"https://static001.geekbang.org/account/avatar/00/1b/2e/ee/3457154b.jpg","comment_is_top":false,"comment_ctime":1642859812,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1642859812","product_id":100084301,"comment_content":"è€å¸ˆçœ‹äº†æ–‡ç« è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Ÿ è¿˜æœ›è§£ç­”ï¼Œ ä¸»çº¿ç¨‹åœ¨è°ƒç”¨ å‡½æ•°initThreadedIO çš„æ—¶å€™ï¼Œä¼šç»™ io_threads_mutex[i]è¿›è¡ŒåŠ é”ï¼Œ <br>è¿™ä¸ªæ—¶å€™IOå­çº¿ç¨‹å°±æ— æ³•è·å–åˆ°é”ï¼Œåªæœ‰åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ startThreadedIO ä¸­æ‰ä¼šæŠŠè¿™äº›é”é‡Šæ”¾ï¼Œ<br>æ­¤æ—¶IOå­çº¿ç¨‹æ‰èƒ½å¤Ÿç»§ç»­è¿è¡Œï¼Œ æŸ¥çœ‹äº†æºç å‘ç°startThreadedIOåªä¼šåœ¨å‡½æ•°handleClientsWithPendingWritesUsingThreadsä¸­è¢«è°ƒç”¨ï¼Œ<br>é‚£å¦‚æœåªæœ‰å¯è¯»äº‹ä»¶ï¼Œ IOå­çº¿ç¨‹ä¸å°±ä¸€ç›´pending åœ¨ io_threads_mutex[i] ä¸Šï¼Ÿ","like_count":0},{"had_liked":false,"id":320872,"user_name":"ikel","can_delete":false,"product_type":"c1","uid":1009002,"ip_address":"","ucode":"1D5CE7803C1C2B","user_header":"https://static001.geekbang.org/account/avatar/00/0f/65/6a/be36c108.jpg","comment_is_top":false,"comment_ctime":1636535572,"is_pvip":false,"discussion_count":0,"race_medal":0,"score":"1636535572","product_id":100084301,"comment_content":"ä½ çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªå‡½æ•°è¦æ‰§è¡Œè§£é”å’ŒåŠ é”æ“ä½œä¹ˆï¼Ÿ<br>è®©å¤šçº¿ç¨‹æ¨¡å¼ä¸‹çš„éƒ¨åˆ†å­çº¿ç¨‹ä¼‘çœ ä»¥é‡Šæ”¾cpuèµ„æº<br>åœ¨networking,cæ–‡ä»¶ä¸­_Atomic unsigned long io_threads_pending[IO_THREADS_MAX_NUM]ä¸­_Atomicç”¨æ³•æ˜¯ç±»ä¼¼äºå¤šçº¿ç¨‹ä¸­é”çš„ä½œç”¨ä¹ˆï¼Ÿè¿™ä¸ªç”¨æ³•æ²¡æŸ¥åˆ°ç›¸å…³èµ„æ–™","like_count":0},{"had_liked":false,"id":311940,"user_name":"Geek_3930c2","can_delete":false,"product_type":"c1","uid":2748958,"ip_address":"","ucode":"5E8613350AD334","user_header":"","comment_is_top":false,"comment_ctime":1631539219,"is_pvip":false,"discussion_count":2,"race_medal":0,"score":"1631539219","product_id":100084301,"comment_content":"io_threads_opä¸ºå•¥ä¸ç”¨volatileä¿®æ”¹","like_count":0,"discussions":[{"author":{"id":1043475,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg","nickname":"neohope","note":"","ucode":"C0268F6E7E2B6E","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548784,"discussion_content":"æ²¡æœ‰å¿…è¦ï¼Œå› ä¸ºä¸å­˜åœ¨å¤šçº¿ç¨‹ä¿®æ”¹çš„æƒ…å†µï¼Œæ¯æ¬¡ä»»åŠ¡åˆ†é…å®Œæ¯•ï¼Œä¸»IOçº¿ç¨‹æ˜¯ç­‰å¾…æ‰€æœ‰IOçº¿ç¨‹ç»“æŸï¼Œæ‰ç»§ç»­æ‰§è¡Œçš„","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1643364930,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":2056719,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8KQ5icwVzutPswKdktQQy8GAUI3nkssDxQiauiaqGnlPv5ld6FUM6uQZziczH5smEqhky3DjMFBhAzQ/132","nickname":"å˜å˜å˜","note":"","ucode":"8744C000DFEA06","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":394069,"discussion_content":"åŒé—®","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1631707897,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":""},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":308690,"user_name":"Milittle","can_delete":false,"product_type":"c1","uid":1045455,"ip_address":"","ucode":"80E566639A8ABB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/f3/cf/851dab01.jpg","comment_is_top":false,"comment_ctime":1629739609,"is_pvip":true,"discussion_count":0,"race_medal":0,"score":"1629739609","product_id":100084301,"comment_content":"è¯¾åé¢˜æˆ‘çš„çŒœæµ‹ï¼šå°±æ˜¯å¯¹äºä¸€ä¸ªçº¿ç¨‹å®Œæ•´çš„é‡Šæ”¾å’Œè§¦å‘ï¼Œå¯åŠ¨çº¿ç¨‹ï¼Œå°†çº¿ç¨‹çš„mutexé‡Šæ”¾ï¼Œæ„å‘³ç€ä½ åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ï¼Œå»è®¿é—®ä¸€äº›å…±äº«èµ„æºï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªmutexã€‚å…³é—­çº¿ç¨‹ï¼Œå°†çº¿ç¨‹çš„mutexè·å–ï¼Œè®©çº¿ç¨‹ä¸­å…¶ä»–è·å–mutexçš„èƒ½åŠ›å¤±æ•ˆã€‚ä¸€ç‚¹çŒœæµ‹ï¼Œä¸çŸ¥é“å¯¹ä¸å¯¹ã€‚","like_count":0}]}