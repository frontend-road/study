{"id":739349,"title":"10ï½œServlet Wrapperï¼šå¦‚ä½•ç»´æŠ¤Servletç”Ÿå‘½å‘¨æœŸåŠå®ç°å®¹å™¨ç®¡ç†ï¼Ÿ","content":"<p>ä½ å¥½ï¼Œæˆ‘æ˜¯éƒ­å±¹ã€‚ä»Šå¤©æˆ‘ä»¬ç»§ç»­æ‰‹å†™MiniTomcatã€‚</p><p>ä¸ŠèŠ‚è¯¾æˆ‘ä»¬æŠŠRequestå’ŒResponseä»æ— çŠ¶æ€å˜æˆäº†æœ‰çŠ¶æ€ï¼Œå®ç°äº†Sessionå’ŒCookieçš„ç®¡ç†ï¼Œè¿˜å®ç°äº†åŒä¸€é¡µé¢çš„èµ„æºè¯·æ±‚å¤ç”¨Socketï¼Œå‡å°‘äº†æ€§èƒ½æ¶ˆè€—ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬å°†æµè§ˆå™¨ä¸æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡å¤„ç†å®Œæ¯•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹åç«¯æœåŠ¡å™¨ï¼Œç°åœ¨æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ServletProcessorç®€å•åœ°è°ƒç”¨Servletçš„serviceæ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å°†å…¶æ‰©å±•ï¼Œå¯¹Servletè¿›è¡Œç®¡ç†ï¼Œè¿™å°±å¼•å…¥äº†Containerå®¹å™¨çš„æ¦‚å¿µã€‚<strong>æˆ‘ä»¬è®¡åˆ’è®©Containerå’ŒConnectoré…åˆåœ¨ä¸€èµ·å·¥ä½œï¼Œå‰è€…è´Ÿè´£åç«¯Servletç®¡ç†ï¼Œè€Œåè€…åˆ™è´Ÿè´£é€šä¿¡ç®¡ç†ã€‚</strong></p><p><img src=\"https://static001.geekbang.org/resource/image/6e/42/6e0069a19d16f6ddf482820a06b8d242.png?wh=1920x998\" alt=\"å›¾ç‰‡\"></p><p>åˆæ­¥æ„å»ºå®¹å™¨åï¼Œæˆ‘ä»¬è¿˜ä¼šè€ƒè™‘ä½¿ç”¨Wrapperè¿›è¡ŒåŒ…è£…ï¼Œç”¨äºç»´æŠ¤Servletçš„ç”Ÿå‘½å‘¨æœŸï¼šåˆå§‹åŒ–ã€æä¾›æœåŠ¡ã€é”€æ¯è¿™ä¸ªå…¨è¿‡ç¨‹ï¼ŒæŠŠServletå®Œå…¨çº³å…¥ç¨‹åºè‡ªåŠ¨ç®¡ç†ä¹‹ä¸­ï¼Œè®©åº”ç”¨ç¨‹åºå‘˜æ›´å°‘åœ°æ„ŸçŸ¥åˆ°åº•å±‚çš„é…ç½®ï¼Œæ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘æœ¬èº«ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥åŠ¨æ‰‹å®ç°ã€‚</p><h2>é¡¹ç›®ç»“æ„</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬æ–°å¢ServletContainerä¸ServletWrapperä¸¤ä¸ªç±»ï¼Œåˆ†åˆ«å®šä¹‰Containerä¸Wrapperï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ç°åœ¨çš„ç¨‹åºç»“æ„ã€‚</p><!-- [[[read_end]]] --><pre><code class=\"language-plain\">MiniTomcat\nâ”œâ”€ src\nâ”‚  â”œâ”€ main\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ server\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ CookieTools.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ DefaultHeaders.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpConnector.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpHeader.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequest.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpRequestLine.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponse.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpResponseFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HttpServer.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Request.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletContainer.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Response.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletProcessor.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ ServletWrapper.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ Session.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ SessionFacade.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ SocketInputStream.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ StatisResourceProcessor.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ java\nâ”‚  â”‚  â”‚  â”œâ”€ test\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ HelloServlet.java\nâ”‚  â”‚  â”‚  â”‚  â”œâ”€ TestServlet.java\nâ”‚  â”‚  â”œâ”€ resources\nâ”œâ”€ webroot\nâ”‚  â”œâ”€ test\nâ”‚  â”‚  â”œâ”€ HelloServlet.class\nâ”‚  â”‚  â”œâ”€ TestServlet.class\nâ”‚  â”œâ”€ hello.txt\nâ”œâ”€ pom.xml\n</code></pre><h2>Containerâ€”â€”Servletç®¡ç†å®¹å™¨</h2><p>åœ¨æ”¹é€ ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå…³æ³¨ä¸€ä¸‹æ•´ä¸ªServerçš„å¯åŠ¨ç±»â€”â€”HttpServerã€‚ç›®å‰ï¼Œæˆ‘ä»¬çš„å¯åŠ¨ç±»æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œmainå‡½æ•°å†…åªæœ‰ä¸¤è¡Œã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpServer {\n&nbsp; &nbsp; public static void main(String[] args) {\n&nbsp; &nbsp; &nbsp; &nbsp; HttpConnector connector = new HttpConnector();\n&nbsp; &nbsp; &nbsp; &nbsp; connector.start();\n&nbsp; &nbsp; }\n}\n</code></pre><p>é€šè¿‡ä»£ç å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬Serverçš„èµ·ç‚¹å°±æ˜¯HttpConnectorï¼Œæ‰€ä»¥ä¹‹å‰å¯¹Servletçš„ç®¡ç†ä¹Ÿå…¨æ˜¯äº¤ç”±Connectorè¿›è¡Œå¤„ç†ï¼Œä¸è¿‡è¿™å¹¶ä¸å¥½ï¼Œè§’è‰²æ··åˆäº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯å¼•å…¥Containerå®¹å™¨è¿™ä¸ªæ¦‚å¿µï¼Œå°†Servletç®¡ç†å’Œç½‘ç»œé€šä¿¡åŠŸèƒ½ä¸€åˆ†ä¸ºäºŒã€‚</p><p>é¦–å…ˆæ˜¯å®šä¹‰ServletContainerç±»ã€‚</p><pre><code class=\"language-java\">package server;\n//Servletå®¹å™¨\npublic class ServletContainer {\n    HttpConnector connector = null;\n    ClassLoader loader = null;\n    //åŒ…å«servletç±»å’Œå®ä¾‹çš„map\n    Map&lt;String,String&gt; servletClsMap = new ConcurrentHashMap&lt;&gt;(); //servletName - ServletClassName\n    Map&lt;String,Servlet&gt; servletInstanceMap = new ConcurrentHashMap&lt;&gt;();//servletName - servlet\n    public ServletContainer() {\n        try {\n            // create a URLClassLoader\n            URL[] urls = new URL[1];\n            URLStreamHandler streamHandler = null;\n            File classPath = new File(HttpServer.WEB_ROOT);\n            String repository = (new URL(\"file\", null, classPath.getCanonicalPath() + File.separator)).toString() ;\n            urls[0] = new URL(null, repository, streamHandler);\n            loader = new URLClassLoader(urls);\n        } catch (IOException e) {\n            System.out.println(e.toString() );\n        }\n    }\n    public String getInfo() {\n        return null;\n    }\n    public ClassLoader getLoader(){\n        return this.loader;\n    }\n    public void setLoader(ClassLoader loader) {\n        this.loader = loader;\n    }\n    public HttpConnector getConnector() {\n        return connector;\n    }\n    public void setConnector(HttpConnector connector) {\n        this.connector = connector;\n    }\n    public String getName() {\n        return null;\n    }\n    public void setName(String name) {\n    }\n    //invokeæ–¹æ³•ç”¨äºä»mapä¸­æ‰¾åˆ°ç›¸å…³çš„servletï¼Œç„¶åè°ƒç”¨\n    public void invoke(HttpRequest request, HttpResponse response)\n            throws IOException, ServletException {\n        Servlet servlet = null;\n        ClassLoader loader = getLoader();\n        String uri = request.getUri();\n        String servletName = uri.substring(uri.lastIndexOf(\"/\") + 1);\n        String servletClassName = servletName;\n        servlet = servletInstanceMap.get(servletName);\n        //å¦‚æœå®¹å™¨å†…æ²¡æœ‰è¿™ä¸ªservletï¼Œå…ˆè¦loadç±»ï¼Œåˆ›å»ºæ–°å®ä¾‹\n        if (servlet == null) {\n            Class&lt;?&gt; servletClass = null;\n            try {\n                servletClass = loader.loadClass(servletClassName);\n            } catch (ClassNotFoundException e) {\n                System.out.println(e.toString());\n            }\n            try {\n                servlet = (Servlet) servletClass.newInstance();\n            } catch (InstantiationException e) {\n                e.printStackTrace();\n            } catch (IllegalAccessException e) {\n                e.printStackTrace();\n            }\n            servletClsMap.put(servletName, servletClassName);\n            servletInstanceMap.put(servletName, servlet);\n            //æŒ‰ç…§è§„èŒƒï¼Œåˆ›å»ºæ–°å®ä¾‹çš„æ—¶å€™éœ€è¦è°ƒç”¨init()\n            servlet.init(null);\n        }\n        //ç„¶åè°ƒç”¨service()\n        try {\n            HttpRequestFacade requestFacade = new HttpRequestFacade(request);\n            HttpResponseFacade responseFacade = new HttpResponseFacade(response);\n            System.out.println(\"Call service()\");\n            servlet.service(requestFacade, responseFacade);\n        }\n        catch (Exception e) {\n            System.out.println(e.toString());\n        }\n        catch (Throwable e) {\n            System.out.println(e.toString());\n        }\n    }\n}\n</code></pre><p>ä»ServletContainerçš„ä»£ç é‡Œï¼Œæˆ‘ä»¬åˆçœ‹åˆ°äº†ç†Ÿæ‚‰çš„é¢å­”â€”â€”ClassLoaderï¼Œæ­¤å‰å°†ClassLoaderç›´æ¥äº¤ç”±HttpConnectorç®¡ç†ï¼Œå®šä¹‰äº†åŸŸã€‚</p><pre><code class=\"language-java\">public static URLClassLoader loader = null;\n</code></pre><p>ç°åœ¨è¿›è¡Œæ”¹é€ ï¼Œç”¨æ–°åˆ›å»ºçš„ServletContainerç±»ç®¡ç†ClassLoaderï¼Œå¹¶æä¾›å¯¹åº”çš„ <code>getLoader()</code> å’Œ <code>setLoader()</code> æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿå°†åŸæ¥åœ¨ServletProcessorå†…è°ƒç”¨Servletçš„ä»£ç æŒªåˆ°ServletContainerçš„ <code>invoke()</code> æ–¹æ³•ä¸­ã€‚</p><p>ä¹‹å‰åœ¨è°ƒç”¨ <code>invoke()</code> æ–¹æ³•æ—¶ï¼Œæ¯æ¬¡éƒ½æ˜¯åŠ è½½Servletçš„ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶è°ƒç”¨serviceæ–¹æ³•ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¿›ä¸€æ­¥æŠŠServletæ”¾åˆ°Mapä¸­å­˜èµ·æ¥ï¼ŒåŒ…å«å¤šServletå®ä¾‹ï¼Œå…¶ä¸­servletClsMapç”¨äºå­˜å‚¨Servletåç§°ä¸Servletç±»åçš„æ˜ å°„å…³ç³»ï¼Œè€ŒservletInstanceMapç”¨äºå­˜å‚¨Servletåç§°ä¸å…·ä½“Servletå¯¹è±¡çš„æ˜ å°„å…³ç³»ã€‚</p><p>è¿™æ ·æ”¹é€ åï¼Œå½“ <code>invoke()</code> æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå¦‚æœæœ‰Servletå®ä¾‹ï¼Œå°±ç›´æ¥è°ƒç”¨ <code>service()</code>ï¼Œå¦‚æœæ²¡æœ‰å®ä¾‹ï¼Œå°±åŠ è½½å¹¶åˆ›å»ºå®ä¾‹ï¼Œå¹¶è°ƒç”¨ <code>init()</code> è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚</p><p>ç°åœ¨ServletProcessorå¯ä»¥å°½å¯èƒ½åœ°ç®€åŒ–äº†ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ç®€åŒ–åçš„ä»£ç ã€‚</p><pre><code class=\"language-java\">package server;\npublic class ServletProcessor {\n    private HttpConnector connector;\n    public ServletProcessor(HttpConnector connector) {\n        this.connector = connector;\n    }\n    public void process(HttpRequest request, HttpResponse response) throws IOException, ServletException {\n        this.connector.getContainer().invoke(request, response);\n    }\n}\n</code></pre><p>åœ¨ServletProcessorä¸­æˆ‘ä»¬å®šä¹‰äº†ä¼ å…¥Connectorçš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥åœ¨Processorä»£ç ä¸­ï¼Œéœ€è¦è°ƒæ•´åˆå§‹åŒ–Processorçš„ä»£ç ã€‚</p><pre><code class=\"language-java\">if (request.getUri().startsWith(\"/servlet/\")) {\n    ServletProcessor processor = new ServletProcessor(this.connector);\n    processor.process(request, response);\n}\n</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†è½¬å‘HttpConnectorã€‚åœ¨å®šä¹‰äº†Containerä¹‹åï¼Œè‡ªç„¶åœ°ï¼Œè¦æŠŠContainerå’ŒConnectorç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬åœ¨HttpConnectorä¸­æ”¹ä¸€ä¸‹ä»£ç ã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpConnector implements Runnable {\n    int minProcessors = 3;\n    int maxProcessors = 10;\n    int curProcessors = 0;\n    Deque&lt;HttpProcessor&gt; processors = new ArrayDeque&lt;&gt;();\n    public static Map&lt;String, HttpSession&gt; sessions = new ConcurrentHashMap&lt;&gt;();\n    //è¿™æ˜¯ä¸connectorç›¸å…³è”çš„container\n    ServletContainer container = null;\n    public void run() {\n        ServerSocket serverSocket = null;\n        int port = 8080;\n        try {\n            serverSocket = new ServerSocket(port, 1, InetAddress.getByName(\"127.0.0.1\"));\n        } catch (IOException e) {\n            e.printStackTrace();\n            System.exit(1);\n        }\n        // initialize processors pool\n        for (int i = 0; i &lt; minProcessors; i++) {\n            HttpProcessor initprocessor = new HttpProcessor(this);\n            initprocessor.start();\n            processors.push(initprocessor);\n        }\n        curProcessors = minProcessors;\n        while (true) {\n            Socket socket = null;\n            try {\n                socket = serverSocket.accept();\n                HttpProcessor processor = createProcessor();\n                if (processor == null) {\n                    socket.close();\n                    continue;\n                }\n                processor.assign(socket);\n                // Close the socket\n//                socket.close();\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n        }\n    }\n    public void start() {\n        Thread thread = new Thread(this);\n        thread.start();\n    }\n    public ServletContainer getContainer() {\n        return container;\n    }\n    public void setContainer(ServletContainer container) {\n        this.container = container;\n    }\n}\n</code></pre><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæ–°å¢äº†ServletContainerç±»å‹çš„containerå±æ€§ï¼Œæ·»åŠ äº†å¯¹åº” <code>getContainer()</code> ä¸ <code>setContainer()</code> æ–¹æ³•ï¼Œç§»é™¤äº†åŸæœ¬å¤„ç†Classloaderçš„ç›¸å…³ä»£ç ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒæ•´HttpServeré‡Œçš„ä»£ç ï¼Œæ‹†åˆ†åŠŸèƒ½äº†ã€‚</p><pre><code class=\"language-java\">package server;\npublic class HttpServer {\n    public static final String WEB_ROOT =\n            System.getProperty(\"user.dir\") + File.separator + \"webroot\";\n    public static void main(String[] args) {\n        //åˆ›å»ºconnectorå’Œcontainer\n        HttpConnector connector = new HttpConnector();\n        ServletContainer container = new ServletContainer();\n        //connectorå’Œcontaineräº’ç›¸æŒ‡å¼•\n        connector.setContainer(container);\n        container.setConnector(connector);\n        connector.start();\n    }\n}\n</code></pre><p>è¿™é‡Œæˆ‘ä»¬è¿›ä¸€æ­¥æ‹†åˆ†äº†HttpConnectorï¼Œåšåˆ°äº†ServletContainerç®¡ç†Servletï¼ŒHttpConnectorè´Ÿè´£é€šä¿¡ç®¡ç†ï¼Œå„å¸å…¶èŒã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘æƒ³å¤šè¯´å‡ å¥ã€‚è½¯ä»¶ç»“æ„åº”è¯¥æ€ä¹ˆè¿›è¡Œæ‹†åˆ†ï¼Ÿæˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°å°†ä¸€ä¸ªè½¯ä»¶å½“æˆä¸€ä¸ªå…¬å¸æˆ–è€…ä¸€ä¸ªå›¢ä½“ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå²—ä½å’Œäººï¼Œå¦‚æœåœ¨å…¬å¸é‡Œéœ€è¦å°†æŸä¸€ä¸ªå·¥ä½œä¸“é—¨äº¤ç”±ä¸“äººè´Ÿè´£ï¼Œå°±å¯ä»¥è®¾ç½®ä¸€ä¸ªå²—ä½ï¼Œç±»æ¯”è½¯ä»¶ç»“æ„ï¼Œå°±æ˜¯åœ¨è½¯ä»¶ä¸­æ–°æ·»åŠ ä¸€ä¸ªç±»ï¼Œä¸€ä¸ªç±»å°±æ˜¯ä¸€ä¸ªå²—ä½ã€‚è¿™ç§æ‹ŸäººåŒ–çš„æ€è€ƒæ–¹å¼å¯¹æˆ‘ä»¬åˆ†æè½¯ä»¶ç»“æ„å¾ˆæœ‰å¸®åŠ©ã€‚</p><h2>Wrapperâ€”â€”å¢å¼ºServletç®¡ç†</h2><p>åˆšåˆšæˆ‘ä»¬å·²ç»ä½¿ç”¨Containerå®ç°äº†Servletçš„ç®¡ç†ï¼Œæˆ‘ä»¬ç»§ç»­å…³æ³¨è¿™ä¸€éƒ¨åˆ†ï¼Œ<strong>é‡‡ç”¨WrapperåŒ…è£…ï¼Œç”¨æ¥ç»´æŠ¤Servletçš„ç”Ÿå‘½å‘¨æœŸ</strong>ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆä¸€ä¸ªWrapperå‘¢ï¼Ÿä»åŠŸèƒ½è§’åº¦ï¼Œä¸å¼•å…¥å®ƒä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœæ²¡æœ‰Wrapperï¼Œæˆ‘ä»¬å°±å¾—åœ¨Containerè¿™ä¸ªå®¹å™¨é‡Œç›´æ¥ç®¡ç†Servletï¼Œè¿™ç›¸å½“äºåœ¨ä¸€ä¸ªå¤§çš„çº¸ç›’å­ä¸­ç›´æ¥æ”¾ä¸Šå¾ˆå¤šå°ç©å…·ï¼Œæ¯”è¾ƒç¹çã€‚</p><p>æ‰€ä»¥è¶…å¸‚ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæ–¹æ¡ˆï¼šæ¯ä¸ªå°ç©å…·å¤–é¢å¥—ä¸€ä¸ªåŒ…è£…ï¼Œæ¯”å¦‚å°ç›’å­æˆ–è€…æ˜¯å¡‘æ–™è¢‹å­ï¼Œå†å°†è¿™äº›å°ç›’å­æˆ–è€…è¢‹å­æ”¾åœ¨å¤§çº¸ç›’ä¸­ï¼Œæ–¹ä¾¿äººä»¬æ‹¿å–ã€‚è¿™ä¸ªWrapperä¹Ÿæ˜¯åŒæ ·çš„æ€è·¯ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥å®šä¹‰ServletWrapperç±»ã€‚</p><pre><code class=\"language-java\">package server;\npublic class ServletWrapper {\n    private Servlet instance = null;\n    private String servletClass;\n    private ClassLoader loader;\n    private String name;\n    protected ServletContainer parent = null;\n    public ServletWrapper(String servletClass, ServletContainer parent) {\n        this.parent = parent;\n        this.servletClass = servletClass;\n        try {\n            loadServlet();\n        } catch (ServletException e) {\n            e.printStackTrace();\n        }\n    }\n    public ClassLoader getLoader() {\n        if (loader != null)\n            return loader;\n        return parent.getLoader();\n    }\n    public String getServletClass() {\n        return servletClass;\n    }\n    public void setServletClass(String servletClass) {\n        this.servletClass = servletClass;\n    }\n    public ServletContainer getParent() {\n        return parent;\n    }\n    public void setParent(ServletContainer container) {\n        parent = container;\n    }\n    public Servlet getServlet(){\n        return this.instance;\n    }\n    public Servlet loadServlet() throws ServletException {\n        if (instance!=null)\n            return instance;\n        Servlet servlet = null;\n        String actualClass = servletClass;\n        if (actualClass == null) {\n            throw new ServletException(\"servlet class has not been specified\");\n        }\n        ClassLoader classLoader = getLoader();\n        Class classClass = null;\n        try {\n            if (classLoader!=null) {\n                classClass = classLoader.loadClass(actualClass);\n            }\n        }\n        catch (ClassNotFoundException e) {\n            throw new ServletException(\"Servlet class not found\");\n        }\n        try {\n            servlet = (Servlet) classClass.newInstance();\n        }\n        catch (Throwable e) {\n            throw new ServletException(\"Failed to instantiate servlet\");\n        }\n        try {\n            servlet.init(null);\n        }\n        catch (Throwable f) {\n            throw new ServletException(\"Failed initialize servlet.\");\n        }\n        instance =servlet;\n        return servlet;\n    }\n    public void invoke(HttpServletRequest request, HttpServletResponse response)\n            throws IOException, ServletException {\n        if (instance != null) {\n            instance.service(request, response);\n        }\n    }\n}\n</code></pre><p>åœ¨ServletWrapperç±»ä¸­ï¼Œæ ¸å¿ƒåœ¨äº <code>loadServlet()</code> æ–¹æ³•ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªClassloaderåŠ è½½å¹¶å®ä¾‹åŒ–Servletï¼Œç„¶åè°ƒç”¨ <code>init()</code> æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œå…¶å®ä¹Ÿæ˜¯åˆšåˆšæˆ‘ä»¬åœ¨ServletContainerä¸­çš„å¤„ç†ã€‚æ‰€ä»¥åœ¨ServletContainerç±»é‡Œï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ”¹é€ ï¼Œå°†ä¸€äº›å¯¹Servletçš„å¤„ç†äº¤ç»™ServletWrapperè¿›è¡Œã€‚</p><p>é¦–å…ˆæ˜¯servletInstanceMapï¼ŒValueç±»å‹å¯è®¾ç½®æˆæ›´é«˜å±‚æ¬¡çš„ServletWrapperï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹ä¿®æ”¹åçš„æ ·å­ã€‚</p><pre><code class=\"language-java\">Map&lt;String,ServletWrapper&gt; servletInstanceMap = new ConcurrentHashMap&lt;&gt;();\n</code></pre><p>å…¶æ¬¡æ˜¯è°ƒæ•´invokeæ–¹æ³•ï¼Œä½ å¯ä»¥çœ‹ä¸€ä¸‹è°ƒæ•´åçš„invokeæ–¹æ³•ã€‚</p><pre><code class=\"language-java\">public void invoke(HttpRequest request, HttpResponse response)\n        throws IOException, ServletException {\n    ServletWrapper servletWrapper = null;\n    String uri = request.getUri();\n    String servletName = uri.substring(uri.lastIndexOf(\"/\") + 1);\n    String servletClassName = servletName;\n    servletWrapper = servletInstanceMap.get(servletName);\n    if ( servletWrapper == null) {\n        servletWrapper = new ServletWrapper(servletClassName,this);\n        //servletWrapper.setParent(this);\n        this.servletClsMap.put(servletName, servletClassName);\n        this.servletInstanceMap.put(servletName, servletWrapper);\n    }\n    try {\n        HttpServletRequest requestFacade = new HttpRequestFacade(request);\n        HttpServletResponse responseFacade = new HttpResponseFacade(response);\n        System.out.println(\"Call service()\");\n        servletWrapper.invoke(requestFacade, responseFacade);\n    }\n    catch (Exception e) {\n        System.out.println(e.toString());\n    }\n    catch (Throwable e) {\n        System.out.println(e.toString());\n    }\n}\n</code></pre><p>è¿™æ ·åœ¨ServletContainerä¸­ï¼Œåªæ˜¯è·å–åˆ°ServletWrapperçš„å®ä¾‹ï¼Œè°ƒç”¨ServletWrapperå†…çš„ <code>invoke()</code> æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è¿›è¡Œäº†è§£è€¦ã€‚</p><h2>æµ‹è¯•</h2><p>è¿™èŠ‚è¯¾å¹¶æ²¡æœ‰åŠŸèƒ½æ€§çš„å˜åŒ–ï¼Œæ‰€ä»¥æ²¡æœ‰æ–°å¢æµ‹è¯•ç±»ï¼Œè¿˜æ˜¯å’Œä¹‹å‰çš„æµ‹è¯•æ–¹å¼ä¿æŒä¸€è‡´ã€‚è¿™é‡Œå°±ä¸é‡å¤è¯´äº†ã€‚</p><h2>å°ç»“</h2><p>è¿™èŠ‚è¯¾æˆ‘ä»¬å®ç°äº†ServletContainerç®¡ç†å…¨éƒ¨çš„Servletï¼Œå°†åŸæœ¬çš„ç®¡ç†åŠŸèƒ½ä»Connectorå†…æŠ½ç¦»ï¼Œè®©Connectorä¸“æ³¨æœåŠ¡å™¨é€šä¿¡ç®¡ç†ã€‚è¿™ä¸ªContainerå°±æ˜¯æˆ‘ä»¬MiniTomcatåˆå§‹å®¹å™¨ï¼Œå®ƒé‡Œé¢æœ‰ä¸€ä¸ªmapï¼ŒåŒ…å«äº†ç®¡ç†çš„Servletå®ä¾‹ã€‚æœ‰äº†è¿™ä¸ªContainerï¼ŒProcessorå°±å˜å¾—ç®€å•äº†ï¼Œå®ƒé‡Œé¢çš„æ–°æ–¹æ³• <code>process()</code> åªéœ€è¦è°ƒç”¨Containerçš„ <code>invoke()</code> å°±å¯ä»¥äº†ã€‚</p><p>åŒæ—¶ï¼Œæˆ‘ä»¬å¼•å…¥ServletWrapperï¼Œå¯¹ServletContaineråšäº†æ›´è¿›ä¸€æ­¥çš„æ‹†åˆ†ï¼Œæ›´åŠ æ–¹ä¾¿å¯¹Servletè¿›è¡Œç®¡ç†ã€‚ä»Šåï¼Œæˆ‘ä»¬ä¼šæŠŠContainerè¿›ä¸€æ­¥æ‹†æˆå¤šå±‚ã€‚</p><p>æœ¬èŠ‚è¯¾ä»£ç å‚è§ï¼š<a href=\"https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter10\">https://gitee.com/yaleguo1/minit-learning-demo/tree/geek_chapter10</a></p><h2>æ€è€ƒé¢˜</h2><p>å­¦å®Œäº†è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šç°åœ¨è¿™ä¸ªHttpServerä»…ä»…åªæ˜¯åˆ›å»ºConnectorå’ŒContainerï¼Œåªæ˜¯ä¸€ä¸ªå£³å­äº†ï¼ŒæŒ‰ç…§æ‹ŸäººåŒ–çš„æ€è·¯ï¼ŒHttpServeråº”è¯¥æ˜¯ä¸€ä¸ªå…¬å¸ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»ä»é“ç†ä¸Šè¿˜åº”è¯¥åˆ†å·¥è´Ÿè´£åšäº›ä»€ä¹ˆï¼Ÿ</p><p>æ¬¢è¿ä½ æŠŠä½ æ€è€ƒåçš„ç»“æœåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™å…¶ä»–æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼</p>","comments":[{"had_liked":false,"id":386066,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1703948052,"is_pvip":false,"replies":[{"id":140779,"content":"åº”è¯¥æ˜¯Cookieæ¯”è¾ƒç®€å•å§ï¼Œjavax.servlet.httpé‡Œé¢å°±ç›´æ¥å®ç°äº†ã€‚\nC++æœåŠ¡å™¨ä¸€æ ·å¤šå¾—å¾ˆï¼ŒApacheï¼ŒNginxï¼Œå¾®è½¯çš„IISï¼Œè¿˜æœ‰å¾ˆå¤šæ¸¸æˆæœåŠ¡å™¨ï¼Œä¸ºäº†æ€§èƒ½éƒ½ç”¨çš„C&#47;C++å†™çš„ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1704328233,"ip_address":"æ¹–å—","comment_id":386066,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·æ•™è€å¸ˆä¸¤ä¸ªé—®é¢˜ï¼š\nQ1ï¼šä¸ºä»€ä¹ˆCookieæœ‰å®ç°è€ŒSessionæ²¡æœ‰å®ç°ï¼Ÿ\nä»£ç ä¸­çš„Sessionç±»å®ç°äº†HttpSessionæ¥å£ï¼Œä½†ä»£ç ä¸­ç”¨çš„Cookieæ˜¯ç³»ç»Ÿæä¾›çš„ã€‚ä¸ºä»€ä¹ˆSessionå°±æ²¡æœ‰ç³»ç»Ÿæä¾›çš„å®ç°ç±»ï¼Ÿ\n\nQ2ï¼šC++æœåŠ¡å™¨æœ‰å“ªäº›ï¼Ÿ\nçœ‹åˆ°ä¸€ç¯‡ä»‹ç»ç”¨C++å¼€å‘æœåŠ¡å™¨çš„æ–‡ç« ï¼Œè¯´æ˜æœ‰C++å¼€å‘çš„æœåŠ¡å™¨ã€‚Tomcatæ˜¯ç”¨Javaå¼€å‘çš„ã€‚é‚£ä¹ˆï¼Œæœ‰ä»€ä¹ˆC++å¼€å‘çš„æœåŠ¡å™¨äº§å“ï¼Ÿç”¨åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ï¼Ÿäº’è”ç½‘å…¬å¸ä¸€èˆ¬ä¸ç”¨C++æœåŠ¡å™¨å§ã€‚","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635025,"discussion_content":"åº”è¯¥æ˜¯Cookieæ¯”è¾ƒç®€å•å§ï¼Œjavax.servlet.httpé‡Œé¢å°±ç›´æ¥å®ç°äº†ã€‚\nC++æœåŠ¡å™¨ä¸€æ ·å¤šå¾—å¾ˆï¼ŒApacheï¼ŒNginxï¼Œå¾®è½¯çš„IISï¼Œè¿˜æœ‰å¾ˆå¤šæ¸¸æˆæœåŠ¡å™¨ï¼Œä¸ºäº†æ€§èƒ½éƒ½ç”¨çš„C/C++å†™çš„ã€‚","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704328233,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¹–å—","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":386008,"user_name":"HHğŸ·ğŸ ","can_delete":false,"product_type":"c1","uid":1133678,"ip_address":"å¹¿ä¸œ","ucode":"C50172BDA604D5","user_header":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","comment_is_top":false,"comment_ctime":1703834484,"is_pvip":false,"replies":[{"id":140708,"content":"å„è‡ªéƒ½æœ‰å„è‡ªçš„è§£å†³æ–¹æ¡ˆã€‚æˆ‘æ˜¯è¿™ä¹ˆæƒ³çš„ï¼Œconnectorç›¸å½“äºå…¬å¸çš„é”€å”®éƒ¨é—¨ï¼ŒæŠŠå®¢æˆ·å¼•è¿›åˆ°å…¬å¸ï¼Œcontaineræ˜¯å®¢æˆ·æœåŠ¡éƒ¨é—¨ï¼Œæ»¡è¶³å®¢æˆ·éœ€æ±‚ã€‚æ‰€ä»¥ä½œä¸ºä¸€ä¸ªå…¬å¸ï¼Œè¿˜è¦æœ‰ä¸€äº›ç®¡ç†èŒèƒ½çš„éƒ¨é—¨ï¼Œä»¥åŠæ”¯æ’‘é”€å”®éƒ¨å’Œå®¢æˆ·æœåŠ¡éƒ¨çš„éƒ¨é—¨ã€‚","user_name":"ä½œè€…å›å¤","user_name_real":"ç¼–è¾‘","uid":1864890,"ctime":1704027207,"ip_address":"æ¹–å—","comment_id":386008,"utype":1}],"discussion_count":2,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è¯·ä¸€ä¸ªå‰¯æ€»å§ï¼Œ ç®¡ç†æ¯ä¸ªéƒ¨é—¨çš„ Connector å’Œ Containerï¼Œ è´Ÿè´£ä»–ä»¬ä¸¤ä¸ªåˆ›å»ºå’Œç›¸äº’å¼•ç”¨","like_count":0,"discussions":[{"author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":634825,"discussion_content":"å„è‡ªéƒ½æœ‰å„è‡ªçš„è§£å†³æ–¹æ¡ˆã€‚æˆ‘æ˜¯è¿™ä¹ˆæƒ³çš„ï¼Œconnectorç›¸å½“äºå…¬å¸çš„é”€å”®éƒ¨é—¨ï¼ŒæŠŠå®¢æˆ·å¼•è¿›åˆ°å…¬å¸ï¼Œcontaineræ˜¯å®¢æˆ·æœåŠ¡éƒ¨é—¨ï¼Œæ»¡è¶³å®¢æˆ·éœ€æ±‚ã€‚æ‰€ä»¥ä½œä¸ºä¸€ä¸ªå…¬å¸ï¼Œè¿˜è¦æœ‰ä¸€äº›ç®¡ç†èŒèƒ½çš„éƒ¨é—¨ï¼Œä»¥åŠæ”¯æ’‘é”€å”®éƒ¨å’Œå®¢æˆ·æœåŠ¡éƒ¨çš„éƒ¨é—¨ã€‚","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1704027208,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"æ¹–å—","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2,\"source\":0}","child_discussion_number":1,"child_discussions":[{"author":{"id":1133678,"avatar":"https://static001.geekbang.org/account/avatar/00/11/4c/6e/5435e214.jpg","nickname":"HHğŸ·ğŸ ","note":"","ucode":"C50172BDA604D5","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1864890,"avatar":"https://thirdwx.qlogo.cn/mmopen/vi_32/cojb2AA3eM620kb7hj7YoOpq8XI0iaPyfajnQLO6icAhuSoYWR1vrdOZB2nmSuETxmuheo3sxec698SD6RhTFxgQ/132","nickname":"Yale Guo","note":"","ucode":"6736810620B3F0","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":634837,"discussion_content":"æ˜ç™½","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704067933,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":634825,"ip_address":"å¹¿ä¸œ","group_id":0},"score":634837,"extra":""}]}]},{"had_liked":false,"id":391625,"user_name":"silentyears","can_delete":false,"product_type":"c1","uid":1061748,"ip_address":"åŒ—äº¬","ucode":"6E137BFEB874CA","user_header":"https://static001.geekbang.org/account/avatar/00/10/33/74/d9d143fa.jpg","comment_is_top":false,"comment_ctime":1718691883,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"è€å¸ˆï¼Œconnectorå’Œcontaineräº’ç›¸æŒ‡å¼•ï¼Œè¿™ç§ç±»çš„ä¾èµ–å…³ç³»æ˜¯ä¸æ˜¯ä¸å¤ªå¥½ï¼Ÿåƒåœ¨springä¸­å°±æ˜¯å¾ªç¯ä¾èµ–","like_count":0},{"had_liked":false,"id":386113,"user_name":"peter","can_delete":false,"product_type":"c1","uid":1058183,"ip_address":"åŒ—äº¬","ucode":"261C3FC001DE2D","user_header":"https://static001.geekbang.org/account/avatar/00/10/25/87/f3a69d1b.jpg","comment_is_top":false,"comment_ctime":1704117819,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100636401,"comment_content":"å‘çš„ç•™è¨€æ€ä¹ˆæ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ï¼Œå†å‘ä¸€æ¬¡ï¼š\nQ1ï¼šä¸ºä»€ä¹ˆCookieæœ‰å®ç°è€ŒSessionæ²¡æœ‰å®ç°ï¼Ÿ\nä»£ç ä¸­çš„Sessionç±»å®ç°äº†HttpSessionæ¥å£ï¼Œä½†ä»£ç ä¸­ç”¨çš„Cookieæ˜¯ç³»ç»Ÿæä¾›çš„ã€‚ä¸ºä»€ä¹ˆSessionå°±æ²¡æœ‰ç³»ç»Ÿæä¾›çš„å®ç°ç±»ï¼Ÿ\n\nQ2ï¼šC++æœåŠ¡å™¨æœ‰å“ªäº›ï¼Ÿ\nçœ‹åˆ°ä¸€ç¯‡ä»‹ç»ç”¨C++å¼€å‘æœåŠ¡å™¨çš„æ–‡ç« ï¼Œè¯´æ˜æœ‰C++å¼€å‘çš„æœåŠ¡å™¨ã€‚Tomcatæ˜¯ç”¨Javaå¼€å‘çš„ã€‚é‚£ä¹ˆï¼Œæœ‰ä»€ä¹ˆC++å¼€å‘çš„æœåŠ¡å™¨äº§å“ï¼Ÿç”¨åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ï¼Ÿäº’è”ç½‘å…¬å¸ä¸€èˆ¬ä¸ç”¨C++æœåŠ¡å™¨å§ã€‚","like_count":0,"discussions":[{"author":{"id":1126661,"avatar":"https://static001.geekbang.org/account/avatar/00/11/31/05/9028e9ac.jpg","nickname":"ctt","note":"","ucode":"FA87B9E86FD308","race_medal":1,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":635008,"discussion_content":"Cookieéµå¾ªäº†HTTPæ ‡å‡†ï¼Œä¸”åŠŸèƒ½å•ä¸€ï¼›ä¸åŒçš„WebæœåŠ¡å™¨å¯èƒ½ä¼šä»¥ä¸åŒçš„æ–¹å¼ç®¡ç†ä¼šè¯æ•°æ®æˆ–ä¼˜åŒ–æ€§èƒ½ï¼Œæ¥å£æ˜¯ä¸ºäº†æ–¹ä¾¿æ‰©å±•","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1704275787,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"å¹¿ä¸œ","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]}]}