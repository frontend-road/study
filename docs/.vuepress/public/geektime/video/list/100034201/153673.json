{"id":153673,"title":"39 | ZooKeeper的客户端网络通信源码解读","content":"<p><strong>课件和Demo地址</strong></p><p><a href=\"https://gitee.com/geektime-geekbang/geekbang-zk-course\">https://gitee.com/geektime-geekbang/geekbang-zk-course</a></p>","comments":[{"had_liked":false,"id":160659,"user_name":"李春恒","can_delete":false,"product_type":"c3","uid":1033066,"ip_address":"","ucode":"F2DCA19EC66DC1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/c3/6a/3272e095.jpg","comment_is_top":false,"comment_ctime":1575997587,"is_pvip":false,"replies":[{"id":61588,"content":"赞","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1576304146,"ip_address":"","comment_id":160659,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"如何切到netty通信呢，\n看到官方文档上写着：NIO continues to be the default, however Netty based communication can be used in place of NIO by setting the environment variable &quot;zookeeper.serverCnxnFactory&quot; to &quot;org.apache.zookeeper.server.NettyServerCnxnFactory&quot;.\n\n默认情况下，zkServer.sh start 启动后，查看zk的日志，可以看到：\n2019-12-11 00:12:40,842 [myid:] - INFO  [main:ServerCnxnFactory@135] - Using org.apache.zookeeper.server.NIOServerCnxnFactory as server connection factory\n\n小弟花了半个小时才实验成功，分享给大家。\n【服务端zkServer.sh】\n在 $ZK_HOME&#47;conf 目录下创建一个 java.env文件，并配置:\nJVMFLAGS=&quot;-Dzookeeper.serverCnxnFactory=org.apache.zookeeper.server.NettyServerCnxnFactory\n-Dzookeeper.clientCnxnSocket=org.apache.zookeeper.ClientCnxnSocketNetty \n&quot;\n如果使用zkCli.sh访问时想使用netty，就加上clientCnxnSocket的配置，如上。\n\n通过zkServer.sh start 启动后，查看zk启动日志，检查是否使用Netty通讯：\n\n2019-12-11 00:37:14,230 [myid:] - INFO  [main:ServerCnxnFactory@135] - Using org.apache.zookeeper.server.NettyServerCnxnFactory as server connection factory\n\n【客户端使用IDEA】\n在VM options中添加下面配置即可：\n-Dzookeeper.clientCnxnSocket=org.apache.zookeeper.ClientCnxnSocketNetty\n\n如果仅调试netty在zookeeper 客户端执行流程中的使用，只配置客户端为netty即可。\n\n如果使用SSL的话。则必须使用netty通信。\nSSL is only supported on top of Netty communication, which means if you want to use SSL you have to enable Netty. ","like_count":3,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477449,"discussion_content":"赞","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576304146,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":146502,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1572557063,"is_pvip":false,"replies":[{"id":56735,"content":"它除了您说的用处，还有很多其他用处，比方说处理API注册的watch，比如https:&#47;&#47;zookeeper.apache.org&#47;doc&#47;r3.5.5&#47;api&#47;org&#47;apache&#47;zookeeper&#47;ZooKeeper.html#getData-java.lang.String-boolean-org.apache.zookeeper.AsyncCallback.DataCallback-java.lang.Object-注册的watch。\n\neventThread一直运行。ClientCnxn的start会启动这个thread，https:&#47;&#47;github.com&#47;apache&#47;zookeeper&#47;blob&#47;release-3.5.5&#47;zookeeper-server&#47;src&#47;main&#47;java&#47;org&#47;apache&#47;zookeeper&#47;ClientCnxn.java#L408。在创建一个ZooKeeper是会调用cnxn.start()。\n","user_name":"作者回复","user_name_real":"Geek_215586","uid":1591870,"ctime":1572666814,"ip_address":"","comment_id":146502,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"老师 也就是eventthread 只在异步调用的时候存在是吧","like_count":0,"discussions":[{"author":{"id":1591870,"avatar":"http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJyDiaaDJrwRsdUia9HxA8EuWaDVLr4E1gMG5y2ZTxV7BNUhdNABCmH3GMZTzib796X5duibiaeuRmNXeg/132","nickname":"Geek_215586","note":"","ucode":"5916AC9CC5FBE2","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":472888,"discussion_content":"它除了您说的用处，还有很多其他用处，比方说处理API注册的watch，比如https://zookeeper.apache.org/doc/r3.5.5/api/org/apache/zookeeper/ZooKeeper.html#getData-java.lang.String-boolean-org.apache.zookeeper.AsyncCallback.DataCallback-java.lang.Object-注册的watch。\n\neventThread一直运行。ClientCnxn的start会启动这个thread，https://github.com/apache/zookeeper/blob/release-3.5.5/zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java#L408。在创建一个ZooKeeper是会调用cnxn.start()。\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1572666814,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":290621,"user_name":"Geek_zhw","can_delete":false,"product_type":"c3","uid":1303813,"ip_address":"","ucode":"AABE15F9895613","user_header":"https://static001.geekbang.org/account/avatar/00/13/e5/05/fc769d45.jpg","comment_is_top":false,"comment_ctime":1619661448,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100034201,"comment_content":"感谢老师分享心得","like_count":0}]}