{"id":229807,"title":"19 | 超时重试：提升系统的健壮性和可用性","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geektime-servicemesh\">https://gitee.com/geektime-geekbang/geektime-servicemesh</a></p>","comments":[{"had_liked":false,"id":217597,"user_name":"lpf32","can_delete":false,"product_type":"c3","uid":1039717,"ip_address":"","ucode":"E1B127FDFF74BB","user_header":"https://static001.geekbang.org/account/avatar/00/0f/dd/65/3b4a2930.jpg","comment_is_top":false,"comment_ctime":1589540954,"is_pvip":false,"replies":[{"id":80739,"content":"A 访问 B，在B的virtualservice里设置的超时重试，都是针对B的。也就是访问B的时候如果B有故障，发送到B的请求会超时或者重试（如果配置了的话）","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1589777156,"ip_address":"","comment_id":217597,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"超时是访问这个服务的超时，还是这个访问别的服务超时；重试是访问这个服务的重试，还是这个服务访问其他服务的重试；这些机制都没讲。。。","like_count":5,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":495191,"discussion_content":"A 访问 B，在B的virtualservice里设置的超时重试，都是针对B的。也就是访问B的时候如果B有故障，发送到B的请求会超时或者重试（如果配置了的话）","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1589777156,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":2,"child_discussions":[{"author":{"id":1112676,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg","nickname":"Sam Fu","note":"","ucode":"EA285A4943271F","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"discussion":{"id":561782,"discussion_content":"有个疑问，这个超时重试为啥是配置在B服务上呢而不是A上面呢？比如A服务多长时间没有收到成功返回自动重试和快速失败","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1649725700,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":495191,"ip_address":"","group_id":0},"score":561782,"extra":""},{"author":{"id":1336951,"avatar":"https://static001.geekbang.org/account/avatar/00/14/66/77/194ba21d.jpg","nickname":"ileruza","note":"","ucode":"C3D83DF4230109","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":1112676,"avatar":"https://static001.geekbang.org/account/avatar/00/10/fa/64/457325e6.jpg","nickname":"Sam Fu","note":"","ucode":"EA285A4943271F","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":577582,"discussion_content":"istio是一个整体吧，B声明自己的超时时间对整个mesh生效。如果A对B的访问有特殊的需求，可以单独设置一个vs再配置超时和重试","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1656215015,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":561782,"ip_address":"","group_id":0},"score":577582,"extra":""}]}]},{"had_liked":false,"id":294629,"user_name":"李永山","can_delete":false,"product_type":"c3","uid":2195625,"ip_address":"","ucode":"E3A4D977398A29","user_header":"","comment_is_top":false,"comment_ctime":1622024748,"is_pvip":false,"replies":[{"id":108536,"content":"查一下ratings服务是不是注入了延迟故障，导致reviews失败","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1624545466,"ip_address":"","comment_id":294629,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，我遇到问题了，但是并不知道从哪儿开始排查，还请老师指点。当我试图将productpage指向reviews v2版本的时候我执行了如下:cat vs.yaml \napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v2\n但是当我执行完使用浏览器访问productpage的时候reviews报错了，如下:\nError fetching product reviews!\nSorry, product reviews are currently unavailable for this book.\n\n","like_count":2,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":520745,"discussion_content":"查一下ratings服务是不是注入了延迟故障，导致reviews失败","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1624545466,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":240717,"user_name":"Geek_02ab73","can_delete":false,"product_type":"c3","uid":1765823,"ip_address":"","ucode":"87E70195D8121F","user_header":"","comment_is_top":false,"comment_ctime":1597044184,"is_pvip":false,"replies":[{"id":89585,"content":"查一下destinationrule的tls设置的值是不是simple。你这个需求我理解就是把一个内部http请求转到外界的https请求，不太确定rewrite方式可行。match下面到rewrite其实都可以删掉。另外也可以在vs中设置tls去route，而不是http route转发。\n可以参考下这个例子：\nhttps:&#47;&#47;istio.io&#47;latest&#47;docs&#47;tasks&#47;traffic-management&#47;egress&#47;egress-tls-origination&#47;","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1597921193,"ip_address":"","comment_id":240717,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师，您好， 我想达到的效果是访问api.httpbin.com 会转发到 ext.api.httpbin.com，但是我如果destination port number 改成 443 就会出现503 UC 问题，以下是我的配置， 可以麻烦帮忙看看吗？\n---\napiVersion: networking.istio.io&#47;v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: api-httpbin-external\nspec:\n  hosts:\n  - ext.api.httpbin.com\n  location: MESH_EXTERNAL\n  ports:\n  - name: https\n    number: 443\n    protocol: HTTPS\n  resolution: DNS\n---\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: httpbin-api-ingress\nspec:\n  hosts:\n    - api.httpbin.com\n  gateways:\n    - api-gateway\n  http:\n  - match:\n    - gateways:\n        - httpbin-api-gateway\n      uri:\n        prefix: &quot;&#47;&quot;\n    rewrite:\n      uri: &#47;\n      authority: ext.api.httpbin.com # this is pretty important\n    route:\n    - destination:\n        host: ext.api.httpbin.com\n        port:\n          number: 443 #如果是80端口是可以的，转成443 就出现503 UC error","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":503541,"discussion_content":"查一下destinationrule的tls设置的值是不是simple。你这个需求我理解就是把一个内部http请求转到外界的https请求，不太确定rewrite方式可行。match下面到rewrite其实都可以删掉。另外也可以在vs中设置tls去route，而不是http route转发。\n可以参考下这个例子：\nhttps://istio.io/latest/docs/tasks/traffic-management/egress/egress-tls-origination/","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1597921193,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":236816,"user_name":"小松松","can_delete":false,"product_type":"c3","uid":1298152,"ip_address":"","ucode":"B9B5FFE7CAA548","user_header":"https://static001.geekbang.org/account/avatar/00/13/ce/e8/12cb8e99.jpg","comment_is_top":false,"comment_ctime":1595556931,"is_pvip":false,"replies":[{"id":87815,"content":"什么版本？http协议还是grpc？这个可能要具体问题具体分析了。集群网络环境，协议，项目的通讯层的配置，trafficpolicy等配置都有关系。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1595935149,"ip_address":"","comment_id":236816,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"我是带着问题来买课的，哈哈  我们在上istio后发现一个问题  node的项目调用后端的api 在上istio后出现connreset的次数明显增大 而不使用istio出现的概率会减小很多 虽然使用重连会解决这个问题 但极端情况也会造成雪崩效应，老师有遇到过吗 ？ 请指导一下！","like_count":0,"discussions":[{"author":{"id":1046394,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/f7/7a/55618020.jpg","nickname":"马若飞","note":"","ucode":"3D0327329A10AE","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":502221,"discussion_content":"什么版本？http协议还是grpc？这个可能要具体问题具体分析了。集群网络环境，协议，项目的通讯层的配置，trafficpolicy等配置都有关系。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1595935149,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":214213,"user_name":"煎蛋","can_delete":false,"product_type":"c3","uid":1233314,"ip_address":"","ucode":"0F9CBDA8CD4FE7","user_header":"https://static001.geekbang.org/account/avatar/00/12/d1/a2/e60a9c01.jpg","comment_is_top":false,"comment_ctime":1588677626,"is_pvip":false,"replies":[{"id":79328,"content":"几个服务都有默认硬编码的超时时间，可以看看源码。有时候会影响到你的设置，不用特纠结。","user_name":"作者回复","user_name_real":"马若飞","uid":1046394,"ctime":1588693537,"ip_address":"","comment_id":214213,"utype":1}],"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"我做了一些实验，我发现这个bookinfo是不是默认2s，我设置delay为2s的时候，基本都可以正常访问，但是3s以上的时候，就访问不到服务了，重试次数的日志也是基本这样2次可以看到输出，3次以上都是显示的2次输出","like_count":0},{"had_liked":false,"id":321385,"user_name":"王哲","can_delete":false,"product_type":"c3","uid":1097315,"ip_address":"","ucode":"72FE449A06BD1B","user_header":"https://static001.geekbang.org/account/avatar/00/10/be/63/ad364db5.jpg","comment_is_top":false,"comment_ctime":1636819756,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"做了一下实验，发现即使没有设置retry策略的时候，实际上也是可以收到两条access log。查阅了相关的资料，发现重试2次是Istio的默认策略，并不是我们设置的重试机制。\n另外，对于retries中的attempts的配置，表示的应该是重试的次数。也就是说，如果attempts=2，那么实际上应该一共收到的是3次请求（1次原始请求+2次重试请求）。","like_count":4,"discussions":[{"author":{"id":1095060,"avatar":"https://static001.geekbang.org/account/avatar/00/10/b5/94/c5ceadf4.jpg","nickname":"宸翰Hank.1","note":"","ucode":"8EFB4D50A5CBAB","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":548391,"discussion_content":"我尝试更改重试次数，但是并未生效。","likes_number":1,"is_delete":false,"is_hidden":false,"ctime":1643178224,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":355306,"user_name":"木几丶","can_delete":false,"product_type":"c3","uid":2420294,"ip_address":"福建","ucode":"FFDB958DA64F8C","user_header":"https://static001.geekbang.org/account/avatar/00/24/ee/46/7d65ae37.jpg","comment_is_top":false,"comment_ctime":1661255377,"is_pvip":true,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"在网络不太好的时候适合用指数退避策略，tcp三次握手中的syn包就是指数退避的重试策略","like_count":1},{"had_liked":false,"id":368342,"user_name":"Demon.Lee","can_delete":false,"product_type":"c3","uid":1052859,"ip_address":"安徽","ucode":"7F0E5493A8E345","user_header":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","comment_is_top":false,"comment_ctime":1676216798,"is_pvip":false,"replies":null,"discussion_count":1,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"老师可遇到过超时机制可以，但重试机制不行的情况。\n\n环境信息：\n➜  ~ hostnamectl \n  Virtualization: vmware\nOperating System: Ubuntu 22.04.1 LTS              \n          Kernel: Linux 5.15.0-60-generic\n    Architecture: arm64\n Hardware Vendor: VMware, Inc.\n  Hardware Model: VMware20,1\n➜  ~ \n\n➜  ~ k version --short\nClient Version: v1.25.3\nKustomize Version: v4.5.7\nServer Version: v1.25.3\n➜  ~ \n             \n➜  ~ istioctl version\nclient version: 1.16.2\ncontrol plane version: 1.16.2\ndata plane version: 1.16.2 (11 proxies)\n➜  ~ \n\n\n我写了一个服务，接口延迟 5 秒返回，我先在 vs 配置 3s 的超时，验证没有问题；\n但我把超时去掉，换成重试3次，重试的超时时长为 1s 后，接口直接在 1s 后就报 504 超时了，并没有发起 3 次重试，查了好久，也没找到原因，特来问问，感谢。\n\n以下是配置：\napiVersion: apps&#47;v1\nkind: Deployment\n省略部分内容\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: student\n  name: student\n  namespace: istio-dev\nspec:\n  ports:\n  - port: 8080\n    name: http\n    protocol: TCP\n    targetPort: 8080\n  selector:\n    app: student\n  type: ClusterIP\n---\napiVersion: networking.istio.io&#47;v1alpha3\nkind: VirtualService\nmetadata:\n  name: student\n  namespace: istio-dev\nspec:\n  hosts:\n    - student\n  http:\n    - route:\n      - destination:\n          host: student\n      #retries:\n      #  attempts: 3\n      #  perTryTimeout: 1s\n      timeout: 3s\n\n以下是两次调用的结果：\n1）超时：\n# curl -i -w &quot;@curl-format.txt&quot; http:&#47;&#47;student:8080&#47;istio&#47;timeout\nHTTP&#47;1.1 504 Gateway Timeout\ncontent-length: 24\ncontent-type: text&#47;plain\ndate: Sun, 12 Feb 2023 15:27:31 GMT\nserver: envoy\n\nupstream request timeout\n------------------------------------\ntime_total:  3.019577s\n# \n\n2）重试：\n# curl -i -w &quot;@curl-format.txt&quot; http:&#47;&#47;student:8080&#47;istio&#47;timeout\nHTTP&#47;1.1 504 Gateway Timeout\ncontent-length: 24\ncontent-type: text&#47;plain\ndate: Sun, 12 Feb 2023 15:23:16 GMT\nserver: envoy\n\nupstream request timeout\n------------------------------------\ntime_total:  1.008266s\n#","like_count":0,"discussions":[{"author":{"id":1052859,"avatar":"https://static001.geekbang.org/account/avatar/00/10/10/bb/f1061601.jpg","nickname":"Demon.Lee","note":"","ucode":"7F0E5493A8E345","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":603665,"discussion_content":"老师，不用回复了，已找到问题。\n\n如果不配置 retryOn，则默认为 connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes，我手动调整配置为 5xx 或 gateway-error 便可以了。\n\n通过命令 istioctl proxy-config route xxx 查看 route。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1676265545,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"安徽","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":222794,"user_name":"斯蒂芬.赵","can_delete":false,"product_type":"c3","uid":1200179,"ip_address":"","ucode":"AA0FF2DA654418","user_header":"https://static001.geekbang.org/account/avatar/00/12/50/33/9dcd30c4.jpg","comment_is_top":false,"comment_ctime":1590913891,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":2,"product_id":100049401,"comment_content":"重试次数也不能过多。倍数的请求对上游的请求也是一种压力。\n指数级退避第一次听说","like_count":0}]}