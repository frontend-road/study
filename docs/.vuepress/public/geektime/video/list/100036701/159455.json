{"id":159455,"title":"28 | 源码剖析：关闭服务","content":"<p><strong>课件和Demo地址</strong><br>\n<a href=\"https://gitee.com/geektime-geekbang/geek_netty\">https://gitee.com/geektime-geekbang/geek_netty</a></p>","comments":[{"had_liked":false,"id":154016,"user_name":"Standly","can_delete":false,"product_type":"c3","uid":1181055,"ip_address":"","ucode":"805CC5784D3F76","user_header":"https://static001.geekbang.org/account/avatar/00/12/05/7f/a7df049a.jpg","comment_is_top":false,"comment_ctime":1574347948,"is_pvip":false,"replies":[{"id":59378,"content":"估计这个关闭复杂的你都怀疑关闭有那么简单么？问的我不禁回头翻了下dubbo&#47;hadoop和做过的项目的代码了，还好都是下面2句话：\nbossGroup.shutdownGracefully();\nworkerGroup.shutdownGracefully();\n所以放心使用吧！","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574517833,"ip_address":"","comment_id":154016,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，那生产环境怎么关闭netty服务？","like_count":8,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475353,"discussion_content":"估计这个关闭复杂的你都怀疑关闭有那么简单么？问的我不禁回头翻了下dubbo/hadoop和做过的项目的代码了，还好都是下面2句话：\nbossGroup.shutdownGracefully();\nworkerGroup.shutdownGracefully();\n所以放心使用吧！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574517833,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149735,"user_name":"Allen","can_delete":false,"product_type":"c3","uid":1211051,"ip_address":"","ucode":"B57ECE1E99A77D","user_header":"https://static001.geekbang.org/account/avatar/00/12/7a/ab/99bdf0ee.jpg","comment_is_top":false,"comment_ctime":1573359922,"is_pvip":false,"replies":[{"id":57932,"content":"谢谢肯定，就是普通话不标准......","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1573569914,"ip_address":"","comment_id":149735,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师真好","like_count":4,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473958,"discussion_content":"谢谢肯定，就是普通话不标准......","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1573569914,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154473,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1574437526,"is_pvip":false,"replies":[{"id":59374,"content":"给你举2个例子啊：\n1 比如请求刚建立的时候，那个建立的请求，不是要register么，例如注册读事件？那个register就是一个task。\n2 你的业务如果不独立出一个线程池来处理，你不就复用IO线程了么？那你的业务处理这个事情就封装成task了\n3 其他所有的handler，类似第二点，只要和io复用在一起，那就成一个task来执行了。所以才有了io和普通的task的比例ioratio一说。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574515784,"ip_address":"","comment_id":154473,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师 一直不懂tasks 里边到底装的什么task， 正常客户发送的请求 不算task吧 那什么会放在taskqueue中呢","like_count":2,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475482,"discussion_content":"给你举2个例子啊：\n1 比如请求刚建立的时候，那个建立的请求，不是要register么，例如注册读事件？那个register就是一个task。\n2 你的业务如果不独立出一个线程池来处理，你不就复用IO线程了么？那你的业务处理这个事情就封装成task了\n3 其他所有的handler，类似第二点，只要和io复用在一起，那就成一个task来执行了。所以才有了io和普通的task的比例ioratio一说。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574515784,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":209208,"user_name":"武文文武","can_delete":false,"product_type":"c3","uid":1108924,"ip_address":"","ucode":"5288366646A15B","user_header":"https://static001.geekbang.org/account/avatar/00/10/eb/bc/6ccac4bb.jpg","comment_is_top":false,"comment_ctime":1587519908,"is_pvip":false,"replies":[{"id":78815,"content":"       说是优雅关闭，其实不是说长连接关闭优雅，而是在关闭时，对正在处理请求的优雅。\n       现在很多不都是蓝绿部署么？部署之前先把流量切走，这样只要优雅处理当前的剩余请求就可以了，所以一方面你可以把关闭的时间调大点，还是不放心的话，可以做一个功能，就是能实时查看还有多少请求还在处理，如果没有了，再升级。\n        另外一个方面你可以看看这个业务本身的可靠性要求等等，实际上，假设你就把某个请求丢了，你的客户端一般都会做重试，等于自动补偿了。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1588055266,"ip_address":"","comment_id":209208,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"\n老师您好，有个问题请教一下(之前这个问题发到上一节课去了，所以重新发一遍，不好意思)，我们用netty做服务端，前端访问服务端是从一个连接池中拿连接，然后访问netty服务端，但是现在生产运维提出让我实现优雅关闭，也就是在服务端升级的时候要让客户端无感知，但是由于连接是基于tcp的长连接，就算用gracefulShutdown也保证不了客户端无感知，您有什么好的建议来实现这种长连接的优雅关闭吗？感谢老师的指教","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":492738,"discussion_content":"       说是优雅关闭，其实不是说长连接关闭优雅，而是在关闭时，对正在处理请求的优雅。\n       现在很多不都是蓝绿部署么？部署之前先把流量切走，这样只要优雅处理当前的剩余请求就可以了，所以一方面你可以把关闭的时间调大点，还是不放心的话，可以做一个功能，就是能实时查看还有多少请求还在处理，如果没有了，再升级。\n        另外一个方面你可以看看这个业务本身的可靠性要求等等，实际上，假设你就把某个请求丢了，你的客户端一般都会做重试，等于自动补偿了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588055266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152568,"user_name":"谨守","can_delete":false,"product_type":"c3","uid":1402386,"ip_address":"","ucode":"01751DDA988C0A","user_header":"https://static001.geekbang.org/account/avatar/00/15/66/12/a485354c.jpg","comment_is_top":false,"comment_ctime":1574043742,"is_pvip":false,"replies":[{"id":59050,"content":"是的，现在我还是迷惘的，哈哈，不过好在，我发现netty的那些创始人也不是都懂，一起阿Q了一下。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574300601,"ip_address":"","comment_id":152568,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"始于迷茫，终于更高级的迷茫。哈哈哈，直指程序员的终极本质~","like_count":1,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474861,"discussion_content":"是的，现在我还是迷惘的，哈哈，不过好在，我发现netty的那些创始人也不是都懂，一起阿Q了一下。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574300601,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":191978,"user_name":"NoBody","can_delete":false,"product_type":"c3","uid":1173766,"ip_address":"","ucode":"72E1B4FCDA2469","user_header":"https://static001.geekbang.org/account/avatar/00/11/e9/06/038a9cea.jpg","comment_is_top":false,"comment_ctime":1584807396,"is_pvip":false,"replies":[{"id":78827,"content":"不容易，哈哈，加油！","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1588056220,"ip_address":"","comment_id":191978,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"坚持硬着头皮打卡！","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":488304,"discussion_content":"不容易，哈哈，加油！","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1588056220,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":175424,"user_name":"InfoQ_fbb8f3b4ab40","can_delete":false,"product_type":"c3","uid":1327125,"ip_address":"","ucode":"B3CF4BFCC8FFDA","user_header":"http://thirdwx.qlogo.cn/mmopen/vi_32/L9VVrMFqrzeT5bsQ7CYZdcHnyEVYa59apyp322eB5icysGXYgDqkeHZmH79ibiaJUShjvftoAmLeP6pxwhFff9ib8g/132","comment_is_top":false,"comment_ctime":1580716181,"is_pvip":false,"replies":[{"id":69674,"content":"肯定不能ctrl+c，不然你不就要有产线环境的权限了么，而且那么多机器怎么操作尼。\n\n不定要配合Runtime.getRuntime().addShutdownHook()，一般使用netty都是做一个核心服务，自然要主动关闭，而不是等着jvm关闭的时候再关，所以直接调用shutdown方法就行了。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1582005067,"ip_address":"","comment_id":175424,"utype":1}],"discussion_count":3,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"生产环境的netty服务是要配合Runtime.getRuntime().addShutdownHook()使用吗？关闭的时候只能ctrl+c这样？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":482726,"discussion_content":"肯定不能ctrl+c，不然你不就要有产线环境的权限了么，而且那么多机器怎么操作尼。\n\n不定要配合Runtime.getRuntime().addShutdownHook()，一般使用netty都是做一个核心服务，自然要主动关闭，而不是等着jvm关闭的时候再关，所以直接调用shutdown方法就行了。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1582005067,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1014023,"avatar":"https://static001.geekbang.org/account/avatar/00/0f/79/07/2f418316.jpg","nickname":"恰饭哒","note":"","ucode":"0395069A050057","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":392104,"discussion_content":"我也不能理解怎么关闭的，肯定是有个地方触发的，代码又走不到那个关闭的地方","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1630834868,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]},{"author":{"id":1108924,"avatar":"https://static001.geekbang.org/account/avatar/00/10/eb/bc/6ccac4bb.jpg","nickname":"武文文武","note":"","ucode":"5288366646A15B","race_medal":0,"user_type":1,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":242600,"discussion_content":"老师说的直接调用shutdown，这个是谁的方法呢？netty的还是jvm的呢？哪个包下的呀？\n","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1587481505,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":false,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161649,"user_name":"可爱的小奶狗","can_delete":false,"product_type":"c3","uid":1178236,"ip_address":"","ucode":"DC810503571DD2","user_header":"https://static001.geekbang.org/account/avatar/00/11/fa/7c/f8f38ad0.jpg","comment_is_top":false,"comment_ctime":1576285809,"is_pvip":false,"replies":[{"id":62116,"content":"这个问题本身和netty没有关系，讨论的是java程序的优美关闭问题了。这\n两个一般都是放一起用的，信号是为了触发你来关，hook是让关闭的时候别忘记清理，所以一般都是配合，所以可以置换成别的方式，比如假设你是http服务器，你可以不用信号量而直接用http api调用来触发关闭，例如jennkins:\nhttp:&#47;&#47;&lt;jenkins.server&gt;&#47;safeExit","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576725266,"ip_address":"","comment_id":161649,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师，生产环境关闭要设计得优雅点，用jdk自带的ShutdownHook，适合不？还有用注册信号量Signal,适合不？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477797,"discussion_content":"这个问题本身和netty没有关系，讨论的是java程序的优美关闭问题了。这\n两个一般都是放一起用的，信号是为了触发你来关，hook是让关闭的时候别忘记清理，所以一般都是配合，所以可以置换成别的方式，比如假设你是http服务器，你可以不用信号量而直接用http api调用来触发关闭，例如jennkins:\nhttp://&amp;lt;jenkins.server&amp;gt;/safeExit","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576725266,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":161587,"user_name":"可爱的小奶狗","can_delete":false,"product_type":"c3","uid":1178236,"ip_address":"","ucode":"DC810503571DD2","user_header":"https://static001.geekbang.org/account/avatar/00/11/fa/7c/f8f38ad0.jpg","comment_is_top":false,"comment_ctime":1576240111,"is_pvip":false,"replies":[{"id":61548,"content":"只能说太狠了，😂","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576264497,"ip_address":"","comment_id":161587,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"我们生产环境直接ctrl + c，这个优美关闭估计没用吧？","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":477773,"discussion_content":"只能说太狠了，😂","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576264497,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154468,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1574436703,"is_pvip":false,"replies":[{"id":62174,"content":"是的，channel关闭了，这块逻辑也挺乱的，而且经过几次改变，连维护者的那些人也迷糊的很，大体思路就是不保证所有请求了，不然时间无法保证，当然也会尽量。所以不要依赖它的行为，而是指望客户端自己去重试什么的。","user_name":"作者回复","user_name_real":"stroller","uid":1638649,"ctime":1576744733,"ip_address":"","comment_id":154468,"utype":1}],"discussion_count":1,"race_medal":0,"score":2,"product_id":100036701,"comment_content":"老师 在shutdowngraceflly 会先关闭所有的channel  那这个时候有一个channel对应的nioeventloop 还在处理 还没有把结果写回这个channel 那么  那么发送这个请求的客户就永远收不到这个请求的处理结果了是吧","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475480,"discussion_content":"是的，channel关闭了，这块逻辑也挺乱的，而且经过几次改变，连维护者的那些人也迷糊的很，大体思路就是不保证所有请求了，不然时间无法保证，当然也会尽量。所以不要依赖它的行为，而是指望客户端自己去重试什么的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1576744733,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":154462,"user_name":"飞翔","can_delete":false,"product_type":"c3","uid":1068571,"ip_address":"","ucode":"65AF6AF292DAD6","user_header":"https://static001.geekbang.org/account/avatar/00/10/4e/1b/f4b786b9.jpg","comment_is_top":false,"comment_ctime":1574435685,"is_pvip":false,"replies":[{"id":59375,"content":"你服务要上新版本的时候，或者你的软硬件升级的时候，比如升级os,升级更好的机器，你都需要重启的对不对？重启，自然想优美点，不能直接拔插座吧，哈哈，所以肯定想着优美关闭的。","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574516161,"ip_address":"","comment_id":154462,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"话说什么情况下我们会关闭netty呢， 我觉得大部分情况 我们服务启动起来 我们希望他一直接受处理请求 因此 大部分情况 我们是永远不调用shutdowngracefully 对吧","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":475477,"discussion_content":"你服务要上新版本的时候，或者你的软硬件升级的时候，比如升级os,升级更好的机器，你都需要重启的对不对？重启，自然想优美点，不能直接拔插座吧，哈哈，所以肯定想着优美关闭的。","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574516161,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":152885,"user_name":"witluo","can_delete":false,"product_type":"c3","uid":1443117,"ip_address":"","ucode":"3D9608C3DDDD95","user_header":"","comment_is_top":false,"comment_ctime":1574096378,"is_pvip":false,"replies":[{"id":59046,"content":"谢谢，感觉有的时候在“泡”代码感觉，过一段时间看看，然后又能多理解一些细节，哈哈","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574300353,"ip_address":"","comment_id":152885,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"始于迷茫，终于更高层次的迷茫；或者应该说，进化到更高层次的迷茫，因为虽然迷茫，但是还要不停的追。断断续续研究netty快一年了，感谢老师带来了不同观点的源码解读。","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":474976,"discussion_content":"谢谢，感觉有的时候在“泡”代码感觉，过一段时间看看，然后又能多理解一些细节，哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574300353,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":149661,"user_name":"梦典","can_delete":false,"product_type":"c3","uid":1203920,"ip_address":"","ucode":"0A6F91068A13E8","user_header":"https://static001.geekbang.org/account/avatar/00/12/5e/d0/e676ac19.jpg","comment_is_top":false,"comment_ctime":1573308490,"is_pvip":false,"replies":[{"id":59075,"content":"读了三遍你的表述，没有觉得你哪里说的不对，和我理解差不多。哈哈","user_name":"作者回复","user_name_real":"Geek_9bc307","uid":1638649,"ctime":1574304112,"ip_address":"","comment_id":149661,"utype":1}],"discussion_count":1,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"关于平静周期（quiet period）的分析，请指教\n1. cancelScheduledTasks()，ScheduledTask能取消的话执行取消\n2. runAllTasks()，ScheduledTask能执行的也执行了\n即Netty内核产生的调度任务都在EventLoop最后的生命消散过程中被处理掉了，\n但是对于业务系统而言，还有用户扩展（自定义异步业务处理层，自定义Handler扩展等），他们均可以通过execute调用，提交额外的调度任务，这些调度任务对于内核来说，需要给予一定时间的观察时间，即平静周期（quiet period），如有这样的调度任务发生执行，就再次观察一段时间。在生命的最后阶段，岁月静好，不必那么劳心劳力了，睡100毫秒起来再来观察就好，，，","like_count":0,"discussions":[{"author":{"id":1638649,"avatar":"https://static001.geekbang.org/account/avatar/00/19/00/f9/44a3e5bd.jpg","nickname":"傅健","note":"","ucode":"5EA8BB26F5B036","race_medal":0,"user_type":2,"is_pvip":false},"reply_author":{"id":0,"avatar":"","nickname":"","note":"","ucode":"","race_medal":0,"user_type":1,"is_pvip":false},"discussion":{"id":473932,"discussion_content":"读了三遍你的表述，没有觉得你哪里说的不对，和我理解差不多。哈哈","likes_number":0,"is_delete":false,"is_hidden":false,"ctime":1574304112,"is_liked":false,"can_delete":false,"is_complain":false,"is_top":true,"parent_id":0,"ip_address":"","group_id":0},"score":2,"extra":"{\"reply\":true,\"user_type\":2}","child_discussion_number":0,"child_discussions":[]}]},{"had_liked":false,"id":258569,"user_name":"冬渐暖","can_delete":false,"product_type":"c3","uid":1586800,"ip_address":"","ucode":"907E41AAE9A36C","user_header":"https://static001.geekbang.org/account/avatar/00/18/36/70/00122b24.jpg","comment_is_top":false,"comment_ctime":1604485715,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"关闭服务自然不能像普通的kill -9 一样简单粗暴\n典型的打败仗，领导先跑，打工仔后面跑。好处是老板跑了，没有新需求进来了，所有人也不用担心了改需求了\n先bossGroup.shutdownGracefully();\n再workerGroup.shutdownGracefully();\n\n关闭主要是吧NioEventLoop的state标识符修改，因为NioEventLoop本身就是一个死循环，循环看到自己的状态为关闭，也会执行关闭自己的命令了\n自己关闭自己的流程为：先看看自己能不能关--》去执行预设好的task&#47;hook或者还在执行的定时任务，因为你都关闭了所有的channel，是不会有新的事件进来的。本身hook钩子就是在程序退出时候应该做的动作，当然如果超过一个特定时间阀值还没有搞完的话，则恼羞成怒给你强制关闭，如果你没有超过这个时间的话，等你一下，等到你全部搞完或者我不耐烦(时间阀值)的时候\n至于看有没有task执行，则是task每次执行的时候会记录一下时间，类似于计数器\n\n关闭服务的本质：\n关闭所有连接和selector，selector是先关channel，再把channel的key全部拿出来和channel解绑掉，然后才是关掉自己，最后关掉所有的线程(退出所有的for死循环)\n\n优雅：其实就是不和kill -9一样粗粒度的关掉。类似电脑关机，先关a程序，再关b程序，最后才关机。kill是直接强制关机\n可控：其实就是给了你一个执行最大时间，超过这个时间给你强制关掉，windows关机也有类似的\n","like_count":4},{"had_liked":false,"id":266505,"user_name":"Allen","can_delete":false,"product_type":"c3","uid":1162307,"ip_address":"","ucode":"0E0D44ABB35DBB","user_header":"https://static001.geekbang.org/account/avatar/00/11/bc/43/11acdc02.jpg","comment_is_top":false,"comment_ctime":1607358289,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"抓住要点·真，讲的真好，这章的七大主线我要好好多看几遍！","like_count":1},{"had_liked":false,"id":156763,"user_name":"粘豆包","can_delete":false,"product_type":"c3","uid":1228403,"ip_address":"","ucode":"5888890A217C8B","user_header":"https://static001.geekbang.org/account/avatar/00/12/be/73/0a274128.jpg","comment_is_top":false,"comment_ctime":1574950384,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"始于迷惘，终于更好层次的迷惘！😂","like_count":1},{"had_liked":false,"id":351621,"user_name":"t0ugh","can_delete":false,"product_type":"c3","uid":2115346,"ip_address":"","ucode":"52BCC9A0B2610C","user_header":"https://static001.geekbang.org/account/avatar/00/20/47/12/ec68d04f.jpg","comment_is_top":false,"comment_ctime":1658021977,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"感谢老师，22年夏天找工作之前刷了这个视频一直到这一章，收获很多。","like_count":0},{"had_liked":false,"id":347626,"user_name":"@","can_delete":false,"product_type":"c3","uid":2674662,"ip_address":"","ucode":"6DC70D2F532A7C","user_header":"https://static001.geekbang.org/account/avatar/00/28/cf/e6/a0b06992.jpg","comment_is_top":false,"comment_ctime":1654240604,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"加油","like_count":0},{"had_liked":false,"id":331997,"user_name":"flying eagle","can_delete":false,"product_type":"c3","uid":1155616,"ip_address":"","ucode":"1020359D893C04","user_header":"https://static001.geekbang.org/account/avatar/00/11/a2/20/7549ff2b.jpg","comment_is_top":false,"comment_ctime":1642953003,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"老师这一章节讲的真好，从 netty 服务的整个主线过程触发，一步步讲解，受益匪浅，虽然源码还看不懂，但是整个原理有了大致的掌握","like_count":0},{"had_liked":false,"id":286862,"user_name":"艺超(鲁鸣)","can_delete":false,"product_type":"c3","uid":1029436,"ip_address":"","ucode":"7F749FA543E0F1","user_header":"https://static001.geekbang.org/account/avatar/00/0f/b5/3c/967d7291.jpg","comment_is_top":false,"comment_ctime":1617637414,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":3,"product_id":100036701,"comment_content":"追到这里，有一个比较大的困惑就是各个类的职业，比如pipeline，handler等，如果加一节就更好了","like_count":0},{"had_liked":false,"id":242100,"user_name":"dododo糖","can_delete":false,"product_type":"c3","uid":1730835,"ip_address":"","ucode":"EFD5D7D5FD9790","user_header":"https://static001.geekbang.org/account/avatar/00/1a/69/13/31ae93c0.jpg","comment_is_top":false,"comment_ctime":1597589752,"is_pvip":false,"replies":null,"discussion_count":0,"race_medal":0,"score":4,"product_id":100036701,"comment_content":"始于迷茫终于更高的迷茫，老师的金句真多啊，哈哈哈哈","like_count":0}]}